{
    "hands_on_practices": [
        {
            "introduction": "In fMRI analysis, we often specify smoothing in physical units, like an $8$ mm FWHM, to ensure comparable results across studies. However, the data itself exists on a grid of voxels that are frequently anisotropic (not perfect cubes). This practice  challenges you to derive the correct Gaussian kernel parameters in discrete voxel units, a foundational skill for translating a desired physical smoothing into an accurate digital implementation.",
            "id": "4164641",
            "problem": "A researcher analyzing functional Magnetic Resonance Imaging (fMRI) data intends to apply spatial smoothing using a three-dimensional Gaussian kernel to achieve a specified full width at half maximum (FWHM) in millimeters. The dataset has anisotropic voxel sampling with voxel dimensions $(\\Delta_x,\\Delta_y,\\Delta_z)$ given by $\\Delta_x = 1.8$ millimeters, $\\Delta_y = 2.0$ millimeters, and $\\Delta_z = 3.6$ millimeters. The desired physical FWHM of the smoothing kernel is $7.5$ millimeters, identical along all spatial axes in the physical space.\n\nStarting from core definitions of the Gaussian function and FWHM, and the notion that convolution in discrete voxel space corresponds to the sampling of a continuous kernel on a grid with spacing $(\\Delta_x,\\Delta_y,\\Delta_z)$, derive the conversion from the desired physical FWHM to the standard deviation $\\sigma$ of the Gaussian kernel in voxel units along each axis. Use only these foundational principles in your derivation; do not assume or cite any specialized shortcut formulas.\n\nCompute the values of $\\sigma$ in voxel units along the $x$, $y$, and $z$ axes, denoted $(\\sigma_x,\\sigma_y,\\sigma_z)$, and report them as dimensionless quantities. Round your final numerical results to four significant figures. Additionally, briefly explain, in terms of sampling and effective point-spread function shape, the implications of anisotropic voxel sizes for implementing physically isotropic smoothing in discrete space.",
            "solution": "The problem requires the derivation of the standard deviations $(\\sigma_x, \\sigma_y, \\sigma_z)$ of a Gaussian smoothing kernel in voxel units, given a desired isotropic physical full width at half maximum (FWHM) and anisotropic voxel dimensions. The solution will proceed in four parts: first, a derivation of the fundamental relationship between FWHM and standard deviation $\\sigma$ for a Gaussian function; second, the conversion of this relationship from physical space to discrete voxel space; third, the numerical computation of the required $\\sigma$ values; and fourth, an explanation of the implications of this conversion.\n\nFirst, we derive the relationship between FWHM and $\\sigma$. A one-dimensional Gaussian function centered at the origin can be written as:\n$$g(x) = \\exp\\left(-\\frac{x^2}{2\\sigma^2}\\right)$$\nThe maximum value of this function is $g(0) = 1$. The FWHM is defined as the width of the function at half of its maximum value. We must find the coordinates $x$ where $g(x) = \\frac{1}{2}$. Let these points be $\\pm x_{1/2}$.\n$$\\exp\\left(-\\frac{x_{1/2}^2}{2\\sigma^2}\\right) = \\frac{1}{2}$$\nTaking the natural logarithm of both sides gives:\n$$-\\frac{x_{1/2}^2}{2\\sigma^2} = \\ln\\left(\\frac{1}{2}\\right) = -\\ln(2)$$\nSolving for $x_{1/2}^2$:\n$$x_{1/2}^2 = 2\\sigma^2 \\ln(2)$$\nThe two points are $x_{1/2} = \\pm \\sigma \\sqrt{2 \\ln(2)}$. The FWHM is the distance between these two points:\n$$\\text{FWHM} = (\\sigma \\sqrt{2 \\ln(2)}) - (-\\sigma \\sqrt{2 \\ln(2)}) = 2\\sigma \\sqrt{2 \\ln(2)}$$\nThis can be written more compactly as:\n$$\\text{FWHM} = \\sigma \\sqrt{8 \\ln(2)}$$\nThis equation provides the direct conversion between the standard deviation $\\sigma$ and the FWHM of a Gaussian distribution.\n\nSecond, we must relate the parameters in physical space (measured in millimeters) to those in discrete voxel space (measured in voxels, a dimensionless quantity). Let the desired physical FWHM be $\\text{FWHM}_p$, which is specified to be isotropic, i.e., the same along all axes. Let the corresponding standard deviation in physical units be $\\sigma_p$. From our derivation:\n$$\\sigma_p = \\frac{\\text{FWHM}_p}{\\sqrt{8 \\ln(2)}}$$\nThe voxel dimensions are given as $(\\Delta_x, \\Delta_y, \\Delta_z)$. These values represent the physical size of a single voxel along each axis (e.g., in mm/voxel). The standard deviation of the Gaussian kernel can be expressed in physical units ($\\sigma_p$) or in voxel units ($\\sigma_x, \\sigma_y, \\sigma_z$). The relationship between these is a simple scaling by the voxel size for each dimension:\n$$\\sigma_p = \\sigma_x \\Delta_x$$\n$$\\sigma_p = \\sigma_y \\Delta_y$$\n$$\\sigma_p = \\sigma_z \\Delta_z$$\nTo achieve an isotropic physical smoothing effect (i.e., the same $\\sigma_p$ in all directions), the standard deviation in voxel units must be different for each direction to compensate for the anisotropic voxel sizes. We can solve for the standard deviation in voxel units for each axis:\n$$\\sigma_x = \\frac{\\sigma_p}{\\Delta_x} = \\frac{\\text{FWHM}_p}{\\Delta_x \\sqrt{8 \\ln(2)}}$$\n$$\\sigma_y = \\frac{\\sigma_p}{\\Delta_y} = \\frac{\\text{FWHM}_p}{\\Delta_y \\sqrt{8 \\ln(2)}}$$\n$$\\sigma_z = \\frac{\\sigma_p}{\\Delta_z} = \\frac{\\text{FWHM}_p}{\\Delta_z \\sqrt{8 \\ln(2)}}$$\n\nThird, we compute the numerical values for $(\\sigma_x, \\sigma_y, \\sigma_z)$. The given values are $\\text{FWHM}_p = 7.5$ mm, $\\Delta_x = 1.8$ mm, $\\Delta_y = 2.0$ mm, and $\\Delta_z = 3.6$ mm.\nFirst, we evaluate the constant factor:\n$$\\sqrt{8 \\ln(2)} \\approx \\sqrt{8 \\times 0.693147} \\approx \\sqrt{5.545177} \\approx 2.354820$$\nNow we can compute the standard deviation in voxel units for each axis:\n$$\\sigma_x = \\frac{7.5}{1.8 \\times \\sqrt{8 \\ln(2)}} \\approx \\frac{7.5}{1.8 \\times 2.354820} \\approx \\frac{7.5}{4.238676} \\approx 1.76943$$\n$$\\sigma_y = \\frac{7.5}{2.0 \\times \\sqrt{8 \\ln(2)}} \\approx \\frac{7.5}{2.0 \\times 2.354820} \\approx \\frac{7.5}{4.709640} \\approx 1.59249$$\n$$\\sigma_z = \\frac{7.5}{3.6 \\times \\sqrt{8 \\ln(2)}} \\approx \\frac{7.5}{3.6 \\times 2.354820} \\approx \\frac{7.5}{8.477352} \\approx 0.88471$$\nRounding these results to four significant figures, we get:\n$$\\sigma_x \\approx 1.769$$\n$$\\sigma_y \\approx 1.592$$\n$$\\sigma_z \\approx 0.8847$$\n\nFourth, we explain the implications of anisotropic voxel sizes. The goal of physically isotropic smoothing is to ensure that the effective point-spread function (PSF) of the smoothing operation is spherically symmetric in continuous physical space. In this case, the PSF is a Gaussian function with the same standard deviation, $\\sigma_p$, in all directions. However, the fMRI data exists on a discrete grid of voxels which, in this problem, is anisotropic—the sampling density is different along each axis. To create a spherically symmetric PSF in physical space, the discrete kernel used for convolution must be anisotropic in voxel space.\nOur calculations demonstrate this necessity: $\\sigma_x \\neq \\sigma_y \\neq \\sigma_z$. The standard deviation in voxel units is largest for the axis with the smallest voxel size ($\\sigma_x \\approx 1.769$ for $\\Delta_x = 1.8$ mm) and smallest for the axis with the largest voxel size ($\\sigma_z \\approx 0.8847$ for $\\Delta_z = 3.6$ mm). This means the discrete Gaussian kernel is \"stretched\" in voxel coordinates along directions of high spatial sampling (small voxels) and \"compressed\" along directions of low spatial sampling (large voxels). If one were to naively use an isotropic kernel in voxel space (e.g., $\\sigma_x = \\sigma_y = \\sigma_z$), the resulting smoothing effect in physical space would be anisotropic, with greater blurring applied along the axes with larger voxels. Therefore, to correctly implement physically isotropic smoothing, the software must construct an anisotropic kernel in the discrete voxel grid that precisely counteracts the anisotropy of the underlying data sampling.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n1.769  1.592  0.8847\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "Applying a 3D smoothing kernel voxel-by-voxel can be computationally intensive, especially for large datasets and kernels. Fortunately, the Gaussian kernel is 'separable,' a property that allows a single large 3D operation to be decomposed into three faster 1D operations. This exercise  guides you through a quantitative comparison of these two methods, providing a concrete understanding of the immense efficiency gains that are critical to modern fMRI processing pipelines.",
            "id": "4164640",
            "problem": "A functional Magnetic Resonance Imaging (fMRI) volume is smoothed with an isotropic Gaussian kernel. The volume has dimensions $N_{x} = 128$, $N_{y} = 128$, $N_{z} = 64$ voxels, and isotropic voxel size $s = 2\\ \\mathrm{mm}$. The target smoothness is a full width at half maximum (FWHM) of $8\\ \\mathrm{mm}$. The discrete kernel is constructed by truncating the continuous Gaussian at $\\pm M \\sigma$ along each axis, where $M = 3$, $\\sigma$ is the Gaussian standard deviation, and the discrete kernel length along each axis is $K = 2 r + 1$ with $r = \\lceil M \\sigma / s \\rceil$.\n\nStarting from the definition of convolution and the definition of a Gaussian, and using the relation between FWHM and the Gaussian standard deviation derived from first principles, compare the computational complexity (in terms of the total number of multiplication operations) of:\n- Naive three-dimensional convolution with the full $K \\times K \\times K$ kernel applied in one pass, versus\n- Three one-dimensional convolutions applied sequentially along $x$, $y$, and $z$ (using the separability of the Gaussian).\n\nAssume interior voxels so that boundary effects do not change per-voxel operation counts, and count the number of multiplications required over the entire volume. Compute the ratio $R$ of the total number of multiplications required by the naive three-dimensional convolution to the total number required by the separable three-pass one-dimensional convolutions, and express $R$ as a dimensionless real number. Round your final answer to four significant figures.",
            "solution": "The solution proceeds in several steps: First, we derive the relationship between the FWHM and the standard deviation $\\sigma$ of a Gaussian function. Second, we calculate the specific value of $\\sigma$ required to achieve the target FWHM. Third, we determine the size of the discrete convolution kernel, $K$. Fourth, we calculate the total number of multiplication operations for both the naive 3D convolution and the separable 1D convolution method. Finally, we compute the ratio of these two quantities.\n\n**1. Relationship between FWHM and $\\sigma$**\n\nA one-dimensional Gaussian function centered at zero is given by:\n$$g(x) = A \\exp\\left(-\\frac{x^2}{2\\sigma^2}\\right)$$\nwhere $A$ is the amplitude and $\\sigma$ is the standard deviation. The maximum value of the function is $g(0) = A$. The FWHM is the width of the function at half of its maximum value, i.e., at $A/2$. Let $x_{HM}$ be the position where this occurs.\n$$g(x_{HM}) = \\frac{A}{2}$$\n$$A \\exp\\left(-\\frac{x_{HM}^2}{2\\sigma^2}\\right) = \\frac{A}{2}$$\n$$\\exp\\left(-\\frac{x_{HM}^2}{2\\sigma^2}\\right) = \\frac{1}{2}$$\nTaking the natural logarithm of both sides:\n$$-\\frac{x_{HM}^2}{2\\sigma^2} = \\ln\\left(\\frac{1}{2}\\right) = -\\ln(2)$$\n$$x_{HM}^2 = 2\\sigma^2 \\ln(2)$$\n$$|x_{HM}| = \\sigma\\sqrt{2\\ln(2)}$$\nThe FWHM is the distance between the two points $-x_{HM}$ and $+x_{HM}$, so $\\text{FWHM} = 2 |x_{HM}|$.\n$$\\text{FWHM} = 2\\sigma\\sqrt{2\\ln(2)}$$\n\n**2. Calculating $\\sigma$**\n\nThe problem states a target smoothness of $\\text{FWHM} = 8\\ \\mathrm{mm}$. We can solve for $\\sigma$:\n$$\\sigma = \\frac{\\text{FWHM}}{2\\sqrt{2\\ln(2)}} = \\frac{8\\ \\mathrm{mm}}{2\\sqrt{2\\ln(2)}} = \\frac{4}{\\sqrt{2\\ln(2)}}\\ \\mathrm{mm}$$\n\n**3. Determining the Kernel Size $K$**\n\nThe discrete kernel is constructed by truncating the continuous Gaussian at a distance of $\\pm M\\sigma$ from the center, along each axis. The parameter $M$ is given as $3$. The physical radius of the kernel is $M\\sigma$.\n$$M\\sigma = 3 \\times \\frac{4}{\\sqrt{2\\ln(2)}}\\ \\mathrm{mm} = \\frac{12}{\\sqrt{2\\ln(2)}}\\ \\mathrm{mm}$$\nThe voxel size is $s = 2\\ \\mathrm{mm}$. The radius of the kernel in voxels, $r$, is found by dividing the physical radius by the voxel size and taking the ceiling of the result, as specified.\n$$r = \\left\\lceil \\frac{M\\sigma}{s} \\right\\rceil = \\left\\lceil \\frac{12 / \\sqrt{2\\ln(2)}}{2} \\right\\rceil = \\left\\lceil \\frac{6}{\\sqrt{2\\ln(2)}} \\right\\rceil$$\nTo evaluate this, we use the approximate value $\\ln(2) \\approx 0.693147$.\n$$\\sqrt{2\\ln(2)} \\approx \\sqrt{2 \\times 0.693147} \\approx \\sqrt{1.386294} \\approx 1.17741$$\n$$r = \\left\\lceil \\frac{6}{1.17741} \\right\\rceil = \\lceil 5.096 \\rceil = 6$$\nThe full length of the discrete kernel along one axis is $K = 2r + 1$.\n$$K = 2(6) + 1 = 13$$\nThe isotropic 3D kernel is therefore a cube of $13 \\times 13 \\times 13$ voxels.\n\n**4. Computational Complexity**\n\nLet the total number of voxels in the volume be $N_{total} = N_x N_y N_z$.\n$$N_{total} = 128 \\times 128 \\times 64 = 1048576$$\n\n**Method 1: Naive 3D Convolution**\nIn a naive 3D convolution, for each output voxel, we multiply each voxel in the kernel with the corresponding voxel in the input volume and sum the results. The number of multiplications per output voxel is equal to the number of elements in the kernel.\nNumber of kernel elements $= K \\times K \\times K = K^3$.\n$$K^3 = 13^3 = 2197$$\nThe total number of multiplications for the entire volume, $N_{mult, 3D}$, is the number of multiplications per voxel multiplied by the total number of voxels.\n$$N_{mult, 3D} = N_{total} \\times K^3 = (N_x N_y N_z) K^3$$\n\n**Method 2: Separable 1D Convolutions**\nThe 3D Gaussian kernel is separable, meaning $G(x,y,z) = G_x(x)G_y(y)G_z(z)$. Convolution with a separable kernel can be performed as a sequence of three 1D convolutions.\n1.  Convolve the entire volume along the x-axis with a 1D kernel of length $K$. For each voxel, this requires $K$ multiplications. The total for this pass is $N_{total} \\times K$.\n2.  Convolve the resulting volume from step 1 along the y-axis with a 1D kernel of length $K$. This also requires $N_{total} \\times K$ multiplications.\n3.  Convolve the resulting volume from step 2 along the z-axis with a 1D kernel of length $K$. This again requires $N_{total} \\times K$ multiplications.\n\nThe total number of multiplications for the separable method, $N_{mult, 1D}$, is the sum of the multiplications from the three passes.\n$$N_{mult, 1D} = (N_{total} \\times K) + (N_{total} \\times K) + (N_{total} \\times K) = N_{total} \\times (3K)$$\n\n**5. Computing the Ratio $R$**\n\nThe ratio $R$ is defined as the total multiplications for the naive method divided by the total for the separable method.\n$$R = \\frac{N_{mult, 3D}}{N_{mult, 1D}} = \\frac{(N_x N_y N_z) K^3}{(N_x N_y N_z) (3K)}$$\nThe volume dimensions cancel out, simplifying the ratio:\n$$R = \\frac{K^3}{3K} = \\frac{K^2}{3}$$\nSubstituting the calculated value of $K = 13$:\n$$R = \\frac{13^2}{3} = \\frac{169}{3} = 56.3333...$$\nThe problem requests the answer to be rounded to four significant figures.\n$$R \\approx 56.33$$\nThis result demonstrates the significant computational advantage of using the separability property of the Gaussian kernel for smoothing operations.",
            "answer": "$$\\boxed{56.33}$$"
        },
        {
            "introduction": "Spatial smoothing near the boundary of the brain mask presents a unique challenge, as part of the kernel may extend into areas with no data, leading to an artificial reduction in signal intensity. This problem  addresses this common issue by having you derive and apply a masked-normalization scheme. Mastering this concept is key to preventing boundary artifacts and ensuring the integrity of your smoothed data right to the edge of the brain.",
            "id": "4164570",
            "problem": "Functional magnetic resonance imaging (fMRI) volumes are defined on a three-dimensional voxel grid, but consider a single two-dimensional axial slice for clarity. Spatial smoothing is performed by convolving the slice intensity field $I(\\mathbf{r})$ with an isotropic Gaussian kernel $K(\\mathbf{r})$ to reduce high-frequency noise while preserving low-frequency structure. Near the brain mask boundary, smoothing can be biased because the convolution accumulates fewer neighbor contributions when some kernel support voxels lie outside the mask. This problem asks you to reason from first principles to formalize that bias and to derive a principled, masked-normalization scheme that rescales kernel weights by the sum over in-mask voxels so that smoothing preserves local means inside the mask.\n\nBase your derivation on the following:\n- The discrete convolution of $I(\\mathbf{r})$ with a kernel $K(\\mathbf{r})$ at location $\\mathbf{r}_{0}$ is $I_{\\mathrm{conv}}(\\mathbf{r}_{0}) = \\sum_{\\mathbf{r}} K(\\mathbf{r} - \\mathbf{r}_{0}) I(\\mathbf{r})$, where the sum is over the kernel’s finite support.\n- The Gaussian kernel on the voxel lattice is defined (up to normalization) by $K(\\Delta x, \\Delta y) \\propto \\exp\\!\\big(-\\big((\\Delta x)^{2} + (\\Delta y)^{2}\\big)/(2\\sigma^{2})\\big)$, where $\\sigma$ is the standard deviation in voxel units.\n- The brain mask is represented by an indicator function $M(\\mathbf{r}) \\in \\{0,1\\}$, which determines whether voxel $\\mathbf{r}$ is inside ($M=1$) or outside ($M=0$) the brain volume.\n\nTask:\n1. Explain, using the convolution definition above, why naive masked convolution (i.e., excluding out-of-mask voxels from the sum without compensating the kernel) biases smoothed values near the boundary when the local signal is approximately constant within the mask.\n2. Derive, from the requirement that smoothing should return the same constant when the underlying local signal is constant within the mask, a masked-normalization scheme that rescales the kernel weights by the sum of weights over in-mask voxels.\n3. Apply your scheme to the following concrete boundary configuration on a $3 \\times 3$ neighborhood centered at $\\mathbf{r}_{0}$ with offsets $(\\Delta x, \\Delta y) \\in \\{-1,0,1\\} \\times \\{-1,0,1\\}$. Let $\\sigma = 1$ voxel and define the unnormalized Gaussian weights on this $3 \\times 3$ support by $W(\\Delta x, \\Delta y) = \\exp\\!\\big(-\\big((\\Delta x)^{2} + (\\Delta y)^{2}\\big)/2\\big)$. Assume that only the four voxels with $(\\Delta x, \\Delta y) \\in \\{(0,0), (1,0), (0,1), (1,1)\\}$ are inside the brain mask ($M=1$), and all other offsets are out of mask ($M=0$). The intensities at the in-mask voxels are $I(0,0) = 100$, $I(1,0) = 80$, $I(0,1) = 90$, and $I(1,1) = 70$. Compute the masked-normalized smoothed value at the center $\\mathbf{r}_{0}$ using your derived scheme. Round your final numerical answer to four significant figures. The intensity is dimensionless; report a unitless number.",
            "solution": "The problem is addressed in three parts as requested.\n\nFirst, we explain the origin of bias in naive masked convolution.\nA spatial smoothing operation is fundamentally a weighted average of voxel intensities in a local neighborhood. For the operation to be unbiased with respect to the local mean intensity, the weights of the kernel must sum to $1$. Let the properly normalized kernel be $K'(\\mathbf{r})$, satisfying $\\sum_{\\mathbf{r}} K'(\\mathbf{r}) = 1$. The convolution of an intensity field $I(\\mathbf{r})$ is $I_{\\mathrm{conv}}(\\mathbf{r}_{0}) = \\sum_{\\mathbf{r}} K'(\\mathbf{r} - \\mathbf{r}_{0}) I(\\mathbf{r})$. If the signal is locally constant, i.e., $I(\\mathbf{r}) = C$ for all voxels $\\mathbf{r}$ in the kernel's support, the smoothed value is:\n$$I_{\\mathrm{conv}}(\\mathbf{r}_{0}) = \\sum_{\\mathbf{r}} K'(\\mathbf{r} - \\mathbf{r}_{0}) C = C \\sum_{\\mathbf{r}} K'(\\mathbf{r} - \\mathbf{r}_{0}) = C \\cdot 1 = C$$\nThis demonstrates that a properly normalized kernel preserves the mean of a constant signal.\n\nNaive masked convolution involves restricting the summation to only those voxels that are inside the brain mask, which is represented by the indicator function $M(\\mathbf{r})$. This can be expressed as summing over all voxels but setting the intensity of out-of-mask voxels to zero: $I'(\\mathbf{r}) = I(\\mathbf{r})M(\\mathbf{r})$. The naive smoothed value at $\\mathbf{r}_{0}$ is then:\n$$I_{\\mathrm{naive}}(\\mathbf{r}_{0}) = \\sum_{\\mathbf{r}} K'(\\mathbf{r} - \\mathbf{r}_{0}) I(\\mathbf{r}) M(\\mathbf{r})$$\nLet's analyze this for a locally constant signal $I(\\mathbf{r}) = C$ for all in-mask voxels.\n$$I_{\\mathrm{naive}}(\\mathbf{r}_{0}) = \\sum_{\\mathbf{r}} K'(\\mathbf{r} - \\mathbf{r}_{0}) C M(\\mathbf{r}) = C \\sum_{\\mathbf{r}} K'(\\mathbf{r} - \\mathbf{r}_{0}) M(\\mathbf{r})$$\nWhen the center voxel $\\mathbf{r}_{0}$ is far from the brain boundary, all voxels $\\mathbf{r}$ within the kernel's support centered at $\\mathbf{r}_{0}$ are inside the mask, so $M(\\mathbf{r}) = 1$ for all relevant $\\mathbf{r}$. In this case, $\\sum_{\\mathbf{r}} K'(\\mathbf{r} - \\mathbf{r}_{0}) M(\\mathbf{r}) = \\sum_{\\mathbf{r}} K'(\\mathbf{r} - \\mathbf{r}_{0}) = 1$, and $I_{\\mathrm{naive}}(\\mathbf{r}_{0}) = C$.\nHowever, when $\\mathbf{r}_{0}$ is near a boundary, some voxels $\\mathbf{r}$ in the kernel's neighborhood will be outside the mask, meaning $M(\\mathbf{r}) = 0$ for those voxels. The sum of the kernel weights is now taken over a subset of the full support:\n$$ \\sum_{\\mathbf{r}} K'(\\mathbf{r} - \\mathbf{r}_{0}) M(\\mathbf{r})  \\sum_{\\mathbf{r}} K'(\\mathbf{r} - \\mathbf{r}_{0}) = 1 $$\nAs a result, $I_{\\mathrm{naive}}(\\mathbf{r}_{0})  C$. The smoothed value is systematically underestimated, or biased towards zero, because the sum of the applied weights is less than one. This darkening effect at the edges is the bias.\n\nSecond, we derive a masked-normalization scheme.\nThe requirement is that the smoothing operation should return the constant value $C$ if the underlying signal within the mask is $I(\\mathbf{r}) = C$. Let the corrected, masked-normalized smoothed value be $I_{\\mathrm{norm}}(\\mathbf{r}_{0})$. We define this as a weighted sum of in-mask voxel intensities, using the unnormalized kernel $K(\\mathbf{r})$, divided by a normalization factor $N(\\mathbf{r}_{0})$ that may depend on the location.\n$$I_{\\mathrm{norm}}(\\mathbf{r}_{0}) = \\frac{1}{N(\\mathbf{r}_{0})} \\sum_{\\mathbf{r}} K(\\mathbf{r} - \\mathbf{r}_{0}) I(\\mathbf{r}) M(\\mathbf{r})$$\nApplying the condition that $I_{\\mathrm{norm}}(\\mathbf{r}_{0})$ must equal $C$ when $I(\\mathbf{r}) = C$ for all voxels where $M(\\mathbf{r})=1$:\n$$C = \\frac{1}{N(\\mathbf{r}_{0})} \\sum_{\\mathbf{r}} K(\\mathbf{r} - \\mathbf{r}_{0}) C M(\\mathbf{r})$$\n$$C = \\frac{C}{N(\\mathbf{r}_{0})} \\sum_{\\mathbf{r}} K(\\mathbf{r} - \\mathbf{r}_{0}) M(\\mathbf{r})$$\nFor this equality to hold for any non-zero $C$, the normalization factor must be:\n$$N(\\mathbf{r}_{0}) = \\sum_{\\mathbf{r}} K(\\mathbf{r} - \\mathbf{r}_{0}) M(\\mathbf{r})$$\nThis factor is the sum of the unnormalized kernel weights over only the voxels within the mask and the kernel's support. The masked-normalization scheme is therefore:\n$$I_{\\mathrm{norm}}(\\mathbf{r}_{0}) = \\frac{\\sum_{\\mathbf{r}} K(\\mathbf{r} - \\mathbf{r}_{0}) I(\\mathbf{r}) M(\\mathbf{r})}{\\sum_{\\mathbf{r}} K(\\mathbf{r} - \\mathbf{r}_{0}) M(\\mathbf{r})}$$\nThis formula defines a proper weighted average where the weights (the rescaled kernel values) correctly sum to $1$ over the available in-mask data for any position $\\mathbf{r}_{0}$.\n\nThird, we apply this scheme to the given concrete example.\nThe neighborhood is a $3 \\times 3$ grid of offsets $(\\Delta x, \\Delta y)$. The kernel weights are given by $W(\\Delta x, \\Delta y) = \\exp\\!\\big(-\\big((\\Delta x)^{2} + (\\Delta y)^{2}\\big)/2\\big)$, corresponding to $K(\\Delta\\mathbf{r})$ with $\\sigma=1$.\nThe in-mask voxels correspond to offsets $(\\Delta x, \\Delta y) \\in \\{(0,0), (1,0), (0,1), (1,1)\\}$.\nThe intensities at these voxels relative to the center $\\mathbf{r}_{0}$ are $I(\\mathbf{r}_{0}+(0,0)) = 100$, $I(\\mathbf{r}_{0}+(1,0)) = 80$, $I(\\mathbf{r}_{0}+(0,1)) = 90$, and $I(\\mathbf{r}_{0}+(1,1)) = 70$.\n\nWe calculate the unnormalized weights $W(\\Delta x, \\Delta y)$ for the four in-mask voxels:\n$W(0,0) = \\exp\\!\\big(-\\frac{0^2+0^2}{2}\\big) = \\exp(0) = 1$\n$W(1,0) = \\exp\\!\\big(-\\frac{1^2+0^2}{2}\\big) = \\exp(-1/2)$\n$W(0,1) = \\exp\\!\\big(-\\frac{0^2+1^2}{2}\\big) = \\exp(-1/2)$\n$W(1,1) = \\exp\\!\\big(-\\frac{1^2+1^2}{2}\\big) = \\exp(-1)$\n\nThe numerator of our formula is the sum of the products of weights and intensities for in-mask voxels:\nNumerator $= \\sum_{(\\Delta x, \\Delta y)} W(\\Delta x, \\Delta y) I(\\mathbf{r}_{0}+(\\Delta x, \\Delta y))$\nNumerator $= W(0,0)I(\\mathbf{r}_{0}+(0,0)) + W(1,0)I(\\mathbf{r}_{0}+(1,0)) + W(0,1)I(\\mathbf{r}_{0}+(0,1)) + W(1,1)I(\\mathbf{r}_{0}+(1,1))$\nNumerator $= 1 \\cdot 100 + \\exp(-1/2) \\cdot 80 + \\exp(-1/2) \\cdot 90 + \\exp(-1) \\cdot 70$\nNumerator $= 100 + 170 \\exp(-1/2) + 70 \\exp(-1)$\n\nThe denominator is the sum of the weights for in-mask voxels:\nDenominator $= \\sum_{(\\Delta x, \\Delta y)} W(\\Delta x, \\Delta y)$\nDenominator $= W(0,0) + W(1,0) + W(0,1) + W(1,1)$\nDenominator $= 1 + \\exp(-1/2) + \\exp(-1/2) + \\exp(-1)$\nDenominator $= 1 + 2 \\exp(-1/2) + \\exp(-1)$\n\nThe masked-normalized smoothed value at $\\mathbf{r}_{0}$ is the ratio:\n$$ I_{\\mathrm{norm}}(\\mathbf{r}_{0}) = \\frac{100 + 170 \\exp(-1/2) + 70 \\exp(-1)}{1 + 2 \\exp(-1/2) + \\exp(-1)} $$\nNow, we compute the numerical value:\n$\\exp(-0.5) \\approx 0.60653066$\n$\\exp(-1) \\approx 0.36787944$\nNumerator $\\approx 100 + 170(0.60653066) + 70(0.36787944) \\approx 100 + 103.110212 + 25.751561 \\approx 228.861773$\nDenominator $\\approx 1 + 2(0.60653066) + 0.36787944 \\approx 1 + 1.21306132 + 0.36787944 \\approx 2.58094076$\n$$ I_{\\mathrm{norm}}(\\mathbf{r}_{0}) \\approx \\frac{228.861773}{2.58094076} \\approx 88.67389 $$\nRounding to four significant figures, the result is $88.67$.",
            "answer": "$$\n\\boxed{88.67}\n$$"
        }
    ]
}