{
    "hands_on_practices": [
        {
            "introduction": "在实验设计中，最关键的决策之一是选择被试内设计（重复测量）还是被试间设计（独立分组）。这个选择对统计功效有着深远的影响，因为它直接关系到如何处理被试间的变异性。通过让每位被试都参与所有实验条件，被试内设计能够有效控制个体差异，因此通常能以更少的被试数量达到更高的统计功效。这项练习 () 将引导你对这两种设计进行定量比较，通过推导和计算重复测量设计所带来的效率增益，将一个理论上的优势转化为具体的数字。",
            "id": "4196378",
            "problem": "一个研究认知训练对通过脑电图（EEG）记录的事件相关电位（ERP）中P300成分影响的实验室，计划采用两种备选设计来检测峰值振幅的变化。在重复测量设计中，对同一批受试者在训练前后进行测量；在独立分组设计中，在训练前后的独立组别中测量不同的受试者，且每组样本量相等。设真实平均差异为 $\\Delta\\mu = 1.0$ 微伏。根据经验，基线变异性为 $\\sigma_{1} = 3.2$ 微伏，训练后变异性为 $\\sigma_{2} = 3.0$ 微伏。训练前后振幅的被试内相关性为 $\\rho = 0.60$。假设跨被试的测量是独立的且近似服从高斯分布，并使用学生t统计量的大样本正态近似来进行功效计算。使用双侧显著性水平 $\\alpha = 0.05$ 和期望功效 $1-\\beta = 0.80$。\n\n从统计功效的定义以及两种设计下均值差异估计量的分布特性出发，推导独立双样本检验所需的每组样本量，以及配对样本检验所需的配对数量，以使两种设计均能达到指定的 $\\alpha$ 和功效。然后，计算所需的独立分组每组样本量与所需的配对样本量之比，从而量化重复测量带来的效率提升。\n\n将最终比率四舍五入至四位有效数字。将最终比率表示为一个无单位的数。",
            "solution": "该问题要求推导并计算，为达到指定的统计功效，独立分组设计与重复测量（配对）设计所需样本量的比率。推导将基于双侧假设检验的大样本正态近似。\n\n在此背景下，样本量计算的通用公式为：\n$$ n = \\frac{\\sigma_{unit}^2 (z_{1-\\alpha/2} + z_{1-\\beta})^2}{(\\Delta\\mu)^2} $$\n其中，$n$ 是所需的样本量（对于独立设计是每组的样本量，对于配对设计是配对的数量），$\\Delta\\mu$ 是要检测的真实平均差异，$\\sigma_{unit}^2$ 是与检验统计量相关的单个观测单元的方差，$\\alpha$ 是显著性水平，$1-\\beta$ 是期望功效。$z_{1-\\alpha/2}$ 和 $z_{1-\\beta}$ 分别是对应于概率 $1-\\alpha/2$ 和 $1-\\beta$ 的标准正态分布的临界值。\n\n问题指定了 $\\Delta\\mu = 1.0$，$\\alpha = 0.05$ 和 $1-\\beta = 0.80$。对应的z值为 $z_{1-0.05/2} = z_{0.975}$ 和 $z_{1-0.20} = z_{0.80}$。这些值以及 $\\Delta\\mu$ 在两种设计的计算中都是共有的，因此在计算比率时它们会被消掉。\n\n首先，我们推导独立分组设计所需的样本量 $n_{ind}$。设训练前组的样本量为 $n_{ind}$，总体方差为 $\\sigma_1^2$；训练后组的样本量为 $n_{ind}$，总体方差为 $\\sigma_2^2$。均值差异的估计量为 $\\hat{\\Delta\\mu}_{ind} = \\bar{X}_2 - \\bar{X}_1$。由于两组是独立的，该估计量的方差是各自均值方差之和：\n$$ \\text{Var}(\\hat{\\Delta\\mu}_{ind}) = \\text{Var}(\\bar{X}_2) + \\text{Var}(\\bar{X}_1) = \\frac{\\sigma_2^2}{n_{ind}} + \\frac{\\sigma_1^2}{n_{ind}} = \\frac{\\sigma_1^2 + \\sigma_2^2}{n_{ind}} $$\n在我们的通用公式中，“单位方差” $\\sigma_{unit, ind}^2$ 对应于被 $1/n$ 缩放的方差分量。因此，$\\sigma_{unit, ind}^2 = \\sigma_1^2 + \\sigma_2^2$。所需的每组样本量为：\n$$ n_{ind} = \\frac{(\\sigma_1^2 + \\sigma_2^2)(z_{1-\\alpha/2} + z_{1-\\beta})^2}{(\\Delta\\mu)^2} $$\n\n接下来，我们推导重复测量（配对样本）设计所需的样本量 $n_{pair}$。在这里，我们有 $n_{pair}$ 个受试者，每个受试者测量两次。我们为每个受试者定义一个差异分数 $D_i = X_{i2} - X_{i1}$，其中 $X_{i1}$ 和 $X_{i2}$ 是一个受试者训练前和训练后的测量值。均值差异的估计量是这些分数的均值 $\\bar{D}$。单个差异分数的方差 $\\sigma_D^2$ 由下式给出：\n$$ \\sigma_D^2 = \\text{Var}(X_2 - X_1) = \\text{Var}(X_1) + \\text{Var}(X_2) - 2\\text{Cov}(X_1, X_2) $$\n使用相关性的定义 $\\text{Cov}(X_1, X_2) = \\rho\\sigma_1\\sigma_2$，我们得到：\n$$ \\sigma_D^2 = \\sigma_1^2 + \\sigma_2^2 - 2\\rho\\sigma_1\\sigma_2 $$\n估计量 $\\bar{D}$ 的方差为 $\\text{Var}(\\bar{D}) = \\frac{\\sigma_D^2}{n_{pair}}$。该设计的“单位方差”为 $\\sigma_{unit, pair}^2 = \\sigma_D^2$。所需的配对数量为：\n$$ n_{pair} = \\frac{\\sigma_D^2 (z_{1-\\alpha/2} + z_{1-\\beta})^2}{(\\Delta\\mu)^2} = \\frac{(\\sigma_1^2 + \\sigma_2^2 - 2\\rho\\sigma_1\\sigma_2)(z_{1-\\alpha/2} + z_{1-\\beta})^2}{(\\Delta\\mu)^2} $$\n\n问题要求的是所需独立分组每组样本量与所需配对样本量之比，即 $\\frac{n_{ind}}{n_{pair}}$。现在我们可以用推导出的表达式来构建这个比率：\n$$ \\frac{n_{ind}}{n_{pair}} = \\frac{\\frac{(\\sigma_1^2 + \\sigma_2^2)(z_{1-\\alpha/2} + z_{1-\\beta})^2}{(\\Delta\\mu)^2}}{\\frac{(\\sigma_1^2 + \\sigma_2^2 - 2\\rho\\sigma_1\\sigma_2)(z_{1-\\alpha/2} + z_{1-\\beta})^2}{(\\Delta\\mu)^2}} $$\n公共因子 $(z_{1-\\alpha/2} + z_{1-\\beta})^2 / (\\Delta\\mu)^2$ 被消掉，得到一个简化的比率表达式，该表达式仅取决于方差及其相关性：\n$$ \\frac{n_{ind}}{n_{pair}} = \\frac{\\sigma_1^2 + \\sigma_2^2}{\\sigma_1^2 + \\sigma_2^2 - 2\\rho\\sigma_1\\sigma_2} $$\n这个比率量化了配对设计相对于独立分组设计的效率提升。\n\n现在我们将给定的数值代入此表达式：\n$\\sigma_1 = 3.2$\n$\\sigma_2 = 3.0$\n$\\rho = 0.60$\n\n首先，我们计算必要的方差和协方差项：\n$\\sigma_1^2 = (3.2)^2 = 10.24$\n$\\sigma_2^2 = (3.0)^2 = 9.00$\n方差之和为 $\\sigma_1^2 + \\sigma_2^2 = 10.24 + 9.00 = 19.24$。\n与协方差相关的项为 $2\\rho\\sigma_1\\sigma_2 = 2 \\times 0.60 \\times 3.2 \\times 3.0 = 1.2 \\times 9.6 = 11.52$。\n\n现在，我们可以计算比率的分子和分母：\n分子 = $\\sigma_1^2 + \\sigma_2^2 = 19.24$\n分母 = $\\sigma_1^2 + \\sigma_2^2 - 2\\rho\\sigma_1\\sigma_2 = 19.24 - 11.52 = 7.72$\n\n最后，我们计算该比率：\n$$ \\frac{n_{ind}}{n_{pair}} = \\frac{19.24}{7.72} \\approx 2.492227979... $$\n按要求将结果四舍五入到四位有效数字，我们得到 $2.492$。这意味着，在保持所有其他参数不变的情况下，为了达到相同的统计功效，配对样本研究中每需要一名受试者，独立分组研究中则*每组*需要大约 $2.492$ 名受试者。独立分组研究的总受试者人数将是 $2 \\times n_{ind}$，这使得配对设计在这种情况下效率要高得多。",
            "answer": "$$\\boxed{2.492}$$"
        },
        {
            "introduction": "在神经科学数据分析中，伪迹剔除是一个至关重要的预处理步骤，尤其是在处理像脑电图（EEG）这样的高噪声信号时。然而，这不仅仅是一个技术操作，更是一个会带来统计学后果的决策。研究者必须在单个试次（trial）的信噪比与可用于分析的总试次数之间做出权衡。过于严苛的伪迹剔除标准会大量减少有效数据，从而可能降低统计功效。这项练习 () 将此权衡过程形式化，要求你计算出一个最优的伪迹剔除阈值，以在保证数据质量与维持足够数据量来达到目标统计功效之间取得平衡。",
            "id": "4196287",
            "problem": "一个单被试脑电图 (EEG) 实验旨在通过对跨试次均值进行双侧假设检验，来检测平均诱发响应振幅是否不为零。设感兴趣通道上单个试次的诱发响应振幅为一个随机变量 $Y$，其真实均值为 $\\mu$，已知标准差为 $\\sigma$，并假设 $Y \\sim \\mathcal{N}(\\mu,\\sigma^{2})$。你将采集 $N_{0}$ 个试次，其中比例为 $q$ 的试次属于一个伪迹生成过程。与 $Y$ 无关，每个试次还有一个伪迹指标 $Z$（例如，眼电图的峰峰值振幅），用于通过设置阈值来剔除试次。假设在给定试次类别（干净或含伪迹）的条件下，$Z \\mid \\text{clean} \\sim \\mathcal{N}(0,s_{c}^{2})$ 且 $Z \\mid \\text{artifact} \\sim \\mathcal{N}(0,s_{a}^{2})$，其中 $s_{a} \\gg s_{c}$。一种对称的伪迹剔除策略会剔除任何满足 $|Z| > T$ 的试次，其中 $T$ 是一个需要在数据采集前选定的阈值（单位为微伏）。\n\n你计划使用双侧 $z$ 检验来检验原假设 $H_{0}:\\mu=0$ 与备择假设 $H_{1}:\\mu \\neq 0$。检验的显著性水平为 $\\alpha$，对于标准化效应量 $d=\\mu/\\sigma$，目标统计功效为 $1-\\beta$。为了进行保守设计，假设只有干净的试次对统计功效有有效贡献：也就是说，将可用试次的期望数量视为通过阈值筛选的干净试次的期望数量。\n\n- 记录的总试次数为 $N_{0}=120$。\n- 伪迹比例为 $q=0.25$。\n- 干净试次的伪迹指标标准差为 $s_{c}=20$ 微伏，而含伪迹试次的伪迹指标标准差为 $s_{a}=100$ 微伏。\n- 显著性水平为 $\\alpha=0.05$（双侧），目标统计功效为 $1-\\beta=0.80$，标准化效应量为 $d=0.30$。\n\n根据以上假设，确定最小的阈值 $T$（单位为微伏），使得在 $H_1$ 成立的情况下，期望的统计功效能达到目标 $1-\\beta$。请用微伏表示你的答案，并将结果四舍五入至三位有效数字。\n\n你可以使用标准正态累积分布函数 $\\Phi(x)=\\int_{-\\infty}^{x}\\frac{1}{\\sqrt{2\\pi}}\\exp(-t^{2}/2)\\,\\mathrm{d}t$ 及其分位数（逆）函数 $\\Phi^{-1}(\\cdot)$。所有其他步骤，包括任何所需的功效计算以及为求得所需可用样本量而进行的逆运算，都必须从第一性原理推导得出。",
            "solution": "用户希望找到最小的伪迹剔除阈值 $T$，以确保在脑电图实验中进行的双侧 $z$ 检验能达到目标统计功效。这个问题可以通过以下逻辑步骤来解决：\n1.  确定为达到指定的统计功效 $1-\\beta$（在显著性水平为 $\\alpha$、效应量为 $d$ 的条件下）所需的可用试次数，我们记为 $N_{req}$。\n2.  将有效试次数 $N_{eff}$ 表示为剔除阈值 $T$ 的函数。根据题目描述，这是指通过阈值筛选的干净试次的期望数量。\n3.  令所需试次数等于有效试次数（$N_{req} = N_{eff}(T)$），然后求解阈值 $T$。\n\n首先，我们来确定所需的样本量 $N_{req}$。对于检验原假设 $H_{0}: \\mu=0$ 与备择假设 $H_{1}: \\mu \\neq 0$ 的双侧 $z$ 检验，如果检验统计量 $|Z_{stat}| = \\left|\\frac{\\bar{Y}}{\\sigma/\\sqrt{N}}\\right|$ 超过临界值 $z_{\\alpha/2} = \\Phi^{-1}(1-\\alpha/2)$，则拒绝原假设。其中 $N$ 是可用试次数，$\\bar{Y}$ 是诱发响应振幅的样本均值，$\\sigma$ 是已知标准差，$\\Phi^{-1}$ 是标准正态分布的分位数函数。\n\n在备择假设 $H_1$ 下，真实均值为 $\\mu$。检验统计量 $Z_{stat} = \\frac{\\bar{Y}}{\\sigma/\\sqrt{N}}$ 服从一个均值为 $\\frac{\\mu}{\\sigma/\\sqrt{N}} = \\frac{\\mu}{\\sigma}\\sqrt{N} = d\\sqrt{N}$、方差为1的正态分布，即 $Z_{stat} \\sim \\mathcal{N}(d\\sqrt{N}, 1)$。\n\n统计功效 $1-\\beta$ 是在 $H_1$ 为真时正确拒绝 $H_0$ 的概率：\n$$1-\\beta = P(|Z_{stat}| > z_{\\alpha/2} \\mid H_1)$$\n$$1-\\beta = P(Z_{stat} > z_{\\alpha/2}) + P(Z_{stat}  -z_{\\alpha/2})$$\n设随机变量 $\\xi \\sim \\mathcal{N}(0, 1)$。那么 $Z_{stat} = \\xi + d\\sqrt{N}$。功效为：\n$$1-\\beta = P(\\xi + d\\sqrt{N} > z_{\\alpha/2}) + P(\\xi + d\\sqrt{N}  -z_{\\alpha/2})$$\n$$1-\\beta = P(\\xi > z_{\\alpha/2} - d\\sqrt{N}) + P(\\xi  -z_{\\alpha/2} - d\\sqrt{N})$$\n$$1-\\beta = (1 - \\Phi(z_{\\alpha/2} - d\\sqrt{N})) + \\Phi(-z_{\\alpha/2} - d\\sqrt{N})$$\n对于 $d>0$ 的典型参数，第二项 $\\Phi(-z_{\\alpha/2} - d\\sqrt{N})$ 可以忽略不计。因此，功效可以由第一项很好地近似。\n$$1-\\beta \\approx 1 - \\Phi(z_{\\alpha/2} - d\\sqrt{N})$$\n$$\\beta \\approx \\Phi(z_{\\alpha/2} - d\\sqrt{N})$$\n应用标准正态累积分布函数的逆函数 $\\Phi^{-1}$：\n$$\\Phi^{-1}(\\beta) = z_{\\alpha/2} - d\\sqrt{N}$$\n利用属性 $\\Phi^{-1}(\\beta) = -z_{\\beta}$，其中 $z_{\\beta} = \\Phi^{-1}(1-\\beta)$：\n$$-z_{\\beta} = z_{\\alpha/2} - d\\sqrt{N}$$\n$$d\\sqrt{N} = z_{\\alpha/2} + z_{\\beta}$$\n求解所需的样本量 $N$，我们记为 $N_{req}$：\n$$N_{req} = \\left(\\frac{z_{\\alpha/2} + z_{\\beta}}{d}\\right)^2$$\n给定的参数为 $\\alpha=0.05$，$1-\\beta=0.80$，$d=0.30$。\n$z_{\\alpha/2} = z_{0.025} = \\Phi^{-1}(1-0.025) = \\Phi^{-1}(0.975)$。\n$z_{\\beta} = z_{0.20} = \\Phi^{-1}(1-0.20) = \\Phi^{-1}(0.80)$。\n数值上，$z_{0.025} \\approx 1.95996$ 且 $z_{0.80} \\approx 0.84162$。\n$$N_{req} = \\left(\\frac{1.95996 + 0.84162}{0.30}\\right)^2 = \\left(\\frac{2.80158}{0.30}\\right)^2 \\approx (9.3386)^2 \\approx 87.211$$\n\n接下来，我们建立有效试次数 $N_{eff}(T)$ 作为剔除阈值 $T$ 的函数的表达式。题目要求我们使用通过阈值筛选的干净试次的期望数量。\n总试次数为 $N_0 = 120$。干净试次的比例为 $1-q=1-0.25=0.75$。\n一个干净试次的伪迹指标为 $Z \\mid \\text{clean} \\sim \\mathcal{N}(0, s_c^2)$，其中 $s_c=20$ 微伏。如果 $|Z| \\le T$，则保留该试次。一个干净试次被保留的概率为：\n$$P_{keep|clean}(T) = P(|Z| \\le T \\mid \\text{clean}) = P(-T \\le Z \\le T \\mid \\text{clean})$$\n用 $W = Z/s_c \\sim \\mathcal{N}(0,1)$ 来标准化变量 $Z$：\n$$P_{keep|clean}(T) = P(-T/s_c \\le W \\le T/s_c) = \\Phi(T/s_c) - \\Phi(-T/s_c)$$\n利用对称性质 $\\Phi(-x) = 1-\\Phi(x)$：\n$$P_{keep|clean}(T) = \\Phi(T/s_c) - (1-\\Phi(T/s_c)) = 2\\Phi(T/s_c) - 1$$\n被保留的干净试次的期望数量是总试次数 $N_0$ 乘以一个试次是干净的概率 ($1-q$)，再乘以一个干净试次被保留的概率 ($P_{keep|clean}(T)$)。\n$$N_{eff}(T) = N_0 (1-q) P_{keep|clean}(T) = N_0(1-q) [2\\Phi(T/s_c) - 1]$$\n\n为了达到目标功效，我们令有效试次数等于所需试次数：\n$$N_{eff}(T) = N_{req}$$\n$$N_0(1-q)[2\\Phi(T/s_c) - 1] = \\left(\\frac{z_{\\alpha/2} + z_{\\beta}}{d}\\right)^2$$\n我们现在求解 $T$：\n$$2\\Phi(T/s_c) - 1 = \\frac{1}{N_0(1-q)} \\left(\\frac{z_{\\alpha/2} + z_{\\beta}}{d}\\right)^2$$\n$$\\Phi(T/s_c) = \\frac{1}{2}\\left[1 + \\frac{1}{N_0(1-q)} \\left(\\frac{z_{\\alpha/2} + z_{\\beta}}{d}\\right)^2\\right]$$\n$$T = s_c \\cdot \\Phi^{-1}\\left(\\frac{1}{2}\\left[1 + \\frac{N_{req}}{N_0(1-q)}\\right]\\right)$$\n代入数值：\n$N_0 = 120$，$1-q=0.75 \\implies N_0(1-q)=90$。\n$s_c = 20$。\n$N_{req} \\approx 87.211$。\n$$\\Phi(T/20) = \\frac{1}{2}\\left[1 + \\frac{87.211}{90}\\right] = \\frac{1}{2}[1 + 0.96901] = \\frac{1.96901}{2} = 0.984505$$\n现在我们通过计算标准正态累积分布函数的逆函数来求 $T/20$ 的值：\n$$T/20 = \\Phi^{-1}(0.984505) \\approx 2.1576$$\n最后，我们求解 $T$：\n$$T = 20 \\cdot 2.1576 = 43.152$$\n题目要求结果四舍五入到三位有效数字。\n$$T \\approx 43.2$$\n\n这个阈值 $T=43.2$ 微伏是能确保干净试次的期望数量足以达到 $0.80$ 的目标功效的最小阈值。更小的阈值会剔除更多的干净试次，从而减少有效样本量，并因此使功效低于目标值。",
            "answer": "$$\\boxed{43.2}$$"
        },
        {
            "introduction": "虽然解析性的功效计算公式对于简单设计非常有用，但现代神经科学实验的复杂性（例如，分层模型、复杂的依赖结构或非标准检验统计量）常常使这些公式难以适用。在这种情况下，蒙特卡洛模拟提供了一种通用且功能强大的替代方法。通过在一个特定的备择假设下反复生成模拟数据并执行预定的统计分析，我们可以凭经验估算出几乎任何复杂实验设计的统计功效。这项练习 () 是一份关于构建蒙特卡洛功效分析流程的实践指南，它将指导你从设定数据生成过程到实施有原则的停止规则，从而让你掌握这项在当代研究设计中不可或缺的关键技能。",
            "id": "4196312",
            "problem": "您的任务是为神经科学数据分析中常见的组水平比较设计并实现一个蒙特卡洛功效分析工作流。该工作流必须在指定的备择假设下模拟数据，对每个模拟数据集应用预设的统计检验，并以拒绝原假设的比例来估计统计功效。此外，它必须包含对蒙特卡洛估计量的收敛诊断，并采用一个有原则的停止规则。\n\n背景与模型。考虑一个具有两种条件的被试内实验（例如，基线和刺激）。对于每个被试 $i \\in \\{1,\\dots,N\\}$，令其未观测到的被试特定的真实条件效应为 $\\Delta_i$。假设存在一个组水平的平均效应 $\\mu$ 和被试间的变异性 $\\tau^2$，因此 $\\Delta_i$ 被建模为高斯分布，即 $\\Delta_i \\sim \\mathcal{N}(\\mu,\\tau^2)$。每个被试在每个条件下贡献 $K$ 个试次，试次水平的测量噪声服从方差为 $\\sigma^2$ 的高斯分布，并且在各试次和各条件间相互独立。观测到的被试水平差异分数 $d_i$ 是该被试在两种条件下样本平均响应之差。在所述假设下，可以通过先从 $\\Delta_i \\sim \\mathcal{N}(\\mu,\\tau^2)$ 中抽取 $\\Delta_i$，然后加上条件平均噪声 $e_i \\sim \\mathcal{N}\\!\\left(0, \\frac{2\\sigma^2}{K}\\right)$ 来模拟 $d_i$，从而得到 $d_i = \\Delta_i + e_i$。等价地，从被试的边际分布来看，$d_i \\sim \\mathcal{N}\\!\\left(\\mu, \\tau^2 + \\frac{2\\sigma^2}{K}\\right)$。\n\n预设的检验。预设的组水平检验是一个双侧单样本学生t检验，用于检验原假设 $H_0\\!:\\, \\mathbb{E}[d_i] = 0$ 与备择假设 $H_1\\!:\\, \\mathbb{E}[d_i] \\neq 0$。该检验基于 $N$ 个被试水平的差异分数 $\\{d_i\\}_{i=1}^N$ 进行计算，显著性水平为 $\\alpha$。该检验统计量使用 $\\{d_i\\}$ 的样本均值和无偏样本标准差计算得出，并与具有 $N-1$ 个自由度的学生t分布进行比较，以获得双侧p值。\n\n蒙特卡洛功效估计。功效定义为，在指定的备择假设下，预设的检验拒绝 $H_0$ 的概率。您的程序必须：\n- 在指定的备择模型下模拟独立的重复数据集；\n- 对每次重复应用预设的检验以计算拒绝指标；\n- 以拒绝指标的样本均值估计功效，结果表示为小数（而非百分数）；\n- 使用蒙特卡洛估计量在名义覆盖率为 $0.95$ 时的正态近似置信区间提供收敛诊断，并根据用户指定的半宽容差 $\\varepsilon$ 实现停止规则；\n- 以分批方式持续进行模拟，直到满足半宽标准或达到最大模拟次数 $R_{\\max}$ 为止，并且在检查停止规则前，需先完成最少初始模拟次数 $R_{\\min}$。\n\n随机性与可复现性。使用固定的随机种子 $12345$ 以确保结果的可复现性。\n\n必需输入与测试套件。为以下测试套件实现您的工作流，其中每个案例指定了 $(N, K, \\mu, \\sigma, \\tau, \\alpha, B, \\varepsilon, R_{\\max}, R_{\\min})$：\n- 案例A：$N=30$, $K=80$, $\\mu=0.3$, $\\sigma=1.0$, $\\tau=0.6$, $\\alpha=0.05$, $B=1000$, $\\varepsilon=0.01$, $R_{\\max}=100000$, $R_{\\min}=1000$。\n- 案例B：$N=25$, $K=80$, $\\mu=0.0$, $\\sigma=1.0$, $\\tau=0.6$, $\\alpha=0.05$, $B=1000$, $\\varepsilon=0.01$, $R_{\\max}=100000$, $R_{\\min}=1000$。\n- 案例C：$N=8$, $K=20$, $\\mu=0.2$, $\\sigma=1.5$, $\\tau=0.8$, $\\alpha=0.05$, $B=1000$, $\\varepsilon=0.01$, $R_{\\max}=100000$, $R_{\\min}=1000$。\n- 案例D：$N=60$, $K=100$, $\\mu=0.5$, $\\sigma=1.0$, $\\tau=0.3$, $\\alpha=0.05$, $B=1000$, $\\varepsilon=0.01$, $R_{\\max}=100000$, $R_{\\min}=1000$。\n\n收敛诊断与停止规则。每批模拟后，计算功效的蒙特卡洛估计量在名义覆盖率为 $0.95$ 时的正态近似置信区间，并检查其半宽是否小于或等于 $\\varepsilon$。仅在完成至少 $R_{\\min}$ 次模拟后才开始检查。如果满足半宽标准，则停止；否则继续模拟，直到达到 $R_{\\max}$ 为止。报告最终的蒙特卡洛标准误和所用的总模拟次数。半宽的计算必须完全在您的程序内部进行；不允许用户输入。\n\n输出规范。对于每个案例，报告一个包含三个值的列表：估计的功效（以小数表示）、蒙特卡洛标准误和所使用的模拟数据集总数。将两个浮点数量四舍五入到 $4$ 位小数，模拟次数保留为整数。将四个案例的结果按 A、B、C、D 的顺序汇总到一个列表中。您的程序应生成单行输出，包含这个汇总列表，格式为用方括号括起来的逗号分隔列表，例如 $[[p_A, s_A, r_A],[p_B, s_B, r_B],[p_C, s_C, r_C],[p_D, s_D, r_D]]$，其中每个 $p_{\\cdot}$ 和 $s_{\\cdot}$ 是一个浮点数，每个 $r_{\\cdot}$ 是一个整数。",
            "solution": "该问题是有效的，因为它具有科学依据，数学上一致，是良定的，并且为获得完整解提供了所有必需的参数。该任务涉及为神经科学中一种常见的实验设计实现蒙特卡洛功效分析，这是计算统计学中的一种标准且有原则的方法。\n\n解决方案的设计过程是，首先将数据生成过程和统计检验形式化，然后构建一个迭代算法，以指定的精度估计功效。\n\n1.  **数据生成过程**\n    对于每次模拟实验，我们需要生成一个包含 $N$ 个被试水平差异分数 $\\{d_i\\}_{i=1}^N$ 的数据集。根据问题描述，单个被试差异分数 $d_i$ 的边际分布是高斯分布。该分布的均值是真实的组水平效应 $\\mu$，其方差是被试间方差 $\\tau^2$ 与被试内测量和平均方差 $\\frac{2\\sigma^2}{K}$ 之和。\n    因此，对于每次模拟，我们从以下分布中生成 $N$ 个独立同分布的样本 $\\{d_i\\}_{i=1}^N$：\n    $$\n    d_i \\sim \\mathcal{N}\\left(\\mu, \\sigma_d^2\\right) \\quad \\text{其中} \\quad \\sigma_d^2 = \\tau^2 + \\frac{2\\sigma^2}{K}\n    $$\n    此过程的参数 $(N, K, \\mu, \\sigma, \\tau)$ 已为每个测试案例指定。\n\n2.  **统计检验与拒绝事件**\n    对于每个生成的数据集 $\\{d_i\\}_{i=1}^N$，执行双侧单样本学生t检验以检验原假设 $H_0: \\mathbb{E}[d_i] = 0$。检验统计量计算如下：\n    $$\n    t = \\frac{\\bar{d}}{\\hat{s}_d / \\sqrt{N}}\n    $$\n    其中 $\\bar{d}$ 是 $d_i$ 值的样本均值，$\\hat{s}_d$ 是它们的无偏样本标准差。将此观测到的 $t$-统计量与具有 $N-1$ 个自由度的学生t分布进行比较，以计算p值。如果获得的p值小于指定的显著性水平 $\\alpha$，则拒绝原假设。此拒绝事件是一个伯努利试验，我们可以为每次重复 $r$ 将其编码为一个指示变量 $I_r$（拒绝时 $I_r=1$，否则 $I_r=0$）。\n\n3.  **蒙特卡洛功效估计与收敛**\n    统计功效是在特定备择假设为真时正确拒绝原假设的概率。在我们的蒙特卡洛框架中，我们通过大量模拟实验中的拒绝比例来估计此概率。如果 $R$ 是总模拟次数，则功效估计值 $\\hat{p}$ 为：\n    $$\n    \\hat{p} = \\frac{1}{R} \\sum_{r=1}^R I_r\n    $$\n    该估计量的精度随 $R$ 的增加而提高。为量化此精度，我们使用比例的标准误：\n    $$\n    SE(\\hat{p}) = \\sqrt{\\frac{\\hat{p}(1-\\hat{p})}{R}}\n    $$\n    此标准误使我们能够为真实功效构建置信区间。真实功效 $p$ 的一个正态近似 $95\\%$ 置信区间由 $\\hat{p} \\pm z_{0.975} \\cdot SE(\\hat{p})$ 给出，其中 $z_{0.975} \\approx 1.96$ 是标准正态分布的第97.5百分位数。该区间的半宽为 $HW = z_{0.975} \\cdot SE(\\hat{p})$。\n\n4.  **带停止规则的算法流程**\n    一个稳健的模拟需要一个有原则的停止规则，以确保估计值稳定，同时避免运行过多的模拟。算法流程如下：\n    - 用固定的种子 $12345$ 初始化一个随机数生成器，以保证可复现性。\n    - 将总模拟次数 $R$ 和拒绝次数初始化为 $0$。\n    - 进入一个循环，只要 $R  R_{\\max}$ 就继续执行。\n    - 在循环内部，模拟一批 $B$ 个数据集。对每个数据集，执行t检验并记录结果（拒绝或不拒绝）。\n    - 更新总模拟次数 $R$ 和总拒绝次数。\n    - 在总模拟次数 $R$ 达到至少 $R_{\\min}$ 后，在每批结束时检查收敛标准。\n    - 计算当前的功效估计值 $\\hat{p}$ 及其 $95\\%$ 置信区间的半宽 $HW$。\n    - 如果 $HW \\le \\varepsilon$，则已达到所需精度。循环终止。\n    - 如果循环因 $R$ 达到 $R_{\\max}$ 而完成，但精度标准仍未满足，模拟将停止，并基于全部 $R_{\\max}$ 次模拟报告最终结果。\n    - 终止时，报告估计的功效 $\\hat{p}$、蒙特卡洛标准误 $SE(\\hat{p})$ 和总模拟次数 $R$ 的最终值。对于案例B，其中 $\\mu=0$，数据是在原假设下模拟的，因此所估计的“功效”实际上是I类错误率，它应该收敛到 $\\alpha=0.05$。\n\n为所提供的每个测试案例都实现了这整个过程。",
            "answer": "```python\nimport numpy as np\nfrom scipy import stats\n\ndef run_power_simulation(\n    N, K, mu, sigma, tau, alpha, B, epsilon, R_max, R_min, rng\n):\n    \"\"\"\n    Performs a Monte Carlo power analysis for a one-sample t-test.\n\n    Args:\n        N (int): Number of subjects.\n        K (int): Number of trials per condition.\n        mu (float): Group-level mean effect.\n        sigma (float): Trial-level measurement noise standard deviation.\n        tau (float): Between-subject standard deviation of the true effect.\n        alpha (float): Significance level for the t-test.\n        B (int): Batch size for simulations.\n        epsilon (float): Desired half-width for the 95% CI of the power estimate.\n        R_max (int): Maximum number of simulations.\n        R_min (int): Minimum number of simulations before checking convergence.\n        rng (np.random.Generator): NumPy random number generator instance.\n\n    Returns:\n        tuple: A tuple containing:\n            - float: The estimated power.\n            - float: The Monte Carlo standard error of the power estimate.\n            - int: The total number of simulations run.\n    \"\"\"\n    var_d = tau**2 + 2 * sigma**2 / K\n    std_d = np.sqrt(var_d)\n\n    z_critical = stats.norm.ppf(1 - 0.05 / 2)\n\n    total_simulations = 0\n    total_rejections = 0\n\n    while total_simulations  R_max:\n        d_samples = rng.normal(loc=mu, scale=std_d, size=(B, N))\n        \n        t_stat, p_values = stats.ttest_1samp(d_samples, popmean=0.0, axis=1)\n\n        batch_rejections = np.sum(p_values  alpha)\n\n        total_rejections += batch_rejections\n        total_simulations += B\n\n        if total_simulations >= R_min:\n            p_hat = total_rejections / total_simulations\n            \n            if p_hat == 0.0 or p_hat == 1.0:\n                se_p_hat = 0.0\n            else:\n                se_p_hat = np.sqrt(p_hat * (1 - p_hat) / total_simulations)\n\n            half_width = z_critical * se_p_hat\n\n            if half_width = epsilon:\n                break\n    \n    final_p_hat = total_rejections / total_simulations\n    if final_p_hat == 0.0 or final_p_hat == 1.0:\n        final_se_p_hat = 0.0\n    else:\n        final_se_p_hat = np.sqrt(final_p_hat * (1 - final_p_hat) / total_simulations)\n\n    return final_p_hat, final_se_p_hat, total_simulations\n\n\ndef solve():\n    \"\"\"\n    Main function to run the simulation for all test cases and print the results.\n    \"\"\"\n    rng = np.random.default_rng(12345)\n\n    test_cases = [\n        (30, 80, 0.3, 1.0, 0.6, 0.05, 1000, 0.01, 100000, 1000),\n        (25, 80, 0.0, 1.0, 0.6, 0.05, 1000, 0.01, 100000, 1000),\n        (8, 20, 0.2, 1.5, 0.8, 0.05, 1000, 0.01, 100000, 1000),\n        (60, 100, 0.5, 1.0, 0.3, 0.05, 1000, 0.01, 100000, 1000),\n    ]\n\n    results = []\n    for params in test_cases:\n        p_hat, se_p, n_sims = run_power_simulation(*params, rng=rng)\n        \n        results.append(\n            f\"[{round(p_hat, 4)},{round(se_p, 4)},{n_sims}]\"\n        )\n    \n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}