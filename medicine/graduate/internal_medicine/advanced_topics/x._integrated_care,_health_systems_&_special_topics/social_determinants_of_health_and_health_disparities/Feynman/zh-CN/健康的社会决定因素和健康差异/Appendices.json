{
    "hands_on_practices": [
        {
            "introduction": "为了有效解决健康不平等问题，我们必须首先能准确地衡量它。风险差 ($RD$)、风险比 ($RR$) 和比值比 ($OR$) 等流行病学指标，为量化不同人群间健康结果的差距提供了不同视角。本练习不仅将巩固你对这些基本指标的理解，还将挑战你批判性地思考，在制定现实决策（例如分配有限的临床资源）时，如何选择与公平原则相符的衡量指标 。",
            "id": "4899875",
            "problem": "一家内科诊所为A组和B组这两个城市社区服务，这两个社区在影响心血管风险的健康社会决定因素方面存在显著差异。在一年的时间范围内，对于未接受治疗的个体，A组发生重大心血管事件的基线概率为 $0.12$，B组为 $0.08$。请使用标准的流行病学定义，首先计算A组相对于B组发病率的风险差、风险比和比值比。\n\n该诊所计划推行一个由护士主导的高血压管理路径。根据先前的随机评估，该路径能以一个在各组间恒定的相对比例降低个体风险。该诊所今年有 $1000$ 个治疗名额的容量限制。诊所采用了一项与“成比例的普遍主义”相符的公平政策：治疗容量在各组之间的分配，与每组中每位接受治疗者预期可预防的事件绝对数量成正比。假设两组有相同数量的符合条件且寻求治疗的患者，因此分配比例仅由每位患者的预期获益决定。\n\n请确定您计算出的三个指标中，哪一个在所述效应模型和容量限制下，与此公平政策天然吻合，然后相应地计算分配给A组的治疗名额数量。\n\n您最终提交的答案必须是分配给A组的治疗名额数量，以整数形式表示。由于精确值即为整数，因此无需进行四舍五入。",
            "solution": "该问题提法明确，具有流行病学科学依据，并包含了得出唯一解所需的所有信息。因此，该问题被认定为有效。\n\n解决该问题需要多步分析。首先，我们计算标准的流行病学关联性度量指标。其次，我们将所述的资源分配政策形式化。最后，我们应用该政策来确定分配给A组的治疗名额数量。\n\n设 $I_A$ 为A组发生重大心血管事件的基线发病率（风险），$I_B$ 为B组的基线发病率。\n根据题干，我们已知：\n$I_A = 0.12$\n$I_B = 0.08$\n\n可用治疗名额总数为 $N_{total} = 1000$。\n\n**步骤1：计算流行病学指标**\n\n我们首先计算A组相对于B组发病率的风险差、风险比和比值比。\n\n1.  **风险差（RD）**：两组风险的绝对差异。\n    $$RD = I_A - I_B$$\n    $$RD = 0.12 - 0.08 = 0.04$$\n\n2.  **风险比（RR）**：A组风险与B组风险的比值。\n    $$RR = \\frac{I_A}{I_B}$$\n    $$RR = \\frac{0.12}{0.08} = 1.5$$\n\n3.  **比值比（OR）**：A组事件发生比值与B组事件发生比值的比率。对于发病率为 $I$ 的组，事件发生的比值由 $O = \\frac{I}{1-I}$ 给出。\n    A组的比值为 $O_A = \\frac{I_A}{1 - I_A} = \\frac{0.12}{1 - 0.12} = \\frac{0.12}{0.88}$。\n    B组的比值为 $O_B = \\frac{I_B}{1 - I_B} = \\frac{0.08}{1 - 0.08} = \\frac{0.08}{0.92}$。\n    $$OR = \\frac{O_A}{O_B} = \\frac{0.12 / 0.88}{0.08 / 0.92} = \\frac{0.12 \\times 0.92}{0.08 \\times 0.88} = \\frac{0.1104}{0.0704} = \\frac{1104}{704} = \\frac{69}{44}$$\n    以小数表示，$OR \\approx 1.568$。\n\n**步骤2：分析分配政策和治疗效果**\n\n分配政策规定，治疗容量的分配“与每组中每位接受治疗者预期可预防的事件绝对数量成正比”。“每位接受治疗者预期可预防的事件绝对数量”是绝对风险降低（Absolute Risk Reduction, ARR）的定义。\n设 $N_A$ 和 $N_B$ 分别为分配给A组和B组的治疗名额数量。该政策意味着：\n$N_A \\propto ARR_A$\n$N_B \\propto ARR_B$\n其中 $ARR_A$ 和 $ARR_B$ 是治疗在各组中带来的绝对风险降低。\n\n题中指明，治疗“能以一个在各组间恒定的相对比例降低个体风险”。这意味着相对风险降低（Relative Risk Reduction, RRR）对两组来说是恒定的。设这个常数为 $r$。\n$RRR = \\frac{I_{untreated} - I_{treated}}{I_{untreated}} = r$\n\n任何组的ARR都与其基线发病率和RRR相关：\n$ARR = I_{untreated} - I_{treated} = I_{untreated} \\times \\left( \\frac{I_{untreated} - I_{treated}}{I_{untreated}} \\right) = I_{untreated} \\times RRR$。\n因此，对于我们这两个组：\n$ARR_A = I_A \\times r = 0.12 r$\n$ARR_B = I_B \\times r = 0.08 r$\n\n**步骤3：确定吻合的指标并计算分配**\n\n名额的分配与每组的ARR成正比。分配给A组的总名额比例 $p_A$ 由下式给出：\n$$p_A = \\frac{N_A}{N_{total}} = \\frac{ARR_A}{ARR_A + ARR_B}$$\n代入我们关于 $ARR_A$ 和 $ARR_B$ 的表达式：\n$$p_A = \\frac{I_A \\times r}{I_A \\times r + I_B \\times r} = \\frac{I_A \\times r}{(I_A + I_B) \\times r} = \\frac{I_A}{I_A + I_B}$$\n分配给A组与B组的名额之比为：\n$$\\frac{N_A}{N_B} = \\frac{ARR_A}{ARR_B} = \\frac{I_A \\times r}{I_B \\times r} = \\frac{I_A}{I_B}$$\n这个比率 $\\frac{I_A}{I_B}$，正是我们在步骤1中计算的**风险比（RR）**。因此，在指定的治疗效果模型（恒定的RRR）和分配政策（与ARR成比例）下，风险比是决定组间资源相对分配的指标。\n\n现在我们可以计算分配给A组的名额数量 $N_A$。\n我们有总名额数量 $N_A + N_B = 1000$。\nA组的名额比例是：\n$$p_A = \\frac{I_A}{I_A + I_B} = \\frac{0.12}{0.12 + 0.08} = \\frac{0.12}{0.20} = \\frac{12}{20} = \\frac{3}{5} = 0.6$$\nA组的名额数量是此比例应用于总名额数量的结果：\n$$N_A = p_A \\times N_{total} = 0.6 \\times 1000 = 600$$\nB组的名额数量是 $N_B = N_{total} - N_A = 1000 - 600 = 400$。\n我们可以用比率来检验：$\\frac{N_A}{N_B} = \\frac{600}{400} = 1.5$，这与风险比 $\\frac{0.12}{0.08} = 1.5$ 相匹配。\n\n最终答案是分配给A组的治疗名额数量。",
            "answer": "$$\n\\boxed{600}\n$$"
        },
        {
            "introduction": "关于健康社会决定因素的研究通常依赖于观察性数据，而这类数据极易受到混杂因素的影响——即第三方变量扭曲了暴露与结局之间的关系。本练习提供了一个经典的辛普森悖论案例，展示了对医院表现进行粗略、未经调整的比较会如何导致错误的结论。通过处理这些数据，你将学会如何通过分层分析来解决这一悖论并揭示真实的潜在效应，这是批判性评估和开展观察性健康研究所需的一项关键技能 。",
            "id": "4899945",
            "problem": "一个内科质量改进小组正在比较医院$A$和医院$B$这两家医院的$30$天再入院风险，这两家医院服务的患者具有不同的社会风险特征。患者根据健康社会决定因素 (SDOH) 被分为两组：低社会风险 ($S-$) 和高社会风险 ($S+$)。在一个固定的测量期内，观察到以下计数：\n\n- $S-$ 层（低 SDOH 风险）：\n  - 医院$A$：$800$例出院中有$60$例再入院。\n  - 医院$B$：$1200$例出院中有$120$例再入院。\n- $S+$ 层（高 SDOH 风险）：\n  - 医院$A$：$1200$例出院中有$360$例再入院。\n  - 医院$B$：$300$例出院中有$105$例再入院。\n\n仅使用概率、作为条件概率的风险以及全概率定律的核心定义：\n- 计算每家医院在各分层内的特定再入院风险，并验证在每个分层内医院$A$的再入院风险是否低于医院$B$。\n- 计算每家医院的粗略（未分层）再入院风险以及比较医院$A$与医院$B$的粗略相对风险 (RR)，并确定粗略比较的方向。\n\n然后，为了解决由社会风险引起的混杂，计算跨越两个分层的、比较医院$A$与医院$B$再入院情况的 Mantel–Haenszel (MH) 公共相对风险。将最终答案表示为一个无单位的精确既约分数。最终答案中不要提供任何中间值。如果得到小数，请在报告前将其化为精确分数。",
            "solution": "将通过首先提取给定信息，然后评估其科学依据、一致性和结构来验证该问题。\n\n### 第1步：提取给定信息\n设$N_{A,S-}$和$R_{A,S-}$分别为低社会风险分层（$S-$）中医院$A$的出院数和再入院数。\n设$N_{B,S-}$和$R_{B,S-}$分别为低社会风险分层（$S-$）中医院$B$的出院数和再入院数。\n设$N_{A,S+}$和$R_{A,S+}$分别为高社会风险分层（$S+$）中医院$A$的出院数和再入院数。\n设$N_{B,S+}$和$R_{B,S+}$分别为高社会风险分层（$S+$）中医院$B$的出院数和再入院数。\n\n- $S-$ 层：\n  - 医院$A$：$R_{A,S-} = 60$, $N_{A,S-} = 800$。\n  - 医院$B$：$R_{B,S-} = 120$, $N_{B,S-} = 1200$。\n- $S+$ 层：\n  - 医院$A$：$R_{A,S+} = 360$, $N_{A,S+} = 1200$。\n  - 医院$B$：$R_{B,S+} = 105$, $N_{B,S+} = 300$。\n\n问题要求计算分层特定风险、粗略风险和粗略相对风险，以及 Mantel–Haenszel 公共相对风险。\n\n### 第2步：使用提取的给定信息进行验证\n1.  **科学依据**：该问题基于流行病学和生物统计学的既定原则，特别是风险、混杂、分层以及用于计算调整后公共相对风险的 Mantel-Haenszel 方法等概念。这个情景被称为辛普森悖论，是观察性研究中混杂效应的一个经典而现实的例证。在卫生服务研究和内科学中，使用健康社会决定因素 (SDOH) 作为分层变量是标准做法。\n2.  **适定性**：该问题提供了执行所要求计算的所有必要数据。风险、相对风险和 Mantel-Haenszel 方法的定义是标准的，允许计算出唯一且有意义的解。\n3.  **客观性**：该问题使用精确的定量数据以及流行病学领域的客观、标准术语进行陈述。它没有主观论断或歧义。\n4.  **未检测到其他缺陷**：该问题是完整的、一致的、现实的，并且在科学上是可验证的，没有发现不适定、琐碎或矛盾之处。\n\n### 第3步：结论与行动\n该问题有效。将提供完整解答。\n\n### 解答\n\n设 $A$ 代表医院$A$，$B$ 代表医院$B$。设 $R$ 为再入院事件。设 $S-$ 和 $S+$ 分别代表低社会风险和高社会风险分层。风险定义为在给定医院和分层条件下的再入院条件概率。\n\n**第1部分：分层特定再入院风险**\n\n医院的分层特定风险是该分层内的再入院数除以出院数。\n\n对于低社会风险分层 $S-$：\n- 医院$A$的风险，$P(R | A, S-)$：\n  $$ P(R | A, S-) = \\frac{R_{A,S-}}{N_{A,S-}} = \\frac{60}{800} = \\frac{3}{40} = 0.075 $$\n- 医院$B$的风险，$P(R | B, S-)$：\n  $$ P(R | B, S-) = \\frac{R_{B,S-}}{N_{B,S-}} = \\frac{120}{1200} = \\frac{1}{10} = 0.100 $$\n比较：$0.075  0.100$。在 $S-$ 分层中，医院$A$的再入院风险低于医院$B$。\n\n对于高社会风险分层 $S+$：\n- 医院$A$的风险，$P(R | A, S+)$：\n  $$ P(R | A, S+) = \\frac{R_{A,S+}}{N_{A,S+}} = \\frac{360}{1200} = \\frac{3}{10} = 0.300 $$\n- 医院$B$的风险，$P(R | B, S+)$：\n  $$ P(R | B, S+) = \\frac{R_{B,S+}}{N_{B,S+}} = \\frac{105}{300} = \\frac{21}{60} = \\frac{7}{20} = 0.350 $$\n比较：$0.300  0.350$。在 $S+$ 分层中，医院$A$的再入院风险也低于医院$B$。\n\n验证：在低风险 ($S-$) 和高风险 ($S+$) 两个分层中，医院$A$的再入院风险都低于医院$B$。\n\n**第2部分：粗略再入院风险和粗略相对风险 (RR)**\n\n粗略风险是每家医院跨越各分层的总体风险。这可以使用全概率定律计算，但更直接的方法是根据总计数计算。\n\n医院$A$的总出院数和总再入院数：\n- 总出院数 $N_A = N_{A,S-} + N_{A,S+} = 800 + 1200 = 2000$。\n- 总再入院数 $R_A = R_{A,S-} + R_{A,S+} = 60 + 360 = 420$。\n\n医院$B$的总出院数和总再入院数：\n- 总出院数 $N_B = N_{B,S-} + N_{B,S+} = 1200 + 300 = 1500$。\n- 总再入院数 $R_B = R_{B,S-} + R_{B,S+} = 120 + 105 = 225$。\n\n医院$A$的粗略风险，$P(R|A)$：\n$$ P(R|A) = \\frac{R_A}{N_A} = \\frac{420}{2000} = \\frac{21}{100} = 0.21 $$\n医院$B$的粗略风险，$P(R|B)$：\n$$ P(R|B) = \\frac{R_B}{N_B} = \\frac{225}{1500} = \\frac{9}{60} = \\frac{3}{20} = 0.15 $$\n\n比较医院$A$与医院$B$的粗略相对风险 ($RR_{\\text{crude}}$) 是它们粗略风险的比值：\n$$ RR_{\\text{crude}} = \\frac{P(R|A)}{P(R|B)} = \\frac{0.21}{0.15} = \\frac{21}{15} = \\frac{7}{5} = 1.4 $$\n粗略比较的方向：由于 $RR_{\\text{crude}} = 1.4 > 1$，粗略分析表明，医院$A$的再入院风险比医院$B$高$40\\%$。这与分层特定分析的结果相反，是辛普森悖论的一个经典例子，由社会风险变量的混杂效应引起。与医院$B$（$300/1500 = 20\\%$）相比，医院$A$有更大比例的患者处于高风险的$S+$分层（$1200/2000 = 60\\%$）。\n\n**第3部分：Mantel–Haenszel 公共相对风险**\n\n为了获得一个考虑了社会风险混杂效应的调整后关联度量，我们计算 Mantel-Haenszel 公共相对风险，$RR_{MH}$。我们可以将每个分层 $i$（其中 $i=1$ 对应 $S-$，$i=2$ 对应 $S+$）的数据表示为 $2 \\times 2$ 表格形式。\n\n分层 $1$ ($S-$)：\n- 医院$A$的再入院数 ($a_1$) = $60$。医院$A$的总人数 ($n_{11}$) = $800$。\n- 医院$B$的再入院数 ($c_1$) = $120$。医院$B$的总人数 ($n_{12}$) = $1200$。\n- 分层 $1$ 的总患者数 ($N_1$) = $800 + 1200 = 2000$。\n\n分层 $2$ ($S+$)：\n- 医院$A$的再入院数 ($a_2$) = $360$。医院$A$的总人数 ($n_{21}$) = $1200$。\n- 医院$B$的再入院数 ($c_2$) = $105$。医院$B$的总人数 ($n_{22}$) = $300$。\n- 分层 $2$ 的总患者数 ($N_2$) = $1200 + 300 = 1500$。\n\nMantel-Haenszel 相对风险由以下公式给出：\n$$ RR_{MH} = \\frac{\\sum_{i=1}^{2} \\frac{a_i n_{i2}}{N_i}}{\\sum_{i=1}^{2} \\frac{c_i n_{i1}}{N_i}} $$\n\n我们计算分子和分母项。\n\n分子（暴露组，即医院A中事件的加权和）：\n$$ \\sum_{i=1}^{2} \\frac{a_i n_{i2}}{N_i} = \\frac{a_1 n_{12}}{N_1} + \\frac{a_2 n_{22}}{N_2} $$\n$$ = \\frac{60 \\times 1200}{2000} + \\frac{360 \\times 300}{1500} $$\n$$ = \\frac{72000}{2000} + \\frac{108000}{1500} = 36 + 72 = 108 $$\n\n分母（非暴露组，即医院B中事件的加权和）：\n$$ \\sum_{i=1}^{2} \\frac{c_i n_{i1}}{N_i} = \\frac{c_1 n_{11}}{N_1} + \\frac{c_2 n_{21}}{N_2} $$\n$$ = \\frac{120 \\times 800}{2000} + \\frac{105 \\times 1200}{1500} $$\n$$ = \\frac{96000}{2000} + \\frac{126000}{1500} = 48 + 84 = 132 $$\n\n现在，我们计算比值：\n$$ RR_{MH} = \\frac{108}{132} $$\n\n为化简该分数，我们求 $108$ 和 $132$ 的最大公约数。两者都能被 $12$ 整除。\n$108 = 12 \\times 9$\n$132 = 12 \\times 11$\n$$ RR_{MH} = \\frac{9}{11} $$\n\n这个调整后的相对风险 $\\frac{9}{11} \\approx 0.818$ 表明，在调整了社会风险的混杂效应后，医院$A$的再入院风险比医院$B$低约$18.2\\%$。这一结果与分层特定分析的结果一致。",
            "answer": "$$\n\\boxed{\\frac{9}{11}}\n$$"
        },
        {
            "introduction": "虽然随机对照试验 (RCT) 是评估干预措施的黄金标准，但对于研究许多健康社会决定因素而言，它们往往不切实际或不符合伦理。这项高级练习介绍了一种强大的解决方案：使用观察性数据模拟目标试验。你将参与一个动手模拟，以估计一项政策变化（获得医疗补助计划）对健康结局的因果效应，并采用逆概率治疗加权 (IPTW) 这一复杂技术来调整混杂因素，这是现代流行病学因果推断的基石 。",
            "id": "4899936",
            "problem": "您需要使用观察性电子健康记录 (EHR) 数据，模拟一项评估获得医疗补助 (Medicaid) 覆盖对一年期死亡率影响的目标试验。该模拟以纯数学术语进行描述。考虑在时间零点有一个由 $n$ 名符合条件的个体组成的队列，每个个体都有基线协变量 $X=(x_1,x_2)$，分别代表剥夺指数和合并症指数。处理 $D \\in \\{0,1\\}$ 表示在 $30$ 天内获得医疗补助覆盖 ($D=1$) 与未在 $30$ 天内获得覆盖 ($D=0$)。二元结局 $Y \\in \\{0,1\\}$ 表示在 $365$ 天内死亡 ($Y=1$) 或存活 ($Y=0$)。目标是使用稳定权重的逆处理概率加权法，在已知的处理分配和结局生成机制下，估计两种处理策略下 $365$ 天时的因果风险差。\n\n基本基础：\n- 使用标准的因果识别条件：一致性、给定协变量下的可交换性和正值性。\n- 使用全期望定律和边际潜在结局风险的定义来论证逆概率加权的合理性。\n\n每个测试用例的数据生成过程：\n- 对于每个个体，基线协变量 $X$ 独立地从均值向量为 $\\mu$、协方差矩阵为 $\\Sigma$ 的二元正态分布中抽取。\n- 对于每个个体，处理 $D$ 独立地从成功概率为 $p_D$ 的伯努利随机变量中抽取，其中 $p_D = \\text{logit}^{-1}(\\alpha_0 + \\alpha_1 x_1 + \\alpha_2 x_2)$ 且 $\\text{logit}^{-1}(z) = \\frac{1}{1+\\exp(-z)}$。\n- 对于每个个体，结局 $Y$ 独立地从成功概率为 $p_Y$ 的伯努利随机变量中抽取，其中 $p_Y = \\text{logit}^{-1}(\\beta_0 + \\beta_1 D + \\beta_2 x_1 + \\beta_3 x_2)$。\n\n需要实现的估计量：\n- 使用在识别条件下推导出的稳定逆处理概率权重，估计在 $D=1$ 和 $D=0$ 下的一年期风险。其中倾向性得分根据上述已知的处理模型计算，并使用每个测试用例提供的阈值对倾向性得分进行截断以控制极端权重。\n- 将因果风险差计算为 $D=1$ 下的加权风险减去 $D=0$ 下的加权风险。\n- 将每个风险差表示为小数（而非百分比），并四舍五入到 $6$ 位小数。\n\n测试套件：\n为以下四个测试用例实现该估计量。对于每个案例，使用指定的随机种子以保证可复现性，并遵循上述数据生成过程生成恰好 $n$ 个独立观测值。在形成稳定权重之前，应通过将 $p_D$ 逐元素裁剪到区间 $[t_{\\min}, t_{\\max}]$ 来应用倾向性得分截断。\n\n- 案例 $1$ (一般“顺利路径”)：\n    - $n = 10000$，种子 $= 202$，\n    - $\\mu = (0, 0)$，\n    - $\\Sigma = \\begin{pmatrix} 1  0.3 \\\\ 0.3  1 \\end{pmatrix}$，\n    - 处理系数 $\\alpha = (\\alpha_0,\\alpha_1,\\alpha_2) = (-0.1, 0.8, -0.4)$，\n    - 结局系数 $\\beta = (\\beta_0,\\beta_1,\\beta_2,\\beta_3) = (-3.0, -0.5, 0.6, 0.8)$，\n    - 截断阈值：$t_{\\min} = 0.02$, $t_{\\max} = 0.98$。\n\n- 案例 $2$ (强混杂，中度重叠)：\n    - $n = 8000$，种子 $= 303$，\n    - $\\mu = (0.5, 1.0)$，\n    - $\\Sigma = \\begin{pmatrix} 1  0.6 \\\\ 0.6  1.5 \\end{pmatrix}$，\n    - $\\alpha = (-0.5, 1.2, 0.9)$，\n    - $\\beta = (-2.8, -0.7, 0.9, 1.1)$，\n    - $t_{\\min} = 0.05$, $t_{\\max} = 0.95$。\n\n- 案例 $3$ (近非重叠边界条件)：\n    - $n = 6000$，种子 $= 404$，\n    - $\\mu = (0, 0)$，\n    - $\\Sigma = \\begin{pmatrix} 1  0.9 \\\\ 0.9  1 \\end{pmatrix}$，\n    - $\\alpha = (-1.4, 2.5, -2.5)$，\n    - $\\beta = (-3.2, -0.4, 0.8, 0.8)$，\n    - $t_{\\min} = 0.10$, $t_{\\max} = 0.90$。\n\n- 案例 $4$ (小样本边缘情况)：\n    - $n = 500$，种子 $= 505$，\n    - $\\mu = (0, 0)$，\n    - $\\Sigma = \\begin{pmatrix} 1  0 \\\\ 0  1 \\end{pmatrix}$，\n    - $\\alpha = (0.0, 0.5, 0.5)$，\n    - $\\beta = (-3.5, -0.3, 0.5, 0.5)$，\n    - $t_{\\min} = 0.01$, $t_{\\max} = 0.99$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，列表中的每个条目对应上述测试用例的风险差，按所列顺序排列，并四舍五入到 $6$ 位小数（例如，$[0.012345,-0.001234,0.000000,0.999999]$）。",
            "solution": "该问题是有效的，因为它提出了一个定义明确的统计模拟任务，该任务基于因果推断的既定原则。它自成一体，所有必要的参数、模型和程序都已明确指定。它是客观的、科学上合理的，并且在计算上是可行的。\n\n目标是估计获得医疗补助覆盖对一年期死亡率的平均因果风险差。这个量在潜在结局框架内定义。对于每个个体 $i$，我们构想两个潜在结局：$Y_i^1$ 是个体接受处理（获得医疗补助，$D=1$）时的结局，而 $Y_i^0$ 是个体不接受处理（对照，$D=0$）时的结局。观察到的结局是 $Y_i = D_i Y_i^1 + (1-D_i) Y_i^0$。因果估计量是风险差，$\\tau = \\mathbb{E}[Y^1] - \\mathbb{E}[Y^0]$，其中 $\\mathbb{E}[\\cdot]$ 表示在整个群体上的期望。\n\n在观察性研究中，处理不是随机分配的，这会导致混杂。处理组和对照组的基线协变量 $X$ 可能存在系统性差异，而这些协变量也能预测结局 $Y$。为了估计因果效应 $\\tau$，我们必须对这种混杂进行调整。问题指定了三个关键的识别假设，使我们能够这样做：\n$1.$ **一致性 (Consistency)**：对于接受了处理 $d$ 的个体，其观察到的结局等于其在处理 $d$ 下的潜在结局。这在定义 $Y_i = D_i Y_i^1 + (1-D_i) Y_i^0$ 中是隐含的。\n$2.$ **条件可交换性 (Conditional Exchangeability)**：给定协变量 $X$，潜在结局与接受的处理无关：$(Y^1, Y^0) \\perp D \\mid X$。这意味着在协变量的各个分层内，处理分配实际上是随机的。\n$3.$ **正值性 (Positivity)**：对于群体中存在的所有 $X$ 值，接受任一处理水平的概率都非零：$0  P(D=1 \\mid X=x)  1$。\n\n在这些假设下，我们可以识别潜在结局的边际均值。例如，对于 $d=1$：\n$$ \\mathbb{E}[Y^1] = \\mathbb{E}_X\\left[ \\mathbb{E}[Y^1 \\mid X] \\right] \\quad (\\text{全期望定律})$$\n$$ = \\mathbb{E}_X\\left[ \\mathbb{E}[Y^1 \\mid D=1, X] \\right] \\quad (\\text{根据可交换性})$$\n$$ = \\mathbb{E}_X\\left[ \\mathbb{E}[Y \\mid D=1, X] \\right] \\quad (\\text{根据一致性})$$\n这个表达式被称为g-公式，它表明平均潜在结局是条件结局期望在整个群体的协变量分布上的平均值。\n\n逆处理概率加权（IPTW）提供了另一种估计 $\\mathbb{E}[Y^d]$ 的方法。该方法通过创建一个伪总体来起作用，在该伪总体中协变量与处理分配无关，从而消除了混杂偏倚。每个个体的权重是其在给定协变量条件下接受其实际所受处理的概率的倒数。这个概率 $e(X) = P(D=1 \\mid X)$ 被称为倾向性得分。\n\n$\\mathbb{E}[Y^1]$ 的一个简单（非稳定）IPTW估计量是 $\\frac{1}{n} \\sum_{i=1}^n \\frac{D_i Y_i}{e(X_i)}$。虽然这个估计量是无偏的，但如果一些倾向性得分接近 $0$ 或 $1$，其方差可能会很高。稳定权重用于缓解此问题。个体 $i$ 的稳定权重由 $sw_i = D_i \\frac{P(D=1)}{e(X_i)} + (1-D_i) \\frac{P(D=0)}{1-e(X_i)}$ 给出。在实践中，边际概率 $P(D=1)$ 和 $P(D=0)$ 是通过样本比例来估计的。\n\n问题要求实现一个常用且稳健的IPTW估计量版本，通常称为Hajek估计量。这个用于处理水平 $d$ 下潜在结局风险的估计量是具有 $D=d$ 的个体的结局的加权平均值。\n处理下（$d=1$）的风险估计为：\n$$ \\hat{R}^1 = \\frac{\\sum_{i=1}^n \\frac{\\mathbb{I}(D_i=1) Y_i}{e(X_i)}}{\\sum_{i=1}^n \\frac{\\mathbb{I}(D_i=1)}{e(X_i)}} $$\n对照下（$d=0$）的风险估计为：\n$$ \\hat{R}^0 = \\frac{\\sum_{i=1}^n \\frac{\\mathbb{I}(D_i=0) Y_i}{1-e(X_i)}}{\\sum_{i=1}^n \\frac{\\mathbb{I}(D_i=0)}{1-e(X_i)}} $$\n其中 $\\mathbb{I}(\\cdot)$ 是指示函数。问题还规定，在使用倾向性得分 $e(X_i)$ 之前，必须将其截断到区间 $[t_{\\min}, t_{\\max}]$ 内，以防止极端权重，这进一步增强了稳定性。\n\n对于每个测试用例，总体算法流程如下：\n$1.$ **数据生成**：使用提供的随机种子，生成一个大小为 $n$ 的数据集。\n    a. 从指定的二元正态分布 $\\mathcal{N}(\\mu, \\Sigma)$ 中为 $n$ 个个体抽取协变量 $X=(x_1, x_2)$。\n    b. 对每个个体，计算倾向性得分 $p_D = \\text{logit}^{-1}(\\alpha_0 + \\alpha_1 x_1 + \\alpha_2 x_2)$。\n    c. 从参数为 $p_D$ 的伯努利分布中抽取观察到的处理 $D$。\n    d. 对每个个体，计算结局概率 $p_Y = \\text{logit}^{-1}(\\beta_0 + \\beta_1 D + \\beta_2 x_1 + \\beta_3 x_2)$。\n    e. 从参数为 $p_Y$ 的伯努利分布中抽取观察到的结局 $Y$。\n$2.$ **估计**：\n    a. 在步骤1b中计算的倾向性得分 $p_D$ 是真实的、已知的倾向性得分。\n    b. 通过将这些倾向性得分裁剪到区间 $[t_{\\min}, t_{\\max}]$ 来对其进行截断。\n    c. 将数据细分为处理组 ($D=1$) 和对照组 ($D=0$)。\n    d. 使用截断后的倾向性得分，将上述Hajek估计量公式应用于相应的组，以计算 $\\hat{R}^1$ 和 $\\hat{R}^0$。\n    e. 计算因果风险差 $\\hat{\\tau} = \\hat{R}^1 - \\hat{R}^0$。\n$3.$ **四舍五入与输出**：将最终估计值 $\\hat{\\tau}$ 四舍五入到 $6$ 位小数。\n对所有四个测试用例重复此过程。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import expit\n\ndef solve():\n    \"\"\"\n    Executes the target trial emulation for all specified test cases and prints the results.\n    \"\"\"\n    test_cases = [\n        # Case 1: general \"happy path\"\n        {'n': 10000, 'seed': 202, 'mu': [0, 0], 'Sigma': [[1, 0.3], [0.3, 1]], \n         'alpha': [-0.1, 0.8, -0.4], 'beta': [-3.0, -0.5, 0.6, 0.8], \n         't_min': 0.02, 't_max': 0.98},\n        \n        # Case 2: strong confounding, moderate overlap\n        {'n': 8000, 'seed': 303, 'mu': [0.5, 1.0], 'Sigma': [[1, 0.6], [0.6, 1.5]],\n         'alpha': [-0.5, 1.2, 0.9], 'beta': [-2.8, -0.7, 0.9, 1.1],\n         't_min': 0.05, 't_max': 0.95},\n\n        # Case 3: near non-overlap boundary condition\n        {'n': 6000, 'seed': 404, 'mu': [0, 0], 'Sigma': [[1, 0.9], [0.9, 1]],\n         'alpha': [-1.4, 2.5, -2.5], 'beta': [-3.2, -0.4, 0.8, 0.8],\n         't_min': 0.10, 't_max': 0.90},\n        \n        # Case 4: small sample edge case\n        {'n': 500, 'seed': 505, 'mu': [0, 0], 'Sigma': [[1, 0], [0, 1]],\n         'alpha': [0.0, 0.5, 0.5], 'beta': [-3.5, -0.3, 0.5, 0.5],\n         't_min': 0.01, 't_max': 0.99}\n    ]\n\n    results = []\n    for case in test_cases:\n        result = _solve_one_case(**case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.6f}' for r in results)}]\")\n\ndef _solve_one_case(n, seed, mu, Sigma, alpha, beta, t_min, t_max):\n    \"\"\"\n    Solves a single instance of the causal inference problem.\n    \"\"\"\n    # Initialize the random number generator for reproducibility\n    rng = np.random.default_rng(seed)\n\n    # Convert lists to numpy arrays for vector/matrix operations\n    mu_arr = np.array(mu)\n    Sigma_arr = np.array(Sigma)\n    alpha_arr = np.array(alpha)\n    beta_arr = np.array(beta)\n\n    # --- Step 1: Data Generation ---\n    # Generate baseline covariates X = (x1, x2)\n    X = rng.multivariate_normal(mu_arr, Sigma_arr, size=n)\n\n    # Create design matrix for treatment model by prepending a column of ones\n    X_padded_alpha = np.c_[np.ones(n), X]\n\n    # Calculate propensity scores, p_D = logit^-1(alpha_0 + alpha_1*x1 + alpha_2*x2)\n    logit_pD = X_padded_alpha @ alpha_arr\n    pD = expit(logit_pD)\n\n    # Generate treatment assignment D\n    D = rng.binomial(1, pD)\n\n    # Create design matrix for outcome model\n    X_padded_beta = np.c_[np.ones(n), D, X]\n\n    # Calculate outcome probabilities, p_Y = logit^-1(beta_0 + beta_1*D + beta_2*x1 + beta_3*x2)\n    logit_pY = X_padded_beta @ beta_arr\n    pY = expit(logit_pY)\n    \n    # Generate outcome Y\n    Y = rng.binomial(1, pY)\n\n    # --- Step 2: Estimation using an IPTW (Hajek) Estimator ---\n    # Truncate propensity scores to avoid extreme weights\n    pD_truncated = np.clip(pD, t_min, t_max)\n\n    # Separate data into treated (D=1) and control (D=0) groups\n    treated_mask = (D == 1)\n    control_mask = (D == 0)\n\n    # Estimate risk for the treated group (R^1)\n    # Check if there are any treated individuals to avoid division by zero\n    if np.any(treated_mask):\n        Y_treated = Y[treated_mask]\n        ps_treated = pD_truncated[treated_mask]\n        \n        # Numerator and denominator of the Hajek estimator for R^1\n        numerator_r1 = np.sum(Y_treated / ps_treated)\n        denominator_r1 = np.sum(1 / ps_treated)\n\n        risk_1 = numerator_r1 / denominator_r1 if denominator_r1 != 0 else 0.0\n    else:\n        risk_1 = 0.0\n\n    # Estimate risk for the control group (R^0)\n    # Check if there are any control individuals to avoid division by zero\n    if np.any(control_mask):\n        Y_control = Y[control_mask]\n        ps_control = pD_truncated[control_mask]\n\n        # Numerator and denominator of the Hajek estimator for R^0\n        numerator_r0 = np.sum(Y_control / (1 - ps_control))\n        denominator_r0 = np.sum(1 / (1 - ps_control))\n\n        risk_0 = numerator_r0 / denominator_r0 if denominator_r0 != 0 else 0.0\n    else:\n        risk_0 = 0.0\n        \n    # Calculate the causal risk difference\n    risk_difference = risk_1 - risk_0\n\n    return risk_difference\n    \nsolve()\n```"
        }
    ]
}