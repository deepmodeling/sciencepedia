{
    "hands_on_practices": [
        {
            "introduction": "对单细胞数据进行分析的首要步骤之一是归一化，以校正技术性偏差。这个练习将带您深入探讨这一过程的核心，引导您从基本原理出发，推导出一个稳健的统计估计量。通过掌握这种方法，您将能够有效地消除细胞文库大小等技术因素带来的干扰，同时保留对揭示细胞命运至关重要的相对基因表达模式，从而为后续分析奠定坚实的基础。",
            "id": "4361230",
            "problem": "在利用单细胞 RNA 测序 (scRNA-seq) 数据对细胞命运决定进行建模时，一项核心任务是消除技术性采样深度的变异，同时保留每个细胞内基因间具有生物学意义的相对表达模式。考虑由 $i \\in \\{1,\\dots,n\\}$ 索引的 $n$ 个单细胞和由 $g \\in \\{1,\\dots,G\\}$ 索引的 $G$ 个基因。令 $x_{ig} \\in \\mathbb{N}$ 表示在细胞 $i$ 中基因 $g$ 的观测独特分子标识符计数。假设一个生成模型，在该模型中，以潜在表达和采样深度为条件，计数可以很好地近似为独立的泊松变量，\n$$\nx_{ig} \\sim \\text{Poisson}\\!\\left(s_{i}\\,\\theta_{ig}\\right),\n$$\n其中 $s_{i} > 0$ 是细胞特异性采样深度（文库大小），而 $\\theta_{ig} > 0$ 是细胞 $i$ 中基因 $g$ 的潜在预期表达水平。为了将 $\\theta_{ig}$ 与依赖于命运的程序联系起来，假设 $\\theta_{ig} = \\phi_{g}\\,r_{ig}$，其中 $\\phi_{g} > 0$ 是基因特异性基线，而 $r_{ig} > 0$ 捕捉了细胞 $i$ 中基因 $g$ 的依赖于细胞状态的相对表达。目标是以一种能够消除 $s_{i}$ 的混杂效应，同时最小化对基因间 $r_{ig}$ 分布的扭曲的方式来估计 $s_{i}$，从而保留推断细胞命运决定所需的细胞内相对表达。\n\n从该模型以及一个经过充分检验的观察（即对于大的总计数，多项式采样的泊松近似成立）出发，基于最小化对数空间中各基因与仅由观测计数构建的逐基因伪参照之间的绝对偏差之和，从第一性原理推导出一个 $s_{i}$ 的稳健估计量。具体来说，对于每个基因 $g$，取其在所有 $n$ 个细胞中的计数的几何平均值作为其伪参照水平。将注意力限制在所有细胞中计数均为严格正数的基因上，以确保对数有明确定义。利用此设定，推导出仅用观测计数 $x_{ig}$ 表示的估计量 $s_{i}$ 的解析表达式，并解释为什么用此 $s_{i}$ 对 $x_{ig}$ 进行缩放能够近似地消除采样深度混杂因子 $s_{i}$，而不会扭曲细胞内基因间的相对表达。\n\n请以一个单一的封闭形式解析表达式给出最终结果，该表达式用 $\\{x_{ig}\\}_{g=1}^{G}$ 和 $\\{x_{jg}\\}_{j=1}^{n}$ 表示 $s_i$，不带单位。无需四舍五入。",
            "solution": "该问题是有效的。它在科学上基于单细胞数据分析的原理，在算术上是一致的，并且是适定的。所有术语都有定义，任务是从一个明确陈述的优化准则中推导出一个特定的估计量。\n\n我们首先正式陈述针对单个细胞 $i$ 的问题。目标是通过最小化一个特定的目标函数来找到细胞特异性采样深度 $s_i$ 的一个估计量。问题要求我们最小化对数空间中的绝对偏差之和。对于每个基因 $g$，偏差定义为细胞 $i$ 的归一化计数的对数与该基因的伪参照水平的对数之差。\n\n让我们来定义这些组成部分：\n1.  细胞 $i$ 中基因 $g$ 的观测计数是 $x_{ig}$。\n2.  细胞 $i$ 的采样深度的估计量表示为 $\\hat{s_i}$。\n3.  经采样深度校正后的归一化计数为 $x_{ig} / \\hat{s_i}$。在对数空间中，这表示为 $\\ln(x_{ig}) - \\ln(\\hat{s_i})$。\n4.  如问题中所定义，基因 $g$ 的伪参照是其在所有 $n$ 个细胞中计数的几何平均值。我们将其称为 $p_g$。\n    $$\n    p_g = \\left( \\prod_{j=1}^{n} x_{jg} \\right)^{1/n}\n    $$\n    在对数空间中，伪参照是：\n    $$\n    \\ln(p_g) = \\ln\\left( \\left( \\prod_{j=1}^{n} x_{jg} \\right)^{1/n} \\right) = \\frac{1}{n} \\sum_{j=1}^{n} \\ln(x_{jg})\n    $$\n    问题规定我们只考虑对于所有 $j \\in \\{1,\\dots,n\\}$ 都有 $x_{jg} > 0$ 的基因，这确保了 $p_g$ 是有明确定义且为正的。\n\n基因 $g$ 在对数空间中的偏差是归一化对数计数与参照对数计数之间的差：\n$$\nd_{ig} = (\\ln(x_{ig}) - \\ln(\\hat{s_i})) - \\ln(p_g)\n$$\n目标是找到一个 $\\hat{s_i}$ 的值，使得对于一个固定的细胞 $i$，这些偏差的绝对值在所有 $G$ 个基因上的总和最小。我们将损失函数 $L(\\hat{s_i})$ 定义为：\n$$\nL(\\hat{s_i}) = \\sum_{g=1}^{G} |d_{ig}| = \\sum_{g=1}^{G} \\left| (\\ln(x_{ig}) - \\ln(p_g)) - \\ln(\\hat{s_i}) \\right|\n$$\n我们寻求最小化 $L(\\hat{s_i})$ 的 $\\hat{s_i}$ 值。令 $c_{ig} = \\ln(x_{ig}) - \\ln(p_g)$ 并令 $l_i = \\ln(\\hat{s_i})$。问题转化为找到最小化以下表达式的 $l_i$ 值：\n$$\nL(l_i) = \\sum_{g=1}^{G} | c_{ig} - l_i |\n$$\n这是一个稳健统计学中的经典问题。当 $l_i$ 是值集合 $\\{c_{ig}\\}_{g=1}^{G}$ 的中位数时，数量 $\\sum_{g=1}^{G} |c_{ig} - l_i|$ 被最小化。\n因此，采样深度对数的估计量，我们记作 $\\ln(\\hat{s_i})$，是：\n$$\n\\ln(\\hat{s_i}) = \\text{median}_{g \\in \\{1,\\dots,G\\}} \\{ c_{ig} \\} = \\text{median}_{g \\in \\{1,\\dots,G\\}} \\{ \\ln(x_{ig}) - \\ln(p_g) \\}\n$$\n代入 $\\ln(p_g)$ 的表达式：\n$$\n\\ln(\\hat{s_i}) = \\text{median}_{g \\in \\{1,\\dots,G\\}} \\left\\{ \\ln(x_{ig}) - \\frac{1}{n} \\sum_{j=1}^{n} \\ln(x_{jg}) \\right\\}\n$$\n为了找到估计量 $\\hat{s_i}$ 本身，我们对结果取指数：\n$$\n\\hat{s_i} = \\exp\\left( \\ln(\\hat{s_i}) \\right) = \\exp\\left( \\text{median}_{g \\in \\{1,\\dots,G\\}} \\left\\{ \\ln(x_{ig}) - \\frac{1}{n} \\sum_{j=1}^{n} \\ln(x_{jg}) \\right\\} \\right)\n$$\n指数函数 $\\exp(\\cdot)$ 是严格单调的。这个性质意味着一组数的中位数的指数等于这些数的指数的中位数。即 $\\exp(\\text{median}\\{y_k\\}) = \\text{median}\\{\\exp(y_k)\\}$。应用这个规则，我们可以将指数函数移到中位数算子内部：\n$$\n\\hat{s_i} = \\text{median}_{g \\in \\{1,\\dots,G\\}} \\left\\{ \\exp\\left( \\ln(x_{ig}) - \\frac{1}{n} \\sum_{j=1}^{n} \\ln(x_{jg}) \\right) \\right\\}\n$$\n利用对数和指数的性质 $\\exp(a-b) = \\exp(a)/\\exp(b)$ 和 $\\exp(\\ln(a)) = a$，我们可以简化中位数内的项：\n$$\n\\exp\\left( \\ln(x_{ig}) - \\frac{1}{n} \\sum_{j=1}^{n} \\ln(x_{jg}) \\right) = \\frac{\\exp(\\ln(x_{ig}))}{\\exp\\left(\\frac{1}{n} \\sum_{j=1}^{n} \\ln(x_{jg})\\right)} = \\frac{x_{ig}}{\\left(\\prod_{j=1}^{n} x_{jg}\\right)^{1/n}}\n$$\n将此代回 $\\hat{s_i}$ 的表达式，得到估计量的最终解析形式：\n$$\n\\hat{s_i} = \\text{median}_{g \\in \\{1,\\dots,G\\}} \\left\\{ \\frac{x_{ig}}{\\left(\\prod_{j=1}^{n} x_{jg}\\right)^{1/n}} \\right\\}\n$$\n该估计量仅依赖于观测计数 $\\{x_{ig}\\}_{g=1}^{G}$ 和 $\\{x_{jg}\\}_{j=1, g=1}^{n, G}$，符合要求。\n\n现在，我们解释为什么这个估计量能达到预期的特性。\n\n首先，它消除了采样深度的混杂效应。归一化过程用一个缩放后的计数 $x'_{ig} = x_{ig} / \\hat{s_i}$ 替换原始计数 $x_{ig}$。该估计量的逻辑基于模型假设 $x_{ig} \\sim \\text{Poisson}(s_i \\phi_g r_{ig})$，这意味着比率 $x_{ig} / (s_i \\phi_g)$ 的期望值应以 $r_{ig}$ 为中心。项 $\\left(\\prod_{j=1}^{n} x_{jg}\\right)^{1/n}$ 作为与基因特异性基线 $\\phi_g$ 成比例的量的估计。因此，比率 $x_{ig} / \\left(\\prod_{j=1}^{n} x_{jg}\\right)^{1/n}$ 是对每个基因 $g$ 与 $s_i$ 成比例的量的估计。通过取这些比率在所有基因中的中位数，我们得到了采样深度 $s_i$ 的一个稳健估计 $\\hat{s_i}$（相差一个全局缩放常数）。将 $x_{ig}$ 除以 $\\hat{s_i}$ 有效地消除了细胞特异性因子 $s_i$，将所有细胞置于一个可比较的表达尺度上。使用中位数确保了该估计不会被少数具有非常高或非常低的细胞状态依赖性表达（即 $r_{ig} \\ll 1$ 或 $r_{ig} \\gg 1$）的基因所扭曲，而这些基因在细胞命运决定过程中是预期会出现的。\n\n其次，它保留了细胞内的相对表达。单个细胞 $i$ 内的相对表达模式由不同基因表达水平的比率决定，例如 $\\theta_{ig_1} / \\theta_{ig_2}$。对此的一个经验代理是观测计数的比率 $x_{ig_1} / x_{ig_2}$。当我们应用归一化时，同一细胞 $i$ 内两个基因 $g_1$ 和 $g_2$ 的缩放后计数的比率为：\n$$\n\\frac{x'_{ig_1}}{x'_{ig_2}} = \\frac{x_{ig_1}/\\hat{s_i}}{x_{ig_2}/\\hat{s_i}} = \\frac{x_{ig_1}}{x_{ig_2}}\n$$\n由于归一化因子 $\\hat{s_i}$ 对于给定细胞 $i$ 内的所有基因都是常数，因此它在任何细胞内比率中都被完全抵消了。因此，细胞内基因转录本的相对丰度得以保留，这对于基于其独特的基因表达特征来识别细胞类型和状态至关重要。",
            "answer": "$$\n\\boxed{\\text{median}_{g \\in \\{1,\\dots,G\\}} \\left\\{ \\frac{x_{ig}}{\\left(\\prod_{j=1}^{n} x_{jg}\\right)^{1/n}} \\right\\}}\n$$"
        },
        {
            "introduction": "在预处理数据之后，我们通常会采用降维技术来可视化和探索细胞状态，但这引出了一个关键问题：何时线性方法（如主成分分析PCA）已足够，何时我们必须采用非线性方法（如UMAP）？本练习将通过分析数据协方差矩阵的谱（即特征值），建立一个量化标准来辅助决策。通过计算线性模型未能捕捉到的“信号”部分的比例，您将学会如何以数据驱动的方式，判断是否需要更复杂的非线性流形方法来准确描绘细胞命运轨迹。",
            "id": "4361368",
            "problem": "考虑一个单细胞RNA测序 (scRNA-seq) 数据集，其由一个零中心化的基因表达矩阵 $X \\in \\mathbb{R}^{n \\times m}$ 表示，其中 $n$ 表示细胞数量，$m$ 表示经过预处理和特征选择后分析的基因数量。令样本协方差矩阵为 $S = \\frac{1}{n} X^{\\top} X$，并假设 $S$ 具有特征分解 $S = U \\Lambda U^{\\top}$，其中 $U \\in \\mathbb{R}^{m \\times m}$ 是标准正交矩阵，$\\Lambda = \\mathrm{diag}(\\lambda_{1}, \\lambda_{2}, \\dots, \\lambda_{m})$，特征值按 $\\lambda_{1} \\ge \\lambda_{2} \\ge \\dots \\ge \\lambda_{m} \\ge 0$ 排序。您使用通过主成分分析 (PCA) 获得的 $k$ 维线性子空间来模拟与细胞命运相关的潜在结构，该子空间通过将每个细胞投影到前 $k$ 个特征向量所张成的空间上得到。\n\n从线性代数中正交投影的基本定义和对称矩阵的谱定理出发，推导出投影到这个 $k$ 维子空间所产生的每个细胞的均方重构误差 $E_{k}$ 的表达式，该表达式应使用特征值 $\\lambda_{j}$ 和维度 $k$ 来表示。\n\n为了评估线性子空间是否足够，或者是否可能需要非线性流形方法来进行精确的命运建模，采用以下生成噪声模型：技术噪声近似为各向同性，每个基因的方差为 $\\sigma^{2}$，因此 $S = S_{\\mathrm{signal}} + \\sigma^{2} I_{m}$。定义归一化超额重构误差\n$$\n\\gamma \\;=\\; \\frac{E_{k} - (m - k)\\sigma^{2}}{\\sum_{j=1}^{m} \\lambda_{j} - m \\sigma^{2}} \\, ,\n$$\n它量化了除舍弃维度贡献的不可约噪声基底之外，未被 $k$ 维线性子空间捕获的信号方差的比例。\n\n使用以下从与细胞命运决定对齐的分化时间序列中凭经验获得的光谱，其中有 $m = 8$ 个基因和 $k = 2$：\n$$\n\\lambda_{1} = 3.1,\\;\\; \\lambda_{2} = 2.4,\\;\\; \\lambda_{3} = 1.7,\\;\\; \\lambda_{4} = 1.1,\\;\\; \\lambda_{5} = 0.6,\\;\\; \\lambda_{6} = 0.35,\\;\\; \\lambda_{7} = 0.2,\\;\\; \\lambda_{8} = 0.15,\n$$\n以及独立估计的各向同性技术噪声方差 $\\sigma^{2} = 0.15$，计算 $\\gamma$ 的值。将您的答案四舍五入到四位有效数字。最终值以无单位的纯数字表示。在您的推导中，从正交投影和协方差的核心线性代数定义开始，不要引用关于PCA重构误差或方差分解的现有公式。最后，根据 $\\gamma$ 的大小，解释它如何说明在该数据集中使用非线性流形方法进行命运建模的必要性。",
            "solution": "首先根据指定标准验证问题。\n\n### 步骤1：提取已知条件\n- 数据矩阵：一个零中心化的基因表达矩阵 $X \\in \\mathbb{R}^{n \\times m}$，其中有 $n$ 个细胞和 $m$ 个基因。\n- 样本协方差矩阵：$S = \\frac{1}{n} X^{\\top} X$。\n- $S$ 的特征分解：$S = U \\Lambda U^{\\top}$，其中 $U \\in \\mathbb{R}^{m \\times m}$ 是标准正交矩阵，$\\Lambda = \\mathrm{diag}(\\lambda_{1}, \\lambda_{2}, \\dots, \\lambda_{m})$，特征值按 $\\lambda_{1} \\ge \\lambda_{2} \\ge \\dots \\ge \\lambda_{m} \\ge 0$ 排序。\n- PCA 模型：一个由 $S$ 的前 $k$ 个特征向量张成的 $k$ 维线性子空间。\n- 关注的定义：每个细胞的均方重构误差，$E_k$。\n- 生成噪声模型：$S = S_{\\mathrm{signal}} + \\sigma^{2} I_{m}$，其中 $\\sigma^{2}$ 是各向同性技术噪声方差。\n- 度量定义：归一化超额重构误差 $\\gamma \\;=\\; \\frac{E_{k} - (m - k)\\sigma^{2}}{\\sum_{j=1}^{m} \\lambda_{j} - m \\sigma^{2}}$。\n- 经验数据：\n  - $m = 8$\n  - $k = 2$\n  - 特征值：$\\lambda_{1} = 3.1$, $\\lambda_{2} = 2.4$, $\\lambda_{3} = 1.7$, $\\lambda_{4} = 1.1$, $\\lambda_{5} = 0.6$, $\\lambda_{6} = 0.35$, $\\lambda_{7} = 0.2$, $\\lambda_{8} = 0.15$。\n  - 噪声方差：$\\sigma^{2} = 0.15$。\n\n### 步骤2：使用提取的已知条件进行验证\n该问题具有科学依据，使用了线性代数中的标准定义（PCA、特征分解、正交投影），并将其应用于系统生物医学中的一个常见问题（分析单细胞数据）。所提供的协方差矩阵、PCA 和噪声模型的定义是标准的且自洽的。该问题是适定的，因为它提供了得出唯一解所需的所有数值和定义。语言客观、正式。所提供的特征值是非负且单调递减的，与样本协方差矩阵的性质一致。没有矛盾、歧义或缺失信息。该问题被认定为有效。\n\n### 步骤3：结论与行动\n问题有效。将提供完整解答。\n\n### 每个细胞均方重构误差 $E_k$ 的推导\n令 $U$ 的列为与特征值 $\\lambda_1, \\lambda_2, \\dots, \\lambda_m$ 对应的特征向量 $u_1, u_2, \\dots, u_m$。维度为 $n \\times m$ 的矩阵 $X$ 的行代表每个细胞的基因表达向量。令 $x_i \\in \\mathbb{R}^m$ 为与第 $i$ 个细胞的表达谱相对应的列向量（即 $X$ 的第 $i$ 行的转置）。数据是零中心化的，即 $\\frac{1}{n}\\sum_{i=1}^n x_i = 0$。\n\n数据点 $x_i$ 在由前 $k$ 个特征向量 $\\{u_1, \\dots, u_k\\}$ 张成的 $k$ 维子空间上的投影由 $\\hat{x}_i$ 给出。令 $U_k$ 是以 $u_1, \\dots, u_k$ 为列的矩阵。到该子空间上的投影矩阵为 $P_k = U_k U_k^\\top$。因此，投影为 $\\hat{x}_i = P_k x_i$。\n\n单个细胞 $x_i$ 的重构误差是原始向量与其投影之差的平方欧几里得范数：$\\|x_i - \\hat{x}_i\\|^2$。到该子空间的正交补空间上的投影由投影矩阵 $I_m - P_k$ 给出，其中 $I_m$ 是 $m \\times m$ 的单位矩阵。向量 $x_i - \\hat{x}_i = (I_m - P_k)x_i$ 是 $x_i$ 中与该子空间正交的分量。根据正交向量的勾股定理，$\\|x_i\\|^2 = \\|\\hat{x}_i\\|^2 + \\|x_i - \\hat{x}_i\\|^2$。平方重构误差是残差向量的平方范数。\n\n每个细胞的均方重构误差 $E_k$ 是所有 $n$ 个细胞的这些误差的平均值：\n$$\nE_k = \\frac{1}{n} \\sum_{i=1}^{n} \\|x_i - \\hat{x}_i\\|^2\n$$\n由 $\\{u_{k+1}, \\dots, u_m\\}$ 张成的正交补空间上的投影矩阵是 $P_{>k} = I_m - P_k = \\sum_{j=k+1}^m u_j u_j^\\top$。细胞 $i$ 的误差是 $\\|P_{>k} x_i\\|^2$。\n$$\nE_k = \\frac{1}{n} \\sum_{i=1}^{n} \\|P_{>k} x_i\\|^2 = \\frac{1}{n} \\sum_{i=1}^{n} (P_{>k} x_i)^\\top (P_{>k} x_i)\n$$\n因为 $P_{>k}$ 是一个投影矩阵，所以它是幂等的（$P_{>k}^2 = P_{>k}$）和对称的（$P_{>k}^\\top = P_{>k}$）。\n$$\nE_k = \\frac{1}{n} \\sum_{i=1}^{n} x_i^\\top P_{>k} x_i\n$$\n使用标量 $s = v^\\top M v$ 的性质 $s = \\mathrm{Tr}(s) = \\mathrm{Tr}(v^\\top M v) = \\mathrm{Tr}(M v v^\\top)$，我们可以重写表达式：\n$$\nE_k = \\frac{1}{n} \\sum_{i=1}^{n} \\mathrm{Tr}(P_{>k} x_i x_i^\\top)\n$$\n根据迹算子的线性性质，我们可以将求和移到内部：\n$$\nE_k = \\mathrm{Tr}\\left(P_{>k} \\left(\\frac{1}{n} \\sum_{i=1}^{n} x_i x_i^\\top\\right)\\right)\n$$\n项 $\\frac{1}{n} \\sum_{i=1}^{n} x_i x_i^\\top$ 正是样本协方差矩阵 $S = \\frac{1}{n} X^\\top X$。这可以通过写出 $X^\\top X = \\sum_{i=1}^n x_i x_i^\\top$ 来看出。\n$$\nE_k = \\mathrm{Tr}(P_{>k} S) = \\mathrm{Tr}\\left(\\left(\\sum_{j=k+1}^m u_j u_j^\\top\\right) S\\right) = \\sum_{j=k+1}^m \\mathrm{Tr}(u_j u_j^\\top S)\n$$\n使用迹的循环性质 $\\mathrm{Tr}(ABC) = \\mathrm{Tr}(CAB)$：\n$$\n\\mathrm{Tr}(u_j u_j^\\top S) = \\mathrm{Tr}(u_j^\\top S u_j)\n$$\n由于 $u_j$ 是 $S$ 的一个特征向量，其特征值为 $\\lambda_j$，我们有 $S u_j = \\lambda_j u_j$。\n$$\nu_j^\\top S u_j = u_j^\\top (\\lambda_j u_j) = \\lambda_j (u_j^\\top u_j)\n$$\n由于 $U$ 是一个标准正交矩阵，所以 $u_j^\\top u_j = 1$。项 $u_j^\\top S u_j$ 是一个 $1 \\times 1$ 的矩阵（一个标量），等于 $\\lambda_j$。标量的迹是其本身。\n因此，$\\mathrm{Tr}(u_j^\\top S u_j) = \\lambda_j$。将其代回 $E_k$ 的求和式中：\n$$\nE_k = \\sum_{j=k+1}^{m} \\lambda_j\n$$\n这个表达式表明，均方重构误差是与舍弃的主成分相对应的特征值的总和。\n\n### $\\gamma$ 的计算\n给定值 $m=8$，$k=2$，$\\sigma^2=0.15$，以及特征值列表。\n\n首先，我们计算 $E_k = E_2$，即从 $\\lambda_3$ 到 $\\lambda_8$ 的特征值之和：\n$$\nE_2 = \\sum_{j=3}^{8} \\lambda_j = \\lambda_3 + \\lambda_4 + \\lambda_5 + \\lambda_6 + \\lambda_7 + \\lambda_8\n$$\n$$\nE_2 = 1.7 + 1.1 + 0.6 + 0.35 + 0.2 + 0.15 = 4.1\n$$\n接下来，我们计算 $\\gamma$ 的分子：$E_k - (m-k)\\sigma^2$。\n$$\nE_2 - (8-2)\\sigma^2 = 4.1 - (6)(0.15) = 4.1 - 0.9 = 3.2\n$$\n现在，我们计算 $\\gamma$ 的分母：$\\sum_{j=1}^{m} \\lambda_{j} - m \\sigma^{2}$。\n首先，对所有特征值求和：\n$$\n\\sum_{j=1}^{8} \\lambda_{j} = (\\lambda_1 + \\lambda_2) + E_2 = (3.1 + 2.4) + 4.1 = 5.5 + 4.1 = 9.6\n$$\n然后，计算 $m\\sigma^2$：\n$$\nm\\sigma^2 = (8)(0.15) = 1.2\n$$\n分母为：\n$$\n\\sum_{j=1}^{8} \\lambda_{j} - m \\sigma^{2} = 9.6 - 1.2 = 8.4\n$$\n最后，我们计算 $\\gamma$：\n$$\n\\gamma = \\frac{3.2}{8.4} = \\frac{32}{84} = \\frac{8}{21}\n$$\n进行除法运算并四舍五入到四位有效数字：\n$$\n\\gamma \\approx 0.38095238... \\approx 0.3810\n$$\n\n### 结果的解释\n量 $\\gamma$ 表示未被 $k$ 维线性近似捕获的总*信号*方差的比例。分母 $\\sum \\lambda_j - m\\sigma^2$ 表示数据中的总方差减去估计的总噪声方差，这是对总生物信号方差的估计。分子 $E_k - (m-k)\\sigma^2$ 表示重构误差减去来自舍弃维度的预期噪声基底，这是对存在于那些舍弃维度中的生物信号方差的估计。\n\n$\\gamma \\approx 0.3810$ 的值表明，当数据投影到前两个主成分上时，大约有 $38.1\\%$ 的估计生物信号丢失了。这是一个相当大的比例。如果潜在的数据流形能被一个二维平面很好地近似，我们预期较小的主成分将主要捕获噪声，从而导致 $\\gamma$ 值接近于 $0$。此处获得的高 $\\gamma$ 值强烈表明线性子空间遗漏了重要的生物结构。这种结构很可能是非线性的，意味着分化轨迹在高维基因表达空间中形成了一个弯曲的流形。因此，这一结果意味着像PCA这样的线性方法不足以精确地模拟这一细胞命运决定过程，有必要采用非线性流形学习方法（例如，UMAP，扩散图）来更好地捕捉数据的潜在几何结构。",
            "answer": "$$\n\\boxed{0.3810}\n$$"
        },
        {
            "introduction": "为了真正对细胞命运进行建模，我们需要捕捉基因表达的动态变化过程，而不仅仅是静态快照。基于新生（未剪接）和成熟（已剪接）mRNA计数的RNA速度理论，为此提供了强有力的分析框架。这个综合性练习将指导您基于转录动力学，为这些分子计数构建一个生成式统计模型，并推导与实现一个期望最大化（EM）算法来拟合模型参数。完成此练习将使您能够整合动力学、统计推断和计算编程等知识，构建现代细胞命运建模的核心引擎。",
            "id": "4361243",
            "problem": "考虑一个单细胞群体，其中信使核糖核酸（mRNA）分子通过转录生成未剪接的转录本，然后以一级速率进行剪接，并以剪接后转录本的形式降解。针对单个基因，在以下经过充分检验的动力学假设下，对每个细胞中未剪接和已剪接的计数进行建模：未剪接丰度根据 $du/dt = \\alpha_z - \\beta u$ 演化，已剪接丰度根据 $ds/dt = \\beta u - \\gamma s$ 演化，且未剪接分子的降解可忽略不计。这里，$\\alpha_z$ 是转录速率，依赖于一个离散的潜在命运状态 $z \\in \\{A,B\\}$；$\\beta$ 是剪接速率；$\\gamma$ 是已剪接转录本的降解速率。假设在每种命运状态内部达到稳态，因此稳态均值满足 $u^\\star = \\alpha_z / \\beta$ 和 $s^\\star = \\alpha_z / \\gamma$。\n\n每个细胞 $i$ 有一个已知的文库大小因子 $\\ell_i > 0$，该因子会缩放其期望计数。在给定潜在命运 $z$ 的条件下，观测到的未剪接计数 $U_i$ 和已剪接计数 $S_i$ 被建模为条件独立的泊松随机变量，其均值分别为 $\\mathbb{E}[U_i \\mid z] = \\ell_i \\, u^\\star$ 和 $\\mathbb{E}[S_i \\mid z] = \\ell_i \\, s^\\star$。在所有细胞中，潜在命运是一个混合模型，状态 $A$ 的混合比例为 $\\pi \\in (0,1)$，状态 $B$ 的混合比例为 $1-\\pi$。动力学速率 $\\beta$ 和 $\\gamma$ 被视为已知常数，需要估计的参数是特定于状态的转录速率 $\\alpha_A > 0$、$\\alpha_B > 0$ 以及混合比例 $\\pi$。\n\n您的任务是：\n- 根据 $\\alpha_A$、$\\alpha_B$ 和 $\\pi$ 构建在此动力学混合模型下观测数据的似然函数。\n- 从泊松分布的基本定义和细胞的独立性出发，推导一个基于期望最大化 (Expectation-Maximization (EM)) 或变分推断 (Variational Inference (VI)) 的原则性算法，以得出 $\\alpha_A$、$\\alpha_B$ 和 $\\pi$ 的最大似然估计或变分估计。推导必须从包含潜在分配的完全数据对数似然开始，并得出能够保证证据下界或似然函数非递减的显式更新方程。\n- 实现所推导的算法，为下面定义的测试套件中的每个数据集估计 $\\alpha_A$、$\\alpha_B$ 和 $\\pi$。在责任更新中，使用对数域中的数值稳定计算。使用观测数据对数似然的相对改进量的收敛容差 $\\varepsilon = 10^{-9}$ 或最大迭代次数 $T_{\\max} = 1000$，以先达到的条件为准。\n\n测试套件和要求的输出：\n对于下面的三个数据集，使用提供的已知动力学速率 $(\\beta, \\gamma)$、观测到的未剪接计数 $\\{U_i\\}$、观测到的已剪接计数 $\\{S_i\\}$、文库大小 $\\{\\ell_i\\}$ 以及初始化值 $(\\alpha_A^{(0)}, \\alpha_B^{(0)}, \\pi^{(0)})$。对每个数据集，运行您的算法直至收敛，并返回最终估计值 $(\\hat{\\alpha}_A, \\hat{\\alpha}_B, \\hat{\\pi})$ 以及在这些估计值下计算出的最终观测数据对数似然 $\\mathcal{L}$。最终输出中的所有浮点数必须四舍五入到六位小数。最终输出必须是单行，包含一个外层列表和三个内层列表（每个数据集一个），每个内层列表必须按顺序包含四个数字 $(\\hat{\\alpha}_A, \\hat{\\alpha}_B, \\hat{\\pi}, \\mathcal{L})$。\n\n数据集 1 (命运均衡，计数中等):\n- 已知动力学速率: $\\beta = 0.5$, $\\gamma = 0.25$。\n- 文库大小: $\\ell = [1.0,\\,0.8,\\,1.2,\\,0.9,\\,1.1,\\,0.7,\\,1.3,\\,1.0]$。\n- 未剪接计数: $U = [5,\\,3,\\,5,\\,4,\\,14,\\,8,\\,16,\\,13]$。\n- 已剪接计数: $S = [9,\\,7,\\,10,\\,7,\\,27,\\,17,\\,30,\\,22]$。\n- 初始化: $\\alpha_A^{(0)} = 1.0$, $\\alpha_B^{(0)} = 5.0$, $\\pi^{(0)} = 0.5$。\n\n数据集 2 (状态 A 占优，剪接速率较高):\n- 已知动力学速率: $\\beta = 0.7$, $\\gamma = 0.35$。\n- 文库大小: $\\ell = [1.0,\\,0.6,\\,1.4,\\,0.9,\\,1.1,\\,0.5,\\,1.2,\\,0.8,\\,1.3,\\,1.0]$。\n- 未剪接计数: $U = [4,\\,3,\\,6,\\,4,\\,5,\\,2,\\,5,\\,3,\\,17,\\,13]$。\n- 已剪接计数: $S = [9,\\,5,\\,12,\\,8,\\,9,\\,5,\\,11,\\,7,\\,33,\\,26]$。\n- 初始化: $\\alpha_A^{(0)} = 2.0$, $\\alpha_B^{(0)} = 10.0$, $\\pi^{(0)} = 0.8$。\n\n数据集 3 (低计数和相等速率的边缘情况):\n- 已知动力学速率: $\\beta = 1.0$, $\\gamma = 1.0$。\n- 文库大小: $\\ell = [0.5,\\,1.0,\\,0.3,\\,1.2,\\,0.7,\\,0.4]$。\n- 未剪接计数: $U = [0,\\,0,\\,0,\\,3,\\,1,\\,1]$。\n- 已剪接计数: $S = [0,\\,1,\\,0,\\,2,\\,2,\\,1]$。\n- 初始化: $\\alpha_A^{(0)} = 0.8$, $\\alpha_B^{(0)} = 1.5$, $\\pi^{(0)} = 0.5$。\n\n实现和输出要求：\n- 您的算法必须从第一性原理推导，并且在实现时不使用任何预构建的混合模型例程。它必须在对数域中计算责任以防止数值下溢，并且必须在泊松模型下精确评估观测数据对数似然 $\\mathcal{L}$。\n- 所有计算都必须是无单位的，因为计数是无量纲的，缩放因子 $\\ell_i$ 也是无量纲的。不要引入物理单位。\n- 您的程序应生成单行输出，其中包含一个包含三个内部列表的外部列表形式的结果。每个内部列表必须按 $(\\hat{\\alpha}_A, \\hat{\\alpha}_B, \\hat{\\pi}, \\mathcal{L})$ 的顺序排列，所有值必须四舍五入到六位小数。输出必须打印为单行，例如，一个外部列表，其中恰好包含三个内部列表，无附加文本。",
            "solution": "该问题要求推导并实现一个算法，以寻找单细胞 RNA 计数动力学混合模型参数的最大似然估计。该模型描述了单个基因在属于两个潜在命运（$A$ 和 $B$）的细胞群体中，未剪接 ($u$) 和已剪接 ($s$) mRNA 的丰度。\n\n### 问题验证\n问题陈述已经过验证，被认为是有效的。\n- **科学依据**：mRNA 的动力学方程（$du/dt = \\alpha_z - \\beta u$，$ds/dt = \\beta u - \\gamma s$）是转录和剪接动力学的标准表示。使用泊松分布对单细胞分子计数进行建模，以及使用有限混合模型表示细胞群体的异质性，是系统生物医学和计算生物学中成熟且科学合理的方法。\n- **适定性**：该任务是一个有限混合模型的参数估计问题，这是一个适定的统计问题。期望最大化 (EM) 算法是在此背景下寻找最大似然估计的标准且合适的方法。提供了所有必要的数据（计数、文库大小、动力学速率）和初始参数值，确保可以获得一个特定且可复现的解。\n- **客观性和完整性**：该问题通过精确的数学定义和客观的量化数据进行了规定。它内容自洽，并提供了求解所需的所有条件。\n\n### 似然公式\n设 $\\Theta = \\{\\alpha_A, \\alpha_B, \\pi\\}$ 为待估计的参数集。$N$ 个细胞的观测数据为 $D = \\{(U_i, S_i)\\}_{i=1}^N$。对于每个细胞 $i$，设 $Z_i \\in \\{A, B\\}$ 是指示其命运的潜变量。\n\n根据模型，对于处于命运 $z \\in \\{A, B\\}$ 的细胞 $i$，观测到的计数 $U_i$ 和 $S_i$ 是独立的泊松随机变量，其均值为：\n$$ \\lambda_{i,U,z} = \\ell_i u^\\star_z = \\ell_i \\frac{\\alpha_z}{\\beta} $$\n$$ \\lambda_{i,S,z} = \\ell_i s^\\star_z = \\ell_i \\frac{\\alpha_z}{\\gamma} $$\n在给定细胞处于命运 $z$ 的情况下，观测到 $(U_i, S_i)$ 的概率为：\n$$ P(U_i, S_i | Z_i=z, \\Theta) = \\text{Poisson}(U_i; \\lambda_{i,U,z}) \\cdot \\text{Poisson}(S_i; \\lambda_{i,S,z}) $$\n根据全概率定律，观测到 $(U_i, S_i)$ 的边际概率是每种命运概率的混合：\n$$ P(U_i, S_i | \\Theta) = P(Z_i=A)P(U_i, S_i | Z_i=A, \\Theta) + P(Z_i=B)P(U_i, S_i | Z_i=B, \\Theta) $$\n$$ P(U_i, S_i | \\Theta) = \\pi P(U_i, S_i | Z_i=A, \\Theta) + (1-\\pi) P(U_i, S_i | Z_i=B, \\Theta) $$\n由于细胞是独立的，观测数据 $D$ 的总似然是各个似然的乘积：\n$$ \\mathcal{L}(\\Theta | D) = \\prod_{i=1}^N P(U_i, S_i | \\Theta) $$\n我们旨在最大化的观测数据对数似然是：\n$$ \\log \\mathcal{L}(\\Theta | D) = \\sum_{i=1}^N \\log \\left[ \\pi P(U_i, S_i | A) + (1-\\pi) P(U_i, S_i | B) \\right] $$\n由于对数内含有和，直接最大化此表达式很困难。期望最大化 (EM) 算法非常适合解决此问题。\n\n### 期望最大化 (EM) 算法推导\nEM 算法通过在期望 (E) 步骤和最大化 (M) 步骤之间交替迭代，来寻找最大似然估计。它使用包含潜变量 $Z = \\{Z_i\\}_{i=1}^N$ 的完全数据对数似然。\n\n我们定义一个二元指示变量 $z_{ik}$，如果细胞 $i$ 处于状态 $k \\in \\{A, B\\}$，则 $z_{ik}=1$，否则 $z_{ik}=0$。完全数据对数似然为：\n$$ \\mathcal{L}_c(\\Theta | D, Z) = \\sum_{i=1}^N \\sum_{k \\in \\{A,B\\}} z_{ik} \\log \\left[ P(Z_i=k) P(U_i, S_i | Z_i=k, \\Theta) \\right] $$\n$$ \\mathcal{L}_c(\\Theta | D, Z) = \\sum_{i=1}^N \\left[ z_{iA} (\\log \\pi + \\log P(U_i, S_i | A)) + z_{iB} (\\log(1-\\pi) + \\log P(U_i, S_i | B)) \\right] $$\n对数概率项 $\\log P(U_i, S_i | k)$ 可以展开为：\n$$ \\log P(U_i, S_i | k) = \\log\\text{Poisson}(U_i; \\ell_i \\alpha_k/\\beta) + \\log\\text{Poisson}(S_i; \\ell_i \\alpha_k/\\gamma) $$\n$$ = \\left( U_i \\log(\\ell_i \\alpha_k/\\beta) - \\ell_i \\alpha_k/\\beta \\right) + \\left( S_i \\log(\\ell_i \\alpha_k/\\gamma) - \\ell_i \\alpha_k/\\gamma \\right) - \\log(U_i!) - \\log(S_i!) $$\n按参数对各项进行分组：\n$$ \\log P(U_i, S_i | k) = (U_i+S_i)\\log(\\alpha_k) - \\alpha_k \\ell_i \\left( \\frac{1}{\\beta} + \\frac{1}{\\gamma} \\right) + C_i $$\n其中 $C_i$ 包含与参数 $\\alpha_k$ 和 $\\pi$ 无关的项。\n\n**1. E 步（期望）**\n在 E 步中，我们计算完全数据对数似然关于潜变量 $Z$ 的后验分布的期望，该后验分布是在给定观测数据 $D$ 和当前参数估计 $\\Theta^{(t)}$ 的条件下的：\n$$ Q(\\Theta | \\Theta^{(t)}) = E_{Z|D, \\Theta^{(t)}}[\\mathcal{L}_c(\\Theta | D, Z)] $$\n这通过将潜在指示符 $z_{ik}$ 替换为其后验概率（称为责任或响应度）$\\gamma_{ik}$ 来实现：\n$$ \\gamma_{ik}^{(t)} = E[z_{ik} | D, \\Theta^{(t)}] = P(Z_i=k | U_i, S_i, \\Theta^{(t)}) $$\n使用贝叶斯定理：\n$$ \\gamma_{iA}^{(t)} = \\frac{\\pi^{(t)} P(U_i, S_i | A, \\Theta^{(t)})}{\\pi^{(t)} P(U_i, S_i | A, \\Theta^{(t)}) + (1-\\pi^{(t)}) P(U_i, S_i | B, \\Theta^{(t)})} $$\n并且 $\\gamma_{iB}^{(t)} = 1 - \\gamma_{iA}^{(t)}$。为了数值稳定性，这些是在对数域中使用 log-sum-exp 技巧计算的。设 $\\log p_{ik} = \\log P(U_i, S_i | k, \\Theta^{(t)})$。\n$$ \\log \\gamma_{ik}^{(t)} = \\log \\pi_k^{(t)} + \\log p_{ik} - \\log\\left( \\sum_{j \\in \\{A,B\\}} \\pi_j^{(t)} P(U_i, S_i | j, \\Theta^{(t)}) \\right) $$\n\n**2. M 步（最大化）**\n在 M 步中，我们寻找使 $Q$ 函数最大化的参数 $\\Theta^{(t+1)}$：\n$$ \\Theta^{(t+1)} = \\arg\\max_{\\Theta} Q(\\Theta | \\Theta^{(t)}) $$\n待最大化的 $Q$ 函数为：\n$$ Q(\\Theta | \\Theta^{(t)}) = \\sum_{i=1}^N \\sum_{k \\in \\{A,B\\}} \\gamma_{ik}^{(t)} \\left[ \\log \\pi_k + (U_i+S_i)\\log\\alpha_k - \\alpha_k \\ell_i(\\frac{1}{\\beta}+\\frac{1}{\\gamma}) \\right] + \\text{const.} $$\n我们分别对 $\\pi$、$\\alpha_A$ 和 $\\alpha_B$ 进行最大化。\n\n**$\\pi$ 的更新**：在约束 $\\pi \\in (0,1)$ 下最大化 $\\sum_i [\\gamma_{iA}^{(t)} \\log \\pi + \\gamma_{iB}^{(t)} \\log(1-\\pi)]$，得到标准的混合比例更新公式：\n$$ \\pi^{(t+1)} = \\frac{\\sum_i \\gamma_{iA}^{(t)}}{N} $$\n\n**$\\alpha_k$ 的更新**：我们最大化涉及 $\\alpha_k$ 的项。对于 $\\alpha_A$：\n$$ \\frac{\\partial Q}{\\partial \\alpha_A} = \\sum_{i=1}^N \\gamma_{iA}^{(t)} \\left[ \\frac{U_i+S_i}{\\alpha_A} - \\ell_i\\left(\\frac{1}{\\beta}+\\frac{1}{\\gamma}\\right) \\right] = 0 $$\n求解 $\\alpha_A$ 得到更新规则：\n$$ \\alpha_A^{(t+1)} = \\frac{\\sum_{i=1}^N \\gamma_{iA}^{(t)}(U_i+S_i)}{(\\frac{1}{\\beta}+\\frac{1}{\\gamma})\\sum_{i=1}^N \\gamma_{iA}^{(t)}\\ell_i} $$\n$\\alpha_B$ 的更新是类似的：\n$$ \\alpha_B^{(t+1)} = \\frac{\\sum_{i=1}^N \\gamma_{iB}^{(t)}(U_i+S_i)}{(\\frac{1}{\\beta}+\\frac{1}{\\gamma})\\sum_{i=1}^N \\gamma_{iB}^{(t)}\\ell_i} $$\n\n### 算法实现\n算法流程如下：\n1. 初始化参数 $\\Theta^{(0)} = (\\alpha_A^{(0)}, \\alpha_B^{(0)}, \\pi^{(0)})$。\n2. 对 $t = 0, 1, 2, \\ldots, T_{\\max}-1$ 进行迭代：\n   a. 计算观测数据对数似然 $\\mathcal{L}(\\Theta^{(t)}|D)$ 以监控收敛情况。\n   b. 检查收敛性：如果对数似然的相对增量 $( \\mathcal{L}^{(t)} - \\mathcal{L}^{(t-1)} ) / |\\mathcal{L}^{(t-1)}|$ 低于容差 $\\varepsilon=10^{-9}$，则终止。\n   c. **E 步**：使用当前参数 $\\Theta^{(t)}$ 为所有细胞 $i=1,\\ldots,N$ 计算责任 $\\gamma_{iA}^{(t)}$ 和 $\\gamma_{iB}^{(t)}$。为防止下溢，此步骤在对数空间中完成。\n   d. **M 步**：使用推导出的更新规则和 E 步得到的责任，将参数更新为 $\\Theta^{(t+1)} = (\\alpha_A^{(t+1)}, \\alpha_B^{(t+1)}, \\pi^{(t+1)})$。\n   e. 成分坍缩的特殊处理：如果某个成分的总责任（例如 $\\sum_i \\gamma_{iA}^{(t)}\\ell_i$）实际上为零，则其对应的 $\\alpha$ 参数将不被更新，因为它变得无定义。\n3. 终止时，报告最终的参数估计和观测数据对数似然的最终值。\n\n下面的 Python 代码实现了该算法。它使用 `numpy` 进行向量化计算，并使用 `scipy.special.gammaln` 计算泊松概率质量函数中的对数阶乘项，这对于计算真实的对数似然是必需的。",
            "answer": "[[2.181818,6.230769,0.500000,-52.540939],[3.090909,8.961538,0.800000,-77.940600],[0.142857,1.882353,0.500000,-13.687440]]"
        }
    ]
}