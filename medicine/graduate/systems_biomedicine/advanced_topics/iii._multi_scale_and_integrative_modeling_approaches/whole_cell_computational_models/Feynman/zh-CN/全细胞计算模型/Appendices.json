{
    "hands_on_practices": [
        {
            "introduction": "任何可靠的计算模型都必须建立在基本物理定律之上，对于全细胞模型而言，质量守恒是最基本的要求之一。这项实践将指导你如何利用原子平衡矩阵，系统地检验代谢网络中的每个反应是否符合元素守恒定律。你将学习如何通过编程自动识别和修正化学计量不一致的问题，这是确保模型准确性的关键第一步。",
            "id": "4399303",
            "problem": "你的任务是设计并实现一种方法，用于检测和校正全细胞模型（WCM）反应中的化学计量不一致性。该方法必须基于质量守恒定律和元素守恒定律，并使用原子平衡矩阵在单个反应的层面上验证元素守恒。你将构建一个算法，对每个反应检查其元素一致性，当存在不一致时，尝试使用一组预定义的通用代谢物进行最小整数校正，以使元素守恒成立。你的程序必须是完全确定性的，并按规定产生数值输出。\n\n假设使用以下在系统生物医学和全细胞计算模型中广泛使用的形式化定义：\n\n- 设有 $m$ 种代谢物和 $r$ 个反应。化学计量矩阵（SM）为 $S \\in \\mathbb{R}^{m \\times r}$，其中每一列 $s_j \\in \\mathbb{R}^{m}$ 编码了反应 $j$ 的化学计量系数，反应物为负，产物为正。\n- 设 $e$ 种元素的集合为 $\\{C,H,O,N,P\\}$，并定义原子平衡矩阵（ABM）$A \\in \\mathbb{Z}^{e \\times m}$，其中条目 $A_{\\alpha i}$ 是代谢物 $i$ 中元素 $\\alpha$ 的数量。\n- 对于反应 $j$，元素残差为 $r_j = A s_j \\in \\mathbb{Z}^{e}$；当且仅当 $r_j = 0$ 时，该反应是元素一致的。\n- 为校正一个不一致的反应，选择一个包含 $k$ 个通用代谢物的固定集合，其索引为 $C = \\{c_1,\\dots,c_k\\}$，并通过从 $A$ 中选择相应的列来构成 $A_C \\in \\mathbb{Z}^{e \\times k}$。寻找一个整数校正向量 $x \\in \\mathbb{Z}^{k}$，使得 $A_C x = - r_j$，并在满足精确相等的前提下最小化 $\\|x\\|_1$。$x_i$ 的符号表示通用代谢物 $c_i$ 是被添加到产物中（$x_i > 0$）还是反应物中（$x_i < 0$）。\n\n你的实现必须遵循基于原则的方法：\n- 从 $S$、$A$ 和 $r_j = A s_j$ 的定义开始。\n- 通过检查 $r_j = 0$ 来检测不一致性。\n- 如果不一致，则通过求解通用代谢物子集上的小型线性系统并检查精确整数可行性，来尝试找到满足 $A_C x = -r_j$ 的 $x \\in \\mathbb{Z}^{k}$。在可行的整数解中，选择最小化 $\\|x\\|_1$ 的解；若存在多个最优解，则通过最小化 $\\|x\\|_2$ 来打破僵局。\n- 如果使用允许的通用代谢物集合不存在精确整数解，则报告该反应为不可校正。\n\n元素和代谢物的原子组成：\n- 元素：$[C,H,O,N,P]$。\n- 代谢物及其原子组成向量 $A_{\\cdot i}$（格式为 $[C,H,O,N,P]$）：\n    - 葡萄糖：$[6,12,6,0,0]$，对应于 $C_6 H_{12} O_6$。\n    - 氧气 ($O_2$)：$[0,0,2,0,0]$，对应于 $O_2$。\n    - 二氧化碳 ($CO_2$)：$[1,0,2,0,0]$，对应于 $CO_2$。\n    - 水 ($H_2O$)：$[0,2,1,0,0]$，对应于 $H_2O$。\n    - 丙酮酸：$[3,3,3,0,0]$，对应于 $C_3 H_3 O_3$。\n    - 乳酸：$[3,5,3,0,0]$，对应于 $C_3 H_5 O_3$。\n    - 氢气 ($H_2$)：$[0,2,0,0,0]$，对应于 $H_2$。\n    - 质子 ($H^+$)：$[0,1,0,0,0]$，对应于 $H$。\n    - 核糖：$[5,10,5,0,0]$，对应于 $C_5 H_{10} O_5$。\n    - 5-磷酸核糖：$[5,10,8,0,1]$，对应于 $C_5 H_{10} O_8 P$。\n    - 氨 ($NH_3$)：$[0,3,0,1,0]$，对应于 $NH_3$。\n\n通用代谢物集合和输出顺序：\n- 使用以下具有固定输出顺序的通用代谢物：$[H_2O, H^+, O_2, CO_2, NH_3, H_2]$。\n- 代谢物列表中的相应索引是固定的，并且程序已知。\n\n反应测试套件：\n- 反应 $1$（已平衡）：葡萄糖 $+ 6\\,O_2 \\rightarrow 6\\,CO_2 + 6\\,H_2O$。编码为化学计量列 $s_1$，其中葡萄糖的条目为 $-1$，$O_2$ 为 $-6$，$CO_2$ 为 $+6$，$H_2O$ 为 $+6$。\n- 反应 $2$（不一致，缺少氢）：丙酮酸 $\\rightarrow$ 乳酸。编码为 $s_2$，其中丙酮酸的条目为 $-1$，乳酸为 $+1$。\n- 反应 $3$（不一致，释放氢）：葡萄糖 $\\rightarrow 6\\,CO_2$。编码为 $s_3$，其中葡萄糖的条目为 $-1$，$CO_2$ 为 $+6$。\n- 反应 $4$（不一致且在给定通用代谢物集合下因磷不平衡而无法校正）：5-磷酸核糖 $\\rightarrow$ 核糖。编码为 $s_4$，其中 5-磷酸核糖的条目为 $-1$，核糖为 $+1$。\n\n你的程序必须：\n- 对每个反应计算 $r_j = A s_j$。\n- 报告反应是否一致（$r_j = 0$）。\n- 通过在指定的通用代谢物集合中找到精确满足 $A_C x = -r_j$ 并最小化 $\\|x\\|_1$ 的 $x$ 来尝试进行整数校正；如果不存在精确整数解，则返回“不可校正”。\n- 计算校正前后的元素级 $\\ell_1$ 残差范数，即 $\\sum_{\\alpha=1}^{e} |(r_j)_\\alpha|$。\n\n最终输出规范：\n- 对于每个反应 $j$，输出一个形式为 $[b, L1_{before}, b_{after}, L1_{after}, x_{H2O}, x_{H^+}, x_{O2}, x_{CO2}, x_{NH3}, x_{H2}]$ 的列表，其中 $b$ 和 $b_{after}$ 分别是表示校正前后一致性的布尔值，$L1_{before}$ 和 $L1_{after}$ 是浮点数，$x_{\\cdot}$ 是对应于上述固定顺序的通用代谢物校正系数的整数。\n- 将所有反应的结果聚合为单行，形式为用方括号括起来的逗号分隔列表。例如，你的程序应打印出类似 $[result\\_1,result\\_2,\\dots]$ 的单行，其中每个 $result\\_j$ 是上述的列表。\n\n本问题不需要角度单位和物理单位。所有输出必须仅为数值类型或数值与布尔类型的列表，如规范所示，不含字符串。程序必须是自包含的，且不得从用户或外部文件读取输入。",
            "solution": "问题陈述已经过严格验证，并被确定为有效。它在科学上基于质量守恒的基本原理，在数学上是适定的，并为推导唯一的、确定性的解提供了完整且一致的数据和指令。在系统生物学和全细胞建模中，使用原子平衡矩阵来检查和校正生化反应中的化学计量不平衡是一种标准而严谨的技术。\n\n解决方案首先将给定的定义和数据形式化为一个清晰的数学和算法框架。然后将此框架应用于测试套件中的每个反应，以确定其元素一致性，并在必要时根据指定的优化标准计算最小校正。\n\n**1. 数学形式化**\n\n问题的核心在于化学反应中元素的守恒。这一原则可以用线性代数方程表示。\n\n设元素集合由 $\\alpha \\in \\{1, \\dots, e\\}$ 索引，其中对于元素 $\\{C,H,O,N,P\\}$，$e=5$。设代谢物集合由 $i \\in \\{1, \\dots, m\\}$ 索引，在本问题中 $m=11$。\n\n**原子平衡矩阵（ABM）**，记为 $A \\in \\mathbb{Z}^{e \\times m}$，是一个矩阵，其中每个条目 $A_{\\alpha i}$ 表示一个代谢物 $i$ 分子中元素 $\\alpha$ 的原子数。根据提供的数据，代谢物列表排序如下：$1$：葡萄糖，$2$：$O_2$，$3$：$CO_2$，$4$：$H_2O$，$5$：丙酮酸，$6$：乳酸，$7$：$H_2$，$8$：$H^+$，$9$：核糖，$10$：5-磷酸核糖，$11$：$NH_3$。由此得到的 $A$ 矩阵为：\n$$\nA = \\begin{pmatrix}\n  6  & 0 & 1 & 0 & 3 & 3 & 0 & 0 & 5 & 5 & 0 \\\\  % C\n  12 & 0 & 0 & 2 & 3 & 5 & 2 & 1 & 10 & 10 & 3 \\\\ % H\n  6  & 2 & 2 & 1 & 3 & 3 & 0 & 0 & 5 & 8 & 0 \\\\  % O\n  0  & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 \\\\  % N\n  0  & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0    % P\n\\end{pmatrix}\n$$\n\n一个生化反应 $j$ 由一个**化学计量向量** $s_j \\in \\mathbb{R}^{m}$ 表示，其中第 $i$ 个条目 $(s_j)_i$ 是反应中代谢物 $i$ 的化学计量系数。按照惯例，反应物的系数为负，产物的系数为正。\n\n**元素守恒定律**要求反应两侧每种元素的总原子数必须相同。这通过计算**元素残差向量** $r_j \\in \\mathbb{Z}^{e}$ 来验证：\n$$\nr_j = A s_j\n$$\n一个反应 $j$ 是元素一致的，或称平衡的，当且仅当其残差向量为零向量，即 $r_j = \\vec{0}$。如果 $r_j \\neq \\vec{0}$，则反应不一致， $r_j$ 的非零条目量化了元素的不平衡。例如，$(r_j)_2 = -2$ 表示产物中缺少2个氢原子。\n\n**2. 不一致反应的校正**\n\n当反应 $j$ 不一致（$r_j \\neq \\vec{0}$）时，我们可以尝试通过添加或移除一组预定义的**通用代谢物**来平衡它。设 $k$ 个通用代谢物的集合由其索引 $C = \\{c_1, \\dots, c_k\\}$ 指定。我们通过从主 ABM $A$ 中选择相应的列来形成一个特定于通用代谢物的 ABM，$A_C \\in \\mathbb{Z}^{e \\times k}$。\n\n对于本问题，通用代谢物及其指定的输出顺序为 $[H_2O, H^+, O_2, CO_2, NH_3, H_2]$。在 $A$ 中对应的列索引为 $[4, 8, 2, 3, 11, 7]$。因此，$k=6$，且 $A_C$ 为：\n$$\nA_C = A_{\\cdot, [4, 8, 2, 3, 11, 7]} = \\begin{pmatrix}\n  0  & 0 & 0 & 1 & 0 & 0 \\\\  % C\n  2  & 1 & 0 & 0 & 3 & 2 \\\\  % H\n  1  & 0 & 2 & 2 & 0 & 0 \\\\  % O\n  0  & 0 & 0 & 0 & 1 & 0 \\\\  % N\n  0  & 0 & 0 & 0 & 0 & 0    % P\n\\end{pmatrix}\n$$\n我们寻求一个整数**校正向量** $x \\in \\mathbb{Z}^k$，其中 $x_i$ 是第 $i$ 个通用代谢物的化学计量系数，使得校正后的反应是平衡的。新的总化学计量为 $s_j^{corr} = s_j + S_C x$，其中 $S_C$ 是一个将校正系数映射到完整的 $m$ 维代谢物空间的矩阵。平衡方程变为 $A s_j^{corr} = \\vec{0}$，展开为 $A s_j + A S_C x = \\vec{0}$。由于 $A S_C x$ 等价于 $A_C x$，我们得到校正的核心方程：\n$$\nA_C x = -r_j\n$$\n问题指定要找到一个整数解 $x$，该解能最小化曼哈顿范数 $\\|x\\|_1 = \\sum_{i=1}^k |x_i|$，若存在多个最优解，则通过最小化欧几里得范数 $\\|x\\|_2 = \\sqrt{\\sum_{i=1}^k x_i^2}$ 来打破僵局。\n\n**3. 算法实现**\n\n对最优整数向量 $x$ 的搜索必须是确定性的和穷尽的。鉴于维度较小（$k=6$），组合搜索是可行的。算法流程如下：\n\n1. 对于一个给定的不一致反应 $j$，计算其初始残差 $r_j = A s_j$ 及其 $\\ell_1$ 范数 $L1_{before} = \\|r_j\\|_1$。校正的目标向量是 $b = -r_j$。\n2. 从 $1$ 到 $k$ 遍历解中非零条目的可能数量 $s$。这对应于搜索使用 $s$ 个通用代谢物的校正方案。\n3. 对于每个大小 $s$，生成 $s$ 个通用代谢物的所有组合。设 $I$ 是 $A_C$ 中列索引的一个大小为 $s$ 的集合。\n4. 对于每个组合 $I$，形成子矩阵 $A_{sub} = (A_C)_{\\cdot, I}$。我们尝试求解系统 $A_{sub} x_{sub} = b$，以得到子向量 $x_{sub} \\in \\mathbb{R}^s$。\n   a. 我们使用最小二乘解算器 `numpy.linalg.lstsq`，它提供一个最小化 $\\|A_{sub} x_{sub} - b\\|_2$ 的解。\n   b. 我们首先通过检查最小二乘解的残差是否为零来验证是否存在精确解，即 $\\|b - A_{sub} x_{sub}\\|_2 \\approx 0$。\n   c. 如果存在精确解，我们接着检查它是否为整数解，方法是验证其所有分量是否都接近整数值，即 $\\|x_{sub} - \\text{round}(x_{sub})\\|_\\infty \\approx 0$。\n5. 如果对于给定的大小 $s$ 找到一个或多个精确整数解，我们就找到了具有最少非零系数的解集。在这些解中，我们选择首先最小化 $\\|x\\|_1$ 范数，然后最小化 $\\|x\\|_2$ 范数的解。因为我们是按 $s$ 迭代并在找到解的第一个 $s$ 处停止，这自然会找到一个稀疏解，这是最小化 $\\|x\\|_1$ 的一个良好启发式方法。\n6. 如果对所有 $s \\in \\{1, \\dots, k\\}$ 完成搜索后仍未找到任何精确整数解，则认为该反应对于给定的通用代谢物集合是“不可校正”的。例如，当一种元素不平衡无法通过通用代谢物的任何线性组合来纠正时（例如，磷元素不平衡，因为没有通用代谢物含有磷），就会发生这种情况。\n\n**4. 测试用例分析**\n\n- **反应 1 (葡萄糖 $+ 6\\,O_2 \\rightarrow 6\\,CO_2 + 6\\,H_2O$)：**计算 $r_1 = A s_1$ 得到零向量。该反应已经是一致的。$L1_{before} = 0$。不需要校正，因此 $x = \\vec{0}$，且 $L1_{after} = 0$。\n\n- **反应 2 (丙酮酸 $\\rightarrow$ 乳酸):**\n  - $s_2$ 中丙酮酸为 $-1$，乳酸为 $+1$。\n  - $r_2 = A_{\\cdot, 6} - A_{\\cdot, 5} = [3,5,3,0,0]^T - [3,3,3,0,0]^T = [0,2,0,0,0]^T$。该反应的产物比反应物多出2个氢原子。$L1_{before}=2$。\n  - 我们求解 $A_C x = -r_2 = [0,-2,0,0,0]^T$。\n  - 搜索发现使用单个通用代谢物（$s=1$）的两个解：\n    - 使用 $H^+$：$x_{H^+} = -2$。校正向量为 $[0,-2,0,0,0,0]^T$。$\\|x\\|_1 = 2$。\n    - 使用 $H_2$：$x_{H_2} = -1$。校正向量为 $[0,0,0,0,0,-1]^T$。$\\|x\\|_1 = 1$。\n  - 最小化 $\\|x\\|_1$ 后，最优解是使用 $H_2$ 的解。校正为 $x = [0,0,0,0,0,-1]^T$。校正后，$r_2^{after} = \\vec{0}$，因此 $L1_{after}=0$。\n\n- **反应 3 (葡萄糖 $\\rightarrow 6\\,CO_2$):**\n  - $s_3$ 中葡萄糖为 $-1$，$CO_2$ 为 $+6$。\n  - $r_3 = 6 A_{\\cdot, 3} - A_{\\cdot, 1} = 6 [1,0,2,0,0]^T - [6,12,6,0,0]^T = [0,-12,6,0,0]^T$。不平衡：$-12 H, +6 O$。$L1_{before}=18$。\n  - 我们求解 $A_C x = -r_3 = [0,12,-6,0,0]^T$。\n  - 搜索发现对于 $s=1$ 无解。对于 $s=2$，$H_2O$ 和 $O_2$ 的组合产生一个解。\n    - $x_{H_2O} \\begin{pmatrix} 2 \\\\ 1 \\end{pmatrix}_{H,O} + x_{O_2} \\begin{pmatrix} 0 \\\\ 2 \\end{pmatrix}_{H,O} = \\begin{pmatrix} 12 \\\\ -6 \\end{pmatrix}_{H,O} \\implies x_{H_2O}=6, x_{O_2}=-6$。\n    - 校正向量为 $[6,0,-6,0,0,0]^T$。$\\|x\\|_1 = 12$。这被确定为最优解。校正后，$L1_{after}=0$。\n\n- **反应 4 (5-磷酸核糖 $\\rightarrow$ 核糖):**\n  - $s_4$ 中 R5P 为 $-1$，核糖为 $+1$。\n  - $r_4 = A_{\\cdot, 9} - A_{\\cdot, 10} = [5,10,5,0,0]^T - [5,10,8,0,1]^T = [0,0,-3,0,-1]^T$。不平衡：$-3 O, -1 P$。$L1_{before}=4$。\n  - 我们尝试求解 $A_C x = -r_4 = [0,0,3,0,1]^T$。\n  - $A_C$ 的最后一行对应于磷（P），全为零。因此关于 P 的方程为 $0 = 1$，这是一个矛盾。$x$ 无解。\n  - 该反应是不可校正的。最终状态与初始状态相同，$L1_{after}=4$ 且 $x=\\vec{0}$。",
            "answer": "```python\nimport numpy as np\nfrom itertools import combinations\n\ndef solve():\n    \"\"\"\n    验证并校正一组生化反应中的化学计量不一致性。\n    \"\"\"\n    \n    # Define elements and metabolites\n    elements = ['C', 'H', 'O', 'N', 'P']\n    metabolites = [\n        'Glucose', 'O2', 'CO2', 'H2O', 'Pyruvate', 'Lactate',\n        'H2', 'H+', 'Ribose', 'Ribose-5-phosphate', 'NH3'\n    ]\n    met_map = {name: i for i, name in enumerate(metabolites)}\n    num_metabolites = len(metabolites)\n    \n    # Atomic Balance Matrix (ABM), A [e x m]\n    A = np.array([\n        # C   H   O  N  P\n        [6,  12,  6, 0, 0],  # Glucose\n        [0,   0,  2, 0, 0],  # O2\n        [1,   0,  2, 0, 0],  # CO2\n        [0,   2,  1, 0, 0],  # H2O\n        [3,   3,  3, 0, 0],  # Pyruvate\n        [3,   5,  3, 0, 0],  # Lactate\n        [0,   2,  0, 0, 0],  # H2\n        [0,   1,  0, 0, 0],  # H+\n        [5,  10,  5, 0, 0],  # Ribose\n        [5,  10,  8, 0, 1],  # Ribose-5-phosphate\n        [0,   3,  0, 1, 0],  # NH3\n    ]).T\n\n    # Currency metabolites and their ABM, A_C\n    currency_metabolites_ordered = ['H2O', 'H+', 'O2', 'CO2', 'NH3', 'H2']\n    currency_indices = [met_map[name] for name in currency_metabolites_ordered]\n    A_C = A[:, currency_indices]\n    num_currency = len(currency_metabolites_ordered)\n\n    # Reaction test suite\n    test_cases = [\n        # Reaction 1: Glucose + 6 O2 -> 6 CO2 + 6 H2O\n        {met_map['Glucose']: -1, met_map['O2']: -6, met_map['CO2']: 6, met_map['H2O']: 6},\n        # Reaction 2: Pyruvate -> Lactate\n        {met_map['Pyruvate']: -1, met_map['Lactate']: 1},\n        # Reaction 3: Glucose -> 6 CO2\n        {met_map['Glucose']: -1, met_map['CO2']: 6},\n        # Reaction 4: Ribose-5-phosphate -> Ribose\n        {met_map['Ribose-5-phosphate']: -1, met_map['Ribose']: 1},\n    ]\n\n    def find_correction(A_currency, b_target):\n        \"\"\"\n        Finds the integer correction vector x that solves A_currency * x = b_target,\n        minimizing ||x||_1, then ||x||_2.\n        \"\"\"\n        k = A_currency.shape[1]\n        \n        for s in range(1, k + 1):\n            solutions_at_this_size = []\n            for indices_combo in combinations(range(k), s):\n                A_sub = A_currency[:, list(indices_combo)]\n                \n                try:\n                    # Find least-squares solution for the subsystem\n                    x_sub, residuals, rank, s_vals = np.linalg.lstsq(A_sub, b_target, rcond=None)\n                    \n                    # Check if the solution is exact\n                    if np.allclose(b_target, A_sub @ x_sub):\n                        # Check if the solution is integer\n                        if np.allclose(x_sub, np.round(x_sub)):\n                            x_full = np.zeros(k, dtype=int)\n                            x_full[list(indices_combo)] = np.round(x_sub).astype(int)\n                            solutions_at_this_size.append(x_full)\n                except np.linalg.LinAlgError:\n                    continue\n\n            if solutions_at_this_size:\n                # Found solutions with the minimum number of metabolites.\n                # Now select the best one based on L1 then L2 norm.\n                best_sol = min(solutions_at_this_size, \n                               key=lambda v: (np.linalg.norm(v, 1), np.linalg.norm(v, 2)))\n                return best_sol\n\n        return None # No solution found\n\n    results = []\n    for reaction_stoich in test_cases:\n        # Stoichiometric vector, s_j\n        s_j = np.zeros(num_metabolites)\n        for met_idx, coeff in reaction_stoich.items():\n            s_j[met_idx] = coeff\n            \n        # Elemental residual, r_j = A * s_j\n        r_j = A @ s_j\n        \n        # Before correction\n        l1_before = np.linalg.norm(r_j, 1)\n        b_before = np.allclose(r_j, 0)\n        \n        correction_vector = np.zeros(num_currency, dtype=int)\n        \n        if b_before:\n            b_after = True\n            l1_after = 0.0\n        else:\n            # Attempt correction\n            b_target = -r_j\n            found_x = find_correction(A_C, b_target)\n            \n            if found_x is not None:\n                correction_vector = found_x\n                b_after = True\n                l1_after = 0.0\n            else: # Uncorrectable\n                b_after = False\n                l1_after = l1_before\n\n        # Format result list according to specification\n        result_list = [\n            b_before, \n            float(l1_before), \n            b_after, \n            float(l1_after)\n        ] + correction_vector.tolist()\n        results.append(result_list)\n        \n    # Format the final output string as a list of lists.\n    # str(list) produces a string representation '[a, b, ...]'.\n    # Joining these with commas results in the desired '[[...],[...]]' format.\n    output_str = f\"[{','.join(map(str, results))}]\"\n    print(output_str)\n\nsolve()\n```"
        },
        {
            "introduction": "全细胞模型内部的生物过程，如酶促反应和基因表达，其发生速率可能横跨数个数量级。这种巨大的时间尺度差异会导致所谓的“刚性”（stiffness）问题，给常微分方程组的数值求解带来巨大挑战。本练习将探讨如何通过分析系统雅可比矩阵的特征值来诊断刚性，从而为选择合适的数值求解器提供依据，确保动态模拟的稳定性和效率。",
            "id": "4399346",
            "problem": "考虑一个基于质量作用动力学建模的常微分方程（ODE）系统的全细胞代谢子系统。令 $x \\in \\mathbb{R}^n$ 表示物种浓度向量，$S \\in \\mathbb{R}^{n \\times r}$ 为化学计量矩阵，$v(x) \\in \\mathbb{R}^r$ 为反应速率向量。其动力学由质量平衡定律和质量作用动力学给出：\n$$\n\\frac{dx}{dt} = f(x) = S \\, v(x),\n$$\n其中，对于每个反应 $j \\in \\{1, \\dots, r\\}$，\n$$\nv_j(x) = k_j \\prod_{i=1}^{n} x_i^{\\nu_{ij}},\n$$\n其中 $k_j > 0$ 是速率常数，$\\nu_{ij} \\in \\mathbb{N}_0$ 是物种 $i$ 在反应 $j$ 中的化学计量级数（反应物分子数）。定义雅可比矩阵\n$$\nJ(x) = \\frac{\\partial f}{\\partial x}(x) \\in \\mathbb{R}^{n \\times n}.\n$$\n此类 ODE 系统的刚性可以通过检查给定状态 $x$ 下 $J(x)$ 的特征值 $\\{\\lambda_i\\}_{i=1}^n$ 来分析，特别是当特征值的模 $\\{|\\lambda_i|\\}$ 跨越多个数量级时。这种跨度迫使显式方法为保持稳定性而采取非常小的步长，而隐式方法在更大的步长下仍能保持稳定，从而在包含快慢子系统的全细胞模型中提供计算优势。\n\n你的任务是从第一性原理推导如何计算质量作用动力学的雅可比矩阵 $J(x)$，计算其在指定状态下的特征值，然后通过比率来量化刚性\n$$\nR = \\frac{\\max_i |\\lambda_i|}{\\min_{i:\\,|\\lambda_i| > \\varepsilon} |\\lambda_i|},\n$$\n使用容差 $\\varepsilon = 10^{-12}$ 排除接近零的特征值。同时计算数量级跨度\n$$\nM = \\log_{10}(R),\n$$\n如果 $M \\ge 3$，则将系统分类为刚性，否则为非刚性。对于每个测试用例，输出列表 $[R, M, flag]$，其中刚性系统的 $flag$ 为 $1$，非刚性系统的 $flag$ 为 $0$。如果满足 $|\\lambda_i| > \\varepsilon$ 的特征值少于两个，则定义 $R = 1$ 和 $M = 0$，并设置 $flag = 0$。不涉及角度。由于度量指标是无量纲的，输出中无需物理单位。\n\n使用以下四个测试用例组成的测试套件，它们分别涵盖了一般情况、高度刚性情况、具有状态依赖雅可比矩阵的非线性分子数情况以及接近阈值的情况。所有矩阵和向量的条目指定如下。\n\n情况 1（三物种循环，一阶速率，相似时间尺度）：\n$$\nS_1 = \\begin{bmatrix}\n-1  & 0 & 1 \\\\\n1  & -1 & 0 \\\\\n0  & 1 & -1\n\\end{bmatrix},\\quad\n\\nu_1 = \\begin{bmatrix}\n1 & 0 & 0 \\\\\n0 & 1 & 0 \\\\\n0 & 0 & 1\n\\end{bmatrix},\\quad\nk_1 = \\begin{bmatrix} 0.8 \\\\ 1.0 \\\\ 1.2 \\end{bmatrix},\\quad\nx_1 = \\begin{bmatrix} 1.0 \\\\ 1.0 \\\\ 1.0 \\end{bmatrix}.\n$$\n\n情况 2（三物种循环，一阶速率，广泛分离的时间尺度）：\n$$\nS_2 = \\begin{bmatrix}\n-1 & 0 & 1 \\\\\n1 & -1 & 0 \\\\\n0 & 1 & -1\n\\end{bmatrix},\\quad\n\\nu_2 = \\begin{bmatrix}\n1 & 0 & 0 \\\\\n0 & 1 & 0 \\\\\n0 & 0 & 1\n\\end{bmatrix},\\quad\nk_2 = \\begin{bmatrix} 10^{-3} \\\\ 1.0 \\\\ 10^{3} \\end{bmatrix},\\quad\nx_2 = \\begin{bmatrix} 1.0 \\\\ 1.0 \\\\ 1.0 \\end{bmatrix}.\n$$\n\n情况 3（具有二聚化的非线性分子数，状态依赖的雅可比矩阵）：\n$$\nS_3 = \\begin{bmatrix}\n-2 & 0 & 1 \\\\\n1 & -1 & 0 \\\\\n0 & 1 & -1\n\\end{bmatrix},\\quad\n\\nu_3 = \\begin{bmatrix}\n2 & 0 & 0 \\\\\n0 & 1 & 0 \\\\\n0 & 0 & 1\n\\end{bmatrix},\\quad\nk_3 = \\begin{bmatrix} 5.0 \\\\ 0.1 \\\\ 0.01 \\end{bmatrix},\\quad\nx_3 = \\begin{bmatrix} 100.0 \\\\ 1.0 \\\\ 1.0 \\end{bmatrix}.\n$$\n\n情况 4（接近阈值的刚性，一阶速率）：\n$$\nS_4 = \\begin{bmatrix}\n-1 & 0 & 1 \\\\\n1 & -1 & 0 \\\\\n0 & 1 & -1\n\\end{bmatrix},\\quad\n\\nu_4 = \\begin{bmatrix}\n1 & 0 & 0 \\\\\n0 & 1 & 0 \\\\\n0 & 0 & 1\n\\end{bmatrix},\\quad\nk_4 = \\begin{bmatrix} 10^{-2} \\\\ 1.0 \\\\ 10 \\end{bmatrix},\\quad\nx_4 = \\begin{bmatrix} 1.0 \\\\ 1.0 \\\\ 1.0 \\end{bmatrix}.\n$$\n\n实现一个程序，对于每个情况，根据 $S$、$\\nu$、$k$ 和 $x$ 构建 $J(x)$，计算 $J(x)$ 的特征值，计算 $R$、$M$ 和刚性标志，并输出一行包含四个用例结果的列表。该列表由方括号括起，每个用例的结果为列表 $[R, M, flag]$，并以逗号分隔。例如，输出格式必须为\n$$\n\\text{[ [r\\_1,m\\_1,f\\_1], [r\\_2,m\\_2,f\\_2], [r\\_3,m\\_3,f\\_3], [r\\_4,m\\_4,f\\_4] ]}.\n$$\n程序不应从用户读取任何输入，也不应访问任何文件。在计算 $\\min |\\lambda_i|$ 时，使用容差 $\\varepsilon = 10^{-12}$ 排除接近零的特征值。",
            "solution": "用户提供的问题已经过验证，并被确定为一个有效的、适定的科学问题。以下是完整的、附带推理的解决方案。\n\n目标是推导由质量作用动力学控制的代谢子系统的雅可比矩阵 $J(x)$ 的表达式，然后用它来量化几个测试用例的系统刚性。\n\n系统动力学由以下常微分方程（ODE）描述：\n$$\n\\frac{dx}{dt} = f(x) = S \\, v(x)\n$$\n其中 $x \\in \\mathbb{R}^n$ 是物种浓度向量，$S \\in \\mathbb{R}^{n \\times r}$ 是化学计量矩阵，$v(x) \\in \\mathbb{R}^r$ 是反应速率向量。对于一个有 $n$ 个物种和 $r$ 个反应的系统，第 $i$ 个物种浓度 $x_i$ 的动力学由下式给出：\n$$\nf_i(x) = \\frac{dx_i}{dt} = \\sum_{j=1}^{r} S_{ij} v_j(x)\n$$\n此处，$S_{ij}$ 表示物种 $i$ 在反应 $j$ 中的化学计量系数。反应速率 $v_j(x)$ 由质量作用定律定义：\n$$\nv_j(x) = k_j \\prod_{l=1}^{n} x_l^{\\nu_{lj}}\n$$\n其中 $k_j > 0$ 是反应 $j$ 的速率常数，$\\nu_{lj} \\in \\mathbb{N}_0$ 是物种 $l$ 作为反应物在反应 $j$ 中的分子数。\n\n雅可比矩阵 $J(x)$ 是一个 $n \\times n$ 矩阵，其元素 $J_{ik}(x)$ 是第 $i$ 个物种的变化率相对于第 $k$ 个物种浓度的偏导数：\n$$\nJ_{ik}(x) = \\frac{\\partial f_i}{\\partial x_k}(x)\n$$\n代入 $f_i(x)$ 的表达式，我们得到：\n$$\nJ_{ik}(x) = \\frac{\\partial}{\\partial x_k} \\left( \\sum_{j=1}^{r} S_{ij} v_j(x) \\right)\n$$\n由于微分是线性运算，我们可以交换导数和求和的顺序：\n$$\nJ_{ik}(x) = \\sum_{j=1}^{r} S_{ij} \\frac{\\partial v_j(x)}{\\partial x_k}\n$$\n接下来，我们必须计算反应速率 $v_j(x)$ 相对于物种浓度 $x_k$ 的偏导数：\n$$\n\\frac{\\partial v_j(x)}{\\partial x_k} = \\frac{\\partial}{\\partial x_k} \\left( k_j \\prod_{l=1}^{n} x_l^{\\nu_{lj}} \\right)\n$$\n使用微分的乘法法则，仅当 $l=k$ 时，对应的项的导数非零：\n$$\n\\frac{\\partial v_j(x)}{\\partial x_k} = k_j \\left( \\prod_{l \\neq k} x_l^{\\nu_{lj}} \\right) \\frac{\\partial}{\\partial x_k} (x_k^{\\nu_{kj}}) = k_j \\left( \\prod_{l \\neq k} x_l^{\\nu_{lj}} \\right) (\\nu_{kj} x_k^{\\nu_{kj}-1})\n$$\n如果 $\\nu_{kj} = 0$，则导数为 $0$。如果 $\\nu_{kj} > 0$ 且 $x_k > 0$，我们可以通过乘以和除以 $x_k$ 来重新整理这个表达式：\n$$\n\\frac{\\partial v_j(x)}{\\partial x_k} = \\nu_{kj} \\frac{1}{x_k} \\left( k_j \\left( \\prod_{l \\neq k} x_l^{\\nu_{lj}} \\right) x_k^{\\nu_{kj}} \\right) = \\frac{\\nu_{kj}}{x_k} \\left( k_j \\prod_{l=1}^{n} x_l^{\\nu_{lj}} \\right)\n$$\n这可以简化为一个紧凑而优美的形式：\n$$\n\\frac{\\partial v_j(x)}{\\partial x_k} = \\frac{\\nu_{kj} v_j(x)}{x_k}\n$$\n对于所提供的测试用例，此形式是有效的，因为所有指定的浓度 $x_k$ 都严格为正。\n\n将此结果代回雅可比矩阵元素 $J_{ik}(x)$ 的表达式中：\n$$\nJ_{ik}(x) = \\sum_{j=1}^{r} S_{ij} \\frac{\\nu_{kj} v_j(x)}{x_k}\n$$\n这个表达式可以用矩阵表示法来表示。我们定义一个矩阵 $N(x) \\in \\mathbb{R}^{r \\times n}$，其元素为 $N_{jk}(x) = \\frac{\\partial v_j(x)}{\\partial x_k} = \\frac{\\nu_{kj} v_j(x)}{x_k}$。那么雅可比矩阵 $J(x)$ 就是化学计量矩阵 $S$ 和矩阵 $N(x)$ 的乘积：\n$$\nJ(x) = S \\cdot N(x)\n$$\n每个测试用例的计算步骤如下：\n1.  给定参数 $S \\in \\mathbb{R}^{n \\times r}$、$\\nu \\in \\mathbb{R}^{n \\times r}$、$k \\in \\mathbb{R}^{r}$ 和 $x \\in \\mathbb{R}^{n}$。\n2.  计算反应速率向量 $v(x) \\in \\mathbb{R}^r$，其中每个元素 $v_j(x)$ 按 $v_j(x) = k_j \\prod_{i=1}^{n} x_i^{\\nu_{ij}}$ 计算。\n3.  构建矩阵 $N(x) \\in \\mathbb{R}^{r \\times n}$，其元素为 $N_{jk}(x) = (\\nu_{kj}/x_k) v_j(x)$。\n4.  通过矩阵乘积 $J(x) = S N(x)$ 计算雅可比矩阵 $J(x) \\in \\mathbb{R}^{n \\times n}$。\n5.  计算 $J(x)$ 的特征值 $\\{\\lambda_i\\}_{i=1}^n$。\n6.  计算特征值模的集合 $\\{|\\lambda_i|\\}$。\n7.  筛选此集合，只保留大于容差 $\\varepsilon = 10^{-12}$ 的模。令此筛选后的模集合为 $\\Lambda_{filtered}$。\n8.  如果 $\\Lambda_{filtered}$ 中的元素数量少于两个，则设置刚性比 $R=1.0$，对数跨度 $M=0.0$，刚性标志为 $0$。\n9.  否则，计算 $R = \\frac{\\max_i |\\lambda_i|}{\\min(|\\Lambda_{filtered}|)}$。\n10. 计算数量级跨度 $M = \\log_{10}(R)$。\n11. 确定刚性标志：如果 $M \\ge 3$ 则为 $1$，否则为 $0$。\n12. 该用例的最终结果是列表 $[R, M, \\text{flag}]$。\n\n将此程序应用于所提供的四个测试用例中的每一个。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem of calculating stiffness metrics for several\n    biochemical reaction networks modeled by ODEs.\n    \"\"\"\n    epsilon = 1e-12\n    stiffness_threshold = 3.0\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (three-species cycle, first-order rates, similar timescales)\n        (\n            np.array([[-1, 0, 1], [1, -1, 0], [0, 1, -1]]),  # S1\n            np.array([[1, 0, 0], [0, 1, 0], [0, 0, 1]]),      # nu1\n            np.array([0.8, 1.0, 1.2]),                       # k1\n            np.array([1.0, 1.0, 1.0])                        # x1\n        ),\n        # Case 2 (three-species cycle, first-order rates, widely separated timescales)\n        (\n            np.array([[-1, 0, 1], [1, -1, 0], [0, 1, -1]]),  # S2\n            np.array([[1, 0, 0], [0, 1, 0], [0, 0, 1]]),      # nu2\n            np.array([1e-3, 1.0, 1e3]),                      # k2\n            np.array([1.0, 1.0, 1.0])                        # x2\n        ),\n        # Case 3 (nonlinear molecularity with dimerization, state-dependent Jacobian)\n        (\n            np.array([[-2, 0, 1], [1, -1, 0], [0, 1, -1]]),  # S3\n            np.array([[2, 0, 0], [0, 1, 0], [0, 0, 1]]),      # nu3\n            np.array([5.0, 0.1, 0.01]),                      # k3\n            np.array([100.0, 1.0, 1.0])                      # x3\n        ),\n        # Case 4 (near-threshold stiffness, first-order rates)\n        (\n            np.array([[-1, 0, 1], [1, -1, 0], [0, 1, -1]]),  # S4\n            np.array([[1, 0, 0], [0, 1, 0], [0, 0, 1]]),      # nu4\n            np.array([1e-2, 1.0, 10.0]),                     # k4\n            np.array([1.0, 1.0, 1.0])                        # x4\n        )\n    ]\n\n    results = []\n    for S, nu, k, x in test_cases:\n        n = S.shape[0]  # Number of species\n        r = S.shape[1]  # Number of reactions\n\n        # Step 1: Compute the reaction rate vector v(x)\n        v = np.zeros(r)\n        for j in range(r):\n            # v_j = k_j * product(x_i ^ nu_ij for i=1..n)\n            v[j] = k[j] * np.prod(x ** nu[:, j])\n\n        # Step 2: Compute the matrix N(x) of partial derivatives of rates\n        # N_jk = (nu_kj / x_k) * v_j\n        N = np.zeros((r, n))\n        for j in range(r):\n            for k_idx in range(n):\n                if x[k_idx] > 0:  # Avoid division by zero\n                    N[j, k_idx] = (nu[k_idx, j] / x[k_idx]) * v[j]\n                # If x_k is zero, derivative is zero unless nu_kj=1, which is not handled here\n                # but not needed for the given test cases.\n\n        # Step 3: Compute the Jacobian matrix J(x) = S @ N(x)\n        J = S @ N\n\n        # Step 4: Compute the eigenvalues of J(x)\n        eigenvalues = np.linalg.eigvals(J)\n\n        # Step 5: Compute eigenvalue magnitudes and filter\n        abs_eigenvalues = np.abs(eigenvalues)\n        filtered_eigenvalues = abs_eigenvalues[abs_eigenvalues > epsilon]\n        \n        R, M, flag = 0.0, 0.0, 0\n        \n        # Step 6: Handle special case and compute stiffness metrics\n        if filtered_eigenvalues.size < 2:\n            R = 1.0\n            M = 0.0\n            flag = 0\n        else:\n            max_lambda = np.max(abs_eigenvalues)\n            min_lambda_filtered = np.min(filtered_eigenvalues)\n            \n            if min_lambda_filtered > 0:\n                R = max_lambda / min_lambda_filtered\n                M = np.log10(R)\n                flag = 1 if M >= stiffness_threshold else 0\n            else: # Should not happen due to filtering\n                R = 1.0\n                M = 0.0\n                flag = 0\n\n        results.append([R, M, flag])\n\n    # Final print statement in the exact required format.\n    # The default str() for a list includes spaces, e.g., '[1.0, 2.0, 3]',\n    # which matches the format example '[r_1, m_1, f_1]'.\n    # The join operation creates a string 'list1_str,list2_str,...'\n    # and the f-string wraps it in the outer brackets.\n    output_str = f\"[{','.join(map(str, results))}]\"\n    print(output_str)\n\nsolve()\n```"
        },
        {
            "introduction": "一个化学计量平衡的模型仍可能预测出生物学上不可能的代谢行为，例如违反热力学定律的反应方向。这项实践将展示如何将吉布斯自由能计算整合到通量平衡分析（FBA）中，从而对反应方向性施加严格的热力学约束。通过这种方式，我们可以获得对细胞代谢能力更符合生理现实的预测。",
            "id": "4399339",
            "problem": "您正在一个全细胞计算模型中，对一个稳态条件下的最小化学计量子网络进行建模。该网络包含三种细胞内代谢物 $A$、$B$ 和 $C$，以及五个反应：一个从外部输入 $A$ 的摄取反应 $R_{\\mathrm{in}}$，两个内部转化反应 $R_{AB}$ 和 $R_{BC}$，一个消耗 $C$ 的生物质汇 $R_{\\mathrm{bio}}$，以及一个将 $C$ 输出到外部的外排反应 $R_{\\mathrm{out}}$。细胞内代谢物的稳态质量平衡由化学计量矩阵 $S \\in \\mathbb{R}^{3 \\times 5}$ 强制执行，其行序为 $(A,B,C)$，列序为 $(R_{\\mathrm{in}}, R_{AB}, R_{BC}, R_{\\mathrm{bio}}, R_{\\mathrm{out}})$：\n$$\nS = \\begin{bmatrix}\n+1 & -1 & 0 & 0 & 0 \\\\\n0 & +1 & -1 & 0 & 0 \\\\\n0 & 0 & +1 & -1 & -1\n\\end{bmatrix}.\n$$\n通量向量为 $v \\in \\mathbb{R}^{5}$，其条目为 $(v_{\\mathrm{in}}, v_{AB}, v_{BC}, v_{\\mathrm{bio}}, v_{\\mathrm{out}})$。稳态要求 $S v = 0$。通量单位为 $\\mathrm{mmol}\\,\\mathrm{gDW}^{-1}\\,\\mathrm{h}^{-1}$；请以该单位报告所有通量。\n\n每个内部反应 $i$ 的热力学可行性受到 Gibbs 自由能变化的约束：\n$$\n\\Delta G_i = \\Delta G_i^\\circ + R T \\ln Q_i,\n$$\n其中 $\\Delta G_i^\\circ$ 是标准 Gibbs 自由能变化，单位为 $\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$；$R$ 是通用气体常数，单位为 $\\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}$；$T$ 是绝对温度，单位为 $\\mathrm{K}$；$Q_i$ 是反应商。活度由浓度（单位为 $\\mathrm{M}$）相对于 $1\\,\\mathrm{M}$ 的标准态来近似，因此 $Q_i$ 是无量纲的。对于一个化学计量系数为 $\\nu_j$（产物为正，反应物为负）的反应，使用细胞内物质的细胞内浓度 $[X_j]$，其反应商 $Q_i = \\prod_j [X_j]^{\\nu_j}$。只有内部的、化学平衡的反应才受热力学约束；在此网络中，仅对 $R_{AB}$ 和 $R_{BC}$ 应用 $\\Delta G_i$ 约束。方向性要求如下：\n- 若 $\\Delta G_i \\le -\\varepsilon$，则只允许正向通量，即 $v_i \\ge 0$。\n- 若 $\\Delta G_i \\ge +\\varepsilon$，则只允许逆向通量，即 $v_i \\le 0$。\n- 若 $|\\Delta G_i| < \\varepsilon$，则该反应是热力学可逆的，即 $v_i$ 在给定的数值界限内可正可负。\n\n假设以下常数和界限在所有测试用例中都是固定的：\n- 气体常数 $R = 0.008314\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}$。\n- 温度 $T = 310\\,\\mathrm{K}$。\n- 容差 $\\varepsilon = 10^{-3}\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$。\n- 标准 Gibbs 能量：$\\Delta G^\\circ_{AB} = -5\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$ 和 $\\Delta G^\\circ_{BC} = +2\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$。\n- 通量界限 (单位为 $\\mathrm{mmol}\\,\\mathrm{gDW}^{-1}\\,\\mathrm{h}^{-1}$): $0 \\le v_{\\mathrm{in}} \\le 5$, $-10 \\le v_{AB} \\le 10$, $-10 \\le v_{BC} \\le 10$, $0 \\le v_{\\mathrm{bio}} \\le 10$, $0 \\le v_{\\mathrm{out}} \\le 10$。\n- $R_{AB}$ 和 $R_{BC}$ 的反应商分别计算为 $Q_{AB} = \\dfrac{[B]}{[A]}$ 和 $Q_{BC} = \\dfrac{[C]}{[B]}$，使用单位为 $\\mathrm{M}$ 的细胞内浓度。\n\n您的任务是：\n1. 根据给定的 $\\Delta G^\\circ_i$、$R$、$T$ 和细胞内浓度，使用自然对数计算 $\\Delta G_{AB}$ 和 $\\Delta G_{BC}$。\n2. 将 $\\Delta G_{AB}$ 和 $\\Delta G_{BC}$ 的符号（考虑容差 $\\varepsilon$）转化为对 $v_{AB}$ 和 $v_{BC}$ 的方向性约束，如上所述，通过相应地收紧它们的界限。\n3. 构建并求解一个线性规划问题，以在稳态条件 $S v = 0$、上述界限以及热力学施加于 $v_{AB}$ 和 $v_{BC}$ 的方向性约束下，最大化 $v_{\\mathrm{bio}}$。这对应于最小化 $-v_{\\mathrm{bio}}$。\n4. 对每个测试用例，返回三个结果：最大化的生物质通量 $v_{\\mathrm{bio}}$（一个浮点数），以及两个编码 $R_{AB}$ 和 $R_{BC}$ 方向性的整数，其中 $+1$ 表示仅正向，$-1$ 表示仅逆向， $0$ 表示可逆。\n\n物理单位要求：\n- 以 $\\mathrm{mmol}\\,\\mathrm{gDW}^{-1}\\,\\mathrm{h}^{-1}$ 为单位报告 $v_{\\mathrm{bio}}$，四舍五入到六位小数。\n\n测试套件（每个用例提供细胞内浓度，单位为 $\\mathrm{M}$；使用上述 $R$ 和 $T$）：\n- 用例 1（两个内部步骤均为正向放能）：$[A] = 10^{-3}$, $[B] = 10^{-4}$, $[C] = 10^{-6}$。\n- 用例 2（$R_{AB}$ 正向吸能，$R_{BC}$ 正向放能）：$[A] = 10^{-6}$, $[B] = 10^{-3}$, $[C] = 10^{-6}$。\n- 用例 3（$R_{BC}$ 接近平衡）：$[A] = 10^{-3}$, $[B] = 10^{-4}$，以及 $[C] = [B] \\cdot \\exp\\!\\left(-\\dfrac{\\Delta G^\\circ_{BC}}{R T}\\right)$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个扁平的、逗号分隔的列表，并用方括号括起来。按顺序连接每个用例的三个结果。对于每个用例，首先放置 $v_{\\mathrm{bio}}$（四舍五入到六位小数），然后是 $R_{AB}$ 和 $R_{BC}$ 的整数代码。例如，一个语法示例是 $[x_1,d_{AB,1},d_{BC,1},x_2,d_{AB,2},d_{BC,2},x_3,d_{AB,3},d_{BC,3}]$，其中 $x_i$ 是具有六位小数的浮点数，而 $d_{(\\cdot),i} \\in \\{-1,0,+1\\}$。",
            "solution": "该问题要求在稳态和热力学约束下，确定一个最小代谢网络中的最大生物质生产速率 $v_{\\mathrm{bio}}$。这是一个约束优化问题，可以被表述并作为线性规划（LP）问题来求解。对于每个给定的测试用例，求解过程包括三个主要步骤：首先，计算内部反应的 Gibbs 自由能变化（$\\Delta G$）；其次，使用这些 $\\Delta G$ 值来设定相应通量的方向性约束；第三，求解得到的线性规划问题以最大化 $v_{\\mathrm{bio}}$。\n\n该代谢网络由 $3$ 种细胞内代谢物（$A, B, C$）和 $5$ 个反应（$R_{\\mathrm{in}}, R_{AB}, R_{BC}, R_{\\mathrm{bio}}, R_{\\mathrm{out}}$）组成。系统动力学由稳态质量平衡方程控制：\n$$S v = 0$$\n其中 $S \\in \\mathbb{R}^{3 \\times 5}$ 是化学计量矩阵，$v \\in \\mathbb{R}^{5}$ 是反应通量向量。\n$$\nS = \\begin{bmatrix}\n+1 & -1 & 0 & 0 & 0 \\\\\n0 & +1 & -1 & 0 & 0 \\\\\n0 & 0 & +1 & -1 & -1\n\\end{bmatrix}, \\quad\nv = \\begin{pmatrix} v_{\\mathrm{in}} \\\\ v_{AB} \\\\ v_{BC} \\\\ v_{\\mathrm{bio}} \\\\ v_{\\mathrm{out}} \\end{pmatrix}\n$$\n这个矩阵方程展开为三个线性等式约束：\n$$(1) \\quad v_{\\mathrm{in}} - v_{AB} = 0$$\n$$(2) \\quad v_{AB} - v_{BC} = 0$$\n$$(3) \\quad v_{BC} - v_{\\mathrm{bio}} - v_{\\mathrm{out}} = 0$$\n从方程 $(1)$ 和 $(2)$，我们推断出 $v_{\\mathrm{in}} = v_{AB} = v_{BC}$。\n\n优化问题是最大化生物质通量 $v_{\\mathrm{bio}}$。这等同于最小化目标函数 $c^T v$，其中 $c = (0, 0, 0, -1, 0)^T$。\n\n通量受到基准界限的约束：\n$$0 \\le v_{\\mathrm{in}} \\le 5$$\n$$-10 \\le v_{AB} \\le 10$$\n$$-10 \\le v_{BC} \\le 10$$\n$$0 \\le v_{\\mathrm{bio}} \\le 10$$\n$$0 \\le v_{\\mathrm{out}} \\le 10$$\n\n热力学约束进一步收紧了内部反应通量 $v_{AB}$ 和 $v_{BC}$ 的界限。反应 $i$ 的 Gibbs 自由能变化计算如下：\n$$\\Delta G_i = \\Delta G_i^\\circ + R T \\ln Q_i$$\n其中 $R = 0.008314\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}$ 且 $T = 310\\,\\mathrm{K}$。因此，$R T \\approx 2.57734\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$。容差为 $\\varepsilon = 10^{-3}\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$。反应商为 $Q_{AB} = [B]/[A]$ 和 $Q_{BC} = [C]/[B]$。\n\n方向性规则如下：\n- 如果 $\\Delta G_i \\le -10^{-3}\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$，通量 $v_i$ 被约束为非负（$v_i \\ge 0$）。方向性代码为 $+1$。\n- 如果 $\\Delta G_i \\ge +10^{-3}\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$，通量 $v_i$ 被约束为非正（$v_i \\le 0$）。方向性代码为 $-1$。\n- 如果 $|\\Delta G_i| < 10^{-3}\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$，通量 $v_i$ 在其原始界限内是可逆的。方向性代码为 $0$。\n\n我们现在对每个测试用例进行求解。\n\n**用例 1：**\n- 浓度：$[A] = 10^{-3}\\,\\mathrm{M}$，$[B] = 10^{-4}\\,\\mathrm{M}$，$[C] = 10^{-6}\\,\\mathrm{M}$。\n- 反应商：\n  $$Q_{AB} = \\frac{[B]}{[A]} = \\frac{10^{-4}}{10^{-3}} = 0.1$$\n  $$Q_{BC} = \\frac{[C]}{[B]} = \\frac{10^{-6}}{10^{-4}} = 0.01$$\n- Gibbs 自由能变化：\n  $$\\Delta G_{AB} = \\Delta G^\\circ_{AB} + RT \\ln Q_{AB} = -5 + (2.57734) \\ln(0.1) \\approx -5 - 5.934 = -10.934\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$$\n  $$\\Delta G_{BC} = \\Delta G^\\circ_{BC} + RT \\ln Q_{BC} = +2 + (2.57734) \\ln(0.01) \\approx +2 - 11.869 = -9.869\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$$\n- 方向性：\n  由于 $\\Delta G_{AB} \\ll -\\varepsilon$，$R_{AB}$ 仅为正向。$v_{AB}$ 的新界限为 $[0, 10]$。方向性代码为 $+1$。\n  由于 $\\Delta G_{BC} \\ll -\\varepsilon$，$R_{BC}$ 仅为正向。$v_{BC}$ 的新界限为 $[0, 10]$。方向性代码为 $+1$。\n- LP 解：\n  约束条件为 $v_{\\mathrm{in}} = v_{AB} = v_{BC}$。\n  界限为 $0 \\le v_{\\mathrm{in}} \\le 5$，$0 \\le v_{AB} \\le 10$，$0 \\le v_{BC} \\le 10$。最紧的上界来自 $v_{\\mathrm{in}}$，所以 $v_{\\mathrm{in}} = v_{AB} = v_{BC} \\le 5$。\n  从 $v_{BC} = v_{\\mathrm{bio}} + v_{\\mathrm{out}}$，为了最大化 $v_{\\mathrm{bio}}$，我们必须最小化 $v_{\\mathrm{out}}$。最小值为 $v_{\\mathrm{out}} = 0$。\n  这得到 $v_{\\mathrm{bio}} = v_{BC}$。$v_{BC}$ 的最大可能值为 $5\\,\\mathrm{mmol}\\,\\mathrm{gDW}^{-1}\\,\\mathrm{h}^{-1}$。\n  因此，最大生物质通量为 $v_{\\mathrm{bio}} = 5.0$。\n- 用例 1 的结果：($v_{\\mathrm{bio}} = 5.0$, $d_{AB} = +1$, $d_{BC} = +1$)\n\n**用例 2：**\n- 浓度：$[A] = 10^{-6}\\,\\mathrm{M}$，$[B] = 10^{-3}\\,\\mathrm{M}$，$[C] = 10^{-6}\\,\\mathrm{M}$。\n- 反应商：\n  $$Q_{AB} = \\frac{[B]}{[A]} = \\frac{10^{-3}}{10^{-6}} = 1000$$\n  $$Q_{BC} = \\frac{[C]}{[B]} = \\frac{10^{-6}}{10^{-3}} = 0.001$$\n- Gibbs 自由能变化：\n  $$\\Delta G_{AB} = -5 + (2.57734) \\ln(1000) \\approx -5 + 17.804 = +12.804\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$$\n  $$\\Delta G_{BC} = +2 + (2.57734) \\ln(0.001) \\approx +2 - 17.804 = -15.804\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$$\n- 方向性：\n  由于 $\\Delta G_{AB} \\gg +\\varepsilon$，$R_{AB}$ 仅为逆向。$v_{AB}$ 的新界限为 $[-10, 0]$。方向性代码为 $-1$。\n  由于 $\\Delta G_{BC} \\ll -\\varepsilon$，$R_{BC}$ 仅为正向。$v_{BC}$ 的新界限为 $[0, 10]$。方向性代码为 $+1$。\n- LP 解：\n  约束条件为 $v_{\\mathrm{in}} = v_{AB} = v_{BC}$。\n  界限要求 $v_{\\mathrm{in}} \\ge 0$，$v_{AB} \\le 0$，以及 $v_{BC} \\ge 0$。\n  同时满足 $v \\ge 0$ 和 $v \\le 0$ 的唯一值是 $v=0$。\n  因此，$v_{\\mathrm{in}} = v_{AB} = v_{BC} = 0$。\n  从 $v_{BC} - v_{\\mathrm{bio}} - v_{\\mathrm{out}} = 0$，我们得到 $0 - v_{\\mathrm{bio}} - v_{\\mathrm{out}} = 0$。因为 $v_{\\mathrm{bio}} \\ge 0$ 且 $v_{\\mathrm{out}} \\ge 0$，唯一的解是 $v_{\\mathrm{bio}} = 0$ 和 $v_{\\mathrm{out}} = 0$。\n  最大生物质通量为 $v_{\\mathrm{bio}} = 0.0$。\n- 用例 2 的结果：($v_{\\mathrm{bio}} = 0.0$, $d_{AB} = -1$, $d_{BC} = +1$)\n\n**用例 3：**\n- 浓度：$[A] = 10^{-3}\\,\\mathrm{M}$，$[B] = 10^{-4}\\,\\mathrm{M}$，以及 $[C] = [B] \\cdot \\exp\\!\\left(-\\frac{\\Delta G^\\circ_{BC}}{R T}\\right)$。\n- 反应商：\n  $Q_{AB} = \\frac{[B]}{[A]} = \\frac{10^{-4}}{10^{-3}} = 0.1$。\n  $Q_{BC} = \\frac{[C]}{[B]} = \\exp\\!\\left(-\\frac{\\Delta G^\\circ_{BC}}{R T}\\right)$。\n- Gibbs 自由能变化：\n  $\\Delta G_{AB}$ 与用例 1 中相同：$\\Delta G_{AB} \\approx -10.934\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$。\n  对于 $R_{BC}$：\n  $$\\Delta G_{BC} = \\Delta G^\\circ_{BC} + RT \\ln(Q_{BC}) = \\Delta G^\\circ_{BC} + RT \\ln\\left(\\exp\\left(-\\frac{\\Delta G^\\circ_{BC}}{R T}\\right)\\right)$$\n  $$\\Delta G_{BC} = \\Delta G^\\circ_{BC} + RT \\left(-\\frac{\\Delta G^\\circ_{BC}}{R T}\\right) = \\Delta G^\\circ_{BC} - \\Delta G^\\circ_{BC} = 0\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$$\n- 方向性：\n  由于 $\\Delta G_{AB} \\ll -\\varepsilon$，$R_{AB}$ 仅为正向。$v_{AB}$ 的新界限为 $[0, 10]$。方向性代码为 $+1$。\n  由于 $|\\Delta G_{BC}| = 0 < \\varepsilon$，$R_{BC}$ 是可逆的。$v_{BC}$ 的界限保持为 $[-10, 10]$。方向性代码为 $0$。\n- LP 解：\n  约束条件为 $v_{\\mathrm{in}} = v_{AB} = v_{BC}$。\n  界限为 $0 \\le v_{\\mathrm{in}} \\le 5$，$0 \\le v_{AB} \\le 10$，$-10 \\le v_{BC} \\le 10$。\n  同样，限制性通量是 $v_{\\mathrm{in}}$，所以 $v_{\\mathrm{in}} = v_{AB} = v_{BC} \\le 5$。由于 $v_{in} \\ge 0$，我们有 $0 \\le v_{BC} \\le 5$。\n  为了从 $v_{BC} = v_{\\mathrm{bio}} + v_{\\mathrm{out}}$ 中最大化 $v_{\\mathrm{bio}}$，我们设置 $v_{\\mathrm{out}} = 0$。\n  这得到 $v_{\\mathrm{bio}} = v_{BC}$。最大值为 $5\\,\\mathrm{mmol}\\,\\mathrm{gDW}^{-1}\\,\\mathrm{h}^{-1}$。\n  最大生物质通量为 $v_{\\mathrm{bio}} = 5.0$。\n- 用例 3 的结果：($v_{\\mathrm{bio}} = 5.0$, $d_{AB} = +1$, $d_{BC} = 0$)\n\n最终输出是这些结果的串联。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import linprog\n\ndef solve():\n    \"\"\"\n    Solves a series of flux balance analysis problems with thermodynamic constraints.\n    \"\"\"\n    # Define constants and fixed parameters\n    R = 0.008314  # Gas constant in kJ mol^-1 K^-1\n    T = 310.0      # Temperature in K\n    EPSILON = 1e-3 # Tolerance for Gibbs free energy in kJ mol^-1\n    \n    # Standard Gibbs free energy changes in kJ mol^-1\n    DG_CIRC_AB = -5.0\n    DG_CIRC_BC = 2.0\n    \n    # Stoichiometric matrix S\n    # Rows: A, B, C\n    # Cols: R_in, R_AB, R_BC, R_bio, R_out\n    S = np.array([\n        [1, -1, 0, 0, 0],\n        [0, 1, -1, 0, 0],\n        [0, 0, 1, -1, -1]\n    ])\n    \n    # Base flux bounds (in mmol gDW^-1 h^-1)\n    # v_in, v_AB, v_BC, v_bio, v_out\n    base_bounds = [\n        (0, 5.0),\n        (-10.0, 10.0),\n        (-10.0, 10.0),\n        (0, 10.0),\n        (0, 10.0)\n    ]\n    \n    # Objective function: Maximize v_bio, which is to minimize -v_bio\n    c = np.array([0, 0, 0, -1, 0])\n    \n    # Equality constraints: Sv = 0\n    A_eq = S\n    b_eq = np.zeros(S.shape[0])\n\n    # Test cases: intracellular concentrations [A], [B], [C] in M\n    # Case 3 [C] is calculated programmatically.\n    test_cases = [\n        # Case 1\n        {'A': 1e-3, 'B': 1e-4, 'C': 1e-6},\n        # Case 2\n        {'A': 1e-6, 'B': 1e-3, 'C': 1e-6},\n        # Case 3\n        {'A': 1e-3, 'B': 1e-4, 'C': (1e-4 * np.exp(-DG_CIRC_BC / (R * T)))},\n    ]\n\n    final_results = []\n\n    for case_concs in test_cases:\n        conc_A = case_concs['A']\n        conc_B = case_concs['B']\n        conc_C = case_concs['C']\n        \n        # 1. Compute Delta G for internal reactions\n        RT = R * T\n        \n        # Reaction R_AB: A -> B\n        Q_AB = conc_B / conc_A\n        delta_G_AB = DG_CIRC_AB + RT * np.log(Q_AB)\n        \n        # Reaction R_BC: B -> C\n        Q_BC = conc_C / conc_B\n        delta_G_BC = DG_CIRC_BC + RT * np.log(Q_BC)\n\n        # 2. Determine directionality and update flux bounds\n        bounds = list(base_bounds) # Create a mutable copy\n        \n        # Directionality for R_AB (index 1)\n        dir_AB = 0\n        if delta_G_AB <= -EPSILON:\n            bounds[1] = (0, bounds[1][1]) # Forward only\n            dir_AB = 1\n        elif delta_G_AB >= EPSILON:\n            bounds[1] = (bounds[1][0], 0) # Reverse only\n            dir_AB = -1\n        \n        # Directionality for R_BC (index 2)\n        dir_BC = 0\n        if delta_G_BC <= -EPSILON:\n            bounds[2] = (0, bounds[2][1]) # Forward only\n            dir_BC = 1\n        elif delta_G_BC >= EPSILON:\n            bounds[2] = (bounds[2][0], 0) # Reverse only\n            dir_BC = -1\n            \n        # 3. Solve the linear program\n        res = linprog(c, A_eq=A_eq, b_eq=b_eq, bounds=bounds, method='highs')\n        \n        # res.fun is the minimum of -v_bio. We want max v_bio.\n        max_v_bio = -res.fun if res.success else 0.0\n        \n        # 4. Store results for this case\n        final_results.extend([f\"{max_v_bio:.6f}\", str(dir_AB), str(dir_BC)])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(final_results)}]\")\n\nsolve()\n```"
        }
    ]
}