{
    "hands_on_practices": [
        {
            "introduction": "The variance parameter, $\\theta$, in a shared Gamma frailty model is the engine of between-cluster heterogeneity. However, its numerical value alone can be abstract. This exercise bridges the gap between the abstract parameter and a concrete measure of association by tasking you with deriving the relationship between $\\theta$ and Kendall's tau, $\\tau$. By working through this derivation, you will gain a profound understanding of how a shared frailty induces dependence and how to quantify this concordance in survival times within a cluster .",
            "id": "4963406",
            "problem": "A cohort study of clustered survival times is modeled using a shared frailty specification. For each cluster, let the unobserved frailty be $Z$, and assume $Z \\sim \\operatorname{Gamma}(1/\\theta, 1/\\theta)$, where the parameterization uses shape $1/\\theta$ and rate $1/\\theta$, so that $\\mathbb{E}[Z]=1$ and $\\operatorname{Var}(Z)=\\theta$. Conditional on $Z$ and a covariate vector $\\boldsymbol{x}$, the hazard for an individual at time $t$ is given by $h(t \\mid Z, \\boldsymbol{x}) = Z\\, h_{0}(t)\\, \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta})$, with baseline hazard $h_{0}(t)$ and regression coefficient vector $\\boldsymbol{\\beta}$. Consider two individuals in the same cluster who share identical covariates, i.e., $\\boldsymbol{x}_{1}=\\boldsymbol{x}_{2}=\\boldsymbol{x}$. \n\nStarting from the definition of the shared frailty model and the Laplace transform of the frailty distribution, derive the copula that links the two marginal survival functions induced by this model, and from the definition of Kendall’s tau for that copula family, obtain Kendall’s tau as a function of $\\theta$. Then evaluate it at $\\theta=0.8$. \n\nFinally, succinctly interpret the magnitude of this dependence measure for two exchangeable individuals in the same cluster at comparable covariates. \n\nExpress your final numerical answer as an exact fraction (no rounding).",
            "solution": "The problem requires the derivation of the copula for a shared Gamma frailty model, the subsequent derivation of Kendall's tau ($\\tau$), its evaluation for a specific parameter value, and an interpretation of the result.\n\n**Step 1: Problem Validation**\n\nThe givens are:\n- A shared frailty model for clustered survival times.\n- Unobserved frailty $Z \\sim \\operatorname{Gamma}(1/\\theta, 1/\\theta)$, with shape $\\alpha = 1/\\theta$ and rate $\\lambda = 1/\\theta$.\n- $\\mathbb{E}[Z]=1$ and $\\operatorname{Var}(Z)=\\theta$.\n- Conditional hazard function: $h(t \\mid Z, \\boldsymbol{x}) = Z\\, h_{0}(t)\\, \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta})$.\n- Two individuals in the same cluster with identical covariates: $\\boldsymbol{x}_{1}=\\boldsymbol{x}_{2}=\\boldsymbol{x}$.\n\nThe problem is scientifically grounded, being a standard exercise in statistical survival analysis. It is well-posed, with sufficient information to derive a unique solution. The language is objective and precise. Therefore, the problem is deemed valid.\n\n**Step 2: Derivation of the Marginal and Joint Survival Functions**\n\nFirst, we determine the conditional cumulative hazard function, $H(t \\mid Z, \\boldsymbol{x})$, by integrating the conditional hazard function $h(t \\mid Z, \\boldsymbol{x})$ with respect to time $t$:\n$$\nH(t \\mid Z, \\boldsymbol{x}) = \\int_{0}^{t} h(u \\mid Z, \\boldsymbol{x}) du = \\int_{0}^{t} Z\\, h_{0}(u)\\, \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta}) du\n$$\n$$\nH(t \\mid Z, \\boldsymbol{x}) = Z\\, \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta}) \\int_{0}^{t} h_{0}(u) du = Z\\, H_{0}(t)\\, \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta})\n$$\nwhere $H_{0}(t)$ is the baseline cumulative hazard function.\n\nThe conditional survival function, $S(t \\mid Z, \\boldsymbol{x})$, is given by:\n$$\nS(t \\mid Z, \\boldsymbol{x}) = \\exp(-H(t \\mid Z, \\boldsymbol{x})) = \\exp(-Z\\, H_{0}(t)\\, \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta}))\n$$\nThe marginal survival function, $S(t \\mid \\boldsymbol{x})$, is obtained by taking the expectation of the conditional survival function with respect to the frailty distribution of $Z$:\n$$\nS(t \\mid \\boldsymbol{x}) = \\mathbb{E}_{Z}[S(t \\mid Z, \\boldsymbol{x})] = \\mathbb{E}_{Z}[\\exp(-Z \\cdot (H_{0}(t)\\, \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta})))]\n$$\nThis expression is the Laplace transform of the distribution of $Z$, denoted $\\mathcal{L}_{Z}(s)$, evaluated at $s = H_{0}(t)\\, \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta})$. For a Gamma distribution with shape $\\alpha$ and rate $\\lambda$, the Laplace transform is $\\mathcal{L}_{Z}(s) = \\left(\\frac{\\lambda}{\\lambda+s}\\right)^{\\alpha}$.\nGiven $Z \\sim \\operatorname{Gamma}(\\alpha=1/\\theta, \\lambda=1/\\theta)$, its Laplace transform is:\n$$\n\\mathcal{L}_{Z}(s) = \\left(\\frac{1/\\theta}{1/\\theta+s}\\right)^{1/\\theta} = \\left(\\frac{1}{1+\\theta s}\\right)^{1/\\theta}\n$$\nSubstituting $s = H_{0}(t)\\, \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta})$ yields the marginal survival function:\n$$\nS(t \\mid \\boldsymbol{x}) = \\left(1 + \\theta\\, H_{0}(t)\\, \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta})\\right)^{-1/\\theta}\n$$\nNow, consider the joint survival function $S(t_{1}, t_{2} \\mid \\boldsymbol{x})$ for two individuals from the same cluster. Since their survival times $T_{1}$ and $T_{2}$ are conditionally independent given $Z$, we have:\n$$\nS(t_{1}, t_{2} \\mid Z, \\boldsymbol{x}) = S(t_{1} \\mid Z, \\boldsymbol{x}) S(t_{2} \\mid Z, \\boldsymbol{x}) = \\exp\\left(-Z \\left(H_{0}(t_{1}) + H_{0}(t_{2})\\right) \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta})\\right)\n$$\nThe marginal joint survival function is the expectation over $Z$:\n$$\nS(t_{1}, t_{2} \\mid \\boldsymbol{x}) = \\mathbb{E}_{Z}[S(t_{1}, t_{2} \\mid Z, \\boldsymbol{x})] = \\mathcal{L}_{Z}\\left((H_{0}(t_{1}) + H_{0}(t_{2})) \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta})\\right)\n$$\n$$\nS(t_{1}, t_{2} \\mid \\boldsymbol{x}) = \\left(1 + \\theta (H_{0}(t_{1}) + H_{0}(t_{2})) \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta})\\right)^{-1/\\theta}\n$$\n\n**Step 3: Derivation of the Copula**\n\nBy Sklar's Theorem, the joint survival function can be expressed through a copula $C$ that links the marginal survival functions. Let $u_{1} = S(t_{1} \\mid \\boldsymbol{x})$ and $u_{2} = S(t_{2} \\mid \\boldsymbol{x})$. We must express $S(t_{1}, t_{2} \\mid \\boldsymbol{x})$ in terms of $u_{1}$ and $u_{2}$. From the marginal survival function expression:\n$$\nu = \\left(1 + \\theta\\, H_{0}(t)\\, \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta})\\right)^{-1/\\theta}\n$$\nwe can solve for the term $\\theta\\, H_{0}(t)\\, \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta})$:\n$$\nu^{-\\theta} = 1 + \\theta\\, H_{0}(t)\\, \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta}) \\implies \\theta\\, H_{0}(t)\\, \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta}) = u^{-\\theta} - 1\n$$\nNow, substitute this back into the expression for the joint survival function:\n$$\nS(t_{1}, t_{2} \\mid \\boldsymbol{x}) = \\left(1 + \\theta\\, H_{0}(t_{1})\\, \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta}) + \\theta\\, H_{0}(t_{2})\\, \\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta})\\right)^{-1/\\theta}\n$$\n$$\nS(t_{1}, t_{2} \\mid \\boldsymbol{x}) = \\left(1 + (u_{1}^{-\\theta} - 1) + (u_{2}^{-\\theta} - 1)\\right)^{-1/\\theta}\n$$\n$$\nC(u_{1}, u_{2}) = S(t_{1}, t_{2} \\mid \\boldsymbol{x}) = \\left(u_{1}^{-\\theta} + u_{2}^{-\\theta} - 1\\right)^{-1/\\theta}\n$$\nThis is the Clayton copula with parameter $\\theta$.\n\n**Step 4: Derivation of Kendall's Tau ($\\tau$)**\n\nFor the Clayton copula with parameter $\\theta$, the relationship with Kendall's tau is well-known to be $\\tau = \\theta / (\\theta + 2)$. Here is a formal derivation. The derived copula is a member of the Archimedean family with generator $\\phi(t) = \\frac{t^{-\\theta}-1}{\\theta}$. For an Archimedean copula, Kendall's tau is given by the formula:\n$$\n\\tau = 1 + 4 \\int_{0}^{1} \\frac{\\phi(t)}{\\phi'(t)} dt\n$$\nThe derivative of the generator is:\n$$\n\\phi'(t) = \\frac{d}{dt}\\left(\\frac{t^{-\\theta}-1}{\\theta}\\right) = \\frac{1}{\\theta}(-\\theta t^{-\\theta-1}) = -t^{-\\theta-1}\n$$\nThe ratio $\\phi(t)/\\phi'(t)$ is:\n$$\n\\frac{\\phi(t)}{\\phi'(t)} = \\frac{(t^{-\\theta}-1)/\\theta}{-t^{-\\theta-1}} = -\\frac{t^{-\\theta}-1}{\\theta t^{-\\theta-1}} = -\\frac{t(1-t^{\\theta})}{\\theta}\n$$\nSubstituting this into the integral for $\\tau$:\n$$\n\\tau = 1 + 4 \\int_{0}^{1} \\left(-\\frac{t(1-t^{\\theta})}{\\theta}\\right) dt = 1 - \\frac{4}{\\theta} \\int_{0}^{1} (t-t^{\\theta+1}) dt\n$$\nEvaluating the integral:\n$$\n\\int_{0}^{1} (t-t^{\\theta+1}) dt = \\left[\\frac{t^{2}}{2} - \\frac{t^{\\theta+2}}{\\theta+2}\\right]_{0}^{1} = \\frac{1}{2} - \\frac{1}{\\theta+2} = \\frac{(\\theta+2)-2}{2(\\theta+2)} = \\frac{\\theta}{2(\\theta+2)}\n$$\nFinally, substituting this result back into the expression for $\\tau$:\n$$\n\\tau = 1 - \\frac{4}{\\theta} \\left(\\frac{\\theta}{2(\\theta+2)}\\right) = 1 - \\frac{2}{\\theta+2} = \\frac{(\\theta+2)-2}{\\theta+2} = \\frac{\\theta}{\\theta+2}\n$$\nSo, Kendall's tau is given by the function $\\tau(\\theta) = \\frac{\\theta}{\\theta+2}$.\n\n**Step 5: Evaluation and Interpretation**\n\nWe are asked to evaluate $\\tau$ at $\\theta=0.8$:\n$$\n\\tau = \\frac{0.8}{0.8+2} = \\frac{0.8}{2.8} = \\frac{8}{28} = \\frac{2}{7}\n$$\nThe parameter $\\theta$ represents the variance of the frailty distribution, which quantifies the heterogeneity between clusters. Kendall's tau, $\\tau$, measures the strength of the ordinal association between the survival times of two individuals within the same cluster. A value of $\\tau = 2/7 \\approx 0.2857$ signifies a positive but weak-to-moderate association. This dependence arises from the shared frailty $Z$, which represents unobserved risk factors (e.g., genetic predispositions, common environmental exposures) common to the cluster. The value indicates that if one individual in a cluster experiences a longer (or shorter) survival time relative to the population, the other individual from the same cluster is more likely to also experience a longer (or shorter) survival time. The probability of observing concordant survival time rankings for two pairs of individuals is higher than the probability of observing discordant rankings. Specifically, the probability of concordance is $(1+\\tau)/2 = (1+2/7)/2 = 9/14$, while the probability of discordance is $(1-\\tau)/2 = (1-2/7)/2 = 5/14$.",
            "answer": "$$\\boxed{\\frac{2}{7}}$$"
        },
        {
            "introduction": "While variance parameters like $\\sigma^2$ are statistically fundamental, communicating their practical importance to a clinical audience can be challenging. The Median Hazard Ratio (MHR) offers an elegant solution by translating variance into the familiar language of risk ratios. This practice focuses on the log-normal frailty model, a common choice in medical research, and guides you through the derivation of the MHR. Completing this exercise will equip you to quantify and explain the magnitude of institutional or group-level effects on patient outcomes in a clinically intuitive way .",
            "id": "4963269",
            "problem": "A multicenter clinical study investigates time to in-hospital mortality after emergency admission across $I$ hospitals. To account for unmeasured between-hospital heterogeneity, investigators fit a shared log-normal frailty Cox model at the hospital level. For patient $j$ in hospital $i$ with covariates $x_{ij}$, the hazard is modeled as\n$$\nh_{ij}(t \\mid u_i) \\;=\\; h_0(t)\\,\\exp\\!\\big(x_{ij}^{\\top}\\beta + u_i\\big),\n$$\nwhere $u_i \\sim \\mathcal{N}(0,\\sigma^2)$ are independent across hospitals and $h_0(t)$ is an unspecified baseline hazard.\n\nDefine the median hazard ratio (MHR) as follows: consider $2$ otherwise identical patients (same $x_{ij}$ and same time $t$) from two randomly selected different hospitals with frailties $u_{i_1}$ and $u_{i_2}$. Form the hazard ratio by placing the hospital with the larger frailty in the numerator so that the ratio is at least $1$. The MHR is the median of this random hazard ratio taken over the joint distribution of $(u_{i_1},u_{i_2})$.\n\nStarting only from the model definition above, the properties of the normal distribution, and the definition of the median of a random variable, derive an analytic expression for the MHR as a function of $\\sigma^2$. Then, evaluate it at $\\sigma^2 = 0.4$. Report the final numerical value rounded to $4$ significant figures. No units are required.\n\nFinally, in a single sentence, interpret the magnitude of the computed MHR in the clinical context where clusters are hospitals, in terms of how much hazards differ between two randomly selected hospitals for otherwise identical patients due to unmeasured hospital-level factors. Your interpretation will not be part of the final answer number.",
            "solution": "We begin with the shared log-normal frailty model\n$$\nh_{ij}(t \\mid u_i) \\;=\\; h_0(t)\\,\\exp\\!\\big(x_{ij}^{\\top}\\beta + u_i\\big),\n$$\nwith $u_i \\sim \\mathcal{N}(0,\\sigma^2)$ independent across hospitals. Consider two hospitals with frailties $u_{i_1}$ and $u_{i_2}$, and two otherwise identical patients (same $x_{ij}$ and same time $t$). The hazard ratio comparing the higher-risk to the lower-risk hospital is\n$$\n\\text{HR} \\;=\\; \\frac{h_0(t)\\exp(x^{\\top}\\beta + \\max\\{u_{i_1},u_{i_2}\\})}{h_0(t)\\exp(x^{\\top}\\beta + \\min\\{u_{i_1},u_{i_2}\\})}\n\\;=\\; \\exp\\!\\big(\\max\\{u_{i_1},u_{i_2}\\}-\\min\\{u_{i_1},u_{i_2}\\}\\big)\n\\;=\\; \\exp\\!\\big(|u_{i_1}-u_{i_2}|\\big).\n$$\n\nLet $\\Delta u \\equiv u_{i_1} - u_{i_2}$. Since $u_{i_1}$ and $u_{i_2}$ are independent and identically distributed as $\\mathcal{N}(0,\\sigma^2)$, the difference $\\Delta u$ is normally distributed with mean $0$ and variance $2\\sigma^2$, i.e.,\n$$\n\\Delta u \\sim \\mathcal{N}\\!\\big(0,\\,2\\sigma^2\\big).\n$$\nTherefore,\n$$\n\\text{HR} \\;=\\; \\exp\\!\\big(|\\Delta u|\\big),\n$$\nand the MHR is the median of $\\exp(|\\Delta u|)$. Because the exponential function is strictly increasing, the median of $\\exp(|\\Delta u|)$ equals $\\exp$ of the median of $|\\Delta u|$. Hence,\n$$\n\\mathrm{MHR} \\;=\\; \\exp\\!\\big(\\mathrm{median}(|\\Delta u|)\\big).\n$$\n\nWe now determine $\\mathrm{median}(|\\Delta u|)$ from first principles. Let $\\tau \\equiv \\sqrt{2}\\,\\sigma$, so that $\\Delta u \\sim \\mathcal{N}(0,\\tau^2)$. The random variable $|\\Delta u|$ has a folded normal distribution. The median $m$ of $|\\Delta u|$ satisfies\n$$\n\\mathbb{P}\\big(|\\Delta u| \\le m\\big) \\;=\\; \\tfrac{1}{2}.\n$$\nBy symmetry of the normal distribution,\n$$\n\\mathbb{P}\\big(|\\Delta u| \\le m\\big) \\;=\\; \\mathbb{P}\\big(-m \\le \\Delta u \\le m\\big) \\;=\\; \\Phi\\!\\Big(\\frac{m}{\\tau}\\Big) - \\Phi\\!\\Big(-\\frac{m}{\\tau}\\Big) \\;=\\; 2\\,\\Phi\\!\\Big(\\frac{m}{\\tau}\\Big) - 1,\n$$\nwhere $\\Phi(\\cdot)$ denotes the cumulative distribution function of the standard normal distribution. Setting this equal to $\\tfrac{1}{2}$ gives\n$$\n2\\,\\Phi\\!\\Big(\\frac{m}{\\tau}\\Big) - 1 \\;=\\; \\tfrac{1}{2}\n\\;\\;\\Longrightarrow\\;\\;\n\\Phi\\!\\Big(\\frac{m}{\\tau}\\Big) \\;=\\; \\tfrac{3}{4}.\n$$\nThus,\n$$\n\\frac{m}{\\tau} \\;=\\; \\Phi^{-1}\\!\\Big(\\tfrac{3}{4}\\Big)\n\\;\\;\\Longrightarrow\\;\\;\nm \\;=\\; \\tau\\,\\Phi^{-1}\\!\\Big(\\tfrac{3}{4}\\Big) \\;=\\; \\sqrt{2}\\,\\sigma \\,\\Phi^{-1}\\!\\Big(\\tfrac{3}{4}\\Big).\n$$\nTherefore, the median hazard ratio is\n$$\n\\mathrm{MHR} \\;=\\; \\exp\\!\\Big(\\sqrt{2}\\,\\sigma \\,\\Phi^{-1}\\!\\big(\\tfrac{3}{4}\\big)\\Big)\n\\;=\\;\n\\exp\\!\\Big(\\sqrt{2\\sigma^{2}}\\,\\Phi^{-1}\\!\\big(\\tfrac{3}{4}\\big)\\Big).\n$$\n\nWe now evaluate this expression at $\\sigma^{2} = 0.4$. First compute\n$$\n\\sqrt{2\\sigma^{2}} \\;=\\; \\sqrt{2 \\times 0.4} \\;=\\; \\sqrt{0.8}.\n$$\nUsing the well-known quantile $\\Phi^{-1}\\!\\big(0.75\\big) \\approx 0.6744897501960817$, we have\n$$\n\\sqrt{0.8}\\times \\Phi^{-1}\\!\\big(0.75\\big) \\;\\approx\\; 0.8944271909999159 \\times 0.6744897501960817 \\;\\approx\\; 0.603022689.\n$$\nExponentiating,\n$$\n\\mathrm{MHR} \\;\\approx\\; \\exp(0.603022689) \\;\\approx\\; 1.82764.\n$$\nRounded to $4$ significant figures, the numerical value is $1.828$.\n\nInterpretation in the clinical context: An $\\mathrm{MHR}$ of approximately $1.828$ means that for two otherwise identical patients treated at two randomly selected hospitals, the median multiplicative difference in their instantaneous risk of the event attributable solely to unmeasured hospital-level factors is about a factor of $1.828$, with the patient at the higher-risk hospital experiencing the greater hazard.",
            "answer": "$$\\boxed{1.828}$$"
        },
        {
            "introduction": "After exploring how to interpret frailty model parameters, the final step is to understand how they are estimated from data. The Expectation-Maximization (EM) algorithm is a cornerstone of fitting models with latent variables, like frailties. This advanced exercise provides a hands-on opportunity to implement a full EM iteration for a Gamma-frailty model with a Weibull baseline hazard. Engaging with the machinery of the E-step and M-step will demystify the fitting process and provide a solid foundation for understanding the computational underpinnings of modern survival models .",
            "id": "4963310",
            "problem": "Implement a single Expectation-Maximization (EM) iteration for a shared frailty survival model with a Weibull baseline hazard in a clustered right-censored dataset under the following modeling assumptions and definitions, and report the updated parameters for specified test cases.\n\nModeling assumptions and core definitions:\n- Consider a shared frailty model with clusters indexed by $i \\in \\{1,\\dots, N\\}$ and within-cluster individuals indexed by $j$.\n- Each observed time is $t_{ij} \\in \\mathbb{R}_{+}$ with event indicator $\\delta_{ij} \\in \\{0,1\\}$, where $\\delta_{ij} = 1$ denotes an event and $\\delta_{ij} = 0$ denotes right-censoring.\n- Conditional on a nonnegative shared frailty $Z_i$, individual times are independent with hazard $h(t \\mid Z_i) = Z_i h_0(t)$, where the baseline hazard is Weibull: $h_0(t) = \\kappa \\lambda t^{\\kappa-1}$ with cumulative hazard $H_0(t) = \\lambda t^{\\kappa}$ for shape $\\kappa  0$ and scale $\\lambda  0$.\n- The cluster frailty $Z_i$ follows a Gamma distribution with mean $1$ and variance $\\theta  0$, equivalently $Z_i \\sim \\mathrm{Gamma}(\\alpha, \\beta)$ with shape $\\alpha = 1/\\theta$ and rate $\\beta = 1/\\theta$. This is a standard choice ensuring identifiability of the baseline.\n- The complete-data log-likelihood (up to additive constants not depending on parameters) can be written using the sufficient statistics $d_i = \\sum_j \\delta_{ij}$ and $A_i = \\sum_j H_0(t_{ij}) = \\sum_j \\lambda t_{ij}^{\\kappa}$ for each cluster $i$.\n\nExpectation-Maximization (EM) iteration requirements:\n- Expectation step (E-step): Using conjugacy of the Gamma prior for $Z_i$ and the Poisson-like likelihood structure for $d_i$ with exposure $A_i$, compute the conditional expectations $\\mathbb{E}[Z_i \\mid \\text{data}, \\theta^{(0)}, \\lambda^{(0)}, \\kappa^{(0)}]$ and $\\mathbb{E}[\\log Z_i \\mid \\text{data}, \\theta^{(0)}, \\lambda^{(0)}, \\kappa^{(0)}]$. Here $A_i$ is computed from the current baseline parameters as $A_i = \\sum_j \\lambda^{(0)} \\, t_{ij}^{\\kappa^{(0)}}$, and $d_i = \\sum_j \\delta_{ij}$.\n- Maximization step (M-step):\n  - Update the frailty variance parameter $\\theta$ by maximizing the expected complete-data log-likelihood with respect to $\\theta$. Introduce $\\alpha = 1/\\theta$ and solve the first-order optimality condition for $\\alpha$ using numerical root-finding.\n  - Update the Weibull baseline parameters by maximizing the expected complete-data log-likelihood with respect to $(\\lambda, \\kappa)$, where the latent $Z_i$ are replaced by their conditional expectations from the E-step. This leads to a one-dimensional root-finding problem for $\\kappa$ with a closed-form profile update for $\\lambda$ given $\\kappa$. If there are no events in the entire dataset, leave $(\\lambda, \\kappa)$ unchanged for numerical stability.\n\nComputational and algorithmic constraints:\n- Assume no covariates and independent right-censoring.\n- Use robust numerical solvers for one-dimensional root-finding in the M-step, ensuring positivity constraints for all parameters are respected. If necessary, bracket roots in an interval $[10^{-6}, 10^{2}]$ and fall back to Newton updates with appropriate safeguards.\n- All computations must use floating-point arithmetic. No physical units are involved beyond abstract time; report results as dimensionless floating-point numbers.\n\nTest suite:\nFor each test case, run exactly one EM iteration starting from the specified initial parameters and dataset, and return the updated parameter triple $[\\theta^{(1)}, \\lambda^{(1)}, \\kappa^{(1)}]$ rounded to $6$ decimal places.\n\n- Test case $1$ (happy path; matches the thumbnail aggregation $A_i$):\n  - Initial parameters: $\\theta^{(0)} = 0.5$, $\\lambda^{(0)} = 0.5$, $\\kappa^{(0)} = 1.0$.\n  - One cluster ($N = 1$) with two individuals ($n_1 = 2$):\n    - Times $t_{11} = 3.0$, $t_{12} = 4.0$.\n    - Event indicators $\\delta_{11} = 1$, $\\delta_{12} = 1$.\n  - Note: With the given initial baseline, $A_1 = \\sum_j \\lambda^{(0)} t_{1j}^{\\kappa^{(0)}} = 0.5 \\times (3.0 + 4.0) = 3.5$, and $d_1 = 2$.\n\n- Test case $2$ (boundary condition: zero events):\n  - Initial parameters: $\\theta^{(0)} = 0.5$, $\\lambda^{(0)} = 0.5$, $\\kappa^{(0)} = 1.0$.\n  - One cluster ($N = 1$) with two individuals:\n    - Times $t_{11} = 2.0$, $t_{12} = 5.0$.\n    - Event indicators $\\delta_{11} = 0$, $\\delta_{12} = 0$.\n  - Note: With the given initial baseline, $A_1 = 0.5 \\times (2.0 + 5.0) = 3.5$, and $d_1 = 0$.\n\n- Test case $3$ (multiple clusters; mixed events and censoring):\n  - Initial parameters: $\\theta^{(0)} = 0.5$, $\\lambda^{(0)} = 0.8$, $\\kappa^{(0)} = 1.2$.\n  - Two clusters ($N = 2$):\n    - Cluster $1$: $t_{11} = 1.0$, $t_{12} = 2.0$ with $\\delta_{11} = 1$, $\\delta_{12} = 0$.\n    - Cluster $2$: $t_{21} = 0.5$, $t_{22} = 1.5$, $t_{23} = 3.0$ with $\\delta_{21} = 1$, $\\delta_{22} = 1$, $\\delta_{23} = 0$.\n\nRequired output format:\n- Your program must produce a single line containing a list of three lists, one per test case, where each inner list is $[\\theta^{(1)}, \\lambda^{(1)}, \\kappa^{(1)}]$ rounded to $6$ decimal places.\n- For example, the output must look like $[[a_1,b_1,c_1],[a_2,b_2,c_2],[a_3,b_3,c_3]]$ with no additional text or whitespace requirements beyond standard list formatting.\n\nYour task:\n- Implement the EM iteration exactly as described, compute the updated parameters for each test case, and print the results in the specified single-line format.",
            "solution": "The problem requires the implementation of a single Expectation-Maximization (EM) iteration for parameter estimation in a shared Gamma-frailty model with a Weibull baseline hazard. The dataset consists of clustered, right-censored survival times.\n\n### Derivation of the EM Iteration\n\nThe EM algorithm is an iterative method for finding maximum likelihood estimates of parameters in statistical models where the model depends on unobserved latent variables. In this context, the frailties $Z_i$ are the latent variables. An iteration consists of an Expectation (E) step and a Maximization (M) step.\n\nLet the current parameter estimates be $\\Theta^{(k)} = (\\theta^{(k)}, \\lambda^{(k)}, \\kappa^{(k)})$.\n\n#### E-Step: Computing Conditional Expectations\nThe E-step involves computing the expectation of the complete-data log-likelihood, conditional on the observed data and current parameter estimates $\\Theta^{(k)}$. This requires the posterior distribution of the latent variables $Z_i$.\n\nThe likelihood of the observed data $(t_{ij}, \\delta_{ij})_{j}$ in cluster $i$, conditional on the frailty $Z_i$, is\n$$ L_i(\\text{data}_i \\mid Z_i; \\lambda, \\kappa) = \\prod_j [h(t_{ij} | Z_i)]^{\\delta_{ij}} S(t_{ij} | Z_i) = \\prod_j [Z_i h_0(t_{ij})]^{\\delta_{ij}} \\exp[-Z_i H_0(t_{ij})] $$\n$$ L_i(\\text{data}_i \\mid Z_i; \\lambda, \\kappa) = \\left( \\prod_j [h_0(t_{ij})]^{\\delta_{ij}} \\right) Z_i^{\\sum_j \\delta_{ij}} \\exp\\left[-Z_i \\sum_j H_0(t_{ij})\\right] $$\nUsing the sufficient statistics $d_i = \\sum_j \\delta_{ij}$ and $A_i = \\lambda^{(k)} \\sum_j t_{ij}^{\\kappa^{(k)}}$, the likelihood is proportional to $Z_i^{d_i} e^{-Z_i A_i}$.\n\nThe prior distribution for $Z_i$ is $\\mathrm{Gamma}(\\alpha, \\beta)$ with $\\alpha = \\beta = 1/\\theta^{(k)}$. The probability density function is $p(Z_i) \\propto Z_i^{\\alpha-1} e^{-\\beta Z_i}$.\n\nBy Bayes' theorem, the posterior distribution of $Z_i$ is\n$$ p(Z_i \\mid \\text{data}_i, \\Theta^{(k)}) \\propto L_i(\\text{data}_i \\mid Z_i) p(Z_i) \\propto (Z_i^{d_i} e^{-Z_i A_i}) (Z_i^{\\alpha-1} e^{-\\beta Z_i}) = Z_i^{d_i+\\alpha-1} e^{-(A_i+\\beta)Z_i} $$\nThis is the kernel of a Gamma distribution. Thus, the posterior distribution is\n$$ Z_i \\mid \\text{data}_i, \\Theta^{(k)} \\sim \\mathrm{Gamma}(d_i + \\alpha, A_i + \\beta) = \\mathrm{Gamma}\\left(d_i + \\frac{1}{\\theta^{(k)}}, A_i + \\frac{1}{\\theta^{(k)}}\\right) $$\nThe required conditional expectations are properties of this posterior Gamma distribution. For $X \\sim \\mathrm{Gamma}(a, b)$, we have $\\mathbb{E}[X] = a/b$ and $\\mathbb{E}[\\log X] = \\psi(a) - \\log(b)$, where $\\psi$ is the digamma function.\n\nTherefore, for each cluster $i$:\n$$ E_{Z_i} := \\mathbb{E}[Z_i \\mid \\text{data}_i, \\Theta^{(k)}] = \\frac{d_i + 1/\\theta^{(k)}}{A_i + 1/\\theta^{(k)}} $$\n$$ E_{\\log Z_i} := \\mathbb{E}[\\log Z_i \\mid \\text{data}_i, \\Theta^{(k)}] = \\psi\\left(d_i + \\frac{1}{\\theta^{(k)}}\\right) - \\log\\left(A_i + \\frac{1}{\\theta^{(k)}}\\right) $$\nThese values are computed for all clusters $i=1, \\dots, N$.\n\n#### M-Step: Maximizing the Expected Log-Likelihood\nThe M-step maximizes the expected complete-data log-likelihood, $Q(\\Theta \\mid \\Theta^{(k)})$, with respect to the parameters $\\Theta = (\\theta, \\lambda, \\kappa)$. The function $Q$ can be separated into parts depending on $\\theta$ and on $(\\lambda, \\kappa)$.\n\n**1. Update of Frailty Variance $\\theta$**\nThe part of $Q$ depending on $\\theta$ (or $\\alpha = 1/\\theta$) is:\n$$ Q_{\\theta}(\\alpha) = \\sum_{i=1}^N \\mathbb{E}[\\log p(Z_i; \\alpha)] = \\sum_{i=1}^N \\mathbb{E}[\\alpha \\log \\alpha - \\log \\Gamma(\\alpha) + (\\alpha-1)\\log Z_i - \\alpha Z_i] $$\n$$ Q_{\\theta}(\\alpha) = N(\\alpha \\log \\alpha - \\log \\Gamma(\\alpha)) + (\\alpha-1)\\sum_{i=1}^N E_{\\log Z_i} - \\alpha \\sum_{i=1}^N E_{Z_i} $$\nTo maximize $Q_{\\theta}(\\alpha)$, we set its derivative with respect to $\\alpha$ to zero:\n$$ \\frac{\\partial Q_{\\theta}}{\\partial \\alpha} = N(\\log \\alpha + 1 - \\psi(\\alpha)) + \\sum_{i=1}^N E_{\\log Z_i} - \\sum_{i=1}^N E_{Z_i} = 0 $$\n$$ N(\\log \\alpha - \\psi(\\alpha)) + N + \\sum_{i=1}^N E_{\\log Z_i} - \\sum_{i=1}^N E_{Z_i} = 0 $$\nThis non-linear equation for $\\alpha$ must be solved numerically. Let $K = N + \\sum_i E_{\\log Z_i} - \\sum_i E_{Z_i}$. We solve $N(\\log \\alpha - \\psi(\\alpha)) + K = 0$. If $K/N \\ge 0$, the left-hand side is always positive, implying the maximum occurs as $\\alpha \\to \\infty$, which means $\\theta \\to 0$. In this case, we cap $\\alpha$ at a large value. Otherwise, a unique root $\\alpha^{(k+1)}$ exists and can be found using a numerical solver. The updated frailty variance is $\\theta^{(k+1)} = 1/\\alpha^{(k+1)}$.\n\n**2. Update of Baseline Hazard Parameters $(\\lambda, \\kappa)$**\nThe part of $Q$ depending on $(\\lambda, \\kappa)$ is:\n$$ Q_{\\lambda, \\kappa}(\\lambda, \\kappa) = \\sum_{i=1}^N \\mathbb{E} \\left[ \\sum_j \\delta_{ij} \\log(Z_i h_0(t_{ij})) - \\sum_j Z_i H_0(t_{ij}) \\right] $$\nSubstituting $h_0(t) = \\kappa \\lambda t^{\\kappa-1}$ and $H_0(t) = \\lambda t^\\kappa$, and taking the expectation over $Z_i$:\n$$ Q_{\\lambda, \\kappa} = \\sum_{i,j} \\delta_{ij}(\\log(\\kappa\\lambda) + (\\kappa-1)\\log t_{ij}) - \\lambda \\sum_{i,j} E_{Z_i} t_{ij}^{\\kappa} + \\text{const} $$\nLet $D = \\sum_{i,j} \\delta_{ij}$ be the total number of events.\n$$ Q_{\\lambda, \\kappa} = D \\log\\lambda + D \\log\\kappa + (\\kappa-1)\\sum_{i,j} \\delta_{ij}\\log t_{ij} - \\lambda \\sum_{i,j} E_{Z_i} t_{ij}^{\\kappa} $$\nIf $D=0$, this function is maximized for $\\lambda \\to 0$, which is not meaningful. As per the problem, if $D=0$, we set $(\\lambda^{(k+1)}, \\kappa^{(k+1)}) = (\\lambda^{(k)}, \\kappa^{(k)})$.\n\nIf $D  0$, we can find a profile likelihood for $\\kappa$. Differentiating with respect to $\\lambda$ and setting to zero gives the optimal $\\lambda$ for a given $\\kappa$:\n$$ \\frac{\\partial Q_{\\lambda, \\kappa}}{\\partial \\lambda} = \\frac{D}{\\lambda} - \\sum_{i,j} E_{Z_i} t_{ij}^\\kappa = 0 \\implies \\lambda(\\kappa) = \\frac{D}{\\sum_{i,j} E_{Z_i} t_{ij}^{\\kappa}} $$\nSubstituting this back into $Q_{\\lambda, \\kappa}$ yields a profile objective function for $\\kappa$. Setting its derivative with respect to $\\kappa$ to zero gives the following equation for $\\kappa$:\n$$ \\frac{D}{\\kappa} + \\sum_{i,j} \\delta_{ij} \\log t_{ij} - \\frac{D \\sum_{i,j} E_{Z_i} t_{ij}^\\kappa \\log t_{ij}}{\\sum_{i,j} E_{Z_i} t_{ij}^\\kappa} = 0 $$\nDividing by $D$, we obtain the equation to be solved numerically for $\\kappa^{(k+1)}$:\n$$ \\frac{1}{\\kappa} + \\frac{1}{D}\\sum_{i,j} \\delta_{ij} \\log t_{ij} - \\frac{\\sum_{i,j} E_{Z_i} t_{ij}^\\kappa \\log t_{ij}}{\\sum_{i,j} E_{Z_i} t_{ij}^\\kappa} = 0 $$\nThis is a 1D root-finding problem. Once $\\kappa^{(k+1)}$ is found, the update for $\\lambda$ is computed from its profile expression:\n$$ \\lambda^{(k+1)} = \\frac{D}{\\sum_{i,j} E_{Z_i} t_{ij}^{\\kappa^{(k+1)}}} $$",
            "answer": "[[0.352136, 0.301587, 1.258079],[0.5, 0.5, 1.0],[0.485124, 0.730302, 1.38576]]"
        }
    ]
}