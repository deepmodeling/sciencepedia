{
    "hands_on_practices": [
        {
            "introduction": "随机对照试验是因果推断的黄金标准，但其有效性可能因研究对象的“不依从性”（non-compliance）而受到影响。本实践深入探讨了工具变量框架，这是分析依从性不完美试验的基石。通过利用初始的随机分配作为工具变量，你将学习如何为那些依从分配的特定患者亚群识别因果效应——即“依从者平均因果效应”（Complier Average Causal Effect, CACE），也被称为“局部平均处理效应”（Local Average Treatment Effect, LATE）。",
            "id": "4987082",
            "problem": "一项随机住院研究评估了启动预防性抗病毒治疗是否能降低在第 $30$ 天前聚合酶链式反应确诊的呼吸道感染的概率。令 $Z \\in \\{0,1\\}$ 表示随机分配，其中 $Z=1$ 表示提供立即启动治疗，而 $Z=0$ 表示常规护理。令 $D(z) \\in \\{0,1\\}$ 表示在分配 $z$ 下的潜在治疗接受指标，其中 $D(z)=1$ 意味着患者在分配 $z$ 下会启动抗病毒治疗。令 $Y(d) \\in \\{0,1\\}$ 表示如果患者的治疗接受情况为 $d$，则到第 $30$ 天时是否感染的潜在结果。观测到的接受情况为 $D= D(Z)$，观测到的结果为 $Y = Y(D)$。\n\n假设以下基本原则：\n- 稳定单位处理价值假设 (SUTVA)：单位之间无干扰，且处理方式定义明确，因此观测变量等于其在实现的分配和接受情况下的相应潜在结果，并且每种接受情况 $d$ 只有一个版本。\n- 随机化：$Z$ 独立于所有潜在变量，因此 $Z \\perp \\{D(1), D(0), Y(1), Y(0)\\}$。\n- 排他性限制：分配 $Z$ 仅通过接受情况 $D$ 影响 $Y$，因此对任何单位，如果 $D(1)=D(0)$ 则 $Y(1)=Y(0)$，等价于对 $z \\in \\{0,1\\}$ 有 $Y(z)=Y(D(z))$。\n- 单调性：不存在反抗者，因此 $D(1) \\ge D(0)$ 几乎必然成立。\n- 正性与工具变量相关性：$\\mathbb{P}(Z=1)>0$，$\\mathbb{P}(Z=0)>0$，且 $\\mathbb{P}(D=1 \\mid Z=1) \\ne \\mathbb{P}(D=1 \\mid Z=0)$。\n\n定义主分层 $G=(D(1),D(0))$，并令依从者分层为 $D(1)=1$ 和 $D(0)=0$ 的那些单位。考虑依从者平均因果效应，也称为局部平均处理效应 (LATE)，定义为 $\\mathbb{E}\\!\\left[ Y(1)-Y(0) \\mid D(1)>D(0) \\right] = \\mathbb{E}\\!\\left[ Y(1)-Y(0) \\mid D(1)=1, D(0)=0 \\right]$。\n\n在上述假设下，以下哪个陈述是正确的？\n\nA. 比率 $\\dfrac{\\mathbb{E}[Y \\mid Z=1] - \\mathbb{E}[Y \\mid Z=0]}{\\mathbb{E}[D \\mid Z=1] - \\mathbb{E}[D \\mid Z=0]}$ 识别了 $\\mathbb{E}\\!\\left[ Y(1)-Y(0) \\mid D(1)>D(0) \\right]$。\n\nB. 差值 $\\mathbb{E}[Y \\mid D=1] - \\mathbb{E}[Y \\mid D=0]$ 识别了 $\\mathbb{E}\\!\\left[ Y(1)-Y(0) \\mid D(1)>D(0) \\right]$。\n\nC. 差值 $\\mathbb{E}[Y \\mid Z=1] - \\mathbb{E}[Y \\mid Z=0]$ 识别了 $\\mathbb{E}\\!\\left[ Y(1)-Y(0) \\mid D(1)>D(0) \\right]$。\n\nD. 比率 $\\dfrac{\\mathbb{E}[Y \\mid Z=1] - \\mathbb{E}[Y \\mid Z=0]}{\\mathbb{E}[D \\mid Z=1] - \\mathbb{E}[D \\mid Z=0]}$ 识别了 $\\mathbb{E}\\!\\left[ Y(1)-Y(0) \\mid D(1)=1, D(0)=1 \\right]$。\n\nE. 仅在单调性假设下，无排他性限制，差值 $\\mathbb{E}[Y \\mid Z=1] - \\mathbb{E}[Y \\mid Z=0]$ 等于 $\\mathbb{E}\\!\\left[ Y(1)-Y(0) \\mid D(1)>D(0) \\right]$。",
            "solution": "问题陈述描述了一个存在不完全依从性的随机对照试验，这是一个适用工具变量 (IV) 方法的场景。任务是在一组特定假设下，识别关于因果效应估计的正确陈述。\n\n### 第1步：提取已知条件\n\n问题提供了以下定义和假设：\n-   **随机分配（工具变量）：** $Z \\in \\{0,1\\}$，其中 $Z=1$ 表示提供治疗，$Z=0$ 表示常规护理。\n-   **潜在治疗接受情况：** $D(z) \\in \\{0,1\\}$，如果被分配到组 $z$，治疗接受的决定。\n-   **潜在结果：** $Y(d) \\in \\{0,1\\}$，如果治疗接受状态为 $d$，对应的结果。\n-   **观测变量：** $D = D(Z)$ 是观测到的治疗接受情况，$Y = Y(D)$ 是观测到的结果。\n-   **稳定单位处理价值假设 (SUTVA)：** 单位之间无干扰，且潜在结果定义明确。这意味着 $D = D(Z)$ 和 $Y = Y(D(Z))$。\n-   **随机化：** $Z \\perp \\{D(1), D(0), Y(1), Y(0)\\}$。分配 $Z$ 在统计上独立于所有潜在结果和潜在接受情况。\n-   **排他性限制：** 分配 $Z$ 仅通过治疗接受情况 $D$ 影响结果 $Y$。形式上，对于任何单位，如果 $D(1)=D(0)$，则 $Y(1)=Y(0)$。一个等价的表述是 $Y(z) = Y(D(z))$，其中 $z \\in \\{0,1\\}$，$Y(z)$ 是分配 $z$ 下的潜在结果。\n-   **单调性：** 对于所有单位，$D(1) \\ge D(0)$。这排除了“反抗者”的存在，即 $D(1)=0$ 且 $D(0)=1$ 的单位。\n-   **正性与工具变量相关性：** $\\mathbb{P}(Z=1)>0$，$\\mathbb{P}(Z=0)>0$，且 $\\mathbb{P}(D=1 \\mid Z=1) \\ne \\mathbb{P}(D=1 \\mid Z=0)$。\n-   **主分层：** 由潜在接受情况对 $G=(D(1),D(0))$ 定义。\n-   **依从者分层：** 满足 $(D(1),D(0)) = (1,0)$ 的单位子群体，在单调性和二元接受情况下，这等价于 $D(1)>D(0)$。\n-   **感兴趣的因果估计量：** 依从者平均因果效应 (CACE) 或局部平均处理效应 (LATE)，定义为 $\\mathbb{E}\\!\\left[ Y(1)-Y(0) \\mid D(1)>D(0) \\right]$。\n\n### 第2步：使用提取的已知条件进行验证\n\n问题陈述是潜在结果框架（也称为 Rubin 因果模型）内工具变量分析的标准、规范表述，由 Imbens 和 Angrist 发展而来。\n\n-   **科学基础：** 整个问题植根于既定的因果推断统计学和计量经济学理论。其设置和假设是识别 LATE 所需的标准假设。\n-   **良态问题：** 问题陈述清晰，提供了推导唯一答案所需的所有定义和假设。问题要求识别一个特定的因果估计量，这是一个定义明确的数学问题。\n-   **客观性：** 问题使用精确、形式化的数学符号和术语表述，没有歧义或主观内容。\n\n所有用于检查无效性的辅助检查都已通过。该问题并非不健全、不完整、矛盾、不现实、病态或琐碎。该问题是形式化因果推断中的一个有效练习。\n\n### 第3步：推导与选项评估\n\n我们被要求确定哪个表达式正确地识别了局部平均处理效应 (LATE)，即 $\\mathbb{E}\\!\\left[ Y(1)-Y(0) \\mid D(1)>D(0) \\right]$。我们将分析选项 A 中的表达式，该表达式通常被称为 IV 估计量或 Wald 估计量，然后评估其他选项。\n\n该表达式为 $\\dfrac{\\mathbb{E}[Y \\mid Z=1] - \\mathbb{E}[Y \\mid Z=0]}{\\mathbb{E}[D \\mid Z=1] - \\mathbb{E}[D \\mid Z=0]}$。\n\n**分子分析：$\\mathbb{E}[Y \\mid Z=1] - \\mathbb{E}[Y \\mid Z=0]$**\n\n这是对结果 $Y$ 的意向治疗 (ITT) 效应。\n-   使用 SUTVA，观测结果为 $Y=Y(D(Z))$。\n-   因此，$\\mathbb{E}[Y \\mid Z=1] = \\mathbb{E}[Y(D(1)) \\mid Z=1]$。根据随机化假设，$Z$ 独立于潜在结果，所以 $\\mathbb{E}[Y(D(1)) \\mid Z=1] = \\mathbb{E}[Y(D(1))]$。\n-   类似地，$\\mathbb{E}[Y \\mid Z=0] = \\mathbb{E}[Y(D(0)) \\mid Z=0] = \\mathbb{E}[Y(D(0))]$。\n-   因此分子是 $\\mathbb{E}[Y(D(1))] - \\mathbb{E}[Y(D(0))]$。\n\n我们根据主分层 $G=(D(1),D(0))$ 对总体进行划分。由于单调性假设 ($D(1) \\ge D(0)$)，唯一可能的分层是：\n-   **始终接受者 (AT):** $(D(1),D(0))=(1,1)$。令其总体比例为 $\\pi_{AT}$。\n-   **依从者 (CO):** $(D(1),D(0))=(1,0)$。令其总体比例为 $\\pi_{CO}$。\n-   **从不接受者 (NT):** $(D(1),D(0))=(0,0)$。令其总体比例为 $\\pi_{NT}$。\n\n使用全期望定律，我们可以展开分子。形式为 $Y(z)=Y(D(z))$ 的排他性限制现在至关重要。\n$$ \\mathbb{E}[Y(D(1))] = \\mathbb{E}[Y(D(1)) \\mid AT]\\pi_{AT} + \\mathbb{E}[Y(D(1)) \\mid CO]\\pi_{CO} + \\mathbb{E}[Y(D(1)) \\mid NT]\\pi_{NT} $$\n对于始终接受者，$D(1)=1$，所以 $\\mathbb{E}[Y(D(1)) \\mid AT] = \\mathbb{E}[Y(1) \\mid AT]$。\n对于依从者，$D(1)=1$，所以 $\\mathbb{E}[Y(D(1)) \\mid CO] = \\mathbb{E}[Y(1) \\mid CO]$。\n对于从不接受者，$D(1)=0$，所以 $\\mathbb{E}[Y(D(1)) \\mid NT] = \\mathbb{E}[Y(0) \\mid NT]$。\n$$ \\Rightarrow \\mathbb{E}[Y(D(1))] = \\mathbb{E}[Y(1) \\mid AT]\\pi_{AT} + \\mathbb{E}[Y(1) \\mid CO]\\pi_{CO} + \\mathbb{E}[Y(0) \\mid NT]\\pi_{NT} $$\n类似地，对于 $\\mathbb{E}[Y(D(0))]$：\n$$ \\mathbb{E}[Y(D(0))] = \\mathbb{E}[Y(D(0)) \\mid AT]\\pi_{AT} + \\mathbb{E}[Y(D(0)) \\mid CO]\\pi_{CO} + \\mathbb{E}[Y(D(0)) \\mid NT]\\pi_{NT} $$\n对于始终接受者，$D(0)=1$，所以 $\\mathbb{E}[Y(D(0)) \\mid AT] = \\mathbb{E}[Y(1) \\mid AT]$。\n对于依从者，$D(0)=0$，所以 $\\mathbb{E}[Y(D(0)) \\mid CO] = \\mathbb{E}[Y(0) \\mid CO]$。\n对于从不接受者，$D(0)=0$，所以 $\\mathbb{E}[Y(D(0)) \\mid NT] = \\mathbb{E}[Y(0) \\mid NT]$。\n$$ \\Rightarrow \\mathbb{E}[Y(D(0))] = \\mathbb{E}[Y(1) \\mid AT]\\pi_{AT} + \\mathbb{E}[Y(0) \\mid CO]\\pi_{CO} + \\mathbb{E}[Y(0) \\mid NT]\\pi_{NT} $$\n将两个表达式相减，AT 和 NT 的项相互抵消：\n$$ \\mathbb{E}[Y(D(1))] - \\mathbb{E}[Y(D(0))] = (\\mathbb{E}[Y(1) \\mid CO] - \\mathbb{E}[Y(0) \\mid CO])\\pi_{CO} $$\n这恰好是 $\\mathbb{E}[Y(1)-Y(0) \\mid D(1)>D(0)] \\cdot \\mathbb{P}(D(1)>D(0))$，即 $LATE \\cdot \\pi_{CO}$。\n\n**分母分析：$\\mathbb{E}[D \\mid Z=1] - \\mathbb{E}[D \\mid Z=0]$**\n\n这是对治疗接受情况 $D$ 的 ITT 效应。\n-   使用 SUTVA，$D=D(Z)$。\n-   $\\mathbb{E}[D \\mid Z=1] = \\mathbb{E}[D(1) \\mid Z=1] = \\mathbb{E}[D(1)]$，根据随机化。由于 $D$ 是二元的，这等于 $\\mathbb{P}(D(1)=1)$。\n-   $\\mathbb{E}[D \\mid Z=0] = \\mathbb{E}[D(0) \\mid Z=0] = \\mathbb{E}[D(0)]$，根据随机化。这等于 $\\mathbb{P}(D(0)=1)$。\n-   分母是 $\\mathbb{P}(D(1)=1) - \\mathbb{P}(D(0)=1)$。\n\n在各分层上展开：\n-   $\\mathbb{P}(D(1)=1) = \\mathbb{P}(D(1)=1 \\text{ and } G=AT) + \\mathbb{P}(D(1)=1 \\text{ and } G=CO) + \\mathbb{P}(D(1)=1 \\text{ and } G=NT) = \\pi_{AT} + \\pi_{CO}$。\n-   $\\mathbb{P}(D(0)=1) = \\mathbb{P}(D(0)=1 \\text{ and } G=AT) + \\mathbb{P}(D(0)=1 \\text{ and } G=CO) + \\mathbb{P}(D(0)=1 \\text{ and } G=NT) = \\pi_{AT}$。\n-   分母是 $(\\pi_{AT} + \\pi_{CO}) - \\pi_{AT} = \\pi_{CO}$，即依从者的比例，$\\mathbb{P}(D(1)>D(0))$。工具变量相关性假设确保了 $\\pi_{CO} \\ne 0$。\n\n**合并分子和分母**\n\n$$ \\frac{\\mathbb{E}[Y \\mid Z=1] - \\mathbb{E}[Y \\mid Z=0]}{\\mathbb{E}[D \\mid Z=1] - \\mathbb{E}[D \\mid Z=0]} = \\frac{LATE \\cdot \\pi_{CO}}{\\pi_{CO}} = LATE $$\n该比率正确地识别了局部平均处理效应。\n\n**逐项分析**\n\n**A. 比率 $\\dfrac{\\mathbb{E}[Y \\mid Z=1] - \\mathbb{E}[Y \\mid Z=0]}{\\mathbb{E}[D \\mid Z=1] - \\mathbb{E}[D \\mid Z=0]}$ 识别了 $\\mathbb{E}\\!\\left[ Y(1)-Y(0) \\mid D(1)>D(0) \\right]$。**\n-   上述推导证实了这一陈述。这是 LATE 框架的核心结果。\n-   **结论：正确。**\n\n**B. 差值 $\\mathbb{E}[Y \\mid D=1] - \\mathbb{E}[Y \\mid D=0]$ 识别了 $\\mathbb{E}\\!\\left[ Y(1)-Y(0) \\mid D(1)>D(0) \\right]$。**\n-   这是“按处理分析”或“依从协议分析”的估计量。它比较了所有接受治疗者的平均结果，$\\mathbb{E}[Y(1) \\mid D=1]$，与所有未接受治疗者的平均结果，$\\mathbb{E}[Y(0) \\mid D=0]$。$\\{D=1\\}$ 和 $\\{D=0\\}$ 这两个组不是随机化的；它们是通过自我选择形成的，因此很可能在治疗之外的其他方面存在差异，导致混淆。例如，$D=1$ 的组是依从者和始终接受者的混合体，而 $D=0$ 的组是依从者和从不接受者的混合体。这些组不具有直接可比性。该估计量对于 LATE 是有偏的。\n-   **结论：不正确。**\n\n**C. 差值 $\\mathbb{E}[Y \\mid Z=1] - \\mathbb{E}[Y \\mid Z=0]$ 识别了 $\\mathbb{E}\\!\\left[ Y(1)-Y(0) \\mid D(1)>D(0) \\right]$。**\n-   这是意向治疗 (ITT) 效应。如我们在分子推导中所示，$\\mathbb{E}[Y \\mid Z=1] - \\mathbb{E}[Y \\mid Z=0] = LATE \\cdot \\pi_{CO}$。这仅在 $\\pi_{CO}=1$ 时，即整个总体都由依从者组成（完全依从）时才等于 LATE。这在一般情况下是不成立的。\n-   **结论：不正确。**\n\n**D. 比率 $\\dfrac{\\mathbb{E}[Y \\mid Z=1] - \\mathbb{E}[Y \\mid Z=0]}{\\mathbb{E}[D \\mid Z=1] - \\mathbb{E}[D \\mid Z=0]}$ 识别了 $\\mathbb{E}\\!\\left[ Y(1)-Y(0) \\mid D(1)=1, D(0)=1 \\right]$。**\n-   该比率识别了 LATE，即依从者的平均处理效应，即 $\\mathbb{E}\\!\\left[ Y(1)-Y(0) \\mid D(1)=1, D(0)=0 \\right]$。右边的表达式是始终接受者的平均处理效应。IV 估计量不能识别始终接受者的效应。\n-   **结论：不正确。**\n\n**E. 仅在单调性假设下，无排他性限制，差值 $\\mathbb{E}[Y \\mid Z=1] - \\mathbb{E}[Y \\mid Z=0]$ 等于 $\\mathbb{E}\\!\\left[ Y(1)-Y(0) \\mid D(1)>D(0) \\right]$。**\n-   这个陈述不正确，原因有二。首先，如选项 C 的分析所示，ITT 差值等于 $LATE \\cdot \\pi_{CO}$，而不是 LATE。其次，排他性限制是这个结果的必要条件。没有它，ITT 效应将是 LATE 与工具变量 $Z$ 对始终接受者和从不接受者结果的直接效应的混合，这些效应不会相互抵消。\n-   **结论：不正确。**",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "在数据分析中，一个常见的诱惑是通过调整所有可用的协变量来减少偏差，但当协变量是在处理后测量时，这种做法可能会适得其反。本练习展示了“对撞因子分层偏倚”（collider-stratification bias）这一关键概念，即对一个同时受处理和一个未观测因素影响的变量进行条件化，会引入虚假的关联。通过一个正式的结构模型，你将推导出因天真地调整一个治疗后生物标志物而产生的偏倚，这是在实践中正确应用因果原则的重要一课。",
            "id": "4987084",
            "problem": "一项在重症监护医学中进行的随机试验评估了一种新的抗炎疗法对第$7$天C反应蛋白的影响。设 $A \\in \\{0,1\\}$ 表示治疗分配，其中 $A=1$ 表示接受该疗法。随机化是平衡的，因此 $\\Pr(A=1)=\\Pr(A=0)=0.5$。设 $M$ 为随机化后24小时测量的早期治疗后生物标志物，设 $Y$ 为第$7$天的对数C反应蛋白结局。考虑潜在结局框架，其中 $Y^{a}$ 表示在治疗水平 $a \\in \\{0,1\\}$ 下将观察到的结局，而 $M^{a}$ 表示在 $a$ 下的治疗后生物标志物。假设稳定单位处理价值假设 (SUTVA) 成立，并且随机化意味着 $A$ 对潜在结局没有未测量的混杂影响。\n\n假设数据生成机制与以下具有独立分量的线性结构模型一致：\n- 一个未测量的患者脆弱性 $U$，满足 $U \\sim \\mathcal{N}(0,1)$。\n- 一个治疗后生物标志物方程 $M = \\alpha A + \\beta U + \\varepsilon_{M}$，其中 $\\varepsilon_{M} \\sim \\mathcal{N}(0,\\sigma_{M}^{2})$ 且独立于 $(A,U)$。\n- 一个结局方程 $Y = \\tau A + \\theta M + \\delta U + \\varepsilon_{Y}$，其中 $\\varepsilon_{Y} \\sim \\mathcal{N}(0,\\sigma_{Y}^{2})$ 且独立于 $(A,U,\\varepsilon_{M})$。\n\n该模型所蕴含的有向无环图 (DAG) 具有箭头 $A \\to M \\to Y$、$A \\to Y$ 以及 $U \\to M$、$U \\to Y$。因为 $M$ 同时受到 $A$ 和 $U$ 的影响，所以 $M$ 是路径 $A \\to M \\leftarrow U \\to Y$ 上的一个对撞因子。\n\n一种常见但有缺陷的分析实践是将 $Y$ 对 $A$ 和 $M$ 进行回归，并将 $A$ 的系数解释为治疗的因果效应。设 $\\beta_{A}$ 表示在线性回归模型 $\\mathbb{E}[Y \\mid A, M] = \\beta_{0} + \\beta_{A} A + \\beta_{M} M$ 中，对由上述模型生成的数据进行拟合时，$A$ 的普通最小二乘法 (OLS) 系数的概率极限（大样本极限）。\n\n从反事实定义和结构模型出发，以 $(\\alpha, \\beta, \\tau, \\theta, \\delta, \\sigma_{M}^{2})$ 的函数形式推导出 $\\beta_{A}$ 的封闭形式。您的最终答案必须是单一的封闭形式解析表达式。无需四舍五入，也无需单位。",
            "solution": "首先验证问题以确保其自洽、一致且科学合理。\n\n### 步骤1：提取已知条件\n- 治疗分配：$A \\in \\{0,1\\}$，随机化满足 $\\Pr(A=1)=\\Pr(A=0)=0.5$。\n- 未测量的患者脆弱性：$U \\sim \\mathcal{N}(0,1)$。\n- 治疗后生物标志物：$M = \\alpha A + \\beta U + \\varepsilon_{M}$，其中 $\\varepsilon_{M} \\sim \\mathcal{N}(0,\\sigma_{M}^{2})$ 且独立于 $(A,U)$。\n- 结局：$Y = \\tau A + \\theta M + \\delta U + \\varepsilon_{Y}$，其中 $\\varepsilon_{Y} \\sim \\mathcal{N}(0,\\sigma_{Y}^{2})$ 且独立于 $(A,U,\\varepsilon_{M})$。\n- 假设：稳定单位处理价值假设 (SUTVA) 成立。随机化意味着 $A$ 独立于 $U$ 和所有潜在结局（及其误差项）。\n- 目标量：线性回归模型 $\\mathbb{E}[Y \\mid A, M] = \\beta_{0} + \\beta_{A} A + \\beta_{M} M$ 中 $A$ 的普通最小二乘法 (OLS) 系数的概率极限 $\\beta_A$。\n\n### 步骤2：使用提取的已知条件进行验证\n- **科学依据：** 该问题是因果推断中的一个标准理论练习，使用线性结构模型和潜在结局来说明对撞分层偏倚。这是统计学、计量经济学和流行病学的核心课题。其设置在科学上和数学上都是合理的。\n- **适定性：** 该问题提供了推导目标量 $\\beta_A$ 所需的所有必要定义、结构方程和分布假设。可以确定一个唯一的解析解。\n- **客观性：** 该问题以精确的数学和统计语言陈述，没有歧义或主观论断。\n\n该问题没有表现出任何列出的无效性缺陷。所描述的 DAG 结构与结构方程一致。问题要求在一个程式化但连贯的模型下，推导一个明确定义的统计量。\n\n### 步骤3：结论与行动\n问题有效。将提供一个完整、合理的解答。\n\n### 解答推导\n目标量 $\\beta_A$ 是在 $Y$ 对 $A$ 和 $M$ 的多元线性回归中，$A$ 的系数的 OLS 估计量的概率极限。在具有两个预测变量的回归中，该系数的公式由 OLS 估计量的总体模拟给出：\n$$ \\beta_{A} = \\frac{\\text{Cov}(A, Y) \\text{Var}(M) - \\text{Cov}(M, Y) \\text{Cov}(A, M)}{\\text{Var}(A) \\text{Var}(M) - (\\text{Cov}(A, M))^2} $$\n我们必须使用给定的结构模型和随机变量的属性来计算每个方差和协方差项。\n\n1.  **治疗分配变量 $A$ 的属性：**\n    由于 $A$ 是一个伯努利随机变量，且 $\\Pr(A=1)=0.5$：\n    -   $\\mathbb{E}[A] = 1 \\cdot \\Pr(A=1) + 0 \\cdot \\Pr(A=0) = 0.5$。\n    -   $\\text{Var}(A) = \\mathbb{E}[A^2] - (\\mathbb{E}[A])^2 = (1^2 \\cdot 0.5 + 0^2 \\cdot 0.5) - (0.5)^2 = 0.5 - 0.25 = 0.25$。\n\n2.  **用外生变量表示 $Y$：**\n    为简化协方差计算，我们将 $M$ 的表达式代入 $Y$ 的方程中：\n    $$ Y = \\tau A + \\theta (\\alpha A + \\beta U + \\varepsilon_{M}) + \\delta U + \\varepsilon_{Y} $$\n    $$ Y = (\\tau + \\theta\\alpha) A + (\\theta\\beta + \\delta) U + \\theta\\varepsilon_{M} + \\varepsilon_{Y} $$\n\n3.  **计算协方差和方差：**\n    我们使用 $A$、$U$、$\\varepsilon_{M}$ 和 $\\varepsilon_{Y}$ 相互独立的性质。我们也知道 $\\mathbb{E}[U]=0$、$\\mathbb{E}[\\varepsilon_M]=0$、$\\mathbb{E}[\\varepsilon_Y]=0$、$\\text{Var}(U)=1$、$\\text{Var}(\\varepsilon_M)=\\sigma_M^2$ 和 $\\text{Var}(\\varepsilon_Y)=\\sigma_Y^2$。\n\n    -   **$\\text{Cov}(A, M)$**：\n        $$ \\text{Cov}(A, M) = \\text{Cov}(A, \\alpha A + \\beta U + \\varepsilon_{M}) = \\alpha \\text{Cov}(A, A) + \\beta \\text{Cov}(A, U) + \\text{Cov}(A, \\varepsilon_{M}) $$\n        由于 $A$ 独立于 $U$ 和 $\\varepsilon_M$，所以 $\\text{Cov}(A, U)=0$ 且 $\\text{Cov}(A, \\varepsilon_M)=0$。\n        $$ \\text{Cov}(A, M) = \\alpha \\text{Var}(A) = 0.25\\alpha $$\n\n    -   **$\\text{Var}(M)$**：\n        $$ \\text{Var}(M) = \\text{Var}(\\alpha A + \\beta U + \\varepsilon_{M}) $$\n        由于 $A$、$U$ 和 $\\varepsilon_M$ 的独立性：\n        $$ \\text{Var}(M) = \\alpha^2 \\text{Var}(A) + \\beta^2 \\text{Var}(U) + \\text{Var}(\\varepsilon_{M}) = 0.25\\alpha^2 + \\beta^2 \\cdot 1 + \\sigma_{M}^{2} $$\n        $$ \\text{Var}(M) = 0.25\\alpha^2 + \\beta^2 + \\sigma_{M}^{2} $$\n\n    -   **$\\text{Cov}(A, Y)$**：\n        使用 $Y$ 的展开形式：\n        $$ \\text{Cov}(A, Y) = \\text{Cov}(A, (\\tau + \\theta\\alpha) A + (\\theta\\beta + \\delta) U + \\theta\\varepsilon_{M} + \\varepsilon_{Y}) $$\n        由于 $A$ 独立于 $U, \\varepsilon_M, \\varepsilon_Y$：\n        $$ \\text{Cov}(A, Y) = (\\tau + \\theta\\alpha) \\text{Var}(A) = 0.25(\\tau + \\theta\\alpha) $$\n\n    -   **$\\text{Cov}(M, Y)$**：\n        使用 $M$ 的定义和 $Y$ 的展开形式：\n        $$ \\text{Cov}(M, Y) = \\text{Cov}(\\alpha A + \\beta U + \\varepsilon_{M}, (\\tau + \\theta\\alpha) A + (\\theta\\beta + \\delta) U + \\theta\\varepsilon_{M} + \\varepsilon_{Y}) $$\n        利用协方差的双线性和 $A, U, \\varepsilon_M, \\varepsilon_Y$ 的相互独立性进行展开：\n        $$ \\text{Cov}(M, Y) = \\text{Cov}(\\alpha A, (\\tau + \\theta\\alpha) A) + \\text{Cov}(\\beta U, (\\theta\\beta + \\delta) U) + \\text{Cov}(\\varepsilon_{M}, \\theta\\varepsilon_{M}) $$\n        所有交叉项的协方差均为零。\n        $$ \\text{Cov}(M, Y) = \\alpha(\\tau + \\theta\\alpha)\\text{Var}(A) + \\beta(\\theta\\beta + \\delta)\\text{Var}(U) + \\theta\\text{Var}(\\varepsilon_{M}) $$\n        $$ \\text{Cov}(M, Y) = \\alpha(\\tau + \\theta\\alpha)(0.25) + \\beta(\\theta\\beta + \\delta)(1) + \\theta\\sigma_{M}^{2} $$\n        $$ \\text{Cov}(M, Y) = 0.25\\alpha\\tau + 0.25\\theta\\alpha^2 + \\theta\\beta^2 + \\beta\\delta + \\theta\\sigma_{M}^{2} $$\n\n4.  **组合 $\\beta_A$ 的表达式：**\n    首先，我们计算 $\\beta_A$ 主公式的分母：\n    $$ D = \\text{Var}(A) \\text{Var}(M) - (\\text{Cov}(A, M))^2 $$\n    $$ D = (0.25)(0.25\\alpha^2 + \\beta^2 + \\sigma_{M}^{2}) - (0.25\\alpha)^2 $$\n    $$ D = 0.0625\\alpha^2 + 0.25\\beta^2 + 0.25\\sigma_{M}^{2} - 0.0625\\alpha^2 $$\n    $$ D = 0.25(\\beta^2 + \\sigma_{M}^{2}) $$\n\n    接下来，我们计算分子：\n    $$ N = \\text{Cov}(A, Y) \\text{Var}(M) - \\text{Cov}(M, Y) \\text{Cov}(A, M) $$\n    $$ N = [0.25(\\tau + \\theta\\alpha)][0.25\\alpha^2 + \\beta^2 + \\sigma_{M}^{2}] - [0.25\\alpha\\tau + 0.25\\theta\\alpha^2 + \\theta\\beta^2 + \\beta\\delta + \\theta\\sigma_{M}^{2}][0.25\\alpha] $$\n    我们可以从整个表达式中提取因子 $0.25$：\n    $$ N = 0.25 \\left( (\\tau + \\theta\\alpha)(0.25\\alpha^2 + \\beta^2 + \\sigma_{M}^{2}) - \\alpha(0.25\\alpha\\tau + 0.25\\theta\\alpha^2 + \\theta\\beta^2 + \\beta\\delta + \\theta\\sigma_{M}^{2}) \\right) $$\n    展开括号内的项：\n    $$ (\\tau + \\theta\\alpha)(\\dots) = 0.25\\alpha^2\\tau + \\beta^2\\tau + \\sigma_M^2\\tau + 0.25\\alpha^3\\theta + \\alpha\\beta^2\\theta + \\alpha\\sigma_M^2\\theta $$\n    $$ -\\alpha(\\dots) = -0.25\\alpha^2\\tau - 0.25\\alpha^3\\theta - \\alpha\\beta^2\\theta - \\alpha\\beta\\delta - \\alpha\\sigma_M^2\\theta $$\n    将这两个展开式相加，有几项会相互抵消：\n    - $0.25\\alpha^2\\tau$ 与 $-0.25\\alpha^2\\tau$ 抵消。\n    - $0.25\\alpha^3\\theta$ 与 $-0.25\\alpha^3\\theta$ 抵消。\n    - $\\alpha\\beta^2\\theta$ 与 $-\\alpha\\beta^2\\theta$ 抵消。\n    - $\\alpha\\sigma_M^2\\theta$ 与 $-\\alpha\\sigma_M^2\\theta$ 抵消。\n    剩下的项是 $\\beta^2\\tau + \\sigma_M^2\\tau - \\alpha\\beta\\delta = \\tau(\\beta^2 + \\sigma_M^2) - \\alpha\\beta\\delta$。\n    所以，分子是：\n    $$ N = 0.25(\\tau(\\beta^2 + \\sigma_{M}^{2}) - \\alpha\\beta\\delta) $$\n\n    最后，我们计算比率 $\\beta_A = N/D$：\n    $$ \\beta_A = \\frac{0.25(\\tau(\\beta^2 + \\sigma_{M}^{2}) - \\alpha\\beta\\delta)}{0.25(\\beta^2 + \\sigma_{M}^{2})} $$\n    $$ \\beta_A = \\frac{\\tau(\\beta^2 + \\sigma_{M}^{2}) - \\alpha\\beta\\delta}{\\beta^2 + \\sigma_{M}^{2}} $$\n    这可以简化为：\n    $$ \\beta_A = \\tau - \\frac{\\alpha\\beta\\delta}{\\beta^2 + \\sigma_{M}^{2}} $$\n    这个表达式揭示了 OLS 系数 $\\beta_A$ 是 $A$ 对 $Y$ 的直接因果效应 ($\\tau$) 和一个偏倚项的和。这个偏倚项 $-\\frac{\\alpha\\beta\\delta}{\\beta^2 + \\sigma_{M}^{2}}$ 的产生，是因为在回归中对生物标志物 $M$ 进行条件化，通过未测量的混杂因素 $U$ 打开了治疗 $A$ 和结局 $Y$ 之间的一条伪路径。这种现象被称为对撞分层偏倚。",
            "answer": "$$\\boxed{\\tau - \\frac{\\alpha\\beta\\delta}{\\beta^2 + \\sigma_{M}^{2}}}$$"
        },
        {
            "introduction": "医疗决策通常涉及根据患者不断变化的健康状况而调整的一系列治疗，这一概念被形式化为“动态治疗方案”（dynamic treatment regimes, DTRs）。这个高级实践超越了单时间点干预，旨在估计这些纵向策略的因果效应。你将实施 G-computation 公式这一强大的标准化方法，来计算不同自适应方案下的期望结果，从而为开发个体化医疗方案的关键工具提供动手实践经验。",
            "id": "4987080",
            "problem": "在医学统计建模的反事实（潜在结果）框架下，考虑一个两阶段动态治疗方案问题。存在两个决策时间点，由 $t \\in \\{1,2\\}$ 索引，每个时间点都有二元协变量和治疗。具体而言，令 $L_1 \\in \\{0,1\\}$ 表示基线二元协变量，$A_1 \\in \\{0,1\\}$ 表示第一次治疗，$L_2 \\in \\{0,1\\}$ 表示在 $A_1$ 之后观察到的中间二元协变量，$A_2 \\in \\{0,1\\}$ 表示第二次治疗，以及 $Y \\in \\mathbb{R}$ 表示在随访结束时测量的连续结果。一个动态治疗方案是一对决策规则 $d = (d_1, d_2)$，其中 $d_1$ 将基线协变量映射到第一阶段的行动，$d_2$ 将观察到的历史映射到第二阶段的行动。目标是计算在多种方案和参数集下的反事实平均结果 $E[Y^d]$。\n\n假设以下核心定义和可识别性假设为基本基础：\n- 一致性：如果观察到的治疗序列与方案 $d$ 匹配，则 $Y = Y^d$。\n- 序列可交换性（每个时间点无未测量的混杂因素）：$(Y^{a_1,a_2}, L_2^{a_1}) \\perp\\!\\!\\!\\perp A_1 \\mid L_1$ 且 $Y^{a_1,a_2} \\perp\\!\\!\\!\\perp A_2 \\mid L_1, A_1, L_2$。\n- 正定性：对于任何具有正概率的历史，每个时间点治疗分配的条件概率严格介于 0 和 1 之间。\n- 迭代期望定律和标准概率法则。\n\n数据生成模型如下。基线协变量遵循伯努利分布，其中 $P(L_1 = 1) = p$。中间协变量在给定 $L_1$ 和 $A_1$ 的条件下，具有一个逻辑斯谛模型：\n$$\nP(L_2 = 1 \\mid L_1 = \\ell_1, A_1 = a_1) = \\operatorname{expit}\\left(\\alpha_0 + \\alpha_1 \\ell_1 + \\alpha_2 a_1 + \\alpha_3 \\ell_1 a_1\\right),\n$$\n其中 $\\operatorname{expit}(x) = \\frac{1}{1 + e^{-x}}$。结果的条件均值在主效应和交互作用上是线性的：\n$$\nE[Y \\mid L_1 = \\ell_1, A_1 = a_1, L_2 = \\ell_2, A_2 = a_2] = \\beta_0 + \\beta_1 \\ell_1 + \\beta_2 a_1 + \\beta_3 \\ell_2 + \\beta_4 a_2 + \\beta_5 a_1 \\ell_2 + \\beta_6 \\ell_1 a_2,\n$$\n且 $\\operatorname{Var}(Y \\mid L_1, A_1, L_2, A_2)$ 是有限的，并且不影响均值。\n\n待评估的动态方案如下：\n- 方案 $d^{(1)}$: $d^{(1)}_1(\\ell_1) = \\mathbb{1}\\{\\ell_1 = 1\\}$ 且 $d^{(1)}_2(\\ell_1,\\ell_2,a_1) = \\mathbb{1}\\{\\ell_2 = 1\\}$。\n- 方案 $d^{(2)}$: $d^{(2)}_1(\\ell_1) = 1$ 且 $d^{(2)}_2(\\ell_1,\\ell_2,a_1) = 1$。\n- 方案 $d^{(3)}$: $d^{(3)}_1(\\ell_1) = 0$ 且 $d^{(3)}_2(\\ell_1,\\ell_2,a_1) = 0$。\n\n你的任务是，仅使用基本概率定律和上面列出的可识别性假设，在给定的假设和模型下推导出 $E[Y^d]$ 的可计算表达式。然后实现一个程序，为以下参数集（测试套件）中的每个方案计算 $E[Y^d]$：\n\n- 测试用例 1：$p = 0.4$；$(\\alpha_0,\\alpha_1,\\alpha_2,\\alpha_3) = (-0.3, 0.8, 0.5, -0.2)$；$(\\beta_0,\\beta_1,\\beta_2,\\beta_3,\\beta_4,\\beta_5,\\beta_6) = (2.0, 0.7, 0.6, 1.1, 1.5, -0.4, 0.3)$。\n- 测试用例 2：$p = 0.5$；$(\\alpha_0,\\alpha_1,\\alpha_2,\\alpha_3) = (0.0, 0.0, 0.0, 0.0)$；$(\\beta_0,\\beta_1,\\beta_2,\\beta_3,\\beta_4,\\beta_5,\\beta_6) = (0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0)$。\n- 测试用例 3：$p = 0.9$；$(\\alpha_0,\\alpha_1,\\alpha_2,\\alpha_3) = (2.0, -3.0, -3.0, 2.0)$；$(\\beta_0,\\beta_1,\\beta_2,\\beta_3,\\beta_4,\\beta_5,\\beta_6) = (1.0, -0.5, 0.2, 0.8, 0.9, 0.1, -0.2)$。\n\n对计算输出的要求：\n- 对于每个测试用例，计算一个包含三个浮点值的列表，按顺序分别对应于 $E[Y^{d^{(1)}}]$、$E[Y^{d^{(2)}}]$ 和 $E[Y^{d^{(3)}}]$。\n- 将每个值四舍五入到 $6$ 位小数。\n- 你的程序应生成单行输出，其中包含用方括号括起来的、逗号分隔的列表的列表形式的结果，例如 $[ [x_{11},x_{12},x_{13}], [x_{21},x_{22},x_{23}], [x_{31},x_{32},x_{33}] ]$，其中 $x_{ij}$ 是测试用例 $i$ 和方案 $j$ 的值。\n\n不需要外部输入；程序必须在内部编码指定的测试套件并生成单行输出。不涉及物理单位。所有概率必须表示为 $[0,1]$ 区间内的实数，所有输出都必须是四舍五入到 $6$ 位小数的实数。",
            "solution": "### 步骤 1：提取已知信息\n\n问题提供了以下数据、定义和模型：\n- **决策时间点**：$t \\in \\{1,2\\}$。\n- **基线协变量**：$L_1 \\in \\{0,1\\}$，一个二元变量。\n- **第一次治疗**：$A_1 \\in \\{0,1\\}$，一个二元变量。\n- **中间协变量**：$L_2 \\in \\{0,1\\}$，一个在 $A_1$ 之后观察到的二元变量。\n- **第二次治疗**：$A_2 \\in \\{0,1\\}$，一个二元变量。\n- **结果**：$Y \\in \\mathbb{R}$，一个连续变量。\n- **动态治疗方案**：一对决策规则 $d = (d_1, d_2)$。\n- **反事实假设**：\n    - 一致性：如果观察到的治疗与方案 $d$ 匹配，则 $Y = Y^d$。\n    - 序列可交换性：$(Y^{a_1,a_2}, L_2^{a_1}) \\perp\\!\\!\\!\\perp A_1 \\mid L_1$ 且 $Y^{a_1,a_2} \\perp\\!\\!\\!\\perp A_2 \\mid L_1, A_1, L_2$。\n    - 正定性：治疗的条件概率严格介于 0 和 1 之间。\n- **数据生成模型**：\n    - 基线协变量分布：$P(L_1 = 1) = p$。\n    - 中间协变量模型：$P(L_2 = 1 \\mid L_1 = \\ell_1, A_1 = a_1) = \\operatorname{expit}\\left(\\alpha_0 + \\alpha_1 \\ell_1 + \\alpha_2 a_1 + \\alpha_3 \\ell_1 a_1\\right)$，其中 $\\operatorname{expit}(x) = \\frac{1}{1 + e^{-x}}$。\n    - 结果模型：$E[Y \\mid L_1 = \\ell_1, A_1 = a_1, L_2 = \\ell_2, A_2 = a_2] = \\beta_0 + \\beta_1 \\ell_1 + \\beta_2 a_1 + \\beta_3 \\ell_2 + \\beta_4 a_2 + \\beta_5 a_1 \\ell_2 + \\beta_6 \\ell_1 a_2$。\n- **待评估的动态治疗方案**：\n    - 方案 $d^{(1)}$: $d^{(1)}_1(\\ell_1) = \\mathbb{1}\\{\\ell_1 = 1\\}$ 且 $d^{(1)}_2(\\ell_1,\\ell_2,a_1) = \\mathbb{1}\\{\\ell_2 = 1\\}$。\n    - 方案 $d^{(2)}$: $d^{(2)}_1(\\ell_1) = 1$ 且 $d^{(2)}_2(\\ell_1,\\ell_2,a_1) = 1$。\n    - 方案 $d^{(3)}$: $d^{(3)}_1(\\ell_1) = 0$ 且 $d^{(3)}_2(\\ell_1,\\ell_2,a_1) = 0$。\n- **测试用例（参数集）**：\n    - 用例 1: $p = 0.4$；$(\\alpha_0,\\alpha_1,\\alpha_2,\\alpha_3) = (-0.3, 0.8, 0.5, -0.2)$；$(\\beta_0,\\beta_1,\\beta_2,\\beta_3,\\beta_4,\\beta_5,\\beta_6) = (2.0, 0.7, 0.6, 1.1, 1.5, -0.4, 0.3)$。\n    - 用例 2: $p = 0.5$；$(\\alpha_0,\\alpha_1,\\alpha_2,\\alpha_3) = (0.0, 0.0, 0.0, 0.0)$；$(\\beta_0,\\beta_1,\\beta_2,\\beta_3,\\beta_4,\\beta_5,\\beta_6) = (0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0)$。\n    - 用例 3: $p = 0.9$；$(\\alpha_0,\\alpha_1,\\alpha_2,\\alpha_3) = (2.0, -3.0, -3.0, 2.0)$；$(\\beta_0,\\beta_1,\\beta_2,\\beta_3,\\beta_4,\\beta_5,\\beta_6) = (1.0, -0.5, 0.2, 0.8, 0.9, 0.1, -0.2)$。\n\n### 步骤 2：使用提取的已知信息进行验证\n\n该问题是应用因果推断原理的一个定义明确的练习。\n- **科学依据（关键）**：该问题在根本上是合理的。它使用了潜在结果框架，这是现代因果推断的基石。一致性、序列可交换性和正定性的假设是从观测数据中识别因果效应的标准要求。在统计建模中，使用逻辑斯谛模型和线性模型是常见做法。该问题没有违反任何科学或数学原理。\n- **良构性**：该问题是良构的。它要求在完全指定的参数化模型和假设下，计算一个特定量，即反事实平均结果 $E[Y^d]$。给定指定的输入，存在一个唯一、稳定且有意义的解，并且可以通过解析或计算方式推导出来。\n- **客观性（关键）**：问题以精确、客观和数学化的语言陈述。没有主观或基于意见的陈述。所有术语都在统计建模的背景下进行了正式定义。\n- **完整性和一致性**：问题是自洽的。它提供了计算所需的所有必要模型、参数和定义。没有缺失数据、未定义术语或矛盾的约束。\n\n### 步骤 3：结论与行动\n\n问题陈述是有效的。它是在动态治疗方案背景下，对因果推断的G-计算公式进行的一次标准而严谨的应用。我将继续进行求解。\n\n### 可计算表达式的推导\n\n目标是计算动态治疗方案 $d=(d_1, d_2)$ 的反事实平均结果 $E[Y^d]$。在所述的一致性、序列可交换性和正定性假设下，可以使用G-计算公式从观测数据分布中识别出反事实均值。该公式通过对协变量的分布进行标准化来表示 $E[Y^d]$。\n\n根据全期望定律，我们可以通过首先以基线历史 $L_1$ 为条件来写出 $E[Y^d]$：\n$$ E[Y^d] = E_{L_1}\\left[ E[Y^d \\mid L_1] \\right] = \\sum_{\\ell_1 \\in \\{0,1\\}} E[Y^d \\mid L_1 = \\ell_1] P(L_1 = \\ell_1) $$\n接下来，我们通过以中间协变量 $L_2$ 为条件来展开内部期望。对于一个固定的 $L_1=\\ell_1$，方案 $d$ 指定了第一次治疗，$A_1 = d_1(\\ell_1)$。然后，我们对该治疗下 $L_2$ 的潜在结果进行平均。\n$$ E[Y^d \\mid L_1 = \\ell_1] = E_{L_2^{A_1=d_1(\\ell_1)} \\mid L_1=\\ell_1} \\left[ E[Y^{A_1=d_1(\\ell_1), A_2=d_2(\\ldots)} \\mid L_1=\\ell_1, L_2^{A_1=d_1(\\ell_1)}] \\right] $$\n应用序列可交换性和一致性假设，使我们能够将反事实量替换为其观测类似物。\n$P(L_2^{a_1}=\\ell_2 \\mid L_1=\\ell_1) = P(L_2=\\ell_2 \\mid L_1=\\ell_1, A_1=a_1)$。\n$E[Y^{a_1, a_2} \\mid L_1=\\ell_1, L_2=\\ell_2] = E[Y \\mid L_1=\\ell_1, A_1=a_1, L_2=\\ell_2, A_2=a_2]$。\n\n让我们固定历史 $(\\ell_1, \\ell_2)$。方案 $d$ 决定了治疗序列：$a_1 = d_1(\\ell_1)$ 和 $a_2 = d_2(\\ell_1, \\ell_2, a_1)$。\n将这些代入完整表达式，我们得到这个两阶段问题的G-计算公式：\n$$ E[Y^d] = \\sum_{\\ell_1 \\in \\{0,1\\}} \\left( \\sum_{\\ell_2 \\in \\{0,1\\}} E[Y \\mid L_1=\\ell_1, A_1=d_1(\\ell_1), L_2=\\ell_2, A_2=d_2(\\ell_1, \\ell_2, d_1(\\ell_1))] \\times P(L_2=\\ell_2 \\mid L_1=\\ell_1, A_1=d_1(\\ell_1)) \\right) \\times P(L_1=\\ell_1) $$\n使用所提供的模型，这个表达式是完全可计算的。\n\n### 计算算法\n\n上述公式可以直接转化为一个数值算法。对于给定的方案 $d=(d_1, d_2)$ 和一组参数 $(p, \\boldsymbol{\\alpha}, \\boldsymbol{\\beta})$，我们如下计算 $E[Y^d]$：\n\n1. 初始化总期望，$E_{\\text{total}} = 0$。\n2. 遍历基线协变量的可能值，$\\ell_1 \\in \\{0,1\\}$。\n    a. 确定该值的概率：当 $\\ell_1=0$ 时为 $(1-p)$，当 $\\ell_1=1$ 时为 $p$。\n    b. 根据方案确定第一阶段治疗：$a_1 = d_1(\\ell_1)$。\n    c. 为此 $L_1$ 层初始化一个内部期望，$E_{\\text{inner}} = 0$。\n    d. 遍历中间协变量的可能值，$\\ell_2 \\in \\{0,1\\}$。\n        i. 使用逻辑斯谛模型计算条件概率 $P(L_2=1 \\mid L_1=\\ell_1, A_1=a_1)$：\n           $P(L_2=1|\\ldots) = \\operatorname{expit}(\\alpha_0 + \\alpha_1 \\ell_1 + \\alpha_2 a_1 + \\alpha_3 \\ell_1 a_1)$。\n           $P(L_2=\\ell_2|\\ldots)$ 对于 $\\ell_2=1$ 是该值，对于 $\\ell_2=0$ 是 1 减去该值。\n        ii. 确定第二阶段治疗：$a_2 = d_2(\\ell_1, \\ell_2, a_1)$。\n        iii. 使用线性模型计算条件平均结果 $E[Y \\mid L_1=\\ell_1, A_1=a_1, L_2=\\ell_2, A_2=a_2]$：\n           $E[Y|\\ldots] = \\beta_0 + \\beta_1 \\ell_1 + \\beta_2 a_1 + \\beta_3 \\ell_2 + \\beta_4 a_2 + \\beta_5 a_1 \\ell_2 + \\beta_6 \\ell_1 a_2$。\n        iv. 将条件平均结果与 $L_2$ 的条件概率的乘积加到内部期望中：$E_{\\text{inner}} = E_{\\text{inner}} + E[Y|\\ldots] \\times P(L_2=\\ell_2|\\ldots)$。\n    e. 将内部期望与 $L_1$ 的概率的乘积加到总期望中：$E_{\\text{total}} = E_{\\text{total}} + E_{\\text{inner}} \\times P(L_1=\\ell_1)$。\n3. 最终结果是 $E_{\\text{total}}$。\n\n该算法将被实现并应用于三个指定的方案和三个测试用例。结果将按要求四舍五入到 $6$ 位小数。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import expit\n\ndef solve():\n    \"\"\"\n    Main function to solve the dynamic treatment regime problem.\n    It iterates through specified test cases and regimes, calculates the \n    counterfactual mean outcome for each, and prints the formatted results.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            'p': 0.4,\n            'alphas': (-0.3, 0.8, 0.5, -0.2),\n            'betas': (2.0, 0.7, 0.6, 1.1, 1.5, -0.4, 0.3)\n        },\n        {\n            'p': 0.5,\n            'alphas': (0.0, 0.0, 0.0, 0.0),\n            'betas': (0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0)\n        },\n        {\n            'p': 0.9,\n            'alphas': (2.0, -3.0, -3.0, 2.0),\n            'betas': (1.0, -0.5, 0.2, 0.8, 0.9, 0.1, -0.2)\n        }\n    ]\n\n    # Define the three dynamic treatment regimes as pairs of decision functions.\n    # Regime 1: d1(l1) = I(l1=1), d2(...,l2,...) = I(l2=1)\n    d1_1 = lambda l1: 1 if l1 == 1 else 0\n    d2_1 = lambda l1, l2, a1: 1 if l2 == 1 else 0\n\n    # Regime 2: d1(l1) = 1, d2(...) = 1\n    d1_2 = lambda l1: 1\n    d2_2 = lambda l1, l2, a1: 1\n\n    # Regime 3: d1(l1) = 0, d2(...) = 0\n    d1_3 = lambda l1: 0\n    d2_3 = lambda l1, l2, a1: 0\n\n    regimes = [\n        (d1_1, d2_1),\n        (d1_2, d2_2),\n        (d1_3, d2_3)\n    ]\n\n    all_results = []\n    for case in test_cases:\n        p = case['p']\n        alphas = case['alphas']\n        betas = case['betas']\n        \n        case_results = []\n        for d1, d2 in regimes:\n            # Calculate the counterfactual mean outcome for the current case and regime.\n            value = calculate_expectation(p, alphas, betas, d1, d2)\n            case_results.append(round(value, 6))\n        \n        all_results.append(case_results)\n\n    # Format the final output string as a list of lists.\n    outer_list_str_parts = []\n    for inner_list in all_results:\n        inner_list_str = f\"[{','.join(map(str, inner_list))}]\"\n        outer_list_str_parts.append(inner_list_str)\n    \n    final_output_str = f\"[{','.join(outer_list_str_parts)}]\"\n    \n    print(final_output_str)\n\ndef calculate_expectation(p, alphas, betas, d1, d2):\n    \"\"\"\n    Calculates the counterfactual mean outcome E[Y^d] using the G-computation formula.\n\n    Args:\n        p (float): Probability P(L1 = 1).\n        alphas (tuple): Parameters for the L2 model.\n        betas (tuple): Parameters for the Y model.\n        d1 (function): Decision rule for the first stage.\n        d2 (function): Decision rule for the second stage.\n\n    Returns:\n        float: The computed value of E[Y^d].\n    \"\"\"\n    total_expected_y = 0.0\n    \n    # Unpack alpha and beta parameters for clarity\n    a0, a1_p, a2_p, a3_p = alphas\n    b0, b1_p, b2_p, b3_p, b4_p, b5_p, b6_p = betas\n\n    # Sum over the distribution of L1\n    for l1 in [0, 1]:\n        prob_l1 = (1 - p) if l1 == 0 else p\n        \n        # Determine treatment A1 based on regime d1\n        a1 = d1(l1)\n        \n        # This will hold E[ E[Y|L1,A1,L2,A2] | L1,A1 ], averaged over L2\n        inner_expectation_over_l2 = 0.0\n        \n        # Sum over the distribution of L2\n        for l2 in [0, 1]:\n            # Calculate P(L2=1 | L1=l1, A1=a1)\n            logit_p_l2 = a0 + a1_p * l1 + a2_p * a1 + a3_p * l1 * a1\n            prob_l2_is_1 = expit(logit_p_l2)\n            prob_l2 = prob_l2_is_1 if l2 == 1 else (1.0 - prob_l2_is_1)\n            \n            # Determine treatment A2 based on regime d2\n            a2 = d2(l1, l2, a1)\n            \n            # Calculate E[Y | L1, A1, L2, A2]\n            cond_exp_y = b0 + b1_p * l1 + b2_p * a1 + b3_p * l2 + b4_p * a2 + b5_p * a1 * l2 + b6_p * l1 * a2\n            \n            # Weight conditional expectation of Y by probability of L2\n            inner_expectation_over_l2 += cond_exp_y * prob_l2\n            \n        # Weight the inner expectation by the probability of L1\n        total_expected_y += inner_expectation_over_l2 * prob_l1\n        \n    return total_expected_y\n\n# Execute the main function.\nsolve()\n```"
        }
    ]
}