{
    "hands_on_practices": [
        {
            "introduction": "理论学习的最佳方式是从基本原理入手。本练习旨在通过推导和应用最基础的工具变量（IV）估计量——沃尔德（Wald）估计量，来揭示 IV 分析的核心逻辑。通过在一个简化的孟德尔随机化研究背景下，使用单个二元工具变量，您将从协方差的第一性原理出发，推导出因果效应的点估计公式，并利用给定的摘要数据进行计算。这项练习将帮助您深入理解 IV 估计量为何是两种效应的比值，为掌握更复杂的 IV 方法奠定坚实的理论与计算基础 ()。",
            "id": "4574229",
            "problem": "一项心血管流行病学领域的大规模孟德尔随机化研究，旨在探究一种连续性炎症生物标志物 $X$（C反应蛋白，单位为 mg/L）对一种连续性结局 $Y$（收缩压，单位为 mmHg）的因果效应。研究使用一个单核苷酸多态性作为工具变量（IV），并将其编码为一个二元工具变量 $Z \\in \\{0,1\\}$，表示效应等位基因的缺失（$Z=0$）或存在（$Z=1$）。假设存在一个线性结构因果模型，其中 $X$ 对 $Y$ 的平均因果效应是一个恒定的斜率参数 $ \\beta $，并且 $Z$ 可能影响 $X$ 但仅通过 $X$ 影响 $Y$。在超总体框架下进行分析，并假设所有相关的期望和方差均存在且为有限值。\n\n请仅使用工具变量相关性和外生性的核心定义，不借助任何预设的估计公式，推导出当 $Z$ 为二元变量时，基于 $Z$ 的、用于估计 $X$ 对 $Y$ 因果效应的恰好识别的IV估计量的总体比率形式。然后，使用下方的样本摘要数据，构建样本类比估计量并计算其数值。\n\n一个包含 $n = 100{,}000$ 名同源血统且无亲缘关系的个体的队列接受了基因分型。从数据中估计出以下亚组均值：\n- 在 $Z=1$ 的个体中：$X$ 的样本均值为 $\\bar{X}_{1} = 2.91$ mg/L，$Y$ 的样本均值为 $\\bar{Y}_{1} = 129.80$ mmHg。\n- 在 $Z=0$ 的个体中：$X$ 的样本均值为 $\\bar{X}_{0} = 2.28$ mg/L，$Y$ 的样本均值为 $\\bar{Y}_{0} = 127.43$ mmHg。\n\n使用上述样本均值，计算 $X$ 对 $Y$ 平均因果效应的基于工具变量的比率估计值，结果为标量。将答案四舍五入至四位有效数字。因果效应的单位以 mmHg/mg/L 表示。\n\n最后，请从工具变量的相关性、外生性、结构性假设和正则性条件等方面，清晰地阐述在所述的具有二元工具变量和连续性暴露的流行病学情境下，该估计量对因果效应参数具有一致性的最小化高阶条件。",
            "solution": "该问题要求推导二元工具变量的工具变量（IV）估计量，根据样本数据进行计算，并阐明其一致性的条件。背景是一项孟德尔随机化研究，其中遗传变异 $Z$ 被用作工具变量，以估计生物标志物 $X$ 对健康结局 $Y$ 的因果效应。\n\n首先，我们推导IV估计量的总体形式。设关联结局 $Y$ 与暴露 $X$ 的结构因果模型是线性的，具有一个恒定的因果效应参数 $\\beta$：\n$$\nY = \\alpha_Y + \\beta X + U\n$$\n其中 $U$ 代表 $Y$ 的所有其他原因，包括可能与 $X$ 相关的未测量混杂因素。目标是估计 $\\beta$。\n\n工具变量 $Z$ 必须满足两个核心条件：\n1.  **相关性**：$Z$ 必须与暴露 $X$ 相关。形式上，$\\text{Cov}(Z, X) \\neq 0$。\n2.  **外生性**：$Z$ 必须独立于任何未测量的 $X-Y$ 关系中的混杂因素。这通常可操作化为两个子条件：(a) $Z$ 仅通过 $X$ 影响 $Y$（排他性限制），以及 (b) $Z$ 独立于 $U$。这两个条件共同意味着 $\\text{Cov}(Z, U) = 0$。\n\n我们计算结构方程与工具变量 $Z$ 的协方差：\n$$\n\\text{Cov}(Y, Z) = \\text{Cov}(\\alpha_Y + \\beta X + U, Z)\n$$\n利用协方差的线性性质，这变为：\n$$\n\\text{Cov}(Y, Z) = \\text{Cov}(\\alpha_Y, Z) + \\beta \\text{Cov}(X, Z) + \\text{Cov}(U, Z)\n$$\n由于 $\\alpha_Y$ 是一个常数，$\\text{Cov}(\\alpha_Y, Z) = 0$。根据外生性假设，我们有 $\\text{Cov}(U, Z) = 0$。这将方程简化为：\n$$\n\\text{Cov}(Y, Z) = \\beta \\text{Cov}(X, Z)\n$$\n根据相关性假设，$\\text{Cov}(X, Z) \\neq 0$，所以我们可以解出 $\\beta$：\n$$\n\\beta = \\frac{\\text{Cov}(Y, Z)}{\\text{Cov}(X, Z)}\n$$\n这就是总体IV估计目标的一般形式。对于一个二元工具变量 $Z \\in \\{0,1\\}$，协方差公式可以简化。对于任意随机变量 $V$，其与二元变量 $Z$ 的协方差为 $\\text{Cov}(V, Z) = (E[V|Z=1] - E[V|Z=0])P(Z=1)(1-P(Z=1))$。将此应用于分子和分母：\n$$\n\\beta = \\frac{(E[Y|Z=1] - E[Y|Z=0])P(Z=1)(1-P(Z=1))}{(E[X|Z=1] - E[X|Z=0])P(Z=1)(1-P(Z=1))}\n$$\n假设 $Z$ 不是一个常数，即 $0  P(Z=1)  1$，那么项 $P(Z=1)(1-P(Z=1))$ 非零，可以消去。这就得到了针对二元工具变量的特定总体比率形式：\n$$\n\\beta = \\frac{E[Y|Z=1] - E[Y|Z=0]}{E[X|Z=1] - E[X|Z=0]}\n$$\n这个公式将估计目标定义为由工具变量定义的两组之间，均值结局的差异与均值暴露的差异之比。\n\n其次，我们通过将总体条件期望替换为其样本对应物——条件样本均值，来构建样本类比估计量。该估计量记为 $\\hat{\\beta}_{IV}$：\n$$\n\\hat{\\beta}_{IV} = \\frac{\\bar{Y}_{1} - \\bar{Y}_{0}}{\\bar{X}_{1} - \\bar{X}_{0}}\n$$\n其中 $\\bar{Y}_{1}$ 和 $\\bar{X}_{1}$ 是 $Z=1$ 亚组中 $Y$ 和 $X$ 的样本均值，而 $\\bar{Y}_{0}$ 和 $\\bar{X}_{0}$ 是 $Z=0$ 亚组的样本均值。\n\n使用提供的数据：\n- $\\bar{Y}_{1} = 129.80$\n- $\\bar{Y}_{0} = 127.43$\n- $\\bar{X}_{1} = 2.91$\n- $\\bar{X}_{0} = 2.28$\n\n我们将这些值代入估计量公式：\n$$\n\\hat{\\beta}_{IV} = \\frac{129.80 - 127.43}{2.91 - 2.28} = \\frac{2.37}{0.63} \\approx 3.7619047...\n$$\n按要求四舍五入到四位有效数字，我们得到：\n$$\n\\hat{\\beta}_{IV} \\approx 3.762\n$$\n单位是 mmHg/mg/L。\n\n第三，在该设定下，要使 $\\hat{\\beta}_{IV}$ 成为因果效应 $\\beta$ 的一致估计量，所需的最小化高阶条件是：\n1.  **工具变量相关性**：SNP ($Z$) 必须对C反应蛋白水平 ($X$) 有因果效应。在总体中，这意味着 $E[X|Z=1] \\neq E[X|Z=0]$。违反或接近违反此条件（即“弱工具变量”）将导致估计量有偏且方差很大。\n2.  **工具变量外生性（及排他性限制）**：SNP ($Z$) 必须独立于所有影响C反应蛋白 ($X$) 和收缩压 ($Y$) 的未测量混杂因素。这意味着 (a) SNP 不通过任何绕过C反应蛋白的路径影响血压（即不存在代表后门路径的多效性），以及 (b) SNP 的存在与导致高血压的其他生活方式或环境因素不相关。第二点由于减数分裂过程中等位基因的随机分配而变得合理。\n3.  **线性与同质性**：问题前提中关于具有恒定因果效应 $\\beta$ 的线性结构模型的设定是一个强的结构性假设。它假定 $X$ 对 $Y$ 的因果效应对每个个体都是相同的。在此假设下，IV估计量是这个恒定效应 $\\beta$ 的一致估计量。如果没有这个假设（即存在效应异质性），IV比率会收敛于局部平均处理效应（LATE），这仅是在其暴露水平受工具变量影响的那些个体中的平均效应。\n\n这三个条件，加上标准的正则性假设（例如，来自总体的随机样本和有限矩，如题目所给）以及大样本量，确保了样本估计量 $\\hat{\\beta}_{IV}$ 依概率收敛于真实的因果参数 $\\beta$。",
            "answer": "$$\\boxed{3.762}$$"
        },
        {
            "introduction": "在应用工具变量（IV）方法后，一个关键的诊断问题是：IV 分析是否确有必要？如果暴露变量实际上是外生的，那么更简单、更精确的普通最小二乘法（OLS）就足够了。本练习将引导您使用豪斯曼检验（Hausman test）来正式地检验暴露变量的内生性 ()。通过比较 OLS 估计值（在没有内生性的零假设下是有效的）和双阶段最小二乘法（2SLS）估计值（即使存在内生性也具备一致性），您可以判断两者之间的差异是否在统计上显著，从而为您的模型选择提供有力证据。这项实践是应用计量经济学和流行病学研究中的一项核心技能。",
            "id": "4574244",
            "problem": "一个流行病学团队正在使用孟德尔随机化方法分析酒精摄入对全身性炎症的因果效应。设 $Y$ 表示对数C反应蛋白，$X$ 表示每周酒精单位，$Z$ 表示由乙醇脱氢酶基因变异构建的多基因评分。结果模型为 $Y = \\alpha + \\beta X + U$，其中由于未测量的生活方式混杂因素，$U$ 可能与 $X$ 相关。多基因评分 $Z$ 被用作 $X$ 的工具变量。\n\n假设以下条件成立：$Z$ 与 $X$ 相关（强第一阶段），并且在以祖源主成分和两个阶段中都使用的其他协变量为条件下，$Z$ 在受孕时如同随机分配。样本量为 $n=4800$，第一阶段的$F$统计量为 $F=22$，两个估计量都是在同方差工作模型下，对相同的完整病例样本，使用相同的协变量集计算得出的。\n\n普通最小二乘 (OLS) 估计值为 $\\hat{\\beta}_{\\mathrm{OLS}}=0.30$，标准误为 $\\mathrm{SE}(\\hat{\\beta}_{\\mathrm{OLS}})=0.05$。两阶段最小二乘 (2SLS) 估计值为 $\\hat{\\beta}_{\\mathrm{2SLS}}=0.45$，标准误为 $\\mathrm{SE}(\\hat{\\beta}_{\\mathrm{2SLS}})=0.12$。\n\n要求您使用 Hausman 原则，即比较外生性假设下的有效估计量与工具变量有效性假设下的一致估计量，来正式检验结果方程中 $X$ 的剩余内生性。请选择一个选项，该选项能正确陈述原假设，正确设置估计量的比较，并根据所提供的信息在 $5\\%$ 的显著性水平下得出正确的结论。\n\nA. 原假设是 $X$ 在结果方程中是外生的，因此普通最小二乘和两阶段最小二乘都是一致的，且普通最小二乘是有效的。该检验将差异 $\\hat{\\beta}_{\\mathrm{2SLS}}-\\hat{\\beta}_{\\mathrm{OLS}}$ 与其在原假设下由有效性排序所隐含的抽样变异性进行比较。使用报告的标准误，检验统计量由方差之差计算得出，并与 $\\chi^2_1$ 参考分布进行比较。在 $5\\%$ 的显著性水平下，无法拒绝 $X$ 的外生性。\n\nB. 原假设是工具变量是相关的。由于第一阶段的 $F=2210$，所以拒绝原假设并得出存在内生性的结论。合适的检验统计量比较的是 $\\hat{\\beta}_{\\mathrm{2SLS}}-\\hat{\\beta}_{\\mathrm{OLS}}$ 除以它们的方差之和，这里得出的值很大，超过了 $\\chi^2_1$ 的临界值，因此 $X$ 是内生的。\n\nC. 原假设是 $\\mathbb{E}[U\\mid Z]=0$，这意味着工具变量有效。正确的比较是对 $\\hat{\\beta}_{\\mathrm{2SLS}}-\\hat{\\beta}_{\\mathrm{OLS}}$ 进行 $t$ 检验，使用合并方差 $\\mathrm{Var}(\\hat{\\beta}_{\\mathrm{2SLS}})+\\mathrm{Var}(\\hat{\\beta}_{\\mathrm{OLS}})$。得到的 $t$ 统计量约等于 $1.12$，在 $5\\%$ 水平下显著，因此我们拒绝外生性。\n\nD. 原假设是 $X$ 是内生的。因为第一阶段是强的，所以普通最小二乘必定有偏。因此，两阶段最小二乘更可取，我们无需进一步计算即可拒绝 $X$ 是外生的原假设。",
            "solution": "用户希望我扮演一名STEM教授，验证一个关于工具变量（IV）分析的问题，然后解决它。\n\n### 步骤1：提取已知条件\n-   结果变量：$Y = \\text{对数C反应蛋白}$\n-   暴露变量：$X = \\text{每周酒精单位}$\n-   工具变量：$Z = \\text{来自乙醇脱氢酶基因的多基因评分}$\n-   结果模型：$Y = \\alpha + \\beta X + U$\n-   内生性问题：$\\mathrm{Cov}(X, U)$ 可能不为零。\n-   已声明满足的工具变量假设：\n    1.  相关性：$Z$ 是 $X$ 的强工具变量。\n    2.  排他性/独立性：$Z$ 如同随机分配，意味着它与误差项 $U$ 不相关。\n-   样本量：$n = 4800$\n-   第一阶段F统计量：$F = 22$\n-   普通最小二乘（OLS）估计值：$\\hat{\\beta}_{\\mathrm{OLS}} = 0.30$\n-   OLS估计值的标准误：$\\mathrm{SE}(\\hat{\\beta}_{\\mathrm{OLS}}) = 0.05$\n-   两阶段最小二乘（2SLS）估计值：$\\hat{\\beta}_{\\mathrm{2SLS}} = 0.45$\n-   2SLS估计值的标准误：$\\mathrm{SE}(\\hat{\\beta}_{\\mathrm{2SLS}}) = 0.12$\n-   建模条件：\n    -   两个估计量都在同一组样本上使用相同的协变量计算得出。\n    -   假设了一个同方差工作模型。\n-   目标：使用Hausman原则，在5%的显著性水平上对 $X$ 的内生性进行正式检验。\n\n### 步骤2：使用提取的已知条件进行验证\n-   **科学依据充分**：该问题在流行病学和计量经济学理论方面有充分的依据。孟德尔随机化是工具变量的一个标准应用。所使用的变量（酒精消耗、C反应蛋白、遗传评分）在该研究领域很常见。统计概念（OLS、2SLS、Hausman检验、F统计量）都是标准的，并且应用得当。\n-   **问题定义良好**：该问题定义良好。它要求进行一项特定的统计检验（内生性的Hausman检验），并提供了执行计算和得出结论所需的所有数值和假设（同方差性、强工具变量、相同样本）。存在唯一解。\n-   **客观性**：问题以精确、客观和量化的方式陈述。没有主观或含糊的陈述。\n\n该问题没有任何说明中列出的缺陷（例如，科学上不健全、不完整、矛盾）。给定的数据是一致的；例如，$\\mathrm{SE}(\\hat{\\beta}_{\\mathrm{2SLS}})  \\mathrm{SE}(\\hat{\\beta}_{\\mathrm{OLS}})$，这是符合预期的，因为OLS比2SLS更有效。第一阶段的F统计量为22，远高于通常经验法则的阈值10，支持了“强第一阶段”的假设。\n\n### 步骤3：结论与行动\n问题陈述有效。我将继续进行求解推导和选项评估。\n\n### 基于原则的推导\n\n目标是检验模型 $Y = \\alpha + \\beta X + U$ 中回归变量 $X$ 的内生性。Hausman检验就是为此目的设计的。它比较了一个在原假设和备择假设下都一致的估计量（2SLS）与一个在原假设下有效但在备择假设下不一致的估计量（OLS）。\n\n1.  **假设**：\n    -   原假设（$H_0$）：$X$ 是外生的，即 $\\mathrm{Cov}(X, U) = 0$。在 $H_0$ 下，OLS和2SLS都是 $\\beta$ 的一致估计量，但OLS更有效（方差更小）。\n    -   备择假设（$H_A$）：$X$ 是内生的，即 $\\mathrm{Cov}(X, U) \\neq 0$。在 $H_A$ 下，OLS是不一致的，而2SLS仍然是一致的（假定工具变量的假设成立）。\n\n2.  **检验统计量**：Hausman检验统计量基于两个估计量之间的差异 $\\hat{d} = \\hat{\\beta}_{\\mathrm{2SLS}} - \\hat{\\beta}_{\\mathrm{OLS}}$。在 $H_0$ 下，这个差异应该接近于零。正式的检验统计量是一个二次型：\n    $$ H = (\\hat{\\beta}_{\\mathrm{2SLS}} - \\hat{\\beta}_{\\mathrm{OLS}})^T [\\mathrm{Var}(\\hat{\\beta}_{\\mathrm{2SLS}} - \\hat{\\beta}_{\\mathrm{OLS}})]^{-1} (\\hat{\\beta}_{\\mathrm{2SLS}} - \\hat{\\beta}_{\\mathrm{OLS}}) $$\n    在这个单一回归变量的情况下，它简化为：\n    $$ H = \\frac{(\\hat{\\beta}_{\\mathrm{2SLS}} - \\hat{\\beta}_{\\mathrm{OLS}})^2}{\\mathrm{Var}(\\hat{\\beta}_{\\mathrm{2SLS}} - \\hat{\\beta}_{\\mathrm{OLS}})} $$\n    Hausman检验的一个关键洞见是差异方差的结构。因为 $\\hat{\\beta}_{\\mathrm{OLS}}$ 在 $H_0$ 下是有效估计量，可以证明 $\\mathrm{Cov}(\\hat{\\beta}_{\\mathrm{OLS}}, \\hat{\\beta}_{\\mathrm{2SLS}} - \\hat{\\beta}_{\\mathrm{OLS}}) = 0$。这意味着 $\\mathrm{Cov}(\\hat{\\beta}_{\\mathrm{OLS}}, \\hat{\\beta}_{\\mathrm{2SLS}}) = \\mathrm{Var}(\\hat{\\beta}_{\\mathrm{OLS}})$。\n    因此，差异的方差为：\n    $$ \\mathrm{Var}(\\hat{\\beta}_{\\mathrm{2SLS}} - \\hat{\\beta}_{\\mathrm{OLS}}) = \\mathrm{Var}(\\hat{\\beta}_{\\mathrm{2SLS}}) + \\mathrm{Var}(\\hat{\\beta}_{\\mathrm{OLS}}) - 2 \\mathrm{Cov}(\\hat{\\beta}_{\\mathrm{OLS}}, \\hat{\\beta}_{\\mathrm{2SLS}}) $$\n    $$ \\mathrm{Var}(\\hat{\\beta}_{\\mathrm{2SLS}} - \\hat{\\beta}_{\\mathrm{OLS}}) = \\mathrm{Var}(\\hat{\\beta}_{\\mathrm{2SLS}}) + \\mathrm{Var}(\\hat{\\beta}_{\\mathrm{OLS}}) - 2 \\mathrm{Var}(\\hat{\\beta}_{\\mathrm{OLS}}) $$\n    $$ \\mathrm{Var}(\\hat{\\beta}_{\\mathrm{2SLS}} - \\hat{\\beta}_{\\mathrm{OLS}}) = \\mathrm{Var}(\\hat{\\beta}_{\\mathrm{2SLS}}) - \\mathrm{Var}(\\hat{\\beta}_{\\mathrm{OLS}}) $$\n    这个公式在同方差性的假设下有效，而问题陈述中已给出该假设。因此检验统计量为：\n    $$ H = \\frac{(\\hat{\\beta}_{\\mathrm{2SLS}} - \\hat{\\beta}_{\\mathrm{OLS}})^2}{\\mathrm{Var}(\\hat{\\beta}_{\\mathrm{2SLS}}) - \\mathrm{Var}(\\hat{\\beta}_{\\mathrm{OLS}})} $$\n    在 $H_0$ 下，$H$ 服从卡方分布，其自由度等于潜在内生回归变量的数量，本例中为1（$\\chi^2_1$）。\n\n3.  **计算**：\n    -   估计值差异：$\\hat{\\beta}_{\\mathrm{2SLS}} - \\hat{\\beta}_{\\mathrm{OLS}} = 0.45 - 0.30 = 0.15$。\n    -   估计方差：\n        -   $\\widehat{\\mathrm{Var}}(\\hat{\\beta}_{\\mathrm{OLS}}) = (\\mathrm{SE}(\\hat{\\beta}_{\\mathrm{OLS}}))^2 = (0.05)^2 = 0.0025$。\n        -   $\\widehat{\\mathrm{Var}}(\\hat{\\beta}_{\\mathrm{2SLS}}) = (\\mathrm{SE}(\\hat{\\beta}_{\\mathrm{2SLS}}))^2 = (0.12)^2 = 0.0144$。\n    -   差异的估计方差：\n        -   $\\widehat{\\mathrm{Var}}(\\hat{\\beta}_{\\mathrm{2SLS}} - \\hat{\\beta}_{\\mathrm{OLS}}) = \\widehat{\\mathrm{Var}}(\\hat{\\beta}_{\\mathrm{2SLS}}) - \\widehat{\\mathrm{Var}}(\\hat{\\beta}_{\\mathrm{OLS}}) = 0.0144 - 0.0025 = 0.0119$。\n    -   Hausman统计量：\n        -   $H = \\frac{(0.15)^2}{0.0119} = \\frac{0.0225}{0.0119} \\approx 1.891$。\n\n4.  **结论**：\n    -   检验应在 $5\\%$ 的显著性水平下进行。$\\alpha = 0.05$ 时，$\\chi^2_1$ 分布的临界值约为 $3.841$。\n    -   由于我们的检验统计量 $H \\approx 1.891$ 小于临界值 $3.841$，我们无法拒绝原假设 $H_0$。\n    -   在 $5\\%$ 的显著性水平下，没有足够的统计证据得出酒精摄入量 ($X$) 在对数C反应蛋白 ($Y$) 的结果方程中是内生变量的结论。OLS和2SLS估计值之间的差异不具有统计显著性。\n\n### 逐项分析\n\n**A. 原假设是 $X$ 在结果方程中是外生的，因此普通最小二乘和两阶段最小二乘都是一致的，且普通最小二乘是有效的。该检验将差异 $\\hat{\\beta}_{\\mathrm{2SLS}}-\\hat{\\beta}_{\\mathrm{OLS}}$ 与其在原假设下由有效性排序所隐含的抽样变异性进行比较。使用报告的标准误，检验统计量由方差之差计算得出，并与 $\\chi^2_1$ 参考分布进行比较。在 $5\\%$ 的显著性水平下，无法拒绝 $X$ 的外生性。**\n-   该选项正确陈述了原假设及其对一致性和有效性的影响。\n-   它正确地描述了比较两种估计量的Hausman原则。\n-   它正确地指出了计算差异方差的方法（$\\mathrm{Var}(\\hat{\\beta}_{\\mathrm{2SLS}}) - \\mathrm{Var}(\\hat{\\beta}_{\\mathrm{OLS}})$）和正确的参考分布（$\\chi^2_1$）。\n-   其结论与我们的计算相符：由于 $H \\approx 1.891  3.841$，我们不能拒绝外生性的原假设。\n-   **结论：正确。**\n\n**B. 原假设是工具变量是相关的。由于第一阶段的 $F=2210$，所以拒绝原假设并得出存在内生性的结论。合适的检验统计量比较的是 $\\hat{\\beta}_{\\mathrm{2SLS}}-\\hat{\\beta}_{\\mathrm{OLS}}$ 除以它们的方差之和，这里得出的值很大，超过了 $\\chi^2_1$ 的临界值，因此 $X$ 是内生的。**\n-   Hausman检验的原假设是 $X$ 的外生性，而不是工具变量的相关性。F统计量检验的是相关性，而 $F=22$ 意味着工具变量是强的，而不是存在内生性。这是对两个独立检验的根本性误解。\n-   差异的方差被错误地陈述为方差之和。这将假设估计量是独立的，而实际上它们不是。\n-   **结论：错误。**\n\n**C. 原假设是 $\\mathbb{E}[U\\mid Z]=0$，这意味着工具变量有效。正确的比较是对 $\\hat{\\beta}_{\\mathrm{2SLS}}-\\hat{\\beta}_{\\mathrm{OLS}}$ 进行 $t$ 检验，使用合并方差 $\\mathrm{Var}(\\hat{\\beta}_{\\mathrm{2SLS}})+\\mathrm{Var}(\\hat{\\beta}_{\\mathrm{OLS}})$。得到的 $t$ 统计量约等于 $1.12$，在 $5\\%$ 水平下显著，因此我们拒绝外生性。**\n-   原假设陈述有误。$\\mathbb{E}[U\\mid Z]=0$ 是工具变量的外生性假设，在进行Hausman检验时这是给定的前提条件。检验的原假设是 $\\mathrm{Cov}(X,U)=0$。\n-   在此表述中，检验统计量是 $\\chi^2$ 统计量，不是 $t$ 统计量。\n-   差异的方差被错误地表述为方差之和。\n-   一个 $t$ 统计量为 $1.12$ 在 $5\\%$ 的水平下不会显著（临界值约为 $\\pm 1.96$），因此其结论即使根据其自身的数字也是错误的。\n-   **结论：错误。**\n\n**D. 原假设是 $X$ 是内生的。因为第一阶段是强的，所以普通最小二乘必定有偏。因此，两阶段最小二乘更可取，我们无需进一步计算即可拒绝 $X$ 是外生的原假设。**\n-   该检验的原假设是外生性，而不是内生性。\n-   一个强的第一阶段（$F=22$）并不意味着OLS有偏。只有当 $X$ 是内生的时，OLS才会有偏。工具变量强度和回归变量内生性是两个独立的概念。\n-   在没有正式检验的情况下拒绝外生性是错误的。Hausman检验的意义就在于为在有效的OLS和一致的2SLS之间做出选择提供统计依据。\n-   **结论：错误。**",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "真实的因果推断研究远不止于应用单个公式，它需要一个从原始数据到最终结论的完整分析流程。本综合练习将指导您构建一个完整的双样本孟德尔随机化（MR）分析流程，这是现代流行病学中 IV 分析的前沿应用 ()。您将模拟一个真实的研究场景，任务涵盖了作为工具变量的遗传变异的筛选、通过连锁不平衡（LD）“剪枝”来确保工具变量的独立性、以及通过等位基因“协调”来统一效应方向等关键数据预处理步骤。最后，您将使用逆方差加权（IVW）方法估计因果效应，从而将理论知识转化为可执行的、贴近真实科研场景的编程实践。",
            "id": "4574240",
            "problem": "您的任务是实现一个完整的双样本孟德尔随机化流程，作为一个可运行的程序，使用工具变量分析来估计低密度脂蛋白胆固醇对冠状动脉疾病的因果效应。您的程序必须实现变异选择、连锁不平衡聚类、等位基因协调和回文等位基因处理，然后计算因果效应的反方差加权（IVW）估计量。设计必须反映流行病学中标准的工具变量分析。该实现必须使用提供的合成摘要数据，并且完全是确定性的，不需要任何用户输入。\n\n从以下基础开始：\n- 工具变量由三个假设定义：相关性、独立性和排他性限制。在双样本孟德尔随机化中，单核苷酸多态性作为暴露的工具。\n- 对于每个由 $i$ 索引的工具，其暴露关联由 $\\hat{\\beta}_{X i}$ 表示，标准误为 $s_{X i}$，$p$值为 $p_{X i}$；其结局关联由 $\\hat{\\beta}_{Y i}$ 表示，标准误为 $s_{Y i}$。\n- 在一个摘要数据双样本设置中，对于 $\\hat{\\beta}_{X i}$ 采用无测量误差近似，IVW估计量是通过对 $\\hat{\\beta}_{Y i}$ 关于 $\\hat{\\beta}_{X i}$ 进行加权最小二乘回归得到的，截距为零，权重为 $w_i = 1 / s_{Y i}^2$。IVW斜率估计值为\n$$\n\\hat{\\theta}_{\\mathrm{IVW}} \\;=\\; \\frac{\\sum_i w_i \\,\\hat{\\beta}_{X i}\\,\\hat{\\beta}_{Y i}}{\\sum_i w_i \\,\\hat{\\beta}_{X i}^2},\n$$\n其固定效应标准误为\n$$\n\\mathrm{se}(\\hat{\\theta}_{\\mathrm{IVW}}) \\;=\\; \\sqrt{\\frac{1}{\\sum_i w_i \\,\\hat{\\beta}_{X i}^2}},\n$$\n以及Cochran异质性统计量\n$$\nQ \\;=\\; \\sum_i w_i \\,\\big(\\hat{\\beta}_{Y i} - \\hat{\\theta}_{\\mathrm{IVW}} \\,\\hat{\\beta}_{X i}\\big)^2.\n$$\n您的程序必须计算每个测试用例的 $\\hat{\\theta}_{\\mathrm{IVW}}$；诸如 $\\mathrm{se}(\\hat{\\theta}_{\\mathrm{IVW}})$ 和 $Q$ 之类的次要量可以在内部计算用于验证，但要求的输出仅为 $\\hat{\\theta}_{\\mathrm{IVW}}$ 值。\n\n要实现的数据和规则：\n1) 按暴露关联筛选变异：\n   - 仅保留 $p_{X i} \\leq p_{\\mathrm{thr}}$ 的变异。\n\n2) 连锁不平衡聚类：\n   - 筛选后，按 $p_{X i}$ 升序对变异进行排序。按此顺序迭代，仅当没有已保留的变异位于指定的物理窗口内且其成对连锁不平衡超过阈值时，才保留候选变异。\n   -具体而言，定义一个 $W_{\\mathrm{kb}}$ 千碱基的窗口和一个 $r^2$ 阈值 $r^2_{\\mathrm{thr}}$。对于一个新的候选变异 $j$，如果存在任何已保留的变异 $k$ 同时满足 $| \\mathrm{pos}_j - \\mathrm{pos}_k | \\leq 1000 \\times W_{\\mathrm{kb}}$ 和 $r^2_{jk} \\geq r^2_{\\mathrm{thr}}$，则丢弃 $j$；否则保留 $j$。\n   - 如果未明确提供一对变异的 $r^2$，则假定 $r^2 = 0$。\n\n3) 等位基因的协调：\n   - 每个变异都有暴露等位基因 $(A_{E}, A_{O})$ 和结局等位基因 $(A'_{E}, A'_{O})$。同时提供了暴露效应等位基因频率 $\\mathrm{EAF}_X$ 和结局效应等位基因频率 $\\mathrm{EAF}_Y$。\n   - 非回文等位基因：如果 $(A'_{E}, A'_{O}) = (A_{E}, A_{O})$，则保持 $\\hat{\\beta}_{Y i}$ 不变。如果 $(A'_{E}, A'_{O}) = (A_{O}, A_{E})$，则反转 $\\hat{\\beta}_{Y i}$ 的符号。如果两者都不匹配，则尝试对结局等位基因进行链互补，即对两个结局等位基因应用互补映射 $\\mathcal{C}$（其中 $\\mathcal{C}(A) = T$, $\\mathcal{C}(T) = A$, $\\mathcal{C}(C) = G$, $\\mathcal{C}(G) = C$），然后重新检查这两个匹配规则；如果仍不匹配，则丢弃该变异。\n   - 回文等位基因：回文集是指 $\\{A_{E}, A_{O}\\} \\in \\big\\{ \\{A,T\\}, \\{C,G\\} \\big\\}$。对于回文变异，不要使用字母匹配或链互补来决定方向。而是使用相对于模糊区间的 $\\mathrm{EAF}_X$。如果 $\\mathrm{EAF}_X \\in [L_{\\mathrm{amb}}, U_{\\mathrm{amb}}]$，其中 $L_{\\mathrm{amb}}$ 和 $U_{\\mathrm{amb}}$ 是模糊界限，则因无法解析而丢弃该变异。否则，通过比较 $|\\mathrm{EAF}_Y - \\mathrm{EAF}_X|$ 与 $| (1 - \\mathrm{EAF}_Y) - \\mathrm{EAF}_X |$ 来确定方向。如果前者较小或相等，则保持 $\\hat{\\beta}_{Y i}$；如果后者较小，则反转 $\\hat{\\beta}_{Y i}$ 的符号。\n\n4) IVW估计：\n   - 经过聚类和协调后，使用上述公式及权重 $w_i = 1 / s_{Y i}^2$ 计算 $\\hat{\\theta}_{\\mathrm{IVW}}$。如果只剩下一个工具变量，则估计量简化为 $\\hat{\\theta}_{\\mathrm{IVW}} = \\hat{\\beta}_{Y 1} / \\hat{\\beta}_{X 1}$。\n\n合成摘要数据：\n- 单核苷酸多态性：$\\mathrm{SNP} \\in \\{\\mathrm{rs1}, \\mathrm{rs2}, \\mathrm{rs3}, \\mathrm{rs4}, \\mathrm{rs5}, \\mathrm{rs6}\\}$，全部位于1号染色体上，碱基对位置如下：\n  - $\\mathrm{rs1}$ 位于 $100{,}000$，\n  - $\\mathrm{rs2}$ 位于 $120{,}000$，\n  - $\\mathrm{rs3}$ 位于 $160{,}000$，\n  - $\\mathrm{rs4}$ 位于 $220{,}000$，\n  - $\\mathrm{rs5}$ 位于 $500{,}000$，\n  - $\\mathrm{rs6}$ 位于 $620{,}000$。\n- 暴露关联 $(\\hat{\\beta}_{X}, s_{X}, p_{X}, \\mathrm{EAF}_X, A_{E}, A_{O})$：\n  - $\\mathrm{rs1}$: $(0.08, 0.01, 1\\times 10^{-12}, 0.30, A, G)$,\n  - $\\mathrm{rs2}$: $(0.07, 0.015, 2\\times 10^{-9}, 0.55, T, A)$,\n  - $\\mathrm{rs3}$: $(0.05, 0.02, 7\\times 10^{-8}, 0.40, C, T)$,\n  - $\\mathrm{rs4}$: $(0.02, 0.02, 1\\times 10^{-6}, 0.20, G, C)$,\n  - $\\mathrm{rs5}$: $(0.06, 0.018, 3\\times 10^{-9}, 0.10, G, T)$,\n  - $\\mathrm{rs6}$: $(0.09, 0.017, 1\\times 10^{-10}, 0.49, C, G)$。\n- 结局关联 $(\\hat{\\beta}_{Y}, s_{Y}, \\mathrm{EAF}_Y, A'_{E}, A'_{O})$：\n  - $\\mathrm{rs1}$: $(0.035, 0.01, 0.31, A, G)$,\n  - $\\mathrm{rs2}$: $(-0.028, 0.012, 0.45, A, T)$,\n  - $\\mathrm{rs3}$: $(0.018, 0.012, 0.60, G, A)$,\n  - $\\mathrm{rs4}$: $(0.006, 0.015, 0.20, G, C)$,\n  - $\\mathrm{rs5}$: $(-0.030, 0.011, 0.90, T, G)$,\n  - $\\mathrm{rs6}$: $(-0.041, 0.013, 0.51, G, C)$。\n- 连锁不平衡对由物理窗口内变异对的 $(r^2)$ 值给出；如果某对未列出，则使用 $0$：\n  - $\\mathrm{rs1}$–$\\mathrm{rs2}$: $0.60$,\n  - $\\mathrm{rs2}$–$\\mathrm{rs3}$: $0.25$,\n  - $\\mathrm{rs1}$–$\\mathrm{rs3}$: $0.19$,\n  - 所有其他列出的对：$0$。\n\n测试套件和参数化：\n您的程序必须使用上述数据集运行以下四个测试用例，并按顺序输出每个用例的IVW估计值 $\\hat{\\theta}_{\\mathrm{IVW}}$。\n\n- 测试用例1（正常路径）：$p_{\\mathrm{thr}} = 5\\times 10^{-8}$，$r^2_{\\mathrm{thr}} = 0.20$，$W_{\\mathrm{kb}} = 100$，$L_{\\mathrm{amb}} = 0.42$，$U_{\\mathrm{amb}} = 0.58$。完全按照上述规定使用暴露和结局数据。\n\n- 测试用例2（$r^2$相等边界）：$p_{\\mathrm{thr}} = 5\\times 10^{-8}$，$r^2_{\\mathrm{thr}} = 0.19$，$W_{\\mathrm{kb}} = 100$，$L_{\\mathrm{amb}} = 0.42$，$U_{\\mathrm{amb}} = 0.58$。使用相同的数据；注意，根据规则 $r^2 \\ge r^2_{\\mathrm{thr}}$，$r^2 = 0.19$ 的相等情况应触发聚类。\n\n- 测试用例3（使用效应等位基因频率可解析的回文变异）：$p_{\\mathrm{thr}} = 5\\times 10^{-8}$，$r^2_{\\mathrm{thr}} = 0.20$，$W_{\\mathrm{kb}} = 100$，$L_{\\mathrm{amb}} = 0.42$，$U_{\\mathrm{amb}} = 0.58$。仅修改回文变异 $\\mathrm{rs6}$，使其暴露 $\\mathrm{EAF}_X = 0.30$，结局 $\\mathrm{EAF}_Y = 0.70$；所有其他值保持原样。\n\n- 测试用例4（单工具变量边缘情况）：$p_{\\mathrm{thr}} = 1\\times 10^{-11}$，$r^2_{\\mathrm{thr}} = 0.20$，$W_{\\mathrm{kb}} = 100$，$L_{\\mathrm{amb}} = 0.42$，$U_{\\mathrm{amb}} = 0.58$。使用原始数据；此阈值确保只保留最强的工具变量。\n\n最终输出格式：\n- 您的程序必须生成单行输出，其中包含四个IVW估计值，按测试用例1到4的顺序，以逗号分隔的列表形式用方括号括起来，例如 $[\\hat{\\theta}_1,\\hat{\\theta}_2,\\hat{\\theta}_3,\\hat{\\theta}_4]$。\n- 每个元素必须是浮点数。不应打印任何其他文本。",
            "solution": "该问题要求实现一个双样本孟德尔随机化（MR）流程，以估计暴露对结局的因果效应。该流程遵循流行病学遗传学的标准方法，包括工具选择、连锁不平衡（LD）聚类、等位基因协调，最后使用反方差加权（IVW）方法进行因果效应估计。整个过程将应用于提供的合成数据集，针对四个不同的测试用例。\n\n首先，我们将以结构化方式表示提供的基因组数据，以便于处理。每个单核苷酸多态性（SNP）都是一个对象，具有其标识符、染色体位置以及暴露和结局研究的摘要统计信息等属性。这些统计数据包括效应估计值（$\\hat{\\beta}$）、标准误（$s$）、p值（$p$）、效应等位基因频率（EAF）以及效应等位基因和其它等位基因。\n\nMR流程包括四个主要的顺序步骤：\n\n**1. 根据暴露关联强度筛选变异**\n选择有效工具变量（IVs）的第一步是确保它们满足*相关性假设*。该假设指出，工具必须与暴露相关。在实践中，这是通过根据变异与暴露关联的统计显著性来筛选变异来实现的。我们将只保留那些暴露p值 $p_{X i}$ 小于或等于指定阈值 $p_{\\mathrm{thr}}$ 的SNP。\n$$\n\\text{如果 } p_{X i} \\leq p_{\\mathrm{thr}} \\text{，则保留SNP } i\n$$\n\n**2. 连锁不平衡（LD）聚类**\n第二步解决*独立性假设*，该假设要求工具变量之间相互独立。在染色体上物理位置相近的SNP通常是相关的，这种现象称为连锁不平衡。包含相关的工具变量可能会使MR估计产生偏差。聚类是一种贪心算法，用于选择一组近似独立的SNP。其过程如下：\na) 通过p值筛选的SNP按其暴露p值 $p_{X i}$ 的升序排序。这优先考虑与暴露关联证据更强的SNP。\nb) 我们遍历排序后的列表，将每个SNP视为一个潜在的工具。第一个SNP（具有最低的 $p_{X i}$）被指定为第一个“索引SNP”并被保留。\nc) 对于每个后续的候选SNP $j$，我们检查它是否与任何已保留的索引SNP $k$ 存在LD。如果存在任何已保留的SNP $k$ 同时满足以下两个条件，则候选SNP $j$ 将被“筛除”（即丢弃）：\n   i) 物理邻近性：SNP之间的距离在指定窗口内，即 $|\\mathrm{pos}_j - \\mathrm{pos}_k| \\leq 1000 \\times W_{\\mathrm{kb}}$，其中 $W_{\\mathrm{kb}}$ 是以千碱基为单位的窗口大小。\n   ii) 相关性：平方相关系数（LD）$r^2_{jk}$ 大于或等于指定的阈值，$r^2_{jk} \\geq r^2_{\\mathrm{thr}}$。\nd) 如果一个候选SNP没有被任何已保留的SNP筛除，它本身就会被保留并添加到索引SNP集合中。\n\n**3. 等位基因协调**\n双样本MR使用来自两个不同研究（一个用于暴露，一个用于结局）的摘要统计数据。确保每个SNP的效应估计值 $\\hat{\\beta}$ 在两项研究中对应于相同的效应等位基因至关重要。协调是校准这些等位基因的过程。对于每个SNP $i$，我们有暴露等位基因 $(A_E, A_O)$ 和结局等位基因 $(A'_E, A'_O)$。\n\n- **非回文SNP**：如果一个SNP的等位基因不是A/T或C/G对（例如A/G），则该SNP为非回文。对于这些SNP，我们可以通过匹配等位基因字母来确定正确的方向。\n  a) 如果等位基因完全匹配，$(A'_E, A'_O) = (A_E, A_O)$，则结局效应 $\\hat{\\beta}_{Y i}$ 按原样使用。\n  b) 如果等位基因颠倒，$(A'_E, A'_O) = (A_O, A_E)$，则结局效应的符号反转（$\\hat{\\beta}_{Y i} \\to -\\hat{\\beta}_{Y i}$）。\n  c) 如果两者都不匹配，则可能是链模糊性问题。我们对结局等位基因应用互补映射（$\\mathcal{C}(A)=T, \\mathcal{C}(T)=A, \\mathcal{C}(C)=G, \\mathcal{C}(G)=C$）并重新尝试匹配。如果找到匹配项，则使用该效应（或其反转值）。\n  d) 如果无法找到匹配项，则丢弃该SNP。\n\n- **回文SNP**：如果一个SNP的等位基因是互补的（A/T或C/G），则该SNP为回文。对于这些SNP，等位基因字母匹配是模糊的。我们必须依赖等位基因频率。\n  a) 如果暴露的效应等位基因频率 $\\mathrm{EAF}_X$ 接近0.5，则很难推断正确的链。如果 $\\mathrm{EAF}_X$ 落在指定的模糊区间内，即 $L_{\\mathrm{amb}} \\leq \\mathrm{EAF}_X \\leq U_{\\mathrm{amb}}$，则该SNP因无法解析而被丢弃。\n  b) 否则，我们通过比较效应等位基因频率来推断方向。我们计算两个距离：$d_1 = |\\mathrm{EAF}_Y - \\mathrm{EAF}_X|$ 和 $d_2 = |(1-\\mathrm{EAF}_Y) - \\mathrm{EAF}_X|$。前者假设等位基因已对齐，而后者假设它们已颠倒（因为结局研究中另一个等位基因的频率是 $1 - \\mathrm{EAF}_Y$）。如果 $d_1 \\leq d_2$，则对齐可能是正确的。如果 $d_2  d_1$，则对齐可能已颠倒，并且 $\\hat{\\beta}_{Y i}$ 的符号被反转。\n\n**4. 反方差加权（IVW）估计**\n经过筛选、聚类和协调后，我们得到了一组有效且独立的工具变量。最后一步是估计因果效应 $\\theta$。IVW方法是一种元分析方法，通过将每个工具变量的比率估计值（$\\hat{\\theta}_i = \\hat{\\beta}_{Y i} / \\hat{\\beta}_{X i}$）按其方差的倒数进行加权来组合它们。这等效于对结局效应关于暴露效应进行加权线性回归，并将截距约束为零。权重为 $w_i = 1 / s_{Y i}^2$，其中 $s_{Y i}$ 是结局效应的标准误。\n\n因果效应的IVW估计值由下式给出：\n$$\n\\hat{\\theta}_{\\mathrm{IVW}} = \\frac{\\sum_i \\hat{\\beta}_{X i} \\hat{\\beta}_{Y i} / s_{Y i}^2}{\\sum_i \\hat{\\beta}_{X i}^2 / s_{Y i}^2} = \\frac{\\sum_i w_i \\hat{\\beta}_{X i} \\hat{\\beta}_{Y i}}{\\sum_i w_i \\hat{\\beta}_{X i}^2}\n$$\n在流程结束后仅剩下一个工具变量（$i=1$）的特定边缘情况下，IVW公式简化为Wald比率估计量：\n$$\n\\hat{\\theta}_{\\mathrm{IVW}} = \\frac{\\hat{\\beta}_{Y 1}}{\\hat{\\beta}_{X 1}}\n$$\n程序将对四个指定的测试用例中的每一个执行这整个流程，每个用例都有其自己的一套参数，并报告最终的 $\\hat{\\theta}_{\\mathrm{IVW}}$ 估计值。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements a two-sample Mendelian Randomization pipeline and runs it on four test cases.\n    \"\"\"\n\n    # --- Data Definition ---\n    # Synthetic summary data for 6 SNPs\n    snp_database = [\n        {'id': 'rs1', 'pos': 100000, 'beta_x': 0.08, 'se_x': 0.01, 'p_x': 1e-12, 'eaf_x': 0.30, 'a_e': 'A', 'a_o': 'G', 'beta_y': 0.035, 'se_y': 0.01, 'eaf_y': 0.31, 'ap_e': 'A', 'ap_o': 'G'},\n        {'id': 'rs2', 'pos': 120000, 'beta_x': 0.07, 'se_x': 0.015, 'p_x': 2e-9, 'eaf_x': 0.55, 'a_e': 'T', 'a_o': 'A', 'beta_y': -0.028, 'se_y': 0.012, 'eaf_y': 0.45, 'ap_e': 'A', 'ap_o': 'T'},\n        {'id': 'rs3', 'pos': 160000, 'beta_x': 0.05, 'se_x': 0.02, 'p_x': 7e-8, 'eaf_x': 0.40, 'a_e': 'C', 'a_o': 'T', 'beta_y': 0.018, 'se_y': 0.012, 'eaf_y': 0.60, 'ap_e': 'G', 'ap_o': 'A'},\n        {'id': 'rs4', 'pos': 220000, 'beta_x': 0.02, 'se_x': 0.02, 'p_x': 1e-6, 'eaf_x': 0.20, 'a_e': 'G', 'a_o': 'C', 'beta_y': 0.006, 'se_y': 0.015, 'eaf_y': 0.20, 'ap_e': 'G', 'ap_o': 'C'},\n        {'id': 'rs5', 'pos': 500000, 'beta_x': 0.06, 'se_x': 0.018, 'p_x': 3e-9, 'eaf_x': 0.10, 'a_e': 'G', 'a_o': 'T', 'beta_y': -0.030, 'se_y': 0.011, 'eaf_y': 0.90, 'ap_e': 'T', 'ap_o': 'G'},\n        {'id': 'rs6', 'pos': 620000, 'beta_x': 0.09, 'se_x': 0.017, 'p_x': 1e-10, 'eaf_x': 0.49, 'a_e': 'C', 'a_o': 'G', 'beta_y': -0.041, 'se_y': 0.013, 'eaf_y': 0.51, 'ap_e': 'G', 'ap_o': 'C'},\n    ]\n    \n    # Linkage disequilibrium (LD) data\n    # Using frozenset for unordered pair keys\n    ld_matrix = {\n        frozenset(['rs1', 'rs2']): 0.60,\n        frozenset(['rs2', 'rs3']): 0.25,\n        frozenset(['rs1', 'rs3']): 0.19,\n    }\n\n    # Test suite parameters\n    test_cases = [\n        {'p_thr': 5e-8, 'r2_thr': 0.20, 'W_kb': 100, 'L_amb': 0.42, 'U_amb': 0.58, 'mods': {}},\n        {'p_thr': 5e-8, 'r2_thr': 0.19, 'W_kb': 100, 'L_amb': 0.42, 'U_amb': 0.58, 'mods': {}},\n        {'p_thr': 5e-8, 'r2_thr': 0.20, 'W_kb': 100, 'L_amb': 0.42, 'U_amb': 0.58, 'mods': {'rs6': {'eaf_x': 0.30, 'eaf_y': 0.70}}},\n        {'p_thr': 1e-11, 'r2_thr': 0.20, 'W_kb': 100, 'L_amb': 0.42, 'U_amb': 0.58, 'mods': {}},\n    ]\n\n    results = []\n\n    def run_pipeline(snps, ld, params):\n        p_thr, r2_thr, W_kb, L_amb, U_amb = params['p_thr'], params['r2_thr'], params['W_kb'], params['L_amb'], params['U_amb']\n        window_bp = 1000 * W_kb\n        \n        # 1. Variant Filtering by exposure p-value\n        filtered_snps = [snp for snp in snps if snp['p_x'] = p_thr]\n\n        # 2. Linkage Disequilibrium (LD) Clumping\n        filtered_snps.sort(key=lambda s: s['p_x'])\n        retained_snps = []\n        for candidate_snp in filtered_snps:\n            is_clumped = False\n            for retained_snp in retained_snps:\n                # Check physical distance\n                if abs(candidate_snp['pos'] - retained_snp['pos']) = window_bp:\n                    # Check LD\n                    pair = frozenset([candidate_snp['id'], retained_snp['id']])\n                    r2 = ld.get(pair, 0.0)\n                    if r2 >= r2_thr:\n                        is_clumped = True\n                        break\n            if not is_clumped:\n                retained_snps.append(candidate_snp)\n\n        # 3. Allele Harmonization\n        harmonized_snps = []\n        complement = {'A': 'T', 'T': 'A', 'C': 'G', 'G': 'C'}\n        for snp in retained_snps:\n            exp_alleles = (snp['a_e'], snp['a_o'])\n            out_alleles = (snp['ap_e'], snp['ap_o'])\n            beta_y = snp['beta_y']\n            \n            is_palindromic = {snp['a_e'], snp['a_o']} in [{'A', 'T'}, {'C', 'G'}]\n            \n            if is_palindromic:\n                if L_amb = snp['eaf_x'] = U_amb:\n                    continue  # Drop ambiguous palindromic SNP\n                \n                dist1 = abs(snp['eaf_y'] - snp['eaf_x'])\n                dist2 = abs((1 - snp['eaf_y']) - snp['eaf_x'])\n\n                if dist2  dist1:\n                    beta_y = -beta_y\n                \n                harmonized_snp = snp.copy()\n                harmonized_snp['beta_y'] = beta_y\n                harmonized_snps.append(harmonized_snp)\n\n            else: # Non-palindromic\n                harmonized = False\n                # Direct and flipped match\n                if out_alleles == exp_alleles:\n                    harmonized = True\n                elif out_alleles == (exp_alleles[1], exp_alleles[0]):\n                    beta_y = -beta_y\n                    harmonized = True\n                else: # Strand complement check\n                    comp_out_alleles = (complement[out_alleles[0]], complement[out_alleles[1]])\n                    if comp_out_alleles == exp_alleles:\n                        harmonized = True\n                    elif comp_out_alleles == (exp_alleles[1], exp_alleles[0]):\n                        beta_y = -beta_y\n                        harmonized = True\n                \n                if harmonized:\n                    harmonized_snp = snp.copy()\n                    harmonized_snp['beta_y'] = beta_y\n                    harmonized_snps.append(harmonized_snp)\n\n        # 4. IVW Estimation\n        if not harmonized_snps:\n            return np.nan # Or handle as error\n        \n        if len(harmonized_snps) == 1:\n            snp = harmonized_snps[0]\n            if snp['beta_x'] == 0: return np.nan\n            return snp['beta_y'] / snp['beta_x']\n\n        numerator = 0.0\n        denominator = 0.0\n        for snp in harmonized_snps:\n            w = 1.0 / (snp['se_y'] ** 2)\n            numerator += w * snp['beta_x'] * snp['beta_y']\n            denominator += w * (snp['beta_x'] ** 2)\n        \n        if denominator == 0: return np.nan\n        return numerator / denominator\n\n    # --- Main Loop ---\n    for case_params in test_cases:\n        # Create a deep copy of the database for this run\n        current_data = [{k: v for k, v in snp.items()} for snp in snp_database]\n        \n        # Apply test-case specific modifications\n        for snp_id, modifications in case_params['mods'].items():\n            for snp in current_data:\n                if snp['id'] == snp_id:\n                    snp.update(modifications)\n                    break\n        \n        result = run_pipeline(current_data, ld_matrix, case_params)\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}