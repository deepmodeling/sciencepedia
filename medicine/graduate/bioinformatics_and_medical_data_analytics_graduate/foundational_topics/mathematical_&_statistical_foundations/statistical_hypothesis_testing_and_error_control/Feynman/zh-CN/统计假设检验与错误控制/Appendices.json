{
    "hands_on_practices": [
        {
            "introduction": "我们从生物信息学中的一个基础实践开始：非参数假设检验。本练习将指导您从零开始构建一个精确的置换检验，用于分析配对数据，例如表观基因组学中的肿瘤-正常组织比较。通过亲手实现此检验以及用于控制错误发现率的Benjamini–Hochberg程序，您将获得稳健统计推断和应对多重检验这一关键挑战的实践经验。",
            "id": "4609525",
            "problem": "您将获得患者队列的匹配肿瘤-正常组织的DNA甲基化beta值。每一对数据都包含同一患者在同一胞嘧啶-磷酸-鸟嘌呤（CpG）位点上的肿瘤及其匹配的正常组织样本。假设beta值被限定在单位区间 $[0,1]$ 内，并且在肿瘤和正常组织之间没有系统性变化的零假设下，配对是可交换的。您的任务是构建配对符号检验的置换版本，以检测配对内差异分布的变化，并通过Benjamini–Hochberg（BH）程序量化误差控制。\n\n使用的基本原理：\n- 在没有变化的零假设 $H_0$ 下，对于任何非零差异，配对内差异的符号为正或为负的可能性是相等的，并且各配对之间的符号是独立的。形式上，令 $d_i = x_i^{\\mathrm{tumor}} - x_i^{\\mathrm{normal}}$。在 $H_0$ 下，以 $\\{d_i \\neq 0\\}$为条件，符号是独立同分布的，其概率为 $\\mathbb{P}(\\mathrm{sign}(d_i) = +1) = 1/2$。$d_i = 0$ 的配对不携带关于符号的信息，因此从有效样本量中排除。\n- 在每个配对内对肿瘤和正常组织进行置换，等同于以1/2的概率独立地翻转每个非零 $d_i$ 的符号，从而给出符号计数的精确置换分布。\n- Benjamini–Hochberg程序在目标错误发现率（FDR）水平 $q$ 下，通过将排序后的p值 $p_{(k)}$ 与阈值 $(k/m)q$进行比较来拒绝假设，其中 $m$ 是一个族中检验的假设数量。\n\n检验统计量和p值的定义：\n- 令 $n$ 为非零差异的数量，令 $S$ 表示这 $n$ 个差异中正差异的数量。将双边检验统计量定义为 $T = \\lvert S - n/2 \\rvert$。\n- 在 $H_0$ 和置换不变性下，$S$ 服从参数为 $n$ 和 $1/2$ 的二项分布，即 $S \\sim \\mathrm{Binomial}(n, 1/2)$，因为 $n$ 次符号翻转是独立的且等可能的。\n- 精确的置换p值（双边）是在所有 $2^n$ 种符号翻转分配中，使得结果 $S^\\ast$ 满足 $\\lvert S^\\ast - n/2 \\rvert \\ge \\lvert S - n/2 \\rvert$ 的比例。等价地，\n$$\np = \\frac{1}{2^n} \\sum_{k=0}^{n} \\mathbf{1}\\left(\\left|k - \\frac{n}{2}\\right| \\ge \\left|S - \\frac{n}{2}\\right|\\right) \\binom{n}{k}.\n$$\n- 相等情况由一个容差 $\\tau = 10^{-12}$ 定义：任何满足 $\\lvert d_i \\rvert  \\tau$ 的差异都被视为零，并从 $n$ 中排除。\n\n您的程序必须：\n1. 实现上述的精确置换配对符号检验，以计算每个数据集中一个或多个CpG特征的双边p值。\n2. 在每个数据集中，对该数据集中各特征的p值向量应用Benjamini–Hochberg程序（目标FDR $q = 0.1$），生成一个布尔决策向量，指示哪些特征被拒绝。\n\n测试套件：\n- 使用以下三个数据集作为完整的测试套件。所有数字都是 $[0,1]$ 区间内的甲基化beta值。\n\n数据集 A（一个特征，$n_{\\mathrm{pairs}} = 8$）：\n- 正常组织： $\\,[0.65,\\,0.72,\\,0.48,\\,0.51,\\,0.40,\\,0.30,\\,0.55,\\,0.60]$\n- 肿瘤组织：  $\\,[0.70,\\,0.80,\\,0.55,\\,0.58,\\,0.50,\\,0.45,\\,0.62,\\,0.58]$\n\n数据集 B（一个特征，存在相等情况，$n_{\\mathrm{pairs}} = 10$；相等情况排除了三对，剩下 $n = 7$ 个非零差异）：\n- 正常组织： $\\,[0.40,\\,0.50,\\,0.60,\\,0.55,\\,0.20,\\,0.80,\\,0.35,\\,0.35,\\,0.90,\\,0.10]$\n- 肿瘤组织：  $\\,[0.46,\\,0.48,\\,0.60,\\,0.59,\\,0.25,\\,0.80,\\,0.33,\\,0.30,\\,0.90,\\,0.13]$\n\n数据集 C（四个特征，$n_{\\mathrm{pairs}} = 6$；列是不同的CpG特征）：\n- 正常组织矩阵（$6 \\times 4$）：\n$\\begin{bmatrix}\n0.20  0.40  0.70  0.60 \\\\\n0.30  0.45  0.50  0.40 \\\\\n0.10  0.35  0.20  0.30 \\\\\n0.25  0.55  0.60  0.50 \\\\\n0.15  0.50  0.30  0.70 \\\\\n0.40  0.60  0.80  0.65 \\\\\n\\end{bmatrix}$\n- 肿瘤组织矩阵（$6 \\times 4$）：\n$\\begin{bmatrix}\n0.25  0.46  0.75  0.58 \\\\\n0.35  0.51  0.48  0.38 \\\\\n0.15  0.41  0.25  0.28 \\\\\n0.30  0.61  0.58  0.48 \\\\\n0.20  0.56  0.28  0.68 \\\\\n0.45  0.58  0.78  0.63 \\\\\n\\end{bmatrix}$\n\n假设和约定：\n- 在判断 $\\lvert d_i \\rvert$ 是否为零时，使用容差 $\\tau = 10^{-12}$。\n- 如果 $n = 0$，则将p值定义为 $1$。\n- 对于BH程序，在每个数据集的特征族内独立使用 $q = 0.1$。\n\n要求的最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果。对于每个数据集，输出一个包含两个元素的列表：第一个元素是该数据集中所有特征按给定顺序排列的双边p值列表，第二个元素是按相同顺序排列的相应BH拒绝决策（布尔值）列表。浮点数必须四舍五入到八位小数，并且打印时不带末尾的零或末尾的小数点。\n- 具体来说，输出必须看起来像一个嵌套列表，形式为“[ [pvals_A, decisions_A], [pvals_B, decisions_B], [pvals_C, decisions_C] ]”，其中每个 pvals_X 是一个浮点数列表，每个 decisions_X 是一个布尔值列表。\n\n您的解决方案将根据科学正确性、算法严谨性、对置换分布定义的精确遵守、对相等情况的正确处理以及Benjamini–Hochberg程序的正确实现进行评估。不需要外部输入，也不涉及物理单位。在打印的输出行中，请以小数形式表示答案，而不是百分比或分数。",
            "solution": "该问题要求实现一个基于置换的配对符号检验来分析匹配的肿瘤-正常组织DNA甲基化数据，然后使用Benjamini-Hochberg（BH）程序进行多重检验校正。解决方案分为三个主要部分：为单个特征定义统计检验，为一组特征定义多重检验校正程序，以及将这些方法应用于所提供的数据集。\n\n### 1. 置换配对符号检验\n\n配对符号检验是一种非参数方法，用于评估匹配配对内差异方向的一致性。其置换版本在可交换性的零假设下提供了一个精确的p值。\n\n#### 1.1. 检验公式\n\n假设单个CpG特征的数据集由 $N$ 个匹配的beta值对 $(x_i^{\\mathrm{normal}}, x_i^{\\mathrm{tumor}})$ 组成，其中 $i = 1, \\dots, N$。\n\n首先，我们计算配对内差异：\n$$\nd_i = x_i^{\\mathrm{tumor}} - x_i^{\\mathrm{normal}}\n$$\n\n零假设 $H_0$ 假定肿瘤和正常组织值之间没有系统性变化。在 $H_0$ 下，任何非零差异 $d_i$ 的符号都是一个随机结果，其为正或为负的概率相等，即 $\\mathbb{P}(\\mathrm{sign}(d_i) = +1) = \\mathbb{P}(\\mathrm{sign}(d_i) = -1) = 1/2$。$d_i=0$ 的差异不提供关于变化方向的信息，因此被排除。由于浮点表示，如果任何差异 $d_i$ 的绝对值小于一个小的容差 $\\tau = 10^{-12}$，我们将其视为零：\n$$\nd_i \\text{ is considered zero if } \\lvert d_i \\rvert  \\tau\n$$\n\n令 $n$ 为具有非零差异的配对数量。这是检验的有效样本量。如果 $n=0$，所有差异都为零，不提供反对 $H_0$ 的证据。在这种情况下，p值定义为 $1$。\n\n对于 $n  0$，我们计算正差异的数量，记为 $S$：\n$$\nS = \\sum_{i=1}^{N} \\mathbf{1}(d_i  \\tau)\n$$\n其中 $\\mathbf{1}(\\cdot)$ 是指示函数。\n\n在 $H_0$ 下， $n$ 个非零差异中的每一个的符号都由一个成功概率为 $1/2$ 的独立伯努利试验确定。因此，正符号的总数 $S$ 服从参数为 $n$ 和 $p=1/2$ 的二项分布：\n$$\nS \\sim \\mathrm{Binomial}(n, 1/2)\n$$\n\n#### 1.2. P值计算\n\n我们使用双边检验来检测任何系统性变化，无论是正向还是负向。检验统计量是根据观测计数 $S$ 与其在 $H_0$ 下的期望值 $n/2$ 的偏差来定义的。该统计量为 $T = \\lvert S - n/2 \\rvert$。\n\np值是观测到至少与观测到的偏差一样极端的偏差的概率。这对应于对分布尾部所有结果 $k \\in \\{0, \\dots, n\\}$ 的概率求和，尾部由观测到的偏差定义。双边p值由下式给出：\n$$\np = \\mathbb{P}\\left(\\left|K - \\frac{n}{2}\\right| \\ge \\left|S - \\frac{n}{2}\\right|\\right) \\quad \\text{where } K \\sim \\mathrm{Binomial}(n, 1/2)\n$$\n使用二项分布的概率质量函数 $\\mathbb{P}(K=k) = \\binom{n}{k} (1/2)^k (1-1/2)^{n-k} = \\binom{n}{k} (1/2)^n$，p值可以计算为：\n$$\np = \\frac{1}{2^n} \\sum_{k=0}^{n} \\binom{n}{k} \\cdot \\mathbf{1}\\left(\\left|k - \\frac{n}{2}\\right| \\ge \\left|S - \\frac{n}{2}\\right|\\right)\n$$\n该公式计算了在所有 $2^n$ 种可能的符号翻转组合中，获得与观测结果 $S$ 一样极端或更极端结果的精确概率。\n\n### 2. Benjamini-Hochberg (BH) 程序\n\n当同时进行多个假设检验时（例如，每个CpG特征一个），我们必须控制假阳性风险的增加。Benjamini-Hochberg程序控制错误发现率（FDR），即所有拒绝中错误拒绝的预期比例。\n\n给定一个包含 $m$ 个p值的族 $\\{p_1, p_2, \\dots, p_m\\}$ 和一个目标FDR水平 $q$ （此处 $q=0.1$），程序如下：\n1.  将p值从小到大排序：$p_{(1)} \\le p_{(2)} \\le \\dots \\le p_{(m)}$。\n2.  找到满足以下条件的最大整数 $k$，即第 $k$ 个排序后的p值 $p_{(k)}$ 满足：\n    $$\n    p_{(k)} \\le \\frac{k}{m} q\n    $$\n3.  如果存在这样的 $k$，则拒绝与p值 $p_{(1)}, p_{(2)}, \\dots, p_{(k)}$ 对应的零假设。\n4.  如果不存在这样的 $k$，则不拒绝任何零假设。\n\n该程序独立应用于每个数据集的特征族。\n\n### 3. 应用于测试套件\n\n#### 数据集 A（1个特征，8对）\n-   正常组织： $\\,[0.65,\\,0.72,\\,0.48,\\,0.51,\\,0.40,\\,0.30,\\,0.55,\\,0.60]$\n-   肿瘤组织：  $\\,[0.70,\\,0.80,\\,0.55,\\,0.58,\\,0.50,\\,0.45,\\,0.62,\\,0.58]$\n-   差异 $d_i$: $\\,[0.05, 0.08, 0.07, 0.07, 0.1, 0.15, 0.07, -0.02]$\n-   所有 $\\lvert d_i \\rvert \\ge 10^{-12}$，因此有效样本量为 $n=8$。\n-   正差异的数量为 $S=7$。\n-   与均值的偏差为 $\\lvert S - n/2 \\rvert = \\lvert 7 - 8/2 \\rvert = 3$。\n-   我们需要找到 $K \\sim \\mathrm{Binomial}(8, 1/2)$ 的p值，即 $\\mathbb{P}(\\lvert K - 4 \\rvert \\ge 3)$。这等同于 $\\mathbb{P}(K \\le 1 \\text{ or } K \\ge 7)$。\n-   $p = \\mathbb{P}(K=0) + \\mathbb{P}(K=1) + \\mathbb{P}(K=7) + \\mathbb{P}(K=8)$。\n-   $p = \\frac{1}{2^8} \\left[ \\binom{8}{0} + \\binom{8}{1} + \\binom{8}{7} + \\binom{8}{8} \\right] = \\frac{1+8+8+1}{256} = \\frac{18}{256} = 0.0703125$。\n-   **BH程序**：$m=1$, $q=0.1$。如果 $p_{(1)} \\le (1/1)q$ 则拒绝。此处，$p = 0.0703125 \\le 0.1$，因此拒绝零假设。决策为True。\n\n#### 数据集 B（1个特征，10对）\n-   正常组织： $\\,[0.40,\\,0.50,\\,0.60,\\,0.55,\\,0.20,\\,0.80,\\,0.35,\\,0.35,\\,0.90,\\,0.10]$\n-   肿瘤组织：  $\\,[0.46,\\,0.48,\\,0.60,\\,0.59,\\,0.25,\\,0.80,\\,0.33,\\,0.30,\\,0.90,\\,0.13]$\n-   差异 $d_i$: $\\,[0.06, -0.02, 0, 0.04, 0.05, 0, -0.02, -0.05, 0, 0.03]$。\n-   有三对的 $d_i=0$，因此被排除。有效样本量为 $n=7$。\n-   非零差异为 $[0.06, -0.02, 0.04, 0.05, -0.02, -0.05, 0.03]$。\n-   正差异的数量为 $S=4$。\n-   与均值的偏差为 $\\lvert S - n/2 \\rvert = \\lvert 4 - 7/2 \\rvert = 0.5$。\n-   我们需要找到 $K \\sim \\mathrm{Binomial}(7, 1/2)$ 的p值，即 $\\mathbb{P}(\\lvert K - 3.5 \\rvert \\ge 0.5)$。这等同于 $\\mathbb{P}(K \\le 3 \\text{ or } K \\ge 4)$。这个不等式对所有可能的 $K \\in \\{0, 1, \\dots, 7\\}$ 值都成立。\n-   因此，概率和是基于分布的整个支撑集，p值为 $1$。\n-   **BH程序**：$m=1$, $q=0.1$。如果 $p \\le 0.1$ 则拒绝。此处，$p=1 \\not\\le 0.1$，因此我们未能拒绝零假设。决策为False。\n\n#### 数据集 C（4个特征，6对）\n-   该数据集有 $m=4$ 个特征，因此我们计算四个p值并应用一次BH校正。对于所有特征，配对数为 $N=6$。\n-   **特征1**：差异： $[0.05, 0.05, 0.05, 0.05, 0.05, 0.05]$。全部非零，因此 $n=6$。$S=6$。偏差为 $\\lvert 6 - 3 \\rvert = 3$。p值为 $\\mathbb{P}(\\lvert K-3 \\rvert \\ge 3)$ for $K \\sim \\mathrm{Binomial}(6, 1/2)$，所以 $\\mathbb{P}(K=0) + \\mathbb{P}(K=6) = (\\binom{6}{0} + \\binom{6}{6})/2^6 = (1+1)/64 = 2/64 = 0.03125$。\n-   **特征2**：差异： $[0.06, 0.06, 0.06, 0.06, 0.06, -0.02]$。全部非零，因此 $n=6$。$S=5$。偏差为 $\\lvert 5 - 3 \\rvert = 2$。p值为 $\\mathbb{P}(\\lvert K-3 \\rvert \\ge 2) \\implies \\mathbb{P}(K \\le 1 \\text{ or } K \\ge 5) = (\\binom{6}{0}+\\binom{6}{1}+\\binom{6}{5}+\\binom{6}{6})/64 = (1+6+6+1)/64 = 14/64 = 0.21875$。\n-   **特征3**：差异： $[0.05, -0.02, 0.05, -0.02, -0.02, -0.02]$。全部非零，因此 $n=6$。$S=2$。偏差为 $\\lvert 2 - 3 \\rvert = 1$。p值为 $\\mathbb{P}(\\lvert K-3 \\rvert \\ge 1) \\implies \\mathbb{P}(K \\le 2 \\text{ or } K \\ge 4) = (\\binom{6}{0}+\\binom{6}{1}+\\binom{6}{2}+\\binom{6}{4}+\\binom{6}{5}+\\binom{6}{6})/64 = (1+6+15+15+6+1)/64 = 44/64 = 0.6875$。\n-   **特征4**：差异： $[-0.02, -0.02, -0.02, -0.02, -0.02, -0.02]$。全部非零，因此 $n=6$。$S=0$。偏差为 $\\lvert 0 - 3 \\rvert = 3$。这与特征1的偏差相同，因此p值也为 $0.03125$。\n-   P值向量： $p = [0.03125, 0.21875, 0.6875, 0.03125]$。\n-   **BH程序**：$m=4$, $q=0.1$。\n    1.  排序后的p值： $p_{(1)}=0.03125$ （特征1或4）， $p_{(2)}=0.03125$ （特征4或1）， $p_{(3)}=0.21875$ （特征2）， $p_{(4)}=0.6875$ （特征3）。\n    2.  BH阈值 $(k/m)q$:\n        -   $k=1: (1/4) \\times 0.1 = 0.025$\n        -   $k=2: (2/4) \\times 0.1 = 0.05$\n        -   $k=3: (3/4) \\times 0.1 = 0.075$\n        -   $k=4: (4/4) \\times 0.1 = 0.1$\n    3.  找到满足 $p_{(k)} \\le (k/m)q$ 的最大 $k$：\n        -   $k=1: p_{(1)} = 0.03125 \\not\\le 0.025$。\n        -   $k=2: p_{(2)} = 0.03125 \\le 0.05$。此条件成立。\n        -   $k=3: p_{(3)} = 0.21875 \\not\\le 0.075$。\n        -   满足条件的最大 $k$ 是 $k=2$。\n    4.  决策：拒绝对应于 $p_{(1)}$ 和 $p_{(2)}$ 的假设。这些对应于特征1和特征4。\n-   按原始顺序的最终决策向量是 [True, False, False, True]。\n\n这完成了对预期结果的手动验证。实现将遵循此逻辑。",
            "answer": "```python\nimport numpy as np\nfrom scipy.special import comb\nimport math\n\ndef format_item(item):\n    \"\"\"Formats a float or bool according to the problem's specifications.\"\"\"\n    if isinstance(item, bool):\n        return str(item)\n    if isinstance(item, (int, float)):\n        # Round to 8 decimal places as per the requirement\n        rounded_item = round(item, 8)\n        # If the rounded value is an integer, represent it as such\n        if rounded_item == int(rounded_item):\n            return str(int(rounded_item))\n        # Otherwise, format to 8 places and strip trailing zeros\n        return f'{rounded_item:.8f}'.rstrip('0')\n    return str(item)\n\ndef format_nested_list(lst):\n    \"\"\"Recursively builds the output string for a nested list.\"\"\"\n    if not isinstance(lst, list):\n         return format_item(lst)\n    \n    formatted_items = [format_nested_list(item) for item in lst]\n    return f\"[{','.join(formatted_items)}]\"\n\ndef permutation_sign_test(normal_vals, tumor_vals, tau=1e-12):\n    \"\"\"\n    Computes the two-sided p-value for the permutation paired sign test.\n    \"\"\"\n    normal_vals = np.asarray(normal_vals)\n    tumor_vals = np.asarray(tumor_vals)\n    differences = tumor_vals - normal_vals\n\n    # Filter out ties (differences close to zero)\n    non_zero_diffs = differences[np.abs(differences) = tau]\n    n = len(non_zero_diffs)\n\n    if n == 0:\n        return 1.0\n\n    # Count the number of positive differences\n    S = np.sum(non_zero_diffs  0)\n    \n    # Calculate the observed deviation from the mean under H0\n    obs_deviation = abs(S - n / 2)\n    \n    # Calculate the two-sided p-value by summing probabilities in the tails\n    # of the Binomial(n, 0.5) distribution.\n    p_value = 0.0\n    for k in range(n + 1):\n        if abs(k - n / 2) = obs_deviation:\n            p_value += comb(n, k, exact=True)\n            \n    p_value /= (2**n)\n    \n    return p_value\n\ndef benjamini_hochberg(p_values, q=0.1):\n    \"\"\"\n    Applies the Benjamini-Hochberg procedure to a list of p-values.\n    \"\"\"\n    p_values = np.asarray(p_values)\n    m = len(p_values)\n    \n    if m == 0:\n        return []\n\n    # Sort p-values and keep track of original indices\n    sorted_indices = np.argsort(p_values)\n    sorted_p_values = p_values[sorted_indices]\n    \n    # Calculate BH thresholds\n    ranks = np.arange(1, m + 1)\n    bh_thresholds = (ranks / m) * q\n    \n    # Find all p-values that are below their respective BH threshold\n    below_threshold = sorted_p_values = bh_thresholds\n    \n    # Find the largest k such that p_(k) = (k/m)q\n    significant_indices = np.where(below_threshold)[0]\n    if len(significant_indices) == 0:\n        max_k_idx = -1\n    else:\n        max_k_idx = np.max(significant_indices)\n\n    # All hypotheses up to the one at max_k_idx are rejected\n    rejections = np.zeros(m, dtype=bool)\n    if max_k_idx != -1:\n        rejection_indices = sorted_indices[:max_k_idx + 1]\n        rejections[rejection_indices] = True\n        \n    return rejections.tolist()\n\ndef solve():\n    \"\"\"\n    Main function to run the analysis on all datasets and print the final result.\n    \"\"\"\n    # Define test cases\n    test_cases = {\n        \"A\": {\n            \"normal\": [[0.65, 0.72, 0.48, 0.51, 0.40, 0.30, 0.55, 0.60]],\n            \"tumor\":  [[0.70, 0.80, 0.55, 0.58, 0.50, 0.45, 0.62, 0.58]]\n        },\n        \"B\": {\n            \"normal\": [[0.40, 0.50, 0.60, 0.55, 0.20, 0.80, 0.35, 0.35, 0.90, 0.10]],\n            \"tumor\":  [[0.46, 0.48, 0.60, 0.59, 0.25, 0.80, 0.33, 0.30, 0.90, 0.13]]\n        },\n        \"C\": {\n            \"normal\": np.array([\n                [0.20, 0.40, 0.70, 0.60],\n                [0.30, 0.45, 0.50, 0.40],\n                [0.10, 0.35, 0.20, 0.30],\n                [0.25, 0.55, 0.60, 0.50],\n                [0.15, 0.50, 0.30, 0.70],\n                [0.40, 0.60, 0.80, 0.65]\n            ]).T.tolist(),\n            \"tumor\": np.array([\n                [0.25, 0.46, 0.75, 0.58],\n                [0.35, 0.51, 0.48, 0.38],\n                [0.15, 0.41, 0.25, 0.28],\n                [0.30, 0.61, 0.58, 0.48],\n                [0.20, 0.56, 0.28, 0.68],\n                [0.45, 0.58, 0.78, 0.63]\n            ]).T.tolist()\n        }\n    }\n\n    q_fdr = 0.1\n    all_results = []\n\n    for key in [\"A\", \"B\", \"C\"]:\n        case = test_cases[key]\n        p_vals = []\n        for i in range(len(case[\"normal\"])):\n            p = permutation_sign_test(case[\"normal\"][i], case[\"tumor\"][i])\n            p_vals.append(p)\n        \n        decisions = benjamini_hochberg(p_vals, q=q_fdr)\n        all_results.append([p_vals, decisions])\n\n    # Format the final output according to the specified format\n    formatted_results = [format_nested_list(res) for res in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "有效的实验设计是研究成功的关键，而统计功效分析是其基石。本练习要求您使用负二项分布模型，为差异表达研究推导并实现功效计算，该模型是分析RNA-seq数据的标准方法。通过这个练习，您将深化对样本量、生物学变异和效应大小如何共同决定实验成功率的理解。",
            "id": "4609496",
            "problem": "您正在使用负二项抽样模型对核糖核酸测序（RNA-seq）中的差异基因表达进行建模，其均值-方差关系由 $\\mathrm{Var}(Y)=\\mu+\\phi \\mu^2$ 给出。其中，$Y$ 是一个样本中某个基因的读取计数，$\\mu$ 是经过文库大小归一化后的平均计数，$\\phi$ 是离散度参数。考虑一个双组比较（处理组对对照组），其中组1有 $n_1$ 个独立重复，组2有 $n_2$ 个独立重复。设组1的基线均值为 $\\mu_1=\\mu$，组2的均值为 $\\mu_2=\\mu \\cdot 2^{\\Delta}$，其中 $\\Delta$ 是以2为底的对数倍数变化。假设重复之间和基因之间相互独立，并且已经进行了文库大小归一化，因此 $\\mu$ 在各组之间是可比的。您需要计算单个基因无差异表达的双边假设检验的统计功效，同时使用 Bonferroni 校正在族水平 $\\alpha_{\\mathrm{FWER}}$ 上控制 $m$ 个独立基因的族系误差率。\n\n从在此情境下有效的核心统计原理和定义出发，具体包括：(i) 独立观测值平均值的中心极限定理，(ii) 渐近正态估计量的平滑变换的 delta 方法，(iii) 使用渐近正态估计量及其标准误检验参数是否为零的 Wald 检验，以及 (iv) 控制族系误差率的 Bonferroni 校正，推导出一个可实现的程序，用以在真实以2为底的对数倍数变化为 $\\Delta$ 时，近似备择假设下的功效。您的推导应仅基于负二项均值-方差设定 $\\mathrm{Var}(Y)=\\mu+\\phi \\mu^2$ 和上述定义，不得假设任何非由这些原理推导出的特定快捷公式。\n\n然后，您必须在一个程序中实现这个过程，该程序针对每个测试用例，使用 Wald 统计量在每个基因的显著性水平 $\\alpha_{\\mathrm{Bonf}}=\\alpha_{\\mathrm{FWER}}/m$ 下，计算双边检验的近似功效。原假设是对数倍数变化等于零。将自然对数尺度上的倍数变化处理为 $\\beta=\\Delta \\cdot \\ln(2)$。每个测试用例的最终答案必须是一个十进制形式的实数，表示功效，并四舍五入到 $6$ 位小数。\n\n您的程序必须处理以下测试套件，其中每个测试用例被指定为一个元组 $(\\mu,\\phi,\\Delta,n_1,n_2,m,\\alpha_{\\mathrm{FWER}})$：\n\n- 测试用例 1：$(50,\\,0.1,\\,1,\\,3,\\,3,\\,20000,\\,0.05)$。\n- 测试用例 2：$(5,\\,0.2,\\,1,\\,3,\\,3,\\,20000,\\,0.05)$。\n- 测试用例 3：$(50,\\,0.1,\\,1,\\,6,\\,6,\\,20000,\\,0.05)$。\n- 测试用例 4：$(20,\\,0.1,\\,0,\\,3,\\,3,\\,10,\\,0.1)$。\n- 测试用例 5：$(100,\\,1.0,\\,1,\\,3,\\,3,\\,20000,\\,0.05)$。\n\n您的程序应产生单行输出，其中包含用方括号括起来的逗号分隔的结果列表，顺序与测试套件相同，每个功效值四舍五入到6位小数（例如，$\\left[\\text{result}_1,\\text{result}_2,\\dots\\right]$）。不应打印任何其他文本。所有角度（如有）均应以弧度为单位。所有概率和显著性水平均必须以小数形式提供和报告，而非百分比。",
            "solution": "问题要求推导并实现一个程序，用以计算 RNA-seq 实验中差异基因表达双边假设检验的统计功效。推导必须基于第一性原理：中心极限定理 (CLT)、Delta 方法、Wald 检验和 Bonferroni 校正。\n\n令 $Y_{ik}$ 为第 $k$ 组第 $i$ 个重复中单个基因的读取计数，其中 $k=1$ 代表对照组，$k=2$ 代表处理组。每组的重复数分别为 $n_1$ 和 $n_2$。假设计数服从负二项分布，其均值为 $\\mathbb{E}[Y_{ik}] = \\mu_k$，指定的均值-方差关系为 $\\mathrm{Var}(Y_{ik}) = \\mu_k + \\phi \\mu_k^2$。组均值之间的关系为 $\\mu_1 = \\mu$ 和 $\\mu_2 = \\mu \\cdot 2^{\\Delta}$，其中 $\\Delta$ 是以2为底的对数倍数变化。我们希望检验原假设 $H_0: \\Delta = 0$ 与备择假设 $H_A: \\Delta \\neq 0$。\n\n推导过程如下：\n\n**1. 样本均值的渐近分布**\n每组的样本均值是各重复读取计数的平均值：\n$$ \\bar{Y}_1 = \\frac{1}{n_1} \\sum_{i=1}^{n_1} Y_{i1} \\quad \\text{和} \\quad \\bar{Y}_2 = \\frac{1}{n_2} \\sum_{i=1}^{n_2} Y_{i2} $$\n根据中心极限定理，对于足够大的 $n_1$ 和 $n_2$，样本均值近似服从正态分布。其均值为 $\\mathbb{E}[\\bar{Y}_k] = \\mu_k$，方差为 $\\mathrm{Var}(\\bar{Y}_k) = \\frac{\\mathrm{Var}(Y_{ik})}{n_k} = \\frac{\\mu_k + \\phi \\mu_k^2}{n_k}$。\n因此，我们有：\n$$ \\bar{Y}_1 \\stackrel{\\text{approx}}{\\sim} N\\left(\\mu_1, \\frac{\\mu_1 + \\phi \\mu_1^2}{n_1}\\right) $$\n$$ \\bar{Y}_2 \\stackrel{\\text{approx}}{\\sim} N\\left(\\mu_2, \\frac{\\mu_2 + \\phi \\mu_2^2}{n_2}\\right) $$\n由于各组间的重复是独立的，$\\bar{Y}_1$ 和 $\\bar{Y}_2$ 是独立的随机变量。\n\n**2. 对数倍数变化估计量的渐近分布**\n我们感兴趣的参数是自然对数倍数变化，$\\beta = \\ln(\\mu_2/\\mu_1) = \\ln(\\mu \\cdot 2^{\\Delta} / \\mu) = \\Delta \\ln(2)$。原假设等价于 $H_0: \\beta=0$。$\\beta$ 的一个自然估计量是通过用样本均值替代真实均值得到的：\n$$ \\hat{\\beta} = \\ln(\\bar{Y}_2/\\bar{Y}_1) = \\ln(\\bar{Y}_2) - \\ln(\\bar{Y}_1) $$\n为了找到 $\\hat{\\beta}$ 的渐近分布，我们应用 Delta 方法。设函数为 $g(\\mu_1, \\mu_2) = \\ln(\\mu_2) - \\ln(\\mu_1)$。$\\hat{\\beta} = g(\\bar{Y}_1, \\bar{Y}_2)$ 的方差可近似为：\n$$ \\mathrm{Var}(\\hat{\\beta}) \\approx \\left(\\frac{\\partial g}{\\partial \\mu_1}\\right)^2 \\mathrm{Var}(\\bar{Y}_1) + \\left(\\frac{\\partial g}{\\partial \\mu_2}\\right)^2 \\mathrm{Var}(\\bar{Y}_2) $$\n偏导数为 $\\frac{\\partial g}{\\partial \\mu_1} = -1/\\mu_1$ 和 $\\frac{\\partial g}{\\partial \\mu_2} = 1/\\mu_2$。代入这些以及样本均值的方差：\n$$ \\mathrm{Var}(\\hat{\\beta}) \\approx \\left(-\\frac{1}{\\mu_1}\\right)^2 \\left(\\frac{\\mu_1 + \\phi \\mu_1^2}{n_1}\\right) + \\left(\\frac{1}{\\mu_2}\\right)^2 \\left(\\frac{\\mu_2 + \\phi \\mu_2^2}{n_2}\\right) $$\n$$ \\sigma_{\\hat{\\beta}}^2 \\equiv \\mathrm{Var}(\\hat{\\beta}) \\approx \\frac{1+\\phi\\mu_1}{n_1\\mu_1} + \\frac{1+\\phi\\mu_2}{n_2\\mu_2} = \\left(\\frac{1}{n_1\\mu_1} + \\frac{\\phi}{n_1}\\right) + \\left(\\frac{1}{n_2\\mu_2} + \\frac{\\phi}{n_2}\\right) $$\n根据 Delta 方法，$\\hat{\\beta}$ 渐近服从均值为 $\\beta$、方差为 $\\sigma_{\\hat{\\beta}}^2$ 的正态分布：\n$$ \\hat{\\beta} \\stackrel{\\text{approx}}{\\sim} N\\left(\\beta, \\sigma_{\\hat{\\beta}}^2\\right) $$\n\n**3. Wald 检验统计量**\n用于检验 $H_0: \\beta = 0$ 的 Wald 统计量构造为 $W = \\hat{\\beta} / \\mathrm{SE}(\\hat{\\beta})$，其中 $\\mathrm{SE}(\\hat{\\beta})$ 是 $\\hat{\\beta}$ 标准误的估计值。对于大样本，估计的标准误收敛于真实的标准误，即 $\\mathrm{SE}(\\hat{\\beta}) \\approx \\sigma_{\\hat{\\beta}}$。因此，在备择假设下（$\\beta \\neq 0$），该检验统计量的分布可以近似为：\n$$ W = \\frac{\\hat{\\beta}}{\\mathrm{SE}(\\hat{\\beta})} \\approx \\frac{\\hat{\\beta}}{\\sigma_{\\hat{\\beta}}} \\sim N\\left(\\frac{\\beta}{\\sigma_{\\hat{\\beta}}}, 1\\right) $$\n在原假设下（$\\beta=0$），$W \\sim N(0,1)$。\n\n**4. 功效计算**\n我们正在检验 $m$ 个独立的基因，并使用 Bonferroni 校正在水平 $\\alpha_{\\mathrm{FWER}}$ 上控制族系误差率 (FWER)。因此，每个独立基因检验的显著性水平为 $\\alpha_{\\mathrm{Bonf}} = \\alpha_{\\mathrm{FWER}}/m$。\n对于双边检验，如果 Wald 统计量的绝对值超过标准正态分布的临界值，我们就拒绝 $H_0$。临界值 $z_{\\alpha_{\\mathrm{Bonf}}/2}$ 的定义为，对于 $Z \\sim N(0,1)$，$P(Z  z_{\\alpha_{\\mathrm{Bonf}}/2}) = \\alpha_{\\mathrm{Bonf}}/2$。这等价于 $z_{\\alpha_{\\mathrm{Bonf}}/2} = \\Phi^{-1}(1 - \\alpha_{\\mathrm{Bonf}}/2)$，其中 $\\Phi$ 是标准正态累积分布函数 (CDF)。\n\n检验的功效是在备择假设为真时拒绝 $H_0$ 的概率：\n$$ \\text{Power} = P(|W|  z_{\\alpha_{\\mathrm{Bonf}}/2} \\mid H_A) = P(W  z_{\\alpha_{\\mathrm{Bonf}}/2} \\mid H_A) + P(W  -z_{\\alpha_{\\mathrm{Bonf}}/2} \\mid H_A) $$\n在 $H_A$ 下，检验统计量 $W$ 服从均值为 $\\theta = \\beta / \\sigma_{\\hat{\\beta}}$、方差为 1 的正态分布。令 $Z \\sim N(0,1)$，使得 $W = Z + \\theta$。功效为：\n$$ \\text{Power} = P(Z + \\theta  z_{\\alpha_{\\mathrm{Bonf}}/2}) + P(Z + \\theta  -z_{\\alpha_{\\mathrm{Bonf}}/2}) $$\n$$ \\text{Power} = P(Z  z_{\\alpha_{\\mathrm{Bonf}}/2} - \\theta) + P(Z  -z_{\\alpha_{\\mathrm{Bonf}}/2} - \\theta) $$\n用标准正态 CDF $\\Phi$ 表示：\n$$ \\text{Power} = \\left(1 - \\Phi(z_{\\alpha_{\\mathrm{Bonf}}/2} - \\theta)\\right) + \\Phi(-z_{\\alpha_{\\mathrm{Bonf}}/2} - \\theta) $$\n这就给出了功效近似的最终公式。\n\n**实现计划：**\n对于每个测试用例 $(\\mu, \\phi, \\Delta, n_1, n_2, m, \\alpha_{\\mathrm{FWER}})$：\n1.  计算 $\\alpha_{\\mathrm{Bonf}} = \\alpha_{\\mathrm{FWER}} / m$。\n2.  计算临界值 $z_{\\alpha_{\\mathrm{Bonf}}/2} = \\Phi^{-1}(1 - \\alpha_{\\mathrm{Bonf}}/2)$。\n3.  计算备择假设下的参数：$\\beta = \\Delta \\ln(2)$，$\\mu_1 = \\mu$，和 $\\mu_2 = \\mu \\cdot 2^\\Delta$。\n4.  计算方差 $\\sigma_{\\hat{\\beta}}^2 = \\left(\\frac{1}{n_1\\mu_1} + \\frac{\\phi}{n_1}\\right) + \\left(\\frac{1}{n_2\\mu_2} + \\frac{\\phi}{n_2}\\right)$。\n5.  计算非中心化参数 $\\theta = \\beta / \\sqrt{\\sigma_{\\hat{\\beta}}^2}$。\n6.  使用推导出的公式计算功效。\n如果 $\\Delta=0$，则 $\\beta=0$ 且 $\\theta=0$。功效公式简化为 $\\alpha_{\\mathrm{Bonf}}$，即第一类错误率，符合预期。",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Derives and implements a procedure to calculate the statistical power\n    of a Wald test for differential gene expression analysis based on a\n    negative binomial model.\n    \"\"\"\n    # Test cases defined as tuples of (mu, phi, Delta, n1, n2, m, alpha_FWER)\n    test_cases = [\n        (50, 0.1, 1, 3, 3, 20000, 0.05),\n        (5, 0.2, 1, 3, 3, 20000, 0.05),\n        (50, 0.1, 1, 6, 6, 20000, 0.05),\n        (20, 0.1, 0, 3, 3, 10, 0.1),\n        (100, 1.0, 1, 3, 3, 20000, 0.05),\n    ]\n\n    results = []\n    for case in test_cases:\n        mu, phi, Delta, n1, n2, m, alpha_fwer = case\n\n        # Step 1: Calculate the per-gene significance level using Bonferroni correction.\n        # This is the alpha level for a single hypothesis test.\n        alpha_bonf = alpha_fwer / m\n\n        # Step 2: Find the critical value for the two-sided test.\n        # This is the z-score corresponding to the tail probability alpha_bonf / 2.\n        z_crit = norm.ppf(1 - alpha_bonf / 2)\n\n        # Step 3: Calculate parameters under the alternative hypothesis.\n        # beta is the natural log-fold change.\n        beta = Delta * np.log(2)\n        mu1 = mu\n        mu2 = mu * (2**Delta)\n\n        # Step 4: Calculate the variance of the log-fold change estimator (beta_hat).\n        # This is derived using the Delta method on the function ln(Y2_bar/Y1_bar).\n        # Var(beta_hat) = Var(ln(Y2_bar) - ln(Y1_bar))\n        #               ~ (1/mu1^2)*Var(Y1_bar) + (1/mu2^2)*Var(Y2_bar)\n        # Var(Yk_bar) = (mu_k + phi*mu_k^2) / n_k\n        # After simplification: Var(beta_hat) = (1+phi*mu1)/(n1*mu1) + (1+phi*mu2)/(n2*mu2)\n        var_beta_hat = (1 / (n1 * mu1) + phi / n1) + (1 / (n2 * mu2) + phi / n2)\n        se_beta_hat = np.sqrt(var_beta_hat)\n        \n        # Step 5: Calculate the non-centrality parameter (theta) of the Wald statistic distribution\n        # under the alternative hypothesis.\n        # The Wald statistic W = beta_hat / se_beta_hat is approx. N(beta/se_beta_hat, 1).\n        if se_beta_hat  0:\n            theta = beta / se_beta_hat\n        else: # Avoid division by zero, although not expected in these cases\n            theta = 0\n\n        # Step 6: Calculate the power of the test.\n        # Power = P(|W|  z_crit | H_A)\n        #       = P(W  z_crit) + P(W  -z_crit) where W ~ N(theta, 1)\n        #       = P(Z  z_crit - theta) + P(Z  -z_crit - theta) where Z ~ N(0, 1)\n        #       = (1 - cdf(z_crit - theta)) + cdf(-z_crit - theta)\n        power = 1 - norm.cdf(z_crit - theta) + norm.cdf(-z_crit - theta)\n        \n        # Append the formatted result.\n        results.append(f\"{power:.6f}\")\n\n    # Print the final output in the required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "除了检测差异，生物信息学家通常还需要证明两种方法或分析流程在实际上是等效的。这一高级实践介绍了双单侧检验（Two One-Sided Tests, TOST）程序，这是一个用于等效性检验的正式框架。您将推导TOST的拒绝域并计算所需的样本量，从而掌握一项在方法验证和监管申报中至关重要的技能。",
            "id": "4609554",
            "problem": "一个实验室正在为临床基因表达谱分析验证两个信使核糖核酸测序 (mRNA-seq) 定量流程，分别记为流程 $A$ 和流程 $B$。对于每个生物样本，两个流程都应用于相同的原始测序数据，为一组固定的基因生成成对的表达摘要。令 $D_i$ 为每个样本在两个流程之间以2为底的对数汇总表达量的差异，定义为 $D_i = \\log_{2}(X_{iA}) - \\log_{2}(X_{iB})$，其中 $X_{iA}$ 和 $X_{iB}$ 分别是来自流程 $A$ 和流程 $B$ 的样本 $i$ 的经适当标准化的表达摘要。假设 $\\{D_i\\}_{i=1}^{n}$ 独立同分布于正态分布，其均值 $\\mu$ 和方差 $\\sigma^{2}$ 未知，并且 $\\mu$ 代表两个流程之间系统性的以2为底的对数倍数变化。\n\n监管指南要求在预先指定的以2为底的对数倍数变化边界 $\\delta  0$ 下，建立两个流程的实际等效性。目标是证明真实均值差异满足 $|\\mu|  \\delta$。该研究将使用族系I类错误率水平为 $\\alpha$ 的双单侧检验 (TOST) 程序，以控制在 $|\\mu| \\ge \\delta$ 时错误地得出等效性结论的概率。\n\n任务：\n- 从等效性假设的核心定义以及正态性条件下样本均值和样本方差的抽样分布出发，推导TOST拒绝域。该拒绝域需用样本均值 $\\bar{D}$、样本标准差 $s$、样本量 $n$、等效性边界 $\\delta$ 以及自由度为 $n-1$ 的学生t分布的上$\\alpha$分位数来表示。您的推导必须从原假设和备择假设、方差未知的单样本t统计量以及单侧临界区的排序出发，不得援引任何现成的等效性检验公式。\n- 在设计备择假设 $\\mu=0$ 下，使用基于正态分布的科学合理规划近似来近似 $\\bar{D}$ 的抽样分布，计算通过TOST在族系I类错误率水平 $\\alpha$ 下声明等效性所需达到的功效 $1-\\beta$ 的最小整数样本量 $n$。给定从先前预实验分析中获得的以下规划值：$\\delta = 0.20$ (以2为底的对数单位)，$\\sigma = 0.35$ (以2为底的对数单位)，$\\alpha = 0.05$，以及 $1-\\beta = 0.90$。报告在此近似下达到至少目标功效的最小整数 $n$。\n\n最终答案必须是单个整数 $n$。",
            "solution": "该问题包含两部分。第一部分要求推导用于等效性检验的双单侧检验 (TOST) 程序的拒绝域。第二部分要求计算达到指定功效所需的最小样本量 $n$。\n\n**第1部分：TOST拒绝域的推导**\n\n目标是建立实际等效性，其定义为真实均值差异 $\\mu$ 落在预先指定的边界 $\\delta  0$ 内。因此，等效性假设为 $|\\mu|  \\delta$，可写作 $-\\delta  \\mu  \\delta$。在假设检验的框架中，待证明的主张通常是备择假设。因此，等效性的备择假设为：\n$$H_A: -\\delta  \\mu  \\delta$$\n\n原假设 $H_0$ 是备择假设的补集。它代表流程不等效的情况：\n$$H_0: |\\mu| \\ge \\delta \\quad \\text{或等价地} \\quad H_0: \\mu \\ge \\delta \\text{ 或 } \\mu \\le -\\delta$$\n\nTOST程序通过将此复合原假设分解为两个独立的单侧原假设来处理：\n1.  $H_{01}: \\mu \\ge \\delta$ (均值差异大于或等于上等效性边界)\n2.  $H_{02}: \\mu \\le -\\delta$ (均值差异小于或等于下等效性边界)\n\n相应的备择假设是：\n1.  $H_{A1}: \\mu  \\delta$\n2.  $H_{A2}: \\mu  -\\delta$\n\n为了得出等效性结论（即拒绝总原假设 $H_0$），两个单侧原假设 $H_{01}$ 和 $H_{02}$ 都必须被拒绝。通过在水平 $\\alpha$ 下进行这两个单侧检验，族系I类错误率被控制在水平 $\\alpha$。\n\n数据由差异 $D_i \\sim N(\\mu, \\sigma^2)$ 组成，其中 $i=1, \\dots, n$。由于 $\\sigma^2$ 未知，我们使用单样本t统计量。对于原假设 $H_0: \\mu = \\mu_0$，该统计量为：\n$$T = \\frac{\\bar{D} - \\mu_0}{s/\\sqrt{n}}$$\n其中 $\\bar{D}$ 是样本均值， $s$ 是样本标准差， $n$ 是样本量。在原假设下， $T$ 服从自由度为 $n-1$ 的学生t分布。\n\n让我们推导这两个检验各自的拒绝域。\n\n**检验1（针对 $H_{01}: \\mu \\ge \\delta$）：**\n检验在原假设区域的边界进行，即 $\\mu = \\delta$。检验统计量为：\n$$T_1 = \\frac{\\bar{D} - \\delta}{s/\\sqrt{n}}$$\n备择假设为 $H_{A1}: \\mu  \\delta$。这意味着我们期望 $\\bar{D}$ 小于 $\\delta$，从而导致 $T_1$ 为负值。这是一个左尾检验。如果观察到的检验统计量小于临界值 $-t_{n-1, \\alpha}$，我们就拒绝 $H_{01}$，其中 $t_{n-1, \\alpha}$ 是自由度为 $n-1$ 的t分布的上$\\alpha$分位数。\n拒绝条件是：\n$$T_1  -t_{n-1, \\alpha} \\implies \\frac{\\bar{D} - \\delta}{s/\\sqrt{n}}  -t_{n-1, \\alpha}$$\n对 $\\bar{D}$ 进行整理，我们得到：\n$$\\bar{D}  \\delta - t_{n-1, \\alpha} \\frac{s}{\\sqrt{n}}$$\n\n**检验2（针对 $H_{02}: \\mu \\le -\\delta$）：**\n检验在原假设区域的边界进行，即 $\\mu = -\\delta$。检验统计量为：\n$$T_2 = \\frac{\\bar{D} - (-\\delta)}{s/\\sqrt{n}} = \\frac{\\bar{D} + \\delta}{s/\\sqrt{n}}$$\n备择假设为 $H_{A2}: \\mu  -\\delta$。这意味着我们期望 $\\bar{D}$ 大于 $-\\delta$，从而导致 $T_2$ 为正值。这是一个右尾检验。如果观察到的检验统计量大于临界值 $t_{n-1, \\alpha}$，我们就拒绝 $H_{02}$。\n拒绝条件是：\n$$T_2  t_{n-1, \\alpha} \\implies \\frac{\\bar{D} + \\delta}{s/\\sqrt{n}}  t_{n-1, \\alpha}$$\n对 $\\bar{D}$ 进行整理，我们得到：\n$$\\bar{D}  -\\delta + t_{n-1, \\alpha} \\frac{s}{\\sqrt{n}}$$\n\n**TOST拒绝域：**\n当且仅当 $H_{01}$ 和 $H_{02}$ 都被拒绝时，才宣告等效。因此，必须同时满足上面推导出的两个条件。总原假设 $H_0$ 的拒绝域是满足以下两个不等式的 $\\bar{D}$ 值的集合：\n$$-\\delta + t_{n-1, \\alpha} \\frac{s}{\\sqrt{n}}  \\bar{D}  \\delta - t_{n-1, \\alpha} \\frac{s}{\\sqrt{n}}$$\n这就是推导出的TOST程序的拒绝域。该条件等价于 $\\mu$ 的 $(1-2\\alpha)$ 置信区间 $[\\bar{D} - t_{n-1, \\alpha} \\frac{s}{\\sqrt{n}}, \\bar{D} + t_{n-1, \\alpha} \\frac{s}{\\sqrt{n}}]$ 完全包含在等效性区间 $(-\\delta, \\delta)$ 内。\n\n**第2部分：样本量计算**\n\n我们需要计算宣告等效性所需达到的功效至少为 $1-\\beta = 0.90$ 的最小整数样本量 $n$。该计算在设计备择假设 $\\mu=0$ 下进行，并使用正态近似。\n\n功效是在备择假设 $H_A$ 为真时拒绝原假设 $H_0$ 的概率。在这里，我们在 $\\mu=0$ 的条件下评估它。\n$$\\text{Power} = P(\\text{Reject } H_0 | \\mu=0) = P\\left(-\\delta + t_{n-1, \\alpha} \\frac{s}{\\sqrt{n}}  \\bar{D}  \\delta - t_{n-1, \\alpha} \\frac{s}{\\sqrt{n}} \\;\\Bigg|\\; \\mu=0 \\right)$$\n问题指定使用正态分布近似。这需要进行两项替换：\n1. 样本标准差 $s$ 被替换为总体标准差的规划值 $\\sigma$。\n2. t分布分位数 $t_{n-1, \\alpha}$ 被替换为标准正态分位数 $z_{\\alpha}$。\n\n功效表达式变为：\n$$\\text{Power} \\approx P\\left(-\\delta + z_{\\alpha} \\frac{\\sigma}{\\sqrt{n}}  \\bar{D}  \\delta - z_{\\alpha} \\frac{\\sigma}{\\sqrt{n}} \\;\\Bigg|\\; \\mu=0 \\right)$$\n在 $\\mu=0$ 的条件下，样本均值的抽样分布为 $\\bar{D} \\sim N(0, \\sigma^2/n)$。我们通过令 $Z = \\frac{\\bar{D} - 0}{\\sigma/\\sqrt{n}}$ 来标准化不等式，其中 $Z \\sim N(0,1)$。\n$$\\text{Power} \\approx P\\left(\\frac{-\\delta + z_{\\alpha} \\frac{\\sigma}{\\sqrt{n}}}{\\sigma/\\sqrt{n}}  Z  \\frac{\\delta - z_{\\alpha} \\frac{\\sigma}{\\sqrt{n}}}{\\sigma/\\sqrt{n}}\\right)$$\n$$\\text{Power} \\approx P\\left(-\\frac{\\delta\\sqrt{n}}{\\sigma} + z_{\\alpha}  Z  \\frac{\\delta\\sqrt{n}}{\\sigma} - z_{\\alpha}\\right)$$\n令 $\\Phi(\\cdot)$ 为标准正态分布的累积分布函数 (CDF)。该概率为：\n$$\\text{Power} \\approx \\Phi\\left(\\frac{\\delta\\sqrt{n}}{\\sigma} - z_{\\alpha}\\right) - \\Phi\\left(-\\frac{\\delta\\sqrt{n}}{\\sigma} + z_{\\alpha}\\right)$$\n使用对称性 $\\Phi(-x) = 1 - \\Phi(x)$，这可以写成：\n$$\\text{Power} \\approx \\Phi\\left(\\frac{\\delta\\sqrt{n}}{\\sigma} - z_{\\alpha}\\right) - \\left[1 - \\Phi\\left(\\frac{\\delta\\sqrt{n}}{\\sigma} - z_{\\alpha}\\right)\\right] = 2\\Phi\\left(\\frac{\\delta\\sqrt{n}}{\\sigma} - z_{\\alpha}\\right) - 1$$\n我们要求功效至少为 $1-\\beta$：\n$$2\\Phi\\left(\\frac{\\delta\\sqrt{n}}{\\sigma} - z_{\\alpha}\\right) - 1 \\ge 1-\\beta$$\n$$2\\Phi\\left(\\frac{\\delta\\sqrt{n}}{\\sigma} - z_{\\alpha}\\right) \\ge 2-\\beta$$\n$$\\Phi\\left(\\frac{\\delta\\sqrt{n}}{\\sigma} - z_{\\alpha}\\right) \\ge 1-\\frac{\\beta}{2}$$\n根据标准正态分位数 $z_{\\beta/2}$ 的定义，这意味着：\n$$\\frac{\\delta\\sqrt{n}}{\\sigma} - z_{\\alpha} \\ge z_{\\beta/2}$$\n求解 $\\sqrt{n}$：\n$$\\frac{\\delta\\sqrt{n}}{\\sigma} \\ge z_{\\alpha} + z_{\\beta/2} \\implies \\sqrt{n} \\ge \\frac{(z_{\\alpha} + z_{\\beta/2})\\sigma}{\\delta}$$\n两边平方，得到所需样本量的公式：\n$$n \\ge \\frac{(z_{\\alpha} + z_{\\beta/2})^2 \\sigma^2}{\\delta^2}$$\n现在，我们代入给定的规划值：\n-   等效性边界: $\\delta = 0.20$\n-   标准差: $\\sigma = 0.35$\n-   族系I类错误率: $\\alpha = 0.05$\n-   目标功效: $1-\\beta = 0.90$，这意味着 $\\beta = 0.10$\n\n我们需要相应的正态分位数：\n-   $z_{\\alpha} = z_{0.05}$ 是使 $\\Phi(z_{0.05}) = 1-0.05 = 0.95$ 的值。$z_{0.05} \\approx 1.64485$。\n-   $z_{\\beta/2} = z_{0.10/2} = z_{0.05}$。所以，$z_{\\beta/2} \\approx 1.64485$。\n\n将这些值代入样本量公式：\n$$n \\ge \\frac{(1.64485 + 1.64485)^2 (0.35)^2}{(0.20)^2}$$\n$$n \\ge \\frac{(2 \\times 1.64485)^2 (0.1225)}{0.04}$$\n$$n \\ge \\frac{(3.2897)^2 (0.1225)}{0.04}$$\n$$n \\ge \\frac{10.8221 \\times 0.1225}{0.04}$$\n$$n \\ge \\frac{1.32571}{0.04}$$\n$$n \\ge 33.14275$$\n由于样本量 $n$ 必须是整数，我们必须向上取整到下一个整数，以确保功效至少达到目标水平。\n最小整数样本量为 $n=34$。",
            "answer": "$$\\boxed{34}$$"
        }
    ]
}