{
    "hands_on_practices": [
        {
            "introduction": "本练习提供了检验哈迪-温伯格平衡（Hardy-Weinberg equilibrium, HWE）的基础实践。您将对一份样本数据集应用经典的皮尔逊卡方拟合优度检验，这是群体遗传学中评估观测基因型频率是否显著偏离随机交配预期的核心方法。掌握此检验对于遗传学研究中的质量控制和初步数据探索至关重要。",
            "id": "4595871",
            "problem": "一项基于生物样本库的医学基因组学研究，在一个包含 $N=500$ 名无亲缘关系个体的队列中，对一个具有等位基因 $A$ 和 $a$ 的双等位基因单核苷酸多态性进行了基因分型。观测到的基因型计数为 $n_{AA}=280$，$n_{Aa}=160$ 和 $n_{aa}=60$。假设基因型的底层抽样机制在个体间是独立的，并且在给定群体中等位基因 $A$ 的频率为 $p$ 的条件下，基因型计数来自一个多项式抽样模型，其单元格概率由哈迪-温伯格平衡（HWE）原理所决定，该原理适用于一个没有突变、迁移或选择的大型封闭群体中的随机交配。\n\n仅从以下核心定义出发：(i) 等位基因频率是样本所携带的等位基因的比例，(ii) 在 HWE 条件下，基因型概率是由配子随机结合决定的关于 $p$ 和 $q=1-p$ 的函数，(iii) 在多项式模型下，期望计数等于样本量乘以相应的单元格概率：\n\n1. 使用观测到的基因型计数，推导等位基因 $A$ 频率的最大似然估计 $\\hat{p}$。\n2. 使用 $\\hat{p}$，计算此样本中在 HWE 条件下 $AA$、$Aa$ 和 $aa$ 的期望基因型计数。\n3. 使用适用于带有一个拟合参数的多项式模型的皮尔逊卡方拟合优度检验框架，计算用于比较观测计数与其 HWE 期望计数的检验统计量。\n\n简要评论观测计数与期望计数之间的差异是可信地归因于 HWE 条件下的抽样变异，还是更可能反映了模型失配（例如，近亲繁殖、群体结构或其他偏离 HWE 的情况）。在你的评论中，请将你的推理建立在样本规模和偏差形式的基础上。\n\n仅报告皮尔逊卡方检验统计量作为最终答案，并四舍五入到 $4$ 位有效数字。将最终结果表示为一个无单位的纯数。",
            "solution": "将通过首先提取给定信息，然后根据科学合理性和完整性的既定标准进行审查，来验证该问题。\n\n### 问题验证\n\n#### 步骤 1：提取已知信息\n- 样本量：$N=500$ 名无亲缘关系的个体。\n- 观测基因型计数：$n_{AA}=280$，$n_{Aa}=160$，$n_{aa}=60$。\n- 位点是一个具有等位基因 $A$ 和 $a$ 的双等位基因单核苷酸多态性。\n- 等位基因 $A$ 的频率用 $p$ 表示。\n- 抽样模型为多项式模型。\n- 该模型假设哈迪-温伯格平衡（HWE），这意味着基因型概率为 $P(AA)=p^2$，$P(Aa)=2p(1-p)$ 和 $P(aa)=(1-p)^2$。\n\n#### 步骤 2：使用提取的已知信息进行验证\n1.  **科学或事实合理性**：该问题基于群体遗传学的基本原理，特别是哈迪-温伯格平衡，并采用标准统计方法（最大似然估计、皮尔逊卡方检验）进行参数估计和模型拟合。这些概念在科学上是合理的。\n2.  **适定性**：问题要求计算最大似然估计、期望计数和检验统计量。这些都是明确定义的量，可以从所提供的数据和模型假设中唯一确定。\n3.  **客观性**：问题以精确、定量和无偏见的语言陈述。\n4.  **不完整或矛盾的设置**：给定的基因型计数之和等于总样本量：$n_{AA} + n_{Aa} + n_{aa} = 280 + 160 + 60 = 500 = N$。该问题提供了所有必要的信息，并且内部一致。\n5.  **不切实际或不可行**：对于生物样本库研究来说，观测到的计数和样本量是现实的。不存在物理上或科学上的不可能性。\n\n#### 步骤 3：结论与行动\n问题是有效的，因为它在科学上是合理的、适定的、客观的且内部一致的。现在将提供完整的解决方案。\n\n### 解答\n\n解答按要求分为三个部分呈现：推导等位基因频率的最大似然估计，计算 HWE 条件下的期望基因型计数，以及计算卡方检验统计量。\n\n#### 1. $p$ 的最大似然估计（MLE）的推导\n\n问题要求从第一性原理进行推导。在 HWE 假设下，基因型 $AA$、$Aa$ 和 $aa$ 的概率分别为 $p^2$、$2pq$ 和 $q^2$，其中 $q = 1-p$。观测计数 $(n_{AA}, n_{Aa}, n_{aa})$ 被假定服从一个多项式分布，其参数为 $N$ 和概率 $(p^2, 2p(1-p), (1-p)^2)$。\n\n似然函数 $L(p)$ 与在参数 $p$ 给定的条件下观测到给定数据的概率成正比：\n$$L(p | n_{AA}, n_{Aa}, n_{aa}) \\propto (P(AA))^{n_{AA}} (P(Aa))^{n_{Aa}} (P(aa))^{n_{aa}}$$\n代入 HWE 概率：\n$$L(p) \\propto (p^2)^{n_{AA}} (2p(1-p))^{n_{Aa}} ((1-p)^2)^{n_{aa}}$$\n为了最大化，我们可以忽略常数因子 $2^{n_{Aa}}$：\n$$L(p) \\propto p^{2n_{AA}} p^{n_{Aa}} (1-p)^{n_{Aa}} (1-p)^{2n_{aa}}$$\n$$L(p) \\propto p^{2n_{AA} + n_{Aa}} (1-p)^{n_{Aa} + 2n_{aa}}$$\n\n为了找到使 $L(p)$ 最大化的 $p$ 值，我们使用对数似然函数 $\\ell(p) = \\ln(L(p))$：\n$$\\ell(p) = C + (2n_{AA} + n_{Aa})\\ln(p) + (n_{Aa} + 2n_{aa})\\ln(1-p)$$\n其中 $C$ 是一个常数。我们对 $\\ell(p)$ 关于 $p$ 求导，并将导数设为零：\n$$\\frac{d\\ell}{dp} = \\frac{2n_{AA} + n_{Aa}}{p} - \\frac{n_{Aa} + 2n_{aa}}{1-p} = 0$$\n求解 $p$：\n$$\\frac{2n_{AA} + n_{Aa}}{p} = \\frac{n_{Aa} + 2n_{aa}}{1-p}$$\n$$(1-p)(2n_{AA} + n_{Aa}) = p(n_{Aa} + 2n_{aa})$$\n$$2n_{AA} + n_{Aa} - p(2n_{AA} + n_{Aa}) = p(n_{Aa} + 2n_{aa})$$\n$$2n_{AA} + n_{Aa} = p(2n_{AA} + n_{Aa} + n_{Aa} + 2n_{aa}) = p(2n_{AA} + 2n_{Aa} + 2n_{aa})$$\n$$2n_{AA} + n_{Aa} = p \\cdot 2(n_{AA} + n_{Aa} + n_{aa}) = p \\cdot 2N$$\n因此，最大似然估计 $\\hat{p}$ 为：\n$$\\hat{p} = \\frac{2n_{AA} + n_{Aa}}{2N}$$\n这个结果证实了最大似然估计与通过直接计算样本中等位基因数目所得的等位基因频率是等价的。\n\n使用给定的计数 ($n_{AA}=280$，$n_{Aa}=160$，$N=500$)：\n$$\\hat{p} = \\frac{2(280) + 160}{2(500)} = \\frac{560 + 160}{1000} = \\frac{720}{1000} = 0.72$$\n\n#### 2. HWE 期望基因型计数\n\n使用 MLE $\\hat{p} = 0.72$，我们得到等位基因 $a$ 的频率：\n$$\\hat{q} = 1 - \\hat{p} = 1 - 0.72 = 0.28$$\n在 HWE 条件下的期望基因型比例为：\n$$P(AA) = \\hat{p}^2 = (0.72)^2 = 0.5184$$\n$$P(Aa) = 2\\hat{p}\\hat{q} = 2(0.72)(0.28) = 0.4032$$\n$$P(aa) = \\hat{q}^2 = (0.28)^2 = 0.0784$$\n在一个大小为 $N=500$ 的样本中，期望基因型计数 ($E$) 为：\n$$E_{AA} = N \\times P(AA) = 500 \\times 0.5184 = 259.2$$\n$$E_{Aa} = N \\times P(Aa) = 500 \\times 0.4032 = 201.6$$\n$$E_{aa} = N \\times P(aa) = 500 \\times 0.0784 = 39.2$$\n\n#### 3. 皮尔逊卡方检验统计量\n\n皮尔逊卡方 ($\\chi^2$) 统计量计算为观测 ($O$) 计数与期望 ($E$) 计数之差的平方，再除以期望计数，然后将各项求和：\n$$\\chi^2 = \\sum_{i \\in \\{AA, Aa, aa\\}} \\frac{(O_i - E_i)^2}{E_i}$$\n观测计数为 $O_{AA}=280$，$O_{Aa}=160$ 和 $O_{aa}=60$。\n$$\\chi^2 = \\frac{(280 - 259.2)^2}{259.2} + \\frac{(160 - 201.6)^2}{201.6} + \\frac{(60 - 39.2)^2}{39.2}$$\n$$\\chi^2 = \\frac{(20.8)^2}{259.2} + \\frac{(-41.6)^2}{201.6} + \\frac{(20.8)^2}{39.2}$$\n$$\\chi^2 = \\frac{432.64}{259.2} + \\frac{1730.56}{201.6} + \\frac{432.64}{39.2}$$\n$$\\chi^2 \\approx 1.66914 + 8.58413 + 11.03673 \\approx 21.28999$$\n四舍五入到 $4$ 位有效数字，检验统计量为 $21.29$。\n\n#### 对结果的评述\n此拟合优度检验的自由度由 $df = (\\text{基因型类别数}) - 1 - (\\text{估计的参数个数})$ 给出。在这里，$df = 3 - 1 - 1 = 1$。在常规显著性水平 $\\alpha=0.05$ 下，自由度为 $1$ 的 $\\chi^2$ 分布的临界值为 $3.84$。我们计算出的统计量 $\\chi^2 \\approx 21.29$ 远超过这个阈值。这表明，仅仅由于随机抽样变异而观测到如此大的偏离 HWE 期望的概率是极低的（$p \\ll 0.001$）。因此，这种差异强烈表明 HWE 模型对该数据拟合不佳。\n\n偏差的形式为其根本原因提供了线索。我们观察到杂合子缺失（$O_{Aa}=160$ vs. $E_{Aa}=201.6$）以及两种纯合子类型相应的过量（$O_{AA}=280$ vs. $E_{AA}=259.2$ 和 $O_{aa}=60$ vs. $E_{aa}=39.2$）。这种特定模式是导致纯合度高于随机交配期望的过程的典型特征，例如近亲繁殖（血缘婚配）或群体亚结构（瓦伦德效应，即样本是具有不同等位基因频率的多个不同亚群体的混合体）。考虑到样本量很大，这种偏差并非统计上的偶然，而是强有力的证据，表明该群体中一项或多项 HWE 假设遭到了违背。",
            "answer": "$$\\boxed{21.29}$$"
        },
        {
            "introduction": "在基础卡方检验之上，本练习深入探讨了更为稳健的HWE精确检验，这在分析稀有变异时至关重要，因为此时渐近近似方法会失效。通过从第一性原理出发实现该检验，您将对条件检验框架和精确p值的逻辑获得深刻的实践理解。这项计算练习可直接应用于现代全基因组关联研究的质量控制流程。",
            "id": "4595920",
            "problem": "您需要为一个双等位基因座实现哈迪-温伯格平衡（HWE）的精确条件检验。该检验必须以观测到的等位基因计数为条件，并枚举在HWE原假设下杂合子计数的分布。背景设定为一个包含 $n$ 个个体的二倍体样本，其基因型计数分别为 $n_{\\text{AA}}$、$n_{\\text{Aa}}$ 和 $n_{\\text{aa}}$，其中两个等位基因表示为 $\\text{A}$ 和 $\\text{a}$，且 $n_{\\text{AA}} + n_{\\text{Aa}} + n_{\\text{aa}} = n$。原假设是该群体处于哈迪-温伯格平衡（HWE）状态，即随机交配，并且不存在如选择、突变、迁移或基因分型错误等会改变基因型频率（超出仅由等位基因频率决定的范围）的作用力。\n\n基本原理：在HWE下，群体中的基因型频率仅由等位基因频率决定，在一个样本中，它们遵循多项式模型。当以在 $2n$ 个基因拷贝中观测到的等位基因 $\\text{A}$ 的计数 $n_{\\text{A}} = 2 n_{\\text{AA}} + n_{\\text{Aa}}$ 为条件时，这 $n_{\\text{A}}$ 个拷贝如何配对形成 $n$ 个二倍体基因型的分布由基因拷贝的随机配对决定。在随机交配下，将 $2n$ 个基因拷贝配对成 $n$ 个无序对的所有方式都是等可能的。\n\n任务要求：\n- 从上述定义和假设出发，推导与固定的等位基因计数 $n_{\\text{A}}$ 和样本量 $n$ 兼容的杂合子计数 $h$ 的允许集合，并推导在HWE下杂合子计数 $H$ 的条件概率质量函数，即对于每个允许的 $h$，计算概率 $\\Pr(H = h \\mid n_{\\text{A}}, n)$。\n- 实现一个程序，为每个测试用例计算：\n  1. 基于概率度量的精确双边p值，定义为在原假设下，所有概率小于或等于观测到的杂合子计数 $h_{\\text{obs}}$ 的概率的所有允许结果的概率之和。形式上，如果 $p(h)$ 表示 $\\Pr(H = h \\mid n_{\\text{A}}, n)$，则计算 $\\sum_{h : p(h) \\leq p(h_{\\text{obs}})} p(h)$，结果为 $[0,1]$ 内的一个实数。\n  2. 相应的mid-$P$双边p值，定义为 $\\sum_{h : p(h)  p(h_{\\text{obs}})} p(h) + \\tfrac{1}{2} p(h_{\\text{obs}})$，表示为 $[0,1]$ 内的一个实数。\n- 对于每个测试用例，两个p值都必须以十进制数形式返回，而不是百分比。\n\n设计细节：\n- 使用随机交配原则，通过枚举所有受 $n_{\\text{A}}$ 和 $n$ 蕴含的约束条件限制的可行杂合子计数 $h$，并计算产生给定 $h$ 的等概率分配方式的数量，来推导条件分布。不要使用渐近近似；计算必须通过在对数域中工作来达到机器精度级别的精确性，以避免数值溢出。\n- 确保程序能正确处理退化情况，包括所有基因拷贝都是相同等位基因的单态样本。请注意，由于分布的离散性，精确双边p值是保守的，在某些情况下mid-$P$值可能更可取；您的解决方案应解释何时属于这种情况。\n\n测试集：\n为以下五个测试用例提供结果，每个用例由 $(n_{\\text{AA}}, n_{\\text{Aa}}, n_{\\text{aa}})$ 指定：\n1. $(30, 10, 10)$，其中 $n = 50$，$n_{\\text{A}} = 2 \\cdot 30 + 10 = 70$。\n2. $(0, 10, 0)$，其中 $n = 10$，$n_{\\text{A}} = 2 \\cdot 0 + 10 = 10$。\n3. $(20, 0, 0)$，其中 $n = 20$，$n_{\\text{A}} = 2 \\cdot 20 + 0 = 40$（单态）。\n4. $(1, 3, 1)$，其中 $n = 5$，$n_{\\text{A}} = 2 \\cdot 1 + 3 = 5$。\n5. $(40, 4, 6)$，其中 $n = 50$，$n_{\\text{A}} = 2 \\cdot 40 + 4 = 84$。\n\n最终输出格式：\n您的程序应生成单行输出，按顺序包含五个测试用例的精确双边p值和mid-$P$双边p值，平铺成一个列表。也就是说，输出必须是 `[p_{1,\\text{exact}}, p_{1,\\text{mid}}, p_{2,\\text{exact}}, p_{2,\\text{mid}}, p_{3,\\text{exact}}, p_{3,\\text{mid}}, p_{4,\\text{exact}}, p_{4,\\text{mid}}, p_{5,\\text{exact}}, p_{5,\\text{mid}}]` 形式的单个Python风格列表，其中每个条目都是 $[0,1]$ 内的实数。",
            "solution": "我们从哈迪-温伯格平衡（HWE）原理开始。在HWE下，基因型频率由等位基因频率决定，在一个有限样本中，基因型计数遵循基于这些频率的多项式分布。当以在 $2n$ 个基因拷贝中观测到的等位基因计数 $n_{\\text{A}}$ 为条件时，随机交配假设意味着将 $n_{\\text{A}}$ 个等位基因 $\\text{A}$ 的拷贝分配到 $2n$ 个基因拷贝槽中的所有方式都是等可能的，并且基因拷贝被均匀随机地配对成 $n$ 个无序的二倍体基因型。因此，给定 $n_{\\text{A}}$ 的条件下基因型计数的条件分布，是通过计算产生特定配置的等概率配对数量得出的。\n\n设观测到的基因型为 $n_{\\text{AA}}$、$n_{\\text{Aa}}$ 和 $n_{\\text{aa}}$，其中 $n_{\\text{AA}} + n_{\\text{Aa}} + n_{\\text{aa}} = n$ 且 $n_{\\text{A}} = 2 n_{\\text{AA}} + n_{\\text{Aa}}$。在条件框架下，仅需考虑杂合子计数 $H = n_{\\text{Aa}}$。对于任何固定的 $n$ 和 $n_{\\text{A}}$，杂合子计数 $h$ 唯一地决定了纯合子计数：\n$$\nn_{\\text{AA}}(h) = \\frac{n_{\\text{A}} - h}{2}, \\quad n_{\\text{aa}}(h) = \\frac{2n - n_{\\text{A}} - h}{2}.\n$$\n这些必须是非负整数，这对 $h$ 施加了以下约束：\n1. $h$ 必须是与 $n_{\\text{A}}$ 具有相同奇偶性的整数（这样 $n_{\\text{A}} - h$ 和 $2n - n_{\\text{A}} - h$ 都是偶数）。\n2. $0 \\leq h \\leq \\min(n_{\\text{A}}, 2n - n_{\\text{A}})$（以确保 $n_{\\text{AA}}(h) \\geq 0$ 和 $n_{\\text{aa}}(h) \\geq 0$）。\n\n因此，$h$ 值的允许集合为\n$$\n\\mathcal{H} = \\{ h \\in \\mathbb{Z} : h \\equiv n_{\\text{A}} \\ (\\text{mod } 2), \\ 0 \\leq h \\leq \\min(n_{\\text{A}}, 2n - n_{\\text{A}}) \\}.\n$$\n在随机交配和以 $n_{\\text{A}}$ 为条件的假设下，将 $n_{\\text{A}}$ 个等位基因 $\\text{A}$ 的拷贝分配到 $2n$ 个槽中的所有方式都是等可能的，因此总的分配方式数量为 $\\binom{2n}{n_{\\text{A}}}$。对于一个给定的允许值 $h$，产生恰好 $n_{\\text{AA}}(h)$ 个 $\\text{AA}$ 纯合子、$h$ 个杂合子和 $n_{\\text{aa}}(h)$ 个 $\\text{aa}$ 纯合子的分配方式数量为\n$$\nW(h) = \\frac{n!}{n_{\\text{AA}}(h)! \\, h! \\, n_{\\text{aa}}(h)!} \\cdot 2^{h}.\n$$\n因子 $2^{h}$ 是因为每个杂合基因型 $\\text{Aa}$ 可由基因对内一个 $\\text{A}$ 基因拷贝和一个 $\\text{a}$ 基因拷贝的两种不同分配方式形成，而纯合子对只有一种分配方式。因此，在HWE下，给定 $n_{\\text{A}}$ 和 $n$ 时 $H$ 的条件概率质量函数为\n$$\np(h) = \\Pr(H = h \\mid n, n_{\\text{A}}) = \\frac{W(h)}{\\sum_{h' \\in \\mathcal{H}} W(h')},\n$$\n这可以等价地写成 $p(h) = W(h) / \\binom{2n}{n_{\\text{A}}}$，但通过用总和 $\\sum_{h' \\in \\mathcal{H}} W(h')$ 对 $W(h)$ 进行归一化来计算，在数值上是稳定的，并避免了直接处理非常大的二项式系数。\n\n给定一个观测到的杂合子计数 $h_{\\text{obs}} = n_{\\text{Aa}}$，基于概率度量的精确双边p值（通常被推荐用于避免离散设置下双边检验的尾部选择模糊性）计算如下\n$$\np_{\\text{exact}} = \\sum_{h \\in \\mathcal{H} : p(h) \\leq p(h_{\\text{obs}})} p(h).\n$$\nmid-$P$双边p值被定义用来减少由离散性引起的保守性：\n$$\np_{\\text{mid}} = \\sum_{h \\in \\mathcal{H} : p(h)  p(h_{\\text{obs}})} p(h) + \\frac{1}{2} p(h_{\\text{obs}}) = p_{\\text{exact}} - \\frac{1}{2} p(h_{\\text{obs}}).\n$$\n$p_{\\text{exact}}$ 和 $p_{\\text{mid}}$ 都在 $[0,1]$ 区间内，尽管 $p_{\\text{mid}}$ 可能严格小于 $p_{\\text{exact}}$。在退化情况下，即 $\\mathcal{H}$ 只包含一个值（例如，单态样本），则有 $p(h_{\\text{obs}}) = 1$，这导致 $p_{\\text{exact}} = 1$ 和 $p_{\\text{mid}} = \\tfrac{1}{2}$。\n\n算法设计：\n1. 对于每个测试用例，计算 $n = n_{\\text{AA}} + n_{\\text{Aa}} + n_{\\text{aa}}$、$n_{\\text{A}} = 2 n_{\\text{AA}} + n_{\\text{Aa}}$ 和 $h_{\\text{obs}} = n_{\\text{Aa}}$。\n2. 使用奇偶性和边界枚举 $\\mathcal{H}$：如果 $n_{\\text{A}}$ 是偶数，则设 $h_{\\min}$ 为 $0$，如果是奇数则为 $1$；$h_{\\max} = \\min(n_{\\text{A}}, 2n - n_{\\text{A}})$；然后以步长 $2$ 从 $h_{\\min}$ 到 $h_{\\max}$ 列出 $h$。\n3. 对于每个 $h \\in \\mathcal{H}$，计算 $n_{\\text{AA}}(h)$ 和 $n_{\\text{aa}}(h)$，然后使用对数阶乘恒等式 $\\log(k!) = \\log\\Gamma(k+1)$ 计算 $\\log W(h)$ 以避免溢出。具体来说，\n$$\n\\log W(h) = \\log(n!) - \\log(n_{\\text{AA}}(h)!) - \\log(h!) - \\log(n_{\\text{aa}}(h)!) + h \\log 2.\n$$\n4. 通过log-sum-exp计算进行归一化以获得 $p(h)$：如果 $\\ell(h) = \\log W(h)$，那么\n$$\np(h) = \\exp\\left(\\ell(h) - \\log\\left(\\sum_{h' \\in \\mathcal{H}} \\exp(\\ell(h'))\\right)\\right),\n$$\n这可使用标准的log-sum-exp技巧来稳定地实现。\n5. 通过对所有满足 $p(h) \\leq p(h_{\\text{obs}})$ 的 $h$ 求和 $p(h)$ 来计算 $p_{\\text{exact}}$，并计算 $p_{\\text{mid}} = p_{\\text{exact}} - \\tfrac{1}{2} p(h_{\\text{obs}})$。\n6. 为每个测试用例返回配对 $(p_{\\text{exact}}, p_{\\text{mid}})$。\n\n何时mid-$P$更优：\n在精确p值因检验统计量的离散性而过于保守的大规模离散检验场景中，mid-$P$通常是更优的选择。在跨越许多位点（例如，全基因组关联研究或基因型的质量控制）的群体遗传学分析中，精确检验的保守性会降低检测与HWE真实偏离（特别是暗示基因分型错误或近亲繁殖的杂合子缺失）的统计功效。Mid-$P$通过有效切分观测结果的概率质量来降低这种保守性，从而更好地校准I型错误率并提高统计功效，同时保留了精确的有限样本枚举。然而，mid-$P$并非一致保守，可能不适用于区间估计场景，或在小样本中需要严格控制族系错误率（family-wise error rate）时。在只有一个允许结果的退化情况下（例如，单态数据），mid-$P$产生0.5，而精确p值为1.0，这突出表明在这种边界条件下应谨慎解释mid-$P$。\n\n最终的程序实现了上述算法，并为指定的测试集输出一个包含精确双边p值和mid-$P$双边p值的单行扁平化列表，格式符合要求。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import gammaln, logsumexp\n\ndef hwe_exact_pvalues(n_AA, n_Aa, n_aa):\n    \"\"\"\n    Compute the exact two-sided probability-based p-value and mid-P p-value\n    for Hardy–Weinberg equilibrium by conditioning on the allele count and\n    enumerating the distribution of heterozygotes.\n\n    Parameters:\n        n_AA (int): Count of AA homozygotes\n        n_Aa (int): Count of Aa heterozygotes\n        n_aa (int): Count of aa homozygotes\n\n    Returns:\n        (float, float): (p_exact_two_sided, p_mid_two_sided)\n    \"\"\"\n    n = n_AA + n_Aa + n_aa\n    n_A = 2 * n_AA + n_Aa\n    h_obs = n_Aa\n\n    # Determine admissible heterozygote counts h with correct parity and bounds.\n    h_min = n_A % 2  # 0 if even, 1 if odd\n    h_max = min(n_A, 2 * n - n_A)\n    if h_min > h_max:\n        # No admissible configurations: should not happen with valid counts, but guard anyway.\n        return (1.0, 0.5)\n\n    # Enumerate admissible h values: step of 2 to respect parity.\n    H_vals = np.arange(h_min, h_max + 1, 2, dtype=int)\n\n    # Compute log-weights log W(h) using gammaln for log-factorials: log(k!) = gammaln(k+1).\n    log_weights = []\n    for h in H_vals:\n        n_AA_h = (n_A - h) // 2\n        n_aa_h = (2 * n - n_A - h) // 2\n        # Sanity checks: nonnegative integers\n        if n_AA_h  0 or n_aa_h  0:\n            log_weights.append(-np.inf)\n            continue\n        # log W(h) = log(n!) - log(n_AA_h!) - log(h!) - log(n_aa_h!) + h * log(2)\n        lw = (gammaln(n + 1)\n              - gammaln(n_AA_h + 1)\n              - gammaln(h + 1)\n              - gammaln(n_aa_h + 1)\n              + h * np.log(2.0))\n        log_weights.append(lw)\n    log_weights = np.array(log_weights, dtype=float)\n\n    # Convert to probabilities via log-sum-exp normalization.\n    logZ = logsumexp(log_weights)\n    # Handle degenerate cases where all log_weights are -inf (should not happen)\n    if not np.isfinite(logZ):\n        # Return neutral values\n        return (1.0, 0.5)\n\n    probs = np.exp(log_weights - logZ)\n\n    # Find observed probability p(h_obs).\n    # h_obs must be in H_vals; if not, the configuration is impossible under the conditioning.\n    try:\n        idx_obs = int(np.where(H_vals == h_obs)[0][0])\n    except IndexError:\n        # Impossible observed h under the conditioning; return extreme p-values.\n        # This should not occur with internally consistent inputs.\n        return (0.0, 0.0)\n\n    p_obs = probs[idx_obs]\n\n    # Exact two-sided probability-based p-value: sum of probs = p_obs.\n    p_exact = float(np.sum(probs[probs = p_obs]))\n\n    # Mid-P two-sided p-value: subtract half of the observed probability mass.\n    p_mid = p_exact - 0.5 * p_obs\n\n    # Numerical safety: clip to [0,1]\n    p_exact = min(max(p_exact, 0.0), 1.0)\n    p_mid = min(max(p_mid, 0.0), 1.0)\n\n    return (p_exact, p_mid)\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each tuple is (n_AA, n_Aa, n_aa)\n    test_cases = [\n        (30, 10, 10),  # n=50, n_A=70\n        (0, 10, 0),    # n=10, n_A=10 (maximum heterozygosity)\n        (20, 0, 0),    # n=20, n_A=40 (monomorphic)\n        (1, 3, 1),     # n=5,  n_A=5 (odd parity case)\n        (40, 4, 6),    # n=50, n_A=84 (heterozygote deficiency)\n    ]\n\n    results = []\n    for n_AA, n_Aa, n_aa in test_cases:\n        p_exact, p_mid = hwe_exact_pvalues(n_AA, n_Aa, n_aa)\n        results.append(p_exact)\n        results.append(p_mid)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "最后的这项练习将重点从假设检验转向理论建模，这是解读基因组数据的一项关键技能。您将推导一种常见的人为因素——系统性基因分型错误——对HWE检验统计量的解析影响。该练习展示了如何对现实世界的过程进行数学建模并预测其在数据中的特征，从而更深入地理解为何一个群体会表现出对HWE的偏离。",
            "id": "4595878",
            "problem": "一个单核苷酸多态性是双等位基因的，其等位基因为 $A$ 和 $a$。在真实群体中，该基因座处于哈代-温伯格平衡（HWE）状态，即基因型频率为：$AA$ 的概率为 $p^2$，$Aa$ 的概率为 $2pq$，$aa$ 的概率为 $q^2$，其中 $p$ 是 $A$ 的真实等位基因频率，$q = 1 - p$ 是 $a$ 的真实等位基因频率。一个从高通量数据中鉴定基因型的生物信息学流程引入了一种系统性的基因分型错误，该错误仅影响真实的杂合子：对于每个 $Aa$ 个体，杂合子以概率 $\\epsilon$ 被错误地鉴定为纯合子，且在错误鉴定的条件下，报告的纯合子为 $AA$ 的概率为 $1/2$，$aa$ 的概率为 $1/2$。真实的纯合子 $AA$ 和 $aa$ 从不被错误鉴定。假设从群体中抽取一个大小为 $N$ 的样本，通过使用上述模型下的期望计数来忽略抽样方差，并假设哈代-温伯格检验使用皮尔逊卡方统计量，将观测到的基因型计数与根据观测数据估计的等位基因频率计算出的HWE期望计数进行比较。\n\n从哈代-温伯格平衡的基本定义和皮尔逊卡方检验的定义出发，推导以下内容的闭式解析表达式：\n- 观测到的期望杂合度（被观测为杂合子的个体比例），作为 $p$、$q$ 和 $\\epsilon$ 的函数；以及\n- 在所述错误模型下，皮尔逊卡方哈代-温伯格检验统计量的渐近期望值，作为 $N$ 和 $\\epsilon$ 的函数。\n\n提供精确表达式；不要四舍五入。您的最终答案必须是一个单行矩阵，按上述顺序包含这两个表达式。",
            "solution": "问题陈述已经过分析并被认为是有效的。它在群体遗传学和统计学方面有科学依据，问题提出得当、客观，并包含了获得唯一解所需的所有必要信息。因此，我们可以进行正式的推导。\n\n设 $p$ 为等位基因 $A$ 的真实频率，$q=1-p$ 为等位基因 $a$ 的真实频率。在处于哈代-温伯格平衡（HWE）的真实群体中，基因型频率为：\n- 真实 $AA$：$P_{true}(AA) = p^2$\n- 真实 $Aa$：$P_{true}(Aa) = 2pq$\n- 真实 $aa$：$P_{true}(aa) = q^2$\n\n该问题描述了一个系统性的基因分型错误模型。我们可以定义在给定真实基因型的情况下，观测到特定基因型的条件概率。设 $G_{obs}$ 为观测基因型，$G_{true}$ 为真实基因型。\n- 真实纯合子从不被错误鉴定：\n  $P(G_{obs}=AA | G_{true}=AA) = 1$\n  $P(G_{obs}=aa | G_{true}=aa) = 1$\n  $P(G_{obs} \\neq AA | G_{true}=AA) = 0$\n  $P(G_{obs} \\neq aa | G_{true}=aa) = 0$\n- 真实杂合子（$Aa$）以概率 $\\epsilon$ 被错误鉴定：\n  在真实基因为 $Aa$ 的情况下，观测到 $Aa$ 的概率即为没有发生错误鉴定的概率：\n  $P(G_{obs}=Aa | G_{true}=Aa) = 1 - \\epsilon$\n  在发生错误鉴定（概率为 $\\epsilon$）的条件下，报告的基因型为 $AA$ 的概率是 $1/2$，$aa$ 的概率是 $1/2$。因此：\n  $P(G_{obs}=AA | G_{true}=Aa) = \\epsilon \\times \\frac{1}{2} = \\frac{\\epsilon}{2}$\n  $P(G_{obs}=aa | G_{true}=Aa) = \\epsilon \\times \\frac{1}{2} = \\frac{\\epsilon}{2}$\n\n使用全概率定律，我们可以计算观测基因型的期望频率，记为 $P_{obs}(G_{obs})$。\n$P_{obs}(G_{obs}) = \\sum_{G_{true} \\in \\{AA, Aa, aa\\}} P(G_{obs} | G_{true}) P_{true}(G_{true})$\n\n对于观测到的 $AA$：\n$P_{obs}(AA) = P(AA|AA)P_{true}(AA) + P(AA|Aa)P_{true}(Aa) + P(AA|aa)P_{true}(aa)$\n$P_{obs}(AA) = (1)(p^2) + (\\frac{\\epsilon}{2})(2pq) + (0)(q^2) = p^2 + pq\\epsilon$\n\n对于观测到的 $Aa$：\n$P_{obs}(Aa) = P(Aa|AA)P_{true}(AA) + P(Aa|Aa)P_{true}(Aa) + P(Aa|aa)P_{true}(aa)$\n$P_{obs}(Aa) = (0)(p^2) + (1-\\epsilon)(2pq) + (0)(q^2) = 2pq(1-\\epsilon)$\n\n对于观测到的 $aa$：\n$P_{obs}(aa) = P(aa|AA)P_{true}(AA) + P(aa|Aa)P_{true}(Aa) + P(aa|aa)P_{true}(aa)$\n$P_{obs}(aa) = (0)(p^2) + (\\frac{\\epsilon}{2})(2pq) + (1)(q^2) = q^2 + pq\\epsilon$\n\n作为一致性检验，观测频率的总和为：\n$(p^2 + pq\\epsilon) + 2pq(1-\\epsilon) + (q^2 + pq\\epsilon) = p^2 + 2pq + q^2 + pq\\epsilon - 2pq\\epsilon + pq\\epsilon = (p+q)^2 = 1$。\n\n问题的第一部分要求计算观测到的期望杂合度。这是被观测为杂合子的个体所占的期望比例，即 $P_{obs}(Aa)$。\n观测到的期望杂合度 $= 2pq(1-\\epsilon)$。\n\n问题的第二部分要求计算皮尔逊卡方统计量的渐近期望值。该统计量由公式 $\\chi^2 = \\sum_i \\frac{(O_i - E_i)^2}{E_i}$ 给出，其中 $O_i$ 是观测到的基因型计数，$E_i$ 是在 HWE 下的期望基因型计数。问题指定使用期望计数进行计算，这意味着我们用基于大小为 $N$ 的样本的期望值来替代随机的观测计数。\n$O_{AA} = N \\cdot P_{obs}(AA) = N(p^2 + pq\\epsilon)$\n$O_{Aa} = N \\cdot P_{obs}(Aa) = N(2pq(1-\\epsilon))$\n$O_{aa} = N \\cdot P_{obs}(aa) = N(q^2 + pq\\epsilon)$\n\n期望计数 $E_i$ 是在 HWE 假设下，使用从*观测*数据中估计出的等位基因频率计算的。设观测到的 $A$ 等位基因频率为 $p'_{obs}$。这可由观测到的基因型频率计算得出：\n$p'_{obs} = P_{obs}(AA) + \\frac{1}{2} P_{obs}(Aa)$\n$p'_{obs} = (p^2 + pq\\epsilon) + \\frac{1}{2} (2pq(1-\\epsilon))$\n$p'_{obs} = p^2 + pq\\epsilon + pq - pq\\epsilon$\n$p'_{obs} = p^2 + pq = p(p+q) = p(1) = p$\n\n值得注意的是，观测到的等位基因频率 $p'_{obs}$ 是真实等位基因频率 $p$ 的一个无偏估计量。因此，观测到的 $a$ 等位基因频率为 $q'_{obs} = 1 - p'_{obs} = 1 - p = q$。\n\n现在我们可以根据 $p'_{obs}=p$ 和 $q'_{obs}=q$，为一个大小为 $N$ 的样本计算 HWE 期望计数 $E_i$：\n$E_{AA} = N (p'_{obs})^2 = Np^2$\n$E_{Aa} = N \\cdot 2 p'_{obs} q'_{obs} = N \\cdot 2pq$\n$E_{aa} = N (q'_{obs})^2 = Nq^2$\n\n我们现在计算 $(O_i - E_i)$ 各项：\n$O_{AA} - E_{AA} = N(p^2 + pq\\epsilon) - Np^2 = Npq\\epsilon$\n$O_{Aa} - E_{Aa} = N(2pq(1-\\epsilon)) - N(2pq) = 2Npq - 2Npq\\epsilon - 2Npq = -2Npq\\epsilon$\n$O_{aa} - E_{aa} = N(q^2 + pq\\epsilon) - Nq^2 = Npq\\epsilon$\n\n这些差异的总和为 $Npq\\epsilon - 2Npq\\epsilon + Npq\\epsilon = 0$，与预期相符。最后，我们将这些值代入公式，计算卡方统计量的渐近期望值：\n$\\chi^2 = \\frac{(O_{AA} - E_{AA})^2}{E_{AA}} + \\frac{(O_{Aa} - E_{Aa})^2}{E_{Aa}} + \\frac{(O_{aa} - E_{aa})^2}{E_{aa}}$\n$\\chi^2 = \\frac{(Npq\\epsilon)^2}{Np^2} + \\frac{(-2Npq\\epsilon)^2}{N(2pq)} + \\frac{(Npq\\epsilon)^2}{Nq^2}$\n$\\chi^2 = \\frac{N^2p^2q^2\\epsilon^2}{Np^2} + \\frac{4N^2p^2q^2\\epsilon^2}{2Npq} + \\frac{N^2p^2q^2\\epsilon^2}{Nq^2}$\n$\\chi^2 = Nq^2\\epsilon^2 + 2Npq\\epsilon^2 + Np^2\\epsilon^2$\n提取公因式 $N\\epsilon^2$：\n$\\chi^2 = N\\epsilon^2 (q^2 + 2pq + p^2)$\n由于 $p^2 + 2pq + q^2 = (p+q)^2 = 1^2 = 1$，该表达式简化为：\n$\\chi^2 = N\\epsilon^2$\n\n这就是在指定错误模型下皮尔逊卡方统计量的渐近期望值。\n\n所需的两个表达式是：\n1. 观测到的期望杂合度：$2pq(1-\\epsilon)$\n2. 皮尔逊卡方统计量的渐近期望值：$N\\epsilon^2$",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n2pq(1-\\epsilon)  N\\epsilon^{2}\n\\end{pmatrix}\n}\n$$"
        }
    ]
}