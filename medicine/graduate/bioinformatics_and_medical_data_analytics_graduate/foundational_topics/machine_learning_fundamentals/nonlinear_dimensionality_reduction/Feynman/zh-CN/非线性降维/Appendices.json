{
    "hands_on_practices": [
        {
            "introduction": "在真实的生物信息学分析中，数据集往往包含复杂的混合结构，例如界限分明的免疫细胞亚群和呈连续过渡状态的癌细胞。选择单一的邻域尺度（如t-SNE中的困惑度或UMAP中的`n_neighbors`）往往难以同时捕捉这两种模式，可能导致“过度抱团”现象，即连续谱被人为压缩成密集的团块。本练习将指导您针对这种混合密度数据，设计一种多尺度的超参数策略，以平衡局部精细结构和全局连续谱的表达，这是高级数据可视化的核心技能。",
            "id": "4590753",
            "problem": "一项对异质性肿瘤微环境的单细胞核糖核酸测序 (scRNA-seq) 研究产生了一个包含 $N=8000$ 个细胞和 $p=20000$ 个基因的矩阵，该矩阵通过对数归一化和投影到前 $d=50$ 个主成分上进行预处理。先前的生物学知识表明，其潜在结构中存在两种模式：(i) 紧密聚集的免疫细胞亚型，其簇内方差较小；以及 (ii) 跨越上皮-间质转化过程的弥散上皮细胞状态，其簇内方差较大且存在过渡性连续体。您将使用 t-分布随机邻域嵌入 (t-SNE) 和均匀流形逼近与投影 (UMAP) 构建一个二维可视化，以支持下游的医学数据分析，例如叠加临床协变量和发现假定的亚型。目标是避免过度聚集（over-clumping），即避免产生会扭曲局部密度并将过渡性连续体合并成密集团块的人为紧凑簇，同时仍保留有意义的局部邻域。\n\n作为基本原理，回顾 t-SNE 定义了高维条件相似度 $p_{j \\mid i} \\propto \\exp\\!\\left(-\\lVert x_i - x_j \\rVert^2 / (2 \\sigma_i^2)\\right)$，其中 $\\sigma_i$ 的选择使得 $p_{\\cdot \\mid i}$ 的香农熵等于一个目标困惑度（perplexity）；该嵌入通过最小化高维 $p_{ij}$ 和低维 $q_{ij}$ 之间的 Kullback–Leibler 散度，产生由 $p_{ij}$ 加权的引力和由 $q_{ij}$ 加权的斥力。均匀流形逼近与投影 (UMAP) 通过从 $k=n_{\\text{neighbors}}$ 个最近邻中定义邻域半径 $\\rho_i$ 和平滑尺度 $\\sigma_i$ 来构建一个模糊单纯复形，对称化隶属度以形成一个高维模糊图，并通过最小化高维和低维模糊集之间的交叉熵来学习一个嵌入；参数 `min_dist` 决定了较小的低维距离在多大程度上增加隶属度，从而控制了点被允许聚集的紧密程度。每种方法中的多尺度构造都结合了多个尺度的邻域，以平衡局部和全局结构。\n\n在这个混合密度数据集中，哪种组合超参数策略能最好地缓解过度聚集问题，同时为使用不同 `n_neighbors` 层级提供理由？\n\nA. 使用单一邻域尺度 `n_neighbors`=15、`min_dist`=0.01 和 `set_op_mix_ratio`=0.0 的 UMAP。使用单一困惑度 $30$ 和 `early_exaggeration`=12 的 t-SNE。\n\nB. 通过聚合来自 `n_neighbors` $\\in \\{15, 60, 200\\}$ 的模糊图来使用多尺度 UMAP，设置 `min_dist`=0.3 和 `set_op_mix_ratio`=0.7 以平衡并集和交集。通过平均来自困惑度 $\\{30, 120\\}$ 的相似度来使用多尺度 t-SNE，设置 `early_exaggeration`=8 和学习率 $\\eta = N/12$。\n\nC. 使用 `n_neighbors`=200、`min_dist`=0.0 和 `set_op_mix_ratio`=1.0 的 UMAP。使用困惑度 $5$ 和 `early_exaggeration`=36 的 t-SNE。\n\nD. 使用 `n_neighbors`=5、`min_dist`=0.5 和 `local_connectivity`=1 的 UMAP。使用困惑度 $200$ 和 `early_exaggeration`=4 的 t-SNE。\n\n选择最佳选项，并准备好从邻域概率分布和模糊隶属度的第一性原理行为出发，论证你的选择，包括为什么在这种包含紧密簇和弥散簇的场景中，多个 `n_neighbors` 层级是合适的。",
            "solution": "用户提供了一个关于在单细胞 RNA 测序数据分析背景下为 t-SNE 和 UMAP 算法选择超参数的问题陈述。我将首先验证该问题陈述。\n\n### 第一步：提取已知信息\n\n*   **数据来源：** 异质性肿瘤微环境的单细胞核糖核酸测序 (scRNA-seq)。\n*   **数据矩阵大小：** $N=8000$ 个细胞，$p=20000$ 个基因。\n*   **预处理：** 对数归一化，投影到前 $d=50$ 个主成分上。\n*   **假定的潜在结构：**\n    *   (i) 簇内方差小的紧密聚集的免疫细胞亚型。\n    *   (ii) 跨越上皮-间质转化 (EMT) 过程、簇内方差大且存在过渡性连续体的弥散上皮细胞状态。\n*   **目标：** 构建二维可视化，以避免“过度聚集”（即扭曲局部密度、将过渡性连续体合并成密集团块的人为紧凑簇），同时保留有意义的局部邻域。\n*   **算法描述：**\n    *   **t-SNE：** 定义条件相似度 $p_{j \\mid i} \\propto \\exp\\!\\left(-\\lVert x_i - x_j \\rVert^2 / (2 \\sigma_i^2)\\right)$，其中 $\\sigma_i$ 通过困惑度进行调整。最小化 Kullback–Leibler (KL) 散度。\n    *   **UMAP：** 使用 $k$ (`n_neighbors`) 个最近邻构建模糊单纯复形。最小化交叉熵。`min_dist` 参数控制嵌入点的聚集密度。\n*   **核心问题：** 确定哪种组合超参数策略能最好地缓解这种混合密度数据集中的过度聚集问题，并为使用多个 `n_neighbors` 层级提供理由。\n\n### 第二步：使用提取的已知信息进行验证\n\n根据既定标准对问题陈述进行评估。\n\n*   **科学依据：** 该问题牢固地植根于生物信息学和医学数据分析这一成熟领域。所描述的场景——使用 PCA、t-SNE 和 UMAP 分析来自肿瘤微环境的 scRNA-seq 数据——是一种标准且广泛发表的方法论。对数据集特征（免疫细胞的紧密簇、弥散的 EMT 连续体）的描述在生物学上是合理的，并代表了数据可视化中的一个常见挑战。对 t-SNE 和 UMAP 的技术描述准确地反映了它们的基本原理。该问题不含伪科学和事实错误。\n*   **定义明确：** 该问题定义明确。它提出了一个明确的目标（缓解过度聚集，保留混合密度结构），并提供了一组互斥的选项来根据此目标进行评估。解决方案可以通过分析指定超参数对最终嵌入几何形状的已知影响，并基于算法的数学基础推导出来。\n*   **客观性：** 语言技术性强且精确。“过度聚集”这一核心概念通过客观描述（“人为紧凑簇”、“扭曲局部密度”、“将过渡性连续体合并成密集团块”）得到限定，消除了主观性。对超参数的评估依赖于它们有据可查的客观效果，而非个人意见。\n\n该问题陈述未表现出任何无效性标志。它在科学上是合理的，可形式化的，完整的，并提出了一个与主题相关的、非平凡且可验证的问题。\n\n### 第三步：结论与行动\n\n该问题是**有效的**。我将继续进行解决方案推导和选项分析。\n\n### 解决方案推导\n\n核心挑战在于为 t-SNE 和 UMAP 选择能够同时表示数据中两种截然不同结构类型的超参数：(i) 小而密集的簇（免疫细胞）和 (ii) 大而弥散的连续体（EMT）。单一的邻域大小选择（t-SNE 中的困惑度，UMAP 中的 `n_neighbors`）本质上是一种折衷：小的邻域大小会解析出密集的簇，但可能会使连续体碎片化；而大的邻域大小会捕捉到连续体，但可能会合并密集的簇。避免“过度聚集”的目标明确要求防止算法将弥散的连续体人为地压缩成一个密集的球，并防止错误地表示所有结构的真实方差。\n\n**理想策略原则：**\n\n1.  **多尺度方法：** 处理具有不同尺度结构的数据最稳健的方法是使用多尺度方法。这涉及到整合来自小邻域和大邻域的信息。在 UMAP 中，这可以通过提供一个 `n_neighbors` 值的列表来实现。在 t-SNE 中，这可以通过为多个困惑度计算相似度矩阵并将其平均来实现。这直接回应了为使用多个邻域大小层级提供理由的要求。\n2.  **控制嵌入密度：** UMAP 中的 `min_dist` 参数直接控制点在最终 2D 嵌入中可以聚集的紧密程度。为了避免过度聚集并忠实地表示弥散结构，`min_dist` 应设置为一个中等或较大的值（例如，$\\geq 0.2$），而不是接近 $0$ 的值。对于 t-SNE，其创建紧密、均匀分布的簇的倾向更根本地源于该算法使用学生 t-分布作为低维相似度，但这可以被调节。降低 `early_exaggeration`（早期夸大）因子可以防止优化在初始阶段过于激进地收缩结构。\n\n基于这些原则，最佳策略将为两种算法采用多尺度邻域定义，并使用主动抑制密集聚集的参数（UMAP 中的 `min_dist` > 0.1，t-SNE 中适度的 `early_exaggeration`）。\n\n### 逐项选项分析\n\n**A. 使用单一邻域尺度 `n_neighbors`=15、`min_dist`=0.01 和 `set_op_mix_ratio`=0.0 的 UMAP。使用单一困惑度 $30$ 和 `early_exaggeration`=12 的 t-SNE。**\n\n*   **UMAP：** 该策略使用单一的小邻域大小 (`n_neighbors`=15)，这将侧重于局部结构而牺牲全局结构，很可能使 EMT 连续体碎片化。关键在于，`min_dist`=0.01 会鼓励最大程度的聚集密度，这正是问题所要避免的“过度聚集”的直接原因。此设置将创建人为的密集簇，与目标背道而驰。\n*   **t-SNE：** 单一的困惑度 30 是一个标准默认值，但它是一种单尺度折衷方案。`early_exaggeration` 为 12 也是标准值但较为激进，会促进聚集。\n*   **结论：** 不正确。该策略促进而非缓解了过度聚集。\n\n**B. 通过聚合来自 `n_neighbors` $\\in \\{15, 60, 200\\}$ 的模糊图来使用多尺度 UMAP，设置 `min_dist`=0.3 和 `set_op_mix_ratio`=0.7 以平衡并集和交集。通过平均来自困惑度 $\\{30, 120\\}$ 的相似度来使用多尺度 t-SNE，设置 `early_exaggeration`=8 和学习率 $\\eta = N/12$。**\n\n*   **UMAP：** 该策略明确采用多尺度，使用 `n_neighbors` $\\in \\{15, 60, 200\\}$。较小的值 (15) 捕获免疫细胞簇的局部结构，而较大的值 (60, 200) 捕获 EMT 连续体的全局结构。`set_op_mix_ratio`=0.7 的值恰当地平衡了模糊集并集（保留连续体）和交集（定义紧密簇），并略微倾向于并集。最重要的是，`min_dist`=0.3 是一个适中的值，它允许点在嵌入中保持散开，直接解决了弥散 EMT 状态的“过度聚集”问题。\n*   **t-SNE：** 该策略也是多尺度的，通过平均来自困惑度 $\\{30, 120\\}$ 的相似度，这是在 t-SNE 中处理混合尺度结构的正确方法。降低的 `early_exaggeration`=8 减少了激进的初始聚集，进一步帮助保留弥散结构。学习率 $\\eta = N/12$ 对于大小为 $N=8000$ 的数据集是一个标准、稳健的选择。\n*   **结论：** 正确。该选项提出了一个复杂、理由充分且内部一致的策略，直接解决了问题陈述的所有方面。在两种算法中使用多个邻域层级是合理的，因为需要捕获数据中存在的不同尺度的结构。\n\n**C. 使用 `n_neighbors`=200、`min_dist`=0.0 和 `set_op_mix_ratio`=1.0 的 UMAP。使用困惑度 $5$ 和 `early_exaggeration`=36 的 t-SNE。**\n\n*   **UMAP：** 单一的大邻域 (`n_neighbors`=200) 将只关注全局结构，可能会合并不同的免疫细胞簇。`min_dist`=0.0 的设置将导致极端的过度聚集，而这正是需要避免的。\n*   **t-SNE：** 一个非常低的困惑度 ($5$) 将专注于超局部结构，从而打碎 EMT 连续体。`early_exaggeration`=36 是一个极高的值，将强制进行过早的、激进的聚集。\n*   **结论：** 不正确。参数选择不佳且相互矛盾。UMAP 的 `min_dist` 和 t-SNE 的 `early_exaggeration` 值会最大化而非缓解过度聚集。\n\n**D. 使用 `n_neighbors`=5、`min_dist`=0.5 和 `local_connectivity`=1 的 UMAP。使用困惑度 $200$ 和 `early_exaggeration`=4 的 t-SNE。**\n\n*   **UMAP：** 这是一种单尺度的超局部策略 (`n_neighbors`=5)，无法捕获全局的 EMT 连续体，很可能会将其分解。虽然 `min_dist`=0.5 有利于防止聚集，但底层的图结构将会是碎片化的。\n*   **t-SNE：** 这是一种单尺度的、高度全局化的策略 (困惑度 $200$)。它很可能捕获 EMT 连续体，但代价是合并更精细的免疫细胞簇。虽然 `early_exaggeration`=4 是一个保留全局结构的不错选择，但单一的大困惑度对于混合尺度数据并非最优。\n*   **结论：** 不正确。该选项提出了两种相互对立的单尺度策略。两者都无法同时解析数据中存在的局部和全局结构。选项 B 的多尺度方法在根本上更为优越。",
            "answer": "$$\\boxed{B}$$"
        },
        {
            "introduction": "非线性降维最常见的误区之一，是直接在生成的二维嵌入图上进行聚类分析。t-SNE和UMAP为了优化可视化效果，会有意地扭曲空间中点的局部密度，这可能导致在嵌入空间中聚类时产生严重的人为结果，例如将本身密集但连续的区域错误地分割成多个簇。本练习旨在揭示这种后处理聚类不稳定性的根源，并引导您思考和选择那些能够校正密度影响、从而得出更可靠生物学结论的稳健分析策略。",
            "id": "4590830",
            "problem": "一个单细胞核糖核酸测序数据集包含 $n$ 个细胞和 $p$ 个基因特征，其目标是可视化并聚类离散的细胞类型。一名实践者使用 t-分布随机邻居嵌入 (t-SNE) 来获得高维点 $\\{x_i\\}_{i=1}^n$ 的二维嵌入 $\\{y_i\\}_{i=1}^n$，其中 t-SNE 由高维条件概率 $p_{j \\mid i} \\propto \\exp\\!\\left(-\\frac{\\|x_i - x_j\\|^2}{2 \\sigma_i^2}\\right)$ 定义，其中 $\\sigma_i$ 的选择是为了匹配目标困惑度 $\\mathcal{P}$，通过 $\\mathrm{Perp}\\!\\left(P_i\\right) = 2^{H(P_i)} = \\mathcal{P}$ 实现，以及低维联合概率 $q_{ij} \\propto \\left(1 + \\|y_i - y_j\\|^2\\right)^{-1}$；该嵌入最小化 $\\{p_{ij}\\}$ 和 $\\{q_{ij}\\}$ 之间的 Kullback–Leibler 散度 (KLD)。或者，该实践者使用均匀流形逼近与投影 (UMAP)，它利用局部连通性 $\\rho_i$ 和尺度 $\\sigma_i$ 构建模糊单纯复形权重 $w_{ij}$，并优化一个交叉熵目标函数来保留这些模糊隶属度。然后，该实践者在嵌入空间中进行聚类，并观察到在不同的随机种子下，密集区域会分裂成许多微簇，而稀疏区域则被合并在一起，从而产生不一致的生物学注释。\n\n从邻居图和密度敏感距离的第一性原理出发，解释变化的局部采样密度 $\\rho(x)$ 如何导致嵌入后聚类的不稳定性。特别要注意的是，对于一个固定的 $k$-最近邻图，捕获 $k$ 个邻居的局部邻居半径 $r_i$ 满足 $r_i \\approx \\left(\\frac{k}{\\rho(x_i)}\\right)^{1/d}$，其中 $d$ 是环境维度，因此高密度区域 (大的 $\\rho(x_i)$) 有小的 $r_i$，而稀疏区域有大的 $r_i$。当使用假设均匀方差或单一全局密度阈值的算法在二维嵌入中进行聚类时，密度异质性可能导致密集区域的过度分裂和稀疏区域的欠分裂。提出能够校正密度并减少这种不稳定性，同时不丢弃细胞类型之间有意义的边界的方法。\n\n下列哪种策略最直接且合理地解决了因密度变化引起的嵌入后聚类不稳定性问题，并避免了过度分裂的人为现象，同时保留了具有生物学意义的分离？选择所有适用选项。\n\nA. 在原始高维空间中使用自适应局部尺度 $\\{\\sigma_i\\}$ 构建一个共享最近邻图，并使用 Leiden 算法对该图进行聚类；严格将二维嵌入用于可视化而非聚类。\n\nB. 使用均匀流形逼近与投影的密度保持变体 (densMAP) 向目标函数中添加一个密度匹配项，以使相对密度在二维嵌入中得以保留，然后使用层次化基于密度的带噪声应用空间聚类 (HDBSCAN) 进行聚类，并利用相互可达距离来适应变化的密度。\n\nC. 将 UMAP 中的邻域大小增加到一个非常大的值，然后在二维嵌入上应用基于密度的带噪声应用空间聚类 (DBSCAN)，其单一全局参数 $\\varepsilon$ 从 $k$-距离图的拐点处选取。\n\nD. 在二维嵌入中直接应用 $k$-means 算法，其中 $k$ 值由轮廓系数选择，并相信 t-SNE 的重尾核已经充分均衡了密度以防止过度分裂。\n\nE. 将欧几里得距离替换为从高维马尔可夫转移矩阵计算出的扩散距离，选择时间尺度 $t$ 以平滑局部随机性，然后对得到的亲和度矩阵执行谱聚类（例如，归一化切割）；仅将嵌入用于可视化。\n\nF. 通过将每个点的坐标除以其所在位置的核密度估计值来归一化嵌入坐标以均衡密度，然后对转换后的二维空间运行任何现成的聚类方法。",
            "solution": "该问题陈述经验证有效。它在科学上是合理的，因为它触及了在t-SNE/UMAP嵌入上进行聚类这一常见但充满陷阱的实践。问题定义明确，要求提出能够缓解因算法内在密度扭曲而导致的聚类不稳定性。该问题也是客观的，因为它基于t-SNE和UMAP算法有据可查的数学特性。\n\n### 解决方案推导\n\n问题的核心在于t-SNE和UMAP算法在设计上会扭曲数据的局部密度。两种算法都旨在保留数据的局部邻域结构（拓扑结构），而非真实的测地距离或密度。\n\n1.  **t-SNE**：通过为每个点$x_i$调整高斯核的宽度$\\sigma_i$以达到恒定的困惑度，强制每个点拥有相似的“有效邻居数”。这意味着在原始的高维空间中，密集区域（小$\\sigma_i$）被“拉伸”，而稀疏区域（大$\\sigma_i$）被“压缩”。\n2.  **UMAP**：同样，它根据到第$k$个最近邻的距离来确定每个点的局部尺度。因此，密集区域中的点（邻居很近）和稀疏区域中的点（邻居很远）在最终的嵌入中会被调整，以使它们的邻域看起来大小相近。\n\n这种为了优美的可视化而进行的密度均衡，对于后续的聚类分析是灾难性的。在嵌入空间中，一个原本单一、密集但连续的细胞群可能会被“拉伸”得非常大，以至于一个像DBSCAN这样依赖单一密度阈值$\\varepsilon$的算法会将其错误地分割成多个小簇（过度分裂）。相反，几个原本分离但稀疏的簇可能会被“挤压”在一起，导致它们被合并（欠分裂）。因此，稳健的策略必须绕过或纠正这种嵌入空间的密度假象。\n\n### 逐项选项分析\n\n**A. 在原始高维空间中使用自适应局部尺度 $\\{\\sigma_i\\}$ 构建一个共享最近邻图，并使用 Leiden 算法对该图进行聚类；严格将二维嵌入用于可视化而非聚类。**\n\n*   **结论：正确。** 这是当前单细胞分析领域的黄金标准。聚类是在高维数据（通常是PCA降维后的空间）上构建的图（如SNN图）上执行的。Leiden或Louvain等社群发现算法直接在图上操作，对密度的局部变化不敏感。二维嵌入仅用于可视化这些预先计算好的簇标签，而不是用来定义它们。这种方法将聚类和可视化解耦，是最稳健的策略。\n\n**B. 使用均匀流形逼近与投影的密度保持变体 (densMAP) 向目标函数中添加一个密度匹配项，以使相对密度在二维嵌入中得以保留，然后使用层次化基于密度的带噪声应用空间聚类 (HDBSCAN) 进行聚类，并利用相互可达距离来适应变化的密度。**\n\n*   **结论：正确。** 这是一种先进且直接的解决方案。`densMAP`是UMAP的一个变体，其目标函数中增加了一项，旨在惩罚高维空间和低维嵌入之间局部密度的差异，从而生成一个密度信息更准确的嵌入。HDBSCAN是一个强大的聚类算法，它不需要全局密度参数，能够识别不同密度的簇。这种组合从嵌入和聚类两个层面同时解决了问题。\n\n**C. 将 UMAP 中的邻域大小增加到一个非常大的值，然后在二维嵌入上应用基于密度的带噪声应用空间聚类 (DBSCAN)，其单一全局参数 $\\varepsilon$ 从 $k$-距离图的拐点处选取。**\n\n*   **结论：不正确。** 此策略存在两个根本性缺陷。首先，非常大的`n_neighbors`会过度平滑数据，只关注全局结构，可能导致不同的精细簇被合并。其次，DBSCAN使用单一的全局密度参数$\\varepsilon$，这正是它在密度变化的数据上表现不佳的原因，而t-SNE/UMAP嵌入恰恰会产生或加剧密度变化。\n\n**D. 在二维嵌入中直接应用 $k$-means 算法，其中 $k$ 值由轮廓系数选择，并相信 t-SNE 的重尾核已经充分均衡了密度以防止过度分裂。**\n\n*   **结论：不正确。** 这是典型的错误做法。$k$-means算法对簇的形状（假设为球形）和密度非常敏感，极易受到t-SNE/UMAP密度扭曲的影响而产生伪影。认为t-SNE的t分布核能“均衡密度”以进行聚类是一种误解；它的作用是创造视觉上分离的簇，但这是通过扭曲空间来实现的，而不是通过使密度适合于像$k$-means这样的算法。\n\n**E. 将欧几里得距离替换为从高维马尔可夫转移矩阵计算出的扩散距离，选择时间尺度 $t$ 以平滑局部随机性，然后对得到的亲和度矩阵执行谱聚类（例如，归一化切割）；仅将嵌入用于可视化。**\n\n*   **结论：正确。** 这与选项A类似，是一种基于图的稳健方法。扩散图（Diffusion Maps）通过构建一个随机游走过程来捕捉数据的流形结构，所产生的扩散距离对噪声不敏感。在由此产生的亲和度矩阵上进行谱聚类是一种强大的图分割技术。同样，这种方法也将聚类过程锚定在数据的内在几何结构上，而将t-SNE/UMAP嵌入保留为纯粹的可视化工具。\n\n**F. 通过将每个点的坐标除以其所在位置的核密度估计值来归一化嵌入坐标以均衡密度，然后对转换后的二维空间运行任何现成的聚类方法。**\n\n*   **结论：不正确。** 尽管这个想法（试图“撤销”密度扭曲）听起来很直观，但它是一种启发式的、不稳定的后处理方法。核密度估计本身需要选择核和带宽参数，这会引入新的不确定性。在稀疏区域，估计的密度可能接近于零，导致除法操作在数值上不稳定。与A、B、E中基于图论或算法改进的原则性方法相比，这种方法不够稳健。",
            "answer": "$$\\boxed{ABE}$$"
        }
    ]
}