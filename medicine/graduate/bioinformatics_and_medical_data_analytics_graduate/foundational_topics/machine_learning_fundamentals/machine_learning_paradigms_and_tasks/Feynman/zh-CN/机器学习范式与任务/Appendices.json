{
    "hands_on_practices": [
        {
            "introduction": "在监督学习中，评估回归模型的性能是至关重要的一步。本练习将引导你计算两个核心评估指标：均方根误差（Root Mean Squared Error, RMSE）和决定系数（$R^2$）。通过一个预测血清肌酐水平的生物信息学场景，你将学会如何从模型的预测误差中量化其准确性，并判断其解释数据变异的能力，从而评估模型是否达到临床应用的最低标准 。",
            "id": "4579954",
            "problem": "一个转化生物信息学团队训练了一个监督学习模型，用多组学特征来预测血清肌酐（单位：mg/dL）。该模型在一个由 $100$ 名成年患者组成的留出验证队列上进行评估。设真实的肌酐值为 $\\{y_i\\}_{i=1}^{n}$，模型预测值为 $\\{\\hat{y}_i\\}_{i=1}^{n}$，其中 $n=100$。根据该验证队列中匹配的真实值和预测值，获得了以下经验性汇总统计量：\n- 残差平方和（预测误差的平方和）：$\\sum_{i=1}^{n} (y_i - \\hat{y}_i)^2 = 19.36$。\n- 围绕经验均值 $\\bar{y} = \\frac{1}{n}\\sum_{i=1}^{n} y_i$ 的总平方和：$\\sum_{i=1}^{n} (y_i - \\bar{y})^2 = 48.40$。\n\n一项临床评估计划规定，一个模型在此队列上被认为是充分的，当且仅当以下两个条件同时成立：均方根误差 (RMSE) 小于或等于 $0.5$ mg/dL，并且决定系数（记为 $R^2$）至少为 $0.55$。\n\n从平方损失下的经验风险和相对于基线预测器 $y=\\bar{y}$ 的方差分解的核心定义出发，计算该模型在验证队列上的 RMSE（以 mg/dL 表示）和 $R^2$，并确定该模型是否满足充分性标准。最终答案只报告 RMSE 和 $R^2$ 的数值，按此顺序排列，并四舍五入到四位有效数字。RMSE 以 mg/dL 为单位表示。最终的方框答案中不包含任何单位。",
            "solution": "任务是计算一个监督学习模型的均方根误差 (RMSE) 和决定系数 ($R^2$)，并评估该模型是否满足预定义的充分性标准。\n\n设 $n$ 为验证队列中的患者数量，其中 $n=100$。\n设 $\\{y_i\\}_{i=1}^{n}$ 为真实的血清肌酐值集合，$\\{\\hat{y}_i\\}_{i=1}^{n}$ 为模型预测值集合。\n\n问题提供了两个关键的汇总统计量：\n1.  残差平方和 (RSS)，即预测误差的平方和：\n    $$ \\text{RSS} = \\sum_{i=1}^{n} (y_i - \\hat{y}_i)^2 = 19.36 $$\n2.  总平方和 (TSS)，即真实值与其经验均值 $\\bar{y}$ 之间差异的平方和：\n    $$ \\text{TSS} = \\sum_{i=1}^{n} (y_i - \\bar{y})^2 = 48.40 $$\n\n首先，我们计算 RMSE。RMSE 被定义为均方误差 (MSE) 的平方根。MSE 是平方损失下的经验风险，计算方法为平方误差的平均值：\n$$ \\text{MSE} = \\frac{1}{n} \\sum_{i=1}^{n} (y_i - \\hat{y}_i)^2 = \\frac{\\text{RSS}}{n} $$\n代入 RSS 和 $n$ 的给定值：\n$$ \\text{MSE} = \\frac{19.36}{100} = 0.1936 $$\nMSE 的单位是目标变量单位的平方，即 $(\\text{mg/dL})^2$。\n\nRMSE 是 MSE 的平方根，这将误差度量恢复到目标变量的原始单位：\n$$ \\text{RMSE} = \\sqrt{\\text{MSE}} $$\n代入计算出的 MSE 值：\n$$ \\text{RMSE} = \\sqrt{0.1936} = 0.44 $$\n因此，RMSE 为 $0.44$ mg/dL。\n\n接下来，我们计算决定系数 $R^2$。该度量衡量了因变量中可由模型预测的方差比例。它的定义为：\n$$ R^2 = 1 - \\frac{\\text{RSS}}{\\text{TSS}} $$\n这个公式将模型的误差 (RSS) 与一个总是预测真实值均值的基线模型的误差 (TSS) 进行比较。\n\n代入 RSS 和 TSS 的给定值：\n$$ R^2 = 1 - \\frac{19.36}{48.40} $$\n该比率可以简化为：\n$$ \\frac{19.36}{48.40} = 0.4 $$\n因此，$R^2$ 值为：\n$$ R^2 = 1 - 0.4 = 0.6 $$\n$R^2$ 是一个无量纲的量。\n\n问题将充分性标准表述为一个由两部分组成的条件：\n1. RMSE $\\le 0.5$ mg/dL\n2. $R^2 \\ge 0.55$\n\n我们用计算出的值来核对这些标准：\n1. 对于 RMSE：$0.44 \\le 0.5$。此条件满足。\n2. 对于 $R^2$：$0.6 \\ge 0.55$。此条件也满足。\n由于两个条件同时成立，该模型在此验证队列上被认为是充分的。\n\n最后一步是报告 RMSE 和 $R^2$ 的数值，并四舍五入到四位有效数字。\n- RMSE = $0.44$。保留四位有效数字，即为 $0.4400$。\n- $R^2$ = $0.6$。保留四位有效数字，即为 $0.6000$。\n\n最终答案将按指定顺序呈现这两个值。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n0.4400  0.6000\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "无监督学习的核心任务之一是从复杂数据中发现有意义的模式，例如在癌症研究中对患者进行亚型分类。然而，如何评估这些自动发现的“簇”的质量是一个挑战。本练习介绍两种广泛使用的聚类评估方法：轮廓系数（Silhouette Score）用于衡量聚类的内部一致性，调整兰德指数（Adjusted Rand Index, ARI）用于与已知的“金标准”进行比较，从而让你掌握全面评估聚类结果的技能 。",
            "id": "4579918",
            "problem": "对一个包含$500$名癌症患者的队列进行了高通量转录组学分析，并对z-score标准化的基因表达谱应用了一种无监督聚类算法，产生了$3$个聚类，这些聚类被假设对应于不同的生物亚型。对于聚类 $k \\in \\{1,2,3\\}$ 中的每一位患者，其与同一聚类中所有其他患者的平均相异度（计算为标准化表达上的欧几里得距离）在经验上是统一的，等于 $A_{k}$；其与不同聚类 $\\ell \\neq k$ 中患者的平均相异度在经验上也是统一的，等于 $D_{k,\\ell}$。聚类水平的平均值为：\n$$\nA_{1} = 4.0,\\quad A_{2} = 3.5,\\quad A_{3} = 2.8,\n$$\n$$\nD_{1,2} = 6.2,\\quad D_{1,3} = 5.1,\\quad D_{2,1} = 6.2,\\quad D_{2,3} = 5.9,\\quad D_{3,1} = 5.1,\\quad D_{3,2} = 5.9.\n$$\n聚类大小为 $|C_{1}| = 220$，$|C_{2}| = 180$，以及 $|C_{3}| = 100$。\n\n根据临床和多组学证据，整理出了一个将患者划分为3个分子亚型的金标准真实划分，其亚型大小为 $|G_{1}| = 200$，$|G_{2}| = 150$，以及 $|G_{3}| = 150$。聚类分配（行）与真实亚型（列）的交叉表如下：\n$$\n\\begin{pmatrix}\n160  40  20 \\\\\n30  90  60 \\\\\n10  20  70\n\\end{pmatrix}.\n$$\n\n使用用于聚类有效性评估的轮廓系数和用于划分一致性比较的调整兰德指数（ARI）的基本定义，计算：\n- 所有$500$名患者的总体轮廓分数，其中每位患者的轮廓值由其所在聚类水平的 $A_{k}$ 和在所有 $\\ell \\neq k$ 中最小的 $D_{k,\\ell}$ 决定，以及\n- 比较聚类与真实划分的调整兰德指数（ARI），该指数从交叉表中的组合计数导出。\n\n将这两个量表示为小数，并均四舍五入到四位有效数字。将您的最终答案以行矩阵的形式呈现，其中第一个条目是轮廓分数，第二个条目是调整兰德指数，不带单位。",
            "solution": "### 解答推导\n\n#### 第1部分：总体轮廓分数\n\n单个样本 $i$ 的轮廓分数定义为 $s(i) = \\frac{b(i) - a(i)}{\\max\\{a(i), b(i)\\}}$，其中 $a(i)$ 是样本 $i$ 与其自身所在聚类中其他样本的平均相异度，$b(i)$ 是样本 $i$ 与任何其他聚类中样本的最小平均相异度。\n\n问题指明，对于聚类 $C_k$ 中的任何患者，我们应使用聚类水平的平均值 $a(i) = A_k$ 和聚类水平的 $b(i)$ 平均值，即 $b_k = \\min_{\\ell \\neq k} D_{k,\\ell}$。因此，聚类 $C_k$ 中任何患者的轮廓分数（记为 $s_k$）在该聚类中是恒定的：\n$$s_k = \\frac{b_k - A_k}{\\max\\{A_k, b_k\\}}$$\n\n- 对于聚类 $C_1$：\n  $A_1 = 4.0$。\n  $b_1 = \\min\\{D_{1,2}, D_{1,3}\\} = \\min\\{6.2, 5.1\\} = 5.1$。\n  $s_1 = \\frac{5.1 - 4.0}{\\max\\{4.0, 5.1\\}} = \\frac{1.1}{5.1}$。\n\n- 对于聚类 $C_2$：\n  $A_2 = 3.5$。\n  $b_2 = \\min\\{D_{2,1}, D_{2,3}\\} = \\min\\{6.2, 5.9\\} = 5.9$。\n  $s_2 = \\frac{5.9 - 3.5}{\\max\\{3.5, 5.9\\}} = \\frac{2.4}{5.9}$。\n\n- 对于聚类 $C_3$：\n  $A_3 = 2.8$。\n  $b_3 = \\min\\{D_{3,1}, D_{3,2}\\} = \\min\\{5.1, 5.9\\} = 5.1$。\n  $s_3 = \\frac{5.1 - 2.8}{\\max\\{2.8, 5.1\\}} = \\frac{2.3}{5.1}$。\n\n总体轮廓分数 $S$ 是所有 $N=500$ 名患者个体分数的平均值。这是各聚类分数的加权平均值，权重等于聚类大小：\n$$S = \\frac{1}{N} \\sum_{k=1}^{3} |C_k| s_k = \\frac{1}{500} \\left( |C_1|s_1 + |C_2|s_2 + |C_3|s_3 \\right)$$\n$$S = \\frac{1}{500} \\left( 220 \\cdot \\frac{1.1}{5.1} + 180 \\cdot \\frac{2.4}{5.9} + 100 \\cdot \\frac{2.3}{5.1} \\right)$$\n$$S = \\frac{1}{500} \\left( \\frac{242}{5.1} + \\frac{432}{5.9} + \\frac{230}{5.1} \\right) = \\frac{1}{500} \\left( \\frac{472}{5.1} + \\frac{432}{5.9} \\right)$$\n$$S \\approx \\frac{1}{500} \\left( 92.5490196... + 73.2203389... \\right) = \\frac{165.769358...}{500} \\approx 0.3315387...$$\n四舍五入到四位有效数字，总体轮廓分数为 $0.3315$。\n\n#### 第2部分：调整兰德指数 (ARI)\n\n调整兰德指数（ARI）衡量两个数据聚类之间的相似性。其一般形式是：\n$$\\text{ARI} = \\frac{\\text{Index} - \\text{Expected Index}}{\\text{Max Index} - \\text{Expected Index}}$$\n使用列联表 $n_{ij}$，其中 $i$ 是算法聚类的索引，$j$ 是真实类别的索引，ARI 的计算公式如下：\n$$\\text{ARI} = \\frac{\\sum_{ij} \\binom{n_{ij}}{2} - \\frac{\\left[\\sum_i \\binom{a_i}{2}\\right] \\left[\\sum_j \\binom{b_j}{2}\\right]}{\\binom{N}{2}}}{\\frac{1}{2}\\left[\\sum_i \\binom{a_i}{2} + \\sum_j \\binom{b_j}{2}\\right] - \\frac{\\left[\\sum_i \\binom{a_i}{2}\\right] \\left[\\sum_j \\binom{b_j}{2}\\right]}{\\binom{N}{2}}}$$\n其中 $a_i$ 是列联表的行和，$b_j$ 是列联表的列和。\n\n首先，我们计算所需的组合项：\n- 所有单元格的 $\\binom{n_{ij}}{2}$ 之和（Index）：\n  $\\sum_{ij}\\binom{n_{ij}}{2} = \\binom{160}{2} + \\binom{40}{2} + \\binom{20}{2} + \\binom{30}{2} + \\binom{90}{2} + \\binom{60}{2} + \\binom{10}{2} + \\binom{20}{2} + \\binom{70}{2}$\n  $= 12720 + 780 + 190 + 435 + 4005 + 1770 + 45 + 190 + 2415 = 22550$。\n\n- 按行的 $\\binom{a_i}{2}$ 之和：\n  行和为 $a_1=220$, $a_2=180$, $a_3=100$。\n  $\\sum_{i}\\binom{a_{i}}{2} = \\binom{220}{2} + \\binom{180}{2} + \\binom{100}{2} = 24090 + 16110 + 4950 = 45150$。\n\n- 按列的 $\\binom{b_j}{2}$ 之和：\n  列和为 $b_1=200$, $b_2=150$, $b_3=150$。\n  $\\sum_{j}\\binom{b_{j}}{2} = \\binom{200}{2} + \\binom{150}{2} + \\binom{150}{2} = 19900 + 11175 + 11175 = 42250$。\n\n- 总配对数 $\\binom{N}{2}$：\n  $\\binom{500}{2} = \\frac{500 \\times 499}{2} = 124750$。\n\n现在，我们计算 ARI 公式的各个组成部分：\n- 期望指数 (Expected Index):\n  $\\frac{\\left[\\sum_i \\binom{a_i}{2}\\right] \\left[\\sum_j \\binom{b_j}{2}\\right]}{\\binom{N}{2}} = \\frac{45150 \\times 42250}{124750} = \\frac{1907587500}{124750} \\approx 15291.28256...$\n\n- ARI 的分子 = Index - 期望指数：\n  $22550 - 15291.28256... = 7258.71743...$\n\n- ARI 的分母：\n  $\\frac{1}{2}\\left(\\sum_i \\binom{a_i}{2} + \\sum_j \\binom{b_j}{2}\\right) - \\text{Expected Index}$\n  $= \\frac{1}{2}(45150 + 42250) - 15291.28256...$\n  $= \\frac{1}{2}(87400) - 15291.28256... = 43700 - 15291.28256... = 28408.71743...$\n\n- 最后，ARI 为：\n  $\\text{ARI} = \\frac{7258.71743...}{28408.71743...} \\approx 0.255511...$\n四舍五入到四位有效数字，ARI 为 $0.2555$。\n\n所要求的量是轮廓分数和 ARI，均四舍五入到四位有效数字。\n轮廓分数 $\\approx 0.3315$。\n调整兰德指数 $\\approx 0.2555$。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n0.3315  0.2555\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "虽然准确率或 $AUC$ 等统计指标能够衡量模型的预测性能，但它们并不能直接指导临床决策。决策曲线分析（Decision Curve Analysis, DCA）是一个强大的框架，它通过量化模型在不同风险阈值下的净获益，将模型评估与临床后果直接联系起来。本练习将要求你从第一性原理出发，推导并实现DCA，从而评估一个预测模型是否能在临床实践中带来真正的价值，这标志着从单纯的统计评估到实用决策支持的关键一步 。",
            "id": "4579973",
            "problem": "你的任务是在脓毒症风险分层的二元临床预测场景中实现决策曲线分析 (DCA)。你的目标是计算在一组风险阈值范围内，基于模型的决策策略的标准化净获益，将其与两种基准策略进行比较，并识别出模型具有临床价值的阈值范围。该公式必须从期望效用最大化以及将阈值定义为期望获益与期望损害之间的无差异点出发，不使用任何预先提供的净获益公式。\n\n使用的基本原理和定义：\n- 考虑一个大小为 $N$ 的队列，其二元结局为 $y_i \\in \\{0,1\\}$，其中 $i \\in \\{1,\\dots,N\\}$，$y_i=1$ 表示患有脓毒症，$y_i=0$ 表示未患脓毒症。\n- 一个预测模型为每个个体 $i$ 输出校准后的风险估计值 $\\hat{p}_i \\in [0,1]$。\n- 一个决策阈值 $t \\in (0,1)$ 导出一个治疗决策规则 $d_i(t) \\in \\{0,1\\}$，其定义为：当且仅当 $\\hat{p}_i \\ge t$ 时，$d_i(t)=1$，否则 $d_i(t)=0$。\n- 在期望效用最大化下，并进行归一化，即治疗一个真阳性病例的获益为 $B=1$，而治疗一个非病例的损害为一个正数 $H>0$，阈值 $t$ 是治疗与不治疗之间的无差异点。这是一个经过充分检验的决策理论事实，它通过阈值 $t$ 处的几率将 $t$ 与损害-获益比联系起来。你必须利用这一点来推导一个可计算的标准化净获益表达式，该表达式依赖于阈值 $t$ 下的真阳性（true positives）和假阳性（false positives）计数。\n- 令 $TP(t)$ 和 $FP(t)$ 分别表示在决策规则 $d_i(t)$ 下的真阳性和假阳性计数。令 $N_1=\\sum_{i=1}^N y_i$ 和 $N_0=N-N_1$ 分别表示病例和非病例的数量，事件发生率为 $\\pi=N_1/N$。\n- 定义三种策略进行比较：在每个阈值 $t$ 下由 $d_i(t)$ 导出的基于模型的策略、为所有个体 $i$ 设定 $d_i(t)=1$ 的全员治疗策略，以及为所有个体 $i$ 设定 $d_i(t)=0$ 的全员不治疗策略。\n- 在上述归一化条件下，任何策略在阈值 $t$ 的标准化净获益是相对于“全员不治疗”基线的人均期望效用。你必须将其表示为 $TP(t)$、$FP(t)$、$N$ 以及由 $t$ 隐含并从第一性原理推导出的损害-获益比的函数。\n\n任务要求：\n1) 基于上述原理，推导出一个可计算的表达式，用于表示模型在阈值 $t$ 时的标准化净获益，该表达式以 $TP(t)$、$FP(t)$ 和 $N$ 表示。同时，推导全员治疗和全员不治疗策略的相应表达式，在适当情况下仅使用 $N_1$、$N_0$ 和 $N$。所有推导都必须遵循“正确治疗一个病例的获益 $B=1$”以及“治疗一个非病例的损害与阈值隐含的损害-获益比一致”的归一化原则。\n2) 实现一个程序，对于下方的每个测试用例，在所提供的阈值网格中的每个阈值 $t$ 上，计算模型的标准化净获益、全员治疗的标准化净获益和全员不治疗的标准化净获益。然后，当且仅当模型在阈值 $t$ 的标准化净获益严格大于全员治疗和全员不治疗策略在该阈值 $t$ 的标准化净获益时（使用严格不等式），声明该阈值 $t$ 具有临床价值。\n3) 在离散的阈值网格上，将连续的具有临床价值的阈值合并成最大的连续区间。如果两个阈值在给定网格中是相邻的，则它们是连续的。每个区间必须报告为一个包含两个元素的列表 $[t_{\\min}, t_{\\max}]$，其中 $t_{\\min}$ 和 $t_{\\max}$ 精确取自所提供的阈值。\n4) 对于每个测试用例，输出这些区间的列表。将所有测试用例的结果汇总到单行中，格式如“最终输出格式”部分所述。\n\n测试套件：\n- 对所有测试用例使用以下通用阈值网格：$T=\\left[0.1, 0.2, 0.33, 0.5, 0.67, 0.8, 0.9\\right]$。\n- 测试用例 1（中等区分度的模型，$N=10$）：\n  - 预测值 $\\hat{p}$: $[0.9, 0.8, 0.6, 0.55, 0.6, 0.45, 0.3, 0.2, 0.1, 0.05]$\n  - 结局 $y$: $[1,1,1,1,0,0,0,0,0,0]$\n- 测试用例 2（无信息量的恒定模型，$N=10$）：\n  - 预测值 $\\hat{p}$: $[0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3]$\n  - 结局 $y$: $[1,0,0,1,0,0,1,0,0,0]$\n- 测试用例 3（近乎完美的分离，$N=10$）：\n  - 预测值 $\\hat{p}$: $[0.9,0.9,0.9,0.9,0.9, 0.05,0.05,0.05,0.05,0.05]$\n  - 结局 $y$: $[1,1,1,1,1, 0,0,0,0,0]$\n- 测试用例 4（仅在中等阈值范围内有用的模型，$N=10$）：\n  - 预测值 $\\hat{p}$: $[0.55, 0.08, 0.45, 0.4, 0.35, 0.3, 0.25, 0.2, 0.12, 0.11]$\n  - 结局 $y$: $[1, 1, 0, 0, 0, 0, 0, 0, 0, 0]$\n\n最终输出格式：\n- 你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。每个元素按顺序对应一个测试用例，其本身是一个区间列表，每个区间是一个包含两个元素的列表 $[t_{\\min},t_{\\max}]$，其中的浮点数精确等于 $T$ 的成员。例如：$[[[0.1,0.5],[0.8,0.9]],[],[[0.1,0.9]],[[0.5,0.5]]]$ 表示第一个案例有两个区间，第二个案例没有，第三个案例有一个，第四个案例有一个退化区间。在确定临床价值时确保使用严格不等式，并且不包括任何模型与基准策略持平的阈值。",
            "solution": "用户提供的问题是有效的。它在决策理论和生物统计学，特别是在决策曲线分析（DCA）的方法学上具有科学依据。问题是良构的（well-posed），为获得唯一解提供了所有必要的数据、定义和约束。语言客观，要求可以形式化为一个计算任务。\n\n### 第 1 步：标准化净获益公式的推导\n\n这个问题的核心是按要求从期望效用理论的第一性原理推导标准化净获益 (SNB) 的表达式。\n\n让我们为二元决策（治疗/不治疗）和二元状况（脓毒症/非脓毒症）的四种可能结局定义相关的效用：\n- $U_{\\text{TP}}$: 治疗脓毒症患者的效用（真阳性）。\n- $U_{\\text{FP}}$: 治疗非脓毒症患者的效用（假阳性）。\n- $U_{\\text{FN}}$: 不治疗脓毒症患者的效用（假阴性）。\n- $U_{\\text{TN}}$: 不治疗非脓毒症患者的效用（真阴性）。\n\n问题提供了一个归一化方案。正确治疗一个病例的获益是 $B=1$。这是治疗脓毒症患者相比不治疗他们的净效用增益：\n$$U_{\\text{TP}} - U_{\\text{FN}} = B = 1$$\n\n错误治疗一个非病例的损害是一个正数 $H$。这是治疗非脓毒症患者相比不治疗他们的净效用损失：\n$$U_{\\text{TN}} - U_{\\text{FP}} = H \\implies U_{\\text{FP}} - U_{\\text{TN}} = -H$$\n\n决策阈值 $t$ 被定义为决策者在治疗与不治疗之间无差异时的疾病概率。对于一个疾病风险为 $p$ 的个体，其期望效用为：\n- 治疗的期望效用：$E[U(\\text{treat})] = p \\cdot U_{\\text{TP}} + (1-p) \\cdot U_{\\text{FP}}$\n- 不治疗的期望效用：$E[U(\\text{no treat})] = p \\cdot U_{\\text{FN}} + (1-p) \\cdot U_{\\text{TN}}$\n\n在无差异阈值 $t$ 处，我们设 $p=t$ 并令两个期望效用相等：\n$$t \\cdot U_{\\text{TP}} + (1-t) \\cdot U_{\\text{FP}} = t \\cdot U_{\\text{FN}} + (1-t) \\cdot U_{\\text{TN}}$$\n重排各项，按 $t$ 和 $(1-t)$ 分组：\n$$t \\cdot (U_{\\text{TP}} - U_{\\text{FN}}) = (1-t) \\cdot (U_{\\text{TN}} - U_{\\text{FP}})$$\n代入获益 $B=1$ 和损害 $H$ 的定义：\n$$t \\cdot 1 = (1-t) \\cdot H$$\n这给出了由阈值 $t$ 隐含的损害-获益比：\n$$H = \\frac{t}{1-t}$$\n这个比率表示为了确保治疗一名患病者，决策者愿意不必要地治疗的非患病者数量。\n\n接下来，我们为一个应用于 $N$ 个个体队列的给定决策策略构建净获益。设 $TP(t)$ 和 $FP(t)$ 分别为阈值 $t$ 时的真阳性和假阳性计数。接受治疗的总人数为 $TP(t) + FP(t)$。患病人数（病例）为 $N_1$，未患病人数（非病例）为 $N_0$。总队列大小为 $N = N_1 + N_0$。假阴性人数为 $FN(t) = N_1 - TP(t)$，真阴性人数为 $TN(t) = N_0 - FP(t)$。\n\n一个策略的总效用是所有个体效用的总和：\n$$U_{\\text{strategy}} = TP(t) \\cdot U_{\\text{TP}} + FP(t) \\cdot U_{\\text{FP}} + FN(t) \\cdot U_{\\text{FN}} + TN(t) \\cdot U_{\\text{TN}}$$\n\n基线策略是“全员不治疗”。对于此策略，$TP=0$，$FP=0$，$FN=N_1$，$TN=N_0$。其总效用为：\n$$U_{\\text{treat-none}} = N_1 \\cdot U_{\\text{FN}} + N_0 \\cdot U_{\\text{TN}}$$\n\n一个策略的净效用是其相对于“全员不治疗”基线的效用：\n$$\\text{Net Utility} = U_{\\text{strategy}} - U_{\\text{treat-none}}$$\n$$\\text{Net Utility} = (TP(t) \\cdot U_{\\text{TP}} + \\dots) - (N_1 \\cdot U_{\\text{FN}} + N_0 \\cdot U_{\\text{TN}})$$\n代入 $FN(t) = N_1 - TP(t)$ 和 $TN(t) = N_0 - FP(t)$：\n$$\\text{Net Utility} = TP(t) \\cdot U_{\\text{TP}} + FP(t) \\cdot U_{\\text{FP}} + (N_1-TP(t)) \\cdot U_{\\text{FN}} + (N_0-FP(t)) \\cdot U_{\\text{TN}} - N_1 \\cdot U_{\\text{FN}} - N_0 \\cdot U_{\\text{TN}}$$\n展开并化简，涉及 $N_1$ 和 $N_0$ 的项相互抵消：\n$$\\text{Net Utility} = TP(t) \\cdot (U_{\\text{TP}} - U_{\\text{FN}}) + FP(t) \\cdot (U_{\\text{FP}} - U_{\\text{TN}})$$\n代入 $B=1$ 和 $-H$：\n$$\\text{Net Utility} = TP(t) \\cdot 1 + FP(t) \\cdot (-H) = TP(t) - FP(t) \\cdot H$$\n\n标准化净获益 (SNB) 是人均净效用，通过除以 $N$ 得到：\n$$SNB(t) = \\frac{TP(t) - FP(t) \\cdot H}{N}$$\n最后，代入 $H = t/(1-t)$，我们得到模型在阈值 $t$ 时的 SNB 的可计算表达式：\n$$SNB_{\\text{model}}(t) = \\frac{TP(t)}{N} - \\frac{FP(t)}{N} \\frac{t}{1-t}$$\n\n我们现在可以推导两种基准策略的 SNB：\n\n1.  **全员不治疗策略**：在此策略下，无人接受治疗，因此对于任何 $t$，$TP(t)=0$ 且 $FP(t)=0$。\n    $$SNB_{\\text{none}}(t) = \\frac{0}{N} - \\frac{0}{N} \\frac{t}{1-t} = 0$$\n    这符合预期，因为它作为基线。\n\n2.  **全员治疗策略**：在此策略下，每个人都接受治疗。真阳性的数量是总病例数 $N_1$，假阳性的数量是总非病例数 $N_0$。\n    $$SNB_{\\text{all}}(t) = \\frac{N_1 - N_0 \\cdot H}{N} = \\frac{N_1}{N} - \\frac{N_0}{N} \\frac{t}{1-t}$$\n\n### 第 2 步：实施计划\n\n程序将为每个测试用例执行以下步骤：\n1.  接收预测风险 $\\hat{p}$ 和真实结局 $y$ 的数组。\n2.  计算队列常数：$N = \\text{len}(y)$，$N_1 = \\sum y$ 和 $N_0 = N - N_1$。\n3.  遍历提供的阈值网格 $T$ 中的每个阈值 $t$。\n4.  对于每个 $t$，计算：\n    a. 基于规则 $\\hat{p}_i \\ge t$ 的二元决策。\n    b. 模型的真阳性 $TP(t)$ 和假阳性 $FP(t)$ 计数。\n    c. 三种标准化净获益：$SNB_{\\text{model}}(t)$、$SNB_{\\text{all}}(t)$ 和 $SNB_{\\text{none}}(t)=0$，使用上面推导的公式。\n5.  对每个 $t$ 判断模型是否具有临床价值，这要求严格不等式 $SNB_{\\text{model}}(t) > SNB_{\\text{all}}(t)$ 和 $SNB_{\\text{model}}(t) > SNB_{\\text{none}}(t)$ 同时成立。\n6.  从布尔型的“有用性”标志数组中，识别出 `True` 值的最大连续块。“连续”指的是在阈值网格 $T$ 中的相邻索引。\n7.  对于每个这样的块，使用 $T$ 中相应的阈值形成一个区间 $[t_{\\min}, t_{\\max}]$。\n8.  将这些区间收集到该测试用例的列表中。\n9.  处理完所有测试用例后，将汇总结果格式化为指定的单行字符串。\n\n实现将使用 `numpy` 进行高效的基于数组的 $TP(t)$ 和 $FP(t)$ 计算。区间合并逻辑将遍历有用性标志，以找到每个具有临床价值的阈值连续块的起点和终点。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements Decision Curve Analysis from first principles for multiple test cases.\n    \"\"\"\n    \n    # Common threshold grid for all test cases\n    T = np.array([0.1, 0.2, 0.33, 0.5, 0.67, 0.8, 0.9])\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"p_hat\": np.array([0.9, 0.8, 0.6, 0.55, 0.6, 0.45, 0.3, 0.2, 0.1, 0.05]),\n            \"y\": np.array([1, 1, 1, 1, 0, 0, 0, 0, 0, 0])\n        },\n        {\n            \"p_hat\": np.array([0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3]),\n            \"y\": np.array([1, 0, 0, 1, 0, 0, 1, 0, 0, 0])\n        },\n        {\n            \"p_hat\": np.array([0.9, 0.9, 0.9, 0.9, 0.9, 0.05, 0.05, 0.05, 0.05, 0.05]),\n            \"y\": np.array([1, 1, 1, 1, 1, 0, 0, 0, 0, 0])\n        },\n        {\n            \"p_hat\": np.array([0.55, 0.08, 0.45, 0.4, 0.35, 0.3, 0.25, 0.2, 0.12, 0.11]),\n            \"y\": np.array([1, 1, 0, 0, 0, 0, 0, 0, 0, 0])\n        }\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        p_hat = case[\"p_hat\"]\n        y = case[\"y\"]\n\n        N = len(y)\n        N_1 = np.sum(y)\n        N_0 = N - N_1\n\n        is_useful = []\n\n        for t in T:\n            # Avoid division by zero for t=1, though not in grid\n            if t >= 1.0:\n                is_useful.append(False)\n                continue\n            \n            # Calculate TP and FP for the model at threshold t\n            decisions = p_hat >= t\n            tp = np.sum((decisions == 1)  (y == 1))\n            fp = np.sum((decisions == 1)  (y == 0))\n            \n            # Harm-to-benefit ratio implied by threshold t\n            h = t / (1 - t)\n\n            # Standardized Net Benefit (SNB) for the three strategies\n            snb_model = (tp - fp * h) / N\n            snb_all = (N_1 - N_0 * h) / N\n            snb_none = 0.0\n\n            # Check for clinical usefulness using strict inequality\n            if snb_model > snb_all and snb_model > snb_none:\n                is_useful.append(True)\n            else:\n                is_useful.append(False)\n\n        # Merge consecutive clinically useful thresholds into intervals\n        intervals = []\n        i = 0\n        while i  len(T):\n            if is_useful[i]:\n                # Found the start of a useful interval\n                t_min = T[i]\n                j = i\n                # Find the end of this contiguous block of useful thresholds\n                while j  len(T) and is_useful[j]:\n                    j += 1\n                t_max = T[j-1]\n                # Append the interval [t_min, t_max]\n                intervals.append([t_min, t_max])\n                # Continue searching from where this block ended\n                i = j\n            else:\n                i += 1\n        \n        all_results.append(intervals)\n    \n    # Convert each result item to its string representation for final output\n    # This also handles converting numpy floats to standard Python floats implicitly\n    # The str() on a list of lists works as required by the output format\n    str_results = [str(res).replace(\" \", \"\") for res in all_results]\n\n    # Final print statement in the exact required format.\n    # The example output format does not contain spaces, so they are removed.\n    print(f\"[{','.join(str_results)}]\")\n\nsolve()\n```"
        }
    ]
}