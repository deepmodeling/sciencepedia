{
    "hands_on_practices": [
        {
            "introduction": "量化隐私风险是评估数据共享伦理可接受性的关键一步。本练习将指导您从基本概率论原理出发，推导在$k$-匿名化保护下身份泄露和属性泄露的风险，这种方法使您能够具体地理解该模型的保护强度及其固有限制，为更复杂的风险-效益分析奠定基础。通过这个练习，您将掌握评估匿名化数据集残留风险的核心技能，这对于履行数据托管人的伦理责任至关重要。",
            "id": "4560898",
            "problem": "一个生物医学研究团队计划在机构审查委员会 (IRB) 的监督下，发布一个去识别化的电子健康记录 (EHR) 数据集用于次级分析。该数据集应用了 $k$-匿名性的定义：每条发布的记录都属于一个至少包含 $k$ 条记录的等价类，这些记录共享相同的准标识符模式。考虑一个攻击者，他知道某个特定个体参与了该研究，并知道其准标识符模式，但除了与已发布数据一致的信息外，没有其他任何能打破僵局的辅助信息。\n\n从概率和贝叶斯定理的基本定义出发，推导在大小为 $k$ 的等价类中，攻击者成功重新识别个体记录的最坏情况下的后验概率。接下来，考虑一个具有 $m$ 个互斥类别的敏感属性 $S$（例如，诊断类别）。在该个体的等价类 $E$ 中，设 $S$ 的经验分布为 $\\mathbf{q} = (q_{1}, q_{2}, \\dots, q_{m})$，且 $\\sum_{j=1}^{m} q_{j} = 1$。在相同的攻击者知识下，推导攻击者成功推断该个体敏感属性值的最大后验概率。\n\n为对同意评估进行伦理风险的形式化，假设研究团队将预期危害量化为身份泄露风险和属性泄露风险的加权和，\n$$\nR = \\lambda_{I} \\, P(\\text{identity correct}) + \\lambda_{A} \\, P(\\text{attribute correct}),\n$$\n其中 $\\lambda_{I} \\ge 0$ 和 $\\lambda_{A} \\ge 0$ 是代表相对危害严重性的机构权重。对于一个特定的等价类，其 $k = 15$，敏感属性分布为 $\\mathbf{q} = (0.90, 0.06, 0.04)$，权重为 $\\lambda_{I} = 0.50$ 和 $\\lambda_{A} = 0.50$，计算 $R$。将最终的 $R$ 值表示为小数，并四舍五入到四位有效数字。",
            "solution": "所述问题具有科学依据、提法明确且客观。它基于数据隐私领域的标准形式化定义，特别是 $k$-匿名性，并使用概率论的基本原理来模拟攻击风险。计算所需的所有参数均已提供，且不存在矛盾。因此，该问题是有效的，我们可以进行形式化的求解。\n\n解决方案分为三个部分：首先，推导身份泄露风险；其次，推导属性泄露风险；第三，根据给定参数计算总预期危害。\n\n**第一部分：身份泄露风险的推导**\n\n设 $E$ 表示攻击者识别出的等价类，其中包含目标特定个体的记录。该等价类的大小为 $|E| = k$。根据 $k$-匿名性的定义，基于准标识符，$E$ 中的所有 $k$ 条记录都是无法区分的。\n\n攻击者知道该个体参与了研究，并已识别出其所在的等价类 $E$。攻击者的目标是从 $E$ 中的 $k$ 条记录中重新识别出属于该个体的特定记录。问题陈述指明，攻击者“除了与已发布数据一致的信息外，没有其他任何能打破僵局的辅助信息”。\n\n设等价类中的记录集合为 $\\{r_1, r_2, \\dots, r_k\\}$。令 $H_i$ 为记录 $r_i$ 是目标个体记录的假设。攻击者的知识状态意味着，先验地，每条记录都等可能地是目标个体的记录。这是无差异原则的应用。每个假设的先验概率为：\n$$\nP(H_i) = \\frac{1}{k} \\quad \\text{for } i = 1, 2, \\dots, k\n$$\n问题要求的是攻击者在最坏情况下的后验概率。由于发布的数据（即等价类本身）没有提供任何信息来区分这 $k$ 条记录，因此后验概率与先验概率相比没有更新。攻击者的最佳猜测是选择 $k$ 条记录中的任意一条。该猜测正确的概率是 $\\frac{1}{k}$。没有任何策略可以改进这一点，因此这代表了攻击者的最大成功概率。从隐私的角度来看，这是最坏的情况。\n\n因此，成功重新识别的最坏情况下的后验概率是：\n$$\nP(\\text{identity correct}) = \\frac{1}{k}\n$$\n\n**第二部分：属性泄露风险的推导**\n\n设 $S$ 是一个具有 $m$ 个互斥类别（表示为 $\\{v_1, v_2, \\dots, v_m\\}$）的敏感属性。在该个体的等价类 $E$ 中，这些属性值的经验分布由向量 $\\mathbf{q} = (q_1, q_2, \\dots, q_m)$ 给出，其中 $q_j$ 是 $E$ 中具有敏感属性值 $v_j$ 的记录所占的比例。已知 $\\sum_{j=1}^{m} q_j = 1$。$E$ 中属性值为 $v_j$ 的记录数量为 $k \\cdot q_j$。\n\n攻击者的目标是正确推断该个体的真实敏感属性值。设 $S_I$ 是该个体的真实属性值。如第一部分所述，从攻击者的角度来看，该个体的记录是从 $E$ 中的 $k$ 条记录中随机抽取的一条。因此，该个体真实属性值为 $v_j$ 的概率等于 $E$ 中具有该属性值的记录的比例：\n$$\nP(S_I = v_j) = q_j\n$$\n一个理性的攻击者会试图最大化其猜对的几率。其最优策略是猜测等价类中最频繁的属性值。该策略的成功概率就是最可能属性的概率。\n\n因此，攻击者成功推断敏感属性值的最大后验概率是：\n$$\nP(\\text{attribute correct}) = \\max_{j \\in \\{1, \\dots, m\\}} \\{q_j\\}\n$$\n\n**第三部分：总预期危害的计算**\n\n总预期危害 $R$ 定义为身份泄露风险和属性泄露风险的加权和：\n$$\nR = \\lambda_{I} \\, P(\\text{identity correct}) + \\lambda_{A} \\, P(\\text{attribute correct})\n$$\n代入前面部分推导出的表达式：\n$$\nR = \\lambda_{I} \\left(\\frac{1}{k}\\right) + \\lambda_{A} \\left(\\max_{j} \\{q_j\\}\\right)\n$$\n我们已知以下具体值：\n- 等价类大小：$k = 15$\n- 敏感属性分布：$\\mathbf{q} = (0.90, 0.06, 0.04)$\n- 机构权重：$\\lambda_{I} = 0.50$ 和 $\\lambda_{A} = 0.50$\n\n首先，我们计算各个风险的概率：\n身份泄露风险为：\n$$\nP(\\text{identity correct}) = \\frac{1}{15}\n$$\n属性泄露风险是分布 $\\mathbf{q}$ 中的最大值：\n$$\nP(\\text{attribute correct}) = \\max\\{0.90, 0.06, 0.04\\} = 0.90\n$$\n现在，将这些概率和给定的权重代入 $R$ 的公式中：\n$$\nR = (0.50) \\cdot \\left(\\frac{1}{15}\\right) + (0.50) \\cdot (0.90)\n$$\n$$\nR = \\frac{0.50}{15} + 0.45\n$$\n$$\nR = \\frac{1/2}{15} + 0.45 = \\frac{1}{30} + 0.45\n$$\n为了进行最终计算，我们可以将分数转换为小数。$\\frac{1}{30} = 0.033333...$\n$$\nR = 0.033333... + 0.45 = 0.483333...\n$$\n问题要求最终答案四舍五入到四位有效数字。前四位有效数字是 $4$、$8$、$3$ 和 $3$。第五位数字是 $3$，小于 $5$，因此我们向下舍入。\n$$\nR \\approx 0.4833\n$$",
            "answer": "$$\n\\boxed{0.4833}\n$$"
        },
        {
            "introduction": "在前一个练习中，我们探讨了即使在$k$-匿名化之后，攻击者仍可能以高置信度推断出敏感属性。为了应对这一漏洞，$l$-多样性等更强的隐私模型应运而生。本练习将让您亲手应用熵$l$-多样性这一具体标准，通过计算信息论中的香农熵来评估数据集中的等价类是否满足多样性要求，从而加深对高级隐私增强技术如何弥补基础模型不足的理解。",
            "id": "4560890",
            "problem": "一个医院联合体计划遵循与知情同意义务一致的伦理数据管理原则，共享一个去标识化的研究数据集。为了在 $k$-匿名性的基础上进一步降低属性泄露风险，该联合体要求敏感属性（国际疾病分类第十版 (ICD-10) 诊断代码）在所有由准标识符（年龄段、性别和邮政编码前三位）构成的 $k$-匿名性等价类中满足熵 $l$-多样性。熵必须使用自然对数（以 $e$ 为底）计算。\n\n三个等价类具有以下诊断代码分布，其中每个计数表示该类中包含该诊断代码的记录数。设诊断代码表示为 $d_1$、$d_2$、$d_3$ 和 $d_4$。\n\n类 $E_1$（$30$ 条记录）：$d_1 = 12$, $d_2 = 10$, $d_3 = 8$。\n\n类 $E_2$（$25$ 条记录）：$d_1 = 20$, $d_2 = 5$。\n\n类 $E_3$（$45$ 条记录）：$d_1 = 15$, $d_2 = 15$, $d_3 = 10$, $d_4 = 5$。\n\n使用有限分类分布的香农熵基本定义以及基于此熵定义的熵 $l$-多样性准则，从基本原理出发，推导并计算最大的实数 $l$，使得上述所有等价类同时满足熵 $l$-多样性。将您的最终数值答案四舍五入到四位有效数字。将 $l$ 表示为一个无单位的纯数。",
            "solution": "该问题要求确定最大的实数 $l$，使得一个数据集对于给定的三个等价类满足熵 $l$-多样性。这涉及计算每个类中敏感属性分布的香non熵，然后应用熵 $l$-多样性的定义。\n\n首先，我们陈述基本原理。离散概率分布 $\\{p_1, p_2, \\ldots, p_n\\}$ 的香农熵 $H$ 定义为：\n$$H = -\\sum_{i=1}^{n} p_i \\log_b(p_i)$$\n问题指定使用自然对数，因此底数 $b$ 是欧拉数 $e$。公式变为：\n$$H = -\\sum_{i=1}^{n} p_i \\ln(p_i)$$\n其中 $p_i$ 是等价类中第 $i$ 个敏感属性值的概率。概率 $p_i$ 计算为具有第 $i$ 个属性的记录数 $c_i$ 与该等价类中的总记录数 $N$ 的比值，即 $p_i = c_i / N$。\n\n熵 $l$-多样性的准则是，对于任何等价类，其敏感属性分布的熵 $H$ 必须大于或等于 $\\ln(l)$：\n$$H \\ge \\ln(l)$$\n为了找到对所有给定等价类（$E_1$、$E_2$ 和 $E_3$）同时成立的 $l$ 的最大值，我们必须为每个类满足以下条件：\n$$H(E_1) \\ge \\ln(l)$$\n$$H(E_2) \\ge \\ln(l)$$\n$$H(E_3) \\ge \\ln(l)$$\n这个不等式组意味着 $\\ln(l)$ 必须小于或等于所有类的熵的最小值：\n$$\\ln(l) \\le \\min\\{H(E_1), H(E_2), H(E_3)\\}$$\n为了找到 $l$ 的最大可能值，我们取等式：\n$$\\ln(l) = \\min\\{H(E_1), H(E_2), H(E_3)\\}$$\n因此，任务简化为计算每个类的香农熵，找出最小值，然后按如下方式计算 $l$：\n$$l = \\exp(\\min\\{H(E_1), H(E_2), H(E_3)\\})$$\n\n现在，我们根据提供的数据计算每个类的熵。\n\n**等价类 $E_1$：**\n总记录数 $N_1 = 30$。\n诊断代码的计数：$c_{1,1} = 12$，$c_{1,2} = 10$，$c_{1,3} = 8$。\n相应的概率为：\n$p_{1,1} = \\frac{12}{30} = \\frac{2}{5} = 0.4$\n$p_{1,2} = \\frac{10}{30} = \\frac{1}{3}$\n$p_{1,3} = \\frac{8}{30} = \\frac{4}{15}$\n熵 $H(E_1)$ 为：\n$$H(E_1) = -\\left[ \\frac{12}{30} \\ln\\left(\\frac{12}{30}\\right) + \\frac{10}{30} \\ln\\left(\\frac{10}{30}\\right) + \\frac{8}{30} \\ln\\left(\\frac{8}{30}\\right) \\right]$$\n$$H(E_1) = -\\left[ 0.4 \\ln(0.4) + \\frac{1}{3} \\ln\\left(\\frac{1}{3}\\right) + \\frac{4}{15} \\ln\\left(\\frac{4}{15}\\right) \\right]$$\n数值计算结果为：\n$$H(E_1) \\approx -[0.4(-0.91629) + 0.33333(-1.09861) + 0.26667(-1.32176)]$$\n$$H(E_1) \\approx -[-0.36652 - 0.36620 - 0.35247] \\approx 1.08519$$\n\n**等价类 $E_2$：**\n总记录数 $N_2 = 25$。\n诊断代码的计数：$c_{2,1} = 20$，$c_{2,2} = 5$。\n相应的概率为：\n$p_{2,1} = \\frac{20}{25} = \\frac{4}{5} = 0.8$\n$p_{2,2} = \\frac{5}{25} = \\frac{1}{5} = 0.2$\n熵 $H(E_2)$ 为：\n$$H(E_2) = -\\left[ \\frac{20}{25} \\ln\\left(\\frac{20}{25}\\right) + \\frac{5}{25} \\ln\\left(\\frac{5}{25}\\right) \\right]$$\n$$H(E_2) = -\\left[ 0.8 \\ln(0.8) + 0.2 \\ln(0.2) \\right]$$\n数值计算结果为：\n$$H(E_2) \\approx -[0.8(-0.22314) + 0.2(-1.60944)]$$\n$$H(E_2) \\approx -[-0.17851 - 0.32189] \\approx 0.50040$$\n\n**等价类 $E_3$：**\n总记录数 $N_3 = 45$。\n诊断代码的计数：$c_{3,1} = 15$，$c_{3,2} = 15$，$c_{3,3} = 10$，$c_{3,4} = 5$。\n相应的概率为：\n$p_{3,1} = \\frac{15}{45} = \\frac{1}{3}$\n$p_{3,2} = \\frac{15}{45} = \\frac{1}{3}$\n$p_{3,3} = \\frac{10}{45} = \\frac{2}{9}$\n$p_{3,4} = \\frac{5}{45} = \\frac{1}{9}$\n熵 $H(E_3)$ 为：\n$$H(E_3) = -\\left[ 2 \\cdot \\frac{15}{45} \\ln\\left(\\frac{15}{45}\\right) + \\frac{10}{45} \\ln\\left(\\frac{10}{45}\\right) + \\frac{5}{45} \\ln\\left(\\frac{5}{45}\\right) \\right]$$\n$$H(E_3) = -\\left[ \\frac{2}{3} \\ln\\left(\\frac{1}{3}\\right) + \\frac{2}{9} \\ln\\left(\\frac{2}{9}\\right) + \\frac{1}{9} \\ln\\left(\\frac{1}{9}\\right) \\right]$$\n数值计算结果为：\n$$H(E_3) \\approx -[0.66667(-1.09861) + 0.22222(-1.50408) + 0.11111(-2.19722)]$$\n$$H(E_3) \\approx -[-0.73241 - 0.33424 - 0.24414] \\approx 1.31079$$\n\n比较计算出的熵：\n$H(E_1) \\approx 1.08519$\n$H(E_2) \\approx 0.50040$\n$H(E_3) \\approx 1.31079$\n最小熵为 $H_{min} = H(E_2) \\approx 0.50040$。\n\n为了找到最大的 $l$，我们令 $\\ln(l) = H_{min}$：\n$$\\ln(l) = H(E_2) = -\\left[ 0.8 \\ln(0.8) + 0.2 \\ln(0.2) \\right] \\approx 0.5004024$$\n现在，我们求解 $l$：\n$$l = \\exp\\left(-\\left[ 0.8 \\ln(0.8) + 0.2 \\ln(0.2) \\right]\\right)$$\n$$l \\approx \\exp(0.5004024) \\approx 1.64947$$\n问题要求答案四舍五入到四位有效数字。\n$1.64947 \\to 1.649$。\n\n因此，使得所有三个等价类都满足熵 $l$-多样性的最大实数 $l$ 约为 $1.649$。",
            "answer": "$$\\boxed{1.649}$$"
        },
        {
            "introduction": "理论风险度量最终需要转化为可执行的系统。本练习将挑战您从理论走向实践，构建一个能够主动执行知情同意中目的限制原则的查询应答系统。您需要将复杂的伦理要求、隐私阈值（如最小群体规模$k_{\\min}$）和统计稳健性（如在“随机缺失”假设下的无偏估计）整合到一个功能性的代码实现中，这真实地反映了现代生物医学数据平台在保障参与者权利和数据科学效用之间取得平衡所面临的挑战。",
            "id": "4560952",
            "problem": "一位研究数据保管人必须为去标识化的生物医学数据的二次分析实施受知情同意约束的查询应答机制。该机制必须遵守源于知情同意的尊重个人和目的限制的伦理原则，具体规定为：来自参与者 $i$ 的数据只能用于该参与者已同意的已声明研究目的，并且这样做不会因群组过小而产生增加的再识别风险。保管人旨在通过返回在尊重知情同意约束的同时对研究人员仍具有科学实用性的估计值，来保护被允许分析的效用。在纯数学和逻辑层面开展工作，以形式化并实现这样一个机制。\n\n使用的基本基础：\n- 核心伦理定义：目的限制和知情同意。形式上，每个个体 $i \\in \\{1,\\dots,N\\}$ 都有一个二元同意指示符 $C_{i,p} \\in \\{0,1\\}$，表示个体 $i$ 是否同意目的 $p$。\n- 抽样理论中经充分检验的事实：如果同意选择是随机缺失（Missing At Random, MAR）的，即在以总体的有限划分（层）$S$ 为条件下，每个层内的同意与感兴趣的结果是独立的，那么通过适当使用已知的包含概率可以实现无偏线性估计。随机缺失（MAR）是调查抽样和生物统计学中的一个标准假设。\n\n数学模型和约束条件：\n- 有 $N$ 个由 $i$ 索引的个体，每个个体都有一个待线性聚合的实值结果 $y_i \\in \\mathbb{R}$，并且每个个体都被分配到一个层 $s(i) \\in \\{0,1,\\dots,S-1\\}$。\n- 一个研究查询是一个元组 $(p,\\mathbf{a})$，其中包含已声明的目的 $p$ 和一个实数权重向量 $\\mathbf{a} = (a_1,\\dots,a_N) \\in \\mathbb{R}^N$，该向量在完整数据上定义了一个目标线性泛函 $\\sum_{i=1}^N a_i y_i$。\n- 一个全局治理策略指定了一组允许的目的 $\\mathcal{P}_{\\mathrm{allowed}}$。如果 $p \\notin \\mathcal{P}_{\\mathrm{allowed}}$，查询必须被阻止。\n- 同意约束：只有 $C_{i,p} = 1$ 的个体才能对计算做出贡献。将在同意下的贡献集合定义为 $I_p = \\{ i \\in \\{1,\\dots,N\\} \\mid C_{i,p} = 1 \\}$。\n- 风险控制（最小群组规模）：设 $k_{\\min} \\in \\mathbb{N}$ 为一个正整数。如果在非零权重所针对的个体中，同意的个体数量小于 $k_{\\min}$，则查询被阻止。形式上，如果 $\\left|\\{ i \\mid a_i \\neq 0 \\text{ and } C_{i,p} = 1 \\}\\right|  k_{\\min}$，则阻止查询。\n- 伦理下的效用保护目标：假设在层内同意是随机缺失（MAR）的，即在以 $s(i)$ 为条件下，同意指示符 $C_{i,p}$ 与 $y_i$ 是随机独立的，每个层 $s \\in \\{0,\\dots,S-1\\}$ 具有特定的同意概率 $r_{s} = \\Pr(C_{i,p} = 1 \\mid s(i)=s)$。该机制只能使用已同意的记录和公开发布的针对声明目的 $p$ 的层级同意率 $r_s$，来为目标 $\\sum_{i=1}^N a_i y_i$ 生成一个估计值 $\\widehat{T}_p(\\mathbf{a})$，使得在 MAR 模型下，$\\mathbb{E}[\\widehat{T}_p(\\mathbf{a})] = \\sum_{i=1}^N a_i y_i$。如果对于任何被非零权重所针对的层 $s$ 存在 $r_s = 0$ 的情况，查询必须被阻止，因为从该层无法获得符合伦理要求可用信息。\n\n您的任务：\n- 设计并实现一个程序，在给定固定的数据集、固定的治理策略和固定的最小群组规模 $k_{\\min}$ 的情况下，接收一小组查询 $(p,\\mathbf{a})$，并为每个查询返回一个实值估计（该估计在 MAR 模型下，仅使用已同意的记录和 $r_s$ 来满足上述约束和无偏性目标），或者在查询被任何阻止规则阻止时返回布尔值 False。\n\n此任务的数据集和策略：\n- 个体数量：$N = 8$。\n- 层数：$S = 2$，层标记为 $0$ 和 $1$。\n- 结果向量 $\\mathbf{y} = (y_1,\\dots,y_8)$，其值为 $\\mathbf{y} = (1.2, 0.5, 2.0, 1.5, 3.0, 2.5, 0.8, 1.1)$。\n- 分层分配向量 $\\mathbf{s} = (s(1),\\dots,s(8)) = (0, 0, 0, 1, 1, 1, 1, 0)$。\n- 考虑的目的数量：$P = 4$，索引为 $p \\in \\{0,1,2,3\\}$。\n- 同意矩阵 $C \\in \\{0,1\\}^{8 \\times 4}$，行为 $i=1,\\dots,8$，列为 $p=0,1,2,3$，具体如下：\n  - 列 $p=0$：$(1, 1, 0, 1, 0, 1, 1, 0)$，\n  - 列 $p=1$：$(1, 0, 1, 1, 1, 0, 1, 1)$，\n  - 列 $p=2$：$(0, 0, 0, 1, 1, 0, 1, 0)$，\n  - 列 $p=3$：$(0, 0, 0, 0, 0, 0, 0, 0)$。\n- 策略下允许的目的：$\\mathcal{P}_{\\mathrm{allowed}} = \\{0,1,2\\}$。\n- 最小群组规模：$k_{\\min} = 3$。\n\n公开发布的针对声明目的 $p$ 的层级同意率 $r_s$ 将根据同意矩阵计算如下：对于每个 $s \\in \\{0,1\\}$，令 $n_s = \\left|\\{ i \\mid s(i) = s \\}\\right|$ 且 $c_{s,p} = \\left|\\{ i \\mid s(i)=s, C_{i,p}=1 \\}\\right|$，则 $r_s = c_{s,p} / n_s$。如果对于任何层 $s$，存在 $a_i \\neq 0$ 且 $s(i)=s$ 的个体 $i$，而该层的 $r_s = 0$，则查询必须被阻止。\n\n测试套件：\n对于上述固定数据集，按顺序评估以下五个查询 $(p,\\mathbf{a})$：\n- 测试 $1$ (正常路径)：$p=0$, $\\mathbf{a} = (1,1,1,1,1,1,1,1)$。\n- 测试 $2$ ($k_{\\min}$ 边界情况)：$p=1$, $\\mathbf{a} = (1, 2, 0, 1, 0, 0.5, 1, 0)$。\n- 测试 $3$ (策略不允许的目的)：$p=3$, $\\mathbf{a} = (1,1,1,1,1,1,1,1)$。\n- 测试 $4$ (同意的贡献者不足)：$p=0$, $\\mathbf{a} = (0,0,1,0,0,0,0,0)$。\n- 测试 $5$ (针对允许的目的，但目标层的同意率为零)：$p=2$, $\\mathbf{a} = (1,1,0,0,0,0,0,0)$。\n\n要求的输出：\n- 您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔的结果列表（例如，“[result1,result2,result3,result4,result5]”）。每个结果必须是回答查询时的一个实数（浮点数），或在查询被阻止时的布尔值 False。不应打印任何额外文本。",
            "solution": "该问题要求设计并实现一个用于应答生物医学数据线性聚合查询的机制，该机制受制于源自知情同意和目的限制伦理原则的约束，以及一项用于降低再识别风险的策略。解决方案必须进行数学形式化，并在指定的统计模型下提供无偏估计。\n\n核心任务是为一个给定的查询 $(p, \\mathbf{a})$ 估计一个目标线性泛函 $T(\\mathbf{a}) = \\sum_{i=1}^N a_i y_i$，该查询包含一个研究目的 $p$ 和一个权重向量 $\\mathbf{a}$。该估计只能使用那些已为目的 $p$ 提供同意的个体数据，即 $C_{i,p}=1$ 的个体。\n\n该问题的一个关键组成部分是假设在预定义的层内，同意是随机缺失（MAR）的。这意味着对于层 $s(i)$ 中的个体 $i$，其对目的 $p$ 的同意概率，记为 $r_{s,p} = \\Pr(C_{i,p}=1 \\mid s(i)=s)$，与结果值 $y_i$ 是随机独立的。这一假设是纠正因仅观察同意个体数据而引入的潜在选择偏差的关键。\n\n设 $\\delta_{i,p}$ 为一个指示随机变量，如果个体 $i$ 同意目的 $p$ (即 $C_{i,p}=1$)，则其值为 $1$，否则为 $0$。根据 MAR 假设，该指示符的条件期望为 $\\mathbb{E}[\\delta_{i,p} \\mid s(i), y_i] = \\mathbb{E}[\\delta_{i,p} \\mid s(i)] = r_{s(i),p}$。\n\n对同意子集进行朴素求和，即 $\\sum_{i \\in I_p} a_i y_i = \\sum_{i=1}^N a_i y_i \\delta_{i,p}$，将会得出 $T(\\mathbf{a})$ 的一个有偏估计。其期望为 $\\mathbb{E}\\left[\\sum_{i=1}^N a_i y_i \\delta_{i,p}\\right] = \\sum_{i=1}^N a_i y_i \\mathbb{E}[\\delta_{i,p}] = \\sum_{i=1}^N a_i y_i r_{s(i),p}$，这不等于期望的目标 $T(\\mathbf{a})$。\n\n为了构建一个无偏估计量，我们应用了逆概率加权原理，这是调查抽样中 Horvitz-Thompson 估计量的一项基本技术。我们通过将每个同意个体的加权结果除以其所在层的同意概率来定义我们的估计量 $\\widehat{T}_p(\\mathbf{a})$：\n$$ \\widehat{T}_p(\\mathbf{a}) = \\sum_{i=1}^N \\frac{a_i y_i \\delta_{i,p}}{r_{s(i),p}} $$\n该估计量的期望确实是目标量：\n$$ \\mathbb{E}[\\widehat{T}_p(\\mathbf{a})] = \\mathbb{E}\\left[ \\sum_{i=1}^N \\frac{a_i y_i \\delta_{i,p}}{r_{s(i),p}} \\right] = \\sum_{i=1}^N \\frac{a_i y_i}{r_{s(i),p}} \\mathbb{E}[\\delta_{i,p}] = \\sum_{i=1}^N \\frac{a_i y_i}{r_{s(i),p}} r_{s(i),p} = \\sum_{i=1}^N a_i y_i = T(\\mathbf{a}) $$\n这证实了在 MAR 模型下，$\\widehat{T}_p(\\mathbf{a})$ 是 $T(\\mathbf{a})$ 的一个无偏估计量。在操作上，该和是在 $C_{i,p}=1$ 且 $a_i \\neq 0$ 的个体集合上计算的。只有当所有包含 $a_i \\neq 0$ 的个体的层 $s$ 都满足 $r_{s,p}  0$ 时，这种估计才是可能的。\n\n完整的查询应答机制还必须强制执行一组阻止规则。仔细分析问题陈述，包括测试用例的描述性标题，表明了这些检查的特定顺序。\n\n评估一个查询 $(p, \\mathbf{a})$ 的算法如下：\n\n1.  **目的治理检查**：如果声明的目的 $p$ 不在允许的目的集合 $\\mathcal{P}_{\\mathrm{allowed}}$ 中，则阻止该查询。如果 $p \\notin \\mathcal{P}_{\\mathrm{allowed}}$，则程序终止并返回 `False`。\n\n2.  **零同意率检查**：此检查可防止估计量中出现除以零的情况，并确保可以从所有必要的人口子群组中获得符合伦理要求的信息。\n    a. 首先，使用给定的公式计算给定目的 $p$ 在每个层 $s \\in \\{0, \\dots, S-1\\}$ 的同意率 $r_{s,p}$：$r_{s,p} = c_{s,p} / n_s$，其中 $n_s = |\\{ i \\mid s(i)=s \\}|$ 且 $c_{s,p} = |\\{ i \\mid s(i)=s, C_{i,p}=1 \\}|$。\n    b. 接着，确定查询所针对的层集合 $S_{\\mathrm{targeted}} = \\{ s(i) \\mid a_i \\neq 0 \\}$。\n    c. 如果存在任何层 $s' \\in S_{\\mathrm{targeted}}$ 的同意率为 $r_{s',p} = 0$，则阻止查询，程序返回 `False`。\n\n3.  **最小群组规模检查**：此规则通过确保任何发布的统计数据都源自足够大的同意参与者群体，来降低再识别风险。\n    a. 确定贡献个体的集合：$I_{p, \\mathbf{a}} = \\{ i \\mid a_i \\neq 0 \\text{ and } C_{i,p} = 1 \\}$。\n    b. 如果该集合的大小小于指定的阈值，即如果 $|I_{p, \\mathbf{a}}|  k_{\\min}$，则阻止查询，程序返回 `False`。\n\n4.  **无偏估计**：如果所有前述检查都通过，则允许查询。使用逆概率加权公式在贡献个体集合 $I_{p, \\mathbf{a}}$ 上计算无偏估计 $\\widehat{T}_p(\\mathbf{a})$：\n    $$ \\widehat{T}_p(\\mathbf{a}) = \\sum_{i \\in I_{p, \\mathbf{a}}} \\frac{a_i y_i}{r_{s(i),p}} $$\n    返回得到的浮点数。\n\n这一系列的检查确保在提供估计值之前，所有伦理、隐私和数学约束都得到满足。如果任何规则被违反，查询将被安全地阻止。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements a consent-constrained query answering mechanism for biomedical data.\n    \"\"\"\n    # Fixed dataset and policy parameters\n    N = 8\n    S = 2\n    y = np.array([1.2, 0.5, 2.0, 1.5, 3.0, 2.5, 0.8, 1.1])\n    s = np.array([0, 0, 0, 1, 1, 1, 1, 0])\n    C = np.array([\n        [1, 1, 0, 0],  # i=1\n        [1, 0, 0, 0],  # i=2\n        [0, 1, 0, 0],  # i=3\n        [1, 1, 1, 0],  # i=4\n        [0, 1, 1, 0],  # i=5\n        [1, 0, 0, 0],  # i=6\n        [1, 1, 1, 0],  # i=7\n        [0, 1, 0, 0],  # i=8\n    ])\n    allowed_purposes = {0, 1, 2}\n    k_min = 3\n\n    # Test suite of queries (p, a)\n    test_cases = [\n        (0, np.array([1, 1, 1, 1, 1, 1, 1, 1])),\n        (1, np.array([1, 2, 0, 1, 0, 0.5, 1, 0])),\n        (3, np.array([1, 1, 1, 1, 1, 1, 1, 1])),\n        (0, np.array([0, 0, 1, 0, 0, 0, 0, 0])),\n        (2, np.array([1, 1, 0, 0, 0, 0, 0, 0])),\n    ]\n\n    results = []\n\n    # Pre-compute stratum sizes n_s\n    n_s = np.bincount(s, minlength=S)\n\n    # Pre-compute consent rates r_{s,p}\n    num_purposes = C.shape[1]\n    r_sp = np.zeros((S, num_purposes))\n    for p_idx in range(num_purposes):\n        for s_idx in range(S):\n            if n_s[s_idx]  0:\n                s_mask = (s == s_idx)\n                c_sp = np.sum(C[s_mask, p_idx])\n                r_sp[s_idx, p_idx] = c_sp / n_s[s_idx]\n\n    for p, a in test_cases:\n        # Step 1: Purpose Governance Check\n        if p not in allowed_purposes:\n            results.append(False)\n            continue\n\n        # Step 2: Zero Consent Rate Check\n        targeted_strata_indices = np.unique(s[a != 0])\n        block_query = False\n        for s_idx in targeted_strata_indices:\n            if r_sp[s_idx, p] == 0:\n                block_query = True\n                break\n        if block_query:\n            results.append(False)\n            continue\n        \n        # Step 3: Minimum Group Size Check\n        consenting_mask = (C[:, p] == 1)\n        targeted_mask = (a != 0)\n        contributing_mask = consenting_mask  targeted_mask\n        num_contributors = np.sum(contributing_mask)\n        \n        if num_contributors  k_min:\n            results.append(False)\n            continue\n\n        # Step 4: Unbiased Estimation\n        estimate = 0.0\n        contributing_indices = np.where(contributing_mask)[0]\n        \n        for i in contributing_indices:\n            stratum_of_i = s[i]\n            consent_rate = r_sp[stratum_of_i, p]\n            # This check is redundant due to step 2, but good for robustness\n            if consent_rate  0:\n                estimate += (a[i] * y[i]) / consent_rate\n            else:\n                # Should not be reached given the logic in Step 2\n                estimate = \"Error: Division by zero\"\n                break\n        \n        if isinstance(estimate, str): # Error case\n            results.append(False) # Or handle error appropriately\n        else:\n            results.append(estimate)\n            \n    # Format the final output\n    formatted_results = []\n    for res in results:\n        if isinstance(res, bool):\n            formatted_results.append(str(res))\n        else:\n            # Use standard float representation\n            formatted_results.append(str(res))\n            \n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}