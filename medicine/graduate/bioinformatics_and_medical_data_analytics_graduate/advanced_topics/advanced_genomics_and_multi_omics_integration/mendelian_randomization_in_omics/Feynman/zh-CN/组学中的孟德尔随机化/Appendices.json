{
    "hands_on_practices": [
        {
            "introduction": "在使用遗传变异作为工具变量之前，我们必须验证其相关性——即它们与暴露因素的强关联。本练习侧重于使用第一阶段 $F$ 统计量来量化工具变量的强度，这是评估孟德尔随机化（MR）分析中是否存在弱工具变量偏倚的基石。掌握这一计算  是确保您的研究建立在坚实基础上的第一步。",
            "id": "4583111",
            "problem": "组学中的孟德尔随机化（MR）分析旨在利用遗传变异作为工具变量，来估计组学暴露（例如，基因的标准化表达水平）对下游表型的因果效应。工具变量的相关性通过第一阶段暴露对每个基因型进行回归来评估。使用以下基因型-暴露（$G \\!-\\! X$）效应的汇总关联数据，假设这些数据是在单一大学习样本中，通过普通最小二乘法估计的，且满足工具变量独立（无连锁不平衡）和同方差残差的条件：\n\n- 变异 $1$: $\\hat{\\beta}_{XG,1} = 0.06$, $\\operatorname{SE}(\\hat{\\beta}_{XG,1}) = 0.012$。\n- 变异 $2$: $\\hat{\\beta}_{XG,2} = 0.04$, $\\operatorname{SE}(\\hat{\\beta}_{XG,2}) = 0.010$。\n- 变异 $3$: $\\hat{\\beta}_{XG,3} = 0.03$, $\\operatorname{SE}(\\hat{\\beta}_{XG,3}) = 0.015$。\n- 变异 $4$: $\\hat{\\beta}_{XG,4} = 0.09$, $\\operatorname{SE}(\\hat{\\beta}_{XG,4}) = 0.008$。\n- 变异 $5$: $\\hat{\\beta}_{XG,5} = 0.05$, $\\operatorname{SE}(\\hat{\\beta}_{XG,5}) = 0.011$。\n\n从线性回归和经典检验统计量的基本统计学定义出发，计算每个变异的第一阶段$F$统计量以评估工具变量的相关性。然后，为了以一种与跨独立工具变量的广义最小二乘法相一致的方式评估整个工具变量集的强度，使用一种精确度加权的方法来汇总这些单个变异的强度，其中每个变异的贡献与其暴露关联方差的倒数成正比。将最终的工具变量集强度表示为一个标量，其值等于每个变异第一阶段$F$统计量的逆方差加权平均值。将您的答案四舍五入到四位有效数字。最终的标量不需要单位。",
            "solution": "该问题要求计算在孟德尔随机化（MR）分析中使用的一组遗传变异的汇总工具变量强度。这包括两个主要步骤：首先，计算每个变异的第一阶段$F$统计量以评估工具变量相关性；其次，使用特定的精确度加权平均方案汇总这些统计量。\n\n### 步骤1：各变异的第一阶段$F$统计量\n\nMR分析的第一阶段是将暴露量$X$对遗传工具变量$G_j$进行回归。对于单个工具变量$j$，简单线性回归模型为：\n$$\nX = \\alpha_j + \\beta_{XG,j} G_j + \\epsilon_j\n$$\n其中$\\beta_{XG,j}$是表示工具变量$G_j$与暴露量$X$之间关联的系数。问题提供了这些系数的普通最小二乘法（OLS）估计值$\\hat{\\beta}_{XG,j}$及其标准误$\\operatorname{SE}(\\hat{\\beta}_{XG,j})$。\n\n工具变量的相关性通过检验原假设$H_0: \\beta_{XG,j} = 0$来评估。在大样本中，该假设的Wald检验统计量是$t$统计量，计算方法是估计值与其标准误的比值：\n$$\nt_j = \\frac{\\hat{\\beta}_{XG,j}}{\\operatorname{SE}(\\hat{\\beta}_{XG,j})}\n$$\n对于具有单个预测变量的简单线性回归，用于检验回归显著性的$F$统计量是相应$t$统计量的平方：\n$$\nF_j = t_j^2 = \\left( \\frac{\\hat{\\beta}_{XG,j}}{\\operatorname{SE}(\\hat{\\beta}_{XG,j})} \\right)^2\n$$\n我们为所提供的5个变异中的每一个计算这个值。\n\n- **变异 1：**\n  $\\hat{\\beta}_{XG,1} = 0.06$, $\\operatorname{SE}(\\hat{\\beta}_{XG,1}) = 0.012$\n  $$ F_1 = \\left( \\frac{0.06}{0.012} \\right)^2 = 5^2 = 25 $$\n\n- **变异 2：**\n  $\\hat{\\beta}_{XG,2} = 0.04$, $\\operatorname{SE}(\\hat{\\beta}_{XG,2}) = 0.010$\n  $$ F_2 = \\left( \\frac{0.04}{0.010} \\right)^2 = 4^2 = 16 $$\n\n- **变异 3：**\n  $\\hat{\\beta}_{XG,3} = 0.03$, $\\operatorname{SE}(\\hat{\\beta}_{XG,3}) = 0.015$\n  $$ F_3 = \\left( \\frac{0.03}{0.015} \\right)^2 = 2^2 = 4 $$\n\n- **变异 4：**\n  $\\hat{\\beta}_{XG,4} = 0.09$, $\\operatorname{SE}(\\hat{\\beta}_{XG,4}) = 0.008$\n  $$ F_4 = \\left( \\frac{0.09}{0.008} \\right)^2 = (11.25)^2 = 126.5625 $$\n\n- **变异 5：**\n  $\\hat{\\beta}_{XG,5} = 0.05$, $\\operatorname{SE}(\\hat{\\beta}_{XG,5}) = 0.011$\n  $$ F_5 = \\left( \\frac{0.05}{0.011} \\right)^2 \\approx (4.5454...)^2 \\approx 20.661157 $$\n\n### 步骤2：汇总的工具变量强度\n\n问题指定，应将整体工具变量集的强度计算为各变异第一阶段$F$统计量的逆方差加权平均值。每个变异贡献的权重与其精确度成正比，精确度是其暴露关联估计值方差的倒数。\n\n设$F_j$为变异$j$的$F$统计量。权重$w_j$由下式给出：\n$$\nw_j = \\frac{1}{\\operatorname{Var}(\\hat{\\beta}_{XG,j})} = \\frac{1}{(\\operatorname{SE}(\\hat{\\beta}_{XG,j}))^2}\n$$\n$F$统计量的逆方差加权平均值，记为$\\bar{F}_{IVW}$，则为：\n$$\n\\bar{F}_{IVW} = \\frac{\\sum_{j=1}^{5} w_j F_j}{\\sum_{j=1}^{5} w_j}\n$$\n代入$w_j$和$F_j$的表达式：\n$$\n\\bar{F}_{IVW} = \\frac{\\sum_{j=1}^{5} \\frac{1}{(\\operatorname{SE}(\\hat{\\beta}_{XG,j}))^2} \\left( \\frac{\\hat{\\beta}_{XG,j}}{\\operatorname{SE}(\\hat{\\beta}_{XG,j})} \\right)^2}{\\sum_{j=1}^{5} \\frac{1}{(\\operatorname{SE}(\\hat{\\beta}_{XG,j}))^2}} = \\frac{\\sum_{j=1}^{5} \\frac{\\hat{\\beta}_{XG,j}^2}{(\\operatorname{SE}(\\hat{\\beta}_{XG,j}))^4}}{\\sum_{j=1}^{5} \\frac{1}{(\\operatorname{SE}(\\hat{\\beta}_{XG,j}))^2}}\n$$\n现在，我们分别计算分子和分母。\n\n**分母（权重之和）：**\n$$\n\\sum_{j=1}^{5} w_j = \\frac{1}{(0.012)^2} + \\frac{1}{(0.010)^2} + \\frac{1}{(0.015)^2} + \\frac{1}{(0.008)^2} + \\frac{1}{(0.011)^2}\n$$\n$$\n\\sum_{j=1}^{5} w_j = \\frac{1}{0.000144} + \\frac{1}{0.0001} + \\frac{1}{0.000225} + \\frac{1}{0.000064} + \\frac{1}{0.000121}\n$$\n$$\n\\sum_{j=1}^{5} w_j \\approx 6944.4444 + 10000 + 4444.4444 + 15625 + 8264.4628 \\approx 45278.3517\n$$\n\n**分子（加权F统计量之和）：**\n$$\n\\sum_{j=1}^{5} w_j F_j = \\frac{25}{(0.012)^2} + \\frac{16}{(0.010)^2} + \\frac{4}{(0.015)^2} + \\frac{126.5625}{(0.008)^2} + \\frac{(0.05/0.011)^2}{(0.011)^2}\n$$\n$$\n\\sum_{j=1}^{5} w_j F_j \\approx 173611.1111 + 160000 + 17777.7778 + 1977539.0625 + 170756.0959\n$$\n$$\n\\sum_{j=1}^{5} w_j F_j \\approx 2499684.0473\n$$\n\n**最终计算：**\n$$\n\\bar{F}_{IVW} = \\frac{2499684.0473}{45278.3517} \\approx 55.20667\n$$\n问题要求将最终答案四舍五入到四位有效数字。\n$$\n\\bar{F}_{IVW} \\approx 55.21\n$$",
            "answer": "$$\\boxed{55.21}$$"
        },
        {
            "introduction": "双样本孟德尔随机化通常会整合来自不同研究的数据，这在等位基因编码和DNA链方向上带来了挑战。本动手编程练习  将指导您完成等位基因协调这一至关重要的生物信息学任务，它是一个关键的预处理步骤，用以确保在合并进行因果推断之前，单核苷酸多态性（SNP）效应的方向是一致的。您还将学习如何处理可能引入歧义的回文型SNP。",
            "id": "4583355",
            "problem": "给定代表孟德尔随机化 (Mendelian Randomization, MR) 中暴露与结局的成对单核苷酸多态性 (Single Nucleotide Polymorphism, SNP) 汇总统计数据集。每个 SNP 的数据集包含：SNP 标识符、效应等位基因、非效应等位基因、效应量，以及可选的效应等位基因频率 (Effect Allele Frequency, EAF)。您的任务是基于核苷酸互补和频率消歧的基本原理，实现等位基因协调和回文 SNP 的排除。\n\n基本原理：\n- 核苷酸互补映射 $c(\\cdot)$ 定义为 $c(A)=T$、$c(T)=A$、$c(C)=G$、$c(G)=C$。\n- 等位基因的方向是相对于效应等位基因确定的。颠倒指定为效应等位基因的等位基因，会使报告的效应量乘以 $-1$，并将效应等位基因频率 $f$ 替换为 $1-f$。\n- 如果一个 SNP 等位基因对的无序集合是 $\\{A,T\\}$ 或 $\\{C,G\\}$，则其为回文结构，这会产生链模糊性，除非通过效应等位基因频率 (EAF) 信息解决。\n- 效应等位基因频率 (EAF) 决定了效应等位基因的频率；次要等位基因频率为 $\\min\\{f,1-f\\}$。\n\n应用的定义：\n- 通过仅按以下顺序使用以下操作，将结局等位基因转换为与暴露等位基因匹配，从而协调一个 SNP：精确等位基因匹配、等位基因翻转、链互补以及互补翻转。如果结局等位基因在这些操作下无法与暴露等位基因匹配，则该 SNP 作为不兼容项被排除。\n- 如果暴露 SNP 等位基因对是回文结构，则必须排除该 SNP，除非存在 EAF 并且可以进行无歧义的方向确定。使用以下规则：在容差 $\\epsilon = 0.05$ 和模糊性阈值 $\\tau = 0.42$ 的情况下，仅当暴露和结局都具有 EAF，两个次要等位基因频率都 $\\le \\tau$，并且在对结局 EAF 应用协调方向后，对齐的结局 EAF 在 $\\epsilon$ 范围内等于暴露 EAF 或其补数时，才保留回文 SNP。否则，将该 SNP 作为回文结构模糊项排除。\n- 协调必须将结局与暴露对齐，以使效应等位基因在两者中都指向相同的生物学等位基因。如果需要翻转，则将结局效应量乘以 $-1$；如果需要链互补，则仅改变等位基因标签，效应量保持不变（除非同时应用翻转）。当应用翻转时，为了 EAF 一致性检查，将结局 EAF $f$ 替换为 $1-f$。\n\n目标：\n- 对于每个测试用例，在协调和排除步骤之后，计算：\n  1. 保留的已协调 SNP 数量 $n_{\\text{keep}}$（一个整数）。\n  2. 排除的回文 SNP 数量 $n_{\\text{pal\\_excluded}}$（一个整数）。\n  3. 一个校验和，定义为在所有保留的 SNP 上的 $\\sum_i \\beta_{\\text{exp},i}\\cdot \\tilde{\\beta}_{\\text{out},i}$，其中 $\\tilde{\\beta}_{\\text{out},i}$ 是与暴露效应等位基因对齐的已协调结局效应量。将校验和报告为四舍五入到 $6$ 位小数的浮点数。\n\n实现的输入作为三个测试用例嵌入在程序中。每个测试用例包含两个列表：暴露和结局的汇总数据，记录形式为 [snp, a1, a2, beta, eaf]，其中 a1 是效应等位基因，a2 是非效应等位基因，beta 是效应量，eaf 是效应等位基因频率（可能为空）。所有等位基因符号均来自集合 $\\{A, C, G, T\\}$。\n\n测试套件：\n- 测试用例 1：\n  - 暴露：\n    - [rs1, A, G, $0.2$, $0.20$]\n    - [rs2, C, T, $-0.3$, $0.35$]\n    - [rs3, A, T, $0.1$, $0.49$]\n    - [rs4, C, G, $0.05$, $0.10$]\n    - [rs5, A, C, $0.4$, $0.60$]\n  - 结局：\n    - [rs1, A, G, $0.1$, $0.19$]\n    - [rs2, T, C, $0.5$, $0.65$]\n    - [rs3, T, A, $0.2$, $0.51$]\n    - [rs4, G, C, $-0.07$, $0.90$]\n    - [rs5, T, G, $0.3$, $0.40$]\n- 测试用例 2：\n  - 暴露：\n    - [rs10, G, T, $0.2$, $0.58$]\n    - [rs11, A, T, $-0.12$, $0.20$]\n    - [rs12, C, G, $0.05$, null]\n    - [rs13, A, C, $0.3$, $0.45$]\n    - [rs14, A, G, $-0.25$, $0.33$]\n  - 结局：\n    - [rs10, C, A, $0.15$, $0.42$]\n    - [rs11, T, A, $0.3$, $0.80$]\n    - [rs12, G, C, $0.02$, $0.90$]\n    - [rs13, A, G, $-0.2$, $0.45$]\n    - [rs14, C, T, $0.5$, $0.67$]\n- 测试用例 3：\n  - 暴露：\n    - [rs20, A, T, $0.5$, $0.42$]\n    - [rs21, C, G, $-0.2$, $0.58$]\n    - [rs22, A, C, $0.1$, $0.30$]\n    - [rs23, G, T, $-0.05$, $0.51$]\n    - [rs24, T, A, $0.2$, $0.50$]\n  - 结局：\n    - [rs20, T, A, $-0.1$, $0.58$]\n    - [rs21, C, G, $0.4$, $0.58$]\n    - [rs22, T, G, $0.2$, $0.70$]\n    - [rs23, A, C, $0.06$, $0.49$]\n    - [rs24, A, T, $0.1$, $0.50$]\n\n涵盖的边缘情况包括：精确匹配、等位基因翻转、链互补、互补翻转、EAF 接近 $0.5$ 的回文 SNP、可通过 EAF 解析的回文 SNP、因 EAF 缺失导致的排除，以及无法匹配的不兼容等位基因。\n\n您的程序必须：\n- 根据上述定义，使用 $\\epsilon = 0.05$ 和 $\\tau = 0.42$ 实现协调和回文排除。\n- 对每个测试用例，计算 $n_{\\text{keep}}$、$n_{\\text{pal\\_excluded}}$ 和四舍五入到 $6$ 位小数的校验和。\n- 生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每个测试用例的结果本身是一个形式为 [$n_{\\text{keep}}$, $n_{\\text{pal\\_excluded}}$, checksum] 的列表。例如：“[[x1,y1,z1],[x2,y2,z2],[x3,y3,z3]]”。",
            "solution": "用户提供的问题已经过评估，并被确定为 **有效**。这是一个具有科学依据、定义明确且客观的问题陈述，植根于孟德尔随机化 (MR) 分析的标准生物信息学流程。该问题提供了一套完整的定义、数据和约束，允许开发出独特且可验证的解决方案。等位基因协调和处理回文单核苷酸多态性 (SNP) 的逻辑与遗传流行病学中既定的方法一致。\n\n### 基于原则的算法设计\n\n核心任务是逐个 SNP 地协调来自两项研究（暴露和结局）的汇总统计数据，确保效应等位基因及其对应的效应量 ($\\beta$) 指向同一生物变异。此过程涉及对齐等位基因标签、处理链方向，并应用特定规则排除方向不明确的 SNP。\n\n#### 1. 基本遗传学定义\n\n该算法依赖于核苷酸碱基的沃森-克里克 (Watson-Crick) 配对。我们定义一个互补函数 $c(\\cdot)$，使得：\n$$ c(A) = T, \\quad c(T) = A, \\quad c(C) = G, \\quad c(G) = C $$\n一个 SNP 由一对等位基因定义，例如 $(A, G)$。在汇总统计中，一个等位基因被指定为效应等位基因 ($a_1$)，另一个为非效应等位基因 ($a_2$)。效应量 $\\beta$ 表示与每个 $a_1$ 拷贝相关的性状变化。颠倒指定，使 $a_2$ 成为效应等位基因，会反转效应的符号，因此 $\\beta$ 变为 $-\\beta$。同时，效应等位基因频率 (EAF) $f$（即 $a_1$ 的频率）会转换为 $1-f$。\n\n如果一个 SNP 的等位基因互为互补，则其被归类为**回文**结构。其无序等位基因集为 $\\{A, T\\}$ 或 $\\{C, G\\}$。这会产生模糊性，因为例如，在正向链上，一个 $A/T$ SNP 在反向链上的互补表示为 $T/A$。若无更多信息，则无法确定一个数据集中观察到的 $A$ 等位基因对应于另一个数据集中的 $A$ 还是 $T$ 等位基因。\n\n#### 2. 非回文 SNP 的协调\n\n对于一个给定的 SNP，我们将结局数据与暴露数据对齐。设暴露 SNP 的等位基因为 $(a_{1,exp}, a_{2,exp})$，结局 SNP 的等位基因为 $(a_{1,out}, a_{2,out})$。目标是找到一个将 $(a_{1,out}, a_{2,out})$ 映射到 $(a_{1,exp}, a_{2,exp})$ 的变换，并对结局效应量 $\\beta_{out}$ 应用相应的更改。按特定顺序评估以下操作：\n\n1.  **相同匹配**：如果 $a_{1,out} = a_{1,exp}$ 且 $a_{2,out} = a_{2,exp}$。数据已对齐。协调后的结局效应为 $\\tilde{\\beta}_{out} = \\beta_{out}$。\n2.  **等位基因翻转**：如果 $a_{1,out} = a_{2,exp}$ 且 $a_{2,out} = a_{1,exp}$。结局研究选择了另一个等位基因作为效应等位基因。效应被反转：$\\tilde{\\beta}_{out} = -\\beta_{out}$。\n3.  **链互补**：如果 $c(a_{1,out}) = a_{1,exp}$ 且 $c(a_{2,out}) = a_{2,exp}$。结局数据报告的是相反链，但参考等位基因方向相同。仅链翻转不会改变效应量：$\\tilde{\\beta}_{out} = \\beta_{out}$。\n4.  **互补翻转**：如果 $c(a_{1,out}) = a_{2,exp}$ 且 $c(a_{2,out}) = a_{1,exp}$。结局数据位于相反链上，并使用了另一个等位基因作为效应等位基因。同时应用了链互补和等位基因翻转。效应被反转：$\\tilde{\\beta}_{out} = -\\beta_{out}$。\n\n如果这些条件都不满足，则等位基因不兼容（例如，暴露 $A/C$ vs. 结局 $A/G$），该 SNP 将从分析中排除。\n\n#### 3. 回文 SNP 的协调与排除\n\n由于其固有的链模糊性，回文 SNP 需要特殊处理程序。这种模糊性有时可以使用 EAF 数据来解决。只有通过三部分测试，回文 SNP 才会被保留：\n\n1.  **EAF 可用性**：暴露和结局数据集都必须提供该 SNP 的 EAF。设它们为 $f_{exp}$ 和 $f_{out}$。如果任何一个缺失，则无法解决模糊性，该 SNP 将被排除。这会增加计数 $n_{\\text{pal\\_excluded}}$。\n\n2.  **频率模糊性阈值**：EAF 必须与 $0.5$ 有足够大的差距才能提供信息。例如，如果 EAF 是 $0.5$，那么它的补数 $1-f$ 也是 $0.5$，无法提供消歧信息。这通过要求次要等位基因频率 (MAF) $\\min(f, 1-f)$ 低于某个阈值 $\\tau$ 来形式化。条件是 `maf_exp` 和 `maf_out` 都必须小于或等于指定的阈值 $\\tau = 0.42$。如果 `maf_exp` $> \\tau$ 或 `maf_out` $> \\tau$，则该 SNP 被排除并计入 $n_{\\text{pal\\_excluded}}$。\n\n3.  **基于 EAF 的消歧**：如果通过了上述检查，则使用 EAF 推断正确的方向。可能出现两种情况：\n    *   效应等位基因相同（正向对齐）。如果 $f_{out}$ 接近 $f_{exp}$，则很可能是这种情况。\n    *   结局中的效应等位基因对应于暴露中的非效应等位基因（反向对齐）。如果 $f_{out}$ 接近 $1-f_{exp}$（这等价于 $1-f_{out}$ 接近 $f_{exp}$），则很可能是这种情况。\n\n    我们使用容差 $\\epsilon = 0.05$ 将此形式化：\n    *   如果 $|\\,f_{out} - f_{exp}| \\le \\epsilon$，则 `forward_match` 为真。\n    *   如果 $|\\,(1-f_{out}) - f_{exp}| \\le \\epsilon$，则 `reverse_match` 为真。\n\n    如果这些条件中只有一个为真（`forward_match` XOR `reverse_match`），则方向是明确的。\n    *   如果 `forward_match` 为真，则不需要反转效应（$\\tilde{\\beta}_{out} = \\beta_{out}$）。\n    *   如果 `reverse_match` 为真，则需要反转效应（$\\tilde{\\beta}_{out} = -\\beta_{out}$）。\n\n    如果两个条件都为真或都为假，则 EAF 不足以解决模糊性。该 SNP 被排除并计入 $n_{\\text{pal\\_excluded}}$。\n\n#### 4. 最终计算\n\n在处理完给定暴露-结局对的所有 SNP 后，计算最终指标：\n1.  $n_{\\text{keep}}$：成功协调并保留的 SNP 总数。\n2.  $n_{\\text{pal\\_excluded}}$：被识别为回文并因模糊性而被排除的 SNP 总数。\n3.  校验和：所有保留 SNP 的暴露效应量与协调后结局效应量的乘积之和，即 $\\sum_i \\beta_{\\text{exp},i} \\cdot \\tilde{\\beta}_{\\text{out},i}$。该值报告为四舍五入到 $6$ 位小数。\n\n这个系统性流程确保只有高置信度、正确对齐的 SNP 用于下游的 MR 分析，从而防止因等位基因未对齐而可能产生的伪因果推断。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the Mendelian Randomization harmonization analysis on the test suite.\n    \"\"\"\n    \n    test_cases = [\n        # Test case 1\n        (\n            [\n                ['rs1', 'A', 'G', 0.2, 0.20],\n                ['rs2', 'C', 'T', -0.3, 0.35],\n                ['rs3', 'A', 'T', 0.1, 0.49],\n                ['rs4', 'C', 'G', 0.05, 0.10],\n                ['rs5', 'A', 'C', 0.4, 0.60]\n            ],\n            [\n                ['rs1', 'A', 'G', 0.1, 0.19],\n                ['rs2', 'T', 'C', 0.5, 0.65],\n                ['rs3', 'T', 'A', 0.2, 0.51],\n                ['rs4', 'G', 'C', -0.07, 0.90],\n                ['rs5', 'T', 'G', 0.3, 0.40]\n            ]\n        ),\n        # Test case 2\n        (\n            [\n                ['rs10', 'G', 'T', 0.2, 0.58],\n                ['rs11', 'A', 'T', -0.12, 0.20],\n                ['rs12', 'C', 'G', 0.05, None],\n                ['rs13', 'A', 'C', 0.3, 0.45],\n                ['rs14', 'A', 'G', -0.25, 0.33]\n            ],\n            [\n                ['rs10', 'C', 'A', 0.15, 0.42],\n                ['rs11', 'T', 'A', 0.3, 0.80],\n                ['rs12', 'G', 'C', 0.02, 0.90],\n                ['rs13', 'A', 'G', -0.2, 0.45],\n                ['rs14', 'C', 'T', 0.5, 0.67]\n            ]\n        ),\n        # Test case 3\n        (\n            [\n                ['rs20', 'A', 'T', 0.5, 0.42],\n                ['rs21', 'C', 'G', -0.2, 0.58],\n                ['rs22', 'A', 'C', 0.1, 0.30],\n                ['rs23', 'G', 'T', -0.05, 0.51],\n                ['rs24', 'T', 'A', 0.2, 0.50]\n            ],\n            [\n                ['rs20', 'T', 'A', -0.1, 0.58],\n                ['rs21', 'C', 'G', 0.4, 0.58],\n                ['rs22', 'T', 'G', 0.2, 0.70],\n                ['rs23', 'A', 'C', 0.06, 0.49],\n                ['rs24', 'A', 'T', 0.1, 0.50]\n            ]\n        )\n    ]\n\n    results = []\n    for exp_data, out_data in test_cases:\n        results.append(process_case(exp_data, out_data))\n\n    # Format the final output as a single-line string\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef process_case(exposure_data, outcome_data):\n    \"\"\"\n    Processes a single test case for SNP harmonization.\n    \n    Args:\n        exposure_data (list): List of exposure SNP records.\n        outcome_data (list): List of outcome SNP records.\n        \n    Returns:\n        list: A list containing [n_keep, n_pal_excluded, checksum].\n    \"\"\"\n    EPSILON = 0.05\n    TAU = 0.42\n    COMPLEMENT = {'A': 'T', 'T': 'A', 'C': 'G', 'G': 'C'}\n    \n    n_keep = 0\n    n_pal_excluded = 0\n    checksum = 0.0\n\n    # Create a dictionary for outcome data for efficient lookup\n    outcome_map = {\n        rec[0]: {'id': rec[0], 'a1': rec[1], 'a2': rec[2], 'beta': rec[3], 'eaf': rec[4]}\n        for rec in outcome_data\n    }\n\n    for rec in exposure_data:\n        exp_snp = {'id': rec[0], 'a1': rec[1], 'a2': rec[2], 'beta': rec[3], 'eaf': rec[4]}\n        out_snp = outcome_map.get(exp_snp['id'])\n\n        if not out_snp:\n            continue\n\n        a1e, a2e = exp_snp['a1'], exp_snp['a2']\n        a1o, a2o = out_snp['a1'], out_snp['a2']\n        b_e, b_o = exp_snp['beta'], out_snp['beta']\n        f_e, f_o = exp_snp['eaf'], out_snp['eaf']\n\n        # Determine if the exposure SNP is palindromic\n        is_pal = {a1e, a2e} in [{'A', 'T'}, {'C', 'G'}]\n\n        harmonized_beta_out = None\n        \n        if is_pal:\n            # Palindromic SNP handling\n            # 1. EAFs must be present\n            if f_e is None or f_o is None:\n                n_pal_excluded += 1\n                continue\n            \n            # 2. Minor Allele Frequencies must be = tau\n            maf_e = f_e if f_e = 0.5 else 1.0 - f_e\n            maf_o = f_o if f_o = 0.5 else 1.0 - f_o\n            if maf_e > TAU or maf_o > TAU:\n                n_pal_excluded += 1\n                continue\n\n            # 3. EAF-based disambiguation\n            forward_match = abs(f_o - f_e) = EPSILON\n            reverse_match = abs((1.0 - f_o) - f_e) = EPSILON\n\n            if forward_match and not reverse_match:\n                harmonized_beta_out = b_o\n            elif reverse_match and not forward_match:\n                harmonized_beta_out = -b_o\n            else: # Ambiguous (both true or both false)\n                n_pal_excluded += 1\n                continue\n        else:\n            # Non-palindromic SNP harmonization\n            c_a1o, c_a2o = COMPLEMENT[a1o], COMPLEMENT[a2o]\n            \n            if a1e == a1o and a2e == a2o: # Identity\n                harmonized_beta_out = b_o\n            elif a1e == a2o and a2e == a1o: # Reversal\n                harmonized_beta_out = -b_o\n            elif a1e == c_a1o and a2e == c_a2o: # Complement\n                harmonized_beta_out = b_o\n            elif a1e == c_a2o and a2e == c_a1o: # Complemented Reversal\n                harmonized_beta_out = -b_o\n            else: # Incompatible\n                continue\n        \n        # If harmonization was successful\n        if harmonized_beta_out is not None:\n            n_keep += 1\n            checksum += b_e * harmonized_beta_out\n            \n    return [n_keep, n_pal_excluded, round(checksum, 6)]\n\n# Run the solver\nsolve()\n```"
        },
        {
            "introduction": "孟德尔随机化的一项主要假设是无水平多效性，但这在实践中常常被违反。本练习  演示了如何通过比较标准的逆方差加权（IVW）估计值与加权中位数和加权众数等稳健估计量，来进行超越单一估计的分析。这种比较方法是一种强大的敏感性分析，用于诊断和减轻多效性异常值的影响，从而得出更可靠的因果结论。",
            "id": "4583451",
            "problem": "一个联合研究团队采用孟德尔随机化 (Mendelian randomization, MR) 方法，研究一种循环代谢物（以 $X$ 表示）对一种二元疾病结局（以 $Y$ 表示）的因果效应。七个独立的遗传变异（单核苷酸多态性，single-nucleotide polymorphisms, SNPs）被用作工具变量，其双样本汇总关联估计值来自全基因组关联研究 (genome-wide association studies, GWAS)。对于每个 SNP $i \\in \\{1,\\dots,7\\}$，给定其与暴露 $X$ 的关联估计值为 $\\beta_{X,i}$，与结局 $Y$ 的关联估计值为 $\\beta_{Y,i}$，以及结局关联的标准误为 $\\sigma_{Y,i}$。暴露关联估计值来自一个非常大的样本，因此对于 $\\beta_{X,i}$ 的无测量误差假设是合理的。\n\n数据：\n- SNP $1$：$\\beta_{X,1} = 0.10$，$\\beta_{Y,1} = 0.052$，$\\sigma_{Y,1} = 0.010$。\n- SNP $2$：$\\beta_{X,2} = 0.12$，$\\beta_{Y,2} = 0.060$，$\\sigma_{Y,2} = 0.012$。\n- SNP $3$：$\\beta_{X,3} = 0.08$，$\\beta_{Y,3} = 0.040$，$\\sigma_{Y,3} = 0.010$。\n- SNP $4$：$\\beta_{X,4} = 0.11$，$\\beta_{Y,4} = 0.0572$，$\\sigma_{Y,4} = 0.011$。\n- SNP $5$：$\\beta_{X,5} = 0.09$，$\\beta_{Y,5} = 0.045$，$\\sigma_{Y,5} = 0.009$。\n- SNP $6$：$\\beta_{X,6} = 0.10$，$\\beta_{Y,6} = 0.130$，$\\sigma_{Y,6} = 0.010$。\n- SNP $7$：$\\beta_{X,7} = 0.13$，$\\beta_{Y,7} = 0.065$，$\\sigma_{Y,7} = 0.013$。\n\n从工具变量和孟德尔随机化的基本原理出发：\n1. 在无水平多效性以及对 $\\beta_{X,i}$ 采用无测量误差假设的条件下，利用线性关联的工具变量比率逻辑，定义每个变异的 Wald 比率 $r_i$，并通过一阶 delta 方法推导其近似方差。利用此结果构建每个工具变量的反方差权重 $w_i$。\n2. 使用一个零截距（即将多效性截距约束为零）的固定效应反方差加权 (inverse-variance weighted, IVW) 模型，从集合 $\\{r_i, w_i\\}_{i=1}^{7}$ 中计算合并的因果效应估计值 $\\hat{\\theta}_{\\mathrm{IVW}}$。\n3. 计算加权中位数估计量 $\\hat{\\theta}_{\\mathrm{WM}}$，其为使用权重 $\\{w_i\\}$ 的 $\\{r_i\\}$ 的加权中位数。\n4. 计算零带宽限制下的加权众数估计量 $\\hat{\\theta}_{\\mathrm{WMode}}$，此处定义为使得具有完全相同 $r$ 值的工具变量的总权重最大化的 $r_i$ 值。如果存在平局，选择较小的值。\n\n在您的解题过程中，简要解释 $\\hat{\\theta}_{\\mathrm{IVW}}$、$\\hat{\\theta}_{\\mathrm{WM}}$ 和 $\\hat{\\theta}_{\\mathrm{WMode}}$ 之间的任何差异对工具变量有效性和水平多效性意味着什么。\n\n将您的三个数值估计值以 $[\\hat{\\theta}_{\\mathrm{IVW}}, \\hat{\\theta}_{\\mathrm{WM}}, \\hat{\\theta}_{\\mathrm{WMode}}]$ 的顺序在一个单行矩阵中报告，每个条目四舍五入到四位有效数字。最终答案以纯数字形式表示，不带单位。",
            "solution": "该问题经评估具有科学合理性、定义明确且客观。它展示了孟德尔随机化领域中的一套标准计算，使用了有效的假设和明确定义的估计量。所有必需的数据均已提供。我们开始进行解答。\n\n孟德尔随机化 (MR) 的核心原理是使用遗传变异作为工具变量 (IVs)，来推断暴露 ($X$) 对结局 ($Y$) 的因果效应。设 $\\theta$ 为真实的因果效应。在工具变量假设和线性关系的假定下，遗传工具 $i$ 与结局的真实关联 $\\Beta_{Y,i}$ 与其和暴露的关联 $\\Beta_{X,i}$ 成正比，即 $\\Beta_{Y,i} = \\theta \\Beta_{X,i}$。该等式成立的条件是工具变量对结局没有绕过暴露的直接影响，这一条件被称为无水平多效性。\n\n**1. Wald 比率、方差和反方差权重**\n\n对于单个工具变量 $i$，其与结局的估计关联 ($\\beta_{Y,i}$) 与其和暴露的估计关联 ($\\beta_{X,i}$) 的比值，提供了因果效应的一个估计值。这就是 Wald 比率，$r_i$。\n$$\nr_i = \\frac{\\beta_{Y,i}}{\\beta_{X,i}}\n$$\n为了确定该比率的方差 $\\operatorname{Var}(r_i)$，我们应用 delta 方法。然而，问题指定了对暴露关联 $\\beta_{X,i}$ 的“无测量误差”(no-measurement-error, NOME) 假设。这意味着 $\\operatorname{Var}(\\beta_{X,i}) \\approx 0$，并且 $\\beta_{X,i}$ 可被视为一个常数。在这个简化假设下，$r_i$ 的方差可以根据 $\\beta_{Y,i}$ 的方差，使用标准的方差传播规则推导得出：\n$$\n\\operatorname{Var}(r_i) = \\operatorname{Var}\\left(\\frac{\\beta_{Y,i}}{\\beta_{X,i}}\\right) = \\frac{1}{\\beta_{X,i}^2} \\operatorname{Var}(\\beta_{Y,i})\n$$\n我们已知结局关联的标准误 $\\sigma_{Y,i}$，其中 $\\operatorname{Var}(\\beta_{Y,i}) = \\sigma_{Y,i}^2$。因此，Wald 比率的方差为：\n$$\n\\operatorname{Var}(r_i) = \\frac{\\sigma_{Y,i}^2}{\\beta_{X,i}^2}\n$$\n每个工具变量比率估计值的反方差权重 $w_i$ 是其方差的倒数：\n$$\nw_i = \\frac{1}{\\operatorname{Var}(r_i)} = \\frac{\\beta_{X,i}^2}{\\sigma_{Y,i}^2}\n$$\n现在我们为 7 个 SNP 中的每一个计算 $r_i$ 和 $w_i$。\n\n- SNP $1$：$r_1 = \\frac{0.052}{0.10} = 0.52$。$w_1 = \\frac{0.10^2}{0.010^2} = \\frac{0.01}{0.0001} = 100$。\n- SNP $2$：$r_2 = \\frac{0.060}{0.12} = 0.50$。$w_2 = \\frac{0.12^2}{0.012^2} = \\frac{0.0144}{0.000144} = 100$。\n- SNP $3$：$r_3 = \\frac{0.040}{0.08} = 0.50$。$w_3 = \\frac{0.08^2}{0.010^2} = \\frac{0.0064}{0.0001} = 64$。\n- SNP $4$：$r_4 = \\frac{0.0572}{0.11} = 0.52$。$w_4 = \\frac{0.11^2}{0.011^2} = \\frac{0.0121}{0.000121} = 100$。\n- SNP $5$：$r_5 = \\frac{0.045}{0.09} = 0.50$。$w_5 = \\frac{0.09^2}{0.009^2} = \\frac{0.0081}{0.000081} = 100$。\n- SNP $6$：$r_6 = \\frac{0.130}{0.10} = 1.30$。$w_6 = \\frac{0.10^2}{0.010^2} = \\frac{0.01}{0.0001} = 100$。\n- SNP $7$：$r_7 = \\frac{0.065}{0.13} = 0.50$。$w_7 = \\frac{0.13^2}{0.013^2} = \\frac{0.0169}{0.000169} = 100$。\n\n**2. 反方差加权 (IVW) 估计量**\n\n固定效应 IVW 估计量通过计算各个 Wald 比率的加权平均值来合并它们，其中权重是反方差 $w_i$。如果所有工具变量都有效（即不存在水平多效性），该方法能提供最精确的估计。\n$$\n\\hat{\\theta}_{\\mathrm{IVW}} = \\frac{\\sum_{i=1}^{7} w_i r_i}{\\sum_{i=1}^{7} w_i}\n$$\n权重的总和是：\n$$\n\\sum_{i=1}^{7} w_i = 100 + 100 + 64 + 100 + 100 + 100 + 100 = 664\n$$\n比率的加权和是：\n$$\n\\sum_{i=1}^{7} w_i r_i = (100 \\times 0.52) + (100 \\times 0.50) + (64 \\times 0.50) + (100 \\times 0.52) + (100 \\times 0.50) + (100 \\times 1.30) + (100 \\times 0.50)\n$$\n$$\n= 52 + 50 + 32 + 52 + 50 + 130 + 50 = 416\n$$\n因此，IVW 估计值为：\n$$\n\\hat{\\theta}_{\\mathrm{IVW}} = \\frac{416}{664} \\approx 0.626506...\n$$\n四舍五入到四位有效数字，$\\hat{\\theta}_{\\mathrm{IVW}} = 0.6265$。\n\n**3. 加权中位数 (WM) 估计量**\n\n如果分析中至少 50% 的权重来自有效的工具变量，加权中位数估计量就能提供一个一致的因果估计。它对多效性异常值具有稳健性。为找到加权中位数，我们首先对各个比率估计值 $r_i$ 进行排序，然后找到权重的累积和达到总权重 50% 时的对应值。\n\n排序后的 $(r_i, w_i)$ 对为：\n$(0.50, 100)$、$(0.50, 64)$、$(0.50, 100)$、$(0.50, 100)$、$(0.52, 100)$、$(0.52, 100)$、$(1.30, 100)$。\n总权重为 $\\sum w_i = 664$。中点是 $\\frac{664}{2} = 332$。\n我们计算排序后比率的累积权重和：\n- 对于 $r_i = 0.50$：累积权重为 $100 + 64 + 100 + 100 = 364$。\n由于这个累积权重 (364) 是第一个超过中点 (332) 的，因此加权中位数是相应的比率值。\n$$\n\\hat{\\theta}_{\\mathrm{WM}} = 0.50\n$$\n报告到四位有效数字，$\\hat{\\theta}_{\\mathrm{WM}} = 0.5000$。\n\n**4. 加权众数 (WMode) 估计量**\n\n加权众数估计量基于这样一个原理：一个有效的因果估计应该得到多数工具变量的支持。问题定义了一个简化的“零带宽”版本：与权重总和最大的那组工具变量相对应的 $r_i$ 值。我们根据工具变量精确的 $r_i$ 值对其进行分组，并计算每组内的权重总和。\n\n- 组 $r=0.50$：SNPs $\\{2, 3, 5, 7\\}$。总权重 = $w_2 + w_3 + w_5 + w_7 = 100 + 64 + 100 + 100 = 364$。\n- 组 $r=0.52$：SNPs $\\{1, 4\\}$。总权重 = $w_1 + w_4 = 100 + 100 = 200$。\n- 组 $r=1.30$：SNP $\\{6\\}$。总权重 = $w_6 = 100$。\n\n最大的聚合权重是 $364$，对应于比率值 $r=0.50$。\n$$\n\\hat{\\theta}_{\\mathrm{WMode}} = 0.50\n$$\n报告到四位有效数字，$\\hat{\\theta}_{\\mathrm{WMode}} = 0.5000$。\n\n**差异解读**\n\n三个估计值分别为 $\\hat{\\theta}_{\\mathrm{IVW}} = 0.6265$、$\\hat{\\theta}_{\\mathrm{WM}} = 0.5000$ 和 $\\hat{\\theta}_{\\mathrm{WMode}} = 0.5000$。IVW 估计值与稳健的中位数和众数估计值之间的显著差异，强烈表明 MR 假设被违反，特别是存在定向水平多效性。IVW 估计量假设所有工具变量都有效，因此对异常值很敏感。SNP 6 的比率 ($r_6 = 1.30$) 与其他聚集在 0.50 附近的比率相比，是一个显著的异常值。由于 IVW 是一个加权平均值，这个具有较大权重 ($w_6=100$) 的多效性异常值会使估计值向上偏倚。相比之下，加权中位数和加权众数估计量对此类异常值具有稳健性。它们都提供了 0.5000 的估计值，这表明占总权重超过 50% 的最大工具变量集群一致地指向一个如此大小的因果效应。中位数和众数估计量之间的一致性，强化了这样一个结论：真实的因果效应可能接近 0.50，而 IVW 估计值因至少一个工具变量 (SNP 6) 的多效性而存在偏倚。\n\n最终数值结果（4 位有效数字）：\n- $\\hat{\\theta}_{\\mathrm{IVW}} \\approx 0.6265$\n- $\\hat{\\theta}_{\\mathrm{WM}} = 0.5000$\n- $\\hat{\\theta}_{\\mathrm{WMode}} = 0.5000$",
            "answer": "$$\\boxed{\\begin{pmatrix} 0.6265  0.5000  0.5000 \\end{pmatrix}}$$"
        }
    ]
}