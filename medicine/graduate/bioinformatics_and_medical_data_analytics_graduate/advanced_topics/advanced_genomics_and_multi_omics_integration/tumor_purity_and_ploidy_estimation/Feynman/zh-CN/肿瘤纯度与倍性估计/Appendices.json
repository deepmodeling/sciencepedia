{
    "hands_on_practices": [
        {
            "introduction": "本练习将核心概念（如倍性和拷贝数）与实际计算联系起来。您将从已知的基因组分段和绝对拷贝数出发，计算肿瘤的平均倍性（$\\pi$），这是衡量基因组整体稳定性的关键指标。此外，该问题引入了进化简约性原则，引导您思考如何通过比较包含或不包含全基因组加倍（WGD）的演化路径，来推断最可能导致观察到的复杂癌基因组的事件序列。",
            "id": "4616048",
            "problem": "一个癌症基因组在其常染色体基因组上被分成了 $n$ 个分段常数的拷贝数状态，每个片段 $i$ 的碱基长度为 $\\ell_i$ (单位：百万碱基)，肿瘤绝对拷贝数为 $C_i$。假设肿瘤绝对拷贝数已经通过与配对的正常样本进行校准，因此 $C_i$ 是肿瘤克隆的整数总数，不受正常细胞污染的影响。考虑一个简化的常染色体基因组，其总长度为 $L$，被划分为 $n = 6$ 个片段，长度分别为 $\\ell_1 = 600$, $\\ell_2 = 450$, $\\ell_3 = 550$, $\\ell_4 = 300$, $\\ell_5 = 800$, and $\\ell_6 = 300$，因此 $L = \\sum_{i=1}^{6} \\ell_i = 3{,}000$。相应的肿瘤绝对拷贝数是 $C_1 = 4$, $C_2 = 5$, $C_3 = 4$, $C_4 = 3$, $C_5 = 4$, and $C_6 = 2$。\n\n从肿瘤倍性是全基因组范围内每个碱基的平均绝对拷贝数这一定义出发，并考虑到分段意味着拷贝数函数在基因组位置上是分段常数的，请推导该肿瘤平均倍性 $\\pi$ 关于 $\\{\\ell_i\\}$ 和 $\\{C_i\\}$ 的表达式，并计算其值。\n\n然后，使用拷贝数演化的整数简约性原则，将每个常染色体片段有 $2$ 个拷贝的二倍体基线作为祖先状态。一个片段增益或缺失事件会使单个片段的拷贝数改变 $1$，记为一次事件；一次全基因组加倍 (WGD) 事件会同时使每个常染色体片段的拷贝数加倍，记为一次事件。计算在两种情况下，从二倍体基线产生观测到的 $\\{C_i\\}$ 所需的最小总事件数：(i) 不允许 WGD，以及 (ii) 允许一次 WGD，且片段事件在 WGD 前后被优化安排以最小化总事件数。将这两个最小总数中较小的一个报告为 $E^{\\star}$。\n\n以包含 $\\pi$ 和 $E^{\\star}$ 的行矩阵形式提供最终答案。无需四舍五入。",
            "solution": "用户要求我解决一个癌症基因组学问题，涉及计算肿瘤倍性和解释观测到的拷贝数谱所需的最小演化事件数（拷贝数变化和全基因组加倍）。\n\n首先，我将验证问题陈述。\n\n### 步骤1：提取已知条件\n- 片段数量：$n = 6$。\n- 片段长度：$\\{\\ell_i\\} = \\{600, 450, 550, 300, 800, 300\\}$，单位为百万碱基。\n- 常染色体基因组总长度：$L = \\sum_{i=1}^{6} \\ell_i = 3000$ 百万碱基。\n- 每个片段的肿瘤绝对拷贝数：$\\{C_i\\} = \\{4, 5, 4, 3, 4, 2\\}$。\n- 肿瘤倍性 ($\\pi$) 的定义：全基因组范围内每个碱基的平均绝对拷贝数。\n- 祖先状态：二倍体，所有片段的拷贝数为 $2$。\n- 片段事件：单个片段的拷贝数变化 $\\pm 1$；计为 $1$ 次事件。\n- 全基因组加倍 (WGD) 事件：所有片段的拷贝数同时加倍；计为 $1$ 次事件。\n- 任务1：推导 $\\pi$ 的表达式并计算其值。\n- 任务2：计算从二倍体基线产生 $\\{C_i\\}$ 所需的最小总事件数 $E^{\\star}$，考虑两种情况：(i) 无 WGD 和 (ii) 一次 WGD。$E^{\\star}$ 是这两种情况下事件数的最小值。\n\n### 步骤2：使用提取的已知条件进行验证\n该问题在科学上植根于癌症基因组学领域，使用了拷贝数变异、倍性和全基因组加倍等标准概念。问题提法清晰，提供了所有必要的数据和明确的定义。所提供的数据是自洽的（例如 $\\sum \\ell_i = L$）。问题是客观且可形式化的。没有可识别的缺陷，如科学上的不健全、不完整或模糊不清。\n\n### 步骤3：结论与行动\n问题有效。我将继续进行解答。\n\n### 第1部分：肿瘤倍性 ($\\pi$) 的推导与计算\n问题将肿瘤倍性 $\\pi$ 定义为全基因组范围内每个碱基的平均绝对拷贝数。基因组被划分为 $n$ 个片段，其中片段 $i$ 的长度为 $\\ell_i$，具有恒定的绝对拷贝数 $C_i$。\n\n单个片段 $i$ 内的DNA总拷贝数与其长度 $\\ell_i$ 和拷贝数 $C_i$ 成正比。为了计算整个基因组的平均拷贝数，我们必须计算拷贝数 $\\{C_i\\}$ 的加权平均值，其中权重是片段的长度分数。\n\n基因组的总“拷贝数加权”长度是每个片段的拷贝数与其长度乘积的总和：\n$$\n\\text{Total copy-weighted length} = \\sum_{i=1}^{n} C_i \\ell_i\n$$\n基因组的总长度是 $L = \\sum_{i=1}^{n} \\ell_i$。\n\n平均倍性 $\\pi$ 是总拷贝数加权长度与总长度的比率。因此，$\\pi$ 的表达式为：\n$$\n\\pi = \\frac{\\sum_{i=1}^{n} C_i \\ell_i}{\\sum_{i=1}^{n} \\ell_i} = \\frac{1}{L} \\sum_{i=1}^{n} C_i \\ell_i\n$$\n现在，我们代入给定的值：\n$L = 3000$\n$\\{\\ell_i\\} = \\{600, 450, 550, 300, 800, 300\\}$\n$\\{C_i\\} = \\{4, 5, 4, 3, 4, 2\\}$\n\n分子中的和为：\n$$\n\\sum_{i=1}^{6} C_i \\ell_i = (4)(600) + (5)(450) + (4)(550) + (3)(300) + (4)(800) + (2)(300)\n$$\n$$\n\\sum_{i=1}^{6} C_i \\ell_i = 2400 + 2250 + 2200 + 900 + 3200 + 600 = 11550\n$$\n现在，我们可以计算 $\\pi$：\n$$\n\\pi = \\frac{11550}{3000} = \\frac{11.55}{3} = 3.85\n$$\n\n### 第2部分：最小演化事件数 ($E^{\\star}$) 的计算\n我们需要找到将祖先二倍体状态 $C_{\\text{initial}} = \\{2, 2, 2, 2, 2, 2\\}$ 转变为观测到的最终状态 $C_{\\text{final}} = \\{4, 5, 4, 3, 4, 2\\}$ 所需的最小事件数。我们考虑两种情况。\n\n#### 情况 (i)：不允许 WGD\n在这种情况下，只允许片段增益和缺失事件。将单个片段 $i$ 的拷贝数从 $2$ 变为 $C_i$ 所需的事件数就是绝对差 $|C_i - 2|$。总事件数 $E_{\\text{no-WGD}}$ 是所有片段上这些差值的总和：\n$$\nE_{\\text{no-WGD}} = \\sum_{i=1}^{n} |C_i - 2|\n$$\n代入 $C_{\\text{final}}$ 的值：\n$$\nE_{\\text{no-WGD}} = |4 - 2| + |5 - 2| + |4 - 2| + |3 - 2| + |4 - 2| + |2 - 2|\n$$\n$$\nE_{\\text{no-WGD}} = 2 + 3 + 2 + 1 + 2 + 0 = 10\n$$\n没有 WGD 的情况下，最小事件数为 $10$。\n\n#### 情况 (ii)：允许一次 WGD\n在这种情况下，演化路径涉及一个中间的 WGD 前状态 $C_{\\text{pre-WGD}} = \\{c'_1, c'_2, \\ldots, c'_n\\}$，该状态是通过片段事件从初始二倍体状态达到的。随后发生一次 WGD 事件，然后再通过进一步的片段事件达到最终状态 $C_{\\text{final}}$。总事件数是 WGD 前片段事件数、单次 WGD 事件和 WGD 后片段事件数的总和。\n\n对于每个片段 $i$，我们希望找到一个整数的 WGD 前拷贝数 $c'_i$ 来最小化片段事件的数量。对于给定的 $C_{\\text{pre-WGD}}$，总事件数为：\n$$\nE_{\\text{WGD}}(C_{\\text{pre-WGD}}) = \\sum_{i=1}^{n} |c'_i - 2| + 1 + \\sum_{i=1}^{n} |C_i - 2c'_i|\n$$\n为了找到全局最小值，我们可以独立地最小化每个片段的事件数。对于每个片段 $i$，我们必须找到整数 $c'_i \\geq 0$ 来最小化片段事件数 $e_i(c'_i) = |c'_i - 2| + |C_i - 2c'_i|$。此情况下的最小总事件数将是 $E_{\\text{WGD}} = 1 + \\sum_{i=1}^{n} \\min_{c'_i} e_i(c'_i)$。\n\n让我们为每个片段计算这个值：\n- **片段 1 ($C_1 = 4$):** 最小化 $e_1(c'_1) = |c'_1 - 2| + |4 - 2c'_1|$。\n  - 如果 $c'_1 = 2$：$e_1(2) = |2-2| + |4 - 2(2)| = 0 + 0 = 0$。这是可能的最小值。\n- **片段 2 ($C_2 = 5$):** 最小化 $e_2(c'_2) = |c'_2 - 2| + |5 - 2c'_2|$。\n  - 如果 $c'_2 = 2$：$e_2(2) = |2-2| + |5 - 2(2)| = 0 + 1 = 1$。\n  - 如果 $c'_2 = 3$：$e_2(3) = |3-2| + |5 - 2(3)| = 1 + 1 = 2$。\n  - 最小值为 $1$，当 $c'_2 = 2$ 时。\n- **片段 3 ($C_3 = 4$):** 与片段1相同。最小值为 $0$，当 $c'_3 = 2$ 时。\n- **片段 4 ($C_4 = 3$):** 最小化 $e_4(c'_4) = |c'_4 - 2| + |3 - 2c'_4|$。\n  - 如果 $c'_4 = 1$：$e_4(1) = |1-2| + |3 - 2(1)| = 1 + 1 = 2$。\n  - 如果 $c'_4 = 2$：$e_4(2) = |2-2| + |3 - 2(2)| = 0 + 1 = 1$。\n  - 最小值为 $1$，当 $c'_4 = 2$ 时。\n- **片段 5 ($C_5 = 4$):** 与片段1相同。最小值为 $0$，当 $c'_5 = 2$ 时。\n- **片段 6 ($C_6 = 2$):** 最小化 $e_6(c'_6) = |c'_6 - 2| + |2 - 2c'_6|$。\n  - 如果 $c'_6 = 1$：$e_6(1) = |1-2| + |2 - 2(1)| = 1 + 0 = 1$。\n  - 如果 $c'_6 = 2$：$e_6(2) = |2-2| + |2 - 2(2)| = 0 + 2 = 2$。\n  - 最小值为 $1$，当 $c'_6 = 1$ 时。\n\n最优的 WGD 前状态是 $C_{\\text{pre-WGD}} = \\{2, 2, 2, 2, 2, 1\\}$。\n片段事件的总数是每个片段的最小值之和：\n$$\n\\sum_{i=1}^{6} \\min_{c'_i} e_i(c'_i) = 0 + 1 + 0 + 1 + 0 + 1 = 3\n$$\nWGD 情况下的总事件数是 WGD 事件的成本 ($1$) 加上总片段事件数 ($3$)：\n$$\nE_{\\text{WGD}} = 1 + 3 = 4\n$$\n\n#### 比较与最终最小事件数 ($E^{\\star}$)\n我们比较两种情况下的最小事件数：\n- 情况 (i) 无 WGD：$E_{\\text{no-WGD}} = 10$。\n- 情况 (ii) 有一次 WGD：$E_{\\text{WGD}} = 4$。\n\n最小总事件数 $E^{\\star}$ 是这两个值中较小的一个：\n$$\nE^{\\star} = \\min(E_{\\text{no-WGD}}, E_{\\text{WGD}}) = \\min(10, 4) = 4\n$$\n\n### 最终答案\n计算出的平均倍性是 $\\pi = 3.85$。最小总事件数是 $E^{\\star} = 4$。问题要求以包含 $\\pi$ 和 $E^{\\star}$ 的行矩阵形式提供最终答案。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 3.85  4 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "在掌握了基本定义之后，我们转向如何从测序数据中直接可观测的量——变异等位基因频率（VAF）——来推断潜在的生物学状态。本练习将引导您推导期望的VAF（$q$）与肿瘤纯度（$p$）、拷贝数（$C$）和突变状态之间的数学关系。您将应用二项分布模型，通过计算似然比来比较两种不同的生物学假说，从而为观察到的VAF数据峰值找到更合理的解释，这是癌症基因组学中解释VAF谱的核心技能。",
            "id": "4616113",
            "problem": "一个肿瘤样本是癌细胞和正常细胞的混合物。肿瘤细胞组分（纯度）用 $p$ 表示。在某个特定位点，肿瘤细胞的总拷贝数为 $C$，体细胞突变影响了携带该突变的那部分肿瘤细胞（占比为 $f$）中的 $m$ 个拷贝。正常细胞在该位点的总拷贝数为 2，且不携带该突变。变异等位基因频率（Variant Allele Fraction, VAF）定义为支持突变（替代）等位基因的测序读段所占的比例。在等位基因无偏采样的情况下，读段水平的替代等位基因概率等于整个混合物中所有等位基因拷贝中替代等位基因拷贝所占的比例。测序采样噪声可以通过二项分布来建模，其中总深度为 $n$ 时替代读段数为 $k$，其成功概率等于预期的替代等位基因概率。\n\n一项外显子组实验显示，在 VAF 分布中，0.66 附近有一个显著的峰。为了评估这个峰是由参数为 $(p,f,m,C)=(0.7,1,2,3)$ 的 Model $A$ 更好地解释，还是由参数为 $(p,f,m,C)=(0.5,1,2,2)$ 的 Model $B$ 更好地解释，我们考虑来自该峰的一个代表性位点，其总读段深度为 $n=200$，观察到的替代读段数为 $k=132$。仅使用上述基本定义和二项采样模型：\n\n1. 通过计算肿瘤和正常细胞混合物中替代等位基因拷贝数和总等位基因拷贝数，推导出预期替代等位基因概率 $q$ 作为 $(p,f,m,C)$ 的函数。\n2. 计算 Model $A$ 和 Model $B$ 下的预期 VAF。\n3. 使用参数为 $q$ 的二项模型，计算在每个模型下，从 $n=200$ 个总读段中观察到 $k=132$ 个替代读段的自然对数似然 $\\ln \\mathcal{L}$，然后计算自然对数似然比 $\\mathrm{LLR}=\\ln \\mathcal{L}(\\text{Model }A)-\\ln \\mathcal{L}(\\text{Model }B)$。\n\n将您计算的对数似然比的最终数值答案四舍五入到四位有效数字。最终答案以纯数字形式表示，不带任何单位。",
            "solution": "该问题被评估为具有科学依据、问题明确、客观且自洽。所提供的参数和模型是癌症基因组学领域的标准模型，所要求的计算可以直接从问题陈述中推导出来。因此，该问题被认为是有效的，下面提供了解决方案。\n\n根据问题陈述的要求，解决方案分三部分呈现。\n\n**第 1 部分：预期替代等位基因概率 $q$ 的推导**\n\n预期的替代等位基因概率，记作 $q$，是样本中整个细胞群体中替代（突变）等位基因拷贝总数与所有等位基因拷贝总数的比率。样本是正常细胞和肿瘤细胞的混合物。\n\n设 $p$ 为肿瘤细胞的比例（纯度），$1-p$ 为正常细胞的比例。\n让我们计算组织代表性部分中每种细胞类型贡献的等位基因数量。\n\n- **正常细胞：**\n  - 占细胞总数的比例为 $1-p$。\n  - 每个正常细胞在该位点的拷贝数为 $2$。\n  - 正常细胞不携带体细胞突变，因此它们有 $0$ 个替代等位基因拷贝。\n  - 正常细胞部分贡献的总等位基因数量与 $(1-p) \\times 2$ 成正比。\n\n- **肿瘤细胞：**\n  - 占细胞总数的比例为 $p$。\n  - 这些肿瘤细胞中，一部分比例为 $f$ 的细胞携带突变，而比例为 $1-f$ 的细胞不携带。\n  - 所有肿瘤细胞，无论突变状态如何，在该位点的总拷贝数均为 $C$。\n  - 对于比例为 $p \\times f$ 的携带突变的肿瘤细胞，每个细胞有 $m$ 个替代等位基因拷贝。\n  - 对于比例为 $p \\times (1-f)$ 的不携带突变的肿瘤细胞，每个细胞有 $0$ 个替代等位基因拷贝。\n\n现在，我们通过对每个亚群的贡献按其各自的比例加权求和，来计算替代等位基因拷贝的总数和所有等位基因拷贝的总数。\n\n替代等位基因拷贝总数 $N_{\\text{alt}}$ 与以下成正比：\n$$N_{\\text{alt}} = \\underbrace{(1-p) \\times 0}_{\\text{正常细胞}} + \\underbrace{(p \\times f) \\times m}_{\\text{突变肿瘤细胞}} + \\underbrace{p \\times (1-f) \\times 0}_{\\text{非突变肿瘤细胞}} = pfm$$\n\n所有等位基因拷贝总数 $N_{\\text{total}}$ 与以下成正比：\n$$N_{\\text{total}} = \\underbrace{(1-p) \\times 2}_{\\text{正常细胞}} + \\underbrace{p \\times C}_{\\text{所有肿瘤细胞}} = 2(1-p) + pC$$\n\n预期的替代等位基因概率 $q$ 是这两个量的比值：\n$$q(p, f, m, C) = \\frac{N_{\\text{alt}}}{N_{\\text{total}}} = \\frac{pfm}{2(1-p) + pC}$$\n\n这就是推导出的预期 VAF 的通用公式。\n\n**第 2 部分：计算 Model A 和 Model B 的预期 VAF**\n\n我们给出了两个模型的参数。\n\n- **Model A:** $(p_A, f_A, m_A, C_A) = (0.7, 1, 2, 3)$。\n  预期的 VAF，$q_A$，是：\n  $$q_A = \\frac{0.7 \\times 1 \\times 2}{2(1 - 0.7) + 0.7 \\times 3} = \\frac{1.4}{2(0.3) + 2.1} = \\frac{1.4}{0.6 + 2.1} = \\frac{1.4}{2.7} = \\frac{14}{27}$$\n  以小数表示，$q_A \\approx 0.5185$。\n\n- **Model B:** $(p_B, f_B, m_B, C_B) = (0.5, 1, 2, 2)$。\n  预期的 VAF，$q_B$，是：\n  $$q_B = \\frac{0.5 \\times 1 \\times 2}{2(1 - 0.5) + 0.5 \\times 2} = \\frac{1}{2(0.5) + 1} = \\frac{1}{1 + 1} = \\frac{1}{2}$$\n  以小数表示，$q_B = 0.5$。\n\n**第 3 部分：对数似然比（LLR）的计算**\n\n在总读段深度为 $n$ 的情况下，替代读段的数量 $k$ 可由成功概率为 $q$ 的二项分布建模：$k \\sim \\text{Binomial}(n, q)$。其概率质量函数为 $P(k|n,q) = \\binom{n}{k} q^k (1-q)^{n-k}$。\n\n似然函数 $\\mathcal{L}$ 等于这个概率。自然对数似然 $\\ln \\mathcal{L}$ 为：\n$$\\ln \\mathcal{L}(q | k, n) = \\ln \\left( \\binom{n}{k} q^k (1-q)^{n-k} \\right) = \\ln\\binom{n}{k} + k\\ln(q) + (n-k)\\ln(1-q)$$\n\n我们得到的观测数据是：$n=200$ 和 $k=132$。因此，$n-k = 200 - 132 = 68$。\n\n对于 Model A，其 $q_A = 14/27$：\n$$\\ln \\mathcal{L}_A = \\ln\\binom{200}{132} + 132\\ln\\left(\\frac{14}{27}\\right) + 68\\ln\\left(1-\\frac{14}{27}\\right)$$\n$$\\ln \\mathcal{L}_A = \\ln\\binom{200}{132} + 132\\ln\\left(\\frac{14}{27}\\right) + 68\\ln\\left(\\frac{13}{27}\\right)$$\n\n对于 Model B，其 $q_B = 1/2$：\n$$\\ln \\mathcal{L}_B = \\ln\\binom{200}{132} + 132\\ln\\left(\\frac{1}{2}\\right) + 68\\ln\\left(\\frac{1}{2}\\right)$$\n$$\\ln \\mathcal{L}_B = \\ln\\binom{200}{132} + (132+68)\\ln\\left(\\frac{1}{2}\\right) = \\ln\\binom{200}{132} + 200\\ln\\left(\\frac{1}{2}\\right)$$\n\n自然对数似然比是 $\\mathrm{LLR} = \\ln \\mathcal{L}_A - \\ln \\mathcal{L}_B$。\n$$\\mathrm{LLR} = \\left( \\ln\\binom{200}{132} + 132\\ln\\left(\\frac{14}{27}\\right) + 68\\ln\\left(\\frac{13}{27}\\right) \\right) - \\left( \\ln\\binom{200}{132} + 200\\ln\\left(\\frac{1}{2}\\right) \\right)$$\n二项式系数项被消掉了：\n$$\\mathrm{LLR} = 132\\ln\\left(\\frac{14}{27}\\right) + 68\\ln\\left(\\frac{13}{27}\\right) - 200\\ln\\left(\\frac{1}{2}\\right)$$\n$$\\mathrm{LLR} = 132\\ln\\left(\\frac{14}{27}\\right) + 68\\ln\\left(\\frac{13}{27}\\right) + 200\\ln(2)$$\n我们可以重新组合这些项以简化计算：\n$$\\mathrm{LLR} = 132\\left(\\ln\\left(\\frac{14}{27}\\right) + \\ln(2)\\right) + 68\\left(\\ln\\left(\\frac{13}{27}\\right) + \\ln(2)\\right)$$\n$$\\mathrm{LLR} = 132\\ln\\left(\\frac{14 \\times 2}{27}\\right) + 68\\ln\\left(\\frac{13 \\times 2}{27}\\right)$$\n$$\\mathrm{LLR} = 132\\ln\\left(\\frac{28}{27}\\right) + 68\\ln\\left(\\frac{26}{27}\\right)$$\n现在，我们计算数值：\n$$\\ln\\left(\\frac{28}{27}\\right) \\approx \\ln(1.037037) \\approx 0.0363678$$\n$$\\ln\\left(\\frac{26}{27}\\right) \\approx \\ln(0.962963) \\approx -0.0377396$$\n$$\\mathrm{LLR} \\approx 132 \\times (0.0363678) + 68 \\times (-0.0377396)$$\n$$\\mathrm{LLR} \\approx 4.80055 - 2.56629 \\approx 2.23426$$\n四舍五入到四位有效数字，对数似然比是 $2.234$。\n正值表明，与 Model B 相比，观测数据在 Model A 下出现的可能性更大。",
            "answer": "$$\\boxed{2.234}$$"
        },
        {
            "introduction": "最后，我们将前述概念整合到一个更全面、更先进的统计模型中。本练习介绍了一种隐马尔可夫模型（HMM），这是现代生物信息学工具中用于联合分析拷贝数、等位基因不平衡和肿瘤纯度的核心算法框架。您的任务是推导期望最大化（EM）算法中的一个关键更新步骤，以估计肿瘤纯度（$p$），这将帮助您理解算法如何从归一化覆盖深度和B等位基因频率（B-allele frequency）等多个数据流中稳健地估计模型参数。",
            "id": "4616142",
            "problem": "考虑一个用于沿染色体进行等位基因特异性拷贝数分割的隐马尔可夫模型 (HMM; Hidden Markov Model)，其基因组区间由 $i \\in \\{1,\\dots,n\\}$ 索引。在区间 $i$ 的潜在状态是一个非负整数的有序对 $(a,b)$，表示在该位点上肿瘤中主等位基因 $A$ 和次等位基因 $B$ 的等位基因特异性拷贝数。状态空间是有限的，例如，对于一个固定的最大总拷贝数 $C_{\\max}$，状态空间为 $S=\\{(a,b) \\in \\mathbb{Z}_{\\ge 0}^{2} : a+b \\le C_{\\max}\\}$。设转移模型倾向于状态持续，并根据以下公式惩罚总拷贝数和等位基因配置的变化：\n$$\n\\Pr\\big((a',b') \\mid (a,b)\\big) \\propto \\exp\\big(-\\lambda_{C} \\, |(a'+b') - (a+b)| - \\lambda_{A} \\, |a'-a| - \\lambda_{B} \\, |b'-b|\\big),\n$$\n其中 $\\lambda_{C}  0$、$\\lambda_{A}  0$ 和 $\\lambda_{B}  0$ 是控制转移惩罚的固定超参数。\n\n在每个区间 $i$，有两个观测值：归一化覆盖度 $L_{i}$（也称为读取深度比）和B等位基因频率 $\\mathrm{BAF}_{i}$（B-allele frequency）。假设在给定潜在状态 $(a,b)$ 和肿瘤纯度 $p \\in [0,1]$ 的条件下，$L_{i}$ 和 $\\mathrm{BAF}_{i}$ 是条件独立的，其中 $p$ 是样本中肿瘤细胞的比例。发射模型规定如下：\n- 对于归一化覆盖度，观测值 $L_{i}$ 服从高斯分布，其均值等于肿瘤纯度为 $p$ 时的期望混合拷贝数，方差为 $\\sigma_{L}^{2}$，\n$$\nL_{i} \\mid (a,b),p \\sim \\mathcal{N}\\big(\\mu_{L}(a,b,p), \\sigma_{L}^{2}\\big), \\quad \\text{其中} \\quad \\mu_{L}(a,b,p) = 2 + p\\big((a+b)-2\\big).\n$$\n此处，常数 $2$ 代表二倍体正常拷贝数，线性混合反映了肿瘤-正常混合样本中的期望总拷贝数。\n- 对于B等位基因频率，假设该位点在正常细胞群中是胚系杂合的，并令 $(a,b)$ 分别表示与等位基因 $(A,B)$ 对齐的等位基因特异性肿瘤计数。观测值 $\\mathrm{BAF}_{i}$ 服从高斯分布，其均值等于期望的混合次等位基因分数，方差为 $\\sigma_{B}^{2}$，\n$$\n\\mathrm{BAF}_{i} \\mid (a,b),p \\sim \\mathcal{N}\\big(\\mu_{B}(a,b,p), \\sigma_{B}^{2}\\big), \\quad \\text{其中} \\quad \\mu_{B}(a,b,p) = \\frac{p \\, b + (1-p)\\cdot 1}{p \\, (a+b) + (1-p)\\cdot 2}.\n$$\n\n假设 $\\sigma_{L}^{2}$ 和 $\\sigma_{B}^{2}$ 是已知常数。令 $\\gamma_{i}(a,b)$ 表示在区间 $i$ 处潜在状态 $(a,b)$ 的后验责任，它是通过在期望最大化 (EM; Expectation-Maximization) 框架中使用前向-后向算法，并结合上述的发射值 $L_{i}$ 和 $\\mathrm{BAF}_{i}$ 及转移模型得到的。\n\n从完整数据对数似然和所述的独立性假设出发，推导肿瘤纯度 $p$ 的闭式M步更新，该更新旨在最大化归一化覆盖度发射值 $\\{L_{i}\\}_{i=1}^{n}$ 对期望完整数据对数似然的贡献，并将责任 $\\{\\gamma_{i}(a,b)\\}$ 视为固定权重。您的最终表达式必须是闭式解，用 $\\{L_{i}\\}$、$\\{\\gamma_{i}(a,b)\\}$ 和等位基因特异性拷贝数 $\\{(a,b)\\}$ 表示，并且除了 $p$ 本身之外，不应依赖于任何未知量。将最终答案表示为单个解析表达式。无需四舍五入，最终表达式中不包含单位。",
            "solution": "用户提供了一个问题，要求在用于基因组数据分析的隐马尔可夫模型 (HMM) 框架中，推导肿瘤纯度参数 $p$ 的M步更新。\n\n### 步骤 1：问题验证\n\n首先，我将从问题陈述中逐字提取给定的信息。\n-   **模型**：隐马尔可夫模型 (HMM)。\n-   **潜在状态**：$(a,b)$，等位基因特异性拷贝数。\n-   **状态空间**：$S=\\{(a,b) \\in \\mathbb{Z}_{\\ge 0}^{2} : a+b \\le C_{\\max}\\}$。\n-   **转移模型**：$\\Pr\\big((a',b') \\mid (a,b)\\big) \\propto \\exp\\big(-\\lambda_{C} \\, |(a'+b') - (a+b)| - \\lambda_{A} \\, |a'-a| - \\lambda_{B} \\, |b'-b|\\big)$。\n-   **观测值**：对于区间 $i \\in \\{1,\\dots,n\\}$ 的归一化覆盖度 $L_{i}$ 和B等位基因频率 $\\mathrm{BAF}_{i}$。\n-   **条件独立性**：给定 $(a,b)$ 和 $p$，$L_{i}$ 和 $\\mathrm{BAF}_{i}$ 条件独立。\n-   **肿瘤纯度**：$p \\in [0,1]$。\n-   **覆盖度的发射模型**：$L_{i} \\mid (a,b),p \\sim \\mathcal{N}\\big(\\mu_{L}(a,b,p), \\sigma_{L}^{2}\\big)$，其中 $\\mu_{L}(a,b,p) = 2 + p\\big((a+b)-2\\big)$。$\\sigma_{L}^{2}$ 已知。\n-   **B等位基因频率的发射模型**：$\\mathrm{BAF}_{i} \\mid (a,b),p \\sim \\mathcal{N}\\big(\\mu_{B}(a,b,p), \\sigma_{B}^{2}\\big)$，其中 $\\mu_{B}(a,b,p) = \\frac{p \\, b + (1-p)\\cdot 1}{p \\, (a+b) + (1-p)\\cdot 2}$。$\\sigma_{B}^{2}$ 已知。\n-   **后验责任**：区间 $i$ 处状态 $(a,b)$ 的后验责任 $\\gamma_{i}(a,b)$ 是给定的，并被视为固定的。\n-   **任务**：推导 $p$ 的闭式M步更新，该更新最大化来自归一化覆盖度发射值 $\\{L_{i}\\}_{i=1}^{n}$ 的期望完整数据对数似然贡献。\n\n接下来，我将基于这些给定的信息来验证问题。\n-   **科学性**：该问题描述了一个用于从DNA测序数据中推断肿瘤特征的标准统计模型，该模型在癌症基因组学中被广泛使用。HMM结构、肿瘤纯度的定义、等位基因特异性拷贝数以及可观测值（$L_i$ 和 $\\mathrm{BAF}_i$）的混合模型都植根于生物信息学和计算生物学的既定原则。平均覆盖度的模型 $\\mu_L(a,b,p) = p(a+b) + 2(1-p)$ 代表了样本中的期望绝对拷贝数，这是一个有效的建模选择。平均BAF的模型 $\\mu_B(a,b,p)$ 正确地表示了在肿瘤细胞（总共 $a+b$ 个拷贝中有 $b$ 个B等位基因拷贝）和正常细胞（总共 $2$ 个拷贝中有 $1$ 个B等位基因）的混合物中B等位基因的比例。该问题在科学上是合理的。\n-   **适定性与完整性**：该问题要求基于一个明确定义的目标函数（覆盖度数据的期望对数似然）进行特定的推导（$p$ 的M步）。所有必要的组成部分都已提供：概率分布的形式、其均值的模型、待优化的参数以及保持固定的量（责任 $\\gamma_i(a,b)$）。要求分离出覆盖度数据的贡献使问题变得更简单，但这是一个明确的指令，而非缺陷。约束条件 $p \\in [0,1]$ 对于混合分数是标准的。该问题是适定且自洽的。\n-   **客观性**：问题以精确的数学术语表述，没有歧义或主观性。\n\n问题是有效的。未检测到任何缺陷。我将继续进行推导。\n\n### 步骤 2：M步更新的推导\n\n期望最大化 (EM) 算法中M步的目标是找到使期望完整数据对数似然（通常表示为 $Q$ 函数）最大化的参数值。在这里，我们想要更新肿瘤纯度 $p$。期望是针对潜在状态的后验分布计算的，其概率由责任 $\\gamma_i(a,b)$ 给出。\n\n问题指明我们只考虑归一化覆盖度发射值 $\\{L_i\\}_{i=1}^n$ 的贡献。需要相对于 $p$ 最大化的 $Q$ 函数的相关部分是：\n$$\nQ_L(p) = E \\left[ \\sum_{i=1}^n \\ln \\Pr(L_i \\mid s_i, p) \\right]\n$$\n其中 $s_i$ 是区间 $i$ 的潜在状态 $(a_i, b_i)$。使用提供的责任 $\\gamma_i(a,b) = \\Pr(s_i=(a,b) \\mid \\text{数据}, p_{\\text{旧}})$ 展开期望：\n$$\nQ_L(p) = \\sum_{i=1}^n \\sum_{(a,b) \\in S} \\gamma_i(a,b) \\ln \\Pr(L_i \\mid s_i=(a,b), p)\n$$\n$L_i$ 的发射概率由高斯分布给出：\n$$\n\\Pr(L_i \\mid s_i=(a,b), p) = \\frac{1}{\\sqrt{2\\pi\\sigma_L^2}} \\exp\\left( -\\frac{(L_i - \\mu_L(a,b,p))^2}{2\\sigma_L^2} \\right)\n$$\n对数概率是：\n$$\n\\ln \\Pr(L_i \\mid s_i=(a,b), p) = -\\frac{1}{2} \\ln(2\\pi\\sigma_L^2) - \\frac{(L_i - \\mu_L(a,b,p))^2}{2\\sigma_L^2}\n$$\n将此代入 $Q_L(p)$ 的表达式中：\n$$\nQ_L(p) = \\sum_{i=1}^n \\sum_{(a,b) \\in S} \\gamma_i(a,b) \\left( -\\frac{1}{2} \\ln(2\\pi\\sigma_L^2) - \\frac{(L_i - \\mu_L(a,b,p))^2}{2\\sigma_L^2} \\right)\n$$\n为了最大化关于 $p$ 的 $Q_L(p)$，我们可以忽略不依赖于 $p$ 的项。这等同于最小化以下目标函数 $J(p)$：\n$$\nJ(p) = \\sum_{i=1}^n \\sum_{(a,b) \\in S} \\gamma_i(a,b) (L_i - \\mu_L(a,b,p))^2\n$$\n现在，代入平均覆盖度的表达式 $\\mu_L(a,b,p) = 2 + p((a+b)-2)$：\n$$\nJ(p) = \\sum_{i=1}^n \\sum_{(a,b) \\in S} \\gamma_i(a,b) \\left( L_i - \\left(2 + p((a+b)-2)\\right) \\right)^2\n$$\n这是一个加权平方和，它是 $p$ 的二次函数。为了找到最小化 $J(p)$ 的 $p$ 值，我们计算关于 $p$ 的导数并将其设为零。\n$$\n\\frac{dJ}{dp} = \\frac{d}{dp} \\sum_{i=1}^n \\sum_{(a,b) \\in S} \\gamma_i(a,b) (L_i - 2 - p(a+b-2))^2\n$$\n使用链式法则：\n$$\n\\frac{dJ}{dp} = \\sum_{i=1}^n \\sum_{(a,b) \\in S} \\gamma_i(a,b) \\cdot 2(L_i - 2 - p(a+b-2)) \\cdot (-(a+b-2))\n$$\n将导数设为零以求极值：\n$$\n-2 \\sum_{i=1}^n \\sum_{(a,b) \\in S} \\gamma_i(a,b) (L_i - 2 - p(a+b-2))(a+b-2) = 0\n$$\n$$\n\\sum_{i=1}^n \\sum_{(a,b) \\in S} \\gamma_i(a,b) \\left[ (L_i - 2)(a+b-2) - p(a+b-2)^2 \\right] = 0\n$$\n我们可以分离包含 $p$ 的项：\n$$\n\\sum_{i=1}^n \\sum_{(a,b) \\in S} \\gamma_i(a,b) (L_i - 2)(a+b-2) = p \\sum_{i=1}^n \\sum_{(a,b) \\in S} \\gamma_i(a,b) (a+b-2)^2\n$$\n求解 $p$，我们得到无约束的最优值，我们称之为 $p^*$：\n$$\np^* = \\frac{\\sum_{i=1}^n \\sum_{(a,b) \\in S} \\gamma_i(a,b) (L_i - 2)(a+b-2)}{\\sum_{i=1}^n \\sum_{(a,b) \\in S} \\gamma_i(a,b) (a+b-2)^2}\n$$\n只要分母不为零，该解就是良定义的。分母为零当且仅当对于所有的 $i$ 和 $(a,b)$，$\\gamma_i(a,b)=0$ 或 $(a+b-2)=0$。后一种情况对应于二倍体肿瘤状态，此时平均覆盖度 $\\mu_L$ 与 $p$ 无关。在这种退化的情况下，覆盖度数据不包含关于 $p$ 的信息，并且无法仅从这些数据中更新 $p$。假设在一个分母不为零的非退化情况下，$p^*$ 是唯一的无约束最优点。\n\n参数 $p$ 是一个比例，必须位于区间 $[0,1]$ 内。函数 $J(p)$ 是一个凸抛物线（其关于 $p$ 的二阶导数为 $\\sum_{i, (a,b)} 2 \\gamma_i(a,b)(a+b-2)^2 \\ge 0$），因此其在区间 $[0,1]$ 上的最小值是通过将 $p^*$ 投影到该区间上得到的。\n因此，$p$ 的M步更新，记为 $p_{\\text{新}}$，是：\n$$\np_{\\text{新}} = \\max(0, \\min(1, p^*))\n$$\n代入 $p^*$ 的表达式，我们得到更新后的肿瘤纯度的最终闭式表达式。\n$$\np_{\\text{新}} = \\max\\left(0, \\min\\left(1, \\frac{\\sum_{i=1}^{n} \\sum_{(a,b) \\in S} \\gamma_{i}(a,b) (L_i - 2) (a+b-2)}{\\sum_{i=1}^{n} \\sum_{(a,b) \\in S} \\gamma_{i}(a,b) (a+b-2)^2}\\right)\\right)\n$$\n该表达式是闭式解，仅依赖于所要求的给定数量，并代表了约束优化问题的完整解。",
            "answer": "$$\n\\boxed{\\max\\left(0, \\min\\left(1, \\frac{\\sum_{i=1}^{n} \\sum_{(a,b) \\in S} \\gamma_{i}(a,b) (L_{i} - 2) (a+b-2)}{\\sum_{i=1}^{n} \\sum_{(a,b) \\in S} \\gamma_{i}(a,b) (a+b-2)^2}\\right)\\right)}\n$$"
        }
    ]
}