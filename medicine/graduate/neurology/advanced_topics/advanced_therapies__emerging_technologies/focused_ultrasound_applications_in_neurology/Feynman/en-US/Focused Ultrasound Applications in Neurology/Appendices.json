{
    "hands_on_practices": [
        {
            "introduction": "The first major obstacle in delivering ultrasound to the brain is the skull itself. This exercise explores the fundamental acoustic principle of impedance mismatch, which governs how much energy is reflected at the boundary between the coupling medium and the skull. By deriving and calculating the pressure reflection coefficient, you will gain a quantitative understanding of this critical challenge in transcranial FUS design. ",
            "id": "4480737",
            "problem": "A transcranial Focused Ultrasound (FUS) system is coupling acoustic energy from a water bath into the human skull to reach a deep brain target. Locally at the point of incidence, approximate the interaction as a one-dimensional, time-harmonic plane longitudinal wave at normal incidence on a planar interface between two lossless, homogeneous, fluid-like media: medium $1$ (water) and medium $2$ (skull). Neglect absorption, shear mode conversion, and curvature or thickness effects so that the interface can be treated as a boundary between two semi-infinite media. Use the definition of specific acoustic impedance $Z$ as $Z=\\rho c$, where $\\rho$ is the mass density and $c$ is the longitudinal sound speed in the medium.\n\nStarting from the linear acoustic boundary conditions that the total acoustic pressure and the normal component of particle velocity are continuous across the interface, and from the plane-wave relations for pressure and particle velocity in each medium, derive the normal-incidence complex pressure reflection coefficient (ratio of reflected to incident pressure amplitudes) in terms of $Z_1$ and $Z_2$. Then, evaluate it numerically for a water–skull interface with $Z_1 = 1.5\\ \\mathrm{MRayl}$ for water and $Z_2 = 7.0\\ \\mathrm{MRayl}$ for skull.\n\nReport the final numerical value of the dimensionless pressure reflection coefficient amplitude, rounded to four significant figures. Do not include units in your final answer.",
            "solution": "The problem requires the derivation of the normal-incidence pressure reflection coefficient at a planar interface between two lossless, fluid-like media, followed by a numerical evaluation for a specific water-skull interface.\n\nLet the interface between medium $1$ and medium $2$ be located at the plane $x=0$. Medium $1$ occupies the space $x<0$ and medium $2$ occupies the space $x>0$. A plane wave propagates from medium $1$ towards medium $2$ along the $x$-axis.\n\nWe represent the time-harmonic acoustic pressure waves in complex exponential form. The angular frequency is $\\omega$ and the wave numbers in the media are $k_1$ and $k_2$.\n\nIn medium $1$ ($x<0$), the total acoustic pressure $p_1$ is the sum of the incident wave $p_i$ and the reflected wave $p_r$:\n$$p_i(x,t) = P_i \\exp(j(\\omega t - k_1 x))$$\n$$p_r(x,t) = P_r \\exp(j(\\omega t + k_1 x))$$\n$$p_1(x,t) = p_i(x,t) + p_r(x,t) = (P_i \\exp(-j k_1 x) + P_r \\exp(j k_1 x)) \\exp(j\\omega t)$$\nHere, $P_i$ and $P_r$ are the complex pressure amplitudes of the incident and reflected waves, respectively.\n\nIn medium $2$ ($x>0$), there is only a transmitted wave $p_t$:\n$$p_t(x,t) = P_t \\exp(j(\\omega t - k_2 x))$$\n$$p_2(x,t) = p_t(x,t) = P_t \\exp(j(\\omega t - k_2 x))$$\nHere, $P_t$ is the complex pressure amplitude of the transmitted wave.\n\nThe relationship between acoustic pressure $p$ and particle velocity $u$ for a plane wave is given by the specific acoustic impedance $Z$. For a wave propagating in the $+x$ direction, $p = Z u$. For a wave propagating in the $-x$ direction, $p = -Z u$.\nThus, the particle velocities corresponding to the pressure waves are:\nIncident velocity: $u_i(x,t) = \\frac{p_i(x,t)}{Z_1} = \\frac{P_i}{Z_1} \\exp(j(\\omega t - k_1 x))$\nReflected velocity: $u_r(x,t) = -\\frac{p_r(x,t)}{Z_1} = -\\frac{P_r}{Z_1} \\exp(j(\\omega t + k_1 x))$\nTransmitted velocity: $u_t(x,t) = \\frac{p_t(x,t)}{Z_2} = \\frac{P_t}{Z_2} \\exp(j(\\omega t - k_2 x))$\n\nThe total particle velocity in each medium is:\nIn medium $1$: $u_1(x,t) = u_i(x,t) + u_r(x,t) = (\\frac{P_i}{Z_1} \\exp(-j k_1 x) - \\frac{P_r}{Z_1} \\exp(j k_1 x)) \\exp(j\\omega t)$\nIn medium $2$: $u_2(x,t) = u_t(x,t) = \\frac{P_t}{Z_2} \\exp(j(\\omega t - k_2 x))$\n\nNow, we apply the boundary conditions at the interface $x=0$.\n1. Continuity of acoustic pressure: $p_1(0,t) = p_2(0,t)$\n$$(P_i \\exp(0) + P_r \\exp(0)) \\exp(j\\omega t) = P_t \\exp(0) \\exp(j\\omega t)$$\n$$P_i + P_r = P_t$$\n\n2. Continuity of normal particle velocity: $u_1(0,t) = u_2(0,t)$\n$$(\\frac{P_i}{Z_1} \\exp(0) - \\frac{P_r}{Z_1} \\exp(0)) \\exp(j\\omega t) = \\frac{P_t}{Z_2} \\exp(0) \\exp(j\\omega t)$$\n$$\\frac{P_i - P_r}{Z_1} = \\frac{P_t}{Z_2}$$\n\nWe now have a system of two linear equations for the amplitudes $P_i$, $P_r$, and $P_t$:\n(1) $P_i + P_r = P_t$\n(2) $P_i - P_r = \\frac{Z_1}{Z_2} P_t$\n\nThe goal is to find the pressure reflection coefficient, $R_p = \\frac{P_r}{P_i}$. We can eliminate $P_t$ from the system. Substitute equation (1) into equation (2):\n$$P_i - P_r = \\frac{Z_1}{Z_2} (P_i + P_r)$$\nMultiply both sides by $Z_2$:\n$$Z_2(P_i - P_r) = Z_1(P_i + P_r)$$\n$$Z_2 P_i - Z_2 P_r = Z_1 P_i + Z_1 P_r$$\nRearrange the terms to group $P_i$ and $P_r$:\n$$Z_2 P_i - Z_1 P_i = Z_1 P_r + Z_2 P_r$$\n$$P_i (Z_2 - Z_1) = P_r (Z_1 + Z_2)$$\nFinally, solve for the ratio $\\frac{P_r}{P_i}$:\n$$R_p = \\frac{P_r}{P_i} = \\frac{Z_2 - Z_1}{Z_2 + Z_1}$$\nThis is the derived expression for the normal-incidence pressure reflection coefficient.\n\nNext, we evaluate this coefficient numerically for the water-skull interface. The problem provides:\n$Z_1 = 1.5\\ \\mathrm{MRayl}$\n$Z_2 = 7.0\\ \\mathrm{MRayl}$\n\nSince the media are lossless, the impedances $Z_1$ and $Z_2$ are real numbers. Therefore, the reflection coefficient $R_p$ is also a real number. The amplitude of the reflection coefficient, $|R_p|$, is its absolute value.\n$$R_p = \\frac{7.0 - 1.5}{7.0 + 1.5} = \\frac{5.5}{8.5}$$\nThe units of MRayl cancel out, as expected for a dimensionless coefficient.\nCalculating the numerical value:\n$$R_p = \\frac{5.5}{8.5} \\approx 0.6470588235...$$\nSince $Z_2 > Z_1$, the value of $R_p$ is positive, so the amplitude is equal to the value itself.\nThe problem asks for the result rounded to four significant figures.\n$$|R_p| \\approx 0.6471$$",
            "answer": "$$\\boxed{0.6471}$$"
        },
        {
            "introduction": "Successfully delivering acoustic energy to a neural target is only half the battle; the therapeutic effect must be precisely controlled. This practice introduces the concept of thermal dose, a crucial metric used in clinical settings to quantify tissue damage from heating. You will apply the widely used Cumulative Equivalent Minutes at $43^\\circ\\mathrm{C}$ (CEM43) model to understand how a specific temperature-time profile translates into a predictable biological outcome. ",
            "id": "4480735",
            "problem": "Focused Ultrasound (FUS) is used in neurology for thermal ablation, for example during thalamotomy targeting the ventral intermediate nucleus to treat essential tremor. Tissue damage kinetics under heating can be modeled at a fundamental level by an Arrhenius-type injury integral, which implies that damage accrual per unit time increases monotonically with temperature. A widely used operational measure in thermal neurosurgery is the cumulative equivalent minutes at $43^\\circ\\mathrm{C}$, abbreviated as CEM43. This measure maps an arbitrary temperature–time history $T(t)$ to an equivalent exposure duration at a reference temperature $43^\\circ\\mathrm{C}$ by weighting time according to a temperature-dependent factor. Empirical calibration based on thermal injury kinetics supports the use of a piecewise-constant weighting parameter $R$ such that for temperatures at or above $43^\\circ\\mathrm{C}$ one has $R=0.5$, which reflects the observation that the injury rate approximately doubles for each $1^\\circ\\mathrm{C}$ increase above $43^\\circ\\mathrm{C}$.\n\nStarting from the Arrhenius concept that injury accrual per unit time scales multiplicatively with temperature and using the above empirical calibration for $R$ at or above $43^\\circ\\mathrm{C}$, derive the expression for CEM43 as an integral over time with the appropriate temperature weight. Then, apply your derived expression to compute the CEM43 for a constant-temperature plateau $T(t)=55^\\circ\\mathrm{C}$ maintained for $20\\ \\mathrm{s}$ during a Magnetic Resonance-guided Focused Ultrasound (MRgFUS) neurosurgical sonication. Use minutes for the time variable in the CEM43 definition and assume $R=0.5$ for $T\\ge 43^\\circ\\mathrm{C}$. Express the final thermal dose in minutes and round your answer to four significant figures. Your final answer must be a single real-valued number.",
            "solution": "The problem requires two parts: first, the derivation of the mathematical expression for the Cumulative Equivalent Minutes at $43^\\circ\\mathrm{C}$ (CEM43), and second, the application of this expression to a specific thermal exposure scenario.\n\n#### Part 1: Derivation of the CEM43 Expression\n\nThe CEM43 is a measure of thermal dose that normalizes a given temperature-time history, $T(t)$, to an equivalent duration of exposure at a constant reference temperature, $T_{\\text{ref}} = 43^\\circ\\mathrm{C}$. The underlying principle, rooted in Arrhenius kinetics, is that the rate of thermally induced biological damage, let's denote it as $\\dot{\\Omega}$, is a strong function of temperature.\n\nThe total accumulated damage, $\\Omega$, over a time interval from $t=0$ to $t=t_{\\text{final}}$ is given by the integral of the damage rate:\n$$ \\Omega = \\int_0^{t_{\\text{final}}} \\dot{\\Omega}(T(t)) dt $$\nThe CEM43 is defined as the time $t_{\\text{eq}}$ that would produce the same total damage $\\Omega$ if the temperature were held constant at $T_{\\text{ref}}$:\n$$ \\Omega = \\dot{\\Omega}(T_{\\text{ref}}) \\cdot t_{\\text{eq}} = \\dot{\\Omega}(T_{\\text{ref}}) \\cdot \\text{CEM43} $$\nEquating the two expressions for $\\Omega$ gives:\n$$ \\dot{\\Omega}(T_{\\text{ref}}) \\cdot \\text{CEM43} = \\int_0^{t_{\\text{final}}} \\dot{\\Omega}(T(t)) dt $$\nSolving for CEM43, we get:\n$$ \\text{CEM43} = \\int_0^{t_{\\text{final}}} \\frac{\\dot{\\Omega}(T(t))}{\\dot{\\Omega}(T_{\\text{ref}})} dt $$\nThe term $\\frac{\\dot{\\Omega}(T(t))}{\\dot{\\Omega}(T_{\\text{ref}})}$ is the dimensionless temperature-dependent weighting factor. The problem states that for temperatures $T \\ge 43^\\circ\\mathrm{C}$, the injury rate approximately doubles for each $1^\\circ\\mathrm{C}$ increase. Let us formalize this relationship. The ratio of the damage rate at a temperature $T$ to the damage rate at the reference temperature $T_{\\text{ref}} = 43^\\circ\\mathrm{C}$ can be expressed as an exponential function. For each degree Celsius above $T_{\\text{ref}}$, the rate is multiplied by a factor of $2$. Thus, for a temperature difference of $(T - T_{\\text{ref}})$ degrees, the rate is multiplied by $2$ this many times.\nThis leads to the weighting factor for $T \\ge T_{\\text{ref}}$:\n$$ \\frac{\\dot{\\Omega}(T)}{\\dot{\\Omega}(T_{\\text{ref}})} = 2^{(T - T_{\\text{ref}})} $$\nwhere temperatures are in degrees Celsius.\n\nThe problem defines the model using a parameter $R=0.5$. Let's show how this relates to our derived weighting factor. The standard formulation for the CEM43 integral uses $R$:\n$$ \\text{CEM43} = \\int_0^{t_{\\text{final}}} R^{(T_{\\text{ref}} - T(t))} dt $$\nFor $T \\ge 43^\\circ\\mathrm{C}$, we are given $R=0.5$. Substituting this value, the weighting factor becomes:\n$$ R^{(T_{\\text{ref}} - T)} = (0.5)^{(T_{\\text{ref}} - T)} = \\left(\\frac{1}{2}\\right)^{(T_{\\text{ref}} - T)} = (2^{-1})^{(T_{\\text{ref}} - T)} = 2^{-(T_{\\text{ref}} - T)} = 2^{(T - T_{\\text{ref}})} $$\nThis confirms that the standard formula with $R=0.5$ is perfectly consistent with the empirical observation that the damage rate doubles for each $1^\\circ\\mathrm{C}$ increase above $43^\\circ\\mathrm{C}$.\n\nTherefore, the derived expression for CEM43, with time $t$ expressed in minutes, is:\n$$ \\text{CEM43} = \\int_0^{t_{\\text{final}}} R^{(43 - T(t))} dt $$\nwhere $R=0.5$ for $T(t) \\ge 43^\\circ\\mathrm{C}$.\n\n#### Part 2: Calculation for a Specific Scenario\n\nWe are asked to compute the CEM43 for a constant-temperature plateau maintained at $T(t) = T_{\\text{plateau}} = 55^\\circ\\mathrm{C}$ for a duration of $20\\ \\mathrm{s}$.\n\nFirst, we must convert the duration into the required unit of minutes. Let $\\Delta t$ be the duration.\n$$ \\Delta t = 20\\ \\mathrm{s} \\times \\frac{1\\ \\text{min}}{60\\ \\mathrm{s}} = \\frac{20}{60}\\ \\text{min} = \\frac{1}{3}\\ \\text{min} $$\nThe exposure time starts at $t=0$ and ends at $t_{\\text{final}} = \\frac{1}{3}$ min.\n\nSince the temperature is constant at $T(t)=55^\\circ\\mathrm{C}$ over the entire interval, and $55^\\circ\\mathrm{C} \\ge 43^\\circ\\mathrm{C}$, we use $R=0.5$. The integrand $R^{(43 - T(t))}$ is constant.\n$$ R^{(43 - T(t))} = (0.5)^{(43 - 55)} = (0.5)^{(-12)} $$\nThe integral simplifies to the constant integrand multiplied by the duration of the interval:\n$$ \\text{CEM43} = \\int_0^{1/3} (0.5)^{(-12)} dt = (0.5)^{(-12)} \\cdot \\int_0^{1/3} dt $$\n$$ \\text{CEM43} = (0.5)^{(-12)} \\cdot \\left[t\\right]_0^{1/3} = (0.5)^{(-12)} \\cdot \\left(\\frac{1}{3} - 0\\right) $$\n$$ \\text{CEM43} = (0.5)^{(-12)} \\cdot \\frac{1}{3} $$\nNow we evaluate this expression numerically.\n$$ (0.5)^{(-12)} = \\left(\\frac{1}{2}\\right)^{(-12)} = 2^{12} $$\nWe know that $2^{10} = 1024$, so $2^{12} = 2^{10} \\times 2^2 = 1024 \\times 4 = 4096$.\n$$ \\text{CEM43} = 4096 \\cdot \\frac{1}{3} = \\frac{4096}{3} $$\n$$ \\text{CEM43} \\approx 1365.333... \\text{ minutes} $$\nThe problem requires the answer to be rounded to four significant figures. The first four significant figures are $1$, $3$, $6$, and $5$. The fifth digit is $3$, which is less than $5$, so we round down.\nThe resulting value is $1365$.",
            "answer": "$$\n\\boxed{1365}\n$$"
        },
        {
            "introduction": "Modern FUS systems overcome physical barriers and achieve precise targeting through the sophisticated control of multi-element transducer arrays. This advanced practice delves into the computational core of this technology, challenging you to formulate an optimization problem that maximizes focal pressure while respecting critical safety constraints like skull heating. Solving this problem demonstrates how to balance therapeutic efficacy and patient safety using state-of-the-art convex optimization techniques. ",
            "id": "4480738",
            "problem": "A multi-element therapeutic transducer is used for transcranial Focused Ultrasound (FUS). In the linear acoustic regime, under the superposition principle, the complex acoustic pressure at a focal location produced by an array with complex weights is the inner product of a complex steering vector and the complex weight vector. Skull heating risk can be conservatively proxied by Euclidean norms of linear maps from the array weights to energy deposition metrics (for example, to Specific Absorption Rate (SAR) surrogates computed at selected skull voxels). You must derive, implement, and solve a convex optimization that selects complex array weights to maximize focal pressure subject to these heating constraints and a total power budget.\n\nStart from the following fundamentals and core definitions:\n- Linear superposition in the frequency domain: if the complex pressure at the focus due to unit excitation of element $i$ is the $i$th component of $h \\in \\mathbb{C}^N$, and the complex array weights are $w \\in \\mathbb{C}^N$, then the complex focal pressure is $p = h^{H} w$, where $(\\cdot)^{H}$ denotes conjugate transpose.\n- Norm-based power constraints: a total power budget can be modeled as $\\lVert w \\rVert_2 \\leq P_{\\max}$, where $P_{\\max} \\ge 0$ is given and $\\lVert \\cdot \\rVert_2$ is the Euclidean norm.\n- Heating proxy as a norm of a linear map: for each skull region or voxel $m \\in \\{1,\\dots,M\\}$, there exists a complex matrix $B_m \\in \\mathbb{C}^{L_m \\times N}$ and bound $s_m \\ge 0$ such that the constraint $\\lVert B_m w \\rVert_2 \\le s_m$ limits heating at that region.\n\nYour tasks:\n1. Derive from first principles a convex optimization problem whose objective is to maximize the focal pressure magnitude and whose constraints are the total power and the heating-proxy bounds above. Your derivation must explain how to express the complex problem over real variables and why the resulting program is a second-order cone program.\n2. Implement a solver for the derived convex program using only the permitted scientific computing environment. You must not assume any nonconvex reformulation. The implementation must adhere to the following:\n   - Represent complex variables using real variables and set up second-order cone constraints accordingly.\n   - Use a deterministic numerical method to obtain an optimal solution from a feasible starting point.\n3. For each provided test case below, compute the maximum achievable focal pressure as a nonnegative real number, that is, the optimal value of the objective you derive. You must express all answers as unitless real numbers rounded to six decimal places.\n\nAngle units are not applicable. All provided quantities are dimensionless. The input data for each test is specified below. For every vector or matrix, real and imaginary parts are given separately. When a matrix is provided, it is specified row-wise.\n\nYou are given $N = 4$ and the same steering vector $h \\in \\mathbb{C}^4$ for all test cases, with\n$$\n\\Re(h) = [\\,1.0,\\;0.3,\\;-0.1,\\;0.2\\,], \\quad\n\\Im(h) = [\\,0.5,\\;-0.2,\\;0.4,\\;0.1\\,].\n$$\n\nTest suite:\n- Case A (power-limited, heating slack):\n  - $P_{\\max} = 1.5$.\n  - $M = 1$ heating constraint with $L_1 = 4$,\n    $$\n    \\Re(B_1) = \\begin{bmatrix}\n    0.5 & 0.0 & 0.0 & 0.0\\\\\n    0.0 & 0.5 & 0.0 & 0.0\\\\\n    0.0 & 0.0 & 0.5 & 0.0\\\\\n    0.0 & 0.0 & 0.0 & 0.5\n    \\end{bmatrix}, \\quad\n    \\Im(B_1) = \\begin{bmatrix}\n    0.0 & 0.0 & 0.0 & 0.0\\\\\n    0.0 & 0.0 & 0.0 & 0.0\\\\\n    0.0 & 0.0 & 0.0 & 0.0\\\\\n    0.0 & 0.0 & 0.0 & 0.0\n    \\end{bmatrix}, \\quad\n    s_1 = 10.0.\n    $$\n- Case B (heating-limited with per-element penalty):\n  - $P_{\\max} = 5.0$.\n  - $M = 1$ heating constraint with $L_1 = 4$,\n    $$\n    \\Re(B_1) = \\begin{bmatrix}\n    3.0 & 0.0 & 0.0 & 0.0\\\\\n    0.0 & 0.1 & 0.0 & 0.0\\\\\n    0.0 & 0.0 & 0.1 & 0.0\\\\\n    0.0 & 0.0 & 0.0 & 0.1\n    \\end{bmatrix}, \\quad\n    \\Im(B_1) = \\begin{bmatrix}\n    0.0 & 0.0 & 0.0 & 0.0\\\\\n    0.0 & 0.0 & 0.0 & 0.0\\\\\n    0.0 & 0.0 & 0.0 & 0.0\\\\\n    0.0 & 0.0 & 0.0 & 0.0\n    \\end{bmatrix}, \\quad\n    s_1 = 1.0.\n    $$\n- Case C (multiple skull-region constraints with coupling):\n  - $P_{\\max} = 2.0$.\n  - $M = 2$ constraints:\n    - $L_1 = 4$,\n      $$\n      \\Re(B_1) = \\begin{bmatrix}\n      1.5 & 0.0 & 0.0 & 0.0\\\\\n      0.0 & 0.5 & 0.0 & 0.0\\\\\n      0.0 & 0.0 & 1.0 & 0.0\\\\\n      0.0 & 0.0 & 0.0 & 0.5\n      \\end{bmatrix}, \\quad\n      \\Im(B_1) = \\begin{bmatrix}\n      0.0 & 0.0 & 0.0 & 0.0\\\\\n      0.0 & 0.0 & 0.0 & 0.0\\\\\n      0.0 & 0.0 & 0.0 & 0.0\\\\\n      0.0 & 0.0 & 0.0 & 0.0\n      \\end{bmatrix}, \\quad\n      s_1 = 0.6.\n      $$\n    - $L_2 = 2$,\n      $$\n      \\Re(B_2) = \\begin{bmatrix}\n      0.8 & -0.3 & 0.1 & 0.0\\\\\n      0.2 & 0.5 & -0.4 & 0.3\n      \\end{bmatrix}, \\quad\n      \\Im(B_2) = \\begin{bmatrix}\n      0.1 & 0.2 & -0.2 & 0.1\\\\\n      -0.3 & 0.1 & 0.0 & -0.2\n      \\end{bmatrix}, \\quad\n      s_2 = 0.4.\n      $$\n- Case D (degenerate power budget):\n  - $P_{\\max} = 0.0$.\n  - $M = 0$ heating constraints.\n\nYour program must compute the optimal objective value for each case and produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example, \"[vA,vB,vC,vD]\". Values must be rounded to six decimal places and printed with standard decimal notation.\n\nThe final answer type for each case is a float. No other output is permitted.",
            "solution": "### Part 1: Derivation of the Convex Optimization Problem\n\nThe goal is to maximize the magnitude of the complex focal pressure, $|p|$, subject to constraints on total power and localized heating. The complex pressure is given by $p = h^{H} w$, where $h \\in \\mathbb{C}^N$ is the steering vector and $w \\in \\mathbb{C}^N$ is the vector of complex array weights. The constraints are given as:\n1.  Total power budget: $\\lVert w \\rVert_2 \\leq P_{\\max}$\n2.  Heating proxies: $\\lVert B_m w \\rVert_2 \\le s_m$ for $m=1, \\dots, M$\n\nThe optimization problem is initially formulated as:\n$$\n\\begin{array}{ll}\n\\text{maximize} & |h^H w| \\\\\n\\text{subject to} & \\lVert w \\rVert_2 \\leq P_{\\max} \\\\\n& \\lVert B_m w \\rVert_2 \\le s_m, \\quad m=1, \\dots, M\n\\end{array}\n$$\nThe optimization variables are the complex weights $w \\in \\mathbb{C}^N$.\n\nTo convert this into a standard convex optimization form, we first address the objective function, $|h^H w|$. For any optimal solution $w^*$, let the resulting complex pressure be $h^H w^* = \\rho e^{i\\theta}$, where $\\rho = |h^H w^*|$ is the magnitude. We can define a new weight vector $w' = w^* e^{-i\\theta}$. This rotation does not change the norms of $w$ or $B_m w$:\n- $\\lVert w' \\rVert_2 = \\lVert w^* e^{-i\\theta} \\rVert_2 = |e^{-i\\theta}| \\lVert w^* \\rVert_2 = \\lVert w^* \\rVert_2$\n- $\\lVert B_m w' \\rVert_2 = \\lVert B_m (w^* e^{-i\\theta}) \\rVert_2 = |e^{-i\\theta}| \\lVert B_m w^* \\rVert_2 = \\lVert B_m w^* \\rVert_2$\nThus, $w'$ is also a feasible solution. The pressure produced by $w'$ is $h^H w' = h^H w^* e^{-i\\theta} = (\\rho e^{i\\theta}) e^{-i\\theta} = \\rho = |h^H w^*|$. This new pressure is real and positive. This shows that an optimal solution can always be found that produces a real and positive pressure. Therefore, maximizing $|h^H w|$ is equivalent to maximizing its real part, $\\mathrm{Re}(h^H w)$, under the same set of constraints. The optimization problem becomes:\n$$\n\\begin{array}{ll}\n\\text{maximize} & \\mathrm{Re}(h^H w) \\\\\n\\text{subject to} & \\lVert w \\rVert_2 \\leq P_{\\max} \\\\\n& \\lVert B_m w \\rVert_2 \\le s_m, \\quad m=1, \\dots, M\n\\end{array}\n$$\nThis is a convex optimization problem, as the objective function is linear in the real and imaginary parts of $w$, and the constraint functions are convex (Euclidean norms).\n\nTo solve this numerically, we express the problem using real variables. Let $w = x + i y$, where $x, y \\in \\mathbb{R}^N$ are the real and imaginary parts of the weights. We define a single real optimization vector $\\mathbf{v} \\in \\mathbb{R}^{2N}$ as $\\mathbf{v} = \\begin{pmatrix} x \\\\ y \\end{pmatrix}$. Similarly, let $h = h_{re} + i h_{im}$.\n\nThe objective function $\\mathrm{Re}(h^H w)$ becomes a linear function of $\\mathbf{v}$:\n$$\n\\mathrm{Re}(h^H w) = \\mathrm{Re}((h_{re} - i h_{im})^T (x + i y)) = h_{re}^T x + h_{im}^T y = \\begin{pmatrix} h_{re} \\\\ h_{im} \\end{pmatrix}^T \\begin{pmatrix} x \\\\ y \\end{pmatrix} = c^T \\mathbf{v}\n$$\nwhere $c = \\begin{pmatrix} \\mathrm{Re}(h) \\\\ \\mathrm{Im}(h) \\end{pmatrix} \\in \\mathbb{R}^{2N}$.\n\nThe power constraint $\\lVert w \\rVert_2 \\leq P_{\\max}$ is transformed by noting that $\\lVert w \\rVert_2^2 = w^H w = x^T x + y^T y = \\lVert x \\rVert_2^2 + \\lVert y \\rVert_2^2 = \\lVert \\mathbf{v} \\rVert_2^2$. The constraint becomes $\\lVert \\mathbf{v} \\rVert_2 \\leq P_{\\max}$.\n\nThe heating constraints $\\lVert B_m w \\rVert_2 \\leq s_m$ are transformed by letting $B_m = B_{m,re} + i B_{m,im}$. The product $B_m w$ is:\n$$\nB_m w = (B_{m,re} + i B_{m,im})(x + i y) = (B_{m,re} x - B_{m,im} y) + i (B_{m,im} x + B_{m,re} y)\n$$\nThe squared norm is $\\lVert B_m w \\rVert_2^2 = \\lVert B_{m,re} x - B_{m,im} y \\rVert_2^2 + \\lVert B_{m,im} x + B_{m,re} y \\rVert_2^2$. This corresponds to the squared norm of the real vector $\\begin{pmatrix} B_{m,re} x - B_{m,im} y \\\\ B_{m,im} x + B_{m,re} y \\end{pmatrix}$. This vector can be written as a matrix-vector product:\n$$\n\\begin{pmatrix} B_{m,re} & -B_{m,im} \\\\ B_{m,im} & B_{m,re} \\end{pmatrix} \\begin{pmatrix} x \\\\ y \\end{pmatrix} = \\mathbf{C}_m \\mathbf{v}\n$$\nwhere $\\mathbf{C}_m \\in \\mathbb{R}^{2L_m \\times 2N}$. The heating constraint then becomes $\\lVert \\mathbf{C}_m \\mathbf{v} \\rVert_2 \\leq s_m$.\n\nWe can now state the final optimization problem in a standard second-order cone programming (SOCP) form. We minimize the negative of the objective function:\n$$\n\\begin{array}{ll}\n\\text{minimize} & -c^T \\mathbf{v} \\\\\n\\text{subject to} & \\lVert \\mathbf{I}_{2N} \\mathbf{v} \\rVert_2 \\leq P_{\\max} \\\\\n& \\lVert \\mathbf{C}_m \\mathbf{v} \\rVert_2 \\leq s_m, \\quad m=1, \\dots, M\n\\end{array}\n$$\nThis is an SOCP because the objective is linear and each constraint is a second-order (or quadratic) cone constraint of the form $\\lVert A\\mathbf{v} + b \\rVert_2 \\le c^T\\mathbf{v} + d$. In our case, $b=0$, $c=0$, and $d$ is either $P_{\\max}$ or $s_m$.\n\n### Part 2: Implementation Strategy\n\nThe derived SOCP can be solved using numerical optimization software. The problem specifies an environment with `numpy` and `scipy`. We will use `scipy.optimize.minimize` with the Sequential Least Squares Programming (`SLSQP`) algorithm. This algorithm can solve general nonlinear constrained optimization problems.\n\nTo use `SLSQP`, we must provide the objective function and constraint functions in the form $g(\\mathbf{v}) \\ge 0$.\n- The objective function to minimize is $f(\\mathbf{v}) = -c^T \\mathbf{v}$.\n- The power constraint $\\lVert \\mathbf{v} \\rVert_2 \\le P_{\\max}$ is equivalent to $P_{\\max}^2 - \\lVert \\mathbf{v} \\rVert_2^2 \\ge 0$.\n- The heating constraints $\\lVert \\mathbf{C}_m \\mathbf{v} \\rVert_2 \\le s_m$ are equivalent to $s_m^2 - \\lVert \\mathbf{C}_m \\mathbf{v} \\rVert_2^2 \\ge 0$.\n\nThis transformation from norm-inequalities to squared norm-inequalities is valid because the quantities are non-negative. The functions $g_0(\\mathbf{v}) = P_{\\max}^2 - \\mathbf{v}^T\\mathbf{v}$ and $g_m(\\mathbf{v}) = s_m^2 - \\mathbf{v}^T \\mathbf{C}_m^T \\mathbf{C}_m \\mathbf{v}$ are concave. A superlevel set of a concave function ($g(\\mathbf{v}) \\ge 0$) is a convex set. Thus, the feasible region remains convex, and the reformulation does not introduce non-convexity. The solver is initialized at the feasible point $\\mathbf{v}_0 = 0$. The optimal value of the objective, which is the maximum focal pressure magnitude, is the negative of the value returned by the `minimize` function.\n\nThe provided Python code implements this strategy, constructing the vector $c$ and matrices $\\mathbf{C}_m$ from the given test case data, setting up the objective and constraint functions, and calling the `SLSQP` solver.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import minimize\n\ndef solve():\n    \"\"\"\n    Derives and solves a convex optimization problem for focused ultrasound.\n    \"\"\"\n    # Global parameters common to all test cases\n    N = 4\n    h_re = np.array([1.0, 0.3, -0.1, 0.2])\n    h_im = np.array([0.5, -0.2, 0.4, 0.1])\n    \n    # The optimization cost vector c is derived from h, for the real-valued formulation.\n    # The objective is to maximize c^T v, where v = [Re(w), Im(w)]^T.\n    c = np.concatenate([h_re, h_im])\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case A: power-limited, heating slack\n        {\n            'P_max': 1.5,\n            'constraints': [\n                {\n                    'B_re': np.diag([0.5] * N),\n                    'B_im': np.zeros((N, N)),\n                    's': 10.0\n                }\n            ]\n        },\n        # Case B: heating-limited with per-element penalty\n        {\n            'P_max': 5.0,\n            'constraints': [\n                {\n                    'B_re': np.diag([3.0, 0.1, 0.1, 0.1]),\n                    'B_im': np.zeros((N, N)),\n                    's': 1.0\n                }\n            ]\n        },\n        # Case C: multiple skull-region constraints with coupling\n        {\n            'P_max': 2.0,\n            'constraints': [\n                {\n                    'B_re': np.diag([1.5, 0.5, 1.0, 0.5]),\n                    'B_im': np.zeros((N, N)),\n                    's': 0.6\n                },\n                {\n                    'B_re': np.array([[0.8, -0.3, 0.1, 0.0],\n                                      [0.2, 0.5, -0.4, 0.3]]),\n                    'B_im': np.array([[0.1, 0.2, -0.2, 0.1],\n                                      [-0.3, 0.1, 0.0, -0.2]]),\n                    's': 0.4\n                }\n            ]\n        },\n        # Case D: degenerate power budget\n        {\n            'P_max': 0.0,\n            'constraints': []\n        }\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        P_max = case['P_max']\n\n        # Handle the degenerate case where the power budget is zero.\n        # The only feasible solution is w=0, resulting in zero pressure.\n        if P_max == 0.0:\n            results.append(0.0)\n            continue\n        \n        # The objective is to maximize Re(h^H w), which is c^T v.\n        # scipy.optimize.minimize minimizes, so we minimize -c^T v.\n        objective_function = lambda v: -np.dot(c, v)\n\n        # The optimization variable v is initialized to a feasible point (the origin).\n        v_initial = np.zeros(2 * N)\n\n        # Collect all constraints for the solver.\n        scipy_constraints = []\n        \n        # 1. Total power constraint: ||v||_2 <= P_max\n        #    Formulated for SLSQP as an inequality constraint: P_max^2 - v^T v >= 0\n        power_constraint = {\n            'type': 'ineq',\n            'fun': lambda v, p=P_max: p**2 - np.dot(v, v)\n        }\n        scipy_constraints.append(power_constraint)\n        \n        # 2. Heating proxy constraints: ||B_m w||_2 <= s_m\n        for constraint_params in case['constraints']:\n            B_re = constraint_params['B_re']\n            B_im = constraint_params['B_im']\n            s_m = constraint_params['s']\n            \n            # Construct the real-valued matrix C_m for the constraint ||C_m v||_2 <= s_m\n            C_m = np.block([\n                [B_re, -B_im],\n                [B_im,  B_re]\n            ])\n            \n            # Formulated for SLSQP as s_m^2 - ||C_m v||_2^2 >= 0\n            # A lambda with default arguments is used to capture the matrix C_m and scalar s_m\n            # for each specific constraint within the loop.\n            heating_constraint = {\n                'type': 'ineq',\n                'fun': lambda v, C=C_m, s=s_m: s**2 - np.dot(C @ v, C @ v)\n            }\n            scipy_constraints.append(heating_constraint)\n        \n        # Solve the convex optimization problem using SLSQP.\n        solution = minimize(objective_function, \n                            v_initial, \n                            method='SLSQP', \n                            constraints=scipy_constraints, \n                            options={'ftol': 1e-12, 'maxiter': 500})\n        \n        # The optimal value of the objective function is the maximum focal pressure.\n        # It's the negative of the minimized value since we minimized -f(v).\n        max_focal_pressure = -solution.fun if solution.success else 0.0\n\n        # The maximum pressure magnitude must be non-negative.\n        if max_focal_pressure < 0:\n            max_focal_pressure = 0.0\n\n        results.append(max_focal_pressure)\n\n    # Format the final output as a comma-separated list of values\n    # rounded to six decimal places, enclosed in square brackets.\n    formatted_results = [f'{r:.6f}' for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}