## 引言
在不知道要寻找什么的情况下，我们如何发现数据中有意义的群组？虽然许多[算法](@article_id:331821)要求我们预先指定簇的数量，但存在一种更具探索性的方法，可以揭示数据集中关系的整个层次结构。这就是凝聚型[层次聚类](@article_id:640718)（agglomerative hierarchical clustering）的世界，一种强大的自下而上技术，它模仿了人类直观的分类过程：从最相似的项目开始，逐步构建越来越大的群组。它解决了揭示数据内在结构这一根本性挑战，不仅提供单一的划分，还提供了完整的关系“族谱”。

本文将引导您了解这一重要的数据科学方法。在第一章**原理与机制**中，我们将深入探讨核心[算法](@article_id:331821)，探索不同的“[连接方法](@article_id:640851)”如何塑造聚类过程，并学习解读最终的[树状图](@article_id:330496)。第二章**应用与跨学科联系**将展示该技术的卓越通用性，演示它如何被用于发现生物学中的分类、构建金融市场结构、组织人类知识，以及在广泛的科学和商业领域中发现时间序列数据的模式。

## 原理与机制

想象你是一位考古学家，刚刚出土了一批古代文物。它们都混杂在一个大箱子里。你会如何开始整理它们？你可能不会一开始就决定要分成三四个大类。相反，你可能会拿起两个看起来几乎一模一样的文物，把它们放在一起。然后，你可能会找到第三个与前两个非常相似的文物，并将其加入它们的组中。你不断重复这个过程，将单个物品和小组合并成越来越大的组，直到所有东西都分门别类，形成一个巨大的相关性族谱。

你刚才凭直觉所做的，就是**凝聚型[层次聚类](@article_id:640718)**。这是一种优美的、自下而上的发现数据结构的方法，也是科学家工具箱中最基本的工具之一。它不强迫我们预先选择群组的数量；相反，它向我们展示了所有可能性的完整层次结构，从每个项目自成一“簇”，到所有项目同属一个巨大的超级簇。

### 核心[算法](@article_id:331821)：分步组装

让我们把考古挖掘的过程具体化一些。假设我们是系统生物学家，正在研究一小[组蛋白](@article_id:375151)质，并且我们有办法衡量它们之间的“相异度”。这种相异度可以基于它们的氨基酸序列、形状，或者在我们的例子中，它们在细胞中的功能角色。我们可以将所有这些信息总结在一个**相异度矩阵**中，这只是一个列出每对蛋白质之间“距离”的表格。数值小意味着它们非常相似，数值大则意味着它们非常不同。

凝聚[算法](@article_id:331821)非常简单，并以循环方式进行：

1.  **找到最近的一对**：首先将每个蛋白质视为其自身的一个微小簇。遍历整个相异度矩阵，找到彼此最接近的两个簇——即相异度值最小的那一对。

2.  **合并它们**：将这两个簇融合成一个单一的新簇。

3.  **更新并重复**：现在是关键部分。我们有了一个新簇，需要更新我们的相异度矩阵。我们必须定义这个新的复合簇与所有其他现有簇之间的距离。完成后，我们回到第 1 步并重复此过程——找到新的最近对并合并它们。我们持续这个过程，直到只剩下一个包含我们所有蛋白质的簇。

让我们用一个真实的例子来追踪前两个步骤 [@problem_id:1452214]。假设我们对五个蛋白质（P1 到 P5）的相异度矩阵如下所示：

$$
\text{Dissimilarity Matrix } D = 
\begin{pmatrix}
  \text{P1}  \text{P2}  \text{P3}  \text{P4}  \text{P5} \\
\text{P1}  0  7  9  10  11 \\
\text{P2}  7  0  6  8  9 \\
\text{P3}  9  6  0  4  5 \\
\text{P4}  10  8  4  0  2 \\
\text{P5}  11  9  5  2  0
\end{pmatrix}
$$

观察矩阵，最小的非零值是 $2$，即 P4 和 P5 之间的距离。所以，我们的第一步是把它们合并成一个新簇 `{P4, P5}`。

现在有趣的问题来了：接下来会发生什么？我们还剩下四个簇：`{P1}`、`{P2}`、`{P3}` 和我们的新簇 `{P4, P5}`。为了找到下一次合并，我们需要一个规则来计算到 `{P4, P5}` 的距离。这就是[聚类](@article_id:330431)的“艺术”所在，通过一个称为**[连接方法](@article_id:640851)**（linkage method）的选择来实现。

### 合并的艺术：[连接方法](@article_id:640851)

我们选择用来定义簇间距离的规则，极大地塑造了最终的层次结构。这就像定义我们考古学家的性格——她是一位乐观主义者、悲观主义者，还是一位外交家？

#### 完全连接：悲观主义者的规则

假设我们的生物学家很谨慎。在考虑一个旧簇（比如 `{P3}`）到新簇 `{P4, P5}` 的距离时，她可能会将其定义为其成员之间*最大*的可能距离。这被称为**完全连接（complete linkage）**。只有当一个组的*所有*成员都与另一个组的*所有*成员接近时，你才会认为这两个组是接近的。从 `{P3}` 到 `{P4, P5}` 的距离将是：

$d(\{P3\}, \{P4, P5\}) = \max(d(P3, P4), d(P3, P5)) = \max(4, 5) = 5$

通过对所有其他簇应用此规则，我们得到一个新的、更小的距离矩阵。然后我们可以找到这个新矩阵中的[最小距离](@article_id:338312)，以决定第二次合并。在这种情况下，`{P3}` 和 `{P4, P5}` 之间 $5$ 的距离恰好是新的最小值，所以它们接下来被合并 [@problem_id:1452214]。

完全连接非常擅长发现紧凑、密集的球状簇。因为它很“悲观”，所以它非常不愿意将一个簇与一个遥远的点合并。这使得它在分离**离群点**方面特别有效。如果你有一个远离其他所有数据点的数据点，完全连接倾向于在过程的最后阶段，在一个非常高的相异度高度上，才将它合并，而在此之前一直将其保留为独立的簇 [@problem_id:3109639]。

#### 单一连接：乐观主义者的规则

如果我们的生物学家是位乐观主义者呢？她可能会将两个簇之间的距离定义为其成员之间*最小*的可能距离。这就是**单一连接（single linkage）**。只要每个簇中各有一个点彼此靠近，这两个簇就会被合并。

这种“最近邻”方法具有非常不同的特性。它不强制要求紧凑性。相反，它擅长发现细长的形状或链条。这个特性，即著名的**链式效应（chaining）**，可以是优点也可以是缺点，取决于你的目标。

例如，在生物学中，假设我们根据基因在不同实验中的活性模式进行聚类 [@problem_id:2379299]。单一连接法找到的链状簇可能不代表一个所有基因功能都相同的紧密群体。相反，它可能揭示了一个功能的*梯度*。基因 1 与基因 2 非常相似，基因 2 与基因 3 非常相似，但基因 1 和基因 3 可能根本不相似！这可能反映了一系列相关的生物过程级联，而不是单一的过程。在现实世界中，相似性并不总是可传递的。

这个简单的、乐观的规则与计算机科学中另一个著名的思想有着惊人的深刻联系：**[最小生成树](@article_id:326182)（Minimum Spanning Tree, MST）** [@problem_id:3228302]。MST 是连接一组城市所需的最便宜的电线网络。事实证明，单一连接聚类所做的合并序列与 Kruskal [算法](@article_id:331821)（一种构建 MST 的经典方法）所做的连接序列完全相同。这种美妙的统一揭示了看似简单的单一连接规则在底层执行着一项深刻的优化任务。

#### 平均连接与 Ward 方法：折衷者

在悲观主义者（完全连接）[和乐](@article_id:297502)观主义者（单一连接）之间，还存在其他方法。**平均连接（Average linkage）**扮演着外交家的角色，将簇间距离定义为其成员之间所有成对距离的平均值。它在两个极端之间取得了平衡，并且在实践中通常效果很好。

一个更复杂的方法是 **Ward 方法**。Ward 方法不仅仅着眼于距离，它像统计学家一样思考。在每一步，它都会问：“哪次合并会导致所有簇内总‘方差’的增量最小？”它总是选择能使合并后的簇尽可能紧凑的合并。这是一个非常强大且流行的方法，但了解其特性是件好事。通过模拟，我们可以看到 Ward 方法有产生大致相等大小簇的微妙偏好，就像父母试图在孩子之间平均分配玩具一样 [@problem_id:3114237]。

#### 一个警告：倒置之谜

人们可能会认为，随着我们合并簇，每次合并的相异度“高度”只能增加或保持不变。这对于单一连接、完全连接、平均连接和 Ward 方法是成立的，这会产生一个清晰的、嵌套的层次结构。然而，某些[连接方法](@article_id:640851)可能会打破这个规则！

考虑**[质心](@article_id:298800)连接（centroid linkage）**，其中两个簇之间的距离是它们[质心](@article_id:298800)（几何中心）之间的距离。可以构建这样一种情况：两个点 $A$ 和 $B$ 在某个距离处合并。它们的新[质心](@article_id:298800) $C$ 可能离第三个点 $D$ 非常近，以至于 $C$ 和 $D$ 之间的距离*小于* $A$ 和 $B$ 之间的原始距离。这会导致层次结构中出现**倒置（inversion）**，即后一次合并发生在更低的相异度高度上 [@problem_id:3129007]。这是一个有趣的怪癖，提醒我们要了解我们正在使用的工具，因为有些工具具有相当反直觉的行为。

### 解读玄机：[树状图](@article_id:330496)

整个过程的最终输出是一个称为**[树状图](@article_id:330496)（dendrogram）**的优美树形图。它是我们数据的族谱。底部的叶子是单个数据点。向上移动时，水平线显示了簇被合并的位置。该水平线在 y 轴上的高度代表发生合并时的相异度。

[树状图](@article_id:330496)是一个信息极其丰富的对象。它不仅仅给你一组簇；它向你展示了*所有*可能的簇集合，从 $n$ 个簇（每个点自成一簇）到 1 个簇（所有点在一起）。

### 一个关键问题：究竟需要多少个簇？

这种丰富性引出了一个至关重要的实际问题：层次结构中的哪个级别是“正确”的？我们的数据*真正*有多少个簇？没有唯一的魔法答案，但有强大的启发式方法来指导我们。

一般的方法是用一条水平线“切割”[树状图](@article_id:330496)。该线穿过的分支数量就是簇的数量 $k$。挑战在于找到最佳的切割高度。

#### 轮廓法

一种优雅的方法是**轮廓分数（silhouette score）** [@problem_id:3129027]。对于每个数据点，我们计算一个分数，衡量它在其当前簇中的满意度。如果该点非常接近其自身的簇成员（高内聚性），并且远离相邻簇中的点（高分离度），则该分数会很高。我们可以为数据集的每一次可能的切割（从 $k=2$ 到一个合理的上限）计算平均轮廓分数。最佳簇数 $k^{\star}$ 通常被选为产生最高平均轮廓分数的那个。这相当于数据点本身投出的信任票。

#### [肘部法则](@article_id:640642)

另一个流行的技术是**[肘部法则](@article_id:640642)（elbow method）** [@problem_id:3114246]。想象一下，当你减少簇的数量时，观察[树状图](@article_id:330496)的高度。起初，你合并的是非常相似的点，所以合并高度增长缓慢。但到某个点，你被迫合并两个非常不同、分离良好的簇。这将导致合并高度的急剧跳跃。这个急剧加速的点——合并高度与簇数关系图中的“肘部”——是数据中自然簇数的一个很好的候选。我们可以通过寻找合并[高度函数](@article_id:360564)离散二阶[导数](@article_id:318324)的最大值来从数学上找到这个肘部。

### 现实检验：这种结构是真实存在的吗？

我们有了漂亮的[树状图](@article_id:330496)和关于正确簇数的想法。但是我们怎么知道我们不是仅仅在随机噪声中找到了一个模式？我们如何验证我们的发现？这才是科学研究真正开始的地方。

#### 内部验证：稳定性

数据中真实的结构应该是**稳定**的。如果我们对数据进行轻微扰动，[聚类](@article_id:330431)结果不应发生剧烈变化。一种测试方法是使用**[自助法](@article_id:299286)（bootstrapping）**技术 [@problem_id:3109613]。我们可以通过从原始数据中（有放回地）抽样点来创建许多新的“复制”数据集。然后我们在每个复制数据集上运行我们的聚类。一个稳定的聚类是，在这些复制数据集中，相同的点倾向于一次又一次地出现在相同的簇中。我们甚至可以计算一个[数值稳定性](@article_id:306969)分数来量化这一点。

另一个内部检查是**共表型[相关系数](@article_id:307453)（cophenetic correlation）** [@problem_id:2804814]。这衡量了[树状图](@article_id:330496)中的距离在多大程度上忠实地代表了我们数据点之间的原始距离。高的相关性意味着我们的层次结构是[数据结构](@article_id:325845)的“诚实”表示。

#### 外部验证：地面实况

有时，我们很幸运地拥有一些外部的“地面实况”。在生物学中，我们可能有一份已知属于某个特定通路的基因列表。然后我们可以使用统计检验，如**[超几何检验](@article_id:336042)（hypergeometric test）**，来提问：“我们发现的簇与这个已知通路之间的重叠是否具有[统计显著性](@article_id:307969)，还是可能仅仅是由于偶然？” [@problem_id:2804814]。当我们执行数千次这样的检验时（针对许多簇和许多通路），我们必须小心地使用像 [Benjamini-Hochberg](@article_id:333588) 程序这样的方法来校正[多重检验问题](@article_id:344848)，以避免被随机性所愚弄。

通过结合这些方法——构建层次结构、选择适当的切[割点](@article_id:641740)、并从内部和外部验证结果——我们可以从一个简单的距离表，走向一个关于世界隐藏结构的深刻且可辩护的假设。

