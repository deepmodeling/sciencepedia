## 应用与跨学科联系

在上一章中，我们拆解了[可信平台模块](@entry_id:756204)的内部构造。我们看到了它的齿轮和弹簧：作为加密哈希单行道的平台配置寄存器 (PCR)，可以像瓶中信一样被封装起来的密钥，以及允许芯片为系统代言的证明过程。但一个钟表的构造只有在它能报时的时候才显得有趣。所以现在，我们不禁要问：我们能用这个奇妙的小机器*做*什么？它能帮助我们解决哪些计算领域的巨大挑战？

我们即将踏上一段旅程，从一台笔记本电脑的神圣领地开始，向外扩展到广阔、共享的云宇宙。你将看到，从硬件[信任根](@entry_id:754420)这个简单而优雅的原则出发，我们可以层层构建安全防护，创造出强度和美感都令人惊叹的结构。[TPM](@entry_id:170576) 不仅仅是一个组件，它是一个基石。

### 内部堡垒：保护单台机器

让我们从家里开始，从你面前的电脑开始。TPM 如何保护*你*的机器上的*你*的数据？

也许最常见和最强大的应用是加强全盘加密 (FDE)。你已经加密了你的硬盘，这是极好的第一步。但是你把密钥放在哪里？如果它只是从你的密码派生而来，那么拿到你笔记本电脑的攻击者可能会花上数周时间来猜测它。一个更好的主意是让 TPM 来释放解密密钥。我们可以将密钥“封装”到一组特定的 PCR 值上——这是一个已知的、良好启动过程的加密指纹。如果攻击者试图启动一个不同的[操作系统](@entry_id:752937)来绕过安全措施，PCR 值将不匹配，TPM 会干脆拒绝释放密钥。你的数据仍然是一个锁着的盒子。

但这个优雅的解决方案立刻带来了一个悖论。当你安装合法的软件更新时会发生什么？你的内核变了，你的[引导加载程序](@entry_id:746922)可能也变了——正是这些被度量的组件发生了变化！新的 PCR 值将不同，而你的 TPM，出于其坚定不移的忠诚，会将*你*自己锁在电脑外面。这就是更新悖论。[TPM](@entry_id:170576) 的早期应用曾为此苦恼，但现代 [TPM](@entry_id:170576) 有一个非常灵活的解决方案。我们不再将密钥封装到一组单一、僵化的 PCR 值上，而是可以将其封装到一个*策略*上。这个策略可以被设计成可由可信的权威机构（如[操作系统](@entry_id:752937)供应商）更新，从而允许它预先授权下一次有效更新的 PCR 值。这样，安全性和可用性终于可以共存；你的系统可以安全地演进，而不会导致灾难性的锁定 [@problem_id:3686042]。

TPM 还可以作为我们最个人化秘密的保险库。考虑[生物特征](@entry_id:148777)认证——你的指纹。将你的指纹模板，即使是用密码加密后，存储在常规[文件系统](@entry_id:749324)中也是有风险的。假以时日，一个窃取了你的设备或侵入了你的云备份的对手可以发动离线攻击来猜测密码并暴露模板。一旦泄露，就永远泄露了。通过将此模板作为不可迁移[数据存储](@entry_id:141659)在 [TPM](@entry_id:170576) 内部，游戏规则完全改变了。拥有物理设备的攻击者将不得不对芯片本身发起复杂且昂贵的硬件攻击，这远超大多数人的能力。量化[风险分析](@entry_id:140624)表明，这不仅仅是一个微小的改进；它可以将你的[生物特征](@entry_id:148777)数据被泄露的概率降低几个[数量级](@entry_id:264888) [@problem_id:3689529]。

堡垒还必须保护其最短暂的状态。当计算机休眠时，它会将其内存的完整快照写入磁盘。攻击者可能会用一个你登录时期的旧文件替换这个文件，诱使机器恢复到一个脆弱的状态。这是一种“回滚攻击”。在这里，TPM 的另一个巧妙特性发挥了作用：单调计数器。这是 [TPM](@entry_id:170576) 内部一个特殊的、非易失性的计数器，只能递增。把它想象成一个只能向前转的棘轮。通过将这个计数器的当前值包含在用于封装休眠密钥的策略中，我们就可以挫败回滚攻击。一个旧的休眠文件将与一个旧的计数器值绑定，[TPM](@entry_id:170576) 将拒绝释放密钥，因为它的内部计数器已经超过了那个值。系统被迫总是向前迈进 [@problem_id:3631408]。

同样，交换分区，即[操作系统](@entry_id:752937)临时换出内存的地方，也是秘密的宝库。对其进行加密至关重要。但我们想要*前向保密性*：如果攻击者从一次会话中攻破了交换密钥（也许是通过一种在断电后瞬间读取内存数据的复杂“冷启动攻击”），他们不应该能够解密过去或未来会话的数据。TPM 通过保护一个长期的根密钥来提供帮助，但真正的魔力来自于每次启动时，使用根密钥和一点真正的随机性来派生一个全新的、临时的交换密钥。这个高熵的随机数确保了每个会话的密钥都是独一无二且不可预测的，从而切断了它们之间的联系 [@problem_id:3688005]。

### 扩张的宇宙：互联世界中的信任

到目前为止，我们已经将 TPM 视为一个孤独的哨兵。但其最深远的应用出现在系统之间需要相互信任的时候。一台计算机如何通过一个不受信任的网络向另一台计算机证明其完整性？答案是[远程证明](@entry_id:754241)。

想象一下，你的计算机感染了[内核模式](@entry_id:755664)的 rootkit。这是最糟糕的一种恶意软件；它以[最高权](@entry_id:202808)限运行，并且可以向[操作系统](@entry_id:752937)谎报自己的存在。机器无法再信任自己。但它无法对它的 TPM 说谎。在[度量启动](@entry_id:751820)期间，TPM 记录了内核的哈希值，包括 rootkit。通过[远程证明](@entry_id:754241)，远程服务器可以对这台机器发起质询。TPM 提供其 PCR 的签名“引用”，这是一份关于*实际*运行了什么代码的不可伪造的声明。服务器可以将其与已知良好值的列表进行核对，并立即检测到感染。这说明了一个关键的区别：[安全启动](@entry_id:754616)*阻止*坏代码运行，而[度量启动](@entry_id:751820)和证明*检测*它。这是了解大量机器健康状况的关键工具。它也教会我们谦卑；这种默认形式的证明在发现启动时威胁方面非常出色，但往往对用户应用程序在运行时发生的恶作剧视而不见 [@problem_id:3673360]。

这种运行时度量的能力延伸到最棘手的现代威胁之一：供应链攻击。如果一个受信任的硬件供应商的签名密钥被盗，并且对手开始分发带有“有效”签名的恶意设备固件，那该怎么办？签名现在已毫无意义。在这里，TPM 与另一个名为输入/输出内存管理单元 ([IOMMU](@entry_id:750812)) 的硬件协同工作，提供了一条前进的道路。当一个新设备被热插拔时，[操作系统](@entry_id:752937)可以忽略签名。取而代之的是，它计算固件*实际内容*的哈希值，将此哈希扩展到一个动态 PCR 中，并使用 [IOMMU](@entry_id:750812) 来控制该设备访问[系统内存](@entry_id:188091)的能力。只有当 [TPM](@entry_id:170576) 能够证明——无论是通过向服务器进行证明，还是通过解封一个本地能力令牌——固件的哈希值与已知的良好允许列表匹配时，IOMMU 才会“释放”该设备。这是硬件特性协同工作的优美交响乐，共同抵御被破坏的[信任链](@entry_id:747264) [@problem_id:3687967]。

这些例子迫使我们更深入地思考一个核心安全概念：[可信计算基 (TCB)](@entry_id:756202)。TCB 是我们*必须*信任以执行我们安全策略的所有硬件和软件组件的集合。像具有无限制直接内存访问 (DMA) 的蜂窝基带处理器这样的组件绝对必须在 TCB 中，因为它可以读取或写入任何东西。它的代码必须是完美的。然而，[IOMMU](@entry_id:750812) 充当硬件防火墙，通过限制外围设备能做什么来帮助我们*缩小* TCB。因此，TPM 是我们用来度量和证明我们 TCB *内部*剩余组件完整性的工具 [@problem_id:3679565]。

### 云之星云：虚拟化信任

信任的最后前沿是云。一台物理服务器可能为不同的客户托管数百个虚拟机 (VM)。一个租户如何能相信他们的 VM，一个纯粹的软件构造，正在安全运行，并且没有被云提供商或邻近的 VM 监视？解决方案是虚拟化 TPM 本身。

虚拟 TPM (vTPM) 是一个由[虚拟机](@entry_id:756518)监控程序 (hypervisor) 管理的软件程序，它为每个 VM 模拟一个真实的 [TPM](@entry_id:170576)。这是一种远比简单地将唯一的物理 [TPM](@entry_id:170576) 直通给一个幸运的 VM 更好的方法，因为那将允许该 VM 发出全局命令（如 `TPM_Clear`），从而破坏主机本身！v[TPM](@entry_id:170576) 提供了隔离，但它带来了一个必要的权衡：客户 VM 必须信任 hypervisor 是一个忠实且安全的模拟器 [@problem_id:3648952]。

有了这个 v[TPM](@entry_id:170576)，我们就可以为虚拟机构建一个完整的、端到端的证明流程。它的工作方式如下：物理主机执行[度量启动](@entry_id:751820)，将其自身的完整性锚定在其硬件 TPM 中。然后，hypervisor 启动一个带有 v[TPM](@entry_id:170576) 的 VM，vTPM 自身的加密身份锚定在物理 TPM 中。VM 本身执行[度量启动](@entry_id:751820)，将其虚拟固件、[引导加载程序](@entry_id:746922)和内核的哈希值记录到其 v[TPM](@entry_id:170576) 的 PCR 中。现在，租户的远程服务器可以发出一个质询。VM 使用其 v[TPM](@entry_id:170576) 生成其启动状态的签名引用。这个引用是一个加密证明，可以一直追溯验证到主机机器的硅片。验证者可以确认 VM 的软件是纯净的，该 vTPM 属于他们特定的 VM 实例，并且它运行在真实的硬件上。只有到那时，它才会向 VM 释放秘密，如磁盘加密密钥。这就是支撑着新兴的[机密计算](@entry_id:747674)领域的魔力，使我们能够在公共云中运行敏感的工作负载，并获得可验证的隐私和完整性保证 [@problem_id:3689858]。

### 优雅的统一

我们的旅程完成了。我们从一个单一、不起眼的芯片开始。我们用它为我们的个人数据建造了一座堡垒，抵御更新、密码猜测者，甚至[时间旅行](@entry_id:188377)攻击。然后，我们将目光转向外部，用它作为普适的见证者来检测恶意软件和驯服被破坏的供应链。最后，我们学会了虚拟化它，在云中创造出整个由可信机器组成的星云。

贯穿始终，核心思想保持简单和统一：一个不可动摇的根，一个不可破坏的度量链，以及通过密码学说出真相的能力。这证明了一个好想法的力量，即从如此简单的一组原语中，可以构建出具有如此巨大实际重要性和智识美感的结构。