## 引言
在理想的科学世界中，实验是完美平衡的，每个变量的效应都可以独立测量。然而，现实世界，尤其是在生物学和医学等领域，往往是混乱且不平衡的。这种“不平衡”会造成混杂，即不同因子的效应纠缠在一起，使其难以分离和分析。因此，我们面临的挑战是如何对数据中的变异进行划分，以准确评估每个因子的贡献。这个问题催生了不同的统计策略，其中最著名的是 I 型、II 型和 III 型平方和，每种类型都代表了一种用于厘清混杂效应的独特理念。本文将揭开这些方法的神秘面纱，并特别关注稳健且被广泛使用的 III 型方法。

在接下来的章节中，我们将从这些方法的理论基础走向它们的实际应用。第一章“原理与机制”将对比平衡设计的简洁性与[不平衡数据](@entry_id:177545)的复杂性，解释为什么需要不同类型的平方和，以及每种类型（特别是 III 型）旨在检验何种具体假设。在此之后，“应用与跨学科联系”一章将阐明，在从调整协变量的临床试验到处理不完整数据的遗传学研究等不同领域中，审慎选择 III 型平方和如何为关键问题提供清晰的答案。

## 原理与机制

想象一下，您正在尝试理解一个复杂的物理系统。您有几个可以调节的旋钮——比如温度和压力——并且您想知道它们各自如何影响某个结果，例如气体的体积。在一个完美设计的实验中，您将能够以相等的次数测试温度和压力的每一种组合。这是一个完美对称和平衡的世界。在统计学中，这被称为**平衡设计**，是实验主义者的梦想。

### 物理学家的梦想：一个平衡的世界

在平衡设计中，您所研究的因子——温度和压力——是“[解耦](@entry_id:160890)”的，或者用几何术语来说，是**正交的**。可以把它们想象成两个相互垂直的坐标轴，就像图上的 $x$ 轴和 $y$ 轴。改变温度（沿 x 轴移动）的效应与改变压力（沿 y 轴移动）的效应完全独立。要找出温度有多重要，您只需测量它的效应。要找出压力有多重要，您只需测量它的效应。您提出这些问题的顺序不会改变答案。

这种优美的简洁性是正交性的直接结果。用[线性模型](@entry_id:178302)的语言来说，实验中不同因子对应的[列空间](@entry_id:156444)是相互正交的 [@problem_id:4848234]。因此，结果中的总变异可以被清晰明确地划分为几个部分，每个因子占一部分，再加上一些随机误差。在这个理想世界里，计算“平方和”——衡量一个因子所解释的变异——的各种方法都会给出完全相同的答案。无论您使用 I 型、II 型还是 III 型平方和，结果都是一样的，因为“温度的效应是什么？”这个问题只有一个简单的答案。

### 生物学家的现实：[不平衡数据](@entry_id:177545)的纠缠

现在，让我们离开这个纯净的世界，走进现实的混乱之中，尤其是在生物学和医学等领域。想象一下，您正在研究一种新药的有效性。您的因子可能是药物本身（与安慰剂对比）和患者的性别。您的目标是进行平衡设计，即药物组和安慰剂组中的男性和女性人数相等。但现实介入了。更多的女性自愿参加研究，或者安慰剂组中更多的男性中途退出。最终您得到了一个**不平衡设计** [@problem_id:4783152]。

一旦发生这种情况，优雅的正交性就消失了。您的因子，药物和性别，不再独立；它们变得纠缠不清或**混杂**。例如，如果您恰好在药物组中有更多的女性，您怎么知道好的结果是由于药物，还是因为女性普遍反应更好？这些效应混合在了一起。

我们相互垂直的坐标轴现在变得倾斜了。询问“药物的效应”就像在有多个纠缠不清的光源时，询问一根杆子投下影子的长度。答案取决于您在测量时保留了哪些其他光源。这个简单明确的问题已经分裂成几个可能的问题，这就是我们需要不同类型平方和的原因。它们代表了在一个纠缠不清的非正交世界中提出问题的不同理念。

### 厘清效应的三种理念

当因子发生混杂时，我们必须非常精确地定义我们所要提出的问题。统计学家已经发展出三种主要策略，体现在 I 型、II 型和 III 型平方和中。

#### I 型：序贯的讲述者

**I 型平方和**，也称为**序贯**平方和，采用一种分层的方法。作为科学家，您必须首先为您的因子确定一个重要性顺序。例如，您可能决定首先考虑性别的效应，*然后*再问药物解释了什么*额外*的变异。每个因子的平方和是其边际贡献，即在序列中位于它之前的因子已被考虑的情况下。

问题在于，答案完全取决于您选择的顺序。如果您先考虑药物再加入性别，归因于每个因子的变异将不同于您先考虑性别再加入药物的情况。要明白这不仅仅是一个理论上的好奇心，可以考虑一个包含两个因子 $A$ 和 $B$ 的简单不平衡实验。直接计算 [@problem_id:4965582] 表明，因子 $B$ 在最先进入模型时的平方和是 $SS_{I}(B \text{ first}) = \frac{121}{6}$，但当它在因子 $A$ 之后进入时，其贡献仅为 $SS_{I}(B \text{ second}) = \frac{25}{3}$。差值 $\Delta = \frac{71}{6}$ 是 $A$ 和 $B$ 之间混杂效应的一个具体度量。这种对顺序的依赖性使得 I 型平方和仅在有充分的、预先证明的科学理由支持特定层次结构时才适用 [@problem_id:4783152]。

#### II 型：谨慎的层级主义者

**II 型平方和**体现了**边际性原则**。该原则指出，如果一个更复杂的[交互作用](@entry_id:164533)包含了某个主效应，那么谈论这个主效应就没有太大意义。因此，II 型平方和问的是：在考虑了*所有其他主效应*（如性别）之后，但在忽略任何[交互作用](@entry_id:164533)的情况下，一个主效应（比如我们的药物）的贡献是什么？[@problem_id:4855812]。它是一个因子在给定所有其他处于相同复杂程度的因子的情况下的平方和。

对于主效应而言，这种方法是顺序不变的，并且当您确信系统中没有显著的[交互作用](@entry_id:164533)时，它是首选方法。在一个可加性的世界里，它为每个因子的主效应提供了一个清晰的检验。

#### III 型：持怀疑态度的边际主义者

这就引出了我们的主要话题：**III 型平方和**。这是这些理念中最具怀疑精神，并且在许多方面也是最稳健的一种。它提出了最严格的问题：在*完整模型中的所有其他项*——所有其他主效应和所有[交互作用](@entry_id:164533)——都已被考虑进去之后，一个因子的独特贡献是什么？[@problem-id:4893842]。它是一个因子被当作最后一个添加到模型中时的平方和。

这种“最后进入”的方法有一个强大的优势：它是顺序不变的，并且即使在存在不平衡和[交互作用](@entry_id:164533)的情况下，它也能为复杂模型中的每一个项提供一个明确定义的检验。这就是为什么它在许多统计软件中是默认设置。但伴随这种强大功能而来的是一项重大的责任，即需要精确理解它到底在回答什么问题。

### 真正的问题是什么？数字背后的假设

当您运行一个统计检验时，您会得到一个 $p$ 值。但这个 $p$ 值是针对一个非常具体的问题（原假设）的答案。如果您不理解这个问题，这个答案就毫无用处。

在平衡设计中，问题很简单：“这个因子的不同水平是否具有不同的效应？”但在有[交互作用](@entry_id:164533)的不平衡设计中，针对主效应的 III 型检验回答的是一个远为微妙的问题。它检验的是**未加权边际均值**是否相等 [@problem_id:1965144]。

让我们来详细解释一下。想象一下我们正在跨不同性别（因子 B）测试我们的药物（因子 A），并且我们加入了一个交互项，因为我们怀疑药物可能在男性和女性中效果不同。针对药物“主效应”的 III 型检验并*不*检验药物是否有效应。相反，它检验的是药物的*平均*效应，即在男性和女性中以同等权重进行平均后的效应，是否为零 [@problem-ax_id:4855842]。

对于一个想要了解总体人口影响的决策者来说，这可能是一个有用的问题。但对于临床医生来说，这可能具有危险的误导性。一种药物完全有可能对男性有很强的积极作用，而对女性有很强的负面作用。平均效应可能恰好为零，导致 III 型主效应不显著，从而掩盖了关键的、具有临床意义的[交互作用](@entry_id:164533)。一个显著的[交互作用](@entry_id:164533)应始终让您停下来，质疑主效应检验的相关性。III 型检验在数学上是有效的，但其解释需要科学智慧。

### 当数据有空缺时：空单元格的挑战

现实世界可能更加混乱。有时，某些因子的组合是不可能或不道德去测试的。在一项针对不同肾病分期患者的新药研究中，给病情最严重的患者使用安慰剂可能是不道德的 [@problem_id:4855806]。这在我们的设计中产生了一个**空单元格**——一个我们没有任何观测值的组合。

这带来了一个深刻的问题。针对药物主效应的 III 型假设要求在所有肾病分期中进行平均。但是，如果您没有“安慰剂/严重疾病”组的数据，您如何能将它包含在那个平均值中呢？那个单元格的均值 $\mu_{ij}$ 是不可知的，或**不可估**的。突然之间，我们关于边际均值的优美、明确的假设崩溃了。我们无法检验它，因为它的一部分从根本上是不可知的。

### III 型平方和的静默智慧

那么会发生什么呢？计算机会崩溃吗？整个分析会失败吗？不会。而这正是 III 型方法的静默智慧展现之处。

在表面之下，这些检验建立在线性代数的优美几何学之上。您想要检验的假设可以被看作高维空间中的一个向量。您拥有的数据定义了一个“可知子空间”——即您*可以*回答的所有问题的空间。当您拥有一个完整的数据集时，您的假设向量完全位于这个可知子空间之内。

但是当您有一个空单元格时，您的假设向量——那个关于未加权边际均值的向量——会伸出可知子空间。它的一部分位于黑暗中，位于不可估的子空间里 [@problem_id:4855806]。您无法检验完整的假设。

III 型程序并不会放弃。它做了一件非常聪明的事情：它在外科手术般地将假设[向量投影](@entry_id:147046)到可知子空间上。它找到了原始问题在可用数据下完全可以回答的那个“影子”，并检验那个影子假设 [@problem_id:4963592]。它会自动构建一个新的假设 $H_0: L\boldsymbol{\beta}=0$，其中 $L$ 的行保证是可估的。

它回答了与您最初想问的问题最接近的那个可能的问题。检验的自由度会自动调整，以匹配这个新的、可回答问题的维度。这是数学稳健性的深刻体现。该方法适应数据的局限性，以挽救一个有意义的、有效的检验。正是在这种弹性中，在这种在科学数据的纠缠和不完整现实中寻找清晰和结构的能力中，我们找到了 III 型平方和真正的美和力量。

