## 引言
在事件发生时间结果的研究（即生存分析）中，Cox [比例风险模型](@entry_id:171806)是核心基石。它使研究人员能够优雅地估计各种因素（如新疗法或环境暴露）对事件发生风险的影响，而无需了解该风险随时间变化的潜在形态。然而，这种强大功能建立在一个关键基础之上：比例风险 (proportional hazards, PH) 假定。该假定认为，任何给定因素的效应在整个随访期间保持不变。这就提出了一个至关重要的问题：如果效应不是恒定的怎么办？如果药物的益处逐渐减弱，或者风险因素的危害性逐渐增强，又该如何？为了建立可靠的模型，我们需要一种方法来检验这一假定。

本文将介绍 Schoenfeld 残差，这是一种为解决上述问题而设计的强大诊断方法。通过在每个事件发生时刻审视数据中的“意外”，这些残差提供了一个窗口，让我们得以观察效应是真正保持稳定，还是随时间动态变化。首先，在“原理与机制”一节中，我们将解析 Schoenfeld 残差的计算和解释方法，探讨其数学基础及其在分析师诊断工具箱中的位置。随后，在“应用与跨学科联系”一节中，我们将通过医学和公共卫生领域的真实案例，了解这一统计工具如何从简单的检验转变为推动重大科学发现的载体，揭示效应在时间长河中如何演变。

## 原理与机制

### 模型的重大妥协

想象一下，你正在试图理解生存状况，无论是患者接受新疗法后的寿命、机器零件失效前的使用时间，还是初创公司被收购前的存续时长。生存分析领域充满了此类问题。我们拥有的最优雅、最强大的工具之一就是 **Cox [比例风险模型](@entry_id:171806)**。其精妙之处在于一种巧妙的关注点分离。它认为，个体在任何特定时刻面临的风险（或称**风险率**，hazard）可以分为两部分：一个随时间变化的普遍潜在风险，称为**基线风险**（baseline hazard）；以及一个取决于个体特定特征（如年龄、治疗组或基因构成）的个人风险因素。

该模型形式如下：
$$
h(t \mid X) = h_0(t) \exp(X\beta)
$$
此处，$h(t \mid X)$ 是具有特征 $X$ 的个体在时间 $t$ 的风险。$h_0(t)$ 项是基线风险，这是一个我们甚至不试图去猜测其具体形式的、关于时间的神秘函数。$\exp(X\beta)$ 项是**相对风险**（relative hazard），它是一个乘数，根据个体的协变量 $X$ 及其[相关系数](@entry_id:147037) $\beta$ 来调高或调低基线风险。

这是一种绝妙的简化。我们可以在无需了解风险随时间变化的潜在形态（$h_0(t)$）的情况下，估计出治疗的效应（$\beta$）。但这种强大功能源于一个重大的妥协，一个我们必须做出的关键假定，即**比例风险 (PH) 假定**。[@problem_id:4744972] 它指出，任何两个个体之间的风险比率在时间上是恒定的。

想象两名马拉松选手。一人穿着新型轻便跑鞋（一个有益的协变量），另一人穿着标准跑鞋。PH 假定意味着，轻便跑鞋带来的优势在 1 英里处和在 25 英里处是相同的。他们“失败”（即退赛）的风险比率是恒定的。但这现实吗？如果轻便跑鞋在短距离冲刺时表现出色，但在比赛[后期](@entry_id:165003)却分崩离析呢？那么这种优势就不是恒定的，它会随时间变化。[比例风险](@entry_id:166780)假定就遭到了违反。因此，一个关键问题出现了：我们如何能通过数据来判断这种效应恒定的假定是否成立？

### “意外”的剖析

为了检验我们的模型，我们可以审视它的错误，或者更准确地说，是它的“意外”。在统计学中，我们称之为**残差**（residuals），通常是 $\text{观测值} - \text{期望值}$ 的度量。但在这里，“观测值”和“[期望值](@entry_id:150961)”意味着什么？关键的洞见在于关注那些最重要的时刻：事件实际发生的时刻。

想象我们正处于一个事件发生时间点，比如 $t=10$ 个月，我们研究中的一位患者 Jane 在此时心脏病发作。在这一确切时刻，还有一群其他患者也仍在研究中，并且同样“处于风险中”，可能发生心脏病。这个群体被称为**风险集**（risk set）。[@problem_id:4991496]

现在我们可以定义我们的“意外”了。
*   **观测值**很简单：它就是实际发生事件的那个人的特征。例如，如果我们研究的是年龄的影响，观测值就是 Jane 的年龄。
*   **[期望值](@entry_id:150961)**是巧妙之处。它是我们根据模型所期望的、在这一刻失败的那个人的该特征的“原型”值。我们将其计算为风险集中所有人该特征的加权平均值。权重是什么呢？就是模型自己对谁最有可能失败的预测——即他们的相对风险 $\exp(X\hat{\beta})$。[@problem_id:4982837]

这给了我们一种特殊的残差，一种以其发明者 David Schoenfeld 命名的逐时诊断工具。在特定事件时间点上，针对特定协变量的 **Schoenfeld 残差**是：

$$
r_i = X_{(i)} - \frac{\sum_{j \in R(t_{(i)})} X_j \exp(X_j \hat{\beta})}{\sum_{j \in R(t_{(i)})} \exp(X_j \hat{\beta})}
$$

其中，$X_{(i)}$ 是在时间 $t_{(i)}$ 失败的个体的协变量，第二项是在同一时刻该协变量在风险集内的加权平均值。

### Schoenfeld 残差的精妙之处

Schoenfeld 残差的美妙之处在于其构造。它是一个“局部”度量，仅在事件发生的离散时刻计算。这与其他残差（如**鞅残差**）形成对比，后者是每个个体在整个随访期内模型失拟的累积汇总。Schoenfeld 残差就像一名侦探，在每个事件现场调查独特的环境，而不仅仅是在研究结束时为每个人统计一个总结。这种局部关注使其对检测随时间变化的效应尤为敏感。[@problem_id:4776391]

更重要的是，这种残差并非凭空创造。它直接源于拟合 Cox 模型本身所用的数学方法。我们刚才定义的量，正是一个单一事件对**得分函数**（score function）的贡献——即我们设为零以求得系数最佳估计值 $\hat{\beta}$ 的对数[偏似然](@entry_id:165240)的导数。[@problem_id:4991496] [@problem_id:4990757] 这意味着，在[模型拟合](@entry_id:265652)完成后，任何给定协变量的所有 Schoenfeld 残差之和，根据其构造，必定为零。“意外”在平均意义上相互抵消了。这种深刻的联系揭示了[模型拟合](@entry_id:265652)与[模型诊断](@entry_id:136895)之间的深层统一。

### 从噪声中发现模式

那么，这如何帮助我们检验[比例风险](@entry_id:166780)假定呢？

如果该假定成立——也就是说，如果我们协变量的效应确实随时间恒定——那么 Schoenfeld 残差所捕捉到的“意外”应该是随机的。将某一协变量的残差对时间作图，应呈现为一团围绕零点散布的、没有方向性的点云。[@problem_id:4920592]

但如果假定被违反了呢？让我们回到跑步者的例子。假设高科技跑鞋（$Z=1$）在早期提供了很大的保护作用，但这种益处随时间逐渐消失。
*   **比赛早期：** 效应很强。如果一个穿*着*特制鞋的跑者退赛，这是一个大大的意外。观测值（$Z=1$）将与风险集平均值（该值会很低，因为模型期望主要是穿普通鞋的跑者失败）大不相同。这将产生一个非零残差。
*   **比赛后期：** 效应已经消失。鞋子不那么重要了。现在，当一个穿着特制鞋的人退赛时，这并不令人意外。观测值（$Z=1$）将更接近风险集平均值，残差也将接近于零。

当我们把残差对时间作图时，这种变化的意外模式将形成一种**系统性趋势**。协变量残差的正向趋势表明其效应（对数风险比）随时间增加，而负向趋势则表明其效应随时间减小。例如，若发现某新疗法的残差存在显著的正向趋势，可能意味着其初始的保护效应（风险比小于1）随时间减弱，风险比逐渐趋向于 1（无效应）甚至大于 1（有害效应）。[@problem_id:4968246]

这种可视化检验可以被形式化。**Grambsch-Therneau 检验**正是这样做的：它对（缩放后的）Schoenfeld 残差与时间函数（如 $t$ 或 $\log(t)$）之间的趋势进行统计检验。它本质上在问：“残差对时间的散点图中是否存在统计上显著的斜率？”一个显著的结果为该特定协变量违反[比例风险](@entry_id:166780)假定提供了正式证据。[@problem_id:4906427]

### 在诊断工具箱中的一席之地

Schoenfeld 残差是一个巧妙的工具，但它只是众多工具之一。对于简单的二元分组，使用**log-minus-log 生存图**进行图形检查可能很有洞察力，但当事件数量较少时可能不稳定，并且不适用于连续协变量。[@problem_id:4555915]

此外，在我们担心效应是否随时间恒定（比例风险）之前，我们应首先确保我们对效应的建模方式是正确的。例如，年龄的效应是线性的，还是二次的？这是一个**函数形式**（functional form）的问题。错误指定函数形式可能会造成非比例风险的假象。因此，明智的分析师会遵循一个两步程序：
1.  首先，使用**[鞅](@entry_id:267779)残差**对协变量值的图来检查连续协变量的函数形式。如有必要，调整模型（例如，使用样条或变换）。
2.  *然后*，在这个改进后的模型上，使用 Schoenfeld 残差来检验[比例风险](@entry_id:166780)假定。[@problem_id:4555951]

这种谨慎的、分步骤的方法使我们能够与数据进行清晰而细致的对话。我们不只是问一个因素*是否*重要，而是问它*如何*重要。Schoenfeld 残差提供了一个强大的镜头，通过它我们可以观察风险的动态，揭示效应在时间长河中展现出的复杂方式。

