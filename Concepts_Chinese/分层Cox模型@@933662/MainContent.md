## 引言
在生存分析领域，Cox等[比例风险模型](@entry_id:171806)是一块基石，为影响事件发生时间结果的因素提供了深刻的见解。然而，它的优势建立在一个严格的基础之上：等[比例风险假设](@entry_id:163597)，该假设规定协变量的相对效应必须随时间保持恒定。在现实世界的数据中，这一假设常常被违反，导致有偏的结果和错误的结论。当一个关键变量（如临床中心或患者亚组）表现出复杂的、随时间变化的效应时，标准模型便会失效。

本文通过对分层Cox模型进行全面探索，来填补这一关键的知识空白。分层[Cox模型](@entry_id:164053)是解决非等比例风险问题的一种优雅而稳健的方案。我们将深入其理论基础，剖析它如何巧妙地回避了直接对非等比例变量建模的需求。本文的结构旨在提供一条从理论到实践的清晰路径。在“原理与机制”部分，我们将探讨分层如何运作、其通过[偏似然](@entry_id:165240)的估计过程以及所涉及的关键权衡。随后，在“应用与跨学科联系”部分，我们将遍览其多样化的现实世界用途，从分析随机试验和观察性研究，到支持[联邦学习](@entry_id:637118)中前沿的、保护隐私的研究。

## 原理与机制

要真正领会分层[Cox模型](@entry_id:164053)的巧妙之处，我们首先必须了解其前身——标准Cox等[比例风险模型](@entry_id:171806)——那个优雅而又严苛的世界。想象一下，你正在研究一种新药对患者生存率的影响。[Cox模型](@entry_id:164053)就像一个精密的秒表；它不仅记录最终事件发生的时间，还测量在任何给定时刻发生该事件的瞬时*风险*——即风险率（hazard）。其核心支柱，即**等[比例风险](@entry_id:166780)**假设，是一个表述极为简洁优美的声明：如果药物今天使患者发生事件的风险增加一倍，那么它在明天、下周和明年也必须使风险增加一倍。接受治疗者与未接受治疗者之间的风险比率随时间保持不变。

这个假设赋予了模型巨大的威力。但当自然界拒绝如此整齐划一时，会发生什么呢？

### 等比例性的束缚

考虑一个在几家不同医院进行的关于我们新药的真实世界临床试验。医院A可能是一个高流量的城市中心，治疗的重症患者初始风险非常高，但如果他们能撑过最初几周，风险就会下降。医院B是一家郊区机构，其患者病情可能不那么紧急，风险起初较低，但随着慢性病的恶化而随时间稳步上升。如果我们为这两家医院的基线患者人群绘制生存曲线，它们甚至可能相互交叉。这是一个教科书式的**非等[比例风险](@entry_id:166780)**案例。在医院A与在医院B的“效应”不是一个简单的、恒定的乘数。[@problem_id:4550973]

如果我们忽略这一点会怎样？一个普遍的本能反应可能是简单地将“医院”作为一个变量加入标准的Cox模型中。这是一个致命的错误。该模型受其等[比例风险假设](@entry_id:163597)的约束，会试图将“医院”这个复杂的、随时间变化的效应强行压缩成一个单一的、恒定的数字——例如，得出结论“医院B的患者风险始终是医院A患者的1.5倍”。这纯属虚构，歪曲了事实。更糟糕的是，如果患者去的医院也与他们接受的治疗或其基础健康状况相关，这种错误设定会产生涟漪效应，扭曲我们关心的药物效应的估计值。这是一个典型的混杂案例，即一个建模不当的变量使我们的结果产生偏倚。[@problem_id:4961478] [@problem_id:5228283]

### 两种模型的故事：蛮力法与巧妙回避

将非等比例变量强行塞入等比例模型的蛮力方法是行不通的。这个问题需要一个更复杂的工具。这就引出了分层这个绝妙的构想。分层Cox模型没有试图去精确建模医院那种混乱的、非等比例的效应，而是采取了一种优雅的回避策略：它决定完全不去建模这个效应。

这个逻辑类似于一位物理学家在不同行星上研究像[引力](@entry_id:189550)这样的普适定律。他们可能不知道每个行星大气或地质的复杂细节，但他们可以假设[引力](@entry_id:189550)的[平方反比定律](@entry_id:170450)在每个行星的*局部环境内*的表现是相同的。分层对我们的数据做的也是同样的事情。

### 世界中的世界：分层的宇宙

分层将我们的数据集分割成独立的“宇宙”，即**层**（strata）——在我们的例子中，每家医院一个层。在这些宇宙的每一个内部，我们对我们真正感兴趣的协变量（如我们的药物治疗）维持等[比例风险假设](@entry_id:163597)。然而，我们允许每个宇宙拥有自己独特的、完全任意的风险“背景时间线”。这就是**分层特有的基线风险**，记为 $h_{0s}(t)$。[@problem_id:4985450]

模型的风险函数优美地捕捉了这一思想：

$h(t \mid \mathbf{X}, S=s) = h_{0s}(t) \exp(\boldsymbol{\beta}^\top \mathbf{X})$

让我们来分解一下这个公式：
- $S=s$ 表示我们正在观察一个特定层 $s$（例如，医院A）中的个体。
- $h_{0s}(t)$ 是该层的基线风险。这个函数可以是任何形状。它可以先高后低，先低后高，或者任意波动。模型并不关心。关键在于，医院A的基线风险 $h_{0A}(t)$ 可以与医院B的基线风险 $h_{0B}(t)$ 完全不同。这就是模型优雅地处理层间非等比例性的方式。[@problem_id:4610345]
- $\exp(\boldsymbol{\beta}^\top \mathbf{X})$ 代表了我们的协变量 $\mathbf{X}$ 的效应。参数向量 $\boldsymbol{\beta}$ 包含对数风险比，而关键的假设是这个系数向量是一个[普适常数](@entry_id:165600)，在*所有*层中都相同。无论是在医院A还是医院B给药，药物具有相同的*相对*效应。[@problem_id:4550973]

### 倾听回声：通过[偏似然](@entry_id:165240)进行估计

那么，当模型已将数据隔离到不同的宇宙中时，它如何估计普适的药物效应 $\boldsymbol{\beta}$ 呢？它通过只在每个宇宙*内部*进行比较来实现。这个估计引擎，一个被称为**[偏似然](@entry_id:165240)**（partial likelihood）的数学奇迹，从不直接将医院A的患者与医院B的患者进行比较。[@problem_id:5228283]

想象一个事件发生——医院A的一名患者复发了。模型立即聚焦于那一刻的**风险集**（risk set）：所有*在医院A中*仍处于复发风险中的其他患者。它会问：“鉴于这个群体中有人复发了，那个人是服用我们药物的人的可能性更大还是更小？” 来自这单个事件的协变量信息为协变量 $\boldsymbol{\beta}$ 的效应提供了微小的一份证据。这个过程对每个医院的每个事件都会发生，并且总是被限制在适当的层内风险集中。

总证据是通过将每个层的似然相乘来收集的：$L(\boldsymbol{\beta}) = \prod_{s=1}^K L_s(\boldsymbol{\beta})$。[@problem_id:4550973] 这使得模型能够汇集信息以获得对 $\boldsymbol{\beta}$ 的精确估计，而从不违反层与层之间的隔离。每一步的计算都非常直观：指导估计的[得分函数](@entry_id:164520)（score function），本质上是一个（观察值 - [期望值](@entry_id:150961)）的动态总和。对于每个事件，我们查看失败患者的协变量值（“观察值”），然后减去该协变量在整个风险集中的加权平均值（“[期望值](@entry_id:150961)”）。如果药物有害，我们预计会看到服用药物的患者比预期更频繁地失败，这个总和会反映出这一点。[@problem_id:4985456]

### 优雅的代价：我们得到了什么，又失去了什么

这个优雅的解决方案是一个巧妙的权衡。

我们获得的收益是巨大的：通过完美地控制分层变量（医院）的混杂影响，我们为协变量效应（$\boldsymbol{\beta}$）获得了稳健、无偏的估计，无论该分层变量对生存的影响多么奇怪或非等比例。[@problem_id:4961478] [@problem_id:5228283]

我们失去的是关于分层变量本身的信息。因为我们从不跨层比较，所以模型无法告诉你身处医院A与医院B的风险差异。这个效应被完全吸收到各自独立的基线风险中。这不是一个缺陷，而是一个刻意为之的特性。我们选择了回避这个问题。此外，任何其他在层内恒定的变量——例如，某家医院所有患者都相同的“质量评分”——也变得无法估计。它的效应与该层的基线风险完全混杂，并在[偏似然](@entry_id:165240)中被抵消掉。[@problem_id:4961478] 最后，通过限制比较，我们有时会损失统计功效（statistical power），特别是当某些层非常小，导致在每个事件时间点可供比较的个体很少时。这会增加我们估计值 $\hat{\boldsymbol{\beta}}$ 的方差。[@problem_id:5228283]

### 统一的线索：伪装下的分层模型

科学中一个真正深刻思想的标志之一，是它能够连接看似毫不相关的概念。分层Cox模型优美地做到了这一点。

考虑**配对分析**（matched-pair analysis），这是流行病学中的一个经典设计。例如，每个接受新疗法的患者都会与一个接受安慰剂的相似患者（例如，年龄和性别相同）进行匹配。每个匹配对都可以被看作是大小为2的一个层。使用分层Cox模型分析这些数据，在数学上等同于使用**条件逻辑回归**（conditional logistic regression），后者是病例对照研究的基石。这两种源于统计学不同分支的方法，被揭示为是同一回事。[@problem_id:4610052]

另一个美妙的联系是与**[对数秩检验](@entry_id:168043)**（log-rank test）的联系，这是一种用于比较两条生存曲线（例如，治疗组与安慰剂组）的简单[非参数检验](@entry_id:176711)。事实证明，分层对数秩检验不过是在一个分层[Cox模型](@entry_id:164053)中，对原假设 $\boldsymbol{\beta}=\mathbf{0}$ 进行的[得分检验](@entry_id:171353)（score test），其中唯一的协变量是分组身份。这个强大的、通用的回归框架将那个简单、优雅的检验作为一个特例包含在内，揭示了其背后统计理论的深刻统一性。[@problem_id:4923232]

### 从比率到现实：预测个体命运

Cox模型给我们提供了风险比（hazard ratios），这对于[科学推断](@entry_id:155119)非常出色。但患者和医生常常会问一个更个人化的问题：“我*自己*活过五年的概率是多少？”要回答这个问题，我们需要从相对风险转向绝对风险。这需要对基线风险本身进行估计。

在[分层模型](@entry_id:274952)中，由于每个层都有自己的基线，我们的预测也必须是分层特有的。在估计了普适效应 $\hat{\boldsymbol{\beta}}$ 之后，我们可以回到数据中，使用像**Breslow估计量**（Breslow estimator）这样的方法为每个层 $s$ 估计累积基线风险 $\hat{H}_{0s}(t)$。[@problem_id:4961506] 然后，对于来自医院 $s$、协变量为 $\mathbf{X}$ 的新患者，其生存概率可以通过将普适定律与局部背景相结合来计算：

$S(t \mid \mathbf{X}, S=s) = S_{0s}(t)^{\exp(\hat{\boldsymbol{\beta}}^\top \mathbf{X})} = \exp(-\hat{H}_{0s}(t) \exp(\hat{\boldsymbol{\beta}}^\top \mathbf{X}))$

该预测正确地使用了该患者所在医院特有的基线风险时间线。[@problem_id:4550973]

### 医生，自医吧：检查我们自己的假设

我们引入分层来解决“医院”变量的非等比例性问题。但这样做的时候，我们将整个分析建立在了一个新的假设之上：我们的协变量（如药物）的效应在每个层*内部*是等比例的。这是一个我们必须检查的假设。

用于这项工作的工具，例如**Schoenfeld残差**，也必须尊重我们模型的分层性质。为了检验我们药物效应的PH假设，我们必须基于层内风险集来计算残差，并寻找是否存在任何随时间变化的系统性趋势。[@problem_id:4555949] 好的科学不仅仅是建立优雅的模型，还在于严格地审视其基础。分层Cox模型不仅为分析提供了强大的框架，也为这种必要的自我审视提供了框架。

