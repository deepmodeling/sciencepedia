## 应用与跨学科联系

既然我们已经精心打造了我们这台错综复杂的机器，这台奇妙的自动机，那就让我们来试驾一番吧。你可能以为我们只是创造了一个美化版的拼写检查器，一个在文档中找词的工具。但这好比说望远镜只是用来看远方的船只。一旦你将它指向天空，一个全新的宇宙就此展开。我们的[模式匹配](@article_id:298439)自动机就是这样一种设备。一旦你学会用“文本”和“模式”的眼光看世界，你就会开始在最意想不到、最美丽的地方发现它们。让我们来一次巡游，看看我们的创造物能做些什么。

### 数字哨兵：安全与过滤

也许我们自动机最直接的工作就是充当一个不知疲倦的数字哨兵。想象一下，你正在运营一个大型在线服务，需要过滤消息中的不当言论或筛选电子邮件中垃圾邮件的蛛丝马迹。你有一个长长的“禁用”词汇和短语列表。一种天真的方法是反复阅读消息，每次只为一个禁用词。效率极低！而我们的自动机，却能以一次优雅的单遍扫描完成这项工作。它消化文本流，就像一组调校完美的铃铛，只要发现任何一个禁用模式，无论有多少个，它都会响起。这种简单但强大的能力是当今互联网上无数内容过滤系统的支柱。[@problem_id:3276231]

但我们可以大幅提高赌注。让我们从过滤公共消息转向守卫互联网的门户。每时每刻，数以百万计的数据包流经[网络路由](@article_id:336678)器。其中一些是[网络流](@article_id:332502)量，一些是电子邮件，一些是视频通话。还有一些可能是来自黑客的恶意流量。防火墙或入侵检测系统如何区分它们呢？它执行所谓的“深度包检测”。它查看数据包的有效载荷，寻找签名——即识别协议（如用于网络流量的 `HTTP/1.1`）或揭示已知计算机病毒指纹的特征数据字符串。挑战是巨大的：系统必须以线路速度同时扫描数千个签名，而不能拖慢网络。这是一项高风险、高性能的工作，简直是为我们的自动机量身定做的。它可以通过在单次扫描中找到最长、最频繁和最早出现的签名来识别流量的性质。[@problem_id:3204942]

### 生命与代码的语言

当我们认识到“文本”不一定是人类语言时，我们自动机的威力才真正显现出来。一些最重要的文本是用远比人类语言古老和复杂的语言写成的。思考一下生命本身的语言：DNA 序列。一个基因序列可以被看作是用一个四字母字母表写成的巨大字符串：$A, C, G, T$。生物学家经常需要在这浩瀚的文本中寻找特定的短序列——例如，特定[限制性内切酶](@article_id:303842)将“切割”DNA的识别位点。给定这些识别位点的列表，我们的自动机可以扫描整个基因组，并在一次线性扫描中精确定位所有潜在的切割位置，这是基因工程和分析中的一项基本任务。[@problem_id:3204966]

从生命的代码，我们转向我们为计算机编写的代码。当你在现代代码编辑器中键入时，你会看到即时反馈：像 `for` 和 `while` 这样的关键字会改变颜色，而像 `my_for_loop` 这样的变量名则不会。编辑器是如何如此迅速地做到这一点的呢？它正在执行多[模式匹配](@article_id:298439)！一种语言中的所有关键字（`if`、`else`、`return` 等）构成了模式的词典。你编写的源代码就是文本。自动机在你键入时扫描你的代码，并且因为它是由整个关键字词典构建的，所以它可以一次性识别所有关键字。当然，一个真实的语法高亮器更为复杂；它必须足够聪明，不会高亮注释或字符串字面量中的关键字，并通过检查周围的字符来识别 `inline` 是关键字而 `inlineFunc` 不是。但在其核心，闪电般快速的识别引擎正是我们的自动机在工作。[@problem_g_id:3205067]

### 超越字符：符号的世界

到目前为止，我们的“字母”一直是字符。但自动机真正的美在于其抽象性。“字母表”可以是*任何*离散符号的集合。让我们拓宽视野。想象你正在调试一个复杂的软件。你有一份长长的执行轨迹，记录了程序所做的每一次函数或 API 调用：`open`、`read`、`write`、`connect`、`send`、`close` 等等。一个 bug 可能只在一次非常特定的调用序列之后才会出现。或者，一个恶意软件可能通过其特有的行为模式来识别，比如 `connect`、`download_payload`、`execute`。通过将每个 API 调用视为新字母表中的一个“字母”，我们可以使用我们的自动机在一个包含数百万次调用的轨迹中，同时搜索数千个已知的恶意或有问题的序列。[@problem_id:3204910]

举一个更有趣的例子来说明同样的原理，考虑国际象棋。一整盘棋可以记录为一连串的着法：`e4 e5 Nf3 Nc6 ...`。这些着法就是我们的新字母表。国际象棋理论家已经编录了数千种标准的开局序列，如“鲁伊·洛佩斯开局”（'Ruy Lopez'）（`e4 e5 Nf3 Nc6 Bb5`）或“西西里防御”（'Sicilian Defense'）（`e4 c5`）。我们可以用一个包含所有这些开局的数据库来构建一个自动机。然后，当我们观看一盘棋的展开时，我们的自动机可以“读取”着法序列，并准确地告诉我们正在使用的是哪些有名称的开局，包括共享共同前缀的变着和子变着。还是那台机器，只是在读取一种不同的文本。[@problem_id:3205036]

### 庞大机器中的一个工具

有时，我们的自动机不是最终的问题解决者，而是更大分析流程中的一个关键组成部分。考虑剽窃检测问题。我们如何确定两份文档是否可疑地相似？一种方法是看它们有哪些共同的短语。我们可以从一份文档中生成所有特定长度的短语（n-gram），并将它们视为我们的模式集。然后，我们使用 Aho-Corasick 自动机高效地找出这些模式中有哪些出现在第二份文档中。由此产生的共享 n-gram 集合充当了一个“指纹”。通过比较我们自动机帮助生成的许多文档的指纹，我们可以将它们[聚类](@article_id:330431)，从而找到相关或抄袭文本的家族。[@problem_id:3204938]

另一个引人入胜的角色是作为数据压缩的[预处理](@article_id:301646)器。[Lempel-Ziv](@article_id:327886) 家族的[算法](@article_id:331821)（`zip` 和 `gzip` 等流行工具背后的[算法](@article_id:331821)）通过构建一个它们以前见过的短语的词典，并用一个简短的引用替换后续的出现来工作。如果我们能给压缩器一个领先优势呢？使用我们的自动机，我们可以首先扫描文本以查找一个非常常见的短语词典（比如，来自标准英语词典）。我们可以将像 `the quick brown fox` 这样的短语的每次出现都替换为一个单一的特殊符号。由此产生的符号和常规字符序列可能会变得更具重[复性](@article_id:342184)，因此对于像 LZ78 这样的标准[算法](@article_id:331821)来说更容易压缩。我们的自动机充当了一个智能的预过滤器，为下一阶段的处理简化了数据。[@problem_id:3204965]

### 打破线性：高维模式

到目前为止，我们的“文本”一直是一个线性序列，一行字符或符号。但如果数据不是平面的呢？抽象机器的真正力量在于其适应新结构的能力。想象一下在 XML 文档或计算机的[文件系统](@article_id:642143)中进行搜索。数据是一棵树。我们可能想在树的路径上而不是单个字符串中寻找模式，比如找到所有其从根开始的路径匹配 `*/bin/python` 的文件。我们可以通过对树进行遍历来实现这一点，例如，[深度优先搜索](@article_id:334681)（DFS）。当 DFS 从根向下探索一条路径时，它将节点标签（字符）“喂”给我们的 Aho-Corasick 自动机。自动机的状态在 DFS 的递归调用中向下传递。通过这种方式，我们实际上是沿着所有从根到叶的路径同时运行[模式匹配](@article_id:298439)[算法](@article_id:331821)，而无需将它们提取为单独的字符串。这是[树遍历算法](@article_id:639508)和[状态机](@article_id:350510)的完美结合。[@problem_id:3204909]

让我们最后一次突破界限，从一条线到一个平面。我们怎么可能在一张大图片里找到一张小的二维图片呢？例如，在照片中找到特定像素[排列](@article_id:296886)。这似乎需要一个全新的“二维自动机”。但令人惊讶的答案是，我们可以用我们信赖的一维自动机来解决这个问题，只需以一种巧妙的两阶段过程来使用它。首先，我们将二维模式的每一*行*视为一个一维字符串。我们在所有这些独特的行模式上构建一个 Aho-Corasick 自动机。然后，我们用这个自动机扫描大二维文本的每一行。结果是一个新的二维矩阵，其中每个条目告诉我们哪个行模式在该位置匹配结束。现在是见证奇迹的时刻：一个二维模式只是这些行模式的一个特定的*垂直*序列。因此，在第二阶段，我们可以扫描我们新矩阵的*列*，寻找正确的行匹配结果的垂直序列！我们巧妙地将一个二维问题简化为一维问题的两次应用，这是物理学家和计算机科学家手册中的一个经典技巧。[@problem_id:3205046]

### 结论

我们的旅程结束了。我们从一个简单的问题开始：在文本中找词。但通过改进我们的方法，通过在一个简单的[前缀树](@article_id:638244)上添加“失败链接”这一巧妙思想，我们创造了远为深刻的东西。我们构建了一台用于识别模式的抽象机器。正如我们所见，模式无处不在：在我们的安全系统中，在我们的源代码中，在我们的 DNA 中，在我们玩游戏的方式中，甚至在数据本身的结构中。Aho-Corasick 自动机是核心计算机科学原理的一个美丽典范：找到一个好的抽象，你就会发现它解开了你甚至还没想过要问的问题的答案。