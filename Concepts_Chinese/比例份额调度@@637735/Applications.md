## 应用与跨学科联系

在窥探了比例份额调度的内部机制之后，人们可能很容易将其归档为[操作系统](@entry_id:752937)设计中一个巧妙的片段。但这就像只欣赏一个漂亮的齿轮，却没看到它所驱动的宏伟时钟。“各取所值（按权重分配）”的原则不仅仅是一个孤立的技巧；它是[资源分配](@entry_id:136615)的一个基本概念，其回响无处不在，从你个人电脑的嗡嗡声，到云端广阔的[分布](@entry_id:182848)式智能，甚至延伸到那些看似与硅毫无关联的领域。让我们踏上一段旅程，看看这个简单的想法能带我们走多远。

### 桌面上的交响乐

我们的第一站是最熟悉的：你桌上的电脑。此时此刻，很可能有几十个进程在争夺它的注意力。你可能正在进行视频通话，而后台在运行备份，你偶尔还会切换到你的代码编辑器。这些任务中的每一个——对延迟敏感的视频流、对吞吐量要求高的备份、交互式的编码会话——都有不同的需求，争夺着相同的有限资源：中央处理器（CPU）、磁盘和网络。

系统是如何避免陷入混乱的呢？比例共享最简单的应用提供了一个出人意料的优雅答案。[操作系统](@entry_id:752937)可以把每种资源都看作一个待分割的饼。对于给定的资源，比如网络，如果所有任务的总需求（它们所需最小数据速率的总和）小于网络连接的总容量，那么公平的分配是可能的。如果需求总和超过了容量，再巧妙的共享也无法满足所有人。这个简单的“准入控制”测试——检查所需速率的总和是否小于或等于总容量——是维持系统稳定和响应迅速的第一道防线。它允许[操作系统](@entry_id:752937)向你的视频通话承诺一定的[服务质量](@entry_id:753918)，确保它不会因为备份程序决定消耗整个磁盘带宽而卡顿[@problem_id:3633834]。这个将需求与容量匹配的基本原则是资源管理的基石。

### 复杂中的秩序：层级与容器

然而，现代系统很少是简单、扁平的进程集合。我们常常希望为任务组管理资源。想象一下，你在同一台机器上运行一个数据库和一个 Web 服务器。你可能希望保证数据库作为一个整体获得 60% 的 CPU，而 Web 服务器获得 40%，无论它们各自衍生出多少个线程。

这就是层级应用的精妙之处。比例共享原则可以递归地应用。例如，Linux 使用一个名为“控制组”（[cgroups](@entry_id:747258)）的功能来实现这一点。你可以创建一个拥有特定 CPU 份额的父组，并在其中创建子组来进一步细分该份额。任何单个进程的有效份额就是其家族树上所有层级份额的乘积[@problem_id:3688823]。这种优雅的乘法逻辑是现代软件容器（如 [Docker](@entry_id:262723)）背后的引擎，允许在复杂的多应用环境中对[资源分配](@entry_id:136615)进行细粒度控制。

我们甚至可以将这种“软”共享与“硬”限制结合起来。管理员可以声明一个进程组按比例获得（比如）20% 的 CPU，但同时设置上限，使其*永远*不能超过总 CPU 的 50%，即使系统在其他方面是空闲的。然而，由于一种称为“工作守恒”的特性，如果该组是唯一运行的组，它可以使用所有可用的资源，直到其硬性上限。未使用的份额不会被浪费；它们会被优雅地重新分配给需要它们的人。这种比例共享和硬性限制的结合，为在服务器和数据中心制定复杂的资源管理策略提供了一个丰富的工具箱[@problem_id:3628565]。

### 超越理想：现实世界中的调度

到目前为止，我们的模型都假设每个任务都是完美的公民，总是准备好运行。但实际上，任务通常是混乱的。数据库中的一个进程可能需要等待一个锁被释放，或者等待数据从慢速磁盘中读取。在这段“阻塞”时间内，它并没有使用 CPU。一个天真的比例份额调度器会简单地跳过它的回合，实际上是对它进行了惩罚。这对交互式应用尤其不公平，因为它们经常因为等待用户输入而阻塞。

为了解决这个问题，调度器可以被赋予记忆。一种巧妙的机制是授予“补偿信用”。如果一个高优先级任务因为被阻塞而错过了它的回合，它会累积信用。当它再次变为可运行时，它被允许“花费”这些信用，暂时获得比正常份额更大的 CPU 份额来追赶进度。这确保了从长远来看，公平性得以保持，一个长时间运行的、CPU 密集型的分析查询不会完全饿死一个交互式的查询[@problem_id:3673609]。

另一个与理想情况的偏离发生在那些无法被抢占的资源上。你不能在一个图形处理单元（GPU）完成复杂计算的中途停止它。这种“[不可抢占](@entry_id:752683)性”对公平性构成了挑战。如果一个应用程序提交了一个非常长的内核，所有其他应用程序都必须等待。我们在这里如何谈论公平性？理论家通过将真实的、“粗粒度”的调度器与一个称为通用[处理器共享](@entry_id:753776)（Generalized Processor Sharing, GPS）的理想化、[完美流体](@entry_id:161909)模型进行比较，提供了一个优美的答案。虽然真实调度器无法在每个瞬间都与流体模型匹配，但我们可以证明，真实调度器完成的工作与理想模型完成的工作之间的差异——即“滞后”——在数学上是有界的。最大滞后，很直观地，不会超过系统中最长的[不可抢占](@entry_id:752683)工作块。这给了我们一个强有力的保证：即使公平性不是完美的，我们也确切地知道它能有多不完美[@problem_id:3673688]。

### 矩阵：虚拟世界中的调度

当我们进入虚拟化的世界，这个驱动云计算的技术时，问题就变得更深了。一个虚拟机（VM）认为它拥有自己私有的硬件，包括一个 CPU。VM 内部的[操作系统](@entry_id:752937)运行着它自己的调度器，试图公平地分配它认为是自己的 CPU 时间。但现实是，一个 hypervisor 正在底层秘密运行，它可能会抢占整个 VM 去运行另一个 VM 或某些主机任务。这被称为“被盗时间”。

从客户机[操作系统](@entry_id:752937)的角度来看，挂钟时间似乎正常流逝，但 CPU 却消失了一段时间。如果它的调度器没有意识到这一点，它的整个公平概念都会被破坏。它可能会为一个进程“收取”一整毫秒的 CPU 时间，而由于被盗时间，该进程实际只运行了其中的一小部分。解决方案是客户机和主机之间的协作：通过一个“[半虚拟化](@entry_id:753169)”接口，hypervisor 可以向客户机报告被盗时间的数量。然后，客户机调度器可以调整其内部记账，将其公平性计算基于真实的、实际的执行时间，而不是挂钟时间。这确保了即使在 VM 的人造现实中，公平性也能得以维持，这是云中可预测性能的一个关键要求[@problem_id:3673700]。

### 我们在分享什么？公平的货币

这就引出了一个非常微妙的观点。我们一直在谈论分享“资源”，但我们必须精确定义我们分享的货币。考虑一个磁盘 I/O 调度器。是给每个进程相同*数量的回合*（即 I/O 请求）更公平，还是给它们相同*数量的时间*来使用磁盘更公平？

这两者并不相同！一个发出成千上万个微小、快速请求的进程，可能会被分配到总*请求数*的一小部分，但最终却垄断了磁盘的*时间*，饿死了一个发出不频繁但巨大、耗时请求的进程。一个基于 IOPS 的调度器，它[按比例分配](@entry_id:634725) I/O 操作的*数量*，并不能保证时间份额的公平性。为了实现真正基于时间的公平性，调度器必须更加复杂；它必须计算每个请求实际花费的时间。这迫使我们去问公平的最终目标是什么，并认识到我们测量什么——资源的“量子”——的选择与分配它的规则同样重要[@problem_id:3673644]。

### 从单机到全球大脑：集群调度

现在，让我们从单台计算机放大到大型数据中心的规模，这是一个由数千个节点组成的分布式系统，构成了互联网的骨干。在这里，像 [Kubernetes](@entry_id:751069) 这样的“集群编排器”必须将应用程序 pod（容器组）放置到节点上运行。目标是实现集群范围的公平性：一个权重为 $w_i$ 的应用程序应该获得与 $w_i$ 成比例的*整个集群* CPU 算力份额。

从一个中心化的大脑来做这件事似乎复杂得不可能。然而，解决方案是[分布式系统](@entry_id:268208)中最优美的结果之一。全局的、集群范围的公平性可以通过在每个节点上强制执行一个简单的局部条件来实现。一个放置是公平的，当且仅当，在每一个节点上，该节点容量与放置在其上的 pod 权重总和之比都是相同的常数值。这个常数实际上就是整个集群的总容量与所有 pod 的总权重之比。这个原则允许一个去中心化的系统通过让每个部分遵循一个简单的局部规则来达到一个全局目标——这是一个令人惊叹的涌现秩序的例子[@problem_id:3673669]。

### 超越硅基：一个普适原则

最后，要看到比例份额调度的真正普适性，我们必须完全走出[操作系统](@entry_id:752937)的世界。考虑一个在线广告系统。对于网站的每一个访问者，系统都必须选择显示哪个广告活动的广告。广告活动有不同的每日预算，系统理想情况下应该按这些预算的比例来展示它们的广告。

抽象地看，这完全是同一个问题！“展示次数”是资源，而“预算”是权重。但是你如何实现它呢？可以使用“彩票”方法，预算为 $b_i$ 的广告活动得到 $b_i$ 张彩票。这在平均意义上是公平的，但由于随机性，实际的展示次数可能会与理想情况有显著偏差，其误差会随着时间增长。一个更好的方法是使用像步进调度（stride scheduling）这样的确定性算法。在这里，与理想份额的偏差在数学上被保证是“有界的”——它从不超过一个小的常数量（通常只有一个展示次数！）。这为商业系统提供了强大、可预测的保证，因为这些系统中金钱攸关[@problem_id:3673695]。

从你的桌面到云端，从 CPU 到广告展示，比例共享这个简单的概念证明了自己是现代系统中最有效、最通用的思想之一。它的美不在于深奥的复杂性，而在于其基础的简单性以及它为混乱的数字世界带来可预测、可扩展和公平秩序的非凡力量。