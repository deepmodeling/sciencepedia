## 引言
多年来，计算机视觉通过一种割裂的视角来感知世界，使用不同的方法来理解可数的“事物”(things) 和无定形的“材料”(stuff)。这种割裂的方法论，即使用[实例分割](@entry_id:634371)和[语义分割](@entry_id:637957)等不同的任务，不仅造成了不完整的画面，而且其依赖的评估指标常常忽略关键错误，例如将两个不同的细胞合并成一个。这种知识鸿沟凸显了建立一个能够从整体上分割和评估场景的统一框架的必要性。本文将介绍全景质量 (Panoptic Quality, PQ)，这是一种专为此目的设计的强大指标。在接下来的章节中，我们将对 PQ 进行全面探索。“原理与机制”一章将分解其核心概念，解释 PQ 是如何由其两个关键组成部分——识别质量和分割质量——计算得出的。然后，“应用与跨学科联系”一章将展示 PQ 的实际应用，阐明其作为诊断工具在医学成像等不同领域不可或缺的作用，揭示更好的指标如何带来更好的人工智能。

## 原理与机制

想象一下，你正在看一张城市的卫星图像。你可以用两种方式来理解它。第一种是像地图一样给它着色：每个像素都被标记为“建筑”、“道路”、“公园”或“水”。这很有用，但存在一个问题：一个包含数十个独立建筑的庞大城市街区，最终只变成了一个巨大的“建筑”色块。你失去了单个的对象。第二种方式是围绕每一辆车和每一栋建筑画出精确的边界。这对于计算汽车数量来说很棒，但它完全忽略了填充场景的“材料”，比如道路和公园。几十年来，[计算机视觉](@entry_id:138301)一直用这两种独立的思维模式来处理世界，一种专注于无定形的“材料”，另一种专注于可数的“事物”。这造成了一种割裂的理解。为了真正理解一个场景，无论是从高空俯瞰的城市，还是显微镜下的组织样本，我们都需要一个统一的视角。

### 两种任务的故事：事物与材料的世界

让我们把这个问题具体化。第一种方法，即用类别标签为每个像素着色，被称为**[语义分割](@entry_id:637957)** (semantic segmentation)。它本质上是在像素级别上执行的分类任务。考虑一张数字病理学切片，病理学家需要识别所有肿瘤细胞核。一个[语义分割](@entry_id:637957)模型可能会被训练来将每个像素标记为“肿瘤细胞核”或“背景”。现在，如果两个肿瘤细胞核相互接触，会发生什么？模型可能会完美地将属于任一细胞核的每个像素都标记为“肿瘤”，从而实现 100% 的像素级准确率。然而，这样做却将两个不同的对象合并成了一个无法区分的色块。对于需要计算细胞核数量来为癌症分级的医生来说，这个结果是失败的。我们丢失了关于对象的数量和个体性的关键信息 [@problem_id:4332648]。

第二种方法，侧重于找到并勾勒出每个独立对象，被称为**[实例分割](@entry_id:634371)** (instance segmentation)。这个任务不仅问“这个像素是什么？”，而是问“这个像素属于哪个对象？”。它非常适合处理可数的**事物**，如细胞、汽车或行人。它为我们提供了一个对象列表及其精确的掩码。然而，它传统上忽略了构成场景背景的无定形、不可数的**材料**，如天空、道路或基质（病理样本中的[结缔组织](@entry_id:143158)）[@problem_-id:4351051]。

为了获得完整的理解，我们需要同时进行这两种操作。我们需要一种方法，既能识别无定形的天空，描绘出蜿蜒的道路，又能同时检测、计数并勾勒出路上的每一辆车。

### 全景之梦：统一视角

这种统一的方法正是**[全景分割](@entry_id:637098)** (panoptic segmentation) 的目标。这个名字本身就很优美，源自“pan-”（全部）和“-optic”（视觉）。它旨在为图像提供单一、全面且无[歧义](@entry_id:276744)的解释。规则简单而深刻：图像中的每个像素都必须被分配一个语义标签，并且，如果该标签对应于一个“事物”，它还必须被分配一个唯一的实例标识符。不允许有重叠的分割区域，也不允许有未分配的像素。整个图像被划分为一个有意义的整体。

在数学上，这个优雅的想法可以用一对映射来表示。对于图像中的每个像素 $x$，我们确定一个实例 ID $i(x)$，对于每个实例 ID，我们有一个类别标签 $c(i(x))$ [@problem_id:4332648]。对于像“道路”或“天空”这样的“材料”类别，所有属于该类别的像素可能共享一个单一、共同的实例 ID。对于像“汽车”这样的“事物”类别，每辆车都会获得自己唯一的 ID。这个框架优雅地结合了[语义分割](@entry_id:637957)和[实例分割](@entry_id:634371)的世界。在实践中，实现这一点通常涉及复杂的融合[启发式方法](@entry_id:637904)，其中来自模型“材料”和“事物”分支的预测被仔细合并，以解决一个人实例可能与预测的道路区域重叠等冲突 [@problem_id:3136241]。但目标始终是这个单一、连贯的输出图。

### 衡量梦想：全景质量 (PQ) 指标

那么，我们有了一个统一的任务。我们如何衡量成功呢？正如我们在接触的细胞核例子中看到的，简单的像素准确率对那些至关重要的实例级错误是视而不见的。一个为合并两个对象而给出满分的指标，不是这项工作的正确工具 [@problem_id:4356921] [@problem_id:3136328]。

**全景质量 (PQ)** 的创造者深刻地理解了这一点。他们意识到，要评估一个全景预测，必须在对象级别上进行匹配游戏。第一步是定义一个预测的对象掩码与一个真实的（ground-truth）对象掩码的匹配程度。为此，我们使用一个非常简单直观的度量，称为**[交并比](@entry_id:634403) (Intersection over Union, IoU)**。它正如其名：计算两个形状重叠区域的面积，然后除以它们共同覆盖的总面积。

$$\mathrm{IoU}(p,g) = \frac{|p \cap g|}{|p \cup g|}$$

IoU 为 1 表示完美匹配，而 IoU 为 0 表示完全没有重叠。匹配游戏通过设置一个阈值进行，通常是 $\mathrm{IoU} > 0.5$。如果一个预测实例和一个真实实例属于同一类别，并且它们的 IoU 超过这个阈值，它们就成为一个匹配对——一个**真正例 (True Positive, TP)**。匹配必须是一对一的；每个真实对象最多只能与一个预测匹配，反之亦然。

经过这个匹配过程后，我们剩下三组对象：
*   **真正例 (TP):** 正确匹配的预测-真实对的集合。这些是成功的例子。
*   **假正例 (FP):** 未能找到匹配的预测对象。这些是模型的“幻觉”。
*   **假负例 (FN):** 未被任何预测匹配的真实对象。这些是模型遗漏的对象。

考虑一个 CT 扫描，模型预测了 3 个潜在的病变，而真实情况有 2 个。在计算 IoU 并应用匹配规则（IoU > 0.5）后，我们发现两个预测正确地匹配了两个真实病变。这给了我们 $|TP|=2$。一个预测仍然未匹配，所以我们有 $|FP|=1$。由于两个真实病变都被找到了，我们有 $|FN|=0$ [@problem_id:4582640]。有了这三个计数，我们就可以计算全景质量了。

### 解构质量：SQ 与 RQ

全景质量的真正美妙和强大之处就在于此。它不仅仅是一个单一、不透明的数字。它是由两个更基本、更易于解释的组成部分的乘积而生：**分割质量 (SQ)** 和**识别质量 (RQ)** [@problem_id:4357013]。

$$PQ = SQ \times RQ$$

**识别质量 (RQ)** 回答了这样一个问题：“模型在*检测*正确对象集合方面的表现如何？” 它是一个 F1 分数，平衡了遗漏对象 (FN) 和产生虚假对象 (FP) 的错误。其定义如下：

$$RQ = \frac{|TP|}{|TP| + \frac{1}{2}|FP| + \frac{1}{2}|FN|}$$

这个公式优雅地对假正例和假负例给予同等惩罚。如果没有 FP 和 FN，则 $RQ=1$。模型犯的检测错误越多，其 RQ 分数就越低。

**分割质量 (SQ)** 回答了另一个问题：“对于模型*确实*正确找到的对象，它描绘其边界的程度如何？” 它就是所有真正例匹配的平均 IoU 分数。

$$SQ = \frac{\sum_{(p,g) \in TP} \mathrm{IoU}(p,g)}{|TP|}$$

如果模型完美地找到了每个对象（$RQ=1$），但其轮廓画得很草率，那么 $SQ$ 就会很低。

当把它们相乘时，神奇的事情就发生了。一个高的 PQ 分数要求模型在*识别*和*分割*两方面都表现出色。任何一个领域的弱点都会严重影响总体分数。这种乘法关系并非随意选择；它直接源于 PQ 的第一性原理定义。PQ 的基本公式是所有匹配对的 IoU 之和，除以真正例的数量加上对假正例和假负例的惩罚 [@problem_id:4351128]。

$$PQ = \frac{\sum_{(p,g) \in TP} \mathrm{IoU}(p,g)}{|TP| + \frac{1}{2}|FP| + \frac{1}{2}|FN|}$$

通过一点代数运算，你可以看到这完[全等](@entry_id:194418)同于 $(\frac{\sum IoU}{|TP|}) \times (\frac{|TP|}{|TP| + \frac{1}{2}|FP| + \frac{1}{2}|FN|})$，也就是 $SQ \times RQ$。这种数学上的一致性是一个精心设计的指标的标志。

### PQ 的实际应用：一种诊断工具

分解为 SQ 和 RQ 将 PQ 从一个单纯的评分转变为一个强大的诊断工具。它不仅告诉你模型的表现*有多好*，还开始告诉你*为什么*。

让我们回到接触的细胞核例子。想象一下，真实情况包含一个大的细胞核，但我们的模型错误地将其分裂成两个较小的部分（“过度分割”）。一个简单的像素级指标可能会报告接近完美的准确率。但 PQ 会看到什么呢？模型预测了两个对象，而实际上只有一个。其中一个预测部分（可能是较大的那个）将与真实细胞核匹配，成为一个 TP。另一个预测部分将无法匹配，成为一个 FP。这一个 FP 会惩罚识别质量 (RQ)，立即使分数降低。此外，匹配对的 IoU 会很差，因为预测只覆盖了真实对象的一小部分，从而降低了分割质量 (SQ)。PQ 分数会急剧下降，正确地指出了一个重大错误 [@problem_id:3136328]。对于“过度合并”错误也是如此。PQ 对这些其他指标会忽略的关键结构性错误非常敏感。

这种诊断能力对科学家来说是不可或缺的。想象一下，在一个病理切片上评估一个模型，切片上有两种“事物”：小的、密集的细胞核和大的、复杂的腺体。总体的 PQ 可能只是中等水平。但通过检查其组成部分，研究人员可能会发现，对于腺体，SQ 非常高（例如 0.82），而 RQ 很低（例如 0.75）。这提供了一个清晰的洞察：模型在勾勒腺体形状方面表现出色（*当它找到它们时*），但它在*首先找到它们*方面有困难。问题在于检测，而不是描绘。相反，对于密集堆积的细胞核，SQ 和 RQ 可能都很低，表明模型在寻找和勾勒这些具有挑战性的对象方面都存在困难 [@problem_id:4357013]。这精确地告诉研究人员应该把改进模型的精力集中在哪里。

即使是调整模型的内部参数，比如用于消除重复检测的[非极大值抑制](@entry_id:636086)（NMS）阈值，也可以由 PQ 来指导。一个更严格的阈值可能会减少 FP，但会增加 FN。PQ 提供了一种原则性的方法来找到最佳的权衡，从而最大化整体性能 [@problem_id:3159516]。

从对“事物”和“材料”的割裂视角，我们走向了统一的全景理解，并在此过程中发现了一个不仅是数字，更是一面透镜的指标。全景质量，凭借其对识别内容和描绘优劣的优雅分解，为我们提供了一个更深入、更有洞察力、也更诚实的评估，来衡量我们的机器开始看世界的水平。

