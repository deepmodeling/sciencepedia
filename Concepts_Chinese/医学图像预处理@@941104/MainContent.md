## 引言
来自CT、PET或MRI扫描仪的原始医学图像并非完美的图片，而是复杂的物理测量结果，其中充满了来自设备和采集过程的失真。为了揭示用于科学分析的真实生物学信息，必须细致地校正这些在几何、强度和噪声方面的非生物学差异。没有这关键的一步，比较图像或训练可靠的算法都将无从谈起，从而阻碍了真正的医学影像量化科学的发展。

本文将作为这一基础过程的指南。第一部分“原理与机制”深入探讨了空间[重采样](@entry_id:142583)、强度归一化和特定模态去噪的核心技术。随后的“应用与跨学科联系”部分则探索了这些方法如何成为量化影像组学、稳健的机器学习模型以及受监管医疗软件开发不可或缺的一部分，从而架起从原始数据到临床洞见的桥梁。

## 原理与机制

想象一下，你是一位艺术品修复师，任务是研究一批来自不同时代、存放在不同博物馆、条件各异的杰作。在你能够比较Rembrandt和Monet的笔触之前，你必须首先处理掉泛黄的清漆、昏暗的画廊灯光以及画布的细微变形。你必须将每幅画恢复到一个共同的、原始的状态，以揭示艺术家的真实意图。

医学图像预处理就是这样一门修复艺术，但修复的对象是我们内部生物学的图像。一幅原始的医学图像，无论是来自CT、PET还是MRI扫描仪，都不是身体的完美照片。它是一项物理测量，一个由精密仪器捕获的复杂信号。与任何测量一样，它受到设备、环境以及其采集物理过程本身特性的影响 [@problem_id:4567524]。我们的任务是细致地剥离这些非生物学层面，以揭示隐藏在其中的量化信息。这个过程是物理学、计算机科学和统计学纪律的美妙结合，是一段将原始信号转化为可靠科学观察的旅程。

### 使用共同的空间语言

[数字图像](@entry_id:275277)最基本的属性之一是其分辨率。我们常常认为像素（或在3D中称为**体素**）是完美的小方块（或立方体）。实际上，它们通常是长方体。例如，一台CT扫描仪可能在一个切片内捕获非常精细的细节，比如间距为 $0.78$ 毫米乘 $0.92$ 毫米，但切片本身可能要厚得多，比如相距 $2.40$ 毫米 [@problem_id:4554326]。这给我们带来了**各向异性**的体素——一个被扭曲的空间网格。在这样的网格上分析距离或形状，就像使用一把在每个方向上拉伸程度都不同的橡皮尺。

为了进行有意义的几何测量，我们必须首先建立一个共同、统一的坐标系。标准做法是**重采样**图像到一个各向同性的网格上，通常是具有完美的 $1 \times 1 \times 1$ 毫米立方体体素。这涉及到创建一个新的空网格，然后计算应该填入每个新体素的强度值。

但是我们如何计算那个值呢？新的网格点落在旧的网格点之间。我们必须进行**插值**。想象一下，你在一个房间的几个点上有温度读数，你想猜测一个新位置的温度。你有几个选择。

-   **最近邻插值**是最简单的方法：直接取最近的原始体素的值。这种方法速度快且直接，但会产生“块状”或像素化的结果。
-   **线性或B[样条插值](@entry_id:147363)**是一种更复杂的猜测。它假设底层的物理量是平滑变化的。它会查看附近的几个体素，并在它们之间拟合一条直[线或](@entry_id:170208)平缓的曲线来估计新位置的值。这会产生一个更平滑、更逼真的图像。

哪种方法是正确的？这里我们遇到了一个优美的原则：工具的选择必须尊[重数](@entry_id:136466)据的性质 [@problem_id:4554326]。
对于像CT扫描这样的**强度图像**，其值代表一个连续的物理量（组织密度）。平滑变化是一个物理上合理的假设，因此线性或[样条插值](@entry_id:147363)是首选。它更忠实地重建了底层的连续信号。
但是对于**标签掩模**，即一个数字代表离散类别（例如，$1$ 代表“肿瘤”，$2$ 代表“肝脏”，$3$ 代表“肾脏”）的图像，进行平均是没有意义的。“肿瘤”和“肝脏”的平均值是什么？结果可能是 $1.5$，这将是一个无意义的、新发明的类别。对于标签掩模，我们必须保留原始的离散标签。因此，**最近邻插值**是唯一正确的选择。它确保[重采样](@entry_id:142583)后的掩模中的每个体素都保留原始的有效标签之一，从而保持区域之间的边界清晰分明。

### 校正光线：强度归一化之旅

即使在我们统一了几何结构之后，“亮度”值——即强度——也可能具有误导性。它们受到多种因素的扭曲，从扫描仪的硬件到特定扫描所使用的设置。校正这些[光度学](@entry_id:178667)失真是一段从扫描仪的基础物理学到数据科学的统计严谨性的旅程。

#### 从源头校准：校准仪器

理想情况下，我们应该在错误的源头进行校正。一台科学相机，像任何测量设备一样，都有不完美之处。一个简单而有效的相机响应模型是，测量到的信号不仅仅是真实信号，而是一个经过放大（或减弱）并添加了基线噪声的版本 [@problem_id:5020596]。我们可以这样写：

$$I_{\mathrm{raw}}(x,y) = K(x,y) \cdot S(x,y) + D(x,y)$$

在这里，$S(x,y)$ 是我们想要测量的真实生物信号。$K(x,y)$ 是一个空间变化的**[乘性](@entry_id:187940)增益**，代表了从不均匀照明（像一个中心更亮的聚光灯）到比邻居更敏感或更不敏感的像素等一切因素。$D(x,y)$ 是一个**加性偏移**，通常称为**[暗电流](@entry_id:154449)**，是传感器即使在完全黑暗中由于热噪声而产生的信号。

为了消除这些影响，我们可以使用两张特殊的图像进行校准：
1.  一张**暗场帧**，$I_{\mathrm{dark}}$，在盖上镜头盖（$S=0$）的情况下拍摄。这直接测量了加性偏移 $D(x,y)$。
2.  一张**平场帧**，$I_{\mathrm{flat}}$，拍摄一个完全均匀的光源。这张图像捕捉了增益和偏移的综合效应。

有了这些校准帧，校正就变成了一个简单而优雅的代数运算。首先，我们从[原始图](@entry_id:262918)像和平场图像中减去[暗电流](@entry_id:154449)。然后，我们将校正后的[原始图](@entry_id:262918)像除以校正后的平场图像。这抵消了乘性增益项 $K(x,y)$。完整的公式，同时重新缩放图像以保持有意义的强度范围，是：

$$I_{\mathrm{corr}}(x,y) = \left(I_{\mathrm{raw}}(x,y)-I_{\mathrm{dark}}(x,y)\right) \cdot \frac{\langle I_{\mathrm{flat}}(x,y)-I_{\mathrm{dark}}(x,y) \rangle}{I_{\mathrm{flat}}(x,y)-I_{\mathrm{dark}}(x,y)}$$

这就是**[平场校正](@entry_id:168651)**。它是辐射定标最基本的形式，是对物理图像形成过程的直接反演 [@problem_id:5020596]。

#### 在实际应用中：统计归一化

在许多现实场景中，尤其是在处理临床数据时，我们无法获得这些精心采集的校准帧。我们得到的是来自不同扫描仪、不同医院、不同时间的图像集，我们必须以某种方式使它们的强度具有可比性。这就是统计归一化发挥作用的地方。目标是消除未知的、特定于扫描仪的增益 $\gamma_j$ 和偏移 $\delta_j$ 的影响 [@problem_id:4567524]。

一种简单直观的方法是**最小-最大值归一化**。对于每张图像，我们找到最小和最大强度值 $I_{\min}$ 和 $I_{\max}$，并线性地将它们重新缩放到一个标准范围，比如 $[0, 1]$。任何强度 $I$ 都通过以下[仿射函数](@entry_id:635019)进行变换 [@problem_id:4545720]：

$$f(I) = \frac{I - I_{\min}}{I_{\max} - I_{\min}}$$

这就像告诉每位摄影师调整他们照片的对比度，使最暗的点是黑色，最亮的点是白色。

一种更稳健和常用的方法是**z-score归一化**。我们不使用极值（因为它们对单个异常像素很敏感），而是使用强度的均值（$\mu$）和标准差（$\sigma$）。变换如下：

$$I' = \frac{I - \mu}{\sigma}$$

这改变了强度值的含义。一个体素的新值不再是一个任意的数字，而是告诉我们它离平均强度有多少个标准差。这个变换有一个奇妙的特性，即它对原始数据的[仿射变换](@entry_id:144885)是不变的。如果我们通过将所有强度乘以一个增益 $\alpha$ 并加上一个偏移 $\beta$ 来重新缩放图像，变换后图像的z-score将与[原始图](@entry_id:262918)像完全相同 [@problem_id:4545773]。这正是我们想要消除的扫描仪间差异！

但这引出了一个微妙而关键的问题：我们从哪里计算 $\mu$ 和 $\sigma$？这个选择会产生深远的影响 [@problem_id:4545773]。
-   **按数据集归一化：** 我们可以从一个大的“训练”数据集中计算一个单一的、全局的 $\mu_{ds}$ 和 $\sigma_{ds}$，并将这些固定值应用于所有新图像。这将每张图像置于相同的绝对统计尺度上。
-   **按图像归一化：** 我们可以为每张图像单独计算 $\mu$ 和 $\sigma$。这对于消除特定于图像的增益和偏置非常有效，但会抹去关于图像绝对亮度的信息。

这种选择是一种权衡，是基于具体的科学问题和成像模态的性质做出的战略决策。没有单一的万能解决方案。

### 驯服噪声：透过静电看清信号

完美测量的最后一个障碍是**噪声**——那些不可避免的、随机的波动，给每张图像都加上了一层“绒毛”。[医学影像](@entry_id:269649)学中最优美的见解之一是，并非所有噪声都是生而平等的。它的特性，它的个性，是成像模态底层物理过程的直接标志 [@problem_id:4552580] [@problem_id:4528387]。

-   在**计算机断层扫描（CT）**中，经过重建过程后，噪声可以很好地用我们熟悉的、对称的**加性[高斯噪声](@entry_id:260752)**来近似。它就像老式收音机里“白噪声”的嘶嘶声。
-   在**[正电子发射断层扫描](@entry_id:165099)（PET）**中，图像是通过计数单个光子探测事件形成的。这是一个经典的泊松过程。其结果是**泊松噪声**，它有一个奇特的性质：方差等于均值。这意味着图像中较亮的区域天生噪声更大。这种信号依赖的噪声被称为**[异方差性](@entry_id:136378)**。
-   在**[磁共振成像](@entry_id:153995)（MRI）**中，情况变得更加有趣。原始信号是一个复数（有实部和虚部），并且两个通道中的噪声都是高斯噪声。但我们通常看的是*幅度*图像。这个幅度值的分布被称为**莱斯噪声**。它是不对称的，总是正的（所以即使是“背景”也有一个非零的平均强度），并且其方差也依赖于信号。

为什么这很重要？因为我们用来[降噪](@entry_id:144387)的工具必须与噪声的个性相匹配。对所有类型的噪声都使用一个通用的滤波器，就像用一把锤子来做工具箱里的所有工作。

例如，一个简单的高斯模糊可以通过平均相邻像素来减少高斯噪声。但它是不加区分地这样做的，会将清晰的边缘连同噪声一起模糊掉。一个更智能的滤波器是**双边滤波器** [@problem_id:4540917]。它执行一种加权平均，其中权重取决于两件事：像素必须在*空间*上接近（空间核），并且它们必须在*强度*上接近（范围核）。这意味着滤波器会在一个平滑区域内平均像素，但当遇到边缘时会停止平均。它巧妙地模糊了噪声，同时保留了结构。

当面对像莱斯噪声这样更奇特的噪声时，为[高斯噪声](@entry_id:260752)设计的标准滤波器，例如强大的非局部均值（NLM）算法，可能会产生偏差并且表现不佳 [@problem_id:4553373]。优雅的解决方案是首先应用**[方差稳定变换](@entry_id:273381)（VST）**。这是一个精心选择的数学函数，它“[预扭曲](@entry_id:268351)”图像数据，将不规则的莱斯或泊松噪声转换成看起来更像行为良好的高斯噪声的东西。经过这种变换后，我们就可以自信地应用我们的标准[去噪](@entry_id:165626)工具了。最后，我们应用逆变换来得到我们干净的图像。这是将我们的方法适应数据物理学的一个 masterful 例子。

### 黄金法则：不要泄露信息

最后，我们必须考虑这些预处理步骤如何融入一个更大的数据分析流程中，尤其是一个涉及机器学习的流程。任何预测模型的完整性都取决于一个神圣的原则：测试数据在模型开发过程中必须保持完全不可见。使用测试集中的任何信息来构建或调整模型都会导致**信息泄露**，从而给人一种人为乐观且最终是虚假的模型性能感 [@problem_id:4568096]。

这一原则完全适用于预处理。想象一下，你正在计算z-score归一化的参数（$\mu$ 和 $\sigma$）。如果你从*整个数据集*（训练、验证和测试集合）计算这些值，你就允许了来自[测试集](@entry_id:637546)的信息——它的均值和标准差——影响了应用于每张图像的变换。你的模型已经“偷看”了测试数据。如果你通过观察哪个值在你的[测试集](@entry_id:637546)上效果最好来决定目标[重采样](@entry_id:142583)分辨率，情况也是如此。

这引出了机器学习流程中预处理的黄金法则：

**所有依赖于数据的预处理参数都必须*仅*从训练数据集中确定。**

你从[训练集](@entry_id:636396)中学习归一化统计数据、重采样目标以及任何其他数据驱动的参数。然后，你“冻结”这些参数，并将由此产生的固定变换应用于你的验证集和[测试集](@entry_id:637546)。这确保了你的[测试集](@entry_id:637546)仍然是一个真正独立的性能仲裁者，提供了一个关于你的模型在真实世界中表现如何的诚实和无偏的估计。这是将图像处理的复杂机制与[科学方法](@entry_id:143231)的严谨伦理联系起来的最后一个关键步骤。

