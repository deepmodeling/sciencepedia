## 引言
在科学研究中，估算一项治疗或暴露随时间推移的真实因果效应是最基本的挑战之一。在许多现实情境中，尤其是在医学和公共卫生领域，任何时刻应用治疗的决策都取决于患者的当前状态，而该状态本身又受到既往治疗的影响。这种动态过程产生了一种复杂的反馈循环，即“时变混杂”，传统的统计方法（如标准回归）无法正确解决这一问题。这些方法要么对混杂因素的控制不充分，要么错误地阻断了我们正希望研究的因果路径。

边际结构模型 (MSM) 为这一困境提供了一个精妙而有力的解决方案。本文将全面概述这一重要的因果推断技术。首先，在“原理与机制”一章中，我们将深入探讨 MSM 的理论基础。我们将剖析时变混杂问题，引入潜在结局的形式化语言来定义因果问题，并解释[逆概率](@entry_id:196307)加权 (IPW) 这一巧妙技巧如何让我们能够像在随机试验中一样估算因果效应。随后，“应用与跨学科联系”一章将把理论付诸实践，探索 MSM 如何被用于回答流行病学、肿瘤学、精神健康等领域的关键问题，并将其置于更广阔的统计方法图景中。

## 原理与机制

要真正理解自然机器的某一部分，我们必须愿意揭开其面纱一探究竟。像边际结构模型这样的概念，其美妙之处不在于其数学上的复杂性，而在于它所解决的问题的精妙简洁性——这个问题正处于理解因果关系随时间演变的核心。

### 时光旅行者的困境

想象一下，你是一名医生，正在治疗一位患有高血压或艾滋病等慢性病的患者。每次就诊时，你都会测量一个关键的生物标志物——比如血压 ($L_t$)——并决定是否开始或调整治疗 ($A_t$)。你上个月给予的治疗 $A_{t-1}$ 有望降低患者今天的血压。因此，你看到的血压 $L_t$ 是你过去行为的*结果*。但同样的血压读数又会影响你*今天*关于是否继续、停止或更改治疗 $A_t$ 的决策。当然，患者全年的血压状况会影响其最终的健康结局 ($Y$)，例如是否发生中风。

在这里，我们遇到了一个绝妙的悖论。生物标志物 $L_t$ 扮演着双重角色。它既是既往治疗到最终结局因果路径上的**中介变量**（即 $A_{t-1} \rightarrow L_t \rightarrow Y$），也是当前治疗与结局之间关系的**混杂因素**，因为它同时影响 $A_t$ 和 $Y$（即 $A_t \leftarrow L_t \rightarrow Y$）。这种错综复杂的情况被称为**受既往治疗影响的时变混杂** [@problem_id:4580923] [@problem_id:4617394]。

现在，假设我们想要分析患者记录以确定治疗是否有效。一种经典的统计方法是使用[回归模型](@entry_id:163386)来“校正”所有可能干扰我们分析的因素。但我们该如何处理 $L_t$ 呢？

如果我们在模型中包含血压以校正混杂，我们在某种意义上是将其“保持恒定”。但这样做，我们就阻碍了我们观察治疗起效的主要途径之一——即通过降低血压！我们将估算到的是*不*通过血压介导的治疗效应，而这并非我们关心的总效应。

另一方面，如果我们*不*在模型中包含血压，以观察其完整、未受阻碍的效应，我们又未能考虑到医生曾利用血压来做治疗决策。我们对[后期](@entry_id:165003)治疗的分析将变得无可救药地混杂。这是一个经典的“左右为难”情景。标准方法在此陷入困境。要摆脱困境，我们需要换一种方式提问。

### “如果……会怎样？”：定义因果问题

上一节的陷阱源于试图将一个动态的、现实世界的过程硬塞进一个静态的[统计模型](@entry_id:755400)中。我们真正想回答的问题，不是关于单次治疗剂量对特定血压患者的影响，而是一个更宏大的公共卫生问题：如果在我们整个人群中，每个人都在全年遵循一种特定的治疗策略，那么平均结局会是怎样？[@problem_id:4776647]

例如，我们可能想比较两种策略：
1.  策略 $\bar{a}$：始终给予治疗。
2.  策略 $\bar{a}'$：从不给予治疗。

在现代因果推断中，我们使用**潜在结局**的语言来形式化这个“如果……会怎样？”的问题。对于任何人，我们都可以想象一个潜在结局 $Y^{\bar{a}}$——即如果他们遵循了治疗策略 $\bar{a}$，他们*本会*经历的结局 [@problem_id:4581139]。我们的目标是估算这些潜在结局在人群中的平均值，例如 $E[Y^{\bar{a}}]$，它代表了如果每个人都遵循策略 $\bar{a}$，人群中的平均结局。

策略的效应就是对这些平均值的比较，例如 $E[Y^{\bar{a}}] - E[Y^{\bar{a}'}]$ [@problem_id:4581153]。这是一个**[边际效应](@entry_id:634982)**，因为我们是在整个人群中进行平均，而不是以每个个体曲折的经历（如他们特定的血压读数）为条件。

一个**边际结构模型 (MSM)** 不过是针对此潜在结局边际均值的一个模型。例如，我们可以假设一个简单的模型如下：
$$ \text{logit}(E[Y^{\bar{a}}]) = \beta_0 + \beta_1 \times (\text{number of treatments in } \bar{a}) $$
在这里，参数 $\beta_1$ 就是我们所追求的因果量。当然，挑战在于我们对每个人只能观察到一个现实；我们无法看到他们在所有其他策略下的潜在结局。那么我们如何估算这些参数呢？

### 用权重创造一个平行宇宙

我们的观测数据之所以难以分析，是因为治疗分配不是随机的，而是存在混杂。在理想的[随机对照试验 (RCT)](@entry_id:167109) 中，每一步都由抛硬币决定治疗方案，这样，无论健康还是病情较重的患者，在所有治疗组中平均而言都是平衡的。混杂因素将会消失。

虽然我们无法回到过去进行一项 RCT，但我们可以使用一个巧妙的统计技巧，让我们的观测数据*看起来像是*来自一项 RCT。这就是**逆概率加权 (IPW)** 的魔力。

其思想是为我们数据集中的每个人重新赋权。可以这样想：在现实世界中，一个血压很高的患者极有可能接受治疗。这就造成了混杂。为了打破这种关联，我们可以给予那些治疗分配出人意料的人更多的“话语权”或权重。例如：

-   一位高血压患者，偶然间*没有*接受治疗（一个罕见事件），他会得到一个较大的权重。
-   一位高血压患者，*确实*接受了治疗（一个常见事件），他会得到一个较小的权重。

通过系统地为每个人分配一个权重，该权重等于在给定其既往史的情况下，他接受实际所受治疗的概率的倒数，我们就创建了一个新的、加权的数据集——一个**伪群体**。在这个伪群体中，患者的既往史与其治疗之间的联系被打破了。这就好像在每个时间点，都是通过抛硬币来决定他们的治疗方案 [@problem_id:5036266] [@problem_id:4582725]。

每个人的权重是这些逆概率随时间推移的乘积。个体 $i$ 的（非稳定）权重为：
$$ w_i = \prod_{t=1}^{T} \frac{1}{P(A_{it} \mid \bar{A}_{i,t-1}, \bar{L}_{it})} $$
分母中的项 $P(A_{it} \mid \bar{A}_{i,t-1}, \bar{L}_{it})$ 是在给定已观察到的既往史的情况下，在时间点 $t$ 接受所观察到的治疗的概率。这通常被称为时变**倾向性得分**。

在实践中，这些权重有时会变得非常大，使我们的分析不稳定。一个简单的修正方法是使用**稳定权重**，其分子项依赖于既往治疗史，但不依赖于时变混杂因素。这可以在不改变根本结果的情况下减小权重的方差。例如，对于一个在所有三个时间点都接受了治疗（$A_1=1, A_2=1, A_3=1$）的参与者，如果每一步的边际治疗概率是 $0.5$，但他们基于个人史的特定概率分别是 $0.8, 0.6,$ 和 $0.4$，那么他的稳定权重将是 [@problem_id:4527047]：
$$ sW = \frac{0.5 \times 0.5 \times 0.5}{0.8 \times 0.6 \times 0.4} = \frac{0.125}{0.192} \approx 0.6510 $$

一旦我们有了这些权重，最后一步就异常简单了。我们使用标准回归（如逻辑回归）来拟合我们的 MSM——即因果效应模型，但我们要告诉软件，计算每个人时不是计为 1，而是计为他计算出的权重 $w_i$。因为我们分析的是无混杂的伪群体，所以这个加权回归的结果就是对因果效应的有效估计。

### 假设：游戏规则

这个精妙的方法很强大，但它不是魔法。它依赖于一些关于世界的关键且无法检验的假设。作为严谨的科学家，我们必须清楚地陈述它们。

1.  **序贯[可交换性](@entry_id:263314)（无未测量混杂因素）**：我们必须已经测量并正确地解释了*所有*作为未来治疗和结局[共同原因](@entry_id:266381)的时变因素 $L_t$。如果存在一个重要的未测量因素——比如患者未报告的动机，它既影响其依从性又影响其健康状况——我们的方法仍然可能存在偏倚。你所看不见的，依然可能伤害你 [@problem_id:4599479]。

2.  **正性**：在每个时间点，对于每一种可能的患者史，接受治疗或不接受治疗的概率都必须非零。举个例子，如果医生*总是*治疗那些血压超过某个临界值的患者，那么我们就没有任何关于这类患者如果*不*被治疗会发生什么的数据。我们的数据中存在一个“空洞”，如果不进行无法检验的外推，我们就无法估算这一群体的因果效应。这将导致我们的权重爆炸（除以零），标志着该假设不成立 [@problem_id:4581153]。

3.  **一致性**：这是一个更技术性的假设，它将潜在结局与观测数据联系起来。它指出，对于一个被观察到遵循了治疗策略 $\bar{a}$ 的个体，其观察到的结局恰好就是该策略下的潜在结局 $Y^{\bar{a}}$。

### 模型的宇宙

边际结构模型并非解决此问题的唯一工具，这恰恰说明了它们所解决问题的根本性。其他方法，如 **g-公式** 和 **结构[嵌套模型](@entry_id:635829) (SNMs)**，也旨在估算存在受治疗影响的时变混杂时的因果效应 [@problem_id:4590895] [@problem_id:4971140]。

-   **g-公式** 的工作方式是，显式地对时变混杂因素和结局的分布进行建模，然后通过模拟对它们进行积分，从而有效地标准化到一个遵循特定治疗策略的世界。
-   **SNMs** 采取了不同的路径，它不直接对最终结局建模，而是对每个时间点上*最后那一小部分*治疗的效应进行建模，并以个体史为条件。

这些不同的数学方法——IPW 创建一个伪群体，g-公式模拟一个新群体，以及 SNMs 从后向前追溯——都为了解决同一个时光旅行者的困境而存在，这揭示了因果推断原理深层次的统一性。它们是通往同一座顶峰的不同路径：在复杂、演变的世界中清晰地洞察因果关系。

