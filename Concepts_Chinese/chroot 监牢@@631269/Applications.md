## 应用与跨学科联系

这是一个非常简单的想法。对于一个正在运行的程序来说，文件和目录的整个世界是一棵树，从一个单点开始：根，用 `/` 表示。`chroot` 系统调用施展了一个看似简单的戏法：它为一个进程及其子进程改变了根目录的位置。这就像递给一个人一张伦敦的详细地图，并告诉他这是整个世界的地图。对于许多任务，比如从皮卡迪利广场找到去伦敦塔的路，这种有限的视野不仅足够，而且有帮助——它能防止他们在浩瀚的地球上迷路。

这一个简单的想法，“改变根目录”，其应用领域之广令人惊叹。它曾是数字架构师从零开始构建整个[操作系统](@entry_id:752937)的基础工具，是安全工程师守护面向互联网服务的门锁，甚至是一个警示故事，其缺点启发了驱动现代云计算的容器技术。`chroot` 的故事是一段穿越我们如何构建、保护和监控复杂软件系统核心的旅程。

### 炼金术士的法阵：在世界中构建世界

`chroot` 最基本、最优雅的应用或许在于解决一个经典的“鸡生蛋还是蛋生鸡”的问题：如何在一台已经运行着不同[操作系统](@entry_id:752937)的机器上构建一个新的[操作系统](@entry_id:752937)？想象一下，你想在你现有的计算机（“HostOS”）上创建一个新的 Linux 发行版，我们称之为“TargetOS”。如果你只是在 HostOS 上为 TargetOS 编译程序，编译器和链接器会自然地从 HostOS 中拾取库和头文件。最终生成的程序会被污染，依赖于宿主环境，并且在移到纯净的 TargetOS 环境时很可能会彻底失败。这是一个确保构建环境纯净且隔离的问题。[@problem_id:3634666]

当 TargetOS 的库就位于 HostOS 的中央时，你如何强制工具链使用它们呢？你可以创建一个目录，比如 `/srv/targetos`，并 meticulously地将 TargetOS 的基本库、头文件和工具放入其中。这个目录是一个羽翼未丰的宇宙，是最终系统的胚胎版本。然后，你使用 `chroot /srv/targetos`。

神奇的是，对于你刚启动的 shell 来说，世界变小了。路径 `/` 不再指向你的 HostOS 的根目录，而是指向 `/srv/targetos`。目录 `/lib` 现在是 TargetOS 的库目录，而不是宿主的。在这个袖珍维度中，你可以编译 TargetOS 的其余部分，确信工具链只能看到它自己的世界。这项技术是引导（bootstrapping）的基石——即系统自我构建的过程。你从宿主上的一个[交叉编译](@entry_id:748066)器开始，为目标构建一个最小的工具链，`chroot` 到目标目录中，然后使用该最小工具链来构建完整的本地系统。这是一个优美的递归过程，就像一个细胞利用其初始的遗传机制来构建一个完整的生物体。[@problem_id:3634627]

### 戒备森严的大门：通过狭窄视野实现安全

同样是这种隔离，既能保证软件构建的纯净，也是一个强大的安全工具。如果有限的[文件系统](@entry_id:749324)视图可以防止意外污染，那么它也可以防止恶意入侵。这就是使用 `chroot` 作为不受信任或用途有限的进程的“监牢”背后的原理。

考虑一个常见场景：你需要授予一个用户通过 SFTP 上传和下载文件的能力，但绝不能允许他们浏览服务器的文件系统。OpenSSH 服务器为此提供了一个绝佳的功能：`ChrootDirectory` 指令。当用户登录时，SSH 守护进程可以使用 `chroot` 将他们的会话限制在他们的主目录中。对于该用户来说，[文件系统](@entry_id:749324)的起点和终点都在他们的个人文件夹里；像 `/etc` 或 `/bin` 这样的敏感目录不仅无法访问，而且是不可见的。[@problem_id:3673392]

这个想法在“权限分离”的设计原则中得到了进一步发展，该原则在 OpenSSH 中得到了著名的实现。[@problem_id:3689496] 处理来自公共互联网的网络请求是一项高风险业务。解析复杂协议的代码是一个巨大的攻击面。OpenSSH 的解决方案非常巧妙：需要 root 权限以监听特权网络端口 22 的主进程，其本身做的事情很少。在收到连接后，它立即派生一个子进程。这个子进程脱下其强大的外袍，将其用户 ID 降级为一个无权力的专用用户。然后，它自愿进入一个空的 `chroot` 监牢。只有到那时，它才开始与不受信任的客户端进行危险的通信工作。如果攻击者在这段代码中发现了一个漏洞，他们会发现自己身处一个贫瘠的监狱：他们没有特殊权限，也看不到[文件系统](@entry_id:749324)。损害得到了控制。这是对[最小权限原则](@entry_id:753740)的一次精湛应用。

### 墙壁上的裂缝：简单监牢的局限性

但是，一个 `chroot` 监牢是一个完美的监狱吗？其优雅的简洁性也是它的主要弱点。它被设计用来改变[文件系统](@entry_id:749324)根目录，并且它只做这一件事。它从未打算成为一个完整的安全沙箱，把它当成沙箱是一个危险的错误。

`chroot` 调用改变了一个进程对[文件系统](@entry_id:749324)的看法，但它没有改变其用户 ID。一个以 root 权限进入监牢的进程仍然是一个 root 进程。一个聪明的 root 进程通常能找到逃脱的方法。例如，它可能有足够的权限创建一个设备节点并访问原始磁盘，从而完全绕过文件系统抽象，或者它可能利用在进入监牢*之前*就已打开的文件描述符。[@problem_id:3685772] [@problem_id:3664841]

此外，`chroot` 只隔离了[文件系统](@entry_id:749324)视图。被监禁的进程仍然与系统的其余部分共享相同的进程表、网络堆栈和用户 ID。它可以向其他进程发送信号，并自由地打开网络连接。这种不完整性导致安全研究人员发现了一类被称为[检查时-使用时](@entry_id:756030)（time-of-check-to-time-of-use, [TOCTTOU](@entry_id:756030)）攻击的漏洞。一个特权程序可能被欺骗：它检查一个路径是安全的（例如，在监牢内），但在它打开文件之前，攻击者迅速将该路径替换为一个指向监牢外敏感文件（如 `/etc/passwd`）的[符号链接](@entry_id:755709)。特权程序跟随这个链接，盲目地对敏感文件执行其操作。[@problem_id:3664841] 事实证明，监牢的墙壁并不像看上去那么坚固。

### 从监牢到宇宙：`chroot` 的遗产

`chroot` 的局限性不是失败，而是一个教训。它们揭示了一个更深层次的真理：要真正隔离一个进程，你必须[虚拟化](@entry_id:756508)它的整个宇宙。这个教训是容器革命的种子。

最初的 `chroot` 可以被看作是第一个、最原始的“命名空间”——一个[挂载命名空间](@entry_id:752191)。现代 Linux 容器极大地扩展了这个想法。它们不仅为[文件系统](@entry_id:749324)提供独立的命名空间，还为进程 ID（一个容器可以有自己的 [PID](@entry_id:174286) 为 1 的进程）、网络堆栈（一个容器可以有自己的 IP 地址）、用户 ID 等等提供了独立的命名空间。

当像 [Docker](@entry_id:262723) 这样的容器运行时启动一个容器时，它执行了一系列操作的交响乐，这些操作都是 `chroot` 的直系后代。它使用一个更强大的系统调用 `pivot_root` 来设置一个新的根[文件系统](@entry_id:749324)，然后将[进程隔离](@entry_id:753779)在一系列其他全新的命名空间内。[@problem_id:3642399] 这创建了一个比单独使用 `chroot` 所能提供的远为稳健和全面的监狱。现代容器内的进程不仅仅是在一个不同的房间里；它在一个不同的宇宙里，不知道同一台机器上还存在其他宇宙。从一个简单的 `chroot` 到 [Kubernetes](@entry_id:751069) 的复杂编排，这是一条直接的知识传承路线，每一步都建立在之前教训的基础之上。

### 煤矿中的金丝雀：`chroot` 作为取证信号

故事还有最后一个引人入胜的转折。我们已经看到 `chroot` 及其后继者 `pivot_root` 在非常具体、众所周知的情况下被合法使用：系统引导、容器启动以及像 SSH 这样的服务。系统管理员知道何时何地会预期这些调用。

那么，当一个 `chroot` 调用凭空出现，来自一个从未进行过此类调用的长期运行的 Web 服务器进程时，这意味着什么？这是一个刺耳的警钟。

已经攻破一个进程的攻击者可能会使用 `chroot` 为自己的工具创建一个隐藏的环境，试图掩盖他们的踪迹，或者为进一步的攻击准备一个集结地。因为合法使用是如此可预测，一个意外的 `chroot` 调用就成了一个高保真的入侵信号。现代[入侵检测](@entry_id:750791)系统（IDS）可以配置一条简单而强大的规则：“对任何并非在生命周期的最初几秒内由已知容器运行时或系统服务发起的 `chroot` 或 `pivot_root` 调用发出警报。”[@problem_id:3650757] 在一个绝妙的反转中，这个用于构建和防御系统的工具，一旦落入坏人之手，就变成了攻击者的法证指纹。

从一个改变路径字符串的简单技巧开始，我们穿越了计算的广阔领域。我们看到了世界的构建、堡垒的防御、幻象的破灭以及新技术的诞生。小小的 `chroot` 不仅仅是一个系统调用；它证明了最深远的结果可以源于最简单的思想，也证明了理解我们工具的局限性是通往下一个伟大发现的最可靠途径。