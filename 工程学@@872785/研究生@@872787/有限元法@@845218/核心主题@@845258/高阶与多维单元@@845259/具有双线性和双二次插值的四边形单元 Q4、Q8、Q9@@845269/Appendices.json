{"hands_on_practices": [{"introduction": "要真正掌握高阶单元，我们必须超越对形函数公式的死记硬背。本练习将引导您从一维拉格朗日多项式出发，通过张量积的方法，从第一性原理构建九节点双二次（$Q9$）单元的形函数。这个过程不仅能加深您对张量积构造方法的理解，还能让您亲手验证单元一致性的基石——单位分解（partition of unity）等关键性质 [@problem_id:2592295]。", "problem": "在等参有限元法 (FEM) 中，九节点四边形 ($Q9$) 单元使用双二次插值，该插值由定义在局部坐标为 $(\\xi,\\eta)\\in[-1,1]\\times[-1,1]$ 的参考域上的一维二次 Lagrange 多项式的张量积构成。考虑参考域中的典范节点布局，其节点位置由下式给出：\n- 节点 $1$: $(-1,-1)$，节点 $2$: $(+1,-1)$，节点 $3$: $(+1,+1)$，节点 $4$: $(-1,+1)$，\n- 节点 $5$: $(0,-1)$，节点 $6$: $(+1,0)$，节点 $7$: $(0,+1)$，节点 $8$: $(-1,0)$，\n- 节点 $9$: $(0,0)$。\n\n从一维二次 Lagrange 基多项式 $\\ell_{-1}(\\zeta)$、$\\ell_{0}(\\zeta)$ 和 $\\ell_{+1}(\\zeta)$ 满足基本插值性质 $\\ell_{a}(b)=\\delta_{ab}$（其中 $a,b\\in\\{-1,0,+1\\}$）出发，推导二维 $Q9$ 形函数 $N_i(\\xi,\\eta)$，其形式为这些一维多项式的张量积。然后计算它们关于 $\\xi$ 和 $\\eta$ 的一阶导数。\n\n仅使用这些推导出的表达式（不使用任何预先记忆的单元公式），进行以下验证：\n- 证明单位分解性质成立，即对于参考域中的所有 $(\\xi,\\eta)$，$\\sum_{i=1}^{9} N_i(\\xi,\\eta)=1$。\n- 证明在每个节点上都满足克罗内克-delta 性质，即对于所有 $i,j\\in\\{1,\\dots,9\\}$，有 $N_i(\\xi_j,\\eta_j)=\\delta_{ij}$。\n- 证明梯度满足 $\\sum_{i=1}^{9}\\frac{\\partial N_i}{\\partial \\xi}(\\xi,\\eta)=0$ 和 $\\sum_{i=1}^{9}\\frac{\\partial N_i}{\\partial \\eta}(\\xi,\\eta)=0$ 对于参考域中的所有 $(\\xi,\\eta)$ 成立。\n- 在点 $(-1,-1)$、$(+1,-1)$、$(+1,+1)$、$(-1,+1)$、$(0,-1)$、$(+1,0)$、$(0,+1)$、$(-1,0)$ 和 $(0,0)$ 处显式验证节点和边中点的取值。\n\n最后，在任意点 $(\\xi,\\eta)=\\left(\\frac{1}{3},-\\frac{1}{2}\\right)$，使用您推导的公式计算 $N_2(\\xi,\\eta)$、$\\frac{\\partial N_5}{\\partial \\xi}(\\xi,\\eta)$ 和 $\\frac{\\partial N_7}{\\partial \\eta}(\\xi,\\eta)$ 的值，并报告标量\n$$\nQ \\;=\\; N_2\\!\\left(\\tfrac{1}{3},-\\tfrac{1}{2}\\right) \\;+\\; 3\\,\\frac{\\partial N_5}{\\partial \\xi}\\!\\left(\\tfrac{1}{3},-\\tfrac{1}{2}\\right) \\;-\\; 2\\,\\frac{\\partial N_7}{\\partial \\eta}\\!\\left(\\tfrac{1}{3},-\\tfrac{1}{2}\\right).\n$$\n的精确值。提供 $Q$ 的精确值（不进行四舍五入）。不包含单位。", "solution": "该问题陈述已经过严格评估，并被认为是有效的。这是一个有限元方法框架内的标准、适定的问题，没有科学上的不准确性、逻辑矛盾或定义不明确的术语。我们将按要求进行推导和验证。\n\n首先，我们推导定义在区间 $\\zeta \\in [-1, 1]$ 上，节点位于 $\\{-1, 0, +1\\}$ 的一维二次 Lagrange 基多项式 $\\ell_k(\\zeta)$。这些多项式必须满足性质 $\\ell_a(b) = \\delta_{ab}$，其中 $a, b \\in \\{-1, 0, +1\\}$，$\\delta_{ab}$ 是克罗内克 delta。\n\n对应于节点 $\\zeta = -1$ 的多项式记为 $\\ell_{-1}(\\zeta)$。它在 $\\zeta=0$ 和 $\\zeta=1$ 处必须为零，在 $\\zeta=-1$ 处必须为1。\n$$ \\ell_{-1}(\\zeta) = \\frac{(\\zeta-0)(\\zeta-1)}{(-1-0)(-1-1)} = \\frac{\\zeta(\\zeta-1)}{2} = \\frac{1}{2}(\\zeta^2 - \\zeta) $$\n对应于节点 $\\zeta = 0$ 的多项式为 $\\ell_{0}(\\zeta)$。它在 $\\zeta=-1$ 和 $\\zeta=1$ 处必须为零，在 $\\zeta=0$ 处必须为1。\n$$ \\ell_{0}(\\zeta) = \\frac{(\\zeta - (-1))(\\zeta-1)}{(0 - (-1))(0-1)} = \\frac{(\\zeta+1)(\\zeta-1)}{-1} = 1-\\zeta^2 $$\n对应于节点 $\\zeta = +1$ 的多项式为 $\\ell_{+1}(\\zeta)$。它在 $\\zeta=-1$ 和 $\\zeta=0$ 处必须为零，在 $\\zeta=1$ 处必须为1。\n$$ \\ell_{+1}(\\zeta) = \\frac{(\\zeta - (-1))(\\zeta-0)}{(1 - (-1))(1-0)} = \\frac{\\zeta(\\zeta+1)}{2} = \\frac{1}{2}(\\zeta^2 + \\zeta) $$\n它们关于 $\\zeta$ 的一阶导数是：\n$$ \\ell'_{-1}(\\zeta) = \\frac{d}{d\\zeta}\\left(\\frac{1}{2}(\\zeta^2 - \\zeta)\\right) = \\frac{1}{2}(2\\zeta - 1) $$\n$$ \\ell'_{0}(\\zeta) = \\frac{d}{d\\zeta}(1-\\zeta^2) = -2\\zeta $$\n$$ \\ell'_{+1}(\\zeta) = \\frac{d}{d\\zeta}\\left(\\frac{1}{2}(\\zeta^2 + \\zeta)\\right) = \\frac{1}{2}(2\\zeta + 1) $$\n\n$Q9$ 单元的二维形函数 $N_i(\\xi, \\eta)$ 是由这些一维多项式的张量积形成的。一个局部坐标为 $(\\xi_i, \\eta_i)$ 的节点 $i$（其中 $\\xi_i, \\eta_i \\in \\{-1, 0, +1\\}$）有其对应的形函数，由 $N_i(\\xi, \\eta) = \\ell_{\\xi_i}(\\xi)\\ell_{\\eta_i}(\\eta)$ 给出。节点编号与坐标对的映射如下：\n$1:(-1,-1)$, $2:(+1,-1)$, $3:(+1,+1)$, $4:(-1,+1)$, $5:(0,-1)$, $6:(+1,0)$, $7:(0,+1)$, $8:(-1,0)$, $9:(0,0)$。\n因此，形函数为：\n$N_1(\\xi, \\eta) = \\ell_{-1}(\\xi)\\ell_{-1}(\\eta) = \\frac{1}{4}(\\xi^2-\\xi)(\\eta^2-\\eta)$\n$N_2(\\xi, \\eta) = \\ell_{+1}(\\xi)\\ell_{-1}(\\eta) = \\frac{1}{4}(\\xi^2+\\xi)(\\eta^2-\\eta)$\n$N_3(\\xi, \\eta) = \\ell_{+1}(\\xi)\\ell_{+1}(\\eta) = \\frac{1}{4}(\\xi^2+\\xi)(\\eta^2+\\eta)$\n$N_4(\\xi, \\eta) = \\ell_{-1}(\\xi)\\ell_{+1}(\\eta) = \\frac{1}{4}(\\xi^2-\\xi)(\\eta^2+\\eta)$\n$N_5(\\xi, \\eta) = \\ell_{0}(\\xi)\\ell_{-1}(\\eta) = \\frac{1}{2}(1-\\xi^2)(\\eta^2-\\eta)$\n$N_6(\\xi, \\eta) = \\ell_{+1}(\\xi)\\ell_{0}(\\eta) = \\frac{1}{2}(\\xi^2+\\xi)(1-\\eta^2)$\n$N_7(\\xi, \\eta) = \\ell_{0}(\\xi)\\ell_{+1}(\\eta) = \\frac{1}{2}(1-\\xi^2)(\\eta^2+\\eta)$\n$N_8(\\xi, \\eta) = \\ell_{-1}(\\xi)\\ell_{0}(\\eta) = \\frac{1}{2}(\\xi^2-\\xi)(1-\\eta^2)$\n$N_9(\\xi, \\eta) = \\ell_{0}(\\xi)\\ell_{0}(\\eta) = (1-\\xi^2)(1-\\eta^2)$\n\n一阶导数为 $\\frac{\\partial N_i}{\\partial \\xi} = \\ell'_{\\xi_i}(\\xi)\\ell_{\\eta_i}(\\eta)$ 和 $\\frac{\\partial N_i}{\\partial \\eta} = \\ell_{\\xi_i}(\\xi)\\ell'_{\\eta_i}(\\eta)$。\n\n我们现在进行所要求的验证。\n\n1.  单位分解性质：$\\sum_{i=1}^{9} N_i(\\xi,\\eta) = 1$。\n    使用张量积结构：\n    $$ \\sum_{i=1}^{9} N_i(\\xi, \\eta) = \\sum_{k \\in \\{-1,0,1\\}} \\sum_{l \\in \\{-1,0,1\\}} \\ell_k(\\xi) \\ell_l(\\eta) = \\left(\\sum_{k \\in \\{-1,0,1\\}} \\ell_k(\\xi)\\right) \\left(\\sum_{l \\in \\{-1,0,1\\}} \\ell_l(\\eta)\\right) $$\n    一维多项式之和为：\n    $$ \\sum_{k \\in \\{-1,0,1\\}} \\ell_k(\\zeta) = \\frac{1}{2}(\\zeta^2 - \\zeta) + (1-\\zeta^2) + \\frac{1}{2}(\\zeta^2 + \\zeta) = \\left(\\frac{1}{2}-1+\\frac{1}{2}\\right)\\zeta^2 + \\left(-\\frac{1}{2}+\\frac{1}{2}\\right)\\zeta + 1 = 1 $$\n    因此，$\\sum_{i=1}^{9} N_i(\\xi, \\eta) = (1)(1) = 1$。单位分解性质得到验证。\n\n2.  克罗内克-delta 性质：$N_i(\\xi_j,\\eta_j)=\\delta_{ij}$。\n    设节点 $i$ 对应坐标 $(\\xi_k, \\eta_l)$，节点 $j$ 对应坐标 $(\\xi_m, \\eta_n)$，其中 $k, l, m, n \\in \\{-1, 0, 1\\}$。\n    节点 $i$ 的形函数为 $N_i(\\xi, \\eta) = \\ell_k(\\xi)\\ell_l(\\eta)$。\n    在节点 $j$ 处求值：$N_i(\\xi_j, \\eta_j) = \\ell_k(\\xi_m)\\ell_l(\\eta_n) = \\delta_{km}\\delta_{ln}$。\n    该乘积仅当 $k=m$ 且 $l=n$ 时为 $1$，这意味着节点 $i$ 和 $j$ 是同一个节点。否则，该乘积为 $0$。因此，$N_i(\\xi_j,\\eta_j)=\\delta_{ij}$。\n    作为一个显式验证，考虑 $N_5(\\xi, \\eta) = \\ell_0(\\xi)\\ell_{-1}(\\eta) = (1-\\xi^2) \\frac{1}{2}\\eta(\\eta-1)$。\n    在节点 5，$(\\xi_5, \\eta_5) = (0, -1)$：$N_5(0,-1) = (1-0^2) \\frac{1}{2}(-1)(-1-1) = (1)\\frac{1}{2}(-1)(-2) = 1$。\n    在节点 1，$(\\xi_1, \\eta_1) = (-1, -1)$：$N_5(-1,-1) = (1-(-1)^2) \\frac{1}{2}(-1)(-2) = (0)(\\dots) = 0$。\n    在节点 9，$(\\xi_9, \\eta_9) = (0, 0)$：$N_5(0,0) = (1-0^2) \\frac{1}{2}(0)(0-1) = (1)(0) = 0$。\n    该性质成立。\n\n3.  梯度之和性质：$\\sum_{i=1}^{9}\\frac{\\partial N_i}{\\partial \\xi}=0$ 和 $\\sum_{i=1}^{9}\\frac{\\partial N_i}{\\partial \\eta}=0$。\n    这可由对单位分解性质求导得出：\n    $$ \\frac{\\partial}{\\partial \\xi} \\left(\\sum_{i=1}^{9} N_i(\\xi, \\eta)\\right) = \\frac{\\partial}{\\partial \\xi}(1) = 0 \\implies \\sum_{i=1}^{9} \\frac{\\partial N_i}{\\partial \\xi}(\\xi, \\eta) = 0 $$\n    $$ \\frac{\\partial}{\\partial \\eta} \\left(\\sum_{i=1}^{9} N_i(\\xi, \\eta)\\right) = \\frac{\\partial}{\\partial \\eta}(1) = 0 \\implies \\sum_{i=1}^{9} \\frac{\\partial N_i}{\\partial \\eta}(\\xi, \\eta) = 0 $$\n    或者，使用张量积展开式：\n    $$ \\sum_{i=1}^{9} \\frac{\\partial N_i}{\\partial \\xi} = \\left(\\sum_{k \\in \\{-1,0,1\\}} \\ell'_k(\\xi)\\right) \\left(\\sum_{l \\in \\{-1,0,1\\}} \\ell_l(\\eta)\\right) $$\n    一维导数之和为 $\\sum_k \\ell'_k(\\zeta) = \\frac{1}{2}(2\\zeta - 1) + (-2\\zeta) + \\frac{1}{2}(2\\zeta + 1) = (\\zeta-\\frac{1}{2})-2\\zeta+(\\zeta+\\frac{1}{2}) = 0$。\n    由于 $\\sum_l \\ell_l(\\eta) = 1$，我们有 $\\sum_i \\frac{\\partial N_i}{\\partial \\xi} = (0)(1) = 0$。根据对称性，$\\sum_i \\frac{\\partial N_i}{\\partial \\eta} = 0$。验证完成。\n\n最后，我们计算在 $(\\xi, \\eta) = (\\frac{1}{3}, -\\frac{1}{2})$ 处的量 $Q$。\n$$ Q = N_2\\left(\\tfrac{1}{3},-\\tfrac{1}{2}\\right) + 3\\,\\frac{\\partial N_5}{\\partial \\xi}\\left(\\tfrac{1}{3},-\\tfrac{1}{2}\\right) - 2\\,\\frac{\\partial N_7}{\\partial \\eta}\\left(\\tfrac{1}{3},-\\tfrac{1}{2}\\right) $$\n我们需要 $N_2$、$\\frac{\\partial N_5}{\\partial \\xi}$ 和 $\\frac{\\partial N_7}{\\partial \\eta}$ 的表达式。\n$N_2(\\xi, \\eta) = \\ell_{+1}(\\xi)\\ell_{-1}(\\eta) = \\frac{1}{2}\\xi(\\xi+1) \\cdot \\frac{1}{2}\\eta(\\eta-1) = \\frac{1}{4}\\xi(\\xi+1)\\eta(\\eta-1)$。\n$\\frac{\\partial N_5}{\\partial \\xi}(\\xi, \\eta) = \\ell'_{0}(\\xi)\\ell_{-1}(\\eta) = (-2\\xi) \\cdot \\frac{1}{2}\\eta(\\eta-1) = -\\xi\\eta(\\eta-1)$。\n$\\frac{\\partial N_7}{\\partial \\eta}(\\xi, \\eta) = \\ell_{0}(\\xi)\\ell'_{+1}(\\eta) = (1-\\xi^2) \\cdot \\frac{1}{2}(2\\eta+1)$。\n\n现在，我们在 $(\\xi, \\eta) = (\\frac{1}{3}, -\\frac{1}{2})$ 处对它们进行求值。\n$N_2(\\frac{1}{3}, -\\frac{1}{2}) = \\frac{1}{4}(\\frac{1}{3})(\\frac{1}{3}+1)(-\\frac{1}{2})(-\\frac{1}{2}-1) = \\frac{1}{4}(\\frac{1}{3})(\\frac{4}{3})(-\\frac{1}{2})(-\\frac{3}{2}) = \\frac{1}{4} \\cdot \\frac{4}{9} \\cdot \\frac{3}{4} = \\frac{1}{12}$。\n\n$\\frac{\\partial N_5}{\\partial \\xi}(\\frac{1}{3}, -\\frac{1}{2}) = -(\\frac{1}{3})(-\\frac{1}{2})(-\\frac{1}{2}-1) = -(\\frac{1}{3})(-\\frac{1}{2})(-\\frac{3}{2}) = -\\frac{3}{12} = -\\frac{1}{4}$。\n\n$\\frac{\\partial N_7}{\\partial \\eta}(\\frac{1}{3}, -\\frac{1}{2}) = (1-(\\frac{1}{3})^2) \\cdot \\frac{1}{2}(2(-\\frac{1}{2})+1) = (1-\\frac{1}{9}) \\cdot \\frac{1}{2}(-1+1) = (\\frac{8}{9}) \\cdot 0 = 0$。\n\n将这些值代入 $Q$ 的表达式中：\n$Q = \\frac{1}{12} + 3\\left(-\\frac{1}{4}\\right) - 2(0) = \\frac{1}{12} - \\frac{3}{4} = \\frac{1}{12} - \\frac{9}{12} = -\\frac{8}{12} = -\\frac{2}{3}$。\n所求的标量被计算为一个精确分数。", "answer": "$$\n\\boxed{-\\frac{2}{3}}\n$$", "id": "2592295"}, {"introduction": "形函数不仅用于插值位移场，在等参单元中，它同样被用来描述几何形状。本练习的核心是探讨从参考单元到物理单元的等参映射，特别是雅可比行列式（Jacobian determinant）在其中的关键作用。通过分析一个简单的四边形单元（Q4），您将计算并比较顺时针与逆时针节点编号对雅可比行列式符号的影响，从而理解为何保持正确的节点顺序对于避免单元反转至关重要 [@problem_id:2592296]。", "problem": "在用于四节点等参四边形 (Q4) 的等参有限元法 (FEM) 中，从具有局部坐标 $(\\xi,\\eta)\\in[-1,1]\\times[-1,1]$ 和标准参考节点位置 $(-1,-1)$、$(1,-1)$、$(1,1)$、$(-1,1)$ 的参考正方形到物理单元的映射由双线性插值定义\n$$\nx(\\xi,\\eta)=\\sum_{i=1}^{4} N_i(\\xi,\\eta)\\,x_i,\\quad\ny(\\xi,\\eta)=\\sum_{i=1}^{4} N_i(\\xi,\\eta)\\,y_i,\n$$\n其雅可比矩阵为\n$$\n\\mathbf{J}(\\xi,\\eta)=\n\\begin{pmatrix}\n\\frac{\\partial x}{\\partial \\xi}  \\frac{\\partial x}{\\partial \\eta} \\\\[4pt]\n\\frac{\\partial y}{\\partial \\xi}  \\frac{\\partial y}{\\partial \\eta}\n\\end{pmatrix}.\n$$\n考虑一个凸物理四边形，其顶点坐标为\n$$\n\\mathbf{P}_1=(0,0),\\quad \\mathbf{P}_2=(3,0),\\quad \\mathbf{P}_3=(4,2),\\quad \\mathbf{P}_4=(0,1).\n$$\n定义两种节点编号情况，将这些物理点分配给 Q4 节点：\n- 情况 CCW：节点 $1,2,3,4$ 分别映射到 $\\mathbf{P}_1,\\mathbf{P}_2,\\mathbf{P}_3,\\mathbf{P}_4$（逆时针遍历）。\n- 情况 CW：节点 $1,2,3,4$ 分别映射到 $\\mathbf{P}_1,\\mathbf{P}_4,\\mathbf{P}_3,\\mathbf{P}_2$（顺时针遍历）。\n\n仅使用上述基本定义和参考正方形上 Q4 的标准双线性形函数，计算行列式\n$$\n\\det\\mathbf{J}_{\\mathrm{CCW}}(0,0)\\quad \\text{和}\\quad \\det\\mathbf{J}_{\\mathrm{CW}}(0,0),\n$$\n然后求比值\n$$\nr=\\frac{\\det\\mathbf{J}_{\\mathrm{CW}}(0,0)}{\\det\\mathbf{J}_{\\mathrm{CCW}}(0,0)}.\n$$\n将 $r$ 的最终结果表示为一个无单位的纯数。无需四舍五入。在您的推导中，指明哪种节点编号约定通过确保整个单元的雅可比行列式为正来避免单元反转。最终答案应仅为 $r$ 的值。", "solution": "所提出的问题是等参有限元理论中的一个标准练习。该问题是适定的、有科学依据的，并包含唯一解所需的所有必要信息。我们将开始推导。\n\n从 $(\\xi, \\eta)$ 局部坐标系中 $\\xi, \\eta \\in [-1, 1]$ 的参考单元（一个正方形）到 $(x, y)$ 坐标系中的物理单元的映射由下式给出\n$$x(\\xi,\\eta)=\\sum_{i=1}^{4} N_i(\\xi,\\eta)\\,x_i$$\n$$y(\\xi,\\eta)=\\sum_{i=1}^{4} N_i(\\xi,\\eta)\\,y_i$$\n其中 $(x_i, y_i)$ 是物理单元第 $i$ 个节点的坐标。四节点四边形单元 (Q4) 的标准双线性形函数是相对于参考节点 $1(-1,-1)$、$2(1,-1)$、$3(1,1)$ 和 $4(-1,1)$ 定义的，如下所示：\n$$N_1(\\xi, \\eta) = \\frac{1}{4}(1-\\xi)(1-\\eta)$$\n$$N_2(\\xi, \\eta) = \\frac{1}{4}(1+\\xi)(1-\\eta)$$\n$$N_3(\\xi, \\eta) = \\frac{1}{4}(1+\\xi)(1+\\eta)$$\n$$N_4(\\xi, \\eta) = \\frac{1}{4}(1-\\xi)(1+\\eta)$$\n此变换的雅可比矩阵为\n$$\n\\mathbf{J}(\\xi,\\eta)=\n\\begin{pmatrix}\n\\sum_{i=1}^{4} \\frac{\\partial N_i}{\\partial \\xi} x_i  \\sum_{i=1}^{4} \\frac{\\partial N_i}{\\partial \\eta} x_i \\\\[4pt]\n\\sum_{i=1}^{4} \\frac{\\partial N_i}{\\partial \\xi} y_i  \\sum_{i=1}^{4} \\frac{\\partial N_i}{\\partial \\eta} y_i\n\\end{pmatrix}\n$$\n为了计算单元中心 $(\\xi, \\eta) = (0,0)$ 处的雅可比矩阵，我们首先计算形函数的偏导数并在此点求值。\n导数是：\n$$\\frac{\\partial N_1}{\\partial \\xi} = -\\frac{1}{4}(1-\\eta), \\quad \\frac{\\partial N_1}{\\partial \\eta} = -\\frac{1}{4}(1-\\xi)$$\n$$\\frac{\\partial N_2}{\\partial \\xi} = \\frac{1}{4}(1-\\eta), \\quad \\frac{\\partial N_2}{\\partial \\eta} = -\\frac{1}{4}(1+\\xi)$$\n$$\\frac{\\partial N_3}{\\partial \\xi} = \\frac{1}{4}(1+\\eta), \\quad \\frac{\\partial N_3}{\\partial \\eta} = \\frac{1}{4}(1+\\xi)$$\n$$\\frac{\\partial N_4}{\\partial \\xi} = -\\frac{1}{4}(1+\\eta), \\quad \\frac{\\partial N_4}{\\partial \\eta} = \\frac{1}{4}(1-\\xi)$$\n在 $(\\xi, \\eta) = (0,0)$ 处，这些导数变为：\n$$\\frac{\\partial N_1}{\\partial \\xi}\\Big|_{(0,0)}=-\\frac{1}{4}, \\quad \\frac{\\partial N_2}{\\partial \\xi}\\Big|_{(0,0)}=\\frac{1}{4}, \\quad \\frac{\\partial N_3}{\\partial \\xi}\\Big|_{(0,0)}=\\frac{1}{4}, \\quad \\frac{\\partial N_4}{\\partial \\xi}\\Big|_{(0,0)}=-\\frac{1}{4}$$\n$$\\frac{\\partial N_1}{\\partial \\eta}\\Big|_{(0,0)}=-\\frac{1}{4}, \\quad \\frac{\\partial N_2}{\\partial \\eta}\\Big|_{(0,0)}=-\\frac{1}{4}, \\quad \\frac{\\partial N_3}{\\partial \\eta}\\Big|_{(0,0)}=\\frac{1}{4}, \\quad \\frac{\\partial N_4}{\\partial \\eta}\\Big|_{(0,0)}=\\frac{1}{4}$$\n将这些代入 $(\\xi, \\eta) = (0,0)$ 处雅可比矩阵的表达式中，我们得到：\n$$\n\\mathbf{J}(0,0) = \\frac{1}{4}\n\\begin{pmatrix}\n-x_1+x_2+x_3-x_4  -x_1-x_2+x_3+x_4 \\\\[4pt]\n-y_1+y_2+y_3-y_4  -y_1-y_2+y_3+y_4\n\\end{pmatrix}\n$$\n现在，我们分析两种指定的节点编号情况。\n\n情况 CCW：节点 $1,2,3,4$ 分别映射到 $\\mathbf{P}_1, \\mathbf{P}_2, \\mathbf{P}_3, \\mathbf{P}_4$。\n物理坐标为：\n$(x_1, y_1) = (0,0)$\n$(x_2, y_2) = (3,0)$\n$(x_3, y_3) = (4,2)$\n$(x_4, y_4) = (0,1)$\n我们计算雅可比矩阵 $\\mathbf{J}_{\\mathrm{CCW}}(0,0)$ 的分量：\n$$J_{11} = \\frac{1}{4}(-0+3+4-0) = \\frac{7}{4}$$\n$$J_{12} = \\frac{1}{4}(-0-3+4+0) = \\frac{1}{4}$$\n$$J_{21} = \\frac{1}{4}(-0+0+2-1) = \\frac{1}{4}$$\n$$J_{22} = \\frac{1}{4}(-0-0+2+1) = \\frac{3}{4}$$\n因此，雅可比矩阵为\n$$\n\\mathbf{J}_{\\mathrm{CCW}}(0,0) =\n\\begin{pmatrix}\n\\frac{7}{4}  \\frac{1}{4} \\\\[4pt]\n\\frac{1}{4}  \\frac{3}{4}\n\\end{pmatrix}\n$$\n行列式为\n$$\n\\det\\mathbf{J}_{\\mathrm{CCW}}(0,0) = \\left(\\frac{7}{4}\\right)\\left(\\frac{3}{4}\\right) - \\left(\\frac{1}{4}\\right)\\left(\\frac{1}{4}\\right) = \\frac{21}{16} - \\frac{1}{16} = \\frac{20}{16} = \\frac{5}{4}\n$$\n行列式的正号证实了该映射保持了方向性。参考单元中节点的逆时针遍历映射到物理单元中节点的逆时针遍历。这是避免生成反转或“内外翻转”单元的正确约定。\n\n情况 CW：节点 $1,2,3,4$ 分别映射到 $\\mathbf{P}_1, \\mathbf{P}_4, \\mathbf{P}_3, \\mathbf{P}_2$。\n物理坐标为：\n$(x_1, y_1) = (0,0)$\n$(x_2, y_2) = (0,1)$\n$(x_3, y_3) = (4,2)$\n$(x_4, y_4) = (3,0)$\n我们计算雅可比矩阵 $\\mathbf{J}_{\\mathrm{CW}}(0,0)$ 的分量：\n$$J_{11} = \\frac{1}{4}(-0+0+4-3) = \\frac{1}{4}$$\n$$J_{12} = \\frac{1}{4}(-0-0+4+3) = \\frac{7}{4}$$\n$$J_{21} = \\frac{1}{4}(-0+1+2-0) = \\frac{3}{4}$$\n$$J_{22} = \\frac{1}{4}(-0-1+2+0) = \\frac{1}{4}$$\n因此，雅可比矩阵为\n$$\n\\mathbf{J}_{\\mathrm{CW}}(0,0) =\n\\begin{pmatrix}\n\\frac{1}{4}  \\frac{7}{4} \\\\[4pt]\n\\frac{3}{4}  \\frac{1}{4}\n\\end{pmatrix}\n$$\n行列式为\n$$\n\\det\\mathbf{J}_{\\mathrm{CW}}(0,0) = \\left(\\frac{1}{4}\\right)\\left(\\frac{1}{4}\\right) - \\left(\\frac{7}{4}\\right)\\left(\\frac{3}{4}\\right) = \\frac{1}{16} - \\frac{21}{16} = -\\frac{20}{16} = -\\frac{5}{4}\n$$\n行列式的负号表示该映射反转了方向性。参考单元中的逆时针路径映射到物理单元中的顺时针路径，这对于大多数有限元分析在物理上和数学上都是无效的。\n\n最后，我们计算所需的比值 $r$：\n$$\nr = \\frac{\\det\\mathbf{J}_{\\mathrm{CW}}(0,0)}{\\det\\mathbf{J}_{\\mathrm{CCW}}(0,0)} = \\frac{-5/4}{5/4} = -1\n$$\n这个结果展示了一个基本性质：相对于参考单元固定的逆时针编号，反转物理单元节点编号的方向（从 CCW 到 CW）会导致雅可比行列式变号，而所有其他因素保持不变。对于凸四边形，逆时针编号约定（情况 CCW）可确保雅可比行列式为正，这是标准做法。", "answer": "$$\n\\boxed{-1}\n$$", "id": "2592296"}, {"introduction": "数值积分是有限元方法的核心环节，但减缩积分（reduced integration）可能会引入被称为“沙漏模式”的数值不稳定性。本练习是一项综合性的计算实践，旨在通过分析单元刚度矩阵的特征值谱，建立一个检测这些伪零能模式的系统性判据。通过为 Q4、Q8 和 Q9 单元编程实现该判据，您将掌握一种强大的诊断工具，用于量化和识别因数值积分不足而产生的非物理变形模式 [@problem_id:2592267]。", "problem": "您的任务是设计并实现一个通用的、程序化的准则，仅使用单元刚度矩阵的特征值谱来检测和量化等参四边形有限元中的沙漏模态。工作应完全在二维小应变线弹性框架内进行，使用带有自然坐标的等参映射，并假设材料属性为常数、均匀、各向同性，杨氏模量 $E=1$，泊松比 $\\nu=0.3$，单元厚度 $t=1$。不需要物理单位；将所有量视为无量纲。\n\n从以下基础出发：\n- 应变能密度是应变的二次函数。对于二维小应变线弹性（平面应变），能量密度为 $w(\\boldsymbol{\\varepsilon})=\\tfrac{1}{2}\\boldsymbol{\\varepsilon}^{\\mathsf{T}}\\mathbf{C}\\boldsymbol{\\varepsilon}$，其中 $\\mathbf{C}$ 是对称、正定的平面应变本构矩阵。\n- 在等参有限元近似中，位移场插值表示为 $\\mathbf{u}(\\xi,\\eta)=\\sum_{a=1}^{n}\\mathbf{N}_a(\\xi,\\eta)\\mathbf{d}_a$，其中 $\\xi,\\eta\\in[-1,1]$ 是自然坐标，$n$ 是单元的节点数，$\\mathbf{N}_a$ 是形函数，$\\mathbf{d}_a\\in\\mathbb{R}^2$ 是节点位移向量。\n- 采用 Voigt 标记法的小应变张量为 $\\boldsymbol{\\varepsilon}=\\mathbf{B}(\\xi,\\eta)\\mathbf{d}$，其中 $\\mathbf{d}\\in\\mathbb{R}^{2n}$ 是节点位移列向量。单元刚度矩阵为 $\\mathbf{K}_e=\\int_{\\Omega_e}\\mathbf{B}^{\\mathsf{T}}\\mathbf{C}\\mathbf{B}\\,\\mathrm{d}\\Omega=\\int_{-1}^{1}\\int_{-1}^{1}\\mathbf{B}^{\\mathsf{T}}(\\xi,\\eta)\\mathbf{C}\\mathbf{B}(\\xi,\\eta)\\,\\det\\mathbf{J}(\\xi,\\eta)\\,\\mathrm{d}\\xi\\,\\mathrm{d}\\eta$，其中 $\\mathbf{J}$ 是等参映射的雅可比矩阵。该积分将通过用户指定阶数的张量积高斯求积进行近似计算。\n\n您的任务是利用这些原理，构建一个基于 $\\mathbf{K}_e$ 谱的准则，以检测和量化由减缩积分引起的沙漏模态。该准则必须：\n1. 计算 $\\mathbf{K}_e$ 对称部分的所有特征值 $\\{\\lambda_i\\}_{i=1}^{2n}$。将它们按非递减顺序排序。\n2. 认识到在二维弹性力学中，一个无约束的单元恰好有 $3$ 个刚体模态（两个平移和一个平面内旋转），即使在完全积分下，这也必须表现为三个接近零的特征值。除这三个之外的任何额外的近零特征值都表示伪零能（沙漏）模态。\n3. 定义一个鲁棒的数值阈值，以将特征值 $\\lambda$ 分类为“近零”。令 $\\lambda_{\\max}=\\max_i \\lambda_i$。使用一个混合的相对-绝对阈值 $\\tau=\\varepsilon_{\\mathrm{rel}}\\max(\\lambda_{\\max},\\varepsilon_0)+\\varepsilon_{\\mathrm{abs}}$，其中 $\\varepsilon_{\\mathrm{rel}}$ 和 $\\varepsilon_{\\mathrm{abs}}$ 将被选为固定的正小常数，$\\varepsilon_0$ 是一个微小的正下限，以避免在 $\\lambda_{\\max}$ 极小时出现退化。计算满足 $\\lvert\\lambda\\rvert\\le \\tau$ 的特征值数量；减去三个刚体模态后，余数即为整数沙漏模态计数 $k\\ge 0$。\n4. 通过一个反映谱隙的标量指数来量化沙漏的严重程度。将在移除三个刚体模态和任何检测到的沙漏特征值后的最小“结构”特征值定义为 $\\lambda_{\\min,+}$。如果至少还有一个正特征值，则设置严重性比率 $\\rho=\\lambda_{\\min,+}/\\lambda_{\\max}$；否则设置 $\\rho=0$。较小的 $\\rho$ 意味着更严重的沙漏现象。\n\n使用以下插值族的等参四边形单元实现刚度矩阵的组装：\n- $Q4$（双线性， $n=4$），\n- $Q8$（巧凑二次，无中心节点，$n=8$），\n- $Q9$（拉格朗日二次，有中心节点，$n=9$）。\n\n在自然坐标系中使用标准的节点排序：\n- 对于 $Q4$：角点位于 $(-1,-1)$, $(+1,-1)$, $(+1,+1)$, $(-1,+1)$。\n- 对于 $Q8$：与上述四个角点相同，外加中点节点位于 $(0,-1)$, $(+1,0)$, $(0,+1)$, $(-1,0)$。\n- 对于 $Q9$：与 $Q8$ 的八个节点相同，外加中心节点位于 $(0,0)$。\n\n必须为每个单元族在自然坐标系中从第一性原理实现形函数及其导数，并通过雅可比矩阵 $\\mathbf{J}$ 转换到物理坐标系。使用平面应变本构矩阵 $\\mathbf{C}$。\n\n测试套件：\n在以下七个案例上评估您的准则。对于每个案例，单元的物理节点坐标按照与单元类型一致的有序列表形式在平面中指定。高斯求积阶数以 $(n_\\xi,n_\\eta)$ 给出。\n\n- 案例 1：$Q4$ 单位正方形，完全积分。\n  - 节点：$\\big[(0,0),(1,0),(1,1),(0,1)\\big]$。\n  - 求积：$(2,2)$。\n\n- 案例 2：$Q4$ 单位正方形，减缩积分。\n  - 节点：$\\big[(0,0),(1,0),(1,1),(0,1)\\big]$。\n  - 求积：$(1,1)$。\n\n- 案例 3：$Q4$ 轻度扭曲四边形，减缩积分。\n  - 节点：$\\big[(0,0),(1.2,-0.05),(1.0,1.1),(-0.1,0.9)\\big]$。\n  - 求积：$(1,1)$。\n\n- 案例 4：$Q8$ 单位正方形，相对于双二次的减缩积分。\n  - 节点：单位正方形上的角点和中点：$\\big[(0,0),(1,0),(1,1),(0,1),(0.5,0),(1,0.5),(0.5,1),(0,0.5)\\big]$。\n  - 求积：$(2,2)$。\n\n- 案例 5：$Q8$ 单位正方形，双二次的完全积分。\n  - 节点：如案例 4。\n  - 求积：$(3,3)$。\n\n- 案例 6：$Q9$ 单位正方形，相对于双二次的减缩积分。\n  - 节点：单位正方形上的角点、中点和中心点：$\\big[(0,0),(1,0),(1,1),(0,1),(0.5,0),(1,0.5),(0.5,1),(0,0.5),(0.5,0.5)\\big]$。\n  - 求积：$(2,2)$。\n\n- 案例 7：$Q9$ 单位正方形，双二次的完全积分。\n  - 节点：如案例 6。\n  - 求积：$(3,3)$。\n\n对于每个案例，计算：\n- 上文定义的整数沙漏模态计数 $k$。\n- 上文定义的严重性比率 $\\rho\\in[0,1]$。\n- 一个检测标志 $h$，其中如果 $k>0$ 则 $h=1$，否则 $h=0$。\n\n最终输出格式：\n您的程序应生成一行输出，其中包含七个测试案例的结果，形式为一个逗号分隔的列表，并用方括号括起来，每个案例贡献一个三元列表 $[k,\\rho,h]$。例如，一个有效的输出形式为\n$[\\,[k_1,\\rho_1,h_1],[k_2,\\rho_2,h_2],\\dots,[k_7,\\rho_7,h_7]\\,]$。", "solution": "所提出的问题是计算固体力学领域，特别是在有限元方法中，一个定义良好且有科学依据的练习。它要求基于单元刚度矩阵的特征值谱，发展一个准则来检测和量化由数值减缩积分引起的伪零能模态，即所谓的沙漏模态。该问题是有效的，将基于已建立的第一性原理构建一个解决方案。\n\n线弹性有限元方法的基础是平衡方程的弱形式，它导出一个线性方程组 $\\mathbf{K}\\mathbf{d} = \\mathbf{f}$。对于单个无约束单元，单元刚度矩阵 $\\mathbf{K}_e$ 将节点位移 $\\mathbf{d}$ 与节点力联系起来。单元的总势能由 $\\Pi_e = \\frac{1}{2}\\mathbf{d}^{\\mathsf{T}}\\mathbf{K}_e\\mathbf{d} - \\mathbf{d}^{\\mathsf{T}}\\mathbf{f}_e$ 给出。导致应变能为零（$\\frac{1}{2}\\mathbf{d}^{\\mathsf{T}}\\mathbf{K}_e\\mathbf{d} = 0$），但对应于非刚体运动的变形模式，就是伪沙漏模态。这些模态是 $\\mathbf{K}_e$ 的特征向量，其特征值为零。零能模态的总数等于 $\\mathbf{K}_e$ 的秩亏。\n\n在二维线弹性力学中，任何无约束的单元必须拥有恰好 3 个刚体模态（两个平移和一个平面内旋转），这些模态不产生应变，因此对应于 $\\mathbf{K}_e$ 的 3 个零特征值。任何额外的零或近零特征值都表示数值不稳定性，即沙漏现象。\n\n单元刚度矩阵 $\\mathbf{K}_e$ 由在单元体积 $\\Omega_e$ 上的积分定义：\n$$\n\\mathbf{K}_e = \\int_{\\Omega_e} \\mathbf{B}^{\\mathsf{T}} \\mathbf{C} \\mathbf{B} \\, t \\, \\mathrm{d}A\n$$\n其中 $t$ 是厚度（给定为 $t=1$），$\\mathbf{C}$ 是材料本构矩阵，$\\mathbf{B}$ 是应变-位移矩阵，它将工程应变向量 $\\boldsymbol{\\varepsilon} = [\\varepsilon_{xx}, \\varepsilon_{yy}, \\gamma_{xy}]^{\\mathsf{T}}$ 与节点位移向量 $\\mathbf{d}$ 联系起来。\n\n对于等参单元，物理坐标 $\\mathbf{x} = (x,y)$ 使用与插值位移场相同的形函数 $\\mathbf{N}_a$ 从节点坐标 $\\mathbf{x}_a = (x_a, y_a)$ 插值得到：\n$$\n\\mathbf{x}(\\xi, \\eta) = \\sum_{a=1}^{n} N_a(\\xi, \\eta) \\mathbf{x}_a\n$$\n其中 $(\\xi, \\eta)$ 是参考域 $[-1,1] \\times [-1,1]$ 上的自然坐标。\n\n应变-位移矩阵 $\\mathbf{B}$ 是从形函数的导数推导出来的。该矩阵包含每个节点 $a$ 的块 $\\mathbf{B}_a$：\n$$\n\\mathbf{B} = [\\mathbf{B}_1, \\mathbf{B}_2, \\ldots, \\mathbf{B}_n] \\quad \\text{其中} \\quad \\mathbf{B}_a =\n\\begin{bmatrix}\n\\frac{\\partial N_a}{\\partial x}  0 \\\\\n0  \\frac{\\partial N_a}{\\partial y} \\\\\n\\frac{\\partial N_a}{\\partial y}  \\frac{\\partial N_a}{\\partial x}\n\\end{bmatrix}\n$$\n相对于物理坐标 $(x,y)$ 的导数是通过雅可比矩阵 $\\mathbf{J}$ 的逆矩阵从自然坐标 $(\\xi, \\eta)$ 的导数获得的：\n$$\n\\begin{Bmatrix} \\frac{\\partial N_a}{\\partial x} \\\\ \\frac{\\partial N_a}{\\partial y} \\end{Bmatrix} = \\mathbf{J}^{-1} \\begin{Bmatrix} \\frac{\\partial N_a}{\\partial \\xi} \\\\ \\frac{\\partial N_a}{\\partial \\eta} \\end{Bmatrix} \\quad \\text{其中} \\quad \\mathbf{J} =\n\\begin{bmatrix}\n\\frac{\\partial x}{\\partial \\xi}  \\frac{\\partial y}{\\partial \\xi} \\\\\n\\frac{\\partial x}{\\partial \\eta}  \\frac{\\partial y}{\\partial \\eta}\n\\end{bmatrix} =\n\\begin{bmatrix}\n\\sum_{a=1}^n \\frac{\\partial N_a}{\\partial \\xi} x_a  \\sum_{a=1}^n \\frac{\\partial N_a}{\\partial \\xi} y_a \\\\\n\\sum_{a=1}^n \\frac{\\partial N_a}{\\partial \\eta} x_a  \\sum_{a=1}^n \\frac{\\partial N_a}{\\partial \\eta} y_a\n\\end{bmatrix}\n$$\n$\\mathbf{K}_e$ 的积分被转换到自然坐标系，并使用高斯求积进行数值计算：\n$$\n\\mathbf{K}_e = \\int_{-1}^{1}\\int_{-1}^{1} \\mathbf{B}^{\\mathsf{T}}(\\xi, \\eta) \\mathbf{C} \\mathbf{B}(\\xi, \\eta) \\det(\\mathbf{J}(\\xi, \\eta)) \\, t \\, \\mathrm{d}\\xi \\mathrm{d}\\eta \\approx t \\sum_{i=1}^{n_\\xi} \\sum_{j=1}^{n_\\eta} w_i w_j \\left[ \\mathbf{B}^{\\mathsf{T}} \\mathbf{C} \\mathbf{B} \\det(\\mathbf{J}) \\right]_{(\\xi_i, \\eta_j)}\n$$\n其中 $(\\xi_i, \\eta_j)$ 是高斯点，$(w_i, w_j)$ 是阶为 $(n_\\xi, n_\\eta)$ 的张量积求积法则对应的权重。当求积阶数过低，不足以对给定单元几何形状和形函数多项式阶数的刚度矩阵进行精确积分时，就会发生减缩积分，这可能导致 $\\mathbf{K}_e$ 秩亏。\n\n对于这个问题，我们使用各向同性材料的平面应变本构矩阵，其杨氏模量 $E=1$，泊松比 $\\nu=0.3$：\n$$\n\\mathbf{C} = \\frac{E}{(1+\\nu)(1-2\\nu)}\n\\begin{bmatrix}\n1-\\nu  \\nu  0 \\\\\n\\nu  1-\\nu  0 \\\\\n0  0  \\frac{1-2\\nu}{2}\n\\end{bmatrix}\n= \\frac{1}{0.52}\n\\begin{bmatrix}\n0.7  0.3  0 \\\\\n0.3  0.7  0 \\\\\n0  0  0.2\n\\end{bmatrix}\n$$\n我们将根据 Q4、Q8 和 Q9 单元在自然坐标系中的标准定义，实现它们的形函数及其导数。每个测试案例的步骤如下：\n1.  使用指定的几何形状、单元类型和求积法则，组装 $2n \\times 2n$ 的刚度矩阵 $\\mathbf{K}_e$。\n2.  通过计算 $\\mathbf{K}_e \\leftarrow \\frac{1}{2}(\\mathbf{K}_e + \\mathbf{K}_e^{\\mathsf{T}})$ 来强制对称，以修正任何微小的浮点误差。\n3.  计算 $\\mathbf{K}_e$ 的特征值 $\\{\\lambda_i\\}_{i=1}^{2n}$ 并按非递减顺序排序。\n4.  应用沙漏检测准则。建立一个数值阈值 $\\tau$ 来识别近零特征值：\n    $$\n    \\tau = \\varepsilon_{\\mathrm{rel}}\\max(\\lambda_{\\max},\\varepsilon_0)+\\varepsilon_{\\mathrm{abs}}\n    $$\n    我们选择常数 $\\varepsilon_{\\mathrm{rel}}=10^{-12}$、$\\varepsilon_{\\mathrm{abs}}=10^{-14}$ 和 $\\varepsilon_0=1.0$ 以确保鲁棒性。计算满足 $|\\lambda_i| \\le \\tau$ 的特征值数量。沙漏模态的数量 $k$ 是这个计数减去 3 个预期的刚体模态。\n5.  如果 $k>0$，则设置标志 $h$ 为 1，否则为 0。\n6.  沙漏的严重程度 $\\rho$ 通过最小结构特征值 $\\lambda_{\\min,+}$ 与最大特征值 $\\lambda_{\\max}$ 的比率来量化。$\\lambda_{\\min,+}$ 是满足 $|\\lambda| > \\tau$ 的最小特征值。如果不存在这样的特征值，则 $\\rho=0$。\n\n此过程将应用于问题陈述中指定的七个测试案例中的每一个。结果将清楚地展示完全积分单元（$k=0$）和减缩积分单元（$k>0$）之间的区别，并且严重性指数 $\\rho$ 将量化伪模态的弱点。", "answer": "```python\nimport numpy as np\nfrom numpy.polynomial.legendre import leggauss\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n    # Material and problem parameters\n    E = 1.0  # Young's modulus\n    nu = 0.3  # Poisson's ratio\n    thickness = 1.0  # Element thickness\n\n    # Test suite from the problem statement\n    test_cases = [\n        # Case 1: Q4 unit square, full integration.\n        {'type': 'Q4', 'nodes': np.array([[0, 0], [1, 0], [1, 1], [0, 1]]), 'quad_order': (2, 2)},\n        # Case 2: Q4 unit square, reduced integration.\n        {'type': 'Q4', 'nodes': np.array([[0, 0], [1, 0], [1, 1], [0, 1]]), 'quad_order': (1, 1)},\n        # Case 3: Q4 mildly distorted, reduced integration.\n        {'type': 'Q4', 'nodes': np.array([[0, 0], [1.2, -0.05], [1.0, 1.1], [-0.1, 0.9]]), 'quad_order': (1, 1)},\n        # Case 4: Q8 unit square, underintegration relative to biquadratic.\n        {'type': 'Q8', 'nodes': np.array([[0, 0], [1, 0], [1, 1], [0, 1], [0.5, 0], [1, 0.5], [0.5, 1], [0, 0.5]]), 'quad_order': (2, 2)},\n        # Case 5: Q8 unit square, full integration.\n        {'type': 'Q8', 'nodes': np.array([[0, 0], [1, 0], [1, 1], [0, 1], [0.5, 0], [1, 0.5], [0.5, 1], [0, 0.5]]), 'quad_order': (3, 3)},\n        # Case 6: Q9 unit square, underintegration.\n        {'type': 'Q9', 'nodes': np.array([[0, 0], [1, 0], [1, 1], [0, 1], [0.5, 0], [1, 0.5], [0.5, 1], [0, 0.5], [0.5, 0.5]]), 'quad_order': (2, 2)},\n        # Case 7: Q9 unit square, full integration.\n        {'type': 'Q9', 'nodes': np.array([[0, 0], [1, 0], [1, 1], [0, 1], [0.5, 0], [1, 0.5], [0.5, 1], [0, 0.5], [0.5, 0.5]]), 'quad_order': (3, 3)},\n    ]\n\n    C = get_C_matrix(E, nu)\n    results = []\n    \n    for case in test_cases:\n        Ke = compute_stiffness_matrix(\n            elem_type=case['type'],\n            nodal_coords=case['nodes'],\n            quad_order=case['quad_order'],\n            C_matrix=C,\n            thickness=thickness\n        )\n        k, rho, h = analyze_spectrum(Ke)\n        # Format rho for consistent output\n        rho_str = f\"{rho:.6e}\" if rho != 0 else \"0.0\"\n        results.append(f\"[{k},{rho_str},{h}]\")\n\n    print(f\"[[{','.join(results)}]]\")\n\ndef get_C_matrix(E, nu):\n    \"\"\"Computes the plane strain constitutive matrix.\"\"\"\n    factor = E / ((1 + nu) * (1 - 2 * nu))\n    C = factor * np.array([\n        [1 - nu, nu, 0],\n        [nu, 1 - nu, 0],\n        [0, 0, (1 - 2 * nu) / 2]\n    ])\n    return C\n\ndef get_shape_functions(elem_type, xi, eta):\n    \"\"\"\n    Computes shape functions N and their derivatives dN/d_xi, dN/d_eta\n    for a given element type at natural coordinates (xi, eta).\n    \"\"\"\n    if elem_type == 'Q4':\n        n_nodes = 4\n        # Node corner coordinates in natural system: (-1,-1), (1,-1), (1,1), (-1,1)\n        corners = np.array([[-1, -1], [1, -1], [1, 1], [-1, 1]])\n        N = np.zeros(n_nodes)\n        dN_dxi = np.zeros(n_nodes)\n        dN_deta = np.zeros(n_nodes)\n        for i in range(n_nodes):\n            xi_i, eta_i = corners[i]\n            N[i] = 0.25 * (1 + xi_i * xi) * (1 + eta_i * eta)\n            dN_dxi[i] = 0.25 * xi_i * (1 + eta_i * eta)\n            dN_deta[i] = 0.25 * eta_i * (1 + xi_i * xi)\n        return N, dN_dxi, dN_deta\n\n    elif elem_type == 'Q8':\n        n_nodes = 8\n        # Corners 1-4, Midsides 5-8\n        xis =  np.array([-1, 1, 1, -1, 0, 1, 0, -1])\n        etas = np.array([-1, -1, 1, 1, -1, 0, 1, 0])\n        \n        N = np.zeros(n_nodes)\n        dN_dxi = np.zeros(n_nodes)\n        dN_deta = np.zeros(n_nodes)\n\n        # Corner nodes (1-4)\n        for i in range(4):\n            xi_i, eta_i = xis[i], etas[i]\n            N[i] = 0.25 * (1 + xi_i*xi) * (1 + eta_i*eta) * (xi_i*xi + eta_i*eta - 1)\n            dN_dxi[i] = 0.25 * xi_i * (1 + eta_i*eta) * (2*xi_i*xi + eta_i*eta)\n            dN_deta[i] = 0.25 * eta_i * (1 + xi_i*xi) * (xi_i*xi + 2*eta_i*eta)\n\n        # Midside nodes (5, 7)\n        for i in [4, 6]:\n            xi_i, eta_i = xis[i], etas[i]\n            N[i] = 0.5 * (1 - xi**2) * (1 + eta_i * eta)\n            dN_dxi[i] = -xi * (1 + eta_i * eta)\n            dN_deta[i] = 0.5 * eta_i * (1 - xi**2)\n\n        # Midside nodes (6, 8)\n        for i in [5, 7]:\n            xi_i, eta_i = xis[i], etas[i]\n            N[i] = 0.5 * (1 + xi_i * xi) * (1 - eta**2)\n            dN_dxi[i] = 0.5 * xi_i * (1 - eta**2)\n            dN_deta[i] = -eta * (1 + xi_i * xi)\n        \n        return N, dN_dxi, dN_deta\n\n    elif elem_type == 'Q9':\n        n_nodes = 9\n        N = np.zeros(n_nodes)\n        dN_dxi = np.zeros(n_nodes)\n        dN_deta = np.zeros(n_nodes)\n        \n        # 1D quadratic Lagrange polynomials and their derivatives for nodes at -1, 0, 1\n        L =    [0.5 * xi * (xi - 1), 1 - xi**2, 0.5 * xi * (xi + 1)]\n        L_xi = [xi - 0.5, -2 * xi, xi + 0.5]\n        M =    [0.5 * eta * (eta - 1), 1 - eta**2, 0.5 * eta * (eta + 1)]\n        M_eta = [eta - 0.5, -2 * eta, eta + 0.5]\n\n        # Node mapping from (i,j) in {-1,0,1} indices to linear index 0-8\n        idx_map = {0: (0,0), 1: (2,0), 2: (2,2), 3: (0,2),\n                   4: (1,0), 5: (2,1), 6: (1,2), 7: (0,1), 8: (1,1)}\n        \n        for i in range(n_nodes):\n            li, mi = idx_map[i]\n            N[i] = L[li] * M[mi]\n            dN_dxi[i] = L_xi[li] * M[mi]\n            dN_deta[i] = L[li] * M_eta[mi]\n            \n        return N, dN_dxi, dN_deta\n\n    else:\n        raise ValueError(\"Unsupported element type.\")\n        \ndef compute_stiffness_matrix(elem_type, nodal_coords, quad_order, C_matrix, thickness):\n    \"\"\"Computes the element stiffness matrix Ke.\"\"\"\n    n_nodes = nodal_coords.shape[0]\n    Ke = np.zeros((2 * n_nodes, 2 * n_nodes))\n    \n    gauss_pts_xi, gauss_w_xi = leggauss(quad_order[0])\n    gauss_pts_eta, gauss_w_eta = leggauss(quad_order[1])\n    \n    for i in range(quad_order[0]):\n        for j in range(quad_order[1]):\n            xi, eta = gauss_pts_xi[i], gauss_pts_eta[j]\n            weight = gauss_w_xi[i] * gauss_w_eta[j]\n            \n            _, dN_dxi, dN_deta = get_shape_functions(elem_type, xi, eta)\n            \n            # Jacobian matrix (convention: J_ij = dx_i / d_xi_j)\n            J_T = np.zeros((2, 2))\n            J_T[0, 0] = np.dot(dN_dxi, nodal_coords[:, 0]) # dx/dxi\n            J_T[0, 1] = np.dot(dN_deta, nodal_coords[:, 0]) # dx/deta\n            J_T[1, 0] = np.dot(dN_dxi, nodal_coords[:, 1]) # dy/dxi\n            J_T[1, 1] = np.dot(dN_deta, nodal_coords[:, 1]) # dy/deta\n            J = J_T.T\n            \n            detJ = np.linalg.det(J)\n            if detJ = 0:\n                raise ValueError(\"Jacobian determinant is non-positive.\")\n            \n            # Inverse of Jacobian\n            J_inv = np.linalg.inv(J)\n            \n            # B matrix\n            B = np.zeros((3, 2 * n_nodes))\n            for k in range(n_nodes):\n                # Derivatives w.r.t. x, y\n                d_nat = np.array([dN_dxi[k], dN_deta[k]])\n                d_cart = J_inv @ d_nat\n                dN_dx_k, dN_dy_k = d_cart[0], d_cart[1]\n                \n                # Assemble B_k block\n                B[0, 2*k] = dN_dx_k\n                B[1, 2*k+1] = dN_dy_k\n                B[2, 2*k] = dN_dy_k\n                B[2, 2*k+1] = dN_dx_k\n                \n            # Add contribution to Ke\n            Ke += B.T @ C_matrix @ B * detJ * weight * thickness\n            \n    return Ke\n\ndef analyze_spectrum(Ke):\n    \"\"\"\n    Analyzes the eigenvalue spectrum of Ke to detect hourglass modes.\n    \"\"\"\n    # Enforce symmetry due to potential floating point inaccuracies\n    Ke_sym = 0.5 * (Ke + Ke.T)\n    \n    # Compute eigenvalues\n    eigenvalues = np.linalg.eigvalsh(Ke_sym)\n\n    # Hourglass detection criterion parameters\n    eps_rel = 1.0e-12\n    eps_abs = 1.0e-14\n    eps_0 = 1.0\n    \n    lambda_max = eigenvalues[-1] if len(eigenvalues) > 0 else 0.0\n\n    # Robust threshold for 'near-zero'\n    threshold = eps_rel * max(lambda_max, eps_0) + eps_abs\n    \n    # Count near-zero eigenvalues\n    near_zero_count = np.sum(np.abs(eigenvalues) = threshold)\n    \n    # Subtract 3 rigid body modes\n    k = max(0, near_zero_count - 3)\n    h = 1 if k > 0 else 0\n    \n    # Find smallest structural eigenvalue\n    structural_eigenvalues = eigenvalues[eigenvalues > threshold]\n    \n    if len(structural_eigenvalues) > 0:\n        lambda_min_plus = structural_eigenvalues[0]\n        # Avoid division by zero if all eigenvalues are zero\n        rho = lambda_min_plus / lambda_max if lambda_max > 0 else 0.0\n    else:\n        rho = 0.0\n        \n    return k, rho, h\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "2592267"}]}