{"hands_on_practices": [{"introduction": "我们从基本原理入手，深入探讨灵敏度分析的核心。本练习将指导您使用拉格朗日乘子法，从第一性原理出发推导伴随方程，这是理解伴随法的关键一步。通过这个推导 [@problem_id:2594547]，您将明白伴随法如何巧妙地避免直接计算状态灵敏度（$\\mathrm{d}u/\\mathrm{d}p$），从而在处理大量设计参数时展现出巨大的计算优势。", "problem": "考虑一个线性的、参数化的有限元方法 (FEM) 模型，其离散状态向量 $u(p) \\in \\mathbb{R}^{n}$ 由以下平衡方程决定\n$$\nK(p)\\,u(p) \\;=\\; f(p),\n$$\n其中 $K(p) \\in \\mathbb{R}^{n \\times n}$ 是一个依赖于参数的刚度矩阵，并且对于所关注的参数值是非奇异的，$f(p) \\in \\mathbb{R}^{n}$ 是依赖于参数的载荷向量。设输出泛函为\n$$\nJ(u,p) \\;=\\; \\tfrac{1}{2}\\,u^{T}\\,Q(p)\\,u,\n$$\n其中 $Q(p) \\in \\mathbb{R}^{n \\times n}$ 是对称的，并且对于标量参数 $p \\in \\mathbb{R}$ 足够光滑。假设所有函数根据需要是可微的。\n\n仅使用第一性原理（链式法则、状态方程的线性化和拉格朗日乘子），执行以下操作：\n\n1) 计算偏导数 $\\partial J/\\partial u$。\n\n2) 引入一个伴随向量 $\\lambda(p) \\in \\mathbb{R}^{n}$，以从全导数 $\\mathrm{d}J/\\mathrm{d}p$ 中消除对状态灵敏度 $\\mathrm{d}u/\\mathrm{d}p$ 的依赖。从残差 $R(u,p) = K(p)\\,u - f(p) = 0$ 出发，推导：\n- 一个定义 $\\lambda(p)$ 的伴随方程，以及\n- 一个完全用 $K$、$Q$、$u$ 和关于 $p$ 的参数导数表示的 $\\mathrm{d}J/\\mathrm{d}p$ 的显式表达式。\n\n不要假设 $K(p)$ 是对称的。您可以使用标准的欧几里得内积来构成对偶配对。\n\n3) 简要解释为什么您最终的梯度表达式不需要求解 $\\mathrm{d}u/\\mathrm{d}p$。\n\n请提供 $\\mathrm{d}J/\\mathrm{d}p$ 的单一闭式解析表达式作为您的最终答案，该表达式用 $K$、$Q$、$u$、$\\tfrac{\\partial K}{\\partial p}$、$\\tfrac{\\partial f}{\\partial p}$、$\\tfrac{\\partial Q}{\\partial p}$ 以及满足您的伴随方程的伴随向量 $\\lambda$ 来表示。不需要进行数值代入。您的最终答案必须是单一的符号表达式，且不得包含任何单位。", "solution": "在尝试求解之前，对所述问题进行验证。\n\n首先，逐字提取已知条件。\n- 状态方程：$K(p)\\,u(p) \\;=\\; f(p)$，其中 $K(p) \\in \\mathbb{R}^{n \\times n}$ 是非奇异的，$u(p) \\in \\mathbb{R}^{n}$，$f(p) \\in \\mathbb{R}^{n}$。\n- 输出泛函：$J(u,p) \\;=\\; \\tfrac{1}{2}\\,u^{T}\\,Q(p)\\,u$，其中 $Q(p) \\in \\mathbb{R}^{n \\times n}$ 是对称且光滑的。\n- 参数：$p \\in \\mathbb{R}$ 是一个标量。\n- 假设：所有函数根据需要是可微的。矩阵 $K(p)$ 不假设为对称。\n- 任务：$1$) 计算 $\\partial J/\\partial u$。$2$) 推导伴随方程以及一个消除了对 $\\mathrm{d}u/\\mathrm{d}p$ 依赖的 $\\mathrm{d}J/\\mathrm{d}p$ 表达式。$3$) 解释 $\\mathrm{d}u/\\mathrm{d}p$ 项的消除。\n\n其次，根据所需标准对问题进行验证。\n- **科学依据**：该问题是使用伴随方法进行灵敏度分析的标准练习，这是优化、最优控制和计算工程中的一项基本技术。它坚实地建立在向量微积分和线性代数的既定原理之上。\n- **适定性**：该问题是适定的。$K(p)$ 是非奇异的先验假设确保了状态向量 $u(p)$ 是唯一确定的。在给定的光滑性假设下，所需的泛函导数和伴随系统是唯一可确定的。\n- **客观性**：问题以精确、无歧义的数学语言陈述。\n- **完整性与一致性**：问题提供了所有必要的定义和约束，没有内部矛盾。\n- **可行性与结构**：问题是一个理论推导，完全可行。其结构逻辑清晰，指导从第一性原理进行逐步推导。\n\n该问题满足所有标准，被认为是有效的。现在将构建一个解决方案。\n\n**1) 计算 $\\partial J/\\partial u$**\n\n输出泛函由 $J(u,p) = \\frac{1}{2} u^T Q(p) u$ 给出。为了计算标量 $J$ 关于向量 $u$ 的偏导数，我们考虑在固定参数 $p$ 下，对于一个扰动 $\\mathrm{d}u$ 的微分 $\\mathrm{d}J$。\n$$\n\\mathrm{d}J = \\frac{1}{2} (\\mathrm{d}u)^T Q u + \\frac{1}{2} u^T Q (\\mathrm{d}u)\n$$\n由于 $(\\mathrm{d}u)^T Q u$ 是一个标量，它等于其自身的转置：$(\\mathrm{d}u)^T Q u = (u^T Q^T (\\mathrm{d}u))^T = u^T Q^T (\\mathrm{d}u)$。将此代入第一项得到：\n$$\n\\mathrm{d}J = \\frac{1}{2} u^T Q^T (\\mathrm{d}u) + \\frac{1}{2} u^T Q (\\mathrm{d}u) = \\frac{1}{2} u^T (Q^T + Q) \\mathrm{d}u\n$$\n问题陈述矩阵 $Q(p)$ 是对称的，所以 $Q^T = Q$。表达式简化为：\n$$\n\\mathrm{d}J = \\frac{1}{2} u^T (2Q) \\mathrm{d}u = u^T Q \\mathrm{d}u\n$$\n根据定义，微分 $\\mathrm{d}J$ 通过 $\\mathrm{d}J = \\frac{\\partial J}{\\partial u} \\mathrm{d}u$ 与偏导数（一个行向量或余向量）相关。通过比较，我们确定 $J$ 关于 $u$ 的偏导数为：\n$$\n\\frac{\\partial J}{\\partial u} = u^T Q(p)\n$$\n$J$ 关于 $u$ 的梯度，记为 $\\nabla_u J$，是此行向量的转置，即列向量 $Q(p)u$。\n\n**2) 伴随方程和灵敏度表达式的推导**\n\n目标是求全导数 $\\mathrm{d}J/\\mathrm{d}p$。泛函 $J$ 对 $p$ 的依赖既有通过 $Q(p)$ 的显式依赖，也有通过状态向量 $u(p)$ 的隐式依赖。应用多变量链式法则：\n$$\n\\frac{\\mathrm{d}J}{\\mathrm{d}p} = \\frac{\\partial J}{\\partial p} + \\frac{\\partial J}{\\partial u} \\frac{\\mathrm{d}u}{\\mathrm{d}p}\n$$\n第一项，即显式导数，是通过在保持 $u$ 不变的情况下对 $J$ 求关于 $p$ 的导数来计算的：\n$$\n\\frac{\\partial J}{\\partial p} = \\frac{\\partial}{\\partial p} \\left( \\frac{1}{2} u^T Q(p) u \\right) = \\frac{1}{2} u^T \\frac{\\partial Q}{\\partial p} u\n$$\n将此结果及第 1 部分的结果代入，得到全导数的表达式，这被称为直接灵敏度公式：\n$$\n\\frac{\\mathrm{d}J}{\\mathrm{d}p} = \\frac{1}{2} u^T \\frac{\\partial Q}{\\partial p} u + u^T Q \\frac{\\mathrm{d}u}{\\mathrm{d}p}\n$$\n该表达式依赖于状态灵敏度 $\\mathrm{d}u/\\mathrm{d}p$，其计算成本高昂，因为需要为每个参数求解一个线性系统。伴随方法可以避免这个问题。\n\n我们使用拉格朗日乘子法。约束是状态方程，写成残差形式 $R(u,p) = K(p)u - f(p) = 0$。我们通过使用一个拉格朗日乘子向量 $\\lambda \\in \\mathbb{R}^n$（我们称之为伴随向量）将约束附加到原始泛函 $J$ 上，从而构成增广泛函 $\\mathcal{L}$。\n$$\n\\mathcal{L}(u, p, \\lambda) = J(u, p) + \\lambda^T R(u, p) = \\frac{1}{2} u^T Q u + \\lambda^T (Ku - f)\n$$\n由于状态方程总是满足的（$R(u(p), p) = 0$），对于任意选择的 $\\lambda$，我们都有 $\\mathcal{L} = J$。因此，它们关于 $p$ 的全导数相等：$\\mathrm{d}J/\\mathrm{d}p = \\mathrm{d}\\mathcal{L}/\\mathrm{d}p$。我们将 $\\mathcal{L}$ 视为 $u$、$p$ 和 $\\lambda$ 的函数，并应用链式法则来计算 $\\mathrm{d}\\mathcal{L}/\\mathrm{d}p$：\n$$\n\\frac{\\mathrm{d}\\mathcal{L}}{\\mathrm{d}p} = \\frac{\\partial \\mathcal{L}}{\\partial p} + \\frac{\\partial \\mathcal{L}}{\\partial u} \\frac{\\mathrm{d}u}{\\mathrm{d}p} + \\frac{\\partial \\mathcal{L}}{\\partial \\lambda} \\frac{\\mathrm{d}\\lambda}{\\mathrm{d}p}\n$$\n伴随方法的核心是选择 $\\lambda$ 来消除包含状态灵敏度 $\\mathrm{d}u/\\mathrm{d}p$ 的项。这通过将其系数设为零来实现：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial u} = 0\n$$\n让我们计算这个偏导数：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial u} = \\frac{\\partial}{\\partial u} \\left( \\frac{1}{2} u^T Q u + \\lambda^T K u - \\lambda^T f \\right) = u^T Q + \\lambda^T K\n$$\n将其设为零得到条件 $u^T Q + \\lambda^T K = 0$。转置该方程得到**伴随方程**的标准形式：\n$$\n(u^T Q + \\lambda^T K)^T = 0^T \\implies Q^T u + K^T \\lambda = 0\n$$\n由于 $Q$ 是对称的（$Q^T = Q$），我们有：\n$$\nK^T \\lambda = -Q u\n$$\n这是一个定义伴随向量 $\\lambda(p)$ 的线性方程组。注意它涉及刚度矩阵的转置 $K^T$，并且其求解需要状态向量 $u$。\n\n通过对 $\\lambda$ 的这种特定选择，$\\mathrm{d}\\mathcal{L}/\\mathrm{d}p$ 表达式中的 $\\frac{\\partial \\mathcal{L}}{\\partial u} \\frac{\\mathrm{d}u}{\\mathrm{d}p}$ 项变为零。此外，项 $\\frac{\\partial \\mathcal{L}}{\\partial \\lambda}$ 就是 $R^T$。由于状态方程 $R=0$ 必须成立，该项也为零，因此无论 $\\mathrm{d}\\lambda/\\mathrm{d}p$ 为何值，$\\frac{\\partial \\mathcal{L}}{\\partial \\lambda} \\frac{\\mathrm{d}\\lambda}{\\mathrm{d}p} = 0$。\n\n因此，泛函的全导数简化为：\n$$\n\\frac{\\mathrm{d}J}{\\mathrm{d}p} = \\frac{\\mathrm{d}\\mathcal{L}}{\\mathrm{d}p} = \\frac{\\partial \\mathcal{L}}{\\partial p}\n$$\n我们现在计算 $\\mathcal{L}$ 关于 $p$ 的偏导数：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial p} = \\frac{\\partial}{\\partial p} \\left( \\frac{1}{2} u^T Q(p) u + \\lambda^T (K(p)u - f(p)) \\right) = \\frac{1}{2} u^T \\frac{\\partial Q}{\\partial p} u + \\lambda^T \\left( \\frac{\\partial K}{\\partial p} u - \\frac{\\partial f}{\\partial p} \\right)\n$$\n这就给出了最终的灵敏度表达式：\n$$\n\\frac{\\mathrm{d}J}{\\mathrm{d}p} = \\frac{1}{2} u^T \\frac{\\partial Q}{\\partial p} u + \\lambda^T \\left( \\frac{\\partial K}{\\partial p} u - \\frac{\\partial f}{\\partial p} \\right)\n$$\n\n**3) 关于消除 $\\mathrm{d}u/\\mathrm{d}p$ 的解释**\n\n梯度 $\\mathrm{d}J/\\mathrm{d}p$ 的最终表达式不需要求解状态灵敏度向量 $\\mathrm{d}u/\\mathrm{d}p$，这是因为伴随问题的特定构造方式。通过引入拉格朗日乘子（伴随）向量 $\\lambda$ 并构建增广泛函 $\\mathcal{L}$，我们获得了一个额外的自由度。这个自由度被用来施加伴随方程 $K^T\\lambda = -Qu$。这个方程被专门设计为这样一个条件，它使得在 $\\mathrm{d}\\mathcal{L}/\\mathrm{d}p$ 的链式法则展开式中，$\\mathrm{d}u/\\mathrm{d}p$ 项的系数为零。通过满足这个伴随方程，全导数 $\\mathrm{d}J/\\mathrm{d}p$ 对状态灵敏度 $\\mathrm{d}u/\\mathrm{d}p$ 的依赖在代数上被消除了，只剩下依赖于状态 $u$、伴随状态 $\\lambda$ 以及问题数据（$K$、$f$、$Q$）关于参数 $p$ 的直接偏导数的项。这构成了伴随方法在涉及大量参数的灵敏度分析中的主要优势，因为只需要求解一个状态系统和一个伴随系统，而不是为每个参数的灵敏度求解一个新的系统。", "answer": "$$\n\\boxed{\\frac{1}{2} u^T \\frac{\\partial Q}{\\partial p} u + \\lambda^T \\left( \\frac{\\partial K}{\\partial p} u - \\frac{\\partial f}{\\partial p} \\right)}\n$$", "id": "2594547"}, {"introduction": "在掌握了伴随法的数学推导之后，我们来建立其物理直觉。本练习 [@problem_id:2594578] 考察一个具体且简单的目标函数——结构上某一点的位移，旨在揭示伴随向量 $\\lambda$ 的物理意义。通过将伴随解与离散影响函数（或格林函数）的概念联系起来，您将对伴随变量在结构力学问题中的实际作用有一个更深刻、更直观的理解。", "problem": "考虑一个线性有限元平衡系统，该系统源于一个对称正定刚度矩阵 $K(p) \\in \\mathbb{R}^{n \\times n}$，该矩阵平滑地依赖于参数 $p \\in \\mathbb{R}^{m}$。位移向量 $u \\in \\mathbb{R}^{n}$ 和载荷向量 $f \\in \\mathbb{R}^{n}$ 满足 $K(p)\\,u = f$。设我们关注的标量响应为第 $i$ 个自由度，即 $J(u) = u_{i}$，其中 $i \\in \\{1,\\dots,n\\}$。在基于伴随的灵敏度分析中，我们引入一个伴随变量 $\\lambda \\in \\mathbb{R}^{n}$。请不要使用任何预先推导的伴随梯度公式，而是从控制平衡方程和 $J(u)$ 的定义出发，推断出伴随线性系统的正确右端项，并将伴随向量 $\\lambda$ 从物理上解释为离散影响函数（在离散设置中也称为格林函数）。\n下列哪个陈述是正确的？\n\nA. 伴随右端项是 $e_{i}$，其中 $e_{i} \\in \\mathbb{R}^{n}$ 是第 $i$ 个标准基向量，因此伴随系统为 $K^{\\top}\\lambda = e_{i}$。对于对称的 $K$，这简化为 $K\\,\\lambda = e_{i}$，因此 $\\lambda = K^{-1} e_{i}$ 是 $J(u)=u_{i}$ 的离散影响函数：其分量 $\\lambda_{j}$ 等于在第 $i$ 个自由度上施加大小为 $1$ 的单位载荷所引起的第 $j$ 个自由度上的位移，并且等价地有 $\\lambda_{j} = \\partial J / \\partial f_{j}$。\n\nB. 伴随右端项是 $f$，因此伴随系统为 $K^{\\top}\\lambda = f$。在物理上，$\\lambda$ 代表支座反力，并且不依赖于定义 $J(u)$ 的是哪个自由度。\n\nC. 伴随右端项是 $K\\,e_{i}$，因此伴随系统为 $K^{\\top}\\lambda = K\\,e_{i}$。在物理上，$\\lambda$ 与第 $i$ 个节点相关的有限元形函数一致。\n\nD. 伴随右端项是 $e_{i}$，并且无论 $K$ 是否对称，伴随系统都是 $K\\,\\lambda = e_{i}$。在物理上，$\\lambda$ 是通过在第 $i$ 个自由度上施加大小为 $1$ 的单位位移而得到的广义力向量。", "solution": "我们从有限元平衡方程 $K(p)\\,u = f$ 开始，其中对于所有允许的 $p$，$K(p)$ 是对称正定的。响应泛函为 $J(u) = u_{i}$，其中 $i \\in \\{1,\\dots,n\\}$。在基于第一性原理的伴随灵敏度推导中，我们构造一个拉格朗日函数，通过拉格朗日乘子（即伴随变量）$\\lambda \\in \\mathbb{R}^{n}$ 来施加平衡约束：\n$$\n\\mathcal{L}(u,\\lambda,p) \\;=\\; J(u) \\;+\\; \\lambda^{\\top}\\big(f - K(p)\\,u\\big).\n$$\n$\\mathcal{L}$ 关于 $u$ 的平稳性条件给出了伴随方程。取关于 $u$ 的一阶变分，得到\n$$\n\\delta_{u}\\mathcal{L} \\;=\\; \\Big(\\tfrac{\\partial J}{\\partial u}\\Big)^{\\top}\\delta u \\;-\\; \\lambda^{\\top}K(p)\\,\\delta u \\;=\\; \\Big[\\Big(\\tfrac{\\partial J}{\\partial u}\\Big) - K(p)^{\\top}\\lambda\\Big]^{\\top}\\delta u.\n$$\n由于 $\\delta u$ 是任意的，伴随方程为\n$$\nK(p)^{\\top}\\lambda \\;=\\; \\frac{\\partial J}{\\partial u}.\n$$\n对于特定的响应 $J(u)=u_{i}$，其关于 $u$ 的梯度是第 $i$ 个标准基向量：\n$$\n\\frac{\\partial J}{\\partial u} \\;=\\; e_{i} \\in \\mathbb{R}^{n},\n$$\n其分量为 $\\big(e_{i}\\big)_{j} = 1$（如果 $j=i$）和 $\\big(e_{i}\\big)_{j} = 0$（否则）。因此，伴随系统是\n$$\nK(p)^{\\top}\\lambda \\;=\\; e_{i}.\n$$\n当 $K(p)$ 是对称的，有 $K(p)^{\\top} = K(p)$，所以伴随方程简化为\n$$\nK(p)\\,\\lambda \\;=\\; e_{i} \\quad\\Rightarrow\\quad \\lambda \\;=\\; K(p)^{-1} e_{i}.\n$$\n这给出了一个清晰的物理诠释。考虑从载荷到位移的线性映射 $u = K(p)^{-1} f$。响应为\n$$\nJ(u) \\;=\\; e_{i}^{\\top} u \\;=\\; e_{i}^{\\top} K(p)^{-1} f.\n$$\n$J$ 关于载荷分量 $f_{j}$ 的灵敏度为\n$$\n\\frac{\\partial J}{\\partial f} \\;=\\; K(p)^{-\\top} e_{i} \\;=\\; \\lambda.\n$$\n因此，每个分量 $\\lambda_{j}$ 等于 $\\partial J / \\partial f_{j} = \\partial u_{i} / \\partial f_{j}$。换句话说，$\\lambda$ 是响应 $u_{i}$ 的离散影响函数（离散格林函数）：$\\lambda_{j}$ 是由施加于自由度 $i$ 的大小为 1 的单位载荷所引起的自由度 $j$ 处的位移响应。对于对称的 $K(p)$，$\\lambda$ 是 $K(p)^{-1}$ 的第 $i$ 列，即在第 $i$ 个自由度上施加大小为 1 的单位点载荷所产生的位移向量。这是线性系统中影响函数的标准解释。\n我们现在来分析这些选项：\n\n- 选项 A：它指出伴随右端项是 $e_{i}$，伴随系统是 $K^{\\top}\\lambda = e_{i}$，这正是从拉格朗日平稳性条件推导出的结果。它接着指出，对于对称的 $K$，有 $K\\,\\lambda = e_{i}$ 和 $\\lambda = K^{-1} e_{i}$，给出了 $\\lambda$ 作为响应 $u_{i}$ 的离散影响函数的物理解释，且有 $\\lambda_{j} = \\partial J / \\partial f_{j}$。所有陈述都是正确的。结论：正确。\n\n- 选项 B：它错误地将伴随右端项设为 $f$，而不是 $e_{i} = \\partial J/\\partial u$。此外，它声称 $\\lambda$ 代表支座反力并且与响应的定义无关，这是错误的：伴随变量依赖于具体的 $J(u)$。结论：不正确。\n\n- 选项 C：它将伴随右端项设为 $K\\,e_{i}$，这无法从 $K^{\\top}\\lambda = \\partial J/\\partial u$ 推导出来。它还将 $\\lambda$ 误认为是形函数；形函数是物理域中与网格几何相关的插值函数，而不是伴随代数系统的全局解向量。结论：不正确。\n\n- 选项 D：它使用了正确的右端项 $e_{i}$，但断言无论 $K$ 是否对称都有 $K\\,\\lambda = e_{i}$。对于非对称的 $K$，正确的方程是 $K^{\\top}\\lambda = e_{i}$。它还将 $\\lambda$ 误解为施加单位位移所产生的广义力，而后者关系到刚度乘以运动学向量，而不是伴随位移影响向量。结论：不正确。\n因此，正确选项是 A。", "answer": "$$\\boxed{A}$$", "id": "2594578"}, {"introduction": "在工程分析中，验证计算结果的正确性是至关重要的一步。本练习 [@problem_id:2594554] 介绍了一种强大的数值验证技术——复步法，用于检验解析梯度的准确性。您将学习如何利用该方法获得机器精度级别的导数，同时避免传统有限差分法中常见的“灾难性抵消”误差，从而为您的直接法或伴随法灵敏度分析代码提供一个可靠的验证手段。", "problem": "考虑一个稳态线性椭圆边值问题，通过有限元法（FEM）离散化，得到复解析残差方程 $R(U,p)=K(p)\\,U - f(p)=0$，其中 $U \\in \\mathbb{R}^n$ 是节点未知量向量，$p \\in \\mathbb{R}^m$ 是一个可微的参数向量，仅通过可微的材料或载荷模型引入。设性能泛函为 $J(U,p)$，假定其对两个参数均为二阶连续可微，并且在 $p_k$ 方向的实轴邻域内存在全纯延拓。您希望使用复步法以机器精度验证单个梯度分量 $\\partial J/\\partial p_k$，且无减法抵消，仅使用您有限元代码中现有的组装和求解基础结构。\n\n从适用于离散设置的第一性原理出发，应用于由 $R(U(p),p)=0$ 确定的解映射 $U(p)$ 的链式法则以及隐函数定理，为通过直接法或伴随法进行灵敏度分析提供了理论依据。然而，您将使用参数的复数扰动，并依赖于解析性来推断复数扰动量的虚部与关于 $p_k$ 的方向导数之间的关系。\n\n哪个选项正确地论证了为何复步法能够确定 $\\partial J/\\partial p_k$，并为离散有限元代码提供了一套准确、可直接实施、避免减法抵消的步骤？\n\nA. 利用 $R$ 和 $J$ 的解析性来论证，对于足够小的 $h \\in \\mathbb{R}$，复数扰动系统 $R(U^{\\mathbb{C}}, p + i\\,h\\,e_k)=0$ 的解满足 $U^{\\mathbb{C}} = U(p) + i\\,h\\,\\partial U/\\partial p_k + \\mathcal{O}(h^2)$，因此 $J(U^{\\mathbb{C}}, p + i\\,h\\,e_k) = J(U(p),p) + i\\,h\\,\\partial J/\\partial p_k + \\mathcal{O}(h^2)$。因此 $\\partial J/\\partial p_k = \\operatorname{Im}\\!\\left(J(U^{\\mathbb{C}}, p + i\\,h\\,e_k)\\right)/h + \\mathcal{O}(h^2)$，没有任何近似相等的实数之差。离散实现步骤：\n- 选择索引 $k$ 和一个极小的步长 $h$（对于双精度，由于没有减法抵消，$h \\in [10^{-30},10^{-20}]$ 是可接受的）。\n- 在单元和载荷例程中，将所有出现的 $p_k$ 替换为 $p_k + i\\,h$，同时保持所有 $j \\neq k$ 的 $p_j$ 不变；这将修改所有依赖于 $p_k$ 的贡献 $K_e(p)$ 和 $f_e(p)$。\n- 组装全局复数系统 $K^{\\mathbb{C}} U^{\\mathbb{C}} = f^{\\mathbb{C}}$，对实部和虚部同样施加本质边界条件（即，约束复数值，而不仅仅是其实部），并求解 $U^{\\mathbb{C}} \\in \\mathbb{C}^n$。\n- 使用相同的复数扰动参数和状态来评估复数泛函 $J^{\\mathbb{C}}=J(U^{\\mathbb{C}}, p + i\\,h\\,e_k)$。\n- 报告 $\\left.\\partial J/\\partial p_k\\right|_{p} \\approx \\operatorname{Im}(J^{\\mathbb{C}})/h$。\n这只需要复数算术；它避免了构造或求解 $\\partial U/\\partial p_k$，并且不会遭受减法抵消。\n\nB. 因为如果步长选择为 $h=\\sqrt{\\epsilon_{\\mathrm{mach}}}$，实数有限差分的减法抵消也会消失，所以可以通过使用 $p_k+h$（实数）进行组装，求解 $K(p_k+h)U^+=f(p_k+h)$，并使用 $h=\\sqrt{\\epsilon_{\\mathrm{mach}}}$ 计算 $\\left[J(U^+,p+h\\,e_k)-J(U(p),p)\\right]/h$ 来估计 $\\partial J/\\partial p_k$。离散步骤是：\n- 使用 $p_k+h$（实数）进行组装，求解 $U^+$。\n- 计算 $J(U^+,p+h\\,e_k)$ 并减去 $J(U(p),p)$。\n- 将实部除以 $h$。\n这避免了复数算术，并且对于验证来说足够准确。\n\nC. 为避免修改材料例程，对自由度添加一个纯虚数扰动：对于选定的自由度索引 $r$，求解 $K(p)\\left(U + i\\,h\\,e_r\\right)=f(p)$，评估 $J\\left(U + i\\,h\\,e_r,p\\right)$，并取 $\\operatorname{Im}(\\cdot)/h$。步骤如下：\n- 求解实数系统以得到 $U$。\n- 通过将 $U$ 替换为 $U + i\\,h\\,e_r$ 来注入扰动。\n- 计算 $J$ 并将其虚部除以 $h$ 以得到 $\\partial J/\\partial p_k$。\n\nD. 使用 $p_k + i\\,h$ 进行组装并求解 $K^{\\mathbb{C}} U^{\\mathbb{C}} = f^{\\mathbb{C}}$，但仅对 $U^{\\mathbb{C}}$ 的实部施加本质边界条件以保留原始约束。然后通过 $\\operatorname{Re}\\!\\left(J(U^{\\mathbb{C}}, p + i\\,h\\,e_k)\\right)/h$ 来近似 $\\partial J/\\partial p_k$，因为实部随 $h$ 线性变化。使用一个非常小的 $h$ 如 $h=10^{-8}$ 可以避免数值问题。\n\n选择唯一一个既提供了正确论证也提供了正确离散实现步骤的最佳选项。", "solution": "我们从离散残差方程 $R(U,p)=0$ 开始，其中 $R:\\mathbb{C}^n \\times \\mathbb{C}^m \\to \\mathbb{C}^n$ 是通过实值残差的解析延拓得到的。假设 $R$ 和 $J$ 在 $(U(p),p)$ 沿 $p_k$ 方向的邻域内是全纯的，并且 $\\partial R/\\partial U$ 在 $(U(p),p)$ 处是非奇异的，因此隐函数定理适用。那么在 $p$ 沿复直线 $p + z\\,e_k$（其中 $z \\in \\mathbb{C}$）的邻域内，存在一个全纯解映射 $U(p)$。通过复数 Taylor 展开，\n$$\nU(p + i\\,h\\,e_k) \\;=\\; U(p) \\;+\\; i\\,h\\,\\frac{\\partial U}{\\partial p_k}(p) \\;+\\; \\mathcal{O}(h^2),\n$$\n对于实数 $h \\to 0$。对 $J(U(p),p)$ 应用链式法则并使用其全纯延拓，\n$$\nJ\\!\\left(U(p + i\\,h\\,e_k),\\, p + i\\,h\\,e_k\\right)\n= J(U(p),p) + i\\,h\\,\\frac{\\partial J}{\\partial p_k}(p) + \\mathcal{O}(h^2).\n$$\n取虚部并除以 $h$ 得到\n$$\n\\frac{\\operatorname{Im}\\!\\left(J\\!\\left(U(p + i\\,h\\,e_k),\\, p + i\\,h\\,e_k\\right)\\right)}{h}\n= \\frac{\\partial J}{\\partial p_k}(p) + \\mathcal{O}(h^2).\n$$\n关键是，这个关系不涉及任何近似相等的实数之差；因此，在浮点运算中，只要代码路径在 $p_k$ 中保持解析，就可以选择极小的 $h$（例如，在双精度下 $h \\approx 10^{-30}$）而不会发生灾难性的抵消，从而得到 $\\partial J/\\partial p_k$ 的机器精度估计。\n\n在离散的有限元代码中，这意味着一个直接的实现：在组装单元矩阵和向量时，无论在哪里使用参数 $p_k$，都对其引入一个纯虚数扰动 $i\\,h$，从而形成一个复数全局系统。对复数值未知量（实部和虚部都等于规定值）同样施加本质边界条件，求解 $U^{\\mathbb{C}}$，并评估复数泛函 $J^{\\mathbb{C}} = J(U^{\\mathbb{C}}, p + i\\,h\\,e_k)$。所需的梯度分量是 $\\operatorname{Im}(J^{\\mathbb{C}})/h$。\n\n逐项分析：\n\n- 选项 A：该选项通过复数 Taylor 展开给出了正确的解析论证，这在离散设置下源于全纯性和隐函数定理。它表明 $J$ 的虚部除以 $h$ 得到 $\\partial J/\\partial p_k$，误差阶为 $\\mathcal{O}(h^2)$，并且没有减法抵消。实现步骤是正确的：在 $K(p)$ 和 $f(p)$ 中所有出现 $p_k$ 的地方一致地插入 $p_k \\mapsto p_k + i\\,h$，对完整的复数未知量施加边界条件来组装和求解复数系统，用相同的复数输入评估 $J$，并取 $\\operatorname{Im}(\\cdot)/h$。关于 $h$ 的指导承认，在复步法中极小的值是可接受的，因为没有实部相减发生。结论——正确。\n\n- 选项 B：该选项转向实数前向差分公式，并引用启发式规则 $h=\\sqrt{\\epsilon_{\\mathrm{mach}}}$ 来减少减法抵消，但它既没有使用复步法，原则上也没有避免减法抵消。当 $h$ 太小时，实数有限差分确实会遭受抵消，而这正是复步法所规避的。此外，减去 $J(U(p),p)$ 并将实部除以 $h$ 产生标准的前向差分，它缺乏复步法所具有的机器精度行为。作为对问题的回应，这既没有提供复步法的论证，也没有提供正确的实现。结论——不正确。\n\n- 选项 C：该选项直接用 $i\\,h\\,e_r$ 扰动解向量 $U$，而不是扰动参数 $p_k$。$J(U + i\\,h\\,e_r,p)/h$ 的虚部近似于在固定 $p$ 下的方向导数 $\\partial J/\\partial U \\cdot e_r$，而不是 $\\partial J/\\partial p_k$。因此，它估计了一个不同的量，并没有解决 $U$ 通过 $R(U,p)=0$ 对 $p_k$ 的隐式依赖关系。结论——不正确。\n\n- 选项 D：该选项使用 $p_k + i\\,h$ 进行组装，但随后（i）仅对实部施加本质边界条件，这对于复数求解是不一致的，因为虚部未受约束并违反了规定值，从而破坏了扰动；（ii）使用 $J$ 的实部除以 $h$ 来估计导数，而复步恒等式要求的是虚部，而不是实部。实部与 $J(U(p),p)$ 的差异仅为 $\\mathcal{O}(h^2)$，除以 $h$ 后不能提供所需的一阶导数。结论——不正确。\n\n因此，只有选项A既正确地论证了该方法，又指定了避免减法抵消的正确离散实现步骤。", "answer": "$$\\boxed{A}$$", "id": "2594554"}]}