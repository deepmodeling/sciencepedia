## 引言
随着机器人、自动驾驶汽车和无人机等自主系统的日益普及，确保其在复杂和动态环境中安全运行已成为控制理论面临的首要挑战。传统的控制设计往往优先考虑性能目标（如稳定性或轨迹跟踪），而安全约束则常常通过[启发式](@entry_id:261307)规则或离线[路径规划](@entry_id:163709)来处理，这在实时交互中可能既不充分也不可靠。这一知识鸿沟催生了对一种能够系统性地、可验证地将安全约束融入实时[控制器设计](@entry_id:274982)的形式化方法的需求。[控制屏障函数](@entry_id:177928) (Control Barrier Functions, CBFs) 正是为应对这一挑战而生的一种强大理论框架，它提供了一种将高层安全规范直接转化为控制器层面的可执行约束的系统性方法。

本文旨在全面而深入地探讨CB[F理论](@entry_id:184208)及其应用。在第一章“原理与机制”中，我们将从数学上严格定义安全性，并建立从平滑系统到非平滑和高阶系统的CBF核心条件。接着，在第二章“应用与[交叉](@entry_id:147634)学科联系”中，我们将展示CBF如何在[机器人学](@entry_id:150623)和自动驾驶等领域解决实际问题，如何与性能目标（如CLF）相结合，以及如何处理不确定性，并探讨其与机器学习等领域的[交叉](@entry_id:147634)。最后，第三章“动手实践”将通过具体问题加深读者对核心概念的理解。现在，让我们从构建CBF的基本原理和机制开始，深入其理论核心。

## 原理与机制

在“引言”章节中，我们已经建立了安全临界控制的基本概念，并阐述了其在现代自主系统中的重要性。本章将深入探讨[控制屏障函数](@entry_id:177928)（Control Barrier Functions, CBFs）的核心原理与作用机制。我们将从其数学基础出发，系统性地构建从平滑系统到非平滑系统的安全约束综合方法，并揭示其在实际[控制器设计](@entry_id:274982)中的应用。

### 安全性的形式化定义与[前向不变性](@entry_id:170094)

安全临界控制的首要任务是确保系统状态 $x \in \mathbb{R}^n$ 始终保持在一个预定义的**安全集 (Safe Set)** $\mathcal{C}$ 之内。这个集合通常由一个或多个[连续函数](@entry_id:137361) $h: \mathbb{R}^n \to \mathbb{R}$ 的零次水平集 (superlevel set) 来描述。最简单的形式是，安[全集](@entry_id:264200)由单个函数定义：

$$
\mathcal{C} = \{x \in \mathbb{R}^n : h(x) \ge 0\}
$$

在此定义下，安[全集](@entry_id:264200)的边界 $\partial\mathcal{C}$ 由 $\{x \in \mathbb{R}^n : h(x) = 0\}$ 描述，而其内部 $\text{Int}(\mathcal{C})$ 则由 $\{x \in \mathbb{R}^n : h(x) > 0\}$ 描述。函数 $h(x)$ 的值可以被直观地理解为系统状态距离不安全区域的一种度量：$h(x)$ 越大，状态越安全。

控制系统的核心目标是保证集合 $\mathcal{C}$ 的**[前向不变性](@entry_id:170094) (Forward Invariance)**。这意味着，对于任意从安[全集](@entry_id:264200)内部或边界出发的初始状态 $x(0) \in \mathcal{C}$，在施加了合适的控制输入后，系统的轨迹将在所有未来时间 $t \ge 0$ 内始终保持在 $\mathcal{C}$ 中，即 $x(t) \in \mathcal{C}$。

从几何角度看，保证[前向不变性](@entry_id:170094)的关键在于控制系统在安全集边界上的行为。根据 Nagumo 的可达性定理 (Viability Theorem)，保证集合 $\mathcal{C}$ 前向不变的一个充分必要条件是，在边界上的任意一点 $x \in \partial\mathcal{C}$，系统的速度向量 $\dot{x}$ 必须指向集合内部或与之相切。换言之，速度向量 $\dot{x}$ 必须属于该点的**[切锥](@entry_id:191609) (Tangent Cone)** $T_{\mathcal{C}}(x)$。[控制屏障函数](@entry_id:177928)的核心思想便是将这一抽象的几何条件转化为一个可在控制器中实时计算和强制执行的代数不等式。

### 平滑系统的[控制屏障函数](@entry_id:177928)

我们首先考虑最基本的情形：一个由控制仿射[非线性系统](@entry_id:168347) $\dot{x} = f(x) + g(x)u$ 描述的系统，以及一个由**连续可微 ($C^1$)** 的函数 $h(x)$ 定义的安[全集](@entry_id:264200)。

#### [相对阶](@entry_id:171358)为一的CBF条件

为了使问题良定义，我们需要对函数 $h$ 施加一些基本假设。首先，$h$ 应当是 $C^1$ 的，这样我们才能计算其梯度。其次，为了保证安[全集](@entry_id:264200)的边界 $\partial\mathcal{C}$ 是一个光滑的超曲面，并且在每一点都有唯一的[法向量](@entry_id:264185)，我们要求 $0$ 是 $h$ 的一个**[正则值](@entry_id:161151) (regular value)**。这意味着在边界上的任意点 $x \in \partial\mathcal{C}$，梯度 $\nabla h(x)$ 均不为零。此时，$\nabla h(x)$ 就定义了边界在该点的[法向量](@entry_id:264185)方向 [@problem_id:2695307]。

沿着系统轨迹，函数 $h(x)$ 的时间导数可以通过[链式法则](@entry_id:190743)计算：
$$
\dot{h}(x, u) = \frac{\partial h}{\partial x} \dot{x} = \nabla h(x)^\top (f(x) + g(x)u)
$$
使用**[李导数](@entry_id:171745) (Lie derivative)** 的标准记法，$L_f h(x) \triangleq \nabla h(x)^\top f(x)$ 和 $L_g h(x) \triangleq \nabla h(x)^\top g(x)$，上式可以写为：
$$
\dot{h}(x, u) = L_f h(x) + L_g h(x) u
$$
这里，$L_f h(x)$ 代表了系统在没有控制输入（即 $u=0$）时的“漂移”趋势对 $h$ 的影响，而 $L_g h(x)$ 则刻画了控制输入 $u$ 对 $\dot{h}$ 的瞬时影响。

为了让控制输入 $u$ 能够有效地维持安全，它必须能够直接影响 $\dot{h}$。这引出了**[相对阶](@entry_id:171358)为一 (relative degree one)** 的关键假设：对于我们关心的所有状态（尤其是在边界附近），必须有 $L_g h(x) \neq 0$ [@problem_id:2695307] [@problem_id:2695249]。当此条件满足时，控制输入 $u$ 会直接出现在 $h$ 的一阶导数中，使得我们可以通过选择 $u$ 来直接控制 $\dot{h}$ 的符号和大小。

**零化[控制屏障函数](@entry_id:177928) (Zeroing Control Barrier Function, ZCBF)** 通过以下不等式来保证[前向不变性](@entry_id:170094)：
$$
\dot{h}(x, u) + \alpha(h(x)) \ge 0
$$
其中，$\alpha$ 是一个**扩展$\mathcal{K}$类函数 (extended class-$\mathcal{K}$ function)**。将李导数表达式代入，我们得到一个关于控制输入 $u$ 的[线性不等式](@entry_id:174297)约束：
$$
L_f h(x) + L_g h(x) u + \alpha(h(x)) \ge 0
$$
这个不等式定义了在状态 $x$ 处所有**安[全控制](@entry_id:275827)输入**的集合，它是一个仿射[半空间](@entry_id:634770)。

#### $\mathcal{K}$类函数的作用与选择

扩展$\mathcal{K}$[类函数](@entry_id:146970) $\alpha: \mathbb{R} \to \mathbb{R}$ 是一个连续、严格单调递增且满足 $\alpha(0)=0$ 的函数。将其定义域扩展到整个实数域 $\mathbb{R}$ 至关重要。原因有二：
1.  **鲁棒性**：在实际系统中，由于[模型不确定性](@entry_id:265539)或外部扰动，状态可能会短暂地“侵入”不安全区域，导致 $h(x)$ 变为一个小的负值。此时，由于 $\alpha$ 是单调递增的，$\alpha(h(x))$ 也为负，$-\alpha(h(x))$ 则为正。CBF不等式 $\dot{h} \ge -\alpha(h(x))$ 会强制 $\dot{h}$ 为正，从而主动地将系统状态推回安全集。如果 $\alpha$ 仅定义在 $[0, \infty)$ 上，控制器在发生安全违规的瞬间将是未定义的 [@problem_id:2695306]。
2.  **高阶CBF的构造**：在处理[相对阶](@entry_id:171358)高于一的系统时，需要递归地定义一系列辅助函数。在这些构造中，即使初始的 $h(x) \ge 0$，中间的辅助函数也可能取负值。因此，$\alpha$ 函数必须能够在负[数域](@entry_id:155558)上进行有意义的评估 [@problem_id:2695306]。

一个特别重要且常用的选择是线性函数 $\alpha(s) = \gamma s$，其中 $\gamma > 0$ 是一个正常数。这种选择定义的CBF被称为**指数[控制屏障函数](@entry_id:177928) (Exponential Control Barrier Function, ECBF)** [@problem_id:2695277]。此时，安全约束变为：
$$
\dot{h}(x) + \gamma h(x) \ge 0
$$
根据比较引理 (Comparison Lemma)，该[微分不等式](@entry_id:137452)保证了 $h(x(t))$ 的下界呈指数衰减：
$$
h(x(t)) \ge h(x(0)) \exp(-\gamma t)
$$
这意味着系统状态接近边界 $h=0$ 的最快速度被指数级地限制了。参数 $\gamma$ 控制了这种限制的“严格程度”。
- 较小的 $\gamma$ 值意味着 $h(t)$ 允许的衰减速度更慢，这要求控制器在远离边界时就采取更“主动”或“保守”的干预，以维持一个较大的安全[裕度](@entry_id:274835)。
- 较大的 $\gamma$ 值允许 $h(t)$ 更快地接近边界，从而减少了对名义性能控制器的干预，但在靠近边界时可能需要更剧烈的控制动作来避免违规 [@problem_id:2695277]。

我们可以通过一个具体的例子来量化参数 $\gamma$（或记为 $\kappa$）的影响。考虑一个从轻微[不安全状态](@entry_id:756344) $h(0)=-\delta$ (其中 $\delta>0$) 恢复到 $h(\tau_\varepsilon)=-\varepsilon$ 所需的时间。在最坏情况下（即控制系统只提供满足约束的最小恢复力），恢复时间 $\tau_\varepsilon$ 的一个紧[上界](@entry_id:274738)为 $T^\star = \frac{1}{\kappa} \ln(\frac{\delta}{\varepsilon})$ [@problem_id:2695286]。这个结果清晰地表明，恢复速率与 $\kappa$ 成正比。

#### 基于二次规划的[控制器综合](@entry_id:261816)

在实践中，我们通常有一个为实现某个性能目标（如跟踪轨迹）而设计的**名义控制器 (nominal controller)** $u_{\text{nom}}(x)$。然而，$u_{\text{nom}}(x)$ 本身可能不满足安全约束。CBF的作用就是作为一个**安全滤波器 (safety filter)**，在最小化对名义控制器的修改的前提下，强制执行安全性。这通常通过求解一个**二次规划 (Quadratic Program, QP)** 问题来实现：

$$
\begin{aligned}
u^\star(x) = \arg\min_{u \in \mathbb{R}^m}  \quad \frac{1}{2}\|u - u_{\text{nom}}(x)\|^2 \\
\text{s.t.}  \quad L_f h(x) + L_g h(x) u + \alpha(h(x)) \ge 0
\end{aligned}
$$

该Q[P问题](@entry_id:267898)的解 $u^\star(x)$ 是在满足安全约束的仿射[半空间](@entry_id:634770)中，与 $u_{\text{nom}}(x)$ 的欧氏距离最近的点。
- 如果 $u_{\text{nom}}(x)$ 本身就是安全的，那么 $u^\star(x) = u_{\text{nom}}(x)$。
- 如果 $u_{\text{nom}}(x)$ 不安全，那么 $u^\star(x)$ 将是 $u_{\text{nom}}(x)$ 在安全半空间边界上的投影。

例如，考虑一个标量系统 $\dot{x}=u$，安全集为 $x \le 1$，由 $h(x) = 1-x \ge 0$ 定义。选择 $\alpha(s) = \kappa s$。我们有 $L_f h(x) = 0$ 和 $L_g h(x) = -1$。CBF约束为 $-u + \kappa(1-x) \ge 0$，即 $u \le \kappa(1-x)$。若在 $x=0.8$ 处，名义控制为 $u_{\text{nom}}=1.2$，且 $\kappa=3$，则安全约束为 $u \le 3(1-0.8)=0.6$。由于 $1.2 > 0.6$，名义控制不安全。QP的解就是将 $u_{\text{nom}}$ 投影到[可行域](@entry_id:136622) $(-\infty, 0.6]$ 上，得到最优安[全控制](@entry_id:275827) $u^\star = 0.6$ [@problem_id:2695296]。

### 高级CBF机制

上述框架在[相对阶](@entry_id:171358)为一的系统上非常有效，但许多实际系统的输入到输出之间存在更复杂的动态关系。

#### 高阶[控制屏障函数](@entry_id:177928) (HOCBF)

当系统的**[相对阶](@entry_id:171358) (relative degree)** $r$ 大于1时，意味着 $L_g h(x) = 0$ 在我们关心的区域内成立。此时，$\dot{h}(x)=L_f h(x)$，控制输入 $u$ 不出现在 $h$ 的一阶导数中，因此无法通过标准的ZCBF来直接控制安全性。

要重新获得控制权，我们必须对 $h$ 求更高阶的时间导数，直到 $u$ 出现为止。系统的[相对阶](@entry_id:171358) $r$ 被定义为满足 $L_g L_f^{k} h(x) = 0$ 对所有 $k  r-1$ 成立，且 $L_g L_f^{r-1} h(x) \neq 0$ 的最小正整数。
$h$ 的 $r$ 阶时间导数可以表示为：
$$
h^{(r)}(x, u) = L_f^r h(x) + L_g L_f^{r-1} h(x) u
$$
计算这些高阶李导数是应用HOCBF的第一步。例如，对于一个三阶系统，我们可能需要计算 $L_f^3 h(x)$ 和 $L_g L_f^2 h(x)$ [@problem_id:2695258]。

HOCBF通过递归地定义一系列函数和相应的安全集来工作。令 $\psi_0(x) = h(x)$，并定义：
$$
\begin{aligned}
\psi_1(x) = \dot{\psi}_0(x) + \alpha_1(\psi_0(x)) = L_f h(x) + \alpha_1(h(x)) \\
\psi_2(x) = \dot{\psi}_1(x) + \alpha_2(\psi_1(x)) \\
\vdots \\
\psi_r(x, u) = \dot{\psi}_{r-1}(x) + \alpha_r(\psi_{r-1}(x)) \ge 0
\end{aligned}
$$
其中 $\alpha_1, \dots, \alpha_r$ 是一组扩展$\mathcal{K}$类函数。这个级联结构确保了如果 $\psi_i(x) \ge 0$，那么 $\psi_{i-1}(x)$ 也将保持非负，最终保证了原始的 $h(x)=\psi_0(x)$ 的安全性。最终的约束 $\psi_r(x, u) \ge 0$ 是一个关于 $u$ 的仿射不等式，因为 $\psi_r$ 的表达式中包含了 $h^{(r)}$，从而引入了 $u$。

一个常用的方法是进行**输入-输出[反馈线性化](@entry_id:163432) (input-output feedback linearization)**。我们定义一个新的虚拟输入 $v = h^{(r)}(x, u)$。这样，原始的[非线性系统](@entry_id:168347)在输入-输出层面被转化为一个 $r$ 阶的[积分器](@entry_id:261578)链 $\ddot{y} = v$（以 $r=2$ 为例）。HOCBF约束可以被重写为关于这个新输入 $v$ 的一个[线性不等式](@entry_id:174297)，例如 $v \ge v_{\min}(x)$ [@problem_id:2695259]。然后，我们可以设计 $v$ 来满足此安全约束以及其他性能目标，最后通过 $v = L_f^r h(x) + L_g L_f^{r-1} h(x) u$ 反解出实际的控制输入 $u$。

值得注意的是，即使在某些点上 $L_g h(x)=0$，也不一定意味着系统本质上不安全。如果在这些点上，系统的自然漂移项本身就是有利的（例如，在边界点 $x^\star$ 上有 $L_f h(x^\star) \ge 0$），那么系统在没有控制干预的情况下也能瞬时满足安全条件。然而，这种被动的安全性是脆弱的，缺乏主动恢复的能力。因此，只要需要鲁棒的控制权威，就必须采用HOCBF等高阶方法 [@problem_id:2695249]。

#### 多重与非平滑约束

在许多应用中，安[全集](@entry_id:264200)由多个约束共同定义，或者约束函数本身不是光滑的。

**多重约束**：当安[全集](@entry_id:264200)是多个水平集的交集时，即 $\mathcal{C} = \bigcap_{i=1}^{m_c} \{x : h_i(x) \ge 0\}$，情况变得更加复杂。为了保证整个集合 $\mathcal{C}$ 的[前向不变性](@entry_id:170094)，系统轨迹在任何时刻都不能离开任何一个[子集](@entry_id:261956) $\mathcal{C}_i$。这意味着，在任意状态 $x$，必须存在一个**共同的**控制输入 $u$，它能**同时满足**所有激活的（即 $h_i(x)$ 接近于零的）约束所对应的CBF不等式：
$$
L_f h_i(x) + L_g h_i(x) u + \alpha_i(h_i(x)) \ge 0, \quad \forall i \in \{1, \dots, m_c\}
$$
在几何上，当状态处于多个约束边界的交点（一个“角落”）时，允许的速度[向量空间](@entry_id:151108)（[切锥](@entry_id:191609)）是各个独立边界所允许的半空间的交集。在满足[正则性条件](@entry_id:166962)（如Mangasarian-Fromovitz[约束规范](@entry_id:635836)，MFCQ）下，这个交集使得安全条件变得更加严格，因为可行的控制方向更少 [@problem_id:2695309]。[控制器设计](@entry_id:274982)也相应地变为一个具有[多重线性](@entry_id:151506)约束的Q[P问题](@entry_id:267898)。

**非平滑屏障函数**：有时安[全集](@entry_id:264200)更自然地由非平滑函数定义，例如 $h(x) = \min_i\{h_i(x)\}$ 或包含[绝对值](@entry_id:147688)、最大/最小值的函数。这些函数通常是局部李普希兹 (locally Lipschitz) 但不可微的。在这种情况下，经典的李导数不再适用。

我们需要借助非光滑分析的工具。关键的推广是使用**Clarke广义梯度 (Clarke generalized gradient)** $\partial h(x)$ 来替代梯度 $\nabla h(x)$。对于一个局部李普希兹函数，其在某点 $x$ 的Clarke广义梯度是一个[紧凸集](@entry_id:272594)，它刻画了该点附近所有可微点梯度的极限行为。

基于此，非平滑CBF条件可以表述为：在系统的运动方向上，$h$ 的“最坏情况”下的增长率必须满足下界。这通过Clarke方向导数 $h^\circ(x;d) = \max_{v \in \partial h(x)} v^\top d$ 来形式化。非平滑CBF不等式要求存在一个控制 $u$ 使得：
$$
\max_{v \in \partial h(x)} v^\top(f(x) + g(x)u) + \alpha(h(x)) \ge 0
$$
这个条件确保了即使沿着最不利的梯度方向，$h$ 的值也不会以过快的速度减小，从而保证安全性 [@problem_id:2695262]。在实践中，这个 `max` 形式的约束虽然不是线性的，但通常可以转化为一组[线性约束](@entry_id:636966)（因为 $\partial h(x)$ 是一个多面体），从而仍然可以用QP求解。例如，对于 $h(x)=\min\{h_1(x), h_2(x)\}$，在 $h_1=h_2$ 的点，广义梯度是 $\text{conv}\{\nabla h_1, \nabla h_2\}$，约束变为 $\max\{\nabla h_1^\top \dot{x}, \nabla h_2^\top \dot{x}\} + \alpha(h) \ge 0$，等价于两个独立的[线性约束](@entry_id:636966) [@problem_id:2695275]。

本章系统地介绍了[控制屏障函数](@entry_id:177928)的原理与机制，从平滑单约束的基础理论出发，逐步扩展到高阶、多重及非平滑等更复杂但更具实际意义的场景。这些工具共同构成了一个强大的框架，用于设计可验证安全的控制系统。