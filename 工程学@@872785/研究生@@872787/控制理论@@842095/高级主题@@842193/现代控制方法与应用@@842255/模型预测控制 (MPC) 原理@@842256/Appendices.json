{"hands_on_practices": [{"introduction": "模型预测控制的核心是在每个时间步求解一个约束优化问题。本练习将带您回归第一性原理，通过解析方法求解一个简单的线性MPC问题。通过构建拉格朗日函数并应用Karush-Kuhn-Tucker (KKT) 条件 [@problem_id:2724762]，您将亲手推导出最优控制输入是如何由系统动态、代价函数和有效约束共同决定的，从而对MPC的内部工作机制建立深刻的直觉。", "problem": "考虑一个用于模型预测控制 (MPC) 的一维离散时间线性系统，其动态方程为 $x_{k+1}=a x_k + b u_k$，其中 $x_k \\in \\mathbb{R}$ 且 $u_k \\in \\mathbb{R}$。设预测时域为 $N=2$，决策变量为 $u_0$ 和 $u_1$。需要最小化的二次性能指标为\n$$J = q x_1^2 + r u_0^2 + p x_2^2 + r u_1^2,$$\n受以下动态方程约束\n$$x_1 = a x_0 + b u_0, \\quad x_2 = a x_1 + b u_1,$$\n以及在终端步骤的一个仿射不等式约束，\n$$x_2 \\ge \\underline{x},$$\n所有其他约束均不存在。假设在最优点，此单一不等式约束是激活的，而所有其他约束都是非激活的。\n\n使用凸二次规划的 Karush–Kuhn–Tucker (KKT) 条件，分析推导并求解所得系统，以获得最优的第一步控制输入 $u_0^{\\star}$。您必须从动态方程、成本和激活不等式的定义出发，构建拉格朗日函数，写出平稳性条件、原始可行性、对偶可行性和互补松弛性条件，并求解它们以获得 $u_0^{\\star}$。\n\n使用以下数值指定且科学一致的参数：$a=1.2$，$b=1$，$q=1$，$r=0.5$，$p=2$，$x_0=1$ 和 $\\underline{x}=0.8$。\n\n将您的最终答案表示为一个四舍五入到四位有效数字的实数（无单位）。", "solution": "所给问题是一个结构良好、有科学依据的最优控制问题，可以使用约束优化的 Karush–Kuhn–Tucker (KKT) 条件来解决。该问题是有效的，我们继续进行解析求解。\n\n系统动态由线性差分方程 $x_{k+1}=a x_k + b u_k$ 给出。给定初始状态 $x_0$ 和预测时域 $N=2$，状态可以用控制输入 $u_0$ 和 $u_1$ 表示如下：\n$$x_1 = a x_0 + b u_0$$\n$$x_2 = a x_1 + b u_1 = a(a x_0 + b u_0) + b u_1 = a^2 x_0 + ab u_0 + b u_1$$\n\n目标是最小化二次性能指标 $J$：\n$$J(u_0, u_1) = q x_1^2 + r u_0^2 + p x_2^2 + r u_1^2$$\n将 $x_1$ 和 $x_2$ 关于 $u_0$ 和 $u_1$ 的表达式代入，成本函数变为：\n$$J(u_0, u_1) = q(a x_0 + b u_0)^2 + r u_0^2 + p(a^2 x_0 + ab u_0 + b u_1)^2 + r u_1^2$$\n\n该优化问题受制于终端状态约束 $x_2 \\ge \\underline{x}$，可以写成标准形式 $g(u_0, u_1) \\le 0$ 如下：\n$$g(u_0, u_1) = \\underline{x} - x_2 = \\underline{x} - (a^2 x_0 + ab u_0 + b u_1) \\le 0$$\n\n这是一个凸二次规划问题，因为成本函数 $J$ 是具有正系数（$q, r, p > 0$）的平方项之和，使其成为严格凸函数，并且约束是仿射的。我们通过引入一个拉格朗日乘子 $\\lambda$ 来构造拉格朗日函数 $\\mathcal{L}$：\n$$\\mathcal{L}(u_0, u_1, \\lambda) = J(u_0, u_1) + \\lambda g(u_0, u_1)$$\n$$\\mathcal{L}(u_0, u_1, \\lambda) = q(a x_0 + b u_0)^2 + r u_0^2 + p(a^2 x_0 + ab u_0 + b u_1)^2 + r u_1^2 + \\lambda(\\underline{x} - (a^2 x_0 + ab u_0 + b u_1))$$\n\n最优性的 KKT 条件如下：\n1.  **平稳性条件 (Stationarity)**：拉格朗日函数相对于决策变量的梯度必须为零。\n    $$\\frac{\\partial \\mathcal{L}}{\\partial u_0} = 2q(a x_0 + b u_0)b + 2r u_0 + 2p(a^2 x_0 + ab u_0 + b u_1)ab - \\lambda ab = 0$$\n    $$\\frac{\\partial \\mathcal{L}}{\\partial u_1} = 2p(a^2 x_0 + ab u_0 + b u_1)b + 2r u_1 - \\lambda b = 0$$\n2.  **原始可行性 (Primal Feasibility)**：约束必须被满足。\n    $$\\underline{x} - (a^2 x_0 + ab u_0 + b u_1) \\le 0$$\n3.  **对偶可行性 (Dual Feasibility)**：对于形如 $g \\le 0$ 的不等式，其拉格朗日乘子必须是非负的。\n    $$\\lambda \\ge 0$$\n4.  **互补松弛性 (Complementary Slackness)**：乘子与约束函数的乘积必须为零。\n    $$\\lambda(\\underline{x} - (a^2 x_0 + ab u_0 + b u_1)) = 0$$\n\n问题陈述在最优点处，不等式约束是激活的。这意味着：\n$$x_2 = a^2 x_0 + ab u_0 + b u_1 = \\underline{x}$$\n这满足了原始可行性条件。它也满足了互补松弛性条件，使得 $\\lambda$ 待定。利用 $x_2 = \\underline{x}$ 并除以非零因子（$b=1 \\ne 0$），可以简化平稳性方程。\n\n第一个平稳性方程在除以 $2b$ 后变为：\n$$q(a x_0 + b u_0) + \\frac{r}{b}u_0 + pa\\underline{x} - \\frac{\\lambda a}{2} = 0 \\quad (1)$$\n第二个平稳性方程在除以 $2b$ 后变为：\n$$p\\underline{x} + \\frac{r}{b}u_1 - \\frac{\\lambda}{2} = 0 \\quad (2)$$\n\n从方程 $(2)$ 中，我们将 $\\frac{\\lambda}{2}$ 用 $u_1$ 表示：\n$$\\frac{\\lambda}{2} = p\\underline{x} + \\frac{r}{b}u_1$$\n我们将这个 $\\frac{\\lambda}{2}$ 的表达式代入方程 $(1)$：\n$$q(a x_0 + b u_0) + \\frac{r}{b}u_0 + pa\\underline{x} - a\\left(p\\underline{x} + \\frac{r}{b}u_1\\right) = 0$$\n$$q(a x_0 + b u_0) + \\frac{r}{b}u_0 + pa\\underline{x} - pa\\underline{x} - \\frac{ar}{b}u_1 = 0$$\n$$q(a x_0 + b u_0) + \\frac{r}{b}u_0 - \\frac{ar}{b}u_1 = 0$$\n两边乘以 $b$ 并展开得到：\n$$qabx_0 + qb^2 u_0 + ru_0 - aru_1 = 0$$\n$$u_0(qb^2+r) + qabx_0 - aru_1 = 0 \\quad (A)$$\n\n我们现在得到了一个关于两个未知数 $u_0$ 和 $u_1$ 的二元线性方程组：\n$$(A): \\quad u_0(qb^2+r) + qabx_0 - aru_1 = 0$$\n$$(B): \\quad a^2 x_0 + ab u_0 + b u_1 = \\underline{x}$$\n从 $(B)$ 中，我们求解 $u_1$：\n$$b u_1 = \\underline{x} - a^2 x_0 - ab u_0 \\implies u_1 = \\frac{1}{b}(\\underline{x} - a^2 x_0 - ab u_0)$$\n将此代入 $(A)$：\n$$u_0(qb^2+r) + qabx_0 - ar \\left(\\frac{1}{b}(\\underline{x} - a^2 x_0 - ab u_0)\\right) = 0$$\n$$u_0(qb^2+r) + qabx_0 - \\frac{ar}{b}(\\underline{x} - a^2 x_0) + a^2 r u_0 = 0$$\n将含有 $u_0$ 的项归类：\n$$u_0(qb^2+r+a^2r) = \\frac{ar}{b}(\\underline{x} - a^2 x_0) - qabx_0$$\n最后，我们求解最优的第一步控制输入 $u_0^{\\star}$：\n$$u_0^{\\star} = \\frac{\\frac{ar}{b}(\\underline{x} - a^2 x_0) - qabx_0}{qb^2 + r + a^2 r}$$\n\n现在我们代入给定的数值：$a=1.2$，$b=1$，$q=1$，$r=0.5$，$x_0=1$ 和 $\\underline{x}=0.8$。\n分子是：\n$$\\frac{(1.2)(0.5)}{1}(0.8 - (1.2)^2(1)) - (1)(1.2)(1)(1) = 0.6(0.8 - 1.44) - 1.2 = 0.6(-0.64) - 1.2 = -0.384 - 1.2 = -1.584$$\n分母是：\n$$(1)(1)^2 + 0.5 + (1.2)^2(0.5) = 1 + 0.5 + (1.44)(0.5) = 1.5 + 0.72 = 2.22$$\n因此，最优控制输入是：\n$$u_0^{\\star} = \\frac{-1.584}{2.22} \\approx -0.7135135...$$\n四舍五入到四位有效数字，我们得到 $u_0^{\\star} = -0.7135$。\n\n作为一致性检验，我们可以计算 $\\lambda$ 的值。\n$u_0^{\\star} \\approx -0.7135135$\n$u_1^{\\star} = \\frac{1}{1}(0.8 - (1.2)^2(1) - (1.2)(1)u_0^{\\star}) = -0.64 - 1.2(-0.7135135) \\approx 0.2162162$\n$\\lambda^{\\star} = 2\\left(p\\underline{x} + \\frac{r}{b}u_1^{\\star}\\right) = 2\\left((2)(0.8) + \\frac{0.5}{1}(0.2162162)\\right) = 2(1.6 + 0.1081081) \\approx 3.416$\n由于 $\\lambda^{\\star} > 0$，对偶可行性条件得到满足，这证实了假设约束为激活状态的正确性。", "answer": "$$\\boxed{-0.7135}$$", "id": "2724762"}, {"introduction": "虽然线性MPC提供了理论基础，但许多实际系统具有显著的非线性。本练习将指导您实践一种解决非线性MPC问题的核心算法：序列二次规划 (SQP)。您将围绕一个名义轨迹，通过对非线性动态进行线性化，并构建相应的二次规划 (QP) 子问题，从而完成单次SQP迭代的关键步骤 [@problem_id:2724668]。这个过程揭示了如何将复杂的非线性问题转化为一系列易于求解的QP问题，这是现代NMPC求解器的基石。", "problem": "考虑一个用于模型预测控制（MPC）的离散时间非线性预测模型，其中模型预测控制（MPC）是一种基于优化的反馈控制策略，在每个采样时刻求解一个有限时域最优控制问题，而序列二次规划（SQP）是一种通过局部线性化和二次化来迭代求解二次规划（QP）子问题的方法。对于标量状态 $x \\in \\mathbb{R}$ 和标量输入 $u \\in \\mathbb{R}$，模型为\n$$\nx_{k+1} \\;=\\; f(x_k,u_k) \\;=\\; x_k \\;+\\; h\\big(\\sin(x_k) + u_k^3\\big),\n$$\n采样周期为 $h0$。设有限时域成本为\n$$\nJ(x_{0},U) \\;=\\; \\sum_{k=0}^{N-1} \\Big((x_k - x_{\\mathrm{ref}})^2 Q \\;+\\; u_k^2 R\\Big) \\;+\\; (x_N - x_{\\mathrm{ref}})^2 P,\n$$\n其中 $U \\triangleq [u_0,\\dots,u_{N-1}]$，并且 $Q \\ge 0$，$R  0$，$P \\ge 0$ 和 $x_{\\mathrm{ref}} \\in \\mathbb{R}$ 是给定值。假设采用直接单次打靶法：给定初始状态 $x_0$ 和初始输入序列猜测值 $U^{(0)}$，使用真实的非线性动力学 $x_{k+1}^{(0)} = f(x_k^{(0)},u_k^{(0)})$ 模拟标称轨迹 $\\{x_k^{(0)}\\}_{k=0}^{N}$。\n\n一次序列二次规划（SQP）迭代通过线性化动力学并将二次成本作为局部模型，构建一个关于扰动 $\\delta x_k \\triangleq x_k - x_k^{(0)}$ 和 $\\delta u_k \\triangleq u_k - u_k^{(0)}$ 的凸二次规划（QP）子问题。使用以下基本依据：\n\n- 离散时间系统的线性化由一阶泰勒展开给出，\n$$\n\\delta x_{k+1} \\;=\\; A_k \\,\\delta x_k \\;+\\; B_k \\,\\delta u_k \\;+\\; r_k,\n$$\n其中 $A_k \\triangleq \\frac{\\partial f}{\\partial x}(x_k^{(0)},u_k^{(0)})$，$B_k \\triangleq \\frac{\\partial f}{\\partial u}(x_k^{(0)},u_k^{(0)})$，以及 $r_k \\triangleq f(x_k^{(0)},u_k^{(0)}) - x_{k+1}^{(0)}$。由于标称轨迹是由真实动力学生成的，因此对于所有 $k$，必须取 $r_k = 0$。\n\n- 围绕标称 $(x_k^{(0)},u_k^{(0)})$ 的二次成本展开，在不计一个与 $(\\delta x,\\delta u)$ 无关的加性常数的情况下，得到\n$$\n\\begin{aligned}\n\\tilde{J}(\\delta x,\\delta u) \\;=\\; \\sum_{k=0}^{N-1} \\Big( Q\\,\\delta x_k^2 \\;+\\; 2Q\\,e_k\\,\\delta x_k \\;+\\; R\\,\\delta u_k^2 \\;+\\; 2R\\,u_k^{(0)}\\,\\delta u_k \\Big) \\\\\n+\\; P\\,\\delta x_N^2 \\;+\\; 2P\\,e_N\\,\\delta x_N,\n\\end{aligned}\n$$\n其中 $e_k \\triangleq x_k^{(0)} - x_{\\mathrm{ref}}$。在直接单次打靶 SQP 中，初始状态是固定的，所以 $\\delta x_0 = 0$ 不是一个决策变量。\n\n通过堆叠状态和输入扰动来定义 QP 决策向量\n$$\nv \\;\\triangleq\\; [\\delta x_1,\\dots,\\delta x_N,\\,\\delta u_0,\\dots,\\delta u_{N-1}]^\\top \\in \\mathbb{R}^{2N}.\n$$\n将 QP 写成标准形式\n$$\n\\min_{v \\in \\mathbb{R}^{2N}} \\;\\; \\tfrac{1}{2} v^\\top H v \\;+\\; h^\\top v \\quad \\text{subject to} \\quad E v = b,\n$$\n其组成部分如下：\n\n- 等式约束是 $\\delta x_0 = 0$ 时的线性化动力学，\n$$\n\\delta x_{k+1} - A_k \\delta x_k - B_k \\delta u_k = 0, \\quad k = 0,\\dots,N-1,\n$$\n其中当 $k=0$ 时，项 $A_0 \\delta x_0$ 恒等于 $0$，因此被省略。将这些约束集合成 $E v = b$，其中 $b = 0$。\n\n- 二次项矩阵 $H$ 和线性项向量 $h$ 来自于用 $v$ 表示的 $\\tilde{J}$，并约定目标函数为 $\\tfrac{1}{2} v^\\top H v + h^\\top v$：对于 $k=1,\\dots,N-1$ 时对应于 $\\delta x_k$ 的条目，使用对角系数 $2Q$；对于 $\\delta x_N$，使用 $2P$；对于每个 $\\delta u_k$，使用 $2R$。线性项的条目对于 $k=1,\\dots,N-1$ 时的 $\\delta x_k$ 是 $2Q e_k$，对于 $\\delta x_N$ 是 $2P e_N$，对于 $\\delta u_k$ 是 $2R u_k^{(0)}$。\n\n形式上，\n$$\nH \\;=\\; \\mathrm{diag}(\\underbrace{2Q,\\dots,2Q}_{N-1\\text{ times}},\\,2P,\\,\\underbrace{2R,\\dots,2R}_{N\\text{ times}}), \\quad\nh \\;=\\; [2Q e_1,\\dots,2Q e_{N-1},\\,2P e_N,\\,2R u_0^{(0)},\\dots,2R u_{N-1}^{(0)}]^\\top.\n$$\n\n对于等式约束的 QP，其 Karush–Kuhn–Tucker (KKT) 系统为\n$$\n\\begin{bmatrix}\nH  E^\\top \\\\\nE  0\n\\end{bmatrix}\n\\begin{bmatrix}\nv^\\star \\\\ \\lambda^\\star\n\\end{bmatrix}\n\\;=\\;\n\\begin{bmatrix}\n-\\,h \\\\ b\n\\end{bmatrix},\n$$\n该系统的解给出了唯一的最优步长 $v^\\star$；对应于 $\\delta u_k$ 的分量即为所需的步长 $\\delta u_k^\\star$。将输入序列的步长报告为\n$$\n\\delta U^\\star \\;\\triangleq\\; [\\delta u_0^\\star,\\dots,\\delta u_{N-1}^\\star].\n$$\n\n对于下面的每个测试用例，你必须精确执行一次 SQP 迭代（构建标称轨迹，计算 $A_k$ 和 $B_k$，组装 QP，求解 KKT 系统）。使用以下基本导数\n$$\nA_k \\;=\\; \\frac{\\partial f}{\\partial x}(x_k^{(0)},u_k^{(0)}) \\;=\\; 1 + h \\cos\\!\\big(x_k^{(0)}\\big), \\quad\nB_k \\;=\\; \\frac{\\partial f}{\\partial u}(x_k^{(0)},u_k^{(0)}) \\;=\\; 3h \\big(u_k^{(0)}\\big)^2.\n$$\n\n测试套件。对于每组参数，按所述方法计算 $\\delta U^\\star$。所有列出的数字都是实数标量；向量是实数行向量。\n\n- 用例 A：$N = 3$，$h = 0.1$，$Q = 1.0$，$R = 0.1$，$P = 1.0$，$x_0 = 0.5$，$x_{\\mathrm{ref}} = 0.0$，$U^{(0)} = [0.2,\\,0.2,\\,0.2]$。\n- 用例 B：$N = 3$，$h = 0.1$，$Q = 10.0$，$R = 1.0$，$P = 10.0$，$x_0 = 1.5$，$x_{\\mathrm{ref}} = 1.0$，$U^{(0)} = [-0.1,\\,-0.1,\\,-0.1]$。\n- 用例 C：$N = 3$，$h = 0.1$，$Q = 1.0$，$R = 0.01$，$P = 1.0$，$x_0 = 0.1$，$x_{\\mathrm{ref}} = 0.0$，$U^{(0)} = [0.0,\\,0.0,\\,0.0]$。\n- 用例 D：$N = 3$，$h = 0.2$，$Q = 0.5$，$R = 0.05$，$P = 0.5$，$x_0 = -0.7$，$x_{\\mathrm{ref}} = 0.0$，$U^{(0)} = [0.5,\\,-0.5,\\,0.5]$。\n\n最终输出格式。你的程序应生成单行输出，其中包含四个向量 $\\delta U^\\star$ 的结果，以逗号分隔列表的形式用方括号括起来，每个向量也以逗号分隔列表的形式用方括号括起来，每个标量四舍五入到小数点后六位。例如，包含两个用例的输出应如下所示：$[[0.123456,-0.000001],[0.000000,0.000000]]$。本问题中有四个用例，因此输出必须为 $[[\\cdot,\\cdot,\\cdot],[\\cdot,\\cdot,\\cdot],[\\cdot,\\cdot,\\cdot],[\\cdot,\\cdot,\\cdot]]$ 的形式。", "solution": "所提出的问题是计算控制理论中一个定义明确的标准练习，具体涉及将序列二次规划（SQP）应用于非线性模型预测控制（MPC）问题。该问题有科学依据，内容自洽，且算法明确。因此，该问题是有效的，并将提供解答。\n\n任务是计算单个 SQP 步长，这涉及找到对标称控制序列的最优扰动 $\\delta U^\\star = [\\delta u_0^\\star, \\dots, \\delta u_{N-1}^\\star]^\\top$。这通过首先围绕标称轨迹对系统动力学进行线性化并将成本函数二次化，从而创建一个二次规划（QP）子问题来实现。然后通过其 Karush-Kuhn-Tucker (KKT) 条件求解该 QP。每个测试用例的过程包括四个主要步骤。\n\n**步骤 1：生成标称轨迹**\n\n给定初始状态 $x_0$ 和标称控制序列 $U^{(0)} = [u_0^{(0)}, \\dots, u_{N-1}^{(0)}]$，我们必须首先计算相应的标称状态轨迹 $\\{x_k^{(0)}\\}_{k=0}^{N}$。我们从 $x_0^{(0)} = x_0$ 开始，迭代应用非线性动力学：\n$$\nx_{k+1}^{(0)} = f(x_k^{(0)}, u_k^{(0)}) = x_k^{(0)} + h\\big(\\sin(x_k^{(0)}) + (u_k^{(0)})^3\\big) \\quad \\text{for } k=0, \\dots, N-1.\n$$\n这提供了我们将围绕其构建 QP 的参考轨迹 $(X^{(0)}, U^{(0)})$。\n\n**步骤 2：系统动力学的线性化**\n\n非线性动力学在标称轨迹周围进行线性化。扰动 $\\delta x_k = x_k - x_k^{(0)}$ 和 $\\delta u_k = u_k - u_k^{(0)}$ 的演化由一阶泰勒展开近似：\n$$\n\\delta x_{k+1} = A_k \\delta x_k + B_k \\delta u_k,\n$$\n其中 $A_k$ 和 $B_k$ 是动力学函数 $f(x, u)$ 在标称轨迹的每个点 $(x_k^{(0)}, u_k^{(0)})$ 处求值的雅可比矩阵。偏导数如下：\n$$\nA_k = \\frac{\\partial f}{\\partial x}\\bigg|_{(x_k^{(0)}, u_k^{(0)})} = 1 + h \\cos(x_k^{(0)})\n$$\n$$\nB_k = \\frac{\\partial f}{\\partial u}\\bigg|_{(x_k^{(0)}, u_k^{(0)})} = 3h (u_k^{(0)})^2\n$$\n这些矩阵是为 $k=0, \\dots, N-1$ 计算的。\n\n**步骤 3：QP 子问题的构建**\n\nQP 子问题是根据决策向量 $v \\triangleq [\\delta x_1, \\dots, \\delta x_N, \\delta u_0, \\dots, \\delta u_{N-1}]^\\top \\in \\mathbb{R}^{2N}$ 构建的。问题是在线性等式约束下最小化一个二次目标：\n$$\n\\min_{v \\in \\mathbb{R}^{2N}} \\;\\; \\tfrac{1}{2} v^\\top H v \\;+\\; h^\\top v \\quad \\text{subject to} \\quad E v = b.\n$$\n该 QP 的组成部分构建如下：\n\n-   **目标函数：** 矩阵 $H$ 和 $h$ 是从成本函数 $J$ 围绕标称轨迹的二阶泰勒展开中导出的。问题直接给出了它们。\n    Hessian矩阵 $H \\in \\mathbb{R}^{2N \\times 2N}$ 是一个对角矩阵：\n    $$\n    H = \\mathrm{diag}(\\underbrace{2Q, \\dots, 2Q}_{N-1 \\text{ times}}, 2P, \\underbrace{2R, \\dots, 2R}_{N \\text{ times}}).\n    $$\n    梯度向量 $h \\in \\mathbb{R}^{2N}$ 是由跟踪误差 $e_k = x_k^{(0)} - x_{\\mathrm{ref}}$ 和标称输入 $u_k^{(0)}$ 构建的：\n    $$\n    h = [2Q e_1, \\dots, 2Q e_{N-1}, 2P e_N, 2R u_0^{(0)}, \\dots, 2R u_{N-1}^{(0)}]^\\top.\n    $$\n\n-   **等式约束：** 约束强制执行线性化动力学。对于 $k=0, \\dots, N-1$，我们有 $\\delta x_{k+1} - A_k \\delta x_k - B_k \\delta u_k = 0$。由于初始状态是固定的，所以 $\\delta x_0 = 0$。这 $N$ 个线性方程被组装成矩阵方程 $E v = b$。\n    约束矩阵 $E \\in \\mathbb{R}^{N \\times 2N}$ 填充了每个方程中决策变量的系数。对于 $N=3$，其结构为：\n    $$\n    E = \\begin{bmatrix}\n    1  0  0  -B_0  0  0 \\\\\n    -A_1  1  0  0  -B_1  0 \\\\\n    0  -A_2  1  0  0  -B_2\n    \\end{bmatrix}.\n    $$\n    右侧向量 $b$ 是零向量，$b=0 \\in \\mathbb{R}^N$。\n\n**步骤 4：KKT 系统的求解**\n\n等式约束 QP 的唯一解是通过求解 Karush-Kuhn-Tucker (KKT) 线性方程组找到的。该系统结合了最优性条件（拉格朗日函数的梯度为零）和可行性条件（满足约束）：\n$$\n\\begin{bmatrix}\nH  E^\\top \\\\\nE  0\n\\end{bmatrix}\n\\begin{bmatrix}\nv^\\star \\\\ \\lambda^\\star\n\\end{bmatrix}\n=\n\\begin{bmatrix}\n-h \\\\ b\n\\end{bmatrix},\n$$\n其中 $v^\\star$ 是最优扰动向量，$\\lambda^\\star \\in \\mathbb{R}^N$ 是拉格朗日乘子向量。对于我们的问题，$b=0$。KKT 矩阵是一个大小为 $(3N \\times 3N)$ 的方形对称矩阵。求解该系统可得到 $v^\\star$。\n\n所需结果 $\\delta U^\\star$ 从解向量 $v^\\star$ 中提取。具体来说，$v^\\star$ 中对应于输入扰动 $[\\delta u_0^\\star, \\dots, \\delta u_{N-1}^\\star]^\\top$ 的分量构成了一次 SQP 迭代的最终答案。对提供的每个测试用例都执行此过程。", "answer": "[[-0.672412,-0.505671,-0.323577],[-0.101700,-0.038450,0.016335],[-0.725171,-0.503719,-0.276605],[0.315939,-0.175492,0.395726]]", "id": "2724668"}, {"introduction": "在理论之外，一个成功的MPC控制器必须在面对模型失配或未预料的扰动时保持鲁棒性，这些情况可能导致优化问题变得不可行。本练习聚焦于解决这一关键挑战的实用技术：通过引入松弛变量来实现“软约束”。您将实现一个带有可行性恢复功能的MPC控制器，并分析控制器如何在约束违反和控制性能之间进行权衡 [@problem_id:2724817]，从而确保控制器在任何情况下都能提供一个（次优但安全的）解，保证系统的持续运行。", "problem": "考虑由状态更新方程 $x_{k+1} = a x_k + b u_k$ 定义的离散时间、单输入、单输出线性时不变系统，其中 $a = 1$ 且 $b = 1$。硬状态约束为 $|x_k| \\le x_{\\max}$，其中 $x_{\\max} = 2$；硬输入约束为 $u_k \\in \\mathcal{U}_d$，其中有限离散输入集为 $\\mathcal{U}_d = \\{-u_{\\max}, -\\tfrac{u_{\\max}}{2}, 0, \\tfrac{u_{\\max}}{2}, u_{\\max}\\}$，且 $u_{\\max} = 1$。您将通过在每个时间步求解一个长度为 $N = 4$ 的预测时域上的开环最优控制问题，来实现一个有限时域模型预测控制（MPC）律。该问题通过向状态约束中添加松弛变量来进行可行性恢复。\n\n将带软约束的 MPC 问题表述如下。对于给定的当前状态 $x_0$，决策变量是输入序列 $(u_0,\\dots,u_{N-1}) \\in \\mathcal{U}_d^N$ 和非负松弛序列 $(s_1,\\dots,s_N)$，其中 $s_i \\ge 0$。预测状态 $(x_1,\\dots,x_N)$ 根据 $x_{i+1} = a x_i + b u_i$ 演化，其中 $i \\in \\{0,\\dots,N-1\\}$。经松弛变量增强的状态约束为 $|x_i| \\le x_{\\max} + s_i$，其中 $i \\in \\{1,\\dots,N\\}$。阶段成本和终端成本使用权重 $q = 0$、 $r = 0.1$、 $p = 0$，以及对松弛变量的 $\\ell_1$-惩罚，其权重为 $\\rho  0$，因此有限时域成本为\n$$\nJ(x_0; u_{0:N-1}, s_{1:N}) = \\sum_{i=0}^{N-1} \\left( q x_i^2 + r u_i^2 + \\rho s_{i+1} \\right) + p x_N^2.\n$$\n由于 $q = 0$ 和 $p = 0$，成本简化为输入能耗和松弛惩罚之和。在每个时间步，将最优序列的第一个元素 $u_0^\\star$ 应用于系统，通过 $x^+ = a x + b u_0^\\star$ 更新状态，并以滚动的时域重复此过程（滚动时域实现）。\n\n您的程序必须严格地从上述基本定义出发，不使用任何连续优化捷径来实现以下内容：\n\n- 在每个时间步，使用对离散集 $\\mathcal{U}_d$ 的穷举枚举来精确求解开环问题。对于每个候选输入序列 $(u_0,\\dots,u_{N-1})$，计算预测轨迹 $(x_1,\\dots,x_N)$ 和由 $s_i^\\star = \\max\\{0, |x_i| - x_{\\max}\\}$ 定义的最小松弛值（其中 $i \\in \\{1,\\dots,N\\}$），这对于 $\\ell_1$ 惩罚的可行性恢复是最优的。评估总成本 $J$ 并选择一个最优序列；如果多个序列的成本相等，则选择 $\\sum_{i=1}^N s_i^\\star$ 最小的序列作为确定性的打破平局规则。\n\n- 从初始状态 $x_{\\mathrm{init}}$ 开始，在有限的闭环时间 $T$（在下面的每个测试用例中指定）内执行此滚动时域过程。记录：\n  1. 实现的松弛序列 $\\sigma_k = \\max\\{0, |x_k| - x_{\\max}\\}$，其中 $k \\in \\{0,1,\\dots,T\\}$。\n  2. 在每个时间步 $k$，最优预测是否在预测时域上满足零松弛，即对于所有 $i \\in \\{1,\\dots,N\\}$ 是否有 $s_i^\\star = 0$。\n\n- 如下分析可行性恢复下的递归可行性，并为每个测试用例返回三个布尔指标：\n  1. always_feasible：如果在每个时间步 $k \\in \\{0,\\dots,T-1\\}$，开环问题在松弛增强的约束下至少存在一个具有有限成本的可行解，则返回 true。根据给定的构造，如果算法按规定实现，此项应成立。\n  2. zero_slack_invariant：如果在某个时间步 $k$，最优预测松弛序列满足对所有 $i \\in \\{1,\\dots,N\\}$ 都有 $s_i^\\star = 0$，则一步移位的候选输入序列 $(u_1^\\star,\\dots,u_{N-1}^\\star,0)$ 在时间 $k+1$ 产生的预测状态序列在新时域上的所有索引（包括附加的终端输入为 $0$ 的终端预测）也满足 $|x_i| \\le x_{\\max}$，则返回 true。如果没有出现预测松弛为零的时间步，则将此属性定义为空真（vacuously true）。\n  3. eventual_zero_slack：如果存在一个索引 $\\bar{k} \\in \\{0,\\dots,T\\}$，使得对于所有 $k \\in \\{\\bar{k}, \\bar{k}+1, \\dots, T\\}$ 都有 $\\sigma_k = 0$，则返回 true。\n\n您的实现必须使用 $a = 1$、$b = 1$、$x_{\\max} = 2$、$u_{\\max} = 1$、$N = 4$、$q = 0$、$r = 0.1$、$p = 0$ 和 $\\mathcal{U}_d = \\{-1, -0.5, 0, 0.5, 1\\}$。\n\n测试套件：\n- A用例（严格可行起始和强松弛惩罚的理想路径）：$x_{\\mathrm{init}} = 1.0$, $\\rho = 100.0$, $T = 8$。\n- B用例（违反边界的起始，但适度的松弛惩罚会促使修正）：$x_{\\mathrm{init}} = 2.5$, $\\rho = 10.0$, $T = 6$。\n- C用例（大违规，但极弱的松弛惩罚不鼓励执行器动作）：$x_{\\mathrm{init}} = 5.0$, $\\rho = 0.01$, $T = 6$。\n- D用例（恰好在边界上）：$x_{\\mathrm{init}} = 2.0$, $\\rho = 1.0$, $T = 5$。\n\n您的程序应生成单行输出，其中包含按 A、B、C、D 顺序排列的每个测试用例的三个布尔值结果，以逗号分隔列表形式呈现。每个三元组用方括号括起来，整个列表也用方括号括起来。例如，输出格式必须类似于 [[True,False,True],[...],...]。不得打印任何额外文本。不涉及物理单位，也未使用角度。", "solution": "所提出的问题是模型预测控制（MPC）中一个有效且适定的练习。它涉及一个离散时间线性时不变（LTI）系统（具体为一个离散积分器）的控制，该系统受状态和输入约束。该问题要求实现一个滚动时域控制器，该控制器通过松弛变量利用软约束，并通过对离散输入集进行穷举枚举来解决底层的有限时域最优控制问题。分析的重点是可行性和约束满足的性质。\n\n系统动力学由状态更新方程给出：\n$$\nx_{k+1} = a x_k + b u_k\n$$\n参数为 $a=1$ 和 $b=1$。状态 $x_k$ 必须满足硬约束 $|x_k| \\le x_{\\max}$，其中 $x_{\\max}=2$。控制输入 $u_k$ 被限制在一个有限的离散集合 $\\mathcal{U}_d = \\{-1, -0.5, 0, 0.5, 1\\}$ 中。\n\n在每个时间步 $k$，给定当前状态 $x_k$，我们在长度为 $N=4$ 的预测时域上求解一个开环最优控制问题。决策变量是输入序列 $u_{0:N-1} = (u_0, u_1, u_2, u_3)$（其中每个 $u_i \\in \\mathcal{U}_d$）和一个非负松弛变量序列 $s_{1:N} = (s_1, s_2, s_3, s_4)$。预测状态轨迹（表示为 $x_i^{pred}$）从初始条件 $x_0^{pred} = x_k$ 开始，根据 $x_{i+1}^{pred} = x_i^{pred} + u_i$ 演化。\n\n状态约束通过使用松弛变量进行软化：\n$$\n|x_i^{pred}| \\le x_{\\max} + s_i \\quad \\text{for } i \\in \\{1, \\dots, N\\}\n$$\n目标是最小化一个惩罚输入使用和约束违反的成本函数。给定参数 $q=0$、$p=0$ 和 $r=0.1$，成本函数为：\n$$\nJ = \\sum_{i=0}^{N-1} r u_i^2 + \\rho \\sum_{i=1}^{N} s_i\n$$\n其中 $\\rho$ 是松弛向量 $\\ell_1$ 范数的权重。对于任何给定的输入序列 $u_{0:N-1}$，通过选择满足软化约束的最小可能非负松弛变量来最小化成本。这会产生最优的松弛值：\n$$\ns_i^\\star = \\max\\{0, |x_i^{pred}| - x_{\\max}\\}\n$$\n将此代入成本函数，在每个时间步 $k$ 需要解决的优化问题就变成了仅对输入序列的最小化问题：\n$$\n\\min_{u_{0:N-1} \\in \\mathcal{U}_d^N} \\left( 0.1 \\sum_{i=0}^{3} u_i^2 + \\rho \\sum_{i=1}^{4} \\max\\{0, |x_i^{pred}| - 2\\} \\right)\n$$\n该问题通过对所有 $|\\mathcal{U}_d|^N = 5^4 = 625$ 个可能的输入序列进行穷举搜索来解决。如果多个序列产生相同的最小成本，则确定性的打破平局规则会选择总松弛最小的序列，即 $\\sum_{i=1}^N s_i^\\star$ 最小的序列。\n\nMPC 律以滚动时域方式实现：找到最优序列 $u^\\star = (u_0^\\star, \\dots, u_{N-1}^\\star)$ 后，仅将第一个控制动作 $u_0^\\star$ 应用于系统，$x_{k+1} = x_k + u_0^\\star$。然后，在下一个时间步 $k+1$ 从新状态 $x_{k+1}$ 重复此过程。此仿真总共运行 $T$ 个时间步。\n\n解决方案需要基于闭环仿真评估三个属性：\n1.  **`always_feasible`**：此布尔值表示在每个时间步 $k \\in \\{0, \\dots, T-1\\}$ 开环问题是否可行。由于使用了软约束（松弛变量），对于任何状态 $x_k$，总能找到一个具有有限成本的可行解，因为任何约束违反都可以通过足够大的松弛变量来容纳。因此，此属性根据构造是 `True`。\n\n2.  **`zero_slack_invariant`**：此属性评估一种递归可行性。如果在任何时间步 $k$，最优预测轨迹的松弛为零（即对所有 $i \\in \\{1, \\dots, N\\}$ 都有 $|x_i^{pred}| \\le x_{\\max}$），并且移位的候选控制序列 $(u_1^\\star, \\dots, u_{N-1}^\\star, 0)$ 从后继状态 $x_{k+1}$ 应用时也产生零松弛轨迹，则该值为 `True`。如系统动力学分析所示，新的预测状态序列是前一个序列的子序列，并附加其终端状态。具体来说，新的状态序列是 $(x_2^{pred}, \\dots, x_N^{pred}, x_N^{pred})$。由于假设原始预测轨迹的松弛为零，所有这些状态都满足约束。因此，只要实现正确，此属性也根据构造而成立。如果从未找到零松弛的最优计划，则此属性为空真（vacuously `True`）。\n\n3.  **`eventual_zero_slack`**：如果实现的（realized）状态轨迹 $x_k$ 最终进入并保持在硬约束集内，则此布尔值为 `True`。形式上，必须存在一个时间索引 $\\bar{k} \\in \\{0, \\dots, T\\}$，使得对于所有 $k \\in \\{\\bar{k}, \\dots, T\\}$，实现的松弛 $\\sigma_k = \\max\\{0, |x_k| - x_{\\max}\\}$ 均为零。这等效于实现的松弛序列的后缀全为零。其值取决于初始状态和惩罚权重 $\\rho$。\n\n该算法通过遍历测试用例，为每个用例运行滚动时域仿真，并评估这三个属性来实现。", "answer": "[[True,True,True],[True,True,True],[True,True,False],[True,True,True]]", "id": "2724817"}]}