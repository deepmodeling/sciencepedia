## 引言
[后退时域控制](@entry_id:270676)（Receding Horizon Control, RHC），更广为人知的名称是[模型预测控制](@entry_id:146965)（Model Predictive Control, MPC），是现代控制理论中最核心和应用最广泛的先进控制策略之一。其最显著的优势在于能够系统、明确地处理[多变量系统](@entry_id:169616)中的状态与输入约束，而这正是传统控制方法通常难以应对的挑战。本文旨在全面剖析RHC的理论精髓与实践应用，解决“控制器如何预见未来并遵守限制”这一核心问题。

为实现这一目标，本文将分为三个层次逐步深入。在“原理与机制”一章中，我们将奠定理论基石，深入探讨有限时域最优控制问题的数学构造、[后退时域](@entry_id:181425)的反馈机制，以及如何将控制问题转化为可计算的二次规划（QP）问题，并最终阐明保证稳定性和可行性的关键——[终端约束](@entry_id:176488)与终端代价。接下来的“应用与交叉学科联系”一章，我们将理论联系实际，展示RHC如何通过软约束、[鲁棒设计](@entry_id:269442)、[状态估计](@entry_id:169668)等技术应对现实世界的不确定性，并演化出[经济MPC](@entry_id:174671)、[分布](@entry_id:182848)式MPC等高级形式，同时探索其在过程工程、生物技术乃至[计算经济学](@entry_id:140923)等领域的跨学科应用。最后，在“动手实践”部分，读者将通过具体的编程练习，亲手实现关键算法，将抽象的理论转化为可执行的代码，从而巩固对核心概念的理解。

## 原理与机制

本章旨在深入剖析[后退时域控制](@entry_id:270676)（Receding Horizon Control, RHC）的核心原理与关键机制，特别是其如何系统地处理约束。我们将从定义其核心的[优化问题](@entry_id:266749)开始，逐步构建其作为反馈控制策略的理论框架，并最终阐明保证其稳定性和可行性的数学条件。

### 有限时域最优控制问题

[后退时域控制](@entry_id:270676)的每一次迭代都始于求解一个**有限时域最优控制问题 (Finite-Horizon Optimal Control Problem, FHOCP)**。理解此问题的精确数学表述是掌握 RHC 的第一步。

考虑一个离散时间[线性时不变 (LTI) 系统](@entry_id:178866)：
$$
x_{k+1} = A x_k + B u_k
$$
其中 $x_k \in \mathbb{R}^n$ 是系统在时刻 $k$ 的状态， $u_k \in \mathbb{R}^m$ 是控制输入。我们的目标是在满足一系列约束的条件下，最小化一个在有限**[预测时域](@entry_id:261473) (prediction horizon)** $N$ 内的性能指标。

在时刻 $k$，给定当前测量的状态 $x_k$，FHOCP 的形式如下 [@problem_id:2736369]：

**1. 决策变量 (Decision Variables):** 决策变量是未来 $N$ 步的控制输入序列，记为 $\mathbf{u}_k = \{ u_{0|k}, u_{1|k}, \dots, u_{N-1|k} \}$。其中，$u_{i|k}$ 表示在时刻 $k$ 规划的、将在未来时刻 $k+i$ 施加的控制输入。一旦控制序列确定，对应的状态序列 $\mathbf{x}_k = \{ x_{1|k}, \dots, x_{N|k} \}$ 也随之确定。

**2. 目标函数 (Objective Function):** 目标函数通常是一个二次代价函数，旨在惩罚状态偏差和控制能量消耗。它由两部分组成：**阶段代价 (stage cost)** 和 **终端代价 (terminal cost)**。
$$
J(\mathbf{x}_k, \mathbf{u}_k) = \sum_{i=0}^{N-1} (x_{i|k}^{\top} Q x_{i|k} + u_{i|k}^{\top} R u_{i|k}) + x_N^{\top} P x_N
$$
其中，$Q$ 和 $R$ 分别是半正定和正定的权重矩阵，用于权衡[状态和](@entry_id:193625)输入的相对重要性。$x_N^{\top} P x_N$ 是终端代价，矩阵 $P$ 通常为半正定，其作用是近似[预测时域](@entry_id:261473) $N$ 之外的未来代价，对保证[闭环稳定性](@entry_id:265949)至关重要。

**3. 约束 (Constraints):** 优化必须在满足以下硬约束的条件下进行：
- **[系统动力学](@entry_id:136288):** $x_{i+1|k} = A x_{i|k} + B u_{i|k}$，对于 $i=0, \dots, N-1$，且初始条件为 $x_{0|k} = x_k$。
- **状态与输入约束:** $x_{i|k} \in \mathcal{X}$ 和 $u_{i|k} \in \mathcal{U}$，对于所有相关的 $i$。这些约束通常由物理限制（如[执行器饱和](@entry_id:274581)、安全操作范围）决定，在数学上常表示为[凸多面体](@entry_id:170947)，例如 $\{z : Gz \le g\}$。
- **[终端约束](@entry_id:176488) (Terminal Constraint):** 为确保稳定性，通常要求预测的终端状态 $x_N$ 落入一个特定的**[终端集](@entry_id:163892) (terminal set)** $\mathcal{X}_f$ 内，即 $x_N \in \mathcal{X}_f$。

FHOCP 与经典的**无限时域[线性二次调节器 (LQR)](@entry_id:276639)** 有本质区别 [@problem_id:2736369]。LQR 旨在为无约束的 LTI 系统找到一个最优的**定常[状态反馈](@entry_id:151441)律** $u_k = K x_k$，以最小化一个无限时域的二次[代价函数](@entry_id:138681) $\sum_{k=0}^{\infty} (x_k^{\top} Q x_k + u_k^{\top} R u_k)$。LQR 的解是一个**[反馈增益](@entry_id:271155)矩阵** $K$，而 FHOCP 的解是一个**开环的控制序列**。此外，LQR 问题不直接处理[状态和](@entry_id:193625)输入约束，而这正是 RHC 的核心优势。在 LQR 理论中，与矩阵 $P$ 对应的角色是离散代数里卡提方程 (DARE) 的唯一稳定解 $P_\infty$，它代表了最优成本函数的值 ($J^* = x_0^\top P_\infty x_0$)，是一个计算结果而非像 RHC 中可供设计的设计参数。

### [后退时域控制](@entry_id:270676)机制

FHOCP 本身只提供了一个未来 $N$ 步的[开环控制](@entry_id:262977)计划。RHC 的精髓在于如何利用这个计划来构建一个闭环反馈策略。这个过程被称为**[后退时域](@entry_id:181425)机制 (receding horizon mechanism)**。

其工作流程如下 [@problem_id:2736404]：
1.  **测量 (Measure):** 在当前时刻 $k$，测量系统的实际状态 $x_k$。
2.  **优化 (Optimize):** 以 $x_k$ 作为初始状态，求解上述 FHOCP，得到[最优控制](@entry_id:138479)序列 $\{ u_{0|k}^*, u_{1|k}^*, \dots, u_{N-1|k}^* \}$。
3.  **执行 (Actuate):** **仅将序列中的第一个控制输入** $u_{0|k}^*$ 施加于系统。
4.  **演进 (Evolve):** 系统在控制输入 $u_k = u_{0|k}^*$ 和可能的扰动 $w_k$ 作用下，演进到下一个状态 $x_{k+1} = A_p x_k + B_p u_k + w_k$（其中 $A_p, B_p$ 是真实系统矩阵）。
5.  **重复 (Repeat):** 在下一个时刻 $k+1$，将时域向前"滚动"一步，以新的测量状态 $x_{k+1}$ 为起点，重复步骤 1-4。

通过这种“测量-优化-执行”的循环，RHC 巧妙地将一系列开环[优化问题](@entry_id:266749)转化为一个**隐式的[状态反馈控制器](@entry_id:203349)**。施加的控制 $u_k = u_{0|k}^*$ 是当前状态 $x_k$ 的函数，即 $u_k = \kappa_{MPC}(x_k)$。这个函数 $\kappa_{MPC}$ 通常是高度[非线性](@entry_id:637147)的，并且没有闭式解，它的值是通过求解一个[优化问题](@entry_id:266749)来获得的。

这种基于反馈的重规划机制是 RHC 鲁棒性的关键来源。考虑一个纯粹的**开环最优控制**策略：在 $k=0$ 时刻一次性计算出整个控制序列 $\{u_0^*, \dots, u_{N-1}^*\}$ 并依次执行，期间不再进行测量和重规划。在存在模型失配 ($A \ne A_p, B \ne B_p$) 或外部扰动 ($w_k \ne 0$) 的情况下，系统的实际状态轨迹将偏离名义上的预测轨迹。开环策略对此无能为力，可能导致性能下降甚至违反约束。相反，RHC 在每一步都根据最新的状态信息进行修正，不断地重新计算一个从当前“实际位置”出发的最优路径，从而有效对抗不确定性带来的偏差 [@problem_id:2736385]。

### 二次规划的数学表述

为了让计算机能够高效求解 FHOCP，我们需要将其转化为一个标准的[数学优化](@entry_id:165540)问题。对于 LTI 系统、二次代价函数和[多面体](@entry_id:637910)约束，FHOCP 可以被精确地表述为一个**二次规划 (Quadratic Program, QP)** 问题。QP 问题是指在仿射约束下最小化一个凸二次函数，存在高效的数值求解器。

转化的关键在于将[预测时域](@entry_id:261473)内的所有[状态和](@entry_id:193625)输入表示为初始状态 $x_k$ 和决策变量（整个控制序列 $U$）的[仿射函数](@entry_id:635019)。

**1. 状态预测模型:**
首先，我们通过递推展开[系统动力学](@entry_id:136288)方程，可以得到未来任意时刻 $i$ 的状态 $x_{i|k}$ 的表达式。
$$
\begin{align*}
x_{1|k} = A x_{k} + B u_{0|k} \\
x_{2|k} = A x_{1|k} + B u_{1|k} = A^2 x_{k} + AB u_{0|k} + B u_{1|k} \\
\vdots
\end{align*}
$$
将整个[预测时域](@entry_id:261473)内的状态序列 $X = [x_{1|k}^\top, \dots, x_{N|k}^\top]^\top$ 和控制序列 $U = [u_{0|k}^\top, \dots, u_{N-1|k}^\top]^\top$ 写成向量形式，我们可以得到一个紧凑的[线性预测](@entry_id:180569)模型 [@problem_id:2736414]：
$$
X = \Phi x_k + \Gamma U
$$
其中，预测矩阵 $\Phi$ 和 $\Gamma$ 具有如下的块结构：
$$
\Phi = \begin{bmatrix} A \\ A^2 \\ \vdots \\ A^N \end{bmatrix}, \quad
\Gamma = \begin{bmatrix}
B & 0 & \cdots & 0 \\
AB & B & \cdots & 0 \\
\vdots & \vdots & \ddots & \vdots \\
A^{N-1}B & A^{N-2}B & \cdots & B
\end{bmatrix}
$$
矩阵 $\Gamma$ 是一个块下三角[托普利茨矩阵](@entry_id:271334)，其结构反映了系统的因果性。

**2. QP 代价函数:**
接下来，我们将原始代价函数 $J$ 表示为决策变量 $U$ 的二次函数 [@problem_id:2736413]。原始代价为：
$$
J = x_k^\top Q x_k + \sum_{i=1}^{N-1} x_{i|k}^\top Q x_{i|k} + x_N^\top P x_N + \sum_{i=0}^{N-1} u_{i|k}^\top R u_{i|k}
$$
这可以写成更紧凑的矩阵形式：
$$
J = x_k^\top Q x_k + X^\top \bar{Q}_P X + U^\top \bar{R} U
$$
其中 $\bar{Q}_P = \mathrm{diag}(Q, \dots, Q, P)$ 和 $\bar{R} = \mathrm{diag}(R, \dots, R)$ 是块对角权重矩阵。将状态预测模型 $X = \Phi x_k + \Gamma U$ 代入上式并整理，可得：
$$
J = U^\top(\Gamma^\top \bar{Q}_P \Gamma + \bar{R})U + 2x_k^\top \Phi^\top \bar{Q}_P \Gamma U + x_k^\top(\Phi^\top \bar{Q}_P \Phi + Q)x_k
$$
这正是 QP [代价函数](@entry_id:138681)的[标准形式](@entry_id:153058) $J = \frac{1}{2}U^\top H U + f^\top U + \text{const}$，其中：
- **Hessian 矩阵:** $H = 2(\Gamma^\top \bar{Q}_P \Gamma + \bar{R})$
- **线性项:** $f = 2\Gamma^\top \bar{Q}_P \Phi x_k$
由于 $Q, P \succeq 0$ 且 $R \succ 0$，Hessian 矩阵 $H$ 是正定的，保证了代价函数的凸性，从而 QP 问题有唯一解。

**3. QP 约束:**
最后，所有线性约束也可以转化为关于 $U$ 的仿射不等式 [@problem_id:2736393]。例如，一组混合状态输入约束 $F x_{i|k} + G u_{i|k} \le f$ 和[终端约束](@entry_id:176488) $F_f x_N \le f_f$ 可以通过代入[状态表](@entry_id:178995)达式 $x_{i|k}$ 并堆叠起来，形成一个大的不等式：
$$
S_u U \le s - S_x x_k
$$
其中 $S_u$, $S_x$ 和 $s$ 是由 $A, B, F, G, f, F_f$ 决定的[块矩阵](@entry_id:148435)。

综上所述，原始的 FHOCP 问题被转化为了一个等价的、关于控制序列 $U$ 的标准 QP 问题：
$$
\begin{align*}
\min_{U} \quad & \frac{1}{2}U^\top H U + (2\Gamma^\top \bar{Q}_P \Phi x_k)^\top U \\
\text{s.t.} \quad & S_u U \le s - S_x x_k
\end{align*}
$$
这个问题可以在每个时间步 $k$ 高效地求解，以获得[最优控制](@entry_id:138479)输入 $u_k = u_{0|k}^*$。

### 稳定性与可行性的保证

一个设计良好的 RHC 控制器不仅要能处理约束，还必须保证闭环系统的**稳定性 (stability)** 和**[递归可行性](@entry_id:167169) (recursive feasibility)**。[递归可行性](@entry_id:167169)意味着如果[优化问题](@entry_id:266749)在时刻 $k$ 有解，那么在未来的所有时刻 $k' > k$ 也一定有解。若无此保证，控制器可能在某个时刻突然无法找到可行的控制动作，导致系统失控。

一个看似直观的想法是，只要[预测时域](@entry_id:261473) $N$ 足够长，控制器就能“看得足够远”从而做出明智决策。然而，对于不[稳定系统](@entry_id:180404)，仅有长时域是不够的。控制器可能会为了最小化短期成本而做出“短视”的决策，将系统引导至一个虽然当前状态尚可，但未来无论如何都无法避免违反约束的“死胡同” [@problem_id:2736362]。

考虑一个标量不[稳定系统](@entry_id:180404) $x_{k+1} = 1.5x_k + u_k$，约束为 $|x_k| \le 1, |u_k| \le 0.1$，时域 $N=2$。从 $x_0 = 0.44$ 出发，为了最小化控制能量，控制器会选择 $u_0=0$，系统状态变为 $x_1 = 1.5 \times 0.44 = 0.66$。在 $k=1$ 时，系统处于 $x_1=0.66$。此时控制器发现，即使在未来两步都施加最大的反向控制（$u_1=-0.1, u_2=-0.1$），预测的状态 $x_3$ 仍将超出范围 1，导致[优化问题](@entry_id:266749)无解。这就是[递归可行性](@entry_id:167169)的丧失。

解决这一根本问题的标准方法是引入**终端代价**和**[终端集](@entry_id:163892)**。

**1. [终端集](@entry_id:163892) $\mathcal{X}_f$:**
[终端集](@entry_id:163892) $\mathcal{X}_f$ 是[状态空间](@entry_id:177074)中的一个特定区域，我们强制要求预测轨迹的终点 $x_N$ 必须落入其中。一个有效的[终端集](@entry_id:163892)必须满足以下三个条件 [@problem_id:2736421]：
- **正不变性 (Positive Invariance):** $\mathcal{X}_f$ 对于某个辅助的局部[稳定控制器](@entry_id:168369) $u = Kx$ 是正不变的。这意味着，如果一个状态 $x$ 在 $\mathcal{X}_f$ 内，那么在局部控制器作用下的下一个状态 $x^+ = (A+BK)x$ 也必定在 $\mathcal{X}_f$ 内。
- **[约束满足](@entry_id:275212):** 在 $\mathcal{X}_f$ 内的任何状态 $x$，其自身和在局部控制器作用下的输入 $Kx$ 都必须满足原始的[状态和](@entry_id:193625)输入约束，即 $x \in \mathcal{X}$ 和 $Kx \in \mathcal{U}$。
- **包含原点:** 原点 $0 \in \mathcal{X}_f$。

这个[终端集](@entry_id:163892)本质上定义了一个“安全区域”。一旦系统的预测状态进入此区域，我们就可以切换到一个已知的、简单的、能保证稳定且满足约束的局部控制器 $u=Kx$，从而无限地维持系统的稳定运行。

**2. 终端代价 $V_f(x)$:**
终端代价 $V_f(x_N) = x_N^\top P x_N$ 不应是一个随意的惩罚项。它应该精确地代表当系统到达状态 $x_N$ 后，切换到局部控制器 $u=Kx$ 并运行至无穷远的**未来总成本**的估计 [@problem_id:2736392]。对于 LTI 系统和二次代价，这个未来总成本（或称 cost-to-go）正是 $x_N^\top P_\infty x_N$，其中 $P_\infty$ 是与系统 $(A,B)$ 和权重 $(Q,R)$ 对应的 LQR 问题所求解的 DARE 的解。因此，选择 $P = P_\infty$ 是理论上最合理的选择。

**3. 稳定性证明:**
当同时使用精心设计的[终端集](@entry_id:163892) $\mathcal{X}_f$ 和终端代价 $V_f(x)$ 时，我们可以证明 RHC 控制器是[渐近稳定](@entry_id:168077)的。证明的核心思想是表明 FHOCP 的最[优值函数](@entry_id:173036) $J_N^*(x)$ 是整个闭环系统的一个**[李雅普诺夫函数](@entry_id:273986) (Lyapunov function)** [@problem_id:2736353]。

证明思路如下：
- 首先，由于 $Q,R,P$ 均为正定（或半正定），$J_N^*(x)$ 显然是正定的。
- 其次，我们需要证明 $J_N^*(x)$ 沿闭环轨迹是递减的。在时刻 $k$，我们得到最优解 $J_N^*(x_k)$ 和控制 $u_k = u_{0|k}^*$。系统演进到 $x_{k+1}$。在时刻 $k+1$，我们可以构造一个可行的（但不一定最优的）候选解：即使用时刻 $k$ 计划的“尾巴” $\{u_{1|k}^*, \dots, u_{N-1|k}^*\}$，并在最后一步附加上局部控制器 $Kx_{N|k}^*$。
- 由于[终端集](@entry_id:163892) $\mathcal{X}_f$ 的不变性和[约束满足](@entry_id:275212)性，这个构造出的候选解一定是可行的。
- 时刻 $k+1$ 的真正最优值 $J_N^*(x_{k+1})$ 必然小于或等于这个候选解的成本。
- 通过代数推导，并利用终端代价 $P$ 满足的李雅普诺夫性质 ($V_f((A+BK)x) - V_f(x) \le -l(x,Kx)$)，可以最终证明：
$$
J_N^*(x_{k+1}) - J_N^*(x_k) \le -l(x_k, u_k) = -(x_k^\top Q x_k + u_k^\top R u_k)
$$
- 这个不等式表明，只要 $x_k \neq 0$，Lyapunov 函数 $J_N^*(x)$ 就会严格递减，从而保证了系统的[渐近稳定性](@entry_id:149743)。同时，这个推导过程也证明了[递归可行性](@entry_id:167169)，因为我们总能为下一步找到一个可行的解。

一个重要的结论是，只要使用了上述的终端成分，**闭环系统的稳定性对于任何[预测时域](@entry_id:261473) $N \ge 1$ 都得到保证** [@problem_id:2736377]。增加 $N$ 的主要作用是扩大**可行域 (region of attraction)**——即能够被成功镇定到原点的初始状态的集合——并可能改善系统的性能（即降低总成本），但对于稳定性的保证本身而言， $N=1$ 就已足够。这凸显了[终端约束](@entry_id:176488)和终端代价在现代 RHC 设计中的核心地位。