## 引言
在[数字逻辑设计](@entry_id:141122)的世界中，异步顺序电路因其在速度和[功耗](@entry_id:264815)上的潜在优势而备受关注，但同时也引入了独特的时序挑战。与[同步系统](@entry_id:172214)不同，[异步电路](@entry_id:169162)的状态转换不依赖全局时钟，而是由输入信号直接触发。这种特性使其对物理世界中无处不在的[信号传播延迟](@entry_id:271898)极为敏感，从而催生了一类被称为“竞争条件”的复杂问题。如果处理不当，竞争会导致电路行为不可预测，甚至引发灾难性系统故障。因此，深刻理解竞争的本质，并掌握其分析与解决方法，是每一位[数字系统设计](@entry_id:168162)师的必备技能。

本文旨在系统性地梳理关键竞争与非关键竞争的核心概念。我们将从竞争产生的根源——物理延迟出发，逐步深入探讨其对电路行为的影响。读者将通过本文学习到：

- 在第一章“原理与机制”中，我们将深入剖析竞争的定义，辨析关键竞争与非关键竞争的本质区别，并系统学习如何运用流程表和激励方程这两种核心工具来准确识别和分析竞争。
- 在第二章“应用与交叉学科联系”中，我们将视野从理论拓展到实践，探讨竞争现象在从基本锁存器到[跨时钟域](@entry_id:173614)通信、[硬件安全](@entry_id:169931)等多种实际应用和交叉学科领域中的具体表现和深远影响。
- 最后，在“动手实践”部分，读者将有机会通过解决一系列精心设计的问题，将理论知识付诸实践，巩固对竞争分析和规避方法的理解。

## 原理与机制

在异步顺序逻辑电路的设计中，时序是一个核心议题。与由全局[时钟信号](@entry_id:174447)精确协调所有状态变化的[同步电路](@entry_id:172403)不同，[异步电路](@entry_id:169162)的状态转换是由输入信号的变化直接触发的。这种架构虽然在速度和[功耗](@entry_id:264815)方面具有潜在优势，但也引入了一类独特的时序问题，统称为**竞争条件 (Race Conditions)**。本章将深入探讨竞争的根本原理、其不同类型的表现形式，以及分析和缓解这些问题的关键机制。

### 什么是竞争？[异步电路](@entry_id:169162)中的时间赛跑

在理想的[数字电路](@entry_id:268512)模型中，我们假设[逻辑门](@entry_id:142135)是瞬时响应的，信号在导线中的传播也无需时间。然而，在物理世界中，任何电子元件——无论是逻辑门还是连接导线——都存在固有的**传播延迟 (propagation delay)**。这意味着从输入变化到输出响应之间，总会有一段微小但不可忽略的时间延迟。更重要的是，一个电路中不同路径的延迟几乎不可能是完全相同的。

当一次输入变化要求两个或多个状态变量（例如 $y_1, y_2$）同时改变其值时，问题就出现了。由于电路中实现这些[状态变量](@entry_id:138790)的逻辑路径具有不同的传播延迟，这些变量几乎永远不会在同一时刻完成翻转。一个变量可能会比另一个“跑得快”，导致电路在到达其预期的最终状态之前，短暂地进入一个或多个非预期的**中间状态 (intermediate states)**。这种由于内部[信号延迟](@entry_id:261518)差异而引发的时序不确定性，就是**竞争 (race)**。

我们可以将此过程想象为一场赛跑。假设电路需要从状态 $(y_1, y_2) = (0, 1)$ 转换到 $(1, 0)$。这要求 $y_1$ 从 $0$ 变为 $1$，$y_2$ 从 $1$ 变为 $0$。这就像两位选手 $y_1$ 和 $y_2$ 在两条不同的跑道上同时出发，目标是同时到达终点线。但由于他们各自的速度（传播延迟）不同，总会有一位选手先到达。

*   如果 $y_1$ 先完成变化：电路状态将经历 $ (0, 1) \to (1, 1) \to (1, 0) $ 的路径。
*   如果 $y_2$ 先完成变化：电路状态将经历 $ (0, 1) \to (0, 0) \to (1, 0) $ 的路径。

这些中间状态 $(1, 1)$ 和 $(0, 0)$ 并非设计者所期望的稳定过渡点。它们是否会引发问题，取决于它们在当前输入下的行为。这引出了对竞争性质的进一步分类。一个非常实际的例子是使用标准二[进制](@entry_id:634389)编码的2位[异步计数器](@entry_id:175347) [@problem_id:1925434]。当计数器从状态 S1（编码为 $(0,1)$）转换到 S2（编码为 $(1,0)$）时，两个状态位都必须翻转，从而不可避免地产生竞争。同样，从 S3（编码为 $(1,1)$）转换到 S0（编码为 $(0,0)$）也存在同样的问题。

### 关键竞争与非关键竞争的甄别

竞争本身并不总是致命的缺陷。其后果的严重性决定了它是**非关键竞争 (non-critical race)** 还是**关键竞争 (critical race)**。这个甄别的核心标准是：电路的最终状态是否是确定的和正确的。

**非关键竞争**是指，尽管电路可能经历不同的中间状态路径，但所有这些路径最终都会汇合到同一个、正确的稳定状态。在这种情况下，电路的行为虽然在微观时间尺度上存在不确定性，但其宏观功能是可靠和可预测的。

例如，一个电路被要求从稳定状态 $(0,0)$ 转换到 $(1,1)$。竞争可能产生中间状态 $(0,1)$ 或 $(1,0)$。如果电路的设计保证了在当前输入下，无论电路进入 $(0,1)$ 还是 $(1,0)$，它的下一个状态都被定义为 $(1,1)$，那么无论哪个状态变量先变化，电路最终都会安然抵达目标。这种情况便构成非关键竞争 [@problem_id:1925435]。

相比之下，**关键竞争**是[异步电路设计](@entry_id:172174)中的一个严重缺陷。当至少有一条可能的中间路径导致电路稳定在一个非预期的、错误的状态时，该竞争就是关键的。电路的最终状态变得依赖于物理元件不可预测的微小延迟差异，这使得电路的行为变得不可靠。

让我们考虑一个从状态 $(1,0)$ 到 $(0,1)$ 的转换。这同样需要两个变量 $y_1$ 和 $y_2$ 同时改变。假设竞争产生了两个可能的中间状态 $(0,0)$ 和 $(1,1)$。如果电路的设计使得从中间状态 $(0,0)$ 出发可以正确地到达目标状态 $(0,1)$，但中间状态 $(1,1)$ 本身在当前输入下就是一个稳定状态，那么问题就出现了。如果 $y_2$ 的变化比 $y_1$ 快，电路会进入 $(1,1)$ 并“卡”在那里，永远无法到达预期的 $(0,1)$ 状态。由于结果取决于无法控制的延迟，这便是一个典型的关键竞争 [@problem_id:1925435] [@problem_id:1925449]。

### 竞争的分析方法

要设计可靠的[异步电路](@entry_id:169162)，首先必须能够准确地识别和分析潜在的竞争。分析通常基于电路的两种标准描述方式：流程表和激励方程。

#### 使用流程表进行分析

**流程表 (Flow Table)** 是描述[异步电路](@entry_id:169162)行为的核心工具。它以表格形式展示了在不同输入条件下，每个“现态” (present state) 对应的“次态” (next state) 和输出。次态与现态相同的条目被称为**稳定状态 (stable state)**。

使用流程表分析竞争的步骤如下：
1.  定位初始稳定状态。
2.  模拟输入变化，保持现态不变，在流程表的新输入列中查找对应的次态。
3.  如果次态与现态之间需要改变多个[状态变量](@entry_id:138790)（即它们的[汉明距离](@entry_id:157657)大于1），则存在竞争。
4.  识别所有可能的中间状态。这些中间状态是现态和次态之间汉明距离为1的状态。
5.  在**新输入**所对应的列中，查找每个中间状态的次态。
6.  如果某个中间状态本身就是稳定状态，那么它就是一个可能的最终结果。如果它是[不稳定状态](@entry_id:197287)，则继续追踪其后续状态，直至到达一个稳定状态。
7.  比较所有可能路径最终到达的稳定状态。如果它们不完全相同，则该竞争是关键竞争。

让我们通过一个具体的例子来说明。考虑一个电路，其初始稳定状态为 D (10)，输入为 `00`。当输入突然变为 `11` 时，流程表指示次态应为 `01` [@problem_id:1925404]。这个转换 $10 \to 01$ 需要两个变量同时改变，因此存在竞争。
*   **路径1**：如果 $y_2$ 先变，$10 \to 00$。我们查找现态为 A (00) 且输入为 `11` 的条目，发现它是一个稳定状态。因此，电路可能停在状态 A (00)。
*   **路径2**：如果 $y_1$ 先变，$10 \to 11$。我们查找现态为 C (11) 且输入为 `11` 的条目，发现它也是一个稳定状态。因此，电路也可能停在状态 C (11)。

由于最终可能停在 A 或 C 这两个不同的稳定状态，这场竞争是关键的。另一个例子展示了从状态 `01` 在输入 `x=0` 时转换到 `10` 的过程 [@problem_id:1925423]。如果 $y_1$ 先变，状态变为 `11`，而 `11` 在输入 `x=0` 时是稳定的。如果 $y_2$ 先变，状态变为 `00`，而 `00` 在输入 `x=0` 时也是稳定的。不同的路径导致了不同的最终状态 `11` 和 `00`，因此这也是一个关键竞争。

#### 使用激励方程进行分析

除了流程表，我们还可以直接使用[状态变量](@entry_id:138790)的**激励方程 (Excitation Equations)** 来分析竞争。激励方程定义了每个次态变量 $(Y_1, Y_2, \dots)$ 如何由输入 $(x_1, x_2, \dots)$ 和现态变量 $(y_1, y_2, \dots)$ 计算得出。一个状态是稳定的，当且仅当对于给定的输入，所有 $Y_i = y_i$。

分析过程与使用流程表类似，但计算是在代数层面进行的。以一个由以下激励方程定义的电路为例 [@problem_id:1925412]：
$Y_1 = x y_1 + x y_1' y_2'$
$Y_2 = x y_2 + x y_1' y_2'$

电路初始稳定在 $(y_1, y_2)=(0,0)$，输入 $x=0$。当输入 $x$ 切换到 $1$ 时，我们代入 $(y_1, y_2)=(0,0)$ 和 $x=1$ 到方程中：
$Y_1 = 1 \cdot 0 + 1 \cdot 1 \cdot 1 = 1$
$Y_2 = 1 \cdot 0 + 1 \cdot 1 \cdot 1 = 1$
目标状态是 $(1,1)$，需要两个变量同时改变，存在竞争。
*   **路径1**：如果 $y_1$ 先变为 $1$，电路进入中间状态 $(1,0)$。我们用这个新状态重新计算次态（$x$ 仍为 $1$）：
    $Y_1 = 1 \cdot 1 + 1 \cdot 0 \cdot 1 = 1$
    $Y_2 = 1 \cdot 0 + 1 \cdot 0 \cdot 1 = 0$
    次态是 $(1,0)$，与当前状态相同，因此 $(1,0)$ 是一个稳定状态。电路将停在这里。
*   **路径2**：如果 $y_2$ 先变为 $1$，电路进入中间状态 $(0,1)$。我们用这个状态再次计算次态：
    $Y_1 = 1 \cdot 0 + 1 \cdot 1 \cdot 0 = 0$
    $Y_2 = 1 \cdot 1 + 1 \cdot 1 \cdot 0 = 1$
    次态是 $(0,1)$，与当前状态相同，因此 $(0,1)$ 也是一个稳定状态。电路也可能停在这里。

在这个例子中，根据延迟的细微差别，电路最终可能稳定在 $(1,0)$ 或 $(0,1)$，甚至在延迟恰好的情况下稳定在预期的 $(1,1)$。由于结果不唯一，这是一个关键竞争。

#### 多变量竞争的复杂性

当需要同时改变的变量超过两个时，竞争的分析会变得更加复杂。例如，一个从 $(0,0,0)$ 到 $(1,1,1)$ 的转换涉及三个变量，这意味着电路可能经过[汉明距离](@entry_id:157657)为1的中间状态（如 $(1,0,0)$, $(0,1,0)$, $(0,0,1)$）或[汉明距离](@entry_id:157657)为2的中间状态（如 $(1,1,0)$, $(1,0,1)$, $(0,1,1)$）。

在一个具有三个[状态变量](@entry_id:138790)的电路实例中，当输入变化触发从 $(0,0,0)$ 到 $(1,1,1)$ 的转换时，详细的分析表明，不同的中间路径可能导致电路稳定在四个不同的状态之一：预期的 $(1,1,1)$，以及三个非预期的稳定状态 $(0,1,0)$、$(1,0,0)$ 和 $(1,0,1)$ [@problem_id:1925471]。这凸显了随着[状态变量](@entry_id:138790)的增加，彻底分析和避免关键竞争的挑战性也随之剧增。

### 输出竞争：一种更隐蔽的风险

到目前为止，我们讨论的“关键性”都与最终的稳定**状态**有关。然而，在某些情况下，即使竞争是非关键的（即最终状态总是正确的），它仍然可能以另一种方式构成严重问题，即产生错误的瞬态**输出**。这种现象被称为**输出竞争 (output race)**。

输出竞争在**米利型 (Mealy) 异步机**中尤其值得关注，因为其输出不仅依赖于当前状态，还直接依赖于输入。在状态转换期间，电路经过的短暂中间状态可能会导致输出信号上出现一个非预期的脉冲或**毛刺 (glitch)**。

考虑一个米利型电路，其初始状态为 $(y_1,y_2)=(0,0)$，输入 $x=0$，输出 $z=0$。当输入 $x$ 变为 $1$ 时，电路的目标状态是 $(1,1)$，在该状态下输出 $z$ 仍然为 $0$。理论上，输出应该保持为 $0$。然而，这是一个双变量转换，存在竞争 [@problem_id:1925454]。
*   **路径1**：如果 $y_1$ 先变，电路经过中间状态 $(1,0)$。在此状态下，输出 $z$ 的计算结果仍为 $0$。电路最终到达 $(1,1)$，输出始终为 $0$。这条路径是安全的。
*   **路径2**：如果 $y_2$ 先变，电路经过中间状态 $(0,1)$。根据输出方程 $z = x y_1' y_2$，在 $x=1$ 和状态 $(0,1)$ 下，输出 $z$ 会短暂地变为 $1$！当电路随后从 $(0,1)$ 转换到最终的 $(1,1)$ 状态时，输出 $z$ 才重新变回 $0$。

这个 $0 \to 1 \to 0$ 的输出序列形成了一个瞬态脉冲。虽然这个脉冲很短暂，但如果下游的[数字逻辑](@entry_id:178743)系统足够快，它可能会被错误地捕捉为一个有效的信号，从而引发系统级的故障。因此，即使状态转换最终是正确的，这种输出竞争在功能上也是“关键的”。

### 竞争的避免：[状态分配](@entry_id:172668)策略

分析竞争的最终目的是为了在设计阶段就将其消除。避免关键竞争最有效的方法之一是进行合理的**[状态分配](@entry_id:172668) (state assignment)**。其核心思想是，确保在电路的所有预期工作序列中，任意两个连续的状态在编码上都是**相邻的 (adjacent)**，即它们的二[进制](@entry_id:634389)表示之间只有一个位的差异（汉明距离为1）。

如果每次状态转换都只涉及一个[状态变量](@entry_id:138790)的变化，那么根据定义，竞争就不会发生。让我们回到之前提到的2位[二进制计数器](@entry_id:175104) [@problem_id:1925434]。其问题根源在于从 $(0,1)$ 到 $(1,0)$ 和从 $(1,1)$ 到 $(0,0)$ 的转换，这两步的汉明距离都是2。

为了解决这个问题，我们可以不使用标准的二[进制](@entry_id:634389)编码，而是采用**格雷码 (Gray code)** 进行[状态分配](@entry_id:172668)。格雷码的一个关键特性是，任何两个连续的码字之间都只相差一位。例如，一个2位的[格雷码](@entry_id:166435)序列可以是：
*   S0: $(0,0)$
*   S1: $(0,1)$
*   S2: $(1,1)$
*   S3: $(1,0)$

现在我们来检查计数器的转换序列 $S0 \to S1 \to S2 \to S3 \to S0$：
*   $S0(0,0) \to S1(0,1)$: 改变1位。无竞争。
*   $S1(0,1) \to S2(1,1)$: 改变1位。无竞争。
*   $S2(1,1) \to S3(1,0)$: 改变1位。无竞争。
*   $S3(1,0) \to S0(0,0)$: 改变1位。无竞争。

通过采用[格雷码](@entry_id:166435)进行[状态分配](@entry_id:172668)，我们成功地为计数器的正常工作流程消除了所有竞争。对于更复杂的、非顺序的状态转换，可能需要引入额外的中间状态来将一个多比特的转换分解为一系列单比特的转换，从而确保电路的可靠性。

综上所述，竞争是[异步电路](@entry_id:169162)中源于物理延迟的固有现象。理解关键竞争与非关键竞争的本质区别，熟练运用流程表和激励方程等工具进行分析，并采取如合理[状态分配](@entry_id:172668)等设计策略，是构建稳健、可预测的异步系统的基础。