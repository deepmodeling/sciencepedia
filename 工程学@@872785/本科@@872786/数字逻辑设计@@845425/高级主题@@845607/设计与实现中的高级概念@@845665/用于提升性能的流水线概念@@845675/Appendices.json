{"hands_on_practices": [{"introduction": "在深入研究流水线可能遇到的问题之前，我们必须首先掌握其理想工作状态下的基本原理。这个练习旨在帮助你通过追踪单个时钟周期，直观地理解指令如何在不同流水线阶段中移动[@problem_id:1952279]。这是理解所有流水线现象的基石，也是分析更复杂场景的起点。", "problem": "某个处理器为提升性能实现了一个四级指令流水线。这些阶段按顺序为：1. 指令提取 (IF)，2. 指令译码 (ID)，3. 执行 (EX)，以及 4. 写回 (WB)。每个阶段完成其操作需要恰好一个时钟周期。一个由 7 条指令（索引为 I1, I2, I3, I4, I5, I6, I7）组成的程序将在此处理器上运行。流水线初始为空，每个时钟周期开始时都有一条新指令进入流水线。假设不存在任何流水线停顿、刷新或数据冒险，请确定在第 5 个时钟周期时，处于执行 (EX) 阶段的指令 `In` 的索引 `n` 是多少。", "solution": "一个包含 IF、ID、EX、WB 四个阶段的流水线，在理想条件下，每个阶段耗时一个时钟周期，每条指令每个周期前进一个阶段。如果流水线初始为空，且指令 $I_{1}$ 在时钟周期 $t=1$ 开始时进入，那么指令 $I_{n}$ 将在：\n- 时钟周期 $t = n$ 时处于 IF 阶段，\n- 时钟周期 $t = n + 1$ 时处于 ID 阶段，\n- 时钟周期 $t = n + 2$ 时处于 EX 阶段，\n- 时钟周期 $t = n + 3$ 时处于 WB 阶段。\n\n因此，在时钟周期 $t$ 处于 EX 阶段的指令满足：\n$$\nt = n + 2 \\quad \\Rightarrow \\quad n = t - 2.\n$$\n对于第 $5$ 个时钟周期，令 $t=5$ 可得：\n$$\nn = 5 - 2 = 3.\n$$\n因此，在第 $5$ 个时钟周期时，$I_{3}$ 处于 EX 阶段。", "answer": "$$\\boxed{3}$$", "id": "1952279"}, {"introduction": "现实世界中的流水线并非总能理想地运行，它们会遇到导致流水线停顿的“冒险”（hazards）。这个练习将带领我们从直观的理解转向定量分析，展示如何计算有效的每指令周期数（$CPI$），从而衡量数据冒险对处理器真实性能造成的损失[@problem_id:1952280]。通过这个计算，你将能更深刻地理解流水线效率。", "problem": "一个名为“Comet-1”的假设简单处理器，具有一个4级指令流水线（取指、译码、执行、写回），并以 1.0 GHz 的时钟频率运行。\n\n在理想条件下，即流水线总是满载且没有冒险（hazard）时，该处理器可以在每个时钟周期完成一条指令。\n\n在执行一个特定的基准测试程序期间，观察到数据相关性导致频繁的流水线停顿。详细分析表明，每当一组四条指令进入流水线时，就会稳定地发生一次数据冒险，迫使流水线停顿整整一个时钟周期。\n\n假设这种停顿模式在整个基准测试执行过程中是均匀的，请计算 Comet-1 处理器新的有效每指令周期数 (CPI)。将您的答案表示为一个保留三位有效数字的实数。", "solution": "在没有冒险的情况下，一个全流水线的4级处理器的理想稳态吞吐率是每个时钟周期一条指令，所以理想的每指令周期数是\n$$\\text{CPI}_{\\text{ideal}} = 1.$$\n根据观察到的模式，每四条指令就会发生一次一个时钟周期的流水线停顿。因此，在任何一个包含四条指令的块中，总周期数为\n$$N_{\\text{cycles}} = 4 + 1 = 5.$$\n根据定义，\n$$\\text{CPI} = \\frac{N_{\\text{cycles}}}{N_{\\text{instructions}}}.$$\n将此公式应用于这个4指令块，\n$$\\text{CPI}_{\\text{effective}} = \\frac{5}{4} = 1 + \\frac{1}{4} = 1.25.$$\n计算 CPI 不需要时钟频率。保留三位有效数字，有效 CPI 是 $1.25$。", "answer": "$$\\boxed{1.25}$$", "id": "1952280"}, {"introduction": "处理器设计本质上是一门权衡的艺术。这个最终练习将探讨一个常见的设计抉择：增加流水线深度可以提高时钟频率，但同时也会加重由分支预测错误等冒险带来的性能惩罚[@problem_id:1952292]。通过分析这个场景，你将学会如何基于对总执行时间的影响来评估不同的设计方案，从而培养一种系统级的性能优化思维。", "problem": "一个CPU设计团队正在为一款新的嵌入式处理器评估两种不同的流水线架构。目标是确定哪种设计能为特定的目标工作负载提供更好的性能。\n\n第一个选项是Architecture-5 (A5)，一个经典的5级流水线。第二个选项是Architecture-6 (A6)，一个更深的6级流水线设计。A6中增加的流水线级数使得每个阶段的逻辑设计更简单，从而可以实现更高的时钟频率。具体来说，A6架构的时钟周期比A5架构短10.0%。\n\n更深流水线的性能代价是控制冒险的惩罚增加。在A5设计中，分支预测错误被检测和处理，会产生2个暂停周期的惩罚。在A6设计中，由于增加了流水线阶段，同样的分支预测错误会产生3个暂停周期的惩罚。\n\n对一个代表性基准程序的分析显示，执行的指令中有20.0%是分支指令。两种架构中使用的动态分支预测器对于此基准程序的平均预测错误率为15.0%。假设分支预测错误造成的暂停是唯一的性能损失来源，并且理想流水线的吞吐量为每个周期一条指令。\n\n计算运行此基准程序时，6级流水线（A6）的总执行时间与5级流水线（A5）的总执行时间的比率。请以四舍五入到三位有效数字的数值形式提供你的答案。", "solution": "设动态指令的数量为 $N$。理想的基本CPI为 $1$（每个周期一条指令）。分支预测错误是唯一的暂停来源。\n\n设 $f_{b}$ 为分支指令的比例，$p_{m}$ 为预测错误率。那么，被错误预测的分支指令占总指令的比例是 $f_{b}p_{m}$。每次预测错误会增加 $P$ 个暂停周期的惩罚，因此CPI变为\n$$\n\\text{CPI} = 1 + f_{b}p_{m}P.\n$$\n对于A5，$P_{5}=2$；对于A6，$P_{6}=3$。给定 $f_{b}=0.2$ 和 $p_{m}=0.15$，我们得到 $f_{b}p_{m}=0.03$。因此，\n$$\n\\text{CPI}_{5}=1+0.03\\cdot 2=1.06,\\qquad \\text{CPI}_{6}=1+0.03\\cdot 3=1.09.\n$$\n设A5的时钟周期为 $T_{5}$。A6的时钟周期为 $T_{6}=0.9\\,T_{5}$。总执行时间为 $T = N \\cdot \\text{CPI} \\cdot T_{\\text{clk}}$，所以执行时间的比率为\n$$\nR=\\frac{T_{6}}{T_{5}}=\\frac{N\\cdot \\text{CPI}_{6}\\cdot T_{6}}{N\\cdot \\text{CPI}_{5}\\cdot T_{5}}=0.9\\cdot \\frac{1.09}{1.06}=\\frac{9}{10}\\cdot \\frac{109}{106}=\\frac{981}{1060}\\approx 0.925471698.\n$$\n四舍五入到三位有效数字，比率为 $0.925$。", "answer": "$$\\boxed{0.925}$$", "id": "1952292"}]}