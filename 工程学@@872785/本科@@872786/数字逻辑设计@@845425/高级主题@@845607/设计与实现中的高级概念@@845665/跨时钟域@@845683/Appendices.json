{"hands_on_practices": [{"introduction": "在设计多时钟域系统时，首先要考虑的挑战之一是数据速率的差异。本练习探讨了用较慢时钟对快速数据源进行采样所带来的基本后果。通过计算最小数据丢失量，你将对为何简单采样通常不足以实现跨时钟域的可靠数据传输有一个具体的理解。[@problem_id:1920375]", "problem": "在数字系统中，为工作在不同时钟信号下的组件进行接口设计需要仔细分析，这个问题被称为时钟域交叉（Clock Domain Crossing, CDC）。\n\n考虑一个场景，其中一个高速数字传感器连接到一个较慢的微控制器（MCU）。该传感器在其时钟 `clk_sensor` 的每个上升沿都会产生一个新的、唯一的数据值。MCU 则在其自身时钟 `clk_mcu` 的每个上升沿对该数据进行采样。\n\n`clk_sensor` 的频率恰好是 `clk_mcu` 频率的三倍。`clk_sensor` 和 `clk_mcu` 之间的相位关系是任意的，并且可能不是恒定的。假设采样过程是理想且瞬时的，精确地发生在时钟沿。如果一个数据值由传感器产生，但从未在 `clk_mcu` 的上升沿被捕获，则该数据值被定义为“丢失”。\n\n请确定在 MCU 的任意两次连续采样事件之间，丢失的数据值的最小数量。", "solution": "设 MCU 的时钟周期为 $T_{\\text{m}}$，传感器的时钟周期为 $T_{\\text{s}}$。已知 $f_{\\text{sensor}}=3 f_{\\text{mcu}}$，我们有\n$$T_{\\text{m}}=3T_{\\text{s}}.$$\n考虑 MCU 在 $t=0$ 和 $t=T_{\\text{m}}$ 的两个连续采样时刻。设传感器的上升沿（数据更新）发生在以下时间点\n$$t=t_{0}+kT_{\\text{s}}, \\quad k \\in \\mathbb{Z},$$\n其中存在某个相位偏移 $t_{0} \\in [0, T_{\\text{s}})$。\n\n计算在开区间 $(0, T_{\\text{m}})$ 内传感器更新的次数：\n- 如果 $t_{0}=0$（传感器和 MCU 的时钟沿在 $t=0$ 时重合），那么在 $[0, T_{\\text{m}}]$ 内的传感器时钟沿位于 $0, T_{\\text{s}}, 2T_{\\text{s}}, 3T_{\\text{s}}$，因此开区间 $(0, T_{\\text{m}})$ 内恰好包含 $2$ 次更新（分别在 $T_{\\text{s}}$ 和 $2T_{\\text{s}}$）。\n- 如果 $t_{0} \\in (0, T_{\\text{s}})$（在端点处不重合），那么在 $(0, T_{\\text{m}})$ 内的更新发生在 $t_{0}, t_{0}+T_{\\text{s}}, t_{0}+2T_{\\text{s}}$，因此恰好有 $3$ 次更新。\n\n在 $t=T_{\\text{m}}$ 时，MCU 捕获该时刻存在的传感器值，这个值是在以下时间点生成的\n$$t^{\\ast}=\\max\\{t \\leq T_{\\text{m}}: t=t_{0}+kT_{\\text{s}}\\}.$$\n- 如果在 $t=T_{\\text{m}}$ 时没有传感器时钟沿（不重合），那么 $t^{\\ast} \\in (0, T_{\\text{m}})$，因此区间内部的更新中只有一个被捕获，其余的内部更新都丢失了。由于有 $3$ 次内部更新，丢失的数量是 $3-1=2$。\n- 如果在 $t=T_{\\text{m}}$ 时有传感器时钟沿（重合），那么 $t^{\\ast}=T_{\\text{m}}$，这个时间点不在 $(0, T_{\\text{m}})$ 内。因此，区间内部的更新都没有被捕获；由于有 $2$ 次内部更新，丢失的数量是 $2$。\n\n因此，在任意两个连续的 MCU 采样事件之间，丢失的传感器数据值的数量总是 $2$，所以最小值是 $2$。", "answer": "$$\\boxed{2}$$", "id": "1920375"}, {"introduction": "要安全地跨时钟域传输信号，要求该信号是稳定的。本实践问题揭示了一个常见且危险的设计缺陷：将组合逻辑的输出直接送入同步器。你将分析看似简单的逻辑电路中，传播延迟如何产生瞬态“毛刺”，并可能被目标时钟域错误地捕获。[@problem_id:1920408]", "problem": "在一个数字系统中，一个由`CLK_A`驱动的时钟域中的组件与另一个由`CLK_B`驱动的异步时钟域中的组件进行通信。一个单比特信号`S`，它是受`CLK_A`驱动的寄存器的输出，被用来生成一个控制信号`Y`。这个信号`Y`接着被传递到`CLK_B`域，作为同步D型触发器（DFF）的输入。\n\n从`S`生成`Y`的组合逻辑由布尔表达式`Y = S AND (NOT S)`定义。在物理上，这是通过一个标准的非门和一个标准的双输入与门实现的。非门的传播延迟为`t_NOT = 2.0 ns`，与门的传播延迟为`t_AND = 3.5 ns`。在本次分析中，假设连线延迟和DFF的时钟到Q端的延迟可以忽略不计。\n\n最初，信号`S`稳定在逻辑`0`。在时间`t = 0`时，`CLK_A`的一个上升沿导致信号`S`从`0`变为`1`。`Y`的逻辑预期稳态值始终为`0`。然而，物理门电路中不同的传播延迟会产生瞬态行为。\n\n在这种情况下，将组合逻辑输出`Y`跨时钟域边界馈送的这种设计选择，其主要和最直接的风险是什么？\n\nA. 电路将消耗过多的静态功耗，因为输出`Y`将锁定在逻辑`1`状态。\nB. `Y`上的一个短暂毛刺脉冲可能会被`CLK_B`域的同步器采样，导致捕获一个错误的值。\nC. 逻辑`S AND (NOT S)`是逻辑冗余的，综合工具会将其优化为常数`0`，从而阻止电路被物理实现。\nD. 在`S`转变后，输出`Y`将在`0`和`1`之间持续振荡，使得同步无法实现。\nE. 信号`S`的转变将在与门内部造成暂时的电气短路，可能损坏器件。", "solution": "定义组合函数为 $Y=S \\land \\neg S$。在布尔代数中，对于所有稳定的`S`，这可以简化为 $Y \\equiv 0$。\n\n然而，对于具有不相等传播延迟的物理门电路，必须检查其时域行为。设反相器的传播延迟为 $t_{\\text{NOT}}$，与门的传播延迟为 $t_{\\text{AND}}$。假设连线延迟和时钟到Q端的延迟可以忽略不计，且`S`在 $t=0$ 时从`0`变为`1`。\n\n1) 对于 $t0$，$S=0$ 且 $\\neg S=1$。与门的输入为 $(0,1)$，因此（在任何延迟稳定后）$Y=0$。\n\n2) 在 $t=0^{+}$ 时，与门的一个输入`S`立即变为`1`，而反相器的输出在 $t=t_{\\text{NOT}}$ 之前保持为`1`。因此，在时间间隔 $0 \\le t  t_{\\text{NOT}}$ 内，与门的输入为 $(1,1)$。\n\n3) 考虑到与门的传播延迟 $t_{\\text{AND}}$，与门的输出将在一个延迟后反映出 $(1,1)$ 的输入组合。因此，在传输延迟模型下，`Y`上的一个潜在高电平脉冲将从 $t=t_{\\text{AND}}$ (上升) 持续到 $t=t_{\\text{NOT}}+t_{\\text{AND}}$ (下降)，产生一个宽度为 $t_{\\text{NOT}}$ 的脉冲：\n$$\n\\Delta t_{\\text{glitch}} = t_{\\text{NOT}}.\n$$\n在惯性延迟模型下，比 $t_{\\text{AND}}$ 窄的脉冲可能会被滤除，但在实践中，工艺-电压-温度（PVT）变化和不同的路径仍然可能在`Y`上产生一个非零脉冲。因此，`Y`上的一个短暂毛刺是一个现实存在的风险。\n\n4) 因为`Y`被传输到由 $\\mathrm{CLK}_{B}$ 驱动的异步时钟域，并进入一个同步DFF，任何这样的短毛刺都可能与 $\\mathrm{CLK}_{B}$ 的采样边沿重合，导致同步器捕获一个错误的逻辑`1`（尽管其预期的稳态是 $Y \\equiv 0$）。这是将组合逻辑跨时钟域边界传输的主要和最直接的风险。\n\n因此，正确的选项是`Y`上的一个短暂毛刺可能会被`CLK_B`域的同步器采样，导致捕获一个错误的值。", "answer": "$$\\boxed{B}$$", "id": "1920408"}, {"introduction": "尽管同步器对于异步时钟边界至关重要，但将它们与同步多速率系统区分开来也同样关键。本练习挑战了“不同时钟频率总是意味着异步跨越”这一假设。通过分析一个时钟相位和频率都相关的场景，你将学会应用标准的同步时序分析来判断一个更简单的直接连接是否安全。[@problem_id:1920380]", "problem": "在一个数字系统中，一个 `Producer` 模块在一个由 `clk_A` 控制的时钟域中运行，其频率为 10 MHz。一个 `Consumer` 模块在一个由 `clk_B` 控制的时钟域中运行，其频率为 20 MHz。时钟生成电路确保 `clk_B` 相对于 `clk_A` 是完美相位对齐和频率加倍的，因此 `clk_A` 的每个上升沿都与 `clk_B` 的一个上升沿完全重合。\n\n`Producer` 模块生成一个单比特信号 `data_out`，它是由 `clk_A` 驱动的 D 型触发器（DFF）的输出。`Consumer` 模块尝试使用一个由 `clk_B` 驱动的单个 DFF 来捕获这个 `data_out` 信号。假设生产者的触发器的时钟到 Q 端的延迟以及消费者的触发器的建立和保持时间都是非零的，但足够小，以至于它们的总和小于 50 ns。\n\n这种单 DFF 方法是否是一种将 `data_out` 信号从 `clk_A` 域传输到 `clk_B` 域的“安全”方法，即它能正确捕获数据值而不会引入亚稳态？\n\n从以下选项中选择最佳解释。\n\nA. 不，因为任何时候数据在不同时钟频率的域之间交叉时，都需要一个双触发器同步器来防止亚稳态。\nB. 是的，因为时钟是同步的。来自 10 MHz 域的数据在 `clk_A` 的上升沿后不久发生变化，并且在 20 MHz 时钟的下一个上升沿（发生在 50 ns 后）之前很久就会变得稳定，从而满足建立和保持时间要求。\nC. 不，因为 20 MHz 时钟太快，不可避免地会在 `data_out` 信号转换时进行采样，从而导致亚稳态。\nD. 是的，因为 10 MHz 的 `data_out` 信号会保持恒定整整 100 ns，这比 `clk_B` 的 50 ns 周期长，保证了安全捕获。", "solution": "设生产者时钟为 $f_{A}=10\\,\\text{MHz}$，周期为 $T_{A}=1/f_{A}=100\\,\\text{ns}$；消费者时钟为 $f_{B}=20\\,\\text{MHz}$，周期为 $T_{B}=1/f_{B}=50\\,\\text{ns}$。根据设计，时钟是同步且完全相位对齐的，因此 `clk_A` 在 $t=nT_{A}$ 的每个上升沿都与 `clk_B` 在 $t=mT_{B}$（其中 $m=2n$）的上升沿重合，并且在连续的 `clk_A` 边沿之间，还有一个额外的 `clk_B` 上升沿出现在 $t=nT_{A}+T_{B}$。\n\n生产者的 DFF 在 `clk_A` 的上升沿发出一个新值。将生产者的时钟到 Q 端延迟表示为 $t\\_{cq,A}0$。那么输出 $data\\_out$ 在 $t=nT_{A}+t\\_{cq,A}$ 时刻发生转换，在其他时间保持不变。\n\n消费者的 DFF 在 `clk_B` 的上升沿采样 $data\\_out$，采样时刻为 $t=mT_{B}$。考虑在 $t=nT_{A}$ 发出数据前后的两个连续相关采样时刻：\n1.  在重合边沿 $t=nT_{A}$ 采样：在这个时刻，`data_out` 尚未改变，因为变化发生在 $t=nT_{A}+t\\_{cq,A}$。为了使这次采样安全且不产生亚稳态，必须满足消费者的保持时间约束：\n    $$\n    t\\_{cq,A} \\ge t\\_{hold,B}.\n    $$\n    因为变化严格发生在采样边沿之后 $t\\_{cq,A}0$ 的时间点，并且实际的 $t\\_{hold,B}$ 很小，所以在典型的同步设计中，这个条件很自然地得到满足；在 $t=nT_{A}$ 附近消费者的采样窗口内没有数据转换，所以消费者安全地捕获了旧值。\n\n2.  在下一个 `clk_B` 边沿 $t=nT_{A}+T_{B}$ 采样：为了让消费者安全地（不产生亚稳态地）捕获新发出的值，必须满足建立时间约束：\n    $$\n    t\\_{cq,A} + t\\_{path} + t\\_{setup,B} \\le T_{B}.\n    $$\n    这里，$t\\_{path}$ 是从生产者的 Q 端到消费者的 D 端的传播延迟，由于 `data_out` 直接来自 DFF，这个延迟是最小的。题目指出，生产者的时钟到 Q 端延迟以及消费者的建立和保持时间都是非零但足够小，以至于它们的和小于 $50\\,\\text{ns}=T_{B}$。因此\n    $$\n    t\\_{cq,A} + t\\_{setup,B}  T_{B}\n    $$\n    成立，确保了新值在 $t=nT_{A}+T_{B}$ 之前很久就已稳定，因此满足了建立时间要求，并且在该边沿不会引发亚稳态。\n\n因为时钟是同步的且具有固定的相位对齐关系，并且根据给定的假设（特别是 $t\\_{cq,A}+t\\_{setup,B}  T_B$），可以安全地进行这种传输。", "answer": "$$\\boxed{B}$$", "id": "1920380"}]}