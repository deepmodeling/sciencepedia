{"hands_on_practices": [{"introduction": "在数字设计中，将理论电路图正确地转化为硬件描述语言 (HDL) 是一项基本技能。这个练习将挑战你从几个Verilog代码片段中识别出正确的双触发器同步器，从而加强你对电路结构及其实际编码实现的理解。通过这个练习[@problem_id:1974107]，你将学会如何在代码层面辨识和构建这个关键的跨时钟域电路。", "problem": "在一个复杂的片上系统（SoC）设计中，一个运行在高频时钟 `clk_fast` 上的中央处理器（CPU）需要向一个工作在独立的较慢时钟 `clk_slow` 上的外设控制器发送一个单位比特的“事务完成”信号。\n\n由于这两个时钟域是异步的，简单地将信号线连接在它们之间可能会导致一种称为亚稳态的危险情况，即接收域中的触发器会进入一个不稳定的中间状态，并持续一段不可预测的时间。\n\n为了降低这种风险，需要一个同步器电路。对于单位比特信号，一种常用且稳健的技术是两级触发器同步器。其目的是对异步输入进行采样，并允许一个完整的时钟周期让任何潜在的亚稳态得以解决，然后才将信号传递到目标时钟域的其余逻辑部分。\n\n考虑以下四个 Verilog 模块定义，它们旨在使用目标时钟 `dest_clk` 将一个信号 `sig_in`（来自源时钟域）传输到 `sig_out`（供目标时钟域使用）。哪个模块正确地实现了一个标准的两级触发器同步器？\n\n**A.**\n```verilog\nmodule synchronizer_A (\n  input  sig_in,\n  input  dest_clk,\n  output reg sig_out\n);\n  reg sig_meta_stage;\n\n  always @(posedge dest_clk) begin\n    sig_meta_stage = sig_in;\n    sig_out = sig_meta_stage;\n  end\nendmodule\n```\n\n**B.**\n```verilog\nmodule synchronizer_B (\n  input  sig_in,\n  input  dest_clk,\n  output reg sig_out\n);\n  always @(posedge dest_clk) begin\n    sig_out = sig_in;\n  end\nendmodule\n```\n\n**C.**\n```verilog\nmodule synchronizer_C (\n  input  sig_in,\n  input  dest_clk,\n  output sig_out\n);\n  assign sig_out = sig_in;\nendmodule\n```\n\n**D.**\n```verilog\nmodule synchronizer_D (\n  input  sig_in,\n  input  dest_clk,\n  output reg sig_out\n);\n  always @(dest_clk or sig_in) begin\n    if (dest_clk) begin\n      sig_out = sig_in;\n    end\n  end\nendmodule\n```", "solution": "我们需要一个标准的两级触发器同步器，它由两个由目标时钟驱动的级联边沿触发触发器组成。第一级对异步输入进行采样，可能会进入亚稳态；第二级在一个完整的目的时钟周期后对第一级进行采样，提供一个约等于目的时钟周期的解析时间。平均无故障时间（MTBF）大致按以下公式改善：\n$$\n\\text{MTBF} = \\frac{1}{f_{\\text{clk}} f_{\\text{data}}} \\exp\\!\\left(\\frac{T_{\\text{res}} - t_{0}}{\\tau}\\right),\n$$\n其中 $f_{\\text{clk}}$ 是目标时钟频率，$f_{\\text{data}}$ 是异步输入的翻转率，$\\tau$ 是触发器的亚稳态时间常数，$t_{0}$ 是一个与器件相关的常数，$T_{\\text{res}}$ 是可用的解析时间。与单级相比，使用两级可以将 $T_{\\text{res}}$ 增加大约一个时钟周期，从而指数级地降低了故障率。\n\n为保证正确性，Verilog 代码必须：\n- 实例化两个串联的寄存器（触发器）。\n- 在目标时钟的上升沿对两个寄存器进行时钟驱动。\n- 使用非阻塞赋值，以便第二级采样第一级的前一个值，从而确保一个完整时钟周期的解析时间。\n\n评估各个选项：\n\nA. 该代码声明了一个中间寄存器 $sig\\_meta\\_stage$，并使用非阻塞赋值在 $posedge\\ dest\\_clk$ 时更新它和 $sig\\_out$：\n$$\n\\begin{aligned}\nsig\\_meta\\_stage \\leftarrow sig\\_in \\quad \\text{on } posedge(dest\\_clk),\\\\\nsig\\_out \\leftarrow sig\\_meta\\_stage \\quad \\text{on } posedge(dest\\_clk).\n\\end{aligned}\n$$\n由于非阻塞赋值的语义，$sig\\_out$ 会捕获 $sig\\_meta\\_stage$ 的前一个值，从而形成两个由 $dest\\_clk$ 驱动的级联触发器。这是一个正确的两级触发器同步器。\n\nB. 只使用了一个触发器：\n$$\nsig\\_out \\leftarrow sig\\_in \\quad \\text{on } posedge(dest\\_clk),\n$$\n这没有提供额外的解析周期，因此不是一个两级触发器同步器。\n\nC. 连续赋值\n$$\nsig\\_out = sig\\_in\n$$\n完全没有提供同步功能，而是直接转发异步信号，这是不安全的。\n\nD. 敏感列表是电平敏感的，其主体使用了\n$$\n\\text{if }(dest\\_clk)\\ \\ sig\\_out \\leftarrow sig\\_in,\n$$\n这不是一个边沿触发的触发器，可能会推断出锁存器或门控行为，违反了同步设计实践。它不是一个两级触发器同步器。\n\n因此，只有模块 A 正确地实现了一个标准的两级触发器同步器。", "answer": "$$\\boxed{A}$$", "id": "1974107"}, {"introduction": "了解了同步器的结构之后，我们来深入探究其工作原理。本练习模拟了一个最坏情况：第一个触发器因时序违规而进入亚稳态。通过精确地追踪信号时序[@problem_id:1974076]，你将亲眼见证第二个触发器如何利用其提供的一个时钟周期的“恢复时间”，最终输出一个干净、稳定的信号，从而理解同步器设计的核心思想。", "problem": "一个数字系统使用一个两级同步器，将异步信号 `D_in` 安全地引入一个同步域。该同步域由一个时钟 `CLK` 控制。该同步器由两个串联的上升沿触发的D型触发器 (DFF) 组成，分别命名为 `DFF1` 和 `DFF2`。`DFF1` 的输出 `Q1` 连接到 `DFF2` 的输入 `D2`，异步信号 `D_in` 连接到 `DFF1` 的输入 `D1`。电路最终的同步输出是 `Q2`。\n\n该系统具有以下时序特性：\n- 时钟 `CLK` 的周期为 `T_clk = 12.0` ns。时钟信号初始为低电平，其第一个上升沿出现在 `t = 0` ns。\n- 对于两个相同的 DFF，建立时间 `t_su = 1.0` ns，保持时间 `t_h = 0.5` ns，时钟到Q端的传播延迟 `t_cq = 0.7` ns。\n\n初始时，在 `t   0` 时，信号 `D_in`、`Q1` 和 `Q2` 都稳定在逻辑低电平 (0)。异步信号 `D_in` 在 `t = 23.6` ns 时发生一次从低到高的跃变。\n\n这个输入跃变导致了时序违例，结果第一个触发器的输出 `Q1` 进入亚稳态。对于这一特定事件，实验观察到亚稳态的输出 `Q1` 最终在 `t = 31.5` ns 时稳定在逻辑高电平 (1)。\n\n根据对该事件的完整描述，下列哪个陈述正确地描述了最终输出信号 `Q2` 的行为？\n\nA. `Q2` 永久保持低电平。\nB. `Q2` 在 `t = 24.7` ns 时跃变为高电平。\nC. `Q2` 在 `t = 36.7` ns 时跃变为高电平。\nD. 输出 `Q2` 在 `t = 36` ns 的时钟沿之后也进入亚稳态。\nE. `Q2` 在 `t = 31.5` ns 时跃变为高电平。", "solution": "时钟的上升沿出现在由 $t_{k} = k T_{\\mathrm{clk}}$ 给出的时间点，其中 $T_{\\mathrm{clk}}=12.0\\,\\text{ns}$，因此相关的时钟沿在 $t_{2}=24\\,\\text{ns}$ 和 $t_{3}=36\\,\\text{ns}$。每个 DFF 要求其输入在采样窗口\n$$\n[t_{k}-t_{su},\\; t_{k}+t_{h}]\n$$\n内保持稳定，其中 $t_{su}=1.0\\,\\text{ns}$ 且 $t_{h}=0.5\\,\\text{ns}$。\n\n对于 $DFF1$，在 $t_{2}=24\\,\\text{ns}$ 时，异步输入 $D_{\\mathrm{in}}$ 在 $t=23.6\\,\\text{ns}$ 时发生跃变，这个时间点落在建立时间窗口 $[23.0\\,\\text{ns},\\,24.0\\,\\text{ns}]$ 内，导致了建立时间违例，并使 $Q_{1}$ 进入亚稳态。题目给出，这个亚稳态的 $Q_{1}$ 最终在 $t=31.5\\,\\text{ns}$ 时稳定为高电平。\n\n考虑 $DFF2$。它的输入是 $D_{2}=Q_{1}$，其采样时钟沿与 $DFF1$ 相同，即 $t_{2}=24\\,\\text{ns}$ 和 $t_{3}=36\\,\\text{ns}$。对于 $t_{2}=24\\,\\text{ns}$ 的时钟沿，要求的稳定窗口是\n$$\n[24\\,\\text{ns}-1.0\\,\\text{ns},\\;24\\,\\text{ns}+0.5\\,\\text{ns}] = [23.0\\,\\text{ns},\\,24.5\\,\\text{ns}].\n$$\n在该时钟沿之前，$Q_{1}$ 是低电平；在该时钟沿之后，$Q_{1}$ 可能发生变化的最早时间受限于 $DFF1$ 的时钟到Q端延迟，因此一个非亚稳态的跃变不会在 $t=24\\,\\text{ns}+t_{cq}=24.7\\,\\text{ns}$ 之前出现。在此事件中，$Q_{1}$ 处于亚稳态，直到 $t=31.5\\,\\text{ns}$ 才稳定为高电平，这也晚于 $24.5\\,\\text{ns}$。因此，在 $[23.0\\,\\text{ns},\\,24.5\\,\\text{ns}]$ 期间，就采样而言，$D_{2}$ 实际上是稳定的低电平，所以 $DFF2$ 在 $t=24\\,\\text{ns}$ 时无误地捕获一个低电平，且 $Q_{2}$ 在该时钟沿后保持低电平。\n\n对于下一个在 $t_{3}=36\\,\\text{ns}$ 的时钟沿，建立/保持窗口是\n$$\n[36\\,\\text{ns}-1.0\\,\\text{ns},\\;36\\,\\text{ns}+0.5\\,\\text{ns}] = [35.0\\,\\text{ns},\\,36.5\\,\\text{ns}].\n$$\n由于 $Q_{1}$ 自 $t=31.5\\,\\text{ns}$ 起就稳定为高电平，因此在 $t=36\\,\\text{ns}$ 附近，$D_{2}$ 同时满足建立时间和保持时间的要求。因此 $DFF2$ 在 $t=36\\,\\text{ns}$ 的时钟沿捕获一个高电平，其输出 $Q_{2}$ 在经过其自身的时钟到Q端延迟后跃变为高电平：\n$$\nt_{Q_{2}\\uparrow} = 36\\,\\text{ns} + t_{cq} = 36.7\\,\\text{ns}.\n$$\n因此，正确的描述是 $Q_{2}$ 在 $t=36.7\\,\\text{ns}$ 时跃变为高电平，这对应于选项 C。选项 A、B、D 和 E 都不一致：A 是错误的，因为高电平在下一个时钟周期被捕获；B 要求 $DFF2$ 在 $t=24\\,\\text{ns}$ 时捕获高电平，但实际上没有；D 是错误的，因为 $Q_{1}$ 在 $t=36\\,\\text{ns}$ 之前早已稳定，所以 $DFF2$ 不会进入亚稳态；E 是错误的，因为 $DFF2$ 是边沿触发的，不能在 $t=31.5\\,\\text{ns}$ 更新。", "answer": "$$\\boxed{C}$$", "id": "1974076"}, {"introduction": "虽然双触发器同步器能显著降低同步失败的概率，但它并不能完全消除风险。这个练习引入了平均无故障时间 (MTBF) 的概念，这是衡量系统可靠性的一个关键指标。你将通过计算[@problem_id:1974062]来确定需要多少级同步器才能达到严格的可靠性目标，这个过程将向你展示增加同步器级数所带来的指数级可靠性提升。", "problem": "在现代系统级芯片（SoC）设计中，确保异步时钟域之间的可靠数据传输是一项关键任务。一种缓解亚稳态问题的常用方法是使用由多个触发器组成的同步器链。\n\n考虑一个SoC，其中一个外围传感器模块向中央处理核心发送一个单比特 `data_valid` 信号。该核心在一个频率为 $f_{\\text{clk}} = 500 \\text{ MHz}$ 的系统时钟下运行。`data_valid` 信号源于传感器的时钟域，与核心的时钟异步，其平均翻转率为 $f_{\\text{data}} = 10 \\text{ kHz}$。\n\n用于在核心时钟域中构建同步器链的触发器具有以下特性：亚稳态解析时间常数 $\\tau = 150 \\text{ ps}$，以及一个输入翻转可能导致亚稳态事件的时间窗口 $T_W = 20 \\text{ ps}$。一个N级触发器同步器的平均无故障时间（MTBF）由以下公式给出：\n$$\n\\text{MTBF} = \\frac{\\exp\\left(\\frac{(N-1) T_{\\text{clk}}}{\\tau}\\right)}{f_{\\text{clk}} f_{\\text{data}} T_W}\n$$\n其中 $T_{\\text{clk}}$ 是同步时钟的周期。\n\n为确保系统的长期可靠性，设计规范要求同步器的MTBF至少为100年。为便于计算，假设一年恰好有365.25天。\n\n确定同步器链中所需的最小整数触发器数量 $N$，以达到或超过此可靠性目标。", "solution": "问题要求计算在一个同步器链中，为达到目标平均无故障时间（MTBF），所需的最小整数触发器数量 $N$。\n\nN级同步器的MTBF的控制方程如下所示：\n$$\n\\text{MTBF} = \\frac{\\exp\\left(\\frac{(N-1) T_{\\text{clk}}}{\\tau}\\right)}{f_{\\text{clk}} f_{\\text{data}} T_W}\n$$\n\n给定以下参数：\n- 目标MTBF, $\\text{MTBF}_{\\text{target}} = 100 \\text{ 年}$\n- 系统时钟频率, $f_{\\text{clk}} = 500 \\text{ MHz} = 500 \\times 10^6 \\text{ Hz}$\n- 异步数据翻转率, $f_{\\text{data}} = 10 \\text{ kHz} = 10 \\times 10^3 \\text{ Hz}$\n- 亚稳态解析时间常数, $\\tau = 150 \\text{ ps} = 150 \\times 10^{-12} \\text{ s}$\n- 亚稳态时间窗口, $T_W = 20 \\text{ ps} = 20 \\times 10^{-12} \\text{ s}$\n\n首先，我们必须将所有参数转换为一组一致的单位（国际单位制单位）。\n系统时钟周期 $T_{\\text{clk}}$ 是时钟频率的倒数：\n$$\nT_{\\text{clk}} = \\frac{1}{f_{\\text{clk}}} = \\frac{1}{500 \\times 10^6 \\text{ Hz}} = 2 \\times 10^{-9} \\text{ s}\n$$\n\n目标MTBF需要从年转换为秒：\n$$\n\\text{MTBF}_{\\text{target}} = 100 \\text{ 年} \\times 365.25 \\frac{\\text{天}}{\\text{年}} \\times 24 \\frac{\\text{小时}}{\\text{天}} \\times 3600 \\frac{\\text{秒}}{\\text{小时}}\n$$\n$$\n\\text{MTBF}_{\\text{target}} = 3,155,760,000 \\text{ s} = 3.15576 \\times 10^9 \\text{ s}\n$$\n\n我们需要找到最小整数 $N$ 使得 $\\text{MTBF} \\geq \\text{MTBF}_{\\text{target}}$。我们建立不等式：\n$$\n\\frac{\\exp\\left(\\frac{(N-1) T_{\\text{clk}}}{\\tau}\\right)}{f_{\\text{clk}} f_{\\text{data}} T_W} \\geq \\text{MTBF}_{\\text{target}}\n$$\n\n现在，我们求解 $N$。首先，分离指数项：\n$$\n\\exp\\left(\\frac{(N-1) T_{\\text{clk}}}{\\tau}\\right) \\geq \\text{MTBF}_{\\text{target}} \\cdot f_{\\text{clk}} \\cdot f_{\\text{data}} \\cdot T_W\n$$\n\n对两边取自然对数（$\\ln$）：\n$$\n\\frac{(N-1) T_{\\text{clk}}}{\\tau} \\geq \\ln(\\text{MTBF}_{\\text{target}} \\cdot f_{\\text{clk}} \\cdot f_{\\text{data}} \\cdot T_W)\n$$\n\n重新整理以求解 $N$：\n$$\nN-1 \\geq \\frac{\\tau}{T_{\\text{clk}}} \\ln(\\text{MTBF}_{\\text{target}} \\cdot f_{\\text{clk}} \\cdot f_{\\text{data}} \\cdot T_W)\n$$\n$$\nN \\geq 1 + \\frac{\\tau}{T_{\\text{clk}}} \\ln(\\text{MTBF}_{\\text{target}} \\cdot f_{\\text{clk}} \\cdot f_{\\text{data}} \\cdot T_W)\n$$\n\n现在，我们代入数值。让我们先计算对数内的项：\n$$\n\\text{Term} = \\text{MTBF}_{\\text{target}} \\cdot f_{\\text{clk}} \\cdot f_{\\text{data}} \\cdot T_W\n$$\n$$\n\\text{Term} = (3.15576 \\times 10^9 \\text{ s}) \\cdot (500 \\times 10^6 \\text{ s}^{-1}) \\cdot (10 \\times 10^3 \\text{ s}^{-1}) \\cdot (20 \\times 10^{-12} \\text{ s})\n$$\n$$\n\\text{Term} = (3.15576 \\times 10^9) \\cdot (5 \\times 10^8) \\cdot (1 \\times 10^4) \\cdot (2 \\times 10^{-11})\n$$\n$$\n\\text{Term} = (3.15576 \\cdot 5 \\cdot 1 \\cdot 2) \\times 10^{(9+8+4-11)} = 31.5576 \\times 10^{10} = 3.15576 \\times 10^{11}\n$$\n\n现在，我们可以将此结果代回关于 $N$ 的不等式中：\n$$\nN \\geq 1 + \\left(\\frac{150 \\times 10^{-12} \\text{ s}}{2 \\times 10^{-9} \\text{ s}}\\right) \\ln(3.15576 \\times 10^{11})\n$$\n\n计算前置因子和对数：\n$$\n\\frac{\\tau}{T_{\\text{clk}}} = \\frac{150 \\times 10^{-12}}{2000 \\times 10^{-12}} = \\frac{150}{2000} = \\frac{3}{40} = 0.075\n$$\n$$\n\\ln(3.15576 \\times 10^{11}) \\approx 26.4776\n$$\n\n将这些值代回关于 $N$ 的不等式中：\n$$\nN \\geq 1 + 0.075 \\times 26.4776\n$$\n$$\nN \\geq 1 + 1.98582\n$$\n$$\nN \\geq 2.98582\n$$\n\n由于触发器的数量 $N$ 必须是整数，我们需要找到大于或等于2.98582的最小整数。这个值是3。\n\n因此，所需的最小触发器数量为3。", "answer": "$$\\boxed{3}$$", "id": "1974062"}]}