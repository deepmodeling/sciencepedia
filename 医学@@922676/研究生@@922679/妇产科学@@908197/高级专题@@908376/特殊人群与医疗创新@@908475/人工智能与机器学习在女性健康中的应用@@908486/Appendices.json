{"hands_on_practices": [{"introduction": "现实世界中的临床数据，尤其是来自电子健康记录的数据，常常是不完整的。这项练习 [@problem_id:4404536] 直面一个关键挑战：“非随机缺失”（MNAR）数据，即缺失本身就包含了信息。你将推导这种缺失如何对风险模型的性能产生偏倚，并学习应用逆概率加权（IPW）这一强大的统计技术来校正这种偏倚，从而恢复对人群风险的准确估计。", "problem": "一家学术医疗中心正在构建一个用于子痫前期的人工智能（AI）风险分层工具，该工具使用胎龄作为关键预测指标。设 $S$ 表示模型预测的个体风险（一个概率），$G$ 表示入院时的胎龄类别，$G \\in \\{g_{E}, g_{L}\\}$，其中 $g_{E}$ 代表早期入院（约孕早期），$g_{L}$ 代表晚期入院（约孕中期）。由于产前护理较晚，胎龄 $G$ 在电子健康记录中经常未被记录。设 $R$ 为 $G$ 的缺失指示符，如果 $G$ 被记录，则 $R=1$，否则 $R=0$。晚期产前护理指示符 $L \\in \\{0,1\\}$ 对所有患者都是完全观测的，其中 $L=1$ 表示产前护理较晚。\n\n假设以下科学上真实的数据生成结构，它反映了一种常见情况，即缺失性依赖于未观测到的 $G$（因此在不以 $G$ 为条件的数据集中是“非随机缺失”（MNAR）），但在以 $L$ 为条件后变为“随机缺失”（MAR），因为在这个理想化的设定中 $L$ 完全决定了 $G$：\n\n1. 晚期产前护理的普遍率：$\\mathbb{P}(L=1)=0.35$ 且 $\\mathbb{P}(L=0)=0.65$。\n2. $L$ 与胎龄类别之间的确定性联系：如果 $L=0$，则 $G=g_{E}$；如果 $L=1$，则 $G=g_{L}$。\n3. $G$ 的缺失性依赖于 $G$（因此在没有 $L$ 的情况下是 MNAR）：$\\mathbb{P}(R=1 \\mid G=g_{E})=0.95$ 且 $\\mathbb{P}(R=1 \\mid G=g_{L})=0.40$。\n4. AI 模型的预测风险仅依赖于 $G$（在本练习中，其他协变量已被积分掉）：如果 $G=g_{E}$，则 $S=s_{E}$；如果 $G=g_{L}$，则 $S=s_{L}$，其中 $s_{E}=0.06$ 且 $s_{L}=0.12$。\n\n在大样本（总体）极限下进行计算，因此样本均值收敛于期望值。仅使用缺失数据文献中的核心定义（例如，非随机缺失（MNAR），随机缺失（MAR））、全概率定律和重期望定律。\n\n任务：\n1. 从第一性原理出发，推导完整病例（即 $R=1$）平均风险估计量相对于真实平均风险的偏差的解析表达式，然后在指定结构下计算其精确数值。\n2. 从第一性原理出发，推导一个基于权重 $\\pi(L)=\\mathbb{P}(R=1 \\mid L)$ 的边际平均风险的逆概率加权（IPW）估计量，并解析地证明，在给定结构下，IPW 估计量能够恢复总体中的真实平均风险。\n3. 计算经 IPW 校正的平均风险的数值。\n\n将最终答案表示为完整病例平均风险估计量的偏差（任务1），以小数形式表示并四舍五入到四位有效数字。不需要单位。不要报告百分号；任何比例都以纯小数表示。", "solution": "我们使用以下符号来形式化问题。设 $S$ 为预测风险，$G \\in \\{g_{E}, g_{L}\\}$ 为胎龄类别，$L \\in \\{0,1\\}$ 为晚期护理指示符，其中 $\\mathbb{P}(L=1)=0.35$ 且 $\\mathbb{P}(L=0)=0.65$，$R \\in \\{0,1\\}$ 为 $G$ 被记录的指示符。该结构规定如果 $L=0$ 则 $G=g_{E}$，如果 $L=1$ 则 $G=g_{L}$。缺失性依赖于 $G$：$\\mathbb{P}(R=1 \\mid G=g_{E})=0.95$ 且 $\\mathbb{P}(R=1 \\mid G=g_{L})=0.40$。当 $G=g_{E}$ 时，预测风险为 $S=s_{E}$，当 $G=g_{L}$ 时，预测风险为 $S=s_{L}$，其中 $s_{E}=0.06$ 且 $s_{L}=0.12$。\n\n我们首先确定真实的边际平均风险和朴素的完整病例平均值，然后计算偏差，最后推导逆概率加权（IPW）并证明它能校正平均值。\n\n步骤 1：真实边际平均风险。根据应用于 $L$ 的全概率定律以及 $L$ 和 $G$ 之间的确定性关系，真实平均值为\n$$\n\\mathbb{E}[S]\n= \\mathbb{P}(L=0)\\, s_{E} + \\mathbb{P}(L=1)\\, s_{L}\n= 0.65 \\times 0.06 + 0.35 \\times 0.12.\n$$\n计算：\n$$\n0.65 \\times 0.06 = 0.039,\\quad 0.35 \\times 0.12 = 0.042,\\quad \\Rightarrow \\mathbb{E}[S] = 0.081.\n$$\n以精确分数形式表示，$\\mathbb{E}[S] = \\frac{81}{1000}$。\n\n步骤 2：朴素的完整病例平均风险及其偏差。完整病例平均值仅使用 $R=1$ 的情况，并估计 $\\mathbb{E}[S \\mid R=1]$。根据定义，\n$$\n\\mathbb{E}[S \\mid R=1]\n= \\sum_{g \\in \\{g_{E}, g_{L}\\}} \\mathbb{P}(G=g \\mid R=1)\\, s(g).\n$$\n通过贝叶斯法则和全概率定律计算 $\\mathbb{P}(G=g \\mid R=1)$。因为 $G=g_{E}$ 当且仅当 $L=0$ 且 $G=g_{L}$ 当且仅当 $L=1$，\n$$\n\\mathbb{P}(R=1) = \\mathbb{P}(R=1 \\mid G=g_{E})\\mathbb{P}(G=g_{E}) + \\mathbb{P}(R=1 \\mid G=g_{L})\\mathbb{P}(G=g_{L})\n= 0.95 \\times 0.65 + 0.40 \\times 0.35 = 0.6175 + 0.14 = 0.7575.\n$$\n那么\n$$\n\\mathbb{P}(G=g_{E} \\mid R=1) = \\frac{0.95 \\times 0.65}{0.7575} = \\frac{0.6175}{0.7575} = \\frac{247}{303},\n$$\n$$\n\\mathbb{P}(G=g_{L} \\mid R=1) = \\frac{0.40 \\times 0.35}{0.7575} = \\frac{0.14}{0.7575} = \\frac{56}{303}.\n$$\n因此，\n$$\n\\mathbb{E}[S \\mid R=1] = \\frac{247}{303}\\times 0.06 + \\frac{56}{303}\\times 0.12.\n$$\n使用精确分数 $0.06=\\frac{3}{50}$ 和 $0.12=\\frac{3}{25}$：\n$$\n\\mathbb{E}[S \\mid R=1] = \\frac{247}{303}\\cdot \\frac{3}{50} + \\frac{56}{303}\\cdot \\frac{3}{25}\n= \\frac{3}{303}\\left(\\frac{247}{50} + \\frac{56}{25}\\right)\n= \\frac{3}{303}\\left(\\frac{247}{50} + \\frac{112}{50}\\right)\n= \\frac{3}{303}\\cdot \\frac{359}{50}\n= \\frac{1077}{15150} = \\frac{359}{5050}.\n$$\n以小数表示，$\\mathbb{E}[S \\mid R=1] \\approx 0.0710891089$。\n\n根据定义，完整病例估计量相对于真实平均值的偏差为\n$$\n\\text{Bias} = \\mathbb{E}[S \\mid R=1] - \\mathbb{E}[S].\n$$\n使用精确形式，\n$$\n\\text{Bias} = \\frac{359}{5050} - \\frac{81}{1000}.\n$$\n通分为公分母 $101000$：\n$$\n\\frac{359}{5050} = \\frac{7180}{101000},\\quad \\frac{81}{1000} = \\frac{8181}{101000},\n$$\n因此\n$$\n\\text{Bias} = \\frac{7180 - 8181}{101000} = -\\frac{1001}{101000} \\approx -0.0099108911.\n$$\n负号表明存在向下偏差：具有较高 $s_{L}$ 的晚期入院孕妇在 $R=1$ 的病例中代表性不足。\n\n缺失数据机制的解释。因为 $R$ 直接依赖于 $G$，而当 $R=0$ 时 $G$ 是未观测到的，所以在不以充分集为条件时，缺失是“非随机缺失”（MNAR）。然而，在这个理想化的结构中，$L$ 完全决定了 $G$，并且 $L$ 是完全观测的，所以该机制在以 $L$ 为条件下是“随机缺失”（MAR）；即 $\\mathbb{P}(R=1 \\mid S,G,L)=\\mathbb{P}(R=1 \\mid L)$。\n\n步骤 3：逆概率加权（IPW）校正。定义选择概率 $\\pi(L)=\\mathbb{P}(R=1 \\mid L)$。给定从 $L$ 到 $G$ 的确定性映射，\n$$\n\\pi(0) = \\mathbb{P}(R=1 \\mid L=0) = \\mathbb{P}(R=1 \\mid G=g_{E}) = 0.95,\\quad\n\\pi(1) = \\mathbb{P}(R=1 \\mid L=1) = \\mathbb{P}(R=1 \\mid G=g_{L}) = 0.40.\n$$\n（归一化的）边际平均值的 IPW 估计量使用权重 $w(L)=1/\\pi(L)$：\n$$\n\\hat{\\mu}_{\\text{IPW}} = \\frac{\\mathbb{E}\\!\\left[ \\frac{R}{\\pi(L)} S \\right]}{\\mathbb{E}\\!\\left[ \\frac{R}{\\pi(L)} \\right]}.\n$$\n根据重期望定律和给定 $L$ 的 MAR 属性，\n$$\n\\mathbb{E}\\!\\left[ \\frac{R}{\\pi(L)} S \\right]\n= \\mathbb{E}\\!\\left[ \\mathbb{E}\\!\\left[ \\left. \\frac{R}{\\pi(L)} S \\right| L \\right] \\right]\n= \\mathbb{E}\\!\\left[ \\frac{1}{\\pi(L)} \\mathbb{E}[ R \\mid L ]\\, \\mathbb{E}[ S \\mid L ] \\right]\n= \\mathbb{E}\\!\\left[ \\frac{1}{\\pi(L)} \\pi(L) \\, \\mathbb{E}[ S \\mid L ] \\right]\n= \\mathbb{E}[ \\mathbb{E}[ S \\mid L ] ] = \\mathbb{E}[S].\n$$\n类似地，\n$$\n\\mathbb{E}\\!\\left[ \\frac{R}{\\pi(L)} \\right]\n= \\mathbb{E}\\!\\left[ \\mathbb{E}\\!\\left[ \\left. \\frac{R}{\\pi(L)} \\right| L \\right] \\right]\n= \\mathbb{E}\\!\\left[ \\frac{1}{\\pi(L)} \\mathbb{E}[ R \\mid L ] \\right]\n= \\mathbb{E}\\!\\left[ \\frac{1}{\\pi(L)} \\pi(L) \\right] = \\mathbb{E}[1]=1.\n$$\n因此，\n$$\n\\hat{\\mu}_{\\text{IPW}} = \\mathbb{E}[S],\n$$\n这表明在 $\\pi(L)$ 被正确设定的情况下，IPW 能够恢复真实的边际平均值。\n\n经 IPW 校正的平均值的数值。从步骤 1 可知，\n$$\n\\hat{\\mu}_{\\text{IPW}} = \\mathbb{E}[S] = 0.081 = \\frac{81}{1000}.\n$$\n\n总结。完整病例估计量的偏差为\n$$\n\\text{Bias} = -\\frac{1001}{101000} \\approx -0.0099108911,\n$$\n而逆概率加权估计量在此结构中恢复了真实的平均风险 $0.081$。根据问题的指示，我们报告四舍五入到四位有效数字的偏差。", "answer": "$$\\boxed{-0.009911}$$", "id": "4404536"}, {"introduction": "从理论走向实践，这项任务 [@problem_id:4404625] 要求你利用实时传感器数据，构建一个用于检测妊娠期高血压事件的实用算法。你将整合特定孕期的正常值、活动水平调整以及鲁棒的异常值过滤，以创建一个决策支持工具。这个动手实践问题展示了如何将临床指南和统计学原理转化为一个功能性的远程患者监护系统。", "problem": "您的任务是构建并实现一种算法，用于从居家血压（BP）和可穿戴活动传感器的时间序列数据中检测妊娠期高血压事件。该算法必须使用特定孕期的正常值分布来设定具有受控假阳性率的检测阈值，包含对活动引起的短暂升高的调整，应用稳健的离群值抑制来处理运动伪影，并遵守临床最低阈值下限。最终输出必须将每个提供的测试用例分类为一个整数代码：$0$ 表示未检测到事件，$1$ 表示检测到原发性高血压事件，或 $2$ 表示检测到重度高血压事件。所有血压值单位为毫米汞柱（mmHg）。采样间隔为 $1$ 分钟。活动是一个归一化到区间 $\\left[0,1\\right]$ 的无量纲值。\n\n基本原理与约束条件：\n\n- 血压（BP）读数包括在离散时间 $t = 1,2,\\dots,T$ 测量的收缩压值 $S_t$ 和舒张压值 $D_t$。\n- 特定孕期的正常值分布被建模为静息测量下的独立高斯分布 $S \\sim \\mathcal{N}\\left(\\mu_s,\\sigma_s^2\\right)$ 和 $D \\sim \\mathcal{N}\\left(\\mu_d,\\sigma_d^2\\right)$。\n- 通过 Neyman-Pearson 尾部分位数构造来强制设定假阳性率 $\\alpha$。定义上尾分位数 $q_\\alpha = \\Phi^{-1}\\left(1-\\alpha\\right)$，其中 $\\Phi^{-1}$ 是标准正态分布的反累积分布函数。特定孕期的正常值阈值是：\n  $$T_{s,\\mathrm{norm}} = \\mu_s + \\sigma_s q_\\alpha,\\quad T_{d,\\mathrm{norm}} = \\mu_d + \\sigma_d q_\\alpha.$$\n- 必须应用妊娠期高血压的临床最低阈值下限：收缩压阈值 $T_{s,\\mathrm{floor}} = 140$ 和舒张压阈值 $T_{d,\\mathrm{floor}} = 90$。可操作的原发性检测阈值为：\n  $$T_s = \\max\\left(T_{s,\\mathrm{norm}},\\,T_{s,\\mathrm{floor}}\\right),\\quad T_d = \\max\\left(T_{d,\\mathrm{norm}},\\,T_{d,\\mathrm{floor}}\\right).$$\n- 具有重度特征的妊娠期高血压的重度阈值是绝对的：$T_{s,\\mathrm{severe}} = 160$ 和 $T_{d,\\mathrm{severe}} = 110$。\n- 为考虑活动引起的短暂升高，在与 $T_s$ 和 $T_d$ 比较之前，对读数应用线性调整：\n  $$S_{t,\\mathrm{adj}} = S_t - \\beta_s a_t,\\quad D_{t,\\mathrm{adj}} = D_t - \\beta_d a_t,$$\n  其中 $a_t \\in [0,1]$ 是时间 $t$ 的活动水平，$\\beta_s = 8$ 和 $\\beta_d = 5$ 的单位是 mmHg/单位活动量。\n- 对运动伪影的稳健抑制使用中位数绝对偏差（MAD）。对于一个序列 $x_t$，计算\n  $$m_x = \\mathrm{median}(x_t),\\quad \\mathrm{MAD}_x = \\mathrm{median}\\left(\\left|x_t - m_x\\right|\\right).$$\n  如果满足以下条件，则时间 $t$ 的样本被标记为无效\n  $$\\left|S_t - m_S\\right| > k \\cdot \\mathrm{MAD}_S\\ \\text{ or }\\ \\left|D_t - m_D\\right| > k \\cdot \\mathrm{MAD}_D,$$\n  并且同时 $a_t > a_{\\mathrm{artifact}}$。使用 $k=3$ 和 $a_{\\mathrm{artifact}} = 0.5$。\n- 静息门控：只有当活动水平较低时（$a_t \\le a_{\\mathrm{rest}}$）才能宣告事件发生，其中 $a_{\\mathrm{rest}} = 0.3$。\n- 原发性事件检测要求至少有 $r$ 个连续的、有效的、经过静息门控的样本超过可操作阈值：\n  $$\\text{primary if there exists } t \\text{ such that for } r \\text{ consecutive indices } i\\in\\{t,\\dots,t+r-1\\},\\ a_i \\le a_{\\mathrm{rest}},\\ \\text{valid}_i = \\text{true},\\ \\text{and } \\left( S_{i,\\mathrm{adj}} \\ge T_s\\ \\text{ or }\\ D_{i,\\mathrm{adj}} \\ge T_d \\right).$$\n  使用 $r=3$。\n- 重度事件检测要求至少有 $p$ 个连续的、有效的、经过静息门控的样本使用未经调整的测量值超过重度阈值：\n  $$\\text{severe if there exists } t \\text{ such that for } p \\text{ consecutive indices } i\\in\\{t,\\dots,t+p-1\\},\\ a_i \\le a_{\\mathrm{rest}},\\ \\text{valid}_i = \\text{true},\\ \\text{and } \\left( S_{i} \\ge T_{s,\\mathrm{severe}}\\ \\text{ or }\\ D_{i} \\ge T_{d,\\mathrm{severe}} \\right).$$\n  使用 $p=2$。\n- 分类规则：如果满足重度标准，则返回 $2$；否则，如果满足原发性标准，则返回 $1$；否则返回 $0$。\n\n特定孕期的正常值参数：\n\n- 第一孕期 ($\\text{trimester}=1$)：$\\mu_s = 118$, $\\sigma_s = 10$；$\\mu_d = 76$, $\\sigma_d = 8$。\n- 第二孕期 ($\\text{trimester}=2$)：$\\mu_s = 112$, $\\sigma_s = 9$；$\\mu_d = 72$, $\\sigma_d = 7$。\n- 第三孕期 ($\\text{trimester}=3$)：$\\mu_s = 116$, $\\sigma_s = 10$；$\\mu_d = 74$, $\\sigma_d = 8$。\n- 使用 $\\alpha = 0.01$。\n\n您的程序必须实现上述算法，并为以下测试套件生成指定的分类。每个测试用例是一个元组，包含 $(\\text{trimester}, S, D, A)$，其中 $S$ 是收缩压序列，$D$ 是舒张压序列，$A$ 是活动序列。所有BP值单位为mmHg，活动值为 $\\left[0,1\\right]$ 内的无量纲值。\n\n测试套件：\n\n- 案例 1（第一孕期，高活动尖峰，预期无事件）：\n  - $\\text{trimester} = 1$\n  - $S = [126,130,142,139,145,135,128,140]$\n  - $D = [80,82,84,83,86,79,81,85]$\n  - $A = [0.6,0.7,0.8,0.7,0.9,0.65,0.7,0.8]$\n- 案例 2（第二孕期，静息时持续舒张压升高，预期有原发性事件）：\n  - $\\text{trimester} = 2$\n  - $S = [118,120,122,119,117,115,121,120]$\n  - $D = [92,94,95,91,89,88,87,90]$\n  - $A = [0.1,0.1,0.1,0.1,0.1,0.1,0.2,0.1]$\n- 案例 3（第三孕期，静息时重度收缩压升高，预期有重度事件）：\n  - $\\text{trimester} = 3$\n  - $S = [165,166,164,150,148,152]$\n  - $D = [90,92,88,85,84,86]$\n  - $A = [0.05,0.05,0.05,0.1,0.1,0.1]$\n- 案例 4（第二孕期，收缩压接近正常值阈值但低于临床下限，预期无事件）：\n  - $\\text{trimester} = 2$\n  - $S = [136,136,137,132,133,135]$\n  - $D = [80,82,81,79,80,82]$\n  - $A = [0.1,0.1,0.1,0.1,0.1,0.1]$\n- 案例 5（第一孕期，伴随高活动的运动伪影离群值，稳健滤波后预期无事件）：\n  - $\\text{trimester} = 1$\n  - $S = [120,122,200,121,119,118,117,116]$\n  - $D = [75,76,90,74,73,72,71,70]$\n  - $A = [0.1,0.1,0.8,0.1,0.1,0.1,0.1,0.1]$\n\n最终输出格式：\n\n- 您的程序应生成单行输出，其中包含五个测试用例的分类结果，格式为逗号分隔的列表，并用方括号括起，例如：$\\left[\\text{result}_1,\\text{result}_2,\\text{result}_3,\\text{result}_4,\\text{result}_5\\right]$。\n- 每个 $\\text{result}_i$ 必须是如上定义的整数，属于集合 $\\{0,1,2\\}$。", "solution": "该问题陈述已经过严格审查，并被确定为有效。它在科学上基于产科和动态血压监测的既定原则，其定义和约束条件清晰完整，问题阐述良好，并且表述客观。任务是构建一个基于规则的算法，用于从时间序列数据中分类高血压事件，这是一个既可形式化又与人工智能在女性健康领域的应用相关的问题。因此，我们可以着手进行原则性的求解。\n\n该算法系统地处理给定孕期的收缩压（$S_t$）、舒张压（$D_t$）和身体活动（$a_t$）的时间序列数据。分类逻辑包括几个阶段：参数初始化、离群值抑制和序列性事件检测。\n\n首先，我们确定控制算法的常数和参数。\n用于正常值阈值设定的假阳性率设置为 $\\alpha = 0.01$。单尾检验的分位数为 $q_\\alpha = \\Phi^{-1}(1-\\alpha)$，其中 $\\Phi^{-1}$ 是标准正态累积分布函数的反函数。对于 $\\alpha = 0.01$，$q_{0.01} \\approx 2.3263$。\n\n临床阈值下限为，原发性高血压的 $T_{s,\\mathrm{floor}} = 140$ mmHg 和 $T_{d,\\mathrm{floor}} = 90$ mmHg，以及绝对的重度阈值 $T_{s,\\mathrm{severe}} = 160$ mmHg 和 $T_{d,\\mathrm{severe}} = 110$ mmHg。\n\n与活动相关的参数包括调整系数 $\\beta_s = 8$ mmHg/单位活动量 和 $\\beta_d = 5$ mmHg/单位活动量，伪影活动阈值 $a_{\\mathrm{artifact}} = 0.5$，以及静息状态阈值 $a_{\\mathrm{rest}} = 0.3$。\n\n离群值检测由一个乘数 $k=3$ 控制。事件检测要求原发性事件至少有 $r=3$ 个连续读数，重度事件至少有 $p=2$ 个。\n\n对每个测试用例的分析始于从提供的表格中选择特定孕期的正常值参数 $(\\mu_s, \\sigma_s, \\mu_d, \\sigma_d)$：\n- 第一孕期：$\\mu_s = 118$, $\\sigma_s = 10$; $\\mu_d = 76$, $\\sigma_d = 8$。\n- 第二孕期：$\\mu_s = 112$, $\\sigma_s = 9$; $\\mu_d = 72$, $\\sigma_d = 7$。\n- 第三孕期：$\\mu_s = 116$, $\\sigma_s = 10$; $\\mu_d = 74$, $\\sigma_d = 8$。\n\n根据这些参数，计算正常血压阈值：\n$$T_{s,\\mathrm{norm}} = \\mu_s + \\sigma_s q_\\alpha$$\n$$T_{d,\\mathrm{norm}} = \\mu_d + \\sigma_d q_\\alpha$$\n\n然后，通过取正常值阈值和临床下限阈值的最大值来确定可操作的原发性阈值 $T_s$ 和 $T_d$，以确保遵守临床标准：\n$$T_s = \\max\\left(T_{s,\\mathrm{norm}},\\,T_{s,\\mathrm{floor}}\\right)$$\n$$T_d = \\max\\left(T_{d,\\mathrm{norm}},\\,T_{d,\\mathrm{floor}}\\right)$$\n\n下一阶段是稳健的离群值抑制。此步骤识别并标记可能由运动伪影损坏的数据点。对于完整的收缩压（$S$）和舒张压（$D$）序列，我们计算它们的中位数（$m_S, m_D$）和中位数绝对偏差（$\\mathrm{MAD}_S, \\mathrm{MAD}_D$）。如果一个样本在活动水平高时，在任一血压通道上是统计学上的离群值，则在时间 $t$ 将其标记为无效。形式上，如果满足以下条件，则样本无效：\n$$\\left(\\left|S_t - m_S\\right| > k \\cdot \\mathrm{MAD}_S\\ \\text{ or }\\ \\left|D_t - m_D\\right| > k \\cdot \\mathrm{MAD}_D\\right) \\land (a_t > a_{\\mathrm{artifact}})$$\n所有其他样本均被视为有效。\n\n事件检测遵循特定的层次结构：我们首先检查是否存在重度事件，只有在未发现重度事件时，才继续检查是否存在原发性事件。\n\n为检测重度事件，我们寻找一个长度为 $p=2$ 的连续时间点序列 $i \\in \\{t, \\dots, t+p-1\\}$，该序列同时满足三个条件：\n$1$. 样本是有效的（即不是运动伪影）。\n$2$. 患者处于静息状态：$a_i \\le a_{\\mathrm{rest}}$。\n$3$. 未经调整的血压达到或超过重度标准：$S_i \\ge T_{s,\\mathrm{severe}}$ 或 $D_i \\ge T_{d,\\mathrm{severe}}$。\n如果找到这样的序列，该案例被分类为重度事件（代码 $2$），且对此案例的分析结束。\n\n如果未检测到重度事件，我们接着搜索原发性事件。这需要找到一个长度为 $r=3$ 的连续时间点序列 $i \\in \\{t, \\dots, t+r-1\\}$，该序列满足三个类似的条件：\n$1$. 样本是有效的。\n$2$. 患者处于静息状态：$a_i \\le a_{\\mathrm{rest}}$。\n$3$. 经过活动调整的血压达到或超过可操作的原发性阈值。调整后的血压计算如下：\n$$S_{i,\\mathrm{adj}} = S_i - \\beta_s a_i$$\n$$D_{i,\\mathrm{adj}} = D_i - \\beta_d a_i$$\n则条件为 $S_{i,\\mathrm{adj}} \\ge T_s$ 或 $D_{i,\\mathrm{adj}} \\ge T_d$。\n如果找到这样的序列，该案例被分类为原发性事件（代码 $1$）。\n\n如果在检查所有可能的子序列后，既未检测到重度事件也未检测到原发性事件，则该案例被分类为正常（代码 $0$）。\n\n这个综合算法将被实现，用于对提供的测试套件进行分类。", "answer": "```python\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Implements the algorithm for detecting hypertensive episodes in pregnancy.\n    \"\"\"\n\n    # --- Algorithm Constants and Parameters ---\n    ALPHA = 0.01\n    T_S_FLOOR = 140\n    T_D_FLOOR = 90\n    T_S_SEVERE = 160\n    T_D_SEVERE = 110\n    BETA_S = 8\n    BETA_D = 5\n    K_MAD = 3\n    A_ARTIFACT = 0.5\n    A_REST = 0.3\n    R_PRIMARY = 3\n    P_SEVERE = 2\n\n    q_alpha = norm.ppf(1 - ALPHA)\n\n    # Trimester-specific normative parameters (mu_s, sigma_s, mu_d, sigma_d)\n    trimester_params = {\n        1: (118, 10, 76, 8),\n        2: (112, 9, 72, 7),\n        3: (116, 10, 74, 8),\n    }\n\n    # --- Test Suite ---\n    test_cases = [\n        # Case 1 (first trimester, high activity spikes, no episode expected)\n        (1,\n         np.array([126, 130, 142, 139, 145, 135, 128, 140]),\n         np.array([80, 82, 84, 83, 86, 79, 81, 85]),\n         np.array([0.6, 0.7, 0.8, 0.7, 0.9, 0.65, 0.7, 0.8])),\n\n        # Case 2 (second trimester, sustained diastolic elevation at rest, primary episode expected)\n        (2,\n         np.array([118, 120, 122, 119, 117, 115, 121, 120]),\n         np.array([92, 94, 95, 91, 89, 88, 87, 90]),\n         np.array([0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.2, 0.1])),\n\n        # Case 3 (third trimester, severe systolic elevations at rest, severe episode expected)\n        (3,\n         np.array([165, 166, 164, 150, 148, 152]),\n         np.array([90, 92, 88, 85, 84, 86]),\n         np.array([0.05, 0.05, 0.05, 0.1, 0.1, 0.1])),\n\n        # Case 4 (second trimester, systolic near normative threshold but below clinical floor, no episode expected)\n        (2,\n         np.array([136, 136, 137, 132, 133, 135]),\n         np.array([80, 82, 81, 79, 80, 82]),\n         np.array([0.1, 0.1, 0.1, 0.1, 0.1, 0.1])),\n\n        # Case 5 (first trimester, motion artifact outlier with high activity, no episode expected)\n        (1,\n         np.array([120, 122, 200, 121, 119, 118, 117, 116]),\n         np.array([75, 76, 90, 74, 73, 72, 71, 70]),\n         np.array([0.1, 0.1, 0.8, 0.1, 0.1, 0.1, 0.1, 0.1])),\n    ]\n\n    results = []\n\n    for case in test_cases:\n        trimester, s_data, d_data, a_data = case\n        num_samples = len(s_data)\n\n        # --- Step 1: Calculate Trimester-Specific Thresholds ---\n        mu_s, sigma_s, mu_d, sigma_d = trimester_params[trimester]\n        \n        t_s_norm = mu_s + sigma_s * q_alpha\n        t_d_norm = mu_d + sigma_d * q_alpha\n\n        t_s_primary = max(t_s_norm, T_S_FLOOR)\n        t_d_primary = max(t_d_norm, T_D_FLOOR)\n\n        # --- Step 2: Outlier Suppression (Validity Check) ---\n        m_s = np.median(s_data)\n        m_d = np.median(d_data)\n        \n        mad_s = np.median(np.abs(s_data - m_s))\n        mad_d = np.median(np.abs(d_data - m_d))\n        \n        is_valid = np.full(num_samples, True, dtype=bool)\n        for t in range(num_samples):\n            s_dev_check = mad_s > 0 and np.abs(s_data[t] - m_s) > K_MAD * mad_s\n            if mad_s == 0 and s_data[t] != m_s: s_dev_check = True\n\n            d_dev_check = mad_d > 0 and np.abs(d_data[t] - m_d) > K_MAD * mad_d\n            if mad_d == 0 and d_data[t] != m_d: d_dev_check = True\n\n            if (s_dev_check or d_dev_check) and a_data[t] > A_ARTIFACT:\n                is_valid[t] = False\n\n        # --- Step 3: Episode Detection ---\n        severe_detected = False\n        primary_detected = False\n\n        # Check for Severe Episode (Priority 1)\n        if num_samples >= P_SEVERE:\n            for t in range(num_samples - P_SEVERE + 1):\n                is_consecutive_match = True\n                for i in range(t, t + P_SEVERE):\n                    is_rest_gated = a_data[i] = A_REST\n                    bp_exceeded = s_data[i] = T_S_SEVERE or d_data[i] = T_D_SEVERE\n                    if not (is_valid[i] and is_rest_gated and bp_exceeded):\n                        is_consecutive_match = False\n                        break\n                if is_consecutive_match:\n                    severe_detected = True\n                    break\n        \n        # Check for Primary Episode (Priority 2)\n        if not severe_detected and num_samples = R_PRIMARY:\n            for t in range(num_samples - R_PRIMARY + 1):\n                is_consecutive_match = True\n                for i in range(t, t + R_PRIMARY):\n                    s_adj = s_data[i] - BETA_S * a_data[i]\n                    d_adj = d_data[i] - BETA_D * a_data[i]\n                    is_rest_gated = a_data[i] = A_REST\n                    bp_exceeded = s_adj = t_s_primary or d_adj = t_d_primary\n                    if not (is_valid[i] and is_rest_gated and bp_exceeded):\n                        is_consecutive_match = False\n                        break\n                if is_consecutive_match:\n                    primary_detected = True\n                    break\n        \n        # --- Step 4: Classification ---\n        if severe_detected:\n            results.append(2)\n        elif primary_detected:\n            results.append(1)\n        else:\n            results.append(0)\n\n    # --- Final Output ---\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "4404625"}, {"introduction": "一个预测模型的准确性本身并不足够，其临床实用性才是真正重要的。这项练习 [@problem_id:4404542] 将向你介绍决策曲线分析和“净获益”的概念，这是一个评估基于模型的决策策略是否利大于弊的框架。通过推导净获益公式并将其应用于子痫前症预测场景，你将学会如何在不同风险阈值范围内量化模型的临床价值。", "problem": "一个三级围产中心正在评估一个概率性二元分类器，该分类器为每位怀孕患者 $i$ 输出一个发生先兆子痫的个体化预测概率 $\\hat{p}_i$。一项临床决策规则是，如果 $\\hat{p}_i \\ge t$，则启动预防性干预，其中 $t$ 是一个风险阈值，由临床医生根据对过度治疗与治疗不足的相对容忍度来选择。您将使用基本的决策分析原理和经验频率，推导临床净效益作为 $t$ 的函数，然后计算其在临床相关范围内的平均值。\n\n理论基础：\n- 不确定性下的期望效用，其中阈值概率 $t$ 体现了治疗真阳性病例的收益与治疗非病例的危害之间的权衡。\n- 在阈值规则下，根据观测结果得到的真阳性和假阳性的经验计数，以及当收益归一化为 $1$ 时，将净效益解释为每位患者的净真阳性数。\n\n从期望效用的第一性原理和阈值概率的定义出发，推导当使用阈值规则 $\\hat{p}_i \\ge t$ 时，分类器的临床净效益 $NB(t)$ 的公式，该公式用 $N$ 名患者中的真阳性数 $TP(t)$ 和假阳性数 $FP(t)$ 来表示。\n\n然后，使用以下包含 $N = 12$ 例单胎妊娠的模型预测风险和观测到的先兆子痫结局 $y_i \\in \\{0,1\\}$ 的数据集，计算在阈值区间 $t \\in [0.05, 0.30]$ 上的平均临床净效益：\n- 患者 $1$：$\\hat{p}_1 = 0.04$, $y_1 = 0$\n- 患者 $2$：$\\hat{p}_2 = 0.06$, $y_2 = 0$\n- 患者 $3$：$\\hat{p}_3 = 0.08$, $y_3 = 1$\n- 患者 $4$：$\\hat{p}_4 = 0.10$, $y_4 = 0$\n- 患者 $5$：$\\hat{p}_5 = 0.12$, $y_5 = 0$\n- 患者 $6$：$\\hat{p}_6 = 0.15$, $y_6 = 1$\n- 患者 $7$：$\\hat{p}_7 = 0.18$, $y_7 = 0$\n- 患者 $8$：$\\hat{p}_8 = 0.22$, $y_8 = 1$\n- 患者 $9$：$\\hat{p}_9 = 0.25$, $y_9 = 0$\n- 患者 $10$：$\\hat{p}_{10} = 0.27$, $y_{10} = 1$\n- 患者 $11$：$\\hat{p}_{11} = 0.30$, $y_{11} = 0$\n- 患者 $12$：$\\hat{p}_{12} = 0.40$, $y_{12} = 1$\n\n使用惯例，如果 $\\hat{p}_i \\ge t$，则患者被分类为阳性。令 $TP(t)$ 和 $FP(t)$ 分别表示在阈值 $t$ 下的真阳性数和假阳性数。将临床净效益 $NB(t)$ 定义为每位患者的预期净真阳性数（真阳性的收益设为 $1$，假阳性的危害由 $t$ 编码）。\n\n计算在该区间上的平均临床净效益，\n$$\n\\overline{NB} \\;=\\; \\frac{1}{0.30 - 0.05}\\int_{0.05}^{0.30} NB(t)\\, dt,\n$$\n使用上述观测结果。将您的最终答案 $\\overline{NB}$ 四舍五入到 $4$ 位有效数字。以每位患者的净真阳性数为单位表示最终结果。", "solution": "该问题要求两部分内容：首先，从第一性原理推导临床净效益公式 $NB(t)$；其次，使用给定的数据集计算在指定的风险阈值 $t$ 区间上的平均净效益 $\\overline{NB}$。\n\n**第1部分：净效益公式的推导**\n\n推导始于最大化期望效用的决策分析原理。对于单个患者，如果干预的期望效用大于不干预的期望效用，则推荐进行预防性干预。令 $\\hat{p}$ 为模型预测的患者将发展为先兆子痫（即，成为“病例”）的概率。\n\n令 $b$ 为治疗一个真正病例（真阳性，TP）的净收益。令 $c$ 为治疗一个非病例（假阳性，FP）的净危害（或成本）。我们可以将不干预的效用对病例和非病例都设置为零，因为这代表了基线或默认策略。\n\n对于风险为 $\\hat{p}$ 的患者，干预的期望效用 $E[U(\\text{干预})]$ 是其为病例的概率乘以TP的收益，减去其不为病例的概率乘以FP的危害：\n$$\nE[U(\\text{干预})] = \\hat{p} \\cdot b - (1-\\hat{p}) \\cdot c\n$$\n不干预的期望效用被定义为基线，即为零：\n$$\nE[U(\\text{不干预})] = 0\n$$\n一个理性的决策者会在 $E[U(\\text{干预})]  E[U(\\text{不干预})]$ 时选择干预，这意味着：\n$$\n\\hat{p} \\cdot b - (1-\\hat{p}) \\cdot c  0\n$$\n风险阈值 $t$ 被定义为决策者在干预与不干预之间无差异的概率点。这发生在期望效用相等时：\n$$\nt \\cdot b - (1-t) \\cdot c = 0\n$$\n这个方程建立了收益-危害权衡与阈值概率 $t$ 之间的关系：\n$$\nt \\cdot b = (1-t) \\cdot c \\implies \\frac{c}{b} = \\frac{t}{1-t}\n$$\n问题陈述中说明，一个真阳性的收益被归一化为 $1$，所以我们设 $b=1$。因此，一个假阳性的危害（以真阳性收益为单位）是 $c = \\frac{t}{1-t}$。\n\n一个包含 $N$ 名患者群体的总净效益是所有真阳性收益的总和减去所有假阳性危害的总和。使用决策阈值 $t$，真阳性的数量是 $TP(t)$，假阳性的数量是 $FP(t)$。总净效益是：\n$$\n\\text{总净效益} = TP(t) \\cdot b - FP(t) \\cdot c\n$$\n每位患者的临床净效益 $NB(t)$ 是总净效益除以患者总数 $N$：\n$$\nNB(t) = \\frac{TP(t) \\cdot b - FP(t) \\cdot c}{N}\n$$\n代入 $b=1$ 和 $c = \\frac{t}{1-t}$，我们得到所求的临床净效益公式：\n$$\nNB(t) = \\frac{TP(t)}{N} - \\frac{FP(t)}{N} \\frac{t}{1-t}\n$$\n该公式表示在使用决策阈值 $t$ 时，考虑了假阳性的危害后，每位患者的净真阳性增益。\n\n**第2部分：平均净效益的计算**\n\n我们的任务是计算在区间 $t \\in [0.05, 0.30]$ 上的平均临床净效益 $\\overline{NB}$，由下式给出：\n$$\n\\overline{NB} = \\frac{1}{0.30 - 0.05} \\int_{0.05}^{0.30} NB(t) \\, dt = \\frac{1}{0.25} \\int_{0.05}^{0.30} \\left( \\frac{TP(t)}{12} - \\frac{FP(t)}{12} \\frac{t}{1-t} \\right) dt\n$$\n数据集包含 $N=12$ 名患者。函数 $TP(t)$ 和 $FP(t)$ 是阶梯函数，其值仅在预测概率 $\\hat{p}_i$ 处发生变化。在积分区间 $[0.05, 0.30]$ 内的相关 $\\hat{p}_i$ 值为 $\\{0.06, 0.08, 0.10, 0.12, 0.15, 0.18, 0.22, 0.25, 0.27, 0.30\\}$。这些值将积分区间划分为多个子区间，在每个子区间内 $TP(t)$ 和 $FP(t)$ 是常数。\n\n患者数据如下：\n$\\hat{p} = \\{0.04, 0.06, 0.08, 0.10, 0.12, 0.15, 0.18, 0.22, 0.25, 0.27, 0.30, 0.40\\}$\n$y = \\{0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 1\\}$\n\n我们为每个子区间计算 $TP(t)$ 和 $FP(t)$ 的值。如果 $\\hat{p}_i \\ge t$，则患者 $i$ 被分类为阳性。\n1.  对于 $t \\in (0.27, 0.30]$：$\\hat{p}_i \\in \\{0.30, 0.40\\}$ 的患者为阳性。这些是患者11 ($y=0$) 和患者12 ($y=1$) 。因此，$TP(t)=1$, $FP(t)=1$。\n2.  对于 $t \\in (0.25, 0.27]$：$\\hat{p}_i \\in \\{0.27, 0.30, 0.40\\}$ 的患者为阳性。增加了患者10 ($y=1$)。因此，$TP(t)=2$, $FP(t)=1$。\n3.  对于 $t \\in (0.22, 0.25]$：增加了患者9 ($y=0$)。$TP(t)=2$, $FP(t)=2$。\n4.  对于 $t \\in (0.18, 0.22]$：增加了患者8 ($y=1$)。$TP(t)=3$, $FP(t)=2$。\n5.  对于 $t \\in (0.15, 0.18]$：增加了患者7 ($y=0$)。$TP(t)=3$, $FP(t)=3$。\n6.  对于 $t \\in (0.12, 0.15]$：增加了患者6 ($y=1$)。$TP(t)=4$, $FP(t)=3$。\n7.  对于 $t \\in (0.10, 0.12]$：增加了患者5 ($y=0$)。$TP(t)=4$, $FP(t)=4$。\n8.  对于 $t \\in (0.08, 0.10]$：增加了患者4 ($y=0$)。$TP(t)=4$, $FP(t)=5$。\n9.  对于 $t \\in (0.06, 0.08]$：增加了患者3 ($y=1$)。$TP(t)=5$, $FP(t)=5$。\n10. 对于 $t \\in [0.05, 0.06]$：增加了患者2 ($y=0$)。$TP(t)=5$, $FP(t)=6$。\n\n总积分是这些子区间上积分的总和：\n$$\n\\int_{0.05}^{0.30} NB(t) \\, dt = \\frac{1}{12} \\sum_{k=1}^{10} \\int_{t_k}^{t_{k+1}} \\left( TP_k - FP_k \\frac{t}{1-t} \\right) dt\n$$\n被积函数的原函数是 $\\int (A - B\\frac{t}{1-t}) dt = \\int (A + B - \\frac{B}{1-t}) dt = (A+B)t + B\\ln(1-t)$。\n\n我们来计算积分 $\\int_{0.05}^{0.30} (TP(t) - FP(t) \\frac{t}{1-t}) dt$ 的值：\n1.  $\\int_{0.27}^{0.30} (1 - 1 \\frac{t}{1-t}) dt = [2t + \\ln(1-t)]_{0.27}^{0.30} = (0.60+\\ln(0.70))-(0.54+\\ln(0.73)) \\approx 0.01804$\n2.  $\\int_{0.25}^{0.27} (2 - 1 \\frac{t}{1-t}) dt = [3t + \\ln(1-t)]_{0.25}^{0.27} = (0.81+\\ln(0.73))-(0.75+\\ln(0.75)) \\approx 0.03297$\n3.  $\\int_{0.22}^{0.25} (2 - 2 \\frac{t}{1-t}) dt = [4t + 2\\ln(1-t)]_{0.22}^{0.25} = (1.00+2\\ln(0.75))-(0.88+2\\ln(0.78)) \\approx 0.04156$\n4.  $\\int_{0.18}^{0.22} (3 - 2 \\frac{t}{1-t}) dt = [5t + 2\\ln(1-t)]_{0.18}^{0.22} = (1.10+2\\ln(0.78))-(0.90+2\\ln(0.82)) \\approx 0.09998$\n5.  $\\int_{0.15}^{0.18} (3 - 3 \\frac{t}{1-t}) dt = [6t + 3\\ln(1-t)]_{0.15}^{0.18} = (1.08+3\\ln(0.82))-(0.90+3\\ln(0.85)) \\approx 0.07221$\n6.  $\\int_{0.12}^{0.15} (4 - 3 \\frac{t}{1-t}) dt = [7t + 3\\ln(1-t)]_{0.12}^{0.15} = (1.05+3\\ln(0.85))-(0.84+3\\ln(0.88)) \\approx 0.10593$\n7.  $\\int_{0.10}^{0.12} (4 - 4 \\frac{t}{1-t}) dt = [8t + 4\\ln(1-t)]_{0.10}^{0.12} = (0.96+4\\ln(0.88))-(0.80+4\\ln(0.90)) \\approx 0.07011$\n8.  $\\int_{0.08}^{0.10} (4 - 5 \\frac{t}{1-t}) dt = [9t + 5\\ln(1-t)]_{0.08}^{0.10} = (0.90+5\\ln(0.90))-(0.72+5\\ln(0.92)) \\approx 0.07010$\n9.  $\\int_{0.06}^{0.08} (5 - 5 \\frac{t}{1-t}) dt = [10t + 5\\ln(1-t)]_{0.06}^{0.08} = (0.80+5\\ln(0.92))-(0.60+5\\ln(0.94)) \\approx 0.09250$\n10. $\\int_{0.05}^{0.06} (5 - 6 \\frac{t}{1-t}) dt = [11t+6\\ln(1-t)]_{0.05}^{0.06} = (0.66+6\\ln(0.94))-(0.55+6\\ln(0.95)) \\approx 0.04646$\n\n将这些值相加，得到分子积分的总值：\n$$\n\\text{总和} \\approx 0.01804 + 0.03297 + 0.04156 + 0.09998 + 0.07221 + 0.10593 + 0.07011 + 0.07010 + 0.09250 + 0.04646 = 0.64986\n$$\n现在，我们计算 $NB(t)$ 的积分：\n$$\n\\int_{0.05}^{0.30} NB(t) \\, dt = \\frac{1}{12} \\times 0.64986 \\approx 0.054155\n$$\n最后，我们计算平均净效益 $\\overline{NB}$：\n$$\n\\overline{NB} = \\frac{1}{0.25} \\times 0.054155 \\approx 0.21662\n$$\n四舍五入到 $4$ 位有效数字，结果是 $0.2166$。这个值表示当临床决策阈值在 $5\\%$ 到 $30\\%$ 的临床相关风险范围内变化时，以每位患者获得的净真阳性数为单位的平均净效益。", "answer": "$$\n\\boxed{0.2166}\n$$", "id": "4404542"}]}