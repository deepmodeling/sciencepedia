{"hands_on_practices": [{"introduction": "任何重复经颅磁刺激（rTMS）的治疗方案都是由一组精确的参数定义的。本练习旨在将这些参数——频率、刺激串时长和间歇时间——转化为临床相关的输出，如总治疗时间和总脉冲数。掌握这些基本计算是安全有效地设计、理解和实施rTMS方案的第一步。[@problem_id:4754572]", "problem": "一名患有重度抑郁症（MDD）的患者被处方接受对左背外侧前额叶皮层的高频重复经颅磁刺激（rTMS）。该方案采用的刺激频率为 $10\\,\\mathrm{Hz}$，以刺激序列的形式施加，每个序列持续时间为 $4\\,\\mathrm{s}$，序列间歇为 $26\\,\\mathrm{s}$，总共有 $75$ 个序列。假设序列间歇仅出现在连续的序列之间，最后一个序列之后没有间歇，并且治疗时长定义为所有序列时间和所有序列间歇的总和，不包括第一个序列之前的准备或休息时间以及最后一个序列之后的任何时间。根据频率（单位赫兹）是每秒脉冲数的定义，以及总施加脉冲数等于所有序列中脉冲数的总和，计算总治疗时长和总施加脉冲数。\n\n将治疗时长以分钟表示，并将您的答案四舍五入到四位有效数字。将总脉冲数表示为无量纲的计数。请以行向量的形式提供您的最终答案，其中第一个条目是治疗时长（分钟），第二个条目是总施加脉冲数。", "solution": "评估用户提供的问题的有效性。\n\n### 步骤 1：提取已知条件\n- 刺激频率：$f = 10\\,\\mathrm{Hz}$\n- 序列持续时间：$t_{train} = 4\\,\\mathrm{s}$\n- 序列间歇：$t_{inter} = 26\\,\\mathrm{s}$\n- 序列总数：$N_{trains} = 75$\n- 条件：序列间歇仅出现在连续序列之间，最后一个序列之后没有间歇。\n- 治疗时长的定义：所有序列时间和所有序列间歇的总和。\n- 要求输出：\n  1. 总治疗时长，以分钟为单位，四舍五入至四位有效数字。\n  2. 总施加脉冲数，作为无量纲计数。\n- 最终答案格式：一个包含治疗时长和总脉冲数的行向量。\n\n### 步骤 2：使用提取的已知条件进行验证\n该问题具有科学依据，因为所提供的重复经颅磁刺激（rTMS）方案参数是标准的，并且在临床实践中广泛用于治疗重度抑郁症。术语精确，所要求的计算基于频率和时间间隔的基本定义。问题提法得当，提供了所有必要信息，没有矛盾之处。它是客观的，不含任何非科学性主张。\n\n### 步骤 3：结论与行动\n该问题被认为是有效的。将推导解答。\n\n解答过程分为两部分：首先，计算总施加脉冲数；其次，计算总治疗时长。\n\n**第一部分：计算总施加脉冲数**\n\n刺激频率 $f$ 为 $10\\,\\mathrm{Hz}$，相当于每秒 $10$ 个脉冲。每个刺激序列的持续时间为 $t_{train} = 4\\,\\mathrm{s}$。单个序列中施加的脉冲数 $P_{train}$ 是频率和序列持续时间的乘积。\n$$P_{train} = f \\times t_{train}$$\n代入给定值：\n$$P_{train} = 10\\,\\mathrm{s^{-1}} \\times 4\\,\\mathrm{s} = 40\\,\\text{pulses}$$\n总施加脉冲数 $P_{total}$ 是每个序列的脉冲数乘以序列总数 $N_{trains}$。\n$$P_{total} = P_{train} \\times N_{trains}$$\n代入数值：\n$$P_{total} = 40 \\times 75 = 3000$$\n总施加脉冲数为 $3000$。\n\n**第二部分：计算总治疗时长**\n\n总治疗时长 $T_{session}$ 定义为施加刺激序列的总时间和序列间歇总时间的总和。\n\n首先，我们计算刺激序列的总持续时间 $T_{trains\\_total}$。这是序列总数与单个序列持续时间的乘积。\n$$T_{trains\\_total} = N_{trains} \\times t_{train}$$\n代入数值：\n$$T_{trains\\_total} = 75 \\times 4\\,\\mathrm{s} = 300\\,\\mathrm{s}$$\n接下来，我们计算序列间歇的总持续时间。问题指明序列间歇仅出现在连续的序列之间。对于 $N_{trains}$ 个序列，有 $N_{trains} - 1$ 个间歇将它们分开。\n$$N_{inter} = N_{trains} - 1 = 75 - 1 = 74$$\n这些间歇的总持续时间 $T_{inter\\_total}$ 是间歇次数与单个间歇持续时间 $t_{inter}$ 的乘积。\n$$T_{inter\\_total} = N_{inter} \\times t_{inter} = (N_{trains} - 1) \\times t_{inter}$$\n代入数值：\n$$T_{inter\\_total} = 74 \\times 26\\,\\mathrm{s} = 1924\\,\\mathrm{s}$$\n以秒为单位的总治疗时长 $T_{session\\_s}$ 是总序列时间和总间歇时间的总和。\n$$T_{session\\_s} = T_{trains\\_total} + T_{inter\\_total}$$\n$$T_{session\\_s} = 300\\,\\mathrm{s} + 1924\\,\\mathrm{s} = 2224\\,\\mathrm{s}$$\n问题要求将治疗时长以分钟表示。一分钟有 $60$ 秒。\n$$T_{session\\_min} = \\frac{T_{session\\_s}}{60}$$\n$$T_{session\\_min} = \\frac{2224}{60}\\,\\mathrm{min} = 37.0666... \\,\\mathrm{min}$$\n结果必须四舍五入到四位有效数字。第五位有效数字是 $6$，所以我们将第四位数字向上取整。\n$$T_{session\\_min} \\approx 37.07\\,\\mathrm{min}$$\n两个所求值分别为治疗时长 $37.07\\,\\mathrm{min}$ 和总脉冲数 $3000$。按要求将它们表示为行向量。", "answer": "$$\\boxed{\\begin{pmatrix} 37.07 & 3000 \\end{pmatrix}}$$", "id": "4754572"}, {"introduction": "在定义了治疗方案的“内容”之后，下一个关键问题是“在哪里”进行刺激。本练习应用国际10-20脑电（EEG）系统，这是一种基于头皮测量来定位皮层区域的标准化方法，用以定位背外侧前额叶皮层（DLPFC）的近似位置。这项技能对于在没有高级神经导航设备的情况下执行rTMS至关重要，并为理解大脑与头皮的空间关系奠定了坚实的基础。[@problem_id:4754531]", "problem": "在精神病学领域的重复经颅磁刺激 (rTMS) 靶向中，左背外侧前额叶皮层 (DLPFC) 通常由国际10–20脑电图 (EEG) 系统的 $F3$ 位置来近似。国际10–20脑电图系统通过沿解剖学标志点之间的弧线放置电极来定义，使得相邻电极间距在弧线末端为总弧长的 $10\\%$，在内部点之间为 $20\\%$。考虑一名受试者，已沿其皮肤测量了以下两条头皮弧长：\n\n- 从鼻根点到枕外粗隆点的中线弧长为 $D_{\\mathrm{NI}} = 36.8\\ \\mathrm{cm}$。\n- 经过 $Fz$ 的额排（$F$-row）上，从左耳前点到右耳前点的弧长为 $A_{F} = 29.4\\ \\mathrm{cm}$，该弧线向前经过前额和额上部头皮。\n\n在 $Cz$ 点建立一个局部切平面坐标系，其坐标轴方向如下：$x$轴沿中矢状子午线指向鼻根点（向前），$y$轴沿额排（$F$-row）指向左耳前标志点（向左侧）。仅使用国际10–20脑电图系统的核心定义和测量的弧长，从第一性原理出发，推导出从 $Cz$ 到 $F3$ 位点的前向和左侧向偏移量，记为 $(\\Delta x_{\\mathrm{ant}}, \\Delta y_{\\mathrm{lat}})$，其中 $\\Delta x_{\\mathrm{ant}}$ 是沿中矢状子午线从 $Cz$ 向 $Fz$ 测量的距离，而 $\\Delta y_{\\mathrm{lat}}$ 是沿 $F$-row 从 $Fz$ 向 $F3$ 测量的距离。\n\n以厘米为单位表示最终的有序对 $(\\Delta x_{\\mathrm{ant}}, \\Delta y_{\\mathrm{lat}})$，并将数值四舍五入到四位有效数字。", "solution": "用户要求我解决一个基于国际10-20脑电图系统用于rTMS靶向的问题。我必须首先验证问题陈述的有效性。\n\n### 步骤1：提取已知条件\n- **系统**：国际10–20脑电图 (EEG) 系统。\n- **系统规则**：相关弧线上，相邻间距在末端为 $10\\%$，在内部点之间为 $20\\%$。\n- **标志点近似**：左背外侧前额叶皮层 (DLPFC) 由EEG位置 $F3$ 近似。\n- **测量的弧长**：\n    - 鼻根点到枕外粗隆点的中线弧长：$D_{\\mathrm{NI}} = 36.8\\ \\mathrm{cm}$。\n    - 沿额排（$F$-row）的左耳前点到右耳前点的弧长：$A_{F} = 29.4\\ \\mathrm{cm}$。\n- **坐标系（概念性）**：在 $Cz$ 处的局部切平面坐标系。$x$轴沿中矢状子午线向前，$y$轴沿额排向左侧。\n- **待求量**：弧长有序对 $(\\Delta x_{\\mathrm{ant}}, \\Delta y_{\\mathrm{lat}})$，其中：\n    - $\\Delta x_{\\mathrm{ant}}$ 是沿中矢状子午线从 $Cz$ 到 $Fz$ 的弧长。\n    - $\\Delta y_{\\mathrm{lat}}$ 是沿 $F$-row 从 $Fz$ 到 $F3$ 的弧长。\n- **输出要求**：以厘米为单位表示 $(\\Delta x_{\\mathrm{ant}}, \\Delta y_{\\mathrm{lat}})$，数值四舍五入至四位有效数字。\n\n### 步骤2：使用提取的已知条件进行验证\n该问题具有科学依据，因为它基于国际10–20系统，这是神经生理学和临床神经学中用于EEG电极放置的标准，并引申用于rTMS的靶向。解剖学标志点（鼻根点、枕外粗隆点、耳前点）和电极位置（$Cz$、$Fz$、$F3$）都是标准的。给定的测量值对于成年人头部是符合实际的。问题陈述客观、精确、自洽，提供了推导唯一解所需的所有信息。它是一个适定问题，没有违反任何科学或数学原理，也不存在歧义或矛盾。\n\n### 步骤3：结论与行动\n问题有效。我现在将进行求解。\n\n该问题要求根据国际10–20脑电图系统的规则，计算头皮上的两个特定弧长。待确定的量是 $\\Delta x_{\\mathrm{ant}}$（沿中线从 $Cz$ 到 $Fz$ 的前向距离）和 $\\Delta y_{\\mathrm{lat}}$（沿额弧从 $Fz$ 到 $F3$ 的左侧向距离）。\n\n首先，我们计算前向偏移量 $\\Delta x_{\\mathrm{ant}}$，它位于连接鼻根点（$Nz$）和枕外粗隆点（$Iz$）的中矢状子午线上。该子午线的总弧长为 $D_{\\mathrm{NI}} = 36.8\\ \\mathrm{cm}$。10–20系统通过在特定的分数距离处放置电极来划分此弧。从前（鼻根点）到后（枕外粗隆点）的标志点和电极序列为：$Nz$、$Fpz$、$Fz$、$Cz$、$Pz$、$Oz$、$Iz$。根据定义，$Cz$点是头顶点，位于鼻根点到枕外粗隆点距离的 $50\\%$ 标记处。\n\n沿该子午线的相邻点之间的分数距离由系统的命名约定定义：\n- 从鼻根点（$Nz$）到 $Fpz$ 的距离是 $D_{\\mathrm{NI}}$ 的 $10\\%$。\n- 从 $Fpz$ 到 $Fz$ 的距离是 $D_{\\mathrm{NI}}$ 的 $20\\%$。\n- 从 $Fz$ 到 $Cz$ 的距离是 $D_{\\mathrm{NI}}$ 的 $20\\%$。\n- 从 $Cz$ 到 $Pz$ 的距离是 $D_{\\mathrm{NI}}$ 的 $20\\%$。\n- 从 $Pz$ 到 $Oz$ 的距离是 $D_{\\mathrm{NI}}$ 的 $20\\%$。\n- 从 $Oz$ 到枕外粗隆点（$Iz$）的距离是 $D_{\\mathrm{NI}}$ 的 $10\\%$。\n这些百分比的总和确认了总弧长：$10\\% + 20\\% + 20\\% + 20\\% + 20\\% + 10\\% = 100\\%$。\n\n问题将 $\\Delta x_{\\mathrm{ant}}$ 定义为沿中矢状子午线从 $Cz$ 朝向 $Fz$ 测量的弧长。根据10–20系统的分段，该距离对应于 $Cz$ 和 $Fz$ 之间的线段。\n因此，$\\Delta x_{\\mathrm{ant}}$ 是总鼻根点-枕外粗隆点距离 $D_{\\mathrm{NI}}$ 的 $20\\%$。\n$$ \\Delta x_{\\mathrm{ant}} = 0.20 \\times D_{\\mathrm{NI}} $$\n代入给定值 $D_{\\mathrm{NI}} = 36.8\\ \\mathrm{cm}$：\n$$ \\Delta x_{\\mathrm{ant}} = 0.20 \\times 36.8\\ \\mathrm{cm} = 7.36\\ \\mathrm{cm} $$\n\n接下来，我们计算左侧向偏移量 $\\Delta y_{\\mathrm{lat}}$，它位于额弧（'$F$-row'）上。此弧线连接左耳前点（$A1$）和右耳前点（$A2$），并穿过中线点 $Fz$。此弧的总长度为 $A_{F} = 29.4\\ \\mathrm{cm}$。\n此弧上从左到右的电极序列为：$A1$、$F7$、$F3$、$Fz$、$F4$、$F8$、$A2$。$Fz$ 点位于中矢状面上，是 $F3$ 和 $F4$ 之间弧线的中点。\n\n沿这条横向弧线的分数距离同样由10–20系统定义：\n- 从左耳前点（$A1$）到 $F7$ 的距离是 $A_{F}$ 的 $10\\%$。\n- 从 $F7$ 到 $F3$ 的距离是 $A_{F}$ 的 $20\\%$。\n- 从 $F3$ 到 $Fz$ 的距离是 $A_{F}$ 的 $20\\%$。\n- 从 $Fz$ 到 $F4$ 的距离是 $A_{F}$ 的 $20\\%$。\n- 从 $F4$ 到 $F8$ 的距离是 $A_{F}$ 的 $20\\%$。\n- 从 $F8$ 到右耳前点（$A2$）的距离是 $A_{F}$ 的 $10\\%$。\n这些百分比的总和是 $10\\% + 20\\% + 20\\% + 20\\% + 20\\% + 10\\% = 100\\%$。\n\n问题将 $\\Delta y_{\\mathrm{lat}}$ 定义为沿 $F$-row 从 $Fz$ 朝向 $F3$ 测量的弧长。这对应于 $Fz$ 和 $F3$ 之间的线段。\n因此，$\\Delta y_{\\mathrm{lat}}$ 是总弧长 $A_{F}$ 的 $20\\%$。\n$$ \\Delta y_{\\mathrm{lat}} = 0.20 \\times A_{F} $$\n代入给定值 $A_{F} = 29.4\\ \\mathrm{cm}$：\n$$ \\Delta y_{\\mathrm{lat}} = 0.20 \\times 29.4\\ \\mathrm{cm} = 5.88\\ \\mathrm{cm} $$\n\n问题要求最终的有序对 $(\\Delta x_{\\mathrm{ant}}, \\Delta y_{\\mathrm{lat}})$ 的数值四舍五入到四位有效数字。\n计算出的 $\\Delta x_{\\mathrm{ant}}$ 值为 $7.36\\ \\mathrm{cm}$。保留四位有效数字，即为 $7.360\\ \\mathrm{cm}$。\n计算出的 $\\Delta y_{\\mathrm{lat}}$ 值为 $5.88\\ \\mathrm{cm}$。保留四位有效数字，即为 $5.880\\ \\mathrm{cm}$。\n因此，偏移量的有序对为 $(7.360, 5.880)$，单位为厘米。", "answer": "$$ \\boxed{ \\begin{pmatrix} 7.360 & 5.880 \\end{pmatrix} } $$", "id": "4754531"}, {"introduction": "为了提高治疗的精确性，现代rTMS正在从解剖学上的近似定位转向功能定义的个性化靶点。这项高级练习将指导您完成一个计算流程，利用静息态功能磁共振成像（rs-fMRI）数据，来识别与抑郁症相关的脑深部结构——膝下前扣带皮层（sgACC）——存在功能性反相关的特定DLPFC位点。完成此练习将为您提供最先进的神经导航技术的实践经验，将神经影像分析与线圈放置的几何学实践联系起来。[@problem_id:4754561]", "problem": "您会获得来自一个个体的经过预处理的静息态功能性磁共振成像 (rs-fMRI) 数据。临床目标是在背外侧前额叶皮层 (DLPFC) 中选择一个与膝下前扣带皮层 (sgACC) 最大程度反相关的刺激靶点，然后为重复经颅磁刺激 (rTMS) 定义一个与该靶点对齐的可重复线圈放置方案。位置使用蒙特利尔神经学研究所 (MNI) 坐标系，单位为毫米，角度使用度。所有坐标值和几何量必须以毫米表示，所有角度必须以度表示。所有报告的数值输出必须四舍五入到三位小数。\n\n使用的基本原理和定义：\n- 静息态功能性磁共振成像 (rs-fMRI) 为每个大脑位置生成一个时间序列。对于一个种子时间序列 $\\mathbf{s} = (s_1, s_2, \\dots, s_n)$ 和一个候选时间序列 $\\mathbf{x} = (x_1, x_2, \\dots, x_n)$，Pearson 相关系数定义为\n$$\nr(\\mathbf{s}, \\mathbf{x}) = \\frac{\\sum_{i=1}^n (s_i - \\bar{s})(x_i - \\bar{x})}{\\sqrt{\\sum_{i=1}^n (s_i - \\bar{s})^2}\\sqrt{\\sum_{i=1}^n (x_i - \\bar{x})^2}},\n$$\n其中 $\\bar{s}$ 和 $\\bar{x}$ 是样本均值。如果任一时间序列的方差为零（分母等于零），则按惯例设置 $r(\\mathbf{s}, \\mathbf{x}) = 0$。\n- 反相关定义为最负的 Pearson 相关系数；即选择具有最小 $r$ 值的候选者。\n- 头部几何形状近似为一个以原点为中心、半径为 $R$ 毫米的球体。对于一个靶点坐标 $\\mathbf{p}_t = (x_t,y_t,z_t)$ 且 $\\|\\mathbf{p}_t\\|  R$，头皮进入点被建模为从原点穿过 $\\mathbf{p}_t$ 的射线与头皮球体的交点：\n$$\n\\mathbf{e} = \\frac{R}{\\|\\mathbf{p}_t\\|}\\mathbf{p}_t,\n$$\n局部向外法线为 $\\mathbf{n} = \\frac{\\mathbf{e}}{R}$。\n- 为了定义一个可重复的切向线圈方向，将解剖学上的前方向 $\\mathbf{a} = (0,1,0)$ 投影到点 $\\mathbf{e}$ 处的切平面上：\n$$\n\\mathbf{t} = \\mathbf{a} - (\\mathbf{a}\\cdot\\mathbf{n})\\mathbf{n}.\n$$\n如果 $\\|\\mathbf{t}\\|$ 在数值上可忽略不计，则使用侧方向 $\\mathbf{l} = (1,0,0)$ 并设置 $\\mathbf{t} = \\mathbf{l} - (\\mathbf{l}\\cdot\\mathbf{n})\\mathbf{n}$。将 $\\mathbf{t}$ 标准化为单位长度。按如下方式计算与 $\\mathbf{t}$ 对齐的线圈手柄的偏航角、俯仰角和滚转角（单位为度）：\n- 偏航角（$x$-$y$ 平面中的方位角）：$\\theta_{\\mathrm{yaw}} = \\operatorname{atan2}(t_y, t_x)\\cdot\\frac{180}{\\pi}$。\n- 俯仰角（从 $x$-$y$ 平面的仰角）：$\\theta_{\\mathrm{pitch}} = \\operatorname{atan2}(t_z, \\sqrt{t_x^2 + t_y^2})\\cdot\\frac{180}{\\pi}$。\n- 滚转角：对于规范方向选择，设置 $\\theta_{\\mathrm{roll}} = 0$。\n\n靶点选择规则：\n- 为每个位于坐标 $\\mathbf{p}_j$ 的候选 DLPFC 时间序列 $\\mathbf{x}_j$ 计算 $r(\\mathbf{s}, \\mathbf{x}_j)$。\n- 选择使 $r(\\mathbf{s}, \\mathbf{x}_j)$ 最小化的索引 $j^\\*$。如果多个候选者在 $\\varepsilon = 10^{-12}$ 的容差范围内具有相等的最小相关性，则通过选择与参考 DLPFC 坐标 $\\mathbf{p}_{\\mathrm{ref}}$ 的欧几里得距离最小的那个来打破平局。如果仍然平局，选择字典序最小的坐标（先比较 $x$，再比较 $y$，然后比较 $z$）。\n\n您的程序必须实现此过程，并为每个测试用例生成一个包含九个浮点数的单一列表作为输出：\n$[x_t,y_t,z_t,e_x,e_y,e_z,\\theta_{\\mathrm{yaw}},\\theta_{\\mathrm{pitch}},\\theta_{\\mathrm{roll}}]$,\n其中坐标单位为毫米，角度单位为度，所有数值均四舍五入到三位小数。\n\n测试套件：\n- 案例 1 (正常路径)：$R = 90$，种子时间序列 $\\mathbf{s} = [0.2,-0.1,0.3,-0.2,0.1,-0.3]$，候选者\n    - $\\mathbf{p}_1 = [-38,44,26]$, $\\mathbf{x}_1 = [-0.2,0.1,-0.3,0.2,-0.1,0.3]$,\n    - $\\mathbf{p}_2 = [-32,50,24]$, $\\mathbf{x}_2 = [0.2,0.1,0.25,0.1,0.2,0.1]$,\n    - $\\mathbf{p}_3 = [-40,36,30]$, $\\mathbf{x}_3 = [-0.1,0.05,-0.15,0.1,-0.05,0.15]$,\n  参考坐标 $\\mathbf{p}_{\\mathrm{ref}} = [-38,44,26]$。\n- 案例 2 (无负相关)：$R = 90$，种子时间序列 $\\mathbf{s} = [0.1,0.2,0.1,0.2,0.1,0.2]$，候选者\n    - $\\mathbf{p}_1 = [-38,44,26]$, $\\mathbf{x}_1 = [0.11,0.19,0.12,0.18,0.1,0.21]$,\n    - $\\mathbf{p}_2 = [-30,46,28]$, $\\mathbf{x}_2 = [0.05,0.22,0.08,0.19,0.12,0.17]$,\n    - $\\mathbf{p}_3 = [-42,40,24]$, $\\mathbf{x}_3 = [0.09,0.21,0.09,0.21,0.09,0.21]$,\n  参考坐标 $\\mathbf{p}_{\\mathrm{ref}} = [-38,44,26]$。\n- 案例 3 (打破平局)：$R = 90$，种子时间序列 $\\mathbf{s} = [0.4,-0.2,0.3,-0.1,0.2,-0.3]$，候选者\n    - $\\mathbf{p}_1 = [-35,45,25]$, $\\mathbf{x}_1 = [-0.2,0.1,-0.15,0.05,-0.1,0.15]$,\n    - $\\mathbf{p}_2 = [-41,43,27]$, $\\mathbf{x}_2 = [-0.2,0.1,-0.15,0.05,-0.1,0.15]$,\n    - $\\mathbf{p}_3 = [-33,47,29]$, $\\mathbf{x}_3 = [-0.1,0.05,-0.07,0.02,-0.05,0.08]$,\n  参考坐标 $\\mathbf{p}_{\\mathrm{ref}} = [-38,44,26]$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，每个测试用例的结果本身是一个包含九个四舍五入浮点数的列表，例如：\n$[[x_1,y_1,z_1,e_{x1},e_{y1},e_{z1},\\theta_{\\mathrm{yaw1}},\\theta_{\\mathrm{pitch1}},\\theta_{\\mathrm{roll1}}],[x_2,\\dots],[x_3,\\dots]]$。", "solution": "用户提供了一个问题，要求确定重复经颅磁刺激 (rTMS) 的最佳靶点以及相应的线圈放置参数。该方法基于静息态功能性磁共振成像 (rs-fMRI) 数据。\n\n此问题被认为是有效的，因为它在科学上基于既定的神经导航原理，在数学上是良态的，具有清晰的定义和唯一的解标准，并且提供了解决该问题所需的所有数据。解决方案分两个主要阶段进行：首先，选择最佳靶点坐标；其次，计算线圈放置的几何参数。\n\n### 阶段 1：最佳靶点选择\n\n主要目标是在背外侧前额叶皮层 (DLPFC) 中确定一个靶点坐标 $\\mathbf{p}_t$，该靶点与种子区域膝下前扣带皮层 (sgACC) 最大程度地反相关。这是通过找到其 fMRI 时间序列与种子时间序列呈现最负 Pearson 相关性的候选坐标来实现的。\n\n步骤如下：\n\n1.  **计算 Pearson 相关性**：对于每个候选者 $j$，其坐标为 $\\mathbf{p}_j$，时间序列为 $\\mathbf{x}_j$，我们计算其与种子时间序列 $\\mathbf{s}$ 的 Pearson 相关系数 $r_j = r(\\mathbf{s}, \\mathbf{x}_j)$。公式为：\n    $$r(\\mathbf{s}, \\mathbf{x}) = \\frac{\\sum_{i=1}^n (s_i - \\bar{s})(x_i - \\bar{x})}{\\sqrt{\\sum_{i=1}^n (s_i - \\bar{s})^2}\\sqrt{\\sum_{i=1}^n (x_i - \\bar{x})^2}}$$\n    根据问题约定，如果 $\\mathbf{s}$ 或 $\\mathbf{x}_j$ 的方差为零，则相关性 $r_j$ 取为 $0$。\n\n2.  **确定最小相关性**：我们找到所有候选者中的最小相关值：$r_{\\min} = \\min_{j} \\{r_j\\}$。\n\n3.  **应用打破平局规则**：一个多层次的打破平局程序确保选出唯一的靶点。\n    a.  **相关性平局**：首先，我们识别所有相关性 $r_j$ 与最小相关性之差在容差 $\\varepsilon = 10^{-12}$ 内的候选者。设这些平局候选者的集合为 $C_1$。\n        $$C_1 = \\{ \\text{candidate } j \\mid |r_j - r_{\\min}| \\le \\varepsilon \\}$$\n    b.  **距离平局**：如果 $C_1$ 包含多个候选者，我们计算每个候选者坐标 $\\mathbf{p}_j$ 到给定参考坐标 $\\mathbf{p}_{\\mathrm{ref}}$ 的欧几里得距离 $d_j = \\|\\mathbf{p}_j - \\mathbf{p}_{\\mathrm{ref}}\\|$。我们找到最小距离 $d_{\\min} = \\min_{j \\in C_1} \\{d_j\\}$，并从 $C_1$ 中形成一个具有此最小距离的候选者新集合 $C_2$。为处理浮点运算，可以使用类似的容差进行距离比較，尽管在所给案例中并非严格必要。\n    c.  **字典序平局**：如果 $C_2$ 仍然包含多个候选者，我们根据它们的坐标 $\\mathbf{p}_j$ 按字典序（首先按 $x$，然后按 $y$，再按 $z$）进行排序。此排序列表中的第一个候选者被选为最终靶点。\n\n所选候选者的坐标被指定为靶点坐标 $\\mathbf{p}_t = (x_t, y_t, z_t)$。\n\n### 阶段 2：线圈放置计算\n\n一旦确定了靶点 $\\mathbf{p}_t$，我们基于球形头部模型确定线圈放置参数。\n\n1.  **头皮进入点**：头部被建模为一个以原点为中心、半径为 $R$ 的球体。线圈与头皮的接触点 $\\mathbf{e}$ 是通过将靶点 $\\mathbf{p}_t$ 从原点投影到该球体表面上找到的。\n    $$ \\mathbf{e} = \\frac{R}{\\|\\mathbf{p}_t\\|}\\mathbf{p}_t $$\n    其中 $\\|\\mathbf{p}_t\\| = \\sqrt{x_t^2 + y_t^2 + z_t^2}$ 是靶点坐标向量的欧几里得范数。\n\n2.  **线圈方向**：线圈必须在进入点 $\\mathbf{e}$ 处与头皮相切。\n    a.  首先，我们计算进入点 $\\mathbf{e}$ 处的向外单位法向量 $\\mathbf{n}$。对于以原点为中心的球体，这只是 $\\mathbf{e}$ 的归一化位置向量：\n        $$ \\mathbf{n} = \\frac{\\mathbf{e}}{R} = \\frac{\\mathbf{p}_t}{\\|\\mathbf{p}_t\\|} $$\n    b.  通过参考头部的解剖轴来定义一个可重复的切向方向。我们将标准的前方向向量 $\\mathbf{a} = (0, 1, 0)$ 投影到点 $\\mathbf{e}$ 处的切平面上。切平面由法线 $\\mathbf{n}$ 定义。该投影是通过减去 $\\mathbf{a}$ 平行于 $\\mathbf{n}$ 的分量来实现的：\n        $$ \\mathbf{t} = \\mathbf{a} - (\\mathbf{a}\\cdot\\mathbf{n})\\mathbf{n} $$\n    c.  处理一个特殊情况，即靶点位于 $y$ 轴上，这使得 $\\mathbf{n}$ 与 $\\mathbf{a}$ 平行，导致 $\\mathbf{t}$ 成为零向量。如果 $\\|\\mathbf{t}\\|$ 在数值上可忽略不计（例如 $ 10^{-9}$），我们使用侧方向向量 $\\mathbf{l} = (1, 0, 0)$ 代替 $\\mathbf{a}$，并重新计算 $\\mathbf{t} = \\mathbf{l} - (\\mathbf{l}\\cdot\\mathbf{n})\\mathbf{n}$。\n    d.  将得到的向量 $\\mathbf{t}$ 归一化为单位长度，以表示最终的线圈手柄方向：$\\hat{\\mathbf{t}} = \\mathbf{t} / \\|\\mathbf{t}\\|$。令 $\\hat{\\mathbf{t}} = (t_x, t_y, t_z)$。\n\n3.  **方向角**：将方向向量 $\\hat{\\mathbf{t}}$ 转换为 TMS设备的一组偏航角、俯仰角和滚转角。\n    -   **偏航角**：这是在水平 ($x-y$) 平面内的旋转，计算为 $\\hat{\\mathbf{t}}$ 投影的方位角。\n        $$ \\theta_{\\mathrm{yaw}} = \\operatorname{atan2}(t_y, t_x) \\cdot \\frac{180}{\\pi} $$\n    -   **俯仰角**：这是从水平面的仰角。\n        $$ \\theta_{\\mathrm{pitch}} = \\operatorname{atan2}(t_z, \\sqrt{t_x^2 + t_y^2}) \\cdot \\frac{180}{\\pi} $$\n    -   **滚转角**：根据惯例，对于规范方向，滚转角设置为零。\n        $$ \\theta_{\\mathrm{roll}} = 0 $$\n\n最后，对于每个测试用例，我们汇集九个所需值：靶点坐标 $(x_t, y_t, z_t)$、头皮进入点坐标 $(e_x, e_y, e_z)$ 和线圈角度 $(\\theta_{\\mathrm{yaw}}, \\theta_{\\mathrm{pitch}}, \\theta_{\\mathrm{roll}})$。所有数值结果均四舍五入到三位小数。\n\n这个完整的、确定性的程序被应用于问题陈述中提供的每个测试用例。", "answer": "```python\nimport numpy as np\nimport math\n\ndef solve():\n    \"\"\"\n    Solves for the optimal TMS target and coil placement for a series of test cases.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"R\": 90,\n            \"s\": [0.2, -0.1, 0.3, -0.2, 0.1, -0.3],\n            \"p_ref\": [-38, 44, 26],\n            \"candidates\": [\n                ([-38, 44, 26], [-0.2, 0.1, -0.3, 0.2, -0.1, 0.3]),\n                ([-32, 50, 24], [0.2, 0.1, 0.25, 0.1, 0.2, 0.1]),\n                ([-40, 36, 30], [-0.1, 0.05, -0.15, 0.1, -0.05, 0.15]),\n            ]\n        },\n        {\n            \"R\": 90,\n            \"s\": [0.1, 0.2, 0.1, 0.2, 0.1, 0.2],\n            \"p_ref\": [-38, 44, 26],\n            \"candidates\": [\n                ([-38, 44, 26], [0.11, 0.19, 0.12, 0.18, 0.1, 0.21]),\n                ([-30, 46, 28], [0.05, 0.22, 0.08, 0.19, 0.12, 0.17]),\n                ([-42, 40, 24], [0.09, 0.21, 0.09, 0.21, 0.09, 0.21]),\n            ]\n        },\n        {\n            \"R\": 90,\n            \"s\": [0.4, -0.2, 0.3, -0.1, 0.2, -0.3],\n            \"p_ref\": [-38, 44, 26],\n            \"candidates\": [\n                ([-35, 45, 25], [-0.2, 0.1, -0.15, 0.05, -0.1, 0.15]),\n                ([-41, 43, 27], [-0.2, 0.1, -0.15, 0.05, -0.1, 0.15]),\n                ([-33, 47, 29], [-0.1, 0.05, -0.07, 0.02, -0.05, 0.08]),\n            ]\n        }\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        R = case[\"R\"]\n        s_ts = np.array(case[\"s\"])\n        p_ref = np.array(case[\"p_ref\"])\n        candidates = case[\"candidates\"]\n        \n        # 1. Target Selection\n        \n        # Calculate correlations\n        computed_candidates = []\n        for p, x_ts_list in candidates:\n            x_ts = np.array(x_ts_list)\n            \n            # Per problem spec, if variance is zero, correlation is 0.\n            # np.std returns 0 for constant arrays.\n            if np.std(s_ts) == 0 or np.std(x_ts) == 0:\n                corr = 0.0\n            else:\n                corr = np.corrcoef(s_ts, x_ts)[0, 1]\n            \n            computed_candidates.append({'p': p, 'corr': corr})\n\n        # Find minimum correlation\n        min_corr = min(c['corr'] for c in computed_candidates)\n        \n        # Tie-breaking 1: Correlation within tolerance\n        epsilon = 1e-12\n        corr_tied_candidates = [c for c in computed_candidates if abs(c['corr'] - min_corr) = epsilon]\n        \n        # If no tie, the selection is done\n        if len(corr_tied_candidates) == 1:\n            p_t = corr_tied_candidates[0]['p']\n        else:\n            # Tie-breaking 2: Distance to reference\n            for c in corr_tied_candidates:\n                c['dist'] = np.linalg.norm(np.array(c['p']) - p_ref)\n            \n            min_dist = min(c['dist'] for c in corr_tied_candidates)\n            \n            dist_tied_candidates = [c for c in corr_tied_candidates if abs(c['dist'] - min_dist) = epsilon]\n            \n            if len(dist_tied_candidates) == 1:\n                p_t = dist_tied_candidates[0]['p']\n            else:\n                # Tie-breaking 3: Lexicographical order of coordinates\n                dist_tied_candidates.sort(key=lambda c: c['p'])\n                p_t = dist_tied_candidates[0]['p']\n        \n        p_t_vec = np.array(p_t, dtype=float)\n\n        # 2. Coil Placement Calculation\n        \n        # Scalp entry point\n        p_t_norm = np.linalg.norm(p_t_vec)\n        e = (R / p_t_norm) * p_t_vec\n        \n        # Outward normal\n        n = p_t_vec / p_t_norm\n        \n        # Coil orientation\n        a = np.array([0., 1., 0.])\n        t = a - np.dot(a, n) * n\n        \n        # Check for negligible tangent vector\n        if np.linalg.norm(t)  1e-9:\n            l = np.array([1., 0., 0.])\n            t = l - np.dot(l, n) * n\n            \n        t_hat = t / np.linalg.norm(t)\n        \n        tx, ty, tz = t_hat\n        \n        # Calculate angles\n        theta_yaw = np.arctan2(ty, tx) * (180 / np.pi)\n        theta_pitch = np.arctan2(tz, np.sqrt(tx**2 + ty**2)) * (180 / np.pi)\n        theta_roll = 0.0\n        \n        # Assemble results\n        result = [\n            p_t[0], p_t[1], p_t[2],\n            e[0], e[1], e[2],\n            theta_yaw, theta_pitch, theta_roll\n        ]\n        \n        all_results.append(result)\n        \n    # Format final output\n    case_strings = []\n    for res in all_results:\n        case_str = f\"[{','.join(f'{val:.3f}' for val in res)}]\"\n        case_strings.append(case_str)\n    \n    print(f\"[{','.join(case_strings)}]\")\n\nsolve()\n```", "id": "4754561"}]}