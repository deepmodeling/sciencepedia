{"hands_on_practices": [{"introduction": "现代测序技术产生了海量数据，但每个碱基的判读都伴随着不确定性，这种不确定性由Phred质量分数来量化。为了在某个特定基因组位点上做出可靠的“一致性”判断，我们必须综合来自多条测序读数（reads）的信息。这项实践练习 [@problem_id:4667814] 将引导您从第一性原理出发，通过贝叶斯推导来严谨地合并来自独立读数的证据，从而计算出一个稳健的一致性质控分数，这是所有基因组分析的基础。", "problem": "一个基因组流行病学团队使用新一代测序 (NGS) 来调查一个 RNA 病毒的疑似传播簇。在一个用于簇分配的单个位点上，$k$ 个独立的 NGS 读数都报告核苷酸为 $\\texttt{G}$。每个读数 $i \\in \\{1,\\dots,k\\}$ 都有一个由标准碱基识别程序产生的相关碱基质量得分 $Q_i$。Phred 质量得分被定义为碱基识别错误概率的对数度量，使得错误概率降低 10 倍会使质量得分增加 10 个单位，并且 $Q_i$ 是错误概率的单调递减函数。\n\n从这个定义和一个概率模型出发，其中：\n- 核苷酸字母表有四种状态 $\\{\\texttt{A},\\texttt{C},\\texttt{G},\\texttt{T}\\}$，\n- 真实核苷酸的先验分布在四种状态上是均匀的，\n- 每个读数的碱基识别错误在读数之间是独立的，\n- 当真实碱基不是 $\\texttt{G}$ 时，在发生错误的条件下，错误的报告在三个不正确的核苷酸上均匀分布，\n\n请从第一性原理推导，在给定观测数据的情况下，共有调用 $\\texttt{G}$ 的后验错误概率及其 Phred 标度的共有置信度的明确解析表达式。然后，对于 $k=5$ 个读数，其单个碱基质量得分分别为 $Q_1=30$、$Q_2=27$、$Q_3=35$、$Q_4=20$ 和 $Q_5=40$，并且都调用为 $\\texttt{G}$ 的情况，计算该表达式的值。\n\n将最终的共有 Phred 质量得分报告为单个实数。将您的答案四舍五入到四位有效数字。无需物理单位。", "solution": "问题是在给定一组新一代测序 (NGS) 读数及其相关质量得分的情况下，推导并计算核苷酸碱基调用的共有 Phred 质量得分。这需要使用贝叶斯方法。\n\n首先，我们形式化单个读数 $i$ 的 Phred 质量得分 $Q_i$ 与碱基识别错误概率 $p_{e,i}$ 之间的关系。问题陈述，错误概率降低 10 倍会使质量得分增加 10 个单位。这意味着一个对数关系。设错误概率为 $p_e$。质量得分 $Q$ 是 $p_e$ 的函数，记为 $Q(p_e)$。条件是 $Q(p_e/10) = Q(p_e) + 10$。这个函数方程的解形式为 $Q(p_e) = -10 \\log_{10}(p_e)$。我们可以验证这一点：$Q(p_e/10) = -10 \\log_{10}(p_e/10) = -10(\\log_{10}(p_e) - 1) = -10\\log_{10}(p_e) + 10 = Q(p_e) + 10$。\n根据此定义，具有质量得分 $Q_i$ 的读数 $i$ 的错误概率由下式给出：\n$$p_{e,i} = 10^{-Q_i/10}$$\n读数 $i$ 的正确调用概率是 $1 - p_{e,i}$。\n\n接下来，我们建立贝叶斯框架。设 $T$ 为基因组位点上真实核苷酸的随机变量，其取值范围为集合 $\\{\\texttt{A}, \\texttt{C}, \\texttt{G}, \\texttt{T}\\}$。设 $D$ 代表观测数据，它由 $k$ 个独立的读数组成，所有读数都报告核苷酸为 $\\texttt{G}$。我们将读数 $i$ 报告为 $\\texttt{G}$ 的事件表示为 $D_i$。因此，$D = \\{D_1, D_2, \\dots, D_k\\}$。\n\n目标是找到共有调用 $\\texttt{G}$ 的后验错误概率，即在给定数据 $D$ 的情况下，真实核苷酸不是 $\\texttt{G}$ 的概率。我们将其表示为 $P_{\\text{err, cons}} = P(T \\neq \\texttt{G} | D)$。这等于 $1 - P(T = \\texttt{G} | D)$。\n\n使用贝叶斯定理，真实碱基为 $\\texttt{G}$ 的后验概率是：\n$$P(T = \\texttt{G} | D) = \\frac{P(D | T = \\texttt{G}) P(T = \\texttt{G})}{P(D)}$$\n数据的边际概率 $P(D)$ 由全概率定律给出：\n$$P(D) = \\sum_{b \\in \\{\\texttt{A},\\texttt{C},\\texttt{G},\\texttt{T}\\}} P(D|T=b)P(T=b)$$\n问题指定了真实核苷酸的均匀先验：\n$$P(T=b) = \\frac{1}{4} \\quad \\text{for any } b \\in \\{\\texttt{A}, \\texttt{C}, \\texttt{G}, \\texttt{T}\\}$$\n\n现在，我们推导似然项 $P(D|T=b)$。由于读数是独立的，似然是每个读数概率的乘积：$P(D|T=b) = \\prod_{i=1}^{k} P(D_i|T=b)$。\n\n情况 1：真实核苷酸是 $\\texttt{G}$ ($T = \\texttt{G}$)。\n将读数 $i$ 观测为 $\\texttt{G}$ 的概率是正确调用的概率，即 $1 - p_{e,i}$。\n似然是：\n$$L_G = P(D | T = \\texttt{G}) = \\prod_{i=1}^{k} (1 - p_{e,i})$$\n\n情况 2：真实核苷酸不是 $\\texttt{G}$ (例如，$T = \\texttt{A}$)。\n将读数 $i$ 观测为 $\\texttt{G}$ 的概率是发生错误的概率。问题陈述，在发生错误的条件下，报告的碱基在三个不正确的选项上均匀分布。如果真实碱基是 $\\texttt{A}$，错误意味着读出 $\\texttt{C}$、$\\texttt{G}$ 或 $\\texttt{T}$。具体读出 $\\texttt{G}$ 的概率是总错误概率的 $1/3$。\n$$P(D_i | T = \\texttt{A}) = p_{e,i} \\times \\frac{1}{3} = \\frac{p_{e,i}}{3}$$\n根据对称性，$T = \\texttt{C}$ 和 $T = \\texttt{T}$ 的似然是相同的。我们把这个似然表示为 $L_{\\neg G}$。\n$$L_{\\neg G} = P(D | T = b \\neq \\texttt{G}) = \\prod_{i=1}^{k} \\frac{p_{e,i}}{3} = \\left(\\frac{1}{3}\\right)^k \\prod_{i=1}^{k} p_{e,i}$$\n\n现在我们可以写出后验错误概率：\n$$P_{\\text{err, cons}} = P(T \\neq \\texttt{G} | D) = \\frac{P(D | T \\neq \\texttt{G}) P(T \\neq \\texttt{G})}{P(D)}$$\n$$P(D | T \\neq \\texttt{G})P(T \\neq \\texttt{G}) = P(D|T=\\texttt{A})P(T=\\texttt{A}) + P(D|T=\\texttt{C})P(T=\\texttt{C}) + P(D|T=\\texttt{T})P(T=\\texttt{T})$$\n$$= L_{\\neg G} \\left(\\frac{1}{4}\\right) + L_{\\neg G} \\left(\\frac{1}{4}\\right) + L_{\\neg G} \\left(\\frac{1}{4}\\right) = 3 L_{\\neg G} \\left(\\frac{1}{4}\\right)$$\n总证据是 $P(D) = P(D|T=\\texttt{G})P(T=\\texttt{G}) + 3 L_{\\neg G} (1/4) = L_G(1/4) + 3L_{\\neg G}(1/4) = \\frac{1}{4}(L_G + 3L_{\\neg G})$。\n所以，后验错误概率是：\n$$P_{\\text{err, cons}} = \\frac{3 L_{\\neg G} (1/4)}{\\frac{1}{4}(L_G + 3L_{\\neg G})} = \\frac{3 L_{\\neg G}}{L_G + 3 L_{\\neg G}}$$\n这可以重写为：\n$$P_{\\text{err, cons}} = \\frac{1}{1 + \\frac{L_G}{3L_{\\neg G}}}$$\n共有 Phred 质量得分 $Q_{\\text{cons}}$ 的定义方式与单个读数的得分相同：\n$$Q_{\\text{cons}} = -10 \\log_{10}(P_{\\text{err, cons}}) = 10 \\log_{10}\\left(1 + \\frac{L_G}{3L_{\\neg G}}\\right)$$\n让我们代入 $L_G$ 和 $L_{\\neg G}$ 的表达式：\n$$\\frac{L_G}{3L_{\\neg G}} = \\frac{\\prod_{i=1}^{k} (1 - p_{e,i})}{3 \\left(\\frac{1}{3}\\right)^k \\prod_{i=1}^{k} p_{e,i}} = \\frac{\\prod_{i=1}^{k} (1 - p_{e,i})}{3^{1-k} \\prod_{i=1}^{k} p_{e,i}} = 3^{k-1} \\prod_{i=1}^{k} \\frac{1 - p_{e,i}}{p_{e,i}}$$\n使用关系式 $p_{e,i} = 10^{-Q_i/10}$，我们得到 $\\frac{1-p_{e,i}}{p_{e,i}} = \\frac{1 - 10^{-Q_i/10}}{10^{-Q_i/10}} = 10^{Q_i/10} - 1$。\n共有 Phred 得分的最终解析表达式是：\n$$Q_{\\text{cons}} = 10 \\log_{10}\\left(1 + 3^{k-1} \\prod_{i=1}^{k} (10^{Q_i/10} - 1)\\right)$$\n\n现在，我们为给定的数据计算这个表达式的值：$k=5$ 个读数，质量得分分别为 $Q_1=30$、$Q_2=27$、$Q_3=35$、$Q_4=20$ 和 $Q_5=40$。\n首先，我们为每个读数计算项 $(10^{Q_i/10} - 1)$：\n对于 $Q_1=30$: $10^{30/10} - 1 = 10^3 - 1 = 999$\n对于 $Q_2=27$: $10^{27/10} - 1 = 10^{2.7} - 1$\n对于 $Q_3=35$: $10^{35/10} - 1 = 10^{3.5} - 1$\n对于 $Q_4=20$: $10^{20/10} - 1 = 10^2 - 1 = 99$\n对于 $Q_5=40$: $10^{40/10} - 1 = 10^4 - 1 = 9999$\n\n乘积项是：\n$$\\prod_{i=1}^{5} (10^{Q_i/10} - 1) = (999) \\times (10^{2.7} - 1) \\times (10^{3.5} - 1) \\times (99) \\times (9999)$$\n当 $k=5$ 时，因子 $3^{k-1}$ 是 $3^{5-1} = 3^4 = 81$。\n将这些值代入 $Q_{\\text{cons}}$ 的表达式中：\n$$Q_{\\text{cons}} = 10 \\log_{10}\\left(1 + 81 \\times (999) \\times (10^{2.7} - 1) \\times (10^{3.5} - 1) \\times (99) \\times (9999) \\right)$$\n让我们计算对数的参数。\n$10^{2.7} \\approx 501.1872$\n$10^{3.5} \\approx 3162.2777$\n参数是 $1 + 81 \\times 999 \\times (501.1872 - 1) \\times (3162.2777 - 1) \\times 99 \\times 9999$。\n这大约是 $1 + 81 \\times 999 \\times 500.1872 \\times 3161.2777 \\times 99 \\times 9999 \\approx 1.26663 \\times 10^{17}$。\n由于这个值非常大，1 可以忽略不计。\n$Q_{\\text{cons}} \\approx 10 \\log_{10}(1.26663 \\times 10^{17})$\n$Q_{\\text{cons}} \\approx 10 \\times ( \\log_{10}(1.26663) + \\log_{10}(10^{17}) )$\n$Q_{\\text{cons}} \\approx 10 \\times (0.10264 + 17) = 10 \\times 17.10264 = 171.0264$\n\n为了更精确并避免中间过程的四舍五入：\n$\\log_{10}\\left(1 + 3^{k-1} \\prod (10^{Q_i/10}-1)\\right) \\approx \\log_{10}\\left(3^{k-1} \\prod (10^{Q_i/10}-1)\\right)$\n$= \\log_{10}(3^{k-1}) + \\sum_{i=1}^{k} \\log_{10}(10^{Q_i/10}-1)$\n对于 $k=5$:\n$= 4 \\log_{10}(3) + \\log_{10}(999) + \\log_{10}(10^{2.7}-1) + \\log_{10}(10^{3.5}-1) + \\log_{10}(99) + \\log_{10}(9999)$\n$\\approx 4(0.477121) + 2.999565 + 2.699140 + 3.499862 + 1.995635 + 3.999957$\n$\\approx 1.908485 + 15.194159 = 17.102644$\n共有得分是这个值的 10 倍：\n$Q_{\\text{cons}} \\approx 10 \\times 17.102644 = 171.02644$\n四舍五入到四位有效数字得到 $171.0$。", "answer": "$$\\boxed{171.0}$$", "id": "4667814"}, {"introduction": "在掌握了碱基层面的质量评估后，下一个挑战是如何从测序错误的背景噪音中分辨出真实的、特别是低频的基因变异（信号）。这项任务对于检测宿主内的病毒多样性或耐药突变至关重要。在本练习 [@problem_id:4667660] 中，您将基于二项分布建立一个统计模型来分析读数计数，并推导出一个能够控制假发现率（False Discovery Rate, FDR）的决策阈值，这是确保高通量数据分析可靠性的基石。", "problem": "一项针对克隆优势病毒病原体的深度测序实验，用于筛选整个基因组内的宿主内次要变异。在任何基因组位点，覆盖该位点的每条读数（read）由于测序错误而独立地报告一个非参考碱基的概率为 $\\epsilon$，并以 $1 - \\epsilon$ 的概率正确报告真实碱基。假设跨读数和位点的错误是独立的，位点特异性错误概率 $\\epsilon$ 是恒定的，并且每个位点的读数覆盖度恰好为 $C$ 条。\n\n一种变异检出规则规定，如果在 $C$ 条读数中观察到的非参考等位基因计数 $x$ 满足 $x \\geq k$（其中 $k$ 为某个整数阈值），则宣布该位点含有一个次要变异。假设在所有位点中，比例为 $r$ 的位点确实含有宿主内等位基因频率为 $p$ 的次要变异（在这些变异位点上 $p$ 是恒定的），而比例为 $1 - r$ 的位点确实是参考等位基因的单态位点。\n\n从独立性假设和二项分布的定义出发，推导在位点确实是单态的情况下，单位碱基错误率 $\\epsilon$ 和覆盖度 $C$ 如何共同决定在规则 $x \\geq k$ 下，每个位点出现假性变异检出的概率。然后，使用错误发现率（FDR）的定义（即在所有检出的位点中，错误检出的位点所占的预期比例），推导出 FDR 作为 $k$ 的函数的表达式，并计算出最小整数阈值 $k^{\\star}$，使得在以下科学上符合实际的参数值下，FDR 不超过目标水平 $\\alpha$：$\\epsilon = 1.0 \\times 10^{-3}$，$C = 200$，$r = 1.0 \\times 10^{-4}$，$p = 0.05$ 以及 $\\alpha = 0.05$。将你的最终答案表示为最小整数 $k^{\\star}$。因为阈值是整数，所以没有舍入要求。", "solution": "该问题被评估为有效，因为它在科学上基于基因组学和统计学的原理，问题提出得很好，提供了所有必要的信息，并且表述客观。\n\n该问题要求进行两个主要的推导，然后进行一次计算。首先，推导单个位点出现假性变异检出的概率。其次，推导变异检出规则的错误发现率（FDR）。最后，计算将 FDR 限制在指定水平 $\\alpha$ 以下的最小整数阈值 $k^{\\star}$。\n\n让我们对在基因组位点上观察到的非参考读数的数量进行建模。该实验包含 $C$ 次独立的试验（读数），每次试验可能产生一个参考碱基或非参考碱基。这是一个经典的伯努利过程，非参考读数的总数（我们用一个随机变量表示）将遵循二项分布。该分布的参数，即观察到非参考碱基的概率，取决于该位点是真正的单态位点还是含有变异。\n\n**第一部分：单个位点假性变異检出的概率**\n\n假性变异检出，也称为假阳性（FP），发生在一个真正的单态位点（即只包含参考等位基因）被宣布含有次要变异时。\n\n对于一个真正的单态位点，真实的碱基是参考等位基因。只有由于测序错误，才会在一条读数中观察到非参考碱基。问题陈述这发生的概率为 $\\epsilon$。因此，对于覆盖该位点的 $C$ 条读数中的每一条，观察到非参考碱基的概率是 $\\epsilon$。\n\n设 $X$ 是表示在一个真正的单态位点上非参考读数数量的随机变量。由于读数是独立的，$X$ 遵循一个二项分布，其参数为 $C$（试验次数）和 $\\epsilon$（成功概率，即观察到非参考等位基因的概率）。我们将其写作 $X \\sim \\text{Bin}(C, \\epsilon)$。\n\n变异检出规则规定，如果观察到的非参考计数 $x$ 大于或等于阈值 $k$，即 $x \\geq k$，则宣布该位点为变异位点。如果在单态位点上满足此规则，则产生一次假性检出。因此，单个位点假性变异检出的概率为 $P(X \\geq k)$。\n\n这个概率是观察到恰好 $i$ 条非参考读数的概率之和，其中 $i$ 从 $k$ 到 $C$：\n$$P(\\text{False Call}) = P(X \\geq k) = \\sum_{i=k}^{C} P(X=i)$$\n使用二项分布的概率质量函数 $P(X=i) = \\binom{C}{i} \\epsilon^i (1-\\epsilon)^{C-i}$，我们得到单个位点假性变异检出概率的表达式：\n$$P(\\text{False Call}) = \\sum_{i=k}^{C} \\binom{C}{i} \\epsilon^i (1-\\epsilon)^{C-i}$$\n\n**第二部分：错误发现率（FDR）的推导**\n\n错误发现率（FDR）定义为在所有发现（所有阳性检出）中，错误发现（假阳性）的预期比例。让我们用 $D$ 表示被检出为变异的位点数。设假阳性检出数为 $FP$，真阳性检出数为 $TP$。那么 $D = FP + TP$。FDR 定义为：\n$$\\text{FDR} = E\\left[\\frac{FP}{D}\\right | D>0] P(D>0)$$\n在大规模检验的常见假设下，这可以近似为：\n$$\\text{FDR} \\approx \\frac{E[FP]}{E[D]} = \\frac{E[FP]}{E[FP] + E[TP]}$$\n\n为了计算 $FP$ 和 $TP$ 的期望数量，我们考虑大量的位点，比如说 $N_{total}$ 个。\n这些位点中有 $1-r$ 的比例是真正的单态位点。$FP$ 的期望数量是单态位点的数量乘以在每个这样的位点上做出假性检出的概率。\n$$E[FP] = N_{total} (1-r) P(X \\geq k) \\quad \\text{where } X \\sim \\text{Bin}(C, \\epsilon)$$\n\n比例为 $r$ 的位点确实含有频率为 $p$ 的次要变异。在这些位点上，可以通过两种互斥的方式观察到非参考读数：\n1. 读数采样到真实的变异等位基因（概率为 $p$），并且测序仪没有出错（概率为 $1-\\epsilon$）。\n2. 读数采样到参考等位基因（概率为 $1-p$），并且测序仪出错，报告了一个非参考碱基（概率为 $\\epsilon$）。\n\n因此，在真实变异位点观察到非参考碱基的总概率，我们称之为 $p_{\\text{obs}}$，是：\n$$p_{\\text{obs}} = p(1-\\epsilon) + (1-p)\\epsilon = p - p\\epsilon + \\epsilon - p\\epsilon = p + \\epsilon(1-2p)$$\n设 $Y$ 是在真实变异位点上非参考读数数量的随机变量。$Y$ 遵循二项分布 $Y \\sim \\text{Bin}(C, p_{\\text{obs}})$。\n\n当一个真实的变异位点被正确地检出为变异时，就产生一个真阳性（TP）。其概率为 $P(Y \\geq k)$。\n$$P(\\text{True Call}) = P(Y \\geq k) = \\sum_{i=k}^{C} \\binom{C}{i} p_{\\text{obs}}^i (1-p_{\\text{obs}})^{C-i}$$\n$TP$ 的期望数量是真实变异位点的数量乘以真性检出的概率。\n$$E[TP] = N_{total} \\, r \\, P(Y \\geq k) \\quad \\text{where } Y \\sim \\text{Bin}(C, p_{\\text{obs}})$$\n\n将这些代入 FDR 公式中，$N_{total}$ 项会消掉：\n$$\\text{FDR}(k) = \\frac{(1-r) P(X \\geq k)}{(1-r) P(X \\geq k) + r P(Y \\geq k)}$$\n代入二项概率和，得到 FDR 作为 $k$ 的函数的最终表达式：\n$$\\text{FDR}(k) = \\frac{(1-r) \\sum_{i=k}^{C} \\binom{C}{i} \\epsilon^i (1-\\epsilon)^{C-i}}{(1-r) \\sum_{i=k}^{C} \\binom{C}{i} \\epsilon^i (1-\\epsilon)^{C-i} + r \\sum_{i=k}^{C} \\binom{C}{i} p_{\\text{obs}}^i (1-p_{\\text{obs}})^{C-i}}$$\n\n**第三部分：最小阈值 $k^{\\star}$ 的计算**\n\n我们得到的参数值为：$\\epsilon = 1.0 \\times 10^{-3}$，$C = 200$，$r = 1.0 \\times 10^{-4}$，$p = 0.05$，以及目标 FDR $\\alpha = 0.05$。\n首先，我们计算 $p_{\\text{obs}}$：\n$$p_{\\text{obs}} = 0.05 + 0.001(1 - 2 \\times 0.05) = 0.05 + 0.001(0.9) = 0.0509$$\n我们需要找到最小的整数 $k$，使得 $\\text{FDR}(k) \\leq 0.05$。\n设 $P_{FP}(k) = P(X \\geq k)$，其中 $X \\sim \\text{Bin}(200, 0.001)$，以及 $P_{TP}(k) = P(Y \\geq k)$，其中 $Y \\sim \\text{Bin}(200, 0.0509)$。\nFDR 的表达式变为：\n$$\\text{FDR}(k) = \\frac{(1-10^{-4}) P_{FP}(k)}{(1-10^{-4}) P_{FP}(k) + 10^{-4} P_{TP}(k)}$$\n$\\text{FDR}(k)$ 项是 $k$ 的一个单调非增函数。我们可以通过从 $1$ 开始测试 $k$ 的整数值来找到最小的 $k^{\\star}$。\n\n对于 $k=4$：\n$P_{FP}(4) = \\sum_{i=4}^{200} \\binom{200}{i} (0.001)^i (0.999)^{200-i} \\approx 5.8407 \\times 10^{-5}$\n$P_{TP}(4) = \\sum_{i=4}^{200} \\binom{200}{i} (0.0509)^i (0.9491)^{200-i} \\approx 0.99843$\n$$\\text{FDR}(4) = \\frac{0.9999 \\times 5.8407 \\times 10^{-5}}{0.9999 \\times 5.8407 \\times 10^{-5} + 0.0001 \\times 0.99843} \\approx \\frac{5.8401 \\times 10^{-5}}{5.8401 \\times 10^{-5} + 9.9843 \\times 10^{-5}} = \\frac{5.8401}{15.8244} \\approx 0.36906$$\n由于 $0.36906 > 0.05$，阈值 $k=4$ 不够严格。\n\n对于 $k=5$：\n$P_{FP}(5) = \\sum_{i=5}^{200} \\binom{200}{i} (0.001)^i (0.999)^{200-i} \\approx 2.3426 \\times 10^{-6}$\n$P_{TP}(5) = \\sum_{i=5}^{200} \\binom{200}{i} (0.0509)^i (0.9491)^{200-i} \\approx 0.99264$\n$$\\text{FDR}(5) = \\frac{0.9999 \\times 2.3426 \\times 10^{-6}}{0.9999 \\times 2.3426 \\times 10^{-6} + 0.0001 \\times 0.99264} \\approx \\frac{2.3424 \\times 10^{-6}}{2.3424 \\times 10^{-6} + 9.9264 \\times 10^{-5}} = \\frac{2.3424}{101.6064} \\approx 0.02305$$\n由于 $0.02305 \\leq 0.05$，阈值 $k=5$ 满足要求。\n\n由于 $\\text{FDR}(4) > 0.05$ 且 $\\text{FDR}(5) \\leq 0.05$，确保 FDR 不超过 $0.05$ 的最小整数阈值 $k^{\\star}$ 是 $5$。", "answer": "$$\\boxed{5}$$", "id": "4667660"}, {"introduction": "一旦我们能够可靠地鉴定出基因变异，就可以利用这些信息来揭示病原体的流行病学历史。贝叶斯天际线图（Bayesian skyline plot）是一种强大的系统发育动力学工具，它能从基因谱系中重建有效群体大小（$N_e(t)$）随时间的变化。这项实践 [@problem_id:4667746] 将通过让您从溯祖等待时间中推导 $N_e(t)$ 的后验分布，来揭示该方法的内在机制，从而使您对如何从基因组数据推断群体动态有一个坚实的理解。", "problem": "给定一个在标准溯祖模型下采样的、有根的、严格二分的系统发育树，您将获得其 coalescent 间期等待时间和相应的谱系数量。假设有效种群大小函数 $N_e(t)$ 是分段恒定的，并按连续的 coalescent 间期进行分组。在每个组 $g$ 内，有效种群大小是恒定的，等于 $N_{e,g}$。\n\n基本和建模假设：\n- 在具有分段恒定种群大小的标准溯祖模型下，当区间 $i$ 属于组 $g$ 时，每个具有 $k_i$ 个共存谱系的 coalescent 间期等待时间 $t_i$ 服从指数分布，其风险率 (hazard rate) 为 $h_i = \\binom{k_i}{2}/N_{e,g}$。\n- 令 $\\lambda_g = 1/N_{e,g}$。那么，组 $g$ 中一个区间 $i$ 的似然贡献是指数分布，其率为 $r_i = \\lambda_g \\binom{k_i}{2}$，在给定组常数的情况下，各区间之间相互独立。\n- 对每个组 $g$ 的 $\\lambda_g$ 采用共轭先验：形状参数为 $a_g$、率参数为 $b_g$ 的伽马分布 (Gamma distribution)，记为 $\\lambda_g \\sim \\mathrm{Gamma}(a_g,b_g)$，其密度正比于 $\\lambda_g^{a_g - 1} \\exp(-b_g \\lambda_g)$。\n- 每个组 $g$ 的充分统计量是 coalescent 间期数量 $m_g$ 和缩放后的时间总和 $S_g = \\sum_{i \\in g} \\binom{k_i}{2} t_i$。\n\n您的任务是通过推导 $\\lambda_g$ 的后验分布，然后转换为 $N_{e,g} = 1/\\lambda_g$，来计算每个组 $g$ 的 $N_{e,g}$ 的贝叶斯天际线图 (Bayesian skyline) 摘要。对于每个组 $g$，计算：\n- $N_{e,g}$ 的后验均值。\n- $N_{e,g}$ 的后验中位数。\n- $N_{e,g}$ 的中心 $95\\%$ 水平可信区间的下限和上限，即 $0.025$ 和 $0.975$ 的后验分位数。\n\n将所有 $N_{e,g}$ 的输出表示为实数（个体计数，一个无量纲的量），四舍五入到六位小数。$t_i$ 的时间单位是年；输出中不应打印任何时间单位。\n\n从上述基本假设推导您的方法。不要使用或假设任何不是这些假设直接结果的公式。\n\n测试套件。对于每个测试用例，您将获得：\n- 以年为单位的 coalescent 间期时间列表 $\\{t_i\\}$。\n- 长度相同的谱系数量列表 $\\{k_i\\}$，其中 $k_i \\ge 2$ 且 $t_i \\ge 0$。\n- 一个正整数列表，指定了连续划分区间序列的组大小。\n- 各组共享的先验超参数：形状参数 $a$ 和率参数 $b$。\n\n计算每个测试用例中每个组的贝叶斯天际线图摘要。测试用例如下：\n\n- 测试用例 1：\n  - $t = [0.05, 0.12, 0.08, 0.20, 0.30, 0.25]$\n  - $k = [10, 9, 8, 7, 6, 5]$\n  - 组大小 $= [2, 2, 2]$\n  - 先验 $(a, b) = (2.5, 1.0)$\n\n- 测试用例 2：\n  - $t = [0.02, 0.02, 0.02, 0.02]$\n  - $k = [50, 49, 48, 47]$\n  - 组大小 $= [1, 1, 2]$\n  - 先验 $(a, b) = (2.1, 0.5)$\n\n- 测试用例 3：\n  - $t = [0.30, 0.25, 0.35, 0.40]$\n  - $k = [6, 5, 4, 3]$\n  - 组大小 $= [4]$\n  - 先验 $(a, b) = (1.5, 1.0)$\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每个元素对应一个测试用例。每个测试用例元素是一个组的列表，每个组元素是一个包含四个数字的列表，顺序为[后验均值, 后验中位数, $0.025$ 分位数, $0.975$ 分位数]，每个数字四舍五入到六位小数。例如，一个有效的结构形状是：\n  - $[\\,[\\,[x_{11}, x_{12}, x_{13}, x_{14}], [x_{21}, x_{22}, x_{23}, x_{24}], \\ldots], \\; [\\ldots], \\; [\\ldots]\\,]$\n\n在您的书面解决方案中，请从基本假设出发解释推导过程，并讨论分段恒定 $N_e(t)$ 的可识别性，包括 $m_g$ 和 $S_g$ 如何约束推断，以及某个片段信息非常有限或没有信息时的边缘情况。", "solution": "该问题要求在贝叶斯框架内计算分段恒定有效种群大小 $N_e(t)$ 的后验摘要统计量。该方法论源于标准溯祖模型的基本假设、coalescent 间期等待时间的指数似然以及精度参数 $\\lambda_g = 1/N_{e,g}$ 上的共轭伽马先验。\n\n推导过程分为三个主要阶段：\n1.  推导每个种群大小组 $g$ 的参数 $\\lambda_g$ 的后验分布。\n2.  将后验分布从 $\\lambda_g$ 转换为有效种群大小 $N_{e,g}$。\n3.  从 $N_{e,g}$ 的后验分布中计算所需的摘要统计量（均值、中位数和 $95\\%$ 可信区间）。\n\n### 1. $\\lambda_g$ 的后验分布\n\n根据贝叶斯定理，后验概率分布正比于似然和先验概率分布的乘积。\n$$P(\\lambda_g | \\text{data}) \\propto P(\\text{data} | \\lambda_g) \\times P(\\lambda_g)$$\n\n**似然函数：**\n问题陈述，对于组 $g$ 内的一个区间 $i$，具有 $k_i$ 个谱系的 coalescent 间期等待时间 $t_i$ 服从指数分布，其率为 $r_i = \\lambda_g \\binom{k_i}{2}$。单个区间的概率密度函数 (PDF) 为：\n$$P(t_i | \\lambda_g, k_i) = \\lambda_g \\binom{k_i}{2} \\exp\\left( -\\lambda_g \\binom{k_i}{2} t_i \\right)$$\n假设在给定 $\\lambda_g$ 的条件下，等待时间是条件独立的，则组 $g$ 中数据（包含 $m_g$ 个区间）的总似然是各个 PDF 的乘积：\n$$L(\\lambda_g) = P(\\{t_i, k_i\\}_{i \\in g} | \\lambda_g) = \\prod_{i \\in g} P(t_i | \\lambda_g, k_i)$$\n$$L(\\lambda_g) = \\prod_{i \\in g} \\left[ \\lambda_g \\binom{k_i}{2} \\exp\\left( -\\lambda_g \\binom{k_i}{2} t_i \\right) \\right]$$\n我们可以将涉及 $\\lambda_g$ 的项组合在一起：\n$$L(\\lambda_g) = \\left( \\prod_{i \\in g} \\binom{k_i}{2} \\right) \\left( \\prod_{i \\in g} \\lambda_g \\right) \\exp\\left( -\\sum_{i \\in g} \\lambda_g \\binom{k_i}{2} t_i \\right)$$\n$$L(\\lambda_g) = \\left( \\prod_{i \\in g} \\binom{k_i}{2} \\right) \\lambda_g^{m_g} \\exp\\left( -\\lambda_g \\sum_{i \\in g} \\binom{k_i}{2} t_i \\right)$$\n项 $\\prod_{i \\in g} \\binom{k_i}{2}$ 是一个关于 $\\lambda_g$ 的常数。使用给定的充分统计量 $S_g = \\sum_{i \\in g} \\binom{k_i}{2} t_i$，似然正比于：\n$$L(\\lambda_g) \\propto \\lambda_g^{m_g} \\exp(-\\lambda_g S_g)$$\n这是似然函数的核。\n\n**先验分布：**\n问题指定了 $\\lambda_g$ 的共轭伽马先验：\n$$\\lambda_g \\sim \\mathrm{Gamma}(a_g, b_g)$$\n其 PDF 为 $P(\\lambda_g) \\propto \\lambda_g^{a_g - 1} \\exp(-b_g \\lambda_g)$，其中 $a_g$ 是形状参数，$b_g$ 是率参数。\n\n**后验分布：**\n将似然核与先验密度核相乘，得到后验密度核：\n$$P(\\lambda_g | \\text{data}) \\propto \\left( \\lambda_g^{m_g} \\exp(-\\lambda_g S_g) \\right) \\times \\left( \\lambda_g^{a_g - 1} \\exp(-b_g \\lambda_g) \\right)$$\n$$P(\\lambda_g | \\text{data}) \\propto \\lambda_g^{a_g + m_g - 1} \\exp\\left( -(b_g + S_g) \\lambda_g \\right)$$\n这是一个具有更新后参数的伽马分布的核。设后验参数为 $a'_g = a_g + m_g$ 和 $b'_g = b_g + S_g$。\n因此，$\\lambda_g$ 的后验分布是：\n$$\\lambda_g | \\text{data} \\sim \\mathrm{Gamma}(a_g + m_g, b_g + S_g)$$\n\n### 2. $N_{e,g}$ 的后验分布\n\n有效种群大小 $N_{e,g}$ 是 $\\lambda_g$ 的倒数，即 $N_{e,g} = 1/\\lambda_g$。如果一个随机变量 $X$ 服从伽马分布，$X \\sim \\mathrm{Gamma}(\\alpha, \\beta)$，那么它的倒数 $Y=1/X$ 服从逆伽马分布 (Inverse-Gamma distribution)，其形状参数为 $\\alpha$，尺度参数为 $\\beta$（伽马分布的率参数成为逆伽马分布的尺度参数）。\n因此，$N_{e,g}$ 的后验分布是一个逆伽马分布：\n$$N_{e,g} | \\text{data} \\sim \\mathrm{InverseGamma}(a'_g, b'_g) = \\mathrm{InverseGamma}(a_g + m_g, b_g + S_g)$$\n\n### 3. $N_{e,g}$ 的后验摘要统计量\n\n我们现在可以从这个后验 $\\mathrm{InverseGamma}(a'_g, b'_g)$ 分布中计算所需的统计量。\n\n**后验均值：**\n逆伽马分布 $\\mathrm{InverseGamma}(\\alpha, \\beta)$ 的期望值是 $E[Y] = \\frac{\\beta}{\\alpha - 1}$，定义于 $\\alpha > 1$。\n在我们的情况下，$N_{e,g}$ 的后验均值为：\n$$E[N_{e,g} | \\text{data}] = \\frac{b'_g}{a'_g - 1} = \\frac{b_g + S_g}{a_g + m_g - 1}$$\n条件 $a'_g > 1$ 对所有测试用例都满足，因为给定的先验形状参数 $a$ 大于 $1$，且每组的区间数 $m_g$ 至少为 $1$。\n\n**后验中位数与可信区间：**\n这些统计量从后验分布的分位数推导而来。伽马分布的分位数与其对应的逆伽马分布的分位数之间有直接关系。设 $Q_Y(p)$ 是 $Y \\sim \\mathrm{InverseGamma}(\\alpha, \\beta)$ 的第 $p$ 分位数，$Q_X(p)$ 是 $X \\sim \\mathrm{Gamma}(\\alpha, \\beta)$ 的第 $p$ 分位数。它们的关系是：\n$$Q_Y(p) = \\frac{1}{Q_X(1-p)}$$\n我们应用这个关系来找到 $N_{e,g}$ 的中位数（第 $50$ 百分位数）和 $95\\%$ 中心可信区间（端点在第 $2.5$ 和第 $97.5$ 百分位数）。令 $Q_{\\lambda_g}(p)$ 表示后验分布 $\\lambda_g | \\text{data} \\sim \\mathrm{Gamma}(a'_g, b'_g)$ 的第 $p$ 分位数。\n\n-   **后验中位数 ($p=0.5$):**\n    $$\\text{Median}[N_{e,g}] = Q_{N_{e,g}}(0.5) = \\frac{1}{Q_{\\lambda_g}(1-0.5)} = \\frac{1}{Q_{\\lambda_g}(0.5)}$$\n-   **可信区间下限 ($p=0.025$):**\n    $$Q_{N_{e,g}}(0.025) = \\frac{1}{Q_{\\lambda_g}(1-0.025)} = \\frac{1}{Q_{\\lambda_g}(0.975)}$$\n-   **可信区间上限 ($p=0.975$):**\n    $$Q_{N_{e,g}}(0.975) = \\frac{1}{Q_{\\lambda_g}(1-0.975)} = \\frac{1}{Q_{\\lambda_g}(0.025)}$$\n\n伽马分布的这些分位数没有封闭形式的表达式，必须通过数值计算得出，为此可使用像 `scipy.stats` 这样的科学计算库。\n\n### 关于可识别性的讨论\n后验参数 $a'_g = a_g + m_g$ 和 $b'_g = b_g + S_g$ 明确显示了由充分统计量 $m_g$ 和 $S_g$ 总结的数据如何更新编码在 $a_g$ 和 $b_g$ 中的先验信念。对于给定片段，种群大小 $N_{e,g}$ 的可识别性取决于该片段内数据的信息含量。\n-   统计量 $m_g$，即组 $g$ 中的 coalescent 事件数量，为后验分布的形状提供了信息。较大的 $m_g$ 会导致后验形状参数 $a'_g$ 主要由数据决定，使得推断对先验形状 $a_g$ 的敏感性降低。\n-   统计量 $S_g = \\sum_{i \\in g} \\binom{k_i}{2} t_i$，即每个等待时间按谱系对数量缩放后的总和，为后验分布的率/尺度参数提供了信息。较大的 $S_g$ 值（表示较长的等待时间）将主导先验率 $b_g$，将 $\\lambda_g$ 的后验分布拉向较小的值，从而使 $N_{e,g}$ 的后验分布趋向于较大的值。\n-   **边缘情况：** 如果一个组包含的信息非常少（例如，$m_g$ 很小，或者所有 $t_i$ 都非常短，导致 $S_g$ 很小），后验分布将会很宽（方差大），并且严重受到先验选择（$a_g, b_g$）的影响。在这种情况下，$N_{e,g}$ 是弱可识别的。相反，当 $m_g$ 和 $S_g$ 很大时，似然会主导先验，后验分布变得非常集中，$N_{e,g}$ 由数据强可识别。问题设置确保所有组的 $m_g \\ge 1$，因此参数在技术上总是可识别的，但估计的精度随数据内容而变化。", "answer": "[[[2.162857,1.933385,0.893118,5.094595],[2.125714,1.900139,0.877770,4.993718],[2.285714,2.043285,0.943924,5.370775]],[[11.833333,10.428795,3.655977,34.004126],[11.023810,9.715372,3.405786,31.488661],[11.597561,10.518605,5.176435,23.364230]],[[3.011111,2.766343,1.258286,6.223847]]]", "id": "4667746"}]}