{"hands_on_practices": [{"introduction": "有效的监测是打破传染链的关键环节，但诊断测试的效用并非一成不变。本练习将引导您运用基础概率论，推导阳性预测值（PPV）和阴性预测值（NPV）的表达式，并分析它们在不同疾病流行率（$\\pi$）下的表现[@problem_id:4656255]。通过这个过程，您将深刻理解为何筛查策略的有效性，尤其是在低患病率地区，会受到根本性的制约。", "problem": "某个群体正在接受针对特定传染原的社区筛查，旨在通过及时隔离真正具有传染性的个体来减少后续传播。设$\\pi$表示筛查时群体中当前感染的患病率，即$\\pi = \\mathsf{P}(\\text{感染})$。该筛查检测的灵敏度为$Se = \\mathsf{P}(\\text{检测阳性} \\mid \\text{感染})$，特异度为$Sp = \\mathsf{P}(\\text{检测阴性} \\mid \\text{未感染})$。检测结果为阳性将触发隔离，而阴性结果则允许个体继续参与社区活动。\n\n从灵敏度、特异度和患病率的核心定义出发，结合贝叶斯定理和全概率定律，推导阳性预测值 (PPV)（定义为 $\\mathsf{P}(\\text{感染} \\mid \\text{检测阳性})$）和阴性预测值 (NPV)（定义为 $\\mathsf{P}(\\text{未感染} \\mid \\text{检测阴性})$）关于$Se$、$Sp$和$\\pi$的闭式解析表达式。\n\n然后，从基本原理出发，论证当$\\pi$变得很小时，这些表达式的极限行为如何限制了一次性筛查在低患病率情境下打破感染链（病原体、传染源、排出门户、传播途径、侵入门户、易感宿主）的效用，并特别关注在隔离决策背景下的假阳性和假阴性问题。以PPV和NPV的解析表达式对的形式提供最终答案。无需进行数值评估或四舍五入，也无需单位，因为这些是表示为小数或分数的概率。", "solution": "该问题要求推导筛查检测的阳性预测值 (PPV) 和阴性预测值 (NPV)，然后分析此种筛查在低患病率情境下的效用。推导将基于概率论的基本原理，即贝叶斯定理和全概率定律。\n\n设$I$为个体感染事件，$D$为个体未感染事件。设$T_+$为检测结果阳性事件，$T_-$为检测结果阴性事件。给定的参数如下：\n- 患病率：$\\pi = \\mathsf{P}(I)$\n- 灵敏度：$Se = \\mathsf{P}(T_+ \\mid I)$\n- 特异度：$Sp = \\mathsf{P}(T_- \\mid D)$\n\n根据这些定义，我们可以陈述其互补事件的概率：\n- $\\mathsf{P}(D) = 1 - \\mathsf{P}(I) = 1 - \\pi$\n- 假阴性概率：$\\mathsf{P}(T_- \\mid I) = 1 - \\mathsf{P}(T_+ \\mid I) = 1 - Se$\n- 假阳性概率：$\\mathsf{P}(T_+ \\mid D) = 1 - \\mathsf{P}(T_- \\mid D) = 1 - Sp$\n\n**阳性预测值 (PPV) 的推导**\n\nPPV定义为在检测结果为阳性的条件下，个体确实感染的概率。\n$$\n\\text{PPV} = \\mathsf{P}(I \\mid T_+)\n$$\n应用贝叶斯定理 $\\mathsf{P}(A \\mid B) = \\frac{\\mathsf{P}(B \\mid A)\\mathsf{P}(A)}{\\mathsf{P}(B)}$，我们得到：\n$$\n\\text{PPV} = \\frac{\\mathsf{P}(T_+ \\mid I) \\mathsf{P}(I)}{\\mathsf{P}(T_+)}\n$$\n分子是灵敏度与患病率的乘积：$\\mathsf{P}(T_+ \\mid I) \\mathsf{P}(I) = Se \\cdot \\pi$。\n\n分母 $\\mathsf{P}(T_+)$ 是群体中检测结果为阳性的总概率。我们使用全概率定律展开此项：\n$$\n\\mathsf{P}(T_+) = \\mathsf{P}(T_+ \\mid I)\\mathsf{P}(I) + \\mathsf{P}(T_+ \\mid D)\\mathsf{P}(D)\n$$\n代入已知量：\n$$\n\\mathsf{P}(T_+) = (Se \\cdot \\pi) + ((1 - Sp) \\cdot (1 - \\pi))\n$$\n此项代表真阳性（来自感染组）与假阳性（来自未感染组）之和。\n\n将展开的分母代回PPV的表达式，得到最终的闭式解析表达式：\n$$\n\\text{PPV} = \\frac{Se \\cdot \\pi}{Se \\cdot \\pi + (1 - Sp)(1 - \\pi)}\n$$\n\n**阴性预测值 (NPV) 的推导**\n\nNPV定义为在检测结果为阴性的条件下，个体确实未感染的概率。\n$$\n\\text{NPV} = \\mathsf{P}(D \\mid T_-)\n$$\n应用贝叶斯定理：\n$$\n\\text{NPV} = \\frac{\\mathsf{P}(T_- \\mid D) \\mathsf{P}(D)}{\\mathsf{P}(T_-)}\n$$\n分子是特异度与未感染率的乘积：$\\mathsf{P}(T_- \\mid D) \\mathsf{P}(D) = Sp \\cdot (1 - \\pi)$。\n\n分母 $\\mathsf{P}(T_-)$ 是检测结果为阴性的总概率。我们使用全概率定律展开此项：\n$$\n\\mathsf{P}(T_-) = \\mathsf{P}(T_- \\mid I)\\mathsf{P}(I) + \\mathsf{P}(T_- \\mid D)\\mathsf{P}(D)\n$$\n代入已知量：\n$$\n\\mathsf{P}(T_-) = ((1 - Se) \\cdot \\pi) + (Sp \\cdot (1 - \\pi))\n$$\n此项代表假阴性（来自感染组）与真阴性（来自未感染组）之和。\n\n将展开的分母代回NPV的表达式，得到最终的闭式解析表达式：\n$$\n\\text{NPV} = \\frac{Sp \\cdot (1 - \\pi)}{(1 - Se)\\pi + Sp(1 - \\pi)}\n$$\n\n**低患病率情境下极限行为的分析**\n\n我们现在分析当患病率$\\pi$趋近于零时（即$\\pi \\to 0$），PPV和NPV的行为。\n\n对于PPV：\n$$\n\\lim_{\\pi \\to 0} \\text{PPV} = \\lim_{\\pi \\to 0} \\frac{Se \\cdot \\pi}{Se \\cdot \\pi + (1 - Sp)(1 - \\pi)}\n$$\n当$\\pi \\to 0$时，分子$Se \\cdot \\pi \\to 0$。分母趋近于$Se \\cdot 0 + (1 - Sp)(1 - 0) = 1 - Sp$。\n假设特异度$Sp$小于1（即检测不完美，存在非零的假阳性率），则分母$1 - Sp$是一个正常数。因此，极限为：\n$$\n\\lim_{\\pi \\to 0} \\text{PPV} = \\frac{0}{1 - Sp} = 0\n$$\n这一结果具有深刻的启示。随着患病率下降，阳性检测结果反映真实感染的概率趋近于零。这意味着，在低患病率情境下，绝大多数阳性结果都是假阳性。基于单一阳性检测结果的隔离决策将导致大量未感染个体被隔离。这种策略无法有效地针对感染链中的实际传染“传染源”，在公共卫生收益甚微的情况下，却造成了高昂的社会和经济成本。假阳性与真阳性的比率，由$\\frac{(1-\\pi)(1-Sp)}{\\pi Se}$给出，当$\\pi \\to 0$时发散至无穷大，这从数学上证明了为何PPV会趋近于零。\n\n对于NPV：\n$$\n\\lim_{\\pi \\to 0} \\text{NPV} = \\lim_{\\pi \\to 0} \\frac{Sp \\cdot (1 - \\pi)}{(1 - Se)\\pi + Sp(1 - \\pi)}\n$$\n当$\\pi \\to 0$时，分子趋近于$Sp \\cdot (1 - 0) = Sp$。分母趋近于$(1 - Se) \\cdot 0 + Sp \\cdot (1 - 0) = Sp$。\n假设$Sp  0$，则极限为：\n$$\n\\lim_{\\pi \\to 0} \\text{NPV} = \\frac{Sp}{Sp} = 1\n$$\n这表明，随着患病率下降，阴性检测结果成为一个极其可靠的指标，表明该个体未被感染。在检测结果为阴性的人群中出现“假阴性”的概率，由$1 - \\text{NPV}$给出，趋近于零。\n\n**关于打破感染链效用的结论**\n\nPPV和NPV的极限行为限制了一次性筛查在低患病率情境下的效用。\n1.  **低PPV（假阳性）带来的限制：** 隔离的主要目标是从群体中移除传染“传染源”，以打破“传播途径”。当PPV趋近于零时，筛查在完成这项任务时变得非常低效。信号（真阳性）被噪声（假阳性）所淹没。依赖单一阳性检测结果来做出隔离决策是不可行的，因为它会导致将健康个体错误地归类为传染源的一部分。\n\n2.  **高NPV（假阴性）带来的效用：** 相反，在这种情境下，筛查的效用发生了转变。当NPV趋近于1时，该检测在证明个体未感染方面非常有效。这使得绝大多数人口可以自信地继续活动，从而最大限度地减少了对那些不对“易感宿主”构成风险的人的干扰。然而，必须认识到，即使NPV很高，仍会存在一些假阴性。检测结果为阴性但被漏掉的感染者绝对数量与$N \\cdot \\pi \\cdot (1-Se)$成正比，其中$N$是人口规模。尽管这个数字可能很小，但如果病原体传染性很强，这些未被发现的传染源成员重新进入社区，仍然可以维持传播。\n\n总而言之，在低患病率情境下，一次性筛查是识别感染个体的拙劣工具，却是排除感染的绝佳工具。因此，其效用是受限的；它对于“排除”健康的多数人很有用，但对于“发现”患病的少数人则不可靠。这要求在实施隔离等限制性措施之前，采取多阶段检测（例如，使用高特异度的确认性检测）等策略来提高PPV。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{Se \\cdot \\pi}{Se \\cdot \\pi + (1 - Sp)(1 - \\pi)}  \\frac{Sp \\cdot (1 - \\pi)}{(1 - Se)\\pi + Sp(1 - \\pi)}\n\\end{pmatrix}\n}\n$$", "id": "4656255"}, {"introduction": "传染性的时间动态是决定传播动力学的关键，而症状前传播对公共卫生控制措施构成了巨大挑战。本练习提供了一个定量框架，用于计算在症状出现前发生的传播所占的比例[@problem_id:4656311]。通过完成这一计算，您将更深入地理解病原体的传染性特征（即传染链中的“病原体”和“排出门户”环节）如何直接影响隔离和接触者追踪策略的制定。", "problem": "考虑一种急性呼吸道感染，其在感染链框架下具有以下特征：宿主的潜伏期（从感染到症状出现的时间）是随机的，并遵循参数为 $\\mu$ 和 $\\sigma$ 的对数正态分布，因此 $\\ln(T_{\\text{inc}}) \\sim \\mathcal{N}(\\mu, \\sigma^{2})$。单位时间传染性（传播强度）是相对于症状出现时间的函数，记为 $\\tau$（$\\tau=0$ 时症状出现），其模型为一个概率密度函数（PDF），该函数是一个平移的伽马分布，从症状出现前 $\\delta$ 天开始。具体来说，令 $V = \\tau + \\delta$ 并定义\n$$\ng(\\tau) = \\begin{cases}\n\\dfrac{\\beta^{k}}{\\Gamma(k)}\\,(\\tau+\\delta)^{k-1}\\exp\\!\\big(-\\beta(\\tau+\\delta)\\big),  \\tau \\geq -\\delta,\\\\\n0,  \\tau  -\\delta,\n\\end{cases}\n$$\n其中 $k0$ 是形状参数，$\\beta0$ 是速率参数，$\\Gamma(\\cdot)$ 是欧拉伽马函数。函数 $g(\\tau)$ 是归一化的，因此 $\\int_{-\\delta}^{\\infty} g(\\tau)\\,d\\tau = 1$，表示以症状出现时间为基准，每个病例在其传染期内继续传播的总倾向。\n\n使用传染病流行病学的基本原理和症状出现前传播比例的定义（即在 $\\tau  0$ 时，也就是症状出现前，发生的传播强度占总传播强度的比例），推导出一个在症状出现前发生传播的比例的解析表达式。然后，对参数 $k=2$，$\\beta=1\\,\\text{day}^{-1}$ 和 $\\delta=1\\,\\text{day}$，以及潜伏期参数 $\\mu=\\ln(5)$ 和 $\\sigma=0.5$ 进行数值评估。将最终数值结果表示为小数，并四舍五入到四位有效数字。最终答案无需单位。", "solution": "首先评估问题的有效性。\n\n**第一步：提取已知条件**\n-   **传染病模型：** 一种急性呼吸道感染。\n-   **潜伏期 ($T_{\\text{inc}}$)：** 潜伏期的对数服从正态分布，$\\ln(T_{\\text{inc}}) \\sim \\mathcal{N}(\\mu, \\sigma^{2})$。\n-   **传染性函数 ($g(\\tau)$)：** 单位时间传染性是相对于症状出现时间 $\\tau$ 的函数（$\\tau=0$）。它被建模为一个平移的伽马概率密度函数（PDF）。\n-   **$g(\\tau)$ 的公式：**\n    $$\n    g(\\tau) = \\begin{cases}\n    \\dfrac{\\beta^{k}}{\\Gamma(k)}\\,(\\tau+\\delta)^{k-1}\\exp\\!\\big(-\\beta(\\tau+\\delta)\\big),  \\tau \\geq -\\delta \\\\\n    0,  \\tau  -\\delta\n    \\end{cases}\n    $$\n-   **$g(\\tau)$ 的参数：** 形状参数 $k  0$，速率参数 $\\beta  0$，平移参数 $\\delta  0$。\n-   **归一化：** 总传播倾向是归一化的，$\\int_{-\\delta}^{\\infty} g(\\tau)\\,d\\tau = 1$。\n-   **定义：** 症状出现前传播比例是在 $\\tau  0$ 时发生的总传播强度的比例。\n-   **任务：** 推导该比例的解析表达式，并对以下参数进行数值评估：\n    -   $k=2$\n    -   $\\beta=1\\,\\text{day}^{-1}$\n    -   $\\delta=1\\,\\text{day}$\n    -   $\\mu=\\ln(5)$\n    -   $\\sigma=0.5$\n-   **四舍五入：** 最终数值结果必须四舍五入到四位有效数字。\n\n**第二步：使用提取的已知条件进行验证**\n该问题定义明确且有科学依据。使用对数正态分布描述潜伏期和使用伽马分布描述传染性曲线是传染病流行病学中的标准方法。问题要求计算在症状出现前发生的传播比例，而给定的传染性曲线已经是以症状出现时间为基准的。有关潜伏期（$T_{\\text{inc}}$，参数为 $\\mu$ 和 $\\sigma$）的信息将感染时间与症状出现时间联系起来。然而，由于传染性曲线 $g(\\tau)$ 已明确给出为相对于症状出现时间 $\\tau$ 的函数，因此回答此特定问题不需要潜伏期分布的信息。这些无关信息的存在并不会使问题无效；相反，它考验了对流行病学中使用的不同时间基准的概念性理解。该问题是自洽的、客观的，并且可以确定唯一的解。\n\n**结论：** 问题有效。\n\n**第三步：求解推导**\n\n在症状出现前发生的传播比例，我们记为 $F_{pre}$，是在时间 $\\tau  0$ 内发生的总传播强度的比例。传染性曲线 $g(\\tau)$ 在 $\\tau \\geq -\\delta$ 时非零。因此，我们关注的症状出现前时期是从 $\\tau = -\\delta$ 到 $\\tau = 0$。\n\n$F_{pre}$ 通过对传染性密度 $g(\\tau)$ 在此区间上积分计算得出：\n$$ F_{pre} = \\int_{-\\delta}^{0} g(\\tau) \\, d\\tau $$\n代入给定的 $g(\\tau)$ 表达式：\n$$ F_{pre} = \\int_{-\\delta}^{0} \\frac{\\beta^{k}}{\\Gamma(k)}\\,(\\tau+\\delta)^{k-1}\\exp(-\\beta(\\tau+\\delta)) \\, d\\tau $$\n为简化此积分，我们进行变量代换。令 $u = \\tau + \\delta$。微分量为 $du = d\\tau$。积分限变更如下：\n-   当 $\\tau = -\\delta$ 时，$u = -\\delta + \\delta = 0$。\n-   当 $\\tau = 0$ 时，$u = 0 + \\delta = \\delta$。\n\n将这些代入积分中得到：\n$$ F_{pre} = \\int_{0}^{\\delta} \\frac{\\beta^{k}}{\\Gamma(k)}\\, u^{k-1}\\exp(-\\beta u) \\, du $$\n此积分是形状参数为 $k$、速率参数为 $\\beta$ 的伽马分布随机变量在 $u=\\delta$ 处的累积分布函数（CDF）的定义。\n\n该比例的一般解析表达式可以用下不完全伽马函数 $\\gamma(s, x) = \\int_0^x t^{s-1} e^{-t} dt$ 来表示。为了看出这一点，我们再进行一次代换。令 $t = \\beta u$。则 $u = t/\\beta$ 且 $du = dt/\\beta$。积分上限变为 $u=\\delta \\implies t=\\beta\\delta$。\n$$ F_{pre} = \\frac{\\beta^{k}}{\\Gamma(k)} \\int_{0}^{\\beta\\delta} \\left(\\frac{t}{\\beta}\\right)^{k-1} \\exp(-t) \\, \\frac{dt}{\\beta} $$\n$$ F_{pre} = \\frac{\\beta^{k}}{\\Gamma(k)} \\frac{1}{\\beta^{k-1}} \\frac{1}{\\beta} \\int_{0}^{\\beta\\delta} t^{k-1} \\exp(-t) \\, dt $$\n$$ F_{pre} = \\frac{1}{\\Gamma(k)} \\int_{0}^{\\beta\\delta} t^{k-1} \\exp(-t) \\, dt $$\n剩下的积分是 $\\gamma(k, \\beta\\delta)$。因此，解析表达式为：\n$$ F_{pre} = \\frac{\\gamma(k, \\beta\\delta)}{\\Gamma(k)} $$\n这是正则化下不完全伽马函数，通常记为 $P(k, \\beta\\delta)$。\n\n接下来，我们对给定参数 $k=2$，$\\beta=1$ 和 $\\delta=1$ 计算此表达式的值。潜伏期参数 $\\mu=\\ln(5)$ 和 $\\sigma=0.5$ 是无关信息，不被使用。\n伽马函数的参数值为 $\\beta\\delta = 1 \\times 1 = 1$。\n$$ F_{pre} = \\frac{\\gamma(2, 1)}{\\Gamma(2)} $$\n我们分别计算各项。对于整数 $k$，伽马函数 $\\Gamma(k) = (k-1)!$。\n$$ \\Gamma(2) = (2-1)! = 1! = 1 $$\n下不完全伽马函数 $\\gamma(2, 1)$ 为：\n$$ \\gamma(2, 1) = \\int_{0}^{1} t^{2-1} \\exp(-t) \\, dt = \\int_{0}^{1} t \\exp(-t) \\, dt $$\n这个积分可以使用分部积分法 $\\int u \\, dv = uv - \\int v \\, du$ 求解。令 $u=t$ 和 $dv=\\exp(-t)dt$。则 $du=dt$ 且 $v=-\\exp(-t)$。\n$$ \\begin{aligned} \\int_{0}^{1} t \\exp(-t) \\, dt = \\left[ -t\\exp(-t) \\right]_{0}^{1} - \\int_{0}^{1} (-\\exp(-t)) \\, dt \\\\ = \\left( -1 \\cdot \\exp(-1) \\right) - \\left( -0 \\cdot \\exp(0) \\right) + \\int_{0}^{1} \\exp(-t) \\, dt \\\\ = -\\exp(-1) + \\left[ -\\exp(-t) \\right]_{0}^{1} \\\\ = -\\exp(-1) + \\left( (-\\exp(-1)) - (-\\exp(0)) \\right) \\\\ = -\\exp(-1) - \\exp(-1) + 1 \\\\ = 1 - 2\\exp(-1) = 1 - \\frac{2}{e} \\end{aligned} $$\n所以，$\\gamma(2, 1) = 1 - 2/e$。\n将这些结果代回 $F_{pre}$ 的表达式中：\n$$ F_{pre} = \\frac{1 - 2/e}{1} = 1 - \\frac{2}{e} $$\n这是给定参数下的精确解析值。\n\n最后，我们计算数值并四舍五入到四位有效数字。使用 $e \\approx 2.71828$ 的值：\n$$ F_{pre} = 1 - \\frac{2}{2.71828...} \\approx 1 - 0.73575888... \\approx 0.26424112... $$\n四舍五入到四位有效数字，我们得到：\n$$ F_{pre} \\approx 0.2642 $$", "answer": "$$\n\\boxed{0.2642}\n$$", "id": "4656311"}, {"introduction": "本练习旨在架起理论与数据分析之间的桥梁，这是现代流行病学家的一项核心技能。您将开发一个计算算法，以根据真实的流行病学数据（如症状出现时间和接触者追踪信息）来估计有效再生数（$R_t$）[@problem_id:4656251]。这项动手编程练习将展示如何将传染链原理和更新理论（renewal theory）综合成一个用于实时疫情评估的实用工具，并处理现实世界中常见的数据不确定性。", "problem": "给定以天为单位的观察到的症状发作时间，以及一个有向接触矩阵，该矩阵指定了哪些个体对之间存在可能导致传播的接触。从传染链的基本原理和发病率的更新公式出发，推导一个算法，该算法使用成对归一化的传播似然来计算有效再生数（ER），记为 $R$。从个体 $i$ 到个体 $j$ 的一次潜在传播的似然，应与在发作时间差 $\\tau = t_j - t_i$ 处求值的传染性核函数 $w(\\tau)$ 成正比，再乘以一个指示是否观察到接触的接触权重。传染性核函数 $w(\\tau)$ 是序列间隔的概率密度函数，建模为形状参数为 $k$、尺度参数为 $\\theta$ 的伽马分布，并且当 $\\tau \\le 0$ 时为零。接触被编码在一个二元有向矩阵 $C$ 中，其条目为 $C_{ij} \\in \\{0,1\\}$。您必须包含一个背景接触权重 $b \\in [0,1]$，通过将有效权重设置为 $(C_{ij} + b(1 - C_{ij}))$ 来考虑未观察到的传播机会。对于每个潜在的被感染者 $j$，将所有候选感染者 $i$ 的成对似然进行归一化，以获得传播概率 $p_{ij}$。个体 $i$ 的继发病例期望数是 $R_i = \\sum_j p_{ij}$，而总体有效再生数是所有个体的平均值，$R = \\frac{1}{N}\\sum_i R_i$，其中 $N$ 是个体总数。\n\n暴露时间的不确定性应建模为发作时间上的独立正态分布测量误差，$\\delta_i \\sim \\mathcal{N}(0,\\sigma^2)$，从而产生受扰动的发作时间 $t_i' = t_i + \\delta_i$。通过蒙特卡洛采样将此不确定性传播到 $R$ 中，具体方法是进行 $M$ 次独立的 $\\{\\delta_i\\}$ 抽样，为每次抽样计算 $R$，然后报告 $R$ 的蒙特卡洛平均值和标准差。为保证可复现性，请使用固定的随机种子。\n\n使用的基本原理：\n- 传染链意味着传播需要传染源（感染性）和易感宿主之间的接触，其时间受代际间隔或序列间隔的控制。\n- 发病率的更新公式表明，新病例可以表示为过去传染性的加权和（或积分），其核函数为 $w(\\tau)$。\n- 序列间隔 $w(\\tau)$ 是一个经过充分检验的用于描述症状发作时间差异的统计描述符，而形状参数为 $k$、尺度参数为 $\\theta$ 的伽马分布被广泛用于对其进行建模。\n\n算法要求：\n- 对于每个 $i \\neq j$ 的有序对 $(i,j)$，计算未归一化的似然 $L_{ij} = \\mathbf{1}\\{t_j  t_i\\}\\, w(t_j - t_i; k,\\theta)\\, (C_{ij} + b(1 - C_{ij}))$，其中 $\\mathbf{1}\\{\\cdot\\}$ 是指示函数。\n- 对于每个 $j$，对 $L_{ij}$ 按 $i$ 进行归一化以获得 $p_{ij} = L_{ij} / \\sum_{k} L_{kj}$（当分母非零时）；否则设置 $p_{ij} = 0$。\n- 计算 $R_i = \\sum_j p_{ij}$ 和 $R = \\frac{1}{N}\\sum_i R_i$。\n- 对于不确定性传播，采样 $M$ 组 $\\{\\delta_i\\}$，根据受扰动的时间 $\\{t_i'\\}$ 计算 $R^{(m)}$，并返回在 $m=1,\\dots,M$ 上的平均值 $\\bar{R}$ 和标准差 $s_R$。\n\n单位与输出：\n- 发作时间 $t_i$ 以天为单位；确保所有时间差都以天为单位计算。\n- 所有输出均为无单位的实数。\n- 对于每个测试用例，您的程序必须输出一个包含三个浮点数的列表 $[R_{\\text{fixed}}, \\bar{R}_{\\text{uncertain}}, s_{R,\\text{uncertain}}]$，并四舍五入到 $4$ 位小数。\n- 您的程序应生成单行输出，其中包含用方括号括起来的结果列表，每个测试用例的结果也用自己的方括号括起来，并以逗号分隔（例如，`[[0.9,0.88,0.05],[\\dots]]`）。\n\n测试套件：\n为以下四组参数计算输出。在每种情况下，$M$ 是蒙特卡洛采样的数量，随机种子固定为 $123$。\n\n$1.$ 具有稀疏有向接触且无时间不确定性的理想情况：\n- 发作时间（天）：$[0.0, 3.0, 6.0, 10.0, 12.0]$。\n- 接触矩阵 $C$（$5 \\times 5$），行索引为 $i$，列索引为 $j$：\n$\\begin{bmatrix}\n0  1  1  0  0 \\\\\n0  0  1  1  0 \\\\\n0  0  0  1  1 \\\\\n0  0  0  0  1 \\\\\n0  0  0  0  0\n\\end{bmatrix}$\n- 伽马分布形状参数 $k = 2.5$，尺度参数 $\\theta = 2.0$。\n- 背景接触权重 $b = 0.05$。\n- 发作时间误差标准差 $\\sigma = 0.0$。\n- 蒙特卡洛采样数 $M = 1000$。\n\n$2.$ 发作时间相同且具有中等时间不确定性：\n- 发作时间（天）：$[1.0, 1.0, 2.0, 2.0]$。\n- 接触矩阵 $C$（$4 \\times 4$）：\n$\\begin{bmatrix}\n0  1  1  0 \\\\\n0  0  1  1 \\\\\n0  0  0  1 \\\\\n0  0  0  0\n\\end{bmatrix}$\n- 伽马分布形状参数 $k = 2.0$，尺度参数 $\\theta = 3.0$。\n- 背景接触权重 $b = 0.10$。\n- 发作时间误差标准差 $\\sigma = 0.5$。\n- 蒙特卡洛采样数 $M = 1000$。\n\n$3.$ 无观察到的接触且时间不确定性较大：\n- 发作时间（天）：$[5.0, 1.0, 3.0]$。\n- 接触矩阵 $C$（$3 \\times 3$）：全为零，即\n$\\begin{bmatrix}\n0  0  0 \\\\\n0  0  0 \\\\\n0  0  0\n\\end{bmatrix}$\n- 伽马分布形状参数 $k = 1.8$，尺度参数 $\\theta = 2.5$。\n- 背景接触权重 $b = 0.20$。\n- 发作时间误差标准差 $\\sigma = 1.5$。\n- 蒙特卡洛采样数 $M = 1500$。\n\n$4.$ 具有密集无环接触、宽序列间隔和高时间不确定性：\n- 发作时间（天）：$[0.0, 2.0, 4.0, 6.0, 8.0, 10.0]$。\n- 接触矩阵 $C$（$6 \\times 6$），当 $i  j$ 时 $C_{ij} = 1$，否则为 $0$，即\n$\\begin{bmatrix}\n0  1  1  1  1  1 \\\\\n0  0  1  1  1  1 \\\\\n0  0  0  1  1  1 \\\\\n0  0  0  0  1  1 \\\\\n0  0  0  0  0  1 \\\\\n0  0  0  0  0  0\n\\end{bmatrix}$\n- 伽马分布形状参数 $k = 1.2$，尺度参数 $\\theta = 4.0$。\n- 背景接触权重 $b = 0.10$。\n- 发作时间误差标准差 $\\sigma = 2.0$。\n- 蒙特卡洛采样数 $M = 2000$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含按顺序排列的四个测试用例的结果列表，每个结果的格式为 $[R_{\\text{fixed}}, \\bar{R}_{\\text{uncertain}}, s_{R,\\text{uncertain}}]$ 并四舍五入到 $4$ 位小数，汇总到一个列表中，例如：`[[0.0000,0.0000,0.0000],[0.0000,0.0000,0.0000],[0.0000,0.0000,0.0000],[0.0000,0.0000,0.0000]]`。", "solution": "我们从传染链出发，它假定传播发生在传染源宿主在传染期内与易感宿主接触时，并且新感染发生的时间由代际间隔或序列间隔决定。在实践中，我们通常观察到的是症状发作时间。发病率的更新公式将时间 $t$ 的新病例发病率表示为先前病例传染性的累积，该累积由一个描述传播时间的核函数进行加权。在连续时间下，一个经典的更新方程将发病率 $I(t)$ 写为\n$$\nI(t) = \\int_0^\\infty R(t-\\tau)\\, I(t-\\tau)\\, w(\\tau)\\, d\\tau,\n$$\n其中 $w(\\tau)$ 是代际或序列间隔密度。当关注一个具有发作时间 $\\{t_i\\}_{i=1}^N$ 的有限观察病例集合时，我们可以用一个与 $w(t_j - t_i)$ 成正比的似然来近似每个先前病例 $i$ 对每个后续病例 $j$ 的贡献，前提是 $t_j > t_i$。序列间隔密度 $w(\\tau)$ 总结了潜伏期和传染性时间的不确定性，通常用形状参数为 $k$、尺度参数为 $\\theta$ 的伽马分布来建模：\n$$\nw(\\tau; k,\\theta) =\n\\begin{cases}\n\\frac{1}{\\Gamma(k)\\,\\theta^k}\\, \\tau^{k-1}\\, e^{-\\tau/\\theta},  \\tau  0,\\\\\n0,  \\tau \\le 0.\\\\\n\\end{cases}\n$$\n\n观察到的接触构成一个有向矩阵 $C$，其条目为 $C_{ij} \\in \\{0,1\\}$。现实中，接触的观察是不完美的，因此我们引入一个背景接触权重 $b \\in [0,1]$ 来表示未观察到的机会。因此，我们定义一个接触权重 $W_{ij} = C_{ij} + b(1 - C_{ij})$，确保 $W_{ij} \\in [b,1]$。\n\n定义从 $i$ 到 $j$ 的未归一化成对传播似然为\n$$\nL_{ij} = \\mathbf{1}\\{t_j  t_i\\}\\, w(t_j - t_i; k,\\theta)\\, W_{ij}.\n$$\n对于每个潜在的被感染者 $j$，对所有候选感染者 $i$ 进行归一化以获得传播概率：\n$$\np_{ij} =\n\\begin{cases}\n\\frac{L_{ij}}{\\sum_{k=1}^N L_{kj}},  \\text{if } \\sum_{k=1}^N L_{kj}  0,\\\\\n0,  \\text{otherwise.}\n\\end{cases}\n$$\n归因于病例 $i$ 的继发病例期望数为\n$$\nR_i = \\sum_{j=1}^N p_{ij},\n$$\n而有效再生数是所有病例的平均值，\n$$\nR = \\frac{1}{N}\\sum_{i=1}^N R_i.\n$$\n\n这个构造是有原则的：$p_{ij}$ 的得出，是通过将病例 $j$ 的更新贡献，按与 $w(\\tau)$ 和接触可用性成正比的方式，分配给符合条件的先前病例 $i$。这与传染链和更新动态一致，并且没有预先假设 $R$ 的特定公式。\n\n暴露时间的不确定性传播：症状发作时间受测量误差和生物变异性的影响。我们将发作时间误差建模为独立的高斯噪声，\n$$\n\\delta_i \\sim \\mathcal{N}(0,\\sigma^2), \\quad t_i' = t_i + \\delta_i.\n$$\n$t_i$ 的不确定性导致了成对间隔 $\\tau_{ij}' = t_j' - t_i'$ 的不确定性，这会改变 $L_{ij}$，从而改变 $p_{ij}$ 和 $R$。在时间不确定性下的期望再生数为\n$$\n\\mathbb{E}[R] = \\int R(\\{t_i + \\delta_i\\}) \\prod_{i=1}^N \\phi(\\delta_i; 0, \\sigma^2)\\, d\\delta_1\\cdots d\\delta_N,\n$$\n其中 $\\phi$ 是高斯密度。对于一般的 $C$ 和 $w(\\cdot)$，该积分在解析上是难以处理的，但蒙特卡洛采样可以对其进行近似：抽取 $M$ 个独立样本 $\\{\\delta_i^{(m)}\\}$，为每个受扰动的发作时间集 $\\{t_i^{(m)}\\} = \\{t_i + \\delta_i^{(m)}\\}$ 计算 $R^{(m)}$，并通过样本均值和标准差进行总结，\n$$\n\\bar{R} = \\frac{1}{M}\\sum_{m=1}^M R^{(m)}, \\quad s_R = \\sqrt{\\frac{1}{M-1}\\sum_{m=1}^M (R^{(m)} - \\bar{R})^2 }.\n$$\n\n实现算法的步骤：\n$1.$ 输入 $\\{t_i\\}$、C、k、θ、b、σ 和 M。\n$2.$ 将 $w(\\tau; k,\\theta)$ 定义为当 $\\tau  0$ 时的伽马密度，否则为零。\n$3.$ 使用固定的时间计算 $R$：\n- 计算 $W_{ij} = C_{ij} + b(1 - C_{ij})$。\n- 使用 $t_j - t_i$ 和 $W_{ij}$ 计算 $L_{ij}$。\n- 对于每个 $j$，进行归一化以获得 $p_{ij}$。\n- 计算 $R_i$ 和 $R$。\n$4.$ 对于不确定性，使用固定的随机种子：\n- 对于 $m=1,\\dots,M$，独立采样 $\\delta_i^{(m)} \\sim \\mathcal{N}(0,\\sigma^2)$。\n- 构建受扰动的时间 $\\{t_i^{(m)}\\}$ 并重复步骤 3 以获得 $R^{(m)}$。\n- 计算 $\\bar{R}$ 和 $s_R$。\n$5.$ 将 $R$、$\\bar{R}$ 和 $s_R$ 四舍五入到 4 位小数。\n\n不确定性传播的解释：\n- 更大的 $\\sigma$ 会增加 $\\tau_{ij}'$ 的变异性，这会使候选感染者之间由 $w(\\tau)$ 产生的有效权重变得更加平坦。这倾向于使归一化分配 $p_{ij}$ 不再那么集中于时间上合理的配对，而变得更加分散，从而降低了特定传播链的可识别性。\n- 随着 $\\sigma$ 的增长，$s_R$ 通常会增加，反映出由于时间噪声导致 $R$ 的不确定性更大。\n- 当接触稀疏且与时间顺序一致时，固定时间下的 $R$ 更为稳定；而在密集或模糊的接触下，不确定性会增大 $R$ 的方差。\n\n将该程序应用于测试套件：\n- 案例 1 包括有序的发作时间和稀疏的接触，且 $\\sigma = 0$，因此 $s_R$ 应为 $0$，且 $R_{\\text{fixed}} = \\bar{R}_{\\text{uncertain}}$。\n- 案例 2 包括相同的发作时间和中等的 $\\sigma$，这会导致一些扰动打破时间上的相同性并重新分配 $p_{ij}$，从而增加 $s_R$。\n- 案例 3 没有观察到的接触，因此背景权重 $b=0.20$ 对于允许非零似然至关重要，而大的 $\\sigma$ 会产生显著的不确定性。\n- 案例 4 具有密集的无环接触和宽的序列间隔（$k=1.2$，$\\theta=4.0$）以及高 $\\sigma$，这两者都会使分配变得分散并增加 $s_R$。\n\n该程序计算并报告每个案例的 $[R_{\\text{fixed}}, \\bar{R}_{\\text{uncertain}}, s_{R,\\text{uncertain}}]$，四舍五入到 4 位小数，并汇总在单行的一个带括号的列表中。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import gamma, norm\n\ndef gamma_pdf_tau(tau, k, theta):\n    \"\"\"\n    Gamma density for serial interval at tau > 0 with shape k and scale theta.\n    Returns 0 for tau = 0.\n    \"\"\"\n    if tau = 0.0:\n        return 0.0\n    # scipy.stats.gamma uses shape 'a' and scale 'scale'\n    return gamma.pdf(tau, a=k, scale=theta)\n\ndef compute_pairwise_probabilities(onsets, C, k, theta, b):\n    \"\"\"\n    Compute pairwise transmission probabilities p_ij given onsets, contact matrix C,\n    gamma parameters (k, theta), and background contact weight b.\n    Returns p matrix, R_i vector, and overall R.\n    \"\"\"\n    n = len(onsets)\n    # Effective contact weights: W_ij = C_ij + b*(1 - C_ij)\n    W = C + b * (1 - C)\n    # Unnormalized likelihoods L_ij\n    L = np.zeros((n, n), dtype=float)\n    for i in range(n):\n        for j in range(n):\n            if i == j:\n                continue\n            tau = onsets[j] - onsets[i]\n            w = gamma_pdf_tau(tau, k, theta)\n            L[i, j] = w * W[i, j]\n    # Normalize per column j to get p_ij\n    p = np.zeros_like(L)\n    col_sums = L.sum(axis=0)\n    for j in range(n):\n        if col_sums[j] > 0.0:\n            p[:, j] = L[:, j] / col_sums[j]\n        else:\n            p[:, j] = 0.0\n    # R_i and overall R\n    R_i = p.sum(axis=1)\n    R = R_i.mean() if n > 0 else 0.0\n    return p, R_i, R\n\ndef compute_R_fixed(onsets, C, k, theta, b):\n    \"\"\"Compute R with fixed onset times.\"\"\"\n    _, _, R = compute_pairwise_probabilities(onsets, C, k, theta, b)\n    return R\n\ndef compute_R_uncertain_mc(onsets, C, k, theta, b, sigma, M, rng):\n    \"\"\"\n    Monte Carlo propagation of onset timing uncertainty.\n    Returns mean R and std of R across M samples.\n    \"\"\"\n    n = len(onsets)\n    Rs = np.zeros(M, dtype=float)\n    if sigma == 0.0:\n        # No uncertainty: return fixed R and std=0\n        R_fixed = compute_R_fixed(onsets, C, k, theta, b)\n        return R_fixed, 0.0\n    for m in range(M):\n        deltas = rng.normal(loc=0.0, scale=sigma, size=n)\n        perturbed_onsets = onsets + deltas\n        _, _, Rm = compute_pairwise_probabilities(perturbed_onsets, C, k, theta, b)\n        Rs[m] = Rm\n    return float(Rs.mean()), float(Rs.std(ddof=1) if M > 1 else 0.0)\n\ndef format_triplet(triplet):\n    \"\"\"Format three floats to 4 decimal places within brackets.\"\"\"\n    return f\"[{triplet[0]:.4f},{triplet[1]:.4f},{triplet[2]:.4f}]\"\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Case 1\n    onsets1 = np.array([0.0, 3.0, 6.0, 10.0, 12.0], dtype=float)\n    C1 = np.array([\n        [0,1,1,0,0],\n        [0,0,1,1,0],\n        [0,0,0,1,1],\n        [0,0,0,0,1],\n        [0,0,0,0,0]\n    ], dtype=int)\n    k1, theta1, b1, sigma1, M1 = 2.5, 2.0, 0.05, 0.0, 1000\n\n    # Case 2\n    onsets2 = np.array([1.0, 1.0, 2.0, 2.0], dtype=float)\n    C2 = np.array([\n        [0,1,1,0],\n        [0,0,1,1],\n        [0,0,0,1],\n        [0,0,0,0]\n    ], dtype=int)\n    k2, theta2, b2, sigma2, M2 = 2.0, 3.0, 0.10, 0.5, 1000\n\n    # Case 3\n    onsets3 = np.array([5.0, 1.0, 3.0], dtype=float)\n    C3 = np.zeros((3,3), dtype=int)\n    k3, theta3, b3, sigma3, M3 = 1.8, 2.5, 0.20, 1.5, 1500\n\n    # Case 4\n    onsets4 = np.array([0.0, 2.0, 4.0, 6.0, 8.0, 10.0], dtype=float)\n    C4 = np.triu(np.ones((6, 6), dtype=int), k=1)\n    k4, theta4, b4, sigma4, M4 = 1.2, 4.0, 0.10, 2.0, 2000\n    \n    test_cases = [\n        (onsets1, C1, k1, theta1, b1, sigma1, M1),\n        (onsets2, C2, k2, theta2, b2, sigma2, M2),\n        (onsets3, C3, k3, theta3, b3, sigma3, M3),\n        (onsets4, C4, k4, theta4, b4, sigma4, M4),\n    ]\n\n    all_results = []\n    # Set fixed seed for reproducibility for all MC runs\n    rng = np.random.default_rng(123)\n    \n    for i, (onsets, C, k, theta, b, sigma, M) in enumerate(test_cases):\n        R_fixed = compute_R_fixed(onsets, C, k, theta, b)\n        R_mean_mc, R_std_mc = compute_R_uncertain_mc(onsets, C, k, theta, b, sigma, M, rng)\n        all_results.append([R_fixed, R_mean_mc, R_std_mc])\n\n    # Format the final output string\n    formatted_results = [format_triplet(res) for res in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\n# Execute the solver\nsolve()\n```", "id": "4656251"}]}