## 引言
随着[单细胞测序](@entry_id:198847)技术的革命性发展，我们首次获得了以前所未有的分辨率探索生命基本组成单元——细胞——的能力。然而，海量的数据也带来了一个核心的计算与生物学挑战：如何准确、稳健地鉴定和注释构成复杂组织与器官的各种细胞类型？对细胞身份的精确描绘不仅是理解发育、生理和病理过程的基石，也是精准医学发展的关键前提。

然而，从高维、稀疏且充满噪声的单细胞数据中提取有意义的细胞身份并非易事。这要求我们建立一个严谨的计算框架，以解决一系列根本性问题：如何从数学上区分稳定的“细胞类型”与可变的“细胞状态”？如何校正技术差异以实现跨样本、跨物种的可靠比较？以及如何整合来自不同分子层面（如[转录组](@entry_id:274025)、表观组和蛋白质组）的信息，构建一幅完整而一致的[细胞图谱](@entry_id:270083)？本文旨在系统性地回答这些问题。

为实现这一目标，本文将分为三个部分，引导读者逐步深入细胞类型鉴定与注释的核心。在第一章**“原理与机制”**中，我们将剖析支撑整个分析流程的数学和统计学原理，从细胞身份的计算定义，到[数据预处理](@entry_id:197920)、[图聚类](@entry_id:263568)、降维可视化以及自动化注释的算法细节。随后的第二章**“应用与交叉学科联系”**将展示这些理论如何在真实的研究场景中发挥作用，涵盖从头注释、多模态整合、空间定位到连接遗传学与疾病机制的前沿应用。最后，在**“动手实践”**部分，我们提供了一系列精心设计的问题，帮助读者巩固对关键概念的理解。通过这一结构化的学习路径，您将掌握进行高水平[单细胞分析](@entry_id:274805)所需的理论深度和实践技能。

我们首先从最基本的问题开始：从计算的角度来看，究竟什么是“细胞类型”？

## 原理与机制

### 细胞身份的计算定义：类型 vs. 状态

在系统生物医学中，对细胞进行分类和注释的核心挑战在于如何精确界定“细胞类型”（cell type）。一个稳健的细胞类型定义应当是内在且相对稳定的，能够跨越不同的组织微环境、外部刺激和个体差异。与此相对，“细胞状态”（cell state）则通常指代一种瞬时或可逆的生物学过程，它可以叠加在稳定的细胞类型之上，例如细胞周期、代谢活动或对信号的[应激反应](@entry_id:168351)。

为了在单细胞转录组数据中区分这两种概念，我们必须寻找在各种扰动下保持不变的分子特征。一个有效的定义依赖于一组**必要且充分**（necessary and sufficient）的分子标准。必要性意味着属于某种类型的所有细胞都必须满足这些标准；充分性则意味着满足这些标准的所有细胞都应被归为此类型。

考虑一个思想实验，我们分析了来自不同组织（如血液、淋巴结、肿瘤）并在两种条件下（基线和干扰素$\gamma$刺激后）的人类[T淋巴细胞](@entry_id:165336)的单细胞RNA测序数据[@problem_id:4324341]。我们观察到两组基因：一组是定义幼稚[T细胞](@entry_id:138090)的基因（如$S_{\text{naive}} = \{\text{CCR7}, \text{TCF7}\}$），另一组是定义[细胞毒性T细胞](@entry_id:139626)的基因（如$S_{\text{cytotoxic}} = \{\text{NKG7}, \text{GZMB}\}$）。实验发现，这两组基因的表达在所有组织和条件下都表现出强烈的**互斥性**（mutual exclusivity）：高表达$S_{\text{naive}}$的细胞几乎从不高表达$S_{\text{cytotoxic}}$，反之亦然。这种稳定的[互斥](@entry_id:752349)模式构成了定义“细胞类型”的理想基础。我们可以将“[细胞毒性T细胞](@entry_id:139626)”类型定义为持续高表达$S_{\text{cytotoxic}}$中的基因并低表达$S_{\text{naive}}$中基因的细胞集合。

与此同时，我们观察到另一组基因——[干扰素刺激基因](@entry_id:168421)（Interferon-Stimulated Genes, ISGs），如$S_{\text{ISG}} = \{\text{ISG15}, \text{IFIT1}\}$。这些基因的表达在干扰素$\gamma$刺激后，在幼稚[T细胞](@entry_id:138090)和[细胞毒性T细胞](@entry_id:139626)中都显著上调。因此，高表达$S_{\text{ISG}}$并非某一特定细胞类型的稳定属性，而是一个可被多种细胞类型采纳的**瞬时应答状态**。类似地，与细胞增殖相关的基因（如$S_{\text{cycle}} = \{\text{MKI67}, \text{TOP2A}\}$）的表达也定义了一个跨越不同细胞类型的“细胞周期状态”。一个正在分裂的[细胞毒性T细胞](@entry_id:139626)，其根本身份依然是[细胞毒性T细胞](@entry_id:139626)。

因此，一个严谨的细胞类型定义是基于一组在多重生物学情境下**不变**（invariant）的分子特征（例如，一组正向和负向标记基因），而细胞状态则由可变的、通常是响应外部或内部信号的基因程序来表征。[无监督聚类](@entry_id:168416)算法（如PCA或UMAP）所产生的聚类结果，虽然直观，但本身并不能直接等同于细胞类型。一个强烈的瞬时信号（如干扰素应答）可能在降维图上形成一个独立的、密集的聚类，但这反映的是一个强大的“状态”，而非一个独立的“类型”。将这种依赖于特定条件的聚类视为一种新的细胞类型，会混淆状态与类型的根本区别。

### 单细胞数据的表示与预处理

在识别细胞类型之前，必须对原始的[单细胞测序](@entry_id:198847)数据进行恰当的数学表示和处理。单细胞数据具有两个显著特点：**高维性**（high-dimensionality），即每个细胞的表达谱由数万个基因构成；以及**稀疏性**（sparsity），即在任何一个细胞中，绝大多数基因的测量计数值都为零。这些特点对传统的分析方法提出了挑战。

#### 高维稀疏性带来的挑战：[距离度量](@entry_id:636073)的选择

在高维空间中，我们对“距离”的直观感受可能会失效。一个被称为**距离集中**（concentration of distances）的现象指出，随着维度的增加，空间中任意两点之间的距离趋于一个常数，使得基于距离的区分变得困难。

让我们通过一个简化的模型来探讨这个问题[@problem_id:4324406]。假设我们有两个细胞的基因表达向量$\mathbf{X}, \mathbf{Y} \in \mathbb{R}^{G}$，其中$G$是基因总数。每个基因的计数值$X_g$和$Y_g$是稀疏的，它们以概率$p$被检测到，若检测到，则其计数值服从一个泊松分布。我们来比较两种常用的度量：欧氏距离（Euclidean distance）和余弦相似度（cosine similarity）。

**欧氏距离**的平方$D_{G}^{2} = \sum_{g=1}^{G} (X_{g} - Y_{g})^{2}$，会受到细胞**[测序深度](@entry_id:178191)**或**文库大小**（library size）的强烈影响。文库大小更大的细胞，其基因计数值总体偏高，导致它们即使在生物学上非常相似，其欧氏距离也可能被人为地拉大。更根本的是，根据[大数定律](@entry_id:140915)，当基因数量$G \to \infty$时，$D_{G}^{2}$的[期望值](@entry_id:150961)$\mathbb{E}[D_{G}^{2}]$与$G$成正比，而其标准差与$\sqrt{G}$成正比。这意味着其变异系数$\mathrm{CV}(D_{G}^{2}) = \frac{\sqrt{\mathrm{Var}(D_{G}^{2})}}{\mathbb{E}[D_{G}^{2}]}$会随着$1/\sqrt{G}$的速率趋向于$0$。这个极限值$0$表明，在高维空间中，任意两个随机选择的细胞之间的欧氏距离的相对差异变得微乎其微，失去了区分能力。

相比之下，**余弦相似度** $C_{G} = \frac{\langle \mathbf{X}, \mathbf{Y} \rangle}{\|\mathbf{X}\|_{2} \, \|\mathbf{Y}\|_{2}}$通过将向量的[内积](@entry_id:750660)除以各自的[L2范数](@entry_id:172687)（即[向量长度](@entry_id:156432)）进行归一化。这种归一化操作有效地消除了文库大小差异带来的尺度效应。在相同的模型下，当$G \to \infty$时，余弦相似度会收敛到一个不依赖于文库大小，而主要由基因检测概率$p$决定的稳定值。因此，在高维、稀疏的[单细胞数据分析](@entry_id:173175)中，余弦相似度或其相关的度量（如相关性系数）通常比欧氏距离更为鲁棒和可取。

#### 处理技术变异：归一化与方差稳定

单细胞RNA测序数据中的计数值不仅受到生物学差异的影响，还受到技术噪声的干扰。其中一个主要的变异来源是**[异方差性](@entry_id:136378)**（heteroskedasticity），即基因表达的方差与其均值相关。对于原始计数值，表达量越高的基因通常表现出越大的变异，这可能在下游分析（如聚类或[降维](@entry_id:142982)）中过度放大了高表达基因的权重。

为了纠正这种偏差，**[方差稳定变换](@entry_id:273381)**（Variance-Stabilizing Transform, VST）应运而生。其目标是找到一个函数$g(y)$，使得变换后的数据$g(Y)$的方差不再依赖于其均值。

一种简单而广泛使用的方法是**对数归一化**（log-normalization），其形式为$g_{\log}(y) = \ln(y + c)$，其中$c$是一个小的伪计数（pseudocount），以避免对零取对数。虽然这种方法在实践中很有效，但它并不能完美地稳定方差。我们可以使用**delta方法**来[近似分析](@entry_id:160272)变换后数据的方差：$\operatorname{Var}[g(Y)] \approx [g'(\mu)]^{2} \operatorname{Var}(Y)$，其中$\mu = \mathbb{E}[Y]$。对于单细胞计数值，通常使用**负二项分布**（Negative Binomial, NB）来建模，其均值-方差关系为$\operatorname{Var}(Y) = \mu + \alpha \mu^{2}$，其中$\alpha$是**[离散度](@entry_id:168823)参数**（dispersion parameter）。应用delta方法于[对数变换](@entry_id:267035)，我们发现变换后的方差仍然与均值$\mu$相关[@problem_id:4324365]。

一种更具原则性的方法是直接从N[B模型](@entry_id:159413)出发，构建一个理论上的[方差稳定变换](@entry_id:273381)。**皮尔逊残差**（Pearson residuals）提供了一种有效的近似VST。对于一个观测值$y$，其皮尔逊残差定义为：
$$
r(y; \mu, \alpha) = \frac{y - \mu}{\sqrt{\mu + \alpha \mu^{2}}}
$$
这个变换的本质是将每个基因的表达量中心化（减去[期望值](@entry_id:150961)），并按其期望的标准差进行缩放。理论上，如果模型假设准确，经过皮尔逊残差变换后的数据，其[方差近似](@entry_id:268585)为$1$，与均值无关。这种基于模型的变换方法，如`sctransform`包中实现的，通常比简单的对数变换能更有效地消除技术噪声，为下游分析提供更清晰的生物学信号。我们可以通过定义一个**局部异方差指数**$H_{g}(\mu^{\star}) = \left| \frac{\partial}{\partial \mu} \ln\!\left(\operatorname{Var}\!\big[g(Y)\big]\right) \right|_{\mu = \mu^{\star}}$来量化变换的效果。计算表明，在典型参数下，皮尔逊残差的该指数远小于对数变换，证实了其在稳定方差方面的优越性[@problem_id:4324365]。

### 无监督细胞类型发现：[聚类分析](@entry_id:637205)

在对数据进行适当的预处理后，最常见的细胞类型识别策略是**[无监督聚类](@entry_id:168416)**（unsupervised clustering）。其核心思想是：[转录组](@entry_id:274025)谱相似的细胞可能属于同一类型。现代的[聚类方法](@entry_id:747401)大多基于图论，将细胞识别问题转化为网络上的[社区发现](@entry_id:143791)问题。

#### 构建鲁棒的细胞-细胞相似性图

[聚类分析](@entry_id:637205)的第一步是量化细胞间的相似性，并构建一个**细胞-细胞相似性图**（cell-cell similarity graph）。在这个图中，节点是细胞，边的权重代表细胞间的相似度。

一个直接的方法是为每个细胞找到其**k-近邻**（k-Nearest Neighbors, k-NN），并构建一个k-NN图。然而，在高维空间中，k-NN图容易受到一种称为“**中心性**”（hubness）的现象的影响[@problem_id:4324345]。Hubness指的是，少数“中心”数据点会不成比例地频繁出现在许多其他数据点的近邻列表中。这些hub节点往往会错误地连接起本应分离的生物学群体，从而干扰聚类结果。

为了构建一个更鲁棒的图，研究者们发展了**共享近邻**（Shared Nearest Neighbor, SNN）方法。SNN图的构建基于一个直观的假设：如果两个细胞共享了许多共同的近邻，那么它们之间的连接就更可信。SNN图中边的权重不是直接的距离，而是它们近邻集合的重叠程度。

一种特别有效的权重计算方式是**Jaccard指数**（Jaccard index），它定义为两个集合交集的大小除以其并集的大小。对于细胞$i$和$j$，其近邻集合分别为$N_k(i)$和$N_k(j)$，则Jaccard权重为：
$$
w_{ij} = J(i,j) = \frac{|N_k(i) \cap N_k(j)|}{|N_k(i) \cup N_k(j)|}
$$
Jaccard加权能够有效减轻hubness效应。假设一个hub节点$h$同时出现在两个本不相关的细胞$i$和$u$的近邻列表$N_k(i)$和$N_k(u)$中，并且是它们唯一的共同邻居。此时，它们的交集大小为$1$。然而，由于它们没有其他共同邻居，其并集大小会非常大（接近$2k-1$）。这导致$J(i,u)$的值非常小，从而有效抑制了由hub节点引起的伪连接。相反，对于真正属于同一局部邻域的两个细胞$i$和$j$，它们会共享多个近邻，交集较大，并集相对较小，从而获得较高的Jaccard权重[@problem_id:4324345]。这种自适应的归一化使得SNN图比简单的k-NN图更能准确地反映数据的局部密度和生物学结构。

#### 图上的[社区发现](@entry_id:143791)：模块度最优化

在构建了SNN图之后，聚类问题就转化为了在图上进行**[社区发现](@entry_id:143791)**（community detection）的问题。目标是找到节点的划分，使得社区内部的连接远比社区之间的连接更为密集。

**Louvain**和**Leiden**算法是两种广泛用于[单细胞分析](@entry_id:274805)的[社区发现](@entry_id:143791)算法。它们的核心是优化一个名为**模块度**（modularity）的[质量函数](@entry_id:158970)。模块度$Q$衡量的是一个特定划分中，社区内部的边权重总和，与一个“[零模型](@entry_id:181842)”（null model）下期望的社区内部边权重总和之间的差异。[零模型](@entry_id:181842)通常采用**配置模型**（configuration model），该模型假设边的连接是随机的，但每个节点的总连接强度（即加权度）保持不变。在此模型下，节点$i$和$j$之间期望的边权重$P_{ij}$正比于它们各自度数$k_i$和$k_j$的乘积，即$P_{ij} = \frac{k_i k_j}{2m}$，其中$m$是图中所有边权重的总和。

引入一个**分辨[率参数](@entry_id:265473)**（resolution parameter）$\gamma > 0$的[模块度函数](@entry_id:190401)定义为[@problem_id:4324373]：
$$
Q(\gamma) = \frac{1}{2m} \sum_{i,j} \left[ A_{ij} - \gamma \frac{k_i k_j}{2m} \right] \delta(c_i, c_j)
$$
其中，$A_{ij}$是节点$i$和$j$之间的实际边权重，$c_i$是节点$i$所属的社区，$\delta(c_i, c_j)$当且仅当$i$和$j$在同一社区时为$1$。

分辨[率参数](@entry_id:265473)$\gamma$扮演着至关重要的角色。它控制着社区大小的尺度。当$\gamma$值较小时，优化过程倾向于将节点合并成少数几个大的社区；当$\gamma$值较大时，优化过程会惩罚将度数较高的节点合并在一起，从而倾向于发现更多、更小的社区。这种性质对于识别稀有细胞类型尤为重要。通过在一个简化的双社区模型中进行分析，可以推导出决定一个小社区能否被独立解析出来的**临界分辨率**$\gamma_c$。当$\gamma > \gamma_c$时，算法倾向于将小社区分离出来；反之，则会将其与大社区合并[@problem_id:4324373]。因此，在实践中，通过调整$\gamma$值，研究者可以探索不同粒度下的细胞类型结构。

#### 可视化与解释：[t-SNE](@entry_id:276549) 与 UMAP 的内在机制

为了直观地探索和注释聚类结果，研究者们通常会将高维的单细胞数据投影到二维或三维空间中进行可视化。**t-分布随机邻域嵌入**（[t-SNE](@entry_id:276549)）和**均匀流形近似与投影**（UMAP）是目前最流行的两种[非线性降维](@entry_id:636435)方法。然而，对它们的输出进行正确解读，需要理解其背后的数学原理和优化目标。

这两种方法都致力于在低维空间中保持高维数据中的**局部邻域结构**，但它们实现这一目标的方式和侧重点有所不同[@problem_id:4324309]。

**[t-SNE](@entry_id:276549)** 的优化目标是最小化高维空间中点对的相似性分布$P$与低维空间中点对的相似性分布$Q$之间的**Kullback–Leibler (KL)散度**，$D_{\mathrm{KL}}(P \| Q) = \sum_{i,j} p_{ij} \log \left( \frac{p_{ij}}{q_{ij}} \right)$。[KL散度](@entry_id:140001)的不对称性使得该目标函数对“错误地将高维空间中的近邻点在低维空间中分离开”（即$p_{ij}$大而$q_{ij}$小）的情况给予非常大的惩罚。然而，对于“错误地将高维空间中的远距离点在低维空间中拉近”（即$p_{ij}$小而$q_{ij}$大）的情况，其惩罚则很小。这导致[t-SNE](@entry_id:276549)能够极好地保留微观的聚类结构，但会完全牺牲**全局结构**。因此，[t-SNE](@entry_id:276549)图中不同聚类之间的距离和相对位置是毫无意义的，不应被解释为它们之间的生物学关系远近。此外，[t-SNE](@entry_id:276549)会倾向于使不同大小的聚类在图上看起来面积相近，因此聚类的面积也不能反映细胞数量的多少。

**UMAP** 的优化目标是最小化高维模糊图结构$P$和低维模糊图结构$Q$之间的**交叉熵**（cross-entropy），其形式为 $CE(P,Q) = - \sum_{i,j} \left[ p_{ij} \log(q_{ij}) + (1 - p_{ij}) \log(1 - q_{ij}) \right]$。这个目标函数包含两个部分：第一部分$p_{ij} \log(q_{ij})$（吸[引力](@entry_id:189550)）与[t-SNE](@entry_id:276549)的目标类似，鼓励将高维近邻放在一起；关键在于第二部分$(1 - p_{ij}) \log(1 - q_{ij})$（排斥力），它对高维空间中非近邻的点（$p_{ij}$小）在低维空间中被拉近（$q_{ij}$大）的情况给予了明确的惩罚。正是这个排斥项的存在，使得UMAP在保留局部结构的同时，比[t-SNE](@entry_id:276549)更好地维持了数据的全局拓扑结构，例如连续的分化轨迹。尽管如此，UMAP[图中的距离](@entry_id:276146)和[分支长度](@entry_id:177486)同样不具备严格的度量意义，不应被用于定量的距离比较。此外，UMAP的输出对超参数（如近邻数$k$）敏感，一个过小的$k$值可能会人为地撕裂一个连续的生物学过程，如细胞周期，形成看似分离的岛屿[@problem_id:4324309]。

### 有监督与半监督细胞注释

[无监督聚类](@entry_id:168416)提供了细胞的分组，但这些分组本身没有生物学意义。下一步是为这些聚类赋予明确的细胞类型标签，即**注释**（annotation）。这个过程可以依赖已知的生物学知识，也可以利用已有的带标签的参考数据集。

#### 基于标记基因的注释

最经典和最可靠的注释方法是识别每个聚类特异性高表达的**标记基因**（marker genes），并根据这些基因的功能和已知表达模式来确定细胞类型。

##### 标记基因的统计发现

寻找标记基因本质上是一个**[差异表达分析](@entry_id:266370)**（differential expression analysis）问题：比较一个聚类中的细胞与所有其他细胞的基因表达水平，找出表达量有统计学显著差异的基因。

由于单细胞RNA测序数据是计数值，并且具有过离散（overdispersion，即方差大于均值）的特性，**负二项分布广义线性模型**（Negative Binomial Generalized Linear Model, NB-GLM）是进行[差异表达分析](@entry_id:266370)的强大框架[@problem_id:4324400]。对于某个特定基因，其在细胞$i$中的计数值$Y_i$可以被建模为：
$$
Y_i \sim \text{NB}(\mu_i, \alpha)
$$
其中，均值$\mu_i$通过一个[对数连接函数](@entry_id:163146)（log link）与预测变量关联，同时将细胞特异的文库大小因子$s_i$作为**偏移量**（offset）纳入模型：
$$
\ln(\mu_i) = \ln(s_i) + \beta_0 + \beta_1 G_i
$$
这里，$G_i$是一个指示变量，如果细胞$i$属于我们感兴趣的聚类，则$G_i=1$，否则$G_i=0$。模型中的$\beta_0$和$\beta_1$是需要估计的系数。通过对模型的对数似然函数求导，可以求解这些系数。

这种模型的一个关键优势在于其系数的可解释性。在控制了文库大小的影响后，系数$\beta_1$直接代表了目标聚类（$G=1$）与背景细胞（$G=0$）之间基因表达的**[对数倍数变化](@entry_id:272578)**（log-fold change, LFC）。即，$\text{LFC} = \ln(\mu_{G=1}/\mu_{G=0}) = \beta_1$[@problem_id:4324400]。具有较大正值$\beta_1$且统计显著（[p值](@entry_id:136498)较小）的基因，就是该聚类的候选标记基因。

##### 评估标记基因组合的性能

在实践中，单个标记基因可能不足以明确定义一个细胞类型。通常需要一个标记基因组合（marker panel）。评估这样一个组合的性能，就像评估一个诊断测试一样，需要用到**灵敏度**（sensitivity）和**特异性**（specificity）等指标[@problem_id:4324385]。

-   **灵敏度**：正确识别出目标细胞类型的概率，即$P(\text{测试阳性} | \text{真为目标类型})$。
-   **特异性**：正确识别出非目标细胞类型的概率，即$P(\text{测试阴性} | \text{真为非目标类型})$。

然而，在实际应用中，我们更关心的是**阳性预测值**（Positive Predictive Value, PPV），即一个被测试为阳性的细胞，它确实是目标类型的概率：$P(\text{真为目标类型} | \text{测试阳性})$。根据**贝叶斯定理**，PPV不仅取决于测试的灵敏度和特异性，还强烈地依赖于目标细胞类型在组织中的**基础比率**（base rate）或**患病率**（prevalence）$p$。
$$
\text{PPV} = \frac{\text{灵敏度} \cdot p}{\text{灵敏度} \cdot p + (1-\text{特异性}) \cdot (1-p)}
$$
这个关系表明，即使一个标记基因组合具有很高的灵敏度和特异性，如果目标细胞类型非常稀有（$p$很小），其PPV也可能相当低。这意味着大部分被识别为“阳性”的细胞实际上可能是[假阳性](@entry_id:635878)。这个原理对于设计和解释针对稀有细胞类型的分类器至关重要[@problem_id:4324385]。

#### 基于参考图谱的自动注释：标签传播

当存在一个已经精确注释过的参考数据集（或“图谱”）时，我们可以利用它来自动注释一个新的、未标记的数据集。一种强大的方法是**标签传播**（label propagation），它在整合了参考数据和新数据的细胞-细胞相似性图上进行。

其核心思想是，标签信息应该从已标记的细胞“平滑地”扩散到图上未标记的近邻细胞。这可以被严谨地表述为一个能量最小化问题。我们希望为所有细胞$i$找到一个分数$f_i$，使得相邻且相似的细胞具有相近的分数。这等价于最小化图上的**[狄利克雷能量](@entry_id:276589)**（Dirichlet energy）$E(\mathbf{f}) = \frac{1}{2}\sum_{i,j} w_{ij} (f_{i} - f_{j})^{2} = \frac{1}{2}\mathbf{f}^{\top}\mathbf{L}\mathbf{f}$，其中$\mathbf{L}$是图的**[拉普拉斯矩阵](@entry_id:152110)**（Graph Laplacian）。

在一个半监督的设定中，我们有一小组标签已知的细胞$\mathcal{L}$，其分数为$\mathbf{y}_\ell$。在**硬约束**（hard-constraint）下，我们要求未标记细胞的分数$\mathbf{f}_u$在最小化能量的同时，精确匹配已知标签（即$\mathbf{f}_\ell = \mathbf{y}_\ell$）。这个问题的解是一个**[调和函数](@entry_id:746864)**（harmonic function），可以通过求解一个[线性方程组](@entry_id:140416)得到：$\mathbf{f}_{u} = -\mathbf{L}_{uu}^{-1} \mathbf{L}_{u \ell} \mathbf{y}_{\ell}$，其中$\mathbf{L}_{uu}$和$\mathbf{L}_{u\ell}$是[拉普拉斯矩阵](@entry_id:152110)根据已标记和未标记节点划分得到的子块[@problem_id:4324321]。

在更现实的**软约束**（soft-constraint）场景中，我们允许最终的标签与初始的参考标签存在一定的偏差（例如，当参考标签可能不完全准确时）。这通过一个**吉洪诺夫正则化**（Tikhonov-regularized）目标函数来实现：
$$
\min_{\mathbf{f}} E_{\alpha}(\mathbf{f}) = \mathbf{f}^{\top}\mathbf{L}\,\mathbf{f} + \alpha \|\mathbf{f} - \mathbf{y}\|_{2}^{2}
$$
其中$\mathbf{y}$是包含初始标签信息的向量，$\alpha > 0$是[正则化参数](@entry_id:162917)，权衡了[标签平滑](@entry_id:635060)度（第一项）和与初始标签的保真度（第二项）。

这个问题的解可以通过**谱图理论**（spectral graph theory）来深刻理解。解$\mathbf{f}^{\star}$可以表示为对初始标签向量$\mathbf{y}$应用一个滤波器。在图的傅里叶域（由拉普拉斯矩阵的特征向量定义）中，这个滤波器对每个频率（由特征值$\lambda$表示）的增益为$g(\lambda) = \frac{\alpha}{\lambda + \alpha}$[@problem_id:4324321]。这是一个**低通滤波器**（low-pass filter）：它强烈衰减与大特征值（高图频率，即在图上剧烈变化的信号）相关的模式，而保留与小特征值（低图频率，即在图上平滑变化的信号）相关的模式。这直观地解释了标签传播是如何通过抑制局部噪声和不一致性，在图上实现信息的平滑扩散。

#### 确保[本体论](@entry_id:264049)一致性：层次化注释

最终的细胞注释不仅应是准确的，还应是**一致的**，即符合公认的生物学知识体系。**细胞[本体论](@entry_id:264049)**（Cell Ontology, CO）提供了一个描述细胞类型之间关系的标准化框架，其结构是一个**[有向无环图](@entry_id:164045)**（Directed Acyclic Graph, DAG）。在这个图中，边代表了“is a”的关系（例如，“[CD4+ T细胞](@entry_id:170396)” is a “[T细胞](@entry_id:138090)”）。

当我们将计算出的标签映射到CO时，必须强制执行这种层次结构。例如，如果一个细胞被注释为“CD4-阳性，α-β [T细胞](@entry_id:138090)”，那么它必须同时也被隐式地认为是“α-β [T细胞](@entry_id:138090)”、“[T细胞](@entry_id:138090)”和“淋巴细胞”。

这个过程可以被建模为一个**约束优化**问题[@problem_id:4324328]。假设一个分类器为每个细胞提供了一组候选的自由文本标签及其概率，而一个相似性函数$\phi$将这些文本标签与CO中的术语联系起来。我们的目标是为每个细胞选择一个唯一的**[叶节点](@entry_id:266134)**（leaf node，即最具体的术语），同时最大化一个结合了分类器概率和语义相似性的分数。

为了强制执行层次一致性，我们引入两组[二元变量](@entry_id:162761)：$y_v \in \{0, 1\}$表示是否选择[叶节点](@entry_id:266134)$v$作为最终注释；$x_u \in \{0, 1\}$表示术语$u$是否被（显式或隐式地）选中。一致性可以通过以下[线性约束](@entry_id:636966)来保证：
$$
x_u \ge y_v, \quad \text{对于所有叶节点 } v \text{ 及其所有祖先 } u \in \mathcal{A}(v)
$$
这个约束确保了只要一个[叶节点](@entry_id:266134)$y_v$被选中（$y_v=1$），其所有祖先$u$的[指示变量](@entry_id:266428)$x_u$也必须为$1$。

整个问题可以被表述为一个[整数线性规划](@entry_id:636600)问题：最大化一个基于证据的[得分函数](@entry_id:164520)，同时满足“选择一个[叶节点](@entry_id:266134)”（$\sum_{v \in \mathcal{L}} y_v = 1$）和上述的层次一致性约束。通过这种方式，我们可以将[机器学习模型](@entry_id:262335)的概率性输出与生物学知识库的确定性逻辑结构相结合，产生出既准确又符合生物学常识的细胞类型注释[@problem_id:4324328]。