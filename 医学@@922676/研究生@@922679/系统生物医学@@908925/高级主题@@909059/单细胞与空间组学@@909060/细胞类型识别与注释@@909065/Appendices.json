{"hands_on_practices": [{"introduction": "在进行任何细胞类型鉴定之前，确保数据质量是至关重要的一步。本练习将指导您从第一性原理出发，为双细胞（doublets）这一常见的技术伪影建立一个生成模型，并推导出一种基于似然比检验的检测方法。通过这个实践[@problem_id:4324320]，您将深入理解许多现代双细胞检测工具背后的核心统计思想。", "problem": "在单细胞RNA测序 (scRNA-seq) 中，细胞类型的鉴定和注释通常依赖于一个基于分子取样的基因计数生成模型：从一个细胞中捕获转录本并进行测序，从而得到每个基因的计数。一个经过充分检验的出发点是将基因水平的计数建模为独立的泊松随机变量，其速率与按文库大小参数缩放的细胞转录组谱成正比。双细胞是一种技术性产物，其中两个细胞被一起捕获并当作一个细胞进行测序；在这种情况下，观察到的图谱预计是两个单细胞图谱的凸组合。考虑一个双基因系统，其包含两种已知细胞类型（标记为A和B）的参考图谱。设参考图谱为基因上的概率向量，记作 $q_{\\mathrm{A}} = (q_{\\mathrm{A},1}, q_{\\mathrm{A},2})$ 和 $q_{\\mathrm{B}} = (q_{\\mathrm{B},1}, q_{\\mathrm{B},2})$，每个向量都满足 $q_{\\mathrm{A},1} + q_{\\mathrm{A},2} = 1$ 和 $q_{\\mathrm{B},1} + q_{\\mathrm{B},2} = 1$。假设一个观察到的细胞其基因计数为 $x = (x_{1}, x_{2})$，其中 $x_{1}, x_{2} \\in \\mathbb{N}$，总计数为 $n = x_{1} + x_{2}$。在单细胞模型下，对于某个 $k \\in \\{\\mathrm{A}, \\mathrm{B}\\}$ 和未知的文库大小 $s > 0$，基因 $g \\in \\{1,2\\}$ 的计数 $x_{g} \\sim \\mathrm{Poisson}(s \\, q_{k,g})$ 且在各基因间独立。在双细胞模型下，对于某个未知的混合权重 $\\alpha \\in [0,1]$ 和未知的文库大小 $s > 0$，基因计数 $x_{g} \\sim \\mathrm{Poisson}(s \\, p_{g}(\\alpha))$ 且独立，其中 $p(\\alpha) = \\alpha \\, q_{\\mathrm{A}} + (1 - \\alpha) \\, q_{\\mathrm{B}}$。所有的对数均为自然对数。\n  \n从这些假设出发，不使用任何现成的双细胞检测公式，推导出单细胞模型和双细胞模型下的对数似然，求出每个模型中冗余参数文库大小 $s$ 的最大似然估计量，并推导出仅用图谱概率表示的剖面对数似然。然后，对于具体的数据和参考 $q_{\\mathrm{A}} = (0.8, 0.2)$、$q_{\\mathrm{B}} = (0.2, 0.8)$ 和 $x = (8, 8)$，执行以下步骤：\n\n1. 通过选择 A 或 B 中更有可能的一个，确定最大化的单细胞对数似然。\n2. 通过对 $\\alpha \\in [0,1]$ 和 $s > 0$ 进行优化，确定最大化的双细胞对数似然。\n3. 将用于检验单细胞模型（原假设）与双细胞模型（备择假设）的似然比检验 (LRT) 统计量定义为最大化的双细胞和单细胞对数似然之差的 2 倍。为给定的 $q_{\\mathrm{A}}$、$q_{\\mathrm{B}}$ 和 $x$ 计算此统计量。\n\n将你的最终答案表示为一个等于LRT统计量的无量纲实数，四舍五入到四位有效数字。无需其他输出。", "solution": "问题陈述被评估为有效。它在科学上基于单细胞转录组学的原理，问题提法恰当，有足够信息得出唯一解，并用客观、正式的语言表述。因此，我们可以进行推导和计算。\n\n首先，我们推导对数似然和文库大小参数 $s$ 的最大似然估计量 (MLE) 的一般表达式。\n\n设观察到的基因计数为 $x = (x_1, x_2)$，总计数为 $n = x_1 + x_2$。设一个一般的细胞图谱由概率向量 $\\theta = (\\theta_1, \\theta_2)$ 给出，其中 $\\theta_1 + \\theta_2 = 1$。对于基因 $g \\in \\{1, 2\\}$，其计数 $x_g$ 被建模为独立的泊松随机变量：\n$$x_g \\sim \\mathrm{Poisson}(s \\theta_g)$$\n似然函数 $L(s, \\theta | x)$ 是观察到 $x_1$ 和 $x_2$ 的概率的乘积：\n$$L(s, \\theta | x) = \\frac{\\exp(-s \\theta_1) (s \\theta_1)^{x_1}}{x_1!} \\cdot \\frac{\\exp(-s \\theta_2) (s \\theta_2)^{x_2}}{x_2!}$$\n这可以通过合并项来简化：\n$$L(s, \\theta | x) = \\frac{\\exp(-s(\\theta_1 + \\theta_2)) s^{x_1+x_2} \\theta_1^{x_1} \\theta_2^{x_2}}{x_1! x_2!}$$\n由于 $\\theta_1 + \\theta_2 = 1$ 且 $n = x_1 + x_2$，似然函数变为：\n$$L(s, \\theta | x) = \\frac{\\exp(-s) s^n \\theta_1^{x_1} \\theta_2^{x_2}}{x_1! x_2!}$$\n对数似然，记作 $\\ell(s, \\theta | x)$，是似然函数的自然对数：\n$$\\ell(s, \\theta | x) = -s + n \\ln(s) + x_1 \\ln(\\theta_1) + x_2 \\ln(\\theta_2) - \\ln(x_1!) - \\ln(x_2!)$$\n为了找到冗余文库大小参数 $s$ 的最大似然估计量(MLE)，我们将 $\\ell$ 对 $s$ 求偏导数并令其为零：\n$$\\frac{\\partial \\ell}{\\partial s} = -1 + \\frac{n}{s} = 0$$\n这就得到了 $s$ 的最大似然估计量，我们将其记作 $\\hat{s}$：\n$$\\hat{s} = n$$\n将 $\\hat{s} = n$ 代回到对数似然函数中，得到剖面对数似然，它仅依赖于图谱概率 $\\theta$：\n$$\\ell_{profile}(\\theta | x) = \\ell(\\hat{s}, \\theta | x) = -n + n \\ln(n) + x_1 \\ln(\\theta_1) + x_2 \\ln(\\theta_2) - \\ln(x_1!) - \\ln(x_2!)$$\n项 $-n + n \\ln(n) - \\ln(x_1!) - \\ln(x_2!)$ 相对于细胞图谱参数是一个常数。我们用 $C$ 表示这个常数。\n$$\\ell_{profile}(\\theta | x) = C + x_1 \\ln(\\theta_1) + x_2 \\ln(\\theta_2)$$\n现在我们将这个通用框架应用于给定数据的单细胞和双细胞模型。\n\n具体数据为 $q_{\\mathrm{A}} = (0.8, 0.2)$、$q_{\\mathrm{B}} = (0.2, 0.8)$ 和 $x = (8, 8)$。根据数据，我们有 $x_1 = 8$，$x_2 = 8$，总计数为 $n = x_1 + x_2 = 16$。对于两个模型，文库大小的最大似然估计量均为 $\\hat{s} = n = 16$。\n\n1. 最大化的单细胞对数似然\n在单细胞模型下，细胞类型为 A 或 B。图谱 $\\theta$ 为 $q_{\\mathrm{A}}$ 或 $q_{\\mathrm{B}}$。我们计算每种情况下的剖面对数似然，并取最大值。\n对于类型 A, $\\theta = q_{\\mathrm{A}} = (0.8, 0.2)$:\n$$\\ell_{singlet, \\mathrm{A}} = C + x_1 \\ln(q_{\\mathrm{A},1}) + x_2 \\ln(q_{\\mathrm{A},2}) = C + 8 \\ln(0.8) + 8 \\ln(0.2) = C + 8 \\ln(0.8 \\times 0.2) = C + 8 \\ln(0.16)$$\n对于类型 B, $\\theta = q_{\\mathrm{B}} = (0.2, 0.8)$:\n$$\\ell_{singlet, \\mathrm{B}} = C + x_1 \\ln(q_{\\mathrm{B},1}) + x_2 \\ln(q_{\\mathrm{B},2}) = C + 8 \\ln(0.2) + 8 \\ln(0.8) = C + 8 \\ln(0.2 \\times 0.8) = C + 8 \\ln(0.16)$$\n两种对数似然是相同的。因此，最大化的单细胞对数似然为：\n$$\\ell_{singlet, max} = \\max(\\ell_{singlet, \\mathrm{A}}, \\ell_{singlet, \\mathrm{B}}) = C + 8 \\ln(0.16)$$\n\n2. 最大化的双细胞对数似然\n在双细胞模型下，图谱是一个混合体 $p(\\alpha) = \\alpha q_{\\mathrm{A}} + (1 - \\alpha) q_{\\mathrm{B}}$，其中 $\\alpha \\in [0,1]$。\n$p(\\alpha)$ 的分量是：\n$$p_1(\\alpha) = \\alpha q_{\\mathrm{A},1} + (1-\\alpha) q_{\\mathrm{B},1} = \\alpha(0.8) + (1-\\alpha)(0.2) = 0.6\\alpha + 0.2$$\n$$p_2(\\alpha) = \\alpha q_{\\mathrm{A},2} + (1-\\alpha) q_{\\mathrm{B},2} = \\alpha(0.2) + (1-\\alpha)(0.8) = 0.8 - 0.6\\alpha$$\n双细胞模型的剖面对数似然是 $\\alpha$ 的函数：\n$$\\ell_{doublet}(\\alpha) = C + x_1 \\ln(p_1(\\alpha)) + x_2 \\ln(p_2(\\alpha)) = C + 8 \\ln(0.6\\alpha + 0.2) + 8 \\ln(0.8 - 0.6\\alpha)$$\n为了找到最大化的双细胞对数似然，我们必须找到使 $\\ell_{doublet}(\\alpha)$ 最大化的 $\\alpha \\in [0,1]$ 的值。这等价于最大化项 $V(\\alpha) = 8 \\ln(p_1(\\alpha)) + 8 \\ln(p_2(\\alpha))$。\n$$\\frac{dV}{d\\alpha} = 8 \\left( \\frac{0.6}{0.6\\alpha + 0.2} - \\frac{0.6}{0.8 - 0.6\\alpha} \\right)$$\n将导数设为零：\n$$\\frac{0.6}{0.6\\alpha + 0.2} = \\frac{0.6}{0.8 - 0.6\\alpha} \\implies 0.6\\alpha + 0.2 = 0.8 - 0.6\\alpha$$\n$$1.2\\alpha = 0.6 \\implies \\hat{\\alpha} = 0.5$$\n由于 $\\hat{\\alpha}=0.5$ 在有效范围 $[0,1]$ 内，它是 $\\alpha$ 的最大似然估计量。我们在 $\\hat{\\alpha} = 0.5$ 处评估图谱：\n$$p_1(0.5) = 0.6(0.5) + 0.2 = 0.3 + 0.2 = 0.5$$\n$$p_2(0.5) = 0.8 - 0.6(0.5) = 0.8 - 0.3 = 0.5$$\n将 $\\hat{\\alpha}=0.5$ 代入 $\\ell_{doublet}(\\alpha)$ 得到最大化的双细胞对数似然：\n$$\\ell_{doublet, max} = C + 8 \\ln(0.5) + 8 \\ln(0.5) = C + 16 \\ln(0.5)$$\n\n3. 似然比检验 (LRT) 统计量\nLRT 统计量 $\\Lambda$ 定义为最大化的双细胞对数似然与最大化的单细胞对数似然之差的 2 倍。\n$$\\Lambda = 2 (\\ell_{doublet, max} - \\ell_{singlet, max})$$\n代入上面推导出的表达式：\n$$\\Lambda = 2 \\left( (C + 16 \\ln(0.5)) - (C + 8 \\ln(0.16)) \\right)$$\n常数 $C$ 相互抵消：\n$$\\Lambda = 2 (16 \\ln(0.5) - 8 \\ln(0.16)) = 32 \\ln(0.5) - 16 \\ln(0.16)$$\n使用对数性质 $\\ln(a^b) = b\\ln(a)$ 和 $\\ln(a) - \\ln(b) = \\ln(a/b)$：\n$$\\Lambda = 16 (2 \\ln(0.5) - \\ln(0.16)) = 16 (\\ln(0.5^2) - \\ln(0.16))$$\n$$\\Lambda = 16 (\\ln(0.25) - \\ln(0.16)) = 16 \\ln\\left(\\frac{0.25}{0.16}\\right)$$\n这可以简化为：\n$$\\Lambda = 16 \\ln\\left(\\frac{25}{16}\\right)$$\n现在我们计算其数值：\n$$\\Lambda = 16 \\ln(1.5625) \\approx 16 \\times 0.4462871 \\approx 7.1405936$$\n四舍五入到四位有效数字，我们得到 $7.141$。", "answer": "$$\\boxed{7.141}$$", "id": "4324320"}, {"introduction": "单细胞数据中的变异不仅来自技术因素，也源于细胞周期等生物学过程，这些过程可能掩盖真实的细胞类型特征。本练习将向您展示如何使用线性回归来“校正”这些混杂效应，并从几何角度推导评估这种校正是否会损害真实生物信号的判据[@problem_id:4324318]。这有助于您在数据预处理中做出更明智的决策。", "problem": "考虑单细胞核糖核酸测序 (scRNA-seq) 的测量值，这些测量值被组织成一个矩阵 $X \\in \\mathbb{R}^{n \\times p}$，其中 $n$ 是细胞数量，$p$ 是基因数量。$X$ 的行代表细胞，列代表基因。为了识别和注释细胞类型，人们通常希望去除由细胞周期引起的变异，因为这种变异可能会混淆特定类型的信号。设 $S \\in \\mathbb{R}^{n \\times q}$ 是一个包含 $q$ 个细胞水平协变量的矩阵，用于量化细胞周期状态（例如，$q=2$ 表示 $\\mathrm{G1/S}$ 和 $\\mathrm{G2/M}$ 程序的得分），并设 $\\mathbf{1} \\in \\mathbb{R}^{n}$ 表示元素全为1的截距向量。定义设计矩阵 $Z = [\\mathbf{1}\\;\\;S] \\in \\mathbb{R}^{n \\times (q+1)}$。假设 $X$ 已经被转换到一个适合线性效应的尺度上，并且每个基因在细胞间的表达变异可以分解为截距、细胞周期协变量和残差的加性贡献。\n\n仅从普通最小二乘法 (OLS)作为残差平方和最小化器的定义以及 $\\mathbb{R}^{n}$ 中欧几里得投影的基本性质出发, 完成以下任务：\n\n1. 对于由 $j \\in \\{1,\\dots,p\\}$ 索引的任意基因，推导细胞表达向量 $X_{\\cdot j} \\in \\mathbb{R}^{n}$ 对 $Z$ 的列进行回归的 OLS 解，然后获得一个矩阵表达式，用于表示对所有基因同时去除细胞周期效应后的残差化表达矩阵 $\\tilde{X} \\in \\mathbb{R}^{n \\times p}$。\n\n2. 为了探究何时去除细胞周期效应是适当的，以及何时对真实的类型差异有害，设 $T \\in \\mathbb{R}^{n}$ 为一个中心化的细胞类型对比向量（例如，$T$ 可能表示两种类型，其元素总和为零），代表细胞空间中真实类型身份变化的一个方向。设 $P_{S}$ 表示到 $S$ 的列空间上的正交投影算子，并设 $\\theta \\in [0,\\pi/2]$ 是向量 $T$ 与由 $S$ 的列所张成的子空间之间的夹角，定义为 $\\cos(\\theta) = \\|P_{S}T\\|/\\|T\\|$。仅使用欧几里得空间中投影和夹角的定义，推导通过回归去除（并减去）细胞周期协变量后，从 $T$ 的真实类型方差中移除的比例 $f(\\theta)$。\n\n请以 $f(\\theta)$ 的闭式解析表达式形式给出你的最终答案。不需要进行数值舍入。如果你引入任何首字母缩略词，请在首次使用时给出其全称并在括号中注明缩略词。", "solution": "所提出的问题具有科学依据、问题明确且客观。它描述了系统生物医学中的一个标准且有效的程序，即使用线性回归校正单细胞核糖核酸测序 (scRNA-seq) 数据中的混杂变量。该问题使用精确的数学语言和线性代数中的定义进行阐述，并包含足够的信息来推导出唯一且有意义的解。因此，该问题被认为是有效的，下面提供了完整的解答。\n\n该问题分为两部分。第一部分要求在回归去除混杂效应后推导残差化表达矩阵。第二部分要求计算此过程从特定信号向量中移除的方差比例。\n\n1.  残差化表达矩阵 $\\tilde{X}$ 的推导。\n\n设 $X_{\\cdot j} \\in \\mathbb{R}^{n}$ 表示任意基因 $j$ 的表达向量，其中 $j \\in \\{1, \\dots, p\\}$。该基因表达作为截距和细胞周期协变量的函数的线性模型由下式给出：\n$$X_{\\cdot j} = Z \\beta_j + \\epsilon_j$$\n其中 $Z = [\\mathbf{1}\\;\\;S] \\in \\mathbb{R}^{n \\times (q+1)}$ 是设计矩阵，$\\beta_j \\in \\mathbb{R}^{q+1}$ 是基因 $j$ 的回归系数向量，$\\epsilon_j \\in \\mathbb{R}^{n}$ 是残差向量。\n\n普通最小二乘法 (OLS) 旨在找到估计值 $\\hat{\\beta}_j$，以最小化残差平方和 (SSR)，这等同于最小化残差向量 $\\epsilon_j$ 的欧几里得范数的平方。\n$$SSR(\\beta_j) = \\|\\epsilon_j\\|^2 = \\|X_{\\cdot j} - Z\\beta_j\\|^2$$\n为了找到最小值，我们可以展开范数的平方并对 $\\beta_j$ 求导。\n$$SSR(\\beta_j) = (X_{\\cdot j} - Z\\beta_j)^T (X_{\\cdot j} - Z\\beta_j) = X_{\\cdot j}^T X_{\\cdot j} - 2 X_{\\cdot j}^T Z \\beta_j + \\beta_j^T Z^T Z \\beta_j$$\nSSR 相对于 $\\beta_j$ 的梯度是：\n$$\\frac{\\partial(SSR)}{\\partial \\beta_j} = -2 Z^T X_{\\cdot j} + 2 Z^T Z \\beta_j$$\n将梯度设为零以找到最小值，得到正规方程：\n$$Z^T Z \\hat{\\beta}_j = Z^T X_{\\cdot j}$$\n假设矩阵 $Z^T Z$ 是可逆的（如果 $Z$ 的列是线性无关的，则该假设成立，这是 OLS 中的一个标准假设），我们可以求解系数的 OLS 估计值：\n$$\\hat{\\beta}_j = (Z^T Z)^{-1} Z^T X_{\\cdot j}$$\n拟合值向量 $\\hat{X}_{\\cdot j}$ 是原始数据向量 $X_{\\cdot j}$ 在 $Z$ 的列空间 $\\mathrm{col}(Z)$ 上的投影。\n$$\\hat{X}_{\\cdot j} = Z \\hat{\\beta}_j = Z (Z^T Z)^{-1} Z^T X_{\\cdot j}$$\n我们将到 $\\mathrm{col}(Z)$ 上的正交投影矩阵定义为 $P_Z = Z (Z^T Z)^{-1} Z^T$。因此，拟合值为 $\\hat{X}_{\\cdot j} = P_Z X_{\\cdot j}$。\n\n基因 $j$ 的残差向量，代表去除 $Z$ 中协变量效应后的基因表达，是观测值与拟合值之间的差：\n$$\\tilde{X}_{\\cdot j} = X_{\\cdot j} - \\hat{X}_{\\cdot j} = X_{\\cdot j} - P_Z X_{\\cdot j} = (I - P_Z) X_{\\cdot j}$$\n其中 $I$ 是 $n \\times n$ 的单位矩阵。矩阵 $I - P_Z$ 是到与 $\\mathrm{col}(Z)$ 正交的子空间上的正交投影矩阵。\n\n为了获得完整的残差化表达矩阵 $\\tilde{X} \\in \\mathbb{R}^{n \\times p}$，我们将此操作同时应用于每个基因（即 $X$ 的每一列）。这可以用一个单一的矩阵方程表示：\n$$\\tilde{X} = X - P_Z X = (I - P_Z) X$$\n\n2.  从真实类型对比向量 $T$ 中移除的方差比例的推导。\n\n我们被要求找出在一个中心化对比向量 $T \\in \\mathbb{R}^n$ 中，通过回归去除细胞周期协变量（即矩阵 $S \\in \\mathbb{R}^{n \\times q}$ 的列）后，被移除的真实类型方差的比例 $f(\\theta)$。\n\n在回归分析的几何背景下，一个向量的“方差”对应于其平方和。由于向量 $T$ 是中心化的（其元素总和为零），它的总平方和就是其欧几里得范数的平方，即 $\\|T\\|^2$。\n\n从向量 $T$ 中“回归去除” $S$ 中协变量效应的过程，意味着将 $T$ 投影到 $S$ 的列空间上，记为 $\\mathrm{col}(S)$。得到的拟合值向量，代表了 $T$ 中可被细胞周期协变量解释（并因此被“移除”）的部分，由下式给出：\n$$\\hat{T}_S = P_S T$$\n其中 $P_S$ 是到 $\\mathrm{col}(S)$ 上的正交投影矩阵。\n\n这个被移除分量的方差是其平方和，即 $\\|\\hat{T}_S\\|^2 = \\|P_S T\\|^2$。这个量是 $T$ 对 $S$ 回归中的可解释平方和。由于 $T$ 是中心化的，这是对可解释方差的正确表达式。\n\n$T$ 的总方差中被回归移除的比例，是被移除的方差与总方差的比值：\n$$f = \\frac{\\text{被移除的方差}}{\\text{总方差}} = \\frac{\\|P_S T\\|^2}{\\|T\\|^2}$$\n问题提供了向量 $T$ 与子空间 $\\mathrm{col}(S)$ 之间的夹角 $\\theta \\in [0, \\pi/2]$ 的定义：\n$$\\cos(\\theta) = \\frac{\\|P_S T\\|}{\\|T\\|}$$\n这是一个向量与其在子空间上的投影之间夹角的余弦。对两边进行平方得到：\n$$\\cos^2(\\theta) = \\left( \\frac{\\|P_S T\\|}{\\|T\\|} \\right)^2 = \\frac{\\|P_S T\\|^2}{\\|T\\|^2}$$\n通过直接代入，我们发现被移除的方差比例 $f$ 等于夹角 $\\theta$ 的余弦的平方：\n$$f(\\theta) = \\cos^2(\\theta)$$\n这个结果量化了我们感兴趣的生物信号（$T$）与细胞周期信号（$S$）发生混淆的程度。如果 $T$ 与细胞周期子空间正交（$\\theta = \\pi/2$），那么 $\\cos^2(\\theta) = 0$，没有方差被移除。如果 $T$ 完全位于细胞周期子空间内（$\\theta = 0$），那么 $\\cos^2(\\theta) = 1$，所有方差都被移除，这表明在此模型下，‘真实类型’信号与细胞周期效应无法区分。", "answer": "$$\\boxed{\\cos^2(\\theta)}$$", "id": "4324318"}, {"introduction": "细胞类型注释的最后一步是评估我们模型的性能，尤其是在细胞群体数量极不均衡的现实情况下。本练习将引导您计算宏观（macro）和微观（micro）$F1$分数，并辨析哪种平均方案更能有效评估对稀有细胞类型的识别性能[@problem_id:4324372]。掌握这些评估指标对于客观地衡量和比较不同注释方法的优劣至关重要。", "problem": "在一项单细胞转录组学研究中，一个监督分类器在细胞类型鉴定和注释过程中，将每个细胞分配到四种免疫细胞类型之一：T细胞（$\\mathrm{T}$）、B细胞（$\\mathrm{B}$）、单核细胞（$\\mathrm{Mo}$）和树突状细胞（$\\mathrm{DC}$）。总共有 $400$ 个细胞。真实标签的细胞计数为：$\\mathrm{T}$ 细胞 $250$ 个，$\\mathrm{B}$ 细胞 $100$ 个，$\\mathrm{Mo}$ 细胞 $40$ 个，$\\mathrm{DC}$ 细胞 $10$ 个。得到的混淆矩阵 $M$（行按真实类别 $\\mathrm{T}, \\mathrm{B}, \\mathrm{Mo}, \\mathrm{DC}$ 的顺序索引；列按预测类别以相同顺序索引）如下：\n$$\nM \\;=\\;\n\\begin{pmatrix}\n220  15  10  5 \\\\\n8  85  5  2 \\\\\n4  3  30  3 \\\\\n1  1  3  5\n\\end{pmatrix}.\n$$\n请仅从真阳性、假阳性、假阴性、精确率、召回率和调和平均数的核心定义出发，推导出四个类别中每个类别的F1分数，然后计算宏平均F1分数（各类别F1分数的未加权算术平均值）和微平均F1分数（在计算精确率和召回率之前，汇总所有类别的决策来计算）。将两个最终数值答案四舍五入到 $4$ 位有效数字。在您的推导过程中，请解释在这种情况下，哪种平均方案能更好地反映对稀有细胞类型的性能评估。", "solution": "该问题涉及多类别、单标签分类。基本依据包括以下核心定义。对于给定的类别 $c$：\n- 真阳性（$TP_c$）：类别为 $c$ 的实例被正确预测为 $c$ 的数量。\n- 假阳性（$FP_c$）：被预测为类别 $c$ 但真实类别并非 $c$ 的实例数量。\n- 假阴性（$FN_c$）：真实类别为 $c$ 但未被预测为 $c$ 的实例数量。\n- 精确率（Precision）为 $P_c = \\frac{TP_c}{TP_c + FP_c}$。\n- 召回率（Recall）为 $R_c = \\frac{TP_c}{TP_c + FN_c}$。\n- F1分数是精确率和召回率的调和平均数，根据调和平均数的定义可以写为：\n$$\nF1_c \\;=\\; \\frac{2\\,P_c\\,R_c}{P_c + R_c}.\n$$\n使用 $P_c = \\frac{TP_c}{TP_c + FP_c}$ 和 $R_c = \\frac{TP_c}{TP_c + FN_c}$，通过代入和代数运算可得到等价表达式：\n$$\nF1_c \\;=\\; \\frac{2\\,TP_c}{2\\,TP_c + FP_c + FN_c}.\n$$\n对于宏平均F1分数，我们计算所有类别的 $F1_c$ 的未加权平均值。对于微平均F1分数，我们首先将所有类别的 $TP_c$、$FP_c$ 和 $FN_c$ 相加，得到全局的 $TP$、$FP$ 和 $FN$，然后使用相同的定义计算精确率和召回率，最后计算它们的调和平均数。\n\n我们从混淆矩阵 $M$ 中提取每个类别的 $TP_c$、$FP_c$ 和 $FN_c$。设类别顺序为 $\\mathrm{T}, \\mathrm{B}, \\mathrm{Mo}, \\mathrm{DC}$。对每个类别 $c$：\n- $TP_c$ 是对角线元素 $M_{cc}$。\n- 列和是每个类别的总预测数，行和是每个类别的总真实数。那么，$FP_c$ 等于类别 $c$ 的列和减去 $TP_c$，$FN_c$ 等于类别 $c$ 的行和减去 $TP_c$。\n\n计算行和（真实总数）：$\\mathrm{T}$ 有 $250$，$\\mathrm{B}$ 有 $100$，$\\mathrm{Mo}$ 有 $40$，$\\mathrm{DC}$ 有 $10$；这些与给定的总数相符。计算列和（预测总数）：\n- 预测为 $\\mathrm{T}$：$220 + 8 + 4 + 1 = 233$。\n- 预测为 $\\mathrm{B}$：$15 + 85 + 3 + 1 = 104$。\n- 预测为 $\\mathrm{Mo}$：$10 + 5 + 30 + 3 = 48$。\n- 预测为 $\\mathrm{DC}$：$5 + 2 + 3 + 5 = 15$。\n\n现在计算每个类别的量和各类别F1分数。\n\n对于 $\\mathrm{T}$：\n- $TP_{\\mathrm{T}} = 220$。\n- $FP_{\\mathrm{T}} = 233 - 220 = 13$。\n- $FN_{\\mathrm{T}} = 250 - 220 = 30$。\n- $F1_{\\mathrm{T}} = \\frac{2 \\cdot 220}{2 \\cdot 220 + 13 + 30} = \\frac{440}{483}$。\n\n对于 $\\mathrm{B}$：\n- $TP_{\\mathrm{B}} = 85$。\n- $FP_{\\mathrm{B}} = 104 - 85 = 19$。\n- $FN_{\\mathrm{B}} = 100 - 85 = 15$。\n- $F1_{\\mathrm{B}} = \\frac{2 \\cdot 85}{2 \\cdot 85 + 19 + 15} = \\frac{170}{204} = \\frac{85}{102} = \\frac{5}{6}$。\n\n对于 $\\mathrm{Mo}$：\n- $TP_{\\mathrm{Mo}} = 30$。\n- $FP_{\\mathrm{Mo}} = 48 - 30 = 18$。\n- $FN_{\\mathrm{Mo}} = 40 - 30 = 10$。\n- $F1_{\\mathrm{Mo}} = \\frac{2 \\cdot 30}{2 \\cdot 30 + 18 + 10} = \\frac{60}{88} = \\frac{15}{22}$。\n\n对于 $\\mathrm{DC}$：\n- $TP_{\\mathrm{DC}} = 5$。\n- $FP_{\\mathrm{DC}} = 15 - 5 = 10$。\n- $FN_{\\mathrm{DC}} = 10 - 5 = 5$。\n- $F1_{\\mathrm{DC}} = \\frac{2 \\cdot 5}{2 \\cdot 5 + 10 + 5} = \\frac{10}{25} = \\frac{2}{5}$。\n\n计算宏平均F1分数：\n$$\nF1_{\\mathrm{macro}} \\;=\\; \\frac{1}{4} \\left( \\frac{440}{483} + \\frac{5}{6} + \\frac{15}{22} + \\frac{2}{5} \\right).\n$$\n为进行数值计算，对每一项进行近似：\n- $\\frac{440}{483} \\approx 0.910971$,\n- $\\frac{5}{6} \\approx 0.833333$,\n- $\\frac{15}{22} \\approx 0.681818$,\n- $\\frac{2}{5} = 0.4$。\n和为：$0.910971 + 0.833333 + 0.681818 + 0.4 = 2.826122$。除以 $4$ 得到\n$$\nF1_{\\mathrm{macro}} \\approx 0.7065305.\n$$\n四舍五入到 $4$ 位有效数字：$0.7065$。\n\n对于微平均F1分数，通过对各类别求和来计算全局的 $TP$、$FP$ 和 $FN$：\n- $TP = 220 + 85 + 30 + 5 = 340$。\n- 预测总数为 $400$，所以 $FP = 400 - TP = 60$。根据单标签属性，每个错误分类都为一个预测类别贡献一个 $FP$，并为一个真实类别贡献一个 $FN$，因此 $FN$ 也等于 $60$。\n全局精确率和召回率为\n$$\nP_{\\mathrm{micro}} = \\frac{TP}{TP + FP} = \\frac{340}{340 + 60} = \\frac{340}{400} = \\frac{17}{20} = 0.85,\n$$\n$$\nR_{\\mathrm{micro}} = \\frac{TP}{TP + FN} = \\frac{340}{340 + 60} = \\frac{340}{400} = \\frac{17}{20} = 0.85.\n$$\n因此\n$$\nF1_{\\mathrm{micro}} = \\frac{2\\,P_{\\mathrm{micro}}\\,R_{\\mathrm{micro}}}{P_{\\mathrm{micro}} + R_{\\mathrm{micro}}} = \\frac{2 \\cdot 0.85 \\cdot 0.85}{0.85 + 0.85} = 0.85,\n$$\n或者等价地，\n$$\nF1_{\\mathrm{micro}} = \\frac{2\\,TP}{2\\,TP + FP + FN} = \\frac{680}{800} = \\frac{17}{20} = 0.85.\n$$\n四舍五入到 $4$ 位有效数字：$0.8500$。\n\n关于哪种平均方案更能反映对稀有细胞类型的性能评估，宏平均在计算均值时给予每个类别相同的权重，而与类别流行度无关。在此数据集中，$\\mathrm{DC}$ 和 $\\mathrm{Mo}$ 是稀有细胞类型，分别只有 $10$ 和 $40$ 个细胞，但它们的类别F1分数（$\\frac{2}{5}$ 和 $\\frac{15}{22}$）对 $F1_{\\mathrm{macro}}$ 的贡献与更常见的类别相同。相反，微平均汇总了所有决策，并由常见类别（$\\mathrm{T}$ 和 $\\mathrm{B}$，共计 $350$ 个细胞）主导，从而产生一个较高的 $F1_{\\mathrm{micro}}$，该值主要反映了在丰富类型上的性能。因此，在系统生物医学细胞注释中评估稀有细胞类型的性能时，$F1_{\\mathrm{macro}}$ 比 $F1_{\\mathrm{micro}}$ 更能反映对稀有类别的性能敏感度，而 $F1_{\\mathrm{micro}}$ 主要反映由常见类别主导的整体准确率。", "answer": "$$\\boxed{\\begin{pmatrix}0.7065  0.8500\\end{pmatrix}}$$", "id": "4324372"}]}