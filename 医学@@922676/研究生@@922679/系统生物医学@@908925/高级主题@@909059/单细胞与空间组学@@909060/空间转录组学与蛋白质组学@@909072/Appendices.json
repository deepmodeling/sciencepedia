{"hands_on_practices": [{"introduction": "空间组学研究的一个关键步骤是将分子数据精确地映射到其组织学背景上。这通常需要将不同模态的图像（例如，Slide-seq珠子图和组织学染色图像）进行配准。本实践将引导您通过最小二乘法来求解仿射变换参数，这是一种稳健地对齐两组对应基准点的核心技术 [@problem_id:5062750]。掌握这项技能对于整合多维空间数据、实现从基因表达到组织结构的精确关联至关重要。", "problem": "在转化医学的空间转录组学和蛋白质组学流程中，一个常见的步骤是配准互补的模态，例如将 Slide-seq 珠子图谱配准到苏木精-伊红 (hematoxylin and eosin) 组织学图像上，以便能够对空间基因和蛋白质表达进行联合推断。考虑一个实验，其中荧光基准标记在两种模态中都可见。令珠子图谱坐标表示为 $\\mathbf{x}_i = (x_i, y_i)$，相应的组织学图像坐标表示为 $\\mathbf{u}_i = (u_i, v_i)$，其中 $i = 1, \\dots, n$。假设从珠子空间到组织学空间的映射可以由一个二维仿射变换很好地近似，该变换由一个 $2 \\times 2$ 矩阵 $\\mathbf{A}$ 和一个平移向量 $\\mathbf{t}$ 定义，因此有 $\\mathbf{u}_i \\approx \\mathbf{A}\\mathbf{x}_i + \\mathbf{t}$，其中 $\\mathbf{A}$ 模拟旋转、各向异性缩放和剪切，而 $\\mathbf{t}$ 模拟平移。两个坐标系都以微米为单位进行测量。\n\n从最小二乘目标的定义出发，\n$$\nJ(\\mathbf{A}, \\mathbf{t}) = \\sum_{i=1}^{n} \\left\\| \\mathbf{A}\\mathbf{x}_i + \\mathbf{t} - \\mathbf{u}_i \\right\\|^{2},\n$$\n推导使 $J(\\mathbf{A}, \\mathbf{t})$ 相对于六个未知标量参数 $(\\alpha_{11}, \\alpha_{12}, \\alpha_{21}, \\alpha_{22}, \\tau_{1}, \\tau_{2})$ 最小化的正规方程，其中 $\\mathbf{A} = \\begin{pmatrix} \\alpha_{11}  \\alpha_{12} \\\\ \\alpha_{21}  \\alpha_{22} \\end{pmatrix}$ 且 $\\mathbf{t} = (\\tau_{1}, \\tau_{2})$。然后，使用以下基准点对应关系计算使配准误差平方最小化的参数值：\n\n- $i = 1$: $\\mathbf{x}_1 = (-1, -1)$, $\\mathbf{u}_1 = (6.7, -6.6)$\n- $i = 2$: $\\mathbf{x}_2 = (1, -1)$, $\\mathbf{u}_2 = (8.9, -7.2)$\n- $i = 3$: $\\mathbf{x}_3 = (-1, 1)$, $\\mathbf{u}_3 = (7.1, -4.8)$\n- $i = 4$: $\\mathbf{x}_4 = (1, 1)$, $\\mathbf{u}_4 = (9.3, -5.4)$\n- $i = 5$: $\\mathbf{x}_5 = (-2, 0)$, $\\mathbf{u}_5 = (5.8, -5.4)$\n- $i = 6$: $\\mathbf{x}_6 = (2, 0)$, $\\mathbf{u}_6 = (10.2, -6.6)$\n- $i = 7$: $\\mathbf{x}_7 = (0, -2)$, $\\mathbf{u}_7 = (7.6, -7.8)$\n- $i = 8$: $\\mathbf{x}_8 = (0, 2)$, $\\mathbf{u}_8 = (8.4, -4.2)$\n\n所有坐标 $(x_i, y_i)$ 和 $(u_i, v_i)$ 都以微米表示。请清楚说明您使用的任何假设。将您的最终答案以有序参数元组 $(\\alpha_{11}, \\alpha_{12}, \\alpha_{21}, \\alpha_{22}, \\tau_{1}, \\tau_{2})$ 的形式报告。条目 $\\alpha_{11}, \\alpha_{12}, \\alpha_{21}, \\alpha_{22}$ 是无量纲的；$\\tau_{1}$ 和 $\\tau_{2}$ 以微米表示。如果进行任何数值近似，请将您的值四舍五入到四位有效数字。", "solution": "该问题要求确定一个二维仿射变换的参数，该变换将一组源点 $\\mathbf{x}_i$ 映射到一组对应的目标点 $\\mathbf{u}_i$。该变换由 $\\mathbf{u}_i \\approx \\mathbf{A}\\mathbf{x}_i + \\mathbf{t}$ 给出，参数是矩阵 $\\mathbf{A}$ 的元素和向量 $\\mathbf{t}$。这些参数将通过最小化平方误差之和来找到，这是一个标准的最小二乘问题。\n\n首先，对问题陈述进行验证。\n\n### 第一步：提取已知条件\n- 仿射变换模型为 $\\mathbf{u}_i \\approx \\mathbf{A}\\mathbf{x}_i + \\mathbf{t}$。\n- 坐标向量为 $\\mathbf{x}_i = (x_i, y_i)$ 和 $\\mathbf{u}_i = (u_i, v_i)$。\n- 变换矩阵为 $\\mathbf{A} = \\begin{pmatrix} \\alpha_{11}  \\alpha_{12} \\\\ \\alpha_{21}  \\alpha_{22} \\end{pmatrix}$。\n- 平移向量为 $\\mathbf{t} = (\\tau_{1}, \\tau_{2})$。\n- 目标函数是平方误差之和：$J(\\mathbf{A}, \\mathbf{t}) = \\sum_{i=1}^{n} \\left\\| \\mathbf{A}\\mathbf{x}_i + \\mathbf{t} - \\mathbf{u}_i \\right\\|^{2}$。\n- 共有 $n=8$ 对对应点：\n  - $\\mathbf{x}_1 = (-1, -1), \\mathbf{u}_1 = (6.7, -6.6)$\n  - $\\mathbf{x}_2 = (1, -1), \\mathbf{u}_2 = (8.9, -7.2)$\n  - $\\mathbf{x}_3 = (-1, 1), \\mathbf{u}_3 = (7.1, -4.8)$\n  - $\\mathbf{x}_4 = (1, 1), \\mathbf{u}_4 = (9.3, -5.4)$\n  - $\\mathbf{x}_5 = (-2, 0), \\mathbf{u}_5 = (5.8, -5.4)$\n  - $\\mathbf{x}_6 = (2, 0), \\mathbf{u}_6 = (10.2, -6.6)$\n  - $\\mathbf{x}_7 = (0, -2), \\mathbf{u}_7 = (7.6, -7.8)$\n  - $\\mathbf{x}_8 = (0, 2), \\mathbf{u}_8 = (8.4, -4.2)$\n- 所有坐标都以微米为单位。\n- 最终答案应为有序元组 $(\\alpha_{11}, \\alpha_{12}, \\alpha_{21}, \\alpha_{22}, \\tau_{1}, \\tau_{2})$，如果使用近似，则数值四舍五入到四位有效数字。\n\n### 第二步：使用提取的已知条件进行验证\n该问题具有科学依据，因为通过最小二乘法寻找最优仿射变换是图像配准和数据对齐中的一种标准和基础技术，在空间组学等领域尤其重要。该问题是适定的；它是一个超定的线性最小二乘问题，用 $8$ 个数据点求解 $6$ 个未知参数。考虑到源点 $\\mathbf{x}_i$ 的空间分布，预期会有一个唯一解。问题陈述是客观、完整的，并且不包含任何矛盾或科学上不成立的前提。\n\n### 第三步：结论与行动\n该问题有效。将推导解答。\n\n### 正规方程的推导\n\n目标函数 $J(\\mathbf{A}, \\mathbf{t})$ 可以用标量参数表示：\n$$\nJ(\\alpha_{11}, \\alpha_{12}, \\alpha_{21}, \\alpha_{22}, \\tau_{1}, \\tau_{2}) = \\sum_{i=1}^{n} \\left[ (\\alpha_{11}x_i + \\alpha_{12}y_i + \\tau_1 - u_i)^2 + (\\alpha_{21}x_i + \\alpha_{22}y_i + \\tau_2 - v_i)^2 \\right]\n$$\n该函数可分离为两个独立的部分：\n$$\nJ = J_1(\\alpha_{11}, \\alpha_{12}, \\tau_1) + J_2(\\alpha_{21}, \\alpha_{22}, \\tau_2)\n$$\n其中\n$$\nJ_1 = \\sum_{i=1}^{n} (\\alpha_{11}x_i + \\alpha_{12}y_i + \\tau_1 - u_i)^2\n$$\n$$\nJ_2 = \\sum_{i=1}^{n} (\\alpha_{21}x_i + \\alpha_{22}y_i + \\tau_2 - v_i)^2\n$$\n为了最小化 $J$，我们可以独立地最小化 $J_1$ 和 $J_2$。我们通过将 $J_1$ 对 $\\alpha_{11}$、$\\alpha_{12}$ 和 $\\tau_1$ 的偏导数设为零来找到最小值，对 $J_2$ 也进行类似操作。\n\n对于 $J_1$：\n$$\n\\frac{\\partial J_1}{\\partial \\alpha_{11}} = \\sum_{i=1}^{n} 2(\\alpha_{11}x_i + \\alpha_{12}y_i + \\tau_1 - u_i)x_i = 0\n$$\n$$\n\\frac{\\partial J_1}{\\partial \\alpha_{12}} = \\sum_{i=1}^{n} 2(\\alpha_{11}x_i + \\alpha_{12}y_i + \\tau_1 - u_i)y_i = 0\n$$\n$$\n\\frac{\\partial J_1}{\\partial \\tau_1} = \\sum_{i=1}^{n} 2(\\alpha_{11}x_i + \\alpha_{12}y_i + \\tau_1 - u_i) = 0\n$$\n整理这些方程，得到第一组参数的正规方程：\n$$\n\\alpha_{11}\\left(\\sum x_i^2\\right) + \\alpha_{12}\\left(\\sum x_i y_i\\right) + \\tau_1\\left(\\sum x_i\\right) = \\sum u_i x_i\n$$\n$$\n\\alpha_{11}\\left(\\sum x_i y_i\\right) + \\alpha_{12}\\left(\\sum y_i^2\\right) + \\tau_1\\left(\\sum y_i\\right) = \\sum u_i y_i\n$$\n$$\n\\alpha_{11}\\left(\\sum x_i\\right) + \\alpha_{12}\\left(\\sum y_i\\right) + \\tau_1(n) = \\sum u_i\n$$\n这可以写成矩阵形式：\n$$\n\\begin{pmatrix} \\sum x_i^2  \\sum x_i y_i  \\sum x_i \\\\ \\sum x_i y_i  \\sum y_i^2  \\sum y_i \\\\ \\sum x_i  \\sum y_i  n \\end{pmatrix}\n\\begin{pmatrix} \\alpha_{11} \\\\ \\alpha_{12} \\\\ \\tau_1 \\end{pmatrix} =\n\\begin{pmatrix} \\sum u_i x_i \\\\ \\sum u_i y_i \\\\ \\sum u_i \\end{pmatrix}\n$$\n对 $J_2$ 进行类似的推导，得到第二组正规方程：\n$$\n\\begin{pmatrix} \\sum x_i^2  \\sum x_i y_i  \\sum x_i \\\\ \\sum x_i y_i  \\sum y_i^2  \\sum y_i \\\\ \\sum x_i  \\sum y_i  n \\end{pmatrix}\n\\begin{pmatrix} \\alpha_{21} \\\\ \\alpha_{22} \\\\ \\tau_2 \\end{pmatrix} =\n\\begin{pmatrix} \\sum v_i x_i \\\\ \\sum v_i y_i \\\\ \\sum v_i \\end{pmatrix}\n$$\n这里做出的主要假设是存在唯一解，这要求由各项和组成的 $3 \\times 3$ 矩阵是可逆的。\n\n### 参数计算\n\n我们使用提供的 $n=8$ 个数据点计算所需的各项和。\n- $\\sum_{i=1}^8 x_i = -1 + 1 - 1 + 1 - 2 + 2 + 0 + 0 = 0$\n- $\\sum_{i=1}^8 y_i = -1 - 1 + 1 + 1 + 0 + 0 - 2 + 2 = 0$\n- $\\sum_{i=1}^8 x_i^2 = (-1)^2 + 1^2 + (-1)^2 + 1^2 + (-2)^2 + 2^2 + 0^2 + 0^2 = 12$\n- $\\sum_{i=1}^8 y_i^2 = (-1)^2 + (-1)^2 + 1^2 + 1^2 + 0^2 + 0^2 + (-2)^2 + 2^2 = 12$\n- $\\sum_{i=1}^8 x_i y_i = (-1)(-1) + (1)(-1) + (-1)(1) + (1)(1) + 0 + 0 + 0 + 0 = 0$\n\n因此，$3 \\times 3$ 矩阵为：\n$$\n\\begin{pmatrix} 12  0  0 \\\\ 0  12  0 \\\\ 0  0  8 \\end{pmatrix}\n$$\n该矩阵是对角矩阵，并且显然是可逆的，这证实了唯一解的存在。\n\n接下来，我们计算右侧向量的各项和。\n对于 $(\\alpha_{11}, \\alpha_{12}, \\tau_1)$ 系统：\n- $\\sum u_i = 6.7 + 8.9 + 7.1 + 9.3 + 5.8 + 10.2 + 7.6 + 8.4 = 64.0$\n- $\\sum u_i x_i = 6.7(-1) + 8.9(1) + 7.1(-1) + 9.3(1) + 5.8(-2) + 10.2(2) = -6.7 + 8.9 - 7.1 + 9.3 - 11.6 + 20.4 = 13.2$\n- $\\sum u_i y_i = 6.7(-1) + 8.9(-1) + 7.1(1) + 9.3(1) + 7.6(-2) + 8.4(2) = -6.7 - 8.9 + 7.1 + 9.3 - 15.2 + 16.8 = 2.4$\n\n第一个线性系统是：\n$$\n\\begin{pmatrix} 12  0  0 \\\\ 0  12  0 \\\\ 0  0  8 \\end{pmatrix}\n\\begin{pmatrix} \\alpha_{11} \\\\ \\alpha_{12} \\\\ \\tau_1 \\end{pmatrix} =\n\\begin{pmatrix} 13.2 \\\\ 2.4 \\\\ 64.0 \\end{pmatrix}\n$$\n求解这个对角系统：\n- $12 \\alpha_{11} = 13.2 \\implies \\alpha_{11} = \\frac{13.2}{12} = 1.1$\n- $12 \\alpha_{12} = 2.4 \\implies \\alpha_{12} = \\frac{2.4}{12} = 0.2$\n- $8 \\tau_1 = 64.0 \\implies \\tau_1 = \\frac{64.0}{8} = 8.0$\n\n对于 $(\\alpha_{21}, \\alpha_{22}, \\tau_2)$ 系统：\n- $\\sum v_i = -6.6 - 7.2 - 4.8 - 5.4 - 5.4 - 6.6 - 7.8 - 4.2 = -48.0$\n- $\\sum v_i x_i = -6.6(-1) - 7.2(1) - 4.8(-1) - 5.4(1) - 5.4(-2) - 6.6(2) = 6.6 - 7.2 + 4.8 - 5.4 + 10.8 - 13.2 = -3.6$\n- $\\sum v_i y_i = -6.6(-1) - 7.2(-1) - 4.8(1) - 5.4(1) - 7.8(-2) - 4.2(2) = 6.6 + 7.2 - 4.8 - 5.4 + 15.6 - 8.4 = 10.8$\n\n第二个线性系统是：\n$$\n\\begin{pmatrix} 12  0  0 \\\\ 0  12  0 \\\\ 0  0  8 \\end{pmatrix}\n\\begin{pmatrix} \\alpha_{21} \\\\ \\alpha_{22} \\\\ \\tau_2 \\end{pmatrix} =\n\\begin{pmatrix} -3.6 \\\\ 10.8 \\\\ -48.0 \\end{pmatrix}\n$$\n求解这个对角系统：\n- $12 \\alpha_{21} = -3.6 \\implies \\alpha_{21} = \\frac{-3.6}{12} = -0.3$\n- $12 \\alpha_{22} = 10.8 \\implies \\alpha_{22} = \\frac{10.8}{12} = 0.9$\n- $8 \\tau_2 = -48.0 \\implies \\tau_2 = \\frac{-48.0}{8} = -6.0$\n\n计算是精确的，因此不需要四舍五入。计算出的参数为：\n- $\\alpha_{11} = 1.1$ (无量纲)\n- $\\alpha_{12} = 0.2$ (无量纲)\n- $\\alpha_{21} = -0.3$ (无量纲)\n- $\\alpha_{22} = 0.9$ (无量纲)\n- $\\tau_1 = 8.0$ (微米)\n- $\\tau_2 = -6.0$ (微米)\n\n最终答案是有序元组 $(\\alpha_{11}, \\alpha_{12}, \\alpha_{21}, \\alpha_{22}, \\tau_{1}, \\tau_{2})$。", "answer": "$$\n\\boxed{(1.1, 0.2, -0.3, 0.9, 8.0, -6.0)}\n$$", "id": "5062750"}, {"introduction": "在获得了配准好的空间数据后，下一步是确保数据的质量。在许多空间转录组学技术中，一个常见的问题是“环境RNA”污染，即游离的RNA分子被非特异性地捕获，从而干扰真实的细胞信号。本实践将通过一个混合物模型来解决这个问题，您将学习如何使用最大似然估计来量化每个空间点位的污染比例 [@problem_id:5062694]，这是数据预处理和净化中的关键一步。", "problem": "考虑一次空间分辨转录组学测量，其中在一个空间点上捕获的信使核糖核酸 (mRNA) 分子来源于两个源头：扩散到捕获区域的环境RNA和真实的点特异性细胞表达。假设有 $G$ 个基因的有限集合和一个单一的全局环境RNA图谱，该图谱以概率向量 $a \\in \\mathbb{R}^G$ 的形式给出，其各项为非负且总和为 $1$。对于每个点，假设有一个已知的点特异性表达图谱 $s \\in \\mathbb{R}^G$，其各项为非负且总和为 $1$。在该点观察到的基因计数向量为 $c \\in \\mathbb{N}_0^G$，总计数为 $N = \\sum_{i=1}^{G} c_i$。生成模型是计数从一个多项分布中抽取，其参数向量为 $p(\\alpha) = \\alpha a + (1 - \\alpha) s$，其中 $\\alpha \\in [0,1]$ 是该点未知环境RNA污染比例，且 $p(\\alpha)$ 是一个有效的概率向量，其各项为 $p_i(\\alpha) = \\alpha a_i + (1 - \\alpha) s_i$。在该模型下观察到 $c$ 的似然是多项似然。任务是为每个提供的点计算混合系数 $\\alpha$ 的最大似然估计 (MLE)，以最大化其似然。如果 $N = 0$ 或 $s = a$，则似然函数对于 $\\alpha$ 是一个常数，任何 $\\alpha \\in [0,1]$ 都是最优解；为了确保一个唯一的、可测试的输出，在这些退化情况下返回 $\\alpha = 0.0$。此外，为保持科学真实性，假设对于任何基因索引 $i$ 若其 $c_i  0$，则 $a_i$ 或 $s_i$ 中至少有一个是严格为正的。\n\n你的程序必须实现以下内容：\n1. 对于每个独立的点及其自身的计数向量 $c$ 和点特异性图谱 $s$，在给定一个固定的环境图谱 $a$ 的情况下，估计污染比例 $\\alpha \\in [0,1]$，使得在 $p(\\alpha) = \\alpha a + (1 - \\alpha) s$ 下的多项似然最大化。\n2. 仅使用多项模型和最大似然所蕴含的有数学原理的操作；不要使用改变目标函数的启发式方法。数值优化必须尊重对数似然函数关于 $\\alpha$ 的凹性，并在最优点位于 $\\alpha = 0$ 或 $\\alpha = 1$ 时选择边界解。\n\n输入作为以下测试套件固定在程序中，该套件定义了一个全局环境图谱 $a$ 和五个点，每个点都有其计数向量 $c$ 和点特异性图谱 $s$：\n- 环境图谱 $a$：$[0.4, 0.3, 0.3]$。\n- 点 $1$：$c = [70, 15, 15]$，$s = [0.6, 0.2, 0.2]$。\n- 点 $2$：$c = [40, 30, 30]$，$s = [0.2, 0.4, 0.4]$。\n- 点 $3$：$c = [30, 10, 60]$，$s = [0.6, 0.1, 0.3]$。\n- 点 $4$：$c = [20, 45, 35]$，$s = [0.4, 0.3, 0.3]$。\n- 点 $5$：$c = [0, 0, 0]$，$s = [0.2, 0.5, 0.3]$。\n\n所有条目都是无单位的计数或概率。不涉及角度。每个点的最终输出是估计的污染比例 $\\alpha$，以 $[0,1]$ 范围内的十进制数表示。你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，$[0.123456,0.654321]$）。每个污染比例应精确到六位小数。\n\n设计需要覆盖不同的方面：\n- 一个在 $(0,1)$ 内有内部最优解的一般情况。\n- 在 $\\alpha = 0$ 和 $\\alpha = 1$ 处的边界最优解。\n- 一个 $s = a$ 的退化情况。\n- 一个总计数为零的边界情况，即 $N = 0$。\n\n你的解决方案必须是完全确定性的和自包含的，仅使用指定的运行时环境和库。", "solution": "该问题要求在空间转录组学实验中，找到污染比例 $\\alpha$ 的最大似然估计 (MLE)。对于一个给定的点，观察到的基因计数向量 $c \\in \\mathbb{N}_0^G$ 被建模为来自多项分布的一个样本。\n\n生成模型被指定为 $c \\sim \\text{Multinomial}(N, p(\\alpha))$，其中 $N = \\sum_{i=1}^{G} c_i$ 是观察到的mRNA分子的总数，而 $p(\\alpha)$ 是 $G$ 个基因的概率向量。该概率向量是全局环境RNA图谱 $a$ 和点特异性真实表达图谱 $s$ 的线性混合：\n$$p(\\alpha) = \\alpha a + (1 - \\alpha) s$$\n混合系数 $\\alpha$ 被约束在区间 $[0,1]$ 内。对于每个基因 $i$，其概率为 $p_i(\\alpha) = \\alpha a_i + (1 - \\alpha) s_i$。向量 $a$ 和 $s$ 本身就是概率分布，其各项非负且总和为 $1$。\n\n在给定 $\\alpha$ 的条件下观察到计数向量 $c$ 的似然由多项概率质量函数给出：\n$$L(\\alpha | c) = \\frac{N!}{\\prod_{i=1}^{G} c_i!} \\prod_{i=1}^{G} p_i(\\alpha)^{c_i}$$\n为了找到 $\\alpha$ 的MLE，我们最大化这个似然函数。这等价于最大化对数似然函数 $\\ell(\\alpha) = \\log(L(\\alpha|c))$，后者在数学上更方便：\n$$\\ell(\\alpha) = \\log\\left(\\frac{N!}{\\prod_{i=1}^{G} c_i!}\\right) + \\sum_{i=1}^{G} c_i \\log(p_i(\\alpha))$$\n第一项相对于 $\\alpha$ 是一个常数，因此优化问题简化为最大化函数 $\\ell^*(\\alpha)$：\n$$\\hat{\\alpha}_{MLE} = \\arg\\max_{\\alpha \\in [0,1]} \\ell^*(\\alpha) \\quad \\text{其中} \\quad \\ell^*(\\alpha) = \\sum_{i=1}^{G} c_i \\log(\\alpha a_i + (1 - \\alpha) s_i)$$\n\n为了找到最大值，我们分析 $\\ell^*(\\alpha)$ 的导数。关于 $\\alpha$ 的一阶导数是：\n$$\\frac{d\\ell^*(\\alpha)}{d\\alpha} = f(\\alpha) = \\sum_{i=1}^{G} c_i \\frac{a_i - s_i}{\\alpha a_i + (1 - \\alpha) s_i}$$\n二阶导数是：\n$$\\frac{d^2\\ell^*(\\alpha)}{d\\alpha^2} = f'(\\alpha) = - \\sum_{i=1}^{G} c_i \\left( \\frac{a_i - s_i}{\\alpha a_i + (1 - \\alpha) s_i} \\right)^2$$\n由于 $c_i \\ge 0$ 且括号中的项是平方的，所以对于所有 $\\alpha \\in (0,1)$ 都有 $f'(\\alpha) \\le 0$。这证实了对数似然函数 $\\ell^*(\\alpha)$ 是凹函数。在一个闭区间 $[0,1]$ 上的凹函数有唯一的最大值。这个最大值可能出现在 $f(\\alpha)=0$ 的内部点，或者在边界点 $\\alpha=0$ 或 $\\alpha=1$ 之一。\n\n总体策略如下：\n首先，我们处理问题中指定的两种退化情况。如果总计数 $N=0$ 或者图谱相同 ($s=a$)，则似然函数对于所有 $\\alpha \\in [0,1]$ 都是常数。在这些情况下，我们返回指定的默认值 $\\hat{\\alpha} = 0.0$。\n\n对于非退化情况，我们分析导数 $f(\\alpha)$，由于其导数 $f'(\\alpha)$ 是非正的，所以 $f(\\alpha)$ 是单调递减的。\n$1$. 我们计算在左边界 $\\alpha=0$ 处的导数。如果 $f(0) \\le 0$，函数从一开始就是非增的，所以最大值必定在 $\\hat{\\alpha}=0$。\n$$f(0) = \\sum_{i=1}^{G} c_i \\frac{a_i - s_i}{s_i} = \\sum_{i=1}^{G} c_i \\left(\\frac{a_i}{s_i} - 1\\right)$$\n如果对于任何 $c_i  0$ 的基因 $i$，我们有 $s_i = 0$，则求和中的相应项趋于 $+\\infty$（因为保证了 $a_i  0$）。在这种情况下，$f(0)$ 实际上是正的，最优点必须是 $\\hat{\\alpha}0$。\n\n$2$. 我们计算在右边界 $\\alpha=1$ 处的导数。如果 $f(1) \\ge 0$，函数在区间末尾仍然是非减的，所以最大值必定在 $\\hat{\\alpha}=1$。\n$$f(1) = \\sum_{i=1}^{G} c_i \\frac{a_i - s_i}{a_i} = \\sum_{i=1}^{G} c_i \\left(1 - \\frac{s_i}{a_i}\\right)$$\n类似地，如果对于任何 $c_i  0$ 的基因 $i$，我们有 $a_i=0$，则该项趋于 $-\\infty$（因为保证了 $s_i0$），使得 $f(1)$ 实际上是负的。这意味着最优点必须是 $\\hat{\\alpha}1$。\n\n$3$. 如果两个边界条件都不满足，即 $f(0)  0$ 且 $f(1)  0$，那么 $\\ell^*(\\alpha)$ 的凹性和 $f(\\alpha)$ 的单调性保证了在开区间 $(0,1)$ 内 $f(\\alpha)=0$ 有一个唯一的根。这个根对应于最大似然估计 $\\hat{\\alpha}$。\n\n为了找到这个内部根，我们采用一种数值优化方法。牛顿-拉弗森法 (Newton-Raphson method) 对于这个一维求根问题是一个合适且高效的选择。从一个初始猜测 $\\alpha_0$（例如 $\\alpha_0 = 0.5$）开始，我们使用以下更新规则迭代地优化估计值：\n$$\\alpha_{k+1} = \\alpha_k - \\frac{f(\\alpha_k)}{f'(\\alpha_k)}$$\n其中 $f(\\alpha_k)$ 和 $f'(\\alpha_k)$ 是在 $\\alpha_k$ 处计算的一阶和二阶导数。迭代持续进行，直到 $\\alpha$ 的变化变得可以忽略不计，表明已收敛到根。\n\n最终的算法是：\n$1$. 对于一个给定的点 ($a$, $s$, $c$)，检查是否 $N = \\sum c_i = 0$ 或 $s$ 和 $a$ 是否相等。如果是，则返回 $\\hat{\\alpha} = 0.0$。\n$2$. 计算导数 $f(0)$。如果 $f(0) \\le 0$，则返回 $\\hat{\\alpha} = 0.0$。\n$3$. 计算导数 $f(1)$。如果 $f(1) \\ge 0$，则返回 $\\hat{\\alpha} = 1.0$。\n$4$. 否则，使用牛顿-拉弗森法，从 $\\alpha_0=0.5$ 开始，在 $(0,1)$ 内找到 $f(\\alpha)=0$ 的根。这个根就是估计值 $\\hat{\\alpha}$。\n对每个点独立应用此过程，以获得估计的污染比例列表。", "answer": "[0.000000,1.000000,0.375000,0.000000,0.000000]", "id": "5062694"}, {"introduction": "经过数据对齐和净化后，我们便可以开始进行生物学解析。由于大多数空间捕获点包含多种细胞，一个核心任务是确定组织微环境的细胞组成。本实践将引导您将细胞类型反卷积问题构建为一个带约束的优化问题，并利用已知的细胞类型特征矩阵来估算每个空间点位中不同细胞类型的比例 [@problem_id:4386305]。这是从混合信号中提取有意义生物学见解的关键分析方法。", "problem": "给定一个系统生物医学场景，其中来自 Visium 空间基因表达 (Visium) 技术的一个空间点包含多种细胞类型的混合物，这些细胞类型的信使核糖核酸 (mRNA) 转录本丰度是跨多个基因测量的。在这样的一个点中，观测到的表达谱是组成细胞类型的表达谱的混合。为了量化一个点的成分，假设有一个参考特征矩阵，该矩阵编码了每种细胞类型的平均基因表达。任务是构建并解决一个约束回归问题，以估计每个点的细胞类型比例。\n\n使用以下基本依据和假设：\n- 分子生物学中心法则：脱氧核糖核酸 (DNA) 转录为核糖核酸 (RNA)，RNA 再翻译为蛋白质。在充分平均和归一化的设置下，观测到的每个基因的转录本计数反映了样本中存在的不同细胞类型贡献的总和。\n- 线性混合模型：一个点中观测到的基因表达向量可以被建模为由未知的非负比例加权的细胞类型特异性特征的线性组合。设 $G$ 为基因数量，$K$ 为细胞类型数量，$\\mathbf{S} \\in \\mathbb{R}_{\\ge 0}^{G \\times K}$ 为已知的特征矩阵，其第 $k$ 列是细胞类型 $k$ 的参考表达谱，$\\mathbf{y} \\in \\mathbb{R}_{\\ge 0}^{G}$ 为一个点的观测表达向量。未知的细胞类型比例向量是 $\\mathbf{p} \\in \\mathbb{R}_{\\ge 0}^{K}$。\n- 约束条件：比例是非负的且总和为一，即 $\\mathbf{p} \\succeq \\mathbf{0}$ 且 $\\mathbf{1}^{\\top} \\mathbf{p} = 1$，其中 $\\mathbf{1}$ 是 $\\mathbb{R}^{K}$ 中的全一向量。\n- 目标：估计准则是预测表达与观测表达之间的平方欧几里得距离，可选地，每个基因带有非负权重 $w_g$ 以反映可靠性，以及一个小的岭正则化项以确保唯一性和数值稳定性。\n\n形式上，将反卷积定义为对每个点的以下约束优化问题：\n最小化函数\n$$\n\\frac{1}{2} \\sum_{g=1}^{G} w_g \\left( (\\mathbf{S}\\mathbf{p})_g - \\mathbf{y}_g \\right)^2 + \\frac{\\alpha}{2} \\lVert \\mathbf{p} \\rVert_2^2\n$$\n约束条件为 $\\mathbf{p} \\succeq \\mathbf{0}$ 和 $\\mathbf{1}^{\\top} \\mathbf{p} = 1$，\n其中 $w_g \\ge 0$ 是给定的每个基因的权重，$\\alpha \\ge 0$ 是一个小的正则化参数。\n\n您的程序必须实现一个求解器，对于每个测试用例，计算在约束条件下最小化上述目标的细胞类型比例向量 $\\widehat{\\mathbf{p}}$。您可以假设问题是凸的并且存在最小值点。该求解器必须是通用的，并且不能依赖于约束的闭式反演。程序必须将 $\\widehat{\\mathbf{p}}$ 的每个分量四舍五入到4位小数。\n\n角度单位不适用。没有物理单位；比例必须以小数形式报告。\n\n测试套件：\n对于每个案例，给定 $G$、$K$、特征矩阵 $\\mathbf{S}$、观测表达 $\\mathbf{y}$、权重 $\\mathbf{w}$ 和岭参数 $\\alpha$。所有数值均在下方明确给出。\n\n- 案例 A（通用，小噪声）：\n  - $G = 5$, $K = 3$, $\\alpha = 10^{-6}$。\n  - $\\mathbf{S} = \\begin{bmatrix}\n  8  2  1 \\\\\n  1  7  2 \\\\\n  0  1  9 \\\\\n  5  2  1 \\\\\n  2  3  4\n  \\end{bmatrix}$。\n  - $\\mathbf{y} = \\begin{bmatrix} 4.9 \\\\ 2.95 \\\\ 2.12 \\\\ 3.27 \\\\ 2.7 \\end{bmatrix}$。\n  - $\\mathbf{w} = \\begin{bmatrix} 1 \\\\ 1 \\\\ 1 \\\\ 1 \\\\ 1 \\end{bmatrix}$。\n\n- 案例 B（纯细胞类型，无噪声）：\n  - $G = 5$, $K = 3$, $\\alpha = 10^{-6}$。\n  - $\\mathbf{S}$ 与案例 A 相同。\n  - $\\mathbf{y} = \\begin{bmatrix} 2 \\\\ 7 \\\\ 1 \\\\ 2 \\\\ 3 \\end{bmatrix}$。\n  - $\\mathbf{w} = \\begin{bmatrix} 1 \\\\ 1 \\\\ 1 \\\\ 1 \\\\ 1 \\end{bmatrix}$。\n\n- 案例 C（共线性，精确混合）：\n  - $G = 4$, $K = 3$, $\\alpha = 10^{-6}$。\n  - $\\mathbf{S} = \\begin{bmatrix}\n  3  3  1 \\\\\n  2  2  0.5 \\\\\n  1  1  4 \\\\\n  0.5  0.5  2\n  \\end{bmatrix}$。\n  - $\\mathbf{y} = \\begin{bmatrix} 2.6 \\\\ 1.7 \\\\ 1.6 \\\\ 0.8 \\end{bmatrix}$。\n  - $\\mathbf{w} = \\begin{bmatrix} 1 \\\\ 1 \\\\ 1 \\\\ 1 \\\\ 1 \\end{bmatrix}$。\n\n- 案例 D（零值和 dropout，中等噪声）：\n  - $G = 4$, $K = 2$, $\\alpha = 10^{-6}$。\n  - $\\mathbf{S} = \\begin{bmatrix}\n  0  3 \\\\\n  5  0 \\\\\n  0  2 \\\\\n  4  1\n  \\end{bmatrix}$。\n  - $\\mathbf{y} = \\begin{bmatrix} 1.15 \\\\ 3.1 \\\\ 0.4 \\\\ 2.7 \\end{bmatrix}$。\n  - $\\mathbf{w} = \\begin{bmatrix} 1 \\\\ 1 \\\\ 1 \\\\ 1 \\\\ 1 \\end{bmatrix}$。\n\n- 案例 E（加权拟合，对噪声大的第二个基因降权）：\n  - $G = 3$, $K = 3$, $\\alpha = 10^{-6}$。\n  - $\\mathbf{S} = \\begin{bmatrix}\n  10  1  0.5 \\\\\n  0.5  8  1 \\\\\n  1  1  6\n  \\end{bmatrix}$。\n  - $\\mathbf{y} = \\begin{bmatrix} 2.65 \\\\ 5.9 \\\\ 2.4 \\end{bmatrix}$。\n  - $\\mathbf{w} = \\begin{bmatrix} 1 \\\\ 0.2 \\\\ 1 \\end{bmatrix}$。\n\n实现要求：\n- 实现一个求解器，该求解器能精确处理约束条件 $\\mathbf{p} \\succeq \\mathbf{0}$ 和 $\\mathbf{1}^{\\top} \\mathbf{p} = 1$，不进行松弛，并在目标函数中包含岭正则化项 $\\alpha$。\n- 该算法必须是有原则且通用的（例如，带有数学上合理的步长并将结果投影到概率单纯形上的投影梯度法）。\n- 对于每个案例，计算估计的比例 $\\widehat{\\mathbf{p}}$ 并将每个分量四舍五入到4位小数。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果（例如，$[result1,result2,result3]$），其中每个 $resulti$ 是对应案例的四舍五入比例的列表。输出必须不含空格。例如：$[[0.5000,0.3000,0.2000],[0.0000,1.0000,0.0000],\\dots]$。", "solution": "用户提供了一个问题陈述，该陈述已经过验证，被认为是科学上可靠、适定且客观的。\n\n该问题要求解一个约束二次优化问题，以在空间转录组学中执行细胞类型反卷积。一个点的观测基因表达向量 $\\mathbf{y} \\in \\mathbb{R}_{\\ge 0}^{G}$ 被建模为参考细胞类型表达特征的线性组合。这些特征被编码在一个已知矩阵 $\\mathbf{S} \\in \\mathbb{R}_{\\ge 0}^{G \\times K}$ 的列中，其中 $G$ 是基因数量，$K$ 是细胞类型数量。未知量是每种细胞类型的比例，由向量 $\\mathbf{p} \\in \\mathbb{R}_{\\ge 0}^{K}$ 表示。\n\n这些比例必须满足两个物理约束：它们必须是非负的，$\\mathbf{p} \\succeq \\mathbf{0}$，并且它们的总和必须为1，$\\mathbf{1}^{\\top} \\mathbf{p} = 1$。所有满足这些约束的向量 $\\mathbf{p}$ 构成了标准的 $K-1$ 维单纯形，记作 $\\Delta^{K-1}$。\n\n目标是找到比例向量 $\\widehat{\\mathbf{p}}$，以最小化一个正则化的、加权的、平方误差目标函数。目标函数由下式给出：\n$$\nf(\\mathbf{p}) = \\frac{1}{2} \\sum_{g=1}^{G} w_g \\left( (\\mathbf{S}\\mathbf{p})_g - y_g \\right)^2 + \\frac{\\alpha}{2} \\lVert \\mathbf{p} \\rVert_2^2\n$$\n其中 $w_g \\ge 0$ 是基因特异性权重，$\\alpha \\ge 0$ 是一个吉洪诺夫 (Tikhonov) (岭) 正则化参数。\n\n这个问题可以用矩阵形式表示。设 $\\mathbf{W}$ 是一个 $G \\times G$ 的对角矩阵，其对角线上的元素为权重 $w_g$。目标函数为：\n$$\nf(\\mathbf{p}) = \\frac{1}{2} (\\mathbf{S}\\mathbf{p} - \\mathbf{y})^{\\top} \\mathbf{W} (\\mathbf{S}\\mathbf{p} - \\mathbf{y}) + \\frac{\\alpha}{2} \\mathbf{p}^{\\top}\\mathbf{p}\n$$\n该问题是一个二次规划 (QP) 问题，具有凸目标函数和紧凑的凸可行集 (单纯形 $\\Delta^{K-1}$)。由岭项 ($\\alpha  0$) 带来的严格凸性保证了唯一解的存在。\n\n解决此问题的一个合适且通用的算法是投影梯度下降法。这种迭代方法包括沿负梯度方向迈出一步，然后将得到的点投影回可行集上。\n\n算法流程如下：\n1.  将 $\\mathbf{p}^{(0)}$ 初始化为一个可行点，通常是单纯形的中心：$\\mathbf{p}^{(0)} = \\frac{1}{K}\\mathbf{1}$。\n2.  对于迭代 $t = 0, 1, 2, \\dots$ 直到收敛：\n    a.  通过计算目标函数在当前迭代点 $\\mathbf{p}^{(t)}$ 的梯度 $\\nabla f(\\mathbf{p})$ 来计算下降方向。\n    b.  沿此方向迈出一步：$\\mathbf{z}^{(t+1)} = \\mathbf{p}^{(t)} - \\eta \\nabla f(\\mathbf{p}^{(t)})$，其中 $\\eta  0$ 是步长。\n    c.  将点 $\\mathbf{z}^{(t+1)}$ 投影到单纯形 $\\Delta^{K-1}$ 上：$\\mathbf{p}^{(t+1)} = \\Pi_{\\Delta^{K-1}}(\\mathbf{z}^{(t+1)})$。\n3.  当两次迭代之间 $\\mathbf{p}$ 的变化小于一个小的容差时，算法终止。\n\n该算法的关键组成部分是梯度计算、步长确定和投影算子。\n\n**1. 梯度计算**\n\n目标函数为：\n$$\nf(\\mathbf{p}) = \\frac{1}{2} \\left( \\mathbf{p}^{\\top}\\mathbf{S}^{\\top}\\mathbf{W}\\mathbf{S}\\mathbf{p} - 2\\mathbf{y}^{\\top}\\mathbf{W}\\mathbf{S}\\mathbf{p} + \\mathbf{y}^{\\top}\\mathbf{W}\\mathbf{y} \\right) + \\frac{\\alpha}{2} \\mathbf{p}^{\\top}\\mathbf{p}\n$$\n关于 $\\mathbf{p}$ 的梯度是：\n$$\n\\nabla f(\\mathbf{p}) = \\mathbf{S}^{\\top}\\mathbf{W}\\mathbf{S}\\mathbf{p} - \\mathbf{S}^{\\top}\\mathbf{W}\\mathbf{y} + \\alpha\\mathbf{p} = \\mathbf{S}^{\\top}\\mathbf{W}(\\mathbf{S}\\mathbf{p} - \\mathbf{y}) + \\alpha\\mathbf{p}\n$$\n\n**2. 步长确定**\n\n为使梯度下降法收敛，必须适当地选择步长 $\\eta$。对于具有 Lipschitz 连续梯度的凸函数，收敛的一个充分条件是 $0  \\eta  2/L$，其中 $L$ 是梯度的 Lipschitz 常数。对于我们的二次目标函数，$L$ 是 Hessian 矩阵 $\\nabla^2 f(\\mathbf{p})$ 的最大特征值。Hessian 矩阵为：\n$$\n\\nabla^2 f(\\mathbf{p}) = \\mathbf{S}^{\\top}\\mathbf{W}\\mathbf{S} + \\alpha\\mathbf{I}\n$$\n其中 $\\mathbf{I}$ 是 $K \\times K$ 单位矩阵。该 Hessian 矩阵是一个常数、对称、正定矩阵 (对于 $\\alpha  0$)。我们可以计算其特征值，并将 $L$ 设为最大特征值 $\\lambda_{\\text{max}}$。那么一个安全且恒定的步长是 $\\eta = 1/L$。\n\n**3. 投影到概率单纯形**\n\n投影步骤 $\\mathbf{p}^{(t+1)} = \\Pi_{\\Delta^{K-1}}(\\mathbf{z}^{(t+1)})$ 找到单纯形上在欧几里得距离上最接近 $\\mathbf{z}^{(t+1)}$ 的点。这本身就是一个 QP 问题：\n$$\n\\text{minimize}_{\\mathbf{p}} \\quad \\frac{1}{2} \\lVert \\mathbf{p} - \\mathbf{z} \\rVert_2^2 \\quad \\text{subject to} \\quad \\mathbf{p} \\succeq \\mathbf{0}, \\mathbf{1}^{\\top}\\mathbf{p} = 1\n$$\n存在一个时间复杂度为 $O(K \\log K)$ 的高效算法来解决这个投影问题。步骤如下：\n1.  将向量 $\\mathbf{z}$ 的元素按降序排序，得到一个新向量 $\\mathbf{u}$。\n2.  找到一个整数 $\\rho$ 使得 $\\rho = \\max\\left\\{ j \\in \\{1, \\dots, K\\} \\mid u_j - \\frac{1}{j} \\left( \\sum_{i=1}^j u_i - 1 \\right)  0 \\right\\}$。\n3.  定义一个阈值 $\\theta = \\frac{1}{\\rho} \\left( \\sum_{i=1}^\\rho u_i - 1 \\right)$。\n4.  通过对原始向量 $\\mathbf{z}$ 的每个元素应用软阈值算子来获得投影向量 $\\mathbf{p}$：$p_k = \\max(z_k - \\theta, 0)$，其中 $k = 1, \\dots, K$。\n\n通过将这三个组件组合到一个迭代循环中，该算法将为每个测试用例收敛到唯一的最小值点 $\\widehat{\\mathbf{p}}$。", "answer": "[[0.5529,0.1471,0.3000],[0.0000,1.0000,0.0000],[0.4000,0.4000,0.2000],[0.6186,0.3814],[0.2006,0.7011,0.0983]]", "id": "4386305"}]}