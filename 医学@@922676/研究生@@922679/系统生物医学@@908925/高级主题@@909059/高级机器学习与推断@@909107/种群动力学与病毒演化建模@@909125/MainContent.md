## 引言
病毒的基因组序列不仅记录了其自身的进化轨迹，也蕴藏着其在宿主种群中传播和扩散的宏观动态信息。[系统动力学](@entry_id:136288)（Phylodynamics）正是一门将分子进化与流行病学过程联系起来的交叉学科，它使我们能够通过分析病原体的基因组来“阅读”流行病的历史和现状。然而，从海量的基因测[序数](@entry_id:150084)据到关于传播速率、种群规模和干预效果的定量结论，需要一个坚实的理论和方法学桥梁。本文旨在系统性地构建这一桥梁，为读者提供一个从理论到实践的全面指南。

在接下来的内容中，我们将分三步深入探索系统动力学的世界。首先，在“原理与机制”一章中，我们将剖析[溯祖理论](@entry_id:155051)和出生-死亡过程这两个核心数学框架，揭示它们如何将谱系树的形态与流行病动态参数（如[有效种群大小](@entry_id:146802)和再生数）联系起来。接着，在“应用与跨学科联系”一章，我们将展示这些理论如何在重建流行病史、追踪空间传播、评估公共卫生干预以及预测病毒[适应性进化](@entry_id:176122)等实际问题中发挥关键作用。最后，通过“动手实践”部分提供的一系列编程练习，读者将有机会亲手实现关键算法，将理论知识转化为实践能力。

通过这一结构化的学习路径，本文将带领读者掌握从病毒基因序列中解码流行病动态的核心技能。让我们首先从构建这一切的基石——[系统动力学](@entry_id:136288)的基本原理与机制开始。

## 原理与机制

在本章中，我们将深入探讨病毒系统生物学中用于模拟[病毒进化](@entry_id:141703)和流行病动态的两个核心理论框架：[溯祖理论](@entry_id:155051)（the coalescent）和出生-死亡过程（birth-death process）。我们将阐明这些模型的基本原理，展示它们如何将病毒的基因组序列与种群水平的流行病学过程联系起来，并讨论在真实世界数据分析中遇到的关键复杂情况及其建模对策。

### 病毒谱系的基础模型

[系统发育](@entry_id:137790)动力学（Phylodynamics）的核心目标是从一组抽样病毒的基因组序列中推断其进化和传播历史。这需要能够描述谱系（genealogies）如何形成的数学模型。谱系，即[系统发育树](@entry_id:140506)，是样本祖先关系的图形表示。我们主要关注两种互补的建模视角：一种是[回溯时间](@entry_id:260844)看待祖先合并，另一种是随时间正向推演谱系的分支。

#### 溯祖过程：追溯祖先的视角

[溯祖理论](@entry_id:155051)提供了一个强大的框架，用于描述在一个种群中随机抽取的个体样本，其谱系在[回溯时间](@entry_id:260844)的过程中如何形成。它不是模拟整个种群的演化，而是专注于样本的祖先，这使其在计算上极为高效。

**[金曼溯祖](@entry_id:169191)（Kingman's Coalescent）与[有效种群大小](@entry_id:146802)**

最经典的[溯祖模型](@entry_id:202220)是 **金曼n-溯祖（Kingman's n-coalescent）**。它描述了一个在理想化假设下（如中性进化、群体混合良好）恒定大小种群的谱系形成过程。其核心思想是，当我们[回溯时间](@entry_id:260844)时，任意两条谱系（lineages）都有一定的速率找到共同的祖先，这个事件被称为 **溯祖事件（coalescent event）**。在金曼模型中，这些事件总是成对发生的，即一次只有一个共同祖先事件，涉及两条谱系合并为一。

对于一个包含 $k$ 条谱系的样本，任何一对特定谱系的合并速率为 $1/N_e$，其中 $N_e$ 是 **[有效种群大小](@entry_id:146802)（effective population size）**。因此，样本中发生下一次溯祖事件的总速率是所有谱系对的速率之和：
$$
\lambda_k = \binom{k}{2} \frac{1}{N_e}
$$
[有效种群大小](@entry_id:146802) $N_e$ 是一个核心概念。它并非指 census population size（普查种群大小，即感染个体总数），而是指一个理想化的、具有相同[遗传漂变](@entry_id:145594)（genetic drift）强度的 **赖特-费舍尔（Wright-Fisher）种群** 的大小。[遗传漂变](@entry_id:145594)[有效种群大小](@entry_id:146802)是一个前向时间概念，量化等位基因频率随机变化的速率。而溯祖[有效种群大小](@entry_id:146802)是一个[回溯时间](@entry_id:260844)概念，量化谱系合并的速率。这两个概念仅在一组严格的条件下才会吻合，包括种群大小恒定、中性进化、世代不重叠、泊松分布的后代数量（即没有“超级传播”现象），以及紧密的传播瓶颈（tight transmission bottlenecks）[@problem_id:4374551]。在病毒流行病学中，后代数量的方差通常远大于均值，这意味着 $N_e$ 往往远小于实际的感染人数。

**时变[有效种群大小](@entry_id:146802)**

在真实的流行病中，种群大小很少保持不变。[溯祖理论](@entry_id:155051)可以扩展到 **时变[有效种群大小](@entry_id:146802) $N_e(t)$** 的情况，其中 $t$ 表示从现在（$t=0$）开始回溯的日历时间。在这种情况下，$k$ 条谱系的瞬时溯祖风险（或速率）变为一个时间函数：
$$
\lambda_k(t) = \frac{\binom{k}{2}}{N_e(t)}
$$
这使得溯祖过程成为一个 **非[齐次泊松过程](@entry_id:263782)（inhomogeneous Poisson process）**。两次连续溯祖事件之间的等待时间不再遵循简单的指数分布，而是取决于 $N_e(t)$ 在该时间段内的变化。

为了理解这一点，我们可以考虑一个思想实验：假设[有效种群大小](@entry_id:146802)在时间 $\tau$ 发生了一次阶跃变化，从 $t \in [0, \tau)$ 期间的 $N_1$ 变为 $t \ge \tau$ 期间的 $N_2$ [@problem_id:4374566]。从 $k$ 条谱系减少到 $k-1$ 条的[期望等待时间](@entry_id:274249) $E[T_k]$ 将取决于两个阶段的速率。如果谱系在时间 $\tau$ 之前没有合并（其概率为 $\exp(-\Lambda_1 \tau)$，其中 $\Lambda_1 = \binom{k}{2}/N_1$），那么它将进入速率为 $\Lambda_2 = \binom{k}{2}/N_2$ 的新阶段。因此，总的[期望等待时间](@entry_id:274249)是两个部分的加权和：
$$
E[T_k] = \int_0^\tau \exp(-\Lambda_1 t) dt + \exp(-\Lambda_1 \tau) \int_\tau^\infty \exp(-\Lambda_2 (t - \tau)) dt = \frac{1 - \exp(-\Lambda_1 \tau)}{\Lambda_1} + \frac{\exp(-\Lambda_1 \tau)}{\Lambda_2}
$$
这个公式直观地表明，如果种群规模扩大（$N_2 > N_1$），则溯祖速率降低（$\Lambda_2 < \Lambda_1$），[期望等待时间](@entry_id:274249)会增加。反之，如果种群规模缩小（$N_2 < N_1$），溯祖速率加快，[期望等待时间](@entry_id:274249)会减少。这揭示了谱系树中分支的长度如何蕴含着关于过去[种群动态](@entry_id:136352)的信息。

#### 出生-死亡过程：流行病的前向视角

与[溯祖理论](@entry_id:155051)的回溯视角不同，**出生-死亡过程（birth-death process）** 提供了一个前向时间的框架来模拟谱系树的形成，这与[流行病传播](@entry_id:264141)的直观理解更为一致。在这个框架中，每条谱系代表一个受感染的个体。

- **“出生”** 事件对应于一次传播事件，即一个受感染的个体（谱系）产生了新的感染者（新的谱系）。
- **“死亡”** 事件对应于一个受感染的个体停止传播，这可以是因为康复、死亡，或者因为被抽样测序而从传播链中移除。

**出生-死亡天际线（BDSKY）模型**

在现代[系统发育](@entry_id:137790)动力学中，一个广泛使用的模型是 **出生-死亡天际线（Birth-Death Skyline, BDSKY）模型** [@problem_id:4374478]。该模型使用一组随时间变化的速率来描述流行病过程：

- **传播速率 $\lambda(t)$**：单位时间内单个感染个体产生新感染的速率。这对应于谱系的分支（“出生”）速率。
- **未抽样移除速率 $\mu(t)$**：单位时间内单个感染个体因康复或死亡而停止传播（但未被测序）的速率。
- **抽样速率 $\psi(t)$**：单位时间内单个感染个体被抽样测序并因此从感染群体中移除的速率。

这两个“死亡”事件是相互竞争的，因此，一个谱系在时间 $t$ 停止传播的总速率（即 **变得无传染性的速率 $\delta(t)$**）是两者之和：
$$
\delta(t) = \mu(t) + \psi(t)
$$
基于这些基本速率，我们可以推导出关键的流行病学参数。**[有效再生数](@entry_id:164900) $R_t$**，即一个感染者在其整个感染期内平均产生的二次感染数，可以计算为传播速率与总移除速率的比值。平均感染期持续时间为 $1/\delta(t)$，因此：
$$
R_t = \lambda(t) \times \frac{1}{\delta(t)} = \frac{\lambda(t)}{\mu(t) + \psi(t)}
$$
此外，**抽样比例 $s(t)$**，即一个停止传播的个体是被抽样测序的概率，是抽样速率与总移除速率的比值：
$$
s(t) = \frac{\psi(t)}{\mu(t) + \psi(t)}
$$
BDSKY模型及其变体通过将这些流行病学上有意义的参数与系统发育树的似然函数联系起来，使得我们能够从病毒基因组数据中联合推断 $R_t$、抽样强度等关键动态。

### 从谱系推断流行病史

理论模型建立了谱系形状与种群动态之间的联系。接下来的挑战是如何利用这一联系，从实际观测到的、根据[序列数据](@entry_id:636380)重建的系统发育树中，反向推断出这些动态。

#### 流行病学与谱系学的联系

流行病的增长模式直接反映在病毒谱系树的拓扑结构和[分支长度](@entry_id:177486)上。例如，在流行病早期指数增长阶段，谱系树的分支会迅速出现，形成一种“星状”的拓扑结构。

**洛特卡-欧拉方程：连接 $R_t$ 与增长率 $r$**

一个更为定量的联系可以通过 **[更新方程](@entry_id:264802)（renewal equation）** 来建立 [@problem_id:4374556]。在易感人群数量庞大的情况下，时间 $t$ 的发病率 $I(t)$ 可以表示为所有过去感染者贡献的总和。如果[有效再生数](@entry_id:164900) $R$ 恒定，则：
$$
I(t) = \int_{0}^{\infty} I(t-\tau) R w_g(\tau) d\tau
$$
其中 $w_g(\tau)$ 是 **代际时间（generation time）** 的[概率密度函数](@entry_id:140610)，即从感染一个“父亲”到感染其“孩子”之间的时间间隔分布。这个分布描述了传播事件的时间节奏。

在流行病呈指数增长（即 $I(t) = I_0 \exp(rt)$，其中 $r$ 是[马尔萨斯增长](@entry_id:187002)率）的常见情景下，将该形式代入[更新方程](@entry_id:264802)，可以得到著名的 **洛特卡-[欧拉方程](@entry_id:177914)（Lotka-Euler equation）**：
$$
1 = R \int_{0}^{\infty} \exp(-r\tau) w_g(\tau) d\tau
$$
方程右侧的积分正是代际时间分布的 **[矩生成函数](@entry_id:154347)（Moment-Generating Function, MGF）** $M_{T_g}(s)$ 在 $s=-r$ 处的值。因此，该方程可以简洁地写为：
$$
\frac{1}{R} = M_{T_g}(-r)
$$
这个核心关系式精确地量化了宏观流行病学参数（$R$ 和 $r$）是如何由传播事件的微观时间尺度（$w_g(\tau)$）决定的。例如，如果代际时间服从[形状参数](@entry_id:270600)为 $k$、均值为 $\mu$ 的Gamma分布，那么增长率 $r$ 可以解析地表示为 $r = \frac{k}{\mu} (R^{1/k} - 1)$。

值得注意的是，代际时间 $T_g$ 必须与 **序列间隔（serial interval）** $T_s$ 区分开来。序列间隔是指“父亲”和“孩子”出现症状的时间间隔。由于潜伏期的存在和变化，这两个分布通常是不同的。在洛特卡-欧拉方程中，必须使用代际时间分布，因为它直接描述了传播事件的时间。

#### 非[参数推断](@entry_id:753157)：[天际线图](@entry_id:167377)

[天际线图](@entry_id:167377)（Skyline plots）是一类强大的[非参数方法](@entry_id:138925)，它们直接利用溯祖[似然函数](@entry_id:141927)从系统发育树中估计 $N_e(t)$ 的历史轨迹，而无需预先假设一个特定的流行病学模型（如[SIR模型](@entry_id:267265)）。

**[贝叶斯天际线图](@entry_id:175686)（Bayesian Skyline Plot, BSP）** [@problem_id:4374510] 是这类方法的典型代表。它假设 $N_e(t)$ 是一个分段[常数函数](@entry_id:152060)。这些“段”不是固定的日历时间间隔，而是由重建的谱系树中连续的 **溯祖间隔（inter-coalescent intervals）** 分组而成。一个溯祖间隔 $\Delta t_i$ 是树中存在 $k_i$ 条谱系直到下一次溯祖事件发生所经过的时间。

对于属于第 $g$ 组的所有溯祖间隔，它们共享同一个[有效种群大小](@entry_id:146802) $N_{e,g}$。该组的似然贡献可以表示为：
$$
L_g(N_{e,g}) \propto N_{e,g}^{-a_g} \exp\left( - \frac{1}{N_{e,g}} \sum_{i \in g} \binom{k_i}{2} \Delta t_i \right)
$$
其中 $a_g$ 是第 $g$ 组包含的间隔数。这个表达式表明，对于 $N_{e,g}$ 的推断，其 **充分统计量（sufficient statistics）** 是 $a_g$ 和该组内经过谱系数量缩放的间隔[时间总和](@entry_id:148146) $S_g = \sum_{i \in g} \binom{k_i}{2} \Delta t_i$。直观上，较长的溯祖间隔（大的 $\Delta t_i$）意味着溯祖速率慢，这支持了较大的[有效种群大小](@entry_id:146802) $N_{e,g}$。BSP方法通过[贝叶斯推断](@entry_id:146958)（如MCMC）同时对分段方式（由 $a_g$ 决定）和每个分段的 $N_{e,g}$ 值进行估计，从而重建出 $N_e(t)$ 的后验分布。

虽然BSP非常灵活，但它在数据稀疏的时期可能表现出高方差。为了解决这个问题，发展出了更平滑的变体 [@problem_id:4374534]。例如：
- **Skyride模型**：在 $\log N_e(t)$ 上施加一个[高斯马尔可夫随机场](@entry_id:749746)（GMRF）先验，这会惩罚相邻时间点之间 $\log N_e(t)$ 的剧烈变化，从而使估计的轨迹更平滑。这降低了方差，但如果真实动态有急剧变化，则可能引入偏差。
- **Skygrowth模型**：在 $\log N_e(t)$ 的导数（即增长率）上施加GMRF先验。这种方法倾向于估计出平滑变化的增长率，因此它能更好地捕捉指数增长或下降的趋势，因为指数增长对应于恒定的增长率。

在数据稀疏（例如，很长一段时间内没有溯祖事件）的区域，这些模型的行为主要由其先验结构决定。BSP因为没有跨间隔的平滑，其后验不确定性会很大。Skyride会倾向于在数据缺口中进行插值，而Skygrowth则会倾向于外推已有的增长趋势。

### 复杂性与高级主题

简单的模型为我们提供了基础，但真实的[病毒进化](@entry_id:141703)充满了复杂性。本节将讨论一些关键的复杂因素及其对[系统发育](@entry_id:137790)动力学建模的挑战。

#### 传播异质性的影响：[超级传播](@entry_id:202212)

经典的[金曼溯祖](@entry_id:169191)模型隐含了一个假设，即每个个体产生后代的[数量方差](@entry_id:191611)很小。然而，许多病毒性疾病，如SARS、[COVID-19](@entry_id:194691)，都表现出显著的 **[超级传播](@entry_id:202212)（superspreading）** 现象，即少数感染者造成了绝大多数的二次传播。这导致后代数量分布呈现 **重尾（heavy-tailed）** 特征。

这种高度倾斜的[繁殖成功率](@entry_id:166712)从根本上改变了谱系的形成方式。当一个[超级传播](@entry_id:202212)者在单次事件中感染了大量个体时，从这些被感染者中抽取的样本谱系将极有可能在[回溯时间](@entry_id:260844)时，在同一个世代、同一个祖先（即那个超级传播者）处发生合并。这导致了 **多重合并（multiple mergers）** 事件，即超过两条谱系在同一时间点合并。

为了对这类[过程建模](@entry_id:183557)，需要使用[金曼溯祖](@entry_id:169191)的推广，即 **$\Lambda$-溯祖（Lambda-coalescent）** [@problem_id:4374495]。在$\Lambda$-溯祖中，谱系可以以任意大小（$k \ge 2$）的组合进行合并。其合并速率由一个定义在 $[0,1]$ 上的测度 $\Lambda$ 决定。对于后代分布尾部指数为 $\alpha \in (1,2)$ 的情况，其谱系通常收敛于一个特定的 **贝塔溯祖（Beta-coalescent）**，这是一种允许多重合并的$\Lambda$-溯祖。未能考虑多重合并的可能性，可能会导致对病毒传播动态的严重误判。

#### 重组与重配：当一棵树不再足够

大多数基本的系统发育模型都基于一个核心假设：一个[多序列比对](@entry_id:176306)中的所有位点都共享同一棵谱系树。然而，病毒的遗传交换机制常常会打破这个 **单树假设（single-tree assumption）** [@problem_id:4374533]。

- **同源重组（Homologous Recombination）**：在共感染细胞中，当病毒聚合酶在复制一个基因组时，可能会从一个亲本的模板“跳”到另一个同源亲本的模板上。这会产生一个嵌合体后代，其基因组的一部分来自一个祖先，另一部分来自另一个祖先。结果是，基因组不同区域（区块）拥有不同的进化历史（即不同的局部谱系树）。描述这种复杂历史的正确数学对象不再是单一的树，而是一个 **[祖先重组图](@entry_id:189125)（Ancestral Recombination Graph, ARG）**。

- **重配（Reassortment）**：此过程特指 **分段基因组病毒**（如流感病毒、轮状病毒）。当两种不同的病毒株共感染一个细胞时，它们各自的基因组片段在子代病毒包装过程中会随机混合。这导致子代病毒的不同片段继承自不同的亲本。例如，一个流感病毒的第1段可能来自A株，而第2段来自B株。因此，每个基因组片段都有其独立的谱系树。将所有片段拼接起来进行分析，会严重违反单树假设。

这两种机制都意味着，对于整个基因组而言，不存在单一的“真实”谱系树。在分析这类病毒时，必须采用能够解释不同谱系历史的模型，例如分别分析每个片段，或使用更复杂的ARG推断方法。

#### 抽样过程的角色

[系统发育推断](@entry_id:182186)的另一个关键但常被忽视的方面是 **抽样过程** 本身。我们的数据（即病毒序列）并非从疫情中随机均匀获取的。抽样的时间、地点和策略都会影响重建的谱系树，并可能误导我们的推断。

一个重要的现象是 **优先抽样（preferential sampling）** [@problem_id:4374482]，即抽样强度与流行病的状态（如发病率）相关。例如，随着疫情的加剧，公共卫生监测力度可能会加大，导致抽样率不成比例地增加。假设真实的抽样强度 $\psi(t)$ 与发病率 $I(t)$ 之间存在非线性关系，如 $\psi(t) = \alpha [I(t)]^{\beta}$，其中 $\beta \neq 1$。如果分析师天真地假设抽样率与发病率成正比（即假设 $\beta=1$），并基于观察到的样本数量随时间的变化来估计增长率 $r$，那么估计值将会出现系统性偏差。

可以证明，在这种情况下，估计的增长率 $\hat{r}$ 将趋向于 $\beta r$。这会进一步导致对[有效再生数](@entry_id:164900)的估计产生偏差，其关系为 $\hat{R}_t \to 1 + \beta (R_t - 1)$。如果 $\beta > 1$（即抽样强度增长快于发病率），$R_t$ 将被高估；如果 $\beta < 1$（抽样强度增长慢于发病率），$R_t$ 将被低估。这凸显了在模型中明确考虑和说明抽样过程的重要性。

#### 整合宿主内与宿主间动态

病毒的进化发生在多个尺度上：既在单个受感染的宿主体内，也在宿主之间的传播链上。标准的[系统发育](@entry_id:137790)模型通常只关注宿主间的传播（[宏观进化](@entry_id:276416)），但宿主内的动态（微观进化）会对我们观察到的遗传变异产生不可忽视的影响。

当病毒从一个供体传播给一个受体时，通常只有一个或少数病毒谱系通过 **传播瓶颈**。在供体宿主体内，病毒种群本身在进行着复制和演化。在传播事件发生之前，供体内的病毒谱系需要一段时间才能追溯到它们的[共同祖先](@entry_id:175919)。这段在宿主体内发生的溯祖过程，也贡献了总的进化时间（和遗传距离），但它在仅记录了传播日历时间的分析中是“隐藏”的 [@problem_id:4374529]。

根据[溯祖理论](@entry_id:155051)，在供体宿主体内，两条谱系找到[共同祖先](@entry_id:175919)的期望时间（以日历时间为单位）约为 $2 N_e^w g_w$，其中 $N_e^w$ 是宿主体内的[有效种群大小](@entry_id:146802)，$g_w$ 是宿主体内的病毒代际时间。当我们通过比较遗传距离和样本采样时间来估计[分子钟](@entry_id:141071)速率（每单位时间的替换数）时，忽略这一部分“隐藏”的进化时间会导致对[时钟速率](@entry_id:747385)的低估。

一个原则性的校正方法是，在计算总进化时间时，为谱系路径上每经过一个传播事件，就增加一个 $2 N_e^w g_w$ 的时间长度。这样，通过将观察到的日历时间与这些未观察到的宿主体内进化时间相加，才能获得对总进化时间的更准确估计，从而得到更无偏的[分子钟](@entry_id:141071)速率。这说明了[多尺度建模](@entry_id:154964)在精确理解[病毒进化](@entry_id:141703)中的必要性。