{"hands_on_practices": [{"introduction": "在转化医学研究中，一个关键问题是恰当地处理生物学变量。此练习旨在揭示一个常见的陷阱：在分析中忽略像“性别”这样的重要协变量。通过一个假设的临床试验场景，您将推导并量化当性别在各治疗组间分布不均时，忽略性别所引入的偏倚。这个练习将阐明“忽略变量偏倚”的核心原理，并强调在统计模型中考虑所有相关生物学变量以确保研究结论有效性的重要性 [@problem_id:5061100]。", "problem": "一项实用的双臂转化医学研究评估了一种新的脂质调节疗法与标准护理的对比效果。主要终点是12周时低密度脂蛋白胆固醇的变化，以毫克/分升（mg/dL）为单位，用随机变量 $Y$ 表示。设二元治疗指示变量为 $T \\in \\{0,1\\}$，其中 $T=1$ 代表新疗法，$T=0$ 代表标准护理。设二元性别指示变量为 $S \\in \\{0,1\\}$，其中 $S=1$ 代表男性，$S=0$ 代表女性。假设在研究人群中，以下结构性结果模型成立：\n$$\nY \\;=\\; \\beta_{0} \\;+\\; \\beta_{1} T \\;+\\; \\beta_{2} S \\;+\\; \\varepsilon,\n$$\n其中 $E[\\varepsilon \\mid T,S] = 0$ 且不存在治疗与性别的交互作用，因此性别的影响是可加的，并且在不同治疗组中是恒定的。\n\n由于随机化后的差异性保留，性别在各组间的分布不均衡，导致 $T$ 和 $S$ 之间存在相关性。假设边际分布和条件分布如下：\n$$\nP(T=1) \\;=\\; 0.5,\\qquad P(S=1 \\mid T=1) \\;=\\; 0.70,\\qquad P(S=1 \\mid T=0) \\;=\\; 0.40.\n$$\n先前的一项药代动力学-药效学分析已经有力地证明，在保持治疗固定的情况下，男性相对于女性，$Y$ 的降低值平均少 $4$ mg/dL，因此性别系数为：\n$$\n\\beta_{2} \\;=\\; -4 \\;\\text{ mg/dL}.\n$$\n\n一位分析师错误地从模型中省略了性别，并在总体极限下使用普通最小二乘法（OLS, Ordinary Least Squares）对 $Y$ 和 $T$ 进行拟合。将估计的治疗效应中的偏差定义为：\n$$\nB \\;=\\; E\\!\\left[\\hat{\\beta}_{1}^{\\text{omit}}\\right] \\;-\\; \\beta_{1},\n$$\n其中 $\\hat{\\beta}_{1}^{\\text{omit}}$ 是仅将 $Y$ 对 $T$ 回归得到的 OLS 系数。仅从上述线性模型的定义、OLS 正规方程以及方差和协方差的定义出发，推导 $B$ 并计算其数值。以毫克/分升（mg/dL）为单位表示最终偏差。如果需要四舍五入，请将答案保留到四位有效数字。", "solution": "问题陈述经核实具有科学依据、问题明确且客观。它提出了一个统计建模中的标准问题，特别是在临床试验分析的背景下处理遗漏变量偏倚，这是转化医学的核心。所提供的所有数据和条件都是一致且充分的，足以推导出一个唯一且有意义的解。\n\n目标是计算偏差 $B = E[\\hat{\\beta}_{1}^{\\text{omit}}] - \\beta_{1}$。$\\hat{\\beta}_{1}^{\\text{omit}}$ 项代表了仅将结果 $Y$ 对治疗指示变量 $T$ 进行简单线性回归时，$T$ 的系数的普通最小二乘（OLS）估计量。在总体极限下，该估计量收敛于真实的总体参数，该参数由协方差与方差的比值给出：\n$$\nE\\left[\\hat{\\beta}_{1}^{\\text{omit}}\\right] = \\frac{\\text{Cov}(T, Y)}{\\text{Var}(T)}\n$$\n结果 $Y$ 的真实结构模型为：\n$$\nY = \\beta_{0} + \\beta_{1} T + \\beta_{2} S + \\varepsilon\n$$\n其中 $E[\\varepsilon \\mid T,S] = 0$。我们可以将 $Y$ 的这个表达式代入协方差项：\n$$\n\\text{Cov}(T, Y) = \\text{Cov}(T, \\beta_{0} + \\beta_{1} T + \\beta_{2} S + \\varepsilon)\n$$\n利用协方差算子的线性性质，我们展开此表达式：\n$$\n\\text{Cov}(T, Y) = \\text{Cov}(T, \\beta_{0}) + \\text{Cov}(T, \\beta_{1} T) + \\text{Cov}(T, \\beta_{2} S) + \\text{Cov}(T, \\varepsilon)\n$$\n我们逐项计算：\n1.  $\\text{Cov}(T, \\beta_{0}) = 0$，因为随机变量与常数的协方差为零。\n2.  $\\text{Cov}(T, \\beta_{1} T) = \\beta_{1} \\text{Cov}(T, T) = \\beta_{1} \\text{Var}(T)$。\n3.  $\\text{Cov}(T, \\beta_{2} S) = \\beta_{2} \\text{Cov}(T, S)$。\n4.  $\\text{Cov}(T, \\varepsilon) = E[T \\varepsilon] - E[T]E[\\varepsilon]$。根据全期望定律，假设 $E[\\varepsilon \\mid T,S] = 0$ 意味着 $E[\\varepsilon] = E[E[\\varepsilon \\mid T,S]] = 0$。这也意味着 $E[\\varepsilon \\mid T] = E_{S \\mid T}[E[\\varepsilon \\mid T,S]] = 0$。因此，$E[T\\varepsilon] = E[E[T\\varepsilon \\mid T]] = E[T E[\\varepsilon \\mid T]] = E[T \\cdot 0] = 0$。所以，$\\text{Cov}(T, \\varepsilon) = 0 - E[T] \\cdot 0 = 0$。\n\n将这些代回，得到：\n$$\n\\text{Cov}(T, Y) = \\beta_{1} \\text{Var}(T) + \\beta_{2} \\text{Cov}(T, S)\n$$\n现在我们可以写出 $E[\\hat{\\beta}_{1}^{\\text{omit}}]$ 的完整表达式：\n$$\nE\\left[\\hat{\\beta}_{1}^{\\text{omit}}\\right] = \\frac{\\beta_{1} \\text{Var}(T) + \\beta_{2} \\text{Cov}(T, S)}{\\text{Var}(T)} = \\beta_{1} + \\beta_{2} \\frac{\\text{Cov}(T, S)}{\\text{Var}(T)}\n$$\n偏差 $B$ 于是推导为：\n$$\nB = E\\left[\\hat{\\beta}_{1}^{\\text{omit}}\\right] - \\beta_{1} = \\left(\\beta_{1} + \\beta_{2} \\frac{\\text{Cov}(T, S)}{\\text{Var}(T)}\\right) - \\beta_{1} = \\beta_{2} \\frac{\\text{Cov}(T, S)}{\\text{Var}(T)}\n$$\n为了计算 $B$ 的数值，我们必须根据给定的概率计算 $\\text{Var}(T)$ 和 $\\text{Cov}(T, S)$。由于 $T \\in \\{0, 1\\}$，变量 $T$ 是一个伯努利随机变量。\n给定 $P(T=1) = 0.5$，$T$ 的期望和方差为：\n$$\nE[T] = P(T=1) = 0.5\n$$\n$$\n\\text{Var}(T) = E[T^2] - (E[T])^2 = P(T=1) - (P(T=1))^2 = 0.5 - (0.5)^2 = 0.5 - 0.25 = 0.25\n$$\n接下来，我们计算 $\\text{Cov}(T, S) = E[TS] - E[T]E[S]$。变量 $S$ 也是伯努利变量，$S \\in \\{0, 1\\}$。\n我们需要计算 $E[S]$ 和 $E[TS]$。\n$S$ 的期望是 $E[S] = P(S=1)$。使用全概率定律：\n$$\nP(S=1) = P(S=1 \\mid T=1)P(T=1) + P(S=1 \\mid T=0)P(T=0)\n$$\n我们已知 $P(T=1)=0.5$，所以 $P(T=0) = 1 - 0.5 = 0.5$。\n$$\nP(S=1) = (0.70)(0.5) + (0.40)(0.5) = 0.35 + 0.20 = 0.55\n$$\n所以，$E[S] = 0.55$。\n对于二元变量，乘积 $TS$ 的期望是联合概率 $P(T=1, S=1)$：\n$$\nE[TS] = P(T=1, S=1)\n$$\n使用条件概率的定义，$P(T=1, S=1) = P(S=1 \\mid T=1)P(T=1)$：\n$$\nE[TS] = (0.70)(0.5) = 0.35\n$$\n现在我们计算协方差：\n$$\n\\text{Cov}(T, S) = E[TS] - E[T]E[S] = 0.35 - (0.5)(0.55) = 0.35 - 0.275 = 0.075\n$$\n最后，我们将已知和计算出的值代入偏差 $B$ 的公式。我们已知 $\\beta_{2} = -4$ mg/dL。\n$$\nB = \\beta_{2} \\frac{\\text{Cov}(T, S)}{\\text{Var}(T)} = (-4) \\frac{0.075}{0.25}\n$$\n该比值为 $\\frac{0.075}{0.25} = 0.3$。\n$$\nB = -4 \\times 0.3 = -1.2\n$$\n估计的治疗效应中的偏差为 $-1.2$ mg/dL。这个值是精确的，不需要四舍五入。", "answer": "$$\n\\boxed{-1.2}\n$$", "id": "5061100"}, {"introduction": "超越仅仅将性别作为混杂因素进行调整，研究人员通常更感兴趣的是探索治疗效果是否存在性别差异，即检验“性别-治疗”交互作用。然而，要可靠地检测到这种交互作用，需要在研究设计阶段进行仔细的规划，尤其是样本量的计算。本练习将指导您在一个药效学研究的背景下，为一个非线性的 $E_{\\max}$ 模型推导样本量公式，旨在为您提供设计有足够统计功效来检验性别特异性效应的研究的实践技能 [@problem_id:5061099]。", "problem": "一项转化药效学研究将评估一个 $E_{\\max}$ 药效学 (PD) 模型中的性别与治疗的交互作用，并将性别视为一个生物学变量。对于剂量为 $d$、性别指示符为 $S \\in \\{-1, +1\\}$（例如，女性为 $S=+1$，男性为 $S=-1$）的个体，其响应模型为：\n$$\n\\mu(d,S) \\;=\\; E_{0} \\;+\\; \\big(E_{\\max} \\;+\\; \\psi\\,S\\big)\\,\\frac{d}{ED_{50} + d},\n$$\n其中 $E_{0}$ 是基线响应，$E_{\\max}$ 是最大药物效应，$ED_{50}$ 是产生 $E_{\\max}$ 一半效应的剂量，$\\psi$ 是性别与治疗的交互作用参数，它根据性别调节 $E_{\\max}$。假设误差是独立的、同方差的、服从正态分布，且方差为 $\\sigma^{2}$。\n\n该研究将在四个剂量水平 $d \\in \\{0, 10, 30, 100\\}\\,\\mathrm{mg}$ 上按性别平均随机分配受试者，并在每个性别-剂量单元内进行等量分配。为了设计计算，将 $ED_{50}$ 视为已知且等于 $20\\,\\mathrm{mg}$，并假设残差方差为 $\\sigma^{2}=0.64$。研究者希望在显著性水平 $\\alpha=0.05$ 和期望功效 $1-\\beta=0.90$ 的条件下，使用双侧假设检验来检测一个真实的交互作用 $\\psi=\\psi^{\\star}=0.25$（单位为响应单位）。\n\n从适用于转化药理学中非线性回归的第一性原理出发——即均值函数的一阶泰勒线性化、在正则条件下 $\\psi$ 估计量的渐近正态性以及瓦尔德检验——推导出在给定平衡设计下的样本量公式，并计算在这些假设下达到所需功效所需的最小总样本量 $N$（涵盖所有性别和剂量）。使用瓦尔德检验的标准正态临界值，忽略有限样本校正，并取在 $2 \\times 4$ 个单元格中等量分配下，能达到或超过目标功效的最小整数 $N$。将 $N$ 报告为一个不带单位的整数。", "solution": "用户提供的问题是有效的。它在药效学和生物统计学方面有科学依据，内容自洽，且提法明确。提供了唯一解所需的所有必要参数和条件。\n\n目标是推导检测特定性别-治疗交互作用效应 $\\psi$ 所需的总样本量 $N$ 的公式，并计算其数值。推导将基于非线性均值函数的一阶泰勒展开、参数估计量的渐近性质以及瓦尔德检验。\n\n个体的药效学响应模型由下式给出：\n$$\n\\mu(d,S) = E_{0} + (E_{\\max} + \\psi S) \\frac{d}{ED_{50} + d}\n$$\n其中 $d$ 是剂量，$S \\in \\{-1, +1\\}$ 是性别指示符。待估计的参数是 $\\theta = (E_{0}, E_{\\max}, \\psi)^T$。为了设计的目的，$ED_{50}$ 被认为是已知的。我们将模型的剂量依赖部分定义为 $g(d) = \\frac{d}{ED_{50} + d}$。那么均值函数可以写成：\n$$\n\\mu(d, S; \\theta) = E_{0} + (E_{\\max} + \\psi S) g(d)\n$$\n观测值的方差是 $\\sigma^2$。对于单个观测值，费雪信息矩阵 (FIM) 由 $I(\\theta) = \\frac{1}{\\sigma^2} \\left(\\frac{\\partial \\mu}{\\partial \\theta}\\right) \\left(\\frac{\\partial \\mu}{\\partial \\theta}\\right)^T$ 给出。我们首先计算均值函数相对于参数 $\\theta = (E_{0}, E_{\\max}, \\psi)^T$ 的梯度：\n$$\n\\frac{\\partial \\mu}{\\partial \\theta} = \\begin{pmatrix} \\frac{\\partial \\mu}{\\partial E_{0}} \\\\ \\frac{\\partial \\mu}{\\partial E_{\\max}} \\\\ \\frac{\\partial \\mu}{\\partial \\psi} \\end{pmatrix} = \\begin{pmatrix} 1 \\\\ g(d) \\\\ S \\cdot g(d) \\end{pmatrix}\n$$\n那么，对于一个剂量为 $d$、性别为 $S$ 的受试者，其费雪信息矩阵为：\n$$\nI(d, S) = \\frac{1}{\\sigma^2} \\begin{pmatrix} 1 \\\\ g(d) \\\\ S g(d) \\end{pmatrix} \\begin{pmatrix} 1  g(d)  S g(d) \\end{pmatrix} = \\frac{1}{\\sigma^2} \\begin{pmatrix} 1  g(d)  S g(d) \\\\ g(d)  g(d)^2  S g(d)^2 \\\\ S g(d)  S g(d)^2  S^2 g(d)^2 \\end{pmatrix}\n$$\n由于 $S \\in \\{-1, +1\\}$，我们有 $S^2 = 1$。\n$$\nI(d, S) = \\frac{1}{\\sigma^2} \\begin{pmatrix} 1  g(d)  S g(d) \\\\ g(d)  g(d)^2  S g(d)^2 \\\\ S g(d)  S g(d)^2  g(d)^2 \\end{pmatrix}\n$$\n研究设计指定总样本量为 $N$，在 2 个性别和 4 个剂量水平上进行等量分配，共产生 8 个单元格。设每个单元格的受试者数量为 $n$，则 $N = 8n$。总费雪信息矩阵 $I_N$ 是所有 $N$ 个受试者的个体费雪信息矩阵之和。由于是平衡设计，这等于 $n$ 乘以在 8 个唯一设计单元格 $(d_k, S_j)$ 上的费雪信息矩阵之和：\n$$\nI_N = n \\sum_{k=1}^{4} \\sum_{j \\in \\{-1, +1\\}} I(d_k, S_j) = \\frac{n}{\\sigma^2} \\sum_{k=1}^{4} \\left( \\begin{pmatrix} 1  g(d_k)  -g(d_k) \\\\ g(d_k)  g(d_k)^2  -g(d_k)^2 \\\\ -g(d_k)  -g(d_k)^2  g(d_k)^2 \\end{pmatrix} + \\begin{pmatrix} 1  g(d_k)  +g(d_k) \\\\ g(d_k)  g(d_k)^2  +g(d_k)^2 \\\\ +g(d_k)  +g(d_k)^2  g(d_k)^2 \\end{pmatrix} \\right)\n$$\n对每个剂量水平 $d_k$ 的性别指示符 $S$ 求和可得：\n$$\nI_N = \\frac{n}{\\sigma^2} \\sum_{k=1}^{4} \\begin{pmatrix} 2  2g(d_k)  0 \\\\ 2g(d_k)  2g(d_k)^2  0 \\\\ 0  0  2g(d_k)^2 \\end{pmatrix}\n$$\n这种块对角结构是性别方面平衡设计的结果，使得 $\\psi$ 的估计量与 $E_0$ 和 $E_{\\max}$ 的估计量渐近正交。对四个剂量水平 $d_k \\in \\{0, 10, 30, 100\\}$ 求和：\n$$\nI_N = \\frac{2n}{\\sigma^2} \\begin{pmatrix} \\sum_{k=1}^{4} 1  \\sum_{k=1}^{4} g(d_k)  0 \\\\ \\sum_{k=1}^{4} g(d_k)  \\sum_{k=1}^{4} g(d_k)^2  0 \\\\ 0  0  \\sum_{k=1}^{4} g(d_k)^2 \\end{pmatrix} = \\frac{2n}{\\sigma^2} \\begin{pmatrix} 4  \\sum g(d_k)  0 \\\\ \\sum g(d_k)  \\sum g(d_k)^2  0 \\\\ 0  0  \\sum g(d_k)^2 \\end{pmatrix}\n$$\n$\\hat{\\psi}$ 的渐近方差是 $I_N$ 的第 $(3,3)$ 个元素的逆：\n$$\n\\mathrm{Var}(\\hat{\\psi}) = \\left( [I_N]_{33} \\right)^{-1} = \\left( \\frac{2n}{\\sigma^2} \\sum_{k=1}^{4} g(d_k)^2 \\right)^{-1} = \\frac{\\sigma^2}{2n \\sum_{k=1}^{4} g(d_k)^2}\n$$\n代入 $n = N/8$：\n$$\n\\mathrm{Var}(\\hat{\\psi}) = \\frac{\\sigma^2}{2(N/8) \\sum g(d_k)^2} = \\frac{4\\sigma^2}{N \\sum g(d_k)^2}\n$$\n对于假设 $H_0: \\psi=0$ 与 $H_a: \\psi \\neq 0$ 的瓦尔德检验统计量是 $W = \\hat{\\psi} / \\mathrm{SE}(\\hat{\\psi})$，其中 $\\mathrm{SE}(\\hat{\\psi}) = \\sqrt{\\mathrm{Var}(\\hat{\\psi})}$。对于一个显著性水平为 $\\alpha$、功效为 $1-\\beta$ 的双侧检验，要检测出效应 $\\psi = \\psi^{\\star}$，所需的样本量必须满足：\n$$\n\\frac{|\\psi^{\\star}|}{\\mathrm{SE}(\\hat{\\psi})} \\ge z_{1-\\alpha/2} + z_{1-\\beta}\n$$\n其中 $z_q$ 是标准正态分布的第 $q$ 个分位数。代入 $\\mathrm{SE}(\\hat{\\psi})$ 的表达式：\n$$\n\\frac{|\\psi^{\\star}| \\sqrt{N \\sum g(d_k)^2}}{2\\sigma} \\ge z_{1-\\alpha/2} + z_{1-\\beta}\n$$\n解出 $N$ 可得样本量公式：\n$$\nN \\ge \\frac{4\\sigma^2 (z_{1-\\alpha/2} + z_{1-\\beta})^2}{(\\psi^{\\star})^2 \\sum_{k=1}^{4} g(d_k)^2}\n$$\n我们现在代入给定的值。剂量水平为 $d \\in \\{0, 10, 30, 100\\}$ 且 $ED_{50}=20$。$g(d) = d/(20+d)$ 的值为：\n$g(0) = \\frac{0}{20+0} = 0$\n$g(10) = \\frac{10}{20+10} = \\frac{1}{3}$\n$g(30) = \\frac{30}{20+30} = \\frac{3}{5}$\n$g(100) = \\frac{100}{20+100} = \\frac{5}{6}$\n\n平方和为：\n$$\n\\sum_{k=1}^{4} g(d_k)^2 = 0^2 + \\left(\\frac{1}{3}\\right)^2 + \\left(\\frac{3}{5}\\right)^2 + \\left(\\frac{5}{6}\\right)^2 = \\frac{1}{9} + \\frac{9}{25} + \\frac{25}{36}\n$$\n$9$、$25$ 和 $36$ 的最小公倍数是 $900$。\n$$\n\\sum_{k=1}^{4} g(d_k)^2 = \\frac{100}{900} + \\frac{324}{900} + \\frac{625}{900} = \\frac{1049}{900}\n$$\n其他参数为：$\\sigma^2 = 0.64$，$\\psi^{\\star} = 0.25$，$\\alpha=0.05$，以及 $1-\\beta=0.90$。临界值为 $z_{1-0.05/2} = z_{0.975} \\approx 1.96$ 和 $z_{1-0.10} = z_{0.90} \\approx 1.2816$。\n\n将这些值代入样本量公式：\n$$\nN \\ge \\frac{4(0.64) (1.96 + 1.2816)^2}{(0.25)^2 \\left(\\frac{1049}{900}\\right)}\n$$\n$$\nN \\ge \\frac{2.56 \\cdot (3.2416)^2}{0.0625 \\cdot \\frac{1049}{900}} = \\frac{2.56 \\cdot 10.50797056}{\\frac{1049}{14400}}\n$$\n$$\nN \\ge \\frac{26.9004046... \\cdot 14400}{1049} = \\frac{387365.826...}{1049} \\approx 369.27\n$$\n总样本量 $N$ 必须是一个整数。此外，设计要求在 8 个性别-剂量单元格中等量分配，这意味着 $N$ 必须是 8 的倍数。我们必须找到大于或等于 $369.27$ 的最小的 8 的倍数。\n$369.27 / 8 \\approx 46.16$。下一个整数是 $47$。\n因此，每个单元格所需的受试者数量为 $n=47$。所需的最小总样本量为 $N = 8 \\times n = 8 \\times 47 = 376$。", "answer": "$$\\boxed{376}$$", "id": "5061099"}, {"introduction": "将研究发现转化为临床实践是转化医学的最终目标。本练习模拟了这一过程，关注于如何根据药物代谢动力学（PK）的性别差异来调整给药方案。具体来说，如果已知药物的清除率（$CL$）和生物利用度（$F$）在女性月经周期的不同阶段存在差异，我们应如何个性化给药？通过这个动手编程练习，您将基于基础药代动力学原理 $AUC = \\frac{D \\cdot F}{CL}$ 设计一个剂量调整规则，并利用模拟来验证该规则在不同生理阶段下稳定药物暴露水平的有效性，从而将性别作为生物学变量的考量付诸于实践 [@problem_id:5061066]。", "problem": "要求您形式化一个给药规则，该规则考虑了月经周期阶段对清除率和生物利用度的影响，并使用在转化医学中标准的简单线性药代动力学模型来量化此规则如何影响暴露变异性。该建模必须通过纳入月经周期阶段，明确地将性别作为一种生物学变量来处理。从以下基本关系出发：在一个具有一级消除的单室线性药代动力学系统中，单次口服剂量的浓度-时间曲线下面积 (Area Under the Curve, AUC) 由 $AUC = \\dfrac{D \\cdot F}{CL}$ 给出，其中 $D$ 是剂量，$F$ 是吸收分数（生物利用度），$CL$ 是清除率。月经周期阶段可以通过生物学上合理的机制调节 $CL$ 和 $F$（例如，激素介导的肝血流量或胃肠生理学的变化）。\n\n您的任务是：\n1) 基于基本关系 $AUC = \\dfrac{D \\cdot F}{CL}$，推导一个特定阶段的给药规则，该规则在假定线性动力学的情况下，将各个不同月经阶段的预期 AUC 均衡到某个选定的参考阶段的水平。使用每个阶段的典型（群体平均）参数来构建给药规则，并将参考 AUC 定义为在指定参考剂量下，参考阶段的预期 AUC。不要假设在剂量间隔内存在任何非线性动力学或时变清除率。\n2) 实现一个模拟，利用个体间变异来估计在采用和不采用此给药规则的情况下，每个阶段的预期 AUC。将 $CL$ 和 $F$ 的个体间变异建模为独立的对数正态随机变量，其中心为其特定阶段的平均值，并具有指定的变异系数（coefficient of variation, CV）。要构建一个算术平均值为 $\\mu$、变异系数为 $CV_X$（表示为小数，例如 $0.3$）的对数正态变量 $X$，请使用参数化 $X = \\mu \\cdot \\exp(\\eta)$，其中 $\\eta \\sim \\mathcal{N}(-\\tfrac{1}{2}\\sigma^2, \\sigma^2)$ 且 $\\sigma^2 = \\ln(1 + CV_X^2)$。假设 $CL$ 和 $F$ 之间以及各阶段之间相互独立。\n\n各阶段按 $[$月经期 (menses), 卵泡期 (follicular), 排卵期 (ovulatory), 黄体期 (luteal)$]$ 排序。假设给药规则的参考阶段是卵泡期。对于下文的每个测试用例，执行以下操作：\n- 计算每个阶段的调整剂量，使预期 AUC 与卵泡期的预期 AUC 相等（基于各阶段的平均值）。\n- 使用指定的种子，为每个阶段模拟 $N$ 个虚拟参与者，如上所述抽取 $CL_i$ 和 $F_i$。对于未调整的场景，计算 $AUC_i = \\dfrac{D_{\\text{ref}} \\cdot F_i}{CL_i}$。对于调整后的场景，计算 $AUC_i = \\dfrac{D_{\\text{phase}} \\cdot F_i}{CL_i}$。\n- 对于每个阶段和场景，报告 $N$ 个样本的算术平均 AUC。AUC 以 mg·h/L 为单位表示，四舍五入到三位小数。调整后的剂量以 mg 为单位报告，四舍五入到三位小数。变异系数以小数形式提供（例如，用 $0.3$ 而不是 $30$ percent）。\n- 本问题不使用角度。\n- 所有需要单位的物理量必须使用指定的单位表示。AUC 使用 mg·h/L；剂量使用 mg；清除率使用 L/h；生物利用度使用无单位分数。\n\n测试套件（三个用例）：\n- 用例 $1$（常规情况）：\n  - 参考剂量 $D_{\\text{ref}} = $ $100$ mg；基础清除率 $CL_{\\text{base}} = $ $12$ L/h；基础生物利用度 $F_{\\text{base}} = $ $0.6$。\n  - 清除率的阶段乘数：月经期 $1.0$，卵泡期 $0.95$，排卵期 $0.90$，黄体期 $1.10$。\n  - 生物利用度的阶段乘数：月经期 $0.95$，卵泡期 $1.00$，排卵期 $1.05$，黄体期 $1.10$。\n  - 个体间变异：$CV_{CL} = $ $0.30$，$CV_{F} = $ $0.20$。\n  - 模拟规模 $N = $ $50000$，随机种子 $11$。\n- 用例 $2$（边界情况：无阶段效应，无变异）：\n  - 参考剂量 $D_{\\text{ref}} = $ $100$ mg；基础清除率 $CL_{\\text{base}} = $ $10$ L/h；基础生物利用度 $F_{\\text{base}} = $ $0.5$。\n  - 清除率的阶段乘数：月经期 $1.0$，卵泡期 $1.0$，排卵期 $1.0$，黄体期 $1.0$。\n  - 生物利用度的阶段乘数：月经期 $1.0$，卵泡期 $1.0$，排卵期 $1.0$，黄体期 $1.0$。\n  - 个体间变异：$CV_{CL} = $ $0.0$，$CV_{F} = $ $0.0$。\n  - 模拟规模 $N = $ $1000$，随机种子 $7$。\n- 用例 $3$（边缘情况：强阶段偏移和高变异）：\n  - 参考剂量 $D_{\\text{ref}} = $ $50$ mg；基础清除率 $CL_{\\text{base}} = $ $20$ L/h；基础生物利用度 $F_{\\text{base}} = $ $0.3$。\n  - 清除率的阶段乘数：月经期 $1.20$，卵泡期 $1.00$，排卵期 $0.85$，黄体期 $1.10$。\n  - 生物利用度的阶段乘数：月经期 $0.80$，卵泡期 $1.00$, 排卵期 $1.20$，黄体期 $0.90$。\n  - 个体间变异：$CV_{CL} = $ $0.60$，$CV_{F} = $ $0.40$。\n  - 模拟规模 $N = $ $40000$，随机种子 $23$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。每个元素对应于上面列出的一个测试用例，并且其本身必须是一个包含三个列表的列表：\n- 第一个内部列表包含在未调整的参考剂量 $D_{\\text{ref}}$ 下的四个特定阶段的平均 AUC 值，单位为 mg·h/L，\n- 第二个内部列表包含在调整剂量下的四个特定阶段的平均 AUC 值，单位为 mg·h/L，\n- 第三个内部列表包含四个特定阶段的调整剂量，单位为 mg。\n\n所有浮点数必须四舍五入到三位小数。每个内部列表中的阶段顺序为 $[$menses, follicular, ovulatory, luteal$]$。例如，整体格式必须为\n$[$ $[$ $[$fixed\\_menses$, $fixed\\_follicular$, $fixed\\_ovulatory$, $fixed\\_luteal$ $]$, $[$adjusted\\_menses$, $adjusted\\_follicular$, $adjusted\\_ovulatory$, $adjusted\\_luteal$ $]$, $[$dose\\_menses$, $dose\\_follicular$, $dose\\_ovulatory$, $dose\\_luteal$ $]$ $]$, $[$\\dots$]$, $[$\\dots$]$ $]$。", "solution": "从基础的线性药代动力学关系开始，对于单次口服给药：$AUC = \\dfrac{D \\cdot F}{CL}$，其中 $D$ 是剂量 (mg)，$F$ 是生物利用度（无单位分数），$CL$ 是清除率 (L/h)。设月经周期阶段索引为 $p \\in \\{\\text{menses}, \\text{follicular}, \\text{ovulatory}, \\text{luteal}\\}$。设 $CL_{\\text{base}}$ 和 $F_{\\text{base}}$ 为基线值，$\\theta_{CL,p}$ 和 $\\theta_{F,p}$ 为乘性阶段效应，使得特定阶段的平均值为 $CL_p = CL_{\\text{base}} \\cdot \\theta_{CL,p}$ 和 $F_p = F_{\\text{base}} \\cdot \\theta_{F,p}$。\n\n给药规则的推导。选择一个参考阶段 $r$（此处为卵泡期）和一个参考剂量 $D_{\\text{ref}}$。在典型水平（忽略个体间变异）下的参考预期 AUC 是\n$$AUC_r^{\\star} = \\frac{D_{\\text{ref}} \\cdot F_r}{CL_r}.$$\n为了将另一个阶段 $p$ 的典型 AUC 均衡到这个参考目标，选择一个特定阶段的剂量 $D_p$，使得在阶段平均值水平上，\n$$\\frac{D_p \\cdot F_p}{CL_p} = \\frac{D_{\\text{ref}} \\cdot F_r}{CL_r}.$$\n解出 $D_p$ 得\n$$D_p = D_{\\text{ref}} \\cdot \\frac{CL_p / F_p}{CL_r / F_r}.$$\n该规则直接源于基础方程中的比例关系：为保持 $AUC$ 不变，剂量与 $CL/F$ 成正比。\n\n个体间变异的建模。对于阶段 $p$ 中的每个参与者 $i$，将 $CL_{p,i}$ 和 $F_{p,i}$ 建模为独立的对数正态随机变量，其中心为阶段平均值 $CL_p$ 和 $F_p$，并具有指定的变异系数 $CV_{CL}$ 和 $CV_{F}$（小数形式）。对于一个算术平均值为 $\\mu$、变异系数为 $CV_X$ 的通用量 $X$，定义 $\\sigma_X^2 = \\ln(1 + CV_X^2)$ 并抽样\n$$X_i = \\mu \\cdot \\exp(\\eta_i), \\quad \\eta_i \\sim \\mathcal{N}\\!\\left(-\\frac{1}{2}\\sigma_X^2,\\ \\sigma_X^2\\right).$$\n此参数化确保 $\\mathbb{E}[X_i] = \\mu$ 且 $\\text{Var}(X_i) = (e^{\\sigma_X^2} - 1)\\mu^2$，因此算术变异系数等于 $CV_X$。\n\n对于每个阶段 $p$，为每个参与者 $i$ 计算两组 AUC：\n- 未调整（参考剂量）：$AUC_{p,i}^{(\\text{fixed})} = \\dfrac{D_{\\text{ref}} \\cdot F_{p,i}}{CL_{p,i}}$。\n- 调整后（特定阶段剂量）：$AUC_{p,i}^{(\\text{adj})} = \\dfrac{D_p \\cdot F_{p,i}}{CL_{p,i}}$。\n\n报告每个阶段在 $i = 1, \\dots, N$ 上的算术平均值。因为 $F_{p,i}$ 和 $CL_{p,i}$ 是独立的对数正态变量，中心在平均值 $F_p$ 和 $CL_p$ 上，所以未调整的预期 AUC 满足\n$$\\mathbb{E}\\!\\left[AUC_{p,i}^{(\\text{fixed})}\\right] = D_{\\text{ref}} \\cdot \\mathbb{E}\\!\\left[\\frac{F_{p,i}}{CL_{p,i}}\\right] = D_{\\text{ref}} \\cdot \\mathbb{E}[F_{p,i}] \\cdot \\mathbb{E}\\!\\left[\\frac{1}{CL_{p,i}}\\right].$$\n使用上述对数正态参数化，$\\mathbb{E}[F_{p,i}] = F_p$，且如果 $CL_{p,i} = CL_p \\cdot Z$（其中 $Z$ 是对数正态且 $\\mathbb{E}[Z] = 1$），则 $\\mathbb{E}\\!\\left[\\tfrac{1}{CL_{p,i}}\\right] = \\tfrac{1}{CL_p} \\cdot \\mathbb{E}\\!\\left[\\tfrac{1}{Z}\\right] = \\tfrac{1}{CL_p} \\cdot e^{\\sigma_{CL}^2}$。因此，\n$$\\mathbb{E}\\!\\left[AUC_{p,i}^{(\\text{fixed})}\\right] = \\frac{D_{\\text{ref}} \\cdot F_p}{CL_p} \\cdot e^{\\sigma_{CL}^2}.$$\n对于调整剂量 $D_p = D_{\\text{ref}} \\cdot \\dfrac{CL_p / F_p}{CL_r / F_r}$，预期的调整后 AUC 变为\n$$\\mathbb{E}\\!\\left[AUC_{p,i}^{(\\text{adj})}\\right] = \\left(D_{\\text{ref}} \\cdot \\frac{CL_p / F_p}{CL_r / F_r}\\right) \\cdot \\frac{F_p}{CL_p} \\cdot e^{\\sigma_{CL}^2} = \\frac{D_{\\text{ref}} \\cdot F_r}{CL_r} \\cdot e^{\\sigma_{CL}^2},$$\n当 $CV_{CL}$ 在各阶段相同时，对于给定的测试用例，该值在各阶段是恒定的。因此，给药规则将各阶段的预期 AUC 均衡起来，相差一个由清除率变异性引起的乘法因子 $e^{\\sigma_{CL}^2}$；在给定假设下，此因子是阶段不变的。在零变异的特殊情况下（$CV_{CL} = 0$），我们有 $\\sigma_{CL}^2 = 0$，预期的调整后 AUC 完全等于确定性目标 $\\dfrac{D_{\\text{ref}} \\cdot F_r}{CL_r}$。\n\n算法实现步骤：\n1) 对于每个用例，计算阶段平均值 $CL_p = CL_{\\text{base}} \\cdot \\theta_{CL,p}$ 和 $F_p = F_{\\text{base}} \\cdot \\theta_{F,p}$。将参考阶段 $r$ 确定为卵泡期。\n2) 对于阶段 $p \\in \\{\\text{menses}, \\text{follicular}, \\text{ovulatory}, \\text{luteal}\\}$，计算调整剂量 $D_p = D_{\\text{ref}} \\cdot \\dfrac{CL_p / F_p}{CL_r / F_r}$。\n3) 对于每个阶段，使用 $\\sigma_{CL}^2 = \\ln(1 + CV_{CL}^2)$ 和 $\\sigma_{F}^2 = \\ln(1 + CV_{F}^2)$，以及 $\\eta_{CL} \\sim \\mathcal{N}(-\\tfrac{1}{2}\\sigma_{CL}^2, \\sigma_{CL}^2)$ 和 $\\eta_{F} \\sim \\mathcal{N}(-\\tfrac{1}{2}\\sigma_{F}^2, \\sigma_{F}^2)$，抽取 $N$ 个 $CL_{p,i}$ 和 $F_{p,i}$ 样本作为中心在 $CL_p$ 和 $F_p$ 的独立对数正态变量，其中 $CL_{p,i} = CL_p \\cdot e^{\\eta_{CL}}$，$F_{p,i} = F_p \\cdot e^{\\eta_{F}}$。\n4) 分别计算在未调整和调整剂量下每个阶段的样本平均 AUC，即 $\\dfrac{D_{\\text{ref}} \\cdot F_{p,i}}{CL_{p,i}}$ 和 $\\dfrac{D_p \\cdot F_{p,i}}{CL_{p,i}}$ 的算术平均值。\n5) 按照指定的阶段顺序和输出格式，将所有平均 AUC 四舍五入到三位小数 (mg·h/L)，并将调整剂量四舍五入到三位小数 (mg)。\n\n测试套件涵盖的边缘情况和预期：\n- 用例 1 展示了典型的中等周期效应和变异性。调整后的平均 AUC 在各阶段应大致相等。\n- 用例 2 没有阶段效应且变异为零；调整剂量等于参考剂量，未调整和调整后的平均 AUC 在各阶段均相同，并与确定性目标完全匹配。\n- 用例 3 通过强烈的阶段偏移和高变异性来对算法进行压力测试；未调整的平均 AUC 相差悬殊，而调整后的平均 AUC 则趋于一致，这说明了月经周期中性别特异性生理变异在给药决策中的作用。\n\n最终程序精确遵循这些步骤，并打印一个嵌套列表，其中包含每个用例的四个未调整平均 AUC、四个调整后平均 AUC 和四个调整剂量，按此顺序排列，所有数值均四舍五入到三位小数，以匹配强制的单行输出格式。", "answer": "```python\nimport numpy as np\n\ndef lognormal_samples(mean_value, cv, size, rng):\n    \"\"\"\n    Generate log-normal samples with given arithmetic mean (mean_value) and coefficient of variation (cv).\n    Returns an array of shape (size,).\n    \"\"\"\n    if cv  0:\n        raise ValueError(\"CV must be non-negative.\")\n    sigma2 = np.log(1.0 + cv**2)\n    # When cv == 0, sigma2 == 0 and the distribution collapses to a point mass at mean_value.\n    if sigma2 == 0.0:\n        return np.full(size, mean_value, dtype=float)\n    mu = -0.5 * sigma2\n    return mean_value * np.exp(rng.normal(loc=mu, scale=np.sqrt(sigma2), size=size))\n\ndef simulate_case(dose_ref_mg, cl_base_lph, f_base, theta_cl, theta_f, cv_cl, cv_f, n, seed):\n    \"\"\"\n    Simulate one test case.\n    Returns:\n        fixed_means: list of 4 floats (mean AUC per phase under fixed dose)\n        adjusted_means: list of 4 floats (mean AUC per phase under adjusted dose)\n        adjusted_doses: list of 4 floats (adjusted dose per phase)\n    \"\"\"\n    phases = [\"menses\", \"follicular\", \"ovulatory\", \"luteal\"]\n    # Compute phase means\n    cl_phase = {p: cl_base_lph * theta_cl[p] for p in phases}\n    f_phase = {p: f_base * theta_f[p] for p in phases}\n    # Reference phase is follicular\n    ref = \"follicular\"\n    # Adjusted doses per phase\n    # D_p = D_ref * (CL_p / F_p) / (CL_ref / F_ref)\n    cl_over_f_ref = cl_phase[ref] / f_phase[ref]\n    adjusted_doses = []\n    for p in phases:\n        dose_adj = dose_ref_mg * (cl_phase[p] / f_phase[p]) / cl_over_f_ref\n        adjusted_doses.append(dose_adj)\n    # Simulate\n    rng = np.random.default_rng(seed)\n    fixed_means = []\n    adjusted_means = []\n    for idx, p in enumerate(phases):\n        cl_samples = lognormal_samples(cl_phase[p], cv_cl, n, rng)\n        f_samples = lognormal_samples(f_phase[p], cv_f, n, rng)\n        # Avoid division by zero (not expected with log-normal, but guard anyway)\n        cl_samples = np.where(cl_samples == 0, np.finfo(float).tiny, cl_samples)\n        auc_fixed = dose_ref_mg * f_samples / cl_samples\n        auc_adj = adjusted_doses[idx] * f_samples / cl_samples\n        fixed_means.append(float(np.mean(auc_fixed)))\n        adjusted_means.append(float(np.mean(auc_adj)))\n    # Round results to three decimals\n    fixed_means = [round(x, 3) for x in fixed_means]\n    adjusted_means = [round(x, 3) for x in adjusted_doses]\n    adjusted_doses = [round(x, 3) for x in adjusted_doses]\n    return fixed_means, adjusted_means, adjusted_doses\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Case 1\n    case1 = {\n        \"dose_ref_mg\": 100.0,\n        \"cl_base_lph\": 12.0,\n        \"f_base\": 0.6,\n        \"theta_cl\": {\"menses\": 1.0, \"follicular\": 0.95, \"ovulatory\": 0.90, \"luteal\": 1.10},\n        \"theta_f\": {\"menses\": 0.95, \"follicular\": 1.00, \"ovulatory\": 1.05, \"luteal\": 1.10},\n        \"cv_cl\": 0.30,\n        \"cv_f\": 0.20,\n        \"n\": 50000,\n        \"seed\": 11,\n    }\n    # Case 2\n    case2 = {\n        \"dose_ref_mg\": 100.0,\n        \"cl_base_lph\": 10.0,\n        \"f_base\": 0.5,\n        \"theta_cl\": {\"menses\": 1.0, \"follicular\": 1.0, \"ovulatory\": 1.0, \"luteal\": 1.0},\n        \"theta_f\": {\"menses\": 1.0, \"follicular\": 1.0, \"ovulatory\": 1.0, \"luteal\": 1.0},\n        \"cv_cl\": 0.0,\n        \"cv_f\": 0.0,\n        \"n\": 1000,\n        \"seed\": 7,\n    }\n    # Case 3\n    case3 = {\n        \"dose_ref_mg\": 50.0,\n        \"cl_base_lph\": 20.0,\n        \"f_base\": 0.3,\n        \"theta_cl\": {\"menses\": 1.20, \"follicular\": 1.00, \"ovulatory\": 0.85, \"luteal\": 1.10},\n        \"theta_f\": {\"menses\": 0.80, \"follicular\": 1.00, \"ovulatory\": 1.20, \"luteal\": 0.90},\n        \"cv_cl\": 0.60,\n        \"cv_f\": 0.40,\n        \"n\": 40000,\n        \"seed\": 23,\n    }\n    test_cases = [case1, case2, case3]\n\n    results = []\n    for c in test_cases:\n        fixed_means, adjusted_means, adjusted_doses = simulate_case(\n            c[\"dose_ref_mg\"],\n            c[\"cl_base_lph\"],\n            c[\"f_base\"],\n            c[\"theta_cl\"],\n            c[\"theta_f\"],\n            c[\"cv_cl\"],\n            c[\"cv_f\"],\n            c[\"n\"],\n            c[\"seed\"]\n        )\n        results.append([fixed_means, adjusted_means, adjusted_doses])\n\n    # Final print statement in the exact required format.\n    print(str(results))\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "5061066"}]}