{"hands_on_practices": [{"introduction": "在设计非劣效性试验时，最关键的一步是设定非劣效性界值（margin）。这个界值通常基于临床判断，有时在相对尺度（如风险比）上更容易论证，但在计算样本量或解释绝对风险增加时，则需要在绝对尺度（如风险差）上进行表达。本练习将指导你动手在两种尺度之间转换界值，并探讨这种转换如何依赖于对照组的基线事件率——这是确保试验设计稳健性的核心考量。[@problem_id:5065077]", "problem": "一个转化医学团队正在设计一项非劣效性（NI）试验，旨在比较一种在研疗法与标准护理对照在一个不良二元临床终点（例如，严重不良事件）上的效果。非劣效性界值在风险比（RR）尺度上被确定为 $\\Delta_{\\text{NI}} = 1.3$，这意味着如果在研疗法的事件概率不超过对照组事件概率的 $1.3$ 倍，则该疗法被认为是非劣效的。设计团队希望将同一个非劣效性界值在风险差（RD）尺度上表示，以便于在绝对风险假设下进行样本量规划，并使监测试验的规则在绝对尺度上具有可解释性。\n\n仅从风险比 $RR = \\frac{p_{T}}{p_{C}}$ 和风险差 $RD = p_{T} - p_{C}$ 的基本定义出发（其中 $p_{T}$ 和 $p_{C}$ 分别表示试验（在研）组和对照组的事件概率），推导出风险差非劣效性界值作为 $p_{C}$ 的函数，然后计算当对照组事件率为 $p_{C} = 0.20$ 时的数值。将最终的数值结果以小数比例形式表示，不要使用百分号。\n\n然后，解释风险差界值对 $p_{C}$ 的依赖性应如何为试验设计选择提供信息，包括当 $p_{C}$ 在规划阶段不确定时对界值稳健性的影响，以及这种敏感性在绝对风险驱动的假设下可能如何影响样本量。你的解释应基于第一性原理，并且不得引用任何预先给定的转换公式。数值答案不需要四舍五入；请提供精确值。", "solution": "我们从第一性原理出发，首先建立风险比（$RR$）和风险差（$RD$）尺度上非劣效性（NI）界值之间的数学关系。\n\n问题给出了以下定义：\n风险比定义为 $RR = \\frac{p_{T}}{p_{C}}$。\n风险差定义为 $RD = p_{T} - p_{C}$。\n在此，$p_{T}$ 是在研疗法组的事件概率，$p_{C}$ 是标准护理对照组的事件概率。\n\n风险比尺度上的非劣效性界值给定为 $\\Delta_{\\text{NI(RR)}} = 1.3$。这个界值定义了可接受的劣效性边界。如果真实的风险比不大于这个值，那么在研疗法被认为是非劣效的。在这个边界上，试验组的事件概率（我们可以表示为 $p_{T, \\text{margin}}$）恰好是对照组概率的 $1.3$ 倍。\n在数学上，这个边界条件表示为：\n$$p_{T, \\text{margin}} = \\Delta_{\\text{NI(RR)}} \\times p_{C}$$\n\n风险差尺度上的非劣效性界值 $\\Delta_{\\text{NI(RD)}}$ 是风险差 $p_{T} - p_{C}$ 在这个相同的非劣效性边界上评估的值。为了求得此值，我们将 $p_{T, \\text{margin}}$ 的表达式代入风险差的定义中：\n$$\\Delta_{\\text{NI(RD)}} = p_{T, \\text{margin}} - p_{C}$$\n$$\\Delta_{\\text{NI(RD)}} = (\\Delta_{\\text{NI(RR)}} \\times p_{C}) - p_{C}$$\n\n提出公因子 $p_{C}$，得到风险差非劣效性界值作为对照组事件率 $p_{C}$ 和风险比非劣效性界值 $\\Delta_{\\text{NI(RR)}}$ 的函数的一般表达式：\n$$\\Delta_{\\text{NI(RD)}} = p_{C} (\\Delta_{\\text{NI(RR)}} - 1)$$\n这就是推导出的风险差非劣效性界值的函数。\n\n接下来，我们计算在对照组事件率为 $p_{C} = 0.20$ 且风险比界值为 $\\Delta_{\\text{NI(RR)}} = 1.3$ 的特定情况下的界值数值。\n将这些值代入我们推导的公式中：\n$$\\Delta_{\\text{NI(RD)}} = 0.20 \\times (1.3 - 1)$$\n$$\\Delta_{\\text{NI(RD)}} = 0.20 \\times 0.3$$\n$$\\Delta_{\\text{NI(RD)}} = 0.06$$\n因此，当对照组事件率为 $20\\%$ 时，风险比界值为 $1.3$ 等同于绝对风险差界值为 $6\\%$，即 $0.06$。\n\n如公式 $\\Delta_{\\text{NI(RD)}} = p_{C} (\\Delta_{\\text{NI(RR)}} - 1)$ 所示，风险差界值对 $p_{C}$ 的依赖性对试验设计具有关键影响。\n\n首先，它影响界值的稳健性。一个恒定的相对界值（$\\Delta_{\\text{NI(RR)}}$）意味着一个可变的绝对界值（$\\Delta_{\\text{NI(RD)}}$），后者与基线风险 $p_{C}$ 成正比。如果试验人群中真实的对照组事件率低于假设的 $p_{C} = 0.20$，则等效的绝对风险界值会变得更严格。例如，如果真实的 $p_{C}$ 是 $0.10$，风险差界值将缩小到 $\\Delta_{\\text{NI(RD)}} = 0.10 \\times (1.3 - 1) = 0.03$。相反，如果 $p_{C}$ 更高，比如 $0.30$，界值会变得更宽松：$\\Delta_{\\text{NI(RD)}} = 0.30 \\times (1.3 - 1) = 0.09$。这意味着风险比界值的临床可接受性隐含地与一个假设的基线风险相关联。试验设计者必须进行敏感性分析，以确保在试验中可能观察到的 $p_{C}$ 值的合理范围内，所隐含的绝对风险增加在临床上仍然是可以接受的。\n\n其次，这种依赖性深刻影响样本量的计算。非劣效性试验的样本量（$N$）对非劣效性界值的大小高度敏感。对于两比例的检验，所需样本量与界值的平方成反比，即 $N \\propto (\\Delta_{\\text{NI(RD)}})^{-2}$。样本量还依赖于终点的方差，对于二项分布的比例，方差是事件概率本身的函数（近似正比于 $p_{C}(1-p_{C})$）。结合这些依赖关系，并假设分配相等且真实率 $p_T$ 和 $p_C$ 相近，总样本量 $N$ 可以近似地表示为与以下表达式成正比：\n$$N \\propto \\frac{p_{C}(1-p_{C}) + p_{T}(1-p_{T})}{(\\Delta_{\\text{NI(RD)}})^2}$$\n代入我们推导的 $\\Delta_{\\text{NI(RD)}}$ 表达式，并假设方差项中 $p_T \\approx p_C$：\n$$N \\propto \\frac{2 p_{C}(1-p_{C})}{[p_{C}(\\Delta_{\\text{NI(RR)}} - 1)]^2} = \\frac{2 p_{C}(1-p_{C})}{p_{C}^2 (\\Delta_{\\text{NI(RR)}} - 1)^2} = \\frac{2(1-p_{C})}{p_{C}(\\Delta_{\\text{NI(RR)}} - 1)^2}$$\n由于 $\\Delta_{\\text{NI(RR)}}$ 对于该设计是一个固定的常数，这揭示了所需样本量 $N$ 近似地与 $\\frac{1-p_C}{p_C}$ 成正比。这表明样本量与对照组事件率 $p_C$ 之间存在强烈的反比关系。如果在试验期间实际的对照组事件率低于规划时假设的率（$p_{C} = 0.20$），那么维持统计功效所需的样本量将会大得多。例如，将 $p_C$ 从 $0.20$ 减半至 $0.10$ 将大约使所需样本量翻倍。因此，在规划阶段 $p_C$ 的不确定性会转化为进行一项把握度不足的研究的重大风险。试验设计者必须考虑到这一点，方法可以是在他们的主要样本量计算中选择一个保守的（即，较低的）$p_C$ 估计值，或者规划自适应措施，例如基于观察到的对照组率进行样本量重新估计。", "answer": "$$\n\\boxed{0.06}\n$$", "id": "5065077"}, {"introduction": "在临床试验中，意向性治疗（ITT）分析原则对于保持随机化的完整性至关重要，但它也可能带来解释上的挑战，尤其是在非劣效性试验中。由于不依从性（nonadherence）的存在，ITT分析的效果估计值通常会趋向于“无差异”的零假设，这种偏倚在非劣效性试验中可能导致错误地得出“非劣效”的结论。这个练习将引导你通过一个假设场景，从数学上推导并量化这种偏倚，从而深刻理解为何患者依从性对非劣效性试验的有效性构成重大威胁。[@problem_id:5065051]", "problem": "一项在转化医学中进行的随机、活性对照、非劣效性试验，旨在评估一种新疗法相对于标准疗法对一个二元不良结局的影响。设风险差在“意向性治疗”尺度上定义为 $RD = p_{T} - p_{C}$，其中 $p_{T}$ 和 $p_{C}$ 分别是新疗法和对照组的风险。假设“符合方案”的因果效应为 $RD_{\\text{true}} = -0.06$，意味着与对照组相比，新疗法将风险降低了 $0.06$。风险差尺度上的非劣效性界值为 $\\delta = -0.05$。\n\n假设存在带有对称污染的全或无不依从性：在每个随机分组中，有一部分比例 $\\pi = 0.15$ 的受试者实际接受了相反的治疗，而剩余比例 $1 - \\pi$ 的受试者则接受了其随机分配所对应的治疗。随机化比例为 $1{:}1$，且除了实际接受的治疗外，不依从性与预后无关。意向性治疗（ITT）分析通过随机分配来比较结局，忽略了依从性。\n\n从随机化和依从性下的混合风险的核心定义出发，推导ITT估计量 $RD_{\\text{obs}}$ 作为 $RD_{\\text{true}}$ 和 $\\pi$ 的函数，并用它来量化在污染情况下由ITT引起的偏向非劣效性的偏倚，该偏倚定义为\n$$B \\equiv \\big(RD_{\\text{obs}} - \\delta\\big) - \\big(RD_{\\text{true}} - \\delta\\big).$$\n请以单个精确小数的形式提供最终答案，不带单位，不要四舍五入。", "solution": "目标是推导意向性治疗（ITT）估计量 $RD_{\\text{obs}}$，作为真实符合方案风险差 $RD_{\\text{true}}$ 和不依从性比例 $\\pi$ 的函数。随后，我们必须计算偏倚 $B$。\n\nITT分析基于初始的随机分配来比较结局，而不考虑实际接受的治疗。我们定义每个随机分组中的观察风险。设 $P(\\text{Outcome} | \\text{Rand T})$ 为随机分配到新疗法组的不良结局概率， $P(\\text{Outcome} | \\text{Rand C})$ 为随机分配到对照组的概率。\n\n在随机分配到新疗法的小组（T组）中，比例为 $1 - \\pi$ 的受试者接受了新疗法（风险为 $p_T$），比例为 $\\pi$ 的受试者因污染而接受了对照疗法（风险为 $p_C$）。该组的总风险是加权平均值：\n$$P(\\text{Outcome} | \\text{Rand T}) = (1 - \\pi) p_T + \\pi p_C$$\n\n同样，在随机分配到对照组的小组（C组）中，比例为 $1 - \\pi$ 的受试者接受了对照疗法（风险为 $p_C$），比例为 $\\pi$ 的受试者因污染而接受了新疗法（风险为 $p_T$）。该组的总风险是：\n$$P(\\text{Outcome} | \\text{Rand C}) = \\pi p_T + (1 - \\pi) p_C$$\n\n来自ITT分析的观察风险差 $RD_{\\text{obs}}$ 是这两个观察风险之间的差值：\n$$RD_{\\text{obs}} = P(\\text{Outcome} | \\text{Rand T}) - P(\\text{Outcome} | \\text{Rand C})$$\n代入观察风险的表达式：\n$$RD_{\\text{obs}} = \\big[ (1 - \\pi) p_T + \\pi p_C \\big] - \\big[ \\pi p_T + (1 - \\pi) p_C \\big]$$\n我们可以按 $p_T$ 和 $p_C$ 对各项进行分组：\n$$RD_{\\text{obs}} = p_T (1 - \\pi - \\pi) + p_C (\\pi - (1 - \\pi))$$\n$$RD_{\\text{obs}} = p_T (1 - 2\\pi) + p_C (\\pi - 1 + \\pi)$$\n$$RD_{\\text{obs}} = p_T (1 - 2\\pi) - p_C (1 - 2\\pi)$$\n提取公因式 $(1 - 2\\pi)$：\n$$RD_{\\text{obs}} = (p_T - p_C) (1 - 2\\pi)$$\n根据定义，真实的符合方案风险差为 $RD_{\\text{true}} = p_T - p_C$。因此，我们可以将观察到的ITT风险差表示为：\n$$RD_{\\text{obs}} = RD_{\\text{true}} (1 - 2\\pi)$$\n这个方程表明，对称性不依从性将真实效应衰减了因子 $(1 - 2\\pi)$，使结果偏向于无差异的零假设（$RD = 0$）。\n\n接下来，我们计算问题陈述中定义的偏倚 $B$：\n$$B \\equiv \\big(RD_{\\text{obs}} - \\delta\\big) - \\big(RD_{\\text{true}} - \\delta\\big)$$\n简化此表达式，非劣效性界值 $\\delta$ 被消掉了：\n$$B = RD_{\\text{obs}} - \\delta - RD_{\\text{true}} + \\delta$$\n$$B = RD_{\\text{obs}} - RD_{\\text{true}}$$\n该偏倚代表了观察到的ITT效应与真实的符合方案效应之间的差异。\n\n现在，我们将推导出的 $RD_{\\text{obs}}$ 表达式代入 $B$ 的公式中：\n$$B = \\big[ RD_{\\text{true}} (1 - 2\\pi) \\big] - RD_{\\text{true}}$$\n$$B = RD_{\\text{true}} - 2\\pi \\cdot RD_{\\text{true}} - RD_{\\text{true}}$$\n$$B = -2\\pi \\cdot RD_{\\text{true}}$$\n\n最后，我们代入给定的数值 $\\pi = 0.15$ 和 $RD_{\\text{true}} = -0.06$ 来求出 $B$ 的值：\n$$B = -2 \\times (0.15) \\times (-0.06)$$\n$$B = -0.30 \\times (-0.06)$$\n$$B = 0.018$$\n\n正偏倚表明，观察到的风险差 $RD_{\\text{obs}}$ 大于（即负得更少）真实的风险差 $RD_{\\text{true}}$。效应偏向于零值 $0$。\n我们来验证一下：\n$$RD_{\\text{obs}} = (-0.06) \\times (1 - 2 \\times 0.15) = (-0.06) \\times (1 - 0.30) = (-0.06) \\times (0.7) = -0.042$$\n偏倚确实为 $B = RD_{\\text{obs}} - RD_{\\text{true}} = -0.042 - (-0.06) = -0.042 + 0.06 = 0.018$。", "answer": "$$\\boxed{0.018}$$", "id": "5065051"}, {"introduction": "许多生物医学终点（如生物标志物浓度）的分布常常是偏态的，并不服从正态分布，这使得基于均值和标准差的传统参数检验方法可能不再适用。在这种情况下，基于中位数的非参数检验方法，如置换检验（permutation test），提供了一种更为稳健和有效的分析途径。这项编程练习将挑战你从第一性原理出发，实现一个用于非劣效性检验的置换检验，通过这个过程，你不仅能深入理解在可交换性假设下的假设检验逻辑，还能掌握一种处理非理想真实世界数据的强大计算工具。[@problem_id:5065031]", "problem": "您的任务是开发一种单侧基于置换的非劣效性（NI）检验，用于检验在偏态连续尺度上测量的两个独立组之间的中位数差异，并评估其在可交换性下的确切 I 型错误。工作背景为转化医学，其中基于中位数的分析适用于高度偏态的生物标志物终点。设 $X$ 表示治疗组的测量值，$Y$ 表示对照组的测量值。将感兴趣的参数定义为中位数差异 $\\Delta = \\operatorname{median}(X) - \\operatorname{median}(Y)$。NI 界值为 $\\delta = -1$，意味着如果治疗组的中位数不比对照组差超过 1 个单位，则认为该治疗是非劣效的。NI 假设为 $H_0: \\Delta \\le \\delta$ 对 $H_1: \\Delta  \\delta$。为了在原假设边界 $\\Delta = \\delta$ 下构建一个有效的置换检验，将治疗组的测量值平移 $-\\delta$，并使用检验统计量 $S = \\operatorname{median}(X - \\delta) - \\operatorname{median}(Y)$，采用右尾拒绝域（大的正值支持 $H_1$）。在边界上的 $H_0$ 下，经过 $-\\delta$ 平移后，两组是同分布的，因此是可交换的，这为通过置换标签获得的随机化分布提供了依据。\n\n从基本定义开始：\n- 样本中位数是样本的 $0.5$ 分位数。\n- 在边界原假设 $H_0: \\Delta = \\delta$ 下的可交换性意味着，经过变换 $X' = X - \\delta$ 后，$X'$ 和 $Y$ 中观测值的多重集是独立同分布的，因此标签置换可以为 $S$ 生成一个有效的零参照分布。\n- 置换 $p$ 值是在所有标签分配中，其置换检验统计量至少与观测检验统计量在备择方向上一样极端的比例。\n\n您的程序必须：\n- 实现针对中位数差异的单侧 NI 置换检验，界值为 $\\delta = -1$，使用所有标签分配的穷举来获得可交换性下的确切置换分布。\n- 对每个测试用例，计算确切的 I 型错误，即在相同的合并数据和可交换性下，所有标签分配中会导致在水平 $\\alpha$ 下拒绝的比例，也就是右尾置换 $p$ 值小于或等于 $\\alpha$ 的标签分配比例。\n- 在边界原假设下，通过从相同的偏态分布中独立抽样，为两组生成可复现的偏态连续数据，然后设置 $X = Z_T + \\delta$ 和 $Y = Z_C$，其中 $Z_T$ 和 $Z_C$ 是来自同一母体分布的独立同分布（i.i.d.）样本。这确保了 $X - \\delta = Z_T$ 和 $Y = Z_C$ 是独立同分布的，从而保证了可交换性。\n\n测试套件：\n- 案例 1：种子 $12345$， $n_T = 6$， $n_C = 6$， $\\alpha = 0.05$，母体分布为对数正态分布，参数为 $(\\mu = 0, \\sigma = 1.0)$。\n- 案例 2：种子 $24680$， $n_T = 5$， $n_C = 7$， $\\alpha = 0.05$，母体分布为对数正态分布，参数为 $(\\mu = 0, \\sigma = 0.8)$。\n- 案例 3：种子 $13579$， $n_T = 3$， $n_C = 3$， $\\alpha = 0.10$，母体分布为伽玛分布，形态-尺度参数为 $(k = 1.5, \\theta = 2.0)$。\n- 案例 4：种子 $11223$， $n_T = 4$， $n_C = 4$， $\\alpha = 0.05$，母体分布为伽玛分布，形态-尺度参数为 $(k = 1.2, \\theta = 1.5)$。\n\n每个案例的算法规范：\n- 使用指定的种子和分布生成独立同分布样本 $Z_T$ 和 $Z_C$。\n- 设置 $X = Z_T + \\delta$ 和 $Y = Z_C$，其中 $\\delta = -1$，因此 $X - \\delta = Z_T$ 和 $Y = Z_C$ 是独立同分布的偏态数据。\n- 形成大小为 $n_T + n_C$ 的合并多重集 $P = \\{X - \\delta\\} \\cup \\{Y\\}$。\n- 穷举所有 $\\binom{n_T + n_C}{n_T}$ 种将 $P$ 划分为大小为 $n_T$ 的治疗平移组和大小为 $n_C$ 的对照组的标签分配；为每种分配计算 $S$。\n- 将任何观测到的标签分配的右尾置换 $p$ 值计算为大于或等于观测到的 $S$ 的置换 $S$ 值的比例。\n- 将可交换性下的确切 I 型错误计算为其右尾置换 $p$ 值小于或等于 $\\alpha$ 的标签分配比例。\n\n输出规范：\n- 您的程序应生成单行输出，其中包含四个测试用例的结果，格式为方括号内以逗号分隔的列表，按案例 1 到 4 的顺序排列，每个条目是相应案例的确切 I 型错误。例如，输出应类似于 $[\\text{result}_1,\\text{result}_2,\\text{result}_3,\\text{result}_4]$。\n- 所有输出都是无单位的实数，并且必须以小数形式表示。\n\n不需要外部输入；程序必须是自包含的，并使用指定的种子可复现。通过使用偏态分布（对数正态、伽玛）、基于中位数的统计量以及在可交换性下对 NI 检验进行确切的置换枚举，确保科学真实性。最终答案必须是一个完整的可运行程序。", "solution": "该问题要求计算一个特定的单侧基于置换的非劣效性（NI）检验的确切 I 型错误率。该检验评估治疗组和对照组之间的中位数差异，这是转化医学中涉及偏态生物标志物数据的常见情景。\n\n设治疗组和对照组的测量值分别由随机变量 $X$ 和 $Y$ 表示，相应的样本量为 $n_T$ 和 $n_C$。感兴趣的参数是中位数之差，$\\Delta = \\operatorname{median}(X) - \\operatorname{median}(Y)$。非劣效性界值给定为 $\\delta = -1$。如果治疗组的中位数不比对照组的中位数差 1 个单位以上，则认为该治疗是非劣效的。\n\n统计假设公式化为：\n- 原假设 $H_0: \\Delta \\le \\delta$（治疗是劣效的，或不优于非劣效性界值）。\n- 备择假设 $H_1: \\Delta  \\delta$（治疗是非劣效的）。\n\n置换检验是在原假设的边界上构建的，即在 $\\Delta = \\delta$ 的假设下。在此边界条件下，我们有 $\\operatorname{median}(X) - \\operatorname{median}(Y) = \\delta$，这意味着 $\\operatorname{median}(X - \\delta) = \\operatorname{median}(Y)$。问题假设如果中位数相等，则分布也相同。因此，转换后的治疗组观测值 $X' = X - \\delta$ 和对照组观测值 $Y$ 被认为是从相同的基础分布中抽取的。这种随机变量同分布的条件是观测标签可交换性的基础，它为置换检验提供了理论依据。\n\n检验统计量定义为 $S = \\operatorname{median}(X - \\delta) - \\operatorname{median}(Y)$。$S$ 的一个大的正值提供了反对 $H_0$ 并支持 $H_1$ 的证据，因此右尾检验是合适的。\n\n为执行检验，我们首先在零边界下生成数据。设 $Z_T$ 和 $Z_C$ 是从一个共同的母体分布中抽取的、大小分别为 $n_T$ 和 $n_C$ 的独立同分布（i.i.d.）样本。然后我们将治疗组观测值设为 $X = Z_T + \\delta$，对照组观测值设为 $Y = Z_C$。用于置换过程的数据是平移后的治疗值 $X - \\delta = Z_T$ 和对照值 $Y = Z_C$。用于置换的合并数据是多重集 $P = \\{Z_{T,1}, \\dots, Z_{T, n_T}, Z_{C,1}, \\dots, Z_{C, n_C}\\}$。\n\n统计量 $S$ 的确切置换分布是通过考虑将合并数据 $P$ 划分为大小为 $n_T$ 的伪治疗组和大小为 $n_C$ 的伪对照组的所有可能分区来生成的。这样的分区总数（也即置换分布的大小）是 $N = \\binom{n_T + n_C}{n_T}$。对于每个分区 $j \\in \\{1, \\dots, N\\}$，我们计算检验统计量 $S_j = \\operatorname{median}(P_T^{(j)}) - \\operatorname{median}(P_C^{(j)})$，其中 $P_T^{(j)}$ 和 $P_C^{(j)}$ 是分区 $j$ 中伪治疗组和伪对照组的数据。集合 $\\{S_1, \\dots, S_N\\}$ 构成了确切的置换分布。\n\n对于任何特定的结果，它对应于产生“观测”统计量 $S_{obs}$ 的其中一个分区，其右尾置换 $p$ 值是置换统计量中至少与 $S_{obs}$ 一样极端的比例：\n$$ p_{\\text{value}} = \\frac{\\text{Number of partitions } j \\text{ such that } S_j \\ge S_{obs}}{N} $$\n如果 $p_{\\text{value}} \\le \\alpha$，则拒绝假设 $H_0$，其中 $\\alpha$ 是预先指定的显著性水平。\n\n核心任务是计算确切的 I 型错误率。在可交换性假设成立的原假设边界下，I 型错误是错误地拒绝 $H_0$ 的概率。这是所有可能结果（即所有 $N$ 个置换）中，将导致 $p$ 值小于或等于 $\\alpha$ 的结果所占的比例。对于 $N$ 个置换中的每一个，我们可以将其统计量 $S_i$ 视为观测值，并计算其对应的 $p$ 值 $p_i$。确切的 I 型错误率则为：\n$$ \\text{Type I Error} = \\frac{1}{N} \\sum_{i=1}^{N} I(p_i \\le \\alpha) $$\n其中 $I(\\cdot)$ 是指示函数。\n\n为了高效地计算它，我们对每个测试用例遵循以下步骤：\n1. 使用指定的种子和分布参数生成初始的独立同分布样本 $Z_T$ 和 $Z_C$。形成大小为 $n_{total} = n_T + n_C$ 的合并数据 $P$。\n2. 穷举 $P$ 的所有 $N = \\binom{n_T + n_C}{n_T}$ 个分区，将其划分为大小为 $n_T$ 和 $n_C$ 的组。对每个分区，计算统计量 $S_j$，从而得到完整的置换分布 $\\{S_1, \\dots, S_N\\}$。\n3. 为避免因统计量值出现平局而导致的冗余计算，找出唯一的统计量值集合 $\\{u_1, \\dots, u_k\\}$ 及其各自的频率 $\\{c_1, \\dots, c_k\\}$，其中 $u_m$ 是按升序排序的第 $m$ 个唯一值。\n4. 对于每个唯一的统计量值 $u_m$，使用以下公式计算其右尾 $p$ 值 $p(u_m)$：\n   $$ p(u_m) = \\frac{\\sum_{j: u_j \\ge u_m} c_j}{N} $$\n5. 识别所有满足 $p(u_m) \\le \\alpha$ 的唯一统计量 $u_m$。\n6. 被拒绝的置换总数是与这些已识别统计量相对应的计数 $c_m$ 的总和。\n7. 确切的 I 型错误率是被拒绝的置换总数除以总置换数 $N$。\n\n对于给定的初始数据集，此过程是确定性的，并保证了在从特定数据实现中导出的可交换性下的确切 I 型错误。对四个指定的测试用例中的每一个都执行此计算。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom itertools import combinations\n\ndef solve():\n    \"\"\"\n    Main function to run the NI test simulation for all specified cases\n    and print the results in the required format.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: seed 12345, n_T = 6, n_C = 6, alpha = 0.05, log-normal(mu=0, sigma=1.0)\n        {\n            \"seed\": 12345, \"n_T\": 6, \"n_C\": 6, \"alpha\": 0.05, \"delta\": -1.0,\n            \"distribution\": {\"name\": \"lognormal\", \"params\": {\"mean\": 0.0, \"sigma\": 1.0}}\n        },\n        # Case 2: seed 24680, n_T = 5, n_C = 7, alpha = 0.05, log-normal(mu=0, sigma=0.8)\n        {\n            \"seed\": 24680, \"n_T\": 5, \"n_C\": 7, \"alpha\": 0.05, \"delta\": -1.0,\n            \"distribution\": {\"name\": \"lognormal\", \"params\": {\"mean\": 0.0, \"sigma\": 0.8}}\n        },\n        # Case 3: seed 13579, n_T = 3, n_C = 3, alpha = 0.10, gamma(k=1.5, theta=2.0)\n        {\n            \"seed\": 13579, \"n_T\": 3, \"n_C\": 3, \"alpha\": 0.10, \"delta\": -1.0,\n            \"distribution\": {\"name\": \"gamma\", \"params\": {\"shape\": 1.5, \"scale\": 2.0}}\n        },\n        # Case 4: seed 11223, n_T = 4, n_C = 4, alpha = 0.05, gamma(k=1.2, theta=1.5)\n        {\n            \"seed\": 11223, \"n_T\": 4, \"n_C\": 4, \"alpha\": 0.05, \"delta\": -1.0,\n            \"distribution\": {\"name\": \"gamma\", \"params\": {\"shape\": 1.2, \"scale\": 1.5}}\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        result = _calculate_exact_type_i_error(case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.10f}'.rstrip('0').rstrip('.') for r in results)}]\")\n\n\ndef _calculate_exact_type_i_error(case):\n    \"\"\"\n    Calculates the exact Type I error for a single non-inferiority test case.\n    The logic follows the principle of permutation testing under exchangeability.\n    \"\"\"\n    seed = case[\"seed\"]\n    n_T = case[\"n_T\"]\n    n_C = case[\"n_C\"]\n    alpha = case[\"alpha\"]\n    dist_info = case[\"distribution\"]\n\n    # Initialize random number generator for reproducibility\n    rng = np.random.default_rng(seed)\n\n    # Generate i.i.d. data from the parent distribution.\n    # These samples represent Z_T and Z_C, which are exchangeable.\n    if dist_info[\"name\"] == \"lognormal\":\n        Z_T = rng.lognormal(mean=dist_info[\"params\"][\"mean\"], sigma=dist_info[\"params\"][\"sigma\"], size=n_T)\n        Z_C = rng.lognormal(mean=dist_info[\"params\"][\"mean\"], sigma=dist_info[\"params\"][\"sigma\"], size=n_C)\n    elif dist_info[\"name\"] == \"gamma\":\n        Z_T = rng.gamma(shape=dist_info[\"params\"][\"shape\"], scale=dist_info[\"params\"][\"scale\"], size=n_T)\n        Z_C = rng.gamma(shape=dist_info[\"params\"][\"shape\"], scale=dist_info[\"params\"][\"scale\"], size=n_C)\n    else:\n        raise ValueError(f\"Unknown distribution: {dist_info['name']}\")\n\n    # Form the pooled multiset P = {X - delta} U {Y} = {Z_T} U {Z_C}\n    pooled_data = np.concatenate((Z_T, Z_C))\n    n_total = n_T + n_C\n\n    # Enumerate all labelings and compute the permutation distribution of the test statistic S.\n    perm_stats = []\n    indices = range(n_total)\n    \n    # Each combination represents the indices for the treatment group in a permutation.\n    for T_indices in combinations(indices, n_T):\n        # The remaining indices form the control group.\n        C_indices = list(set(indices) - set(T_indices))\n\n        perm_T_data = pooled_data[list(T_indices)]\n        perm_C_data = pooled_data[C_indices]\n\n        # Calculate the test statistic S = median(T_shifted) - median(C).\n        # Our pooled data is already shifted (it's composed of Z_T and Z_C).\n        s_val = np.median(perm_T_data) - np.median(perm_C_data)\n        perm_stats.append(s_val)\n\n    perm_stats = np.array(perm_stats)\n    N = len(perm_stats) # Total number of permutations\n\n    # --- Calculate Exact Type I Error ---\n    # The Type I error is the proportion of permutations whose p-value is = alpha.\n\n    # 1. Find unique statistic values and their counts for efficiency.\n    unique_stats, counts = np.unique(perm_stats, return_counts=True)\n    \n    # 2. Calculate right-tailed p-values for each unique statistic.\n    # The p-value for a stat 'u' is P(S_perm >= u).\n    # We can use a cumulative sum of counts from right-to-left.\n    cum_counts_from_right = np.cumsum(counts[::-1])[::-1]\n    p_values_for_unique = cum_counts_from_right / N\n\n    # 3. Identify which unique statistics lead to a rejection (p-value = alpha).\n    is_rejected_mask = p_values_for_unique = alpha\n\n    # 4. Sum the counts of the permutations corresponding to the rejected statistics.\n    num_rejected_perms = np.sum(counts[is_rejected_mask])\n\n    # 5. The exact Type I error is the proportion of rejected permutations.\n    exact_type_i_error = num_rejected_perms / N\n    \n    return exact_type_i_error\n\nsolve()\n```", "id": "5065031"}]}