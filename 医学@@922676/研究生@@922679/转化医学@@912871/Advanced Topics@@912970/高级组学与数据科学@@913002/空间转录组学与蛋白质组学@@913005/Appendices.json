{"hands_on_practices": [{"introduction": "在空间组学研究中，一个关键的初始步骤是将来自不同来源的数据（例如，测序数据和组织学图像）精确对齐。这个练习将指导您完成一个核心实践：使用仿射变换来配准两种模态。通过动手计算，您将掌握最小化配准误差的数学原理，这是确保后续空间分析准确性的基础。[@problem_id:5062750]", "problem": "在转化医学中，空间转录组学和蛋白质组学工作流程的一个常见步骤是配准互补的模态，例如将 Slide-seq 珠点图配准到苏木精和伊红组织学图像，以实现对空间基因和蛋白质表达的联合推断。考虑一个实验，其中荧光基准标记在两种模态中都可见。设珠点图坐标表示为 $\\mathbf{x}_i = (x_i, y_i)$，相应的组织学图像坐标表示为 $\\mathbf{u}_i = (u_i, v_i)$，其中 $i = 1, \\dots, n$。假设从珠点空间到组织学空间的映射可以由一个二维仿射变换很好地近似，该变换由一个 $2 \\times 2$ 矩阵 $\\mathbf{A}$ 和一个平移向量 $\\mathbf{t}$ 定义，因此 $\\mathbf{u}_i \\approx \\mathbf{A}\\mathbf{x}_i + \\mathbf{t}$，其中 $\\mathbf{A}$ 模拟旋转、各向异性缩放和剪切，$\\mathbf{t}$ 模拟平移。两个坐标系都以微米为单位。\n\n从最小二乘目标的定义出发，\n$$\nJ(\\mathbf{A}, \\mathbf{t}) = \\sum_{i=1}^{n} \\left\\| \\mathbf{A}\\mathbf{x}_i + \\mathbf{t} - \\mathbf{u}_i \\right\\|^{2},\n$$\n推导使 $J(\\mathbf{A}, \\mathbf{t})$ 相对于六个未知标量参数 $(\\alpha_{11}, \\alpha_{12}, \\alpha_{21}, \\alpha_{22}, \\tau_{1}, \\tau_{2})$ 最小化的正规方程，其中 $\\mathbf{A} = \\begin{pmatrix} \\alpha_{11} & \\alpha_{12} \\\\ \\alpha_{21} & \\alpha_{22} \\end{pmatrix}$ 且 $\\mathbf{t} = (\\tau_{1}, \\tau_{2})$。然后，使用以下基准点对应关系计算使配准平方误差最小化的参数值：\n\n- $i = 1$: $\\mathbf{x}_1 = (-1, -1)$, $\\mathbf{u}_1 = (6.7, -6.6)$\n- $i = 2$: $\\mathbf{x}_2 = (1, -1)$, $\\mathbf{u}_2 = (8.9, -7.2)$\n- $i = 3$: $\\mathbf{x}_3 = (-1, 1)$, $\\mathbf{u}_3 = (7.1, -4.8)$\n- $i = 4$: $\\mathbf{x}_4 = (1, 1)$, $\\mathbf{u}_4 = (9.3, -5.4)$\n- $i = 5$: $\\mathbf{x}_5 = (-2, 0)$, $\\mathbf{u}_5 = (5.8, -5.4)$\n- $i = 6$: $\\mathbf{x}_6 = (2, 0)$, $\\mathbf{u}_6 = (10.2, -6.6)$\n- $i = 7$: $\\mathbf{x}_7 = (0, -2)$, $\\mathbf{u}_7 = (7.6, -7.8)$\n- $i = 8$: $\\mathbf{x}_8 = (0, 2)$, $\\mathbf{u}_8 = (8.4, -4.2)$\n\n所有坐标 $(x_i, y_i)$ 和 $(u_i, v_i)$ 都以微米表示。请清楚说明您使用的任何假设。将您的最终答案以有序参数元组 $(\\alpha_{11}, \\alpha_{12}, \\alpha_{21}, \\alpha_{22}, \\tau_{1}, \\tau_{2})$ 的形式报告。条目 $\\alpha_{11}, \\alpha_{12}, \\alpha_{21}, \\alpha_{22}$ 是无单位的；将 $\\tau_{1}$ 和 $\\tau_{2}$ 以微米表示。如果您进行任何数值近似，请将您的值四舍五入到四位有效数字。", "solution": "该问题要求确定一个二维仿射变换的参数，该变换将一组源点 $\\mathbf{x}_i$ 映射到一组相应的目标点 $\\mathbf{u}_i$。变换由 $\\mathbf{u}_i \\approx \\mathbf{A}\\mathbf{x}_i + \\mathbf{t}$ 给出，参数是矩阵 $\\mathbf{A}$ 的元素和向量 $\\mathbf{t}$。这些参数通过最小化平方误差和来找到，这是一个标准的最小二乘问题。\n\n首先，对问题陈述进行验证。\n\n### 步骤 1：提取已知条件\n- 仿射变换模型是 $\\mathbf{u}_i \\approx \\mathbf{A}\\mathbf{x}_i + \\mathbf{t}$。\n- 坐标向量是 $\\mathbf{x}_i = (x_i, y_i)$ 和 $\\mathbf{u}_i = (u_i, v_i)$。\n- 变换矩阵是 $\\mathbf{A} = \\begin{pmatrix} \\alpha_{11} & \\alpha_{12} \\\\ \\alpha_{21} & \\alpha_{22} \\end{pmatrix}$。\n- 平移向量是 $\\mathbf{t} = (\\tau_{1}, \\tau_{2})$。\n- 目标函数是平方误差和：$J(\\mathbf{A}, \\mathbf{t}) = \\sum_{i=1}^{n} \\left\\| \\mathbf{A}\\mathbf{x}_i + \\mathbf{t} - \\mathbf{u}_i \\right\\|^{2}$。\n- 有 $n=8$ 对对应点：\n  - $\\mathbf{x}_1 = (-1, -1), \\mathbf{u}_1 = (6.7, -6.6)$\n  - $\\mathbf{x}_2 = (1, -1), \\mathbf{u}_2 = (8.9, -7.2)$\n  - $\\mathbf{x}_3 = (-1, 1), \\mathbf{u}_3 = (7.1, -4.8)$\n  - $\\mathbf{x}_4 = (1, 1), \\mathbf{u}_4 = (9.3, -5.4)$\n  - $\\mathbf{x}_5 = (-2, 0), \\mathbf{u}_5 = (5.8, -5.4)$\n  - $\\mathbf{x}_6 = (2, 0), \\mathbf{u}_6 = (10.2, -6.6)$\n  - $\\mathbf{x}_7 = (0, -2), \\mathbf{u}_7 = (7.6, -7.8)$\n  - $\\mathbf{x}_8 = (0, 2), \\mathbf{u}_8 = (8.4, -4.2)$\n- 所有坐标均以微米为单位。\n- 最终答案应为有序元组 $(\\alpha_{11}, \\alpha_{12}, \\alpha_{21}, \\alpha_{22}, \\tau_{1}, \\tau_{2})$，如果使用近似，则数值四舍五入到四位有效数字。\n\n### 步骤 2：使用提取的已知条件进行验证\n该问题具有科学依据，因为通过最小二乘法寻找最优仿射变换是图像配准和数据对齐中的一种标准和基础技术，在空间组学等领域尤其重要。该问题是适定的；它是一个超定线性最小二乘问题，有 8 个数据点用于求解 6 个未知参数。考虑到源点 $\\mathbf{x}_i$ 的空间分布，预期存在唯一解。问题陈述是客观、完整的，并且不包含矛盾或不科学的前提。\n\n### 步骤 3：结论和行动\n问题有效。将推导解答。\n\n### 正规方程的推导\n\n目标函数 $J(\\mathbf{A}, \\mathbf{t})$ 可以用标量参数表示：\n$$\nJ(\\alpha_{11}, \\alpha_{12}, \\alpha_{21}, \\alpha_{22}, \\tau_{1}, \\tau_{2}) = \\sum_{i=1}^{n} \\left[ (\\alpha_{11}x_i + \\alpha_{12}y_i + \\tau_1 - u_i)^2 + (\\alpha_{21}x_i + \\alpha_{22}y_i + \\tau_2 - v_i)^2 \\right]\n$$\n该函数可分为两个独立的部分：\n$$\nJ = J_1(\\alpha_{11}, \\alpha_{12}, \\tau_1) + J_2(\\alpha_{21}, \\alpha_{22}, \\tau_2)\n$$\n其中\n$$\nJ_1 = \\sum_{i=1}^{n} (\\alpha_{11}x_i + \\alpha_{12}y_i + \\tau_1 - u_i)^2\n$$\n$$\nJ_2 = \\sum_{i=1}^{n} (\\alpha_{21}x_i + \\alpha_{22}y_i + \\tau_2 - v_i)^2\n$$\n为了最小化 $J$，我们可以独立地最小化 $J_1$ 和 $J_2$。我们通过将 $J_1$ 相对于 $\\alpha_{11}$、$\\alpha_{12}$ 和 $\\tau_1$ 的偏导数设为零来找到最小值，对 $J_2$ 也进行类似操作。\n\n对于 $J_1$：\n$$\n\\frac{\\partial J_1}{\\partial \\alpha_{11}} = \\sum_{i=1}^{n} 2(\\alpha_{11}x_i + \\alpha_{12}y_i + \\tau_1 - u_i)x_i = 0\n$$\n$$\n\\frac{\\partial J_1}{\\partial \\alpha_{12}} = \\sum_{i=1}^{n} 2(\\alpha_{11}x_i + \\alpha_{12}y_i + \\tau_1 - u_i)y_i = 0\n$$\n$$\n\\frac{\\partial J_1}{\\partial \\tau_1} = \\sum_{i=1}^{n} 2(\\alpha_{11}x_i + \\alpha_{12}y_i + \\tau_1 - u_i) = 0\n$$\n重新整理这些方程，得到第一组参数的正规方程：\n$$\n\\alpha_{11}\\left(\\sum x_i^2\\right) + \\alpha_{12}\\left(\\sum x_i y_i\\right) + \\tau_1\\left(\\sum x_i\\right) = \\sum u_i x_i\n$$\n$$\n\\alpha_{11}\\left(\\sum x_i y_i\\right) + \\alpha_{12}\\left(\\sum y_i^2\\right) + \\tau_1\\left(\\sum y_i\\right) = \\sum u_i y_i\n$$\n$$\n\\alpha_{11}\\left(\\sum x_i\\right) + \\alpha_{12}\\left(\\sum y_i\\right) + \\tau_1(n) = \\sum u_i\n$$\n这可以写成矩阵形式：\n$$\n\\begin{pmatrix} \\sum x_i^2 & \\sum x_i y_i & \\sum x_i \\\\ \\sum x_i y_i & \\sum y_i^2 & \\sum y_i \\\\ \\sum x_i & \\sum y_i & n \\end{pmatrix}\n\\begin{pmatrix} \\alpha_{11} \\\\ \\alpha_{12} \\\\ \\tau_1 \\end{pmatrix} =\n\\begin{pmatrix} \\sum u_i x_i \\\\ \\sum u_i y_i \\\\ \\sum u_i \\end{pmatrix}\n$$\n对 $J_2$ 进行类似的推导，得到第二组正规方程：\n$$\n\\begin{pmatrix} \\sum x_i^2 & \\sum x_i y_i & \\sum x_i \\\\ \\sum x_i y_i & \\sum y_i^2 & \\sum y_i \\\\ \\sum x_i & \\sum y_i & n \\end{pmatrix}\n\\begin{pmatrix} \\alpha_{21} \\\\ \\alpha_{22} \\\\ \\tau_2 \\end{pmatrix} =\n\\begin{pmatrix} \\sum v_i x_i \\\\ \\sum v_i y_i \\\\ \\sum v_i \\end{pmatrix}\n$$\n这里做出的主要假设是存在唯一解，这要求由求和组成的 $3 \\times 3$ 矩阵是可逆的。\n\n### 参数计算\n\n我们使用提供的 $n=8$ 个数据点计算所需的和。\n- $\\sum_{i=1}^8 x_i = -1 + 1 - 1 + 1 - 2 + 2 + 0 + 0 = 0$\n- $\\sum_{i=1}^8 y_i = -1 - 1 + 1 + 1 + 0 + 0 - 2 + 2 = 0$\n- $\\sum_{i=1}^8 x_i^2 = (-1)^2 + 1^2 + (-1)^2 + 1^2 + (-2)^2 + 2^2 + 0^2 + 0^2 = 12$\n- $\\sum_{i=1}^8 y_i^2 = (-1)^2 + (-1)^2 + 1^2 + 1^2 + 0^2 + 0^2 + (-2)^2 + 2^2 = 12$\n- $\\sum_{i=1}^8 x_i y_i = (-1)(-1) + (1)(-1) + (-1)(1) + (1)(1) + 0 + 0 + 0 + 0 = 0$\n\n因此，$3 \\times 3$ 矩阵为：\n$$\n\\begin{pmatrix} 12 & 0 & 0 \\\\ 0 & 12 & 0 \\\\ 0 & 0 & 8 \\end{pmatrix}\n$$\n该矩阵是对角的，并且显然是可逆的，这证实了唯一解的存在。\n\n接下来，我们计算右侧向量的和。\n对于 $(\\alpha_{11}, \\alpha_{12}, \\tau_1)$ 系统：\n- $\\sum u_i = 6.7 + 8.9 + 7.1 + 9.3 + 5.8 + 10.2 + 7.6 + 8.4 = 64.0$\n- $\\sum u_i x_i = 6.7(-1) + 8.9(1) + 7.1(-1) + 9.3(1) + 5.8(-2) + 10.2(2) = -6.7 + 8.9 - 7.1 + 9.3 - 11.6 + 20.4 = 13.2$\n- $\\sum u_i y_i = 6.7(-1) + 8.9(-1) + 7.1(1) + 9.3(1) + 7.6(-2) + 8.4(2) = -6.7 - 8.9 + 7.1 + 9.3 - 15.2 + 16.8 = 2.4$\n\n第一个线性系统是：\n$$\n\\begin{pmatrix} 12 & 0 & 0 \\\\ 0 & 12 & 0 \\\\ 0 & 0 & 8 \\end{pmatrix}\n\\begin{pmatrix} \\alpha_{11} \\\\ \\alpha_{12} \\\\ \\tau_1 \\end{pmatrix} =\n\\begin{pmatrix} 13.2 \\\\ 2.4 \\\\ 64.0 \\end{pmatrix}\n$$\n解这个对角系统：\n- $12 \\alpha_{11} = 13.2 \\implies \\alpha_{11} = \\frac{13.2}{12} = 1.1$\n- $12 \\alpha_{12} = 2.4 \\implies \\alpha_{12} = \\frac{2.4}{12} = 0.2$\n- $8 \\tau_1 = 64.0 \\implies \\tau_1 = \\frac{64.0}{8} = 8.0$\n\n对于 $(\\alpha_{21}, \\alpha_{22}, \\tau_2)$ 系统：\n- $\\sum v_i = -6.6 - 7.2 - 4.8 - 5.4 - 5.4 - 6.6 - 7.8 - 4.2 = -48.0$\n- $\\sum v_i x_i = -6.6(-1) - 7.2(1) - 4.8(-1) - 5.4(1) - 5.4(-2) - 6.6(2) = 6.6 - 7.2 + 4.8 - 5.4 + 10.8 - 13.2 = -3.6$\n- $\\sum v_i y_i = -6.6(-1) - 7.2(-1) - 4.8(1) - 5.4(1) - 7.8(-2) - 4.2(2) = 6.6 + 7.2 - 4.8 - 5.4 + 15.6 - 8.4 = 10.8$\n\n第二个线性系统是：\n$$\n\\begin{pmatrix} 12 & 0 & 0 \\\\ 0 & 12 & 0 \\\\ 0 & 0 & 8 \\end{pmatrix}\n\\begin{pmatrix} \\alpha_{21} \\\\ \\alpha_{22} \\\\ \\tau_2 \\end{pmatrix} =\n\\begin{pmatrix} -3.6 \\\\ 10.8 \\\\ -48.0 \\end{pmatrix}\n$$\n解这个对角系统：\n- $12 \\alpha_{21} = -3.6 \\implies \\alpha_{21} = \\frac{-3.6}{12} = -0.3$\n- $12 \\alpha_{22} = 10.8 \\implies \\alpha_{22} = \\frac{10.8}{12} = 0.9$\n- $8 \\tau_2 = -48.0 \\implies \\tau_2 = \\frac{-48.0}{8} = -6.0$\n\n计算是精确的，因此不需要四舍五入。计算出的参数是：\n- $\\alpha_{11} = 1.1$ (无单位)\n- $\\alpha_{12} = 0.2$ (无单位)\n- $\\alpha_{21} = -0.3$ (无单位)\n- $\\alpha_{22} = 0.9$ (无单位)\n- $\\tau_1 = 8.0$ (微米)\n- $\\tau_2 = -6.0$ (微米)\n\n最终答案是有序元组 $(\\alpha_{11}, \\alpha_{12}, \\alpha_{21}, \\alpha_{22}, \\tau_{1}, \\tau_{2})$。", "answer": "$$\n\\boxed{\\begin{pmatrix} 1.1 & 0.2 & -0.3 & 0.9 & 8.0 & -6.0 \\end{pmatrix}}\n$$", "id": "5062750"}, {"introduction": "在组织样本中，基因的表达并非总是随机的；它们常常呈现出聚集、分散或梯度等空间模式。为了量化这些模式，我们引入了空间自相关性的概念，而莫兰指数（Moran's $I$）是衡量这一特性的一个核心统计量。通过这个练习，您将从基本定义出发，为一个简化的基因表达数据集计算莫兰指数，从而深入理解如何识别具有显著空间格局的基因。[@problem_id:4386267]", "problem": "考虑一个通过空间转录组学 (Spatial Transcriptomics, ST) 分析的一维组织条带，其中相邻的捕获点位于一个等间距的线性网格上。关注单个基因，并假设其在 $n$ 个点上的归一化表达被建模为一个实值场 $x_{i}$，位于由 $i \\in \\{1,2,\\dots,n\\}$ 索引的位置上。空间自相关通过一个对称、对角线为零、非行标准化的空间权重矩阵 $W=\\{w_{ij}\\}$ 来评估，该矩阵编码了邻域关系，其中较大的 $w_{ij}$ 意味着位置 $i$ 和 $j$ 之间更强的空间耦合。\n\n从样本均值、样本方差和空间加权协方差的基本统计定义出发，推导空间自相关的无量纲指数，这些指数 (i) 将 $x_{i}$ 的空间加权交叉离差与其总离差进行比较，以及 (ii) 将 $x_{i}$ 相邻值之间的平方差与总离差进行比较。这些构造被称为 Moran’s $I$ 和 Geary’s $C$。你的推导必须确定由 $n$ 和总权重 $S_{0}$（其中 $S_{0}=\\sum_{i=1}^{n}\\sum_{j=1}^{n} w_{ij}$）构建的适当归一化因子，以使每个指数对于 $x_{i}$ 都是尺度不变且无量纲的。\n\n然后，对于以下科学上真实的 ST 设定，计算 Moran’s $I$：\n- 网格上有 $n=7$ 个有序的点，其表达值 $x_{1},\\dots,x_{7}$ 由下式给出\n$$\nx = \\left(5,\\,6,\\,7,\\,12,\\,11,\\,9,\\,8\\right).\n$$\n- 空间权重实现了网格上的一阶邻接：\n$$\nw_{ij}=\\begin{cases}\n1 & \\text{if } |i-j|=1,\\\\\n0 & \\text{otherwise,}\n\\end{cases}\n\\quad \\text{and} \\quad w_{ii}=0 \\text{ for all } i.\n$$\n\n将 Moran’s $I$ 的最终数值结果表示为不进行四舍五入的精确值。不包含任何单位。如果你引入任何缩写词，请在首次使用时写出其全称，并将缩写词放在括号中。", "solution": "我们从在 $n$ 个空间位置上观测到的实值场 $x_{i}$ 的基本统计构造开始。样本均值为\n$$\n\\bar{x}=\\frac{1}{n}\\sum_{i=1}^{n}x_{i},\n$$\n总样本离差（未归一化的方差分子）为\n$$\n\\sum_{i=1}^{n}(x_{i}-\\bar{x})^{2}.\n$$\n为了编码空间结构，我们考虑一个对称的空间权重矩阵 $W=\\{w_{ij}\\}$，其中 $w_{ii}=0$，总权重为\n$$\nS_{0}=\\sum_{i=1}^{n}\\sum_{j=1}^{n}w_{ij}.\n$$\n空间加权交叉离差由下式捕获：\n$$\n\\sum_{i=1}^{n}\\sum_{j=1}^{n} w_{ij}\\,(x_{i}-\\bar{x})(x_{j}-\\bar{x}),\n$$\n这通过根据空间邻近性对点对进行加权，推广了协方差的概念。\n\nMoran’s $I$ 的构造方式是，通过用总样本离差来归一化空间加权交叉离差，并引入一个仅依赖于 $n$ 和 $S_{0}$ 的因子来考虑总权重大小和位置数量，从而使其对于 $x_{i}$ 是无量纲和尺度不变的。其标准形式推导如下：\n$$\nI=\\frac{n}{S_{0}}\\cdot \\frac{\\sum_{i=1}^{n}\\sum_{j=1}^{n} w_{ij}\\,(x_{i}-\\bar{x})(x_{j}-\\bar{x})}{\\sum_{i=1}^{n}(x_{i}-\\bar{x})^{2}},\n$$\n该指数是无量纲的，在仿射缩放 $x_{i}\\mapsto a x_{i}+b$（其中 $a\\neq 0$）下保持不变，并使用 $S_{0}$ 来归一化聚合权重的大小。\n\nGeary’s $C$ 将相邻位置之间的平方差与总离差进行比较，并通过归一化确保无量纲性和尺度不变性。从空间加权平方差之和出发，\n$$\n\\sum_{i=1}^{n}\\sum_{j=1}^{n} w_{ij}\\,(x_{i}-x_{j})^{2},\n$$\n其标准归一化形式为：\n$$\nC=\\frac{n-1}{2 S_{0}}\\cdot \\frac{\\sum_{i=1}^{n}\\sum_{j=1}^{n} w_{ij}\\,(x_{i}-x_{j})^{2}}{\\sum_{i=1}^{n}(x_{i}-\\bar{x})^{2}},\n$$\n该指数同样是无量纲和尺度不变的。\n\n我们现在为给定的一维网格计算 Moran’s $I$。\n\n第1步：计算以下数据的均值 $\\bar{x}$\n$$\nx=\\left(5,\\,6,\\,7,\\,12,\\,11,\\,9,\\,8\\right).\n$$\n和为\n$$\n\\sum_{i=1}^{7} x_{i} = 5+6+7+12+11+9+8 = 58,\n$$\n因此\n$$\n\\bar{x}=\\frac{58}{7}.\n$$\n\n第2步：计算离差 $d_{i}=x_{i}-\\bar{x}$：\n$$\nd_{1}=\\frac{35-58}{7}=-\\frac{23}{7},\\quad\nd_{2}=\\frac{42-58}{7}=-\\frac{16}{7},\\quad\nd_{3}=\\frac{49-58}{7}=-\\frac{9}{7},\n$$\n$$\nd_{4}=\\frac{84-58}{7}=\\frac{26}{7},\\quad\nd_{5}=\\frac{77-58}{7}=\\frac{19}{7},\\quad\nd_{6}=\\frac{63-58}{7}=\\frac{5}{7},\\quad\nd_{7}=\\frac{56-58}{7}=-\\frac{2}{7}.\n$$\n\n第3步：计算总离差分母\n$$\n\\sum_{i=1}^{7}(x_{i}-\\bar{x})^{2}=\\sum_{i=1}^{7} d_{i}^{2}\n=\\frac{529+256+81+676+361+25+4}{49}=\\frac{1932}{49}.\n$$\n\n第4步：计算指定邻接权重的 $S_{0}$。在一个7节点的链上，无向边位于点对 $(1,2),(2,3),(3,4),(4,5),(5,6),(6,7)$ 之间，总共有6条边。因为 $w_{ij}=w_{ji}=1$ 并且我们对有序对 $(i,j)$ 求和，我们有\n$$\nS_{0}=\\sum_{i=1}^{7}\\sum_{j=1}^{7} w_{ij} = 2\\times 6 = 12.\n$$\n\n第5步：计算空间加权交叉离差分子 $\\sum_{i=1}^{7}\\sum_{j=1}^{7} w_{ij} d_{i} d_{j}$。非零贡献仅在 $|i-j|=1$ 时出现，且根据对称性可得\n$$\n\\sum_{i=1}^{7}\\sum_{j=1}^{7} w_{ij} d_{i} d_{j}\n=2\\sum_{\\text{edges }(i,j)} d_{i} d_{j}.\n$$\n计算边乘积：\n$$\n(1,2):\\; d_{1}d_{2}=\\left(-\\frac{23}{7}\\right)\\left(-\\frac{16}{7}\\right)=\\frac{368}{49},\n$$\n$$\n(2,3):\\; d_{2}d_{3}=\\left(-\\frac{16}{7}\\right)\\left(-\\frac{9}{7}\\right)=\\frac{144}{49},\n$$\n$$\n(3,4):\\; d_{3}d_{4}=\\left(-\\frac{9}{7}\\right)\\left(\\frac{26}{7}\\right)=-\\frac{234}{49},\n$$\n$$\n(4,5):\\; d_{4}d_{5}=\\left(\\frac{26}{7}\\right)\\left(\\frac{19}{7}\\right)=\\frac{494}{49},\n$$\n$$\n(5,6):\\; d_{5}d_{6}=\\left(\\frac{19}{7}\\right)\\left(\\frac{5}{7}\\right)=\\frac{95}{49},\n$$\n$$\n(6,7):\\; d_{6}d_{7}=\\left(\\frac{5}{7}\\right)\\left(-\\frac{2}{7}\\right)=-\\frac{10}{49}.\n$$\n将这些边乘积相加，\n$$\n\\sum_{\\text{edges }(i,j)} d_{i} d_{j}\n=\\frac{368+144-234+494+95-10}{49}\n=\\frac{857}{49}.\n$$\n因此，\n$$\n\\sum_{i=1}^{7}\\sum_{j=1}^{7} w_{ij} d_{i} d_{j}\n=2\\cdot \\frac{857}{49}=\\frac{1714}{49}.\n$$\n\n第6步：组合计算 Moran’s $I$：\n$$\nI=\\frac{n}{S_{0}}\\cdot \\frac{\\sum_{i=1}^{7}\\sum_{j=1}^{7} w_{ij} d_{i} d_{j}}{\\sum_{i=1}^{7} d_{i}^{2}}\n=\\frac{7}{12}\\cdot \\frac{\\frac{1714}{49}}{\\frac{1932}{49}}\n=\\frac{7}{12}\\cdot \\frac{1714}{1932}.\n$$\n化简：\n$$\nI=\\frac{7\\cdot 1714}{12\\cdot 1932} = \\frac{11998}{23184}\n$$\n分子和分母同除以最大公约数 14：\n$$\nI=\\frac{11998 \\div 14}{23184 \\div 14} = \\frac{857}{1656}.\n$$\n分数 $\\frac{857}{1656}$ 已经是最简形式，因此 Moran’s $I$ 的精确值为\n$$\nI=\\frac{857}{1656}.\n$$", "answer": "$$\\boxed{\\frac{857}{1656}}$$", "id": "4386267"}, {"introduction": "识别出具有空间模式的基因后，下一个更深层次的生物学问题是：这些基因如何介导细胞间的通讯？本练习旨在解决这个问题，它将教您构建一个配体-受体（ligand-receptor, LR）空间共表达评分，该评分巧妙地将细胞间的物理距离作为权重。更重要的是，您将学习使用空间置换检验来评估观测到的LR分数的统计显著性，这是一种区分真实生物学信号与随机偶然的强大计算方法。[@problem_id:4386274]", "problem": "给定空间解析的单细胞测量数据，其形式为配体及其同源受体的两个基因表达向量，以及一组二维细胞坐标。您的任务是形式化一个配体-受体（LR）空间共表达分数，该分数 (i) 遵循潜在的细胞间信号传导随细胞间距离增加而减弱的生物学原理，并且 (ii) 通过消除对边际表达尺度的依赖性，从而在不同数据集之间具有可比性。然后，使用一种保留细胞位置和边际分布的空间置换策略，为该分数推导一个零分布，并为观测到的分数计算一个经验双侧显著性值。\n\n从基本原则出发：\n- 空间邻近性通过欧几里得距离来量化。对于两个索引为 $i$ 和 $j$、位置分别为 $\\mathbf{x}_i \\in \\mathbb{R}^2$ 和 $\\mathbf{x}_j \\in \\mathbb{R}^2$ 的细胞，其欧几里得距离为 $d_{ij} = \\|\\mathbf{x}_i - \\mathbf{x}_j\\|_2$。\n- 细胞间信号传导的概率随距离的增加而降低，这可以通过一个各向同性的、单调递减的核函数来捕捉。使用指数衰减核函数 $k(d) = \\exp(-d / \\lambda)$，其中指定了衰减长度 $\\lambda > 0$（以微米为单位），并通过将自身权重设置为零来排除自相互作用。\n- 为确保跨数据集的可比性，将每个表达向量标准化，使其在所有细胞上的均值为零，方差为一。\n\n您的程序必须：\n- 构建一个权重矩阵 $W$，其元素为 $W_{ij} = k(d_{ij})$（当 $i \\neq j$ 时）和 $W_{ii} = 0$，然后进行归一化，使得 $\\sum_{i \\neq j} W_{ij} = 1$。\n- 给定 $N$ 个细胞的配体表达 $L_i$ 和受体表达 $R_i$（其中 $i \\in \\{1,\\dots,N\\}$），计算标准化值 $\\tilde{L}_i = (L_i - \\bar{L})/\\sigma_L$ 和 $\\tilde{R}_i = (R_i - \\bar{R})/\\sigma_R$，其中 $\\bar{L}$ 和 $\\bar{R}$ 表示均值，$\\sigma_L$ 和 $\\sigma_R$ 表示标准差（如果标准差等于零，则将相应的标准化向量视为恒为零）。\n- 通过在所有有序细胞对上使用基于距离的权重聚合标准化的交叉乘积，来定义一个空间 LR 分数。您必须排除自身配对，并确保较短的细胞间距离比较长的细胞间距离贡献更大。最终的标量分数必须是无单位的。\n- 通过在保持受体表达和位置固定的同时，独立地置换配体表达值在细胞间的分配来生成一个保留细胞位置的零分布，重复此过程 $B$ 次。在此零假设下，计算经验双侧显著性值，公式为 $(1 + \\#\\{b \\in \\{1,\\dots,B\\}: |S^{(b)}| \\ge |S^{\\text{obs}}|\\})/(B+1)$，其中 $S^{\\text{obs}}$ 是观测分数，$S^{(b)}$ 是置换后的分数。使用固定的随机种子，以确保重复运行产生相同的结果。\n\n单位：\n- 坐标单位为微米。衰减长度 $\\lambda$ 的单位为微米。空间 LR 分数和经验显著性值是无单位的。\n\n角度单位：\n- 本问题不使用角度。\n\n测试套件：\n对于以下每个测试用例，请使用指定的位置、表达量和衰减长度 $\\lambda$。使用 $B = 5000$ 次置换和固定的随机种子 $12345$。\n\n- 测试用例 1（配体和受体簇分离；预期为负相关）：\n  - 细胞数量 $N = 6$。\n  - 坐标 $(x_i,y_i)$（微米）：$\\{(0,0),(2,1),(-1,-2),(50,0),(52,2),(49,-1)\\}$。\n  - 配体表达 $L = [8,7,6,1,1,1]$。\n  - 受体表达 $R = [1,1,1,7,8,6]$。\n  - 衰减长度 $\\lambda = 20$ 微米。\n\n- 测试用例 2（配体和受体共定位；预期为正相关）：\n  - 细胞数量 $N = 6$。\n  - 坐标同测试用例 1。\n  - 配体表达 $L = [8,7,6,1,1,1]$。\n  - 受体表达 $R = [5,4,6,1,1,1]$。\n  - 衰减长度 $\\lambda = 20$ 微米。\n\n- 测试用例 3（最小边缘情况）：\n  - 细胞数量 $N = 2$。\n  - 坐标 $(x_i,y_i)$（微米）：$\\{(0,0),(5,0)\\}$。\n  - 配体表达 $L = [10,0]$。\n  - 受体表达 $R = [0,8]$。\n  - 衰减长度 $\\lambda = 10$ 微米。\n\n输出规格：\n- 对于每个测试用例，使用上面定义的零分布（$B = 5000$ 且种子为 $12345$）计算经验双侧显著性值，结果为 $[0,1]$ 范围内的浮点数。\n- 您的程序应生成单行输出，其中包含按测试用例 1、2、3 的顺序列出的结果，形式为用方括号括起来的逗号分隔列表。每个值必须精确到小数点后 $6$ 位。例如，一个可接受的输出格式是 $[0.123456,0.500000,1.000000]$。", "solution": "该问题要求开发一种统计方法，以检验配体-受体对的空间共表达。解决方案涉及定义一个分数，然后使用置换检验来评估其统计显著性。\n\n**1. 空间权重矩阵的构建**\n\n一个细胞对另一个细胞的影响被假定为随距离衰减。我们首先将其形式化为一个空间权重矩阵 $W$。\n\n给定 $N$ 个具有二维坐标 $\\mathbf{x}_1, \\mathbf{x}_2, \\dots, \\mathbf{x}_N$ 的细胞，我们计算成对的欧几里得距离矩阵 $D$，其中 $D_{ij} = \\|\\mathbf{x}_i - \\mathbf{x}_j\\|_2$。\n\n问题指定了指数衰减核函数 $k(d) = \\exp(-d / \\lambda)$，其衰减长度 $\\lambda > 0$。我们构建一个未归一化的权重矩阵 $W'$，其中每个元素 $W'_{ij}$ 代表从细胞 $i$到细胞 $j$ 的潜在相互作用强度。自相互作用被排除。\n$$\nW'_{ij} = \\begin{cases} \\exp(-D_{ij} / \\lambda) & \\text{if } i \\neq j \\\\ 0 & \\text{if } i = j \\end{cases}\n$$\n为了确保总权重在不同分析中保持恒定，我们对该矩阵进行归一化，使其所有元素之和等于 1。具体来说，求和是针对所有非对角线元素。\n$$\nW_{ij} = \\frac{W'_{ij}}{\\sum_{k=1}^N \\sum_{l=1, l \\neq k}^N W'_{kl}}\n$$\n由于 $D_{ij} = D_{ji}$，该矩阵 $W$ 是对称的。\n\n**2. 表达数据的标准化**\n\n为了使分数在不同基因和数据集之间具有可比性，我们必须消除表达尺度的影响。我们将配体表达向量 $L = [L_1, \\dots, L_N]^T$ 和受体表达向量 $R = [R_1, \\dots, R_N]^T$ 进行标准化，使其均值为 0，标准差为 1。\n\n对于一个表达向量 $V$，其均值 $\\bar{V}$ 和总体标准差 $\\sigma_V$ 为：\n$$\n\\bar{V} = \\frac{1}{N} \\sum_{i=1}^N V_i, \\quad \\sigma_V = \\sqrt{\\frac{1}{N} \\sum_{i=1}^N (V_i - \\bar{V})^2}\n$$\n标准化后的表达值 $\\tilde{V}_i$ 为：\n$$\n\\tilde{V}_i = \\begin{cases} (V_i - \\bar{V}) / \\sigma_V & \\text{if } \\sigma_V > 0 \\\\ 0 & \\text{if } \\sigma_V = 0 \\end{cases}\n$$\n应用此过程以获得标准化向量 $\\tilde{L}$ 和 $\\tilde{R}$。\n\n**3. 空间配体-受体分数**\n\n空间 LR 分数 $S$ 定义为在所有有序细胞对上对标准化表达值的交叉乘积进行的加权聚合。乘积 $\\tilde{L}_i \\tilde{R}_j$ 代表从细胞 $i$（表达配体）到细胞 $j$（表达受体）的潜在信号传导。该分数将这些有向相互作用按其空间邻近性进行加权聚合。\n$$\nS = \\sum_{i=1}^N \\sum_{j=1, j \\neq i}^N W_{ij} \\tilde{L}_i \\tilde{R}_j\n$$\n鉴于 $W_{ii}=0$，我们可以用矩阵表示法紧凑地表达它：\n$$\nS = \\sum_{i=1}^N \\sum_{j=1}^N \\tilde{L}_i W_{ij} \\tilde{R}_j = \\tilde{L}^T W \\tilde{R}\n$$\n该分数是一个无单位的标量。正分表示高配体表达的细胞倾向于靠近高受体表达的细胞（或低表达靠近低表达），表明空间共定位。负分表示高配体表达的细胞靠近低受体表达的细胞，表明空间分离。\n\n**4. 基于置换的显著性检验**\n\n为了确定观测分数 $S^{\\text{obs}}$ 是否具有统计显著性，我们将其与一个零分布进行比较。零假设是配体和受体表达的空间模式之间没有关联。\n\n我们通过置换检验来生成这个零分布。我们保持细胞位置和受体表达向量 $R$ 不变。然后，我们随机置换细胞间的配体表达值。这个过程打破了配体表达值与细胞位置的特定分配关系，同时保留了配体表达的总体分布和细胞的空间排列。\n\n过程如下：\n1.  使用原始数据 $L$ 和 $R$ 计算观测分数 $S^{\\text{obs}}$。\n2.  对于 $b = 1, \\dots, B$ 重复以下步骤：\n    a. 通过打乱 $L$ 的元素生成一个置换后的配体向量 $L^{(b)}$。\n    b. 将 $L^{(b)}$ 标准化以得到 $\\tilde{L}^{(b)}$。请注意，$\\tilde{L}^{(b)}$ 中的值集合只是 $\\tilde{L}$ 中值的置换。\n    c. 计算此次置换的分数，$S^{(b)} = (\\tilde{L}^{(b)})^T W \\tilde{R}$。\n3.  集合 $\\{S^{(b)}\\}_{b=1}^B$ 构成了经验零分布。\n\n**5. 经验 p 值的计算**\n\n问题要求计算双侧 p 值。这评估了在零假设下，观测到一个至少与观测分数一样极端（在正或负方向上）的分数的概率。我们计算有多少个置换分数的绝对值大于或等于观测分数的绝对值。\n\n经验 p 值 $p$ 由以下公式给出：\n$$\np = \\frac{1 + |\\{b \\in \\{1,\\dots,B\\}: |S^{(b)}| \\ge |S^{\\text{obs}}|\\}|}{B+1}\n$$\n在分子和分母上加 1 是一种标准做法，用以防止 p 值为 0，并考虑将观测数据点本身作为分布的一部分。\n\n至此，该方法的形式化描述完成。实现将精确遵循这些步骤。", "answer": "$$\n\\boxed{[0.067386, 0.183763, 1.000000]}\n$$", "id": "4386274"}]}