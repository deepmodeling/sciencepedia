{"hands_on_practices": [{"introduction": "真实世界数据通常需要借助算法来识别临床结局。本练习将指导您完成一个关键的验证步骤：评估此类算法的准确性。通过计算阳性预测值（PPV）及其置信区间，您将学会量化来自电子健康记录数据的可靠性，并理解结局的错误分类如何影响研究结论[@problem_id:5054623]。", "problem": "一项多中心转化肿瘤学研究使用电子健康记录（EHRs）来识别接受免疫检查点抑制剂治疗的患者中与免疫相关的不良事件。一个基于EHR的表型分析算法根据诊断代码和皮质类固醇处方标记出严重的结肠炎推定病例。为使用真实世界数据（RWD）量化该算法的有效性，研究人员对一个由$80$个算法标记的就诊记录组成的简单随机样本进行了盲法病历审查，并确认其中$68$例为真实的严重结肠炎病例。将每次病历审查的就诊记录视为一个独立的伯努利试验，其未知概率 $p$ 表示一个被标记的就诊记录是真实病例的概率。根据定义，阳性预测值（PPV）等于 $p$。\n\n从二项模型出发，并仅使用经过充分检验的大样本似然或基于得分的近似方法，通过对二项比例的双侧检验进行反演，推导出一个关于 $p$ 的近似双侧$95\\%$置信区间。然后，从基本原理出发，解释所得的PPV及其不确定性如何说明结局错分是否威胁到比较效果分析的研究结论，此类分析假设结局在暴露组间的错分是非差异性的。\n\n说明：\n- 计算PPV的点估计值。\n- 通过对二项比例进行适当的得分类型检验的反演，构建一个关于 $p$ 的双侧$95\\%$置信区间，不要使用临时的连续性校正。\n- 陈述推导过程中使用的任何假设。\n- 定性评估，如果错分是非差异性的，由您的估计值和区间所暗示的结局错分程度是否可能将相对效应估计值实质性地偏向于零值。\n- 作为您的最终数值答案，仅报告PPV的双侧$95\\%$置信区间的下限，以小数形式表示，并四舍五入至四位有效数字。", "solution": "该问题要求计算和解释一个二项比例的置信区间，该比例代表一个临床表型分析算法的阳性预测值（PPV）。验证过程将首先陈述统计模型，然后按照指定，通过对一个得分类型检验进行反演来推导置信区间。\n\n给定数据如下：\n- 算法标记的就诊记录样本量：$n = 80$\n- 确认的严重结肠炎真实病例数（成功次数）：$x = 68$\n- 置信水平：$95\\%$\n\n该问题可以通过假设真实病例数 $X$ 服从二项分布来建模，即 $X \\sim \\text{Binomial}(n, p)$，其中 $p$ 是算法标记的就诊记录中真实病例的真实比例。根据定义，这个比例 $p$ 就是该算法的PPV。假设每次就诊记录是独立的伯努利试验。\n\nPPV的点估计值是样本比例 $\\hat{p}$：\n$$\n\\hat{p} = \\frac{x}{n} = \\frac{68}{80} = 0.85\n$$\n\n任务是通过对一个二项比例的得分类型检验进行反演，来构建一个关于 $p$ 的双侧$95\\%$置信区间。针对原假设 $H_0: p = p_0$ 的得分检验基于以下统计量：\n$$\nZ = \\frac{\\hat{p} - p_0}{\\sqrt{\\frac{p_0(1-p_0)}{n}}}\n$$\n在 $H_0$ 下，对于大样本 $n$，该统计量近似服从标准正态分布，$Z \\sim N(0,1)$。\n\n一个关于 $p$ 的双侧 $(1-\\alpha)$ 置信区间是所有 $p_0$ 值的集合，对于这些值，原假设 $H_0: p = p_0$ 在显著性水平 $\\alpha$ 下不会被拒绝。对于双侧检验，该条件为 $|Z| \\le z_{1-\\alpha/2}$，其中 $z_{1-\\alpha/2}$ 是标准正态分布的 $(1-\\frac{\\alpha}{2})$-分位数。对于一个$95\\%$的置信区间，$\\alpha = 0.05$，所以 $1-\\frac{\\alpha}{2} = 0.975$，对应的临界值为 $z_{0.975} \\approx 1.95996$。我们将使用常用近似值 $z_{0.975} \\approx 1.96$。\n\n需要求解的关于 $p$（之前的 $p_0$）的不等式是：\n$$\n\\left| \\frac{\\hat{p} - p}{\\sqrt{\\frac{p(1-p)}{n}}} \\right| \\le z_{1-\\alpha/2}\n$$\n两边平方得到：\n$$\n(\\hat{p} - p)^2 \\le z_{1-\\alpha/2}^2 \\left( \\frac{p(1-p)}{n} \\right)\n$$\n置信区间的端点是相应等式的解：\n$$\n(\\hat{p} - p)^2 = \\frac{z_{1-\\alpha/2}^2}{n} p(1-p)\n$$\n展开并重新整理各项，得到一个形式为 $Ap^2 + Bp + C = 0$ 的二次方程：\n$$\n\\hat{p}^2 - 2\\hat{p}p + p^2 = \\frac{z_{1-\\alpha/2}^2}{n}p - \\frac{z_{1-\\alpha/2}^2}{n}p^2\n$$\n$$\n\\left(1 + \\frac{z_{1-\\alpha/2}^2}{n}\\right)p^2 - \\left(2\\hat{p} + \\frac{z_{1-\\alpha/2}^2}{n}\\right)p + \\hat{p}^2 = 0\n$$\n使用二次公式 $p = \\frac{-B \\pm \\sqrt{B^2-4AC}}{2A}$ 求解 $p$，得到置信区间的下限和上限。设 $z = z_{1-\\alpha/2}$。系数为 $A = 1 + \\frac{z^2}{n}$，$B = -(2\\hat{p} + \\frac{z^2}{n})$，以及 $C = \\hat{p}^2$。代入这些系数并化简，得到威尔逊得分区间的标准公式：\n$$\np = \\frac{\\hat{p} + \\frac{z^2}{2n} \\pm z\\sqrt{\\frac{\\hat{p}(1-\\hat{p})}{n} + \\frac{z^2}{4n^2}}}{1 + \\frac{z^2}{n}}\n$$\n现在，我们代入给定值：$n=80$，$x=68$，$\\hat{p}=0.85$，以及 $z=z_{0.975} \\approx 1.96$。\n$z^2 \\approx (1.96)^2 = 3.8416$。\n\n在除以分母之前，区间的中心是：\n$$\n\\hat{p} + \\frac{z^2}{2n} = 0.85 + \\frac{3.8416}{2 \\times 80} = 0.85 + \\frac{3.8416}{160} = 0.85 + 0.02401 = 0.87401\n$$\n平方根下的项是：\n$$\n\\frac{\\hat{p}(1-\\hat{p})}{n} + \\frac{z^2}{4n^2} = \\frac{0.85 \\times 0.15}{80} + \\frac{3.8416}{4 \\times 80^2} = \\frac{0.1275}{80} + \\frac{3.8416}{25600} = 0.00159375 + 0.0001500625 = 0.0017438125\n$$\n分子中的半宽度项是：\n$$\nz \\sqrt{0.0017438125} \\approx 1.96 \\times 0.04175897 \\approx 0.08184758\n$$\n分母是：\n$$\n1 + \\frac{z^2}{n} = 1 + \\frac{3.8416}{80} = 1 + 0.04802 = 1.04802\n$$\n下限是：\n$$\np_{lower} = \\frac{0.87401 - 0.08184758}{1.04802} = \\frac{0.79216242}{1.04802} \\approx 0.755866\n$$\n上限是：\n$$\np_{upper} = \\frac{0.87401 + 0.08184758}{1.04802} = \\frac{0.95585758}{1.04802} \\approx 0.912061\n$$\nPPV的双侧$95\\%$置信区间约为 $(0.756, 0.912)$。\n\n此推导的假设是：\n1. 这$80$个被审查的就诊记录构成了一个从所有被算法标记的就诊记录总体中抽取的简单随机样本。\n2. 每次就诊记录的真实结局与其他记录相互独立。\n3. 真实病例数服从二项分布，$X \\sim \\text{Binomial}(n,p)$。\n4. 样本量 $n$ 足够大，使得得分统计量的分布的正态近似有效。条件 $n\\hat{p} = 68 \\ge 5$ 和 $n(1-\\hat{p}) = 12 \\ge 5$ 均满足，支持使用此大样本近似。\n\n解释：\nPPV的点估计值为 $0.85$，意味着被算法标记的患者中，估计有 $85\\%$ 确实患有严重的结肠炎。剩下的 $15\\%$ 是假阳性。这代表了结局错分。$95\\%$的置信区间 $(0.756, 0.912)$ 表明，真实的PPV很可能在 $75.6\\%$ 到 $91.2\\%$ 之间。这意味着将非病例错分为病例的比例（在被标记的病例中的假阳性率）估计为 $15\\%$，但合理地可能高达 $100\\% - 75.6\\% = 24.4\\%$。\n\n在一项比较效果研究中，如果这种错分是非差异性的——即PPV在被比较的两个暴露组中相同——它将会使关联性的估计度量（例如，相对风险或比值比）偏向于零值 $1$。$0.85$的PPV表明存在相当程度的错分。在病例中 $15\\%$ 的假阳性率并非微不足道，并且很可能导致实质性的偏倚。如果暴露的真实效应是中等的，这种程度的错分可能会将观察到的效应削弱到不再具有统计显著性的程度，从而导致假阴性结论（第二类错误）。置信区间所反映的不确定性，特别是下限表明错分率接近 $25\\%$，强化了这一结论：即这对有效性的威胁是严重的。因此，由该PPV所暗示的结局错分程度是一个重大的关切，需要进行敏感性分析来量化其对研究主要结论的潜在偏倚大小。\n\n最终的数值答案是置信区间的下限，四舍五入到四位有效数字。\n$p_{lower} \\approx 0.755866 \\rightarrow 0.7559$。", "answer": "$$\n\\boxed{0.7559}\n$$", "id": "5054623"}, {"introduction": "来自电子健康记录（EHR）或医保理赔数据的原始数据（如ICD编码）必须经过转换才能成为有意义的分析变量。本练习模拟了这一过程，要求您根据一系列诊断编码计算标准风险评分——Charlson合并症指数。这项实践不仅能锻炼您的数据处理能力，还能加深您对变量的预测能力与因果论断之间区别的理解[@problem_id:5054781]。", "problem": "您面临一个转化医学场景，其中合并症通过源自电子健康记录 (EHR)、医保理赔数据和疾病登记的国际疾病分类第十版 (ICD-10) 编码进行观察。科学目标是使用Charlson合并症指数构建一个可解释的风险总结，并利用基本统计学定义评估其与一年期死亡率的预测关联。请从以下基本依据出发：(i) 未经调整的Charlson合并症指数 (CCI) 作为不同合并症类别的加权和，(ii) 两个随机变量之间的皮尔逊相关性定义为 $$\\rho_{XY} = \\frac{\\mathrm{Cov}(X,Y)}{\\sigma_X \\sigma_Y},$$ 以及 (iii) 使用结构性假设而非经验相关性来阐述预测与因果之间的区别。除了这些基本依据，您不得假设任何快捷公式。\n\n输入规范和合并症编码：您将使用一个包含 $n = 10$ 名患者的小型测试套件。每位患者都有一组ICD-10编码和一个二元一年期死亡率标签 $Y_i \\in \\{0,1\\}$，其中 $Y_i = 1$ 表示在1年内死亡。患者 $i$ 的Charlson合并症指数得分定义为 $$S_i = \\sum_{c \\in \\mathcal{C}_i} w(c),$$ 其中 $\\mathcal{C}_i$ 是在应用层级规则后，患者 $i$ 存在的唯一Charlson类别集合，而 $w(c)$ 是类别权重。一个类别对于每位患者最多贡献一次其权重，无论有多少个编码映射到该类别。层级规则强制规定，当某种疾病的严重形式存在时，该疾病的较不严重形式不贡献额外权重。具体而言：\n- 如果存在伴有终末器官损害的糖尿病，则无并发症的糖尿病类别不贡献权重。\n- 如果存在中度或重度肝病，则轻度肝病类别不贡献权重。\n- 如果存在转移性实体瘤，则非转移性肿瘤类别不贡献权重。\n\n从ICD-10编码到Charlson类别和权重的映射仅限于测试数据中使用的以下临床标准子集。如果患者的编码字符串以前缀列表中的某个前缀开头，则该编码映射到一个Charlson类别。权重 $w(c)$ 如下：\n- 心肌梗死：前缀 $\\{\\text{\"I21\"}, \\text{\"I22\"}, \\text{\"I25.2\"}\\}$，权重 $w = 1$。\n- 充血性心力衰竭：前缀 $\\{\\text{\"I50\"}\\}$，权重 $w = 1$。\n- 外周血管疾病：前缀 $\\{\\text{\"I70.2\"}, \\text{\"I73.9\"}\\}$，权重 $w = 1$。\n- 脑血管疾病：前缀 $\\{\\text{\"I63\"}\\}$，权重 $w = 1$。\n- 痴呆：前缀 $\\{\\text{\"F03\"}\\}$，权重 $w = 1$。\n- 慢性阻塞性肺疾病：前缀 $\\{\\text{\"J44\"}\\}$，权重 $w = 1$。\n- 结缔组织病：前缀 $\\{\\text{\"M32\"}\\}$，权重 $w = 1$。\n- 消化性溃疡病：前缀 $\\{\\text{\"K25\"}\\}$，权重 $w = 1$。\n- 轻度肝病：前缀 $\\{\\text{\"K76.0\"}, \\text{\"K73\"}\\}$，权重 $w = 1$。\n- 无并发症的糖尿病：前缀 $\\{\\text{\"E11\"}\\}$，权重 $w = 1$，除非存在伴有并发症的糖尿病。\n- 伴有终末器官损害的糖尿病：前缀 $\\{\\text{\"E11.22\"}, \\text{\"E11.4\"}\\}$，权重 $w = 2$。\n- 偏瘫或截瘫：前缀 $\\{\\text{\"G81\"}\\}$，权重 $w = 2$。\n- 中度或重度肾病：前缀 $\\{\\text{\"N18.5\"}\\}$，权重 $w = 2$。\n- 任何肿瘤（非转移性）：前缀 $\\{\\text{\"C50\"}\\}$，权重 $w = 2$，除非存在转移性肿瘤。\n- 白血病：前缀 $\\{\\text{\"C91\"}\\}$，权重 $w = 2$。\n- 淋巴瘤：前缀 $\\{\\text{\"C85\"}\\}$，权重 $w = 2$。\n- 中度或重度肝病：前缀 $\\{\\text{\"K72.9\"}\\}$，权重 $w = 3$。\n- 转移性实体瘤：前缀 $\\{\\text{\"C78\"}\\}$，权重 $w = 6$。\n- 获得性免疫缺陷综合征：前缀 $\\{\\text{\"B20\"}\\}$，权重 $w = 6$。\n\n测试套件（每个元素是患者的编码列表和死亡率 $Y$）：\n- 患者1：编码 $\\varnothing$，$Y_1 = 0$。\n- 患者2：编码 $\\{\\text{\"I21.0\"}\\}$，$Y_2 = 0$。\n- 患者3：编码 $\\{\\text{\"I50.9\"}, \\text{\"I50.2\"}, \\text{\"J44.9\"}\\}$，$Y_3 = 0$。\n- 患者4：编码 $\\{\\text{\"E11.9\"}, \\text{\"I70.20\"}\\}$，$Y_4 = 0$。\n- 患者5：编码 $\\{\\text{\"E11.22\"}, \\text{\"N18.5\"}, \\text{\"G81.9\"}\\}$，$Y_5 = 1$。\n- 患者6：编码 $\\{\\text{\"C50.9\"}\\}$，$Y_6 = 0$。\n- 患者7：编码 $\\{\\text{\"C78.7\"}, \\text{\"C50.9\"}\\}$，$Y_7 = 1$。\n- 患者8：编码 $\\{\\text{\"K76.0\"}, \\text{\"K72.90\"}\\}$，$Y_8 = 1$。\n- 患者9：编码 $\\{\\text{\"B20\"}, \\text{\"J44.9\"}, \\text{\"I63.9\"}\\}$，$Y_9 = 1$。\n- 患者10：编码 $\\{\\text{\"F03.90\"}, \\text{\"M32.10\"}, \\text{\"K25.9\"}, \\text{\"I73.9\"}\\}$，$Y_{10} = 0$。\n\n任务：\n1. 通过应用映射和层级规则，计算 $i \\in \\{1,\\dots,10\\}$ 的Charlson合并症指数得分 $S_i$。确保映射到同一类别的多个编码只贡献一次权重。\n2. 计算得分向量 $S = (S_1,\\dots,S_{10})$ 与死亡率向量 $Y = (Y_1,\\dots,Y_{10})$ 之间的皮尔逊相关性 $\\rho_{SY}$，使用定义 $$\\rho_{SY} = \\frac{\\sum_{i=1}^{n} (S_i - \\bar{S})(Y_i - \\bar{Y})}{\\sqrt{\\sum_{i=1}^{n} (S_i - \\bar{S})^2} \\, \\sqrt{\\sum_{i=1}^{n} (Y_i - \\bar{Y})^2}},$$ 其中 $\\bar{S}$ 和 $\\bar{Y}$ 是样本均值。\n3. 通过返回两个布尔值来解释预测性用途与因果性用途，计算方式如下：定义 $\\text{predictive\\_valid} = \\text{True}$，如果 $\\sigma_S  0$, $\\sigma_Y  0$ 且 $\\rho_{SY}  0$，否则为 $\\text{False}$；定义 $\\text{causal\\_warranted} = \\text{True}$，仅当数据包含暴露变量 $A$ 和测量的协变量 $Z$，使得在一个合理的数据生成机制下，一个有效的调整集能使 $Y \\perp\\!\\!\\!\\perp A \\mid Z$ 成立；在此测试套件中没有暴露变量，因此返回 $\\text{False}$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，格式严格为 `[[s_1,...,s_10],rho,predictive_valid,causal_warranted]]`，其中每个 $s_i$ 是一个整数，$\\rho$ 是一个浮点数，最后两个条目是布尔值。\n\n该测试套件旨在实现覆盖范围：\n- 正常路径：具有多种不同合并症且结局混合的患者。\n- 边界条件：没有编码的患者 ($S_i = 0$)，映射到同一类别的重复编码（只计算一次），以及具有层级优势的类别（严重形式抑制较不严重形式）。\n- 边缘情况：同时存在转移性肿瘤和非转移性肿瘤，有并发症和无并发症的糖尿病，以及轻度与重度肝病。\n\n不涉及物理单位或角度单位。内部将任何比例表示为小数。您的输出必须严格遵循上述指定格式。", "solution": "该问题被认为是有效的，因为它基于已确立的生物统计学方法，具有科学依据；其数据和规则集完整且一致，问题是适定的；并且以客观、正式的语言表述。这些任务在计算上是可行的，并能得出一个唯一且有意义的解。\n\n解决方案按指定的三个步骤进行：(1) 为一个包含10名患者的队列计算Charlson合并症指数 (CCI) 得分，(2) 计算CCI得分与1年期死亡率之间的皮尔逊相关系数，以及 (3) 从预测与因果的角度解释结果。\n\n### 步骤1：Charlson合并症指数 (CCI) 得分计算\n\n每位患者的CCI得分 $S_i$ 是其唯一合并症类别权重的总和，$S_i = \\sum_{c \\in \\mathcal{C}_i} w(c)$。唯一类别集合 $\\mathcal{C}_i$ 是通过将患者的ICD-10编码映射到预定义的Charlson类别来确定的，同时确保每个类别最多贡献一次其权重，并应用指定的层级规则，即严重疾病会抑制较轻形式的贡献。\n\n提供了从ICD-10前缀到类别和权重 $w(c)$ 的映射。我们将其应用于 $n=10$ 名患者中的每一位。\n\n- **患者1**：编码：$\\varnothing$，死亡率 $Y_1=0$。\n  - 不存在任何编码。\n  - 类别集合为空，$\\mathcal{C}_1 = \\varnothing$。\n  - 得分为 $S_1 = 0$。\n\n- **患者2**：编码：$\\{\\text{\"I21.0\"}\\}$，死亡率 $Y_2=0$。\n  - 编码 `\"I21.0\"` 映射到“心肌梗死”类别 ($w=1$)。\n  - $\\mathcal{C}_2 = \\{\\text{心肌梗死}\\}$。\n  - 得分为 $S_2 = 1$。\n\n- **患者3**：编码：$\\{\\text{\"I50.9\"}, \\text{\"I50.2\"}, \\text{\"J44.9\"}\\}$，死亡率 $Y_3=0$。\n  - `\"I50.9\"` 和 `\"I50.2\"` 都映射到“充血性心力衰竭” ($w=1$)。编码 `\"J44.9\"` 映射到“慢性阻塞性肺疾病” ($w=1$)。\n  - 唯一类别集合为 $\\mathcal{C}_3 = \\{\\text{充血性心力衰竭}, \\text{慢性阻塞性肺疾病}\\}$。\n  - 得分为 $S_3 = 1 + 1 = 2$。\n\n- **患者4**：编码：$\\{\\text{\"E11.9\"}, \\text{\"I70.20\"}\\}$，死亡率 $Y_4=0$。\n  - `\"E11.9\"` 映射到“无并发症的糖尿病” ($w=1$)。`\"I70.20\"` 映射到“外周血管疾病” ($w=1$)。\n  - 无层级规则适用。$\\mathcal{C}_4 = \\{\\text{无并发症的糖尿病}, \\text{外周血管疾病}\\}$。\n  - 得分为 $S_4 = 1 + 1 = 2$。\n\n- **患者5**：编码：$\\{\\text{\"E11.22\"}, \\text{\"N18.5\"}, \\text{\"G81.9\"}\\}$，死亡率 $Y_5=1$。\n  - `\"E11.22\"` 映射到“伴有终末器官损害的糖尿病” ($w=2$)。`\"N18.5\"` 映射到“中度或重度肾病” ($w=2$)。`\"G81.9\"` 映射到“偏瘫或截瘫” ($w=2$)。\n  - 患者的编码也可能通过前缀 `\"E11\"` 映射到“无并发症的糖尿病”。然而，层级规则规定，“伴有终末器官损害的糖尿病”的存在会抑制来自无并发症形式的权重。\n  - $\\mathcal{C}_5 = \\{\\text{伴有终末器官损害的糖尿病}, \\text{中度或重度肾病}, \\text{偏瘫或截瘫}\\}$。\n  - 得分为 $S_5 = 2 + 2 + 2 = 6$。\n\n- **患者6**：编码：$\\{\\text{\"C50.9\"}\\}$，死亡率 $Y_6=0$。\n  - `\"C50.9\"` 映射到“任何肿瘤（非转移性）” ($w=2$)。\n  - $\\mathcal{C}_6 = \\{\\text{任何肿瘤}\\}$。\n  - 得分为 $S_6 = 2$。\n\n- **患者7**：编码：$\\{\\text{\"C78.7\"}, \\text{\"C50.9\"}\\}$，死亡率 $Y_7=1$。\n  - `\"C78.7\"` 映射到“转移性实体瘤” ($w=6$)。`\"C50.9\"` 映射到“任何肿瘤（非转移性）” ($w=2$)。\n  - 适用于肿瘤的层级规则：“转移性实体瘤”的存在会抑制来自“任何肿瘤”的贡献。\n  - $\\mathcal{C}_7 = \\{\\text{转移性实体瘤}\\}$。\n  - 得分为 $S_7 = 6$。\n\n- **患者8**：编码：$\\{\\text{\"K76.0\"}, \\text{\"K72.90\"}\\}$，死亡率 $Y_8=1$。\n  - `\"K76.0\"` 映射到“轻度肝病” ($w=1$)。`\"K72.90\"` 映射到“中度或重度肝病” ($w=3$)。\n  - 适用于肝病的层级规则：“中度或重度肝病”抑制“轻度肝病”。\n  - $\\mathcal{C}_8 = \\{\\text{中度或重度肝病}\\}$。\n  - 得分为 $S_8 = 3$。\n\n- **患者9**：编码：$\\{\\text{\"B20\"}, \\text{\"J44.9\"}, \\text{\"I63.9\"}\\}$，死亡率 $Y_9=1$。\n  - `\"B20\"` 映射到“获得性免疫缺陷综合征” ($w=6$)。`\"J44.9\"` 映射到“慢性阻塞性肺疾病” ($w=1$)。`\"I63.9\"` 映射到“脑血管疾病” ($w=1$)。\n  - $\\mathcal{C}_9 = \\{\\text{艾滋病}, \\text{COPD}, \\text{脑血管疾病}\\}$。\n  - 得分为 $S_9 = 6 + 1 + 1 = 8$。\n\n- **患者10**：编码：$\\{\\text{\"F03.90\"}, \\text{\"M32.10\"}, \\text{\"K25.9\"}, \\text{\"I73.9\"}\\}$，死亡率 $Y_{10}=0$。\n  - `\"F03.90\"` $\\to$ “痴呆” ($w=1$)。`\"M32.10\"` $\\to$ “结缔组织病” ($w=1$)。`\"K25.9\"` $\\to$ “消化性溃疡病” ($w=1$)。`\"I73.9\"` $\\to$ “外周血管疾病” ($w=1$)。\n  - $\\mathcal{C}_{10} = \\{\\text{痴呆}, \\text{结缔组织病}, \\text{消化性溃疡病}, \\text{外周血管疾病}\\}$。\n  - 得分为 $S_{10} = 1 + 1 + 1 + 1 = 4$。\n\n得到的CCI得分向量为 $S = (0, 1, 2, 2, 6, 2, 6, 3, 8, 4)$。\n\n### 步骤2：皮尔逊相关性计算\n\n我们使用提供的公式计算得分向量 $S$ 与死亡率向量 $Y = (0, 0, 0, 0, 1, 0, 1, 1, 1, 0)$ 之间的皮尔逊相关系数 $\\rho_{SY}$：\n$$ \\rho_{SY} = \\frac{\\sum_{i=1}^{n} (S_i - \\bar{S})(Y_i - \\bar{Y})}{\\sqrt{\\sum_{i=1}^{n} (S_i - \\bar{S})^2} \\, \\sqrt{\\sum_{i=1}^{n} (Y_i - \\bar{Y})^2}} $$\n首先，我们计算这 $n=10$ 名患者的样本均值：\n- $\\bar{S} = \\frac{1}{10}\\sum_{i=1}^{10} S_i = \\frac{0+1+2+2+6+2+6+3+8+4}{10} = \\frac{34}{10} = 3.4$\n- $\\bar{Y} = \\frac{1}{10}\\sum_{i=1}^{10} Y_i = \\frac{0+0+0+0+1+0+1+1+1+0}{10} = \\frac{4}{10} = 0.4$\n\n接下来，我们计算公式所需的项：\n- 偏差交叉乘积之和（分子）：\n$$ \\sum_{i=1}^{10} (S_i - \\bar{S})(Y_i - \\bar{Y}) = (0-3.4)(0-0.4) + \\dots + (4-3.4)(0-0.4) = 9.4 $$\n- $S$的偏差平方和：\n$$ \\sum_{i=1}^{10} (S_i - \\bar{S})^2 = (0-3.4)^2 + (1-3.4)^2 + \\dots + (4-3.4)^2 = 58.4 $$\n- $Y$的偏差平方和：\n$$ \\sum_{i=1}^{10} (Y_i - \\bar{Y})^2 = 6 \\times (0-0.4)^2 + 4 \\times (1-0.4)^2 = 6 \\times 0.16 + 4 \\times 0.36 = 2.4 $$\n将这些值代入相关公式：\n$$ \\rho_{SY} = \\frac{9.4}{\\sqrt{58.4} \\cdot \\sqrt{2.4}} = \\frac{9.4}{\\sqrt{140.16}} \\approx 0.79400003 $$\n约0.794的正相关性表明，在此样本中，计算出的CCI得分与1年期死亡率之间存在很强的正向线性关联。\n\n### 步骤3：预测与因果解释\n\n最后一项任务是根据结果和问题的框架评估两个布尔值。\n\n1.  **$\\text{predictive\\_valid}$**：如果两个变量的标准差均为正（$\\sigma_S  0, \\sigma_Y  0$）且相关性为正（$\\rho_{SY}  0$），则定义为 $\\text{True}$。\n    - $S$的方差非零，因为 $\\sum(S_i - \\bar{S})^2 = 58.4  0$，所以 $\\sigma_S  0$。\n    - $Y$的方差非零，因为 $\\sum(Y_i - \\bar{Y})^2 = 2.4  0$，所以 $\\sigma_Y  0$。\n    - 相关性 $\\rho_{SY} \\approx 0.794  0$。\n    - 所有三个条件都满足，因此 $\\text{predictive\\_valid} = \\text{True}$。这表明CCI得分对该数据集中的死亡率具有预测价值。\n\n2.  **$\\text{causal\\_warranted}$**：仅在特定的结构性条件下才定义为 $\\text{True}$，即存在暴露变量 $A$ 和一组测量的协变量 $Z$，从而允许进行因果识别（例如，通过后门准则）。问题陈述明确指出，测试套件不包含这些元素。相关性 $\\rho_{SY}$ 是关联的度量，而非因果关系。在没有正式的因果模型和必要数据来控制混杂因素的情况下，仅基于此分析就声称更高的CCI得分*导致*更高的死亡风险是没有根据的。因此，根据规定，$\\text{causal\\_warranted} = \\text{False}$。\n\n综合这些结果得出最终输出。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes Charlson Comorbidity Index scores, their correlation with mortality,\n    and interprets the results for predictive vs. causal validity.\n    \"\"\"\n    \n    # Define the mapping from ICD-10 prefixes to Charlson categories, weights,\n    # and hierarchical suppression rules.\n    categories = {\n        'mi': {'weight': 1, 'prefixes': {\"I21\", \"I22\", \"I25.2\"}},\n        'chf': {'weight': 1, 'prefixes': {\"I50\"}},\n        'pvd': {'weight': 1, 'prefixes': {\"I70.2\", \"I73.9\"}},\n        'cvd': {'weight': 1, 'prefixes': {\"I63\"}},\n        'dementia': {'weight': 1, 'prefixes': {\"F03\"}},\n        'copd': {'weight': 1, 'prefixes': {\"J44\"}},\n        'ctd': {'weight': 1, 'prefixes': {\"M32\"}},\n        'pud': {'weight': 1, 'prefixes': {\"K25\"}},\n        'mild_liver': {'weight': 1, 'prefixes': {\"K76.0\", \"K73\"}, 'suppressed_by': 'mod_sev_liver'},\n        'dm_uncomp': {'weight': 1, 'prefixes': {\"E11\"}, 'suppressed_by': 'dm_comp'},\n        'dm_comp': {'weight': 2, 'prefixes': {\"E11.22\", \"E11.4\"}},\n        'hemiplegia': {'weight': 2, 'prefixes': {\"G81\"}},\n        'mod_sev_renal': {'weight': 2, 'prefixes': {\"N18.5\"}},\n        'tumor': {'weight': 2, 'prefixes': {\"C50\"}, 'suppressed_by': 'meta_tumor'},\n        'leukemia': {'weight': 2, 'prefixes': {\"C91\"}},\n        'lymphoma': {'weight': 2, 'prefixes': {\"C85\"}},\n        'mod_sev_liver': {'weight': 3, 'prefixes': {\"K72.9\"}},\n        'meta_tumor': {'weight': 6, 'prefixes': {\"C78\"}},\n        'aids': {'weight': 6, 'prefixes': {\"B20\"}},\n    }\n\n    # Define the test suite data from the problem statement.\n    test_suite = [\n        ({'codes': [], 'mortality': 0}),\n        ({'codes': {\"I21.0\"}, 'mortality': 0}),\n        ({'codes': {\"I50.9\", \"I50.2\", \"J44.9\"}, 'mortality': 0}),\n        ({'codes': {\"E11.9\", \"I70.20\"}, 'mortality': 0}),\n        ({'codes': {\"E11.22\", \"N18.5\", \"G81.9\"}, 'mortality': 1}),\n        ({'codes': {\"C50.9\"}, 'mortality': 0}),\n        ({'codes': {\"C78.7\", \"C50.9\"}, 'mortality': 1}),\n        ({'codes': {\"K76.0\", \"K72.90\"}, 'mortality': 1}),\n        ({'codes': {\"B20\", \"J44.9\", \"I63.9\"}, 'mortality': 1}),\n        ({'codes': {\"F03.90\", \"M32.10\", \"K25.9\", \"I73.9\"}, 'mortality': 0}),\n    ]\n    \n    # Task 1: Compute Charlson Comorbidity Index scores\n    scores = []\n    mortality_labels = []\n\n    for patient in test_suite:\n        mortality_labels.append(patient['mortality'])\n        present_categories = set()\n        for code in patient['codes']:\n            for cat_id, cat_info in categories.items():\n                for prefix in cat_info['prefixes']:\n                    if code.startswith(prefix):\n                        present_categories.add(cat_id)\n        \n        # Apply hierarchical rules\n        categories_to_remove = set()\n        for cat_id in present_categories:\n            cat_info = categories.get(cat_id, {})\n            suppressor = cat_info.get('suppressed_by')\n            if suppressor and suppressor in present_categories:\n                categories_to_remove.add(cat_id)\n        \n        final_categories = present_categories - categories_to_remove\n        \n        # Sum weights of final categories\n        current_score = sum(categories[cat_id]['weight'] for cat_id in final_categories)\n        scores.append(current_score)\n        \n    S = np.array(scores, dtype=np.float64)\n    Y = np.array(mortality_labels, dtype=np.float64)\n    \n    # Task 2: Compute Pearson correlation\n    n = len(S)\n    s_mean = np.mean(S)\n    y_mean = np.mean(Y)\n\n    # Handle the case of zero variance to avoid division by zero\n    s_ss = np.sum((S - s_mean)**2)\n    y_ss = np.sum((Y - y_mean)**2)\n    \n    if s_ss == 0 or y_ss == 0:\n        rho = 0.0\n    else:\n        numerator = np.sum((S - s_mean) * (Y - y_mean))\n        denominator = np.sqrt(s_ss * y_ss)\n        rho = numerator / denominator\n\n    # Task 3: Compute predictive vs. causal booleans\n    # The problem defines sigma > 0 implicitly through the sum of squares being > 0\n    sigma_S_positive = s_ss > 0\n    sigma_Y_positive = y_ss > 0\n    predictive_valid = sigma_S_positive and sigma_Y_positive and (rho > 0)\n    \n    causal_warranted = False  # As per problem statement\n\n    # Format the final output string exactly as specified.\n    scores_str = f\"[{','.join(map(str, scores))}]\"\n    final_output_str = f\"[{scores_str},{rho},{str(predictive_valid).lower()},{str(causal_warranted).lower()}]\"\n    \n    # According to problem statement, the required output format is `[[s_1,...,s_{10}],rho,predictive_valid,causal_warranted]]`\n    # The python boolean must be converted to lowercase string 'true'/'false'\n    # and the rho must be a float, not a string representation.\n    # The sample output in the prompt shows `[[s_1,...,s_{10}],rho,predictive_valid,causal_warranted]]`\n    # Let's rebuild this carefully, as the variable names might be confusing.\n    print(f\"[{scores_str},{rho},{str(predictive_valid).lower()},{str(causal_warranted).lower()}]\")\n\nsolve()\n```", "id": "5054781"}, {"introduction": "从纵向真实世界数据中估计因果效应是一项复杂的任务，特别是当存在时变混杂因素时——这些变量既受过去治疗的影响，又影响未来的治疗决策。这项高级实践介绍了一种强大的解决方案：带有逆概率加权的边际结构模型。通过为一个微型数据集计算稳定权重，您将亲身体验这种能够在复杂观察性研究中进行稳健因果推断的方法[@problem_id:5054426]。", "problem": "给定一个纵向玩具数据集，该数据集与转化医学中电子健康记录（EHR）、行政理赔数据和患者登记源中遇到的数据一致。每个个体在两次访视中有两个二元治疗指标 $A_1$ 和 $A_2$（其中 $A_t \\in \\{0,1\\}$），一个在 $A_1$ 和 $A_2$ 之间测量且受 $A_1$ 影响的时变二元混杂因素 $L_1 \\in \\{0,1\\}$，以及一个在 $A_2$ 之后测量的二元结局 $Y \\in \\{0,1\\}$。使用条件概率法则和联合概率分解，构建稳定逆概率治疗权重，以对观测数据进行重新加权，从而模拟一个已移除 $L_1$ 造成的时变混杂的伪人群。然后，使用这些权重估计“始终治疗”与“从不治疗”之间的边际静态方案因果对比，该对比定义为静态方案 $(A_1,A_2)=(1,1)$ 和 $(A_1,A_2)=(0,0)$ 下加权平均结局的差异。\n\n计算的基本原理和规则：\n- 对于任何概率为 $p = \\Pr(B=1 \\mid \\cdot)$ 的二元变量 $B \\in \\{0,1\\}$，观测值 $b$ 的概率质量为 $\\Pr(B=b \\mid \\cdot) = p^{b}(1-p)^{1-b}$，当 $b=1$ 时简化为 $p$，当 $b=0$ 时简化为 $1-p$。\n- 根据链式法则，治疗史的联合质量可按时间顺序分解。稳定权重的构建方法是，将各个治疗时间的分子质量（排除了时变混杂因素的简化模型下的治疗概率）除以分母质量（以包括 $L_1$ 的历史为条件的观测模型下的治疗概率）的乘积。在此设置中，由于 $A_1$ 之前没有基线协变量，时间点 1 的因子抵消为 1。\n- 对于一个静态方案 $(a_1^*, a_2^*)$，特定治疗的平均结局通过加权平均来估计\n$$\n\\widehat{\\mathbb{E}}[Y^{a_1^*,a_2^*}] = \\frac{\\sum_{i=1}^{n} \\text{SW}_i \\cdot \\mathbf{1}(A_{1i}=a_1^*, A_{2i}=a_2^*) \\cdot Y_i}{\\sum_{i=1}^{n} \\text{SW}_i \\cdot \\mathbf{1}(A_{1i}=a_1^*, A_{2i}=a_2^*)},\n$$\n其中 $\\text{SW}_i$ 是个体 $i$ 的稳定权重，$\\mathbf{1}(\\cdot)$ 是指示函数。目标对比是\n$$\n\\Delta = \\widehat{\\mathbb{E}}[Y^{1,1}] - \\widehat{\\mathbb{E}}[Y^{0,0}].\n$$\n\n您的程序必须使用所提供的数据集和治疗分配概率模型来实现此过程，并为每个测试用例输出估计的 $\\Delta$。所有概率均作为固定值提供，代表在真实世界数据（EHR、理赔数据、登记数据）中拟合的模型。不涉及物理单位。所有最终结果表示为四舍五入到六位小数的十进制浮点数。\n\n测试套件规范：\n对于每个测试用例，您将获得：\n- 一个包含 $n$ 个个体的元组 $(A_1, L_1, A_2, Y)$ 的数据集。\n- 第一次治疗的边际概率 $\\Pr(A_1=1)$（为完整性而包含；由于没有基线协变量，时间点 1 的因子抵消为 1）。\n- 第二次治疗的简化（分子）模型，$\\Pr(A_2=1 \\mid A_1=a_1)$，其中 $a_1 \\in \\{0,1\\}$。\n- 第二次治疗的完整（分母）模型，$\\Pr(A_2=1 \\mid A_1=a_1, L_1=\\ell_1)$，其中 $a_1,\\ell_1 \\in \\{0,1\\}$。\n\n对每个个体 $i$，计算稳定权重\n$$\n\\text{SW}_i \\;=\\; \\frac{\\Pr(A_{2i}=a_{2i} \\mid A_{1i}=a_{1i})}{\\Pr(A_{2i}=a_{2i} \\mid A_{1i}=a_{1i}, L_{1i}=\\ell_{1i})},\n$$\n使用所提供概率的伯努利质量法则计算观测值 $a_{2i} \\in \\{0,1\\}$。然后按上述定义计算 $\\widehat{\\mathbb{E}}[Y^{1,1}]$、$\\widehat{\\mathbb{E}}[Y^{0,0}]$ 和 $\\Delta$。\n\n为以下三个测试用例提供结果：\n\n- 测试用例 1（一般情况）：\n  - $n=8$ 个个体的数据 $(A_1, L_1, A_2, Y)$：\n    - $(1,1,1,1)$\n    - $(1,0,1,1)$\n    - $(1,1,0,0)$\n    - $(0,0,0,0)$\n    - $(0,1,1,1)$\n    - $(0,0,1,0)$\n    - $(1,0,0,0)$\n    - $(0,1,0,0)$\n  - $\\Pr(A_1=1) = 0.6$。\n  - 第二次治疗的分子模型：$\\Pr(A_2=1 \\mid A_1=1)=0.5$，$\\Pr(A_2=1 \\mid A_1=0)=0.3$。\n  - 第二次治疗的分母模型：\n    - $\\Pr(A_2=1 \\mid A_1=1,L_1=1)=0.8$\n    - $\\Pr(A_2=1 \\mid A_1=1,L_1=0)=0.4$\n    - $\\Pr(A_2=1 \\mid A_1=0,L_1=1)=0.6$\n    - $\\Pr(A_2=1 \\mid A_1=0,L_1=0)=0.2$\n\n- 测试用例 2（近边界概率）：\n  - $n=6$ 个个体的数据 $(A_1, L_1, A_2, Y)$：\n    - $(1,1,1,1)$\n    - $(1,1,0,0)$\n    - $(1,0,1,1)$\n    - $(0,1,1,1)$\n    - $(0,0,0,0)$\n    - $(0,0,1,0)$\n  - $\\Pr(A_1=1) = 0.5$。\n  - 第二次治疗的分子模型：$\\Pr(A_2=1 \\mid A_1=1)=0.8$，$\\Pr(A_2=1 \\mid A_1=0)=0.2$。\n  - 第二次治疗的分母模型：\n    - $\\Pr(A_2=1 \\mid A_1=1,L_1=1)=0.95$\n    - $\\Pr(A_2=1 \\mid A_1=1,L_1=0)=0.05$\n    - $\\Pr(A_2=1 \\mid A_1=0,L_1=1)=0.9$\n    - $\\Pr(A_2=1 \\mid A_1=0,L_1=0)=0.1$\n\n- 测试用例 3（混合结局和中等概率）：\n  - $n=7$ 个个体的数据 $(A_1, L_1, A_2, Y)$：\n    - $(1,1,0,0)$\n    - $(1,0,1,0)$\n    - $(1,1,1,1)$\n    - $(0,1,0,0)$\n    - $(0,1,1,1)$\n    - $(1,0,0,0)$\n    - $(0,0,0,0)$\n  - $\\Pr(A_1=1) = 0.7$。\n  - 第二次治疗的分子模型：$\\Pr(A_2=1 \\mid A_1=1)=0.6$，$\\Pr(A_2=1 \\mid A_1=0)=0.25$。\n  - 第二次治疗的分母模型：\n    - $\\Pr(A_2=1 \\mid A_1=1,L_1=1)=0.7$\n    - $\\Pr(A_2=1 \\mid A_1=1,L_1=0)=0.3$\n    - $\\Pr(A_2=1 \\mid A_1=0,L_1=1)=0.5$\n    - $\\Pr(A_2=1 \\mid A_1=0,L_1=0)=0.2$\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含按顺序排列的测试用例 1、2 和 3 的三个估计对比值 $\\Delta$，形式为方括号内以逗号分隔的列表，每个值都四舍五入到六位小数，例如 $[r_1,r_2,r_3]$，其中 $r_1$、$r_2$ 和 $r_3$ 是十进制浮点数。", "solution": "该问题是有效的，因为它提出了一个适定、有科学依据且客观的任务，该任务基于生物统计学中既定的因果推断原则，而生物统计学是转化医学不可或缺的学科。该问题要求使用稳定逆概率治疗权重（IPTW）来估计因果对比，以调整时变混杂因素。在分析来自电子健康记录（EHR）等来源的纵向真实世界数据时，这是一个标准且关键的程序。所有必要的数据、模型和定义均已提供，问题结构没有矛盾、模糊或谬误。\n\n目标是估计因果风险差异 $\\Delta = \\mathbb{E}[Y^{\\bar{a}=(1,1)}] - \\mathbb{E}[Y^{\\bar{a}=(0,0)}]$，比较“始终治疗”与“从不治疗”的静态治疗方案。分析的复杂性在于存在一个时变混杂因素 $L_1$，它是一个基线后变量，受第一次治疗 $A_1$ 的影响，并反过来影响后续治疗 $A_2$ 和结局 $Y$。对 $L_1$ 进行标准回归调整是不合适的，因为它会阻断 $A_1$ 的部分效应并可能引入偏倚。边际结构模型的逆概率加权是处理这种因果结构的适当方法。\n\n该方法的核心是构建稳定权重 $\\text{SW}_i$。这些权重创建了一个伪人群，在该伪人群中，时变混杂因素 $L_1$ 与后续治疗 $A_2$ 之间的关联被打破，同时保留了治疗随时间的边际关联。对于每个个体 $i$，稳定权重是其在不包含时变混杂因素的模型下的观测治疗史概率与在包含该混杂因素的模型下的观测治疗史概率之比。\n\n鉴于治疗的序贯性，治疗史 $(A_{1i}, A_{2i})$ 的联合概率可分解为 $\\Pr(A_{1i}=a_{1i}, A_{2i}=a_{2i}) = \\Pr(A_{2i}=a_{2i} \\mid A_{1i}=a_{1i}) \\Pr(A_{1i}=a_{1i})$。对于具有观测历史 $(a_{1i}, \\ell_{1i}, a_{2i})$ 的个体 $i$，完整的稳定权重由下式给出：\n$$\n\\text{SW}_i = \\frac{\\Pr(A_{1i}=a_{1i}) \\Pr(A_{2i}=a_{2i} \\mid A_{1i}=a_{1i})}{\\Pr(A_{1i}=a_{1i}) \\Pr(A_{2i}=a_{2i} \\mid A_{1i}=a_{1i}, L_{1i}=\\ell_{1i})}\n$$\n问题指明在 $A_1$ 之前没有测量基线协变量。因此，$\\Pr(A_1=a_1)$ 的分子和分母模型是相同的，该项从权重表达式中抵消。因此，简化的稳定权重仅由时间点 2 的治疗分配决定：\n$$\n\\text{SW}_i \\;=\\; \\frac{\\Pr(A_{2i}=a_{2i} \\mid A_{1i}=a_{1i})}{\\Pr(A_{2i}=a_{2i} \\mid A_{1i}=a_{1i}, L_{1i}=\\ell_{1i})}\n$$\n为了实施这一过程，我们使用所提供的概率模型和观测二元变量 $b \\in \\{0,1\\}$ 的概率质量通用公式 $p^b(1-p)^{1-b}$，其中成功概率为 $p = \\Pr(B=1 \\mid \\cdot)$。对于给定数据为 $(a_{1i}, \\ell_{1i}, a_{2i}, y_i)$ 的个体 $i$，我们按如下方式计算权重：\n1. 确定分子概率 $p_{num} = \\Pr(A_2=1 \\mid A_1=a_{1i})$。观测值 $a_{2i}$ 的概率质量为 $m_{num} = p_{num}^{a_{2i}}(1-p_{num})^{1-a_{2i}}$。\n2. 确定分母概率 $p_{den} = \\Pr(A_2=1 \\mid A_1=a_{1i}, L_1=\\ell_{1i})$。观测值 $a_{2i}$ 的概率质量为 $m_{den} = p_{den}^{a_{2i}}(1-p_{den})^{1-a_{2i}}$。\n3. 权重为 $\\text{SW}_i = m_{num} / m_{den}$。\n\n一旦计算出所有 $n$ 个个体的权重，我们使用加权平均来估计每个静态方案 $(a_1^*, a_2^*)$ 下的平均结局。这个估计量是 Horvitz-Thompson 估计量的一个特例。对于感兴趣的方案，我们只考虑数据集中观测治疗史与该方案一致的个体，即 $(A_{1i}, A_{2i}) = (a_1^*, a_2^*)$。特定治疗平均值的估计量为：\n$$\n\\widehat{\\mathbb{E}}[Y^{a_1^*,a_2^*}] = \\frac{\\sum_{i=1}^{n} \\text{SW}_i \\cdot \\mathbf{1}(A_{1i}=a_1^*, A_{2i}=a_2^*) \\cdot Y_i}{\\sum_{i=1}^{n} \\text{SW}_i \\cdot \\mathbf{1}(A_{1i}=a_1^*, A_{2i}=a_2^*)}\n$$\n其中 $\\mathbf{1}(\\cdot)$ 是指示函数。分子是符合条件的个体的加权结局之和，分母是他们的权重之和。\n\n步骤如下：\n1. 对于每个测试用例，我们根据每个个体的观测数据 $(a_{1i}, \\ell_{1i}, a_{2i})$ 以及所提供的分子和分母概率模型，系统地计算 $\\text{SW}_i$。\n2. 为了估计 $\\widehat{\\mathbb{E}}[Y^{1,1}]$，我们识别出所有满足 $(A_{1i}, A_{2i}) = (1,1)$ 的个体。然后我们计算他们的加权结局之和 $\\sum \\text{SW}_i \\cdot Y_i$，并除以他们的权重之和 $\\sum \\text{SW}_i$。\n3. 类似地，为了估计 $\\widehat{\\mathbb{E}}[Y^{0,0}]$，我们识别出所有满足 $(A_{1i}, A_{2i}) = (0,0)$ 的个体，并计算他们的加权平均结局。\n4. 最终的因果对比是差值：$\\Delta = \\widehat{\\mathbb{E}}[Y^{1,1}] - \\widehat{\\mathbb{E}}[Y^{0,0}]$。\n\n对问题陈述中指定的三个测试用例中的每一个都实施了这整个计算过程。例如，对于测试用例 1 中数据为 $(A_1=1, L_1=1, A_2=1, Y=1)$ 的个体，分子概率为 $\\Pr(A_2=1 \\mid A_1=1) = 0.5$，分母概率为 $\\Pr(A_2=1 \\mid A_1=1, L_1=1) = 0.8$。权重为 $\\text{SW} = 0.5/0.8 = 0.625$。对于数据为 $(A_1=1, L_1=1, A_2=0, Y=0)$ 的个体，分子质量为 $\\Pr(A_2=0 \\mid A_1=1) = 1-0.5 = 0.5$，分母质量为 $\\Pr(A_2=0 \\mid A_1=1, L_1=1) = 1-0.8 = 0.2$，权重为 $\\text{SW} = 0.5/0.2 = 2.5$。对所有个体执行这些计算，并将结果汇总以产生最终估计。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the three test cases.\n    It calculates the stabilized inverse probability of treatment weights and\n    estimates the causal contrast between always-treated and never-treated regimens.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"data\": np.array([\n                [1, 1, 1, 1], [1, 0, 1, 1], [1, 1, 0, 0], [0, 0, 0, 0],\n                [0, 1, 1, 1], [0, 0, 1, 0], [1, 0, 0, 0], [0, 1, 0, 0]\n            ]),\n            \"p_num\": {1: 0.5, 0: 0.3},\n            \"p_den\": {\n                1: {1: 0.8, 0: 0.4},\n                0: {1: 0.6, 0: 0.2}\n            }\n        },\n        {\n            \"data\": np.array([\n                [1, 1, 1, 1], [1, 1, 0, 0], [1, 0, 1, 1],\n                [0, 1, 1, 1], [0, 0, 0, 0], [0, 0, 1, 0]\n            ]),\n            \"p_num\": {1: 0.8, 0: 0.2},\n            \"p_den\": {\n                1: {1: 0.95, 0: 0.05},\n                0: {1: 0.9, 0: 0.1}\n            }\n        },\n        {\n            \"data\": np.array([\n                [1, 1, 0, 0], [1, 0, 1, 0], [1, 1, 1, 1],\n                [0, 1, 0, 0], [0, 1, 1, 1], [1, 0, 0, 0],\n                [0, 0, 0, 0]\n            ]),\n            \"p_num\": {1: 0.6, 0: 0.25},\n            \"p_den\": {\n                1: {1: 0.7, 0: 0.3},\n                0: {1: 0.5, 0: 0.2}\n            }\n        }\n    ]\n\n    results = []\n\n    for case in test_cases:\n        data = case[\"data\"]\n        p_num_model = case[\"p_num\"]\n        p_den_model = case[\"p_den\"]\n\n        weights = []\n        for row in data:\n            a1, l1, a2, y = int(row[0]), int(row[1]), int(row[2]), int(row[3])\n            \n            p_num = p_num_model[a1]\n            m_num = p_num if a2 == 1 else 1 - p_num\n            \n            p_den = p_den_model[a1][l1]\n            m_den = p_den if a2 == 1 else 1 - p_den\n            \n            sw = m_num / m_den\n            weights.append(sw)\n        \n        weights = np.array(weights)\n\n        # Estimate for regimen (1, 1)\n        a1_obs, a2_obs, y_obs = data[:, 0], data[:, 2], data[:, 3]\n        \n        mask_11 = (a1_obs == 1)  (a2_obs == 1)\n        sum_sw_y_11 = np.sum(weights[mask_11] * y_obs[mask_11])\n        sum_sw_11 = np.sum(weights[mask_11])\n        mean_y_11 = sum_sw_y_11 / sum_sw_11 if sum_sw_11 != 0 else 0\n\n        # Estimate for regimen (0, 0)\n        mask_00 = (a1_obs == 0)  (a2_obs == 0)\n        sum_sw_y_00 = np.sum(weights[mask_00] * y_obs[mask_00])\n        sum_sw_00 = np.sum(weights[mask_00])\n        mean_y_00 = sum_sw_y_00 / sum_sw_00 if sum_sw_00 != 0 else 0\n\n        delta = mean_y_11 - mean_y_00\n        results.append(delta)\n\n    # Format the final output string exactly as required\n    print(f\"[{','.join(f'{r:.6f}' for r in results)}]\")\n\nsolve()\n```", "id": "5054426"}]}