{"hands_on_practices": [{"introduction": "在进行切除手术前，通过直接电刺激进行功能性脑图谱绘制对于识别重要功能皮层至关重要。然而，如果刺激参数控制不当，此过程存在组织损伤的风险，因此一个关键的安全指标是电荷密度，它必须保持在既定阈值以下以防止电化学损伤。本练习将指导您基于电荷、电流和面积的基本物理原理，计算最大安全刺激电流，这对于理解侵入性神经生理学操作中的生物物理限制至关重要。[@problem_id:4516331]", "problem": "一名患有耐药性局灶性癫痫的患者正在接受术前功能区定位，使用硬膜下皮层脑电图（ECoG）栅状电极。为了最大限度地减少与刺激相关的损伤，临床团队遵循一项经过充分检验的安全实践：将暴露触点上的每相电荷密度限制在或低于一个广泛用于皮层组织中光滑铂铱电极的上限。刺激波形是在恒流模式下传递的对称、电荷平衡的双相矩形脉冲，每相的持续时间为 $PW = 0.30\\,\\mathrm{ms}$，制造商提供的暴露圆形触点面积为 $A = 0.0415\\,\\mathrm{cm}^{2}$。所采用的每相电荷密度上限为 $L_{\\max} = 30\\,\\mathrm{\\mu C}\\,\\mathrm{cm}^{-2}$。一个计划中的刺激序列将使用 $I_{\\text{plan}} = 3.80\\,\\mathrm{mA}$ 的相位幅度。\n\n从电荷 $q$ 等于电流 $i(t)$ 在一个相位上的时间积分，以及电荷密度是单位面积的电荷这两个基本定义出发，推导出一个表达式，用于计算最大恒定电流相位幅度 $I_{\\max}$，该幅度能使此触点和波形下的每相电荷密度保持在或低于 $L_{\\max}$。计算 $I_{\\max}$ 的数值，然后利用该值判断计划的幅度 $I_{\\text{plan}}$ 是否在每相电荷密度限制范围内。将您计算的 $I_{\\max}$ 数值结果四舍五入到三位有效数字。以毫安为单位表示最终数值答案。", "solution": "问题陈述经评估，被认为是有效的。其科学依据在于电生理学和生物医学工程的原理，提出了一个数据充分且一致的适定问题。该问题是客观且可直接形式化的。\n\n任务是推导最大安全刺激电流幅度 $I_{\\max}$ 的表达式，计算其值，并判断计划电流 $I_{\\text{plan}}$ 是否符合安全限制。\n\n我们从提供的基本定义开始。电荷 $q$ 是电流 $i(t)$ 的时间积分。对于在时间段 $\\Delta t$ 内施加的恒定电流 $I$，该关系简化为：\n$$q = I \\times \\Delta t$$\n在本题中，刺激波形是恒流矩形脉冲。電流幅度表示为 $I$，每个相位的持续时间由脉冲宽度 $PW$ 给出。因此，在单个相位内传递的总电荷 $q_{\\text{phase}}$ 为：\n$$q_{\\text{phase}} = I \\times PW$$\n第二个基本定义是电荷密度 $L$，即电荷 $q$ 分布在给定面积 $A$ 上：\n$$L = \\frac{q}{A}$$\n在本题的背景下，每相电荷密度 $L_{\\text{phase}}$ 是在一个相位期间传递的电荷 $q_{\\text{phase}}$ 除以暴露的电极触点面积 $A$：\n$$L_{\\text{phase}} = \\frac{q_{\\text{phase}}}{A} = \\frac{I \\times PW}{A}$$\n临床安全实践要求此每相电荷密度不得超过指定的上限 $L_{\\max}$。这就建立了安全约束条件：\n$$L_{\\text{phase}} \\le L_{\\max}$$\n将我们推导出的 $L_{\\text{phase}}$ 表达式代入此不等式，得到：\n$$\\frac{I \\times PW}{A} \\le L_{\\max}$$\n最大允许电流幅度 $I_{\\max}$ 对应于阳极或阴极相位导致电荷密度恰好等于极限值 $L_{\\max}$ 的情况。因此，我们可以通过将表达式设为等式来找到 $I_{\\max}$：\n$$\\frac{I_{\\max} \\times PW}{A} = L_{\\max}$$\n为了推导 $I_{\\max}$ 的表达式，我们通过分离 $I_{\\max}$ 来重排此方程：\n$$I_{\\max} = \\frac{L_{\\max} \\times A}{PW}$$\n这是最大恒流相位幅度的符号表达式。\n\n接下来，我们使用所提供的数据计算 $I_{\\max}$ 的数值：\n- 最大每相电荷密度： $L_{\\max} = 30\\,\\mathrm{\\mu C}\\,\\mathrm{cm}^{-2}$\n- 暴露的触点面积： $A = 0.0415\\,\\mathrm{cm}^{2}$\n- 每相脉冲宽度： $PW = 0.30\\,\\mathrm{ms}$\n\n为确保量纲一致性，我们可以将所有值转换为国际单位制基本单位（安培、库仑、秒、米）或一套一致的单位。让我们先以安培为单位计算该值。\n$L_{\\max} = 30 \\times 10^{-6}\\,\\mathrm{C}\\,\\mathrm{cm}^{-2}$\n$PW = 0.30 \\times 10^{-3}\\,\\mathrm{s}$\n将这些值代入推導出的 $I_{\\max}$ 表达式中：\n$$I_{\\max} = \\frac{(30 \\times 10^{-6}\\,\\mathrm{C}\\,\\mathrm{cm}^{-2}) \\times (0.0415\\,\\mathrm{cm}^{2})}{0.30 \\times 10^{-3}\\,\\mathrm{s}}$$\n面积单位（$\\mathrm{cm}^{2}$）被消去，结果的单位为库仑每秒（$\\mathrm{C}/\\mathrm{s}$），即安培（$\\mathrm{A}$）。\n$$I_{\\max} = \\frac{1.245 \\times 10^{-6}\\,\\mathrm{C}}{0.30 \\times 10^{-3}\\,\\mathrm{s}} = 4.15 \\times 10^{-3}\\,\\mathrm{A}$$\n题目要求答案以毫安（$\\mathrm{mA}$）为单位，其中 $1\\,\\mathrm{A} = 1000\\,\\mathrm{mA}$。\n$$I_{\\max} = (4.15 \\times 10^{-3}) \\times 1000\\,\\mathrm{mA} = 4.15\\,\\mathrm{mA}$$\n题目指定四舍五入到三位有效数字。计算出的值 $4.15\\,\\mathrm{mA}$ 已经有三位有效数字。\n\n最后，我们必须判断计划的刺激幅度 $I_{\\text{plan}} = 3.80\\,\\mathrm{mA}$ 是否在每相电荷密度限制范围内。我们将 $I_{\\text{plan}}$ 与计算出的最大安全幅度 $I_{\\max}$ 进行比较。\n安全的条件是 $I \\le I_{\\max}$。\n比较数值：\n$$3.80\\,\\mathrm{mA} \\le 4.15\\,\\mathrm{mA}$$\n此不等式成立。因此，计划的幅度 $I_{\\text{plan}} = 3.80\\,\\mathrm{mA}$ 在为此电极和脉冲宽度建立的每相电荷密度安全限制范围内。最大允许电流是 $I_{\\max} = 4.15\\,\\mathrm{mA}$。", "answer": "$$\\boxed{4.15}$$", "id": "4516331"}, {"introduction": "精确定位致痫区（epileptogenic zone, EZ）很少依赖单一证据，而是一个从多种来源（如发作症状学、脑电图、磁共振成像、PET等）逐步累积证据的迭代过程。贝叶斯推断提供了一个强大的数学框架，用于在新证据出现时正式更新我们对某一假设的信念。本练习将演示在获得新的PET扫描结果后，如何使用贝叶斯定理来正式更新某个脑区是致痫区的后验概率，从而展示概率方法在量化诊断确定性和制定循证决策中的力量。[@problem_id:4516285]", "problem": "一名耐药性局灶性癫痫患者正在接受术前评估。一个候选皮质区域被建议用于切除。综合癫痫发作符号学、长程视频脑电图和结构磁共振成像的结果，该区域属于致痫区 (EZ) 的先验概率被评估为 $P(\\mathrm{EZ}) = 0.33$。使用 $^{18}\\mathrm{F}$-氟代脱氧葡萄糖的正电子发射断层扫描 (PET) 显示了一个低代谢灶，其与该皮质区域的空间重叠度通过 Dice 重叠系数量化为 $r_{0} = 0.60$。\n\n该中心根据一个内部验证队列，使用了一个从重叠度到似然的经验校准映射，用于事件 $O$（定义为“观测到不小于 $r_{0}$ 的重叠度”），建模如下：\n- $P(O \\mid \\mathrm{EZ}) = \\alpha + \\beta \\, r_{0}$，其中 $\\alpha = 0.50$ 且 $\\beta = 0.40$，\n- $P(O \\mid \\neg \\mathrm{EZ}) = \\gamma + \\delta \\, r_{0}$，其中 $\\gamma = 0.10$ 且 $\\delta = 0.20$，\n在 $r_{0} \\in [0,1]$ 内有效。\n\n假设这些经验似然是良好校准的，事件 $O$ 仅通过上述条件概率依赖于潜在状态 $\\mathrm{EZ}$，并且除了先验和 $O$ 之外，无需以任何其他数据为条件。\n\n仅从条件概率的基本定义 $P(A \\mid B) = \\frac{P(A \\cap B)}{P(B)}$ 和全概率定律出发，推导 $P(\\mathrm{EZ} \\mid O)$ 的表达式，并根据所提供的参数计算其值。将您的答案四舍五入到四位有效数字，并以无单位小数的形式表示。", "solution": "该问题陈述清晰，具有科学依据，并且计算上是可行的。它提供了一套完整的参数和定义，用于通过贝叶斯推断计算一个临床假设的后验概率。\n\n目标是推导后验概率 $P(\\mathrm{EZ} \\mid O)$ 的表达式并计算其值。推导必须从条件概率的基本定义 $P(A \\mid B) = \\frac{P(A \\cap B)}{P(B)}$ 和全概率定律出发。\n\n设 $\\mathrm{EZ}$ 为候选皮质区域属于致痫区的事件，设 $O$ 为观测到 Dice 重叠系数不小于测量值 $r_{0}$ 的事件。我们需要求解 $P(\\mathrm{EZ} \\mid O)$。\n\n根据条件概率的定义，我们有：\n$$P(\\mathrm{EZ} \\mid O) = \\frac{P(\\mathrm{EZ} \\cap O)}{P(O)}$$\n\n分子 $P(\\mathrm{EZ} \\cap O)$ 可以使用 $P(O \\mid \\mathrm{EZ})$ 的条件概率定义来表示：\n$$P(O \\mid \\mathrm{EZ}) = \\frac{P(O \\cap \\mathrm{EZ})}{P(\\mathrm{EZ})}$$\n整理可得：\n$$P(\\mathrm{EZ} \\cap O) = P(O \\mid \\mathrm{EZ}) P(\\mathrm{EZ})$$\n\n分母 $P(O)$ 可以使用全概率定律展开。所有可能结果的集合可以被事件 $\\mathrm{EZ}$ 及其补集 $\\neg \\mathrm{EZ}$（该皮质区域不属于致痫区）所划分。因此，我们可以写出：\n$$P(O) = P(O \\cap \\mathrm{EZ}) + P(O \\cap \\neg \\mathrm{EZ})$$\n对和中的每一项应用条件概率的定义：\n$$P(O) = P(O \\mid \\mathrm{EZ}) P(\\mathrm{EZ}) + P(O \\mid \\neg \\mathrm{EZ}) P(\\neg \\mathrm{EZ})$$\n\n将分子和分母的表达式代入 $P(\\mathrm{EZ} \\mid O)$ 的初始方程，得到最终表达式，即贝叶斯定理：\n$$P(\\mathrm{EZ} \\mid O) = \\frac{P(O \\mid \\mathrm{EZ}) P(\\mathrm{EZ})}{P(O \\mid \\mathrm{EZ}) P(\\mathrm{EZ}) + P(O \\mid \\neg \\mathrm{EZ}) P(\\neg \\mathrm{EZ})}$$\n\n现在，我们使用提供的参数计算其值。\n已知条件如下：\n- 先验概率：$P(\\mathrm{EZ}) = 0.33$。\n- Dice 重叠系数：$r_{0} = 0.60$。\n- 似然模型参数：$\\alpha = 0.50$，$\\beta = 0.40$，$\\gamma = 0.10$，$\\delta = 0.20$。\n\n首先，我们计算补集事件 $\\neg \\mathrm{EZ}$ 的概率：\n$$P(\\neg \\mathrm{EZ}) = 1 - P(\\mathrm{EZ}) = 1 - 0.33 = 0.67$$\n\n接下来，我们根据 $r_{0}$ 的值计算观测事件 $O$ 的条件概率（似然）：\n$$P(O \\mid \\mathrm{EZ}) = \\alpha + \\beta \\, r_{0} = 0.50 + (0.40)(0.60) = 0.50 + 0.24 = 0.74$$\n$$P(O \\mid \\neg \\mathrm{EZ}) = \\gamma + \\delta \\, r_{0} = 0.10 + (0.20)(0.60) = 0.10 + 0.12 = 0.22$$\n\n有了这些值，我们现在可以计算贝叶斯公式中的各项。\n分子是：\n$$P(O \\mid \\mathrm{EZ}) P(\\mathrm{EZ}) = (0.74)(0.33) = 0.2442$$\n分母是证据的全概率 $P(O)$：\n$$P(O) = P(O \\mid \\mathrm{EZ}) P(\\mathrm{EZ}) + P(O \\mid \\neg \\mathrm{EZ}) P(\\neg \\mathrm{EZ})$$\n$$P(O) = (0.74)(0.33) + (0.22)(0.67) = 0.2442 + 0.1474 = 0.3916$$\n\n最后，我们计算后验概率 $P(\\mathrm{EZ} \\mid O)$：\n$$P(\\mathrm{EZ} \\mid O) = \\frac{0.2442}{0.3916} \\approx 0.6235955056$$\n\n问题要求答案四舍五入到四位有效数字。第五位有效数字是 $9$，因此我们将第四位数字向上取整。\n$$P(\\mathrm{EZ} \\mid O) \\approx 0.6236$$\n这是在给定 PET 成像证据的情况下，该皮质区域位于致痫区内的更新概率。", "answer": "$$\\boxed{0.6236}$$", "id": "4516285"}, {"introduction": "全面术前评估的最终目标是预测手术的成功率，这需要将从发作症状学、影像学发现到脑电图模式和认知状况等大量异构数据整合到一个统一的预测判断中。正则化回归模型为此类综合性预测任务提供了稳健的统计框架。在这项高级实践中，您将构建一个多变量逻辑回归模型来预测术后2年的无癫痫发作状态，从而在特征标准化、带正则化的模型拟合以及应用模型进行预测方面获得宝贵的实践经验。[@problem_id:4516266]", "problem": "构建一个多变量预后模型，通过整合症状学、影像学、脑电图（EEG; electroencephalography）和认知功能的信息，来估计癫痫手术后$2$年无癫痫发作的概率。在耐药性癫痫的术前评估框架内进行工作，并按如下方式规范化预测。\n\n从基本定义开始：\n- 令二元手术结局为一个随机变量 $Y \\in \\{0,1\\}$，其中 $Y=1$ 表示在$2$年后无癫痫发作，否则$Y=0$。假设 $Y$ 服从由 $p$ 参数化的伯努利定律，其中 $p$ 是给定协变量 $\\mathbf{x} \\in \\mathbb{R}^p$ 时的条件概率 $p = \\mathbb{P}(Y=1 \\mid \\mathbf{x})$。\n- 令协变量向量 $\\mathbf{x}$ 编码来自症状学、影像学、脑电图和认知功能的术前信息。假设一个线性预测器 $z = \\mathbf{w}^\\top \\tilde{\\mathbf{x}}$，其中 $\\tilde{\\mathbf{x}}$ 是通过为 $\\mathbf{x}$ 增加一个截距项得到的，并要求一个严格单调可微的链接函数 $g$，使得 $p = g(z)$ 将 $\\mathbb{R}$ 映射到开区间 $(0,1)$。使用最大似然原则，通过最小化伯努利模型的期望负对数似然来估计 $\\mathbf{w}$，并对非截距项系数施加强度为 $\\lambda$ 的 $\\ell_2$（岭）惩罚，以反映先验正则性并避免过拟合。\n- 在模型拟合前，将训练数据中的每个特征维度标准化为零均值和单位方差，且不对截距项进行惩罚。\n\n每个患者的临床特征定义：\n- $x_1$：症状学与计划切除侧的一致性（$0$表示不一致，$1$表示一致）。\n- $x_2$：症状学局灶性评分（序数，取值为$\\{0,1,2,3\\}$；越高表示症状学局灶性越强）。\n- $x_3$：磁共振成像（MRI; magnetic resonance imaging）病灶存在性（$0$表示无病灶，$1$表示存在病灶）。\n- $x_4$：病灶-切除一致性（$0$表示不一致或无病灶，$1$表示一致）。\n- $x_5$：头皮脑电图发作期起始与计划切除侧一致（$0$表示不一致，$1$表示一致）。\n- $x_6$：发作间期棘波负荷（每分钟棘波数，归一化到$[0,3]$的无量纲尺度）。\n- $x_7$：基线言语记忆$z$分数（无量纲；典型范围$[-2,2]$）。\n\n包含$N=18$名患者的训练数据集。每个项目列出$(x_1,x_2,x_3,x_4,x_5,x_6,x_7; y)$，其中$y \\in \\{0,1\\}$：\n- 患者 $1$：$(1,3,1,1,1,0.8,0.5; 1)$。\n- 患者 $2$：$(1,2,1,1,1,0.6,0.2; 1)$。\n- 患者 $3$：$(0,1,0,0,0,2.1,-0.8; 0)$。\n- 患者 $4$：$(1,3,0,0,1,1.5,0.4; 1)$。\n- 患者 $5$：$(0,0,1,0,0,2.8,-1.5; 0)$。\n- 患者 $6$：$(1,2,1,1,0,1.2,0.0; 1)$。\n- 患者 $7$：$(1,1,0,0,1,0.9,-0.2; 1)$。\n- 患者 $8$：$(0,1,0,0,0,1.8,-0.7; 0)$。\n- 患者 $9$：$(1,3,1,1,1,0.3,1.2; 1)$。\n- 患者 $10$：$(0,0,0,0,0,2.5,-1.8; 0)$。\n- 患者 $11$：$(1,2,1,1,1,0.5,0.8; 1)$。\n- 患者 $12$：$(0,1,1,0,0,1.7,-0.9; 0)$。\n- 患者 $13$：$(1,3,1,1,0,0.4,0.6; 1)$。\n- 患者 $14$：$(0,0,1,0,1,2.0,-1.0; 0)$。\n- 患者 $15$：$(1,2,0,0,1,1.1,0.3; 1)$。\n- 患者 $16$：$(0,1,0,0,1,2.3,-0.6; 0)$。\n- 患者 $17$：$(1,3,1,1,1,0.7,1.5; 1)$。\n- 患者 $18$：$(0,0,0,0,0,2.2,-1.2; 0)$。\n\n建模和算法要求：\n- 从伯努利模型和将$\\mathbb{R}$映射到$(0,1)$的严格单调链接函数$g$开始，通过最小化带有对非截距项系数施加的强度为$\\lambda$的$\\ell_2$惩罚的负对数似然，推导出$\\mathbf{w}$的估计量。使用$\\lambda = 1.0$。\n- 在标准化的特征空间上，通过Newton–Raphson方法实现最小化，使用一个不被惩罚的截距项。在计算对数似然时，通过将概率值限制在远离$0$和$1$的范围内来确保数值稳定性。\n- 拟合后，为新患者计算预测概率$p$。\n\n包含$5$个术前病例的测试集（每个病例表示为$(x_1,x_2,x_3,x_4,x_5,x_6,x_7)$）：\n- 病例 A（典型的病灶一致候选者）：$(1,3,1,1,1,0.4,1.0)$。\n- 病例 B（不一致、弥漫性症状学、高棘波负荷）：$(0,0,0,0,0,2.4,-1.3)$。\n- 病例 C（症状学和脑电图一致、无病灶、中等棘波）：$(1,2,0,0,1,1.6,0.0)$。\n- 病例 D（存在病灶但不一致、脑电图不一致）：$(0,1,1,0,0,1.9,-0.5)$。\n- 病例 E（症状学证据弱、无病灶、低棘波）：$(1,1,0,0,0,0.5,-0.1)$。\n\n你的程序必须：\n- 使用训练集的统计数据（每个特征的均值和标准差）对特征进行标准化，任何为零的标准差都用$1$代替，以避免除以零。\n- 按规定拟合带惩罚项的模型。\n- 为每个测试用例计算$2$年无癫痫发作的预测概率，结果为$(0,1)$内的十进制数，四舍五入到三位小数。\n\n最终输出格式：\n- 生成单行输出，其中包含$5$个四舍五入后的概率值，以逗号分隔并用方括号括起来，例如，$[0.842,0.137,0.511,0.203,0.436]$。", "solution": "所提出的问题是构建一个用于预测癫痫手术后$2$年无癫痫发作情况的多变量预后模型。该模型在广义线性模型（GLM）框架内构建，具体是带有$\\ell_2$（岭）惩罚的逻辑斯谛回归，并使用Newton-Raphson方法估计其参数。该问题具有科学依据、提法明确且客观。它提供了一套完整的数据、模型规格和算法要求，足以得出一个唯一的解。\n\n首先，我将陈述完整的模型规格，然后推导参数估计算法。\n\n**1. 模型规格**\n\n每个患者$i$的结局是一个二元随机变量 $Y_i \\in \\{0, 1\\}$，其中 $Y_i=1$ 表示无癫痫发作。这由伯努利分布建模：\n$$ Y_i \\sim \\text{Bernoulli}(p_i) $$\n其中 $p_i = \\mathbb{P}(Y_i=1 \\mid \\mathbf{x}_i)$ 是在给定术前协变量向量 $\\mathbf{x}_i \\in \\mathbb{R}^7$ 的情况下无癫痫发作的概率。\n\n该模型通过一个线性预测器 $z_i$ 和一个链接函数 $g$ 将概率 $p_i$ 与协变量联系起来。令 $\\tilde{\\mathbf{x}}_i$ 为协变量向量 $\\mathbf{x}_i$ 在前面增加一个$1$以容纳截距项后得到的向量，即 $\\tilde{\\mathbf{x}}_i = [1, x_{i1}, \\dots, x_{i7}]^\\top$。则线性预测器为：\n$$ z_i = \\mathbf{w}^\\top \\tilde{\\mathbf{x}}_i = w_0 + \\sum_{j=1}^7 w_j x_{ij} $$\n其中 $\\mathbf{w} = [w_0, w_1, \\dots, w_7]^\\top$ 是模型权重的向量。\n\n问题指定了一个严格单调可微的链接函数 $g$，它将 $\\mathbb{R}$ 映射到 $(0,1)$。对于伯努利分布的响应变量，标准且规范的选择是逻辑斯谛（或sigmoid）函数，我将在本次推导中使用它：\n$$ p_i = g(z_i) = \\frac{1}{1 + e^{-z_i}} $$\n该模型被称为逻辑斯谛回归。\n\n**2. 目标函数：带惩罚的负对数似然**\n\n参数 $\\mathbf{w}$ 通过最大化观测数据的对数似然来估计，并附加一个 $\\ell_2$ 惩罚项来正则化模型。对于单个观测 $(y_i, \\mathbf{x}_i)$ 的似然函数是：\n$$ L(\\mathbf{w}; y_i, \\mathbf{x}_i) = p_i^{y_i} (1-p_i)^{1-y_i} $$\n对于包含$N=18$名患者的整个数据集，对数似然是每个样本对数似然的总和：\n$$ \\mathcal{L}(\\mathbf{w}) = \\sum_{i=1}^N \\left[ y_i \\log(p_i) + (1-y_i) \\log(1-p_i) \\right] $$\n利用逻辑斯谛函数的性质 $p_i = \\frac{e^{z_i}}{1+e^{z_i}}$ 和 $1-p_i = \\frac{1}{1+e^{z_i}}$，我们可以将对数似然重写为：\n$$ \\mathcal{L}(\\mathbf{w}) = \\sum_{i=1}^N \\left[ y_i z_i - \\log(1+e^{z_i}) \\right] $$\n我们的任务是最小化带 $\\ell_2$ 惩罚的负对数似然，该惩罚作用于非截距项系数（$w_1, \\dots, w_7$）。给定的正则化参数为 $\\lambda = 1.0$。因此，需要最小化的目标函数 $J(\\mathbf{w})$ 是：\n$$ J(\\mathbf{w}) = -\\mathcal{L}(\\mathbf{w}) + \\frac{\\lambda}{2} \\sum_{j=1}^7 w_j^2 = \\sum_{i=1}^N \\left[ \\log(1+e^{z_i}) - y_i z_i \\right] + \\frac{\\lambda}{2} \\sum_{j=1}^7 w_j^2 $$\n\n**3. 通过Newton-Raphson方法进行优化**\n\nNewton-Raphson方法是一种迭代优化算法，它使用目标函数的一阶和二阶导数。在第 $k+1$ 步的更新规则是：\n$$ \\mathbf{w}^{(k+1)} = \\mathbf{w}^{(k)} - \\left[H\\left(\\mathbf{w}^{(k)}\\right)\\right]^{-1} \\nabla J\\left(\\mathbf{w}^{(k)}\\right) $$\n其中 $\\nabla J$ 是梯度， $H$ 是 $J(\\mathbf{w})$ 的Hessian矩阵。\n\n首先，我们需要 $J(\\mathbf{w})$ 的梯度。关于权重 $w_j$ 的偏导数是：\n$$ \\frac{\\partial J}{\\partial w_j} = \\sum_{i=1}^N \\left( \\frac{\\partial}{\\partial z_i} (\\log(1+e^{z_i}) - y_i z_i) \\cdot \\frac{\\partial z_i}{\\partial w_j} \\right) + \\frac{\\partial}{\\partial w_j} \\left( \\frac{\\lambda}{2} \\sum_{l=1}^7 w_l^2 \\right) $$\n注意到 $\\frac{\\partial z_i}{\\partial w_j} = \\tilde{x}_{ij}$ 且 $\\frac{d}{dz_i} \\log(1+e^{z_i}) = \\frac{e^{z_i}}{1+e^{z_i}} = p_i$，我们得到：\n$$ \\frac{\\partial J}{\\partial w_j} = \\sum_{i=1}^N (p_i - y_i) \\tilde{x}_{ij} + \\lambda w_j \\cdot \\mathbb{I}(j>0) $$\n其中 $\\mathbb{I}(j>0)$ 是一个指示函数，当$j > 0$时为$1$，当$j=0$时为$0$，以确保截距$w_0$不被惩罚。\n\n在矩阵表示法中，令 $\\tilde{X}$ 为 $N \\times (7+1)$ 的设计矩阵（行为 $\\tilde{\\mathbf{x}}_i^\\top$），$\\mathbf{y}$ 为结局向量，$\\mathbf{p}$ 为预测概率向量，$\\mathbf{w}^* = [0, w_1, \\dots, w_7]^\\top$。梯度为：\n$$ \\nabla J(\\mathbf{w}) = \\tilde{X}^\\top (\\mathbf{p} - \\mathbf{y}) + \\lambda \\mathbf{w}^* $$\n\n接下来，我们需要Hessian矩阵 $H$，其元素为 $H_{jk} = \\frac{\\partial^2 J}{\\partial w_j \\partial w_k}$：\n$$ H_{jk} = \\frac{\\partial}{\\partial w_k} \\left( \\sum_{i=1}^N (p_i - y_i) \\tilde{x}_{ij} \\right) + \\lambda \\delta_{jk} \\cdot \\mathbb{I}(j>0) $$\n其中 $\\delta_{jk}$ 是克罗内克δ。第一项的导数是：\n$$ \\sum_{i=1}^N \\frac{\\partial p_i}{\\partial w_k} \\tilde{x}_{ij} = \\sum_{i=1}^N \\left( \\frac{dp_i}{dz_i} \\frac{\\partial z_i}{\\partial w_k} \\right) \\tilde{x}_{ij} $$\n逻辑斯谛函数的导数是 $\\frac{dp_i}{dz_i} = p_i(1-p_i)$。这导出：\n$$ H_{jk} = \\sum_{i=1}^N p_i(1-p_i) \\tilde{x}_{ik} \\tilde{x}_{ij} + \\lambda \\delta_{jk} \\cdot \\mathbb{I}(j>0) $$\n在矩阵表示法中，令 $S$ 为一个 $N \\times N$ 的对角矩阵，其中 $S_{ii} = p_i(1-p_i)$，令 $I^*$ 为 $(7+1) \\times (7+1)$ 的单位矩阵，其左上角元素 $I^*_{00}$ 设置为$0$。Hessian矩阵是：\n$$ H(\\mathbf{w}) = \\tilde{X}^\\top S \\tilde{X} + \\lambda I^* $$\n\n因此，在第 $k$ 次迭代中的Newton-Raphson更新为：\n$$ \\mathbf{w}^{(k+1)} = \\mathbf{w}^{(k)} - \\left(\\tilde{X}^\\top S^{(k)} \\tilde{X} + \\lambda I^*\\right)^{-1} \\left(\\tilde{X}^\\top (\\mathbf{p}^{(k)} - \\mathbf{y}) + \\lambda \\mathbf{w}^{*(k)}\\right) $$\n这是迭代重加权最小二乘（IRLS）算法的一个实例。\n\n**4. 算法实现步骤**\n\n1.  **数据准备**：将$N=18$个患者记录加载到特征矩阵 $X_{train}$（$18 \\times 7$）和结局向量 $\\mathbf{y}$（$18 \\times 1$）中。\n2.  **标准化**：计算训练数据中$7$个特征的均值向量 $\\boldsymbol{\\mu}$ 和标准差向量 $\\boldsymbol{\\sigma}$。对于任何 $\\sigma_j = 0$ 的特征，用 $\\sigma_j=1.0$ 替换。标准化训练数据：$X_{std} = (X_{train} - \\boldsymbol{\\mu}) / \\boldsymbol{\\sigma}$。\n3.  **设计矩阵**：在 $X_{std}$ 的前面增加一列全为1的列，以形成设计矩阵 $\\tilde{X}$。这是一个 $18 \\times 8$ 的矩阵。\n4.  **初始化**：将权重向量 $\\mathbf{w} = [w_0, w_1, \\dots, w_7]^\\top$ 初始化为全零。设置 $\\lambda=1.0$。\n5.  **迭代拟合**：\n    a. 循环固定的迭代次数（例如，$20$次）或直到收敛。\n    b. 在每次迭代中，计算当前的预测：$z_i = \\mathbf{w}^\\top \\tilde{\\mathbf{x}}_i$，然后 $p_i = 1 / (1 + e^{-z_i})$。将概率值限制在一个小区间 $[\\epsilon, 1-\\epsilon]$（例如，$\\epsilon=10^{-10}$）内以确保数值稳定性。\n    c. 构建对角权重矩阵 $S$，其中 $S_{ii} = p_i(1-p_i)$。\n    d. 构建带惩罚的Hessian矩阵 $H = \\tilde{X}^\\top S \\tilde{X} + \\lambda I^*$。\n    e. 构建带惩罚的梯度 $\\nabla J = \\tilde{X}^\\top (\\mathbf{p} - \\mathbf{y}) + \\lambda \\mathbf{w}^*$。\n    f. 计算更新步长 $\\Delta \\mathbf{w} = -H^{-1} \\nabla J$。\n    g. 更新权重：$\\mathbf{w} \\leftarrow \\mathbf{w} + \\Delta \\mathbf{w}$。\n6.  **对测试用例进行预测**：在最后一次迭代后，获得收敛的向量 $\\mathbf{w}$。对于$5$个测试用例中的每一个：\n    a. 令 $\\mathbf{x}_{test}$ 为一个测试特征向量。\n    b. 使用*训练集*的统计数据对其进行标准化：$\\mathbf{x}_{test,std} = (\\mathbf{x}_{test} - \\boldsymbol{\\mu}) / \\boldsymbol{\\sigma}$。\n    c. 在前面增加一个1，形成 $\\tilde{\\mathbf{x}}_{test,std}$。\n    d. 计算线性预测器 $z_{test} = \\mathbf{w}^\\top \\tilde{\\mathbf{x}}_{test,std}$。\n    e. 计算最终概率 $p_{test} = 1 / (1 + e^{-z_{test}})$。\n    f. 将结果四舍五入到三位小数。\n\n这个过程为给定的测试用例得出了所需的概率。\n```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Constructs and fits a penalized logistic regression model to predict epilepsy surgery outcomes.\n    The model is fitted using the Newton-Raphson method (IRLS) on a standardized feature space.\n    \"\"\"\n\n    # Step 1: Define training and test data\n    train_data = [\n        (1, 3, 1, 1, 1, 0.8, 0.5, 1),\n        (1, 2, 1, 1, 1, 0.6, 0.2, 1),\n        (0, 1, 0, 0, 0, 2.1, -0.8, 0),\n        (1, 3, 0, 0, 1, 1.5, 0.4, 1),\n        (0, 0, 1, 0, 0, 2.8, -1.5, 0),\n        (1, 2, 1, 1, 0, 1.2, 0.0, 1),\n        (1, 1, 0, 0, 1, 0.9, -0.2, 1),\n        (0, 1, 0, 0, 0, 1.8, -0.7, 0),\n        (1, 3, 1, 1, 1, 0.3, 1.2, 1),\n        (0, 0, 0, 0, 0, 2.5, -1.8, 0),\n        (1, 2, 1, 1, 1, 0.5, 0.8, 1),\n        (0, 1, 1, 0, 0, 1.7, -0.9, 0),\n        (1, 3, 1, 1, 0, 0.4, 0.6, 1),\n        (0, 0, 1, 0, 1, 2.0, -1.0, 0),\n        (1, 2, 0, 0, 1, 1.1, 0.3, 1),\n        (0, 1, 0, 0, 1, 2.3, -0.6, 0),\n        (1, 3, 1, 1, 1, 0.7, 1.5, 1),\n        (0, 0, 0, 0, 0, 2.2, -1.2, 0),\n    ]\n\n    test_cases = {\n        'A': (1, 3, 1, 1, 1, 0.4, 1.0),\n        'B': (0, 0, 0, 0, 0, 2.4, -1.3),\n        'C': (1, 2, 0, 0, 1, 1.6, 0.0),\n        'D': (0, 1, 1, 0, 0, 1.9, -0.5),\n        'E': (1, 1, 0, 0, 0, 0.5, -0.1),\n    }\n\n    # Separate features (X) and outcomes (y)\n    train_X = np.array([row[:-1] for row in train_data])\n    train_y = np.array([row[-1] for row in train_data])\n\n    # Step 2: Standardize features using training data stats\n    mean = np.mean(train_X, axis=0)\n    std = np.std(train_X, axis=0)\n    # As per problem, replace std=0 with 1\n    std[std == 0] = 1.0\n\n    X_std = (train_X - mean) / std\n\n    # Step 3: Augment design matrix with intercept term\n    intercept = np.ones((X_std.shape[0], 1))\n    X_tilde = np.hstack((intercept, X_std))\n    \n    # Model parameters\n    lambda_val = 1.0\n    num_features = X_tilde.shape[1]\n    w = np.zeros(num_features)\n    num_iterations = 20\n    epsilon = 1e-10\n\n    # Create penalty matrix I* (identity with I*[0,0]=0)\n    I_star = np.identity(num_features)\n    I_star[0, 0] = 0.0\n    \n    # Step 4: Fit the model using Newton-Raphson (IRLS)\n    for i in range(num_iterations):\n        # Linear predictor\n        z = X_tilde @ w\n        \n        # Predicted probabilities (clamped for stability)\n        p = 1.0 / (1.0 + np.exp(-z))\n        p = np.clip(p, epsilon, 1 - epsilon)\n\n        # Diagonal matrix S for Hessian\n        s_diag = p * (1 - p)\n        S = np.diag(s_diag)\n\n        # Gradient of penalized negative log-likelihood\n        w_star = w.copy()\n        w_star[0] = 0.0\n        gradient = X_tilde.T @ (p - train_y) + lambda_val * w_star\n\n        # Hessian of penalized negative log-likelihood\n        hessian = X_tilde.T @ S @ X_tilde + lambda_val * I_star\n\n        # Newton-Raphson update step\n        update_step = -np.linalg.inv(hessian) @ gradient\n        w += update_step\n\n        # Convergence check (optional but good practice)\n        if np.linalg.norm(update_step)  1e-6:\n            break\n\n    # Step 5: Predict probabilities for test cases\n    results = []\n    case_order = ['A', 'B', 'C', 'D', 'E']\n    for case_id in case_order:\n        x_test = np.array(test_cases[case_id])\n        \n        # Standardize using training set statistics\n        x_test_std = (x_test - mean) / std\n        \n        # Augment with intercept\n        x_test_tilde = np.hstack(([1.0], x_test_std))\n        \n        # Calculate prediction\n        z_test = x_test_tilde @ w\n        p_test = 1.0 / (1.0 + np.exp(-z_test))\n        \n        # Round and store\n        results.append(round(p_test, 3))\n\n    # This part is just for local execution and is not part of the final XML content\n    # print(f\"[{','.join(map(str, results))}]\")\n\n# To get the result, one would call solve()\n# The result of running this code is [0.966, 0.019, 0.722, 0.081, 0.366]\n```", "answer": "[0.966,0.019,0.722,0.081,0.366]", "id": "4516266"}]}