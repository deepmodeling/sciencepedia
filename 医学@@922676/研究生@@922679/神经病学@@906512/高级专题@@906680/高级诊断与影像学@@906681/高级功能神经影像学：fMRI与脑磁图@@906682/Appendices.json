{"hands_on_practices": [{"introduction": "功能性磁共振成像（fMRI）实验的核心目标是可靠地检测由神经活动引起的微弱的血氧水平依赖（BOLD）信号。实现这一目标的关键在于最大化“对比度噪声比”（CNR），而不仅仅是原始的“信噪比”（SNR）。本练习将通过数学推导来探索这一权衡，展示一个简单的数学模型如何指导实验设计中的关键参数选择，例如回波时间（$TE$），从而巩固你对梯度回波序列中BOLD信号物理基础的理解。[@problem_id:4445739]", "problem": "一个神经学研究团队正在设计一种在 $B_0 = 3\\,\\mathrm{T}$ 静磁场下使用回波平面成像 (EPI) 的梯度回波功能性磁共振成像 (fMRI) 采集方案。对于皮层灰质，他们预计包含静态失相的横向弛豫时间 $T_2^*$ 约为 $30\\,\\mathrm{ms}$。血氧水平依赖 (BOLD) 对比度源于脱氧血红蛋白变化引起的局部磁化率微小变化，这些变化调节了有效横向弛豫率 $R_2^*$，其中 $R_2^* = 1/T_2^*$。假设梯度回波信号幅度随回波时间 $TE$ 呈单指数衰减，公式为 $S(TE) = S_0 \\exp(-TE/T_2^*) = S_0 \\exp(-TE\\,R_2^*)$，并且图像的主要噪声近似为热噪声且与 $TE$ 无关。使用第一性原理和针对 BOLD 引起的 $R_2^*$ 变化的小扰动近似，推导出用于检测微小 BOLD 效应的、可最大化对比度噪声比 (CNR) 的回波时间 $TE$。然后，在给定 $T_2^* = 30\\,\\mathrm{ms}$ 的情况下计算其数值。最后，简要讨论在 $B_0 = 3\\,\\mathrm{T}$ 条件下，选择此 $TE$ 在信噪比 (SNR) 和磁化率相关失真方面的权衡，并以梯度回波 EPI 的物理机制为基础进行讨论。以 $\\mathrm{ms}$ 为单位表示最佳 $TE$，并将您的数值答案四舍五入到三位有效数字。", "solution": "该问题要求推导在梯度回波功能性磁共振成像中，对于微小的血氧水平依赖 (BOLD) 效应，能够最大化对比度噪声比 (CNR) 的最佳回波时间 ($TE$)，然后进行数值计算并讨论相关的权衡。\n\n首先，我们必须规范 CNR 的定义。CNR 是两种状态（例如，神经元活动与静息）之间信号差异的绝对值除以图像噪声的标准差 $\\sigma_{noise}$。\n$$\nCNR = \\frac{|\\Delta S|}{\\sigma_{noise}}\n$$\n我们将静息态设为基线条件，将活动态设为目标条件。BOLD 效应表现为有效横向弛豫率 $R_2^* = 1/T_2^*$ 的变化。具体来说，神经元活动导致局部脱氧血红蛋白浓度降低，这使得局部磁场更加均匀。这会增加 $T_2^*$，从而降低 $R_2^*$。\n\n设 $R_{2,rest}^*$ 为静息态的弛豫率，$R_{2,act}^*$ 为活动态的弛豫率。变化量为 $\\Delta R_2^* = R_{2,act}^* - R_{2,rest}^*$。根据其生理学基础，$\\Delta R_2^*$ 是一个很小的负值。为简化符号，我们将 $R_{2,rest}^*$ 表示为 $R_2^*$。信号幅度作为回波时间 $TE$ 的函数由 $S(TE) = S_0 \\exp(-TE \\cdot R_2^*)$ 给出，其中 $S_0$ 包含了质子密度和 $T_1$ 弛豫效应，在本分析中假定为常数。\n\n静息态的信号为：\n$$\nS_{rest}(TE) = S_0 \\exp(-TE \\cdot R_2^*)\n$$\n活动态的信号为：\n$$\nS_{act}(TE) = S_0 \\exp(-TE \\cdot (R_2^* + \\Delta R_2^*))\n$$\n信号变化 $\\Delta S$ 则为：\n$$\n\\Delta S = S_{act} - S_{rest} = S_0 \\left[ \\exp(-TE \\cdot (R_2^* + \\Delta R_2^*)) - \\exp(-TE \\cdot R_2^*) \\right]\n$$\n提出公因式 $\\exp(-TE \\cdot R_2^*)$：\n$$\n\\Delta S = S_0 \\exp(-TE \\cdot R_2^*) \\left[ \\exp(-TE \\cdot \\Delta R_2^*) - 1 \\right]\n$$\n问题指明对 BOLD 引起的变化使用小扰动近似。这意味着 BOLD 效应很小，所以 $|\\Delta R_2^*|$ 很小，因此指数 $|-TE \\cdot \\Delta R_2^*|$ 也很小。因此，我们可以对指数函数使用一阶泰勒展开，即当 $x$ 很小时，$\\exp(x) \\approx 1 + x$。\n令 $x = -TE \\cdot \\Delta R_2^*$，我们得到：\n$$\n\\exp(-TE \\cdot \\Delta R_2^*) \\approx 1 - TE \\cdot \\Delta R_2^*\n$$\n将此近似代入 $\\Delta S$ 的表达式中：\n$$\n\\Delta S \\approx S_0 \\exp(-TE \\cdot R_2^*) \\left[ (1 - TE \\cdot \\Delta R_2^*) - 1 \\right] = -S_0 \\cdot \\Delta R_2^* \\cdot TE \\cdot \\exp(-TE \\cdot R_2^*)\n$$\n由于 $\\Delta R_2^*$ 是负值，$\\Delta S$ 是正值，这与 BOLD 信号增加的预期相符。信号变化的幅度为：\n$$\n|\\Delta S| \\approx S_0 |\\Delta R_2^*| \\cdot TE \\cdot \\exp(-TE \\cdot R_2^*)\n$$\n问题陈述了图像的主要噪声是热噪声且与 $TE$ 无关。因此，$\\sigma_{noise}$ 是一个常数。关于 $TE$ 最大化 $CNR = |\\Delta S|/\\sigma_{noise}$ 等价于最大化 $|\\Delta S|$。项 $S_0$ 和 $|\\Delta R_2^*|$ 相对于 $TE$ 是常数，所以我们需要找到函数 $f(TE) = TE \\cdot \\exp(-TE \\cdot R_2^*)$ 的最大值。\n\n为了找到最大值，我们计算 $f(TE)$ 关于 $TE$ 的一阶导数并将其设为零。使用微分的乘积法则 $(uv)' = u'v + uv'$，其中 $u=TE$，$v=\\exp(-TE \\cdot R_2^*)$：\n$$\n\\frac{df}{d(TE)} = \\frac{d}{d(TE)} \\left( TE \\cdot \\exp(-TE \\cdot R_2^*) \\right)\n$$\n$$\n\\frac{df}{d(TE)} = (1) \\cdot \\exp(-TE \\cdot R_2^*) + TE \\cdot (-R_2^* \\cdot \\exp(-TE \\cdot R_2^*))\n$$\n$$\n\\frac{df}{d(TE)} = \\exp(-TE \\cdot R_2^*) (1 - TE \\cdot R_2^*)\n$$\n将导数设为零以找到临界点：\n$$\n\\exp(-TE \\cdot R_2^*) (1 - TE \\cdot R_2^*) = 0\n$$\n由于对于任何有限的 $TE$，$\\exp(-TE \\cdot R_2^*) > 0$，因此该表达式仅在以下情况下为零：\n$$\n1 - TE \\cdot R_2^* = 0\n$$\n求解 $TE$，我们找到最佳回波时间 $TE_{opt}$：\n$$\nTE_{opt} = \\frac{1}{R_2^*}\n$$\n根据定义 $R_2^* = 1/T_2^*$，我们可以将其代入我们的结果：\n$$\nTE_{opt} = \\frac{1}{1/T_2^*} = T_2^*\n$$\n因此，最大化 BOLD CNR 的回波时间等于组织的基线 $T_2^*$。为了确认这是一个最大值，我们可以检查二阶导数，但这是一个众所周知的结果，即这是一个最大值。\n\n接下来，我们计算数值。问题给出 $T_2^* = 30\\,\\mathrm{ms}$。因此，最佳回波时间是：\n$$\nTE_{opt} = 30\\,\\mathrm{ms}\n$$\n四舍五入到三位有效数字得到 $30.0\\,\\mathrm{ms}$。\n\n最后，我们讨论选择 $TE = T_2^*$ 的权衡。\n\n1.  **信噪比 (SNR):** 对于给定的体素信号 $S$，其信噪比为 $SNR = S/\\sigma_{noise}$。由于假定噪声 $\\sigma_{noise}$ 是恒定的，SNR 与信号本身成正比：$S(TE) = S_0 \\exp(-TE/T_2^*)$。这是一个关于 $TE$ 的单调递减函数。因此，为了最大化 SNR，应该选择尽可能短的 $TE$。通过选择 $TE = T_2^* = 30\\,\\mathrm{ms}$，信号已衰减至 $S(T_2^*) = S_0 \\exp(-1) \\approx 0.37 S_0$。与使用非常短的 $TE$ 所能达到的信号相比，这是一个显著的信号降低。这说明了在最大化功能激活的 CNR（对变化的敏感性）和最大化图像本身的原始 SNR 之间存在根本性的权衡。\n\n2.  **磁化率相关的失真:** 问题指明在 $B_0 = 3\\,\\mathrm{T}$ 的场强下使用梯度回波平面成像 (GE-EPI)。GE-EPI 对磁场不均匀性高度敏感，这种不均匀性源于磁化率的变化，尤其是在空气-组织交界处（例如，鼻窦和耳道附近）。这些磁场不均匀性会导致离共振效应，从而产生两种主要伪影：信号丢失（由于体素内失相）和几何失真（相位编码方向上的像素位移）。这些效应的严重程度与回波时间 $TE$ 成正比，因为更长的 $TE$ 允许更多的离共振相位累积。这些效应也随主磁场强度 $B_0$ 的增加而增强，使其在 $3\\,\\mathrm{T}$ 场强下成为一个突出问题。选择 $30\\,\\mathrm{ms}$ 的 $TE$ 是一个中等长度的回波时间，虽然对于灰质中的 BOLD 对比度是最佳的，但这将不可避免地导致大脑区域（如眶额皮层和内侧颞叶）出现显著的信号损失和失真。较短的 $TE$ 会减轻这些伪影，但代价是牺牲最佳的 BOLD 敏感性 (CNR)。因此，这一选择代表了功能敏感性与图像保真度之间的折衷。", "answer": "$$\\boxed{30.0}$$", "id": "4445739"}, {"introduction": "在获得fMRI数据后，我们通常使用通用线性模型（GLM）来检验有关大脑活动的假设。然而，我们关心的问题常常超越了简单的“激活与基线”对比。本练习介绍了参数调制器，这是一种强大的GLM技术，用于检验大脑活动是否随某个实验变量（如刺激强度）线性或非线性地变化，并让你亲手实践回归量正交化的关键步骤，这对于解释相关模型分量的独特贡献至关重要。通过这项动手计算，你将学习如何构建一个能够检验更精细假设的设计矩阵，从而能够就大脑如何处理信息提出更深刻的问题。[@problem_id:4445759]", "problem": "一个单一条件的事件相关功能性磁共振成像 (fMRI) 实验使用带有参数调制器的通用线性模型 (GLM) 进行建模，以检验单调的刺激-反应关系。该条件在 $t=0,1,2,\\dots,8\\,\\mathrm{s}$ 的离散采样网格上，于时间点 $t \\in \\{1,4,6\\}$ 秒有事件，重复时间 $TR = 1\\,\\mathrm{s}$。对于每个事件，根据事件顺序从一个严格单调的强度分数 $I \\in \\{1,2,3\\}$ 定义了两个参数调制器：一个线性调制器 $m_{1} = I$ 和一个二次调制器 $m_{2} = I^{2}$。在构建回归量之前，两个调制器都在该条件内进行了均值中心化。回归量的构建方法是：在事件发生时放置特定条件的脉冲（stick），其幅度等于中心化后的调制器值，然后将这些脉冲与血流动力学响应函数 (HRF) 的有限脉冲响应近似进行卷积。HRF在同一个离산网格上定义为 $h[0]=0$、 $h[1]=1$、 $h[2]=\\tfrac{1}{2}$，对于所有其他整数延迟 $\\ell$， $h[\\ell]=0$。卷积是离散时间、因果且时不变的。\n\n仅使用基本定义（离散时间卷积、内积和Gram–Schmidt正交化），执行以下操作：\n\n- 通过将两个参数调制器各自中心化后的脉冲函数与HRF $h$ 在 $t=0,1,2,\\dots,8$ 网格上进行卷积，构建两个回归量 $r_{1}$ (来自 $m_{1}$) 和 $r_{2}$ (来自 $m_{2}$)。\n- 为了获得一个用于推断的、与第一个回归量不相关的序列正交化的第二个调制器（首先检验单调线性效应），定义 $r_{2}' = r_{2} - \\alpha\\, r_{1}$，其中 $r_{2}'$ 在设计空间上的欧几里得内积中被约束为与 $r_{1}$ 正交。\n\n从第一性原理出发，推导使 $r_{2}' \\perp r_{1}$ 成立的精确标量投影系数 $\\alpha$。给出你的最终答案，形式为一个精确的实数。无需四舍五入，也无需报告单位。", "solution": "用户提供了一个有效的问题陈述。该问题在科学上基于使用通用线性模型（GLM）进行fMRI数据分析的原理，在数学上是适定的，并且提供了所有必要的信息。\n\n目标是找到标量投影系数 $\\alpha$，使得回归量 $r_{2}'$ 与回归量 $r_{1}$ 正交，其中 $r_{2}' = r_{2} - \\alpha r_{1}$。在欧几里得内积空间中，正交的条件是它们的内积（点积）为零：$\\langle r_{2}', r_{1} \\rangle = 0$。\n\n根据 $r_{2}'$ 的定义和内积的性质：\n$$\n\\langle r_{2} - \\alpha r_{1}, r_{1} \\rangle = 0\n$$\n$$\n\\langle r_{2}, r_{1} \\rangle - \\langle \\alpha r_{1}, r_{1} \\rangle = 0\n$$\n$$\n\\langle r_{2}, r_{1} \\rangle - \\alpha \\langle r_{1}, r_{1} \\rangle = 0\n$$\n解出 $\\alpha$，我们得到 $r_{2}$ 在 $r_{1}$ 上的标量投影公式：\n$$\n\\alpha = \\frac{\\langle r_{2}, r_{1} \\rangle}{\\langle r_{1}, r_{1} \\rangle} = \\frac{r_{2} \\cdot r_{1}}{r_{1} \\cdot r_{1}}\n$$\n要计算 $\\alpha$，我们必须首先构建回归量 $r_{1}$ 和 $r_{2}$。\n\n**步骤1：定义参数调制器值并对其进行均值中心化**\n事件按顺序在时间点 $t \\in \\{1, 4, 6\\}$ 发生，对应的刺激强度分数为 $I \\in \\{1, 2, 3\\}$。\n\n对于线性调制器 $m_{1} = I$：\n值为 $\\{1, 2, 3\\}$。均值为 $\\bar{m}_{1} = \\frac{1+2+3}{3} = \\frac{6}{3} = 2$。\n中心化后的线性调制器值 $c_{1}$ 为：\n$c_{1}(1) = 1 - 2 = -1$\n$c_{1}(2) = 2 - 2 = 0$\n$c_{1}(3) = 3 - 2 = 1$\n所以，中心化后的值的集合是 $\\{-1, 0, 1\\}$。\n\n对于二次调制器 $m_{2} = I^{2}$：\n值为 $\\{1^{2}, 2^{2}, 3^{2}\\} = \\{1, 4, 9\\}$。均值为 $\\bar{m}_{2} = \\frac{1+4+9}{3} = \\frac{14}{3}$。\n中心化后的二次调制器值 $c_{2}$ 为：\n$c_{2}(1) = 1 - \\frac{14}{3} = \\frac{3}{3} - \\frac{14}{3} = -\\frac{11}{3}$\n$c_{2}(2) = 4 - \\frac{14}{3} = \\frac{12}{3} - \\frac{14}{3} = -\\frac{2}{3}$\n$c_{2}(3) = 9 - \\frac{14}{3} = \\frac{27}{3} - \\frac{14}{3} = \\frac{13}{3}$\n所以，中心化后的值的集合是 $\\{-\\frac{11}{3}, -\\frac{2}{3}, \\frac{13}{3}\\}$。\n\n**步骤2：构建脉冲函数**\n脉冲函数 $s_{1}[t]$ 和 $s_{2}[t]$ 定义在时间网格 $t=0, 1, \\dots, 8$ 上。它们由在事件起始点（$t \\in \\{1, 4, 6\\}$）的脉冲组成，其高度等于相应的中心化调制器值。\n\n对于 $r_{1}$，脉冲函数 $s_{1}[t]$ 为：\n$s_{1}[1] = -1$\n$s_{1}[4] = 0$\n$s_{1}[6] = 1$\n$s_{1}[t] = 0$ 对于所有其他 $t$。\n作为在 $t=0, \\dots, 8$ 上的向量： $s_{1} = (0, -1, 0, 0, 0, 0, 1, 0, 0)$。\n\n对于 $r_{2}$，脉冲函数 $s_{2}[t]$ 为：\n$s_{2}[1] = -\\frac{11}{3}$\n$s_{2}[4] = -\\frac{2}{3}$\n$s_{2}[6] = \\frac{13}{3}$\n$s_{2}[t] = 0$ 对于所有其他 $t$。\n作为向量： $s_{2} = (0, -\\frac{11}{3}, 0, 0, -\\frac{2}{3}, 0, \\frac{13}{3}, 0, 0)$。\n\n**步骤3：通过卷积构建回归量**\n回归量由离散卷积 $r[t] = (s * h)[t] = \\sum_{k} s[k]h[t-k]$ 形成。\n给定的HRF是 $h[t]$，其中 $h[1]=1$，$h[2]=\\frac{1}{2}$，其他情况下 $h[t]=0$。\n对于一个在时间 $\\tau$ 幅度为 $A$ 的单一脉冲，其卷积运算为 $A \\cdot h[t-\\tau]$。\n\n为了构建 $r_{1}$：\n$r_{1}[t] = s_{1}[1]h[t-1] + s_{1}[4]h[t-4] + s_{1}[6]h[t-6]$\n$r_{1}[t] = (-1)h[t-1] + (0)h[t-4] + (1)h[t-6]$\n项 $(-1)h[t-1]$ 在 $t=1+1=2$ 时产生值 $-1$，在 $t=1+2=3$ 时产生值 $-\\frac{1}{2}$。\n项 $(1)h[t-6]$ 在 $t=6+1=7$ 时产生值 $1$，在 $t=6+2=8$ 时产生值 $\\frac{1}{2}$。\n将这些贡献相加，在 $t = 0, \\dots, 8$ 上的回归量向量 $r_{1}$ 为：\n$$\nr_{1} = \\left(0, 0, -1, -\\frac{1}{2}, 0, 0, 0, 1, \\frac{1}{2}\\right)\n$$\n\n为了构建 $r_{2}$：\n$r_{2}[t] = s_{2}[1]h[t-1] + s_{2}[4]h[t-4] + s_{2}[6]h[t-6]$\n项 $s_{2}[1]h[t-1] = -\\frac{11}{3}h[t-1]$ 在 $t=2$ 时产生值 $-\\frac{11}{3}$，在 $t=3$ 时产生值 $-\\frac{11}{3} \\cdot \\frac{1}{2} = -\\frac{11}{6}$。\n项 $s_{2}[4]h[t-4] = -\\frac{2}{3}h[t-4]$ 在 $t=4+1=5$ 时产生值 $-\\frac{2}{3}$，在 $t=4+2=6$ 时产生值 $-\\frac{2}{3} \\cdot \\frac{1}{2} = -\\frac{1}{3}$。\n项 $s_{2}[6]h[t-6] = \\frac{13}{3}h[t-6]$ 在 $t=6+1=7$ 时产生值 $\\frac{13}{3}$，在 $t=6+2=8$ 时产生值 $\\frac{13}{3} \\cdot \\frac{1}{2} = \\frac{13}{6}$。\n将这些贡献相加，在 $t = 0, \\dots, 8$ 上的回归量向量 $r_{2}$ 为：\n$$\nr_{2} = \\left(0, 0, -\\frac{11}{3}, -\\frac{11}{6}, 0, -\\frac{2}{3}, -\\frac{1}{3}, \\frac{13}{3}, \\frac{13}{6}\\right)\n$$\n\n**步骤4：计算内积和 $\\alpha$**\n现在我们计算所需的内积（点积）。\n\n首先，$\\langle r_{1}, r_{1} \\rangle = r_{1} \\cdot r_{1}$：\n$$\n\\langle r_{1}, r_{1} \\rangle = (0)^{2} + (0)^{2} + (-1)^{2} + \\left(-\\frac{1}{2}\\right)^{2} + (0)^{2} + (0)^{2} + (0)^{2} + (1)^{2} + \\left(\\frac{1}{2}\\right)^{2}\n$$\n$$\n\\langle r_{1}, r_{1} \\rangle = 1 + \\frac{1}{4} + 1 + \\frac{1}{4} = 2 + \\frac{2}{4} = 2 + \\frac{1}{2} = \\frac{5}{2}\n$$\n\n其次，$\\langle r_{2}, r_{1} \\rangle = r_{2} \\cdot r_{1}$：\n我们将 $r_{1}$ 和 $r_{2}$ 的相应非零分量相乘。\n$$\n\\langle r_{2}, r_{1} \\rangle = r_{2}[2]r_{1}[2] + r_{2}[3]r_{1}[3] + r_{2}[7]r_{1}[7] + r_{2}[8]r_{1}[8]\n$$\n$$\n\\langle r_{2}, r_{1} \\rangle = \\left(-\\frac{11}{3}\\right)(-1) + \\left(-\\frac{11}{6}\\right)\\left(-\\frac{1}{2}\\right) + \\left(\\frac{13}{3}\\right)(1) + \\left(\\frac{13}{6}\\right)\\left(\\frac{1}{2}\\right)\n$$\n$$\n\\langle r_{2}, r_{1} \\rangle = \\frac{11}{3} + \\frac{11}{12} + \\frac{13}{3} + \\frac{13}{12}\n$$\n将具有相同分母的项组合在一起：\n$$\n\\langle r_{2}, r_{1} \\rangle = \\left(\\frac{11}{3} + \\frac{13}{3}\\right) + \\left(\\frac{11}{12} + \\frac{13}{12}\\right) = \\frac{24}{3} + \\frac{24}{12} = 8 + 2 = 10\n$$\n\n最后，我们计算 $\\alpha$：\n$$\n\\alpha = \\frac{\\langle r_{2}, r_{1} \\rangle}{\\langle r_{1}, r_{1} \\rangle} = \\frac{10}{\\frac{5}{2}} = 10 \\cdot \\frac{2}{5} = \\frac{20}{5} = 4\n$$\n精确的标量投影系数为 $4$。", "answer": "$$\n\\boxed{4}\n$$", "id": "4445759"}, {"introduction": "全脑分析中的一个主要挑战是海量的多重比较问题，若不加以校正，将导致大量的假阳性结果。本练习将指导你实现一个强大的解决方案：非参数置换检验。通过利用数据自身的对称性假设来构建一个精确的零分布，该方法能够在比参数方法更少的假设下，对族系误差率（FWER）进行严格控制。从零开始编写置換检验的代码将揭开这种高级统计技术的神秘面纱，使你对如何在神经影像学的高维数据中进行稳健的统计推断获得深刻的实践理解。[@problem_id:4445740]", "problem": "您将获得来自功能性磁共振成像 (fMRI) 和脑磁图 (MEG) 任务的配对、被试内测量数据，这些数据被抽象为按特征区分的条件差异。对于每个被试，特征差异代表了两种条件（例如，任务和基线）之间的被试内对比，这些差异被排列在一个矩阵中，其中行代表被试，列代表特征。您必须为被试内对比构建一个基于符号翻转的非参数置换检验，并计算跨特征的最大绝对检验统计量的分布，以通过 Westfall–Young 方法实现族系误差率 (FWER) 控制。然后，对于每个测试用例，确定在指定的显著性水平下，通过 FWER 控制有多少特征是显著的。\n\n请使用以下基本原理：\n\n- 在没有条件效应的原假设下，被试内的条件差异围绕零对称，因此对每个被试的差异进行符号翻转是保持分布不变的。因此，在原假设下，被试间的符号翻转是可交换的。这会产生一个由所有符号组合构建的非参数参考分布。\n- 对于由 $f$ 索引的给定特征，其被试差异为 $d_{1,f}, d_{2,f}, \\dots, d_{n,f}$，样本均值 $\\bar{d}_f$ 和样本标准差 $s_f$ 定义如下：\n  $$\\bar{d}_f = \\frac{1}{n}\\sum_{i=1}^{n} d_{i,f}, \\quad s_f = \\sqrt{\\frac{1}{n-1}\\sum_{i=1}^{n}\\left(d_{i,f} - \\bar{d}_f\\right)^2}.$$\n- 对于特征 $f$，被试内对比的单样本检验统计量由学生 t 统计量给出，\n  $$t_f = \\frac{\\bar{d}_f}{s_f / \\sqrt{n}},$$\n  它评估均值差异是否偏离零，仅假设原假设能导出置换有效性所需的对称性和可交换性。\n- 通过对每个符号翻转模式 $p \\in \\{-1,+1\\}^n$ 计算置换后的差异 $p_i d_{i,f}$、相应的各特征统计量 $t_f^{(p)}$ 以及最大绝对统计量，可以获得用于控制 $m$ 个特征多重比较的非参数分布\n  $$T_{\\max}^{(p)} = \\max_{1 \\le f \\le m} \\left|t_f^{(p)}\\right|.$$\n- 假设有 $R$ 次符号翻转置换。在显著性水平 $\\alpha$ 下，FWER 临界阈值 $c_\\alpha$ 是通过从 $\\{T_{\\max}^{(p)}\\}_{p=1}^{R}$ 的经验分布中选择 $(1-\\alpha)$ 分位数得到的，该分位数使用控制族系误差率的顺序统计量。如果 $\\left|t_f\\right| \\ge c_\\alpha$，则特征 $f$ 被宣告为显著。\n\n您的任务是实现上述非参数过程，并将其应用于下面的测试套件。对于每个测试用例，使用通过最大绝对统计量的双边准则，计算在指定 $\\alpha$ 水平下显著特征的数量。请精确地枚举所有符号翻转置换；不要进行子抽样。\n\n答案格式要求：\n- 程序必须生成单行输出，其中包含所有测试用例的结果，结果为逗号分隔的列表，并用方括号括起来。\n- 每个测试用例的结果必须是该用例显著特征数量的整数值。\n\n测试套件：\n- 案例 $1$：$n=4$, $m=3$, $\\alpha = 0.05$，各特征的被试差异如下：\n  - 特征 $1$：$(0.8, 0.6, 0.7, 0.9)$\n  - 特征 $2$：$(0.2, -0.1, 0.0, 0.3)$\n  - 特征 $3$：$(1.2, 1.0, 1.1, 0.9)$\n- 案例 $2$：$n=5$, $m=2$, $\\alpha = 0.05$，差异如下：\n  - 特征 $1$：$(0.05, -0.02, 0.01, -0.03, 0.00)$\n  - 特征 $2$：$(0.4, 0.45, 0.35, 0.5, 0.38)$\n- 案例 $3$：$n=6$, $m=1$, $\\alpha = 0.05$，差异如下：\n  - 特征 $1$：$(-0.5, -0.6, -0.4, -0.55, -0.45, -0.5)$\n- 案例 $4$：$n=3$, $m=4$, $\\alpha = 0.05$，差异如下：\n  - 特征 $1$：$(1.0, 0.0, -1.0)$\n  - 特征 $2$：$(0.5, -0.5, 0.0)$\n  - 特征 $3$：$(0.2, -0.2, 0.0)$\n  - 特征 $4$：$(0.3, -0.3, 0.0)$\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，$[r_1,r_2,r_3,r_4]$），其中每个 $r_k$ 是使用所述的非参数最大统计量 FWER 过程计算出的案例 $k$ 的显著特征数量的整数值。", "solution": "该问题要求实现一个非参数置换检验，以从配对的被试内 fMRI 和 MEG 数据中识别显著特征，同时控制族系误差率 (FWER)。所提供的方法论基于符号翻转和最大统计量方法，该方法通常与 Westfall-Young 过程相关联。该问题在科学上是合理的，阐述清晰，并为确定性解决方案提供了所有必要信息。\n\n核心原则和算法步骤如下：\n\n首先，我们为置换检验建立理论基础。该问题涉及被试内对比，表示为每个被试 $i \\in \\{1, \\dots, n\\}$ 和特征 $f \\in \\{1, \\dots, m\\}$ 的差异 $d_{i,f}$。原假设 $H_0$ 假定配对条件之间没有真实差异。在 $H_0$ 下，假设每个差异 $d_{i,f}$ 都来自一个关于 $0$ 对称的分布。这种对称性的一个直接后果是，每个被试在所有特征上的差异向量的符号是任意的；也就是说，翻转任何被试测量值的符号都不会改变数据的统计分布。此属性称为符号翻转可交换性。它允许我们通过考虑应用于被试数据的所有 $2^n$ 种可能的符号翻转组合来生成一个参考分布。\n\n其次，我们定义一个合适的检验统计量来量化每个特征反对原假设的证据。为此，我们选择单样本学生 t 统计量。对于每个特征 $f$，其计算方式如下：\n$$t_f = \\frac{\\bar{d}_f}{s_f / \\sqrt{n}}$$\n其中 $\\bar{d}_f$ 是特征 $f$ 在 $n$ 个被试中的差异样本均值，而 $s_f$ 是相应的样本标准差，定义为 $s_f = \\sqrt{\\frac{1}{n-1}\\sum_{i=1}^{n}\\left(d_{i,f} - \\bar{d}_f\\right)^2}$。该统计量以其标准误为单位来衡量均值差异，提供了一个标准化的效应大小度量。$t_f$ 的较大绝对值表明均值差异不太可能为零。\n\n第三，我们解决多重比较问题。当同时检验 $m$ 个特征时，至少出现一个假阳性发现（I 类错误）的概率会膨胀。为了应对这种情况，我们控制 FWER，即在所有 $m$ 个检验中犯一个或多个 I 类错误的概率。指定的方法通过为*最大绝对检验统计量*构建一个零分布来实现这一点。对于由 $p$ 索引的 $R=2^n$ 个符号翻转置换中的每一个，我们为每个特征重新计算 t 统计量，记为 $t_f^{(p)}$。然后，对于每次置换，我们找出所有特征中的最大绝对值：\n$$T_{\\max}^{(p)} = \\max_{1 \\le f \\le m} \\left|t_f^{(p)}\\right|$$\n这些 $R$ 个值的集合 $\\{T_{\\max}^{(p)}\\}_{p=1}^{R}$ 构成了经验零分布。该分布代表了在原假设下，人们期望在所有特征中观察到的最极端 t 统计量的范围。\n\n最后，我们推导出一个决策规则。FWER 为 $\\alpha$ 的临界阈值 $c_\\alpha$ 是根据最大统计量的零分布确定的。具体来说，$c_\\alpha$ 是 $\\{T_{\\max}^{(p)}\\}$ 排序后分布的 $(1-\\alpha)$ 分位数。设排序后的值为 $T_{(1)} \\le T_{(2)} \\le \\dots \\le T_{(R)}$。临界值 $c_\\alpha$ 被选为第 $k$ 个顺序统计量 $T_{(k)}$，其中 $k = \\lceil R(1-\\alpha) \\rceil$。这种保守的选择确保了在原假设下，最大统计量超过 $c_\\alpha$ 的概率不大于 $\\alpha$。如果一个特征 $f$ 的原始观测绝对 t 统计量 $|t_f|$ 达到或超过这个严格的阈值，即 $|t_f| \\ge c_\\alpha$，则该特征被宣告为统计显著。\n\n每个测试用例要实现的算法过程是：\n1.  对于给定的具有 $n$ 个被试和 $m$ 个特征的差异数据矩阵 $D$，计算每个特征 $f=1, \\dots, m$ 的观测 t 统计量 $t_f$。\n2.  生成所有 $R=2^n$ 个唯一的符号翻转向量 $p \\in \\{-1, +1\\}^n$。\n3.  初始化一个空列表以存储最大统计量的分布。\n4.  对于每个符号翻转向量 $p$：\n    a. 将符号翻转应用于数据矩阵 $D$，以获得置换后的数据矩阵 $D^{(p)}$，其中 $D_{i,f}^{(p)} = p_i d_{i,f}$。\n    b. 基于 $D^{(p)}$ 计算每个特征的 t 统计量 $t_f^{(p)}$。需要特别注意标准差为零的情况，在这种情况下 t 统计量定义为 $0$。\n    c. 确定此次置换的最大绝对统计量 $T_{\\max}^{(p)} = \\max_f |t_f^{(p)}|$，并将其添加到列表中。\n5.  将 $R$ 个最大统计量的列表按升序排序。\n6.  在已排序的、0 索引的列表中，将索引为 $\\lceil R(1-\\alpha)\\rceil - 1$ 的值计算为临界值 $c_\\alpha$。\n7.  将每个原始观测 t 统计量的绝对值 $|t_f|$ 与 $c_\\alpha$ 进行比较。\n8.  测试用例的最终结果是满足 $|t_f| \\ge c_\\alpha$ 的特征数量。\n\n这个完整、精确的置换过程将应用于问题陈述中指定的全部 4 个测试用例。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nimport itertools\n\ndef calculate_significant_features(D, alpha):\n    \"\"\"\n    Performs a nonparametric permutation test with FWER control.\n\n    Args:\n        D (np.ndarray): A 2D numpy array of shape (n_subjects, n_features)\n                        containing the within-subject differences.\n        alpha (float): The desired significance level for FWER control.\n\n    Returns:\n        int: The number of features significant at the specified alpha level.\n    \"\"\"\n    D = np.asarray(D)\n    n, m = D.shape\n    \n    # Define a helper function to compute t-statistics for a data matrix\n    def compute_t_stats(data):\n        n_subjects = data.shape[0]\n        if n_subjects  2:\n            return np.zeros(data.shape[1])\n            \n        means = np.mean(data, axis=0)\n        stds = np.std(data, axis=0, ddof=1)\n        \n        # Denominator of the t-statistic\n        sems = stds / np.sqrt(n_subjects)\n        \n        # Handle division by zero for features with zero variance\n        t_stats = np.divide(means, sems, out=np.zeros_like(means), where=sems != 0)\n        \n        return t_stats\n\n    # 1. Calculate observed t-statistics\n    t_observed = compute_t_stats(D)\n    abs_t_observed = np.abs(t_observed)\n\n    # 2. Generate all 2^n sign-flip permutations\n    R = 2**n\n    sign_flips = list(itertools.product([-1, 1], repeat=n))\n\n    # 3. Build the null distribution of the maximal absolute t-statistic\n    max_t_distribution = []\n    for signs in sign_flips:\n        signs_array = np.array(signs).reshape(-1, 1)\n        permuted_data = D * signs_array\n        \n        t_permuted = compute_t_stats(permuted_data)\n        \n        max_abs_t = np.max(np.abs(t_permuted))\n        max_t_distribution.append(max_abs_t)\n\n    # 4. Sort the distribution and find the critical value c_alpha\n    max_t_distribution.sort()\n    \n    # The critical value is the (1-alpha) quantile of the permutation distribution.\n    # We use ceiling to be conservative, ensuring P(T_max >= c_alpha) = alpha.\n    quantile_index = int(np.ceil((1 - alpha) * R)) - 1\n    \n    # Ensure index is within bounds\n    if quantile_index  0:\n        quantile_index = 0\n    if quantile_index >= R:\n        quantile_index = R-1\n        \n    c_alpha = max_t_distribution[quantile_index]\n\n    # 5. Count how many observed t-statistics exceed the critical threshold\n    significant_count = np.sum(abs_t_observed >= c_alpha)\n    \n    return int(significant_count)\n\ndef solve():\n    \"\"\"\n    Solves the problem by running the permutation test on all provided test cases.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"data\": [\n                [0.8, 0.2, 1.2],\n                [0.6, -0.1, 1.0],\n                [0.7, 0.0, 1.1],\n                [0.9, 0.3, 0.9]\n            ],\n            \"alpha\": 0.05\n        },\n        {\n            \"data\": [\n                [0.05, 0.4],\n                [-0.02, 0.45],\n                [0.01, 0.35],\n                [-0.03, 0.5],\n                [0.00, 0.38]\n            ],\n            \"alpha\": 0.05\n        },\n        {\n            \"data\": [\n                [-0.5],\n                [-0.6],\n                [-0.4],\n                [-0.55],\n                [-0.45],\n                [-0.5]\n            ],\n            \"alpha\": 0.05\n        },\n        {\n            \"data\": [\n                [1.0, 0.5, 0.2, 0.3],\n                [0.0, -0.5, -0.2, -0.3],\n                [-1.0, 0.0, 0.0, 0.0]\n            ],\n            \"alpha\": 0.05\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        D = np.array(case[\"data\"])\n        alpha = case[\"alpha\"]\n        result = calculate_significant_features(D, alpha)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "4445740"}]}