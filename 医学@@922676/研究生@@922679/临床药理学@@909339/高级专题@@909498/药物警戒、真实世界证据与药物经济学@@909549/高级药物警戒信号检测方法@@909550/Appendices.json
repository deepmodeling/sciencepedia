{"hands_on_practices": [{"introduction": "本练习深入探讨了贝叶斯置信度传播神经网络（BCPNN），这是一种用于不均衡性分析的精密方法。你将计算信息分量（IC），它量化了药物与不良事件之间的关联强度，超越了简单的频率计数。这项实践对于理解贝叶斯收缩如何稳定估计值并提供更稳健的信号至关重要，尤其是在处理罕见事件时 [@problem_id:4520104]。", "problem": "一个自发呈报数据库由一个关于药物 $D$ 和不良事件 $E$ 的 $2 \\times 2$ 列联表总结，其报告总数为 $N$，联合计数为 $n_{DE}$，边际计数为 $n_{D \\cdot}$ 和 $n_{\\cdot E}$。考虑一个针对四个单元格概率 $(p_{11}, p_{10}, p_{01}, p_{00})$ 的贝叶斯收缩模型，该模型对每个单元格使用伪计数为 $\\alpha$ 的对称狄利克雷先验，其中数据被建模为多项分布。对于贝叶斯置信度传播神经网络 (BCPNN) 的不成比例性指标，信息分量 (IC) 定义为 $IC = \\log_{2}\\!\\left(\\frac{p_{11}}{(p_{11}+p_{10})(p_{11}+p_{01})}\\right)$。\n\n从多项式似然和狄利克雷共轭先验的定义出发，使用 $(p_{11}, p_{10}, p_{01}, p_{00})$ 的后验分布来：\n- 通过在 $(p_{11}, p_{10}, p_{01}, p_{00})$ 的后验均值处评估定义函数，计算 $IC$ 的点估计，以及\n- 通过将狄利克雷分布的后验协方差传播到上述变换中，计算 $IC$ 的 delta 方法标准误。\n\n给定 $n_{DE} = 20$，$n_{D \\cdot} = 200$，$n_{\\cdot E} = 150$，$N = 5000$，以及对四个单元格中每个单元格的伪计数为 $\\alpha = 1$ 的对称狄利克雷先验。报告由 $IC$ 的点估计及其 delta 方法标准误组成的数对。将两个值都四舍五入到四位有效数字。无需单位。", "solution": "该问题要求在贝叶斯框架内计算信息分量 ($IC$) 的点估计和标准误。\n\n首先，我们建立 $2 \\times 2$ 列联表的记法并计算所有四个单元格的计数。令单元格 $(i, j)$ 对应于药物状态 $i$ 和事件状态 $j$，其中 $i=1$ 表示存在药物 $D$，$i=0$ 表示不存在药物 $D$；类似地，$j=1$ 表示存在事件 $E$，$j=0$ 表示不存在事件 $E$。\n\n给定的计数是：\n报告总数：$N=5000$\n药物 $D$ 和事件 $E$：$n_{11} = n_{DE} = 20$\n药物 $D$ 边际：$n_{D \\cdot} = n_{11} + n_{10} = 200$\n事件 $E$ 边际：$n_{\\cdot E} = n_{11} + n_{01} = 150$\n\n由此，我们推导出其他单元格的计数：\n药物 $D$，无事件 $E$：$n_{10} = n_{D \\cdot} - n_{11} = 200 - 20 = 180$\n无药物 $D$，事件 $E$：$n_{01} = n_{\\cdot E} - n_{11} = 150 - 20 = 130$\n无药物 $D$，无事件 $E$：$n_{00} = N - n_{11} - n_{10} - n_{01} = 5000 - 20 - 180 - 130 = 4670$\n完整的计数集为 $(n_{11}, n_{10}, n_{01}, n_{00}) = (20, 180, 130, 4670)$。\n\n模型假设数据 $\\mathbf{n} = (n_{11}, n_{10}, n_{01}, n_{00})$ 服从参数为 $N$ 和单元格概率为 $\\mathbf{p} = (p_{11}, p_{10}, p_{01}, p_{00})$ 的多项分布。$\\mathbf{p}$ 的先验是对称狄利克雷分布，$\\mathbf{p} \\sim \\text{Dir}(\\alpha, \\alpha, \\alpha, \\alpha)$，其中 $\\alpha=1$。\n\n狄利克雷分布是多项式似然的共轭先验。因此，给定数据 $\\mathbf{n}$，$\\mathbf{p}$ 的后验分布也是一个狄利克雷分布：\n$$ \\mathbf{p} \\,|\\, \\mathbf{n} \\sim \\text{Dir}(\\alpha'_{11}, \\alpha'_{10}, \\alpha'_{01}, \\alpha'_{00}) $$\n其中后验参数为 $\\alpha'_{ij} = n_{ij} + \\alpha$。\n当 $\\alpha=1$ 时，后验参数为：\n$\\alpha'_{11} = 20 + 1 = 21$\n$\\alpha'_{10} = 180 + 1 = 181$\n$\\alpha'_{01} = 130 + 1 = 131$\n$\\alpha'_{00} = 4670 + 1 = 4671$\n\n后验参数的总和为 $\\alpha'_0 = \\sum_{i,j} \\alpha'_{ij} = 21 + 181 + 131 + 4671 = 5004$。注意，这也等于 $N + 4\\alpha = 5000 + 4(1) = 5004$。\n\n**1. IC 的点估计**\n\n点估计是通过将概率的后验均值代入 $IC$ 的定义中来计算的。$p_{ij}$ 的后验均值为 $E[p_{ij} | \\mathbf{n}] = \\hat{p}_{ij} = \\frac{\\alpha'_{ij}}{\\alpha'_0}$。\nIC 定义为 $g(\\mathbf{p}) = IC = \\log_{2}\\!\\left(\\frac{p_{11}}{p_{D\\cdot} p_{\\cdot E}}\\right)$，其中 $p_{D\\cdot} = p_{11}+p_{10}$ 且 $p_{\\cdot E} = p_{11}+p_{01}$。\n点估计 $\\widehat{IC}$ 为：\n$$ \\widehat{IC} = g(\\hat{\\mathbf{p}}) = \\log_{2}\\!\\left(\\frac{\\hat{p}_{11}}{\\hat{p}_{D\\cdot}\\hat{p}_{\\cdot E}}\\right) $$\n边际概率的后验均值为 $\\hat{p}_{D\\cdot} = \\hat{p}_{11}+\\hat{p}_{10} = \\frac{\\alpha'_{11}+\\alpha'_{10}}{\\alpha'_0}$ 和 $\\hat{p}_{\\cdot E} = \\hat{p}_{11}+\\hat{p}_{01} = \\frac{\\alpha'_{11}+\\alpha'_{01}}{\\alpha'_0}$。\n令 $\\alpha'_{D\\cdot} = \\alpha'_{11}+\\alpha'_{10} = 21+181 = 202$ 且 $\\alpha'_{\\cdot E} = \\alpha'_{11}+\\alpha'_{01} = 21+131 = 152$。\n那么，\n$$ \\widehat{IC} = \\log_{2}\\!\\left(\\frac{\\alpha'_{11}/\\alpha'_{0}}{(\\alpha'_{D\\cdot}/\\alpha'_{0})(\\alpha'_{\\cdot E}/\\alpha'_{0})}\\right) = \\log_{2}\\!\\left(\\frac{\\alpha'_{11}\\alpha'_0}{\\alpha'_{D\\cdot}\\alpha'_{\\cdot E}}\\right) $$\n代入数值：\n$$ \\widehat{IC} = \\log_{2}\\!\\left(\\frac{21 \\times 5004}{202 \\times 152}\\right) = \\log_{2}\\!\\left(\\frac{105084}{30704}\\right) \\approx \\log_{2}(3.42248567) $$\n$$ \\widehat{IC} = \\frac{\\ln(3.42248567)}{\\ln(2)} \\approx 1.775193 $$\n四舍五入到四位有效数字，点估计为 $1.775$。\n\n**2. IC 的 Delta 方法标准误**\n\nDelta 方法将函数 $g(\\mathbf{p})$ 的方差近似为 $\\text{Var}(g(\\mathbf{p})) \\approx (\\nabla g)^T \\Sigma_{\\mathbf{p}} (\\nabla g)$，在后验均值 $\\hat{\\mathbf{p}}$ 处求值。对于后验狄利克雷分布，这可以简化为：\n$$ \\text{Var}(g(\\mathbf{p})) \\approx \\frac{1}{\\alpha'_0+1} \\left[ \\sum_{i,j} \\hat{p}_{ij} \\left(\\frac{\\partial g}{\\partial p_{ij}}\\right)^2 - \\left(\\sum_{i,j} \\hat{p}_{ij} \\frac{\\partial g}{\\partial p_{ij}}\\right)^2 \\right] $$\n首先，我们用自然对数表示 $g(\\mathbf{p})$：$g(\\mathbf{p}) = \\frac{1}{\\ln(2)}[\\ln(p_{11}) - \\ln(p_{11}+p_{10}) - \\ln(p_{11}+p_{01})]$。令 $C = 1/\\ln(2)$。\n在后验均值 $\\hat{\\mathbf{p}}$ 处求值的偏导数为：\n$\\frac{\\partial g}{\\partial p_{11}} = C \\left(\\frac{1}{p_{11}} - \\frac{1}{p_{D\\cdot}} - \\frac{1}{p_{\\cdot E}}\\right)$\n$\\frac{\\partial g}{\\partial p_{10}} = C \\left(-\\frac{1}{p_{D\\cdot}}\\right)$\n$\\frac{\\partial g}{\\partial p_{01}} = C \\left(-\\frac{1}{p_{\\cdot E}}\\right)$\n$\\frac{\\partial g}{\\partial p_{00}} = 0$\n\n我们来计算方差公式中的两项。第一项是 $E_{\\hat{\\mathbf{p}}}[\\nabla g] = \\sum \\hat{p}_{ij}\\frac{\\partial g}{\\partial p_{ij}}$：\n$$ \\sum_{i,j} \\hat{p}_{ij}\\frac{\\partial g}{\\partial p_{ij}} = C \\left[ \\hat{p}_{11}\\left(\\frac{1}{\\hat{p}_{11}} - \\frac{1}{\\hat{p}_{D\\cdot}} - \\frac{1}{\\hat{p}_{\\cdot E}}\\right) - \\hat{p}_{10}\\frac{1}{\\hat{p}_{D\\cdot}} - \\hat{p}_{01}\\frac{1}{\\hat{p}_{\\cdot E}} \\right] $$\n$$ = C \\left[ 1 - \\frac{\\hat{p}_{11}}{\\hat{p}_{D\\cdot}} - \\frac{\\hat{p}_{11}}{\\hat{p}_{\\cdot E}} - \\frac{\\hat{p}_{10}}{\\hat{p}_{D\\cdot}} - \\frac{\\hat{p}_{01}}{\\hat{p}_{\\cdot E}} \\right] = C \\left[ 1 - \\frac{\\hat{p}_{11}+\\hat{p}_{10}}{\\hat{p}_{D\\cdot}} - \\frac{\\hat{p}_{11}+\\hat{p}_{01}}{\\hat{p}_{\\cdot E}} \\right] $$\n$$ = C [1 - 1 - 1] = -C $$\n第二项是 $E_{\\hat{\\mathbf{p}}}[(\\nabla g)^2] = \\sum \\hat{p}_{ij}(\\frac{\\partial g}{\\partial p_{ij}})^2$：\n$$ \\sum_{i,j} \\hat{p}_{ij}\\left(\\frac{\\partial g}{\\partial p_{ij}}\\right)^2 = C^2 \\left[ \\hat{p}_{11}\\left(\\frac{1}{\\hat{p}_{11}}-\\frac{1}{\\hat{p}_{D\\cdot}}-\\frac{1}{\\hat{p}_{\\cdot E}}\\right)^2 + \\frac{\\hat{p}_{10}}{\\hat{p}_{D\\cdot}^2} + \\frac{\\hat{p}_{01}}{\\hat{p}_{\\cdot E}^2} \\right] $$\n展开并简化此表达式可得：\n$$ \\sum_{i,j} \\hat{p}_{ij}\\left(\\frac{\\partial g}{\\partial p_{ij}}\\right)^2 = C^2 \\left[ \\frac{1}{\\hat{p}_{11}} - \\frac{1}{\\hat{p}_{D\\cdot}} - \\frac{1}{\\hat{p}_{\\cdot E}} + \\frac{2\\hat{p}_{11}}{\\hat{p}_{D\\cdot}\\hat{p}_{\\cdot E}} \\right] $$\n现在，将这些简化形式代入方差公式：\n$$ \\text{Var}(IC) \\approx \\frac{1}{\\alpha'_0+1} \\left[ C^2 \\left( \\frac{1}{\\hat{p}_{11}} - \\frac{1}{\\hat{p}_{D\\cdot}} - \\frac{1}{\\hat{p}_{\\cdot E}} + \\frac{2\\hat{p}_{11}}{\\hat{p}_{D\\cdot}\\hat{p}_{\\cdot E}} \\right) - (-C)^2 \\right] $$\n$$ \\text{Var}(IC) \\approx \\frac{C^2}{\\alpha'_0+1} \\left[ \\frac{1}{\\hat{p}_{11}} - \\frac{1}{\\hat{p}_{D\\cdot}} - \\frac{1}{\\hat{p}_{\\cdot E}} + \\frac{2\\hat{p}_{11}}{\\hat{p}_{D\\cdot}\\hat{p}_{\\cdot E}} - 1 \\right] $$\n让我们将数值代入方括号中的项。\n$\\frac{1}{\\hat{p}_{11}} = \\frac{\\alpha'_0}{\\alpha'_{11}} = \\frac{5004}{21} \\approx 238.2857$\n$\\frac{1}{\\hat{p}_{D\\cdot}} = \\frac{\\alpha'_0}{\\alpha'_{D\\cdot}} = \\frac{5004}{202} \\approx 24.7723$\n$\\frac{1}{\\hat{p}_{\\cdot E}} = \\frac{\\alpha'_0}{\\alpha'_{\\cdot E}} = \\frac{5004}{152} \\approx 32.9211$\n$\\frac{2\\hat{p}_{11}}{\\hat{p}_{D\\cdot}\\hat{p}_{\\cdot E}} = \\frac{2\\alpha'_{11}\\alpha'_0}{\\alpha'_{D\\cdot}\\alpha'_{\\cdot E}} = \\frac{2 \\times 21 \\times 5004}{202 \\times 152} \\approx 6.8450$\n方括号中的项是 $238.2857 - 24.7723 - 32.9211 + 6.8450 - 1 = 186.4373$\n因此，方差为：\n$$ \\text{Var}(IC) \\approx \\frac{1}{(\\ln(2))^2} \\frac{186.4373}{5004+1} \\approx \\frac{1}{0.480453} \\frac{186.4373}{5005} \\approx 2.081368 \\times 0.0372502 \\approx 0.0775317 $$\n标准误是方差的平方根：\n$$ SE(IC) = \\sqrt{\\text{Var}(IC)} \\approx \\sqrt{0.0775317} \\approx 0.278445 $$\n四舍五入到四位有效数字，标准误为 $0.2784$。\n\n由点估计及其 delta 方法标准误组成的数对是 $(1.775, 0.2784)$。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n1.775  0.2784\n\\end{pmatrix}\n}\n$$", "id": "4520104"}, {"introduction": "从不均衡性分析转向队列研究，本问题聚焦于计算发病率比（IRR），这是药物流行病学的基石。通过处理人-时数据，你可以估计绝对风险并直接比较发病率，这提供了另一种通常更可靠的证据类型。这项动手计算将巩固你对基于率的比较及其置信区间构建的理解 [@problem_id:4520180]。", "problem": "一项跨国上市后安全性研究，旨在评估一种新批准的口服抗凝剂与一种已广泛使用的对照药物相比，其与胃肠道出血的关联。在一个从常规医疗电子健康记录和理赔数据中组建的队列中，暴露组（新抗凝剂）贡献了 $t_{E} = 23{,}500$ 人年，并发生了 $k_{E} = 85$ 例首次胃肠道出血事件。对照组贡献了 $t_{C} = 31{,}200$ 人年，并发生了 $k_{C} = 96$ 例首次胃肠道出血事件。假设事件计数遵循泊松过程，各组内的率参数是恒定的，且人时数是精确测量的。\n\n使用一个带有泊松方差假设的对数率模型，从第一性原理推导发生率比的对数的大样本Wald置信区间，然后进行反变换以获得发生率比。计算发生率比的点估计值及其$95\\%$置信区间。\n\n将发生率比及其置信区间界限表示为无量纲量。将发生率比和置信区间界限四舍五入到四位有效数字。最终答案必须是一个单行向量，按顺序包含发生率比、置信下限和置信上限。", "solution": "该问题陈述具有科学依据，提法明确且客观，为进行有效分析提供了所有必要的数据和假设。因此，我们可以开始求解。\n\n设 $\\lambda_E$ 和 $\\lambda_C$ 分别为暴露组（新抗凝剂）和对照组中胃肠道出血的真实但未知的发生率。这些率的单位是事件/人年。问题陈述指出，每组中的事件数遵循泊松过程。在人时数为 $t$ 的时期内观察到的事件数 $K$ 是一个随机变量 $K \\sim \\text{Poisson}(\\lambda t)$。给定的数据是，在 $t_E = 23{,}500$ 人年内观察到 $k_E = 85$ 个事件，在 $t_C = 31{,}200$ 人年内观察到 $k_C = 96$ 个事件。\n\n泊松率 $\\lambda$ 的最大似然估计量由观测到的事件数除以人时数给出，即 $\\hat{\\lambda} = k/t$。因此，两组的估计率为：\n$$\n\\hat{\\lambda}_E = \\frac{k_E}{t_E} = \\frac{85}{23{,}500} \\text{ 人年}^{-1}\n$$\n$$\n\\hat{\\lambda}_C = \\frac{k_C}{t_C} = \\frac{96}{31{,}200} \\text{ 人年}^{-1}\n$$\n我们感兴趣的参数是发生率比（Incidence Rate Ratio, IRR），定义为两个率的比值：\n$$\nIRR = \\frac{\\lambda_E}{\\lambda_C}\n$$\nIRR的点估计值，记为 $\\widehat{IRR}$，由估计率计算得出：\n$$\n\\widehat{IRR} = \\frac{\\hat{\\lambda}_E}{\\hat{\\lambda}_C} = \\frac{k_E/t_E}{k_C/t_C} = \\frac{k_E t_C}{k_C t_E}\n$$\n为了构建置信区间，标准做法是处理IRR的自然对数。对数变换产生的抽样分布更接近正态分布。设 $\\theta = \\ln(IRR)$。$\\theta$ 的估计量是 $\\hat{\\theta} = \\ln(\\widehat{IRR})$。\n$$\n\\hat{\\theta} = \\ln\\left(\\frac{\\hat{\\lambda}_E}{\\hat{\\lambda}_C}\\right) = \\ln(\\hat{\\lambda}_E) - \\ln(\\hat{\\lambda}_C)\n$$\n对于大样本Wald置信区间，我们需要 $\\hat{\\theta}$ 的方差。由于暴露组和对照组是独立的，差的方差是方差之和：\n$$\n\\text{Var}(\\hat{\\theta}) = \\text{Var}(\\ln(\\hat{\\lambda}_E)) + \\text{Var}(\\ln(\\hat{\\lambda}_C))\n$$\n我们使用Delta方法推导单个对数率估计量的方差 $\\text{Var}(\\ln(\\hat{\\lambda}))$。对于函数 $g(X)$，其方差近似为 $\\text{Var}(g(X)) \\approx (g'(E[X]))^2 \\text{Var}(X)$。这里，我们的随机变量是估计量 $\\hat{\\lambda} = K/t$，函数是 $g(\\hat{\\lambda}) = \\ln(\\hat{\\lambda})$。\n\n估计量 $\\hat{\\lambda}$ 是无偏的，所以其期望值为 $E[\\hat{\\lambda}] = E[K/t] = (\\lambda t)/t = \\lambda$。\n$\\hat{\\lambda}$ 的方差是 $\\text{Var}(\\hat{\\lambda}) = \\text{Var}(K/t) = \\frac{1}{t^2}\\text{Var}(K)$。由于 $K \\sim \\text{Poisson}(\\lambda t)$，其方差为 $\\text{Var}(K) = \\lambda t$。因此，\n$$\n\\text{Var}(\\hat{\\lambda}) = \\frac{1}{t^2}(\\lambda t) = \\frac{\\lambda}{t}\n$$\n函数 $g(\\lambda) = \\ln(\\lambda)$ 的导数是 $g'(\\lambda) = 1/\\lambda$。应用Delta方法：\n$$\n\\text{Var}(\\ln(\\hat{\\lambda})) \\approx \\left(\\frac{1}{E[\\hat{\\lambda}]}\\right)^2 \\text{Var}(\\hat{\\lambda}) = \\left(\\frac{1}{\\lambda}\\right)^2 \\left(\\frac{\\lambda}{t}\\right) = \\frac{1}{\\lambda^2} \\frac{\\lambda}{t} = \\frac{1}{\\lambda t}\n$$\n表达式 $\\lambda t$ 代表期望事件数。在实践中，这是未知的，可以通过用最大似然估计量 $\\hat{\\lambda}$ 替代 $\\lambda$ 来估计，从而得到估计方差为 $1/(\\hat{\\lambda}t) = 1/((k/t)t) = 1/k$。因此，对数率的估计方差就是观测事件数的倒数。\n\n将此应用于我们的问题，$\\hat{\\theta}$ 的估计方差为：\n$$\n\\widehat{\\text{Var}}(\\hat{\\theta}) = \\widehat{\\text{Var}}(\\ln(\\hat{\\lambda}_E)) + \\widehat{\\text{Var}}(\\ln(\\hat{\\lambda}_C)) = \\frac{1}{k_E} + \\frac{1}{k_C}\n$$\n$\\hat{\\theta}$ 的标准误（SE）是该方差的平方根：\n$$\nSE(\\hat{\\theta}) = \\sqrt{\\frac{1}{k_E} + \\frac{1}{k_C}}\n$$\n$\\theta = \\ln(IRR)$ 的 $(1-\\alpha)100\\%$ Wald置信区间由 $\\hat{\\theta} \\pm z_{1-\\alpha/2} SE(\\hat{\\theta})$ 给出，其中 $z_{1-\\alpha/2}$ 是标准正态分布的临界值。对于 $95\\%$ 置信区间，$\\alpha = 0.05$，且 $z_{0.975} \\approx 1.959964$。$\\ln(IRR)$ 的置信区间为：\n$$\n\\ln(\\widehat{IRR}) \\pm z_{0.975} \\sqrt{\\frac{1}{k_E} + \\frac{1}{k_C}}\n$$\n要获得IRR的置信区间，我们对 $\\ln(IRR)$ 区间的下限和上限取指数：\n$$\nCI_{IRR} = \\exp\\left( \\ln(\\widehat{IRR}) \\pm z_{0.975} \\sqrt{\\frac{1}{k_E} + \\frac{1}{k_C}} \\right) = \\widehat{IRR} \\cdot \\exp\\left(\\pm z_{0.975} \\sqrt{\\frac{1}{k_E} + \\frac{1}{k_C}}\\right)\n$$\n现在，我们代入给定值：$k_E = 85$，$t_E = 23{,}500$，$k_C = 96$，$t_C = 31{,}200$。\n\n首先，IRR的点估计值：\n$$\n\\widehat{IRR} = \\frac{85 \\times 31{,}200}{96 \\times 23{,}500} = \\frac{2{,}652{,}000}{2{,}256{,}000} \\approx 1.1755319\n$$\n接下来，对数IRR的标准误：\n$$\nSE(\\ln(\\widehat{IRR})) = \\sqrt{\\frac{1}{85} + \\frac{1}{96}} \\approx \\sqrt{0.0117647 + 0.0104167} = \\sqrt{0.0221814} \\approx 0.1489342\n$$\n对数IRR的 $95\\%$ 置信区间是：\n$$\n\\ln(1.1755319) \\pm 1.959964 \\times 0.1489342\n$$\n$$\n0.161744 \\pm 0.291907\n$$\n这给出了 $\\ln(IRR)$ 的区间 $[-0.130163, 0.453651]$。\n\n最后，我们通过对界限取指数进行反变换，得到IRR的 $95\\%$ 置信区间：\n下限：$L = \\exp(-0.130163) \\approx 0.877942$\n上限：$U = \\exp(0.453651) \\approx 1.574044$\n\n将点估计值和置信界限四舍五入到四位有效数字：\n点估计值 $\\widehat{IRR} = 1.176$\n下限 $L = 0.8779$\n上限 $U = 1.574$\n\n点估计值 $1.176$ 表明，与对照药物相比，使用新抗凝剂的胃肠道出血率增加了 $17.6\\%$。然而，$95\\%$ 置信区间从 $0.8779$ 到 $1.574$，包含了无效值 $1.0$。这表明，在 $\\alpha=0.05$ 的水平上，观测到的增加在统计上不显著。", "answer": "$$\n\\boxed{\\begin{pmatrix} 1.176  0.8779  1.574 \\end{pmatrix}}\n$$", "id": "4520180"}, {"introduction": "药物警戒并非一次性分析，而是一个持续的监测过程。本练习介绍了指数加权移动平均（EWMA）图，这是一种用于序列信号检测的强大工具。通过实施EWMA，你将学习如何检测报告频率随时间发生的微小但持续的变化，这些变化可能会被静态的、横截面的分析所忽略 [@problem_id:4520144]。", "problem": "要求您基于概率论和统计学的第一性原理，构建并应用指数加权移动平均 (EWMA) 控制图，以进行药物警戒信号检测。考虑一个每月监测的单一药物-事件对。设第 $t$ 个月的观测计数为 $X_t$，在零假设（无真实变化）下的期望计数为 $\\mu_t$。假设在零假设下，$X_t$ 是独立的，并服从均值为 $\\mu_t$ 的泊松分布，即 $X_t \\sim \\text{Poisson}(\\mu_t)$，且序列 $\\{X_t\\}$ 随时间独立。\n\n从期望的线性性质、独立随机变量方差的基本定义以及 EWMA 统计量的定义出发：\n- 通过平滑参数 $\\lambda \\in (0,1)$ 递归定义 EWMA 统计量 $Z_t$ 为 $Z_t = \\lambda X_t + (1-\\lambda) Z_{t-1}$，初始启动值为 $Z_0 = \\mu_1$。\n- 使用期望的线性性质和独立性假设，从第一性原理递归推导期望值 $m_t = \\mathbb{E}[Z_t]$。\n- 使用 $\\text{Var}(aY + bZ) = a^2 \\text{Var}(Y) + b^2 \\text{Var}(Z) + 2ab\\,\\text{Cov}(Y,Z)$、 $X_t$ 与过去观测值独立的性质，以及对于泊松随机变量 $Y \\sim \\text{Poisson}(\\theta)$ 有 $\\text{Var}(Y) = \\theta$ 这一事实，从第一性原理递归推导方差 $v_t = \\text{Var}(Z_t)$。\n- 使用这些推导出的递归式，计算每个月 $t$ 的时变双侧控制限为 $m_t \\pm L \\sqrt{v_t}$，其中宽度乘数 $L = 3$。如果在第 $t$ 个月，$Z_t > m_t + L \\sqrt{v_t}$，则标记一个潜在的上限信号；如果 $Z_t  m_t - L \\sqrt{v_t}$，则标记一个潜在的下限信号。\n\n取平滑参数 $\\lambda = 0.2$。所有量均为无量纲的月度计数；无需物理单位。不涉及角度。不涉及百分比。\n\n为以下三个测试用例（每个跨度为 24 个月）实现此逻辑。对于每个用例，将序列 $\\{\\mu_t\\}$ 视为已知且固定的，并将观测计数 $\\{x_t\\}$ 作为给定数据代入 EWMA 递归式中。\n\n测试套件：\n- 用例 1（恒定基线，单次极端峰值）：\n    - 对于 $t=1,\\dots,24$，$\\mu_t = 5$。\n    - $x_t = [5,5,5,5,5,5,5,5,5,5,5,5,50,5,5,5,5,5,5,5,5,5,5,5]$。\n- 用例 2（极低基线，零值中的单次峰值）：\n    - 对于 $t=1,\\dots,24$，$\\mu_t = 0.2$。\n    - $x_t = [0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0]$。\n- 用例 3（阶梯式变化基线，阶跃变化后的单次极端峰值）：\n    - $\\mu_t = [2,2,2,2,2,2,4,4,4,4,4,4,6,6,6,6,6,6,8,8,8,8,8,8]$。\n    - 除了第 19 个月出现峰值外，所有月份的 $x_t$ 都等于 $\\mu_t$，即 $x_t = [2,2,2,2,2,2,4,4,4,4,4,4,6,6,6,6,6,6,40,8,8,8,8,8]$。\n\n必需的计算步骤：\n1. 对于每个用例，初始化 $Z_0 = \\mu_1$，设 $m_0 = \\mu_1$ 和 $v_0 = 0$。\n2. 对于 $t = 1,\\dots,24$，仅使用基本定律（期望的线性和独立和的方差）以及泊松计数的 $\\text{Var}(X_t) = \\mu_t$ 来更新 $Z_t$、$m_t$ 和 $v_t$。\n3. 在每个 $t$，计算上、下控制限，并如果发生如上定义的潜在信号，则记录月份索引 $t$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个包含三个元素（每个测试用例一个）的列表的类 JSON 表示。\n- 每个元素本身必须是一个包含两个列表的列表：第一个是出现上限信号的月份列表（使用基于 1 的索引），第二个是出现下限信号的月份列表。\n- 例如，输出格式必须为： \"[[ [u1_1,u1_2,...], [l1_1,l1_2,...] ], [ [u2_1,...], [l2_1,...] ], [ [u3_1,...], [l3_1,...] ]]\"，不含空格。", "solution": "我们通过从 $Z_t$ 的定义出发，并应用期望和方差的基本性质，来构建指数加权移动平均 (EWMA) 统计量及其控制限。\n\n指数加权移动平均 (EWMA) 的定义：\n对于平滑参数 $\\lambda \\in (0,1)$ 和初始启动值 $Z_0 = \\mu_1$，定义递归统计量\n$$\nZ_t = \\lambda X_t + (1 - \\lambda) Z_{t-1}, \\quad t = 1,2,\\dots,24.\n$$\n这是指数加权移动平均 (EWMA) 的标准定义，它在保留过去信息的同时，强调了最近的观测值。\n\n零假设下的假设（除了指定的 $\\mu_t$ 外，基础过程中没有真实变化）：\n- 在时间 $t$ 的观测计数 $X_t$ 是一个均值为 $\\mu_t$ 的泊松随机变量，即 $X_t \\sim \\text{Poisson}(\\mu_t)$。\n- 序列 $\\{X_t\\}$ 随时间独立。\n\n我们现在从第一性原理推导期望值 $m_t = \\mathbb{E}[Z_t]$ 和方差 $v_t = \\text{Var}(Z_t)$。\n\n期望值递归：\n使用期望的线性性质，\n$$\nm_t = \\mathbb{E}[Z_t] = \\mathbb{E}[\\lambda X_t + (1-\\lambda) Z_{t-1}]\n= \\lambda \\mathbb{E}[X_t] + (1-\\lambda) \\mathbb{E}[Z_{t-1}]\n= \\lambda \\mu_t + (1-\\lambda) m_{t-1},\n$$\n初始化为 $m_0 = \\mathbb{E}[Z_0] = \\mu_1$，因为 $Z_0$ 固定为 $\\mu_1$。\n\n方差递归：\n使用线性组合的方差和独立性假设，注意到 $Z_{t-1}$ 只依赖于 $X_1,\\dots,X_{t-1}$，而 $X_t$ 与过去独立。因此 $\\text{Cov}(Z_{t-1}, X_t) = 0$。使用 $\\text{Var}(aY + bZ) = a^2 \\text{Var}(Y) + b^2 \\text{Var}(Z) + 2ab \\,\\text{Cov}(Y,Z)$，我们得到\n$$\nv_t = \\text{Var}(Z_t) = \\text{Var}(\\lambda X_t + (1-\\lambda) Z_{t-1})\n= \\lambda^2 \\text{Var}(X_t) + (1-\\lambda)^2 \\text{Var}(Z_{t-1}) + 2 \\lambda (1-\\lambda) \\text{Cov}(X_t, Z_{t-1}).\n$$\n根据独立性，$\\text{Cov}(X_t, Z_{t-1}) = 0$。对于泊松变量 $X_t$，$\\text{Var}(X_t) = \\mu_t$。因此，\n$$\nv_t = (1-\\lambda)^2 v_{t-1} + \\lambda^2 \\mu_t,\n$$\n初始化为 $v_0 = \\text{Var}(Z_0) = 0$，因为 $Z_0$ 是固定的。\n\n时间 $t$ 的控制限：\n在每个时间 $t$，我们计算时变的中心和限值如下\n$$\n\\text{中心线: } m_t, \\quad\n\\text{标准差: } s_t = \\sqrt{v_t}, \\quad\n\\text{控制上限: } \\text{UCL}_t = m_t + L s_t, \\quad\n\\text{控制下限: } \\text{LCL}_t = m_t - L s_t,\n$$\n其中 $L = 3$ 是宽度乘数。\n\n信号逻辑：\n- 若 $Z_t > \\text{UCL}_t$，则在第 $t$ 个月出现上限信号。\n- 若 $Z_t  \\text{LCL}_t$，则在第 $t$ 个月出现下限信号。\n\n我们现在将此应用于指定的测试用例，其中 $\\lambda = 0.2$。\n\n所有用例通用的初始化：\n- $Z_0 = \\mu_1$,\n- $m_0 = \\mu_1$,\n- $v_0 = 0$.\n\n用例 1：\n- 对于 $t=1,\\dots,24$，$\\mu_t = 5$。\n- $x_t = [5,5,5,5,5,5,5,5,5,5,5,5,50,5,5,5,5,5,5,5,5,5,5,5]$。\n\n因为 $\\mu_t$ 是常数且 $Z_0 = \\mu_1$，从递归式可得，对所有 $t$ 都有 $m_t = 5$。方差 $v_t$ 迅速收敛到其稳态值 $v_\\infty = \\frac{\\lambda}{2-\\lambda} \\mu \\approx \\frac{0.2}{1.8}\\cdot 5 \\approx 0.555\\ldots$；从数值上看，在初始瞬态之后，$s_t \\approx \\sqrt{0.555\\ldots} \\approx 0.745$，因此 $\\text{UCL}_t \\approx 5 + 3\\times 0.745 \\approx 7.236$ 且 $\\text{LCL}_t \\approx 2.764$。$x_t=5$ 的长序列使 $Z_t$ 一直保持在 5，直到第 13 个月，$x_{13}=50$ 导致了一次跳变：\n$$\nZ_{13} = (1-\\lambda) Z_{12} + \\lambda x_{13} \\approx 0.8 \\cdot 5 + 0.2 \\cdot 50 = 14,\n$$\n这远高于 $\\text{UCL}_{13}$。此后，当 $x_t = 5$ 时，差值 $d_t = Z_t - m_t$ 每月以 $(1-\\lambda) = 0.8$ 的因子衰减。求解 $9 \\cdot 0.8^k > 3 s_t \\approx 2.236$ 得到 $k = 0,1,2,3,4,5,6$，对应于第 13 至 19 个月。没有出现下限信号。\n\n用例 1 的结果：\n- 上限信号出现在月份 $[13,14,15,16,17,18,19]$。\n- 下限信号出现在月份 $[]$。\n\n用例 2：\n- 对于 $t=1,\\dots,24$，$\\mu_t = 0.2$。\n- $x_t = [0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0]$。\n\n由于 $\\mu_t$ 是常数且 $Z_0 = \\mu_1$，对所有 $t$ 都有 $m_t = 0.2$。稳态方差为 $v_\\infty = \\frac{\\lambda}{2-\\lambda} \\mu \\approx \\frac{0.2}{1.8}\\cdot 0.2 \\approx 0.02222\\ldots$，因此 $s_t \\approx 0.149$ 且 $\\text{UCL}_t \\approx 0.2 + 3 \\cdot 0.149 \\approx 0.647$。初始的一系列零值将 $Z_t$ 向下拉低，但因为它保持为正值，所以从未低于控制下限。在第 11 个月，峰值 $x_{11} = 5$ 产生\n$$\nZ_{11} \\approx 0.8 Z_{10} + 0.2 \\cdot 5 \\approx 0.8 \\cdot 0.0215 + 1 \\approx 1.017,\n$$\n这大于 $\\text{UCL}_{11}$。随后的零值使得 $d_t = Z_t - m_t$ 每月衰减 0.8，因此 $d_{11} \\approx 0.817$。求解 $0.817 \\cdot 0.8^k > 3 s_t \\approx 0.447$ 得到 $k = 0,1,2$，对应于第 11、12、13 个月。没有出现下限信号。\n\n用例 2 的结果：\n- 上限信号出现在月份 $[11,12,13]$。\n- 下限信号出现在月份 $[]$。\n\n用例 3：\n- $\\mu_t = [2,2,2,2,2,2,4,4,4,4,4,4,6,6,6,6,6,6,8,8,8,8,8,8]$（阶梯式增加）。\n- $x_t = [2,2,2,2,2,2,4,4,4,4,4,4,6,6,6,6,6,6,40,8,8,8,8,8]$（除了第 19 个月的峰值外，与基线相等）。\n\n我们递归地计算 $m_t$ 和 $v_t$。因为 $Z_0 = \\mu_1$，$m_0 = \\mu_1$。期望值遵循 $m_t = (1-\\lambda) m_{t-1} + \\lambda \\mu_t$ 并逐渐适应阶跃变化。方差遵循 $v_t = (1-\\lambda)^2 v_{t-1} + \\lambda^2 \\mu_t$；当 $\\mu_t$ 较高时，方差略有增加，并且在稳定期间，标准差 $s_t = \\sqrt{v_t}$ 接近 $\\sqrt{\\frac{\\lambda}{2-\\lambda} \\mu_t}$。\n\n在第 19 个月，峰值 $x_{19} = 40$ 且 $\\mu_{19} = 8$ 产生\n$$\nZ_{19} \\approx 0.8 Z_{18} + 0.2 \\cdot 40, \\quad m_{19} = 0.8 m_{18} + 0.2 \\cdot 8.\n$$\n由于在前一个稳定期，$m_{18}$ 接近 6，$Z_{18}$ 也接近 6，我们得到 $Z_{19} \\approx 12.8$ 和 $m_{19} \\approx 6.4$。标准差 $s_{19}$ 约等于 0.86，所以 $\\text{UCL}_{19} \\approx 6.4 + 3 \\cdot 0.86 \\approx 8.99$。因此，第 19 个月是一个上限信号。此后，当 $x_t = \\mu_t = 8$ 时，偏差 $d_t = Z_t - m_t$ 遵循 $d_t = (1-\\lambda) d_{t-1}$ 并每月以 0.8 的因子衰减，而 $s_t$ 接近 $\\sqrt{\\frac{0.2}{1.8}\\cdot 8} \\approx 0.943$。用 $d_{19} \\approx 6.4$ 和 $3 s_t \\approx 2.83$ 求解 $d_{19} \\cdot 0.8^k > 3 s_t$ 得到 $k = 0,1,2,3$，对应于第 19、20、21、22 个月。没有出现下限信号。\n\n用例 3 的结果：\n- 上限信号出现在月份 $[19,20,21,22]$。\n- 下限信号出现在月份 $[]$。\n\n因此，要打印的最终汇总结果是：\n- 用例 1：$[ [13,14,15,16,17,18,19], [] ]$,\n- 用例 2：$[ [11,12,13], [] ]$,\n- 用例 3：$[ [19,20,21,22], [] ]$.\n\n程序必须输出一个不含空格的单行： \"[[[13,14,15,16,17,18,19],[]],[[11,12,13],[]],[[19,20,21,22],[]]]\"。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport json\nimport math\n\ndef ewma_signals(x, mu, lam=0.2, L=3.0):\n    n = len(x)\n    # Initialize\n    z_prev = mu[0]\n    m_prev = mu[0]\n    v_prev = 0.0\n\n    upper_signal_months = []\n    lower_signal_months = []\n\n    for t in range(1, n + 1):\n        xt = x[t - 1]\n        mut = mu[t - 1]\n\n        # Update EWMA\n        z_t = lam * xt + (1.0 - lam) * z_prev\n\n        # Update mean and variance under null\n        m_t = (1.0 - lam) * m_prev + lam * mut\n        v_t = (1.0 - lam) ** 2 * v_prev + (lam ** 2) * mut\n\n        s_t = math.sqrt(v_t)\n        ucl = m_t + L * s_t\n        lcl = m_t - L * s_t\n\n        # Check signals (1-based month index)\n        if z_t > ucl:\n            upper_signal_months.append(t)\n        if z_t  lcl:\n            lower_signal_months.append(t)\n\n        # Prepare for next iteration\n        z_prev = z_t\n        m_prev = m_t\n        v_prev = v_t\n\n    return upper_signal_months, lower_signal_months\n\ndef solve():\n    # Define the test cases from the problem statement.\n\n    # Case 1\n    mu1 = [5.0] * 24\n    x1 = [5,5,5,5,5,5,5,5,5,5,5,5,50,5,5,5,5,5,5,5,5,5,5,5]\n\n    # Case 2\n    mu2 = [0.2] * 24\n    x2 = [0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0]\n\n    # Case 3\n    mu3 = [2,2,2,2,2,2,4,4,4,4,4,4,6,6,6,6,6,6,8,8,8,8,8,8]\n    x3 = [2,2,2,2,2,2,4,4,4,4,4,4,6,6,6,6,6,6,40,8,8,8,8,8]\n\n    lam = 0.2\n    L = 3.0\n\n    results = []\n    for x, mu in [(x1, mu1), (x2, mu2), (x3, mu3)]:\n        upper, lower = ewma_signals(x, mu, lam=lam, L=L)\n        results.append([upper, lower])\n\n    # Final print statement in the exact required format (no spaces).\n    print(json.dumps(results, separators=(',',':')))\n\nsolve()\n```", "id": "4520144"}]}