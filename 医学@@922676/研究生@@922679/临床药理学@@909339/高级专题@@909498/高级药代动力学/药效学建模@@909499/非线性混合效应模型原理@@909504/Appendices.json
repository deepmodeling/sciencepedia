{"hands_on_practices": [{"introduction": "非线性混合效应模型的核心在于其结构化的参数化方式，它能够同时描述群体典型趋势和个体差异。本练习旨在通过一个常见的药代动力学场景，阐明如何将协变量效应（如体重）和个体间变异性整合到模型中。通过对数转换，您将把一个乘性误差模型转化为易于分析的线性形式，这是后续参数估计和模型解释的基础步骤。[@problem_id:4568900]", "problem": "在非线性混合效应模型 (NLME) 框架下，考虑一项群体药代动力学研究中个体清除率的结构参数化。设个体清除率 $CL_{i}$ 被建模为一个典型值和个体间变异的乘积分解，同时包含体重 $WT_{i}$（参考值为 $70$ 公斤）的异速生长协变量效应。具体来说，假设以下具有科学依据的基础：\n\n- 源自生理学理论的异速生长定标：成年哺乳动物的典型代谢率与体重呈幂律关系，指数为 $3/4$。\n- 对数正态的个体间变异：正参数上的乘性随机效应可以表示为一个均值为零的正态随机变量的指数，这意味着在对数尺度上噪声具有可加性。\n- 协变量与随机效应的独立性：体重 $WT_{i}$ 被视为一个与随机效应独立的观测协变量。\n\n从这些原则出发，设参数化为\n$$\nCL_{i} \\;=\\; \\theta_{CL} \\left(\\frac{WT_{i}}{70}\\right)^{\\beta} \\exp\\!\\big(\\eta_{CL,i}\\big),\n$$\n其中 $\\theta_{CL} \\!\\! 0$ 是体重为 $70$ 公斤时的典型清除率，$\\beta$ 是异速生长指数，而 $\\eta_{CL,i} \\sim \\mathcal{N}(0,\\omega_{CL}^{2})$ 代表对数尺度上的个体间变异。\n\n假设具有生理学动机的异速生长指数 $\\beta = 0.75$。仅使用上述基础和自然对数的一般性质，推导 $\\ln(CL_{i})$ 和 $\\ln(WT_{i}/70)$ 之间的线性关系，并确定具有可加误差 $\\eta_{CL,i}$ 的对数-线性表达式的回归截距和斜率。将你的最终答案以一个行矩阵的形式给出，其中依次包含截距和斜率。不需要进行数值代入，也无需四舍五入。", "solution": "该问题陈述已经过验证并被认为是有效的。它在科学上基于药代动力学和异速生长定标的既定原则，问题阐述清晰且具有唯一解，并且没有歧义或矛盾。因此，我们可以进行推导。\n\n出发点是给定的个体清除率 $CL_{i}$ 的结构模型：\n$$\nCL_{i} = \\theta_{CL} \\left(\\frac{WT_{i}}{70}\\right)^{\\beta} \\exp(\\eta_{CL,i})\n$$\n其中 $CL_{i}$ 是第 $i$ 个个体的清除率，$\\theta_{CL}$ 是体重为 $70$ 公斤个体的典型清除率，$WT_{i}$ 是第 $i$ 个个体的体重，$\\beta$ 是异速生长指数，$\\eta_{CL,i}$ 是代表个体间变异的随机效应，且 $\\eta_{CL,i} \\sim \\mathcal{N}(0, \\omega_{CL}^{2})$。\n\n目标是推导 $\\ln(CL_{i})$ 和 $\\ln(WT_{i}/70)$ 之间的线性关系。这个过程通过对等式两边取自然对数来实现。\n$$\n\\ln(CL_{i}) = \\ln\\left( \\theta_{CL} \\left(\\frac{WT_{i}}{70}\\right)^{\\beta} \\exp(\\eta_{CL,i}) \\right)\n$$\n利用对数的性质，即乘积的对数等于对数的和，$\\ln(a \\cdot b \\cdot c) = \\ln(a) + \\ln(b) + \\ln(c)$，我们可以展开右边部分：\n$$\n\\ln(CL_{i}) = \\ln(\\theta_{CL}) + \\ln\\left( \\left(\\frac{WT_{i}}{70}\\right)^{\\beta} \\right) + \\ln(\\exp(\\eta_{CL,i}))\n$$\n接下来，我们应用对数的另外两个性质。首先，对第二项应用幂律法则，$\\ln(x^{p}) = p \\ln(x)$。其次，对第三项应用自然对数是指数函数的反函数的性质，$\\ln(\\exp(x)) = x$。由此得到：\n$$\n\\ln(CL_{i}) = \\ln(\\theta_{CL}) + \\beta \\ln\\left(\\frac{WT_{i}}{70}\\right) + \\eta_{CL,i}\n$$\n这个方程代表一个线性模型。一般的线性回归模型形式如下：\n$$\nY = \\text{Intercept} + (\\text{Slope}) \\cdot X + \\text{Error}\n$$\n通过将我们推导出的方程与此通用形式进行比较，我们可以确定相应的组成部分：\n- 因变量 $Y$ 是 $\\ln(CL_{i})$。\n- 自变量 $X$ 是 $\\ln(WT_{i}/70)$。\n- 可加误差项是 $\\eta_{CL,i}$，这与问题的假设一致，因为 $\\eta_{CL,i}$ 是一个均值为 $0$ 的随机变量。\n- 截距是常数项，对应于 $\\ln(\\theta_{CL})$。\n- 斜率是自变量的系数，对应于 $\\beta$。\n\n问题指定假设具有生理学动机的异速生长指数 $\\beta = 0.75$。将此值代入斜率，我们得到：\n斜率 $= \\beta = 0.75$。\n截距保持其符号形式 $\\ln(\\theta_{CL})$，因为没有提供典型清除率 $\\theta_{CL}$ 的值。\n\n因此，对数-线性表达式的回归截距和斜率分别为 $\\ln(\\theta_{CL})$ 和 $0.75$。", "answer": "$$\\boxed{\\begin{pmatrix} \\ln(\\theta_{CL})  0.75 \\end{pmatrix}}$$", "id": "4568900"}, {"introduction": "本练习将深入探讨非线性混合效应模型的统计核心，即参数估计算法的基础。通过从高斯概率密度函数的基本定义出发，推导给定个体数据的条件对数似然函数以及经验贝叶斯估计 (Empirical Bayes Estimates, EBEs) 的目标函数，您将揭示模型如何权衡群体信息（先验分布）和个体数据（似然）来估算每个受试者的特异性参数。[@problem_id:4568879]", "problem": "考虑临床药理学中的一个非线性混合效应模型，其中个体 $i$ 在采样时间 $\\{t_{ij}\\}_{j=1}^{n_i}$ 的响应遵循结构关系 $y_{ij} = f(t_{ij},\\phi_i) + \\epsilon_{ij}$，测量噪声 $\\epsilon_{ij}$ 被建模为均值为 $0$、方差为 $\\sigma^2$ 的高斯随机变量的独立实现，即对所有 $j$ 都有 $\\epsilon_{ij} \\sim \\mathcal{N}(0,\\sigma^2)$。个体特异性参数向量 $\\phi_i \\in \\mathbb{R}^{p}$ 由一个可微连接函数 $\\Lambda(\\theta,\\eta_i)$ 决定，其中 $\\theta \\in \\mathbb{R}^{m}$ 是一个固定效应参数向量，$\\eta_i \\in \\mathbb{R}^{q}$ 是个体随机效应向量，建模为 $\\eta_i \\sim \\mathcal{N}(0,\\Omega)$，其中 $\\Omega \\in \\mathbb{R}^{q \\times q}$ 是一个正定协方差矩阵。假设给定 $\\phi_i$ 时，观测值 $y_{ij}$ 条件独立，并且 $f(t,\\phi)$ 在 $\\phi$ 上连续可微。\n\n仅从高斯概率密度函数和条件独立性的定义出发，并援引贝叶斯定理，推导在给定 $\\phi_i$ 和固定效应参数 $\\theta$ 的情况下，观测值 $\\{y_{ij}\\}_{j=1}^{n_i}$ 的个体条件对数似然 $\\ell_i(\\theta,\\phi_i)$。然后，利用 $\\eta_i$ 的先验和连接函数 $\\phi_i=\\Lambda(\\theta,\\eta_i)$，推导 $\\eta_i$ 的后验目标函数，该函数的最小化子产生个体 $i$ 随机效应的经验贝叶斯（EB）估计，并将此EB估计量表示为关于 $\\eta_i$ 的优化问题。\n\n将你的最终答案表示为一个单行矩阵，其第一个条目是推导出的条件对数似然 $\\ell_i(\\theta,\\phi_i)$ 的解析表达式（包括加法常数），第二个条目是 $\\eta_i$ 的EB估计量作为优化问题的解析表达式。不需要进行数值计算。最终答案中不要包含任何文本或单位。", "solution": "该问题是有效的，因为它科学地基于非线性混合效应模型的既定理论，信息充分、问题适定，可进行唯一推导，并使用了客观、正式的语言。我们着手求解。\n\n推导过程包括两个主要部分：首先，是个体观测值的条件对数似然；其次，是该个体随机效应的经验贝叶斯（EB）估计的目标函数。\n\n**第1部分：条件对数似然 $\\ell_i(\\theta, \\phi_i)$ 的推导**\n\n问题陈述了第 $i$ 个个体在第 $j$ 次观测的结构模型是 $y_{ij} = f(t_{ij},\\phi_i) + \\epsilon_{ij}$。测量误差 $\\epsilon_{ij}$ 被假定为来自均值为 $0$、方差为 $\\sigma^2$ 的高斯分布的独立实现，记作 $\\epsilon_{ij} \\sim \\mathcal{N}(0, \\sigma^2)$。\n\n根据这个定义，给定个体特异性参数向量 $\\phi_i$ 的情况下，观测值 $y_{ij}$ 的条件分布也是高斯分布。该分布的均值是结构模型的预测值 $f(t_{ij}, \\phi_i)$，方差是 $\\sigma^2$。因此，我们可以写出：\n$$y_{ij} | \\phi_i \\sim \\mathcal{N}(f(t_{ij}, \\phi_i), \\sigma^2)$$\n\n单个观测值 $y_{ij}$ 在以 $\\phi_i$ 为条件下的概率密度函数（PDF）由高斯PDF的公式给出：\n$$p(y_{ij} | \\phi_i) = \\frac{1}{\\sqrt{2\\pi\\sigma^2}} \\exp\\left( -\\frac{(y_{ij} - f(t_{ij}, \\phi_i))^2}{2\\sigma^2} \\right)$$\n\n问题陈述，给定 $\\phi_i$ 时，个体 $i$ 的观测值 $\\{y_{ij}\\}_{j=1}^{n_i}$ 是条件独立的。因此，个体 $i$ 的所有 $n_i$ 个观测值（记作 $y_i = \\{y_{i1}, y_{i2}, \\dots, y_{in_i}\\}$）的联合条件似然是各个PDF的乘积：\n$$L_i(\\phi_i | y_i) = p(y_i | \\phi_i) = \\prod_{j=1}^{n_i} p(y_{ij} | \\phi_i)$$\n代入高斯PDF的表达式，我们得到：\n$$L_i(\\phi_i | y_i) = \\prod_{j=1}^{n_i} \\left[ \\frac{1}{\\sqrt{2\\pi\\sigma^2}} \\exp\\left( -\\frac{(y_{ij} - f(t_{ij}, \\phi_i))^2}{2\\sigma^2} \\right) \\right]$$\n这可以通过合并各项来简化：\n$$L_i(\\phi_i | y_i) = \\left( \\frac{1}{\\sqrt{2\\pi\\sigma^2}} \\right)^{n_i} \\exp\\left( -\\sum_{j=1}^{n_i} \\frac{(y_{ij} - f(t_{ij}, \\phi_i))^2}{2\\sigma^2} \\right)$$\n$$L_i(\\phi_i | y_i) = (2\\pi\\sigma^2)^{-n_i/2} \\exp\\left( -\\frac{1}{2\\sigma^2} \\sum_{j=1}^{n_i} (y_{ij} - f(t_{ij}, \\phi_i))^2 \\right)$$\n\n条件对数似然 $\\ell_i$ 是条件似然 $L_i$ 的自然对数。问题要求的是 $\\ell_i(\\theta, \\phi_i)$。我们注意到，以 $\\phi_i$ 为条件使得数据 $y_i$ 的似然独立于固定效应 $\\theta$，所以 $p(y_i | \\phi_i, \\theta) = p(y_i | \\phi_i)$。\n$$\\ell_i(\\phi_i) = \\ln(L_i(\\phi_i | y_i)) = \\ln\\left[ (2\\pi\\sigma^2)^{-n_i/2} \\exp\\left( -\\frac{1}{2\\sigma^2} \\sum_{j=1}^{n_i} (y_{ij} - f(t_{ij}, \\phi_i))^2 \\right) \\right]$$\n利用对数的性质 $\\ln(ab) = \\ln(a) + \\ln(b)$ 和 $\\ln(e^x) = x$，我们得到：\n$$\\ell_i(\\phi_i) = \\ln((2\\pi\\sigma^2)^{-n_i/2}) - \\frac{1}{2\\sigma^2} \\sum_{j=1}^{n_i} (y_{ij} - f(t_{ij}, \\phi_i))^2$$\n$$\\ell_i(\\phi_i) = -\\frac{n_i}{2} \\ln(2\\pi\\sigma^2) - \\frac{1}{2\\sigma^2} \\sum_{j=1}^{n_i} (y_{ij} - f(t_{ij}, \\phi_i))^2$$\n这就是个体 $i$ 的条件对数似然，包括所有加法常数。\n\n**第2部分：经验贝叶斯（EB）估计量目标函数的推导**\n\n随机效应向量 $\\eta_i$ 的经验贝叶斯估计是其后验众数，即最大化后验概率密度 $p(\\eta_i | y_i, \\theta, \\Omega, \\sigma^2)$ 的 $\\eta_i$ 值。在此估计步骤中，参数 $\\theta$、$\\Omega$ 和 $\\sigma^2$ 被视为固定的已知量。\n\n使用贝叶斯定理，后验密度与似然和先验的乘积成正比：\n$$p(\\eta_i | y_i, \\theta, \\Omega, \\sigma^2) \\propto p(y_i | \\eta_i, \\theta, \\sigma^2) \\cdot p(\\eta_i | \\Omega)$$\n\n第一项 $p(y_i | \\eta_i, \\theta, \\sigma^2)$ 是给定随机效应的数据似然。由于个体参数 $\\phi_i$ 是 $\\eta_i$ 和 $\\theta$ 通过连接函数 $\\phi_i = \\Lambda(\\theta, \\eta_i)$ 的确定性函数，我们有 $p(y_i | \\eta_i, \\theta, \\sigma^2) = p(y_i | \\phi_i = \\Lambda(\\theta, \\eta_i), \\sigma^2)$。我们可以通过代入 $\\phi_i = \\Lambda(\\theta, \\eta_i)$ 来使用第1部分推导出的似然：\n$$p(y_i | \\eta_i, \\theta, \\sigma^2) = (2\\pi\\sigma^2)^{-n_i/2} \\exp\\left( -\\frac{1}{2\\sigma^2} \\sum_{j=1}^{n_i} (y_{ij} - f(t_{ij}, \\Lambda(\\theta, \\eta_i)))^2 \\right)$$\n\n第二项 $p(\\eta_i | \\Omega)$ 是随机效应的先验密度。我们已知 $\\eta_i \\sim \\mathcal{N}(0, \\Omega)$。对于一个 $q$ 维多元正态分布，其PDF为：\n$$p(\\eta_i | \\Omega) = \\frac{1}{\\sqrt{(2\\pi)^q \\det(\\Omega)}} \\exp\\left( -\\frac{1}{2}\\eta_i^T \\Omega^{-1} \\eta_i \\right)$$\n其中 $\\det(\\Omega)$ 是协方差矩阵 $\\Omega$ 的行列式。\n\n最大化后验 $p(\\eta_i | y_i, \\dots)$ 等价于最大化其对数 $\\ln(p(\\eta_i | y_i, \\dots))$，这又等价于最小化其负对数。\n$$\\ln(p(\\eta_i | y_i, \\dots)) = \\ln(p(y_i | \\eta_i, \\dots)) + \\ln(p(\\eta_i | \\dots)) + C$$\n其中 $C$ 是一个不依赖于 $\\eta_i$ 的常数。\n$$-\\ln(p(\\eta_i | y_i, \\dots)) = -\\ln(p(y_i | \\eta_i, \\dots)) - \\ln(p(\\eta_i | \\dots)) - C$$\n代入对数PDF的表达式：\n$$-\\ln(p(\\eta_i | y_i, \\dots)) = \\left[ \\frac{n_i}{2} \\ln(2\\pi\\sigma^2) + \\frac{1}{2\\sigma^2} \\sum_{j=1}^{n_i} (y_{ij} - f(t_{ij}, \\Lambda(\\theta, \\eta_i)))^2 \\right] + \\left[ \\frac{1}{2}\\ln((2\\pi)^q \\det(\\Omega)) + \\frac{1}{2}\\eta_i^T \\Omega^{-1} \\eta_i \\right] - C$$\n为了找到最小化此表达式的 $\\eta_i$ 值，我们可以舍去所有相对于 $\\eta_i$ 是常数的项。这给出了需要最小化的目标函数 $O_i(\\eta_i)$：\n$$O_i^{\\text{unscaled}}(\\eta_i) = \\frac{1}{2\\sigma^2} \\sum_{j=1}^{n_i} (y_{ij} - f(t_{ij}, \\Lambda(\\theta, \\eta_i)))^2 + \\frac{1}{2}\\eta_i^T \\Omega^{-1} \\eta_i$$\n最小化 $O_i^{\\text{unscaled}}(\\eta_i)$ 等价于最小化它的任何正常数倍。习惯上使用一个乘以因子 $2$ 的目标函数，我们将其表示为 $O_i(\\eta_i)$：\n$$O_i(\\eta_i) = 2 \\cdot O_i^{\\text{unscaled}}(\\eta_i) = \\frac{1}{\\sigma^2} \\sum_{j=1}^{n_i} (y_{ij} - f(t_{ij}, \\Lambda(\\theta, \\eta_i)))^2 + \\eta_i^T \\Omega^{-1} \\eta_i$$\n这就是后验目标函数。第一项是加权残差平方和，第二项是使随机效应向其先验均值零收缩的惩罚项。\n\n$\\eta_i$ 的经验贝叶斯估计量，记作 $\\hat{\\eta}_i^{EB}$，是最小化此目标函数的优化问题的解：\n$$\\hat{\\eta}_i^{EB} = \\arg\\min_{\\eta_i \\in \\mathbb{R}^q} O_i(\\eta_i)$$\n具体来说，该估计量表示为以下优化问题：\n$$\\hat{\\eta}_i^{EB} = \\arg\\min_{\\eta_i \\in \\mathbb{R}^q} \\left\\{ \\frac{1}{\\sigma^2} \\sum_{j=1}^{n_i} (y_{ij} - f(t_{ij}, \\Lambda(\\theta, \\eta_i)))^2 + \\eta_i^T \\Omega^{-1} \\eta_i \\right\\}$$\n至此，推导完成。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n-\\frac{n_i}{2} \\ln(2\\pi\\sigma^2) - \\frac{1}{2\\sigma^2} \\sum_{j=1}^{n_i} (y_{ij} - f(t_{ij},\\phi_i))^2  \\arg\\min_{\\eta_i \\in \\mathbb{R}^q} \\left\\{ \\frac{1}{\\sigma^2} \\sum_{j=1}^{n_i} (y_{ij} - f(t_{ij}, \\Lambda(\\theta, \\eta_i)))^2 + \\eta_i^T \\Omega^{-1} \\eta_i \\right\\}\n\\end{pmatrix}\n}\n$$", "id": "4568879"}, {"introduction": "模型诊断是确保模型可靠性的关键步骤，而条件加权残差 (Conditionally Weighted Residuals, CWRES) 是其中一项重要的诊断工具。本练习将理论与实践相结合，要求您不仅要应用模型进行预测，还要使用一阶灵敏度（Delta 方法）来近似预测中的不确定性，最终计算出 CWRES。这个综合性练习将全面检验您对模型结构、随机效应和残差误差模型的理解，是连接理论与实际应用的重要桥梁。[@problem_id:4568868]", "problem": "在临床药理学中，考虑一个用于单室系统静脉推注剂量的非线性混合效应模型。对于个体 $i$ 在采样时间 $t_{ij}$，其结构浓度预测由经过充分检验的单室公式给出\n$$\nC_{ij} = \\frac{D_i}{V_i}\\exp\\!\\left(-\\frac{CL_i}{V_i}\\,t_{ij}\\right),\n$$\n其中 $D_i$ 是给药剂量，$CL_i$ 是清除率，$V_i$ 是分布容积。个体间变异由对数正态随机效应表示，\n$$\nCL_i = CL_{\\text{pop}}\\exp(\\eta_{CL,i}),\\quad V_i = V_{\\text{pop}}\\exp(\\eta_{V,i}),\n$$\n其中 $CL_{\\text{pop}}$ 和 $V_{\\text{pop}}$ 是群体参数，$(\\eta_{CL,i},\\eta_{V,i})$ 是个体特异性随机效应，其条件均值（经验贝叶斯估计，EBE）用于预测，其条件协方差矩阵表示为 $S_i \\in \\mathbb{R}^{2\\times 2}$。观测模型是一个组合的比例-加性残差模型，\n$$\ny_{ij} = C_{ij}\\left(1+\\epsilon_{p,ij}\\right) + \\epsilon_{a,ij},\n$$\n其中 $\\epsilon_{p,ij}\\sim \\mathcal{N}(0,\\sigma_p^2)$ 和 $\\epsilon_{a,ij}\\sim \\mathcal{N}(0,\\sigma_a^2)$，它们相互独立，且与随机效应无关。所有浓度必须以 $\\mathrm{mg/L}$ 表示，剂量以 $\\mathrm{mg}$ 表示，清除率以 $\\mathrm{L/h}$ 表示，容积以 $\\mathrm{L}$ 表示，时间以 $\\mathrm{h}$ 表示。\n\n条件加权残差（CWRES）对每个观测值的定义是：残差通过给定模型和数据下观测值的条件方差的平方根进行归一化。为了以科学上合理的方式估计条件方差，使用一阶灵敏度（Delta 方法）近似：如果 $C_{ij}$ 依赖于具有条件协方差 $S_i$ 的不确定参数 $\\boldsymbol{\\eta}_i = (\\eta_{CL,i}, \\eta_{V,i})^\\top$，则\n$$\n\\mathrm{Var}\\!\\left[C_{ij}\\mid \\text{data}\\right] \\approx \\nabla_{\\boldsymbol{\\eta}} C_{ij}^\\top S_i \\nabla_{\\boldsymbol{\\eta}} C_{ij} \\;+\\; \\mathrm{Var}\\!\\left[\\epsilon_{p,ij}\\right]\\cdot C_{ij}^2 \\;+\\; \\mathrm{Var}\\!\\left[\\epsilon_{a,ij}\\right].\n$$\n梯度 $\\nabla_{\\boldsymbol{\\eta}} C_{ij}$ 必须根据第一性原理，使用链式法则和上述结构模型定义推导得出。\n\n您的任务是编写一个完整的程序，该程序能够：\n- 根据 $CL_{\\text{pop}}$、$V_{\\text{pop}}$ 和提供的 EBE 值 $(\\eta_{CL,i},\\eta_{V,i})$ 计算 $CL_i$ 和 $V_i$。\n- 为每个采样时间 $t_{ij}$ 计算 $C_{ij}$。\n- 推导 $\\nabla_{\\boldsymbol{\\eta}} C_{ij}$ 并使用 Delta 方法和提供的 $S_i$ 来估计条件方差。\n- 为每个观测值 $y_{ij}$ 计算 CWRES，其公式为 $(y_{ij}-C_{ij})/\\sqrt{\\mathrm{Var}[y_{ij}\\mid \\text{data}]}$。\n- 生成单行输出，其中包含所有 CWRES 值，形式为方括号括起来的逗号分隔列表，每个数值四舍五入到 $6$ 位小数。CWRES 是无量纲的。\n\n使用以下测试套件，其涵盖一个通用情况、一个边界条件和一个边缘情况：\n- 案例 $1$（通用“理想路径”）：\n  - $D_1 = 100\\ \\mathrm{mg}$，$CL_{\\text{pop}} = 5\\ \\mathrm{L/h}$，$V_{\\text{pop}} = 50\\ \\mathrm{L}$。\n  - $\\eta_{CL,1} = 0.1$，$\\eta_{V,1} = -0.05$ (EBE)。\n  - $S_1 = \\begin{pmatrix} 0.04  0.01 \\\\ 0.01  0.03 \\end{pmatrix}$。\n  - 采样时间 $t_{1j}\\in \\{0.5, 2.0, 8.0\\}\\ \\mathrm{h}$。\n  - 观测值 $y_{1j}\\in \\{2.06, 1.62, 0.80\\}\\ \\mathrm{mg/L}$。\n  - $\\sigma_p = 0.15$（无量纲），$\\sigma_a = 0.05\\ \\mathrm{mg/L}$。\n- 案例 $2$（零时间点的边界条件）：\n  - $D_2 = 200\\ \\mathrm{mg}$，$CL_{\\text{pop}} = 3\\ \\mathrm{L/h}$，$V_{\\text{pop}} = 40\\ \\mathrm{L}$。\n  - $\\eta_{CL,2} = 0.0$，$\\eta_{V,2} = 0.0$ (EBE)。\n  - $S_2 = \\begin{pmatrix} 0.0001  0.0 \\\\ 0.0  0.0001 \\end{pmatrix}$。\n  - 采样时间 $t_{2j}\\in \\{0.0, 1.0\\}\\ \\mathrm{h}$。\n  - 观测值 $y_{2j}\\in \\{5.05, 4.60\\}\\ \\mathrm{mg/L}$。\n  - $\\sigma_p = 0.10$（无量纲），$\\sigma_a = 0.02\\ \\mathrm{mg/L}$。\n- 案例 $3$（比例误差为零且 $\\boldsymbol{\\eta}$ 相关的边缘情况）：\n  - $D_3 = 50\\ \\mathrm{mg}$，$CL_{\\text{pop}} = 10\\ \\mathrm{L/h}$，$V_{\\text{pop}} = 20\\ \\mathrm{L}$。\n  - $\\eta_{CL,3} = -0.2$，$\\eta_{V,3} = 0.2$ (EBE)。\n  - $S_3 = \\begin{pmatrix} 0.05  -0.02 \\\\ -0.02  0.07 \\end{pmatrix}$。\n  - 采样时间 $t_{3j}\\in \\{0.5, 3.0\\}\\ \\mathrm{h}$。\n  - 观测值 $y_{3j}\\in \\{2.35, 0.60\\}\\ \\mathrm{mg/L}$。\n  - $\\sigma_p = 0.00$（无量纲），$\\sigma_a = 0.10\\ \\mathrm{mg/L}$。\n\n您的程序应生成单行输出，其中包含按上述顺序列出的所有观测值的 CWRES（逐个案例，每个案例内按时间顺序），形式为方括号括起来的逗号分隔列表，每个数值四舍五入到 $6$ 位小数（例如 $[x_1,x_2,\\dots]$）。", "solution": "该问题是有效的。这是一个在临床药理学领域中定义明确、有科学依据的问题，内容自洽且无矛盾。所用的模型、参数和数据在药代动力学计量学领域是标准的，并与基本原理一致。所有提供的协方差矩阵都是正定的。该任务要求严格应用已建立的数学和统计方法。\n\n目标是为一系列药代动力学观测值计算条件加权残差（CWRES）。计算从基本模型定义开始，按顺序分步执行。\n\n基础模型由三个部分组成：描述药物浓度随时间变化的结构模型，关键参数的个体间变异模型，以及观测值的残差模型。\n对于个体 $i$，在时间 $t_{ij}$ 时，静脉推注剂量 $D_i$ 后的药物浓度 $C_{ij}$ 的结构模型由单室模型给出：\n$$\nC_{ij} = \\frac{D_i}{V_i}\\exp\\left(-\\frac{CL_i}{V_i}t_{ij}\\right)\n$$\n参数清除率（$CL_i$）和分布容积（$V_i$）在个体之间存在差异。这种变异性围绕群体典型值（$CL_{\\text{pop}}$，$V_{\\text{pop}}$）进行对数正态建模：\n$$\nCL_i = CL_{\\text{pop}}\\exp(\\eta_{CL,i})\n$$\n$$\nV_i = V_{\\text{pop}}\\exp(\\eta_{V,i})\n$$\n这里，$\\eta_{CL,i}$ 和 $\\eta_{V,i}$ 是个体特异性随机效应，我们使用它们的条件均值（经验贝叶斯估计，EBEs）进行预测。\n\n观测浓度 $y_{ij}$ 通过一个组合的比例和加性误差模型与真实（结构）浓度 $C_{ij}$ 相关联：\n$$\ny_{ij} = C_{ij}(1+\\epsilon_{p,ij}) + \\epsilon_{a,ij}\n$$\n其中 $\\epsilon_{p,ij} \\sim \\mathcal{N}(0, \\sigma_p^2)$ 和 $\\epsilon_{a,ij} \\sim \\mathcal{N}(0, \\sigma_a^2)$ 分别代表独立的、服从正态分布的比例和加性误差项。\n\nCWRES 定义为观测浓度与预测浓度之差，通过观测值的条件标准差的估计值进行归一化。CWRES 的公式是：\n$$\n\\text{CWRES}_{ij} = \\frac{y_{ij} - C_{ij}}{\\sqrt{\\mathrm{Var}[y_{ij} \\mid \\text{data}]}}\n$$\n其中 $C_{ij}$ 是使用 $\\boldsymbol{\\eta}_i = (\\eta_{CL,i}, \\eta_{V,i})^\\top$ 的 EBEs 计算的。条件方差 $\\mathrm{Var}[y_{ij} \\mid \\text{data}]$ 解释了两个变异来源：个体参数 $\\boldsymbol{\\eta}_i$ 的不确定性和残差未解释变异（测量误差）。\n\n总条件方差使用一阶泰勒展开（Delta 方法）来近似。它是参数不确定性引起的方差与残差方差之和：\n$$\n\\mathrm{Var}[y_{ij} \\mid \\text{data}] \\approx \\nabla_{\\boldsymbol{\\eta}} C_{ij}^\\top S_i \\nabla_{\\boldsymbol{\\eta}} C_{ij} + \\mathrm{Var}\\left[C_{ij}\\epsilon_{p,ij} + \\epsilon_{a,ij}\\right]\n$$\n鉴于误差项的独立性，残差方差分量为：\n$$\n\\mathrm{Var}\\left[C_{ij}\\epsilon_{p,ij} + \\epsilon_{a,ij}\\right] = C_{ij}^2 \\mathrm{Var}[\\epsilon_{p,ij}] + \\mathrm{Var}[\\epsilon_{a,ij}] = C_{ij}^2\\sigma_p^2 + \\sigma_a^2\n$$\n项 $\\nabla_{\\boldsymbol{\\eta}} C_{ij}$ 是结构模型 $C_{ij}$ 关于随机效应 $\\boldsymbol{\\eta}_i$ 的梯度（一阶偏导数向量），在 EBEs 处求值。$S_i$ 是 EBEs 的条件协方差矩阵。\n\n关键步骤是推导梯度 $\\nabla_{\\boldsymbol{\\eta}} C_{ij} = \\left(\\frac{\\partial C_{ij}}{\\partial \\eta_{CL,i}}, \\frac{\\partial C_{ij}}{\\partial \\eta_{V,i}}\\right)^\\top$。我们应用链式法则。\n\n让我们推导第一个分量，$\\frac{\\partial C_{ij}}{\\partial \\eta_{CL,i}}$：\n$$\n\\frac{\\partial C_{ij}}{\\partial \\eta_{CL,i}} = \\frac{\\partial C_{ij}}{\\partial CL_i} \\frac{\\partial CL_i}{\\partial \\eta_{CL,i}}\n$$\n$CL_i$ 关于 $\\eta_{CL,i}$ 的导数是：\n$$\n\\frac{\\partial CL_i}{\\partial \\eta_{CL,i}} = \\frac{\\partial}{\\partial \\eta_{CL,i}} \\left(CL_{\\text{pop}}\\exp(\\eta_{CL,i})\\right) = CL_{\\text{pop}}\\exp(\\eta_{CL,i}) = CL_i\n$$\n$C_{ij}$ 关于 $CL_i$ 的导数是：\n$$\n\\frac{\\partial C_{ij}}{\\partial CL_i} = \\frac{\\partial}{\\partial CL_i} \\left(\\frac{D_i}{V_i}\\exp\\left(-\\frac{CL_i}{V_i}t_{ij}\\right)\\right) = \\frac{D_i}{V_i} \\exp\\left(-\\frac{CL_i}{V_i}t_{ij}\\right) \\cdot \\left(-\\frac{t_{ij}}{V_i}\\right) = -C_{ij}\\frac{t_{ij}}{V_i}\n$$\n将它们组合起来，我们得到：\n$$\n\\frac{\\partial C_{ij}}{\\partial \\eta_{CL,i}} = \\left(-C_{ij}\\frac{t_{ij}}{V_i}\\right) \\cdot CL_i = -C_{ij}\\frac{CL_i t_{ij}}{V_i}\n$$\n现在，对于第二个分量，$\\frac{\\partial C_{ij}}{\\partial \\eta_{V,i}}$：\n$$\n\\frac{\\partial C_{ij}}{\\partial \\eta_{V,i}} = \\frac{\\partial C_{ij}}{\\partial V_i} \\frac{\\partial V_i}{\\partial \\eta_{V,i}}\n$$\n$V_i$ 关于 $\\eta_{V,i}$ 的导数是：\n$$\n\\frac{\\partial V_i}{\\partial \\eta_{V,i}} = \\frac{\\partial}{\\partial \\eta_{V,i}} \\left(V_{\\text{pop}}\\exp(\\eta_{V,i})\\right) = V_{\\text{pop}}\\exp(\\eta_{V,i}) = V_i\n$$\n$C_{ij}$ 关于 $V_i$ 的导数需要使用乘法法则，因为 $V_i$ 出现在指数前因子和指数内部：\n$$\n\\frac{\\partial C_{ij}}{\\partial V_i} = \\frac{\\partial}{\\partial V_i} \\left(D_i V_i^{-1} \\exp\\left(-\\frac{CL_i t_{ij}}{V_i}\\right)\\right)\n$$\n$$\n= D_i \\left[ (-1)V_i^{-2}\\exp\\left(-\\frac{CL_i t_{ij}}{V_i}\\right) + V_i^{-1}\\exp\\left(-\\frac{CL_i t_{ij}}{V_i}\\right) \\cdot \\left(\\frac{CL_i t_{ij}}{V_i^2}\\right) \\right]\n$$\n$$\n= \\frac{D_i}{V_i}\\exp\\left(-\\frac{CL_i t_{ij}}{V_i}\\right) \\left[ -\\frac{1}{V_i} + \\frac{CL_i t_{ij}}{V_i^2} \\right] = C_{ij} \\frac{1}{V_i}\\left(\\frac{CL_i t_{ij}}{V_i} - 1\\right)\n$$\n将它们组合起来，我们发现：\n$$\n\\frac{\\partial C_{ij}}{\\partial \\eta_{V,i}} = \\left(C_{ij} \\frac{1}{V_i}\\left(\\frac{CL_i t_{ij}}{V_i} - 1\\right)\\right) \\cdot V_i = C_{ij}\\left(\\frac{CL_i t_{ij}}{V_i} - 1\\right)\n$$\n因此，梯度向量为：\n$$\n\\nabla_{\\boldsymbol{\\eta}} C_{ij} = \\begin{pmatrix} -C_{ij} \\frac{CL_i t_{ij}}{V_i} \\\\ C_{ij}\\left(\\frac{CL_i t_{ij}}{V_i} - 1\\right) \\end{pmatrix}\n$$\n由参数不确定性引起的方差贡献是二次型 $\\text{Var}_{\\eta} = \\nabla_{\\boldsymbol{\\eta}} C_{ij}^\\top S_i \\nabla_{\\boldsymbol{\\eta}} C_{ij}$。\n\n对于每个观测值 $(y_{ij}, t_{ij})$，完整的算法如下：\n$1$. 使用群体参数和 EBEs $\\eta_{CL,i}$ 和 $\\eta_{V,i}$ 计算个体参数 $CL_i$ 和 $V_i$。\n$2$. 使用结构模型计算预测浓度 $C_{ij}$。\n$3$. 使用推导出的公式计算梯度 $\\nabla_{\\boldsymbol{\\eta}} C_{ij}$ 的分量。\n$4$. 计算由参数不确定性引起的方差：$\\text{Var}_{\\eta} = \\nabla_{\\boldsymbol{\\eta}} C_{ij}^\\top S_i \\nabla_{\\boldsymbol{\\eta}} C_{ij}$。\n$5$. 计算残差方差：$\\text{Var}_{\\epsilon} = C_{ij}^2\\sigma_p^2 + \\sigma_a^2$。\n$6$. 将方差相加得到总条件方差：$\\text{Var}_{\\text{total}} = \\text{Var}_{\\eta} + \\text{Var}_{\\epsilon}$。\n$7$. 计算 CWRES：$\\text{CWRES}_{ij} = (y_{ij} - C_{ij}) / \\sqrt{\\text{Var}_{\\text{total}}}$。\n\n此过程将应用于所提供测试套件中的所有观测值。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes Conditionally Weighted Residuals (CWRES) for a series of\n    pharmacokinetic test cases based on a one-compartment model.\n    \"\"\"\n    test_cases = [\n        {\n            \"D\": 100.0, \"CLpop\": 5.0, \"Vpop\": 50.0,\n            \"eta_CL\": 0.1, \"eta_V\": -0.05,\n            \"S\": np.array([[0.04, 0.01], [0.01, 0.03]]),\n            \"times\": [0.5, 2.0, 8.0],\n            \"obs\": [2.06, 1.62, 0.80],\n            \"sigma_p\": 0.15, \"sigma_a\": 0.05,\n        },\n        {\n            \"D\": 200.0, \"CLpop\": 3.0, \"Vpop\": 40.0,\n            \"eta_CL\": 0.0, \"eta_V\": 0.0,\n            \"S\": np.array([[0.0001, 0.0], [0.0, 0.0001]]),\n            \"times\": [0.0, 1.0],\n            \"obs\": [5.05, 4.60],\n            \"sigma_p\": 0.10, \"sigma_a\": 0.02,\n        },\n        {\n            \"D\": 50.0, \"CLpop\": 10.0, \"Vpop\": 20.0,\n            \"eta_CL\": -0.2, \"eta_V\": 0.2,\n            \"S\": np.array([[0.05, -0.02], [-0.02, 0.07]]),\n            \"times\": [0.5, 3.0],\n            \"obs\": [2.35, 0.60],\n            \"sigma_p\": 0.00, \"sigma_a\": 0.10,\n        }\n    ]\n\n    all_cwres = []\n\n    for case in test_cases:\n        # Unpack case parameters\n        D_i = case[\"D\"]\n        CL_pop = case[\"CLpop\"]\n        V_pop = case[\"Vpop\"]\n        eta_CL_i = case[\"eta_CL\"]\n        eta_V_i = case[\"eta_V\"]\n        S_i = case[\"S\"]\n        sigma_p = case[\"sigma_p\"]\n        sigma_a = case[\"sigma_a\"]\n\n        # 1. Calculate individual parameters\n        CL_i = CL_pop * np.exp(eta_CL_i)\n        V_i = V_pop * np.exp(eta_V_i)\n        \n        elimination_rate_k = CL_i / V_i\n\n        for t_ij, y_ij in zip(case[\"times\"], case[\"obs\"]):\n            # 2. Calculate predicted concentration\n            C_ij = (D_i / V_i) * np.exp(-elimination_rate_k * t_ij)\n\n            # 3. Calculate the gradient vector\n            grad_C_eta_CL = -C_ij * elimination_rate_k * t_ij\n            grad_C_eta_V = C_ij * (elimination_rate_k * t_ij - 1)\n            grad_vector = np.array([grad_C_eta_CL, grad_C_eta_V])\n\n            # 4. Compute variance from parameter uncertainty (Delta Method)\n            # Var_eta = grad^T * S * grad\n            var_eta = grad_vector.T @ S_i @ grad_vector\n\n            # 5. Compute residual error variance\n            var_epsilon = (C_ij**2) * (sigma_p**2) + (sigma_a**2)\n\n            # 6. Total conditional variance\n            total_variance = var_eta + var_epsilon\n\n            # 7. Compute CWRES\n            if total_variance > 0:\n                cwres = (y_ij - C_ij) / np.sqrt(total_variance)\n            else:\n                # Handle potential division by zero, though unlikely with valid inputs\n                cwres = np.nan \n\n            all_cwres.append(cwres)\n\n    # Round results to 6 decimal places\n    rounded_results = [round(r, 6) for r in all_cwres]\n    \n    # Format the final output string\n    print(f\"[{','.join(map(str, rounded_results))}]\")\n\nsolve()\n```", "id": "4568868"}]}