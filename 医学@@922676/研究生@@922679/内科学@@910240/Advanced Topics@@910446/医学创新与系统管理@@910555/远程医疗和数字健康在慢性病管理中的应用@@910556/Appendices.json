{"hands_on_practices": [{"introduction": "远程监护系统中的警报并非生而平等。虽然灵敏度（$Se$）和特异性（$Sp$）是评估诊断工具性能的核心指标，但它们并不直接告诉我们一个警报在临床实践中的真正价值。此项练习 [@problem_id:4903372] 将指导您运用贝叶斯定理，计算阳性预测值（PPV）和阴性预测值（NPV），从而深入理解疾病患病率如何影响警报的实际效用，并评估其对临床工作负荷（如警报疲劳）的具体影响。", "problem": "一家医院的心力衰竭远程监测项目使用单一的二元决策规则，在未来 $7$ 天内为可能发生的失代偿触发远程护士警报。该规则评估每日的远程数据流，并将患者分类为“警报” ($T^{+}$) 或“无警报” ($T^{-}$)。在一个高风险队列中，真实发生的失代偿的7天患病率为 $p = 0.10$。该规则的操作特性为灵敏度 $Se = 0.85$ 和特异度 $Sp = 0.90$。\n\n从灵敏度和特异度的核心概率定义出发，并应用贝叶斯定理于诊断分类，推导阳性预测值（PPV；给定警报后发生失代偿的概率）和阴性预测值（NPV；给定无警报后不发生失代偿的概率）的表达式。然后，根据给定的参数计算PPV和NPV的数值。\n\n最后，在一个包含 $N = 1000$ 名受监测患者的队列中，根据您推导出的量和关于预期警报量及其构成的概率论第一性原理，解读对远程护士工作量的影响，期间不使用任何非推导的“快捷”公式。\n\n将PPV和NPV表示为四舍五入到四位有效数字的小数。不要使用百分号。", "solution": "该问题陈述是概率论（特别是贝叶斯定理）在医学诊断领域的有效应用。它具有科学依据、提法明确且客观。所有必要的数据均已提供，没有矛盾或歧义。\n\n设 $D^{+}$ 为患者真正经历即将发生的失代偿的事件， $D^{-}$ 为患者未经历该情况的事件。设 $T^{+}$ 为远程监测规则触发警报的事件， $T^{-}$ 为未触发警报的事件。\n\n从问题陈述中，我们得到以下概率：\n即将发生的失代偿的患病率为 $P(D^{+}) = p = 0.10$。\n由此，患者不发生失代偿的概率为 $P(D^{-}) = 1 - P(D^{+}) = 1 - p = 1 - 0.10 = 0.90$。\n\n该测试的灵敏度是在患者确实发生失代偿的情况下出现警报的概率：\n$Se = P(T^{+} | D^{+}) = 0.85$。\n其互补概率，即假阴性率 (FNR)，为 $P(T^{-} | D^{+}) = 1 - Se = 1 - 0.85 = 0.15$。\n\n该测试的特异度是在患者未发生失代偿的情况下没有警报的概率：\n$Sp = P(T^{-} | D^{-}) = 0.90$。\n其互补概率，即假阳性率 (FPR)，为 $P(T^{+} | D^{-}) = 1 - Sp = 1 - 0.90 = 0.10$。\n\n题目要求推导阳性预测值 (PPV) 和阴性预测值 (NPV)。\n\n**1. 阳性预测值 (PPV) 的推导与计算**\n\nPPV 是指在警报被触发的情况下，患者确实正在发生失代偿的概率，即 $P(D^{+} | T^{+})$。\n根据贝叶斯定理，其公式为：\n$$PPV = P(D^{+} | T^{+}) = \\frac{P(T^{+} | D^{+}) P(D^{+})}{P(T^{+})}$$\n分母 $P(T^{+})$ 是警报的总概率。它可以通过全概率公式计算，即对患者的两种互斥状态（$D^{+}$ 和 $D^{-}$）进行求和：\n$$P(T^{+}) = P(T^{+} | D^{+}) P(D^{+}) + P(T^{+} | D^{-}) P(D^{-})$$\n将灵敏度、特异度和患病率的变量代入：\n$$P(T^{+}) = (Se)(p) + (1-Sp)(1-p)$$\n现在，将 $P(T^{+})$ 的这个表达式代回 PPV 的公式，我们得到推导出的表达式：\n$$PPV = \\frac{Se \\cdot p}{Se \\cdot p + (1-Sp)(1-p)}$$\n现在我们使用给定的参数计算其数值：$p=0.10$，$Se=0.85$，以及 $Sp=0.90$。\n$$PPV = \\frac{(0.85)(0.10)}{(0.85)(0.10) + (1-0.90)(1-0.10)}$$\n$$PPV = \\frac{0.085}{0.085 + (0.10)(0.90)}$$\n$$PPV = \\frac{0.085}{0.085 + 0.090}$$\n$$PPV = \\frac{0.085}{0.175} \\approx 0.485714$$\n四舍五入到四位有效数字，PPV 为 $0.4857$。\n\n**2. 阴性预测值 (NPV) 的推导与计算**\n\nNPV 是指在没有警报被触发的情况下，患者确实未发生失代偿的概率，即 $P(D^{-} | T^{-})$。\n使用贝叶斯定理：\n$$NPV = P(D^{-} | T^{-}) = \\frac{P(T^{-} | D^{-}) P(D^{-})}{P(T^{-})}$$\n分母 $P(T^{-})$ 是无警报的总概率。使用全概率公式：\n$$P(T^{-}) = P(T^{-} | D^{-}) P(D^{-}) + P(T^{-} | D^{+}) P(D^{+})$$\n将灵敏度、特异度和患病率的变量代入：\n$$P(T^{-}) = (Sp)(1-p) + (1-Se)(p)$$\n将 $P(T^{-})$ 的这个表达式代回 NPV 的公式，我们得到推导出的表达式：\n$$NPV = \\frac{Sp \\cdot (1-p)}{Sp \\cdot (1-p) + (1-Se) \\cdot p}$$\n现在我们计算其数值：\n$$NPV = \\frac{(0.90)(1-0.10)}{(0.90)(1-0.10) + (1-0.85)(0.10)}$$\n$$NPV = \\frac{(0.90)(0.90)}{(0.90)(0.90) + (0.15)(0.10)}$$\n$$NPV = \\frac{0.81}{0.81 + 0.015}$$\n$$NPV = \\frac{0.81}{0.825} \\approx 0.981818$$\n四舍五入到四位有效数字，NPV 为 $0.9818$。\n\n**3. 对护士工作量的影响**\n\n为了分析在一个包含 $N=1000$ 名患者的队列中、在为期7天的时间段内对工作量的影响，我们从第一性原理出发，通过计算每个类别中的预期患者数量来进行推理。\n\n首先，我们确定真正发生失代偿的患者 ($D^{+}$) 和未发生失代偿的患者 ($D^{-}$) 的预期数量：\n即将发生失代偿的预期患者数量： $E[N_{D^{+}}] = N \\cdot P(D^{+}) = 1000 \\cdot 0.10 = 100$。\n不发生失代偿的预期患者数量： $E[N_{D^{-}}] = N \\cdot P(D^{-}) = 1000 \\cdot 0.90 = 900$。\n\n接下来，我们计算将生成的预期警报数量。警报由真阳性 (TP) 和假阳性 (FP) 组成。\n预期真阳性数量（来自真正患病患者的警报）：\n$E[N_{TP}] = E[N_{D^{+}}] \\cdot P(T^{+} | D^{+}) = 100 \\cdot Se = 100 \\cdot 0.85 = 85$。这些是正确识别出有风险患者的警报。\n\n预期假阳性数量（来自健康患者的警报）：\n$E[N_{FP}] = E[N_{D^{-}}] \\cdot P(T^{+} | D^{-}) = 900 \\cdot (1-Sp) = 900 \\cdot 0.10 = 90$。这些是假警报。\n\n护理人员必须调查的预期警报总数是真阳性和假阳性的总和：\n$E[N_{Alerts}] = E[N_{TP}] + E[N_{FP}] = 85 + 90 = 175$。\n\n对远程护士工作量的影响是，对于这个包含1000名患者的队列，他们可以预期在7天内接收并调查175个警报。推导出的PPV为 $0.4857$ 意味着，对于任何给定的警报，患者真正发生失代偿的几率仅为 $48.57\\%$。这在我们的预期数量中直接反映出来：真阳性警报所占的比例为 $\\frac{E[N_{TP}]}{E[N_{Alerts}]} = \\frac{85}{175} \\approx 0.4857$。\n\n这意味着超过一半的警报（175个中的90个，约占 $51.4\\%$）是假阳性。护理人员必须花费精力审查所有175个警报，以识别出其中的85个真实病例。如此大量的无需采取措施的警报会造成巨大的工作量，并可能导致一种被称为“警报疲劳”的现象，即临床人员可能对警报变得不敏感，从而可能降低系统的有效性。因此，远程监测系统的效用不仅关键地取决于其灵敏度和特异度，还取决于受监测人群中该病情的患病率，因为低患病率可能导致低PPV和大量的假警报，从而在没有相应临床益处的情况下增加了工作量。", "answer": "$$\\boxed{\\begin{pmatrix} 0.4857  0.9818 \\end{pmatrix}}$$", "id": "4903372"}, {"introduction": "连续血糖监测（CGM）等数字健康工具产生了海量的数据，为慢性病管理带来了前所未有的机遇与挑战。临床医生的核心任务之一是将这些原始数据流提炼为标准化的、具有临床意义的指标，例如范围内时间（TIR）和血糖管理指标（GMI），并据此作出治疗决策。此项练习 [@problem_id:4903517] 模拟了这一关键过程，要求您从一个假设的 CGM 数据集中计算关键性能指标，并应用一个预设的临床决策规则来调整治疗方案，从而体验从数据到决策的全过程。", "problem": "一名临床监测下的2型糖尿病成人患者正在使用连续血糖监测 (CGM)。远程医疗团队收到了一个为期$14$天的数据集，该数据集被概括为多个分段恒定的血糖片段，每个片段的血糖水平 $g_i$（单位：$\\mathrm{mg/dL}$）恒定，并持续时间 $t_i$（单位：分钟）。该数据集反映了这$14$天内所有记录的分钟数，因此 $\\sum_i t_i$ 等于$14$天的总分钟数。使用以下数据片段：\n- 片段 $1$：$g_1 = 60$，$t_1 = 520$。\n- 片段 $2$：$g_2 = 65$，$t_2 = 780$。\n- 片段 $3$：$g_3 = 75$，$t_3 = 1200$。\n- 片段 $4$：$g_4 = 90$，$t_4 = 2400$。\n- 片段 $5$：$g_5 = 110$，$t_5 = 3600$。\n- 片段 $6$：$g_6 = 140$，$t_6 = 2800$。\n- 片段 $7$：$g_7 = 160$，$t_7 = 2000$。\n- 片段 $8$：$g_8 = 175$，$t_8 = 1600$。\n- 片段 $9$：$g_9 = 185$，$t_9 = 1500$。\n- 片段 $10$：$g_{10} = 200$，$t_{10} = 1400$。\n- 片段 $11$：$g_{11} = 225$，$t_{11} = 1260$。\n- 片段 $12$：$g_{12} = 260$，$t_{12} = 400$。\n- 片段 $13$：$g_{13} = 145$，$t_{13} = 700$。\n\n使用的定义和公式：\n- 范围内时间 (TIR) 是血糖值 $70 \\leq G(t) \\leq 180$ $\\mathrm{mg/dL}$ 的时间所占的比例。\n- 低于范围时间 (TBR) 是血糖值 $G(t)  70$ $\\mathrm{mg/dL}$ 的时间所占的比例。\n- 血糖管理指标 (GMI) 根据平均血糖 $\\bar{G}$（单位：$\\mathrm{mg/dL}$）以百分比形式表示估计的糖化血红蛋白A1c，其广泛使用的经验关系式为：$\\mathrm{GMI}_{\\%} = 3.31 + 0.02392 \\times \\bar{G}$。将 $\\mathrm{GMI}$ 表示为小数形式，即除以 $100$：$\\mathrm{GMI} = \\frac{3.31 + 0.02392 \\times \\bar{G}}{100}$。\n- 数据集上的平均血糖由时间加权平均值定义：$\\bar{G} = \\frac{\\sum_i t_i g_i}{\\sum_i t_i}$。\n\n基础胰岛素调整因子 $\\Delta$（无单位的分数变化量）的远程医疗决策规则：\n- 如果 $\\mathrm{TBR} > \\theta_{\\mathrm{TBR}}$，其中 $\\theta_{\\mathrm{TBR}} = 0.05$，则 $\\Delta = -0.10$。\n- 否则，如果 $\\mathrm{TIR} \\ge \\theta_{\\mathrm{TIR}}$ 且 $\\mathrm{GMI} \\le \\theta_{\\mathrm{GMI}}$，其中 $\\theta_{\\mathrm{TIR}} = 0.70$ 且 $\\theta_{\\mathrm{GMI}} = 0.067$，则 $\\Delta = 0$。\n- 否则，$\\Delta = +0.10$。\n\n仅根据所给定义和数据集，计算 $\\mathrm{TIR}$、$\\mathrm{TBR}$ 和 $\\mathrm{GMI}$，然后应用决策规则确定基础胰岛素调整因子 $\\Delta$。仅报告 $\\Delta$ 的最终值。将您的最终答案四舍五入至四位有效数字。将最终答案表示为无单位小数（不要使用百分号）。", "solution": "问题陈述已经过严格验证，并被认为是有效的。它在临床糖尿病管理分析的背景下具有科学依据，在数学上是适定的、自洽的且内部一致的。所有必要的数据、定义和规则均已提供。关于总时间 $\\sum_i t_i$ 的约束条件已由所提供的数据片段时长满足，其总和等于14天的总分钟数：$14 \\times 24 \\times 60 = 20160$ 分钟。因此，该问题可按所述方式求解。\n\n目标是通过首先从提供的连续血糖监测 (CGM) 数据中计算三个关键指标：范围内时间 (TIR)、低于范围时间 (TBR) 和血糖管理指标 (GMI)，来计算基础胰岛素调整因子 $\\Delta$。计算按以下步骤进行。\n\n首先，我们确定监测期的总时长 $T_{total}$，即所有单个片段时长 $t_i$ 的总和。\n$$T_{total} = \\sum_{i=1}^{13} t_i = 520 + 780 + 1200 + 2400 + 3600 + 2800 + 2000 + 1600 + 1500 + 1400 + 1260 + 400 + 700 = 20160 \\text{ 分钟}$$\n这个总和正确地对应于$14$天内的总分钟数（$14 \\text{ 天} \\times 24 \\text{ 小时/天} \\times 60 \\text{ 分钟/小时} = 20160 \\text{ 分钟}$）。\n\n接下来，我们计算低于范围时间 (TBR)，其定义为血糖水平 $G(t)  70 \\text{ mg/dL}$ 的时间所占的比例。我们识别出满足此标准的片段：\n- 片段 $1$：$g_1 = 60 \\text{ mg/dL}$\n- 片段 $2$：$g_2 = 65 \\text{ mg/dL}$\n低于范围的总时间 $T_{below}$ 是这些片段时长的总和。\n$$T_{below} = t_1 + t_2 = 520 + 780 = 1300 \\text{ 分钟}$$\nTBR 是 $T_{below}$ 与 $T_{total}$ 的比值。\n$$\\mathrm{TBR} = \\frac{T_{below}}{T_{total}} = \\frac{1300}{20160} \\approx 0.064484$$\n\n第二，我们计算范围内时间 (TIR)，其定义为血糖水平 $70 \\leq G(t) \\leq 180 \\text{ mg/dL}$ 的时间所占的比例。满足此标准的片段是：\n- 片段 $3$：$g_3 = 75 \\text{ mg/dL}$\n- 片段 $4$：$g_4 = 90 \\text{ mg/dL}$\n- 片段 $5$：$g_5 = 110 \\text{ mg/dL}$\n- 片段 $6$：$g_6 = 140 \\text{ mg/dL}$\n- 片段 $7$：$g_7 = 160 \\text{ mg/dL}$\n- 片段 $8$：$g_8 = 175 \\text{ mg/dL}$\n- 片段 $13$：$g_{13} = 145 \\text{ mg/dL}$\n在范围内的总时间 $T_{in\\_range}$ 是这些片段时长的总和。\n$$T_{in\\_range} = t_3 + t_4 + t_5 + t_6 + t_7 + t_8 + t_{13} = 1200 + 2400 + 3600 + 2800 + 2000 + 1600 + 700 = 14300 \\text{ 分钟}$$\nTIR 是 $T_{in\\_range}$ 与 $T_{total}$ 的比值。\n$$\\mathrm{TIR} = \\frac{T_{in\\_range}}{T_{total}} = \\frac{14300}{20160} \\approx 0.709325$$\n\n第三，我们使用时间加权平均公式计算平均血糖 $\\bar{G}$：\n$$\\bar{G} = \\frac{\\sum_{i=1}^{13} t_i g_i}{\\sum_{i=1}^{13} t_i}$$\n分子计算如下：\n$$ \\sum_{i=1}^{13} t_i g_i = (520 \\cdot 60) + (780 \\cdot 65) + (1200 \\cdot 75) + (2400 \\cdot 90) + (3600 \\cdot 110) + (2800 \\cdot 140) + (2000 \\cdot 160) + (1600 \\cdot 175) + (1500 \\cdot 185) + (1400 \\cdot 200) + (1260 \\cdot 225) + (400 \\cdot 260) + (700 \\cdot 145) $$\n$$ \\sum t_i g_i = 31200 + 50700 + 90000 + 216000 + 396000 + 392000 + 320000 + 280000 + 277500 + 280000 + 283500 + 104000 + 101500 = 2822400 $$\n因此，平均血糖为：\n$$\\bar{G} = \\frac{2822400}{20160} = 140 \\text{ mg/dL}$$\n\n第四，我们使用所提供的公式和已计算出的平均血糖 $\\bar{G} = 140 \\text{ mg/dL}$ 来计算血糖管理指标 (GMI)。\n$$\\mathrm{GMI} = \\frac{3.31 + 0.02392 \\times \\bar{G}}{100} = \\frac{3.31 + 0.02392 \\times 140}{100}$$\n$$\\mathrm{GMI} = \\frac{3.31 + 3.3488}{100} = \\frac{6.6588}{100} = 0.066588$$\n\n最后，我们应用远程医疗决策规则来确定基础胰岛素调整因子 $\\Delta$。规则按顺序进行评估。\n1.  **规则 1：** 如果 $\\mathrm{TBR} > \\theta_{\\mathrm{TBR}}$，其中 $\\theta_{\\mathrm{TBR}} = 0.05$，则 $\\Delta = -0.10$。\n    我们得到 $\\mathrm{TBR} \\approx 0.064484$。条件是 $0.064484 > 0.05$，此条件为真。\n    由于第一个条件已满足，决策即已做出，并且由于“if-else if-otherwise”的逻辑结构，无需评估后续规则。存在显著的低血糖（TBR 高于安全阈值）是减少剂量的主要决定因素。\n\n因此，调整因子为 $\\Delta = -0.10$。\n问题要求答案四舍五入到四位有效数字。数值 $-0.10$ 写成 $-0.1000$ 以表示此精度。", "answer": "$$\\boxed{-0.1000}$$", "id": "4903517"}, {"introduction": "当远程医疗项目在多个临床中心实施时，如何科学地评估其整体效果与中心间的差异，是一个核心的挑战。由于患者数据自然地“嵌套”在各个中心内，简单的平均分析会掩盖重要的中心层面差异，甚至得出误导性结论。此项练习 [@problem_id:4903390] 将引导您应用分层线性模型（Hierarchical Linear Model），这是一种能够妥善处理嵌套数据结构的高级统计方法。通过此练习，您将学习如何区分并量化患者个体间变异（within-clinic variation）与不同临床中心间变异（between-clinic variation），从而更准确地评估项目的整体成效和实施一致性。", "problem": "您的任务是实现一个分层高斯线性混合模型，以估计在内科慢性病管理中实施远程医疗项目后，诊所级别的结果变异。结果是在标准化的远程医疗干预后，患者级别的收缩压变化，单位为毫米汞柱 (mmHg)。患者组合（差异）通过将基线收缩压作为固定效应协变量来加以校正。\n\n从以下基本原理出发：\n- 正态（高斯）分布的性质，包括多元正态分布及其在线性映射下的协方差变换。\n- 线性模型中普通最小二乘法的高斯-马尔可夫定理。\n- 分层随机截距模型的定义以及用于组间和组内变异的方差分量概念。\n- 用于线性混合模型中方差分量无偏估计的限制性最大似然（REML）方法。\n\n构建一个程序，为每个测试用例，从以下分层模型中估计诊所间方差分量，表示为 $\\tau^2$：\n$$\ny_{ij} = \\alpha + x_{ij}\\beta + u_j + \\varepsilon_{ij},\n$$\n其中 $y_{ij}$ 是诊所 $j$ 中患者 $i$ 的收缩压变化（单位 $\\mathrm{mmHg}$），$x_{ij}$ 是诊所 $j$ 中患者 $i$ 的基线收缩压（单位 $\\mathrm{mmHg}$），$u_j \\sim \\mathcal{N}(0,\\tau^2)$ 是诊所 $j$ 的随机截距，$\\varepsilon_{ij} \\sim \\mathcal{N}(0,\\sigma^2)$ 是残差变异。固定效应是截距 $\\alpha$ 和基线斜率 $\\beta$，随机效应由诊所级别的截距组成。模型必须通过 $x_{ij}$ 来校正患者组合。\n\n您的程序必须：\n- 使用限制性最大似然原理来估计 $\\tau^2$ 和 $\\sigma^2$。\n- 将固定效应 $\\alpha$ 和 $\\beta$ 视为未知，并根据 REML 的要求，将它们与方差分量联合估计。\n- 仅使用所提供的数据和以下约束来实现计算，不得使用假设参数已知的捷径。\n- 将每个测试用例的最终答案表示为估计的诊所间方差 $\\tau^2$，单位为 $(\\mathrm{mmHg})^2$，以四舍五入到三位小数的浮点数形式表示。\n\n所有角度（如有）必须以弧度为单位。物理单位适用；方差的输出单位是 $(\\mathrm{mmHg})^2$。不涉及百分比。\n\n测试套件：\n对于每个测试用例，您会获得诊所数量、患者分配、基线收缩压值（单位 $\\mathrm{mmHg}$）以及观测结果 $y_{ij}$（收缩压变化，单位 $\\mathrm{mmHg}$）。固定效应设计矩阵必须包含一个截距和基线收缩压。\n\n- 测试用例 $1$（正常路径：均衡的诊所规模，中等的诊所间变异）：\n  - 诊所：$4$\n  - 每个诊所的患者数：$[5,5,5,5]$\n  - 按诊所划分的基线收缩压 (单位 $\\mathrm{mmHg}$)：\n    - 诊所 $0$：$[160,150,155,145,150]$\n    - 诊所 $1$：$[140,145,150,135,140]$\n    - 诊所 $2$：$[155,160,150,170,165]$\n    - 诊所 $3$：$[150,148,152,155,149]$\n  - 结果 $y_{ij}$ (变化量，单位 $\\mathrm{mmHg}$)：\n    - 诊所 $0$：$[-12.3,-15.0,-12.75,-13.75,-10.8]$\n    - 诊所 $1$：$[-9.5,-8.25,-11.1,-8.45,-9.9]$\n    - 诊所 $2$：$[-9.95,-7.2,-8.2,-8.5,-9.85]$\n    - 诊所 $3$：$[-11.6,-12.5,-12.0,-13.75,-9.95]$\n\n- 测试用例 $2$（边界情况：较小的诊所间变异，变化的诊所规模）：\n  - 诊所：$6$\n  - 每个诊所的患者数：$[3,3,4,2,5,3]$\n  - 按诊所划分的基线收缩压 (单位 $\\mathrm{mmHg}$)：\n    - 诊所 $0$：$[145,150,155]$\n    - 诊所 $1$：$[140,135,130]$\n    - 诊所 $2$：$[160,158,162,155]$\n    - 诊所 $3$：$[150,152]$\n    - 诊所 $4$：$[140,142,138,145,147]$\n    - 诊所 $5$：$[150,155,149]$\n  - 结果 $y_{ij}$ (变化量，单位 $\\mathrm{mmHg}$)：\n    - 诊所 $0$：$[-10.35,-9.2,-11.25]$\n    - 诊所 $1$：$[-9.7,-10.75,-9.3]$\n    - 诊所 $2$：$[-10.85,-10.05,-11.45,-10.2]$\n    - 诊所 $3$：$[-10.35,-11.25]$\n    - 诊所 $4$：$[-10.1,-9.9,-10.4,-10.25,-10.05]$\n    - 诊所 $5$：$[-11.1,-10.35,-10.75]$\n\n- 测试用例 $3$（边缘情况：一个大诊所和几个小诊所）：\n  - 诊所：$4$\n  - 每个诊所的患者数：$[10,1,1,2]$\n  - 按诊所划分的基线收缩压 (单位 $\\mathrm{mmHg}$)：\n    - 诊所 $0$：$[150,152,148,155,149,151,153,147,150,154]$\n    - 诊所 $1$：$[160]$\n    - 诊所 $2$：$[140]$\n    - 诊所 $3$：$[145,150]$\n  - 结果 $y_{ij}$ (变化量，单位 $\\mathrm{mmHg}$)：\n    - 诊所 $0$：$[-8.7,-9.5,-8.4,-10.45,-8.95,-8.45,-9.85,-8.65,-9.1,-9.2]$\n    - 诊所 $1$：$[-13.0]$\n    - 诊所 $2$：$[-7.5]$\n    - 诊所 $3$：$[-10.65,-12.6]$\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个方括号括起来的逗号分隔列表，每个元素是相应测试用例的估计值 $\\tau^2$（单位 $(\\mathrm{mmHg})^2$），四舍五入到三位小数。例如：$[1.234,0.567,3.210]$。", "solution": "该问题要求从一个分层线性混合模型中估计诊所间方差分量 $\\tau^2$。这将通过实施限制性最大似然（REML）估计程序来完成。该解决方案是根据下述的第一性原理推导出来的。\n\n### 1. 模型设定\n\n针对诊所 $j$ 中患者 $i$ 的收缩压变化 $y_{ij}$，指定的分层模型如下：\n$$ y_{ij} = \\alpha + x_{ij}\\beta + u_j + \\varepsilon_{ij} $$\n其中：\n- $y_{ij}$ 是结果变量（收缩压变化，单位 $\\mathrm{mmHg}$）。\n- $x_{ij}$ 是一个固定效应协变量（基线收缩压，单位 $\\mathrm{mmHg}$）。\n- $\\alpha$ 和 $\\beta$ 分别是截距和基线收缩压斜率的固定效应参数。\n- $u_j$ 是诊所 $j$ 的随机截距，表示诊所 $j$ 的平均结果与总体平均值的偏差。假设其服从正态分布，$u_j \\sim \\mathcal{N}(0, \\tau^2)$。参数 $\\tau^2$ 是诊所间方差，它量化了不同诊所间结果的变异性。\n- $\\varepsilon_{ij}$ 是诊所 $j$ 中患者 $i$ 的随机误差，代表诊所内（或残差）变异。假设其服从正态分布，$\\varepsilon_{ij} \\sim \\mathcal{N}(0, \\sigma^2)$。参数 $\\sigma^2$ 是诊所内方差。\n- 假设 $u_j$ 和 $\\varepsilon_{ij}$ 相互独立。\n\n### 2. 矩阵表示\n\n对于 $J$ 个诊所中的总共 $N$ 名患者，该模型可以表示为矩阵形式：\n$$ \\mathbf{y} = \\mathbf{X}\\boldsymbol{\\beta} + \\mathbf{Z}\\mathbf{u} + \\boldsymbol{\\varepsilon} $$\n其中：\n- $\\mathbf{y}$ 是所有结果 $y_{ij}$ 组成的 $N \\times 1$ 向量。\n- $\\mathbf{X}$ 是 $N \\times p$ 的固定效应设计矩阵，其中 $p=2$。第一列是由1组成的向量，用于截距 $\\alpha$，第二列包含基线收缩压值 $x_{ij}$。\n- $\\boldsymbol{\\beta}$ 是 $p \\times 1$ 的固定效应向量，$\\boldsymbol{\\beta} = [\\alpha, \\beta]^T$。\n- $\\mathbf{Z}$ 是 $N \\times J$ 的随机效应设计矩阵。对于此随机截距模型，如果对应的患者属于某个给定的诊所，则 $\\mathbf{Z}$ 的元素为1，否则为0。\n- $\\mathbf{u}$ 是随机截距 $u_j$ 组成的 $J \\times 1$ 向量，其中 $\\mathbf{u} \\sim \\mathcal{N}(\\mathbf{0}, \\mathbf{G})$，且 $\\mathbf{G} = \\tau^2 \\mathbf{I}_J$。\n- $\\boldsymbol{\\varepsilon}$ 是残差 $\\varepsilon_{ij}$ 组成的 $N \\times 1$ 向量，其中 $\\boldsymbol{\\varepsilon} \\sim \\mathcal{N}(\\mathbf{0}, \\mathbf{R})$，且 $\\mathbf{R} = \\sigma^2 \\mathbf{I}_N$。\n\n结果向量 $\\mathbf{y}$ 的边际分布是一个多元正态分布：\n$$ \\mathbf{y} \\sim \\mathcal{N}(\\mathbf{X}\\boldsymbol{\\beta}, \\mathbf{V}) $$\n边际协方差矩阵 $\\mathbf{V}$ 由下式给出：\n$$ \\mathbf{V} = \\text{Cov}(\\mathbf{Z}\\mathbf{u} + \\boldsymbol{\\varepsilon}) = \\mathbf{Z}\\text{Cov}(\\mathbf{u})\\mathbf{Z}^T + \\text{Cov}(\\boldsymbol{\\varepsilon}) = \\mathbf{Z}\\mathbf{G}\\mathbf{Z}^T + \\mathbf{R} = \\tau^2 \\mathbf{Z}\\mathbf{Z}^T + \\sigma^2 \\mathbf{I}_N $$\n这个协方差矩阵 $\\mathbf{V}$ 依赖于未知的方差分量 $\\boldsymbol{\\theta} = (\\tau^2, \\sigma^2)$。\n\n### 3. 限制性最大似然（REML）估计\n\n标准的最大似然估计对分差分量的估计可能是有偏的，因为它没有考虑用于估计固定效应 $\\boldsymbol{\\beta}$ 所消耗的自由度。REML通过最大化一组误差对比的似然来纠正这一点，这些误差对比是 $\\mathbf{y}$ 的线性组合，且对 $\\boldsymbol{\\beta}$ 的值不敏感。需要对 $\\boldsymbol{\\theta}$ 最大化的REML对数似然函数（忽略常数）是：\n$$ \\ell_{REML}(\\boldsymbol{\\theta} | \\mathbf{y}) = -\\frac{1}{2}\\left( \\log|\\mathbf{V}| + \\log|\\mathbf{X}^T \\mathbf{V}^{-1} \\mathbf{X}| + \\mathbf{y}^T \\mathbf{P} \\mathbf{y} \\right) $$\n其中 $\\mathbf{P} = \\mathbf{V}^{-1} - \\mathbf{V}^{-1}\\mathbf{X}(\\mathbf{X}^T \\mathbf{V}^{-1} \\mathbf{X})^{-1}\\mathbf{X}^T \\mathbf{V}^{-1}$。项 $\\mathbf{y}^T \\mathbf{P} \\mathbf{y}$ 是来自固定效应的广义最小二乘（GLS）拟合的残差平方和：\n$$ \\mathbf{y}^T \\mathbf{P} \\mathbf{y} = (\\mathbf{y} - \\mathbf{X}\\hat{\\boldsymbol{\\beta}})^T \\mathbf{V}^{-1} (\\mathbf{y} - \\mathbf{X}\\hat{\\boldsymbol{\\beta}}) $$\n其中 $\\hat{\\boldsymbol{\\beta}} = (\\mathbf{X}^T \\mathbf{V}^{-1} \\mathbf{X})^{-1} \\mathbf{X}^T \\mathbf{V}^{-1} \\mathbf{y}$。\n\n### 4. 计算策略\n\n对于大的 $N$，直接计算 $\\mathbf{V}^{-1}$ 和 $|\\mathbf{V}|$ 在计算上是不可行的。然而，$\\mathbf{V}$ 的结构允许进行显著简化。由于患者嵌套在诊所内，并且在不同诊所间是独立的，因此 $\\mathbf{V}$ 是一个块对角矩阵：\n$$ \\mathbf{V} = \\text{diag}(\\mathbf{V}_1, \\mathbf{V}_2, \\ldots, \\mathbf{V}_J) $$\n其中 $\\mathbf{V}_j$ 是诊所 $j$ 中 $n_j$ 名患者的 $n_j \\times n_j$ 协方差矩阵：\n$$ \\mathbf{V}_j = \\tau^2 \\mathbf{J}_{n_j} + \\sigma^2 \\mathbf{I}_{n_j} $$\n这里，$\\mathbf{J}_{n_j}$ 是一个 $n_j \\times n_j$ 的全1矩阵。这种块对角结构使得所有矩阵运算都可以在较小的诊所级别块上执行。\n\n每个块 $\\mathbf{V}_j$ 的行列式和逆矩阵可以被高效计算：\n- $\\log|\\mathbf{V}_j| = (n_j-1)\\log(\\sigma^2) + \\log(\\sigma^2 + n_j\\tau^2)$\n- $\\mathbf{V}_j^{-1} = \\frac{1}{\\sigma^2}\\mathbf{I}_{n_j} - \\frac{\\tau^2}{\\sigma^2(\\sigma^2 + n_j\\tau^2)}\\mathbf{J}_{n_j}$\n\n因此，REML对数似然中的各项可以通过对每个诊所的贡献求和来计算：\n- $\\log|\\mathbf{V}| = \\sum_{j=1}^{J} \\log|\\mathbf{V}_j|$\n- $\\mathbf{X}^T \\mathbf{V}^{-1} \\mathbf{X} = \\sum_{j=1}^{J} \\mathbf{X}_j^T \\mathbf{V}_j^{-1} \\mathbf{X}_j$\n- $\\mathbf{X}^T \\mathbf{V}^{-1} \\mathbf{y} = \\sum_{j=1}^{J} \\mathbf{X}_j^T \\mathbf{V}_j^{-1} \\mathbf{y}_j$\n- $\\mathbf{y}^T \\mathbf{V}^{-1} \\mathbf{y} = \\sum_{j=1}^{J} \\mathbf{y}_j^T \\mathbf{V}_j^{-1} \\mathbf{y}_j$\n\n这些和可以被高效计算，而无需构建大的矩阵 $\\mathbf{V}$ 或 $\\mathbf{V}^{-1}$。\n\n### 5. 优化\n\n$\\tau^2$ 和 $\\sigma^2$ 的REML估计值是使 $\\ell_{REML}$ 最大化的值。这是一个数值优化问题。我们定义一个目标函数，该函数为给定的 $(\\tau^2, \\sigma^2)$ 值计算负REML对数似然。然后使用数值优化器（例如`scipy.optimize.minimize`中可用的L-BFGS-B算法）来最小化此函数，该算法可以处理非负约束 $\\tau^2 \\ge 0$ 和 $\\sigma^2  0$。\n\n该实现将首先为每个诊所预计算充分统计量（$n_j, \\mathbf{X}_j^T\\mathbf{X}_j, \\mathbf{X}_j^T\\mathbf{y}_j$ 等），以加速优化过程中目标函数的评估。优化器进行迭代，不断优化其对 $(\\tau^2, \\sigma^2)$ 的猜测值，直到找到负对数似然函数的最小值。此最小值处的 $\\tau^2$ 值即为REML估计值。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import minimize\n\ndef solve():\n    \"\"\"\n    Solves for the between-clinic variance (tau^2) using a REML approach\n    for a hierarchical linear mixed model.\n    \"\"\"\n    \n    test_cases = [\n        {\n            \"num_clinics\": 4,\n            \"patients_per_clinic\": [5, 5, 5, 5],\n            \"baseline_sbp\": [\n                [160, 150, 155, 145, 150], [140, 145, 150, 135, 140],\n                [155, 160, 150, 170, 165], [150, 148, 152, 155, 149]\n            ],\n            \"outcomes\": [\n                [-12.3, -15.0, -12.75, -13.75, -10.8], [-9.5, -8.25, -11.1, -8.45, -9.9],\n                [-9.95, -7.2, -8.2, -8.5, -9.85], [-11.6, -12.5, -12.0, -13.75, -9.95]\n            ]\n        },\n        {\n            \"num_clinics\": 6,\n            \"patients_per_clinic\": [3, 3, 4, 2, 5, 3],\n            \"baseline_sbp\": [\n                [145, 150, 155], [140, 135, 130], [160, 158, 162, 155],\n                [150, 152], [140, 142, 138, 145, 147], [150, 155, 149]\n            ],\n            \"outcomes\": [\n                [-10.35, -9.2, -11.25], [-9.7, -10.75, -9.3], [-10.85, -10.05, -11.45, -10.2],\n                [-10.35, -11.25], [-10.1, -9.9, -10.4, -10.25, -10.05], [-11.1, -10.35, -10.75]\n            ]\n        },\n        {\n            \"num_clinics\": 4,\n            \"patients_per_clinic\": [10, 1, 1, 2],\n            \"baseline_sbp\": [\n                [150, 152, 148, 155, 149, 151, 153, 147, 150, 154],\n                [160], [140], [145, 150]\n            ],\n            \"outcomes\": [\n                [-8.7, -9.5, -8.4, -10.45, -8.95, -8.45, -9.85, -8.65, -9.1, -9.2],\n                [-13.0], [-7.5], [-10.65, -12.6]\n            ]\n        }\n    ]\n\n    results = []\n\n    for case in test_cases:\n        # 1. Prepare data structures\n        y_flat = np.array([item for sublist in case[\"outcomes\"] for item in sublist])\n        x_flat = np.array([item for sublist in case[\"baseline_sbp\"] for item in sublist])\n        \n        N = len(y_flat)\n        X = np.c_[np.ones(N), x_flat]\n        p = X.shape[1]\n\n        # 2. Pre-compute clinic-level sufficient statistics for efficiency\n        clinic_stats = []\n        current_pos = 0\n        for n_j in case[\"patients_per_clinic\"]:\n            idx_slice = slice(current_pos, current_pos + n_j)\n            y_j = y_flat[idx_slice]\n            X_j = X[idx_slice, :]\n            \n            stats = {\n                \"n_j\": n_j,\n                \"XtX\": X_j.T @ X_j,\n                \"X_col_sums\": np.sum(X_j, axis=0),\n                \"Xty\": X_j.T @ y_j,\n                \"yty\": y_j.T @ y_j,\n                \"y_sum\": np.sum(y_j)\n            }\n            clinic_stats.append(stats)\n            current_pos += n_j\n\n        # 3. Define the negative REML log-likelihood function\n        def neg_reml_log_lik(params):\n            tau_sq, sigma_sq = params\n            \n            # Constraints: variances must be non-negative\n            if tau_sq  0 or sigma_sq = 0:\n                return np.inf\n\n            log_det_V = 0.0\n            Xt_Vinv_X = np.zeros((p, p))\n            Xt_Vinv_y = np.zeros(p)\n            yt_Vinv_y = 0.0\n\n            for stats in clinic_stats:\n                n_j = stats[\"n_j\"]\n                \n                # Denominator for V_j^-1 term\n                denom = sigma_sq + n_j * tau_sq\n                if denom == 0: return np.inf\n\n                log_det_V += (n_j - 1) * np.log(sigma_sq) + np.log(denom)\n\n                # Efficient computation using pre-calculated stats\n                a = 1.0 / sigma_sq\n                b = -tau_sq / (sigma_sq * denom)\n                \n                Xt_Vinv_X += a * stats[\"XtX\"] + b * np.outer(stats[\"X_col_sums\"], stats[\"X_col_sums\"])\n                Xt_Vinv_y += a * stats[\"Xty\"] + b * stats[\"X_col_sums\"] * stats[\"y_sum\"]\n                yt_Vinv_y += a * stats[\"yty\"] + b * stats[\"y_sum\"]**2\n\n            try:\n                # Compute log-determinant of (X'V^-1X)\n                sign, log_det_Xt_Vinv_X = np.linalg.slogdet(Xt_Vinv_X)\n                if sign = 0: return np.inf\n                \n                # Compute quadratic form y'Py\n                beta_hat = np.linalg.solve(Xt_Vinv_X, Xt_Vinv_y)\n                y_P_y = yt_Vinv_y - Xt_Vinv_y.T @ beta_hat\n                \n            except (np.linalg.LinAlgError, ValueError):\n                return np.inf\n            \n            # Full negative REML log-likelihood (ignoring constants)\n            neg_lik = 0.5 * (log_det_V + log_det_Xt_Vinv_X + y_P_y)\n            return neg_lik\n\n        # 4. Minimize the negative REML log-likelihood\n        initial_guess = [np.var(y_flat) / 2, np.var(y_flat) / 2]\n        # Ensure initial guess is positive\n        initial_guess = [max(1e-6, v) for v in initial_guess]\n\n        bounds = [(0, None), (1e-8, None)]\n\n        opt_result = minimize(\n            neg_reml_log_lik,\n            x0=initial_guess,\n            method='L-BFGS-B',\n            bounds=bounds\n        )\n\n        tau_sq_est = opt_result.x[0] if opt_result.success else np.nan\n        results.append(tau_sq_est)\n    \n    # Format and print the final results\n    print(f\"[{','.join(f'{r:.3f}' for r in results)}]\")\n\nsolve()\n```", "id": "4903390"}]}