{"hands_on_practices": [{"introduction": "评估概率预测模型的一个核心工具是布里尔分数 (Brier score)，它量化了预测概率与实际结果之间的平均二次误差。然而，一个总分可能掩盖了模型性能的不同方面。本练习将带您亲手计算一个小型数据集的布里尔分数，并进一步将其分解为可靠性 (reliability) 和解析度 (resolution) 两个关键部分，从而让您更深刻地理解模型校准的真正含义以及模型区分不同风险群体的能力。[@problem_id:4951610]", "problem": "在一个针对二元结局（例如，$30$天死亡率；$Y \\in \\{0,1\\}$）的临床风险预测场景中，考虑一个输出预测概率 $\\hat P$ 的模型。您观察到 $4$ 名患者的预测概率为 $\\hat P = (0.1, 0.2, 0.8, 0.7)$，其结局为 $Y = (0, 0, 1, 1)$。\n\n(a) 从 Brier 得分 (BS) 的定义出发，即预测概率与二元结局之间的均方误差，计算这 $4$ 名患者的 Brier 得分。\n\n(b) 为了通过分箱评估校准度，以 $0.5$ 为阈值将预测值分为两个箱：箱 $1$ 包含所有 $\\hat{p}  0.5$ 的情况，箱 $2$ 包含所有 $\\hat{p} \\ge 0.5$ 的情况。用 $\\bar p_k$ 表示箱 $k$ 中的平均预测概率，用 $\\bar y_k$ 表示箱 $k$ 中的经验事件率，用 $\\bar y$ 表示所有 $4$ 名患者的总体事件率。使用 Brier 得分作为均方误差的定义，结合基于双箱分区的条件以及全方差公式，推导出基于分箱分解的失校准（可靠性）和散布（解析度）分量的表达式，然后计算它们在此数据集上的数值。具体来说：\n- 可靠性应量化 $\\bar p_k$ 和 $\\bar y_k$ 之间按箱大小加权的平均平方偏差。\n- 解析度应量化 $\\bar y_k$ 和总体事件率 $\\bar y$ 之间按箱大小加权的平均平方偏差。\n\n按顺序报告您的最终三元组 $(\\text{BS}, \\text{可靠性}, \\text{解析度})$，不带单位。无需四舍五入；如果方便，可报告为有限小数或简化分数。", "solution": "该问题具有科学依据、提法明確且客观。求解所需的所有数据和定义均已提供，并且与预测模型评估中的标准统计实践一致。因此，该问题是有效的。\n\n(a) Brier 得分计算\n\nBrier 得分 (BS) 定义为预测概率 $\\hat{p}_i$ 与实际二元结局 $y_i$ 之间的均方误差。对于一组 $N$ 个预测，其公式为：\n$$\nBS = \\frac{1}{N} \\sum_{i=1}^{N} (\\hat{p}_i - y_i)^2\n$$\n问题提供了 $N=4$ 名患者的数据：\n- 预测概率：$\\hat{P} = (0.1, 0.2, 0.8, 0.7)$\n- 观测结局：$Y = (0, 0, 1, 1)$\n\n我们计算每名患者的平方误差：\n- 患者 $1$：$(\\hat{p}_1 - y_1)^2 = (0.1 - 0)^2 = 0.01$\n- 患者 $2$：$(\\hat{p}_2 - y_2)^2 = (0.2 - 0)^2 = 0.04$\n- 患者 $3$：$(\\hat{p}_3 - y_3)^2 = (0.8 - 1)^2 = (-0.2)^2 = 0.04$\n- 患者 $4$：$(\\hat{p}_4 - y_4)^2 = (0.7 - 1)^2 = (-0.3)^2 = 0.09$\n\nBrier 得分是这些值的平均值：\n$$\nBS = \\frac{1}{4} (0.01 + 0.04 + 0.04 + 0.09) = \\frac{0.18}{4} = 0.045\n$$\n\n(b) 可靠性与解析度的推导和计算\n\n首先，我们将数据划分到指定的两个箱中。\n- 对于 $\\hat{p}  0.5$ 的箱 $1$：预测值为 $\\{0.1, 0.2\\}$，对应的结局为 $\\{0, 0\\}$。\n- 对于 $\\hat{p} \\ge 0.5$ 的箱 $2$：预测值为 $\\{0.8, 0.7\\}$，对应的结局为 $\\{1, 1\\}$。\n\n接下来，我们计算每个箱以及总体的所需统计量。令 $N_k$ 为箱 $k$ 中的患者数量。\n- 对于箱 $1$ ($k=1$)：\n  - 大小：$N_1 = 2$\n  - 平均预测概率：$\\bar{p}_1 = \\frac{0.1 + 0.2}{2} = 0.15$\n  - 经验事件率（平均结局）：$\\bar{y}_1 = \\frac{0 + 0}{2} = 0$\n- 对于箱 $2$ ($k=2$)：\n  - 大小：$N_2 = 2$\n  - 平均预测概率：$\\bar{p}_2 = \\frac{0.8 + 0.7}{2} = 0.75$\n  - 经验事件率（平均结局）：$\\bar{y}_2 = \\frac{1 + 1}{2} = 1$\n- 总体事件率（发生率）：\n  - $\\bar{y} = \\frac{0+0+1+1}{4} = \\frac{2}{4} = 0.5$\n\n现在，我们推导可靠性和解析度分量的表达式。问题基于预测的分箱来定义这些分量。\n- 可靠性（或失校准）分量定义为“$\\bar{p}_k$ 和 $\\bar{y}_k$ 之间按箱大小加权的平均平方偏差”。其正式表達为：\n$$\n\\text{可靠性 (REL)} = \\frac{1}{N} \\sum_{k=1}^{K} N_k (\\bar{p}_k - \\bar{y}_k)^2\n$$\n- 解析度（或散布）分量定义为“$\\bar{y}_k$ 和总体事件率 $\\bar{y}$ 之间按箱大小加权的平均平方偏差”。其正式表達为：\n$$\n\\text{解析度 (RES)} = \\frac{1}{N} \\sum_{k=1}^{K} N_k (\\bar{y}_k - \\bar{y})^2\n$$\n问题要求推导这些分量。这可以通过展示它们如何从误差和方差度量的分解中产生来实现。使用全方差公式的提示是理解解析度分量的关键。二元结局 $Y$ 的总方差由 $Var(Y) = \\bar{y}(1-\\bar{y})$ 给出。应用于将数据划分为 $K$ 个箱的全方差公式表明 $Var(Y) = E[Var(Y|\\text{Bin})] + Var(E[Y|\\text{Bin}])$。在我们的有限样本表示法中，这是：\n$$\n\\frac{1}{N}\\sum_{i=1}^N (y_i - \\bar{y})^2 = \\sum_{k=1}^K \\frac{N_k}{N} \\left(\\frac{1}{N_k}\\sum_{i \\in \\text{Bin }k} (y_i - \\bar{y}_k)^2\\right) + \\sum_{k=1}^K \\frac{N_k}{N} (\\bar{y}_k - \\bar{y})^2\n$$\n认识到对于二元 $y_i$，样本方差 $\\frac{1}{M}\\sum(y_i - \\bar{y})^2$ 是 $\\bar{y}(1-\\bar{y})$，该恒等式变为：\n$$\n\\bar{y}(1-\\bar{y}) = \\frac{1}{N}\\sum_{k=1}^K N_k \\bar{y}_k(1-\\bar{y}_k) + \\frac{1}{N}\\sum_{k=1}^K N_k (\\bar{y}_k - \\bar{y})^2\n$$\n右侧的第二项正是解析度的公式。$\\bar{y}(1-\\bar{y})$ 项被称为总不确定性 ($UNC$)。右侧的第一项是平均条件不确定性。这个推导表明，解析度是由分箱解释的总不确定性分量。\n$$ UNC = RES + \\text{Uncertainty}_{\\text{cond}} $$\n可靠性分量来自于分解一个模型的 Brier 得分，该模型使用分箱概率 $\\bar{p}_k$作为箱 $k$ 中所有案例的预测值。设该得分为 $BS_{binned} = \\frac{1}{N}\\sum_i (\\bar{p}_{k(i)} - y_i)^2$。通过在平方项内加减 $\\bar{y}_k$ 并展开，交叉乘积项消失，得到：\n$$\nBS_{binned} = \\frac{1}{N}\\sum_k N_k(\\bar{p}_k - \\bar{y}_k)^2 + \\frac{1}{N}\\sum_k N_k \\bar{y}_k(1-\\bar{y}_k)\n$$\n第一项正是可靠性分量。第二项是条件不确定性。因此，我们得到了分箱模型的著名分解：\n$$\nBS_{binned} = REL + (UNC - RES) = REL - RES + UNC\n$$\n这个推导确立了 REL 和 RES 作为 Brier 得分基于分箱分解的基本分量。\n\n现在，我们计算此数据集的数值。\n- 可靠性计算：\n$$\nREL = \\frac{1}{4} \\left[ N_1(\\bar{p}_1 - \\bar{y}_1)^2 + N_2(\\bar{p}_2 - \\bar{y}_2)^2 \\right]\n$$\n$$\nREL = \\frac{1}{4} \\left[ 2 \\times (0.15 - 0)^2 + 2 \\times (0.75 - 1)^2 \\right]\n$$\n$$\nREL = \\frac{1}{4} \\left[ 2 \\times (0.15)^2 + 2 \\times (-0.25)^2 \\right]\n$$\n$$\nREL = \\frac{1}{4} \\left[ 2 \\times 0.0225 + 2 \\times 0.0625 \\right]\n$$\n$$\nREL = \\frac{1}{4} \\left[ 0.045 + 0.125 \\right] = \\frac{0.17}{4} = 0.0425\n$$\n\n- 解析度计算：\n$$\nRES = \\frac{1}{4} \\left[ N_1(\\bar{y}_1 - \\bar{y})^2 + N_2(\\bar{y}_2 - \\bar{y})^2 \\right]\n$$\n$$\nRES = \\frac{1}{4} \\left[ 2 \\times (0 - 0.5)^2 + 2 \\times (1 - 0.5)^2 \\right]\n$$\n$$\nRES = \\frac{1}{4} \\left[ 2 \\times (-0.5)^2 + 2 \\times (0.5)^2 \\right]\n$$\n$$\nRES = \\frac{1}{4} \\left[ 2 \\times 0.25 + 2 \\times 0.25 \\right]\n$$\n$$\nRES = \\frac{1}{4} \\left[ 0.5 + 0.5 \\right] = \\frac{1}{4} = 0.25\n$$\n\n最终的三元组（BS，可靠性，解析度）是 $(0.045, 0.0425, 0.25)$。", "answer": "$$\\boxed{\\begin{pmatrix} 0.045  0.0425  0.25 \\end{pmatrix}}$$", "id": "4951610"}, {"introduction": "在通过布里尔分数等指标对模型的整体表现有了初步了解后，我们常常需要一个正式的统计检验来判断模型的校准度是否存在显著偏差。霍斯默-莱梅肖 (Hosmer-Lemeshow) 拟合优度检验便是为此目的设计的经典方法之一，它通过将预测风险分箱，比较每个箱内的观测事件数与期望事件数。通过本练习，您将学会如何计算霍斯默-莱梅肖统计量，并利用其p值来对模型的校准性能做出统计推断。[@problem_id:4951573]", "problem": "一家医院建立了一个逻辑斯谛回归模型，用于预测一个由 $n=1000$ 名患者组成的队列的 $30$ 天死亡率。为了评估模型的校准度，医院根据预测风险的十分位数将患者分为 $B=10$ 个大小相等的组，每组有 $n_b=100$ 名患者。对于组 $b \\in \\{1,\\dots,10\\}$，令 $O_b$ 表示观测到的死亡人数，$E_b$ 表示期望的死亡人数，其计算方式为该组内所有预测概率的总和。获得以下数值：\n- 第1组：$n_1=100$, $E_1=5$, $O_1=7$。\n- 第2组：$n_2=100$, $E_2=10$, $O_2=8$。\n- 第3组：$n_3=100$, $E_3=15$, $O_3=14$。\n- 第4组：$n_4=100$, $E_4=20$, $O_4=24$。\n- 第5组：$n_5=100$, $E_5=25$, $O_5=24$。\n- 第6组：$n_6=100$, $E_6=35$, $O_6=33$。\n- 第7组：$n_7=100$, $E_7=45$, $O_7=50$。\n- 第8组：$n_8=100$, $E_8=60$, $O_8=58$。\n- 第9组：$n_9=100$, $E_9=80$, $O_9=86$。\n- 第10组：$n_{10}=100$, $E_{10}=95$, $O_{10}=92$。\n\n仅从以下定义出发：在正确校准的情况下，第 $b$ 组的期望计数为 $E_b=\\sum_{i \\in b} \\hat{p}_i$，观测计数为 $O_b=\\sum_{i \\in b} y_i$，以及 $n_b$ 个均值为 $p_b$ 的伯努利结果之和的二项方差为 $n_b p_b (1-p_b)$。请推导 Hosmer–Lemeshow 拟合优度统计量，该统计量使用各组特定的二项方差来比较所有组的 $O_b$ 与 $E_b$。然后，根据上述数据计算其值。最后，在正确校准的原假设下，使用该统计量的标准大样本参考分布计算p值。假设大样本参考分布是自由度为 $B-2$ 的卡方分布。将p值表示为小数（而非百分比）。将 Hosmer–Lemeshow 统计量和 p 值都四舍五入到四位有效数字，并将这两个值一起作为最终答案报告。", "solution": "该问题被评估为有效。它在科学上基于统计模型验证领域，特别是关于医学中预测模型的校准。问题陈述清晰，提供了所有必要的数据（$n$、$B$、$n_b$ 以及各组的观测计数（$O_b$）和期望计数（$E_b$））、定义和明确的目标。数据内部一致，术语精确。\n\n任务是推导 Hosmer–Lemeshow 拟合优度统计量，根据所提供的数据计算其值，然后计算相应的p值。\n\n第一步是推导 Hosmer–Lemeshow 统计量 $H$。该统计量旨在检验一个模型校准良好（即其预测概率与观测结果一致）的原假设 ($H_0$)。这是一个拟合优度检验。其基本思想是在每个组 $b$ 中比较观测事件数 $O_b$ 和期望事件数 $E_b$。\n\n对于每个组 $b$，我们有 $n_b$ 个个体。观测到的事件（死亡）计数 $O_b = \\sum_{i \\in b} y_i$（其中如果个体 $i$ 发生事件则 $y_i=1$，否则 $y_i=0$）可以被视为 $n_b$ 个独立（但非同分布）的伯努利试验的总和。在原假设下，模型的预测概率 $\\hat{p}_i$ 是个体 $i$ 的正确事件概率。组 $b$ 中的期望事件数由 $E_b = \\sum_{i \\in b} \\hat{p}_i$ 给出。\n\n问题指定 $O_b$ 和 $E_b$ 的比较应使用各组特定的二项方差。观测计数 $O_b$ 是一个随机变量。在 $H_0$ 下，其期望值为 $E[O_b] = E_b$。构建拟合优度统计量的一个标准方法是将观测值与期望值之间的标准化差异的平方求和。组 $b$ 的标准化差异为 $\\frac{O_b - E_b}{\\sqrt{\\text{Var}(O_b)}}$。将这些项在所有组上平方求和，得到一个在 $H_0$ 下渐近服从卡方分布的统计量。\n\n$O_b$ 的方差需要被估计。问题提供了 $n_b$ 个具有共同均值概率 $p_b$ 的伯努利结果之和的方差公式为 $n_b p_b (1-p_b)$。尽管一个组内的概率 $\\hat{p}_i$ 不完全相同，但通常的做法是使用组内的平均预测概率 $\\bar{p}_b$ 作为 $p_b$ 的估计值。该平均值由下式给出：\n$$ \\bar{p}_b = \\frac{1}{n_b} \\sum_{i \\in b} \\hat{p}_i = \\frac{E_b}{n_b} $$\n将这个估计值代入方差公式，我们得到 $O_b$ 的估计方差：\n$$ \\text{Var}(O_b) \\approx n_b \\bar{p}_b(1-\\bar{p}_b) = n_b \\left(\\frac{E_b}{n_b}\\right) \\left(1 - \\frac{E_b}{n_b}\\right) = E_b \\left(1 - \\frac{E_b}{n_b}\\right) $$\nHosmer–Lemeshow 统计量 $H$ 是观测计数与期望计数之间差异的平方之和，每一项都通过其估计方差进行标准化：\n$$ H = \\sum_{b=1}^{B} \\frac{(O_b - E_b)^2}{\\text{Var}(O_b)} = \\sum_{b=1}^{B} \\frac{(O_b - E_b)^2}{n_b \\bar{p}_b(1-\\bar{p}_b)} = \\sum_{b=1}^{B} \\frac{(O_b - E_b)^2}{E_b(1 - E_b/n_b)} $$\n这就是所要求的推导过程。\n\n第二步是使用给定的数据计算 $H$ 的值。我们有 $B=10$ 个组，每组 $n_b=100$。来自每个组的贡献如下：\n- 第1组：$\\frac{(7-5)^2}{5(1-5/100)} = \\frac{4}{5(0.95)} = \\frac{4}{4.75} \\approx 0.842105$\n- 第2组：$\\frac{(8-10)^2}{10(1-10/100)} = \\frac{4}{10(0.90)} = \\frac{4}{9} \\approx 0.444444$\n- 第3组：$\\frac{(14-15)^2}{15(1-15/100)} = \\frac{1}{15(0.85)} = \\frac{1}{12.75} \\approx 0.078431$\n- 第4组：$\\frac{(24-20)^2}{20(1-20/100)} = \\frac{16}{20(0.80)} = \\frac{16}{16} = 1.000000$\n- 第5组：$\\frac{(24-25)^2}{25(1-25/100)} = \\frac{1}{25(0.75)} = \\frac{1}{18.75} \\approx 0.053333$\n- 第6组：$\\frac{(33-35)^2}{35(1-35/100)} = \\frac{4}{35(0.65)} = \\frac{4}{22.75} \\approx 0.175824$\n- 第7组：$\\frac{(50-45)^2}{45(1-45/100)} = \\frac{25}{45(0.55)} = \\frac{25}{24.75} \\approx 1.010101$\n- 第8组：$\\frac{(58-60)^2}{60(1-60/100)} = \\frac{4}{60(0.40)} = \\frac{4}{24} \\approx 0.166667$\n- 第9组：$\\frac{(86-80)^2}{80(1-80/100)} = \\frac{36}{80(0.20)} = \\frac{36}{16} = 2.250000$\n- 第10组：$\\frac{(92-95)^2}{95(1-95/100)} = \\frac{9}{95(0.05)} = \\frac{9}{4.75} \\approx 1.894737$\n\n将这些单独的分量相加，得到统计量 $H$ 的总值：\n$$ H \\approx 0.842105 + 0.444444 + 0.078431 + 1.000000 + 0.053333 + 0.175824 + 1.010101 + 0.166667 + 2.250000 + 1.894737 $$\n$$ H \\approx 7.915642 $$\n四舍五入到四位有效数字，Hosmer–Lemeshow 统计量为 $H = 7.916$。\n\n第三步是计算p值。在校准良好的原假设下，统计量 $H$ 服从卡方（$\\chi^2$）分布。问题指定该分布的自由度（$df$）为 $B-2$。因为有 $B=10$ 个组，所以自由度为 $df = 10-2=8$。\n\np值是在原假设为真的前提下，观测到至少与计算出的检验统计量一样大的检验统计量的概率。\n$$ p\\text{-value} = P(\\chi^2_8 \\ge H) = P(\\chi^2_8 \\ge 7.915642) $$\n这个概率可以使用 $\\chi^2_8$ 分布的累积分布函数（CDF），记为 $F_{\\chi^2_8}(x)$ 来求得：\n$$ p\\text{-value} = 1 - F_{\\chi^2_8}(7.915642) $$\n使用统计计算器，该值约为 $0.441753$。四舍五入到四位有效数字，p值为 $0.4418$。\n\n如此大的p值（通常使用 $0.05$ 作为阈值）表明没有统计上显著的证据来拒绝原假设。我们得出结论，基于此检验，该模型看起来校准良好。\n\n最终答案要求同时给出 Hosmer–Lemeshow 统计量和p值，并四舍五入到四位有效数字。\n\nHosmer–Lemeshow 统计量: $7.916$\np值: $0.4418$\n\n这两个值一起报告。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n7.916  0.4418\n\\end{pmatrix}\n}\n$$", "id": "4951573"}, {"introduction": "在理想情况下，我们使用代表目标人群的随机样本来评估模型，但医学研究的现实往往更为复杂。病例-对照研究 (case–control study) 就是一个典型例子，其抽样设计会导致标准的校准评估指标产生偏差。本高级练习将引导您推导并应用逆概率加权 (inverse probability weighting, IPW) 方法，这是一种强大的技术，能够校正因病例-对照抽样引入的偏差，从而准确评估模型在真实目标人群中的校准性能。[@problem_id:4951609]", "problem": "临床风险模型使用在病例-对照研究中拟合的逻辑回归，为二元结局（例如住院后三十天死亡率）分配个体化的概率。令 $Y \\in \\{0,1\\}$ 表示结局，$X$ 表示协变量，$\\hat{p}(X) \\in (0,1)$ 表示协变量为 $X$ 的个体的模型预测概率。将总体校准误差定义为总体量 $E_b = \\mathbb{E}[\\hat{p}(X)] - \\mathbb{E}[Y]$，其中期望是相对于目标人群分布计算的。\n\n假设存在以下科学上标准的框架：\n- 目标人群的患病率为 $\\pi = \\mathbb{P}(Y=1)$，且 $\\mathbb{P}(Y=0) = 1 - \\pi$。\n- 病例-对照样本的抽样方法是：以概率 $s_{1} \\in (0,1]$ 选择病例，以概率 $s_{0} \\in (0,1]$ 选择对照，在给定 $Y$ 的条件下，该选择独立于 $X$。\n- 在病例-对照样本中，令 $P_{s}(Y=1) = \\frac{s_{1}\\,\\pi}{s_{1}\\,\\pi + s_{0}\\,(1-\\pi)}$ 和 $P_{s}(Y=0) = \\frac{s_{0}\\,(1-\\pi)}{s_{1}\\,\\pi + s_{0}\\,(1-\\pi)}$ 表示诱导的结局比例。\n- 令 $\\mu_{y} = \\mathbb{E}[\\hat{p}(X)\\,|\\,Y=y]$ (对于 $y \\in \\{0,1\\}$) 表示在目标人群分布下预测风险的条件均值。假设在病例-对照样本中给定 $Y$ 的 $X$ 的条件分布与目标人群中的条件分布相同，当选择仅依赖于 $Y$ 时，此假设成立。\n\n在大小为 $n$ 的病例-对照样本中，个体由 $i=1,\\dots,n$ 索引，具有观测对 $(y_{i}, \\hat{p}_{i})$ 和分组成员身份 $g(i) \\in \\{1,\\dots,G\\}$，这些组是通过按 $\\hat{p}_{i}$ 的分位数将样本划分为 $G$ 个区间而形成的。对每个区间 $g$，定义观测计数 $O_{g} = \\sum_{i:\\,g(i)=g} y_{i}$，期望计数 $E_{g} = \\sum_{i:\\,g(i)=g} \\hat{p}_{i}$，以及区间大小 $n_{g} = \\sum_{i:\\,g(i)=g} 1$。考虑构建为各区间上皮尔逊型残差平方和的 Hosmer–Lemeshow 拟合优度统计量。\n\n从基本概率恒等式（全期望定律和独立伯努利变量的方差）以及针对有偏抽样的逆概率加权定义出发，推导：\n1) 由病例-对照抽样引起的 $E_b$ 偏差的解析表达式，以及一个通过根据个体选择概率的倒数对其进行加权来恢复目标 $E_b$ 的校正估计量。\n2) 一个重加权的 Hosmer–Lemeshow 统计量，在上述选择机制下，通过使用逆概率权重和伯努利方差，该统计量一致地以基于人群分组的皮尔逊统计量为目标。\n\n你的最终答案必须是一个单一的闭式解析表达式，包含校正后的总体校准和重加权的 Hosmer–Lemeshow 统计量，用 $s_{1}$、$s_{0}$、$\\pi$、$y_{i}$、$\\hat{p}_{i}$ 和分组成员 $g(i)$ 表示。如果 $y_{i}=1$，则使用 $s_{y_{i}} = s_{1}$；如果 $y_{i}=0$，则使用 $s_{y_{i}} = s_{0}$。最终表达式中不得包含任何数值近似或四舍五入。", "solution": "该问题要求推导两个统计量，以校正病例-对照研究设计中固有的抽样偏差：一个校正的总体校准估计量，以及一个重加权的 Hosmer-Lemeshow 拟合优度统计量。两个推导都将基于逆概率加权（IPW）原理。\n\n首先，我们必须确定适当的权重以抵消抽样偏差。病例-对照样本是从目标人群中抽取的，方法是以概率 $s_1$ 选择有结局的个体（病例，$Y=1$），并以概率 $s_0$ 选择没有结局的个体（对照，$Y=0$）。目标人群中结局的患病率为 $\\pi = \\mathbb{P}(Y=1)$。\n\n样本中的结局分布 $P_s(Y=y)$ 与人群分布 $\\mathbb{P}(Y=y)$ 不同。具体来说，使用贝叶斯定理，在样本中观察到结局为 $y$ 的个体的概率是：\n$P_s(Y=y) = \\frac{\\mathbb{P}(\\text{sampled}|Y=y)\\mathbb{P}(Y=y)}{\\mathbb{P}(\\text{sampled})}$\n被抽样的总概率为 $\\mathbb{P}(\\text{sampled}) = \\mathbb{P}(\\text{sampled}|Y=1)\\mathbb{P}(Y=1) + \\mathbb{P}(\\text{sampled}|Y=0)\\mathbb{P}(Y=0) = s_1 \\pi + s_0 (1-\\pi)$。\n让我们将此常数表示为 $C = s_1 \\pi + s_0 (1-\\pi)$。\n样本中的比例为 $P_s(Y=1) = \\frac{s_1 \\pi}{C}$ 和 $P_s(Y=0) = \\frac{s_0 (1-\\pi)}{C}$。\n\n为了从样本均值中恢复人群期望，我们必须为每个观测值 $i$ 赋予一个权重 $w_i$，该权重与其被选择的概率成反比。加权的目的是使加权后的样本分布与目标人群分布相似。对于任何函数 $f(X,Y)$，我们希望具有性质 $\\mathbb{E}[f(X,Y)] = \\mathbb{E}_s[w(Y) f(X,Y)]$，其中 $\\mathbb{E}[\\cdot]$ 是对目标人群的期望，$\\mathbb{E}_s[\\cdot]$ 是对病例-对照样本的期望。\n\n使用全期望定律，我们有：\n$\\mathbb{E}[f(X,Y)] = \\pi \\mathbb{E}[f(X,Y)|Y=1] + (1-\\pi) \\mathbb{E}[f(X,Y)|Y=0]$。\n$\\mathbb{E}_s[w(Y)f(X,Y)] = P_s(Y=1)w_1 \\mathbb{E}_s[f(X,Y)|Y=1] + P_s(Y=0)w_0 \\mathbb{E}_s[f(X,Y)|Y=0]$。\n鉴于选择仅依赖于 $Y$，给定 $Y$ 的协变量 $X$ 的条件分布在样本和人群中是相同的，因此 $\\mathbb{E}_s[f(X,Y)|Y=y] = \\mathbb{E}[f(X,Y)|Y=y]$。为确保等式对任何函数 $f$ 都成立，我们必须使系数相等：\n$P_s(Y=1) w_1 = \\pi \\implies w_1 = \\frac{\\pi}{P_s(Y=1)} = \\frac{\\pi}{s_1 \\pi / C} = \\frac{C}{s_1}$。\n$P_s(Y=0) w_0 = 1-\\pi \\implies w_0 = \\frac{1-\\pi}{P_s(Y=0)} = \\frac{1-\\pi}{s_0(1-\\pi)/C} = \\frac{C}{s_0}$。\n因此，结局为 $y_i$ 的观测值 $i$ 的权重为 $w_i = \\frac{s_1 \\pi + s_0 (1-\\pi)}{s_{y_i}}$，其中如果 $y_i=1$，则 $s_{y_i}$ 为 $s_1$；如果 $y_i=0$，则 $s_{y_i}$ 为 $s_0$。\n\n有了这些权重，我们现在可以推导所需的两个量。\n\n1. 总体校准（$E_b$）的校正估计量\n\n目标人群量为 $E_b = \\mathbb{E}[\\hat{p}(X)] - \\mathbb{E}[Y]$。第二项就是 $\\pi$。完整表达式为 $E_b = \\mathbb{E}[\\hat{p}(X) - Y]$。在病例-对照样本上计算的朴素估计量 $\\frac{1}{n} \\sum_{i=1}^n (\\hat{p}_i - y_i)$ 会是 $E_b$ 的一个有偏估计量，因为它收敛于 $\\mathbb{E}_s[\\hat{p}(X) - Y]$，而由于有偏抽样，这不等于 $E_b$。\n\n为了获得 $E_b$ 的一致估计量，我们使用权重 $w_i$ 计算残差 $(\\hat{p}_i - y_i)$ 的加权平均值。对于人群均值 $\\mathbb{E}[Z]$，这个通用的 IPW 估计量是 $\\frac{1}{n}\\sum_{i=1}^n w_i Z_i$，假设权重的尺度被调整以使其样本均值收敛于 $1$。我们的权重满足这个条件：$\\mathbb{E}_s[w(Y)] = P_s(Y=1)w_1 + P_s(Y=0)w_0 = \\pi + (1-\\pi) = 1$。\n\n因此，$E_b$ 的校正估计量为：\n$\\hat{E}_{b, \\text{corr}} = \\frac{1}{n} \\sum_{i=1}^{n} w_i (\\hat{p}_i - y_i)$。\n代入 $w_i$ 的表达式：\n$\\hat{E}_{b, \\text{corr}} = \\frac{1}{n} \\sum_{i=1}^{n} \\frac{s_1 \\pi + s_0 (1-\\pi)}{s_{y_i}} (\\hat{p}_i - y_i) = \\frac{s_1 \\pi + s_0 (1-\\pi)}{n} \\sum_{i=1}^{n} \\frac{\\hat{p}_i - y_i}{s_{y_i}}$。\n\n2. 重加权的 Hosmer–Lemeshow (HL) 统计量\n\n标准的 HL 统计量是 $G$ 个区间上皮尔逊型残差平方和。对于给定区间 $g$，人群层面的皮尔逊卡方统计量为 $\\frac{(O_{pop,g} - E_{pop,g})^2}{\\text{Var}(O_{pop,g})}$，其中所有量都指目标人群。\n- $O_{pop,g} = \\sum_{j \\in \\text{pop}, g(j)=g} Y_j$ 是人群中区间 $g$ 内观测到的事件总数。\n- $E_{pop,g} = \\sum_{j \\in \\text{pop}, g(j)=g} \\hat{p}(X_j)$ 是区间 $g$ 内的期望事件总数。\n- 在完美校准的原假设下（$\\mathbb{E}[Y_j|X_j] = \\hat{p}(X_j)$），观测计数的方差基于伯努利方差之和：$\\text{Var}(O_{pop,g}) = \\sum_{j \\in \\text{pop}, g(j)=g} \\text{Var}(Y_j) = \\sum_{j \\in \\text{pop}, g(j)=g} \\hat{p}(X_j)(1-\\hat{p}(X_j))$。\n\n我们必须使用 IPW 从我们的病例-对照样本中估计这三个总体总量。人群总量 $\\sum_{j \\in \\text{pop}} Z_j$ 的 IPW 估计量是样本上的加权和 $\\sum_{i \\in \\text{sample}} w_i Z_i$。\n- $O_{pop,g}$ 的估计量：$\\hat{O}_{w,g} = \\sum_{i:g(i)=g} w_i y_i$。\n- $E_{pop,g}$ 的估计量：$\\hat{E}_{w,g} = \\sum_{i:g(i)=g} w_i \\hat{p}_i$。\n- $\\text{Var}(O_{pop,g})$ 的估计量：$\\hat{V}_{w,g} = \\sum_{i:g(i)=g} w_i \\hat{p}_i(1-\\hat{p}_i)$。权重 $w_i$ 与个体 $i$ 相关联，因此依赖于 $y_i$，即使被求和的量 $\\hat{p}_i(1-\\hat{p}_i)$ 并不依赖于 $y_i$。\n\n区间 $g$ 的重加权统计量是前两个估计量之差的平方与第三个估计量的比值：\n$\\chi^2_{w,g} = \\frac{(\\hat{O}_{w,g} - \\hat{E}_{w,g})^2}{\\hat{V}_{w,g}} = \\frac{\\left( \\sum_{i:g(i)=g} w_i (y_i - \\hat{p}_i) \\right)^2}{\\sum_{i:g(i)=g} w_i \\hat{p}_i(1-\\hat{p}_i)}$。\n\n总的重加权 HL 统计量 $H_w$ 是所有 $G$ 个区间的总和：\n$H_w = \\sum_{g=1}^{G} \\frac{\\left( \\sum_{i:g(i)=g} w_i (y_i - \\hat{p}_i) \\right)^2}{\\sum_{i:g(i)=g} w_i \\hat{p}_i(1-\\hat{p}_i)}$。\n代入 $w_i = C/s_{y_i}$，其中 $C = s_1 \\pi + s_0 (1-\\pi)$：\n$H_w = \\sum_{g=1}^{G} \\frac{\\left( \\sum_{i:g(i)=g} \\frac{C}{s_{y_i}} (y_i - \\hat{p}_i) \\right)^2}{\\sum_{i:g(i)=g} \\frac{C}{s_{y_i}} \\hat{p}_i(1-\\hat{p}_i)} = \\sum_{g=1}^{G} \\frac{C^2 \\left( \\sum_{i:g(i)=g} \\frac{y_i - \\hat{p}_i}{s_{y_i}} \\right)^2}{C \\sum_{i:g(i)=g} \\frac{\\hat{p}_i(1-\\hat{p}_i)}{s_{y_i}}}$。\n$H_w = (s_1 \\pi + s_0 (1-\\pi)) \\sum_{g=1}^{G} \\frac{\\left( \\sum_{i:g(i)=g} \\frac{y_i - \\hat{p}_i}{s_{y_i}} \\right)^2}{\\sum_{i:g(i)=g} \\frac{\\hat{p}_i(1-\\hat{p}_i)}{s_{y_i}}}$。\n\n这两个推导出的表达式分别代表了总体校准的校正估计量和重加权的 Hosmer-Lemeshow 统计量。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{s_{1} \\pi + s_{0} (1-\\pi)}{n} \\sum_{i=1}^{n} \\frac{\\hat{p}_i - y_i}{s_{y_i}}  (s_{1} \\pi + s_{0} (1-\\pi)) \\sum_{g=1}^{G} \\frac{\\left( \\sum_{i:g(i)=g} \\frac{y_i - \\hat{p}_i}{s_{y_i}} \\right)^2}{\\sum_{i:g(i)=g} \\frac{\\hat{p}_i(1-\\hat{p}_i)}{s_{y_i}}}\n\\end{pmatrix}\n}\n$$", "id": "4951609"}]}