## 引言
在生存分析领域，Cox比例风险模型因其灵活性和强大的解释能力而被广泛应用。然而，该模型的有效性严格依赖于一个核心前提——比例风险（Proportional Hazards, PH）假设，即协变量对事件风险的影响在整个研究期间保持恒定。当这一假设被违背时，例如治疗效果随时间减弱或增强，模型的结论可能产生严重偏差，从而误导科学研究和临床决策。因此，对PH假设进行严谨的诊断检验，是任何可靠生存分析中不可或缺的一环。

本文旨在全面阐述检验PH假设最经典、最重要的方法之一：Schoenfeld[残差分析](@entry_id:191495)。通过三个章节的深入探讨，读者将构建一个从理论到实践的完整知识体系：

-   在**第一章：原理与机制**中，我们将剖析Schoenfeld残差的数学定义与统计学基础，揭示其为何能够有效捕捉非比例风险的信号，并介绍如何通过可视化和正式检验来解读残差。
-   在**第二章：应用与跨学科联系**中，我们将展示Schoenfeld残差在医学、流行病学和生物信息学等领域的真实应用，讨论如何应对假设违背，并将其扩展到竞争风险、分层模型等复杂场景。
-   在**第三章：动手实践**中，您将通过一系列精心设计的问题，亲手实现和分析Schoenfeld残差，从而巩固所学知识并提升解决实际问题的能力。

通过本文的学习，您将掌握一套诊断和处理非[比例风险](@entry_id:166780)的系统性方法，为构建更精确、更可靠的生存模型奠定坚实的基础。让我们首先从理解其核心原理与机制开始。

## 原理与机制

在生存分析中，Cox比例风险模型是一项强大而灵活的工具，但其有效性依赖于一个核心假设：比例风险（Proportional Hazards, PH）假设。本章将深入探讨检验这一关键假设的原理与机制，重点介绍一种广泛使用的诊断工具——Schoenfeld残差。我们将从其基本定义出发，揭示其理论基础，展示其在实践中的应用，并最终将其整合为一套严谨的[假设检验框架](@entry_id:165093)。

### [比例风险假设](@entry_id:163597)的回顾

首先，我们简要回顾[Cox模型](@entry_id:164053)的结构。对于一个具有协变量向量 $\mathbf{x}$ 的个体，其在时间 $t$ 的风险函数 $h(t \mid \mathbf{x})$ 被建模为：
$$
h(t \mid \mathbf{x}) = h_0(t)\exp(\boldsymbol{\beta}^{\top}\mathbf{x})
$$
其中，$h_0(t)$ 是一个未指定的基准风险函数，$\boldsymbol{\beta}$ 是一个需要估计的[回归系数](@entry_id:634860)向量。

该模型的内在结构导出了其核心假设。对于两个具有不同协变量向量 $\mathbf{x}_1$ 和 $\mathbf{x}_2$ 的个体，其风险比（Hazard Ratio, HR）为：
$$
HR = \frac{h(t \mid \mathbf{x}_1)}{h(t \mid \mathbf{x}_2)} = \frac{h_0(t)\exp(\boldsymbol{\beta}^{\top}\mathbf{x}_1)}{h_0(t)\exp(\boldsymbol{\beta}^{\top}\mathbf{x}_2)} = \exp(\boldsymbol{\beta}^{\top}(\mathbf{x}_1 - \mathbf{x}_2))
$$
关键在于，基准风险函数 $h_0(t)$ 在此比率中被约去，使得风险比 $HR$ 成为一个不依赖于时间 $t$ 的常数。这便是**[比例风险](@entry_id:166780) (PH) 假设**。它意味着协变量对风险的影响在整个随访期间是恒定的。对数风险比，即 $\boldsymbol{\beta}^{\top}(\mathbf{x}_1 - \mathbf{x}_2)$，同样也是一个与时间无关的常数。[@problem_id:4986317]

然而，在许多现实场景中，这一假设可能不成立。例如，一个治疗方法的效果可能随时间减弱或增强。在这种情况下，系数向量本身可能是时间的函数，即 $\boldsymbol{\beta}(t)$。此时，模型变为时[变系数模型](@entry_id:635059)，其风险比 $HR(t) = \exp(\boldsymbol{\beta}(t)^{\top}(\mathbf{x}_1 - \mathbf{x}_2))$ 明确地依赖于时间 $t$，从而违反了PH假设。[@problem_id:4986289] 因此，对PH假设进行诊断性检验，是任何严谨的[Cox模型](@entry_id:164053)分析中不可或缺的一步。

### Schoenfeld残差：一种比例性的诊断工具

Schoenfeld残差是专门为检验PH假设而设计的诊断工具。它的核心思想是在每个事件发生的时间点，比较实际发生事件个体的协变量值与“期望”的协变量值之间的差异。

#### 定义与计算

对于模型中的第 $k$ 个协变量 $X_k$，在事件时间 $t_i$ 发生的事件中，对应个体的协变量值为 $x_{ik}$。该事件的**Schoenfeld残差** $r_{ik}$ 定义为观测值与在风险集 $R(t_i)$（即在时间 $t_i$ 之前仍然存活且在观测中的所有个体的集合）中[期望值](@entry_id:150961)的差：
$$
r_{ik} = x_{ik} - \mathbb{E}[X_k \mid R(t_i); \hat{\boldsymbol{\beta}}]
$$
这里的 $\hat{\boldsymbol{\beta}}$ 是通过最大化偏似然函数得到的[系数估计](@entry_id:175952)向量。[@problem_id:4986331]

这个“[期望值](@entry_id:150961)”实际上是风险集中所有个体协变量值的加权平均值，其形式源于Cox模型偏似然函数的得分函数（score function）。具体而言：
$$
\mathbb{E}[X_k \mid R(t_i); \hat{\boldsymbol{\beta}}] = \bar{x}_k(t_i; \hat{\boldsymbol{\beta}}) = \frac{\sum_{j \in R(t_i)} x_{jk} \exp(\hat{\boldsymbol{\beta}}^{\top} \mathbf{x}_j)}{\sum_{j \in R(t_i)} \exp(\hat{\boldsymbol{\beta}}^{\top} \mathbf{x}_j)}
$$
[@problem_id:4986361]

权重 $w_{ij} = \frac{\exp(\hat{\boldsymbol{\beta}}^{\top} \mathbf{x}_j)}{\sum_{l \in R(t_i)} \exp(\hat{\boldsymbol{\beta}}^{\top} \mathbf{x}_l)}$ 具有清晰的概率解释：它代表了在给定风险集 $R(t_i)$ 和模型参数 $\hat{\boldsymbol{\beta}}$ 的条件下，个体 $j$ 是在时间 $t_i$ 发生事件的条件概率。一个至关重要的特性是，基准风险函数 $h_0(t_i)$ 在这个概率的推导中被分子和分母的公因子约去。这意味着Schoenfeld残差的构造天然地使其对 $h_0(t)$ 的具体形式不敏感，从而能够专注于检验协变量效应的恒定性。[@problem_id:4986361] [@problem_id:4986331]

为了具体说明，假设在某个临床研究的事件时间 $t_3$，风险集 $R(t_3)$ 中包含三名患者，他们单一协变量 $X$ 的值分别为 $\{0, 1, 2\}$。事件恰好发生在协变量值为 $2$ 的患者身上。如果拟合的[Cox模型](@entry_id:164053)给出的[系数估计](@entry_id:175952)值为 $\hat{\beta} = \ln 2$，那么在 $t_3$ 时刻协变量的[期望值](@entry_id:150961)为：
$$
\bar{x}(t_3; \hat{\beta}) = \frac{(0 \cdot \exp(0 \cdot \ln 2)) + (1 \cdot \exp(1 \cdot \ln 2)) + (2 \cdot \exp(2 \cdot \ln 2))}{\exp(0 \cdot \ln 2) + \exp(1 \cdot \ln 2) + \exp(2 \cdot \ln 2)} = \frac{0 \cdot 1 + 1 \cdot 2 + 2 \cdot 4}{1 + 2 + 4} = \frac{10}{7}
$$
因此，Schoenfeld残差为 $r_3 = 2 - \frac{10}{7} = \frac{4}{7}$。[@problem_id:4986331] 值得注意的是，Schoenfeld残差只在事件发生的时间点有定义，因为它们源于偏似然函数的构成，而偏[似然函数](@entry_id:141927)只在事件时间有贡献项。[@problem_id:4986331]

### 理论基础：为何Schoenfeld残差能够奏效

Schoenfeld残差之所以能有效诊断PH假设，其背后有深刻的统计学理论支持。

在PH假设成立的**原假设**（null hypothesis）下，协变量效应 $\boldsymbol{\beta}$ 是一个常数。理论上可以证明，Schoenfeld残差序列 $\{r_{ik}\}$ 应该围绕零值随机波动，不表现出任何系统性的时间趋势。[@problem_id:4986362] 更严格地讲，从[计数过程](@entry_id:260664)和鞅理论的视角来看，在真实的参数 $\boldsymbol{\beta}_0$ 下，Cox模型的得分过程是一个零均值鞅（zero-mean martingale）。Schoenfeld残差正是这个得分过程在每个事件时间点的增量。鞅的性质保证了在给定历史信息的情况下，每个残差的条件期望为零。[@problem_id:4986286] [@problem_id:4986331] 这个优美的理论性质确保了在原假设下，残差序列与任何可预测的时间函数都是不相关的，这构成了所有后续统计检验的基石。

相反，当PH假设被违反，即真实系数是时变的 $\boldsymbol{\beta}(t)$ 时（**备择假设**），Schoenfeld残差的[期望值](@entry_id:150961)将不再为零。其[期望值](@entry_id:150961)会系统地偏离零，并且这种偏离的模式与 $\boldsymbol{\beta}(t)$ 随时间变化的方式有关。具体来说，在时间 $t_i$ 的期望残差近似地与真实时变系数 $\beta_k(t_i)$ 和模型估计出的平均恒定系数 $\hat{\beta}_k$ 之差成正比，即 $E[r_{ik}(t_i)] \propto \beta_k(t_i) - \hat{\beta}_k$。[@problem_id:4986289] 正是这种系统性的偏离，使得Schoenfeld残差成为探测非比例风险的有力工具。

### 可视化诊断：解读[残差图](@entry_id:169585)

将理论应用于实践，最直观的方法是绘制Schoenfeld残差与时间的散点图，并通过它来评估PH假设。

#### [残差图](@entry_id:169585)的构建与解读

标准的做法是绘制Schoenfeld残差（或其缩放版本）关于时间 $t$ 或时间的某个变换（如 $\log t$）的散点图。为了更好地观察潜在趋势，通常会在此图上叠加一条平滑曲线（smoother）。

*   **符合PH假设的模式**：如果PH假设成立，散点应围绕水平线 $y=0$ 随机分布，平滑曲线也应近似为一条在零值附近的水平线。[@problem_id:4986362]
*   **违反PH假设的模式**：如果平滑曲线系统地偏离零，则提示PH假设可能被违反。例如，一条从负值区域单调递增至正值区域的平滑曲线（即正向趋势），表明协变量的系数 $\beta_k(t)$ 随时间增加，意味着其风险比也随时间增加。[@problem_id:4986317] [@problem_id:4986289] 反之，负向趋势则表明风险比随时间减小。

#### 实践中的注意事项

解读[残差图](@entry_id:169585)时必须保持审慎，因为一些伪影可能会误导分析。

*   **过度拟合的风险**：平滑曲线的选择至关重要。假设在一个包含150个事件的研究中，我们对[残差图](@entry_id:169585)应用了两种平滑器：一个选择了9个[有效自由度](@entry_id:161063)的高度灵活的[平滑器](@entry_id:636528)S1，以及一个通过[交叉验证](@entry_id:164650)选择了3个[有效自由度](@entry_id:161063)的稳健[平滑器](@entry_id:636528)S2。S1可能会产生许多围绕零值的小幅振荡，而S2则呈现出一条平缓的单调趋势。S1的“摆动”很可能是由于对随机噪声的过度拟合造成的，而S2所揭示的平缓趋势则更可能反映了真实的非比例性。这警示我们，应避免使用过于复杂的平滑器，并采用交叉验证等惩罚复杂度的原则来选择平滑度。[@problem_id:4986360]

*   **异方差性**：在[残差图](@entry_id:169585)中，通常可以观察到残差的离散程度（方差）随时间增加。这是因为随着时间的推移，风险集中的个体数量减少，导致基于风险集的估计（如协变量的[期望值](@entry_id:150961)）变得更加不确定。这种异方差性是正常现象，只要残差的均值没有系统性趋势，它本身并不构成反对PH假设的证据。[@problem_id:4986362]

*   **时间尺度的选择**：在x轴上使用 $\log t$ 而非原始时间 $t$ 是一种常见且有效的技术。它可以分散在早期密集的事件点，使模式更易于观察。然而，这仅仅是[坐标变换](@entry_id:138577)，并不能创造或消除一个真实的PH违规。过度拟合的风险在任何时间尺度上都同样存在。[@problem_id:4986360]

### 对[比例风险](@entry_id:166780)的正式[假设检验](@entry_id:142556)

除了直观的可视化诊断，我们还可以构建正式的统计检验来量化证据。

#### 缩放Schoenfeld残差

原始的Schoenfeld残差具有复杂的协方差结构，不便于直接用于检验。因此，我们通常使用**缩放Schoenfeld残差**（scaled Schoenfeld residuals）。一种重要的缩放方式是将[残差向量](@entry_id:165091)左乘一个与[系数估计](@entry_id:175952)量 $\hat{\boldsymbol{\beta}}$ 的协方差矩阵相关的矩阵，如 $r_i^{*} = d \cdot \text{Var}(\hat{\boldsymbol{\beta}}) r_i$（其中 $d$ 为事件数）。这种缩放的直观解释是，它将残差的尺度转换到了与[回归系数](@entry_id:634860) $\boldsymbol{\beta}$ 相同的尺度上。$r_i^{*}$ 的值可以被理解为，为了“解释”在时间 $t_i$ 观测到的残差，需要对[系数估计](@entry_id:175952)值 $\hat{\boldsymbol{\beta}}$ 做出的近似调整量。这个解释源于对[得分函数](@entry_id:164520)的[泰勒级数展开](@entry_id:138468)。[@problem_id:4986347]

#### 单个协变量的检验

对单个协变量 $X_k$ 的PH假设进行检验，通常被称为Grambsch-Therneau检验。该检验通过将缩放Schoenfeld残差 $r_{ik}^*$ 对某个预设的时间函数 $g(t_i)$ 进行回归：
$$
r_{ik}^* = \alpha_k + \theta_k g(t_i) + \varepsilon_{ik}
$$
检验PH假设的原假设等价于检验斜率系数是否为零，即 $H_0: \theta_k = 0$。

需要强调的是，由于残差 $\varepsilon_{ik}$ 之间存在相关性，这并非一个标准的普通最小二乘（OLS）回归。必须使用**广义最小二乘（GLS）**来估计 $\theta_k$，因为它能够正确处理缩放Schoenfeld残差的协方差结构。最终，基于GLS估计量 $\hat{\theta}_k$ 及其方差构造的[Wald检验](@entry_id:164095)统计量 $W_k = \hat{\theta}_k^2 / \widehat{\text{Var}}(\hat{\theta}_k)$ 将与自由度为1的[卡方分布](@entry_id:165213)（$\chi^2_1$）进行比较。[@problem_id:4986322]

#### 全局检验

为了同时检验模型中所有 $p$ 个协变量的PH假设，我们需要进行一个**全局检验**（omnibus test）。令 $\boldsymbol{\theta}$ 是一个包含所有 $p$ 个斜率估计值的 $p \times 1$ 向量，$\hat{\mathbf{V}}$ 是 $\boldsymbol{\theta}$ 的估计协方差矩阵。全局检验统计量是一个多元Wald统计量：
$$
T = \boldsymbol{\theta}^{\top} \hat{\mathbf{V}}^{-1} \boldsymbol{\theta}
$$
在所有协变量均满足PH假设的联合原假设下，该统计量 $T$ 近似服从自由度为 $p$ 的[卡方分布](@entry_id:165213)，即 $T \sim \chi^2_p$。[@problem_id:4986288]

### 综合应用：解读与对策

让我们通过一个综合案例来串联上述所有概念。

假设一项心脏病学的临床试验，模型中包含了治疗指标（$Z$）、年龄（$A$）和一项基线生物标志物（$B$）作为协变量。PH[假设检验](@entry_id:142556)的结果显示：全局检验显著（$p=0.015$）；针对各协变量的单独检验中，治疗 $Z$ 显著（$p=0.002$），而年龄 $A$ 和生物标志物 $B$ 不显著（$p>0.7$）；此外，变量 $Z$ 的Schoenfeld残差与 $\log(t)$ 呈显著正相关（$\rho=0.28$）。[@problem_id:4986317]

这一系列结果提供了强有力的证据，表明整个模型的PH假设被违反，而违规主要由治疗变量 $Z$ 引起。正相关性进一步揭示了违规的模式：治疗 $Z$ 的效果（即风险比）并非恒定，而是随时间推移而增强。对于年龄和生物标志物，我们没有找到违规的证据，但这并不等同于“证明”它们的效应绝对恒定。

当检测到像 $Z$ 这样的非比例风险时，一个符合统计学原则的修正方法是调整模型，以明确地对时变效应进行建模。最常见的方法是引入一个**与时间相关的交互项**，例如，在模型中加入 $Z \times \log(t)$。新的[模型风险](@entry_id:136904)函数形如 $h(t \mid X) = h_0(t) \exp\{\beta_Z Z + \dots + \gamma_Z (Z \cdot \log t)\}$，它将对数风险比明确地建模为 $\log(t)$ 的线性函数。[@problem_id:4986317]

最后，需要将这种方法与其他技术区分开来。例如，对模型按 $Z$ 进行**分层**（stratification）也是处理其非比例性的一种有效方法，但其机制完全不同。分层允许 $Z$ 的每个水平（例如治疗组和[对照组](@entry_id:188599)）拥有各自独立的基准风险函数 $h_{0,Z=1}(t)$ 和 $h_{0,Z=0}(t)$，但它**不会**估计变量 $Z$ 本身的风险比。认为分层会强制一个共同的基准风险或仍能得到一个单一的HR，是对分层方法的常见误解。[@problem_id:4986317]

通过Schoenfeld残差，我们获得了一个从可视化探索到严格[统计推断](@entry_id:172747)的完整框架，用以评估和应对[Cox模型](@entry_id:164053)中至关重要的[比例风险假设](@entry_id:163597)。