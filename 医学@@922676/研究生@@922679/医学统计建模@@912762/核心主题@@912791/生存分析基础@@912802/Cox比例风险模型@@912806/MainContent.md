## 引言
[Cox比例风险模型](@entry_id:174252)是现代统计学，特别是生存分析领域的一块基石。自D.R. Cox于1972年提出以来，它已成为分析“事件发生时间”数据（time-to-event data）最为广泛使用的工具之一，在医学研究、流行病学、工程可靠性乃至经济金融等领域都扮演着至关重要的角色。其核心魅力在于，它能够在不预设事件风险随时间变化具体模式的情况下，精准评估多个协变量（如治疗方案、患者特征或环境因素）对事件发生率的影响。

然而，要正确应用并深刻理解这一模型，必须掌握其背后的精妙设计。传统生存模型往往需要对生存时间的分布做出严格假定，而Cox模型如何绕开这一限制？当模型的关键假设——[比例风险](@entry_id:166780)——不成立时，我们又该如何应对？本篇文章旨在系统性地回答这些问题，为读者提供一个从理论到实践的全面指南。

在接下来的章节中，我们将分步深入探索Cox模型的全貌。首先，在“原理与机制”一章中，我们将从第一性原理出发，剖析模型的数学结构、[比例风险假设](@entry_id:163597)的内涵，并详细阐释革命性的[偏似然](@entry_id:165240)估计方法。接着，在“应用与跨学科连接”一章中，我们将通过丰富的实例，展示如何解读模型结果，并介绍一系列高级扩展，以应对时依协变量、聚类数据和[竞争风险](@entry_id:173277)等复杂数据挑战。最后，通过“动手实践”部分的练习，您将有机会亲手应用所学知识，巩固对核心概念的理解。通过这一结构化的学习路径，我们旨在帮助您彻底掌握Cox比例风险模型，并能自信地将其应用于您的研究和分析工作中。

## 原理与机制

在上一章引言的基础上，本章将深入探讨[Cox比例风险模型](@entry_id:174252)的数学原理、核心假设及其参数估计的精巧机制。我们将从第一性原理出发，构建模型，并阐明其为何在医学及其他领域的生存分析中占据核心地位。

### [比例风险模型](@entry_id:171806)：一种半[参数化](@entry_id:265163)表述

生存分析的核心是**[风险函数](@entry_id:166593)（hazard function）**，$h(t)$，它表示在时间点 $t$ 尚存活的个体在该瞬间发生事件的瞬时速率。形式上，它可以定义为：

$$
h(t) = \lim_{\Delta t \to 0^+} \frac{\mathbb{P}(t \le T \lt t + \Delta t \mid T \ge t)}{\Delta t}
$$

其中 $T$ 是事件发生的时间。在临床研究中，我们通常更关心协变量（covariates）——如治疗方法、年龄、生物标志物水平等——如何影响个体的风险。因此，我们关注**条件[风险函数](@entry_id:166593)** $h(t | \mathbf{X})$，它表示具有协变量向量 $\mathbf{X}$ 的个体在时间 $t$ 的风险。

Cox模型的基石是**比例风险（Proportional Hazards, PH）假设**。该假设规定，任意两个不同协变量向量（例如 $\mathbf{X}_1$ 和 $\mathbf{X}_2$）的个体，其[风险函数](@entry_id:166593)之比在所有时间点上均为一个常数。这个比值被称为**风险比（Hazard Ratio, HR）**：

$$
\operatorname{HR}(t; \mathbf{X}_1, \mathbf{X}_2) = \frac{h(t | \mathbf{X}_1)}{h(t | \mathbf{X}_2)} = \text{常数（不依赖于 } t \text{）}
$$

这个看似简单的假设具有深刻的含义。它意味着协变量对风险的影响是以一种乘法的方式，并且这种影响不随时间改变。例如，如果一种新疗法使得患者的风险降低一半（$\operatorname{HR}=0.5$），那么无论是在术后第一天还是第五年，该疗法都同样将患者的瞬时风险降低一半。

为了从这个假设推导出模型的具体形式，我们可以选择一个“基准”个体作为参照。通常，我们定义基准个体为所有协变量取值为零（$\mathbf{X} = \mathbf{0}$）的个体。其风险函数被称为**基线风险函数（baseline hazard function）**，记作 $h_0(t) \equiv h(t | \mathbf{X}=\mathbf{0})$。根据[比例风险假设](@entry_id:163597)，对于任何协变量为 $\mathbf{X}$ 的个体，其风险与基准风险之比应为一个不依赖于时间的函数 $g(\mathbf{X})$：

$$
\frac{h(t | \mathbf{X})}{h(t | \mathbf{X}=\mathbf{0})} = \frac{h(t | \mathbf{X})}{h_0(t)} = g(\mathbf{X})
$$

整理后得到：

$$
h(t | \mathbf{X}) = h_0(t) g(\mathbf{X})
$$

这个形式清晰地表明，任何满足[比例风险假设](@entry_id:163597)的模型，其风险函数必须能分解为一个只与时间相关的部分（$h_0(t)$）和一个只与协变量相关的部分（$g(\mathbf{X})$）的乘积。

为了确保风险为正，并为协变量效应提供一个灵活且易于解释的框架，Cox爵士提出使用指数函数来定义 $g(\mathbf{X})$。具体而言，假设协变量通过[线性组合](@entry_id:155091) $\boldsymbol{\beta}^T \mathbf{X}$ 来影响风险，其中 $\boldsymbol{\beta}$ 是[回归系数](@entry_id:634860)向量。那么 $g(\mathbf{X})$ 的形式就定为 $\exp(\boldsymbol{\beta}^T \mathbf{X})$。这样，我们就得到了经典的**[Cox比例风险模型](@entry_id:174252)**表达式 [@problem_id:4987396]：

$$
h(t | \mathbf{X}) = h_0(t) \exp(\boldsymbol{\beta}^T \mathbf{X})
$$

在这个模型下，两个个体（协变量分别为 $\mathbf{X}_1$ 和 $\mathbf{X}_2$）的风险比为：

$$
\operatorname{HR} = \frac{h_0(t) \exp(\boldsymbol{\beta}^T \mathbf{X}_1)}{h_0(t) \exp(\boldsymbol{\beta}^T \mathbf{X}_2)} = \exp(\boldsymbol{\beta}^T (\mathbf{X}_1 - \mathbf{X}_2))
$$

正如所预期的，基线风险函数 $h_0(t)$ 在比值中被消去，使得风险比不依赖于时间 $t$，这与[比例风险假设](@entry_id:163597)完全吻合。

### 模型的组成部分与“半参数”特性

[Cox模型](@entry_id:164053)的优美之处在于其巧妙的结构，它融合了非参数和参数两种成分，因此被称为**[半参数模型](@entry_id:200031)（semi-parametric model）** [@problem_id:1911752]。

#### 非参数部分：基线[风险函数](@entry_id:166593) $h_0(t)$

模型中的 $h_0(t)$ 是一个**非参数**组件。这意味着我们不对其函数形式做任何预设的假定。它可以是任意形状——单调递增、递减、驼峰状或更复杂的形态。这种灵活性是[Cox模型](@entry_id:164053)强大的关键原因之一，因为它允许我们捕捉事件风险随时间变化的任何潜在模式，而无需强制其符合某个特定的概率分布（如指数分布或[威布尔分布](@entry_id:270143)）。

$h_0(t)$ 的解释非常直观。它是在所有协变量都为零时，个体所具有的潜在风险随时间变化的模式 [@problem_id:1911764]。例如，在一个研究客户重复购买行为的电子商务模型中，如果协变量包括是否为付费会员（$x_1=1$ 为是，$x_1=0$ 为否）和收到的代金券金额（$x_2$），那么 $h_0(t)$ 就代表了那些非付费会员且没有收到任何代金券的顾客（即 $x_1=0, x_2=0$）在距离上次购买 $t$ 天后，进行下一次购买的瞬时速率。

#### 参数部分：协变量效应 $\exp(\boldsymbol{\beta}^T \mathbf{X})$

模型中的 $\exp(\boldsymbol{\beta}^T \mathbf{X})$ 是一个**参数**组件。它明确规定了协变量如何通过一个有限的参数集 $\boldsymbol{\beta}$ 来共同影响风险。系数 $\beta_k$ 的解释非常直接：它是对应协变量 $x_k$ 的**对数风险比（log-hazard ratio）**。当协变量 $x_k$ 增加一个单位，而其他协变量保持不变时，[风险函数](@entry_id:166593)将在所有时间点上乘以一个因子 $\exp(\beta_k)$。如果 $\beta_k > 0$，则 $\exp(\beta_k) > 1$，说明 $x_k$ 是一个风险因素；如果 $\beta_k  0$，则 $\exp(\beta_k)  1$，说明 $x_k$ 是一个保护性因素。

正是这种“未指定形状的基线风险”与“明确[参数化](@entry_id:265163)的协变量效应”的结合，赋予了Cox模型“半参数”的称号 [@problem_id:1911752]。

### [比例风险假设](@entry_id:163597)的检验与违背

尽管[比例风险假设](@entry_id:163597)是[Cox模型](@entry_id:164053)的核心，但它并非永远成立。在实际应用中，检验这一假设至关重要。当协变量对风险的影响随时间变化时，该假设就会被违背。

一个经典的违背[比例风险假设](@entry_id:163597)的例子是比较两种截然不同的癌症治疗方案 [@problem_id:1911730]。假设“治疗组”接受一种高风险但可能根治的外科手术，而“[对照组](@entry_id:188599)”接受标准的药物治疗。

- **治疗组（手术）**：术后短期内，由于手术并发症（如感染、出血），死亡风险可能非常高。但如果患者成功度过危险期，其长期复发风险可能很低。其风险函数 $h_T(t)$ 可能呈现出初期极高、随后迅速下降并趋于平稳的形态。
- **[对照组](@entry_id:188599)（药物）**：药物治疗初期风险较低，但随着时间推移，可能出现耐药性或药物毒性累积，导致风险逐渐升高。其[风险函数](@entry_id:166593) $h_C(t)$ 可能呈现出随时间线性增加的形态。

在这种情况下，两组的风险曲线可能会在某个时间点交叉。在交叉点之前，手术组的风险更高（$\operatorname{HR} > 1$）；在交叉点之后，药物组的风险更高（$\operatorname{HR}  1$）。由于风险比 $\frac{h_T(t)}{h_C(t)}$ 明显依赖于时间 $t$，[比例风险假设](@entry_id:163597)被违背。此时，强行使用标准的[Cox模型](@entry_id:164053)会得出误导性或平均化的结论，掩盖了治疗效果随时间变化的动态过程。

### 参数估计：[偏似然](@entry_id:165240)法的精妙之处

既然基线[风险函数](@entry_id:166593) $h_0(t)$ 的形式是未知的，我们如何才能估计参数 $\boldsymbol{\beta}$ 呢？直接构建传统的全[似然函数](@entry_id:141927)是困难的，因为它会同时包含参数 $\boldsymbol{\beta}$ 和无限维的非参数函数 $h_0(t)$。

为了解决这个问题，D.R. Cox 提出了一种革命性的方法，称为**[偏似然](@entry_id:165240)法（Partial Likelihood）**。其核心思想是，忽略事件发生的具体时间点，转而关注在每个事件发生时刻，是“哪一个”个体发生了事件。通过对事件发生的**顺序**信息进行建模，可以构建一个不依赖于 $h_0(t)$ 的似然函数 [@problem_id:4g87368]。

#### 生存数据的复杂结构

在进入[偏似然](@entry_id:165240)的细节之前，我们必须认识到生存数据通常具有复杂的结构，最常见的是**[右删失](@entry_id:164686)（right censoring）**和**左截断（left truncation）**。

- **[右删失](@entry_id:164686)**：当我们在研究结束时，一个体仍未发生事件，或者在研究期间因失访等原因停止观察时，我们只知道其生存时间大于已知的观察时间。例如，一个体在 $C_i$ 时刻失访，其真实事件时间 $T_i$ 未知，但我们知道 $T_i > C_i$。观测到的数据是 $Y_i = \min(T_i, C_i)$ 和一个事件指示符 $\Delta_i = \mathbb{I}(T_i \le C_i)$。
- **左截断**（或称延迟进入）：当个体不是从时间零点（如出生或诊断）开始被观察，而是在某个稍后的时间点 $E_i$ 才进入研究时，就会发生左截断。只有那些至少存活到 $E_i$ 的个体才有可能被纳入研究。

为了从这类不完整的数据中得到无偏的估计，一个关键的假设是**独立删失（independent censoring）**。这个假设的准确表述是，在给定协变量历史的条件下，删失机制与事件发生过程是独立的 [@problem_id:4987392]。这意味着，一个体在某个时间点被删失，这一事实本身并不提供关于其未来事件风险的额外信息（超出其协变量已提供的信息）。

#### [偏似然](@entry_id:165240)的构建

[偏似然](@entry_id:165240)法的逻辑如下：让我们考虑一个发生事件的时间点 $t_{(j)}$。在这一刻，有一个特定的个体（比如个体 $j$）发生了事件。同时，在这一刻之前，有一组个体仍然处于“被观察且未发生事件”的状态。这组个体被称为**风险集（risk set）**，记作 $R(t_{(j)})$。风险集包括了在 $t_{(j)}$ 时刻发生事件的个体 $j$，以及所有其他在 $t_{(j)}$ 时刻仍然存活且未被删失的个体。

一个非常重要的点是，即使一个体的数据最终是删失的，它仍然对偏似然函数有贡献。例如，一个在 $t=12$ 个月时被删失的患者，对于在 $t=9$ 个月发生的事件，他/她仍然在风险集中，因为在 $t=9$ 时，他/她仍然“有风险” [@problem_id:1911718]。

[偏似然](@entry_id:165240)的单个贡献项就是计算在已知 $t_{(j)}$ 时刻风险集 $R(t_{(j)})$ 中有且仅有一个事件发生的情况下，这个事件恰好发生在个体 $j$ 身上的条件概率。

$$
L_j(\boldsymbol{\beta}) = \mathbb{P}(\text{个体 } j \text{ 在 } t_{(j)} \text{ 发生事件} \mid \text{在 } R(t_{(j)}) \text{ 中有一个事件发生})
$$

在 $t_{(j)}$ 时刻的一个极小时间间隔内，个体 $k$ 发生事件的概率近似为其风险 $h(t_{(j)} | \mathbf{X}_k)$。因此，上述条件概率可以表示为个体 $j$ 的风险占风险集中所有个体风险总和的比例：

$$
L_j(\boldsymbol{\beta}) = \frac{h(t_{(j)} | \mathbf{X}_j)}{\sum_{k \in R(t_{(j)})} h(t_{(j)} | \mathbf{X}_k)}
$$

现在，代入[Cox模型](@entry_id:164053)的表达式 $h(t | \mathbf{X}) = h_0(t) \exp(\boldsymbol{\beta}^T \mathbf{X})$：

$$
L_j(\boldsymbol{\beta}) = \frac{h_0(t_{(j)}) \exp(\boldsymbol{\beta}^T \mathbf{X}_j)}{\sum_{k \in R(t_{(j)})} h_0(t_{(j)}) \exp(\boldsymbol{\beta}^T \mathbf{X}_k)}
$$

奇迹发生了：作为公因子的基线风险函数 $h_0(t_{(j)})$ 在分子和分母中被完美地消掉了！[@problem_id:4g87368] 最终我们得到的[偏似然](@entry_id:165240)贡献项完全不依赖于未知的 $h_0(t)$：

$$
L_j(\boldsymbol{\beta}) = \frac{\exp(\boldsymbol{\beta}^T \mathbf{X}_j)}{\sum_{k \in R(t_{(j)})} \exp(\boldsymbol{\beta}^T \mathbf{X}_k)}
$$

这个表达式的分子是发生事件的那个个体的风险的参数部分 [@problem_id:1911751]，而分母是风险集中所有个体（包括发生事件的个体和在该时刻仍然存活的其他人）风险的参数部分之和。

完整的**偏[似然函数](@entry_id:141927)**就是所有观测到的事件的贡献项的连乘积：

$$
L(\boldsymbol{\beta}) = \prod_{j: \text{事件发生}} \frac{\exp(\boldsymbol{\beta}^T \mathbf{X}_j)}{\sum_{k \in R(t_{(j)})} \exp(\boldsymbol{\beta}^T \mathbf{X}_k)}
$$

通过最大化这个关于 $\boldsymbol{\beta}$ 的函数，我们就可以得到 $\boldsymbol{\beta}$ 的估计值，而完全无需知道或估计 $h_0(t)$ 的具体形式。

例如，在一个小型研究中，我们有三位受试者的数据 [@problem_id:1911734]：
- 受试者1：$Z=1$（治疗组），在 $t=5$ 时发生事件。
- 受试者2：$Z=0$（安慰剂组），在 $t=8$ 时发生事件。
- 受试者3：$Z=0$（安慰剂组），在 $t=10$ 时被删失。

最早的事件发生在 $t=5$（受试者1）。在这一刻，风险集 $R(5)$ 包括所有尚未发生事件或被删失的个体，即 {受试者1, 受试者2, 受试者3}。因此，对应于 $t=5$ 事件的[偏似然](@entry_id:165240)项为：

$$
L_1(\beta) = \frac{\exp(\beta \cdot Z_1)}{\exp(\beta \cdot Z_1) + \exp(\beta \cdot Z_2) + \exp(\beta \cdot Z_3)} = \frac{\exp(\beta \cdot 1)}{\exp(\beta \cdot 1) + \exp(\beta \cdot 0) + \exp(\beta \cdot 0)} = \frac{\exp(\beta)}{\exp(\beta) + 2}
$$

#### 实际问题：时间结（Tied Events）

[偏似然](@entry_id:165240)的标准推导依赖于事件时间是连续的，即任意两个事件不会在完全相同的时间点发生。但在实际数据收集中，由于记录精度（如记录到天或月），我们经常会遇到**时间结**，即多个个体在同一个记录时间点发生事件。

时间结的存在对标准[偏似然](@entry_id:165240)的构建提出了挑战，因为它破坏了“在每个事件时间点只有一个事件发生”的假设，使得事件的唯一排序变得模糊 [@problem_id:1911707]。为了处理这个问题，统计学家们发展了多种近似方法，如Breslow法和Efron法，以及一种被称为“精确法”的离散时间似然。这些方法调整了[偏似然](@entry_id:165240)分母的计算方式，以更准确地反映在存在时间结时，从风险集中选择出发生事件的特定个体组合的概率。

总之，[Cox比例风险模型](@entry_id:174252)通过其巧妙的半参数结构和独创的[偏似然](@entry_id:165240)估计方法，在理论的严谨性和应用的灵活性之间取得了完美的平衡。它允许研究者在不预设潜在风险时间模式的情况下，稳健地估计协变量对事件风险的影响，这使其成为现代生存分析中不可或缺的工具。