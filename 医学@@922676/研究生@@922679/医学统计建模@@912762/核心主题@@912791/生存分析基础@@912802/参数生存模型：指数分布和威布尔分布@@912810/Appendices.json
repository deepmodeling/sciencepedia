{"hands_on_practices": [{"introduction": "本次练习是参数推断中的一项基础实践。我们将从最简单的参数生存模型——指数模型入手，从第一性原理出发，推导其平均生存时间的估计量。通过完成最大似然估计的步骤，并应用德尔塔方法（delta method）构建置信区间，你将为理解生存分析中的统计推断过程打下坚实的基础 [@problem_id:4977968]。", "problem": "在一个恒定风险假设下，分析了一个患有快速致命疾病的患者的单臂前瞻性队列。具体来说，假设个体事件时间是独立的，并服从率参数为 $\\lambda$ 的指数分布，这是形状参数等于 $1$ 的威布尔分布的特例。右删失是独立的且非信息性的。令 $d$ 表示观测到的事件数，令 $S$ 表示总的风险暴露时间（所有个体随访时间之和，包括事件和删失观测）。在本研究中，观测到的计数为 $d = 52$，$S = 294.1$ 患者-年。\n\n仅从指数模型下独立右删失的参数似然、最大似然估计（MLE）的大样本正态性以及德尔塔方法的核心定义出发，为平均生存时间 $\\mu = 1/\\lambda$ 构建一个名义覆盖率为 $0.95$ 的双侧瓦尔德型置信区间（CI）。明确推导出 $\\lambda$ 的最大似然估计，通过费雪信息得到其大样本方差，然后应用德尔塔方法获得 $\\mu$ 的估计量的标准误。最后，计算该置信区间的数值端点。\n\n以年为单位表示最终的置信区间端点，并将您的答案四舍五入到三位有效数字。", "solution": "该问题要求在指数模型下，为右删失数据的平均生存时间 $\\mu$ 构建一个 $95\\%$ 的置信区间。推导过程必须从第一性原理出发。\n\n令 $T$ 为患者事件时间的随机变量。已知 $T$ 服从常数率参数为 $\\lambda  0$ 的指数分布。其概率密度函数（PDF）为 $f(t; \\lambda) = \\lambda \\exp(-\\lambda t)$（对于 $t \\ge 0$），生存函数为 $S(t; \\lambda) = P(T  t) = \\exp(-\\lambda t)$。平均生存时间为 $\\mu = E[T] = 1/\\lambda$。\n\n数据存在独立的、非信息性的右删失。对于队列中的 $n$ 个患者，我们观测到时间 $y_i = \\min(t_i, c_i)$，其中 $t_i$ 是真实事件时间，$c_i$ 是删失时间。我们还观测到一个事件指示符 $\\delta_i$，如果事件被观测到（$t_i \\le c_i$），则 $\\delta_i$ 为 $1$，如果观测值被删失（$t_i  c_i$），则 $\\delta_i$ 为 $0$。\n\n单个观测值 $(y_i, \\delta_i)$ 对似然函数的贡献是：如果事件发生，则为概率密度函数；如果观测被删失，则为生存函数：\n$$L_i(\\lambda) = [f(y_i; \\lambda)]^{\\delta_i} [S(y_i; \\lambda)]^{1-\\delta_i}$$\n代入指数分布的概率密度函数和生存函数：\n$$L_i(\\lambda) = [\\lambda \\exp(-\\lambda y_i)]^{\\delta_i} [\\exp(-\\lambda y_i)]^{1-\\delta_i} = \\lambda^{\\delta_i} \\exp(-\\lambda y_i \\delta_i) \\exp(-\\lambda y_i (1-\\delta_i)) = \\lambda^{\\delta_i} \\exp(-\\lambda y_i)$$\n假设独立，整个包含 $n$ 个患者的队列的总似然函数是各个贡献的乘积：\n$$L(\\lambda) = \\prod_{i=1}^n L_i(\\lambda) = \\prod_{i=1}^n \\left( \\lambda^{\\delta_i} \\exp(-\\lambda y_i) \\right) = \\lambda^{\\sum_{i=1}^n \\delta_i} \\exp\\left(-\\lambda \\sum_{i=1}^n y_i\\right)$$\n问题提供了汇总统计量：观测到的事件总数 $d = \\sum_{i=1}^n \\delta_i$，以及总的风险暴露时间 $S = \\sum_{i=1}^n y_i$。因此，似然函数可以用这些充分统计量来表示：\n$$L(\\lambda; d, S) = \\lambda^d \\exp(-\\lambda S)$$\n为了找到 $\\lambda$ 的最大似然估计（MLE），我们首先构造对数似然函数 $\\ell(\\lambda)$:\n$$\\ell(\\lambda) = \\ln(L(\\lambda)) = d \\ln(\\lambda) - \\lambda S$$\n接下来，我们求对数似然函数关于 $\\lambda$ 的一阶导数（得分函数），并将其设为零：\n$$\\frac{d\\ell}{d\\lambda} = \\frac{d}{\\lambda} - S = 0$$\n求解 $\\lambda$ 得到其最大似然估计 $\\hat{\\lambda}$:\n$$\\hat{\\lambda} = \\frac{d}{S}$$\n我们感兴趣的参数是平均生存时间 $\\mu = 1/\\lambda$。根据最大似然估计的不变性，$\\mu$ 的最大似然估计是：\n$$\\hat{\\mu} = \\frac{1}{\\hat{\\lambda}} = \\frac{S}{d}$$\n为了构建瓦尔德型置信区间，我们需要估计量的大样本方差。我们首先使用费雪信息来找到 $\\hat{\\lambda}$ 的方差。观测费雪信息 $I(\\lambda)$ 定义为对数似然函数二阶导数的负值。\n$$\\frac{d^2\\ell}{d\\lambda^2} = -\\frac{d}{\\lambda^2}$$\n在最大似然估计 $\\hat{\\lambda}$ 处计算的观测费雪信息是：\n$$I_{\\text{obs}}(\\hat{\\lambda}) = -\\left. \\frac{d^2\\ell}{d\\lambda^2} \\right|_{\\lambda=\\hat{\\lambda}} = -\\left(-\\frac{d}{\\hat{\\lambda}^2}\\right) = \\frac{d}{\\hat{\\lambda}^2}$$\n$\\hat{\\lambda}$ 的大样本方差可以通过观测费雪信息的倒数来近似：\n$$\\widehat{\\text{Var}}(\\hat{\\lambda}) \\approx [I_{\\text{obs}}(\\hat{\\lambda})]^{-1} = \\frac{\\hat{\\lambda}^2}{d}$$\n代入 $\\hat{\\lambda} = d/S$:\n$$\\widehat{\\text{Var}}(\\hat{\\lambda}) = \\frac{(d/S)^2}{d} = \\frac{d^2/S^2}{d} = \\frac{d}{S^2}$$\n我们需要 $\\hat{\\mu} = 1/\\hat{\\lambda}$ 的方差。我们使用德尔塔方法。令 $g(\\lambda) = 1/\\lambda$。$g(\\hat{\\lambda})$ 的渐近方差由 $\\text{Var}(g(\\hat{\\lambda})) \\approx [g'(\\lambda)]^2 \\text{Var}(\\hat{\\lambda})$ 给出。其导数为 $g'(\\lambda) = -1/\\lambda^2$。\n因此，$\\hat{\\mu}$ 的估计方差为：\n$$\\widehat{\\text{Var}}(\\hat{\\mu}) = [g'(\\hat{\\lambda})]^2 \\widehat{\\text{Var}}(\\hat{\\lambda}) = \\left(-\\frac{1}{\\hat{\\lambda}^2}\\right)^2 \\left(\\frac{\\hat{\\lambda}^2}{d}\\right) = \\frac{1}{\\hat{\\lambda}^4} \\frac{\\hat{\\lambda}^2}{d} = \\frac{1}{d\\hat{\\lambda}^2}$$\n由于 $\\hat{\\mu} = 1/\\hat{\\lambda}$，我们可以用 $\\hat{\\mu}$ 来表示这个方差：\n$$\\widehat{\\text{Var}}(\\hat{\\mu}) = \\frac{\\hat{\\mu}^2}{d}$$\n$\\hat{\\mu}$ 的标准误（SE）是其估计方差的平方根：\n$$\\text{SE}(\\hat{\\mu}) = \\sqrt{\\frac{\\hat{\\mu}^2}{d}} = \\frac{\\hat{\\mu}}{\\sqrt{d}} \\quad (\\text{since } \\mu > 0)$$\n对于 $\\mu$，一个名义覆盖率为 $1-\\alpha$ 的双侧瓦尔德型置信区间由下式给出：\n$$\\hat{\\mu} \\pm z_{\\alpha/2} \\times \\text{SE}(\\hat{\\mu})$$\n其中 $z_{\\alpha/2}$ 是标准正态分布的上 $\\alpha/2$ 分位数。对于 $95\\%$ 的置信区间，$\\alpha = 0.05$，所以 $\\alpha/2 = 0.025$。相应的临界值为 $z_{0.025} \\approx 1.95996$。\n\n现在我们代入研究中的数值：$d = 52$ 和 $S = 294.1$ 患者-年。\n首先，我们计算平均生存时间 $\\mu$ 的最大似然估计：\n$$\\hat{\\mu} = \\frac{S}{d} = \\frac{294.1}{52} \\approx 5.655769 \\text{ 年}$$\n接下来，我们计算 $\\hat{\\mu}$ 的标准误：\n$$\\text{SE}(\\hat{\\mu}) = \\frac{\\hat{\\mu}}{\\sqrt{d}} = \\frac{5.655769...}{\\sqrt{52}} \\approx \\frac{5.655769...}{7.211102...} \\approx 0.784323 \\text{ 年}$$\n$95\\%$ 置信区间的误差范围（ME）是：\n$$\\text{ME} = z_{0.025} \\times \\text{SE}(\\hat{\\mu}) \\approx 1.95996 \\times 0.784323 \\approx 1.53724 \\text{ 年}$$\n置信区间的端点是：\n下限：$\\hat{\\mu} - \\text{ME} \\approx 5.655769 - 1.53724 = 4.118529$ 年。\n上限：$\\hat{\\mu} + \\text{ME} \\approx 5.655769 + 1.53724 = 7.193009$ 年。\n\n问题要求将最终端点四舍五入到三位有效数字。\n下限：$4.118529 \\rightarrow 4.12$\n上限：$7.193009 \\rightarrow 7.19$\n\n平均生存时间 $\\mu$ 的 $95\\%$ 置信区间约为 $(4.12, 7.19)$ 年。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n4.12  7.19\n\\end{pmatrix}\n}\n$$", "id": "4977968"}, {"introduction": "尽管比例风险（Proportional Hazards, PH）模型和加速失效时间（Accelerated Failure Time, AFT）模型为协变量效应提供了不同的解读视角，但威布尔（Weibull）分布族在它们之间建立了一座独特的桥梁。本练习将探讨当这两个模型应用于符合指数分布（威布尔分布的特例）的同一份数据时，其回归系数之间精确的数学关系。掌握这种联系对于正确解释和比较来自这两种建模框架的结果至关重要 [@problem_id:4977979]。", "problem": "在一项评估首次再住院时间的随机临床试验中，令 $T$ 表示非负生存时间。假设基线事件时间分布为威布尔 (Weibull) 分布，其形状参数为 $k0$，尺度参数为 $\\lambda0$，因此基线生存函数为 $S_{0}(t)=\\exp\\!\\big(-(\\lambda t)^{k}\\big)$，基线风险率为 $h_{0}(t)=k\\,\\lambda^{k}\\,t^{k-1}$。考虑一个单一的二元协变量 $x\\in\\{0,1\\}$，它表示对干预措施的分配情况。在医学中常用的两种备选框架中对协变量效应进行建模：\n\n- 比例风险 (Proportional Hazards, PH) 模型：$h(t\\mid x)=h_{0}(t)\\,\\exp(\\beta_{\\text{PH}}\\,x)$，其中 $\\beta_{\\text{PH}}$ 为回归系数。\n- 加速失效时间 (Accelerated Failure Time, AFT) 模型：$T(x)=T_{0}\\,\\exp(\\gamma_{\\text{AFT}}\\,x)$，其中 $\\gamma_{\\text{AFT}}$ 为回归系数， $T_{0}$ 服从基线分布。\n\n从上述定义以及生存函数和风险函数的标准属性出发，推导在指数分布这一特殊情况（$k=1$）下，$\\beta_{\\text{PH}}$ 和 $\\gamma_{\\text{AFT}}$ 之间的代数关系。然后，解释在这种指数分布情况下，$x$ 每增加一个单位所对应的风险比 (hazard ratio) 与时间比 (time ratio) 之间的关系，并选择能同时正确描述系数关系和比率解释的陈述。\n\nA. 在指数基线分布下，回归参数满足 $\\beta_{\\text{PH}}=\\gamma_{\\text{AFT}}$，且风险比等于时间比。\n\nB. 在指数基线分布下，回归参数满足 $\\beta_{\\text{PH}}=-\\gamma_{\\text{AFT}}$，且风险比等于时间比的倒数。\n\nC. 在指数基线分布下，回归参数满足 $\\beta_{\\text{PH}}=-k\\,\\gamma_{\\text{AFT}}$（其中 $k$ 为形状参数），因此风险比等于时间比的 $k$ 次方。\n\nD. 在指数基线分布下，$\\beta_{\\text{PH}}$ 和 $\\gamma_{\\text{AFT}}$ 之间没有代数关联；风险比和时间比无法相互映射。", "solution": "### 推导与求解\n\n目标是找出当 PH 和 AFT 模型都适用于具有指数基线分布的过程时，回归系数 $\\beta_{\\text{PH}}$ 和 $\\gamma_{\\text{AFT}}$ 之间的关系。这是可能的，因为指数分布（以及更一般的威布尔分布）是唯一一个同时满足 PH 和 AFT 假设的常用参数族。我们可以通过找到每个模型下的生存函数并使它们相等来推导出这种关系。\n\n**1. AFT 模型的生存函数**\n\nAFT 模型由关系 $T(x) = T_0 \\exp(\\gamma_{\\text{AFT}} x)$ 定义，其中 $T_0$ 服从基线分布，其生存函数为 $S_0(t)$。对于具有协变量 $x$ 的个体，其生存函数表示为 $S_{\\text{AFT}}(t \\mid x)$：\n$$S_{\\text{AFT}}(t \\mid x) = P(T(x)  t)$$\n$$S_{\\text{AFT}}(t \\mid x) = P(T_0 \\exp(\\gamma_{\\text{AFT}} x)  t)$$\n$$S_{\\text{AFT}}(t \\mid x) = P(T_0  t \\exp(-\\gamma_{\\text{AFT}} x))$$\n根据定义，$P(T_0  u) = S_0(u)$，其中 $u = t \\exp(-\\gamma_{\\text{AFT}} x)$。因此：\n$$S_{\\text{AFT}}(t \\mid x) = S_0\\left(t \\exp(-\\gamma_{\\text{AFT}} x)\\right)$$\n基线分布为威布尔分布：$S_0(t) = \\exp(-(\\lambda t)^k)$。将其代入 $S_{\\text{AFT}}(t \\mid x)$ 的方程中：\n$$S_{\\text{AFT}}(t \\mid x) = \\exp\\left( -\\left(\\lambda \\left[t \\exp(-\\gamma_{\\text{AFT}} x)\\right]\\right)^k \\right)$$\n$$S_{\\text{AFT}}(t \\mid x) = \\exp\\left( -(\\lambda t)^k \\left[\\exp(-\\gamma_{\\text{AFT}} x)\\right]^k \\right)$$\n$$S_{\\text{AFT}}(t \\mid x) = \\exp\\left( -(\\lambda t)^k \\exp(-k \\gamma_{\\text{AFT}} x) \\right)$$\n\n**2. PH 模型的生存函数**\n\nPH 模型由风险函数 $h(t \\mid x) = h_0(t) \\exp(\\beta_{\\text{PH}} x)$ 定义。生存函数 $S_{\\text{PH}}(t \\mid x)$ 通过 $S_{\\text{PH}}(t \\mid x) = \\exp(-H(t \\mid x))$ 与累积风险函数 $H(t \\mid x) = \\int_0^t h(u \\mid x) du$ 相关联。\n首先，我们求累积风险函数：\n$$H(t \\mid x) = \\int_0^t h_0(u) \\exp(\\beta_{\\text{PH}} x) du = \\exp(\\beta_{\\text{PH}} x) \\int_0^t h_0(u) du$$\n积分 $\\int_0^t h_0(u) du$ 是基线累积风险函数 $H_0(t)$。我们知道 $S_0(t) = \\exp(-H_0(t))$，所以 $H_0(t) = -\\ln(S_0(t))$。\n给定 $S_0(t) = \\exp(-(\\lambda t)^k)$，基线累积风险为 $H_0(t) = - \\ln(\\exp(-(\\lambda t)^k)) = (\\lambda t)^k$。\n将此代回 $H(t \\mid x)$ 的表达式中：\n$$H(t \\mid x) = (\\lambda t)^k \\exp(\\beta_{\\text{PH}} x)$$\n因此，PH 模型的生存函数是：\n$$S_{\\text{PH}}(t \\mid x) = \\exp(-H(t \\mid x)) = \\exp\\left( -(\\lambda t)^k \\exp(\\beta_{\\text{PH}} x) \\right)$$\n\n**3. 联立模型并推导系数关系**\n\n要使这两个模型对于同一潜在过程等价，它们的生存函数必须对所有 $t  0$ 和任何 $x$ 都相同：\n$$S_{\\text{AFT}}(t \\mid x) = S_{\\text{PH}}(t \\mid x)$$\n$$\\exp\\left( -(\\lambda t)^k \\exp(-k \\gamma_{\\text{AFT}} x) \\right) = \\exp\\left( -(\\lambda t)^k \\exp(\\beta_{\\text{PH}} x) \\right)$$\n为了使这个等式成立，指数函数的参数必须相等：\n$$-(\\lambda t)^k \\exp(-k \\gamma_{\\text{AFT}} x) = -(\\lambda t)^k \\exp(\\beta_{\\text{PH}} x)$$\n两边同除以非零项 $-(\\lambda t)^k$ 得到：\n$$\\exp(-k \\gamma_{\\text{AFT}} x) = \\exp(\\beta_{\\text{PH}} x)$$\n两边取自然对数：\n$$-k \\gamma_{\\text{AFT}} x = \\beta_{\\text{PH}} x$$\n为了使这对任何 $x$（特别是对于 $x=1$）都成立，我们必须有：\n$$\\beta_{\\text{PH}} = -k \\gamma_{\\text{AFT}}$$\n这是威布尔分布的一般关系。\n\n问题要求的是**指数分布这一特殊情况**的结果，其中形状参数 $k=1$。将 $k=1$ 代入一般关系中：\n$$\\beta_{\\text{PH}} = -1 \\cdot \\gamma_{\\text{AFT}} \\implies \\beta_{\\text{PH}} = -\\gamma_{\\text{AFT}}$$\n\n**4. 关联风险比和时间比**\n\n-   **风险比 (Hazard Ratio, HR)**：HR 来自 PH 模型。它是 $x$ 变化一个单位（从 $x=0$ 到 $x=1$）的风险率之比：\n    $$HR = \\frac{h(t \\mid x=1)}{h(t \\mid x=0)} = \\frac{h_0(t)\\,\\exp(\\beta_{\\text{PH}} \\cdot 1)}{h_0(t)\\,\\exp(\\beta_{\\text{PH}} \\cdot 0)} = \\exp(\\beta_{\\text{PH}})$$\n-   **时间比 (Time Ratio, TR)**：TR（或加速因子）来自 AFT 模型。它是 $x$ 变化一个单位的预期（或任意分位数）生存时间之比。如果 $t_p(x)$ 是协变量值为 $x$ 时的第 $p$ 个百分位数，我们有 $t_p(x) = t_{p,0} \\exp(\\gamma_{\\text{AFT}}x)$，其中 $t_{p,0}$ 是基线百分位数。\n    $$TR = \\frac{t_p(1)}{t_p(0)} = \\frac{t_{p,0}\\,\\exp(\\gamma_{\\text{AFT}} \\cdot 1)}{t_{p,0}\\,\\exp(\\gamma_{\\text{AFT}} \\cdot 0)} = \\exp(\\gamma_{\\text{AFT}})$$\n-   **关系**：现在我们使用指数情况下的系数关系 $\\beta_{\\text{PH}} = -\\gamma_{\\text{AFT}}$ 来关联 HR 和 TR。\n    $$HR = \\exp(\\beta_{\\text{PH}}) = \\exp(-\\gamma_{\\text{AFT}})$$\n    由于 $TR = \\exp(\\gamma_{\\text{AFT}})$，我们可以写出：\n    $$HR = \\frac{1}{\\exp(\\gamma_{\\text{AFT}})} = \\frac{1}{TR}$$\n    因此，对于指数分布的情况，风险比是时间比的倒数。\n\n### 选项评估\n\n-   **A. 在指数基线分布下，回归参数满足 $\\beta_{\\text{PH}}=\\gamma_{\\text{AFT}}$，且风险比等于时间比。**\n    推导出的系数关系是 $\\beta_{\\text{PH}}=-\\gamma_{\\text{AFT}}$，而不是 $\\beta_{\\text{PH}}=\\gamma_{\\text{AFT}}$。推导出的比率关系是 $HR = 1/TR$，而不是 $HR=TR$。该陈述是**不正确的**。\n\n-   **B. 在指数基线分布下，回归参数满足 $\\beta_{\\text{PH}}=-\\gamma_{\\text{AFT}}$，且风险比等于时间比的倒数。**\n    系数关系 $\\beta_{\\text{PH}}=-\\gamma_{\\text{AFT}}$ 对于指数情况（$k=1$）是正确的。风险比（$HR$）等于时间比（$TR$）的倒数（$1/TR$）的解释也是正确的，如 $HR = \\exp(\\beta_{\\text{PH}}) = \\exp(-\\gamma_{\\text{AFT}}) = 1/\\exp(\\gamma_{\\text{AFT}}) = 1/TR$ 所示。该陈述是**正确的**。\n\n-   **C. 在指数基线分布下，回归参数满足 $\\beta_{\\text{PH}}=-k\\,\\gamma_{\\text{AFT}}$（其中 $k$ 为形状参数），因此风险比等于时间比的 $k$ 次方。**\n    威布尔分布的一般公式 $\\beta_{\\text{PH}}=-k\\,\\gamma_{\\text{AFT}}$ 是正确的。然而，对比率的解释是错误的。风险比是 $HR = \\exp(\\beta_{\\text{PH}}) = \\exp(-k\\gamma_{\\text{AFT}}) = (\\exp(\\gamma_{\\text{AFT}}))^{-k} = (TR)^{-k} = 1/(TR)^k$。该选项声称 $HR = (TR)^k$，这是不正确的。该陈述是**不正确的**。\n\n-   **D. 在指数基线分布下，$\\beta_{\\text{PH}}$ 和 $\\gamma_{\\text{AFT}}$ 之间没有代数关联；风险比和时间比无法相互映射。**\n    这是错误的。我们已经推导出了一个精确的代数关联 $\\beta_{\\text{PH}}=-\\gamma_{\\text{AFT}}$，从而得到映射关系 $HR=1/TR$。该陈述是**不正确的**。", "answer": "$$\\boxed{B}$$", "id": "4977979"}, {"introduction": "最后一个练习将从理论推导转向计算实现，这是任何现代统计学家的关键技能。你将推导 AFT-Weibull 模型在计算上更稳定的 Gumbel 分布形式下的对数似然函数，然后编写代码对其进行求值。此练习模拟了任何模型拟合程序的核心任务，让你亲身体验驱动参数生存模型数值优化的“引擎”是如何工作的 [@problem_id:4978000]。", "problem": "考虑一个右删失的事件时间数据集，其中每个个体 $i$ 提供一个观测时间 $t_i \\in (0,\\infty)$、一个删失指示符 $d_i \\in \\{0,1\\}$ 和一个协变量向量 $x_i \\in \\mathbb{R}^p$。加速失效时间 (AFT) Weibull 模型假设存在一个潜误差 $W_i$ 且满足关系 $\\log T_i = x_i^\\top \\beta + \\sigma W_i$，其中 $\\beta \\in \\mathbb{R}^p$ 是一个回归系数向量，$\\sigma \\in (0,\\infty)$ 是一个尺度参数。在 AFT Weibull 参数化中，误差 $W_i$ 被建模为服从标准极值（Gumbel，最小值）分布，其生存函数为 $S_W(w) = \\exp\\!\\big(-\\exp(w)\\big)$，概率密度函数为 $f_W(w) = \\exp(w)\\exp\\!\\big(-\\exp(w)\\big)$。您必须使用的基本依据是生存分析中的右删失似然：对于独立观测，$(t_i,d_i)$ 对似然的贡献是 $f_T(t_i)^{d_i} S_T(t_i)^{1-d_i}$，其中 $f_T$ 和 $S_T$ 分别表示事件时间变量 $T$ 的概率密度函数和生存函数。\n\n您的任务是：\n- 仅使用上述基本依据和定义，推导在右删失情况下 AFT Weibull 模型的似然函数，并完全用 Gumbel 概率密度函数 $f_W$ 和生存函数 $S_W$ 在变换后的残差 $W_i = \\big(\\log t_i - x_i^\\top \\beta\\big)/\\sigma$ 处的求值来表示。您的推导必须有理有据，并且必须解释从 $W_i$ 到 $T_i$ 的变量变换。\n- 提供一个数值稳定的对数似然评估程序，清楚地解释如何计算事件和删失观测的贡献，以避免浮点运算中的下溢或上溢。\n\n然后，实现一个程序，为一组测试用例计算总对数似然。对于每个测试用例，给定 $X \\in \\mathbb{R}^{n \\times p}$、$\\beta \\in \\mathbb{R}^p$、$\\sigma \\in (0,\\infty)$、$t \\in (0,\\infty)^n$ 和 $d \\in \\{0,1\\}^n$。您的程序必须计算总对数似然\n$$\n\\log L(\\beta,\\sigma; X, t, d) = \\sum_{i=1}^n \\left\\{ d_i \\log f_T(t_i) + (1-d_i) \\log S_T(t_i) \\right\\},\n$$\n使用通过 $W_i$ 和所推导的 Gumbel 函数的 AFT Weibull 表示进行评估。\n\n测试套件：\n- 测试用例 1（一般情况，混合事件和删失）：设 $n=5$, $p=1$,\n$$\nX = \\begin{bmatrix} 1.0 \\\\ 0.5 \\\\ 1.5 \\\\ 0.0 \\\\ 2.0 \\end{bmatrix},\\quad\n\\beta = \\begin{bmatrix} 0.2 \\end{bmatrix},\\quad\n\\sigma = 0.8,\n$$\n$$\nt = \\begin{bmatrix} 5.0 \\\\ 2.0 \\\\ 8.0 \\\\ 1.2 \\\\ 10.0 \\end{bmatrix},\\quad\nd = \\begin{bmatrix} 1 \\\\ 1 \\\\ 0 \\\\ 1 \\\\ 0 \\end{bmatrix}.\n$$\n- 测试用例 2（边界情况：全部右删失，包含较小时间）：设 $n=4$, $p=1$,\n$$\nX = \\begin{bmatrix} 1.0 \\\\ 1.0 \\\\ 1.0 \\\\ 1.0 \\end{bmatrix},\\quad\n\\beta = \\begin{bmatrix} -0.1 \\end{bmatrix},\\quad\n\\sigma = 1.0,\n$$\n$$\nt = \\begin{bmatrix} 0.5 \\\\ 1.0 \\\\ 3.0 \\\\ 0.8 \\end{bmatrix},\\quad\nd = \\begin{bmatrix} 0 \\\\ 0 \\\\ 0 \\\\ 0 \\end{bmatrix}.\n$$\n- 测试用例 3（小 $\\sigma$ 导致大的 Weibull 形状参数，两个协变量，混合事件）：设 $n=6$, $p=2$,\n$$\nX = \\begin{bmatrix}\n1.0  0.2 \\\\\n0.5  -0.3 \\\\\n1.5  0.0 \\\\\n0.0  1.0 \\\\\n2.0  -0.5 \\\\\n1.0  0.5\n\\end{bmatrix},\\quad\n\\beta = \\begin{bmatrix} 0.1 \\\\ -0.2 \\end{bmatrix},\\quad\n\\sigma = 0.3,\n$$\n$$\nt = \\begin{bmatrix} 4.0 \\\\ 1.5 \\\\ 6.0 \\\\ 0.9 \\\\ 3.2 \\\\ 2.1 \\end{bmatrix},\\quad\nd = \\begin{bmatrix} 1 \\\\ 1 \\\\ 1 \\\\ 0 \\\\ 1 \\\\ 0 \\end{bmatrix}.\n$$\n- 测试用例 4（大 $\\sigma$ 导致小的 Weibull 形状参数，两个协变量，时间值较大的混合事件）：设 $n=3$, $p=2$,\n$$\nX = \\begin{bmatrix}\n1.0  -1.0 \\\\\n0.0  2.0 \\\\\n3.0  0.5\n\\end{bmatrix},\\quad\n\\beta = \\begin{bmatrix} 0.3 \\\\ 0.1 \\end{bmatrix},\\quad\n\\sigma = 2.0,\n$$\n$$\nt = \\begin{bmatrix} 12.0 \\\\ 18.0 \\\\ 25.0 \\end{bmatrix},\\quad\nd = \\begin{bmatrix} 1 \\\\ 0 \\\\ 1 \\end{bmatrix}.\n$$\n\n答案规范：\n- 您的程序必须为上述 4 个测试用例中的每一个计算总对数似然。\n- 最终输出必须是单行，包含一个由逗号分隔的 4 个浮点数列表，每个数字四舍五入到 6 位小数，并用方括号括起来，按测试用例 1 到 4 的顺序排列；例如，输出形式为 $[a_1,a_2,a_3,a_4]$，其中每个 $a_k$ 是为测试用例 $k$ 计算的对数似然。", "solution": "该问题要求推导在右删失情况下加速失效时间 (AFT) Weibull 模型的对数似然，然后通过实现该模型来为几个测试用例计算总对数似然。推导必须基于第一性原理，从 AFT 关系和标准 Gumbel 误差分布的概率函数出发。\n\n### 步骤 1：似然函数的推导\n\n问题陈述将事件时间 $T_i$ 的 AFT 模型关系定义为：\n$$\n\\log T_i = x_i^\\top \\beta + \\sigma W_i\n$$\n其中 $W_i$ 是一个服从标准最小值 Gumbel 分布的随机变量。这可以重新整理以用 $T_i$ 表示 $W_i$：\n$$\nW_i = \\frac{\\log T_i - x_i^\\top \\beta}{\\sigma}\n$$\n对于一个特定的观测时间 $t_i$，我们将标准化残差 $w_i$ 定义为：\n$$\nw_i = \\frac{\\log t_i - x_i^\\top \\beta}{\\sigma}\n$$\n推导过程是通过将事件时间 $T$ 的生存函数 $S_T(t)$ 和概率密度函数 (PDF) $f_T(t)$ 用误差项 $W$ 的生存函数 $S_W(w)$ 和 PDF $f_W(w)$ 来表示。\n\n#### 生存函数 $S_T(t)$ 的推导\n生存函数 $S_T(t)$ 是事件时间 $T$ 大于某个时间 $t$ 的概率。\n$$\nS_T(t) = P(T > t) = P(\\log T > \\log t)\n$$\n代入 AFT 模型方程：\n$$\nS_T(t) = P(x_i^\\top \\beta + \\sigma W > \\log t)\n$$\n重新整理不等式以分离出 $W$：\n$$\nS_T(t) = P\\left(W > \\frac{\\log t - x_i^\\top \\beta}{\\sigma}\\right)\n$$\n根据定义，$P(W > w)$ 是 $W$ 的生存函数 $S_W(w)$。因此，对于在时间 $t_i$ 的观测 $i$：\n$$\nS_T(t_i) = S_W\\left(\\frac{\\log t_i - x_i^\\top \\beta}{\\sigma}\\right) = S_W(w_i)\n$$\n\n#### 概率密度函数 $f_T(t)$ 的推导\nPDF $f_T(t)$ 是生存函数 $S_T(t)$ 关于 $t$ 的负导数。\n$$\nf_T(t) = -\\frac{d}{dt} S_T(t)\n$$\n使用以 $S_W(w)$ 表示 $S_T(t)$ 的表达式，我们应用链式法则：\n$$\nf_T(t) = -\\frac{d}{dt} S_W\\left(\\frac{\\log t - x_i^\\top \\beta}{\\sigma}\\right)\n$$\n设 $w(t) = \\frac{\\log t - x_i^\\top \\beta}{\\sigma}$。链式法则给出：\n$$\nf_T(t) = \\left(-\\frac{d S_W(w)}{dw}\\Big|_{w=w(t)}\\right) \\cdot \\frac{dw(t)}{dt}\n$$\n第一项根据定义是 $W$ 的 PDF，$f_W(w) = -\\frac{d S_W(w)}{dw}$。第二项是从 $t$ 到 $w$ 变换的雅可比行列式：\n$$\n\\frac{dw(t)}{dt} = \\frac{d}{dt} \\left(\\frac{\\log t - x_i^\\top \\beta}{\\sigma}\\right) = \\frac{1}{\\sigma} \\frac{d}{dt}(\\log t) = \\frac{1}{\\sigma t}\n$$\n结合这些结果，在时间 $t_i$ 处观测 $i$ 的 PDF 是：\n$$\nf_T(t_i) = f_W\\left(\\frac{\\log t_i - x_i^\\top \\beta}{\\sigma}\\right) \\cdot \\frac{1}{\\sigma t_i} = f_W(w_i) \\frac{1}{\\sigma t_i}\n$$\n这个推导正确地解释了从 $W_i$ 到 $T_i$ 的变量变换。\n\n#### 构建对数似然\n在右删失数据集中，单个观测 $(t_i, d_i)$ 的似然贡献是 $L_i = f_T(t_i)^{d_i} S_T(t_i)^{1-d_i}$，其中如果事件被观测到则 $d_i=1$，如果观测被删失则 $d_i=0$。对于 $n$ 个独立观测，总对数似然是各个对数似然贡献的总和：\n$$\n\\log L(\\beta, \\sigma; X, t, d) = \\sum_{i=1}^n \\log(L_i) = \\sum_{i=1}^n \\left\\{ d_i \\log f_T(t_i) + (1-d_i) \\log S_T(t_i) \\right\\}\n$$\n代入我们推导出的 $f_T(t_i)$ 和 $S_T(t_i)$ 的表达式：\n$$\n\\log L = \\sum_{i=1}^n \\left\\{ d_i \\log\\left(f_W(w_i) \\frac{1}{\\sigma t_i}\\right) + (1-d_i) \\log S_W(w_i) \\right\\}\n$$\n$$\n\\log L = \\sum_{i=1}^n \\left\\{ d_i (\\log f_W(w_i) - \\log \\sigma - \\log t_i) + (1-d_i) \\log S_W(w_i) \\right\\}\n$$\n这就是按要求用 Gumbel PDF 和生存函数表示的对数似然。\n\n### 步骤 2：数值稳定的计算程序\n\n为了进行数值计算，我们将 Gumbel 函数的具体形式代入对数似然表达式中。问题提供了：\n- 生存函数：$S_W(w) = \\exp(-\\exp(w))$\n- PDF：$f_W(w) = \\exp(w) \\exp(-\\exp(w))$\n\n由此，我们推导它们的对数形式，这样计算起来更稳定：\n- $\\log S_W(w) = \\log(\\exp(-\\exp(w))) = -\\exp(w)$\n- $\\log f_W(w) = \\log(\\exp(w) \\exp(-\\exp(w))) = \\log(\\exp(w)) + \\log(\\exp(-\\exp(w))) = w - \\exp(w)$\n\n现在，我们将这些对数形式代入总对数似然方程：\n$$\n\\log L = \\sum_{i=1}^n \\left\\{ d_i (w_i - \\exp(w_i) - \\log \\sigma - \\log t_i) + (1-d_i) (-\\exp(w_i)) \\right\\}\n$$\n这个表达式可以通过合并包含 $\\exp(w_i)$ 的项来简化：\n$$\n\\log L = \\sum_{i=1}^n \\left\\{ d_i (w_i - \\log \\sigma - \\log t_i) - d_i \\exp(w_i) - (1-d_i) \\exp(w_i) \\right\\}\n$$\n$$\n\\log L = \\sum_{i=1}^n \\left\\{ d_i (w_i - \\log \\sigma - \\log t_i) - (d_i + 1 - d_i) \\exp(w_i) \\right\\}\n$$\n$$\n\\log L = \\sum_{i=1}^n \\left\\{ d_i (w_i - \\log \\sigma - \\log t_i) - \\exp(w_i) \\right\\}\n$$\n这个最终形式是数值稳定的。整个过程中使用对数避免了因乘以许多小概率（似然贡献 $L_i$）而可能导致的下溢。计算被简化为不易发生下溢的项的总和。唯一对数值敏感的操作是 $\\exp(w_i)$，如果 $w_i$ 是大的正数，它可能会上溢。然而，对于典型的数据和模型参数，$w_i$ 的值通常保持在标准浮点运算的合理范围内。\n\n计算程序如下：\n1.  对于整个数据集，为每个观测计算线性预测器：$\\eta = X\\beta$。\n2.  为所有观测计算标准化残差：$w = (\\log(t) - \\eta) / \\sigma$。注意这些是向量运算。\n3.  计算残差的指数：$\\exp(w)$。\n4.  每个观测 $i$ 的对数似然贡献是 $d_i (w_i - \\log \\sigma - \\log t_i) - \\exp(w_i)$。这可以使用向量化操作同时为所有观测计算。\n5.  将这些贡献相加以获得总对数似然：$\\log L = \\sum_i \\left[ d_i (w_i - \\log \\sigma - \\log t_i) - \\exp(w_i) \\right]$。\n\n将实现此程序来解决测试用例。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the total log-likelihood for the AFT Weibull model for several test cases.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"X\": np.array([[1.0], [0.5], [1.5], [0.0], [2.0]]),\n            \"beta\": np.array([0.2]),\n            \"sigma\": 0.8,\n            \"t\": np.array([5.0, 2.0, 8.0, 1.2, 10.0]),\n            \"d\": np.array([1, 1, 0, 1, 0]),\n        },\n        {\n            \"X\": np.array([[1.0], [1.0], [1.0], [1.0]]),\n            \"beta\": np.array([-0.1]),\n            \"sigma\": 1.0,\n            \"t\": np.array([0.5, 1.0, 3.0, 0.8]),\n            \"d\": np.array([0, 0, 0, 0]),\n        },\n        {\n            \"X\": np.array([\n                [1.0, 0.2],\n                [0.5, -0.3],\n                [1.5, 0.0],\n                [0.0, 1.0],\n                [2.0, -0.5],\n                [1.0, 0.5]\n            ]),\n            \"beta\": np.array([0.1, -0.2]),\n            \"sigma\": 0.3,\n            \"t\": np.array([4.0, 1.5, 6.0, 0.9, 3.2, 2.1]),\n            \"d\": np.array([1, 1, 1, 0, 1, 0]),\n        },\n        {\n            \"X\": np.array([\n                [1.0, -1.0],\n                [0.0, 2.0],\n                [3.0, 0.5]\n            ]),\n            \"beta\": np.array([0.3, 0.1]),\n            \"sigma\": 2.0,\n            \"t\": np.array([12.0, 18.0, 25.0]),\n            \"d\": np.array([1, 0, 1]),\n        }\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        X = case[\"X\"]\n        beta = case[\"beta\"]\n        sigma = case[\"sigma\"]\n        t = case[\"t\"]\n        d = case[\"d\"]\n\n        # Step 1: Calculate the linear predictor, eta = X @ beta\n        eta = X @ beta\n\n        # Step 2: Calculate the standardized residuals, w = (log(t) - eta) / sigma\n        log_t = np.log(t)\n        w = (log_t - eta) / sigma\n\n        # Step 3: Calculate the total log-likelihood using the derived stable formula:\n        # log L = sum( d_i * (w_i - log(sigma) - log(t_i)) - exp(w_i) ) for i=1 to n\n        log_sigma = np.log(sigma)\n        \n        # Calculate log-likelihood contributions for each observation\n        # This is a vectorized implementation of the formula.\n        log_likelihood_contributions = d * (w - log_sigma - log_t) - np.exp(w)\n        \n        # Step 4: Sum contributions to get total log-likelihood\n        total_log_likelihood = np.sum(log_likelihood_contributions)\n        \n        results.append(round(total_log_likelihood, 6))\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```", "id": "4978000"}]}