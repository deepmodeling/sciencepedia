{"hands_on_practices": [{"introduction": "要真正掌握对数秩检验（log-rank test），一个基础步骤是能够亲手进行计算。这项练习 ([@problem_id:4608348]) 将指导您从汇总数据中计算检验统计量的核心组成部分——得分（$U$）、其方差（$V$）以及标准化统计量（$Z$）。通过完成这个过程，您将具体理解在每个事件时间点上证据是如何被累积的。", "problem": "一项流行病学研究追踪了两个独立的队列，A组和B组，以使用生存分析比较事件发生时间结局。假设在任何一个不同的事件时间点，以该时间点之前的风险集构成为条件，在风险函数相等的零假设下，观测到的事件在各组间的分配遵循从合并的风险集中进行无放回抽样。这对应于Cox比例风险（CPH）模型中的计分检验，并得出经典的对数秩检验。\n\n存在三个不同的事件时间点，每个时间点各组的风险集大小和观测到的事件数如下：\n- 在时间 $t_1$：A组有 $10$ 人处于风险中，B组有 $10$ 人处于风险中；观测到的事件为A组 $1$ 例，B组 $0$ 例。\n- 在时间 $t_2$：A组有 $8$ 人处于风险中，B组有 $9$ 人处于风险中；观测到的事件为A组 $1$ 例，B组 $2$ 例。\n- 在时间 $t_3$：A组有 $6$ 人处于风险中，B组有 $7$ 人处于风险中；观测到的事件为A组 $0$ 例，B组 $3$ 例。\n\n在事件时间点之间，一些个体可能会被删失；给定的风险集大小已经考虑了之前的事件和删失。\n\n使用基于风险相等的零假设的对数秩框架，计算A组的对数秩得分 $U$、其方差 $V$ 以及标准化统计量 $Z = U / \\sqrt{V}$。从基本原理出发，论证在每个事件时间点使用的期望值和方差。将最终的标准化统计量 $Z$ 四舍五入到四位有效数字。不需要单位。简要解释 $Z$ 值，说明是否有证据表明两组之间的风险存在差异，但最终答案只提供 $Z$ 值。", "solution": "对数秩检验的基本依据是各组间风险函数相等的零假设。在此零假设下，在任何一个不同的事件时间点 $t_j$，以 $t_j$ 之前的合并风险集为条件，在 $t_j$ 观测到的 $d_j$ 个事件在两组间的分配，就如同从处于风险中的 $n_j$ 个个体中无放回地抽取一样。这意味着在时间点 $t_j$ A组的事件数（记为 $O_{A,j}$）服从超几何模型，其参数为：\n- 总体大小 $n_j = n_{A,j} + n_{B,j}$，\n- “成功”次数（A组风险人数）$n_{A,j}$，\n- 样本大小 $d_j$ （$t_j$ 时的事件数）。\n\n对于一个超几何随机变量，\n$$\n\\mathbb{E}[O_{A,j}] = d_j \\frac{n_{A,j}}{n_j},\n\\quad\n\\mathrm{Var}(O_{A,j}) = d_j \\frac{n_{A,j}}{n_j} \\left(1 - \\frac{n_{A,j}}{n_j}\\right) \\frac{n_j - d_j}{n_j - 1}.\n$$\n等价地，\n$$\n\\mathrm{Var}(O_{A,j}) = \\frac{d_j (n_j - d_j) n_{A,j} n_{B,j}}{n_j^2 (n_j - 1)}.\n$$\n\nA组的对数秩得分 $U$ 是所有事件时间点上观测事件数与期望事件数之差的总和：\n$$\nU = \\sum_{j=1}^{3} \\left(O_{A,j} - \\mathbb{E}[O_{A,j}]\\right),\n$$\n方差为\n$$\nV = \\sum_{j=1}^{3} \\mathrm{Var}(O_{A,j}).\n$$\n标准化统计量为 $Z = U / \\sqrt{V}$，根据大样本理论（应用于Cox比例风险（CPH）模型中计分检验的中心极限定理（CLT）），该统计量近似服从标准正态分布。\n\n我们现在计算每个时间点的这些量。\n\n时间 $t_1$：\n- 风险集：$n_{A,1} = 10$, $n_{B,1} = 10$, $n_1 = 20$。\n- 事件：$d_1 = 1$，其中 $O_{A,1} = 1$。\n- 期望值：\n$$\n\\mathbb{E}[O_{A,1}] = d_1 \\frac{n_{A,1}}{n_1} = 1 \\cdot \\frac{10}{20} = \\frac{1}{2}.\n$$\n- 方差：\n$$\n\\mathrm{Var}(O_{A,1}) = \\frac{d_1 (n_1 - d_1) n_{A,1} n_{B,1}}{n_1^2 (n_1 - 1)} = \\frac{1 \\cdot 19 \\cdot 10 \\cdot 10}{20^2 \\cdot 19} = \\frac{1}{4}.\n$$\n- 对 $U$ 的贡献：$O_{A,1} - \\mathbb{E}[O_{A,1}] = 1 - \\frac{1}{2} = \\frac{1}{2}$。\n\n时间 $t_2$：\n- 风险集：$n_{A,2} = 8$, $n_{B,2} = 9$, $n_2 = 17$。\n- 事件：$d_2 = 3$，其中 $O_{A,2} = 1$。\n- 期望值：\n$$\n\\mathbb{E}[O_{A,2}] = d_2 \\frac{n_{A,2}}{n_2} = 3 \\cdot \\frac{8}{17} = \\frac{24}{17}.\n$$\n- 方差：\n$$\n\\mathrm{Var}(O_{A,2}) = \\frac{d_2 (n_2 - d_2) n_{A,2} n_{B,2}}{n_2^2 (n_2 - 1)} = \\frac{3 \\cdot 14 \\cdot 8 \\cdot 9}{17^2 \\cdot 16} = \\frac{3024}{4624} = \\frac{189}{289}.\n$$\n- 对 $U$ 的贡献：$O_{A,2} - \\mathbb{E}[O_{A,2}] = 1 - \\frac{24}{17} = -\\frac{7}{17}$。\n\n时间 $t_3$：\n- 风险集：$n_{A,3} = 6$, $n_{B,3} = 7$, $n_3 = 13$。\n- 事件：$d_3 = 3$，其中 $O_{A,3} = 0$。\n- 期望值：\n$$\n\\mathbb{E}[O_{A,3}] = d_3 \\frac{n_{A,3}}{n_3} = 3 \\cdot \\frac{6}{13} = \\frac{18}{13}.\n$$\n- 方差：\n$$\n\\mathrm{Var}(O_{A,3}) = \\frac{d_3 (n_3 - d_3) n_{A,3} n_{B,3}}{n_3^2 (n_3 - 1)} = \\frac{3 \\cdot 10 \\cdot 6 \\cdot 7}{13^2 \\cdot 12} = \\frac{1260}{2028} = \\frac{105}{169}.\n$$\n- 对 $U$ 的贡献：$O_{A,3} - \\mathbb{E}[O_{A,3}] = 0 - \\frac{18}{13} = -\\frac{18}{13}$。\n\n对所有时间点求和，\n$$\nU = \\left( \\frac{1}{2} \\right) + \\left( -\\frac{7}{17} \\right) + \\left( -\\frac{18}{13} \\right)\n= \\frac{1}{2} - \\frac{7}{17} - \\frac{18}{13}\n= \\frac{221 - 182 - 612}{442}\n= -\\frac{573}{442}.\n$$\n数值上，$U \\approx -1.2963800905$。\n\n同样地，\n$$\nV = \\left( \\frac{1}{4} \\right) + \\left( \\frac{189}{289} \\right) + \\left( \\frac{105}{169} \\right).\n$$\n数值上，\n$$\n\\frac{1}{4} = 0.25,\\quad \\frac{189}{289} \\approx 0.6539792388,\\quad \\frac{105}{169} \\approx 0.6213017751,\n$$\n所以\n$$\nV \\approx 0.25 + 0.6539792388 + 0.6213017751 = 1.5252810139.\n$$\n因此，\n$$\nZ = \\frac{U}{\\sqrt{V}} \\approx \\frac{-1.2963800905}{\\sqrt{1.5252810139}} \\approx \\frac{-1.2963800905}{1.235022672} \\approx -1.049681.\n$$\n四舍五入到四位有效数字，$Z \\approx -1.050$。\n\n解释：标准化的对数秩统计量在量级上接近于零（约为-1.05），在标准正态近似下，这对应于接近0.29的双侧尾部概率。基于这个小数据集，没有强有力的证据反对A组和B组之间风险相等的零假设。\n\n最终答案只需提供按要求四舍五入的Z值。", "answer": "$$\\boxed{-1.050}$$", "id": "4608348"}, {"introduction": "虽然手动计算有助于阐明理论，但实际的生存分析需要我们通过计算来处理原始数据。这项练习 ([@problem_id:4990751]) 要求您开发一个算法，该算法接收原始生存数据（时间、事件指示符和分组标签）并计算必要的“观测减去期望”（$O-E$）计数。这在理论公式和其实际应用之间架起了一座至关重要的桥梁，为您处理真实世界的数据集做好准备。", "problem": "考虑一个由索引为 $i$ 的独立受试者组成的临床生存数据集，每个受试者具有观测随访时间 $T_i \\ge 0$、事件指示符 $\\delta_i \\in \\{0,1\\}$（其中 $\\delta_i = 1$ 表示事件发生，$\\delta_i = 0$ 表示右删失）以及一个用于 $G$ 个不相交组的分类组标签 $g_i \\in \\{0,1,\\dots,G-1\\}$。定义不同事件时间的有序集合 $\\{t_j\\}_{j=1}^J$，其中对于每个 $j$，至少存在一个受试者满足 $\\delta_i = 1$ 且 $T_i = t_j$。对于每个 $t_j$，定义风险集大小 $n_j$ 为满足 $T_i \\ge t_j$ 的受试者数量，事件数 $d_j$ 为满足 $\\delta_i = 1$ 且 $T_i = t_j$ 的受试者数量。对于每个组 $g \\in \\{0,1,\\dots,G-1\\}$，定义特定组的风险集大小 $n_{gj}$ 为满足 $g_i = g$ 且 $T_i \\ge t_j$ 的受试者数量，特定组的事件数 $d_{gj}$ 为满足 $g_i = g$、$\\delta_i = 1$ 且 $T_i = t_j$ 的受试者数量。在各组风险函数相等的零假设下，于每个事件时间 $t_j$ 时，组 $g$ 的预期事件数由 $E_{gj} = d_j \\cdot \\frac{n_{gj}}{n_j}$ 给出。对数秩检验为每个组 $g$ 构建累积差异 $O_g - E_g = \\sum_{j=1}^J \\left(d_{gj} - E_{gj}\\right)$。\n\n您的任务是实现一个算法，该算法在给定组标签、事件指示符和时间数组的情况下，计算在每个 $t_j$ 时的 $n_j$、$d_j$、$n_{gj}$、$d_{gj}$，并返回在所有 $j \\in \\{1,\\dots,J\\}$ 上每个组 $g$ 的累积 $O_g - E_g$。算法必须按如下方式处理时间平局（ties）：如果在同一时间 $t_j$ 发生多个事件，则 $d_j$ 等于在 $t_j$ 发生的事件数；如果在时间 $t_j$ 发生删失，删失的受试者因满足 $T_i \\ge t_j$ 而被包含在 $t_j$ 的风险集中，但他们对 $d_j$ 没有贡献。在计算 $n_j$ 和 $n_{gj}$ 时，于 $t_j$ 发生事件或被删失的受试者均被包含在 $t_j$ 的风险集中。\n\n使用以下测试套件，其中时间单位为月（提供单位是为了提供上下文，但您的输出是无量纲的计数或差异，因此不需要指定单位）：\n\n- 测试用例 1（两组，混合事件和删失，存在时间平局以及在同一事件时间发生删失）：\n  - 时间 $\\mathbf{t} = (5,8,12,12,15,17,20,22,22,25)$\n  - 事件 $\\boldsymbol{\\delta} = (1,0,1,1,0,1,0,1,0,1)$\n  - 组别 $\\mathbf{g} = (0,0,1,1,0,1,0,1,0,0)$\n\n- 测试用例 2（边界情况：无事件，全部删失）：\n  - 时间 $\\mathbf{t} = (3,7,10,12)$\n  - 事件 $\\boldsymbol{\\delta} = (0,0,0,0)$\n  - 组别 $\\mathbf{g} = (0,1,0,1)$\n\n- 测试用例 3（一组没有事件，但处于风险中）：\n  - 时间 $\\mathbf{t} = (4,7,9,12,15,18)$\n  - 事件 $\\boldsymbol{\\delta} = (1,1,1,0,0,0)$\n  - 组别 $\\mathbf{g} = (0,0,0,1,1,1)$\n\n- 测试用例 4（三组，存在多个时间平局和混合删失）：\n  - 时间 $\\mathbf{t} = (2,2,5,5,5,8,10,10,10,12)$\n  - 事件 $\\boldsymbol{\\delta} = (1,0,1,1,0,0,1,0,1,0)$\n  - 组别 $\\mathbf{g} = (0,1,0,1,2,2,0,1,2,2)$\n\n您的程序必须为每个测试用例计算所有组 $g$ 的累积差异向量 $\\left(O_g - E_g\\right)$，并按组标签升序排列。最终输出必须将所有测试用例的结果聚合到单行中，形式为用方括号括起来的逗号分隔列表，其中每个条目是一个测试用例的结果向量。例如，输出格式应为 $[ \\text{result}_1, \\text{result}_2, \\text{result}_3, \\text{result}_4 ]$，其中每个 $\\text{result}_k$ 本身表示为标准编程表示法中的列表。输出必须是实数（浮点数），不应打印任何其他单位或符号。", "solution": "在尝试解决方案之前，对问题进行验证。\n\n### 步骤 1：提取已知条件\n\n问题提供了以下定义和数据：\n- 由索引为 $i$ 的独立受试者组成的数据集。\n- 观测随访时间 $T_i \\ge 0$。\n- 事件指示符 $\\delta_i \\in \\{0,1\\}$，其中 $\\delta_i = 1$ 表示事件，$\\delta_i = 0$ 表示右删失。\n- 用于 $G$ 个不相交组的分类组标签 $g_i \\in \\{0,1,\\dots,G-1\\}$。\n- 不同事件时间的有序集合 $\\{t_j\\}_{j=1}^J$，其中对于每个 $j$，至少有一个受试者满足 $\\delta_i = 1$ 且 $T_i = t_j$。\n- 在 $t_j$ 时的风险集大小：$n_j = \\text{满足 } T_i \\ge t_j \\text{ 的受试者数量}$。\n- 在 $t_j$ 时的事件数：$d_j = \\text{满足 } \\delta_i = 1 \\text{ 且 } T_i = t_j \\text{ 的受试者数量}$。\n- 在时间 $t_j$ 时组 $g$ 的特定组风险集大小：$n_{gj} = \\text{满足 } g_i = g \\text{ 且 } T_i \\ge t_j \\text{ 的受试者数量}$。\n- 在时间 $t_j$ 时组 $g$ 的特定组事件数：$d_{gj} = \\text{满足 } g_i = g, \\delta_i = 1, \\text{ 且 } T_i = t_j \\text{ 的受试者数量}$。\n- 在风险函数相等的零假设下，在时间 $t_j$ 时组 $g$ 的预期事件数为 $E_{gj} = d_j \\cdot \\frac{n_{gj}}{n_j}$。\n- 要计算的量是每个组 $g$ 的累积差异：$O_g - E_g = \\sum_{j=1}^J \\left(d_{gj} - E_{gj}\\right)$。\n- 时间平局处理规则：“在计算 $n_j$ 和 $n_{gj}$ 时，在 $t_j$ 发生事件或被删失的受试者均包含在 $t_j$ 的风险集中。”\n- 测试用例 1：时间 $\\mathbf{t} = (5,8,12,12,15,17,20,22,22,25)$，事件 $\\boldsymbol{\\delta} = (1,0,1,1,0,1,0,1,0,1)$，组别 $\\mathbf{g} = (0,0,1,1,0,1,0,1,0,0)$。\n- 测试用例 2：时间 $\\mathbf{t} = (3,7,10,12)$，事件 $\\boldsymbol{\\delta} = (0,0,0,0)$，组别 $\\mathbf{g} = (0,1,0,1)$。\n- 测试用例 3：时间 $\\mathbf{t} = (4,7,9,12,15,18)$，事件 $\\boldsymbol{\\delta} = (1,1,1,0,0,0)$，组别 $\\mathbf{g} = (0,0,0,1,1,1)$。\n- 测试用例 4：时间 $\\mathbf{t} = (2,2,5,5,5,8,10,10,10,12)$，事件 $\\boldsymbol{\\delta} = (1,0,1,1,0,0,1,0,1,0)$，组别 $\\mathbf{g} = (0,1,0,1,2,2,0,1,2,2)$。\n\n### 步骤 2：使用提取的已知条件进行验证\n\n根据验证标准分析问题陈述。\n- **科学依据：** 问题描述了对数秩检验统计量核心成分的计算，这是生存分析中用于比较风险函数的一种基础且广泛使用的非参数方法。风险集、观测事件和零假设下的预期事件的定义是标准且正确的。公式 $E_{gj} = d_j \\cdot \\frac{n_{gj}}{n_j}$ 源于一个假设，即在时间 $t_j$，从 $n_j$ 个风险个体中无放回地抽样出 $d_j$ 个事件，这遵循一个多元超几何分布。\n- **适定性：** 问题是适定的。它提供了所有必要的输入（时间、事件状态、分组）并清晰地定义了要计算的量和最终输出格式。该任务是确定性的，并且每个测试用例都有唯一的解。\n- **客观性：** 语言技术性强且精确，使用了统计学和生存分析的标准术语。它不包含主观看法。\n- **不完整或矛盾的设置：** 问题是自洽的。提供的数据和定义足以完成一个完整的实现。处理时间平局和事件时间删失的规则是明确的，并与标准实践一致。\n- **不切实际或不可行：** 数据在临床数据的现实范围内，为进行计算练习而缩小了规模。\n- **病态或结构不良：** 结构是合乎逻辑的，从生存数据的基本定义构建到最终的聚合统计量。\n- **伪深刻、琐碎或同义反复：** 问题并非无足轻重。它需要仔细实现一个多步算法，并注意细节，例如识别独特的事件时间以及正确处理索引和分组，尤其是在事件时间存在平局的情况下。\n- **超出科学可验证性：** 结果可以通过手动计算或与已建立的统计软件中对数秩检验的实现进行比较来验证。\n\n### 步骤 3：结论和行动\n\n问题陈述是有效的。这是一个在计算统计学领域具有科学合理性、适定性且客观的问题。将提供一个解决方案。\n\n### 解决方案\n\n任务是计算生存数据集中每个组 $g$ 的观测事件数减去预期事件数的累积值，$O_g - E_g$，这是对数秩检验的核心组成部分。对数秩检验是一种假设检验，用于比较两个或多个组的生存分布。它在零假设 $H_0$ 下运行，即各组之间的风险函数（以及因此的生存函数）没有差异。\n\n基本原理是在每个发生事件的不同时间点进行比较。在每个这样的时间 $t_j$，我们按组分层，制表列出处于事件风险中的受试者数量和实际经历事件的受试者数量。在 $H_0$ 下，在 $t_j$ 发生的事件应按各组在当时风险集中的各自大小成比例地分布。该检验统计量聚合了所有事件时间中与此预期的偏差。\n\n算法按以下步骤进行：\n\n1.  **识别不同事件时间**：首先，我们必须识别出至少发生一个事件（$\\delta_i=1$）的唯一时间点 $\\{t_j\\}_{j=1}^J$。与事件时间不重合的删失时间不用于构成集合 $\\{t_j\\}$。该集合按升序排序。如果数据集中没有事件发生，则此集合为空，计算终止，所有 $O_g - E_g$ 值均为 $0$。\n\n2.  **初始化累加器**：我们为每个组 $g \\in \\{0, 1, \\dots, G-1\\}$ 初始化一个用于 $O_g - E_g$ 值的累加器向量，并将其值设为零。设此向量为 $\\mathbf{S}$。\n\n3.  **遍历事件时间**：对于步骤 1 中排序集合中的每个不同事件时间 $t_j$：\n    a.  **确定风险集**：时间 $t_j$ 的风险集包括所有在 $t_j$ 之前尚未经历事件或被删失的受试者 $i$。这相当于找到所有观测时间 $T_i \\ge t_j$ 的受试者。此集合中的个体总数为 $n_j$。\n    b.  **计数事件**：计算在时间 $t_j$ 发生事件的总数。这是满足 $T_i=t_j$ 和 $\\delta_i=1$ 的受试者 $i$ 的数量。此计数表示为 $d_j$。\n    c.  **按组分层**：对于每个组 $g$：\n        i.  统计风险集中来自组 $g$ 的受试者数量。这是 $n_{gj}$，即满足 $g_i=g$ 和 $T_i \\ge t_j$ 的受试者计数。\n        ii. 统计在时间 $t_j$ 经历事件的来自组 $g$ 的受试者数量。这是观测计数 $d_{gj}$，即满足 $g_i=g$、$T_i=t_j$ 和 $\\delta_i=1$ 的受试者数量。\n    d.  **计算预期事件**：对于每个组 $g$，使用公式 $E_{gj} = d_j \\cdot \\frac{n_{gj}}{n_j}$ 计算零假设下的预期事件数。该公式假设从 $n_j$ 个风险受试者中无放回地抽取 $d_j$ 个事件，并且任何给定受试者经历事件的概率与组别无关。\n    e.  **更新累加器**：对于每个组 $g$，计算差异 $d_{gj} - E_{gj}$ 并将其加到向量 $\\mathbf{S}$ 中相应的累加器中。即 $S_g \\leftarrow S_g + (d_{gj} - E_{gj})$。\n\n4.  **最终结果**：遍历所有唯一的事件时间后，向量 $\\mathbf{S}$ 包含每个组 $g$ 的最终累积值 $\\left(O_g - E_g\\right)$。此计算的一个属性是各分量之和必须为零，即 $\\sum_{g=0}^{G-1} (O_g - E_g) = 0$，因为在每个时间 $t_j$，$\\sum_g d_{gj} = d_j$ 且 $\\sum_g E_{gj} = \\sum_g d_j \\frac{n_{gj}}{n_j} = \\frac{d_j}{n_j} \\sum_g n_{gj} = \\frac{d_j}{n_j} n_j = d_j$。这可作为一个有用的一致性检查。\n\n此过程按照问题陈述的规定，正确处理了事件时间中的时间平局（通过在 $d_j$ 中计算在 $t_j$ 的所有事件）和事件时间点的删失（通过将此类受试者包含在风险集 $n_j$ 中，但不包含在事件计数 $d_j$ 中）。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the log-rank O-E calculation for all test cases.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test case 1 (two groups, mixed events and censoring with ties)\n        (\n            np.array([5, 8, 12, 12, 15, 17, 20, 22, 22, 25]),\n            np.array([1, 0, 1, 1, 0, 1, 0, 1, 0, 1]),\n            np.array([0, 0, 1, 1, 0, 1, 0, 1, 0, 0])\n        ),\n        # Test case 2 (boundary case: no events, all censored)\n        (\n            np.array([3, 7, 10, 12]),\n            np.array([0, 0, 0, 0]),\n            np.array([0, 1, 0, 1])\n        ),\n        # Test case 3 (one group has no events but is at risk)\n        (\n            np.array([4, 7, 9, 12, 15, 18]),\n            np.array([1, 1, 1, 0, 0, 0]),\n            np.array([0, 0, 0, 1, 1, 1])\n        ),\n        # Test case 4 (three groups with multiple ties and mixed censoring)\n        (\n            np.array([2, 2, 5, 5, 5, 8, 10, 10, 10, 12]),\n            np.array([1, 0, 1, 1, 0, 0, 1, 0, 1, 0]),\n            np.array([0, 1, 0, 1, 2, 2, 0, 1, 2, 2])\n        )\n    ]\n\n    results = []\n    for t_i, delta_i, g_i in test_cases:\n        result = _calculate_log_rank_o_minus_e(t_i, delta_i, g_i)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    # Convert each inner list to string for the final join.\n    print(f\"[{','.join(map(str, results))}]\")\n\n\ndef _calculate_log_rank_o_minus_e(times, events, groups):\n    \"\"\"\n    Computes the aggregated observed minus expected (O - E) counts for each group.\n\n    Args:\n        times (np.ndarray): Array of observed follow-up times.\n        events (np.ndarray): Array of event indicators (1=event, 0=censored).\n        groups (np.ndarray): Array of group labels.\n\n    Returns:\n        list: A list of floats representing the O-E value for each group,\n              ordered by group index.\n    \"\"\"\n    \n    if len(groups) == 0:\n        return []\n\n    # Determine the number of groups, G. Assumes group labels are 0-indexed.\n    num_groups = np.max(groups) + 1 if groups.size > 0 else 0\n    \n    # Initialize the vector of aggregated differences (O_g - E_g) for each group.\n    o_minus_e = np.zeros(num_groups)\n\n    # Identify the unique time points where at least one event occurred.\n    event_mask = (events == 1)\n    if not np.any(event_mask):\n      # If no events, O-E is 0 for all groups.\n      return o_minus_e.tolist()\n      \n    unique_event_times = np.unique(times[event_mask])\n\n    # Iterate through each unique event time t_j.\n    for t_j in unique_event_times:\n        # Identify subjects at risk at time t_j.\n        # A subject is at risk if their observation time is >= t_j.\n        at_risk_mask = (times >= t_j)\n        \n        # Calculate n_j: total number of subjects at risk at t_j.\n        n_j = np.sum(at_risk_mask)\n\n        # Identify events that occurred exactly at time t_j.\n        events_at_t_j_mask = (times == t_j)  event_mask\n        \n        # Calculate d_j: total number of events at t_j.\n        d_j = np.sum(events_at_t_j_mask)\n\n        if n_j == 0:\n            continue # Should not happen if d_j > 0\n\n        # For each group, calculate d_gj, n_gj and update O-E.\n        for g in range(num_groups):\n            # Mask for subjects in the current group g.\n            in_group_g_mask = (groups == g)\n            \n            # Calculate n_gj: number of subjects in group g at risk at t_j.\n            n_gj = np.sum(at_risk_mask  in_group_g_mask)\n            \n            # Calculate d_gj: number of events in group g at t_j.\n            d_gj = np.sum(events_at_t_j_mask  in_group_g_mask)\n\n            # Calculate E_gj: expected number of events in group g at t_j.\n            e_gj = d_j * (n_gj / n_j) if n_j > 0 else 0.0\n\n            # Accumulate the difference (d_gj - E_gj) for group g.\n            o_minus_e[g] += (d_gj - e_gj)\n            \n    return o_minus_e.tolist()\n\nsolve()\n```", "id": "4990751"}, {"introduction": "一位出色的统计学家不仅知道如何执行检验，还了解其局限性。这最后一个练习 ([@problem_id:4990713]) 探讨了一个关键场景——风险交叉（crossing hazards），此时对数秩检验的比例风险（proportional hazards）假设被违反。通过分析检验统计量在这种情况下如何表现，您将了解到为什么标准的对数秩检验会失去统计功效，并体会到在得出结论前仔细检查生存曲线的重要性。", "problem": "一项双臂随机临床试验比较了一种新疗法（第 $1$ 组）与标准治疗（第 $2$ 组）。设 $S_1(t)$ 和 $S_2(t)$ 表示生存函数，并假设风险函数 $h_1(t)$ 和 $h_2(t)$ 在时间 $t^\\star$ 恰好相交一次，其中当 $t  t^\\star$ 时 $h_1(t)  h_2(t)$，当 $t > t^\\star$ 时 $h_1(t) > h_2(t)$。考虑对数秩检验，该检验在风险相等的原假设下，比较在不同事件时间点上第 $1$ 组的观测事件数和期望事件数。在每个不同的事件时间点 $t_j$，设 $O_1(t_j)$ 为第 $1$ 组中观测到的事件数， $E_1(t_j)$ 为在原假设下，基于 $t_j$ 时的风险集计算出的第 $1$ 组的期望事件数。对数秩检验的分子是所有不同事件时间点上 $\\sum_j \\{O_1(t_j) - E_1(t_j)\\}$ 的未加权和。\n\n为了具体说明交叉点附近的定性行为，假设由于离散化的评估时间表，存在两组结时间事件：\n- 在时间 $t_E  t^\\star$ 的一个早期结事件集，风险集中第 $1$ 组有 $n_{1E}$ 人，第 $2$ 组有 $n_{2E}$ 人，总事件数为 $d_E$，其中第 $1$ 组的观测事件数为 $d_{1E}$。\n- 在时间 $t_L > t^\\star$ 的一个晚期结事件集，风险集中第 $1$ 组有 $n_{1L}$ 人，第 $2$ 组有 $n_{2L}$ 人，总事件数为 $d_L$，其中第 $1$ 组的观测事件数为 $d_{1L}$。\n\n假设在这些结事件集开始时有以下合理数值：$n_{1E} = 95$, $n_{2E} = 95$, $d_E = 20$, $d_{1E} = 7$；以及 $n_{1L} = 70$, $n_{2L} = 60$, $d_L = 25$, $d_{1L} = 16$。在这些结事件集之外没有发生其他事件。在风险相等的原假设下，一个结事件集内的事件在风险集中的个体之间是可交换的。\n\n在这种风险交叉情景下，哪个陈述最能描述 $O_1(t_j) - E_1(t_j)$ 随时间变化的符号模式，以及其对未加权的对数秩检验分子 $\\sum_j \\{O_1(t_j) - E_1(t_j)\\}$ 的影响？\n\nA. 因为当 $t  t^\\star$ 时 $h_1(t)  h_2(t)$，当 $t > t^\\star$ 时 $h_1(t) > h_2(t)$，早期的贡献项 $O_1(t_j) - E_1(t_j)$ 倾向于为负，而晚期的贡献项倾向于为正，导致在未加权和中发生抵消，从而减小了总检验统计量的量值。\n\nB. 因为当 $t  t^\\star$ 时 $h_1(t)  h_2(t)$，当 $t > t^\\star$ 时 $h_1(t) > h_2(t)$，早期的贡献项 $O_1(t_j) - E_1(t_j)$ 倾向于为正，而晚期的贡献项倾向于为负，导致在未加权和中发生增强，从而增大了总检验统计量的量值。\n\nC. 风险集大小随时间的变化意味着晚期的贡献项必然占主导地位，因此当风险交叉一次时，早期和晚期的贡献项之间不会发生抵消。\n\nD. 对数秩检验会自动对时间段进行重新加权以中和单次交叉的影响，因此未加权和不受随时间变化的符号变化的影响，且检验保持完全的敏感性。", "solution": "用户希望我解决一个关于在风险交叉情况下对数秩检验的问题。\n\n**1. 问题验证**\n\n**1.1. 提取已知条件**\n- **分组：** 一项双臂试验，第 $1$ 组（新疗法）和第 $2$ 组（标准治疗）。\n- **生存函数和风险函数：** 生存函数为 $S_1(t)$ 和 $S_2(t)$；风险函数为 $h_1(t)$ 和 $h_2(t)$。\n- **风险交叉条件：** 风险函数在时间 $t^\\star$ 恰好相交一次。\n- **风险关系：** 当 $t  t^\\star$ 时 $h_1(t)  h_2(t)$，当 $t > t^\\star$ 时 $h_1(t) > h_2(t)$。\n- **对数秩检验：** 检验统计量的分子是未加权和 $\\sum_j \\{O_1(t_j) - E_1(t_j)\\}$，其中 $O_1(t_j)$ 是在不同事件时间点 $t_j$ 第 $1$ 组的观测事件数，$E_1(t_j)$ 是第 $1$ 组的期望事件数。$E_1(t_j)$ 是在风险相等的原假设下，以 $t_j$ 时的风险集为条件计算的。\n- **早期事件集 ($t_E  t^\\star$)：**\n  - 总事件数 $d_E = 20$。\n  - 第 $1$ 组的风险集大小：$n_{1E} = 95$。\n  - 第 $2$ 组的风险集大小：$n_{2E} = 95$。\n  - 第 $1$ 组的观测事件数：$d_{1E} = 7$。\n- **晚期事件集 ($t_L > t^\\star$)：**\n  - 总事件数 $d_L = 25$。\n  - 第 $1$ 组的风险集大小：$n_{1L} = 70$。\n  - 第 $2$ 组的风险集大小：$n_{2L} = 60$。\n  - 第 $1$ 组的观测事件数：$d_{1L} = 16$。\n- **假设：** 没有其他事件发生。在原假设下，结事件集内的事件是可交换的。\n\n**1.2. 使用提取的已知条件进行验证**\n问题陈述描述了生存分析中的一个经典情景，即对数秩检验最优性所依赖的比例风险假设被违反了。\n- **科学依据：** 生存函数、风险函数、风险交叉和对数秩检验等概念是生物统计学和临床试验方法学中的基础且公认的概念。该情景在科学上是合理的，并且在文献中经常被讨论。\n- **适定性：** 问题陈述清晰。它提供了风险交叉的定性描述和一个具体的数值例子来说明其后果。问题要求描述对数秩统计量的行为特征，这可以直接从提供的信息中推导出来。存在一个唯一的、有意义的解。\n- **客观性：** 语言正式、精确，没有主观论断。在一个说明性例子中，使用“合理数值”是对数值数据的恰当限定。\n\n该问题没有违反任何无效性标准。它在科学上是合理的、可形式化的、完整的和适定的。\n\n**1.3. 结论和行动**\n问题是**有效的**。将继续进行求解。\n\n**2. 解题推导**\n\n问题的核心在于理解在指定的风险交叉情景下，不同时间点对对数秩检验统计量的贡献项 $O_1(t_j) - E_1(t_j)$。对数秩检验评估的是原假设 $H_0: h_1(t) = h_2(t)$（对于所有 $t$）。\n\n在此原假设下，在时间 $t_j$ 发生事件的风险对于风险集中的所有个体都是相同的，无论他们属于哪个组。第 $1$ 组的期望事件数 $E_1(t_j)$ 就是基于此原理计算的。它是在 $t_j$ 时的总事件数 $d_j$ 乘以属于第 $1$ 组的个体在总风险集中的比例。\n公式为：\n$$ E_1(t_j) = d_j \\frac{n_{1j}}{n_{1j} + n_{2j}} $$\n其中 $n_{1j}$ 和 $n_{2j}$ 是在时间 $t_j$ 之前，第 $1$ 组和第 $2$ 组中处于风险状态的受试者人数。\n\n在 $t_j$ 时第 $1$ 组的观测事件数记为 $O_1(t_j)$。我们分析在两个指定的事件时间点 $t_E$ 和 $t_L$ 时，差值 $O_1(t_j) - E_1(t_j)$ 的符号。\n\n**在早期时间点 ($t_E  t^\\star$) 的分析：**\n此时，问题陈述 $h_1(t)  h_2(t)$。这意味着第 $1$ 组中的个体发生事件的瞬时风险低于第 $2$ 组中的个体。因此，我们预计在第 $1$ 组中观测到的事件数会*少于*在风险相等（原假设）的情况下所期望的事件数。因此，我们预期 $O_1(t_E)  E_1(t_E)$，这意味着贡献项 $O_1(t_E) - E_1(t_E)$ 应该是负的。\n\n让我们用提供的数值来验证这一点：\n- 第 $1$ 组的观测事件数：$O_1(t_E) = d_{1E} = 7$。\n- 风险集大小：$n_{1E} = 95$，$n_{2E} = 95$。总风险集大小 $N_E = n_{1E} + n_{2E} = 95 + 95 = 190$。\n- 总事件数：$d_E = 20$。\n- 第 $1$ 组的期望事件数：\n$$ E_1(t_E) = d_E \\frac{n_{1E}}{N_E} = 20 \\times \\frac{95}{190} = 20 \\times 0.5 = 10 $$\n- 在 $t_E$ 时对对数秩检验分子的贡献是：\n$$ O_1(t_E) - E_1(t_E) = 7 - 10 = -3 $$\n正如从 $h_1(t)  h_2(t)$ 原理所预测的，这个贡献项是负的。\n\n**在晚期时间点 ($t_L > t^\\star$) 的分析：**\n此时，问题陈述 $h_1(t) > h_2(t)$。这意味着第 $1$ 组中的个体现在发生事件的瞬时风险*高于*第 $2$ 组中的个体。因此，我们预计在第 $1$ 组中观测到的事件数会*多于*在原假设下所期望的事件数。因此，我们预期 $O_1(t_L) > E_1(t_L)$，这意味着贡献项 $O_1(t_L) - E_1(t_L)$ 应该是正的。\n\n让我们用提供的数值来验证这一点：\n- 第 $1$ 组的观测事件数：$O_1(t_L) = d_{1L} = 16$。\n- 风险集大小：$n_{1L} = 70$，$n_{2L} = 60$。总风险集大小 $N_L = n_{1L} + n_{2L} = 70 + 60 = 130$。\n- 总事件数：$d_L = 25$。\n- 第 $1$ 组的期望事件数：\n$$ E_1(t_L) = d_L \\frac{n_{1L}}{N_L} = 25 \\times \\frac{70}{130} = 25 \\times \\frac{7}{13} = \\frac{175}{13} \\approx 13.46 $$\n- 在 $t_L$ 时对对数秩检验分子的贡献是：\n$$ O_1(t_L) - E_1(t_L) = 16 - \\frac{175}{13} = \\frac{208 - 175}{13} = \\frac{33}{13} \\approx 2.54 $$\n正如从 $h_1(t) > h_2(t)$ 原理所预测的，这个贡献项是正的。\n\n**对对数秩检验分子的总体影响：**\n对数秩检验的总分子是这些贡献项的和。由于没有其他事件发生，和为：\n$$ \\sum_j \\{O_1(t_j) - E_1(t_j)\\} = (O_1(t_E) - E_1(t_E)) + (O_1(t_L) - E_1(t_L)) = -3 + \\frac{33}{13} \\approx -0.46 $$\n早期的负贡献项和晚期的正贡献项部分相互抵消。这导致总和接近于零。对数秩检验统计量与该和的平方成正比，即 $(\\sum(O-E))^2 / \\sum \\text{Var}(O-E)$。一个小的分子会导致一个小的检验统计量和一个大的p值，从而在风险交叉时降低了检验检测生存分布之间真实差异的功效。\n\n**3. 逐项分析**\n\n**A. 因为当 $t  t^\\star$ 时 $h_1(t)  h_2(t)$，当 $t > t^\\star$ 时 $h_1(t) > h_2(t)$，早期的贡献项 $O_1(t_j) - E_1(t_j)$ 倾向于为负，而晚期的贡献项倾向于为正，导致在未加权和中发生抵消，从而减小了总检验统计量的量值。**\n这个陈述准确地描述了理论行为，并被我们的计算所证实。早期（$h_1  h_2$）显示出第 $1$ 组的优势，导致观测事件数少于期望值（$O_1-E_1  0$）。晚期（$h_1 > h_2$）显示出第 $1$ 组的劣势，导致观测事件数多于期望值（$O_1-E_1 > 0$）。将符号相反的项相加会导致抵消，这会减小检验统计量分子的量值，从而降低检验的功效。\n**结论：正确。**\n\n**B. 因为当 $t  t^\\star$ 时 $h_1(t)  h_2(t)$，当 $t > t^\\star$ 时 $h_1(t) > h_2(t)$，早期的贡献项 $O_1(t_j) - E_1(t_j)$ 倾向于为正，而晚期的贡献项倾向于为负，导致在未加权和中发生增强，从而增大了总检验统计量的量值。**\n这个陈述将贡献项的符号弄反了。如我们推导的，早期贡献项为负，晚期贡献项为正。此外，它错误地声称是增强效应；符号相反的贡献项会抵消，而不是增强。只有当所有贡献项都具有相同符号时（如在比例风险情况下），才会发生增强。\n**结论：错误。**\n\n**C. 风险集大小随时间的变化意味着晚期的贡献项必然占主导地位，因此当风险交叉一次时，早期和晚期的贡献项之间不会发生抵消。**\n这个陈述有两个错误的论断。首先，它声称晚期的贡献项“必然占主导地位”。我们的计算显示，在这个具体例子中情况恰恰相反：早期贡献项的量值 ($|-3| = 3$) 大于晚期贡献项的量值 ($|33/13| \\approx 2.54$)。并没有普遍的原则规定晚期贡献项占主导地位；它们的量值取决于当时的风险比、事件数量和风险集大小。其次，它声称抵消“不会发生”。抵消是将符号相反的项相加的必然结果，而这正是风险交叉时所发生的情况。\n**结论：错误。**\n\n**D. 对数秩检验会自动对时间段进行重新加权以中和单次交叉的影响，因此未加权和不受随时间变化的符号变化的影响，且检验保持完全的敏感性。**\n标准的对数秩检验正是一个*未加权*的检验，这就是为什么它在风险交叉情况下表现不佳。问题明确提到了“未加权和”。存在其他*加权*的对数秩类型检验（例如，来自 Fleming-Harrington 族的 $G^{\\rho,\\gamma}$ 检验），它们可以更侧重于早期或晚期的差异，以在这种非比例风险情景中提高检验功效。该陈述错误地将这种重新加权的属性归于标准的、未加权的对数秩检验。它的敏感性是降低了，而不是保持不变。\n**结论：错误。**", "answer": "$$\\boxed{A}$$", "id": "4990713"}]}