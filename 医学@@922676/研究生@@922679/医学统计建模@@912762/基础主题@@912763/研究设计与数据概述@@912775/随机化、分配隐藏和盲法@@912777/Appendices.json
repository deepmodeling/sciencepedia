{"hands_on_practices": [{"introduction": "随机化是临床试验的基石，但试验的实际执行往往并非理想化。即使随机分配和分配隐藏都完美无瑕，治疗组和对照组之间的“交叉污染”等问题也可能发生，从而影响意向性治疗（ITT）分析的结果。本练习将通过一个实际场景，指导您量化这种交叉污染如何导致治疗效果的衰减偏倚，从而帮助您理解理想设计与实际执行之间的差距 [@problem_id:4982143]。", "problem": "考虑一项在一个大型城市卫生系统中进行的减钠行为干预项目，该项目完全通过线下小组课程进行，并采用随机对照试验（RCT）进行评估。通过个体随机化的方式，将高血压患者分配到干预组或常规护理组。随机化过程中的分配隐藏通过中心化的计算机生成分配得以保证，但由于参与者知晓自己接受的内容，因此无法实现盲法。由于日程安排的限制，一些常规护理组的患者被无意中安排到混合班级中，其中包含了干预内容，这导致他们接触到有效课程而产生污染。假设六个月内收缩压（SBP）的变化（单位为毫米汞柱，mmHg）遵循以下科学上合理的数据生成结构：对于参与者 $i$，其结果为\n$$\nY_{i} \\;=\\; \\mu \\;+\\; \\tau\\,E_{i} \\;+\\; \\varepsilon_{i},\n$$\n其中，$E_{i} \\in [0,1]$ 是参与者个体的干预暴露强度，$\\tau$ 是单位暴露强度对SBP变化的因果效应，$\\mu$ 是基线平均值，$\\varepsilon_{i}$ 是一个均值为零且独立于随机分配的误差项。随机化是在个体层面进行的，但由于干预是以小组形式提供的，暴露强度遵循以下规则：\n- 对于分配到干预组的参与者，由于小组授课中的稀释效应（共享时间和进度限制），其平均暴露强度为 $\\gamma \\in (0,1)$；\n- 对于分配到常规护理组的参与者，有比例为 $p \\in (0,1)$ 的人因参加了混合班级而受到污染，每人接受的部分暴露强度为 $\\lambda \\in (0,1)$；其余的人暴露为零。\n\n意向性治疗（ITT）效应定义为随机分配到干预组和随机分配到常规护理组的参与者之间平均结果的差异。将衰减偏倚定义为理想ITT效应与实际ITT效应之间的差值。理想ITT效应指的是在完美的个体化实施下（无污染，干预组接受者暴露强度 $E_{i}=1$，对照组暴露强度 $E_{i}=0$）的效果；实际ITT效应则是在前述小组授课和污染机制下的效果。\n\n假设减钠项目的完全强度因果效应为 $\\tau = -6$ mmHg（即降低了6 mmHg），治疗组的平均暴露强度为 $\\gamma = 0.85$，对照组中的污染比例为 $p = 0.30$，受污染对照组参与者的部分暴露强度为 $\\lambda = 0.40$。根据上述模型和假设，计算衰减偏倚（以mmHg为单位）。将您的答案四舍五入到四位有效数字，并以mmHg为单位表示最终值。", "solution": "用户要求基于所提供的数据生成模型和试验条件，计算随机对照试验（RCT）中的衰减偏倚。\n\n首先，我将验证问题陈述。\n\n### 步骤1：提取已知条件\n- 参与者 $i$ 的结果模型为 $Y_{i} = \\mu + \\tau E_{i} + \\varepsilon_{i}$。\n- $Y_{i}$ 是六个月内收缩压（SBP）的变化，单位为mmHg。\n- $E_{i} \\in [0,1]$ 是个体干预暴露强度。\n- $\\tau$ 是单位暴露强度对SBP变化的因果效应。\n- $\\mu$ 是基线平均值。\n- $\\varepsilon_{i}$ 是一个均值为零且独立于随机分配的误差项，因此 $E[\\varepsilon_{i}] = 0$。\n- 对于分配到干预组的参与者，平均暴露强度为 $\\gamma \\in (0,1)$。\n- 对于分配到常规护理组的参与者，有比例为 $p \\in (0,1)$ 的人受到污染，接受的部分暴露强度为 $\\lambda \\in (0,1)$。剩余的比例 $1-p$ 接受零暴露。\n- 意向性治疗（ITT）效应定义为随机分配到干预组和随机分配到常规护理组的参与者之间平均结果的差异。\n- 衰减偏倚定义为理想ITT效应与实际ITT效应之间的差值。\n- 理想ITT效应假设完美实施：干预组分配者的 $E_{i}=1$，对照组分配者的 $E_{i}=0$。\n- 实际ITT效应源于所述的小组授课污染机制。\n- 具体的数值为：$\\tau = -6$ mmHg，$\\gamma = 0.85$，$p = 0.30$，$\\lambda = 0.40$。\n\n### 步骤2：使用提取的已知条件进行验证\n该问题在生物统计学和临床试验方法学领域内定义明确。ITT分析、治疗稀释和污染等概念都是标准概念。所提供的数学模型是一个简单但标准的因果效应线性模型。所有参数都有定义，且要求进行的计算是具体的。该情景在科学上是合理的。问题具有科学依据，提法恰当，且客观。它没有违反任何无效性标准。\n\n### 步骤3：结论和行动\n问题是有效的。我将继续进行解答。\n\n目标是计算衰减偏倚，其定义为：\n$$\n\\text{衰减偏倚} = \\text{ITT}_{\\text{理想}} - \\text{ITT}_{\\text{实际}}\n$$\n\n设 $Z_i$ 为参与者 $i$ 的随机分配指示变量，其中若分配到干预组则 $Z_i=1$，若分配到常规护理（对照）组则 $Z_i=0$。ITT效应的一般形式是 $E[Y_i | Z_i=1] - E[Y_i | Z_i=0]$。\n\n首先，我将计算理想ITT效应，即 $\\text{ITT}_{\\text{理想}}$。在理想实施情景下：\n- 对于分配到干预组的参与者（$Z_i=1$），暴露是完全的，因此 $E_i = 1$。其期望结果是：\n  $$\n  E[Y_i | Z_i=1] = E[\\mu + \\tau E_i + \\varepsilon_i | Z_i=1] = E[\\mu + \\tau(1) + \\varepsilon_i] = \\mu + \\tau\n  $$\n  因为 $E[\\varepsilon_i]=0$。\n- 对于分配到对照组的参与者（$Z_i=0$），没有暴露，因此 $E_i = 0$。其期望结果是：\n  $$\n  E[Y_i | Z_i=0] = E[\\mu + \\tau E_i + \\varepsilon_i | Z_i=0] = E[\\mu + \\tau(0) + \\varepsilon_i] = \\mu\n  $$\n- 理想ITT效应是这两个期望结果之间的差值：\n  $$\n  \\text{ITT}_{\\text{理想}} = (\\mu + \\tau) - \\mu = \\tau\n  $$\n\n接下来，我将计算在所述的小组授课和污染机制下的实际ITT效应，即 $\\text{ITT}_{\\text{实际}}$。这需要计算每个随机化组内的期望暴露。\n- 对于干预组（$Z_i=1$），问题陈述其平均暴露强度为 $\\gamma$。因此，$E[E_i|Z_i=1] = \\gamma$。其期望结果是：\n  $$\n  E[Y_i | Z_i=1] = E[\\mu + \\tau E_i + \\varepsilon_i | Z_i=1] = \\mu + \\tau E[E_i|Z_i=1] + E[\\varepsilon_i] = \\mu + \\tau\\gamma\n  $$\n- 对于对照组（$Z_i=0$），比例为 $p$ 的参与者受到污染并接受暴露 $\\lambda$，而剩余的比例 $1-p$ 接受暴露 $0$。该组的期望暴露是加权平均值：\n  $$\n  E[E_i|Z_i=0] = p \\cdot \\lambda \\ + (1-p) \\cdot 0 = p\\lambda\n  $$\n  对照组的期望结果是：\n  $$\n  E[Y_i | Z_i=0] = E[\\mu + \\tau E_i + \\varepsilon_i | Z_i=0] = \\mu + \\tau E[E_i|Z_i=0] + E[\\varepsilon_i] = \\mu + \\tau p\\lambda\n  $$\n- 实际ITT效应是这两个期望结果之间的差值：\n  $$\n  \\text{ITT}_{\\text{实际}} = (\\mu + \\tau\\gamma) - (\\mu + \\tau p\\lambda) = \\tau\\gamma - \\tau p\\lambda = \\tau(\\gamma - p\\lambda)\n  $$\n\n现在，我可以使用其定义来计算衰减偏倚：\n$$\n\\text{衰减偏倚} = \\text{ITT}_{\\text{理想}} - \\text{ITT}_{\\text{实际}} = \\tau - \\tau(\\gamma - p\\lambda)\n$$\n将 $\\tau$ 提取出来，我们得到：\n$$\n\\text{衰减偏倚} = \\tau(1 - (\\gamma - p\\lambda)) = \\tau(1 - \\gamma + p\\lambda)\n$$\n\n最后一步是将给定的数值代入此表达式：$\\tau = -6$，$\\gamma = 0.85$，$p = 0.30$，$\\lambda = 0.40$。\n$$\n\\text{衰减偏倚} \\;=\\; -6 \\times (1 - 0.85 + 0.30 \\times 0.40)\n$$\n首先，计算乘积 $p\\lambda$：\n$$\np\\lambda \\;=\\; 0.30 \\times 0.40 \\;=\\; 0.12\n$$\n现在将此结果代回偏倚的表达式中：\n$$\n\\text{衰减偏倚} \\;=\\; -6 \\times (1 - 0.85 + 0.12)\n$$\n$$\n\\text{衰减偏倚} \\;=\\; -6 \\times (0.15 + 0.12)\n$$\n$$\n\\text{衰减偏倚} \\;=\\; -6 \\times (0.27)\n$$\n$$\n\\text{衰减偏倚} \\;=\\; -1.62\n$$\n问题要求答案四舍五入到四位有效数字。计算出的值为 $-1.62$。要用四位有效数字表示，必须写为 $-1.620$。单位是mmHg。\n理想效应是 $\\tau = -6$ mmHg。观察到的ITT效应是 $\\text{ITT}_{\\text{实际}} = -6 \\times (0.85 - 0.12) = -6 \\times 0.73 = -4.38$ mmHg。衰减偏倚是差值 $\\text{ITT}_{\\text{理想}} - \\text{ITT}_{\\text{实际}} = -6 - (-4.38) = -1.62$ mmHg。这证实了结果。数值 $-1.620$ 表示偏倚的大小（单位为mmHg），该偏倚削弱了观察到的ITT效应（相较于完全干预的真实因果效应）。", "answer": "$$\n\\boxed{-1.620}\n$$", "id": "4982143"}, {"introduction": "盲法对于预防评估和报告偏倚至关重要，但我们如何客观地衡量盲法是否成功？本练习介绍了一种量化工具——盲法指数，用于评估受试者猜测其治疗分配的准确性。通过计算和解释该指数，您将学会如何从数据中评估试验盲法的完整性，这是评判试验质量的关键一步 [@problem_id:4982173]。", "problem": "一项双臂随机、双盲临床试验评估参与者是否能正确猜出他们被分配的治疗臂，目的是评估设盲（盲法）效果。在理想的设盲条件下，采用强迫二选一猜测，正确猜测的概率应等于随机概率。考虑以下 $2 \\times 2$ 计数表，其中行是真实的分配臂，列是通过没有“不知道”选项的强迫选择问卷猜测的臂。各行之和为各臂的样本量。\n\n- 真实干预组：猜是干预组 $51$ 人，猜是安慰剂组 $99$ 人。\n- 真实安慰剂组：猜是干预组 $60$ 人，猜是安慰剂组 $120$ 人。\n\n从以下定义出发：在完美的设盲和强迫二选一猜测下，“正确猜测”事件发生的概率为 $1/2$；任何定量的设盲指数都应在完全破盲（所有猜测都正确）时赋值为 $1$，在完全破盲（所有猜测都错误，即系统性反向猜测）时赋值为 $-1$，在随机水平猜测时赋值为 $0$。请完成以下任务：\n\n1. 推导一个特定于臂的盲法指数，该指数是满足上述锚定条件的、对特定臂正确猜测概率的线性重缩放。用特定臂的正确猜测概率来表示你的指数。\n2. 使用上表，根据观测到的计数分别为干预组和安慰剂组估计该指数。\n3. 简要说明接近 $-1$、$0$ 和 $1$ 的值分别表示怎样的设盲质量。\n\n将你的两个指数估计值按（干预组，安慰剂组）的顺序报告为一个单行矩阵，四舍五入到四位有效数字。最终答案必须是无单位的纯数字。", "solution": "问题要求推导一个盲法指数，根据所提供的数据为两个治疗臂计算该指数，并解释其值的含义。首先对问题陈述进行验证。\n\n### 第 1 步：提取已知条件\n- 研究是一项双臂随机、双盲临床试验。\n- 在理想的设盲和强迫二选一猜测下，正确猜测的概率为 $p = \\frac{1}{2}$。\n- 来自 $2 \\times 2$ 计数表的数据：\n    - 真实干预组：$51$ 人猜是干预组，$99$ 人猜是安慰剂组。\n    - 真实安慰剂组：$60$ 人猜是干预组，$120$ 人猜是安慰剂组。\n- 一个特定于臂的盲法指数 $BI$ 必须是特定于臂的正确猜测概率 $p$ 的线性重缩放。\n- 该指数必须满足三个锚定条件：\n    1.  完全破盲且所有猜测都正确（$p=1$）时，$BI=1$。\n    2.  完全破盲且所有猜测都错误（$p=0$）时，$BI=-1$。\n    3.  随机水平猜测（$p = \\frac{1}{2}$）时，$BI=0$。\n- 任务是：\n    1.  推导指数 $BI(p)$ 的函数形式。\n    2.  为干预组和安慰剂组估计该指数。\n    3.  解释接近 $-1$、$0$ 和 $1$ 的指数值的含义。\n- 两个指数的最终估计值需以行矩阵形式报告，并四舍五入到四位有效数字。\n\n### 第 2 步：使用提取的已知条件进行验证\n该问题具有科学依据，是临床试验统计分析中的一个标准练习，特别是关于盲法完整性的评估。盲法指数的概念以及在强迫二选一情景下随机水平猜测对应于 $\\frac{1}{2}$ 概率的假设是基本且正确的。该问题提法恰当，因为所给条件足以唯一确定指数的线性变换。数据完整且一致。语言客观、精确。该问题不违反任何无效性标准。\n\n### 第 3 步：结论与行动\n该问题有效。将提供完整解答。\n\n### 解答\n\n#### 1. 特定臂盲法指数的推导\n\n令特定臂的正确猜测概率为 $p$。问题陈述盲法指数 $BI$ 是 $p$ 的一个线性函数。我们可以将此关系写为：\n$$\nBI(p) = ap + b\n$$\n其中 $a$ 和 $b$ 是待定常数。我们使用给定的锚定条件来求解 $a$ 和 $b$。\n\n- **条件 1**：完全破盲且所有猜测都错误。这对应于正确猜测的概率 $p=0$。此情况下的指数被指定为 $BI(0) = -1$。\n$$\nBI(0) = a(0) + b = -1 \\implies b = -1\n$$\n\n- **条件 2**：完全破盲且所有猜测都正确。这对应于正确猜测的概率 $p=1$。此情况下的指数被指定为 $BI(1) = 1$。\n$$\nBI(1) = a(1) + b = 1\n$$\n将 $b=-1$ 代入此方程得到：\n$$\na - 1 = 1 \\implies a = 2\n$$\n\n因此，盲法指数的公式为：\n$$\nBI(p) = 2p - 1\n$$\n\n我们必须用第三个条件来验证此公式：随机水平猜测。这对应于正确猜测的概率 $p=\\frac{1}{2}$，此时指数应为 $BI(\\frac{1}{2}) = 0$。\n$$\nBI\\left(\\frac{1}{2}\\right) = 2\\left(\\frac{1}{2}\\right) - 1 = 1 - 1 = 0\n$$\n该公式与所有三个指定条件一致。此指数是 James 盲法指数的一个变体。\n\n#### 2. 为干预组和安慰剂组估计指数\n\n我们首先整理数据，以计算每个臂的正确猜测概率的估计值。\n\n对于**干预组**：\n- 正确猜到“干预组”的受试者人数（$N_{AA}$）：$51$。\n- 错误猜到“安慰剂组”的受试者人数（$N_{AP}$）：$99$。\n- 干预组的总受试者人数（$n_A$）：$n_A = N_{AA} + N_{AP} = 51 + 99 = 150$。\n\n干预组中正确猜测的估计概率 $\\hat{p}_A$ 是该组中正确猜测的受试者比例：\n$$\n\\hat{p}_A = \\frac{N_{AA}}{n_A} = \\frac{51}{150} = 0.34\n$$\n干预组相应的盲法指数 $BI_A$ 为：\n$$\nBI_A = 2\\hat{p}_A - 1 = 2(0.34) - 1 = 0.68 - 1 = -0.32\n$$\n\n对于**安慰剂组**：\n- 错误猜到“干预组”的受试者人数（$N_{PA}$）：$60$。\n- 正确猜到“安慰剂组”的受试者人数（$N_{PP}$）：$120$。\n- 安慰剂组的总受试者人数（$n_P$）：$n_P = N_{PA} + N_{PP} = 60 + 120 = 180$。\n\n安慰剂组中正确猜测的估计概率 $\\hat{p}_P$ 是该组中正确猜测的受试者比例：\n$$\n\\hat{p}_P = \\frac{N_{PP}}{n_P} = \\frac{120}{180} = \\frac{2}{3}\n$$\n安慰剂组相应的盲法指数 $BI_P$ 为：\n$$\nBI_P = 2\\hat{p}_P - 1 = 2\\left(\\frac{2}{3}\\right) - 1 = \\frac{4}{3} - 1 = \\frac{1}{3}\n$$\n以小数表示，$BI_P = \\frac{1}{3} \\approx 0.33333...$。\n\n按要求将结果四舍五入到四位有效数字：\n- $BI_A = -0.3200$\n- $BI_P \\approx 0.3333$\n\n#### 3. 盲法指数值的解释\n\n基于指数 $BI(p) = 2p - 1$ 的推导：\n- $BI \\approx 1$ 的值对应于 $p \\approx 1$。这表示设盲严重失败，参与者能够以远超随机的水平正确识别他们被分配的治疗臂。\n- $BI \\approx 0$ 的值对应于 $p \\approx \\frac{1}{2}$。这表明参与者猜测其分组的比率与纯粹的随机机会一致，这是成功设盲试验所期望的结果。\n- $BI \\approx -1$ 的值对应于 $p \\approx 0$。这表示设盲严重失败，参与者系统性地猜测与其真实分组*相反*的分组。例如，如果安慰剂的副作用被误解为活性治疗的迹象，或者反之，就可能发生这种形式的破盲。\n\n在本案例中，$BI_A = -0.3200$ 表明干预组的患者倾向于猜测自己在安慰剂组，其频率高于随机预测，这表明存在一定程度的“反向”破盲。$BI_P = 0.3333$ 表明安慰剂组的患者在猜测其分组方面优于随机水平，这表明存在一定程度的朝向正确识别的破盲。", "answer": "$$\n\\boxed{\\begin{pmatrix} -0.3200  0.3333 \\end{pmatrix}}\n$$", "id": "4982173"}, {"introduction": "随机化不仅是一种分配方法，更是统计推断的理论基础。对于约束性随机化等高级设计，传统的统计检验可能不再适用，我们需要直接基于随机化方案本身进行推断。这个高级编程练习将指导您实现一个重随机化检验，通过仅在满足协变量平衡条件的“可接受”分配集中进行抽样，来计算精确的$p$值，从而加深您对基于设计的推断这一核心概念的理解 [@problem_id:4982187]。", "problem": "您需要在一个约束随机化设计下，实现并论证一个用于检验 Fisher 精确零假设（即无处理效应）的再随机化检验。此检验仅从容许分配集中抽样。请在完全指定的有限样本设定下进行。程序必须通过枚举容许分配集，并根据观测到的检验统计量聚合尾部概率，来计算精确的双侧基于随机化的 p 值。\n\n使用以下基本依据：\n- 稳定单位处理值假设 (SUTVA)：对于每个单位 $i \\in \\{1,\\dots,N\\}$，存在两个潜在结果 $Y_i(0)$ 和 $Y_i(1)$。在分配向量 $W \\in \\{0,1\\}^N$ 下，观测结果为 $Y_i^{\\mathrm{obs}} = W_i Y_i(1) + (1-W_i) Y_i(0)$，且单位之间无干扰。\n- Fisher 精确零假设（无处理效应）：对于所有 $i$，$Y_i(1) = Y_i(0)$。因此，观测结果向量 $Y^{\\mathrm{obs}}$ 对分配不变，并等于共同的潜在结果向量 $Y$。\n- 基于设计的推断：在一个处理组规模固定为 $n_T = \\sum_{i=1}^N W_i$ 的随机实验中，随机化分布由分配空间上的设计所定义。\n- 约束随机化：令 $X \\in \\mathbb{R}^{N \\times p}$ 表示处理前协变量。定义一个平衡标准 $g(W, X)$ 为处理组和控制组在指定协变量维度上均值的绝对差，并设容差为 $\\delta \\ge 0$。容许分配集为\n$$\n\\mathcal{A} = \\left\\{ W \\in \\{0,1\\}^N : \\sum_{i=1}^N W_i = n_T,\\ \\left| \\bar X_T - \\bar X_C \\right| \\le \\delta \\right\\},\n$$\n其中 $\\bar X_T$ 和 $\\bar X_C$ 分别是所选协变量在处理组和控制组内的样本均值。\n- 检验统计量：使用结果的均值差，\n$$\nT(W, Y) = \\frac{1}{n_T} \\sum_{i: W_i=1} Y_i - \\frac{1}{N-n_T} \\sum_{i: W_i=0} Y_i.\n$$\n\n您的程序必须为每个测试用例执行以下操作：\n- 枚举所有满足 $\\sum_i W_i = n_T$ 的分配 $W$。\n- 使用指定的 $\\delta$ 和给定的协变量向量 $X$（如果 $p > 1$，则使用第一列）筛选出容许集 $\\mathcal{A}$。\n- 使用提供的观测分配 $W^{\\mathrm{obs}}$ 和结果 $Y$ 计算观测统计量 $T(W^{\\mathrm{obs}}, Y)$。\n- 根据以下公式计算零假设下的精确双侧 p 值\n$$\np = \\frac{1}{|\\mathcal{A}|} \\sum_{W \\in \\mathcal{A}} \\mathbf{1}\\left( \\left| T(W, Y) \\right| \\ge \\left| T(W^{\\mathrm{obs}}, Y) \\right| \\right),\n$$\n其中 $\\mathbf{1}(\\cdot)$ 是指示函数，并通过弱不等式包含平局情况。\n\n论证有效性：在分配隐藏和盲法下，研究者或患者的行为不会扭曲 $W$，并且实验设计从 $\\mathcal{A}$ 中均匀抽取 $W$。在 Fisher 精确零假设下，$Y$ 是固定的。因此，仅从 $\\mathcal{A}$ 中抽样的再随机化检验，对于任何 $\\alpha \\in (0,1)$，都能在 $\\alpha$ 水平上实现精确的有限样本 I 类错误控制，因为在限制于 $\\mathcal{A}$ 的设计分布下，p 值是 $W$ 的一个超均匀函数。\n\n实现要求：\n- 无用户输入。在代码中硬编码以下测试用例。\n- 所有计算必须相对于有限的容许集是精确的；不要通过蒙特卡洛方法进行近似。\n- 角度单位不适用。不涉及物理单位。将概率报告为 $[0,1]$ 区间内的小数。\n\n测试套件（请严格使用这三个用例）：\n- 用例 1（理想情况，中等约束）：\n  - $N = 8$，$n_T = 4$，\n  - 协变量向量 $X = [-1.2, -0.5, -0.1, 0.0, 0.3, 0.6, 1.1, 1.4]$，\n  - 结果向量 $Y = [4.0, 3.1, 2.9, 5.2, 6.3, 5.9, 4.8, 6.7]$，\n  - 观测分配 $W^{\\mathrm{obs}} = [1, 0, 1, 0, 0, 1, 0, 1]$，\n  - 约束容差 $\\delta = 0.25$，应用于单一协变量的处理组与控制组均值绝对差。\n- 用例 2（边界情况，无约束设计）：\n  - $N$、$n_T$、$X$、$Y$、$W^{\\mathrm{obs}}$ 与用例 1 相同，\n  - 约束容差 $\\delta = 10.0$，使得所有 $n_T = 4$ 的分配都是容许的。\n- 用例 3（边缘情况，二元协变量上的严格平衡）：\n  - $N = 8$，$n_T = 4$，\n  - 协变量向量 $X = [0, 0, 0, 0, 1, 1, 1, 1]$，\n  - 结果向量 $Y = [2.2, 2.9, 3.5, 3.0, 3.1, 2.7, 2.6, 3.2]$，\n  - 观测分配 $W^{\\mathrm{obs}} = [1, 0, 1, 0, 1, 0, 1, 0]$，\n  - 约束容差 $\\delta = 0.0$，使得只有组间协变量均值完全相等的分配才是容许的，在本例中要求处理组中恰好有 $2$ 个 $X=1$ 的单位。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含用例 1、2 和 3 的三个 p 值，按顺序排列，形式为逗号分隔的列表并用方括号括起，每个值四舍五入到 $6$ 位小数（例如，`\"[0.428571,0.271429,0.500000]\"`）。不允许有其他输出。", "solution": "该问题陈述是有效的。它在统计因果推断领域是一个定义明确、有科学依据的问题，为获得唯一、可验证的解提供了所有必要的信息和定义。\n\n任务是实现一个用于检验 Fisher 精确零假设（即无处理效应）的再随机化检验。此程序的核心是通过仅考虑满足预先指定协变量平衡约束的处理分配集合，来计算一个精确的 p 值。\n\n首先，我们按要求为该检验程序的有效性提供理论论证。一个有效的基于随机化的检验必须将 I 类错误率控制在预先指定的水平 $\\alpha$ 以下。\n\n实验设定包含 $N$ 个单位，索引为 $i \\in \\{1, \\dots, N\\}$。其中 $n_T$ 个单位的子集接受处理，其余 $n_C = N - n_T$ 个单位作为对照组。一个处理分配是一个二元向量 $W \\in \\{0, 1\\}^N$，其中 $W_i=1$ 表示单位 $i$ 接受处理，且 $\\sum_{i=1}^N W_i = n_T$。\n\n稳定单位处理值假设 (SUTVA) 假定每个单位 $i$ 有两个潜在结果，$Y_i(1)$（如果接受处理）和 $Y_i(0)$（如果不接受处理），观测到的结果是 $Y_i^{\\mathrm{obs}} = W_i Y_i(1) + (1-W_i) Y_i(0)$。\n\nFisher 精确零假设 $H_0$ 指出，对任何单位都没有处理效应：对于所有 $i$，$Y_i(1) = Y_i(0)$。$H_0$ 的一个关键推论是，单位 $i$ 的观测结果为 $Y_i^{\\mathrm{obs}} = Y_i(0)$，无论其处理状态如何。因此，在 $H_0$ 下，观测结果向量 $Y$ 是固定的，不依赖于分配向量 $W$。\n\n在传统的随机实验中，分配 $W$是从所有可能的分配集合 $\\Omega = \\{W \\in \\{0,1\\}^N : \\sum W_i = n_T\\}$ 中均匀抽取的。在约束随机化（或再随机化）设计中，分配是从一个受限的子集 $\\mathcal{A} \\subseteq \\Omega$ 中均匀抽取的。这个容许集 $\\mathcal{A}$ 只包含那些满足特定标准的分配，在本例中，该标准是对协变量不平衡的界限：\n$$\n\\mathcal{A} = \\left\\{ W \\in \\Omega : \\left| \\bar X_T(W) - \\bar X_C(W) \\right| \\le \\delta \\right\\}\n$$\n其中 $\\bar X_T(W)$ 和 $\\bar X_C(W)$ 是由分配 $W$ 定义的处理组和控制组的协变量 $X$ 的均值，$\\delta \\ge 0$ 是一个容差。实验设计规定，观测到的分配 $W^{\\mathrm{obs}}$ 是从 $\\mathcal{A}$ 中均匀随机抽取的。分配隐藏和盲法的原则旨在确保此随机化过程不受损害。\n\n检验统计量是结果的均值差：$T(W, Y) = \\bar{Y}_T(W) - \\bar{Y}_C(W)$。在 $H_0$ 下，$Y$ 是固定的，因此检验统计量仅是 $W$ 的函数，我们记为 $T(W)$。在已实现的实验中，检验统计量的值为 $t^{\\mathrm{obs}} = T(W^{\\mathrm{obs}})$。\n\n双侧 p 值是在零假设下，观测到至少与实际观测到的检验统计量一样极端的检验统计量的概率。这个概率的参考分布是当 $W$ 从 $\\mathcal{A}$ 中均匀抽取时 $T(W)$ 的随机化分布。\n$$\np = P\\left( |T(W)| \\ge |t^{\\mathrm{obs}}| \\mid H_0, W \\sim \\text{Uniform}(\\mathcal{A}) \\right)\n$$\n这个概率通过枚举容许集中的所有分配来计算：\n$$\np = \\frac{1}{|\\mathcal{A}|} \\sum_{W \\in \\mathcal{A}} \\mathbf{1}\\left( |T(W)| \\ge |t^{\\mathrm{obs}}| \\right)\n$$\n其中 $\\mathbf{1}(\\cdot)$ 是指示函数。p 值 $p$ 本身是一个随机变量，因为它是随机分配 $W^{\\mathrm{obs}}$（通过 $t^{\\mathrm{obs}}$）的函数。我们将其表示为 $p(W^{\\mathrm{obs}})$。\n\n为证明该检验能控制 I 类错误，我们必须表明，对于任何显著性水平 $\\alpha \\in (0,1)$，当 $H_0$ 为真时，拒绝 $H_0$ 的概率不大于 $\\alpha$。该检验的决策规则是，如果 $p(W^{\\mathrm{obs}}) \\le \\alpha$，则拒绝 $H_0$。我们需要证明 $P(p(W^{\\mathrm{obs}}) \\le \\alpha \\mid H_0) \\le \\alpha$。\n\n在 $H_0$ 下，$W^{\\mathrm{obs}}$ 的分布在 $\\mathcal{A}$ 上是均匀的。对于任何潜在的分配 $w \\in \\mathcal{A}$，其被选中的概率是 $P(W^{\\mathrm{obs}} = w) = 1/|\\mathcal{A}|$。如果 $w$ 是被选中的分配，那么计算出的 p 值是 $p(w) = \\frac{1}{|\\mathcal{A}|} \\sum_{w' \\in \\mathcal{A}} \\mathbf{1}( |T(w')| \\ge |T(w)| )$。\n\n考虑获得一个小于或等于某个值 $c$ 的 p 值的概率：$P(p(W^{\\mathrm{obs}}) \\le c)$。令 $A_c = \\{w \\in \\mathcal{A} : p(w) \\le c\\}$。那么 $P(p(W^{\\mathrm{obs}}) \\le c) = |A_c| / |\\mathcal{A}|$。根据 p 值的构造，产生至多为 $p(w)$ 的 p 值的分配集合，恰好是那些其检验统计量至少与 $|T(w)|$ 一样极端的分配集合。这样的分配数量是 $|\\mathcal{A}| \\times p(w)$。因此，对于任何 $w \\in \\mathcal{A}$，$P(p(W^{\\mathrm{obs}}) \\le p(w)) = p(w)$。\n\n现在，对于一个给定的显著性水平 $\\alpha$，令 $p_{\\text{max}} = \\max \\{ p(w) \\mid w \\in \\mathcal{A}, p(w) \\le \\alpha \\}$。如果不存在这样的 $p(w)$，则拒绝域为空，错误率为 $0$。否则，决策规则“如果 $p(W^{\\mathrm{obs}}) \\le \\alpha$ 则拒绝”等价于“如果 $p(W^{\\mathrm{obs}}) \\le p_{\\text{max}}$ 则拒绝”。此事件的概率为：\n$$\nP(\\text{拒绝 } H_0 \\mid H_0) = P(p(W^{\\mathrm{obs}}) \\le p_{\\text{max}}) = p_{\\text{max}}\n$$\n根据定义，$p_{\\text{max}} \\le \\alpha$。因此，$P(\\text{拒绝 } H_0 \\mid H_0) \\le \\alpha$。出现不等式是因为检验统计量值的分布是离散的，所以可能不存在一个分配 $w$ 使得 $p(w)$ 恰好等于 $\\alpha$。在原假设下，p 值的分布被称为超均匀分布，因为对于任何 $u \\in [0,1]$，都有 $P(p \\le u) \\le u$。这证实了再随机化检验提供了对 I 类错误率的精确有限样本控制。\n\n计算 p 值的算法如下：\n1.  通过生成 $N$ 个索引中所有 $n_T$ 个索引的组合，定义所有可能分配的完整集合 $\\Omega$。\n2.  通过筛选 $\\Omega$ 来构建容许集 $\\mathcal{A}$。对于每个潜在分配 $W \\in \\Omega$：\n    a. 将协变量向量 $X$ 划分到处理组和控制组。\n    b. 计算均值 $\\bar{X}_T$ 和 $\\bar{X}_C$。\n    c. 如果 $|\\bar{X}_T - \\bar{X}_C| \\le \\delta$，则将 $W$ 包含在 $\\mathcal{A}$ 中。\n3.  使用提供的观测分配 $W^{\\mathrm{obs}}$ 计算观测到的检验统计量 $t^{\\mathrm{obs}} = T(W^{\\mathrm{obs}}, Y)$。\n4.  初始化一个极端事件计数器为零。\n5.  遍历 $\\mathcal{A}$ 中的每个分配 $W$。对于每个 $W$：\n    a. 计算检验统计量 $T(W, Y)$。在精确零假设下，对于所有假设的分配，结果向量 $Y$ 都是相同的。\n    b. 如果 $|T(W, Y)| \\ge |t^{\\mathrm{obs}}|$，则计数器加一。\n6.  p 值是最终计数除以 $\\mathcal{A}$ 中的总分配数，即 $|\\mathcal{A}|$。\n对提供的三个测试用例中的每一个都实现了此过程。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom itertools import combinations\n\ndef calculate_p_value(N, n_T, X, Y, W_obs, delta):\n    \"\"\"\n    Computes the exact two-sided p-value from a re-randomization test.\n\n    Args:\n        N (int): Total number of units.\n        n_T (int): Number of units in the treatment group.\n        X (np.ndarray): Covariate vector of shape (N,).\n        Y (np.ndarray): Outcome vector of shape (N,).\n        W_obs (np.ndarray): Observed assignment vector of shape (N,).\n        delta (float): Tolerance for covariate balance.\n\n    Returns:\n        float: The exact two-sided p-value.\n    \"\"\"\n    n_C = N - n_T\n    all_indices = np.arange(N)\n\n    # Step 1: Enumerate all possible assignments\n    all_possible_treatment_indices = list(combinations(all_indices, n_T))\n    \n    # Step 2: Filter to find the admissible set A\n    admissible_set = []\n    for treat_indices in all_possible_treatment_indices:\n        treat_indices = np.array(treat_indices)\n        control_indices = np.setdiff1d(all_indices, treat_indices)\n        \n        # Calculate covariate means, handling cases where a group might be empty\n        # Although n_T and n_C are > 0, this is good practice.\n        x_treat_mean = np.mean(X[treat_indices]) if len(treat_indices) > 0 else 0\n        x_control_mean = np.mean(X[control_indices]) if len(control_indices) > 0 else 0\n        \n        balance_diff = np.abs(x_treat_mean - x_control_mean)\n        \n        if balance_diff = delta:\n            # Store indices, not the full W vector, for efficiency\n            admissible_set.append(treat_indices)\n\n    if not admissible_set:\n        # This case is unlikely but possible if delta is too strict\n        return np.nan\n\n    admissible_set_size = len(admissible_set)\n    \n    # Step 3: Compute the observed test statistic\n    obs_treat_indices = np.where(W_obs == 1)[0]\n    obs_control_indices = np.where(W_obs == 0)[0]\n    \n    # Check if the observed allocation is in the admissible set\n    # Create a set of tuples for quick checking\n    obs_treat_indices_tuple = tuple(sorted(obs_treat_indices))\n    admissible_set_tuples = {tuple(sorted(indices)) for indices in admissible_set}\n    if obs_treat_indices_tuple not in admissible_set_tuples:\n        # This can happen if the experiment did not correctly sample from A.\n        # The p-value is still conditional on the realized A.\n        # In a real analysis, this would be a major protocol deviation.\n        pass\n\n    y_obs_treat_mean = np.mean(Y[obs_treat_indices])\n    y_obs_control_mean = np.mean(Y[obs_control_indices])\n    t_obs = y_obs_treat_mean - y_obs_control_mean\n    abs_t_obs = np.abs(t_obs)\n\n    # Step 4: Compute the p-value\n    extreme_count = 0\n    for treat_indices in admissible_set:\n        control_indices = np.setdiff1d(all_indices, treat_indices)\n        \n        y_treat_mean = np.mean(Y[treat_indices])\n        y_control_mean = np.mean(Y[control_indices])\n        \n        t_hypothetical = y_treat_mean - y_control_mean\n        \n        if np.abs(t_hypothetical) = abs_t_obs:\n            extreme_count += 1\n            \n    p_value = extreme_count / admissible_set_size\n    return p_value\n\ndef solve():\n    \"\"\"\n    Main function to run the test cases and print results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"N\": 8, \"n_T\": 4,\n            \"X\": np.array([-1.2, -0.5, -0.1, 0.0, 0.3, 0.6, 1.1, 1.4]),\n            \"Y\": np.array([4.0, 3.1, 2.9, 5.2, 6.3, 5.9, 4.8, 6.7]),\n            \"W_obs\": np.array([1, 0, 1, 0, 0, 1, 0, 1]),\n            \"delta\": 0.25\n        },\n        {\n            \"N\": 8, \"n_T\": 4,\n            \"X\": np.array([-1.2, -0.5, -0.1, 0.0, 0.3, 0.6, 1.1, 1.4]),\n            \"Y\": np.array([4.0, 3.1, 2.9, 5.2, 6.3, 5.9, 4.8, 6.7]),\n            \"W_obs\": np.array([1, 0, 1, 0, 0, 1, 0, 1]),\n            \"delta\": 10.0\n        },\n        {\n            \"N\": 8, \"n_T\": 4,\n            \"X\": np.array([0, 0, 0, 0, 1, 1, 1, 1]),\n            \"Y\": np.array([2.2, 2.9, 3.5, 3.0, 3.1, 2.7, 2.6, 3.2]),\n            \"W_obs\": np.array([1, 0, 1, 0, 1, 0, 1, 0]),\n            \"delta\": 0.0\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        p_value = calculate_p_value(\n            case[\"N\"], case[\"n_T\"], case[\"X\"], case[\"Y\"], case[\"W_obs\"], case[\"delta\"]\n        )\n        # Round to 6 decimal places for final output formatting.\n        results.append(round(p_value, 6))\n\n    # Final print statement in the exact required format.\n    formatted_results = [f\"{res:.6f}\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\n# Execute the solver\nsolve()\n```", "id": "4982187"}]}