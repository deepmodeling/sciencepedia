## 引言
在[统计建模](@entry_id:272466)中，尤其是在医学研究领域，构建一个预测模型仅仅是第一步。任何模型的真正价值和可靠性都取决于其底层假设的有效性。我们如何确定模型准确地捕捉了数据内部的关系？这正是[回归诊断](@entry_id:187782)，特别是[残差分析](@entry_id:191495)，旨在填补的关键知识空白。[残差分析](@entry_id:191495)是我们[统计模型](@entry_id:755400)的“术后检查”，它提供了一套强有力的工具，用以审视模型假设，并识别模型与数据之间的不匹配之处。

本文将对[残差分析](@entry_id:191495)进行全面探讨，旨在让您掌握诊断和改进回归模型的理论知识与实践技能。在第一章**“原则与机制”**中，我们将深入探讨基本概念，从普通最小二乘法中残差的本质，到高级诊断指标及其在广义线性模型（GLM）和线性混合模型（LMM）等复杂模型中的扩展。随后，在**“应用与跨学科联系”**一章中，我们将展示这些原则如何应用于解决真实世界的问题，例如处理[非正态性](@entry_id:752585)、[数据依赖](@entry_id:748197)性，以及在生存分析和[算法公平性](@entry_id:143652)审计中诊断模型。最后，**“动手实践”**部分将让您通过解决实际练习来巩固所学知识，从计算基本的[标准化残差](@entry_id:634169)到为广义线性模型推导离差残差。

## 原则与机制

在统计建模中，尤其是在医学研究领域，任何模型的构建都伴随着一系列假设。模型的可靠性与预测能力直接取决于这些假设在多大程度上被满足。[残差分析](@entry_id:191495)是[回归诊断](@entry_id:187782)的核心，它提供了一套强有力的工具，用于系统性地审视模型假设，并识别模型与数据之间的潜在不匹配。本章将深入探讨[残差分析](@entry_id:191495)的基本原则与关键机制，从普通最小二乘法（OLS）的基础到广义线性模型（GLM）和线性混合模型（LMM）的扩展应用。

### 残差的本质

从根本上讲，**残差**（residual）是观测值与[模型拟合](@entry_id:265652)值之间的差异。对于第 $i$ 个观测，其残差 $e_i$ 定义为：

$e_i = Y_i - \hat{Y}_i$

其中，$Y_i$ 是观测到的响应变量值，$\hat{Y}_i$ 是模型根据预测变量 $X_i$ 给出的拟合值。在[回归分析](@entry_id:165476)中，我们通常假设一个真实的数据生成过程，形如 $Y_i = \mu(X_i) + \varepsilon_i$，其中 $\mu(X_i)$ 是真实的条件[均值函数](@entry_id:264860)，$\varepsilon_i$ 是均值为零的[随机误差](@entry_id:144890)项。我们构建的模型 $m(X_i, \beta)$ 旨在逼近这个真实的[均值函数](@entry_id:264860) $\mu(X_i)$。

因此，残差可以被分解为两个部分：

$e_i = Y_i - \hat{m}_i = (\mu(X_i) + \varepsilon_i) - \hat{m}_i = (\mu(X_i) - \hat{m}_i) + \varepsilon_i$

这个表达式揭示了残差的两个来源：一部分是由于模型形式不正确或参数估计不精确导致的**模型偏误**（modeling bias），即 $(\mu(X_i) - \hat{m}_i)$；另一部分是数据中固有的**随机噪声**（random noise），即 $\varepsilon_i$。

这一分解是[残差分析](@entry_id:191495)的基石。只有当模型被**正确设定**（correctly specified）时，即我们选择的模型形式 $m(X_i, \beta)$ 能够准确描述真实的均值结构 $\mu(X_i)$，并且我们拥有足够的数据使得估计的均值 $\hat{m}_i$ 无限接近真实均值时，模型偏误项 $(\mu(X_i) - \hat{m}_i)$ 才会趋近于零。在这种理想情况下，残差 $e_i$ 就约等于真实的、不可观测的[随机误差](@entry_id:144890) $\varepsilon_i$。此时，残差的行为应当反映出我们对误差项 $\varepsilon_i$ 所做的假设，例如独立同分布、零均值、恒定方差（[同方差性](@entry_id:634679)）和正态分布。

反之，如果[残差图](@entry_id:169585)中出现了系统性的、非随机的模式，这便是一个强烈的信号，表明模型设定存在问题。这些模式本质上是模型偏误 $(\mu(X_i) - \hat{m}_i)$ 的体现。例如，在一个旨在评估药物剂量的临床试验中，如果真实的[剂量反应关系](@entry_id:190870)是二次的，而模型仅包含了线性项，那么[残差图](@entry_id:169585)中很可能会出现一个U形或倒U形的系统性模式。同样，如果在一个纵向研究中，我们忽略了重复测量数据内在的时间[自相关](@entry_id:138991)性，残差在按时间排序后也会表现出非随机的“游程”或相关性模式。若在不同剂量组中，结果的变异性不同（即异方差），而模型假设方差恒定，残差的离散程度也会随拟合值系统性地变化 [@problem_id:4982826]。因此，通过检验残差是否表现出随机噪声的特性，我们可以反向推断模型的设定是否恰当。

### [普通最小二乘法](@entry_id:137121)残差的基本性质

在[普通最小二乘法](@entry_id:137121)（OLS）线性回归中，残差具有一些源于其最小化过程的代数性质。理解这些性质对于正确解读[残差图](@entry_id:169585)至关重要。

首先，当模型包含**截距项**（intercept）时，所有残差的总和恒等于零，即 $\sum_{i=1}^{n} e_i = 0$。这意味着残差的样本均值 $\bar{e}$ 始终为零。这个性质源于OLS的正规方程（normal equations），它要求[残差向量](@entry_id:165091) $\mathbf{e}$ 与[设计矩阵](@entry_id:165826) $\mathbf{X}$ 的每一列都正交。由于截距项对应于 $\mathbf{X}$ 中一个全为1的列向量，[残差向量](@entry_id:165091)与该[向量的正交性](@entry_id:274719)即意味着残差之和为零。这一性质是OLS的代数约束，无论[模型拟合](@entry_id:265652)得好坏，它都成立。因此，看到残差在零线上下波动是正常的，但这本身并不代表模型是正确的 [@problem_id:4982788] [@problem_id:4982777]。

其次，OLS残差与**拟合值** $\hat{Y}_i$ 的样本协方差和[相关系数](@entry_id:147037)也恒等于零，即 $\sum_{i=1}^{n} e_i \hat{Y}_i = 0$。这是因为拟合值向量 $\hat{\mathbf{y}}$ 位于[设计矩阵](@entry_id:165826) $\mathbf{X}$ 的[列空间](@entry_id:156444)中，而[残差向量](@entry_id:165091) $\mathbf{e}$ 与该空间正交。这个性质意味着，在残差对拟合值的散点图中，我们永远不会看到线性的关联。然而，这绝不意味着两者之间没有关系。正如我们将在下一节看到的，非线性关系是诊断模型均值结构是否正确的关键 [@problem_id:4982768]。

最后，一个常被忽略但至关重要的性质是，OLS残差的方差并非恒定。即使真实的误差项 $\varepsilon_i$ 满足[同方差性](@entry_id:634679)，即 $\mathrm{Var}(\varepsilon_i) = \sigma^2$，OLS残差的方差也依赖于数据点的位置，其表达式为：

$\mathrm{Var}(e_i) = \sigma^2 (1 - h_{ii})$

这里的 $h_{ii}$ 被称为第 $i$ 个观测的**[杠杆值](@entry_id:172567)**（leverage）。杠杆值度量了观测点 $X_i$ 在预测变量空间中的“极端”程度。$h_{ii}$ 的取值范围在 $0$ 到 $1$ 之间，其值越大，说明该点在预测变量空间中越偏离中心。从公式中可以看出，高杠杆值（$h_{ii}$ 接近1）的观测点，其对应的残差方差会更小。直观上，这是因为[高杠杆点](@entry_id:167038)对回归线有强大的“拉力”，使得拟合线倾向于穿过或靠近这些点，从而导致它们的残差较小 [@problem_id:4982795] [@problem_id:4982825]。这一性质是发展[标准化残差](@entry_id:634169)和[学生化残差](@entry_id:636292)的动因。

### 图形诊断：残差与拟合值图

在所有残差诊断工具中，**残差对拟合值图**（residuals versus fitted values plot）无疑是最重要和信息最丰富的。它通过将残差 $e_i$ 绘制在y轴，拟合值 $\hat{Y}_i$ 绘制在x轴，能够同时帮助我们评估两个核心假设：[均值函数](@entry_id:264860)的线性和误差的[同方差性](@entry_id:634679)。

#### 检验非线性

如前所述，尽管OLS残差与拟合值在代数上不相关，但它们之间可能存在复杂的非线性关系。如果模型正确捕捉了数据中的系统性趋势，那么残差应该只剩下随机噪声，在残差对拟合值图中表现为围绕水平线 $y=0$ 的一团无明显模式的散点。

然而，如果图中出现系统性曲率，则强烈暗示模型的均值结构被错误设定。例如，在一个肾脏病学研究中，若研究者用线性模型拟合尿蛋白肌酐比的对数值，但残差对拟合值的平滑曲线呈现出中间低、两端高的“U形”模式，这便是遗漏了某个重要预测变量的二次项（或更高阶项）的典型迹象。相反，一个“S形”的趋势可能暗示着遗漏了三次项或某些[交互作用](@entry_id:164533)项 [@problem_id:4982768]。这个图之所以如此强大，是因为拟合值 $\hat{Y}_i$ 是所有预测变量的[线性组合](@entry_id:155091)，它将多维的预测变量空间压缩到一维，从而有效地揭示了由任何预测变量或其组合引起的总体非线性问题。

#### 检验异方差性

残差对拟合值图的另一个关键用途是检验**[同方差性](@entry_id:634679)**（homoscedasticity）假设，即误差项的方差 $\sigma^2$ 不随预测变量的水平而改变。如果此假设成立，残差点的垂直离散程度（即散点的“厚度”）在图的水平方向上应大致保持一致。

当这一假设被违背时，即出现**异方差性**（heteroscedasticity），残差的离散程度会随拟合值的变化而系统性地改变。在医学研究中，一个常见的模式是“锥形”或“喇叭形”（funnel shape），即随着拟合值的增大，残差的散布范围也随之扩大。例如，在一个高血压研究中，如果发现拟合的收缩压值越高，残差的波动范围越大，这可能意味着响应变量的变异性与其均值成正比。这种情况表明，OLS的基本假设之一被违反，虽然[系数估计](@entry_id:175952)值仍然是无偏的，但其标准误和相关的[假设检验](@entry_id:142556)（如t检验）将不再可靠 [@problem_id:4982777] [@problem_id:4982825]。

面对异方差性，常见的处理策略包括对响应变量进行**方差稳定化变换**（variance-stabilizing transformation），例如，当标准差与均值成正比时使用[对数变换](@entry_id:267035)；或者采用**[加权最小二乘法](@entry_id:177517)**（Weighted Least Squares, WLS），给予方差较小的观测点更大的权重 [@problem_id:4982777]。

### 检验[正态性假设](@entry_id:170614)

经典[线性模型](@entry_id:178302)通常假设误差项 $\varepsilon_i$ 服从正态分布。尽管[OLS估计量](@entry_id:177304)的无偏性不依赖于此，但[正态性假设](@entry_id:170614)是进行精确有限样本推断（如构建t检验和[F检验](@entry_id:274297)）的理论基础 [@problem_id:4982825]。

检验残差正态性的标准工具是**[分位数-分位数图](@entry_id:174944)**（Quantile-Quantile plot, 或[Q-Q图](@entry_id:174944)）。其思想是比较样本[分位数](@entry_id:178417)（来自我们模型的残差）和理论分位数（来自一个[标准正态分布](@entry_id:184509)）。

具体而言，构建[Q-Q图](@entry_id:174944)的步骤如下：
1.  计算模型的残差，并将其标准化（我们将在下一节讨论不同类型的[标准化残差](@entry_id:634169)）。
2.  将[标准化残差](@entry_id:634169)从小到大排序，得到经验[顺序统计量](@entry_id:266649) $r_{(1)} \le r_{(2)} \le \dots \le r_{(n)}$。这些值将作为图的y坐标。
3.  计算对应的理论分位数。对于第 $i$ 个有序残差 $r_{(i)}$，其对应的理论[分位数](@entry_id:178417)是来自一个容量为 $n$ 的[标准正态分布](@entry_id:184509)样本的第 $i$ 个[顺序统计量](@entry_id:266649)的[期望值](@entry_id:150961)，记为 $\mathbb{E}[Z_{(i)}]$。这些[期望值](@entry_id:150961)将作为图的x坐标。

从第一性原理出发，这个[期望值](@entry_id:150961)可以通过一个积分表达式精确定义。给定一个标准正态分布，其概率密度函数为 $\phi(z)$，[累积分布函数](@entry_id:143135)为 $\Phi(z)$，$\mathbb{E}[Z_{(i)}]$ 的精确表达式为 [@problem_id:4982821]：

$\mathbb{E}[Z_{(i)}] = \int_{0}^{1} \Phi^{-1}(u) \frac{n!}{(i-1)!(n-i)!} u^{i-1} (1-u)^{n-i} \, du$

其中 $\Phi^{-1}(u)$ 是[标准正态分布](@entry_id:184509)的[分位数函数](@entry_id:271351)（CDF的反函数）。这个积分的直观含义是，我们将所有可能的标准正态样本排序后，第 $i$ 小的值的平均位置。

如果残差确实来自一个正态分布，那么[Q-Q图](@entry_id:174944)上的点 $( \mathbb{E}[Z_{(i)}], r_{(i)} )$ 将大致落在一条直线上（$y=x$ 线）。系统性地偏离这条直线则表明[正态性假设](@entry_id:170614)不成立。例如，S形的曲线可能表示分布的偏度（skewness）问题，而两端偏离直线的点则可能表示分布具有比正态分布更“重”或更“轻”的尾部。

### 用于高级诊断的残差类型

原始残差 $e_i$ 因其方差不恒定，在用于识别异常值时可能产生误导。为了克服这一问题并进行更精细的诊断，统计学家发展了多种标准化的残差。

#### [学生化残差](@entry_id:636292)

**内部[学生化残差](@entry_id:636292)**（internally studentized residual）通过使用从整个样本估计的残差标准差 $s$ （或 $\hat{\sigma}$）和杠杆值 $h_{ii}$ 对每个原始残差进行标准化：

$r_i = \frac{e_i}{s\sqrt{1-h_{ii}}}$

这种标准化考虑到了每个残差自身方差的不同。然而，由于分子 $e_i$ 和分母中的 $s$（$s^2 = \frac{\sum e_j^2}{n-p}$）并非相互独立（因为 $e_i$ 参与了 $s$ 的计算），$r_i$ 在正态假设下并不精确服从t分布 [@problem_id:4982795]。

为了解决独立性问题，**外部[学生化残差](@entry_id:636292)**（externally studentized residual），也称为**剔除残差**（deleted residual），被提了出来。其定义为：

$t_i = \frac{e_i}{s_{(i)}\sqrt{1-h_{ii}}}$

这里的关键区别在于分母使用了 $s_{(i)}$，这是在剔除第 $i$ 个观测点后重新拟合模型得到的残差标准差估计值。因为 $s_{(i)}$ 的计算完全不依赖于第 $i$ 个观测，它与 $e_i$ 是统计独立的。因此，在正态误差假设下，$t_i$ 精确服从自由度为 $n-p-1$ 的**t分布**。这使得我们可以基于[t分布](@entry_id:267063)进行严格的[假设检验](@entry_id:142556)来判断某个观测是否为异常值。实际上，我们无需真的进行 $n$ 次回归，因为 $s_{(i)}$ 和 $r_i$ 之间存在一个方便的代数关系 [@problem_id:4982795]：

$t_i = r_i \sqrt{\frac{n-p-1}{n-p-r_i^2}}$

这个关系表明，$t_i$ 是 $r_i$ 的一个单调递增函数，但并非简单的线性倍数。当 $|r_i|$ 增大时，$|t_i|$ 会以更快的速度增大，从而更显著地标识出潜在的异常点。

#### [影响点](@entry_id:170700)诊断：[库克距离](@entry_id:175103)

一个观测点可能是一个异常值（其y值偏离模型预测），也可能是一个[高杠杆点](@entry_id:167038)（其x值在预测变量空间中很极端），或者两者兼具。一个观测点的**影响力**（influence）是指其对[模型参数估计](@entry_id:752080)和拟合值的整体影响大小。

**[库克距离](@entry_id:175103)**（Cook's distance, $D_i$）是衡量影响力的标准度量。它直接量化了剔除第 $i$ 个观测点后，所有拟合值发生的总体变化。其定义式为 [@problem_id:4982806]：

$D_i = \frac{\sum_{j=1}^{n} (\hat{Y}_j - \hat{Y}_{j,(i)})^2}{p \hat{\sigma}^2}$

其中 $\hat{Y}_{j,(i)}$ 是剔除观测 $i$ 后得到的第 $j$ 个拟合值，$p$ 是模型中系数的个数。这个公式等价于衡量系数向量变化的表达式：

$D_i = \frac{(\hat{\boldsymbol{\beta}} - \hat{\boldsymbol{\beta}}_{(i)})^\top (\mathbf{X}^\top \mathbf{X})(\hat{\boldsymbol{\beta}} - \hat{\boldsymbol{\beta}}_{(i)})}{p \hat{\sigma}^2}$

同样地，[库克距离](@entry_id:175103)也有一个高效的计算公式，它将影响力量化为残差大小和[杠杆值](@entry_id:172567)的函数：

$D_i = \frac{e_i^2}{p \hat{\sigma}^2} \frac{h_{ii}}{(1 - h_{ii})^2} = \frac{r_i^2}{p} \frac{h_{ii}}{1 - h_{ii}}$

最后一个表达式将[库克距离](@entry_id:175103)与内部[学生化残差](@entry_id:636292) $r_i$ 联系起来。这个公式清晰地表明，一个观测点具有巨大影响力，通常是因为它既有较大的（[学生化](@entry_id:176921)）残差，又有较高的杠杆值。一个残差很大但杠杆很低的点，或一个杠杆很高但残差很小的点，其影响力可能都有限。[库克距离](@entry_id:175103)综合了这两方面的信息，是识别[强影响点](@entry_id:170700)的关键工具 [@problem_id:4982806]。

### 将[残差分析](@entry_id:191495)扩展到其他模型

[残差分析](@entry_id:191495)的基本思想可以推广到更复杂的模型，尽管残差的定义和解释需要相应调整。

#### [广义线性模型](@entry_id:171019)（GLM）

在GLM中，例如用于分析感染病例数等计数数据的泊松回归，响应变量的方差通常是其均值的函数（$Var(Y_i) = \phi V(\mu_i)$）。这意味着原始残差 $y_i - \hat{\mu}_i$ 的方差是不恒定的。

为了处理这个问题，**皮尔逊残差**（Pearson residual）被定义为：

$r_i^P = \frac{y_i - \hat{\mu}_i}{\sqrt{V(\hat{\mu}_i)}}$

其中 $V(\mu_i)$ 是方差函数，对于泊松分布是 $\mu_i$，对于二项分布是 $n_i \mu_i(1-\mu_i)$。这些残差通过除以均值相关的标准差（不含[离散度](@entry_id:168823)参数 $\phi$），近似地实现了方差的稳定化。

皮尔逊残差的一个重要应用是估计**[离散度](@entry_id:168823)参数**（dispersion parameter） $\phi$。通过计算**皮尔逊卡方统计量** $Q = \sum_{i=1}^{n} (r_i^P)^2$，我们可以得到 $\phi$ 的一个矩估计量：

$\hat{\phi}_P = \frac{Q}{n-p}$

在许多理论模型（如泊松分布）中，$\phi$ 假设为1。如果 $\hat{\phi}_P$ 显著大于1，则表明数据存在**[过度离散](@entry_id:263748)**（overdispersion），即观测到的变异性超出了模型的预期，这是医学计数数据中非常常见的现象。反之，$\hat{\phi}_P  1$ 则表示**低度离散**（underdispersion）。准确评估[离散度](@entry_id:168823)对于获得正确的标准误和进行有效的统计推断至关重要 [@problem_id:4982770]。

#### 线性混合模型（LMM）

对于处理纵向数据或聚[类数](@entry_id:156164)据（如来自不同临床中心的患者）的线性混合模型，残差的概念变得更加分层。LMM模型形如 $\mathbf{y} = \mathbf{X\beta} + \mathbf{Zb} + \mathbf{\varepsilon}$，其中 $\mathbf{Zb}$ 代表随机效应。这引出了两种主要的残差类型：

1.  **边际残差**（Marginal Residuals）：$e^{\text{marg}} = y - X\hat{\beta}$。
    这些残差代表了观测值与**群体平均**（population-average）拟合值的偏差。它们包含了随机效应部分（$Zb$）和[随机误差](@entry_id:144890)部分（$\varepsilon$）。因此，即使模型正确，边际残差在同一个聚类（例如，同一个病人的多次测量）内部也预期是相关的。它们主要用于检查固定效应部分的模型设定是否正确，例如，是否存在非线性的时间趋势 [@problem_id:4982782]。

2.  **条件残差**（Conditional Residuals）：$e^{\text{cond}} = y - (X\hat{\beta} + Z\hat{b})$。
    这些残差是通过从观测值中减去**个体特异性**（subject-specific）的拟合值得到的，其中 $\hat{b}$ 是随机效应的预测值（BLUPs）。条件残差因此是真正随机误差项 $\varepsilon$ 的估计。它们是检验关于 $\varepsilon$ 的假设（如正态性、[同方差性](@entry_id:634679)、内部序列无关性）的正确工具。例如，绘制条件残差的绝对值与条件拟合值的关系图，可以帮助我们判断LMM中的残差方差是否恒定 [@problem_id:4982782]。

正确区分和使用这两种残差，对于全面诊断复杂的LMM至关重要。边际残差关注模型的固定效应部分，而条件残差关注模型的随机误差结构。