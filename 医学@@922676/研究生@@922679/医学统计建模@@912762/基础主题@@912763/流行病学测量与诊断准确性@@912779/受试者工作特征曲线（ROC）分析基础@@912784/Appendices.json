{"hands_on_practices": [{"introduction": "完整的ROC曲线虽然能全面展示诊断测试的性能，但在实际应用中，我们常常需要选择一个“最佳”阈值。Youden指数通过最大化ROC曲线与机会线之间的垂直距离，为此类选择提供了一个直接的、纯粹基于统计的准则。这项练习 ([@problem_id:4963858]) 将要求您在常见的生物标志物分布参数模型下，从第一性原理出发，推导最大化Youden指数的最佳阈值，从而锻炼您的分析能力。该练习将巩固ROC曲线的几何特性与底层统计分布之间的联系。", "problem": "一个连续的诊断生物标志物 $X$ 用于在一个队列中检测某种疾病。决策规则将满足 $X \\ge t$ 的个体分类为检测阳性，其中 $t \\in \\mathbb{R}$ 是某个阈值。在该队列中，给定非患病条件下 $X$ 的条件分布是均值为 $\\mu_{0}$、方差为 $\\sigma_{0}^{2}$ 的正态分布；给定患病条件下 $X$ 的条件分布是均值为 $\\mu_{1}$、方差为 $\\sigma_{1}^{2}$ 的正态分布。具体来说，假设 $X \\mid (D=0) \\sim \\mathcal{N}(\\mu_{0},\\sigma_{0}^{2})$，其中 $\\mu_{0}=5$ 且 $\\sigma_{0}=1.5$；并且 $X \\mid (D=1) \\sim \\mathcal{N}(\\mu_{1},\\sigma_{1}^{2})$，其中 $\\mu_{1}=8$ 且 $\\sigma_{1}=2$。对于任意阈值 $t$，定义真阳性率 $\\mathrm{TPR}(t) = \\mathbb{P}(X \\ge t \\mid D=1)$，假阳性率 $\\mathrm{FPR}(t) = \\mathbb{P}(X \\ge t \\mid D=0)$，以及约登指数 $J(t) = \\mathrm{TPR}(t) - \\mathrm{FPR}(t)$，它是受试者工作特征（ROC）曲线的一个泛函。\n\n仅从这些核心定义和给定的分布假设出发，推导出使约登指数 $J(t)$ 最大化的阈值 $t^{\\star}$，并根据给定的参数计算其数值。不要假设方差相等，也不要使用任何未经证明的捷径。将最终数值答案四舍五入至四位有效数字。将您的答案表示为最优阈值 $t^{\\star}$（无单位）。", "solution": "问题是找到一个阈值 $t^{\\star}$，使得基于连续生物标志物 $X$ 的诊断测试的约登指数 $J(t)$ 最大化。\n\n首先，我们验证问题陈述的有效性。\n**第1步：提取已知条件**\n- 生物标志物: $X$\n- 决策规则：如果 $X \\ge t$，则检测为阳性。\n- 非患病个体的分布 ($D=0$)：$X \\mid (D=0) \\sim \\mathcal{N}(\\mu_{0},\\sigma_{0}^{2})$，其中 $\\mu_{0}=5$ 且 $\\sigma_{0}=1.5$。\n- 患病个体的分布 ($D=1$)：$X \\mid (D=1) \\sim \\mathcal{N}(\\mu_{1},\\sigma_{1}^{2})$，其中 $\\mu_{1}=8$ 且 $\\sigma_{1}=2$。\n- 真阳性率: $\\mathrm{TPR}(t) = \\mathbb{P}(X \\ge t \\mid D=1)$。\n- 假阳性率: $\\mathrm{FPR}(t) = \\mathbb{P}(X \\ge t \\mid D=0)$。\n- 约登指数: $J(t) = \\mathrm{TPR}(t) - \\mathrm{FPR}(t)$。\n\n**第2步：使用提取的已知条件进行验证**\n该问题具有科学依据，采用了统计决策理论和生物统计学中的标准定义和模型（正态分布、ROC分析、约登指数）。这是一个适定问题，因为它要求最大化一个定义良好、连续且可微的函数。该问题是客观、自洽且一致的，提供了所有必要的参数和定义。参数值是符合实际的。这项任务并非微不足道，需要推导和计算，特别是因为方差不相等。该问题在数学上是可验证的。\n\n**第3步：结论与行动**\n问题被判定为有效。我们可以继续进行求解。\n\n目标是找到 $t^{\\star} = \\arg\\max_{t} J(t)$。我们首先将 $J(t)$ 表示为解析形式。\n设 $\\Phi(z)$ 为标准正态分布 $\\mathcal{N}(0,1)$ 的累积分布函数（CDF）。一个正态随机变量 $Y \\sim \\mathcal{N}(\\mu, \\sigma^2)$ 大于或等于某个值 $t$ 的概率由下式给出：\n$$ \\mathbb{P}(Y \\ge t) = 1 - \\mathbb{P}(Y  t) = 1 - \\Phi\\left(\\frac{t-\\mu}{\\sigma}\\right) $$\n利用这一点，我们可以为给定的分布定义 $\\mathrm{TPR}(t)$ 和 $\\mathrm{FPR}(t)$。\n\n对于患病人群，$X_1 \\sim \\mathcal{N}(\\mu_1, \\sigma_1^2)$：\n$$ \\mathrm{TPR}(t) = \\mathbb{P}(X \\ge t \\mid D=1) = 1 - \\Phi\\left(\\frac{t-\\mu_1}{\\sigma_1}\\right) $$\n对于非患病人群，$X_0 \\sim \\mathcal{N}(\\mu_0, \\sigma_0^2)$：\n$$ \\mathrm{FPR}(t) = \\mathbb{P}(X \\ge t \\mid D=0) = 1 - \\Phi\\left(\\frac{t-\\mu_0}{\\sigma_0}\\right) $$\n现在，我们可以写出约登指数 $J(t)$ 的表达式：\n$$ J(t) = \\mathrm{TPR}(t) - \\mathrm{FPR}(t) = \\left(1 - \\Phi\\left(\\frac{t-\\mu_1}{\\sigma_1}\\right)\\right) - \\left(1 - \\Phi\\left(\\frac{t-\\mu_0}{\\sigma_0}\\right)\\right) $$\n$$ J(t) = \\Phi\\left(\\frac{t-\\mu_0}{\\sigma_0}\\right) - \\Phi\\left(\\frac{t-\\mu_1}{\\sigma_1}\\right) $$\n为了找到使 $J(t)$ 最大化的阈值 $t$，我们计算它关于 $t$ 的导数，并令其为零。设 $\\phi(z)$ 为标准正态分布的概率密度函数（PDF），它是其CDF的导数，即 $\\frac{d\\Phi(z)}{dz} = \\phi(z)$。使用链式法则：\n$$ \\frac{dJ}{dt} = \\frac{d}{dt}\\left[\\Phi\\left(\\frac{t-\\mu_0}{\\sigma_0}\\right)\\right] - \\frac{d}{dt}\\left[\\Phi\\left(\\frac{t-\\mu_1}{\\sigma_1}\\right)\\right] $$\n$$ \\frac{dJ}{dt} = \\phi\\left(\\frac{t-\\mu_0}{\\sigma_0}\\right) \\cdot \\frac{1}{\\sigma_0} - \\phi\\left(\\frac{t-\\mu_1}{\\sigma_1}\\right) \\cdot \\frac{1}{\\sigma_1} $$\n项 $\\frac{1}{\\sigma} \\phi\\left(\\frac{t-\\mu}{\\sigma}\\right)$ 是一般正态分布 $\\mathcal{N}(\\mu, \\sigma^2)$ 的概率密度函数（PDF），我们将其记为 $f(t; \\mu, \\sigma^2)$。因此，我们可以将导数写为：\n$$ \\frac{dJ}{dt} = f(t; \\mu_0, \\sigma_0^2) - f(t; \\mu_1, \\sigma_1^2) $$\n将导数设为零以找到临界点 $t^{\\star}$：\n$$ f(t^{\\star}; \\mu_0, \\sigma_0^2) = f(t^{\\star}; \\mu_1, \\sigma_1^2) $$\n这个结果表明，约登指数的最优阈值是两类概率密度函数相交处的 $t$ 值。现在我们求解这个方程以得到 $t^{\\star}$。\n$$ \\frac{1}{\\sigma_0\\sqrt{2\\pi}} \\exp\\left(-\\frac{(t^{\\star}-\\mu_0)^2}{2\\sigma_0^2}\\right) = \\frac{1}{\\sigma_1\\sqrt{2\\pi}} \\exp\\left(-\\frac{(t^{\\star}-\\mu_1)^2}{2\\sigma_1^2}\\right) $$\n对两边取自然对数：\n$$ \\ln\\left(\\frac{1}{\\sigma_0}\\right) - \\frac{(t^{\\star}-\\mu_0)^2}{2\\sigma_0^2} = \\ln\\left(\\frac{1}{\\sigma_1}\\right) - \\frac{(t^{\\star}-\\mu_1)^2}{2\\sigma_1^2} $$\n整理各项得：\n$$ \\frac{(t^{\\star}-\\mu_1)^2}{2\\sigma_1^2} - \\frac{(t^{\\star}-\\mu_0)^2}{2\\sigma_0^2} = \\ln\\left(\\frac{\\sigma_0}{\\sigma_1}\\right) $$\n乘以 $2\\sigma_0^2\\sigma_1^2$ 以消去分母：\n$$ \\sigma_0^2(t^{\\star}-\\mu_1)^2 - \\sigma_1^2(t^{\\star}-\\mu_0)^2 = 2\\sigma_0^2\\sigma_1^2 \\ln\\left(\\frac{\\sigma_0}{\\sigma_1}\\right) $$\n展开平方项：\n$$ \\sigma_0^2(t^{\\star 2} - 2\\mu_1 t^{\\star} + \\mu_1^2) - \\sigma_1^2(t^{\\star 2} - 2\\mu_0 t^{\\star} + \\mu_0^2) = 2\\sigma_0^2\\sigma_1^2 \\ln\\left(\\frac{\\sigma_0}{\\sigma_1}\\right) $$\n按 $t^{\\star}$ 的幂次对各项进行分组，我们得到一个二次方程 $At^{\\star 2} + Bt^{\\star} + C = 0$：\n$$ (\\sigma_0^2 - \\sigma_1^2)t^{\\star 2} + 2(\\mu_0\\sigma_1^2 - \\mu_1\\sigma_0^2)t^{\\star} + (\\mu_1^2\\sigma_0^2 - \\mu_0^2\\sigma_1^2 - 2\\sigma_0^2\\sigma_1^2 \\ln\\left(\\frac{\\sigma_0}{\\sigma_1}\\right)) = 0 $$\n系数为：\n$A = \\sigma_0^2 - \\sigma_1^2$\n$B = 2(\\mu_0\\sigma_1^2 - \\mu_1\\sigma_0^2)$\n$C = \\mu_1^2\\sigma_0^2 - \\mu_0^2\\sigma_1^2 - 2\\sigma_0^2\\sigma_1^2 \\ln\\left(\\frac{\\sigma_0}{\\sigma_1}\\right)$\n\n现在，我们代入给定的数值：$\\mu_{0}=5$, $\\sigma_{0}=1.5$, $\\mu_{1}=8$, $\\sigma_{1}=2$。\n$\\sigma_0^2 = (1.5)^2 = 2.25$\n$\\sigma_1^2 = (2)^2 = 4$\n\n$A = 2.25 - 4 = -1.75$\n$B = 2(5 \\cdot 4 - 8 \\cdot 2.25) = 2(20 - 18) = 4$\n$C = 8^2 \\cdot 2.25 - 5^2 \\cdot 4 - 2(2.25)(4) \\ln\\left(\\frac{1.5}{2}\\right) = 64 \\cdot 2.25 - 25 \\cdot 4 - 18 \\ln(0.75)$\n$C = 144 - 100 - 18 \\ln(0.75) = 44 - 18 \\ln(0.75)$\n\n使用 $\\ln(0.75) \\approx -0.28768$：\n$C \\approx 44 - 18(-0.28768) \\approx 44 + 5.17824 = 49.17824$\n\n$t^{\\star}$ 的二次方程为：\n$$ -1.75t^{\\star 2} + 4t^{\\star} + 49.17824 = 0 $$\n我们使用二次公式 $t^{\\star} = \\frac{-B \\pm \\sqrt{B^2 - 4AC}}{2A}$ 求解 $t^{\\star}$：\n$t^{\\star} = \\frac{-4 \\pm \\sqrt{4^2 - 4(-1.75)(49.17824)}}{2(-1.75)}$\n$t^{\\star} = \\frac{-4 \\pm \\sqrt{16 + 7(49.17824)}}{-3.5}$\n$t^{\\star} = \\frac{-4 \\pm \\sqrt{16 + 344.24768}}{-3.5}$\n$t^{\\star} = \\frac{-4 \\pm \\sqrt{360.24768}}{-3.5}$\n$t^{\\star} = \\frac{-4 \\pm 18.98019}{-3.5}$\n\n这给出了两个解：\n$t_1^{\\star} = \\frac{-4 + 18.98019}{-3.5} = \\frac{14.98019}{-3.5} \\approx -4.28005$\n$t_2^{\\star} = \\frac{-4 - 18.98019}{-3.5} = \\frac{-22.98019}{-3.5} \\approx 6.56577$\n\n由于非患病人群和患病人群的均值分别为 $\\mu_0 = 5$ 和 $\\mu_1 = 8$，且患病人群的生物标志物均值较高，因此最优阈值 $t^{\\star}$ 预期会落在这两个值之间。解 $t_1^{\\star} \\approx -4.28$ 在此背景下没有医学或统计学意义。解 $t_2^{\\star} \\approx 6.566$ 位于 $5$ 和 $8$ 之间。对 $J(t)$ 的二阶导数进行形式分析可以证实，$t_2^{\\star}$ 对应于约登指数的最大值，而 $t_1^{\\star}$ 对应于其最小值。因此，最优阈值为 $t^{\\star} = t_2^{\\star}$。\n\n将结果四舍五入至四位有效数字：\n$t^{\\star} \\approx 6.566$", "answer": "$$\\boxed{6.566}$$", "id": "4963858"}, {"introduction": "仅仅基于Youden指数等统计指标来选择阈值，实际上是隐含地假设了假阳性和假阴性具有同等的后果。在临床实践中，误诊的成本和疾病的流行率是制定有效决策的关键考量因素。这项练习 ([@problem_id:4963859]) 将挑战您将决策理论与ROC分析相结合。您将推导出能够最小化分类预期成本的最佳阈值，从而提供一种更具临床相关性的阈值选择方法，该方法能够在特定人群中平衡风险与收益。", "problem": "一项医学筛查检测会输出一个连续的诊断评分 $S \\in \\mathbb{R}$。在一个目标临床人群中，疾病指标 $D \\in \\{0,1\\}$ 的患病率为 $P(D=1)=\\pi$，其中 $\\pi \\in (0,1)$。您采用一个阈值规则：当且仅当 $S \\ge \\tau$ 时，判定 $D=1$（存在疾病），其中 $\\tau \\in \\mathbb{R}$ 是一个待选的阈值。受试者工作特征（ROC）曲线是通过改变 $\\tau$ 的值而得到的。\n\n假设评分的类条件分布如下：\n- 在患病条件下，$S \\mid D=1 \\sim \\mathcal{N}(\\mu_{1},\\sigma^{2})$。\n- 在未患病条件下，$S \\mid D=0 \\sim \\mathcal{N}(\\mu_{0},\\sigma^{2})$。\n\n此处 $\\mu_{1},\\mu_{0} \\in \\mathbb{R}$，$\\sigma  0$，且 $\\mu_{1}  \\mu_{0}$。\n\n设定与单步筛查决策一致的决策成本：假阴性（漏诊）产生的成本为 $c_{\\mathrm{FN}}0$，假阳性（不必要的随访）产生的成本为 $c_{\\mathrm{FP}}0$，而正确决策的成本为零。让我们使用受试者工作特征（ROC）曲线基础上的灵敏度和特异度的标准定义，通过 $(S,D)$ 的联合分布，将每个被筛查个体的预期成本定义为阈值 $\\tau$ 的函数。\n\n仅从错分预期成本的基本定义和上述分布假设出发，推导出使预期成本最小化的阈值 $\\tau^{\\star}$ 的闭式表达式，该表达式是 $\\mu_{0}$、$\\mu_{1}$、$\\sigma$、$c_{\\mathrm{FN}}$、$c_{\\mathrm{FP}}$ 和 $\\pi$ 的函数。请将您的最终答案表示为包含这些符号的单一简化代数表达式。不需要进行数值计算，也不允许四舍五入。最终答案必须是单一的符号数学表达式。", "solution": "我们从将二元分类性能与受试者工作特征（ROC）曲线和预期成本联系起来的定义开始。对于一个阈值 $\\tau \\in \\mathbb{R}$，该规则当且仅当 $S \\ge \\tau$ 时将样本分类为 $D=1$。假阴性概率是 $P(S  \\tau \\mid D=1)$，假阳性概率是 $P(S \\ge \\tau \\mid D=0)$。在患病率 $P(D=1)=\\pi$ 和 $P(D=0)=1-\\pi$，以及假阴性和假阳性决策成本分别为 $c_{\\mathrm{FN}}>0$ 和 $c_{\\mathrm{FP}}>0$ 的情况下，每个个体的预期成本作为 $\\tau$ 的函数为\n$$\nR(\\tau) \\;=\\; c_{\\mathrm{FN}} \\,\\pi \\,P(S  \\tau \\mid D=1) \\;+\\; c_{\\mathrm{FP}} \\,(1-\\pi)\\,P(S\\ge \\tau \\mid D=0).\n$$\n在假设的高斯模型下，将类条件累积分布函数（CDF）表示为\n$$\nF_{1}(\\tau) \\;=\\; P(S \\le \\tau \\mid D=1) \\;=\\; \\Phi\\!\\left(\\frac{\\tau-\\mu_{1}}{\\sigma}\\right), \\qquad\nF_{0}(\\tau) \\;=\\; P(S \\le \\tau \\mid D=0) \\;=\\; \\Phi\\!\\left(\\frac{\\tau-\\mu_{0}}{\\sigma}\\right),\n$$\n其中 $\\Phi$ 是标准正态累积分布函数。那么 $P(S  \\tau \\mid D=1)=F_{1}(\\tau)$，且 $P(S\\ge\\tau \\mid D=0)=1-F_{0}(\\tau)$。预期成本变为\n$$\nR(\\tau) \\;=\\; c_{\\mathrm{FN}}\\,\\pi\\,F_{1}(\\tau) \\;+\\; c_{\\mathrm{FP}}\\,(1-\\pi)\\,\\bigl(1-F_{0}(\\tau)\\bigr).\n$$\n为了最小化 $R(\\tau)$ 关于 $\\tau$ 的值，我们对 $\\tau$ 求导并将导数设为零。累积分布函数的导数是其密度函数，因此对于类条件密度\n$$\nf_{1}(\\tau) \\;=\\; \\frac{1}{\\sigma}\\,\\varphi\\!\\left(\\frac{\\tau-\\mu_{1}}{\\sigma}\\right), \\qquad\nf_{0}(\\tau) \\;=\\; \\frac{1}{\\sigma}\\,\\varphi\\!\\left(\\frac{\\tau-\\mu_{0}}{\\sigma}\\right),\n$$\n其中 $\\varphi$ 是标准正态密度函数，我们有\n$$\n\\frac{d}{d\\tau}R(\\tau) \\;=\\; c_{\\mathrm{FN}}\\,\\pi\\,f_{1}(\\tau) \\;-\\; c_{\\mathrm{FP}}\\,(1-\\pi)\\,f_{0}(\\tau).\n$$\n驻点 $\\tau^{\\star}$ 满足\n$$\nc_{\\mathrm{FN}}\\,\\pi\\,f_{1}(\\tau^{\\star}) \\;=\\; c_{\\mathrm{FP}}\\,(1-\\pi)\\,f_{0}(\\tau^{\\star}).\n$$\n整理后得到似然比条件\n$$\n\\frac{f_{1}(\\tau^{\\star})}{f_{0}(\\tau^{\\star})} \\;=\\; \\frac{c_{\\mathrm{FP}}\\,(1-\\pi)}{c_{\\mathrm{FN}}\\,\\pi}.\n$$\n因为 $f_{1}$ 和 $f_{0}$ 是方差相等的高斯密度函数，所以左侧是关于 $\\tau$ 的严格单调递增函数（因为 $\\mu_{1}\\mu_{0}$），这确保了存在一个唯一的解来最小化 $R(\\tau)$。\n\n我们现在明确地计算 $f_{1}(\\tau)/f_{0}(\\tau)$。类条件密度函数为\n$$\nf_{1}(s) \\;=\\; \\frac{1}{\\sigma\\sqrt{2\\pi}}\\exp\\!\\left(-\\frac{(s-\\mu_{1})^{2}}{2\\sigma^{2}}\\right), \\qquad\nf_{0}(s) \\;=\\; \\frac{1}{\\sigma\\sqrt{2\\pi}}\\exp\\!\\left(-\\frac{(s-\\mu_{0})^{2}}{2\\sigma^{2}}\\right).\n$$\n因此，\n$$\n\\ln\\!\\left(\\frac{f_{1}(s)}{f_{0}(s)}\\right) \\;=\\; -\\frac{(s-\\mu_{1})^{2}}{2\\sigma^{2}} + \\frac{(s-\\mu_{0})^{2}}{2\\sigma^{2}}\n\\;=\\; \\frac{(\\mu_{1}-\\mu_{0})}{\\sigma^{2}}\\,s \\;-\\; \\frac{\\mu_{1}^{2}-\\mu_{0}^{2}}{2\\sigma^{2}}.\n$$\n令 $s=\\tau^{\\star}$ 并使其等于 $\\ln\\!\\left(\\frac{c_{\\mathrm{FP}}(1-\\pi)}{c_{\\mathrm{FN}}\\pi}\\right)$，得到\n$$\n\\frac{(\\mu_{1}-\\mu_{0})}{\\sigma^{2}}\\,\\tau^{\\star} \\;-\\; \\frac{\\mu_{1}^{2}-\\mu_{0}^{2}}{2\\sigma^{2}} \\;=\\; \\ln\\!\\left(\\frac{c_{\\mathrm{FP}}(1-\\pi)}{c_{\\mathrm{FN}}\\pi}\\right).\n$$\n解出 $\\tau^{\\star}$ 得到\n$$\n\\tau^{\\star} \\;=\\; \\frac{\\sigma^{2}}{\\mu_{1}-\\mu_{0}}\\,\\ln\\!\\left(\\frac{c_{\\mathrm{FP}}(1-\\pi)}{c_{\\mathrm{FN}}\\pi}\\right) \\;+\\; \\frac{\\mu_{1}^{2}-\\mu_{0}^{2}}{2(\\mu_{1}-\\mu_{0})}.\n$$\n注意到 $\\frac{\\mu_{1}^{2}-\\mu_{0}^{2}}{2(\\mu_{1}-\\mu_{0})}=\\frac{\\mu_{1}+\\mu_{0}}{2}$，我们得到简化的闭式形式\n$$\n\\tau^{\\star} \\;=\\; \\frac{\\mu_{1}+\\mu_{0}}{2} \\;+\\; \\frac{\\sigma^{2}}{\\mu_{1}-\\mu_{0}}\\,\\ln\\!\\left(\\frac{c_{\\mathrm{FP}}(1-\\pi)}{c_{\\mathrm{FN}}\\pi}\\right).\n$$\n在给定的高斯评分模型、患病率 $\\pi$ 和错分成本下，这个 $\\tau^{\\star}$ 唯一地最小化了预期成本 $R(\\tau)$，并且在几何上对应于受试者工作特征（ROC）曲线上切线斜率等于 $\\frac{c_{\\mathrm{FP}}(1-\\pi)}{c_{\\mathrm{FN}}\\pi}$ 的点。", "answer": "$$\\boxed{\\frac{\\mu_{1}+\\mu_{0}}{2}+\\frac{\\sigma^{2}}{\\mu_{1}-\\mu_{0}}\\ln\\!\\left(\\frac{c_{\\mathrm{FP}}(1-\\pi)}{c_{\\mathrm{FN}}\\pi}\\right)}$$", "id": "4963859"}, {"introduction": "基于已知分布的理论推导是理解概念的基础，但现实世界中的分析始于原始数据。经验ROC曲线是一种非参数工具，它使我们能够直接根据观测到的分数和标签来评估测试性能，而无需假设任何特定的分布。这个实践性的编程挑战 ([@problem_id:4963863]) 将指导您实现经验ROC曲线及其关键汇总统计量（包括AUC、部分AUC和最大Youden指数）的计算。通过解决数值稳定性和评分并列等问题，您将培养出现实世界诊断测试评估所必需的稳健计算技能。", "problem": "您的任务是为医学分类场景中的诊断测试分数实现接收者操作特征（ROC）曲线及相关汇总泛函的数值稳定计算。该实现必须基于以下基本定义。\n\n1.  观测数据由数据对 $\\{(s_i, y_i)\\}_{i=1}^n$ 组成，其中 $s_i \\in \\mathbb{R}$ 是一个实值诊断分数，$y_i \\in \\{0,1\\}$ 是类别标签，表示非患病（$y_i=0$）或患病（$y_i=1$）。\n\n2.  对于任何阈值 $\\tau \\in \\mathbb{R} \\cup \\{-\\infty, +\\infty\\}$，定义一个分类器，当且仅当 $s_i \\ge \\tau$ 时预测为阳性。令 $P = \\sum_{i=1}^n \\mathbb{I}(y_i=1)$ 和 $N = \\sum_{i=1}^n \\mathbb{I}(y_i=0)$ 分别表示阳性和阴性样本的数量。在阈值 $\\tau$ 下的真阳性率（TPR，灵敏度）和假阳性率（FPR，1-特异度）为\n$$\n\\mathrm{TPR}(\\tau) = \\frac{1}{P} \\sum_{i=1}^n \\mathbb{I}(y_i=1)\\,\\mathbb{I}(s_i \\ge \\tau),\\quad\n\\mathrm{FPR}(\\tau) = \\frac{1}{N} \\sum_{i=1}^n \\mathbb{I}(y_i=0)\\,\\mathbb{I}(s_i \\ge \\tau).\n$$\nROC曲线是当 $\\tau$ 从 $+\\infty$ 变化到 $-\\infty$ 时，点集 $\\{(\\mathrm{FPR}(\\tau), \\mathrm{TPR}(\\tau))\\}$ 的轨迹。\n\n3.  曲线下面积（AUC）定义为一个随机选择的阳性分数超过一个随机选择的阴性分数的概率，平局记为半分。等价地，如果 $\\{s_i: y_i=1\\}$ 是阳性分数，$\\{s_j: y_j=0\\}$ 是阴性分数，则\n$$\n\\mathrm{AUC} = \\frac{1}{PN} \\sum_{i: y_i=1} \\sum_{j: y_j=0} \\left[ \\mathbb{I}(s_i  s_j) + \\tfrac{1}{2}\\mathbb{I}(s_i = s_j) \\right].\n$$\n\n4.  截至假阳性率上限 $\\alpha$ 的部分曲线下面积是 $\\mathrm{TPR}$ 对 $\\mathrm{FPR}$ 从 $0$到 $\\alpha$ 的积分，该积分在经验ROC曲线上使用连续ROC点之间的线段进行线性插值计算。在 $[0,\\alpha]$ 内的归一化部分AUC通过将此部分面积除以 $\\alpha$ 获得，使其值落在 $[0,1]$ 区间内：\n$$\n\\mathrm{pAUC}_\\alpha^{\\mathrm{norm}} = \\frac{1}{\\alpha} \\int_{0}^{\\alpha} \\mathrm{TPR}(x)\\,dx.\n$$\n\n5.  在阈值 $\\tau$ 处的约登指数 $J(\\tau)$ 为\n$$\nJ(\\tau) = \\mathrm{TPR}(\\tau) - \\mathrm{FPR}(\\tau).\n$$\n定义 $J^\\star = \\max_{\\tau} J(\\tau)$ 并选择一个最大化阈值 $\\tau^\\star$，该阈值是所有达到 $J^\\star$ 的阈值中最小的有限阈值。\n\n数值稳定性要求。在实际使用浮点数分数进行计算时，由于舍入误差，精确相等 $s_i = s_j$ 可能是个不适定的问题。为了稳健地处理近似平局：\n- 使用绝对容差 $\\varepsilon = 10^{-12}$ 来处理分数 $a$ 和 $b$ 的排序，如果 $|a-b| \\le \\varepsilon$，则它们被视为平局。\n- 通过将分数聚类成分组来构建阈值，其中排序后相邻分数的差值最多为 $\\varepsilon$。将每个聚类视为一个单一的分数水平，其代表性阈值是该聚类的最小元素。在阈值 $\\tau \\in \\{+\\infty\\} \\cup \\{\\text{按降序排列的聚类代表}\\} \\cup \\{-\\infty\\}$ 处评估ROC。\n- 在计算AUC时，根据相同的容差规则，对近似平局给予半分：一对 $(s_i,s_j)$ 如果 $|s_i - s_j| \\le \\varepsilon$，则对分子贡献 $\\tfrac{1}{2}$。\n\n任务。实现一个程序，对每个提供的测试用例，计算：\n- 使用近似平局规则（$\\varepsilon = 10^{-12}$）的经验 $\\mathrm{AUC}$。\n- 归一化部分面积 $\\mathrm{pAUC}_\\alpha^{\\mathrm{norm}}$，其中 $\\alpha = 0.2$，使用上述阈值集构建的ROC曲线上的线性插值。\n- 最大约登指数 $J^\\star$ 和根据上述规则选择的阈值 $\\tau^\\star$。\n\n您的程序必须为每个测试用例输出一个包含四个值的列表 $[\\mathrm{AUC}, \\mathrm{pAUC}_\\alpha^{\\mathrm{norm}}, J^\\star, \\tau^\\star]$，每个值四舍五入到六位小数。将所有测试用例的结果聚合成单行，作为一个由方括号包围的、每个案例列表组成的逗号分隔列表，例如 `[[a_1,a_2,a_3,a_4],[b_1,b_2,b_3,b_4]]`。\n\n测试套件。使用以下四个测试用例。在每个用例中，第一个列表是诊断分数 $\\{s_i\\}$，第二个是相应的标签 $\\{y_i\\}$，其中 $1$ 表示患病，$0$ 表示非患病。对于所有情况，容差为 $\\varepsilon=10^{-12}$，假阳性率上限为 $\\alpha=0.2$。\n\n- 案例1（一般混合分数）：\n  - 分数：$\\{0.90, 0.80, 0.70, 0.10, 0.40, 0.35, 0.85, 0.20, 0.50\\}$\n  - 标签：$\\{1, 1, 0, 0, 1, 0, 1, 0, 1\\}$\n\n- 案例2（跨类别的近似平局）：\n  - 分数：$\\{0.3000000000000000, 0.3000000000000004, 0.6000000000000000, 0.6000000000000003, 0.4500000000000000, 0.4500000000000002, 0.2000000000000000, 0.2000000000000001\\}$\n  - 标签：$\\{1, 0, 1, 0, 0, 1, 1, 0\\}$\n\n- 案例3（完美分离）：\n  - 分数：$\\{0.10, 0.20, 0.30, 0.80, 0.90, 0.95\\}$\n  - 标签：$\\{0, 0, 0, 1, 1, 1\\}$\n\n- 案例4（极端类别不平衡，只有一个阳性样本）：\n  - 分数：$\\{0.51, 0.10, 0.11, 0.09, 0.12, 0.10, 0.13, 0.08, 0.10\\}$\n  - 标签：$\\{1, 0, 0, 0, 0, 0, 0, 0, 0\\}$\n\n最终输出格式。您的程序应生成单行输出，包含一个由四个元素列表组成的列表，每个测试用例一个，其中每个浮点数四舍五入到六位小数，例如：\n$[[x_{11},x_{12},x_{13},x_{14}],[x_{21},x_{22},x_{23},x_{24}],[x_{31},x_{32},x_{33},x_{34}],[x_{41},x_{42},x_{43},x_{44}]]$.", "solution": "```python\nimport numpy as np\n\ndef compute_metrics(scores_list, labels_list, alpha, eps):\n    \"\"\"\n    Computes AUC, normalized pAUC, max Youden index J*, and optimal threshold tau*.\n\n    Args:\n        scores_list (list): List of diagnostic scores.\n        labels_list (list): List of corresponding binary labels (0 or 1).\n        alpha (float): False positive rate cap for partial AUC.\n        eps (float): Absolute tolerance for numerical comparisons.\n\n    Returns:\n        list: A list containing [AUC, pAUC_norm, J_star, tau_star].\n    \"\"\"\n    scores = np.array(scores_list, dtype=np.float64)\n    labels = np.array(labels_list)\n\n    pos_scores = scores[labels == 1]\n    neg_scores = scores[labels == 0]\n\n    P = len(pos_scores)\n    N = len(neg_scores)\n    \n    if P == 0 or N == 0:\n        return [0.5, 0.5, 0.0, -np.inf]\n\n    # 1. AUC Calculation using the provided near-tie rule\n    auc_numerator = 0.0\n    for s_p in pos_scores:\n        for s_n in neg_scores:\n            if s_p - s_n > eps:\n                auc_numerator += 1.0\n            elif abs(s_p - s_n) = eps:\n                auc_numerator += 0.5\n    auc = auc_numerator / (P * N)\n\n    # 2. ROC Curve construction and Youden Index calculation\n    # Identify unique thresholds based on score clustering\n    unique_scores_sorted = np.sort(np.unique(scores))\n    thresholds = []\n    if len(unique_scores_sorted) > 0:\n        thresholds.append(unique_scores_sorted[0])\n        for i in range(1, len(unique_scores_sorted)):\n            if unique_scores_sorted[i] - unique_scores_sorted[i - 1] > eps:\n                thresholds.append(unique_scores_sorted[i])\n    \n    sorted_thresholds = sorted(thresholds, reverse=True)\n    \n    roc_points = [(0.0, 0.0)]\n    j_candidates = []\n    for tau in sorted_thresholds:\n        tp = np.sum(pos_scores >= tau)\n        fp = np.sum(neg_scores >= tau)\n        tpr = tp / P\n        fpr = fp / N\n        roc_points.append((fpr, tpr))\n        \n        j = tpr - fpr\n        j_candidates.append({'j': j, 'tau': tau})\n    \n    # Find J* and tau*\n    j_star = -2.0\n    tau_star = np.inf\n    if j_candidates:\n        j_star = max(c['j'] for c in j_candidates)\n        candidate_taus = [c['tau'] for c in j_candidates if abs(c['j'] - j_star)  1e-9]\n        tau_star = min(candidate_taus)\n    else: \n        j_star = 0.0\n        tau_star = -np.inf\n\n    # 3. Partial AUC Calculation\n    roc_points.append((1.0, 1.0))\n    # Get unique, sorted points for trapezoidal integration\n    unique_roc_points = sorted(list(set(roc_points)))\n\n    pauc_area = 0.0\n    for i in range(1, len(unique_roc_points)):\n        x1, y1 = unique_roc_points[i - 1]\n        x2, y2 = unique_roc_points[i]\n\n        if x1 >= alpha:\n            break\n        \n        if x2 > x1:\n            if x2 = alpha:\n                pauc_area += (x2 - x1) * (y1 + y2) / 2.0\n            else:\n                y_at_alpha = y1 + (y2 - y1) * (alpha - x1) / (x2 - x1)\n                pauc_area += (alpha - x1) * (y1 + y_at_alpha) / 2.0\n                break\n    \n    pauc_norm = pauc_area / alpha\n\n    return [auc, pauc_norm, j_star, tau_star]\n\ndef solve():\n    test_cases = [\n        ([0.90, 0.80, 0.70, 0.10, 0.40, 0.35, 0.85, 0.20, 0.50],\n         [1, 1, 0, 0, 1, 0, 1, 0, 1]),\n        ([0.3000000000000000, 0.3000000000000004, 0.6000000000000000, \n          0.6000000000000003, 0.4500000000000000, 0.4500000000000002, \n          0.2000000000000000, 0.2000000000000001],\n         [1, 0, 1, 0, 0, 1, 1, 0]),\n        ([0.10, 0.20, 0.30, 0.80, 0.90, 0.95],\n         [0, 0, 0, 1, 1, 1]),\n        ([0.51, 0.10, 0.11, 0.09, 0.12, 0.10, 0.13, 0.08, 0.10],\n         [1, 0, 0, 0, 0, 0, 0, 0, 0]),\n    ]\n    alpha = 0.2\n    eps = 1e-12\n    results = []\n    for scores, labels in test_cases:\n        result = compute_metrics(scores, labels, alpha, eps)\n        results.append(result)\n\n    formatted_results = []\n    for res in results:\n        s_res = (f\"[{res[0]:.6f},{res[1]:.6f},\"\n                 f\"{res[2]:.6f},{res[3]:.6f}]\")\n        formatted_results.append(s_res)\n\n    return f\"[{','.join(formatted_results)}]\"\n\n# The final answer is generated by calling solve()\n# print(solve())\n```", "answer": "[[0.850000,1.000000,0.750000,0.700000],[0.593750,0.625000,0.250000,0.300000],[1.000000,1.000000,1.000000,0.800000],[1.000000,1.000000,1.000000,0.510000]]", "id": "4963863"}]}