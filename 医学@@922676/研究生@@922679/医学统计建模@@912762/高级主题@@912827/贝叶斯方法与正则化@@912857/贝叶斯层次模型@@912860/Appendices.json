{"hands_on_practices": [{"introduction": "分层模型的核心优势之一是在不同组之间“借力”，特别是当某些组的数据量较少时，这种优势尤为明显。这一现象被称为“收缩”或“部分池化”，是贝叶斯方法强大之处的体现。本练习将通过一个经典的多中心临床试验场景，让你亲手推导后验均值中的收缩因子，从而精确地理解模型如何将单个医院的经验率向总体平均值拉近，以达到平衡个体数据与池化信息的目的。[@problem_id:4800178]", "problem": "考虑一个多中心外科手术队列，其中 $J$ 家医院独立报告术后并发症的计数。对于医院 $j \\in \\{1,\\dots,J\\}$，设 $y_j$ 表示在 $n_j$ 名接受手术的患者中出现并发症的患者数量，其模型为 $y_j \\sim \\text{Binomial}(n_j,\\theta_j)$，其中 $0  \\theta_j  1$ 是医院特定的并发症概率。假设一个可交换的层次贝叶斯模型，其先验为 $\\theta_j \\mid \\alpha,\\beta \\sim \\text{Beta}(\\alpha,\\beta)$，其中 $(\\alpha,\\beta)$ 具有合适的超先验，这些超先验编码了关于跨医院并发症概况的不确定性。设可交换先验下的汇集均值为 $\\mu_0 = \\alpha/(\\alpha+\\beta)$，经验医院并发症率为 $\\hat{p}_j = y_j/n_j$。\n\n将 $\\theta_j$ 的后验均值向汇集均值的收缩定义为唯一的标量 $\\kappa_j \\in (0,1)$，使得在给定 $(y_j,\\alpha,\\beta)$ 的情况下 $\\theta_j$ 的后验均值可以写成凸组合 $E[\\theta_j \\mid y_j,\\alpha,\\beta] = \\kappa_j \\mu_0 + (1-\\kappa_j) \\hat{p}_j$。从贝叶斯定理和带有 Beta 先验的二项似然出发，推导 $\\kappa_j$ 作为 $n_j$、$\\alpha$ 和 $\\beta$ 的函数的封闭形式表达式。将您的最终答案表示为单个解析表达式。不需要进行数值四舍五入。", "solution": "用户希望我根据提供的问题陈述来解决一个问题。\n\n### 步骤 1：提取已知条件\n-   **模型：** 对于医院 $j \\in \\{1, \\dots, J\\}$，在 $n_j$ 名患者中出现并发症的数量 $y_j$ 被建模为 $y_j \\sim \\text{Binomial}(n_j, \\theta_j)$。\n-   **感兴趣的参数：** $\\theta_j$，医院特定的并发症概率，其中 $0  \\theta_j  1$。\n-   **先验：** 参数 $\\theta_j$ 被赋予一个来自 Beta 分布的可交换先验：$\\theta_j \\mid \\alpha, \\beta \\sim \\text{Beta}(\\alpha, \\beta)$。超参数 $(\\alpha, \\beta)$ 有其自身的合适超先验。\n-   **定义：**\n    -   汇集均值（先验均值）：$\\mu_0 = \\frac{\\alpha}{\\alpha+\\beta}$。\n    -   经验医院并发症率：$\\hat{p}_j = \\frac{y_j}{n_j}$。\n-   **目标表达式：** 给定数据 $y_j$ 和超参数 $\\alpha, \\beta$ 时 $\\theta_j$ 的后验均值表示为一个凸组合：$E[\\theta_j \\mid y_j, \\alpha, \\beta] = \\kappa_j \\mu_0 + (1-\\kappa_j) \\hat{p}_j$。\n-   **目标：** 推导收缩因子 $\\kappa_j \\in (0,1)$ 作为 $n_j$、$\\alpha$ 和 $\\beta$ 的函数的封闭形式表达式。\n\n### 步骤 2：使用提取的已知条件进行验证\n问题陈述在科学上和数学上都是合理的。它描述了一个标准且广泛使用的层次贝叶斯模型，特别是 Beta-二项模型，这是使用共轭先验进行贝叶斯推断的经典例子。\n-   **科学依据：** 该模型是医学和公共卫生等领域统计分析的基石，用于对不同群体的比率和比例进行建模。没有违反任何科学原则。\n-   **良构性：** 为二项比例使用 Beta 先验是一个共轭配对，这保证了后验分布（也是一个 Beta 分布）具有封闭形式。这确保了后验均值是良定义的，并且可以解析计算，从而得到 $\\kappa_j$ 的唯一解。\n-   **目标：** 语言是精确的，所有术语都在概率论和贝叶斯统计的背景下被正式定义。\n-   **完整性：** 问题提供了进行推导所需的所有必要信息（似然、先验、定义）。\n\n### 步骤 3：结论与行动\n问题是有效的。我将继续进行推导。\n\n为了找到收缩因子 $\\kappa_j$ 的表达式，我们必须首先使用贝叶斯定理从第一性原理推导出后验均值 $E[\\theta_j \\mid y_j, \\alpha, \\beta]$，然后将其与给定的凸组合形式相等。\n\n推导过程分为三个主要步骤：\n1.  确定 $\\theta_j$ 的后验分布。\n2.  计算该后验分布的均值。\n3.  重新整理后验均值的表达式以匹配指定的结构并识别出 $\\kappa_j$。\n\n**1. $\\theta_j$ 的后验分布**\n\n根据贝叶斯定理，$\\theta_j$ 的后验概率密度函数 (PDF) 正比于似然函数与先验 PDF 的乘积。\n$p(\\theta_j \\mid y_j, \\alpha, \\beta) \\propto p(y_j \\mid \\theta_j, n_j) \\cdot p(\\theta_j \\mid \\alpha, \\beta)$\n\n似然函数，来自二项模型 $y_j \\sim \\text{Binomial}(n_j, \\theta_j)$，为：\n$p(y_j \\mid \\theta_j, n_j) = \\binom{n_j}{y_j} \\theta_j^{y_j} (1 - \\theta_j)^{n_j - y_j}$\n为了推导后验核，我们可以省略常数二项式系数 $\\binom{n_j}{y_j}$：\n$L(\\theta_j \\mid y_j) \\propto \\theta_j^{y_j} (1 - \\theta_j)^{n_j - y_j}$\n\n$\\theta_j$ 的先验分布是 $\\text{Beta}(\\alpha, \\beta)$，其 PDF 为：\n$p(\\theta_j \\mid \\alpha, \\beta) = \\frac{\\Gamma(\\alpha+\\beta)}{\\Gamma(\\alpha)\\Gamma(\\beta)} \\theta_j^{\\alpha-1} (1 - \\theta_j)^{\\beta-1}$\n先验的核是：\n$p(\\theta_j \\mid \\alpha, \\beta) \\propto \\theta_j^{\\alpha-1} (1 - \\theta_j)^{\\beta-1}$\n\n现在，我们将似然的核与先验的核相乘：\n$p(\\theta_j \\mid y_j, \\alpha, \\beta) \\propto \\left( \\theta_j^{y_j} (1 - \\theta_j)^{n_j - y_j} \\right) \\cdot \\left( \\theta_j^{\\alpha-1} (1 - \\theta_j)^{\\beta-1} \\right)$\n合并具有相同底数的项：\n$p(\\theta_j \\mid y_j, \\alpha, \\beta) \\propto \\theta_j^{y_j + \\alpha - 1} (1 - \\theta_j)^{n_j - y_j + \\beta - 1}$\n\n这个结果核可以被识别为 Beta 分布的核。因此，$\\theta_j$ 的后验分布是：\n$\\theta_j \\mid y_j, \\alpha, \\beta \\sim \\text{Beta}(\\alpha', \\beta')$\n后验参数为：\n$\\alpha' = y_j + \\alpha$\n$\\beta' = n_j - y_j + \\beta$\n\n**2. 后验均值 $E[\\theta_j \\mid y_j, \\alpha, \\beta]$**\n\n服从 Beta 分布 $\\text{Beta}(a, b)$ 的随机变量的期望值为 $\\frac{a}{a+b}$。\n使用后验参数 $\\alpha'$ 和 $\\beta'$，$\\theta_j$ 的后验均值为：\n$E[\\theta_j \\mid y_j, \\alpha, \\beta] = \\frac{\\alpha'}{\\alpha' + \\beta'} = \\frac{y_j + \\alpha}{(y_j + \\alpha) + (n_j - y_j + \\beta)}$\n简化分母：\n$E[\\theta_j \\mid y_j, \\alpha, \\beta] = \\frac{y_j + \\alpha}{n_j + \\alpha + \\beta}$\n\n**3. 收缩因子 $\\kappa_j$ 的推导**\n\n最后一步是将这个推导出的后验均值表达式与问题陈述中给出的形式相等，并求解 $\\kappa_j$。问题陈述为：\n$E[\\theta_j \\mid y_j, \\alpha, \\beta] = \\kappa_j \\mu_0 + (1-\\kappa_j) \\hat{p}_j$\n\n我们将重写我们推导出的后验均值以匹配此结构。项 $\\alpha + \\beta$ 可以解释为“先验样本量”或先验信息的强度。后验均值是经验率和先验均值的加权平均。让我们明确这一点。\n$E[\\theta_j \\mid y_j, \\alpha, \\beta] = \\frac{y_j + \\alpha}{n_j + \\alpha + \\beta}$\n\n我们可以通过将 $y_j$ 与 $\\hat{p}_j = \\frac{y_j}{n_j}$ 联系起来，以及将 $\\alpha$ 与 $\\mu_0 = \\frac{\\alpha}{\\alpha+\\beta}$ 联系起来，来重写分子：\n$E[\\theta_j \\mid y_j, \\alpha, \\beta] = \\frac{n_j (\\frac{y_j}{n_j}) + \\alpha}{n_j + \\alpha + \\beta} = \\frac{n_j \\hat{p}_j + \\alpha}{n_j + \\alpha + \\beta}$\n\n为了将其表示为 $\\hat{p}_j$ 和 $\\mu_0$ 的凸组合，我们可以将表达式重写如下：\n$E[\\theta_j \\mid y_j, \\alpha, \\beta] = \\left( \\frac{n_j}{n_j + \\alpha + \\beta} \\right) \\hat{p}_j + \\frac{\\alpha}{n_j + \\alpha + \\beta}$\n现在，我们处理第二项以引入 $\\mu_0 = \\frac{\\alpha}{\\alpha+\\beta}$：\n$\\frac{\\alpha}{n_j + \\alpha + \\beta} = \\left( \\frac{\\alpha+\\beta}{n_j + \\alpha + \\beta} \\right) \\frac{\\alpha}{\\alpha+\\beta} = \\left( \\frac{\\alpha+\\beta}{n_j + \\alpha + \\beta} \\right) \\mu_0$\n\n将其代回，我们得到以后验均值表示为 $\\hat{p}_j$ 和 $\\mu_0$ 的加权平均：\n$E[\\theta_j \\mid y_j, \\alpha, \\beta] = \\left( \\frac{n_j}{n_j + \\alpha + \\beta} \\right) \\hat{p}_j + \\left( \\frac{\\alpha + \\beta}{n_j + \\alpha + \\beta} \\right) \\mu_0$\n\n我们现在将此表达式与问题中给出的形式进行比较：\n$E[\\theta_j \\mid y_j, \\alpha, \\beta] = (1 - \\kappa_j) \\hat{p}_j + \\kappa_j \\mu_0$\n\n通过使 $\\mu_0$ 的系数相等，我们直接确定了收缩因子 $\\kappa_j$：\n$\\kappa_j = \\frac{\\alpha + \\beta}{n_j + \\alpha + \\beta}$\n\n为了严谨起见，我们验证这与 $\\hat{p}_j$ 的系数是一致的：\n$1 - \\kappa_j = 1 - \\frac{\\alpha + \\beta}{n_j + \\alpha + \\beta} = \\frac{(n_j + \\alpha + \\beta) - (\\alpha + \\beta)}{n_j + \\alpha + \\beta} = \\frac{n_j}{n_j + \\alpha + \\beta}$\n这与我们推导出的 $\\hat{p}_j$ 的系数相匹配。因此，$\\kappa_j$ 的表达式是正确的。\n\n这个因子 $\\kappa_j$ 代表赋予先验均值 $\\mu_0$ 的权重。它是“先验强度”（$\\alpha + \\beta$）与总有效样本量之比，总有效样本量是数据样本量（$n_j$）和先验强度之和。随着 $n_j$ 的增加，$\\kappa_j$ 趋近于 0，估计值更重地依赖于数据 $\\hat{p}_j$。相反，对于较小的 $n_j$，$\\kappa_j$ 较大，估计值更强烈地向汇集均值 $\\mu_0$“收缩”。", "answer": "$$\n\\boxed{\\frac{\\alpha + \\beta}{n_j + \\alpha + \\beta}}\n$$", "id": "4800178"}, {"introduction": "在我们理解了信息应当被池化之后，一个自然而然的问题是：池化的程度应该有多大？这个问题的答案取决于组内观测值的相似程度以及组间的差异大小。组内相关系数（Intraclass Correlation Coefficient, ICC）是量化这种聚类效应的关键指标。本练习要求你从一个随机截距模型中推导出ICC的表达式，从而揭示其如何由组间和组内方差分量构成，并阐明其在多中心临床研究背景下的重要解释。[@problem_id:4953506]", "problem": "考虑一项关于连续性生物标志物的多中心临床研究，其中患者嵌套于各个中心（例如医院）内。假设中心 $j$ 中患者 $i$ 的响应通过贝叶斯分层随机截距模型进行建模\n$$\ny_{ij} \\,=\\, \\mu \\,+\\, u_{j} \\,+\\, \\epsilon_{ij},\n$$\n其中包含中心特有的随机截距 $u_{j} \\sim \\mathcal{N}(0,\\tau^{2})$ 和患者层面的误差 $\\epsilon_{ij} \\sim \\mathcal{N}(0,\\sigma^{2})$。假设 $u_{j}$ 和 $\\epsilon_{ij}$ 对于所有指标都是相互独立的，并且独立于 $\\mu$（为计算方差的目的，$\\mu$ 被视为常数）。仅使用方差、协方差和相关性的基本定义，推导定义为如下的组内相关系数 (intraclass correlation coefficient (ICC))\n$$\n\\operatorname{Corr}\\!\\big(y_{ij},\\,y_{i' j}\\big)\n$$\n对于同一中心 $j$ 内的 $i \\neq i'$，该相关性是在对 $u_{j}$ 积分得到的边际分布下计算的。然后，从临床角度简要解释ICC，重点说明在此医学背景下，它如何量化中心内部的相似性和中心之间的异质性。请用关于 $\\tau^{2}$ 和 $\\sigma^{2}$ 的简化符号表达式表示您的最终答案。无需四舍五入。", "solution": "问题陈述经评估为有效。这是一个提法恰当、有科学依据的统计建模问题，提供了所有必要信息，且无内部矛盾。它要求从一个明确定义的分层模型中推导一个标准统计量，即组内相关系数 (ICC)。\n\n该问题要求推导组内相关系数 (ICC)，其定义为同一中心 $j$ 内两个不同患者（$i \\neq i'$）之间的 $\\operatorname{Corr}(y_{ij}, y_{i'j})$。响应变量 $y_{ij}$ 的模型由下式给出：\n$$\ny_{ij} = \\mu + u_j + \\epsilon_{ij}\n$$\n其中 $\\mu$ 是一个恒定的总体均值，$u_j$ 是中心 $j$ 的随机截距，$\\epsilon_{ij}$ 是中心 $j$ 中患者 $i$ 的随机误差。\n\n分布假设如下：\n1.  中心特有的随机截距：$u_j \\sim \\mathcal{N}(0, \\tau^2)$，这意味着 $\\operatorname{E}[u_j] = 0$ 且 $\\operatorname{Var}(u_j) = \\tau^2$。\n2.  患者层面的误差：$\\epsilon_{ij} \\sim \\mathcal{N}(0, \\sigma^2)$，这意味着 $\\operatorname{E}[\\epsilon_{ij}] = 0$ 且 $\\operatorname{Var}(\\epsilon_{ij}) = \\sigma^2$。\n3.  随机变量 $u_j$ 和 $\\epsilon_{ij}$ 对所有指标都是相互独立的。这意味着对于任何 $i, i', j, j'$，都有 $\\operatorname{Cov}(u_j, \\epsilon_{i'j'}) = 0$。这也意味着对于 $i \\neq i'$，有 $\\operatorname{Cov}(\\epsilon_{ij}, \\epsilon_{i'j}) = 0$。\n\n两个随机变量 $X$ 和 $Y$ 之间的相关性定义为：\n$$\n\\operatorname{Corr}(X, Y) = \\frac{\\operatorname{Cov}(X, Y)}{\\sqrt{\\operatorname{Var}(X) \\operatorname{Var}(Y)}}\n$$\n在本问题中，我们关心的是 $\\operatorname{Corr}(y_{ij}, y_{i'j})$。我们必须首先计算单个观测值的方差 $\\operatorname{Var}(y_{ij})$，以及来自同一中心的两个观测值之间的协方差 $\\operatorname{Cov}(y_{ij}, y_{i'j})$。\n\n首先，我们计算 $y_{ij}$ 的方差。由于 $\\mu$ 被视为常数，其方差为零。\n$$\n\\operatorname{Var}(y_{ij}) = \\operatorname{Var}(\\mu + u_j + \\epsilon_{ij}) = \\operatorname{Var}(u_j + \\epsilon_{ij})\n$$\n利用独立随机变量之和的方差等于各方差之和的性质：\n$$\n\\operatorname{Var}(y_{ij}) = \\operatorname{Var}(u_j) + \\operatorname{Var}(\\epsilon_{ij})\n$$\n代入给定的方差：\n$$\n\\operatorname{Var}(y_{ij}) = \\tau^2 + \\sigma^2\n$$\n根据同样的逻辑，观测值 $y_{i'j}$ 的方差是相同的，因为 $u_j$ 和 $\\epsilon_{i'j}$ 的基础分布是相同的：\n$$\n\\operatorname{Var}(y_{i'j}) = \\tau^2 + \\sigma^2\n$$\n\n接下来，我们计算 $i \\neq i'$ 时 $y_{ij}$ 和 $y_{i'j}$ 之间的协方差。\n$$\n\\operatorname{Cov}(y_{ij}, y_{i'j}) = \\operatorname{Cov}(\\mu + u_j + \\epsilon_{ij}, \\mu + u_j + \\epsilon_{i'j})\n$$\n利用协方差的性质，特别是其双线性和常数对协方差没有贡献的特性：\n$$\n\\operatorname{Cov}(y_{ij}, y_{i'j}) = \\operatorname{Cov}(u_j + \\epsilon_{ij}, u_j + \\epsilon_{i'j})\n$$\n展开此表达式：\n$$\n\\operatorname{Cov}(y_{ij}, y_{i'j}) = \\operatorname{Cov}(u_j, u_j) + \\operatorname{Cov}(u_j, \\epsilon_{i'j}) + \\operatorname{Cov}(\\epsilon_{ij}, u_j) + \\operatorname{Cov}(\\epsilon_{ij}, \\epsilon_{i'j})\n$$\n我们根据问题的假设来评估每一项：\n1.  $\\operatorname{Cov}(u_j, u_j) = \\operatorname{Var}(u_j) = \\tau^2$。\n2.  $\\operatorname{Cov}(u_j, \\epsilon_{i'j}) = 0$，因为 $u_j$ 和 $\\epsilon_{i'j}$ 是独立的。\n3.  $\\operatorname{Cov}(\\epsilon_{ij}, u_j) = 0$，原因同上。\n4.  $\\operatorname{Cov}(\\epsilon_{ij}, \\epsilon_{i'j}) = 0$，因为对于不同患者（$i \\neq i'$），患者层面的误差是独立的。\n\n将这些项相加，得到协方差：\n$$\n\\operatorname{Cov}(y_{ij}, y_{i'j}) = \\tau^2 + 0 + 0 + 0 = \\tau^2\n$$\n同一中心内两个不同患者结果之间的协方差等于中心间方差 $\\tau^2$。这是因为共享的随机效应 $u_j$ 是他们结果之间统计依赖性的唯一来源。\n\n现在我们可以使用推导出的方差和协方差来组合得到 ICC：\n$$\n\\operatorname{ICC} = \\operatorname{Corr}(y_{ij}, y_{i'j}) = \\frac{\\operatorname{Cov}(y_{ij}, y_{i'j})}{\\sqrt{\\operatorname{Var}(y_{ij}) \\operatorname{Var}(y_{i'j})}}\n$$\n$$\n\\operatorname{ICC} = \\frac{\\tau^2}{\\sqrt{(\\tau^2 + \\sigma^2)(\\tau^2 + \\sigma^2)}} = \\frac{\\tau^2}{\\tau^2 + \\sigma^2}\n$$\n\n在此临床背景下，ICC 的解释直接从其公式得出。生物标志物测量值的总方差 $\\operatorname{Var}(y_{ij}) = \\tau^2 + \\sigma^2$ 被分解为两个部分：\n- $\\tau^2$：中心特有效应的方差，代表中心*之间*的异质性。\n- $\\sigma^2$：患者特有误差的方差，代表中心*内部*的异质性。\n\n因此，ICC $\\frac{\\tau^2}{\\tau^2 + \\sigma^2}$ 是生物标志物总方差中可归因于临床中心之间系统性差异的比例。\n- **高 ICC**（接近 1）表示 $\\tau^2$ 相对于 $\\sigma^2$ 较大。这意味着同一中心内的患者彼此高度相似，而中心之间存在巨大的系统性差异。从临床角度看，医院的选择显著影响患者的生物标志物水平。这可能是由于测量方案、当地环境因素或每个中心服务的特定亚群的差异造成的。\n- **低 ICC**（接近 0）表示 $\\tau^2$ 相对于 $\\sigma^2$ 较小。这意味着大部分变异是由患者个体差异引起的，而不是他们所属的中心。一个中心内患者的结果相关性不强，且中心本身相对同质。特定的医院对生物标志物结果影响甚微。\n总之，ICC 量化了同一中心内观测值的聚集程度或非独立性，提供了一个衡量中心间异质性对临床研究中总观测变异贡献大小的指标。", "answer": "$$\n\\boxed{\\frac{\\tau^{2}}{\\tau^{2} + \\sigma^{2}}}\n$$", "id": "4953506"}, {"introduction": "理论理解和模型解释固然重要，但要将模型应用于实际数据分析，则离不开强大的计算工具。吉布斯采样（Gibbs sampling）是拟合复杂贝叶斯模型的关键马尔可夫链蒙特卡洛（MCMC）方法之一。本练习将指导你为一个完整的分层模型推导所有参数的全条件分布（full conditional distributions），这是构建和理解贝叶斯计算软件背后工作原理的基石，也是进行高级贝叶斯建模的必备技能。[@problem_id:4953489]", "problem": "一项多中心临床研究评估了一种新的抗高血压疗法在 $J$ 家医院中对收缩压变化的影响。在医院 $j$ 中，患者 $i$ 的变化被建模为 $y_{ij}$，其中 $i = 1, \\dots, n_{j}$ 且 $j = 1, \\dots, J$。假设使用以下贝叶斯分层模型：\n- 观测模型：$y_{ij} \\mid \\theta_{j}, \\sigma^{2} \\sim \\mathcal{N}(\\theta_{j}, \\sigma^{2})$，在给定 $\\theta_{j}$ 和 $\\sigma^{2}$ 的条件下独立。\n- 医院水平效应：$\\theta_{j} \\mid \\mu, \\tau^{2} \\sim \\mathcal{N}(\\mu, \\tau^{2})$，在给定 $\\mu$ 和 $\\tau^{2}$ 的条件下独立。\n- 全局均值和异质性先验：$(\\mu, \\tau^{2})$ 服从正态-逆伽马（N-InvGamma）先验，定义为 $\\mu \\mid \\tau^{2} \\sim \\mathcal{N}(m_{0}, \\tau^{2}/k_{0})$ 和 $\\tau^{2} \\sim \\text{InvGamma}(a_{0}, b_{0})$。\n- 医院内方差先验：$\\sigma^{2} \\sim \\text{InvGamma}(a_{\\sigma}, b_{\\sigma})$，与 $(\\mu, \\tau^{2})$ 独立。\n\n此处使用的逆伽马分布参数化是形状-尺度形式，其密度为 $p(x \\mid a, b) \\propto x^{-(a+1)} \\exp(-b/x)$，其中 $x  0$，形状 $a  0$，尺度 $b  0$。\n\n令 $\\bar{y}_{j} = \\frac{1}{n_{j}} \\sum_{i=1}^{n_{j}} y_{ij}$ 为医院 $j$ 的样本均值，令 $N = \\sum_{j=1}^{J} n_{j}$ 为总样本量。从 Bayes 法则以及正态似然与正态和逆伽马先验的共轭性出发，推导 Gibbs 采样器所需的完全条件分布：\n1. 对每个 $j$，$p(\\theta_{j} \\mid \\mathbf{y}, \\mu, \\tau^{2}, \\sigma^{2})$，\n2. $p(\\mu \\mid \\boldsymbol{\\theta}, \\tau^{2})$，\n3. $p(\\tau^{2} \\mid \\boldsymbol{\\theta}, \\mu)$，\n4. $p(\\sigma^{2} \\mid \\mathbf{y}, \\boldsymbol{\\theta})$。\n\n将每个条件分布表示为显式参数形式，其中条件正态分布由其均值和方差表征，逆伽马分布由其形状和尺度表征。你的最终答案必须是一个单一的复合解析表达式，使用 $\\texttt{pmatrix}$ 环境将这四个条件分布列在同一行中。不要代入数值。无需四舍五入。", "solution": "问题陈述提供了一个完整且定义明确的贝叶斯分层模型，并要求推导 Gibbs 采样器所需的完全条件分布。该模型在统计上是合理的，在生物统计学应用中很常见。所有必要的组成部分（似然、先验及其参数化）都已指定，使得问题有效且自洽。没有科学缺陷、歧义或矛盾。我现在将着手推导指定的四个完全条件分布。\n\n在 Gibbs 采样器中寻找参数的完全条件分布的一般原则是使用 Bayes 定理。参数的完全条件分布与所有数据和参数的完全联合概率分布成正比。我们可以将其写作 $p(\\text{parameter} \\mid \\text{rest}) \\propto p(\\text{all data and all parameters})$。在此表达式中，“rest”表示所有其他参数和数据。我们只需要考虑完全联合分布中作为目标参数的函数的项。\n\n完全联合概率分布由下式给出：\n$$p(\\mathbf{y}, \\boldsymbol{\\theta}, \\mu, \\tau^{2}, \\sigma^{2}) = p(\\mathbf{y} \\mid \\boldsymbol{\\theta}, \\sigma^{2}) \\, p(\\boldsymbol{\\theta} \\mid \\mu, \\tau^{2}) \\, p(\\mu \\mid \\tau^{2}) \\, p(\\tau^{2}) \\, p(\\sigma^{2})$$\n其中 $\\mathbf{y} = \\{y_{ij}\\}$ 且 $\\boldsymbol{\\theta} = \\{\\theta_j\\}$。各个组成部分已在问题陈述中指定。\n\n1.  **$\\theta_{j}$ 的条件分布**\n    $\\theta_{j}$ 的完全条件分布是 $p(\\theta_{j} \\mid \\mathbf{y}, \\boldsymbol{\\theta}_{-j}, \\mu, \\tau^{2}, \\sigma^{2})$，其中 $\\boldsymbol{\\theta}_{-j}$ 表示所有 $k \\neq j$ 的 $\\theta_k$。由于条件独立性，$\\theta_j$ 仅依赖于其自身组的数据 $\\mathbf{y}_j = \\{y_{ij}\\}_{i=1}^{n_j}$ 及其先验参数 $\\mu$ 和 $\\tau^2$。\n    $$p(\\theta_{j} \\mid \\mathbf{y}_{j}, \\mu, \\tau^{2}, \\sigma^{2}) \\propto p(\\mathbf{y}_{j} \\mid \\theta_{j}, \\sigma^{2}) \\, p(\\theta_{j} \\mid \\mu, \\tau^{2})$$\n    似然项是 $p(\\mathbf{y}_{j} \\mid \\theta_{j}, \\sigma^{2}) = \\prod_{i=1}^{n_{j}} \\mathcal{N}(y_{ij} \\mid \\theta_{j}, \\sigma^{2})$。这等价于样本均值 $\\bar{y}_{j} = \\frac{1}{n_{j}} \\sum_{i=1}^{n_{j}} y_{ij}$ 的似然，即 $\\bar{y}_j \\mid \\theta_j, \\sigma^2 \\sim \\mathcal{N}(\\theta_j, \\sigma^2/n_j)$。因此，似然正比于 $\\exp\\left(-\\frac{n_j}{2\\sigma^2}(\\bar{y}_j - \\theta_j)^2\\right)$。\n    先验是 $p(\\theta_{j} \\mid \\mu, \\tau^{2}) = \\mathcal{N}(\\theta_{j} \\mid \\mu, \\tau^{2})$，正比于 $\\exp\\left(-\\frac{1}{2\\tau^2}(\\theta_j - \\mu)^2\\right)$。\n    $\\theta_j$ 的后验分布正比于两者的乘积：\n    $$p(\\theta_j \\mid \\dots) \\propto \\exp\\left(-\\frac{n_j}{2\\sigma^2}(\\theta_j - \\bar{y}_j)^2 - \\frac{1}{2\\tau^2}(\\theta_j - \\mu)^2\\right)$$\n    指数是关于 $\\theta_j$ 的二次型，这表明后验分布是正态分布。我们通过配方法或使用正态模型的标准共轭结果来确定其均值和方差。后验精度（方差的倒数）是似然精度和先验精度的和：\n    $$V_{\\theta_j}^{-1} = \\frac{n_j}{\\sigma^2} + \\frac{1}{\\tau^2} = \\frac{n_j \\tau^2 + \\sigma^2}{\\sigma^2 \\tau^2} \\implies V_{\\theta_j} = \\frac{\\sigma^2 \\tau^2}{n_j \\tau^2 + \\sigma^2}$$\n    后验均值是数据均值和先验均值的精度加权平均：\n    $$\\mu_{\\theta_j} = V_{\\theta_j} \\left(\\frac{n_j \\bar{y}_j}{\\sigma^2} + \\frac{\\mu}{\\tau^2}\\right) = \\frac{\\sigma^2 \\tau^2}{n_j \\tau^2 + \\sigma^2} \\left(\\frac{n_j \\bar{y}_j \\tau^2 + \\mu \\sigma^2}{\\sigma^2 \\tau^2}\\right) = \\frac{n_j \\bar{y}_j \\tau^2 + \\mu \\sigma^2}{n_j \\tau^2 + \\sigma^2}$$\n    因此，条件分布是 $\\theta_j \\mid \\dots \\sim \\mathcal{N}(\\mu_{\\theta_j}, V_{\\theta_j})$。\n\n2.  **$\\mu$ 的条件分布**\n    $\\mu$ 的完全条件分布是 $p(\\mu \\mid \\mathbf{y}, \\boldsymbol{\\theta}, \\tau^{2}, \\sigma^{2})$。根据模型结构，这可以简化为 $p(\\mu \\mid \\boldsymbol{\\theta}, \\tau^{2})$。我们考虑联合分布中所有包含 $\\mu$ 的项：\n    $$p(\\mu \\mid \\boldsymbol{\\theta}, \\tau^{2}) \\propto p(\\boldsymbol{\\theta} \\mid \\mu, \\tau^{2}) \\, p(\\mu \\mid \\tau^{2})$$\n    $\\mu$ 的“似然”来自 $p(\\boldsymbol{\\theta} \\mid \\mu, \\tau^{2}) = \\prod_{j=1}^{J} \\mathcal{N}(\\theta_j \\mid \\mu, \\tau^{2})$，它正比于 $\\exp\\left(-\\frac{1}{2\\tau^2} \\sum_{j=1}^J (\\theta_j - \\mu)^2\\right)$。\n    先验是 $p(\\mu \\mid \\tau^{2}) = \\mathcal{N}(\\mu \\mid m_{0}, \\tau^{2}/k_{0})$，正比于 $\\exp\\left(-\\frac{k_0}{2\\tau^2}(\\mu - m_0)^2\\right)$。\n    这是另一个正态-正态模型。后验精度为：\n    $$V_{\\mu}^{-1} = \\frac{J}{\\tau^2} + \\frac{k_0}{\\tau^2} = \\frac{J+k_0}{\\tau^2} \\implies V_{\\mu} = \\frac{\\tau^2}{J+k_0}$$\n    后验均值为：\n    $$\\mu_{\\mu} = V_{\\mu} \\left(\\frac{\\sum_{j=1}^J \\theta_j}{\\tau^2} + \\frac{k_0 m_0}{\\tau^2}\\right) = \\frac{\\tau^2}{J+k_0} \\left(\\frac{\\sum_{j=1}^J \\theta_j + k_0 m_0}{\\tau^2}\\right) = \\frac{\\sum_{j=1}^J \\theta_j + k_0 m_0}{J+k_0}$$\n    因此，条件分布是 $\\mu \\mid \\dots \\sim \\mathcal{N}(\\mu_{\\mu}, V_{\\mu})$。\n\n3.  **$\\tau^{2}$ 的条件分布**\n    $\\tau^{2}$ 的完全条件分布是 $p(\\tau^{2} \\mid \\mathbf{y}, \\boldsymbol{\\theta}, \\mu, \\sigma^{2})$，可简化为 $p(\\tau^{2} \\mid \\boldsymbol{\\theta}, \\mu)$。从完全联合分布中，我们收集所有涉及 $\\tau^2$ 的因子：\n    $$p(\\tau^{2} \\mid \\boldsymbol{\\theta}, \\mu) \\propto p(\\boldsymbol{\\theta} \\mid \\mu, \\tau^{2}) \\, p(\\mu \\mid \\tau^{2}) \\, p(\\tau^{2})$$\n    这些密度的形式是：\n    $p(\\boldsymbol{\\theta} \\mid \\mu, \\tau^{2}) \\propto (\\tau^2)^{-J/2} \\exp\\left(-\\frac{1}{2\\tau^2}\\sum_{j=1}^J (\\theta_j - \\mu)^2\\right)$\n    $p(\\mu \\mid \\tau^{2}) \\propto (\\tau^2/k_0)^{-1/2} \\exp\\left(-\\frac{k_0}{2\\tau^2}(\\mu - m_0)^2\\right) \\propto (\\tau^2)^{-1/2} \\exp\\left(-\\frac{k_0(\\mu - m_0)^2}{2\\tau^2}\\right)$\n    $p(\\tau^{2}) \\propto (\\tau^2)^{-(a_0+1)} \\exp(-b_0/\\tau^2)$\n    将这些相乘得到：\n    $$p(\\tau^{2} \\mid \\dots) \\propto (\\tau^2)^{-J/2} (\\tau^2)^{-1/2} (\\tau^2)^{-(a_0+1)} \\exp\\left(-\\frac{1}{\\tau^2} \\left[ b_0 + \\frac{1}{2}\\sum_{j=1}^J (\\theta_j - \\mu)^2 + \\frac{k_0}{2}(\\mu - m_0)^2 \\right]\\right)$$\n    $$p(\\tau^{2} \\mid \\dots) \\propto (\\tau^2)^{-(a_0 + \\frac{J+1}{2} + 1)} \\exp\\left(-\\frac{1}{\\tau^2} \\left[ b_0 + \\frac{1}{2}\\left(\\sum_{j=1}^J (\\theta_j - \\mu)^2 + k_0(\\mu - m_0)^2\\right) \\right]\\right)$$\n    这是逆伽马分布 InvGamma($a'$, $b'$) 的核，其形状参数为 $a' = a_0 + \\frac{J+1}{2}$，尺度参数为 $b' = b_0 + \\frac{1}{2}\\left(\\sum_{j=1}^J (\\theta_j - \\mu)^2 + k_0(\\mu - m_0)^2\\right)$。\n\n4.  **$\\sigma^{2}$ 的条件分布**\n    $\\sigma^{2}$ 的完全条件分布是 $p(\\sigma^{2} \\mid \\mathbf{y}, \\boldsymbol{\\theta}, \\mu, \\tau^{2})$，可简化为 $p(\\sigma^{2} \\mid \\mathbf{y}, \\boldsymbol{\\theta})$。我们从联合分布中收集涉及 $\\sigma^2$ 的因子：\n    $$p(\\sigma^{2} \\mid \\mathbf{y}, \\boldsymbol{\\theta}) \\propto p(\\mathbf{y} \\mid \\boldsymbol{\\theta}, \\sigma^{2}) \\, p(\\sigma^{2})$$\n    似然项是 $p(\\mathbf{y} \\mid \\boldsymbol{\\theta}, \\sigma^{2}) = \\prod_{j=1}^J \\prod_{i=1}^{n_j} \\mathcal{N}(y_{ij} \\mid \\theta_j, \\sigma^2)$。就 $\\sigma^2$ 而言，这正比于：\n    $$(\\sigma^2)^{-N/2} \\exp\\left(-\\frac{1}{2\\sigma^2} \\sum_{j=1}^J \\sum_{i=1}^{n_j} (y_{ij} - \\theta_j)^2\\right)$$\n    其中 $N = \\sum_{j=1}^J n_j$。\n    先验是 $p(\\sigma^{2}) = \\text{InvGamma}(\\sigma^2 \\mid a_{\\sigma}, b_{\\sigma})$，正比于 $(\\sigma^2)^{-(a_{\\sigma}+1)} \\exp(-b_{\\sigma}/\\sigma^2)$。\n    将这些相乘得到：\n    $$p(\\sigma^2 \\mid \\dots) \\propto (\\sigma^2)^{-(a_{\\sigma} + N/2 + 1)} \\exp\\left(-\\frac{1}{\\sigma^2} \\left[ b_{\\sigma} + \\frac{1}{2} \\sum_{j=1}^J \\sum_{i=1}^{n_j} (y_{ij} - \\theta_j)^2 \\right]\\right)$$\n    这是逆伽马分布的核，其更新后的形状参数为 $a' = a_{\\sigma} + \\frac{N}{2}$，尺度参数为 $b' = b_{\\sigma} + \\frac{1}{2} \\sum_{j=1}^J \\sum_{i=1}^{n_j} (y_{ij} - \\theta_j)^2$。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\mathcal{N}\\left(\\frac{\\mu\\sigma^2 + n_j \\bar{y}_j \\tau^2}{n_j \\tau^2 + \\sigma^2}, \\frac{\\sigma^2 \\tau^2}{n_j \\tau^2 + \\sigma^2}\\right) \\quad \\mathcal{N}\\left(\\frac{k_0 m_0 + \\sum_{j=1}^J \\theta_j}{k_0+J}, \\frac{\\tau^2}{k_0+J}\\right) \\quad \\text{InvGamma}\\left(a_0 + \\frac{J+1}{2}, b_0 + \\frac{1}{2}\\sum_{j=1}^J (\\theta_j - \\mu)^2 + \\frac{k_0}{2}(\\mu - m_0)^2\\right) \\quad \\text{InvGamma}\\left(a_\\sigma + \\frac{N}{2}, b_\\sigma + \\frac{1}{2} \\sum_{j=1}^J \\sum_{i=1}^{n_j} (y_{ij} - \\theta_j)^2\\right)\n\\end{pmatrix}\n}\n$$", "id": "4953489"}]}