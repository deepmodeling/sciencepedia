## 引言
在医学、公共卫生和社会科学等领域，研究人员常常希望从观察性数据中推断干预措施的因果效应。然而，与随机对照试验不同，[观察性研究](@entry_id:174507)中的处理组和[对照组](@entry_id:188599)在基线特征上往往存在系统性差异，即“混杂偏倚”，这使得直接比较两组的结局会得出有偏的结论。倾向性评分方法（Propensity Score Methods）正是为了解决这一核心挑战而设计的强大统计框架，它旨在通过平衡这些基线差异，模拟随机化过程，从而使因果推断成为可能。

本文将系统性地引导读者深入理解倾向性评分的世界。在“原理与机制”一章中，我们将奠定因果推断的理论基石，解释倾向性评分如何作为一种降维工具来平衡协变量。接着，在“应用与跨学科联系”一章中，我们将跨越不同学科，展示该方法在解决真实世界问题中的广泛适用性和灵活性，并介绍其在处理复杂数据时的前沿扩展。最后，通过“动手实践”部分，读者将有机会通过具体案例加深对核心概念的理解。现在，让我们从支撑这一切的**原理与机制**开始，深入探索该方法背后的逻辑。

## 原理与机制

在观察性研究中，一个核心挑战是处理组间的系统性差异。与随机对照试验（RCT）不同，在[观察性研究](@entry_id:174507)中，接受治疗的个体与未接受治疗的个体在基线特征上可能存在显著不同。这些差异，即所谓的**混杂因素（confounders）**，既影响个体接受治疗的决策，也影响研究的结局。因此，直接比较治疗组和[对照组](@entry_id:188599)的结局可能会产生误导性的结论，将治疗的效果与这些基线差异的影响混为一谈。倾向性评分（Propensity Score）方法是一套强大的统计工具，其旨在通过调整这些观测到的基线差异，从而在[观察性研究](@entry_id:174507)中模拟随机对照试验的特征，以估计治疗的因果效应。本章将深入探讨支持倾向性评分方法的因果推断原理、其核心机制、实际应用策略以及关键的诊断和敏感性分析方法。

### 因果推断的三大基石

为了从观察性数据中识别（identify）因果效应，即为了能够用观测数据来估计潜在的因果量，我们必须依赖一套形式化的假设。这些假设构成了从相关性迈向因果性的桥梁。

#### 稳定单位治疗价值假设（SUTVA）

**稳定单位治疗价值假设（Stable Unit Treatment Value Assumption, SUTVA）** 是因果推断的逻辑起点。它包含两个关键组成部分：

1.  **无干扰（No Interference）**：该假设要求任何一个个体的潜在结局（potential outcomes）仅取决于其自身接受的治疗，而不受其他个体接受何种治疗的影响。例如，在评估一种新药效果的研究中，这意味着一个病人的康复情况不会因为他/她的邻床病人是否服用了该药物而改变。

2.  **一致性（Consistency）**：该假设确保对于接受了特定治疗水平 $a$ 的个体，其观测到的结局 $Y$ 与其在该治疗水平下的潜在结局 $Y(a)$ 是一致的。形式上，如果个体 $i$ 的治疗暴露 $A_i = a$，那么其观测结局 $Y_i = Y_i(a)$。这排除了“隐藏的治疗版本”的存在，确保了我们讨论的治疗是明确且单一的。例如，如果治疗是“手术”，我们假设所有接受手术的个体都接受了同质化的、无本质差异的手术程序。

SUTVA 将我们观测到的数据 $(Y, A)$ 与我们希望了解的、但本质上无法完全观测的潜在结局 $(Y(0), Y(1))$ 联系起来 [@problem_id:4830481]。

#### 强可忽略性（Strong Ignorability）

**强可忽略性（Strong Ignorability）** 假设是控制混杂偏倚的核心。它也由两个部分组成：

1.  **条件可交换性（Conditional Exchangeability）** 或 **无未观测混杂（No Unmeasured Confounding）**：给定一组足够丰富的基线协变量 $X$，治疗分配 $A$ 与潜在结局 $(Y(0), Y(1))$ 是条件独立的。形式上写作 $(Y(0), Y(1)) \perp A \mid X$。这个假设的直观含义是，在具有相同协变量特征 $X=x$ 的个体中，治疗的分配过程是“仿佛随机的”。我们假定 $X$ 已经包含了所有同时影响治疗选择和结局的共同原因。这是倾向性评分方法有效性的最关键、也是最无法验证的假设。

2.  **正性（Positivity）** 或 **重叠（Overlap）**：对于协变量空间中任何存在的特征组合 $x$，每个治疗水平的分配概率都严格大于零。形式上，对于所有的 $x$，我们有 $0  \mathbb{P}(A=1 \mid X=x)  1$。这个假设保证了对于任何类型的个体，我们总能找到接受治疗和未接受治疗的代表。如果某个亚组（例如，所有超过80岁的患者）全部接受了治疗，那么我们就无法为这个亚组估计未经治疗的反事实结局，因为根本不存在可供比较的对照者。因此，正性是识别因果效应的必要条件。倾向性评分方法，无论是匹配、分层还是加权，都依赖于此。例如，在[逆概率](@entry_id:196307)加权中，权重涉及除以倾向性评分 $e(X)$ 或 $1-e(X)$。如果这些概率为零，权重将是无限大，方法便会失效 [@problem_id:4830500]。

#### 因果效应的识别

在 SUTVA 和强可忽略性假设下，我们可以将不可观测的潜在结局的[期望值](@entry_id:150961)用可观测的数据分布来表达。以平均治疗效应（Average Treatment Effect, ATE）$E[Y(1)-Y(0)]$为例，我们分别识别 $E[Y(1)]$ 和 $E[Y(0)]$。

以 $E[Y(1)]$ 为例，推导过程如下：
1.  根据**[迭代期望定律](@entry_id:188849)（Law of Iterated Expectations）**，我们可以对协变量 $X$ 进行积分：
    $E[Y(1)] = E_X[E[Y(1) \mid X]]$

2.  利用**条件可交换性** $(Y(1) \perp A \mid X)$，我们可以在条件期望中加入治疗条件 $A=1$：
    $E[Y(1) \mid X] = E[Y(1) \mid A=1, X]$

3.  利用**一致性**，对于接受了治疗 $A=1$ 的个体，他们的潜在结局 $Y(1)$ 就是他们被观测到的结局 $Y$：
    $E[Y(1) \mid A=1, X] = E[Y \mid A=1, X]$

综合以上三步，我们得到了 $E[Y(1)]$ 的可识别表达式：
$E[Y(1)] = E_X[E[Y \mid A=1, X]]$

同理，可得 $E[Y(0)] = E_X[E[Y \mid A=0, X]]$。

因此，平均治疗效应 ATE 被识别为：
$$ \text{ATE} = E_X[E[Y \mid A=1, X] - E[Y \mid A=0, X]] $$
这个最终表达式完全由可观测变量 $(Y, A, X)$ 的联合分布决定，因此可以从数据中估计。所有基于协变量调整的方法，包括倾向性评分方法，其目标都是为了估计这个被识别出来的量 [@problem_id:4830481]。

### 倾向性评分：一种[降维](@entry_id:142982)工具

直接对高维协变量向量 $X$ 进行匹配或分层是困难的，这就是所谓的“[维数灾难](@entry_id:143920)”。倾向性评分 $e(X) = \mathbb{P}(A=1 \mid X)$ 的引入极大地简化了这个问题。

#### 平衡性质

倾向性评分最重要的理论性质是其**平衡性质（Balancing Property）**。Rosenbaum 和 Rubin (1983) 证明，在以倾向性评分为条件的亚组内，治疗分配 $A$ 与协变量 $X$ 的整体分布是独立的，即 $A \perp X \mid e(X)$。这意味着，如果我们找到两个具有相同倾向性评分（例如 $e(X)=0.7$）的个体，即使他们的具体协变量组合（如年龄、性别、病史）可能不同，从统计意义上讲，一个来自治疗组，一个来自[对照组](@entry_id:188599)，他们的协变量分布是平衡的。

#### 对无混杂的充分性

更重要的是，倾向性评分对于控制混杂是**充分的（sufficient）**。如果给定 $X$ 满足条件[可交换性](@entry_id:263314)，那么给定 $e(X)$ 也同样满足，即：
$$ (Y(0), Y(1)) \perp A \mid X \implies (Y(0), Y(1)) \perp A \mid e(X) $$
这一性质意味着，我们可以将一个复杂的高维调整问题（在 $X$ 上进行条件化）转化为一个简单的一维调整问题（在标量 $e(X)$ 上进行条件化），而不会丢失识别因果效应的能力。这就是倾向性评分方法的核心思想：它将所有与治疗选择相关的混杂信息压缩到了一个单一的标量中 [@problem_id:4830535]。

### 为倾向性评分[模型选择](@entry_id:155601)协变量

构建倾向性评分模型的第一步，也是最关键的一步，是选择包含哪些协变量。这个选择过程必须以因果理论为指导，而不仅仅是[统计预测](@entry_id:168738)能力。使用**[有向无环图](@entry_id:164045)（Directed Acyclic Graphs, DAGs）** 是指导这一过程的有力工具。

我们的目标是选择一个协变量集合 $X$，使其满足**[后门准则](@entry_id:637856)（Backdoor Criterion）**。一个集合 $X$ 满足[后门准则](@entry_id:637856)，如果：
1.  $X$ 中不包含 $A$ 的任何后代（即不受治疗影响的变量）。
2.  $X$ 阻断了所有连接 $A$ 和 $Y$ 的、以指向 $A$ 的箭头开始的路径（即“后门路径”）。

简单来说，我们应该在模型中包含所有 $A$ 和 $Y$ 的[共同原因](@entry_id:266381)（**混杂因素**），而不应包含受 $A$ 影响的变量（**中介因素**）或由两个变量共同导致的变量（**对撞因子**）。

例如，考虑一个评估早期血管介入治疗（$T$）对死亡率（$Y$）影响的研究。协变量包括年龄（$A$）、社会经济地位（$S$）、合并症（$C$）、医院质量（$H$）、医生偏好（$P$）、入院途径（$R$）和治疗后血运重建成功率（$M$）。假设其[因果结构](@entry_id:159914)如 [@problem_id:4980793] 中所描述的DAG所示。一个有效的协变量集合是 $\{A, S, C, H\}$，因为它们是 $T$ 和 $Y$ 的共同原因，调整它们可以阻断主要的后门路径。

#### [对撞偏倚](@entry_id:163186)的风险

一个常见的、严重的错误是调整对撞因子。**对撞因子（collider）** 是一个被两个或多个变量共同影响的变量（例如，路径 $X \rightarrow C \leftarrow Z$ 中的 $C$）。在默认情况下，通过对撞因子的路径是封闭的。然而，一旦我们对对撞因子进行条件化（例如，将其纳入回归模型或倾向性评分模型），这条路径就会被打开，从而在原本独立的两个原因之间产生虚假的关联。

考虑一个场景 [@problem_id:4830498]，其中治疗 $A$ 和一个未观测的生理脆弱性 $U$ 共同影响了乳酸水平 $C$（即 $A \rightarrow C \leftarrow U$）。同时，$U$ 也直接影响结局 $Y$（即 $U \rightarrow Y$）。在这种情况下，$C$ 是一个对撞因子。尽管我们假设，仅需调整基线变量 $L$ 就足以控制混杂，但如果研究者错误地将后处理变量 $C$ 加入倾向性评分模型，他们就会在 $A$ 和 $U$ 之间打开一条虚假通路。由于 $U$ 影响 $Y$，这就引入了偏倚，破坏了条件可交换性。

这个原则也适用于治疗前的变量。如果一个变量 $C$ 是治疗 $A$ 的某个原因和结局 $Y$ 的某个原因的共同结果（即所谓的 M-结构: $A \leftarrow L_1 \rightarrow C \leftarrow L_2 \rightarrow Y$），那么调整 $C$ 同样会引入[对撞偏倚](@entry_id:163186) [@problem_id:4830498]。这强调了一个关键点：倾向性评分模型的目标不是最大化对治疗分配的预测准确性，而是恰当地调整混杂因素以满足可交换性假设 [@problem_id:4830498]。

### 使用倾向性评分估计因果效应

在估计了倾向性评分 $\hat{e}(X)$ 之后，有多种方法可以用来估计因果效应。选择哪种方法以及如何实施，取决于我们感兴趣的目标估计量。

#### 目标估计量：ATE, ATT, 和 ATC

在因果推断中，有三个常见的目标估计量：

1.  **平均治疗效应（Average Treatment Effect, ATE）**：$E[Y(1) - Y(0)]$，即在整个目标人群中，接受治疗相对于不接受治疗的平均效果。
2.  **处理组平均治疗效应（Average Treatment Effect on the Treated, ATT）**：$E[Y(1) - Y(0) \mid A=1]$，即在实际接受了治疗的人群中，治疗的平均效果。
3.  **[对照组](@entry_id:188599)平均治疗效应（Average Treatment Effect on the Controls, ATC）**：$E[Y(1) - Y(0) \mid A=0]$，即在实际未接受治疗的人群中，如果他们接受了治疗，会产生的平均效果。

选择哪个估计量取决于研究问题。例如，评估一项公共卫生干预政策时，ATE 更为重要；而评估一种昂贵且有风险的手术时，了解其对实际接受手术的病人的效果（ATT）可能更有意义 [@problem_id:4830491]。

#### 倾向性评分方法

1.  **倾向性评分匹配（Propensity Score Matching, PSM）**：这是最直观的方法。其核心思想是为每个接受治疗的个体，在[对照组](@entry_id:188599)中寻找一个或多个具有最相似倾向性评分的个体作为匹配。这样形成了一个新的、协变量分布近似平衡的“伪随机”数据集。最常见的1对1匹配，其目标是估计 **ATT**，因为它是为治疗组构建了一个可比的[对照组](@entry_id:188599)。反之，若为每个[对照组](@entry_id:188599)个体寻找治疗组的匹配，则可以估计 **ATC** [@problem_id:4830491]。

2.  **倾向性评分分层（Propensity Score Stratification）**：此方法将样本根据倾向性评分的五分位数或十分位数等分为若干个（例如5个或10个）子层。在每个子层内，个体的倾向性评分相似，因此协变量分布也应近似平衡。在每个子层内分别计算治疗效应，然后通过加权平均得到总[体效应](@entry_id:261475)。权重的选择决定了目标估计量：若以各层在总样本中的比例为权重，则估计 **ATE**；若以各层在治疗组中的比例为权重，则估计 **ATT** [@problem_id:4830491]。

3.  **逆概率加权（Inverse Probability of Treatment Weighting, IPTW）**：IPTW 通过给每个个体赋予一个权重，来创建一个协变量分布与治疗分配无关的伪总体。权重的构建方式决定了目标估计量 [@problem_id:4830491]：
    *   **ATE 权重**：治疗组个体的权重为 $1/\hat{e}(X_i)$，[对照组](@entry_id:188599)个体的权重为 $1/(1-\hat{e}(X_i))$。这使得伪总体中任何协变量水平下的治疗组和[对照组](@entry_id:188599)比例都[趋于平衡](@entry_id:150414)。
    *   **ATT 权重**：治疗组个体是目标人群，其权重为1。[对照组](@entry_id:188599)个体被加权以使其协变量分布与治疗组匹配，其权重为 $\hat{e}(X_i) / (1-\hat{e}(X_i))$（即治疗的“比值”）。
    *   **ATC 权重**：与 ATT 对称，[对照组](@entry_id:188599)个体权重为1，治疗组个体权重为 $(1-\hat{e}(X_i)) / \hat{e}(X_i)$。

### 诊断：评估协变量平衡

在应用任何倾向性评分方法后，必须进行**诊断检查**，以验证协变量平衡是否确实得到改善。仅仅拟合一个倾向性评分模型是远远不够的。

#### 标准化均数差（Standardized Mean Difference, SMD）

评估平衡性的首选工具是**标准化均数差（Standardized Mean Difference, SMD）**，有时也称为标准化偏倚。对于一个连续协变量 $X_j$，其定义为：
$$ \Delta_j = \frac{\bar{X}_{1j} - \bar{X}_{0j}}{\sqrt{(s_{1j}^2 + s_{0j}^2)/2}} $$
其中 $\bar{X}_{tj}$ 和 $s_{tj}^2$ 分别是治疗组 $t$ 中协变量 $j$ 的样本均值和方差。对于二元协变量，该公式简化为：
$$ \Delta_j = \frac{p_{1j} - p_{0j}}{\sqrt{(p_{1j}(1-p_{1j}) + p_{0j}(1-p_{0j}))/2}} $$
其中 $p_{tj}$ 是组 $t$ 中该协变量取值为1的比例 [@problem_id:4830450]。

SMD 具有以下重要特性：
*   **无量纲**：它不受协变量原始单位的影响，因此可以在不同协变量之间进行比较。
*   **对样本量不敏感**：与依赖于样本量的[p值](@entry_id:136498)不同，SMD衡量的是效应的大小。在大型研究中，即使是临床上微不足道的差异也可能产生统计学上显著的[p值](@entry_id:136498)，而SMD能更稳定地反映不平衡的程度。
*   **解释直观**：普遍接受的[经验法则](@entry_id:262201)是，调整后 $|\Delta_j| \le 0.1$ 表明达到了可接受的平衡 [@problem_id:4830450]。

在使用IPTW或分层后评估平衡性时，必须使用加权后或层内的均值和方差来计算SMD [@problem_id:4830450]。

#### 评估分布平衡

SMD 主要关注分布的第一矩（均值）。为了评估整个分布的平衡性，可以使用图形方法，如绘制**[经验累积分布函数](@entry_id:167083)（Empirical Cumulative Distribution Function, ECDF）**图。**Kolmogorov-Smirnov (KS) 统计量**为这两条ECDF曲线之间的最大垂直距离。
$$ D = \sup_{x} |\hat{F}_{\text{treated}}(x) - \hat{F}_{\text{control}}(x)| $$
一个较小的KS统计量表明两个组的协变量分布在所有值上都很接近，从而提供了比SMD更全面的平衡性证据 [@problem_id:4830542]。

然而，需要注意的是，即使一维的倾向性评分分布图和SMD看起来平衡良好，当正性假设很弱时（即倾向性评分接近0或1），在高维协变量空间中可能仍然存在局部的不重叠。这是因为许多不同的协变量组合可能映射到相似的倾向性评分值，从而掩盖了局部的不[匹配问题](@entry_id:275163) [@problem_id:4830535]。

### 高级主题与扩展

#### 双重[稳健估计](@entry_id:261282)

**双重[稳健估计](@entry_id:261282)（Doubly Robust Estimation）** 是一种结合了倾向性评分和结局[回归模型](@entry_id:163386)的强大方法。其估计量（也称为增广逆概率加权估计量，AIPW）的形式为：
$$ \hat{\tau}_{\text{DR}} = \frac{1}{n} \sum_{i=1}^n \left( (\hat{m}_1(X_i) - \hat{m}_0(X_i)) + \frac{T_i(Y_i - \hat{m}_1(X_i))}{\hat{e}(X_i)} - \frac{(1-T_i)(Y_i - \hat{m}_0(X_i))}{1-\hat{e}(X_i)} \right) $$
其中 $\hat{m}_t(X)$ 是对结局的[条件期望](@entry_id:159140) $E[Y \mid T=t, X]$ 的估计。这种估计量的美妙之处在于其“双重稳健”性质：只要倾向性评分模型或结局回归模型中**有一个**被正确设定，它就能提供对ATE的一致估计。这为研究者提供了“两次机会”来获得正确的答案，使其比单独依赖任一模型的方法更为可靠 [@problem_id:4980792]。

#### 对未观测混杂的[敏感性分析](@entry_id:147555)

倾向性评分方法只能调整**已观测**的混杂因素。然而，“无未观测混杂”这一核心假设是无法被验证的。因此，在报告[观察性研究](@entry_id:174507)的结果时，进行**敏感性分析（sensitivity analysis）**至关重要。[敏感性分析](@entry_id:147555)旨在量化一个未观测的混杂因素需要多强大，才能从本质上改变研究的结论。

我们可以定义两个参数来描述一个二元未观测混杂因素 $U$ 的强度 [@problem_id:4980775]：
*   $RR_{AU}$：$U$ 与治疗分配 $A$ 之间的关联强度（风险比）。
*   $RR_{UY}$：$U$ 与结局 $Y$ 之间的关联强度（风险比）。

可以证明，由 $U$ 引起的最大偏倚因子（即观测风险比 $RR_{\text{obs}}$ 与真实因果风险比 $RR_{\text{true}}$ 的比值）的上限为：
$$ B_{\text{max}} = \frac{RR_{AU} \cdot RR_{UY}}{RR_{AU} + RR_{UY} - 1} $$
假设一项研究观测到的风险比为 $RR_{\text{obs}} = 0.70$，提示治疗有保护作用。我们可以问：一个多强的未观测混杂因素（假设 $RR_{AU}=RR_{UY}=x$）才能“解释掉”这个发现，即让这个结果与真实的因果风险比为1（$RR_{\text{true}}=1$）相容？通过求解 $B_{\text{max}} \ge 1/0.70$，我们可以计算出所需的最小混杂强度 $x$。例如，在 [@problem_id:4980775] 的计算中，需要一个与治疗和结局的关联风险比都至少为 $2.211$ 的未观测混杂因素才能完全解释观测到的效应。这个数值为研究结果的稳健性提供了一个具体的衡量标准。