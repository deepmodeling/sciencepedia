## 引言
在医学、公共卫生和社会科学等领域，研究者常常希望评估某项干预措施（如新药、新疗法或新政策）的因果效应。然而，由于伦理或实践限制，随机对照试验（RCT）并非总是可行，使得我们必须依赖观察性数据。[观察性研究](@entry_id:174507)面临的核心挑战是**混杂偏倚**：接受干预的个体与未接受干预的个体在关键预后特征上可能存在系统性差异，从而扭曲真实的因果关系。为了应对这一挑战，倾向性评分方法应运而生，成为从复杂观察性数据中提取可靠因果结论的强大工具。

本文旨在系统性地介绍两种主流的倾向性评分调整技术：**倾向性评分分层法**与**逆概率加权法（IPTW）**。通过学习本文，您将能够理解如何在存在混杂因素的情况下，模拟随机试验的核心思想，从而估计出无偏的因果效应。

文章将分为三个部分展开：
- 在“**原则与机制**”一章中，我们将奠定理论基础，详细阐释因果推断的核心目标（ATE、ATT）、三大识别假设，以及倾向性评分如何作为一个降维工具来平衡协变量，并介绍分层法与IPTW的具体工作机制。
- 接下来，“**应用与跨学科联系**”一章将展示这些方法在临床流行病学、药物安全监测等领域的实际应用，并探讨如何将其扩展至[生存数据](@entry_id:165675)、纵向数据等复杂场景，同时解决诊断协变量平衡和处理极端权重等实践难题。
- 最后，“**动手实践**”部分将通过一系列引导性问题，帮助您巩固从模型构建、平衡性诊断到效应估计的全过程，将理论知识转化为实践技能。

通过这三个章节的层层深入，您将全面掌握倾向性评分分层法与逆概率加权法的理论精髓与应用技巧。让我们首先进入第一章，探索这些方法背后的核心原则与机制。

## 原则与机制

本章在前一章介绍的基础上，深入探讨在观察性研究中估计因果效应的核心原则与机制。我们将阐明，为了从存在混杂偏倚的数据中提取无偏的效应估计，为何需要以及如何利用倾向性评分。具体而言，我们将系统地介绍倾向性评分分层法与逆概率加权法，它们是调整可观测混杂因素的两种主流方法。

### 关键因果目标：ATE、ATT与ATC

在评估一项医学干预措施（如一种新药或一项新疗法）的效果时，首要任务是明确我们希望回答的因果问题。这个问题由我们选择的**因果 estimand**（目标参数）来定义。在潜在结局框架下，我们为每个个体$i$定义两个潜在结局：$Y_i(1)$表示其接受干预（$A_i=1$）时的结局，而$Y_i(0)$表示其未接受干预（$A_i=0$）时的结局。基于此，三个最核心的因果 estimands 被定义出来 [@problem_id:4980951]。

1.  **平均处理效应 (Average Treatment Effect, ATE)**：
    $$ \mathrm{ATE} = \mathbb{E}[Y(1) - Y(0)] $$
    ATE 回答了这样一个问题：“如果将整个人群（例如，所有符合条件的高血压患者）随机分配到接受新药或常规护理，平均效果差异会是多少？” 这个 estimand 对于制定宏观卫生政策至关重要，因为它评估了在整个目标人群中推广该干预的平均影响 [@problem_id:4980951]。

2.  **处理组平均处理效应 (Average Treatment Effect on the Treated, ATT)**：
    $$ \mathrm{ATT} = \mathbb{E}[Y(1) - Y(0) \mid A=1] $$
    ATT 回答了一个更具针对性的问题：“在那些实际接受了新药治疗的患者中，其平均获益（或损失）是多少？” 这个 estimand 对于评估现有临床实践的效果非常有用。例如，如果医生倾向于将新药给予风险更高的患者，ATT 将量化该药物在这一高风险群体中的实际效果 [@problem_id:4980949] [@problem_id:4980951]。

3.  **[对照组](@entry_id:188599)平均处理效应 (Average Treatment Effect on the Controls, ATC)**：
    $$ \mathrm{ATC} = \mathbb{E}[Y(1) - Y(0) \mid A=0] $$
    ATC 则回答：“在那些未接受新药治疗的患者中，如果他们当初接受了治疗，平均效果会是怎样？” 这个 estimand 在考虑是否将干预措施扩展到目前未覆盖的人群时特别有价值。

在任何观察性研究中，研究者都必须首先明确其研究的临床或政策背景，以选择最相关的因果 estimand。

### 因果识别的基本假设

“因果推断的根本问题”在于，对于任何一个个体，我们永远只能观测到$Y_i(1)​$或$Y_i(0)​$中的一个，而无法同时观测到两者。为了能够从观测数据（即个体的处理状态$A$、协变量$X$和观测结局$Y$）中估计上述反事实的 estimands，我们必须依赖一组关键的、不可完全验证的**识别假设 (identification assumptions)** [@problem_id:4980964] [@problem_id:4980908]。

1.  **一致性 (Consistency)**：该假设将潜在结局与观测结局联系起来。它规定，一个个体在其实际接受的处理水平下的潜在结局，就是我们观测到的结局。形式化地，如果个体$i$接受了处理$A_i=a$，那么其观测结局$Y_i$等于$Y_i(a)$。这通常被包含在**稳定单元处理价值假设 (Stable Unit Treatment Value Assumption, SUTVA)**中，SUTVA还包含了**无干扰 (no interference)**的假设，即一个个体的潜在结局不受其他个体处理分配的影响 [@problem_id:4980964]。

2.  **条件[可交换性](@entry_id:263314) (Conditional Exchangeability)**：这是控制混杂偏倚的核心假设，也称为**无未观测混杂 (no unmeasured confounding)**或**可忽略性 (ignorability)**。它要求在给定一组协变量$X$的条件下，处理分配$A$与潜在结局$\{Y(1), Y(0)\}$是独立的。形式化地写作：
    $$ \{Y(1), Y(0)\} \perp A \mid X $$
    其直观含义是，在具有相同协变量$X$值的个体亚组内，接受处理的个体与未接受处理的个体在潜在结局方面是“可交换的”或“可比较的”，就好像处理是随机分配的一样。所有可能影响处理选择和结局的变量（即混杂因素）都必须被包含在$X$中，此假设才能成立 [@problem_id:4980908] [@problem_id:4980964]。

3.  **正性 (Positivity)**：该假设也称为**重叠 (overlap)**，要求在协变量$X$的每一个取值组合上，接受处理和未接受处理的概率都必须大于零。形式化地：
    $$ 0 \lt \mathbb{P}(A=1 \mid X=x) \lt 1 $$
    对于所有在人群中可能出现的$x$。如果对于某类特征为$x$的患者，他们总是（或从不）接受某种治疗，那么我们就无法在该亚组中进行处理组与[对照组](@entry_id:188599)的比较，也就无法识别该亚组的因果效应。因此，正性是进行有效比较的经验基础 [@problem_id:4980964] [@problem_id:4980913]。

只有当这三个核心假设同时成立时，我们才可以说因果效应是**可识别的 (identifiable)**，即可以从观测数据的分布中唯一确定。

### 倾向性评分：一个根本性的[降维](@entry_id:142982)工具

直接对高维协变量向量$X$进行匹配或分层调整，在实践中往往是不可行的，这被称为“[维数灾难](@entry_id:143920)”。倾向性评分理论为解决这一难题提供了优雅的方案。

**倾向性评分 (Propensity Score, PS)**被定义为在给定一系列基线协变量$X$的条件下，一个个体接受处理的条件概率 [@problem_id:4980880]：
$$ e(X) = \mathbb{P}(A=1 \mid X) $$
倾向性评分最重要的理论性质是它的**平衡性 (balancing property)**。该性质是一个数学定理，而非一个假设，它表明：在给定倾向性评分$e(X)$的条件下，处理分配$A$与协变量$X$是相互独立的 [@problem_id:4980880] [@problem_id:4980910]。
$$ X \perp A \mid e(X) $$
这意味着，如果我们找到一群倾向性评分完全相同的患者，那么在这个亚群中，无论他们最终是接受了治疗还是作为对照，其协变量$X$的分布是完全相同的。因此，倾向性评分$e(X)$成为了一个一维的、包含了$X$中所有关于处理分配信息的充分摘要。

这一性质的直接推论是，如果条件可交换性在给定$X$时成立，那么它在给定$e(X)$时也成立 [@problem_id:4980880] [@problem_id:4980937]：
$$ \{Y(1), Y(0)\} \perp A \mid X \implies \{Y(1), Y(0)\} \perp A \mid e(X) $$
这就为我们使用倾向性评分来代替高维协变量$X$进行混杂调整提供了理论依据。我们可以通过匹配、分层或加权等方法，在倾向性评分上实现组间平衡，从而消除由$X$所引起的混杂偏倚。

值得注意的是，倾向性评分虽然是处理分配机制的充分统计量，但它不一定是结局模型的充分统计量。一个协变量可能与结局紧密相关（即为强**预后变量 (prognostic variable)**），但与处理分配关系不大。在将$X$简化为$e(X)$的过程中，这类纯预后变量的信息可能会丢失。虽然这不会导致因果效应估计产生偏倚，但可能会降低估计的统计**效率 (efficiency)**（即增大方差）。在更高级的方法中（如双重[稳健估计](@entry_id:261282)），同时利用倾向性评分模型和结局模型，可以更有效地利用$X$中的预后信息以提高估计精度 [@problem_id:4980937]。

### 基于倾向性评分的估计方法

#### 倾向性评分分层法

倾向性评分分层法（或称亚分类法）是一种直观的调整方法。其基本步骤如下：

1.  **估计倾向性评分**：通常使用逻辑回归等模型，以处理状态$A$为因变量，协变量$X$为[自变量](@entry_id:267118)，为每个个体估计其倾向性评分$\hat{e}(X)$。
2.  **划分层次**：根据估计的倾向性评分$\hat{e}(X)$的分布，将所有研究对象划分为$K$个互不重叠的层次。一种常见且推荐的做法是使用$\hat{e}(X)$的**分位数 (quantiles)**进行划分，例如划分为五个层次（即五分位数），以确保每个层次内有大致相等的样本量 [@problem_id:4980918]。
3.  **层内效应估计**：在每个层次$k$内部，分别计算处理组和[对照组](@entry_id:188599)的平均结局，其差值$(\bar{Y}_{1,k} - \bar{Y}_{0,k})$即为该层次的因果效应估计。由于在每个层次内，个体的倾向性评分值相近，因此协变量分布也是近似平衡的，这使得层内的直接比较近似无偏 [@problem_id:4980910]。
4.  **汇总效应**：最后，将各层次的效应估计值进行加权平均，得到总体的因果效应估计。权重通常是每个层次的样本量占总样本量的比例。

分层法的核心逻辑是，通过在倾向性评分上进行划分，将对高维$X$的调整问题转化为对一维$e(X)$的调整。对于有限的层次数量$K$，层次内的倾向性评分并非完全相同，因此协变量的平衡也只是近似的，这会导致**残余偏倚 (residual bias)**。随着层次数量$K$的增加，层次变得更窄，残余偏倚会减小。理论上，当$K$趋于无穷大时，分层法得到的估计量将收敛到真实的因果效应 [@problem_id:4980908] [@problem_id:4980910]。

在实践中，选择$K=5$是一个广为流传的[经验法则](@entry_id:262201)。这一做法的理论基础源于Cochran的研究，他发现对于单个正态分布的混杂因素，分为五个子类可以消除大约90%的偏倚。Rosenbaum和Rubin将其扩展到倾向性评分，并发现五[分位数](@entry_id:178417)分层法在多种应用场景下都能有效去除大部分由可观测协变量引起的偏倚，同时避免了因分层过细导致层内样本量过小而估计不稳定的问题 [@problem_id:4980918]。

#### [逆概率](@entry_id:196307)加权法 (IPTW)

[逆概率](@entry_id:196307)加权法 (Inverse Probability of Treatment Weighting, IPTW) 提供了一种不同的调整思路。它并非通过创造可比较的亚组，而是通过加权来构建一个“伪人群” (pseudo-population)，在这个伪人群中，处理分配与协变量无关，从而消除了混杂。

其核心机制是为每个个体赋予一个权重$w_i$，该权重等于其**接受实际所受处理**的概率的倒数。

*   **ATE的权重**：为了估计ATE，我们的目标是创建一个伪人群，其中协变量在处理组和[对照组](@entry_id:188599)中的分布都与原始总人群相同。权重定义为：
    $$ w_i^{\mathrm{ATE}} = \frac{A_i}{e(X_i)} + \frac{1-A_i}{1-e(X_i)} $$
    对于一个接受处理的个体 ($A_i=1$)，其权重为$1/e(X_i)$；对于一个未接受处理的个体 ($A_i=0$)，其权重为$1/(1-e(X_i))$。通过这些权重，一个在原始数据中代表性不足的个体（例如，一个本不该接受治疗却接受了的个体）在伪人群中被赋予了更大的权重，反之亦然 [@problem_id:4980908] [@problem_id:4980880]。

*   **ATT的权重**：为了估计ATT，我们的目标是为处理组寻找一个可比较的[对照组](@entry_id:188599)。这意味着我们需要将原始[对照组](@entry_id:188599)进行加权，使其协变量分布与处理组相同，而处理组本身已经是我们关心的目标人群，无需加权。因此，权重定义为 [@problem_id:4980949]：
    $$ w_i^{\mathrm{ATT}} = A_i + (1-A_i) \frac{e(X_i)}{1-e(X_i)} $$
    这意味着，所有处理组个体的权重为$1$，而[对照组](@entry_id:188599)个体的权重为$\frac{e(X_i)}{1-e(X_i)}$，这个比值恰好是“成为处理组的概率”与“成为[对照组](@entry_id:188599)的概率”之比，也称为**odds**。这种加权方式在直觉上将[对照组](@entry_id:188599)“改造”成了处理组的复制品 [@problem_id:4980949] [@problem_id:4980951]。

ATC的权重与ATT对称，此处不再赘述。

在获得权重后，ATE的估计量可以通过计算加权后的结局均值之差得到。例如，ATE的Horvitz-Thompson估计量为：
$$ \hat{\mathrm{ATE}}_{\mathrm{IPTW}} = \frac{1}{n} \sum_{i=1}^n \left( \frac{A_i Y_i}{e(X_i)} - \frac{(1-A_i)Y_i}{1-e(X_i)} \right) $$

理论上，当分层法的层次数量$K$趋于无穷大时，其估计的目标参数与IPTW的目标参数是相同的 [@problem_id:4980908] [@problem_id:4980918]。

### 实践中的挑战与对策

#### 正性假设的挑战

正性假设是所有倾向性评分方法有效性的基石。在实践中，我们面临两种形式的违规：

1.  **理论违规**：对于某些协变量$X=x$的亚组，$\mathbb{P}(A=1|X=x)$严格等于0或1。例如，存在某种绝对禁忌症，使得某类患者绝不会接受某种治疗。在这种情况下，因果效应是不可识别的，因为我们缺乏反事实的经验证据 [@problem_id:4980913]。

2.  **实践违规 (或称弱重叠)**：虽然理论上概率不为0或1，但在样本中，某些个体的估计倾向性评分$\hat{e}(X_i)$非常接近0或1。例如，一个本极不可能接受治疗的患者 ($\hat{e}(X_i) \approx 0$) 却接受了治疗 ($A_i=1$)。对于IPTW，这将导致其权重$1/\hat{e}(X_i)$变得极大。这种极端权重会使少数几个个体对总[体效应](@entry_id:261475)估计产生不成比例的巨大影响，从而极大地增加估计量的**方差**，使其变得非常不稳定，并对倾向性评分模型的微小设定错误也异常敏感 [@problem_id:4980945] [@problem_id:4980913]。

#### 应对弱重叠的策略

面对实践中倾向性评分接近0或1的问题，研究者可以采取以下几种策略：

*   **稳定化权重 (Stabilized Weights)**：稳定化权重通过在分子上乘以处理的[边际概率](@entry_id:201078)来缩减权重的范围。例如，ATE的稳定化权重为：
    $$ w_i^{\mathrm{ATE, stab}} = \frac{A_i \mathbb{P}(A=1)}{e(X_i)} + \frac{(1-A_i)\mathbb{P}(A=0)}{1-e(X_i)} $$
    其中$\mathbb{P}(A=1)$可以用样本中处理组的比例来估计。由于$\mathbb{P}(A=1)$和$\mathbb{P}(A=0)$是小于1的常数，稳定化权重通常比标准权重有更小的变异性，从而得到更稳定的估计量。然而，当分母$e(X_i)$或$1-e(X_i)$非常接近0时，稳定化权重仍然会变得很大，因此它能缓解但不能根除极端权重带来的不稳定性问题 [@problem_id:4980945] [@problem_id:4980908]。

*   **截断 (Trimming) 或权重封顶 (Weight Capping)**：这是一种更激进的策略。截断是指直接从分析中剔除那些倾向性评分极端（例如，小于0.01或大于0.99）的个体。权重封顶则是将超过某个阈值的权重强制设置为该阈值。这些方法通过直接消除极端权重来有效降低[估计量的方差](@entry_id:167223)。然而，它们付出的代价是**改变了目标参数**。分析不再针对原始的全部目标人群，而是针对一个协变量重叠性更好的亚群（“重叠人群”）。因此，这种方法在降低方差的同时，可能引入了相对于原始ATE的偏倚。研究者必须在获得一个更稳定、但针对不同人群的估计，与一个可能不稳定、但针对原始目标人群的估计之间做出权衡 [@problem_id:4980945] [@problem_id:4980913]。

综上所述，倾向性评分方法为从观察性数据中进行因果推断提供了强大的理论框架和实用的工具。然而，成功应用这些方法不仅需要理解其基本原理，还要求对背后的假设有深刻的认识，并能在实践中诊断和应对可能出现的问题。