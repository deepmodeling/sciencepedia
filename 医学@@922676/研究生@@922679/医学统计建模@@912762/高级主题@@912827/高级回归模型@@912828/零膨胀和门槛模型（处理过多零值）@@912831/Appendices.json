{"hands_on_practices": [{"introduction": "本练习解决了一个根本性的诊断问题：数据中的过度离散（overdispersion）是否必然意味着您需要使用零膨胀模型？我们将通过第一性原理和具体计算，探讨为何情况并非如此，并学习如何计算标准负二项分布模型所预期的零概率。这项技能对于证明使用更复杂的零膨胀或Hurdle模型的合理性至关重要。[@problem_id:4993564]", "problem": "一家医疗中心追踪一种慢性呼吸系统疾病患者每年严重恶化的次数。设 $Y$ 表示每病人年的计数。该中心观察到过度离散现象，即与泊松基准相比，$\\mathrm{Var}(Y)>\\mathrm{E}(Y)$。分析师正在考虑是否需要使用零膨胀模型来解释明显偏高的零计数比例。\n\n仅使用核心定义和经过充分检验的事实，按以下步骤进行。\n\n1) 从第一性原理出发，解释为什么仅有过度离散并不逻辑上意味着“零过多”。在这里，“零过多”指的是在零点的概率质量 $\\mathbb{P}(Y=0)$ 大于具有相同均值的适当选择的基准计数模型所预期的值。你的解释应明确阐述关于二阶矩（方差膨胀）的陈述与关于单一点（$0$）上的概率质量的陈述之间的区别。给出一个具体的构造，构建一个具有零缺失（即 $\\mathbb{P}(Y=0)$ 小于具有相同均值的标准基准，如泊松分布）的过度离散计数分布，从而证明过度离散本身并不能保证零过多。\n\n2) 现在假设 $Y$ 服从一个在生物统计学中广泛用于处理过度离散计数的负二项 (NB) 模型，该模型通过泊松-伽马混合定义：在给定受试者特异性脆弱性 $\\,\\Theta\\,$ 的条件下，$Y \\mid \\Theta \\sim \\mathrm{Poisson}(\\lambda\\,\\Theta)$，并且脆弱性 $\\Theta \\sim \\mathrm{Gamma}(k,\\text{rate}=k)$，因此 $\\mathrm{E}[\\Theta]=1$ 且 $\\mathrm{Var}(\\Theta)=1/k$。因此，$\\mathrm{E}[Y]=\\lambda$ 且 $\\mathrm{Var}(Y)=\\lambda+\\lambda^{2}/k$。从这个混合定义和泊松随机变量的概率定义出发，推导出边际零概率 $\\mathbb{P}(Y=0)$ 关于 $\\,\\lambda\\,$ 和 $\\,k\\,$ 的闭式表达式。\n\n对于一个平均计数 $\\lambda=2.4$ 且离散参数 $k=1.5$ 的队列，对你推导出的表达式进行数值计算。将你的最终数值答案四舍五入到四位有效数字。将最终量报告为无单位小数。", "solution": "该问题陈述具有科学依据，定义明确，且没有矛盾。它提出了一个在应用统计学中标准但微妙的概念性挑战。因此，我们可以着手解答。\n\n1) “过度离散并不逻辑上意味着零过多”这一陈述关系到一个分布的二阶矩与单一点上的概率质量之间的关系。在计数数据的背景下，过度离散意味着随机变量 $Y$ 的方差大于其期望，即 $\\mathrm{Var}(Y) > \\mathrm{E}(Y)$。这是与泊松分布的比较，对于泊松分布，$\\mathrm{Var}(Y) = \\mathrm{E}(Y)$。“零过多”意味着观测到的零计数概率 $\\mathbb{P}(Y=0)$ 大于具有相同均值的基准模型所预测的概率。对于均值为 $\\mu = \\mathrm{E}(Y)$ 的泊松基准，这意味着 $\\mathbb{P}(Y=0) > \\exp(-\\mu)$。\n\n方差定义为 $\\mathrm{Var}(Y) = \\mathrm{E}[(Y-\\mu)^2] = \\sum_{k=0}^{\\infty} (k-\\mu)^2 \\mathbb{P}(Y=k)$，是分布的一个全局性质，因为它是对所有可能结果的加权平均。它衡量概率质量围绕均值的散布程度。方差大可能是由于与基准相比，分布的尾部（即远离均值的值）有更多的概率质量。\n\n相比之下，$\\mathbb{P}(Y=0)$ 是一个局部性质，指的是在单一点 $k=0$ 上的概率质量。可以在不增加甚至减少 $k=0$ 处概率质量的情况下增大方差。这可以通过将概率质量从均值附近移动到分布的上尾部来实现。将概率质量从 $k=0$ 处移走并重新分配到一个非常大的 $k$ 值，会同时减少 $\\mathbb{P}(Y=0)$ 并增加方差，因为新的大结果的较大平方偏差 $(k-\\mu)^2$ 会对总和产生很大贡献。\n\n为了提供一个具体的构造，我们定义一个基准模型 $Y_P \\sim \\mathrm{Poisson}(\\lambda=1)$。\n对于这个基准模型：\n- 均值: $\\mathrm{E}[Y_P] = 1$。\n- 方差: $\\mathrm{Var}[Y_P] = 1$。\n- 零概率: $\\mathbb{P}(Y_P=0) = \\exp(-1) \\approx 0.3679$。\n\n现在，我们构造一个新的离散随机变量 $Y$，其概率质量函数 (PMF) 如下，设计使其具有相同的均值，是过度离散的，但表现出零缺失：\n设 $Y$ 在 $\\{0, 1, 11\\}$ 中取值，其 PMF 为：\n- $\\mathbb{P}(Y=0) = 0.1$\n- $\\mathbb{P}(Y=1) = 0.89$\n- $\\mathbb{P}(Y=11) = 0.01$\n概率之和为 $0.1 + 0.89 + 0.01 = 1$，因此这是一个有效的 PMF。\n\n我们来检查它的性质：\n- 均值: $\\mathrm{E}[Y] = (0 \\times 0.1) + (1 \\times 0.89) + (11 \\times 0.01) = 0 + 0.89 + 0.11 = 1$。均值与泊松基准相同。\n- 零概率: $\\mathbb{P}(Y=0) = 0.1$。与基准相比，$0.1 < \\exp(-1) \\approx 0.3679$。因此，该分布存在“零缺失”，而非零过多。\n- 方差: 首先，我们计算二阶矩 $\\mathrm{E}[Y^2]$。\n$\\mathrm{E}[Y^2] = (0^2 \\times 0.1) + (1^2 \\times 0.89) + (11^2 \\times 0.01) = 0 + 0.89 + (121 \\times 0.01) = 0.89 + 1.21 = 2.1$。\n方差为 $\\mathrm{Var}(Y) = \\mathrm{E}[Y^2] - (\\mathrm{E}[Y])^2 = 2.1 - 1^2 = 1.1$。\n因为 $\\mathrm{Var}(Y) = 1.1 > \\mathrm{E}[Y] = 1$，所以该分布是过度离散的。\n\n这个构造展示了一个随机变量 $Y$，它相对于其均值是过度离散的，但其零计数概率小于相应的泊松分布。因此，仅观察到过度离散不足以断定存在零过多。\n\n2) 我们被要求推导一个定义为泊松-伽马混合的负二项模型的边际概率 $\\mathbb{P}(Y=0)$。该模型由以下公式给出：\n$Y \\mid \\Theta \\sim \\mathrm{Poisson}(\\lambda\\Theta)$\n$\\Theta \\sim \\mathrm{Gamma}(\\text{shape}=k, \\text{rate}=k)$\n\n边际概率 $\\mathbb{P}(Y=0)$ 是通过对脆弱性参数 $\\Theta$ 的分布求条件概率 $\\mathbb{P}(Y=0|\\Theta)$ 的平均得到的。\n$\\Theta \\sim \\mathrm{Gamma}(\\text{shape}=\\alpha, \\text{rate}=\\beta)$ 的概率密度函数 (PDF) 是 $f(\\theta; \\alpha, \\beta) = \\frac{\\beta^\\alpha}{\\Gamma(\\alpha)}\\theta^{\\alpha-1}\\exp(-\\beta\\theta)$，对于 $\\theta > 0$。在我们的情况下，$\\alpha=k$ 且 $\\beta=k$，所以 $\\Theta$ 的 PDF 是：\n$$f_{\\Theta}(\\theta) = \\frac{k^k}{\\Gamma(k)}\\theta^{k-1}\\exp(-k\\theta)$$\n对于均值为 $\\mu$ 的泊松分布，结果为零的概率是 $\\exp(-\\mu)$。在这里，条件均值是 $\\lambda\\Theta$，所以条件零概率是：\n$$\\mathbb{P}(Y=0|\\Theta=\\theta) = \\exp(-\\lambda\\theta)$$\n为了找到边际概率，我们计算条件概率关于 $\\Theta$ 的期望：\n$$\\mathbb{P}(Y=0) = \\mathrm{E}_{\\Theta}[\\mathbb{P}(Y=0|\\Theta)] = \\int_0^\\infty \\mathbb{P}(Y=0|\\Theta=\\theta) f_{\\Theta}(\\theta) d\\theta$$\n代入条件概率和 $\\Theta$ 的 PDF 表达式：\n$$\\mathbb{P}(Y=0) = \\int_0^\\infty \\exp(-\\lambda\\theta) \\left( \\frac{k^k}{\\Gamma(k)}\\theta^{k-1}\\exp(-k\\theta) \\right) d\\theta$$\n我们可以合并指数项并将常数移到积分外：\n$$\\mathbb{P}(Y=0) = \\frac{k^k}{\\Gamma(k)} \\int_0^\\infty \\theta^{k-1} \\exp(-k\\theta - \\lambda\\theta) d\\theta$$\n$$\\mathbb{P}(Y=0) = \\frac{k^k}{\\Gamma(k)} \\int_0^\\infty \\theta^{k-1} \\exp(-(\\lambda+k)\\theta) d\\theta$$\n该积分是伽马分布归一化常数的核心部分。我们使用恒等式 $\\int_0^\\infty x^{\\alpha-1}\\exp(-\\beta x)dx = \\frac{\\Gamma(\\alpha)}{\\beta^\\alpha}$。此处，$\\alpha=k$ 且 $\\beta=\\lambda+k$。\n应用此恒等式，积分计算结果为：\n$$\\int_0^\\infty \\theta^{k-1} \\exp(-(\\lambda+k)\\theta) d\\theta = \\frac{\\Gamma(k)}{(\\lambda+k)^k}$$\n将此结果代回我们的 $\\mathbb{P}(Y=0)$ 表达式中：\n$$\\mathbb{P}(Y=0) = \\frac{k^k}{\\Gamma(k)} \\left( \\frac{\\Gamma(k)}{(\\lambda+k)^k} \\right) = \\frac{k^k}{(\\lambda+k)^k}$$\n因此，边际零概率的闭式表达式是：\n$$\\mathbb{P}(Y=0) = \\left(\\frac{k}{\\lambda+k}\\right)^k$$\n对于给定的队列，我们有平均计数 $\\lambda=2.4$ 和离散参数 $k=1.5$。我们对推导出的表达式进行数值计算：\n$$\\mathbb{P}(Y=0) = \\left(\\frac{1.5}{2.4+1.5}\\right)^{1.5} = \\left(\\frac{1.5}{3.9}\\right)^{1.5} = \\left(\\frac{5}{13}\\right)^{1.5}$$\n计算该值：\n$$\\left(\\frac{5}{13}\\right)^{1.5} \\approx (0.38461538)^{1.5} \\approx 0.23853535$$\n将此结果四舍五入到四位有效数字得到 $0.2385$。", "answer": "$$\\boxed{0.2385}$$", "id": "4993564"}, {"introduction": "在拟合了零膨胀泊松（Zero-Inflated Poisson, ZIP）模型后，一项关键的解释任务是判断观测到的零计数的性质。本练习将应用贝叶斯定理，计算一个给定的零值是来自“结构性”部分的后验概率，还是来自泊松部分的“抽样”零。掌握这一计算过程，能够让您深刻理解ZIP模型如何对数据进行划分。[@problem_id:4993558]", "problem": "一个医院系统使用零膨胀泊松 (ZIP) 模型对因哮喘急性发作导致的月度急诊就诊次数进行建模。ZIP 模型假设了以下生成机制：对于患者 $i$，其处于结构性零状态的概率为 $\\pi_i$，此时观测计数 $Y_i$ 必然为 $0$；否则，其计数来自均值为 $\\lambda_i$ 的泊松分布，概率为 $1 - \\pi_i$。结构性零概率 $\\pi_i$ 通过逻辑 (logit) 链接与协变量相连，泊松均值 $\\lambda_i$ 通过对数 (log) 链接与协变量相连，这两种链接都是广义线性模型中的标准做法。\n\n对于单个患者 $i$，假设拟合的协变量模型为\n$$\\mathrm{logit}(\\pi_i) = \\alpha_0 + \\alpha_1 \\,\\mathrm{Prophylaxis}_i + \\alpha_2 \\,\\mathrm{Immunocompromised}_i + \\alpha_3 \\,\\mathrm{PriorExacerbation}_i,$$\n$$\\ln(\\lambda_i) = \\beta_0 + \\beta_1 \\,\\mathrm{Smoking}_i + \\beta_2 \\,\\frac{\\mathrm{Age}_i}{10} + \\beta_3 \\,\\mathrm{Prophylaxis}_i + \\beta_4 \\,\\mathrm{ComorbidityIndex}_i.$$\n\n假设一项经过验证的研究给出了以下估计系数：\n$$\\alpha_0 = -0.5,\\quad \\alpha_1 = 0.8,\\quad \\alpha_2 = 0.4,\\quad \\alpha_3 = -0.6,$$\n$$\\beta_0 = -0.6,\\quad \\beta_1 = 0.4,\\quad \\beta_2 = 0.05,\\quad \\beta_3 = -0.3,\\quad \\beta_4 = 0.1.$$\n\n对于我们关注的患者，其协变量值为\n$$\\mathrm{Prophylaxis}_i = 1,\\quad \\mathrm{Immunocompromised}_i = 0,\\quad \\mathrm{PriorExacerbation}_i = 0,$$\n$$\\mathrm{Smoking}_i = 1,\\quad \\mathrm{Age}_i = 60,\\quad \\mathrm{ComorbidityIndex}_i = 2.$$\n\n在某个月份，观测到的计数为 $y_i = 0$。从 ZIP 模型的混合定义和贝叶斯法则出发，使用上述拟合模型所隐含的 $(\\pi_i,\\lambda_i)$，推导并计算这个观测到的零来自结构性零部分而非泊松部分的后验概率。请将最终答案表示为小数，并四舍五入到四位有效数字。", "solution": "此问题要求在零膨胀泊松 (ZIP) 模型的框架内计算后验概率。具体来说，给定观测计数为零，我们需要确定这个零源自模型的“结构性零”部分而非“计数”（泊松）部分的概率。这可以使用贝叶斯法则来解决。\n\n设 $Y_i$ 为代表患者 $i$ 急诊就诊次数的随机变量。ZIP 模型假设了两个过程的混合。我们可以引入一个潜伏二元变量 $S_i$ 来指示观测值来自哪个部分。\n设 $S_i = 1$ 表示患者属于结构性零组（在给定情境下为“恒为零”的患者）。此事件的概率为 $P(S_i=1) = \\pi_i$。\n设 $S_i = 0$ 表示患者属于“风险”组，其计数遵循泊松分布。此事件的概率为 $P(S_i=0) = 1-\\pi_i$。\n\n该模型定义如下：\n- 如果 $S_i=1$，则观测计数 $Y_i$ 必然为 $0$。因此，条件概率为 $P(Y_i=0 | S_i=1) = 1$。\n- 如果 $S_i=0$，则计数 $Y_i$ 遵循均值为 $\\lambda_i$ 的泊松分布，即 $Y_i | (S_i=0) \\sim \\mathrm{Poisson}(\\lambda_i)$。其概率质量函数为 $P(Y_i=k | S_i=0) = \\frac{\\exp(-\\lambda_i)\\lambda_i^k}{k!}$，其中 $k \\in \\{0, 1, 2, ...\\}$。\n\n问题指出，对于我们关注的患者，观测计数为 $y_i = 0$。我们需要求解这个零是结构性零的后验概率，即 $P(S_i=1 | Y_i=0)$。\n\n根据贝叶斯法则，该后验概率由下式给出：\n$$P(S_i=1 | Y_i=0) = \\frac{P(Y_i=0 | S_i=1) P(S_i=1)}{P(Y_i=0)}$$\n此方程中的各项为：\n- $P(S_i=1) = \\pi_i$，即属于结构性零组的先验概率。\n- $P(Y_i=0 | S_i=1) = 1$，由模型定义。\n- $P(Y_i=0)$ 是观测到零的总概率，可使用全概率定律求得：\n$$P(Y_i=0) = P(Y_i=0 | S_i=1)P(S_i=1) + P(Y_i=0 | S_i=0)P(S_i=0)$$\n项 $P(Y_i=0 | S_i=0)$ 是从泊松部分观测到零的概率，即：\n$$P(Y_i=0 | S_i=0) = \\frac{\\exp(-\\lambda_i)\\lambda_i^0}{0!} = \\exp(-\\lambda_i)$$\n将各部分代入全概率定律，得到：\n$$P(Y_i=0) = (1)(\\pi_i) + (\\exp(-\\lambda_i))(1-\\pi_i) = \\pi_i + (1-\\pi_i)\\exp(-\\lambda_i)$$\n现在，我们可以写出所需后验概率的最终表达式：\n$$P(S_i=1 | Y_i=0) = \\frac{1 \\cdot \\pi_i}{\\pi_i + (1-\\pi_i)\\exp(-\\lambda_i)}$$\n\n下一步是使用给定的协变量模型和估计系数来计算该患者特有的参数 $\\pi_i$ 和 $\\lambda_i$。\n\n首先，我们计算结构性零概率 $\\pi_i$ 的线性预测器：\n$$\\mathrm{logit}(\\pi_i) = \\alpha_0 + \\alpha_1 \\,\\mathrm{Prophylaxis}_i + \\alpha_2 \\,\\mathrm{Immunocompromised}_i + \\alpha_3 \\,\\mathrm{PriorExacerbation}_i$$\n代入给定的系数和协变量值：\n$$\\mathrm{logit}(\\pi_i) = -0.5 + (0.8)(1) + (0.4)(0) + (-0.6)(0) = -0.5 + 0.8 = 0.3$$\n为了求出 $\\pi_i$，我们应用反logit (逻辑) 函数：\n$$\\pi_i = \\mathrm{logit}^{-1}(0.3) = \\frac{\\exp(0.3)}{1 + \\exp(0.3)}$$\n\n接下来，我们计算泊松均值 $\\lambda_i$ 的线性预测器：\n$$\\ln(\\lambda_i) = \\beta_0 + \\beta_1 \\,\\mathrm{Smoking}_i + \\beta_2 \\,\\frac{\\mathrm{Age}_i}{10} + \\beta_3 \\,\\mathrm{Prophylaxis}_i + \\beta_4 \\,\\mathrm{ComorbidityIndex}_i$$\n代入给定的系数和协变量值：\n$$\\ln(\\lambda_i) = -0.6 + (0.4)(1) + (0.05)\\left(\\frac{60}{10}\\right) + (-0.3)(1) + (0.1)(2)$$\n$$\\ln(\\lambda_i) = -0.6 + 0.4 + (0.05)(6) - 0.3 + 0.2$$\n$$\\ln(\\lambda_i) = -0.6 + 0.4 + 0.3 - 0.3 + 0.2 = 0$$\n为了求出 $\\lambda_i$，我们应用反对数 (指数) 函数：\n$$\\lambda_i = \\exp(0) = 1$$\n\n现在，我们将 $\\pi_i$ 的表达式和 $\\lambda_i$ 的值代入我们的后验概率公式。为简化计算，我们可以将分子和分母同乘以 $(1 + \\exp(0.3))$：\n$$P(S_i=1 | Y_i=0) = \\frac{\\frac{\\exp(0.3)}{1 + \\exp(0.3)}}{\\frac{\\exp(0.3)}{1 + \\exp(0.3)} + \\left(1 - \\frac{\\exp(0.3)}{1 + \\exp(0.3)}\\right)\\exp(-1)}$$\n$$P(S_i=1 | Y_i=0) = \\frac{\\frac{\\exp(0.3)}{1 + \\exp(0.3)}}{\\frac{\\exp(0.3)}{1 + \\exp(0.3)} + \\frac{1}{1 + \\exp(0.3)}\\exp(-1)}$$\n$$P(S_i=1 | Y_i=0) = \\frac{\\exp(0.3)}{\\exp(0.3) + \\exp(-1)}$$\n现在我们计算数值：\n$$\\exp(0.3) \\approx 1.3498588$$\n$$\\exp(-1) \\approx 0.3678794$$\n$$P(S_i=1 | Y_i=0) \\approx \\frac{1.3498588}{1.3498588 + 0.3678794} = \\frac{1.3498588}{1.7177382} \\approx 0.7858310$$\n根据要求，将结果四舍五入到四位有效数字，我们得到 $0.7858$。\n\n这个值表示，在给定模型及其特定协变量的情况下，该患者观测到的零计数是由于其处于结构性零状态的后验概率。", "answer": "$$\\boxed{0.7858}$$", "id": "4993558"}, {"introduction": "一个模型的优劣取决于它对数据的拟合程度。这项动手编程练习要求您从第一性原理出发，推导并实现ZIP和Hurdle模型的皮尔逊（Pearson）残差和偏差（deviance）残差。这不仅将考验您对模型结构（均值、方差和概率质量函数）的理解，还将使您掌握模型评估这一基本技能。[@problem_id:4993527]", "problem": "考虑从临床事件中生成的计数结果，其中数据表现出超出标准泊松模型预测的过多零值。两种广泛使用的方法是零膨胀泊松 (ZIP) 模型和跨栏模型。您需要构建一个程序，该程序能针对指定的参数值和观测计数，计算两种模型下的皮尔逊残差和偏差残差，并为给定的测试套件汇总结果。您的推导和实现必须从以下基本依据出发：混合分布定义、全期望定律、全方差定律、概率质量函数的定义，以及源于似然贡献的残差定义。\n\n定义与建模设置：\n- ZIP 模型假设观测值 $Y$ 来自一个混合过程，该过程以概率 $\\pi \\in (0,1)$ 产生结构性零，并以概率 $1-\\pi$ 来自一个速率为 $\\lambda \\in (0,\\infty)$ 的泊松过程。其概率质量函数 (PMF) 定义为 $P(Y=0)=\\pi+(1-\\pi)\\exp(-\\lambda)$ 和 $P(Y=y)= (1-\\pi)\\exp(-\\lambda)\\lambda^y/y!$（对于 $y \\in \\{1,2,3,\\ldots\\}$）。期望值 $E[Y]$ 和方差 $\\operatorname{Var}(Y)$ 必须通过将全期望定律和全方差定律应用于该混合设定来获得，而不是通过简化公式。\n- 跨栏模型假设一个两部分过程：一个以概率 $\\pi_h \\in (0,1)$ 产生结构性零的过程，和一个以概率 $1-\\pi_h$ 产生正计数的过程。在观测值为正的条件下，$Y$ 服从速率为 $\\lambda \\in (0,\\infty)$ 的零截断泊松 (ZTP) 分布，即条件概率质量函数为 $P(Y=y \\mid Y>0) = \\left[\\exp(-\\lambda)\\lambda^y/y!\\right]/\\left[1-\\exp(-\\lambda)\\right]$（对于 $y \\in \\{1,2,3,\\ldots\\}$）。跨栏模型的无条件概率质量函数为 $P(Y=0)=\\pi_h$ 和 $P(Y=y>0)=(1-\\pi_h)P(Y=y \\mid Y>0)$。期望值 $E[Y]$ 和方差 $\\operatorname{Var}(Y)$ 必须通过全期望定律和全方差定律，从混合结构和截断正计数分布中推导出来。\n\n待计算的残差：\n- 单个观测值 $y$ 的皮尔逊残差为 $r_P = \\dfrac{y - \\mu}{\\sqrt{\\sigma^2}}$，其中 $\\mu = E[Y]$ 和 $\\sigma^2 = \\operatorname{Var}(Y)$ 是在指定模型和参数下计算的。\n- 单个观测值 $y$ 的偏差残差为 $r_D = \\operatorname{sign}(y - \\mu)\\sqrt{2\\left(\\ell_\\text{sat}(y) - \\ell(y;\\theta)\\right)}$，其中 $\\ell(y;\\theta)$ 是指定模型下参数为 $\\theta$ 的对数似然贡献，$\\ell_\\text{sat}(y)$ 是饱和对数似然贡献。对于此处考虑的混合计数模型，饱和对数似然将单位概率质量置于实现的观测结果上，从而得到 $\\ell_\\text{sat}(y)=0$，因此偏差残差简化为 $r_D = \\operatorname{sign}(y - \\mu)\\sqrt{-2\\log p(y;\\theta)}$，其中 $p(y;\\theta)$ 是在 $y$ 处求值的模型概率质量函数。您的计算必须明确使用 ZIP 或跨栏模型的相应 PMF，并分别使用混合质量处理 $y=0$ 的情况，以及使用泊松或零截断泊松项处理 $y>0$ 的情况，而不使用任何预先简化的捷径。\n\n解释要求：\n- 在 ZIP 模型设定下，解释 $r_P$ 和 $r_D$ 如何反映零膨胀参数 $\\pi$ 对离散度以及在 $y=0$ 与 $y>0$ 处的似然贡献的影响。\n- 在跨栏模型设定下，解释正值部分的截断如何改变 $y>0$ 的参考均值和方差，以及与非截断模型相比，这如何影响 $r_P$ 和 $r_D$，尤其是在 $\\lambda$ 较小的情况下。\n\n您的程序必须以数值上稳定的方式实现计算。在计算对数似然贡献时，使用能够避免小概率导致数值下溢的求和与对数运算。对于阶乘项，使用伽马函数的对数来计算 $\\log(y!)$ 以避免精度损失。对于零值的混合概率，使用数值稳定的求和方法来计算 $\\log\\left(\\pi + (1-\\pi)\\exp(-\\lambda)\\right)$。\n\n测试套件：\n为以下每个参数集计算 $(r_P,r_D)$，参数集以有序四元组 $(\\text{模型}, y, \\pi\\text{ 或 }\\pi_h, \\lambda)$ 的形式表示：\n- 案例 1：$($ZIP$,\\, y=$3$,\\, \\pi=$0.2$,\\, \\lambda=$2.5$)$\n- 案例 2：$($ZIP$,\\, y=$0$,\\, \\pi=$0.85$,\\, \\lambda=$0.7$)$\n- 案例 3：$($ZIP$,\\, y=$10$,\\, \\pi=$0.1$,\\, \\lambda=$1.2$)$\n- 案例 4：$($跨栏$,\\, y=$2$,\\, \\pi_h=$0.3$,\\, \\lambda=$1.8$)$\n- 案例 5：$($跨栏$,\\, y=$0$,\\, \\pi_h=$0.05$,\\, \\lambda=$0.2$)$\n- 案例 6：$($跨栏$,\\, y=$7$,\\, \\pi_h=$0.6$,\\, \\lambda=$3.0$)$\n\n输出要求：\n- 对于每个案例，返回一个列表 $[r_P, r_D]$，两个值均四舍五入至 6 位小数。\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，列表中的每个元素是对应案例的 $[r_P, r_D]$ 对，顺序与测试套件相同（例如 $[[r_{P,1},r_{D,1}],[r_{P,2},r_{D,2}],\\dots]$）。\n- 所有概率参数在内部处理和报告时必须为小数或分数，不得使用百分号。\n\n您的解决方案必须从基本依据出发，清楚地论证代码中实现的每个公式，并讨论在存在过多零值以及（对于跨栏模型）正计数截断的情况下残差的解释。不允许使用外部数据或用户输入，也不得在问题陈述中超出所列基本依据使用任何提示或简化公式。", "solution": "该问题陈述已经过严格验证，被认为是科学上可靠、良构且客观的。它提出了一个统计建模中的标准任务，尽管细节详尽。所有关于零膨胀泊松 (ZIP) 模型和跨栏模型的定义都是正确的，并且所要求的推导都基于基本的统计学原理。测试套件的参数定义明确且在有效范围内。因此，我将继续提供完整的解决方案。\n\n解决方案的结构如下：首先，我们从指定的基本原理出发，为 ZIP 和跨栏模型推导必要的属性（概率质量函数、均值、方差）。其次，我们形式化皮尔逊残差和偏差残差的定义。第三，我们讨论在这些模型的背景下对这些残差的解释。最后，我们将这些公式应用于提供的测试案例。\n\n**1. 理论推导**\n\n**1.1. 零膨胀泊松 (ZIP) 模型**\n\nZIP 模型将观测值 $Y$ 概念化为一个来自两状态混合过程的结果。设 $Z$ 是一个伯努利随机变量，其中 $P(Z=1) = \\pi$ 且 $P(Z=0) = 1-\\pi$。如果 $Z=1$，则结果为“结构性零”，即 $Y=0$。如果 $Z=0$，则结果 $Y$ 从一个速率为 $\\lambda$ 的泊松分布中抽取，记为 $Y_P \\sim \\text{Poisson}(\\lambda)$。\n\n**概率质量函数 (PMF):**\nPMF, $p(y;\\pi,\\lambda) = P(Y=y)$, 使用全概率定律推导：\n$P(Y=y) = P(Y=y|Z=1)P(Z=1) + P(Y=y|Z=0)P(Z=0)$.\n对于 $y=0$:\n$$P(Y=0) = (1)\\cdot\\pi + P(Y_P=0)\\cdot(1-\\pi) = \\pi + (1-\\pi)e^{-\\lambda}$$\n对于整数 $y > 0$:\n$$P(Y=y) = (0)\\cdot\\pi + P(Y_P=y)\\cdot(1-\\pi) = (1-\\pi)\\frac{e^{-\\lambda}\\lambda^y}{y!}$$\n\n**期望值 ($E[Y]$):**\n使用全期望定律, $\\mu = E[Y] = E[E[Y|Z]]$:\n条件期望为 $E[Y|Z=1]=0$ 和 $E[Y|Z=0]=E[Y_P]=\\lambda$。\n$$ \\mu = E[Y|Z=1]P(Z=1) + E[Y|Z=0]P(Z=0) = 0 \\cdot \\pi + \\lambda \\cdot (1-\\pi) = (1-\\pi)\\lambda $$\n\n**方差 ($\\operatorname{Var}(Y)$):**\n使用全方差定律, $\\sigma^2 = \\operatorname{Var}(Y) = E[\\operatorname{Var}(Y|Z)] + \\operatorname{Var}(E[Y|Z])$:\n条件方差为 $\\operatorname{Var}(Y|Z=1)=0$ 和 $\\operatorname{Var}(Y|Z=0)=\\operatorname{Var}(Y_P)=\\lambda$。\n第一项是 $E[\\operatorname{Var}(Y|Z)] = 0 \\cdot \\pi + \\lambda \\cdot (1-\\pi) = (1-\\pi)\\lambda$。\n第二项, $\\operatorname{Var}(E[Y|Z])$, 是一个随机变量的方差，该随机变量以概率 $\\pi$ 取值 $E[Y|Z=1]=0$，以概率 $1-\\pi$ 取值 $E[Y|Z=0]=\\lambda$。\n$E[E[Y|Z]] = \\mu = (1-\\pi)\\lambda$。\n$E[(E[Y|Z])^2] = 0^2 \\cdot \\pi + \\lambda^2 \\cdot (1-\\pi) = (1-\\pi)\\lambda^2$。\n$\\operatorname{Var}(E[Y|Z]) = E[(E[Y|Z])^2] - (E[E[Y|Z]])^2 = (1-\\pi)\\lambda^2 - ((1-\\pi)\\lambda)^2 = (1-\\pi)\\lambda^2 - (1-\\pi)^2\\lambda^2 = \\lambda^2(1-\\pi)(1-(1-\\pi)) = \\pi(1-\\pi)\\lambda^2$。\n合并各项：\n$$ \\sigma^2 = (1-\\pi)\\lambda + \\pi(1-\\pi)\\lambda^2 = (1-\\pi)\\lambda(1+\\pi\\lambda) $$\n该方差大于均值，表明了 ZIP 模型的过度离散特征。\n\n**1.2. 跨栏模型**\n\n跨栏模型是一个两部分模型。一个二元过程决定了计数是零还是正数。假设此过程由一个伯努利试验控制，结果为零的概率为 $\\pi_h$。如果结果为正（概率为 $1-\\pi_h$），则计数 $y$ 服从速率为 $\\lambda$ 的零截断泊松 (ZTP) 分布。\n\n**ZTP 分布的 PMF:**\n如果一个随机变量 $Y^*$ 的 PMF 对于 $y \\in \\{1, 2, \\dots\\}$ 由下式给出，则它服从 ZTP 分布：\n$$ P(Y^*=y) = P(\\text{Poisson}=y | \\text{Poisson}>0) = \\frac{P(\\text{Poisson}=y)}{P(\\text{Poisson}>0)} = \\frac{e^{-\\lambda}\\lambda^y/y!}{1-e^{-\\lambda}} $$\n\n**ZTP 分布的矩:**\n期望值 $E[Y^*]$ 为：\n$$ E[Y^*] = \\frac{1}{1-e^{-\\lambda}} \\sum_{k=1}^{\\infty} k \\frac{e^{-\\lambda}\\lambda^k}{k!} = \\frac{e^{-\\lambda}}{1-e^{-\\lambda}} \\sum_{k=1}^{\\infty} \\frac{\\lambda^k}{(k-1)!} = \\frac{e^{-\\lambda}\\lambda}{1-e^{-\\lambda}} \\sum_{j=0}^{\\infty} \\frac{\\lambda^j}{j!} = \\frac{e^{-\\lambda}\\lambda e^{\\lambda}}{1-e^{-\\lambda}} = \\frac{\\lambda}{1-e^{-\\lambda}} $$\n类似地，二阶原点矩为 $E[(Y^*)^2] = \\frac{\\lambda+\\lambda^2}{1-e^{-\\lambda}}$。\n方差为 $\\operatorname{Var}(Y^*) = E[(Y^*)^2] - (E[Y^*])^2 = \\frac{\\lambda+\\lambda^2}{1-e^{-\\lambda}} - \\left(\\frac{\\lambda}{1-e^{-\\lambda}}\\right)^2$。\n\n**跨栏模型的无条件 PMF:**\n对于 $y=0$:\n$$ P(Y=0) = \\pi_h $$\n对于整数 $y > 0$:\n$$ P(Y=y) = (1-\\pi_h)P(Y^*=y) = (1-\\pi_h)\\frac{e^{-\\lambda}\\lambda^y/y!}{1-e^{-\\lambda}} $$\n\n**期望值 ($E[Y]$):**\n使用全期望定律，其中两个状态是“零计数”和“正计数”：\n$$ \\mu = E[Y] = 0 \\cdot P(Y=0) + E[Y^*] \\cdot P(Y>0) = E[Y^*](1-\\pi_h) = (1-\\pi_h)\\frac{\\lambda}{1-e^{-\\lambda}} $$\n\n**方差 ($\\operatorname{Var}(Y)$):**\n使用全方差定律, $\\sigma^2 = E[\\operatorname{Var}(Y|\\text{state})] + \\operatorname{Var}(E[Y|\\text{state}])$。\n$E[Y|\\text{零状态}] = 0$ 且 $\\operatorname{Var}(Y|\\text{零状态}) = 0$。\n$E[Y|\\text{正状态}] = E[Y^*]$ 且 $\\operatorname{Var}(Y|\\text{正状态}) = \\operatorname{Var}(Y^*)$。\n$E[\\operatorname{Var}(Y|\\text{state})] = 0 \\cdot \\pi_h + \\operatorname{Var}(Y^*) \\cdot (1-\\pi_h) = (1-\\pi_h)\\operatorname{Var}(Y^*)$。\n$\\operatorname{Var}(E[Y|\\text{state}])$ 是一个变量的方差，该变量以概率 $\\pi_h$ 取值 0，以概率 $1-\\pi_h$ 取值 $E[Y^*]$。\n$\\operatorname{Var}(E[Y|\\text{state}]) = E[(E[Y|\\text{state}])^2] - (E[E[Y|\\text{state}]])^2 = (1-\\pi_h)(E[Y^*])^2 - ((1-\\pi_h)E[Y^*])^2 = \\pi_h(1-\\pi_h)(E[Y^*])^2$。\n合并各项：\n$$ \\sigma^2 = (1-\\pi_h)\\operatorname{Var}(Y^*) + \\pi_h(1-\\pi_h)(E[Y^*])^2 $$\n代入 ZTP 的矩即可得到方差的完整表达式。\n\n**1.3. 残差定义**\n\n残差衡量了观测值 $y$ 与模型预测值之间的差异。\n**皮尔逊残差 ($r_P$):**\n该残差是观测值与模型期望值之间的标准化差异。\n$$ r_P = \\frac{y - \\mu}{\\sqrt{\\sigma^2}} $$\n其中 $\\mu=E[Y]$ 和 $\\sigma^2=\\operatorname{Var}(Y)$ 是在指定模型（ZIP 或跨栏）下的均值和方差。\n\n**偏差残差 ($r_D$):**\n该残差基于观测值对对数似然函数的贡献。\n$$ r_D = \\operatorname{sign}(y - \\mu)\\sqrt{2\\left(\\ell_\\text{sat}(y) - \\ell(y;\\theta)\\right)} $$\n这里，$\\theta$ 表示模型参数（例如 $\\{\\pi, \\lambda\\}$）。饱和对数似然 $\\ell_\\text{sat}(y)$ 对应于一个能完美拟合数据点的模型，对于离散观测值 $y$ 而言，这意味着为该结果分配概率 1。因此，$p_\\text{sat}(y)=1$ 且 $\\ell_\\text{sat}(y) = \\log(1) = 0$。公式简化为：\n$$ r_D = \\operatorname{sign}(y - \\mu)\\sqrt{-2\\ell(y;\\theta)} = \\operatorname{sign}(y - \\mu)\\sqrt{-2\\log p(y;\\theta)} $$\n其中 $p(y;\\theta)$ 是指定模型的 PMF。\n\n**2. 残差的解释**\n\n**ZIP 模型：** 零膨胀参数 $\\pi$ 显式地对过多的零值进行建模。\n- 其对 $r_P$ 的影响：方差 $\\sigma^2=(1-\\pi)\\lambda(1+\\pi\\lambda)$ 是一个关键组成部分。随着 $\\pi$ 的增加，通常会增加过度离散程度，导致对于给定的泊松速率 $\\lambda$，方差 $\\sigma^2$ 更大。$r_P$ 中这个更大的分母可能会缩小残差的量级，反映了模型对更高变异性的内在预期。\n- 其对 $r_D$ 的影响：对于观测值 $y=0$，PMF 为 $p(0) = \\pi+(1-\\pi)e^{-\\lambda}$。更大的 $\\pi$ 会增加 $p(0)$，使 $\\log p(0)$ 更接近 0。这导致偏差残差更小，表明模型认为这个零值是一个良好的拟合。对于观测值 $y>0$，PMF 为 $p(y)=(1-\\pi) \\frac{e^{-\\lambda}\\lambda^y}{y!}$。更大的 $\\pi$ 会降低这个概率，使 $\\log p(y)$ 更负，从而增加偏差残差，表明拟合效果更差。因此，参数 $\\pi$ 在零计数和非零计数之间调节模型的拟合优度。\n\n**跨栏模型：** 跨栏模型将零生成过程与正计数生成过程分开。\n- 截断的影响：正值部分服从 ZTP 分布，其均值 $E[Y^*] = \\lambda/(1-e^{-\\lambda})$ 严格大于未截断泊松分布的均值 $\\lambda$。当 $\\lambda$ 较小时，这种差异最为显著。例如，当 $\\lambda \\to 0$ 时，$E[Y^*] \\to 1$，而 $\\lambda \\to 0$。ZTP 模型“知道”一个正的结果必须至少为 1，因此其期望向上移动。整个模型的均值 $\\mu = (1-\\pi_h)E[Y^*]$ 反映了这一点。\n- 对残差的影响：在为正观测值 $y>0$ 计算残差时，跨栏模型使用的参考均值 $\\mu$ 和对数似然 $\\log p(y)$ 是以计数为正为条件的。与非截断模型（如标准泊松模型甚至 ZIP 模型）相比，跨栏模型对于一个小的正计数（例如 $y=1$）的条件概率更高，尤其是在 $\\lambda$ 较小的情况下。这导致此类计数的偏差残差更小。皮尔逊残差也受到影响，因为分子 $y-\\mu$ 是相对于过程正值部分的更高有效均值计算的。\n\n**3. 数值实现说明**\n\n为了进行稳健的计算，以下是必要的：\n- 术语 $\\log(y!)$ 通过使用对数伽马函数 `gammaln(y+1)` 进行计算，以保持精度并避免大 $y$ 值的上溢。\n- ZIP 模型在 $y=0$ 处的对数 PMF, $\\log(\\pi + (1-\\pi)e^{-\\lambda})$, 使用 log-sum-exp 操作来计算以避免下溢：$\\log(e^{\\log(\\pi)} + e^{\\log(1-\\pi)-\\lambda})$。\n- 跨栏模型在 $y>0$ 处的对数 PMF 涉及项 $\\log(1-e^{-\\lambda})$，当 $\\lambda$ 较小时，为保持数值稳定性，该项计算为 `log1p(-exp(-lambda))`。\n\n**4. 应用于测试案例**\n\n现在将推导出的公式应用于指定的测试套件。对于每个案例，我们计算模型均值 $\\mu$、方差 $\\sigma^2$ 和对数 PMF $\\ell(y;\\theta) = \\log p(y;\\theta)$，以求出残差 $r_P$ 和 $r_D$。\n\n- **案例 1：** (ZIP, $y=3$, $\\pi=0.2$, $\\lambda=2.5$)\n  - $\\mu = 2.0$, $\\sigma^2 = 3.0$\n  - $\\log p(3) = -1.766033$\n  - $r_P = (3 - 2.0) / \\sqrt{3.0} \\approx 0.577350$\n  - $r_D = \\operatorname{sign}(3 - 2.0)\\sqrt{-2(-1.766033)} \\approx 1.879379$\n\n- **案例 2：** (ZIP, $y=0$, $\\pi=0.85$, $\\lambda=0.7$)\n  - $\\mu = 0.105$, $\\sigma^2 = 0.167475$\n  - $\\log p(0) = -0.078490$\n  - $r_P = (0 - 0.105) / \\sqrt{0.167475} \\approx -0.256575$\n  - $r_D = \\operatorname{sign}(0 - 0.105)\\sqrt{-2(-0.078490)} \\approx -0.396207$\n\n- **案例 3：** (ZIP, $y=10$, $\\pi=0.1$, $\\lambda=1.2$)\n  - $\\mu = 1.08$, $\\sigma^2 = 1.2096$\n  - $\\log p(10) = -14.586558$\n  - $r_P = (10 - 1.08) / \\sqrt{1.2096} \\approx 8.110452$\n  - $r_D = \\operatorname{sign}(10 - 1.08)\\sqrt{-2(-14.586558)} \\approx 5.401214$\n\n- **案例 4：** (跨栏, $y=2$, $\\pi_h=0.3$, $\\lambda=1.8$)\n  - $\\mu = 1.509529$, $\\sigma^2 = 1.947978$\n  - $\\log p(2) = -1.493617$\n  - $r_P = (2 - 1.509529) / \\sqrt{1.947978} \\approx 0.351412$\n  - $r_D = \\operatorname{sign}(2 - 1.509529)\\sqrt{-2(-1.493617)} \\approx 1.728362$\n\n- **案例 5：** (跨栏, $y=0$, $\\pi_h=0.05$, $\\lambda=0.2$)\n  - $\\mu = 1.048160$, $\\sigma^2 = 0.159135$\n  - $\\log p(0) = -2.995732$\n  - $r_P = (0 - 1.048160) / \\sqrt{0.159135} \\approx -2.627519$\n  - $r_D = \\operatorname{sign}(0 - 1.048160)\\sqrt{-2(-2.995732)} \\approx -2.447747$\n\n- **案例 6：** (跨栏, $y=7$, $\\pi_h=0.6$, $\\lambda=3.0$)\n  - $\\mu = 1.262869$, $\\sigma^2 = 3.456592$\n  - $\\log p(7) = -6.994715$\n  - $r_P = (7 - 1.262869) / \\sqrt{3.456592} \\approx 3.085827$\n  - $r_D = \\operatorname{sign}(7 - 1.262869)\\sqrt{-2(-6.994715)} \\approx 3.740244$", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import gammaln\n\ndef solve():\n    \"\"\"\n    Computes Pearson and deviance residuals for ZIP and Hurdle models for a given test suite.\n    \"\"\"\n    test_cases = [\n        (\"ZIP\", 3, 0.2, 2.5),\n        (\"ZIP\", 0, 0.85, 0.7),\n        (\"ZIP\", 10, 0.1, 1.2),\n        (\"hurdle\", 2, 0.3, 1.8),\n        (\"hurdle\", 0, 0.05, 0.2),\n        (\"hurdle\", 7, 0.6, 3.0),\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        model, y, pi_param, lam = case\n        \n        mu = 0.0\n        var = 0.0\n        log_pmf = 0.0\n\n        if model == \"ZIP\":\n            pi = pi_param\n            # Expected value\n            mu = (1 - pi) * lam\n            \n            # Variance\n            var = (1 - pi) * lam * (1 + pi * lam)\n            \n            # Log-Probability Mass Function contribution\n            if y == 0:\n                # Use np.logaddexp for numerical stability: log(a+b) = log(exp(log(a)) + exp(log(b)))\n                log_p_zero_poisson = -lam\n                log_pmf = np.logaddexp(np.log(pi), np.log(1 - pi) + log_p_zero_poisson)\n            else:\n                log_pmf = np.log(1 - pi) - lam + y * np.log(lam) - gammaln(y + 1)\n        \n        elif model == \"hurdle\":\n            pi_h = pi_param\n            \n            if y == 0:\n                # For y=0, mean and variance of the whole distribution are needed for residuals\n                # but log_pmf is simple.\n                one_m_exp_lam = np.log1p(-np.exp(-lam))\n                mu_c = lam / (1 - np.exp(-lam)) # E[Y|Y>0]\n                mu = (1 - pi_h) * mu_c\n                \n                var_c = mu_c - (lam**2 * np.exp(-lam)) / (1 - np.exp(-lam))**2 # Var(Y|Y>0)\n                var = (1 - pi_h) * var_c + pi_h * (1 - pi_h) * mu_c**2\n                \n                log_pmf = np.log(pi_h)\n            else: # y > 0\n                # Mean and Variance for the whole distribution\n                # Note: log1p(-exp(-x)) is a stable way to compute log(1-exp(-x))\n                one_m_exp_lam = 1 - np.exp(-lam)\n                \n                mu_c = lam / one_m_exp_lam # E[Y|Y>0]\n                mu = (1 - pi_h) * mu_c\n                \n                var_c = mu_c - (lam**2 * np.exp(-lam)) / (one_m_exp_lam**2) # Var(Y|Y>0)\n                var = (1 - pi_h) * var_c + pi_h * (1 - pi_h) * mu_c**2\n\n                # Log-Probability Mass Function contribution\n                log_term_trunc = np.log1p(-np.exp(-lam))\n                log_pmf = np.log(1 - pi_h) - lam + y * np.log(lam) - gammaln(y + 1) - log_term_trunc\n\n        # Pearson residual\n        if var > 0:\n            r_p = (y - mu) / np.sqrt(var)\n        else: # Handle case of zero variance if it occurs\n            r_p = np.inf if y != mu else 0.0\n\n        # Deviance residual\n        r_d = np.sign(y - mu) * np.sqrt(-2 * log_pmf) if mu != y else 0.0\n        \n        # In the edge case y = mu, sign(0) is 0, so r_d becomes 0\n        if y == mu:\n            r_d = 0.0\n\n        results.append([round(r_p, 6), round(r_d, 6)])\n\n    # Format the final output string exactly as required\n    formatted_results = [f\"[{res[0]},{res[1]}]\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "4993527"}]}