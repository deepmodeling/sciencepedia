## 引言
在纵向医学研究中，患者的许多关键风险因素——如血压、治疗方案或生理标志物——并非静止不变，而是随着时间的推移而演变。标准的Cox比例风险模型假定协变量在研究开始时测量一次且保持不变，这在真实世界情景中往往是一个过于简化的假设，可能导致对风险的评估产生偏差。为了更精确地捕捉暴露与结局之间的动态关系，统计学家们将Cox模型扩展至能够容纳时变协变量（time-varying covariates, TVCs），从而极大地增强了其在复杂医学数据分析中的能力和现实意义。

本文旨在系统性地介绍在Cox模型中使用时变协变量的理论、应用与实践。读者将通过本文学习到如何从根本上理解和实施这一强大的统计工具，同时警惕其带来的挑战和潜在陷阱。文章将分为三个核心部分：

第一章“原则与机制”将深入探讨含时变协变量的[Cox模型](@entry_id:164053)的理论基础，包括其如何扩展[比例风险](@entry_id:166780)假定的概念，如何构建相应的偏[似然函数](@entry_id:141927)，以及在实践中处理此类数据所需的“[计数过程](@entry_id:260664)”格式。本章还将阐明可预测性条件等理论基石，并辨析不同类型的时变协变量及其解释上的差异。

第二章“应用与跨学科联系”将展示时变协变量模型在临床药理学、流行病学和因果推断等领域的广泛应用。通过真实案例，我们将看到如何利用该模型处理动态暴露、避免不朽时间偏倚，并将其整合到复发事件、[竞争风险](@entry_id:173277)和多状态模型等高级框架中。

第三章“动手实践”提供了一系列精心设计的计算练习，旨在通过具体操作加深读者对时变协变量如何影响[风险估计](@entry_id:754371)、如何正确构建数据以及如何识别潜在偏误的理解。

通过对这些内容的学习，您将能够自信地在自己的研究中应用时变协变量模型，从而从纵向数据中提取更丰富、更准确的科学见解。

## 原则与机制

在许多纵向医学研究中，个体的风险因素并非一成不变。例如，患者的血压、治疗方案或生活方式都可能随着时间演变。标准的Cox比例风险模型假定协变量在基线时被测量且在整个随访期间保持不变，这在许多情况下是不现实的。为了更准确地描述风险与动态变化的预测因子之间的关系，我们需要将Cox模型扩展到能容纳**时变协变量 (time-varying covariates, TVCs)** 的情况。本章将深入探讨在Cox模型中引入时变协变量的基本原则、理论基础、实现方式及其在解释和因果推断中带来的挑战。

### 扩展[Cox模型](@entry_id:164053)：时变协变量的概念

经典的Cox比例风险模型为我们提供了一个强大的框架，用于分析事件时间数据。其核心在于将个体的[风险函数](@entry_id:166593)（hazard function）$h_i(t)$ 分解为一个共同的**基线风险函数 (baseline hazard function)** $h_0(t)$ 和一个依赖于协变量的相对风险项。对于在基线时（$t=0$）测量的一组不随时间变化的协变量 $\mathbf{X}_i$，其风险函数表示为：

$$
h_i(t | \mathbf{X}_i) = h_0(t) \exp(\boldsymbol{\beta}' \mathbf{X}_i)
$$

其中，$\boldsymbol{\beta}$ 是[回归系数](@entry_id:634860)向量。该模型的一个关键特性是**[比例风险](@entry_id:166780) (proportional hazards)** 假定，即任意两个具有不同协变量向量 $\mathbf{X}_1$ 和 $\mathbf{X}_2$ 的个体，其风险比 (hazard ratio) 是一个不随时间变化的常数：

$$
\frac{h_1(t)}{h_2(t)} = \frac{h_0(t) \exp(\boldsymbol{\beta}' \mathbf{X}_1)}{h_0(t) \exp(\boldsymbol{\beta}' \mathbf{X}_2)} = \exp(\boldsymbol{\beta}' (\mathbf{X}_1 - \mathbf{X}_2))
$$

然而，当协变量本身随时间变化时，我们需要对模型进行扩展。令 $\mathbf{X}_i(t)$ 表示个体 $i$ 在时间 $t$ 的协变量向量。扩展后的Cox模型形式如下：

$$
h_i(t | \mathbf{X}_i(t)) = h_0(t) \exp(\boldsymbol{\beta}' \mathbf{X}_i(t))
$$

这个模型允许协变量的值在随访过程中动态更新。一个重要的概念问题随之而来：比例风险假定是否仍然成立？答案是肯定的，但需要以一种“瞬时”的方式来理解。在任何一个固定的时间点 $t$，两个体之间的风险比仅取决于他们在该时刻的协变量值，而与基线风险 $h_0(t)$ 无关 [@problem_id:4991901]。具体来说，在时间 $t$，个体1和个体2的风险比为：

$$
\frac{h_1(t)}{h_2(t)} = \frac{h_0(t) \exp(\boldsymbol{\beta}' \mathbf{X}_1(t))}{h_0(t) \exp(\boldsymbol{\beta}' \mathbf{X}_2(t))} = \exp(\boldsymbol{\beta}' (\mathbf{X}_1(t) - \mathbf{X}_2(t)))
$$

这个风险比可能随时间 $t$ 变化，但这种变化完全是通过协变量 $\mathbf{X}_i(t)$ 的变化来驱动的，而不是因为模型结构本身违背了比例性。如果两个个体的协变量轨迹完全相同，即对于所有时间 $u$，都有 $\mathbf{X}_1(u) = \mathbf{X}_2(u)$，那么他们在任何时刻 $t$ 的风险比都恒为1 [@problem_id:4991820]。因此，该模型保留了[风险函数](@entry_id:166593)在基线风险和协变量效应之间相乘分离的核心结构。

### 时变协变量下的[偏似然](@entry_id:165240)

Cox模型的核心优势在于其**[偏似然](@entry_id:165240) (partial likelihood)** 方法，该方法允许我们在不指定基线风险函数 $h_0(t)$ 的情况下估计回归系数 $\boldsymbol{\beta}$。这一优势在处理时变协变量时得以保留。

[偏似然](@entry_id:165240)的构建逻辑是基于在每个事件发生时刻的条件概率。假设研究中有 $J$ 个不同的事件时间，按顺序排列为 $t_1  t_2  \dots  t_J$。在每个事件时间 $t_j$，我们定义**风险集 (risk set)** $\mathcal{R}(t_j)$，它包含了在 $t_j$ 时刻之前仍然在随访中且未经历事件的所有个体。

在给定风险集 $\mathcal{R}(t_j)$ 中恰好发生一个事件的情况下，该事件发生在特定个体（我们称其为 $(j)$）身上的[条件概率](@entry_id:151013)，等于该个体的瞬时风险占风险集中所有个体瞬时风险总和的比例：

$$
P(\text{个体 } (j) \text{ 在 } t_j \text{ 发生事件} | \text{在 } \mathcal{R}(t_j) \text{ 中发生一个事件}) = \frac{h_{(j)}(t_j)}{\sum_{k \in \mathcal{R}(t_j)} h_k(t_j)}
$$

将时变协变量模型 $h_k(t_j) = h_0(t_j) \exp(\boldsymbol{\beta}' \mathbf{X}_k(t_j))$ 代入上式，基线风险项 $h_0(t_j)$ 会被约去：

$$
L_j(\boldsymbol{\beta}) = \frac{h_0(t_j) \exp(\boldsymbol{\beta}' \mathbf{X}_{(j)}(t_j))}{\sum_{k \in \mathcal{R}(t_j)} h_0(t_j) \exp(\boldsymbol{\beta}' \mathbf{X}_k(t_j))} = \frac{\exp(\boldsymbol{\beta}' \mathbf{X}_{(j)}(t_j))}{\sum_{k \in \mathcal{R}(t_j)} \exp(\boldsymbol{\beta}' \mathbf{X}_k(t_j))}
$$

总的偏似然函数就是所有事件时间点上的这些条件概率的乘积：

$$
L(\boldsymbol{\beta}) = \prod_{j=1}^{J} L_j(\boldsymbol{\beta}) = \prod_{j=1}^{J} \frac{\exp(\boldsymbol{\beta}' \mathbf{X}_{(j)}(t_j))}{\sum_{k \in \mathcal{R}(t_j)} \exp(\boldsymbol{\beta}' \mathbf{X}_k(t_j))}
$$

这个公式揭示了时变协变量如何融入估计过程 [@problem_id:4991825]。关键在于：在计算每个事件时间 $t_j$ 的似然贡献时，我们必须使用事件发生者 $(j)$ 在该时刻的协变量值 $\mathbf{X}_{(j)}(t_j)$，以及风险集中所有其他成员 $k$ 在**同一时刻**的协变量值 $\mathbf{X}_k(t_j)$。这意味着模型在每个事件点上，都将事件发生者的当前风险状况与所有当时可能发生事件者的风险状况进行比较。

### 实践中的实现：[计数过程](@entry_id:260664)（开始-停止）数据格式

理论上，为了计算[偏似然](@entry_id:165240)，我们需要在每个事件时间点上知道风险集中所有个体的协变量值。在实践中，如果协变量是连续变化的，这将无法实现。幸运的是，在大多数应用中，协变量的值是在离散的时间点上发生变化的，例如，在每次诊所访问时更新的生物标志物值，或是开始或停止用药的时刻。

为了让统计软件能够处理这类数据，我们需要将每个个体的随访历史分割成多个时间段，在每个时间段内，所有协变量的值都保持不变。这种数据结构被称为**[计数过程](@entry_id:260664) (counting process)** 或**开始-停止 (start-stop)** 格式 [@problem_id:4991780]。

具体来说，对于一个个体 $i$，其随访记录会被转换成多行数据。分[割点](@entry_id:637448)包括其进入研究的时间、所有协变量发生变化的时刻、以及其发生事件或被删失的时间。每一行数据代表一个时间区间 $[t_{start}, t_{stop})$，并包含以下信息：
-   个体ID
-   区间的起始时间 $t_{start}$
-   区间的结束时间 $t_{stop}$
-   在该区间内保持恒定的协变量值
-   一个事件指示符，仅在代表事件发生时刻的那个区间的末尾取值为1，其他情况为0。

通过这种方式，当软件需要在某个事件时间 $t_j$ 构建风险集并计算[偏似然](@entry_id:165240)时，它可以简单地查询所有满足 $t_{start} \le t_j  t_{stop}$ 的数据行。这些行代表了在 $t_j$ 时刻处于风险中的所有个体，并且每行都提供了在该时刻有效的协变量值。这种分段常数 (piecewise-constant) 的表示方法是大多数现代生存分析软件处理时变协变量的标准操作方式 [@problem_id:4991780]。

### 理论基础：[计数过程](@entry_id:260664)与可预测性

对[Cox模型](@entry_id:164053)进行更深入的理论探讨需要借助**[计数过程](@entry_id:260664)理论 (counting process theory)**。在这个框架下，我们将每个个体的事件历史视为一个[计数过程](@entry_id:260664) $N_i(t)$，它在事件发生时从0跳跃到1。这个过程的**强度过程 (intensity process)** $\lambda_i(t)$ 定义了在给定直至 $t$ 时刻之前的全部历史信息 $\mathcal{F}_{t-}$ 的条件下，事件在瞬时发生的概率：

$$
\lambda_i(t) dt = \mathbb{E}[dN_i(t) | \mathcal{F}_{t-}]
$$

强度 $\lambda_i(t)$ 与我们之前讨论的风险函数 $h_i(t)$ 密切相关。只有当个体处于风险中时（即在险指示符 $Y_i(t)=1$），事件才可能发生。因此，强度可以表示为风险与在险状态的乘积 [@problem_id:4991892]：

$$
\lambda_i(t) = Y_i(t) h_i(t) = Y_i(t) h_0(t) \exp(\boldsymbol{\beta}' \mathbf{X}_i(t))
$$

这个理论框架的基石之一是**可预测性 (predictability)** 条件 [@problem_id:4991781]。为了使[偏似然](@entry_id:165240)估计量具有良好的统计性质（如一致性），强度过程 $\lambda_i(t)$ 必须是可预测的。这意味着在任何时间 $t$，$\lambda_i(t)$ 的值必须由 $t$ 时刻**之前**的历史信息 $\mathcal{F}_{t-}$ 完全确定。由于 $Y_i(t)$ 和 $h_0(t)$ 通常满足此条件，可预测性要求最终落在了时变协变量 $\mathbf{X}_i(t)$ 上。

在实践中，可预测性意味着用于计算时间 $t$ 风险的协变量值，必须是基于严格在 $t$ 之前收集的信息。一个常见的确保可预测性的方法是使用左连续的协变量路径，即在时间 $t$ 使用的协变量值是 $t$ 之前最后一次观测到的值。这个条件禁止了“窥探未来”，例如，不能使用在一次心脏病发作事件发生时或之后才测量到的生物标志物值来预测这次心脏病发作的风险 [@problem_id:4991820]。这样做会引入严重的偏倚，因为它混淆了原因和结果。

### 时变协变量的类型及其意义

正确使用和解释时变协变量模型需要辨析几个关键概念。

#### 时变协变量 vs. 时变效应

首先，必须区分**时变协变量 (time-varying covariates)** 和**时变效应 (time-varying effects)** [@problem_id:4991895]。
-   **时变协变量**：模型形式为 $h(t) = h_0(t)\exp(\beta X(t))$。这里，协变量 $X(t)$ 的值随时间变化，但其对风险（对数尺度上）的影响系数 $\beta$ 是一个常数。如前所述，该模型对于协变量 $X(t)$ 满足瞬时比例风险假定。
-   **时变效应**：模型形式为 $h(t) = h_0(t)\exp(\beta(t) Z)$，其中 $Z$ 是一个（通常为基线的）协变量。这里，协变量本身的值是固定的，但其效应 $\beta(t)$ 随时间变化。这种模型明确违背了[比例风险](@entry_id:166780)假定，因此也称为**非[比例风险模型](@entry_id:171806) (non-proportional hazards model)**。在实践中，这通常通过在模型中加入协变量与时间函数的交互项来实现，例如 $Z \times \log(t)$。包含这样一个项后，对于 $Z$ 的风险比将变为 $\exp(\delta \log(t)) = t^\delta$，它是一个时间的函数 [@problem_id:4991895]。

如果检验（如基于Schoenfeld残差的检验）发现某个基线协变量违背了[比例风险](@entry_id:166780)假定，正确的修正方法是为其构建一个时变效应模型，而不是将其错误地转换为一个时变协变量。

#### 内部协变量 vs. 外部协变量

其次，根据其与个体状态的关系，时变协变量可分为**外部 (external)** 和**内部 (internal)** 两类 [@problem_id:4991893]。
-   **外部协变量**是指其路径不受个体事件过程影响的变量。一个典型的例子是环境暴露，如城市范围内的每日空气污染浓度 [@problem_id:4991893] 或环境温度 [@problem_id:4991784]。这些变量的演变独立于队列中任何个体的健康状况。在满足可预测性的前提下，外部协变量可以直接纳入[Cox模型](@entry_id:164053)。

-   **内部协变量**是由个体自身产生的过程，其存在依赖于个体的存活。典型的例子包括生物标志物（如血压、血清乳酸水平、[肾小球滤过率](@entry_id:164274)eGFR）或累积的临床事件史（如住院次数）[@problem_id:4991820] [@problem_id:4991784] [@problem_id:4991893]。

内部协变量给[模型解释](@entry_id:637866)带来了巨大挑战。一个核心问题是**[反向因果关系](@entry_id:265624) (reverse causation)** 的可能性。例如，一个正在恶化的潜在心血管疾病过程可能同时导致血压升高和心肌梗死的风险增加。在这种情况下，观察到的血压升高与事件风险之间的关联，可能并非血压对事件的因果效应，而仅仅是两者都是同一潜在疾病过程的结果 [@problem_id:4991820]。同样，如果医生因为观察到患者病情不稳而更频繁地测量其血乳酸水平，那么测量时间本身就带有关于风险的信息，这被称为**信息性观测过程 (informative observation process)**，它会给标准分析带来偏倚 [@problem_id:4991784]。

### 常见陷阱与高级因果推断

由于时变协变量的复杂性，研究者在分析和解释时容易陷入几个常见的陷阱。

#### 不朽时间偏倚 (Immortal Time Bias)

当分析一个在基线后某个时间点才开始的治疗或暴露时，一个常见的严重错误是**不朽时间偏倚**。这种偏倚发生在错误地处理暴露开始前的随访时间段。

考虑一个评估某种药物效果的研究，患者在出院后不同时间点开始服药。一个错误的分析方法是将患者分为“曾经服药组”和“从未服药组”，并从 $t=0$ 开始比较他们的生存情况。对于一个在 $T^*$ 时刻开始服药的患者，他在 $[0, T^*)$ 这段时间内被错误地归类为“服药组”。然而，要能开始服药，他必须存活到 $T^*$ 时刻。这段时间对于“服药组”来说是“不朽的”，因为根据定义，他们不可能在这段时间内作为服药者死亡。这种错误的分类会人为地降低“服药组”的事件率，导致对药物保护效果的严重高估 [@problem_id:4991846]。

正确的处理方法是使用时变协变量模型，将该患者在 $[0, T^*)$ 时间段内的暴露[状态编码](@entry_id:169998)为0，在 $[T^*, \infty)$ 时间段内编码为1。其他一些看似合理的“修正”方法，如地标分析 (landmark analysis) 或仅对服药者使用延迟进入，也存在各自的偏倚，无法得到一致的估计 [@problem_id:4991846]。

#### 时依混杂 (Time-Dependent Confounding)

在因果推断中，最棘手的问题之一是**时依混杂**。这种情况发生在当一个时变变量（如生物标志物 $L(t)$）既是未来治疗决策 $X(t)$ 的预测因子（即混杂因子），又是过去治疗 $\bar{X}(t-1)$ 的一个结果（即中介变量）[@problem_id:4991887]。

例如，医生根据患者当前的炎症标志物水平 $L(t)$ 来决定是否使用皮质类固醇治疗 $X(t)$；而过去的[类固醇](@entry_id:146569)使用史 $\bar{X}(t-1)$ 又会影响当前炎症标志物的水平 $L(t)$。如果我们想估计治疗 $X(t)$ 的因果效应，标准的处理方法会失效：
-   **不调整** $L(t)$：由于 $L(t)$ 是一个混杂因子，忽略它会导致混杂偏倚。
-   **调整** $L(t)$（即将其作为协变量放入模型）：由于 $L(t)$ 也可能在过去治疗到未来结局的因果链上，调整它会不当地阻断一部分治疗的因果路径，导致偏倚。

在这种情况下，从标准Cox模型中得到的治疗系数 $\beta_X$ 不能被解释为因果效应。它仅代表在控制了基线变量和生物标志物当前值的条件下，治疗与风险之间的**条件性关联 (conditional association)**。

为了估计因果效应，需要使用更高级的方法，如**边际结构模型 (Marginal Structural Models, MSMs)** 或**结构[嵌套模型](@entry_id:635829) (Structural Nested Models, SNMs)**。这些方法通过对治疗或删失进行逆概率加权 (inverse probability weighting)，或通过g-估计，来校正时依混杂，从而估计在特定治疗策略下的边际因果效应 [@problem_id:4991887] [@problem_id:4991893]。

#### 关联 vs. 因果：模型的双重用途

最后需要强调的是，即使由于时依混杂等问题，Cox模型无法提供无偏的**因果效应**估计，它作为一种**关联性模型 (associational model)** 或**预测模型 (predictive model)** 仍然是有效和有用的 [@problem_id:4991895]。模型估计的系数准确地描述了在给定患者的完整观测历史（包括过去的治疗和生物标志物轨迹）的条件下，协变量与瞬时风险之间的关系。对于需要根据患者当前可及的所有信息来预测其短期风险的临床场景，这样的模型极具价值。关键在于研究者必须清晰地认识到模型的局限性，避免对结果进行不恰当的因果解释。