{"hands_on_practices": [{"introduction": "理论是根基，但真正的理解始于实践。本练习将分层Cox模型的偏似然函数计算分解为具体的、可操作的步骤。通过处理一个精简的假设性数据集，您将亲手构建分层风险集并计算似然贡献，从而将抽象的数学公式转化为直观的理解，并巩固在竞争风险环境下如何正确应用分层分析的核心技能。[@problem_id:4610388]", "problem": "一个精准肿瘤学登记库包含一小群实体瘤患者的事件时间数据，其中记录了性别以便进行分层。记录了两种互斥的临床事件：原因 $1$ 是疾病进展，原因 $2$ 是非癌症死亡。假设分析旨在使用分层 Cox 比例风险 (CPH) 模型来研究疾病进展的特定原因风险，其中允许基线风险因性别而异，但对于指示通路激活特征高表达的单个二元基因组协变量 $z \\in \\{0,1\\}$，各层使用一个共同的回归系数。在层 $s \\in \\{\\text{女性}, \\text{男性}\\}$ 中，疾病进展的特定原因风险为\n$$\\lambda_{1,s}(t \\mid z) = \\lambda_{1,0,s}(t)\\,\\exp(\\beta z),$$\n其中 $\\lambda_{1,0,s}(t)$ 是一个未指明的、特定于层的基线风险，而 $\\beta$ 是高表达的共同对数风险比。\n\n给出以下事件史。每行列表为 $(\\text{性别}, z, t, \\text{类型})$，其中 $t$ 是观测到的距离首次事件或删失的时间（以月为单位），$\\text{类型} \\in \\{1,2,\\text{删失}\\}$ 分别表示进展、死亡或右删失。\n\n- $(\\text{女性},\\,1,\\,4,\\,1)$\n- $(\\text{女性},\\,0,\\,6,\\,2)$\n- $(\\text{女性},\\,1,\\,10,\\,\\text{删失})$\n- $(\\text{女性},\\,0,\\,5,\\,1)$\n- $(\\text{男性},\\,1,\\,3,\\,1)$\n- $(\\text{男性},\\,0,\\,8,\\,2)$\n- $(\\text{男性},\\,1,\\,7,\\,\\text{删失})$\n\n假设对于进展（原因 $1$）的特定原因分析，任何非癌症死亡（原因 $2$）都会在事件发生时将受试者从风险集中移除（即，被视为一个竞争事件），而右删失则在删失时间将受试者移除。不存在左截断和事件时间平局。\n\n任务：对于每个性别分层内的每个进展事件时间，明确指出特定原因 CPH 模型下的风险集，并写下相应的偏似然贡献。验证由于分层，每个事件时间点的分母仅包含来自同一性别分层的受试者。最后，将所有进展事件的合并偏似然 $L(\\beta)$ 表示为单个解析表达式。\n\n答案格式：以 $\\exp(\\beta)$ 的形式提供 $L(\\beta)$ 的闭式表达式。最终答案必须是单个解析表达式。不要四舍五入，也不要包含任何单位。", "solution": "用户希望我解决一个关于竞争风险背景下分层 Cox 模型的问题。\n\n这是我的计划：\n1.  **验证问题：**\n    *   提取所有给定信息。\n    *   检查科学合理性、适定性和客观性。这是一个标准的生物统计学问题，所以应该是有效的。\n\n2.  **理解模型和数据：**\n    *   模型：针对特定原因（原因1：进展）的分层 Cox 比例风险 (CPH) 模型。\n    *   风险函数：`lambda_{1,s}(t | z) = lambda_{1,0,s}(t) * exp(beta * z)`。\n    *   `s` 是分层（性别：女性，男性）。\n    *   `lambda_{1,0,s}(t)` 是特定于层的基线风险。\n    *   `beta` 是协变量 `z` 的共同对数风险比。\n    *   `z` 是一个二元协变量 (0 或 1)。\n    *   竞争风险：原因2（非癌症死亡）在原因1的特定原因分析中被视为删失事件。\n    *   数据：7名患者的列表，格式为 `(性别, z, t, 类型)`。\n\n3.  **分解任务：**\n    *   **第1部分：** 对于每个进展事件，识别其 *分层内的* 风险集。\n    *   **第2部分：** 对于每个进展事件，写下偏似然贡献。\n    *   **第3部分：** 验证分母只包含来自同一分层的受试者。\n    *   **第4部分：** 合并这些贡献，形成总偏似然 `L(beta)`。\n\n4.  **执行计划：**\n\n    *   **数据整理：** 我将首先按分层（性别）整理数据。\n\n        *   **分层：女性**\n            *   患者 F1: (z=1, t=4, type=1) -> 进展事件\n            *   患者 F2: (z=0, t=6, type=2) -> 竞争事件（在 t=6 时视为删失）\n            *   患者 F3: (z=1, t=10, type=cens) -> 在 t=10 时删失\n            *   患者 F4: (z=0, t=5, type=1) -> 进展事件\n\n        *   **分层：男性**\n            *   患者 M1: (z=1, t=3, type=1) -> 进展事件\n            *   患者 M2: (z=0, t=8, type=2) -> 竞争事件（在 t=8 时视为删失）\n            *   患者 M3: (z=1, t=7, type=cens) -> 在 t=7 时删失\n\n    *   **识别事件时间：** 进展事件（类型=1）是唯一对偏似然分子有贡献的事件。\n        *   女性分层事件时间：`t=4`（来自 F1）和 `t=5`（来自 F4）。\n        *   男性分层事件时间：`t=3`（来自 M1）。\n\n    *   **计算偏似然贡献（按分层计算）：**\n\n        *   受试者 `i` 在时间 `t_i` 发生事件的偏似然贡献为：\n            `L_i(beta) = [exp(beta * z_i)] / [sum_{j in R(t_i)} exp(beta * z_j)]`\n            其中 `R(t_i)` 是在时间 `t_i` 的风险集。风险集 `R(t_i)` 包括所有事件/删失时间 `t_j` 大于或等于 `t_i` 的受试者 `j`。\n\n        *   **男性分层：**\n            *   **在 t=3 时的事件（患者 M1, z=1）：**\n                *   在时间 `t=3`，男性分层中有谁处于风险中？\n                    *   M1: `t=3`, 处于风险中。(z=1)\n                    *   M2: `t=8`, 处于风险中。(z=0)\n                    *   M3: `t=7`, 处于风险中。(z=1)\n                *   风险集 `R_M(3)` = {M1, M2, M3}。\n                *   分母总和：`exp(beta*1) + exp(beta*0) + exp(beta*1) = 2*exp(beta) + 1`。\n                *   分子：`exp(beta*1) = exp(beta)`。\n                *   偏似然贡献 `L_M1(beta)`: `exp(beta) / (2*exp(beta) + 1)`。\n\n        *   **女性分层：**\n            *   事件时间为 `t=4` 和 `t=5`。我需要按时间顺序处理它们。\n            *   **在 t=4 时的事件（患者 F1, z=1）：**\n                *   在时间 `t=4`，女性分层中有谁处于风险中？\n                    *   F1: `t=4`, 处于风险中。(z=1)\n                    *   F2: `t=6`, 处于风险中。(z=0)\n                    *   F3: `t=10`, 处于风险中。(z=1)\n                    *   F4: `t=5`, 处于风险中。(z=0)\n                *   风险集 `R_F(4)` = {F1, F2, F3, F4}。\n                *   分母总和：`exp(beta*1) + exp(beta*0) + exp(beta*1) + exp(beta*0) = 2*exp(beta) + 2`。\n                *   分子：`exp(beta*1) = exp(beta)`。\n                *   偏似然贡献 `L_F1(beta)`: `exp(beta) / (2*exp(beta) + 2)`。\n\n            *   **在 t=5 时的事件（患者 F4, z=0）：**\n                *   在时间 `t=5`，女性分层中有谁处于风险中？\n                    *   F1：在 `t=4` 发生事件，不再处于风险集中。\n                    *   F2: `t=6`, 处于风险中。(z=0)\n                    *   F3: `t=10`, 处于风险中。(z=1)\n                    *   F4: `t=5`, 处于风险中。(z=0)\n                *   风险集 `R_F(5)` = {F2, F3, F4}。\n                *   分母总和：`exp(beta*0) + exp(beta*1) + exp(beta*0) = exp(beta) + 2`。\n                *   分子：`exp(beta*0) = 1`。\n                *   偏似然贡献 `L_F4(beta)`: `1 / (exp(beta) + 2)`。\n\n    *   **验证分层：** 问题陈述明确要求验证每个事件时间点的分母只包含来自同一性别分层的受试者。我上面的过程自然地做到了这一点。风险集 `R_M(3)`、`R_F(4)` 和 `R_F(5)` 仅使用相应分层（男性或女性）的受试者构建。这是分层 Cox 模型的定义：偏似然是每个分层似然的乘积，并且在每个分层内，风险集仅限于该分层。因此，验证完成。\n\n    *   **合并贡献以获得总偏似然：**\n        *   总偏似然 `L(beta)` 是所有事件的单个贡献的乘积。\n        *   `L(beta) = L_M1(beta) * L_F1(beta) * L_F4(beta)`\n        *   `L(beta) = [exp(beta) / (2*exp(beta) + 1)] * [exp(beta) / (2*exp(beta) + 2)] * [1 / (exp(beta) + 2)]`\n        *   `L(beta) = [exp(beta)]^2 / [(2*exp(beta) + 1) * (2*exp(beta) + 2) * (exp(beta) + 2)]`\n        *   `L(beta) = exp(2*beta) / [(2*exp(beta) + 1) * 2*(exp(beta) + 1) * (exp(beta) + 2)]`\n        *   让我们为最终表达式稍微简化分母。\n        *   `L(beta) = exp(2*beta) / [2 * (2*exp(beta) + 1) * (exp(beta) + 1) * (exp(beta) + 2)]`\n\n    *   **最终答案格式：**\n        *   答案应为单个解析表达式 `L(beta)`。\n        *   我将使用 `\\exp(\\beta)` 和 `\\exp(2\\beta)`。\n        *   最终表达式为：`\\frac{\\exp(2\\beta)}{2(2\\exp(\\beta) + 1)(\\exp(\\beta) + 1)(\\exp(\\beta) + 2)}`。\n\n5.  **复查和再次核对：**\n\n    *   **问题验证：**\n        *   给定条件：模型 `lambda_{1,s}(t | z) = lambda_{1,0,s}(t) * exp(beta * z)`，7名患者的数据，分层（`s`=性别）的定义，事件（1=进展，2=死亡，cens=删失）的定义，以及竞争风险的处理（原因2在原因1的特定原因分析中被视为删失）。\n        *   科学依据：是的，这是生存分析在生物统计学中的标准应用。Cox 模型和竞争风险框架是公认的。\n        *   适定性：是的，问题定义明确，并能得到偏似然的唯一表达式。\n        *   客观性：是的，语言精确且定量。\n        *   结论：**有效**。\n\n    *   **解题逻辑：**\n        *   分层：通过将数据分为男性和女性队列并在每个队列内形成风险集来正确处理。\n        *   风险集：\n            *   `t=3` 时的事件（男性，z=1）：风险集为 {M1, M2, M3}。`z` 值为 {1, 0, 1}。正确。\n            *   `t=4` 时的事件（女性，z=1）：风险集为 {F1, F2, F3, F4}。`z` 值为 {1, 0, 1, 0}。正确。\n            *   `t=5` 时的事件（女性，z=0）：风险集为 {F2, F3, F4}，因为 F1 在 `t=4` 时发生了事件。`z` 值为 {0, 1, 0}。正确。\n        *   竞争风险处理：正确地将原因2事件视为删失。例如，患者 F2（t=6，类型=2）在 `t=4` 和 `t=5` 时处于风险集中，但在 `t=6` 后从风险集中移除。患者 M2（t=8，类型=2）在 `t=3` 时处于风险集中，但在 `t=8` 后移除。这是标准的特定原因风险方法。\n        *   偏似然项：\n            *   `t=3`：分子 `exp(beta*1)`，分母 `exp(beta*1) + exp(beta*0) + exp(beta*1) = 2*exp(beta) + 1`。正确。\n            *   `t=4`：分子 `exp(beta*1)`，分母 `exp(beta*1) + exp(beta*0) + exp(beta*1) + exp(beta*0) = 2*exp(beta) + 2`。正确。\n            *   `t=5`：分子 `exp(beta*0)`，分母 `exp(beta*0) + exp(beta*1) + exp(beta*0) = exp(beta) + 2`。正确。\n        *   总似然 `L(beta)`：三项的乘积。\n            `[exp(beta) / (2*exp(beta) + 1)] * [exp(beta) / (2*exp(beta) + 2)] * [1 / (exp(beta) + 2)]`\n            `= exp(2*beta) / [(2*exp(beta) + 1) * (2(exp(beta) + 1)) * (exp(beta) + 2)]`\n            `= exp(2*beta) / [2 * (2*exp(beta) + 1) * (exp(beta) + 1) * (exp(beta) + 2)]`\n            看起来正确。代数运算很简单。\n\n    *   **最终输出格式检查：**\n        *   所有内容必须是 LaTeX 格式。\n        *   没有 markdown 标题。\n        *   最终答案在 `\\boxed{...}` 中。\n        *   使用 `\\exp(...)`。\n        *   使用 `\\frac{...}{...}`。\n        *   逻辑和计算看起来都合理。我准备好写解答了。", "answer": "$$\n\\boxed{\\frac{\\exp(2\\beta)}{2(2\\exp(\\beta)+1)(\\exp(\\beta)+1)(\\exp(\\beta)+2)}}\n$$", "id": "4610388"}, {"introduction": "选择正确的模型是统计分析的关键，而理解模型何时会失效同样重要。此练习构建了一个巧妙的场景，其中一个简单的参数化模型因违反比例风险假设而失效，凸显了分层Cox模型的优越性。通过对比这两种方法，您将深刻体会到分层为何是处理非比例风险（尤其是由基线风险模式的系统性差异引起时）的强大而稳健的工具。[@problem_id:4985401]", "problem": "一项临床队列研究在基线时间 $t=0$ 从两家医院招募患者，由分层指标 $Z \\in \\{0,1\\}$ 索引，其中 $Z=0$ 代表医院 A，$Z=1$ 代表医院 B。在基线时测量了一个二元生物标志物协变量 $X \\in \\{0,1\\}$。由于支持性护理的改变，医院 B 表现出延迟的基线风险模式（时间偏移），因此即使生物标志物 $X$ 相同，其事件时间也比医院 A 的晚。这种现象不是风险随时间的恒定乘性变化，因此不能在比例风险模型下编码为 $Z$ 的时不变对数风险比。\n\n数据包含 8 名患者，每家医院 4 名，均在 $t=0$ 时进入研究。观察到的事件和删失时间如下：\n- 医院 A ($Z=0$)：两名患者 $X=1$，两名患者 $X=0$。一名 $X=1$ 的患者在 $t=1$ 时发生事件，一名 $X=0$ 的患者在 $t=2$ 时发生事件，另外两名在 $t=3$ 时被行政删失。\n- 医院 B ($Z=1$)：两名患者 $X=1$，两名患者 $X=0$。一名 $X=0$ 的患者在 $t=5$ 时发生事件，一名 $X=1$ 的患者在 $t=6$ 时发生事件，另外两名在 $t=7$ 时被行政删失。\n\n假设没有并列的事件时间，且删失是独立的、非信息性的。考虑两种建模策略：\n1. 一个非分层的 Cox 比例风险 (CPH) 模型，其线性预测变量为 $\\beta X + \\gamma Z$，因此风险函数为 $h(t \\mid X,Z) = h_{0}(t)\\,\\exp(\\beta X + \\gamma Z)$，所有患者共享一个单一的基线风险 $h_{0}(t)$。\n2. 一个按医院分层的 Cox 模型，具有共同的生物标志物效应但有分层特定的基线风险 $h_{0Z}(t)$：$h(t \\mid X,Z) = h_{0Z}(t)\\,\\exp(\\beta X)$。\n\n从 CPH 模型及其偏似然的定义出发，利用给定的事件时间和数据引出的风险集，推导出分层模型的偏似然，并说明分层如何消除了由医院 B 的延迟基线风险引起的对比例风险假设的违背。然后，与非分层的指标调整模型进行对比，解释为什么时不变的 $\\gamma$ 无法吸收时间偏移，以及为什么最大化关于 $\\gamma$ 的偏似然会失败（即无法获得有限的最大化子），从而证明指标调整不能解决非比例性问题。\n\n在正确的分层 Cox 模型下，对于此数据，公共生物标志物对数风险比 $\\beta$ 的最大偏似然估计是多少？您可以以精确形式给出最终答案。不要包含单位。如果需要近似值，则四舍五入到四位有效数字，但这里接受精确值。", "solution": "用户要求我为给定的生存数据集分析两种 Cox 建模策略，并计算在正确指定的的分层模型中生物标志物效应的最大偏似然估计。\n\n### 步骤1：提取已知条件\n- **分层指标**：$Z \\in \\{0,1\\}$，其中 $Z=0$ 代表医院 A，$Z=1$ 代表医院 B。\n- **生物标志物协变量**：$X \\in \\{0,1\\}$。\n- **患者数据**：\n    - **医院 A ($Z=0$)**：4 名患者从 $t=0$ 开始。\n        - 两名患者 $X=1$。一名在 $t=1$ 发生事件，另一名在 $t=3$ 被删失。\n        - 两名患者 $X=0$。一名在 $t=2$ 发生事件，另一名在 $t=3$ 被删失。\n    - **医院 B ($Z=1$)**：4 名患者从 $t=0$ 开始。\n        - 两名患者 $X=1$。一名在 $t=6$ 发生事件，另一名在 $t=7$ 被删失。\n        - 两名患者 $X=0$。一名在 $t=5$ 发生事件，另一名在 $t=7$ 被删失。\n- **事件时间**：$t=1$ ($Z=0, X=1$), $t=2$ ($Z=0, X=0$), $t=5$ ($Z=1, X=0$), $t=6$ ($Z=1, X=1$)。\n- **模型1（非分层）**：风险函数 $h(t \\mid X,Z) = h_{0}(t)\\,\\exp(\\beta X + \\gamma Z)$。\n- **模型2（分层）**：风险函数 $h(t \\mid X,Z) = h_{0Z}(t)\\,\\exp(\\beta X)$。\n- **假设**：无并列事件时间，删失是独立且非信息性的。\n\n### 步骤2：使用提取的已知条件进行验证\n1.  **科学依据**：该问题设置在生存分析的既定框架内，特别是 Cox 比例风险模型和分层。这些是医学研究中使用的标准、易于理解的统计方法。由于医院规程不同导致非比例风险的情景在科学上是现实的。\n2.  **适定性**：问题的结构使其具有唯一且有意义的解。它要求基于所提供的数据和模型定义进行特定的推导和计算。数据足以执行分析。\n3.  **客观性**：问题使用精确、客观的数学和统计术语（$h(t)$, $\\beta$, 分层模型, 偏似然）来陈述。没有主观或基于意见的陈述。\n4.  **完整性和一致性**：提供了所有必要的数据（事件时间、删失时间、协变量、分层指标）和模型形式。设置中没有矛盾。\n5.  **非不适定**：虽然非分层模型被证明是不适定的（$\\gamma$ 没有有限的最大似然估计），但这是问题明确目标的一部分：展示这种失败。在分层模型下找到 $\\beta$ 的核心任务是适定的。\n\n### 步骤3：结论与行动\n该问题是有效的。我将进行完整解答。\n\n### 推导与解答\n\n本题要求对两种 Cox 建模策略进行比较分析，并计算更优模型的参数估计。我们首先定义 Cox 偏似然，然后将其应用于分层和非分层模型，以展示它们在给定数据下的属性。\n\n对于参数矢量为 $\\boldsymbol{\\theta}$ 的 Cox 模型，其偏似然由不同失败时间点 $t_{(1)}  t_{(2)}  \\dots  t_{(D)}$ 上的概率乘积给出。对于在时间 $t_{(i)}$ 发生的每次失败，对似然的贡献是在风险集 $R(t_{(i)})$ 中发生一次失败的条件下，特定受试者 $i$ 失败的条件概率。\n$$\nL(\\boldsymbol{\\theta}) = \\prod_{i=1}^{D} \\frac{h(t_{(i)} \\mid \\mathbf{x}_i)}{\\sum_{j \\in R(t_{(i)})} h(t_{(j)} \\mid \\mathbf{x}_j)} = \\prod_{i=1}^{D} \\frac{h_{0}(t_{(i)}) \\exp(\\boldsymbol{\\theta}' \\mathbf{x}_i)}{\\sum_{j \\in R(t_{(i)})} h_{0}(t_{(i)}) \\exp(\\boldsymbol{\\theta}' \\mathbf{x}_j)} = \\prod_{i=1}^{D} \\frac{\\exp(\\boldsymbol{\\theta}' \\mathbf{x}_i)}{\\sum_{j \\in R(t_{(i)})} \\exp(\\boldsymbol{\\theta}' \\mathbf{x}_j)}\n$$\n其中 $\\mathbf{x}_i$ 是受试者 $i$ 的协变量向量。\n\n**分层模型（模型2）的分析**\n\n分层模型由风险函数 $h(t \\mid X,Z) = h_{0Z}(t)\\,\\exp(\\beta X)$ 定义。分层的关键特征是基线风险 $h_{0Z}(t)$ 对于每个分层 $Z \\in \\{0, 1\\}$ 是特定的。因此，风险集是*在每个分层内*形成的，总偏似然是每个分层偏似然的乘积。\n$$\nL_{\\text{stratified}}(\\beta) = L_{Z=0}(\\beta) \\times L_{Z=1}(\\beta)\n$$\n这种模型结构内在地适应了医院 B ($Z=1$) 中的“延迟基线风险”。医院之间事件时间模式的差异被不同的基线风险函数 $h_{00}(t)$ 和 $h_{01}(t)$ 所吸收。该模型不假设医院之间的风险比是恒定的，从而正确处理了非比例性。比较只在同一家医院内的患者之间进行。\n\n**非分层模型（模型1）及其失败的分析**\n\n非分层模型 $h(t \\mid X,Z) = h_0(t)\\,\\exp(\\beta X + \\gamma Z)$ 假设一个共同的基线风险 $h_0(t)$，并且医院之间的风险比随时间是恒定的，由 $\\exp(\\gamma)$ 给出。我们现在证明为什么这个假设对于给定数据是站不住脚的，并导致 $\\gamma$ 的估计不是有限的。\n\n合并队列的有序事件时间是 $t=1$, $t=2$, $t=5$ 和 $t=6$。\n对数偏似然为 $\\ell(\\beta, \\gamma) = \\sum_{i: \\text{failure}} \\left( (\\beta X_i + \\gamma Z_i) - \\ln \\left( \\sum_{j \\in R(t_i)} \\exp(\\beta X_j + \\gamma Z_j) \\right) \\right)$。\n\n数据显示，失败时间按医院完全分离：医院 A ($Z=0$) 的所有失败（在 $t=1, 2$）都发生在医院 B ($Z=1$) 的任何失败（在 $t=5, 6$）之前。我们来检查 $\\gamma$ 的得分函数，$\\frac{\\partial \\ell}{\\partial \\gamma} = \\sum_{i: \\text{failure}} \\left( Z_i - \\frac{\\sum_{j \\in R(t_i)} Z_j \\exp(\\beta X_j + \\gamma Z_j)}{\\sum_{j \\in R(t_i)} \\exp(\\beta X_j + \\gamma Z_j)} \\right)$。\n\n- 对于 $t=1$ 和 $t=2$ 的事件，失败个体的 $Z_i=0$。风险集 $R(1)$ 和 $R(2)$ 包含来自两家医院（$Z=0$ 和 $Z=1$）的个体。这些事件的项是 $0 - P(Z=1 \\mid j \\in R(t_i) \\text{ selected to fail})$。由于 $Z=1$ 的个体在风险集中但没有失败，此项为负。\n- 对于 $t=5$ 和 $t=6$ 的事件，失败个体的 $Z_i=1$。然而，来自医院 A 的两个未失败患者在 $t=3$ 时被删失。因此，风险集 $R(5)$ 和 $R(6)$ *只*包含来自医院 B 的个体，对他们来说 $Z_j = 1$。对于这些事件，得分贡献为 $1 - \\frac{\\sum_{j \\in R(t_i)} 1 \\cdot \\exp(\\beta X_j + \\gamma)}{\\sum_{j \\in R(t_i)} \\exp(\\beta X_j + \\gamma)} = 1 - 1 = 0$。\n\n因此，$\\gamma$ 的得分仅取决于前两个失败时间：\n$$\n\\frac{\\partial \\ell}{\\partial \\gamma} = - \\frac{\\sum_{j \\in R(1), Z_j=1} \\exp(\\beta X_j + \\gamma)}{\\sum_{j \\in R(1)} \\exp(\\beta X_j + \\gamma Z_j)} - \\frac{\\sum_{j \\in R(2), Z_j=1} \\exp(\\beta X_j + \\gamma)}{\\sum_{j \\in R(2)} \\exp(\\beta X_j + \\gamma Z_j)}\n$$\n让我们写出第一项的和。在 $t=1$ 时，$R(1)$ 包含所有 8 名患者。\n分子：$2\\exp(\\beta+\\gamma) + 2\\exp(\\gamma) = 2\\exp(\\gamma)(\\exp(\\beta)+1)$。\n分母：$2\\exp(\\beta) + 2 + 2\\exp(\\beta+\\gamma) + 2\\exp(\\gamma) = 2(\\exp(\\beta)+1) + 2\\exp(\\gamma)(\\exp(\\beta)+1)$。\n该项为 $-\\frac{2\\exp(\\gamma)(\\exp(\\beta)+1)}{2(\\exp(\\beta)+1) + 2\\exp(\\gamma)(\\exp(\\beta)+1)} = -\\frac{\\exp(\\gamma)}{1+\\exp(\\gamma)}$。\n对第二项进行类似的计算也得到一个负值。只要 $\\exp(\\beta)+1>0$（这总是成立的），对于任何有限的 $\\gamma$，$\\gamma$ 的得分方程中的两项都严格为负。\n由于 $\\frac{\\partial \\ell}{\\partial \\gamma}  0$，对数似然是 $\\gamma$ 的单调递减函数。因此，当 $\\gamma \\to -\\infty$ 时，似然被最大化。这表明 $\\gamma$ 没有有限的最大似然估计（MLE）。该模型试图使医院 B 相对于医院 A 的风险无限小，以解释为什么医院 B 的所有失败都发生在较晚的时间，这是比例风险假设的失败，一个时不变的 $\\gamma$ 无法修正。\n\n**分层模型 $\\beta_{MLE}$ 的计算**\n\n我们现在计算在正确指定的的分层模型下，共同生物标志物效应 $\\beta$ 的 MLE。\n$\\ell_{\\text{stratified}}(\\beta) = \\ell_{Z=0}(\\beta) + \\ell_{Z=1}(\\beta)$。\n\n**分层1：医院 A ($Z=0$)**\n- $t=1$ 时的事件：失败者 $X=1$。风险集 $R_A(1)$ 的受试者 $X$ 值为 $\\{1, 1, 0, 0\\}$。\n  似然项：$\\frac{\\exp(\\beta \\cdot 1)}{\\exp(\\beta \\cdot 1) + \\exp(\\beta \\cdot 1) + \\exp(\\beta \\cdot 0) + \\exp(\\beta \\cdot 0)} = \\frac{\\exp(\\beta)}{2\\exp(\\beta) + 2}$。\n- $t=2$ 时的事件：失败者 $X=0$。风险集 $R_A(2)$ 的受试者 $X$ 值为 $\\{1, 0, 0\\}$ (一个 $X=1$ 的受试者在 $t=1$ 时失败了)。\n  似然项：$\\frac{\\exp(\\beta \\cdot 0)}{\\exp(\\beta \\cdot 1) + \\exp(\\beta \\cdot 0) + \\exp(\\beta \\cdot 0)} = \\frac{1}{\\exp(\\beta) + 2}$。\n所以, $\\ell_{Z=0}(\\beta) = \\ln\\left(\\frac{\\exp(\\beta)}{2\\exp(\\beta) + 2}\\right) + \\ln\\left(\\frac{1}{\\exp(\\beta) + 2}\\right) = \\beta - \\ln(2(\\exp(\\beta)+1)) - \\ln(\\exp(\\beta)+2)$。\n\n**分层2：医院 B ($Z=1$)**\n- $t=5$ 时的事件：失败者 $X=0$。风险集 $R_B(5)$ 的受试者 $X$ 值为 $\\{0, 0, 1, 1\\}$。\n  似然项：$\\frac{\\exp(\\beta \\cdot 0)}{\\exp(\\beta \\cdot 0) + \\exp(\\beta \\cdot 0) + \\exp(\\beta \\cdot 1) + \\exp(\\beta \\cdot 1)} = \\frac{1}{2 + 2\\exp(\\beta)}$。\n- $t=6$ 时的事件：失败者 $X=1$。风险集 $R_B(6)$ 的受试者 $X$ 值为 $\\{0, 1, 1\\}$ (一个 $X=0$ 的受试者在 $t=5$ 时失败了)。\n  似然项：$\\frac{\\exp(\\beta \\cdot 1)}{\\exp(\\beta \\cdot 0) + \\exp(\\beta \\cdot 1) + \\exp(\\beta \\cdot 1)} = \\frac{\\exp(\\beta)}{1 + 2\\exp(\\beta)}$。\n所以, $\\ell_{Z=1}(\\beta) = \\ln\\left(\\frac{1}{2 + 2\\exp(\\beta)}\\right) + \\ln\\left(\\frac{\\exp(\\beta)}{1 + 2\\exp(\\beta)}\\right) = -\\ln(2(1+\\exp(\\beta))) + \\beta - \\ln(1+2\\exp(\\beta))$。\n\n**总对数似然和得分方程**\n$\\ell_{\\text{stratified}}(\\beta) = \\ell_{Z=0}(\\beta) + \\ell_{Z=1}(\\beta) = 2\\beta - 2\\ln(2) - 2\\ln(\\exp(\\beta)+1) - \\ln(\\exp(\\beta)+2) - \\ln(1+2\\exp(\\beta))$。\n为了找到 MLE，我们对 $\\beta$ 求导并令其为 $0$：\n$$\n\\frac{d\\ell_{\\text{stratified}}}{d\\beta} = 2 - \\frac{2\\exp(\\beta)}{\\exp(\\beta)+1} - \\frac{\\exp(\\beta)}{\\exp(\\beta)+2} - \\frac{2\\exp(\\beta)}{1+2\\exp(\\beta)} = 0\n$$\n令 $u = \\exp(\\beta)$。因为 $\\beta$ 是实数，$u > 0$。得分方程变为：\n$$\n2 = \\frac{2u}{u+1} + \\frac{u}{u+2} + \\frac{2u}{1+2u}\n$$\n假设 $u \\neq 0$，我们可以两边除以 $u$：\n$$\n\\frac{2}{u} = \\frac{2}{u+1} + \\frac{1}{u+2} + \\frac{2}{1+2u}\n$$\n整理各项：\n$$\n\\frac{2}{u} - \\frac{2}{u+1} = \\frac{1}{u+2} + \\frac{2}{1+2u}\n$$\n$$\n\\frac{2(u+1) - 2u}{u(u+1)} = \\frac{(1+2u) + 2(u+2)}{(u+2)(1+2u)}\n$$\n$$\n\\frac{2}{u(u+1)} = \\frac{4u+5}{(u+2)(2u+1)}\n$$\n交叉相乘得到：\n$$\n2(u+2)(2u+1) = u(u+1)(4u+5)\n$$\n$$\n2(2u^2 + 5u + 2) = u(4u^2 + 9u + 5)\n$$\n$$\n4u^2 + 10u + 4 = 4u^3 + 9u^2 + 5u\n$$\n这简化为三次方程：\n$$\n4u^3 + 5u^2 - 5u - 4 = 0\n$$\n我们可以测试简单的有理根。令 $P(u) = 4u^3 + 5u^2 - 5u - 4$。\n$P(1) = 4(1)^3 + 5(1)^2 - 5(1) - 4 = 4 + 5 - 5 - 4 = 0$。\n因此，$u=1$ 是一个根。这对应于 $\\exp(\\hat{\\beta}) = 1$，得出 $\\hat{\\beta} = \\ln(1) = 0$。\n\n为了检查其他正根，我们分解多项式：\n$(u-1)(4u^2 + 9u + 4) = 0$。\n二次因子 $4u^2 + 9u + 4 = 0$ 的判别式为 $\\Delta = 9^2 - 4(4)(4) = 81 - 64 = 17 > 0$。其根为 $u = \\frac{-9 \\pm \\sqrt{17}}{8}$。由于 $\\sqrt{17}  \\sqrt{81} = 9$，这两个根都是负数。因为 $u = \\exp(\\beta)$ 必须为正，所以它们不是有效的解。\n因此，唯一有效的解是 $u=1$，这意味着 $\\hat{\\beta}=0$。\n\n检查在 $\\beta=0$ 处的对数似然的二阶导数（信息量）可以确认它为负，因此该解对应一个最大值。\n$$\n\\frac{d^2\\ell}{d\\beta^2}\\bigg|_{\\beta=0} = -\\frac{2\\exp(0)}{(\\exp(0)+1)^2} - \\frac{2\\exp(0)}{(\\exp(0)+2)^2} - \\frac{2\\exp(0)}{(1+2\\exp(0))^2} = -\\frac{2}{4} - \\frac{2}{9} - \\frac{2}{9} = -\\frac{1}{2} - \\frac{4}{9} = -\\frac{17}{18}  0\n$$\n因此，$\\beta$ 的最大偏似然估计是 $0$。", "answer": "$$\n\\boxed{0}\n$$", "id": "4985401"}, {"introduction": "从模型理想到研究现实，一个关键的步骤是研究设计和样本量规划。本练习将带您从第一性原理出发，推导分层Cox模型研究设计的功效（power）计算公式。这个过程不仅能让您掌握如何为一项使用分层分析的研究估算可检测的效应大小，还将加深您对Fisher信息等核心统计概念在实际应用中的理解。[@problem_id:4985403]", "problem": "一项随机临床研究将使用分层Cox比例风险(PH)模型进行分析。共有 $K$ 个层，由 $s \\in \\{1,\\dots,K\\}$ 索引，每个层都有其自身的基线风险函数，但对于单个协变量 $X$ 具有一个共同的对数风险比参数 $\\theta$。令 $d_s$ 表示在层 $s$ 中观测到的预期事件数，令 $v_s$ 表示根据先前数据或初步信息获得的、在层 $s$ 中事件发生时间内 $X$ 的预期风险集内方差的平均值。假设一个关于 $H_0:\\theta=0$ 的双边假设检验，其I类错误率为 $\\alpha$，目标把握度为 $1-\\beta$，以检测风险比大于 $1$（即 $\\theta0$）的有害效应。令 $z_p$ 表示标准正态分布的第 $p$ 分位数。\n\n仅使用以下基本事实：\n- 根据Cox模型中偏似然得分的标准大样本理论，$\\theta$ 的标准化得分统计量渐近服从正态分布，其均值与 $\\theta$ 成正比，方差为 $1$。\n- 在独立分层和共同 $\\theta$ 的情况下，关于 $\\theta$ 的费雪信息在各层之间是可加的。\n- 根据Cox模型的Schoenfeld大样本近似，每个观测到的事件所贡献的信息近似等于 $X$ 的风险集内方差，因此总信息可以从预期的事件计数和风险集内方差中近似得出，\n\n请从基本原理出发，推导出一个关于 $\\alpha$、$\\beta$、$\\{d_s\\}_{s=1}^K$ 和 $\\{v_s\\}_{s=1}^K$ 的、用于计算最小可检测风险比 $HR_{\\text{det}}$（大于 $1$）的闭式解析表达式。请用一个包含 $z_{1-\\alpha/2}$、$z_{1-\\beta}$ 和 $\\sum_{s=1}^K d_s v_s$ 的单一解析表达式来表示您的最终答案。不需要进行数值计算或四舍五入。", "solution": "用户希望我扮演一位严谨的STEM教授，解决一个与分层Cox模型相关的问题。\n\n### 第1步：提取已知条件\n- 模型：分层Cox比例风险(PH)模型。\n- 层：$K$ 个层，由 $s \\in \\{1, \\dots, K\\}$ 索引。\n- 风险模型：每个层都有其独特的基线风险 $h_{0s}(t)$，但所有层对单个协变量 $X$ 共享一个共同的对数风险比参数 $\\theta$。在层 $s$ 中，个体 $i$ 的风险为 $h_i(t|X_i) = h_{0s}(t) \\exp(\\theta X_i)$。\n- 预期事件：$d_s$ 是在层 $s$ 中观测到的预期事件数。\n- 协变量方差：$v_s$ 是在层 $s$ 中 $X$ 的预期风险集内方差的平均值。\n- 假设检验：关于原假设 $H_0: \\theta=0$ 的双边检验。\n- I类错误：$\\alpha$。\n- 把握度：$1-\\beta$，用于检测风险比大于 $1$（对应于 $\\theta  0$）的备择假设。\n- 符号：$z_p$ 表示标准正态分布的第 $p$ 分位数。\n- 基本事实：\n    1. $\\theta$ 的标准化得分统计量渐近服从正态分布，其均值与 $\\theta$ 成正比，方差为 $1$。\n    2. 关于共同参数 $\\theta$ 的费雪信息在各独立层之间是可加的。\n    3. Schoenfeld的大样本近似：每个事件贡献的信息近似等于协变量 $X$ 的风险集内方差。\n\n### 第2步：使用提取的已知条件进行验证\n- **科学依据**：该问题基于Cox比例风险模型的成熟统计理论，包括分层、得分检验以及使用标准大样本近似（例如，Schoenfeld公式）进行把握度计算。所有原理都是生物统计学和生存分析中的标准内容。\n- **良态的**：问题陈述清晰，并提供了推导所要求公式的所有必要组成部分。它要求推导一个标准的把握度/样本量公式，该公式具有唯一且有意义的解。\n- **客观的**：语言技术性强且精确，没有主观性或歧义。\n\n该问题没有违反任何无效性标准。这是一个科学上合理、良态且客观的问题，可以通过应用指定统计推断的基本原理来解决。\n\n### 第3步：结论与行动\n问题是**有效的**。将提供完整的推导过程。\n\n### 推导过程\n目标是推导最小可检测风险比 $HR_{\\text{det}}$ 的表达式，它对应于一个特定的对数风险比 $\\theta_A  0$，该风险比可以在显著性水平为 $\\alpha$ 的双边检验中以 $1-\\beta$ 的把握度被检测出来。\n\n令 $U(\\theta)$ 为得分函数（对数偏似然函数关于 $\\theta$ 的一阶导数），$I(\\theta)$ 为费雪信息（期望二阶导数的负值）。对于原假设 $H_0: \\theta=0$ 的得分检验是基于得分统计量 $U(0)$。标准化检验统计量由下式给出：\n$$\nZ = \\frac{U(0)}{\\sqrt{I(0)}}\n$$\n在 $H_0: \\theta=0$ 下，该统计量渐近服从标准正态随机变量分布，即 $Z \\sim N(0, 1)$。\n\n对于I类错误率为 $\\alpha$ 的双边检验，如果 $|Z|$ 的观测值超过临界值 $z_{1-\\alpha/2}$，我们就拒绝原假设 $H_0$。也就是说，拒绝域为 $\\{z \\in \\mathbb{R} : |z|  z_{1-\\alpha/2}\\}$。\n\n现在，我们考虑在一个特定的备择假设 $H_A: \\theta = \\theta_A  0$ 下 $Z$ 的分布。根据基于似然的检验的大样本理论（且与提供的第一个基本事实一致），在 $H_A$ 下，检验统计量 $Z$ 渐近服从一个非零均值、方差为 $1$ 的正态分布：\n$$\nZ | H_A \\sim N(\\theta_A \\sqrt{I(0)}, 1)\n$$\n检验的把握度 $1-\\beta$ 是在 $H_A$ 为真时正确拒绝 $H_0$ 的概率。由于我们感兴趣的是检测一个 $\\theta_A  0$ 的效应，在 $H_A$ 下 $Z$ 的均值为正，因此检验统计量将趋向于一个大的正值。因此，把握度为：\n$$\n1-\\beta = P(|Z|  z_{1-\\alpha/2} | \\theta = \\theta_A) = P(Z  z_{1-\\alpha/2} | \\theta = \\theta_A) + P(Z  -z_{1-\\alpha/2} | \\theta = \\theta_A)\n$$\n对于一个把握度足够高的研究，均值 $\\theta_A \\sqrt{I(0)}$ 是一个足够大的正数，这使得第二项 $P(Z  -z_{1-\\alpha/2})$ 可以忽略不计。因此，我们可以通过只考虑拒绝域的上侧尾部来精确地近似把握度：\n$$\n1-\\beta \\approx P(Z  z_{1-\\alpha/2} | \\theta = \\theta_A)\n$$\n为了计算这个概率，我们使用 $Z$ 在 $H_A$ 下的分布对其进行标准化。令 $\\tilde{Z} = Z - \\theta_A \\sqrt{I(0)}$。在 $H_A$ 下，$\\tilde{Z} \\sim N(0,1)$。\n把握度方程变为：\n$$\n1-\\beta \\approx P(\\tilde{Z} + \\theta_A \\sqrt{I(0)}  z_{1-\\alpha/2})\n$$\n$$\n1-\\beta \\approx P(\\tilde{Z}  z_{1-\\alpha/2} - \\theta_A \\sqrt{I(0)})\n$$\n令 $\\Phi(\\cdot)$ 为标准正态分布的累积分布函数（CDF）。那么 $P(\\tilde{Z}  x) = 1 - \\Phi(x)$。\n$$\n1-\\beta \\approx 1 - \\Phi(z_{1-\\alpha/2} - \\theta_A \\sqrt{I(0)})\n$$\n这意味着 $\\beta \\approx \\Phi(z_{1-\\alpha/2} - \\theta_A \\sqrt{I(0)})$。根据标准正态分位数 $z_p$ 的定义，我们有 $\\Phi(z_p)=p$。因此：\n$$\nz_{\\beta} \\approx z_{1-\\alpha/2} - \\theta_A \\sqrt{I(0)}\n$$\n利用标准正态分布的对称性，$z_{\\beta} = -z_{1-\\beta}$。将此代入方程得到：\n$$\n-z_{1-\\beta} \\approx z_{1-\\alpha/2} - \\theta_A \\sqrt{I(0)}\n$$\n求解 $\\theta_A$，即最小可检测对数风险比，我们得到：\n$$\n\\theta_A \\sqrt{I(0)} \\approx z_{1-\\alpha/2} + z_{1-\\beta}\n$$\n$$\n\\theta_A \\approx \\frac{z_{1-\\alpha/2} + z_{1-\\beta}}{\\sqrt{I(0)}}\n$$\n接下来，我们必须确定总费雪信息 $I(0)$。第二个基本事实指出，信息在 $K$ 个独立层之间是可加的：\n$$\nI(0) = \\sum_{s=1}^K I_s(0)\n$$\n其中 $I_s(0)$ 是来自层 $s$ 的信息。\n第三个基本事实提供了Schoenfeld近似：总信息是协变量 $X$ 在所有事件时间点上的风险集内方差之和。在层 $s$ 中，我们预期有 $d_s$ 个事件，预期的平均风险集内方差为 $v_s$。因此，来自层 $s$ 的总信息可近似为：\n$$\nI_s(0) \\approx d_s v_s\n$$\n对所有层求和，总费雪信息为：\n$$\nI(0) \\approx \\sum_{s=1}^K d_s v_s\n$$\n将 $I(0)$ 的这个表达式代入我们关于 $\\theta_A$ 的方程中：\n$$\n\\theta_A = \\frac{z_{1-\\alpha/2} + z_{1-\\beta}}{\\sqrt{\\sum_{s=1}^K d_s v_s}}\n$$\n问题要求的是最小可检测风险比 $HR_{\\text{det}}$，而不是对数风险比。它们之间的关系是 $HR = \\exp(\\theta)$。因此，\n$$\nHR_{\\text{det}} = \\exp(\\theta_A) = \\exp\\left( \\frac{z_{1-\\alpha/2} + z_{1-\\beta}}{\\sqrt{\\sum_{s=1}^K d_s v_s}} \\right)\n$$\n这就是作为指定参数函数的最小可检测风险比的最终闭式解析表达式。", "answer": "$$\n\\boxed{\\exp\\left(\\frac{z_{1-\\alpha/2} + z_{1-\\beta}}{\\sqrt{\\sum_{s=1}^K d_s v_s}}\\right)}\n$$", "id": "4985403"}]}