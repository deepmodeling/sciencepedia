## 引言
Cox比例风险模型是生存分析中的基石，但其有效性严格依赖于[比例风险](@entry_id:166780)（PH）假设。在处理如多中心临床试验或存在重要分组因素（如疾病分期）的复杂数据时，这一假设常常被违反，从而威胁到模型结果的有效性。当不同组别的基线风险模式随时间呈现不同趋势时，我们如何才能在不牺牲模型稳健性的前提下，准确估计其他协变量的效应？

分层Cox模型为此提供了一个优雅而强大的解决方案。本文旨在全面、深入地剖析这一重要统计方法。我们将从**原理与机制**出发，详细阐述模型如何通过分层思想绕过对分层变量的PH假设，并介绍其参数估计与解释的独特之处。随后，在**应用与跨学科联系**一章中，我们将展示该模型在流行病学、临床试验、生物信息学乃至[联邦学习](@entry_id:637118)等前沿领域的广泛应用，揭示其作为解决实际问题的桥梁作用。最后，通过一系列精心设计的**动手实践**，您将有机会将理论知识转化为解决具体问题的能力，从而真正掌握分层Cox模型的精髓。

## 原理与机制

在生存分析中，Cox比例风险模型是一个强大而灵活的工具，但其有效性依赖于一个核心假设：**[比例风险](@entry_id:166780)（Proportional Hazards, PH）**假设。该假设要求任意两个个体之间的风险比（Hazard Ratio）在时间上保持恒定。然而，在许多实际研究中，尤其是涉及多中心临床试验或具有重要分组变量（如疾病分期）的研究中，这一假设可能被违反。例如，不同临床中心的基线风险模式可能随时间以不同方式演变，导致中心之间的风险比随时间变化。分层[Cox模型](@entry_id:164053)（Stratified Cox Model）正是为了应对这一挑战而设计的。本章将深入探讨分层Cox模型的原理、机制、估计方法及其在复杂分析场景中的高级应用。

### 为何需要分层：处理非[比例风险](@entry_id:166780)

标准的Cox模型假定所有协变量对风险函数的影响都是乘法性的，且与时间无关。考虑一个包含协变量向量 $X$ 和一个[分类变量](@entry_id:637195) $S$（例如，表示临床中心）的模型。如果我们简单地将 $S$ 作为一个协变量纳入模型，其风险函数形式为：
$h(t \mid X, S) = h_0(t) \exp(\beta'X + \gamma'S)$
其中 $S$ 被编码为一组[指示变量](@entry_id:266428)。这个模型强制要求不同中心（即 $S$ 的不同水平）之间的风险比（例如，$\exp(\gamma_s)$）在所有时间点 $t$ 上都是恒定的。

然而，如果不同中心的基线风险随访时间的变化趋势不同，即它们的基线[风险函数](@entry_id:166593) $h_{0s}(t)$ 的形状各异，那么[比例风险假设](@entry_id:163597)就不成立。在这种情况下，强行拟合上述模型会导致模型误设。如果分层变量 $S$ 与我们关心的协变量 $X$ 相关，这种误设可能导致对 $X$ 的效应估计（即 $\beta$）产生偏倚。

分层Cox模型提供了一种优雅的解决方案。它不是将 $S$ 作为一个协变量来估计其效应，而是将其作为一个**分层变量**。其核心思想是：在每个由 $S$ 定义的层（stratum）内部，[比例风险假设](@entry_id:163597)对其他协变量 $X$ 仍然成立，但允许不同层之间有完全任意的基线风险。

### 分层Cox比例风险模型

#### 模型设定

分层Cox模型将总体划分为由[分类变量](@entry_id:637195) $S$ 定义的 $K$ 个互不重叠的层。对于层 $s$ 中的一个个体，其在时间 $t$ 的[风险函数](@entry_id:166593)由下式给出：

$h(t \mid X, S=s) = h_{0s}(t) \exp(\beta'X)$

这个模型包含两个关键组成部分：

1.  **层特异性基线[风险函数](@entry_id:166593) $h_{0s}(t)$**：每个层 $s$ 都有其自己独立的、形式完全任意的非负基线[风险函数](@entry_id:166593)。模型对这些函数之间的关系不做任何假设——它们既不需要相等，也不需要成比例。这正是该模型能够灵活处理分层变量 $S$ 的非比例风险效应的关键。

2.  **共同的[回归系数](@entry_id:634860) $\beta$**：[回归系数](@entry_id:634860)向量 $\beta$ 被假定在所有层中是相同的。这意味着协变量 $X$ 对风险的影响（即对数风险比）在所有中心或所有疾病分期中是恒定的。

#### 参数的解释

在分层Cox模型中，参数 $\beta$ 的解释必须在层的背景下进行。考虑协变量向量 $X$ 中的第 $k$ 个分量 $X_k$ 及其对应的系数 $\beta_k$。设想在**同一个层 $s$ 内**有两个个体，他们的协变量除了 $X_k$ 相差一个单位外完全相同。他们的风险比为：

$$ \frac{h(t \mid X_2, S=s)}{h(t \mid X_1, S=s)} = \frac{h_{0s}(t) \exp(\beta'X_2)}{h_{0s}(t) \exp(\beta'X_1)} = \exp(\beta'(X_2 - X_1)) = \exp(\beta_k) $$

层特异性的基线风险函数 $h_{0s}(t)$ 在比值中被约去。因此，$\beta_k$ 是在**任意层内**，当其他协变量保持不变时，$X_k$ 每增加一个单位所对应的对数风险比。这个解释既不依赖于时间 $t$，也不依赖于具体的层 $s$。

一个至关重要的推论是，分层Cox模型**不能**用于估计或比较不同层之间的风险。比较来自不同层 $s_1$ 和 $s_2$ 的两个个体，即使他们的协变量 $X$ 完全相同，其风险比为 $h_{0s_1}(t) / h_{0s_2}(t)$。由于 $h_{0s}(t)$ 是形式任意且不被直接估计的，这个比值是未知的，并且通常随时间变化。同样，任何在层内保持不变的协变量（例如，描述中心特征的变量）的效应都是不可识别的，因为其效应会与层特异性的基线[风险函数](@entry_id:166593)完全混淆，并在似然计算中被抵消掉。

### 估计与推断

#### 分层偏似然函数

分层Cox模型的参数估计是通过最大化**分层偏[似然函数](@entry_id:141927)（Stratified Partial Likelihood）**来实现的。其基本原理是将总体的偏似然函数分解为各个层内部偏似然函数的乘积。

$L(\beta) = \prod_{s=1}^{K} L_s(\beta)$

在每个层 $s$ 内部，其偏[似然函数](@entry_id:141927) $L_s(\beta)$ 的构造方式与标准Cox模型相同，但有一个关键区别：在任意一个事件时间点 $T_i$，用于计算似然贡献的**风险集（Risk Set）**仅包含那些**处于同一层**且在该时间点仍处于风险中的个体。

具体而言，假设在层 $s$ 中，个体 $i$ 在时间 $T_i$ 发生事件。该事件对[偏似然](@entry_id:165240)的贡献是，在给定层 $s$ 的风险集 $R_s(T_i)$ 中恰好是 $i$ 发生事件的条件概率。其表达式为：

$$ \frac{\exp(\beta' X_i)}{\sum_{j \in R_s(T_i)} \exp(\beta' X_j)} $$

总的对数偏[似然函数](@entry_id:141927)是所有事件贡献的总和：
$\ell(\beta) = \sum_{s=1}^{K} \sum_{i \in D_s} \left[ \beta'X_i - \ln\left(\sum_{j \in R_s(T_i)} \exp(\beta'X_j)\right) \right]$
其中 $D_s$ 是层 $s$ 中发生事件的个体集合。

由此，我们可以推导出用于求解 $\hat{\beta}$ 的得分函数 $U(\beta)$：

$$ U(\beta) = \frac{\partial \ell(\beta)}{\partial \beta} = \sum_{s=1}^{K} \sum_{i \in D_s} \left[ X_i - \frac{\sum_{j \in R_s(T_i)} X_j \exp(\beta' X_j)}{\sum_{j \in R_s(T_i)} \exp(\beta' X_j)} \right] $$

上式中，$\frac{\sum_{j \in R_s(T_i)} X_j \exp(\beta' X_j)}{\sum_{j \in R_s(T_i)} \exp(\beta' X_j)}$ 可以被看作是在事件时间 $T_i$，层 $s$ 风险集内协变量的风险加权平均值。因此，得分函数的核心思想是，在所有事件时间点，发生事件个体的协变量值与其层内风险集中协变量的[期望值](@entry_id:150961)（在风险加权意义下）之差的总和。当这个总差值接近于零时，我们就得到了 $\beta$ 的最大[偏似然](@entry_id:165240)估计 $\hat{\beta}$。

#### 事件时间平局的处理

当多个事件在同一时间点发生（即存在**平局 tied events**）时，[偏似然](@entry_id:165240)的计算需要调整。在[分层模型](@entry_id:274952)中，这个调整同样是在层内进行的。例如，在时间 $t^*$，层1发生了2个事件，层2发生了1个事件。这并不构成一个大小为3的平局。正确的处理方式是：在层1内部，我们处理一个大小为2的平局（例如使用Breslow或Efron近似）；在层2内部，我们处理一个单独的事件。因为风险集是按层分离的，跨层的同时事件在似然计算中是相互独立的。

#### 基线[累积风险函数](@entry_id:169734)的估计

在获得 $\beta$ 的一致估计 $\hat{\beta}$ 后，我们可以进而估计每个层的基线[累积风险函数](@entry_id:169734) $H_{0s}(t) = \int_0^t h_{0s}(u)du$。这通常采用一种称为**Breslow估计量**的[非参数方法](@entry_id:138925)。对于每个层 $s$，其估计量为：

$$ \hat{H}_{0s}(t) = \sum_{T_{sj} \le t} \frac{d_{sj}}{\sum_{i \in R_s(T_{sj})} \exp(\hat{\beta}'X_i)} $$

其中，$T_{sj}$ 是层 $s$ 中的第 $j$ 个唯一事件时间，$d_{sj}$ 是在该时间点层 $s$ 内发生的事件数。这个估计量的构建完全基于层 $s$ 内部的数据（事件和风险集），唯一的外部信息是所有层共同估计出的 $\hat{\beta}$。因此，对于基线风险的估计，模型并不会在不同层之间“借用信息”。

### 高级主题与实践考量

#### 条件效应与[边际效应](@entry_id:634982)：不可坍塌性问题

分层Cox模型估计的 $\beta$ 代表一个**条件（conditional）**对数风险比，即在给定层（如医院）内部的效应。一个自然的问题是：这个条件风险比是否等于整个研究人群（即忽略分层）的**边际（marginal）**风险比？答案通常是否定的。风险比（Hazard Ratio）是一种**不可坍塌的（non-collapsible）**度量。

即使在随机化试验中，协变量 $X$ 与分层变量 $S$ 独立（$X \perp S$），条件风险比 $\exp(\beta)$ 通常也不等于边际风险比。其根本原因在于，当不同层的基线风险 $h_{0s}(t)$ 不同时，随着时间的推移，不同治疗组（$X=0$ 和 $X=1$）的风险集构成会发生差异性改变。例如，在高风险层中，高风险治疗组的受试者会更快地“耗尽”（发生事件或被删失），导致该治疗组的风险集在后续时间点更多地由来自低风险层的“幸存者”构成。这种动态变化的构成使得边际风险比会随时间变化，并且不等于恒定的条件风险比 $\exp(\beta)$。

只有在非常特殊的情况下，例如所有层的基线[风险函数](@entry_id:166593)都相同时（$h_{0s}(t)$ 对所有 $s$ 都相同），或者当事件非常罕见以至于生存率在所有层和所有时间点都接近1时，条件风险比才约等于边际风险比。

#### 稀疏层带来的挑战

当分层导致许多层内事件数量非常少（例如，0、1或2个事件）时，会出现统计挑战。这种情况在拥有大量中心但每个中心患者不多的多中心研究中很常见。

1.  **[方差膨胀](@entry_id:756433)**：Fisher信息量与事件数量近似成正比。大量稀疏层意味着总信息量较低，从而导致 $\hat{\beta}$ 的标准误增大，估计精度下降。
2.  **小样本偏倚**：在事件稀少的层内，协变量很容易完美或接近完美地预测事件（即**分离 separation**现象），导致该层的似然贡献趋于单调，从而对 $\hat{\beta}$ 的整体估计产生显著的小样本偏倚。

应对这些挑战的策略包括：
*   **合并层**：如果根据外部知识或数据探索，有理由相信某些小层具有相似的基线风险，可以将它们合并成一个更大的层。这能有效增加每个风险集的大小，提高估计的效率和稳健性。
*   **惩罚似然方法**：可以使用Firth校正（一种基于Jeffreys先验的惩罚）来消除一阶偏倚并解决分离问题。或者使用[岭回归](@entry_id:140984)（$L_2$惩罚）来压缩[回归系数](@entry_id:634860)，通过引入少量偏倚来大幅降低方差，从而稳定估计。

#### 分层模型与脆弱模型：固定效应与随机效应的对比

分层Cox模型将层效应视为**固定效应（fixed effects）**，通过为每层引入一个独立的非参数基线风险函数来控制。这种方法稳健性强，因为它不对层间效应的分布做任何假设。

另一种处理聚[类数](@entry_id:156164)据（如多中心数据）的方法是**共享脆弱模型（shared frailty model）**，它将层效应视为**随机效应（random effects）**。一个典型的脆弱模型形式为：

$h(t \mid X, S=s, u_s) = h_0(t) u_s \exp(\beta'X)$

其中，$u_s$ 是一个未观测到的、服从特定参数分布（如Gamma分布）的随机变量，代表层 $s$ 的脆弱度或随机效应。该模型假设所有层共享一个共同的基线[风险函数](@entry_id:166593) $h_0(t)$，并通过估计脆弱度分布的方差 $\theta$ 来量化层间的异质性。

这两种方法的关键区别在于：

*   **假设**：[分层模型](@entry_id:274952)更稳健，无需假设层效应的分布。脆弱模型则需要指定一个参数分布，如果分布指定错误，可能导致偏倚。
*   **推断目标**：分层模型不估计层效应本身。脆弱模型则可以估计层间异质性的大小（即方差 $\theta$），并允许对单个中心的随机效应进行预测。
*   **参数解释**：尽管两种模型都估计一个“条件”$\beta$，但它们所属的数据生成机制不同，因此严格来说，它们的目标参数（estimand）也不同。
*   **数据要求**：[分层模型](@entry_id:274952)对每个层的数据要求较低（理论上每层只需一个事件即可为 $\beta$ 的估计贡献信息）。而要稳定地估计脆弱度方差 $\theta$，则需要相当一部分层内有多个事件发生。

总之，分层Cox模型是处理生存数据中非[比例风险](@entry_id:166780)和聚类效应的强大工具。它通过在层内进行比较来绕过对分层变量比例风险的假设，同时保持对其他协变量效应的有效推断。理解其模型设定、参数解释以及与[边际效应](@entry_id:634982)和随机效应模型的区别，对于在医学统计研究中正确应用该模型至关重要。