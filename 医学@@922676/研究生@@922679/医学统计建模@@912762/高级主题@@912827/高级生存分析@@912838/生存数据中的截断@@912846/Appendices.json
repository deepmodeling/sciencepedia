{"hands_on_practices": [{"introduction": "在处理左截断生存数据时，首要步骤是正确定义在每个事件时间点上有哪些研究对象处于风险之中。本练习旨在通过一个具体的数据集，让你亲手构建随时间变化的风险集，并在此基础上计算Kaplan-Meier生存估计值。这个基本功的训练将帮助你深入理解截断如何影响风险集的构成，以及为何正确的风险集是获得无偏生存估计的前提。[@problem_id:4985814]", "problem": "一项临床研究追踪患者首次心血管事件的发生时间，单位为月。由于招募延迟，每位患者可能会在一段延迟后才进入研究，这会产生左截断；如果患者失访或研究在事件发生前结束，则可能会出现右删失。对于患者 $i$，观测数据为左截断时间 $L_i$、观测时间 $T_i$ 和事件指示符 $\\delta_i$，其中 $\\delta_i = 1$ 表示在时间 $T_i$ 发生了事件，$\\delta_i = 0$ 表示在时间 $T_i$ 发生了右删失。8 位患者的数据集如下：\n- 患者 1：$(L_1 = 0, T_1 = 3, \\delta_1 = 1)$。\n- 患者 2：$(L_2 = 1, T_2 = 5, \\delta_2 = 1)$。\n- 患者 3：$(L_3 = 2, T_3 = 6, \\delta_3 = 0)$。\n- 患者 4：$(L_4 = 4, T_4 = 7, \\delta_4 = 1)$。\n- 患者 5：$(L_5 = 0.5, T_5 = 9, \\delta_5 = 1)$。\n- 患者 6：$(L_6 = 3.2, T_6 = 8, \\delta_6 = 0)$。\n- 患者 7：$(L_7 = 5.5, T_7 = 10, \\delta_7 = 0)$。\n- 患者 8：$(L_8 = 0, T_8 = 4, \\delta_8 = 0)$。\n\n假设没有同时发生的事件，也没有在事件发生的确切时间点发生删失。\n\n请仅使用生存分析中风险集和计数过程的基本定义，计算在每个不同的观测事件发生时间 $u$ 的风险集大小 $Y(u)$ 和事件数 $d(u)$。在每个事件发生时间 $u$，验证风险集排除了那些尚未进入研究的个体（即 $L_i > u$）或在 $u$ 之前已经被删失或发生事件的个体。然后，使用这些值和乘积极限原理，计算在 $t = 9$ 个月时的 Kaplan–Meier (KM) 生存估计值，记为 $\\hat{S}(9)$。请将最终答案表示为精确分数，不要四舍五入。", "solution": "我们首先使用带有左截断和右删失的生存数据的标准计数过程符号。对每个个体 $i$，定义事件计数过程\n$$\nN_i(t) = \\mathbf{1}\\{T_i \\le t, \\delta_i = 1\\},\n$$\n和在险指示符\n$$\nY_i(t) = \\mathbf{1}\\{L_i \\le t \\le T_i\\}.\n$$\n在时间 $t$ 的风险集为 $R(t) = \\{i : Y_i(t) = 1\\}$，其大小为 $Y(t) = |R(t)|$。在时间 $t$ 的事件数为 $d(t) = \\sum_{i=1}^{n} \\mathbf{1}\\{T_i = t, \\delta_i = 1\\}$。在有左截断的情况下，个体仅在进入研究后（即时间 $t$ 大于或等于其 $L_i$ 时）才对风险集有贡献；在有右删失的情况下，个体在其删失时间之后严格离开风险集。\n\n数据集中的不同观测事件发生时间为 $u \\in \\{3, 5, 7, 9\\}$。我们在每个事件发生时间 $u$ 计算 $R(u)$ 和 $Y(u)$，并验证左截断和右删失所要求的排除条件。\n\n在 $u = 3$ 时：\n- 包括满足 $L_i \\le 3$ 和 $T_i \\ge 3$ 的患者：患者 $1$ ($L_1 = 0, T_1 = 3$)、患者 $2$ ($L_2 = 1, T_2 = 5$)、患者 $3$ ($L_3 = 2, T_3 = 6$)、患者 $5$ ($L_5 = 0.5, T_5 = 9$) 和患者 $8$ ($L_8 = 0, T_8 = 4$)。\n- 排除尚未进入研究的患者：患者 $4$ ($L_4 = 4$)、患者 $6$ ($L_6 = 3.2$)、患者 $7$ ($L_7 = 5.5$)。\n- 在时间点 3 之前，没有人被删失或发生事件。\n因此，$R(3) = \\{1, 2, 3, 5, 8\\}$，所以 $Y(3) = 5$，且 $d(3) = 1$（患者 1 在时间 3 发生事件）。\n\n在 $u = 5$ 时：\n- 移除在时间点 5 之前发生事件或被删失的患者：患者 1（在时间 3 发生事件）和患者 8（在时间 4 被删失）不再处于风险中。\n- 包括满足 $L_i \\le 5$ 和 $T_i \\ge 5$ 的患者：患者 $2$ ($L_2 = 1, T_2 = 5$)、患者 $3$ ($L_3 = 2, T_3 = 6$)、患者 $4$ ($L_4 = 4, T_4 = 7$)、患者 $5$ ($L_5 = 0.5, T_5 = 9$) 和患者 $6$ ($L_6 = 3.2, T_6 = 8$)。\n- 排除尚未进入研究的患者：患者 $7$ ($L_7 = 5.5$)。\n这验证了排除了尚未进入研究和已经被移除的个体。因此，$R(5) = \\{2, 3, 4, 5, 6\\}$，所以 $Y(5) = 5$，且 $d(5) = 1$（患者 2 在时间 5 发生事件）。\n\n在 $u = 7$ 时：\n- 移除在时间点 7 之前发生事件或被删失的患者：患者 2（在时间 5 发生事件）被移除；患者 3（在时间 6 被删失）被移除。\n- 包括满足 $L_i \\le 7$ 和 $T_i \\ge 7$ 的患者：患者 $4$ ($L_4 = 4, T_4 = 7$)、患者 $5$ ($L_5 = 0.5, T_5 = 9$)、患者 $6$ ($L_6 = 3.2, T_6 = 8$) 和患者 $7$ ($L_7 = 5.5, T_7 = 10$)。\n这再次验证了排除了在时间点 7 之前被删失的个体，且仅在左截断后才将其纳入。因此，$R(7) = \\{4, 5, 6, 7\\}$，所以 $Y(7) = 4$，且 $d(7) = 1$（患者 4 在时间 7 发生事件）。\n\n在 $u = 9$ 时：\n- 移除在时间点 9 之前发生事件或被删失的患者：患者 4（在时间 7 发生事件）和患者 6（在时间 8 被删失）被移除。\n- 包括满足 $L_i \\le 9$ 和 $T_i \\ge 9$ 的患者：患者 $5$ ($L_5 = 0.5, T_5 = 9$) 和患者 $7$ ($L_7 = 5.5, T_7 = 10$)。\n因此，$R(9) = \\{5, 7\\}$，所以 $Y(9) = 2$，且 $d(9) = 1$（患者 5 在时间 9 发生事件）。\n\n我们已经在每个事件发生时间验证了 $R(u)$ 排除了那些尚未进入研究的个体（即 $L_i > u$）和那些在 $u$ 之前已经发生事件或被删失的个体。利用这些风险集大小和事件计数，我们计算在 $t = 9$ 个月时的 Kaplan–Meier (KM) 乘积极限生存估计：\n$$\n\\hat{S}(9) = \\prod_{u \\in \\{3, 5, 7, 9\\}} \\left(1 - \\frac{d(u)}{Y(u)}\\right) = \\left(1 - \\frac{1}{5}\\right)\\left(1 - \\frac{1}{5}\\right)\\left(1 - \\frac{1}{4}\\right)\\left(1 - \\frac{1}{2}\\right).\n$$\n计算该乘积，\n$$\n\\hat{S}(9) = \\frac{4}{5} \\cdot \\frac{4}{5} \\cdot \\frac{3}{4} \\cdot \\frac{1}{2} = \\frac{16}{25} \\cdot \\frac{3}{8} = \\frac{48}{200} = \\frac{6}{25}.\n$$\n因此，在 $t = 9$ 个月时的 KM 生存估计为 $\\hat{S}(9) = \\frac{6}{25}$。", "answer": "$$\\boxed{\\frac{6}{25}}$$", "id": "4985814"}, {"introduction": "计算出生存函数的点估计后，评估其统计精度同样重要。本练习将引导你从第一性原理出发，推导适用于左截断和右删失数据的Kaplan-Meier估计量的Greenwood型方差公式。通过将理论推导应用于实际计算，你将掌握量化生存估计不确定性的方法，这对于构建置信区间和进行严谨的统计推断至关重要。[@problem_id:4992405]", "problem": "一项针对晚期心力衰竭患者的队列研究仅在诊断后、发生感兴趣事件（死亡）前招募个体。由于个体必须存活到其进入研究的时间才能被观察到，因此数据存在左截断问题。每位患者贡献了一个进入时间 $A_i$、一个观测时间 $X_i$ 和一个事件指示符 $\\delta_i \\in \\{0,1\\}$，其中 $\\delta_i = 1$ 表示在时间 $X_i$ 发生事件，$\\delta_i = 0$ 表示在时间 $X_i$ 发生右删失。目标是失效时间 $T$ 在条件 $T \\ge A$ 下的生存函数 $S(t)$，使用延迟进入 Kaplan–Meier (KM) 估计量进行估计。\n\n给定 $n=8$ 位患者的数据：\n- 患者 $1$：$(A_1, X_1, \\delta_1) = (0.5, 3.0, 1)$\n- 患者 $2$：$(A_2, X_2, \\delta_2) = (1.0, 6.0, 0)$\n- 患者 $3$：$(A_3, X_3, \\delta_3) = (2.0, 5.0, 1)$\n- 患者 $4$：$(A_4, X_4, \\delta_4) = (4.0, 9.0, 0)$\n- 患者 $5$：$(A_5, X_5, \\delta_5) = (0.0, 8.0, 1)$\n- 患者 $6$：$(A_6, X_6, \\delta_6) = (7.0, 10.0, 1)$\n- 患者 $7$：$(A_7, X_7, \\delta_7) = (5.0, 7.0, 1)$\n- 患者 $8$：$(A_8, X_8, \\delta_8) = (8.5, 12.0, 0)$\n\n仅使用风险、生存和计数过程的基本定义，推导在左截断和右删失情况下，延迟进入 Kaplan–Meier 生存估计量的 Greenwood 型渐近方差表达式。然后，应用您的推导计算上述数据集在 $t^\\star = 8$ 时 $\\hat{S}(t)$ 的方差估计值。将最终数值表示为无舍入的精确分数。", "solution": "### 第一部分：Greenwood 型方差公式的推导\n\n设 $T$ 为失效时间随机变量。生存函数为 $S(t) = P(T > t)$。给定来自 $n$ 个个体的数据 $(A_i, X_i, \\delta_i)$，其中 $i \\in \\{1, \\dots, n\\}$，$A_i$ 是左截断（进入）时间，$X_i = \\min(T_i, C_i)$ 是观测时间（其中 $T_i$ 是失效时间，$C_i$ 是删失时间），$\\delta_i = I(T_i \\le C_i)$ 是事件指示符。只有当个体 $i$ 存活到其进入时间，即 $T_i \\ge A_i$ 时，才被纳入研究。\n\n设排序后的不同事件时间为 $t_1  t_2  \\dots  t_k$。\n在存在左截断的情况下，生存函数 $S(t)$ 的 Kaplan-Meier 估计量由下式给出：\n$$ \\hat{S}(t) = \\prod_{j: t_j \\le t} \\left(1 - \\frac{d_j}{Y_j}\\right) $$\n其中 $d_j$ 是在时间 $t_j$ 发生的事件数，$Y_j$ 是在时间 $t_j$ 之前处于风险中的个体数。对于左截断数据，关键的修正在于风险集 $R(t)$ 的定义，它包括在时间 $t$ 前已进入研究且尚未经历事件或被删失的个体。\n在时间 $t_j$ 的风险集大小为：\n$$ Y_j = |R(t_j)| = \\left|\\{i: A_i \\le t_j \\le X_i\\}\\right| = \\sum_{i=1}^n I(A_i \\le t_j \\le X_i) $$\n在时间 $t_j$ 的事件数为：\n$$ d_j = \\sum_{i=1}^n I(X_i = t_j, \\delta_i = 1) $$\n为了推导方差，我们使用 delta 方法。首先求 $\\ln(\\hat{S}(t))$ 的方差会更方便。\n$$ \\ln(\\hat{S}(t)) = \\ln\\left(\\prod_{j: t_j \\le t} \\left(1 - \\frac{d_j}{Y_j}\\right)\\right) = \\sum_{j: t_j \\le t} \\ln\\left(1 - \\frac{d_j}{Y_j}\\right) $$\n该和式中对应于不同事件时间的项是近似独立的。因此，和的方差约等于方差的和：\n$$ \\text{Var}[\\ln(\\hat{S}(t))] \\approx \\sum_{j: t_j \\le t} \\text{Var}\\left[\\ln\\left(1 - \\frac{d_j}{Y_j}\\right)\\right] $$\n在风险集 $Y_j$ 的条件下，事件数 $d_j$ 可以建模为二项分布随机变量，$d_j \\sim \\text{Binomial}(Y_j, \\pi_j)$，其中 $\\pi_j$ 是在 $t_j$ 时发生事件的条件概率。这个概率的估计量是 $\\hat{\\pi}_j = d_j/Y_j$。$\\hat{\\pi}_j$ 的方差是 $\\text{Var}[\\hat{\\pi}_j] = \\frac{\\pi_j(1-\\pi_j)}{Y_j}$。\n\n我们对函数 $g(\\pi) = \\ln(1-\\pi)$ 应用 delta 方法。其导数为 $g'(\\pi) = -\\frac{1}{1-\\pi}$。$g(\\hat{\\pi}_j)$ 的方差近似为：\n$$ \\text{Var}[g(\\hat{\\pi}_j)] \\approx [g'(\\pi_j)]^2 \\text{Var}[\\hat{\\pi}_j] = \\left(-\\frac{1}{1-\\pi_j}\\right)^2 \\frac{\\pi_j(1-\\pi_j)}{Y_j} = \\frac{1}{(1-\\pi_j)^2} \\frac{\\pi_j(1-\\pi_j)}{Y_j} = \\frac{\\pi_j}{Y_j(1-\\pi_j)} $$\n我们通过用 $\\pi_j$ 的估计值 $\\hat{\\pi}_j = d_j/Y_j$ 来替换 $\\pi_j$，从而估计这个方差：\n$$ \\widehat{\\text{Var}}\\left[\\ln\\left(1 - \\frac{d_j}{Y_j}\\right)\\right] = \\frac{d_j/Y_j}{Y_j(1 - d_j/Y_j)} = \\frac{d_j/Y_j}{Y_j\\left(\\frac{Y_j-d_j}{Y_j}\\right)} = \\frac{d_j}{Y_j(Y_j-d_j)} $$\n对所有直到 $t$ 的事件时间求和，得到 $\\ln(\\hat{S}(t))$ 的估计方差：\n$$ \\widehat{\\text{Var}}[\\ln(\\hat{S}(t))] = \\sum_{j: t_j \\le t} \\frac{d_j}{Y_j(Y_j-d_j)} $$\n为了求出 $\\hat{S}(t)$ 的方差，我们再次应用 delta 方法，这次是对从 $\\ln(S)$ 到 $S$ 的变换。由于 $\\hat{S}(t) = \\exp(\\ln(\\hat{S}(t)))$，且对于 $f(x) = \\exp(x)$，$f'(x) = \\exp(x)$，我们有：\n$$ \\text{Var}[\\hat{S}(t)] \\approx \\left(\\frac{d}{d\\ln S} S\\right)^2 \\text{Var}[\\ln(\\hat{S}(t))] = [S(t)]^2 \\text{Var}[\\ln(\\hat{S}(t))] $$\n代入估计值，得到延迟进入 Kaplan-Meier 估计量方差的 Greenwood 型公式：\n$$ \\widehat{\\text{Var}}[\\hat{S}(t)] = [\\hat{S}(t)]^2 \\sum_{j: t_j \\le t} \\frac{d_j}{Y_j(Y_j-d_j)} $$\n这个推导是成立的，因为左截断的影响在风险集 $Y_j$ 的构建中已完全被考虑。\n\n### 第二部分：$\\widehat{\\text{Var}}[\\hat{S}(8)]$ 的计算\n\n我们将推导出的公式应用于给定数据集，计算 $t^\\star = 8$ 的情况。\n数据集为：\n患者$1$：$(0.5, 3.0, 1)$，患者$2$：$(1.0, 6.0, 0)$，患者$3$：$(2.0, 5.0, 1)$，患者$4$：$(4.0, 9.0, 0)$，患者$5$：$(0.0, 8.0, 1)$，患者$6$：$(7.0, 10.0, 1)$，患者$7$：$(5.0, 7.0, 1)$，患者$8$：$(8.5, 12.0, 0)$。\n\n首先，我们确定 $t_j \\le 8$ 的不同事件时间：$t_1=3.0$，$t_2=5.0$，$t_3=7.0$ 和 $t_4=8.0$。\n\n接下来，我们构建一个表格来计算每个事件时间的 $d_j$、$Y_j$、生存概率因子和方差分量。\n\n1.  **事件时间 $t_1 = 3.0$：**\n    -   事件：患者 $1$。所以 $d_1 = 1$。\n    -   风险集 $R(3.0) = \\{i: A_i \\le 3.0 \\le X_i\\}$：\n        -   患者$1: 0.5 \\le 3.0 \\le 3.0$ (是)\n        -   患者$2: 1.0 \\le 3.0 \\le 6.0$ (是)\n        -   患者$3: 2.0 \\le 3.0 \\le 5.0$ (是)\n        -   患者$5: 0.0 \\le 3.0 \\le 8.0$ (是)\n    -   $Y_1 = 4$。\n    -   KM 因子：$1 - \\frac{1}{4} = \\frac{3}{4}$。方差项：$\\frac{1}{4(4-1)} = \\frac{1}{12}$。\n\n2.  **事件时间 $t_2 = 5.0$：**\n    -   事件：患者 $3$。所以 $d_2 = 1$。\n    -   风险集 $R(5.0) = \\{i: A_i \\le 5.0 \\le X_i\\}$：\n        -   患者$2: 1.0 \\le 5.0 \\le 6.0$ (是)\n        -   患者$3: 2.0 \\le 5.0 \\le 5.0$ (是)\n        -   患者$4: 4.0 \\le 5.0 \\le 9.0$ (是)\n        -   患者$5: 0.0 \\le 5.0 \\le 8.0$ (是)\n        -   患者$7: 5.0 \\le 5.0 \\le 7.0$ (是)\n    -   $Y_2 = 5$。\n    -   KM 因子：$1 - \\frac{1}{5} = \\frac{4}{5}$。方差项：$\\frac{1}{5(5-1)} = \\frac{1}{20}$。\n\n3.  **事件时间 $t_3 = 7.0$：**\n    -   事件：患者 $7$。所以 $d_3 = 1$。\n    -   风险集 $R(7.0) = \\{i: A_i \\le 7.0 \\le X_i\\}$：\n        -   患者$4: 4.0 \\le 7.0 \\le 9.0$ (是)\n        -   患者$5: 0.0 \\le 7.0 \\le 8.0$ (是)\n        -   患者$6: 7.0 \\le 7.0 \\le 10.0$ (是)\n        -   患者$7: 5.0 \\le 7.0 \\le 7.0$ (是)\n    -   $Y_3 = 4$。\n    -   KM 因子：$1 - \\frac{1}{4} = \\frac{3}{4}$。方差项：$\\frac{1}{4(4-1)} = \\frac{1}{12}$。\n\n4.  **事件时间 $t_4 = 8.0$：**\n    -   事件：患者 $5$。所以 $d_4 = 1$。\n    -   风险集 $R(8.0) = \\{i: A_i \\le 8.0 \\le X_i\\}$：\n        -   患者$4: 4.0 \\le 8.0 \\le 9.0$ (是)\n        -   患者$5: 0.0 \\le 8.0 \\le 8.0$ (是)\n        -   患者$6: 7.0 \\le 8.0 \\le 10.0$ (是)\n    -   $Y_4 = 3$。\n    -   KM 因子：$1 - \\frac{1}{3} = \\frac{2}{3}$。方差项：$\\frac{1}{3(3-1)} = \\frac{1}{6}$。\n\n现在我们可以计算所需的组成部分。\nKM 估计值 $\\hat{S}(8)$ 为：\n$$ \\hat{S}(8) = \\prod_{j=1}^4 \\left(1 - \\frac{d_j}{Y_j}\\right) = \\left(\\frac{3}{4}\\right)\\left(\\frac{4}{5}\\right)\\left(\\frac{3}{4}\\right)\\left(\\frac{2}{3}\\right) = \\frac{72}{240} = \\frac{3}{10} $$\n方差的求和项为：\n$$ \\sum_{j: t_j \\le 8} \\frac{d_j}{Y_j(Y_j-d_j)} = \\frac{1}{12} + \\frac{1}{20} + \\frac{1}{12} + \\frac{1}{6} $$\n$$ = \\frac{2}{12} + \\frac{1}{6} + \\frac{1}{20} = \\frac{1}{6} + \\frac{1}{6} + \\frac{1}{20} = \\frac{2}{6} + \\frac{1}{20} = \\frac{1}{3} + \\frac{1}{20} $$\n使用公分母 $60$：\n$$ = \\frac{20}{60} + \\frac{3}{60} = \\frac{23}{60} $$\n最后，我们计算方差估计值：\n$$ \\widehat{\\text{Var}}[\\hat{S}(8)] = [\\hat{S}(8)]^2 \\sum_{j: t_j \\le 8} \\frac{d_j}{Y_j(Y_j-d_j)} = \\left(\\frac{3}{10}\\right)^2 \\left(\\frac{23}{60}\\right) $$\n$$ = \\left(\\frac{9}{100}\\right) \\left(\\frac{23}{60}\\right) = \\frac{9 \\times 23}{100 \\times 60} = \\frac{207}{6000} $$\n这个分数可以通过将分子和分母除以它们的最大公约数 $3$ 来简化：\n$$ \\widehat{\\text{Var}}[\\hat{S}(8)] = \\frac{207 \\div 3}{6000 \\div 3} = \\frac{69}{2000} $$\n$69$ 的质因数是 $3$ 和 $23$，而 $2000$ 的质因数是 $2$ 和 $5$。没有更多的公因数，所以这个分数是最简形式。", "answer": "$$\\boxed{\\frac{69}{2000}}$$", "id": "4992405"}, {"introduction": "生存分析的核心应用之一是比较不同处理组或暴露组的生存曲线。本练习将风险集构建的原理扩展到组间比较的经典方法——对数秩检验（log-rank test）中。通过编程实现并比较两种风险集定义（正确考虑左截断和天真地忽略它）下的检验统计量，你将直观地量化“不朽时间偏倚”对假设检验结果的潜在影响。[@problem_id:3185126]", "problem": "给定多个受试者的生存数据，这些受试者被分为两个治疗组，其事件和删失时间可能在延迟同意后发生。在这种情况下，由于受试者仅在获得同意时才进入研究，因此会出现左截断问题。因此，风险集必须反映从同意时间而非零时间开始进入研究。目标是通过实现从同意时间开始计入的风险集，来研究由延迟同意引起的左截断如何影响组间的对数秩比较，并量化其与忽略延迟进入的朴素对数秩检验之间的差异。\n\n从生存分析的基本定义出发，您必须推导并实现在左截断条件下的对数秩检验。具体来说，使用生存函数 $S(t)$、风险函数 $\\lambda(t)$ 和时间 $t$ 的风险集 $R(t)$ 的定义，并结合以下原理：在风险相等的原假设下，每个事件时间点上某一组的事件数应遵循以该时间点的风险集为条件的超几何分布。然后实现：\n- 一个经过左截断校正的对数秩检验，该检验构建从同意时间开始计入的风险集：当且仅当 $L_i \\le t \\le T_i$ 时，受试者 $i$ 被包含在时间 $t$ 的风险集中，其中 $L_i$ 是同意（进入）时间，$T_i$ 是观测到的事件或删失时间。\n- 一个忽略延迟进入的朴素对数秩检验：将所有受试者视为从观测开始时就处于风险中，当且仅当 $T_i \\ge t$ 时，将受试者 $i$ 包含在时间 $t$ 的风险集中。\n\n对于这两种实现，您都需要汇总所有不同事件时间的数据，计算对数秩得分（目标组中事件的观测数减去期望数）、其在包含重复值的超几何模型下的方差，以及标准化统计量 $Z$。然后，将朴素 $Z$ 与经过左截断校正的 $Z$ 之间的差异量化为绝对差 $|Z_{\\text{naive}} - Z_{\\text{correct}}|$。\n\n此任务的输入是固定的，形式为三个测试用例。每个测试用例提供 $L_i$（同意时间）、$T_i$（事件或删失时间）、$\\delta_i$（事件指示符，1表示事件，0表示删失）和 $G_i$（分组指示符，0和1）的数组。受试者按顺序列出；分组、事件时间和删失在科学上是合理且自洽的。您必须为每个测试用例计算绝对差 $|Z_{\\text{naive}} - Z_{\\text{correct}}|$。\n\n使用以下测试套件：\n\n- 测试用例 1（各组的延迟同意时间不同；事件和删失混合）：\n$$\nL = [\\,0,\\,0,\\,1,\\,2,\\,0,\\,3,\\,4,\\,5,\\,5,\\,6,\\,4,\\,7\\,],\\quad\nT = [\\,5,\\,7,\\,9,\\,6,\\,8,\\,10,\\,9,\\,11,\\,13,\\,12,\\,8,\\,15\\,],\n$$\n$$\n\\delta = [\\,1,\\,1,\\,0,\\,1,\\,0,\\,1,\\,1,\\,0,\\,1,\\,1,\\,0,\\,1\\,],\\quad\nG = [\\,0,\\,0,\\,0,\\,0,\\,0,\\,0,\\,1,\\,1,\\,1,\\,1,\\,1,\\,1\\,].\n$$\n\n- 测试用例 2（无延迟同意；左截断无效的边界情况，包含重复值）：\n$$\nL = [\\,0,\\,0,\\,0,\\,0,\\,0,\\,0,\\,0,\\,0\\,],\\quad\nT = [\\,2,\\,3,\\,5,\\,6,\\,1,\\,3,\\,4,\\,6\\,],\n$$\n$$\n\\delta = [\\,1,\\,1,\\,0,\\,1,\\,1,\\,1,\\,1,\\,0\\,],\\quad\nG = [\\,0,\\,0,\\,0,\\,0,\\,1,\\,1,\\,1,\\,1\\,].\n$$\n\n- 测试用例 3（永生时间偏倚场景；一组同意较晚，另一组较早）：\n$$\nL = [\\,5,\\,5,\\,6,\\,6,\\,7,\\,0,\\,0,\\,0,\\,0,\\,0\\,],\\quad\nT = [\\,9,\\,10,\\,11,\\,12,\\,14,\\,2,\\,4,\\,5,\\,7,\\,8\\,],\n$$\n$$\n\\delta = [\\,1,\\,0,\\,1,\\,0,\\,1,\\,1,\\,1,\\,1,\\,1,\\,0\\,],\\quad\nG = [\\,0,\\,0,\\,0,\\,0,\\,0,\\,1,\\,1,\\,1,\\,1,\\,1\\,].\n$$\n\n您的程序必须：\n- 对于每个测试用例，使用经过左截断校正的风险集计算对数秩标准化统计量 $Z_{\\text{correct}}$，并使用忽略同意时间的朴素风险集计算 $Z_{\\text{naive}}$。\n- 对每个测试用例，报告绝对差 $|Z_{\\text{naive}} - Z_{\\text{correct}}|$，结果为浮点数，四舍五入到 $6$ 位小数。\n\n最终输出格式：\n- 您的程序应生成一行输出，其中包含用方括号括起来的逗号分隔列表形式的结果。对于这三个测试用例，打印\n$$\n[\\,d_1,\\,d_2,\\,d_3\\,],\n$$\n其中 $d_k$ 是测试用例 $k$ 的四舍五入后的绝对差。", "solution": "该问题要求推导并实现适用于存在左截断的生存数据的对数秩检验，并与忽略左截断的朴素实现进行比较。对数秩检验是一种非参数统计检验，用于比较两个或多个组的生存分布。\n\n对数秩检验的基本原理是检验原假设 $H_0$，即所比较的组之间的风险函数 $\\lambda(t)$ 没有差异。对于由组0和组1表示的两个组，原假设为 $H_0: \\lambda_0(t) = \\lambda_1(t)$ 对所有时间 $t$ 成立。在此假设下，在任何事件发生的时间点，该事件在当时处于风险中的任何受试者身上发生的可能性是均等的，无论其属于哪个组。\n\n该检验通过考虑每个不同的事件时间 $t_j$（其中 $j=1, \\dots, k$）来进行。在每个 $t_j$ 时，我们构建一个结果的列联表，并将目标组（例如组1）中观测到的事件数与原假设下的期望数进行比较。\n\n让我们定义在特定事件时间 $t_j$ 的各个量：\n-   $d_j$：在时间 $t_j$ 发生的事件总数。\n-   $R(t_j)$：在时间 $t_j$ 处于风险中的受试者集合。如果一个受试者正在被观察且尚未经历事件或被删失，则他处于风险中。\n-   $N_j = |R(t_j)|$：在时间 $t_j$ 处于风险中的受试者总数。\n-   $N_{1j}$：来自组1且在风险集 $R(t_j)$ 中的受试者数量。\n-   $d_{1j}$：在时间 $t_j$ 组1中观测到的事件数。这是我们的观测值，记为 $O_j = d_{1j}$。\n\n在原假设下，时间 $t_j$ 的 $d_j$ 个事件分布在 $N_j$ 个风险个体中。在组1中观测到的事件数 $d_{1j}$ 服从超几何分布。这类似于从一个包含 $N_j$ 个项目（风险集）的总体中不放回地抽取 $d_j$ 个项目（发生事件的个体），其中 $N_{1j}$ 个项目是特殊类型（属于组1）。\n\n在时间 $t_j$，组1中事件的期望数由该分布的均值给出：\n$$E_j = E[d_{1j}] = d_j \\frac{N_{1j}}{N_j}$$\n在时间 $t_j$，组1中事件数的方差（它正确地处理了重复值，即 $d_j > 1$）由超几何分布的方差给出：\n$$V_j = \\text{Var}(d_{1j}) = \\frac{N_{1j} (N_j - N_{1j}) d_j (N_j - d_j)}{N_j^2 (N_j - 1)}$$\n如果 $N_j \\le 1$，则没有变异性，因此方差为0。\n\n对数秩检验聚合了所有独立事件时间的信息。总得分统计量 $U$ 是观测事件数与期望事件数之差的总和：\n$$U = \\sum_{j=1}^{k} (O_j - E_j) = \\sum_{j=1}^{k} (d_{1j} - E_j)$$\n假设不同事件时间的列联表相互独立，总方差 $V$ 是各个方差的总和：\n$$V = \\sum_{j=1}^{k} V_j$$\n最后，标准化的对数秩检验统计量 $Z$ 计算如下：\n$$Z = \\frac{U}{\\sqrt{V}}$$\n在原假设下，$Z$ 近似服从标准正态分布。如果 $V=0$，那么 $U$ 也必须为0，我们定义 $Z=0$。\n\n这个问题的关键部分在于风险集 $R(t)$ 的定义，它受到延迟同意引起的左截断的影响。设 $L_i$ 为受试者 $i$ 的同意（进入）时间，$T_i$ 为其事件或删失时间。\n\n1.  **经左截断校正的对数秩检验：**受试者只有在进入研究后才处于风险中。因此，时间 $t$ 的风险集必须只包括那些 $t$ 落在其观察期内的受试者。按照规定，当且仅当 $L_i \\le t \\le T_i$ 时，受试者 $i$ 在时间 $t$ 处于风险集中。这是正确的方法。\n\n2.  **朴素对数秩检验：**这种方法错误地忽略了延迟进入时间 $L_i$。它假设所有受试者从时间 $t=0$ 开始就处于风险中。这等同于为所有受试者设置 $L_i = 0$。风险集的定义变为：当且仅当 $T_i \\ge t$ 时，受试者 $i$ 在时间 $t$ 处于风险集中。这可能导致“永生时间偏倚”，即延迟进入的组别在早期表现出更好的生存结果，仅仅是因为他们当时未被观察，因此不可能发生事件。\n\n要实现的算法如下：\n1.  对每个测试用例，从数据中识别出所有唯一的事件时间。\n2.  定义一个函数，该函数根据给定的数据数组 $L, T, \\delta, G$ 计算 $Z$ 统计量。\n3.  在此函数内部，遍历每个唯一的事件时间 $t_j$。\n4.  在每个 $t_j$ 时，根据相应的风险集定义（$L_i \\le t_j \\le T_i$），计算风险集的大小 $N_j$ 和组1中处于风险中的受试者数量 $N_{1j}$。\n5.  在时间 $t_j$ 统计总事件数 $d_j$ 和组1中的事件数 $d_{1j}$。\n6.  计算对得分的贡献 $d_{1j} - E_j$ 和对总方差的贡献 $V_j$。\n7.  将这些贡献相加，得到总的 $U$ 和 $V$。\n8.  计算 $Z = U / \\sqrt{V}$。\n9.  为获得 $Z_{\\text{correct}}$，使用提供的 $L_i$ 值调用该函数。\n10. 为获得 $Z_{\\text{naive}}$，使用所有 $L_i$ 值均设为0来调用该函数。\n11. 该测试用例的最终结果是绝对差 $|Z_{\\text{naive}} - Z_{\\text{correct}}|$。对所有三个测试用例重复此过程。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem by computing the log-rank test under both naive\n    and left-truncation-corrected assumptions and finding the difference.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (\n            [0, 0, 1, 2, 0, 3, 4, 5, 5, 6, 4, 7],\n            [5, 7, 9, 6, 8, 10, 9, 11, 13, 12, 8, 15],\n            [1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 0, 1],\n            [0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1]\n        ),\n        (\n            [0, 0, 0, 0, 0, 0, 0, 0],\n            [2, 3, 5, 6, 1, 3, 4, 6],\n            [1, 1, 0, 1, 1, 1, 1, 0],\n            [0, 0, 0, 0, 1, 1, 1, 1]\n        ),\n        (\n            [5, 5, 6, 6, 7, 0, 0, 0, 0, 0],\n            [9, 10, 11, 12, 14, 2, 4, 5, 7, 8],\n            [1, 0, 1, 0, 1, 1, 1, 1, 1, 0],\n            [0, 0, 0, 0, 0, 1, 1, 1, 1, 1]\n        )\n    ]\n\n    def compute_log_rank_z(L, T, D, G):\n        \"\"\"\n        Computes the log-rank standardized statistic Z.\n\n        Args:\n            L (list or np.ndarray): Consent (entry) times.\n            T (list or np.ndarray): Event or censoring times.\n            D (list or np.ndarray): Event indicators (1=event, 0=censor).\n            G (list or np.ndarray): Group indicators (0 or 1).\n\n        Returns:\n            float: The standardized log-rank statistic Z.\n        \"\"\"\n        # Convert to numpy arrays for vectorized operations\n        L_arr = np.array(L, dtype=np.float64)\n        T_arr = np.array(T, dtype=np.float64)\n        D_arr = np.array(D, dtype=np.int32)\n        G_arr = np.array(G, dtype=np.int32)\n        \n        # Get unique event times in sorted order\n        event_times = np.unique(T_arr[D_arr == 1])\n        \n        U = 0.0  # Log-rank score (Observed - Expected for group 1)\n        V = 0.0  # Variance of the score\n        \n        for t in event_times:\n            # Determine the risk set at time t. A subject i is at risk if L[i] = t and T[i] >= t.\n            at_risk_mask = (L_arr = t)  (T_arr >= t)\n            \n            # Number of subjects at risk\n            N_j = np.sum(at_risk_mask)\n            \n            # Number of subjects at risk in group 1\n            N_1j = np.sum(at_risk_mask  (G_arr == 1))\n            \n            # Number of events at time t\n            events_at_t_mask = (T_arr == t)  (D_arr == 1)\n            d_j = np.sum(events_at_t_mask)\n            \n            if N_j > 0:\n                # Observed events in group 1 at time t\n                d_1j = np.sum(events_at_t_mask  (G_arr == 1))\n                \n                # Expected events in group 1 at time t\n                E_j = d_j * (N_1j / N_j)\n                \n                # Update score\n                U += (d_1j - E_j)\n                \n                # Update variance (only if there is uncertainty, N_j > 1)\n                if N_j > 1:\n                    # Variance of hypergeometric distribution\n                    term1 = float(N_1j)\n                    term2 = float(N_j - N_1j)\n                    term3 = float(d_j)\n                    term4 = float(N_j - d_j)\n                    numerator = term1 * term2 * term3 * term4\n                    denominator = float(N_j)**2 * (N_j - 1)\n                    if denominator > 0:\n                        V_j = numerator / denominator\n                        V += V_j\n\n        # Calculate the standardized statistic Z\n        if V > 0:\n            Z = U / np.sqrt(V)\n        else:\n            Z = 0.0\n            \n        return Z\n\n    results = []\n    for case in test_cases:\n        L, T, D, G = case\n        \n        # 1. Corrected Z-score (with left-truncation)\n        z_correct = compute_log_rank_z(L, T, D, G)\n        \n        # 2. Naive Z-score (ignoring left-truncation, so L_i = 0 for all i)\n        L_naive = [0] * len(L)\n        z_naive = compute_log_rank_z(L_naive, T, D, G)\n        \n        # 3. Absolute difference\n        diff = np.abs(z_naive - z_correct)\n        results.append(round(diff, 6))\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```", "id": "3185126"}]}