{"hands_on_practices": [{"introduction": "要想真正掌握隐马尔可夫模型 (Hidden Markov Models, HMMs) 的强大之处，我们首先要完成一项基础任务：计算一个给定观测序列的概率。这项练习 [@problem_id:4572030] 将计算成本高昂的暴力枚举法与优雅且高效的前向算法进行直接对比。通过亲手完成这两种计算，您将具体地体会到为什么动态规划方法对于处理HMM是不可或缺的。", "problem": "考虑一个离散时间隐马尔可夫模型 (HMM)，其具有两个隐状态 $N=2$ 和一个二元观测字母表 $M=2$，其中观测符号表示为 $a$ 和 $b$。令时间 $t$ 的隐状态为 $Z_t \\in \\{1,2\\}$，时间 $t$ 的观测为 $X_t \\in \\{a,b\\}$。该模型由一个初始状态分布 $\\boldsymbol{\\pi}$、一个状态转移矩阵 $\\boldsymbol{A}$ 和发射概率 $\\boldsymbol{B}$ 指定：\n$$\n\\boldsymbol{\\pi} = \\begin{pmatrix} \\frac{3}{5} \\\\ \\frac{2}{5} \\end{pmatrix}, \\quad\n\\boldsymbol{A} = \\begin{pmatrix} \\frac{7}{10} & \\frac{3}{10} \\\\ \\frac{2}{5} & \\frac{3}{5} \\end{pmatrix}, \\quad\n\\boldsymbol{B} = \\begin{pmatrix}\nP(X_t=a \\mid Z_t=1) & P(X_t=b \\mid Z_t=1)\\\\\nP(X_t=a \\mid Z_t=2) & P(X_t=b \\mid Z_t=2)\n\\end{pmatrix}\n= \\begin{pmatrix}\n\\frac{1}{3} & \\frac{2}{3} \\\\\n\\frac{3}{4} & \\frac{1}{4}\n\\end{pmatrix}.\n$$\n考虑一个长度为 $T=3$ 的观测序列，给定为 $x_{1:3}=(b,a,b)$。从隐马尔可夫模型 (HMM) 的核心定义出发——即隐状态链的一阶马尔可夫性质和给定隐状态下观测的条件独立性——执行以下操作：\n\n1. 使用全概率定律和链式法则，将 $P(x_{1:3})$ 写成所有 $2^3$ 个隐状态序列的和，并通过枚举所有项来精确计算它。\n2. 独立地，通过定义 $\\alpha_t(i) = P(x_{1:t}, Z_t=i)$ 并用 $\\alpha_{t-1}(i)$ 表示 $\\alpha_t(j)$，从基本原理推导前向递归，然后根据给定的参数使用此递归计算 $P(x_{1:3})$。\n\n确认两种计算结果一致。以最简形式的单个精确有理数形式提供最终结果。不需要四舍五入，也不涉及单位。", "solution": "该问题要求计算给定离散时间隐马尔可夫模型 (HMM) 的一个观测序列的概率 $P(x_{1:3})$。该计算需要通过两种不同的方法进行：直接枚举法和前向算法，并期望两种方法得出相同的结果。\n\n该 HMM 定义如下：\n- 隐状态数量：$N=2$，状态为 $Z_t \\in \\{1, 2\\}$。\n- 观测字母表大小：$M=2$，符号为 $X_t \\in \\{a, b\\}$。\n- 初始状态分布：$\\boldsymbol{\\pi} = \\begin{pmatrix} P(Z_1=1) \\\\ P(Z_1=2) \\end{pmatrix} = \\begin{pmatrix} 3/5 \\\\ 2/5 \\end{pmatrix}$。\n- 状态转移矩阵：$\\boldsymbol{A} = \\begin{pmatrix} a_{11} & a_{12} \\\\ a_{21} & a_{22} \\end{pmatrix} = \\begin{pmatrix} 7/10 & 3/10 \\\\ 2/5 & 3/5 \\end{pmatrix}$，其中 $a_{ij} = P(Z_{t+1}=j \\mid Z_t=i)$。\n- 发射概率矩阵：$\\boldsymbol{B}$，其中 $b_i(k) = P(X_t=k \\mid Z_t=i)$。\n  $b_1(a) = 1/3, b_1(b) = 2/3$\n  $b_2(a) = 3/4, b_2(b) = 1/4$\n- 观测序列为 $x_{1:3} = (x_1, x_2, x_3) = (b, a, b)$。\n\nHMM 的基本假设是：\n1.  **一阶马尔可夫性质：** 时间 $t$ 的隐状态的概率仅取决于时间 $t-1$ 的隐状态。\n    $$P(Z_t=j \\mid Z_{t-1}=i, Z_{t-2}=k, \\dots) = P(Z_t=j \\mid Z_{t-1}=i) = a_{ij}$$\n2.  **观测的条件独立性：** 时间 $t$ 的观测的概率仅取决于时间 $t$ 的隐状态。\n    $$P(X_t=k \\mid Z_t=i, Z_{t-1}=j, \\dots, X_{t-1}=l, \\dots) = P(X_t=k \\mid Z_t=i) = b_i(k)$$\n\n### 1. 直接枚举法计算\n\n观测序列 $x_{1:T}$ 的概率是 $x_{1:T}$ 与每个可能的隐状态序列 $z_{1:T}$ 的联合概率对所有这些序列求和的结果。\n$$P(x_{1:T}) = \\sum_{z_{1:T}} P(x_{1:T}, z_{1:T})$$\n观测序列和特定隐状态序列 $z_{1:T} = (z_1, z_2, \\dots, z_T)$ 的联合概率由下式给出：\n$$P(x_{1:T}, z_{1:T}) = P(z_1) \\left( \\prod_{t=2}^T P(z_t \\mid z_{t-1}) \\right) \\left( \\prod_{t=1}^T P(x_t \\mid z_t) \\right) = \\pi_{z_1} b_{z_1}(x_1) \\prod_{t=2}^T a_{z_{t-1}, z_t} b_{z_t}(x_t)$$\n对于我们的问题，$T=3$ 且 $x_{1:3}=(b, a, b)$。存在 $N^T = 2^3 = 8$ 种可能的隐状态序列 $z_{1:3} = (z_1, z_2, z_3)$。我们枚举每条路径的概率并将它们相加。\n\n通项为 $P(b,a,b, z_1,z_2,z_3) = \\pi_{z_1} b_{z_1}(b) a_{z_1, z_2} b_{z_2}(a) a_{z_2, z_3} b_{z_3}(b)$。\n\n1.  $z=(1,1,1): P_1 = P(Z_1=1)b_1(b) \\cdot a_{11}b_1(a) \\cdot a_{11}b_1(b) = (\\frac{3}{5})(\\frac{2}{3}) \\cdot (\\frac{7}{10})(\\frac{1}{3}) \\cdot (\\frac{7}{10})(\\frac{2}{3}) = \\frac{196}{2250}$\n2.  $z=(1,1,2): P_2 = P(Z_1=1)b_1(b) \\cdot a_{11}b_1(a) \\cdot a_{12}b_2(b) = (\\frac{3}{5})(\\frac{2}{3}) \\cdot (\\frac{7}{10})(\\frac{1}{3}) \\cdot (\\frac{3}{10})(\\frac{1}{4}) = \\frac{42}{3000}$\n3.  $z=(1,2,1): P_3 = P(Z_1=1)b_1(b) \\cdot a_{12}b_2(a) \\cdot a_{21}b_1(b) = (\\frac{3}{5})(\\frac{2}{3}) \\cdot (\\frac{3}{10})(\\frac{3}{4}) \\cdot (\\frac{2}{5})(\\frac{2}{3}) = \\frac{72}{3000}$\n4.  $z=(1,2,2): P_4 = P(Z_1=1)b_1(b) \\cdot a_{12}b_2(a) \\cdot a_{22}b_2(b) = (\\frac{3}{5})(\\frac{2}{3}) \\cdot (\\frac{3}{10})(\\frac{3}{4}) \\cdot (\\frac{3}{5})(\\frac{1}{4}) = \\frac{54}{4000}$\n5.  $z=(2,1,1): P_5 = P(Z_1=2)b_2(b) \\cdot a_{21}b_1(a) \\cdot a_{11}b_1(b) = (\\frac{2}{5})(\\frac{1}{4}) \\cdot (\\frac{2}{5})(\\frac{1}{3}) \\cdot (\\frac{7}{10})(\\frac{2}{3}) = \\frac{28}{4500}$\n6.  $z=(2,1,2): P_6 = P(Z_1=2)b_2(b) \\cdot a_{21}b_1(a) \\cdot a_{12}b_2(b) = (\\frac{2}{5})(\\frac{1}{4}) \\cdot (\\frac{2}{5})(\\frac{1}{3}) \\cdot (\\frac{3}{10})(\\frac{1}{4}) = \\frac{6}{6000}$\n7.  $z=(2,2,1): P_7 = P(Z_1=2)b_2(b) \\cdot a_{22}b_2(a) \\cdot a_{21}b_1(b) = (\\frac{2}{5})(\\frac{1}{4}) \\cdot (\\frac{3}{5})(\\frac{3}{4}) \\cdot (\\frac{2}{5})(\\frac{2}{3}) = \\frac{36}{3000}$\n8.  $z=(2,2,2): P_8 = P(Z_1=2)b_2(b) \\cdot a_{22}b_2(a) \\cdot a_{22}b_2(b) = (\\frac{2}{5})(\\frac{1}{4}) \\cdot (\\frac{3}{5})(\\frac{3}{4}) \\cdot (\\frac{3}{5})(\\frac{1}{4}) = \\frac{27}{4000}$\n\n现在，我们对这些概率求和。$2250=2 \\cdot 3^2 \\cdot 5^3$、$3000=2^3 \\cdot 3 \\cdot 5^3$、$4000=2^5 \\cdot 5^3$、$4500=2^2 \\cdot 3^2 \\cdot 5^3$ 和 $6000=2^4 \\cdot 3 \\cdot 5^3$ 的公分母是 $36000 = 2^5 \\cdot 3^2 \\cdot 5^3$。\n$$ P(x_{1:3}) = \\sum_{i=1}^8 P_i $$\n$$ P_1 = (\\frac{2}{5})(\\frac{7}{30})(\\frac{14}{30}) = \\frac{196}{4500} = \\frac{1568}{36000} $$\n$P_2 = (\\frac{2}{5})(\\frac{7}{30})(\\frac{3}{40}) = \\frac{42}{6000} = \\frac{252}{36000}$\n$P_3 = (\\frac{2}{5})(\\frac{9}{40})(\\frac{4}{15}) = \\frac{72}{3000} = \\frac{864}{36000}$\n$P_4 = (\\frac{2}{5})(\\frac{9}{40})(\\frac{3}{20}) = \\frac{54}{4000} = \\frac{486}{36000}$\n$P_5 = (\\frac{1}{10})(\\frac{2}{15})(\\frac{14}{30}) = \\frac{28}{4500} = \\frac{224}{36000}$\n$P_6 = (\\frac{1}{10})(\\frac{2}{15})(\\frac{3}{40}) = \\frac{6}{6000} = \\frac{36}{36000}$\n$P_7 = (\\frac{1}{10})(\\frac{9}{20})(\\frac{4}{15}) = \\frac{36}{3000} = \\frac{432}{36000}$\n$P_8 = (\\frac{1}{10})(\\frac{9}{20})(\\frac{3}{20}) = \\frac{27}{4000} = \\frac{243}{36000}$\n分子之和：$1568+252+864+486+224+36+432+243 = 4105$。\n因此，$P(x_{1:3}) = \\frac{4105}{36000} = \\frac{821}{7200}$。\n\n### 2. 前向算法计算\n\n前向算法提供了一种更高效的递归方法来计算 $P(x_{1:T})$。我们定义前向变量 $\\alpha_t(i)$ 为观测到部分序列 $x_{1:t}$ 并且在时间 $t$ 处于状态 $i$ 的联合概率。\n$$\\alpha_t(i) = P(x_{1:t}, Z_t=i)$$\n**从基本原理推导：**\n- **初始化 ($t=1$):**\n  $$\\alpha_1(i) = P(x_1, Z_1=i) = P(x_1 \\mid Z_1=i) P(Z_1=i) = b_i(x_1) \\pi_i$$\n- **递归 ($t > 1$):**\n  $$\\alpha_t(j) = P(x_{1:t}, Z_t=j) = P(x_t \\mid x_{1:t-1}, Z_t=j) P(x_{1:t-1}, Z_t=j)$$\n  使用观测的条件独立性，$P(x_t \\mid x_{1:t-1}, Z_t=j) = P(x_t \\mid Z_t=j) = b_j(x_t)$。\n  $$ \\alpha_t(j) = b_j(x_t) P(x_{1:t-1}, Z_t=j) $$\n  我们通过对时间 $t-1$ 的状态进行边缘化来展开第二项：\n  $$ P(x_{1:t-1}, Z_t=j) = \\sum_{i=1}^N P(x_{1:t-1}, Z_{t-1}=i, Z_t=j) $$\n  $$ = \\sum_{i=1}^N P(Z_t=j \\mid x_{1:t-1}, Z_{t-1}=i) P(x_{1:t-1}, Z_{t-1}=i) $$\n  使用马尔可夫性质，$P(Z_t=j \\mid x_{1:t-1}, Z_{t-1}=i) = P(Z_t=j \\mid Z_{t-1}=i) = a_{ij}$。最后一项恰好是 $\\alpha_{t-1}(i)$。\n  $$ P(x_{1:t-1}, Z_t=j) = \\sum_{i=1}^N \\alpha_{t-1}(i) a_{ij} $$\n  代回，我们得到递归式：\n  $$ \\alpha_t(j) = b_j(x_t) \\left[ \\sum_{i=1}^N \\alpha_{t-1}(i) a_{ij} \\right] $$\n- **终止：** 总概率是最终前向变量的和。\n  $$ P(x_{1:T}) = \\sum_{i=1}^N \\alpha_T(i) $$\n\n**将算法应用于该问题：** $x_{1:3} = (b, a, b)$。\n\n**步骤 1：初始化 ($t=1$，观测 $x_1=b$)**\n$$ \\alpha_1(1) = \\pi_1 b_1(b) = (\\frac{3}{5})(\\frac{2}{3}) = \\frac{2}{5} $$\n$$ \\alpha_1(2) = \\pi_2 b_2(b) = (\\frac{2}{5})(\\frac{1}{4}) = \\frac{1}{10} $$\n\n**步骤 2：递归 ($t=2$，观测 $x_2=a$)**\n$$ \\alpha_2(1) = b_1(a) [\\alpha_1(1) a_{11} + \\alpha_1(2) a_{21}] = (\\frac{1}{3}) [(\\frac{2}{5})(\\frac{7}{10}) + (\\frac{1}{10})(\\frac{2}{5})] = (\\frac{1}{3}) [\\frac{14}{50} + \\frac{2}{50}] = (\\frac{1}{3})(\\frac{16}{50}) = \\frac{16}{150} = \\frac{8}{75} $$\n$$ \\alpha_2(2) = b_2(a) [\\alpha_1(1) a_{12} + \\alpha_1(2) a_{22}] = (\\frac{3}{4}) [(\\frac{2}{5})(\\frac{3}{10}) + (\\frac{1}{10})(\\frac{3}{5})] = (\\frac{3}{4}) [\\frac{6}{50} + \\frac{3}{50}] = (\\frac{3}{4})(\\frac{9}{50}) = \\frac{27}{200} $$\n\n**步骤 3：递归 ($t=3$，观测 $x_3=b$)**\n$$ \\alpha_3(1) = b_1(b) [\\alpha_2(1) a_{11} + \\alpha_2(2) a_{21}] = (\\frac{2}{3}) [(\\frac{8}{75})(\\frac{7}{10}) + (\\frac{27}{200})(\\frac{2}{5})] = (\\frac{2}{3}) [\\frac{56}{750} + \\frac{54}{1000}] $$\n为了对分数求和，我们找到公分母 $3000$：\n$$ \\alpha_3(1) = (\\frac{2}{3}) [\\frac{56 \\cdot 4}{3000} + \\frac{54 \\cdot 3}{3000}] = (\\frac{2}{3}) [\\frac{224+162}{3000}] = (\\frac{2}{3}) \\frac{386}{3000} = \\frac{772}{9000} = \\frac{193}{2250} $$\n$$ \\alpha_3(2) = b_2(b) [\\alpha_2(1) a_{12} + \\alpha_2(2) a_{22}] = (\\frac{1}{4}) [(\\frac{8}{75})(\\frac{3}{10}) + (\\frac{27}{200})(\\frac{3}{5})] = (\\frac{1}{4}) [\\frac{24}{750} + \\frac{81}{1000}] $$\n使用相同的公分母 $3000$：\n$$ \\alpha_3(2) = (\\frac{1}{4}) [\\frac{24 \\cdot 4}{3000} + \\frac{81 \\cdot 3}{3000}] = (\\frac{1}{4}) [\\frac{96+243}{3000}] = (\\frac{1}{4}) \\frac{339}{3000} = \\frac{339}{12000} = \\frac{113}{4000} $$\n\n**步骤 4：终止**\n$$ P(x_{1:3}) = \\alpha_3(1) + \\alpha_3(2) = \\frac{193}{2250} + \\frac{113}{4000} $$\n$2250 = 2 \\cdot 3^2 \\cdot 5^3$ 和 $4000 = 2^5 \\cdot 5^3$ 的最小公分母是 $2^5 \\cdot 3^2 \\cdot 5^3 = 36000$。\n$$ P(x_{1:3}) = \\frac{193 \\cdot 16}{36000} + \\frac{113 \\cdot 9}{36000} = \\frac{3088}{36000} + \\frac{1017}{36000} = \\frac{4105}{36000} $$\n通过将分子和分母除以它们的最大公约数 $5$ 来化简分数：\n$$ P(x_{1:3}) = \\frac{4105 \\div 5}{36000 \\div 5} = \\frac{821}{7200} $$\n质数 $821$ 与 $7200 = 2^5 \\cdot 3^2 \\cdot 5^2$ 没有公因数，所以该分数是最简形式。\n\n直接枚举法和前向算法这两种方法得出了相同的结果，证实了计算的正确性和方法的等价性。前向算法通过组合计算，避免了枚举每条路径的指数级复杂性，因此明显更高效。", "answer": "$$\n\\boxed{\\frac{821}{7200}}\n$$", "id": "4572030"}, {"introduction": "除了计算一个序列的整体出现概率，HMM 的一个更关键的应用是揭示生成该观测序列的最可能的潜在状态序列。这个“解码”问题是诸如基因注释等生物信息学任务的核心。在此练习 [@problem_id:4572067] 中，您将把维特比 (Viterbi) 算法应用于一个简化的基因发现模型，从而在一个DNA序列中找出最可能的外显子与内含子路径。", "problem": "一个简化的基因发现模型表示为一个隐马尔可夫模型 (HMM)，其中的隐状态为外显子 ($E$)、内含子 ($I$)，以及用于标记序列边界的特殊起始 ($B$) 和终止 ($F$) 状态。在隐马尔可夫模型 (HMM) 中，隐状态序列 $\\{S_t\\}$ 是一个一阶马尔可夫链，并且在给定 $\\{S_t\\}$ 的条件下，观测发射序列 $\\{X_t\\}$ 是独立的，其中 $X_t$ 的分布遵循由 $S_t$ 决定的发射分布。路径和序列的联合概率可以分解为初始概率、转移概率和发射概率的乘积。最可能的路径（在固定参数和固定序列下，路径的后验概率最大化）可以通过 Viterbi 动态规划算法计算，该算法利用了马尔可夫性质和条件独立性，将对路径的全局最大化问题分解为逐个位置的局部最大化问题。\n\n考虑以下科学上合理的脱氧核糖核酸 (DNA) 发射分布，这些分布反映了外显子中适度的鸟嘌呤-胞嘧啶 (GC) 偏好和内含子中腺嘌呤-胸腺嘧啶 (AT) 偏好：\n- 外显子发射概率：$p_E(A) = 0.20$, $p_E(C) = 0.30$, $p_E(G) = 0.30$, $p_E(T) = 0.20$。\n- 内含子发射概率：$p_I(A) = 0.35$, $p_I(C) = 0.15$, $p_I(G) = 0.15$, $p_I(T) = 0.35$。\n\n转移概率如下：\n- 从 $B$ 开始：$p(B \\to E) = 0.60$, $p(B \\to I) = 0.40$。\n- 从 $E$ 开始：$p(E \\to E) = 0.80$, $p(E \\to I) = 0.15$, $p(E \\to F) = 0.05$。\n- 从 $I$ 开始：$p(I \\to I) = 0.70$, $p(I \\to E) = 0.25$, $p(I \\to F) = 0.05$。\n\n假设序列在发射最后一个符号后，通过一个到 $F$ 的最终转移立即终止。设观测到的 DNA 序列为 $X_{1:8} = \\text{ATGCGTTA}$。\n\n仅使用上述基本定义，通过 Viterbi 算法计算 $X_{1:8}$ 最可能的外显子-内含子分割，并报告最优路径和 $X_{1:8}$ 的联合概率的自然对数，包括从 $B$ 开始的初始转移和到 $F$ 的终止转移。将您的答案四舍五入到六位有效数字。将最终答案表示为一个纯数字（无单位）。", "solution": "我们从隐马尔可夫模型 (HMM) 的定义开始。设隐状态为 $S_t \\in \\{E, I\\}$，其中 $t = 1,\\dots,8$，有一个从 $B$ 到 $S_1$ 的初始转移，并在最终发射后有一个从 $S_8$ 到 $F$ 的终止转移。特定状态路径 $s_{1:8}$ 和观测序列 $x_{1:8}$ 的联合概率可分解为\n$$\np(B \\to s_1) \\left( \\prod_{t=1}^{8} p_{s_t}(x_t) \\right) \\left( \\prod_{t=2}^{8} p(s_{t-1} \\to s_t) \\right) p(s_8 \\to F),\n$$\n这是根据一阶马尔可夫性质和给定状态下发射的条件独立性得出的。\n\nViterbi 算法通过动态规划计算所有路径中联合概率的最大值。定义\n$$\n\\delta_E(t) = \\max_{s_{1:t-1}} \\ln\\left( p(B \\to s_1) \\left( \\prod_{u=1}^{t} p_{s_u}(x_u) \\right) \\left( \\prod_{u=2}^{t} p(s_{u-1} \\to s_u) \\right) \\right) \\text{ 且 } s_t = E,\n$$\n类似地，当 $s_t = I$ 时，定义 $\\delta_I(t)$。在自然对数域中的递归关系是\n$$\n\\delta_E(t) = \\max\\left\\{ \\delta_E(t-1) + \\ln p(E \\to E),\\ \\delta_I(t-1) + \\ln p(I \\to E) \\right\\} + \\ln p_E(x_t),\n$$\n$$\n\\delta_I(t) = \\max\\left\\{ \\delta_E(t-1) + \\ln p(E \\to I),\\ \\delta_I(t-1) + \\ln p(I \\to I) \\right\\} + \\ln p_I(x_t),\n$$\n初始化为\n$$\n\\delta_E(1) = \\ln p(B \\to E) + \\ln p_E(x_1), \\quad \\delta_I(1) = \\ln p(B \\to I) + \\ln p_I(x_1).\n$$\n最终的 Viterbi 分数（最优路径和序列的联合概率的自然对数，包括终止）是\n$$\n\\text{score} = \\max\\left\\{ \\delta_E(8) + \\ln p(E \\to F),\\ \\delta_I(8) + \\ln p(I \\to F) \\right\\}.\n$$\n\n我们计算所需的对数值：\n- $\\ln(0.60) = -0.510825624$, $\\ln(0.40) = -0.916290732$。\n- $\\ln(0.80) = -0.223143551$, $\\ln(0.15) = -1.897119984$, $\\ln(0.25) = -1.386294361$, $\\ln(0.70) = -0.356674944$, $\\ln(0.05) = -2.995732274$。\n- 外显子发射概率：$\\ln p_E(A) = \\ln(0.20) = -1.609437912$, $\\ln p_E(C) = \\ln(0.30) = -1.203972804$, $\\ln p_E(G) = -1.203972804$, $\\ln p_E(T) = -1.609437912$。\n- 内含子发射概率：$\\ln p_I(A) = \\ln(0.35) = -1.049822124$, $\\ln p_I(C) = \\ln(0.15) = -1.897119984$, $\\ln p_I(G) = -1.897119984$, $\\ln p_I(T) = -1.049822124$。\n\n设 $x_{1:8} = \\text{A}, \\text{T}, \\text{G}, \\text{C}, \\text{G}, \\text{T}, \\text{T}, \\text{A}$。\n\n初始化 ($t=1$)：\n$$\n\\delta_E(1) = \\ln(0.60) + \\ln p_E(A) = -0.510825624 - 1.609437912 = -2.120263536,\n$$\n$$\n\\delta_I(1) = \\ln(0.40) + \\ln p_I(A) = -0.916290732 - 1.049822124 = -1.966112856.\n$$\n\n逐步递归：\n\n对于 $t=2$, $x_2 = \\text{T}$：\n$$\n\\delta_E(2) = \\max\\{ \\delta_E(1) + \\ln(0.80),\\ \\delta_I(1) + \\ln(0.25) \\} + \\ln p_E(T)\n= \\max\\{ -2.120263536 - 0.223143551,\\ -1.966112856 - 1.386294361 \\} - 1.609437912.\n$$\n计算候选值：$-2.343407087$ 对比 $-3.352407217$，因此\n$$\n\\delta_E(2) = -2.343407087 - 1.609437912 = -3.952844999.\n$$\n对于内含子：\n$$\n\\delta_I(2) = \\max\\{ \\delta_E(1) + \\ln(0.15),\\ \\delta_I(1) + \\ln(0.70) \\} + \\ln p_I(T)\n= \\max\\{ -2.120263536 - 1.897119984,\\ -1.966112856 - 0.356674944 \\} - 1.049822124.\n$$\n计算候选值：$-4.017383520$ 对比 $-2.322787800$，因此\n$$\n\\delta_I(2) = -2.322787800 - 1.049822124 = -3.372609924.\n$$\n\n对于 $t=3$, $x_3 = \\text{G}$：\n$$\n\\delta_E(3) = \\max\\{ -3.952844999 - 0.223143551,\\ -3.372609924 - 1.386294361 \\} - 1.203972804\n= \\max\\{ -4.175988550,\\ -4.758904285 \\} - 1.203972804 = -5.379961354,\n$$\n$$\n\\delta_I(3) = \\max\\{ -3.952844999 - 1.897119984,\\ -3.372609924 - 0.356674944 \\} - 1.897119984\n= \\max\\{ -5.849964983,\\ -3.729284868 \\} - 1.897119984 = -5.626404852.\n$$\n\n对于 $t=4$, $x_4 = \\text{C}$：\n$$\n\\delta_E(4) = \\max\\{ -5.379961354 - 0.223143551,\\ -5.626404852 - 1.386294361 \\} - 1.203972804\n= \\max\\{ -5.603104905,\\ -7.012699213 \\} - 1.203972804 = -6.807077709,\n$$\n$$\n\\delta_I(4) = \\max\\{ -5.379961354 - 1.897119984,\\ -5.626404852 - 0.356674944 \\} - 1.897119984\n= \\max\\{ -7.277081338,\\ -5.983079796 \\} - 1.897119984 = -7.880199780.\n$$\n\n对于 $t=5$, $x_5 = \\text{G}$：\n$$\n\\delta_E(5) = \\max\\{ -6.807077709 - 0.223143551,\\ -7.880199780 - 1.386294361 \\} - 1.203972804\n= \\max\\{ -7.030221260,\\ -9.266494141 \\} - 1.203972804 = -8.234194064,\n$$\n$$\n\\delta_I(5) = \\max\\{ -6.807077709 - 1.897119984,\\ -7.880199780 - 0.356674944 \\} - 1.897119984\n= \\max\\{ -8.704197693,\\ -8.236874724 \\} - 1.897119984 = -10.133994708.\n$$\n\n对于 $t=6$, $x_6 = \\text{T}$：\n$$\n\\delta_E(6) = \\max\\{ -8.234194064 - 0.223143551,\\ -10.133994708 - 1.386294361 \\} - 1.609437912\n= \\max\\{ -8.457337615,\\ -11.520289069 \\} - 1.609437912 = -10.066775527,\n$$\n$$\n\\delta_I(6) = \\max\\{ -8.234194064 - 1.897119984,\\ -10.133994708 - 0.356674944 \\} - 1.049822124\n= \\max\\{ -10.131314048,\\ -10.490669652 \\} - 1.049822124 = -11.181136172.\n$$\n\n对于 $t=7$, $x_7 = \\text{T}$：\n$$\n\\delta_E(7) = \\max\\{ -10.066775527 - 0.223143551,\\ -11.181136172 - 1.386294361 \\} - 1.609437912\n= \\max\\{ -10.289919078,\\ -12.567430533 \\} - 1.609437912 = -11.899356990,\n$$\n$$\n\\delta_I(7) = \\max\\{ -10.066775527 - 1.897119984,\\ -11.181136172 - 0.356674944 \\} - 1.049822124\n= \\max\\{ -11.963895511,\\ -11.537811116 \\} - 1.049822124 = -12.587633240.\n$$\n\n对于 $t=8$, $x_8 = \\text{A}$：\n$$\n\\delta_E(8) = \\max\\{ -11.899356990 - 0.223143551,\\ -12.587633240 - 1.386294361 \\} - 1.609437912\n= \\max\\{ -12.122500541,\\ -13.973927601 \\} - 1.609437912 = -13.731938453,\n$$\n$$\n\\delta_I(8) = \\max\\{ -11.899356990 - 1.897119984,\\ -12.587633240 - 0.356674944 \\} - 1.049822124\n= \\max\\{ -13.796476974,\\ -12.944308184 \\} - 1.049822124 = -13.994130308.\n$$\n\n终止步骤加上到 $F$ 的转移：\n$$\n\\text{score} = \\max\\{ \\delta_E(8) + \\ln(0.05),\\ \\delta_I(8) + \\ln(0.05) \\}\n= \\max\\{ -13.731938453 - 2.995732274,\\ -13.994130308 - 2.995732274 \\}.\n$$\n计算：\n$$\n\\delta_E(8) + \\ln(0.05) = -16.727670727,\\quad \\delta_I(8) + \\ln(0.05) = -16.989862582,\n$$\n所以\n$$\n\\text{score} = -16.727670727.\n$$\n\n因此，最可能的分割对应于以 $E$ 结尾的路径（回溯指针确认了从 $E$到$E$ 的选择在整个过程中占主导地位，对于这个偏向 GC 的序列，产生了一个全外显子的路径），最优路径和观测序列的联合概率（包括起始和终止转移）的自然对数是 $-16.727670727$。四舍五入到六位有效数字得到 $-16.7277$。", "answer": "$$\\boxed{-16.7277}$$", "id": "4572067"}, {"introduction": "一个HMM模型的好坏完全取决于其参数的优劣。然而，我们应如何从数据中确定最佳的转移概率 $A$ 和发射概率 $B$ 呢？这项练习 [@problem_id:4572062] 将深入探讨学习问题，指导您手动完成一次完整的鲍姆-韦尔奇 (Baum-Welch) 算法迭代。您将学习如何从观测数据中计算期望充分统计量，并利用它们来更新模型参数，从而揭示应用于HMM的期望最大化 (Expectation-Maximization) 算法的核心机制。", "problem": "隐马尔可夫模型 (HMM) 是一种双重随机过程，其中一个潜在的马尔可夫链根据特定于状态的发射分布来发射可观测的符号。在计算生物学和医学数据分析中，HMM 及其推广形式——轮廓隐马尔可夫模型 (Profile HMM)——是序列分析任务（如基序发现和结构域注释）的基础。考虑通过称为 Baum–Welch 算法的期望最大化 (EM) 过程，使用一个观测序列来训练一个最小离散HMM，作为轮廓模型短片段的替代。\n\n给定一个双状态离散 HMM，其状态空间为 $\\{1,2\\}$，观测字母表为 $\\{x,y\\}$，初始参数为\n$$\n\\pi = \\begin{pmatrix} 0.6 & 0.4 \\end{pmatrix}, \\quad\nA = \\begin{pmatrix} 0.7 & 0.3 \\\\ 0.4 & 0.6 \\end{pmatrix}, \\quad\nB_1(x)=0.5,\\; B_1(y)=0.5,\\; B_2(x)=0.2,\\; B_2(y)=0.8.\n$$\n单个观测序列为\n$$\n\\mathbf{O} = (x, y, x, y).\n$$\n\n仅从 HMM 生成模型的定义性质（马尔可夫性质和给定状态下发射的条件独立性）出发，对该数据执行一次完整的 Baum–Welch 迭代：\n- 从基本原理出发，计算每个时间步的前向和后向变量，\n- 计算后验状态占据概率 $\\gamma_t(i)$ 和后验双时间转移概率 $\\xi_t(i,j)$，\n- 使用你计算出的充分统计量更新初始分布 $\\pi$、转移矩阵 $A$ 和发射概率 $B$。\n\n明确显示所有中间的充分统计量（包括每个状态的 $\\gamma_t(i)$ 按时间求和以及每次转移的 $\\xi_t(i,j)$ 按时间求和）。\n\n经过这次 EM 迭代后，更新后的转移概率 $A_{12}^{(\\text{new})}$ 是多少？将你的答案四舍五入到四位有效数字。以纯数字形式表示答案，不带任何单位。", "solution": "Baum–Welch 算法是期望最大化 (EM) 算法的一个实例，用于在给定一组观测特征向量的情况下，找到 HMM 参数的最大似然估计。单次迭代包括两个步骤：期望步骤（E-step）和最大化步骤（M-step）。\n\n给定的 HMM 参数为 $\\lambda = (\\pi, A, B)$：\n- 状态空间 $S=\\{1, 2\\}$，有 $N=2$ 个状态。\n- 初始状态分布 $\\pi = \\begin{pmatrix} \\pi_1 & \\pi_2 \\end{pmatrix} = \\begin{pmatrix} 0.6 & 0.4 \\end{pmatrix}$。\n- 转移概率矩阵 $A = \\begin{pmatrix} A_{11} & A_{12} \\\\ A_{21} & A_{22} \\end{pmatrix} = \\begin{pmatrix} 0.7 & 0.3 \\\\ 0.4 & 0.6 \\end{pmatrix}$。\n- 对于观测字母表 $\\{x, y\\}$ 的发射概率：\n$B_1(x) = b_1(x) = 0.5$, $B_1(y) = b_1(y) = 0.5$。\n$B_2(x) = b_2(x) = 0.2$, $B_2(y) = b_2(y) = 0.8$。\n观测序列为 $\\mathbf{O} = (O_1, O_2, O_3, O_4) = (x, y, x, y)$，长度 $T=4$。\n\n### E-步：计算期望充分统计量\n\nE-步涉及在给定观测序列 $\\mathbf{O}$ 和当前参数 $\\lambda$ 的情况下，计算 HMM 处于特定状态或进行特定转移的期望次数。这需要计算前向变量、后向变量以及由它们导出的后验概率。\n\n**1. 前向变量 $\\alpha_t(i)$**\n前向变量 $\\alpha_t(i) = P(O_1, \\dots, O_t, q_t=i | \\lambda)$ 是观测到时间 $t$ 为止的部分序列且在时间 $t$ 处于状态 $i$ 的概率。\n- **初始化 ($t=1$):** $\\alpha_1(i) = \\pi_i b_i(O_1)$\n  $\\alpha_1(1) = \\pi_1 b_1(x) = 0.6 \\times 0.5 = 0.3$\n  $\\alpha_1(2) = \\pi_2 b_2(x) = 0.4 \\times 0.2 = 0.08$\n- **递推 ($t=2, 3, 4$):** $\\alpha_t(j) = \\left[ \\sum_{i=1}^N \\alpha_{t-1}(i) A_{ij} \\right] b_j(O_t)$\n  对于 $t=2$, $O_2=y$：\n  $\\alpha_2(1) = [\\alpha_1(1)A_{11} + \\alpha_1(2)A_{21}]b_1(y) = [0.3 \\times 0.7 + 0.08 \\times 0.4] \\times 0.5 = 0.242 \\times 0.5 = 0.121$\n  $\\alpha_2(2) = [\\alpha_1(1)A_{12} + \\alpha_1(2)A_{22}]b_2(y) = [0.3 \\times 0.3 + 0.08 \\times 0.6] \\times 0.8 = 0.138 \\times 0.8 = 0.1104$\n  对于 $t=3$, $O_3=x$：\n  $\\alpha_3(1) = [\\alpha_2(1)A_{11} + \\alpha_2(2)A_{21}]b_1(x) = [0.121 \\times 0.7 + 0.1104 \\times 0.4] \\times 0.5 = 0.12886 \\times 0.5 = 0.06443$\n  $\\alpha_3(2) = [\\alpha_2(1)A_{12} + \\alpha_2(2)A_{22}]b_2(x) = [0.121 \\times 0.3 + 0.1104 \\times 0.6] \\times 0.2 = 0.10254 \\times 0.2 = 0.020508$\n  对于 $t=4$, $O_4=y$：\n  $\\alpha_4(1) = [\\alpha_3(1)A_{11} + \\alpha_3(2)A_{21}]b_1(y) = [0.06443 \\times 0.7 + 0.020508 \\times 0.4] \\times 0.5 = 0.0533042 \\times 0.5 = 0.0266521$\n  $\\alpha_4(2) = [\\alpha_3(1)A_{12} + \\alpha_3(2)A_{22}]b_2(y) = [0.06443 \\times 0.3 + 0.020508 \\times 0.6] \\times 0.8 = 0.0316338 \\times 0.8 = 0.02530704$\n\n观测序列的概率为 $P(\\mathbf{O}|\\lambda) = \\sum_{i=1}^N \\alpha_T(i) = \\alpha_4(1) + \\alpha_4(2) = 0.0266521 + 0.02530704 = 0.05195914$。\n\n**2. 后向变量 $\\beta_t(i)$**\n后向变量 $\\beta_t(i) = P(O_{t+1}, \\dots, O_T | q_t=i, \\lambda)$ 是在给定时间 $t$ 的状态为 $i$ 的条件下，观测到从时间 $t+1$ 开始的序列剩余部分的概率。\n- **初始化 ($t=T=4$):** 对所有 $i$，$\\beta_4(i) = 1$。\n  $\\beta_4(1) = 1$\n  $\\beta_4(2) = 1$\n- **递推 ($t=3, 2, 1$):** $\\beta_t(i) = \\sum_{j=1}^N A_{ij} b_j(O_{t+1}) \\beta_{t+1}(j)$\n  对于 $t=3$, $O_4=y$：\n  $\\beta_3(1) = A_{11}b_1(y)\\beta_4(1) + A_{12}b_2(y)\\beta_4(2) = (0.7 \\times 0.5 \\times 1) + (0.3 \\times 0.8 \\times 1) = 0.35 + 0.24 = 0.59$\n  $\\beta_3(2) = A_{21}b_1(y)\\beta_4(1) + A_{22}b_2(y)\\beta_4(2) = (0.4 \\times 0.5 \\times 1) + (0.6 \\times 0.8 \\times 1) = 0.2 + 0.48 = 0.68$\n  对于 $t=2$, $O_3=x$：\n  $\\beta_2(1) = A_{11}b_1(x)\\beta_3(1) + A_{12}b_2(x)\\beta_3(2) = (0.7 \\times 0.5 \\times 0.59) + (0.3 \\times 0.2 \\times 0.68) = 0.2065 + 0.0408 = 0.2473$\n  $\\beta_2(2) = A_{21}b_1(x)\\beta_3(1) + A_{22}b_2(x)\\beta_3(2) = (0.4 \\times 0.5 \\times 0.59) + (0.6 \\times 0.2 \\times 0.68) = 0.118 + 0.0816 = 0.1996$\n  对于 $t=1$, $O_2=y$：\n  $\\beta_1(1) = A_{11}b_1(y)\\beta_2(1) + A_{12}b_2(y)\\beta_2(2) = (0.7 \\times 0.5 \\times 0.2473) + (0.3 \\times 0.8 \\times 0.1996) = 0.086555 + 0.047904 = 0.134459$\n  $\\beta_1(2) = A_{21}b_1(y)\\beta_2(1) + A_{22}b_2(y)\\beta_2(2) = (0.4 \\times 0.5 \\times 0.2473) + (0.6 \\times 0.8 \\times 0.1996) = 0.04946 + 0.095808 = 0.145268$\n\n**3. 后验概率 $\\gamma_t(i)$ 和 $\\xi_t(i,j)$**\n在时间 $t$ 处于状态 $i$ 的后验概率是 $\\gamma_t(i) = P(q_t=i|\\mathbf{O},\\lambda) = \\frac{\\alpha_t(i)\\beta_t(i)}{P(\\mathbf{O}|\\lambda)}$。\n在时间 $t$ 从状态 $i$ 转移到状态 $j$ 的后验概率是 $\\xi_t(i,j) = P(q_t=i, q_{t+1}=j|\\mathbf{O},\\lambda) = \\frac{\\alpha_t(i)A_{ij}b_j(O_{t+1})\\beta_{t+1}(j)}{P(\\mathbf{O}|\\lambda)}$。\n\n$\\gamma_t(i)$ 的计算值：\n$\\gamma_1(1) = \\frac{0.3 \\times 0.134459}{0.05195914} \\approx 0.776335$, $\\gamma_1(2) = \\frac{0.08 \\times 0.145268}{0.05195914} \\approx 0.223665$\n$\\gamma_2(1) = \\frac{0.121 \\times 0.2473}{0.05195914} \\approx 0.575898$, $\\gamma_2(2) = \\frac{0.1104 \\times 0.1996}{0.05195914} \\approx 0.424102$\n$\\gamma_3(1) = \\frac{0.06443 \\times 0.59}{0.05195914} \\approx 0.731221$, $\\gamma_3(2) = \\frac{0.020508 \\times 0.68}{0.05195914} \\approx 0.268390$\n$\\gamma_4(1) = \\frac{0.0266521 \\times 1}{0.05195914} \\approx 0.512943$, $\\gamma_4(2) = \\frac{0.02530704 \\times 1}{0.05195914} \\approx 0.487057$\n\n对于 $t=1, 2, 3$，$\\xi_t(i,j)$ 的计算值：\n对于 $t=1$： $\\xi_1(1,1)\\approx0.499748$, $\\xi_1(1,2)\\approx0.276587$, $\\xi_1(2,1)\\approx0.076152$, $\\xi_1(2,2)\\approx0.147513$。\n对于 $t=2$： $\\xi_2(1,1)\\approx0.481176$, $\\xi_2(1,2)\\approx0.095013$, $\\xi_2(2,1)\\approx0.250166$, $\\xi_2(2,2)\\approx0.173379$。\n对于 $t=3$： $\\xi_3(1,1)\\approx0.433997$, $\\xi_3(1,2)\\approx0.297598$, $\\xi_3(2,1)\\approx0.078940$, $\\xi_3(2,2)\\approx0.189452$。\n\n### M-步：重新估计参数\n\nM-步使用后验概率更新参数 $\\pi$、$A$ 和 $B$。首先，我们计算必要的充分统计量。\n\n**充分统计量：**\n- 从状态 $i$ 开始的期望转移次数：$\\sum_{t=1}^{T-1} \\gamma_t(i)$\n  $\\sum_{t=1}^{3} \\gamma_t(1) = 0.776335 + 0.575898 + 0.731221 = 2.083454$\n  $\\sum_{t=1}^{3} \\gamma_t(2) = 0.223665 + 0.424102 + 0.268390 = 0.916157$\n- 从状态 $i$ 转移到状态 $j$ 的期望转移次数：$\\sum_{t=1}^{T-1} \\xi_t(i,j)$\n  $\\sum_{t=1}^{3} \\xi_t(1,1) = 0.499748 + 0.481176 + 0.433997 = 1.414921$\n  $\\sum_{t=1}^{3} \\xi_t(1,2) = 0.276587 + 0.095013 + 0.297598 = 0.669198$\n  $\\sum_{t=1}^{3} \\xi_t(2,1) = 0.076152 + 0.250166 + 0.078940 = 0.405258$\n  $\\sum_{t=1}^{3} \\xi_t(2,2) = 0.147513 + 0.173379 + 0.189452 = 0.510344$\n- 处于状态 $j$ 的期望次数：$\\sum_{t=1}^{T} \\gamma_t(j)$\n  $\\sum_{t=1}^{4} \\gamma_t(1) = 2.083454 + 0.512943 = 2.596397$\n  $\\sum_{t=1}^{4} \\gamma_t(2) = 0.916157 + 0.487057 = 1.403214$\n- 处于状态 $j$ 并观测到符号 $v_k$ 的期望次数：$\\sum_{t \\text{ s.t. } O_t=v_k} \\gamma_t(j)$\n  观测值 $x$ 出现在 $t=1,3$。观测值 $y$ 出现在 $t=2,4$。\n  $\\sum_{t \\in \\{1,3\\}} \\gamma_t(1) = \\gamma_1(1) + \\gamma_3(1) = 0.776335 + 0.731221 = 1.507556$\n  $\\sum_{t \\in \\{2,4\\}} \\gamma_t(1) = \\gamma_2(1) + \\gamma_4(1) = 0.575898 + 0.512943 = 1.088841$\n  $\\sum_{t \\in \\{1,3\\}} \\gamma_t(2) = \\gamma_1(2) + \\gamma_3(2) = 0.223665 + 0.268390 = 0.492055$\n  $\\sum_{t \\in \\{2,4\\}} \\gamma_t(2) = \\gamma_2(2) + \\gamma_4(2) = 0.424102 + 0.487057 = 0.911159$\n\n**参数更新：**\n- **初始分布 $\\pi^{(\\text{new})}$**：$\\pi_i^{(\\text{new})} = \\gamma_1(i)$\n  $\\pi_1^{(\\text{new})} = \\gamma_1(1) \\approx 0.7763$\n  $\\pi_2^{(\\text{new})} = \\gamma_1(2) \\approx 0.2237$\n- **转移矩阵 $A^{(\\text{new})}$**：$A_{ij}^{(\\text{new})} = \\frac{\\sum_{t=1}^{T-1} \\xi_t(i,j)}{\\sum_{t=1}^{T-1} \\gamma_t(i)}$。\n  $A_{11}^{(\\text{new})} = \\frac{1.414921}{2.083454} \\approx 0.67911$\n  $A_{12}^{(\\text{new})} = \\frac{0.669198}{2.083454} \\approx 0.32119$\n  $A_{21}^{(\\text{new})} = \\frac{0.405258}{0.916157} \\approx 0.44235$\n  $A_{22}^{(\\text{new})} = \\frac{0.510344}{0.916157} \\approx 0.55704$\n- **发射概率 $B^{(\\text{new})}$**：$b_j(v_k)^{(\\text{new})} = \\frac{\\sum_{t \\text{ s.t. } O_t=v_k} \\gamma_t(j)}{\\sum_{t=1}^T \\gamma_t(j)}$\n  $b_1(x)^{(\\text{new})} = \\frac{1.507556}{2.596397} \\approx 0.58063$; $b_1(y)^{(\\text{new})} = \\frac{1.088841}{2.596397} \\approx 0.41937$\n  $b_2(x)^{(\\text{new})} = \\frac{0.492055}{1.403214} \\approx 0.35066$; $b_2(y)^{(\\text{new})} = \\frac{0.911159}{1.403214} \\approx 0.64934$\n\n问题要求更新后的转移概率 $A_{12}^{(\\text{new})}$，并四舍五入到四位有效数字。\n$A_{12}^{(\\text{new})} = \\frac{\\sum_{t=1}^{3} \\xi_t(1,2)}{\\sum_{t=1}^{3} \\gamma_t(1)} = \\frac{0.669198}{2.083454} \\approx 0.32119$\n四舍五入到四位有效数字得到 $0.3212$。 *注：使用更高精度的中间值进行计算，可得 $A_{12}^{(\\text{new})} \\approx 0.3210876$，四舍五入到四位有效数字为 $0.3211$。*", "answer": "$$\\boxed{0.3211}$$", "id": "4572062"}]}