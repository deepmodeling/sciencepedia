## 引言
[定量构效关系](@entry_id:175003)（QSAR）建模是现代计算化学和药物发现的基石，它在分子的化学结构与其生物效应之间架起了一座强大的桥梁。其重要性在于能够预测新化合物的活性，从而加速“设计-合成-测试”的研发循环并降低成本。然而，对于生物信息学和医学数据分析领域的研究生和研究人员而言，从理解QSAR的理论基础到在真实场景中有效且负责任地应用它，两者之间常常存在知识鸿沟。本文旨在通过提供一个全面的、面向实践的指南来弥合这一鸿沟。

本文将引导您系统地探索QSAR的世界。在第一章 **“原理与机制”** 中，我们将剖析QSAR的核心假设，探索如何通过各种描述符将化学结构转化为数学语言，并考察用于构建预测模型的[统计学习](@entry_id:269475)框架，从经典的线性方法到先进的[图神经网络](@entry_id:136853)。第二章 **“应用与跨学科交叉”** 将展示QSAR的实际应用，阐明其在药物优化、[虚拟筛选](@entry_id:171634)、法规[毒理学](@entry_id:271160)中的关键作用，以及它如何与[主动学习](@entry_id:157812)和多目标学习等先进[机器学习范式](@entry_id:637731)相结合。最后，**“动手实践”** 章节提供了实际练习，以巩固您对QSAR建模中关键统计概念的理解。通过学习这些内容，您将获得一个用于构建、验证和批判性应用QS[AR模型](@entry_id:189434)的坚实框架。

## 原理与机制

本章在前一章介绍的背景基础上，深入探讨了[定量构效关系](@entry_id:175003)（QSAR）模型构建的核心科学原理与技术机制。我们将从QSAR的基本假设出发，系统地阐述如何将化学结构转化为数学语言，如何利用[统计学习](@entry_id:269475)方法构建预测模型，以及如何验证模型的可靠性并界定其适用范围。本章旨在为读者构建一个严谨、系统且符合现代生物信息学与医学数据分析实践的QSAR知识框架。

### QSAR的核心原理：结构编码活性

[定量构效关系](@entry_id:175003)（QSAR）研究的基石是一个核心假设：分子的化学结构通过其物理化学性质，以一种可量化的方式决定其生物活性。这个过程并非简单的[统计关联](@entry_id:172897)，而是蕴含着一个因果链条。形式上，我们可以将这个因果关系表述为 $x \rightarrow M \rightarrow y$，其中 $x$ 是描述分子结构的特征向量（即**描述符**），$y$ 是可测量的生物学响应（如半数抑制浓度 $pIC_{50}$），而 $M$ 是一个潜在的、物理上可解释的**机制中介**，例如分子与靶蛋白的结合自由能 $\Delta G$。

一个成功的QS[AR模型](@entry_id:189434)不仅应具备良好的预测能力，其 underlying 机制也应具有物理真实性。单纯的[统计相关性](@entry_id:267552)可能是虚假的或由[混淆变量](@entry_id:199777)引起，而一个具有机制解释力的模型则能为[药物设计](@entry_id:140420)提供更可靠的指导。因此，区分[统计相关性](@entry_id:267552)与因果机制证据是至关重要的。机制证据应来自于以下几个方面：干预一致性、物理合理性以及在不改变核心机制的前提下，因果关联在不同环境下的不变性 [@problem_id:4602648]。

设想一个情景：我们构建了一个QS[AR模型](@entry_id:189434)，预测一个氢键供体描述符的增加将导致结合自由能改善约 $-1.5\,\mathrm{kcal/mol}$。为了验证这是否为因果关系，我们可以进行一系列实验 [@problem_id:4602648]：

1.  **干预一致性验证**：通过**匹配分子对分析**（Matched Molecular Pair Analysis），我们合成一对仅相差一个氢键供体的化合物 A 和 B。使用**等温滴定[量热法](@entry_id:145378)**（Isothermal Titration Calorimetry, ITC）实验测定它们与靶蛋白的结合解离常数 $K_d$。根据[热力学](@entry_id:172368)公式 $\Delta \Delta G = R T \ln(K_{d,B} / K_{d,A})$，计算出的实验 $\Delta \Delta G$ 值应与模型的预测在符号和数量级上保持一致。例如，若测得 $K_{d,A} = 100\,\mathrm{nM}$ 和 $K_{d,B} = 20\,\mathrm{nM}$，在 $298\,\mathrm{K}$ 时计算可得实验值 $\Delta \Delta G_{\text{exp}} \approx -0.95\,\mathrm{kcal/mol}$，这与模型的预测相符。

2.  **物理合理性与反事实验证**：通过**[分子对接](@entry_id:166262)**和**量子[化学计算](@entry_id:155220)**，我们可以构建一个物理上合理的相互作用模型，例如，观察到化合物 B 增加的氢键[供体与受体](@entry_id:137311)口袋中的某个羰基氧形成了特定几何构型的[氢键](@entry_id:136659)。更进一步，通过高精度的计算方法（如[对称适应微扰理论](@entry_id:271732)）估算的能量贡献应与实验值吻合。决定性的证据来自于**定点突变**实验：将受体上假定的[氢键受体](@entry_id:139503)氨基酸突变为不能形成[氢键](@entry_id:136659)的丙氨酸。如果这一突变几乎完全消除了化合物 A 和 B 之间的活性差异，这就为“[氢键](@entry_id:136659)是导致活性差异的原因”这一假设提供了强有力的反事实证据。

3.  **不变性与正交实验**：在不影响核心作用机制的其他实验条件（如[缓冲液](@entry_id:139484)[离子强度](@entry_id:152038)）下，重复测量应得到一致的 $\Delta \Delta G$ 值。此外，使用一个已知的、能占据该[氢键](@entry_id:136659)微环境的竞争性配体，如果它能消除化合物 B 相对于 A 的活性优势，则进一步证实了相互作用的位点特异性。

与此相对，诸如在外部[测试集](@entry_id:637546)上获得高预测性能指标（如高的受试者工作特征曲线下面积AUC、[决定系数](@entry_id:142674)$R^2$）或描述符具有高的[特征重要性](@entry_id:171930)（如SHAP值），这些本身仅能证明模型学习到了数据中的相关性，而不能作为机制性证据。只有通过上述结合物理干预和定量观测的实验验证，我们才能从相关性迈向对因果关系的深刻理解 [@problem_id:4602648]。

### 分[子表示](@entry_id:141094)：QSAR的语言

为了让计算机能够处理和学习，化学结构必须被转化为数值形式的描述符。这个转化过程包括从原始分[子表示](@entry_id:141094)到标准化，再到特征提取等一系列步骤。

#### 从分子到图：化学结构的数字化基础

在计算化学中，一个分子可以被抽象为一个带标签的**分子图** $G=(V,E)$，其中顶点 $V$ 代表原子，边的集合 $E$ 代表[化学键](@entry_id:145092)。每个顶点（原子）都带有一系列标签，如元素类型、化合价、形式电荷、芳香性等。每条边（[化学键](@entry_id:145092)）也带有标签，如键级（[单键](@entry_id:188561)、双键、芳香键等）。

**简化[分子线](@entry_id:198003)性输入规范**（SMILES）是一种广泛使用的、将分子结构编码为字符串的方法。从SMILES字符串构建分子图是一个基础且关键的步骤 [@problem_id:4602695]。例如，对于对氨基苯酚的SMILES字符串 `c1cc(O)ccc1N`：
- 小写字母 `c` 表示[芳香性](@entry_id:144501)碳原子。
- 数字 `1` 用于标记成环的两个原子，闭合一个环。
- 括号 `()` 用于表示分支。
- 相邻的[芳香性](@entry_id:144501)原子间省略的[化学键](@entry_id:145092)默认为芳香键。

解析这个字符串，我们可以构建一个包含8个重原子（6个碳、1个氧、1个氮）和8个[化学键](@entry_id:145092)（6个芳香环键、2个单键）的分子图。在这个过程中，许多隐含的化学信息需要被正确处理：
- **化合价与隐式氢**：基于常见元素（如O、N）的默认化合价，可以推断出每个重原子上连接的**隐式氢**数量。例如，在中性条件下，与一个碳相连的氧原子（来自`-OH`）有1个隐式氢，而与一个碳相连的氮原子（来自`-NH2`）有2个隐式氢。这些隐式氢虽然在重原[子图](@entry_id:273342)中不是顶点，但它们的数量作为原子属性被存储，并对许多描述符（如[氢键供体](@entry_id:141108)数）的计算至关重要。
- **[芳香性](@entry_id:144501)感知**：虽然SMILES中的小写字母直接指定了[芳香性](@entry_id:144501)，但许多化学信息学工具包会使用更复杂的算法（如基于[休克尔规则](@entry_id:273458)的$4n+2$[电子计数](@entry_id:154059)）来感知芳香性。不同的芳香性模型可能会对杂环等复杂体系产生不同的判断，这将直接改变原子和键的标签，进而影响所有依赖这些标签的下游描述符的计算 [@problem_id:4602695]。例如，一个原子的[芳香性](@entry_id:144501)标签的改变，会影响基于片段的$\log P$估算和拓扑[极性表面](@entry_id:753555)积（TPSA）的计算。

#### 分子标准化：确保表示的一致性与[可复现性](@entry_id:151299)

在真实的药物研发项目中，分子数据往往来自不同来源，其表示方式可能存在不一致，例如包含盐、不同的[质子化状态](@entry_id:753827)或[互变异构体](@entry_id:167578)形式。为了确保QS[AR模型](@entry_id:189434)的[可复现性](@entry_id:151299)和可靠性，必须在计算描述符之前对分子进行**标准化**或**典范化**处理 [@problem_id:4602655]。其核心目标是：对于在特定实验条件下（如生理pH值 $7.4$）表现为同一化学实体的不同输入表示，通过一个典范化映射 $c(\cdot)$，将它们映射到唯一的、确定性的结构表示上。这样可以消除由表示伪影导致的描述符差异。

关键的标准化步骤包括：
- **去盐处理（Salt Stripping）**：在水溶液中，药物盐会解离成活性有机[部分和](@entry_id:162077)无活性的抗衡离子（如$Cl^-$、$Na^+$）。去盐处理旨在识别并移除这些非共价结合的抗衡离子，仅保留最大的共价有机部分作为研究主体。
- **电荷归一化（Charge Normalization）**：含有酸性或碱性基团的分子在溶液中以不同[质子化状态](@entry_id:753827)的平衡混合物形式存在。电荷归一化旨在根据分子的$pK_a$值和特定环境的pH值（通常为生理pH $7.4$），确定其最可能的[质子化状态](@entry_id:753827)，并赋予原子正确的形式电荷。
- **[互变异构体](@entry_id:167578)典范化（Tautomer Canonicalization）**：对于在实验条件下能够快速相互转化的[互变异构体](@entry_id:167578)，它们共同贡献了观察到的生物活性。典范化过程需要根据一套固定的规则，从所有可能的[互变异构体](@entry_id:167578)中选择一个唯一的代表形式。这保证了无论输入的是哪个[互变异构体](@entry_id:167578)，最终用于计算的结构都是相同的。
- **同位素移除（Isotope Removal）**：当研究的生物终点（如[热力学](@entry_id:172368)结合亲和力）对同位素不敏感时，应移除分子结构中的[同位素标记](@entry_id:193758)（如$^{13}C$、$D$），将其恢复为默认的天然丰度同位素形式，以确保[同位素标记](@entry_id:193758)的类似物被视为同一化合物。

#### 经典描述符：从物理化学性质到拓扑指纹

标准化之后，就可以从典范化的分子图中提取描述符。这些描述符大致可分为两类：基于物理化学性质的描述符和基于结构的拓扑指纹。

##### 物理化学描述符

这类描述符通常具有明确的物理意义，与分子的宏观性质如图形、大小、极性、疏水性等相关。它们对于构建可解释的QS[AR模型](@entry_id:189434)尤其重要。以跨细胞膜的**被动渗透性**为例，其关键影响因素可以通过以下描述符来量化 [@problem_id:4602614]：
- **辛醇/水[分配系数](@entry_id:177413) ($\log P$)**：定义为化合物**中性形式**在正辛醇和水两相中[达到平衡](@entry_id:170346)时的浓度比的对数。它衡量分子的疏水性。在[溶解-扩散模型](@entry_id:174090)中，更高的$\log P$通常意味着更容易分配到疏水性的细胞膜中，从而提[高渗](@entry_id:145393)透性。但过高的$\log P$可能导致水溶性差，反而降低表观渗透性。对于可电离分子，在特定pH下的表观分配系数应用**分布系数 ($\log D$)** 描述，它同时考虑了中性形式的分配和离子化平衡。
- **拓扑[极性表面](@entry_id:753555)积（Topological Polar Surface Area, TPSA）**：通过基于片段的方法，估算分子中所有极性原子（通常是O和N及其相连的H）的表面[积之和](@entry_id:266697)。TPSA是衡量[分子极性](@entry_id:139879)的重要指标。进入疏水性膜内部需要克服去溶剂化的能量惩罚，因此，在$\log P$固定的情况下，TPSA越大，[去溶剂化惩罚](@entry_id:164055)越高，被动渗透性通常越低。
- **[氢键供体](@entry_id:141108)/受体（HBD/HBA）计数**：分别计算分子中能提供或接受[氢键](@entry_id:136659)的[官能团](@entry_id:139479)数量。这些是极性的具体体现，更多的HBD/HBA通常意味着更高的去[溶剂化能](@entry_id:178842)垒和更低的渗透性。
- **可旋转键数目（Rotatable Bonds）**：衡量分子的柔性。过多的可旋转键会增加分子在溶液中的[构象熵](@entry_id:170224)，进入膜内需要“冻结”到特定构象，从而带来熵惩罚，降低渗透性。
- **分子量（Molecular Weight）**：与分子的大小和体积相关。根据[斯托克斯-爱因斯坦关系](@entry_id:138244)，在粘性介质（如细胞膜）中，分子的扩散系数$D$通常随尺寸增大而减小。因此，在其他条件相同时，分子量增大会降低渗透性。

此外，一些精细的结构特征也能显著影响性质。例如，**[分子内氢键](@entry_id:750785)**可以“隐藏”部分极性[官能团](@entry_id:139479)，使其不与水相互作用，从而有效降低分子的表观极性，减少去[溶剂化能](@entry_id:178842)垒，提[高渗](@entry_id:145393)透性 [@problem_id:4602614]。

##### 结构指纹

**[分子指纹](@entry_id:172531)**是一种将分子结构信息编码为固定长度向量（通常是二进制[位向量](@entry_id:746852)）的方法。它通过识别分子中存在的特定子结构来工作。指纹的生成机制主要有两种：基于预定义字典的匹配和基于子结构枚举与哈希的生成 [@problem_id:4602673]。

- **MACCS键（MACCS Keys）**：这是一种基于**预定义字典**的指纹。例如，166位的MACCS键集包含166个预定义的结构查询（如“是否含有[季碳](@entry_id:199819)”、“是否含有芳香环”等）。指纹的每一位对应一个查询，如果分子中存在该结构，则该位置1，否则为0。这种指纹的优点是每一位都有明确、可解释的化学含义。

- **基于路径的指纹（Path-based Fingerprints）**：这类指纹通过枚举分[子图](@entry_id:273342)中所有长度在一定范围内的原子-键-原子路径来生成。每条路径被编码成一个唯一的标识符，然后通过**[哈希函数](@entry_id:636237)**映射到指纹向量的某个位置并将其置1。

- **扩展连通性指纹（Extended Connectivity Fingerprints, ECFP）** 或 **圆形指纹（Circular Fingerprints）**：这是目前应用最广泛的一类指纹。ECFP通过迭代地编码每个原子的局部环境来生成。在第0步，每个原子根据其自身属性（如原子序数、电荷等）被赋予一个初始整数标识符。在随后的每一次迭代中，每个原子的新标识符由其前一步的标识符和其所有邻居原子前一步的标识符集合共同生成。这个过程会产生大量代表不同半径的原子中心子结构的唯一标识符。最后，这些标识符同样通过**[哈希函数](@entry_id:636237)**映射到指纹向量的相应位置。由于生成的子结构数量可能远大于指纹长度，[哈希冲突](@entry_id:270739)是可能发生的。ECFP对分子结构的局部细节变化非常敏感。

### 建模框架：从数据中学习

将分[子表示](@entry_id:141094)为描述符向量后，QSAR建模就转化为一个标准的**监督学习**问题。目标是学习一个从描述符空间 $\mathbb{R}^p$ 到生物[活性空间](@entry_id:263213) $\mathbb{R}$ 的映射函数 $f$。

#### QSAR的监督学习形式化

给定一个包含 $n$ 个分子的数据集，其中每个分子由一个 $p$ 维描述符向量 $\mathbf{x}_i$ 表示，其对应的活性值为 $y_i$。我们可以构建一个**描述符矩阵** $X \in \mathbb{R}^{n \times p}$ 和一个**活性向量** $y \in \mathbb{R}^n$。[统计模型](@entry_id:755400)通常假设为 $y_i = f(\mathbf{x}_i) + \varepsilon_i$，其中 $\varepsilon_i$ 是独立的、服从均值为0的正态分布的噪声项 $\mathcal{N}(0,\sigma^2)$ [@problem_id:4602697]。

在这一假设下，最大化数据似然等价于最小化**[平方误差损失](@entry_id:178358)** $\ell(y, \hat{y}) = (y - \hat{y})^2$。因此，学习的目标是找到一个函数 $f$ 来最小化**[经验风险](@entry_id:633993)**（即训练集上的平均损失），同时通过**正则化**来控制模型复杂度，[防止过拟合](@entry_id:635166)。这被称为**惩罚[经验风险最小化](@entry_id:633880)**，其目标函数通常是凸的，保证了优化问题的良好性质。

#### 线性模型与正则化

线性模型是最基础也是最具解释性的QS[AR模型](@entry_id:189434)之一，其形式为 $f(\mathbf{x}) = \mathbf{x}^\top \boldsymbol{\beta}$。学习的目标是找到最优的系数向量 $\boldsymbol{\beta}$。

- **普通最小二乘法（Ordinary Least Squares, OLS）**：OLS旨在最小化平方误差和 $\sum_{i=1}^n (y_i - \mathbf{x}_i^\top \boldsymbol{\beta})^2$，不带任何惩罚项。然而，在QSAR的典型场景中，描述符之间常常存在高度相关性（**多重共线性**），或者描述符数量 $p$ 大于样本数量 $n$。在这些情况下，OLS的解可能不唯一或具有极高的方差，导致模型不稳定 [@problem_id:4602688]。

- **岭回归（Ridge Regression）**：为了解决OLS的问题，岭回归在[损失函数](@entry_id:136784)上增加了一个 $\ell_2$ **正则化项** $\lambda \|\boldsymbol{\beta}\|_2^2$（其中 $\|\boldsymbol{\beta}\|_2^2 = \sum_j \beta_j^2$）。这个惩罚项会[压缩系数](@entry_id:272630)向量的$\ell_2$范数，使得所有系数都向零收缩。$\ell_2$惩罚保证了即使在$p>n$或多重共线性的情况下，解也是唯一的。它通过引入少量偏置来大幅降低模型方差，从而提高预测性能。[岭回归](@entry_id:140984)的系数是连续地被压缩，但通常不会精确地等于零 [@problem_id:4602688]。这对应于一个凸的惩罚[经验风险最小化](@entry_id:633880)问题 [@problem_id:4602697]。

- **[LASSO](@entry_id:751223)（Least Absolute Shrinkage and Selection Operator）**：[LASSO](@entry_id:751223)使用 $\ell_1$ **正则化项** $\lambda \|\boldsymbol{\beta}\|_1$（其中 $\|\boldsymbol{\beta}\|_1 = \sum_j |\beta_j|$）。$\ell_1$惩罚的独特之处在于它能够产生**[稀疏解](@entry_id:187463)**，即将许多不重要的描述符的系数精确地压缩为零，从而实现**[变量选择](@entry_id:177971)**。这在处理高维描述符时非常有用。然而，当面对一组高度相关的描述符时，LASSO倾向于随机选择其中的一个并赋予其非零系数，而将其余相关描述符的系数置零，这种选择可能不稳定 [@problem_id:4602688]。

- **弹性网络（Elastic Net）**：弹性网络结合了$\ell_1$和$\ell_2$两种惩罚，其正则化项为 $\lambda_1 \|\boldsymbol{\beta}\|_1 + \lambda_2 \|\boldsymbol{\beta}\|_2^2$。它综合了LASSO和岭回归的优点：$\ell_1$部分负责产生[稀疏解](@entry_id:187463)进行变量选择，而$\ell_2$部分则克服了[LASSO](@entry_id:751223)在处理相关变量时的不稳定性，并鼓励产生“**分组效应**”——即一组相关的描述符的系数会趋向于同进同出模型。[弹性网络](@entry_id:143357)在LASSO和[岭回归](@entry_id:140984)之间进行插值，是一个在QSAR实践中非常强大和灵活的模型 [@problem_id:4602688]。这也构成了一个凸优化问题 [@problem_id:4602697]。

除了[线性模型](@entry_id:178302)，**核方法**（如[核岭回归](@entry_id:636718)或[支持向量回归](@entry_id:141942)）也常被使用。它们通过一个**[核函数](@entry_id:145324)** $k(\mathbf{x}_i, \mathbf{x}_j)$ 将数据隐式地映射到高维[特征空间](@entry_id:638014)，并在该空间中进行线性回归。这允许模型学习复杂的非线性关系，同时通过对**[再生核希尔伯特空间](@entry_id:633928)（RKHS）** 范数的正则化来控制复杂度，同样构成一个凸优化问题 [@problem_id:4602697]。

### 先进模型：学习表示本身

传统的QSAR流程是“固定描述符+学习模型”的两阶段过程。现代深度学习方法，特别是**[图神经网络](@entry_id:136853)（Graph Neural Networks, GNNs）**，则提供了一种端到端的学习范式，能够直接从分子图结构中自动学习最优的分[子表示](@entry_id:141094)。

#### [图神经网络](@entry_id:136853)与[消息传递](@entry_id:751915)

**[消息传递神经网络](@entry_id:751916)（Message Passing Neural Networks, MPNNs）** 是一类GNN的核心框架 [@problem_id:4602669]。其基本思想是通过迭代地聚合邻居节点的信息来更新每个节点（原子）的表示向量。一个典型的MPNN包含以下步骤：
1.  **初始化**：每个原子 $v$ 的初始特征向量 $x_v$（如原子类型、电荷等）被一个可学习的线性层映射为一个初始的隐[状态向量](@entry_id:154607) $h_v^{(0)}$。
2.  **[消息传递](@entry_id:751915)**：在第 $t$ 层，对于每个原子 $v$，其邻居原子 $u \in \mathcal{N}(v)$ 会向它传递“消息”。消息 $m_v^{(t)}$ 是通过一个可学习的函数 $\psi^{(t)}$ 综合了中心原子 $v$、邻居原子 $u$ 的当前隐状态以及它们之间的[化学键](@entry_id:145092)特征 $e_{uv}$ 后，再对所有邻居进行聚合（如求和）得到的。
3.  **更新**：每个原子 $v$ 的新隐状态 $h_v^{(t+1)}$ 由一个可学习的[更新函数](@entry_id:275392) $\phi^{(t)}$ 结合其旧状态 $h_v^{(t)}$ 和收到的聚合消息 $m_v^{(t)}$ 计算得出。
4.  **读出**：经过 $T$ 轮[消息传递](@entry_id:751915)后，每个原子都获得了一个包含了其 $T$ 跳邻域内结构信息的最终隐状态 $h_v^{(T)}$。为了得到整个分子的表示，需要一个**置换不变**的读出函数（如对所有原子的最终状态向量求和或求平均），将所有原子的表示聚合成一个图级别的向量 $z(G)$。
5.  **预测**：最后，这个图级别的向量被送入一个标准的[前馈神经网络](@entry_id:635871)（如多层感知机）以产生最终的活性预测值 $\hat{y}$。

GNNs的核心优势在于其**端到端**的特性：[特征提取](@entry_id:164394)（[消息传递](@entry_id:751915)过程）和回归（最终的预测网络）是在同一个优化目标下联合学习的。这意味着网络可以自动发现与生物活性最相关的结构基序，而无需手动设计或选择描述符。

#### GNNs的关键性质

- **[置换不变性](@entry_id:753356)**：由于GNN中的聚合（求和）和读出（求和）操作都是[交换律](@entry_id:141214)的，并且网络参数在所有原子和键之间共享，因此最终的图级别预测对于分[子图](@entry_id:273342)中原子的编号顺序是**不敏感**的。这是处理图结构数据的一个基本要求 [@problem_id:4602669]。
- **表达能力**：[GNN的表达能力](@entry_id:637052)与经典的**Weisfeiler-Lehman (WL)[图同构](@entry_id:143072)测试**密切相关。一个标准的MPNN的区分能力上限与1-WL测试相同。这意味着，如果两个非同构的图无法被1-WL测试区分，那么该MPNN也无法将它们映射到不同的表示中，从而会给出相同的预测 [@problem_id:4602669]。
- **[归纳偏置](@entry_id:137419)**：与固定描述符模型相比，GNN具有强烈的**局部性[归纳偏置](@entry_id:137419)**。经过 $T$ 层[消息传递](@entry_id:751915)，每个原子的表示仅由其 $T$ 跳邻域决定。当生物活性主要由局部化学环境决定时，这是一种非常有效的正则化，有助于[模型泛化](@entry_id:174365)。反之，如果活性依赖于分子的全局性质或[长程相互作用](@entry_id:140725)，而 $T$ 值又不够大时，GNN可能难以捕捉到这些信息 [@problem_id:4602669]。

### [模型验证](@entry_id:141140)与可信度

构建一个QS[AR模型](@entry_id:189434)后，必须对其性能进行严格、无偏的评估，并明确其预测结果的可信范围。

#### 评估泛化性能与避免选择偏倚

我们关心的是模型在未见数据上的表现，即**泛化风险**。在实践中，我们使用有限的数据集来估计这个风险。一个常见的陷阱是**选择偏倚**：如果同一份数据既被用来调整模型（如选择超参数），又被用来报告最终性能，那么报告的性能将是过于乐观的 [@problem_id:4602652]。

为了获得无偏的性能估计，必须遵守“数据隔离”原则。
- **训练/验证/[测试集](@entry_id:637546)划分**：这是最简单的方法。数据集被划分为三个互不相交的子集：**训练集**用于学习模型参数 $\theta$；**验证集**用于选择最佳的超参数 $h$（如正则化强度$\lambda$）；**[测试集](@entry_id:637546)**则完全不参与训练和调优过程，仅在最后用于评估最终选定模型的性能。[测试集](@entry_id:637546)上的性能是泛化性能的无偏估计 [@problem_id:4602652]。
- **[k-折交叉验证](@entry_id:177917)（k-fold Cross-Validation）**：当数据量较小时，简单的三集划分可能导致[测试集](@entry_id:637546)过小，估计方差大。[k-折交叉验证](@entry_id:177917)将数据分为k个子集，轮流将其中k-1个用于训练，1个用于测试，最后平均k次的结果。这提供了更稳健的性能估计。然而，如果使用k-折CV来选择最佳超参数，那么为这个最佳超参数报告的CV分数本身就是有偏的，因为它是在所有数据上“择优”得到的结果。
- **[嵌套交叉验证](@entry_id:176273)（Nested Cross-Validation）**：为了在没有独立测试集的情况下，既能调优超参数又能获得无偏性能估计，**[嵌套交叉验证](@entry_id:176273)**是金标准。它包含一个**外层循环**和一个**内层循环**。外层循环用于性能评估，它将数据划分为 $k_{out}$ 折。对于外层的每一个[训练集](@entry_id:636396)，会启动一个完整的内层交叉验证（$k_{in}$ 折）来寻找该[训练集](@entry_id:636396)下的最佳超参数。然后，使用这个最佳超参数在整个外层[训练集](@entry_id:636396)上重新训练模型，并在外层[测试集](@entry_id:637546)上评估。最终的性能是所有外层[测试集](@entry_id:637546)上得分的平均值。这个过程确保了用于最终性能评估的数据（外层测试集）从未参与任何超参数的选择过程，从而提供了无偏的估计。无论是[网格搜索](@entry_id:636526)、[随机搜索](@entry_id:637353)还是**[贝叶斯优化](@entry_id:175791)**等高级调优方法，都需要遵循这一原则来避免选择偏倚 [@problem_id:4602652]。

#### 界定[适用域](@entry_id:172549)（Applicability Domain, AD）

任何QS[AR模型](@entry_id:189434)都不是万能的。它的预测能力仅限于与训练数据相似的化学空间。**[适用域](@entry_id:172549)（Applicability Domain, AD）** 定义了这样一个描述符空间区域：在该区域内，模型有足够的数据支持，其预测可被认为是可靠的**内插**，而非不可靠的**外推** [@problem_id:4602662]。在将模型用于[虚拟筛选](@entry_id:171634)或法规决策时，评估一个新分子是否处于AD内是至关重要的一步。

定义AD的方法有多种，它们从不同角度衡量新分子与[训练集](@entry_id:636396)数据的相似性：
- **基于距离的方法**：这是最直观的方法，它直接在描述符空间中定义一个边界。例如，可以计算训练集中每个描述符的范围或标准差，并要求新分子的所有描述符值都落在这个范围内（或在均值的若干个标准差内，如“三西格玛”规则）。这种方法的几何形状通常是一个超矩形。
- **基于[杠杆值](@entry_id:172567)的方法**：此方法与[线性模型](@entry_id:178302)的几何结构相关。一个数据点的**[杠杆值](@entry_id:172567)**（leverage）衡量了它在描述符空间中与数据中心的距离，从而反映了它对[模型拟合](@entry_id:265652)的影响力。杠杆值仅依赖于描述符矩阵 $X$，与响应值 $y$ 无关。AD可以被定义为[杠杆值](@entry_id:172567)小于某个阈值（如所有训练点平均[杠杆值](@entry_id:172567)的3倍）的区域。几何上，这个区域是一个由 $X^T X$ 矩阵定义的椭球。
- **基于概率的方法**：该方法假设训练集的描述符遵循某个概率分布（如[多元正态分布](@entry_id:175229)）。新分子的**[马氏距离](@entry_id:269828)**（Mahalanobis distance）被用来衡量其属于该分布的概率。[马氏距离](@entry_id:269828)考虑了描述符之间的相关性。AD被定义为马氏距离平方小于某个$\chi^2$分布临界值的区域，这同样定义了一个椭球。

这三种方法基于不同的假设，可能会对同一个分子做出不同的判断 [@problem_id:4602662]。例如，一个新分子的所有描述符可能都在各自的“三西格玛”范围内（满足基于距离的AD），但由于其描述符组合方式在[训练集](@entry_id:636396)中不常见，其杠杆值或马氏距离可能非常大，从而被后两种方法判定为AD之外。因此，在实践中，通常会结合多种方法来综合评估一个预测的可靠性。