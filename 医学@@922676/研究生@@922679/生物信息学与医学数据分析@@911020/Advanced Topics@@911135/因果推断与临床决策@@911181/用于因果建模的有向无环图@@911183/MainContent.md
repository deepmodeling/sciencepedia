## 引言
在生物信息学和医学数据分析等领域，从复杂的观测数据中辨别因果关系与虚假关联，是推动科学发现和临床决策的核心挑战。随机对照试验（RCT）虽是黄金标准，但往往因伦理、成本或可行性限制而无法实施。那么，我们如何才能利用海量的观测数据，严谨地推断出干预措施的真实效果呢？有向无环图（Directed Acyclic Graphs, DAGs）为此提供了一个强大、直观且理论坚实的框架。它不仅是一种数学工具，更是一种结构化的思维方式，帮助研究者清晰地阐述因果假设，识别潜在的偏倚来源，[并指](@entry_id:276731)导有效的数据分析策略。

本文旨在系统性地介绍DAGs在因果建模中的应用。通过学习，您将能够弥合“看到”的关联与“行动”产生的效应之间的鸿沟。我们将分三个章节逐步深入：
- 在“**原理与机制**”中，我们将奠定理论基础，详细阐述DAGs的构建规则、[d-分离](@entry_id:748152)准则，以及用以识别因果效应的后门与[前门准则](@entry_id:636516)。
- 在“**应用与跨学科连接**”中，我们将理论付诸实践，通过丰富的案例展示DAGs如何解决生物医学研究中的实际问题，如混杂控制、选择性偏倚、时变混杂处理，并揭示其与中介分析、[工具变量](@entry_id:142324)等其他统计领域的深刻联系。
- 最后，在“**动手实践**”部分，您将通过具体计算问题，亲手应用所学知识，巩固对[d-分离](@entry_id:748152)、偏倚量化和效应估计的理解。

让我们从DAGs的基本原理开始，探索如何将我们对世界运行方式的直觉知识，转化为一个可以进行严格[逻辑推演](@entry_id:267782)的数学模型。

## 原理与机制

本章旨在深入探讨因果推断中指导性图形工具——[有向无环图](@entry_id:164045)（Directed Acyclic Graphs, DAGs）的核心原理与作用机制。作为“引言”章节的延续，我们将直接进入技术细节，系统性地阐述DAGs如何形式化地表达因果假设，并提供一套严谨的规则，用于从观测数据中识别和估计因果效应。我们将从结构因果模型（Structural Causal Models, SCM）的基础出发，逐步构建起DAGs的语法和语义，最终达到能够运用[后门准则](@entry_id:637856)与[前门准则](@entry_id:636516)解决复杂因果问题的程度。

### 从因果机制到图模型表示

在科学研究中，我们通常认为现象是由一系列潜在的、稳定的机制所驱动的。例如，在临床医学中，患者的恢复情况可能取决于其所接受的治疗、基线健康状况以及一系列内在的生物学过程。结构因果模型（SCM）为这一思想提供了数学形式化。在一个SCM中，系统中的每一个变量 $X_i$ 的值都被看作是一个确定性函数 $f_i$ 的结果，该函数作用于其直接原因（记为 $\mathrm{Pa}(X_i)$）和一组外生的、随机的扰动因素 $U_i$。其数学表达式为：

$X_i = f_i(\mathrm{Pa}(X_i), U_i)$

这里，$\mathrm{Pa}(X_i)$ 代表变量 $X_i$ 的“父节点”集合，即直接导致 $X_i$ 变化的变量。$U_i$ 代表了所有未被模型明确包含的其他影响因素，并且在标准模型中，我们假设所有这些外生扰动项 $\{U_i\}$ 是相互独立的。

**[有向无环图 (DAG)](@entry_id:748452)** 正是这种结构因果模型的图形化表达。在DAG中，每个节点代表一个变量，而一条从节点 $X_j$ 指向 $X_i$ 的有向边（$X_j \to X_i$）则精确地表示 $X_j$ 是 $X_i$ 的一个直接原因，即 $X_j \in \mathrm{Pa}(X_i)$。因此，DAG的拓扑结构编码了一整套关于数据生成机制的因果假设。

DAGs的两个核心特征是**有向性（directionality）**和**无环性（acyclicity）**。**有向性**捕捉了因果关系的不对称性：如果治疗影响了生物标志物，这并不意味着改变生物标志物会反过来影响治疗的分配。边的箭头方向至关重要，它区分了原因和结果，这与仅表示对称关联的**[无向图](@entry_id:270905)模型（undirected graphical model）**形成了鲜明对比。无向图中的边 $X - Y$ 仅表示 $X$ 和 $Y$ 之间存在某种依赖关系，但无法说明是 $X$ 导致 $Y$，还是 $Y$ 导致 $X$，抑或两者由一个共同因素所驱动 [@problem_id:4557739]。

**无环性**则是一个逻辑上的必然要求：任何变量都不能直接或间接地成为其自身的原因。例如，一个人的基线合并症负担 $C$ 可能会影响医生为其开具的治疗方案 $T$，而治疗方案 $T$ 可能会影响24小时后测量的生物标志物 $B$，但生物标志物 $B$ 的值不可能反过来影响在它之前发生的基线合并症 $C$。这种不存在如 $A \to B \to A$ 这样的循环路径的特性，保证了图中所有变量可以进行**[拓扑排序](@entry_id:156507)**，即可以将它们排列在一个序列中，使得所有原因都出现在其结果之前。这个序列可以自然地对应于事件发生的时间顺序或逻辑顺序 [@problem_id:4557739]。

在因果DAG中，边的存在与否具有深刻的语义。一条边 $T \to L$ 的存在，意味着如果我们固定 $L$ 的所有其他直接原因，对 $T$ 进行干预仍能改变 $L$ 的分布。这等同于说 $T$ 是生成 $L$ 的[结构方程](@entry_id:274644)中的一个自变量 [@problem_id:4960042]。反之，**边的缺失则是一个更强的假设**。例如，在关于他汀类药物的研究模型中，如果不存在从治疗 $T$ 到心肌梗死 $Y$ 的直接边（$T \to Y$），这并不意味着 $T$ 和 $Y$ 在观测数据中是独立的。事实上，由于存在通过低密度脂蛋白 $L$ 的中介路径 $T \to L \to Y$ 和通过基线风险 $C$ 的共同原因路径 $T \leftarrow C \to Y$， $T$ 和 $Y$ 几乎必然是相关的。边的缺失所代表的假设是：**不存在从 $T$ 到 $Y$ 的直接因果效应**。这一假设可以通过**因果马尔可夫假设（Causal Markov Assumption）**转化为关于条件独立的陈述，我们将在下一节详细探讨。

### 连接图与概率的桥梁：[马尔可夫性质](@entry_id:139474)与[d-分离](@entry_id:748152)

DAGs之所以强大，是因为它们不仅编码了[因果结构](@entry_id:159914)，还通过一套严谨的规则将该结构与变量间的统计依赖关系联系起来。这个联系的桥梁是**因果马尔可夫假设**，它断言：在因果DAG中，给定一个节点的直接父节点（其直接原因），该节点与其所有非后代节点（即非其效应的节点）在统计上是独立的。

这个假设的一个直接推论是**局部[马尔可夫性质](@entry_id:139474)**：任何变量 $X_i$ 在给定其父节点 $\mathrm{Pa}(X_i)$ 的条件下，与其非后代节点条件独立 [@problem_id:4557739]。例如，在模型 $C \to T, C \to Y, T \to L, L \to Y$ 中， $Y$ 的父节点是 $\{L, C\}$。根据局部[马尔可夫性质](@entry_id:139474)，$Y$ 在给定 $L$ 和 $C$ 的条件下，与其非后代节点（这里包括 $T$）条件独立。因此，图中断言了 $Y \perp T \mid \{L, C\}$ [@problem_id:4960042]。这一性质正是源于图中不存在从 $T$ 到 $Y$ 的直接边。

为了在图中判断任意两个（组）变量之间是否存在条件独立关系，我们使用一个称为**[d-分离](@entry_id:748152)（d-separation）**的图形准则。“d”代表“方向（directional）”。如果对于两个节点（或节点集） $X$ 和 $Y$ 之间的**每一条**路径都被一个节点集 $Z$ 所“阻断（blocked）”，那么我们就说 $X$ 和 $Y$ 被 $Z$ [d-分离](@entry_id:748152)，记为 $X \perp Y \mid Z$。路径的阻断与否，取决于路径上节点的结构以及该节点是否在条件集 $Z$ 中。理解[d-分离](@entry_id:748152)的关键在于掌握三种基本的路径结构：链式结构、[分叉](@entry_id:270606)结构和对撞结构 [@problem_id:4960169]。

1.  **链式结构 (Chains)**：路径形式为 $A \to B \to C$。在这种结构中，关联性从 $A$ 流向 $C$。如果我们在中间节点 $B$ 上进行条件化（即 $B \in Z$），关联流就被阻断。例如，[他汀类药物](@entry_id:167025) $T$ 通过降低胆[固醇](@entry_id:173187) $B$ 来减少心肌梗死 $Y$ ($T \to B \to Y$) 。$B$ 在这里是一个**中介者 (mediator)**。不进行条件化时，$T$ 和 $Y$ 是关联的。但如果我们控制了 $B$ 的水平（例如，只看胆[固醇](@entry_id:173187)为某一特定值的患者），那么 $T$ 和 $Y$ 之间的这条路径就被阻断了 [@problem_id:4557815]。

2.  **分叉结构 (Forks)**：路径形式为 $A \leftarrow B \to C$。这里，$B$ 是 $A$ 和 $C$ 的一个**[共同原因](@entry_id:266381) (common cause)**，它会产生一条非因果的关联路径。这条路径默认是开放的，但同样地，在 $B$ 上进行条件化会将其阻断。例如，社会经济地位 $E$ 既影响吸烟行为 $S$ 也影响肺癌风险 $L$ ($S \leftarrow E \to L$)。$E$ 在这里是一个**混杂因素 (confounder)**。在未控制 $E$ 的人群中，$S$ 和 $L$ 会表现出关联，即使我们假设吸烟本身对肺癌有直接影响($S \to L$)，这种关联也包含了由 $E$ 引起的虚假成分。通过对 $E$ 进行分层分析（条件化），我们可以阻断这条“后门”路径 [@problem_id:4557815]。

3.  **对撞结构 (Colliders)**：路径形式为 $A \to B \leftarrow C$。这是最特殊且最违反直觉的结构。在这里，$B$ 是 $A$ 和 $C$ 的一个**共同效应 (common effect)**，我们称 $B$ 为一个**对撞节点 (collider)**。与前两种结构相反，包含对撞节点的路径**默认是阻断的**。$A$ 和 $C$ 之间不存在无条件的关联。然而，如果我们对对撞节点 $B$ **或其任何后代节点**进行条件化，这条原本被阻断的路径反而会被**打开**，从而在 $A$ 和 $C$ 之间引入一种虚假的、非因果的关联。

[对撞偏倚](@entry_id:163186)（collider bias），也称为选择偏倚（selection bias），是因果推断中一个常见且[隐蔽](@entry_id:196364)的陷阱。让我们通过一个具体的例子来理解这个机制 [@problem_id:4557801]。假设一个基因型 $G$ 决定了患者是否接受治疗 $T$ ($T:=G$)，而一个独立的基线严重程度 $R$ 决定了患者的预后 $Y$ ($Y:=R$)。在整个人群中，$G$ 和 $R$ 是独立的，因此 $T$ 和 $Y$ 也是独立的。现在，假设只有当患者具有风险基因型 ($G=1$) 或疾病严重 ($R=1$) 时，他们才会被招募进一项研究，即入组状态 $S := \mathbf{1}(G=1 \lor R=1)$。在图中，这构成了对撞结构 $T \leftarrow G \to S \leftarrow R \to Y$。在整个人群中，由于对撞节点 $S$ 的存在， $T$ 和 $Y$ 之间的这条路径是阻断的，它们相互独立。但是，如果我们的分析**仅限于研究内的参与者**，这相当于对 $S=1$ 进行了条件化。此时，对撞路径被打开。为什么呢？因为在已知一个患者在研究中（$S=1$）的前提下，如果我们观察到他没有接受治疗（$T=0$, 意味着 $G=0$），我们就能推断出他的疾病一定很严重（$R=1$, 意味着 $Y=1$），否则他就不会入组。这样一来，在入组人群中，$T$ 和 $Y$ 之间就产生了一种负相关关系，即使它们之间没有任何因果联系。这种因在选择样本时对共同效应进行条件化而导致的偏倚，就是选择偏倚。

### 评估因果效应：干预与条件化

因果推断的核心任务是区分“观察到的关联”与“干预产生的效应”。这两种概念在数学上对应着**[条件概率](@entry_id:151013)（conditioning）**和**干预分布（intervention）**。

**[条件概率](@entry_id:151013)** $P(Y \mid X=x)$ 描述的是一个被动观察的过程：在我们观察到的人群中，那些恰好 $X$ 取值为 $x$ 的亚群里，$Y$ 的分布是怎样的。这是一种“看见（seeing）”的逻辑。

**干预分布** $P(Y \mid \text{do}(X=x))$ 则描述了一个主动干预的过程：如果我们强制将人群中**每一个**个体的 $X$ 值都设定为 $x$ ，而不管他们原本的自然状态如何，那么 $Y$ 的分布将会是怎样的。这是一种“行动（doing）”的逻辑。

在大多数情况下，尤其是在存在**混杂（confounding）**时，这两者是完全不同的。让我们回到经典的混杂例子：一个未被观测的基线炎症负担 $U$ 既影响医生开具的药物剂量 $X$（$U \to X$），也直接影响患者的预后 $Y$（$U \to Y$），同时药物剂量 $X$ 也对预后 $Y$ 有直接的因果效应（$X \to Y$） [@problem_id:4557715]。

在这种情况下，$P(Y \mid X=x)$ 是有偏的。为什么？因为我们观察到接受高剂量 $X$ 的患者亚群，并不是一个随机样本。他们之所以接受高剂量，很可能是因为他们的基线炎症 $U$ 更严重。而更严重的 $U$ 本身就会导致更差的预后 $Y$。因此，观测到的 $X$ 和 $Y$ 之间的关联，混合了 $X$ 对 $Y$ 的真实因果效应，以及通过[共同原因](@entry_id:266381) $U$ 产生的虚假关联。数学上，我们可以将二者展开：

-   **[条件概率](@entry_id:151013) (观测)**: $P(Y=y \mid X=x) = \sum_{u} P(Y=y \mid X=x, U=u) P(U=u \mid X=x)$
-   **干预分布 (因果)**: $P(Y=y \mid \text{do}(X=x)) = \sum_{u} P(Y=y \mid X=x, U=u) P(U=u)$

对比这两个公式可以发现，它们的区别在于对不同 $U$ 水平下的效应 $P(Y \mid X, U)$ 进行加权的权重不同。[条件概率](@entry_id:151013)使用 $P(U \mid X=x)$ 作为权重，即在 $X=x$ 的亚群中 $U$ 的分布；而干预分布使用 $P(U)$ 作为权重，即在**整个人群**中 $U$ 的分布。由于存在 $U \to X$ 的边， $P(U \mid X=x) \neq P(U)$，因此 $P(Y \mid X=x) \neq P(Y \mid \text{do}(X=x))$。一个理想的**随机对照试验（RCT）**正是通过随机分配 $X$ 来物理上切断 $U \to X$ 这条边，从而使得 $P(U \mid X=x) = P(U)$，进而让观测到的关联等于因果效应 [@problem_id:4557715]。

在DAG框架下，$\text{do}(X=x)$ 这一操作有非常直观的图形解释：**图 mutilation（图截断）** [@problem_id:4557794]。执行 $\text{do}(X=x)$ 意味着我们用一个常数 $x$ 取代了原来生成 $X$ 的自然机制 $X=f_X(\mathrm{pa}(X), U_X)$。在图形上，这等同于**删除所有指向 $X$ 的边**，因为 $X$ 的值不再依赖于它的任何父节点。之后，[联合概率分布](@entry_id:171550)的因子分解式也会相应地被“截断”：原来的因子 $P(X \mid \mathrm{pa}(X))$ 被一个在 $x$ 处的点[质量函数](@entry_id:158970)所取代。例如，在一个模型 $P(B,S,X,Y)=P(B)P(S)P(X \mid B,S)P(Y \mid X,B,S)$ 中，干预后的分布变为：

$P^{\text{do}(x^{\star})}(B,S,X,Y) = \delta_{x^{\star}}(X) P(B) P(S) P(Y \mid X=x^{\star}, B, S)$

其中 $\delta_{x^{\star}}(X)$ 表示 $X$ 被固定在 $x^{\star}$。这个过程清晰地展示了干预是如何通过改变系统的[因果结构](@entry_id:159914)来产生与观测不同的结果的。

### 可识别性策略：[后门准则](@entry_id:637856)与[前门准则](@entry_id:636516)

既然观测到的关联不等于因果效应，我们如何在无法进行RCT的观测性研究中估计 $P(Y \mid \text{do}(X=x))$ 呢？这就是**可识别性（identification）**问题。DAGs为我们提供了强大的工具来回答这个问题。核心思想是：利用图结构找到一个或一组变量进行调整（条件化），从而消除虚假关联，分离出纯粹的因果效应。

#### [后门准则](@entry_id:637856) (The Backdoor Criterion)

“[后门准则](@entry_id:637856)”是最常用、最直观的可识别性判据，它旨在通过控制混杂因素来阻断所有非因果路径 [@problem_id:4557770]。一条从 $X$到 $Y$ 的**后门路径（backdoor path）**是指任何一条连接 $X$ 和 $Y$ 且起始于指向 $X$ 的箭头的路径。这种路径是“后门”的，因为它代表了在 $X$ 之前的[共同原因](@entry_id:266381)所引入的非因果关联。

一个节点集 $Z$ 被称为满足相对于 $(X,Y)$ 的**[后门准则](@entry_id:637856)**，如果它满足以下两个条件：
1.  $Z$ 中不包含 $X$ 的任何后代节点。
2.  $Z$ 阻断了所有从 $X$ 到 $Y$ 的后门路径。

**条件1**至关重要。如果我们控制了 $X$ 的后代，可能会产生两种严重问题：(a) 如果该后代是 $X \to Y$ 路径上的一个中介者（如 $M$ in $X \to M \to Y$），控制它会阻断我们想要测量的部分因果效应；(b) 如果该后代是一个对撞节点（如 $S$ in $X \to S \leftarrow U$），控制它会打开一条新的虚[假路径](@entry_id:168255)，引入选择偏倚。

**条件2**是核心。通过对 $Z$ 中的变量进行条件化，我们阻断了所有由共同原因（混杂因素）引起的虚假关联。

如果找到了一个满足[后门准则](@entry_id:637856)的集合 $Z$（并且 $Z$ 中的变量都是可观测的），那么 $X$ 对 $Y$ 的因果效应就是可识别的，并且可以通过**调整公式（adjustment formula）**来计算：

$P(Y \mid \text{do}(X=x)) = \sum_{z} P(Y \mid X=x, Z=z) P(Z=z)$

这个公式的直观解释是：我们在混杂因素 $Z$ 的每一个水平（stratum）$z$ 内部计算 $X$ 对 $Y$ 的关联 $P(Y \mid X=x, Z=z)$，然后在用 $Z$ 在总人群中的分布 $P(Z=z)$ 对这些层内的关联进行加权平均。这样就模拟了一个“伪随机化”过程，得到了纯净的因果效应。

#### [前门准则](@entry_id:636516) (The Frontdoor Criterion)

当主要的混杂因素 $U$ 无法被观测时，后门路径 $X \leftarrow U \to Y$ 无法被阻断，[后门准则](@entry_id:637856)失效。在这种情况下，我们还有没有办法识别因果效应呢？“[前门准则](@entry_id:636516)”提供了一种精妙的解决方案 [@problem_id:4557698]。它的思想是，如果我们无法从“后门”阻断混杂，或许可以完整地追踪从“前门”流出的因果效应。

这需要我们能够观测到一个或一组**中介变量** $\mathbf{M}$，它们满足以下三个严格的**[前门准则](@entry_id:636516)**条件：
1.  $\mathbf{M}$ 截断了所有从 $X$ 到 $Y$ 的有向（因果）路径。
2.  从 $X$ 到 $\mathbf{M}$ 没有未被阻断的后门路径。
3.  所有从 $\mathbf{M}$ 到 $Y$ 的后门路径都被 $X$ 阻断。

**条件1** 意味着 $X$ 对 $Y$ 的所有影响都必须通过 $\mathbf{M}$ 来传导。**条件2** 意味着 $X$ 对 $\mathbf{M}$ 的效应是没有混杂的，可以直接从观测数据中估计，即 $P(\mathbf{m} \mid \text{do}(x)) = P(\mathbf{m} \mid x)$。**条件3** 意味着虽然 $\mathbf{M}$ 到 $Y$ 的关系可能被 $X \leftarrow U \to Y$ 这条路径所混杂，但这种混杂可以通过控制 $X$ 来消除。因此， $\mathbf{M}$ 对 $Y$ 的效应可以通过对 $X$ 进行后门调整来识别。

满足这些条件后， $X$ 对 $Y$ 的总因果效应可以通过两步识别，并由**前门公式**给出：

$P(y \mid \text{do}(x)) = \sum_{\mathbf{m}} P(\mathbf{m} \mid x) \sum_{x'} P(y \mid \mathbf{m}, x') P(x')$

这个公式首先计算了 $X$ 对 $\mathbf{M}$ 的影响 ($P(\mathbf{m} \mid x)$)，然后计算了 $\mathbf{M}$ 对 $Y$ 的经 $X$ 调整后的影响 ($\sum_{x'} P(y \mid \mathbf{m}, x') P(x')$)，最后将两者结合，从而在存在未观测混杂的情况下巧妙地重构了总因果效应。

### 观测推断的局限性：[马尔可夫等价](@entry_id:751683)

尽管DAGs功能强大，但我们必须认识到，仅凭观测数据本身，我们往往无法唯一确定一个系统中真实的[因果结构](@entry_id:159914)。不同的因果图可能在统计上是无法区分的，这个概念被称为**[马尔可夫等价](@entry_id:751683)（Markov equivalence）** [@problem_id:4959958]。

两个DAG如果蕴含了完全相同的条件独立关系集合，那么它们就是[马尔可夫等价](@entry_id:751683)的。这意味着，任何能够被一个图的联合概率分布所满足的条件独立性，也同样能被另一个图所满足。因此，无论我们有多少观测数据，都无法从统计上区分这两个图哪个是“真实”的。

一个深刻的定理给出了判断[马尔可夫等价](@entry_id:751683)的图形准则：**两个DAG是[马尔可夫等价](@entry_id:751683)的，当且仅当它们拥有相同的骨架（skeleton）和相同的v-结构（v-structures）**。

-   **骨架**是指将DAG中所有边的箭头去掉后得到的无向图。它决定了图中哪些节点是相邻的，从而定义了所有潜在路径的存在。
-   **v-结构**是指形如 $A \to B \leftarrow C$ 且 $A$ 和 $C$ 不相邻的对撞结构。

这个定理的逻辑根植于[d-分离](@entry_id:748152)的规则。[d-分离](@entry_id:748152)判断路径是否被阻断，依赖于两个核心要素：路径的存在（由骨架决定）和路径上节点的类型（是对撞节点还是非对撞节点）。v-结构恰好是图中所有“不可逆”的结构单元。任何边的翻转，只要不产生新的v-结构或破坏原有的v-结构，就不会改变图所蕴含的条件独立关系。例如，链式结构 $X \to Y \to Z$ 和 $X \leftarrow Y \leftarrow Z$ 以及分叉结构 $X \leftarrow Y \to Z$ 这三者是[马尔可夫等价](@entry_id:751683)的，因为它们有相同的骨架且都没有v-结构。然而，一旦我们有一个v-结构，如 $X \to Y \leftarrow Z$，任何试图翻转其中一条边的操作（如变成 $X \to Y \to Z$）都会破坏这个v-结构，从而改变图的条件独立关系，使得新图与原图不再等价。

[马尔可夫等价](@entry_id:751683)的概念揭示了纯粹基于观测数据的因果推断的根本局限性。它告诉我们，数据可以帮助我们将[因果结构](@entry_id:159914)缩小到一个**等价类（equivalence class）**内，但要从[等价类](@entry_id:156032)中唯一确定真实的因果图（特别是边的方向），则需要额外的来源，如背景知识、实验数据或者引入更强的结构假设。