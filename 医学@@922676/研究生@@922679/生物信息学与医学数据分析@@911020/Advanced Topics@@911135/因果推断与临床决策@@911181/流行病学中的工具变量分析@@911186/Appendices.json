{"hands_on_practices": [{"introduction": "本练习旨在巩固对工具变量分析核心逻辑的理解。通过从协方差关系这一基本原理出发，您将推导出在二元工具变量这一常见情境下的IV估计量，即Wald估计量。这项实践将理论与一个简洁直观的公式联系起来，揭示了如何利用工具变量对暴露的影响来估算其对结局的因果效应。[@problem_id:4574229]", "problem": "一项心血管流行病学领域的大规模孟德尔随机化研究旨在探究一种连续性炎症生物标志物 $X$（C反应蛋白，单位为 mg/L）对一个连续性结局 $Y$（收缩压，单位为 mmHg）的因果效应。一个单核苷酸多态性被用作工具变量 (IV)，并被编码为一个二元工具变量 $Z \\in \\{0,1\\}$，表示效应等位基因的不存在 ($Z=0$) 或存在 ($Z=1$)。假设一个线性结构因果模型，其中 $X$ 对 $Y$ 的平均因果效应是一个恒定的斜率参数 $\\beta$，并且 $Z$ 可能影响 $X$，但仅通过 $X$ 影响 $Y$。在超总体框架下进行分析，并假设所有相关的期望和方差都存在且有限。\n\n仅使用工具变量相关性和外生性的核心定义，并且不借助任何预先指定的估计公式，当 $Z$ 是二元变量时，推导用于估计 $X$ 对 $Y$ 因果效应的、基于 $Z$ 的恰好识别的 IV 估计量的总体比率形式。然后，使用下面的样本摘要数据，构建样本类比估计量并计算其数值。\n\n一个包含 $n = 100{,}000$ 名无亲缘关系且血统同质的个体的队列被进行了基因分型。从数据中估计出以下亚组均值：\n- 在 $Z=1$ 的个体中：$X$ 的样本均值为 $\\bar{X}_{1} = 2.91$ mg/L，$Y$ 的样本均值为 $\\bar{Y}_{1} = 129.80$ mmHg。\n- 在 $Z=0$ 的个体中：$X$ 的样本均值为 $\\bar{X}_{0} = 2.28$ mg/L，$Y$ 的样本均值为 $\\bar{Y}_{0} = 127.43$ mmHg。\n\n使用上述样本均值，计算 $X$ 对 $Y$ 平均因果效应的基于工具变量的比率估计值（一个标量）。将答案四舍五入至四位有效数字。用 mmHg/mg/L 的单位表达该因果效应。\n\n最后，在所述的具有二元工具变量和连续暴露的流行病学背景下，从工具变量相关性、外生性、结构性假设和正则性条件等方面，清晰地阐述该估计量成为因果效应参数的一致估计量所需的最小化的高层条件。", "solution": "该问题要求推导针对二元工具变量的工具变量 (IV) 估计量，根据样本数据进行计算，并阐述其一致性的条件。背景是一项孟德尔随机化研究，其中遗传变异 $Z$ 被用作工具变量，以估计生物标志物 $X$ 对健康结局 $Y$ 的因果效应。\n\n首先，我们推导 IV 估计量的总体形式。假设关联结局 $Y$ 和暴露 $X$ 的结构因果模型是线性的，具有一个恒定的因果效应参数 $\\beta$：\n$$\nY = \\alpha_Y + \\beta X + U\n$$\n其中 $U$ 代表 $Y$ 的所有其他原因，包括可能与 $X$ 相关的未测量混杂因素。目标是估计 $\\beta$。\n\n工具变量 $Z$ 必须满足两个核心条件：\n1.  **相关性**：$Z$ 必须与暴露 $X$ 相关。形式上，$\\text{Cov}(Z, X) \\neq 0$。\n2.  **外生性**：$Z$ 必须独立于 $X-Y$ 关系中的任何未测量混杂因素。这通常被操作化为两个子条件：(a) $Z$ 仅通过 $X$ 影响 $Y$（排他性限制），以及 (b) $Z$ 独立于 $U$。这两个条件共同意味着 $\\text{Cov}(Z, U) = 0$。\n\n我们计算结构方程与工具变量 $Z$ 的协方差：\n$$\n\\text{Cov}(Y, Z) = \\text{Cov}(\\alpha_Y + \\beta X + U, Z)\n$$\n利用协方差的线性性质，上式变为：\n$$\n\\text{Cov}(Y, Z) = \\text{Cov}(\\alpha_Y, Z) + \\beta \\text{Cov}(X, Z) + \\text{Cov}(U, Z)\n$$\n由于 $\\alpha_Y$ 是一个常数，所以 $\\text{Cov}(\\alpha_Y, Z) = 0$。根据外生性假设，我们有 $\\text{Cov}(U, Z) = 0$。这使得方程简化为：\n$$\n\\text{Cov}(Y, Z) = \\beta \\text{Cov}(X, Z)\n$$\n根据相关性假设，$\\text{Cov}(X, Z) \\neq 0$，因此我们可以解出 $\\beta$：\n$$\n\\beta = \\frac{\\text{Cov}(Y, Z)}{\\text{Cov}(X, Z)}\n$$\n这是总体 IV 估计目标的一般形式。对于一个二元工具变量 $Z \\in \\{0,1\\}$，协方差公式可以被简化。对于任意随机变量 $V$，其与二元变量 $Z$ 的协方差为 $\\text{Cov}(V, Z) = (\\mathbb{E}[V|Z=1] - \\mathbb{E}[V|Z=0])\\mathbb{P}(Z=1)(1-\\mathbb{P}(Z=1))$。将此公式应用于分子和分母：\n$$\n\\beta = \\frac{(\\mathbb{E}[Y|Z=1] - \\mathbb{E}[Y|Z=0])\\mathbb{P}(Z=1)(1-\\mathbb{P}(Z=1))}{(\\mathbb{E}[X|Z=1] - \\mathbb{E}[X|Z=0])\\mathbb{P}(Z=1)(1-\\mathbb{P}(Z=1))}\n$$\n假设 $Z$ 不是一个常数，即 $0  \\mathbb{P}(Z=1)  1$，那么 $\\mathbb{P}(Z=1)(1-\\mathbb{P}(Z=1))$ 项非零，可以被约去。这就得出了针对二元工具变量的特定总体比率形式：\n$$\n\\beta = \\frac{\\mathbb{E}[Y|Z=1] - \\mathbb{E}[Y|Z=0]}{\\mathbb{E}[X|Z=1] - \\mathbb{E}[X|Z=0]}\n$$\n这个公式将估计目标定义为由工具变量定义的两组之间，均值结局的差异与均值暴露的差异之比。\n\n第二，我们通过将总体条件期望替换为它们的样本对应物——即条件样本均值，来构建样本类比估计量。该估计量记为 $\\hat{\\beta}_{IV}$，其形式为：\n$$\n\\hat{\\beta}_{IV} = \\frac{\\bar{Y}_{1} - \\bar{Y}_{0}}{\\bar{X}_{1} - \\bar{X}_{0}}\n$$\n其中 $\\bar{Y}_{1}$ 和 $\\bar{X}_{1}$ 分别是 $Z=1$ 亚组中 $Y$ 和 $X$ 的样本均值，而 $\\bar{Y}_{0}$ 和 $\\bar{X}_{0}$ 分别是 $Z=0$ 亚组的样本均值。\n\n使用所提供的数据：\n- $\\bar{Y}_{1} = 129.80$\n- $\\bar{Y}_{0} = 127.43$\n- $\\bar{X}_{1} = 2.91$\n- $\\bar{X}_{0} = 2.28$\n\n我们将这些值代入估计量公式：\n$$\n\\hat{\\beta}_{IV} = \\frac{129.80 - 127.43}{2.91 - 2.28} = \\frac{2.37}{0.63} \\approx 3.7619047...\n$$\n按要求四舍五入到四位有效数字，我们得到：\n$$\n\\hat{\\beta}_{IV} \\approx 3.762\n$$\n单位是 mmHg/mg/L。\n\n第三，在此情境下，要使 $\\hat{\\beta}_{IV}$ 成为因果效应 $\\beta$ 的一致估计量，所需的最小化的高层条件如下：\n1.  **工具变量相关性**：SNP ($Z$) 必须对C反应蛋白水平 ($X$) 有因果效应。在总体中，这意味着 $\\mathbb{E}[X|Z=1] \\neq \\mathbb{E}[X|Z=0]$。违背此条件，或近乎违背（即“弱工具变量”），会使估计量有偏且变异性极大。\n2.  **工具变量外生性（及排他性限制）**：SNP ($Z$) 必须独立于所有同时影响C反应蛋白 ($X$) 和收缩压 ($Y$) 的未测量混杂因素。这意味着 (a) SNP 不通过任何绕过C反应蛋白的路径影响血压（即不存在构成后门路径的多效性），并且 (b) SNP 的存在与其他导致高血压的生活方式或环境因素不相关。第二点由于减数分裂中等位基因的随机分配而变得合理。\n3.  **线性与同质性**：问题中关于具有恒定因果效应 $\\beta$ 的线性结构模型的前提是一个很强的结构性假设。它假定 $X$ 对 $Y$ 的因果效应对每个个体都是相同的。在此假设下，IV 估计量是这个恒定效应 $\\beta$ 的一致估计。如果没有这个假设（即存在效应异质性），IV 比率会收敛于局部平均处理效应 (LATE)，这仅仅是那些暴露水平受工具变量影响的个体的平均效应。\n\n这三个条件，连同标准的正则性假设（例如，如题中所给的来自总体的随机样本和有限矩）以及大样本量，确保了样本估计量 $\\hat{\\beta}_{IV}$ 依概率收敛于真实的因果参数 $\\beta$。", "answer": "$$\\boxed{3.762}$$", "id": "4574229"}, {"introduction": "此前的练习建立在因果效应恒定的假设之上，但现实中效应可能因人而异。本练习将探讨当存在异质性因果效应时，工具变量估计量究竟识别了什么。通过在潜在结果框架下进行推导，您将理解工具变量估计量所识别的并非全体人群的平均效应，而是仅针对那些因工具变量而改变暴露状态的“依从者”亚群的效应，即局部平均处理效应 (LATE)，这对于严谨解释流行病学研究结果至关重要。[@problem_id:4574225]", "problem": "一个基因组学赋能的卫生系统进行了一项鼓励性设计，以评估启动药物基因组学指导的他汀类药物治疗对降低低密度脂蛋白胆固醇的因果效应。符合条件的患者中，一个随机子集会收到参加药物基因组学咨询的电子鼓励信息，这会增加他们启动他汀类药物治疗方案的机会。设二元工具变量为 $Z \\in \\{0,1\\}$，其中 $Z=1$ 表示受到鼓励。设二元干预为 $X \\in \\{0,1\\}$，其中 $X=1$ 表示启动治疗。设结局为 $Y \\in \\mathbb{R}$，即随访时的低密度脂蛋白胆固醇水平（越低越好）。使用潜在结局框架，并作出以下定义和假设：\n\n- 稳定单位治疗价值假设 (SUTVA): 对于每个单位，其潜在干预 $X(z) \\in \\{0,1\\}$（其中 $z \\in \\{0,1\\}$）和潜在结局 $Y(x) \\in \\mathbb{R}$（其中 $x \\in \\{0,1\\}$）都是明确定义的，并且单位之间没有干扰。\n- 独立性：工具变量是随机分配的，因此 $Z \\perp \\big(Y(1),Y(0),X(1),X(0)\\big)$。\n- 排他性限制：工具变量仅通过干预影响结局，因此观测到的结局是 $Y=Y\\big(X\\big)$，并且除了通过 $X$ 产生的影响外，$Z$ 对 $Y$ 没有直接影响。\n- 单调性：不存在违逆者，即对所有单位而言，$X(1) \\geq X(0)$。\n- 相关性：工具变量改变了干预接受情况，因此 $\\mathbb{P}\\big(X(1) \\neq X(0)\\big) > 0$。\n\n将局部平均干预效应 (LATE) 定义为干预对依从者亚群的平均因果效应，即\n$$\n\\text{LATE} \\equiv \\mathbb{E}\\big[\\,Y(1)-Y(0)\\,\\big|\\,X(1)=1,\\,X(0)=0\\,\\big].\n$$\n\n仅从这些定义和假设出发，推导出一个 $\\text{LATE}$ 的闭式表达式，该表达式应使用工具变量不同水平下条件期望的观测差异来表示，且仅使用 $\\mathbb{E}[\\,\\cdot \\mid Z=z\\,]$ 形式的量。在推导过程中，明确陈述并论证从假设到最终识别公式的每一步，包括在单调性假设下每种依从类型（总是接受者、从不接受者、依从者和违逆者）所扮演的角色。解释最终表达式中分子和分母在该鼓励性设计的流行病学背景下的含义。以可观测期望值的形式，将 $\\text{LATE}$ 的最终表达式表示为单个简化的符号分数。不应包含任何数值计算。最终答案必须是单个解析表达式。", "solution": "我们首先使用潜在结局框架来形式化因果结构。每个单位都有对应于工具变量水平 $Z=1$ 和 $Z=0$ 的潜在干预 $X(1)$ 和 $X(0)$，以及对应于干预水平 $X=1$ 和 $X=0$ 的潜在结局 $Y(1)$ 和 $Y(0)$。观测到的干预是 $X = X(Z)$，并且根据排他性限制，观测到的结局是 $Y = Y\\big(X(Z)\\big) = Y\\big(X\\big)$。\n\n根据 $\\big(X(1),X(0)\\big)$ 的联合取值定义主分层：\n- 总是接受者：$X(1)=1$，$X(0)=1$。\n- 从不接受者：$X(1)=0$，$X(0)=0$。\n- 依从者：$X(1)=1$，$X(0)=0$。\n- 违逆者：$X(1)=0$，$X(0)=1$。\n\n根据单调性，$X(1) \\geq X(0)$ 对所有单位成立，这排除了违逆者的存在。设 $\\mathcal{A}$、$\\mathcal{N}$ 和 $\\mathcal{C}$ 分别表示总是接受者、从不接受者和依从者的集合。\n\n我们首先表达在给定 $Z=z$ 的条件下观测到的平均结局：\n$$\n\\mathbb{E}[\\,Y \\mid Z=z\\,] \\;=\\; \\mathbb{E}\\Big[\\,Y\\big(X(z)\\big) \\,\\big|\\, Z=z\\,\\Big].\n$$\n根据独立性，$Z \\perp \\big(Y(1),Y(0),X(1),X(0)\\big)$，因此以 $Z=z$ 为条件不会改变潜在结局和潜在干预的分布。因此，\n$$\n\\mathbb{E}[\\,Y \\mid Z=z\\,] \\;=\\; \\mathbb{E}\\Big[\\,Y\\big(X(z)\\big)\\,\\Big].\n$$\n将此期望按主分层分解：\n$$\n\\mathbb{E}[\\,Y \\mid Z=z\\,] \\;=\\; \\mathbb{E}\\big[\\,Y\\big(X(z)\\big)\\,\\big|\\,\\mathcal{A}\\,\\big]\\mathbb{P}(\\mathcal{A})\n\\;+\\; \\mathbb{E}\\big[\\,Y\\big(X(z)\\big)\\,\\big|\\,\\mathcal{N}\\,\\big]\\mathbb{P}(\\mathcal{N})\n\\;+\\; \\mathbb{E}\\big[\\,Y\\big(X(z)\\big)\\,\\big|\\,\\mathcal{C}\\,\\big]\\mathbb{P}(\\mathcal{C}).\n$$\n对于总是接受者，$X(1)=X(0)=1$，因此对于 $z=0$ 和 $z=1$ 都有 $X(z)=1$，故\n$$\n\\mathbb{E}\\big[\\,Y\\big(X(1)\\big)\\,\\big|\\,\\mathcal{A}\\,\\big] \\;=\\; \\mathbb{E}\\big[\\,Y(1)\\,\\big|\\,\\mathcal{A}\\,\\big], \n\\quad\n\\mathbb{E}\\big[\\,Y\\big(X(0)\\big)\\,\\big|\\,\\mathcal{A}\\,\\big] \\;=\\; \\mathbb{E}\\big[\\,Y(1)\\,\\big|\\,\\mathcal{A}\\,\\big].\n$$\n因此，在计算跨 $Z$ 水平的差异时，总是接受者的贡献被抵消了。类似地，对于从不接受者，$X(1)=X(0)=0$，因此对于 $z=0$ 和 $z=1$ 都有 $X(z)=0$，这意味着\n$$\n\\mathbb{E}\\big[\\,Y\\big(X(1)\\big)\\,\\big|\\,\\mathcal{N}\\,\\big] \\;=\\; \\mathbb{E}\\big[\\,Y(0)\\,\\big|\\,\\mathcal{N}\\,\\big], \n\\quad\n\\mathbb{E}\\big[\\,Y\\big(X(0)\\big)\\,\\big|\\,\\mathcal{N}\\,\\big] \\;=\\; \\mathbb{E}\\big[\\,Y(0)\\,\\big|\\,\\mathcal{N}\\,\\big],\n$$\n他们的贡献在计算跨 $Z$ 水平的差异时也被抵消了。\n\n对于依从者，$X(1)=1$ 且 $X(0)=0$，因此 $X(1)-X(0)=1$。他们对结局差异的贡献是\n$$\n\\mathbb{E}\\big[\\,Y\\big(X(1)\\big)\\,\\big|\\,\\mathcal{C}\\,\\big] - \\mathbb{E}\\big[\\,Y\\big(X(0)\\big)\\,\\big|\\,\\mathcal{C}\\,\\big]\n\\;=\\; \\mathbb{E}\\big[\\,Y(1)-Y(0)\\,\\big|\\,\\mathcal{C}\\,\\big]\n\\;=\\; \\text{LATE}.\n$$\n因此，通过计算观测平均结局在不同工具变量水平上的差异，并利用期望的线性性质，我们得到\n$$\n\\mathbb{E}[\\,Y \\mid Z=1\\,] - \\mathbb{E}[\\,Y \\mid Z=0\\,]\n\\;=\\; \\mathbb{P}(\\mathcal{C}) \\cdot \\text{LATE}.\n$$\n我们现在分析不同工具变量水平上平均干预的差异：\n$$\n\\mathbb{E}[\\,X \\mid Z=z\\,] \\;=\\; \\mathbb{E}\\big[\\,X(z)\\,\\big].\n$$\n按主分层分解并使用相同的逻辑：\n- 对于 $z=0$ 和 $z=1$，总是接受者对 $\\mathbb{E}[\\,X \\mid Z=z\\,]$ 的贡献均为 $1$。\n- 对于 $z=0$ 和 $z=1$，从不接受者的贡献均为 $0$。\n- 当 $z=1$ 时，依从者的贡献为 $1$；当 $z=0$ 时，贡献为 $0$。\n\n因此，\n$$\n\\mathbb{E}[\\,X \\mid Z=1\\,] - \\mathbb{E}[\\,X \\mid Z=0\\,] \\;=\\; \\mathbb{P}(\\mathcal{C}).\n$$\n结合这两个恒等式，并利用工具变量相关性假设 $\\mathbb{P}(\\mathcal{C})0$，我们可以解出 $\\text{LATE}$ 为\n$$\n\\text{LATE} \\;=\\; \\frac{\\mathbb{E}[\\,Y \\mid Z=1\\,] - \\mathbb{E}[\\,Y \\mid Z=0\\,]}{\\mathbb{E}[\\,X \\mid Z=1\\,] - \\mathbb{E}[\\,X \\mid Z=0\\,]}.\n$$\n\n在该流行病学鼓励性设计中各项的解释：\n- 分子 $\\mathbb{E}[\\,Y \\mid Z=1\\,] - \\mathbb{E}[\\,Y \\mid Z=0\\,]$ 是鼓励对结局的意向性治疗效应。它捕捉了随机化的鼓励如何改变平均低密度脂蛋白胆固醇水平，该效应综合了所有依从类型。\n- 分母 $\\mathbb{E}[\\,X \\mid Z=1\\,] - \\mathbb{E}[\\,X \\mid Z=0\\,]$ 是鼓励对干预接受率的意向性治疗效应，即因受到鼓励而启动药物基因组学指导的他汀类药物治疗的概率增加量。\n- 两者的比率是在依从者中启动治疗的平均因果效应，依从者是其干预状态随鼓励而改变的亚群。这就是在所述假设下被识别出的局部平均干预效应。\n\n这个表达式是一个以可观测的条件期望表示的闭式待估参数，不需要知道个体层面的依从类型。在 $Z$ 的随机化、排他性限制、单调性和 SUTVA 假设均成立，并且工具变量相关（从而分母不为零）的情况下，该表达式在这个由生物信息学驱动的流行病学研究中是有效的。", "answer": "$$\\boxed{\\frac{\\mathbb{E}[Y \\mid Z=1]-\\mathbb{E}[Y \\mid Z=0]}{\\mathbb{E}[X \\mid Z=1]-\\mathbb{E}[X \\mid Z=0]}}$$", "id": "4574225"}, {"introduction": "这是将理论付诸实践的终极练习，特别是针对现代基因流行病学中常见的两样本孟德尔随机化分析。您将构建一个完整的分析流程，处理从基因组数据中选择和处理工具变量的各种实际挑战。此练习不仅涵盖了核心的逆方差加权 (IVW) 估计方法，还包括了连锁不平衡剪枝和等位基因协调等关键的生物信息学步骤，这对于任何希望应用工具变量方法的分析师来说都是一项核心技能。[@problem_id:4574240]", "problem": "您的任务是实现一个完整的两样本孟德尔随机化流程，作为一个可运行的程序，使用工具变量分析来估计低密度脂蛋白胆固醇对冠状动脉疾病的因果效应。您的程序必须实现变异筛选、连锁不平衡聚集、等位基因协调和回文等位基因处理，然后计算因果效应的逆方差加权（IVW）估计量。该设计必须反映流行病学中标准的工具变量分析。实现必须使用所提供的合成摘要数据，并且完全确定，不得需要任何用户输入。\n\n从以下基础开始：\n- 工具变量由三个假设定义：相关性、独立性和排他性限制。在两样本孟德尔随机化中，单核苷酸多态性作为暴露的工具变量。\n- 对于每个索引为 $i$ 的工具变量，其与暴露的关联用 $\\hat{\\beta}_{X i}$ 表示，标准误为 $s_{X i}$，$p$ 值为 $p_{X i}$；其与结局的关联用 $\\hat{\\beta}_{Y i}$ 表示，标准误为 $s_{Y i}$。\n- 在对 $\\hat{\\beta}_{X i}$ 采用无测量误差近似的摘要数据两样本设置中，IVW 估计量是通过对 $\\hat{\\beta}_{Y i}$ 关于 $\\hat{\\beta}_{X i}$ 进行加权最小二乘回归得到的，截距为零，权重为 $w_i = 1 / s_{Y i}^2$。IVW 斜率估计值为\n$$\n\\hat{\\theta}_{\\mathrm{IVW}} \\;=\\; \\frac{\\sum_i w_i \\,\\hat{\\beta}_{X i}\\,\\hat{\\beta}_{Y i}}{\\sum_i w_i \\,\\hat{\\beta}_{X i}^2},\n$$\n其固定效应标准误为\n$$\n\\mathrm{se}(\\hat{\\theta}_{\\mathrm{IVW}}) \\;=\\; \\sqrt{\\frac{1}{\\sum_i w_i \\,\\hat{\\beta}_{X i}^2}},\n$$\nCochran异质性统计量为\n$$\nQ \\;=\\; \\sum_i w_i \\,\\big(\\hat{\\beta}_{Y i} - \\hat{\\theta}_{\\mathrm{IVW}} \\,\\hat{\\beta}_{X i}\\big)^2.\n$$\n您的程序必须为每个测试用例计算 $\\hat{\\theta}_{\\mathrm{IVW}}$；次要量如 $\\mathrm{se}(\\hat{\\theta}_{\\mathrm{IVW}})$ 和 $Q$ 可以在内部计算以进行验证，但要求的输出仅为 $\\hat{\\theta}_{\\mathrm{IVW}}$ 值。\n\n需实现的数据和规则：\n1) 根据与暴露的关联进行变异筛选：\n   - 仅保留 $p_{X i} \\leq p_{\\mathrm{thr}}$ 的变异。\n\n2) 连锁不平衡聚集：\n   - 筛选后，按 $p_{X i}$ 升序对变异进行排序。遍历此排序列表，一个候选变异只有在不存在任何已保留的变异位于指定物理窗口内且其配对连锁不平衡超过阈值时，才被保留。\n   - 具体来说，定义一个 $W_{\\mathrm{kb}}$ 千碱基的窗口和一个 $r^2$ 阈值 $r^2_{\\mathrm{thr}}$。对于一个新的候选变异 $j$，如果存在任何已保留的变异 $k$ 同时满足 $| \\mathrm{pos}_j - \\mathrm{pos}_k | \\leq 1000 \\times W_{\\mathrm{kb}}$ 和 $r^2_{jk} \\geq r^2_{\\mathrm{thr}}$，则丢弃 $j$；否则保留 $j$。\n   - 如果一对变异的 $r^2$ 没有明确提供，则假定 $r^2 = 0$。\n\n3) 等位基因协调：\n   - 每个变异都有暴露等位基因 $(A_{E}, A_{O})$ 和结局等位基因 $(A'_{E}, A'_{O})$。同时提供了暴露效应等位基因频率 $\\mathrm{EAF}_X$ 和结局效应等位基因频率 $\\mathrm{EAF}_Y$。\n   - 非回文等位基因：如果 $(A'_{E}, A'_{O}) = (A_{E}, A_{O})$，则保持 $\\hat{\\beta}_{Y i}$ 不变。如果 $(A'_{E}, A'_{O}) = (A_{O}, A_{E})$，则翻转 $\\hat{\\beta}_{Y i}$ 的符号。如果两种情况都不匹配，则尝试对结局等位基因进行链互补，即对两个结局等位基因应用互补映射 $\\mathcal{C}$（其中 $\\mathcal{C}(A) = T, \\mathcal{C}(T) = A, \\mathcal{C}(C) = G, \\mathcal{C}(G) = C$），然后重新检查上述两条匹配规则；如果仍然不匹配，则丢弃该变异。\n   - 回文等位基因：回文等位基因组是指 $\\{A_{E}, A_{O}\\} \\in \\big\\{ \\{A,T\\}, \\{C,G\\} \\big\\}$ 的情况。对于回文变异，不要使用字母匹配或链互补来决定方向。而是使用相对于一个模糊区间的 $\\mathrm{EAF}_X$。如果 $\\mathrm{EAF}_X \\in [L_{\\mathrm{amb}}, U_{\\mathrm{amb}}]$，其中 $L_{\\mathrm{amb}}$ 和 $U_{\\mathrm{amb}}$ 是模糊边界，则因无法解析而丢弃该变异。否则，通过比较 $|\\mathrm{EAF}_Y - \\mathrm{EAF}_X|$ 与 $| (1 - \\mathrm{EAF}_Y) - \\mathrm{EAF}_X |$ 来确定方向。如果前者较小或相等，则保持 $\\hat{\\beta}_{Y i}$ 不变；如果后者较小，则翻转 $\\hat{\\beta}_{Y i}$ 的符号。\n\n4) IVW 估计：\n   - 在聚集和协调之后，使用上述公式和权重 $w_i = 1 / s_{Y i}^2$ 计算 $\\hat{\\theta}_{\\mathrm{IVW}}$。如果只剩下一个工具变量，估计量简化为 $\\hat{\\theta}_{\\mathrm{IVW}} = \\hat{\\beta}_{Y 1} / \\hat{\\beta}_{X 1}$。\n\n合成摘要数据：\n- 单核苷酸多态性：$\\mathrm{SNP} \\in \\{\\mathrm{rs1}, \\mathrm{rs2}, \\mathrm{rs3}, \\mathrm{rs4}, \\mathrm{rs5}, \\mathrm{rs6}\\}$，全部位于1号染色体上，碱基对位置如下：\n  - $\\mathrm{rs1}$ 位于 $100{,}000$，\n  - $\\mathrm{rs2}$ 位于 $120{,}000$，\n  - $\\mathrm{rs3}$ 位于 $160{,}000$，\n  - $\\mathrm{rs4}$ 位于 $220{,}000$，\n  - $\\mathrm{rs5}$ 位于 $500{,}000$，\n  - $\\mathrm{rs6}$ 位于 $620{,}000$。\n- 暴露关联 $(\\hat{\\beta}_{X}, s_{X}, p_{X}, \\mathrm{EAF}_X, A_{E}, A_{O})$：\n  - $\\mathrm{rs1}$: $(0.08, 0.01, 1\\times 10^{-12}, 0.30, A, G)$,\n  - $\\mathrm{rs2}$: $(0.07, 0.015, 2\\times 10^{-9}, 0.55, T, A)$,\n  - $\\mathrm{rs3}$: $(0.05, 0.02, 7\\times 10^{-8}, 0.40, C, T)$,\n  - $\\mathrm{rs4}$: $(0.02, 0.02, 1\\times 10^{-6}, 0.20, G, C)$,\n  - $\\mathrm{rs5}$: $(0.06, 0.018, 3\\times 10^{-9}, 0.10, G, T)$,\n  - $\\mathrm{rs6}$: $(0.09, 0.017, 1\\times 10^{-10}, 0.49, C, G)$.\n- 结局关联 $(\\hat{\\beta}_{Y}, s_{Y}, \\mathrm{EAF}_Y, A'_{E}, A'_{O})$：\n  - $\\mathrm{rs1}$: $(0.035, 0.01, 0.31, A, G)$,\n  - $\\mathrm{rs2}$: $(-0.028, 0.012, 0.45, A, T)$,\n  - $\\mathrm{rs3}$: $(0.018, 0.012, 0.60, G, A)$,\n  - $\\mathrm{rs4}$: $(0.006, 0.015, 0.20, G, C)$,\n  - $\\mathrm{rs5}$: $(-0.030, 0.011, 0.90, T, G)$,\n  - $\\mathrm{rs6}$: $(-0.041, 0.013, 0.51, G, C)$.\n- 连锁不平衡对由物理窗口内的配对 $(r^2)$ 值给出；如果某一对未列出，则使用 $0$：\n  - $\\mathrm{rs1}$–$\\mathrm{rs2}$: $0.60$,\n  - $\\mathrm{rs2}$–$\\mathrm{rs3}$: $0.25$,\n  - $\\mathrm{rs1}$–$\\mathrm{rs3}$: $0.19$,\n  - 所有其他列出的配对: $0$.\n\n测试套件和参数化：\n您的程序必须使用上述数据集运行以下四个测试用例，并按顺序输出每个用例的IVW估计值 $\\hat{\\theta}_{\\mathrm{IVW}}$。\n\n- 测试用例 1 (理想路径)：$p_{\\mathrm{thr}} = 5\\times 10^{-8}$，$r^2_{\\mathrm{thr}} = 0.20$，$W_{\\mathrm{kb}} = 100$，$L_{\\mathrm{amb}} = 0.42$，$U_{\\mathrm{amb}} = 0.58$。完全按照上面指定的方式使用暴露和结局数据。\n\n- 测试用例 2 ($r^2$ 相等的边界情况)：$p_{\\mathrm{thr}} = 5\\times 10^{-8}$，$r^2_{\\mathrm{thr}} = 0.19$，$W_{\\mathrm{kb}} = 100$，$L_{\\mathrm{amb}} = 0.42$，$U_{\\mathrm{amb}} = 0.58$。使用相同的数据；注意，根据规则 $r^2 \\ge r^2_{\\mathrm{thr}}$，$r^2 = 0.19$ 的相等情况应触发聚集。\n\n- 测试用例 3 (使用效应等位基因频率解决回文变异)：$p_{\\mathrm{thr}} = 5\\times 10^{-8}$，$r^2_{\\mathrm{thr}} = 0.20$，$W_{\\mathrm{kb}} = 100$，$L_{\\mathrm{amb}} = 0.42$，$U_{\\mathrm{amb}} = 0.58$。仅修改回文变异 $\\mathrm{rs6}$ 的暴露 $\\mathrm{EAF}_X = 0.30$ 和结局 $\\mathrm{EAF}_Y = 0.70$；所有其他值保持原样。\n\n- 测试用例 4 (单个工具变量的边缘情况)：$p_{\\mathrm{thr}} = 1\\times 10^{-11}$，$r^2_{\\mathrm{thr}} = 0.20$，$W_{\\mathrm{kb}} = 100$，$L_{\\mathrm{amb}} = 0.42$，$U_{\\mathrm{amb}} = 0.58$。使用原始数据；此阈值确保只保留最强的工具变量。\n\n最终输出格式：\n- 您的程序必须生成单行输出，其中包含四个IVW估计值，以逗号分隔的列表形式并用方括号括起来，按测试用例1到4的顺序排列，例如 $[\\hat{\\theta}_1,\\hat{\\theta}_2,\\hat{\\theta}_3,\\hat{\\theta}_4]$。\n- 每个元素必须是浮点数。不应打印任何额外文本。", "solution": "该问题要求实现一个两样本孟德尔随机化（MR）流程，以估计暴露对结局的因果效应。该流程遵循流行病学遗传学的标准方法，包括工具变量选择、连锁不平衡（LD）聚集、等位基因协调，最后使用逆方差加权（IVW）方法进行因果效应估计。整个过程将应用于提供的合成数据集，并针对四个不同的测试用例进行。\n\n首先，我们将以结构化的方式表示所提供的基因组数据，以便于处理。每个单核苷酸多态性（SNP）都是一个对象，其属性包括标识符、染色体位置以及暴露和结局研究的汇总统计数据。这些统计数据包括效应估计值（$\\hat{\\beta}$）、标准误（$s$）、p值（$p$）、效应等位基因频率（EAF）以及效应等位基因和其它等位基因。\n\nMR流程包括四个主要的顺序步骤：\n\n**1. 根据与暴露的关联强度进行变异筛选**\n选择有效工具变量（IV）的第一步是确保它们满足*相关性假设*。该假设指出工具变量必须与暴露相关。在实践中，这是通过根据变异与暴露关联的统计显著性来筛选变异实现的。我们将只保留那些暴露p值 $p_{X i}$ 小于或等于指定阈值 $p_{\\mathrm{thr}}$ 的SNP。\n$$\n\\text{如果 } p_{X i} \\leq p_{\\mathrm{thr}} \\text{，则保留SNP } i\n$$\n\n**2. 连锁不平衡（LD）聚集**\n第二步处理*独立性假设*，该假设要求工具变量相互独立。在染色体上物理位置相近的SNP通常是相关的，这种现象称为连锁不平衡。包含相关的工具变量可能会使MR估计产生偏差。聚集是一种贪心算法，用于选择一组近似独立的SNP。该过程如下：\na) 通过p值筛选的SNP按其暴露p值 $p_{X i}$ 的升序排序。这优先考虑了与暴露有更强关联证据的SNP。\nb) 我们遍历排序后的列表，将每个SNP视为一个潜在的工具变量。第一个SNP（具有最低的 $p_{X i}$）被指定为第一个“索引SNP”并被保留。\nc) 对于每个后续的候选SNP $j$，我们检查它是否与任何已保留的索引SNP $k$ 处于LD状态。如果存在任何已保留的SNP $k$ 同时满足以下两个条件，则候选SNP $j$ 将被“聚集掉”（即丢弃）：\n   i) 物理邻近性：SNP之间的距离在指定窗口内，即 $|\\mathrm{pos}_j - \\mathrm{pos}_k| \\leq 1000 \\times W_{\\mathrm{kb}}$，其中 $W_{\\mathrm{kb}}$ 是以千碱基为单位的窗口大小。\n   ii) 相关性：平方相关系数（LD）$r^2_{jk}$ 大于或等于指定的阈值，$r^2_{jk} \\geq r^2_{\\mathrm{thr}}$。\nd) 如果一个候选SNP没有被任何已保留的SNP聚集掉，它本身就会被保留，并添加到索引SNP集合中。\n\n**3. 等位基因协调**\n两样本MR使用来自两个不同研究（一个用于暴露，一个用于结局）的汇总统计数据。关键是要确保每个SNP的效应估计值 $\\hat{\\beta}$ 在两项研究中对应的是同一个效应等位基因。协调是校准这些等位基因的过程。对于每个SNP $i$，我们有暴露等位基因 $(A_E, A_O)$ 和结局等位基因 $(A'_E, A'_O)$。\n\n- **非回文SNP**：如果一个SNP的等位基因不是A/T或C/G对（例如A/G），则它是非回文的。对于这些SNP，我们可以通过匹配等位基因字母来确定正确的方向。\n  a) 如果等位基因完全匹配，$(A'_E, A'_O) = (A_E, A_O)$，则结局效应 $\\hat{\\beta}_{Y i}$ 按原样使用。\n  b) 如果等位基因是翻转的，$(A'_E, A'_O) = (A_O, A_E)$，则结局效应的符号被反转（$\\hat{\\beta}_{Y i} \\to -\\hat{\\beta}_{Y i}$）。\n  c) 如果两者都不匹配，则可能是链模糊性问题。我们对结局等位基因应用互补映射（$\\mathcal{C}(A)=T, \\mathcal{C}(T)=A, \\mathcal{C}(C)=G, \\mathcal{C}(G)=C$）并重新尝试匹配。如果找到匹配项，则使用该效应（或其翻转值）。\n  d) 如果找不到匹配项，则丢弃该SNP。\n\n- **回文SNP**：如果一个SNP的等位基因是互补的（A/T或C/G），则它是回文的。对于这些SNP，等位基因字母匹配是模糊的。我们必须依赖等位基因频率。\n  a) 如果暴露的效应等位基因频率 $\\mathrm{EAF}_X$ 接近0.5，则很难推断正确的链。如果 $\\mathrm{EAF}_X$ 落在指定的模糊区间内，即 $L_{\\mathrm{amb}} \\leq \\mathrm{EAF}_X \\leq U_{\\mathrm{amb}}$，则该SNP因无法解析而被丢弃。\n  b) 否则，我们通过比较效应等位基因频率来推断方向。我们计算两个距离：$d_1 = |\\mathrm{EAF}_Y - \\mathrm{EAF}_X|$ 和 $d_2 = |(1-\\mathrm{EAF}_Y) - \\mathrm{EAF}_X|$。前者假设等位基因是对齐的，而后者假设它们是翻转的（因为结局研究中另一个等位基因的频率是 $1 - \\mathrm{EAF}_Y$）。如果 $d_1 \\leq d_2$，则对齐很可能是正确的。如果 $d_2  d_1$，则对齐很可能是翻转的，并且 $\\hat{\\beta}_{Y i}$ 的符号被反转。\n\n**4. 逆方差加权（IVW）估计**\n在筛选、聚集和协调之后，我们得到了一组有效且独立的工具变量。最后一步是估计因果效应 $\\theta$。IVW方法是一种荟萃分析方法，它通过按每个工具变量方差的倒数对其比率估计值（$\\hat{\\theta}_i = \\hat{\\beta}_{Y i} / \\hat{\\beta}_{X i}$）进行加权来组合它们。这等效于将结局效应对暴露效应进行加权线性回归，并将截距约束为零。权重为 $w_i = 1 / s_{Y i}^2$，其中 $s_{Y i}$ 是结局效应的标准误。\n\n因果效应的IVW估计值由下式给出：\n$$\n\\hat{\\theta}_{\\mathrm{IVW}} = \\frac{\\sum_i \\hat{\\beta}_{X i} \\hat{\\beta}_{Y i} / s_{Y i}^2}{\\sum_i \\hat{\\beta}_{X i}^2 / s_{Y i}^2} = \\frac{\\sum_i w_i \\hat{\\beta}_{X i} \\hat{\\beta}_{Y i}}{\\sum_i w_i \\hat{\\beta}_{X i}^2}\n$$\n在流程结束后只剩下一个工具变量（$i=1$）的特定边缘情况下，IVW公式简化为Wald比率估计量：\n$$\n\\hat{\\theta}_{\\mathrm{IVW}} = \\frac{\\hat{\\beta}_{Y 1}}{\\hat{\\beta}_{X 1}}\n$$\n程序将为四个指定的测试用例中的每一个执行这整个流程，每个用例都有自己的参数集，并报告最终的 $\\hat{\\theta}_{\\mathrm{IVW}}$ 估计值。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements a two-sample Mendelian Randomization pipeline and runs it on four test cases.\n    \"\"\"\n\n    # --- Data Definition ---\n    # Synthetic summary data for 6 SNPs\n    snp_database = [\n        {'id': 'rs1', 'pos': 100000, 'beta_x': 0.08, 'se_x': 0.01, 'p_x': 1e-12, 'eaf_x': 0.30, 'a_e': 'A', 'a_o': 'G', 'beta_y': 0.035, 'se_y': 0.01, 'eaf_y': 0.31, 'ap_e': 'A', 'ap_o': 'G'},\n        {'id': 'rs2', 'pos': 120000, 'beta_x': 0.07, 'se_x': 0.015, 'p_x': 2e-9, 'eaf_x': 0.55, 'a_e': 'T', 'a_o': 'A', 'beta_y': -0.028, 'se_y': 0.012, 'eaf_y': 0.45, 'ap_e': 'A', 'ap_o': 'T'},\n        {'id': 'rs3', 'pos': 160000, 'beta_x': 0.05, 'se_x': 0.02, 'p_x': 7e-8, 'eaf_x': 0.40, 'a_e': 'C', 'a_o': 'T', 'beta_y': 0.018, 'se_y': 0.012, 'eaf_y': 0.60, 'ap_e': 'G', 'ap_o': 'A'},\n        {'id': 'rs4', 'pos': 220000, 'beta_x': 0.02, 'se_x': 0.02, 'p_x': 1e-6, 'eaf_x': 0.20, 'a_e': 'G', 'a_o': 'C', 'beta_y': 0.006, 'se_y': 0.015, 'eaf_y': 0.20, 'ap_e': 'G', 'ap_o': 'C'},\n        {'id': 'rs5', 'pos': 500000, 'beta_x': 0.06, 'se_x': 0.018, 'p_x': 3e-9, 'eaf_x': 0.10, 'a_e': 'G', 'a_o': 'T', 'beta_y': -0.030, 'se_y': 0.011, 'eaf_y': 0.90, 'ap_e': 'T', 'ap_o': 'G'},\n        {'id': 'rs6', 'pos': 620000, 'beta_x': 0.09, 'se_x': 0.017, 'p_x': 1e-10, 'eaf_x': 0.49, 'a_e': 'C', 'a_o': 'G', 'beta_y': -0.041, 'se_y': 0.013, 'eaf_y': 0.51, 'ap_e': 'G', 'ap_o': 'C'},\n    ]\n    \n    # Linkage disequilibrium (LD) data\n    ld_matrix = {\n        frozenset(['rs1', 'rs2']): 0.60,\n        frozenset(['rs2', 'rs3']): 0.25,\n        frozenset(['rs1', 'rs3']): 0.19,\n    }\n\n    # Test suite parameters\n    test_cases = [\n        {'p_thr': 5e-8, 'r2_thr': 0.20, 'W_kb': 100, 'L_amb': 0.42, 'U_amb': 0.58, 'mods': {}},\n        {'p_thr': 5e-8, 'r2_thr': 0.19, 'W_kb': 100, 'L_amb': 0.42, 'U_amb': 0.58, 'mods': {}},\n        {'p_thr': 5e-8, 'r2_thr': 0.20, 'W_kb': 100, 'L_amb': 0.42, 'U_amb': 0.58, 'mods': {'rs6': {'eaf_x': 0.30, 'eaf_y': 0.70}}},\n        {'p_thr': 1e-11, 'r2_thr': 0.20, 'W_kb': 100, 'L_amb': 0.42, 'U_amb': 0.58, 'mods': {}},\n    ]\n\n    results = []\n\n    def run_pipeline(snps, ld, params):\n        p_thr, r2_thr, W_kb, L_amb, U_amb = params['p_thr'], params['r2_thr'], params['W_kb'], params['L_amb'], params['U_amb']\n        window_bp = 1000 * W_kb\n        \n        # 1. Variant Filtering by exposure p-value\n        filtered_snps = [snp for snp in snps if snp['p_x'] = p_thr]\n\n        # 2. Linkage Disequilibrium (LD) Clumping\n        filtered_snps.sort(key=lambda s: s['p_x'])\n        retained_snps = []\n        for candidate_snp in filtered_snps:\n            is_clumped = False\n            for retained_snp in retained_snps:\n                if abs(candidate_snp['pos'] - retained_snp['pos']) = window_bp:\n                    pair = frozenset([candidate_snp['id'], retained_snp['id']])\n                    r2 = ld.get(pair, 0.0)\n                    if r2 >= r2_thr:\n                        is_clumped = True\n                        break\n            if not is_clumped:\n                retained_snps.append(candidate_snp)\n\n        # 3. Allele Harmonization\n        harmonized_snps = []\n        complement = {'A': 'T', 'T': 'A', 'C': 'G', 'G': 'C'}\n        for snp in retained_snps:\n            exp_alleles = (snp['a_e'], snp['a_o'])\n            out_alleles = (snp['ap_e'], snp['ap_o'])\n            beta_y = snp['beta_y']\n            \n            is_palindromic = {snp['a_e'], snp['a_o']} in [{'A', 'T'}, {'C', 'G'}]\n            \n            if is_palindromic:\n                if L_amb = snp['eaf_x'] = U_amb:\n                    continue\n                \n                dist1 = abs(snp['eaf_y'] - snp['eaf_x'])\n                dist2 = abs((1 - snp['eaf_y']) - snp['eaf_x'])\n\n                if dist2  dist1:\n                    beta_y = -beta_y\n                \n                harmonized_snp = snp.copy()\n                harmonized_snp['beta_y'] = beta_y\n                harmonized_snps.append(harmonized_snp)\n\n            else: # Non-palindromic\n                harmonized = False\n                if out_alleles == exp_alleles:\n                    harmonized = True\n                elif out_alleles == (exp_alleles[1], exp_alleles[0]):\n                    beta_y = -beta_y\n                    harmonized = True\n                else:\n                    comp_out_alleles = (complement.get(out_alleles[0]), complement.get(out_alleles[1]))\n                    if comp_out_alleles == exp_alleles:\n                        harmonized = True\n                    elif comp_out_alleles == (exp_alleles[1], exp_alleles[0]):\n                        beta_y = -beta_y\n                        harmonized = True\n                \n                if harmonized:\n                    harmonized_snp = snp.copy()\n                    harmonized_snp['beta_y'] = beta_y\n                    harmonized_snps.append(harmonized_snp)\n\n        # 4. IVW Estimation\n        if not harmonized_snps:\n            return np.nan\n        \n        if len(harmonized_snps) == 1:\n            snp = harmonized_snps[0]\n            if snp['beta_x'] == 0: return np.nan\n            return snp['beta_y'] / snp['beta_x']\n\n        numerator = 0.0\n        denominator = 0.0\n        for snp in harmonized_snps:\n            w = 1.0 / (snp['se_y'] ** 2)\n            numerator += w * snp['beta_x'] * snp['beta_y']\n            denominator += w * (snp['beta_x'] ** 2)\n        \n        if denominator == 0: return np.nan\n        return numerator / denominator\n\n    # --- Main Loop ---\n    for case_params in test_cases:\n        current_data = [dict(snp) for snp in snp_database]\n        \n        for snp_id, modifications in case_params['mods'].items():\n            for snp in current_data:\n                if snp['id'] == snp_id:\n                    snp.update(modifications)\n                    break\n        \n        result = run_pipeline(current_data, ld_matrix, case_params)\n        results.append(result)\n\n    print(f\"[{results[0]},{results[1]},{results[2]},{results[3]}]\")\n\nsolve()\n```", "id": "4574240"}]}