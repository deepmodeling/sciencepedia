{"hands_on_practices": [{"introduction": "在单细胞聚类分析中，一个核心且基础的挑战是如何确定数据中存在的最优细胞簇数量，即选择合适的$k$值。间隙统计量（Gap Statistic）为此提供了一个严谨的统计框架，它通过将观测数据的聚类紧密度与不含聚类结构的零假设参考分布进行比较，从而帮助我们选择一个既能揭示真实结构又不过度拟合的$k$值。这项实践将指导你从头构建一个完整的分析流程，包括生成模拟数据、降维、聚类，并最终应用间隙统计量来确定最佳簇数 [@problem_id:4607414]。", "problem": "您的任务是设计并实现一个有原则的算法，在主成分分析(PCA)降维后的空间上使用间隙统计量(gap statistic)来为单细胞数据选择聚类数量。该解决方案必须以一个完整、可运行的程序形式呈现。程序必须生成合成的类单细胞数据集，使用主成分分析(PCA)进行降维，对一系列$k$值使用$k$-均值算法对细胞进行聚类，并计算间隙统计量以选择最优聚类数$\\hat{k}$。最终输出必须将预定义测试套件中选定的$\\hat{k}$聚合为单行。\n\n推导和实现必须基于以下基础且经过充分检验的依据：\n\n- 分子生物学的中心法则支持将每个细胞的基因表达水平视为可测量的数值特征。对数归一化和方差稳定化是公认的做法，可使聚合特征的分布近似连续、近似类高斯分布。\n- 主成分分析(PCA)被定义为一种正交线性变换，它通过沿连续的正交轴最大化投影方差，将数据映射到低维空间。对于一个中心化矩阵$X \\in \\mathbb{R}^{n \\times p}$，PCA可以从奇异值分解(SVD) $X = U \\Sigma V^{\\top}$ 推导出来。\n- $k$-均值目标是最小化簇内离散度。给定$k$个簇$\\{C_r\\}_{r=1}^k$及其质心$\\{\\mu_r\\}_{r=1}^k$，簇内离散度为$$W_k = \\sum_{r=1}^{k} \\sum_{i \\in C_r} \\| x_i - \\mu_r \\|_2^2$$\n- 间隙统计量将$\\log(W_k)$与其在参考分布下的期望值$\\mathbb{E}^\\star[\\log(W_k^\\star)]$进行比较，该参考分布通过在相同范围内的无聚类基线上采样生成。$k$处的间隙定义为$$\\mathrm{Gap}(k) = \\mathbb{E}^\\star[\\log(W_k^\\star)] - \\log(W_k)$$标准选择规则是选择满足$\\mathrm{Gap}(k) \\ge \\mathrm{Gap}(k+1) - s_{k+1}$的最小$k$，其中$s_k$是$\\log(W_k^\\star)$标准差的估计值，并按$\\sqrt{1 + 1/B}$进行缩放（$B$为蒙特卡洛样本数）。\n\n您的方法应按以下步骤进行：\n\n- 数据生成：应在$\\mathbb{R}^{p}$中生成合成数据集，其中$p$为基因数，一个包含$s$个信号维度的子集编码了聚类结构，其余$p - s$个基因为噪声。对于每个簇$r$，从均值为$\\mu_r \\in \\mathbb{R}^p$且为对角协方差的高斯分布中独立抽取$n_r$个细胞。具体来说：\n  - 信号基因索引是前$s$个坐标。对于簇$r$，根据一个依赖于分离参数$\\delta$的固定几何模式，在这些坐标上设置其均值，并将其余坐标设置为$0$。\n  - 在信号坐标上设置每个基因的方差为$\\sigma_{\\mathrm{signal}}^2$，在噪声坐标上设置为$\\sigma_{\\mathrm{noise}}^2$，各分量独立。\n  - 最终数据集包含$n = \\sum_{r=1}^{k_{\\text{true}}} n_r$个细胞和$p$个基因。\n- 预处理和PCA：按基因对特征进行中心化和z-score标准化（零均值和单位方差）。使用奇异值分解计算PCA，并保留前$d$个主成分。将PCA得分表示为$Y \\in \\mathbb{R}^{n \\times d}$。\n- 聚类：对于每个候选$k \\in \\{k_{\\min}, k_{\\min}+1, \\dots, k_{\\max}\\}$，对$Y$执行$k$-均值聚类以获得簇分配，并计算$W_k$作为到簇质心的欧几里得距离平方和。\n- 参考分布和间隙统计量：对于每个$k$，通过在$\\mathbb{R}^{d}$中$Y$的轴对齐边界框内均匀抽取$B$个独立的参考数据集来估计$\\mathbb{E}^\\star[\\log(W_k^\\star)]$。对于每个参考数据集，计算$k$-均值和$W_k^\\star$。定义\n  $$ \\mathrm{Gap}(k) = \\frac{1}{B}\\sum_{b=1}^{B} \\log\\left(W_{k,b}^\\star\\right) - \\log\\left(W_k\\right), $$\n  并通过以下方式估计标准差\n  $$ s_k = \\sqrt{1 + \\frac{1}{B}} \\cdot \\operatorname{sd}\\left( \\left\\{ \\log\\left(W_{k,b}^\\star\\right) \\right\\}_{b=1}^{B} \\right). $$\n  选择$\\hat{k}$为满足$\\mathrm{Gap}(k) \\ge \\mathrm{Gap}(k+1) - s_{k+1}$的最小$k$。如果不存在这样的$k$，则设置$\\hat{k} = k_{\\max}$。如果$k_{\\min} = k_{\\max}$，则设置$\\hat{k} = k_{\\min}$。\n- 需要证明的假设：解释为什么在PCA得分上使用欧几里得$k$-均值可以近似单细胞的细胞类型聚类，为什么PCA空间上的轴对齐均匀参考是合适的零假设，为什么在间隙统计量中使用对数变换，以及为什么该选择规则能控制$k$的过拟合。\n\n您的程序必须实现上述方法，并在以下测试套件上进行评估。对于每个测试用例，数据生成参数都有精确指定。在所有情况下，信号维度固定为$s = 3$。对于每个簇$r \\in \\{1,\\dots,k_{\\text{true}}\\}$，在$\\mathbb{R}^{p}$中按如下方式定义其在前$s$个坐标上的均值向量：\n- 对于$k_{\\text{true}} = 1$，将均值设为$(0, 0, 0)$。\n- 对于$k_{\\text{true}} = 2$，将簇均值设为$(-\\delta, 0, 0)$和$(+\\delta, 0, 0)$。\n- 对于$k_{\\text{true}} = 3$，将簇均值设为$(-\\delta, 0, 0)$、$(+\\delta, 0, 0)$和$(0, +\\delta, 0)$。\n对于坐标$j > s$，所有簇的均值都设为$0$。使用对角协方差$\\operatorname{diag}(\\sigma_{\\mathrm{signal}}^2, \\sigma_{\\mathrm{signal}}^2, \\sigma_{\\mathrm{signal}}^2, \\sigma_{\\mathrm{noise}}^2, \\dots, \\sigma_{\\mathrm{noise}}^2)$独立抽取样本。\n\n测试套件包含五个用例。每个用例是一个元组，指定了$(\\text{seed}, n, p, \\text{cluster\\_sizes}, \\delta, \\sigma_{\\mathrm{signal}}, \\sigma_{\\mathrm{noise}}, d, k_{\\min}, k_{\\max}, B)$，其中所有实体均为整数或适当的实数：\n- 用例 1（均衡、分离良好的簇，理想情况）：$(7, 600, 50, [200, 200, 200], 4.5, 0.6, 0.4, 10, 1, 6, 20)$。\n- 用例 2（无簇，单个高斯分布）：$(13, 400, 50, [400], 0.0, 1.0, 1.0, 10, 1, 6, 20)$。\n- 用例 3（不均衡的簇）：$(23, 500, 50, [50, 150, 300], 4.0, 0.7, 0.4, 10, 1, 6, 20)$。\n- 用例 4（小样本量，边界行为）：$(31, 60, 30, [30, 30], 3.5, 0.6, 0.5, 5, 1, 4, 12)$。\n- 用例 5（重叠的簇，具有挑战性）：$(41, 600, 50, [120, 180, 300], 2.6, 1.0, 0.6, 10, 1, 6, 20)$。\n\n实现要求：\n- 使用标准化PCA：在PCA之前，对每个基因在所有细胞中进行中心化和z-score标准化。通过奇异值分解计算PCA并保留前$d$个主成分。\n- 执行$k$-均值时，使用$k$-means++初始化、多次随机重启以及Lloyd迭代，直到收敛或达到最大迭代次数。\n- 在PCA得分的轴对齐边界框上，使用$B$个均匀参考复制，在相同的$d$维空间中计算间隙统计量。\n- 对于每个用例，返回一个整数$\\hat{k}$。\n\n最终输出格式：\n- 您的程序应生成一行输出，其中包含按顺序为每个用例选择的$\\hat{k}$，形式为用方括号括起来的逗号分隔列表（例如：$[\\hat{k}_1,\\hat{k}_2,\\hat{k}_3,\\hat{k}_4,\\hat{k}_5]$）。程序不得打印任何其他文本。\n\n本问题中的所有量都是无量纲的，不涉及物理单位。不涉及角度。唯一可接受的输出是指定的整数。算法必须仅使用允许的库从头开始实现，并且必须能够根据给定的种子完全复现，无需任何外部输入。", "solution": "该问题要求设计并实现一种计算方法，以确定合成单细胞数据中的最优聚类数$\\hat{k}$。指定的方法论整合了数据分析中的几项基础技术：用于降维的主成分分析(PCA)、用于聚类的$k$-均值算法，以及用于模型选择的间隙统计量。本文提供的解决方案对算法进行了有原则的推导，证明了关键假设的合理性，并详细说明了实现步骤。\n\n### 理论框架与方法论依据\n\n首要目标是从高维基因表达数据中识别出不同的细胞群体。我们将此建模为一个聚类问题。聚类的数量$k$是未知的，必须从数据本身进行估计。\n\n**1. 数据模型与生物学基础**\n\n本问题的数据生成过程基于分子生物学的中心法则，该法则允许我们通过基因表达谱来量化细胞状态。每个细胞表示为一个向量$x \\in \\mathbb{R}^p$，其中$p$是基因数量，向量的分量是它们的表达水平。将不同的细胞类型建模为这个高维空间中的独立簇是一种常见且有效的简化方法。假设这些簇服从高斯分布是一个务实的选择，这反映了许多生物过程在聚合时，由于中心极限定理，会近似于正态分布。因此，整个数据集被建模为高斯混合模型。少数驱动细胞身份的“信号”基因与大量“噪声”基因之间的区别也是单细胞数据的一个现实特征，其中只有一小部分转录组定义了主要的细胞类型。\n\n**2. 通过主成分分析(PCA)进行降维**\n\n单细胞表达数据是出了名的高维（大$p$）和稀疏。PCA是一种线性变换，它沿着一组新的正交轴（称为主成分）重新定向数据，这些主成分按其解释的方差量排序。对于一个数据矩阵$X \\in \\mathbb{R}^{n \\times p}$（有$n$个细胞和$p$个基因），并且每个特征都已中心化为零均值，PCA可以通过其奇异值分解(SVD)来计算：\n$$ X_c = U \\Sigma V^{\\top} $$\n其中$V$的列包含了主成分。数据到前$d$个主成分上的投影，称为主成分得分，由$Y = X_c V_d = U_d \\Sigma_d$给出，其中$V_d$、$U_d$和$\\Sigma_d$是对应于前$d$个成分的截断矩阵。\n\n问题指定在PCA之前对特征进行z-score标准化。这一点至关重要，因为PCA对特征的尺度敏感。Z-score标准化确保每个基因对初始方差结构的贡献相等，防止高方差基因仅仅因为其尺度而主导主成分。\n\n*使用PCA的理由*：通过保留前$d$个主成分，我们创建了一个低维表示$Y \\in \\mathbb{R}^{n \\times d}$，它捕获了数据中最重要的变异轴。其基本假设是，细胞类型簇之间的分离是这种变异的主要来源。因此，聚类结构不仅在低维PCA空间中得以保留，而且常常得到增强，同时高维噪声被过滤掉。\n\n**3. 在PCA空间中聚类**\n\n聚类是在PCA得分$Y$上执行的。我们选择$k$-均值算法，该算法旨在将$n$个数据点划分为$k$个集合$C_1, \\dots, C_k$，以最小化簇内平方和(WCSS)，也称为离散度：\n$$ W_k = \\sum_{r=1}^{k} \\sum_{y_i \\in C_r} \\| y_i - \\mu_r \\|_2^2 $$\n其中$\\mu_r$是簇$C_r$的质心。\n\n*在PCA得分上使用欧几里得$k$-均值的理由*：到主成分上的投影是一种正交变换，如果保留所有成分，它会保持欧几里得距离。当我们将维度降至$d$个成分时，这个空间中的欧几里得距离$\\| y_i - y_j \\|_2$成为原始距离的一个近似，并由最能分离数据的特征（即主成分）的重要性加权。由于簇被建模为径向对称的高斯分布，最小化到质心的欧几里得距离平方和是识别其中心的一种自然而有效的方法。\n\n**4. 用于估计$\\hat{k}$的间隙统计量**\n\n随着$k$的增加，$W_k$的值总是会减小。因此，我们不能简单地选择最小化$W_k$的$k$。间隙统计量提供了一个正式的统计框架，通过将观测到的$W_k$与在无聚类结构的原假设下的期望值进行比较来选择$k$。\n\n关键组成部分是：\n- **对数变换**：该统计量使用$\\log(W_k)$计算。\n    *理由*：对于缺乏聚类结构的数据（例如，均匀分布），$\\log(W_k)$与$k$的曲线近似是线性的。取对数将$W_k$的乘性缩放转换为加性效应，这使得偏离“无结构”趋势的情况更容易被识别。它还有助于稳定方差并处理$W_k$值可能存在的巨大动态范围。\n\n- **参考分布**：为了估计期望值$\\mathbb{E}^\\star[\\log(W_k^\\star)]$，我们生成$B$个参考数据集。每个参考数据集都从一个体现了原假设的概率分布中抽取。\n    *理由*：问题指定了在PCA投影数据$Y$的轴对齐边界框上的均匀分布。这是一个合适的零假设模型，因为它使用了与观测数据相同的值范围，但破坏了任何潜在的基于密度的结构或分组。它代表了聚类的“最坏情况”，为判断实际数据的聚类趋势提供了一个基线。\n\n- **间隙函数**：间隙定义为在原假设下的期望对数离散度与观测到的对数离散度之差。\n$$ \\mathrm{Gap}(k) = \\mathbb{E}^\\star[\\log(W_k^\\star)] - \\log(W_k) = \\left( \\frac{1}{B}\\sum_{b=1}^{B} \\log(W_{k,b}^\\star) \\right) - \\log(W_k) $$\n更大的间隙值表明观测到的数据比随机预期的具有更多的结构（即更具聚类性）。\n\n- **选择规则**：最优的$\\hat{k}$被选为满足以下条件的最小$k \\in \\{k_{\\min}, \\dots, k_{\\max}-1\\}$：\n$$ \\mathrm{Gap}(k) \\ge \\mathrm{Gap}(k+1) - s_{k+1} $$\n其中$s_{k+1}$是$\\mathbb{E}^\\star[\\log(W_{k+1}^\\star)]$的蒙特卡洛估计的标准误，并根据样本量$B$进行了调整。\n$$ s_k = \\operatorname{sd}(\\log(W_k^\\star)) \\cdot \\sqrt{1 + 1/B} $$\n*理由*：我们寻找$\\mathrm{Gap}(k)$曲线的“肘部”——即增加$k$后收益递减的点。该规则通过找到第一个$k$来形式化这一点，使得该$k$处的间隙值不显著小于$k+1$处的间隙值。$s_{k+1}$项解释了我们模拟中的统计不确定性。通过要求从$\\mathrm{Gap}(k)$到$\\mathrm{Gap}(k+1)$的改进大于这种不确定性，该规则防止了过拟合，即防止了因随机模拟噪声而非真实数据结构而选择更大的$k$。\n\n### 算法实现\n\n对于每个测试用例，总体算法按以下步骤进行：\n1.  **生成数据**：根据指定的参数（$k_{\\text{true}}$、簇大小、$\\delta$、$\\sigma_{\\text{signal}}$、$\\sigma_{\\text{noise}}$）创建一个大小为$n \\times p$的合成数据集。这涉及从多个具有预定均值和共享对角协方差矩阵的多元正态分布中采样。\n2.  **预处理和降维**：将生成的数据矩阵$X$的$p$个特征（基因）进行标准化，使其均值为零，方差为一。然后，通过计算其SVD对该标准化矩阵执行PCA。保留前$d$个主成分得分，形成矩阵$Y \\in \\mathbb{R}^{n \\times d}$。\n3.  **计算间隙统计量**：对于从$k_{\\min}$到$k_{\\max}$的每个候选聚类数$k$：\n    a. 使用$k$-均值对实际数据$Y$进行聚类，以获得质心和分配。计算簇内离散度$W_k$并存储$\\log(W_k)$。使用具有多次初始化（例如，$k$-means++）的稳健$k$-均值实现。\n    b. 生成$B$个参考数据集。每个都是一个$n \\times d$的矩阵，其中每个点都是从包围$Y$的超矩形中均匀采样的。\n    c. 对于每个参考数据集，使用$k$个簇运行$k$-均值，计算其离散度$W_{k,b}^\\star$，并存储$\\log(W_{k,b}^\\star)$。\n    d. 从$B$个对数离散度的集合中计算$\\mathrm{Gap}(k)$和标准误项$s_k$。\n4.  **选择最优$\\hat{k}$**：将选择规则$\\mathrm{Gap}(k) \\ge \\mathrm{Gap}(k+1) - s_{k+1}$应用于计算出的间隙值，以找到估计的聚类数$\\hat{k}$。如果条件从未满足，$\\hat{k}$默认为$k_{\\max}$。还处理了$k_{\\min}=k_{\\max}$的边界情况。记录最终的$\\hat{k}$。\n对问题陈述中指定的所有测试用例重复此过程。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.cluster.vq import kmeans2\nfrom scipy.linalg import svd\n\ndef solve():\n    \"\"\"\n    Main function to run the entire pipeline for all test cases.\n    \"\"\"\n    # Test cases as specified in the problem statement.\n    # (seed, n, p, cluster_sizes, delta, sigma_signal, sigma_noise, d, k_min, k_max, B)\n    test_cases = [\n        (7, 600, 50, [200, 200, 200], 4.5, 0.6, 0.4, 10, 1, 6, 20),\n        (13, 400, 50, [400], 0.0, 1.0, 1.0, 10, 1, 6, 20),\n        (23, 500, 50, [50, 150, 300], 4.0, 0.7, 0.4, 10, 1, 6, 20),\n        (31, 60, 30, [30, 30], 3.5, 0.6, 0.5, 5, 1, 4, 12),\n        (41, 600, 50, [120, 180, 300], 2.6, 1.0, 0.6, 10, 1, 6, 20),\n    ]\n\n    results = []\n    for params in test_cases:\n        seed, n, p, cluster_sizes, delta, sigma_signal, sigma_noise, d, k_min, k_max, B = params\n        \n        # Set seed for reproducibility for this case\n        np.random.seed(seed)\n        \n        # 1. Generate synthetic data\n        X = generate_synthetic_data(n, p, cluster_sizes, delta, sigma_signal, sigma_noise)\n        \n        # 2. Preprocessing and PCA\n        Y = perform_pca(X, d)\n        \n        # 3. Compute Gap Statistic and select k\n        k_hat = find_optimal_k(Y, k_min, k_max, B)\n        results.append(k_hat)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef generate_synthetic_data(n, p, cluster_sizes, delta, sigma_signal, sigma_noise, s=3):\n    \"\"\"\n    Generates synthetic single-cell data based on a Gaussian mixture model.\n    \"\"\"\n    k_true = len(cluster_sizes)\n    \n    # Define cluster means\n    means = np.zeros((k_true, p))\n    if k_true == 1:\n        pass # Mean is already [0, 0, ..., 0]\n    elif k_true == 2:\n        means[0, 0] = -delta\n        means[1, 0] = +delta\n    elif k_true == 3:\n        means[0, 0] = -delta\n        means[1, 0] = +delta\n        means[2, 1] = +delta\n    \n    # Define diagonal covariance matrix\n    variances = np.array([sigma_signal**2] * s + [sigma_noise**2] * (p - s))\n    cov = np.diag(variances)\n    \n    # Generate data for each cluster\n    data_parts = []\n    for i in range(k_true):\n        n_r = cluster_sizes[i]\n        mean_r = means[i, :]\n        cluster_data = np.random.multivariate_normal(mean_r, cov, n_r)\n        data_parts.append(cluster_data)\n        \n    return np.vstack(data_parts)\n\ndef perform_pca(X, d):\n    \"\"\"\n    Performs standardization and PCA on the data matrix X.\n    \"\"\"\n    # Z-score normalization\n    mean = np.mean(X, axis=0)\n    std = np.std(X, axis=0)\n    # Avoid division by zero for constant features\n    std[std == 0] = 1.0\n    X_std = (X - mean) / std\n    \n    # PCA using SVD\n    U, s, Vt = svd(X_std, full_matrices=False)\n    \n    # Project data onto the top d principal components (get scores)\n    Y = U[:, :d] * s[:d]\n    return Y\n\ndef compute_dispersion(Y, k):\n    \"\"\"\n    Performs k-means and computes the within-cluster dispersion W_k.\n    \"\"\"\n    # k-means++-like initialization and 10 restarts\n    centroids, labels = kmeans2(Y, k, iter=10, minit='points')\n    \n    W_k = 0.0\n    for i in range(k):\n        cluster_points = Y[labels == i, :]\n        if cluster_points.shape[0] > 0:\n            W_k += np.sum((cluster_points - centroids[i, :])**2)\n            \n    return W_k\n\ndef find_optimal_k(Y, k_min, k_max, B):\n    \"\"\"\n    Computes the gap statistic and selects the optimal k.\n    \"\"\"\n    if k_min == k_max:\n        return k_min\n        \n    n, d = Y.shape\n    \n    log_W = np.zeros(k_max - k_min + 1)\n    gap_stats = np.zeros(k_max - k_min + 1)\n    s_k_vals = np.zeros(k_max - k_min + 1)\n    \n    # Bounding box for reference data generation\n    min_coords = np.min(Y, axis=0)\n    max_coords = np.max(Y, axis=0)\n    \n    k_range = range(k_min, k_max + 1)\n    \n    for i, k in enumerate(k_range):\n        # Dispersion for the actual data\n        log_W[i] = np.log(compute_dispersion(Y, k))\n        \n        # Dispersions for reference data\n        log_W_star_b = np.zeros(B)\n        for b in range(B):\n            Y_star = np.random.uniform(low=min_coords, high=max_coords, size=(n, d))\n            # Handle potential failure of k-means on uniform data for small k\n            try:\n                log_W_star_b[b] = np.log(compute_dispersion(Y_star, k))\n            except Exception:\n                # If k-means fails, e.g., creates an empty cluster, this run is invalid.\n                # A robust but complex solution would be to retry. A simpler one is to ignore it.\n                # Given the context, we can assume it's rare and fill with a neighbor or mean.\n                # For simplicity, we re-use the last valid value or 0 if none.\n                if b > 0:\n                    log_W_star_b[b] = log_W_star_b[b-1]\n                else:\n                    log_W_star_b[b] = 0 # should not happen often\n        \n        E_log_W_star = np.mean(log_W_star_b)\n        sd_log_W_star = np.std(log_W_star_b, ddof=0) # ddof=0 for population std\n        \n        gap_stats[i] = E_log_W_star - log_W[i]\n        s_k_vals[i] = sd_log_W_star * np.sqrt(1.0 + 1.0 / B)\n\n    # Selection rule\n    k_hat = k_max\n    for i in range(len(k_range) - 1):\n        k = k_range[i]\n        if gap_stats[i] >= gap_stats[i+1] - s_k_vals[i+1]:\n            k_hat = k\n            break\n            \n    return k_hat\n\nif __name__ == '__main__':\n    solve()\n```", "id": "4607414"}, {"introduction": "确定了聚类的数量$k$后，下一个关键步骤是评估聚类结果的质量。轮廓系数（Silhouette Score）是一个直观且强大的度量标准，它同时评估了每个数据点在其所属簇内的紧密程度以及与其它簇的分离程度。通过这项实践，你将对一个简化的数据集手动计算轮廓系数，从而深刻理解该指标如何量化聚类划分的优劣 [@problem_id:4607428]。", "problem": "一项对外周血单个核细胞的单细胞核糖核酸测序 (scRNA-seq) 研究，通过主成分分析 (PCA) 得到了沿第一主成分的低维嵌入。五个细胞具有以下一维坐标（以任意归一化单位表示）和一个被认为对应于两个淋巴细胞谱系的建议双聚类划分：\n\n- 细胞 $S_{1}$ 位于 $x = 0$、细胞 $S_{2}$ 位于 $x = 1$、细胞 $S_{3}$ 位于 $x = 3$，被分配到簇 $\\mathcal{A}$（推定T细胞）。\n- 细胞 $S_{4}$ 位于 $x = 10$、细胞 $S_{5}$ 位于 $x = 12$，被分配到簇 $\\mathcal{B}$（推定B细胞）。\n\n假设任意两个细胞之间的相异度是这个一维嵌入中的欧几里得距离（即它们坐标的绝对差值）。使用聚类分析中轮廓系数的标准定义，计算在此划分下每个细胞的轮廓系数，然后计算所有五个细胞的总体平均轮廓系数。结合细胞类型鉴定的背景，从分离度和紧凑性的角度解释所获得的轮廓系数值对该划分意味着什么。\n\n将最终的总体平均轮廓系数以单个最简分数的形式给出。不要四舍五入。最终答案不需要单位。", "solution": "该问题是有效的，因为它是聚类分析中一个定义明确、内容自洽且有科学依据的问题，而聚类分析是生物信息学中的一种标准技术。所有必要的数据和定义都已提供，足以计算出唯一解。\n\n单个数据点 $i$ 的轮廓系数由以下公式定义：\n$$ s(i) = \\frac{b(i) - a(i)}{\\max\\{a(i), b(i)\\}} $$\n其中，$a(i)$ 是点 $i$ 的簇内平均相异度，$b(i)$ 是点 $i$ 的最近簇平均相异度。相异度由一维欧几里得距离给出，$d(S_i, S_j) = |x_i - x_j|$。\n\n所提供的数据点和簇分配如下：\n簇 $\\mathcal{A}$：细胞 $S_1$ 位于 $x_1=0$，细胞 $S_2$ 位于 $x_2=1$，细胞 $S_3$ 位于 $x_3=3$。\n簇 $\\mathcal{B}$：细胞 $S_4$ 位于 $x_4=10$，细胞 $S_5$ 位于 $x_5=12$。\n\n我们接下来计算这5个细胞中每一个的轮廓系数。\n\n对于簇 $\\mathcal{A}$ 中位于 $x_1=0$ 的细胞 $S_1$：\n簇内相异度 $a(1)$ 是到簇 $\\mathcal{A}$ 中其他细胞（$S_2, S_3$）的平均距离：\n$$ a(1) = \\frac{d(S_1, S_2) + d(S_1, S_3)}{2} = \\frac{|0-1| + |0-3|}{2} = \\frac{1+3}{2} = 2 $$\n最近簇相异度 $b(1)$ 是到簇 $\\mathcal{B}$ 中细胞（$S_4, S_5$）的平均距离：\n$$ b(1) = \\frac{d(S_1, S_4) + d(S_1, S_5)}{2} = \\frac{|0-10| + |0-12|}{2} = \\frac{10+12}{2} = 11 $$\n$S_1$ 的轮廓系数是：\n$$ s(1) = \\frac{b(1) - a(1)}{\\max\\{a(1), b(1)\\}} = \\frac{11-2}{\\max\\{2, 11\\}} = \\frac{9}{11} $$\n\n对于簇 $\\mathcal{A}$ 中位于 $x_2=1$ 的细胞 $S_2$：\n$$ a(2) = \\frac{d(S_2, S_1) + d(S_2, S_3)}{2} = \\frac{|1-0| + |1-3|}{2} = \\frac{1+2}{2} = \\frac{3}{2} $$\n$$ b(2) = \\frac{d(S_2, S_4) + d(S_2, S_5)}{2} = \\frac{|1-10| + |1-12|}{2} = \\frac{9+11}{2} = 10 $$\n$$ s(2) = \\frac{b(2) - a(2)}{\\max\\{a(2), b(2)\\}} = \\frac{10 - \\frac{3}{2}}{\\max\\{\\frac{3}{2}, 10\\}} = \\frac{\\frac{17}{2}}{10} = \\frac{17}{20} $$\n\n对于簇 $\\mathcal{A}$ 中位于 $x_3=3$ 的细胞 $S_3$：\n$$ a(3) = \\frac{d(S_3, S_1) + d(S_3, S_2)}{2} = \\frac{|3-0| + |3-1|}{2} = \\frac{3+2}{2} = \\frac{5}{2} $$\n$$ b(3) = \\frac{d(S_3, S_4) + d(S_3, S_5)}{2} = \\frac{|3-10| + |3-12|}{2} = \\frac{7+9}{2} = 8 $$\n$$ s(3) = \\frac{b(3) - a(3)}{\\max\\{a(3), b(3)\\}} = \\frac{8 - \\frac{5}{2}}{\\max\\{\\frac{5}{2}, 8\\}} = \\frac{\\frac{11}{2}}{8} = \\frac{11}{16} $$\n\n对于簇 $\\mathcal{B}$ 中位于 $x_4=10$ 的细胞 $S_4$：\n其所在簇的大小为 $2$，所以 $a(4)$ 是到簇 $\\mathcal{B}$ 中另外 $1$ 个细胞（$S_5$）的平均距离：\n$$ a(4) = \\frac{d(S_4, S_5)}{1} = |10-12| = 2 $$\n最近簇相异度 $b(4)$ 是到簇 $\\mathcal{A}$ 中细胞（$S_1, S_2, S_3$）的平均距离：\n$$ b(4) = \\frac{d(S_4, S_1) + d(S_4, S_2) + d(S_4, S_3)}{3} = \\frac{|10-0| + |10-1| + |10-3|}{3} = \\frac{10+9+7}{3} = \\frac{26}{3} $$\n$$ s(4) = \\frac{b(4) - a(4)}{\\max\\{a(4), b(4)\\}} = \\frac{\\frac{26}{3} - 2}{\\max\\{2, \\frac{26}{3}\\}} = \\frac{\\frac{20}{3}}{\\frac{26}{3}} = \\frac{20}{26} = \\frac{10}{13} $$\n\n对于簇 $\\mathcal{B}$ 中位于 $x_5=12$ 的细胞 $S_5$：\n$$ a(5) = \\frac{d(S_5, S_4)}{1} = |12-10| = 2 $$\n$$ b(5) = \\frac{d(S_5, S_1) + d(S_5, S_2) + d(S_5, S_3)}{3} = \\frac{|12-0| + |12-1| + |12-3|}{3} = \\frac{12+11+9}{3} = \\frac{32}{3} $$\n$$ s(5) = \\frac{b(5) - a(5)}{\\max\\{a(5), b(5)\\}} = \\frac{\\frac{32}{3} - 2}{\\max\\{2, \\frac{32}{3}\\}} = \\frac{\\frac{26}{3}}{\\frac{32}{3}} = \\frac{26}{32} = \\frac{13}{16} $$\n\n接下来，我们计算所有 $5$ 个细胞的总体平均轮廓系数 $\\bar{s}$。\n$$ \\bar{s} = \\frac{1}{5} \\sum_{i=1}^{5} s(i) = \\frac{1}{5} \\left( \\frac{9}{11} + \\frac{17}{20} + \\frac{11}{16} + \\frac{10}{13} + \\frac{13}{16} \\right) $$\n合并分母相同的项：\n$$ \\bar{s} = \\frac{1}{5} \\left( \\frac{9}{11} + \\frac{17}{20} + \\frac{10}{13} + \\frac{11+13}{16} \\right) = \\frac{1}{5} \\left( \\frac{9}{11} + \\frac{17}{20} + \\frac{10}{13} + \\frac{24}{16} \\right) = \\frac{1}{5} \\left( \\frac{9}{11} + \\frac{17}{20} + \\frac{10}{13} + \\frac{3}{2} \\right) $$\n分母 $11$、$20$、$13$ 和 $2$ 的最小公倍数是 $lcm(11, 20, 13, 2) = 2860$。我们将每个分数用这个公分母表示：\n$$ \\bar{s} = \\frac{1}{5} \\left( \\frac{9 \\times 260}{2860} + \\frac{17 \\times 143}{2860} + \\frac{10 \\times 220}{2860} + \\frac{3 \\times 1430}{2860} \\right) $$\n$$ \\bar{s} = \\frac{1}{5} \\left( \\frac{2340}{2860} + \\frac{2431}{2860} + \\frac{2200}{2860} + \\frac{4290}{2860} \\right) $$\n$$ \\bar{s} = \\frac{1}{5} \\left( \\frac{2340 + 2431 + 2200 + 4290}{2860} \\right) = \\frac{1}{5} \\left( \\frac{11261}{2860} \\right) $$\n$$ \\bar{s} = \\frac{11261}{14300} $$\n\n结果解释：\n各个细胞的轮廓系数分别为 $s(1) = 9/11 \\approx 0.818$、$s(2) = 17/20 = 0.85$、$s(3) = 11/16 = 0.6875$、$s(4) = 10/13 \\approx 0.769$ 和 $s(5) = 13/16 = 0.8125$。所有这些值都显著大于 $0$ 并接近 $1$，这表明每个细胞与其自身簇中的细胞的平均距离，远小于其与另一个簇中细胞的平均距离。总体平均轮廓系数得分 $\\bar{s} = 11261/14300 \\approx 0.787$ 很高，意味着该聚类划分质量很高。在此背景下，这意味着这些簇既是紧凑的（低的簇内距离，反映在 $a(i)$ 值中），又是分离良好的（高的簇间距离，反映在 $b(i)$ 值中）。这为“两个簇确实对应于不同且分辨清晰的细胞类型”这一假设提供了强有力的定量证据。", "answer": "$$\\boxed{\\frac{11261}{14300}}$$", "id": "4607428"}, {"introduction": "高质量的聚类结果为我们揭示了细胞的异质性，但其生物学意义仍需进一步阐释，其中一个核心任务就是鉴定定义每个细胞簇的标记基因（marker gene）。受试者工作特征曲线下面积（Area Under the ROC Curve, AUC）是一个有效的非参数指标，可用于量化某个基因的表达水平区分两个细胞群体的能力。本练习将通过一个具体案例，演示如何计算和解读AUC值，从而评估一个候选基因作为细胞类型特异性标记的潜力 [@problem_id:4607367]。", "problem": "您正在分析一个单细胞核糖核酸测序（scRNA-seq）数据集，其中非监督聚类识别出两个聚类，记为 $\\mathcal{C}_{1}$ 和 $\\mathcal{C}_{0}$。一个候选标记基因 $g$ 被假设在 $\\mathcal{C}_{1}$ 中相对于 $\\mathcal{C}_{0}$ 是上调的，您希望使用受试者工作特征（ROC）曲线下面积来量化其区分能力。受试者工作特征（ROC）曲线比较了当标量分数的阈值变化时，真阳性率和假阳性率的变化；这里的标量分数是基因 $g$ 的对数归一化表达量。将 $\\mathcal{C}_{1}$ 视为正类，$\\mathcal{C}_{0}$ 视为负类。基因 $g$ 在一部分细胞中的对数归一化表达值如下：\n- $\\mathcal{C}_{1}$ (假定标记阳性): $2.5$, $3.1$, $1.8$, $2.2$, $3.7$, $2.9$。\n- $\\mathcal{C}_{0}$ (假定标记阴性): $0.6$, $1.1$, $1.4$, $1.9$, $2.3$。\n从ROC曲线关于真阳性率和假阳性率作为应用于标量分数的阈值的函数的基本定义出发，推导在这种有限样本情况下的ROC曲线下面积（AUC）的表达式，并计算上述数据的AUC值。基于该定义，使用概率解释简要说明这个值对基因 $g$ 在 $\\mathcal{C}_{1}$ 和 $\\mathcal{C}_{0}$ 之间的区分能力意味着什么。将AUC报告为一个在 $[0,1]$ 区间内的标量，并将最终数值答案四舍五入到四位有效数字。", "solution": "该问题要求计算并解释候选标记基因 $g$ 的受试者工作特征曲线下面积（AUC），已知其在两个细胞聚类 $\\mathcal{C}_{1}$（正类）和 $\\mathcal{C}_{0}$（负类）中的对数归一化表达值。\n\n首先，让我们形式化受试者工作特征（ROC）曲线及其下面积的概念。ROC曲线是一个图形图，它说明了二元分类器系统在其判别阈值变化时的诊断能力。它是通过在不同阈值设置下绘制真阳性率（$TPR$）对假阳性率（$FPR$）的曲线来创建的。\n\n设 $S$ 为用于分类的标量分数，在本问题中即为基因 $g$ 的对数归一化表达量。设 $\\tau$ 为分类阈值。如果一个样本的分数 $S > \\tau$，则它被分类为正类。\n正类是 $\\mathcal{C}_{1}$，包含 $N_1$ 个样本。负类是 $\\mathcal{C}_{0}$，包含 $N_0$ 个样本。\n真阳性率，或称灵敏度，是被正确分类为正类的正样本的比例：\n$$TPR(\\tau) = \\frac{\\text{在 } \\mathcal{C}_{1} \\text{ 中分数 } > \\tau \\text{ 的样本数}}{N_1}$$\n假阳性率，或称（1 - 特异度），是被错误分类为正类的负样本的比例：\n$$FPR(\\tau) = \\frac{\\text{在 } \\mathcal{C}_{0} \\text{ 中分数 } > \\tau \\text{ 的样本数}}{N_0}$$\nROC曲线是对于所有可能的 $\\tau \\in (-\\infty, \\infty)$ 值，点集 $(FPR(\\tau), TPR(\\tau))$ 所构成的曲线。此曲线下面积（AUC）由以下积分给出：\n$$AUC = \\int_0^1 TPR(x) dx$$\n其中积分变量 $x$ 代表 $FPR$。\n\n一个基本结果为AUC提供了一个概率解释。AUC等于从正类中随机抽取一个样本的分数高于从负类中随机抽取一个样本的分数的概率。设 $S_1$ 为从 $\\mathcal{C}_1$ 中随机抽取样本的分数，$S_0$ 为从 $\\mathcal{C}_0$ 中随机抽取样本的分数。那么，\n$AUC = P(S_1 > S_0)$\n在可能出现平局（即 $S_1 = S_0$）的情况下，标准定义将其调整为 $AUC = P(S_1 > S_0) + \\frac{1}{2} P(S_1 = S_0)$。\n\n对于没有平局的有限样本集，这个概率可以通过Wilcoxon-Mann-Whitney U统计量进行非参数估计，这涉及到计算所有可能的样本对（每对样本一个来自正类，一个来自负类）。设来自 $\\mathcal{C}_1$ 的分数集为 $X_1 = \\{x_{1,i}\\}_{i=1}^{N_1}$，来自 $\\mathcal{C}_0$ 的分数集为 $X_0 = \\{x_{0,j}\\}_{j=1}^{N_0}$。AUC的计算公式如下：\n$$AUC = \\frac{1}{N_1 N_0} \\sum_{i=1}^{N_1} \\sum_{j=1}^{N_0} \\mathbb{I}(x_{1,i}, x_{0,j})$$\n其中\n$$ \\mathbb{I}(a, b) = \\begin{cases} 1 & \\text{若 } a > b \\\\ 0.5 & \\text{若 } a = b \\\\ 0 & \\text{若 } a < b \\end{cases} $$\n该表达式为计算给定有限数据集的AUC提供了最直接的方法。\n\n现在，我们将此方法应用于所提供的数据。\n正类是 $\\mathcal{C}_{1}$，有 $N_1 = 6$ 个样本。表达值为 $X_1 = \\{2.5, 3.1, 1.8, 2.2, 3.7, 2.9\\}$。\n负类是 $\\mathcal{C}_{0}$，有 $N_0 = 5$ 个样本。表达值为 $X_0 = \\{0.6, 1.1, 1.4, 1.9, 2.3\\}$。\n\n从 $\\mathcal{C}_{1}$ 中取一个细胞和从 $\\mathcal{C}_{0}$ 中取一个细胞组成的总对数为 $N_1 \\times N_0 = 6 \\times 5 = 30$。\n两组数据之间没有表达值相同的情况，因此 $\\mathbb{I}(a,b)$ 函数只会取值 $1$ 或 $0$。我们需要计算满足 $x_{1,i} > x_{0,j}$ 的对 $(x_{1,i}, x_{0,j})$ 的数量。\n\n让我们系统地进行成对比较：\n对于每个 $x_{1,i} \\in X_1$，我们计算有多少个 $x_{0,j} \\in X_0$ 比它小。\n\\begin{itemize}\n    \\item 对于 $x_{1,i} = 2.5$：它大于 $X_0 = \\{0.6, 1.1, 1.4, 1.9, 2.3\\}$ 中的所有 $5$ 个值。计数为 $5$。\n    \\item 对于 $x_{1,i} = 3.1$：它大于 $X_0$ 中的所有 $5$ 个值。计数为 $5$。\n    \\item 对于 $x_{1,i} = 1.8$：它大于 $\\{0.6, 1.1, 1.4\\}$。计数为 $3$。\n    \\item 对于 $x_{1,i} = 2.2$：它大于 $\\{0.6, 1.1, 1.4, 1.9\\}$。计数为 $4$。\n    \\item 对于 $x_{1,i} = 3.7$：它大于 $X_0$ 中的所有 $5$ 个值。计数为 $5$。\n    \\item 对于 $x_{1,i} = 2.9$：它大于 $X_0$ 中的所有 $5$ 个值。计数为 $5$。\n\\end{itemize}\n\n来自 $\\mathcal{C}_1$ 的分数大于来自 $\\mathcal{C}_0$ 的分数的总对数是这些计数的总和：\n$$ \\text{总和} = 5 + 5 + 3 + 4 + 5 + 5 = 27 $$\n现在，我们可以计算AUC：\n$$ AUC = \\frac{27}{30} = \\frac{9}{10} = 0.9 $$\n问题要求答案四舍五入到四位有效数字，所以 $0.9$ 写成 $0.9000$。\n\n解释：AUC值是衡量分类器性能的指标，范围从 $0$ 到 $1$。AUC为 $0.5$ 对应于没有区分能力的随机分类器。AUC为 $1.0$ 对应于完美的分类器。计算出的AUC值为 $0.9$，非常接近 $1.0$，这表明基因 $g$ 的表达水平在区分聚类 $\\mathcal{C}_{1}$ 和 $\\mathcal{C}_{0}$ 的细胞方面具有出色的区分能力。\n根据概率解释，AUC为 $0.9$ 意味着如果我们从 $\\mathcal{C}_{1}$ 中随机选择一个细胞，并从 $\\mathcal{C}_{0}$ 中随机选择一个细胞，那么有 $90\\%$ 的概率 $\\mathcal{C}_{1}$ 中的细胞将具有更高的基因 $g$ 对数归一化表达量。这有力地支持了 $g$ 是在 $\\mathcal{C}_{1}$ 中上调的标记基因这一假设。", "answer": "$$\\boxed{0.9000}$$", "id": "4607367"}]}