{"hands_on_practices": [{"introduction": "在训练或评估任何临床命名实体识别（NER）系统之前，我们必须确保基准标注数据（ground-truth data）的质量和一致性。标注者间一致性（Inter-Annotator Agreement, IAA）指标是实现此目标的关键工具，它量化了人类专家之间共识的程度。本练习将指导您计算一个标准的IAA指标——科恩系数（Cohen’s Kappa, $\\kappa$），以评估词元（token）级别标注的可靠性，并理解其深层含义。[@problem_id:4547588]", "problem": "一个医院研究团队正在评估一份简短的去身份化医生笔记中临床命名实体识别（NER）标注的一致性。两名人工评分员独立地将每个词元（token）标注为五个互斥类别之一：外部（Outside, $O$）、问题（Problem, $\\mathrm{PROB}$）、药物（Medication, $\\mathrm{MED}$）、实验室检验（Laboratory Test, $\\mathrm{TEST}$）和解剖结构（Anatomy, $\\mathrm{ANAT}$）。词元总数为 $60$。两位评分员之间的词元级联合计数总结如下，其中每个项目符号表示评分员 A 指定为固定类别的词元子集的计数，按评分员 B 的指定进行划分：\n\n- 对于评分员 A 标注为 $O$ 的词元：评分员 B 将 $38$ 个词元标注为 $O$，$1$ 个词元标注为 $\\mathrm{PROB}$，$0$ 个词元标注为 $\\mathrm{MED}$，$1$ 个词元标注为 $\\mathrm{TEST}$，以及 $0$ 个词元标注为 $\\mathrm{ANAT}$。\n- 对于评分员 A 标注为 $\\mathrm{PROB}$ 的词元：评分员 B 将 $2$ 个词元标注为 $O$，$5$ 个词元标注为 $\\mathrm{PROB}$，$0$ 个词元标注为 $\\mathrm{MED}$，$1$ 个词元标注为 $\\mathrm{TEST}$，以及 $0$ 个词元标注为 $\\mathrm{ANAT}$。\n- 对于评分员 A 标注为 $\\mathrm{MED}$ 的词元：评分员 B 将 $1$ 个词元标注为 $O$，$0$ 个词元标注为 $\\mathrm{PROB}$，$3$ 个词元标注为 $\\mathrm{MED}$，$1$ 个词元标注为 $\\mathrm{TEST}$，以及 $1$ 个词元标注为 $\\mathrm{ANAT}$。\n- 对于评分员 A 标注为 $\\mathrm{TEST}$ 的词元：评分员 B 将 $1$ 个词元标注为 $O$，$0$ 个词元标注为 $\\mathrm{PROB}$，$1$ 个词元标注为 $\\mathrm{MED}$，$2$ 个词元标注为 $\\mathrm{TEST}$，以及 $0$ 个词元标注为 $\\mathrm{ANAT}$。\n- 对于评分员 A 标注为 $\\mathrm{ANAT}$ 的词元：评分员 B 将 $0$ 个词元标注为 $O$，$1$ 个词元标注为 $\\mathrm{PROB}$，$1$ 个词元标注为 $\\mathrm{MED}$，$0$ 个词元标注为 $\\mathrm{TEST}$，以及 $0$ 个词元标注为 $\\mathrm{ANAT}$。\n\n假设基于评分员的边际标签分布，采用独立评分员下观察到的一致性和期望一致性的标准信度理论定义。计算这些标注的词元级 Cohen’s kappa $\\kappa$ 值，表示为单个实数。将最终数值答案四舍五入到四位有效数字。\n\n然后，简要解释（无需计算任何额外的数值指标）在这种情况下，片段级（span-level）一致性（例如，基于精确片段匹配的评分员间一致性（IAA））与词元级一致性有何不同，特别是在存在边界对齐问题时，例如一个评分员将“$\\mathrm{Type\\ 2\\ diabetes\\ mellitus}$”标注为单个 $\\mathrm{PROB}$ 片段，而另一个评分员仅标注“$\\mathrm{diabetes}$”。最终数值答案无需单位。", "solution": "该问题被验证为具有科学依据、提法恰当、客观且自洽。所提供的数据是完整的，足以计算 Cohen's kappa，这是一个用于评估评分员间信度的标准指标。从联合计数中得出的词元总数（$38+1+0+1+0 + 2+5+0+1+0 + 1+0+3+1+1 + 1+0+1+2+0 + 0+1+1+0+0=60$）与所述的总数 $60$ 相符。因此，该问题是有效的。\n\n解答过程分为两部分：首先，计算 Cohen's kappa ($\\kappa$)；其次，对词元级和片段级一致性之间的差异进行概念性解释。\n\n第 1 部分：计算 Cohen's Kappa\n\nCohen's kappa 系数定义为 $\\kappa = \\frac{p_o - p_e}{1 - p_e}$，其中 $p_o$ 是评分员之间观察到的一致性比例，而 $p_e$ 是偶然一致的假设概率。已标注的词元总数为 $N=60$。五个标注类别是 $O$、$\\mathrm{PROB}$、$\\mathrm{MED}$、$\\mathrm{TEST}$ 和 $\\mathrm{ANAT}$。\n\n首先，我们根据给定数据构建一个列联表（或混淆矩阵），其中行代表评分员 A 指定的标签，列代表评分员 B 指定的标签。令 $n_{ij}$ 为评分员 A 指定为类别 $i$ 且评分员 B 指定为类别 $j$ 的词元数。\n\n计数的列联表为：\n$$\nN_{obs} = \n\\begin{pmatrix}\n  \\text{O}  \\text{PROB}  \\text{MED}  \\text{TEST}  \\text{ANAT} \\\\\n\\text{O}  38  1  0  1  0 \\\\\n\\text{PROB}  2  5  0  1  0 \\\\\n\\text{MED}  1  0  3  1  1 \\\\\n\\text{TEST}  1  0  1  2  0 \\\\\n\\text{ANAT}  0  1  1  0  0\n\\end{pmatrix}\n$$\n\n接下来，我们计算观察到的一致性 $p_o$。这是两位评分员在标签上达成一致的词元比例。它是列联表对角线元素之和除以词元总数 $N$。\n$$\np_o = \\frac{\\sum_{i=1}^{5} n_{ii}}{N} = \\frac{38 + 5 + 3 + 2 + 0}{60} = \\frac{48}{60} = 0.8\n$$\n\n接下来，我们计算偶然的期望一致性 $p_e$。这需要每个评分员的边际总数。令 $n_{i \\cdot}$ 为评分员 A 标注为类别 $i$ 的词元总数（行和），令 $n_{\\cdot j}$ 为评分员 B 标注为类别 $j$ 的词元总数（列和）。\n\n行和（评分员 A 的边际）：\n$n_{O \\cdot} = 38 + 1 + 0 + 1 + 0 = 40$\n$n_{\\mathrm{PROB} \\cdot} = 2 + 5 + 0 + 1 + 0 = 8$\n$n_{\\mathrm{MED} \\cdot} = 1 + 0 + 3 + 1 + 1 = 6$\n$n_{\\mathrm{TEST} \\cdot} = 1 + 0 + 1 + 2 + 0 = 4$\n$n_{\\mathrm{ANAT} \\cdot} = 0 + 1 + 1 + 0 + 0 = 2$\n行总数的和为 $40+8+6+4+2=60=N$。\n\n列和（评分员 B 的边际）：\n$n_{\\cdot O} = 38 + 2 + 1 + 1 + 0 = 42$\n$n_{\\cdot \\mathrm{PROB}} = 1 + 5 + 0 + 0 + 1 = 7$\n$n_{\\cdot \\mathrm{MED}} = 0 + 0 + 3 + 1 + 1 = 5$\n$n_{\\cdot \\mathrm{TEST}} = 1 + 1 + 1 + 2 + 0 = 5$\n$n_{\\cdot \\mathrm{ANAT}} = 0 + 0 + 1 + 0 + 0 = 1$\n列总数的和为 $42+7+5+5+1=60=N$。\n\n期望一致性 $p_e$ 是假设评分员判断独立的情况下，每个类别边际概率乘积的总和。\n$$\np_e = \\sum_{i \\in \\{\\text{classes}\\}} P(\\text{Rater A}=i) \\times P(\\text{Rater B}=i) = \\frac{1}{N^2} \\sum_{i=1}^{5} (n_{i \\cdot} \\times n_{\\cdot i})\n$$\n$$\np_e = \\frac{1}{60^2} \\left[ (40 \\times 42) + (8 \\times 7) + (6 \\times 5) + (4 \\times 5) + (2 \\times 1) \\right]\n$$\n$$\np_e = \\frac{1}{3600} (1680 + 56 + 30 + 20 + 2) = \\frac{1788}{3600}\n$$\n化简分数：$\\frac{1788}{3600} = \\frac{447}{900} = \\frac{149}{300}$。\n\n最后，我们计算 Cohen's kappa，$\\kappa$。\n$$\n\\kappa = \\frac{p_o - p_e}{1 - p_e} = \\frac{\\frac{48}{60} - \\frac{1788}{3600}}{1 - \\frac{1788}{3600}} = \\frac{\\frac{4 \\times 60}{300} - \\frac{149}{300}}{1 - \\frac{149}{300}} = \\frac{\\frac{240 - 149}{300}}{\\frac{300-149}{300}} = \\frac{\\frac{91}{300}}{\\frac{151}{300}} = \\frac{91}{151}\n$$\n为了获得数值，我们执行除法运算：\n$$\n\\kappa = \\frac{91}{151} \\approx 0.6026490066...\n$$\n四舍五入到四位有效数字，我们得到 $\\kappa \\approx 0.6026$。\n\n第 2 部分：词元级与片段级一致性的解释\n\n如上计算的词元级一致性将每个词元视为一个独立的标注单位。它衡量的是由两位评分员赋予相同标签的词元比例，并根据偶然性进行了校正。在命名实体识别（NER）任务中，这个指标可能会产生误导性的高值，因为它没有考虑实体的连续性。片段级一致性是一种更严格的度量，它评估在被识别为实体的整个短语或文本“片段”上的一致性。在一个常见的片段级指标（如精确匹配的评分员间一致性（IAA））下，要计算为一致，两位评分员必须识别出完全相同的词元序列（即起始和结束边界相同）并为其分配相同的实体标签。\n\n边界对齐问题对这两种类型的一致性有显著不同的影响。考虑一个例子，评分员 A 将片段“$\\mathrm{Type\\ 2\\ diabetes\\ mellitus}$”标注为单个 $\\mathrm{PROB}$ 实体，而评分员 B 仅将“$\\mathrm{diabetes}$”标注为 $\\mathrm{PROB}$。在片段级（精确匹配），这是一个完全的不一致；因为识别出了两个不同的片段，它们不匹配，因此对一致性的贡献为零。然而，在词元级，评分员们对词元“$\\mathrm{diabetes}$”的标签 $\\mathrm{PROB}$ 达成了一致。这一个词元的一致性将对词元级 kappa 产生积极贡献，而对“$\\mathrm{Type}$”、“$2$”和“$\\mathrm{mellitus}$”的不一致则会产生负面影响。因此，在 NER 任务中，片段级 IAA 通常低于词元级 IAA，因为它对实体边界的不一致性更为敏感，而这种不一致性很常见。", "answer": "$$\n\\boxed{0.6026}\n$$", "id": "4547588"}, {"introduction": "现代自然语言处理模型，特别是基于Transformer架构的模型，是在子词（subword）而非完整单词的层面上进行操作。本练习将演示一个关键的预处理步骤：如何将WordPiece分词技术应用于临床文本，并使用BILOU标注方案将生成的子词与实体标签对齐。掌握这一过程对于为先进的NER模型准备训练和推理数据至关重要。[@problem_id:4547499]", "problem": "一个临床自然语言处理任务需要将由 WordPiece 分词器产生的子词片段与 Begin–Inside–Last–Outside–Unit (BILOU) 方案中的实体标签对齐，以支持下游对药品名称、其剂量强度和给药频率之间的关系抽取。考虑以下电子健康记录 (EHR) 片段：“metoprolol-XL 50mg qHS”。使用以下设置。\n\n基本基础：\n1) WordPiece 分词的定义：一个基础分词器首先按空格分割，并将标点符号分离成独立的词元。然后 WordPiece 对每个基础词元应用贪心最长匹配优先规则。在基础词元的开始处，可以选择任何不带接续标记 “##” 的词汇项；对于同一基础词元内的接续，只能选择带有 “##” 前缀的词汇项。当移除 “##” 前缀并将子词按顺序连接时，这个过程必须能精确地重构原始基础词元字符串。\n2) BILOU 方案的定义：对于任何实体范围，多词元范围中的第一个词元被标记为 Begin ($\\text{B}$)，任何严格内部的词元被标记为 Inside ($\\text{I}$)，最后一个词元被标记为 Last ($\\text{L}$)。单词元范围被标记为 Unit ($\\text{U}$)。不属于任何实体的词元被标记为 Outside ($\\text{O}$)。\n\n给定：\n- 一个基础分词器，它按空格分割，并将连字符“-”视为一个单独的词元。\n- 一个 WordPiece 词汇表，仅限于集合\n$$\\{\\texttt{met},\\ \\texttt{##op},\\ \\texttt{##ro},\\ \\texttt{##lol},\\ \\texttt{-},\\ \\texttt{XL},\\ \\texttt{50},\\ \\texttt{##mg},\\ \\texttt{q},\\ \\texttt{##HS}\\}.$$\n- 在原始文本字符串上定义的标准实体提及如下：\n  a) 药品名称 (DRUG): “metoprolol-XL”\n  b) 剂量强度 (STRENGTH): “50mg”\n  c) 频率 (FREQ): “qHS”\n\n任务：\n1) 将基础分词器和 WordPiece 分词器（如上定义）应用于字符串 “metoprolol-XL 50mg qHS”，确保正确处理连字符和单位。\n2) 将生成的 WordPiece 词元与标准实体范围对齐，并为每个 WordPiece 词元生成一个 BILOU 标签。在进行 BILOU 分配时，将每个 WordPiece 子词元视为一个独立的词元，因此多子词实体在其第一个子词上接收 $\\text{B}$，在内部子词上接收 $\\text{I}$，在最后一个子词上接收 $\\text{L}$；单子词实体接收 $\\text{U}$。\n3) 使用以下映射将每个 BILOU 标签映射到一个整数代码：\n   - $\\text{B-DRUG} \\mapsto 11$, $\\text{I-DRUG} \\mapsto 12$, $\\text{L-DRUG} \\mapsto 13$, $\\text{U-DRUG} \\mapsto 14$,\n   - $\\text{B-STRENGTH} \\mapsto 21$, $\\text{I-STRENGTH} \\mapsto 22$, $\\text{L-STRENGTH} \\mapsto 23$, $\\text{U-STRENGTH} \\mapsto 24$,\n   - $\\text{B-FREQ} \\mapsto 31$, $\\text{I-FREQ} \\mapsto 32$, $\\text{L-FREQ} \\mapsto 33$, $\\text{U-FREQ} \\mapsto 34$,\n   - $\\text{O} \\mapsto 0$。\n4) 设最终序列的长度为 $N$。定义校验和\n$$H \\;=\\; \\sum_{i=1}^{N} i \\cdot \\mathrm{code}_i,$$\n其中 $\\mathrm{code}_i$ 是第 $i$ 个 WordPiece 词元的 BILOU 标签按其出现的顺序对应的整数代码。\n\n计算 $H$ 的值。将最终答案表示为一个没有单位的整数。不需要四舍五入。", "solution": "在进行解答之前，对问题陈述进行了严格验证。\n\n### 步骤 1：提取给定信息\n- **输入字符串**：“metoprolol-XL 50mg qHS”\n- **基础分词器规则**：按空格分割，并将连字符“-”视为一个单独的词元。更一般地，它“将标点符号分离成独立的词元”。\n- **WordPiece 分词器规则**：对每个基础词元应用贪心最长匹配优先算法。以“##”为前缀的词汇项是接续子词。子词必须能完美重构原始基础词元。\n- **WordPiece 词汇表**：$\\{\\texttt{met},\\ \\texttt{##op},\\ \\texttt{##ro},\\ \\texttt{##lol},\\ \\texttt{-},\\ \\texttt{XL},\\ \\texttt{50},\\ \\texttt{##mg},\\ \\texttt{q},\\ \\texttt{##HS}\\}$\n- **标准实体范围**：\n  - 药品名称 (DRUG)：“metoprolol-XL”\n  - 剂量强度 (STRENGTH)：“50mg”\n  - 频率 (FREQ)：“qHS”\n- **BILOU 方案定义**：多词元范围中的第一个词元是 Begin ($\\text{B}$)，内部词元是 Inside ($\\text{I}$)，最后一个词元是 Last ($\\text{L}$)。单词元范围是 Unit ($\\text{U}$)。非实体词元是 Outside ($\\text{O}$)。\n- **整数代码映射**：\n  - $\\text{B-DRUG} \\mapsto 11$, $\\text{I-DRUG} \\mapsto 12$, $\\text{L-DRUG} \\mapsto 13$, $\\text{U-DRUG} \\mapsto 14$\n  - $\\text{B-STRENGTH} \\mapsto 21$, $\\text{I-STRENGTH} \\mapsto 22$, $\\text{L-STRENGTH} \\mapsto 23$, $\\text{U-STRENGTH} \\mapsto 24$\n  - $\\text{B-FREQ} \\mapsto 31$, $\\text{I-FREQ} \\mapsto 32$, $\\text{L-FREQ} \\mapsto 33$, $\\text{U-FREQ} \\mapsto 34$\n  - $\\text{O} \\mapsto 0$\n- **校验和公式**：$H = \\sum_{i=1}^{N} i \\cdot \\mathrm{code}_i$，其中 $N$ 是 WordPiece 词元的数量，$\\mathrm{code}_i$ 是第 $i$ 个词元的整数代码。\n\n### 步骤 2：使用提取的给定信息进行验证\n根据验证标准对问题进行评估。\n- **科学依据**：问题在自然语言处理领域有充分的科学依据，该领域是计算机科学和人工智能的一个子领域。WordPiece 分词和用于命名实体识别的 BILOU 标签等概念是临床 NLP 中的标准技术。\n- **定义明确**：所有规则、定义和数据都已提供。分词算法是确定性的，标签和计算规则是明确的，从而得出一个唯一的、有意义的解。\n- **客观性**：问题陈述使用精确、客观的语言，没有主观或基于意见的成分。\n- 没有科学或事实上的不健全、不完整、矛盾或其他缺陷。\n\n### 步骤 3：结论与行动\n该问题被判定为 **有效**。将提供一个完整的、有理有据的解答。\n\n通过执行问题陈述中指定的四个任务来得出解答。\n\n**任务 1：分词**\n\n首先，对输入字符串 “metoprolol-XL 50mg qHS” 应用基础分词器。该分词器按空格分割并分离标点符号。\n1.  按空格分割产生初步词元：`[“metoprolol-XL”, “50mg”, “qHS”]`。\n2.  `“metoprolol-XL”` 中的连字符作为标点符号被分离。这将第一个词元分解为 `[“metoprolol”, “-”, “XL”]`。\n3.  最终的基础词元列表是：`[“metoprolol”, “-”, “XL”, “50mg”, “qHS”]`。\n\n接下来，使用提供的词汇表和贪心最长匹配优先规则，对每个基础词元应用 WordPiece 分词器。\n- 对于基础词元 `“metoprolol”`：\n  - `met` 是词汇表中最长的前缀。剩余部分：`oprolol`。\n  - `##op` 是最长的接续匹配。剩余部分：`rolol`。\n  - `##ro` 是最长的接续匹配。剩余部分：`lol`。\n  - `##lol` 是最长的接续匹配。剩余部分为空。\n  - 结果：`[“met”, “##op”, “##ro”, “##lol”]`\n- 对于基础词元 `“-”`：\n  - `-` 在词汇表中。\n  - 结果：`[“-”]`\n- 对于基础词元 `“XL”`：\n  - `XL` 在词汇表中。\n  - 结果：`[“XL”]`\n- 对于基础词元 `“50mg”`：\n  - `50` 是最长的前缀。剩余部分：`mg`。\n  - `##mg` 是接续匹配。剩余部分为空。\n  - 结果：`[“50”, “##mg”]`\n- 对于基础词元 `“qHS”`：\n  - `q` 是最长的前缀。剩余部分：`HS`。\n  - `##HS` 是接续匹配。剩余部分为空。\n  - 结果：`[“q”, “##HS”]`\n\n结合所有结果，最终的 $N=10$ 个 WordPiece 词元序列是：\n`[“met”, “##op”, “##ro”, “##lol”, “-”, “XL”, “50”, “##mg”, “q”, “##HS”]`\n\n**任务 2：BILOU 标签分配**\n\n将 WordPiece 词元与标准实体范围对齐，为每个词元分配一个 BILOU 标签。\n\n- **实体：药品名称 (DRUG) “metoprolol-XL”**\n  - 该范围对应于前 $6$ 个 WordPiece 词元：`“met”, “##op”, “##ro”, “##lol”, “-”, “XL”`。\n  - 作为一个多词元范围，标签如下：\n    - `“met”`: B-DRUG (Begin)\n    - `“##op”`: I-DRUG (Inside)\n    - `“##ro”`: I-DRUG (Inside)\n    - `“##lol”`: I-DRUG (Inside)\n    - `“-”`: I-DRUG (Inside)\n    - `“XL”`: L-DRUG (Last)\n- **实体：剂量强度 (STRENGTH) “50mg”**\n  - 该范围对应于接下来的 $2$ 个 WordPiece 词元：`“50”, “##mg”`。\n  - 作为一个 $2$-词元范围，标签如下：\n    - `“50”`: B-STRENGTH (Begin)\n    - `“##mg”`: L-STRENGTH (Last)\n- **实体：频率 (FREQ) “qHS”**\n  - 该范围对应于最后的 $2$ 个 WordPiece 词元：`“q”, “##HS”`。\n  - 作为一个 $2$-词元范围，标签如下：\n    - `“q”`: B-FREQ (Begin)\n    - `“##HS”`: L-FREQ (Last)\n\n排序后的（词元，标签）对列表如下：\n1. (`“met”`, B-DRUG)\n2. (`“##op”`, I-DRUG)\n3. (`“##ro”`, I-DRUG)\n4. (`“##lol”`, I-DRUG)\n5. (`“-”`, I-DRUG)\n6. (`“XL”`, L-DRUG)\n7. (`“50”`, B-STRENGTH)\n8. (`“##mg”`, L-STRENGTH)\n9. (`“q”`, B-FREQ)\n10. (`“##HS”`, L-FREQ)\n\n**任务 3：整数代码映射**\n\n使用提供的映射，将每个 BILOU 标签映射到其对应的整数代码 $\\mathrm{code}_i$。\n1. B-DRUG $\\mapsto 11$\n2. I-DRUG $\\mapsto 12$\n3. I-DRUG $\\mapsto 12$\n4. I-DRUG $\\mapsto 12$\n5. I-DRUG $\\mapsto 12$\n6. L-DRUG $\\mapsto 13$\n7. B-STRENGTH $\\mapsto 21$\n8. L-STRENGTH $\\mapsto 23$\n9. B-FREQ $\\mapsto 31$\n10. L-FREQ $\\mapsto 33$\n\n整数代码序列为：$[11, 12, 12, 12, 12, 13, 21, 23, 31, 33]$。\n\n**任务 4：校验和计算**\n\n使用公式 $H = \\sum_{i=1}^{N} i \\cdot \\mathrm{code}_i$ 计算校验和 $H$，其中 $N = 10$。\n\n$H = (1 \\cdot \\mathrm{code}_1) + (2 \\cdot \\mathrm{code}_2) + (3 \\cdot \\mathrm{code}_3) + (4 \\cdot \\mathrm{code}_4) + (5 \\cdot \\mathrm{code}_5) + (6 \\cdot \\mathrm{code}_6) + (7 \\cdot \\mathrm{code}_7) + (8 \\cdot \\mathrm{code}_8) + (9 \\cdot \\mathrm{code}_9) + (10 \\cdot \\mathrm{code}_{10})$\n\n代入整数代码：\n$H = (1 \\cdot 11) + (2 \\cdot 12) + (3 \\cdot 12) + (4 \\cdot 12) + (5 \\cdot 12) + (6 \\cdot 13) + (7 \\cdot 21) + (8 \\cdot 23) + (9 \\cdot 31) + (10 \\cdot 33)$\n\n计算每一项：\n$H = 11 + 24 + 36 + 48 + 60 + 78 + 147 + 184 + 279 + 330$\n\n将各项相加：\n$H = (11 + 24 + 36 + 48 + 60) + 78 + 147 + 184 + 279 + 330$\n$H = 179 + 78 + 147 + 184 + 279 + 330$\n$H = 257 + 147 + 184 + 279 + 330$\n$H = 404 + 184 + 279 + 330$\n$H = 588 + 279 + 330$\n$H = 867 + 330$\n$H = 1197$\n\n校验和 $H$ 的值为 $1197$。", "answer": "$$\\boxed{1197}$$", "id": "4547499"}, {"introduction": "评估一个命名实体识别（NER）系统，不仅仅是检查标签是否正确，还必须考虑实体边界的准确性，因此评估过程比想象中更为精细。本练习将探讨“严格（strict）”与“宽松（relaxed）”评估标准之间的实际差异，这两种标准对我们如何解读模型性能有着重要影响。通过计算并比较两种标准下的 $F1$ 分数，您将更深刻地理解如何批判性地评估和报告NER系统的性能。[@problem_id:4547529]", "problem": "一个临床命名实体识别（NER）系统处理一个分词后的临床记录。每个实体表示为一个标记索引的闭区间 $[s,e]$，并带有一个相关的语义类型。金标准集包含以下五个实体：\n- $G_{1}: [3,6]$，类型“问题”。\n- $G_{2}: [10,10]$，类型“药物”。\n- $G_{3}: [11,12]$，类型“剂量”。\n- $G_{4}: [15,17]$，类型“问题”。\n- $G_{5}: [21,22]$，类型“问题”。\n\n系统输出以下六个预测实体（原始预测集）：\n- $P_{1}: [3,6]$，类型“问题”。\n- $P_{2}: [10,11]$，类型“药物”。\n- $P_{3}: [11,12]$，类型“剂量”。\n- $P_{4}: [16,17]$，类型“问题”。\n- $P_{5}: [20,22]$，类型“问题”。\n- $P_{6}: [25,25]$，类型“药物”。\n\n评估使用两种匹配机制，每种机制都采用一对一的对齐方式（每个金标准实体最多只能匹配一个预测实体，反之亦然）：\n\n1. 严格匹配：一个预测实体被计为真正例（TP）当且仅当其 $[s,e]$ 边界与一个金标准实体完全匹配且类型相同。未匹配任何金标准实体的预测实体是假正例（FP）。未被任何预测匹配的金标准实体是假反例（FN）。\n\n2. 宽松匹配：一个预测实体被计为真正例（TP）当且仅当它与一个金标准实体至少重叠一个标记（即区间的交集非空）且类型相同。允许精确匹配。如果一个预测实体与多个相同类型的金标准实体重叠，它将与重叠标记数最多的未匹配金标准实体对齐；若数量相同，则选择起始索引最小的金标准实体。没有有效重叠的预测实体是假正例（FP）。未被匹配的金标准实体是假反例（FN）。\n\n根据精确率和召回率的核心定义，\n- 精确率为 $P = \\frac{\\text{TP}}{\\text{TP} + \\text{FP}}$。\n- 召回率为 $R = \\frac{\\text{TP}}{\\text{TP} + \\text{FN}}$。\n$F1$分数定义为精确率和召回率的调和平均数：\n$$F1 = \\frac{2PR}{P+R}.$$\n\n任务 A：使用原始预测集，计算 $F1^{\\mathrm{strict}}$ 和 $F1^{\\mathrm{relaxed}}$。\n\n任务 B：为了模拟边界错误，通过将每个预测区间的起始和结束索引向右移动一个标记来扰动每个预测区间，生成一个扰动集 $P'_{i}: [s+1,e+1]$，其类型保持不变。在严格和宽松匹配下重新评估，计算 $F1'^{\\mathrm{strict}}$ 和 $F1'^{\\mathrm{relaxed}}$。\n\n任务 C：通过计算变化量 $\\Delta F1^{\\mathrm{strict}} = F1'^{\\mathrm{strict}} - F1^{\\mathrm{strict}}$ 和 $\\Delta F1^{\\mathrm{relaxed}} = F1'^{\\mathrm{relaxed}} - F1^{\\mathrm{relaxed}}$ 来量化对边界错误的敏感度。\n\n将您的最终结果报告为包含以下顺序的四个分量的单行向量：\n$$\\left(F1^{\\mathrm{strict}},\\ F1^{\\mathrm{relaxed}},\\ \\Delta F1^{\\mathrm{strict}},\\ \\Delta F1^{\\mathrm{relaxed}}\\right).$$\n精确表达所有数值；无需四舍五入。", "solution": "用户提供的问题首先经过严格的验证过程。\n\n### 第1步：提取已知信息\n从问题陈述中逐字提取的已知信息如下：\n\n**金标准实体 ($G$):**\n- $G_{1}: [3,6]$，类型“问题”。\n- $G_{2}: [10,10]$，类型“药物”。\n- $G_{3}: [11,12]$，类型“剂量”。\n- $G_{4}: [15,17]$，类型“问题”。\n- $G_{5}: [21,22]$，类型“问题”。\n金标准实体总数：$N_G = 5$。\n\n**原始预测实体 ($P$):**\n- $P_{1}: [3,6]$，类型“问题”。\n- $P_{2}: [10,11]$，类型“药物”。\n- $P_{3}: [11,12]$，类型“剂量”。\n- $P_{4}: [16,17]$，类型“问题”。\n- $P_{5}: [20,22]$，类型“问题”。\n- $P_{6}: [25,25]$，类型“药物”。\n预测实体总数：$N_P = 6$。\n\n**匹配机制：**\n- **严格匹配：**一个预测实体是真正例（TP），当且仅当其区间 $[s,e]$ 和类型与一个金标准实体完全相同。强制执行一对一对齐。\n- **宽松匹配：**一个预测实体是真正例（TP），当且仅当其区间与一个金标准实体的区间重叠（交集非空）且类型相同。强制执行一对一对齐，平局决胜规则是基于最大重叠，然后是金标准实体的最小起始索引。\n\n**评估指标：**\n- 精确率：$P = \\frac{\\text{TP}}{\\text{TP} + \\text{FP}}$\n- 召回率：$R = \\frac{\\text{TP}}{\\text{TP} + \\text{FN}}$\n- F1分数：$F1 = \\frac{2PR}{P+R}$\n\n**任务：**\n- **任务 A：**为原始集 $P$ 计算 $F1^{\\mathrm{strict}}$ 和 $F1^{\\mathrm{relaxed}}$。\n- **任务 B：**通过将 $P$ 中的每个区间移动 $+1$（$[s+1, e+1]$）来创建一个扰动集 $P'$。计算 $F1'^{\\mathrm{strict}}$ 和 $F1'^{\\mathrm{relaxed}}$。\n- **任务 C：**计算变化量 $\\Delta F1^{\\mathrm{strict}} = F1'^{\\mathrm{strict}} - F1^{\\mathrm{strict}}$ 和 $\\Delta F1^{\\mathrm{relaxed}} = F1'^{\\mathrm{relaxed}} - F1^{\\mathrm{relaxed}}$。\n- **最终结果：**报告为行向量 $(F1^{\\mathrm{strict}}, F1^{\\mathrm{relaxed}}, \\Delta F1^{\\mathrm{strict}}, \\Delta F1^{\\mathrm{relaxed}})$。\n\n### 第2步：使用提取的已知信息进行验证\n对问题进行有效性评估。\n1.  **科学依据：** 该问题使用了自然语言处理（NLP）领域的标准、公认的指标和概念，特别是用于评估命名实体识别（NER）系统的指标和概念。精确率、召回率、F1分数以及严格匹配和宽松匹配的概念是该领域的基础。\n2.  **适定性：** 该问题提供了所有必要的数据（金标准和预测实体）以及所有流程（匹配标准、平局决胜规则、指标公式）的清晰、明确的定义。这些任务是具体的计算练习，可导向一个唯一的、确定性的解决方案。\n3.  **客观性：** 语言正式且技术性强。定义精确。没有主观或基于意见的元素。\n4.  **主题相关性：** 该问题明确地设定在*临床命名实体识别*的背景下，这是*生物信息学和医疗数据分析*中的一个核心任务。\n\n该问题是自洽的、一致的，并遵循其所在领域的科学评估原则。\n\n### 第3步：结论与行动\n问题是**有效的**。将提供完整的解决方案。\n\n### 解决方案推导\n\n解题过程按顺序执行每个任务。\n\n**任务 A：评估原始预测集 ($P$)**\n\n**1. 严格匹配：**\n我们将每个预测实体 $P_i$ 与金标准集 $G$进行比较，以寻找区间和类型的完全匹配。\n- $P_1:[3,6]$, \"问题\" 与 $G_1:[3,6]$, \"问题\" 完全匹配。这是一个真正例（TP）。\n- $P_2:[10,11]$, \"药物\" 与 $G_2:[10,10]$, \"药物\" 不匹配（边界不同）。\n- $P_3:[11,12]$, \"剂量\" 与 $G_3:[11,12]$, \"剂量\" 完全匹配。这是一个TP。\n- $P_4:[16,17]$, \"问题\" 与 $G_4:[15,17]$, \"问题\" 不匹配（边界不同）。\n- $P_5:[20,22]$, \"问题\" 与 $G_5:[21,22]$, \"问题\" 不匹配（边界不同）。\n- $P_6:[25,25]$, \"药物\" 不匹配任何金标准实体。\n\n在严格匹配下，我们有 $2$ 个 TP：$(P_1, G_1)$ 和 $(P_3, G_3)$。\n- 真正例数量：$\\text{TP}^{\\mathrm{strict}} = 2$。\n- 假正例数量：$\\text{FP}^{\\mathrm{strict}} = N_P - \\text{TP}^{\\mathrm{strict}} = 6 - 2 = 4$。（FP 是 $P_2, P_4, P_5, P_6$）。\n- 假反例数量：$\\text{FN}^{\\mathrm{strict}} = N_G - \\text{TP}^{\\mathrm{strict}} = 5 - 2 = 3$。（FN 是 $G_2, G_4, G_5$）。\n\n现在，我们计算精确率、召回率和 F1 分数：\n- 精确率：$P^{\\mathrm{strict}} = \\frac{\\text{TP}^{\\mathrm{strict}}}{\\text{TP}^{\\mathrm{strict}} + \\text{FP}^{\\mathrm{strict}}} = \\frac{2}{2+4} = \\frac{2}{6} = \\frac{1}{3}$。\n- 召回率：$R^{\\mathrm{strict}} = \\frac{\\text{TP}^{\\mathrm{strict}}}{\\text{TP}^{\\mathrm{strict}} + \\text{FN}^{\\mathrm{strict}}} = \\frac{2}{2+3} = \\frac{2}{5}$。\n- F1分数：$F1^{\\mathrm{strict}} = \\frac{2 \\cdot P^{\\mathrm{strict}} \\cdot R^{\\mathrm{strict}}}{P^{\\mathrm{strict}} + R^{\\mathrm{strict}}} = \\frac{2 \\cdot \\frac{1}{3} \\cdot \\frac{2}{5}}{\\frac{1}{3} + \\frac{2}{5}} = \\frac{\\frac{4}{15}}{\\frac{5+6}{15}} = \\frac{4}{11}$。\n\n**2. 宽松匹配：**\n我们检查相同类型的区间之间是否存在任何重叠。\n- $P_1:[3,6]$, \"问题\" 与 $G_1:[3,6]$, \"问题\" 重叠。匹配。\n- $P_2:[10,11]$, \"药物\" 与 $G_2:[10,10]$, \"药物\" 重叠。匹配。\n- $P_3:[11,12]$, \"剂量\" 与 $G_3:[11,12]$, \"剂量\" 重叠。匹配。\n- $P_4:[16,17]$, \"问题\" 与 $G_4:[15,17]$, \"问题\" 重叠。匹配。\n- $P_5:[20,22]$, \"问题\" 与 $G_5:[21,22]$, \"问题\" 重叠。匹配。\n- $P_6:[25,25]$, \"药物\" 不与任何类型为“药物”的金标准实体（只有 $G_2$）重叠。\n\n没有预测实体与多个相同类型的金标准实体重叠，也没有金标准实体被多个相同类型的预测重叠，因此一对一对齐是直接的。\n我们找到 $5$ 个 TP：$(P_1, G_1), (P_2, G_2), (P_3, G_3), (P_4, G_4), (P_5, G_5)$。\n- $\\text{TP}^{\\mathrm{relaxed}} = 5$。\n- $\\text{FP}^{\\mathrm{relaxed}} = N_P - \\text{TP}^{\\mathrm{relaxed}} = 6 - 5 = 1$。（FP 是 $P_6$）。\n- $\\text{FN}^{\\mathrm{relaxed}} = N_G - \\text{TP}^{\\mathrm{relaxed}} = 5 - 5 = 0$。\n\n现在，我们计算指标：\n- 精确率：$P^{\\mathrm{relaxed}} = \\frac{5}{5+1} = \\frac{5}{6}$。\n- 召回率：$R^{\\mathrm{relaxed}} = \\frac{5}{5+0} = 1$。\n- F1分数：$F1^{\\mathrm{relaxed}} = \\frac{2 \\cdot \\frac{5}{6} \\cdot 1}{\\frac{5}{6} + 1} = \\frac{\\frac{10}{6}}{\\frac{11}{6}} = \\frac{10}{11}$。\n\n**任务 B：评估扰动预测集 ($P'$)**\n\n首先，我们通过将每个区间 $[s,e]$ 移动到 $[s+1, e+1]$ 来定义扰动集 $P'$。\n- $P'_{1}: [4,7]$, \"问题\"\n- $P'_{2}: [11,12]$, \"药物\"\n- $P'_{3}: [12,13]$, \"剂量\"\n- $P'_{4}: [17,18]$, \"问题\"\n- $P'_{5}: [21,23]$, \"问题\"\n- $P'_{6}: [26,26]$, \"药物\"\n\n**1. $P'$ 的严格匹配：**\n我们将每个 $P'_i$ 与金标准集 $G$ 进行比较。\n- $P'_1:[4,7]$ vs $G_1:[3,6]$。不匹配。\n- $P'_2:[11,12]$, \"药物\" vs $G_3:[11,12]$, \"剂量\"。类型不匹配。不匹配。\n- $P'$ 中没有实体的区间和类型与 $G$ 中的任何实体完全相同。\n- $\\text{TP}'^{\\mathrm{strict}} = 0$。\n- $\\text{FP}'^{\\mathrm{strict}} = N_P - \\text{TP}'^{\\mathrm{strict}} = 6 - 0 = 6$。\n- $\\text{FN}'^{\\mathrm{strict}} = N_G - \\text{TP}'^{\\mathrm{strict}} = 5 - 0 = 5$。\n\nF1分数计算如下：\n- $P'^{\\mathrm{strict}} = \\frac{0}{0+6} = 0$。\n- $R'^{\\mathrm{strict}} = \\frac{0}{0+5} = 0$。\n- $F1'^{\\mathrm{strict}} = 0$，因为精确率和召回率均为 $0$。\n\n**2. $P'$ 的宽松匹配：**\n我们检查与匹配类型的重叠。\n- $P'_1:[4,7]$, \"问题\" 与 $G_1:[3,6]$, \"问题\" 重叠。匹配。\n- $P'_2:[11,12]$, \"药物\" 与 $G_2:[10,10]$, \"药物\" 不重叠。不匹配。\n- $P'_3:[12,13]$, \"剂量\" 与 $G_3:[11,12]$, \"剂量\" 重叠。匹配。\n- $P'_4:[17,18]$, \"问题\" 与 $G_4:[15,17]$, \"问题\" 重叠。匹配。\n- $P'_5:[21,23]$, \"问题\" 与 $G_5:[21,22]$, \"问题\" 重叠。匹配。\n- $P'_6:[26,26]$, \"药物\" 与 $G_2:[10,10]$, \"药物\" 不重叠。不匹配。\n\n对齐再次变得直接。\n我们从配对 $(P'_1, G_1), (P'_3, G_3), (P'_4, G_4), (P'_5, G_5)$ 中找到 $4$ 个 TP。\n- $\\text{TP}'^{\\mathrm{relaxed}} = 4$。\n- $\\text{FP}'^{\\mathrm{relaxed}} = N_P - \\text{TP}'^{\\mathrm{relaxed}} = 6 - 4 = 2$。（FP 是 $P'_2$ 和 $P'_6$）。\n- $\\text{FN}'^{\\mathrm{relaxed}} = N_G - \\text{TP}'^{\\mathrm{relaxed}} = 5 - 4 = 1$。（FN 是 $G_2$）。\n\n现在，我们计算指标：\n- $P'^{\\mathrm{relaxed}} = \\frac{4}{4+2} = \\frac{4}{6} = \\frac{2}{3}$。\n- $R'^{\\mathrm{relaxed}} = \\frac{4}{4+1} = \\frac{4}{5}$。\n- $F1'^{\\mathrm{relaxed}} = \\frac{2 \\cdot \\frac{2}{3} \\cdot \\frac{4}{5}}{\\frac{2}{3} + \\frac{4}{5}} = \\frac{\\frac{16}{15}}{\\frac{10+12}{15}} = \\frac{16}{22} = \\frac{8}{11}$。\n\n**任务 C：量化对边界错误的敏感度**\n\n我们计算 F1 分数的变化。\n- $\\Delta F1^{\\mathrm{strict}} = F1'^{\\mathrm{strict}} - F1^{\\mathrm{strict}} = 0 - \\frac{4}{11} = -\\frac{4}{11}$。\n- $\\Delta F1^{\\mathrm{relaxed}} = F1'^{\\mathrm{relaxed}} - F1^{\\mathrm{relaxed}} = \\frac{8}{11} - \\frac{10}{11} = -\\frac{2}{11}$。\n\n**最终结果汇编**\n最终答案所需的四个分量是：\n- $F1^{\\mathrm{strict}} = \\frac{4}{11}$\n- $F1^{\\mathrm{relaxed}} = \\frac{10}{11}$\n- $\\Delta F1^{\\mathrm{strict}} = -\\frac{4}{11}$\n- $\\Delta F1^{\\mathrm{relaxed}} = -\\frac{2}{11}$\n\n将这些组合成一个单行向量。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{4}{11}  \\frac{10}{11}  -\\frac{4}{11}  -\\frac{2}{11}\n\\end{pmatrix}\n}\n$$", "id": "4547529"}]}