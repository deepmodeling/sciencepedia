{"hands_on_practices": [{"introduction": "网络分析的第一步通常是根据高通量数据构建网络。本练习将指导您完成构建加权基因共表达网络的整个过程，并评估其重要的拓扑特性，这是许多下游分析的常见起点。通过这个实践，您将掌握将原始基因表达数据转化为结构化网络并进行量化评估的基本技能。 [@problem_id:4565386]", "problem": "给定以基因-样本形式表示的、来自核糖核酸测序 (RNA-seq) 的标准化转录本丰度测量值。您的任务是通过对 Pearson 相关性绝对值进行软阈值化来构建一个加权基因共表达网络，并使用无标度拓扑拟合指数来量化所得网络对无标度拓扑的近似程度。推导和实现必须基于以下基础：将 Pearson 相关性作为衡量两个变量之间线性相关性的指标，通过相似性的单调变换构建邻接矩阵，将加权网络中每个节点的边权重之和定义为度，通过度的直方图估计经验概率质量函数，以及使用普通最小二乘线性回归和作为拟合优度度量的决定系数。\n\n根据基础定义，实现以下过程。给定一个基因-样本矩阵 $X \\in \\mathbb{R}^{G \\times S}$，其中基因由 $i \\in \\{1,\\dots,G\\}$ 索引，样本由 $s \\in \\{1,\\dots,S\\}$ 索引：\n1. 移除在所有样本 $s \\in \\{1,\\dots,S\\}$ 间样本方差恰好为零的任何基因 $i$，以避免出现未定义的相关性。\n2. 计算基因间的 Pearson 相关矩阵 $R = (r_{ij})$，其中 $r_{ij}$ 是 $X$ 的第 $i$ 行和第 $j$ 行之间的 Pearson 相关性，且 $r_{ii} = 1$。\n3. 对于每个给定的软阈值幂 $\\beta \\in \\mathbb{R}_{0}$，构建一个加权、无符号邻接矩阵 $A^{(\\beta)} = (a^{(\\beta)}_{ij})$，其中当 $i \\neq j$ 时 $a^{(\\beta)}_{ij} = |r_{ij}|^{\\beta}$，且 $a^{(\\beta)}_{ii} = 0$。\n4. 对于每个节点 $i$，计算其加权度 $k^{(\\beta)}_i = \\sum_{j=1}^{G} a^{(\\beta)}_{ij}$。\n5. 仅使用严格正度的节点（即 $k^{(\\beta)}_i  0$），通过一个具有 $B \\in \\mathbb{N}$ 个组的等间距直方图来估计经验度分布，该直方图的边界范围从 $\\min\\{k^{(\\beta)}_i : k^{(\\beta)}_i  0\\}$ 到 $\\max\\{k^{(\\beta)}_i : k^{(\\beta)}_i  0\\}$。令 $c_\\ell$ 表示第 $\\ell$ 个组的中心，$p_\\ell$ 表示第 $\\ell$ 个组中的经验概率质量，其中 $p_\\ell$ 等于第 $\\ell$ 个组中的计数除以严格正度的节点总数。舍弃任何计数为零的组，以确保 $\\log_{10}(p_\\ell)$ 有定义。\n6. 仅使用具有非零计数的组，通过普通最小二乘法拟合线性模型 $\\log_{10}(p_\\ell) = \\alpha + \\gamma \\log_{10}(c_\\ell) + \\varepsilon_\\ell$。将此次拟合的决定系数 $R^2 \\in [0,1]$ 定义为幂 $\\beta$ 的无标度拓扑拟合指数，其计算公式为 $R^2 = 1 - \\dfrac{\\sum_{\\ell} (\\hat{y}_\\ell - y_\\ell)^2}{\\sum_{\\ell} (y_\\ell - \\bar{y})^2}$，其中 $y_\\ell = \\log_{10}(p_\\ell)$ 且 $\\hat{y}_\\ell$ 为拟合值。如果非空组少于 2 个，或者 $\\{\\log_{10}(c_\\ell)\\}$ 或 $\\{\\log_{10}(p_\\ell)\\}$ 的样本方差为零，则定义 $R^2 = 0$。\n7. 对每个测试用例中提供的每个 $\\beta$ 重复步骤 3 到 6。\n\n您的程序必须为以下测试套件实现上述过程。每个测试用例提供表达矩阵 $X$、软阈值幂列表 $\\{\\beta\\}$ 和直方图组数 $B$。\n\n测试用例 1：\n- $X \\in \\mathbb{R}^{6 \\times 8}$，各行为\n  - $[\\,1,2,3,4,5,6,7,8\\,]$\n  - $[\\,2,4,6,8,10,12,14,16\\,]$\n  - $[\\,8,7,6,5,4,3,2,1\\,]$\n  - $[\\,1,1,2,2,3,3,4,4\\,]$\n  - $[\\,5,5,5,5,5,5,5,5\\,]$\n  - $[\\,1,0,1,0,1,0,1,0\\,]$\n- 软阈值幂 $\\{\\beta\\} = \\{\\,2,4,6,8,10\\,\\}$\n- 直方图组数 $B = 10$\n\n测试用例 2：\n- $X \\in \\mathbb{R}^{5 \\times 8}$，各行为\n  - $[\\,0.1,2.1,1.2,3.2,2.8,1.7,3.0,2.5\\,]$\n  - $[\\,2.0,1.1,2.2,1.3,2.1,1.4,2.0,1.6\\,]$\n  - $[\\,5.0,5.0,5.0,5.0,5.0,5.0,5.0,5.0\\,]$\n  - $[\\,1.5,1.4,1.6,1.5,1.7,1.6,1.8,1.7\\,]$\n  - $[\\,3.2,2.9,3.1,3.0,3.3,3.1,3.2,3.0\\,]$\n- 软阈值幂 $\\{\\beta\\} = \\{\\,1,2,3,4,5\\,\\}$\n- 直方图组数 $B = 8$\n\n测试用例 3：\n- $X \\in \\mathbb{R}^{4 \\times 6}$，各行为\n  - $[\\,1,2,3,4,5,6\\,]$\n  - $[\\,2,3,4,5,6,7\\,]$\n  - $[\\,3,4,5,6,7,8\\,]$\n  - $[\\,10,10,10,10,10,10\\,]$\n- 软阈值幂 $\\{\\beta\\} = \\{\\,1,3,6\\,\\}$\n- 直方图组数 $B = 5$\n\n最终输出规范：\n- 对于每个测试用例，按给定顺序为每个提供的 $\\beta$ 计算无标度拓扑拟合指数 $R^2$。将每个 $R^2$ 值四舍五入到 4 位小数（不需要“round half away from zero”；可接受标准的“round-to-nearest with ties to even”）。将所有测试用例的所有 $R^2$ 值按其计算顺序汇总到一个扁平列表中。\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，例如，“[r2_1,r2_2,r2_3]”。", "solution": "用户提供的问题经评估为**有效**。该问题以生物信息学和网络理论的原理为科学基础，特别是加权基因共表达网络分析 (WGCNA)。问题是适定的、客观的，并提供了完整、自洽的算法规范。该过程在计算上是可行的，并能导出一个唯一的、可验证的解。\n\n解决方案通过实现指定的算法来展开。核心任务是为一个根据给定基因表达矩阵 $X \\in \\mathbb{R}^{G \\times S}$ 构建的基因共表达网络计算无标度拓扑拟合指数 $R^2$。对多个软阈值幂 $\\beta$ 重复此过程。\n\n**步骤 1：基因过滤**\n首先，处理输入表达矩阵 $X$，以移除在样本间没有任何变异的基因。计算每个基因 $i$（第 $i$ 行）的样本方差。任何方差恰好为零（$\\sigma^2_i = 0$）的基因 $i$ 将从矩阵中移除。此步骤至关重要，因为对于方差为零的变量，Pearson 相关系数是未定义的。设过滤后的矩阵为 $X_{filt} \\in \\mathbb{R}^{G_{filt} \\times S}$，其中 $G_{filt}$ 是具有非零方差的基因数量。\n\n**步骤 2：Pearson 相关矩阵**\n使用过滤后的数据 $X_{filt}$ 构建相似性矩阵。相似性度量是 Pearson 相关系数 $r_{ij}$，它量化了基因 $i$ 和基因 $j$ 表达谱之间的线性关系。这将产生一个 $G_{filt} \\times G_{filt}$ 的对称相关矩阵 $R = (r_{ij})$，其中 $r_{ij} = \\frac{\\sum_{s=1}^S (X_{is} - \\bar{X}_i)(X_{js} - \\bar{X}_j)}{\\sqrt{\\sum_{s=1}^S (X_{is} - \\bar{X}_i)^2 \\sum_{s=1}^S (X_{js} - \\bar{X}_j)^2}}$。根据定义，对角线元素为 $r_{ii} = 1$。\n\n**步骤 3：加权邻接矩阵**\n对于每个指定的软阈值幂 $\\beta > 0$，相关矩阵 $R$ 被转换为一个加权邻接矩阵 $A^{(\\beta)}$。该问题指定了一个无符号网络，因此变换为 $a^{(\\beta)}_{ij} = |r_{ij}|^\\beta$。此操作会放大强相关性并抑制弱相关性，这个过程称为软阈值化。对角线元素被设置为零，$a^{(\\beta)}_{ii} = 0$，以移除网络中的自环。\n\n**步骤 4：加权节点度**\n对于网络中的每个基因（节点）$i$，计算其连接度或度 $k_i$。在加权网络中，度是连接到该节点的所有边的权重之和：$k^{(\\beta)}_i = \\sum_{j=1}^{G_{filt}} a^{(\\beta)}_{ij}$。\n\n**步骤 5：度分布**\n通过检查其度分布 $P(k)$ 来评估网络的无标度特性，$P(k)$ 给出了一个随机选择的节点其度为 $k$ 的概率。对于无标度网络，该分布遵循幂律，$P(k) \\propto k^{-\\gamma}$。为验证这一点，我们分析计算出的度 $\\{k^{(\\beta)}_i\\}$ 的分布。首先，我们只考虑具有正度的节点 $\\{k^{(\\beta)}_i : k^{(\\beta)}_i  0\\}$。这些度的经验概率分布是使用具有指定组数 $B$ 的直方图来估计的。这些组是等间距的，范围从最小正度到最大正度。对于每个组 $\\ell$，我们确定其中心 $c_\\ell$ 和经验概率 $p_\\ell$，即度落入第 $\\ell$ 组的节点数除以具有正度的节点总数。计数为零的组被舍弃。\n\n**步骤 6：无标度拓扑拟合指数 ($R^2$)**\n为了检验幂律关系，我们对度分布图的两个轴都取对数。如果 $P(k) \\propto k^{-\\gamma}$，那么 $\\log(P(k)) = C - \\gamma \\log(k)$，这是一个线性关系。因此，我们对经对数变换的直方图数据拟合一个普通最小二乘 (OLS) 线性模型：$\\log_{10}(p_\\ell) = \\alpha + \\gamma \\log_{10}(c_\\ell) + \\varepsilon_\\ell$。该线性模型的拟合优度由决定系数 $R^2$ 量化。无标度拓扑拟合指数被定义为这个 $R^2$ 值。对于简单线性回归，$R^2$ 就是自变量 $x_\\ell = \\log_{10}(c_\\ell)$ 和因变量 $y_\\ell = \\log_{10}(p_\\ell)$ 之间 Pearson 相关性的平方。该问题为计算定义了特定的边界情况：如果直方图的非空组少于 2 个，或者 $\\log_{10}(c_\\ell)$ 值集合或 $\\log_{10}(p_\\ell)$ 值集合的样本方差为零，则拟合指数 $R^2$ 定义为 0。这可以防止未定义的计算，例如对单个点进行线性拟合或在 $R^2$ 公式中除以零。\n\n对于每个测试用例中提供的列表中的每个 $\\beta$ 值，重复整个过程（步骤 3-6）。最终结果按指定要求进行汇总和格式化。", "answer": "```python\nimport numpy as np\n\ndef calculate_sft_fit(X, betas, B):\n    \"\"\"\n    Calculates the scale-free topology fit index R^2 for a series of soft-thresholding powers.\n    \n    The function implements the full procedure described in the problem:\n    1. Filter genes with zero variance.\n    2. Compute the Pearson correlation matrix.\n    3. For each beta, construct the adjacency matrix.\n    4. Compute weighted node degrees.\n    5. Estimate the degree distribution using a histogram.\n    6. Fit a linear model to the log-log transformed distribution and compute R^2.\n    \"\"\"\n    X_np = np.array(X, dtype=float)\n\n    # Step 1: Remove any gene whose sample variance is exactly zero.\n    # We use ddof=1 for sample variance, although ddof=0 would yield the same filter.\n    variances = np.var(X_np, axis=1, ddof=1)\n    X_filtered = X_np[variances  0]\n    \n    # If fewer than 2 genes remain, correlation is not meaningful for a network.\n    if X_filtered.shape[0]  2:\n        return [0.0] * len(betas)\n    \n    # Step 2: Compute the Pearson correlation matrix.\n    R_matrix = np.corrcoef(X_filtered)\n    \n    # Handle the case where corrcoef might return a scalar if only one gene passed filtering.\n    if R_matrix.ndim  2:\n        return [0.0] * len(betas)\n\n    r_squared_values = []\n\n    for beta in betas:\n        # Step 3: Construct a weighted, unsigned adjacency matrix.\n        A = np.power(np.abs(R_matrix), beta)\n        np.fill_diagonal(A, 0)\n        \n        # Step 4: Compute the weighted degree for each node.\n        k = np.sum(A, axis=1)\n        \n        # Step 5: Estimate the empirical degree distribution.\n        # Use only nodes with strictly positive degree.\n        k_pos = k[k  0]\n        \n        if len(k_pos) == 0:\n            r_squared_values.append(0.0)\n            continue\n            \n        k_min, k_max = np.min(k_pos), np.max(k_pos)\n\n        # If all positive degrees are identical, they will fall into a single bin.\n        # This is handled by the num_non_empty_bins  2 check below.\n        if np.isclose(k_min, k_max):\n            r_squared_values.append(0.0)\n            continue\n            \n        bin_edges = np.linspace(k_min, k_max, B + 1)\n        counts, _ = np.histogram(k_pos, bins=bin_edges)\n        \n        bin_centers = (bin_edges[:-1] + bin_edges[1:]) / 2.0\n        \n        # Discard bins with zero count.\n        non_empty_mask = counts  0\n        p_counts = counts[non_empty_mask]\n        c_ell = bin_centers[non_empty_mask]\n        \n        num_non_empty_bins = len(c_ell)\n        \n        # Step 6: Fit the linear model and compute the scale-free topology fit index (R^2).\n        \n        # Condition: If there are fewer than 2 nonempty bins, R^2 = 0.\n        if num_non_empty_bins  2:\n            r_squared_values.append(0.0)\n            continue\n            \n        # Calculate empirical probability mass p_ell.\n        p_ell = p_counts / len(k_pos)\n        \n        # Log-transform coordinates for linear model fitting.\n        y_log = np.log10(p_ell)\n        x_log = np.log10(c_ell)\n        \n        # Condition: If sample variance of log-coords is zero, R^2 = 0.\n        # We use ddof=1 for sample variance, matching the problem's language.\n        if np.var(x_log, ddof=1) == 0 or np.var(y_log, ddof=1) == 0:\n            r_squared_values.append(0.0)\n            continue\n            \n        # For simple linear regression, R^2 is the square of the Pearson correlation\n        # between the independent and dependent variables.\n        corr_matrix = np.corrcoef(x_log, y_log)\n        correlation = corr_matrix[0, 1]\n        \n        # Safeguard against potential NaN from corrcoef, though variance checks should prevent this.\n        if np.isnan(correlation):\n            r_squared_values.append(0.0)\n            continue\n            \n        r_squared = correlation**2\n        r_squared_values.append(r_squared)\n        \n    return r_squared_values\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"X\": [\n                [1, 2, 3, 4, 5, 6, 7, 8],\n                [2, 4, 6, 8, 10, 12, 14, 16],\n                [8, 7, 6, 5, 4, 3, 2, 1],\n                [1, 1, 2, 2, 3, 3, 4, 4],\n                [5, 5, 5, 5, 5, 5, 5, 5],\n                [1, 0, 1, 0, 1, 0, 1, 0]\n            ],\n            \"betas\": [2, 4, 6, 8, 10],\n            \"B\": 10\n        },\n        {\n            \"X\": [\n                [0.1, 2.1, 1.2, 3.2, 2.8, 1.7, 3.0, 2.5],\n                [2.0, 1.1, 2.2, 1.3, 2.1, 1.4, 2.0, 1.6],\n                [5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0],\n                [1.5, 1.4, 1.6, 1.5, 1.7, 1.6, 1.8, 1.7],\n                [3.2, 2.9, 3.1, 3.0, 3.3, 3.1, 3.2, 3.0]\n            ],\n            \"betas\": [1, 2, 3, 4, 5],\n            \"B\": 8\n        },\n        {\n            \"X\": [\n                [1, 2, 3, 4, 5, 6],\n                [2, 3, 4, 5, 6, 7],\n                [3, 4, 5, 6, 7, 8],\n                [10, 10, 10, 10, 10, 10]\n            ],\n            \"betas\": [1, 3, 6],\n            \"B\": 5\n        }\n    ]\n\n    all_results = []\n    for case in test_cases:\n        results = calculate_sft_fit(case[\"X\"], case[\"betas\"], case[\"B\"])\n        all_results.extend(results)\n\n    # Final print statement in the exact required format.\n    formatted_results = [f\"{r:.4f}\" for r in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "4565386"}, {"introduction": "在获得基因水平的统计数据（例如，来自差异表达分析）后，下一个挑战是理解它们的集体生物学意义。本练习通过指导您完成其核心计算，将排名基因列表转化为有意义的通路富集分数，从而揭示了广泛使用的基因集富集分析（GSEA）的内在机制。这项实践对于将冗长的基因列表转化为可操作的生物学见解至关重要。 [@problem_id:4565335]", "problem": "一项关于某复杂疾病的队列研究，使用带符号的统计量 $r_{i}$（对于基因 $i$）根据差异表达生成了一个基因排序列表，其中正值表示在病例中相对于对照组表达量更高，负值表示在病例中表达量更低。您将从第一性原理出发，使用基因集富集分析（Gene Set Enrichment Analysis, GSEA）评估单个通路。\n\n考虑一个包含 $N=12$ 个基因 $(g_{1},\\dots,g_{12})$ 的有序全基因组列表及其带符号的统计量\n$$\n\\begin{aligned}\ng_{1}:~ r_{1}=2.8,\\quad g_{2}:~ r_{2}=2.6,\\quad g_{3}:~ r_{3}=2.1,\\quad g_{4}:~ r_{4}=1.9,\\quad g_{5}:~ r_{5}=1.5,\\quad g_{6}:~ r_{6}=0.9,\\\\\ng_{7}:~ r_{7}=0.3,\\quad g_{8}:~ r_{8}=-0.2,\\quad g_{9}:~ r_{9}=-0.8,\\quad g_{10}:~ r_{10}=-1.2,\\quad g_{11}:~ r_{11}=-1.9,\\quad g_{12}:~ r_{12}=-2.4~,\n\\end{aligned}\n$$\n按从 $g_{1}$（正值最大）到 $g_{12}$（负值最大）的顺序排列。通路基因集为 $S=\\{g_{2},g_{5},g_{9},g_{11}\\}$。\n\n从排序列表富集的基本原理出发，定义一个在位置 $k=1,\\dots,N$ 上的运行总和统计量 $R_{k}$，该统计量满足：(i) 在基因 $g_{k}\\in S$ 的位置 $k$ 处，以一个与 $\\lvert r_{k}\\rvert^{p}$ 成正比的正权重增加，且经过缩放以使在 $S$ 上的总增量和为 $1$；(ii) 在基因 $g_{k}\\notin S$ 的位置 $k$ 处，以一个恒定的步长减少，且经过缩放以使在 $S$ 的补集上的总减量和为 $-1$；(iii) 从 $R_{0}=0$ 开始，并回到 $R_{N}=0$。采用经典的加权指数 $p=1$。\n\n使用这些定义，计算富集得分 $ES$，即 $R_{k}$ 在 $k=1,\\dots,N$ 范围内与 $0$ 的最大正偏差。然后，给定通过对此同一通路的表型标签置换获得的五个零富集得分，\n$$\nES_{\\text{null}}=\\{0.21,\\,-0.12,\\,0.25,\\,0.19,\\,-0.08\\},\n$$\n通过将观测到的 $ES$ 除以 $ES_{\\text{null}}$ 中正值的平均值，计算归一化富集得分 $NES$。\n\n最后，通过确定在达到最大正偏差 $ES$ 的位置 $k$ 或之前出现的通路基因数量，来定量解释前导边缘子集（leading-edge subset）。\n\n使用 $\\mathrm{pmatrix}$ 环境将您的最终答案表示为一个行矩阵，其条目为 $(ES,\\,NES,\\,\\text{leading-edge count})$。将 $ES$ 和 $NES$ 四舍五入到四位有效数字。", "solution": "该问题要求我们从第一性原理出发，为单个基因通路执行基因集富集分析（Gene Set Enrichment Analysis, GSEA）计算。给定一个包含 $N=12$ 个基因的排序列表及其相关的带符号统计量 $r_i$，以及一个基因集 $S=\\{g_{2},g_{5},g_{9},g_{11}\\}$。\n\n首先，我们为有序基因列表定义并计算从 $k=1$ 到 $N=12$ 的运行总和统计量 $R_k$。初始条件为 $R_0 = 0$。$R_k$ 的更新规则取决于基因 $g_k$ 是否在基因集 $S$ 中（“命中”，hit）或不在其中（“未命中”，miss）。\n\n基因集 $S$ 中的基因数量为 $|S|=4$。不在 $S$ 中的基因数量为 $|S^c| = N - |S| = 12 - 4 = 8$。\n\n对于一次命中（即 $g_k \\in S$），运行总和以一个与 $|r_k|^p$（指数 $p=1$）成正比的步长 $\\Delta R_k^{\\text{hit}}$ 增加。所有这些正增量的总和必须等于 $1$。我们首先计算归一化因子，即 $S$ 中所有基因的加权得分之和：\n$$\nN_S = \\sum_{g_i \\in S} |r_i|^p = |r_2|^1 + |r_5|^1 + |r_9|^1 + |r_{11}|^1\n$$\n使用给定值：\n$$\nN_S = |2.6| + |1.5| + |-0.8| + |-1.9| = 2.6 + 1.5 + 0.8 + 1.9 = 6.8\n$$\n因此，在位置 $k$ 处命中的增量为：\n$$\n\\Delta R_k^{\\text{hit}} = \\frac{|r_k|}{N_S} = \\frac{|r_k|}{6.8}\n$$\n\n对于一次未命中（即 $g_k \\notin S$），运行总和以一个恒定的步长 $\\Delta R_k^{\\text{miss}}$ 减少。所有这些负减量的总和必须等于 $-1$。由于有 $|S^c|=8$ 个基因不在 $S$ 中，恒定的减量为：\n$$\n\\Delta R_k^{\\text{miss}} = \\frac{-1}{|S^c|} = \\frac{-1}{8} = -0.125\n$$\n\n现在我们可以从 $R_0 = 0$ 开始，为 $k=1, \\dots, 12$ 计算运行总和 $R_k = R_{k-1} + \\Delta R_k$。\n\n$k=1$：$g_1 \\notin S$。$R_1 = R_0 + \\Delta R_1^{\\text{miss}} = 0 - 0.125 = -0.125$。\n\n$k=2$：$g_2 \\in S$。$|r_2|=2.6$。$R_2 = R_1 + \\Delta R_2^{\\text{hit}} = -0.125 + \\frac{2.6}{6.8} = -\\frac{1}{8} + \\frac{26}{68} = -\\frac{17}{136} + \\frac{52}{136} = \\frac{35}{136} \\approx 0.25735$。\n\n$k=3$：$g_3 \\notin S$。$R_3 = R_2 + \\Delta R_3^{\\text{miss}} = \\frac{35}{136} - \\frac{1}{8} = \\frac{35}{136} - \\frac{17}{136} = \\frac{18}{136} \\approx 0.13235$。\n\n$k=4$：$g_4 \\notin S$。$R_4 = R_3 + \\Delta R_4^{\\text{miss}} = \\frac{18}{136} - \\frac{17}{136} = \\frac{1}{136} \\approx 0.00735$。\n\n$k=5$：$g_5 \\in S$。$|r_5|=1.5$。$R_5 = R_4 + \\Delta R_5^{\\text{hit}} = \\frac{1}{136} + \\frac{1.5}{6.8} = \\frac{1}{136} + \\frac{15}{68} = \\frac{1}{136} + \\frac{30}{136} = \\frac{31}{136} \\approx 0.22794$。\n\n$k=6$：$g_6 \\notin S$。$R_6 = R_5 + \\Delta R_6^{\\text{miss}} = \\frac{31}{136} - \\frac{17}{136} = \\frac{14}{136} \\approx 0.10294$。\n\n$k=7$：$g_7 \\notin S$。$R_7 = R_6 + \\Delta R_7^{\\text{miss}} = \\frac{14}{136} - \\frac{17}{136} = -\\frac{3}{136} \\approx -0.02206$。\n\n$k=8$：$g_8 \\notin S$。$R_8 = R_7 + \\Delta R_8^{\\text{miss}} = -\\frac{3}{136} - \\frac{17}{136} = -\\frac{20}{136} \\approx -0.14706$。\n\n$k=9$：$g_9 \\in S$。$|r_9|=0.8$。$R_9 = R_8 + \\Delta R_9^{\\text{hit}} = -\\frac{20}{136} + \\frac{0.8}{6.8} = -\\frac{20}{136} + \\frac{8}{68} = -\\frac{20}{136} + \\frac{16}{136} = -\\frac{4}{136} \\approx -0.02941$。\n\n$k=10$：$g_{10} \\notin S$。$R_{10} = R_9 + \\Delta R_{10}^{\\text{miss}} = -\\frac{4}{136} - \\frac{17}{136} = -\\frac{21}{136} \\approx -0.15441$。\n\n$k=11$：$g_{11} \\in S$。$|r_{11}|=1.9$。$R_{11} = R_{10} + \\Delta R_{11}^{\\text{hit}} = -\\frac{21}{136} + \\frac{1.9}{6.8} = -\\frac{21}{136} + \\frac{19}{68} = -\\frac{21}{136} + \\frac{38}{136} = \\frac{17}{136} = \\frac{1}{8} = 0.125$。\n\n$k=12$：$g_{12} \\notin S$。$R_{12} = R_{11} + \\Delta R_{12}^{\\text{miss}} = \\frac{1}{8} - \\frac{1}{8} = 0$。\n条件 $R_N=0$ 得到满足，这证实了我们的计算。\n\n富集得分（$ES$）是运行总和与 $0$ 的最大正偏差，即集合 $\\{R_1, \\dots, R_{12}\\}$ 中的最大值。\n$$\nES = \\max_{k \\in \\{1, \\dots, 12\\}} R_k = R_2 = \\frac{35}{136} \\approx 0.2573529...\n$$\n四舍五入到四位有效数字，$ES \\approx 0.2574$。\n\n接下来，我们计算归一化富集得分（$NES$）。给定一组零富集得分：$ES_{\\text{null}}=\\{0.21, -0.12, 0.25, 0.19, -0.08\\}$。我们需要计算该集合中正值的平均值。\n正值为 $\\{0.21, 0.25, 0.19\\}$。\n$$\n\\text{mean}(ES_{\\text{null, pos}}) = \\frac{0.21 + 0.25 + 0.19}{3} = \\frac{0.65}{3} \\approx 0.21666...\n$$\n$NES$ 是观测到的 $ES$ 除以这个平均值：\n$$\nNES = \\frac{ES}{\\text{mean}(ES_{\\text{null, pos}})} = \\frac{35/136}{0.65/3} = \\frac{35}{136} \\times \\frac{3}{0.65} = \\frac{105}{88.4} = \\frac{1050}{884} = \\frac{525}{442} \\approx 1.1877828...\n$$\n四舍五入到四位有效数字，$NES \\approx 1.188$。\n\n最后，我们确定前导边缘子集。该子集包含在达到 $ES$ 的位置或之前出现在排序列表中的 $S$ 内的基因。运行总和的最大值 $ES$ 出现在位置 $k=2$。到此位置为止的排序列表中的基因为 $\\{g_1, g_2\\}$。\n我们求这个集合与基因集 $S$ 的交集：\n$$\n\\text{Leading-Edge Genes} = \\{g_k | k \\le 2\\} \\cap S = \\{g_1, g_2\\} \\cap \\{g_2, g_5, g_9, g_{11}\\} = \\{g_2\\}\n$$\n前导边缘子集中的基因数量是此集合中元素的个数。\n$$\n\\text{leading-edge count} = |\\{g_2\\}| = 1\n$$\n\n最终所需的值是 $ES \\approx 0.2574$，$NES \\approx 1.188$，以及前导边缘计数为 $1$。", "answer": "$$\n\\boxed{\\begin{pmatrix} 0.2574  1.188  1 \\end{pmatrix}}\n$$", "id": "4565335"}, {"introduction": "当同时分析数千个生物学通路时，假阳性的风险会显著增加，因此必须进行统计学校正。本练习将教授一种关键的统计方法——Benjamini-Hochberg程序，以控制假发现率（FDR）。掌握这项技术对于从大量结果中筛选出真正显著的通路至关重要，是确保功能分析结论可靠性的基石。 [@problem_id:4565348]", "problem": "一项病例-对照基因集富集分析在一个疾病队列中评估了多个功能通路，通过对 $m=12$ 个预定义通路进行独立的关联性检验，得到了各通路的名义$p$值。在高维多重检验中，错误发现率 (False Discovery Rate, FDR) 定义为在所有被拒绝的原假设中，实际上为真的原假设（即错误拒绝）所占的期望比例。为了将FDR控制在目标水平，Benjamini-Hochberg (BH) 程序为每个通路分配了校正后的$q$值。使用以下通路列表及其名义$p$值，计算所有通路的经BH校正后的$q$值，然后确定在FDR阈值 $\\alpha=0.05$ 下，有多少个通路将被宣布为显著。将显著通路的数量作为你的最终答案。\n\n各通路及其$p$值为：\nDNA损伤应答：$0.0009$；干扰素γ应答：$0.004$；活化B细胞核因子κ-轻链增强子 (NF-$\\kappa$B) 信号通路：$0.012$；糖酵解与葡萄糖代谢：$0.018$；细胞凋亡：$0.021$；丝裂原活化蛋白激酶 (MAPK) 级联反应：$0.035$；T细胞受体信号通路：$0.048$；缺氧：$0.06$；磷脂酰肌醇3-激酶 - 蛋白激酶B (PI3K-AKT) 信号通路：$0.11$；雷帕霉素靶蛋白 (mTOR) 信号通路：$0.17$；Wnt (Wingless-related integration site) 信号通路：$0.24$；血管生成：$0.5$。\n\n假设通路水平的检验是独立的，或在某个子集上满足正回归依赖性，因此BH程序能在名义水平上控制FDR。在解释你的推理过程时，请提供一个基于科学的FDR控制解释，但最终报告的量必须是在 $\\alpha=0.05$ 水平下显著通路的整数数量。最终答案无需四舍五入。", "solution": "该问题要求将Benjamini-Hochberg (BH) 程序应用于一组来自基因集富集分析的名义$p$值，以控制错误发现率 (FDR)，然后确定在指定的FDR阈值下具有统计显著性的通路数量。\n\n首先，我们建立理论背景。在多重假设检验中，当同时进行许多 statistical 检验时，犯I类错误（假阳性）的风险会增加。错误发现率是一种用于校正此问题的统计方法。FDR定义为在所有被拒绝的原假设（总发现）中，被错误拒绝的原假设（错误发现）所占比例的期望值。令 $V$ 为被错误拒绝的真实原假设的数量， $R$ 为被拒绝的原假设的总数。FDR由 $E\\left[\\frac{V}{R}\\right]$ 给出，其中如果 $R=0$，则该分数为 $0$。Benjamini-Hochberg程序提供了一种将此FDR控制在指定水平 $\\alpha$ 的方法。\n\n问题提供了 $m=12$ 个通路及其对应的名义$p$值。步骤如下：\n1.  令各个$p$值为 $p_1, p_2, \\ldots, p_m$。\n2.  将这些$p$值按升序排列：$p_{(1)} \\le p_{(2)} \\le \\ldots \\le p_{(m)}$。\n3.  对于每个排序后的$p$值 $p_{(k)}$，计算其对应的经BH校正后的$p$值，即$q$值。对于具有第 $k$ 小的 $p$ 值的检验，其$q$值表示为 $q_{(k)}$，由以下公式给出：\n$$q_{(k)} = \\min_{j=k, \\dots, m} \\left( \\frac{m \\cdot p_{(j)}}{j} \\right)$$\n这个公式确保了校正后的$q$值序列是单调非递减的，即 $q_{(1)} \\le q_{(2)} \\le \\ldots \\le q_{(m)}$。一种实用的计算方法是，首先为每个秩 $k$ 计算中间值 $\\frac{m \\cdot p_{(k)}}{k}$，然后通过从 $k=m$ 到 $k=1$ 反向迭代来强制执行单調性。具体来说，$q_{(m)} = p_{(m)}$，并且对于 $k = m-1, \\ldots, 1$，我们有 $q_{(k)} = \\min\\left(q_{(k+1)}, \\frac{m \\cdot p_{(k)}}{k}\\right)$。\n4.  如果一个假设的校正$q$值小于或等于FDR阈值 $\\alpha$，则拒绝该假设（即宣布该通路是显著的）。\n\n给定的数据是：\n检验总数（通路数），$m = 12$。\nFDR阈值，$\\alpha = 0.05$。\n名义$p$值已按升序排列：\n$p_{(1)} = 0.0009$\n$p_{(2)} = 0.004$\n$p_{(3)} = 0.012$\n$p_{(4)} = 0.018$\n$p_{(5)} = 0.021$\n$p_{(6)} = 0.035$\n$p_{(7)} = 0.048$\n$p_{(8)} = 0.06$\n$p_{(9)} = 0.11$\n$p_{(10)} = 0.17$\n$p_{(11)} = 0.24$\n$p_{(12)} = 0.5$\n\n我们现在为从 $1$ 到 $12$ 的每个秩 $k$ 计算校正后的$q$值，$q_{(k)}$。我们将通过从 $k=12$ 向下迭代到 $k=1$ 来计算它们。\n\n对于 $k=12$：$q_{(12)} = \\frac{12 \\cdot p_{(12)}}{12} = p_{(12)} = 0.5$。\n对于 $k=11$：$q_{(11)} = \\min\\left(q_{(12)}, \\frac{12 \\cdot p_{(11)}}{11}\\right) = \\min\\left(0.5, \\frac{12 \\cdot 0.24}{11}\\right) = \\min\\left(0.5, \\frac{2.88}{11}\\right) = \\min(0.5, 0.26\\overline{18}) = 0.26\\overline{18}$。\n对于 $k=10$：$q_{(10)} = \\min\\left(q_{(11)}, \\frac{12 \\cdot p_{(10)}}{10}\\right) = \\min\\left(0.26\\overline{18}, \\frac{12 \\cdot 0.17}{10}\\right) = \\min(0.26\\overline{18}, 0.204) = 0.204$。\n对于 $k=9$：$q_{(9)} = \\min\\left(q_{(10)}, \\frac{12 \\cdot p_{(9)}}{9}\\right) = \\min\\left(0.204, \\frac{12 \\cdot 0.11}{9}\\right) = \\min(0.204, 0.14\\overline{6}) = 0.14\\overline{6}$。\n对于 $k=8$：$q_{(8)} = \\min\\left(q_{(9)}, \\frac{12 \\cdot p_{(8)}}{8}\\right) = \\min\\left(0.14\\overline{6}, \\frac{12 \\cdot 0.06}{8}\\right) = \\min(0.14\\overline{6}, 0.09) = 0.09$。\n对于 $k=7$：$q_{(7)} = \\min\\left(q_{(8)}, \\frac{12 \\cdot p_{(7)}}{7}\\right) = \\min\\left(0.09, \\frac{12 \\cdot 0.048}{7}\\right) = \\min\\left(0.09, \\frac{0.576}{7}\\right) \\approx \\min(0.09, 0.08228) \\approx 0.08228$。我们将使用精确分数 $\\frac{0.576}{7}$。所以 $q_{(7)} = \\frac{0.576}{7}$。\n对于 $k=6$：$q_{(6)} = \\min\\left(q_{(7)}, \\frac{12 \\cdot p_{(6)}}{6}\\right) = \\min\\left(\\frac{0.576}{7}, \\frac{12 \\cdot 0.035}{6}\\right) = \\min(\\frac{0.576}{7}, 0.07) \\approx \\min(0.08228, 0.07) = 0.07$。\n对于 $k=5$：$q_{(5)} = \\min\\left(q_{(6)}, \\frac{12 \\cdot p_{(5)}}{5}\\right) = \\min\\left(0.07, \\frac{12 \\cdot 0.021}{5}\\right) = \\min(0.07, 0.0504) = 0.0504$。\n对于 $k=4$：$q_{(4)} = \\min\\left(q_{(5)}, \\frac{12 \\cdot p_{(4)}}{4}\\right) = \\min\\left(0.0504, \\frac{12 \\cdot 0.018}{4}\\right) = \\min(0.0504, 0.054) = 0.0504$。\n对于 $k=3$：$q_{(3)} = \\min\\left(q_{(4)}, \\frac{12 \\cdot p_{(3)}}{3}\\right) = \\min\\left(0.0504, \\frac{12 \\cdot 0.012}{3}\\right) = \\min(0.0504, 0.048) = 0.048$。\n对于 $k=2$：$q_{(2)} = \\min\\left(q_{(3)}, \\frac{12 \\cdot p_{(2)}}{2}\\right) = \\min\\left(0.048, \\frac{12 \\cdot 0.004}{2}\\right) = \\min(0.048, 0.024) = 0.024$。\n对于 $k=1$：$q_{(1)} = \\min\\left(q_{(2)}, \\frac{12 \\cdot p_{(1)}}{1}\\right) = \\min\\left(0.024, \\frac{12 \\cdot 0.0009}{1}\\right) = \\min(0.024, 0.0108) = 0.0108$。\n\n与排序后的$p$值相对应的BH校正$q$值的完整列表是：\n$q_{(1)} = 0.0108$ (DNA损伤应答)\n$q_{(2)} = 0.024$ (干扰素γ应答)\n$q_{(3)} = 0.048$ (NF-$\\kappa$B信号通路)\n$q_{(4)} = 0.0504$ (糖酵解与葡萄糖代謝)\n$q_{(5)} = 0.0504$ (细胞凋亡)\n$q_{(6)} = 0.07$ (MAPK级联反应)\n$q_{(7)} \\approx 0.0823$ (T细胞受体信号通路)\n$q_{(8)} = 0.09$ (缺氧)\n$q_{(9)} \\approx 0.1467$ (PI3K-AKT信号通路)\n$q_{(10)} = 0.204$ (mTOR信号通路)\n$q_{(11)} \\approx 0.2618$ (Wnt信号通路)\n$q_{(12)} = 0.5$ (血管生成)\n\n最后一步是确定在FDR阈值 $\\alpha = 0.05$ 下显著的通路。我们拒绝任何$q$值小于或等于 $0.05$ 的通路的原假设。\n- 通路 1 (DNA损伤应答): $q_{(1)} = 0.0108 \\le 0.05$。显著。\n- 通路 2 (干扰素γ应答): $q_{(2)} = 0.024 \\le 0.05$。显著。\n- 通路 3 (NF-$\\kappa$B信号通路): $q_{(3)} = 0.048 \\le 0.05$。显著。\n- 通路 4 (糖酵解与葡萄糖代謝): $q_{(4)} = 0.0504 > 0.05$。不显著。\n\n由于$q$值是单调非递减的，所有后续通路（从秩 $5$ 到 $12$）的$q$值也将大于 $0.05$。因此，它们不显著。\n\n计算显著通路的数量，我们发现有 $3$ 个。", "answer": "$$\\boxed{3}$$", "id": "4565348"}]}