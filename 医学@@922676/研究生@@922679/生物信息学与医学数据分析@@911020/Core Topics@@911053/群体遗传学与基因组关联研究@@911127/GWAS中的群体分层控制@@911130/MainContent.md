## 引言
在人类遗传学研究中，全基因组关联研究（GWAS）已成为识别与复杂性状和疾病相关的遗传变异的强大引擎。然而，这一探索之旅充满了统计学挑战，其中最普遍且最具误导性的障碍之一便是**群体分层（population stratification）**。当研究样本包含来自不同祖源背景的个体时，系统性的遗传和环境差异可能交织在一起，产生大量虚假的关联信号，从而掩盖真实的生物学发现，并误导后续的研究方向。因此，准确识别并有效控制[群体分层](@entry_id:175542)，是确保GWAS结果可靠性的绝对前提。

本篇文章旨在为读者提供一个关于GWAS中群体分层控制的全面指南。我们将系统性地解决“群体分层为何会产生问题”以及“我们该如何应对”这两个核心议题。通过以下三个章节的深入学习，您将掌握从理论到实践的全套知识体系：
*   在“**原理与机制**”一章中，我们将从统计学第一性原理出发，剖析群体分层导致混杂的数学本质，并详细介绍[主成分分析](@entry_id:145395)（PCA）、[线性混合模型](@entry_id:139702)（LMM）等核心校正方法的内在逻辑及其假设。
*   在“**应用与跨学科联系**”一章中，我们将视野扩展到真实世界的研究场景，探讨这些控制策略如何在临床GWAS、跨族裔研究、稀有变异分析中应用，并揭示其对[孟德尔随机化](@entry_id:147183)、多基因评分等下游因果推断的深远影响。
*   最后，在“**实践操作**”部分，您将通过一系列精心设计的问题，亲手实践关键概念的计算与推导，从而将理论知识内化为解决实际问题的能力。

现在，让我们从[群体分层](@entry_id:175542)的根本原理开始，深入理解这一挑战的统计学基础。

## 原理与机制

在上一章对[全基因组](@entry_id:195052)关联研究（GWAS）的基本概念进行介绍之后，本章将深入探讨一个核心的方法学挑战：[群体分层](@entry_id:175542)（population stratification）的控制。[群体分层](@entry_id:175542)是[GWAS分析](@entry_id:264205)中最主要的混杂因素之一，如果处理不当，会导致大量的[假阳性](@entry_id:635878)关联，从而严重误导研究结论。本章旨在阐释群体分层的基本原理、其对关联分析统计量的影响，并系统地介绍几种主流的控制策略及其背后的机制，包括[主成分分析](@entry_id:145395)（Principal Component Analysis, PCA）、[线性混合模型](@entry_id:139702)（Linear Mixed Models, LMMs）以及[连锁不平衡分数回归](@entry_id:149170)（Linkage Disequilibrium Score Regression, LDSC）。

### 群体分层的统计学本质

从根本上说，**[群体分层](@entry_id:175542)**是一种由系统性祖源差异引起的混杂（confounding）。在一个由多个祖源亚群混合而成的研究队列中，如果等位基因频率在不同亚群间存在系统性差异，同时表型的均值也因环境、生活方式或多基因背景等与祖源相关的因素而不同，那么即使某个基因座（locus）与表型之间没有直接的因果关系，我们也能在混合群体中观察到虚假的统计学关联。

#### 基于协[方差分解](@entry_id:272134)的理解

我们可以利用**总协方差定律**（Law of Total Covariance）来精确地描述这一现象。假设在一个混合群体中，我们研究一个基因型变量 $G$（例如，某个SNP的次要等位基因计数，$G \in \{0, 1, 2\}$）和一个连续表型 $Y$。令 $S$ 表示一个离散的祖源指示变量，例如，代表个体所属的大陆祖源（$S \in \{A, B\}$）。$G$ 和 $Y$ 在整个混合群体中的协方差 $\operatorname{Cov}(G, Y)$ 可以分解为两部分：

$$
\operatorname{Cov}(G,Y) = \mathbb{E}[\operatorname{Cov}(G,Y \mid S)] + \operatorname{Cov}(\mathbb{E}[G \mid S], \mathbb{E}[Y \mid S])
$$

第一项 $\mathbb{E}[\operatorname{Cov}(G,Y \mid S)]$ 代表“组内协方差的期望”，即在控制了祖源背景后，$G$ 和 $Y$ 的平均协方差。在理想的零假设下（即 $G$ 对 $Y$ 没有因果效应，并且没有其他未控制的组内混杂因素），这一项的期望为零。

第二项 $\operatorname{Cov}(\mathbb{E}[G \mid S], \mathbb{E}[Y \mid S])$ 代表“期望的协方差”，衡量的是基因型和表型的[期望值](@entry_id:150961)如何随着祖源 $S$ 的变化而共同变化。具体来说：
-   $\mathbb{E}[G \mid S]$ 是给定祖源 $S$ 时基因型的[期望值](@entry_id:150961)，它直接反映了该祖源群体的等位基因频率。如果不同祖源群体的[等位基因频率](@entry_id:146872)不同（例如 $\mu_G^{(A)} \neq \mu_G^{(B)}$），$\mathbb{E}[G \mid S]$ 就会随 $S$ 而变。
-   $\mathbb{E}[Y \mid S]$ 是给定祖源 $S$ 时表型的[期望值](@entry_id:150961)。如果不同祖源群体的平均表型水平不同（$\mu_Y^{(A)} \neq \mu_Y^{(B)}$），这可能是由于环境暴露、文化习惯或背景多基因效应的差异所致，那么 $\mathbb{E}[Y \mid S]$ 也会随 $S$ 而变。

当这两个条件同时满足时，即使组内协方差为零，第二项 $\operatorname{Cov}(\mathbb{E}[G \mid S], \mathbb{E}[Y \mid S])$ 也会非零。这正是群体分层产生虚假关联的数学根源 [@problem_id:4596462]。祖源 $S$ 仿佛一个共同的“原因”，同时影响了等位基因的分布和表型的分布（即 $G \leftarrow S \rightarrow Y$），从而在 $G$ 和 $Y$ 之间制造了一条非因果的关联通路。

#### 基于连续祖源模型的理解

上述离散祖源模型可以推广到更真实的连续祖源[混合模型](@entry_id:266571)。假设每个个体的祖源成分可以用一个连续变量 $Z \in [0,1]$ 来表示（例如，来自某个参考群体的祖源比例）。我们可以构建一个生成模型 [@problem_id:4596475]：
-   基因型 $G$ 的[期望值](@entry_id:150961)依赖于 $Z$：$\mathbb{E}[G \mid Z] = 2 p(Z)$，其中等位基因频率 $p(Z) = p_0 + b Z$ 是 $Z$ 的线性函数。系数 $b$ 反映了等位基因频率随祖源变化的程度。
-   表型 $Y$ 的[期望值](@entry_id:150961)也依赖于 $Z$：$Y = \mu_0 + d Z + \varepsilon$，其中 $\varepsilon$ 是与 $G$ 和 $Z$ 无关的随机噪音。系数 $d$ 反映了表型随祖源变化的程度。

在这个模型中，祖源 $Z$ 仍然是 $G$ 和 $Y$ 的共同影响因素。再次运用总协方差定律，我们可以推导出 $G$ 和 $Y$ 之间的总体协方差：
$$
\operatorname{Cov}(G, Y) = \operatorname{Cov}(2p_0 + 2bZ, \mu_0 + dZ) = 2 b d \operatorname{Var}(Z)
$$
这个简洁的公式清晰地表明，只要[等位基因频率](@entry_id:146872)和表型都随着祖源变化（即 $b \neq 0$ 且 $d \neq 0$），并且群体中存在祖源差异（即 $\operatorname{Var}(Z) \gt 0$），那么即使在模型中没有直接的 $G \to Y$ 路径，也会产生非零的协方差。

#### 群体分层对关联检验统计量的影响

群体分层导致的虚假关联并非微不足道的效应，它能够显著地夸大关联检验的统计量，导致I类错误率（Type I error rate）的急剧膨胀。我们可以通过一个具体的数值例子来感受其影响 [@problem_id:4596571]。

假设一个病例-对照研究，包含1000名病例和1000名对照。群体由两个祖源亚群 $S_1$ 和 $S_2$ 混合而成。
-   在病例组中，来自 $S_1$ 的个体占 $w_{\text{case}} = 0.8$。
-   在[对照组](@entry_id:188599)中，来自 $S_1$ 的个体占 $w_{\text{ctrl}} = 0.2$。
-   某个SNP的等位基因 $A$ 在 $S_1$ 中的频率为 $p_1 = 0.8$，在 $S_2$ 中的频率为 $p_2 = 0.2$。
-   关键假设：该SNP在任何一个亚群内部都与疾病无关（即组内无关联）。

在这种情况下，由于病例组和[对照组](@entry_id:188599)的祖源构成不同，导致两组的等位基因频率被人为地拉开了差距：
-   病例组中等位基因 $A$ 的频率：$p_{\text{case}} = w_{\text{case}} p_{1} + (1 - w_{\text{case}}) p_{2} = (0.8)(0.8) + (0.2)(0.2) = 0.68$
-   [对照组](@entry_id:188599)中等位基因 $A$ 的频率：$p_{\text{ctrl}} = w_{\text{ctrl}} p_{1} + (1 - w_{\text{ctrl}}) p_{2} = (0.2)(0.8) + (0.8)(0.2) = 0.32$

尽管该SNP本身并非致病基因，但由于它与祖源相关，而祖源又与疾病状态相关，导致它在病例和[对照组](@entry_id:188599)之间表现出显著的频率差异。如果我们忽略祖源信息，直接进行等位基因关联检验（例如，使用[Pearson卡方检验](@entry_id:272929)），构建的 $2 \times 2$ 列联表将产生一个巨大的卡方值。经过计算，该检验的卡方统计量 $X^2$ 约为 $518.4$，远远超过了在零假设下期望为1的 $\chi^2(1)$ 分布。这个结果对应的P值将达到天文数字般的显著性，从而产生一个极其“显著”的[假阳性](@entry_id:635878)信号。这个问题在全基因组尺度上普遍存在，会导致GWAS结果中出现大量 spurious associations。

### 控制策略I：主成分分析（PCA）

最直观和广泛使用的群体分层控制方法之一是主成分分析（PCA）。其核心思想是，既然群体结构是混杂的根源，那么我们可以在关联分析中将代表[群体结构](@entry_id:148599)的变量作为协变量进行校正。PCA正是一种从高维基因型数据中提取低维度的、能够反映主要祖源结构信息的变量的强大工具。

#### PCA的原理与应用

在GWAS中，PCA通常应用于一个包含成千上万个SNP的标准化基因型矩阵 $\mathbf{X} \in \mathbb{R}^{n \times p}$，其中 $n$ 是个体数量，$p$ 是SNP数量。矩阵的每一行代表一个个体，每一列代表一个SNP。对基因型矩阵进行标准化的目的是为了消除等位基因频率差异对SNP方差的影响，使得每个SNP对结构推断的贡献更加均衡 [@problem_id:4596588]。

PCA的目标是找到一组正交的“[主方向](@entry_id:276187)”（principal directions），数据在这些方向上的投影方差最大。从数学上讲，这些主方向是SNP-SNP样本协方差矩阵 $\mathbf{S} = \frac{1}{n-1}\mathbf{X}^\top \mathbf{X}$ 的特征向量（eigenvectors）。
-   第一个主方向 $\mathbf{v}_1$ 是最大化投影方差 $\text{Var}(\mathbf{Xv})$ 的单位向量。
-   第二个[主方向](@entry_id:276187) $\mathbf{v}_2$ 在与 $\mathbf{v}_1$ 正交的约束下，最大化剩余的投影方差，以此类推。

为什么这些[主方向](@entry_id:276187)能反映祖源结构呢？这是因为在混合群体中，系统性的祖源差异是基因型数据中最主要的变异来源。根据前面提到的祖源[混合模型](@entry_id:266571)，基因型矩阵 $\mathbf{X}$ 可以近似地看作一个低秩结构（low-rank structure）与随机噪音的叠加。这个低秩结构是由少数几个（比如 $r$ 个）祖源群体贡献的。因此，$\mathbf{X}^\top \mathbf{X}$ 这个协方差矩阵的特征值谱会呈现出少数几个大的特征值和大量接近于零的特征值。与这些大特征值对应的特征向量（即[主方向](@entry_id:276187)）张成了一个能够捕捉主要祖源分化模式的低维子空间 [@problem_id:4596588]。

将每个个体（$\mathbf{X}$的每一行）投影到这些[主方向](@entry_id:276187)上，我们就能得到一系列的**主成分（Principal Components, PCs）**得分。例如，第 $k$ 个PC得分向量为 $\mathbf{s}_k = \mathbf{X}\mathbf{v}_k$。这些PC得分向量是量化的祖源信息，例如，PC1可能区分了欧洲和亚洲祖源，PC2可能区分了东亚和南亚祖源。

在GWAS中，控制群体分层的标准做法是将前 $k$ 个主成分（例如，PC1到PC10）作为协变量纳入每个SNP的回归模型中：
$$
y = \beta_0 + \beta_g g + \beta_1 \text{PC}_1 + \dots + \beta_k \text{PC}_k + \text{other covariates} + \epsilon
$$
通过这种方式，我们检验的是在控制了主要祖源背景之后，$g$ 对 $y$ 的“直接”效应，从而有效地消除了由[群体分层](@entry_id:175542)引起的混杂。

#### PCA方法的挑战与权衡

虽然PCA方法直观有效，但在实践中也面临挑战，最核心的是如何选择纳入模型的主成分数量 $k$ [@problem_id:4596527]。这是一个典型的**[偏差-方差权衡](@entry_id:138822)（bias-variance trade-off）**问题：
-   **过小的 $k$**：如果纳入的PCs不足以完全捕捉导致混杂的祖源结构（例如，在存在复杂或精细尺度[群体结构](@entry_id:148599)时），就会存在**残余混杂（residual confounding）**，导致关联检验的偏差（bias）和P值的膨胀。
-   **过大的 $k$**：纳入过多的PCs，尤其是那些只解释了少量方差的PCs，可能会导致**过度拟合（overfitting）**。这会增加SNP效应估计值 $\hat{\beta}_g$ 的方差，因为待测SNP $g$ 的一部分变异可能会被众多PCs所解释（即共線性问题），从而降低检验的统计功效（power）。

因此，选择一个最优的 $k$ 值至关重要。实践中，研究者通常会结合多种策略来确定 $k$，例如检查特征值的“[碎石图](@entry_id:143396)”（scree plot）以寻找“[拐点](@entry_id:144929)”，或监测基因组膨胀因子（genomic inflation factor, $\lambda_{GC}$）随纳入PCs数量的变化，目标是使其接近1。

### 控制策略II：[线性混合模型](@entry_id:139702)（LMM）

[线性混合模型](@entry_id:139702)（LMM）提供了一种更为整合和强大的方法来控制群体分层，它尤其擅长同时处理广泛的群体结构和样本中隐藏的**亲缘关系（cryptic relatedness）**。

#### LMM的原理

LMM的核心思想是将个体的表型 $y$ 建模为固定效应（fixed effects）和随机效应（random effects）的和。在GWAS中，待测SNP的效应被当作固定效应，而由[全基因组](@entry_id:195052)所有其他SNP共同构成的多基因背景效应则被建模为一个随机效应 [@problem_id:4596538]。

标准LMM模型如下：
$$
\mathbf{y} = \mathbf{X}\boldsymbol{\alpha} + \mathbf{g}\beta + \mathbf{u} + \boldsymbol{\epsilon}
$$
其中：
-   $\mathbf{y}$ 是 $N \times 1$ 的表型向量。
-   $\mathbf{X}$ 是固定效应协变量矩阵（如年龄、性别和PCs），$\boldsymbol{\alpha}$ 是其效应系数。
-   $\mathbf{g}$ 是待测SNP的基因型向量，$\beta$ 是其固定效应大小，也是我们希望检验的目标。
-   $\boldsymbol{\epsilon}$ 是独立的[随机误差](@entry_id:144890)向量，$\boldsymbol{\epsilon} \sim \mathcal{N}(0, \sigma_e^2 \mathbf{I})$。
-   $\mathbf{u}$ 是关键的随机效应向量，代表了多基因背景效应。它被假设服从一个均值为0的[多元正态分布](@entry_id:175229)，其协方差结构由基因组数据决定：
    $$
    \mathbf{u} \sim \mathcal{N}(0, \sigma_g^2 \mathbf{K})
    $$

这里的 $\mathbf{K}$ 是一个 $N \times N$ 的**[遗传相关](@entry_id:176283)矩阵（Genetic Relationship Matrix, GRM）**。$\mathbf{K}$ 的每个元素 $K_{ij}$ 量化了个体 $i$ 和个体 $j$ 在[全基因组](@entry_id:195052)水平上的遗传相似度，通常通过标准化的基因型矩阵 $\mathbf{Z}$ 计算得到：$\mathbf{K} = \frac{1}{M} \mathbf{Z} \mathbf{Z}^\top$。$\sigma_g^2$ 是由该多基因背景解释的[表型方差](@entry_id:274482)。

LMM之所以能有效控制[群体分层](@entry_id:175542)和亲缘关系，关键在于这个随机效应项 $\mathbf{u}$。[遗传相关](@entry_id:176283)矩阵 $\mathbf{K}$ 精确地捕捉了样本中所有个体间的成对遗传相似性。
-   对于来自同一祖源亚群的两个个体，他们的基因型向量在[全基因组](@entry_id:195052)上会更相似，导致他们之间的 $K_{ij}$ 值偏高。这在 $\mathbf{K}$ 矩阵中体现为块状结构（block structure）[@problem_id:4596538]。
-   对于有亲缘关系的两个个体（如兄弟姐妹或堂表亲），他们共享大段的DNA，导致他们之间的 $K_{ij}$ 值非常高。这在 $\mathbf{K}$ 矩阵中体现为稀疏的、数值很高的离群点 [@problem_id:4596573]。

通过在模型中明确包含一个协方差与 $\mathbf{K}$ 成比例的随机效应，LMM能够“吸收”掉所有与全基因组遗传相似性相关的表型协方差。这意味着，任何由群体结构或亲缘关系导致的身高、体重或疾病风险的相似性，都会被归因于随机效应 $\mathbf{u}$，从而使得对固定效应 $\beta$ 的估计不受这些混杂因素的影响。

#### LMM与PCA的关系

LMM和PCA这两种方法并非毫无关联。事实上，LMM可以被看作是PCA校正方法的一种更高级、更自动化的形式。从[谱分解](@entry_id:173707)（spectral decomposition）的角度看，LMM的解在数学上等价于将数据旋转到GRM矩阵 $\mathbf{K}$ 的特征向量（也就是PCs）所定义的空间中，然后对每个PC的效应进行收缩（shrinkage）[@problem_id:4596527]。与PCA方法中“硬性”地选择前 $k$ 个PCs并给予它们完全的权重，而舍弃其余所有PCs不同，LMM对所有PCs的贡献都进行了建模，但根据它们对应的特征值（即解释方差的能力）和模型的方差组分估计，对它们的效应进行了平滑的、数据驱动的加权。这种内在的**正则化（regularization）**机制，使得LMM能够优雅地处理[偏差-方差权衡](@entry_id:138822)，而无需研究者手动选择一个最优的 $k$ 值。

### 诊断与区分：QQ图与LDSC

在应用了校正方法后，我们需要工具来诊断关联分析结果是否存在残余的P值膨胀，并试图区分这种膨胀是源于未完全校正的混杂，还是源于真实的、广泛分布的遗传效应（即**多基因性, polygenicity**）。

#### [分位数-分位数图](@entry_id:174944)（QQ图）

QQ图是评估GWAS结果系统性偏差的最基本的视觉工具 [@problem_id:4596551]。它将观测到的P值（通常经过 $-\log_{10}$ 变换）的分位数与在零假设下（即所有SNP均无效应）期望的P值分位数进行对比。
-   **构建**：将所有SNP的P值从小到大排序 $p_{(1)}, \dots, p_{(m)}$。期望的P值[分位数](@entry_id:178417)为 $i/(m+1)$。QQ图绘制的是 $(-\log_{10}(\frac{i}{m+1}), -\log_{10}(p_{(i)}))$。
-   **解读**：
    -   **理想情况**：在全局零假设下，所有点应落在 $y=x$ 这条对角线附近。
    -   **群体分层**：如果存在广泛的群体分层，大量非因果SNP的P值都会被系统性地夸大（即变小）。这在QQ图上表现为数据点从对角线的起点（即P值较大的部分）就开始系统性地向上偏离，形成一条几乎平行的“抬升”直线。
    -   **多基因性**：如果一个性状受到大量真实遗传位点的影响，那么大部分P值应遵循零分布（落在对角线上），但图的尾部（对应最显著的P值）会向上翘起，偏离对角线。这是因为存在一个真实信号的SNP子集。

#### [连锁不平衡分数回归](@entry_id:149170)（LDSC）

QQ图的解读有时是模棱两可的，尤其是在大样本GWAS中，高度的多基因性也可能导致早期偏离。LDSC提供了一种更量化的方法来区分这两种情况 [@problem_id:4596427]。其核心思想是，一个SNP的关联检验统计量（$\chi^2$统计量）的大小，不仅取决于它自身的效应，还取决于它通过[连锁不平衡](@entry_id:146203)（LD）“标记”了多少附近其他因果SNP的效应。
-   一个SNP的**LD分数**（$\ell_j$）定义为它与基因组中所有其他SNP（包括它自身）的LD相关系数平方和 $\ell_j = \sum_k r_{jk}^2$。LD分数越高的SNP，位于LD区域越密集的地方，标记的遗传变异越多。

LDSC的理论推导表明，在多基因遗传结构下，一个SNP的期望$\chi^2$统计量与其LD分数呈线性关系：
$$
\mathbb{E}[\chi_j^2] = 1 + c + \frac{N h_g^2}{M} \ell_j
$$
其中 $N$ 是样本量，$M$ 是SNP数量，$h_g^2$ 是[SNP遗传力](@entry_id:148453)。通过将所有SNP的$\chi^2$统计量对它们的LD分数进行回归，我们可以估计这个模型的截距和斜率。
-   **斜率**：回归线的斜率与 $N h_g^2 / M$ 成正比，反映了由多基因性贡献的信号强度。
-   **截距**：截距 $1+c$ 则捕捉了那些与LD无关的、在全基因组范围内普遍存在的P值膨胀。理论上，在没有混杂的情况下，截距应为1。因此，**截距偏离1的部分（即 $c$）被解释为由[群体分层](@entry_id:175542)、亲缘关系或其他未建模的混杂因素导致的膨胀** [@problem_id:4596427] [@problem_id:4596551]。

LDSC因此成为了一个强大的诊断工具：一个显著大于1的LDSC截距是存在残余群体分层的有力证据，即使QQ图看起来似乎可接受。

### 假设、局限性与最佳实践

尽管PCA、LMM和LDSC是功能强大的工具，但它们都建立在特定的假设之上，并有其局限性 [@problem_id:4596446]。
-   **PCA** 假设混杂结构是低维的，可以通过几个主要的线性轴来捕捉。对于具有近期、复杂混合历史的群体，其祖源结构可能并非低维，导致PCA校正不充分。
-   **LMM** 假设导致表型相似性的混杂因素与通过GRM测量的[全基因组](@entry_id:195052)遗传相似性是一致的。如果存在一个与遗传背景不相关的强环境混杂因素（例如，地域差异导致的饮食习惯），LMM可能无法完全校正它。此外，在计算GRM时不应包含待测SNP所在的染色体，以避免“近端污染”（proximal contamination），即随机效应错误地吸收了待测位点的固定效应。
-   **LDSC** 的一个关键假设是，混杂因素对$\chi^2$统计量的影响与LD分数无关。此外，它要求用于计算LD分数的参考面板（reference panel）与GWAS研究群体的祖源背景相匹配。如果祖源不匹配，LD模式的差异会扭曲LDSC的估计，特别是对截距的估计。

综上所述，群体分层的控制是[GWAS分析](@entry_id:264205)中一个复杂但可控的问题。不存在一种“一劳永逸”的完美方法。在实践中，最佳策略通常是结合使用这些互补的方法：使用PCA或LMM来校正关联分析，然后使用QQ图和LDSC来诊断结果的可靠性，并对[群体结构](@entry_id:148599)和遗传结构做出明智的推断。