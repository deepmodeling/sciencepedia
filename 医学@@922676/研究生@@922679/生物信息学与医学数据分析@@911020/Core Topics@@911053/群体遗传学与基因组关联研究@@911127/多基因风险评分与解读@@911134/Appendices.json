{"hands_on_practices": [{"introduction": "多基因风险评分（PRS）本身只是一个数值，其真正的价值在于我们如何解释它。这项练习旨在连接统计模型（如逻辑回归）的抽象输出（例如对数优势比系数）与更直观的风险度量，如优势比（Odds Ratio, OR）或风险比（Hazard Ratio, HR）。掌握这项基本技能对于在临床或研究环境中有效沟通PRS的意义至关重要([@problem_id:4594841])。", "problem": "一项病例对照研究使用标准化的多基因风险评分（PRS）（记为 $Z$，其均值为 $0$，标准差为 $1$）来对疾病风险进行建模。二元疾病状态 $D \\in \\{0,1\\}$ 通过一个逻辑斯蒂回归模型与 $Z$ 相关联，其中对数优势比是 $Z$ 的线性函数。另外，在一个针对事件发生时间数据的队列研究中，假设采用 Cox 比例风险模型，其中风险率与 $Z$ 呈乘法关系。\n\n仅从以下基本定义和模型陈述出发：\n- 概率为 $p$ 时的疾病优势比为 $O(p) = \\frac{p}{1-p}$，而 logit（对数几率）为 $\\ln\\!\\big(O(p)\\big)$。\n- 逻辑斯蒂回归模型满足 $\\ln\\!\\big(O(p_Z)\\big) = \\alpha + \\gamma Z$，其中 $p_Z = \\Pr(D=1 \\mid Z)$，$\\alpha$ 是截距，$\\gamma$ 是每单位 $Z$ 的斜率。\n- Cox 模型假设 $h(t \\mid Z) = h_0(t)\\,\\exp(\\beta Z)$，其中 $h(t \\mid Z)$ 是时间 $t$ 时的风险率，$h_0(t)$ 是基线风险率，$\\beta$ 是每单位 $Z$ 的斜率。\n\n根据这些定义，推导在逻辑斯蒂模型中 $Z$ 增加一个标准差如何对应于一个优势比（OR），以及在 Cox 模型中如何对应于一个风险比（HR）。解释系数 $\\gamma$ 和 $\\beta$ 的含义，即它们分别表示当 $Z$ 增加一个标准差时，优势比或风险率的乘法变化。\n\n然后，假设一个拟合的逻辑斯蒂模型得出的斜率估计值为 $\\gamma = 0.42$（每标准差 $Z$ 的对数优势比）。计算当 $Z$ 增加一个标准差时的数值优势比。将您的答案四舍五入到四位有效数字。最终答案以纯数字形式表示，不带单位。", "solution": "问题陈述定义了两个将标准化多基因风险评分（PRS）（记为 $Z$）与健康结果相关联的模型。我们被要求推导模型系数在优势比（OR）和风险比（HR）方面的解释，然后计算一个特定的 OR。变量 $Z$ 是一个标准化分数，意味着其均值为 $0$，标准差为 $1$。\n\n首先，我们分析用于二元疾病结果 $D \\in \\{0,1\\}$ 的逻辑斯蒂回归模型。该模型由下式给出：\n$$\n\\ln\\!\\big(O(p_Z)\\big) = \\alpha + \\gamma Z\n$$\n其中 $p_Z = \\Pr(D=1 \\mid Z)$ 是在给定 PRS $Z$ 的情况下的疾病概率，而 $O(p_Z)$ 是相应的优势比。项 $\\alpha$ 是 $Z=0$（群体平均 PRS）的个体的对数优势比，而 $\\gamma$ 是 $Z$ 每增加一个单位时对数优势比的变化。\n\n为了求出当 $Z$ 增加一个标准差时的优势比（OR），我们比较两个个体的优势比。由于 $Z$ 是标准化的，一个标准差等于 $Z$ 的一个单位。让我们考虑一个 PRS 为 $Z$ 的个体和另一个 PRS 为 $Z+1$ 的个体。\n\n第一个个体的对数优势比为：\n$$\n\\ln(\\text{Odds}_1) = \\alpha + \\gamma Z\n$$\n因此，该个体的优势比为 $\\text{Odds}_1 = \\exp(\\alpha + \\gamma Z)$。\n\n第二个个体的 PRS 高一个单位，其对数优势比为：\n$$\n\\ln(\\text{Odds}_2) = \\alpha + \\gamma (Z+1) = \\alpha + \\gamma Z + \\gamma\n$$\n这第二个个体的优势比为 $\\text{Odds}_2 = \\exp(\\alpha + \\gamma Z + \\gamma)$。\n\n优势比（OR）定义为这两个优势比的比率：\n$$\n\\text{OR} = \\frac{\\text{Odds}_2}{\\text{Odds}_1} = \\frac{\\exp(\\alpha + \\gamma Z + \\gamma)}{\\exp(\\alpha + \\gamma Z)}\n$$\n使用指数的性质 $\\exp(a+b) = \\exp(a)\\exp(b)$，我们得到：\n$$\n\\text{OR} = \\frac{\\exp(\\alpha + \\gamma Z) \\cdot \\exp(\\gamma)}{\\exp(\\alpha + \\gamma Z)} = \\exp(\\gamma)\n$$\n这个推导表明，当 $Z$ 增加一个单位时，OR 为 $\\exp(\\gamma)$。由于 $Z$ 的一个单位对应一个标准差，因此这也是 PRS 每增加一个标准差的 OR。\n\n系数 $\\gamma$ 的解释可以直接得出：$\\gamma$ 是与 PRS 增加一个标准差相关联的优势比的自然对数。值 $\\exp(\\gamma)$ 表示当 $Z$ 每增加一个标准差时，疾病优势比增加（如果 $\\gamma > 0$）或减少（如果 $\\gamma  0$）的乘法因子。\n\n其次，我们分析用于事件发生时间数据的 Cox 比例风险模型。该模型由下式给出：\n$$\nh(t \\mid Z) = h_0(t)\\,\\exp(\\beta Z)\n$$\n其中 $h(t \\mid Z)$ 是具有 PRS 为 $Z$ 的个体在时间 $t$ 时的风险率，$h_0(t)$ 是基线风险函数，$\\beta$ 是 $Z$ 每增加一个单位的对数风险比。\n\n为了求出当 $Z$ 增加一个标准差时的风险比（HR），我们再次比较 PRS 值分别为 $Z$ 和 $Z+1$ 的两个个体。\n\n第一个个体的风险率为：\n$$\nh(t \\mid Z) = h_0(t)\\,\\exp(\\beta Z)\n$$\n第二个个体的风险率为：\n$$\nh(t \\mid Z+1) = h_0(t)\\,\\exp(\\beta(Z+1)) = h_0(t)\\,\\exp(\\beta Z + \\beta)\n$$\n风险比（HR）是这两个风险率的比率。Cox 模型的一个关键特征是，这个比率在时间 $t$ 上是恒定的。\n$$\n\\text{HR} = \\frac{h(t \\mid Z+1)}{h(t \\mid Z)} = \\frac{h_0(t)\\,\\exp(\\beta Z + \\beta)}{h_0(t)\\,\\exp(\\beta Z)}\n$$\n基线风险 $h_0(t)$ 被消掉，化简指数项得到：\n$$\n\\text{HR} = \\frac{\\exp(\\beta Z) \\cdot \\exp(\\beta)}{\\exp(\\beta Z)} = \\exp(\\beta)\n$$\n这个推导表明，当 $Z$ 增加一个单位（即一个标准差）时，HR 为 $\\exp(\\beta)$。\n\n系数 $\\beta$ 的解释与 $\\gamma$ 的解释类似：$\\beta$ 是与 PRS 增加一个标准差相关联的风险比的自然对数。值 $\\exp(\\beta)$ 是当 $Z$ 每增加一个标准差时，事件风险率变化的乘法因子。\n\n最后，我们被要求为一个拟合的逻辑斯蒂模型计算数值优势比，其中斜率估计值为 $\\gamma = 0.42$。这个系数代表 $Z$ 每增加一个标准差时对数优势比的增加量。\n\n根据我们的推导，OR 由 $\\exp(\\gamma)$ 给出。代入给定的 $\\gamma$ 值：\n$$\n\\text{OR} = \\exp(0.42)\n$$\n计算这个值：\n$$\n\\text{OR} \\approx 1.521961556...\n$$\n问题要求答案四舍五入到四位有效数字。前四位有效数字是 $1$、$5$、$2$ 和 $2$（因为第五位数字是 $9 \\ge 5$，所以我们将第四位数字向上取整）。\n$$\n\\text{OR} \\approx 1.522\n$$\n这意味着，多基因风险评分每增加一个标准差，患病的优势比变为原来的约 1.522 倍。", "answer": "$$\\boxed{1.522}$$", "id": "4594841"}, {"introduction": "在学会如何解释PRS之后，下一个合乎逻辑的步骤是学习如何构建它。本实践概述了经典的“团块与P值阈值法”（Clumping and Thresholding, C+T），这是一种构建PRS的广泛使用的方法。它将引导你完成一个从原始GWAS数据到经过验证的PRS的完整流程，并强调其中关键的质量控制步骤和统计严谨性，确保你能够设计出科学可靠的分析流程([@problem_id:4594729])。", "problem": "一个临床遗传学小组希望在一个欧洲血统队列中，使用经典的 clumping 和 $p$ 值阈值法，为一种复杂疾病构建多基因风险评分 (PRS)。该小组拥有以下资源：来自一个大型非重叠荟萃分析的全基因组关联研究 (GWAS) 汇总统计数据、目标队列的 PLINK 二进制格式基因型数据，以及公共参考面板。PRS 必须在一个科学上合理、步骤化的流程中构建和评估，该流程需遵循 GWAS 衍生预测变量的统计假设，包括训练数据和评估数据之间的独立性、对连锁不平衡 (LD) 的适当处理以及等位基因协调。为清楚起见，在此背景下，PRS 是由 GWAS 效应大小加权的单核苷酸多态性 (SNP) 预测变量的线性组合，LD 指的是不同位点上等位基因之间的相关性，而 clumping 通过保留关联性最强的索引 SNP 并移除附近相关的 SNP 来减少相关冗余。\n\n选择一个选项，该选项指定了使用 clumping 和 $p$ 值阈值法构建 PRS 的正确、分步流程，包括所需的输入文件和科学上合理的参数选择。该流程必须：\n\n- 遵循基础样本与目标样本的独立性（无数据泄露）。\n- 使用与血统匹配的 LD 信息进行 clumping。\n- 执行等位基因协调和适当的质量控制。\n- 使用正确尺度的效应大小进行加权。\n- 通过验证选择一个 $p$ 值阈值，以避免过拟合。\n- 提供明确的输入文件和参数值。\n\n选项：\n\nA. \n- 输入：\n  - GWAS 汇总统计文件（例如，“sumstats.txt”），包含以下列：SNP 标识符、染色体、碱基对位置、效应等位基因、其他等位基因、每个等位基因的效应大小 $\\hat{\\beta}$（对数优势比或线性效应）、标准误、$p$ 值 $p$ 和样本量 $N$。\n  - 目标队列 PLINK 基因型文件：“target.bed”、“target.bim”、“target.fam”。\n  - 与血统匹配的 LD 参考面板（例如，千人基因组计划欧洲子集）的 PLINK 格式文件。\n  - 包含年龄、性别和主成分 (PCs) 的协变量文件。\n- 汇总统计数据的质量控制和协调：\n  - 移除非双等位基因和链不明确的 SNP（腺嘌呤/胸腺嘧啶和胞嘧啶/鸟嘌呤），以防止链错配。\n  - 排除缺少 $\\hat{\\beta}$、$p$ 或等位基因信息的 SNP；限制在常染色体，并可选择性排除人类白细胞抗原 (HLA) 区域（6号染色体从25到34兆碱基对）。\n  - 将效应等位基因与目标基因型编码对齐：当等位基因交换时，必要时翻转 $\\hat{\\beta}$ 的符号，移除无法解决等位基因错配的 SNP。\n- 目标基因型的质量控制：\n  - 按检出率（缺失率 $0.02$）、次要等位基因频率（MAF $>0.01$）、哈迪-温伯格平衡（HWE）（$p>10^{-6}$）和填充质量（如果使用剂量，信息分数 $>0.8$）过滤 SNP。\n  - 使用经过 LD 剪枝的 SNP 计算血统主成分，并将分析限制在欧洲血统子集中。\n- LD clumping：\n  - 使用与血统匹配的 LD 参考面板。\n  - 参数：窗口大小为 250 千碱基对，成对 $r^20.1$，根据区域内最小的 GWAS $p$ 值选择索引 SNP；移除与索引 SNP 的 $r^2$ 关系不符合条件的次要 SNP。\n- $p$ 值阈值法：\n  - 定义一个阈值网格 $p \\in \\{5\\times 10^{-8}, 10^{-6}, 10^{-4}, 10^{-3}, 10^{-2}, 5\\times 10^{-2}, 10^{-1}, 5\\times 10^{-1}, 1\\}$。\n  - 对于每个阈值，包括 $p$ 值低于该阈值的经过 clumping 的 SNP。\n- 评分构建：\n  - 计算个体评分 $\\mathrm{PRS}_j=\\sum_{i\\in S(\\alpha)} \\hat{\\beta}_i x_{ij}$，其中 $x_{ij}$ 是个体 $j$ 的目标基因型剂量（编码为 $0, 1, 2$ 或填充剂量），$S(\\alpha)$ 是通过 clumping 和 $p$ 值阈值 $\\alpha$ 的 SNP 集合。\n  - 在目标样本内对 $\\mathrm{PRS}_j$ 进行标准化（例如，z-分数）。\n- 模型评估和选择：\n  - 将目标队列拆分为训练集和验证集，或使用交叉验证；确保与 GWAS 训练数据没有重叠。\n  - 使用 PRS 和协变量（年龄、性别、PCs）拟合回归模型：对二元性状使用逻辑回归，对数量性状使用线性回归。\n  - 在验证中选择能最大化解释方差（例如，$R^2$）或曲线下面积（AUC）的阈值 $\\alpha$，并报告性能。\n- 报告：\n  - 提供最终的 SNP 列表、权重 $\\hat{\\beta}_i$、选定的 $\\alpha$、clumping 参数（$r^2$、窗口）和评估指标。\n\nB.\n- 输入：\n  - 仅包含 SNP 标识符和优势比，但没有等位基因信息的 GWAS 汇总统计文件。\n  - 用于 LD 估计和 PRS 评估的目标队列 PLINK 基因型文件。\n- 流程：\n  - 跳过等位基因协调和不明确 SNP 的移除；假设优势比已对齐。\n  - 使用目标队列的基因型进行 LD clumping，参数为：窗口大小 500 千碱基对，$r^2>0.5$；如果索引 SNP 和相关 SNP 的 $p$ 值都低于 $5\\times 10^{-8}$，则同时保留它们。\n  - 通过直接使用发布的优势比（而不是对数优势比）对基因型计数进行加权来计算 PRS，并对所有通过 $p$ 值阈值 $5\\times 10^{-8}$ 的 SNP 进行求和。\n  - 在整个目标队列（包括病例和对照）上优化 $p$ 值阈值，并在同一队列上报告未经协变量调整的性能。\n\nC.\n- 输入：\n  - 仅包含每个 SNP 的 $z$-分数的 GWAS 荟萃分析汇总统计数据。\n  - 目标 PLINK 基因型。\n  - 来自结合了欧洲和东亚个体的混合血统样本的 LD 参考面板。\n- 流程：\n  - 用标准化的 $z$-分数替换权重 $\\hat{\\beta}$，并除以目标队列的等位基因频率，以强调稀有变异。\n  - 进行 LD clumping，参数为：窗口大小 1000 千碱基对，保留 $r^2>0.8$ 的 SNP 以捕获单倍型。\n  - 使用单一的严格 $p$ 值阈值 $p5\\times 10^{-8}$，并且不评估其他阈值。\n  - 计算 PRS 并在目标队列中使用未经调整的线性回归进行评估，不使用 PCs 或其他协变量；报告样本内 $R^2$。\n\nD.\n- 输入：\n  - 包含效应等位基因和对数优势比 $\\hat{\\beta}$ 的 GWAS 汇总统计数据，但样本与目标队列重叠。\n  - 目标 PLINK 基因型。\n  - 来自千人基因组计划东亚子集的 LD 参考面板。\n- 流程：\n  - 协调等位基因并移除不明确的 SNP；在目标队列中排除 MAF $0.05$ 的 SNP。\n  - 使用东亚 LD 参考面板对欧洲目标队列进行 LD clumping，参数为：窗口大小 250 千碱基对，$r^20.1$。\n  - 使用阈值网格 $p \\in \\{5\\times 10^{-8}, 10^{-6}, 10^{-4}, 10^{-3}\\}$；通过在目标队列上最大化 $R^2$ 来选择最佳阈值。\n  - 使用 $\\hat{\\beta}$ 权重计算 PRS，并在包含协变量的同一目标队列上评估性能，然后报告最终的 PRS。\n\n哪个选项最正确地指定了一个科学合理的、采用 clumping 和 $p$ 值阈值法的 PRS 流程，并包含适当的输入和参数？", "solution": "问题要求确定使用 clumping 和 $p$ 值阈值法 ($C+T$) 构建多基因风险评分 (PRS) 的正确、分步流程。该流程必须科学合理，遵循该领域的统计假设和最佳实践。\n\n### 问题陈述的验证\n首先，对问题陈述的有效性进行评估。\n\n**1. 提取已知条件：**\n- **目标：** 为一种复杂疾病构建 PRS。\n- **方法：** Clumping 和 $p$ 值阈值法。\n- **目标人群：** 欧洲血统队列。\n- **可用数据：**\n    - 来自一个大型非重叠荟萃分析的全基因组关联研究 (GWAS) 汇总统计数据。\n    - 目标队列的 PLINK 二进制格式基因型数据。\n    - 公共参考面板。\n- **关键科学约束：**\n    - 基础 (GWAS) 样本和目标样本的独立性。\n    - 使用与血统匹配的连锁不平衡 (LD) 信息。\n    - 适当的等位基因协调和质量控制 (QC)。\n    - 使用正确尺度的效应大小。\n    - 通过验证程序选择 $p$ 值阈值，以避免过拟合。\n    - 明确指定输入和参数。\n\n**2. 有效性分析：**\n- **科学基础：** 该问题牢固地基于统计遗传学和生物信息学的既定原则。所描述的 PRS 方法是一种标准且广泛使用的方法。\n- **适定性：** 该问题是适定的。它要求根据一组明确的科学约束，从一组选项中确定一个正确的程序。预期会有一个唯一的最佳答案。\n- **客观性：** 语言精确且无偏见。PRS、LD 和 clumping 的定义准确且标准。\n- **完整性和一致性：** 问题是自洽的。它明确指出 GWAS 和目标队列是不重叠的，这是有效分析的关键细节。没有内部矛盾。\n- **现实性：** 该场景非常现实，反映了临床遗传学研究人员的常见任务。数据类型和约束都是标准的。\n\n**3. 结论：**\n问题陈述是**有效的**。在其领域内，这是一个表述清晰、科学合理且相关的问题。\n\n### 正确流程的推导与选项评估\n\n一个科学严谨的 $C+T$ PRS 流程如下：\n\n1.  **数据准备和质量控制：** 从高质量的 GWAS 汇总统计数据和目标基因型数据开始。关键的第一步是协调数据，确保 GWAS 中的效应等位基因与目标数据中计数的等位基因相对应。这包括检查并解决链不明确性和等位基因交换问题，在必要时翻转效应大小（$\\hat{\\beta}$）的符号。必须移除无法解决错配的 SNP。对汇总统计数据（例如，根据信息分数、等位基因频率过滤，移除不明确的 SNP）和目标基因型（根据缺失率、次要等位基因频率（MAF）、哈迪-温伯格平衡（HWE）$p$ 值过滤）应用标准的 QC 过滤器。\n2.  **LD Clumping：** 为了满足加性效应的假设，必须对高度相关的 SNP 进行修剪。这是通过 LD clumping 完成的，该方法迭代地识别出一个索引 SNP（在给定窗口内 GWAS $p$ 值最低的 SNP），并移除该窗口内与索引 SNP 处于高度 LD（例如，$r^2 > 0.1$）的所有其他 SNP。此步骤至关重要地需要一个与 GWAS 和目标人群**血统相匹配**的 LD 参考面板。\n3.  **阈值设定和评分计算：** 生成一系列 PRS，每个 PRS 对应一个不同的 GWAS $p$ 值阈值。定义一个阈值网格（例如，$p \\in \\{5\\times 10^{-8}, 10^{-6}, ..., 1\\}$）。对于每个阈值，个体的评分计算为他们的基因型总和，由相应的 GWAS 效应大小（$\\hat{\\beta}$，对于二元性状是对数优势比）加权。公式为 $\\mathrm{PRS}_j = \\sum_{i} \\hat{\\beta}_i G_{ij}$，其中 $G_{ij}$ 是个体 $j$ 在 SNP $i$ 上的效应等位基因计数。\n4.  **模型调优和评估：** 为了无偏地选择最佳 $p$ 值阈值，必须将目标队列拆分为训练集和验证/测试集，或者必须使用交叉验证。对于每个 PRS（对应一个 $p$ 值阈值），在训练集中拟合一个回归模型（例如，疾病状态的逻辑回归）：$\\text{性状} \\sim \\text{PRS} + \\text{协变量}$。协变量必须包括主成分 (PCs) 以控制人群分层，以及其他相关变量如年龄和性别。然后，在独立的验证集中使用合适的指标（例如，AUC，Nagelkerke's $R^2$）评估每个模型的性能。选择在验证集中产生最佳性能的 $p$ 值阈值作为最终模型。理想情况下，应在一个独立的、预留的测试集上报告最终模型的性能，以获得无偏估计。\n\n### 逐项选项分析\n\n**A. 评估：**\n该选项概述了一个遵循严谨 PRS 分析所有原则的流程。\n- **输入：** 正确指定了非重叠的 GWAS 汇总统计数据、目标基因型和一个与血统匹配的 LD 面板。列出了所有必需的列和文件。\n- **QC 和协调：** 详细说明了一个全面且正确的程序，包括移除不明确的 SNP、通过翻转 $\\hat{\\beta}$ 的符号来协调效应等位基因，以及对汇总统计数据和目标基因型进行标准 QC。\n- **LD Clumping：** 使用一个与血统匹配的面板，并采用标准、合理的参数（250 千碱基对窗口，$r^2  0.1$）。\n- **$p$ 值阈值法：** 采用宽泛的 $p$ 值阈值网格，这是正确的调优方法。\n- **评分构建：** 使用正确的线性公式，以 $\\hat{\\beta}$ 作为权重。\n- **模型评估：** 至关重要的是，它强制要求拆分目标队列或使用交叉验证来选择最佳阈值，使用必要的协变量（PCs）拟合模型，并使用适当的指标（$R^2$，AUC）。这可以防止过拟合。\n- **报告：** 指定了可重复性所需的信息。\n**结论：正确。**\n\n**B. 评估：**\n该选项包含多个基本错误。\n- **输入：** 没有等位基因信息的 GWAS 汇总统计数据无法用于协调，而协调是关键步骤。\n- **流程：** “跳过等位基因协调”是一个致命缺陷。假设对齐在科学上是站不住脚的。直接使用优势比作为权重在数学上是不正确的，因为 PRS 模型是加性的（需要对数优势比，即 $\\hat{\\beta}$）。$r^2 > 0.5$ 的 clumping 阈值过于宽松，无法充分移除相关的 SNP。保留相关 SNP 违背了 clumping 的目的。\n- **评估：** 在整个目标队列上优化和评估模型，而没有训练/验证集拆分或交叉验证，会导致严重的过拟合和虚高的性能估计。忽略像 PCs 这样的协变量，无法控制人群分层。\n**结论：不正确。**\n\n**C. 评估：**\n该选项的核心方法存在缺陷。\n- **输入：** 对欧洲队列使用来自混合血统样本的 LD 参考面板是一个重大错误，因为 LD 模式具有人群特异性，这种不匹配将导致不正确的 clumping。\n- **流程：** 权重方案是临时的。更重要的是，clumping 的逻辑是颠倒的：保留 $r^2 > 0.8$ 的 SNP 会将高度相关的 SNP 分组在一起，这与为 PRS 创建一组独立预测变量的 clumping 目标相反。这描述的是一种识别用于单倍型分析的标签 SNP 的方法，而不是创建一组独立预测变量的方法。\n- **评估：** 仅使用单一、严格的 $p$ 值阈值（$p  5\\times 10^{-8}$）违背了 $C+T$ 方法中阈值部分的宗旨，即凭经验找到信号和噪声之间的最佳权衡。报告未经调整的样本内 $R^2$ 是不良做法，因为存在混杂和过拟合。\n**结论：不正确。**\n\n**D. 评估：**\n该选项违反了 PRS 构建中两个最关键的假设。\n- **输入：** “样本与目标队列重叠”的陈述是一个致命缺陷。这种对基础（GWAS）数据和目标数据之间独立性的违反，保证了会发生过拟合，并将产生一个性能估计被严重夸大且不具泛化性的 PRS。\n- **LD 参考面板：** 对欧洲目标队列使用东亚 LD 参考面板是一个科学上无效的选择，因为血统不匹配将导致不正确的 clumping。\n- **评估：** 在同一个、完整的目杯队列上选择最佳阈值并评估性能是一种数据泄露形式，会导致过拟合。需要一个独立的验证集。\n**结论：不正确。**\n\n### 结论\n选项 A 是唯一一个描述了使用 clumping 和 $p$ 值阈值法构建 PRS 的科学合理、严谨且完整的流程的选项。它正确地指定了所有必要的输入、QC 步骤、分析程序和验证策略。", "answer": "$$\\boxed{A}$$", "id": "4594729"}, {"introduction": "为了达到对PRS模型的精通，从第一性原理出发生成数据是超越仅仅分析现有数据的关键一步。这项编码练习提供了一个完整的框架，用于模拟具有真实连锁不平衡（Linkage Disequilibrium, LD）结构的基因型，并基于预设的遗传结构生成复杂性状。通过要求你亲手实现遗传度、LD和因果效应等核心概念，这项实践将巩固并深化你对整个PRS模型的理解([@problem_id:4594602])。", "problem": "要求您设计并实现一个完整的、可运行的程序，该程序能从一个参考单倍型面板中模拟具有真实连锁不平衡 (Linkage Disequilibrium, LD) 结构的二倍体基因型，并根据指定的因果遗传结构生成数量性状。您的程序必须实现一个镶嵌复制模型，从参考面板生成新的单倍型，配对单倍型以形成基因型，在频率依赖先验下抽取效应大小，重新缩放以达到目标解释方差（狭义遗传力），并评估模拟的 LD 在多大程度上保留了参考 LD，同时报告实现的遗传力。使用的科学基础如下：(i) 单倍型的定义，即单条染色体上等位基因的有序序列；(ii) 二倍体基因型的构建，即两个单倍型之和；(iii) 广泛使用的隐马尔可夫模型 (Hidden Markov Model, HMM) 镶嵌复制 (Li–Stephens) 方法，通过以每个相邻位点的固定概率在参考供体之间切换来近似重组；(iv) LD 的定义，即跨单倍型的基因座之间等位基因指示符的皮尔逊相关性；以及 (v) 数量性状的标准加性模型，其中表型是线性多基因遗传组分与环境残差之和。缩略词在首次使用时必须定义：连锁不平衡 (Linkage Disequilibrium, LD)、隐马尔可夫模型 (Hidden Markov Model, HMM) 和多基因风险评分 (Polygenic Risk Score, PRS)。\n\n形式化设定。令参考单倍型矩阵表示为 $H \\in \\{0,1\\}^{K \\times M}$，其中有 $K$ 个参考单倍型和 $M$ 个双等位基因座（单核苷酸多态性）。任务是通过以下过程，将 $H$ 作为 HMM 镶嵌的模板，生成 $L$ 个新的单倍型：对于每个模拟的单倍型 $\\ell \\in \\{1,\\dots,L\\}$，从 $\\{1,\\dots,K\\}$ 中均匀随机抽取一个初始供体索引 $d_1$，然后对于每个基因座 $j \\in \\{1,\\dots,M\\}$，设置模拟的等位基因 $h_{\\ell j} = H_{d_j, j}$，其中 $d_j$ 在 $\\{1,\\dots,K\\}$ 上演化为一个马尔可夫链，其转移规则为 $d_{j+1}=\\begin{cases} \\text{从 } \\{1,\\dots,K\\} \\text{ 中均匀抽取的一个状态}  \\text{概率为 } \\rho,\\\\ d_j  \\text{概率为 } 1-\\rho.\\end{cases}$ 此处 $\\rho \\in [0,1]$ 是近似重组的相邻基因座切换概率。然后，通过按顺序配对模拟的单倍型来构建 $N$ 个二倍体基因型 $G \\in \\{0,1,2\\}^{N \\times M}$，使得对于 $i \\in \\{1,\\dots,N\\}$ 和 $j \\in \\{1,\\dots,M\\}$，有 $G_{i j} = h_{(2i-1) j} + h_{(2i) j}$。\n\n因果结构。设 $p_{\\text{causal}} \\in [0,1]$ 为因果基因座的比例，并设 $\\alpha \\in \\mathbb{R}$ 通过 $[2 \\, p_j (1-p_j)]^\\alpha$ 控制效应大小方差与等位基因频率之间的关系，其中 $p_j$ 是根据模拟基因型估计的基因座 $j$ 处的次要等位基因频率，$p_j = \\frac{1}{2N}\\sum_{i=1}^N G_{i j}$。设狭义遗传力为 $h^2 \\in [0,1]$。随机选择 $M_c = \\lfloor p_{\\text{causal}} \\, M \\rfloor$ 个因果基因座，并对因果集中的每个 $j$ 抽取原始效应 $\\beta^{\\text{raw}}_j \\sim \\mathcal{N}\\!\\left(0,\\,[2\\,p_j(1-p_j)]^\\alpha\\right)$，否则 $\\beta^{\\text{raw}}_j = 0$。通过 $g^{\\text{raw}} = G \\beta^{\\text{raw}}$ 定义原始遗传组分 $g^{\\text{raw}} \\in \\mathbb{R}^N$，并将 $\\beta^{\\text{raw}}$ 重新缩放为 $\\beta$，使得 $g = G \\beta$ 的样本方差等于目标 $h^2$：如果 $\\operatorname{Var}(g^{\\text{raw}})>0$，则设置 $\\beta = \\beta^{\\text{raw}} \\cdot \\sqrt{\\frac{h^2}{\\operatorname{Var}(g^{\\text{raw}})}}$，否则设置 $\\beta = 0$。通过加性模型 $y = g + \\varepsilon$ 生成表型 $y \\in \\mathbb{R}^N$，其中 $\\varepsilon \\sim \\mathcal{N}(0,\\,1-h^2)$ 在个体间独立。个体 $i$ 的多基因风险评分 (PRS) 等于 $g_i$。\n\n评估指标。令 $r^{\\text{ref}}_j$ 表示根据 $H$ 的行计算的相邻基因座 $j$ 和 $j+1$ 之间跨单倍型的皮尔逊相关性，令 $r^{\\text{sim}}_j$ 表示根据模拟单倍型计算的类似相关性。定义 LD 均方根误差为 $\\mathrm{LD\\_RMSE} = \\sqrt{\\frac{1}{M-1}\\sum_{j=1}^{M-1} \\bigl(r^{\\text{sim}}_j - r^{\\text{ref}}_j \\bigr)^2}$。令实现的遗传力为 $\\widehat{h}^2 = \\frac{\\operatorname{Var}(g)}{\\operatorname{Var}(y)}$，并定义遗传力绝对误差为 $\\lvert \\widehat{h}^2 - h^2 \\rvert$。所有方差和相关性都应作为样本量计算，并进行自由度为 1 的调整。\n\n您的程序必须从第一性原理实现以上内容，并为每个测试用例生成一个列表，按此顺序包含两个实数：LD 均方根误差和遗传力绝对误差。将所有测试用例的结果汇总到一个列表中。为保证可复现性，请使用固定的随机种子 $42$。\n\n参考单倍型面板。使用以下 $K \\times M$ 矩阵，其中 $K=12$，$M=10$：\n- 第 1 行：$[0,0,0,0,0,1,1,1,1,1]$\n- 第 2 行：$[0,0,1,1,1,1,1,0,0,0]$\n- 第 3 行：$[1,1,1,0,0,0,0,0,1,1]$\n- 第 4 行：$[1,1,0,0,0,0,1,1,1,0]$\n- 第 5 行：$[0,1,1,1,0,1,1,1,0,0]$\n- 第 6 行：$[1,0,0,1,1,0,0,1,1,1]$\n- 第 7 行：$[0,0,0,0,1,1,1,1,0,1]$\n- 第 8 行：$[1,1,1,1,0,0,0,0,1,0]$\n- 第 9 行：$[0,1,0,1,0,1,0,1,0,1]$\n- 第 10 行：$[1,0,1,0,1,0,1,0,1,0]$\n- 第 11 行：$[0,0,1,0,1,1,0,1,1,0]$\n- 第 12 行：$[1,1,0,1,0,0,1,0,0,1]$\n\n测试套件。实现程序以评估以下三种情况，每种情况产生一对 $[\\mathrm{LD\\_RMSE}, \\lvert \\widehat{h}^2 - h^2 \\rvert]$：\n- 情况 1：$\\rho = 0.05$，$N = 500$，$p_{\\text{causal}} = 0.3$，$\\alpha = 0.0$，$h^2 = 0.5$。\n- 情况 2：$\\rho = 0.0$，$N = 500$，$p_{\\text{causal}} = 0.6$，$\\alpha = -0.25$，$h^2 = 0.3$。\n- 情况 3：$\\rho = 0.5$，$N = 500$，$p_{\\text{causal}} = 0.3$，$\\alpha = 0.5$，$h^2 = 0.8$。\n\n最终输出格式。您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，按测试套件的顺序排列，其中每个案例本身是一个包含两个元素的列表。例如，输出必须类似于 $[[x_1,y_1],[x_2,y_2],[x_3,y_3]]$，其中 $x_c$ 和 $y_c$ 的位置是案例 $c$ 的十进制数。", "solution": "所提出的问题是有效的，因为它科学地基于群体遗传学和数量遗传学的既定原则，数学上定义良好，提供了所有必要的参数和定义，并且陈述客观。它要求为遗传数据和相关的复杂性状实现一个标准的模拟流程。我们将逐步推导和解释所需的计算过程。目标是从参考单倍型面板模拟具有真实遗传相关结构（称为连锁不平衡，Linkage Disequilibrium, LD）的二倍体基因型，模拟具有指定遗传结构的数量性状，然后评估模拟的保真度。\n\n模拟始于一个参考单倍型面板，由一个大小为 $K \\times M$ 的二进制矩阵 $H$ 表示，其中 $K=12$ 是参考单倍型的数量，$M=10$ 是双等位基因遗传基因座的数量，通常称为单核苷酸多态性 (Single-Nucleotide Polymorphisms, SNPs)。$H$ 的每一行都是一个单倍型，即单条染色体上等位基因（$0$ 或 $1$）的序列。\n\n第一步是使用镶嵌复制模型生成一个新的、更大的包含 $L$ 个单倍型的集合，这是 Li-Stephens 隐马尔可夫模型 (Hidden Markov Model, HMM) 的简化版本。对于 $L$ 个新单倍型中的每一个，我们从参考面板中模拟一个“供体”单倍型序列。单个模拟单倍型 $\\ell \\in \\{1, \\dots, L\\}$ 的过程如下：\n$1$。从 $\\{1, \\dots, K\\}$ 中均匀随机选择一个初始供体索引 $d_1$。新单倍型的第一个等位基因从该供体复制：$h_{\\ell,1} = H_{d_1, 1}$。\n$2$。对于从 $2$ 到 $M$ 的每个后续基因座 $j$，前一个基因座的供体索引 $d_{j-1}$ 要么保留，要么切换。以固定的概率 $\\rho$ 切换到一个从 $\\{1, \\dots, K\\}$ 中均匀随机选择的新供体，这模拟了遗传重组的效果。以概率 $1-\\rho$，供体保持不变 ($d_j=d_{j-1}$)。然后从选定的供体复制基因座 $j$ 处的等位基因：$h_{\\ell,j} = H_{d_j, j}$。对所有 $L$ 个单倍型重复此过程，生成大小为 $L \\times M$ 的模拟单倍型矩阵。\n\n第二步是从 $L=2N$ 个模拟单倍型中形成 $N$ 个二倍体基因型。基因型通过配对连续的单倍型形成。个体 $i \\in \\{1, \\dots, N\\}$ 在基因座 $j \\in \\{1, \\dots, M\\}$ 上的基因型，表示为 $G_{i,j}$，是第 $(2i-1)$ 个和第 $(2i)$ 个模拟单倍型上等位基因的总和：$G_{i,j} = h_{2i-1, j} + h_{2i, j}$。得到的基因型矩阵 $G$ 大小为 $N \\times M$，其元素在 $\\{0, 1, 2\\}$ 中，代表每个个体在每个基因座上‘1’等位基因的数量。根据此基因型矩阵，我们计算每个基因座 $j$ 上‘1’等位基因的频率 $p_j$ 为 $p_j = \\frac{1}{2N}\\sum_{i=1}^N G_{i,j}$。\n\n第三步是基于加性遗传模型模拟数量性状（表型）。这涉及到定义一个因果遗传结构。将 $M$ 个基因座中的一部分比例 $p_{\\text{causal}}$ 指定为因果基因座，意味着它们直接影响性状。因果基因座的数量为 $M_c = \\lfloor p_{\\text{causal}} M \\rfloor$，这些基因座从 $M$ 个基因座中均匀随机选择。对于每个因果基因座 $j$，从正态分布 $\\mathcal{N}(0, \\sigma_j^2)$ 中抽取原始效应大小 $\\beta^{\\text{raw}}_j$，其中方差 $\\sigma_j^2$ 依赖于等位基因频率 $p_j$ 和一个参数 $\\alpha$：$\\sigma_j^2 = [2 p_j (1-p_j)]^\\alpha$。对于非因果基因座，$\\beta^{\\text{raw}}_j = 0$。项 $2 p_j (1-p_j)$ 是假设哈迪-温伯格平衡 (Hardy-Weinberg Equilibrium) 时基因座的方差。因此，参数 $\\alpha$ 模拟了效应大小如何与等位基因频率耦合，这是人类遗传学中一个备受关注的话题。每个个体的总遗传组分，通常称为多基因风险评分 (Polygenic Risk Score, PRS)，被计算为其基因型与效应大小加权的线性总和。原始遗传评分向量 $g^{\\text{raw}}$ 计算为 $g^{\\text{raw}} = G \\beta^{\\text{raw}}$。为确保模拟的遗传方差与预定义的目标——狭义遗传力 $h^2$ 相匹配，需要对原始效应大小进行重新缩放。计算原始遗传评分的样本方差 $\\operatorname{Var}(g^{\\text{raw}})$（使用自由度为 1 的调整）。如果 $\\operatorname{Var}(g^{\\text{raw}}) > 0$，则通过缩放 $\\beta^{\\text{raw}}$ 获得最终效应大小 $\\beta$：$\\beta = \\beta^{\\text{raw}} \\cdot \\sqrt{h^2 / \\operatorname{Var}(g^{\\text{raw}})}$。这确保了最终的遗传评分向量 $g = G\\beta$ 的样本方差恰好为 $h^2$。如果 $\\operatorname{Var}(g^{\\text{raw}}) = 0$，则 $\\beta$ 是一个零向量。最后，通过将一个正态分布的环境噪声项 $\\varepsilon_i$ 加到每个个体的遗传评分 $g_i$ 上来生成表型 $y_i$。噪声项 $\\varepsilon$ 从 $\\mathcal{N}(0, 1-h^2)$ 中抽取，确保表型 $y=g+\\varepsilon$ 的总方差期望为 $1$。\n\n第四步也是最后一步，是通过计算两个指标来评估模拟。\n$1$。LD 均方根误差 ($\\mathrm{LD\\_RMSE}$): 该指标量化了参考面板的 LD 结构在模拟单倍型中被保留的程度。首先，我们计算参考面板（$r^{\\text{ref}}_j = \\text{corr}(H_{\\cdot, j}, H_{\\cdot, j+1})$，对于 $j \\in \\{1, \\dots, M-1\\}$）和模拟单倍型（$r^{\\text{sim}}_j = \\text{corr}(h_{\\cdot, j}, h_{\\cdot, j+1})$）中相邻基因座列之间的皮尔逊相关系数。然后，$\\mathrm{LD\\_RMSE}$ 是这些相关性之间平方差的均值的平方根：$\\mathrm{LD\\_RMSE} = \\sqrt{\\frac{1}{M-1}\\sum_{j=1}^{M-1} (r^{\\text{sim}}_j - r^{\\text{ref}}_j)^2}$。\n$2$。遗传力绝对误差：该指标衡量模拟样本中实现的遗传力与目标遗传力 $h^2$ 的接近程度。实现的遗传力 $\\widehat{h}^2$ 计算为遗传组分 $g$ 的样本方差与总表型 $y$ 的样本方差之比：$\\widehat{h}^2 = \\frac{\\operatorname{Var}(g)}{\\operatorname{Var}(y)}$。误差为绝对差 $|\\widehat{h}^2 - h^2|$。所有样本方差和相关性都使用自由度为 1 的调整进行计算。\n\n整个过程在一个计算框架内实现。为确保随机元素（供体选择、因果 SNP 选择、效应大小和环境噪声抽取）的可复现性，使用了固定的随机种子 $42$。该程序将对三个指定的测试用例中的每一个执行此模拟和评估。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements a full pipeline for simulating diploid genotypes and quantitative traits,\n    and evaluates the simulation quality.\n    \"\"\"\n    \n    # Use a single random number generator for reproducibility, as per the problem.\n    rng = np.random.default_rng(42)\n\n    # Reference haplotype panel H (K x M)\n    H = np.array([\n        [0, 0, 0, 0, 0, 1, 1, 1, 1, 1],\n        [0, 0, 1, 1, 1, 1, 1, 0, 0, 0],\n        [1, 1, 1, 0, 0, 0, 0, 0, 1, 1],\n        [1, 1, 0, 0, 0, 0, 1, 1, 1, 0],\n        [0, 1, 1, 1, 0, 1, 1, 1, 0, 0],\n        [1, 0, 0, 1, 1, 0, 0, 1, 1, 1],\n        [0, 0, 0, 0, 1, 1, 1, 1, 0, 1],\n        [1, 1, 1, 1, 0, 0, 0, 0, 1, 0],\n        [0, 1, 0, 1, 0, 1, 0, 1, 0, 1],\n        [1, 0, 1, 0, 1, 0, 1, 0, 1, 0],\n        [0, 0, 1, 0, 1, 1, 0, 1, 1, 0],\n        [1, 1, 0, 1, 0, 0, 1, 0, 0, 1]\n    ], dtype=np.int8)\n    \n    K, M = H.shape\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (rho, N, p_causal, alpha, h2)\n        (0.05, 500, 0.3, 0.0, 0.5),\n        (0.0, 500, 0.6, -0.25, 0.3),\n        (0.5, 500, 0.3, 0.5, 0.8),\n    ]\n\n    all_results = []\n\n    for rho, N, p_causal, alpha, h2 in test_cases:\n        # === 1. HAPLOTYPE SIMULATION ===\n        L = 2 * N\n        sim_haplotypes = np.zeros((L, M), dtype=np.int8)\n        \n        for l in range(L):\n            # Draw initial donor index uniformly\n            current_donor_idx = rng.integers(0, K)\n            sim_haplotypes[l, 0] = H[current_donor_idx, 0]\n            \n            # For each subsequent locus, decide whether to switch donor\n            for j in range(1, M):\n                if rng.random()  rho:\n                    current_donor_idx = rng.integers(0, K)\n                sim_haplotypes[l, j] = H[current_donor_idx, j]\n\n        # === 2. GENOTYPE CONSTRUCTION ===\n        # Pair haplotypes G_i = h_{2i-1} + h_{2i}\n        G = sim_haplotypes[::2, :] + sim_haplotypes[1::2, :]\n\n        # === 3. TRAIT SIMULATION ===\n        # Calculate allele frequencies from simulated genotypes\n        p_j = np.mean(G, axis=0) / 2.0\n        \n        # Select causal loci\n        M_c = int(np.floor(p_causal * M))\n        causal_indices = rng.choice(M, size=M_c, replace=False)\n        \n        # Draw raw effect sizes\n        beta_raw = np.zeros(M)\n        for j in causal_indices:\n            # Frequency-dependent variance. Handle p_j=0 or p_j=1, where variance term is 0\n            if p_j[j] > 0 and p_j[j]  1:\n                # [2*p*(1-p)]^alpha can be problematic if 2*p*(1-p) is 0 and alpha is negative\n                var_beta_j = (2 * p_j[j] * (1 - p_j[j])) ** alpha\n                std_beta_j = np.sqrt(var_beta_j)\n                beta_raw[j] = rng.normal(loc=0.0, scale=std_beta_j)\n        \n        # Calculate raw genetic component and rescale effects\n        g_raw = G @ beta_raw\n        var_g_raw = np.var(g_raw, ddof=1)\n        \n        beta = np.zeros(M)\n        if var_g_raw > 0:\n            scaling_factor = np.sqrt(h2 / var_g_raw)\n            beta = beta_raw * scaling_factor\n        \n        # Final genetic component and phenotype\n        g = G @ beta\n        epsilon = rng.normal(loc=0.0, scale=np.sqrt(1 - h2), size=N)\n        y = g + epsilon\n        \n        # === 4. EVALUATION METRICS ===\n        # LD_RMSE\n        # Calculate adjacent-locus Pearson correlations for reference panel\n        r_ref = np.array([np.corrcoef(H[:, j], H[:, j+1])[0, 1] for j in range(M - 1)])\n        \n        # Calculate adjacent-locus Pearson correlations for simulated haplotypes\n        r_sim = np.array([np.corrcoef(sim_haplotypes[:, j], sim_haplotypes[:, j+1])[0, 1] for j in range(M - 1)])\n        \n        # np.corrcoef can return NaN if one of the columns has zero variance.\n        # This is unlikely but we handle it for robustness.\n        r_ref = np.nan_to_num(r_ref)\n        r_sim = np.nan_to_num(r_sim)\n\n        ld_rmse = np.sqrt(np.mean((r_sim - r_ref)**2))\n        \n        # Heritability Absolute Error\n        var_g = np.var(g, ddof=1)\n        var_y = np.var(y, ddof=1)\n        \n        h2_realized = 0.0\n        if var_y > 0:\n            h2_realized = var_g / var_y\n        \n        h2_error = np.abs(h2_realized - h2)\n        \n        all_results.append([ld_rmse, h2_error])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, all_results))}]\")\n\nsolve()\n```", "id": "4594602"}]}