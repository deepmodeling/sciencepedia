{"hands_on_practices": [{"introduction": "我们从一个基础练习开始。给定一组模型预测和真实结果，你将计算在不同决策阈值下的灵敏度（sensitivity）和特异度（specificity）。这个练习将巩固你对这些核心指标如何计算的理解，并揭示它们之间固有的权衡关系，这是模型评估中的一个中心主题。[@problem_id:4585247]", "problem": "一个单阶段二元疾病分类器为每位患者 $i \\in \\{1,\\dots,100\\}$ 输出预测概率 $p_i \\in [0,1]$。一个决策规则规定，如果 $p_i \\ge t$，则患者被预测为阳性，否则预测为阴性。给定100名患者，他们根据相同的预测概率和其实现的二元标签进行了分组。分组情况如下：\n- $30$名患者的 $p_i = 0.05$，其中$0$名为真阳性。\n- $20$名患者的 $p_i = 0.15$，其中$0$名为真阳性。\n- $20$名患者的 $p_i = 0.25$，其中$0$名为真阳性。\n- $10$名患者的 $p_i = 0.35$，其中$1$名为真阳性。\n- $10$名患者的 $p_i = 0.60$，其中$3$名为真阳性。\n- $10$名患者的 $p_i = 0.80$，其中$6$名为真阳性。\n\n该队列中的疾病患病率为 $\\pi = 0.1$。\n\n使用基于混淆矩阵的灵敏度和特异度的标准定义，计算在阈值 $t=0.2$ 和阈值 $t=0.5$ 时这两个指标。然后，构建定义为跨越这些阈值的Youden’s $J$ 统计量变化的对比值，其中Youden’s $J$ 统计量是灵敏度与特异度之和减1。将 $J(0.2)-J(0.5)$ 的值报告为一个简化的精确数字。无需四舍五入，最终答案中不应包含单位。", "solution": "用户提供的问题已经过严格验证，被认为是自洽、一致且科学合理的。所有必要的数据和定义均已提供，不存在矛盾之处。该问题是适定的、客观的，完全属于数据分析中模型评估的范畴。\n\n目标是计算在两个决策阈值 $t=0.2$ 和 $t=0.5$ 之间Youden's $J$ 统计量的变化。Youden's $J$ 统计量定义为 $J = \\text{灵敏度} + \\text{特异度} - 1$。\n\n首先，我们必须确定这100名患者队列中状况为阳性和状况为阴性的总病例数。数据是根据预测概率分组提供的。让我们汇总真阳性患者的数量。\n- $p_i = 0.05$ 的组：$0$ 例阳性病例。\n- $p_i = 0.15$ 的组：$0$ 例阳性病例。\n- $p_i = 0.25$ 的组：$0$ 例阳性病例。\n- $p_i = 0.35$ 的组：$1$ 例阳性病例。\n- $p_i = 0.60$ 的组：$3$ 例阳性病例。\n- $p_i = 0.80$ 的组：$6$ 例阳性病例。\n\n真阳性患者的总数，记为 $P$，是其总和：\n$$P = 0 + 0 + 0 + 1 + 3 + 6 = 10$$\n队列中的患者总数是各组患者人数之和：$30 + 20 + 20 + 10 + 10 + 10 = 100$。\n真阴性患者的总数，记为 $N$，是患者总数减去真阳性患者总数：\n$$N = 100 - P = 100 - 10 = 90$$\n患病率 $\\pi$ 是 $\\frac{P}{100} = \\frac{10}{100} = 0.1$，这与问题陈述中提供的值相符，证实了数据的一致性。\n\n灵敏度和特异度的定义如下：\n$$ \\text{灵敏度} = \\frac{\\text{真阳性 (TP)}}{\\text{阳性总数 (P)}} $$\n$$ \\text{特异度} = \\frac{\\text{真阴性 (TN)}}{\\text{阴性总数 (N)}} $$\n\n我们现在为每个阈值计算这些指标。\n\n**情况1：阈值 $t = 0.2$**\n\n如果患者的预测概率 $p_i$ 大于或等于 $t=0.2$，则该患者被预测为阳性。满足此标准的组是 $p_i$ 为 $0.25$、$0.35$、$0.60$ 和 $0.80$ 的组。\n\n在此阈值下的真阳性（True Positives）数量，$TP(0.2)$，是这些预测为阳性的组中真阳性患者的总和：\n$$TP(0.2) = 0 + 1 + 3 + 6 = 10$$\n在 $t=0.2$ 时的灵敏度是：\n$$\\text{灵敏度}(0.2) = \\frac{TP(0.2)}{P} = \\frac{10}{10} = 1$$\n\n如果 $p_i  0.2$，则患者被预测为阴性。满足此标准的组是 $p_i$ 为 $0.05$ 和 $0.15$ 的组。\n真阴性（True Negatives）的数量，$TN(0.2)$，是这些预测为阴性的组中真阴性患者的总和。\n- 对于 $p_i = 0.05$ 的组：有 $30$ 名患者，其中 $0$ 名为阳性，因此全部 $30$ 名都是阴性。\n- 对于 $p_i = 0.15$ 的组：有 $20$ 名患者，其中 $0$ 名为阳性，因此全部 $20$ 名都是阴性。\n$$TN(0.2) = 30 + 20 = 50$$\n在 $t=0.2$ 时的特异度是：\n$$\\text{特异度}(0.2) = \\frac{TN(0.2)}{N} = \\frac{50}{90} = \\frac{5}{9}$$\n在 $t=0.2$ 时的 Youden's $J$ 统计量是：\n$$J(0.2) = \\text{灵敏度}(0.2) + \\text{特异度}(0.2) - 1 = 1 + \\frac{5}{9} - 1 = \\frac{5}{9}$$\n\n**情况2：阈值 $t = 0.5$**\n\n如果 $p_i \\ge 0.5$，则患者被预测为阳性。满足此标准的组是 $p_i$ 为 $0.60$ 和 $0.80$ 的组。\n在此阈值下的真阳性数量，$TP(0.5)$，是这些组中真阳性患者的总和：\n$$TP(0.5) = 3 + 6 = 9$$\n在 $t=0.5$ 时的灵敏度是：\n$$\\text{灵敏度}(0.5) = \\frac{TP(0.5)}{P} = \\frac{9}{10}$$\n\n如果 $p_i  0.5$，则患者被预测为阴性。满足此标准的组是 $p_i$ 为 $0.05$、$0.15$、$0.25$ 和 $0.35$ 的组。\n真阴性数量，$TN(0.5)$，是这些预测为阴性的组中真阴性患者的总和。\n- 对于 $p_i = 0.05$ 的组：$30$ 名阴性患者。\n- 对于 $p_i = 0.15$ 的组：$20$ 名阴性患者。\n- 对于 $p_i = 0.25$ 的组：$20$ 名阴性患者。\n- 对于 $p_i = 0.35$ 的组：有 $10$ 名患者，其中 $1$ 名为阳性，因此 $10 - 1 = 9$ 名为阴性。\n$$TN(0.5) = 30 + 20 + 20 + 9 = 79$$\n在 $t=0.5$ 时的特异度是：\n$$\\text{特异度}(0.5) = \\frac{TN(0.5)}{N} = \\frac{79}{90}$$\n在 $t=0.5$ 时的 Youden's $J$ 统计量是：\n$$J(0.5) = \\text{灵敏度}(0.5) + \\text{特异度}(0.5) - 1 = \\frac{9}{10} + \\frac{79}{90} - 1$$\n为了合并这些项，我们找到一个公分母，即 $90$：\n$$J(0.5) = \\frac{9 \\times 9}{10 \\times 9} + \\frac{79}{90} - \\frac{90}{90} = \\frac{81}{90} + \\frac{79}{90} - \\frac{90}{90} = \\frac{81 + 79 - 90}{90} = \\frac{160 - 90}{90} = \\frac{70}{90} = \\frac{7}{9}$$\n\n**最终计算**\n\n问题要求计算对比值 $J(0.2) - J(0.5)$。\n$$J(0.2) - J(0.5) = \\frac{5}{9} - \\frac{7}{9} = \\frac{5-7}{9} = -\\frac{2}{9}$$\n结果是一个精确的、简化的分数。", "answer": "$$\\boxed{-\\frac{2}{9}}$$", "id": "4585247"}, {"introduction": "这个练习揭示了模型评估中一个关键而微妙的观点：一个更高的受试者工作特征曲线下面积（AUROC）并不总是意味着更好的实际应用性能。你将分析两个具有相同 AUROC 值但得分分布不同的模型，并发现这如何导致它们可实现的最大 $F_1$ 分数有所不同。这突出了选择与你的特定临床或生物学目标相一致的评估指标的重要性。[@problem_id:4585277]", "problem": "一个临床信息学团队正在评估两种用于从电子健康记录中早期检测脓毒性休克的概率性二元分类器。对于一个由 $N=10$ 名成人重症监护室患者组成的队列，其真实标签是固定的，其中 $Y_i \\in \\{0,1\\}$ 表示患者 $i$ 的脓毒性休克 ($1$) 或非休克 ($0$) 状态。标签为：$Y_1=1$, $Y_2=1$, $Y_3=0$, $Y_4=1$, $Y_5=0$, $Y_6=1$, $Y_7=0$, $Y_8=0$, $Y_9=0$, $Y_{10}=1$，因此有 $m=5$ 个阳性样本和 $n=5$ 个阴性样本。\n\n两个模型产生可解释为预测概率的风险评分：\n- 模型 $\\mathrm{A}$ 是过分自信的，输出 $s^{(\\mathrm{A})}_1=0.98$, $s^{(\\mathrm{A})}_2=0.92$, $s^{(\\mathrm{A})}_3=0.83$, $s^{(\\mathrm{A})}_4=0.79$, $s^{(\\mathrm{A})}_5=0.72$, $s^{(\\mathrm{A})}_6=0.68$, $s^{(\\mathrm{A})}_7=0.55$, $s^{(\\mathrm{A})}_8=0.51$, $s^{(\\mathrm{A})}_9=0.44$, $s^{(\\mathrm{A})}_{10}=0.37$，反映了明显的分数分离。\n- 模型 $\\mathrm{B}$ 是保守的，并且更好地校准到患病率，其分数被压缩：$s^{(\\mathrm{B})}_1=0.88$, $s^{(\\mathrm{B})}_2=0.78$, $s^{(\\mathrm{B})}_3=0.81$, $s^{(\\mathrm{B})}_4=0.80$, $s^{(\\mathrm{B})}_5=0.79$, $s^{(\\mathrm{B})}_6=0.77$, $s^{(\\mathrm{B})}_7=0.76$, $s^{(\\mathrm{B})}_8=0.74$, $s^{(\\mathrm{B})}_9=0.73$, $s^{(\\mathrm{B})}_{10}=0.75$，因此分数降序排列的索引为 $\\{1,3,4,5,2,6,7,10,8,9\\}$。\n\n使用以下基本定义：\n- 受试者工作特征曲线下面积 (AUROC) 等于随机抽取的阳性样本得分严格高于随机抽取的阴性样本得分的概率，加上得分相等概率的一半。对于有 $m$ 个阳性样本和 $n$ 个阴性样本的有限样本，它可以计算为 $\\mathrm{AUROC} = \\frac{U}{mn}$，其中 $U$ 是 Mann–Whitney $U$ 统计量，用于计算阳性-阴性一致对的数量（对于得分相等的情况，权重为二分之一）。\n- 对于一个有阈值的分类器，$F_1$ 分数为 $F_1 = \\frac{2\\,\\mathrm{TP}}{2\\,\\mathrm{TP}+\\mathrm{FP}+\\mathrm{FN}}$，其中 $\\mathrm{TP}$、$\\mathrm{FP}$ 和 $\\mathrm{FN}$ 分别表示真阳性、假阳性和假阴性。对分数设定一个阈值，会产生一个基于排序的前 $k$ 个预测阳性样本的选择，$k \\in \\{1,2,\\dots,N\\}$，并从分数降序排列的前缀中确定 $(\\mathrm{TP},\\mathrm{FP},\\mathrm{FN})$。\n\n任务：使用 Mann–Whitney $U$ 统计量的排序解释来验证模型 $\\mathrm{A}$ 和 $\\mathrm{B}$ 具有相同的 AUROC，然后确定每个模型在所有阈值下可实现的最大 $F_1$ 分数，最后计算差值 $F_{1,\\max}^{(\\mathrm{B})} - F_{1,\\max}^{(\\mathrm{A})}$。将你的最终答案表示为一个最简分数。不需要四舍五入。", "solution": "该问题需要进行三部分分析：首先，验证模型 $\\mathrm{A}$ 和 $\\mathrm{B}$ 具有相同的受试者工作特征曲线下面积 (AUROC) 值；其次，确定每个模型在所有可能的分类阈值下可实现的最大 $F_1$ 分数；第三，计算这些最大 $F_1$ 分数之间的差值。\n\n真实数据包含 $N=10$ 名患者。真实标签集合为 $\\{Y_1=1, Y_2=1, Y_3=0, Y_4=1, Y_5=0, Y_6=1, Y_7=0, Y_8=0, Y_9=0, Y_{10}=1\\}$。\n这给出了 $m=5$ 个阳性实例（患者 $\\{1, 2, 4, 6, 10\\}$）和 $n=5$ 个阴性实例（患者 $\\{3, 5, 7, 8, 9\\}$）。\n\n## 第1部分：验证相同的 AUROC\n\nAUROC 定义为 $\\frac{U}{mn}$，其中 $U$ 是 Mann–Whitney $U$ 统计量。对于没有分数相等情况的样本，$U$ 是阳性实例得分高于阴性实例的（一个阳性，一个阴性）配对的数量。由于 AUROC 仅取决于分数的排序，我们首先为两个模型确定每个患者的排名，排名 $1$ 为最高分，排名 $10$ 为最低分。\n\n**模型 A:**\n分数 $s_i^{(\\mathrm{A})}$ 按患者索引 $i=1, 2, \\dots, 10$ 降序提供。\n按排名排序的患者索引列表是 $\\{1, 2, 3, 4, 5, 6, 7, 8, 9, 10\\}$。\n相应的真实标签序列是 $\\{Y_1, Y_2, \\dots, Y_{10}\\}$，即 $\\{1, 1, 0, 1, 0, 1, 0, 0, 0, 1\\}$。\n阳性样本（标签 $1$）是患者 $\\{1, 2, 4, 6, 10\\}$。他们的排名是 $\\{1, 2, 4, 6, 10\\}$。\n阴性样本（标签 $0$）是患者 $\\{3, 5, 7, 8, 9\\}$。他们的排名是 $\\{3, 5, 7, 8, 9\\}$。\n\n我们通过对每个阳性实例，将其得分低于它的阴性实例（即排名数值更高）的数量相加来计算 $U_A$。\n- 患者 $1$（排名 $1$）：排名高于所有 $5$ 个阴性样本（排名 $3, 5, 7, 8, 9$）。贡献：$5$。\n- 患者 $2$（排名 $2$）：排名高于所有 $5$ 个阴性样本。贡献：$5$。\n- 患者 $4$（排名 $4$）：排名高于 $4$ 个阴性样本（排名 $5, 7, 8, 9$）。贡献：$4$。\n- 患者 $6$（排名 $6$）：排名高于 $3$ 个阴性样本（排名 $7, 8, 9$）。贡献：$3$。\n- 患者 $10$（排名 $10$）：排名高于 $0$ 个阴性样本。贡献：$0$。\n模型 A 的 $U$ 统计量是 $U_A = 5+5+4+3+0=17$。\n模型 A 的 AUROC 是 $\\mathrm{AUROC}_A = \\frac{U_A}{mn} = \\frac{17}{5 \\times 5} = \\frac{17}{25}$。\n\n**模型 B:**\n问题提供了按排名排序的患者索引列表：$\\{1, 3, 4, 5, 2, 6, 7, 10, 8, 9\\}$。\n相应的真实标签序列是 $\\{Y_1, Y_3, Y_4, Y_5, Y_2, Y_6, Y_7, Y_{10}, Y_8, Y_9\\}$，即 $\\{1, 0, 1, 0, 1, 1, 0, 1, 0, 0\\}$。\n阳性样本是患者 $\\{1, 4, 2, 6, 10\\}$。他们的排名是 $\\{1, 3, 5, 6, 8\\}$。\n阴性样本是患者 $\\{3, 5, 7, 8, 9\\}$。他们的排名是 $\\{2, 4, 7, 9, 10\\}$。\n\n我们类似地计算 $U_B$：\n- 患者 $1$（排名 $1$）：排名高于所有 $5$ 个阴性样本（排名 $2, 4, 7, 9, 10$）。贡献：$5$。\n- 患者 $4$（排名 $3$）：排名高于 $4$ 个阴性样本（排名 $4, 7, 9, 10$）。贡献：$4$。\n- 患者 $2$（排名 $5$）：排名高于 $3$ 个阴性样本（排名 $7, 9, 10$）。贡献：$3$。\n- 患者 $6$（排名 $6$）：排名高于 $3$ 个阴性样本（排名 $7, 9, 10$）。贡献：$3$。\n- 患者 $10$（排名 $8$）：排名高于 $2$ 个阴性样本（排名 $9, 10$）。贡献：$2$。\n模型 B 的 $U$ 统计量是 $U_B = 5+4+3+3+2=17$。\n模型 B 的 AUROC 是 $\\mathrm{AUROC}_B = \\frac{U_B}{mn} = \\frac{17}{5 \\times 5} = \\frac{17}{25}$。\n\n因此，我们验证了 $\\mathrm{AUROC}_A = \\mathrm{AUROC}_B = \\frac{17}{25}$。\n\n## 第2部分：可实现的最大 $F_1$ 分数\n\n$F_1$ 分数由 $F_1 = \\frac{2\\,\\mathrm{TP}}{2\\,\\mathrm{TP}+\\mathrm{FP}+\\mathrm{FN}}$ 给出。一个分类阈值对应于从排名列表中选择前 $k$ 个患者，其中 $k \\in \\{1, \\dots, 10\\}$。对于这样的选择，预测阳性的数量是 $k = \\mathrm{TP}+\\mathrm{FP}$。实际阳性的总数固定为 $m = \\mathrm{TP}+\\mathrm{FN} = 5$。\n我们可以将 $F_1$ 分数重写为 $k$ 的函数：\n$$F_1(k) = \\frac{2\\,\\mathrm{TP}(k)}{(\\mathrm{TP}(k)+\\mathrm{FP}(k)) + (\\mathrm{TP}(k)+\\mathrm{FN}(k))} = \\frac{2\\,\\mathrm{TP}(k)}{k + m} = \\frac{2\\,\\mathrm{TP}(k)}{k+5}$$\n其中 $\\mathrm{TP}(k)$ 是排名前 $k$ 的患者中的真阳性数量。我们现在为每个模型计算 $k=1, \\dots, 10$ 时的 $F_1(k)$。\n\n**模型 A:**\n按排名排序的标签序列是 $\\{1, 1, 0, 1, 0, 1, 0, 0, 0, 1\\}$。\n- $k=1$: $\\mathrm{TP}(1)=1$, $F_1(1) = \\frac{2(1)}{1+5} = \\frac{2}{6} = \\frac{1}{3}$。\n- $k=2$: $\\mathrm{TP}(2)=2$, $F_1(2) = \\frac{2(2)}{2+5} = \\frac{4}{7}$。\n- $k=3$: $\\mathrm{TP}(3)=2$, $F_1(3) = \\frac{2(2)}{3+5} = \\frac{4}{8} = \\frac{1}{2}$。\n- $k=4$: $\\mathrm{TP}(4)=3$, $F_1(4) = \\frac{2(3)}{4+5} = \\frac{6}{9} = \\frac{2}{3}$。\n- $k=5$: $\\mathrm{TP}(5)=3$, $F_1(5) = \\frac{2(3)}{5+5} = \\frac{6}{10} = \\frac{3}{5}$。\n- $k=6$: $\\mathrm{TP}(6)=4$, $F_1(6) = \\frac{2(4)}{6+5} = \\frac{8}{11}$。\n- $k=7$: $\\mathrm{TP}(7)=4$, $F_1(7) = \\frac{2(4)}{7+5} = \\frac{8}{12} = \\frac{2}{3}$。\n- $k=8$: $\\mathrm{TP}(8)=4$, $F_1(8) = \\frac{2(4)}{8+5} = \\frac{8}{13}$。\n- $k=9$: $\\mathrm{TP}(9)=4$, $F_1(9) = \\frac{2(4)}{9+5} = \\frac{8}{14} = \\frac{4}{7}$。\n- $k=10$: $\\mathrm{TP}(10)=5$, $F_1(10) = \\frac{2(5)}{10+5} = \\frac{10}{15} = \\frac{2}{3}$。\n为了找到最大值，我们比较这些值。$\\frac{8}{11} \\approx 0.727$ 大于 $\\frac{2}{3} \\approx 0.667$ 和 $\\frac{8}{13} \\approx 0.615$。因此，模型 A 的最大 $F_1$ 分数是 $F_{1,\\max}^{(\\mathrm{A})} = \\frac{8}{11}$。\n\n**模型 B:**\n按排名排序的标签序列是 $\\{1, 0, 1, 0, 1, 1, 0, 1, 0, 0\\}$。\n- $k=1$: $\\mathrm{TP}(1)=1$, $F_1(1) = \\frac{2(1)}{1+5} = \\frac{1}{3}$。\n- $k=2$: $\\mathrm{TP}(2)=1$, $F_1(2) = \\frac{2(1)}{2+5} = \\frac{2}{7}$。\n- $k=3$: $\\mathrm{TP}(3)=2$, $F_1(3) = \\frac{2(2)}{3+5} = \\frac{1}{2}$。\n- $k=4$: $\\mathrm{TP}(4)=2$, $F_1(4) = \\frac{2(2)}{4+5} = \\frac{4}{9}$。\n- $k=5$: $\\mathrm{TP}(5)=3$, $F_1(5) = \\frac{2(3)}{5+5} = \\frac{3}{5}$。\n- $k=6$: $\\mathrm{TP}(6)=4$, $F_1(6) = \\frac{2(4)}{6+5} = \\frac{8}{11}$。\n- $k=7$: $\\mathrm{TP}(7)=4$, $F_1(7) = \\frac{2(4)}{7+5} = \\frac{2}{3}$。\n- $k=8$: $\\mathrm{TP}(8)=5$, $F_1(8) = \\frac{2(5)}{8+5} = \\frac{10}{13}$。\n- $k=9$: $\\mathrm{TP}(9)=5$, $F_1(9) = \\frac{2(5)}{9+5} = \\frac{10}{14} = \\frac{5}{7}$。\n- $k=10$: $\\mathrm{TP}(10)=5$, $F_1(10) = \\frac{2(5)}{10+5} = \\frac{2}{3}$。\n为了找到最大值，我们比较较大的值：$\\frac{8}{11} \\approx 0.727$，$\\frac{10}{13} \\approx 0.769$，以及 $\\frac{5}{7} \\approx 0.714$。最大值是 $\\frac{10}{13}$。因此，模型 B 的最大 $F_1$ 分数是 $F_{1,\\max}^{(\\mathrm{B})} = \\frac{10}{13}$。\n\n## 第3部分：最大 $F_1$ 分数的差值\n\n最后的任务是计算差值 $F_{1,\\max}^{(\\mathrm{B})} - F_{1,\\max}^{(\\mathrm{A})}$。\n$$F_{1,\\max}^{(\\mathrm{B})} - F_{1,\\max}^{(\\mathrm{A})} = \\frac{10}{13} - \\frac{8}{11}$$\n为了减去这两个分数，我们找到一个公分母，即 $13 \\times 11 = 143$。\n$$\\frac{10 \\times 11}{13 \\times 11} - \\frac{8 \\times 13}{11 \\times 13} = \\frac{110}{143} - \\frac{104}{143} = \\frac{110 - 104}{143} = \\frac{6}{143}$$\n分数 $\\frac{6}{143}$ 是最简形式，因为 $6 = 2 \\times 3$ 和 $143=11 \\times 13$ 没有公因数。\n这个结果表明，即使具有相同的区分能力（AUROC），模型在基于阈值的指标（如 $F_1$ 分数）下也可能表现出不同的最优性能，这是由于它们对个体案例的排序方式不同。", "answer": "$$\\boxed{\\frac{6}{143}}$$", "id": "4585277"}, {"introduction": "我们的最后一个实践将从计算性能指标转向进行统计上稳健的比较。你将实现一个配对自助法（paired bootstrap）检验，以确定两个模型之间 Brier 分数的差异是否具有统计显著性。这个练习将使你掌握一项进行严谨模型选择的关键技能，确保你的结论不仅仅是你所使用的特定测试集的偶然产物。[@problem_id:4585270]", "problem": "您的任务是构建一个完整、可运行的程序，该程序实现一个配对非参数自助法（bootstrap）假设检验，用于检验在同一组患者上评估的两个概率分类器之间Brier分数的差异。对于二元结果，Brier分数的定义如下。对于患者级别的结果 $y_i \\in \\{0,1\\}$、来自模型 $m \\in \\{1,2\\}$ 的预测概率 $p_i^{(m)} \\in [0,1]$ 以及大小为 $n$ 的数据集，模型 $m$ 的经验Brier分数是\n$$\n\\mathrm{BS}_m = \\frac{1}{n} \\sum_{i=1}^{n} \\left( p_i^{(m)} - y_i \\right)^2.\n$$\n将观测到的Brier分数差异定义为\n$$\n\\Delta_{\\mathrm{obs}} = \\mathrm{BS}_1 - \\mathrm{BS}_2.\n$$\n较低的 $\\mathrm{BS}_m$ 值表示更好的概率准确性。由于两个模型都在同一批患者上进行评估，这会在 $\\left(p_i^{(1)}, p_i^{(2)}, y_i\\right)$ 之间引起患者内相关性，因此分析必须尊重患者级别的配对。\n\n您的任务是使用基于患者级别单位的配对非参数自助法，对原假设 $H_0: \\Delta = 0$ 与双边备择假设 $H_1: \\Delta \\neq 0$ 进行假设检验。自助法必须有放回地对患者索引 $i \\in \\{1,\\dots,n\\}$ 进行重抽样，并在每个自助样本上重新计算Brier分数差异，以生成一个经验分布。令 $\\Delta_b^{\\ast}$ 表示在第 $b$ 次自助法重复（$b \\in \\{1,\\dots,B\\}$）中计算出的Brier差异。请使用以下基于原则的步骤：\n\n1. 观测统计量。在完整数据集上计算 $\\Delta_{\\mathrm{obs}}$。\n\n2. 配对自助法重抽样。对于每次自助法重复 $b$，从 $\\{1,\\dots,n\\}$ 中有放回地抽取 $n$ 个索引，将这些索引应用于患者级别的三元组 $\\left(p_i^{(1)}, p_i^{(2)}, y_i\\right)$，并计算\n$$\n\\Delta_b^{\\ast} = \\frac{1}{n} \\sum_{j=1}^{n} \\left( p_{i_j}^{(1)} - y_{i_j} \\right)^2 - \\frac{1}{n} \\sum_{j=1}^{n} \\left( p_{i_j}^{(2)} - y_{i_j} \\right)^2,\n$$\n其中 $i_j$ 是第 $b$ 次重复的重抽样索引。\n\n3. 双边自助法实现的显著性水平。使用中心化的自助分布来近似 $H_0$ 下的抽样分布，从而计算双边自助法 $p$ 值：\n$$\np_{\\mathrm{boot}} = \\frac{1 + \\sum_{b=1}^{B} \\mathbf{1}\\left( \\left| \\Delta_b^{\\ast} - \\Delta_{\\mathrm{obs}} \\right| \\ge \\left| \\Delta_{\\mathrm{obs}} \\right| \\right)}{B + 1}.\n$$\n此公式包含观测统计量，以避免在有限的 $B$ 下出现零 $p$ 值。\n\n4. 自助法置信区间。通过使用 $\\{\\Delta_b^{\\ast}\\}_{b=1}^{B}$ 的经验分位数，采用百分位法为 $\\Delta$ 构建一个双边 $95\\%$ 置信区间：\n$$\n\\left[ \\mathrm{quantile}_{0.025}\\left(\\{\\Delta_b^{\\ast}\\}\\right),\\ \\mathrm{quantile}_{0.975}\\left(\\{\\Delta_b^{\\ast}\\}\\right) \\right].\n$$\n\n您必须依赖且不得违反的假设：患者级别的观测值 $\\left(p_i^{(1)}, p_i^{(2)}, y_i\\right)$ 在索引 $i$ 上是独立同分布（i.i.d.），其中 $y_i \\in \\{0,1\\}$ 且 $p_i^{(m)} \\in [0,1]$。在每次自助法重复中，必须保留 $\\left(p_i^{(1)}, p_i^{(2)}, y_i\\right)$ 的配对关系。\n\n您的程序必须为一组固定的测试场景实现上述过程。在每个场景中，您必须使用提供的参数、logistic函数 $\\sigma(t) = \\frac{1}{1 + e^{-t}}$ 以及指定的用于结果生成的随机种子，确定性地生成结果和模型预测。对于每个场景，计算并报告：\n- 观测到的Brier分数差异 $\\Delta_{\\mathrm{obs}}$，\n- 双边自助法 $p$ 值 $p_{\\mathrm{boot}}$，\n- $95\\%$ 百分位自助法置信区间的下限和上限，\n- 以及一个布尔决策 $\\mathrm{reject}_{0.05}$，指示 $p_{\\mathrm{boot}}  0.05$ 是否成立。\n\n所有数值输出必须报告为小数点后四舍五入到六位的小数。布尔值必须报告为 True 或 False。\n\n测试套件规范。对于每个测试案例 $k$，定义 $n$、结果生成种子 $s_y$、自助法种子 $s_b$、自助法重复次数 $B$ 以及用于构建患者级别协变量、结果和预测的方案。使用以下四种情况：\n\n- Case A (中等样本，不同斜率):\n  - $n = 60$。\n  - 构建 $x_i$ 为一个从 $-2$ 到 $2$ 包含 $n$ 个点的线性间隔网格。\n  - 定义真实概率函数 $q_i = \\sigma(0.5 x_i - 0.3)$。\n  - 使用种子 $s_y = 0$ 生成 $y_i \\sim \\mathrm{Bernoulli}(q_i)$。\n  - 模型 1 预测： $p_i^{(1)} = \\sigma(0.5 x_i - 0.3)$。\n  - 模型 2 预测： $p_i^{(2)} = \\sigma(0.8 x_i - 0.3)$。\n  - 自助法： $B = 4000$，种子 $s_b = 123$。\n\n- Case B (相同模型，健全性检查):\n  - $n = 40$。\n  - 构建 $x_i$ 为一个从 $-1$ 到 $1$ 包含 $n$ 个点的线性间隔网格。\n  - 定义 $q_i = \\sigma(0.2 x_i + 0.1)$。\n  - 使用种子 $s_y = 202$ 生成 $y_i \\sim \\mathrm{Bernoulli}(q_i)$。\n  - 模型 1 预测： $p_i^{(1)} = q_i$。\n  - 模型 2 预测： $p_i^{(2)} = q_i$。\n  - 自助法： $B = 3000$，种子 $s_b = 321$。\n\n- Case C (类别不平衡，常数预测变量):\n  - $n = 80$。\n  - 对所有 $i$ 设置 $q_i \\equiv 0.08$。\n  - 使用种子 $s_y = 404$ 生成 $y_i \\sim \\mathrm{Bernoulli}(q_i)$。\n  - 模型 1 预测： $p_i^{(1)} \\equiv 0.08$。\n  - 模型 2 预测： $p_i^{(2)} \\equiv 0.15$。\n  - 自助法： $B = 5000$，种子 $s_b = 999$。\n\n- Case D (小样本，不同校准强度):\n  - $n = 10$。\n  - 定义 $x = [-4.0, -2.0, -1.0, -0.5, 0.0, 0.5, 1.0, 2.0, 3.0, 4.0]$。\n  - 定义 $q_i = \\sigma(1.2 x_i - 0.5)$。\n  - 使用种子 $s_y = 77$ 生成 $y_i \\sim \\mathrm{Bernoulli}(q_i)$。\n  - 模型 1 预测： $p_i^{(1)} = \\sigma(1.2 x_i - 0.5)$。\n  - 模型 2 预测： $p_i^{(2)} = \\sigma(0.6 x_i - 0.2)$。\n  - 自助法： $B = 2000$，种子 $s_b = 42$。\n\n最终输出格式。您的程序应生成单行输出，其中包含一个含四个子列表的列表，每个子列表对应一个测试案例，顺序为A、B、C、D。每个子列表必须按顺序包含五个元素 $\\left[\\Delta_{\\mathrm{obs}}, p_{\\mathrm{boot}}, \\mathrm{CI}_{\\mathrm{low}}, \\mathrm{CI}_{\\mathrm{high}}, \\mathrm{reject}_{0.05}\\right]$。整个输出必须以单行形式呈现，为一个带方括号、逗号分隔的子列表列表，不含空格，例如：\n[[0.012345,0.502000,-0.010000,0.034000,False],[...],[...],[...]]", "solution": "该问题是有效的。它在统计模型比较领域提出了一个清晰、明确且科学上合理的任务，这是生物信息学和医学数据分析的一个基本方面。所有必要的数据、公式和计算过程都得到了无歧义的规定，使得该问题是自洽且适定的。所采用的方法论，即使用配对非参数自助法来处理Brier分数的差异，是在同一数据集上比较概率分类器的一种标准且适用的技术。\n\n该解决方案将通过首先定义一个函数来执行单个测试案例的完整流程来实现。这包括确定性数据生成、观测统计量的计算、自助法重抽样过程的执行，以及最终结果（$p$值和置信区间）的计算。然后，一个主函数将遍历四个指定的测试案例，收集结果，并将其格式化为所需的单行字符串输出。\n\n**1. 问题阐述**\n\n目标是比较两个概率分类器（表示为模型1和模型2）基于它们对二元结果的预测准确性。这些模型在同一组 $n$ 名患者上进行评估，我们拥有这些患者的真实结果 $y_i \\in \\{0, 1\\}$ 和每个模型的预测概率 $p_i^{(1)}$ 和 $p_i^{(2)}$，其中 $i \\in \\{1, \\dots, n\\}$。\n\nBrier分数（$\\mathrm{BS}$）被用作评估指标。对于给定的模型 $m$，它是预测概率与实际结果之间的均方误差：\n$$\n\\mathrm{BS}_m = \\frac{1}{n} \\sum_{i=1}^{n} \\left( p_i^{(m)} - y_i \\right)^2.\n$$\n较低的Brier分数表示更好的模型校准度和准确性。我们感兴趣的统计量是两个模型之间Brier分数的差异：\n$$\n\\Delta = \\mathrm{BS}_1 - \\mathrm{BS}_2.\n$$\n$\\Delta  0$ 的值表明模型1优于模型2，而 $\\Delta > 0$ 则表明相反情况。在给定数据集上的观测差异表示为 $\\Delta_{\\mathrm{obs}}$。\n\n**2. 假设检验框架**\n\n我们执行一个假设检验，以确定观测到的差异 $\\Delta_{\\mathrm{obs}}$ 是否具有统计显著性。原假设和备择假设是：\n- 原假设，$H_0: \\Delta = 0$。两个模型之间没有性能差异。\n- 备择假设，$H_1: \\Delta \\neq 0$。性能存在差异。\n\n由于两个模型都在同一组患者上进行评估，误差 $(p_i^{(1)} - y_i)^2$ 和 $(p_i^{(2)} - y_i)^2$ 不是独立的。患者级别的三元组 $(p_i^{(1)}, p_i^{(2)}, y_i)$ 是基本的观测单位，在统计检验期间必须保留它们的配对结构。对于这种情况，配对非参数自助法是一种合适的方法。\n\n**3. 配对非参数自助法程序**\n\n该过程包括四个主要步骤：\n\n**步骤1：计算观测统计量**\n首先，我们在原始的完整数据集上计算模型1和模型2的Brier分数。\n$$\n\\mathrm{BS}_1 = \\frac{1}{n} \\sum_{i=1}^{n} \\left( p_i^{(1)} - y_i \\right)^2 \\quad \\text{和} \\quad \\mathrm{BS}_2 = \\frac{1}{n} \\sum_{i=1}^{n} \\left( p_i^{(2)} - y_i \\right)^2.\n$$\n然后计算观测差异为 $\\Delta_{\\mathrm{obs}} = \\mathrm{BS}_1 - \\mathrm{BS}_2$。\n\n**步骤2：生成自助分布**\n我们通过从原始数据中重抽样来为统计量 $\\Delta$ 生成一个经验抽样分布。这个过程进行 $B$ 次自助法重复。对于每次重复 $b \\in \\{1, \\dots, B\\}$：\n- 通过从原始索引集 $\\{1, 2, \\dots, n\\}$ 中有放回地抽取 $n$ 个索引 $\\{i_1, i_2, \\dots, i_n\\}$ 来创建一个自助样本。\n- 使用这些重抽样的索引，我们形成一个新的患者三元组数据集：$\\{(p_{i_j}^{(1)}, p_{i_j}^{(2)}, y_{i_j})\\}_{j=1}^n$。\n- 为该自助样本计算Brier分数差异：\n$$\n\\Delta_b^{\\ast} = \\frac{1}{n} \\sum_{j=1}^{n} \\left( p_{i_j}^{(1)} - y_{i_j} \\right)^2 - \\frac{1}{n} \\sum_{j=1}^{n} \\left( p_{i_j}^{(2)} - y_{i_j} \\right)^2.\n$$\n这个过程重复 $B$ 次，以获得一组自助统计量 $\\{\\Delta_b^{\\ast}\\}_{b=1}^B$。这个集合近似于 $\\Delta$ 的抽样分布。\n\n**步骤3：计算双边p值**\n为了检验原假设 $H_0: \\Delta = 0$，我们评估观测统计量 $\\Delta_{\\mathrm{obs}}$ 相对于 $H_0$ 下 $\\Delta$ 的分布有多极端。自助分布 $\\{\\Delta_b^{\\ast}\\}$ 以 $\\Delta_{\\mathrm{obs}}$ 为中心。为了模拟零分布（以0为中心），我们可以通过从每个 $\\Delta_b^{\\ast}$ 中减去 $\\Delta_{\\mathrm{obs}}$ 来使自助分布中心化。该检验衡量了在此零分布下，观测到至少与 $|\\Delta_{\\mathrm{obs}}|$ 一样大的差异的概率。这对应于计算中心化统计量 $\\Delta_b^{\\ast} - \\Delta_{\\mathrm{obs}}$ 距离0至少与 $\\Delta_{\\mathrm{obs}}$ 一样远的自助法重复的比例。双边 $p$ 值正式计算如下：\n$$\np_{\\mathrm{boot}} = \\frac{1 + \\sum_{b=1}^{B} \\mathbf{1}\\left( \\left| \\Delta_b^{\\ast} - \\Delta_{\\mathrm{obs}} \\right| \\ge \\left| \\Delta_{\\mathrm{obs}} \\right| \\right)}{B + 1}.\n$$\n指示函数 $\\mathbf{1}(\\cdot)$ 在其参数为真时为1，否则为0。在分子和分母上都加1可以防止在有限的重复次数 $B$ 下出现 $p$ 值为0，并且考虑了观测样本本身。\n\n**步骤4：构建置信区间**\n可以使用百分位法为真实差异 $\\Delta$ 构建一个双边 $95\\%$ 置信区间（CI）。该方法使用非中心化自助分布 $\\{\\Delta_b^{\\ast}\\}$ 的分位数。CI的下限和上限由 $\\Delta_b^{\\ast}$ 经验分布的第 $2.5$ 和第 $97.5$ 个百分位数给出：\n$$\n\\mathrm{CI}_{95\\%} = \\left[ \\mathrm{quantile}_{0.025}\\left(\\{\\Delta_b^{\\ast}\\}\\right),\\ \\mathrm{quantile}_{0.975}\\left(\\{\\Delta_b^{\\ast}\\}\\right) \\right].\n$$\n如果该区间不包含0，则在 $\\alpha=0.05$ 的显著性水平上提供了反对原假设 $H_0$ 的证据。\n\n**4. 实现细节**\n\n实现将使用 `numpy` 库在 Python 中进行。使用带有指定种子的 `numpy.random.default_rng` 可确保合成数据生成和自助法重抽样过程的可复现性。将利用 `numpy` 中的向量化操作来高效计算Brier分数和自助统计量。每个测试案例将由一个封装了上述逻辑的专用函数处理，最终结果将被格式化以满足精确的输出规范。\nlogistic函数 $\\sigma(t) = (1 + e^{-t})^{-1}$ 用于根据测试案例中的规定生成真实概率和模型预测。\n通过将计算出的p值与显著性水平 $\\alpha = 0.05$ 进行比较，来做出拒绝 $H_0$ 的最终决定。\n_如果 $p_{\\mathrm{boot}}  0.05$，则决策为 `True`，否则为 `False`。_", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print the results.\n    \"\"\"\n\n    # Logistic (sigmoid) function\n    def sigmoid(t):\n        return 1 / (1 + np.exp(-t))\n\n    def run_bootstrap_test(n, data_gen_params, B, s_y, s_b):\n        \"\"\"\n        Executes the paired nonparametric bootstrap test for a single scenario.\n\n        Args:\n            n (int): Sample size.\n            data_gen_params (dict): Parameters to generate data (x_vals, q_func, p1_func, p2_func).\n            B (int): Number of bootstrap replicates.\n            s_y (int): Random seed for outcome generation.\n            s_b (int): Random seed for bootstrap resampling.\n\n        Returns:\n            list: A list containing [delta_obs, p_boot, ci_low, ci_high, reject_0.05].\n        \"\"\"\n        # --- 1. Data Generation ---\n        rng_y = np.random.default_rng(s_y)\n        \n        x_vals = data_gen_params['x_vals']\n        q_func = data_gen_params['q_func']\n        p1_func = data_gen_params['p1_func']\n        p2_func = data_gen_params['p2_func']\n\n        q = q_func(x_vals)\n        p1 = p1_func(x_vals)\n        p2 = p2_func(x_vals)\n        \n        # Generate binary outcomes y_i ~ Bernoulli(q_i)\n        y = rng_y.binomial(1, q, size=n)\n\n        # --- 2. Observed Statistic ---\n        # Calculate individual squared errors\n        e1 = (p1 - y)**2\n        e2 = (p2 - y)**2\n        \n        # Calculate Brier Scores\n        bs1_obs = np.mean(e1)\n        bs2_obs = np.mean(e2)\n        \n        # Observed difference\n        delta_obs = bs1_obs - bs2_obs\n\n        # --- 3. Paired Bootstrap Resampling ---\n        rng_b = np.random.default_rng(s_b)\n        delta_star_values = np.zeros(B)\n        \n        # Vectorized resampling for efficiency\n        indices = rng_b.integers(0, n, size=(B, n))\n        e_diff = e1 - e2\n        delta_star_values = np.mean(e_diff[indices], axis=1)\n            \n        # --- 4. p-value and Confidence Interval ---\n        # Two-sided bootstrap p-value\n        abs_delta_obs = np.abs(delta_obs)\n        # Handle the case where delta_obs is numerically zero\n        if abs_delta_obs  1e-12:\n            p_boot = 1.0\n        else:\n            count = np.sum(np.abs(delta_star_values - delta_obs) >= abs_delta_obs)\n            p_boot = (1 + count) / (B + 1)\n        \n        # 95% percentile confidence interval\n        ci_low = np.quantile(delta_star_values, 0.025)\n        ci_high = np.quantile(delta_star_values, 0.975)\n        \n        # Decision rule\n        reject_0_05 = p_boot  0.05\n        \n        return [\n            round(delta_obs, 6),\n            round(p_boot, 6),\n            round(ci_low, 6),\n            round(ci_high, 6),\n            reject_0_05\n        ]\n\n    # Test suite specification\n    test_cases = [\n        {\n            \"name\": \"Case A\",\n            \"n\": 60,\n            \"data_gen_params\": {\n                \"x_vals\": np.linspace(-2, 2, 60),\n                \"q_func\": lambda x: sigmoid(0.5 * x - 0.3),\n                \"p1_func\": lambda x: sigmoid(0.5 * x - 0.3),\n                \"p2_func\": lambda x: sigmoid(0.8 * x - 0.3),\n            },\n            \"B\": 4000,\n            \"s_y\": 0,\n            \"s_b\": 123,\n        },\n        {\n            \"name\": \"Case B\",\n            \"n\": 40,\n            \"data_gen_params\": {\n                \"x_vals\": np.linspace(-1, 1, 40),\n                \"q_func\": lambda x: sigmoid(0.2 * x + 0.1),\n                \"p1_func\": lambda x: sigmoid(0.2 * x + 0.1),\n                \"p2_func\": lambda x: sigmoid(0.2 * x + 0.1),\n            },\n            \"B\": 3000,\n            \"s_y\": 202,\n            \"s_b\": 321,\n        },\n        {\n            \"name\": \"Case C\",\n            \"n\": 80,\n            \"data_gen_params\": {\n                \"x_vals\": np.arange(80), # Pass a dummy array for shape consistency\n                \"q_func\": lambda x: np.full(80, 0.08),\n                \"p1_func\": lambda x: np.full(80, 0.08),\n                \"p2_func\": lambda x: np.full(80, 0.15),\n            },\n            \"B\": 5000,\n            \"s_y\": 404,\n            \"s_b\": 999,\n        },\n        {\n            \"name\": \"Case D\",\n            \"n\": 10,\n            \"data_gen_params\": {\n                \"x_vals\": np.array([-4.0, -2.0, -1.0, -0.5, 0.0, 0.5, 1.0, 2.0, 3.0, 4.0]),\n                \"q_func\": lambda x: sigmoid(1.2 * x - 0.5),\n                \"p1_func\": lambda x: sigmoid(1.2 * x - 0.5),\n                \"p2_func\": lambda x: sigmoid(0.6 * x - 0.2),\n            },\n            \"B\": 2000,\n            \"s_y\": 77,\n            \"s_b\": 42,\n        }\n    ]\n\n    all_results = []\n    for case in test_cases:\n        result = run_bootstrap_test(\n            case[\"n\"],\n            case[\"data_gen_params\"],\n            case[\"B\"],\n            case[\"s_y\"],\n            case[\"s_b\"],\n        )\n        all_results.append(result)\n    \n    # Format the final output string exactly as specified\n    output_str = str(all_results).replace(\" \", \"\").replace(\"'\", \"\")\n    print(output_str)\n\nsolve()\n```", "id": "4585270"}]}