## 引言
在生物信息学和医学数据分析领域，时间-事件数据（或称生存数据）无处不在，它描述了从一个明确的起点到一个终点事件所经过的时间。准确分析和解释这类数据对于评估治疗效果、发现预后生物标志物和理解疾病进展至关重要。然而，[生存数据](@entry_id:165675)常伴有删失（censoring）这一特性，即我们无法观察到所有研究对象的完整事件时间，这为标准统计分析带来了巨大挑战。[Kaplan-Meier](@entry_id:169317) (KM) 估计和对数秩 (log-rank) 检验是为应对这一挑战而设计的两大经典非参数方法，它们是整个生存分析领域的基石。尽管这些方法在各类统计软件中易于实现，但对其背后原理、核心假设和潜在陷阱的肤浅理解，往往会导致错误的分析和误导性的结论。本文旨在填补理论与实践之间的鸿沟，提供一个关于KM估计和对数秩检验的全面而深入的指南。我们将通过三个章节的探索，带领读者从基础走向精通。在“原理与机制”一章中，我们将深入剖析这些方法的数学基础，揭示它们如何巧妙地处理删失数据。接着，在“应用与跨学科连接”一章中，我们将展示这些工具在临床医学、基因组学和机器学习中的强大应用，并讨论如何应对混杂、竞争风险等现实世界的复杂性。最后，通过“动手实践”部分，您将有机会通过解决具体问题，将理论知识转化为可操作的技能。

## 原理与机制

本章将深入探讨生存分析中两个基石性的[非参数方法](@entry_id:138925)：用于估计生存函数的 [Kaplan-Meier](@entry_id:169317) (KM) 方法和用于比较生存分布的[对数秩检验](@entry_id:168043) (log-rank test)。我们将从基本定义出发，系统地阐述这些方法的构建原理、计算机制、核心假设，并讨论在处理复杂[数据结构](@entry_id:262134)（如延迟进入和竞争风险）时需要注意的关键问题。

### 时间-事件分析的语言

在深入探讨统计方法之前，我们必须首先掌握时间-事件分析的独特语言。这套语言使我们能够精确地描述和量化从某个起点到一个终点事件所经过的时间。

#### 核心概念：生存、风险与累积发生率

假设我们关注的随机变量 $T$ 是一个非负的**事件时间** (event time)，例如从诊断到疾病进展的时间。为了完整描述 $T$ 的分布，我们定义了几个关键函数：

1.  **生存函数 (Survival Function)**, $S(t)$：这是在时间-事件分析中最重要的函数，定义为个体生存时间超过某一特定时间点 $t$ 的概率。
    $$S(t) = \mathbb{P}(T > t)$$
    生存函数是一个非增函数，其起始值为 $S(0) = 1$（在时间起点，所有个体都“存活”），并随着时间的推移趋向于 $0$（如果事件最终必然发生）[@problem_id:4576947]。

2.  **累积分布函数 (Cumulative Distribution Function)**, $F(t)$：这与生存函数互补，表示事件在时间点 $t$ 或之前发生的概率。
    $$F(t) = \mathbb{P}(T \le t) = 1 - S(t)$$
    $F(t)$ 是一个非减函数，从 $F(0)=0$ 开始，最终趋向于 $1$ [@problem_id:4576947]。

3.  **风险函数 (Hazard Function)**, $h(t)$：也称为[瞬时失效率](@entry_id:171877) (instantaneous failure rate)，它描述了在时间点 $t$ 仍然“存活”的个体，在下一个极小时间间隔内发生事件的[瞬时速率](@entry_id:182981)。
    $$h(t) = \lim_{\Delta t \to 0} \frac{\mathbb{P}(t \le T  t+\Delta t \mid T \ge t)}{\Delta t}$$
    [风险函数](@entry_id:166593)捕捉了事件发生的“风险强度”。它与生存函数之间存在着深刻的数学联系。如果我们将 $h(t)$ 对[时间积分](@entry_id:267413)，得到**[累积风险函数](@entry_id:169734) (cumulative hazard function)** $H(t) = \int_0^t h(u)du$，那么生存函数可以表示为：
    $$S(t) = \exp(-H(t)) = \exp\left(-\int_0^t h(u)du\right)$$
    这个关系是许多生存分析模型（包括后续将讨论的Cox比例风险模型）的理论基础 [@problem_id:4576923]。

#### 删失：不完整信息的挑战

在理想情况下，我们可以跟踪研究中的每个个体，直到观察到他们发生目标事件为止。然而，在现实世界的生物信息学和临床研究中，数据往往是“不完整”的。这种不完整性被称为**删失 (censoring)**。理解不同类型的删失对于选择正确的分析方法至关重要。

-   **[右删失](@entry_id:164686) (Right Censoring)**：这是最常见的删失类型。当我们在某个时间点 $c$ 停止观察某个个体，而该个体尚未发生事件时，就会发生[右删失](@entry_id:164686)。这可能是因为研究结束、患者失访或因其他原因退出研究。我们所知道的只是该个体的真实事件时间 $T$ 大于 $c$，即 $T > c$。该观测对[似然函数](@entry_id:141927)的贡献是 $\mathbb{P}(T > c) = S(c)$。

-   **[左删失](@entry_id:169731) (Left Censoring)**：当我们在第一次观察时，发现事件已经发生，但不知道确切的发生时间。例如，在研究某种慢性病的发生时，如果在首次检查时就发现患者已患病，我们只知道事件时间 $T$ 小于或等于首次检查时间 $\ell$，即 $T \le \ell$。该观测对[似然函数](@entry_id:141927)的贡献是 $\mathbb{P}(T \le \ell) = F(\ell)$。

-   **[区间删失](@entry_id:636589) (Interval Censoring)**：当事件的发生时间只能被确定在某个时间区间 $(\ell, r]$ 内时，就会发生[区间删失](@entry_id:636589)。这在需要定期随访的研究中很常见，例如，如果一个患者在时间点 $\ell$ 的检查中呈阴性，但在时间点 $r$ 的检查中呈阳性，我们便知道事件发生在 $(\ell, r]$ 之间。该观测对似然函数的贡献是 $\mathbb{P}(\ell  T \le r) = S(\ell) - S(r)$。

标准的 Kaplan-Meier 估计和经典的[对数秩检验](@entry_id:168043)是为处理**精确事件时间**和**[右删失](@entry_id:164686)**数据而设计的。它们无法直接处理[左删失](@entry_id:169731)或[区间删失](@entry_id:636589)数据，这些情况需要更复杂的统计方法或对标准方法的扩展 [@problem_id:4576943]。在本章的其余部分，我们将主要关注右删失数据。

### 生存函数的非[参数估计](@entry_id:139349)：[Kaplan-Meier估计量](@entry_id:178062)

面对右[删失数据](@entry_id:173222)，我们如何估计生存函数 $S(t)$？一个简单的方法，比如用（期初总人数 - 到 $t$ 为止的事件数）/ 期初总人数，是错误的，因为它忽略了删失个体提供的信息（即他们在删失前一直存活），从而会系统性地低估生存率 [@problem_id:4576947]。

[Kaplan-Meier](@entry_id:169317) (KM) 估计量，也称为**[乘积极限估计量](@entry_id:171437) (product-limit estimator)**，提供了一种优雅的非参数解决方案。其核心思想是将生存到时间 $t$ 的概率分解为一系列在各个事件时间点“幸存”下来的[条件概率](@entry_id:151013)的乘积。

#### 乘积极限公式

KM 估计量的计算公式如下：
$$ \hat{S}(t) = \prod_{i: t_i \le t} \left(1 - \frac{d_i}{n_i}\right) $$
这里的符号定义如下：
-   $t_i$：按时间顺序排列的、发生事件的**不同**时间点。
-   $d_i$：在时间点 $t_i$ 发生的事件数量。
-   $n_i$：在时间点 $t_i$ **之前瞬间**，仍然处于“风险”中的个体数量，即尚未发生事件也未被删失的个体总数。这个集合被称为**风险集 (risk set)**。

每一项 $(1 - d_i/n_i)$ 都可以被看作是在时间点 $t_i$ 存活下来的条件概率的估计值。通过将所有直至时间 $t$ 的这些条件概率相乘，我们便得到了生存到时间 $t$ 之后的总概率的估计值。

#### 风险集的概念与演变

正确构建每个事件时间点的**风险集**是KM估计和对数秩检验的关键。风险集 $R(t)$ 在时间 $t$ 定义为所有在该时间点或之后才发生事件或被删失的个体集合，即 $R(t) = \{i: T_i \ge t\}$，其中 $T_i$ 是观测时间 [@problem_id:4576963]。风险集的大小 $n_i = |R(t_i)|$ 随着时间的推移而动态变化：
-   在每个事件时间点之后，发生事件的个体会从风险集中移除。
-   在每个删失时间点之后，被删失的个体会从风险集中移除。

一个重要的计算约定是处理在同一时间点发生的事件和删失。标准做法是：**在计算时间点 $t$ 的生存概率时，事件被认为发生在删失之前**。这意味着，在时间点 $t$ 被删失的个体仍然被包含在计算该时间点生存概率的风险集 $n_t$ 中。他们是在为时间 $t$ 的计算做出贡献之后，才被移出风险集，从而影响后续时间点的计算 [@problem_id:4576963]。

#### [Kaplan-Meier](@entry_id:169317) 曲线的计算示例

让我们通过一个具体的例子来演示KM估计的计算过程。考虑来自一项研究的B组数据，共有5名个体 [@problem_id:4576981]：
-   B1: 时间 1, 事件
-   B2: 时间 3, 删失
-   B3: 时间 4, 事件
-   B4: 时间 6, 事件
-   B5: 时间 8, 删失

B组的事件时间点为 $t=1, 4, 6$。

1.  **初始状态 ($t=0$)**: 风险集大小 $n=5$。$\hat{S}(0)=1$。
2.  **第一个事件时间 ($t_1=1$)**:
    -   风险集大小 $n_1=5$。
    -   事件数 $d_1=1$。
    -   生存概率估计更新为：$\hat{S}(1) = \hat{S}(0) \times (1 - d_1/n_1) = 1 \times (1 - 1/5) = 4/5$。
3.  **$t=3$ 时**: 个体B2被删失。风险集人数减少1人。KM曲线在删失点保持平坦。
4.  **第二个事件时间 ($t_2=4$)**:
    -   风险集大小 $n_2=3$ (初始5人 - 1个事件 - 1个删失)。
    -   事件数 $d_2=1$。
    -   生存概率估计更新为：$\hat{S}(4) = \hat{S}(1) \times (1 - d_2/n_2) = (4/5) \times (1 - 1/3) = 8/15$。
5.  **第三个事件时间 ($t_3=6$)**:
    -   风险集大小 $n_3=2$ (之前3人 - 1个事件)。
    -   事件数 $d_3=1$。
    -   生存概率估计更新为：$\hat{S}(6) = \hat{S}(4) \times (1 - d_3/n_3) = (8/15) \times (1 - 1/2) = 4/15$。

因此，在时间 $t=6.5$ 时，B组的KM生存估计值为 $\hat{S}_B(6.5) = \hat{S}_B(6) = 4/15 \approx 0.267$ [@problem_id:4576981]。K[M估计量](@entry_id:169257)是一个右连续的阶梯函数，仅在观测到的事件时间点发生跳跃。

#### 理论基础：为何KM曲线是阶梯函数？

K[M估计量](@entry_id:169257)的[阶梯函数](@entry_id:159192)形式并非偶然，它源于**[非参数最大似然估计](@entry_id:164132) (Nonparametric Maximum Likelihood Estimation, [NPMLE](@entry_id:164132))** 的深刻原理。在右[删失数据](@entry_id:173222)的框架下，[似然函数](@entry_id:141927)由两部分构成：一部分来自发生事件的观测，另一部分来自被删失的观测。

-   对于在时间 $t_j$ 发生的事件，其对似然的贡献与在该时间点发生事件的概率（或概率质量）$p_j$ 成正比。
-   对于在时间 $c$ 被删失的观测，其贡献等于生存到该时间点之后的概率 $S(c)$。

为了最大化总[似然函数](@entry_id:141927)，我们需要决定如何在一个非参数的生存[函数空间](@entry_id:136890)里分配概率质量。可以证明，任何将正的概率[质量分配](@entry_id:751704)给一个**没有观测到事件**的时间点的生存函数，都不是最优的。因为这样做（即在该时间点创建一个“跳跃”）不会增加任何事件观测的似然贡献，反而会降低所有在该时间点之后被删失的观测的生存概率 $S(c)$，从而导致总[似然函数](@entry_id:141927)减小。因此，最大化似然的策略是将全部概率质量集中在那些**实际观测到事件**的时间点。这从根本上解释了为什么K[M估计量](@entry_id:169257)是一个仅在事件时间点发生跳跃的阶梯函数 [@problem_id:4576957]。

### 比较生存分布：[对数秩检验](@entry_id:168043)

在临床试验或基因组学研究中，一个常见的问题是：两种疗法（或两个基因型组）的生存分布是否存在显著差异？[对数秩检验](@entry_id:168043) (Log-rank test) 是回答这个问题的标准非参数方法。

#### 检验的零假设

对数秩检验的**零假设 ($H_0$)** 是两个或多个组的**风险函数**在所有时间点上都相等。例如，对于两组，我们有：
$$ H_0: h_1(t) = h_2(t) \quad \text{for all } t \ge 0 $$
鉴于生存函数与风险函数之间的关系 $S(t) = \exp(-\int_0^t h(u)du)$，[风险函数](@entry_id:166593)的相等性直接等价于生存函数的相等性：
$$ H_0: S_1(t) = S_2(t) \quad \text{for all } t \ge 0 $$
因此，[对数秩检验](@entry_id:168043)实际上是在检验整个生存曲线是否相同 [@problem_id:4576923]。

#### 检验统计量的构建

[对数秩检验](@entry_id:168043)的核心思想是“观察值 vs. [期望值](@entry_id:150961)”的比较。它在每个事件时间点 $t_i$ 比较一个组中**观察到**的事件数与在零假设下**期望**发生的事件数。

1.  **在每个事件时间点 $t_i$**：
    -   我们将两个组合并，考虑总风险集 $n_i = n_{1i} + n_{2i}$ 和总事件数 $d_i = d_{1i} + d_{2i}$。
    -   在 $H_0$ 成立的条件下，所有 $n_i$ 个个体都有相同的事件风险。因此，这 $d_i$ 个事件应该[按比例分配](@entry_id:634725)到两个组中。
    -   组1中**期望**的事件数 $E_{1i}$ 可以通过一个简单的比例计算得出，这背后是[超几何分布](@entry_id:193745)模型：
        $$ E_{1i} = E[d_{1i}] = d_i \cdot \frac{n_{1i}}{n_i} $$
        这个公式是构建[对数秩检验](@entry_id:168043)统计量的基石 [@problem_id:4576922]。

2.  **汇总所有事件时间点的信息**：
    -   对数秩检验通过加总在**所有**不同事件时间点上的“观察值减[期望值](@entry_id:150961)”(Observed-minus-Expected)的差异来构建一个总的统计量 $U$：
        $$ U = \sum_{i} (O_{1i} - E_{1i}) = \sum_{i} \left(d_{1i} - d_i \cdot \frac{n_{1i}}{n_i}\right) $$
        其中 $O_{1i}$ 就是 $d_{1i}$ [@problem_id:4576979]。

3.  **最终的检验统计量**：
    -   $U$ 的值如果偏离0很远，就说明有证据反对零假设。为了进行[统计推断](@entry_id:172747)，我们需要 $U$ 的方差 $V$。方差 $V$ 也是通过在每个事件时间点加总方差贡献得到的（其公式基于[超几何分布](@entry_id:193745)的方差）。
    -   最终的对数秩检验统计量是一个卡方统计量，自由度为 (组数 - 1)：
        $$ \chi^2 = \frac{U^2}{V} $$
    -   我们将这个计算出的 $\chi^2$ 值与具有相应自由度的[卡方分布](@entry_id:165213)的临界值进行比较，以获得 p 值。

#### [对数秩检验](@entry_id:168043)的计算示例

让我们继续使用之前的数据 [@problem_id:4576981]，比较A组和B组的生存曲线。A组数据为：$(2, \text{事件}), (4, \text{事件}), (5, \text{删失}), (7, \text{事件}), (9, \text{删失})$。B组数据同前。合并后的事件时间为 $t = 1, 2, 4, 6, 7$。

我们构建一个表格来计算每个事件时间点的观察值(O)、[期望值](@entry_id:150961)(E)和方差贡献(V)：

| $t_i$ | 风险集 (A, B) | 总风险集 $n_i$ | 事件数 (A, B) | 总事件数 $d_i$ | A组 $O_{Ai}$ | A组 $E_{Ai}$ | $O_{Ai}-E_{Ai}$ | 方差 $V_i$ |
|---|---|---|---|---|---|---|---|---|
| 1 | (5, 5) | 10 | (0, 1) | 1 | 0 | $1 \cdot \frac{5}{10} = 0.5$ | -0.5 | 0.25 |
| 2 | (5, 4) | 9 | (1, 0) | 1 | 1 | $1 \cdot \frac{5}{9} \approx 0.556$ | 0.444 | 0.247 |
| 4 | (4, 3) | 7 | (1, 1) | 2 | 1 | $2 \cdot \frac{4}{7} \approx 1.143$ | -0.143 | 0.408 |
| 6 | (2, 2) | 4 | (0, 1) | 1 | 0 | $1 \cdot \frac{2}{4} = 0.5$ | -0.5 | 0.25 |
| 7 | (2, 1) | 3 | (1, 0) | 1 | 1 | $1 \cdot \frac{2}{3} \approx 0.667$ | 0.333 | 0.222 |

汇总计算：
-   $U = \sum(O_{Ai} - E_{Ai}) \approx -0.365$
-   $V = \sum V_i \approx 1.377$

最终的[检验统计量](@entry_id:167372)：
$$ \chi^2 = \frac{(-0.365)^2}{1.377} \approx 0.097 $$
这个值远小于在 $\alpha=0.05$ 水平下自由度为1的[卡方分布](@entry_id:165213)临界值（约3.84），因此我们没有足够的证据拒绝零假设，即两组的生存分布没有统计学上的显著差异 [@problem_id:4576981]。

### 假设与进阶主题

KM估计和对数秩检验虽然强大且应用广泛，但它们的有效性依赖于一系列关键假设。此外，在处理更复杂的[数据结构](@entry_id:262134)时，需要对这些基本方法进行适当的调整或使用更高级的模型。

#### 核心假设

1.  **独立观测 (Independent Observations)**：每个个体的生存经历被假定为与其他个体独立。这个假设在处理聚集性数据（例如，来自同一家庭的患者）时可能会被违反。在这种情况下，需要使用稳健[方差估计](@entry_id:268607)或混合效应模型来修正标准方法的方差计算 [@problem_id:4576970]。

2.  **非信息性删失 (Non-informative Censoring)**：这是生存分析中**最关键**的假设。它要求在任何时间点，一个被删失的个体在未来的事件风险方面，能够代表所有在该时间点仍然处于风险集中的其他个体。简而言之，删失的原因不能与事件的预后相关。例如，如果病情更严重的患者更有可能失访，那么这种删失就是“信息性的”，会导致生存率的严重偏倚。标准KM估计和对数秩检验对信息性删失不具有稳健性。

3.  **充分的随访时间**：为了在时间区间 $[0, \tau]$ 内一致地估计 $S(t)$，我们需要在该区间内有非零的概率观察到个体仍处于风险之中。

#### 对数秩检验的功效与最优性

对数秩检验在所有情况下都不是最优的。它的统计功效（即检测到真实差异的能力）依赖于两组[风险函数](@entry_id:166593)的相对形态。

-   对数秩检验在**[比例风险](@entry_id:166780) (proportional hazards, PH)** 假设下具有最大的功效。[比例风险](@entry_id:166780)意味着两组的[风险函数](@entry_id:166593)在所有时间点上成恒定比例，即 $h_1(t) = \theta \cdot h_2(t)$，其中风险比 (hazard ratio) $\theta$ 是一个常数。在这种情况下，对数秩检验（其权重在所有时间点上都为1）是检测这种恒定信号的最优选择 [@problem_id:4576959]。

-   当风险函数**不满足比例性**时，例如出现**交叉风险**（一个疗法早期更好，晚期更差），[对数秩检验](@entry_id:168043)的功效会大大降低，因为它会将早期和晚期的相反效应（正负的 $O-E$ 值）相互抵消。对于早期效应更强的替代假设，给予早期事件更大权重的加权对数秩检验（如Gehan-[Wilcoxon检验](@entry_id:172291)）会更有效 [@problem_id:4576959]。

#### 处理复杂数据结构

**1. 延迟进入（左截断）**

在某些研究中，个体不是在时间起点 $t=0$ 就进入风险集，而是在一个稍晚的、个体特定的时间 $L_i > 0$ 才开始被观察。这种情况被称为**延迟进入 (delayed entry)** 或 **左截断 (left truncation)**。例如，在基于生物标志物的研究中，患者可能只有在测序报告出来后才能被纳入分析。

为了正确处理左[截断数据](@entry_id:163004)，我们必须修改风险集的定义。个体 $i$ 在时间 $t$ 处于风险集中的条件是：他/她必须已经进入研究 ($L_i \le t$) 并且尚未发生事件或被删失 ($T_i \ge t$)。因此，修正后的风险集为：
$$ R(t) = \{i: L_i \le t \text{ and } T_i \ge t\} $$
在应用KM估计和对数秩检验时，只需使用这个修正后的风险集定义来计算每个时间点的 $n_i$ 和 $n_{gi}$，其余计算流程保持不变 [@problem_id:4576967]。

**2. [竞争风险](@entry_id:173277)**

在许多生物医学研究中，个体可能经历多种不同类型的事件，而任何一种事件的发生都会阻止其他事件的发生。这些事件被称为**竞争风险 (competing risks)**。例如，在评估癌症进展时，患者可能因治疗毒性而死亡，这种死亡就是一个与癌症进展相竞争的事件。

在这种情况下，我们通常感兴趣的量是特定原因（如原因1）的**累积发生率函数 (Cumulative Incidence Function, CIF)**，定义为到时间 $t$ 为止因原因1发生事件的概率, $F_1(t) = \mathbb{P}(T \le t, \text{事件原因}=1)$。

一个非常常见但**严重错误**的做法是，在估计原因1的发生率时，将所有其他原因的事件（如竞争风险事件）当作右删失处理，然后计算 $1 - \hat{S}_{KM}(t)$。这种方法是错误的，因为它违反了非信息性删失的核心假设。竞争事件的发生提供了确切的信息：该个体永远不会再经历我们感兴趣的事件。

将竞争事件视为删失，会人为地保留本应已退出风险集的个体，导致对“净生存率”的估计出现偏差，从而**高估**真实的累积发生率。正确的分析方法需要使用专门为竞争风险设计的模型来直接估计CIF，例如Aalen-Johansen估计量。只有在竞争风险完全不存在的情况下（即其风险函数恒为零），这种偏倚才会消失 [@problem_id:4576966]。这是生存分析实践中一个至关重要的概念陷阱。