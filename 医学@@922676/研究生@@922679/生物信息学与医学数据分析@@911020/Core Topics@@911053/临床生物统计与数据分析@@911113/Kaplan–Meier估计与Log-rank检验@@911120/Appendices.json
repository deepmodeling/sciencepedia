{"hands_on_practices": [{"introduction": "理论知识是基础，但只有通过亲手实践，我们才能真正掌握其精髓。本节练习将引导您从零开始，逐步手动计算Kaplan-Meier生存估计和对数秩（log-rank）检验统计量。这项基础计算练习对于深入理解风险集、事件和删失数据如何共同作用于最终的生存估计和检验结果至关重要，它将揭开统计软件包背后算法的神秘面纱。[@problem_id:4576971]", "problem": "一项晚期肿瘤学的临床基因组学研究旨在比较两个分子队列的总体生存率：一个突变阳性队列和一个野生型队列。基线为研究入组时间 $t=0$，随访时间以月为单位。在非信息性右删失的假设下，生存函数 $S(t)$ 定义为 $S(t) = \\Pr(T > t)$，其中 $T$ 为非负事件时间。给定个体观测时间 $t_i$ 和右删失指示符 $\\delta_i$，其中 $\\delta_i = 1$ 表示事件发生，$\\delta_i = 0$ 表示右删失。两个队列如下：\n\n突变阳性队列（$\\mathcal{M}$ 组），$8$ 个个体：\n- M1: $t_1 = 2, \\delta_1 = 1$\n- M2: $t_2 = 5, \\delta_2 = 0$\n- M3: $t_3 = 6, \\delta_3 = 1$\n- M4: $t_4 = 7, \\delta_4 = 1$\n- M5: $t_5 = 9, \\delta_5 = 0$\n- M6: $t_6 = 12, \\delta_6 = 1$\n- M7: $t_7 = 15, \\delta_7 = 0$\n- M8: $t_8 = 18, \\delta_8 = 1$\n\n野生型队列（$\\mathcal{W}$ 组），$8$ 个个体：\n- W1: $t_1 = 3, \\delta_1 = 1$\n- W2: $t_2 = 4, \\delta_2 = 1$\n- W3: $t_3 = 8, \\delta_3 = 0$\n- W4: $t_4 = 10, \\delta_4 = 1$\n- W5: $t_5 = 11.5, \\delta_5 = 0$\n- W6: $t_6 = 14, \\delta_6 = 1$\n- W7: $t_7 = 17, \\delta_7 = 0$\n- W8: $t_8 = 20, \\delta_8 = 1$\n\n任务：\n- 仅使用 $S(t)$ 和右删失的基本定义，从合并队列中识别出不同的观测事件时间，并在每个此类时间 $t_{(j)}$，构建合并风险集大小 $n_{j}$（紧邻 $t_{(j)}$ 之前的风险个体数）、事件计数 $d_{j}$，以及特定组的风险集大小 $n_{\\mathcal{M},j}$ 和 $n_{\\mathcal{W},j}$ 与特定组的事件指示符。\n- 根据第一性原理，逐步推导两个队列的 Kaplan–Meier (KM) 估计量，通过在特定队列的事件时间进行乘法更新，并明确显示每个事件时间的贡献。\n- 在两个队列随时间具有相同风险函数的零假设下，在每个事件时间，于每个合并风险集内使用有限总体抽样逻辑，构建用于比较 $\\mathcal{M}$ 组与 $\\mathcal{W}$ 组的对数秩统计量。\n\n报告用于比较 $\\mathcal{M}$ 与 $\\mathcal{W}$ 的对数秩卡方统计量的最终值。将您的最终数值答案四舍五入至四位有效数字。在最终报告中不要包含任何单位。", "solution": "此问题经评估为**有效**。它提出了一个生物统计学中的标准且适定的问题，特别是在生存分析领域。两个队列（突变阳性队列和野生型队列）的所有必要数据均已提供，包括观测时间和事件/删失指示符。假设（非信息性右删失）和定义（生存函数 $S(t)$）都已明确说明。任务——构建风险集、推导 Kaplan-Meier 估计量和计算对数秩统计量——是基于所提供数据的标准程序。该问题具有科学依据，内容自洽且客观，没有矛盾、歧义或事实错误。\n\n分析的核心是使用对数秩检验比较两个队列——$\\mathcal{M}$ 组（突变阳性）和 $\\mathcal{W}$ 组（野生型）——的生存分布。此检验在零假设 $H_0$ 下进行，即两组之间的生存（或风险）函数没有差异。该检验统计量是通过将研究过程中每个不同事件时间的观测事件数与预期事件数之差求和来构建的。\n\n首先，我们必须合并两个队列的数据，并识别所有不同的事件时间，记为 $t_{(j)}$，其中 $j=1, \\dots, k$。删失观测值用于在每个事件时间正确确定风险集的大小。在时间 $t_{(j)}$ 的风险集（记为 $n_j$）由所有在 $t_{(j)}$ 之前尚未经历事件且未被删失的个体组成。\n\n合并数据中的不同事件时间为：$2, 3, 4, 6, 7, 10, 12, 14, 18, 20$。\n在每个这 $k=10$ 个事件时间点，我们列表整理以下量：\n- $t_{(j)}$: 第 $j$ 个不同的事件时间。\n- $n_{\\mathcal{M},j}$ 和 $n_{\\mathcal{W},j}$: 在紧邻 $t_{(j)}$ 之前，$\\mathcal{M}$ 组和 $\\mathcal{W}$ 组中各自的风险个体数。\n- $n_j = n_{\\mathcal{M},j} + n_{\\mathcal{W},j}$: 风险个体总数。\n- $d_{\\mathcal{M},j}$ 和 $d_{\\mathcal{W},j}$: 在时间 $t_{(j)}$ 时，$\\mathcal{M}$ 组和 $\\mathcal{W}$ 组中各自观测到的事件数。\n- $d_j = d_{\\mathcal{M},j} + d_{\\mathcal{W},j}$: 在 $t_{(j)}$ 时的事件总数。\n\n下表总结了这些信息，这些信息是通过从 $t=0$ 开始仔细追踪受试者得出的：\n| $j$ | $t_{(j)}$ | $n_{\\mathcal{M},j}$ | $n_{\\mathcal{W},j}$ | $n_j$ | $d_{\\mathcal{M},j}$ | $d_{\\mathcal{W},j}$ | $d_j$ |\n|---|---|---|---|---|---|---|---|\n| $1$ | $2$  | $8$ | $8$ | $16$ | $1$ | $0$ | $1$ |\n| $2$ | $3$  | $7$ | $8$ | $15$ | $0$ | $1$ | $1$ |\n| $3$ | $4$  | $7$ | $7$ | $14$ | $0$ | $1$ | $1$ |\n| $4$ | $6$  | $6$ | $6$ | $12$ | $1$ | $0$ | $1$ |\n| $5$ | $7$  | $5$ | $6$ | $11$ | $1$ | $0$ | $1$ |\n| $6$ | $10$ | $3$ | $5$ | $8$  | $0$ | $1$ | $1$ |\n| $7$ | $12$ | $3$ | $3$ | $6$  | $1$ | $0$ | $1$ |\n| $8$ | $14$ | $2$ | $3$ | $5$  | $0$ | $1$ | $1$ |\n| $9$ | $18$ | $1$ | $1$ | $2$  | $1$ | $0$ | $1$ |\n| $10$| $20$ | $0$ | $1$ | $1$  | $0$ | $1$ | $1$ |\n\n按照要求，我们首先推导两个队列的 Kaplan-Meier (KM) 估计量。生存函数 $\\hat{S}(t)$ 的 KM 估计量是乘积极限估计量：$\\hat{S}(t) = \\prod_{t_{(i)} \\le t} \\left(1 - \\frac{d_i}{n_i}\\right)$，使用特定队列的事件时间、事件计数和风险集计算。\n\n对于突变阳性队列 ($\\mathcal{M}$):\n- 事件时间：$2, 6, 7, 12, 18$。\n- 对于 $t \\in [0, 2)$，$\\hat{S}_{\\mathcal{M}}(t) = 1$。\n- 在 $t=2$ 时：$n_{\\mathcal{M}}=8, d_{\\mathcal{M}}=1$。对于 $t \\in [2, 6)$，$\\hat{S}_{\\mathcal{M}}(t) = 1 - \\frac{1}{8} = \\frac{7}{8}$。\n- 在 $t=6$ 时：$n_{\\mathcal{M}}=6, d_{\\mathcal{M}}=1$。对于 $t \\in [6, 7)$，$\\hat{S}_{\\mathcal{M}}(t) = \\frac{7}{8} \\times (1 - \\frac{1}{6}) = \\frac{7}{8} \\times \\frac{5}{6} = \\frac{35}{48}$。\n- 在 $t=7$ 时：$n_{\\mathcal{M}}=5, d_{\\mathcal{M}}=1$。对于 $t \\in [7, 12)$，$\\hat{S}_{\\mathcal{M}}(t) = \\frac{35}{48} \\times (1 - \\frac{1}{5}) = \\frac{35}{48} \\times \\frac{4}{5} = \\frac{7}{12}$。\n- 在 $t=12$ 时：$n_{\\mathcal{M}}=3, d_{\\mathcal{M}}=1$。对于 $t \\in [12, 18)$，$\\hat{S}_{\\mathcal{M}}(t) = \\frac{7}{12} \\times (1 - \\frac{1}{3}) = \\frac{7}{12} \\times \\frac{2}{3} = \\frac{7}{18}$。\n- 在 $t=18$ 时：$n_{\\mathcal{M}}=1, d_{\\mathcal{M}}=1$。对于 $t \\ge 18$，$\\hat{S}_{\\mathcal{M}}(t) = \\frac{7}{18} \\times (1 - \\frac{1}{1}) = 0$。\n\n对于野生型队列 ($\\mathcal{W}$):\n- 事件时间：$3, 4, 10, 14, 20$。\n- 对于 $t \\in [0, 3)$，$\\hat{S}_{\\mathcal{W}}(t) = 1$。\n- 在 $t=3$ 时：$n_{\\mathcal{W}}=8, d_{\\mathcal{W}}=1$。对于 $t \\in [3, 4)$，$\\hat{S}_{\\mathcal{W}}(t) = 1 - \\frac{1}{8} = \\frac{7}{8}$。\n- 在 $t=4$ 时：$n_{\\mathcal{W}}=7, d_{\\mathcal{W}}=1$。对于 $t \\in [4, 10)$，$\\hat{S}_{\\mathcal{W}}(t) = \\frac{7}{8} \\times (1 - \\frac{1}{7}) = \\frac{3}{4}$。\n- 在 $t=10$ 时：$n_{\\mathcal{W}}=5, d_{\\mathcal{W}}=1$。对于 $t \\in [10, 14)$，$\\hat{S}_{\\mathcal{W}}(t) = \\frac{3}{4} \\times (1 - \\frac{1}{5}) = \\frac{3}{5}$。\n- 在 $t=14$ 时：$n_{\\mathcal{W}}=3, d_{\\mathcal{W}}=1$。对于 $t \\in [14, 20)$，$\\hat{S}_{\\mathcal{W}}(t) = \\frac{3}{5} \\times (1 - \\frac{1}{3}) = \\frac{2}{5}$。\n- 在 $t=20$ 时：$n_{\\mathcal{W}}=1, d_{\\mathcal{W}}=1$。对于 $t \\ge 20$，$\\hat{S}_{\\mathcal{W}}(t) = \\frac{2}{5} \\times (1 - \\frac{1}{1}) = 0$。\n\n现在，我们构建对数秩统计量。对于每个事件时间 $t_{(j)}$，我们在零假设下计算 $\\mathcal{M}$ 组的预期事件数 $E_{\\mathcal{M},j}$。该值由事件总数 $d_j$ 乘以属于 $\\mathcal{M}$ 组的风险集比例给出：$E_{\\mathcal{M},j} = d_j \\frac{n_{\\mathcal{M},j}}{n_j}$。$\\mathcal{M}$ 组中观测事件数 $d_{\\mathcal{M},j}$ 的方差源自超几何分布：$V_j = \\frac{n_{\\mathcal{M},j} n_{\\mathcal{W},j} d_j (n_j - d_j)}{n_j^2 (n_j - 1)}$。\n\n然后，对数秩统计量 $\\chi^2$ 按如下方式计算：\n$$ \\chi^2 = \\frac{(O_{\\mathcal{M}} - E_{\\mathcal{M}})^2}{V} $$\n其中 $O_{\\mathcal{M}} = \\sum_{j=1}^{k} d_{\\mathcal{M},j}$，$E_{\\mathcal{M}} = \\sum_{j=1}^{k} E_{\\mathcal{M},j}$，以及 $V = \\sum_{j=1}^{k} V_j$。\n\n让我们计算各个组成部分：\n$\\mathcal{M}$ 组的总观测事件数：$O_{\\mathcal{M}} = 1+0+0+1+1+0+1+0+1+0 = 5$。\n\n$\\mathcal{M}$ 组的总预期事件数：\n$$E_{\\mathcal{M}} = \\sum_{j=1}^{10} d_j \\frac{n_{\\mathcal{M},j}}{n_j} = 1\\left(\\frac{8}{16}\\right) + 1\\left(\\frac{7}{15}\\right) + 1\\left(\\frac{7}{14}\\right) + 1\\left(\\frac{6}{12}\\right) + 1\\left(\\frac{5}{11}\\right) + 1\\left(\\frac{3}{8}\\right) + 1\\left(\\frac{3}{6}\\right) + 1\\left(\\frac{2}{5}\\right) + 1\\left(\\frac{1}{2}\\right) + 1\\left(\\frac{0}{1}\\right)$$\n$$E_{\\mathcal{M}} = \\frac{1}{2} + \\frac{7}{15} + \\frac{1}{2} + \\frac{1}{2} + \\frac{5}{11} + \\frac{3}{8} + \\frac{1}{2} + \\frac{2}{5} + \\frac{1}{2} + 0 = \\frac{5}{2} + \\frac{7}{15} + \\frac{5}{11} + \\frac{3}{8} + \\frac{2}{5} = \\frac{5539}{1320} \\approx 4.19621$$\n\n总方差：\n$$V = \\sum_{j=1}^{10} V_j = \\frac{8 \\cdot 8 \\cdot 1 \\cdot 15}{16^2(15)} + \\frac{7 \\cdot 8 \\cdot 1 \\cdot 14}{15^2(14)} + \\frac{7 \\cdot 7 \\cdot 1 \\cdot 13}{14^2(13)} + \\frac{6 \\cdot 6 \\cdot 1 \\cdot 11}{12^2(11)} + \\frac{5 \\cdot 6 \\cdot 1 \\cdot 10}{11^2(10)} + \\frac{3 \\cdot 5 \\cdot 1 \\cdot 7}{8^2(7)} + \\frac{3 \\cdot 3 \\cdot 1 \\cdot 5}{6^2(5)} + \\frac{2 \\cdot 3 \\cdot 1 \\cdot 4}{5^2(4)} + \\frac{1 \\cdot 1 \\cdot 1 \\cdot 1}{2^2(1)} + 0$$\n$$V = \\frac{64}{256} + \\frac{56}{225} + \\frac{49}{196} + \\frac{36}{144} + \\frac{30}{121} + \\frac{15}{64} + \\frac{9}{36} + \\frac{6}{25} + \\frac{1}{4}$$\n$$V = \\frac{1}{4} + \\frac{56}{225} + \\frac{1}{4} + \\frac{1}{4} + \\frac{30}{121} + \\frac{15}{64} + \\frac{1}{4} + \\frac{6}{25} + \\frac{1}{4} = \\frac{5}{4} + \\frac{56}{225} + \\frac{30}{121} + \\frac{15}{64} + \\frac{6}{25}$$\n将这些分数相加得到 $V = \\frac{3870215}{1742400} \\approx 2.22120$。\n\n现在，我们计算 $\\chi^2$ 统计量：\n$$O_{\\mathcal{M}} - E_{\\mathcal{M}} = 5 - \\frac{5539}{1320} = \\frac{6600 - 5539}{1320} = \\frac{1061}{1320}$$\n$$(O_{\\mathcal{M}} - E_{\\mathcal{M}})^2 = \\left(\\frac{1061}{1320}\\right)^2 = \\frac{1125721}{1742400}$$\n\n$$\\chi^2 = \\frac{(O_{\\mathcal{M}} - E_{\\mathcal{M}})^2}{V} = \\frac{1125721/1742400}{3870215/1742400} = \\frac{1125721}{3870215} \\approx 0.290867$$\n\n将结果四舍五入到四位有效数字，得到 $0.2909$。", "answer": "$$\n\\boxed{0.2909}\n$$", "id": "4576971"}, {"introduction": "在真实的临床研究中，我们常常需要处理可能扭曲组间比较结果的混杂变量，而分层分析是解决这一问题的关键技术。此练习将对数秩检验（log-rank test）扩展到分层情景，您需要在每个预定义的层内独立进行计算，然后汇总结果。通过完成这个分层计算，您将学会如何校正混杂因素的影响，从而在比较生存结果时得出更可靠、更稳健的结论。[@problem_id:4576961]", "problem": "一项肿瘤学研究评估了两种疗法，标记为 A 组（治疗组）和 B 组（对照组），在由 RNA 测序定义的 $3$ 个转录组学分层中的无进展生存期。在每个分层内，考虑每个不同事件时间点之前的有限总体风险集，并假设在列出的每个时间点恰好发生 $1$ 个事件（在列出的时间点没有并列的失败事件）。对于每个分层 $s \\in \\{1,2,3\\}$ 和有序事件时间 $t_{s,j}$，给定 $t_{s,j}$ 之前的风险集人数对 $(n_{A,sj}, n_{B,sj})$ 以及事件发生的组。\n\n分层 $1$：\n- 在 $t_{1,1}$ 时：风险集 $(n_{A,11}, n_{B,11}) = (10, 12)$；事件发生在 A 组。\n- 在 $t_{1,2}$ 时：风险集 $(n_{A,12}, n_{B,12}) = (9, 12)$；事件发生在 B 组。\n- 在 $t_{1,3}$ 时：风险集 $(n_{A,13}, n_{B,13}) = (8, 10)$；事件发生在 A 组。\n\n分层 $2$：\n- 在 $t_{2,1}$ 时：风险集 $(n_{A,21}, n_{B,21}) = (15, 15)$；事件发生在 B 组。\n- 在 $t_{2,2}$ 时：风险集 $(n_{A,22}, n_{B,22}) = (14, 14)$；事件发生在 B 组。\n- 在 $t_{2,3}$ 时：风险集 $(n_{A,23}, n_{B,23}) = (14, 13)$；事件发生在 A 组。\n- 在 $t_{2,4}$ 时：风险集 $(n_{A,24}, n_{B,24}) = (13, 13)$；事件发生在 A 组。\n\n分层 $3$：\n- 在 $t_{3,1}$ 时：风险集 $(n_{A,31}, n_{B,31}) = (6, 9)$；事件发生在 A 组。\n- 在 $t_{3,2}$ 时：风险集 $(n_{A,32}, n_{B,32}) = (5, 9)$；事件发生在 B 组。\n\n仅从以下核心定义出发：在 A 组和 B 组具有相等的分层特定风险率的原假设 $H_{0}$ 下，时间 $t_{s,j}$ 的单个事件来自 A 组的条件概率等于该时刻风险集中 A 组的比例，并且条件方差遵循从有限风险集中进行一次无放回抽样的逻辑。请执行以下操作：\n\n- 对于每个分层内列出的每个事件时间，计算 A 组的“观测值减期望值”增量及其在 $H_{0}$ 下的条件方差，条件为该时间的风险集。\n- 将这些增量和方差在所有列出的时间和所有分层上求和，以获得一个总的“观测值减期望值”和一个总方差。\n- 构建自由度为 $1$ 的分层对数秩卡方统计量，其值为总“观测值减期望值”的平方除以总方差。\n\n将最终的卡方值报告为单个实数，四舍五入到 $4$ 位有效数字。不需要单位。", "solution": "我们要使用分层对数秩检验比较跨多个分层的两种疗法。我们使用的基本原则是：\n\n1. 在每个分层内风险率相等的原假设 $H_{0}$ 下，在给定失败时间的事件来自特定组的瞬时概率等于该时间点之前即刻风险集中该组的比例。如果在时间 $t_{s,j}$ 的风险集在 A 组有 $n_{A,sj}$ 人，在 B 组有 $n_{B,sj}$ 人，那么在该时间点恰好发生一个事件的情况下，事件来自 A 组的条件概率是\n$$\np_{s,j} \\equiv \\frac{n_{A,sj}}{n_{A,sj} + n_{B,sj}}.\n$$\n\n2. 以每次一个事件（无并列）的风险集为条件，事件发生在 A 组的指示变量的方差是\n$$\n\\operatorname{Var}_{H_{0}}(I\\{\\text{event in }A\\}\\mid \\text{risk set}) \\;=\\; p_{s,j}\\bigl(1 - p_{s,j}\\bigr),\n$$\n因为当从总体中无放回地抽取恰好一个单位时，有限总体校正因子等于 $1$。\n\n对于每个事件时间，将 A 组的“观测值减期望值”增量定义为\n$$\n\\Delta_{s,j} \\;=\\; I\\{\\text{event in }A\\} \\;-\\; p_{s,j},\n$$\n其条件方差为 $\\sigma^{2}_{s,j} = p_{s,j}\\bigl(1 - p_{s,j}\\bigr)$。\n\n我们将在每个列出的事件中计算 $\\Delta_{s,j}$ 和 $\\sigma^{2}_{s,j}$，然后在所有分层和事件上求和：\n$$\nU \\;=\\; \\sum_{s}\\sum_{j} \\Delta_{s,j}, \\qquad V \\;=\\; \\sum_{s}\\sum_{j} \\sigma^{2}_{s,j},\n$$\n并最终构建自由度为 1 的分层对数秩卡方统计量：\n$$\nX^{2} \\;=\\; \\frac{U^{2}}{V}.\n$$\n\n按分层计算贡献。\n\n分层 $1$：\n- $t_{1,1}$：$(n_{A}, n_{B}) = (10,12)$，所以 $p = \\frac{10}{22} = \\frac{5}{11}$。事件在 A 组，得出 $\\Delta_{1,1} = 1 - \\frac{5}{11} = \\frac{6}{11}$，并且 $\\sigma^{2}_{1,1} = \\frac{5}{11}\\cdot\\frac{6}{11} = \\frac{30}{121}$。\n- $t_{1,2}$：$(n_{A}, n_{B}) = (9,12)$，所以 $p = \\frac{9}{21} = \\frac{3}{7}$。事件在 B 组，得出 $\\Delta_{1,2} = 0 - \\frac{3}{7} = -\\frac{3}{7}$，并且 $\\sigma^{2}_{1,2} = \\frac{3}{7}\\cdot\\frac{4}{7} = \\frac{12}{49}$。\n- $t_{1,3}$：$(n_{A}, n_{B}) = (8,10)$，所以 $p = \\frac{8}{18} = \\frac{4}{9}$。事件在 A 组，得出 $\\Delta_{1,3} = 1 - \\frac{4}{9} = \\frac{5}{9}$，并且 $\\sigma^{2}_{1,3} = \\frac{4}{9}\\cdot\\frac{5}{9} = \\frac{20}{81}$。\n\n对分层 1 求和：\n$$\nU_{1} \\;=\\; \\frac{6}{11} \\;-\\; \\frac{3}{7} \\;+\\; \\frac{5}{9} \\;=\\; \\frac{466}{693},\n$$\n$$\nV_{1} \\;=\\; \\frac{30}{121} \\;+\\; \\frac{12}{49} \\;+\\; \\frac{20}{81} \\;=\\; \\frac{355262}{480249}.\n$$\n\n分层 $2$：\n- $t_{2,1}$：$(n_{A}, n_{B}) = (15,15)$，$p = \\frac{1}{2}$，事件在 B 组：$\\Delta_{2,1} = -\\frac{1}{2}$，$\\sigma^{2}_{2,1} = \\frac{1}{4}$。\n- $t_{2,2}$：$(n_{A}, n_{B}) = (14,14)$，$p = \\frac{1}{2}$，事件在 B 组：$\\Delta_{2,2} = -\\frac{1}{2}$，$\\sigma^{2}_{2,2} = \\frac{1}{4}$。\n- $t_{2,3}$：$(n_{A}, n_{B}) = (14,13)$，$p = \\frac{14}{27}$，事件在 A 组：$\\Delta_{2,3} = 1 - \\frac{14}{27} = \\frac{13}{27}$，$\\sigma^{2}_{2,3} = \\frac{14}{27}\\cdot\\frac{13}{27} = \\frac{182}{729}$。\n- $t_{2,4}$：$(n_{A}, n_{B}) = (13,13)$，$p = \\frac{1}{2}$，事件在 A 组：$\\Delta_{2,4} = \\frac{1}{2}$，$\\sigma^{2}_{2,4} = \\frac{1}{4}$。\n\n对分层 2 求和：\n$$\nU_{2} \\;=\\; -\\frac{1}{2} \\;-\\; \\frac{1}{2} \\;+\\; \\frac{13}{27} \\;+\\; \\frac{1}{2} \\;=\\; -\\frac{1}{2} \\;+\\; \\frac{13}{27} \\;=\\; -\\frac{1}{54},\n$$\n$$\nV_{2} \\;=\\; \\frac{1}{4} \\;+\\; \\frac{1}{4} \\;+\\; \\frac{182}{729} \\;+\\; \\frac{1}{4} \\;=\\; \\frac{3}{4} \\;+\\; \\frac{182}{729} \\;=\\; \\frac{2915}{2916}.\n$$\n\n分层 $3$：\n- $t_{3,1}$：$(n_{A}, n_{B}) = (6,9)$，$p = \\frac{6}{15} = \\frac{2}{5}$，事件在 A 组：$\\Delta_{3,1} = 1 - \\frac{2}{5} = \\frac{3}{5}$，$\\sigma^{2}_{3,1} = \\frac{2}{5}\\cdot\\frac{3}{5} = \\frac{6}{25}$。\n- $t_{3,2}$：$(n_{A}, n_{B}) = (5,9)$，$p = \\frac{5}{14}$，事件在 B 组：$\\Delta_{3,2} = -\\frac{5}{14}$，$\\sigma^{2}_{3,2} = \\frac{5}{14}\\cdot\\frac{9}{14} = \\frac{45}{196}$。\n\n对分层 3 求和：\n$$\nU_{3} \\;=\\; \\frac{3}{5} \\;-\\; \\frac{5}{14} \\;=\\; \\frac{17}{70},\n$$\n$$\nV_{3} \\;=\\; \\frac{6}{25} \\;+\\; \\frac{45}{196} \\;=\\; \\frac{2301}{4900}.\n$$\n\n跨分层汇总：\n$$\nU \\;=\\; U_{1} + U_{2} + U_{3} \\;=\\; \\frac{466}{693} \\;-\\; \\frac{1}{54} \\;+\\; \\frac{17}{70}.\n$$\n使用最小公分母 $20790$，我们得到\n$$\nU \\;=\\; \\frac{466\\cdot 30 \\;-\\; 1\\cdot 385 \\;+\\; 17\\cdot 297}{20790}\n\\;=\\; \\frac{13980 \\;-\\; 385 \\;+\\; 5049}{20790}\n\\;=\\; \\frac{18644}{20790}\n\\;=\\; \\frac{9322}{10395}.\n$$\n同样地，\n$$\nV \\;=\\; V_{1} + V_{2} + V_{3} \\;=\\; \\frac{355262}{480249} \\;+\\; \\frac{2915}{2916} \\;+\\; \\frac{2301}{4900}.\n$$\n\n自由度为 1 的分层对数秩卡方统计量为\n$$\nX^{2} \\;=\\; \\frac{U^{2}}{V}\n\\;=\\; \\frac{\\left(\\frac{9322}{10395}\\right)^{2}}{\\;\\frac{355262}{480249} + \\frac{2915}{2916} + \\frac{2301}{4900}\\;}\n\\;=\\; \\frac{\\frac{86899684}{108056025}}{\\;\\frac{355262}{480249} + \\frac{2915}{2916} + \\frac{2301}{4900}\\;}.\n$$\n\n对于最终的数值（仅在最后进行四舍五入），计算分子和分母：\n- $U^{2} \\approx (0.896777)^2 \\approx 0.804209485$。\n- $V \\approx 0.7397454237 + 0.9996570645 + 0.4695918367 \\approx 2.2089943249$。\n\n因此，\n$$\nX^{2} \\;\\approx\\; \\frac{0.804209485}{2.2089943249} \\;\\approx\\; 0.364061363.\n$$\n\n四舍五入到 $4$ 位有效数字，分层对数秩卡方统计量为 $0.3641$。", "answer": "$$\\boxed{0.3641}$$", "id": "4576961"}, {"introduction": "生存研究并非总能从时间零点开始观察所有受试者，延迟进入（即左截断）是一个常见的数据特征，如果处理不当会导致结果产生偏差。本编程挑战要求您通过修改风险集的定义，来实现能够正确处理左截断数据的Kaplan-Meier估计和对数秩检验算法。这项练习不仅能将理论知识转化为实际代码，还能直观展示正确处理复杂数据结构（如延迟进入）的巨大影响，这是生物信息学分析师必须掌握的一项关键技能。[@problem_id:4576983]", "problem": "一项随机肿瘤学队列研究纳入了相对于观察开始时间在不同日历时间入组的患者，这造成了左截斷（也称为延迟进入）。设 $T_i$ 表示受试者 $i$ 的失败时间，$C_i$ 表示右删失时间，$L_i$ 表示受试者首次变得可观察并有资格进入风险集的左截断（进入）时间。观测时间为 $X_i = \\min(T_i, C_i)$，事件指示符为 $\\Delta_i = \\mathbf{1}\\{T_i \\le C_i\\}$。受试者属于由 $G_i \\in \\{0,1\\}$ 指示的两个治疗组之一。对于一个时间点 $t$，风险集必须反映左截断：一个受试者在时间 $t$ 处于风险中，当且仅当 $L_i \\le t \\le X_i$。生存函数定义为 $S(t) = \\mathbb{P}(T > t)$。\n\n通过在每个不同事件时间 $t_j$ 根据上述定义构建风险集，并以不超过 $t$ 的事件时间的乘积形式构建 $S(t)$ 的估计量，来实现带左截断的 Kaplan-Meier 估计。然后，通过在每个事件时间 $t_j$，计算组0中观测到的事件数以及在零假设下与组0中风险集大小成比例的期望事件数，并汇总所有事件时间的标准化差异，来实现两个组之间带左截断的对数秩检验（log-rank test）。同时实现一种“朴素”分析，该分析通过将所有 $L_i$ 设置为0并重新计算 Kaplan-Meier 和对数秩分析来忽略左截断。通过大样本近似，对数秩统计量的零分布是标准正态分布。\n\n您的程序必须为下面的每个测试用例计算：\n- 在提供的时间评估网格上，使用左截断计算的Kaplan-Meier生存估计与朴素分析计算的生存估计之间的最大绝对差。\n- 使用左截断计算的双边对数秩 $p$ 值。\n- 通过朴素分析计算的双边对数秩 $p$ 值。\n\n所有时间值都是没有物理单位的抽象时间单位。不涉及角度。如果出现百分比，必须表示为小数。\n\n使用以下测试套件。每个案例提供进入时间 $L$、观测时间 $X$、事件指示符 $\\Delta$、组标签 $G$ 和评估时间 $\\mathcal{T}_{\\mathrm{eval}}$ 的向量。这些向量按索引对齐。\n\n案例 $\\mathrm{A}$（一般延迟进入，混合事件与删失）：\n- $L = [\\,0.0,\\,1.0,\\,2.0,\\,0.5,\\,3.0,\\,0.0,\\,2.0,\\,1.5,\\,4.0,\\,0.0,\\,5.0,\\,3.0\\,]$\n- $X = [\\,5.0,\\,6.0,\\,7.5,\\,4.0,\\,9.0,\\,3.5,\\,8.0,\\,6.2,\\,9.5,\\,2.0,\\,7.0,\\,6.0\\,]$\n- $\\Delta = [\\,1,\\,0,\\,1,\\,1,\\,0,\\,1,\\,0,\\,1,\\,0,\\,1,\\,1,\\,0\\,]$\n- $G = [\\,0,\\,0,\\,0,\\,0,\\,0,\\,1,\\,1,\\,1,\\,1,\\,1,\\,1,\\,1\\,]$\n- $\\mathcal{T}_{\\mathrm{eval}} = [\\,2.0,\\,4.0,\\,6.0,\\,8.0\\,]$\n\n案例 $\\mathrm{B}$（無截断；所有条目均在时间零点）：\n- $L = [\\,0.0,\\,0.0,\\,0.0,\\,0.0,\\,0.0,\\,0.0,\\,0.0,\\,0.0,\\,0.0,\\,0.0\\,]$\n- $X = [\\,5.0,\\,7.0,\\,4.0,\\,10.0,\\,3.0,\\,6.0,\\,8.0,\\,5.0,\\,9.0,\\,2.0\\,]$\n- $\\Delta = [\\,1,\\,0,\\,1,\\,0,\\,1,\\,1,\\,0,\\,0,\\,1,\\,1\\,]$\n- $G = [\\,0,\\,0,\\,0,\\,0,\\,1,\\,1,\\,1,\\,1,\\,1,\\,1\\,]$\n- $\\mathcal{T}_{\\mathrm{eval}} = [\\,2.0,\\,5.0,\\,7.0,\\,9.0\\,]$\n\n案例 $\\mathrm{C}$（重度截断；许多晚期进入）：\n- $L = [\\,3.0,\\,4.0,\\,5.0,\\,6.0,\\,2.5,\\,4.5,\\,5.5,\\,7.0,\\,8.0,\\,3.5,\\,6.5,\\,1.0\\,]$\n- $X = [\\,3.5,\\,6.0,\\,9.0,\\,7.5,\\,3.0,\\,7.0,\\,8.0,\\,9.5,\\,10.0,\\,5.0,\\,7.2,\\,2.0\\,]$\n- $\\Delta = [\\,1,\\,1,\\,0,\\,1,\\,1,\\,0,\\,1,\\,0,\\,0,\\,1,\\,1,\\,1\\,]$\n- $G = [\\,0,\\,0,\\,0,\\,0,\\,1,\\,1,\\,1,\\,1,\\,0,\\,0,\\,1,\\,1\\,]$\n- $\\mathcal{T}_{\\mathrm{eval}} = [\\,2.0,\\,4.0,\\,6.0,\\,8.0\\,]$\n\n案例 $\\mathrm{D}$（跨组别的事件时间相同，且同时存在删失）：\n- $L = [\\,0.0,\\,1.0,\\,2.0,\\,2.5,\\,0.0,\\,1.5,\\,2.0,\\,3.0\\,]$\n- $X = [\\,3.0,\\,3.0,\\,5.0,\\,7.0,\\,3.0,\\,3.0,\\,7.0,\\,7.0\\,]$\n- $\\Delta = [\\,1,\\,1,\\,0,\\,1,\\,1,\\,0,\\,1,\\,1\\,]$\n- $G = [\\,0,\\,0,\\,0,\\,0,\\,1,\\,1,\\,1,\\,1\\,]$\n- $\\mathcal{T}_{\\mathrm{eval}} = [\\,3.0,\\,7.0\\,]$\n\n您的程序应生成一行输出，其中包含一个逗号分隔的列表，该列表包含在方括号中的结果，每个测试用例贡献一个包含上述顺序的三个浮点数的列表。例如，最终输出格式必须是\n$[\\,[d_{\\mathrm{A}},p_{\\mathrm{A}}^{\\mathrm{left}},p_{\\mathrm{A}}^{\\mathrm{naive}}],\\,[d_{\\mathrm{B}},p_{\\mathrm{B}}^{\\mathrm{left}},p_{\\mathrm{B}}^{\\mathrm{naive}}],\\,[d_{\\mathrm{C}},p_{\\mathrm{C}}^{\\mathrm{left}},p_{\\mathrm{C}}^{\\mathrm{naive}}],\\,[d_{\\mathrm{D}},p_{\\mathrm{D}}^{\\mathrm{left}},p_{\\mathrm{D}}^{\\mathrm{naive}}]\\,]$ 其中每个 $d_{\\cdot}$ 是该案例在提供的评估时间内Kaplan-Meier生存估计的最大绝对差，每个 $p_{\\cdot}^{\\mathrm{left}}$ 或 $p_{\\cdot}^{\\mathrm{naive}}$ 是相应的双边对数秩 $p$ 值。", "solution": "用户要求实现并比较两种生存分析方法：一种是正确处理左截断（延迟进入）数据的分析方法，另一种是忽略左截断的“朴素”分析方法。具体任务是计算两种情况下的Kaplan-Meier（KM）生存曲线并执行对数秩检验。对于每个提供的测试用例，必须计算三个值：两种KM估计在一个评估时间网格上的最大绝对差，以及来自正确和朴素对数秩检验的双边p值。\n\n### 基于原则的设计\n\n解决方案将围绕两种核心统计方法构建，并使其适应左截斷数据。\n\n#### 1. 带左截断的Kaplan-Meier估计量\n\n生存函数 $S(t) = \\mathbb{P}(T > t)$ 使用Kaplan-Meier乘积限公式进行估计。对于有左截断的数据，公式保持不变，但风险集的定义被修改了。\n\n设 $\\tau_1  \\tau_2  \\dots  \\tau_K$ 为数据中观测到的不同事件时间。Kaplan-Meier估计量由下式给出：\n$$ \\hat{S}(t) = \\prod_{j: \\tau_j \\le t} \\left(1 - \\frac{d_j}{n_j}\\right) $$\n- $\\tau_j$：第$j$个不同事件时间。\n- $d_j$：在时间$\\tau_j$发生事件的受试者数量。数学上，$d_j = |\\{i: X_i = \\tau_j, \\Delta_i = 1\\}|$。\n- $n_j$：在时间$\\tau_j$处于风险集中的受试者数量。对于左截断数据，受试者$i$在时间$t$处于风险中，如果他们已进入研究（$L_i \\le t$）且尚未发生事件或被删失（$X_i \\ge t$）。因此，风险集的大小为 $n_j = |\\{i: L_i \\le \\tau_j \\le X_i\\}|$。\n\n对于“朴素”分析，通过将所有进入时间$L_i$设为0来忽略左截断。风险集的定义随后简化为右删失数据的标准形式：$n_j^{\\text{naive}} = |\\{i: X_i \\ge \\tau_j\\}|$。\n\n实现将首先识别所有唯一的事件时间。然后，对于每个评估时间 $t \\in \\mathcal{T}_{\\mathrm{eval}}$，它将计算所有事件时间 $\\tau_j \\le t$ 的生存因子 $(1 - d_j/n_j)$ 的乘积。\n\n#### 2. 带左截断的对数秩检验\n\n对数秩检验是一种非参数假设检验，用于比较两个或多个组的生存分布。对于两个组（$G=0$和$G=1$），零假设为$H_0: S_0(t) = S_1(t)$。\n\n该检验统计量是通过在一个组（例如，组0）中，对所有不同事件时间$\\tau_j$上观测到的事件数与期望事件数之间的差异求和来构建的。\n\n在每个事件时间 $\\tau_j$：\n- 设$d_j$为事件总数，$n_j$为处于风险中的受试者总数，两者均按上述定义计算（考虑左截断）。\n- 设$d_{0j}$和$n_{0j}$分别为组0中的事件数和风险人数。\n- 在$H_0$下，事件数预期按风险集的大小成比例分布。在$\\tau_j$时，组0中的期望事件数为 $E_{0j} = d_j \\frac{n_{0j}}{n_j}$。\n\n对数秩统计量$Z$的构建如下：\n$$ Z = \\frac{U}{\\sqrt{V}} = \\frac{\\sum_j (d_{0j} - E_{0j})}{\\sqrt{\\sum_j V_j}} $$\n- $U = \\sum_j (d_{0j} - E_{0j})$是观测事件数减去期望事件数的总和。\n- $V = \\sum_j V_j$是各项方差的总和。$d_{0j}$的方差$V_j$遵循超几何分布，由下式给出：\n$$ V_j = \\frac{n_{0j} n_{1j} d_j (n_j - d_j)}{n_j^2 (n_j - 1)} $$\n其中$n_{1j} = n_j - n_{0j}$是组1中处于风险中的人数。此公式在$n_j > 1$时有效。如果$n_j \\le 1$，则方差贡献为0。\n\n在零假设下，对于大样本，$Z$服从标准正态分布$\\mathcal{N}(0,1)$。双边p值通过$2 \\times \\mathbb{P}(\\mathcal{N}(0,1) > |Z|)$获得。\n\n朴素对数秩检验在计算所有量（$n_j, n_{0j}$等）之前，通过将所有$L_i = 0$来执行。\n\n### 实现策略\n\n将创建两个辅助函数：`kaplan_meier_estimator`和`log_rank_test`。两者都将接受数据数组$L, X, \\Delta$（以及用于对数秩检验的$G$）作为输入。\n1. `kaplan_meier_estimator(t_eval, L, X, Delta)`：为`t_eval`中的每个时间点计算合并队列的KM生存概率。\n2. `log_rank_test(L, X, Delta, G)`：计算用于比较组0和组1的对数秩p值。\n\n主`solve`函数将遍历提供的测试用例。对于每个案例，它将：\n- 使用给定的$L$数组调用辅助函数一次，以获得左截断的结果（$S_{\\text{left}}$，$p_{\\text{left}}$）。\n- 使用一个全为零的修改后的$L$数组第二次调用辅助函数，以获得朴素分析的结果（$S_{\\text{naive}}$，$p_{\\text{naive}}$）。\n- 计算生存估计的最大绝对差 $d = \\max |S_{\\text{left}}(t) - S_{\\text{naive}}(t)|$ （在评估时间上）。\n- 整理三个结果（$d$, $p_{\\text{left}}$, $p_{\\text{naive}}$）以用于最终输出。最终的结果列表将被格式化为所需的字符串表示形式。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm\n\ndef kaplan_meier_estimator(t_eval, L, X, Delta):\n    \"\"\"\n    Computes Kaplan-Meier survival estimates with support for left truncation.\n    \"\"\"\n    L, X, Delta = np.asarray(L), np.asarray(X), np.asarray(Delta)\n    t_eval = np.asarray(t_eval)\n\n    # Get unique event times in ascending order\n    unique_event_times = np.unique(X[Delta == 1])\n\n    # Build the survival curve as a step function starting at S(0)=1\n    survival_curve_times = [0.0]\n    survival_curve_probs = [1.0]\n    \n    current_prob = 1.0\n    for t_j in unique_event_times:\n        # Number of events at time t_j\n        d_j = np.sum((X == t_j)  (Delta == 1))\n        \n        # Number of subjects at risk at time t_j (L_i = t_j = X_i)\n        n_j = np.sum((L = t_j)  (X >= t_j))\n        \n        if n_j > 0:\n            current_prob *= (1.0 - d_j / n_j)\n        \n        survival_curve_times.append(t_j)\n        survival_curve_probs.append(current_prob)\n\n    times = np.array(survival_curve_times)\n    probs = np.array(survival_curve_probs)\n\n    # Evaluate survival at requested times using the step function\n    results = []\n    for t in t_eval:\n        # Find the index of the last event time = t\n        idx = np.searchsorted(times, t, side='right') - 1\n        results.append(probs[idx])\n            \n    return np.array(results)\n\ndef log_rank_test(L, X, Delta, G):\n    \"\"\"\n    Performs the log-rank test for two groups with support for left truncation.\n    \"\"\"\n    L, X, Delta, G = np.asarray(L), np.asarray(X), np.asarray(Delta), np.asarray(G)\n    \n    # Get unique event times across all data\n    unique_event_times = np.unique(X[Delta == 1])\n\n    U = 0.0  # Numerator of Z-statistic: Sum of (Observed - Expected)\n    V = 0.0  # Denominator of Z-statistic: Sum of variances\n\n    for t_j in unique_event_times:\n        # Define mask for subjects at risk at time t_j\n        at_risk_mask = (L = t_j)  (X >= t_j)\n        n_j = np.sum(at_risk_mask)\n        d_j = np.sum((X == t_j)  (Delta == 1))\n\n        # Variance is only defined for n_j > 1\n        if n_j > 1:\n            # Group 0 specifics\n            at_risk_g0_mask = at_risk_mask  (G == 0)\n            n_0j = np.sum(at_risk_g0_mask)\n            d_0j = np.sum((X == t_j)  (Delta == 1)  (G == 0))\n            \n            # Group 1 specifics (by subtraction)\n            n_1j = n_j - n_0j\n\n            # Expected events in group 0 under H0\n            E_0j = d_j * (n_0j / n_j)\n            \n            # Update U and V\n            U += (d_0j - E_0j)\n            \n            # Variance based on hypergeometric distribution\n            # This is valid for tied event times\n            if n_j > 1: # Redundant check, but safe\n                V_j = (n_0j * n_1j * d_j * (n_j - d_j)) / (n_j**2 * (n_j - 1))\n                V += V_j\n\n    # Compute Z-statistic and two-sided p-value\n    if V > 1e-9: # Use a small tolerance for floating point precision\n        Z = U / np.sqrt(V)\n        p_value = 2 * norm.sf(np.abs(Z))\n    else:\n        # If variance is zero, no statistical evidence to reject H0\n        p_value = 1.0\n        \n    return p_value\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case A\n        {'L': [0.0, 1.0, 2.0, 0.5, 3.0, 0.0, 2.0, 1.5, 4.0, 0.0, 5.0, 3.0],\n         'X': [5.0, 6.0, 7.5, 4.0, 9.0, 3.5, 8.0, 6.2, 9.5, 2.0, 7.0, 6.0],\n         'Delta': [1, 0, 1, 1, 0, 1, 0, 1, 0, 1, 1, 0],\n         'G': [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1],\n         'T_eval': [2.0, 4.0, 6.0, 8.0]},\n        # Case B\n        {'L': [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],\n         'X': [5.0, 7.0, 4.0, 10.0, 3.0, 6.0, 8.0, 5.0, 9.0, 2.0],\n         'Delta': [1, 0, 1, 0, 1, 1, 0, 0, 1, 1],\n         'G': [0, 0, 0, 0, 1, 1, 1, 1, 1, 1],\n         'T_eval': [2.0, 5.0, 7.0, 9.0]},\n        # Case C\n        {'L': [3.0, 4.0, 5.0, 6.0, 2.5, 4.5, 5.5, 7.0, 8.0, 3.5, 6.5, 1.0],\n         'X': [3.5, 6.0, 9.0, 7.5, 3.0, 7.0, 8.0, 9.5, 10.0, 5.0, 7.2, 2.0],\n         'Delta': [1, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1],\n         'G': [0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1],\n         'T_eval': [2.0, 4.0, 6.0, 8.0]},\n        # Case D\n        {'L': [0.0, 1.0, 2.0, 2.5, 0.0, 1.5, 2.0, 3.0],\n         'X': [3.0, 3.0, 5.0, 7.0, 3.0, 3.0, 7.0, 7.0],\n         'Delta': [1, 1, 0, 1, 1, 0, 1, 1],\n         'G': [0, 0, 0, 0, 1, 1, 1, 1],\n         'T_eval': [3.0, 7.0]},\n    ]\n    \n    all_results = []\n    \n    for case_data in test_cases:\n        L = np.array(case_data['L'])\n        X = np.array(case_data['X'])\n        Delta = np.array(case_data['Delta'])\n        G = np.array(case_data['G'])\n        T_eval = np.array(case_data['T_eval'])\n        \n        # Left-truncated (\"correct\") analysis\n        S_left = kaplan_meier_estimator(T_eval, L, X, Delta)\n        p_left = log_rank_test(L, X, Delta, G)\n        \n        # Naive analysis (ignore left truncation)\n        L_naive = np.zeros_like(L, dtype=float)\n        S_naive = kaplan_meier_estimator(T_eval, L_naive, X, Delta)\n        p_naive = log_rank_test(L_naive, X, Delta, G)\n        \n        # Compute maximum absolute difference in survival estimates\n        d = np.max(np.abs(S_left - S_naive))\n        \n        all_results.append([d, p_left, p_naive])\n        \n    # Final print statement in the exact required format.\n    formatted_results = [f\"[{res[0]},{res[1]},{res[2]}]\" for res in all_results]\n    print(f\"[[{all_results[0][0]},{all_results[0][1]},{all_results[0][2]}],[{all_results[1][0]},{all_results[1][1]},{all_results[1][2]}],[{all_results[2][0]},{all_results[2][1]},{all_results[2][2]}],[{all_results[3][0]},{all_results[3][1]},{all_results[3][2]}]]\")\n\n```", "id": "4576983"}]}