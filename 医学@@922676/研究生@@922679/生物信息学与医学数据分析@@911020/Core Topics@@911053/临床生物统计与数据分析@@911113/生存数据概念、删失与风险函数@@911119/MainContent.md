## 引言
生存分析是生物医学数据分析领域中不可或缺的统计方法，它专门用于研究从一个明确的时间起点到某个特定事件发生所经过的时间。无论是评估新药疗效、识别疾病预后因素，还是探索基因标志物与患者生存期的关联，我们处理的都不仅仅是事件是否发生，更关键的是“何时”发生。然而，在实际研究中，我们常常无法观测到所有研究对象的完整事件时间，这种数据的不完整性，即“删失”（censoring），构成了[生存数据分析](@entry_id:190868)的核心挑战与特色。若不能妥善处理[删失数据](@entry_id:173222)，将会导致严重的统计偏倚和错误的科学结论。

本文旨在系统性地梳理生存分析中的核心概念，为读者构建一个坚实的理论与应用基础。我们将深入探讨删失数据的本质、[风险函数](@entry_id:166593)的数学原理，以及将这些理论应用于解决实际问题的各种模型。通过本文的学习，你将能够：
*   在**第一章：原理与机制**中，精确理解[生存数据](@entry_id:165675)的构成，区分不同类型的删失与截断，并掌握描述事件动态风险的核心工具——[风险函数](@entry_id:166593)及其相关数学性质。
*   在**第二章：应用与跨学科联系**中，看到这些理论如何在临床试验、观察性研究、生物信息学、机器学习乃至算法伦理等多个领域中发挥关键作用，解决从疗效比较到复杂[生物过程](@entry_id:164026)建模等一系列问题。
*   在**第三章：动手实践**中，通过具体的练习题，将理论知识转化为实际操作能力，亲手计算生存估计量并理解高级模型的构建逻辑。

本章将从生存分析的基本原理与机制讲起，为后续的应用和实践奠定坚实的基础。

## 原理与机制

在上一章引言的基础上，本章将深入探讨生存分析的核心概念，重点阐述删失（censoring）与[风险函数](@entry_id:166593)（hazard function）的原理、数学表述及其在生物医学研究中的应用。我们将从定义时间-事件数据的基本要素开始，系统地剖析数据不完整性的各种类型，并引出描述事件瞬时发生率的强大工具——[风险函数](@entry_id:166593)。最后，我们将讨论确保从[删失数据](@entry_id:173222)中进行有效推断所必须满足的关键假设。

### 生存数据的基本构成

生存分析的核心是研究从某个明确定义的**时间起点**（time origin）到一个特定**事件**（event）发生所经过的时间。这个持续时间是一个非负随机变量，通常表示为 $T$。在生物医学研究中，正确地定义这些要素是任何有效分析的第一步。

例如，在一项评估靶向治疗效果的精准肿瘤学研究中，一个合理的框架如下 [@problem_id:4612136]：

*   **时间起点**：最能反映治疗干预影响的起点是患者首次接受[靶向治疗](@entry_id:261071)的日期。其他时间点，如签署知情同意书或进行基线生物标志物检测的日期，可能会因患者间不同的等待时间而引入与治疗无关的变异性。

*   **事件**：事件必须是临床上明确且有意义的终点。在肿瘤学中，常用的终点包括**总生存期**（Overall Survival, OS），即因任何原因导致的死亡；以及**无进展生存期**（Progression-Free Survival, PFS），这是一个复合终点，定义为从时间起点到首次出现客观的影像学疾病进展或任何原因导致的死亡中，以先发生者为准。

*   **时间-事件变量 $T$**：对于PFS分析，每个患者的 $T$ 就是从首次用药到其疾病进展或死亡的时间。

然而，在研究结束时，并非所有患者都经历了我们所关注的事件。一些患者可能仍然存活且无疾病进展，一些患者可能因各种原因失访。这种对事件时间的不完全观测，即为**删失**（censoring）。为了处理这种情况，我们需要为每个个体记录一个数据对 $(\tilde{T}_i, \Delta_i)$，其中 $\tilde{T}_i$ 是观测到的时间，$\Delta_i$ 是事件指示符。$\tilde{T}_i$ 是真实事件时间 $T_i$ 和删失时间 $C_i$ 的较小值，即 $\tilde{T}_i = \min(T_i, C_i)$。事件指示符 $\Delta_i$ 则记录了观测终止的原因：如果事件被观测到（即 $T_i \le C_i$），则 $\Delta_i = 1$；如果观测因删失而终止（即 $T_i > C_i$），则 $\Delta_i = 0$。

例如，在上述肿瘤学研究中，如果数据库在预设的日历日期锁定（这被称为**行政删失**，administrative censoring），一个在该日期前仍无事件发生的患者将被视为删失。其观测时间 $\tilde{T}_i$ 是从首次用药到最后一次有效评估其无事件状态的日期，其事件指示符 $\Delta_i$ 为 $0$。值得注意的是，其观测时间是到最后一次评估的日期，而不是数据库锁定的日期，因为在最后一次评估和数据锁定之间，我们对患者的状态一无所知，错误地使用后者会人为地延长生存时间，引入偏倚。

### 删失与截断的类型学

数据的不完整性有多种形式，准确区分它们对于选择正确的分析方法至关重要。我们可以将这些情况归纳为删失和截断两大类 [@problem_id:4612152] [@problem_id:4612166]。通常，我们可以用一个区间 $(L_i, R_i]$ 来表示对真实事件时间 $T_i$ 的[观测信息](@entry_id:165764)。

*   **[右删失](@entry_id:164686) (Right Censoring)**：这是最常见的一种删失类型。我们只知道事件在最后一次观测时间 $L_i$ 之后尚未发生，即 $T_i > L_i$。用[区间表示](@entry_id:264745)为 $(L_i, \infty)$。例如，在总生存期研究中，一个在最后一次随访时仍然存活的患者就是[右删失](@entry_id:164686)的。行政删失也是[右删失](@entry_id:164686)的一种特殊情况。

*   **[左删失](@entry_id:169731) (Left Censoring)**：当事件在首次观测时间 $R_i$ 之前已经发生，但具体发生时间未知时，我们称之为[左删失](@entry_id:169731)。我们只知道 $T_i \le R_i$，用[区间表示](@entry_id:264745)为 $(0, R_i]$。一个典型的例子是，在研究HIV感染到血清转换的时间时，如果一名参与者在首次检测时（时间 $R_i$）就已呈血清阳性，那么其血清转换事件就发生了[左删失](@entry_id:169731)。

*   **[区间删失](@entry_id:636589) (Interval Censoring)**：当事件被确定发生在两次观测之间，即 $L_i  T_i \le R_i$ 时，我们称之为[区间删失](@entry_id:636589)。这在定期随访的研究中很常见。例如，如果一名患者在时间点 $L_i$ 的检测中呈阴性，但在随后的时间点 $R_i$ 的检测中呈阳性，那么其血清转换事件就发生在区间 $(L_i, R_i]$ 内。在电子健康记录（EHR）数据中，由于事件通常只在离散的门诊访问时才被发现，[区间删失](@entry_id:636589)是普遍存在的 [@problem_id:4612168]。将这种[区间删失](@entry_id:636589)数据简单地当作在 $R_i$ 发生的确切事件（即把事件时间归因于右端点），会系统性地高估生存时间，从而可能导致对风险的低估。

与删失不同，**左截断 (Left Truncation)**，也称为**延迟进入 (delayed entry)**，是一种样本选择问题，而非观测不完整问题。它指的是个体只有在某个起始时间点之后（即在时间 $A_i > 0$ 时）仍然无事件发生，才会被纳入研究队列。因此，进入研究的条件是 $T_i > A_i$。

一个典型的例子是基于国家癌症登记中心数据的研究 [@problem_id:4612166]。假设研究的时间起点是[癌症诊断](@entry_id:197439)日期。对于那些在登记中心建立（比如日历时间0）之前就被诊断的“现患病例”（prevalent cases），他们只有在进入登记中心时（比如诊断后 $A_i$ 时间）仍然存活，才会被观察到。那些在进入登记中心之前就已死亡的患者则永远不会出现在数据集中。因此，这些现患病例的数据是左截断的。他们的观测数据通常表示为三元组 $(A_i, Y_i, \Delta_i)$，其中 $A_i$ 是延迟进入时间（从诊断到登记的时间），$Y_i$ 是从诊断到事件或[右删失](@entry_id:164686)的观测时间，且必然有 $Y_i \ge A_i$。在分析中，必须对这种延迟进入进行适当调整，例如在构建风险集时，确保个体 $i$ 只在其进入研究后（即对于时间 $t \ge A_i$）才被计入风险集。

### 风险函数：事件的瞬时速率

为了描述事件风险如何随时间演变，生存分析引入了一个核心概念：**[风险函数](@entry_id:166593) (hazard function)**，记为 $h(t)$ 或 $\lambda(t)$。

#### 定义与诠释

风险函数 $h(t)$ 定义为在时间 $t$ 存活的个体，在下一个极小时间间隔内发生事件的瞬时速率。它是一个[条件概率密度](@entry_id:265457)，其正式定义如下 [@problem_id:4612141]：

$$
h(t) = \lim_{\Delta t \to 0^{+}} \frac{\mathbb{P}(t \le T  t+\Delta t \mid T \ge t)}{\Delta t}
$$

从这个定义可以看出：
1.  **条件性**：风险是在“生存至今”（$T \ge t$）的条件下定义的，它衡量的是那些仍然处于“风险中”的个体的瞬时失败率。
2.  **瞬时性**：它是一个速率（rate），而不是一个概率（probability）。因此，它的取值可以大于1，其单位是 1/时间（例如，事件数/人-年）。将[风险函数](@entry_id:166593)误解为概率是一个常见的错误。

#### 与生存函数和密度函数的关系

[风险函数](@entry_id:166593)与生存函数 $S(t) = \mathbb{P}(T > t)$ 和[概率密度函数](@entry_id:140610) $f(t)$ 之间存在着紧密的数学联系。如果 $T$ 是一个[连续随机变量](@entry_id:166541)，其生存函数 $S(t)$ 可微，则可以推导出：

$$
h(t) = \frac{f(t)}{S(t)}
$$

其中 $f(t) = -S'(t)$。这个关系式直观地说明了风险是在存活概率 $S(t)$ 的基础上，事件发生的“密度”$f(t)$。

另一个重要的关系是：

$$
h(t) = -\frac{d}{dt} \ln S(t)
$$

这个公式表明，风险函数描述了对数生存概率的下降速率。这三个函数——$S(t)$, $f(t)$, 和 $h(t)$——在数学上是等价的，知道其中任何一个，就可以推导出另外两个。

### 累积风险与生存函数

从[风险函数](@entry_id:166593)出发，我们可以定义**[累积风险函数](@entry_id:169734) (cumulative hazard function)**, $H(t)$，它表示到时间 $t$ 为止累积的总风险：

$$
H(t) = \int_0^t h(u) du
$$

由于[风险函数](@entry_id:166593) $h(u)$ 必然是非负的（$h(u) \ge 0$），[累积风险函数](@entry_id:169734) $H(t)$ 是一个关于时间 $t$ 的**[非递减函数](@entry_id:202520)**。这意味着总累积风险永远不会减少，即使瞬时风险 $h(t)$ 在某些时段可能下降 [@problem_id:4612114]。

[累积风险函数](@entry_id:169734)与生存函数之间的基本关系是：

$$
S(t) = \exp(-H(t)) = \exp\left(-\int_0^t h(u) du\right)
$$

这个关系是生存分析的基石。它允许我们通过对[风险函数](@entry_id:166593)建模来推断生存概率。

为了具体理解这些概念，考虑一个具有分段常数风险的实际场景 [@problem_id:4612114]。假设某种免疫治疗的副作用风险在不同阶段是不同的：
*   第 0-3 个月，风险率 $h(t) = \lambda_1 = 0.08$ /月
*   第 3-6 个月，风险率 $h(t) = \lambda_2 = 0.02$ /月
*   第 6-9 个月，风险率 $h(t) = \lambda_3 = 0.05$ /月

在第9个月时的累积风险为各阶段风险的加和：
$H(9) = \int_0^9 h(u)du = \lambda_1 \times 3 + \lambda_2 \times 3 + \lambda_3 \times 3 = 0.08 \times 3 + 0.02 \times 3 + 0.05 \times 3 = 0.45$。

那么，一个患者存活超过9个月的概率为：
$S(9) = \exp(-H(9)) = \exp(-0.45)$。

对于一个在9个月时被[右删失](@entry_id:164686)的患者，其对似然函数的贡献就是 $S(9)$，即他存活超过9个月的概率。

### [风险函数](@entry_id:166593)形状的生物学诠释

[风险函数](@entry_id:166593)的形状本身可以揭示潜在的生物学或行为机制 [@problem_id:4612138]。

*   **常数风险** ($h(t) = \lambda$)：对应于指数分布。这意味着事件风险不随时间改变，系统具有“[无记忆性](@entry_id:201790)”。
*   **递增风险**：表示“耗损”或“[老化](@entry_id:198459)”过程，风险随时间累积。在数学上，递增风险率（IFR）等价于生存函数 $S(t)$ 是对数[凹函数](@entry_id:274100) [@problem_id:4612138]。
*   **递减风险**：常见于新生儿死亡率或设备早期故障，体质较弱的个体在早期被淘汰，导致剩余群体的平均风险下降。
*   **驼峰形风险**（先增后减）：即使在同质群体中也可能出现。例如，由对数正态分布描述的生存时间就具有驼峰形风险，这可能反映了从成熟到衰退的生命周期过程。
*   **浴盆形风险**（先减后增）：这是最有趣和最复杂的形状之一。它通常反映了**未观测到的异质性 (unobserved heterogeneity)**，也称为**脆弱性 (frailty)**。

想象一个由不同脆弱程度个体组成的群体。即使每个个体的基线风险（$h_0(t)$）是随时间递增的，群体层面的表观风险也可能呈现浴盆形。在早期，高脆弱性的个体迅速经历事件并从风险集中移除（**选择效应**），导致群体的平均风险下降。随着时间推移，这种选择效应减弱，而个体层面的老化效应（$h_0(t)$ 的递增）开始主导，导致群体风险重新上升。

在数学上，使用伽马脆弱性模型 $h(t|Z) = Z h_0(t)$（其中 $Z$ 是表示脆弱性的随机变量）可以很好地描述这一现象。群体（边际）[风险函数](@entry_id:166593)为 $h(t) = \frac{h_0(t)}{1 + \theta H_0(t)}$，其中 $\theta$ 是脆弱性分布的方差。该公式清晰地显示了脆弱性选择（分母项）如何调节基线风险 $h_0(t)$。$h(t)$ 的形状取决于 $h_0(t)$ 的增长与选择效应之间的竞争 [@problem_id:4612138]。

### 从[删失数据](@entry_id:173222)中进行有效推断的假设

到目前为止，我们讨论的都是关于真实事件时间 $T$ 的函数。但我们观测到的是被删失的数据 $(\tilde{T}, \Delta)$。那么，我们如何从这些不完整的观测中，无偏地推断出关于 $T$ 的生存和风险函数呢？这需要满足一系列关键假设。

#### 可识别性 (Identifiability)

首先，我们需要明确哪些量是可以在非参数的设定下被唯一确定的。在满足下述假设的前提下，从观测数据 $(\tilde{T}, \Delta)$ 的联合分布中，可以**非参数地识别**出事件的真实[风险函数](@entry_id:166593) $h_T(t)$、[累积风险函数](@entry_id:169734) $H_T(t)$ 和生存函数 $S_T(t)$。这构成了诸如[Kaplan-Meier](@entry_id:169317)估计和Nelson-Aalen估计等方法的理论基础。然而，事件的[概率密度函数](@entry_id:140610) $f_T(t)$ 通常是**不可识别的**，因为对其进行估计需要额外的平滑假设（例如选择[核函数](@entry_id:145324)和带宽）[@problem_id:4612177]。

#### 核心假设：独立删失、阳性假设与一致性

为了实现上述可识别性，必须满足三个核心假设，这些假设类似于因果推断中的框架 [@problem_id:4612119] [@problem_id:4612175]。

1.  **独立删失 (Independent Censoring)**：这是最关键的假设。它要求事件时间 $T$ 和删失时间 $C$ 在给定协变量 $X$ 的条件下是独立的，记为 $T \perp C \mid X$。这意味着，对于具有相同协变量的个体，其删失时间不应携带关于其事件风险的额外信息。例如，一个患者因搬家而失访（可能与病情无关），这通常被认为是独立删失。但如果患者因病情恶化而停止随访，则违反了此假设。独立删失保证了在任何时间点 $t$，在观测到的风险集中，事件的瞬时风险与我们感兴趣的目标人群的真实风险是一致的。行政删失通常被认为是满足独立删失假设的典型例子。

2.  **阳性假设 (Positivity)**：该假设要求在所有我们感兴趣的时间点 $t$ 和协变量组合 $X=x$ 上，个体保持未被删失的概率必须大于零，即 $\mathbb{P}(C \ge t \mid X=x) > 0$。直观地说，如果在某个时间点 $t^*$ 之后，所有特定类型的患者都被删失了，那么我们就无法观察到该时间点之后的任何事件，从而无法推断 $t^*$ 之后的风险。

3.  **一致性 (Consistency)**：这是一个基础性假设，确保我们的观测数据与潜在的真实事件过程相符。它包括：(a) 结构一致性，即观测变量确实由 $\tilde{T} = \min(T, C)$ 和 $\Delta = \mathbf{1}\{T \le C\}$ 生成；(b) [潜在结果](@entry_id:753644)一致性，即我们所定义的潜在事件时间 $T$ 是一个明确的、不受删失机制影响的量。

当这三个假设成立时，我们才能相信从删失数据中得到的生存曲线和[风险估计](@entry_id:754371)是有效的。

### 实践挑战与高级理论框架

最后，我们将理论与实践联系起来，讨论两个重要主题：数据中的“结”和现代生存分析的数学语言。

#### 事件时间中的结 (Ties)

尽管理论模型常假设时间是连续的，但在实际数据（如EHR）中，事件时间经常被记录为离散值（如精确到天），导致多个事件在记录上发生在同一时间，形成**结 (ties)** [@problem_id:4612168]。理论上，对于连续变量 $T$，$\mathbb{P}(T_i=T_j)=0$ ($i \neq j$)。因此，“结”是数据收集或记录过程离散化的产物。

在Cox比例风险模型等分析中，标准的部分[似然函数](@entry_id:141927)是基于无“结”的假设推导的。当存在“结”时，必须采用特殊的处理方法，例如：
*   **Breslow 近似**：计算最简单，但在“结”较多时会产生偏倚。
*   **Efron 近似**：比Breslow更精确，是许多统计软件的默认选项。
*   **精确法 (Exact Method)**：当“结”非常多或时间本质上是离散的时，这是最准确的方法。它在计算上更复杂，等价于在每个事件时间点上对风险集进行条件逻辑回归。

#### [计数过程](@entry_id:260664)框架

现代生存分析的理论，尤其是其[渐近性质](@entry_id:177569)的证明，建立在**[计数过程](@entry_id:260664) (counting process)**和鞅理论的强大框架之上 [@problem_id:4612125]。

*   **[计数过程](@entry_id:260664) $N_i(t)$**：这是一个[随机过程](@entry_id:268487)，记录个体 $i$ 在时间区间 $[0, t]$ 内观测到的事件数量。对于单次事件，它是一个在事件发生时从0跳到1的[阶梯函数](@entry_id:159192)：$N_i(t) = \mathbf{1}(\tilde{T}_i \le t, \Delta_i = 1)$。

*   **在风险过程 $Y_i(t)$**：这是一个示性过程，表示个体 $i$ 在时间 $t$ 是否处于风险中（即尚未经历事件也未被删失）：$Y_i(t) = \mathbf{1}(\tilde{T}_i \ge t)$。

根据[Doob-Meyer分解](@entry_id:187728)定理，[计数过程](@entry_id:260664)可以被唯一地分解为一个可预测的累积强度部分（补偿器）和一个均值为零的随机波动部分（[鞅](@entry_id:267779)）：

$$
N_i(t) = \int_0^t Y_i(s) \lambda_i(s) ds + M_i(t)
$$

这里，$\lambda_i(s)$ 是个体 $i$ 在时间 $s$ 的风险函数。积分项 $\int_0^t Y_i(s) \lambda_i(s) ds$ 是 $N_i(t)$ 的**补偿器 (compensator)**，代表了到时间 $t$ 为止预期的累积事件数。$M_i(t)$ 是一个**鞅 (martingale)**，代表了事件过程的随机“噪音”或不可预测部分。这个分解公式是推导生存分析中各种估计量和检验统计量性质的数学基础，为该领域提供了严谨的理论支撑。

本章系统地介绍了生存分析的基本原理与机制。理解这些概念——从数据的基本构成到[风险函数](@entry_id:166593)的深刻内涵，再到确保推断有效性的严格假设——对于在生物医学数据分析中正确应用和解释生存模型至关重要。