## 引言
在生物信息学和医学数据分析领域，理解事件发生时间（如患者生存期或疾病复发）及其影响因素是至关重要的。生存分析为此提供了核心方法论，而Cox比例风险回归模型无疑是其中应用最广泛、功能最强大的工具之一。它解决了超越简单生存曲线比较的根本问题：如何量化不同协变量（如治疗方案、基因表达或临床指标）对个体生存风险的独立影响，尤其是在数据存在删失的复杂情况下。然而，要正确地应用并解读这一模型，需要对其理论基础、核心假设和各种扩展有深刻的理解。

本篇文章旨在提供一份关于Cox比例风险模型的全面指南。我们将带领读者从基础理论走向前沿应用。在“原理与机制”一章中，我们将深入剖析模型的核心，从[风险函数](@entry_id:166593)和部分似然的精妙之处，到[比例风险假设](@entry_id:163597)的实践考量。接着，在“应用与跨学科联系”一章，我们将展示该模型的巨大灵活性，探讨如何利用它处理时依协变量、[竞争风险](@entry_id:173277)、聚[类数](@entry_id:156164)据和高维基因组数据等现实挑战，并领略其在进化生物学等领域的跨界应用。最后，通过“动手实践”部分，读者将有机会通过解决具体问题来巩固所学知识，将理论真正转化为实践技能。让我们一同开启这段探索之旅，掌握从复杂数据中挖掘生存洞见的强大能力。

## 原理与机制

本章在前一章介绍生存分析背景的基础上，深入探讨 Cox [比例风险](@entry_id:166780)回归模型的理论基础和核心机制。我们将从生存分析的基本概念入手，逐步构建起 Cox 模型的理论框架，阐明其半参数性质的由来，并讨论在实际应用中处理复杂[数据结构](@entry_id:262134)和模型假设检验的关键技术。

### 生存分析的语言：[风险函数](@entry_id:166593)与[生存数据](@entry_id:165675)

要理解 Cox 模型，首先必须掌握生存分析的独特语言，其核心是**风险函数（Hazard Function）**。与更直观的生存函数或概率密度函数不同，[风险函数](@entry_id:166593)描述了事件在某一瞬间发生的“瞬时速率”。

假设一个随机变量 $T$ 代表从某个起点到事件发生的时间。其**生存函数（Survival Function）** $S(t)$ 定义为个体生存时间超过 $t$ 的概率，即 $S(t) = \Pr(T \ge t)$。相应的，事件发生在时间 $t$ 的**[概率密度函数](@entry_id:140610)（Probability Density Function）** 为 $f(t)$。

在此基础上，瞬时[风险函数](@entry_id:166593) $h(t)$ 定义为：
$$
h(t) = \lim_{\Delta t \to 0^+} \frac{\Pr(t \le T  t + \Delta t \mid T \ge t)}{\Delta t}
$$
这个定义揭示了[风险函数](@entry_id:166593)的几个关键特性 [@problem_id:4550982]：
1.  **[条件概率](@entry_id:151013)**：$h(t)$ 是基于个体已经生存到时间 $t$ 这一条件下的瞬时事件发生率。
2.  **速率而非概率**：由于定义中包含了除以时间间隔 $\Delta t$，因此 $h(t)$ 是一个速率，其单位是时间的倒数（例如，事件数/人-年）。正因如此，[风险函数](@entry_id:166593)的值可以大于 1，它本身不是概率。
3.  **近似解释**：对于一个很小的时间窗口 $\Delta t$，在时间 $t$ 仍然存活的个体在接下来 $[t, t + \Delta t)$ 区间内发生事件的概率约等于 $h(t)\Delta t$ [@problem_id:4550982] [@problem_id:4550977]。

在生物信息学和医学数据分析的实际研究中，我们处理的数据通常包含三个核心部分：观测时间 $T_i$、事件指示符 $\delta_i$ 和协变量向量 $X_i$ [@problem_id:4550963]。由于患者可能因失访、研究结束等原因未能观测到事件，便产生了**[右删失](@entry_id:164686)（Right Censoring）**。此时，观测时间 $T_i$ 是真实事件时间与删失时间的较小值，而事件指示符 $\delta_i$ 则记录了观测到的时间是一个真实事件（$\delta_i=1$）还是一个删失（$\delta_i=0$）。

几乎所有生存分析方法，包括 Cox 模型，都依赖于一个至关重要的假设：**非信息性删失（Non-informative Censoring）**。这个假设的正式表述为，在给定协变量 $X$ 的条件下，个体的真实事件时间 $T$ 与其删失时间 $C$ 是相互独立的，记为 $T \perp C \mid X$ [@problem_id:4550953]。通俗地讲，这意味着一个患者是否会失访（或因其他原因被删失）可以依赖于其已知的基线特征（如年龄、疾病分期），但不应依赖于那些研究者尚未观测到的、预示其未来结局的潜在风险。如果删失是有信息性的（例如，病情更重的患者更容易退出研究），那么简单地将他们作为删失数据处理将导致对治疗效果的严重偏倚。

### Cox [比例风险模型](@entry_id:171806)

1972年，David R. Cox 爵士提出的[比例风险模型](@entry_id:171806)彻底改变了生存分析领域。该模型优美地将事件风险与一组协变量联系起来，而无需对时间的基线风险做出任何具体假设。

Cox [比例风险模型](@entry_id:171806)的数学表达式为：
$$
h(t \mid X) = h_0(t) \exp(X^\top \beta)
$$
这个模型可以分解为两个主要部分 [@problem_id:4550939]：
- **基线风险函数 ($h_0(t)$)**：这是当所有协变量 $X$ 均为零时（或处于参考水平时）的风险函数。它是时间 $t$ 的一个任意非负函数，描述了风险随时间演变的[基本模式](@entry_id:165201)。Cox 模型的一大优势在于我们**无需**指定 $h_0(t)$ 的具体形式（例如，它不必是常数或单调的）[@problem_id:4550991]。
- **协变量效应 ($\exp(X^\top \beta)$)**：这部分描述了协变量向量 $X$ 如何以乘法形式调整基线风险。向量 $\beta$ 是需要从数据中估计的[回归系数](@entry_id:634860)。

该模型的核心是**比例风险（Proportional Hazards, PH）假设**。顾名思义，该假设要求任意两个具有不同协变量向量 $X_1$ 和 $X_2$ 的个体，其[风险函数](@entry_id:166593)之比在任何时间点 $t$ 都是一个常数：
$$
\frac{h(t \mid X_1)}{h(t \mid X_2)} = \frac{h_0(t)\exp(X_1^\top \beta)}{h_0(t)\exp(X_2^\top \beta)} = \exp((X_1 - X_2)^\top \beta)
$$
可见，基线风险 $h_0(t)$ 在比值中被消去，使得风险之比不随时间变化，这就是“比例”的含义 [@problem_id:4550939] [@problem_id:4550991]。

这个恒定的风险比通常被称为**风险比（Hazard Ratio, HR）**。对于单个协变量 $x_j$ 的单位变化，其风险比为 $\exp(\beta_j)$。准确理解 HR 的含义至关重要：它是一个瞬时事件发生率的比值。例如，HR 为 0.70 意味着在任何时刻，实验组发生事件的瞬时速率是[对照组](@entry_id:188599)的 70%，即风险降低了 30% [@problem_id:4550936]。然而，HR 不应与**风险比（Risk Ratio, RR）** 或 **比值比（Odds Ratio, OR）** 相混淆。后两者是基于在某一固定时间段内的累积事件概率计算的，而 HR 是关于[瞬时速率](@entry_id:182981)的。除非在事件非常罕见的极端情况下，HR、RR 和 OR 的数值通常不相等 [@problem_id:4550980]。

### 参数估计：部分似然的奥秘

Cox 模型的精髓在于其独特的参数估计方法，即**部分似然（Partial Likelihood）**。这个方法巧妙地解决了在不了解基线[风险函数](@entry_id:166593) $h_0(t)$ 的情况下如何估计[回归系数](@entry_id:634860) $\beta$ 的难题。

该方法的核心思想是，不关注事件发生的确切时间，而只关注在每个事件发生时刻的“风险集合”中，为什么是这个特定的人发生了事件，而不是其他人。

**风险集合（Risk Set）** $R(t)$ 被定义为在时间 $t$ 之前仍然存活且未被删失的所有个体的集合 [@problem_id:4550963]。他们是下一瞬间可能发生事件的“候选人”。

现在，假设在时间 $t_{(k)}$ ，个体 $i$ 发生了事件。我们考虑这样一个条件概率：在风险集合 $R(t_{(k)})$ 中恰好发生一个事件的条件下，这个事件发生在个体 $i$ 身上的概率是多少？这个概率可以表示为个体 $i$ 的风险占整个风险集合总风险的比例：
$$
\Pr(\text{个体 } i \text{ 在 } t_{(k)} \text{ 发生事件} \mid \text{在 } R(t_{(k)}) \text{ 中发生一个事件}) = \frac{h(t_{(k)} \mid X_i)}{\sum_{j \in R(t_{(k)})} h(t_{(k)} \mid X_j)}
$$
接下来是关键一步。将 Cox 模型的公式代入上式：
$$
\frac{h_0(t_{(k)}) \exp(X_i^\top \beta)}{\sum_{j \in R(t_{(k)})} h_0(t_{(k)}) \exp(X_j^\top \beta)} = \frac{h_0(t_{(k)}) \exp(X_i^\top \beta)}{h_0(t_{(k)}) \sum_{j \in R(t_{(k)})} \exp(X_j^\top \beta)} = \frac{\exp(X_i^\top \beta)}{\sum_{j \in R(t_{(k)})} \exp(X_j^\top \beta)}
$$
我们看到，未知的基线风险函数 $h_0(t_{(k)})$ 作为分子和分母的公因子被神奇地**约掉了** [@problem_id:4550977] [@problem_id:4550997]。这个结果只与参数 $\beta$ 和风险集合中个体的协变量有关。

通过将所有观测到的事件时刻的这种条件概率连乘起来，我们就构造出了关于 $\beta$ 的**部分似然函数** $L_P(\beta)$：
$$
L_P(\beta) = \prod_{i: \delta_i=1} \frac{\exp(X_i^\top \beta)}{\sum_{j \in R(T_i)} \exp(X_j^\top \beta)}
$$
最大化这个函数，就可以得到 $\beta$ 的估计值 $\hat\beta$。这个过程完全绕开了对 $h_0(t)$ 的估计，因此 Cox 模型被称为**[半参数模型](@entry_id:200031)**：其一部分（$\beta$）是[参数化](@entry_id:265163)的，而另一部分（$h_0(t)$）是非[参数化](@entry_id:265163)的 [@problem_id:4550997]。

值得注意的是，删失的个体虽然不直接为部分似然函数的分子提供贡献项，但他们在被删失之前，作为风险集合的一员出现在分母中，为模型提供了至关重要的信息 [@problem_id:4550963]。

从效率角度看，部分似然估计量在所有不依赖于 $h_0(t)$ 的估计量中是渐近最有效的。然而，如果我们能用一个正确的参数模型（如 Weibull 分布）来描述 $h_0(t)$，那么全参数的最大似然估计会利用更多信息（事件之间的时间间隔），从而得到更精确的 $\beta$ 估计值 [@problem_id:4550977]。

### 进阶主题与实践考量

#### 时依协变量与复杂风险集

Cox 模型可以被灵活地扩展以处理**时依协变量（Time-Dependent Covariates）**，即协变量的值随时间变化，例如患者在随访期间反复测量的生物标志物。模型形式变为 $h(t \mid X(t)) = h_0(t)\exp(X(t)^\top \beta)$。令人欣喜的是，部分似然的推导依然成立，只需在每个事件时刻 $t_{(k)}$ 使用当时所有风险集成员的协变量值 $X_j(t_{(k)})$ 即可。基线风险 $h_0(t)$ 仍然会消掉 [@problem_id:4550997]。

在处理时依协变量或**左截断（Left-Truncation，即延迟入组）**数据时，通常采用[计数过程](@entry_id:260664)（counting process）的 `(start, stop, status)` 格式来记录每个个体的观察区间。此时，风险集的构建需要特别注意。根据[计数过程](@entry_id:260664)理论，风险状态过程必须是“可预测的”（predictable），这意味着它在时间 $t$ 的状态是由 $t$ 之前的历史决定的。因此，在构建事件时刻 $t^\star$ 的风险集 $R(t^\star)$ 时，一个通用的规则是：如果一个人的观察区间为 $(s, e]$，他/她当且仅当 $s  t^\star \le e$ 时才在风险集 $R(t^\star)$ 中 [@problem_id:4551005]。这个规则确保了在 $t^\star$ 发生事件的个体（其观察在 $t^\star$ 结束）被包含在内，而在 $t^\star$ 才刚刚进入研究的个体（其观察从 $t^\star$ 开始）则被排除在外。

例如，考虑以下数据（时间单位：周）[@problem_id:4551005]：
- 个体1：(2.0, 5.0, 0), (5.0, 9.0, 0)
- 个体2：(4.0, 6.0, 1) - 事件发生在第6周
- 个体3：(6.0, 7.0, 0), (7.0, 9.0, 1)
- 个体4：(1.0, 5.5, 0), (5.5, 10.0, 0)
- 个体5：(6.0, 8.0, 0)

在事件时刻 $t^\star=6.0$ 周，风险集合 $R(6.0)$ 的成员为：
- 个体1：在观察期内 ($5.0  6.0 \le 9.0$)，**在**风险集中。
- 个体2：事件发生者，观察期结束于此 ($4.0  6.0 \le 6.0$)，**在**风险集中。
- 个体3：在 $t=6.0$ 时才开始观察 ($s=6.0$)，**不在**风险集中。
- 个体4：在观察期内 ($5.5  6.0 \le 10.0$)，**在**风险集中。
- 个体5：在 $t=6.0$ 时才开始观察 ($s=6.0$)，**不在**风险集中。
因此， $R(6.0) = \{1, 2, 4\}$。

#### [比例风险假设](@entry_id:163597)的实践

PH 假设是 Cox 模型的基石，但在实际应用中，它未必成立。

**PH 假设的含义与诊断**
- **图形解释**：如果 PH 假设成立，不同组别的 $\log(-\log(\hat{S}(t)))$ 对 $\log(t)$ 的曲线应该是近似平行的 [@problem_id:4550991]。此外，不同组的 [Kaplan-Meier](@entry_id:169317) 生存曲线理论上不应交叉（除了在时间起点）。然而，样本曲线的轻微交叉可能是由抽样误差引起的，尤其是在随访[后期](@entry_id:165003) [@problem_id:4550991]。
- **违背的临床意义**：PH 假设违背的一个典型例子是**交叉风险**，例如免疫治疗中常见的“早期伤害，晚期获益”模式。在早期，治疗可能因免疫相关毒性而增加风险（HR > 1），而在后期则因肿瘤控制而降低风险（HR  1）。此时，一个单一的、在整个研究期间平均的 HR（如 0.70）会掩盖这种复杂的动态关系，极具误导性 [@problem_id:4550936]。
- **正式检验**：最常用的诊断方法是检验**Schoenfeld 残差**。将（加权的）Schoenfeld 残差对时间作图，如果图中没有系统性趋势（即回归斜率不显著异于零），则支持 PH 假设 [@problem_id:4550991]。

**处理 PH 假设违背**
当发现有力的证据表明 PH 假设不成立时，研究者有几种应对策略：
- **分层 Cox 模型（Stratified Cox Model）**：如果某个分类协变量（如治疗分组）不满足 PH 假设，可以按此变量分层。模型将为每个层级估计一个独立的基线[风险函数](@entry_id:166593) $h_{0k}(t)$，同时为其他协变量估计一个共同的 $\beta$。这允许层间风险比随时间任意变化 [@problem_id:4550991]。
- **时依系数模型**：通过在模型中加入协变量与时间的交互项来直接建模非比例风险，例如 $h(t \mid X) = h_0(t)\exp(\beta_1 X + \beta_2 X \cdot g(t))$，其中 $g(t)$ 是时间的某个函数（如 $\log(t)$）。如果 $\beta_2$ 显著不为零，则表明 $X$ 的效应是随时间变化的，其风险比为 $HR(t) = \exp(\beta_1 + \beta_2 g(t))$ [@problem_id:4550991]。这也解释了标准 Cox 模型在 PH 假设被违背时估计出的系数的含义：它实际上是真实时变效应的一个加权平均值 [@problem_id:4550936]。
- **使用不依赖 PH 假设的指标**：可以转而报告其他生存指标，如**限制性平均生存时间（Restricted Mean Survival Time, RMST）**，它比较了两组在某个时间限制内的平均生存时间差异，该指标无需 PH 假设，因此在风险交叉时更为稳健和直观 [@problem_id:4550936]。

总之，Cox 模型是一个强大而灵活的工具，但其应用需要对模型的基本原理、核心假设以及在复杂情况下的扩展有深刻的理解。