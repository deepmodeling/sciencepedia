## 引言
在生存分析领域，[Cox比例风险模型](@entry_id:174252)以其灵活性和强大的解释力，成为医学研究和生物信息学中不可或缺的工具。然而，该模型的有效性完全依赖于一个核心前提——**[比例风险](@entry_id:166780)（Proportional Hazards, PH）假设**。该假设断言，协变量对个体事件风险的影响在整个时间轴上是恒定的。当这一假设被违背时，模型的结论可能产生严重误导，影响我们对治疗效果或预后因素的正确判断。因此，对PH假设进行严谨的诊断，并非模型构建中的可选项，而是确保研究结论科学性和可靠性的关键一步。

本文旨在提供一个关于[比例风险假设](@entry_id:163597)诊断的全面指南。我们将从基本原理出发，系统地引导读者穿越理论与实践的桥梁。在“**原理与机制**”一章中，我们将深入剖析PH假设的数学内涵，并详细介绍包括Schoenfeld残差在内的核心诊断工具。接着，在“**应用与跨学科连接**”一章中，我们将展示这些诊断方法在临床研究、[竞争风险分析](@entry_id:634319)和高维组学数据等复杂场景下的具体应用和高级策略。最后，“**动手实践**”部分将通过精心设计的练习，帮助读者将理论知识转化为解决实际问题的能力。通过这一结构化的学习路径，读者将能掌握从识别、诊断到处理非比例风险问题的全套技能。

## 原理与机制

在生存分析领域，Cox比例风险模型（Cox Proportional Hazards model）因其半参数性质的灵活性和强大的解释能力而成为一项基石性的工具。该模型的核心在于一个关键假设：**比例风险（Proportional Hazards, PH）假设**。本章旨在深入阐述此假设的根本原理、检验其有效性的诊断机制，以及在复杂的生物信息学和医学数据分析场景中如何应用这些机制。我们将从第一性原理出发，系统地构建对PH假设及其诊断的理解。

### [比例风险假设](@entry_id:163597)：[Cox模型](@entry_id:164053)之基石

[Cox模型](@entry_id:164053)将一个个体的风险函数 $h(t | \boldsymbol{X})$ 分解为两部分：一个仅与时间相关的**基准[风险函数](@entry_id:166593)** $h_0(t)$，以及一个仅与协变量相关的指数项。其数学形式如下：

$h(t | \boldsymbol{X}) = h_0(t) \exp(\boldsymbol{\beta}^{\top} \boldsymbol{X})$

其中，$t$ 代表时间，$\boldsymbol{X}$ 是一个包含 $p$ 个协变量的向量（例如，基因表达、临床特征等），而 $\boldsymbol{\beta}$ 是一个相应维度的[回归系数](@entry_id:634860)向量。风险函数 $h(t | \boldsymbol{X})$ 代表在给定协变量 $\boldsymbol{X}$ 的条件下，一个个体在生存至时间 $t$ 后，在下一瞬间 $(t, t+\Delta t)$ 发生事件的[瞬时速率](@entry_id:182981)。

[比例风险假设](@entry_id:163597)的精髓在于，任意两个具有不同协变量向量（例如，$\boldsymbol{X}_1$ 和 $\boldsymbol{X}_2$）的个体，其风险函数之比，即**风险比（Hazard Ratio, HR）**，在整个时间轴上是一个常数。我们可以通过简单的代数推导来证明这一点 [@problem_id:4555994]：

$\text{HR}(t) = \frac{h(t | \boldsymbol{X}_1)}{h(t | \boldsymbol{X}_2)} = \frac{h_0(t) \exp(\boldsymbol{\beta}^{\top} \boldsymbol{X}_1)}{h_0(t) \exp(\boldsymbol{\beta}^{\top} \boldsymbol{X}_2)} = \exp(\boldsymbol{\beta}^{\top} (\boldsymbol{X}_1 - \boldsymbol{X}_2))$

从上式可见，基准风险函数 $h_0(t)$ 在分子和分母中被完全抵消。最终得到的风险比仅依赖于协变量的差异和时间无关的系数 $\boldsymbol{\beta}$，而与时间 $t$ 无关。这种不依赖于时间的恒定比例，正是“[比例风险](@entry_id:166780)”名称的由来。

Cox模型的强大之处在于其半参数特性：它不对基准风险函数 $h_0(t)$ 的具体形式做任何假设。这一特性也意味着，任何不与协变量发生交互的纯时间函数都会被模型自动吸收到基准风险中。例如，在一个临床生物信息学分析中，如果研究者观察到风险比随时间系统性变化，试图通过在模型中引入一个与协变量 $x$ 无关的时间函数 $g(t)$ 来修正模型，比如将模型设定为 $h^*(t|x) = h_0(t)g(t)\exp(\beta x)$，这并不能解决非[比例风险](@entry_id:166780)问题。该模型可以被重写为 $h^*(t|x) = h_0^*(t)\exp(\beta x)$，其中新的基准风险 $h_0^*(t) = h_0(t)g(t)$。计算其风险比会发现，$h_0^*(t)$ 同样会被抵消，风险比仍然是与时间无关的 $\exp(\beta(x_1-x_2))$ [@problem_id:4555965]。

当PH假设不成立时，意味着协变量的效应（即其对数风险比）随时间变化。这种情况被称为**非[比例风险](@entry_id:166780)（Non-proportional Hazards）**。我们可以通过引入时变系数 $\boldsymbol{\beta}(t)$ 来显式地对此建模，例如 $h(t|\boldsymbol{X}) = h_0(t)\exp(\boldsymbol{\beta}(t)^{\top} \boldsymbol{X})$。一个常见的建模策略是让系数成为时间的某个已知函数，例如，对于单个二元生物标志物 $x \in \{0, 1\}$，其效应可能随访时间越长而增强或减弱，模型可以写成 $h(t|x) = h_0(t)\exp\big((\beta_1 + \beta_2 g(t))x\big)$，其中 $g(t)$ 是时间的函数，如 $g(t) = \log(t)$ [@problem_id:4555936]。如果 $\beta_2$ 显著不为零，则PH假设被违背。因此，对PH假设的诊断是应用Cox模型进行可靠推断的关键前提。

### 评估比例风险的诊断工具

对PH假设的检验可以通过多种图形和基于残差的方法进行。这些工具旨在揭示协变量效应是否随时间表现出系统性变化。

#### 图形化诊断

一种直观的图形化诊断方法是**log-minus-log图**。该方法基于生存函数 $S(t)$ 和[累积风险函数](@entry_id:169734) $H(t)$ 之间的关系 $S(t) = \exp(-H(t))$。在[Cox模型](@entry_id:164053)下，[累积风险函数](@entry_id:169734)为 $H(t|\boldsymbol{X}) = H_0(t)\exp(\boldsymbol{\beta}^{\top}\boldsymbol{X})$，其中 $H_0(t) = \int_0^t h_0(u)du$ 是基准[累积风险函数](@entry_id:169734)。对生存函数进行两次[对数变换](@entry_id:267035)可得：

$\log(-\log S(t|\boldsymbol{X})) = \log(H_0(t)) + \boldsymbol{\beta}^{\top}\boldsymbol{X}$

此方程清晰地将时间依赖项 $\log(H_0(t))$ 和协变量效应项 $\boldsymbol{\beta}^{\top}\boldsymbol{X}$ 分离开来。如果我们将数据按某个**分类协变量**（例如，治疗组与[对照组](@entry_id:188599)）分层，并为每组绘制 $\log(-\log \hat{S}_g(t))$ 对 $\log(t)$ 的曲线（其中 $\hat{S}_g(t)$ 是该组的[Kaplan-Meier](@entry_id:169317)生存估计），PH假设意味着这些曲线应该是近似平行的，其[垂直距离](@entry_id:176279)恒定 [@problem_id:4555915]。

然而，log-minus-log图有其局限性。首先，它主要适用于分类协变量。对于像基因表达得分这样的连续性协变量，必须先将其人为地划分成几个组别，这不仅会损失信息，还会引入主观性 [@problem_id:4555915]。其次，由于Kaplan-Meier估计在随访[后期](@entry_id:165003)（当在风险集中的患者数量很少时）的方差很大，log-minus-log变换会放大这种不稳定性，导致曲线尾部出现剧烈波动，使得对平行性的视觉评估变得困难和不可靠 [@problem_id:4555915]。

#### 基于残差的诊断

残差是衡量观测数据与[模型拟合](@entry_id:265652)值之间差异的统计量。在生存分析中，有多种残差可用于[模型诊断](@entry_id:136895)，但它们服务于不同的目的。

**[鞅](@entry_id:267779)残差（Martingale Residuals）** 和 **[偏差残差](@entry_id:635876)（Deviance Residuals）** 是两种常见的个体层面残差。鞅残差 $M_i$ 定义为个体 $i$ 的观测事件数（0或1）减去其在模型下的期望事件数：$M_i = \delta_i - \hat{E}_i$。它的取值范围不对称（从 $-\infty$到1），期望为0。[偏差残差](@entry_id:635876) $D_i$ 是对鞅残差的归一化变换，使其分布更接近对称的正态分布，便于识别异常值。这两种残差的主要用途是检查模型的**总体拟合优度**以及**协变量的函数形式**。例如，在一个肿瘤预后模型中，我们可以通过绘制[鞅](@entry_id:267779)残差或[偏差残差](@entry_id:635876)关于某个连续基因表达得分 $G$ 的散点图，并叠加一条平滑曲线。如果曲线系统性地偏离水平线0（例如呈U形），则表明 $G$ 在对数风险尺度上的线性假设可能不成立 [@problem_id:4555907]。然而，它们并非诊断特定协变量是否满足PH假设的首选工具 [@problem_id:4555907]。

诊断PH假设的核心工具是**Schoenfeld残差**。与个体层面的鞅残差不同，Schoenfeld残差是为每个**事件时间点**和每个**协变量**定义的。其推导源于[Cox模型](@entry_id:164053)的[偏似然](@entry_id:165240)[得分函数](@entry_id:164520)。在任一事件时间 $t_k$，假设个体 $d_k$ 发生事件，其协变量 $j$ 的Schoenfeld残差 $r_{S,k,j}$ 定义为该个体在该协变量上的观测值 $X_{d_k, j}$ 与在风险集 $R(t_k)$ 中所有个体的该协变量值的风险加权平均值之差 [@problem_id:4555979]：

$r_{S,k,j} = X_{d_k, j}(t_k) - \frac{\sum_{i \in R(t_k)} X_{i,j}(t_k) \exp(\boldsymbol{\hat{\beta}}^{\top} \boldsymbol{X}_i(t_k))}{\sum_{i \in R(t_k)} \exp(\boldsymbol{\hat{\beta}}^{\top} \boldsymbol{X}_i(t_k))}$

这个定义解释了为何Schoenfeld残差只在事件发生时有定义——因为它们源于构成[偏似然](@entry_id:165240)的各个条件概率项。每一项都以一个事件的发生为条件。从直观上看，这个残差比较了“实际”发生事件的个体的协变量值与模型根据当时风险集中的所有个体所“期望”的协变量值。如果PH假设成立，这些残差的期望应为0，且当它们被绘制成关于时间的函数时，应呈现出围绕0的随机散点，无任何系统性趋势 [@problem_id:4555936] [@problem_id:4555907]。因此，Schoenfeld[残差图](@entry_id:169585)中的系统性模式（如线性趋势、曲线趋势）是违背PH假设的有力证据。

### 对非比例风险的形式化检验

除了图形诊断，我们还需要更客观的形式化统计检验来评估PH假设。

#### 基于Schoenfeld残差的检验

**Grambsch-Therneau检验**是目前最广泛使用的检验PH假设的方法。其基本思想是：如果协变量的效应随时间变化，那么Schoenfeld残差将与时间相关。因此，可以通过将Schoenfeld残差对时间（或时间的某个函数，如 $\log(t)$）进行回归，并检验其斜率是否显著不为零 [@problem_id:4555936]。

然而，一个技术细节至关重要：原始的（未缩放的）Schoenfeld残差是**异方差**的。这意味着它们的方差在不同事件时间点上是变化的。其[条件方差](@entry_id:183803)在时间 $t_i$ 等于[偏似然](@entry_id:165240)在该时间点的信息增量矩阵 $\Sigma(t_i, \boldsymbol{\beta})$。由于风险集 $R(t)$ 的大小和构成随时间演变（患者发生事件或被删失），$\Sigma(t_i, \boldsymbol{\beta})$ 也随之变化 [@problem_id:4555977]。在[回归分析](@entry_id:165476)中，异方差会影响检验的效率和有效性。

Grambsch-Therneau检验通过使用**缩放的（scaled）Schoenfeld残差**来解决这个问题。缩放过程本质上是一种方差稳定化变换，它使用 $\Sigma(t, \boldsymbol{\hat{\beta}})$ 的估计值的逆来对残差进行变换，从而使得变换后的残差在PH假设下近似同方差。这使得后续的回归分析和假设检验更为可靠和强大 [@problem_id:4555977]。对某个协变量，一个显著不为零的回归斜率（即一个很小的[p值](@entry_id:136498)）提供了反对PH假设的统计学证据。

#### 基于时依协变量的检验

另一种形式化检验方法是直接在Cox模型中构建一个包含时依效应的扩展模型。如前所述，我们可以引入一个协变量与时间函数的交互项，例如：

$h(t|x) = h_0(t)\exp(\beta_1 x + \gamma x \cdot g(t))$

在此模型中，协变量 $x$ 的对数风险比为 $\beta_1 + \gamma g(t)$，它是一个时间的函数。PH假设在此框架下等价于零假设 $H_0: \gamma = 0$。如果对 $\gamma$ 的检验（如[Wald检验](@entry_id:164095)或[似然比检验](@entry_id:268070)）结果是显著的，我们就可以拒绝原假设，断定存在非比例风险 [@problem_id:4555936]。这种方法不仅可以检验PH假设，还可以在假设被拒绝时，提供对效应如何随时间变化的直接估计。值得注意的是，Grambsch-Therneau检验在数学上近似于对这种扩展模型中交互项系数 $\gamma$ 的[得分检验](@entry_id:171353)（score test）。

### 高级议题与复杂因素

在实际的生物信息学和医学数据分析中，诊断PH假设常常会遇到更复杂的情况。

#### [未观测异质性](@entry_id:142880)（脆弱性）导致的伪非[比例风险](@entry_id:166780)

有时，观测到的非[比例风险](@entry_id:166780)现象并非源于协变量效应的真实时变性，而是由**未观测到的异质性（unobserved heterogeneity）**造成的。在生存分析中，这种异质性通常通过**脆弱性模型（Frailty Model）**来建模。

假设在一个多中心肿瘤研究中，真实的个体风险由一个未观测的、乘性的随机效应（即**脆弱性**）$U$ 决定：$h(t|X, U) = h_0(t) U \exp(\beta X)$。其中 $U$ 代表个体固有的、未被模型中其他协变量捕捉的风险水平，且我们假设在给定 $U$ 的条件下，协变量 $X$ 的效应 $\beta$ 是恒定的。

然而，分析师通常拟合的是忽略了 $U$ 的边际模型。在这样的群体中，存在一个“适者生存”的选择偏倚：脆弱性值较高（即内在风险较高）的个体更可能在早期发生事件并从风险集中脱落。因此，随着时间的推移，仍在风险集中的人群的平均脆弱性水平会逐渐降低。这种动态变化导致了边际风险比的衰减：即使条件风险比 $\exp(\beta)$ 是常数，观测到的边际风险比 $\text{HR}_{\text{marg}}(t)$ 也会从 $t=0$ 时的 $\exp(\beta)$ 随时间逐渐趋近于1 [@problem_id:4555993]。

这种脆弱性效应在PH诊断中会留下独特的“指纹”：
1.  Schoenfeld[残差图](@entry_id:169585)通常会显示一个负向趋势，表明效应随时间减弱。
2.  在不同时间点进行的**地标分析（landmark analysis）**会显示，随着地标时间的增加，估计的风险比会衰减。
3.  最关键的证据是，当研究者转而拟合一个明确包含个体随机效应的脆弱性模型（如Gamma脆弱性模型）时，之前观测到的Schoenfeld残差趋势和时依交互项的显著性会消失。这强烈支持了观测到的非比例性是由[未观测异质性](@entry_id:142880)而非真实的效应时变性驱动的解释 [@problem_id:4555993]。

#### [竞争风险](@entry_id:173277)

在许多医学研究中，患者面临多种[互斥](@entry_id:752349)的事件类型，即**[竞争风险](@entry_id:173277)（Competing Risks）**。例如，在肿瘤学研究中，患者可能死于癌症（事件1）或非癌症原因（事件2）。在这种情况下，我们需要区分两种不同的风险度量：

1.  **特定原因风险（Cause-Specific Hazard, CSH）**, $h_k(t|X)$：在时刻 $t$ 仍存活（未发生任何事件）的个体，发生第 $k$ 类事件的[瞬时速率](@entry_id:182981)。
2.  **子分布风险（Subdistribution Hazard, SDH）**, $\tilde{h}_k(t|X)$：在时刻 $t$ 尚未发生第 $k$ 类事件的个体（包括存活者和已发生其他竞争事件者），发生第 $k$ 类事件的瞬时速率。

CSH和SDH对应着不同的风险集和研究问题，因此它们的PH假设是**完全独立**的。一个的成立并不意味着另一个的成立 [@problem_id:4555929]。对PH假设的诊断必须针对所使用的模型进行。如果研究者为每种死因拟合了独立的CSH模型，那么就应该为每个模型分别进行PH诊断。诊断结果完全可能是原因特异性的。例如，诊断可能会显示，某个生物标志物的效应在预测癌症死亡风险时存在非比例性（Schoenfeld残差有趋势，[p值](@entry_id:136498)显著），但在预测非癌症死亡风险时则满足PH假设（[残差图](@entry_id:169585)平坦，p值不显著）[@problem_id:4555929]。此外，需要注意的是，即使所有CSH都满足PH假设，由于竞争事件对风险集构成的动态影响，对应的累积发生率函数（CIF）曲线也可能发生交叉，这本身并不必然意味着任何CSH的PH假设被违背 [@problem_id:4555929]。

#### 数据结构对诊断的影响

现实世界的数据往往包含**左截断（left truncation）**、**[右删失](@entry_id:164686)（right censoring）**和**事件时间绑定（tied event times）**等复杂结构。幸运的是，[Cox模型](@entry_id:164053)的[计数过程](@entry_id:260664)（counting process）理论框架为处理这些情况提供了坚实的基础。

- **左截断和右删失**：只要截断和删失机制是**非信息性**的（即在给定协变量的情况下，它们不提供关于事件时间的额外信息），并且在分析中正确定义了风险集（例如，对于左[截断数据](@entry_id:163004)，仅在个体进入研究后才将其纳入风险集），那么基于[偏似然](@entry_id:165240)的PH诊断工具（如Schoenfeld残差）的有效性就不会受到影响。其在零假设下的基本性质（如期望为零）得以保持 [@problem_id:4555946]。当然，大量的删失会减少观测到的事件数量，从而降低诊断检验的[统计功效](@entry_id:197129) [@problem_id:4555946]。
- **事件时间绑定**：当多个事件发生在同一时间点时，需要对[偏似然](@entry_id:165240)进行近似处理，常用的有Breslow和Efron方法。Efron方法通常更为精确。在存在大量绑定事件的情况下，使用不够精确的Breslow近似会低估统计量的方差，可能导致Grambsch-Therneau这类检验的I类错误率膨胀，即更倾向于错误地拒绝PH假设（变得“反保守”）[@problem_id:4555946]。

总之，对[比例风险假设](@entry_id:163597)的审慎评估是应用Cox模型不可或缺的一步。通过结合使用图形化方法、基于残差的诊断以及形式化统计检验，并对潜在的复杂因素（如脆弱性、竞争风险和[数据结构](@entry_id:262134)）保持清醒的认识，研究者能够更准确地理解协变量与生存结局之间的动态关系，从而构建出更为可靠和深刻的[统计模型](@entry_id:755400)。