{"hands_on_practices": [{"introduction": "在实际的生存分析中，多个事件被记录在同一时间点（即“时间绑定”）是一种常见情况。此练习 [@problem_id:4610354] 提供了一个具体的例子，探讨在Cox模型的偏似然中如何处理这些时间绑定，并比较了广泛使用的Breslow和Efron近似法。理解这一点对于使用真实的、离散时间的临床数据正确拟合模型至关重要。", "problem": "一项关于免疫治疗反应的临床基因组学研究考虑了两种事件类型：影像学进展（原因$1$）和非进展性死亡（原因$2$）。计划对原因$1$的特定原因风险采用分层Cox比例风险(PH)模型，其中层由测序平台（$S \\in \\{\\text{A}, \\text{B}\\}$）定义。唯一的协变量是通路突变的二元指示变量$X$（如果发生突变则$X=1$，否则$X=0$）。时间以月为单位记录，并四舍五入到最接近的整数月份，从而产生了事件时间平局。数据集如下：\n\n- 层 $\\text{A}$：\n  - 受试者 $\\text{A}1$：$X=1$，时间 $=4$，事件类型 $=1$。\n  - 受试者 $\\text{A}2$：$X=0$，时间 $=4$，事件类型 $=1$。\n  - 受试者 $\\text{A}3$：$X=1$，时间 $=4$，事件类型 $=2$。\n  - 受试者 $\\text{A}4$：$X=0$，时间 $=6$，删失。\n  - 受试者 $\\text{A}5$：$X=1$，时间 $=10$，删失。\n\n- 层 $\\text{B}$：\n  - 受试者 $\\text{B}1$：$X=0$，时间 $=3$，事件类型 $=1$。\n  - 受试者 $\\text{B}2$：$X=1$，时间 $=4$，事件类型 $=2$。\n  - 受试者 $\\text{B}3$：$X=1$，时间 $=5$，事件类型 $=1$。\n  - 受试者 $\\text{B}4$：$X=0$，时间 $=7$，删失。\n\n在原因$1$的特定原因Cox PH模型内，并使用从第一性原理定义的偏似然（风险集由恰好在某个时间点之前无事件的个体定义，分子仅包含原因$1$的事件），执行以下操作：\n\n- 证明在层$\\text{A}$中，对于原因$1$的模型，时间$t=4$时的风险集包含哪些个体，并解释$t=4$时的事件时间平局如何影响此时偏似然中分子和分母的构成，包括在$t=4$时发生原因$2$事件的个体如何贡献。\n- 使用从第一性原理推导出的用于处理$m$个事件时间平局的半参数平局处理近似方法（不调用任何精确的离散时间排序），写出在Breslow和Efron两种近似下，层$\\text{A}$在时间$t=4$时对偏似然的层特定贡献，作为对数风险比参数$\\beta$的函数。\n- 对于跨越层$\\text{A}$和$\\text{B}$的整体分层模型，计算在$\\beta=\\ln(2)$时，Efron近似偏似然与Breslow近似偏似然的比率。将您的最终答案四舍五入到四位有效数字。将您的最终数值结果表示为一个纯数字（无单位）。", "solution": "该问题是有效的，因为它在科学上基于生存分析理论，特别是涉及竞争风险和数据平局的分层Cox模型。所提供的数据是自洽且一致的，问题提得很好，可以导出一个唯一且有意义的解。\n\n该问题要求三件事：证明在层$\\text{A}$中时间$t=4$时风险集的构成，使用Breslow和Efron近似计算此时间点的层特定偏似然贡献，以及在特定的$\\beta$值下计算总Efron偏似然与Breslow偏似然的比率。\n\n首先，我们分析风险集和事件数据。该模型是针对原因$1$（影像学进展）的特定原因Cox比例风险模型。在此框架中，其他原因的事件（此处为原因$2$：非进展性死亡）在其发生时被视为右删失事件。\n\n时间$t$的风险集，记为$R(t)$，由所有在恰好$t$时刻之前仍在观察中且未经历任何类型事件的个体组成。这意味着它包括所有观测时间$T_i$大于或等于$t$的受试者$i$。\n\n**第1部分：层$\\text{A}$中$t=4$时的风险集**\n\n层$\\text{A}$的数据如下：\n- 受试者 $\\text{A}1$：$X=1$，时间 $=4$，事件类型 $=1$。\n- 受试者 $\\text{A}2$：$X=0$，时间 $=4$，事件类型 $=1$。\n- 受试者 $\\text{A}3$：$X=1$，时间 $=4$，事件类型 $=2$。\n- 受试者 $\\text{A}4$：$X=0$，时间 $=6$，删失。\n- 受试者 $\\text{A}5$：$X=1$，时间 $=10$，删失。\n\n在时间$t=4$时，层$\\text{A}$的风险集$R_A(4)$包括该层中所有观测时间$T_i \\geq 4$的受试者。层$\\text{A}$中的所有五个受试者都满足此条件。\n- $T_{A1}=4$，$T_{A2}=4$，$T_{A3}=4$，$T_{A4}=6$，$T_{A5}=10$。\n因此，风险集为$R_A(4) = \\{\\text{A}1, \\text{A}2, \\text{A}3, \\text{A}4, \\text{A}5\\}$。\n\n在$t=4$时，发生了多个事件。我们正在对原因$1$的风险进行建模。在$t=4$时经历原因$1$事件的受试者是A1和A2。设$D_A(4)$为在$t=4$时经历原因1事件的受试者集合。因此，$D_A(4) = \\{\\text{A}1, \\text{A}2\\}$。原因$1$的事件时间平局数量为$m_A = |D_A(4)| = 2$。\n受试者A3在$t=4$时经历原因$2$的事件。对于原因$1$的特定原因风险模型，受试者A3在$t=4$时被视为删失。因此，A3被包含在风险集$R_A(4)$中，并对$t=4$时偏似然项的分母有贡献，但它不被包含在构成分子“失效”集$D_A(4)$中。\n\n**第2部分：层$\\text{A}$中$t=4$时的偏似然贡献**\n\n层$s$中个体$i$的特定原因风险为$h_i(t|X_i) = h_{0,s}(t) \\exp(\\beta X_i)$。\n在事件时间$t_j$有$m_j$个所关注原因的事件时间平局时，其偏似然贡献由以下公式给出：\n$$L_j(\\beta) = \\frac{\\prod_{i \\in D_j} \\exp(\\beta X_i)}{\\text{Denominator}}$$\n这等价于\n$$L_j(\\beta) = \\frac{\\exp(\\beta \\sum_{i \\in D_j} X_i)}{\\text{Denominator}}$$\n分母的形式取决于处理平局的近似方法。\n\n对于层$\\text{A}$在$t=4$时：\n风险集为$R_A(4) = \\{\\text{A}1, \\text{A}2, \\text{A}3, \\text{A}4, \\text{A}5\\}$，其协变量为$X_{A1}=1, X_{A2}=0, X_{A3}=1, X_{A4}=0, X_{A5}=1$。\n原因1的失效集为$D_A(4) = \\{\\text{A}1, \\text{A2}\\}$，其协变量为$X_{A1}=1, X_{A2}=0$。平局数量为$m_A=2$。\n\n风险集上的风险评分总和为：\n$$ \\sum_{j \\in R_A(4)} \\exp(\\beta X_j) = \\exp(\\beta \\cdot 1) + \\exp(\\beta \\cdot 0) + \\exp(\\beta \\cdot 1) + \\exp(\\beta \\cdot 0) + \\exp(\\beta \\cdot 1) = 3\\exp(\\beta) + 2 $$\n失效受试者的协变量总和为$\\sum_{i \\in D_A(4)} X_i = 1+0=1$。\n似然贡献的分子是$\\exp(\\beta \\cdot 1) = \\exp(\\beta)$。\n\nBreslow近似的分母是$(\\sum_{j \\in R_A(4)} \\exp(\\beta X_j))^{m_A}$。\n在Breslow近似下，在$t=4$时对偏似然的层特定贡献是：\n$$ L_{Breslow, A, 4}(\\beta) = \\frac{\\exp(\\beta)}{(3\\exp(\\beta) + 2)^2} $$\n\nEfron近似的分母是$\\prod_{k=0}^{m_A-1} \\left( \\sum_{j \\in R_A(4)} \\exp(\\beta X_j) - \\frac{k}{m_A} \\sum_{l \\in D_A(4)} \\exp(\\beta X_l) \\right)$。\n失效受试者的风险评分总和为$\\sum_{l \\in D_A(4)} \\exp(\\beta X_l) = \\exp(\\beta \\cdot 1) + \\exp(\\beta \\cdot 0) = \\exp(\\beta) + 1$。\n对于$m_A=2$，分母是两项（$k=0$和$k=1$）的乘积：\n- $k=0$的项：$(3\\exp(\\beta) + 2) - \\frac{0}{2}(\\exp(\\beta)+1) = 3\\exp(\\beta) + 2$\n- $k=1$的项：$(3\\exp(\\beta) + 2) - \\frac{1}{2}(\\exp(\\beta)+1) = 3\\exp(\\beta) + 2 - \\frac{1}{2}\\exp(\\beta) - \\frac{1}{2} = \\frac{5}{2}\\exp(\\beta) + \\frac{3}{2}$\nEfron近似的似然贡献是：\n$$ L_{Efron, A, 4}(\\beta) = \\frac{\\exp(\\beta)}{(3\\exp(\\beta) + 2) \\left(\\frac{5}{2}\\exp(\\beta) + \\frac{3}{2}\\right)} $$\n\n**第3部分：整体模型的Efron似然与Breslow似然之比**\n\n总的分层偏似然是各层似然的乘积：$L(\\beta) = L_A(\\beta) L_B(\\beta)$。每层的似然是该层中每个唯一的原因1事件时间的贡献的乘积。\n比率为$\\mathcal{R} = \\frac{L_{Efron}(\\beta)}{L_{Breslow}(\\beta)} = \\frac{L_{Efron, A}(\\beta)}{L_{Breslow, A}(\\beta)} \\times \\frac{L_{Efron, B}(\\beta)}{L_{Breslow, B}(\\beta)}$。\n\n对于层$\\text{A}$，唯一的原因1事件时间是$t=4$。Efron贡献与Breslow贡献的比率为：\n$$ \\frac{L_{Efron, A, 4}(\\beta)}{L_{Breslow, A, 4}(\\beta)} = \\frac{\\frac{\\exp(\\beta)}{(3\\exp(\\beta) + 2)(\\frac{5}{2}\\exp(\\beta) + \\frac{3}{2})}}{\\frac{\\exp(\\beta)}{(3\\exp(\\beta) + 2)^2}} = \\frac{3\\exp(\\beta) + 2}{\\frac{5}{2}\\exp(\\beta) + \\frac{3}{2}} = \\frac{2(3\\exp(\\beta) + 2)}{5\\exp(\\beta) + 3} $$\n\n现在，我们分析层$\\text{B}$。数据如下：\n- 受试者 B1：$X=0$，时间 $=3$，事件类型 $=1$。\n- 受试者 B2：$X=1$，时间 $=4$，事件类型 $=2$。\n- 受试者 B3：$X=1$，时间 $=5$，事件类型 $=1$。\n- 受试者 B4：$X=0$，时间 $=7$，删失。\n\n在层B中，唯一的原因1事件时间是$t=3$和$t=5$。\n- 在$t=3$时：事件是B1 ($X=0$)。只有一个事件，$m_B(3)=1$。当没有平局（$m=1$）时，Breslow和Efron近似是相同的。因此，$\\frac{L_{Efron, B, 3}(\\beta)}{L_{Breslow, B, 3}(\\beta)} = 1$。\n- 在$t=5$时：事件是B3 ($X=1$)。B1和B2已不在风险集中。风险集是$R_B(5) = \\{\\text{B3}, \\text{B4}\\}$。只有一个事件，$m_B(5)=1$。同样，由于没有平局，近似方法是相同的，所以$\\frac{L_{Efron, B, 5}(\\beta)}{L_{Breslow, B, 5}(\\beta)} = 1$。\n\n因此，层$\\text{B}$的似然比为$\\frac{L_{Efron, B}(\\beta)}{L_{Breslow, B}(\\beta)} = 1 \\times 1 = 1$。\n总比率完全由层$\\text{A}$在$t=4$时的贡献决定：\n$$ \\mathcal{R}(\\beta) = \\frac{2(3\\exp(\\beta) + 2)}{5\\exp(\\beta) + 3} $$\n\n我们被要求在$\\beta = \\ln(2)$处计算这个比率。在此值下，$\\exp(\\beta) = \\exp(\\ln(2)) = 2$。\n$$ \\mathcal{R}(\\ln(2)) = \\frac{2(3(2) + 2)}{5(2) + 3} = \\frac{2(6 + 2)}{10 + 3} = \\frac{2(8)}{13} = \\frac{16}{13} $$\n为了找到四舍五入到四位有效数字的数值：\n$$ \\frac{16}{13} \\approx 1.230769... $$\n四舍五入到四位有效数字得到$1.231$。", "answer": "$$\\boxed{1.231}$$", "id": "4610354"}, {"introduction": "构建生存模型的一个主要目标是检验协变量的显著效应，例如评估一种疗法的效果。这个练习 [@problem_id:4610370] 通过展示经典的分层对数秩检验（log-rank test）如何从分层Cox模型的得分检验（score test）中推导出来，从而在理论与实践之间架起了一座桥梁。通过完成这一计算，您将对这些重要统计工具背后的理论统一性有更深刻的认识。", "problem": "一项转化肿瘤学研究追踪实体瘤患者的疾病进展时间，并将无事先进展的死亡事件视为竞争风险事件。为了对进展的特定原因风险进行推断，竞争风险事件通过特定原因方法处理：经历竞争风险事件的受试者在此时对进展终点进行删失，并且仅在无进展且存活时才被纳入风险集。研究人员将患者随机分配到两个治疗组，用指示变量 $Z \\in \\{0,1\\}$ 表示，并根据二元分子风险特征 $S \\in \\{1,2\\}$（低风险 $S=1$，高风险 $S=2$）预先指定分层。事件时间按离散的月份网格记录，这会产生结（ties）。目标是从分层Cox比例风险（Cox PH）模型中，将分层对数秩检验（log-rank test）作为得分检验（score test）来获得，并基于分组事件时间计算该检验。\n\n从第一性原理出发，使用特定原因风险公式和分层Cox PH模型，其中每个分层内 $Z$ 对应一个单一系数 $\\beta$，允许基线风险按分层变化，但系数 $\\beta$ 在各分层间是共同的。形式上，对于分层 $s$，\n$$\nh_{s}(t \\mid Z) \\;=\\; h_{0s}(t)\\,\\exp\\!\\big(\\beta Z\\big),\n$$\n且 $\\beta$ 的部分似然函数可按分层分解。对于离散（分组）事件时间，在分层 $s$ 的每个唯一分组时间 $j$，$d_{sj} \\geq 1$ 个并列的进展事件发生，且在该时间点之前紧邻的风险集大小为 $r_{sj}$，其中风险集里有 $n_{sj}$ 个个体属于组 $Z=1$。设 $d^{(1)}_{sj}$ 为在该分组时间点，组 $Z=1$ 中实际观测到的 $d_{sj}$ 个事件中的事件数。\n\n在原假设 $H_{0}:\\beta=0$ 下，从分层Cox PH模型的部分似然函数推导当事件时间分组时，在 $\\beta=0$ 处求值的得分函数 $U(\\beta)$ 及其在 $\\beta=0$ 处的期望信息 $I(\\beta)$。通过在每个分组时间点对风险集进行条件化，并使用适当的有限总体抽样逻辑，来论证分组时间（结）校正是如何引入的。证明得到的得分检验与在所有事件时间上具有相等权重的分层对数秩检验一致。\n\n然后，使用以下科学上合理的汇总计数（这些计数已经排除了发生竞争风险事件后的个体，即特定原因风险集）来计算 $H_{0}:\\beta=0$ 的分层得分检验统计量：\n- 分层 $s=1$ (低分子风险):\n  - 分组时间 $j=1$: $r_{11}=80$, $n_{11}=40$, $d_{11}=5$, $d^{(1)}_{11}=4$。\n  - 分组时间 $j=2$: $r_{12}=75$, $n_{12}=38$, $d_{12}=3$, $d^{(1)}_{12}=2$。\n  - 分组时间 $j=3$: $r_{13}=70$, $n_{13}=35$, $d_{13}=4$, $d^{(1)}_{13}=3$。\n- 分层 $s=2$ (高分子风险):\n  - 分组时间 $j=1$: $r_{21}=60$, $n_{21}=20$, $d_{21}=6$, $d^{(1)}_{21}=1$。\n  - 分组时间 $j=2$: $r_{22}=55$, $n_{22}=18$, $d_{22}=5$, $d^{(1)}_{22}=2$。\n  - 分组时间 $j=3$: $r_{23}=50$, $n_{23}=16$, $d_{23}=7$, $d^{(1)}_{23}=3$。\n\n根据您的推导，使用在 $H_0$ 下适当的分组时间校正，计算分层对数秩得分检验统计量\n$$\nQ \\;=\\; \\frac{U(0)^{2}}{I(0)}\n$$\n。将您的最终数值答案四舍五入到四位有效数字。$Q$ 无需物理单位。", "solution": "该问题具有科学依据，提法明确，客观，并包含得出唯一解所需的所有信息。因此，该问题被认定为有效。我们着手进行推导和计算。\n\n本问题要求从分层Cox比例风险（PH）模型中将分层对数秩检验推导为得分检验，然后计算该检验统计量。\n\n### 第1部分：推导\n\n我们从指定的分层Cox PH模型开始。对于分层 $s \\in \\{1, 2, \\dots, S\\}$ 中治疗指示变量为 $Z$ 的个体，其在时间 $t$ 发生目标事件（进展）的特定原因风险由下式给出\n$$h_s(t \\mid Z) = h_{0s}(t) \\exp(\\beta Z)$$\n其中 $h_{0s}(t)$ 是一个任意的、特定于分层的基线风险函数，$\\beta$ 是与治疗相关的对数风险比，假定在所有分层中是共同的。\n\n$\\beta$ 的部分似然函数是通过考虑在每个事件时间点，给定风险集中的个体，观测到实际发生事件的个体集合的概率来构建的。由于模型是分层的，总部分似然函数 $L(\\beta)$ 是来自每个分层 $s$ 的部分似然函数的乘积：\n$$L(\\beta) = \\prod_{s=1}^{S} L_s(\\beta)$$\n相应的对数部分似然函数是各分层特定对数部分似然函数的和：\n$$\\ell(\\beta) = \\log L(\\beta) = \\sum_{s=1}^{S} \\ell_s(\\beta)$$\n\n问题指明事件时间是分组的，从而产生结。设分层 $s$ 中的不同事件时间由 $j$ 索引。在分层 $s$ 的时间 $j$，设 $D_{sj}$ 是发生事件的 $d_{sj}$ 个个体的集合，而 $R_{sj}$ 是在时间 $j$ 之前紧邻的、无事件且在观察中的 $r_{sj}$ 个个体组成的风险集。设 $n_{sj}$ 是风险集 $R_{sj}$ 中 $Z=1$ 的个体数量，而 $d_{sj}^{(1)}$ 是事件集 $D_{sj}$ 中 $Z=1$ 的个体数量。\n\n对于离散（分组）时间数据，来自第 $s$ 层、第 $j$ 个事件时间的似然贡献，是在给定风险集 $R_{sj}$ 和恰好发生 $d_{sj}$ 次失败这一事实的条件下，观测到特定的 $d_{sj}$ 个体失败的条件概率。关键在于，对于原假设 $H_0: \\beta=0$ 下的得分检验，部分似然函数的确切形式会显著简化。我们推导得分函数 $U(\\beta) = \\partial\\ell(\\beta)/\\partial\\beta$ 和信息量 $I(\\beta) = -\\mathbb{E}[\\partial^2\\ell(\\beta)/\\partial\\beta^2]$。得分检验统计量为 $Q = U(0)^2 / I(0)$。\n\n在处理结的离散时间模型下，来自第 $s$ 层、第 $j$ 个时间的对数似然贡献，是基于在给定边际计数 $r_{sj}$、$n_{sj}$ 和 $d_{sj}$ 的条件下，观察到治疗组（$Z=1$）中发生 $d_{sj}^{(1)}$ 个事件的条件概率。此概率遵循非中心超几何分布。完整的对数似然贡献为：\n$$\\ell_{sj}(\\beta) = \\beta d_{sj}^{(1)} - \\log \\left( \\sum_{k=\\max(0, d_{sj}-(r_{sj}-n_{sj}))}^{\\min(d_{sj}, n_{sj})} \\binom{n_{sj}}{k} \\binom{r_{sj}-n_{sj}}{d_{sj}-k} \\exp(\\beta k) \\right)$$\n该时间点的得分函数贡献为 $U_{sj}(\\beta) = \\partial\\ell_{sj}(\\beta)/\\partial\\beta$：\n$$U_{sj}(\\beta) = d_{sj}^{(1)} - \\frac{\\sum_k k \\binom{n_{sj}}{k} \\binom{r_{sj}-n_{sj}}{d_{sj}-k} \\exp(\\beta k)}{\\sum_k \\binom{n_{sj}}{k} \\binom{r_{sj}-n_{sj}}{d_{sj}-k} \\exp(\\beta k)}$$\n总得分函数为 $U(\\beta) = \\sum_s \\sum_j U_{sj}(\\beta)$。\n\n在原假设 $H_0: \\beta=0$ 下，我们有 $\\exp(\\beta k)=1$。根据范德蒙恒等式，分母变为 $\\sum_k \\binom{n_{sj}}{k} \\binom{r_{sj}-n_{sj}}{d_{sj}-k} = \\binom{r_{sj}}{d_{sj}}$。分子变为 $\\sum_k k \\binom{n_{sj}}{k} \\binom{r_{sj}-n_{sj}}{d_{sj}-k}$。该比率是遵循（中心）超几何分布的随机变量 $k$ 的期望值。该分布描述了从一个包含 $r_{sj}$ 个项目的总体中不放回地抽取 $d_{sj}$ 个项目，其中 $n_{sj}$ 个项目属于一种类型（这里是 $Z=1$）。其期望值为 $d_{sj} (n_{sj}/r_{sj})$。\n\n因此，在 $\\beta=0$ 处的得分贡献为：\n$$U_{sj}(0) = d_{sj}^{(1)} - d_{sj} \\frac{n_{sj}}{r_{sj}}$$\n这是经典的（观测值 - 期望值）项，其中 $d_{sj}^{(1)}$ 是组 $Z=1$ 中观测到的事件数，而 $E_{sj} = d_{sj} \\frac{n_{sj}}{r_{sj}}$ 是在无治疗效应的原假设下的期望事件数。在 $\\beta=0$ 处的总得分是所有事件时间和分层的总和：\n$$U(0) = \\sum_s \\sum_j \\left(d_{sj}^{(1)} - d_{sj} \\frac{n_{sj}}{r_{sj}}\\right)$$\n\n接下来，我们推导信息量 $I(0)$。来自第 $s$ 层、第 $j$ 个时间的信息量贡献是 $I_{sj}(0) = -\\left.\\frac{\\partial^2\\ell_{sj}(\\beta)}{\\partial\\beta^2}\\right|_{\\beta=0}$。对 $U_{sj}(\\beta)$ 求导表明，$I_{sj}(0)$ 是同一个超几何随机变量的方差。一个总体大小为 $r_{sj}$、其中“成功”项数量为 $n_{sj}$、样本大小为 $d_{sj}$ 的超几何分布的方差为：\n$$I_{sj}(0) = \\text{Var}(d_{sj}^{(1)}) = d_{sj} \\left(\\frac{n_{sj}}{r_{sj}}\\right) \\left(1 - \\frac{n_{sj}}{r_{sj}}\\right) \\left(\\frac{r_{sj}-d_{sj}}{r_{sj}-1}\\right)$$\n这可以写作 $V_{sj} = E_{sj} \\left(\\frac{r_{sj}-n_{sj}}{r_{sj}}\\right) \\left(\\frac{r_{sj}-d_{sj}}{r_{sj}-1}\\right)$。项 $\\frac{r_{sj}-d_{sj}}{r_{sj}-1}$ 是有限总体校正因子，它恰当地解释了并列事件（不放回地抽取 $d_{sj}$ 个个体）。这个论证直接回应了所要求的“有限总体抽样逻辑”。在 $\\beta=0$ 处的总信息量是这些方差的总和：\n$$I(0) = \\sum_s \\sum_j V_{sj}$$\n\n得分检验统计量是 $Q = \\frac{U(0)^2}{I(0)}$。代入推导出的表达式：\n$$Q = \\frac{\\left(\\sum_s \\sum_j (d_{sj}^{(1)} - E_{sj})\\right)^2}{\\sum_s \\sum_j V_{sj}}$$\n这正是分层对数秩检验（也称为Mantel-Haenszel检验）的公式，其中所有事件时间具有相等的权重，并对结进行了适当的校正。\n\n### 第2部分：计算\n\n我们现在使用提供的数据计算检验统计量 $Q$。对于每个分层 $s$ 中的每个事件时间 $j$，我们计算观测事件数减去期望事件数，$O_{sj} - E_{sj} = d_{sj}^{(1)} - d_{sj} \\frac{n_{sj}}{r_{sj}}$，以及方差，$V_{sj} = d_{sj} \\frac{n_{sj}}{r_{sj}} \\frac{r_{sj}-n_{sj}}{r_{sj}} \\frac{r_{sj}-d_{sj}}{r_{sj}-1}$。\n\n**分层 $s=1$ (低分子风险)**\n- 时间 $j=1$: $r_{11}=80, n_{11}=40, d_{11}=5, d^{(1)}_{11}=4$。\n  - $O_{11}-E_{11} = 4 - 5 \\left(\\frac{40}{80}\\right) = 4 - 2.5 = 1.5$。\n  - $V_{11} = 5 \\left(\\frac{40}{80}\\right) \\left(\\frac{40}{80}\\right) \\left(\\frac{80-5}{80-1}\\right) = 5(0.5)(0.5)\\left(\\frac{75}{79}\\right) = 1.25 \\left(\\frac{75}{79}\\right) = \\frac{375}{316}$。\n- 时间 $j=2$: $r_{12}=75, n_{12}=38, d_{12}=3, d^{(1)}_{12}=2$。\n  - $O_{12}-E_{12} = 2 - 3 \\left(\\frac{38}{75}\\right) = 2 - 1.52 = 0.48 = \\frac{12}{25}$。\n  - $V_{12} = 3 \\left(\\frac{38}{75}\\right) \\left(\\frac{37}{75}\\right) \\left(\\frac{75-3}{75-1}\\right) = 1.52 \\left(\\frac{37}{75}\\right) \\left(\\frac{72}{74}\\right) = \\frac{456}{625}$。\n- 时间 $j=3$: $r_{13}=70, n_{13}=35, d_{13}=4, d^{(1)}_{13}=3$。\n  - $O_{13}-E_{13} = 3 - 4 \\left(\\frac{35}{70}\\right) = 3 - 2 = 1$。\n  - $V_{13} = 4 \\left(\\frac{35}{70}\\right) \\left(\\frac{35}{70}\\right) \\left(\\frac{70-4}{70-1}\\right) = 4(0.5)(0.5)\\left(\\frac{66}{69}\\right) = 1 \\left(\\frac{22}{23}\\right) = \\frac{22}{23}$。\n\n**分层 $s=2$ (高分子风险)**\n- 时间 $j=1$: $r_{21}=60, n_{21}=20, d_{21}=6, d^{(1)}_{21}=1$。\n  - $O_{21}-E_{21} = 1 - 6 \\left(\\frac{20}{60}\\right) = 1 - 2 = -1$。\n  - $V_{21} = 6 \\left(\\frac{20}{60}\\right) \\left(\\frac{40}{60}\\right) \\left(\\frac{60-6}{60-1}\\right) = 6\\left(\\frac{1}{3}\\right)\\left(\\frac{2}{3}\\right)\\left(\\frac{54}{59}\\right) = \\frac{4}{3}\\left(\\frac{54}{59}\\right) = \\frac{72}{59}$。\n- 时间 $j=2$: $r_{22}=55, n_{22}=18, d_{22}=5, d^{(1)}_{22}=2$。\n  - $O_{22}-E_{22} = 2 - 5 \\left(\\frac{18}{55}\\right) = 2 - \\frac{18}{11} = \\frac{4}{11}$。\n  - $V_{22} = 5 \\left(\\frac{18}{55}\\right) \\left(\\frac{37}{55}\\right) \\left(\\frac{55-5}{55-1}\\right) = \\frac{18}{11} \\left(\\frac{37}{55}\\right) \\left(\\frac{50}{54}\\right) = \\frac{370}{363}$。\n- 时间 $j=3$: $r_{23}=50, n_{23}=16, d_{23}=7, d^{(1)}_{23}=3$。\n  - $O_{23}-E_{23} = 3 - 7 \\left(\\frac{16}{50}\\right) = 3 - 2.24 = 0.76 = \\frac{19}{25}$。\n  - $V_{23} = 7 \\left(\\frac{16}{50}\\right) \\left(\\frac{34}{50}\\right) \\left(\\frac{50-7}{50-1}\\right) = 2.24 \\left(\\frac{34}{50}\\right) \\left(\\frac{43}{49}\\right) = \\frac{5848}{4375}$。\n\n现在，我们将这些量相加以获得总得分 $U(0)$ 和总信息量 $I(0)$。\n\n$$U(0) = \\sum_{s,j} (O_{sj}-E_{sj}) = 1.5 + 0.48 + 1 - 1 + \\frac{4}{11} + 0.76$$\n$$U(0) = \\frac{3}{2} + \\frac{12}{25} + \\frac{4}{11} + \\frac{19}{25} = \\frac{3}{2} + \\frac{31}{25} + \\frac{4}{11} = \\frac{825 + 682 + 200}{550} = \\frac{1707}{550}$$\n$$U(0) \\approx 3.103636$$\n\n$$I(0) = \\sum_{s,j} V_{sj} = \\frac{375}{316} + \\frac{456}{625} + \\frac{22}{23} + \\frac{72}{59} + \\frac{370}{363} + \\frac{5848}{4375}$$\n数值上，\n$$I(0) \\approx 1.186709 + 0.729600 + 0.956522 + 1.220339 + 1.019284 + 1.336686 \\approx 6.449140$$\n\n最后，我们计算检验统计量 $Q$：\n$$Q = \\frac{U(0)^2}{I(0)} = \\frac{\\left(\\frac{1707}{550}\\right)^2}{6.449140} = \\frac{(3.103636...)^2}{6.449140...} \\approx \\frac{9.632559}{6.449140} \\approx 1.493633$$\n\n将最终答案四舍五入到四位有效数字，得到 $1.494$。", "answer": "$$\n\\boxed{1.494}\n$$", "id": "4610370"}, {"introduction": "一个预测模型的最终价值在于其预测新个体结局的能力。当存在竞争性事件时，这需要估计累积发生函数（Cumulative Incidence Function, CIF）。这项综合性编程练习 [@problem_id:4610316] 将引导您在分层模型设定下，计算特定原因的累积风险和CIF，从而将模型参数转化为有意义的、符合真实世界情况的事件发生概率。", "problem": "给定一个具有两种失败原因和右删失的竞争风险队列，在分层 Cox 比例风险框架下进行分析。有两个层，用标签 $A$ 和 $B$ 表示。在每个层内，基线风险是未指定的，并允许因层而异，而协变量效应被假定为在各层间是共同的，但因原因而异。假设是：(i) 独立的右删失，(ii) 每层内的比例风险作为事件时间数据一个经过充分检验的建模原则，以及 (iii) 将风险解释为强度的计数过程。对于一个标量协变量值为 $x$ 的受试者，在 $s$ 层中原因 $k$ 的特定原因风险建模为 $h_{k,s}(t \\mid x) = h_{0,k,s}(t) \\exp(x \\,\\beta_k)$，其中 $h_{0,k,s}(t)$ 是特定于层和原因的基线风险，$\\beta_k$ 是跨层共享的特定原因回归系数。一个受试者特定原因 $k$ 的累积特定原因风险是其风险的时间聚合。总体生存函数由所有原因的特定原因风险随时间的总和决定。原因 $k$ 的累积发生率函数必须通过将总体生存率与在观测到的事件时间点上特定原因风险的增量进行复合来获得。所有积分都将作为相关层中观察到的不同事件时间点的总和进行数值计算，基线风险增量将使用 Breslow 型方法从每个层观察到的数据中进行非参数估计：在给定层中原因 $k$ 的每个不同事件时间点，基线风险增量等于在该时间点观察到的原因 $k$ 事件数除以在该时间点该层中 $\\exp(x \\,\\beta_k)$ 的风险集总和。\n\n数据描述。每条记录是一个元组 $(\\text{stratum}, t, \\delta, x)$，其中 $\\text{stratum} \\in \\{A,B\\}$ 表示层，$t$ 是观察时间，$\\delta \\in \\{0,1,2\\}$ 是事件指示符，其中 $0$ 表示删失，$1$ 表示因原因 $1$ 失败，$2$ 表示因原因 $2$ 失败，$x$ 是一个标量协变量。数据如下：\n\n层 $A$：\n- $(A, 1.0, 1, -0.2)$\n- $(A, 2.0, 0, 0.5)$\n- $(A, 3.0, 2, 1.2)$\n- $(A, 4.0, 1, 0.0)$\n- $(A, 5.0, 0, -1.0)$\n- $(A, 6.5, 2, 0.7)$\n- $(A, 7.2, 1, 1.5)$\n- $(A, 7.8, 0, -0.4)$\n- $(A, 8.0, 2, 0.3)$\n- $(A, 9.0, 0, 0.9)$\n\n层 $B$：\n- $(B, 0.8, 2, -0.1)$\n- $(B, 1.5, 0, 0.2)$\n- $(B, 2.2, 1, -0.8)$\n- $(B, 3.0, 0, 1.1)$\n- $(B, 3.3, 1, 0.5)$\n- $(B, 4.1, 2, 1.0)$\n- $(B, 4.9, 0, -0.6)$\n- $(B, 5.2, 1, 0.4)$\n- $(B, 6.0, 2, -1.2)$\n- $(B, 6.5, 0, 0.0)$\n\n模型参数。特定原因回归系数为：\n- $\\beta_1 = 0.6$\n- $\\beta_2 = -0.4$\n\n计算任务。对于一个在 $s^\\star$ 层中协变量值为 $x^\\star$ 的受试者，仅使用 $s^\\star$ 层中观察到的事件时间来：\n- 如上所述，在那些事件时间点分别为每个原因估计基线风险增量。\n- 在比例风险结构下，聚合这些增量以计算截至给定时间 $t^\\star$ 的受试者特定的累积特定原因风险函数。\n- 从这些函数中，计算每一步的总体生存率，并复合特定原因风险增量，以获得在 $t^\\star$ 评估的每个原因的累积发生率函数。\n\n测试套件。您的程序必须按照此确切顺序，为每个测试用例 $(s^\\star, x^\\star, t^\\star)$ 计算四个值\n$[\\Lambda_1(t^\\star \\mid x^\\star, s^\\star),\\; \\Lambda_2(t^\\star \\mid x^\\star, s^\\star),\\; F_1(t^\\star \\mid x^\\star, s^\\star),\\; F_2(t^\\star \\mid x^\\star, s^\\star)]$，\n其中 $\\Lambda_k(\\cdot)$ 表示原因 $k$ 的累积特定原因风险，$F_k(\\cdot)$ 表示原因 $k$ 的累积发生率函数，它是通过在观察到的事件时间点上（直到 $t^\\star$）将生存率与特定原因风险增量复合而构建的。请使用以下测试用例：\n- $(A, x^\\star=0.0, t^\\star=4.0)$\n- $(A, x^\\star=1.0, t^\\star=7.0)$\n- $(B, x^\\star=-0.5, t^\\star=3.5)$\n- $(B, x^\\star=0.2, t^\\star=0.0)$\n\n最终输出格式。您的程序应生成一行输出，其中包含一个逗号分隔的列表，用方括号括起来，按给定顺序连接每个测试用例的四个值。也就是说，输出必须是\n$[\\Lambda_1^{(1)},\\Lambda_2^{(1)},F_1^{(1)},F_2^{(1)},\\Lambda_1^{(2)},\\Lambda_2^{(2)},F_1^{(2)},F_2^{(2)},\\Lambda_1^{(3)},\\Lambda_2^{(3)},F_1^{(3)},F_2^{(3)},\\Lambda_1^{(4)},\\Lambda_2^{(4)},F_1^{(4)},F_2^{(4)}]$，\n其中上标表示从 $1$ 到 $4$ 的测试用例索引。\n\n角度单位或物理单位不适用；就本问题而言，时间是无量纲的，所有数值输出必须是纯实数。", "solution": "该问题是有效的，因为它在科学上基于竞争风险分析中使用分层 Cox 比例风险模型的既定生物统计学框架。问题提法清晰，为获得唯一的数值解提供了所有必要的数据和参数。语言客观，要求的计算遵循了该领域的标准方法，即使用 Breslow 型估计量估计基线风险和使用 Aalen-Johansen 方法计算累积发生率函数。\n\n解决方案通过为每个测试用例执行指定的计算来进行。分析是分层的，这意味着对给定层中受试者的计算仅使用该层的数据。\n\n首先，我们定义模型的核心组成部分。对于协变量为 $x$ 的受试者，在层 $s \\in \\{A, B\\}$ 中原因 $k \\in \\{1, 2\\}$ 的特定原因风险由比例风险模型给出：\n$$h_{k,s}(t \\mid x) = h_{0,k,s}(t) \\exp(x \\beta_k)$$\n其中 $h_{0,k,s}(t)$ 是层 $s$ 中原因 $k$ 的未知基线风险，$\\beta_k$ 是与 $x$ 增加一个单位相关的特定原因对数风险比。问题提供了 $\\beta_1 = 0.6$ 和 $\\beta_2 = -0.4$。\n\n分析在离散时间中进行，步长对应于数据中观察到的不同事件时间。我们必须首先估计基线风险。问题指定了一个 Breslow 型估计量来估计累积基线风险的增量，$\\Delta H_{0,k,s}(t_j) = H_{0,k,s}(t_j) - H_{0,k,s}(t_j^-)$。在层 $s$ 的每个不同事件时间 $t_j$，此增量估计为：\n$$\\Delta \\hat{H}_{0,k,s}(t_j) = \\frac{d_{k,s,j}}{\\sum_{i \\in R_{s,j}} \\exp(x_i \\beta_k)}$$\n这里，$t_j$ 代表层 $s$ 中的第 $j$ 个不同事件时间。$d_{k,s,j}$ 是在时间 $t_j$ 在层 $s$ 中观察到的原因 $k$ 事件的数量。风险集 $R_{s,j}$ 由在时间 $t_j$ 仍然处于观察中的所有层 $s$ 的受试者组成（即，他们的事件或删失时间大于或等于 $t_j$）。请注意，只有在 $t_j$ 发生原因 $k$ 的事件时，$\\Delta \\hat{H}_{0,k,s}(t_j)$ 才不为零。\n\n对于一个在层 $s^\\star$ 中协变量值为 $x^\\star$ 的新受试者，其在时间 $t_j$ 的特定受试者原因 $k$ 累积风险增量从基线增量导出：\n$$\\Delta \\Lambda_k(t_j \\mid x^\\star, s^\\star) = \\Delta \\hat{H}_{0,k,s^\\star}(t_j) \\times \\exp(x^\\star \\beta_k)$$\n截至时间 $t^\\star$ 的原因 $k$ 的总累积特定原因风险是这些增量在所有截至 $t^\\star$ 的事件时间上的总和：\n$$\\Lambda_k(t^\\star \\mid x^\\star, s^\\star) = \\sum_{t_j \\le t^\\star} \\Delta \\Lambda_k(t_j \\mid x^\\star, s^\\star)$$\n\n该受试者的总体生存函数 $S(t \\mid x^\\star, s^\\star)$ 是到时间 $t$ 未经历任何事件的概率。它与累积特定原因风险的总和相关：\n$$S(t \\mid x^\\star, s^\\star) = \\exp\\left(-\\sum_{k=1}^{2} \\Lambda_k(t \\mid x^\\star, s^\\star)\\right)$$\n\n原因 $k$ 的累积发生率函数 (CIF) $F_k(t \\mid x^\\star, s^\\star)$ 给出了到时间 $t$ 因原因 $k$ 而失败的概率。它通过将在每个事件时间因原因 $k$ 失败的概率相加来计算，条件是在此之前一直存活。这是 Aalen-Johansen 估计量。在事件时间 $t_j$ 的 CIF 增量是紧接在 $t_j$ 之前的生存概率与在 $t_j$ 的特定受试者原因 $k$ 风险增量的乘积。总 CIF 是这些增量的总和：\n$$F_k(t^\\star \\mid x^\\star, s^\\star) = \\sum_{t_j \\le t^\\star} S(t_{j-1} \\mid x^\\star, s^\\star) \\times \\Delta \\Lambda_k(t_j \\mid x^\\star, s^\\star)$$\n其中 $t_0=0$ 且 $S(0 \\mid x^\\star, s^\\star) = 1$。\n\n每个测试用例 $(s^\\star, x^\\star, t^\\star)$ 的计算过程如下：\n1.  筛选数据集，仅包括来自 $s^\\star$ 层的记录。按时间对这些记录进行排序。\n2.  识别该层中小于或等于 $t^\\star$ 的唯一事件时间 $t_j$。\n3.  在时间 $t=0$ 初始化各量：$\\Lambda_1=0$, $\\Lambda_2=0$, $F_1=0$, $F_2=0$，以及第一个事件之前的生存概率 $S_{prev} = 1$。\n4.  对于每个唯一的事件时间 $t_j$，按升序：\n    a.  识别风险集 $R_{s^\\star, j}$。\n    b.  计算分母 $\\sum_{i \\in R_{s^\\star, j}} \\exp(x_i \\beta_1)$ 和 $\\sum_{i \\in R_{s^\\star, j}} \\exp(x_i \\beta_2)$。\n    c.  计算在时间 $t_j$ 原因 1 ($d_{1,j}$) 和原因 2 ($d_{2,j}$) 的事件数。\n    d.  计算基线风险增量 $\\Delta \\hat{H}_{0,1,s^\\star}(t_j)$ 和 $\\Delta \\hat{H}_{0,2,s^\\star}(t_j)$。\n    e.  使用 $\\exp(x^\\star \\beta_k)$ 计算特定受试者的风险增量 $\\Delta \\Lambda_1(t_j)$ 和 $\\Delta \\Lambda_2(t_j)$。\n    f.  更新 CIF：$F_k \\leftarrow F_k + S_{prev} \\times \\Delta \\Lambda_k(t_j)$。\n    g.  更新累积风险：$\\Lambda_k \\leftarrow \\Lambda_k + \\Delta \\Lambda_k(t_j)$。\n    h.  为下一步更新生存概率：$S_{prev} = \\exp(-(\\Lambda_1 + \\Lambda_2))$。\n5.  $\\Lambda_1, \\Lambda_2, F_1, F_2$ 的最终值是该测试用例的结果。对于 $t^\\star = 0$ 的测试用例，所有结果均为 $0$。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the competing risks problem for all test cases.\n    \"\"\"\n    \n    # Each record is a tuple (stratum, t, delta, x)\n    data_A = [\n        ('A', 1.0, 1, -0.2), ('A', 2.0, 0, 0.5), ('A', 3.0, 2, 1.2),\n        ('A', 4.0, 1, 0.0), ('A', 5.0, 0, -1.0), ('A', 6.5, 2, 0.7),\n        ('A', 7.2, 1, 1.5), ('A', 7.8, 0, -0.4), ('A', 8.0, 2, 0.3),\n        ('A', 9.0, 0, 0.9)\n    ]\n    data_B = [\n        ('B', 0.8, 2, -0.1), ('B', 1.5, 0, 0.2), ('B', 2.2, 1, -0.8),\n        ('B', 3.0, 0, 1.1), ('B', 3.3, 1, 0.5), ('B', 4.1, 2, 1.0),\n        ('B', 4.9, 0, -0.6), ('B', 5.2, 1, 0.4), ('B', 6.0, 2, -1.2),\n        ('B', 6.5, 0, 0.0)\n    ]\n    \n    data = {'A': data_A, 'B': data_B}\n    \n    # Cause-specific regression coefficients\n    betas = {1: 0.6, 2: -0.4}\n    \n    # Test suite\n    test_cases = [\n        ('A', 0.0, 4.0),\n        ('A', 1.0, 7.0),\n        ('B', -0.5, 3.5),\n        ('B', 0.2, 0.0)\n    ]\n\n    all_results = []\n    for s_star, x_star, t_star in test_cases:\n        results = calculate_estimates(s_star, x_star, t_star, data, betas)\n        all_results.extend(results)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, all_results))}]\")\n\ndef calculate_estimates(s_star, x_star, t_star, all_data, betas):\n    \"\"\"\n    Calculates cumulative hazards and cumulative incidence functions for a single subject.\n\n    Args:\n        s_star (str): Stratum of the subject.\n        x_star (float): Covariate value of the subject.\n        t_star (float): Time point at which to evaluate the functions.\n        all_data (dict): Dictionary containing the full dataset, keyed by stratum.\n        betas (dict): Dictionary of cause-specific regression coefficients.\n\n    Returns:\n        list: A list of four floats: [Lambda1, Lambda2, F1, F2].\n    \"\"\"\n    if t_star == 0.0:\n        return [0.0, 0.0, 0.0, 0.0]\n\n    # 1. Filter data for the stratum and sort by time\n    stratum_data = sorted(all_data[s_star], key=lambda item: item[1])\n\n    # 2. Identify distinct event times up to t_star\n    event_times = sorted(list(set(\n        d[1] for d in stratum_data if d[2] in [1, 2] and d[1] = t_star\n    )))\n\n    # 3. Initialize outcome variables\n    lambda1, lambda2 = 0.0, 0.0\n    f1, f2 = 0.0, 0.0\n    surv_prev = 1.0\n\n    # 4. Iterate through distinct event times\n    for t_j in event_times:\n        # a. Determine risk set at time t_j\n        risk_set = [d for d in stratum_data if d[1] = t_j]\n        risk_set_x = np.array([d[3] for d in risk_set])\n\n        # b. Calculate risk-set sums (denominators)\n        w1 = np.sum(np.exp(risk_set_x * betas[1]))\n        w2 = np.sum(np.exp(risk_set_x * betas[2]))\n\n        # c. Count events of each cause at t_j\n        events_at_tj = [d for d in stratum_data if d[1] == t_j and d[2] in [1, 2]]\n        d1_j = sum(1 for d in events_at_tj if d[2] == 1)\n        d2_j = sum(1 for d in events_at_tj if d[2] == 2)\n\n        # d. Calculate baseline hazard increments\n        delta_h01 = d1_j / w1 if w1  0 else 0.0\n        delta_h02 = d2_j / w2 if w2  0 else 0.0\n\n        # e. Calculate subject-specific hazard increments\n        delta_lambda1 = delta_h01 * np.exp(x_star * betas[1])\n        delta_lambda2 = delta_h02 * np.exp(x_star * betas[2])\n\n        # f. Update Cumulative Incidence Functions (CIFs)\n        # CIF increment is S(t_j-)*dLambda_k(t_j)\n        f1 += surv_prev * delta_lambda1\n        f2 += surv_prev * delta_lambda2\n\n        # g. Update cumulative hazards\n        lambda1 += delta_lambda1\n        lambda2 += delta_lambda2\n\n        # h. Update overall survival for the start of the next interval\n        surv_prev = np.exp(-(lambda1 + lambda2))\n\n    return [lambda1, lambda2, f1, f2]\n\nsolve()\n```", "id": "4610316"}]}