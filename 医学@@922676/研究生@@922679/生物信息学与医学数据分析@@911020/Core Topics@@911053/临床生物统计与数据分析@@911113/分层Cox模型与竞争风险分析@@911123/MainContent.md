## 引言
在生物医学数据分析中，时间-事件数据是评估预后和治疗效果的核心。标准的Cox比例风险模型是这一领域的基石，但其应用常受到两大挑战的限制。首先，当研究数据来自不同中心或包含具有内在异质性的亚组时，其核心的[比例风险假设](@entry_id:163597)往往不成立。其次，当患者可能经历多种相互竞争的结局事件时（如癌症复发与治疗相关死亡），简单的生存分析方法会产生误导性结论。本文旨在系统性地解决这两个难题，为研究者提供一套严谨的分析框架。

本文将分为三个部分，引导您逐步掌握高级生存分析技术。在“原理与机制”一章中，我们将深入剖析分层Cox模型如何应对非[比例风险](@entry_id:166780)，并详细辨析[竞争风险分析](@entry_id:634319)中两种核心方法——因果特定风险(CSH)与子分布风险(SDH)模型的理论基础与适用场景。接着，在“应用与跨学科连接”一章中，我们将通过临床试验、肿瘤学和高维组学等领域的真实案例，展示这些模型如何解决实际研究问题，并与其他学科（如机器学习）产生交叉。最后，“动手实践”部分将提供具体的计算和编程练习，帮助您将理论知识转化为可操作的数据分析技能。

## 原理与机制

在生存分析领域，[Cox比例风险模型](@entry_id:174252)是评估协变量与事件发生时间之间关系的核心工具。然而，在处理来自多中心研究或存在显著异质性亚组的数据时，标准的[Cox模型](@entry_id:164053)可能面临其核心假设——[比例风险](@entry_id:166780)(Proportional Hazards, PH)假设——被违背的挑战。此外，当研究结局包含多种相互排斥的事件类型时，我们必须进入竞争风险(Competing Risks)分析的领域，这需要更细致的模型设定和结果解读。本章将深入探讨分层[Cox模型](@entry_id:164053)(Stratified Cox Models)的原理，并阐述在竞争风险框架下，如何运用因果特定风险(Cause-Specific Hazards)和子分布风险(Subdistribution Hazards)这两种关键方法来应对不同的科学问题。

### 分层Cox比例风险模型

在许多临床研究中，数据来自不同的中心（如医院或实验室），或者可以根据某些基线临床特征（如疾病分期）将患者分为几个明确的组。这些分组变量本身可能与生存结局强烈相关，并且它们对风险的影响可能会随时间变化，从而违背了标准的[比例风险假设](@entry_id:163597)。例如，一个中心的术后早期风险可能很高，但长期风险较低，而另一个中心可能正好相反。将中心作为一个普通的协变量纳入Cox模型会强制其效应（即风险比）在整个研究期间保持不变，这与实际情况不符，可能导致模型误设并扭曲对其他协变量效应的估计 [@problem_id:4610342]。

**分层(Stratification)** 提供了一种优雅的解决方案。其核心思想是允许不同亚组（即**层, strata**）拥有各自独有的基线风险函数，同时假设我们感兴趣的协变量效应在所有层之间是恒定的。分层Cox模型的数学表达式为：

$h(t | \mathbf{X}, S=s) = h_{0s}(t) \exp(\boldsymbol{\beta}^{\top}\mathbf{X})$

在此模型中：
- $s$ 代表某个特定的层，例如第 $s$ 个医院。
- $h(t | \mathbf{X}, S=s)$ 是在第 $s$ 层中，具有协变量向量 $\mathbf{X}$ 的个体在时间 $t$ 的风险函数。
- $h_{0s}(t)$ 是第 $s$ 层特有的**基线[风险函数](@entry_id:166593)(stratum-specific baseline hazard function)**。它是一个关于时间的任意非负函数，完全不加限定，允许每个层有其独特的风险模式。
- $\boldsymbol{\beta}$ 是我们关心的对数风险比向量，它被假定在所有层中是**共同的(common)**。$\exp(\beta_j)$ 则是在任意一个层内，协变量 $X_j$ 每增加一个单位，瞬时风险改变的乘数因子 [@problem_id:4610313]。

#### [参数估计](@entry_id:139349)：分层[偏似然](@entry_id:165240)

分层Cox模型最巧妙之处在于其[参数估计](@entry_id:139349)方法。尽管每个层的基线[风险函数](@entry_id:166593) $h_{0s}(t)$ 都是未知的，并且可能千差万别，我们仍然可以一致地估计出共同的 $\boldsymbol{\beta}$。这是通过**分层[偏似然](@entry_id:165240)(stratified partial likelihood)** 实现的。

其原理是，在构建似然函数时，所有的风险比较都严格限制在**层内部**进行。具体来说，当在时间 $t_{(j)}$ 观察到一个事件时，假设该事件发生在第 $s_j$ 层的个体 $i_j$ 身上。我们只考虑在那个时刻，同样处于第 $s_j$ 层且尚未发生事件的个体组成的**风险集(risk set)**, 记为 $R_{s_j}(t_{(j)})$。该事件对[偏似然](@entry_id:165240)的贡献是，在给定第 $s_j$ 层的风险集中发生了一个事件的条件下，这个事件恰好发生在个体 $i_j$ 身上的[条件概率](@entry_id:151013)：

$L_j(\boldsymbol{\beta}) = \frac{h(t_{(j)} | \mathbf{X}_{i_j}, S=s_j)}{\sum_{l \in R_{s_j}(t_{(j)})} h(t_{(j)} | \mathbf{X}_l, S=s_j)} = \frac{h_{0,s_j}(t_{(j)}) \exp(\boldsymbol{\beta}^{\top}\mathbf{X}_{i_j})}{\sum_{l \in R_{s_j}(t_{(j)})} h_{0,s_j}(t_{(j)}) \exp(\boldsymbol{\beta}^{\top}\mathbf{X}_l)} = \frac{\exp(\boldsymbol{\beta}^{\top}\mathbf{X}_{i_j})}{\sum_{l \in R_{s_j}(t_{(j)})} \exp(\boldsymbol{\beta}^{\top}\mathbf{X}_l)}$

在这个概率表达式中，层特异的基线风险 $h_{0,s_j}(t_{(j)})$ 在分子和分母中被约掉了。这意味着，关于 $\boldsymbol{\beta}$ 的信息完全来自于层内部个体间的风险比较，而与基线风险的具体形式无关。因此，即使基线风险任意变化，我们也能识别和估计出 $\boldsymbol{\beta}$ [@problem_id:4610371]。总的偏[似然函数](@entry_id:141927)就是所有事件贡献的乘积。需要注意的是，如果某个层没有任何事件发生，那么该层对 $\boldsymbol{\beta}$ 的估计将不提供任何信息 [@problem_id:4610371]。

让我们通过一个具体的例子来理解这个过程 [@problem_id:4610388]。假设一项研究按性别分层，分析一个二元基因标记 $z \in \{0,1\}$ 对疾病进展风险的影响。数据如下：
- 女性层: $(z=1, t=4, \text{进展})$, $(z=0, t=6, \text{其他原因死亡})$, $(z=1, t=10, \text{删失})$, $(z=0, t=5, \text{进展})$
- 男性层: $(z=1, t=3, \text{进展})$, $(z=0, t=8, \text{其他原因死亡})$, $(z=1, t=7, \text{删失})$

在对进展风险的因果特定分析中，其他原因死亡和删失都作为删失事件处理。
1.  **男性层**: 唯一进展事件发生在 $t=3$，事件者 $z=1$。此刻，男性层风险集包括3名成员: $(z=1, t=3)$, $(z=0, t=8)$, $(z=1, t=7)$。因此，[偏似然](@entry_id:165240)贡献为：$\frac{\exp(\beta \cdot 1)}{\exp(\beta \cdot 1) + \exp(\beta \cdot 0) + \exp(\beta \cdot 1)} = \frac{\exp(\beta)}{2\exp(\beta) + 1}$。
2.  **女性层**: 有两个进展事件。
    - 在 $t=4$，事件者 $z=1$。此刻，女性层风险集包括4名成员: $(z=1, t=4)$, $(z=0, t=6)$, $(z=1, t=10)$, $(z=0, t=5)$。[偏似然](@entry_id:165240)贡献为：$\frac{\exp(\beta \cdot 1)}{\exp(\beta \cdot 1) + \exp(\beta \cdot 0) + \exp(\beta \cdot 1) + \exp(\beta \cdot 0)} = \frac{\exp(\beta)}{2\exp(\beta) + 2}$。
    - 在 $t=5$，事件者 $z=0$。此刻，之前在$t=4$发生事件的个体已移出风险集。风险集包括3名成员: $(z=0, t=6)$, $(z=1, t=10)$, $(z=0, t=5)$。[偏似然](@entry_id:165240)贡献为：$\frac{\exp(\beta \cdot 0)}{\exp(\beta \cdot 0) + \exp(\beta \cdot 1) + \exp(\beta \cdot 0)} = \frac{1}{\exp(\beta) + 2}$。

总的偏似然函数 $L(\beta)$ 是这三项的乘积。这个计算过程清晰地显示了风险比较是如何严格限制在每层内部的。

### [竞争风险](@entry_id:173277)的挑战

当研究结局不止一种时，我们就进入了竞争风险的领域。例如，在肿瘤学中，患者可能因癌症复发而失败，也可能因与癌症无关的原因（如心脏病）死亡。这两种事件是相互竞争的：一旦发生其中一种，另一种就不可能再被观察到。在这种设定下，我们需要精确定义我们想要测量的风险。

#### 核心概念：因果特定风险与累积发生率

在[竞争风险](@entry_id:173277)框架下，有两个核心的度量指标：

1.  **因果特定风险函数 (Cause-Specific Hazard, CSH)**: 对于第 $k$ 类事件，其CSH记为 $h_k(t)$，定义为在时间 $t$ 仍未发生任何事件的个体，在下一瞬间发生第 $k$ 类事件的[瞬时速率](@entry_id:182981)。
    $h_k(t) = \lim_{\Delta t \to 0} \frac{P(t \le T  t+\Delta t, \text{事件类型}=k \mid T \ge t)}{\Delta t}$
    CSH衡量的是事件的**瞬时生物学或机械速率**，是回答**病因学(etiologic)**问题的理想指标，例如“某个[基因突变](@entry_id:166469)是否直接增加了癌症复发的速率？”。

2.  **累积发生率函数 (Cumulative Incidence Function, CIF)**: 对于第 $k$ 类事件，其CIF记为 $F_k(t)$，定义为到时间 $t$ 为止，发生第 $k$ 类事件的累积概率。
    $F_k(t) = P(T \le t, \text{事件类型}=k)$
    CIF衡量的是事件的**净累积概率**，是回答**预后(prognostic)**问题的理想指标，例如“对于接受某种治疗的患者，五年内因癌症复发的概率是多少？”。

这两者之间存在一个至关重要的关系。$F_k(t)$ 并非简单地由 $h_k(t)$ 积分得到。实际上，它还依赖于所有其他竞争事件的风险。其精确关系为：

$F_k(t) = \int_0^t S(u) h_k(u) du$

其中 $S(u) = P(Tu)$ 是**总生存函数(overall survival function)**，即到时间 $u$ 为止未发生任何类型事件的概率。$S(u)$ 本身取决于所有原因的总风险：$S(u) = \exp(-\int_0^u \sum_j h_j(v) dv)$。这个公式表明，第 $k$ 类事件的累积发生率不仅取决于其自身的瞬时风险 $h_k(u)$，还取决于个体能“存活”下来（即不发生任何其他竞争事件）以至于有机会经历第 $k$ 类事件的概率 $S(u)$ [@problem_id:4610381]。

一个常见的误区是认为 $F_k(t)$ 等于 $1-S(t)$。这是错误的。$1-S(t)$ 是到时间 $t$ 为止发生**任何类型**事件的总概率。由于不同类型的事件是[互斥](@entry_id:752349)的，这个总概率等于所有因果特定累积发生率之和 [@problem_id:4610381]：

$1 - S(t) = \sum_{j=1}^K F_j(t)$

因此，只要存在多于一种的事件类型（即 $K  1$），对于任何单一事件 $k$，$F_k(t)$ 必定小于 $1-S(t)$。例如，在一个包含两种失败原因（1和2）的研究中，$1-S(t) = F_1(t) + F_2(t)$。我们可以通过一个简单的数值例子来固化这个概念 [@problem_id:4610315]。假设在某个人群中，原因1的恒定风险为 $\lambda_1=0.1$，原因2的恒定风险为 $\lambda_2=0.2$。总风险为 $\lambda = 0.3$。在时间 $t=2$ 时：
- 总生存率 $S(2) = \exp(-0.3 \times 2) \approx 0.549$。
- 任何事件的发生率 $1-S(2) \approx 0.451$。
- 原因1的累积发生率 $F_1(2) = \int_0^2 \lambda_1 S(u) du = \frac{\lambda_1}{\lambda}(1-S(2)) = \frac{0.1}{0.3}(0.451) \approx 0.150$。
- 原因2的累积发生率 $F_2(2) = \frac{\lambda_2}{\lambda}(1-S(2)) = \frac{0.2}{0.3}(0.451) \approx 0.301$。
显然，$F_1(2) \approx 0.150$，远小于 $1-S(2) \approx 0.451$。实际上，我们看到 $F_1(2) + F_2(2) \approx 0.150 + 0.301 = 0.451 = 1-S(2)$。

### 竞争风险的建模策略

理解了CSH和CIF的区别后，我们便可以根据具体的科学问题选择合适的建模策略。主要有两种方法，分别针对这两个不同的目标。

#### 策略一：因果特定风险模型（用于病因学推断）

如果研究目标是理解协变量如何影响事件发生的[瞬时速率](@entry_id:182981)（即病因学机制），我们应该对**因果特定风险(CSH)** 进行建模。这通常通过为我们感兴趣的特定事件（如原因 $k=1$）拟合一个标准的（分层）[Cox模型](@entry_id:164053)来实现 [@problem_id:4610369]。

- **机制**：在估计原因1的CSH时，所有其他原因的事件（$k=2, 3, \dots$）以及常规的右删失都被同等对待，即作为**删失事件**处理。这个处理方法的正当性依赖于一个关键假设：**非信息性删失(non-informative censoring)**。这意味着，在给定协变量的条件下，一个删失事件（无论是常规删失还是竞争事件）的发生不提供关于未来原因1事件风险的额外信息 [@problem_id:4610338] [@problem_id:4610369]。

- **解读**：模型估计出的系数 $\boldsymbol{\beta}$ 反映了协变量对CSH的直接、[乘性](@entry_id:187940)效应。$\exp(\beta_j)$ 是**因果特定风险比(cause-specific hazard ratio)**，它回答了诸如“基因标记$X_j$每增加一个单位，患者复发的瞬时速率会增加多少倍？”这类问题 [@problem_id:4610313]。

- **局限**：这种模型的解释必须非常严谨。$\boldsymbol{\beta}$ 描述的是对瞬时风险的影响，但它**不能**直接等同于对累积发生率CIF的影响。一个协变量可能强烈增加原因1的CSH（$\beta_1  0$），但如果它更强烈地增加了某个竞争原因2的CSH（$\beta_2 \gg \beta_1  0$），导致大量患者因原因2而提前退出风险集，那么该协变量对原因1的CIF的净效应可能是降低的。因此，CSH模型的结果主要用于病因学解释，而非直接预测累积风险 [@problem_id:4610338]。

#### 策略二：子分布风险模型（用于预后预测）

如果研究目标是评估协变量对事件累积发生概率的影响（即预后预测），我们则需要直接对**累积发生率函数(CIF)** 进行建模。这通过引入**子分布风险函数(Subdistribution Hazard, SDH)** 的概念来实现，最著名的模型是**Fine-Gray模型**。

- **机制**：SDH的核心创新在于其对**风险集**的重新定义。对于我们感兴趣的原因 $k=1$，其在时间 $t$ 的子分布风险 $h_1^*(t)$ 的风险集不仅包括在时间 $t$ 仍然“存活”（即未发生任何事件）的个体，还**包括**那些在时间 $t$ 之前已经发生了**竞争事件**（$k \neq 1$）的个体 [@problem_id:4610332]。
    $h_k^*(t) = \lim_{\Delta t \to 0} \frac{P(t \le T  t+\Delta t, \text{事件类型}=k \mid T \ge t \text{ 或 } (T  t, \text{事件类型} \neq k))}{\Delta t}$
    这个特殊的风险集构造使得SDH与CIF之间存在直接的简单关系：$F_k(t) = 1 - \exp(-\int_0^t h_k^*(u)du)$。

- **Fine-Gray模型**正是对SDH建立的一个[比例风险模型](@entry_id:171806)：$h_k^*(t | \mathbf{X}) = h_{0k}^*(t) \exp(\boldsymbol{\gamma}^{\top}\mathbf{X})$。通过对SDH建模，我们实际上直接[参数化](@entry_id:265163)了CIF [@problem_id:4610369]。

- **解读**：模型估计出的系数 $\boldsymbol{\gamma}$ 反映了协变量对CIF的直接影响。$\exp(\gamma_j)$ 是**子分布风险比(subdistribution hazard ratio, SHR)**。如果 SHR 大于1，意味着协变量值的增加会导致该事件的累积发生率在整个时间轴上更高。它直接回答了诸如“携带某个基因标记的患者，其五年内复发的累积概率是未携带者的多少？”这类预后问题 [@problem_id:4610378]。值得注意的是，恒定的SHR并不意味着CIF的比值也是恒定的；CIF的比值通常会随时间变化 [@problem_id:4610378]。

- **估计中的挑战**：由于在SDH的风险集中需要保留那些已经发生竞争事件的个体，标准的右删失会带来复杂性。如果一个个体在时间 $t_c$ 被删失，我们无法知道他/她是否本应在 $t_c$ 之后发生一个竞争事件并继续留在SDH风险集中。Fine-Gray模型通过**逆概率删失加权(Inverse Probability of Censoring Weighting, IPCW)** 来巧妙地解决这个问题。在估计过程中，那些经历了竞争事件的个体会被赋予一个随时间变化的权重，以补偿那些因删失而“丢失”的、本应有类似经历的个体的信息 [@problem_id:4610332]。

### 总结：选择正确的工具

综上所述，分层[Cox模型](@entry_id:164053)为处理非[比例风险](@entry_id:166780)的分组变量提供了强大工具。当面临[竞争风险](@entry_id:173277)时，分析策略的选择完全取决于研究者试图回答的科学问题：

-   若要探索**病因学机制**，即协变量如何影响事件的瞬时发生率，应使用**因果特定风险模型**。此时，将竞争事件视为删失，估计出的系数反映的是对生物学速率的直接影响。

-   若要进行**预后预测**，即协变量如何影响事件的最终累积概率，应使用**子分布风险模型（如Fine-Gray模型）**。该模型通过修改风险集定义来直接对累积发生率建模，其系数反映的是对净发生概率的综合影响。

这两种模型的系数（$\boldsymbol{\beta}$ 和 $\boldsymbol{\gamma}$）估计的是不同的量，具有不同的解释，并且通常在数值上不相等。为一个特定研究问题选择错误的模型，可能会导致对风险的根本性误解。因此，清晰地界定分析目标是进行严谨、可信的[竞争风险分析](@entry_id:634319)的首要步骤。