{"hands_on_practices": [{"introduction": "理论是实践的基石。为了深刻理解ROC曲线和AUC，我们首先从一个经典的参数模型入手。本练习将指导你推导当正负两类样本的得分均服从正态分布时的ROC曲线方程，并计算出AUC的闭合解析表达式。通过这个过程，你将亲身体会分类器得分分布的参数（如均值和方差）如何直接决定其区分能力，并将AUC这一宏观指标与分布的统计特性联系起来。[@problem_id:3167105]", "problem": "一个二元分类器根据输入特征 $X$ 生成一个实值分数 $S$，用于区分类别 $Y \\in \\{0,1\\}$。假设以类别标签为条件的分数分布是方差相等的高斯分布：$S \\mid Y=1 \\sim \\mathcal{N}(\\mu_{1}, \\sigma^{2})$ 和 $S \\mid Y=0 \\sim \\mathcal{N}(\\mu_{0}, \\sigma^{2})$，其中 $\\mu_{1}, \\mu_{0} \\in \\mathbb{R}$ 且 $\\sigma > 0$。考虑阈值规则，即当且仅当分数 $S \\ge t$ 时预测 $Y=1$，其中 $t \\in \\mathbb{R}$ 是一个阈值。\n\n仅使用真正率 (TPR)、假正率 (FPR)、受试者工作特征 (ROC) 曲线和曲线下面积 (AUC) 的基本定义，完成以下任务：\n- 推导受试者工作特征 (ROC) 曲线的参数形式，即将真正率表示为由阈值 $t$ 引起的假正率的函数。\n- 然后，推导该模型的曲线下面积 (AUC) 的闭式解析表达式，将其表示为 $\\mu_{1}$、$\\mu_{0}$ 和 $\\sigma$ 的函数。\n\n为清楚起见，受试者工作特征 (ROC) 曲线是当阈值 $t$ 变化时，真正率 (TPR) 对假正率 (FPR) 的图，而曲线下面积 (AUC) 是该曲线下的面积。将最终答案表示为 AUC 的单个闭式解析表达式。无需四舍五入。", "solution": "用户要求对该问题进行详细推导。我将遵循我在思考过程中概述的计划。\n\n**1. 问题验证**\n\n问题陈述验证如下：\n\n*   **第 1 步：提取已知条件**\n    *   分类器：二元，类别为 $Y \\in \\{0, 1\\}$。\n    *   分数：实值分数 $S$。\n    *   条件分布：$S \\mid Y=1 \\sim \\mathcal{N}(\\mu_{1}, \\sigma^{2})$ 和 $S \\mid Y=0 \\sim \\mathcal{N}(\\mu_{0}, \\sigma^{2})$。\n    *   参数：$\\mu_{1}, \\mu_{0} \\in \\mathbb{R}$ 且 $\\sigma > 0$。\n    *   决策规则：当且仅当 $S \\geq t$ 时预测 $Y=1$，其中 $t \\in \\mathbb{R}$ 是一个阈值。\n    *   定义：真正率 (TPR)、假正率 (FPR)、受试者工作特征 (ROC) 曲线、曲线下面积 (AUC)。\n    *   任务：\n        1. 推导 ROC 曲线的参数形式（将 TPR 表示为 FPR 的函数）。\n        2. 推导 AUC 的闭式解析表达式，将其表示为 $\\mu_{1}$、$\\mu_{0}$ 和 $\\sigma$ 的函数。\n\n*   **第 2 步：使用提取的已知条件进行验证**\n    *   该问题具有科学依据，植根于标准的统计决策理论和机器学习原理。使用高斯分布作为类别条件分数是一种常见且易于理解的模型（例如，线性判别分析的基础）。\n    *   该问题是适定 (well-posed) 的。所有必要信息均已提供，术语是标准且明确定义的，并且存在一个唯一的、有意义的解。\n    *   该问题是客观的，使用了精确的数学语言，没有主观或模糊的陈述。\n    *   该问题没有说明中列出的任何无效性缺陷。它是其领域内一个标准的、可解决的问题。\n\n*   **第 3 步：结论与行动**\n    *   问题有效。将继续进行求解过程。\n\n**2. 解题推导**\n\n求解需要两个部分：首先，推导 ROC 曲线方程，其次，计算其下面积 (AUC)。\n\n令 $\\Phi(z)$ 为标准正态分布 $\\mathcal{N}(0, 1)$ 的累积分布函数 (CDF)，定义为 $\\Phi(z) = \\int_{-\\infty}^{z} \\frac{1}{\\sqrt{2\\pi}} \\exp\\left(-\\frac{u^2}{2}\\right) du$。\n\n**第 1 部分：ROC 曲线的推导**\n\nROC 曲线是当决策阈值 $t$ 变化时，真正率 (TPR) 对假正率 (FPR) 的图。\n\n真正率 $\\text{TPR}(t)$ 是正确分类一个正例 ($Y=1$) 的概率。分类规则是 $S \\ge t$。\n$$\n\\text{TPR}(t) = P(S \\ge t \\mid Y=1)\n$$\n给定 $S \\mid Y=1 \\sim \\mathcal{N}(\\mu_{1}, \\sigma^{2})$，我们可以对随机变量 $S$ 进行标准化：\n$$\n\\text{TPR}(t) = P\\left(\\frac{S-\\mu_1}{\\sigma} \\ge \\frac{t-\\mu_1}{\\sigma} \\mid Y=1\\right)\n$$\n$\\frac{S-\\mu_1}{\\sigma}$ 项是一个标准正态随机变量。我们称之为 $Z$。\n$$\n\\text{TPR}(t) = P\\left(Z \\ge \\frac{t-\\mu_1}{\\sigma}\\right) = 1 - P\\left(Z  \\frac{t-\\mu_1}{\\sigma}\\right) = 1 - \\Phi\\left(\\frac{t-\\mu_1}{\\sigma}\\right)\n$$\n使用标准正态分布的对称性属性 $1 - \\Phi(z) = \\Phi(-z)$，我们得到：\n$$\n\\text{TPR}(t) = \\Phi\\left(-\\frac{t-\\mu_1}{\\sigma}\\right) = \\Phi\\left(\\frac{\\mu_1-t}{\\sigma}\\right)\n$$\n\n假正率 $\\text{FPR}(t)$ 是将一个负例 ($Y=0$) 错误分类为正例的概率。\n$$\n\\text{FPR}(t) = P(S \\ge t \\mid Y=0)\n$$\n给定 $S \\mid Y=0 \\sim \\mathcal{N}(\\mu_{0}, \\sigma^{2})$，我们类似地进行标准化：\n$$\n\\text{FPR}(t) = P\\left(\\frac{S-\\mu_0}{\\sigma} \\ge \\frac{t-\\mu_0}{\\sigma} \\mid Y=0\\right)\n$$\n$$\n\\text{FPR}(t) = P\\left(Z \\ge \\frac{t-\\mu_0}{\\sigma}\\right) = 1 - \\Phi\\left(\\frac{t-\\mu_0}{\\sigma}\\right) = \\Phi\\left(\\frac{\\mu_0-t}{\\sigma}\\right)\n$$\n\n为了找到 ROC 曲线，我们必须将 TPR 表示为 FPR 的函数。令 $y = \\text{TPR}$ 且 $x = \\text{FPR}$。\n我们有参数方程：\n$y(t) = \\Phi\\left(\\frac{\\mu_1-t}{\\sigma}\\right)$\n$x(t) = \\Phi\\left(\\frac{\\mu_0-t}{\\sigma}\\right)$\n\n从 $x$ 的方程中，我们可以使用标准正态分布的反累积分布函数 $\\Phi^{-1}$（probit 函数）将 $t$ 表示为 $x$ 的函数。\n$$\n\\Phi^{-1}(x) = \\frac{\\mu_0-t}{\\sigma}\n$$\n解出 $t$：\n$$\n\\sigma \\Phi^{-1}(x) = \\mu_0-t \\implies t = \\mu_0 - \\sigma \\Phi^{-1}(x)\n$$\n现在，将这个关于 $t$ 的表达式代入 $y$ 的方程中：\n$$\ny = \\Phi\\left(\\frac{\\mu_1 - (\\mu_0 - \\sigma \\Phi^{-1}(x))}{\\sigma}\\right)\n$$\n$$\ny = \\Phi\\left(\\frac{\\mu_1 - \\mu_0 + \\sigma \\Phi^{-1}(x)}{\\sigma}\\right)\n$$\n$$\ny = \\Phi\\left(\\frac{\\mu_1 - \\mu_0}{\\sigma} + \\Phi^{-1}(x)\\right)\n$$\n因此，ROC 曲线的参数形式为：\n$$\n\\text{TPR} = \\Phi\\left(\\frac{\\mu_1 - \\mu_0}{\\sigma} + \\Phi^{-1}(\\text{FPR})\\right)\n$$\n\n**第 2 部分：曲线下面积 (AUC) 的推导**\n\nAUC 是 ROC 函数从 $\\text{FPR}=0$到 $\\text{FPR}=1$ 的积分。\n$$\n\\text{AUC} = \\int_{0}^{1} \\text{TPR}(\\text{FPR}) \\, d(\\text{FPR})\n$$\n虽然可以直接计算这个积分，但一个更具洞察力的方法是使用 AUC 的概率解释。AUC 等价于从正例中随机抽取的样本得分高于从负例中随机抽取的样本得分的概率。令 $S_1$ 为来自正例 ($Y=1$) 的随机得分，$S_0$ 为来自负例 ($Y=0$) 的随机得分。那么：\n$$\n\\text{AUC} = P(S_1  S_0)\n$$\n这里，$S_1 \\sim \\mathcal{N}(\\mu_{1}, \\sigma^{2})$ 和 $S_0 \\sim \\mathcal{N}(\\mu_{0}, \\sigma^{2})$，并且它们是独立的。\n我们感兴趣的是概率 $P(S_1 - S_0  0)$。\n我们定义一个新的随机变量 $D = S_1 - S_0$。由于 $S_1$ 和 $S_0$ 是独立的服从正态分布的随机变量，它们的差 $D$ 也服从正态分布。\n\n$D$ 的均值是：\n$$\nE[D] = E[S_1 - S_0] = E[S_1] - E[S_0] = \\mu_1 - \\mu_0\n$$\n$D$ 的方差是（由于独立性）：\n$$\n\\text{Var}(D) = \\text{Var}(S_1 - S_0) = \\text{Var}(S_1) + \\text{Var}(-S_0) = \\text{Var}(S_1) + (-1)^2 \\text{Var}(S_0) = \\sigma^2 + \\sigma^2 = 2\\sigma^2\n$$\n所以，差值的分布是 $D \\sim \\mathcal{N}(\\mu_1 - \\mu_0, 2\\sigma^2)$。\n\n现在我们可以计算概率 $P(D  0)$。我们对变量 $D$ 进行标准化：\n$$\nP(D0) = P\\left(\\frac{D - E[D]}{\\sqrt{\\text{Var}(D)}}  \\frac{0 - E[D]}{\\sqrt{\\text{Var}(D)}}\\right)\n$$\n$$\nP(D0) = P\\left(Z  \\frac{0 - (\\mu_1 - \\mu_0)}{\\sqrt{2\\sigma^2}}\\right)\n$$\n其中 $Z \\sim \\mathcal{N}(0, 1)$。\n$$\nP(D0) = P\\left(Z  -\\frac{\\mu_1 - \\mu_0}{\\sigma\\sqrt{2}}\\right)\n$$\n使用对称性属性 $P(Z  -z) = P(Z  z) = \\Phi(z)$，我们发现：\n$$\nP(D0) = \\Phi\\left(\\frac{\\mu_1 - \\mu_0}{\\sigma\\sqrt{2}}\\right)\n$$\n因此，AUC 的闭式解析表达式为：\n$$\n\\text{AUC} = \\Phi\\left(\\frac{\\mu_1 - \\mu_0}{\\sigma\\sqrt{2}}\\right)\n$$\n推导至此完成。", "answer": "$$\\boxed{\\Phi\\left(\\frac{\\mu_1 - \\mu_0}{\\sigma\\sqrt{2}}\\right)}$$", "id": "3167105"}, {"introduction": "在掌握了理论推导后，下一步是通过编程实践来验证和深化理解。这个编码练习的核心是验证AUC一个极其重要的等价解释：即随机抽取一个正样本，其得分高于随机抽取一个负样本得分的概率，通常记为 $\\mathbb{P}(S^+ \\gt S^-)$。你将通过编写代码，分别使用几何定义（梯形法则计算ROC曲线下面积）和概率定义（直接成对比较计数）来计算AUC，并对比两种方法的结果。此练习不仅能巩固你对AUC本质的认识，还让你熟悉了处理连续和离散分数（包括得分相同的情况）时的计算细节。[@problem_id:3167097]", "problem": "构建一个自包含的程序，针对几个指定的测试用例，比较由二元分类分数派生出的两个经验计算量：接收者操作特征（ROC）曲线下的几何面积，以及正例与负例之间的直接成对超越概率。此任务的基本依据是接收者操作特征（ROC）曲线及其曲线下面积（AUC）的定义，以及将概率定义为相对频率的极限。您必须严格遵循这些核心定义。\n\n假设一个二元分类问题由应用于实例的实值分数函数 $S:\\mathbb{R}^d\\to\\mathbb{R}$ 表示，其真实标签为 $Y\\in\\{0,1\\}$，其中 $Y=1$ 表示正类，$Y=0$ 表示负类。对于任何阈值 $t\\in\\mathbb{R}$，定义真阳性率（TPR）和假阳性率（FPR）如下：\n$$\n\\mathrm{TPR}(t) = \\frac{\\#\\{i:\\,Y_i=1,\\,S_i\\ge t\\}}{\\#\\{i:\\,Y_i=1\\}},\\quad\n\\mathrm{FPR}(t) = \\frac{\\#\\{i:\\,Y_i=0,\\,S_i\\ge t\\}}{\\#\\{i:\\,Y_i=0\\}}.\n$$\n接收者操作特征（ROC）曲线是当 $t$ 在所有可能的阈值上变化时，所描绘出的参数曲线 $\\big(\\mathrm{FPR}(t),\\mathrm{TPR}(t)\\big)$。曲线下面积（AUC）定义为沿此曲线 $\\mathrm{TPR}$ 相对于 $\\mathrm{FPR}$ 的黎曼积分：\n$$\n\\mathrm{AUC} = \\int \\mathrm{TPR}\\,d(\\mathrm{FPR}),\n$$\n其几何解释为单位正方形内ROC曲线下方的面积。\n\n独立地，考虑两个随机分数 $S^+$ 和 $S^-$，它们分别通过根据正例分数和负例分数的经验分布抽样一个正例和一个负例而获得。定义直接成对超越概率为：\n$$\np_{} = \\mathbb{P}\\big(S^+  S^-\\big),\n$$\n以及考虑平局调整的超越概率为：\n$$\np_{\\text{half}} = \\mathbb{P}\\big(S^+  S^-\\big) + \\frac{1}{2}\\,\\mathbb{P}\\big(S^+ = S^-\\big).\n$$\n您的程序必须通过对经验ROC点使用梯形法则，根据ROC定义来经验性地估计 $\\mathrm{AUC}$，并独立地通过计算所有正-负分数对来估计 $p_{}$ 和 $p_{\\text{half}}$。然后，对于每个测试用例，计算两个浮点数：$|\\mathrm{AUC} - p_{}|$ 和 $|\\mathrm{AUC} - p_{\\text{half}}|$。\n\n实现要求：\n- 对于每个测试用例，根据指定的分布和参数生成正例分数和负例分数，使用固定的随机种子 $42$ 以确保可复现性。\n- 计算 $\\mathrm{AUC}$ 的步骤如下：\n  - 将所有分数按降序排序。\n  - 在每个唯一的分数值处扫描阈值，以构建经验ROC点 $\\big(\\mathrm{FPR},\\mathrm{TPR}\\big)$。\n  - 在这些点上（包括端点 $(0,0)$ 和 $(1,1)$），通过梯形法则对 $\\mathrm{TPR}$ 关于 $\\mathrm{FPR}$ 进行积分。\n- 计算 $p_{}$ 和 $p_{\\text{half}}$ 的步骤如下：\n  - 对所有正-负对进行计数：\n  - 对于 $p_{}$：计算严格大于的比较。\n  - 对于 $p_{\\text{half}}$：对平局（分数相等）的情况加上一半的分数。\n\n测试套件：\n- 案例 $1$（连续，中等分离度）：正例分数 $S^+$ 从均值为 $\\mu_+=1$、标准差为 $\\sigma_+=1$ 的正态分布中抽样；负例分数 $S^-$ 从均值为 $\\mu_-=0$、标准差为 $\\sigma_-=1$ 的正态分布中抽样；样本量 $n^+=1000$, $n^-=1000$。\n- 案例 $2$（连续，相同分布）：$S^+$ 和 $S^-$ 均来自均值为 $\\mu=0$、标准差为 $\\sigma=1$ 的正态分布；$n^+=2000$, $n^-=2000$。\n- 案例 $3$（连续，强分离度）：$S^+$ 来自均值为 $\\mu_+=3$、标准差为 $\\sigma_+=0.5$ 的正态分布；$S^-$ 来自均值为 $\\mu_-=0$、标准差为 $\\sigma_-=0.5$ 的正态分布；$n^+=1000$, $n^-=1000$。\n- 案例 $4$（离散，有平局）：$S^+$ 来自成功概率为 $p_+=0.6$ 的伯努利分布；$S^-$ 来自成功概率为 $p_-=0.4$ 的伯努利分布；$n^+=5000$, $n^-=5000$。\n- 案例 $5$（连续，小样本，边界方差）：$S^+$ 来自均值为 $\\mu_+=0.2$、标准差为 $\\sigma_+=1$ 的正态分布；$S^-$ 来自均值为 $\\mu_-=0$、标准差为 $\\sigma_-=1$ 的正态分布；$n^+=10$, $n^-=10$。\n- 案例 $6$（连续，偏态分布）：$S^+$ 来自率参数为 $\\lambda_+=1$（尺度参数 $1/\\lambda_+=1$）的指数分布；$S^-$ 来自率参数为 $\\lambda_-=2$（尺度参数 $1/\\lambda_-=0.5$）的指数分布；$n^+=2000$, $n^-=2000$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔的结果列表。该列表必须按以下顺序排列：\n$$\n[\\Delta_1^{},\\Delta_1^{\\text{half}},\\Delta_2^{},\\Delta_2^{\\text{half}},\\dots,\\Delta_6^{},\\Delta_6^{\\text{half}}],\n$$\n其中，对于案例 $k$，$\\Delta_k^{}=|\\mathrm{AUC}-p_{}|$ 且 $\\Delta_k^{\\text{half}}=|\\mathrm{AUC}-p_{\\text{half}}|$。每个浮点数应四舍五入到 $6$ 位小数。", "solution": "用户提供了一个科学上和数学上都合理的问题。我现在将着手解决。\n\n### 第1步：问题验证\n\n**1.1. 提取给定条件**\n\n*   **问题领域**：二元分类、接收者操作特征（ROC）曲线、曲线下面积（AUC）。\n*   **定义**：\n    *   正类标签 $Y=1$，负类标签 $Y=0$。\n    *   分数函数 $S:\\mathbb{R}^d\\to\\mathbb{R}$。\n    *   真阳性率：$\\mathrm{TPR}(t) = \\frac{\\#\\{i:\\,Y_i=1,\\,S_i\\ge t\\}}{\\#\\{i:\\,Y_i=1\\}}$。\n    *   假阳性率：$\\mathrm{FPR}(t) = \\frac{\\#\\{i:\\,Y_i=0,\\,S_i\\ge t\\}}{\\#\\{i:\\,Y_i=0\\}}$。\n    *   ROC曲线：当 $t$ 变化时，参数曲线 $(\\mathrm{FPR}(t),\\mathrm{TPR}(t))$ 的轨迹。\n    *   AUC：$\\mathrm{AUC} = \\int \\mathrm{TPR}\\,d(\\mathrm{FPR})$，解释为ROC曲线下的面积。\n    *   直接成对超越概率：$p_{} = \\mathbb{P}(S^+  S^-)$，其中 $S^+$ 和 $S^-$ 分别是从随机选择的正例和负例中获得的分数。\n    *   考虑平局调整的超越概率：$p_{\\text{half}} = \\mathbb{P}(S^+  S^-) + \\frac{1}{2}\\,\\mathbb{P}(S^+ = S^-)$。\n*   **计算要求**：\n    *   使用固定的随机种子 $42$。\n    *   通过在唯一分数处的阈值扫描构建经验ROC点，并使用梯形法则进行积分来估计 $\\mathrm{AUC}$。必须包括端点 $(0,0)$ 和 $(1,1)$。\n    *   通过枚举所有正负分数对并计数结果来估计 $p_{}$ 和 $p_{\\text{half}}$。\n*   **输出**：对于每个测试用例，计算两个绝对差：$\\Delta^{} = |\\mathrm{AUC} - p_{}|$ 和 $\\Delta^{\\text{half}} = |\\mathrm{AUC} - p_{\\text{half}}|$。最终输出必须是所有测试用例的这些差异的单个逗号分隔列表，每个值四舍五入到 $6$ 位小数。\n*   **测试用例**：\n    1.  $S^+ \\sim N(\\mu=1, \\sigma=1)$， $S^- \\sim N(\\mu=0, \\sigma=1)$；$n^+=1000, n^-=1000$。\n    2.  $S^+ \\sim N(\\mu=0, \\sigma=1)$， $S^- \\sim N(\\mu=0, \\sigma=1)$；$n^+=2000, n^-=2000$。\n    3.  $S^+ \\sim N(\\mu=3, \\sigma=0.5)$， $S^- \\sim N(\\mu=0, \\sigma=0.5)$；$n^+=1000, n^-=1000$。\n    4.  $S^+ \\sim \\text{Bernoulli}(p=0.6)$， $S^- \\sim \\text{Bernoulli}(p=0.4)$；$n^+=5000, n^-=5000$。\n    5.  $S^+ \\sim N(\\mu=0.2, \\sigma=1)$， $S^- \\sim N(\\mu=0, \\sigma=1)$；$n^+=10, n^-=10$。\n    6.  $S^+ \\sim \\text{Exponential}(\\lambda=1)$， $S^- \\sim \\text{Exponential}(\\lambda=2)$；$n^+=2000, n^-=2000$。\n\n**1.2. 验证与结论**\n\n根据验证标准对问题进行审查：\n*   **科学依据**：TPR、FPR、ROC 和 AUC 的定义在统计学和机器学习中是标准的。AUC 与概率 $\\mathbb{P}(S^+  S^-)$（更准确地说是与 $p_{\\text{half}}$ 等价的 Mann-Whitney U 统计量）之间的关系是一个基本且已确立的定理。该问题要求使用指定的数值方法对该定理进行经验验证。所有概念在科学上都是合理的。\n*   **定义明确**：问题定义明确。输入（分布和样本量）、计算过程（梯形法则、成对计数）和期望的输出都得到了明确的规定。使用固定的随机种子确保了唯一且可复现的解决方案。\n*   **客观性**：语言正式、精确，没有任何主观性或偏见。\n*   **完整且一致**：问题陈述是自包含的。它提供了所有必要的定义、数据生成参数和计算指令。没有矛盾之处。\n*   **可行性**：指定的样本量导致的计算量很大，但在现代硬件上是完全可行的（例如，$5000 \\times 5000 = 25 \\times 10^6$ 次成对比较）。\n\n**结论**：该问题是**有效的**。\n\n### 第2步：解决方案设计\n\n该任务需要实现两种不同的方法来量化正负分数分布之间的分离度，然后比较它们的结果。\n\n**2.1. 通过梯形法则计算AUC**\n\n经验ROC曲线是在不同分类阈值下评估的 $(\\mathrm{FPR}, \\mathrm{TPR})$ 对的图。一个关键的洞见是，ROC曲线是分段常数，并且仅在与观察到的分数值相对应的阈值处发生变化。构建曲线并计算其面积的最直接方法如下：\n\n1.  将所有正例分数（标记为 $1$）和负例分数（标记为 $0$）合并到一个 $(score, label)$ 对的集合中。设 $n^+$ 为正例总数，$n^-$ 为负例总数。\n2.  根据分数按降序对这些对进行排序。如果分数出现平局，标签的顺序不影响最终的AUC计算，因为它们将被作为一个整体处理。\n3.  用点 $(0,0)$ 初始化ROC曲线，这对应于阈值 $t \\to \\infty$，此时没有实例被分类为正例。将真阳性计数 $(TP)$ 和假阳性计数 $(FP)$ 初始化为 $0$。\n4.  遍历排序后的对。对于每个对 $(s_i, y_i)$：\n    *   更新计数：如果 $y_i=1$，则增加 $TP$；如果 $y_i=0$，则增加 $FP$。\n    *   为了构建经验ROC点，我们仅在阈值有效改变时才添加新点。这发生在处理完一组具有相同分数值的块之后。因此，我们检查当前分数 $s_i$ 是否与下一个分数 $s_{i+1}$ 不同（或者我们是否在列表的末尾）。\n    *   当发生这种变化时，ROC曲线上的一个新点由 $(\\frac{FP}{n^-}, \\frac{TP}{n^+})$ 定义。将此点添加到我们的ROC点列表中。\n5.  遍历所有分数后，最终的点将是 $(1,1)$。从 $(0,0)$ 开始生成的完整点列表定义了经验ROC曲线的顶点。\n6.  然后通过对这些顶点应用梯形法则来计算曲线下面积（AUC）。对于每对连续的点 $(x_i, y_i)$ 和 $(x_{i+1}, y_{i+1})$，其下方的梯形面积由 $\\frac{1}{2}(y_i + y_{i+1})(x_{i+1} - x_i)$ 给出。将所有线段的这些面积相加，即可得到总AUC。\n\n**2.2. 计算成对超越概率**\n\n概率 $p_{}$ 和 $p_{\\text{half}}$ 通过经验计数直接根据其定义进行估计。\n\n1.  给定正例分数集 $\\{S^+_1, \\dots, S^+_{n^+}\\}$ 和负例分数集 $\\{S^-_1, \\dots, S^-_{n^-}\\}$，我们总共形成 $N = n^+ \\times n^-$ 个对。\n2.  初始化两个计数器：`greater_count = 0` 和 `equal_count = 0`。\n3.  遍历每个可能的对 $(S^+_i, S^-_j)$：\n    *   如果 $S^+_i  S^-_j$，增加 `greater_count`。\n    *   如果 $S^+_i = S^-_j$，增加 `equal_count`。\n4.  然后计算经验概率：\n    *   $p_{} = \\frac{\\text{greater\\_count}}{N}$\n    *   $p_{\\text{half}} = \\frac{\\text{greater\\_count} + 0.5 \\times \\text{equal\\_count}}{N}$\n\n此方法在计算上等同于计算 Mann-Whitney U 统计量，已知该统计量等于AUC。因此，该问题建立了一个对这一统计定理的数值验证。\n\n**2.3. 程序实现**\n\n将构建一个Python程序，为六个测试用例中的每一个执行这些计算。\n*   将使用一个带有指定种子（$42$）的集中式随机数生成器（`numpy.random.default_rng`）以保证可复现性。\n*   将定义用于生成分数、计算AUC和计算成对概率的辅助函数，以确保代码的清晰度和模块化。\n*   主循环将遍历测试用例参数，调用辅助函数，计算所需的绝对差，并存储四舍五入后的结果。\n*   最后，程序将以指定格式打印收集到的结果。对于指数分布，我们注意到 `numpy` 库的 `exponential` 函数是按尺度参数 $\\beta$ 参数化的，它是率参数 $\\lambda$ 的倒数（即 $\\beta = 1/\\lambda$）。", "answer": "```python\nimport numpy as np\n\ndef calculate_auc(pos_scores, neg_scores):\n    \"\"\"\n    Computes the Area Under the ROC Curve using the trapezoidal rule.\n    \"\"\"\n    n_pos = len(pos_scores)\n    n_neg = len(neg_scores)\n    \n    if n_pos == 0 or n_neg == 0:\n        return 0.5\n\n    # Combine scores and labels, then sort by score descending.\n    labels = [1] * n_pos + [0] * n_neg\n    scores = list(pos_scores) + list(neg_scores)\n    \n    sorted_pairs = sorted(zip(scores, labels), key=lambda x: x[0], reverse=True)\n    \n    # Initialize ROC points starting at (0,0).\n    roc_points = [(0.0, 0.0)]\n    tp_count, fp_count = 0, 0\n    \n    # Iterate through sorted scores to define ROC curve vertices.\n    for i in range(len(sorted_pairs)):\n        score, label = sorted_pairs[i]\n        \n        if label == 1:\n            tp_count += 1\n        else:\n            fp_count += 1\n            \n        # A new vertex is formed when the score value changes, or at the end.\n        is_last_element = (i == len(sorted_pairs) - 1)\n        is_score_change = not is_last_element and (score != sorted_pairs[i+1][0])\n        \n        if is_last_element or is_score_change:\n            tpr = tp_count / n_pos\n            fpr = fp_count / n_neg\n            roc_points.append((fpr, tpr))\n            \n    # Calculate area using the trapezoidal rule.\n    auc = 0.0\n    for i in range(len(roc_points) - 1):\n        x1, y1 = roc_points[i]\n        x2, y2 = roc_points[i+1]\n        auc += (x2 - x1) * (y1 + y2) / 2.0\n        \n    return auc\n\ndef calculate_probabilities(pos_scores, neg_scores):\n    \"\"\"\n    Computes p_ and p_half by direct pairwise comparison.\n    \"\"\"\n    n_pos = len(pos_scores)\n    n_neg = len(neg_scores)\n    total_pairs = n_pos * n_neg\n\n    if total_pairs == 0:\n        return 0.5, 0.5\n\n    gt_count = 0\n    eq_count = 0\n\n    for s_pos in pos_scores:\n        for s_neg in neg_scores:\n            if s_pos  s_neg:\n                gt_count += 1\n            elif s_pos == s_neg:\n                eq_count += 1\n                \n    p_gt = gt_count / total_pairs\n    p_half = (gt_count + 0.5 * eq_count) / total_pairs\n    \n    return p_gt, p_half\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print results.\n    \"\"\"\n    rng = np.random.default_rng(seed=42)\n    \n    test_cases = [\n        {'type': 'normal', 'params_pos': {'loc': 1, 'scale': 1, 'size': 1000}, 'params_neg': {'loc': 0, 'scale': 1, 'size': 1000}},\n        {'type': 'normal', 'params_pos': {'loc': 0, 'scale': 1, 'size': 2000}, 'params_neg': {'loc': 0, 'scale': 1, 'size': 2000}},\n        {'type': 'normal', 'params_pos': {'loc': 3, 'scale': 0.5, 'size': 1000}, 'params_neg': {'loc': 0, 'scale': 0.5, 'size': 1000}},\n        {'type': 'bernoulli', 'params_pos': {'n': 1, 'p': 0.6, 'size': 5000}, 'params_neg': {'n': 1, 'p': 0.4, 'size': 5000}},\n        {'type': 'normal', 'params_pos': {'loc': 0.2, 'scale': 1, 'size': 10}, 'params_neg': {'loc': 0, 'scale': 1, 'size': 10}},\n        {'type': 'exponential', 'params_pos': {'scale': 1.0, 'size': 2000}, 'params_neg': {'scale': 0.5, 'size': 2000}} # rate=1/scale\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        if case['type'] == 'normal':\n            pos_scores = rng.normal(**case['params_pos'])\n            neg_scores = rng.normal(**case['params_neg'])\n        elif case['type'] == 'bernoulli':\n            pos_scores = rng.binomial(**case['params_pos'])\n            neg_scores = rng.binomial(**case['params_neg'])\n        elif case['type'] == 'exponential':\n            pos_scores = rng.exponential(**case['params_pos'])\n            neg_scores = rng.exponential(**case['params_neg'])\n\n        # 1. Compute AUC using the trapezoidal rule on the empirical ROC curve\n        auc = calculate_auc(pos_scores, neg_scores)\n        \n        # 2. Compute probabilities by pairwise counting\n        p_gt, p_half = calculate_probabilities(pos_scores, neg_scores)\n        \n        # 3. Calculate absolute differences\n        delta_gt = abs(auc - p_gt)\n        delta_half = abs(auc - p_half)\n        \n        results.append(round(delta_gt, 6))\n        results.append(round(delta_half, 6))\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3167097"}, {"introduction": "一个高AUC的模型就一定“好”吗？此练习旨在揭示模型性能评估的另一个重要维度：校准度（calibration），并将其与AUC所衡量的区分度（discrimination）进行对比。你将分析两个对比鲜明的虚构模型：一个模型完全不具区分能力（$AUC=0.5$）但其预测概率完美校准；另一个模型则具有很强的区分能力（高AUC）但校准度差。通过这个思想实验，你将深刻理解到，AUC仅衡量模型的排序能力，而校准度关乎其预测概率数值的准确性——这两者在生物统计和临床决策等实际应用中都至关重要，但绝不可混为一谈。[@problem_id:4946999]", "problem": "一个体队列被划分为两个频率相等的协变量分层，记为 $G \\in \\{L,H\\}$。对每个个体，结果 $Y \\in \\{0,1\\}$ 根据以下两种数据生成机制独立生成，并定义了两个相应的预测器。\n\n模型 A（已校准，无歧视性）：\n- 数据生成机制：$Y \\sim \\text{Bernoulli}(p)$，其中 $p=0.3$，且与 $G$ 无关。\n- 预测器：对所有个体，预测概率为 $\\hat{p}=0.3$。\n\n模型 B（高度歧视性，未校准）：\n- 数据生成机制：$Y \\mid (G=L) \\sim \\text{Bernoulli}(0.1)$ 且 $Y \\mid (G=H) \\sim \\text{Bernoulli}(0.9)$，其中 $\\mathbb{P}(G=L)=\\mathbb{P}(G=H)=\\frac{1}{2}$。\n- 预测器：对于所有在 $G=L$ 中的个体，预测概率为 $\\hat{p}=0.01$，对于所有在 $G=H$ 中的个体，预测概率为 $\\hat{p}=0.99$。\n\n仅使用基本定义，计算：\n1. 模型A的受试者工作特征 (ROC) 曲线下面积 (AUC)。\n2. 模型B的ROC曲线的AUC。\n3. 模型B的校准斜率，定义为在 logit 尺度上，通过两个校准点 $\\big(\\text{logit}(\\hat{p}),\\text{logit}(\\text{观测事件率})\\big)$ 的直线的斜率 $m$，即点 $\\big(\\text{logit}(0.01),\\text{logit}(0.1)\\big)$ 和点 $\\big(\\text{logit}(0.99),\\text{logit}(0.9)\\big)$。\n\n将你的最终答案表示为有序三元组 $\\big(\\text{AUC}_{A},\\text{AUC}_{B},m\\big)$。无需四舍五入。使用自然对数 $\\ln(\\cdot)$ 表示对数。", "solution": "首先对问题陈述的科学合理性、一致性和完整性进行验证。\n\n### 第1步：提取已知条件\n问题提供了以下信息：\n- 两个频率相等的协变量分层：$G \\in \\{L,H\\}$，其中 $\\mathbb{P}(G=L) = \\mathbb{P}(G=H) = \\frac{1}{2}$。\n- 结果变量：$Y \\in \\{0,1\\}$，对每个个体独立生成。\n\n**模型A：**\n- 数据生成机制：$Y \\sim \\text{Bernoulli}(p)$，其中 $p=0.3$，且与 $G$ 无关。\n- 预测器：对所有个体，预测概率为 $\\hat{p}=0.3$。\n\n**模型B：**\n- 数据生成机制：$Y \\mid (G=L) \\sim \\text{Bernoulli}(0.1)$ 且 $Y \\mid (G=H) \\sim \\text{Bernoulli}(0.9)$。\n- 预测器：对于分层 $G=L$ 中的个体，$\\hat{p}=0.01$。对于分层 $G=H$ 中的个体，$\\hat{p}=0.99$。\n\n**任务：**\n1. 计算模型A的曲线下面积 (AUC)，记为 $\\text{AUC}_A$。\n2. 计算模型B的AUC，记为 $\\text{AUC}_B$。\n3. 计算模型B的校准斜率 $m$，定义为通过点 $\\big(\\text{logit}(0.01),\\text{logit}(0.1)\\big)$ 和点 $\\big(\\text{logit}(0.99),\\text{logit}(0.9)\\big)$ 的直线的斜率。Logit 函数在自然对数尺度 $\\ln(\\cdot)$ 上定义。\n\n### 第2步：使用提取的已知条件进行验证\n根据验证标准对问题进行评估。\n- **科学依据**：该问题使用了生物统计学中标准的、定义明确的概念，包括伯努利分布、受试者工作特征 (ROC) 曲线、曲线下面积 (AUC) 和模型校准。所提出的模型是简化的但连贯的统计结构，用于说明这些概念。该问题是科学合理的。\n- **适定性**：提供了所有必要的数据和定义。任务是具体且数学化的，能够导出一个唯一且有意义的解。问题是自洽且无歧义的。\n- **客观性**：问题使用正式、精确的语言陈述，不含任何主观或基于意见的内容。\n\n该问题没有表现出任何诸如科学不合理、不完整、矛盾或歧义等缺陷。\n\n### 第3步：结论与行动\n问题被认为是**有效的**。将提供一个完整的、有理有据的解答。\n\n### 解答\n\n**1. 模型A的 $\\text{AUC}_A$ 计算**\n\n受试者工作特征 (ROC) 曲线下面积 (AUC) 有一个标准的概率解释：它是随机选择的事件发生者（$Y=1$）的预测风险评分高于随机选择的事件未发生者（$Y=0$）的概率。如果评分可能出现平局，则AUC由下式给出：\n$$ \\text{AUC} = \\mathbb{P}(S_1  S_0) + \\frac{1}{2}\\mathbb{P}(S_1 = S_0) $$\n其中 $S_1$ 是随机选择的 $Y=1$ 的受试者的评分，而 $S_0$ 是随机选择的 $Y=0$ 的受试者的评分。\n\n在模型A中，预测器为每个个体分配相同的评分 $\\hat{p}=0.3$，无论其协变量分层或真实结果如何。因此，对于任何一对受试者，一个 $Y=1$ 和一个 $Y=0$，他们的评分将是 $S_1 = 0.3$ 和 $S_0 = 0.3$。\n\n因此：\n- 阳性病例的评分严格大于阴性病例的评分的概率为零：$\\mathbb{P}(S_1  S_0) = 0$。\n- 他们的评分相等的概率为一：$\\mathbb{P}(S_1 = S_0) = 1$。\n\n将这些值代入AUC的公式：\n$$ \\text{AUC}_A = 0 + \\frac{1}{2}(1) = \\frac{1}{2} = 0.5 $$\nAUC为$0.5$表示该模型没有歧视能力，这是预料之中的，因为预测器是一个恒定值。该模型的ROC曲线是从$(0,0)$到$(1,1)$的对角线。\n\n**2. 模型B的 $\\text{AUC}_B$ 计算**\n\n我们再次使用AUC的概率定义。在模型B中，评分 $\\hat{p}$ 可以取两个值：对于分层 $G=L$ 中的受试者为 $0.01$，对于分层 $G=H$ 中的受试者为 $0.99$。我们需要评分在结果 $Y$ 条件下的分布。\n\n首先，我们计算事件 $Y=1$ 的总体流行率：\n$$ \\mathbb{P}(Y=1) = \\mathbb{P}(Y=1|G=L)\\mathbb{P}(G=L) + \\mathbb{P}(Y=1|G=H)\\mathbb{P}(G=H) $$\n$$ \\mathbb{P}(Y=1) = (0.1)\\left(\\frac{1}{2}\\right) + (0.9)\\left(\\frac{1}{2}\\right) = 0.05 + 0.45 = 0.5 $$\n非事件的流行率为 $\\mathbb{P}(Y=0) = 1 - \\mathbb{P}(Y=1) = 0.5$。\n\n接下来，我们找出事件发生者（$Y=1$）的评分分布。评分为 $\\hat{p}=S_1$。\n$$ \\mathbb{P}(S_1=0.99) = \\mathbb{P}(G=H | Y=1) = \\frac{\\mathbb{P}(Y=1|G=H)\\mathbb{P}(G=H)}{\\mathbb{P}(Y=1)} = \\frac{(0.9)(\\frac{1}{2})}{0.5} = 0.9 $$\n$$ \\mathbb{P}(S_1=0.01) = \\mathbb{P}(G=L | Y=1) = 1 - \\mathbb{P}(S_1=0.99) = 1 - 0.9 = 0.1 $$\n\n然后，我们找出事件未发生者（$Y=0$）的评分分布。评分为 $\\hat{p}=S_0$。\n$$ \\mathbb{P}(S_0=0.01) = \\mathbb{P}(G=L | Y=0) = \\frac{\\mathbb{P}(Y=0|G=L)\\mathbb{P}(G=L)}{\\mathbb{P}(Y=0)} = \\frac{(1-0.1)(\\frac{1}{2})}{0.5} = \\frac{(0.9)(\\frac{1}{2})}{0.5} = 0.9 $$\n$$ \\mathbb{P}(S_0=0.99) = \\mathbb{P}(G=H | Y=0) = 1 - \\mathbb{P}(S_0=0.01) = 1 - 0.9 = 0.1 $$\n\n现在我们计算AUC公式的各项。受试者是独立选择的。\n$$ \\mathbb{P}(S_1  S_0) = \\mathbb{P}(S_1=0.99 \\text{ and } S_0=0.01) = \\mathbb{P}(S_1=0.99)\\mathbb{P}(S_0=0.01) = (0.9)(0.9) = 0.81 $$\n$$ \\mathbb{P}(S_1 = S_0) = \\mathbb{P}(S_1=0.99, S_0=0.99) + \\mathbb{P}(S_1=0.01, S_0=0.01) $$\n$$ \\mathbb{P}(S_1 = S_0) = \\mathbb{P}(S_1=0.99)\\mathbb{P}(S_0=0.99) + \\mathbb{P}(S_1=0.01)\\mathbb{P}(S_0=0.01) = (0.9)(0.1) + (0.1)(0.9) = 0.09 + 0.09 = 0.18 $$\n\n最后，我们计算 $\\text{AUC}_B$：\n$$ \\text{AUC}_B = \\mathbb{P}(S_1  S_0) + \\frac{1}{2}\\mathbb{P}(S_1 = S_0) = 0.81 + \\frac{1}{2}(0.18) = 0.81 + 0.09 = 0.9 $$\n这个高AUC反映了模型在区分将要发生事件和不会发生事件的受试者方面的强大能力。\n\n**3. 模型B的校准斜率 $m$ 的计算**\n\n校准斜率 $m$ 定义为通过logit转换尺度上两个指定点 $(x_1, y_1)$ 和 $(x_2, y_2)$ 的直线的斜率。\nLogit函数为 $\\text{logit}(p) = \\ln\\left(\\frac{p}{1-p}\\right)$。\n\n给定的两个点是：\n- 点1：$(x_1, y_1) = \\big(\\text{logit}(0.01), \\text{logit}(0.1)\\big)$\n- 点2：$(x_2, y_2) = \\big(\\text{logit}(0.99), \\text{logit}(0.9)\\big)$\n\n我们计算坐标：\n$x_1 = \\text{logit}(0.01) = \\ln\\left(\\frac{0.01}{1-0.01}\\right) = \\ln\\left(\\frac{0.01}{0.99}\\right) = \\ln\\left(\\frac{1}{99}\\right) = -\\ln(99)$\n$y_1 = \\text{logit}(0.1) = \\ln\\left(\\frac{0.1}{1-0.1}\\right) = \\ln\\left(\\frac{0.1}{0.9}\\right) = \\ln\\left(\\frac{1}{9}\\right) = -\\ln(9)$\n$x_2 = \\text{logit}(0.99) = \\ln\\left(\\frac{0.99}{1-0.99}\\right) = \\ln\\left(\\frac{0.99}{0.01}\\right) = \\ln(99)$\n$y_2 = \\text{logit}(0.9) = \\ln\\left(\\frac{0.9}{1-0.9}\\right) = \\ln\\left(\\frac{0.9}{0.1}\\right) = \\ln(9)$\n\n斜率 $m$ 计算如下 $m = \\frac{y_2 - y_1}{x_2 - x_1}$：\n$$ m = \\frac{\\ln(9) - (-\\ln(9))}{\\ln(99) - (-\\ln(99))} = \\frac{2\\ln(9)}{2\\ln(99)} = \\frac{\\ln(9)}{\\ln(99)} $$\n按照要求，结果以其精确的符号形式表示。\n\n最终的有序三元组是 $(\\text{AUC}_{A}, \\text{AUC}_{B}, m) = \\left(0.5, 0.9, \\frac{\\ln(9)}{\\ln(99)}\\right)$。", "answer": "$$\n\\boxed{\n\\left(0.5, 0.9, \\frac{\\ln(9)}{\\ln(99)}\\right)\n}\n$$", "id": "4946999"}]}