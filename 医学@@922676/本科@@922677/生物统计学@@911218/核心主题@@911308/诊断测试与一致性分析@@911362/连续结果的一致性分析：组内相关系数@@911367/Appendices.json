{"hands_on_practices": [{"introduction": "在评估一致性时，一个常见的误区是将相关性与一致性混为一谈。皮尔逊相关系数（Pearson correlation coefficient）衡量的是线性关系的强度，但它对系统性偏倚（如一个评估者持续给出比另一个评估者更高或更低的分数）不敏感。本练习 [@problem_id:4893311] 将通过一个精心设计的思想实验，清晰地揭示这一区别，并展示绝对一致性组内相关系数（ICC for absolute agreement）如何通过将系统性偏倚纳入考量，从而提供一个更真实的评估者一致性度量。", "problem": "一位生物统计学家正在评估两名连续型评分者对 $n$ 名受试者的一致性，其中每位受试者由每位评分者测量一次。考虑 $n=8$ 名受试者和两名评分者，分别标记为评分者 A 和评分者 B。观测值如下：\n\n- 受试者 $1$：评分者 A $10$，评分者 B $30$。\n- 受试者 $2$：评分者 A $12$，评分者 B $32$。\n- 受试者 $3$：评分者 A $14$，评分者 B $34$。\n- 受试者 $4$：评分者 A $16$，评分者 B $36$。\n- 受试者 $5$：评分者 A $18$，评分者 B $38$。\n- 受试者 $6$：评分者 A $20$，评分者 B $40$。\n- 受试者 $7$：评分者 A $22$，评分者 B $42$。\n- 受试者 $8$：评分者 A $24$，评分者 B $44$。\n\n从用于连续结果一致性的双向随机效应框架及其相关的方差分析分解出发，计算用于单一测量的绝对一致性的组内相关系数 (Intraclass Correlation Coefficient, ICC)，记为组内相关系数 (ICC) $(\\text{absolute agreement}, 1)$，并简要解释为什么对于此数据集，该值可能与两名评分者之间的皮尔逊积矩相关系数不同。\n\n仅报告此数据集的组内相关系数 $(\\text{absolute agreement}, 1)$ 的值，四舍五入到 $4$ 位有效数字。不需要单位。", "solution": "问题要求计算用于单一测量的绝对一致性的组内相关系数，记为 ICC$(\\text{absolute agreement}, 1)$。此分析在双向随机效应框架内进行。数据包含来自 $k=2$ 名评分者对 $n=8$ 名受试者的测量值。\n\n对于来自受试者 $i$、由评分者 $j$ 测量的观测值 $y_{ij}$，其双向随机效应模型由下式给出：\n$$y_{ij} = \\mu + s_i + r_j + e_{ij}$$\n其中 $\\mu$ 是总均值，$s_i$ 是受试者 $i$ 的随机效应 ($s_i \\sim \\mathcal{N}(0, \\sigma_s^2)$)，$r_j$ 是评分者 $j$ 的随机效应 ($r_j \\sim \\mathcal{N}(0, \\sigma_r^2)$)，$e_{ij}$ 是随机误差项 ($e_{ij} \\sim \\mathcal{N}(0, \\sigma_e^2)$)。$\\sigma_s^2$、$\\sigma_r^2$ 和 $\\sigma_e^2$ 分别代表受试者间方差、评分者间方差和残差方差。所有效应均假定为独立的。\n\n用于单一测量的绝对一致性的 ICC 定义为可归因于受试者的方差占总方差的比例。其公式为：\n$$ \\text{ICC}(\\text{absolute agreement}, 1) = \\frac{\\sigma_s^2}{\\sigma_s^2 + \\sigma_r^2 + \\sigma_e^2} $$\n为了估计方差分量（$\\sigma_s^2, \\sigma_r^2, \\sigma_e^2$），我们对所提供的数据进行双向方差分析 (ANOVA)。\n\n对于 $n=8$ 名受试者和 $k=2$ 名评分者的数据如下：\n- 评分者 A ($j=1$): $10, 12, 14, 16, 18, 20, 22, 24$\n- 评分者 B ($j=2$): $30, 32, 34, 36, 38, 40, 42, 44$\n\n首先，我们计算必要的均值：\n- 评分者 A 均值：$\\bar{y}_{.1} = \\frac{1}{8}\\sum_{i=1}^8 y_{i1} = \\frac{136}{8} = 17$\n- 评分者 B 均值：$\\bar{y}_{.2} = \\frac{1}{8}\\sum_{i=1}^8 y_{i2} = \\frac{296}{8} = 37$\n- 受试者均值 ($\\bar{y}_{i.}$):\n  $\\bar{y}_{1.} = \\frac{10+30}{2}=20, \\bar{y}_{2.} = \\frac{12+32}{2}=22, \\dots, \\bar{y}_{8.} = \\frac{24+44}{2}=34$\n- 总均值：$\\bar{y}_{..} = \\frac{1}{nk}\\sum_{i=1}^n \\sum_{j=1}^k y_{ij} = \\frac{17+37}{2} = 27$\n\n接下来，我们为方差分析计算平方和 (SS)：\n- 受试者间平方和 (SSB):\n$$ SSB = k \\sum_{i=1}^n (\\bar{y}_{i.} - \\bar{y}_{..})^2 = 2 \\sum_{i=1}^8 (\\bar{y}_{i.} - 27)^2 $$\n$$ SSB = 2 \\left[ (20-27)^2 + (22-27)^2 + (24-27)^2 + (26-27)^2 + (28-27)^2 + (30-27)^2 + (32-27)^2 + (34-27)^2 \\right] $$\n$$ SSB = 2 \\left[ (-7)^2 + (-5)^2 + (-3)^2 + (-1)^2 + 1^2 + 3^2 + 5^2 + 7^2 \\right] $$\n$$ SSB = 2 [49+25+9+1+1+9+25+49] = 2(168) = 336 $$\n\n- 评分者间平方和 (SSJ):\n$$ SSJ = n \\sum_{j=1}^k (\\bar{y}_{.j} - \\bar{y}_{..})^2 = 8 \\left[ (17-27)^2 + (37-27)^2 \\right] $$\n$$ SSJ = 8 [(-10)^2 + 10^2] = 8(100+100) = 8(200) = 1600 $$\n\n- 总平方和 (SST):\n$$ SST = \\sum_{i=1}^n \\sum_{j=1}^k (y_{ij} - \\bar{y}_{..})^2 $$\n$$ SST = \\sum_{i=1}^8 (y_{i1}-27)^2 + \\sum_{i=1}^8 (y_{i2}-27)^2 $$\n$$ SST = \\left[ (-17)^2 + (-15)^2 + \\dots + (-3)^2 \\right] + \\left[ 3^2 + 5^2 + \\dots + 17^2 \\right] $$\n$$ SST = (289+225+169+121+81+49+25+9) + (9+25+49+81+121+169+225+289) = 968 + 968 = 1936 $$\n\n- 误差平方和 (SSE):\n$$ SSE = SST - SSB - SSJ = 1936 - 336 - 1600 = 0 $$\n误差平方和为零表示没有受试者-评分者交互作用；对于所有受试者，评分者之间的差异是恒定的。\n\n现在，我们构建方差分析表来找出均方 (MS)：\n- 受试者均方：$MSB = \\frac{SSB}{n-1} = \\frac{336}{8-1} = \\frac{336}{7} = 48$\n- 评分者均方：$MSJ = \\frac{SSJ}{k-1} = \\frac{1600}{2-1} = 1600$\n- 误差均方：$MSE = \\frac{SSE}{(n-1)(k-1)} = \\frac{0}{(7)(1)} = 0$\n\n双向随机效应模型的期望均方 (EMS) 是：\n- $E(MSB) = k\\sigma_s^2 + \\sigma_e^2$\n- $E(MSJ) = n\\sigma_r^2 + \\sigma_e^2$\n- $E(MSE) = \\sigma_e^2$\n\n现在我们可以通过将观测到的均方与其期望值相等来估计方差分量：\n- $\\hat{\\sigma}_e^2 = MSE = 0$\n- $MSB = k\\hat{\\sigma}_s^2 + \\hat{\\sigma}_e^2 \\implies 48 = 2\\hat{\\sigma}_s^2 + 0 \\implies \\hat{\\sigma}_s^2 = 24$\n- $MSJ = n\\hat{\\sigma}_r^2 + \\hat{\\sigma}_e^2 \\implies 1600 = 8\\hat{\\sigma}_r^2 + 0 \\implies \\hat{\\sigma}_r^2 = 200$\n\n利用估计出的方差分量，我们计算 ICC：\n$$ \\text{ICC}(\\text{absolute agreement}, 1) = \\frac{\\hat{\\sigma}_s^2}{\\hat{\\sigma}_s^2 + \\hat{\\sigma}_r^2 + \\hat{\\sigma}_e^2} = \\frac{24}{24 + 200 + 0} = \\frac{24}{224} = \\frac{3}{28} $$\n$$ \\frac{3}{28} \\approx 0.107142857... $$\n四舍五入到 $4$ 位有效数字，该值为 $0.1071$。\n\n问题还要求简要解释为什么这个 ICC 值不同于皮尔逊积矩相关系数 $r$。对于此数据集，每位受试者来自评分者 B 的分数都恰好比来自评分者 A 的分数高 $20$ 分 ($y_{i,B} = y_{i,A} + 20$)。这是一个完美的正线性关系。皮尔逊相关系数仅衡量线性关联的强度，并且对这种加性系统性偏差不敏感。因此，该数据的皮尔逊相关系数为 $r=1$。\n\n相比之下，用于绝对一致性的 ICC 被设计为对系统性偏差敏感。其公式包含了评分者间方差 $\\sigma_r^2$。两位评分者之间巨大且一致的差异导致了一个非常大的估计评分者间方差分量 ($\\hat{\\sigma}_r^2 = 200$)，这是 ICC 公式分母中总方差的主要部分。这个大的 $\\sigma_r^2$ 项严重拉低了 ICC 值，反映了尽管评分者分数具有完美的一致性，但其绝对一致性却很差。因此，虽然皮尔逊相关系数表明了完美的一致性 ($r=1$)，但用于绝对一致性的 ICC 正确地表明了较差的绝对一致性 (ICC $\\approx 0.1071$)。", "answer": "$$\n\\boxed{0.1071}\n$$", "id": "4893311"}, {"introduction": "组内相关系数（ICC）不仅是一个描述性统计量，更是在研究设计阶段一个至关重要的工具。在许多科学和临床应用中，我们希望通过多次重复测量并取平均值来提高测量的可靠性。本练习 [@problem_id:4893345] 模拟了一个在生物标志物分析验证中的常见场景，要求你推导并应用斯皮尔曼-布朗预言公式（Spearman-Brown prophecy formula），来计算为了达到预期的可靠性水平，需要多少次重复测量。这让你能够将ICC的理论知识转化为解决实际问题的能力。", "problem": "一个临床实验室正在验证一种用于连续生物标志物的定量检测方法。对于受试者 $i$，第 $j$ 次重复测量由经典的随机效应分解模型 $Y_{ij} = \\mu + S_{i} + E_{ij}$ 建模，其中 $S_{i}$ 代表受试者特异性随机效应，其方差为 $\\sigma_{b}^{2}$，$E_{ij}$ 代表独立的测量误差，其方差为 $\\sigma_{w}^{2}$，并且所有分量都相互独立，均值为零。单次测量的可靠性由组内相关系数（Intraclass Correlation Coefficient, ICC）量化，对于单次测量其定义为 $ICC = \\sigma_{b}^{2} / (\\sigma_{b}^{2} + \\sigma_{w}^{2})$。一项初步研究估计单次测量的组内相关系数（ICC）为 $0.70$。该实验室计划对每个受试者平均 $k$ 次独立重复测量，以报告该受试者的检测值。\n\n仅使用上述方差分解和组内相关系数（ICC）的定义，推导出 $k$ 次重复测量平均值的可靠性，作为 $k$ 和单次测量 ICC 的函数，然后确定最小的整数 $k$，使得平均测量的 ICC 至少为 $0.85$。将最终的 $k$ 以整数形式报告。无需四舍五入到有效数字；根据设计，$k$ 必须是整数。", "solution": "该问题需要两部分：首先，推导平均测量 ICC（$ICC_k$）的表达式；其次，计算达到所需可靠性的最小重复次数 $k$。\n\n**第1部分：平均测量 ICC ($ICC_k$) 的推导**\n\n设 $\\bar{Y}_i$ 为受试者 $i$ 的 $k$ 次重复测量的平均值。\n$$ \\bar{Y}_i = \\frac{1}{k} \\sum_{j=1}^{k} Y_{ij} $$\n代入给定的模型 $Y_{ij} = \\mu + S_{i} + E_{ij}$：\n$$ \\bar{Y}_i = \\frac{1}{k} \\sum_{j=1}^{k} (\\mu + S_{i} + E_{ij}) = \\frac{1}{k} \\left( k\\mu + kS_{i} + \\sum_{j=1}^{k} E_{ij} \\right) = \\mu + S_{i} + \\left( \\frac{1}{k} \\sum_{j=1}^{k} E_{ij} \\right) $$\n这个平均测量的可靠性 $ICC_k$ 定义为真实受试者方差与平均测量总方差之比。真实受试者方差是受试者特异性随机效应的方差，即 $\\text{Var}(S_i) = \\sigma_{b}^{2}$。平均测量的总方差是 $\\text{Var}(\\bar{Y}_i)$。\n\n我们来计算 $\\text{Var}(\\bar{Y}_i)$。由于 $\\mu$ 是一个常数，其方差为 $0$。随机效应 $S_i$ 和误差项 $E_{ij}$ 是独立的。因此，$S_i$ 也与平均误差 $\\bar{E}_i = \\frac{1}{k} \\sum_{j=1}^{k} E_{ij}$ 独立。\n$$ \\text{Var}(\\bar{Y}_i) = \\text{Var}(\\mu + S_{i} + \\bar{E}_i) = \\text{Var}(S_i) + \\text{Var}(\\bar{E}_i) $$\n已知 $\\text{Var}(S_i) = \\sigma_{b}^{2}$。现在我们求 $\\text{Var}(\\bar{E}_i)$：\n$$ \\text{Var}(\\bar{E}_i) = \\text{Var}\\left(\\frac{1}{k} \\sum_{j=1}^{k} E_{ij}\\right) = \\frac{1}{k^2} \\text{Var}\\left(\\sum_{j=1}^{k} E_{ij}\\right) $$\n因为误差项 $E_{ij}$ 对于 $j=1, \\dots, k$ 是独立的，所以它们的和的方差等于它们方差的和：\n$$ \\text{Var}\\left(\\sum_{j=1}^{k} E_{ij}\\right) = \\sum_{j=1}^{k} \\text{Var}(E_{ij}) = \\sum_{j=1}^{k} \\sigma_{w}^{2} = k\\sigma_{w}^{2} $$\n将其代回，平均误差的方差为：\n$$ \\text{Var}(\\bar{E}_i) = \\frac{1}{k^2} (k\\sigma_{w}^{2}) = \\frac{\\sigma_{w}^{2}}{k} $$\n因此，平均测量的总方差为：\n$$ \\text{Var}(\\bar{Y}_i) = \\sigma_{b}^{2} + \\frac{\\sigma_{w}^{2}}{k} $$\n现在我们可以写出平均测量 ICC, $ICC_k$ 的表达式：\n$$ ICC_k = \\frac{\\text{真实受试者方差}}{\\text{总方差}} = \\frac{\\text{Var}(S_i)}{\\text{Var}(\\bar{Y}_i)} = \\frac{\\sigma_{b}^{2}}{\\sigma_{b}^{2} + \\frac{\\sigma_{w}^{2}}{k}} $$\n为了将 $ICC_k$ 表示为单次测量 ICC 和 $k$ 的函数，我们首先处理单次测量 ICC 的定义，$ICC = \\frac{\\sigma_{b}^{2}}{\\sigma_{b}^{2} + \\sigma_{w}^{2}}$。\n由此，我们推导出方差分量的比率：\n$$ ICC(\\sigma_{b}^{2} + \\sigma_{w}^{2}) = \\sigma_{b}^{2} $$\n$$ ICC \\cdot \\sigma_{b}^{2} + ICC \\cdot \\sigma_{w}^{2} = \\sigma_{b}^{2} $$\n$$ ICC \\cdot \\sigma_{w}^{2} = \\sigma_{b}^{2} (1 - ICC) $$\n$$ \\frac{\\sigma_{w}^{2}}{\\sigma_{b}^{2}} = \\frac{1 - ICC}{ICC} $$\n现在，我们回到 $ICC_k$ 的表达式，并将分子和分母同时除以 $\\sigma_{b}^{2}$：\n$$ ICC_k = \\frac{\\frac{\\sigma_{b}^{2}}{\\sigma_{b}^{2}}}{\\frac{\\sigma_{b}^{2}}{\\sigma_{b}^{2}} + \\frac{\\sigma_{w}^{2}}{k\\sigma_{b}^{2}}} = \\frac{1}{1 + \\frac{1}{k}\\left(\\frac{\\sigma_{w}^{2}}{\\sigma_{b}^{2}}\\right)} $$\n代入我们推导出的方差比率：\n$$ ICC_k = \\frac{1}{1 + \\frac{1}{k}\\left(\\frac{1-ICC}{ICC}\\right)} $$\n为简化，将分子和分母同时乘以 $k \\cdot ICC$：\n$$ ICC_k = \\frac{k \\cdot ICC}{k \\cdot ICC \\left(1 + \\frac{1-ICC}{k \\cdot ICC}\\right)} = \\frac{k \\cdot ICC}{k \\cdot ICC + (1-ICC)} $$\n这就得到了最终的推导公式，即斯皮尔曼-布朗预测公式（Spearman-Brown prophecy formula）：\n$$ ICC_k = \\frac{k \\cdot ICC}{1 + (k-1)ICC} $$\n这就完成了问题的第一部分。\n\n**第2部分：计算最小重复次数 $k$**\n\n我们已知单次测量的 $ICC = 0.70$，平均测量的目标可靠性为 $ICC_k \\geq 0.85$。我们必须找到满足此条件的最小整数 $k$。\n$$ \\frac{k \\cdot (0.70)}{1 + (k-1)(0.70)} \\geq 0.85 $$\n由于 $k$ 必须是大于或等于 $1$ 的整数，分母 $1 + (k-1)(0.70)$ 总是正数。我们可以在不等式两边同乘以分母，而不用改变不等号的方向。\n$$ 0.70k \\geq 0.85 \\left[ 1 + 0.70(k-1) \\right] $$\n$$ 0.70k \\geq 0.85 (1 + 0.70k - 0.70) $$\n$$ 0.70k \\geq 0.85 (0.30 + 0.70k) $$\n$$ 0.70k \\geq (0.85)(0.30) + (0.85)(0.70)k $$\n$$ 0.70k \\geq 0.255 + 0.595k $$\n不等式两边同时减去 $0.595k$：\n$$ 0.70k - 0.595k \\geq 0.255 $$\n$$ 0.105k \\geq 0.255 $$\n$$ k \\geq \\frac{0.255}{0.105} $$\n简化分数：\n$$ k \\geq \\frac{255}{105} = \\frac{51}{21} = \\frac{17}{7} $$\n作为小数，$\\frac{17}{7} \\approx 2.42857...$。\n因为 $k$ 必须是整数（重复次数），我们必须找到大于或等于 $2.42857...$ 的最小整数。\n最小的这样的整数是 $3$。\n\n为了验证：\n对于 $k=2$：$ICC_2 = \\frac{2(0.70)}{1+(2-1)(0.70)} = \\frac{1.4}{1.7} \\approx 0.8235$，小于 $0.85$。\n对于 $k=3$：$ICC_3 = \\frac{3(0.70)}{1+(3-1)(0.70)} = \\frac{2.1}{1+1.4} = \\frac{2.1}{2.4} = \\frac{21}{24} = \\frac{7}{8} = 0.875$，大于或等于 $0.85$。\n因此，所需的最小整数重复次数为 $3$。", "answer": "$$\n\\boxed{3}\n$$", "id": "4893345"}, {"introduction": "为了真正深入理解评估者一致性的复杂性，没有什么比亲手构建模型并观察其动态行为更有效了。本练习 [@problem_id:4893327] 是一个综合性的计算实践，你将通过编写程序来模拟含有不同类型偏倚（加性偏倚和乘性偏倚）的评估数据。通过这个过程，你将直观地看到两种主要的ICC形式——绝对一致性（absolute agreement）和相对一致性（consistency）——对不同偏倚的反应，从而对这些统计指标的内在机制建立起深刻而直观的理解。", "problem": "你需要编写一个完整的、可运行的程序，该程序模拟双向设计下的评分者测量，并计算两种类型的组内相关系数（ICC）：绝对一致性（absolute agreement）和相对一致性（consistency）。然后，程序需要展示这两种系数对加性（additive）和乘性（multiplicative）评分者偏差的响应。请纯粹从数学和算法角度进行操作。\n\n基本模型与定义：\n- 组内相关系数（ICC）通过在双向随机效应方差分析模型下，比较被试间变异与总变异，来量化连续性结果的一致性程度。\n- 考虑有 $n$ 个被试，每个被试由 $k$ 个评分者进行评分。设 $Y_{ij}$ 表示评分者 $j$ 对被试 $i$ 的评分。假设数据由以下随机模型生成：\n  - 真实被试分数：$T_i \\sim \\mathcal{N}(0, \\sigma_S^2)$，对于 $i \\in \\{1,\\dots,n\\}$ 独立同分布。\n  - 评分者特定尺度乘数：$S_j$（每个案例中的固定常数）。\n  - 评分者特定加性偏差：$B_j$（每个案例中的固定常数）。\n  - 测量噪声：$E_{ij} \\sim \\mathcal{N}(0, \\sigma_E^2)$，对于所有 $(i,j)$ 独立同分布。\n  - 观测分数：$Y_{ij} = S_j \\, T_i + B_j + E_{ij}$。\n- 一致性通过双向随机效应方差分析分解计算出的两种 ICC 进行评估：\n  - 绝对一致性 ICC 将系统性的评分者均值差异视为不一致。\n  - 相对一致性 ICC 对系统性的评分者均值差异（加性偏移）保持不变，侧重于被试在不同评分者间的排名一致性。\n\n你的程序必须：\n1) 对于下方的每个测试案例，完全按照上述规定模拟数据矩阵 $Y \\in \\mathbb{R}^{n \\times k}$。使用伪随机数生成器，并为了可复现性设置种子，种子值为 $20231105$ 加上测试案例的零基索引（即，种子 = $20231105 + \\text{case\\_index}$）。对于 $T_i$ 和 $E_{ij}$，使用均值为 $0$ 和指定标准差的正态分布。\n2) 对于每个模拟出的矩阵 $Y$，使用方差分析的均方（mean squares）从双向随机效应模型中计算以下量：\n   - 被试间均方、评分者间均方和残差均方（被试-评分者交互作用加上测量噪声）。\n   - 根据这些均方，推导并计算：\n     - 绝对一致性单一度量 ICC（常被称为双向随机效应，绝对一致性）。\n     - 相对一致性单一度量 ICC（常被称为双向混合/随机效应，相对一致性）。\n   推导必须基于方差分解和期望均方；不要依赖外部库的黑盒 ICC 例程。\n3) 对于每个测试案例，输出两个浮点数值：首先是绝对一致性 ICC，然后是相对一致性 ICC。每个值都表示为小数（而非百分比），并四舍五入到 $6$ 位小数。\n4) 如果在 ICC 公式计算中遇到任何分母为 $0$ 的情况，则为该 ICC 输出一个“非数值”（Not-a-Number）值。\n\n测试套件：\n所有案例中均使用 $k=2$ 个评分者。每个案例指定 $(n, \\sigma_S, \\sigma_E, \\mathbf{B}, \\mathbf{S})$，其中 $\\mathbf{B} = [B_1, B_2]$ 且 $\\mathbf{S} = [S_1, S_2]$。\n- 案例 1（基线，无偏差）：$(n=\\;40, \\; \\sigma_S=\\;10, \\; \\sigma_E=\\;3, \\; \\mathbf{B}=[0, 0], \\; \\mathbf{S}=[1, 1])$。\n- 案例 2（加性偏差）：$(n=\\;40, \\; \\sigma_S=\\;10, \\; \\sigma_E=\\;3, \\; \\mathbf{B}=[0, 5], \\; \\mathbf{S}=[1, 1])$。\n- 案例 3（乘性尺度偏差）：$(n=\\;40, \\; \\sigma_S=\\;10, \\; \\sigma_E=\\;3, \\; \\mathbf{B}=[0, 0], \\; \\mathbf{S}=[1, 1.2])$。\n- 案例 4（低被试间变异性，伴有加性偏差）：$(n=\\;40, \\; \\sigma_S=\\;0.1, \\; \\sigma_E=\\;3, \\; \\mathbf{B}=[0, 5], \\; \\mathbf{S}=[1, 1])$。\n\n数值与输出要求：\n- 不涉及角度或物理单位。\n- 所有 ICC 必须表示为小数，而非百分比。\n- 你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，结果的顺序和格式如下：\n  $[\\text{ICC\\_A1\\_case1}, \\text{ICC\\_C1\\_case1}, \\text{ICC\\_A1\\_case2}, \\text{ICC\\_C1\\_case2}, \\text{ICC\\_A1\\_case3}, \\text{ICC\\_C1\\_case3}, \\text{ICC\\_A1\\_case4}, \\text{ICC\\_C1\\_case4}]$\n- 在打印前，将每个值精确地四舍五入到 $6$ 位小数。", "solution": "我们已对问题陈述进行了严格审查，并确定其是有效的。该问题基于已确立的方差分析（ANOVA）和组内相关系数（ICC）的统计理论，具有科学依据；其表述清晰，指令完整且计算上可行，并且其构思是客观的。任务是在特定的偏差条件下模拟评分者数据，并量化这些偏差对两种不同形式的ICC——绝对一致性（absolute agreement）和相对一致性（consistency）——的影响。我们将提供一个完整的解决方案。\n\n解决方案的结构如下：首先，建立双向方差分析的理论框架并推导 ICC 公式。其次，详细说明用于模拟数据和计算所需统计量的计算算法。最后，基于理论原则讨论指定测试案例的预期结果。\n\n### 理论基础：ANOVA 和 ICC\n\n组内相关系数（ICC）是一种描述性统计量，用于量化组内测量值的同质性或一致性。在评分者信度的背景下，它衡量评分总变异中有多少是由于被评被试之间的真实差异造成的。我们考虑一个有 $n$ 个被试和 $k$ 个评分者的研究。数据被组织成一个 $n \\times k$ 的矩阵 $Y$，其中 $Y_{ij}$ 是评分者 $j$ 对被试 $i$ 的评分。\n\n所要求的 ICC 的计算基于从双向方差分析（ANOVA）中估计出的方差分量。数据中的总变异被划分为可归因于被试、评分者和残差（包括被试-评分者交互作用）的来源。\n\n设 $\\bar{Y}_{i.}$ 为被试 $i$ 的平均分，$\\bar{Y}_{.j}$ 为评分者 $j$ 的平均分，$\\bar{Y}_{..}$ 为所有分数的总平均值。平方和计算如下：\n\n- **被试间平方和 ($SS_S$)**: $SS_S = k \\sum_{i=1}^n (\\bar{Y}_{i.} - \\bar{Y}_{..})^2$\n- **评分者间平方和 ($SS_R$)**: $SS_R = n \\sum_{j=1}^k (\\bar{Y}_{.j} - \\bar{Y}_{..})^2$\n- **总平方和 ($SS_{Total}$)**: $SS_{Total} = \\sum_{i=1}^n \\sum_{j=1}^k (Y_{ij} - \\bar{Y}_{..})^2$\n- **残差（误差）平方和 ($SS_E$)**: $SS_E = SS_{Total} - SS_S - SS_R$\n\n均方（$MS$）是平方和除以其各自的自由度（$df$）：\n- **被试间均方 ($MS_S$)**: $MS_S = \\frac{SS_S}{n-1}$，自由度为 $df_S = n-1$\n- **评分者间均方 ($MS_R$)**: $MS_R = \\frac{SS_R}{k-1}$，自由度为 $df_R = k-1$\n- **残差（误差）均方 ($MS_E$)**: $MS_E = \\frac{SS_E}{(n-1)(k-1)}$，自由度为 $df_E = (n-1)(k-1)$\n\n这些均方可作为总体潜在方差分量——被试方差（$\\sigma_S^2$）、评分者方差（$\\sigma_R^2$）和误差方差（$\\sigma_E^2$）——的线性组合的估计。双向随机效应模型的期望均方为：\n- $E[MS_S] = k \\sigma_S^2 + \\sigma_E^2$\n- $E[MS_R] = n \\sigma_R^2 + \\sigma_E^2$\n- $E[MS_E] = \\sigma_E^2$\n\n由此，我们可以推导出方差分量的矩法估计量：\n- $\\hat{\\sigma}_S^2 = \\frac{MS_S - MS_E}{k}$\n- $\\hat{\\sigma}_R^2 = \\frac{MS_R - MS_E}{n}$\n- $\\hat{\\sigma}_E^2 = MS_E$\n\n我们现在推导所需的两种 ICC。\n\n**1. 绝对一致性 ICC（单一度量）**\n这种 ICC 在文献中通常表示为 ICC(A,1) 或 ICC(2,1)，适用于将被试和评分者都视为来自更大人群的随机样本的双向随机效应模型。它通过将评分者之间的系统性差异视为误差来源，来量化评分间的绝对一致性程度。ICC 是可归因于被试变异的总方差比例。\n单个观测值的总方差是所有方差分量之和：$\\sigma_S^2 + \\sigma_R^2 + \\sigma_E^2$。\n$$ ICC_{abs} = \\frac{\\text{被试方差}}{\\text{总方差}} = \\frac{\\sigma_S^2}{\\sigma_S^2 + \\sigma_R^2 + \\sigma_E^2} $$\n代入基于均方的估计量：\n$$ ICC_{abs} = \\frac{\\frac{MS_S - MS_E}{k}}{\\frac{MS_S - MS_E}{k} + \\frac{MS_R - MS_E}{n} + MS_E} $$\n一个在代数上等价于上述公式的更常见的计算形式是：\n$$ ICC_{abs} = \\frac{MS_S - MS_E}{MS_S + (k-1)MS_E + \\frac{k}{n}(MS_R - MS_E)} $$\n评分者中的加性偏差会增加该评分者的 $\\bar{Y}_{.j}$，导致 $MS_R$ 增大，从而降低 $ICC_{abs}$ 的值，这正确地反映了较差的绝对一致性。\n\n**2. 相对一致性 ICC（单一度量）**\n这种 ICC 在文献中通常表示为 ICC(C,1) 或 ICC(3,1)，适用于将被试视为随机而将 $k$ 个评分者视为固定的双向混合效应模型。它衡量分数的一致性，这意味着它对评分者的加性偏差不敏感。由于评分者效应是固定的，评分者方差不属于随机变异的一部分。因此，相关的“总”方差仅为被试方差和误差方差之和。\n$$ ICC_{cons} = \\frac{\\text{被试方差}}{\\text{被试方差 + 误差方差}} = \\frac{\\sigma_S^2}{\\sigma_S^2 + \\sigma_E^2} $$\n代入估计量：\n$$ ICC_{cons} = \\frac{\\frac{MS_S - MS_E}{k}}{\\frac{MS_S - MS_E}{k} + MS_E} $$\n将分子和分母同乘以 $k$ 得到标准的计算公式：\n$$ ICC_{cons} = \\frac{MS_S - MS_E}{MS_S + (k-1)MS_E} $$\n这个公式不包含 $MS_R$ 项。因此，评分者之间较大的系统性差异（会增大 $MS_R$）不会影响 $ICC_{cons}$ 的值。\n\n### 算法方法论\n\n程序将为每个测试案例执行以下步骤：\n1.  **初始化**：设置参数 $(n, k, \\sigma_S, \\sigma_E, \\mathbf{B}, \\mathbf{S})$ 和伪随机数生成器种子（$20231105 + \\text{case\\_index}$）。\n2.  **模拟数据**：\n    -   生成 $n$ 个真实被试分数，$T_i \\sim \\mathcal{N}(0, \\sigma_S^2)$。\n    -   生成一个 $n \\times k$ 的误差项矩阵，$E_{ij} \\sim \\mathcal{N}(0, \\sigma_E^2)$。\n    -   根据模型 $Y_{ij} = S_j T_i + B_j + E_{ij}$，使用 NumPy 的广播功能构建 $n \\times k$ 的数据矩阵 $Y$。\n3.  **计算均方**：\n    -   从矩阵 $Y$ 计算 $\\bar{Y}_{..}$、$\\bar{Y}_{i.}$ 和 $\\bar{Y}_{.j}$。\n    -   使用这些均值计算 $SS_S$、$SS_R$ 和 $SS_{Total}$。\n    -   计算 $SS_E = SS_{Total} - SS_S - SS_R$。\n    -   将平方和除以它们各自的自由度（$n-1$, $k-1$, $(n-1)(k-1)$）以获得 $MS_S$、$MS_R$ 和 $MS_E$。\n4.  **计算 ICC**：\n    -   使用推导出的公式计算 $ICC_{abs}$ 和 $ICC_{cons}$。\n    -   对每个 ICC，检查其分母是否为零。如果为零，则结果为“非数值”（`NaN`）。否则，执行除法。\n5.  **存储与格式化**：存储计算出的两个 ICC 值，并在处理完所有案例后，将收集到的结果格式化为所需的单行字符串输出，每个值四舍五入到 6 位小数。\n\n### 测试案例的预期行为\n-   **案例 1 (基线)**：在没有加性或乘性偏差（$B_j=0, S_j=1$）的情况下，评分者间方差预计会很小（仅由抽样误差引起）。因此，$MS_R \\approx MS_E$，导致项 $\\frac{k}{n}(MS_R - MS_E)$ 接近于零。结果是，$ICC_{abs}$ 和 $ICC_{cons}$ 的值应该非常接近且很高，反映了良好的绝对一致性和相对一致性。\n-   **案例 2 (加性偏差)**：加性偏差（$B=[0,5]$）将在两个评分者的平均评分之间产生巨大的系统性差异，从而增大 $MS_R$。这将显著增加 $ICC_{abs}$ 的分母，降低其值。$ICC_{cons}$ 对 $MS_R$ 不敏感，应该保持高值，与案例 1 中的值相似。\n-   **案例 3 (乘性偏差)**：乘性偏差（$S=[1, 1.2]$）引入了被试与评分者的交互作用，因为评分者分数之间的差异取决于被试的真实分数。这种交互作用会增大残差均方 $MS_E$。增大的 $MS_E$ 会减小分子（$MS_S-MS_E$）并增大两个 ICC 的分母，从而同时降低相对一致性和绝对一致性。\n-   **案例 4 (低被试变异性)**：当真实的被试间标准差（$\\sigma_S=0.1$）远小于误差标准差（$\\sigma_E=3$）时，“信号”被“噪声”淹没。与 $MS_S - MS_E$ 成正比的被试方差估计值可能会非常小，甚至为负（如果由于抽样导致 $MS_S  MS_E$），从而导致 ICC 值接近于零或为负。大的加性偏差会进一步压低 $ICC_{abs}$。这个案例表明，当被试之间没有显著可区分性时，ICC 值会很低。\n\n这种严谨、基于原则的方法确保了解决方案的正确性和可验证性。", "answer": "```python\nimport numpy as np\n\ndef calculate_iccs(Y: np.ndarray):\n    \"\"\"\n    Computes absolute agreement and consistency ICCs from a data matrix.\n\n    Args:\n        Y: An n x k numpy array of ratings, where n is the number of subjects\n           and k is the number of raters.\n\n    Returns:\n        A tuple containing (icc_abs, icc_cons).\n    \"\"\"\n    n, k = Y.shape\n\n    if n == 1 or k == 1:\n        return (np.nan, np.nan)\n\n    # Calculate mean squares\n    grand_mean = np.mean(Y)\n    subject_means = np.mean(Y, axis=1)\n    rater_means = np.mean(Y, axis=0)\n\n    # Sum of Squares\n    ss_total = np.sum((Y - grand_mean) ** 2)\n    ss_s = k * np.sum((subject_means - grand_mean) ** 2)\n    ss_r = n * np.sum((rater_means - grand_mean) ** 2)\n    ss_e = ss_total - ss_s - ss_r\n    \n    # Degrees of Freedom\n    df_s = n - 1\n    df_r = k - 1\n    df_e = (n - 1) * (k - 1)\n\n    # Mean Squares\n    ms_s = ss_s / df_s if df_s > 0 else 0\n    ms_r = ss_r / df_r if df_r > 0 else 0\n    ms_e = ss_e / df_e if df_e > 0 else 0\n\n    # Common numerator for both ICCs\n    numerator = ms_s - ms_e\n\n    # Calculate ICC for Absolute Agreement (ICC(A,1) or ICC(2,1))\n    denominator_abs = ms_s + (k - 1) * ms_e + (k / n) * (ms_r - ms_e)\n    if denominator_abs == 0:\n        icc_abs = np.nan\n    else:\n        icc_abs = numerator / denominator_abs\n\n    # Calculate ICC for Consistency (ICC(C,1) or ICC(3,1))\n    denominator_cons = ms_s + (k - 1) * ms_e\n    if denominator_cons == 0:\n        icc_cons = np.nan\n    else:\n        icc_cons = numerator / denominator_cons\n        \n    return icc_abs, icc_cons\n\ndef solve():\n    \"\"\"\n    Main function to run simulations and print results.\n    \"\"\"\n    test_cases = [\n        # (n, sigma_S, sigma_E, B, S)\n        (40, 10, 3, np.array([0, 0]), np.array([1, 1])),    # Case 1: baseline\n        (40, 10, 3, np.array([0, 5]), np.array([1, 1])),    # Case 2: additive bias\n        (40, 10, 3, np.array([0, 0]), np.array([1, 1.2])),  # Case 3: multiplicative bias\n        (40, 0.1, 3, np.array([0, 5]), np.array([1, 1]))    # Case 4: low subject variability\n    ]\n\n    results = []\n    base_seed = 20231105\n    k = 2\n\n    for i, case in enumerate(test_cases):\n        n, sigma_s, sigma_e, B, S = case\n        seed = base_seed + i\n        rng = np.random.default_rng(seed)\n\n        # Simulate data according to the model Y_ij = S_j * T_i + B_j + E_ij\n        T = rng.normal(loc=0, scale=sigma_s, size=n)\n        E = rng.normal(loc=0, scale=sigma_e, size=(n, k))\n        \n        # Use broadcasting to construct the Y matrix\n        # T[:, np.newaxis] changes T from (n,) to (n, 1)\n        # S and B are broadcast from (k,) to (n, k)\n        Y = T[:, np.newaxis] * S + B + E\n\n        # Calculate ICCs\n        icc_abs, icc_cons = calculate_iccs(Y)\n        results.extend([icc_abs, icc_cons])\n\n    # Format the output string with values rounded to 6 decimal places.\n    # NaN values are formatted as \"nan\".\n    output_str = f\"[{','.join(f'{val:.6f}' for val in results)}]\"\n    print(output_str)\n\nsolve()\n\n```", "id": "4893327"}]}