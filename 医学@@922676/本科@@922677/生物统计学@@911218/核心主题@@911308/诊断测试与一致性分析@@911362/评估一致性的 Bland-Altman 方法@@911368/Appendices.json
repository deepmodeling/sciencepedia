{"hands_on_practices": [{"introduction": "理论是实践的基石。要真正掌握Bland-Altman方法，我们不能仅仅满足于记住“均值 $\\pm 1.96 \\times$ 标准差”这条规则，而应深入理解其统计学根源。本练习将引导你从正态分布的第一性原理出发，推导一致性界限 (Limits of Agreement, LoA)，并进一步探讨如何将此基础扩展到更复杂的异方差情景，即测量误差随测量值的变化而变化的情况。通过这个推导过程，你将对该方法背后的假设和逻辑有更深刻的认识 [@problem_id:4551956]。", "problem": "一个临床实验室希望评估在相同受试者上测量空腹血糖的两种检测方法的一致性。对于每个受试者 $i \\in \\{1,\\dots,n\\}$，设 $A_i$ 和 $B_i$ 表示两种检测结果，定义配对差值 $D_i = B_i - A_i$，以及受试者内均值 $M_i = (A_i + B_i)/2$。一致性界限 (Limits of Agreement, LoA) 是一种广泛使用的、与设计无关的工具，用于生物和临床测量比较中的数据质量评估。假设以下基本前提成立：差值 $\\{D_i\\}$ 是独立同分布的正态随机变量，其均值 $\\mu_d$ 和方差 $\\sigma_d^2$ 未知。\n\n仅使用正态分布的性质和一致性参数估计，完成以下任务：\n\n1) 在同方差模型 $D \\sim \\mathcal{N}(\\mu_d,\\sigma_d^2)$ 下，推导未来差值 $D$ 在 $0.95$ 水平下的总体一致性界限 (LoA)。然后，根据观测到的 $\\{D_i\\}_{i=1}^n$ 的样本均值 $\\bar{d}$ 和样本标准差 $s_d$，推导相应的大样本插入式估计量。\n\n2) 在实践中，临床测量误差可能是异方差的，其系统性偏差和变异性都会随着测量值的大小而变化。考虑异方差条件正态模型\n$$\nD \\mid M=m \\sim \\mathcal{N}\\!\\big(\\,a + b\\,m,\\;\\tau^2\\{1 + \\kappa\\, m^2\\}\\big),\n$$\n其中 $a,b,\\tau,\\kappa$ 是未知常数。仅使用正态分布分位数的定义，推导作为 $m$ 的函数的 $0.95$ 水平下的条件 LoA。\n\n3) 假设一项包含 $n$ 对配对测量的研究，通过对均值结构进行线性回归和对离散度进行方差函数拟合，得到以下拟合值：\n$$\n\\hat{a} = -2.3,\\quad \\hat{b} = 0.015,\\quad \\hat{\\tau} = 3.8,\\quad \\hat{\\kappa} = 1.1\\times 10^{-4}.\n$$\n计算受试者内均值为 $m^{\\star} = 160$ 时，在 $0.95$ 水平下的条件 LoA 上限（最终答案以 mg/dL 表示）。使用水平为 $0.975$ 的标准正态分位数，并将最终答案四舍五入至四位有效数字。", "solution": "在尝试求解之前，对问题陈述进行了严格验证。\n\n### 步骤 1：提取已知条件\n- 对于每个受试者 $i \\in \\{1,\\dots,n\\}$，$A_i$ 和 $B_i$ 是两种检测结果。\n- 配对差值为 $D_i = B_i - A_i$。\n- 受试者内均值为 $M_i = (A_i + B_i)/2$。\n- 差值 $\\{D_i\\}$ 被假定为独立同分布 (i.i.d.) 的正态随机变量。\n- **第 1 部分 (同方差模型):** 对于未来的差值 $D$，模型为 $D \\sim \\mathcal{N}(\\mu_d, \\sigma_d^2)$，其中 $\\mu_d$ 和 $\\sigma_d^2$ 未知。任务是推导 $0.95$ 水平下的总体一致性界限 (LoA)，并使用 $\\{D_i\\}_{i=1}^n$ 的样本均值 $\\bar{d}$ 和样本标准差 $s_d$ 推导其大样本插入式估计量。\n- **第 2 部分 (异方差模型):** 在给定均值 $M=m$ 的条件下，差值 $D$ 的条件分布被指定为 $D \\mid M=m \\sim \\mathcal{N}(a + b\\,m, \\tau^2\\{1 + \\kappa\\,m^2\\})$，其中 $a, b, \\tau, \\kappa$ 为未知常数。任务是推导作为 $m$ 的函数的 $0.95$ 水平下的条件 LoA。\n- **第 3 部分 (计算):** 给定一项研究的拟合值：$\\hat{a} = -2.3$，$\\hat{b} = 0.015$，$\\hat{\\tau} = 3.8$，以及 $\\hat{\\kappa} = 1.1 \\times 10^{-4}$。任务是计算受试者内均值为 $m^{\\star} = 160$ 时，在 $0.95$ 水平下的条件 LoA 上限。需使用水平为 $0.975$ 的标准正态分位数。最终答案应四舍五入至四位有效数字。\n\n### 步骤 2：使用提取的已知条件进行验证\n- **科学依据：** 该问题坚实地基于 Bland-Altman 方法，这是一种用于评估两种临床测量技术之间一致性的标准且广为接受的方法，应用于生物统计学、临床化学和医学诊断领域。测量误差的同方差性和异方差性概念是该领域的核心。指定的正态分布模型是标准的统计假设。\n- **问题适定性：** 问题结构清晰，分为三个不同的部分，每个部分都有一个具体且可解的任务。模型有数学上的定义，目标（推导和计算）明确。每个部分都存在唯一且有意义的解。\n- **客观性：** 问题以精确、客观的数学和统计语言陈述。没有主观或基于观点的陈述。\n- **完整性：** 提供了所有必要的信息。模型、参数、数据摘要 ($\\bar{d}, s_d$)、拟合值以及要使用的特定分位数都已明确说明。\n- **一致性与真实性：** 设定是内部一致的。从简单的同方差模型过渡到更现实的异方差模型，反映了数据分析中的常见做法。对于像以 mg/dL 为单位的血糖测量值，拟合参数的数值是合理的。\n\n### 步骤 3：结论与行动\n该问题是有效的，因为它具有科学依据、问题适定、客观且信息完备。将继续进行求解过程。\n\n***\n\n### 求解推导\n\n**1) 同方差一致性界限**\n\n问题要求在 $0.95$ 置信水平下，求解总体水平的一致性界限 (LoA)。在同方差模型下，假定未来的差值 $D$ 服从正态分布，$D \\sim \\mathcal{N}(\\mu_d, \\sigma_d^2)$。\n\nLoA 定义为一个区间，该区间预期包含测量值之间特定比例（此处为 $0.95$）的差值。对于正态分布，一个以均值为中心的对称区间包含总体中 $1-\\alpha$ 的比例。该区间由 $[\\mu - z_{1-\\alpha/2}\\sigma, \\mu + z_{1-\\alpha/2}\\sigma]$ 给出，其中 $z_{q}$ 是标准正态分布的 $q$ 分位数。\n\n对于 $0.95$ 的水平，我们有 $1-\\alpha = 0.95$，这意味着 $\\alpha = 0.05$ 且 $\\alpha/2 = 0.025$。因此，我们需要 $1-0.025 = 0.975$ 分位数，记为 $z_{0.975}$。其数值约为 $z_{0.975} \\approx 1.96$。\n\n因此，总体水平的 LoA 为：\n$$\n\\text{LoA}_{\\text{pop}} = \\mu_d \\pm z_{0.975} \\sigma_d\n$$\n这代表了理论区间，如果真实的总体参数 $\\mu_d$ 和 $\\sigma_d$ 已知，则 $95\\%$ 的未来差值预期会落入此区间。\n\n在实践中，$\\mu_d$ 和 $\\sigma_d$ 是未知的，必须从差值样本 $\\{D_i\\}_{i=1}^n$ 中估计。问题要求提供大样本插入式估计量。总体均值 $\\mu_d$ 和总体标准差 $\\sigma_d$ 的一致性估计量分别是样本均值 $\\bar{d}$ 和样本标准差 $s_d$，其中：\n$$\n\\bar{d} = \\frac{1}{n} \\sum_{i=1}^n D_i \\quad \\text{and} \\quad s_d = \\sqrt{\\frac{1}{n-1} \\sum_{i=1}^n (D_i - \\bar{d})^2}\n$$\n插入法原理包括将这些样本估计值代入总体水平 LoA 的公式中，以替代未知的总体参数。这产生了基于样本的 LoA 估计量：\n$$\n\\widehat{\\text{LoA}} = \\bar{d} \\pm z_{0.975} s_d\n$$\n这就是所要求的大样本插入式估计量。使用正态分位数 $z_{0.975}$ 而非 t 分布分位数是合理的，因为题目中指定了“大样本”。\n\n**2) 异方差一致性界限**\n\n问题引入了一个更复杂的模型，其中差值 $D$ 的分布取决于测量值的大小，由受试者内均值 $M=m$ 表示。条件分布如下：\n$$\nD \\mid M=m \\sim \\mathcal{N}\\!\\big(a + b\\,m, \\tau^2\\{1 + \\kappa\\,m^2\\}\\big)\n$$\n这指定了一个正态分布，其均值和方差都是 $m$ 的函数。\n$D$ 的条件均值为 $\\mu_{D|m} = a + b\\,m$。\n$D$ 的条件方差为 $\\sigma_{D|m}^2 = \\tau^2\\{1 + \\kappa\\,m^2\\}$。\n条件标准差是方差的平方根：\n$$\n\\sigma_{D|m} = \\sqrt{\\tau^2\\{1 + \\kappa\\,m^2\\}} = |\\tau|\\sqrt{1 + \\kappa\\,m^2}\n$$\n由于 $\\tau^2$ 是一个方差参数，它必须是非负的。我们可以将 $\\tau$ 定义为其正平方根，因此 $|\\tau| = \\tau$。\n$$\n\\sigma_{D|m} = \\tau\\sqrt{1 + \\kappa\\,m^2}\n$$\n遵循第 1 部分中的相同逻辑，对于一个固定的 $m$ 值，其 $0.95$ LoA 是通过构建一个围绕条件均值的区间来找到的，该区间的范围是 $\\pm z_{0.975}$ 倍的条件标准差。\n因此，作为 $m$ 的函数的条件 LoA 是：\n$$\n\\text{LoA}(m) = \\mu_{D|m} \\pm z_{0.975} \\sigma_{D|m}\n$$\n代入条件均值和标准差的表达式：\n$$\n\\text{LoA}(m) = (a + b\\,m) \\pm z_{0.975} \\tau\\sqrt{1 + \\kappa\\,m^2}\n$$\n这个表达式给出了一致性界限的上限和下限，它们随平均测量值 $m$ 而变化。\n\n**3) 条件 LoA 上限的计算**\n\n任务是计算受试者内均值为 $m^{\\star} = 160$ 时，在 $0.95$ 水平下的条件 LoA 上限。给定 $m$ 时的条件 LoA 上限公式为：\n$$\n\\text{Upper LoA}(m) = (a + b\\,m) + z_{0.975} \\tau\\sqrt{1 + \\kappa\\,m^2}\n$$\n问题提供了以下估计参数值：\n$\\hat{a} = -2.3$\n$\\hat{b} = 0.015$\n$\\hat{\\tau} = 3.8$\n$\\hat{\\kappa} = 1.1 \\times 10^{-4}$\n\n给定 $m^{\\star} = 160$。我们将使用标准正态分位数 $z_{0.975} \\approx 1.959964$。根据普遍惯例，我们将使用值 $z_{0.975}=1.96$。\n\n首先，我们计算在 $m^{\\star} = 160$ 时的估计条件均值：\n$$\n\\hat{\\mu}_{D|m=160} = \\hat{a} + \\hat{b}\\,m^{\\star} = -2.3 + (0.015)(160) = -2.3 + 2.4 = 0.1\n$$\n接下来，我们计算在 $m^{\\star} = 160$ 时的估计条件标准差：\n$$\n\\hat{\\sigma}_{D|m=160} = \\hat{\\tau}\\sqrt{1 + \\hat{\\kappa}(m^{\\star})^2} = 3.8 \\sqrt{1 + (1.1 \\times 10^{-4})(160)^2}\n$$\n我们计算平方根内的项：\n$$\n1 + (1.1 \\times 10^{-4})(160)^2 = 1 + (1.1 \\times 10^{-4})(25600) = 1 + 1.1 \\times 2.56 = 1 + 2.816 = 3.816\n$$\n现在，将此结果代回标准差的表达式中：\n$$\n\\hat{\\sigma}_{D|m=160} = 3.8 \\sqrt{3.816} \\approx 3.8 \\times 1.9534585 = 7.4231423\n$$\n最后，我们计算估计的条件 LoA 上限：\n$$\n\\widehat{\\text{Upper LoA}}(160) = \\hat{\\mu}_{D|m=160} + z_{0.975} \\hat{\\sigma}_{D|m=160}\n$$\n$$\n\\widehat{\\text{Upper LoA}}(160) \\approx 0.1 + (1.96)(7.4231423)\n$$\n$$\n\\widehat{\\text{Upper LoA}}(160) \\approx 0.1 + 14.5493589\n$$\n$$\n\\widehat{\\text{Upper LoA}}(160) \\approx 14.6493589\n$$\n问题要求答案四舍五入至四位有效数字。数字 $14.6493589$ 四舍五入至四位有效数字是 $14.65$。根据问题上下文，单位默认为 mg/dL，但最终的方框答案中不包含单位。", "answer": "$$\n\\boxed{14.65}\n$$", "id": "4551956"}, {"introduction": "将理论知识转化为实际技能是学习过程中的关键一步。本练习旨在通过编程实践，让你亲手实现Bland-Altman分析的核心计算过程。你将编写一个程序，从原始的配对数据出发，计算偏倚 (bias)、一致性界限 (Limits of Agreement)，并执行一个简单的线性回归来检验是否存在比例偏倚。这个过程不仅能巩固你对相关公式的理解，还能让你构建一个未来可复用的数据分析工具 [@problem_id:4898488]。", "problem": "构建一个完整的、可运行的程序。该程序根据在同一组受试者上使用两种方法得到的配对测量值，计算用于评估一致性的 Bland-Altman 方法中的关键量。计算必须从数理统计的第一性原理出发，仅使用核心定义和经过充分检验的事实，并且不得依赖任何针对此方法的预打包快捷方式。对于每个数据集，执行以下操作。\n\n- 使用以下基本定义和事实。\n  - 对于配对观测值 $\\{(x_i,y_i)\\}_{i=1}^n$，将每个受试者的均值 $m_i$ 和差值 $d_i$ 定义为 $m_i = (x_i + y_i)/2$ 和 $d_i = x_i - y_i$。\n  - 任何单变量数据 $\\{z_i\\}_{i=1}^n$ 的样本均值为 $\\bar{z} = \\frac{1}{n}\\sum_{i=1}^n z_i$。\n  - 带 Bessel 校正的样本方差为 $s_z^2 = \\frac{1}{n-1}\\sum_{i=1}^n (z_i - \\bar{z})^2$，样本标准差为 $s_z = \\sqrt{s_z^2}$。\n  - 在差值 $\\{d_i\\}$ 的分布近似为正态分布的工作假设下，可以使用标准正态分位数 $z_{1 - (1-c)/2}$ 构建名义覆盖率为 $c$ 的双侧中心覆盖区间，其中 $z_q$ 表示标准正态分布的 $q$-分位数。\n  - 为评估比例偏倚，通过普通最小二乘法 (OLS) 对差值与均值拟合一个简单线性模型：$d_i = \\beta_0 + \\beta_1 m_i + \\varepsilon_i$。使用核心线性回归恒等式，斜率估计量为 $\\hat{\\beta}_1 = \\frac{\\sum_{i=1}^n (m_i - \\bar{m})(d_i - \\bar{d})}{\\sum_{i=1}^n (m_i - \\bar{m})^2}$，前提是分母为正。残差平方和为 $\\mathrm{SSE} = \\sum_{i=1}^n (d_i - \\hat{\\beta}_0 - \\hat{\\beta}_1 m_i)^2$，其中 $\\hat{\\beta}_0 = \\bar{d} - \\hat{\\beta}_1 \\bar{m}$，自由度为 $\\mathrm{DF} = n - 2$，斜率的估计方差为 $\\widehat{\\mathrm{Var}}(\\hat{\\beta}_1) = \\frac{\\widehat{\\sigma}^2}{\\sum_{i=1}^n (m_i - \\bar{m})^2}$，其中 $\\widehat{\\sigma}^2 = \\mathrm{SSE}/\\mathrm{DF}$。对于无比例偏倚的双侧假设检验 $H_0\\!:\\,\\beta_1=0$ 与 $H_1\\!:\\,\\beta_1\\neq 0$，使用自由度为 $\\mathrm{DF}$ 的 $t$-统计量 $T = \\frac{\\hat{\\beta}_1}{\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_1)}}$，通过 Student’s $t$ 分布的累积分布函数计算双侧 $p$-值。\n- 对于每个数据集，计算：\n  - 偏倚 $\\bar{d}$（$\\{d_i\\}$ 的样本均值）。\n  - $\\{d_i\\}$ 的样本标准差 $s_d$。\n  - 一致性界限的 $c$-覆盖率，定义为在正态工作模型下，使用水平为 $1 - (1-c)/2$ 的标准正态分位数得到的 $\\{d_i\\}$ 分布的对称双侧中心覆盖区间的端点。\n  - 将 $d_i$ 对 $m_i$ 进行回归得到的 OLS 斜率 $\\hat{\\beta}_1$，以及 $H_0\\!:\\,\\beta_1=0$ 的双侧 $p$-值。\n- 使用以下边缘情况约定以确保数值稳健性和可定义性：\n  - 如果 $\\{d_i\\}$ 的样本方差为零，则将一致性界限的上下限均设为偏倚（这与退化正态模型下的区间构造一致）。\n  - 如果 $\\sum_{i=1}^n (m_i - \\bar{m})^2 = 0$ 或 $n \\le 2$，则定义 $\\hat{\\beta}_1 = 0$ 且 $p$-值为 $1$。\n  - 否则，按上述方法计算 OLS 各量；如果估计的残差方差为零（即 $\\mathrm{SSE} = 0$），则当 $\\hat{\\beta}_1 \\ne 0$ 时定义双侧 $p$-值为 $0$，当 $\\hat{\\beta}_1 = 0$ 时定义为 $1$。\n- 始终使用覆盖率 $c = 0.95$。将 $c$ 写成小数形式，并使用如上定义的标准正态分位数 $z_{1 - (1-c)/2}$。\n\n测试套件。你的程序必须精确评估以下五个数据集，每个数据集由等长 $n$ 的配对列表 $x$ 和 $y$ 组成。\n\n- 数据集 A（一般情况，$n = 10$）：\n  - $x = [98.6,102.1,87.5,110.0,95.3,100.2,105.8,99.9,92.4,101.5]$\n  - $y = [97.9,101.7,88.1,109.2,96.0,99.4,106.5,100.1,93.0,100.8]$\n- 数据集 B（完全一致，$n = 5$）：\n  - $x = [10.0,12.0,14.0,16.0,18.0]$\n  - $y = [10.0,12.0,14.0,16.0,18.0]$\n- 数据集 C（恒定偏倚，$n = 5$）：\n  - $x = [50.0,60.0,70.0,80.0,90.0]$\n  - $y = [52.0,62.0,72.0,82.0,92.0]$\n- 数据集 D（具有精确线性关系的比例偏倚，$n = 7$）：\n  - $x = [20.0,25.0,30.0,35.0,40.0,45.0,50.0]$\n  - $y = [18.0,22.5,27.0,31.5,36.0,40.5,45.0]$\n- 数据集 E（小样本，$n = 3$）：\n  - $x = [5.0,5.5,6.0]$\n  - $y = [5.2,5.1,5.9]$\n\n算法要求。\n\n- 对于每个数据集，计算一个包含五个浮点数的结果列表：$[\\bar{d}, L, U, \\hat{\\beta}_1, p]$，其中 $L$ 和 $U$ 是针对 $c = 0.95$ 按上述方法构建的一致性下限和上限，$p$ 是在 $d$ 对 $m$ 的 OLS 回归中检验 $H_0\\!:\\,\\beta_1=0$ 的双侧 $p$-值。\n- 使用标准的四舍五入将每个结果列表中的每个浮点数舍入到 $6$ 位小数，如果你的语言默认使用银行家舍入法，则将恰好一半的情况舍入到远离零的方向。\n\n最终输出格式。\n\n- 你的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果，每个数据集的结果本身也是一个用方括号括起来的逗号分隔列表，并且任何地方都没有空格。例如，一个有效的形状是 $[[a_1,a_2,a_3,a_4,a_5],[b_1,b_2,b_3,b_4,b_5],\\dots]$，其中每个占位符都由一个按规定舍入到 $6$ 位的小数替换。\n- 必须正好有五个这样的内部列表，按顺序对应数据集 A 到 E。\n\n不涉及物理单位。所有角度（如有）都与此任务无关。所有比例（如覆盖率 $c$）都必须以小数表示，不得使用百分号。", "solution": "我们从核心统计定义出发，推导 Bland-Altman 方法和比例偏倚评估所需的量，然后将这些推导转化为适用于每个数据集的算法。\n\n给定来自两种方法对相同 $n$ 名受试者的配对测量值 $\\{(x_i,y_i)\\}_{i=1}^n$，对每个受试者 $i$ 定义其受试者内均值 $m_i$ 和差值 $d_i$ 为\n$$\nm_i \\;=\\; \\frac{x_i + y_i}{2},\\qquad d_i \\;=\\; x_i - y_i.\n$$\n这些是 Bland-Altman 框架的基本构造：差值 $\\{d_i\\}$ 捕捉了不一致性，其分布特征（位置和离散程度）是主要关注点，而均值 $\\{m_i\\}$ 提供了一个自然的协变量，用于检查不一致性与测量值大小之间是否存在任何关系（比例偏倚）。\n\n差值的偏倚（位置）是样本均值\n$$\n\\bar{d} \\;=\\; \\frac{1}{n}\\sum_{i=1}^n d_i.\n$$\n差值的离散程度通过带 Bessel 校正的样本标准差来衡量\n$$\ns_d \\;=\\; \\sqrt{\\frac{1}{n-1}\\sum_{i=1}^n (d_i - \\bar{d})^2}.\n$$\n在差值分布近似为正态分布的工作模型下，使用标准正态分位数构建差值分布的名义覆盖率为 $c$ 的双侧中心覆盖区间。令\n$$\nz_{1 - (1-c)/2}\n$$\n表示标准正态分布的 $(1 - (1-c)/2)$-分位数。以 $\\bar{d}$ 为中心，半宽为 $z_{1 - (1-c)/2}\\,s_d$ 的中心覆盖区间为\n$$\n[\\;\\bar{d} - z_{1 - (1-c)/2}\\,s_d,\\;\\bar{d} + z_{1 - (1-c)/2}\\,s_d\\;].\n$$\n在 Bland-Altman 的背景下，这被称为一致性界限。如果 $s_d = 0$（所有差值相等），正态模型退化为退化分布，上述区间的两个端点都等于 $\\bar{d}$；我们采用此约定。\n\n为了评估比例偏倚（即不一致性是否取决于测量值的大小），通过普通最小二乘法 (OLS) 将差值对受试者内均值进行回归。模型为\n$$\nd_i \\;=\\; \\beta_0 + \\beta_1 m_i + \\varepsilon_i,\\quad i=1,\\dots,n,\n$$\n其中 OLS 斜率由下式给出\n$$\n\\hat{\\beta}_1 \\;=\\; \\frac{S_{xy}}{S_{xx}},\\qquad S_{xy} \\;=\\; \\sum_{i=1}^n (m_i - \\bar{m})(d_i - \\bar{d}),\\qquad S_{xx} \\;=\\; \\sum_{i=1}^n (m_i - \\bar{m})^2,\n$$\n截距为 $\\hat{\\beta}_0 = \\bar{d} - \\hat{\\beta}_1 \\bar{m}$，其中 $\\bar{m}$ 是 $\\{m_i\\}$ 的样本均值。如果 $S_{xx} = 0$（$m_i$ 没有变异）或 $n \\le 2$，斜率因除法而未定义，OLS 无法估计；在这种情况下，我们定义 $\\hat{\\beta}_1 = 0$ 且 $p$-值为 $1$。\n\n对于双侧检验 $H_0\\!:\\,\\beta_1=0$ 与 $H_1\\!:\\,\\beta_1\\neq 0$，残差平方和为\n$$\n\\mathrm{SSE} \\;=\\; \\sum_{i=1}^n \\bigl(d_i - \\hat{\\beta}_0 - \\hat{\\beta}_1 m_i\\bigr)^2 \\;=\\; S_{yy} - \\hat{\\beta}_1 S_{xy},\\qquad S_{yy} \\;=\\; \\sum_{i=1}^n (d_i - \\bar{d})^2,\n$$\n自由度为 $\\mathrm{DF} = n - 2$，残差方差估计量为 $\\widehat{\\sigma}^2 = \\mathrm{SSE}/\\mathrm{DF}$。斜率的估计方差为\n$$\n\\widehat{\\mathrm{Var}}(\\hat{\\beta}_1) \\;=\\; \\frac{\\widehat{\\sigma}^2}{S_{xx}},\n$$\n因此 $t$-统计量为\n$$\nT \\;=\\; \\frac{\\hat{\\beta}_1}{\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_1)}} \\;=\\; \\frac{\\hat{\\beta}_1}{\\sqrt{\\widehat{\\sigma}^2/S_{xx}}}\n$$\n双侧 $p$-值为 $p = 2\\bigl(1 - F_{t,\\mathrm{DF}}(|T|)\\bigr)$，其中 $F_{t,\\mathrm{DF}}$ 是自由度为 $\\mathrm{DF}$ 的 Student’s $t$ 分布的累积分布函数。如果 $\\mathrm{SSE} = 0$（完全拟合），则 $\\widehat{\\sigma}^2 = 0$ 且 $\\hat{\\beta}_1$ 的标准误为零；我们采用约定，如果 $\\hat{\\beta}_1 \\ne 0$ 则 $p = 0$，如果 $\\hat{\\beta}_1 = 0$ 则 $p = 1$。\n\n每个数据集的算法转换：\n1. 从 $\\{x_i\\}$ 和 $\\{y_i\\}$ 构建数组 $\\{d_i\\}$ 和 $\\{m_i\\}$。\n2. 使用上述定义计算 $\\bar{d}$ 和 $s_d$。\n3. 当 $c = 0.95$ 时，从标准正态分布计算 $z_{1 - (1-c)/2} = z_{0.975}$，并设置 $L = \\bar{d} - z_{0.975}s_d$，$U = \\bar{d} + z_{0.975}s_d$。如果 $s_d = 0$，则设置 $L = U = \\bar{d}$。\n4. 计算 $S_{xx}$ 和 $S_{xy}$。如果 $S_{xx} = 0$ 或 $n \\le 2$，则设置 $\\hat{\\beta}_1 = 0$ 且 $p = 1$。否则，计算 $\\hat{\\beta}_1 = S_{xy}/S_{xx}$，$\\hat{\\beta}_0 = \\bar{d} - \\hat{\\beta}_1 \\bar{m}$，然后计算 $\\mathrm{SSE} = \\sum_{i=1}^n (d_i - \\hat{\\beta}_0 - \\hat{\\beta}_1 m_i)^2$。如果 $\\mathrm{SSE} = 0$ 且 $\\hat{\\beta}_1 \\ne 0$，则设置 $p = 0$；如果 $\\mathrm{SSE} = 0$ 且 $\\hat{\\beta}_1 = 0$，则设置 $p = 1$；否则，计算 $\\widehat{\\sigma}^2 = \\mathrm{SSE}/(n-2)$、标准误 $\\sqrt{\\widehat{\\sigma}^2/S_{xx}}$、$t$-统计量 $T$ 和 $p$ 值（如上所述）。\n5. 将 $\\bar{d}$、$L$、$U$、$\\hat{\\beta}_1$ 和 $p$ 舍入到 $6$ 位小数。\n6. 将五元组输出为列表，并将所有五个数据集的列表聚合成一个单一列表，打印在单行上，不含空格。\n\n所提供数据集的说明性数值特征（为便于说明，已舍入到合理精度；程序将计算并舍入到 $6$ 位小数）：\n- 数据集 A：$n = 10$，$\\bar{d} \\approx 0.060000$，$s_d \\approx 0.6769$，因此界限为 $L \\approx -1.2667$，$U \\approx 1.3867$；OLS 斜率 $\\hat{\\beta}_1 \\approx 0.0529$，双侧 $p$-值中等偏大（约为 $0.1$ 到 $0.2$）。\n- 数据集 B：所有差值均为零，因此 $\\bar{d} = 0$，$s_d = 0$，且 $L = U = 0$；斜率设为 $0$，$p$ 值为 $1$。\n- 数据集 C：恒定偏倚约为 $-2$，因此 $\\bar{d} = -2$，$s_d = 0$，且 $L = U = -2$；斜率为 $0$，$p$ 值为 $1$。\n- 数据集 D：精确比例偏倚 $d_i = \\frac{2}{19} m_i$，因此 $\\hat{\\beta}_1 = \\frac{2}{19} \\approx 0.105263$，完全拟合，$\\mathrm{SSE} = 0$，因此 $p = 0$；差值具有非零离散度，所以界限是有限的，围绕 $\\bar{d} = 3.5$ 分布，其中 $L \\approx 1.382$，$U \\approx 5.618$。\n- 数据集 E：小样本，$n = 3$，$\\bar{d} = 0.1$，$s_d = 0.3$，界限为 $L \\approx -0.487989$，$U \\approx 0.687989$，斜率 $\\hat{\\beta}_1 \\approx 0.151899$，由于 $\\mathrm{DF} = 1$，双侧 $p$-值非常大。\n\n所提供的程序将完全按照规定执行这些计算，使用 $z_{0.975}$ 处的标准正态分位数和 Student’s $t$ 分布进行比例偏倚检验，根据上述约定处理边缘情况，并以所需格式打印单行结果，每个浮点数都舍入到 $6$ 位小数。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm, t\n\ndef bland_altman_metrics(x, y, coverage=0.95):\n    x = np.asarray(x, dtype=float)\n    y = np.asarray(y, dtype=float)\n    if x.shape != y.shape:\n        raise ValueError(\"x and y must have the same shape\")\n    n = x.size\n    d = x - y\n    m = (x + y) / 2.0\n\n    # Bias and sample SD of differences with Bessel's correction\n    d_bar = float(np.mean(d))\n    # Handle n == 1 separately to avoid ddof > n-1; but our tests have n >= 3\n    sd = float(np.std(d, ddof=1)) if n > 1 else 0.0\n\n    # Limits of agreement using standard normal quantile\n    alpha = 1.0 - coverage\n    z = float(norm.ppf(1.0 - alpha / 2.0))\n    if sd == 0.0:\n        loa_lower = d_bar\n        loa_upper = d_bar\n    else:\n        half_width = z * sd\n        loa_lower = d_bar - half_width\n        loa_upper = d_bar + half_width\n\n    # Proportional bias via OLS regression of d on m\n    m_bar = float(np.mean(m))\n    # Centered sums\n    dm = m - m_bar\n    dd = d - d_bar\n    Sxx = float(np.sum(dm * dm))\n    Sxy = float(np.sum(dm * dd))\n\n    # Edge cases for slope\n    if Sxx == 0.0 or n = 2:\n        slope = 0.0\n        p_value = 1.0\n    else:\n        slope = Sxy / Sxx\n        intercept = d_bar - slope * m_bar\n        residuals = d - (intercept + slope * m)\n        SSE = float(np.sum(residuals * residuals))\n        df = n - 2\n        if SSE == 0.0:\n            # Perfect fit or numerical zero\n            p_value = 0.0 if abs(slope) > 0.0 else 1.0\n        else:\n            sigma2_hat = SSE / df\n            var_slope = sigma2_hat / Sxx\n            # Guard against numerical issues\n            if var_slope = 0.0:\n                p_value = 0.0 if abs(slope) > 0.0 else 1.0\n            else:\n                se_slope = np.sqrt(var_slope)\n                t_stat = slope / se_slope\n                # Two-sided p-value from Student's t distribution\n                p_value = float(2.0 * (1.0 - t.cdf(abs(t_stat), df)))\n\n    return d_bar, loa_lower, loa_upper, slope, p_value\n\ndef round6(x):\n    # Standard rounding to 6 decimal places, away from zero for .5 cases\n    return \"{:.6f}\".format(np.round(x + 1e-9 * np.sign(x), 6))\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Dataset A\n        (\n            [98.6,102.1,87.5,110.0,95.3,100.2,105.8,99.9,92.4,101.5],\n            [97.9,101.7,88.1,109.2,96.0,99.4,106.5,100.1,93.0,100.8]\n        ),\n        # Dataset B\n        (\n            [10.0,12.0,14.0,16.0,18.0],\n            [10.0,12.0,14.0,16.0,18.0]\n        ),\n        # Dataset C\n        (\n            [50.0,60.0,70.0,80.0,90.0],\n            [52.0,62.0,72.0,82.0,92.0]\n        ),\n        # Dataset D\n        (\n            [20.0,25.0,30.0,35.0,40.0,45.0,50.0],\n            [18.0,22.5,27.0,31.5,36.0,40.5,45.0]\n        ),\n        # Dataset E\n        (\n            [5.0,5.5,6.0],\n            [5.2,5.1,5.9]\n        ),\n    ]\n\n    coverage = 0.95\n    results = []\n    for x, y in test_cases:\n        d_bar, L, U, slope, p_val = bland_altman_metrics(x, y, coverage=coverage)\n        # Round to 6 decimals as strings\n        res_strs = [round6(d_bar), round6(L), round6(U), round6(slope), round6(p_val)]\n        results.append(res_strs)\n\n    # Build the exact required format: a single line, no spaces, nested lists\n    inner = []\n    for res in results:\n        inner.append(\"[\" + \",\".join(res) + \"]\")\n    output = \"[\" + \",\".join(inner) + \"]\"\n    print(output)\n\nsolve()\n```", "id": "4898488"}, {"introduction": "计算得出结果仅仅是分析的一半，正确的解读才是最终目的。在实际应用中，我们常常需要区分Bland-Altman方法与其他统计工具的用途，以避免得出错误的结论。本练习设置了一个典型的场景，在该场景中，Bland-Altman分析的结论似乎与等效性检验 (equivalence testing) 的结论相悖。这道题目将挑战你深入思考这两种方法各自解决的不同科学问题，从而培养你在真实世界中做出准确判断所必需的批判性思维能力 [@problem_id:4898491]。", "problem": "一个临床实验室正在评估一种新的无创血压监测仪是否可以替代基于袖带的参考设备来测量收缩压。对于 $n = 50$ 名成年人，每位受试者都在 $10$ 分钟内使用了两种设备，并定义了每位受试者的配对差异为 $d_i = X_i - Y_i$，其中 $X_i$ 是新设备的测量值，$Y_i$ 是参考设备的测量值。生物统计学家将这些配对差异总结为样本均值 $\\bar{d} = -2$ 毫米汞柱和样本标准差 $s_d = 6$ 毫米汞柱。预先设定的临床可接受范围为 $\\Delta = 5$ 毫米汞柱。\n\n考虑两种互补的方法：\n\n- Bland–Altman 一致性评估方法 (BA)，该方法通过图形和基于区间的总结（包括一致性界限）来检验个体差异的分布，并且主要是描述性的而非推断性的。\n\n- 基于双单侧检验 (TOST) 框架的等效性检验，在显著性水平 $\\alpha = 0.05$ 下，检验总体均值差异 $\\mu_d$ 是否在预设范围 $\\pm \\Delta$ 内。\n\n根据这些总结信息和每种方法的基本定义，以下哪个/哪些陈述是正确的？\n\nA. 在给定 $\\bar{d} = -2$，$s_d = 6$，$n = 50$ 和 $\\Delta = 5$ 的情况下，Bland–Altman 方法和等效性检验都会得出结论，认为替代参考设备具有可接受的一致性。\n\nB. 在这些数据下，等效性检验可能会宣布平均偏差在 $\\pm \\Delta$ 范围内，而 Bland–Altman 分析则会因为个体差异的散布相对于 $\\pm \\Delta$ 来说太宽而表明缺乏一致性。\n\nC. Bland–Altman 分析是一种正式的假设检验，等同于检验 $H_0: \\mu_d = 0$ 和 $H_1: \\mu_d \\neq 0$。\n\nD. 如果 $95\\%$ 的一致性界限超出了 $\\pm \\Delta$，增加样本量 $n$ 必然会使这些界限回到 $\\pm \\Delta$ 之内。\n\nE. 等效性检验和 Bland–Altman 方法针对不同的总体目标：前者针对平均差异 $\\mu_d$，而后者针对个体差异的分布；因此，在相同的数据和范围 $\\Delta$ 下，它们可能得出不同的结论。", "solution": "该问题描述了一项方法比较研究，旨在评估一种新的血压监测仪与参考设备的对比情况。它为配对差异提供了汇总统计数据，并要求评估关于两种常用分析方法（Bland-Altman (BA) 方法和等效性检验 (TOST)）的几个陈述。\n\n### 问题验证\n\n**第一步：提取已知条件**\n\n*   新设备测量值：$X_i$\n*   参考设备测量值：$Y_i$\n*   受试者 $i$ 的配对差异：$d_i = X_i - Y_i$\n*   样本量：$n = 50$\n*   差异的样本均值：$\\bar{d} = -2$ 毫米汞柱 (mmHg)\n*   差异的样本标准差：$s_d = 6$ 毫米汞柱 (mmHg)\n*   预设的临床可接受范围：$\\Delta = 5$ 毫米汞柱 (mmHg)，意味着区间为 $[-\\Delta, \\Delta] = [-5, 5]$ 毫米汞柱。\n*   方法1：Bland-Altman (BA) 一致性评估方法，被描述为检查个体差异的分布，包括一致性界限，并且主要是描述性的。\n*   方法2：通过双单侧检验 (TOST) 框架进行的等效性检验。\n*   TOST 的显著性水平：$\\alpha = 0.05$。\n*   TOST 的目标：检验总体均值差异 $\\mu_d$ 是否在范围 $\\pm \\Delta$ 内。\n\n**第二步：使用提取的已知条件进行验证**\n\n*   **科学依据：** 该问题设置在方法比较研究的标准且完善的生物统计学框架内。Bland-Altman 方法和用于等效性的 TOST 是该领域的基本技术。所提供的均值差异、标准差、样本量和临床范围的数值对于收缩压测量研究是现实的。该问题遵循公认的科学原则。\n*   **定义明确：** 该问题提供了执行 Bland-Altman 方法和等效性检验所需的所有必要数据和定义。问题要求基于这些定义的方法和数据来评估陈述，这是一个定义明确、答案唯一的任务。\n*   **客观性：** 该问题使用精确、客观和标准的统计术语陈述。问题陈述中没有歧义、主观性或基于意见的语言。\n\n**第三步：判断与行动**\n\n该问题陈述在科学上是合理的、定义明确且客观的。它是有效的。我将继续推导解决方案。\n\n### 求解过程\n\n核心任务是使用 Bland-Altman (BA) 方法和双单侧检验 (TOST) 等效性框架来分析所提供的数据，然后利用这些分析来评估给出的陈述。\n\n**1. Bland-Altman (BA) 分析**\n\nBA 方法通过计算一致性界限 (LoA) 来评估一致性，该界限提供了一个区间，预计未来约 $95\\%$ 的个体差异会落入其中。LoA 的计算公式为：\n$$ \\text{LoA} = \\bar{d} \\pm z_{1-\\alpha/2} s_d $$\n对于 $95\\%$ 的区间，我们使用标准正态分位数 $z_{0.975} = 1.96$。一个常见的近似值是使用 $\\approx 2$，特别是在 Bland 和 Altman 的原始论文中，但使用 $1.96$ 更为精确。\n\n给定 $\\bar{d} = -2$ 和 $s_d = 6$：\n$$ \\text{LoA} = -2 \\pm (1.96 \\times 6) $$\n$$ \\text{LoA} = -2 \\pm 11.76 $$\n这给出了区间 $[-13.76, 9.76]$ 毫米汞柱。\n\n通过将这些 LoA 与预设的临床可接受范围 $\\pm \\Delta = \\pm 5$ 毫米汞柱进行比较来判断一致性。计算出的 LoA 为 $[-13.76, 9.76]$，远宽于可接受的范围 $[-5, 5]$。这表明，对于单个受试者，两种设备之间的差异可能高达 $-13.76$ 毫米汞柱或 $+9.76$ 毫米汞柱，这在临床上是不可接受的。因此，BA 分析会得出结论，认为这两种设备不具有可接受的一致性，不能互换使用。\n\n**2. 等效性检验 (TOST) 分析**\n\nTOST 程序旨在确定总体均值差异 $\\mu_d$ 是否足够小，以至于在临床上可以忽略不计，即它是否位于等效性范围 $[-\\Delta, \\Delta]$ 内。这是通过检验两个单侧原假设来完成的：\n$$ H_{01}: \\mu_d \\le -\\Delta \\quad \\text{和} \\quad H_{02}: \\mu_d \\ge \\Delta $$\n如果在显著性水平 $\\alpha = 0.05$ 下，每个检验的统计量都显著，我们就拒绝两个原假设并得出等效性的结论。一个等效且更直观的方法是构建 $\\mu_d$ 的 $(1 - 2\\alpha)$ 置信区间，并检查它是否完全包含在区间 $[-\\Delta, \\Delta]$ 内。\n\n当 $\\alpha=0.05$ 时，我们计算 $\\mu_d$ 的 $(1 - 2 \\times 0.05) = 90\\%$ 置信区间。公式是：\n$$ \\text{CI for } \\mu_d = \\bar{d} \\pm t_{1-\\alpha, n-1} \\frac{s_d}{\\sqrt{n}} $$\n给定 $\\bar{d} = -2$，$s_d = 6$，$n = 50$ 和 $\\alpha=0.05$。自由度为 $n-1 = 49$。临界值为 $t_{0.95, 49}$。从 t 分布表或软件中查得，$t_{0.95, 49} \\approx 1.6766$。\n\n均值差异的标准误为：\n$$ SE(\\bar{d}) = \\frac{s_d}{\\sqrt{n}} = \\frac{6}{\\sqrt{50}} \\approx \\frac{6}{7.071} \\approx 0.8485 \\text{ mmHg} $$\n$90\\%$ 置信区间为：\n$$ 90\\% \\text{ CI} = -2 \\pm (1.6766 \\times 0.8485) $$\n$$ 90\\% \\text{ CI} = -2 \\pm 1.4225 $$\n$$ 90\\% \\text{ CI} = [-3.4225, -0.5775] \\text{ mmHg} $$\n等效性范围是 $[-\\Delta, \\Delta] = [-5, 5]$ 毫米汞柱。由于整个 $90\\%$ 置信区间 $[-3.4225, -0.5775]$ 都包含在等效性范围 $[-5, 5]$ 内，我们拒绝两个原假设。TOST 程序将得出结论，认为平均偏差 $\\mu_d$ 在预设范围内与零在统计上是等效的。\n\n### 逐项分析\n\n**A. 在给定 $\\bar{d} = -2$，$s_d = 6$，$n = 50$ 和 $\\Delta = 5$ 的情况下，Bland–Altman 方法和等效性检验都会得出结论，认为替代参考设备具有可接受的一致性。**\n我们的分析表明，等效性检验会得出平均偏差具有可接受一致性的结论，但 Bland-Altman 分析会得出个体测量值不具有可接受一致性的结论，因为其 LoA $[-13.76, 9.76]$ 远宽于范围 $\\pm 5$。由于其中一种方法表明缺乏一致性，因此该陈述是错误的。\n**结论：错误。**\n\n**B. 在这些数据下，等效性检验可能会宣布平均偏差在 $\\pm \\Delta$ 范围内，而 Bland–Altman 分析则会因为个体差异的散布相对于 $\\pm \\Delta$ 来说太宽而表明缺乏一致性。**\n这个陈述准确地反映了我们的发现。TOST 分析显示 $\\mu_d$ 的 $90\\%$ 置信区间在 $\\pm 5$ 之内。BA 分析显示 $95\\%$ 的 LoA 远宽于 $\\pm 5$。这正确地对比了两种方法在给定数据下的结论。\n**结论：正确。**\n\n**C. Bland–Altman 分析是一种正式的假设检验，等同于检验 $H_0: \\mu_d = 0$ 和 $H_1: \\mu_d \\neq 0$。**\n这个陈述是错误的。Bland-Altman 分析主要是一种描述性的图形方法，而不是一种正式的假设检验。其目标是量化一致性（通过一致性界限）以判断其是否在临床上可接受，而不是检验关于均值的假设。检验 $H_0: \\mu_d=0$ 是一个简单的 t 检验，用于检验是否存在非零的平均偏差。Bland 和 Altman 特别指出，这对于评估一致性是不足够的，并且常常会产生误导，因为不显著的结果不意味着一致性，而显著的结果也无法量化不一致的程度。\n**结论：错误。**\n\n**D. 如果 $95\\%$ 的一致性界限超出了 $\\pm \\Delta$，增加样本量 $n$ 必然会使这些界限回到 $\\pm \\Delta$ 之内。**\nLoA 的公式近似为 $\\bar{d} \\pm 1.96 s_d$。随着样本量 $n$ 的增加，样本统计量 $\\bar{d}$ 和 $s_d$ 分别收敛于真实的总体参数 $\\mu_d$ 和 $\\sigma_d$。因此，LoA 收敛于总体界限 $\\mu_d \\pm 1.96 \\sigma_d$。该区间的宽度由 $\\sigma_d$（差异的内在变异性）决定，而不是由样本量 $n$ 决定。如果 $\\sigma_d$ 很大，那么真实的 LoA 就会很宽，再多的抽样也无法改变这种固有的精确度缺乏。增加 $n$ 只会提高 LoA *估计值*的精度，而不会缩小 LoA 本身。\n**结论：错误。**\n\n**E. 等效性检验和 Bland–Altman 方法针对不同的总体目标：前者针对平均差异 $\\mu_d$，而后者针对个体差异的分布；因此，在相同的数据和范围 $\\Delta$ 下，它们可能得出不同的结论。**\n这是一个关于这两种方法理念的根本性正确陈述。TOST 是一种推断性程序，专注于差异的中心趋势（平均偏差）$\\mu_d$。BA 方法是一种描述性程序，专注于个体差异 $d_i$ 的分布散布，以了解单次测量的预期误差。因为它们评估的是数据的不同方面（均值 vs. 散布），所以它们可能并且经常得出不同的结论。本问题中的数据就为这种分歧提供了一个完美的例子。\n**结论：正确。**\n\n最终审查：陈述 B 和 E 都是正确的。陈述 B 是将陈述 E 中描述的一般原则应用于所提供数据的具体应用。陈述 E 描述了该一般原则。在问题的背景下，两者在事实上都是正确的。", "answer": "$$\\boxed{BE}$$", "id": "4898491"}]}