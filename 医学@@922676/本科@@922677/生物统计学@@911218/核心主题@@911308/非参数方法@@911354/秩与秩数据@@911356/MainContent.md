## 引言
在生物统计学及诸多科学领域，真实世界的数据常常充满挑战，如异常值、[偏态分布](@entry_id:175811)或本质上的有序等级，这使得依赖正态性等严格假设的传统参数检验方法力不从心。当这些假设不被满足时，我们如何才能得出可靠的统计推断？秩和秩次数据分析为此提供了稳健而强大的解决方案。通过将数据的绝对数值转换为其相对顺序（即秩次），[非参数方法](@entry_id:138925)摆脱了对特定数据分布的依赖，成为现代研究者不可或缺的工具。

本文将系统地引导您掌握秩次方法的精髓。在第一章 **“原理与机制”** 中，我们将深入探讨秩的定义、结的处理策略，并详细阐述Wilcoxon[秩和检验](@entry_id:168486)、Kruskal-Wallis检验等核心方法的数学原理与理论依据。随后，在第二章 **“应用与跨学科连接”** 中，我们将展示这些方法如何应用于生物统计、基因组学和生态学等前沿领域，解决从临床试验到高维基因数据分析的复杂问题。最后，第三章 **“动手实践”** 将通过具体的编程练习，帮助您将理论知识转化为解决实际问题的能力。通过这一学习路径，您将能够自信地运用秩方法进行严谨的数据分析。

## 原理与机制

本章深入探讨了[非参数统计](@entry_id:174479)中基于秩的方法的核心原理和机制。与依赖于数据具体数值和特定分布假设（如正态性）的参数方法不同，秩方法通过将观测值转换为其在排序列表中的相对位置（即秩）来工作。这种转换保留了数据的顺序信息，同时舍弃了其绝对大小和分布形状，从而获得了对异常值和分布偏态的稳健性。我们将系统地阐述秩的定义、处理数据中“结”（tied values）的策略，并详细介绍用于比较[独立样本](@entry_id:177139)、配对样本和多组设计的关键[秩检验](@entry_id:178051)。此外，我们还将探讨[秩相关](@entry_id:175511)性的度量，并通过[随机占优](@entry_id:142966)和[渐近相对效率](@entry_id:171033)等概念，为这些检验的解释和性能提供更深刻的理解。

### 秩的定义与结的处理

从根本上说，一个观测值的**秩**是它在所有观测值按升序排列后的位置。例如，在数据集 `{10, 50, 2, 35}` 中，数值 2 的秩是 1，10 的秩是 2，35 的秩是 3，50 的秩是 4。这种转换用整数 `{1, 2, 3, 4}` 取代了原始数值，使得后续分析不依赖于原始数据的尺度或分布。

在实际数据中，尤其是在生物统计学中，由于测量精度或数据取整，经常会出现**结**（ties），即多个观测值具有相同的值。处理结是秩方法中的一个关键技术问题，不同的策略会对检验统计量的性质产生影响。我们考虑以下三种主要策略 [@problem_id:4946601]：

1.  **中位秩 (Midranks)**：这是处理结的标准方法。如果 $t$ 个观测值并列，占据了从 $r$ 到 $r+t-1$ 的秩次，那么每个观测值都被赋予这些秩次的平均值，即 $(r + (r+t-1))/2$。例如，在混合样本 `{1.0, 1.0, 1.5, 2.0, 3.0}` 中，两个 1.0 的值占据了第 1 和第 2 的位置。它们的中位秩是 $(1+2)/2 = 1.5$。其余值的秩分别为 3, 4, 5。因此，秩集为 `{1.5, 1.5, 3, 4, 5}`。

2.  **随机断结 (Random tie-breaking)**：将整数秩（如上例中的 1 和 2）随机分配给并列的观测值。这种方法在理论上可以保持秩的置换特性，但在实际应用中引入了不必要的随机性——两次分析相同的数据可能会得到不同的结果。

3.  **唯一值秩 (Dense ranks)**：首先对所有唯一值进行排序，然后将每个唯一值的秩分配给所有具有该值的观测值。在上例中，唯一值为 `{1.0, 1.5, 2.0, 3.0}`，其秩为 `{1, 2, 3, 4}`。因此，两个 1.0 的观测值都将获得秩 1。

中位秩之所以成为标准，是因为它与一个重要的非参数效应量——**优越概率**（probability of superiority）——有着直接的代数联系。我们将在后续章节中看到，使用中位秩的[检验统计量](@entry_id:167372)可以无偏地估计这个概率，而其他方法（如唯一值秩）则会引入偏差 [@problem_id:4946601]。因此，在后续讨论中，除非另有说明，所有[秩检验](@entry_id:178051)均默认使用中位秩。

### 独立双样本的[秩检验](@entry_id:178051)

在比较两个独立组（例如，治疗组与安慰剂组）时，最常用的[非参数检验](@entry_id:176711)是 Wilcoxon [秩和检验](@entry_id:168486)或等价的 Mann-Whitney U 检验。

#### Wilcoxon [秩和检验](@entry_id:168486)与 Mann-Whitney U 检验

**Wilcoxon [秩和检验](@entry_id:168486) (Wilcoxon Rank-Sum test)** 的统计量 $W$ 定义为其中一个组（例如，A 组）的秩之和。**Mann-Whitney U 检验 (Mann-Whitney U test)** 的统计量 $U$ 定义为两组间所有可能的配对中，A 组观测值大于 B 组观测值的对数，加上 A 组与 B 组观测值相等的对数的一半。

这两个统计量在代数上是等价的，它们之间存在一个简单的线性关系 [@problem_id:4946649]：
$$ U_A = W_A - \frac{m(m+1)}{2} $$
其中 $W_A$ 是 A 组的秩和，$m$ 是 A 组的样本量。由于这种等价性，我们通常可以互换使用这两个术语。

在零假设（$H_0$）下，即两组来自相同的连续分布，我们可以推导出这些统计量的期望和方差。在 $H_0$ 下，来自总样本量为 $N=m+n$ 的所有秩都是随机分配给两组的。$U$ 统计量的期望为 [@problem_id:4946649]：
$$ \mathbb{E}[U] = \frac{mn}{2} $$
这个[期望值](@entry_id:150961)在有结或无结的情况下都成立。

在没有结的情况下，其方差为：
$$ \operatorname{Var}(U) = \frac{mn(N+1)}{12} $$
当数据中存在结时，秩的变异性会减小，因此必须对方差进行修正。修正后的方差公式为 [@problem_id:4946659] [@problem_id:4946649]：
$$ \operatorname{Var}(U)_{\text{ties}} = \frac{mn}{12} \left[ (N+1) - \frac{\sum_j (t_j^3 - t_j)}{N(N-1)} \right] $$
其中求和 $\sum_j$ 是对所有结块进行的，$t_j$ 是第 $j$ 个结块的大小（即并列观测值的数量）。这个修正项 $\sum (t^3 - t)$ 精确地量化了由于使用中位秩而导致的秩平方和的减少量。

例如，考虑两组数据，A 组：`{8, 7, 10, 9, 7}` ($m=5$)，B 组：`{10, 5, 9, 7, 10}` ($n=5$)。[混合排序](@entry_id:637177)后为 `{5, 7, 7, 7, 8, 9, 9, 10, 10, 10}`。存在三个结块：数值 7 出现 3 次 ($t_1=3$)，数值 9 出现 2 次 ($t_2=2$)，数值 10 出现 3 次 ($t_3=3$)。A 组的秩和（使用中位秩）为 $W=26.5$。方差修正项为 $\sum(t^3-t) = (3^3-3) + (2^3-2) + (3^3-3) = 24+6+24=54$。代入公式后，我们得到修正后的方差 $\operatorname{Var}(W) \approx 21.67$ [@problem_id:4946659]。

#### 检验的解释：[随机占优](@entry_id:142966)与效应量

[秩检验](@entry_id:178051)不仅仅是判断“是否存在差异”，它实际上检验的是一个更具体、更具解释性的概念，称为**[随机占优](@entry_id:142966) (stochastic ordering)**。如果对于所有的值 $t$，变量 $X_A$ 取值大于 $t$ 的概率总是大于或等于变量 $X_B$ 的相应概率，那么我们说 $X_A$ **[随机占优](@entry_id:142966)于** $X_B$。用[累积分布函数 (CDF)](@entry_id:264700) $F$ 表示，即 $F_A(t) \le F_B(t)$ 对所有 $t$ 成立 [@problem_id:4946617]。直观上，这意味着 A 组的整个分布相对于 B 组向“更好”或“更大”的方向移动。

与此密切相关的非参数**效应量**是**优越概率 (probability of superiority)**，记为 $\theta$：
$$ \theta = \mathbb{P}(X_A > X_B) + \frac{1}{2}\mathbb{P}(X_A = X_B) $$
$\theta$ 表示从 A 组中随机抽取一个个体，其结果优于从 B 组中随机抽取的个体的概率。Mann-Whitney U 统计量正是 $mn\theta$ 的一个[无偏估计量](@entry_id:756290)，即 $\hat{\theta} = U / (mn)$。

当两组分布相同时，$\theta=0.5$。如果 A 组[随机占优](@entry_id:142966)于 B 组，则 $\theta > 0.5$。这为我们提供了一种非常有力的解释框架：[秩和检验](@entry_id:168486)的显著结果（当 $\hat{\theta} > 0.5$ 时）表明，有证据支持 A 组的分布[随机占优](@entry_id:142966)于 B 组。例如，一项研究发现，在 56 对跨组比较中，A 组有 38 次优于 B 组，16 次劣于 B 组，2 次持平。那么 $\hat{\theta} = (38 + 0.5 \times 2) / 56 \approx 0.696$。这个值可以直接解释为：随机选择一个 A 组患者，他比 B 组患者有约 69.6% 的机会获得更好的结果 [@problem_id:4946617]。

#### 多样本问题：[Kruskal-Wallis 检验](@entry_id:163863)

当需要比较 $k$ 个（$k>2$）[独立样本](@entry_id:177139)时，Wilcoxon [秩和检验](@entry_id:168486)可以推广为 **Kruskal-Wallis (KW) 检验**。这可以被看作是单向[方差分析 (ANOVA)](@entry_id:262372) 的非参数等价物 [@problem_id:4821602]。

其过程是：首先将所有 $k$ 组的 $N$ 个观测值汇集起来进行全局排名（同样使用中位秩处理结），然后计算每组的秩和 $R_i$。检验统计量 $H$ 基于各组平均秩与其总平均秩 $(N+1)/2$ 之间的加权平方差。其计算公式为：
$$ H = \frac{12}{N(N+1)} \sum_{i=1}^{k} \frac{R_i^2}{n_i} - 3(N+1) $$
在存在结的情况下，需要对 $H$ 进行修正，即除以一个修正因子 $C$：
$$ C = 1 - \frac{\sum_j (t_j^3 - t_j)}{N^3 - N} $$
在零假设（所有 $k$ 组来自相同的分布）下，对于大样本，$H$（或修正后的 $H/C$）近似服从自由度为 $k-1$ 的**卡方 ($\chi^2$) 分布**。$H$ 值显著大表明至少有一组的分布与其他组存在[随机占优](@entry_id:142966)意义上的差异。在更强的假设下（例如，所有组的分布形状相同，仅[位置参数](@entry_id:176482)——[中位数](@entry_id:264877)——可能不同），KW 检验可以被解释为对各组中位数是否相等的检验 [@problem_id:4821602]。

### 相关样本的[秩检验](@entry_id:178051)

当数据具有相关结构时，例如配对样本或区组设计，使用为独立样本设计的检验（如 KW 检验）是不恰当的。我们需要采用能够利用这种相关结构的[秩检验](@entry_id:178051)。

#### 配对样本：Wilcoxon 符号[秩检验](@entry_id:178051)

对于配对数据（例如，对同一受试者进行干预前后的测量），我们关注的是配对差值 $D_i = \text{后} - \text{前}$。**Wilcoxon 符号[秩检验](@entry_id:178051) (Wilcoxon Signed-Rank test)** 是配对样本 t 检验的非参数替代方法 [@problem_id:4946634]。

其检验步骤如下：
1.  计算每个配对的差值 $D_i$。
2.  忽略所有 $D_i = 0$ 的配对。
3.  对所有非零差值的绝对值 $|D_i|$ 进行排序，得到秩 $R_i$。
4.  检验统计量 $W$ 是所有**正差值**所对应的秩之和：$W = \sum_{i=1}^{n} R_i \cdot \mathbf{1}\{D_i > 0\}$。

零假设是差值的分布关于 0 对称。在此假设下，任何一个秩所对应的原始差值为正或为负的概率都是 $1/2$，且各秩的符号是独立的。基于此，我们可以精确推导出 $W$ 的期望和方差 [@problem_id:4946634]：
$$ \mathbb{E}[W] = \frac{n(n+1)}{4} $$
$$ \operatorname{Var}(W) = \frac{n(n+1)(2n+1)}{24} $$
其中 $n$ 是非零差值的数量。这些精确的矩使得我们可以在小样本情况下进行精确检验，或在大样本情况下使用[正态近似](@entry_id:261668)。

#### 区组设计：Friedman 检验

在**随机完整区组设计 (Randomized Complete Block Design, RCBD)** 中，每个区组（例如，一个病人）都接受所有 $k$ 种处理。这种设计通过在区组内部进行比较来控制区组间的变异。[Kruskal-Wallis 检验](@entry_id:163863)在此不适用，因为它忽略了区组结构，错误地将所有观测值视为独立的。

正确的非参数方法是 **Friedman 检验** [@problem_id:4921323]。其与 KW 检验的根本区别在于**秩的分配方式**：
*   **Friedman 检验**：在**每个区组内部**，对 $k$ 个处理的观测值进行排序，赋予从 1 到 $k$ 的秩。
*   **[Kruskal-Wallis 检验](@entry_id:163863)**：对所有区组和所有处理的 $N=bk$ 个观测值进行**全局排序**。

Friedman 检验通过在区组内部排名，有效地消除了区组效应（例如，某些病人总体疼痛水平较高），使检验专注于处理间的差异。检验统计量基于各处理的秩和，在大样本情况下，它也近似服从自由度为 $k-1$ 的 $\chi^2$ 分布。

### [秩相关](@entry_id:175511)性度量

除了[假设检验](@entry_id:142556)，秩也被用来衡量两个变量之间的单调关系，最著名的就是 Spearman 秩[相关系数](@entry_id:147037)。

#### Spearman 秩[相关系数](@entry_id:147037) ($\rho_s$)

当两个变量的关系是单调但非线性，或者数据不满足正态假设时，Pearson 相关系数可能无法准确捕捉其关联强度。**Spearman 秩相关系数 (Spearman's rank correlation coefficient)**，记为 $\rho_s$，通过计算两个变量各自的秩之间的 Pearson [相关系数](@entry_id:147037)来解决这个问题 [@problem_id:4946645]。

在没有结的情况下，$\rho_s$ 有一个简化的计算公式：
$$ \rho_s = 1 - \frac{6 \sum_{i=1}^n d_i^2}{n(n^2 - 1)} $$
其中 $d_i$ 是第 $i$ 个数据点的两个变量的秩之差。$\rho_s$ 的取值范围为 -1 到 +1，完美地衡量了变量间的单调关系强度。

从更深层次的概率论角度看，Spearman 相关系数有着优美的理论解释。对于[连续随机变量](@entry_id:166541) $(X, Y)$，其总体 Spearman 相关系数等于其[概率积分变换](@entry_id:262799) $U=F_X(X)$ 和 $V=F_Y(Y)$ 后的 Pearson [相关系数](@entry_id:147037)。由于 $U$ 和 $V$ 都服从 `[0,1]` 上的标准均匀分布，$\rho_s$ 的定义可以完全由连接这两个变量的**copula 函数** $C(u,v)$ 决定 [@problem_id:4946645]：
$$ \rho_s = 12 \int_0^1 \int_0^1 C(u,v) \,du\,dv - 3 $$
这表明 Spearman 相关系数是一个纯粹的依赖性度量，不受边缘分布的任何单调变换的影响。

### [秩检验](@entry_id:178051)的效率

一个自然的问题是：与参数检验（如 t 检验）相比，使用[秩检验](@entry_id:178051)会损失多少“信息”或“[统计功效](@entry_id:197129)”？**Pitman [渐近相对效率](@entry_id:171033) (Asymptotic Relative Efficiency, ARE)** 提供了一个量化的答案 [@problem_id:4946629]。ARE 比较了在检测微小效应时，两种检验达到相同功效所需的样本量之比。

Wilcoxon [秩和检验](@entry_id:168486)相对于 t 检验的 ARE 可以表示为：
$$ \text{ARE}(W, t) = 12\sigma^2 \left( \int_{-\infty}^{\infty} f(x)^2 \,dx \right)^2 $$
其中 $\sigma^2$ 是数据的方差，$f(x)$ 是其[概率密度函数](@entry_id:140610)。

这个公式揭示了[秩检验](@entry_id:178051)的卓越性能：
*   当数据来自**正态分布**时（这是 t 检验最理想的情况），ARE 的值为 $3/\pi \approx 0.955$。这意味着 Wilcoxon 检验的效率几乎与 t 检验相同，仅损失了约 4.5% 的效率 [@problem_id:4946629]。
*   当数据来自**逻辑斯蒂分布**（一种比正态分布尾部更重的分布）时，ARE 的值为 $\pi^2/9 \approx 1.097$。这意味着在这种情况下，Wilcoxon 检验比 t 检验**更有效** [@problem_id:4946629]。

更一般地，可以证明 Wilcoxon 检验相对于 t 检验的 ARE 永远不会低于 0.864，并且对于某些[重尾分布](@entry_id:142737)，ARE 可以是无穷大。这一惊人的结果表明，[秩检验](@entry_id:178051)是一种非常安全和强大的选择：在参数检验表现最佳的情况下，它的表现几乎同样好；而在参数检验的假设不成立时，它的表现可能要优越得多。这为在生物统计学实践中广泛采用秩方法提供了强有力的理论依据。