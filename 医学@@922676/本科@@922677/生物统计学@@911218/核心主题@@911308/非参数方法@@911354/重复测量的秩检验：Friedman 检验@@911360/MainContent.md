## 引言
在科学研究中，尤其是在生物统计学和临床试验领域，我们常常需要比较多种处理在同一组受试者身上的效果。这种重复测量设计虽然能有效控制个体差异，但也对统计分析方法提出了特殊要求，特别是当数据不满足正态分布等参数检验的严格假设时。弗里德曼检验（Friedman Test）正是为解决这一挑战而设计的强大非参数工具，它允许研究者在不依赖数据分布形态的情况下，稳健地评估多个相关样本或处理之间是否存在显著差异。本文旨在系统性地介绍弗里德曼检验。在“原理与机制”一章中，我们将深入剖析其如何通过秩转换消除区组效应，并详细介绍其统计量的构建与检验过程。接下来，“应用与跨学科联系”一章将通过丰富的案例，展示该检验在临床研究、纵向数据分析等领域的实际应用，并讨论结果解释、[事后分析](@entry_id:165661)及高级扩展。最后，“动手实践”部分将提供练习，帮助你巩固所学知识并将其付诸实践。通过学习本文，你将掌握在重复测量设计中进行非参数比较的核心技能。

## 原理与机制

在生物统计学研究中，我们经常需要在存在显著个体差异的情况下比较多种处理（如药物、疗法或干预措施）的效果。例如，评估不同降压药的效果时，患者的基础血压水平各不相同。这种固有的、与处理无关的受试者间变异性，即**受试者间异质性 (between-subject heterogeneity)**，可能会掩盖真实的[处理效应](@entry_id:636010)，从而对统计分析构成挑战。一个精巧的实验设计——**重复测量设计 (repeated-measures design)** 或 **随机化完全区组设计 (randomized complete block design)**——为解决此问题提供了优雅的方案。在这种设计中，每位受试者（即“区组”）都接受所有 $k$ 种处理，从而使每位受试者成为自己的对照。通过在受试者内部进行比较，我们可以有效地消除或“控制”由受试者基线水平差异引起的变异。

弗里德曼检验正是为分析此类重复测量数据而设计的强大的[非参数方法](@entry_id:138925)。它不依赖于数据呈正态分布的假设，仅要求数据至少具有[序数](@entry_id:150084)水平，能够在其区组内部进行有意义的排序。本章将深入探讨弗里德曼检验的核心原理与运行机制，阐明其如何利用秩转换来分离[处理效应](@entry_id:636010)与受试者效应，并介绍其统计量的构建、[假设检验](@entry_id:142556)过程以及结果的正确解读。

### 基本原理：通过区组内排序控制异质性

弗里德曼检验的核心思想是，通过将分析[重心](@entry_id:273519)从原始观测值转移到其在各自区组内的**秩 (rank)**，来消除受试者特异性效应。让我们通过一个加性模型来理解这个过程 [@problem_id:4946243]。假设对于受试者 $i$ 在处理 $j$ 下的观测值 $Y_{ij}$，可以被分解为：

$Y_{ij} = \mu + \tau_{j} + b_{i} + \varepsilon_{ij}$

在这里，$ \mu $ 是总体均值，$ \tau_{j} $ 是我们关心的处理 $j$ 的效应，$ b_{i} $ 是受试者 $i$ 特有的、代表其基线水平的区组效应（这是一个“讨厌的”参数，因为它增加了数据变异但并非研究焦点），而 $ \varepsilon_{ij} $ 是[随机误差](@entry_id:144890)。我们的目标是检验不同处理效应 $ \tau_j $ 是否存在差异。

当我们在一个特定的受试者 $i$（即一个区组）内部对所有 $k$ 个观测值 $\{Y_{i1}, Y_{i2}, \dots, Y_{ik}\}$ 进行排序时，恒定的区组效应 $b_i$ 会被有效地“消除”。这是因为 $b_i$ 对该受试者的所有观测值都有相同的加性影响，因此不会改变它们的相对顺序。例如，在一个评估三种饮食（A、B、C）对血糖影响的研究中，即使受试者2的血糖值（如20, 23, 21）普遍高于受试者3（如8, 11, 10），但在每个受试者内部，饮食B都产生了最高的血糖值，饮食A最低。进行区组内排序后，两名受试者的秩序列完全相同：A为1，C为2，B为3。原始数值的巨大差异（异质性）被秩转换所“吸收”，使得处理间的相对优劣模式凸显出来 [@problem_id:4946243]。

更进一步，秩转换的威力在于其对单调变换的不变性。对于任何一个区组，只要对该区组内的所有观测值应用同一个严格单调递增函数，其内部的秩次将保持不变。这意味着弗里德曼检验不仅能控制加性区组效应，还能控制更广泛的、由受试者特异性引起的尺度缩放效应，这使其成为一个非常稳健的工具 [@problem_id:4946243]。

### 核心机制：从原始数据到秩和

弗里德曼检验的第一步，也是最关键的一步，就是数据排序。

#### 区组内排序

对于 $n$ 个区组（受试者）中的每一个，我们将其接受的 $k$ 个处理的观测值从1到 $k$ 进行排序。通常，最小值被赋予秩1，次小值被赋予秩2，以此类推，直到最大值被赋予秩 $k$。

让我们通过一个临床研究的例子来说明，该研究在 $n=6$ 名受试者中比较 $k=4$ 种治疗（A, B, C, D）的效果 [@problem_id:4946270]。假设观测数据如下（数值越大表示效果越好），且每个受试者内部没有相同的值（即无**结 (ties)**）：

- 受试者1：A=4, B=1, C=3, D=2  $\rightarrow$ 秩：A=4, B=1, C=3, D=2
- 受试者2：A=3, B=2, C=4, D=1  $\rightarrow$ 秩：A=3, B=2, C=4, D=1
- ... 以此类推。

#### 处理结：中位秩法

在实际数据中，一个区组内出现相同值的“结”是很常见的。处理结的标准方法是**中位秩法 (midrank method)**。如果一个区组内有多个观测值相同，它们将被赋予它们本应占据的秩次的[算术平均值](@entry_id:165355)。

例如，在一个有 $n=6$ 个区组和 $k=4$ 种处理的研究中，数据如下 [@problem_id:4946272]：
- 区组1：$(7.1, 6.8, 7.1, 5.9)$
  - 排序后为 $5.9  6.8  7.1 = 7.1$。
  - 秩次为：$D(5.9) \rightarrow 1$；$B(6.8) \rightarrow 2$。
  - $A(7.1)$ 和 $C(7.1)$ 并列，占据了第3和第4的位置。它们的中位秩为 $\frac{3+4}{2} = 3.5$。
  - 因此，区组1的秩为：$(r_{1A}, r_{1B}, r_{1C}, r_{1D}) = (3.5, 2.0, 3.5, 1.0)$。

- 区组5：$(5.8, 6.1, 6.1, 5.8)$
  - 排序后为 $5.8 = 5.8  6.1 = 6.1$。
  - $A$ 和 $D$ 并列，占据第1和第2位，中位秩为 $\frac{1+2}{2} = 1.5$。
  - $B$ 和 $C$ 并列，占据第3和第4位，中位秩为 $\frac{3+4}{2} = 3.5$。
  - 因此，区组5的秩为：$(r_{5A}, r_{5B}, r_{5C}, r_{5D}) = (1.5, 3.5, 3.5, 1.5)$。

#### 计算秩和

完成对所有 $n$ 个区组的排序后，下一步是为每一种处理计算其**秩和 (rank sum)**。处理 $j$ 的秩和 $R_j$ 是其在所有区组中获得的秩的总和：

$R_j = \sum_{i=1}^{n} r_{ij}$

其中 $r_{ij}$ 是处理 $j$ 在区组 $i$ 中的秩。秩和 $R_j$ 汇总了处理 $j$ 在所有受试者中的相对表现。如果所有处理的效果都相同，我们预期它们的秩和会大致相等。反之，如果某个处理的秩和远大于或远小于其他处理，则提示该处理的效果可能存在系统性差异。

### 弗里德曼[检验统计量](@entry_id:167372)：量化处理差异

在计算出各处理的秩和后，我们需要一个统计量来客观地衡量这些秩和的差异是否超出了随机波动的范围。

#### 假设的设定

首先，我们必须明确弗里德曼检验的**原假设 ($H_0$)** 与**[备择假设](@entry_id:167270) ($H_1$)** [@problem_id:4946270]。
- **$H_0$**：所有 $k$ 种处理的效应分布完全相同。这意味着，对于任何一个区组，将其观测结果赋予任何一个处理标签的概率都是均等的。
- **$H_1$**：至少有一种处理的效应分布与其他处理不同。

需要特别强调的是，弗里德曼检验的原假设是关于**整个分布的同一性**，而不仅仅是中位数或均值的相等。这意味着，即使所有处理的中位数相同，如果它们的分布形状（如[偏度](@entry_id:178163)或[峰度](@entry_id:269963)）不同并足以系统性地影响排序结果，弗里德曼检验仍然可能拒绝原假设 [@problem_id:4946304]。

#### 统计量的构建

弗里德曼[检验统计量](@entry_id:167372)，通常记为 $\chi^2_F$ 或 $Q$，其核心思想是衡量观测到的各处理秩和 $R_j$ 与其在原假设下的[期望值](@entry_id:150961)之间的离差平方和。

在原假设下，每个区组内的秩 $\{1, 2, \dots, k\}$ 是随机分配给 $k$ 个处理的，因此任何处理在任何区组内的期望秩都是 $\frac{k+1}{2}$。在 $n$ 个区组中，处理 $j$ 的期望秩和为 $E[R_j] = n \frac{k+1}{2}$。

基于此，弗里德曼统计量的一个直观形式是 [@problem_id:4946245]：

$\chi^2_F = \frac{12}{nk(k+1)} \sum_{j=1}^{k} \left(R_j - \frac{n(k+1)}{2}\right)^2$

这个公式类似于[卡方检验](@entry_id:174175)，它计算了每个处理的观测秩和与期望秩和之差的平方，然后加总，并通过一个缩放因子 $\frac{12}{nk(k+1)}$ 进行标准化。该缩放因子的作用是调整统计量，使其在样本量较大时，其[抽样分布](@entry_id:269683)近似于一个已知的理论分布。

在实际计算中，一个代数等价且更方便的公式是 [@problem_id:4946245]：

$\chi^2_F = \frac{12}{nk(k+1)} \sum_{j=1}^{k} R_j^2 - 3n(k+1)$

当数据中存在结时，秩的变异性会减小。为了修正这一点，统计量的公式需要进行调整，通常是通过除以一个小于1的修正因子来增大统计量的值。虽然我们在此不详述修正公式，但重要的是要认识到，正确处理结是确保检验有效性的关键一步 [@problem_id:4946264] [@problem_id:4946249]。

### [假设检验](@entry_id:142556)与结果解读

计算出 $\chi^2_F$ 统计量后，我们需要将其与一个参照分布进行比较，以确定观测到的处理间差异是否具有[统计显著性](@entry_id:147554)。

#### 参照分布与[p值](@entry_id:136498)

对于中等到较大的样本量（通常当 $k \ge 3, n \ge 10$ 或 $k \ge 4, n \ge 5$ 时，近似效果较好），弗里德曼统计量 $\chi^2_F$ 的抽样分布近似于一个**自由度为 $k-1$ 的卡方 ($\chi^2$) 分布**。自由度为 $k-1$ 是因为在 $k$ 个秩和中，由于其总和是一个固定值（即 $n \frac{k(k+1)}{2}$），只有 $k-1$ 个秩和可以自由变化 [@problem_id:4946270]。

检验过程如下：
1.  设定显著性水平 $\alpha$（如 0.05）。
2.  计算出观测数据的 $\chi^2_F$ 值。
3.  查找自由度为 $k-1$ 的 $\chi^2$ 分布，计算获得大于或等于观测 $\chi^2_F$ 值的概率，即 **[p值](@entry_id:136498)**。
4.  如果 $p  \alpha$，则拒绝原假设 $H_0$，认为处理之间存在统计显著的差异。否则，不拒绝 $H_0$。

让我们完成一个完整的例子。一项营养学研究在 $n=6$ 名患者中比较 $k=4$ 种饮食的效果，得分越低越好 [@problem_id:4946292]。
- **排序与秩和**：对每个患者的4个得分进行排序后，得到各饮食的秩和为：$R_A = 22, R_B = 17, R_C = 9, R_D = 12$。
- **计算统计量**：
  $\chi^2_F = \frac{12}{6 \times 4 \times (4+1)} (22^2 + 17^2 + 9^2 + 12^2) - 3 \times 6 \times (4+1)$
  $\chi^2_F = \frac{12}{120} (998) - 90 = 0.1 \times 998 - 90 = 99.8 - 90 = 9.8$
- **决策**：该统计量应与自由度为 $k-1=3$ 的 $\chi^2$ 分布进行比较。$\chi^2_3$ 分布在 $\alpha=0.05$ 时的临界值为7.815。由于观测值 $9.8 > 7.815$，我们拒绝原假设。计算得到的[p值](@entry_id:136498)约为 $0.020$。因此，我们可以得出结论：这些饮食的效果存在统计学上的显著差异。

#### 结果的解读

当弗里德曼检验结果显著时，我们只能断定“至少有一种处理的效应分布与其他处理不同”。这并不直接告诉我们哪些处理之间存在差异。要进行具体的两两比较，需要进行**[事后检验](@entry_id:171973) (post-hoc tests)**，例如使用[Wilcoxon符号秩检验](@entry_id:168040)并对多重比较进行校正（如[Bonferroni校正](@entry_id:261239)）。

此外，正如之前所强调的，显著结果应被审慎地解读为**分布差异**的证据，而不仅仅是[中位数](@entry_id:264877)差异。虽然弗里德曼检验对能引起持续排序变化的**位置偏移 (location shift)** 最为敏感（这是它被设计用来检测的主要目标），但它也可能被其他类型的分布差异触发。因此，一个稳妥的结论是，[处理效应](@entry_id:636010)在分布上存在差异 [@problem_id:4946304]。

### 基本假设与理论基础

任何统计检验的有效性都建立在一系列假设之上。弗里德曼检验也不例外。

#### 核心假设

要正确应用弗里德曼检验，必须满足以下几个核心假设 [@problem_id:4946264]：
1.  **区组独立性**：$n$ 个区组（受试者）是相互独立的随机样本。一个受试者的表现不应影响另一个受试者。
2.  **区组内无处理[交互作用](@entry_id:164533)**：处理的效果不应依赖于特定的区组。换言之，处理的相对优劣顺序在所有受试者中应具有一致性。
3.  **数据类型**：变量至少是序数尺度，以便在区组内进行有意义的排序。
4.  **原假设下的可交换性**：在 $H_0$ 成立（即所有处理效应相同）的前提下，对于任何一个区组，其内部的 $k$ 个观测值与 $k$ 个处理标签的配对是随机的。这意味着，将这组观测值重新任意分配给不同的处理标签，其概率都是相同的。这一**[可交换性](@entry_id:263314) (exchangeability)** 原理是构建检验统计量零分布的理论基石。

#### 置换原理与[精确检验](@entry_id:178040)

$\chi^2$ 分布只是弗里德曼统计量在大样本下的近似分布。其真正的理论基础是**置换原理 (permutation principle)** [@problem_id:4946282]。在原假设下，由于区组内的可交换性，每个区组内的 $k$ 个秩有 $k!$ 种同样可能的排列方式。由于 $n$ 个区组是独立的，整个实验总共有 $(k!)^n$ 种同样可能的秩分配矩阵。

对于小样本（例如 $n=3, k=3$ 时，总共有 $(3!)^3 = 6^3 = 216$ 种可能性），我们可以从理论上枚举所有这些可能性，为每一种可能性计算 $\chi^2_F$ 统计量，从而构建出其**精确的零分布**。精确的[p值](@entry_id:136498)就是在这个[零分布](@entry_id:195412)中，统计量大于或等于我们实际观测到的统计量的比例。当样本量很大时，这种枚举变得不可行，因此我们转而使用更方便的 $\chi^2$ 近似。

#### 与Kruskal-Wallis检验的对比

最后，有必要将弗里德曼检验与其“表亲”——**Kruskal-Wallis检验**——进行区分 [@problem_id:4797204]。两者都是比较 $k$ 组（$k > 2$）的非参数[秩检验](@entry_id:178051)，但适用于完全不同的实验设计：
- **弗里德曼检验**：用于**相关样本**或**重复测量数据**（随机化完全区组设计）。其关键操作是**在每个区组内部进行排序**。
- **Kruskal-Wallis检验**：用于**独立样本数据**（完全随机化设计），即 $k$ 个处理组由完全不同的受试者构成。其关键操作是将**所有 $N$ 个观测值汇集在一起进行全局排序**。

混淆这两种检验是统计分析中的一个严重错误，因为它忽略了数据中的依赖结构，可能导致完全错误的结论。