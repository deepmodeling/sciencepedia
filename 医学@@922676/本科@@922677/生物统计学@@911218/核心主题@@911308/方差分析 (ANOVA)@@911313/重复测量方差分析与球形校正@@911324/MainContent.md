## 引言
在科学研究中，尤其是在生物统计学、心理学和医学等领域，对同一样本在不同时间或条件下进行重复测量是一种常见且高效的设计方法。这类纵向数据由于其内在的相关性，无法使用传统的[方差分析](@entry_id:275547)。重复测量[方差分析](@entry_id:275547)（RM-[ANOVA](@entry_id:275547)）正是为应对这一挑战而生的关键统计工具。然而，RM-ANOVA的有效性高度依赖于一个核心但常被误解的假设——球形性。当数据不满足球形性时，[统计推断](@entry_id:172747)的可靠性会受到严重威胁，导致错误的科学结论。本文旨在系统性地解决这一问题，为研究者提供一个清晰的导航。

在接下来的内容中，我们将分三个章节深入探索这一主题。首先，在“原理与机制”一章中，我们将剖析RM-ANOVA模型的基础，详细阐明球形性假设的数学与直观含义，并介绍如何通过莫奇利检验进行诊断，以及如何利用Greenhouse-Geisser和Huynh-Feldt方法进行校正。接着，在“应用与跨学科联系”一章中，我们会将理论付诸实践，探讨这些方法在真实研究场景中的应用，并将其与多变量[方差分析](@entry_id:275547)（MANOVA）及更为现代的线性混合效应模型（LMM）进行比较，帮助您在不同分析策略间做出明智选择。最后，“动手实践”部分将通过具体练习，巩固您对核心概念的掌握。

让我们首先从理解重复测量[方差分析](@entry_id:275547)的基本原理及其最重要的假设开始。

## 原理与机制

在对同一受试者进行多次测量的研究设计中，例如纵向研究或在不同条件下评估反应的实验，我们不能再假设观测是相互独立的。重复测量[方差分析](@entry_id:275547) (Repeated Measures Analysis of Variance, RM-[ANOVA](@entry_id:275547)) 是一种专门为处理此[类数](@entry_id:156164)据而设计的强大统计技术。本章将深入探讨重复测量方差分析的核心原理，重点关注其关键假设——球形性 (sphericity)，并阐述当此假设不成立时，我们应如何检测并校正，以确保统计推断的有效性。

### 重复测量[方差分析模型](@entry_id:175362)及其假设

标准的重复测量[方差分析模型](@entry_id:175362)可以看作是[双因素方差分析](@entry_id:172441)的扩展，其中一个因素是受试者间因素（如果存在的话），另一个是受试者内部因素（重复测量的条件或时间点）。对于一个简单的单因子重复测量设计，其线性模型可以表述为：

$$
Y_{ij} = \mu + \alpha_j + s_i + \epsilon_{ij}
$$

其中，$Y_{ij}$ 是第 $i$ 个受试者在第 $j$ 个时间点（或条件下）的观测值。模型的各个组成部分解释如下 [@problem_id:4948305]：
- $\mu$：所有观测值的总平均值 (grand mean)。
- $\alpha_j$：第 $j$ 个时间点的固定效应 (fixed effect)，表示第 $j$ 个时间点的总体均值与总平均值 $\mu$ 的偏差。为了模型的参数可以被唯一识别，通常会施加一个约束，如 $\sum_{j=1}^t \alpha_j = 0$，其中 $t$ 是重复测量的次数。
- $s_i$：第 $i$ 个受试者的效应。这代表了受试者间的固有差异，即每个受试者自身的平均水平相对于总平均值的偏差。在重复测量设计中，受试者是其自身数据的“区组” (block)。
- $\epsilon_{ij}$：[随机误差](@entry_id:144890)项，代表了除去时间效应和受试者效应之外的剩余变异。

与标准[方差分析](@entry_id:275547)的关键区别在于对误差项 $\epsilon_{ij}$ 的假设。对于同一个受试者 $i$，其在不同时间点 $j$ 的误差项 $\epsilon_{i1}, \epsilon_{i2}, \dots, \epsilon_{it}$ 通常是相关的，而不是相互独立的。这种相关性被一个 $t \times t$ 的协方差矩阵 $\boldsymbol{\Sigma}$ 所描述。单变量重复测量方差分析的 $F$ 检验的有效性，并不要求这些测量完全独立，但它依赖于一个比独立性更弱的假设，即 **球形性**。

### 理解球形性

球形性是重复测量方差分析中最为核心也最常被误解的概念。它涉及重复测量数据内部的协方差结构。

#### 核心概念：差异方差的[同质性](@entry_id:636502)

从最直观的层面理解，**球形性** (sphericity) 假设指的是，在所有重复测量的时间点中，任意两对时间点之间差值的方差都是相等的 [@problem_id:4948305] [@problem_id:4919615]。换句话说，对于任意两个不同的时间点 $j$ 和 $k$，方差 $\operatorname{Var}(Y_{ij} - Y_{ik})$ 都是一个常数。

我们可以用协方差矩阵 $\boldsymbol{\Sigma}$ 的元素来表达这个条件。设 $\sigma_{jj}$ 为第 $j$ 个时间点的方差，$\sigma_{jk}$ 为第 $j$ 和第 $k$ 个时间点之间的协方差，则：

$$
\operatorname{Var}(Y_{ij} - Y_{ik}) = \operatorname{Var}(Y_{ij}) + \operatorname{Var}(Y_{ik}) - 2\operatorname{Cov}(Y_{ij}, Y_{ik}) = \sigma_{jj} + \sigma_{kk} - 2\sigma_{jk}
$$

球形性要求对于所有 $j \neq k$ 的组合，这个值都保持不变。

#### 球形性与其他协方差结构的关系

为了更清晰地理解球形性，我们将其与其他几种常见的协方差结构进行比较 [@problem_id:4948286]。

- **[方差齐性](@entry_id:167143) (Homoscedasticity)**：指所有重复测量的方差都相等，即 $\sigma_{11} = \sigma_{22} = \dots = \sigma_{tt}$。这仅仅是球形性的一个组成部分，但并非充分条件。
- **独立性 (Independence)**：指所有重复测量之间均不相关，即所有非对角线上的协方差 $\sigma_{jk} = 0$ ($j \neq k$)。
- **复合对称性 (Compound Symmetry, CS)**：这是一个更强的假设，它要求所有测量点的方差都相等（[方差齐性](@entry_id:167143)），并且所有不同测量点对之间的协方差也都相等。即 $\sigma_{jj} = v$ 且 $\sigma_{jk} = c$ 对于所有 $j \neq k$。

复合对称性必然满足球形性，因为在这种情况下，$\operatorname{Var}(Y_{ij} - Y_{ik}) = v + v - 2c = 2(v - c)$，这是一个常数 [@problem_id:4919615]。然而，反之不成立——满足球形性并不一定意味着满足复合对称性。球形性是一个更弱、更不严格的条件。

让我们通过一个具体的例子来阐明这些区别 [@problem_id:4948286]。假设我们有三组不同的 $3 \times 3$ 协方差矩阵：
$$
\boldsymbol{\Sigma}_1=\begin{pmatrix} 1  & 1 & 1.5 \\ 1 & 2 & 2 \\ 1.5 & 2 & 3 \end{pmatrix}, \quad
\boldsymbol{\Sigma}_2=\begin{pmatrix} 1 & 0.5 & 0.2 \\ 0.5 & 1 & 0.1 \\ 0.2 & 0.1 & 1 \end{pmatrix}, \quad
\boldsymbol{\Sigma}_3=\begin{pmatrix} 1 & 0 & 0 \\ 0 & 2 & 0 \\ 0 & 0 & 3 \end{pmatrix}
$$

- 对于 $\boldsymbol{\Sigma}_1$：其对角线元素 (1, 2, 3) 不同，因此不满足[方差齐性](@entry_id:167143)。但计算其所有配对差值的方差：$\operatorname{Var}(Y_1-Y_2)=1+2-2(1)=1$，$\operatorname{Var}(Y_1-Y_3)=1+3-2(1.5)=1$，$\operatorname{Var}(Y_2-Y_3)=2+3-2(2)=1$。所有差值的方差都相等，因此 $\boldsymbol{\Sigma}_1$ **满足** 球形性。这证明了球形性并不需要[方差齐性](@entry_id:167143)或复合对称性。
- 对于 $\boldsymbol{\Sigma}_2$：其对角线元素 (1, 1, 1) 相同，满足[方差齐性](@entry_id:167143)。但其差值方差为：$\operatorname{Var}(Y_1-Y_2)=1+1-2(0.5)=1$，$\operatorname{Var}(Y_1-Y_3)=1+1-2(0.2)=1.6$。由于差值方差不全相等，$\boldsymbol{\Sigma}_2$ **不满足** 球形性。这说明仅有[方差齐性](@entry_id:167143)是不够的。
- 对于 $\boldsymbol{\Sigma}_3$：其非对角[线元](@entry_id:196833)素全为0，满足独立性。但其差值方差为：$\operatorname{Var}(Y_1-Y_2)=1+2-2(0)=3$，$\operatorname{Var}(Y_1-Y_3)=1+3-2(0)=4$。差值方差不相等，因此 $\boldsymbol{\Sigma}_3$ **不满足** 球形性。这表明独立性本身也不能保证球形性，除非方差也恰好相等。

#### 更深层次的视角：球形性的几何与代数表达

为了更精确地定义球形性，我们需要引入 **对比 (contrast)** 的概念。一个对比是重复测量数据的一个[线性组合](@entry_id:155091)，其系数之和为零。例如，$Y_1 - Y_2$ 就是一个简单的对比。所有对比向量构成的空间被称为对比子空间。

球形性可以被更一般地定义为：所有标准化的对比都具有相同的方差。从代数上讲，这可以用一个投影矩阵来表达。设 $\mathbf{P} = \mathbf{I} - \frac{1}{t}\mathbf{J}$ 是一个将向量投影到对比子空间的[正交投影](@entry_id:144168)矩阵（其中 $\mathbf{I}$ 是单位矩阵，$\mathbf{J}$ 是全1矩阵）。球形性条件等价于以下[矩阵方程](@entry_id:203695) [@problem_id:4948342] [@problem_id:4948323]：

$$
\mathbf{P}\boldsymbol{\Sigma}\mathbf{P} = \lambda \mathbf{P}
$$

其中 $\lambda$ 是一个标量。这个方程的几何意义是，当我们将原始数据的协方差椭球投影到 $(t-1)$ 维的对比子空间时，这个投影后的椭球是一个完美的 **超球面 (hypersphere)** [@problem_id:4948323]。这意味着在对比子空间中，变异在所有方向上都是均等的（各向同性）。当球形性被违反时，这个投影后的椭球就变成了一个各向异性的椭球体，意味着不同方向（即不同对比）的变异程度是不同的。

### 检测与量化球形性违规

#### 违规的后果

为何我们如此关注球形性？因为当球形性假设被违反时，用于重复测量方差分析的 $F$ 统计量的零分布不再精确地服从标准的 $F$ 分布。具体来说，误差项的方差会被低估，导致计算出的 $F$ 值系统性地偏高。这会使得我们更容易拒绝一个实际上成立的原假设，从而导致 **[第一类错误](@entry_id:163360)率 (Type I error rate) 的膨胀** [@problem_id:4919615] [@problem_id:4546892]。换句话说，检验会变得过于“自由” (liberal)。

#### 莫奇利球形性检验 (Mauchly's Test of Sphericity)

为了正式检验球形性假设是否成立，我们可以使用 **莫奇利检验**。其[检验统计量](@entry_id:167372) $W$ 的构造非常巧妙。设想在对比子空间中，协方差矩阵有 $q=t-1$ 个特征值 $\lambda_1, \dots, \lambda_q$。莫奇利统计量 $W$ 与以下比率成正比 [@problem_id:4948344]：

$$
\frac{\prod_{i=1}^q \lambda_i}{\left(\frac{1}{q} \sum_{i=1}^q \lambda_i\right)^q}
$$

分子是这些特征值的几何平均值的 $q$ 次方，而分母是它们的算术平均值的 $q$ 次方。根据算术平均-几何平均 (AM-GM) 不等式，这个比率总是不大于1，并且只有在所有特征值都相等时（即满足球形性时）才等于1。当特征值变得越来越不相等时（即球形性违规越严重），几何平均值相对于算术平均值会变得更小，从而导致 $W$ 值趋近于0。因此，一个显著小的 $W$ 值（以及与之相关的显著的 $p$ 值）表明球形性假设被违反。

#### Epsilon ($\epsilon$) 校正因子

莫奇利检验只告诉我们是否存在违规，但没有告诉我们违规的严重程度。**Epsilon ($\epsilon$) 校正因子** 就是一个用来量化球形性偏离程度的指标。它的取值范围是 $[\frac{1}{t-1}, 1]$。
- 当 $\epsilon = 1$ 时，表示数据完全满足球形性。
- 当 $\epsilon$ 越接近其下限 $\frac{1}{t-1}$ 时，表示违规越严重。这个下限对应于最极端的不均匀情况，即所有对比的方差都集中在单一维度上 [@problem_id:4948331]。

$\epsilon$ 的一个重要解释是，它代表了重复测量数据的 **“[有效维度](@entry_id:146824)” (effective dimensionality)** [@problem_id:4948301]。虽然我们有 $t-1$ 个[正交对](@entry_id:164779)比，但当球形性被违反时，它们在信息量上的贡献是不平等的。$\epsilon$ 值衡量了这些维度“等效于”多少个完全独立的维度。例如，如果有 $t=6$ 个时间点（即 $t-1=5$ 个对比维度），$\epsilon=0.5$ 意味着数据的变异结构使得这5个维度实际上只等效于 $5 \times 0.5 = 2.5$ 个满足球形性条件的维度。

### 对球形性违规的校正

当检测到球形性被违反时，我们不能直接使用标准的 $F$ 检验结果。正确的做法是调整 $F$ 检验的自由度，使其推断更为保守和准确。这种调整正是通过我们刚刚讨论的 $\epsilon$ 因子来完成的。

标准的 $F$ 检验自由度为 $df_1 = t-1$ 和 $df_2 = (n-1)(t-1)$。校正后的自由度则是将原自由度乘以 $\epsilon$ 的一个估计值 $\hat{\epsilon}$：

$$
df'_{\text{num}} = \hat{\epsilon}(t-1)
$$
$$
df'_{\text{den}} = \hat{\epsilon}(n-1)(t-1)
$$

$F$ 统计量本身保持不变，但我们会用这个校正后的自由度去查找 $F$ 分布的临界值并计算 $p$ 值。由于 $\hat{\epsilon} \le 1$，自由度被调低了，这会导致临界值变大，使得检验更加严格，从而控制了膨胀的[第一类错误](@entry_id:163360)率。

目前主要有两种广泛使用的 $\hat{\epsilon}$ 估计方法：

#### Greenhouse-Geisser (GG) 校正

Greenhouse-Geisser (GG) 方法提供了一个对 $\epsilon$ 的估计值，通常记为 $\hat{\epsilon}_{GG}$。其计算公式基于样本协方差矩阵 $\hat{\boldsymbol{\Sigma}}$ [@problem_id:4948347]：
$$
\hat{\epsilon}_{GG} = \frac{\left(\mathrm{tr}(C\hat{\boldsymbol{\Sigma}})\right)^2}{(t-1)\mathrm{tr}((C\hat{\boldsymbol{\Sigma}})^2)}
$$
GG 校正是一种非常稳健的方法，但它在小样本情况下往往会过度校正，即它估计的 $\hat{\epsilon}_{GG}$ 常常会低于真实的 $\epsilon$ 值，导致检验结果过于保守（损失统计功效）[@problem_id:4948332]。

#### Huynh-Feldt (HF) 校正

为了解决 GG 校正的保守性问题，Huynh 和 Feldt 提出了一种修正方法。Huynh-Feldt (HF) 校正通过对 $\hat{\epsilon}_{GG}$ 进行调整，以减少其在小样本中的负向偏差，从而提供一个通常更接近真实 $\epsilon$ 的估计值 $\hat{\epsilon}_{HF}$ [@problem_id:4948332]。其计算公式为：

$$
\hat{\epsilon}_{HF} = \min\left(1, \frac{n(t-1)\hat{\epsilon}_{GG}-2}{(t-1)(n-1)}\right)
$$

其中 $n$ 是受试者数量。这个公式通过对 $\hat{\epsilon}_{GG}$ 的期望进行[逆向工程](@entry_id:754334)来校正其偏差，并确保结果不会超过理论上限1。通常情况下，$\hat{\epsilon}_{HF} \ge \hat{\epsilon}_{GG}$，这使得 HF 校正比 GG 校正稍显“自由”一些。

#### 一个实践案例

假设一项研究有 $n=26$ 名参与者和 $t=6$ 个时间点。标准的 $F$ 检验分母自由度为 $(26-1) \times (6-1) = 125$。如果莫奇利检验显著，并且计算出的 Greenhouse-Geisser 因子为 $\hat{\epsilon}_{GG} = 0.58$，那么校正后的分母自由度将是 [@problem_id:4948301]：

$$
df'_{\text{den}} = 0.58 \times (26-1)(6-1) = 0.58 \times 125 = 72.5
$$

同样，[分子自由度](@entry_id:175192)将从 $6-1=5$ 调整为 $0.58 \times 5 = 2.9$。研究者在报告结果时，应报告这个校正后的自由度以及相应的 $p$ 值。

在选择校正方法时，一般的建议是：如果估计的 $\epsilon$ 值很低（例如，小于0.75），GG 校正可能是更安全的选择；如果 $\epsilon$ 值接近1，HF 校正可能更好，因为它具有更高的统计功效。许多统计软件会同时提供这两种校正的结果，供研究者参考。