## 引言
在统计建模的征途中，获得一个拟合的模型只是旅程的起点。一个更为关键且常被忽视的步骤是进行严格的诊断检验，以确保模型的基本假设与数据相符，并且其结论不会被少数异常观测所扭曲。[残差分析](@entry_id:191495)，即对模型[预测误差](@entry_id:753692)的系统性研究，正是这一诊断过程的核心。然而，对残差的误解和对诊断流程的忽视，往往会导致分析者得出脆弱甚至错误的科学结论。本文旨在填补这一知识鸿沟，提供一份从理论到实践的全面指南。
在接下来的内容中，我们将分三步深入探索[残差分析](@entry_id:191495)的世界。首先，在“原理与机制”一章，我们将揭示残差的本质，从线性模型中的[帽子矩阵](@entry_id:174084)和[杠杆值](@entry_id:172567)，到[广义线性模型](@entry_id:171019)和生存模型中更为复杂的残差形式。接着，在“应用与跨学科联系”一章，我们将展示这些诊断工具如何在生物统计、流行病学等真实研究场景中发挥作用，帮助研究者精炼模型、增强结论的稳健性。最后，通过一系列“动手实践”练习，您将有机会亲手实现和应用所学知识，将理论内化为技能。这一结构化的学习路径将引导您掌握进行严谨、可靠的统计分析所必备的诊断技术。

## 原理与机制

在统计建模中，拟合一个模型仅仅是分析过程的开端。一个同样重要甚至更为关键的步骤是**诊断检验**（diagnostic checks），即评估模型假设是否被数据充分支持，并识别可能对模型结论产生过度影响的异常观测。[残差分析](@entry_id:191495)是这一诊断过程的核心。本章将深入探讨[残差分析](@entry_id:191495)的根本原理与核心机制，从最基础的线性模型开始，逐步扩展到更复杂的[广义线性模型](@entry_id:171019)和生存模型。

### [线性模型](@entry_id:178302)中的基础：普通残差

在线性回归的框架下，我们假设响应变量 $y$ 与预测变量 $X$ 之间存在关系 $y = X\beta + \varepsilon$。其中，$\beta$ 是待估计的参数向量，而 $\varepsilon$ 是代表随机变化或模型未解释部分的**误差向量**（error vector）。这个误差向量是理论上的实体，本质上是**不可观测的**。

在实践中，我们使用数据 $(X, y)$ 来获得 $\beta$ 的估计值，即 $\hat{\beta}$，通常通过**[普通最小二乘法](@entry_id:137121)** (Ordinary Least Squares, OLS) 实现。基于此估计，我们可以计算出每个观测的**拟合值**（fitted values），$\hat{y} = X\hat{\beta}$。**普通残差**（ordinary residual）$e$ 被定义为观测值与拟合值之间的差异：

$$
e = y - \hat{y}
$$

[残差向量](@entry_id:165091) $e$ 是一个可计算的、具体的量，它可被视为不可观测的误差向量 $\varepsilon$ 的**估计**或**代理**。然而，将残差与误差简单等同是一个普遍但严重的误解。尽管在理想条件下，残差的性质会反映误差的性质，但它们之间存在着根本的、系统性的差异 [@problem_id:4949161]。理解这些差异是进行有效[模型诊断](@entry_id:136895)的第一步。

此外，样本内（in-sample）残差与样本外（out-of-sample）的**预测误差**（prediction error）在概念上也有着本质区别。对于一个具有新协变量 $x_{\text{new}}$ 的观测，其[预测误差](@entry_id:753692)为 $y_{\text{new}} - x_{\text{new}}^{\top} \hat{\beta}$。这个误差可以分解为两个部分：一部分是新观测自身的随机误差 $\varepsilon_{\text{new}} = y_{\text{new}} - x_{\text{new}}^{\top} \beta$，另一部分是由于我们使用估计系数 $\hat{\beta}$ 而非真实系数 $\beta$ 带来的估计误差 $x_{\text{new}}^{\top}(\hat{\beta} - \beta)$ [@problem_id:4949161]。因此，预测误差包含了模型内在的、不可约的变异性以及由于参数估计不确定性所导致的可约变异性，这与作为拟合优度度量的样本内残差截然不同。

### OLS残差的性质：[帽子矩阵](@entry_id:174084)与[杠杆值](@entry_id:172567)

为了精确理解OLS残差的特性，我们必须引入一个关键工具——**[帽子矩阵](@entry_id:174084)**（hat matrix），记为 $H$。[OLS估计量](@entry_id:177304) $\hat{\beta}$ 的解为 $\hat{\beta} = (X^{\top}X)^{-1}X^{\top}y$。因此，拟合值向量可以表示为：

$$
\hat{y} = X\hat{\beta} = X(X^{\top}X)^{-1}X^{\top}y = Hy
$$

[帽子矩阵](@entry_id:174084) $H = X(X^{\top}X)^{-1}X^{\top}$ 是一个 $n \times n$ 的矩阵，它直接将观测响应向量 $y$ “戴上帽子”，映射为拟合值向量 $\hat{y}$。从几何上看，$H$ 是一个将任意向量正交投影到由设计矩阵 $X$ 的列向量所张成的子空间（即 $X$ 的列空间, $\mathcal{C}(X)$）上的**投影矩阵** [@problem_id:4949166]。这意味着 $\hat{y}$ 是在 $\mathcal{C}(X)$ 中与 $y$ 欧氏距离最近的唯一向量。

利用[帽子矩阵](@entry_id:174084)，[残差向量](@entry_id:165091)可以写为：

$$
e = y - \hat{y} = y - Hy = (I - H)y
$$

将模型 $y = X\beta + \varepsilon$ 代入，我们得到残差与真实误差之间的确切关系：

$$
e = (I - H)(X\beta + \varepsilon) = (I - H)X\beta + (I - H)\varepsilon
$$

由于 $H$ 投影到 $X$ 的[列空间](@entry_id:156444)，它具有性质 $HX=X$。因此，第一项 $(I-H)X\beta = X\beta - HX\beta = 0$。这揭示了一个深刻的结果：

$$
e = (I - H)\varepsilon
$$

这个简单的方程是[残差分析](@entry_id:191495)的基石。它表明，OLS[残差向量](@entry_id:165091)并非误差向量本身，而是误差向量经过[线性变换](@entry_id:143080) $(I-H)$ 后的结果。这一变换施加了若干重要的结构性约束，使得残差的性质与误差的性质显著不同。

首先，假设误差满足标准假设，即 $E(\varepsilon) = 0$ 且 $\mathrm{Var}(\varepsilon) = \sigma^2 I_n$（即误差不相关且方差恒定）。我们可以推导出残差的均值和方差：

$$
E(e) = E((I - H)\varepsilon) = (I - H)E(\varepsilon) = 0
$$

$$
\mathrm{Var}(e) = \mathrm{Var}((I - H)\varepsilon) = (I - H)\mathrm{Var}(\varepsilon)(I - H)^{\top} = (I - H)(\sigma^2 I_n)(I - H) = \sigma^2(I - H)
$$

这里我们利用了[投影矩阵](@entry_id:154479) $H$ 的对称性 ($H^{\top}=H$) 和[幂等性](@entry_id:190768) ($H^2=H$)，这同样适用于 $(I-H)$。

$\mathrm{Var}(e) = \sigma^2(I - H)$ 这个结果带来了两个关键洞见：

1.  **残差是相关的**：$\mathrm{Var}(e)$ 矩阵的非对角元素为 $-\sigma^2 h_{ij}$，通常不为零。这意味着即使真实的误差 $\varepsilon_i$ 是相互独立的，OLS残差 $e_i$ 和 $e_j$ 之间也存在协方差。例如，对于一个简单的[线性回归](@entry_id:142318)模型，我们可以计算出任意两个残差之间的协方差。考虑一个[设计矩阵](@entry_id:165826) $X = \begin{pmatrix} 1  0 \\ 1  1 \\ 1  2 \\ 1  3 \end{pmatrix}$，残差 $e_1$ 和 $e_4$ 之间的协方差为 $\mathrm{Cov}(e_1, e_4) = -\sigma^2 H_{14}$。经过计算，可以得到 $H_{14} = -1/5$，因此 $\mathrm{Cov}(e_1, e_4) = \frac{1}{5}\sigma^2$ [@problem_id:4949200]。这个正协方差意味着，如果一个端点的残差为正，另一个端点的残差也倾向于为正，这完全是OLS拟合过程施加的数学约束所致。

2.  **残差是异方差的**：单个残差 $e_i$ 的方差是 $\mathrm{Var}(e)$ 的第 $i$ 个对角元素，即 $\mathrm{Var}(e_i) = \sigma^2(1 - h_{ii})$。这里的 $h_{ii}$ 是[帽子矩阵](@entry_id:174084) $H$ 的第 $i$ 个对角元素，被称为第 $i$ 个观测的**杠杆值**（leverage value）。由于不同观测的 $h_{ii}$ 值通常不同，这意味着即使真实误差的方差 $\sigma^2$ 是恒定的（[同方差性](@entry_id:634679)），OLS残差的方差也不是恒定的（[异方差性](@entry_id:136378)）。

[杠杆值](@entry_id:172567) $h_{ii}$ 本身是一个重要的诊断量，它度量了第 $i$ 个观测的预测变量向量 $x_i$ 在所有预测变量构成的“点云”中的极端程度 [@problem_id:4949166]。$h_{ii}$ 的值介于 $0$ 和 $1$ 之间，所有杠杆值的总和等于模型参数的个数 $p$，即 $\sum_{i=1}^n h_{ii} = p$。一个高杠杆值的观测（$h_{ii}$ 远大于平均值 $p/n$）意味着该点在预测变量空间中处于一个“偏远”的位置，对回归线的位置有很大的潜在拉动作用。

$\mathrm{Var}(e_i) = \sigma^2(1 - h_{ii})$ 这个关系式清楚地表明，高[杠杆值](@entry_id:172567)的观测（$h_{ii}$ 接近1）其对应的残差方差会更小。这是因为回归线被迫向这些[高杠杆点](@entry_id:167038)靠近，从而使得它们的残差 $e_i = y_i - \hat{y}_i$ 倾向于更小。因此，直接比较不同[杠杆值](@entry_id:172567)观测的原始残差大小 $|e_i|$ 是不公平的，这会混淆模型真实拟合的不足与由杠杆值效应导致的方差差异 [@problem_id:4949162]。

### [标准化残差](@entry_id:634169)与[离群点检测](@entry_id:175858)

由于原始OLS残差具有非恒定的方差，我们需要对其进行标准化，以使其具有可比性，从而能够公正地评估哪些观测值是“异常”的（即离群点）。

最直接的方法是将每个残差除以其标准差的估计值。这引出了**内部[学生化残差](@entry_id:636292)**（internally studentized residual），有时也称为[标准化残差](@entry_id:634169)：

$$
t_i = \frac{e_i}{\widehat{\mathrm{sd}}(e_i)} = \frac{e_i}{\hat{\sigma}\sqrt{1-h_{ii}}}
$$

其中，$\hat{\sigma}^2 = \frac{\sum e_j^2}{n-p}$ 是基于所有 $n$ 个观测计算的[误差方差](@entry_id:636041)的[无偏估计](@entry_id:756289)。这种残差考虑了[杠杆效应](@entry_id:137418)，使得它们的[方差近似](@entry_id:268585)为1。然而，由于分子 $e_i$ 和分母中的 $\hat{\sigma}$ 都依赖于第 $i$ 个观测，它们不是独立的。因此，在正态误差假设下，$t_i$ 并不严格服从t分布 [@problem_id:4949181]。

为了进行更严格的统计检验，我们引入**外部[学生化残差](@entry_id:636292)**（externally studentized residual），也称为[学生化](@entry_id:176921)删除残差（studentized deleted residual）或R-student：

$$
t_i^* = \frac{e_i}{\hat{\sigma}_{(i)}\sqrt{1-h_{ii}}}
$$

这里的关键区别在于分母中的 $\hat{\sigma}_{(i)}$。$\hat{\sigma}_{(i)}^2$ 是在**移除第 $i$ 个观测后**重新拟合模型所得的[误差方差估计](@entry_id:167285)。其计算基于 $n-1$ 个观测，自由度为 $(n-1)-p = n-p-1$。通过这种方式，分子 $e_i$（来自完整模型）与分母 $\hat{\sigma}_{(i)}$ 在统计上是独立的。这个精巧的构造使得在正态误差假设下，$t_i^*$ 精确地服从自由度为 $n-p-1$ 的**[t分布](@entry_id:267063)** [@problem_id:4949181]。因此，外部[学生化残差](@entry_id:636292)是识别离群点的首选工具，我们可以将其与t分布的临界值进行比较，以进行正式的[假设检验](@entry_id:142556)。

### 超越离群点：使用[Cook距离](@entry_id:175103)衡量影响

一个具有大残差的观测（离群点）并不一定对回归结果产生重大影响。一个观测的影响力取决于两个因素：它离回归模型有多远（残差大小），以及它在预测变量空间中的位置有多大的“拉力”（杠杆值）。一个高杠杆、低残差的点可能比一个低杠杆、高残差的点更具影响力。

为了综合评估一个观测的整体影响，我们使用**[影响诊断](@entry_id:167943)**（influence diagnostics），其中最著名的是**[Cook距离](@entry_id:175103)**（Cook's distance），记为 $D_i$。[Cook距离](@entry_id:175103)衡量了当第 $i$ 个观测从数据集中删除后，整个拟合值向量 $\hat{y}$ 发生的变化有多大。其定义为：

$$
D_i = \frac{(\hat{y} - \hat{y}_{(i)})^{\top}(\hat{y} - \hat{y}_{(i)})}{p\hat{\sigma}^2} = \frac{\sum_{j=1}^n (\hat{y}_j - \hat{y}_{j,(i)})^2}{p\hat{\sigma}^2}
$$

其中 $\hat{y}_{(i)}$ 是删除第 $i$ 个观测后重新计算的拟合值向量。这个定义直观地量化了删除一个点对所有拟合值的总体影响。通过代数推导，[Cook距离](@entry_id:175103)可以更方便地用单个观测的残差和[杠杆值](@entry_id:172567)来计算 [@problem_id:4949199]：

$$
D_i = \frac{e_i^2}{p\hat{\sigma}^2} \cdot \frac{h_{ii}}{(1-h_{ii})^2}
$$

这个公式优雅地展示了[Cook距离](@entry_id:175103)是如何将残差的平方（$e_i^2$，衡量拟合程度）和杠杆值（$h_{ii}$，衡量潜在影响）结合在一起的。只有当一个观测同时具有较大的残差和不可忽略的[杠杆值](@entry_id:172567)时，它的[Cook距离](@entry_id:175103)才会很大，从而被判定为**[强影响点](@entry_id:170700)**（influential point）。通常，研究者会将 $D_i > 4/n$ 或 $D_i > 1$ 作为需要进一步审查该观测的阈值。

### 检验核心模型假设

残差不仅用于识别单个异常点，更重要的是用于检验模型赖以成立的各项基本假设。

#### [正态性假设](@entry_id:170614)

在线性模型推断中，一个常见的假设是误差项 $\varepsilon$ 服从正态分布。理解这个假设的作用至关重要。根据**[高斯-马尔可夫定理](@entry_id:138437)**，只要满足误差零均值、同方差和不相关，[OLS估计量](@entry_id:177304) $\hat{\beta}$ 就是所有线性无偏估计中方差最小的（BLUE）。这个最优性质**并不需要[正态性假设](@entry_id:170614)** [@problem_id:4949172]。

[正态性假设](@entry_id:170614)的核心作用在于**有限样本下的精确推断**。只有当误差是正态分布时，我们才能精确推导出：
1.  $\hat{\beta}$ 的[线性组合](@entry_id:155091)（如 $c^{\top}\hat{\beta}$）服从正态分布。
2.  [残差平方和](@entry_id:174395)（SSE）经过缩放后服从[卡方分布](@entry_id:165213)。
3.  $\hat{\beta}$ 与[残差平方和](@entry_id:174395)相互独立 [@problem_id:4949161]。

这三条性质是构建精确t检验和[F检验](@entry_id:274297)的理论基础。如果没有正态性，这些检验统计量在有限样本中就不再精确服从[t分布](@entry_id:267063)或[F分布](@entry_id:261265) [@problem_id:4949172]。

然而，在**大样本**中，即使误差非正态，[中心极限定理](@entry_id:143108)通常也能保证 $\hat{\beta}$ 的抽样分布近似于正态分布。这意味着基于正态性的推断（[t检验](@entry_id:272234)和[F检验](@entry_id:274297)）是**[渐近有效](@entry_id:167883)**的。尽管如此，对于小样本或当误差分布严重偏离正态时，检验的实际I类错误率可能与名义水平不符。因此，通过检查残差的**[Q-Q图](@entry_id:174944)**（[分位数-分位数图](@entry_id:174944)）或进行**[Shapiro-Wilk检验](@entry_id:173200)**等来评估[正态性假设](@entry_id:170614)，仍然是重要的诊断步骤。

#### 独立性假设：检测自相关

OLS的另一个核心假设是误差项 $\varepsilon_i$ 相互独立。当数据具有时间或空间序列结构时，这个假设尤其容易被违反。例如，在分析每周的医院数据时，本周的随机影响因素可能会持续到下周，导致误差项之间存在**[自相关](@entry_id:138991)**（autocorrelation）或序列相关。

最简单的[自相关](@entry_id:138991)结构是**一阶自相关**（first-order autocorrelation），通常用[AR(1)模型](@entry_id:265801)描述：$\epsilon_t = \rho \epsilon_{t-1} + u_t$，其中 $u_t$ 是一个不相关的白噪声项，$\rho$ 是自相关系数。

当误差存在正[自相关](@entry_id:138991)（$\rho > 0$）时，会产生严重后果 [@problem_id:4949173]：
1.  OLS估计的系数 $\hat{\beta}$ 在标准条件下（如严格[外生性](@entry_id:146270)）仍然是**无偏的**。
2.  但 $\hat{\beta}$ 不再是有效的（即不再是BLUE）。
3.  最严重的是，传统的OLS标准误公式 $\mathrm{se}(\hat{\beta}_j)$ 是**有偏的且通常是系统性低估的**。这会导致[t统计量](@entry_id:177481)被人为夸大，[p值](@entry_id:136498)被人为缩小，从而得出虚假的“显著”结论。

诊断自相关的常用工具包括：
-   **残差-时间图**：正自相关会使[残差图](@entry_id:169585)呈现出“粘性”，即正残差之后倾向于跟随正残差，负残差之后倾向于跟随负残差，形成明显的“长串”或“波浪”模式。
-   **[Durbin-Watson统计量](@entry_id:143204)**：该统计量值域为0到4。若值接近2，表示无一阶自相关；若值显著小于2，表示存在正[自相关](@entry_id:138991)；若值显著大于2，表示存在负[自相关](@entry_id:138991)。
-   **残差[自相关函数](@entry_id:138327)（ACF）图**：该图显示了残差与其各阶滞后项之间的样本相关系数。对于[AR(1)过程](@entry_id:746502)，在滞后1阶处会有一个显著的尖峰。

若检测到自相关，应使用对自相关稳健的推断方法，例如采用**异方差和自相关稳健（HAC）的标准误**，也称为“三明治”估计量（sandwich estimator） [@problem_id:4949173]。

### 超越线性模型：广义化残差

残差的概念可以推广到更广泛的模型类别，尽管其定义需要根据模型的特性进行调整。

#### 广义线性模型(GLM)中的残差

在广义线性模型（GLM）中，响应变量的分布可以是泊松分布、二项分布等非正态分布，且响应变量的期望 $\mu_i$ 通过一个链接函数 $g(\cdot)$ 与线性预测器 $\eta_i = x_i^{\top}\beta$ 相关联。在这种情况下，简单的残差 $y_i - \hat{\mu}_i$ 同样存在方差不恒定的问题，且其分布高度依赖于 $\mu_i$。因此，需要更精细的残差定义 [@problem_id:4949137]：

-   **皮尔逊残差 (Pearson residual)**：它将原始残差通过模型隐含的方差进行标准化。
    $$
    r_{Pi} = \frac{y_i - \hat{\mu}_i}{\sqrt{V(\hat{\mu}_i)}}
    $$
    其中 $V(\mu_i)$ 是方差函数，描述了方差如何随均值变化，例如对于泊松分布，$V(\mu_i) = \mu_i$。皮尔逊残差的平方和近似服从[卡方分布](@entry_id:165213)，可用于[拟合优度检验](@entry_id:267868)。

-   **偏离度残差 (Deviance residual)**：它度量了每个观测对模型总偏离度（deviance）的贡献。偏离度是[饱和模型](@entry_id:150782)（完美拟合数据的模型）与所拟合模型之间[对数似然](@entry_id:273783)差异的两倍。偏离度残差被定义为该贡献的带符号平方根：
    $$
    r_{Di} = \mathrm{sign}(y_i - \hat{\mu}_i) \sqrt{d_i}
    $$
    其中 $d_i$ 是第 $i$ 个观测的偏离度贡献。偏离度残差通常比皮尔逊残差具有更好的统计性质（例如更接近正态分布），因此在图形诊断中更受欢迎。

-   **工作残差 (Working residual)**：它是在拟合GLM的迭代重加权最小二乘（IRLS）算法中产生的中间量，定义为 $r_{Wi} = (y_i - \hat{\mu}_i) \frac{d\eta_i}{d\mu_i}$。它在算法内部扮演重要角色，但在[模型诊断](@entry_id:136895)中较少直接使用。

#### 生存模型中的残差：Cox模型

在生存分析中，特别是对于**Cox比例风险模型**，残差的定义需要处理删失数据（censoring）和事件发生时间的动态过程。其中最重要的是**[鞅](@entry_id:267779)残差**（martingale residual）。

[Cox模型](@entry_id:164053)假设[风险函数](@entry_id:166593)为 $\lambda(t|x_i) = \lambda_0(t)\exp(x_i^{\top}\beta)$。鞅残差的核心思想是比较每个个体“观测到的事件数”与“期望的事件数”。对于个体 $i$，其在观测时间 $T_i$ 内的观测事件数是 $\delta_i$（事件发生为1，删失为0）。其期望事件数是到时间 $T_i$ 为止的累积风险 $\hat{\Lambda}(T_i|x_i)$。因此，鞅残差定义为 [@problem_id:4949150]：

$$
M_i = \text{观测事件数} - \text{期望事件数} = \delta_i - \hat{\Lambda}(T_i|x_i) = \delta_i - \hat{\Lambda}_0(T_i)\exp(x_i^{\top}\hat{\beta})
$$

[鞅](@entry_id:267779)残差具有一些独特的性质：
-   **范围**：其取值范围为 $(-\infty, 1]$。对于发生事件的个体（$\delta_i=1$），残差为 $1 - \hat{\Lambda}_i$，通常接近零；对于被删失的个体（$\delta_i=0$），残差为 $-\hat{\Lambda}_i$，总是负数 [@problem_id:4949150]。
-   **分布**：鞅残差的均值近似为零，但其分布是高度右偏的，远非正态。
-   **用途**：鞅残差的一个主要用途是**检验协变量的函数形式**。如果模型中某个连续协变量 $x_k$ 的函数形式（通常假定为线性）设定正确，那么[鞅](@entry_id:267779)残差 $M_i$ 与该协变量 $x_{ik}$ 的散点图应该没有系统性趋势。通过绘制平滑曲线（如LOESS），如果发现存在U形、线性或其他非平坦的模式，则表明需要对该协变量进行变换（如取对数、使用[样条](@entry_id:143749)函数等）[@problem_id:4949150]。

需要注意的是，鞅残差主要用于检查协变量函数形式和整体拟合优度，而评估[Cox模型](@entry_id:164053)的关键假设——**[比例风险假设](@entry_id:163597)**——则主要依赖于另一类残差，即**Schoenfeld残差**。这两种残差在[Cox模型](@entry_id:164053)诊断中扮演着互补的角色。