## 引言
在生物统计学、工程学乃至社会科学中，我们经常关注“事件发生需要多长时间”这一核心问题。无论是预测患者的存活时间、评估机器部件的寿命，还是分析用户流失的时间点，能够准确建模和分析时间-事件数据都至关重要。生存分析为此提供了一个强大的理论框架，其核心在于两个基本概念：生存函数与风险函数。然而，初学者往往难以理解这两个函数之间的深刻联系，以及如何将抽象的理论应用于充满数据不完整性（如删失）的真实世界问题中。

本文旨在系统性地扫清这些障碍。我们将从最基本的定义出发，带领读者构建起对生存分析的全面理解。文章分为三个主要部分：
*   在**原理与机制**部分，我们将从第一性原理出发，详细阐述生存函数（刻画存活概率）和[风险函数](@entry_id:166593)（衡量瞬时风险）的定义、性质及其内在的数学关系，并介绍处理[删失数据](@entry_id:173222)的基本思想和非[参数估计](@entry_id:139349)方法。
*   在**应用与跨学科联系**部分，我们将展示这些理论如何通[过参数化模型](@entry_id:637931)（如[指数和](@entry_id:199860)[威布尔分布](@entry_id:270143)）和强大的[Cox比例风险模型](@entry_id:174252)，在临床试验、工程可靠性、[金融风险](@entry_id:138097)和高维组学数据等多个领域解决实际问题，同时探讨[竞争风险](@entry_id:173277)和治愈模型等高级主题。
*   最后，在**动手实践**部分，您将有机会通过具体练习，亲手计算[Kaplan-Meier曲线](@entry_id:178171)和对数秩检验，从而将理论知识转化为实践技能。

通过学习本章，您将掌握生存分析的核心工具，并能够自信地将其应用于您所研究的领域。

## 原理与机制

在时间-事件分析领域，我们的核心目标是描述和建模从一个明确定义的起点到一个特定事件发生所需的时间。为了严谨地实现这一目标，我们需要建立一个数学框架，该框架能够量化事件随时间发生的模式。本章将系统地阐述两个核心概念——**生存函数 (survival function)** 和 **风险函数 (hazard function)**——以及它们之间的基本关系。我们将从第一性原理出发，构建这些函数，探讨它们在存在数据不完整（如删失和截断）时的估计方法，并最终介绍如何利用它们建立强大的预测模型。

### 生存函数：刻画存活概率

描述时间-事件数据最直观的方式是刻画在任意给定时间点之后，事件尚未发生的概率。这正是**生存函数 (survival function)** $S(t)$ 的核心思想。

假设 $T$ 是一个代表事件发生时间的非负[连续随机变量](@entry_id:166541)。生存函数 $S(t)$ 被严格定义为事件时间 $T$ 大于某个特定时间点 $t$ 的概率：
$$ S(t) = P(T > t) $$
这个函数也被称为存活函数。与之密切相关的是**累积分布函数 (cumulative distribution function, CDF)** $F(t)$，它表示事件在时间 $t$ 或之前发生的概率，即 $F(t) = P(T \le t)$。根据概率论的基本公理，一个事件要么发生，要么不发生，因此在任何时间 $t$， $P(T > t) + P(T \le t) = 1$。由此，我们得到了生存函数与[累积分布函数](@entry_id:143135)之间的简单关系：
$$ S(t) = 1 - F(t) $$

生存函数具有一些基本性质，这些性质源于其作为概率的定义 [@problem_id:4853746]。首先，在研究开始的时刻（$t=0$），我们假设所有研究对象都尚未经历事件，因此存活概率为 1。对于一个非负连续变量 $T$，$P(T=0)=0$，所以初始存活概率 $S(0) = P(T>0) = 1 - P(T=0) = 1$。其次，随着时间的推移，事件可能发生，存活的概率不会增加，因此 $S(t)$ 是一个**非增函数**。最后，随着时间趋于无穷，我们预期所有研究对象最终都会经历事件（在一个“有瑕疵”的世界里），因此生存曲线最终会趋近于零，即 $\lim_{t \to \infty} S(t) = 0$。这种情况被称为一个**正常的 (proper)** 概率分布。在某些理论场景中，如果一个事件可能永远不会发生（例如，治愈），那么这个极限可能大于零，这对应于一个**非正常的 (improper)** 分布。

### 风险函数：瞬时事件发生率

虽然生存函数直观地描述了“到目前为止”的累积存活情况，但它并不能直接回答一个在临床和工程领域至关重要的问题：在某个特定时刻 $t$，对于那些到目前为止仍然“存活”的个体，他们面临的瞬时风险有多大？例如，在器官移植后，患者在第一周的排异风险与一年后的风险显然是不同的。为了量化这种瞬时风险，我们引入了**[风险函数](@entry_id:166593) (hazard function)**，记为 $h(t)$。

风险函数 $h(t)$ 定义为在给定一个个体存活至时间 $t$ 的条件下，该个体在下一个极小时间区间 $[t, t+\Delta t)$ 内发生事件的[瞬时速率](@entry_id:182981) [@problem_id:4612141]。其数学定义如下：
$$ h(t) = \lim_{\Delta t \to 0^+} \frac{P(t \le T  t+\Delta t \mid T \ge t)}{\Delta t} $$
这个定义有几个关键点需要深入理解 [@problem_id:4853725]。
第一，[风险函数](@entry_id:166593)是一个**条件概率**的速率。它关注的是那些在时间 $t$ 仍处于风险中的个体（即 $T \ge t$）。
第二，它是一个**速率 (rate)**，而不是一个概率。它的单位是时间的倒数（例如，事件数/人-年）。因此，[风险函数](@entry_id:166593)的值可以大于 1，这并无不妥。一个 $h(t)=2$（单位：年$^{-1}$）的风险值意味着，在时间 $t$，对于任何一个存活的个体，其事件发生的瞬时速率为每年 2 次。这与概率必须在 $[0, 1]$ 区间内形成鲜明对比。

### 生存与风险的内在联系

生存函数和风险函数从不同角度描述了同一个[随机过程](@entry_id:268487)，因此它们之间存在着深刻的数学联系。我们可以通过[概率密度函数](@entry_id:140610) (probability density function, PDF) $f(t)$ 来建立这种联系。PDF $f(t)$ 是 $F(t)$ 的导数，即 $f(t) = F'(t) = -S'(t)$。

利用条件概率的定义，$P(t \le T  t+\Delta t \mid T \ge t) = \frac{P(t \le T  t+\Delta t)}{P(T \ge t)}$。对于一个连续变量，当 $\Delta t$ 很小时，$P(t \le T  t+\Delta t) \approx f(t)\Delta t$，并且 $P(T \ge t) = S(t)$。代入[风险函数](@entry_id:166593)的定义，我们得到：
$$ h(t) = \lim_{\Delta t \to 0^+} \frac{f(t)\Delta t / S(t)}{\Delta t} = \frac{f(t)}{S(t)} $$
这个公式 $h(t) = f(t)/S(t)$ 揭示了三者之间的基本关系：在任何时间点，瞬时风险率等于该点的事件发生密度除以在该点仍然存活的概率 [@problem_id:4612141]。

反过来，我们也可以从风险函数导出独一无二的生存函数。将 $h(t) = -S'(t)/S(t)$ 改写为 $h(t) = -\frac{d}{dt}\ln S(t)$。对两边从 0 到 $t$ 积分，并利用 $S(0)=1$（因此 $\ln S(0)=0$），我们得到：
$$ \int_0^t h(u) \, du = -\ln S(t) $$
这个积分被称为**[累积风险函数](@entry_id:169734) (cumulative hazard function)**，记为 $H(t) = \int_0^t h(u) \, du$。它代表了到时间 $t$ 为止累积的总风险。值得注意的是，即使瞬时风险 $h(t)$ 在某些时段下降，累积风险 $H(t)$ 也始终是时间的非减函数，因为它是在累加一个非负的量 [@problem_id:4612114]。

由此，我们得到了生存函数与[累积风险函数](@entry_id:169734)之间的指数关系：
$$ S(t) = \exp(-H(t)) = \exp\left(-\int_0^t h(u) \, du\right) $$
这个关系是生存分析的基石。它意味着，只要我们能定义任何一个非负的、局部可积的[风险函数](@entry_id:166593) $h(t)$，我们就能通过上式构建一个完全合法的生存分布 [@problem_id:4956177]。例如，在一个生物医学研究中，如果事件风险在前3个月是每月 $0.08$，在第3到第6个月下降到每月 $0.02$，在第6到第9个月又变为每月 $0.05$，那么在第9个月时的累积风险为 $H(9) = 0.08 \times 3 + 0.02 \times 3 + 0.05 \times 3 = 0.45$。对应的9个月生存概率就是 $S(9) = \exp(-0.45)$ [@problem_id:4612114]。

### 现实世界的数据：不完整观测

在理论世界中，我们可以假设事件时间 $T$ 总是可观测的。但在现实研究中，我们常常无法观测到所有研究对象的完整事件时间。这种数据不完整性主要有两种形式：删失 (censoring) 和截断 (truncation)。

#### [右删失](@entry_id:164686)与独立性假设

最常见的不完整数据类型是**右删失 (right-censoring)**。这发生在研究结束时事件仍未发生，或研究对象因故失访。我们只知道事件时间 $T$ 大于我们最后一次观测到他们的时间 $C$。因此，对于每个个体，我们实际观测到的是一对数据 $(\tilde{T}, \Delta)$，其中 $\tilde{T} = \min(T, C)$ 是观测到的随访时间，$\Delta = I(T \le C)$ 是一个事件指示符（如果事件发生则为1，如果被删失则为0）[@problem_id:4956153]。

为了能从这种[删失数据](@entry_id:173222)中有效推断真实的生存分布，我们必须做出一个至关重要的假设：**独立删失 (independent censoring)** 或称 **非信息性删失 (non-informative censoring)**。这个假设的正式表述是，在给定协变量 $X$ 的条件下，真实事件时间 $T$ 与删失时间 $C$ 相互独立，记为 $T \perp C \mid X$。通俗地讲，这意味着一个人的删失机制（例如，搬家导致失访）不应提供任何关于其事件风险的信息。如果删失是有信息性的（例如，病情最重的患者更倾向于退出研究），那么简单的统计方法将会产生严重偏倚的结论。独立删失假设是保证我们能够从观测数据 $(\tilde{T}, \Delta, X)$ 中识别出（即唯一确定）真实生存函数 $S(T)$ 的理论基石 [@problem_id:4956153]。

#### 左截断：延迟进入研究

另一种不完整数据形式是**左截断 (left truncation)**，或称**延迟进入 (delayed entry)**。这是一种**[抽样偏差](@entry_id:193615)**，而非信息缺失。它发生在研究对象不是从时间起点 $t=0$ 开始被观察，而是从一个较晚的时间点 $L_i > 0$ 才进入研究队列。其根本后果是，任何在进入研究之前就已经发生事件的个体（即 $T_i  L_i$）将永远不会被纳入样本。因此，我们观察到的样本实际上是条件样本，即以“存活超过其各自的进入时间 $L_i$”为条件。这与**[左删失](@entry_id:169731)**完全不同，后者是指我们知道事件在某个时间点 $L_i$ 之前发生，但不知道确切时间，这是一种信息不完整的问题 [@problem_id:4562399]。

在分析左[截断数据](@entry_id:163004)时，必须对风险集的定义进行修正。一个研究对象 $i$ 在时间 $t$ 处于“风险中”，当且仅当他已经进入研究并且尚未发生事件或被删失。使用[计数过程](@entry_id:260664)的语言，其在险过程 $Y_i(t)$ 仅在区间 $[L_i, \tilde{T}_i]$ 内取值为1 [@problem_id:4562399]。

### 从数据估计生存与风险

有了处理不完整数据的理论框架，我们现在可以讨论如何从实际数据中估计生存函数和风险函数。

#### [Kaplan-Meier](@entry_id:169317) 估计量：生存的乘积极限

最著名的生存函数非参数估计方法是 **[Kaplan-Meier](@entry_id:169317) (KM) 估计量**，也称**乘积极限 (product-limit) 估计量**。其推导的直觉非常优美，它基于条件[概率的[链式法](@entry_id:268139)则](@entry_id:190743) [@problem_id:4956179]。在任一时间 $t$ 的生存概率可以看作是一系列条件生存概率的乘积：即活过第一个事件时间点、再活过第二个事件时间点（在前者的基础上），以此类推，直到时间 $t$。

在每个离散的事件发生时间点 $t_i$，我们可以估计在该点存活的[条件概率](@entry_id:151013)。设在 $t_i$ 之前恰好有 $n_i$ 人处于风险中（即存活且未被删失），而在 $t_i$ 时刻有 $d_i$ 人发生事件。那么，在 $t_i$ 时刻发生事件的条件概率可估计为 $\frac{d_i}{n_i}$，因此在该点存活的条件概率可估计为 $1 - \frac{d_i}{n_i}$。将所有直到时间 $t$ 的这些条件生存概率相乘，就得到了 Kaplan-Meier 估计量：
$$ \hat{S}(t) = \prod_{t_i \le t} \left(1 - \frac{d_i}{n_i}\right) $$
KM 估计量是一条阶梯状的曲线，仅在有事件发生的时间点下降。它巧妙地利用了删失信息——被删失的个体在删失前对风险集 $n_i$ 做出贡献，之后则不再计入。

#### Nelson-Aalen 估计量：风险的累加

另一种估计方法是从[风险函数](@entry_id:166593)的角度出发。我们可以将累积风险 $H(t) = \int_0^t h(u) \, du$ 看作是许多微小风险“增量”的总和。在每个事件时间点 $t_i$，瞬时风险 $h(t_i)$ 贡献的风险增量可以近似地用前面提到的条件事件概率 $\frac{d_i}{n_i}$ 来估计 [@problem_id:4991508]。将所有直到时间 $t$ 的这些风险增量累加起来，就得到了[累积风险函数](@entry_id:169734)的 **Nelson-Aalen (NA) 估计量**：
$$ \hat{H}(t) = \sum_{t_i \le t} \frac{d_i}{n_i} $$
有了累积风险的估计，我们可以利用 $S(t) = \exp(-H(t))$ 这一关系，通过“即插即用”的方式得到生存函数的另一种估计，即 **Fleming-Harrington 估计量**：
$$ \hat{S}(t) = \exp(-\hat{H}(t)) = \exp\left(-\sum_{t_i \le t} \frac{d_i}{n_i}\right) $$
在样本量大时，KM 估计量和 Fleming-Harrington 估计量非常接近。

### 风险建模：[比例风险模型](@entry_id:171806)

非[参数估计](@entry_id:139349)方法对于描述单个群体的生存模式非常有用，但它们通常无法直接评估协变量（如治疗方法、年龄、基因型）对生存时间的影响。为此，我们需要[回归模型](@entry_id:163386)，其中最重要和最广泛应用的是**[比例风险](@entry_id:166780) (Proportional Hazards, PH) 模型**，也常被称为 **Cox 模型**。

PH 模型的核心思想是，一个体的[风险函数](@entry_id:166593)可以分解为一个与时间有关的**基准风险函数 (baseline hazard function)** $h_0(t)$ 和一个与时间无关但与协变量 $x$ 有关的因子 [@problem_id:4991485]。其数学形式为：
$$ h(t \mid x) = h_0(t) \exp(\beta^\top x) $$
这里，$h_0(t)$ 是当所有协变量 $x$ 均为零时（或取参考值时）的风险函数，它可以是任意随时间变化的非负函数。$\exp(\beta^\top x)$ 是一个相对风险因子，$\beta$ 是需要从数据中估计的[回归系数](@entry_id:634860)。

这个模型的“比例”二字体现在，对于任意两个具有不同协变量 $x_1$ 和 $x_2$ 的个体，他们的风险比 (hazard ratio) 为：
$$ \frac{h(t \mid x_1)}{h(t \mid x_2)} = \frac{h_0(t) \exp(\beta^\top x_1)}{h_0(t) \exp(\beta^\top x_2)} = \exp(\beta^\top(x_1 - x_2)) $$
由于基准风险 $h_0(t)$ 在比值中被消去，这个风险比是一个不依赖于时间 $t$ 的常数。这就是**[比例风险假设](@entry_id:163597)**的精髓。它意味着，如果一个治疗组的事件风险在研究初期是安慰剂组的一半，那么在整个研究期间，这一半的相对风险将保持不变，即使两组的绝对风险 $h(t \mid x)$ 都在随时间变化。

这个假设对其他函数形式有重要启示。例如，累积风险的比值也是一个常数，但生存函数的比值和概率密度函数的比值通常**不是**一个常数，它们的值会随时间而变化 [@problem_id:4991485]。理解这一点对于正确解释 Cox 模型的结果至关重要。

本章介绍了生存分析的基石——生存函数与风险函数。我们从它们的定义出发，阐明了它们之间的数学关系，讨论了如何在存在删失和截断的真实数据中对其进行估计，并最终引入了将它们用于[回归建模](@entry_id:170726)的[比例风险](@entry_id:166780)框架。这些原理和机制共同构成了理解和应用时间-事件分析的基础。