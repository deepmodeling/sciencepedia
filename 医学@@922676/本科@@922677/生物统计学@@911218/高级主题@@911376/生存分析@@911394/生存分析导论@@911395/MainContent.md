## 引言
从新药的疗效评估到手机的软件支持寿命，从客户的流失预测到金融资产的违约风险，许多看似无关的问题背后都隐藏着一个共同的关注点：一个事件发生需要多长时间？生存分析（Survival Analysis）正是为解答此类“事件发生时间”（time-to-event）问题而生的一整套强大统计方法。然而，与传统的回归或分类问题不同，这类数据通常是不完整的——我们往往不知道所有研究对象的最终结局，这种现象称为“删失”（censoring）。直接应用标准统计方法会得出有偏甚至错误的结论，因此，理解和掌握生存分析的独特框架至关重要。

本文将系统性地引导您入门生存分析。在第一部分**“原理与机制”**中，我们将奠定理论基石，深入探讨[删失数据](@entry_id:173222)的本质，定义核心的生存函数与[风险函数](@entry_id:166593)，并学习如何使用[Kaplan-Meier](@entry_id:169317)方法和Cox比例风险模型进行估计与推断。接下来，在第二部分**“应用与跨学科联系”**中，我们将跨出生物统计学的传统边界，通过来自医学、工程、商业和金融等领域的生动实例，展示生存分析的惊人普适性与解决实际问题的能力。最后，在第三部分**“动手实践”**中，您将通过具体的练习题，将理论知识转化为解决问题的实践技能。

现在，让我们从构建生存分析的基石开始，一同探索其精妙的原理与机制。

## 原理与机制

在介绍章节中，我们已经了解生存分析是关注“事件发生时间”的一系列统计方法的总称。本章将深入探讨支撑这些方法的核心原理与机制。我们将首先定义生存分析数据的独特结构，特别是删失（censoring）现象。接着，我们将介绍描述事件发生时间分布的几个基本数学量——生存函数与[风险函数](@entry_id:166593)。随后，我们将讨论在存在删失数据的情况下如何估计这些函数，并阐明其背后的关键假设。最后，我们将学习如何使用模型来评估协变量对生存时间的影响，并简要介绍竞争风险这一重要概念。

### 事件时间数据的性质

生存分析的核心是**事件时间数据（time-to-event data）**。这[类数](@entry_id:156164)据记录了从一个明确定义的起始时间点（如研究入组、诊断、设备启动）到一个终点事件（如死亡、疾病复发、设备故障）所经过的时间长度。我们将这个时间长度，即生存时间，表示为一个非负的随机变量 $T$。

然而，在许多实际研究中，我们往往无法观测到所有研究对象的完整生存时间。例如，一项临床试验可能计划进行五年，但到研究结束时，一些患者仍然存活且未发生目标事件；另一些患者可能因为搬家或个人原因而中途退出研究，此后他们的状况便不得而知。这种对真实事件时间 $T$ 的观测不完全的现象，被称为**删失（censoring）**。删失是生存数据最显著的特征，也是生存分析方法之所以必要的原因。删失主要有以下几种类型 [@problem_id:4920657]：

*   **[右删失](@entry_id:164686)（Right-censoring）**：这是最常见的删失类型。当我们在某个时间点 $C$ 停止对一个对象的观测，而此时事件尚未发生时，我们只知道其真实的生存时间 $T$ 大于 $C$ (即 $T > C$)。这可能是因为研究预定结束，或者对象失访。

*   **[左删失](@entry_id:169731)（Left-censoring）**：当我们在首次观测一个对象时，发现事件已经发生，但我们不知道确切的发生时间。例如，在研究某种慢性病的发生时，我们可能在第一次体检时发现某人已经患病，但其确切的发病时间早于此次体检。此时，我们只知道其生存时间（此处的“生存”指无病状态）$T$ 小于或等于首次观测时间 $L$ (即 $T \le L$)。

*   **[区间删失](@entry_id:636589)（Interval-censoring）**：当事件的发生时间无法被精确观测，但我们知道它发生于两个观测时间点 $L$ 和 $R$ 之间时，就产生了[区间删失](@entry_id:636589)。例如，通过定期进行病毒检测来研究感染的发生时间。如果某次检测结果为阴性（在时间 $L$），而下一次检测结果为阳性（在时间 $R$），我们便知道感染事件发生在了 $(L, R]$ 这个时间区间内，即 $L  T \le R$。

在本章后续内容中，如无特殊说明，我们将主要关注最普遍的[右删失](@entry_id:164686)情况。为了在数学上严谨地处理右[删失数据](@entry_id:173222)，我们引入两个潜在的随机变量：代表真实事件时间的 $T_i$ 和代表潜在删失时间的 $C_i$，两者均为非负。对于研究中的第 $i$ 个对象，我们实际观测到的数据由一个数据对 $(X_i, \delta_i)$ 构成 [@problem_id:4920605]：

1.  **观测时间 $X_i$**：我们能观测到的时间是真实事件时间和删失时间中较早发生的那一个。这是因为一旦任何一个“终点”（我们感兴趣的事件或我们失去观测的机会）发生，观测就终止了。因此，观测时间为 $X_i = \min(T_i, C_i)$。

2.  **事件指示符 $\delta_i$**：我们需要一个指示符来区分观测到的时间 $X_i$ 究竟是真实事件时间还是删失时间。如果事件被观测到，我们将其记为 $\delta_i = 1$；如果观测被删失，则记为 $\delta_i = 0$。一个关键的约定是，当事件和删失恰好同时发生时（即 $T_i = C_i$），我们认为事件是被观测到了。例如，如果一项研究在12月31日结束，而一位患者恰好在12月31日死亡，那么他的死亡事件是确切观测到的，不应被视为删失。因此，事件指示符的精确定义是 $\delta_i = \mathbf{1}\{T_i \le C_i\}$，其中 $\mathbf{1}\{\cdot\}$ 是[指示函数](@entry_id:186820)。

这个 $(X_i, \delta_i)$ 数据对构成了生存分析中进行统计推断的基础。我们的目标是利用这些可能不完整的观测数据，来推断全体人群中真实生存时间 $T$ 的分布特征。

### 生存分析中的基本量

为了描述事件时间变量 $T$ 的概率分布，生存分析使用了一套独特的函数，它们从不同角度刻画了生存过程。

#### 生存函数

最核心的概念是**生存函数（Survival Function）**，记为 $S(t)$。它被定义为随机变量 $T$ 大于某个特定时间点 $t$ 的概率：
$$ S(t) = P(T > t) $$
$S(t)$ 的直观含义是：一个个体存活超过时间 $t$ 的概率。例如，如果 $S(5 \text{ years}) = 0.8$，这意味着一个随机抽取的个体有 $0.8$ 的概率在研究开始后存活超过5年。

生存函数具有一些普适的数学性质 [@problem_id:4920654]：

*   **非增性**：随着时间 $t$ 的增加，存活的概率不会增加。因此，$S(t)$ 是一个非增函数，即对于任意 $t_1  t_2$，有 $S(t_1) \ge S(t_2)$。
*   **边界值**：在时间起点 $t=0$ 之前，生存概率为1，即 $\lim_{t \to 0^-} S(t) = 1$。如果事件不可能在 $t=0$ 时刻立即发生（即 $P(T=0)=0$），那么 $S(0)=1$。在无穷远处，生存概率趋于0（假设事件最终总会发生），即 $\lim_{t \to \infty} S(t) = 0$。
*   **与[累积分布函数](@entry_id:143135)（CDF）的关系**：生存函数与 $T$ 的[累积分布函数](@entry_id:143135) $F(t) = P(T \le t)$ 互补。对于任意时间 $t$，事件要么在 $t$ 或之前发生，要么在 $t$ 之后发生，所以 $F(t) + S(t) = 1$。
*   **连续性**：由概率论的基本性质可知，$S(t)$ 是**右连续**的。这意味着在任何时间点 $t$，当从右侧逼近 $t$ 时，[函数的极限](@entry_id:158708)值等于函数在该点的值。然而，$S(t)$ 不一定是左连续的。如果在一个离散的时间点 $t_0$ 发生事件的概率大于零（即 $P(T=t_0) > 0$），那么生存函数将在 $t_0$ 处出现一个大小为 $P(T=t_0)$ 的向下跳跃。

#### [风险函数](@entry_id:166593)

虽然生存函数描述了“到目前为止”的累积生存状况，但在许多应用中，我们更关心在某个特定时刻的瞬时风险。这个概念由**风险函数（Hazard Function）**或称**风险率（Hazard Rate）**来量化，记为 $h(t)$ 或 $\lambda(t)$。

[风险函数](@entry_id:166593) $h(t)$ 定义为在时间 $t$ 存活的条件下，在下一个极小时间间隔 $[t, t+\Delta t)$ 内发生事件的[瞬时速率](@entry_id:182981) [@problem_id:4920653]：
$$ h(t) = \lim_{\Delta t \to 0^+} \frac{P(t \le T  t + \Delta t \mid T \ge t)}{\Delta t} $$
这个定义的直观解释是，对于一个已经在时间 $t$ 之前“幸免于难”的个体， $h(t)\Delta t$ 是他在接下来一个短暂的 $\Delta t$ 时间内发生事件的近似概率。因此，$h(t)$ 度量了在时间点 $t$ 的瞬时“危险程度”或“事件倾向”。

[风险函数](@entry_id:166593)与生存函数以及[概率密度函数](@entry_id:140610)（PDF, $f(t) = F'(t)$）之间有着密切的联系。通过条件概率的定义，我们可以推导出：
$$ h(t) = \frac{f(t)}{S(t)} $$
这个关系式非常重要，它连接了三个核心函数。同时，它也引出了风险函数与生存函数的另一个关键关系：
$$ h(t) = -\frac{d}{dt} \ln S(t) \quad \text{以及} \quad S(t) = \exp\left(-\int_0^t h(u) du\right) $$
后者表明，如果我们知道了从0到 $t$ 的整个[风险函数](@entry_id:166593)历史，我们就可以完全确定在时间 $t$ 的生存概率。积分 $\int_0^t h(u) du$ 被称为[累积风险函数](@entry_id:169734)（Cumulative Hazard Function），记为 $H(t)$。

与生存函数总是单调非增不同，[风险函数](@entry_id:166593)的形状可以多种多样，这为我们提供了关于[失效机制](@entry_id:184047)的深刻洞见。例如，对于一个可靠的电子元件，其[风险函数](@entry_id:166593)可能在早期较高（早期失效），然后进入一个稳定期（随机失效），最后在寿命末期因老化而再次升高。

让我们通过一个具体的例子来理解这些关系。假设一个航天器组件的生存时间服从韦伯（Weibull）分布，其生存函数为 [@problem_id:1925083]：
$$ S(t) = \exp\left(-\left(\frac{t}{\alpha}\right)^\beta\right) $$
其中 $\alpha > 0$ 是[尺度参数](@entry_id:268705)，$\beta > 0$ 是[形状参数](@entry_id:270600)。我们可以利用 $h(t) = f(t)/S(t)$ 来推导其风险函数。首先，我们知道 $f(t) = -S'(t)$。利用[链式法则](@entry_id:190743)求导：
$$ S'(t) = \exp\left(-\left(\frac{t}{\alpha}\right)^\beta\right) \cdot \left[-\frac{d}{dt}\left(\frac{t}{\alpha}\right)^\beta\right] = S(t) \cdot \left[-\frac{\beta}{\alpha}\left(\frac{t}{\alpha}\right)^{\beta-1}\right] $$
因此，$f(t) = -S'(t) = S(t) \cdot \frac{\beta}{\alpha}\left(\frac{t}{\alpha}\right)^{\beta-1}$。代入风险函数公式：
$$ h(t) = \frac{f(t)}{S(t)} = \frac{\beta}{\alpha}\left(\frac{t}{\alpha}\right)^{\beta-1} $$
这个结果揭示了韦伯分布的灵活性。[形状参数](@entry_id:270600) $\beta$ 决定了风险的模式：
*   如果 $\beta  1$，风险随时间递减（例如，缺陷产品在早期被淘汰）。
*   如果 $\beta = 1$，风险恒定（$h(t) = 1/\alpha$），这对应于指数分布，描述无记忆性的随机事件。
*   如果 $\beta > 1$，风险随时间递增（例如，[老化](@entry_id:198459)或磨损过程）。

### 删失数据的估计

理论上的函数定义是清晰的，但实践中的挑战在于如何利用包含右删失的 $(X_i, \delta_i)$ 数据来估计它们。

#### [Kaplan-Meier](@entry_id:169317) 估计

估计生存函数 $S(t)$ 的标准非参数方法是**[Kaplan-Meier](@entry_id:169317) (KM) 估计**，也称为乘积极限估计（product-limit estimator）。其核心思想非常直观：在时间轴上，生存函数只在发生事件的时刻才会发生变化（下降）。因此，我们可以将生存到任意时间 $t$ 的概率看作是一系列“成功”通过所有在 $t$ 之前的事件时刻的条件概率的乘积 [@problem_id:4920591]。

假设研究中观察到的不同事件时间按顺序为 $t_{(1)}  t_{(2)}  \dots  t_{(D)}$。在每个事件时刻 $t_{(i)}$，我们可以估计在该时刻存活的[条件概率](@entry_id:151013)。设 $n_i$ 为在时间 $t_{(i)}$ 之前“处于风险中”的个体数量（即尚未发生事件也未被删失的个体），并设 $d_i$ 为在时间 $t_{(i)}$ 恰好发生事件的个体数量。那么，在 $t_{(i)}$ 发生事件的条件概率的经验估计为 $\frac{d_i}{n_i}$，因此在该时刻存活下来的[条件概率](@entry_id:151013)估计为 $1 - \frac{d_i}{n_i}$。

[Kaplan-Meier](@entry_id:169317) 估计量 $\hat{S}(t)$ 就是将这些条件生存概率连乘起来：
$$ \hat{S}(t) = \prod_{i: t_{(i)} \le t} \left(1 - \frac{d_i}{n_i}\right) $$
这里的连乘积包含了所有小于等于 $t$ 的事件时刻。在两个相邻的事件时刻之间，生存函数估计值保持不变，形成一个阶梯状的曲线。被删失的观测虽然不直接导致生存曲线下降，但它们会在后续的计算中减少“处于风险中”的人数 $n_i$。

让我们通过一个例子来演示计算过程 [@problem_id:4920591]。一个包含12名受试者的研究，观测时间和结果如下（E=事件，C=删失）：1.5(E), 2.0(C), 2.2(E), 3.0(E), 4.5(C), 5.0(E), 6.0(E), 7.5(C), 8.0(E), 9.0(C), 10.0(E), 12.0(C)。我们要计算 $t=10$ 个月时的生存概率 $\hat{S}(10)$。

1.  **$t=1.5$ (事件)**: 初始风险人数 $n_1=12$。事件数 $d_1=1$。$\hat{S}(1.5) = 1 - \frac{1}{12} = \frac{11}{12}$。
2.  **$t=2.0$ (删失)**: 1人退出，不改变 $\hat{S}(t)$。
3.  **$t=2.2$ (事件)**: 风险人数 $n_2=12-1-1=10$。事件数 $d_2=1$。$\hat{S}(2.2) = \hat{S}(1.5) \times (1 - \frac{1}{10}) = \frac{11}{12} \times \frac{9}{10}$。
4.  **$t=3.0$ (事件)**: 风险人数 $n_3=10-1=9$。事件数 $d_3=1$。$\hat{S}(3.0) = \hat{S}(2.2) \times (1 - \frac{1}{9}) = \frac{11}{12} \times \frac{9}{10} \times \frac{8}{9}$。
5.  **$t=4.5$ (删失)**: 1人退出。
6.  **$t=5.0$ (事件)**: 风险人数 $n_4=9-1-1=7$。事件数 $d_4=1$。$\hat{S}(5.0) = \hat{S}(3.0) \times (1 - \frac{1}{7}) = \dots$
7.  ... 以此类推，直到最后一个事件时刻 $t=10.0$。

在 $t=10.0$ 时，我们追踪到风险人数为 $n_7=2$，事件数为 $d_7=1$。因此，在 $t=10$ 时的最终生存概率估计值为：
$$ \hat{S}(10) = \left(\frac{11}{12}\right) \left(\frac{9}{10}\right) \left(\frac{8}{9}\right) \left(\frac{6}{7}\right) \left(\frac{5}{6}\right) \left(\frac{3}{4}\right) \left(\frac{1}{2}\right) = \frac{11}{56} \approx 0.1964 $$
这意味着，根据这些数据，一个受试者存活超过10个月的估计概率约为 $19.64\%$。

#### 独立删失假设

[Kaplan-Meier](@entry_id:169317) 估计乃至整个生存分析领域的大部分方法，都依赖于一个至关重要的假设：**独立删失（Independent Censoring）** [@problem_id:4920602]。在不考虑其他变量的情况下，该假设意味着个体的真实生存时间 $T$ 与其潜在的删失时间 $C$ 是相互独立的。在包含协变量 $X$ 的更一般情景下，该假设表述为在给定协变量 $X$ 的条件下，$T$ 和 $C$ 是条件独立的，记为 $T \perp C \mid X$。

这个假设的直观含义是，删失机制不能提供关于个体生存前景的额外信息。换句话说，在任何时间点 $t$，从研究中因删失而“消失”的个体，其未来的事件风险与那些在同一时间点仍然留在研究中的个体是相同的（在控制了协变量 $X$ 后）。如果删失与预后有关，例如病情最严重的患者更有可能退出试验（这被称为**信息性删失，informative censoring**），那么独立删失假设就被违反了。此时，留在研究中的个体是一个经过筛选的、“更健康”的群体，使用标准方法（如KM估计）将会高估真实的生存概率。

独立删失假设是保证我们能够从观测数据中“识别”出真实生存分布的关键。它确保了在任何时刻 $t$，我们从处于风险集中的个体所观察到的事件发生率，能够无偏地反映我们感兴趣的真实风险率 $\lambda_T(t \mid X)$。此外，为了能够在时间 $t$ [估计风险](@entry_id:139340)，我们还需要一个实际的条件：在该时间点必须有足够的人处于风险中。这被称为**正性假设（positivity condition）**，即对于所有我们感兴趣的时间 $t$，$\mathbb{P}(C \ge t \mid X) > 0$，意味着在任何时刻都有不为零的概率可以观测到个体 [@problem_id:4920602]。

### 协变量效应建模

生存分析的一大目标是研究各种因素（协变量）如何影响生存时间。例如，新疗法是否比标准疗法更有效？年龄或性别是否是某疾病的风险因素？

#### [比例风险模型](@entry_id:171806)

回答这类问题的最常用工具是 David Cox 在1972年提出的**[比例风险模型](@entry_id:171806)（Proportional Hazards Model）**，通常称为**Cox模型**。这是一个半参数[回归模型](@entry_id:163386)，它直接对[风险函数](@entry_id:166593)进行建模，而不是对生存时间本身。其基本形式为 [@problem_id:4920590]：
$$ \lambda(t \mid \mathbf{x}) = \lambda_0(t) \exp(\boldsymbol{\beta}^\top \mathbf{x}) $$
其中：
*   $\mathbf{x} = (x_1, x_2, \dots, x_p)$是协变量向量。
*   $\lambda(t \mid \mathbf{x})$ 是具有协变量 $\mathbf{x}$ 的个体的[风险函数](@entry_id:166593)。
*   $\lambda_0(t)$ 是**基线[风险函数](@entry_id:166593)（baseline hazard function）**。它是一个任意的、非负的时间函数，对应于所有协变量均为0（$\mathbf{x}=\mathbf{0}$）的个体的风险函数。[Cox模型](@entry_id:164053)的“半参数”特性正来源于此：我们不对 $\lambda_0(t)$ 的具体形式做任何假定。
*   $\boldsymbol{\beta} = (\beta_1, \beta_2, \dots, \beta_p)$ 是[回归系数](@entry_id:634860)向量，用于量化协变量对风险的影响。$\exp(\boldsymbol{\beta}^\top \mathbf{x})$ 确保了风险总是正的。

[Cox模型](@entry_id:164053)的核心假设是**[比例风险](@entry_id:166780)**。考虑两个协变量分别为 $\mathbf{x}_1$ 和 $\mathbf{x}_2$ 的个体，他们的风险率之比为：
$$ \frac{\lambda(t \mid \mathbf{x}_1)}{\lambda(t \mid \mathbf{x}_2)} = \frac{\lambda_0(t) \exp(\boldsymbol{\beta}^\top \mathbf{x}_1)}{\lambda_0(t) \exp(\boldsymbol{\beta}^\top \mathbf{x}_2)} = \exp(\boldsymbol{\beta}^\top (\mathbf{x}_1 - \mathbf{x}_2)) $$
这个比值不随时间 $t$ 变化，即它是一个常数。这就是“比例风险”的含义：一个体的风险在任何时候都是另一个体的固定倍数。

模型系数的解释也十分直接。对于单个协变量 $x_j$，$\exp(\beta_j)$ 是其对应的**风险比（Hazard Ratio, HR）**。它表示在保持其他协变量不变的情况下，$x_j$ 每增加一个单位，事件的瞬时风险会乘以的倍数。
*   如果 $\beta_j > 0$，则 $\exp(\beta_j) > 1$，说明 $x_j$ 是一个风险因素。
*   如果 $\beta_j  0$，则 $\exp(\beta_j)  1$，说明 $x_j$ 是一个保护因素。
*   如果 $\beta_j = 0$，则 $\exp(\beta_j) = 1$，说明 $x_j$ 与风险无关。

例如，一项研究比较新疗法（$x=1$）和安慰剂（$x=0$），拟合[Cox模型](@entry_id:164053)后得到 $\beta = -0.693$。那么风险比 $HR = \exp(-0.693) = 0.5$。这意味着在研究期间的任何时刻，接受新疗法的患者发生事件的风险都是安慰剂组患者的一半。

我们可以利用[比例风险假设](@entry_id:163597)来推断不同组别的生存状况。假设我们知道一个基准组（如冷藏草莓）的生存函数 $S_{ref}(t)$，并且知道另一个组（如室温草莓）相对于基准组的风险比为 $\lambda$。根据[比例风险假设](@entry_id:163597) $h_{room}(t) = \lambda \cdot h_{ref}(t)$，我们可以推导出两者的生存函数关系 [@problem_id:1925081]：
$$ S_{room}(t) = [S_{ref}(t)]^\lambda $$
这个简单的关系使得我们能够仅通过一个风险比就将一个群体的生存曲线映射到另一个群体。

### 竞争风险简介

在许多情况下，研究对象可能面临多种类型的终点事件，而任何一种事件的发生都会阻止其他事件的发生。这种情况被称为**竞争风险（Competing Risks）**。例如，在对老年人进行的心血管疾病研究中，一位患者可能死于心脏病（目标事件），也可能死于癌症或意外事故（竞争事件）。

在竞争风险框架下，我们为每一种可能的原因 $k$ 定义一个**原因特异性风险函数（cause-specific hazard function）** $h_k(t)$。它表示在时间 $t$ 存活的条件下，在下一个瞬间因原因 $k$ 发生事件的瞬时速率。

所有原因的总风险，即发生任何一种事件的整体[风险函数](@entry_id:166593) $h(t)$，是所有原因特异性风险之和：
$$ h(t) = \sum_k h_k(t) $$
一个非常有用且直观的结果是，如果我们在时间 $t$ 观察到一个事件发生，那么这个事件是由原因 $k$ 造成的条件概率，恰好是原因 $k$ 的风险在总风险中所占的比例 [@problem_id:1925099]：
$$ P(\text{事件原因为 } k \mid \text{在时间 } t \text{ 发生事件}) = \frac{h_k(t)}{h(t)} = \frac{h_k(t)}{\sum_j h_j(t)} $$
例如，假设在一个池塘里，蝌蚪在时间 $t$ 发生“变态为青蛙”的特异性风险是 $h_M(t) = 0.005t$，而被捕食的特异性风险是恒定的 $h_P(t) = 0.04$。如果在第10天观察到一只蝌蚪消失了（发生了终点事件），那么这个事件是“成功变态”的概率就是：
$$ P(\text{变态} \mid T=10) = \frac{h_M(10)}{h_M(10) + h_P(10)} = \frac{0.005 \times 10}{0.005 \times 10 + 0.04} = \frac{0.05}{0.09} \approx 0.556 $$
在处理[竞争风险](@entry_id:173277)数据时，一个常见的错误是将竞争事件简单地当作删失来处理，然后使用标准的[Kaplan-Meier](@entry_id:169317)方法来估计目标事件的发生概率。这种做法是错误的，因为它估计的是在一个假设的、没有[竞争风险](@entry_id:173277)存在的世界里事件的发生概率（称为净概率），而不是在现实世界中，存在多种风险并存时事件的实际发生概率（称为粗概率或累积发生率）。因此，分析[竞争风险](@entry_id:173277)数据需要专门的方法。