## 引言
在生物统计学、医学研究、工程学乃至社会科学等多个领域，我们常常关心“从某个起点到某个特定事件发生所经过的时间”，即时间至事件数据（time-to-event data）。例如，患者从接受治疗到疾病复发的时间，或者一个机械部件从投入使用到发生故障的时间。然而，在真实世界的研究中，我们往往无法观察到所有研究对象的完整事件时间，部分数据会因为研究结束、个体失访等原因而“删失”，这给传统的统计分析带来了巨大挑战。

为了解决这一难题，统计学家 Edward L. Kaplan 和 Paul Meier 于1958年提出了一种强大而优雅的非参数方法——Kaplan-Meier 估计。它能够在存在删失数据的情况下，准确地估计和可视化生存概率随时间变化的趋势，已成为生存分析领域的基石。本文将系统地引导您掌握 Kaplan-Meier 估计的核心知识。

文章分为三个核心部分。在“原理与机制”一章中，我们将深入探讨生存分析的基本概念、[Kaplan-Meier](@entry_id:169317) 估计量的数学构造、其背后的关键假设以及相关的理论扩展。接下来，“应用与跨学科联系”一章将展示该方法在临床研究、[观察性研究](@entry_id:174507)乃至工程可靠性等领域的广泛实际应用，并讨论如何与其他[统计模型](@entry_id:755400)结合使用。最后，通过“动手实践”部分，您将有机会通过具体计算来巩固所学知识。学完本文，您将能够自信地运用和解读 [Kaplan-Meier](@entry_id:169317) 生存曲线，为您的数据分析工作增添一个有力的工具。

## 原理与机制

在上一章引言的基础上，本章将深入探讨 Kaplan-Meier 生存曲线估计的理论基础和核心机制。我们将从生存分析的基本概念出发，逐步构建 [Kaplan-Meier](@entry_id:169317) 估计量的推导过程，阐明其关键假设，并讨论其在复杂数据情景（如[竞争风险](@entry_id:173277)）中的应用与局限性。

### 生存分析的核心概念

生存分析的核心是处理包含**删失 (censoring)** 的时间至事件数据。在典型的临床研究或[可靠性工程](@entry_id:271311)中，我们关心的是从某个起点（如诊断、治疗开始或设备投入使用）到某个特定**事件 (event)** 发生所经过的时间。这个时间我们称之为**事件时间 (event time)**，通常用随机变量 $T$ 表示。然而，由于多种原因（如研究结束、患者失访、发生其他非研究终点的事件），我们可能无法观测到所有研究对象的完整事件时间。当我们在某个时间点之后就无法再获得关于个体的信息，但事件尚未发生时，就产生了**[右删失](@entry_id:164686) (right-censoring)**。

为了在数学上严谨地处理这种情况，我们为每个个体 $i$ 定义以下变量：
- $T_i$：真实的、潜在的事件时间。
- $C_i$：删失时间，即在该时间点之后我们停止了对个体 $i$ 的观察。
- $X_i = \min(T_i, C_i)$：实际观测到的时间，即事件时间和删失时间中较早发生的那一个。
- $\Delta_i = \mathbf{1}(T_i \le C_i)$：事件指示符。如果 $\Delta_i=1$，表示在观测时间内事件发生了（即 $X_i = T_i$）；如果 $\Delta_i=0$，表示观测在事件发生前就终止了，即发生了[右删失](@entry_id:164686)（$X_i = C_i$），我们只知道真实的事件时间 $T_i$ 大于我们观测到的时间 $X_i$ [@problem_id:4921673]。

我们的目标是基于这些可能不完整的观测数据 $(X_i, \Delta_i)$ 来估计事件时间 $T$ 的分布特征。在生存分析中，我们通常不直接估计[概率密度函数](@entry_id:140610) (PDF)，而是关注以下三个密切相关的函数 [@problem_id:4921600]：

1.  **生存函数 (Survival Function)**, $S(t)$：也称为生存概率，定义为事件时间 $T$ 大于某个特定时间点 $t$ 的概率，即 $S(t) = \mathbb{P}(T > t)$。它描述了研究对象存活超过时间 $t$ 的可能性。$S(t)$ 是一个非增函数，其起始值为 $S(0)=1$，并随着 $t$ 趋于无穷而趋于 $0$（或一个稳定比例，如果存在永远不会经历事件的亚群）。

2.  **累积分布函数 (Cumulative Distribution Function)**, $F(t)$：定义为事件在时间 $t$ 或之前发生的概率，即 $F(t) = \mathbb{P}(T \le t)$。它与生存函数的关系非常直接：$S(t) = 1 - F(t)$。

3.  **风险函数 (Hazard Function)**, $h(t)$：也称为[风险率](@entry_id:266388)或瞬时事件率。它表示在时间 $t$ 仍然“存活”（即事件尚未发生）的条件下，在下一个极小时间间隔内发生事件的瞬时速率。其严格定义为：
    $$h(t) = \lim_{\Delta t \to 0} \frac{\mathbb{P}(t \le T  t + \Delta t \mid T \ge t)}{\Delta t}$$
    当 $T$ 为[连续随机变量](@entry_id:166541)且其概率密度函数为 $f(t)$ 时，[风险函数](@entry_id:166593)可以表示为 $h(t) = f(t) / S(t)$。[风险函数](@entry_id:166593)与生存函数之间存在一个重要的积分关系：
    $$S(t) = \exp\left(-\int_0^t h(u) \,du\right)$$
    这个关系表明，如果我们能够估计出在各个时间点上的风险，我们就可以通过累积这些风险并进行指数变换来重构整个生存曲线。这正是 Kaplan-Meier 估计方法背后的核心思想。值得注意的是，[风险率](@entry_id:266388) $h(t)$ 是一个瞬时速率，其取值范围是 $[0, \infty)$，而不像概率那样必须在 $[0, 1]$ 之内 [@problem_id:4921600]。

### 乘积极限原理：Kaplan-Meier 估计量的构建

直接从[删失数据](@entry_id:173222)中估计 $S(t)$ 是困难的。例如，一个简单的估计方法是计算在时间 $t$ 之后仍然存活的个体比例，但这会因为删失而产生偏倚。[Kaplan-Meier](@entry_id:169317) 方法通过一种巧妙的“乘积极限”思想解决了这个问题。

其基本逻辑是，将生存到时间 $t$ 的概率分解为一系列连续时间段的条件生存概率的乘积 [@problem_id:4921635]。假设研究中观测到的所有**不同**的事件发生时间点按升序排列为 $t_1  t_2  \dots  t_k$。那么，生存超过时间 $t$（其中 $t_j \le t  t_{j+1}$）意味着个体必须：
- 生存超过 $t_1$
- 在生存超过 $t_1$ 的条件下，再生存超过 $t_2$
- ...
- 在生存超过 $t_{j-1}$ 的条件下，再生存超过 $t_j$

使用[条件概率](@entry_id:151013)的[乘法法则](@entry_id:144424)，我们可以将 $S(t)$ 表示为：
$$S(t) = \mathbb{P}(T  t_1) \times \mathbb{P}(T  t_2 \mid T  t_1) \times \dots \times \mathbb{P}(T  t_j \mid T  t_{j-1})$$
由于在两个连续的事件时间点之间没有事件发生，我们可以将条件生存概率 $\mathbb{P}(T  t_j \mid T  t_{j-1})$ 写为 $\mathbb{P}(T  t_j \mid T \ge t_j)$，即在 $t_j$ 时刻尚未发生事件的条件下，能够成功“渡过”该时刻的概率。这个[条件概率](@entry_id:151013)可以进一步表示为 $1 - \mathbb{P}(T = t_j \mid T \ge t_j)$。

至此，问题转化为如何从数据中估计在每个事件时间点 $t_j$ 的条件生存概率。这正是**风险集 (risk set)** 概念发挥作用的地方。

#### 风险集与经验概率估计

在任意时间点 $t_j$，**风险集** $R(t_j)$ 被定义为在 $t_j$ **之前瞬间**（just prior to $t_j$）所有仍然处于观察中且尚未经历事件的个体集合。换句话说，它包含了所有在 $t_j$ 时刻“有风险”经历事件的个体。数学上，风险集的大小 $n_j$ 是满足 $X_i \ge t_j$ 的个体数量 [@problem_id:4921568]。

这个定义“just prior to $t_j$”非常关键。它意味着，在时刻 $t_j$ 发生事件或被删失的个体，在该时刻的计算中**仍然被包含在风险集内** [@problem_id:4806009]。他们对估计该时刻的风险做出了贡献，并在此之后才被移出风险集。

有了风险集，我们就可以很自然地估计条件事件概率。令 $d_j$ 为在时间 $t_j$ 确切发生事件的个体数量。那么，在 $t_j$ 时刻发生事件的[条件概率](@entry_id:151013)的经验估计就是：
$$ \widehat{\mathbb{P}}(T = t_j \mid T \ge t_j) = \frac{d_j}{n_j} $$
相应地，在该时刻存活的条件概率的经验估计为：
$$ \widehat{\mathbb{P}}(T  t_j \mid T \ge t_j) = 1 - \frac{d_j}{n_j} $$

#### [Kaplan-Meier](@entry_id:169317) 估计公式

将这些经验条件概率代入之前的[乘积公式](@entry_id:137076)，我们就得到了 **Kaplan-Meier (KM) 估计量**，也称为**[乘积极限估计量](@entry_id:171437) (product-limit estimator)**：
$$ \hat{S}(t) = \prod_{j: t_j \le t} \left(1 - \frac{d_j}{n_j}\right) $$
其中，乘积遍历所有小于等于 $t$ 的事件时间点 $t_j$。

让我们通过一个具体的例子来演示计算过程。考虑以下 $n=8$ 个体的数据 [@problem_id:4921673]，其中时间单位为月，$\Delta=1$ 表示事件，$\Delta=0$ 表示删失：
- $(1.7, 1)$, $(2.1, 1)$, $(2.1, 1)$, $(3.4, 1)$, $(3.4, 0)$, $(4.0, 0)$, $(4.5, 0)$, $(5.0, 1)$

**计算步骤：**
1.  **识别并排序所有独特的事件时间**：$t_1=1.7$, $t_2=2.1$, $t_3=3.4$, $t_4=5.0$。
2.  **构建KM表**：

| 时间 $t_j$ | 风险数 $n_j$ | 事件数 $d_j$ | 删失数 $c_j$ | 条件生存率 $(1 - d_j/n_j)$ | 累积生存率 $\hat{S}(t_j)$ |
|:----------:|:------------:|:------------:|:------------:|:-----------------------------:|:-------------------------:|
| $t=0$      | $8$          | $0$          | $0$          | -                             | $1.0$                     |
| $t_1=1.7$  | $8$          | $1$          | $0$          | $1 - 1/8 = 7/8$               | $1.0 \times 7/8 = 0.875$  |
| $t_2=2.1$  | $7$          | $2$          | $0$          | $1 - 2/7 = 5/7$               | $7/8 \times 5/7 = 5/8 = 0.625$ |
| $t_3=3.4$  | $5$          | $1$          | $1$          | $1 - 1/5 = 4/5$               | $5/8 \times 4/5 = 4/8 = 0.5$ |
| $t_4=5.0$  | $1$          | $1$          | $0$          | $1 - 1/1 = 0$                 | $0.5 \times 0 = 0$        |

**关键点解释：**
-   在 $t=1.7$ 之前，所有 $8$ 人都在风险集中。在 $t=1.7$ 发生 $1$ 次事件后，风险集人数降为 $7$。
-   在 $t=2.1$ 时，风险集有 $7$ 人，发生了 $2$ 次事件。之后风险集人数变为 $5$。
-   在 $t=3.4$ 时，风险集有 $5$ 人。此时同时有 $1$ 次事件和 $1$ 次删失。根据标准惯例，**事件被认为发生在删失之前** [@problem_id:4921673]。因此，计算条件生存率时，分母是 $5$。事件发生后，风险集人数变为 $4$；然后删失的个体再被移出，风险集最终变为 $3$。但删失本身不改变 $\hat{S}(t)$ 的值。
-   在 $t=4.0$ 和 $t=4.5$ 发生删失，$\hat{S}(t)$ 保持在 $0.5$ 不变。风险集人数在此期间从 $3$ 逐步减少到 $1$。
-   在 $t=5.0$ 时，风险集仅剩 $1$ 人，并发生了 $1$ 次事件。$\hat{S}(5.0)$ 下降到 $0.5 \times (1-1/1) = 0$。

### KM 曲线的性质与解读

Kaplan-Meier 估计量 $\hat{S}(t)$ 在图形上表现为一条**右连续的阶梯函数**。
-   曲线仅在**事件发生的时间点** $t_j$ 发生**垂直下降**。下降的幅度取决于当时的风险集大小和事件数量。
-   在两个连续的事件时间点之间，曲线保持水平。
-   在**删失发生的时间点**，曲线同样保持水平，不会下降。这是因为删失不被视为事件，它只减少了未来时间点的风险集人数，从而影响后续的估计精度，但它不提供关于生存率下降的直接证据 [@problem_id:4921667]。

**视觉解读的注意事项：**
-   **平坦不等于安全**：KM 曲线上一段长长的平坦区域（没有下降）只表明在**样本中**该时间段内没有观测到事件。这并不意味着在**总体中**该时间段的真实风险为零。特别是在研究后期，当风险集人数很少时，这种平坦区间的偶然性很大 [@problem_id:4921667]。
-   **删失标记的重要性**：图上通常会用小刻度线（ticks）标记删失时间。这些标记提醒我们，曲线的稳定性可能部分是由于信息丢失（个体退出风险集）造成的。在删失频繁的区域，尤其是在曲线的尾部，风险集人数 ($n_j$) 可能变得非常小。这会导致估计的方差增大，[置信区间](@entry_id:138194)变宽，使得[点估计](@entry_id:174544)的可靠性降低。因此，解读KM曲线时，必须结合风险集人数的变化来综合判断 [@problem_id:4921667]。

### 关键假设：独立非信息性删失

[Kaplan-Meier](@entry_id:169317) 估计量的有效性和一致性（即随着样本量增大，估计值收敛于真实值）依赖于一个至关重要的假设：**独立非信息性删失 (independent non-informative censoring)** [@problem_id:4805991]。

这个假设可以从两个层面来理解：
1.  **数学形式化**：在最简单的情况下，该假设意味着个体的真实事件时间 $T$ 与其删失时间 $C$ 是相互独立的，记为 $T \perp C$。在存在协变量 $X$ 的更复杂模型中，该假设放宽为在给定协变量的条件下，事件时间与删失时间是独立的，即 $T \perp C \mid X$ [@problem_id:4805991]。

2.  **直观解释**：该假设的核心是，删失的发生不能提供任何关于个体未来事件风险的信息。一个被删失的个体，其未来的事件风险应该与在同一时间点仍然留在风险集中的其他个体“没有系统性差异”。正因为如此，我们才能将被删失的个体简单地从风险集中移除，而不用担心这会使我们对剩余人群的[风险估计](@entry_id:754371)产生偏倚。换句话说，独立删失保证了在任何时刻 $t_j$，风险集 $R(t_j)$ 都可以被视为在真实总体中所有存活至 $t_j$ 的个体的**一个[代表性样本](@entry_id:201715)** [@problem_id:4921635]。

#### 违反假设的后果：信息性删失

当删失与事件风险相关时，就发生了**信息性删失 (informative censoring)**，此时 KM 估计量会产生严重的偏倚。

让我们考虑一个违反独立性假设的反例 [@problem_id:4921666]。假设在一个群体中，个体的真实事件时间 $T$ 只能取两个值：$1$ 或 $2$。$\mathbb{P}(T=1)=p$, $\mathbb{P}(T=2)=1-p$。删失机制是这样的：如果一个人的真实事件时间是 $T=1$（较差预后），他的删失时间为 $C=3$；如果他的真实事件时间是 $T=2$（较好预后），他的删失时间则为 $C=0.5$。

-   **真实生存率**：我们想估计 $S(1) = \mathbb{P}(T  1) = \mathbb{P}(T=2) = 1-p$。

-   **KM 估计会得到什么？**
    -   对于那些 $T=2$ 的个体（占总体的 $1-p$），他们的观测时间是 $X = \min(2, 0.5) = 0.5$，事件指示符为 $\Delta = \mathbf{1}(2 \le 0.5) = 0$。他们都在 $t=0.5$ 时被删失。
    -   对于那些 $T=1$ 的个体（占总体的 $p$），他们的观测时间是 $X = \min(1, 3) = 1$，事件指示符为 $\Delta = \mathbf{1}(1 \le 3) = 1$。他们都在 $t=1$ 时发生事件。
    -   当计算 $\hat{S}(1)$ 时，唯一的事件时间是 $t_1=1$。在 $t_1=1$ 时刻的风险集 $n_1$ 只包含那些观测时间 $X \ge 1$ 的个体。由于所有 $T=2$ 的个体都在 $t=0.5$ 被删失，风险集中只剩下那些 $T=1$ 的个体。因此，在大样本下，$n_1 \approx N \times p$。
    -   在 $t_1=1$ 时刻的事件数 $d_1$ 就是所有 $T=1$ 的个体数，即 $d_1 \approx N \times p$。
    -   因此，KM 估计量在 $t=1$ 的极限值为：
        $$ \hat{S}(1) = 1 - \frac{d_1}{n_1} = 1 - \frac{N \times p}{N \times p} = 0 $$

-   **偏倚计算**：估计的偏差为 $\text{估计值} - \text{真实值} = 0 - (1-p) = p-1$。由于 $p \in (0,1)$，这个偏差是负数。KM 估计量严重低估了真实的生存率。这是因为预后好的个体被系统性地提前移出风险集，导致估计器在[后期](@entry_id:165003)只看到了预后差的个体，从而错误地推断生存希望渺茫。这个例子清晰地表明，KM 方法的有效性完全建立在非信息性删失的假设之上。

### 扩展与局限

#### [计数过程](@entry_id:260664)表示法

Kaplan-Meier 估计量可以被置于一个更通用和现代的数学框架中——**[计数过程](@entry_id:260664) (counting process)** 理论。在这个框架下，我们定义：
-   **事件[计数过程](@entry_id:260664)** $N(t) = \sum_{i=1}^n \mathbf{1}(X_i \le t, \Delta_i=1)$，它记录了到时间 $t$ 为止观测到的事件总数。
-   **在险过程 (at-risk process)** $Y(t) = \sum_{i=1}^n \mathbf{1}(X_i \ge t)$，它记录了在时间 $t$ 处于风险集中的个体总数。

在事件时间点 $s$，发生的事件数是 $dN(s) = N(s) - N(s^-)$。风险集大小就是 $Y(s)$。因此，KM 估计量可以优雅地写为：
$$ \hat{S}(t) = \prod_{0  s \le t} \left(1 - \frac{dN(s)}{Y(s)}\right) $$
其中乘积遍布所有发生事件的时间点 $s$ [@problem_id:4921655]。这个表示法不仅统一了概念，也为后续更复杂的生存模型（如 Cox [比例风险模型](@entry_id:171806)）奠定了基础。

#### 竞争风险问题

在许多实际情况中，个体可能面临多种不同类型、相互排斥的事件。例如，一个心脏病患者可能死于心肌梗死、中风或非心血管原因。这些事件被称为**[竞争风险](@entry_id:173277) (competing risks)**。

一个常见但**错误**的做法是，在估计某一特定原因（如心肌梗死）的发生概率时，将所有其他原因（中风、非心血管死亡）导致的事件视为“非信息性删失”，然后直接应用 Kaplan-Meier 方法。

这种方法为什么是错误的？因为竞争事件的发生并非“非信息性”的。一个因中风而死亡的患者，他**永远不可能**再经历心肌梗死了。将他作为删失处理，KM 方法会错误地假定他仍然有机会在未来发生心肌梗死。这实质上创造了一个只有目标事件存在的**假想世界** [@problem_id:4921567]。

其结果是，通过这种方法计算出的“1 - KM 生存率”会系统性地**高估**特定原因的真实**累积发生率 (Cumulative Incidence Function, CIF)**。CIF 定义为到时间 $t$ 为止，因特定原因 $j$ 而发生事件的概率，它正确地考虑到了其他[竞争风险](@entry_id:173277)会使个体“退出”风险池。正确的[竞争风险分析](@entry_id:634319)需要使用专门的方法，如构建 CIF 的非[参数估计](@entry_id:139349)量（如 Aalen-Johansen 估计量），而不是误用 Kaplan-Meier 方法。这揭示了 KM 方法的一个重要应用边界。