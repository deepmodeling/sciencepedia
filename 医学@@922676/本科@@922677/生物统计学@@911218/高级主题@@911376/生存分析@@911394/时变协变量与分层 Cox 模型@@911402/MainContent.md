## 引言
生存分析是生物统计学中的核心工具，而Cox比例风险模型是其基石。然而，该模型的一个核心前提——[比例风险](@entry_id:166780)（PH）假设——在现实研究中常常难以满足，且许多关键因素本身就是随时间动态变化的。这为准确评估风险带来了巨大挑战。本文旨在填补基础Cox模型与复杂现实数据分析之间的鸿沟，系统介绍应对这些挑战的两种强大技术：**时变协变量**和**分层Cox模型**。通过本文的学习，读者将全面掌握这些高级方法的原理与应用。在第一部分“原理与机制”中，我们将深入剖析时变协变量和[分层模型](@entry_id:274952)的数学基础、估计方法以及如何避免“永生时间偏倚”等常见陷阱。接着，在“应用与跨学科联系”部分，我们将通过临床研究、流行病学、生物信息学乃至古生物学的丰富案例，展示这些模型在解决真实科学问题中的强大威力。最后，“动手实践”部分将提供具体的计算练习，帮助读者将理论知识转化为实践技能，从而自信地应对复杂的[生存数据分析](@entry_id:190868)。

## 原理与机制

在上一章中，我们介绍了生存分析的基本概念和[Cox比例风险模型](@entry_id:174252)的基础。标准Cox模型的一个核心假设是，协变量对风险的影响在整个随访期间是恒定的，即比例风险（Proportional Hazards, PH）假设。然而，在许多实际研究中，这一假设可能不成立，或者研究设计本身就涉及到随时间变化的因素。本章将深入探讨Cox模型的两个关键扩展：**时变协变量 (time-dependent covariates)** 和 **分层 (stratification)**。我们将阐述它们的原理、机制、实现方法以及在解决复杂生物统计学问题中的应用。

### 扩展[Cox模型](@entry_id:164053)：时变协变量

在许多临床或流行病学研究中，个体的某些特征并非一成不变。例如，患者的治疗方案可能会根据病情调整，血压或胆[固醇](@entry_id:173187)等生物标志物会随时间波动，或者患者可能会改变吸烟等生活习惯。这些随时间变化的协变量被称为**时变协变量 (time-dependent covariates)**。为了准确评估这些动态因素与生存结局之间的关系，我们需要将它们纳入Cox模型中。

包含时变协变量的[Cox模型](@entry_id:164053)可以表示为：
$$h(t|X(t)) = h_0(t)\exp(\beta^\top X(t))$$
其中，$h(t|X(t))$ 是个体在时间 $t$ 的瞬时风险，给定其在时间 $t$ 的协变量向量 $X(t)$。$h_0(t)$ 仍然是未被指定的**基线[风险函数](@entry_id:166593) (baseline hazard function)**，代表当所有协变量值均为零时 ($X(t)=0$) 的瞬时风险。$\beta$ 是一个与时间无关的系数向量，表示协变量的对数风险比。

一个常见的误解是，引入时变协变量意味着模型本身不再是“比例风险”模型。这种理解需要被澄清。**比例风险**的真正含义在于，在任何给定的时间点 $t$，任意两个个体的[风险函数](@entry_id:166593)之比仅依赖于他们在该时间点的协变量值，而与基线[风险函数](@entry_id:166593) $h_0(t)$ 无关。让我们考虑两个个体 $i$ 和 $j$，他们在时间 $t$ 的协变量向量分别为 $X_i(t)$ 和 $X_j(t)$。根据模型，他们的风险比 (Hazard Ratio, HR) 为：
$$ \text{HR}_{i:j}(t) = \frac{h_i(t)}{h_j(t)} = \frac{h_0(t)\exp(\beta^\top X_i(t))}{h_0(t)\exp(\beta^\top X_j(t))} = \exp(\beta^\top (X_i(t) - X_j(t))) $$
正如公式所示，基线风险 $h_0(t)$ 被完全消除了。这就是“比例”的体现。然而，由于协变量向量 $X_i(t)$ 和 $X_j(t)$ 本身是时间的函数，它们的差值也可能随时间变化，因此风险比 $\text{HR}_{i:j}(t)$ 也可能随时间 $t$ 变化 [@problem_id:4961530]。因此，当使用时变协变量时，[比例风险假设](@entry_id:163597)指的是在任一瞬间风险是“成比例”的，但这并不意味着两个特定个体在整个随访期间的风险比是一个常数。

值得注意的是，这种由于协变量值变化导致的非恒定风险比，与由于协变量**效应**本身随时间变化而导致的非[比例风险](@entry_id:166780)是不同的。后者是指，即使对于一个基线时固定的协变量 $Z$（例如，随机分组），其对数风险比 $\beta$ 也可能是时间的函数 $\beta(t)$。这种情况需要使用**时变系数 (time-varying coefficients)** 模型来处理，其形式为 $h(t|Z) = h_0(t)\exp(\beta(t)Z)$ [@problem_id:4961540]。时变协变量模型本身并不能解决时变效应导致的不满足PH假设的问题。

### 时变协变量模[型的实现](@entry_id:637593)

为了在实践中应用时变协变量模型，我们需要一个严谨的理论框架和一种特定的数据结构来处理随时间变化的信息。

#### [计数过程](@entry_id:260664)框架

现代生存分析理论常使用**[计数过程](@entry_id:260664) (counting process)** 的语言来形式化模型。对于每个个体 $i$，我们可以定义：
- **[计数过程](@entry_id:260664) $N_i(t)$**：记录个体 $i$ 在时间 $[0, t]$ 内发生事件的次数。对于单一事件的生存分析，它在事件发生前为0，在事件发生时跳跃为1。
- **在风险过程 (at-risk process) $Y_i(t)$**：一个指示变量，当个体 $i$ 在时间 $t$ 处于“在风险”状态（即已进入研究且尚未发生事件或被删失）时取值为1，否则为0。

在这个框架下，个体的瞬时事件概率由其**强度过程 (intensity process)** $\lambda_i(t)$ 决定，其定义为 $\lambda_i(t)dt = \mathbb{E}[dN_i(t) | \mathcal{F}_{t-}]$，其中 $\mathcal{F}_{t-}$ 代表截至时间 $t$ 之前的所有历史信息。强度过程与[风险函数](@entry_id:166593)的关系可以表示为 $\lambda_i(t) = Y_i(t)h_i(t)$。因此，对于包含时变协变量的[Cox模型](@entry_id:164053)，个体 $i$ 的强度过程可以写为 [@problem_id:4961491]：
$$\lambda_i(t) = Y_i(t) h_0(t) \exp(\beta^\top X_i(t))$$
这个公式优雅地整合了个体的在风险状态、基线风险和时变协变量的效应。

#### “开始-停止”数据格式

为了让统计软件能够处理时变协变量，我们需要将每个个体的随访历史分割成多个时间段，在每个时间段内，所有协变量的值都是恒定的。这种数据结构被称为**“开始-停止” (start-stop)** 或[计数过程](@entry_id:260664)格式。每个时间段对应数据集中的一行记录。

每行记录通常包含以下信息：个体ID、区间的起始时间 (start)、区间的结束时间 (stop)、在该区间内恒定的协变量值，以及一个事件指示符（通常在区间的结束时间点发生事件时为1，否则为0）。

让我们通过一个例子来阐明这一点 [@problem_id:4961476]。假设我们有两位受试者：
- **受试者1**：在时间 $t=1$ 进入研究（左截断），在 $t=10$ 时发生事件。其协变量 $X_1(t)$ 在 $[1, 4)$ 区间为0，在 $[4, 8)$ 区间为1，在 $[8, 10)$ 区间为2。
- **受试者2**：在时间 $t=0$ 进入研究，在 $t=7$ 时被删失。其协变量 $X_2(t)$ 在 $[0, 3)$ 区间为1，在 $[3, 7)$ 区间为0。

为了准备数据进行分析，我们需要将他们的随访历史转换成如下的“开始-停止”格式：

**受试者1的数据**
- 第一行：$(\text{start}, \text{stop}, X, \text{event}) = (1, 4, 0, 0)$。此区间从受试者进入研究开始，到其协变量首次变化时结束。期间未发生事件。
- 第二行：$(\text{start}, \text{stop}, X, \text{event}) = (4, 8, 1, 0)$。此区间对应协变量值为1的时期。期间未发生事件。
- 第三行：$(\text{start}, \text{stop}, X, \text{event}) = (8, 10, 2, 1)$。此区间从协变量再次变化开始，到发生事件时结束。事件指示符为1。

**受试者2的数据**
- 第一行：$(\text{start}, \text{stop}, X, \text{event}) = (0, 3, 1, 0)$。此区间从研究开始，到协变量变化时结束。期间未发生事件。
- 第二行：$(\text{start}, \text{stop}, X, \text{event}) = (3, 7, 0, 0)$。此区间从协变量变化开始，到受试者被删失时结束。由于是删失，事件指示符为0。

通过这种方式，我们将复杂的时变[数据转换](@entry_id:170268)成了标准化的格式，使得后续的似然计算成为可能。

#### [偏似然](@entry_id:165240)估计

在“开始-停止”数据格式下，[Cox模型](@entry_id:164053)的**偏[似然函数](@entry_id:141927) (partial likelihood function)** 的构建逻辑与标准模型类似，但风险集的构成和协变量取值需要特别注意。在每个唯一的事件时间 $t_j$，[偏似然](@entry_id:165240)的贡献项是发生事件的个体 $i$ 的风险，与当时所有在风险个体（即风险集 $R(t_j)$）的总风险之比。

一个关键的细节是，对于风险集 $R(t_j)$ 中的任何个体 $k$，我们使用的协变量值必须是其在事件发生**前一瞬间**的值，即 $X_k(t_j^-)$。这是因为协变量过程必须是**可预测的 (predictable)**，意味着它的值在事件发生之前是已知的。这确保了我们不会用事件发生本身或之后的信息来“预测”事件，从而避免了逻辑上的循环。

让我们通过一个例子来说明分母项的计算 [@problem_id:4961515]。假设有4个个体，事件时间发生在 $t=3, 4, 7$。
- **事件时间 $t=3$**：假设此刻风险集为 $\{1, 2, 3, 4\}$。我们需要他们各自在 $t=3^-$ 的协变量值。假设 $X_1(3^-)=0$, $X_2(3^-)=0$, $X_3(3^-)=0$, $X_4(3^-)=1$。则[偏似然](@entry_id:165240)分母为 $\exp(\beta \cdot 0) + \exp(\beta \cdot 0) + \exp(\beta \cdot 0) + \exp(\beta \cdot 1) = 3 + e^{\beta}$。
- **事件时间 $t=4$**：个体3已发生事件，退出风险集。此刻风险集为 $\{1, 2, 4\}$。假设个体4的协变量恰好在 $t=4$ 时从1变为2。根据可预测性原则，我们使用 $t=4^-$ 的值，即 $X_4(4^-)=1$。假设 $X_1(4^-)=0$, $X_2(4^-)=0$。则分母为 $\exp(\beta \cdot 0) + \exp(\beta \cdot 0) + \exp(\beta \cdot 1) = 2 + e^{\beta}$。个体4在 $t=4$ 的协变量变化，只影响未来（$t>4$）的风险集计算。
- **事件时间 $t=7$**：个体1也已发生事件。此刻风险集为 $\{2, 4\}$。此时，个体2和个体4在过去发生的协变量变化（例如，个体2在 $t=6.5$ 时协变量变化，个体4在 $t=4$ 时协变量变化）现在都已生效。假设 $X_2(7^-)=1, X_4(7^-)=2$。则分母为 $\exp(\beta \cdot 1) + \exp(\beta \cdot 2) = e^{\beta} + e^{2\beta}$。

这个过程清晰地展示了时变协变量模型是如何在每个事件时间点动态地评估风险，并正确地利用了随时间更新的信息。

### 一个关键陷阱：永生时间偏倚

正确处理时变协变量至关重要，因为错误的分类方法会导致一种常见而严重的偏倚——**永生时间偏倚 (immortal time bias)**。这种偏倚通常发生在观察性研究中，当研究者根据个体在随访期间是否“曾经”接受某种治疗或暴露，而将其从研究开始（$t=0$）就划分为“暴露组”时产生。

问题在于，那些最终进入“暴露组”的个体，必须在暴露开始前的“等待”期间存活下来。这段时间是“永生的”，因为根据定义，暴露组的死亡事件不可能在这段时间内发生。如果将这段永生时间错误地归因于暴露组的人时（person-time），就会稀释暴露组的事件发生率，从而人为地低估风险，使暴露看起来具有虚假的保护作用 [@problem_id:4961522]。

让我们来看一个具体的数值例子。假设一项研究评估一种药物对死亡率的影响。一些患者在随访期间开始用药。
- **幼稚的基线分析**：将所有“曾经”用药的患者（例如，患者1, 2, 3）从 $t=0$ 就归为“暴露组”，从未用药的（患者4, 5, 6）归为“非暴露组”。
  - 假设暴露组有2例死亡，总人时为26个月，事件率 = $2/26 \approx 0.077$。
  - 假设非暴露组有2例死亡，总人时为21个月，事件率 = $2/21 \approx 0.095$。
  - 风险比 $\approx 0.077 / 0.095 \approx 0.81$。结论：药物有保护作用。
- **正确的时变分析**：将每个患者的随访时间精确地划分为暴露前和暴露后。
  - 假设暴露后的总人时为11个月，期间发生2例死亡，事件率 = $2/11 \approx 0.182$。
  - 暴露前及从未暴露的总人时为36个月，期间发生2例死亡，事件率 = $2/36 \approx 0.056$。
  - 风险比 $\approx 0.182 / 0.056 \approx 3.27$。结论：药物有害。

这个例子戏剧性地说明，永生时间偏倚可以完全逆转研究结论。避免这种偏倚的正确方法，正是在Cox模型中使用时变协变量，通过“开始-停止”数据格式精确地反映每个个体在每个时间点的真实暴露状态。

### 应对非等比例风险：分层Cox模型

除了协变量值随时间变化，不满足PH假设的另一个常见原因是，某个**分类协变量 (categorical covariate)** 的不同水平具有形态迥异的基线风险。例如，在多中心临床试验中，不同医疗中心的基线患者死亡率和其随时间变化的模式可能大相径庭。简单地将“中心”作为一个协变量放入模型，会强加一个不切实际的假设，即任何两个中心之间的风险比是恒定的。

解决这类问题的有力工具是**分层[Cox模型](@entry_id:164053) (stratified Cox model)**。其核心思想是，允许PH假设不成立的分类协变量（我们称之为**分层变量 (stratification variable)**）的每个水平（或**层, stratum**）拥有其自己独立的、形式任意的基线[风险函数](@entry_id:166593)，同时估计其他协变量跨所有层共同的效应 [@problem_id:4961542]。

分层Cox模型的数学形式为：
$$h_i(t | X_i, S_i=s) = h_{0,s}(t)\exp(\beta^\top X_i)$$
其中，$S_i=s$ 表示个体 $i$ 属于第 $s$ 层。$h_{0,s}(t)$ 是第 $s$ 层特有的基线[风险函数](@entry_id:166593)，而系数向量 $\beta$ 对所有层都是共享的。

[分层模型](@entry_id:274952)的精妙之处在于它如何处理风险比 [@problem_id:4961490]。
- **比较不同层**：对于两个协变量相同 ($X_i=X_j$) 但分属不同层（$s_1$ 和 $s_2$）的个体，他们的风险比为：
  $$\text{HR}_{i:j}(t) = \frac{h_{0,s_1}(t)\exp(\beta^\top X_i)}{h_{0,s_2}(t)\exp(\beta^\top X_j)} = \frac{h_{0,s_1}(t)}{h_{0,s_2}(t)}$$
  由于 $h_{0,s_1}(t)$ 和 $h_{0,s_2}(t)$ 是任意的函数，它们的比值也是一个任意的时间函数。这样，模型就完美地容纳了分层变量的非[比例风险](@entry_id:166780)效应，而无需为其效应的形式做任何假设。
- **比较同一层内**：对于两个同属一层（$s$）但协变量不同（$X_i$ 和 $X_j$）的个体，他们的风险比为：
  $$\text{HR}_{i:j}(t) = \frac{h_{0,s}(t)\exp(\beta^\top X_i)}{h_{0,s}(t)\exp(\beta^\top X_j)} = \exp(\beta^\top (X_i - X_j))$$
  这与标准Cox模型完全一致，风险比是恒定的。也就是说，PH假设在**层内部 (within strata)** 对其他协变量是成立的。

通过这种方式，[分层模型](@entry_id:274952)将分层变量的非比例效应“吸收”到各自的基线风险函数中，从而可以无偏地估计其他满足PH假设的协变量的效应 ($\beta$)。值得注意的是，[分层模型](@entry_id:274952)不直接估计分层变量本身的效应大小（即没有为分层变量估计一个系数），而是将其作为一个需要控制的“讨厌”参数 (nuisance parameter) [@problem_id:4961540]。

### 分层模型的估计

分层模型的参数估计同样依赖于偏似然函数，但有一个关键的修改：**所有比较都严格限制在层内部** [@problem_id:4961500]。

具体来说，当一个位于第 $s$ 层的个体在时间 $t_j$ 发生事件时，用于计算[偏似然](@entry_id:165240)贡献项的风险集 $R_s(t_j)$ 只包含那些在时间 $t_j$ 同样位于第 $s$ 层且仍在风险中的个体。其他层的个体，无论他们当时是否在风险中，都不会被包含在这个风险集的计算中。

总的偏似然函数是所有层各自的偏[似然函数](@entry_id:141927)的乘积：
$$L(\beta) = \prod_{s=1}^{K} L_s(\beta) = \prod_{s=1}^{K} \left( \prod_{j: \text{事件发生在层 s 的时间 } t_j} \frac{\exp(\beta^\top X_{i(j)}(t_j))}{\sum_{k \in R_s(t_j)} \exp(\beta^\top X_k(t_j))} \right)$$
其中 $K$ 是总的层数。这种估计方法有效地将数据按层“隔离”，分别在每层内部进行风险比较来估计共同的效应 $\beta$，从而避免了因混合不同基线风险的群体而导致的偏倚。

### 理论基础与[一致性条件](@entry_id:637057)

时变协变量和分层Cox模型是功能强大的工具，但它们的有效性依赖于一系列理论假设。为了确保我们通过最大化[偏似然](@entry_id:165240)得到的估计量 $\hat{\beta}$ 是**一致的 (consistent)**（即当样本量趋于无穷时，它会收敛到真实的参数值），以下源于[计数过程](@entry_id:260664)理论的条件必须得到满足 [@problem_id:4961537]：

1.  **协变量过程的可预测性 (Predictability of Covariate Process)**：如前所述，任何时变协变量 $X(t)$ 的值在时间 $t$ 必须是由该时间点之前的历史信息完全决定的。这排除了任何形式的“预知未来”，确保了模型的因果解释性。

2.  **条件非信息性删失 (Conditional Non-informative Censoring)**：删失机制不能提供关于事件风险的额外信息。更确切地说，在给定个体过去所有观测历史（包括协变量历史）的条件下，删失的发生与未来的事件风险是独立的。这个假设比简单的“独立删失”更弱，也更贴近现实。例如，它允许一个因健康状况恶化（已由过去的协变量值反映）而更可能退出的患者被正确处理，但不允许删失直接与未被观测到的潜在事件风险相关联。

3.  **正确的风险集设定 (Correct Risk Set Specification)**：在每个事件时间点，风险集必须被精确无误地构建。这包括：
    - **分层**：风险集必须在正确的层内构建。
    - **在风险状态**：必须准确地包含所有已进入研究（处理延迟进入/左截断）且尚未发生事件或被删失的个体。
    - **协变量值**：必须使用每个风险集成员在该事件时间点前一瞬间的协变量值。

当这些条件得到满足时，我们就有理论保证，通过这些复杂的模型得到的[参数估计](@entry_id:139349)是可靠的，能够为我们的科学问题提供有效的答案。本章所介绍的原理和机制，为在实践中正确应用这些高级生存分析方法奠定了坚实的基础。