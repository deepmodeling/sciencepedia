## 引言
在生物统计学、公共卫生、社会科学等众多研究领域，我们经常遇到观测数据并非相互独立的情况。例如，对同一患者进行多次重复测量，或将在不同诊所招募的患者进行比较。这种数据被称为分层或聚类数据，其内在的嵌套结构是其核心特征。传统的[统计模型](@entry_id:755400)，如标准线性回归，通常假设所有观测值相互独立。当这一假设被违背时，分析结果的可靠性会受到严重威胁，可能导致我们得出错误的科学结论。那么，我们应如何科学地处理这种非独立性，从而确保研究的严谨性呢？

本文旨在系统性地解答这一问题。我们将通过三个章节，带领您全面掌握分层与聚[类数](@entry_id:156164)据的分析方法。在**“原理与机制”**一章中，我们将深入探讨非独立性的根源，并详细介绍两种主流的建模工具——混合效应模型（Mixed-Effects Models）和广义估计方程（GEE）。接着，在**“应用与跨学科连接”**一章中，我们将通过来自临床研究、流行病学和基因组学等领域的丰富案例，展示这些理论在解决实际问题中的强大功能。最后，在**“动手实践”**部分，您将有机会通过具体练习来巩固所学知识。

现在，让我们从理解这些复杂[数据结构](@entry_id:262134)背后的核心统计原理开始。

## 原理与机制

本章旨在阐述分层和聚类[数据[结](@entry_id:262134)构分析](@entry_id:153861)的核心原理与机制。在前一章介绍背景之后，我们将深入探讨这些[数据结构](@entry_id:262134)为何对统计分析构成挑战，并系统地介绍两种主要的建模方法：混合效应模型（Mixed-Effects Models）和广义估计方程（Generalized Estimating Equations, GEE）。本章将详细解释这些方法的数学基础、参数解释以及在实际应用中选择模型的关键考量因素。

### 什么是分层数据？理解非独立性

在生物统计学中，许多研究设计自然而然地产生了**分层数据（hierarchical data）**或**聚类数据（clustered data）**。当研究中的观测单元被嵌套在更高层次的单元中时，就形成了这种结构。常见的例子包括：

*   **重复测量数据**：在纵向研究中，对每个受试者（更高层次的单元）在不同时间点进行多次测量（更低层次的单元）。
*   **多中心研究**：患者（更低层次的单元）嵌套在不同的医院或诊所（更高层次的单元）中。
*   **遗传学研究**：个体（更低层次的单元）嵌套于家庭（更高层次的单元）之内。

这些结构中的核心特征是**非独立性（non-independence）**：来自同一聚类（例如，同一名患者的所有测量值，或同一家医院的所有患者）的观测值往往比来自不同聚类的观测值更为相似。这种相似性源于共享的、未被观测到的聚类级别因素（如个体的遗传背景、诊所的特定治疗方案等）。

为了精确描述这些结构，我们需要区分**严格嵌套（strict nesting）**和**交叉因子（crossed factors）**。如果每个低级别单元只属于一个高级别单元，那么就存在严格嵌套。反之，如果低级别单元可以与多个高级别单元相关联，则因子是交叉的。

例如，在一个研究血压的全国性研究中，我们有诊所、医生、患者和访视等多个观测单元 [@problem_id:4915017]。我们可以定义以下层次关系：
*   **访视（第1层）**与**患者（第2层）**：每次访视都只属于一名患者，而一名患者可以有多次访视。因此，访视严格嵌套于患者之内。
*   **医生**与**诊所（第3层）**：如果每位医生只在一家诊所工作，那么医生就严格嵌套于诊所之内。

患者与诊所的关系则可能取决于研究设计。如果政策规定每位患者只能在一家诊所就诊，那么患者就严格嵌套于诊所之内，形成一个清晰的`访视 -> 患者 -> 诊所`的三层结构。然而，如果政策允许患者在多家诊所就诊，那么患者和诊所的因子就是交叉的，因为一个患者可以关联到多个诊所，而一个诊所也服务于多个患者。在这种情况下，数据结构更为复杂，不能用简单的三层嵌套来描述。理解这些结构是选择正确分析模型的第一步。

### 统计挑战：独立性假设的违背

经典[统计模型](@entry_id:755400)，如普通最小二乘（OLS）回归，其一个基本假设是观测值的误差项是相互独立的。在分层数据中，这一假设几乎总是被违背。忽略这种内在的相关性会导致严重的[统计推断](@entry_id:172747)问题。

为了理解这种相关性是如何产生的，我们可以考虑一个简单的分层[线性模型](@entry_id:178302) [@problem_id:4915066]。假设 $Y_{ij}$ 是诊所 $j$ 中患者 $i$ 的血压，其模型可以表示为：

$$
Y_{ij} = \beta_0 + \beta_1 X_{ij} + b_j + \varepsilon_{ij}
$$

这里，$X_{ij}$ 是一个患者级别的预测变量（如年龄），$\beta_0$ 和 $\beta_1$ 是**固定效应（fixed effects）**，代表群体的平均截距和斜率。关键在于两个随机部分：$b_j$ 是诊所 $j$ 特有的**随机效应（random effect）**，代表该诊所的平均血压与总体平均水平的偏离，我们假设 $b_j \sim \mathcal{N}(0, \sigma_b^2)$。$\varepsilon_{ij}$ 是患者 $i$ 的个体特异性误差，我们假设 $\varepsilon_{ij} \sim \mathcal{N}(0, \sigma_w^2)$。

现在，我们来考察同一诊所 $j$ 内两名不同患者（$i$ 和 $i'$）的观测值 $Y_{ij}$ 和 $Y_{i'j}$ 之间的协方差：

$$
\operatorname{Cov}(Y_{ij}, Y_{i'j}) = \operatorname{Cov}(\beta_0 + \beta_1 X_{ij} + b_j + \varepsilon_{ij}, \beta_0 + \beta_1 X_{i'j} + b_j + \varepsilon_{i'j})
$$

由于固定效应和独立的误差项，协方差计算简化为：

$$
\operatorname{Cov}(Y_{ij}, Y_{i'j}) = \operatorname{Cov}(b_j, b_j) = \operatorname{Var}(b_j) = \sigma_b^2
$$

这个结果至关重要：只要诊所之间存在变异（即**[组间方差](@entry_id:175044)** $\sigma_b^2 > 0$），同一诊所内任意两个患者的观测值就是正相关的。这种相关性的根源是他们共享了同一个随机效应 $b_j$。

为了量化这种相关性，我们引入**组内[相关系数](@entry_id:147037)（Intraclass Correlation Coefficient, ICC）**，记为 $\rho$。ICC 定义为同一聚类中两个随机选择的观测值之间的相关性。首先，单个观测值的总方差是[组间方差](@entry_id:175044)和**[组内方差](@entry_id:177112)**（$\sigma_w^2 = \operatorname{Var}(\varepsilon_{ij})$）之和：

$$
\operatorname{Var}(Y_{ij}) = \operatorname{Var}(b_j) + \operatorname{Var}(\varepsilon_{ij}) = \sigma_b^2 + \sigma_w^2
$$

根据相关性的定义，ICC可以推导为 [@problem_id:4915021]：

$$
\rho = \operatorname{Corr}(Y_{ij}, Y_{i'j}) = \frac{\operatorname{Cov}(Y_{ij}, Y_{i'j})}{\sqrt{\operatorname{Var}(Y_{ij})\operatorname{Var}(Y_{i'j})}} = \frac{\sigma_b^2}{\sigma_b^2 + \sigma_w^2}
$$

ICC 的值介于0和1之间，它代表了总方差中可归因于聚类间差异的比例。一个正的 ICC 意味着忽略聚类效应将导致错误的推断。具体来说，传统的统计方法会低估[参数估计](@entry_id:139349)的标准误，从而产生过窄的[置信区间](@entry_id:138194)和过小的[p值](@entry_id:136498)。这会增加犯第一类错误的概率，导致**反保守（anticonservative）**的检验结果，即我们可能会错误地声称发现了显著效应 [@problem_id:4915066]。因此，必须采用能够正确处理组内相关性的模型。

### 建模方法I：混合效应模型

处理分层数据的一种主要方法是**混合效应模型（Mixed-Effects Models）**，也称为[多层模型](@entry_id:171741)（multilevel models）。这类模型通过同时包含固定效应和随机效应来明确地对数据中的相关性进行建模。

#### 线性混合模型（LMM）

对于连续型正态分布的结局变量，我们使用**线性混合模型（Linear Mixed Model, LMM）**。其通用矩阵形式为 [@problem_id:4915055]：

$$
Y = X\beta + Zb + \varepsilon
$$

让我们来分解这个方程的每个组成部分：
*   $Y$ 是一个 $N \times 1$ 的向量，包含了所有 $N$ 个观测值。
*   $X$ 是一个 $N \times p$ 的**固定效应设计矩阵**，包含了 $p$ 个预测变量的值。$X\beta$ 部分描述了结局变量的均值与预测变量之间的**群体平均关系**。$\beta$ 是一个 $p \times 1$ 的固定效应系数向量。
*   $Z$ 是一个 $N \times q$ 的**随机效应[设计矩阵](@entry_id:165826)**，它将 $q$ 个随机效应映射到 $N$ 个观测值上。$Zb$ 部分描述了每个聚类相对于群体平均的**特异性偏离**。$b$ 是一个 $q \times 1$ 的随机效应向量。
*   $\varepsilon$ 是一个 $N \times 1$ 的[残差向量](@entry_id:165091)，代表了未被[模型解释](@entry_id:637866)的随机误差。

模型的随机部分有其分布假设：随机效应 $b \sim \mathcal{N}(0, \Sigma_b)$，残差 $\varepsilon \sim \mathcal{N}(0, \sigma^2 I_N)$。这里，$\Sigma_b$ 是随机效应的协方差矩阵，$I_N$ 是一个 $N \times N$ 的单位矩阵。

通过这个设定，LMM 为结局向量 $Y$ 构建了一个非对角的边际协方差矩阵：

$$
\operatorname{Var}(Y) = \operatorname{Var}(Zb + \varepsilon) = Z\operatorname{Var}(b)Z^\top + \operatorname{Var}(\varepsilon) = Z\Sigma_b Z^\top + \sigma^2 I_N
$$

这个协方差矩阵精确地捕捉了由共享随机效应引起的组内相关性。例如，在一个随机截距模型中，$\Sigma_b = \tau^2 I_J$（其中 $J$ 是聚类数），两个在同一聚类的观测值之间的协方差为 $\tau^2$，而不同聚类的观测值之间协方差为0 [@problem_id:4915055]。

#### 随机截距与随机斜率

混合效应模型的灵活性在于它可以对不同类型的效应进行随机化。最常见的两种是随机截距和随机斜率 [@problem_id:4915037]。

*   **随机截距模型（Random-Intercept Model）**：该模型允许每个聚类的基线水平（截距）不同。
    $$
    y_{ij} = \beta_0 + \beta_1 x_{ij} + b_{0j} + \epsilon_{ij}
    $$
    这里，$b_{0j}$ 是聚类 $j$ 的随机截距。这意味着每个聚类的回归线都是平行的，只是起点不同。

*   **随机截距和随机斜率模型（Random-Intercept-and-Slope Model）**：该模型更进一步，不仅允许截距变化，还允许某个预测变量的效应（斜率）在不同聚类间变化。
    $$
    y_{ij} = (\beta_0 + b_{0j}) + (\beta_1 + b_{1j}) x_{ij} + \epsilon_{ij} = \beta_0 + \beta_1 x_{ij} + b_{0j} + b_{1j} x_{ij} + \epsilon_{ij}
    $$
    这里，随机效应向量是 $b_j = (b_{0j}, b_{1j})^\top$。它的协方差矩阵 $\Sigma_b$ 现在是一个 $2 \times 2$ 的矩阵：
    $$
    \Sigma_b = \begin{pmatrix} \operatorname{Var}(b_{0j}) & \operatorname{Cov}(b_{0j}, b_{1j}) \\ \operatorname{Cov}(b_{0j}, b_{1j}) & \operatorname{Var}(b_{1j}) \end{pmatrix} = \begin{pmatrix} \tau_0^2 & \rho \tau_0 \tau_1 \\ \rho \tau_0 \tau_1 & \tau_1^2 \end{pmatrix}
    $$
    对角[线元](@entry_id:196833)素 $\tau_0^2$ 和 $\tau_1^2$ 分别是随机截距和随机斜率的方差。非对角线元素表示截距和斜率之间的协方差，其中 $\rho$ 是它们之间的相关性。一个非零的 $\rho$ 意味着，例如，基线水平较高的聚类（$b_{0j} > 0$）可能其斜率也系统性地更高或更低。

#### 广义线性混合模型（GLMM）

当结局变量不是连续正态分布时（例如，二元结局或计数数据），我们可以将LMM扩展为**广义线性混合模型（Generalized Linear Mixed Model, GLMM）**。GLMM通过一个**联结函数（link function）** $g(\cdot)$ 将结局的条件均值与[线性预测](@entry_id:180569)器联系起来 [@problem_id:4914992]：

$$
g(E[Y_{ij} \mid b_j]) = \eta_{ij} = x_{ij}^\top\beta + z_{ij}^\top b_j
$$

对于二元结局变量 $Y_{ij} \in \{0,1\}$，我们通常使用伯努利（Bernoulli）分布。其**典则联结函数（canonical link）**是**logit**函数。因此，一个用于二元结局的GLMM（也称为逻辑[混合模型](@entry_id:266571)）可以指定为：

1.  **[条件分布](@entry_id:138367)**: $Y_{ij} \mid b_j \sim \mathrm{Bernoulli}(\mu_{ij})$
2.  **联结函数**: $\mathrm{logit}(\mu_{ij}) = \log\left(\frac{\mu_{ij}}{1-\mu_{ij}}\right) = x_{ij}^\top\beta + z_{ij}^\top b_j$
3.  **随机效应分布**: $b_j \sim \mathcal{N}(0, D)$

这个模型允许我们在处理非正态结局的同时，对数据中的相关性结构进行建模。

### 建模方法II：边际模型（GEE）

处理分层数据的第二种主要方法是**广义估计方程（Generalized Estimating Equations, GEE）**。与混合效应模型明确模拟随机效应不同，GEE是一种**边际模型（marginal model）**，它直接关注于**群体平均效应**，并将组内相关性视为一种需要处理的“滋扰”（nuisance）。

GEE方法有三个核心组成部分 [@problem_id:4915050]：

1.  **边际均值模型**：它通过一个联结函数 $g(\cdot)$ 将结局变量的**边际期望**（即在总体上平均的期望）与预测变量联系起来：
    $$
    g(E[Y_{ij}]) = g(\mu_{ij}) = x_{ij}^{\top}\beta
    $$
    这里的系数 $\beta$ 代表**群体平均效应（population-averaged effects）**。

2.  **“工作”相关性矩阵**：为了提高估计效率，我们需要对组内相关性结构做一个假设，这被称为**工作相关性矩阵（working correlation matrix）** $R(\alpha)$。常见的选择包括：
    *   **独立（Independence）**：假设观测值不相关（$R$ 是单位矩阵）。
    *   **可交换（Exchangeable）**：假设聚类内任意两个观测值之间的相关性是恒定的。
    *   **自回归（Autoregressive）**：对于纵向数据，假设随时间间隔增加，相关性呈指数衰减。

3.  **稳健（三明治）标准误估计**：这是GEE方法的一个标志性特征。即使“工作”相关性矩阵的设定是错误的，GEE也能提供对 $\beta$ 的一致性[点估计](@entry_id:174544)（只要均值模型设定正确）。更重要的是，它使用一种**经验性（或称“三明治”）标准误估计量（robust/sandwich variance estimator）**，该估计量即使在工作相关性设定错误的情况下，也能为 $\hat{\beta}$ 提供有效的标准误和[置信区间](@entry_id:138194)。

GEE的优势在于其稳健性和对群体平均效应的直接建模，这在流行病学和公共卫生研究中通常是首要关注点。

### 如何选择模型：LMM/GLMM vs. GEE

选择[混合模型](@entry_id:266571)还是GEE，取决于研究问题、对效应的解释以及对数据（特别是缺失数据）的假设。

#### 估计目标：特定主[体效应](@entry_id:261475) vs. 群体平均效应

这两种方法估计的参数 $\beta$ 具有不同的解释，这种差异在非线性模型中尤为重要 [@problem_id:4915012]。

*   **特定主体效应（Subject-Specific, SS）**：由GLMM估计。$\beta_{SS}$ 描述了**在给定一个特定主体（或聚类）的情况下**，预测变量变化一个单位时，期望结局的变化。例如，一个 odds ratio（比值比）为2.0的SS效应意味着，对于某个特定个体，当其预测变量增加一个单位时，其成功事件的几率会翻倍。

*   **群体平均效应（Population-Averaged, PA）**：由GEE估计。$\beta_{PA}$ 描述了**在整个研究群体中**，预测变量变化一个单位时，期望结局的变化。例如，一个 odds ratio 为1.5的PA效应意味着，在总体中随机抽取两个分别具有不同预测变量值的个体，其平均成功几率的比值为1.5。

这两种效应之间的关系取决于联结函数：
*   对于**[线性模型](@entry_id:178302)（恒等联结函数）**，如LMM，两种效应是**相同的**。即 $\beta_{LMM} = \beta_{GEE}$。
*   对于**[非线性模型](@entry_id:276864)（如logit联结）**，两种效应是**不同的**。通常，群体平均效应的绝对值会比特定主[体效应](@entry_id:261475)的绝对值要小，即 $|\beta_{PA}| \le |\beta_{SS}|$。这是因为PA效应是在具有不同基线风险的个体上平均得到的结果，这种异质性会“稀释”效应的大小。

#### 实践考量：假设与缺失数据

在实践中，模型选择还受到数据特征的影响，尤其是缺失数据 [@problem_id:4915030]。

*   **模型假设**：LMM/GLMM是基于似然的方法，其有效性依赖于对随机效应分布的正确设定（通常是正态分布）。而GEE对于工作相关性矩阵的设定是稳健的（就[标准误](@entry_id:635378)而言），但它强烈依赖于均值模型的正确设定。

*   **缺失数据**：这是一个关键区别。
    *   基于似然的方法，如LMM和GLMM，在数据**[随机缺失](@entry_id:168632)（Missing At Random, MAR）**的条件下是有效的。MAR意味着缺失的概率可以依赖于已观测到的数据，但不能依赖于未观测到的数据本身。
    *   标准的GEE在默认情况下只在更严格的**[完全随机缺失](@entry_id:170286)（Missing Completely At Random, MCAR）**条件下才是无偏的。MCAR意味着缺失与任何已观测或未观测的数据都无关。要在MAR下使用GEE得到无偏估计，通常需要结合逆概率加权（IPW）等额外技术。

因此，如果研究的主要目标是理解个体内部的变化机制（SS效应），或者数据存在MAR缺失，那么LMM/GLMM通常是更合适的选择。如果目标是评估政策或干预措施在人群层面的平均影响（PA效应），并且研究者希望减少对随机效应分布的假设，那么GEE是一个强有力的备选方案。

### 高级主题：预测变量的中心化

在[多层模型](@entry_id:171741)中，对第1层（个体层面）预测变量进行**中心化（centering）**是一个重要的实践步骤，因为它会影响系数的解释以及模型的[数值稳定性](@entry_id:146550) [@problem_id:4915027]。

主要有两种中心化方法：

*   **按[总体均值](@entry_id:175446)中心化（Grand-Mean Centering）**：将每个观测值减去所有观测值的总平均值，即 $X_{ij}^{G} = X_{ij} - \bar{X}$。当使用这个变量作为预测变量时，其系数 $\beta_1$ 代表的是一个**混合效应**，它混淆了**组内效应**（例如，在同一诊所内，钠摄入量与血压的关系）和**组间效应**（例如，平均钠摄入量较高的诊所是否其患者的平均血压也较高）。

*   **按聚类均值中心化（Cluster-Mean Centering）**：将每个观测值减去其所在聚类的平均值，即 $X_{ij}^{C} = X_{ij} - \bar{X}_{\cdot j}$。使用这个变量时，其系数 $\beta_1$ 代表的是纯粹的**组内效应**。它隔离了所有聚类间的差异，只关注在同一个聚类内部，预测变量的变化如何影响结局。

要同时估计组内和组间效应，可以构建一个包含两个变量的模型：

$$
Y_{ij} = \gamma_0 + \gamma_W(X_{ij} - \bar{X}_{\cdot j}) + \gamma_B(\bar{X}_{\cdot j} - \bar{X}) + u_{0j} + \epsilon_{ij}
$$

在这个模型中，$\gamma_W$ 明确地估计了组内效应，而 $\gamma_B$ 则估计了组间效应。这种分解对于理解一个预测变量在不同分析层次上可能存在的不同作用至关重要。例如，在个体层面增加锻炼可能降低血压（负的 $\gamma_W$），但平均锻炼水平更高的社区可能因为其他健康行为而具有更高的平均血压（正的 $\gamma_B$）。正确地应用中心化技术是进行严谨多层分析的关键。