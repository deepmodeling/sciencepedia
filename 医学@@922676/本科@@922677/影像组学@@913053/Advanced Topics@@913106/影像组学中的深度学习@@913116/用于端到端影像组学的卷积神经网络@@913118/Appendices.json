{"hands_on_practices": [{"introduction": "医学影像（如磁共振成像 MRI）通常具有各向异性体素，即不同维度上的物理间距不同。直接应用标准的卷积神经网络（CNN）可能无法获得最佳效果，因为它可能错误地混合了不成比例的物理空间中的信息。本练习将挑战您像一位CNN架构师一样思考，通过精心设计网络组件（如步长和卷积核形状）来适应数据的物理属性，而无需进行计算成本高昂的重采样。通过这个过程，您将建立起对架构选择如何影响物理空间特征学习的直观理解 [@problem_id:4534271]。", "problem": "一个端到端的放射组学流程处理三维磁共振成像（MRI）体积数据，其体素间距沿 $(x,y,z)$ 轴具有各向异性，为 $(1.0, 1.0, 5.0)$ 毫米。考虑一个三层三维卷积神经网络（CNN），其目的是为下游的监督学习任务提取特征。您必须设计一个步长（stride）和扩张（dilation）方案，该方案应遵循采集数据的各向异性，且不对输入体积进行任何重采样。设计必须满足以下所有约束，这些约束反映了在此类场景中的标准工程选择：\n\n- 在第一层使用单位步长 $(1,1,1)$，以保留输入端的高频细节。\n- 在三层网络中实现总计为 $4$ 的平面内下采样因子，该下采样仅应用于 $x$ 和 $y$ 轴，而 $z$ 轴上无下采样。具体而言，在三层中的两层使用步长 $(2,2,1)$，在剩下的一层使用单位步长 $(1,1,1)$。\n- 为遵循切片间的各向异性，在平面内感受野（以物理单位计）达到至少一个切片厚度之前，禁止任何跨切片的混合。具体而言，在任何前一层平面内感受野（以物理单位计）严格小于 $5$ 毫米的层中，沿 $z$ 轴使用深度为 $1$ 的卷积核（即 $k_{z}=1$）；从前一层平面内感受野（以物理单位计）至少为 $5$ 毫米的第一层开始，沿 $z$ 轴使用深度为 $3$ 的卷积核（即 $k_{z}=3$）。\n- 在满足上述所有约束的前提下，沿所有轴使用最小的正整数扩张率。\n\n假设所有卷积核沿 $x$ 和 $y$ 轴的空间尺寸均为 $3$（即 $k_{x}=k_{y}=3$），选择零填充（zero padding）以使输出与输入的中心体素对齐，并且网络中没有跳跃连接（skip connections）。在推断各层感受野增长时，独立处理每个空间轴。\n\n仅使用在带步长和扩张的卷积组合下感受野增长的基本定义，根据您设计的方案，确定第三层之后沿每个轴的最终有效感受野范围（以物理单位毫米计）。为清晰起见，将沿给定轴的有效感受野范围定义为：能够影响该轴上单个输出元素的最小连续输入段的物理长度，其值等于该轴上感受野内的输入体素数量乘以该轴上的体素间距。\n\n将您的最终答案表示为一个行向量 $\\begin{pmatrix} R_{x}  R_{y}  R_{z} \\end{pmatrix}$，单位为毫米。无需四舍五入。", "solution": "该问题陈述具有科学依据、问题适定、客观且内部一致。唯一解所需的所有数据和约束均已提供。该问题是在医学成像的实际设计场景中应用卷积神经网络基本原理的一个有效练习。因此，有必要给出完整的解答。\n\n问题的核心是根据一组约束条件，确定一个三层3D CNN的设计参数——具体是每层的步长、卷积核大小和扩张率——然后计算由此产生的有效感受野。第 $i$ 层之后沿单个轴的有效感受野 $R_i$（以体素为单位）可以递归计算。设 $R_{i-1}$ 为前一层之后的感受野（其中 $R_0=1$），$k_i$ 为第 $i$ 层的卷积核大小，$d_i$ 为第 $i$ 层的扩张率，$S_{i-1}$ 为截至第 $i-1$ 层的步长累积乘积，定义为 $S_{i-1} = \\prod_{j=1}^{i-1} s_j$（其中 $S_0 = 1$）。递归公式为：\n$$R_i = R_{i-1} + (k_i - 1) d_i S_{i-1}$$\n我们将此公式独立应用于每个空间轴 $(x, y, z)$。最终以物理单位表示的感受野范围等于以体素为单位的感受野乘以相应的体素间距。\n\n给定的参数如下：\n- 体素间距：$v = (v_x, v_y, v_z) = (1.0, 1.0, 5.0)$ 毫米。\n- 层数：$3$。\n- 平面内卷积核大小：对于 $i \\in \\{1, 2, 3\\}$，$k_{ix} = k_{iy} = 3$。\n\n我们逐层确定参数并计算感受野的增长。\n\n**步骤1：确定网络参数**\n\n**第1层：**\n- **步长 ($s_1$)：** 问题陈述要求在第一层使用单位步长。因此，$s_1 = (s_{1x}, s_{1y}, s_{1z}) = (1, 1, 1)$。\n- **扩张率 ($d_1$)：** 问题要求使用最小的正整数扩张率。在没有其他约束强制要求更大值的情况下，最小的正整数是 $1$。因此，$d_1 = (d_{1x}, d_{1y}, d_{1z}) = (1, 1, 1)$。\n- **卷积核大小 ($k_1$)：** 给定 $k_{1x}=3$ 和 $k_{1y}=3$。对于 $k_{1z}$，我们必须评估各向异性约束。第1层的“前一层平面内感受野”是输入的感受野，即单个体素。其物理尺寸为 $\\max(1 \\cdot v_x, 1 \\cdot v_y) = \\max(1.0, 1.0) = 1.0$ 毫米。由于 $1.0  5.0$，该约束要求无跨切片混合。因此，$k_{1z} = 1$。\n- **第1层参数：** $s_1=(1,1,1)$，$d_1=(1,1,1)$，$k_1=(3,3,1)$。\n\n**第2层：**\n- **步长 ($s_2$)：** 平面内总下采样因子必须为 $4$，通过在三层中的两层使用步长 $(2,2,1)$ 来实现。由于第1层是单位步长，因此第2层和第3层必须使用步长 $(2,2,1)$。因此，$s_2 = (s_{2x}, s_{2y}, s_{2z}) = (2, 2, 1)$。\n- **扩张率 ($d_2$)：** 使用最小的正整数，即 $d_2 = (d_{2x}, d_{2y}, d_{2z}) = (1, 1, 1)$。\n- **卷积核大小 ($k_2$)：** 给定 $k_{2x}=3$ 和 $k_{2y}=3$。为了求出 $k_{2z}$，我们首先需要第1层之后的平面内感受野。\n  - 第2层之前的累积步长乘积为 $S_1 = s_1 = (1,1,1)$。\n  - 第1层之后的感受野（以体素为单位）（$R_1$）：\n    - $R_{1x} = R_0 + (k_{1x}-1)d_{1x}S_0 = 1 + (3-1) \\cdot 1 \\cdot 1 = 3$。\n    - $R_{1y} = R_0 + (k_{1y}-1)d_{1y}S_0 = 1 + (3-1) \\cdot 1 \\cdot 1 = 3$。\n  - 前一层的平面内物理感受野为 $\\max(R_{1x} \\cdot v_x, R_{1y} \\cdot v_y) = \\max(3 \\cdot 1.0, 3 \\cdot 1.0) = 3.0$ 毫米。由于 $3.0  5.0$，该约束要求 $k_{2z} = 1$。\n- **第2层参数：** $s_2=(2,2,1)$，$d_2=(1,1,1)$，$k_2=(3,3,1)$。\n\n**第3层：**\n- **步长 ($s_3$)：** 如上所述，$s_3 = (s_{3x}, s_{3y}, s_{3z}) = (2, 2, 1)$。平面内总步长乘积为 $s_{1x}s_{2x}s_{3x} = 1 \\cdot 2 \\cdot 2 = 4$，满足约束条件。\n- **扩张率 ($d_3$)：** 使用最小的正整数，即 $d_3 = (d_{3x}, d_{3y}, d_{3z}) = (1, 1, 1)$。\n- **卷积核大小 ($k_3$)：** 给定 $k_{3x}=3$ 和 $k_{3y}=3$。为了求出 $k_{3z}$，我们首先需要第2层之后的平面内感受野。\n  - 第3层之前的累积步长乘积为 $S_2 = (s_{1x}s_{2x}, s_{1y}s_{2y}, s_{1z}s_{2z}) = (1 \\cdot 2, 1 \\cdot 2, 1 \\cdot 1) = (2, 2, 1)$。\n  - 第2层之后的感受野（以体素为单位）（$R_2$）：\n    - $R_{2x} = R_{1x} + (k_{2x}-1)d_{2x}S_{1x} = 3 + (3-1) \\cdot 1 \\cdot 1 = 5$。\n    - $R_{2y} = R_{1y} + (k_{2y}-1)d_{2y}S_{1y} = 3 + (3-1) \\cdot 1 \\cdot 1 = 5$。\n  - 前一层的平面内物理感受野为 $\\max(R_{2x} \\cdot v_x, R_{2y} \\cdot v_y) = \\max(5 \\cdot 1.0, 5 \\cdot 1.0) = 5.0$ 毫米。“严格小于 $5$ 毫米”的条件现在不成立。规则规定，从前一层感受野“至少为 $5$ 毫米”的第一层开始使用 $k_z=3$。这个条件在第3层首次满足。因此，$k_{3z} = 3$。\n- **第3层参数：** $s_3=(2,2,1)$，$d_3=(1,1,1)$，$k_3=(3,3,3)$。\n\n**步骤2：计算最终感受野**\n\n现在我们使用上面确定的参数来计算最终的感受野（以体素为单位），即 $R_3$。\n\n**沿x轴：**\n- $R_{0x}=1$\n- $R_{1x}=3$\n- $R_{2x}=5$\n- $R_{3x} = R_{2x} + (k_{3x}-1)d_{3x}S_{2x} = 5 + (3-1) \\cdot 1 \\cdot 2 = 5 + 4 = 9$。\n\n**沿y轴：**\n- $R_{0y}=1$\n- $R_{1y}=3$\n- $R_{2y}=5$\n- 根据与x轴的对称性，$R_{3y} = 9$。\n\n**沿z轴：**\n- 我们必须从头开始计算感受野的增长。\n- $R_{0z}=1$。\n- 第1层：$R_{1z} = R_{0z} + (k_{1z}-1)d_{1z}S_{0z} = 1 + (1-1) \\cdot 1 \\cdot 1 = 1$。\n- 第2层：$R_{2z} = R_{1z} + (k_{2z}-1)d_{2z}S_{1z} = 1 + (1-1) \\cdot 1 \\cdot 1 = 1$。\n- 第3层：$R_{3z} = R_{2z} + (k_{3z}-1)d_{3z}S_{2z} = 1 + (3-1) \\cdot 1 \\cdot 1 = 1 + 2 = 3$。\n\n最终的感受野（以体素为单位）是 $R_3 = (R_{3x}, R_{3y}, R_{3z}) = (9, 9, 3)$。\n\n**步骤3：转换为物理单位**\n\n问题要求最终的有效感受野范围（以物理单位毫米计）。我们将体素数量乘以体素间距 $v = (1.0, 1.0, 5.0)$ 毫米。\n- 沿x轴的范围：$R_x = R_{3x} \\cdot v_x = 9 \\cdot 1.0 = 9.0$ 毫米。\n- 沿y轴的范围：$R_y = R_{3y} \\cdot v_y = 9 \\cdot 1.0 = 9.0$ 毫米。\n- 沿z轴的范围：$R_z = R_{3z} \\cdot v_z = 3 \\cdot 5.0 = 15.0$ 毫米。\n\n最终的有效感受野范围是 $(9.0, 9.0, 15.0)$ 毫米。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n9.0  9.0  15.0\n\\end{pmatrix}\n}\n$$", "id": "4534271"}, {"introduction": "在设计好模型之后，我们需要对其进行可靠的评估。在医学影像分析中，一个常见且危险的陷阱是数据泄漏，即验证集的信息无意中“泄漏”到训练过程中，导致模型性能被过分乐观地估计。本练习探讨了这一关键的方法论问题，引导您深入思考统计独立性的重要性，并选择能够产生可信性能估计的验证策略（如按患者分组交叉验证）。掌握这些技能对于开展严谨的科学研究至关重要 [@problem_id:4534196]。", "problem": "您正在为一个基于医学影像的二元放射组学任务训练一个端到端的卷积神经网络（CNN）。对于每个索引为 $p \\in \\{1,\\dots,P\\}$ 的患者，您有一个3D体积数据和一个单一的患者级别标签 $y_p \\in \\{0,1\\}$。从每位患者中，您提取索引为 $i \\in \\{1,\\dots,n_p\\}$ 的2D切片或3D补丁，得到观测值 $(x_{p,i}, y_p)$。假设存在一个数据生成过程，其中包含一个患者特有的潜在因子 $\\theta_p$（编码肿瘤表型、采集方案、扫描仪、预处理的特殊情况），并且患者内部的观测值在给定 $\\theta_p$ 时满足条件独立性：对于固定的 $p$，$(x_{p,i} \\mid \\theta_p)$ 在不同 $i$ 之间是独立的，但边际上，对于 $i \\neq i'$，$(x_{p,i})$ 和 $(x_{p,i'})$ 通过 $\\theta_p$ 呈正相关。在不同患者之间，$(\\theta_p)$ 是独立同分布的。\n\n设一个学习算法通过在训练集 $\\mathcal{S}_{\\text{train}}$ 上进行经验风险最小化来生成一个模型 $f$，最小化经验风险 $\\hat{R}(f;\\mathcal{S}_{\\text{train}}) = \\frac{1}{n_{\\text{train}}} \\sum_{(x,y) \\in \\mathcal{S}_{\\text{train}}} \\ell(f(x),y)$，其中损失函数 $\\ell$ 有界。标准的k折交叉验证（CV）是在样本独立同分布（i.i.d.）的假设下估计泛化误差的。考虑一下，如果您按切片或补丁进行随机划分（这样来自同一患者的切片可能会同时出现在训练集和验证集中），与按患者进行划分（这样没有患者会贡献于多个折）相比，会发生什么情况。\n\n仅使用独立性、经验风险以及交叉验证中有效风险估计所需的独立同分布假设这些核心定义，论证患者内部相关性对估计的泛化误差的影响。然后，确定下列哪些陈述正确地描述了在这种基于CNN的端到端放射组学设置中的泄露风险和稳健的划分策略。选择所有适用的选项。\n\nA. 如果您按切片划分，使得同一患者的切片可以同时出现在训练集和验证集中，那么CNN可以学习到与 $\\theta_p$ 相关的患者特有因素（例如扫描仪特有的强度模式），导致验证损失相对于在真正未见过的患者上的表现出现乐观的向下偏差。一个稳健的替代方案是使用分组k折交叉验证，将患者标识符作为分组依据，以确保每位患者只出现在一个折中。\n\nB. 如果您提取有重叠的补丁，但确保同一患者的补丁不会跨越训练集和验证集，数据泄露仍然存在，因为不同患者的补丁在视觉上可能相似；因此，唯一稳健的策略是避免任何形式的交叉验证，并在用于训练的相同数据上进行评估。\n\nC. 按切片进行分层划分，以匹配每个折中阳性切片的比例，可以保证训练样本和验证样本的独立性，从而即使同一患者的切片出现在多个折中也能消除泄露。\n\nD. 在患者是独立同分布的假设下，留一患者交叉验证（Leave-One-Patient-Out CV）可以对新患者的误差产生近似无偏的估计；为避免模型选择过程中的泄露，应在一个同样按患者进行划分的内循环中调整超参数（嵌套交叉验证）。\n\nE. 在补丁上训练CNN时，可以在划分数据集之前对整个数据集计算全局预处理统计数据（例如，用于强度归一化的均值和标准差），因为这些统计数据与标签无关，不会导致数据泄露。", "solution": "问题陈述描述了医学影像分析中的一个常见情景，即在一个具有层次结构的数据上训练机器学习模型。具体来说，多个观测值（切片或补丁）源自单个主体（患者），这导致了主体内相关性。核心任务是评估在存在这种相关性的情况下，不同交叉验证策略有效性的相关陈述。\n\n### 问题验证\n\n**第一步：提取已知信息**\n- **领域**：用于二元放射组学任务的端到端卷积神经网络（CNN）。\n- **数据来源**：医学影像。\n- **数据结构**：\n    - 有 $P$ 位患者，索引为 $p \\in \\{1,\\dots,P\\}$。\n    - 每位患者 $p$ 有一个单一的患者级别标签 $y_p \\in \\{0,1\\}$。\n    - 从每位患者 $p$ 中，提取 $n_p$ 个观测值（2D切片或3D补丁），索引为 $i \\in \\{1,\\dots,n_p\\}$。\n    - 每个观测值是一对 $(x_{p,i}, y_p)$，其中对于来自患者 $p$ 的所有观测值，标签 $y_p$ 是恒定的。\n- **数据生成过程**：\n    - 每位患者 $p$ 存在一个患者特有的潜在因子 $\\theta_p$。\n    - 在一位患者 $p$ 内部，给定 $\\theta_p$，观测值 $(x_{p,i} \\mid \\theta_p)$ 在不同 $i$ 之间是条件独立的。\n    - 边际上，对于一位固定的患者 $p$，当 $i \\neq i'$ 时，观测值 $(x_{p,i})$ 和 $(x_{p,i'})$ 因共同因子 $\\theta_p$ 而呈正相关。\n    - 在不同患者之间，潜在因子 $(\\theta_p)$ 是独立同分布的（i.i.d.）。这意味着不同的患者是独立同分布的单元。\n- **学习算法**：\n    - 在训练集 $\\mathcal{S}_{\\text{train}}$ 上进行经验风险最小化。\n    - 目标是最小化经验风险 $\\hat{R}(f;\\mathcal{S}_{\\text{train}}) = \\frac{1}{n_{\\text{train}}} \\sum_{(x,y) \\in \\mathcal{S}_{\\text{train}}} \\ell(f(x),y)$。\n    - 损失函数 $\\ell$ 是有界的。\n- **评估背景**：\n    - 使用标准的k折交叉验证（CV）来估计泛化误差。\n    - 标准的CV程序假设样本是独立同分布的。\n- **问题**：论证患者内部相关性对泛化误差估计的影响，并确定关于数据泄露和稳健划分策略的正确陈述。\n\n**第二步：使用提取的已知信息进行验证**\n问题陈述在科学上和方法上都是合理的。\n- **科学依据**：这个前提非常现实。在医学影像中，来自同一患者（甚至同一扫描仪）的数据共享一些特征（例如，解剖结构、图像纹理、噪声模式、重建伪影），这些特征在其他患者的数据中是不存在的。使用潜在的患者特有因子 $\\theta_p$ 的概念是对此类层次相关性进行建模的一种标准且恰当的方法。\n- **问题定义明确**：该问题定义清晰。它为数据建立了一个明确的统计模型，并要求在此模型下分析一个标准的机器学习评估程序（交叉验证）。违反独立同分布假设的后果是统计学习理论中的一个核心主题。\n- **客观性**：该问题使用精确、客观、形式化的数学语言陈述。它避免了模糊性和主观性。\n\n**第三步：结论与行动**\n问题是有效的。它描述了将机器学习应用于结构化数据时的一个典型挑战，并且没有缺陷。可以继续进行求解过程。\n\n### 推导与选项分析\n\n交叉验证的基本原则是估计在新、未见过的数据上的预期预测误差（泛化误差）。为了使这个估计是无偏的，验证集必须在统计上独立于训练集。问题陈述指出，患者是独立同分布的，但一个患者内部的观测值（切片/补丁）不是。因此，患者是数据的独立单元。任何有效的交叉验证划分方案都必须尊重这种独立性，即来自单个患者的所有数据必须只属于一个折。\n\n如果通过在切片/补丁层面进行划分而违反了这一原则，训练集和验证集将包含相关的样本。例如，如果切片 $x_{p,i}$ 在训练集中，而切片 $x_{p,j}$（来自同一患者 $p$）在验证集中，模型 $f$ 可以从 $x_{p,i}$ 中学习到与 $\\theta_p$ 相关的、不可泛化的患者特有特征，并利用这些“泄露”的信息对 $x_{p,j}$ 做出更容易的预测。这会导致人为压低的验证误差，这种现象被称为数据泄露，它会导致对模型在真正新患者上性能的乐观偏误估计。\n\n**选项 A：如果您按切片划分，使得同一患者的切片可以同时出现在训练集和验证集中，那么CNN可以学习到与 $\\theta_p$ 相关的患者特有因素（例如扫描仪特有的强度模式），导致验证损失相对于在真正未见过的患者上的表现出现乐观的向下偏差。一个稳健的替代方案是使用分组k折交叉验证，将患者标识符作为分组依据，以确保每位患者只出现在一个折中。**\n\n该陈述是对问题及其解决方案的精确而准确的描述。\n1.  **问题描述**：按切片/补丁划分允许来自同一患者的相关数据同时存在于训练集和验证集中。CNN足够强大，可以学习到患者特有的潜在因子 $\\theta_p$（例如，扫描仪伪影、特定的组织纹理）。这使得模型能够“识别”验证集中的患者，而不是学习与标签 $y_p$ 相关的可泛化特征。这导致验证损失低于真实的泛化误差，从而产生乐观偏差。\n2.  **建议的解决方案**：分组k折交叉验证（也称为按主体或按患者的交叉验证）将来自单个患者的所有数据视为一个不可分割的组。通过将每个患者组精确地分配到一个折中，它确保了训练集和验证集由不相交的患者集组成。由于患者是独立同分布的，这使得训练折和验证折是独立的，满足了对泛化误差进行无偏估计的核心要求。\n该陈述与层次化数据的统计学习原则完全一致。\n\n**结论：正确。**\n\n**选项 B：如果您提取有重叠的补丁，但确保同一患者的补丁不会跨越训练集和验证集，数据泄露仍然存在，因为不同患者的补丁在视觉上可能相似；因此，唯一稳健的策略是避免任何形式的交叉验证，并在用于训练的相同数据上进行评估。**\n\n这个陈述有根本性的缺陷。\n第一个条件，“确保同一患者的补丁不会跨越训练集和验证集”，描述了*正确*的按患者划分策略。声称泄露仍然发生是因为“不同患者的补丁在视觉上可能相似”是对泄露和机器学习目标的误解。模型*应该*在来自不同患者的视觉相似的补丁中找到区分类别 $y=0$ 和 $y=1$ 的模式。这是学习任务，而不是一种泄露形式。当关于验证集样本的信息（超出了一般群体中可获得的信息）存在于训练集中时，才会发生泄露。最后的结论，即应该“在用于训练的相同数据上进行评估”，是衡量训练误差的定义，而训练误差是众所周知的对泛化性能的糟糕且有偏的估计量。\n\n**结论：不正确。**\n\n**选项 C：按切片进行分层划分，以匹配每个折中阳性切片的比例，可以保证训练样本和验证样本的独立性，从而即使同一患者的切片出现在多个折中也能消除泄露。**\n\n这个陈述将分层与确保独立性混为一谈。分层是一种技术，用于确保每个折具有相似的目标变量（或其他重要特征）分布，从而降低CV估计量的方差。然而，它不能解决样本依赖的问题。如果来自同一患者的切片出现在多个折中，那么无论切片标签是否平衡，这些折都不是独立的。通过 $\\theta_p$ 产生的相关性依然存在，数据泄露也依然存在。因此，在这种情况下，按切片分层并不能保证独立性，也不能消除泄露。\n\n**结论：不正确。**\n\n**选项 D：在患者是独立同分布的假设下，留一患者交叉验证（Leave-One-Patient-Out CV）可以对新患者的误差产生近似无偏的估计；为避免模型选择过程中的泄露，应在一个同样按患者进行划分的内循环中调整超参数（嵌套交叉验证）。**\n\n这个陈述正确地描述了两个先进且稳健的评估概念。\n1.  **留一患者交叉验证（LOPO-CV）**：这是分组k折交叉验证的一个特例，其中折数 $k$ 等于患者数 $P$。在每次迭代中，留出一个患者用于验证，模型在其余的 $P-1$ 个患者上进行训练。由于患者是独立同分布的，此过程为新患者的泛化误差提供了一个近似无偏的估计（尽管其方差可能很高）。\n2.  **用于超参数调优的嵌套交叉验证**：当使用交叉验证来选择超参数时，在相同数据上报告最佳模型的性能会导致乐观偏差，因为超参数对该特定数据划分“过拟合”了。为了获得对*整个建模流程*（包括超参数选择）性能的无偏估计，需要使用嵌套交叉验证。外循环划分患者用于最终误差估计。内循环仅在外循环的训练集上操作，执行另一次按患者的划分来选择最佳超参数。这确保了超参数选择过程永远不会看到外循环的验证数据，从而防止信息泄露。\n\n**结论：正确。**\n\n**选项 E：在补丁上训练CNN时，可以在划分数据集之前对整个数据集计算全局预处理统计数据（例如，用于强度归一化的均值和标准差），因为这些统计数据与标签无关，不会导致数据泄露。**\n\n这个陈述描述了一种微妙但明确的数据泄露形式。任何数据驱动的预处理步骤都必须专门在训练数据上“拟合”。如果像归一化的均值和标准差这样的统计数据是在整个数据集（训练集+验证集+测试集）上计算的，那么来自验证集和测试集的信息就已经“泄露”到了训练过程中。模型在经过缩放的数据上训练，而这种缩放是利用了它将要被评估的数据的属性。这违反了验证集应被视为未见数据的原则。虽然影响可能很小，但这违反了正确的协议，并可能导致乐观的性能估计。正确的程序是仅在训练折上计算均值和标准差，然后将这个固定的变换应用于验证折和测试折。声称这样做是“安全的”因为它是“与标签无关的”是错误的；泄露是关于信息，而不仅仅是标签。\n\n**结论：不正确。**", "answer": "$$\\boxed{AD}$$", "id": "4534196"}, {"introduction": "当我们训练出一个性能可靠的模型后，下一个关键问题是：“模型为什么会做出这样的预测？”这对于获得临床信任和进行模型调试至关重要。本练习介绍了梯度加权类激活映射（Grad-CAM），这是一种强大的可视化技术，可以揭示CNN在进行预测时关注图像的哪些部分。通过推导其公式并完成一个具体的计算示例，您将学会如何生成并解释这些“热图”，从而将CNN从一个“黑箱”转变为一个更透明的工具 [@problem_id:4534276]。", "problem": "考虑一个端到端的放射组学系统，其中一个三维卷积神经网络（CNN）被训练来从输入的体积图像块预测目标临床终点的标量 pre-softmax 类别分数 $y$。设最后的卷积块输出 $K$ 个特征图 $\\{A^{k}\\}_{k=1}^{K}$，其中每个 $A^{k}$ 由空间坐标 $(i,j,l)$ 索引，维度为 $I \\times J \\times L$。定义 $Z = I \\cdot J \\cdot L$。梯度加权类激活映射（Grad-CAM）方法根据 $y$ 对特征图的偏导数，为每个通道分配一个重要性权重，并生成一个空间热图，其正值表示对预测有积极贡献的区域。\n\n从微分的链式法则和 $y$ 关于激活值 $\\{A^{k}\\}$ 的一阶泰勒展开出发，推导 Grad-CAM 热图的闭式表达式，该表达式应使用特征图 $\\{A^{k}\\}$ 和一个通过对偏导数 $\\frac{\\partial y}{\\partial A^{k}_{i,j,l}}$ 在空间索引 $(i,j,l)$ 上进行全局平均而构建的通道级标量权重来表示。请论证使用整流非线性来仅保留最终热图中具有正贡献区域的合理性。你的推导应基于关于反向传播和 CNN 中激活重要性的经过充分检验的事实，而不预设任何最终公式。\n\n然后，对于一个代表体积放射组学 CNN 的特定案例，设 $K = 2$，$I = 2$，$J = 2$，且 $L = 1$，因此 $Z = 4$。假设特征图为\n$$\nA^{1} = \\begin{pmatrix}\n1  -2 \\\\\n0  3\n\\end{pmatrix}, \\quad\nA^{2} = \\begin{pmatrix}\n-1  2 \\\\\n1  -2\n\\end{pmatrix},\n$$\n由 $(i,j,l)$ 索引，其中所有条目的 $l=1$，且 pre-softmax 分数 $y$ 对激活值的偏导数为\n$$\n\\frac{\\partial y}{\\partial A^{1}} = \\begin{pmatrix}\n4  -1 \\\\\n2  0\n\\end{pmatrix}, \\quad\n\\frac{\\partial y}{\\partial A^{2}} = \\begin{pmatrix}\n-2  1 \\\\\n-1  2\n\\end{pmatrix}.\n$$\n计算在体素 $(i,j,l) = (1,1,1)$ 处，由全局平均的通道权重和整流非线性产生的 Grad-CAM 热图值。请以精确数值形式给出最终答案，不要四舍五入。\n\n最后，解释在体积放射组学的背景下，选择提取特征图 $\\{A^{k}\\}$ 的卷积层如何影响最终生成的 Grad-CAM 热图，需论及分辨率、语义特异性和梯度可靠性。你的解释应具有科学依据且自洽，但最终答案必须是上面所要求的单一数值，不带单位。", "solution": "该问题陈述被认为是有效的。它在科学上基于深度学习和模型可解释性的原理，特别是梯度加权类激活映射（Grad-CAM）方法。该问题定义明确，为计算唯一解提供了所有必要的定义和数值数据。语言客观，设定内部一致且可形式化。\n\n我们的任务是推导 Grad-CAM 热图的表达式，然后计算其在特定情况下的值。推导必须源于应用于神经网络的微积分基本原理。\n\n首先，我们推导 Grad-CAM 热图的一般形式。pre-softmax 类别分数 $y$ 是最后一个卷积层特征图 $\\{A^{k}\\}_{k=1}^{K}$ 中激活值的标量函数。在特征图 $k$ 中，体素 $(i,j,l)$ 处的特定激活值 $A^{k}_{i,j,l}$ 对分数 $y$ 的影响由偏导数 $\\frac{\\partial y}{\\partial A^{k}_{i,j,l}}$ 捕获。此梯度通过反向传播计算。\n\n$y$ 在一个基线（例如，零激活值）附近的一阶泰勒展开将分数近似为激活值的线性函数，其中梯度作为系数：\n$$ y \\approx y_0 + \\sum_{k=1}^{K} \\sum_{i=1}^{I} \\sum_{j=1}^{J} \\sum_{l=1}^{L} \\frac{\\partial y}{\\partial A^{k}_{i,j,l}} A^{k}_{i,j,l} $$\nGrad-CAM 通过首先确定整个特征图（或通道）$k$ 的“重要性”来简化这种高维关系。这是通过将空间梯度信息压缩为单个标量权重 $\\alpha_k$ 来实现的。根据问题规定，该权重是通过对该通道的梯度执行全局平均池化来获得的：\n$$ \\alpha_k = \\frac{1}{Z} \\sum_{i=1}^{I} \\sum_{j=1}^{J} \\sum_{l=1}^{L} \\frac{\\partial y}{\\partial A^{k}_{i,j,l}} $$\n此处，$Z = I \\cdot J \\cdot L$ 是一个特征图中的空间位置（体素）总数。这个权重 $\\alpha_k$ 表示通道 $k$ 每单位激活对分数 $y$ 的平均贡献。\n\n然后，Grad-CAM 热图 $L_{\\text{Grad-CAM}}$ 被构造为特征图的加权线性组合，其中的权重是刚刚定义的 $\\alpha_k$ 值。这个中间“原始”热图在特定体素 $(i,j,l)$ 处的值是：\n$$ L_{\\text{raw}}(i,j,l) = \\sum_{k=1}^{K} \\alpha_k A^{k}_{i,j,l} $$\n该表达式将通道重要性 $\\alpha_k$ 所捕获的高级语义信息定位到由特征图 $A^k$ 定义的空间网格上。$L_{\\text{raw}}$ 中的高正值表示对应的体素在对类别分数 $y$ 有强正向影响的特征图中被强烈激活。\n\n最后，问题指出应用了整流非线性以仅保留有正贡献的区域。这对应于应用一个整流线性单元（ReLU）函数，它将所有负值设为零。因此，最终的 Grad-CAM 热图是：\n$$ L_{\\text{Grad-CAM}}(i,j,l) = \\text{ReLU}(L_{\\text{raw}}(i,j,l)) = \\max(0, L_{\\text{raw}}(i,j,l)) $$\n这一步骤的理由是，我们通常感兴趣的是可视化输入的哪些部分为感兴趣的类别提供了积极的证据。$L_{\\text{raw}}$ 中的负值可能含糊不清，可能来自于负权重通道中的正激活，也可能来自于正权重通道中的负激活。通过将这些值过滤掉，生成的热图仅突出显示支持预测的区域。\n\n现在，我们将此推导应用于提供的具体案例。\n给定条件如下：\n- 通道数：$K=2$。\n- 特征图维度：$I=2$, $J=2$, $L=1$。\n- 每个图的体素总数：$Z = I \\cdot J \\cdot L = 2 \\cdot 2 \\cdot 1 = 4$。\n- 特征图：\n$$ A^{1} = \\begin{pmatrix} 1  -2 \\\\ 0  3 \\end{pmatrix}, \\quad A^{2} = \\begin{pmatrix} -1  2 \\\\ 1  -2 \\end{pmatrix} $$\n- 分数相对于特征图的梯度：\n$$ \\frac{\\partial y}{\\partial A^{1}} = \\begin{pmatrix} 4  -1 \\\\ 2  0 \\end{pmatrix}, \\quad \\frac{\\partial y}{\\partial A^{2}} = \\begin{pmatrix} -2  1 \\\\ -1  2 \\end{pmatrix} $$\n\n首先，我们计算通道重要性权重 $\\alpha_1$ 和 $\\alpha_2$。\n对于通道 $k=1$：\n$$ \\alpha_1 = \\frac{1}{4} \\sum_{i,j,l} \\frac{\\partial y}{\\partial A^{1}_{i,j,l}} = \\frac{1}{4} (4 + (-1) + 2 + 0) = \\frac{5}{4} $$\n对于通道 $k=2$：\n$$ \\alpha_2 = \\frac{1}{4} \\sum_{i,j,l} \\frac{\\partial y}{\\partial A^{2}_{i,j,l}} = \\frac{1}{4} ((-2) + 1 + (-1) + 2) = \\frac{0}{4} = 0 $$\n\n接下来，我们计算指定体素 $(i,j,l) = (1,1,1)$ 处的原始热图值 $L_{\\text{raw}}$。这对应于给定矩阵中第一行第一列的元素（假设 $i$ 和 $j$ 是基于 1 的索引，并且 $l=1$ 是隐含的）。\n根据给定的矩阵，在 $(1,1,1)$ 处的激活值为：\n- $A^{1}_{1,1,1} = 1$\n- $A^{2}_{1,1,1} = -1$\n\n原始热图值为：\n$$ L_{\\text{raw}}(1,1,1) = \\alpha_1 A^{1}_{1,1,1} + \\alpha_2 A^{2}_{1,1,1} = \\left(\\frac{5}{4}\\right)(1) + (0)(-1) = \\frac{5}{4} $$\n\n最后，我们应用 ReLU 函数得到最终的 Grad-CAM 值：\n$$ L_{\\text{Grad-CAM}}(1,1,1) = \\text{ReLU}\\left(\\frac{5}{4}\\right) = \\max\\left(0, \\frac{5}{4}\\right) = \\frac{5}{4} $$\nGrad-CAM 热图在体素 $(1,1,1)$ 处的值是 $\\frac{5}{4}$。\n\n关于卷积层的选择，空间分辨率和语义特异性之间存在一个根本性的权衡。\n- **更深的层（靠近输出）：** 由于重复的下采样（例如，池化、带步长的卷积），这些层的特征图空间分辨率较低。然而，它们捕获了与临床终点高度相关的高级、复杂的语义特征（例如，肿瘤纹理、器官形态）。从深层生成的 Grad-CAM 热图会比较粗糙，但具有很高的类别区分能力，能有效定位网络学到的抽象概念。这些层的梯度通常更“干净”，因为它们更接近损失函数。\n- **更浅的层（靠近输入）：** 这些层具有高空间分辨率，保留了输入图像的精细细节。然而，它们捕获的是边缘、角点和简单纹理等低级特征，这些特征的语义不够丰富。从浅层生成的热图在位置上会很详细和精确，但可能会突出显示与感兴趣类别不特定的特征（例如，突出显示所有边缘，而不仅仅是病灶的边缘）。\n在体积放射组学的背景下，热图最常从最后的卷积层生成。这是因为主要目标是理解网络编码的哪些高级放射组学模式正在驱动预测。为了获得对模型决策过程的更优越的语义洞察，空间分辨率的损失是一个可接受的权衡。", "answer": "$$\\boxed{\\frac{5}{4}}$$", "id": "4534276"}]}