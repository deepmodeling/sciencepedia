{"hands_on_practices": [{"introduction": "AUC 不仅仅是 ROC 曲线下的几何面积，它还有一个深刻的概率解释。这个练习旨在通过编程实践，经验性地验证 AUC 等同于模型将随机选择的正样本得分排在随机选择的负样本得分之前的概率。通过从两个不同角度计算并比较结果，你可以加深对 AUC 核心含义的直观理解。[@problem_id:3167097]", "problem": "构建一个独立的程序，针对几个指定的测试用例，比较由二元分类分数派生出的两个经验计算量：受试者工作特征（ROC）曲线的几何曲线下面积，以及正例与负例之间的直接成对超越概率。此任务的基本依据是受试者工作特征（ROC）曲线及其曲线下面积（AUC）的定义，以及将概率定义为相对频率的极限。您必须严格遵循这些核心定义进行操作。\n\n设一个二元分类问题由应用于实例的实值分数函数 $S:\\mathbb{R}^d\\to\\mathbb{R}$ 表示，其实际标签为 $Y\\in\\{0,1\\}$，其中 $Y=1$ 表示正类，$Y=0$ 表示负类。对于任意阈值 $t\\in\\mathbb{R}$，将真阳性率（TPR）和假阳性率（FPR）定义为\n$$\n\\mathrm{TPR}(t) = \\frac{\\#\\{i:\\,Y_i=1,\\,S_i\\ge t\\}}{\\#\\{i:\\,Y_i=1\\}},\\quad\n\\mathrm{FPR}(t) = \\frac{\\#\\{i:\\,Y_i=0,\\,S_i\\ge t\\}}{\\#\\{i:\\,Y_i=0\\}}.\n$$\n受试者工作特征（ROC）曲线是当 $t$ 在所有可能的阈值上变化时，所描绘出的参数曲线 $\\big(\\mathrm{FPR}(t),\\mathrm{TPR}(t)\\big)$。曲线下面积（AUC）被定义为 TPR 对 FPR 在此曲线上的黎曼积分：\n$$\n\\mathrm{AUC} = \\int \\mathrm{TPR}\\,d(\\mathrm{FPR}),\n$$\n在几何上解释为单位正方形内ROC曲线下方的面积。\n\n独立地，考虑通过分别根据正例和负例分数的经验分布抽样一个正例和一个负例而获得的两个随机分数 $S^+$ 和 $S^-$。将直接成对超越概率定义为\n$$\np_{} = \\mathbb{P}\\big(S^+  S^-\\big),\n$$\n并将经平局调整的超越概率定义为\n$$\np_{\\text{half}} = \\mathbb{P}\\big(S^+  S^-\\big) + \\frac{1}{2}\\,\\mathbb{P}\\big(S^+ = S^-\\big).\n$$\n您的程序必须使用梯形法则，根据ROC定义对经验ROC点进行积分，从而凭经验估计 $\\mathrm{AUC}$，并通过计算所有正负分数对来独立地估计 $p_{}$ 和 $p_{\\text{half}}$。然后，对于每个测试用例，计算两个浮点数：绝对差 $|\\mathrm{AUC} - p_{}|$ 和绝对差 $|\\mathrm{AUC} - p_{\\text{half}}|$。\n\n实现要求：\n- 对于每个测试用例，根据指定的分布和参数生成正例分数和负例分数，使用固定的随机种子 $42$ 以确保可复现性。\n- 通过以下方式计算 $\\mathrm{AUC}$：\n  - 将所有分数按降序排序。\n  - 在每个唯一的分数值处扫描阈值，以构建经验ROC点 $\\big(\\mathrm{FPR},\\mathrm{TPR}\\big)$。\n  - 通过在这些点上（包括端点 $(0,0)$ 和 $(1,1)$）使用梯形法则，对 $\\mathrm{TPR}$ 关于 $\\mathrm{FPR}$ 进行积分。\n- 通过计算所有正负分数对来计算 $p_{}$ 和 $p_{\\text{half}}$：\n  - 对于 $p_{}$：计算严格大于的比较次数。\n  - 对于 $p_{\\text{half}}$：对于平局（分数相等）的情况，加上一半的计分。\n\n测试套件：\n- 用例 $1$（连续，中度分离）：正例分数 $S^+$ 从均值为 $\\mu_+=1$、标准差为 $\\sigma_+=1$ 的正态分布中抽样；负例分数 $S^-$ 从均值为 $\\mu_-=0$、标准差为 $\\sigma_-=1$ 的正态分布中抽样；样本量 $n^+=1000$，$n^-=1000$。\n- 用例 $2$（连续，分布相同）：$S^+$ 和 $S^-$ 均来自均值为 $\\mu=0$、标准差为 $\\sigma=1$ 的正态分布；$n^+=2000$，$n^-=2000$。\n- 用例 $3$（连续，强分离）：$S^+$ 来自均值为 $\\mu_+=3$、标准差为 $\\sigma_+=0.5$ 的正态分布；$S^-$ 来自均值为 $\\mu_-=0$、标准差为 $\\sigma_-=0.5$ 的正态分布；$n^+=1000$，$n^-=1000$。\n- 用例 $4$（离散，有平局）：$S^+$ 来自成功概率为 $p_+=0.6$ 的伯努利分布；$S^-$ 来自成功概率为 $p_-=0.4$ 的伯努利分布；$n^+=5000$，$n^-=5000$。\n- 用例 $5$（连续，小样本，边界方差）：$S^+$ 来自均值为 $\\mu_+=0.2$、标准差为 $\\sigma_+=1$ 的正态分布；$S^-$ 来自均值为 $\\mu_-=0$、标准差为 $\\sigma_-=1$ 的正态分布；$n^+=10$，$n^-=10$。\n- 用例 $6$（连续，偏态分布）：$S^+$ 来自率为 $\\lambda_+=1$（尺度参数 $1/\\lambda_+=1$）的指数分布；$S^-$ 来自率为 $\\lambda_-=2$（尺度参数 $1/\\lambda_-=0.5$）的指数分布；$n^+=2000$，$n^-=2000$。\n\n最终输出格式：\n- 您的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表。该列表必须按以下顺序排列\n$$\n[\\Delta_1^{},\\Delta_1^{\\text{half}},\\Delta_2^{},\\Delta_2^{\\text{half}},\\dots,\\Delta_6^{},\\Delta_6^{\\text{half}}],\n$$\n其中对于用例 $k$，$\\Delta_k^{}=|\\mathrm{AUC}-p_{}|$ 且 $\\Delta_k^{\\text{half}}=|\\mathrm{AUC}-p_{\\text{half}}|$。每个浮点数应四舍五入到 $6$ 位小数。", "solution": "用户提供了一个科学上和数学上都合理的问题。我现在将着手解决。\n\n### 第一步：问题验证\n\n**1.1. 提取给定信息**\n\n*   **问题领域**：二元分类、受试者工作特征（ROC）曲线、曲线下面积（AUC）。\n*   **定义**：\n    *   正类标签 $Y=1$，负类标签 $Y=0$。\n    *   分数函数 $S:\\mathbb{R}^d\\to\\mathbb{R}$。\n    *   真阳性率：$\\mathrm{TPR}(t) = \\frac{\\#\\{i:\\,Y_i=1,\\,S_i\\ge t\\}}{\\#\\{i:\\,Y_i=1\\}}$。\n    *   假阳性率：$\\mathrm{FPR}(t) = \\frac{\\#\\{i:\\,Y_i=0,\\,S_i\\ge t\\}}{\\#\\{i:\\,Y_i=0\\}}$。\n    *   ROC曲线：当 $t$ 变化时形成的参数曲线 $(\\mathrm{FPR}(t),\\mathrm{TPR}(t))$。\n    *   AUC：$\\mathrm{AUC} = \\int \\mathrm{TPR}\\,d(\\mathrm{FPR})$，解释为ROC曲线下的面积。\n    *   直接成对超越概率：$p_{} = \\mathbb{P}(S^+  S^-)$，其中 $S^+$ 和 $S^-$ 分别是从随机选择的正例和负例中获得的分数。\n    *   经平局调整的超越概率：$p_{\\text{half}} = \\mathbb{P}(S^+  S^-) + \\frac{1}{2}\\,\\mathbb{P}(S^+ = S^-)$。\n*   **计算要求**：\n    *   使用固定的随机种子 $42$。\n    *   通过在唯一分数处的阈值扫描构建经验ROC点，并使用梯形法则进行积分来估计 $\\mathrm{AUC}$。必须包括端点 $(0,0)$ 和 $(1,1)$。\n    *   通过枚举所有正负分数对并计数结果来估计 $p_{}$ 和 $p_{\\text{half}}$。\n*   **输出**：对于每个测试用例，计算两个绝对差：$\\Delta^{} = |\\mathrm{AUC} - p_{}|$ 和 $\\Delta^{\\text{half}} = |\\mathrm{AUC} - p_{\\text{half}}|$。最终输出必须是所有测试用例的这些差异的单个逗号分隔列表，每个值四舍五入到 $6$ 位小数。\n*   **测试用例**：\n    1.  $S^+ \\sim N(\\mu=1, \\sigma=1)$, $S^- \\sim N(\\mu=0, \\sigma=1)$; $n^+=1000, n^-=1000$。\n    2.  $S^+ \\sim N(\\mu=0, \\sigma=1)$, $S^- \\sim N(\\mu=0, \\sigma=1)$; $n^+=2000, n^-=2000$。\n    3.  $S^+ \\sim N(\\mu=3, \\sigma=0.5)$, $S^- \\sim N(\\mu=0, \\sigma=0.5)$; $n^+=1000, n^-=1000$。\n    4.  $S^+ \\sim \\text{Bernoulli}(p=0.6)$, $S^- \\sim \\text{Bernoulli}(p=0.4)$; $n^+=5000, n^-=5000$。\n    5.  $S^+ \\sim N(\\mu=0.2, \\sigma=1)$, $S^- \\sim N(\\mu=0, \\sigma=1)$; $n^+=10, n^-=10$。\n    6.  $S^+ \\sim \\text{Exponential}(\\lambda=1)$, $S^- \\sim \\text{Exponential}(\\lambda=2)$; $n^+=2000, n^-=2000$。\n\n**1.2. 验证与结论**\n\n根据验证标准对问题进行审查：\n*   **科学依据**：TPR、FPR、ROC和AUC的定义是统计学和机器学习中的标准定义。AUC与概率 $\\mathbb{P}(S^+  S^-)$（更准确地说是与 $p_{\\text{half}}$ 等价的Mann-Whitney U统计量）之间的关系是一个基本且已确立的定理。该问题要求使用指定的数值方法对该定理进行经验验证。所有概念在科学上都是合理的。\n*   **定义明确**：该问题定义明确。输入（分布和样本量）、计算过程（梯形法则、成对计数）和期望的输出都得到了明确的规定。使用固定的随机种子确保了唯一且可复现的解决方案。\n*   **客观性**：语言正式、精确，没有任何主观性或偏见。\n*   **完整且一致**：问题陈述是自洽的。它提供了所有必要的定义、数据生成参数和计算指令，没有矛盾之处。\n*   **可行性**：指定的样本量导致的计算量很大，但在现代硬件上完全可行（例如，$5000 \\times 5000 = 25 \\times 10^6$ 次成对比较）。\n\n**结论**：该问题是**有效的**。\n\n### 第二步：解决方案设计\n\n该任务要求实现两种不同的方法来量化正负分数分布之间的分离度，然后比较它们的结果。\n\n**2.1. 通过梯形法则计算AUC**\n\n经验ROC曲线是在不同分类阈值下评估的 $(\\mathrm{FPR}, \\mathrm{TPR})$ 对的图。一个关键的洞见是，ROC曲线是分段常数，并且仅在与观察到的分数值相对应的阈值处发生变化。构建曲线并计算其面积最直接的方法如下：\n\n1.  将所有正例分数（标记为 $1$）和负例分数（标记为 $0$）合并到一个 $(分数, 标签)$ 对的集合中。令 $n^+$ 为正例总数，$n^-$ 为负例总数。\n2.  根据分数按降序对这些对进行排序。如果分数出现平局，标签的顺序不会影响最终的AUC计算，因为它们将作为一个整体块进行处理。\n3.  用点 $(0,0)$ 初始化ROC曲线，该点对应于阈值 $t \\to \\infty$，此时没有任何实例被分类为正例。将真阳性计数（$TP$）和假阳性计数（$FP$）初始化为 $0$。\n4.  遍历排序后的对。对于每个对 $(s_i, y_i)$：\n    *   更新计数：如果 $y_i=1$，则增加 $TP$；如果 $y_i=0$，则增加 $FP$。\n    *   为了构建经验ROC点，我们仅在阈值有效改变时才添加新点。这发生在处理完具有相同值的一组分数之后。因此，我们检查当前分数 $s_i$ 是否与下一个分数 $s_{i+1}$ 不同（或者我们是否在列表的末尾）。\n    *   当发生这种变化时，ROC曲线上的一个新点由 $(\\frac{FP}{n^-}, \\frac{TP}{n^+})$ 定义。将此点添加到我们的ROC点列表中。\n5.  遍历完所有分数后，最终点将是 $(1,1)$。从 $(0,0)$ 开始生成的完整点列表定义了经验ROC曲线的顶点。\n6.  然后通过对这些顶点应用梯形法则来计算曲线下面积（AUC）。对于每对连续的点 $(x_i, y_i)$ 和 $(x_{i+1}, y_{i+1})$，其下方的梯形面积由 $\\frac{1}{2}(y_i + y_{i+1})(x_{i+1} - x_i)$ 给出。将所有线段的这些面积相加，即可得到总AUC。\n\n**2.2. 计算成对超越概率**\n\n概率 $p_{}$ 和 $p_{\\text{half}}$ 通过经验计数直接从其定义估计。\n\n1.  给定正例分数集 $\\{S^+_1, \\dots, S^+_{n^+}\\}$ 和负例分数集 $\\{S^-_1, \\dots, S^-_{n^-}\\}$，我们总共形成 $N = n^+ \\times n^-$ 个对。\n2.  初始化两个计数器：`greater_count = 0` 和 `equal_count = 0`。\n3.  遍历每个可能的对 $(S^+_i, S^-_j)$：\n    *   如果 $S^+_i  S^-_j$，则增加 `greater_count`。\n    *   如果 $S^+_i = S^-_j$，则增加 `equal_count`。\n4.  然后，经验概率计算如下：\n    *   $p_{} = \\frac{\\text{greater\\_count}}{N}$\n    *   $p_{\\text{half}} = \\frac{\\text{greater\\_count} + 0.5 \\times \\text{equal\\_count}}{N}$\n\n此方法在计算上等同于计算Mann-Whitney U统计量，该统计量已知与AUC相等。因此，该问题建立了一个对此统计定理的数值验证。\n\n**2.3. 程序实现**\n\n将构建一个Python程序，为六个测试用例中的每一个执行这些计算。\n*   将使用一个带有指定种子（$42$）的集中式随机数生成器（`numpy.random.default_rng`）以确保可复现性。\n*   将定义用于生成分数、计算AUC和计算成对概率的辅助函数，以确保代码的清晰度和模块化。\n*   主循环将遍历测试用例参数，调用辅助函数，计算所需的绝对差，并存储四舍五入后的结果。\n*   最后，程序将以指定格式打印收集到的结果。对于指数分布，我们注意到 `numpy` 库的 `exponential` 函数是按尺度参数 $\\beta$ 参数化的，该参数是率 $\\lambda$ 的倒数（即 $\\beta = 1/\\lambda$）。", "answer": "```python\nimport numpy as np\n\ndef calculate_auc(pos_scores, neg_scores):\n    \"\"\"\n    Computes the Area Under the ROC Curve using the trapezoidal rule.\n    \"\"\"\n    n_pos = len(pos_scores)\n    n_neg = len(neg_scores)\n    \n    if n_pos == 0 or n_neg == 0:\n        return 0.5\n\n    # Combine scores and labels, then sort by score descending.\n    labels = [1] * n_pos + [0] * n_neg\n    scores = list(pos_scores) + list(neg_scores)\n    \n    sorted_pairs = sorted(zip(scores, labels), key=lambda x: x[0], reverse=True)\n    \n    # Initialize ROC points starting at (0,0).\n    roc_points = [(0.0, 0.0)]\n    tp_count, fp_count = 0, 0\n    \n    # Iterate through sorted scores to define ROC curve vertices.\n    for i in range(len(sorted_pairs)):\n        score, label = sorted_pairs[i]\n        \n        if label == 1:\n            tp_count += 1\n        else:\n            fp_count += 1\n            \n        # A new vertex is formed when the score value changes, or at the end.\n        is_last_element = (i == len(sorted_pairs) - 1)\n        is_score_change = not is_last_element and (score != sorted_pairs[i+1][0])\n        \n        if is_last_element or is_score_change:\n            tpr = tp_count / n_pos\n            fpr = fp_count / n_neg\n            roc_points.append((fpr, tpr))\n            \n    # Calculate area using the trapezoidal rule.\n    auc = 0.0\n    for i in range(len(roc_points) - 1):\n        x1, y1 = roc_points[i]\n        x2, y2 = roc_points[i+1]\n        auc += (x2 - x1) * (y1 + y2) / 2.0\n        \n    return auc\n\ndef calculate_probabilities(pos_scores, neg_scores):\n    \"\"\"\n    Computes p_ and p_half by direct pairwise comparison.\n    \"\"\"\n    n_pos = len(pos_scores)\n    n_neg = len(neg_scores)\n    total_pairs = n_pos * n_neg\n\n    if total_pairs == 0:\n        return 0.5, 0.5\n\n    gt_count = 0\n    eq_count = 0\n\n    for s_pos in pos_scores:\n        for s_neg in neg_scores:\n            if s_pos  s_neg:\n                gt_count += 1\n            elif s_pos == s_neg:\n                eq_count += 1\n                \n    p_gt = gt_count / total_pairs\n    p_half = (gt_count + 0.5 * eq_count) / total_pairs\n    \n    return p_gt, p_half\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print results.\n    \"\"\"\n    rng = np.random.default_rng(seed=42)\n    \n    test_cases = [\n        {'type': 'normal', 'params_pos': {'loc': 1, 'scale': 1, 'size': 1000}, 'params_neg': {'loc': 0, 'scale': 1, 'size': 1000}},\n        {'type': 'normal', 'params_pos': {'loc': 0, 'scale': 1, 'size': 2000}, 'params_neg': {'loc': 0, 'scale': 1, 'size': 2000}},\n        {'type': 'normal', 'params_pos': {'loc': 3, 'scale': 0.5, 'size': 1000}, 'params_neg': {'loc': 0, 'scale': 0.5, 'size': 1000}},\n        {'type': 'bernoulli', 'params_pos': {'n': 1, 'p': 0.6, 'size': 5000}, 'params_neg': {'n': 1, 'p': 0.4, 'size': 5000}},\n        {'type': 'normal', 'params_pos': {'loc': 0.2, 'scale': 1, 'size': 10}, 'params_neg': {'loc': 0, 'scale': 1, 'size': 10}},\n        {'type': 'exponential', 'params_pos': {'scale': 1.0, 'size': 2000}, 'params_neg': {'scale': 0.5, 'size': 2000}} # rate=1/scale\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        if case['type'] == 'normal':\n            pos_scores = rng.normal(**case['params_pos'])\n            neg_scores = rng.normal(**case['params_neg'])\n        elif case['type'] == 'bernoulli':\n            pos_scores = rng.binomial(**case['params_pos'])\n            neg_scores = rng.binomial(**case['params_neg'])\n        elif case['type'] == 'exponential':\n            pos_scores = rng.exponential(**case['params_pos'])\n            neg_scores = rng.exponential(**case['params_neg'])\n\n        # 1. Compute AUC using the trapezoidal rule on the empirical ROC curve\n        auc = calculate_auc(pos_scores, neg_scores)\n        \n        # 2. Compute probabilities by pairwise counting\n        p_gt, p_half = calculate_probabilities(pos_scores, neg_scores)\n        \n        # 3. Calculate absolute differences\n        delta_gt = abs(auc - p_gt)\n        delta_half = abs(auc - p_half)\n        \n        results.append(round(delta_gt, 6))\n        results.append(round(delta_half, 6))\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3167097"}, {"introduction": "高 AUC 值常被误解为模型预测“准确”。实际上，AUC 主要衡量模型的 *区分度*（即排序能力），而非其预测概率的 *校准度*（即预测概率与真实频率的一致性）。这个练习通过构建两个极端但清晰的模型，让你亲手揭示这两者之间的差异，从而理解为何一个模型可以有完美的校准度但毫无区分能力，而另一个模型区分能力很强但校准度却很差。[@problem_id:4946999]", "problem": "一个体队列被划分为两个频率相等的协变量层，记为 $G \\in \\{L,H\\}$。结果 $Y \\in \\{0,1\\}$ 根据以下两种数据生成机制为每个个体独立生成，并定义了两个相应的预测器。\n\n模型A（已校准，无区分能力）：\n- 数据生成机制：$Y \\sim \\text{Bernoulli}(p)$，其中 $p=0.3$，且独立于 $G$。\n- 预测器：对所有个体，预测概率为 $\\hat{p}=0.3$。\n\n模型B（高区分能力，未校准）：\n- 数据生成机制：$Y \\mid (G=L) \\sim \\text{Bernoulli}(0.1)$ 且 $Y \\mid (G=H) \\sim \\text{Bernoulli}(0.9)$，其中 $\\mathbb{P}(G=L)=\\mathbb{P}(G=H)=\\frac{1}{2}$。\n- 预测器：对所有 $G=L$ 的个体，预测概率为 $\\hat{p}=0.01$；对所有 $G=H$ 的个体，预测概率为 $\\hat{p}=0.99$。\n\n仅使用基本定义，计算：\n1. 模型A的受试者工作特征（ROC）曲线下面积（AUC）。\n2. 模型B的ROC曲线下面积（AUC）。\n3. 模型B的校准斜率，定义为在logit尺度上通过两个校准点 $\\big(\\text{logit}(\\hat{p}),\\text{logit}(\\text{观测事件率})\\big)$ 的直线的斜率 $m$，即点 $\\big(\\text{logit}(0.01),\\text{logit}(0.1)\\big)$ 和点 $\\big(\\text{logit}(0.99),\\text{logit}(0.9)\\big)$。\n\n以有序三元组 $\\big(\\text{AUC}_{A},\\text{AUC}_{B},m\\big)$ 的形式报告你的最终答案。无需四舍五入。使用自然对数 $\\ln(\\cdot)$ 表示对数。", "solution": "首先验证问题陈述的科学性、一致性和完整性。\n\n### 步骤1：提取已知条件\n问题提供了以下信息：\n- 两个频率相等的协变量层：$G \\in \\{L,H\\}$，且 $\\mathbb{P}(G=L) = \\mathbb{P}(G=H) = \\frac{1}{2}$。\n- 结果变量：$Y \\in \\{0,1\\}$，为每个个体独立生成。\n\n**模型A：**\n- 数据生成机制：$Y \\sim \\text{Bernoulli}(p)$，其中 $p=0.3$，且独立于 $G$。\n- 预测器：对所有个体，预测概率为 $\\hat{p}=0.3$。\n\n**模型B：**\n- 数据生成机制：$Y \\mid (G=L) \\sim \\text{Bernoulli}(0.1)$ 且 $Y \\mid (G=H) \\sim \\text{Bernoulli}(0.9)$。\n- 预测器：对 $G=L$ 层的个体，$\\hat{p}=0.01$。对 $G=H$ 层的个体，$\\hat{p}=0.99$。\n\n**任务：**\n1. 计算模型A的曲线下面积（AUC），记为 $\\text{AUC}_A$。\n2. 计算模型B的AUC，记为 $\\text{AUC}_B$。\n3. 计算模型B的校准斜率 $m$，定义为通过点 $\\big(\\text{logit}(0.01),\\text{logit}(0.1)\\big)$ 和点 $\\big(\\text{logit}(0.99),\\text{logit}(0.9)\\big)$ 的直线的斜率。logit函数使用自然对数 $\\ln(\\cdot)$ 定义。\n\n### 步骤2：使用提取的已知条件进行验证\n根据验证标准评估该问题。\n- **科学依据**：该问题使用了生物统计学中标准的、明确定义的概念，包括伯努利分布、受试者工作特征（ROC）曲线、曲线下面积（AUC）和模型校准。所提出的模型是简化的但连贯的统计结构，用于说明这些概念。该问题在科学上是合理的。\n- **适定性**：所有必要的数据和定义均已提供。任务是具体的、数学的，能够导出一个唯一且有意义的解。问题是自洽且明确的。\n- **客观性**：问题使用正式、精确的语言陈述，不含任何主观或基于观点的内容。\n\n该问题没有表现出科学上不合理、不完整、矛盾或模棱两可等任何缺陷。\n\n### 步骤3：结论与行动\n该问题被判定为**有效**。将提供一个完整的、带推理过程的解答。\n\n### 解答\n\n**1. 模型A的$\\text{AUC}_A$计算**\n\n受试者工作特征（ROC）曲线下面积（AUC）有一个标准的概率解释：它是一个随机选择的发生事件（$Y=1$）的个体比一个随机选择的未发生事件（$Y=0$）的个体具有更高预测风险评分的概率。如果评分可能出现平局，则AUC由以下公式给出：\n$$ \\text{AUC} = \\mathbb{P}(S_1  S_0) + \\frac{1}{2}\\mathbb{P}(S_1 = S_0) $$\n其中 $S_1$ 是 $Y=1$ 的随机个体的评分，$S_0$ 是 $Y=0$ 的随机个体的评分。\n\n在模型A中，预测器为每个个体分配相同的评分 $\\hat{p}=0.3$，无论其协变量层或真实结果如何。因此，对于任意一对个体，一个 $Y=1$ 和一个 $Y=0$，他们的评分都将是 $S_1 = 0.3$ 和 $S_0 = 0.3$。\n\n因此：\n- 阳性病例的评分严格大于阴性病例评分的概率为零：$\\mathbb{P}(S_1  S_0) = 0$。\n- 他们的评分相等的概率为一：$\\mathbb{P}(S_1 = S_0) = 1$。\n\n将这些值代入AUC公式：\n$$ \\text{AUC}_A = 0 + \\frac{1}{2}(1) = \\frac{1}{2} = 0.5 $$\nAUC为$0.5$表明该模型没有区分能力，这是预料之中的，因为预测器是一个恒定值。该模型的ROC曲线是从$(0,0)$到$(1,1)$的对角线。\n\n**2. 模型B的$\\text{AUC}_B$计算**\n\n我们再次使用AUC的概率定义。在模型B中，评分 $\\hat{p}$ 可以取两个值：对于 $G=L$ 层的个体为 $0.01$，对于 $G=H$ 层的个体为 $0.99$。我们需要基于结果 $Y$ 的评分条件分布。\n\n首先，我们计算事件 $Y=1$ 的总体发生率：\n$$ \\mathbb{P}(Y=1) = \\mathbb{P}(Y=1|G=L)\\mathbb{P}(G=L) + \\mathbb{P}(Y=1|G=H)\\mathbb{P}(G=H) $$\n$$ \\mathbb{P}(Y=1) = (0.1)\\left(\\frac{1}{2}\\right) + (0.9)\\left(\\frac{1}{2}\\right) = 0.05 + 0.45 = 0.5 $$\n未发生事件的发生率为 $\\mathbb{P}(Y=0) = 1 - \\mathbb{P}(Y=1) = 0.5$。\n\n接下来，我们找到发生事件（$Y=1$）的个体的评分分布。评分为 $\\hat{p}=S_1$。\n$$ \\mathbb{P}(S_1=0.99) = \\mathbb{P}(G=H | Y=1) = \\frac{\\mathbb{P}(Y=1|G=H)\\mathbb{P}(G=H)}{\\mathbb{P}(Y=1)} = \\frac{(0.9)(\\frac{1}{2})}{0.5} = 0.9 $$\n$$ \\mathbb{P}(S_1=0.01) = \\mathbb{P}(G=L | Y=1) = 1 - \\mathbb{P}(S_1=0.99) = 1 - 0.9 = 0.1 $$\n\n然后，我们找到未发生事件（$Y=0$）的个体的评分分布。评分为 $\\hat{p}=S_0$。\n$$ \\mathbb{P}(S_0=0.01) = \\mathbb{P}(G=L | Y=0) = \\frac{\\mathbb{P}(Y=0|G=L)\\mathbb{P}(G=L)}{\\mathbb{P}(Y=0)} = \\frac{(1-0.1)(\\frac{1}{2})}{0.5} = \\frac{(0.9)(\\frac{1}{2})}{0.5} = 0.9 $$\n$$ \\mathbb{P}(S_0=0.99) = \\mathbb{P}(G=H | Y=0) = 1 - \\mathbb{P}(S_0=0.01) = 1 - 0.9 = 0.1 $$\n\n现在我们计算AUC公式的各项。个体是独立选择的。\n$$ \\mathbb{P}(S_1  S_0) = \\mathbb{P}(S_1=0.99 \\text{ and } S_0=0.01) = \\mathbb{P}(S_1=0.99)\\mathbb{P}(S_0=0.01) = (0.9)(0.9) = 0.81 $$\n$$ \\mathbb{P}(S_1 = S_0) = \\mathbb{P}(S_1=0.99, S_0=0.99) + \\mathbb{P}(S_1=0.01, S_0=0.01) $$\n$$ \\mathbb{P}(S_1 = S_0) = \\mathbb{P}(S_1=0.99)\\mathbb{P}(S_0=0.99) + \\mathbb{P}(S_1=0.01)\\mathbb{P}(S_0=0.01) = (0.9)(0.1) + (0.1)(0.9) = 0.09 + 0.09 = 0.18 $$\n\n最后，我们计算$\\text{AUC}_B$：\n$$ \\text{AUC}_B = \\mathbb{P}(S_1  S_0) + \\frac{1}{2}\\mathbb{P}(S_1 = S_0) = 0.81 + \\frac{1}{2}(0.18) = 0.81 + 0.09 = 0.9 $$\n这个高AUC值反映了模型在区分将要发生事件和不会发生事件的个体方面的强大能力。\n\n**3. 模型B的校准斜率 $m$ 的计算**\n\n校准斜率 $m$ 定义为在logit变换尺度上通过两个指定点 $(x_1, y_1)$ 和 $(x_2, y_2)$ 的直线的斜率。\nlogit函数为 $\\text{logit}(p) = \\ln\\left(\\frac{p}{1-p}\\right)$。\n\n给定的两个点是：\n- 点 1: $(x_1, y_1) = \\big(\\text{logit}(0.01), \\text{logit}(0.1)\\big)$\n- 点 2: $(x_2, y_2) = \\big(\\text{logit}(0.99), \\text{logit}(0.9)\\big)$\n\n我们计算坐标：\n$x_1 = \\text{logit}(0.01) = \\ln\\left(\\frac{0.01}{1-0.01}\\right) = \\ln\\left(\\frac{0.01}{0.99}\\right) = \\ln\\left(\\frac{1}{99}\\right) = -\\ln(99)$\n$y_1 = \\text{logit}(0.1) = \\ln\\left(\\frac{0.1}{1-0.1}\\right) = \\ln\\left(\\frac{0.1}{0.9}\\right) = \\ln\\left(\\frac{1}{9}\\right) = -\\ln(9)$\n$x_2 = \\text{logit}(0.99) = \\ln\\left(\\frac{0.99}{1-0.99}\\right) = \\ln\\left(\\frac{0.99}{0.01}\\right) = \\ln(99)$\n$y_2 = \\text{logit}(0.9) = \\ln\\left(\\frac{0.9}{1-0.9}\\right) = \\ln\\left(\\frac{0.9}{0.1}\\right) = \\ln(9)$\n\n斜率 $m$ 计算如下 $m = \\frac{y_2 - y_1}{x_2 - x_1}$：\n$$ m = \\frac{\\ln(9) - (-\\ln(9))}{\\ln(99) - (-\\ln(99))} = \\frac{2\\ln(9)}{2\\ln(99)} = \\frac{\\ln(9)}{\\ln(99)} $$\n根据要求，结果以其精确的符号形式保留。\n\n最终的有序三元组是 $(\\text{AUC}_{A}, \\text{AUC}_{B}, m) = \\left(0.5, 0.9, \\frac{\\ln(9)}{\\ln(99)}\\right)$。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n0.5  0.9  \\frac{\\ln(9)}{\\ln(99)}\n\\end{pmatrix}\n}\n$$", "id": "4946999"}, {"introduction": "ROC 曲线和 AUC 的一个显著特点是它们对类别不平衡（如疾病患病率）不敏感，但这既是优点也是潜在的陷阱。本练习将向你展示，即使两个分类器具有完全相同的 ROC 曲线，当它们应用于不同患病率的人群时，其精确率-召回率（PR）曲线和实际临床效用可能截然不同。通过计算这一差异，你将学会在评估模型性能时考虑应用场景和选择恰当指标的重要性。[@problem_id:4946956]", "problem": "一项生物医学筛查测试输出一个连续的风险评分，通过将该评分与一个阈值进行比较来做出决策。对于跨越整个评分范围的阈值，该测试的受试者工作特征（ROC）曲线——真阳性率对假阳性率——可以通过召回率 $t \\in [0,1]$（召回率等于真阳性率）进行参数化，其假阳性率函数 $f(t)$ 是一个分段线性函数：\n$$\nf(t) \\;=\\;\n\\begin{cases}\n0.1\\,t,  0 \\le t \\le 0.4, \\\\\n0.65\\,t - 0.22,  0.4  t \\le 0.8, \\\\\n3.5\\,t - 2.5,  0.8  t \\le 1.\n\\end{cases}\n$$\n两个分类系统 $\\mathcal{C}_A$ 和 $\\mathcal{C}_B$ 被部署在两个独立的临床队列中。它们共享由上述ROC曲线所捕捉到的相同判别能力（因此它们具有相同的ROC曲线），但两个队列的疾病患病率不同：对于 $\\mathcal{C}_A$，患病率为 $\\pi_A = 0.1$；对于 $\\mathcal{C}_B$，患病率为 $\\pi_B = 0.4$。\n\n仅使用基本定义——患病率 $\\pi$ 为真实患病个体的比例，真阳性率 $TPR = TP/P$，假阳性率 $FPR = FP/N$，召回率 $r = TPR$，以及精确率 $p = TP/(TP + FP)$——为每个队列构建由ROC函数 $f(t)$ 所蕴含的精确率-召回率（PR）曲线，并通过将精确率对召回率 $t$ 从 $0$ 到 $1$ 进行积分，计算每个队列的平均精确率（精确率-召回率曲线下的面积）。然后，计算两个队列之间平均精确率的差异，\n$$\n\\Delta \\;=\\; AP(\\pi_B) \\;-\\; AP(\\pi_A).\n$$\n将您的最终答案 $\\Delta$ 四舍五入到四位有效数字。以小数形式表示您的答案（不要使用百分号）。", "solution": "我们从定义开始。设总人口归一化为 $1$。那么，真实阳性个体的数量为 $P = \\pi$，真实阴性个体的数量为 $N = 1 - \\pi$。在给定的召回率水平 $t \\in [0,1]$下，真阳性（TP）的数量为 $TP = P \\cdot TPR = \\pi \\, t$，假阳性（FP）的数量为 $FP = N \\cdot FPR = (1-\\pi)\\, f(t)$，其中 $f(t)$ 是根据给定ROC参数化表示的作为召回率函数的假阳性率。\n\n在召回率为 $t$ 时的精确率 $p$ 定义为 $p = TP/(TP + FP)$，代入可得\n$$\np(t;\\pi) \\;=\\; \\frac{\\pi \\, t}{\\pi \\, t + (1-\\pi)\\, f(t)}.\n$$\n平均精确率 $AP(\\pi)$ 是精确率-召回率曲线下的面积，此处定义为\n$$\nAP(\\pi) \\;=\\; \\int_{0}^{1} p(t;\\pi)\\, dt \\;=\\; \\int_{0}^{1} \\frac{\\pi \\, t}{\\pi \\, t + (1-\\pi)\\, f(t)} \\, dt.\n$$\n由于 $f(t)$ 是分段线性的，我们对每个分段分别计算积分然后求和。\n\n在一个分段上，记 $f(t) = m\\,t + c$；那么被积函数变为\n$$\n\\frac{\\pi \\, t}{\\pi \\, t + (1-\\pi)\\,(m\\,t + c)} \\;=\\; \\frac{\\pi \\, t}{\\alpha \\, t + \\beta},\n$$\n其中 $\\alpha = \\pi + (1-\\pi)\\, m$ 且 $\\beta = (1-\\pi)\\, c$。注意到以下事实可以得到其不定积分\n$$\n\\int \\frac{t}{\\alpha\\, t + \\beta}\\, dt \\;=\\; \\frac{t}{\\alpha} \\;-\\; \\frac{\\beta}{\\alpha^{2}} \\ln(\\alpha\\, t + \\beta) \\;+\\; C.\n$$\n因此，在任何分段 $[a,b]$ 上，\n$$\n\\int_{a}^{b} \\frac{\\pi \\, t}{\\alpha \\, t + \\beta}\\, dt \\;=\\; \\pi \\left[ \\frac{t}{\\alpha} - \\frac{\\beta}{\\alpha^{2}} \\ln(\\alpha \\, t + \\beta) \\right]_{t=a}^{t=b}.\n$$\n\n现在我们将此应用于两种患病率下的三个分段中的每一个。\n\n分段1：$t \\in [0,0.4]$，$f(t) = 0.1\\, t$，所以 $m = 0.1$，$c = 0$。那么 $\\alpha_{1} = \\pi + (1-\\pi)\\, 0.1 = 0.1 + 0.9\\, \\pi$ 且 $\\beta_{1} = 0$。积分简化为\n$$\nI_{1}(\\pi) \\;=\\; \\int_{0}^{0.4} \\frac{\\pi \\, t}{\\alpha_{1} \\, t}\\, dt \\;=\\; \\int_{0}^{0.4} \\frac{\\pi}{\\alpha_{1}}\\, dt \\;=\\; \\frac{0.4 \\, \\pi}{0.1 + 0.9\\, \\pi}.\n$$\n因此，\n- 对于 $\\pi_A = 0.1$：$I_{1}(\\pi_A) = \\frac{0.4 \\cdot 0.1}{0.1 + 0.9 \\cdot 0.1} = \\frac{0.04}{0.19} = \\frac{4}{19} \\approx 0.210526315789$。\n- 对于 $\\pi_B = 0.4$：$I_{1}(\\pi_B) = \\frac{0.4 \\cdot 0.4}{0.1 + 0.9 \\cdot 0.4} = \\frac{0.16}{0.46} = \\frac{8}{23} \\approx 0.347826086957$。\n\n分段2：$t \\in [0.4,0.8]$，$f(t) = 0.65\\, t - 0.22$，所以 $m = 0.65$，$c = -0.22$。那么\n$$\n\\alpha_{2} = \\pi + (1-\\pi)\\, 0.65 \\;=\\; 0.65 + 0.35\\, \\pi, \\qquad \\beta_{2} = (1-\\pi)\\, (-0.22) \\;=\\; -0.22 + 0.22\\, \\pi.\n$$\n该分段的积分为\n$$\nI_{2}(\\pi) \\;=\\; \\pi \\left[ \\frac{t}{\\alpha_{2}} - \\frac{\\beta_{2}}{\\alpha_{2}^{2}} \\ln(\\alpha_{2} \\, t + \\beta_{2}) \\right]_{t=0.4}^{t=0.8}.\n$$\n对每种患病率进行数值计算：\n- 对于 $\\pi_A = 0.1$：$\\alpha_{2} = 0.685$，$\\beta_{2} = -0.198$，所以在 $t=0.4$ 时 $\\alpha_{2}\\, t + \\beta_{2}$ 为 $0.076$，在 $t=0.8$ 时为 $0.35$。那么\n$$\nI_{2}(\\pi_A) \\;=\\; 0.1 \\left( \\frac{0.4}{0.685} - \\frac{-0.198}{0.685^{2}} \\ln\\!\\frac{0.35}{0.076} \\right)\n\\;\\approx\\; 0.1 \\left( 0.583941606 + 0.644433120 \\right)\n\\;\\approx\\; 0.122837473.\n$$\n- 对于 $\\pi_B = 0.4$：$\\alpha_{2} = 0.79$，$\\beta_{2} = -0.132$，所以在 $t=0.4$ 时 $\\alpha_{2}\\, t + \\beta_{2}$ 为 $0.184$，在 $t=0.8$ 时为 $0.5$。那么\n$$\nI_{2}(\\pi_B) \\;=\\; 0.4 \\left( \\frac{0.4}{0.79} - \\frac{-0.132}{0.79^{2}} \\ln\\!\\frac{0.5}{0.184} \\right)\n\\;\\approx\\; 0.4 \\left( 0.506329114 + 0.211419421 \\right)\n\\;\\approx\\; 0.287099410.\n$$\n\n分段3：$t \\in [0.8,1]$，$f(t) = 3.5\\, t - 2.5$，所以 $m = 3.5$，$c = -2.5$。那么\n$$\n\\alpha_{3} = \\pi + (1-\\pi)\\, 3.5 \\;=\\; 3.5 - 2.5\\, \\pi, \\qquad \\beta_{3} = (1-\\pi)\\, (-2.5) \\;=\\; -2.5 + 2.5\\, \\pi.\n$$\n该分段的积分为\n$$\nI_{3}(\\pi) \\;=\\; \\pi \\left[ \\frac{t}{\\alpha_{3}} - \\frac{\\beta_{3}}{\\alpha_{3}^{2}} \\ln(\\alpha_{3} \\, t + \\beta_{3}) \\right]_{t=0.8}^{t=1}.\n$$\n注意对于任何 $\\pi$，都有 $\\alpha_{3} \\cdot 1 + \\beta_{3} = 1$，且 $\\alpha_{3} \\cdot 0.8 + \\beta_{3} = 0.3 + 0.5\\, \\pi$。因此\n$$\nI_{3}(\\pi) \\;=\\; \\pi \\left( \\frac{0.2}{\\alpha_{3}} - \\frac{\\beta_{3}}{\\alpha_{3}^{2}} \\ln\\!\\frac{1}{0.3 + 0.5\\, \\pi} \\right).\n$$\n数值计算：\n- 对于 $\\pi_A = 0.1$：$\\alpha_{3} = 3.25$，$\\beta_{3} = -2.25$，$0.3 + 0.5\\, \\pi_A = 0.35$。那么\n$$\nI_{3}(\\pi_A) \\;=\\; 0.1 \\left( \\frac{0.2}{3.25} - \\frac{-2.25}{3.25^{2}} \\ln\\!\\frac{1}{0.35} \\right)\n\\;=\\; 0.1 \\left( 0.061538462 + 0.223630740 \\right)\n\\;\\approx\\; 0.028516920.\n$$\n- 对于 $\\pi_B = 0.4$：$\\alpha_{3} = 2.5$，$\\beta_{3} = -1.5$，$0.3 + 0.5\\, \\pi_B = 0.5$。那么\n$$\nI_{3}(\\pi_B) \\;=\\; 0.4 \\left( \\frac{0.2}{2.5} - \\frac{-1.5}{2.5^{2}} \\ln\\!\\frac{1}{0.5} \\right)\n\\;=\\; 0.4 \\left( 0.08 + 0.24 \\ln 2 \\right)\n\\;\\approx\\; 0.098542129.\n$$\n\n将各分段的积分相加，得到每个队列的平均精确率：\n$$\nAP(\\pi_A) \\;=\\; I_{1}(\\pi_A) + I_{2}(\\pi_A) + I_{3}(\\pi_A)\n\\;\\approx\\; 0.210526316 + 0.122837473 + 0.028516920 \\;=\\; 0.361880709,\n$$\n$$\nAP(\\pi_B) \\;=\\; I_{1}(\\pi_B) + I_{2}(\\pi_B) + I_{3}(\\pi_B)\n\\;\\approx\\; 0.347826087 + 0.287099410 + 0.098542129 \\;=\\; 0.733467626.\n$$\n因此，仅由患病率差异导致的平均精确率之差为\n$$\n\\Delta \\;=\\; AP(\\pi_B) - AP(\\pi_A) \\;\\approx\\; 0.733467626 - 0.361880709 \\;=\\; 0.371586918.\n$$\n四舍五入到四位有效数字，$\\Delta \\approx 0.3716$。", "answer": "$$\\boxed{0.3716}$$", "id": "4946956"}]}