{"hands_on_practices": [{"introduction": "理解特征的可重复性始于对其进行量化。本练习将引导您从标准的方差分析（ANOVA）输出中，完成组内相关系数（Intraclass Correlation Coefficient, $ICC$）的基本计算，从而在方差分量与可靠性评估之间建立直接联系 [@problem_id:4563339]。通过为一个假想的影像组学特征计算$ICC$值，您将实际掌握如何解读这一关键指标，以筛选出稳定的特征。", "problem": "一项影像组学研究量化了一个源自灰度共生矩阵（GLCM）的纹理特征，通过重复测试扫描来评估其可重复性。二十名受试者（$n=20$）在相同的采集和重建设置下被扫描两次（每名受试者$k=2$次重复）。对于单个特征，对配对测量值进行的单因素方差分析（ANOVA）分解得出组间平方和 $SS_{\\text{between}}=1.50\\times 10^{3}$ 和组内平方和 $SS_{\\text{within}}=1.60\\times 10^{2}$。一项独立的基于体模的验证，使用一个均匀成像体模在相同协议下扫描两次，结果显示特征变异可忽略不计，$SS_{\\text{phantom}}\\approx 0$，这与稳定的采集过程相符。\n\n从适用于重复测试的单因素随机效应模型的基本原理出发，利用所提供的ANOVA统计量推导该特征的单一测量组内相关系数（ICC）。然后，使用给定的 $SS_{\\text{between}}$ 和 $SS_{\\text{within}}$ 计算其数值。最后，在你的解答过程中，根据常用的可靠性指南，结合用于下游建模的特征选择，简要解释所计算出的ICC值的大小意义。\n\n将最终的ICC表示为四舍五入到四位有效数字的小数，不带单位。", "solution": "问题陈述已经过验证，被认为是合理的。它具有科学依据，提法得当且客观。它提供了按要求推导和计算组内相关系数（ICC）所需的所有信息。关于基于体模验证的背景信息表明系统级测量误差可以忽略不计，从而加强了所选统计模型适用性的论证。\n\n我们首先建立理论框架。该问题描述了一项使用单因素方差分析（ANOVA）进行分析的重复测试可靠性研究。这对应于一个单因素随机效应模型，当受试者被视为来自更大总体的随机样本时，该模型适合用于分解方差。第 $i$ 个受试者在第 $j$ 次重复测量下的模型由下式给出：\n$$y_{ij} = \\mu + \\alpha_i + \\epsilon_{ij}$$\n其中 $y_{ij}$ 是第 $i$ 个受试者（$i \\in \\{1, \\dots, n\\}$）在第 $j$ 次重复测量（$j \\in \\{1, \\dots, k\\}$）下的观测特征值。$\\mu$ 项是所有受试者和测量的特征总均值。$\\alpha_i$ 项代表第 $i$ 个受试者的随机效应，假定其服从均值为0、方差为 $\\sigma^2_{\\text{between}}$ 的正态分布，即 $\\alpha_i \\sim N(0, \\sigma^2_{\\text{between}})$。这个方差分量 $\\sigma^2_{\\text{between}}$ 捕捉了受试者之间的真实生物学变异。$\\epsilon_{ij}$ 项代表随机测量误差，假定其服从均值为0、方差为 $\\sigma^2_{\\text{within}}$ 的正态分布，即 $\\epsilon_{ij} \\sim N(0, \\sigma^2_{\\text{within}})$。这个方差分量 $\\sigma^2_{\\text{within}}$ 捕捉了单个受试者在重复测量中的变异。单次观测的总方差是这两个分量之和：$\\sigma^2_{\\text{total}} = \\sigma^2_{\\text{between}} + \\sigma^2_{\\text{within}}$。\n\n单一测量组内相关系数（通常表示为ICC(1,1)）定义为总方差中可归因于组间变异的比例。它量化了单次测量的可靠性。\n$$ICC = \\frac{\\sigma^2_{\\text{between}}}{\\sigma^2_{\\text{total}}} = \\frac{\\sigma^2_{\\text{between}}}{\\sigma^2_{\\text{between}} + \\sigma^2_{\\text{within}}}$$\n为了计算ICC，我们必须首先从ANOVA输出中估计方差分量 $\\sigma^2_{\\text{between}}$ 和 $\\sigma^2_{\\text{within}}$。在单因素随机效应ANOVA中，均方的期望值为：\n$$E(MS_{\\text{between}}) = \\sigma^2_{\\text{within}} + k \\sigma^2_{\\text{between}}$$\n$$E(MS_{\\text{within}}) = \\sigma^2_{\\text{within}}$$\n其中 $MS_{\\text{between}}$ 是组间均方，$MS_{\\text{within}}$ 是组内均方。它们由平方和（$SS$）和自由度（$df$）计算得出：\n$$MS_{\\text{between}} = \\frac{SS_{\\text{between}}}{df_{\\text{between}}} = \\frac{SS_{\\text{between}}}{n-1}$$\n$$MS_{\\text{within}} = \\frac{SS_{\\text{within}}}{df_{\\text{within}}} = \\frac{SS_{\\text{within}}}{n(k-1)}$$\n通过将观测到的均方与其期望值相等，我们可以推导出方差分量的矩法估计量：\n$$\\hat{\\sigma}^2_{\\text{within}} = MS_{\\text{within}}$$\n$$\\hat{\\sigma}^2_{\\text{between}} = \\frac{MS_{\\text{between}} - MS_{\\text{within}}}{k}$$\n将这些估计量代入ICC公式，得到：\n$$ICC = \\frac{\\frac{MS_{\\text{between}} - MS_{\\text{within}}}{k}}{\\frac{MS_{\\text{between}} - MS_{\\text{within}}}{k} + MS_{\\text{within}}}$$\n将分子和分母同乘以 $k$ 以简化表达式：\n$$ICC = \\frac{MS_{\\text{between}} - MS_{\\text{within}}}{MS_{\\text{between}} - MS_{\\text{within}} + k \\cdot MS_{\\text{within}}} = \\frac{MS_{\\text{between}} - MS_{\\text{within}}}{MS_{\\text{between}} + (k-1)MS_{\\text{within}}}$$\n这就是从单因素ANOVA推导出的单一测量ICC的通用公式。\n\n现在，我们将此公式应用于给定数据：\n受试者数量, $n = 20$。\n重复次数, $k = 2$。\n组间平方和, $SS_{\\text{between}} = 1.50 \\times 10^{3} = 1500$。\n组内平方和, $SS_{\\text{within}} = 1.60 \\times 10^{2} = 160$。\n\n首先，我们计算自由度：\n$$df_{\\text{between}} = n - 1 = 20 - 1 = 19$$\n$$df_{\\text{within}} = n(k - 1) = 20(2 - 1) = 20$$\n接着，我们计算均方：\n$$MS_{\\text{between}} = \\frac{SS_{\\text{between}}}{df_{\\text{between}}} = \\frac{1500}{19}$$\n$$MS_{\\text{within}} = \\frac{SS_{\\text{within}}}{df_{\\text{within}}} = \\frac{160}{20} = 8$$\n现在我们将这些均方和 $k=2$ 代入ICC公式：\n$$ICC = \\frac{MS_{\\text{between}} - MS_{\\text{within}}}{MS_{\\text{between}} + (2-1)MS_{\\text{within}}} = \\frac{MS_{\\text{between}} - MS_{\\text{within}}}{MS_{\\text{between}} + MS_{\\text{within}}}$$\n代入均方的数值：\n$$ICC = \\frac{\\frac{1500}{19} - 8}{\\frac{1500}{19} + 8}$$\n为了简化，我们通分：\n$$ICC = \\frac{\\frac{1500}{19} - \\frac{8 \\times 19}{19}}{\\frac{1500}{19} + \\frac{8 \\times 19}{19}} = \\frac{\\frac{1500 - 152}{19}}{\\frac{1500 + 152}{19}} = \\frac{1348}{1652}$$\n最后，我们计算小数值并四舍五入到四位有效数字：\n$$ICC = \\frac{1348}{1652} \\approx 0.8159806...$$\n$$ICC \\approx 0.8160$$\n\n解释：\n计算出的ICC值约为 $0.8160$，表明该影像组学特征的总方差中约有 $81.6\\%$ 是由受试者之间真实的系统性差异引起的，而其余的 $18.4\\%$ 是由测量误差或随机的受试者内波动造成的。根据解释可靠性的常用指南（例如，Koo and Li, 2016），介于 $0.75$ 和 $0.90$ 之间的ICC值被认为代表“良好”的可靠性。一个具有良好可靠性的特征所产生的测量值能有效地区分不同受试者。因此，该特征表现出足够的可重复性，可以考虑纳入后续的定量建模中，例如构建预后或预测模型，因为它没有受到测量噪声的过度干扰。$SS_{\\text{phantom}} \\approx 0$ 的补充信息证实了采集系统本身是稳定的，这强化了以下结论：测得的组内方差主要归因于患者体位和生理状态等因素，而非设备的不稳定性。", "answer": "$$\\boxed{0.8160}$$", "id": "4563339"}, {"introduction": "并非所有$ICC$的含义都相同；当存在系统性偏倚时，在一致性（consistency）和绝对一致性（absolute agreement）$ICC$之间做出选择至关重要。本练习通过一个包含已知扫描会话偏倚的场景，探讨了这一核心差异，展示了不同形式的$ICC$如何惩罚或忽略这种系统性误差 [@problem_id:4563309]。通过分析基于体模校正后的影响，您将学会如何选择合适的$ICC$指标，以确保您所选的特征真正具有可互换性。", "problem": "一项放射组学研究评估了在同一$N$名受试者队列中，跨两次会话（session）的一个标量图像特征的测试-再测试可重复性。设测量模型为 $y_{ij} = \\mu + p_i + s_j + \\varepsilon_{ij}$，其中 $y_{ij}$ 是受试者 $i$ 在会话 $j$ 中的特征值，$\\mu$ 是总均值，$p_i$ 是受试者特定效应，$s_j$ 是会话效应，$\\varepsilon_{ij}$ 是受试者内噪声。假设以下基本事实：(i) 受试者间变异性由方差分量 $\\sigma_p^2$ 量化，(ii) 会话间变异性由方差分量 $\\sigma_s^2$ 量化，(iii) 残余测量噪声由 $\\sigma_\\varepsilon^2$ 量化。用于评估一致性 (consistency) 的组内相关系数 (ICC)，记为 $ICC(C,1)$，通过将 $s_j$ 视为不影响排序的无关变量来评估可靠性，允许存在附加的会话偏移；用于评估绝对一致性 (absolute agreement) 的ICC，记为 $ICC(A,1)$，通过惩罚任何会话效应来评估跨会话的相同值的可靠性。\n\n一项基于体模的验证揭示了两次会话之间存在一个大小为 $\\delta$ 的附加会话偏倚，会话效应为 $s_1 = 0$ 和 $s_2 = \\delta$，且两次会话的使用频率相同。因此，会话效应方差为 $\\sigma_s^2 = \\delta^2 / 4$。假设该队列的 $\\sigma_p^2 = 100$，受试者内噪声方差 $\\sigma_\\varepsilon^2 = 25$，体模估计的偏倚 $\\delta = 5$。以方差分解为基本出发点（可靠性等于真实受试者方差与相关可靠性定义下的总方差之比），请考虑在存在会话偏倚以及经过基于体模的校正（从会话2的测量值中减去 $\\delta$）后，关于 $ICC(C,1)$ 和 $ICC(A,1)$ 的以下陈述：\n\nA. 在存在大小为 $\\delta$ 的附加会话偏倚时，$ICC(C,1)$ 排除了会话方差项，因此与 $ICC(A,1)$ 相比，它高估了可重复性；经过基于体模的偏倚校正（减去 $\\delta$）后，$ICC(A,1)$ 增加到与 $ICC(C,1)$ 相等，使得 $ICC(A,1)$ 成为放射组学特征可重复性的更好反映指标。\n\nB. $ICC(C,1)$ 通过包含会话方差项来惩罚附加会话偏倚，因此是更好的可重复性反映指标；基于体模的校正对 $ICC(A,1)$ 没有影响。\n\nC. 如果 $\\delta$ 是恒定的，$ICC(A,1)$ 会超过 $ICC(C,1)$，因为绝对一致性忽略了固定的偏移；基于体模的校正会降低 $ICC(A,1)$。\n\nD. $ICC(C,1)$ 和 $ICC(A,1)$ 对任何附加会话偏倚都是不变的；因此两者都不适合用于可重复性评估。\n\n哪个选项是正确的？", "solution": "该问题陈述已经过严格验证，被认为是合理的。它在科学上基于生物统计学和可靠性分析的原理，特别是关于组内相关系数（ICC）的原理。该问题提法得当、客观，并为严谨求解提供了完整且一致的数据和定义。\n\n问题的核心在于理解并应用两种不同形式ICC的正确公式：基于所提供的方差分量，用于一致性的 $ICC(C,1)$ 和用于绝对一致性的 $ICC(A,1)$。\n\n测量模型以线性混合效应模型给出：\n$$y_{ij} = \\mu + p_i + s_j + \\varepsilon_{ij}$$\n其中 $p_i$、$s_j$ 和 $\\varepsilon_{ij}$ 是随机效应，其方差分别为 $\\sigma_p^2$、$\\sigma_s^2$ 和 $\\sigma_\\varepsilon^2$。这些方差分别代表受试者间变异性、会话间变异性和残余测量噪声。\n\n问题要求我们使用方差分解作为定义可靠性的基本原则。可靠性是“真实”方差（此处指受试者间方差 $\\sigma_p^2$）与总方差的比值。分母中总方差的构成取决于所使用的可靠性定义。\n\n对于 $ICC(C,1)$（一致性），会话效应 $s_j$ 被视为一个无关参数。会话间的恒定附加偏移不影响受试者的排序，因此被排除在降低可靠性的方差分量之外。对于单个观测值，与一致性相关的总方差是受试者方差和随机误差方差之和。\n$$ICC(C,1) = \\frac{\\sigma_p^2}{\\sigma_p^2 + \\sigma_\\varepsilon^2}$$\n\n对于 $ICC(A,1)$（绝对一致性），会话效应 $s_j$ 被视为系统误差的来源。会话均值的任何差异都会影响在不同会话中为同一受试者获得相同值的目标。因此，其方差 $\\sigma_s^2$ 被包含在总方差中，从而对可靠性得分进行惩罚。\n$$ICC(A,1) = \\frac{\\sigma_p^2}{\\sigma_p^2 + \\sigma_s^2 + \\sigma_\\varepsilon^2}$$\n\n我们已知以下数值：\n- 受试者间方差： $\\sigma_p^2 = 100$\n- 残余噪声方差： $\\sigma_\\varepsilon^2 = 25$\n- 会话偏倚大小： $\\delta = 5$\n\n会话效应方差 $\\sigma_s^2$ 是根据会话效应 $s_1 = 0$ 和 $s_2 = \\delta$（假设频率相等）推导出来的。会话效应的均值为 $(0 + \\delta) / 2 = \\delta / 2$。方差是与均值偏差平方的期望值：\n$$\\sigma_s^2 = \\frac{1}{2}(0 - \\frac{\\delta}{2})^2 + \\frac{1}{2}(\\delta - \\frac{\\delta}{2})^2 = \\frac{1}{2}(\\frac{\\delta^2}{4}) + \\frac{1}{2}(\\frac{\\delta^2}{4}) = \\frac{\\delta^2}{4}$$\n代入 $\\delta = 5$：\n$$\\sigma_s^2 = \\frac{5^2}{4} = \\frac{25}{4} = 6.25$$\n\n**场景1：存在会话偏倚**\n\n我们使用给定的方差分量计算ICC：\n$$ICC(C,1) = \\frac{100}{100 + 25} = \\frac{100}{125} = 0.8$$\n$$ICC(A,1) = \\frac{100}{100 + 6.25 + 25} = \\frac{100}{131.25} \\approx 0.7619$$\n正如预期的那样，在存在系统性会话偏倚（$\\sigma_s^2 > 0$）的情况下，$ICC(A,1)  ICC(C,1)$。$ICC(A,1)$ 会惩罚该偏倚，而 $ICC(C,1)$ 则忽略它。\n\n**场景2：经过基于体模的偏倚校正后**\n\n校正过程涉及从会话 $2$ 的所有测量值中减去 $\\delta$。设校正后的测量值为 $y'_{ij}$。\n- 对于会话 $j=1$：$y'_{i1} = y_{i1} = \\mu + p_i + s_1 + \\varepsilon_{i1} = \\mu + p_i + 0 + \\varepsilon_{i1}$。\n- 对于会话 $j=2$：$y'_{i2} = y_{i2} - \\delta = (\\mu + p_i + s_2 + \\varepsilon_{i2}) - \\delta = (\\mu + p_i + \\delta + \\varepsilon_{i2}) - \\delta = \\mu + p_i + \\varepsilon_{i2}$。\n校正后的模型实际上是 $y'_{ij} = \\mu + p_i + \\varepsilon_{ij}$。会话效应已被消除。\n这意味着新的会话效应方差为 $\\sigma_{s, \\text{corrected}}^2 = 0$。其他方差分量 $\\sigma_p^2$ 和 $\\sigma_\\varepsilon^2$ 保持不变，因为它们描述的是固有的受试者变异性和随机噪声。\n\n我们重新计算校正后的ICC：\n$$ICC(C,1)_{\\text{corrected}} = \\frac{\\sigma_p^2}{\\sigma_p^2 + \\sigma_\\varepsilon^2} = \\frac{100}{100 + 25} = 0.8$$\n$ICC(C,1)$ 对校正不敏感，证实了它对附加的会话偏移不敏感。\n$$ICC(A,1)_{\\text{corrected}} = \\frac{\\sigma_p^2}{\\sigma_p^2 + \\sigma_{s, \\text{corrected}}^2 + \\sigma_\\varepsilon^2} = \\frac{100}{100 + 0 + 25} = \\frac{100}{125} = 0.8$$\n校正后，$ICC(A,1)$ 增加并变得与 $ICC(C,1)$ 相等。\n\n现在我们根据这些推导来评估给出的选项。\n\n**A. 在存在大小为 $\\delta$ 的附加会话偏倚时，$ICC(C,1)$ 排除了会话方差项，因此与 $ICC(A,1)$ 相比，它高估了可重复性；经过基于体模的偏倚校正（减去 $\\delta$）后，$ICC(A,1)$ 增加到与 $ICC(C,1)$ 相等，使得 $ICC(A,1)$ 成为放射组学特征可重复性的更好反映指标。**\n- “$ICC(C,1)$ 排除了会话方差项”：**正确**。其公式为 $\\sigma_p^2 / (\\sigma_p^2 + \\sigma_\\varepsilon^2)$。\n- “因此与 $ICC(A,1)$ 相比，它高估了可重复性”：**正确**。我们计算出 $ICC(C,1) = 0.8$，而 $ICC(A,1) \\approx 0.7619$。$ICC(C,1)$ 忽略了系统误差，给出了一个比绝对值一致性所保证的更高、更乐观的可靠性值。\n- “经过基于体模的偏倚校正后...，$ICC(A,1)$ 增加到与 $ICC(C,1)$ 相等”：**正确**。我们计算出 $ICC(A,1)$ 从 $\\approx 0.7619$ 增加到 $0.8$，此时它等于 $ICC(C,1)$。\n- “使得 $ICC(A,1)$ 成为更好的可重复性反映指标”：**正确**。这是一个合理的结论。$ICC(A,1)$ 对系统性偏倚敏感，在校正前能正确识别其存在，在校正后能确认其已被移除。在放射组学中，目标通常是获得可互换的定量测量值，因此绝对一致性通常是更相关、更全面的可重复性度量。\n因此，整个陈述是**正确**的。\n\n**B. $ICC(C,1)$ 通过包含会话方差项来惩罚附加会话偏倚，因此是更好的可重复性反映指标；基于体模的校正对 $ICC(A,1)$ 没有影响。**\n- “$ICC(C,1)$ 通过包含会话方差项来惩罚附加会话偏倚”：**不正确**。这是 $ICC(A,1)$ 的定义，而不是 $ICC(C,1)$ 的。$ICC(C,1)$ *忽略* 会话方差。\n- “基于体模的校正对 $ICC(A,1)$ 没有影响”：**不正确**。我们的计算显示 $ICC(A,1)$ 在校正后显著增加。\n该陈述是**不正确**的。\n\n**C. 如果 $\\delta$ 是恒定的，$ICC(A,1)$ 会超过 $ICC(C,1)$，因为绝对一致性忽略了固定的偏移；基于体模的校正会降低 $ICC(A,1)$。**\n- “$ICC(A,1)$ 会超过 $ICC(C,1)$”：**不正确**。因为 $\\sigma_s^2 \\ge 0$，$ICC(A,1)$ 的分母总是大于或等于 $ICC(C,1)$ 的分母。因此，$ICC(A,1) \\le ICC(C,1)$ 总是成立。\n- “因为绝对一致性忽略了固定的偏移”：**不正确**。绝对一致性*惩罚*固定的偏移；一致性则忽略它们。此推理存在缺陷。\n- “基于体模的校正会降低 $ICC(A,1)$”：**不正确**。校正*移除*了一个误差方差源（$\\sigma_s^2$），这会减小分母，从而*增加* $ICC(A,1)$。\n该陈述是**不正确**的。\n\n**D. $ICC(C,1)$ 和 $ICC(A,1)$ 对任何附加会话偏倚都是不变的；因此两者都不适合用于可重复性评估。**\n- “$ICC(C,1)$ 和 $ICC(A,1)$ 对任何附加会话偏倚都是不变的”：**不正确**。我们的计算明确显示 $ICC(A,1)$ 对会话偏倚是敏感的（它从 $\\approx 0.7619$ 变为 $0.8$），而 $ICC(C,1)$ 是不敏感的。\n- “因此两者都不适合用于可重复性评估”：**不正确**。前提是错误的，结论也是错误的。ICC 不同形式的差异化敏感性正是它们成为评估可重复性的强大诊断工具的原因。\n该陈述是**不正确**的。\n\n基于详细的分析，只有选项A与可靠性理论的原则以及从问题数据得出的计算结果相符。", "answer": "$$\\boxed{A}$$", "id": "4563309"}, {"introduction": "理论通过模拟得以生动展现，使我们能够系统地研究影像组学特征的稳健性。在最后的这个动手实践中，您将从零开始构建一个模拟程序，以建模测试-重测采集过程，并评估受控水平的噪声如何影响多种一阶特征的可重复性 [@problem_id:4563232]。通过亲手实现从图像生成到$ICC$计算的完整分析流程，您将对为何某些特征本质上比其他特征更稳定建立起深刻且实用的直觉。", "problem": "您的任务是设计一个程序，模拟对简单体模区域的测试-再测试采集，以评估一阶直方图放射组学特征在受控加性噪声下的可重复性。目标是为每个测试案例计算有多少特征保持较高的组内相关系数（Intraclass Correlation Coefficient, ICC），从而可以被认为是稳健的。您的程序必须严格根据第一性原理来实现模拟和特征计算。\n\n从以下基本定义开始：\n\n- 对于像素强度为 $\\{x_1, x_2, \\dots, x_N\\}$ 的图像，定义样本均值为 $ \\mu = \\frac{1}{N}\\sum_{i=1}^{N} x_i $，样本方差为 $ s^2 = \\frac{1}{N-1}\\sum_{i=1}^{N}(x_i - \\mu)^2 $，样本标准差为 $ s = \\sqrt{s^2} $。定义 $r$ 阶中心矩为 $ m_r = \\frac{1}{N}\\sum_{i=1}^{N}(x_i - \\mu)^r $。当 $ s \\neq 0 $ 时，偏度为 $ \\gamma_1 = \\frac{m_3}{s^3} $，峰度为 $ \\gamma_2 = \\frac{m_4}{s^4} $；当 $ s = 0 $ 时，为避免除以零，设定 $ \\gamma_1 = 0 $ 和 $ \\gamma_2 = 0 $。\n- 对于一个在固定强度范围内、具有 $B$ 个组且计数为 $\\{h_1, h_2, \\dots, h_B\\}$ 的直方图，每个组 $b$ 的经验概率质量函数为 $ p_b = \\frac{h_b}{\\sum_{j=1}^{B} h_j} $。香农熵（自然对数）为 $ H = -\\sum_{b=1}^{B} p_b \\ln(p_b) $，其中求和针对 $ p_b > 0 $ 的组。强度能量定义为 $ E = \\frac{1}{N}\\sum_{i=1}^{N} x_i^2 $。\n- 位于分数 $ q \\in [0,1] $ 的分位数定义为值 $ Q(q) $，使得数据中有 $ q $ 的部分小于或等于 $ Q(q) $。特别地，需要计算 $ Q(0.5) $（中位数）、$ Q(0.1) $ 和 $ Q(0.9) $。\n\n模拟 $n$ 个独立体模区域的测试-再测试成像过程，每个区域是一个大小为 $H \\times W$ 的二维数组，其均匀基础强度 $ I_i $ 从区间 $[I_{\\min}, I_{\\max}]$ 中均匀抽取。通过向每个像素添加均值为零、标准差为 $\\sigma$ 的独立同分布加性高斯噪声，来模拟每个区域的 $k$ 次重复采集。将强度值裁剪到区间 $[0, 255]$ 以保持灰度值的物理合理性。\n\n对于每次采集，对整个图像计算以下一阶直方图特征：\n- 均值 $ \\mu $。\n- 方差 $ s^2 $。\n- 标准差 $ s $。\n- 偏度 $ \\gamma_1 $。\n- 峰度 $ \\gamma_2 $。\n- 强度能量 $ E $。\n- 使用在 $[0, 255]$ 范围内有 $B$ 个组的直方图计算的香农熵 $ H $。\n- 中位数 $ Q(0.5) $。\n- 分位数 $ Q(0.1) $。\n- 分位数 $ Q(0.9) $。\n\n为量化跨对象间的测试-再测试可重复性，使用单次测量的单向随机效应组内相关系数（ICC），记为 $ \\mathrm{ICC}(1,1) $。设 $x_{ij}$ 为对象 $i \\in \\{1,\\dots,n\\}$ 在第 $j \\in \\{1,\\dots,k\\}$ 次重复测量时的特征值。令 $ \\bar{x}_i = \\frac{1}{k}\\sum_{j=1}^{k} x_{ij} $ 为对象 $i$ 的均值，$ \\bar{x} = \\frac{1}{nk}\\sum_{i=1}^{n}\\sum_{j=1}^{k} x_{ij} $ 为总均值。定义对象间均方\n$$ \\mathrm{BMS} = \\frac{k}{n-1} \\sum_{i=1}^{n} \\left( \\bar{x}_i - \\bar{x} \\right)^2, $$\n和对象内均方\n$$ \\mathrm{WMS} = \\frac{1}{n(k-1)} \\sum_{i=1}^{n} \\sum_{j=1}^{k} \\left( x_{ij} - \\bar{x}_i \\right)^2. $$\n然后计算\n$$ \\mathrm{ICC}(1,1) = \\frac{\\mathrm{BMS} - \\mathrm{WMS}}{\\mathrm{BMS} + (k-1)\\,\\mathrm{WMS}}. $$\n\n在给定的测试案例中，如果一个特征满足 $ \\mathrm{ICC}(1,1) \\ge \\tau $，则该特征被认为是稳健的，其中 $ \\tau $ 是一个以小数表示的指定阈值。\n\n实现一个确定性程序，对于所提供的测试套件中的每个测试案例，执行模拟并计算上述十个特征中有多少个是稳健的。必须为随机数生成设定种子以确保可复现性。\n\n测试套件：\n- 案例 1：$n = 12$, $k = 3$, $H = 64$, $W = 64$, $I_{\\min} = 80$, $I_{\\max} = 120$, $\\sigma = 2$, $B = 64$, $\\tau = 0.85$。\n- 案例 2：$n = 12$, $k = 3$, $H = 64$, $W = 64$, $I_{\\min} = 80$, $I_{\\max} = 120$, $\\sigma = 15$, $B = 64$, $\\tau = 0.85$。\n- 案例 3：$n = 8$, $k = 2$, $H = 32$, $W = 32$, $I_{\\min} = 80$, $I_{\\max} = 120$, $\\sigma = 40$, $B = 64$, $\\tau = 0.85$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，列表中的每个元素是对应测试案例的稳健特征的整数计数，顺序与上面列出的一致（例如，$[c_1,c_2,c_3]$）。", "solution": "该问题陈述在放射组学领域提出了一个有效且定义明确的任务，具体涉及基于体模的特征可重复性验证。该问题具有科学依据，采用了图像特征和组内相关系数（ICC）的标准统计定义。模拟的所有参数都已明确提供，任务是实现一个确定性模拟，这可以通过为随机数生成器设定种子来实现。问题没有矛盾、歧义和非科学性论断。它代表了一个评估放射组学特征对噪声稳健性的标准（尽管是简化的）程序，这是验证其临床可用性的关键步骤。\n\n我们将着手提供一个完整的解决方案。该方法论包括三个主要阶段：\n1.  **图像数据模拟**：对于每个测试案例，我们根据指定的模型生成一组体模图像。这包括创建 $n$ 个不同的体模区域，每个区域由一个均匀的基础强度 $I_i$ 表征。对于每个区域，我们通过添加独立的高斯噪声并裁剪所得的像素强度来模拟 $k$ 次重复采集。\n2.  **特征提取**：从每个模拟图像中，我们计算一组十个一阶放射组学特征。这些特征严格按照所提供的数学定义进行计算。\n3.  **可重复性分析**：对于十个特征中的每一个，我们使用收集到的所有 $n$ 个对象和 $k$ 次重复的数据来计算组内相关系数 $\\mathrm{ICC}(1,1)$。然后我们将此值与给定的阈值 $\\tau$ 进行比较，以确定该特征是否稳健。每个测试案例的最终输出是稳健特征的总数。\n\n让我们将分步过程形式化。\n\n首先，我们为伪随机数生成器设置一个全局种子，以确保整个模拟是确定性和可复现的。设图像中的总像素数为 $N = H \\times W$。\n\n对于每个具有参数 $(n, k, H, W, I_{\\min}, I_{\\max}, \\sigma, B, \\tau)$ 的测试案例：\n\n**1. 数据生成**\n\n我们生成一个数据结构来保存特征值，可以将其看作十个独立的矩阵，每个矩阵的大小为 $n \\times k$。设 $F_{l,i,j}$ 为第 $l$ 个特征（对于 $l \\in \\{1, \\dots, 10\\}$）在对象 $i \\in \\{1, \\dots, n\\}$ 和重复采集 $j \\in \\{1, \\dots, k\\}$ 上的值。\n\n模拟过程如下：\n对于每个对象 $i$（从 $1$ 到 $n$）：\na.  从区间 $[I_{\\min}, I_{\\max}]$ 上的均匀分布中抽取一个基础强度值 $I_i$。\nb.  对于每次重复采集 $j$（从 $1$ 到 $k$）：\n    i.   生成一个 $H \\times W$ 的噪声值矩阵 $\\epsilon$，其中每个元素都独立地从均值为 $0$、标准差为 $\\sigma$ 的高斯分布中抽取。\n    ii.  通过将噪声添加到基础强度来构造模拟图像矩阵：$X_{ij} = I_i + \\epsilon$。\n    iii. 将 $X_{ij}$ 中的所有像素值裁剪到有效强度范围 $[0, 255]$。\n    iv.  将 $H \\times W$ 的图像矩阵 $X_{ij}$ 展平为包含 $N$ 个像素强度的一维向量 $\\{x_1, x_2, \\dots, x_N\\}$。\n    v.   从此向量计算十个放射组学特征并存储它们。\n\n**2. 特征计算**\n\n对于每个像素强度向量 $\\{x_1, x_2, \\dots, x_N\\}$，计算十个特征：\n\n-   **均值 ($\\mu$)**: $\\mu = \\frac{1}{N}\\sum_{p=1}^{N} x_p$。\n-   **方差 ($s^2$)**: $s^2 = \\frac{1}{N-1}\\sum_{p=1}^{N}(x_p - \\mu)^2$。\n-   **标准差 ($s$)**: $s = \\sqrt{s^2}$。\n-   **中心矩 ($m_r$)**: $m_r = \\frac{1}{N}\\sum_{p=1}^{N}(x_p - \\mu)^r$。\n-   **偏度 ($\\gamma_1$)**: $\\gamma_1 = m_3 / s^3$。如果 $s=0$，则 $\\gamma_1=0$。\n-   **峰度 ($\\gamma_2$)**: $\\gamma_2 = m_4 / s^4$。如果 $s=0$，则 $\\gamma_2=0$。\n-   **能量 ($E$)**: $E = \\frac{1}{N}\\sum_{p=1}^{N} x_p^2$。\n-   **香农熵 ($H$)**: 在 $[0, 255]$ 的范围内为强度值构建一个有 $B$ 个组的直方图。设每个组的计数为 $\\{h_1, \\dots, h_B\\}$。组 $b$ 的概率为 $p_b = h_b / N$。熵为 $H = -\\sum_{b=1}^{B} p_b \\ln(p_b)$，其中求和是针对 $p_b  0$ 的组。\n-   **分位数 ($Q(q)$)**: 对数据进行排序，并计算值 $Q(0.1)$、$Q(0.5)$（中位数）和 $Q(0.9)$。\n\n**3. ICC 计算和稳健性评估**\n\n填充特征矩阵后，我们逐一分析每个特征。对于给定的特征 $l$，我们有测量值的 $n \\times k$ 矩阵 $x_{ij} = F_{l,i,j}$。\n\na.  计算每个对象的平均测量值：$\\bar{x}_i = \\frac{1}{k}\\sum_{j=1}^{k} x_{ij}$。\nb.  计算所有测量的总均值：$\\bar{x} = \\frac{1}{n} \\sum_{i=1}^{n} \\bar{x}_i = \\frac{1}{nk}\\sum_{i=1}^{n}\\sum_{j=1}^{k} x_{ij}$。\nc.  计算对象间均方（BMS）：\n    $$ \\mathrm{BMS} = \\frac{k}{n-1} \\sum_{i=1}^{n} \\left( \\bar{x}_i - \\bar{x} \\right)^2 $$\nd.  计算对象内均方（WMS）：\n    $$ \\mathrm{WMS} = \\frac{1}{n(k-1)} \\sum_{i=1}^{n} \\sum_{j=1}^{k} \\left( x_{ij} - \\bar{x}_i \\right)^2 $$\n    这些项分别量化了不同对象之间的变异性和同一对象重复测量内部的变异性。\ne.  计算单次测量的组内相关系数 $\\mathrm{ICC}(1,1)$：\n    $$ \\mathrm{ICC}(1,1) = \\frac{\\mathrm{BMS} - \\mathrm{WMS}}{\\mathrm{BMS} + (k-1)\\,\\mathrm{WMS}} $$\n    一个接近于 $1$ 的高 ICC 值表示对象间的变异性（BMS）远大于重复测量带来的变异性（WMS），这表明具有良好的可重复性。\nf.  如果 $\\mathrm{ICC}(1,1) \\ge \\tau$，则一个特征被归类为稳健的。\ng.  我们计算该测试案例中稳健特征的总数。这个计数就是该案例的结果。\n\n对问题陈述中提供的三个测试案例中的每一个都重复这一完整过程。最终输出是一个列表，其中包含每个案例的稳健特征的整数计数。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run simulations for all test cases and print the results.\n    \"\"\"\n    # Seed the random number generator for deterministic and reproducible results.\n    np.random.seed(0)\n\n    # Test Suite\n    test_cases = [\n        {'n': 12, 'k': 3, 'H': 64, 'W': 64, 'I_min': 80, 'I_max': 120, 'sigma': 2, 'B': 64, 'tau': 0.85},\n        {'n': 12, 'k': 3, 'H': 64, 'W': 64, 'I_min': 80, 'I_max': 120, 'sigma': 15, 'B': 64, 'tau': 0.85},\n        {'n': 8, 'k': 2, 'H': 32, 'W': 32, 'I_min': 80, 'I_max': 120, 'sigma': 40, 'B': 64, 'tau': 0.85},\n    ]\n\n    results = []\n    for case_params in test_cases:\n        robust_count = run_simulation_and_analysis(**case_params)\n        results.append(robust_count)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef compute_features(pixels, num_bins):\n    \"\"\"\n    Computes all 10 first-order radiomic features from a 1D array of pixel intensities.\n    \"\"\"\n    N = len(pixels)\n    if N == 0:\n        return [0.0] * 10\n\n    # Mean, Variance, Std Dev\n    mu = np.mean(pixels)\n    # The problem defines sample variance with N-1, which is ddof=1 in numpy.\n    s2 = np.var(pixels, ddof=1) if N > 1 else 0.0\n    s = np.sqrt(s2)\n\n    # Skewness and Kurtosis from first principles\n    if s > 0:\n        # Central moments are defined with 1/N\n        m3_term = np.sum((pixels - mu)**3) / N\n        m4_term = np.sum((pixels - mu)**4) / N\n        skewness = m3_term / (s**3)\n        kurtosis = m4_term / (s**4)\n    else:\n        skewness = 0.0\n        kurtosis = 0.0\n\n    # Intensity Energy\n    energy = np.mean(pixels**2)\n\n    # Shannon Entropy\n    # Histogram range is fixed to [0, 255] as per problem context.\n    hist, _ = np.histogram(pixels, bins=num_bins, range=(0, 255))\n    probs = hist / N\n    # Sum over bins with non-zero probability\n    entropy = -np.sum(probs[probs > 0] * np.log(probs[probs > 0]))\n\n    # Quantiles\n    q10 = np.quantile(pixels, 0.1)\n    median = np.quantile(pixels, 0.5)\n    q90 = np.quantile(pixels, 0.9)\n\n    return [\n        mu, s2, s, skewness, kurtosis, energy, entropy, median, q10, q90\n    ]\n\ndef calculate_icc11(feature_matrix, k):\n    \"\"\"\n    Calculates ICC(1,1) from an n x k matrix of feature measurements.\n    \"\"\"\n    n, k_check = feature_matrix.shape\n    if k_check != k:\n        raise ValueError(\"Matrix dimensions do not match k.\")\n\n    if n == 1 or k == 1:\n        # ICC is not well-defined for n=1 or k=1. The formulas would involve division by zero.\n        return 0.0\n\n    # Means\n    grand_mean = np.mean(feature_matrix)\n    subject_means = np.mean(feature_matrix, axis=1)\n\n    # Between-Subject Mean Square (BMS)\n    bms = (k / (n - 1)) * np.sum((subject_means - grand_mean)**2)\n\n    # Within-Subject Mean Square (WMS)\n    wms_sum_sq = np.sum((feature_matrix - subject_means[:, np.newaxis])**2)\n    wms = wms_sum_sq / (n * (k - 1))\n\n    # ICC(1,1)\n    denominator = bms + (k - 1) * wms\n    if denominator  1e-9: # Avoid division by zero, handle case of no variance\n        # If both BMS and WMS are zero, all measurements are identical.\n        # If BMS is zero but WMS is not, it implies negative ICC.\n        # If WMS is zero but BMS is not, it implies perfect correlation ICC=1.\n        return 1.0 if bms > wms else 0.0\n    \n    icc = (bms - wms) / denominator\n    return icc\n\ndef run_simulation_and_analysis(n, k, H, W, I_min, I_max, sigma, B, tau):\n    \"\"\"\n    Performs the full simulation, feature extraction, and repeatability analysis for one test case.\n    \"\"\"\n    num_features = 10\n    # feature_data will be a list of 10 numpy arrays, each of shape (n, k)\n    feature_data = [np.zeros((n, k)) for _ in range(num_features)]\n    \n    num_pixels = H * W\n\n    # Generate base intensities for all subjects at once\n    base_intensities = np.random.uniform(I_min, I_max, size=n)\n\n    for i in range(n):\n        base_I = base_intensities[i]\n        for j in range(k):\n            # Create perfect image and add noise\n            noise = np.random.normal(loc=0.0, scale=sigma, size=(H, W))\n            image = base_I + noise\n            \n            # Clip intensities to [0, 255] and flatten\n            image = np.clip(image, 0, 255)\n            pixels = image.flatten()\n\n            # Compute and store features\n            features = compute_features(pixels, B)\n            for feat_idx in range(num_features):\n                feature_data[feat_idx][i, j] = features[feat_idx]\n\n    # Analyze repeatability for each feature\n    robust_feature_count = 0\n    for feat_idx in range(num_features):\n        icc_value = calculate_icc11(feature_data[feat_idx], k)\n        if icc_value >= tau:\n            robust_feature_count += 1\n            \n    return robust_feature_count\n\nif __name__ == '__main__':\n    solve()\n\n```", "id": "4563232"}]}