{"hands_on_practices": [{"introduction": "决策曲线分析的核心在于量化模型在特定风险阈值下的临床价值。本练习将带您从最基础的混淆矩阵出发，亲手计算一个影像组学模型的净获益，并将其与“全员治疗”和“全员不治疗”这两种基线策略进行比较。通过这个计算，您将直观地理解净获益是如何权衡真阳性带来的益处与假阳性带来的危害的。[@problem_id:4551107]", "problem": "一个经过校准的影像组学分类器用于根据影像特征预测一个二元临床终点（某种状况存在或不存在）。在一个反映临床风险承受能力的决策阈值概率 $t$ 下，该分类在一个外部验证集上产生以下混淆矩阵：真阳性 (TP) $=84$，假阳性 (FP) $=60$，真阴性 (TN) $=220$，以及假阴性 (FN) $=36$，总样本量为 $N=400$。阈值概率为 $t=0.15$。使用阈值概率的基本决策理论解释，其中假阳性的危害通过对应于 $t$ 的比值进行加权，计算该校准影像组学模型的净获益 $NB(t)$ 以及两种基线临床策略（全体治疗和全体不治疗）的净获益。然后，报告影像组学模型相对于最佳基线策略的净获益优势，定义为 $NB(t)-\\max\\{NB_{\\text{all}}(t), NB_{\\text{none}}(t)\\}$。将最终优势表示为小数，并四舍五入至四位有效数字。", "solution": "首先对问题进行验证，以确保其科学合理、定义明确且客观。\n\n### 步骤1：提取已知条件\n问题陈述中提供了以下数据：\n- 真阳性，$TP = 84$\n- 假阳性，$FP = 60$\n- 真阴性，$TN = 220$\n- 假阴性，$FN = 36$\n- 总样本量，$N = TP + FP + TN + FN = 84 + 60 + 220 + 36 = 400$\n- 决策阈值概率，$t = 0.15$\n\n### 步骤2：使用提取的已知条件进行验证\n1.  **科学依据**：该问题基于决策曲线分析 (DCA)，这是生物统计学和医学信息学中用于评估预测模型的标准且成熟的方法。净获益、阈值概率、混淆矩阵元素以及基线策略（全体治疗、全体不治疗）等概念是DCA的基础。将其应用于影像组学分类器是一个常见且合适的背景。\n2.  **定义明确**：该问题提供了所有必要的数值和一个清晰、明确的目标。所提供的数字在内部是一致的（$TP+FP+TN+FN = N$）。问题要求一个具体的、可计算的量。\n3.  **客观性**：该问题以精确、定量的术语陈述，没有主观性语言或观点。\n\n### 步骤3：结论与行动\n该问题被认为是有效的。将提供完整的解答。\n\n预测模型的净获益 ($NB$) 是基于指定的决策阈值概率 $t$ 定义的。阈值 $t$ 代表患者（或临床医生）会选择接受治疗的疾病概率。假阳性（不必要的治疗）的危害相对于真阳性（正确的治疗）的获益，通过该阈值的比值 $\\frac{t}{1-t}$ 进行加权。净获益的公式为：\n$$NB(t) = \\frac{TP}{N} - \\frac{FP}{N} \\left( \\frac{t}{1-t} \\right)$$\n其中 $TP$ 是真阳性数量，$FP$ 是假阳性数量，$N$ 是总受试者数量。\n\n首先，我们计算给定阈值 $t=0.15$ 的比值项：\n$$ \\frac{t}{1-t} = \\frac{0.15}{1 - 0.15} = \\frac{0.15}{0.85} = \\frac{15}{85} = \\frac{3}{17} $$\n\n接下来，我们使用给定的混淆矩阵值计算影像组学模型的净获益 $NB(t)$：\n$$ NB(t) = \\frac{84}{400} - \\frac{60}{400} \\left( \\frac{3}{17} \\right) $$\n简化分数：\n$$ NB(t) = \\frac{21}{100} - \\frac{15}{100} \\left( \\frac{3}{17} \\right) = \\frac{21}{100} - \\frac{45}{1700} $$\n为了进行减法，我们找到一个公分母 $1700$：\n$$ NB(t) = \\frac{21 \\times 17}{1700} - \\frac{45}{1700} = \\frac{357 - 45}{1700} = \\frac{312}{1700} $$\n这个分数可以被简化：\n$$ NB(t) = \\frac{156}{850} = \\frac{78}{425} $$\n\n现在，我们计算两种基线临床策略的净获益。\n\n1.  **全体不治疗策略 ($NB_{\\text{none}}(t)$)**：在此策略中，没有人接受治疗。因此，没有真阳性也没有假阳性（$TP=0$, $FP=0$）。净获益始终为零。\n    $$ NB_{\\text{none}}(t) = \\frac{0}{N} - \\frac{0}{N} \\left( \\frac{t}{1-t} \\right) = 0 $$\n\n2.  **全体治疗策略 ($NB_{\\text{all}}(t)$)**：在此策略中，每个人都接受治疗。所有患有该状况的受试者都是真阳性，所有未患该状况的受试者都是假阳性。\n    患有该状况的总受试者数（患病人数）为 $P = TP + FN = 84 + 36 = 120$。\n    未患该状况的总受试者数为 $N_{\\text{neg}} = TN + FP = 220 + 60 = 280$。\n    对于全体治疗策略，“真阳性”的数量是患病患者的总数（$120$），“假阳性”的数量是未患病患者的总数（$280$）。\n    净获益为：\n    $$ NB_{\\text{all}}(t) = \\frac{P}{N} - \\frac{N_{\\text{neg}}}{N} \\left( \\frac{t}{1-t} \\right) = \\frac{120}{400} - \\frac{280}{400} \\left( \\frac{3}{17} \\right) $$\n    简化分数：\n    $$ NB_{\\text{all}}(t) = \\frac{3}{10} - \\frac{7}{10} \\left( \\frac{3}{17} \\right) = \\frac{3}{10} - \\frac{21}{170} $$\n    为了进行减法，我们找到一个公分母 $170$：\n    $$ NB_{\\text{all}}(t) = \\frac{3 \\times 17}{170} - \\frac{21}{170} = \\frac{51 - 21}{170} = \\frac{30}{170} = \\frac{3}{17} $$\n\n问题要求计算影像组学模型相对于最佳基线策略的净获益优势。我们必须首先通过找到 $\\max\\{NB_{\\text{all}}(t), NB_{\\text{none}}(t)\\}$ 来确定最佳基线策略。\n我们比较 $NB_{\\text{all}}(t) = \\frac{3}{17}$ 和 $NB_{\\text{none}}(t) = 0$。显然，$\\frac{3}{17} > 0$，所以最佳基线策略是“全体治疗”。\n$$ \\max\\{NB_{\\text{all}}(t), NB_{\\text{none}}(t)\\} = \\frac{3}{17} $$\n\n净获益优势是模型的净获益与最佳基线净获益之间的差值：\n$$ \\text{Advantage} = NB(t) - \\max\\{NB_{\\text{all}}(t), NB_{\\text{none}}(t)\\} = \\frac{78}{425} - \\frac{3}{17} $$\n为了求差，我们使用公分母 $425$，注意 $425 = 25 \\times 17$。\n$$ \\text{Advantage} = \\frac{78}{425} - \\frac{3 \\times 25}{17 \\times 25} = \\frac{78}{425} - \\frac{75}{425} = \\frac{3}{425} $$\n\n最后，我们将此分数表示为小数，并四舍五入到四位有效数字。\n$$ \\text{Advantage} = \\frac{3}{425} \\approx 0.0070588235... $$\n四舍五入到四位有效数字，我们确定第一个非零数字（$7$）及其后的三位数字（$058$）。第五位有效数字是$8$，它 $\\ge 5$，因此我们将最后一位数字（$8$）向上取整为$9$。\n四舍五入后的值为 $0.007059$。", "answer": "$$\\boxed{0.007059}$$", "id": "4551107"}, {"introduction": "一个预测模型在新的临床环境中使用时，其表现常常会因人群特征（如疾病患病率）的变化而下降。本练习旨在揭示模型校准度与患病率之间的深刻联系，并指导您推导出一个关键的校正方法，以调整模型使其适应目标人群。这项实践将理论与应用相结合，帮助您掌握在真实世界中部署预测模型时至关重要的一项技能。[@problem_id:4551063]", "problem": "一个二元放射组学分类器被训练用于通过逻辑回归从计算机断层扫描（CT）特征中预测恶性肿瘤。令 $\\mathbf{x}$ 表示特征向量。训练好的模型通过逻辑函数输出预测概率，其线性预测器为 $\\eta_{\\mathrm{train}}(\\mathbf{x}) = \\beta_{0} + \\beta^{\\top}\\mathbf{x}$，因此 $p_{\\mathrm{train}}(y=1 \\mid \\mathbf{x}) = \\frac{1}{1+\\exp\\!\\left(-\\eta_{\\mathrm{train}}(\\mathbf{x})\\right)}$。在外部验证中，您希望评估“广义校准”（calibration-in-the-large）并进行决策曲线分析（Decision Curve Analysis, DCA），但外部队列具有不同的疾病患病率。假设如下：\n\n- 外部队列表现出标签偏移（label shift）：对于 $y \\in \\{0,1\\}$，$p_{\\mathrm{target}}(\\mathbf{x} \\mid y) = p_{\\mathrm{train}}(\\mathbf{x} \\mid y)$，但 $p_{\\mathrm{target}}(y=1) = \\pi \\neq \\pi_{\\mathrm{train}}$。\n- 斜率参数 $\\beta$ 在不同队列中是稳定的，并且在训练分布下近似于对数似然比 $\\ln\\!\\left(\\frac{p(\\mathbf{x}\\mid y=1)}{p(\\mathbf{x}\\mid y=0)}\\right)$。\n- 广义校准定义为：为使平均预测概率等于观测患病率所需的截距偏移。\n\n从优势比形式的 Bayes 定理和逻辑连接函数的定义出发，推导类别患病率的变化如何导致表观广义校准的偏差，并获得将广义校准恢复到目标患病率 $\\pi$ 所需的截距校正 $\\beta_{0}^{*}$ 的闭式表达式。然后，给定训练截距 $\\beta_{0} = -0.2$、训练患病率 $\\pi_{\\mathrm{train}} = 0.30$ 和目标患病率 $\\pi = 0.12$，计算经数值校正后的截距 $\\beta_{0}^{*}$。将您的数值答案四舍五入到四位有效数字。将最终值表示为无量纲数。\n\n最后，根据 DCA 中净获益的标准定义，简要论证（无需额外计算）在固定阈值概率 $p_{t}$ 下，这种截距校正如何影响决策曲线分析（DCA）中的预期净获益。", "solution": "在尝试任何解决方案之前，对问题进行验证。\n\n### 步骤 1：提取已知条件\n-   分类器：二元逻辑回归。\n-   特征向量：$\\mathbf{x}$。\n-   训练模型线性预测器：$\\eta_{\\mathrm{train}}(\\mathbf{x}) = \\beta_{0} + \\beta^{\\top}\\mathbf{x}$。\n-   训练模型预测概率：$p_{\\mathrm{train}}(y=1 \\mid \\mathbf{x}) = \\frac{1}{1+\\exp(-\\eta_{\\mathrm{train}}(\\mathbf{x}))}$。\n-   标签偏移假设：对于 $y \\in \\{0,1\\}$，$p_{\\mathrm{target}}(\\mathbf{x} \\mid y) = p_{\\mathrm{train}}(\\mathbfx \\mid y)$。\n-   患病率偏移假设：$p_{\\mathrm{target}}(y=1) = \\pi \\neq \\pi_{\\mathrm{train}}$。\n-   斜率参数假设：$\\beta$ 是稳定的，并且在训练分布下近似于 $\\ln\\left(\\frac{p(\\mathbf{x}\\mid y=1)}{p(\\mathbf{x}\\mid y=0)}\\right)$。\n-   广义校准的定义：为使平均预测概率等于观测患病率所需的截距偏移。\n-   任务 1：推导校正后截距 $\\beta_{0}^{*}$ 的闭式表达式。\n-   任务 2：在给定 $\\beta_{0} = -0.2$、$\\pi_{\\mathrm{train}} = 0.30$ 和 $\\pi = 0.12$ 的条件下，计算 $\\beta_{0}^{*}$ 的数值。\n-   任务 3：论证该校正对决策曲线分析（DCA）净获益的影响。\n\n### 步骤 2：使用提取的已知条件进行验证\n-   **科学依据**：该问题基于统计建模的既定原则，特别是逻辑回归、数据集偏移（标签偏移）下的模型校准，以及通过决策曲线分析进行的临床效用评估。这些假设在关于预测模型可移植性的文献中是标准的。\n-   **适定性**：该问题是适定的。它提供了所有必要的定义、假设和数据，以推导所要求的公式、计算数值并提供定性论证。目标清晰明确。\n-   **客观性**：该问题以精确、客观和形式化的数学语言陈述。\n\n### 步骤 3：结论与行动\n该问题被认定为**有效**。将制定解决方案。\n\n### 校正截距 $\\beta_{0}^{*}$ 的推导\n推导始于优势比形式的 Bayes 定理，该定理将后验优势比与先验优势比和似然比联系起来：\n$$ \\frac{p(y=1 \\mid \\mathbf{x})}{p(y=0 \\mid \\mathbf{x})} = \\frac{p(\\mathbf{x} \\mid y=1)}{p(\\mathbf{x} \\mid y=0)} \\times \\frac{p(y=1)}{p(y=0)} $$\n对两边取自然对数，得到对数优势比（log-odds）或 logit：\n$$ \\ln\\left(\\frac{p(y=1 \\mid \\mathbf{x})}{1-p(y=1 \\mid \\mathbf{x})}\\right) = \\ln\\left(\\frac{p(\\mathbf{x} \\mid y=1)}{p(\\mathbf{x} \\mid y=0)}\\right) + \\ln\\left(\\frac{p(y=1)}{1-p(y=1)}\\right) $$\n该表达式可写为 $\\mathrm{logit}(p(y=1 \\mid \\mathbf{x})) = \\mathrm{log-LR}(\\mathbf{x}) + \\mathrm{logit_prevalence}$。\n\n对于训练队列，患病率为 $\\pi_{\\mathrm{train}}$。预测概率的 logit 由线性预测器 $\\eta_{\\mathrm{train}}(\\mathbf{x})$ 给出：\n$$ \\eta_{\\mathrm{train}}(\\mathbf{x}) = \\beta_{0} + \\beta^{\\top}\\mathbf{x} = \\ln\\left(\\frac{p_{\\mathrm{train}}(\\mathbf{x} \\mid y=1)}{p_{\\mathrm{train}}(\\mathbf{x} \\mid y=0)}\\right) + \\ln\\left(\\frac{\\pi_{\\mathrm{train}}}{1-\\pi_{\\mathrm{train}}}\\right) $$\n问题陈述，斜率参数 $\\beta$ 近似于对数似然比，即 $\\beta^{\\top}\\mathbf{x} \\approx \\ln\\left(\\frac{p_{\\mathrm{train}}(\\mathbf{x} \\mid y=1)}{p_{\\mathrm{train}}(\\mathbf{x} \\mid y=0)}\\right)$。这意味着对于一个校准良好的模型，截距 $\\beta_{0}$ 捕获了训练患病率的对数优势比：\n$$ \\beta_{0} \\approx \\ln\\left(\\frac{\\pi_{\\mathrm{train}}}{1-\\pi_{\\mathrm{train}}}\\right) $$\n现在，我们考虑具有不同患病率 $\\pi$ 的外部验证（目标）队列。我们给定标签偏移假设，$p_{\\mathrm{target}}(\\mathbf{x} \\mid y) = p_{\\mathrm{train}}(\\mathbf{x} \\mid y)$，这意味着似然比在不同队列中是守恒的。\n$$ \\frac{p_{\\mathrm{target}}(\\mathbf{x} \\mid y=1)}{p_{\\mathrm{target}}(\\mathbf{x} \\mid y=0)} = \\frac{p_{\\mathrm{train}}(\\mathbf{x} \\mid y=1)}{p_{\\mathrm{train}}(\\mathbf{x} \\mid y=0)} $$\n因此，目标队列中的真实 logit 为：\n$$ \\mathrm{logit}(p_{\\mathrm{target}}(y=1 \\mid \\mathbf{x})) = \\ln\\left(\\frac{p_{\\mathrm{train}}(\\mathbf{x} \\mid y=1)}{p_{\\mathrm{train}}(\\mathbf{x} \\mid y=0)}\\right) + \\ln\\left(\\frac{\\pi}{1-\\pi}\\right) $$\n为了恢复广义校准，我们需要找到一个新的截距 $\\beta_{0}^{*}$，使得新的线性预测器 $\\eta_{\\mathrm{target}}(\\mathbf{x}) = \\beta_{0}^{*} + \\beta^{\\top}\\mathbf{x}$ 等于目标人群中的真实 logit。\n$$ \\beta_{0}^{*} + \\beta^{\\top}\\mathbf{x} = \\ln\\left(\\frac{p_{\\mathrm{train}}(\\mathbf{x} \\mid y=1)}{p_{\\mathrm{train}}(\\mathbf{x} \\mid y=0)}\\right) + \\ln\\left(\\frac{\\pi}{1-\\pi}\\right) $$\n将 $\\beta^{\\top}\\mathbf{x} \\approx \\ln\\left(\\frac{p_{\\mathrm{train}}(\\mathbf{x} \\mid y=1)}{p_{\\mathrm{train}}(\\mathbf{x} \\mid y=0)}\\right)$ 代入方程，得到：\n$$ \\beta_{0}^{*} + \\ln\\left(\\frac{p_{\\mathrm{train}}(\\mathbf{x} \\mid y=1)}{p_{\\mathrm{train}}(\\mathbf{x} \\mid y=0)}\\right) \\approx \\ln\\left(\\frac{p_{\\mathrm{train}}(\\mathbf{x} \\mid y=1)}{p_{\\mathrm{train}}(\\mathbf{x} \\mid y=0)}\\right) + \\ln\\left(\\frac{\\pi}{1-\\pi}\\right) $$\n这简化为 $\\beta_{0}^{*} \\approx \\ln\\left(\\frac{\\pi}{1-\\pi}\\right)$。为了根据原始截距 $\\beta_{0}$ 找到更新后的截距，我们可以建立一个关系。原始的线性预测器是 $\\eta_{\\mathrm{train}}(\\mathbf{x})$。校正后的是 $\\eta_{\\mathrm{target}}(\\mathbf{x})$。\n$$ \\eta_{\\mathrm{target}}(\\mathbf{x}) = \\eta_{\\mathrm{train}}(\\mathbf{x}) - \\ln\\left(\\frac{\\pi_{\\mathrm{train}}}{1-\\pi_{\\mathrm{train}}}\\right) + \\ln\\left(\\frac{\\pi}{1-\\pi}\\right) $$\n代入线性预测器的表达式：\n$$ \\beta_{0}^{*} + \\beta^{\\top}\\mathbf{x} = (\\beta_{0} + \\beta^{\\top}\\mathbf{x}) - \\ln\\left(\\frac{\\pi_{\\mathrm{train}}}{1-\\pi_{\\mathrm{train}}}\\right) + \\ln\\left(\\frac{\\pi}{1-\\pi}\\right) $$\n项 $\\beta^{\\top}\\mathbf{x}$ 被消去，从而得出校正截距 $\\beta_{0}^{*}$ 的闭式表达式：\n$$ \\beta_{0}^{*} = \\beta_{0} + \\ln\\left(\\frac{\\pi}{1-\\pi}\\right) - \\ln\\left(\\frac{\\pi_{\\mathrm{train}}}{1-\\pi_{\\mathrm{train}}}\\right) = \\beta_{0} + \\ln\\left(\\frac{\\pi(1-\\pi_{\\mathrm{train}})}{\\pi_{\\mathrm{train}}(1-\\pi)}\\right) $$\n\n### 数值计算\n给定值 $\\beta_{0} = -0.2$、$\\pi_{\\mathrm{train}} = 0.30$ 和 $\\pi = 0.12$。将这些值代入推导出的表达式中：\n$$ \\beta_{0}^{*} = -0.2 + \\ln\\left(\\frac{0.12 \\times (1 - 0.30)}{0.30 \\times (1 - 0.12)}\\right) $$\n$$ \\beta_{0}^{*} = -0.2 + \\ln\\left(\\frac{0.12 \\times 0.70}{0.30 \\times 0.88}\\right) $$\n$$ \\beta_{0}^{*} = -0.2 + \\ln\\left(\\frac{0.084}{0.264}\\right) $$\n$$ \\beta_{0}^{*} = -0.2 + \\ln(0.318181\\overline{81}) $$\n$$ \\beta_{0}^{*} \\approx -0.2 - 1.14513 $$\n$$ \\beta_{0}^{*} \\approx -1.34513 $$\n四舍五入到四位有效数字，我们得到 $\\beta_{0}^{*} = -1.345$。\n\n### 关于对决策曲线分析（DCA）影响的论证\n决策曲线分析通过计算在一系列阈值概率 $p_t$ 下的净获益（Net Benefit, NB）来评估模型的临床效用。净获益定义为 $\\mathrm{NB}(p_t) = \\frac{\\mathrm{TP}}{N} - \\frac{\\mathrm{FP}}{N} \\left( \\frac{p_t}{1-p_t} \\right)$，其中 $\\mathrm{TP}$ 是真阳性数，$\\mathrm{FP}$ 是假阳性数，N 是总样本量。如果患者的预测概率超过 $p_t$，则将其分类为阳性。\n\n原始模型是在患病率为 $\\pi_{\\mathrm{train}} = 0.30$ 的队列上训练的。当应用于患病率较低（$\\pi = 0.12$）的目标队列时，该模型将系统性地高估每位患者的恶性肿瘤概率。这种不良的校准意味着，对于任何给定的阈值 $p_t$，模型都会将过多的患者分类为阳性，从而导致高假阳性率。在净获益公式中，一个高的 $\\mathrm{FP}$ 计数，乘以假阳性干预的危害权重 $\\frac{p_t}{1-p_t}$，会降低整体净获益。\n截距校正 $\\beta_{0}^{*}$ 通过降低每位患者的线性预测器 $\\eta$ 来重新校准模型，这反过来又降低了每位患者的预测概率。这一调整使平均预测概率与真实的目标患病率 $\\pi$ 保持一致。因此，对于固定的阈值 $p_t$，被分类为阳性的患者会减少。这尤其减少了由原始模型系统性高估所导致的假阳性数量。通过改善模型对目标人群的校准，截距校正可以带来更好的决策，这体现在更高的预期净获益上。由减少假阳性所带来的危害减少量，超过了相应减少的真阳性数量，从而提高了模型的临床效用。", "answer": "$$\\boxed{-1.345}$$", "id": "4551063"}, {"introduction": "在比较不同临床决策策略（如两个模型或模型与常规策略）时，仅比较其净获益的点估计值是不够的，我们还需要评估这些差异是否具有统计显著性。本练习将指导您完成一个完整的端到端分析流程：从生成模拟数据到使用非参数自助法（bootstrap）为净获益曲线构建置信区间。通过这项综合实践，您将学会如何稳健地评估和比较模型的临床实用性，从而做出更可靠的决策。[@problem_id:4551064]", "problem": "给定一个代表放射组学（radiomics）的二元分类场景，其中一个预测模型为每位患者分配一个恶性肿瘤概率。您必须形式化并实现决策曲线分析（Decision Curve Analysis, DCA），通过自助法（bootstrap）为预设分类阈值下的净获益曲线构建逐点置信区间，并操作化解释临床决策策略之间重叠的曲线。\n\n从以下基本基础开始：\n- 在二元分类中，真实标签为 $y \\in \\{0,1\\}$，在阈值 $t \\in (0,1)$ 下的预测类别为 $\\hat{y} \\in \\{0,1\\}$，给定策略在阈值 $t$ 的净获益定义为\n$$\n\\mathrm{NB}(t) = \\frac{\\mathrm{TP}(t)}{N} - \\frac{\\mathrm{FP}(t)}{N} \\cdot \\frac{t}{1-t},\n$$\n其中 $N$ 是总样本量，$\\mathrm{TP}(t)$ 是在阈值 $t$ 下的真阳性数量，$\\mathrm{FP}(t)$ 是在阈值 $t$ 下的假阳性数量。\n- 对于“全治”策略（将每个人都视为阳性），在阈值 $t$ 的净获益等于\n$$\n\\mathrm{NB}_{\\mathrm{TA}}(t) = \\hat{\\pi} - \\left(1-\\hat{\\pi}\\right)\\frac{t}{1-t},\n$$\n其中 $\\hat{\\pi}$ 是经验患病率 $\\hat{\\pi} = \\frac{1}{N}\\sum_{i=1}^{N} y_i$。\n- 对于“不治”策略（将每个人都视为阴性），对于所有 $t$，净获益恒为零，即 $\\mathrm{NB}_{\\mathrm{TN}}(t) = 0$。\n- 非参数自助法是一种重抽样方法，它通过从观测数据中有放回地重抽样来近似统计量的抽样分布。百分位法通过取自助法复制的经验 $\\alpha/2$ 和 $1-\\alpha/2$ 分位数来构建双侧置信区间。\n\n您的任务是实现以下端到端的过程。\n\n数据生成：\n1. 使用一个包含 $N = 500$ 名患者的样本，其二元结局为 $y \\in \\{0,1\\}$，经验患病率约为 $0.35$。对于 $i \\in \\{1,\\dots,N\\}$，独立地生成 $y_i \\sim \\mathrm{Bernoulli}(0.35)$。使用伪随机数生成器种子 $20240517$ 以确保可复现性。\n2. 按如下方式构建以 $y_i$ 为条件的模型 A 的预测概率 $p^{(A)}_i$：\n   - 如果 $y_i = 1$，从 $\\mathrm{Beta}(\\alpha_1,\\beta_1)$ 分布中抽取 $p^{(A)}_i$，其中 $(\\alpha_1,\\beta_1) = (5,2)$。\n   - 如果 $y_i = 0$，从 $\\mathrm{Beta}(\\alpha_0,\\beta_0)$ 分布中抽取 $p^{(A)}_i$，其中 $(\\alpha_0,\\beta_0) = (2,5)$。\n3. 构建模型 B，作为模型 A 的一个未校准的变换，通过逻辑斯蒂链接变换保留区分度。定义 logit 函数 $\\mathrm{logit}(x) = \\log\\left(\\frac{x}{1-x}\\right)$ 及其逆函数 $\\mathrm{logit}^{-1}(z) = \\frac{1}{1+e^{-z}}$。令\n$$\n\\mathrm{logit}\\left(p^{(B)}_i\\right) = a + b \\cdot \\mathrm{logit}\\left(p^{(A)}_i\\right),\n$$\n其中 $a = -0.2$ 且 $b = 1.5$。通过将 logit 函数的输入值裁剪到远离 $0$ 和 $1$ 的范围（例如 $[10^{-6}, 1-10^{-6}]$）来确保数值稳定性。\n\n策略和阈值：\n4. 考虑四种策略：模型 A（对 $p^{(A)}$ 使用阈值）、模型 B（对 $p^{(B)}$ 使用阈值）、全治策略和不治策略。\n5. 在阈值集合 $T = \\{0.01, 0.10, 0.33, 0.50, 0.90\\}$ 上评估决策。对于每个阈值 $t \\in T$，对于 $M \\in \\{\\text{A}, \\text{B}\\}$，通过 $\\hat{y}^{(M)}_i(t) = \\mathbb{1}\\{p^{(M)}_i \\ge t\\}$ 定义模型的预测类别，并使用上述定义计算 $\\mathrm{NB}^{(M)}(t)$。对于全治和不治策略，使用上面给出的表达式。\n\n自助法置信区间：\n6. 使用非参数自助法，设 $B = 1000$ 个复制。对于每个复制 $b \\in \\{1,\\dots,B\\}$，从 $N$ 名患者中有放回地重抽样以获得一个自助样本。对于每个 $t \\in T$ 和每种策略，计算自助净获益 $\\mathrm{NB}^{*,(M)}_b(t)$。\n7. 对于每个 $t \\in T$ 和每种策略，使用百分位法计算一个双侧逐点 $95\\%$ 置信区间，即 $\\{\\mathrm{NB}^{*,(M)}_b(t)\\}_{b=1}^{B}$ 在水平 $0.025$ 和 $0.975$ 的经验分位数。\n\n解释重叠曲线：\n8. 为了形式化判断两个策略在阈值 $t$ 是否可区分，考虑净获益的差异 $\\Delta(t) = \\mathrm{NB}^{(M_1)}(t) - \\mathrm{NB}^{(M_2)}(t)$。使用差异的自助法复制 $\\Delta^*_b(t) = \\mathrm{NB}^{*,(M_1)}_b(t) - \\mathrm{NB}^{*,(M_2)}_b(t)$ 来为 $\\Delta(t)$ 构建一个百分位 $95\\%$ 置信区间。当且仅当该区间的下界严格大于 $0$ 时，宣布 $M_1$ 在阈值 $t$ 优于 $M_2$。这种方法通过评估差异的不确定性来直接处理曲线之间的重叠，而不是视觉上比较边缘区间。\n\n测试套件和要求输出：\n- 使用固定的阈值 $T = \\{0.01, 0.10, 0.33, 0.50, 0.90\\}$ 作为测试套件。\n- 对于每个 $t \\in T$，使用所述的差异的自助法置信区间评估以下三个比较：\n  1. 模型 A vs. 模型 B。\n  2. 模型 A vs. 全治策略。\n  3. 模型 B vs. 全治策略。\n- 对于每个比较，输出一个布尔值，指示根据上述规则，第一个策略在阈值 $t$ 是否优于第二个策略。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。具体来说，对于按顺序 $0.01, 0.10, 0.33, 0.50, 0.90$ 迭代的 $t$，按以下顺序附加布尔值：模型 A 大于模型 B，模型 A 大于全治策略，模型 B 大于全治策略。例如，输出应类似于 $[b_1,b_2,\\dots,b_{15}]$，其中每个 $b_k$ 是 True 或 False。不应打印任何其他文本。\n- 所有量都是无单位的。内部将所有浮点数表示为实数；最终打印的值是指定的布尔值。\n\n注意：\n- 不涉及角度；您不得使用度或弧度。\n- 自助法置信区间对于 $t$ 是逐点的。您不得合并阈值或使用任何参数假设。", "solution": "目标是实现并应用决策曲线分析（DCA），这是一种在临床背景下根据净获益来评估和比较预测模型的方法。该分析涉及生成合成的患者数据，构建两个预测模型（一个校准良好，一个未校准），并将它们相互比较，并与两个基线策略（全治和不治）进行比较。净获益差异的统计显著性通过非参数自助法置信区间进行评估。\n\n程序步骤如下：数据生成、净获益计算、用于置信区间估计的自助法重抽样，以及策略的形式化比较。\n\n首先，我们生成一个包含 $N=500$ 名患者的合成数据集。每位患者 $i$ 的真实二元结局 $y_i \\in \\{0, 1\\}$ 从伯努利分布中抽取，患病率为 $0.35$。具体来说，$y_i \\sim \\mathrm{Bernoulli}(p)$，其中 $p=0.35$。使用指定的伪随机数生成器种子 $20240517$ 以确保可复现性。\n\n其次，我们为两个模型（模型 A 和模型 B）构建预测概率。这些概率是根据真实结局 $y_i$ 条件生成的。\n对于模型 A，预测概率 $p^{(A)}_i$ 从 Beta 分布中抽取，这是建模概率的标准选择。如果患者有该状况（$y_i=1$），则概率从参数为 $(\\alpha_1, \\beta_1) = (5, 2)$ 的 $\\mathrm{Beta}(\\alpha_1, \\beta_1)$ 分布中抽取。如果患者没有该状况（$y_i=0$），则概率从参数为 $(\\alpha_0, \\beta_0) = (2, 5)$ 的 $\\mathrm{Beta}(\\alpha_0, \\beta_0)$ 分布中抽取。选择这些参数是为了使模型的预测对于阳性病例平均高于阴性病例，从而表明具有区分能力。\n\n对于模型 B，预测概率 $p^{(B)}_i$ 是通过对模型 A 的概率应用逻辑斯蒂变换来创建的。此过程旨在模拟预测建模中的一个常见问题：未校准，即模型的区分度得以保留，但其概率被系统性地扭曲。该变换由以下方程定义：\n$$\n\\mathrm{logit}\\left(p^{(B)}_i\\right) = a + b \\cdot \\mathrm{logit}\\left(p^{(A)}_i\\right)\n$$\n其中 $\\mathrm{logit}(x) = \\log\\left(\\frac{x}{1-x}\\right)$，参数给定为 $a = -0.2$ 和 $b = 1.5$。logit 函数的输入被裁剪到远离 $0$ 和 $1$ 的一个小区间，例如 $[10^{-6}, 1-10^{-6}]$，以保持数值稳定性。\n\n第三，我们定义净获益指标。对于给定的风险阈值 $t \\in (0, 1)$，基于模型的策略建议在 $p_i \\ge t$ 时进行治疗。这种策略的净获益由下式给出：\n$$\n\\mathrm{NB}(t) = \\frac{\\mathrm{TP}(t)}{N} - \\frac{\\mathrm{FP}(t)}{N} \\cdot \\frac{t}{1-t}\n$$\n其中 $N$ 是总样本量，$\\mathrm{TP}(t)$ 是在阈值 $t$ 下的真阳性数量，$\\mathrm{FP}(t)$ 是假阳性数量。项 $\\frac{t}{1-t}$ 代表在该阈值下结果的比值（odds），并作为假阳性的权重，在需要更高确定性才能采取行动的较高阈值处，对其施加更重的惩罚。\n\n我们还考虑两种参考策略：\n1.  全治：无论风险如何，每个人都接受治疗。其净获益为 $\\mathrm{NB}_{\\mathrm{TA}}(t) = \\hat{\\pi} - (1-\\hat{\\pi})\\frac{t}{1-t}$，其中 $\\hat{\\pi}$ 是样本患病率 $\\frac{1}{N}\\sum y_i$。\n2.  不治：没有人接受治疗。其净获益始终为零，$\\mathrm{NB}_{\\mathrm{TN}}(t) = 0$。\n这些策略在一组指定的阈值 $T = \\{0.01, 0.10, 0.33, 0.50, 0.90\\}$ 上进行评估。\n\n第四，为了评估净获益估计的统计不确定性，我们采用非参数自助法。这包括通过从原始数据元组 $(y_i, p^{(A)}_i, p^{(B)}_i)$ 中有放回地重抽样，创建 $B=1000$ 个新数据集。对于每个自助样本和每个阈值 $t \\in T$，我们计算所有四种策略（模型 A、模型 B、全治、不治）的净获益。这个过程为每个策略-阈值对产生了 $B$ 个净获益的自助法复制，例如 $\\{\\mathrm{NB}^{*,(M)}_b(t)\\}_{b=1}^{B}$。\n\n最后，我们形式化了在给定阈值 $t$ 下两种策略 $M_1$ 和 $M_2$ 之间的比较。我们不比较它们各自的置信区间（如果它们重叠，可能会产生误导），而是直接分析其净获益差异的分布，$\\Delta(t) = \\mathrm{NB}^{(M_1)}(t) - \\mathrm{NB}^{(M_2)}(t)$。使用自助法复制，我们为这个差异生成一个经验分布：$\\Delta^*_b(t) = \\mathrm{NB}^{*,(M_1)}_b(t) - \\mathrm{NB}^{*,(M_2)}_b(t)$。通过找到 $\\{\\Delta^*_b(t)\\}_{b=1}^{B}$ 分布的 $0.025$ 和 $0.975$ 分位数，为 $\\Delta(t)$ 构建一个双侧 $95\\%$ 百分位法置信区间。优越性的决策规则是：当且仅当其净获益差异的 $95\\%$ 置信区间的下界严格大于 $0$ 时，策略 $M_1$ 被宣布在阈值 $t$ 优于策略 $M_2$。\n\n该算法首先生成单个合成数据集。然后，它进入一个进行 $B=1000$ 次迭代的自助循环。在每次迭代中，它重抽样数据并计算所有策略在所有阈值下的净获益。循环结束后，它使用存储的自助结果来计算策略之间（模型 A vs. 模型 B、模型 A vs. 全治、模型 B vs. 全治）在每个阈值下的差异的置信区间。应用优越性规则，并将得到的布尔值按特定顺序收集以用于最终输出。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import beta\nfrom scipy.special import logit, expit\n\ndef solve():\n    \"\"\"\n    Implements the end-to-end Decision Curve Analysis (DCA) procedure as specified.\n    \"\"\"\n    # ------------------\n    # 1. Define Constants  Setup\n    # ------------------\n    N = 500\n    PREVALENCE = 0.35\n    SEED = 20240517\n    \n    # Model A parameters\n    BETA_PARAMS_POS = {'a': 5, 'b': 2}\n    BETA_PARAMS_NEG = {'a': 2, 'b': 5}\n    \n    # Model B transformation parameters\n    LOGIT_A = -0.2\n    LOGIT_B = 1.5\n    CLIP_EPS = 1e-6\n    \n    # Analysis parameters\n    THRESHOLDS = [0.01, 0.10, 0.33, 0.50, 0.90]\n    B = 1000  # Number of bootstrap replicates\n    CI_ALPHA = 0.05\n\n    rng = np.random.default_rng(SEED)\n\n    # ------------------\n    # 2. Data Generation\n    # ------------------\n    # Generate true outcomes y\n    y = rng.binomial(1, PREVALENCE, size=N)\n    \n    # Generate Model A probabilities p_A conditional on y\n    pos_mask = (y == 1)\n    neg_mask = (y == 0)\n    n_pos = np.sum(pos_mask)\n    n_neg = N - n_pos\n\n    p_A = np.zeros(N, dtype=float)\n    p_A[pos_mask] = beta.rvs(a=BETA_PARAMS_POS['a'], b=BETA_PARAMS_POS['b'], size=n_pos, random_state=rng)\n    p_A[neg_mask] = beta.rvs(a=BETA_PARAMS_NEG['a'], b=BETA_PARAMS_NEG['b'], size=n_neg, random_state=rng)\n    \n    # Generate Model B probabilities p_B via logistic transformation\n    p_A_clipped = np.clip(p_A, CLIP_EPS, 1 - CLIP_EPS)\n    logit_p_A = logit(p_A_clipped)\n    logit_p_B = LOGIT_A + LOGIT_B * logit_p_A\n    p_B = expit(logit_p_B)\n\n    # ------------------\n    # 3. Net Benefit Helper Function\n    # ------------------\n    def calculate_net_benefit(y_true, p_pred, t):\n        \"\"\"Calculates net benefit for a model-based strategy.\"\"\"\n        n_samples = len(y_true)\n        if n_samples == 0:\n            return 0.0\n        \n        # Predictions based on threshold t\n        y_pred = p_pred >= t\n        \n        # TP and FP counts\n        # Cast y_true to boolean for bitwise operations\n        y_true_bool = y_true.astype(bool)\n        tp_count = np.sum(y_pred  y_true_bool)\n        fp_count = np.sum(y_pred  ~y_true_bool)\n\n        # Net Benefit formula\n        return (tp_count / n_samples) - (fp_count / n_samples) * t / (1 - t)\n\n    # ------------------\n    # 4. Bootstrap Procedure\n    # ------------------\n    # Store data for easy resampling\n    all_data = np.column_stack((y, p_A, p_B))\n    \n    # Dictionary to store bootstrap replicates of net benefits\n    # Structure: {threshold: {'model_a': [...], 'model_b': [...], 'treat_all': [...]}}\n    boot_nb_results = {t: {'a': [], 'b': [], 'ta': []} for t in THRESHOLDS}\n\n    for _ in range(B):\n        # Create a bootstrap sample\n        indices = rng.choice(N, size=N, replace=True)\n        boot_sample = all_data[indices]\n        y_boot, p_a_boot, p_b_boot = boot_sample[:, 0], boot_sample[:, 1], boot_sample[:, 2]\n\n        for t in THRESHOLDS:\n            # Net benefit for Model A\n            nb_a = calculate_net_benefit(y_boot, p_a_boot, t)\n            boot_nb_results[t]['a'].append(nb_a)\n\n            # Net benefit for Model B\n            nb_b = calculate_net_benefit(y_boot, p_b_boot, t)\n            boot_nb_results[t]['b'].append(nb_b)\n            \n            # Net benefit for Treat-All strategy\n            pi_hat_boot = np.mean(y_boot)\n            if pi_hat_boot > 0: # Avoid issues if bootstrap sample has no positive cases\n                nb_ta = pi_hat_boot - (1 - pi_hat_boot) * t / (1 - t)\n            else:\n                nb_ta = 0.0 # If prevalence is 0, NB is 0 for t>0.\n            boot_nb_results[t]['ta'].append(nb_ta)\n\n    # ------------------\n    # 5. Interpretation and Final Output\n    # ------------------\n    final_results = []\n    \n    for t in THRESHOLDS:\n        # Convert lists to numpy arrays for vectorized operations\n        nb_a_boots = np.array(boot_nb_results[t]['a'])\n        nb_b_boots = np.array(boot_nb_results[t]['b'])\n        nb_ta_boots = np.array(boot_nb_results[t]['ta'])\n\n        # Comparison 1: Model A vs Model B\n        delta_ab = nb_a_boots - nb_b_boots\n        ci_lower_ab = np.quantile(delta_ab, CI_ALPHA / 2)\n        final_results.append(ci_lower_ab > 0)\n\n        # Comparison 2: Model A vs Treat-All\n        delta_ata = nb_a_boots - nb_ta_boots\n        ci_lower_ata = np.quantile(delta_ata, CI_ALPHA / 2)\n        final_results.append(ci_lower_ata > 0)\n        \n        # Comparison 3: Model B vs Treat-All\n        delta_bta = nb_b_boots - nb_ta_boots\n        ci_lower_bta = np.quantile(delta_bta, CI_ALPHA / 2)\n        final_results.append(ci_lower_bta > 0)\n\n    # Print results in the specified single-line format\n    print(f\"[{','.join(map(str, final_results))}]\")\n\nsolve()\n```", "id": "4551064"}]}