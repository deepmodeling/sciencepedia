## 引言
在医学研究，特别是影像组学领域，准确预测患者从诊断到某一关键事件（如疾病进展或死亡）发生的时间至关重要。分析这类“时间-事件”数据需要专门的统计工具，而由 David Cox 提出的[比例风险模型](@entry_id:171806)正是其中应用最广泛、功能最强大的方法之一。然而，要正确应用并解读其结果，需要深入理解其背后的统计原理、核心假设以及应对复杂数据情境的扩展能力。本文旨在填补理论与实践之间的鸿沟，为读者提供一个关于[Cox模型](@entry_id:164053)的全面指南。

本文将通过以下章节逐步展开：
- **原理与机制**：我们将从生存分析的基础概念出发，系统推导Cox模型的数学形式，阐释其半参数特性，并详细介绍基于部分似然法的[参数估计](@entry_id:139349)过程。此外，本章还将探讨[比例风险假设](@entry_id:163597)的检验及因果推断中的注意事项。
- **应用与跨学科联系**：本章将展示[Cox模型](@entry_id:164053)在临床研究、流行病学和高维影像组学中的实际应用，包括风险因素量化、个体化生存预测，以及如何通过[正则化方法](@entry_id:150559)应对高维挑战。同时，我们还会介绍分层、时依性协变量和竞争风险等高级扩展模型。
- **动手实践**：通过一系列精心设计的练习，本章将帮助读者巩固核心概念，如风险集的构建、风险比[置信区间](@entry_id:138194)的计算以及[比例风险假设](@entry_id:163597)的诊断检验，从而将理论知识转化为实践技能。

通过学习本文，读者将能够掌握Cox比例风险模型的理论精髓，并具备在科研实践中严谨应用和批判性评估该模型的能力。

## 原理与机制

在深入探讨用于生存预测的 Cox [比例风险模型](@entry_id:171806)之前，我们必须首先掌握生存分析的基本概念。本章将系统地阐述这些核心原理，从生存、风险和删失数据的基本定义开始，逐步构建 Cox 模型的理论框架，并最终探讨其[参数估计](@entry_id:139349)、[模型诊断](@entry_id:136895)及因果推断的深层机制。

### 生存分析的基础模块

生存分析的核心是描述和建模直到某个事件发生所经过的时间。为了严谨地处理“事件时间”数据，我们需要定义三个关键函数：生存函数、风险函数和[累积风险函数](@entry_id:169734)。

#### 生存、风险与累积风险

让我们设想一个临床研究，其中 $T$ 是一个非负随机变量，表示从某个时间起点（如诊断或治疗开始）到特定事件（如疾病进展或死亡）发生的时间。对于一个具有特定协变量（例如，一组影像组学特征）向量 $\boldsymbol{x}$ 的个体，我们可以定义以下函数：

- **生存函数 (Survival Function)** $S(t \mid \boldsymbol{x})$，定义为在给定协变量 $\boldsymbol{x}$ 的条件下，个体生存时间超过 $t$ 的概率。从概率论的第一性原理出发，这可以写作：
  $$
  S(t \mid \boldsymbol{x}) = \mathbb{P}(T > t \mid \boldsymbol{x})
  $$
  生存函数是一个单调递减的函数，其在 $t=0$ 时的值为 $S(0 \mid \boldsymbol{x}) = 1$（在研究开始时所有个体都存活），并随着 $t \to \infty$ 趋近于 $0$。

- **风险函数 (Hazard Function)** $h(t \mid \boldsymbol{x})$，也称为风险率或瞬时事件率。它描述了在给定协变量 $\boldsymbol{x}$ 且已存活至时间 $t$ 的条件下，在下一个极小时间间隔 $[t, t+\Delta t)$ 内发生事件的瞬时概率。其严格定义为：
  $$
  h(t \mid \boldsymbol{x}) = \lim_{\Delta t \to 0^{+}} \frac{\mathbb{P}(t \le T  t+\Delta t \mid T \ge t, \boldsymbol{x})}{\Delta t}
  $$
  [风险函数](@entry_id:166593) $h(t \mid \boldsymbol{x})$ 不是一个概率（它可以大于1），而是一个率，单位为“事件数/单位时间”。它捕捉了在任意时间点 $t$ 事件发生的“风险强度”。

- **[累积风险函数](@entry_id:169734) (Cumulative Hazard Function)** $H(t \mid \boldsymbol{x})$，表示到时间 $t$ 为止累积的总风险。它是瞬时[风险函数](@entry_id:166593)从时间起点 $0$ 到时间 $t$ 的积分：
  $$
  H(t \mid \boldsymbol{x}) = \int_{0}^{t} h(u \mid \boldsymbol{x}) \, \mathrm{d}u
  $$
  [累积风险函数](@entry_id:169734)是一个[非递减函数](@entry_id:202520)，从 $H(0 \mid \boldsymbol{x}) = 0$ 开始，随时间累积风险。

这三个函数通过深刻的数学关系联系在一起。可以证明，风险函数是生存函数对数负导数，即 $h(t \mid \boldsymbol{x}) = -\frac{\mathrm{d}}{\mathrm{d}t} \ln S(t \mid \boldsymbol{x})$。通过对这个关系式进行积分，我们可以建立生存函数和[累积风险函数](@entry_id:169734)之间的核心联系 [@problem_id:4534746]：
$$
S(t \mid \boldsymbol{x}) = \exp(-H(t \mid \boldsymbol{x}))
$$
同时，对[累积风险函数](@entry_id:169734)求导可以直接得到瞬时风险函数：
$$
h(t \mid \boldsymbol{x}) = \frac{\mathrm{d}}{\mathrm{d}t} H(t \mid \boldsymbol{x})
$$
这些关系构成了所有生存模型（包括 Cox 模型）的数学基石，使我们能够在这三个描述风险与生存的核心概念之间灵活转换。

#### [生存数据](@entry_id:165675)的复杂结构：删失与截断

在影像组学科研等实际应用中，我们很少能观察到所有研究对象的完整事件时间。数据经常是不完整的，主要表现为**[右删失](@entry_id:164686) (right-censoring)** 和 **左截断 (left-truncation)**。

**[右删失](@entry_id:164686)** 是最常见的数据不完整类型。当我们在事件发生前就停止了对某个体的观察时，就会发生右删失。这可能是因为研究在预定日期结束（行政删失），或者患者因搬家、退出研究等原因失访。在这种情况下，我们只知道该患者的真实事件时间 $T^*$ 大于我们观察到的最后时间点 $C$。因此，我们记录的观测时间 $Y$ 是真实事件时间 $T^*$ 和删失时间 $C$ 中的较小者，即 $Y = \min(T^*, C)$。为了区分事件和删失，我们引入一个**事件指示符 (event indicator)** $\Delta$，如果事件被观察到（即 $T^* \le C$），则 $\Delta=1$；如果观测被删失（即 $T^* > C$），则 $\Delta=0$。因此，每个研究对象提供的数据通常是一个数据对 $(Y, \Delta)$。

为了使基于这些[删失数据](@entry_id:173222)的[统计推断](@entry_id:172747)有效，我们必须做出**非信息性删失 (non-informative censoring)** 的假设 [@problem_id:4534791]。这个假设并不意味着删失是完全随机的，而是指在给定已测量的协变量 $\boldsymbol{X}$ 的条件下，删失机制本身不提供关于个体未来事件风险的额外信息。其数学表达为真实事件时间 $T^*$ 和删失时间 $C$ 在给定协变量 $\boldsymbol{X}$ 时条件独立：
$$
T^* \perp C \mid \boldsymbol{X}
$$
例如，由于影像设备维护或节假日导致的随访中断通常满足此假设。然而，如果一个患者因为病情急剧恶化（未被基线影像组学特征 $\boldsymbol{X}$ 完全捕捉）而无法继续参加随访，那么这次失访就可能是信息性的，因为它预示着更高的事件风险，从而违反了该假设。

**左截断**，也称为**延迟进入 (delayed entry)**，发生在研究对象并非在时间起点 $t=0$ 就进入研究队列，而是在之后的某个时间点 $E_i$ 才开始被观察。这种情况在回顾性研究或患者分批入组的研究中非常普遍。只有那些在入组时 $E_i$ 仍然存活（即 $T_i^* \ge E_i$）的患者才会被纳入分析。对于这些患者，他们的风险期从 $E_i$ 开始计算，而不是从原始的 $t=0$ 开始。对于一个同时存在左截断和[右删失](@entry_id:164686)的研究，患者 $i$ 提供的观测数据是从其入组时间 $E_i$ 开始计算的随访时长 $T_i$ 和事件指示符 $\delta_i$ [@problem_id:4534741]。其构造如下：
$$
T_i = \min(T_i^*, C_i) - E_i, \quad \delta_i = \mathbb{I}(T_i^* \le C_i)
$$
这个数据对只对满足 $T_i^* \ge E_i$ 条件的患者有定义。

### Cox [比例风险模型](@entry_id:171806)

1972年，统计学家 David Cox 提出了一种革命性的生存分析方法，即[比例风险模型](@entry_id:171806)。该模型的核心优势在于它能够在不预先假设基线风险具体形态的情况下，评估协变量对生存风险的影响。

#### 模型形式的推导

Cox 模型建立在一个关键假设之上：**[比例风险假设](@entry_id:163597) (Proportional Hazards Assumption)**。该假设认为，对于任意两个具有不同协变量向量 $\boldsymbol{x}_1$ 和 $\boldsymbol{x}_2$ 的个体，他们的[风险函数](@entry_id:166593)之比不随时间变化，即是一个常数。
$$
\frac{h(t \mid \boldsymbol{x}_1)}{h(t \mid \boldsymbol{x}_2)} = \text{constant for all } t
$$
为了从这个假设导出模型的具体形式，我们选择一个**基线 (baseline)** 或参考个体，其协变量向量为 $\boldsymbol{x} = \boldsymbol{0}$。我们将该个体的风险函数定义为**基线[风险函数](@entry_id:166593) (baseline hazard function)**，记为 $h_0(t) \equiv h(t \mid \boldsymbol{x} = \boldsymbol{0})$。现在，将任意一个个体与基线个体进行比较，根据[比例风险假设](@entry_id:163597)，我们有：
$$
\frac{h(t \mid \boldsymbol{x})}{h_0(t)} = g(\boldsymbol{x})
$$
其中 $g(\boldsymbol{x})$ 是一个只依赖于协变量 $\boldsymbol{x}$ 而不依赖于时间 $t$ 的函数，它代表了相对于基线风险的**相对风险 (relative risk)** 或**风险比 (hazard ratio)**。

整理上式，我们得到[风险函数](@entry_id:166593)的一个分离形式：
$$
h(t \mid \boldsymbol{x}) = h_0(t) \cdot g(\boldsymbol{x})
$$
模型进一步假设，协变量通过一种对数线性的方式影响相对风险，即 $\ln(g(\boldsymbol{x}))$ 是 $\boldsymbol{x}$ 的[线性组合](@entry_id:155091)。这等价于：
$$
g(\boldsymbol{x}) = \exp(\beta_1 x_1 + \beta_2 x_2 + \dots + \beta_p x_p) = \exp(\boldsymbol{x}^\top \boldsymbol{\beta})
$$
将此式代回，我们便得到了 Cox [比例风险模型](@entry_id:171806)的经典形式 [@problem_id:4534716]：
$$
h(t \mid \boldsymbol{x}) = h_0(t) \exp(\boldsymbol{x}^\top \boldsymbol{\beta})
$$
其中，$\boldsymbol{\beta}$ 是一个需要从数据中估计的系数向量。

#### 模型组成与解读

Cox 模型由两个核心部分构成：

1.  **基线风险函数 $h_0(t)$**：这是一个非参数部分，它描述了当所有协变量取值为零时（即 $\boldsymbol{x}=\boldsymbol{0}$）的潜在风险随时间的变化规律。它可以是任意非负函数，捕捉了事件风险的内在时间动态，例如术后感染风险可能在早期很高，之后逐渐下降。Cox 模型不对 $h_0(t)$ 的具体形式做任何假定，这是其强大灵活性的来源。

2.  **相对风险部分 $\exp(\boldsymbol{x}^\top \boldsymbol{\beta})$**：这是一个参数部分，其中 $\boldsymbol{x}^\top \boldsymbol{\beta}$ 被称为**线性预测子 (linear predictor)** 或**风险得分 (risk score)** [@problem_id:4534742]。整个指数项 $\exp(\boldsymbol{x}^\top \boldsymbol{\beta})$ 是**风险比 (Hazard Ratio, HR)**，它量化了具有协变量 $\boldsymbol{x}$ 的个体相对于基线个体的风险倍数。由于[比例风险假设](@entry_id:163597)，这个风险比是**不随时间变化的 (time-invariant)** [@problem_id:4534743]。例如，如果 $\exp(\beta_k) = 2$，则意味着协变量 $x_k$ 每增加一个单位，在任何时间点 $t$，个体的瞬时事件风险都会变为原来的两倍，前提是其他协变量保持不变。值得强调的是，风险比是瞬时事件率之比，而不是生存概率之比，混淆这两者是一个常见的错误。

由于该模型结合了参数部分（$\boldsymbol{\beta}$）和非参数部分（$h_0(t)$），它被称为**[半参数模型](@entry_id:200031) (semi-parametric model)** [@problem_id:4534716]。

### 参数估计：部分似然法

Cox 模型的一个天才之处在于，它允许我们在不知道（也无需估计）基线[风险函数](@entry_id:166593) $h_0(t)$ 的情况下，就能估计出系数向量 $\boldsymbol{\beta}$。这通过 **部分似然法 (partial likelihood)** 实现。

#### 风险集

理解部分似然法的关键是**风险集 (risk set)** 的概念。在任何一个发生事件的时间点 $t_{(k)}$，风险集 $R(t_{(k)})$ 由所有在该时间点之前既没有发生事件也没有被删失，且已经进入研究的个体组成。换言之，他们是“有资格”在 $t_{(k)}$ 时刻经历事件的全体成员。

对于包含左截断（进入时间 $L_i$）和[右删失](@entry_id:164686)（观测结束时间 $X_i$）的数据，个体 $i$ 在时间 $t$ 处于风险中，当且仅当该个体已经进入研究且尚未发生事件或被删失，即 $L_i \le t$ 且 $X_i \ge t$。因此，在第 $k$ 个唯一事件时间 $t_{(k)}$ 的风险集为 [@problem_id:4534778]：
$$
R(t_{(k)}) = \{i : L_i \le t_{(k)} \text{ 且 } X_i \ge t_{(k)}\}
$$
这个定义精确地包括了所有在 $t_{(k)}$ 时刻或之前进入研究，并且在该时刻仍然处于观察中（即尚未发生事件或被删失）的个体。

#### 部分似然的直觉与构建

部分似然法的核心思想是，在每个事件发生的时间点 $t_{(k)}$，我们不关注事件“为什么”在这一刻发生（这与 $h_0(t_{(k)})$ 有关），而是关注“谁”在这一刻发生了事件。

假设在时间 $t_{(k)}$，风险集 $R(t_{(k)})$ 中恰好有一个事件发生，并且这个事件发生在个体 $i$ 身上。我们可以构建一个条件概率：给定风险集 $R(t_{(k)})$ 中有一个事件发生，这个事件恰好发生在个体 $i$ 身上的概率是多少？

这个概率等于个体 $i$ 的风险占风险集中所有个体总风险的比例：
$$
\mathbb{P}(\text{个体 } i \text{ 在 } t_{(k)} \text{ 发生事件} \mid \text{一个事件在 } R(t_{(k)}) \text{ 中发生}) = \frac{h(t_{(k)} \mid \boldsymbol{x}_i)}{\sum_{j \in R(t_{(k)})} h(t_{(k)} \mid \boldsymbol{x}_j)}
$$
代入 Cox 模型 $h(t \mid \boldsymbol{x}) = h_0(t) \exp(\boldsymbol{x}^\top \boldsymbol{\beta})$，我们得到：
$$
= \frac{h_0(t_{(k)}) \exp(\boldsymbol{x}_i^\top \boldsymbol{\beta})}{\sum_{j \in R(t_{(k)})} h_0(t_{(k)}) \exp(\boldsymbol{x}_j^\top \boldsymbol{\beta})} = \frac{\exp(\boldsymbol{x}_i^\top \boldsymbol{\beta})}{\sum_{j \in R(t_{(k)})} \exp(\boldsymbol{x}_j^\top \boldsymbol{\beta})}
$$
神奇的事情发生了：未知的基线风险 $h_0(t_{(k)})$ 在分子和分母中被约掉了！[@problem_id:4534742] [@problem_id:5189316]。这个概率项只依赖于我们想要估计的参数 $\boldsymbol{\beta}$ 和观测数据。

**部分[似然函数](@entry_id:141927)**就是将所有[独立事件](@entry_id:275822)时间点的这些[条件概率](@entry_id:151013)项连乘起来。如果 $t_{(1)}, \dots, t_{(D)}$ 是所有唯一的事件时间，并且在每个时间点 $t_{(k)}$ 发生事件的个体是 $i_k$，则部分[似然函数](@entry_id:141927)为：
$$
L_p(\boldsymbol{\beta}) = \prod_{k=1}^{D} \frac{\exp(\boldsymbol{x}_{i_k}^\top \boldsymbol{\beta})}{\sum_{j \in R(t_{(k)})} \exp(\boldsymbol{x}_j^\top \boldsymbol{\beta})}
$$
（对于存在并列事件时间的情况，有相应的修正形式，如 Breslow 或 Efron 近似法）。通过最大化这个部分[似然函数](@entry_id:141927)（或其对数），我们可以得到 $\boldsymbol{\beta}$ 的估计值 $\hat{\boldsymbol{\beta}}$，而完全无需对 $h_0(t)$ 做任何处理。

### 模型应用与高级主题

一旦获得了系数 $\hat{\boldsymbol{\beta}}$，我们就可以进入模型的第二阶段：估计基线风险并进行个体化预测，以及进行[模型诊断](@entry_id:136895)和更深入的解释。

#### 估计基线风险与个体化预测

虽然估计 $\boldsymbol{\beta}$ 时绕过了 $h_0(t)$，但在进行预后预测时，我们仍然需要它。**Breslow 估计量**是一种用于非[参数估计](@entry_id:139349)**累积基线[风险函数](@entry_id:166593)** $H_0(t)$ 的方法。其思想是在每个事件时间点 $t_{(k)}$，将观测到的事件数 $d_k$（可能大于1，如果有并列事件）归因于风险集中所有成员的总风险。由此，在 $t_{(k)}$ 处的累积风险增量 $\Delta \hat{H}_0(t_{(k)})$ 被估计为 [@problem_id:5189316]：
$$
\Delta \hat{H}_0(t_{(k)}) = \frac{d_k}{\sum_{j \in R(t_{(k)})} \exp(\boldsymbol{x}_j^\top \hat{\boldsymbol{\beta}})}
$$
总的累积基线风险 $\hat{H}_0(t)$ 就是将所有不晚于 $t$ 的事件时间点的风险增量累加起来：
$$
\hat{H}_0(t) = \sum_{t_{(k)} \le t} \frac{d_k}{\sum_{j \in R(t_{(k)})} \exp(\boldsymbol{x}_j^\top \hat{\boldsymbol{\beta}})}
$$
得到 $\hat{H}_0(t)$ 后，我们可以立即计算出基线生存函数 $\hat{S}_0(t) = \exp(-\hat{H}_0(t))$。最后，对于一个具有新协变量向量 $\boldsymbol{x}_{\text{new}}$ 的个体，其生存函数可以被预测为：
$$
\hat{S}(t \mid \boldsymbol{x}_{\text{new}}) = \exp(-\hat{H}_0(t) \cdot \exp(\boldsymbol{x}_{\text{new}}^\top \hat{\boldsymbol{\beta}})) = [\hat{S}_0(t)]^{\exp(\boldsymbol{x}_{\text{new}}^\top \hat{\boldsymbol{\beta}})}
$$
这使得我们能够为每个个体绘制出其独特的预测生存曲线。

#### [比例风险假设](@entry_id:163597)的检验

[比例风险](@entry_id:166780)（PH）假设是 Cox 模型有效性的基石，因此必须在使用模型后对其进行检验。**非比例风险 (Non-proportional hazards)** 意味着某个协变量的影响力随时间而变化。例如，某个影像组学特征可能在治疗早期对预后有强烈影响，但随着时间推移其影响力逐渐减弱。

一种常用的检验方法是基于**Schoenfeld 残差**。对于每个事件时间 $t_{(k)}$ 和每个协变量 $x_j$，可以计算一个 Schoenfeld 残差，它衡量了在该时刻实际发生事件的个体（们）的协变量值与风险集中所有个体的期望协变量值之间的差异。如果 PH 假设成立，这些残差应该不随时间呈现任何系统性趋势 [@problem_id:4534767]。因此，通过绘制 Schoenfeld 残差与时间（或时间的函数，如 $\log(t)$）的散点图并检查是否存在非零斜率，可以直观地评估 PH 假设。

更形式化的方法是在 Cox 模型中加入一个**含时交互项 (time-dependent interaction term)** [@problem_id:4534763]。例如，要检验协变量 $x_k$ 的 PH 假设，我们可以构建一个扩展模型：
$$
h(t \mid \boldsymbol{x}) = h_0(t) \exp(\dots + \beta_k x_k + \gamma_k (x_k \cdot g(t)) + \dots)
$$
其中 $g(t)$ 是一个时间的函数，常用的选择是 $g(t)=\log(t)$。在这个模型中，$x_k$ 的对数风险比变为 $(\beta_k + \gamma_k \log t)$，它随时间变化。此时，PH 假设等价于检验零假设 $H_0: \gamma_k = 0$。如果通过 Wald 检验发现 $\gamma_k$ 的估计值显著不为零，我们就有证据拒绝 PH 假设，表明该协变量存在非[比例风险](@entry_id:166780)效应。

#### 因果推断与风险比的非可折叠性

在解释 Cox 模型的结果时，尤其是试图进行因果推断时，必须理解**风险比的非可折叠性 (non-collapsibility)** [@problem_id:4534764]。一个统计量如果其在调整了某个协变量后的条件效应不等于其未调整时的[边际效应](@entry_id:634982)，则称其为不可折叠的。风险比（以及优势比）就具有这种性质。

考虑一个包含二元处理变量 $X$（如是否应用某个影像组学衍生的治疗规则）和另一个协变量 $R$（如一个影像组学风险评分）的 Cox 模型：$h(t \mid X, R) = h_0(t) \exp(\beta X + \gamma R)$。
- **条件风险比**：在给定 $R$ 的某个固定水平上，处理 $X$ 的风险比是 $\exp(\beta)$，且不随时间变化。
- **边际风险比**：如果我们不考虑 $R$，直接比较 $X=1$ 组和 $X=0$ 组的总体风险比，这个边际风险比是通过对 $R$ 的分布进行积分平均得到的。

关键在于，即使在基线时 $X$ 和 $R$ 是独立的（例如通过随机化实现），随着时间的推移，由于生存选择效应（例如，高 $R$ 值的个体在两组中都更快地发生事件并退出风险集），在 $t>0$ 时的风险集中，$R$ 的分布在 $X=1$ 组和 $X=0$ 组之间会变得不同。这种动态变化导致边际风险比通常不等于条件风险比 $\exp(\beta)$，并且边际风险比本身还会随时间变化。

这意味着，即使在理想的随机化试验中，从多变量 Cox 模型中得到的 $\exp(\hat{\beta})$ 也应被解释为一个**条件因果效应**：即在保持其他协变量不变的情况下，处理对瞬时风险的[乘性](@entry_id:187940)影响。它并不等于一个**边际（或群体平均）因果效应**，也不能直接等同于对生存概率或累积事件风险的边际影响。理解这一点对于避免过度或不当的因果结论至关重要。