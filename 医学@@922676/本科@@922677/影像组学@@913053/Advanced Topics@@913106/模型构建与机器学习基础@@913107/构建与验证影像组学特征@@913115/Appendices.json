{"hands_on_practices": [{"introduction": "影像组学特征是构建预测模型的基石，但这些特征是如何从医学图像中计算出来的呢？本练习将揭开纹理特征提取的“黑箱”，指导您从一个简化的图像矩阵出发，亲手计算一个核心的纹理特征——灰度共生矩阵（$GLCM$）对比度。通过这个实践，您将深入理解图像的局部模式如何被量化为具体数值，以及计算参数（如位移向量）如何影响最终的特征值 [@problem_id:4531346]。", "problem": "一个单模态计算机断层扫描感兴趣区域已被强度量化为 $16$ 个灰度级箱，标记为 $1$ 到 $16$。考虑以下 $3 \\times 3$ 的箱索引平面内切片（在平面外方向上厚度为一个体素），其中第 $y$ 行第 $x$ 列的条目是在空间位置 $(x,y)$ 处的箱索引：\n$$\n\\begin{pmatrix}\n1  2  3\\\\\n2  2  4\\\\\n3  4  5\n\\end{pmatrix}.\n$$\n使用灰度共生矩阵 (GLCM) 的定义，通过对由界内体素对 $\\big(I(x,y),\\,I(x+1,y)\\big)$（以体素为单位）形成的有序对 $(i,j)$ 进行计数，为位移 $\\mathbf{d}_1=(1,0,0)$ 构建一个非对称共生矩阵。然后通过除以此类对的总数进行归一化，以获得概率矩阵 $P_{\\mathbf{d}_1}(i,j)$。对位移 $\\mathbf{d}_2=(1,1,0)$ 重复此过程，形成有序对 $\\big(I(x,y),\\,I(x+1,y+1)\\big)$ 并进行归一化以获得 $P_{\\mathbf{d}_2}(i,j)$。使用 GLCM 对比度特征的标准定义，计算每个位移的对比度，并报告比率\n$$\nr \\;=\\; \\frac{C(\\mathbf{d}_2)}{C(\\mathbf{d}_1)}.\n$$\n假设只计算界内对（无环绕），且不应用对称化。请提供 $r$ 的精确值，不要四舍五入。", "solution": "该问题定义明确，需要放射组学领域的标准计算。所有必要的数据和定义都已提供，没有科学或逻辑上的不一致性。因此，该问题是有效的。\n\n解题过程首先为每个位移向量构建灰度共生矩阵 (GLCM)。输入图像是一个 $3 \\times 3$ 的箱索引切片，记为 $I(x,y)$，其中 $x$ 是列索引（$1, 2, 3$），$y$ 是行索引（$1, 2, 3$）：\n$$\nI = \\begin{pmatrix}\n1  2  3\\\\\n2  2  4\\\\\n3  4  5\n\\end{pmatrix}\n$$\n灰度级数为 $N_g=16$。\n\n步骤 1：计算位移 $\\mathbf{d}_1=(1,0,0)$ 的 GLCM 和对比度。\n位移 $\\mathbf{d}_1=(1,0,0)$ 对应于一个体素的水平位移。我们通过考虑界内的体素对 $\\big(I(x,y), I(x+1,y)\\big)$ 来形成有序对 $(i,j)$。\n我们遍历有效的空间坐标 $(x,y)$。这里，$x$ 的取值范围是 $1$ 到 $2$，$y$ 的取值范围是 $1$ 到 $3$。\n这些对是：\n\\begin{itemize}\n    \\item 对于 $y=1$: $\\big(I(1,1), I(2,1)\\big)=(1,2)$; $\\big(I(2,1), I(3,1)\\big)=(2,3)$。\n    \\item 对于 $y=2$: $\\big(I(1,2), I(2,2)\\big)=(2,2)$; $\\big(I(2,2), I(3,2)\\big)=(2,4)$。\n    \\item 对于 $y=3$: $\\big(I(1,3), I(2,3)\\big)=(3,4)$; $\\big(I(2,3), I(3,3)\\big)=(4,5)$。\n\\end{itemize}\n对的总数是 $N_{\\mathbf{d}_1} = 6$。非对称 GLCM 计数矩阵 $G_{\\mathbf{d}_1}$ 将具有以下关于 $(i,j)$ 的非零条目：\n$G_{\\mathbf{d}_1}(1,2)=1$，$G_{\\mathbf{d}_1}(2,2)=1$，$G_{\\mathbf{d}_1}(2,3)=1$，$G_{\\mathbf{d}_1}(2,4)=1$，$G_{\\mathbf{d}_1}(3,4)=1$，$G_{\\mathbf{d}_1}(4,5)=1$。\n\n归一化概率矩阵为 $P_{\\mathbf{d}_1}(i,j) = G_{\\mathbf{d}_1}(i,j) / N_{\\mathbf{d}_1}$。因此，每个非零条目都是 $1/6$。\nGLCM 对比度特征定义为 $C = \\sum_{i=1}^{N_g} \\sum_{j=1}^{N_g} (i-j)^2 P(i,j)$。\n对于位移 $\\mathbf{d}_1$：\n$$\nC(\\mathbf{d}_1) = (1-2)^2 P_{\\mathbf{d}_1}(1,2) + (2-2)^2 P_{\\mathbf{d}_1}(2,2) + (2-3)^2 P_{\\mathbf{d}_1}(2,3) + (2-4)^2 P_{\\mathbf{d}_1}(2,4) + (3-4)^2 P_{\\mathbf{d}_1}(3,4) + (4-5)^2 P_{\\mathbf{d}_1}(4,5)\n$$\n$$\nC(\\mathbf{d}_1) = (-1)^2\\left(\\frac{1}{6}\\right) + (0)^2\\left(\\frac{1}{6}\\right) + (-1)^2\\left(\\frac{1}{6}\\right) + (-2)^2\\left(\\frac{1}{6}\\right) + (-1)^2\\left(\\frac{1}{6}\\right) + (-1)^2\\left(\\frac{1}{6}\\right)\n$$\n$$\nC(\\mathbf{d}_1) = \\frac{1}{6} \\left( 1 + 0 + 1 + 4 + 1 + 1 \\right) = \\frac{8}{6} = \\frac{4}{3}.\n$$\n\n步骤 2：计算位移 $\\mathbf{d}_2=(1,1,0)$ 的 GLCM 和对比度。\n位移 $\\mathbf{d}_2=(1,1,0)$ 对应于一个对角位移。我们通过考虑界内的体素对 $\\big(I(x,y), I(x+1,y+1)\\big)$ 来形成有序对 $(i,j)$。\n我们遍历有效的空间坐标 $(x,y)$。这里，$x$ 的取值范围是 $1$ 到 $2$，$y$ 的取值范围是 $1$ 到 $2$。\n这些对是：\n\\begin{itemize}\n    \\item 对于 $y=1$: $\\big(I(1,1), I(2,2)\\big)=(1,2)$; $\\big(I(2,1), I(3,2)\\big)=(2,4)$。\n    \\item 对于 $y=2$: $\\big(I(1,2), I(2,3)\\big)=(2,4)$; $\\big(I(2,2), I(3,3)\\big)=(2,5)$。\n\\end{itemize}\n对的总数是 $N_{\\mathbf{d}_2} = 4$。非对称 GLCM 计数矩阵 $G_{\\mathbf{d}_2}$ 将具有以下关于 $(i,j)$ 的非零条目：\n$G_{\\mathbf{d}_2}(1,2)=1$，$G_{\\mathbf{d}_2}(2,4)=2$，$G_{\\mathbf{d}_2}(2,5)=1$。\n\n归一化概率矩阵为 $P_{\\mathbf{d}_2}(i,j) = G_{\\mathbf{d}_2}(i,j) / N_{\\mathbf{d}_2}$。非零条目是：\n$P_{\\mathbf{d}_2}(1,2) = 1/4$，$P_{\\mathbf{d}_2}(2,4) = 2/4 = 1/2$，$P_{\\mathbf{d}_2}(2,5) = 1/4$。\n\n对于位移 $\\mathbf{d}_2$，对比度是：\n$$\nC(\\mathbf{d}_2) = (1-2)^2 P_{\\mathbf{d}_2}(1,2) + (2-4)^2 P_{\\mathbf{d}_2}(2,4) + (2-5)^2 P_{\\mathbf{d}_2}(2,5)\n$$\n$$\nC(\\mathbf{d}_2) = (-1)^2\\left(\\frac{1}{4}\\right) + (-2)^2\\left(\\frac{2}{4}\\right) + (-3)^2\\left(\\frac{1}{4}\\right)\n$$\n$$\nC(\\mathbf{d}_2) = \\frac{1}{4}\\left(1\\right) + \\frac{4}{4}\\left(2\\right) + \\frac{9}{4}\\left(1\\right) = \\frac{1+8+9}{4} = \\frac{18}{4} = \\frac{9}{2}.\n$$\n\n步骤 3：计算比率 $r$。\n问题要求计算比率 $r = C(\\mathbf{d}_2) / C(\\mathbf{d}_1)$。\n$$\nr = \\frac{C(\\mathbf{d}_2)}{C(\\mathbf{d}_1)} = \\frac{9/2}{4/3} = \\frac{9}{2} \\times \\frac{3}{4} = \\frac{27}{8}.\n$$\n比率的精确值是 $27/8$。", "answer": "$$\n\\boxed{\\frac{27}{8}}\n$$", "id": "4531346"}, {"introduction": "在提取了大量的影像组学特征后，一个关键问题随之而来：哪些特征是稳定且可重复的？许多特征对图像采集或感兴趣区域（$ROI$）勾画中的微小变化非常敏感，这使得它们在临床应用中并不可靠。本练习将介绍两个关键的稳定性评估指标：组内相关系数（$ICC$）和变异系数（$CV$），并指导您从头开始计算它们，以量化特征的稳健性 [@problem_id:4531341]。掌握这一技能对于筛选出高质量的特征，并最终构建一个可推广到不同数据集的影像组学模型至关重要。", "problem": "您将执行一项稳定性选择任务，该任务针对受模拟感兴趣区域（ROI）扰动影响的放射组学特征。对于每个受试者，每个特征都在多种扰动下被重复测量。您的目标是通过为每个特征计算两个稳定性指标来确定哪些特征在不同扰动和受试者之间是稳健的：变异系数和组内相关系数（ICC）。您必须从第一性原理出发，并从样本均值、样本方差和单因素方差分析（ANOVA）的核心定义推导出必要的计算。\n\n假设设置如下。有 $S$ 个受试者，每个受试者有 $K$ 次扰动，以及 $F$ 个特征。令 $x_{s,k,f}$ 表示在扰动 $k$ 下，受试者 $s$ 的特征 $f$ 的值，其中 $s \\in \\{0,\\dots,S-1\\}$，$k \\in \\{0,\\dots,K-1\\}$，且 $f \\in \\{0,\\dots,F-1\\}$。\n\n推导的基本依据：\n- 使用样本均值和样本方差的定义。对于一组 $K$ 次重复测量值 $\\{y_k\\}_{k=0}^{K-1}$，样本均值为 $m = \\frac{1}{K}\\sum_{k=0}^{K-1} y_k$，无偏样本方差为 $s^2 = \\frac{1}{K-1}\\sum_{k=0}^{K-1} (y_k - m)^2$，样本标准差为 $s = \\sqrt{s^2}$。\n- 使用跨受试者的重复测量的单因素方差分析分解来计算组内相关系数（ICC），类型为单因素随机效应、单一测量，此处记为 $ICC(1,1)$。推导过程必须从平方和与均方出发：即组间平方和与组内平方和及其各自的自由度，不得使用简化公式。\n\n需实现的定义：\n1. 对每个特征 $f$ 和受试者 $s$，计算跨扰动的受试者层面的变异系数：\n   - 计算样本均值 $\\mu_{s,f} = \\frac{1}{K}\\sum_{k=0}^{K-1} x_{s,k,f}$。\n   - 计算样本标准差 $\\sigma_{s,f} = \\sqrt{\\frac{1}{K-1}\\sum_{k=0}^{K-1} \\left(x_{s,k,f} - \\mu_{s,f}\\right)^2}$。\n   - 定义受试者 $s$ 和特征 $f$ 的变异系数为 $CV_{s,f} = \\frac{\\sigma_{s,f}}{|\\mu_{s,f}|}$（如果 $|\\mu_{s,f}| \\neq 0$）。如果 $|\\mu_{s,f}| = 0$ 且 $\\sigma_{s,f} = 0$，则设 $CV_{s,f} = 0$。如果 $|\\mu_{s,f}| = 0$ 且 $\\sigma_{s,f} > 0$，则定义 $CV_{s,f}$ 为 $+\\infty$。\n   - 通过取所有受试者结果的中位数，将其汇总为单个基于特征的值：$CV_f = \\operatorname{median}\\left(\\{CV_{s,f}\\}_{s=0}^{S-1}\\right)$。\n2. 对每个特征 $f$，通过跨受试者的单因素方差分析分解计算 $ICC(1,1)$：\n   - 对每个受试者 $s$，计算其在所有扰动下的均值：$\\bar{x}_{s,f} = \\frac{1}{K}\\sum_{k=0}^{K-1} x_{s,k,f}$。\n   - 计算总均值 $\\bar{x}_f = \\frac{1}{S}\\sum_{s=0}^{S-1} \\bar{x}_{s,f}$。\n   - 计算组间平方和 $SS_B = K \\sum_{s=0}^{S-1} \\left(\\bar{x}_{s,f} - \\bar{x}_f\\right)^2$，其自由度为 $df_B = S - 1$，因此当 $S \\ge 2$ 时，组间均方为 $MS_B = \\frac{SS_B}{df_B}$。\n   - 计算组内平方和 $SS_W = \\sum_{s=0}^{S-1}\\sum_{k=0}^{K-1} \\left(x_{s,k,f} - \\bar{x}_{s,f}\\right)^2$，其自由度为 $df_W = S\\,(K-1)$，因此当 $K \\ge 2$ 时，组内均方为 $MS_W = \\frac{SS_W}{df_W}$。\n   - 如下定义 $ICC_f$：如果 $MS_B = 0$ 且 $MS_W = 0$，则设 $ICC_f = 1$。否则，设\n     $$ ICC_f = \\frac{MS_B - MS_W}{MS_B + (K-1)\\,MS_W}. $$\n   在单因素随机效应模型下，此量反映了可归因于受试者间差异的方差比例。\n\n稳健性判定规则：\n- 给定阈值 $\\tau_{CV}$ 和 $\\tau_{ICC}$，一个特征 $f$ 被认为是稳健的，当且仅当 $CV_f \\le \\tau_{CV}$ 且 $ICC_f \\ge \\tau_{ICC}$。\n\n测试套件：\n- 使用 $S = 3$，$K = 4$，$F = 4$，数据 $x_{s,k,f}$ 按特征规定如下，按受试者（外层）、扰动（内层）列出，适用于每个特征索引 $f \\in \\{0,1,2,3\\}$：\n  - 特征 $f=0$:\n    - 受试者 $s=0$: $[\\,10.0,\\,10.1,\\,9.9,\\,10.0\\,]$\n    - 受试者 $s=1$: $[\\,12.0,\\,12.1,\\,11.9,\\,12.0\\,]$\n    - 受试者 $s=2$: $[\\,8.0,\\,8.1,\\,7.9,\\,8.0\\,]$\n  - 特征 $f=1$:\n    - 受试者 $s=0$: $[\\,5.0,\\,7.0,\\,3.0,\\,9.0\\,]$\n    - 受试者 $s=1$: $[\\,6.0,\\,10.0,\\,2.0,\\,8.0\\,]$\n    - 受试者 $s=2$: $[\\,4.0,\\,12.0,\\,1.0,\\,11.0\\,]$\n  - 特征 $f=2$:\n    - 受试者 $s=0$: $[\\,{-0.1},\\,0.1,\\,{-0.1},\\,0.1\\,]$\n    - 受试者 $s=1$: $[\\,{-0.2},\\,0.2,\\,{-0.2},\\,0.2\\,]$\n    - 受试者 $s=2$: $[\\,{-0.05},\\,0.05,\\,{-0.05},\\,0.05\\,]$\n  - 特征 $f=3$:\n    - 受试者 $s=0$: $[\\,7.0,\\,7.0,\\,7.0,\\,7.0\\,]$\n    - 受试者 $s=1$: $[\\,7.0,\\,7.0,\\,7.0,\\,7.0\\,]$\n    - 受试者 $s=2$: $[\\,7.0,\\,7.0,\\,7.0,\\,7.0\\,]$\n- 评估三种阈值情况以测试不同方面：\n  1. 情况 A：$\\tau_{CV} = 0.05$，$\\tau_{ICC} = 0.9$（一般情况）。\n  2. 情况 B：$\\tau_{CV} = 0.0$，$\\tau_{ICC} = 1.0$（允许精确相等的边界情况）。\n  3. 情况 C：$\\tau_{CV} = 0.55$，$\\tau_{ICC} = {-0.4}$（允许负 $ICC$ 但仍受 $CV$ 约束的边缘情况）。\n\n要求的最终输出格式：\n- 您的程序必须生成单行输出，其中包含一个整数列表的列表。每个内部列表分别包含情况 A、B 和 C 的稳健特征的升序索引。该行不得包含任何空白字符。例如，包含两种情况的输出可能看起来像 $[[0,2],[1]]$。对于本问题中的三种情况，要求的输出形式为 $[[\\dots],[\\dots],[\\dots]]$，整行无任何空格。", "solution": "该问题是有效的，因为它在科学上基于评估测量稳定性的标准统计方法（变异系数和组内相关系数），问题定义明确，提供了所有必要的数据和定义，并以客观、可形式化的方式呈现。我们按照要求，基于第一性原理进行逐步求解。\n\n任务是从一个数据集中识别出稳健的放射组学特征，该数据集包含 $S=3$ 个受试者、每个受试者 $K=4$ 次扰动、共 $F=4$ 个特征的测量值。令 $x_{s,k,f}$ 为受试者 $s$ 在扰动 $k$ 下的特征 $f$ 的值。如果一个特征的聚合变异系数 $CV_f$ 和其组内相关系数 $ICC_f$ 满足指定的阈值，则该特征是稳健的。\n\n**步骤 1：计算各特征的稳定性指标（$CV_f$ 和 $ICC_f$）**\n\n我们将为每个特征 $f \\in \\{0, 1, 2, 3\\}$ 计算 $CV_f$ 和 $ICC_f$。\n\n**特征 $f=0$**\n数据为：\n- 受试者 $s=0$: $[\\,10.0,\\,10.1,\\,9.9,\\,10.0\\,]$\n- 受试者 $s=1$: $[\\,12.0,\\,12.1,\\,11.9,\\,12.0\\,]$\n- 受试者 $s=2$: $[\\,8.0,\\,8.1,\\,7.9,\\,8.0\\,]$\n\n*1. 变异系数 ($CV_0$)*\n对于每个受试者 $s$，我们计算其在 $K=4$ 次扰动下的均值 $\\mu_{s,0}$ 和标准差 $\\sigma_{s,0}$。\n- 受试者 $s=0$：\n  - $\\mu_{0,0} = \\frac{1}{4}(10.0 + 10.1 + 9.9 + 10.0) = 10.0$。\n  - $\\sigma_{0,0}^2 = \\frac{1}{4-1}((10.0-10.0)^2 + (10.1-10.0)^2 + (9.9-10.0)^2 + (10.0-10.0)^2) = \\frac{1}{3}(0 + 0.01 + 0.01 + 0) = \\frac{0.02}{3}$。\n  - $\\sigma_{0,0} = \\sqrt{\\frac{0.02}{3}} \\approx 0.08165$。\n  - $CV_{0,0} = \\frac{\\sigma_{0,0}}{|\\mu_{0,0}|} = \\frac{\\sqrt{0.02/3}}{10.0} \\approx 0.008165$。\n- 受试者 $s=1$：\n  - $\\mu_{1,0} = \\frac{1}{4}(12.0 + 12.1 + 11.9 + 12.0) = 12.0$。\n  - $\\sigma_{1,0}^2 = \\frac{1}{3}((12.0-12.0)^2 + (12.1-12.0)^2 + (11.9-12.0)^2 + (12.0-12.0)^2) = \\frac{0.02}{3}$。\n  - $\\sigma_{1,0} = \\sqrt{\\frac{0.02}{3}} \\approx 0.08165$。\n  - $CV_{1,0} = \\frac{\\sigma_{1,0}}{|\\mu_{1,0}|} = \\frac{\\sqrt{0.02/3}}{12.0} \\approx 0.006804$。\n- 受试者 $s=2$：\n  - $\\mu_{2,0} = \\frac{1}{4}(8.0 + 8.1 + 7.9 + 8.0) = 8.0$。\n  - $\\sigma_{2,0}^2 = \\frac{1}{3}((8.0-8.0)^2 + (8.1-8.0)^2 + (7.9-8.0)^2 + (8.0-8.0)^2) = \\frac{0.02}{3}$。\n  - $\\sigma_{2,0} = \\sqrt{\\frac{0.02}{3}} \\approx 0.08165$。\n  - $CV_{2,0} = \\frac{\\sigma_{2,0}}{|\\mu_{2,0}|} = \\frac{\\sqrt{0.02/3}}{8.0} \\approx 0.010206$。\n聚合的 $CV_0$ 是各受试者层面 CV 的中位数：\n$CV_0 = \\operatorname{median}(\\{0.008165, 0.006804, 0.010206\\}) = 0.008165$。\n\n*2. 组内相关系数 ($ICC_0$)*\n我们进行单因素方差分析。受试者均值 $\\bar{x}_{s,0}$ 与上面计算的 $\\mu_{s,0}$ 相同：$\\bar{x}_{0,0}=10.0$，$\\bar{x}_{1,0}=12.0$，$\\bar{x}_{2,0}=8.0$。\n- 总均值：$\\bar{x}_0 = \\frac{1}{S}\\sum_{s=0}^{S-1} \\bar{x}_{s,0} = \\frac{1}{3}(10.0 + 12.0 + 8.0) = 10.0$。\n- 组间平方和 ($SS_B$)：$SS_B = K \\sum_{s=0}^{S-1} (\\bar{x}_{s,0} - \\bar{x}_0)^2 = 4 \\times ((10.0-10.0)^2 + (12.0-10.0)^2 + (8.0-10.0)^2) = 4 \\times (0 + 4 + 4) = 32$。\n- 组间均方 ($MS_B$)：$df_B = S-1 = 2$。$MS_B = \\frac{SS_B}{df_B} = \\frac{32}{2} = 16$。\n- 组内平方和 ($SS_W$)：$SS_W = \\sum_{s=0}^{S-1}\\sum_{k=0}^{K-1} (x_{s,k,0} - \\bar{x}_{s,0})^2 = \\sum_{s=0}^{S-1} (K-1)\\sigma_{s,0}^2 = 3 \\times (\\frac{0.02}{3}) \\times 3 = 0.06$。\n- 组内均方 ($MS_W$)：$df_W = S(K-1) = 3(3) = 9$。$MS_W = \\frac{SS_W}{df_W} = \\frac{0.06}{9} = \\frac{1}{150}$。\n- $ICC_0 = \\frac{MS_B - MS_W}{MS_B + (K-1)MS_W} = \\frac{16 - 1/150}{16 + (3)(1/150)} = \\frac{16 - 1/150}{16 + 1/50} = \\frac{2399/150}{2403/150} = \\frac{2399}{2403} \\approx 0.998335$。\n\n**特征 $f=1$**\n数据为：\n- 受试者 $s=0$: $[\\,5.0,\\,7.0,\\,3.0,\\,9.0\\,]$\n- 受试者 $s=1$: $[\\,6.0,\\,10.0,\\,2.0,\\,8.0\\,]$\n- 受试者 $s=2$: $[\\,4.0,\\,12.0,\\,1.0,\\,11.0\\,]$\n\n*1. 变异系数 ($CV_1$)*\n- 受试者 $s=0$：$\\mu_{0,1} = 6.0$，$\\sigma_{0,1}^2 = \\frac{20}{3}$，$\\sigma_{0,1} = \\sqrt{20/3}$。$CV_{0,1} = \\frac{\\sqrt{20/3}}{6.0} \\approx 0.43033$。\n- 受试者 $s=1$：$\\mu_{1,1} = 6.5$，$\\sigma_{1,1}^2 = \\frac{35}{3}$，$\\sigma_{1,1} = \\sqrt{35/3}$。$CV_{1,1} = \\frac{\\sqrt{35/3}}{6.5} \\approx 0.52548$。\n- 受试者 $s=2$：$\\mu_{2,1} = 7.0$，$\\sigma_{2,1}^2 = \\frac{86}{3}$，$\\sigma_{2,1} = \\sqrt{86/3}$。$CV_{2,1} = \\frac{\\sqrt{86/3}}{7.0} \\approx 0.76488$。\n$CV_1 = \\operatorname{median}(\\{0.43033, 0.52548, 0.76488\\}) = 0.52548$。\n\n*2. 组内相关系数 ($ICC_1$)*\n- 受试者均值：$\\bar{x}_{0,1}=6.0$，$\\bar{x}_{1,1}=6.5$，$\\bar{x}_{2,1}=7.0$。\n- 总均值：$\\bar{x}_1 = \\frac{1}{3}(6.0+6.5+7.0) = 6.5$。\n- $SS_B = 4 \\times ((6.0-6.5)^2 + (6.5-6.5)^2 + (7.0-6.5)^2) = 4 \\times (0.25+0+0.25) = 2$。\n- $MS_B = \\frac{2}{2} = 1$。\n- $SS_W = (4-1)(\\sigma_{0,1}^2 + \\sigma_{1,1}^2 + \\sigma_{2,1}^2) = 3(\\frac{20}{3} + \\frac{35}{3} + \\frac{86}{3}) = 20+35+86 = 141$。\n- $MS_W = \\frac{141}{9} = \\frac{47}{3}$。\n- $ICC_1 = \\frac{1 - 47/3}{1 + 3(47/3)} = \\frac{-44/3}{1+47} = \\frac{-44/3}{48} = -\\frac{44}{144} = -\\frac{11}{36} \\approx -0.30556$。\n\n**特征 $f=2$**\n数据为：\n- 受试者 $s=0$: $[\\,{-0.1},\\,0.1,\\,{-0.1},\\,0.1\\,]$\n- 受试者 $s=1$: $[\\,{-0.2},\\,0.2,\\,{-0.2},\\,0.2\\,]$\n- 受试者 $s=2$: $[\\,{-0.05},\\,0.05,\\,{-0.05},\\,0.05\\,]$\n\n*1. 变异系数 ($CV_2$)*\n对于所有受试者 $s \\in \\{0,1,2\\}$，均值 $\\mu_{s,2} = 0$。然而，由于测量值不全为零，标准差 $\\sigma_{s,2} > 0$。根据问题定义，如果 $|\\mu_{s,f}| = 0$ 且 $\\sigma_{s,f} > 0$，则 $CV_{s,f} = +\\infty$。\n- $CV_{0,2} = +\\infty$, $CV_{1,2} = +\\infty$, $CV_{2,2} = +\\infty$。\n$CV_2 = \\operatorname{median}(\\{+\\infty, +\\infty, +\\infty\\}) = +\\infty$。\n\n*2. 组内相关系数 ($ICC_2$)*\n- 受试者均值：$\\bar{x}_{0,2}=0$，$\\bar{x}_{1,2}=0$，$\\bar{x}_{2,2}=0$。\n- 总均值：$\\bar{x}_2 = 0$。\n- $SS_B = 4 \\times ((0-0)^2 + (0-0)^2 + (0-0)^2) = 0$。因此，$MS_B = 0$。\n- $SS_W$:\n  - $s=0: (-0.1)^2 + 0.1^2 + (-0.1)^2 + 0.1^2 = 0.04$。\n  - $s=1: (-0.2)^2 + 0.2^2 + (-0.2)^2 + 0.2^2 = 0.16$。\n  - $s=2: (-0.05)^2 + 0.05^2 + (-0.05)^2 + 0.05^2 = 0.01$。\n  - $SS_W = 0.04 + 0.16 + 0.01 = 0.21$。\n- $MS_W = \\frac{0.21}{9}$。\n- $ICC_2 = \\frac{0 - 0.21/9}{0 + 3(0.21/9)} = \\frac{-0.21/9}{3(0.21/9)} = -\\frac{1}{3}$。\n\n**特征 $f=3$**\n数据对于所有受试者和扰动都相同：$[\\,7.0,\\,7.0,\\,7.0,\\,7.0\\,]$。\n\n*1. 变异系数 ($CV_3$)*\n对于所有受试者 $s \\in \\{0,1,2\\}$，均值为 $\\mu_{s,3}=7.0$，标准差为 $\\sigma_{s,3}=0$。\n- $CV_{s,3} = \\frac{0}{|7.0|} = 0$。\n$CV_3 = \\operatorname{median}(\\{0, 0, 0\\}) = 0$。\n\n*2. 组内相关系数 ($ICC_3$)*\n- 受试者均值：$\\bar{x}_{0,3}=7.0$，$\\bar{x}_{1,3}=7.0$，$\\bar{x}_{2,3}=7.0$。\n- 总均值：$\\bar{x}_3 = 7.0$。\n- $SS_B = K \\sum (\\bar{x}_{s,3}-\\bar{x}_3)^2 = 0$。因此，$MS_B=0$。\n- $SS_W = \\sum\\sum(x_{s,k,3}-\\bar{x}_{s,3})^2 = 0$。因此，$MS_W=0$。\n我们遇到了 $MS_B = 0$ 且 $MS_W = 0$ 的特殊情况。根据问题定义，我们设置 $ICC_3 = 1$。\n\n**指标摘要**\n\n| 特征 $f$ | $CV_f$            | $ICC_f$               |\n|:-----------:|:-----------------:|:---------------------:|\n| $0$         | $\\approx 0.00817$ | $\\approx 0.99834$     |\n| $1$         | $\\approx 0.52548$ | $\\approx -0.30556$    |\n| $2$         | $+\\infty$         | $\\approx -0.33333$    |\n| $3$         | $0.0$             | $1.0$                 |\n\n**步骤 2：应用稳健性判定规则**\n\n我们现在根据三种情况的阈值来评估每个特征。\n\n**情况 A: $\\tau_{CV} = 0.05$, $\\tau_{ICC} = 0.9$**\n- 特征 $f=0$: $CV_0 \\approx 0.00817 \\le 0.05$ (真) 且 $ICC_0 \\approx 0.99834 \\ge 0.9$ (真) $\\implies$ **稳健**。\n- 特征 $f=1$: $CV_1 \\approx 0.52548 \\le 0.05$ (假) $\\implies$ 不稳健。\n- 特征 $f=2$: $CV_2 = +\\infty \\le 0.05$ (假) $\\implies$ 不稳健。\n- 特征 $f=3$: $CV_3 = 0.0 \\le 0.05$ (真) 且 $ICC_3 = 1.0 \\ge 0.9$ (真) $\\implies$ **稳健**。\n情况 A 的稳健特征索引：`[0, 3]`。\n\n**情况 B: $\\tau_{CV} = 0.0$, $\\tau_{ICC} = 1.0$**\n- 特征 $f=0$: $CV_0 \\approx 0.00817 \\le 0.0$ (假) $\\implies$ 不稳健。\n- 特征 $f=1$: $CV_1 \\approx 0.52548 \\le 0.0$ (假) $\\implies$ 不稳健。\n- 特征 $f=2$: $CV_2 = +\\infty \\le 0.0$ (假) $\\implies$ 不稳健。\n- 特征 $f=3$: $CV_3 = 0.0 \\le 0.0$ (真) 且 $ICC_3 = 1.0 \\ge 1.0$ (真) $\\implies$ **稳健**。\n情况 B 的稳健特征索引：`[3]`。\n\n**情况 C: $\\tau_{CV} = 0.55$, $\\tau_{ICC} = -0.4$**\n- 特征 $f=0$: $CV_0 \\approx 0.00817 \\le 0.55$ (真) 且 $ICC_0 \\approx 0.99834 \\ge -0.4$ (真) $\\implies$ **稳健**。\n- 特征 $f=1$: $CV_1 \\approx 0.52548 \\le 0.55$ (真) 且 $ICC_1 \\approx -0.30556 \\ge -0.4$ (真) $\\implies$ **稳健**。\n- 特征 $f=2$: $CV_2 = +\\infty \\le 0.55$ (假) $\\implies$ 不稳健。\n- 特征 $f=3$: $CV_3 = 0.0 \\le 0.55$ (真) 且 $ICC_3 = 1.0 \\ge -0.4$ (真) $\\implies$ **稳健**。\n情况 C 的稳健特征索引：`[0, 1, 3]`。\n\n**最终结果**\n\n最终输出是一个列表的列表，其中包含情况 A、B 和 C 的稳健特征的升序索引。\n- 情况 A: `[0, 3]`\n- 情况 B: `[3]`\n- 情况 C: `[0, 1, 3]`\n这编译成最终字符串 `[[0,3],[3],[0,1,3]]`。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes stability metrics for radiomic features and determines robustness\n    based on given thresholds.\n    \"\"\"\n    \n    # Define constants based on the problem statement.\n    S = 3  # Number of subjects\n    K = 4  # Number of perturbations\n    F = 4  # Number of features\n    \n    # Define the dataset as a 3D numpy array of shape (F, S, K).\n    X = np.array([\n        # Feature f=0: High ICC, low CV\n        [[10.0, 10.1, 9.9, 10.0],\n         [12.0, 12.1, 11.9, 12.0],\n         [8.0, 8.1, 7.9, 8.0]],\n        \n        # Feature f=1: Low ICC, high CV\n        [[5.0, 7.0, 3.0, 9.0],\n         [6.0, 10.0, 2.0, 8.0],\n         [4.0, 12.0, 1.0, 11.0]],\n        \n        # Feature f=2: Zero mean, leading to infinite CV\n        [[-0.1, 0.1, -0.1, 0.1],\n         [-0.2, 0.2, -0.2, 0.2],\n         [-0.05, 0.05, -0.05, 0.05]],\n         \n        # Feature f=3: No variation, perfect stability\n        [[7.0, 7.0, 7.0, 7.0],\n         [7.0, 7.0, 7.0, 7.0],\n         [7.0, 7.0, 7.0, 7.0]]\n    ])\n\n    # Define the threshold cases to test.\n    threshold_cases = [\n        # Case A: (tau_cv, tau_icc)\n        (0.05, 0.9),\n        # Case B:\n        (0.0, 1.0),\n        # Case C:\n        (0.55, -0.4)\n    ]\n    \n    feature_metrics = []\n\n    # Iterate through each feature to calculate its stability metrics (CV and ICC).\n    for f in range(F):\n        feature_data = X[f, :, :]  # Data for the current feature, shape (S, K)\n\n        # --- 1. Calculate Coefficient of Variation (CV) ---\n        cv_per_subject = []\n        for s in range(S):\n            subject_data = feature_data[s, :]\n            \n            # Unbiased sample standard deviation (ddof=1 for N-1 in denominator)\n            sigma_sf = np.std(subject_data, ddof=1)\n            mu_sf = np.mean(subject_data)\n            \n            # Handle special cases for CV calculation as per the problem definition.\n            if mu_sf == 0.0:\n                if sigma_sf == 0.0:\n                    cv_sf = 0.0\n                else:\n                    cv_sf = np.inf\n            else:\n                cv_sf = sigma_sf / abs(mu_sf)\n            cv_per_subject.append(cv_sf)\n            \n        # Aggregate to a single per-feature value by taking the median across subjects.\n        cv_f = np.median(cv_per_subject)\n\n        # --- 2. Calculate Intraclass Correlation Coefficient (ICC) ---\n        # Subject means across perturbations\n        subject_means = np.mean(feature_data, axis=1) # Shape (S,)\n        \n        # Grand mean across all subjects and perturbations\n        grand_mean = np.mean(subject_means)\n\n        # Between-subject sum of squares (SS_B)\n        df_b = S - 1\n        ms_b = 0\n        if df_b > 0:\n            ss_b = K * np.sum((subject_means - grand_mean)**2)\n            ms_b = ss_b / df_b\n\n        # Within-subject sum of squares (SS_W)\n        df_w = S * (K - 1)\n        ms_w = 0\n        if df_w > 0:\n            # Use broadcasting to subtract subject means from their respective measurements\n            ss_w = np.sum((feature_data - subject_means.reshape(-1, 1))**2)\n            ms_w = ss_w / df_w\n\n        # Handle special case for ICC calculation\n        if ms_b == 0.0 and ms_w == 0.0:\n            icc_f = 1.0\n        else:\n            # Formula for ICC(1,1)\n            numerator = ms_b - ms_w\n            denominator = ms_b + (K - 1) * ms_w\n            icc_f = numerator / denominator if denominator != 0 else -1.0\n        \n        feature_metrics.append((cv_f, icc_f))\n\n    all_case_results = []\n    \n    # Apply the robustness decision rule for each case.\n    for tau_cv, tau_icc in threshold_cases:\n        robust_indices = []\n        for f in range(F):\n            cv_f, icc_f = feature_metrics[f]\n            if cv_f = tau_cv and icc_f >= tau_icc:\n                robust_indices.append(f)\n        all_case_results.append(robust_indices)\n\n    # Format the final output string exactly as specified, with no whitespace.\n    inner_results_as_strings = [f\"[{','.join(map(str, inner_list))}]\" for inner_list in all_case_results]\n    final_output = f\"[{','.join(inner_results_as_strings)}]\"\n    \n    print(final_output)\n\nsolve()\n```", "id": "4531341"}, {"introduction": "一个影像组学模型通常会输出一个连续的风险评分，但在临床实践中，医生需要的是一个明确的二元决策（例如，高风险或低风险）。如何在这两者之间建立桥梁？本练习模拟了在模型验证阶段如何选择最佳决策阈值的过程 [@problem_id:4531403]。您将学习使用受试者工作特征（$ROC$）曲线分析中的灵敏度和特异性数据，结合尤登指数（Youden’s Index）来寻找最佳平衡点，同时满足特定的临床需求（如确保高灵敏度），这是将预测模型转化为实用临床工具的决定性一步。", "problem": "一个用于肿瘤分级二元分类的影像组学特征，是使用从计算机断层扫描图像中提取的多变量纹理和形状特征进行训练的，其连续风险评分 $r \\in [0,1]$ 通过逻辑回归在内部数据上进行了校准。在一个外部验证队列上，必须选择操作决策阈值 $t$ 以最大化临床区分能力，同时满足最低灵敏度要求，以避免漏诊高级别病例。\n\n受试者工作特征（ROC）坐标是在候选阈值处，根据真阳性、假阴性、真阴性和假阳性的计数，使用灵敏度和特异度的标准定义来估计的。灵敏度定义为 $\\text{sensitivity} = \\text{true positive rate}$，特异度定义为 $\\text{specificity} = 1 - \\text{false positive rate}$。Youden指数定义为 $J = \\text{sensitivity} + \\text{specificity} - 1$。\n\n对于以下候选阈值和测得的验证指标：\n- 当 $t=0.15$ 时，灵敏度 $=0.99$，特异度 $=0.35$；\n- 当 $t=0.25$ 时，灵敏度 $=0.98$，特异度 $=0.45$；\n- 当 $t=0.35$ 时，灵敏度 $=0.96$，特异度 $=0.60$；\n- 当 $t=0.45$ 时，灵敏度 $=0.93$，特异度 $=0.70$；\n- 当 $t=0.55$ 时，灵敏度 $=0.88$，特异度 $=0.78$；\n- 当 $t=0.65$ 时，灵敏度 $=0.86$，特异度 $=0.85$；\n- 当 $t=0.75$ 时，灵敏度 $=0.80$，特异度 $=0.90$；\n- 当 $t=0.85$ 时，灵敏度 $=0.72$，特异度 $=0.94$；\n- 当 $t=0.95$ 时，灵敏度 $=0.60$，特异度 $=0.97$，\n\n使用上述基本定义计算每个阈值下的Youden指数 $J(t)$。然后，在临床约束条件 $\\text{sensitivity} > 0.90$ 下，找出使 $J(t)$ 最大化的阈值 $t$。将最终阈值 $t^{\\ast}$ 表示为一个无量纲数。无需四舍五入。", "solution": "该问题要求从一组候选阈值中确定一个最佳操作决策阈值，记为 $t^{\\ast}$。优化标准是在灵敏度的临床约束条件下，最大化Youden指数 $J(t)$。Youden指数是衡量诊断测试性能的指标，它概括了二元分类器的区分能力。其定义公式为：\n$$J(t) = \\text{sensitivity}(t) + \\text{specificity}(t) - 1$$\n所施加的临床约束是灵敏度必须大于 $0.90$，可以表示为：\n$$\\text{sensitivity}(t) > 0.90$$\n我们得到了一组离散的候选阈值 $t$ 及其对应的测得的灵敏度和特异度值。确定最佳阈值 $t^{\\ast}$ 的过程包括两个主要步骤：首先，筛选候选阈值，只保留那些满足指定灵敏度约束的阈值；其次，为每个保留的阈值计算Youden指数，以找出产生最大值的那个阈值。\n\n提供的数据点如下：\n\\begin{itemize}\n    \\item 当 $t=0.15$ 时，灵敏度 $=0.99$，特异度 $=0.35$\n    \\item 当 $t=0.25$ 时，灵敏度 $=0.98$，特异度 $=0.45$\n    \\item 当 $t=0.35$ 时，灵敏度 $=0.96$，特异度 $=0.60$\n    \\item 当 $t=0.45$ 时，灵敏度 $=0.93$，特异度 $=0.70$\n    \\item 当 $t=0.55$ 时，灵敏度 $=0.88$，特异度 $=0.78$\n    \\item 当 $t=0.65$ 时，灵敏度 $=0.86$，特异度 $=0.85$\n    \\item 当 $t=0.75$ 时，灵敏度 $=0.80$，特异度 $=0.90$\n    \\item 当 $t=0.85$ 时，灵敏度 $=0.72$，特异度 $=0.94$\n    \\item 当 $t=0.95$ 时，灵敏度 $=0.60$，特异度 $=0.97$\n\\end{itemize}\n\n首先，我们应用灵敏度约束来确定可接受阈值的子集，即那些满足 $\\text{sensitivity}(t) > 0.90$ 的阈值。\n\n\\begin{itemize}\n    \\item 当 $t=0.15$ 时：$\\text{sensitivity} = 0.99$。由于 $0.99 > 0.90$，该阈值是可接受的。\n    \\item 当 $t=0.25$ 时：$\\text{sensitivity} = 0.98$。由于 $0.98 > 0.90$，该阈值是可接受的。\n    \\item 当 $t=0.35$ 时：$\\text{sensitivity} = 0.96$。由于 $0.96 > 0.90$，该阈值是可接受的。\n    \\item 当 $t=0.45$ 时：$\\text{sensitivity} = 0.93$。由于 $0.93 > 0.90$，该阈值是可接受的。\n    \\item 当 $t=0.55$ 时：$\\text{sensitivity} = 0.88$。由于 $0.88 \\ngtr 0.90$，该阈值是不可接受的。\n    \\item 当 $t=0.65$ 时：$\\text{sensitivity} = 0.86$。由于 $0.86 \\ngtr 0.90$，该阈值是不可接受的。\n    \\item 当 $t=0.75$ 时：$\\text{sensitivity} = 0.80$。由于 $0.80 \\ngtr 0.90$，该阈值是不可接受的。\n    \\item 当 $t=0.85$ 时：$\\text{sensitivity} = 0.72$。由于 $0.72 \\ngtr 0.90$，该阈值是不可接受的。\n    \\item 当 $t=0.95$ 时：$\\text{sensitivity} = 0.60$。由于 $0.60 \\ngtr 0.90$，该阈值是不可接受的。\n\\end{itemize}\n满足约束的可接受阈值集合为 $\\{0.15, 0.25, 0.35, 0.45\\}$。\n\n接下来，我们使用给定公式为每个可接受的阈值计算Youden指数 $J(t)$。\n\n\\begin{itemize}\n    \\item 对于 $t=0.15$：\n    $$J(0.15) = \\text{sensitivity}(0.15) + \\text{specificity}(0.15) - 1 = 0.99 + 0.35 - 1 = 0.34$$\n    \\item 对于 $t=0.25$：\n    $$J(0.25) = \\text{sensitivity}(0.25) + \\text{specificity}(0.25) - 1 = 0.98 + 0.45 - 1 = 0.43$$\n    \\item 对于 $t=0.35$：\n    $$J(0.35) = \\text{sensitivity}(0.35) + \\text{specificity}(0.35) - 1 = 0.96 + 0.60 - 1 = 0.56$$\n    \\item 对于 $t=0.45$：\n    $$J(0.45) = \\text{sensitivity}(0.45) + \\text{specificity}(0.45) - 1 = 0.93 + 0.70 - 1 = 0.63$$\n\\end{itemize}\n\n最后，我们通过比较计算出的值来确定使 $J(t)$ 最大化的阈值：\n$$J(0.15) = 0.34$$\n$$J(0.25) = 0.43$$\n$$J(0.35) = 0.56$$\n$$J(0.45) = 0.63$$\n在可接受的阈值中，Youden指数的最大值为 $J_{\\max} = 0.63$，它出现在阈值 $t = 0.45$ 处。\n\n因此，在满足对灵敏度的临床要求的同时最大化Youden指数的最佳阈值 $t^{\\ast}$ 是 $0.45$。", "answer": "$$\n\\boxed{0.45}\n$$", "id": "4531403"}]}