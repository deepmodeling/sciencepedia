{"hands_on_practices": [{"introduction": "要对图像进行重采样，我们必须首先在原始（源）图像和新（目标）网格的坐标之间建立一个精确的数学映射。本练习将引导你从第一性原理出发，推导一个实现这一目标的复合仿射变换，该变换结合了旋转、各向异性缩放和平移。掌握这一过程有助于你理解所有图像配准和重采样任务背后的基本几何原理，这是放射组学分析流程中至关重要的一步。[@problem_id:4546648]", "problem": "一个用于影像组学特征提取的计算机断层扫描 (CT) 体定义在一个离散源网格上，其体素间距为各向异性，$s_{x} = 0.8$ 毫米，$s_{y} = 1.2$ 毫米，$s_{z} = 2.5$ 毫米。其在扫描仪物理坐标系中的刚性方向和位置由绕 $z$ 轴旋转 $30$ 度和一个平移向量 $\\boldsymbol{t}_{s} = [12, -6, 4]^{\\top}$ 毫米给出。用于重采样的目标网格是各向同性的，间距为 $\\Delta = 1.0$ 毫米，与扫描仪坐标轴对齐（单位方向），原点位于 $\\boldsymbol{t}_{t} = [0, 0, 0]^{\\top}$ 毫米。角度以度为单位。\n\n请仅从索引坐标和物理坐标之间仿射映射的基本定义，以及用于插值的反向映射原理出发，推导将在齐次坐标下把目标网格索引映射到源网格索引的复合仿射变换。使用以下基本定义：\n\n- 从源索引坐标 $\\boldsymbol{u} = [u_{x}, u_{y}, u_{z}]^{\\top}$ 到源物理坐标 $\\boldsymbol{p}_{s}$ 的映射为 $\\boldsymbol{p}_{s} = \\boldsymbol{R}_{s}\\,\\boldsymbol{S}_{s}\\,\\boldsymbol{u} + \\boldsymbol{t}_{s}$，其中 $\\boldsymbol{S}_{s} = \\mathrm{diag}(s_{x},\\,s_{y},\\,s_{z})$，$\\boldsymbol{R}_{s}$ 是对应于绕 $z$ 轴旋转 $30$ 度的旋转矩阵。\n- 从目标索引坐标 $\\boldsymbol{v} = [v_{x}, v_{y}, v_{z}]^{\\top}$ 到目标物理坐标 $\\boldsymbol{p}_{t}$ 的映射为 $\\boldsymbol{p}_{t} = \\boldsymbol{R}_{t}\\,\\boldsymbol{S}_{t}\\,\\boldsymbol{v} + \\boldsymbol{t}_{t}$，其中 $\\boldsymbol{R}_{t}$ 是单位矩阵，$\\boldsymbol{S}_{t} = \\Delta\\,\\boldsymbol{I}$，$\\boldsymbol{I}$ 是单位矩阵。\n\n使用反向映射原理，即通过令物理坐标相等 $\\boldsymbol{p}_{t} = \\boldsymbol{p}_{s}$，然后解出 $\\boldsymbol{u}$ 作为 $\\boldsymbol{v}$ 的函数，来获得源中的采样位置。构建齐次 $4 \\times 4$ 仿射矩阵 $\\boldsymbol{A}$，使得\n$$\n\\begin{pmatrix}\n\\boldsymbol{u} \\\\\n1\n\\end{pmatrix}\n=\n\\boldsymbol{A}\n\\begin{pmatrix}\n\\boldsymbol{v} \\\\\n1\n\\end{pmatrix}.\n$$\n明确展示从基本定义出发的复合步骤，并陈述将目标索引 $\\boldsymbol{v}$ 转换为用于后续插值的连续源采样位置 $\\boldsymbol{u}$ 的反向映射公式。用精确解析形式表示最终的仿射矩阵 $\\boldsymbol{A}$，三角函数值使用根式表示，缩放比例使用分数表示；请勿四舍五入。最终答案必须是单一的齐次矩阵 $\\boldsymbol{A}$，矩阵元素中不包含任何单位。", "solution": "用户希望推导将在齐次坐标下把目标网格索引映射到源网格索引的复合仿射变换。\n\n所提供的问题是**有效的**，因为它在科学上基于医学图像处理和坐标变换的原理，问题提出得很好，包含了所有必要信息，并且陈述客观。\n\n### 坐标变换简介\n\n该问题要求我们找到一个从目标网格索引坐标（记为 $\\boldsymbol{v}$）到源网格索引坐标（记为 $\\boldsymbol{u}$）的变换。这个过程涉及从一个索引空间映射到物理空间，然后再回到另一个索引空间。这是图像重采样中的一个标准程序，其中目标体素的值是通过在源图像的相应位置进行采样来确定的。\n\n### 基本定义\n\n我们首先确定给定的从索引坐标到物理坐标的变换。\n\n**1. 源网格变换：**\n从源索引坐标 $\\boldsymbol{u} = [u_{x}, u_{y}, u_{z}]^{\\top}$ 到源物理坐标 $\\boldsymbol{p}_{s}$ 的映射由以下仿射变换给出：\n$$ \\boldsymbol{p}_{s} = \\boldsymbol{R}_{s} \\boldsymbol{S}_{s} \\boldsymbol{u} + \\boldsymbol{t}_{s} $$\n其中：\n*   $\\boldsymbol{S}_{s}$ 是由各向异性体素间距 $s_{x} = 0.8 = \\frac{4}{5}$，$s_{y} = 1.2 = \\frac{6}{5}$ 和 $s_{z} = 2.5 = \\frac{5}{2}$（单位均为毫米）构成的对角缩放矩阵：\n    $$ \\boldsymbol{S}_{s} = \\begin{pmatrix} \\frac{4}{5} & 0 & 0 \\\\ 0 & \\frac{6}{5} & 0 \\\\ 0 & 0 & \\frac{5}{2} \\end{pmatrix} $$\n*   $\\boldsymbol{R}_{s}$ 是绕 $z$ 轴旋转角度 $\\theta = 30^{\\circ}$ 的旋转矩阵。使用 $\\cos(30^{\\circ}) = \\frac{\\sqrt{3}}{2}$ 和 $\\sin(30^{\\circ}) = \\frac{1}{2}$：\n    $$ \\boldsymbol{R}_{s} = \\begin{pmatrix} \\cos(\\theta) & -\\sin(\\theta) & 0 \\\\ \\sin(\\theta) & \\cos(\\theta) & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} = \\begin{pmatrix} \\frac{\\sqrt{3}}{2} & -\\frac{1}{2} & 0 \\\\ \\frac{1}{2} & \\frac{\\sqrt{3}}{2} & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} $$\n*   $\\boldsymbol{t}_{s}$ 是平移向量：\n    $$ \\boldsymbol{t}_{s} = \\begin{pmatrix} 12 \\\\ -6 \\\\ 4 \\end{pmatrix} $$\n\n**2. 目标网格变换：**\n从目标索引坐标 $\\boldsymbol{v} = [v_{x}, v_{y}, v_{z}]^{\\top}$ 到目标物理坐标 $\\boldsymbol{p}_{t}$ 的映射为：\n$$ \\boldsymbol{p}_{t} = \\boldsymbol{R}_{t} \\boldsymbol{S}_{t} \\boldsymbol{v} + \\boldsymbol{t}_{t} $$\n其中：\n*   $\\boldsymbol{S}_{t}$ 是间距为 $\\Delta = 1.0$ 的各向同性缩放矩阵：\n    $$ \\boldsymbol{S}_{t} = \\Delta \\boldsymbol{I} = 1.0 \\begin{pmatrix} 1 & 0 & 0 \\\\ 0 & 1 & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} = \\boldsymbol{I} $$\n*   $\\boldsymbol{R}_{t}$ 是单位旋转矩阵：\n    $$ \\boldsymbol{R}_{t} = \\boldsymbol{I} $$\n*   $\\boldsymbol{t}_{t}$ 是零平移向量：\n    $$ \\boldsymbol{t}_{t} = \\begin{pmatrix} 0 \\\\ 0 \\\\ 0 \\end{pmatrix} $$\n目标变换简化为 $\\boldsymbol{p}_{t} = \\boldsymbol{I} \\boldsymbol{I} \\boldsymbol{v} + \\boldsymbol{0} = \\boldsymbol{v}$。这意味着目标索引坐标与其物理坐标相同。\n\n### 反向映射原理\n\n反向映射原理要求对于目标网格中的任意点，我们找到它在源网格中的对应位置。这通过令它们的物理坐标相等来实现：\n$$ \\boldsymbol{p}_{s} = \\boldsymbol{p}_{t} $$\n代入变换的定义：\n$$ \\boldsymbol{R}_{s} \\boldsymbol{S}_{s} \\boldsymbol{u} + \\boldsymbol{t}_{s} = \\boldsymbol{R}_{t} \\boldsymbol{S}_{t} \\boldsymbol{v} + \\boldsymbol{t}_{t} $$\n我们需要解此方程，得到 $\\boldsymbol{u}$ 作为 $\\boldsymbol{v}$ 的函数。令 $\\boldsymbol{M}_{s} = \\boldsymbol{R}_{s} \\boldsymbol{S}_{s}$ 且 $\\boldsymbol{M}_{t} = \\boldsymbol{R}_{t} \\boldsymbol{S}_{t}$。\n$$ \\boldsymbol{M}_{s} \\boldsymbol{u} + \\boldsymbol{t}_{s} = \\boldsymbol{M}_{t} \\boldsymbol{v} + \\boldsymbol{t}_{t} $$\n$$ \\boldsymbol{M}_{s} \\boldsymbol{u} = \\boldsymbol{M}_{t} \\boldsymbol{v} + (\\boldsymbol{t}_{t} - \\boldsymbol{t}_{s}) $$\n$$ \\boldsymbol{u} = \\boldsymbol{M}_{s}^{-1} (\\boldsymbol{M}_{t} \\boldsymbol{v} + \\boldsymbol{t}_{t} - \\boldsymbol{t}_{s}) = (\\boldsymbol{M}_{s}^{-1} \\boldsymbol{M}_{t}) \\boldsymbol{v} + \\boldsymbol{M}_{s}^{-1} (\\boldsymbol{t}_{t} - \\boldsymbol{t}_{s}) $$\n代入目标网格的特定值（$\\boldsymbol{M}_{t} = \\boldsymbol{I}$ 和 $\\boldsymbol{t}_{t} = \\boldsymbol{0}$）：\n$$ \\boldsymbol{u} = (\\boldsymbol{M}_{s}^{-1} \\boldsymbol{I}) \\boldsymbol{v} + \\boldsymbol{M}_{s}^{-1} (\\boldsymbol{0} - \\boldsymbol{t}_{s}) = \\boldsymbol{M}_{s}^{-1} \\boldsymbol{v} - \\boldsymbol{M}_{s}^{-1} \\boldsymbol{t}_{s} $$\n此表达式即为反向映射公式，它给出了对于一个给定的目标索引 $\\boldsymbol{v}$ 的连续源索引位置 $\\boldsymbol{u}$。\n\n### 齐次变换\n\n仿射变换 $\\boldsymbol{u} = \\boldsymbol{L} \\boldsymbol{v} + \\boldsymbol{c}$ 可以使用一个 $4 \\times 4$ 矩阵 $\\boldsymbol{A}$ 在齐次坐标中表示：\n$$ \\begin{pmatrix} \\boldsymbol{u} \\\\ 1 \\end{pmatrix} = \\begin{pmatrix} \\boldsymbol{L} & \\boldsymbol{c} \\\\ \\boldsymbol{0}^{\\top} & 1 \\end{pmatrix} \\begin{pmatrix} \\boldsymbol{v} \\\\ 1 \\end{pmatrix} = \\boldsymbol{A} \\begin{pmatrix} \\boldsymbol{v} \\\\ 1 \\end{pmatrix} $$\n根据我们推导的公式，线性部分是 $\\boldsymbol{L} = \\boldsymbol{M}_{s}^{-1}$，平移部分是 $\\boldsymbol{c} = -\\boldsymbol{M}_{s}^{-1} \\boldsymbol{t}_{s}$。\n因此，复合仿射变换矩阵 $\\boldsymbol{A}$ 是：\n$$ \\boldsymbol{A} = \\begin{pmatrix} \\boldsymbol{M}_{s}^{-1} & -\\boldsymbol{M}_{s}^{-1} \\boldsymbol{t}_{s} \\\\ \\boldsymbol{0}^{\\top} & 1 \\end{pmatrix} $$\n这恰好是将在源索引映射到物理空间的齐次矩阵 $\\boldsymbol{H}_{s}$ 的逆矩阵：\n$$ \\boldsymbol{H}_{s} = \\begin{pmatrix} \\boldsymbol{M}_{s} & \\boldsymbol{t}_{s} \\\\ \\boldsymbol{0}^{\\top} & 1 \\end{pmatrix} \\implies \\boldsymbol{H}_{s}^{-1} = \\begin{pmatrix} \\boldsymbol{M}_{s}^{-1} & -\\boldsymbol{M}_{s}^{-1} \\boldsymbol{t}_{s} \\\\ \\boldsymbol{0}^{\\top} & 1 \\end{pmatrix} = \\boldsymbol{A} $$\n\n### 矩阵分量的计算\n\n我们现在计算 $\\boldsymbol{A}$ 的分量。\n\n**1. 线性部分 $\\boldsymbol{M}_{s}^{-1}$ 的逆：**\n$$ \\boldsymbol{M}_{s}^{-1} = (\\boldsymbol{R}_{s} \\boldsymbol{S}_{s})^{-1} = \\boldsymbol{S}_{s}^{-1} \\boldsymbol{R}_{s}^{-1} $$\n*   缩放矩阵 $\\boldsymbol{S}_{s}$ 的逆矩阵是：\n    $$ \\boldsymbol{S}_{s}^{-1} = \\begin{pmatrix} \\frac{5}{4} & 0 & 0 \\\\ 0 & \\frac{5}{6} & 0 \\\\ 0 & 0 & \\frac{2}{5} \\end{pmatrix} $$\n*   旋转矩阵 $\\boldsymbol{R}_{s}$ 的逆矩阵是其转置，即 $\\boldsymbol{R}_{s}^{-1} = \\boldsymbol{R}_{s}^{\\top}$：\n    $$ \\boldsymbol{R}_{s}^{-1} = \\begin{pmatrix} \\frac{\\sqrt{3}}{2} & \\frac{1}{2} & 0 \\\\ -\\frac{1}{2} & \\frac{\\sqrt{3}}{2} & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} $$\n*   现在，我们计算乘积 $\\boldsymbol{M}_{s}^{-1} = \\boldsymbol{S}_{s}^{-1} \\boldsymbol{R}_{s}^{-1}$：\n    $$ \\boldsymbol{M}_{s}^{-1} = \\begin{pmatrix} \\frac{5}{4} & 0 & 0 \\\\ 0 & \\frac{5}{6} & 0 \\\\ 0 & 0 & \\frac{2}{5} \\end{pmatrix} \\begin{pmatrix} \\frac{\\sqrt{3}}{2} & \\frac{1}{2} & 0 \\\\ -\\frac{1}{2} & \\frac{\\sqrt{3}}{2} & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} = \\begin{pmatrix} \\frac{5\\sqrt{3}}{8} & \\frac{5}{8} & 0 \\\\ -\\frac{5}{12} & \\frac{5\\sqrt{3}}{12} & 0 \\\\ 0 & 0 & \\frac{2}{5} \\end{pmatrix} $$\n\n**2. 平移向量 $\\boldsymbol{c} = -\\boldsymbol{M}_{s}^{-1} \\boldsymbol{t}_{s}$：**\n我们首先计算 $\\boldsymbol{M}_{s}^{-1} \\boldsymbol{t}_{s}$：\n$$ \\boldsymbol{M}_{s}^{-1} \\boldsymbol{t}_{s} = \\begin{pmatrix} \\frac{5\\sqrt{3}}{8} & \\frac{5}{8} & 0 \\\\ -\\frac{5}{12} & \\frac{5\\sqrt{3}}{12} & 0 \\\\ 0 & 0 & \\frac{2}{5} \\end{pmatrix} \\begin{pmatrix} 12 \\\\ -6 \\\\ 4 \\end{pmatrix} = \\begin{pmatrix} (\\frac{5\\sqrt{3}}{8})(12) + (\\frac{5}{8})(-6) \\\\ (-\\frac{5}{12})(12) + (\\frac{5\\sqrt{3}}{12})(-6) \\\\ (\\frac{2}{5})(4) \\end{pmatrix} $$\n$$ = \\begin{pmatrix} \\frac{15\\sqrt{3}}{2} - \\frac{15}{4} \\\\ -5 - \\frac{5\\sqrt{3}}{2} \\\\ \\frac{8}{5} \\end{pmatrix} $$\n矩阵 $\\boldsymbol{A}$ 的平移部分是该向量的负值：\n$$ \\boldsymbol{c} = -\\begin{pmatrix} \\frac{15\\sqrt{3}}{2} - \\frac{15}{4} \\\\ -5 - \\frac{5\\sqrt{3}}{2} \\\\ \\frac{8}{5} \\end{pmatrix} = \\begin{pmatrix} \\frac{15}{4} - \\frac{15\\sqrt{3}}{2} \\\\ 5 + \\frac{5\\sqrt{3}}{2} \\\\ -\\frac{8}{5} \\end{pmatrix} $$\n\n### 最终的齐次矩阵 A\n\n通过组合计算出的分量，我们得到最终的 $4 \\times 4$ 齐次变换矩阵 $\\boldsymbol{A}$：\n$$ \\boldsymbol{A} = \\begin{pmatrix} \\frac{5\\sqrt{3}}{8} & \\frac{5}{8} & 0 & \\frac{15}{4} - \\frac{15\\sqrt{3}}{2} \\\\ -\\frac{5}{12} & \\frac{5\\sqrt{3}}{12} & 0 & 5 + \\frac{5\\sqrt{3}}{2} \\\\ 0 & 0 & \\frac{2}{5} & -\\frac{8}{5} \\\\ 0 & 0 & 0 & 1 \\end{pmatrix} $$\n这个矩阵 $\\boldsymbol{A}$完整地描述了从目标索引坐标 $\\boldsymbol{v}$到相应的连续源索引坐标 $\\boldsymbol{u}$ 的变换。", "answer": "$$ \\boxed{\n\\begin{pmatrix}\n\\frac{5\\sqrt{3}}{8} & \\frac{5}{8} & 0 & \\frac{15}{4} - \\frac{15\\sqrt{3}}{2} \\\\\n-\\frac{5}{12} & \\frac{5\\sqrt{3}}{12} & 0 & 5 + \\frac{5\\sqrt{3}}{2} \\\\\n0 & 0 & \\frac{2}{5} & -\\frac{8}{5} \\\\\n0 & 0 & 0 & 1\n\\end{pmatrix}\n} $$", "id": "4546648"}, {"introduction": "并非所有的插值方法都适用于每种类型的图像，数据的内在属性是决定性因素。本实践问题阐明了重采样连续强度图像和分类标签图（如肿瘤分割掩模）之间的关键区别。你将通过一个具体的定量计算，来揭示为何像三次卷积插值这样看似“更平滑”的高阶方法会产生不存在的标签值，从而破坏分割结果的拓扑结构，并理解为何最近邻插值是处理这类分类数据的金标准。[@problem_id:4546655]", "problem": "在影像组学预处理中，标签图像是一个函数 $L:\\Omega\\subset\\mathbb{Z}^d\\to\\mathcal{C}$，其中 $\\mathcal{C}$ 是一个有限的分类编码集合（例如，背景、器官、病灶）。与强度图像 $I:\\Omega\\to\\mathbb{R}$ 不同，标签图像带有分类语义，其编码集合 $\\mathcal{C}$ 上没有有意义的线性顺序或向量空间结构。将图像从一个体素网格重采样到另一个体素网格依赖于插值，而插值根据其定义，假设其处理的底层量具有支持形成加权平均的代数结构。考虑广泛使用的立方卷积插值（在 $2\\text{D}$ 中也称为双三次插值），它使用 Keys 核，并由参数 $a=-\\frac{1}{2}$ 定义。该插值定义了一个 $1\\text{D}$ 核 $h:\\mathbb{R}\\to\\mathbb{R}$：\n$$\nh(x)=\\begin{cases}\n(a+2)|x|^3-(a+3)|x|^2+1, & 0\\le |x|1 \\\\\na|x|^3-5a|x|^2+8a|x|-4a,  1\\le |x|2 \\\\\n0,  |x|\\ge 2\n\\end{cases}\n$$\n其中 $a=-\\frac{1}{2}$。在样本 $y_1$ 和 $y_2$ 之间的小数偏移量为 $t\\in[0,1]$ 处的插值结果使用了四个相邻样本 $y_0,y_1,y_2,y_3$（索引从左到右递增）及其权重：\n$$\nw_0=h(1+t),\\quad w_1=h(t),\\quad w_2=h(1-t),\\quad w_3=h(2-t),\n$$\n因此 $y(t)=w_0y_0+w_1y_1+w_2y_2+w_3y_3$。\n\n假设沿一条 $1\\text{D}$ 扫描线的二值分割标签图像将背景编码为 $c=0$，血管编码为 $c=2$（即 $\\mathcal{C}=\\{0,2\\}$），在整数位置 $\\{x=0,1,2,3\\}$ 处的连续样本为 $\\{y_0,y_1,y_2,y_3\\}=\\{0,0,2,2\\}$。您通过在 $x=1.5$ 处进行插值（即在 $x=1$ 处的 $y_1$ 和 $x=2$ 处的 $y_2$ 之间取 $t=\\frac{1}{2}$）来重采样到一个更精细的网格，然后通过四舍五入算子 $\\mathrm{round}(\\cdot)$ 将插值结果简单地转换为整数标签，而没有将其投影到有效编码集 $\\mathcal{C}$ 上。\n\n哪个选项从第一性原理出发，正确地解释了为什么最近邻插值更适用于标签图像，并且正确地计算了使用 Keys 立方核的插值结果 $y\\!\\left(\\frac{1}{2}\\right)$，同时指出了由此产生的伪类及其对标签划分的影响？\n\nA. 标签图像是分类的；对编码进行平均没有语义意义，因为 $\\mathcal{C}$ 缺乏向量空间结构。最近邻插值通过选择一个已有的编码来保持隶属关系。使用 Keys 立方核，当 $a=-\\frac{1}{2}$ 且 $t=\\frac{1}{2}$ 时，权重为 $w_1=h\\!\\left(\\frac{1}{2}\\right)=\\frac{9}{16}$，$w_2=h\\!\\left(\\frac{1}{2}\\right)=\\frac{9}{16}$，以及 $w_0=w_3=h\\!\\left(\\frac{3}{2}\\right)=-\\frac{1}{16}$，得出 $y\\!\\left(\\frac{1}{2}\\right)=0\\cdot\\!\\left(-\\frac{1}{16}\\right)+0\\cdot\\!\\left(\\frac{9}{16}\\right)+2\\cdot\\!\\left(\\frac{9}{16}\\right)+2\\cdot\\!\\left(-\\frac{1}{16}\\right)=1$。四舍五入产生整数标签 $1$，它不在 $\\mathcal{C}$ 中，因此引入了一个伪类，并将标签划分从 $\\{0,2\\}$ 改变为 $\\{0,1,2\\}$。\n\nB. 对于标签图像，不推荐使用最近邻插值，因为它会在边界处引起混叠；立方插值是安全的，因为四舍五入总能恢复一个有效的标签。对于给定的数据，$y\\!\\left(\\frac{1}{2}\\right)=\\frac{1}{2}(0+2)=1$，但四舍五入到最近的有效标签会得到 $2$，因此不会出现伪类。\n\nC. 在单调片段上，立方插值的结果受限于样本的凸包，因此它不能创建中间标签。对于 $\\{0,0,2,2\\}$，$y\\!\\left(\\frac{1}{2}\\right)=2$，并且最近邻插值是不必要的，因为立方插值能保持拓扑结构。\n\nD. 标签编码可以被视为概率；立方插值计算一个平滑的概率混合，而四舍五入只是恢复最大后验类。对于给定的样本，$y\\!\\left(\\frac{1}{2}\\right)=\\frac{3}{2}$，四舍五入后得到 $2$，并保持了原始类别。", "solution": "该问题陈述是有效的。它在科学上基于数字图像处理和影像组学的原理，问题提出得很好，提供了所有必要的数据和定义，并以客观、正式的语言编写。没有矛盾、歧义或事实错误。\n\n该问题需要进行两部分分析：首先，从概念上证明为分类标签图像选择插值方法的合理性；其次，使用立方卷积插值进行具体计算。\n\n**第一部分：概念论证（分类数据的插值）**\n\n标签图像是一个函数 $L:\\Omega\\subset\\mathbb{Z}^d\\to\\mathcal{C}$，其中 $\\mathcal{C}$ 是一个有限的分类编码集合。在此问题中，$\\mathcal{C}=\\{0,2\\}$，分别代表背景和血管。这些编码是标识符或标签，而不是连续尺度上的量。集合 $\\mathcal{C}$ 不是一个向量空间；诸如加法和标量乘法之类的运算没有语义意义。例如，$0.5 \\times (\\text{背景}) + 0.5 \\times (\\text{血管})$ 的意义是什么？其结果不是一个已定义的类别。\n\n诸如线性、立方或样条等插值方法都基于计算相邻样本值的加权平均值。这种数学结构隐含地假设底层数据空间是一个连续体，其中这样的平均值是有意义的（例如，一个实向量空间 $\\mathbb{R}$）。当应用于像图像标签这样的分类数据时，这些方法可能会产生原始编码集合 $\\mathcal{C}$之外的值。例如，在标签 $0$ 和标签 $2$ 之间插值可能会得到 $1$、$1.5$ 或任何其他实数，这些都不是有效的标签。这会引入伪类并破坏分割图。\n\n相比之下，最近邻插值将原始网格中最近样本的值赋给新网格位置。它不对标签编码本身进行任何算术运算。因此，输出值始终是原始集合 $\\mathcal{C}$ 的一个元素。这种保持标签集合的特性，是为什么最近邻插值成为重采样分类图像（如分割或掩模）的标准且在概念上正确的方法。\n\n**第二部分：使用 Keys 立方核进行计算**\n\n我们需要计算在 $x=1.5$ 处的插值。该点位于 $x=1$ 处的样本（值为 $y_1=0$）和 $x=2$ 处的样本（值为 $y_2=2$）的正中间。因此，小数偏移量为 $t = 1.5 - 1 = 0.5$，即 $t=\\frac{1}{2}$。插值使用四个相邻样本 $\\{y_0, y_1, y_2, y_3\\} = \\{0, 0, 2, 2\\}$。\n\n插值由 $y(t) = w_0 y_0 + w_1 y_1 + w_2 y_2 + w_3 y_3$ 给出。\n对于 $t=\\frac{1}{2}$，权重为：\n$w_1 = h(t) = h(\\frac{1}{2})$\n$w_2 = h(1-t) = h(1-\\frac{1}{2}) = h(\\frac{1}{2})$\n$w_0 = h(1+t) = h(1+\\frac{1}{2}) = h(\\frac{3}{2})$\n$w_3 = h(2-t) = h(2-\\frac{1}{2}) = h(\\frac{3}{2})$\n\n我们使用参数 $a=-\\frac{1}{2}$ 的 Keys 核公式：\n$$\nh(x)=\\begin{cases}\n(a+2)|x|^3-(a+3)|x|^2+1,  0\\le |x|1 \\\\\na|x|^3-5a|x|^2+8a|x|-4a,  1\\le |x|2 \\\\\n0,  |x|\\ge 2\n\\end{cases}\n$$\n\n首先，我们计算权重。\n对于 $x = \\frac{1}{2}$（在 $[0, 1)$ 区间内），我们使用 $h(x)$ 的第一种情况：\n当 $a = -\\frac{1}{2}$ 时，我们有 $a+2 = \\frac{3}{2}$ 和 $a+3 = \\frac{5}{2}$。\n$$\nw_1 = w_2 = h\\left(\\frac{1}{2}\\right) = \\left(\\frac{3}{2}\\right)\\left|\\frac{1}{2}\\right|^3 - \\left(\\frac{5}{2}\\right)\\left|\\frac{1}{2}\\right|^2 + 1 = \\frac{3}{2}\\cdot\\frac{1}{8} - \\frac{5}{2}\\cdot\\frac{1}{4} + 1 = \\frac{3}{16} - \\frac{5}{8} + 1 = \\frac{3}{16} - \\frac{10}{16} + \\frac{16}{16} = \\frac{9}{16}\n$$\n\n对于 $x = \\frac{3}{2}$（在 $[1, 2)$ 区间内），我们使用 $h(x)$ 的第二种情况：\n$$\nw_0 = w_3 = h\\left(\\frac{3}{2}\\right) = a\\left|\\frac{3}{2}\\right|^3 - 5a\\left|\\frac{3}{2}\\right|^2 + 8a\\left|\\frac{3}{2}\\right| - 4a\n$$\n提出因子 $a$：\n$$\nh\\left(\\frac{3}{2}\\right) = a \\left[ \\left(\\frac{3}{2}\\right)^3 - 5\\left(\\frac{3}{2}\\right)^2 + 8\\left(\\frac{3}{2}\\right) - 4 \\right] = -\\frac{1}{2} \\left[ \\frac{27}{8} - 5\\left(\\frac{9}{4}\\right) + 12 - 4 \\right]\n$$\n$$\nh\\left(\\frac{3}{2}\\right) = -\\frac{1}{2} \\left[ \\frac{27}{8} - \\frac{90}{8} + \\frac{64}{8} \\right] = -\\frac{1}{2} \\left[ \\frac{27 - 90 + 64}{8} \\right] = -\\frac{1}{2} \\left[ \\frac{1}{8} \\right] = -\\frac{1}{16}\n$$\n\n现在，我们计算插值结果 $y\\left(\\frac{1}{2}\\right)$：\n$$\ny\\left(\\frac{1}{2}\\right) = w_0 y_0 + w_1 y_1 + w_2 y_2 + w_3 y_3 = \\left(-\\frac{1}{16}\\right)(0) + \\left(\\frac{9}{16}\\right)(0) + \\left(\\frac{9}{16}\\right)(2) + \\left(-\\frac{1}{16}\\right)(2)\n$$\n$$\ny\\left(\\frac{1}{2}\\right) = 0 + 0 + \\frac{18}{16} - \\frac{2}{16} = \\frac{16}{16} = 1\n$$\n插值结果为 $1$。问题陈述中提到，该值会通过一个四舍五入算子被简单地转换为一个整数。由于 $y\\left(\\frac{1}{2}\\right) = 1$ 是一个整数，所以 $\\mathrm{round}(1) = 1$。\n\n**第三部分：结果的意义**\n\n得到的标签是 $1$。原始的有效标签集合是 $\\mathcal{C}=\\{0,2\\}$。新标签 $1$ 不是 $\\mathcal{C}$ 的成员。这是一个**伪类**。插值在背景和血管之间的边界上创建了一个新的、不存在的类别。这从根本上改变了图像的标签划分，将活动标签的集合从 $\\{0,2\\}$ 变为 $\\{0,1,2\\}$。这会破坏分割结果，并导致任何下游的定量分析（影像组学）出现错误。产生超出局部样本范围的值（“过冲”，尽管这里相对于局部值 $\\{0,2\\}$ 是“下冲”，但从全局看是中间值）是 Keys 核的一个已知特性，由其负旁瓣引起。\n\n**逐项分析**\n\n*   **A**：该选项正确地指出标签图像是分类的，平均编码没有意义。它正确地指明最近邻是首选方法。它正确地计算出权重 $w_1=w_2=\\frac{9}{16}$ 和 $w_0=w_3=-\\frac{1}{16}$。它正确地计算出插值结果 $y(\\frac{1}{2}) = 1$。最后，它正确地将结果识别为一个不在 $\\mathcal{C}=\\{0,2\\}$ 中的伪类 $1$，这改变了标签划分。此选项完全正确。\n    **结论：正确**\n\n*   **B**：该选项错误地声称不推荐使用最近邻插值。它其实是分类数据的首选方法。它错误地声称立方插值是“安全的”，并且四舍五入能恢复有效标签，我们的计算证明了这是错误的。计算 $y(\\frac{1}{2})=\\frac{1}{2}(0+2)=1$ 对应的是线性插值，而非指定的立方插值。其声称没有伪类出现的说法是错误的。\n    **结论：错误**\n\n*   **C**：该选项提出了一个错误的论断，即立方插值受限于样本的凸包。负权重（$-\\frac{1}{16}$）的存在证明了这是错误的，并且过冲/下冲是可能发生的。计算 $y(\\frac{1}{2}) = 2$ 是不正确的。声称立方插值能保持拓扑结构的说法也是错误的；创建新标签会从根本上改变对象的连通性。\n    **结论：错误**\n\n*   **D**：该选项基于一个有缺陷的前提，即标签编码可以被视为概率，这是一个概念性错误。问题将它们定义为分类编码。计算 $y(\\frac{1}{2}) = \\frac{3}{2}$ 是不正确的；正确的值是 $1$。基于这个错误值进行的后续推理也是无效的。\n    **结论：错误**", "answer": "$$\\boxed{A}$$", "id": "4546655"}, {"introduction": "重采样过程中的选择不仅会改变图像的外观，还会直接影响从中提取的量化特征，而这正是放射组学的核心。在这个编程练习中，你将通过构建一个包含锐利边缘和精细光栅的合成体模来研究不正确的降采样如何导致混叠伪影。你将进一步测量这些伪影如何改变从灰度共生矩阵（GLCM）中提取的常用纹理特征，从而使混叠这一理论概念及其对放射组学分析的实际影响变得具体而清晰。[@problem_id:4546567]", "problem": "您需要研究不当的图像重采样所产生的混叠现象，如何改变灰度共生矩阵特征。研究对象是一个人工合成的二维体模，该体模设计为同时包含锐利边缘和精细光栅，这两种结构在放射组学中很常见。分析必须基于以下第一性原理：用于信号采样的香农-奈奎斯特采样定理，以及灰度共生矩阵及其派生特征的形式化定义。\n\n按如下方式构建一个合成图像体模。设图像为一个大小为 $256 \\times 256$ 的离散数组，其整数像素索引为 $(x,y)$，其中 $x \\in \\{0,\\dots,255\\}$ 且 $y \\in \\{0,\\dots,255\\}$。定义一个强度场 $I(x,y)$，包含三个分量：\n1. 强度为 $0.2$ 的均匀背景。\n2. 一个边缘锐利的明亮方形区域，在轴对齐的边界 $x \\in [64,192)$ 和 $y \\in [64,192)$ 内，强度为 $0.8$。\n3. 一个可选的余弦光栅，限制在 $x \\in [32,224)$ 和 $y \\in [96,160)$ 范围内，由一个加法项 $A \\cos\\left(2\\pi x/p\\right)$ 给出，其振幅 $A = 0.2$，光栅周期 $p$ 以像素为单位。如果存在光栅，则仅在定义的条带内添加该光栅项，其他像素不受光栅影响。将最终强度裁剪到区间 $[0,1]$ 内。\n\n使用两种不同的流程将此图像重采样到新的空间分辨率：\n- 不当重采样（混叠）：通过缩放因子 $s$ 在两个轴上各向同性地进行直接最近邻重采样（无抗混叠预滤波器）。\n- 适当重采样（抗混叠）：如果 $s  1$，首先在两个轴上应用标准差为 $\\sigma = 0.6/s$ 像素的高斯低通滤波器（以衰减超出新奈奎斯特极限的频率），然后使用双线性插值进行重采样；如果 $s \\ge 1$，则跳过低通滤波器，并使用单位尺度的双线性插值。\n\n通过四舍五入将每个图像（原始图像和两种重采样版本）量化为 $N_g = 32$ 个灰度级：将每个强度 $v \\in [0,1]$ 通过 $q = \\operatorname{round}\\left( v (N_g - 1) \\right)$ 映射到一个整数 $q \\in \\{0,1,\\dots,31\\}$，然后裁剪到允许的范围内。\n\n为指定的偏移量定义灰度共生矩阵（GLCM）如下。对于一个离散灰度级为 $q(x,y) \\in \\{0,1,\\dots, N_g - 1\\}$ 的图像和偏移量 $(\\Delta x,\\Delta y)$，共生矩阵 $P \\in \\mathbb{R}^{N_g \\times N_g}$ 的元素为\n$$\nP(i,j) = \\#\\left\\{(x,y) \\,\\big|\\, q(x,y) = i,\\; q(x+\\Delta x,y+\\Delta y) = j\\right\\},\n$$\n仅计算其中 $(x,y)$ 和 $(x+\\Delta x,y+\\Delta y)$ 都在图像域内的有效像素对。通过累加两个方向的计数（即同时累积 $(i,j)$ 和 $(j,i)$）来使用对称形式。进行归一化以获得概率矩阵 $\\hat{P} = P / \\sum_{i,j} P(i,j)$。使用 $\\hat{P}$ 计算特征对比度 $C$ 和同质性 $H$，定义如下\n$$\nC = \\sum_{i=0}^{N_g-1} \\sum_{j=0}^{N_g-1} (i - j)^2 \\, \\hat{P}(i,j),\n\\quad\nH = \\sum_{i=0}^{N_g-1} \\sum_{j=0}^{N_g-1} \\frac{\\hat{P}(i,j)}{1 + (i - j)^2}.\n$$\n使用水平偏移量 $(\\Delta x, \\Delta y) = (1,0)$。\n\n您的推理应基于香农-奈奎斯特采样定理：一个单位间距的离散采样网格的奈奎斯特极限为 $0.5$ 周期/像素，而通过因子 $s$ 进行向下采样会相应地降低新的奈奎斯特频率。不当重采样（没有足够的低通滤波）允许高于新奈奎斯特极限的频率分量折叠到较低频率（混叠），从而改变了局部的灰度关系，进而改变了GLCM特征。\n\n您的程序必须实现上述构建过程，并评估以下参数设置的测试套件，每个设置都会创建一个独特的体模和重采样场景：\n- 测试用例 $1$：光栅周期 $p = 3$ 像素，缩放因子 $s = 0.5$。\n- 测试用例 $2$：光栅周期 $p = 12$ 像素，缩放因子 $s = 0.5$。\n- 测试用例 $3$：无光栅（省略分量3），缩放因子 $s = 0.5$。\n- 测试用例 $4$：光栅周期 $p = 3$ 像素，缩放因子 $s = 1.0$。\n\n对于每个测试用例：\n1. 生成体模 $I(x,y)$（根据指定有或没有光栅）。\n2. 在原始体模上计算 $C_{\\mathrm{orig}}$ 和 $H_{\\mathrm{orig}}$（无重采样）。\n3. 在不当重采样的图像上计算 $C_{\\mathrm{improper}}$ 和 $H_{\\mathrm{improper}}$。\n4. 在适当重采样的图像上计算 $C_{\\mathrm{proper}}$ 和 $H_{\\mathrm{proper}}$。\n\n为每个测试报告一对差异值\n$$\n\\Delta C = C_{\\mathrm{improper}} - C_{\\mathrm{proper}},\n\\quad\n\\Delta H = H_{\\mathrm{improper}} - H_{\\mathrm{proper}},\n$$\n每个值都四舍五入到六位小数。将所有测试的结果按测试用例的顺序汇总成一个列表，每个测试的两个差异值交错排列。您的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，\"[dC1,dH1,dC2,dH2,dC3,dH3,dC4,dH4]\"）。不使用角度；偏移量直接以像素指定，因此不需要角度单位。所有输出均为无单位的纯浮点数，四舍五入到六位小数。", "solution": "该问题要求分析混叠对源自灰度共生矩阵（GLCM）的放射组学特征的影响。这将通过构建一个合成图像体模，对其进行两种不同的重采样流程（一种适当，一种不当），并量化由此产生的GLCM特征——对比度（Contrast）和同质性（Homogeneity）的差异来完成。整个过程基于信号处理和图像分析的基本原理。\n\n### 采样与混叠原理\n\n香农-奈奎斯特采样定理是本分析的理论基础。该定理指出，要从离散样本中完美重建一个连续时间信号，采样频率必须至少是信号中存在的最高频率分量的两倍。这个最低要求的采样频率被称为奈奎斯特速率。等效地，对于一个采样间隔为 $\\Delta t$ 的离散信号，能够被唯一表示的最高频率是奈奎斯特频率 $f_N = 1/(2\\Delta t)$。对于一个像素间距归一化为1的数字图像，奈奎斯特频率是 $f_N = 0.5$ 周期/像素。\n\n通过一个各向同性的缩放因子 $s  1$ 对图像进行向下采样，实际上是将采样间隔从 $1$ 增加到 $1/s$。因此，新的、更粗糙网格的奈奎斯特频率降低为 $f_{N, \\text{new}} = 0.5 \\times s$，单位是周期/原始像素间距。\n\n当原始图像包含高于这个新奈奎斯特频率 $f_{N, \\text{new}}$ 的频率时，就会发生混叠。这些高频分量并不仅仅是丢失了；它们被“折叠”或“混叠”到较低的频率范围 $[0, f_{N, \\text{new}}]$ 中，伪装成原始信号中不存在的新的、人为的模式。“不当”重采样方法使用直接的最近邻插值而没有任何预滤波，它无法阻止这种情况发生，因此如果输入图像包含足够高的频率，将出现混叠伪影。\n\n为避免混叠，必须执行抗混叠操作。这包括在重采样*之前*对原始图像应用低通滤波器，以移除任何高于 $f_{N, \\text{new}}$ 的频率分量。“适当”的重采样流程实现了这一点。对于缩放因子 $s  1$，它首先应用一个标准差为 $\\sigma = 0.6/s$ 的高斯低通滤波器。这个 $\\sigma$ 值是一个标准的启发式选择，旨在将滤波器的截止频率大致设置在新的奈奎斯特极限，从而有效衰减会导致混叠的频率。在此滤波步骤之后，使用双线性插值来执行重采样，与最近邻插值的块状伪影相比，它能提供更平滑的结果。\n\n### GLCM与纹理特征原理\n\n灰度共生矩阵（GLCM）是一种统计工具，通过统计在特定空间偏移下出现不同灰度值对的频率来分析纹理。对于一个量化为 $N_g$ 个灰度级的图像，GLCM（表示为 $P$）是一个 $N_g \\times N_g$ 的矩阵。对于偏移量 $(\\Delta x, \\Delta y)$，一个条目 $P(i,j)$ 计数了灰度级为 $i$ 的像素与在指定方向上灰度级为 $j$ 的像素相邻出现的次数。问题指定了一个对称的GLCM，这是通过将偏移量 $(\\Delta x, \\Delta y)$ 的GLCM与其转置相加来实现的。这使得分析对关系的方向不敏感（即，对 $(i,j)$ 与对 $(j,i)$ 同等对待）。然后将该矩阵归一化，形成一个概率分布 $\\hat{P}$。\n\n从这个概率矩阵计算纹理特征。问题指定了两个：\n1.  **对比度 (Contrast)**: $C = \\sum_{i=0}^{N_g-1} \\sum_{j=0}^{N_g-1} (i - j)^2 \\hat{P}(i,j)$。此特征衡量图像中的局部变化量。$(i-j)^2$ 项对灰度级差异大的像素对赋予更重的权重。高对比度表示存在急剧的过渡和高度的局部变化。混叠可能引入伪高频模式，预计会增加对比度特征。\n2.  **同质性 (Homogeneity)**: $H = \\sum_{i=0}^{N_g-1} \\sum_{j=0}^{N_g-1} \\frac{\\hat{P}(i,j)}{1 + (i - j)^2}$。此特征也称为逆差矩（Inverse Difference Moment），与对比度成反比。权重因子 $1/(1+(i-j)^2)$ 为灰度级相似的像素对赋予更高的值。高的同质性值表示图像局部变化少，纹理更均匀。预计混叠会降低同质性。\n\n### 算法实现\n\n解决方案通过遵循问题陈述中列出的步骤来实现。\n\n1.  **体模生成**：创建一个 $256 \\times 256$ 的体模。它以强度为 $0.2$ 的均匀背景开始。从 $(64,64)$ 到 $(191,191)$ 的方形区域被设置为强度 $0.8$。对于包含光栅的测试用例，在水平条带内添加一个正弦模式 $0.2 \\cos(2\\pi x/p)$。最终的强度值被裁剪到范围 $[0,1]$ 内。\n2.  **重采样**：\n    *   **不当重采样**通过使用 `scipy.ndimage.zoom` 并设置参数 `order=0` 来实现最近邻插值。\n    *   **适当重采样**是条件性实现的。如果缩放因子 $s  1$，首先对原始体模应用一个高斯滤波器（`scipy.ndimage.gaussian_filter`），其 $\\sigma=0.6/s$。然后，使用双线性插值（`scipy.ndimage.zoom` 并设置 `order=1`）对滤波后的图像进行重采样。如果 $s \\ge 1$，则跳过滤波步骤，仅应用双线性插值。\n3.  **量化**：所有图像（原始、不当重采样和适当重采样）都使用指定的舍入公式 $q = \\operatorname{round}(v(N_g-1))$ 量化为 $N_g=32$ 个灰度级，其中 $v$ 是像素强度。\n4.  **特征计算**：对于每个量化图像，为水平偏移 $(\\Delta x, \\Delta y) = (1,0)$ 计算一个对称的GLCM。这通过从相邻像素列创建一维灰度级数组并使用 `numpy.histogram2d` 来高效完成。生成的矩阵被对称化、归一化，然后用于根据其定义计算对比度和同质性。\n5.  **差异计算**：对于每个测试用例，使用不当重采样图像的特征 ($C_{\\mathrm{improper}}, H_{\\mathrm{improper}}$) 和适当重采样图像的特征 ($C_{\\mathrm{proper}}, H_{\\mathrm{proper}}$) 来计算差异 $\\Delta C = C_{\\mathrm{improper}} - C_{\\mathrm{proper}}$ 和 $\\Delta H = H_{\\mathrm{improper}} - H_{\\mathrm{proper}}$。\n\n此过程应用于四个指定的测试用例。差异 $\\Delta C$ 和 $\\Delta H$ 量化了混叠的影响。一个大的正 $\\Delta C$ 和一个大的负 $\\Delta H$ 表明两种重采样流程之间存在显著差异，这可归因于不当方法中的混叠伪影，而这些伪影在适当方法中被抗混叠滤波器所缓解。\n\n对于用例1（$p=3, s=0.5$），光栅频率 $f = 1/3 \\approx 0.333$ 周期/像素大于新的奈奎斯特频率 $f_{N, \\text{new}} = 0.5 \\times 0.5 = 0.25$ 周期/像素，导致强烈的混叠。我们预计差异会很大。对于用例2（$p=12, s=0.5$），光栅频率 $f = 1/12 \\approx 0.083$ 低于新的奈奎斯特极限，因此预计光栅不会产生混叠，差异应该很小。用例3（无光栅, $s=0.5$）隔离了对锐利边缘的影响。用例4（$p=3, s=1.0$）作为一个对照，其中没有发生向下采样，因此预计不会有因采样引起的混叠。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import ndimage\n\ndef generate_phantom(p=None, size=256):\n    \"\"\"\n    Constructs the synthetic image phantom.\n    \"\"\"\n    I = np.full((size, size), 0.2, dtype=np.float64)\n    I[64:192, 64:192] = 0.8\n    \n    if p is not None:\n        A = 0.2\n        x, y = np.meshgrid(np.arange(size), np.arange(size), indexing='xy')\n        \n        grating_mask = (x >= 32)  (x  224)  (y >= 96)  (y  160)\n        grating_term = A * np.cos(2 * np.pi * x / p)\n        \n        I[grating_mask] += grating_term[grating_mask]\n\n    return np.clip(I, 0.0, 1.0)\n\ndef quantize_image(img, Ng=32):\n    \"\"\"\n    Quantizes an image with intensities in [0,1] to Ng gray levels.\n    \"\"\"\n    quant_img = np.round(img * (Ng - 1))\n    return np.clip(quant_img, 0, Ng - 1).astype(int)\n\ndef resample_improper(img, s):\n    \"\"\"\n    Improper resampling using nearest-neighbor interpolation.\n    \"\"\"\n    return ndimage.zoom(img, s, order=0, mode='nearest')\n\ndef resample_proper(img, s):\n    \"\"\"\n    Proper resampling with anti-aliasing filter and bilinear interpolation.\n    \"\"\"\n    if s  1.0:\n        sigma = 0.6 / s\n        img_filtered = ndimage.gaussian_filter(img, sigma=sigma, mode='mirror')\n        return ndimage.zoom(img_filtered, s, order=1, mode='nearest')\n    else:  # s >= 1.0\n        return ndimage.zoom(img, s, order=1, mode='nearest')\n\ndef compute_glcm_features(quant_img, Ng=32):\n    \"\"\"\n    Computes a symmetric GLCM and its Contrast and Homogeneity features.\n    Offset is fixed to (dx=1, dy=0).\n    \"\"\"\n    if quant_img.shape[1] = 1:\n        return 0.0, 0.0\n\n    # Extract pixel pairs for a (1,0) offset\n    i_vals = quant_img[:, :-1].ravel()\n    j_vals = quant_img[:, 1:].ravel()\n\n    # Compute GLCM using histogram2d\n    glcm = np.histogram2d(\n        i_vals, j_vals,\n        bins=(np.arange(Ng + 1), np.arange(Ng + 1))\n    )[0]\n\n    # Make the GLCM symmetric\n    glcm = glcm + glcm.T\n\n    # Normalize the GLCM to get a probability matrix\n    glcm_sum = glcm.sum()\n    if glcm_sum == 0:\n        return 0.0, 0.0\n    p_hat = glcm / glcm_sum\n\n    # Compute features\n    i_matrix, j_matrix = np.meshgrid(np.arange(Ng), np.arange(Ng), indexing='ij')\n    \n    # Contrast\n    weight_c = (i_matrix - j_matrix)**2\n    contrast = np.sum(weight_c * p_hat)\n\n    # Homogeneity\n    weight_h = 1.0 / (1.0 + (i_matrix - j_matrix)**2)\n    homogeneity = np.sum(weight_h * p_hat)\n\n    return contrast, homogeneity\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {'p': 3, 's': 0.5},   # Case 1\n        {'p': 12, 's': 0.5},  # Case 2\n        {'p': None, 's': 0.5},# Case 3\n        {'p': 3, 's': 1.0},   # Case 4\n    ]\n\n    all_results = []\n    for case in test_cases:\n        p = case['p']\n        s = case['s']\n\n        # 1. Generate the original phantom\n        I_orig = generate_phantom(p=p)\n\n        # 2. Improper resampling pipeline\n        I_improper = resample_improper(I_orig, s)\n        Q_improper = quantize_image(I_improper)\n        C_improper, H_improper = compute_glcm_features(Q_improper)\n        \n        # 3. Proper resampling pipeline\n        I_proper = resample_proper(I_orig, s)\n        Q_proper = quantize_image(I_proper)\n        C_proper, H_proper = compute_glcm_features(Q_proper)\n\n        # 4. Calculate and store differences\n        delta_C = C_improper - C_proper\n        delta_H = H_improper - H_proper\n\n        all_results.extend([f\"{delta_C:.6f}\", f\"{delta_H:.6f}\"])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(all_results)}]\")\n\nsolve()\n```", "id": "4546567"}]}