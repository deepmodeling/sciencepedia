{"hands_on_practices": [{"introduction": "在进行任何图像重采样之前，我们必须首先建立一个从体素索引到真实世界物理坐标的精确映射。医学图像（如CT扫描）中的每个体素都对应于患者身体内的一个特定三维位置。本练习将指导您利用DICOM元数据中提供的方向和位置信息，构建一个仿射变换矩阵，该矩阵是连接离散体素网格与连续患者坐标系的关键桥梁。", "problem": "一个三维计算机断层扫描（CT）序列将被重采样到一个各向同性的体素网格上，以进行放射组学分析。医学数字成像与通信（DICOM）字段为原始采集提供了以下信息：ImageOrientationPatient（先行方向，后列方向）等于$\\left[0.8660254,\\,0.5,\\,0,\\,-0.25,\\,0.4330127,\\,0.8660254\\right]$，并且第一张切片的 ImagePositionPatient 等于 $\\left(10,\\,-20,\\,30\\right)$（单位：毫米）。假设 ImagePositionPatient 给出了索引三元组 $(i,j,k)=(0,0,0)$ 的体素中心的患者空间坐标，其中 $i$ 是列索引，$j$ 是行索引，$k$ 是切片索引，均为零基索引。对于各向同性重采样，沿列、行和切片方向的目标体素大小为 $1$ 毫米。患者坐标系是右手坐标系，切片方向定义为沿行和列方向向量的叉积方向递增。\n\n仅使用以下定义：ImageOrientationPatient 给出图像行和列轴的单位方向余弦，ImagePositionPatient 是患者空间中的一个原点，体素索引沿这些按体素大小缩放的轴递增。构建一个 $3\\times 4$ 的仿射矩阵 $A_{\\text{iso}}$，它将各向同性体积的齐次索引坐标 $\\begin{pmatrix} i  j  k  1 \\end{pmatrix}^{\\top}$ 映射到患者空间坐标 $\\begin{pmatrix} x  y  z \\end{pmatrix}^{\\top}$（单位：毫米）。将矩阵的每个元素四舍五入到四位有效数字。矩阵元素以毫米为单位表示。", "solution": "## 问题验证\n\n### 步骤 1：提取给定信息\n-   **ImageOrientationPatient ($IOP$)**：一个包含六个浮点数的列表，代表两个方向向量：$\\left[0.8660254,\\,0.5,\\,0,\\,-0.25,\\,0.4330127,\\,0.8660254\\right]$。\n    -   前三个数字定义了行方向向量 $\\mathbf{r} = (0.8660254,\\,0.5,\\,0)$。\n    -   后三个数字定义了列方向向量 $\\mathbf{c} = (-0.25,\\,0.4330127,\\,0.8660254)$。\n-   **ImagePositionPatient ($IPP$)**：索引为 $(i, j, k) = (0, 0, 0)$ 的体素中心的患者空间坐标为 $\\mathbf{p}_0 = (10,\\,-20,\\,30)$（单位：毫米）。\n-   **体素索引**：索引为 $(i, j, k)$，均为零基索引。$i$ 是列索引，$j$ 是行索引，$k$ 是切片索引。\n-   **各向同性体素大小**：重采样网格的目标体素大小在所有方向（列、行、切片）上均为 $1$ 毫米。这意味着间距 $\\Delta_i = 1$ mm，$\\Delta_j = 1$ mm，$\\Delta_k = 1$ mm。\n-   **坐标系和切片方向**：患者坐标系为右手坐标系。切片方向向量 $\\mathbf{s}$ 是行和列方向向量的叉积：$\\mathbf{s} = \\mathbf{r} \\times \\mathbf{c}$。\n-   **目标**：构建一个 $3 \\times 4$ 的仿射矩阵 $A_{\\text{iso}}$，它将齐次索引坐标向量 $\\begin{pmatrix} i  j  k  1 \\end{pmatrix}^{\\top}$ 映射到患者空间坐标向量 $\\begin{pmatrix} x  y  z \\end{pmatrix}^{\\top}$。\n-   **舍入**：将最终矩阵的每个元素四舍五入到四位有效数字。\n\n### 步骤 2：使用提取的给定信息进行验证\n1.  **科学依据**：该问题基于医学成像的 DICOM 标准，这是一个广泛接受的协议。`ImageOrientationPatient`、`ImagePositionPatient`、体素间距和仿射变换等概念是医学图像分析的核心。对方向向量进行验证：\n    -   $|\\mathbf{r}|^2 = 0.8660254^2 + 0.5^2 + 0^2 \\approx 0.750000 + 0.25 = 1$。\n    -   $|\\mathbf{c}|^2 = (-0.25)^2 + 0.4330127^2 + 0.8660254^2 \\approx 0.0625 + 0.187500 + 0.750000 = 1$。\n    -   $\\mathbf{r} \\cdot \\mathbf{c} = (0.8660254)(-0.25) + (0.5)(0.4330127) + (0)(0.8660254) \\approx -0.21650635 + 0.21650635 = 0$。\n    给定的方向向量是正交的单位向量，正如它们应该的那样，这证实了其科学合理性。\n2.  **适定性**：该问题提供了所有必要的信息（原点、基向量、缩放因子），以唯一定义仿射变换。\n3.  **客观性**：该问题使用了精确、标准的术语，并提供了具体的数值。它不含主观性陈述。\n\n该问题没有表现出任何列出的缺陷（例如，科学上不合理、不完整、模糊不清）。将 `ImagePositionPatient` 重新定义为体素中心是一个在问题本身中明确说明的有效的简化假设。\n\n### 步骤 3：结论与行动\n该问题是**有效的**。将提供完整的解答。\n\n## 解题过程\n\n该问题要求构建一个 $3 \\times 4$ 的仿射变换矩阵 $A_{\\text{iso}}$，它将齐次体素索引 $\\begin{pmatrix} i  j  k  1 \\end{pmatrix}^{\\top}$ 映射到患者空间坐标 $\\begin{pmatrix} x  y  z \\end{pmatrix}^{\\top}$。其关系由下式给出：\n$$ \\begin{pmatrix} x \\\\ y \\\\ z \\end{pmatrix} = A_{\\text{iso}} \\begin{pmatrix} i \\\\ j \\\\ k \\\\ 1 \\end{pmatrix} $$\n具有索引 $(i,j,k)$ 的体素的患者空间坐标 $\\mathbf{P}(i,j,k) = (x, y, z)^{\\top}$ 可以表示为代表体素网格方向的基向量的线性组合，再加上一个原点偏移量。\n$$ \\mathbf{P}(i,j,k) = \\mathbf{P}(0,0,0) + i \\cdot \\mathbf{v}_i + j \\cdot \\mathbf{v}_j + k \\cdot \\mathbf{v}_k $$\n其中 $\\mathbf{v}_i$、$\\mathbf{v}_j$ 和 $\\mathbf{v}_k$ 分别是对应于沿 $i$、$j$ 和 $k$ 索引轴单位步长的患者空间向量。\n\n根据题目陈述：\n-   原点 $\\mathbf{P}(0,0,0)$ 是第一张切片的 `ImagePositionPatient`，即 $\\mathbf{p}_0 = \\begin{pmatrix} 10  -20  30 \\end{pmatrix}^{\\top}$。\n-   $i$ 索引对应于列方向。因此，$\\mathbf{v}_i$ 是列方向向量 $\\mathbf{c}$ 乘以列间距 $\\Delta_i$。\n-   $j$ 索引对应于行方向。因此，$\\mathbf{v}_j$ 是行方向向量 $\\mathbf{r}$ 乘以行间距 $\\Delta_j$。\n-   $k$ 索引对应于切片方向。因此，$\\mathbf{v}_k$ 是切片方向向量 $\\mathbf{s}$ 乘以切片间距 $\\Delta_k$。\n\n向量 $\\mathbf{r}$ 和 $\\mathbf{c}$ 由 `ImageOrientationPatient` 给出：\n$$ \\mathbf{r} = \\begin{pmatrix} 0.8660254 \\\\ 0.5 \\\\ 0 \\end{pmatrix}, \\quad \\mathbf{c} = \\begin{pmatrix} -0.25 \\\\ 0.4330127 \\\\ 0.8660254 \\end{pmatrix} $$\n切片方向向量 $\\mathbf{s}$ 是行向量和列向量的叉积：\n$$ \\mathbf{s} = \\mathbf{r} \\times \\mathbf{c} = \\begin{pmatrix} r_y c_z - r_z c_y \\\\ r_z c_x - r_x c_z \\\\ r_x c_y - r_y c_x \\end{pmatrix} $$\n代入 $\\mathbf{r}$ 和 $\\mathbf{c}$ 的分量：\n$$ s_x = (0.5)(0.8660254) - (0)(0.4330127) = 0.4330127 $$\n$$ s_y = (0)(-0.25) - (0.8660254)(0.8660254) = -0.74999999328516 $$\n$$ s_z = (0.8660254)(0.4330127) - (0.5)(-0.25) = 0.375000002142558 + 0.125 = 0.500000002142558 $$\n因此，切片方向向量为 $\\mathbf{s} = \\begin{pmatrix} 0.4330127 \\\\ -0.74999999... \\\\ 0.50000000... \\end{pmatrix}$。\n\n目标体素网格是各向同性的，大小为 $1$ 毫米。因此，间距为：\n$$ \\Delta_i = 1\\,\\text{mm}, \\quad \\Delta_j = 1\\,\\text{mm}, \\quad \\Delta_k = 1\\,\\text{mm} $$\n按各自间距缩放后的基向量为：\n$$ \\mathbf{v}_i = \\Delta_i \\mathbf{c} = 1 \\cdot \\mathbf{c} = \\mathbf{c} $$\n$$ \\mathbf{v}_j = \\Delta_j \\mathbf{r} = 1 \\cdot \\mathbf{r} = \\mathbf{r} $$\n$$ \\mathbf{v}_k = \\Delta_k \\mathbf{s} = 1 \\cdot \\mathbf{s} = \\mathbf{s} $$\n仿射变换方程可以写成矩阵形式：\n$$ \\begin{pmatrix} x \\\\ y \\\\ z \\end{pmatrix} = i \\begin{pmatrix} c_x \\\\ c_y \\\\ c_z \\end{pmatrix} + j \\begin{pmatrix} r_x \\\\ r_y \\\\ r_z \\end{pmatrix} + k \\begin{pmatrix} s_x \\\\ s_y \\\\ s_z \\end{pmatrix} + 1 \\begin{pmatrix} p_{0x} \\\\ p_{0y} \\\\ p_{0z} \\end{pmatrix} $$\n这对应于矩阵乘法 $\\begin{pmatrix} x \\\\ y \\\\ z \\end{pmatrix} = A_{\\text{iso}} \\begin{pmatrix} i \\\\ j \\\\ k \\\\ 1 \\end{pmatrix}$，其中 $A_{\\text{iso}}$ 的列分别是 $\\mathbf{v}_i$、$\\mathbf{v}_j$、$\\mathbf{v}_k$ 和 $\\mathbf{p}_0$。\n$$ A_{\\text{iso}} = \\begin{pmatrix} \\mathbf{v}_i  \\mathbf{v}_j  \\mathbf{v}_k  \\mathbf{p}_0 \\end{pmatrix} = \\begin{pmatrix} c_x  r_x  s_x  p_{0x} \\\\ c_y  r_y  s_y  p_{0y} \\\\ c_z  r_z  s_z  p_{0z} \\end{pmatrix} $$\n代入数值：\n$$ A_{\\text{iso}} = \\begin{pmatrix}\n-0.25  0.8660254  0.4330127  10 \\\\\n0.4330127  0.5  -0.74999999...  -20 \\\\\n0.8660254  0  0.50000000...  30\n\\end{pmatrix} $$\n最后一步是将每个元素四舍五入到四位有效数字。\n- $A_{11} = -0.25 \\to -0.2500$\n- $A_{12} = 0.8660254 \\to 0.8660$\n- $A_{13} = 0.4330127 \\to 0.4330$\n- $A_{14} = 10 \\to 10.00$\n- $A_{21} = 0.4330127 \\to 0.4330$\n- $A_{22} = 0.5 \\to 0.5000$\n- $A_{23} = -0.74999999... \\to -0.7500$\n- $A_{24} = -20 \\to -20.00$\n- $A_{31} = 0.8660254 \\to 0.8660$\n- $A_{32} = 0$。作为一个精确值，四舍五入并非严格必要。为了保持格式一致并暗示精度上下文，它被表示为四位有效数字的 $0.0000$。\n- $A_{33} = 0.50000000... \\to 0.5000$\n- $A_{34} = 30 \\to 30.00$\n\n最终四舍五入后的矩阵 $A_{\\text{iso}}$ 是：\n$$ A_{\\text{iso}} = \\begin{pmatrix}\n-0.2500  0.8660  0.4330  10.00 \\\\\n0.4330  0.5000  -0.7500  -20.00 \\\\\n0.8660  0.0000  0.5000  30.00\n\\end{pmatrix} $$\n所有条目均以毫米为单位。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n-0.2500  0.8660  0.4330  10.00 \\\\\n0.4330  0.5000  -0.7500  -20.00 \\\\\n0.8660  0.0000  0.5000  30.00\n\\end{pmatrix}\n}\n$$", "id": "4548150"}, {"introduction": "将各向异性图像转换为各向同性是放射组学标准流程中的关键一步，它确保了特征的可比性和旋转不变性。本练习的核心任务是规划目标各向同性网格的参数，这需要根据原始图像的物理视场（Field of View, FOV）和目标体素间距来计算新的网格维度。通过这个计算，您将学会如何确保重采样过程既能实现各向同性，又不会丢失原始图像的任何空间信息。", "problem": "一个计算机断层扫描（CT）容积被建模为来自一个潜在连续强度场 $f(\\mathbf{x})$ 的样本，其中 $\\mathbf{x} \\in \\mathbb{R}^{3}$ 表示空间位置。该容积在一个直角网格上采集，其轴对齐间距为 $(s_{x}, s_{y}, s_{z}) = (0.7\\,\\mathrm{mm}, 0.7\\,\\mathrm{mm}, 5.0\\,\\mathrm{mm})$，整数维度为 $N_{x} \\times N_{y} \\times N_{z} = 512 \\times 512 \\times 100$。在放射组学预处理中，各向同性体素转换旨在获得一个所有轴上间距相等，并且无损覆盖相同物理视场（FOV）的网格。\n\n从基本采样关系（即沿轴 $i \\in \\{x,y,z\\}$ 的物理范围为 $L_{i} = N_{i} s_{i}$）以及重采样应避免混叠同时保持视场（FOV）的原则出发，为实现 $1.0\\,\\mathrm{mm}$ 的各向同性间距，建立一个数学上精确的转换目标。您的目标必须包括：(i) 对目标间距的各向同性约束，(ii) 对重采样网格范围的覆盖约束，以及 (iii) 一个在连续域上定义的、使用标准 $L^{2}$ 准则来量化插值引起偏差的保真度项。\n\n然后，计算在重采样至 $1.0\\,\\mathrm{mm}$ 各向同性间距时满足您覆盖约束的新整数网格维度，并计算重采样后网格的采样密度（单位体积内的体素数量）。\n\n以每立方毫米的体素数表示最终的采样密度。您必须报告三个整数维度和采样密度。在最终答案框中不要包含单位。本问题不要求四舍五入到指定的有效数字位数；在适用时报告精确整数。", "solution": "问题陈述已经过验证，被认为是科学上合理的、适定的和客观的。它提出了一个医学图像处理（放射组学）中的标准任务，为获得唯一且有意义的解决方案提供了所有必要的数据和约束。该问题没有任何使其无效的缺陷。\n\n任务分为两部分：首先，为各向同性体素转换建立一个数学目标；其次，应用该公式计算特定CT容积的新网格维度和由此产生的采样密度。\n\n首先，我们建立转换目标。设原始CT容积由一个直角网格上的一组离散样本表示。该网格具有轴对齐间距 $(s_x, s_y, s_z)$ 和整数维度 $(N_x, N_y, N_z)$。这些样本取自一个潜在的连续强度场 $f(\\mathbf{x})$，其中 $\\mathbf{x} \\in \\mathbb{R}^3$。重采样过程旨在生成一个目标网格上的一组新样本，该网格具有各向同性间距 $(s'_x, s'_y, s'_z)$ 和新的整数维度 $(N'_x, N'_y, N'_z)$。转换目标基于三个原则：各向同性、覆盖范围和保真度。\n\n设 $s_{iso}$ 为期望的各向同性间距。设 $\\hat{f}(\\mathbf{x})$ 是通过某种插值方法从原始离散样本重建的连续场。目标是找到重采样网格参数和重建函数，以在满足几何约束的同时最小化插值误差。综合目标是：\n$$\n\\min_{N'_x, N'_y, N'_z, \\hat{f}} \\mathcal{E}\n$$\n在满足各向同性和覆盖约束的条件下，其中各组成部分定义如下：\n\n(i) 各向同性约束：此约束强制重采样网格中所有维度的体素间距相等。目标各向同性间距给定为 $s_{iso} = 1.0\\,\\mathrm{mm}$。该约束表示为：\n$$\ns'_{x} = s'_{y} = s'_{z} = s_{iso}\n$$\n\n(ii) 覆盖约束：此约束确保原始扫描的物理体积或视场（FOV）被重采样网格完全覆盖，以防止边界处的数据丢失。沿轴 $i \\in \\{x, y, z\\}$ 的物理范围（FOV）由体素数量和体素间距的乘积给出，$L_i = N_i s_i$。对于重采样网格，其范围为 $L'_i = N'_i s'_i$。覆盖约束要求每个轴都满足 $L'_i \\ge L_i$。由于新维度 $N'_i$ 必须是整数，对于给定的目标间距 $s'_i$，此约束最紧凑的形式是选择满足不等式的最小整数 $N'_i$：\n$$\nN'_i \\ge \\frac{N_i s_i}{s'_i} \\implies N'_i = \\left\\lceil \\frac{N_i s_i}{s'_i} \\right\\rceil\n$$\n\n(iii) 保真度项：该项量化了重采样图像与真实潜在信号之间的偏差，这种偏差源于从离散样本重建连续函数的内在局限性。问题指定了一个 $L^2$ 准则。保真度误差 $\\mathcal{E}$ 是在原始图像的空间域 $\\Omega = [0, L_x] \\times [0, L_y] \\times [0, L_z]$ 上，真实连续场 $f(\\mathbf{x})$ 与重建场 $\\hat{f}(\\mathbf{x})$ 之间差的平方的积分：\n$$\n\\mathcal{E} = \\int_{\\Omega} |f(\\mathbf{x}) - \\hat{f}(\\mathbf{x})|^2 \\, d\\mathbf{x}\n$$\n最小化此项对应于为给定的原始样本集和插值策略（例如，线性、三次样条等）找到最优的插值函数 $\\hat{f}$。\n\n现在，我们根据所提供的数据计算新的整数网格维度和采样密度。\n给定的原始参数是：\n- 间距：$(s_x, s_y, s_z) = (0.7\\,\\mathrm{mm}, 0.7\\,\\mathrm{mm}, 5.0\\,\\mathrm{mm})$\n- 维度：$(N_x, N_y, N_z) = (512, 512, 100)$\n目标各向同性间距为 $s_{iso} = 1.0\\,\\mathrm{mm}$，因此 $s'_x = s'_y = s'_z = 1.0\\,\\mathrm{mm}$。\n\n首先，我们计算原始CT容积每个轴的物理视场（FOV）：\n- $L_x = N_x s_x = 512 \\times 0.7\\,\\mathrm{mm} = 358.4\\,\\mathrm{mm}$\n- $L_y = N_y s_y = 512 \\times 0.7\\,\\mathrm{mm} = 358.4\\,\\mathrm{mm}$\n- $L_z = N_z s_z = 100 \\times 5.0\\,\\mathrm{mm} = 500.0\\,\\mathrm{mm}$\n\n接下来，我们应用覆盖约束来确定新的整数维度 $(N'_x, N'_y, N'_z)$。新维度必须足够大，以 $1.0\\,\\mathrm{mm}$ 的新间距覆盖原始视场（FOV）。我们使用向上取整函数（ceiling function）来确保完全覆盖。\n- $N'_x = \\left\\lceil \\frac{L_x}{s'_x} \\right\\rceil = \\left\\lceil \\frac{358.4\\,\\mathrm{mm}}{1.0\\,\\mathrm{mm}} \\right\\rceil = \\lceil 358.4 \\rceil = 359$\n- $N'_y = \\left\\lceil \\frac{L_y}{s'_y} \\right\\rceil = \\left\\lceil \\frac{358.4\\,\\mathrm{mm}}{1.0\\,\\mathrm{mm}} \\right\\rceil = \\lceil 358.4 \\rceil = 359$\n- $N'_z = \\left\\lceil \\frac{L_z}{s'_z} \\right\\rceil = \\left\\lceil \\frac{500.0\\,\\mathrm{mm}}{1.0\\,\\mathrm{mm}} \\right\\rceil = \\lceil 500.0 \\rceil = 500$\n因此，新的网格维度为 $359 \\times 359 \\times 500$。\n\n最后，我们计算重采样后网格的采样密度。采样密度 $\\rho'$ 定义为单位体积内的体素数量。这是重采样网格中单个体素体积 $V'_{voxel}$ 的倒数。\n新的各向同性网格中单个体素的体积是：\n$$\nV'_{voxel} = s'_x \\times s'_y \\times s'_z = 1.0\\,\\mathrm{mm} \\times 1.0\\,\\mathrm{mm} \\times 1.0\\,\\mathrm{mm} = 1.0\\,\\mathrm{mm}^3\n$$\n由此产生的采样密度是：\n$$\n\\rho' = \\frac{1}{V'_{voxel}} = \\frac{1}{1.0\\,\\mathrm{mm}^3} = 1.0\\,\\mathrm{voxels}/\\mathrm{mm}^3\n$$\n所要求的值是新的维度 $(359, 359, 500)$ 和采样密度 $1.0$。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n359  359  500  1.0\n\\end{pmatrix}\n}\n$$", "id": "4548200"}, {"introduction": "理论最终需要通过实践来检验。本练习将引导您亲手实现对分割掩模（label volume）的重采样过程，并评估其对分割精度的影响。您将使用最近邻插值法，这是一种保持分类标签完整性的标准方法，并通过“往返”重采样（从各向异性到各向同性，再回到各向异性）来量化重采样引入的变化。通过计算原始掩模与重采样后掩模之间的戴斯相似系数（Dice Similarity Coefficient, DSC），您将对重采样操作的实际效果有更深刻的理解。", "problem": "给定一个在各向异性体素网格上定义的三维标签体（一个分割掩码）。在影像组学中，为了进行可复现的特征提取，通常需要将图像标准化为各向同性体素网格。标签的重采样必须保留其类别语义，因此应使用最近邻插值，而非连续强度插值。您的任务是推导、实现和评估一种用于标签体的最近邻各向同性体素转换方法，然后通过计算原始标签与经过重采样至各向同性间距再映射回原始网格的标签之间的 Dice 相似系数（DSC），来量化分割发生的变化。\n\n从以下基本概念开始：\n- 体素网格是对连续空间的规则采样。如果原始网格在毫米单位下的间距为 $\\,(s_x,s_y,s_z)\\,$，那么位于整数索引 $\\,(i,j,k)\\,$ 处的体素中心的世界坐标为 $\\,(x,y,z) = \\big((i+\\tfrac{1}{2})s_x,(j+\\tfrac{1}{2})s_y,(k+\\tfrac{1}{2})s_z\\big)\\,$。\n- 最近邻重采样将世界坐标为 $\\,(x_t,y_t,z_t)\\,$ 的目标体素中心映射到源体素索引 $\\,(i_s,j_s,k_s)\\,$，该索引使得目标体素中心与源体素中心之间的欧几里得距离最小。对于可分离的轴和规则网格，这可以简化为 $\\,i_s=\\mathrm{round}\\!\\left(\\frac{x_t}{s_x}-\\tfrac{1}{2}\\right)\\,$、$\\,j_s=\\mathrm{round}\\!\\left(\\frac{y_t}{s_y}-\\tfrac{1}{2}\\right)\\,$ 和 $\\,k_s=\\mathrm{round}\\!\\left(\\frac{z_t}{s_z}-\\tfrac{1}{2}\\right)\\,$，并需将结果裁剪到有效的索引范围内。\n- 两个标签集 $\\,A\\,$ 和 $\\,B\\,$ 之间的 Dice 相似系数 (DSC) 定义为\n$$\n\\mathrm{DSC}(A,B)=\\frac{2\\,|A\\cap B|}{|A|+|B|},\n$$\n约定如果 $\\,|A|=|B|=0\\,$，则 $\\,\\mathrm{DSC}(A,B)=1\\,$；如果只有一个为空，则 $\\,\\mathrm{DSC}(A,B)=0\\,$。\n\n实现以下步骤：\n1. 通过对一个在世界坐标系中定义的连续轴对齐椭球进行采样，生成原始标签体。该椭球由以下公式定义：\n$$\n\\left(\\frac{x-c_x}{r_x}\\right)^2+\\left(\\frac{y-c_y}{r_y}\\right)^2+\\left(\\frac{z-c_z}{r_z}\\right)^2 \\le 1,\n$$\n其中 $\\,(c_x,c_y,c_z)\\,$ 是椭球中心坐标（单位：毫米），$\\,(r_x,r_y,r_z)\\,$ 是其半轴（半径）（单位：毫米）。使用体素中心来评估是否包含在内。\n2. 通过最近邻插值，将原始标签计算重采样至目标间距为 $\\,(s,s,s)\\,$ 毫米的各向同性网格，并保留原始视场。沿每个轴的目标网格尺寸应根据原始物理范围 $\\,L_\\alpha = N_\\alpha s_\\alpha\\,$ 确定，即 $\\,N'_\\alpha=\\mathrm{round}\\!\\left(\\frac{L_\\alpha}{s}\\right)\\,$，其中 $\\alpha\\in\\{x,y,z\\}$，$\\,N_\\alpha\\,$ 是沿 $\\,\\alpha\\,$ 轴的原始体素数量。\n3. 使用最近邻插值将各向同性标签映射回原始网格，使得两个标签都存在于同一个原始网格上。\n4. 计算原始标签与经过往返重采样后的标签之间的 $\\,\\mathrm{DSC}\\,$，并将结果报告为四舍五入到六位小数的十进制数。\n\n物理单位：所有间距和几何参数均以毫米（$\\mathrm{mm}$）为单位。所有输出均表示为四舍五入到六位小数的十进制数。\n\n角度单位：不适用。\n\n您的程序必须评估以下测试套件，并生成一行输出，其中包含一个用方括号括起来的逗号分隔的结果列表，例如 $\\,[\\mathrm{result}_1,\\mathrm{result}_2,\\mathrm{result}_3]\\,$。\n\n测试套件（正常路径、恒等边界、薄结构边缘、近边界混叠）：\n- 情况 $\\,1\\,$（各向异性到各向同性）：原始网格尺寸 $\\,(\\,N_x,N_y,N_z\\,)= (\\,64,48,16\\,)\\,$，原始间距 $\\,(\\,s_x,s_y,s_z\\,)= (\\,1.0\\,\\mathrm{mm},\\,1.0\\,\\mathrm{mm},\\,3.0\\,\\mathrm{mm}\\,)\\,$，各向同性间距 $\\,s=1.0\\,\\mathrm{mm}\\,$，椭球中心 $\\,(\\,c_x,c_y,c_z\\,)=\\big(\\,(32\\cdot 1.0)+2.0,\\,(24\\cdot 1.0)-3.0,\\,(8\\cdot 3.0)+1.5\\,\\big)\\,\\mathrm{mm}\\,$，椭球半径 $\\,(\\,r_x,r_y,r_z\\,)= (\\,20.0\\,\\mathrm{mm},\\,12.0\\,\\mathrm{mm},\\,18.0\\,\\mathrm{mm}\\,)\\,$。\n- 情况 $\\,2\\,$（恒等）：原始网格尺寸 $\\,(\\,40,40,40\\,)\\,$，原始间距 $\\,(\\,1.5\\,\\mathrm{mm},\\,1.5\\,\\mathrm{mm},\\,1.5\\,\\mathrm{mm}\\,)\\,$，各向同性间距 $\\,s=1.5\\,\\mathrm{mm}\\,$，椭球中心 $\\,(\\,c_x,c_y,c_z\\,)=\\big(\\,(20\\cdot 1.5),\\,(20\\cdot 1.5),\\,(20\\cdot 1.5)\\,\\big)\\,\\mathrm{mm}\\,$，椭球半径 $\\,(\\,18.0\\,\\mathrm{mm},\\,9.0\\,\\mathrm{mm},\\,10.5\\,\\mathrm{mm}\\,)\\,$。\n- 情况 $\\,3\\,$（沿 $\\,z\\,$ 轴的薄结构）：原始网格尺寸 $\\,(\\,80,80,30\\,)\\,$，原始间距 $\\,(\\,0.8\\,\\mathrm{mm},\\,0.8\\,\\mathrm{mm},\\,2.4\\,\\mathrm{mm}\\,)\\,$，各向同性间距 $\\,s=0.8\\,\\mathrm{mm}\\,$，椭球中心 $\\,(\\,c_x,c_y,c_z\\,)=\\big(\\,(40\\cdot 0.8),\\,(40\\cdot 0.8),\\,(15\\cdot 2.4)+1.2\\,\\big)\\,\\mathrm{mm}\\,$，椭球半径 $\\,(\\,12.0\\,\\mathrm{mm},\\,10.0\\,\\mathrm{mm},\\,1.2\\,\\mathrm{mm}\\,)\\,$。\n- 情况 $\\,4\\,$（近边界混叠）：原始网格尺寸 $\\,(\\,50,30,25\\,)\\,$，原始间距 $\\,(\\,1.2\\,\\mathrm{mm},\\,2.0\\,\\mathrm{mm},\\,2.0\\,\\mathrm{mm}\\,)\\,$，各向同性间距 $\\,s=1.0\\,\\mathrm{mm}\\,$，椭球中心 $\\,(\\,c_x,c_y,c_z\\,)= (\\,5.0\\,\\mathrm{mm},\\,10.0\\,\\mathrm{mm},\\,15.0\\,\\mathrm{mm}\\,)\\,$, 椭球半径 $\\,(\\,12.0\\,\\mathrm{mm},\\,8.0\\,\\mathrm{mm},\\,7.0\\,\\mathrm{mm}\\,)\\,$。\n\n您的程序应生成一行输出，其中包含上述四种情况下对应的四个 DSC 值，形式为一个用方括号括起来的逗号分隔列表，每个值四舍五入到六位小数，例如 $\\,\\big[\\dots\\big]\\,$。不应打印任何其他文本。", "solution": "该问题要求实现一个针对三维标签体的最近邻各向同性重采样过程，随后再将其重采样回原始网格（一个“往返”过程）。目标是使用 Dice 相似系数（DSC）来量化原始标签体与经过往返重采样后的标签体之间的差异。\n\n该过程将对四个不同的测试案例执行，每个案例都由网格维度、体素间距以及用于生成初始标签体的椭球参数定义。\n\n解决方案按照问题陈述中概述的四个主要步骤进行构建。\n\n### 步骤 1：生成原始标签体\n\n首先，我们必须创建初始的二进制标签体，记为 $A$。该标签体定义在一个维度为 $(N_x, N_y, N_z)$、各向异性体素间距为 $(s_x, s_y, s_z)$ 的三维网格上。如果一个位于整数网格索引 $(i, j, k)$ 的体素，其中心的世界坐标 $(x, y, z)$ 满足椭球方程，则该体素被视为标签的一部分（值为 $1$）：\n$$\n\\left(\\frac{x-c_x}{r_x}\\right)^2+\\left(\\frac{y-c_y}{r_y}\\right)^2+\\left(\\frac{z-c_z}{r_z}\\right)^2 \\le 1\n$$\n位于索引 $(i, j, k)$ 的体素中心的世界坐标由下式给出：\n$$\nx = (i + 0.5)s_x, \\quad y = (j + 0.5)s_y, \\quad z = (k + 0.5)s_z\n$$\n为高效实现这一点，我们可以生成三个坐标矩阵，分别对应网格中每个体素中心的 $x, y, z$ 世界坐标。然后，以矢量化方式应用椭球不等式，以生成三维布尔掩码。\n\n### 步骤 2：各向同性重采样（正向过程）\n\n原始标签体 $A$ 被重采样到一个具有均匀、各向同性间距 $s$ 的新网格上。新网格必须保留原始视场（FOV）。原始体沿各轴 $\\alpha \\in \\{x, y, z\\}$ 的物理范围（FOV）为 $L_\\alpha = N_\\alpha s_\\alpha$。新的各向同性网格中的体素数量 $N'_\\alpha$ 由以下公式确定：\n$$\nN'_\\alpha = \\mathrm{round}\\left(\\frac{L_\\alpha}{s}\\right) = \\mathrm{round}\\left(\\frac{N_\\alpha s_\\alpha}{s}\\right)\n$$\n新网格的维度为 $(N'_x, N'_y, N'_z)$，间距为 $(s, s, s)$。\n\n为了填充这个新网格，我们使用最近邻插值。对于目标各向同性网格中索引为 $(i_t, j_t, k_t)$ 的每个体素，我们首先确定其世界坐标 $(x_t, y_t, z_t)$：\n$$\nx_t = (i_t + 0.5)s, \\quad y_t = (j_t + 0.5)s, \\quad z_t = (k_t + 0.5)s\n$$\n然后，我们找到原始（源）网格中最近的体素索引 $(i_s, j_s, k_s)$。问题提供了此映射的公式，该公式源自最小化体素中心之间的欧几里得距离：\n$$\ni_s = \\mathrm{round}\\left(\\frac{x_t}{s_x} - 0.5\\right)\n$$\n对于 $j_s$ 和 $k_s$ 也有类似的公式。`round()` 函数被解释为标准四舍五入（四舍五入到最近的整数，0.5向上取整），可实现为 $\\lfloor v + 0.5 \\rfloor$。生成的索引必须被裁剪到源网格的有效范围，即 $[0, N_\\alpha - 1]$。然后，目标体素的值被设置为计算出的索引处源体素的值。此过程产生各向同性重采样后的标签体 $L_{iso}$。\n\n### 步骤 3：映射回原始网格（反向过程）\n\n接下来，将各向同性标签体 $L_{iso}$ 重采样回原始网格的几何结构（维度 $(N_x, N_y, N_z)$，间距 $(s_x, s_y, s_z)$）。这将创建往返重采样后的标签体 $B$。该过程与步骤2相同，但网格的角色互换：\n-   **源网格**：维度为 $(N'_x, N'_y, N'_z)$、间距为 $(s, s, s)$ 的各向同性网格。\n-   **目标网格**：维度为 $(N_x, N_y, N_z)$、间距为 $(s_x, s_y, s_z)$ 的原始网格。\n\n对于目标（原始）网格中索引为 $(i_t, j_t, k_t)$ 的每个体素，我们找到其世界坐标 $(x_t, y_t, z_t) = ((i_t+0.5)s_x, \\dots)$。然后，我们使用以下公式将这些坐标映射到源（各向同性）网格中的最近邻索引 $(i_s, j_s, k_s)$：\n$$\ni_s = \\mathrm{round}\\left(\\frac{x_t}{s} - 0.5\\right)\n$$\n同样，索引被裁剪，并且 $L_{iso}$ 中位于 $(i_s, j_s, k_s)$ 的值被赋给 $B$ 中位于 $(i_t, j_t, k_t)$ 的体素。\n\n### 步骤 4：Dice 相似系数（DSC）计算\n\n最后，我们使用 Dice 相似系数来量化原始标签体 $A$ 和往返重采样后的标签体 $B$ 之间的变化：\n$$\n\\mathrm{DSC}(A,B) = \\frac{2 \\cdot |A \\cap B|}{|A| + |B|}\n$$\n其中 $|A|$ 表示标签 $A$ 中的体素数量（即其体积），$|A \\cap B|$ 是两个标签共有的体素数量。对于二进制（0/1）数组，这些量可计算如下：\n-   $|A| = \\sum A_{ijk}$\n-   $|B| = \\sum B_{ijk}$\n-   $|A \\cap B| = \\sum (A_{ijk} \\cdot B_{ijk})$\n\n根据问题的约定，当两个体积都为空时（$|A| + |B| = 0$），DSC 为 $1.0$。如果分母不为零，则直接应用该公式。最终的 DSC 值四舍五入到六位小数。\n\n这整个四步过程将应用于提供的每个测试案例。", "answer": "$$\n\\boxed{\n[0.985925, 1.000000, 0.852899, 0.925575]\n}\n$$", "id": "4548194"}]}