{"hands_on_practices": [{"introduction": "要理解偏置场校正的原理，一个有效的方法是亲手实践其核心的数学过程。在许多校正算法中，一个关键步骤是将在对数空间中呈现为加性的偏置场拟合为一个平滑函数。这个练习将指导您完成这一基本任务，使用最小二乘法将一个简单的B样条基函数模型拟合到给定的强度数据上，从而估算出潜在的偏置场。通过这个计算，您将具体地理解像N4ITK这样的常用算法是如何在基础层面运作的。[@problem_id:4531113]", "problem": "在放射组学中，磁共振成像（MRI）的强度不均匀性通常被建模为一个乘性的、缓慢变化的偏置场。考虑乘性模型 $I_{\\text{obs}}(x) = b(x)\\, I_{\\text{true}}(x) + n(x)$，其中 $I_{\\text{obs}}(x)$ 是空间位置 $x$ 处的观测强度，$I_{\\text{true}}(x)$ 是真实的潜在组织强度，$b(x)$ 是一个平滑的乘性偏置场，$n(x)$ 是本问题中我们将忽略的噪声。在一个用于放射组学强度标准化的均匀白质感兴趣区域内，通常假设 $I_{\\text{true}}(x) \\approx I_{\\text{ref}}$ 在空间上是常数。取自然对数可得到对数偏置的加性模型：$y(x) \\equiv \\ln I_{\\text{obs}}(x) - \\ln I_{\\text{ref}} \\approx \\ln b(x)$。非参数非均匀强度归一化Insight Toolkit（N4ITK）方法使用低频B样条基来表示 $\\ln b(x)$，并通过在一个掩模上最小化一个合适的数据保真度目标函数来估计其系数。\n\n考虑在一个白质区域内，沿着单个成像轴的一维剖面，其位置为 $x \\in \\{0, 1, 2, 3\\}$（以任意空间单位计），其中 $I_{\\text{ref}} = 100$。假设观测强度为 $I_{\\text{obs}}(0) = 100$，$I_{\\text{obs}}(1) = 100\\,\\exp(0.02)$，$I_{\\text{obs}}(2) = 100\\,\\exp(0.04)$，以及 $I_{\\text{obs}}(3) = 100\\,\\exp(0.06)$。在 N4ITK 的一个粗网格步骤中，使用一个具有两个控制点（位于 $x=0$ 和 $x=3$）的线性B样条展开来近似 $[0,3]$ 上的 $\\ln b(x)$，其基函数为\n- $B_{1}(x) = 1 - \\frac{x}{3}$ 在 $[0,3]$ 上成立，其他情况下 $B_{1}(x) = 0$，\n- $B_{2}(x) = \\frac{x}{3}$ 在 $[0,3]$ 上成立，其他情况下 $B_{2}(x) = 0$。\n假设在保真度项中，所有四个样本的权重均为单位权重。\n\n从乘性模型及其对数变换出发，建立B样条系数的最小二乘估计，并进行推导以计算在 $x_{0} = 1.5$ 处的预测对数偏置。然后，返回到乘性尺度，以获得这个粗略的 N4ITK 步骤将产生的估计偏置值 $\\hat{b}(x_{0})$。\n\n$\\hat{b}(1.5)$ 的值是多少？请用指数函数的形式给出您的最终答案的精确表达式。将结果报告为无量纲量；不要四舍五入。", "solution": "用户希望使用 N4ITK 偏置场校正算法的简化一维模型，来确定在特定点 $x_0 = 1.5$ 处的估计偏置场值 $\\hat{b}(x_0)$。\n\n问题从观测到的 MRI 强度的乘性模型开始：\n$$I_{\\text{obs}}(x) = b(x)\\, I_{\\text{true}}(x) + n(x)$$\n忽略噪声项 $n(x)$ 并假设在均匀区域内真实强度为常数 $I_{\\text{true}}(x) \\approx I_{\\text{ref}}$，模型简化为：\n$$I_{\\text{obs}}(x) \\approx b(x)\\, I_{\\text{ref}}$$\n对此方程取自然对数，得到对数偏置 $\\ln b(x)$ 的加性模型：\n$$\\ln(I_{\\text{obs}}(x)) \\approx \\ln(b(x)) + \\ln(I_{\\text{ref}})$$\n我们将待拟合的量 $y(x)$ 定义为观测到的对数偏置：\n$$y(x) \\equiv \\ln(I_{\\text{obs}}(x)) - \\ln(I_{\\text{ref}}) \\approx \\ln(b(x))$$\n问题提供了以下数据：\n- 样本点：$x \\in \\{0, 1, 2, 3\\}$。\n- 参考强度：$I_{\\text{ref}} = 100$。\n- 观测强度：\n  - $I_{\\text{obs}}(0) = 100$\n  - $I_{\\text{obs}}(1) = 100\\,\\exp(0.02)$\n  - $I_{\\text{obs}}(2) = 100\\,\\exp(0.04)$\n  - $I_{\\text{obs}}(3) = 100\\,\\exp(0.06)$\n\n首先，我们计算每个样本点处的观测对数偏置值 $y(x)$：\n- $y(0) = \\ln(I_{\\text{obs}}(0)) - \\ln(100) = \\ln(100) - \\ln(100) = 0$。\n- $y(1) = \\ln(I_{\\text{obs}}(1)) - \\ln(100) = \\ln(100\\,\\exp(0.02)) - \\ln(100) = \\ln(100) + 0.02 - \\ln(100) = 0.02$。\n- $y(2) = \\ln(I_{\\text{obs}}(2)) - \\ln(100) = \\ln(100\\,\\exp(0.04)) - \\ln(100) = \\ln(100) + 0.04 - \\ln(100) = 0.04$。\n- $y(3) = \\ln(I_{\\text{obs}}(3)) - \\ln(100) = \\ln(100\\,\\exp(0.06)) - \\ln(100) = \\ln(100) + 0.06 - \\ln(100) = 0.06$。\n\n对数偏置场 $\\ln b(x)$ 由两个基函数 $B_1(x) = 1 - \\frac{x}{3}$ 和 $B_2(x) = \\frac{x}{3}$ 的线性组合来近似：\n$$\\ln \\hat{b}(x) = c_1 B_1(x) + c_2 B_2(x)$$\n我们需要找到系数 $c_1$ 和 $c_2$，以最小化模型 $\\ln \\hat{b}(x_i)$ 与观测数据 $y(x_i)$ 之间的平方差之和。目标函数是：\n$$J(c_1, c_2) = \\sum_{i=0}^{3} (y(x_i) - (c_1 B_1(x_i) + c_2 B_2(x_i)))^2$$\n这是一个线性最小二乘问题，可以写成矩阵形式 $\\mathbf{A}\\mathbf{c} \\approx \\mathbf{y}$。解 $\\hat{\\mathbf{c}}$ 可以通过求解正规方程组 $(\\mathbf{A}^T \\mathbf{A}) \\hat{\\mathbf{c}} = \\mathbf{A}^T \\mathbf{y}$ 得到。\n\n观测向量 $\\mathbf{y}$ 是：\n$$\\mathbf{y} = \\begin{pmatrix} 0 \\\\ 0.02 \\\\ 0.04 \\\\ 0.06 \\end{pmatrix}$$\n设计矩阵 $\\mathbf{A}$ 是通过计算每个样本点 $x_i$ 处的基函数值来构建的：\n- $B_1(0) = 1$, $B_2(0) = 0$\n- $B_1(1) = 1 - 1/3 = 2/3$, $B_2(1) = 1/3$\n- $B_1(2) = 1 - 2/3 = 1/3$, $B_2(2) = 2/3$\n- $B_1(3) = 1 - 3/3 = 0$, $B_2(3) = 3/3 = 1$\n$$\\mathbf{A} = \\begin{pmatrix} B_1(0)  B_2(0) \\\\ B_1(1)  B_2(1) \\\\ B_1(2)  B_2(2) \\\\ B_1(3)  B_2(3) \\end{pmatrix} = \\begin{pmatrix} 1  0 \\\\ 2/3  1/3 \\\\ 1/3  2/3 \\\\ 0  1 \\end{pmatrix}$$\n待确定的系数向量是 $\\mathbf{c} = \\begin{pmatrix} c_1 \\\\ c_2 \\end{pmatrix}$。\n\n接下来，我们计算 $\\mathbf{A}^T \\mathbf{A}$ 和 $\\mathbf{A}^T \\mathbf{y}$：\n$$\\mathbf{A}^T \\mathbf{A} = \\begin{pmatrix} 1  2/3  1/3  0 \\\\ 0  1/3  2/3  1 \\end{pmatrix} \\begin{pmatrix} 1  0 \\\\ 2/3  1/3 \\\\ 1/3  2/3 \\\\ 0  1 \\end{pmatrix} = \\begin{pmatrix} 1+\\frac{4}{9}+\\frac{1}{9}  \\frac{2}{9}+\\frac{2}{9} \\\\ \\frac{2}{9}+\\frac{2}{9}  \\frac{1}{9}+\\frac{4}{9}+1 \\end{pmatrix} = \\begin{pmatrix} \\frac{14}{9}  \\frac{4}{9} \\\\ \\frac{4}{9}  \\frac{14}{9} \\end{pmatrix}$$\n$$\\mathbf{A}^T \\mathbf{y} = \\begin{pmatrix} 1  2/3  1/3  0 \\\\ 0  1/3  2/3  1 \\end{pmatrix} \\begin{pmatrix} 0 \\\\ 0.02 \\\\ 0.04 \\\\ 0.06 \\end{pmatrix} = \\begin{pmatrix} 0 \\cdot 1 + (2/3)(0.02) + (1/3)(0.04) + 0 \\cdot 0.06 \\\\ 0 \\cdot 0 + (1/3)(0.02) + (2/3)(0.04) + 1 \\cdot 0.06 \\end{pmatrix} = \\begin{pmatrix} \\frac{0.04}{3} + \\frac{0.04}{3} \\\\ \\frac{0.02}{3} + \\frac{0.08}{3} + \\frac{0.18}{3} \\end{pmatrix} = \\begin{pmatrix} \\frac{0.08}{3} \\\\ \\frac{0.28}{3} \\end{pmatrix}$$\n现在我们求解方程组 $(\\mathbf{A}^T \\mathbf{A}) \\mathbf{c} = \\mathbf{A}^T \\mathbf{y}$。我们求 $\\mathbf{A}^T \\mathbf{A}$ 的逆矩阵：\n$$\\det(\\mathbf{A}^T \\mathbf{A}) = \\left(\\frac{14}{9}\\right)^2 - \\left(\\frac{4}{9}\\right)^2 = \\frac{196 - 16}{81} = \\frac{180}{81}$$\n$$(\\mathbf{A}^T \\mathbf{A})^{-1} = \\frac{81}{180} \\begin{pmatrix} \\frac{14}{9}  -\\frac{4}{9} \\\\ -\\frac{4}{9}  \\frac{14}{9} \\end{pmatrix} = \\frac{9}{20} \\begin{pmatrix} \\frac{14}{9}  -\\frac{4}{9} \\\\ -\\frac{4}{9}  \\frac{14}{9} \\end{pmatrix} = \\frac{1}{20} \\begin{pmatrix} 14  -4 \\\\ -4  14 \\end{pmatrix}$$\n系数向量是 $\\mathbf{c} = (\\mathbf{A}^T \\mathbf{A})^{-1} (\\mathbf{A}^T \\mathbf{y})$：\n$$\\mathbf{c} = \\frac{1}{20} \\begin{pmatrix} 14  -4 \\\\ -4  14 \\end{pmatrix} \\begin{pmatrix} \\frac{0.08}{3} \\\\ \\frac{0.28}{3} \\end{pmatrix} = \\frac{1}{60} \\begin{pmatrix} 14(0.08) - 4(0.28) \\\\ -4(0.08) + 14(0.28) \\end{pmatrix} = \\frac{1}{60} \\begin{pmatrix} 1.12 - 1.12 \\\\ -0.32 + 3.92 \\end{pmatrix} = \\frac{1}{60} \\begin{pmatrix} 0 \\\\ 3.6 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 0.06 \\end{pmatrix}$$\n因此，我们求得系数为 $c_1 = 0$ 和 $c_2 = 0.06$。\n\n估计的对数偏置场为：\n$$\\ln \\hat{b}(x) = 0 \\cdot \\left(1 - \\frac{x}{3}\\right) + 0.06 \\cdot \\left(\\frac{x}{3}\\right) = 0.02x$$\n注意到，观测到的对数偏置数据 $y(x_i)$ 完全落在直线 $y=0.02x$ 上。由于该函数位于基函数张成的空间内，因此最小二乘拟合是精确的，平方误差和为零。\n\n问题要求计算在 $x_0 = 1.5$ 处的估计偏置值 $\\hat{b}(x_0)$。首先，我们计算该点的估计对数偏置：\n$$\\ln \\hat{b}(1.5) = 0.02 \\times 1.5 = 0.03$$\n最后，我们对该结果取指数，以得到乘性尺度上的偏置场值：\n$$\\hat{b}(1.5) = \\exp(\\ln \\hat{b}(1.5)) = \\exp(0.03)$$\n这是一个无量纲量，符合要求。", "answer": "$$\\boxed{\\exp(0.03)}$$", "id": "4531113"}, {"introduction": "在真实的医学图像中，我们通常无法假定用于估计偏置场的区域是完全均匀的，因为不同类型的组织常常并存。更高级的校正方法能够同时处理偏置场估计和组织分割这两个相互关联的问题。这个练习将向您介绍期望最大化（EM）算法，这是一种用于解决包含潜在（隐藏）变量问题的强大统计工具。您将学习如何为一个简化的图像强度生成模型构建框架，并实践如何通过迭代更新组织类别的后验概率（E步）和偏置场参数的估计（M步）来联合解决问题。[@problem_id:4531103]", "problem": "在磁共振成像 (MRI) 放射组学中，低频强度不均匀性（偏置场）会使体素强度失真，并可能干扰下游的特征提取。在一个小的同质区域内，通常可以将平滑的乘性偏置场近似为一个单一的常数因子。考虑一个用于小的双组织斑块的简化生成模型，其中体素 $i$ 的观测强度（记为 $y_i$）来自于一个潜在的组织类别 $z_{i} \\in \\{1,2\\}$，该类别具有特定于类的均值 $\\mu_k$ 和一个全局、未知的乘性偏置参数 $b>0$，并受到已知方差为 $\\sigma^2$ 的零均值高斯噪声的干扰。其条件分布为\n$$\np(y_{i} \\mid z_{i}=k, b) = \\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\,\\exp\\!\\left(-\\frac{(y_{i} - b\\,\\mu_{k})^{2}}{2\\sigma^{2}}\\right).\n$$\n假设混合先验为 $p(z_{i}=k) = \\pi_{k}$，且 $\\sum_{k=1}^{2}\\pi_{k}=1$。您将执行一次期望最大化 (EM) 算法（Expectation–Maximization (EM)）的迭代，以联合推断软分割（后验类别隶属度）并更新偏置参数 $b$。\n\n任务：\n1) 从潜变量模型的最大似然原理和完整数据对数似然的定义出发，在给定固定的类别均值 $\\mu_{1}, \\mu_{2}$、已知方差 $\\sigma^{2}$ 和混合权重 $\\pi_{1}, \\pi_{2}$ 的情况下，从第一性原理推导全局乘性偏置参数 $b$ 的最大化步更新的闭式解。您的推导必须通过构建在当前后验责任下的期望完整数据对数似然，然后对其关于 $b$ 进行优化来进行。\n\n2) 考虑 $N=4$ 个体素，其观测强度为 $y_{1}=82, y_{2}=120, y_{3}=78, y_{4}=130$。设类别均值为 $\\mu_{1}=110$ 和 $\\mu_{2}=80$，标准差为 $\\sigma=10$，混合权重为 $\\pi_{1}=\\pi_{2}=\\tfrac{1}{2}$。使用 $b^{(0)}=1$ 初始化 EM 算法。执行期望步以计算后验责任\n$$\n\\gamma_{ik} \\equiv p(z_{i}=k \\mid y_{i}, b^{(0)}, \\mu_{1}, \\mu_{2}, \\sigma^{2}, \\pi_{1}, \\pi_{2}),\n$$\n然后使用您推导的表达式执行最大化步，以计算更新后的偏置估计值 $b^{(1)}$。报告 $b^{(1)}$ 的数值，四舍五入到五位有效数字。将最终答案表示为一个无单位的纯数字。", "solution": "## 问题验证\n\n### 步骤 1：提取已知条件\n- **生成模型**：在给定潜在类别 $z_i=k$ 和偏置参数 $b$ 的情况下，观测到的体素强度 $y_i$ 的条件分布是一个高斯分布：\n$$\np(y_{i} \\mid z_{i}=k, b) = \\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\,\\exp\\!\\left(-\\frac{(y_{i} - b\\,\\mu_{k})^{2}}{2\\sigma^{2}}\\right)\n$$\n- **潜变量**：$z_i \\in \\{1,2\\}$ 是体素 $i$ 的组织类别。\n- **模型参数**：\n    - $\\mu_k$：类别 $k$ 的特定类别平均强度。\n    - $b$：一个全局、未知的乘性偏置参数，$b>0$。\n    - $\\sigma^2$：零均值高斯噪声的已知方差。\n- **先验分布**：混合先验 $p(z_i = k) = \\pi_k$，其中 $\\sum_{k=1}^{2} \\pi_k = 1$。\n- **任务 1**：从第一性原理推导 $b$ 的最大化步更新。\n- **任务 2**：执行一次期望最大化 (EM) 算法的迭代。\n- **任务 2 的数值数据**：\n    - 体素数量，$N=4$。\n    - 观测强度：$y_1=82, y_2=120, y_3=78, y_4=130$。\n    - 类别均值：$\\mu_1=110, \\mu_2=80$。\n    - 标准差：$\\sigma=10$，这意味着方差 $\\sigma^2=100$。\n    - 混合权重：$\\pi_1 = \\pi_2 = \\frac{1}{2}$。\n    - 初始偏置估计：$b^{(0)}=1$。\n- **责任的定义**：\n$$\n\\gamma_{ik} \\equiv p(z_{i}=k \\mid y_{i}, b^{(0)}, \\mu_{1}, \\mu_{2}, \\sigma^{2}, \\pi_{1}, \\pi_{2})\n$$\n\n### 步骤 2：使用提取的已知条件进行验证\n1.  **科学依据**：该问题描述了一个用于 MRI 强度的简化但标准的生成模型，其中包含了乘性偏置场和特定于组织的高斯统计。这是医学图像分析中的一种常用方法。应用 EM 算法来寻找此潜变量模型中参数的最大似然估计是一种典型且成熟的统计方法。该问题牢固地植根于应用于医学成像的统计建模和机器学习理论。\n2.  **适定性**：该问题是适定的。任务 1 要求进行标准推导，从而得出一个唯一的闭式更新方程。任务 2 提供了一整套参数和初始条件，确保 EM 算法的第一次迭代可以执行，从而为更新后的偏置参数 $b^{(1)}$ 得出唯一的数值结果。\n3.  **客观性**：该问题以精确的数学语言陈述，没有歧义或主观论断。\n4.  **完整性和一致性**：该问题提供了执行推导和数值计算所需的所有必要定义、数据和初始条件。所提供的信息中没有矛盾之处。\n5.  **无其他缺陷**：该问题是应用 EM 算法的一个标准的、非平凡的练习。它不是不适定的，对于理论问题来说并非不切实际，也不是同义反复的。\n\n### 步骤 3：结论与行动\n问题有效。将提供完整解答。\n\n---\n\n## 解答\n\n### 任务 1：推导偏置参数 $b$ 的 M 步更新\n\n期望最大化 (EM) 算法是一种在含有潜变量的统计模型中寻找参数的最大似然估计的迭代方法。该算法在期望 (E) 步和最大化 (M) 步之间交替进行。E 步使用当前的参数估计值，创建一个关于对数似然期望的函数；M 步则计算使 E 步中求得的期望对数似然最大化的参数。\n\n设观测数据为 $Y = \\{y_1, ..., y_N\\}$，潜在数据为 $Z = \\{z_1, ..., z_N\\}$。我们引入指示变量 $z_{ik}$，如果体素 $i$ 属于类别 $k$，则 $z_{ik}=1$，否则 $z_{ik}=0$。完整数据集为 $(Y, Z)$。待估计的参数记为 $\\theta$。在这个问题中，我们唯一更新的参数是 $b$，而 $\\mu_k$、$\\sigma^2$ 和 $\\pi_k$ 被视为固定值。\n\n完整数据似然由下式给出：\n$$L_c(\\theta; Y, Z) = p(Y, Z | \\theta) = \\prod_{i=1}^{N} p(y_i, z_i | \\theta) = \\prod_{i=1}^{N} \\prod_{k=1}^{2} [p(y_i|z_i=k, \\theta) p(z_i=k | \\theta)]^{z_{ik}}$$\n完整数据对数似然为：\n$$\\mathcal{L}_c(\\theta; Y, Z) = \\log L_c(\\theta; Y, Z) = \\sum_{i=1}^{N} \\sum_{k=1}^{2} z_{ik} \\left[ \\log p(y_i|z_i=k, \\theta) + \\log p(z_i=k | \\theta) \\right]$$\n代入给定的分布，其中 $\\theta$ 隐式地包含 $b$：\n$$p(y_i|z_i=k, b) = \\mathcal{N}(y_i; b\\mu_k, \\sigma^2)$$\n$$p(z_i=k) = \\pi_k$$\n完整数据对数似然变为：\n$$\\mathcal{L}_c(b; Y, Z) = \\sum_{i=1}^{N} \\sum_{k=1}^{2} z_{ik} \\left[ \\log\\left(\\frac{1}{\\sqrt{2\\pi}\\sigma}\\exp\\left(-\\frac{(y_i - b\\mu_k)^2}{2\\sigma^2}\\right)\\right) + \\log \\pi_k \\right]$$\n$$\\mathcal{L}_c(b; Y, Z) = \\sum_{i=1}^{N} \\sum_{k=1}^{2} z_{ik} \\left[ -\\frac{1}{2}\\log(2\\pi\\sigma^2) - \\frac{(y_i - b\\mu_k)^2}{2\\sigma^2} + \\log \\pi_k \\right]$$\n\n**E 步**：我们计算完整数据对数似然关于潜变量 $Z$ 的后验分布的期望，该后验分布是在给定观测数据 $Y$ 和当前参数估计 $b^{(t)}$ 的条件下的。这个函数记为 $Q(b | b^{(t)})$。\n$$Q(b | b^{(t)}) = E_{Z|Y, b^{(t)}}[\\mathcal{L}_c(b; Y, Z)]$$\n指示变量 $z_{ik}$ 的期望是后验概率，或称为责任，$\\gamma_{ik}^{(t)}$：\n$$E[z_{ik}] = p(z_i=k | y_i, b^{(t)}) = \\gamma_{ik}^{(t)}$$\n所以 $Q$ 函数是：\n$$Q(b | b^{(t)}) = \\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} \\left[ -\\frac{1}{2}\\log(2\\pi\\sigma^2) - \\frac{(y_i - b\\mu_k)^2}{2\\sigma^2} + \\log \\pi_k \\right]$$\n\n**M 步**：我们寻找使 $Q$ 函数最大化的参数 $b$。这将给出更新后的估计值 $b^{(t+1)}$。\n$$b^{(t+1)} = \\arg\\max_{b} Q(b | b^{(t)})$$\n为了对 $b$ 最大化 $Q(b | b^{(t)})$，我们只需要考虑依赖于 $b$ 的项。这等价于最小化以下表达式：\n$$J(b) = \\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} (y_i - b\\mu_k)^2$$\n我们对 $J(b)$ 关于 $b$ 求导，并令其为零：\n$$\\frac{\\partial J(b)}{\\partial b} = \\frac{\\partial}{\\partial b} \\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} (y_i^2 - 2by_i\\mu_k + b^2\\mu_k^2) = 0$$\n$$\\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} (-2y_i\\mu_k + 2b\\mu_k^2) = 0$$\n$$-2\\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} y_i\\mu_k + 2b\\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} \\mu_k^2 = 0$$\n求解 $b$：\n$$b \\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} \\mu_k^2 = \\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} y_i\\mu_k$$\n这就得出了 $b^{(t+1)}$ 的 M 步更新方程：\n$$b^{(t+1)} = \\frac{\\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} y_i \\mu_k}{\\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} \\mu_k^2}$$\n\n### 任务 2：数值计算\n\n给定 $N=4$ 个体素，其强度为 $y = \\{82, 120, 78, 130\\}$，类别均值为 $\\mu_1=110$ 和 $\\mu_2=80$，标准差为 $\\sigma=10$（即 $\\sigma^2=100$），混合权重为 $\\pi_1=\\pi_2=\\frac{1}{2}$。初始偏置估计为 $b^{(0)}=1$。\n\n**在迭代 $t=0$ 时的 E 步**：我们使用 $b^{(0)}=1$ 计算责任 $\\gamma_{ik}^{(0)}$。\n责任 $\\gamma_{ik}^{(0)}$ 由贝叶斯定理给出：\n$$\\gamma_{ik}^{(0)} = p(z_i=k | y_i, b^{(0)}) = \\frac{p(y_i | z_i=k, b^{(0)}) p(z_i=k)}{\\sum_{j=1}^{2} p(y_i | z_i=j, b^{(0)}) p(z_i=j)}$$\n由于 $\\pi_1 = \\pi_2$，先验项可以消去。令 $\\mathcal{L}_{ik} = p(y_i|z_i=k, b^{(0)})$。\n对于给定的 $i$，项 $\\frac{1}{\\sqrt{2\\pi}\\sigma}$ 对所有的 $\\mathcal{L}_{ik}$ 都是公共的，因此也会消去。我们只需要指数部分来计算责任：\n$$\\gamma_{i1}^{(0)} = \\frac{\\exp\\left(-\\frac{(y_i - b^{(0)}\\mu_1)^2}{2\\sigma^2}\\right)}{\\exp\\left(-\\frac{(y_i - b^{(0)}\\mu_1)^2}{2\\sigma^2}\\right) + \\exp\\left(-\\frac{(y_i - b^{(0)}\\mu_2)^2}{2\\sigma^2}\\right)}$$\n并且 $\\gamma_{i2}^{(0)} = 1 - \\gamma_{i1}^{(0)}$。当 $b^{(0)}=1$, $\\mu_1=110$, $\\mu_2=80$, $\\sigma^2=100$ 时：\n\n- 对于 $i=1, y_1=82$：\n  - $(y_1 - b^{(0)}\\mu_1)^2 = (82 - 110)^2 = (-28)^2 = 784$。\n  - $(y_1 - b^{(0)}\\mu_2)^2 = (82 - 80)^2 = (2)^2 = 4$。\n  - $\\gamma_{11}^{(0)} = \\frac{\\exp(-784/200)}{\\exp(-784/200) + \\exp(-4/200)} = \\frac{\\exp(-3.92)}{\\exp(-3.92) + \\exp(-0.02)} \\approx 0.019839$。\n  - $\\gamma_{12}^{(0)} = 1 - \\gamma_{11}^{(0)} \\approx 0.980161$。\n\n- 对于 $i=2, y_2=120$：\n  - $(y_2 - b^{(0)}\\mu_1)^2 = (120 - 110)^2 = (10)^2 = 100$。\n  - $(y_2 - b^{(0)}\\mu_2)^2 = (120 - 80)^2 = (40)^2 = 1600$。\n  - $\\gamma_{21}^{(0)} = \\frac{\\exp(-100/200)}{\\exp(-100/200) + \\exp(-1600/200)} = \\frac{\\exp(-0.5)}{\\exp(-0.5) + \\exp(-8)} \\approx 0.999448$。\n  - $\\gamma_{22}^{(0)} = 1 - \\gamma_{21}^{(0)} \\approx 0.000552$。\n\n- 对于 $i=3, y_3=78$：\n  - $(y_3 - b^{(0)}\\mu_1)^2 = (78 - 110)^2 = (-32)^2 = 1024$。\n  - $(y_3 - b^{(0)}\\mu_2)^2 = (78 - 80)^2 = (-2)^2 = 4$。\n  - $\\gamma_{31}^{(0)} = \\frac{\\exp(-1024/200)}{\\exp(-1024/200) + \\exp(-4/200)} = \\frac{\\exp(-5.12)}{\\exp(-5.12) + \\exp(-0.02)} \\approx 0.006059$。\n  - $\\gamma_{32}^{(0)} = 1 - \\gamma_{31}^{(0)} \\approx 0.993941$。\n\n- 对于 $i=4, y_4=130$：\n  - $(y_4 - b^{(0)}\\mu_1)^2 = (130 - 110)^2 = (20)^2 = 400$。\n  - $(y_4 - b^{(0)}\\mu_2)^2 = (130 - 80)^2 = (50)^2 = 2500$。\n  - $\\gamma_{41}^{(0)} = \\frac{\\exp(-400/200)}{\\exp(-400/200) + \\exp(-2500/200)} = \\frac{\\exp(-2)}{\\exp(-2) + \\exp(-12.5)} \\approx 0.999973$。\n  - $\\gamma_{42}^{(0)} = 1 - \\gamma_{41}^{(0)} \\approx 0.000027$。\n\n**M 步**：我们使用推导出的公式和计算出的责任来计算更新后的偏置 $b^{(1)}$。\n$$b^{(1)} = \\frac{\\sum_{i=1}^{4} (\\gamma_{i1}^{(0)} y_i \\mu_1 + \\gamma_{i2}^{(0)} y_i \\mu_2)}{\\sum_{i=1}^{4} (\\gamma_{i1}^{(0)} \\mu_1^2 + \\gamma_{i2}^{(0)} \\mu_2^2)}$$\n首先，计算分子：\n分子 = $(\\gamma_{11}^{(0)} y_1 \\mu_1 + \\gamma_{12}^{(0)} y_1 \\mu_2) + (\\gamma_{21}^{(0)} y_2 \\mu_1 + \\gamma_{22}^{(0)} y_2 \\mu_2) + \\dots$\n- $i=1$：$(0.019839 \\times 82 \\times 110) + (0.980161 \\times 82 \\times 80) \\approx 179.0 + 6429.9 \\approx 6608.9$\n- $i=2$：$(0.999448 \\times 120 \\times 110) + (0.000552 \\times 120 \\times 80) \\approx 13192.7 + 5.3 \\approx 13198.0$\n- $i=3$：$(0.006059 \\times 78 \\times 110) + (0.993941 \\times 78 \\times 80) \\approx 52.0 + 6202.4 \\approx 6254.4$\n- $i=4$：$(0.999973 \\times 130 \\times 110) + (0.000027 \\times 130 \\times 80) \\approx 14299.6 + 0.3 \\approx 14299.9$\n分子之和 $\\approx 6608.9 + 13198.0 + 6254.4 + 14299.9 = 40361.2$\n\n接下来，计算分母，其中 $\\mu_1^2=12100$ 且 $\\mu_2^2=6400$：\n分母 = $(\\gamma_{11}^{(0)} \\mu_1^2 + \\gamma_{12}^{(0)} \\mu_2^2) + (\\gamma_{21}^{(0)} \\mu_1^2 + \\gamma_{22}^{(0)} \\mu_2^2) + \\dots$\n- $i=1$：$(0.019839 \\times 12100) + (0.980161 \\times 6400) \\approx 240.1 + 6273.0 \\approx 6513.1$\n- $i=2$：$(0.999448 \\times 12100) + (0.000552 \\times 6400) \\approx 12093.3 + 3.5 \\approx 12096.8$\n- $i=3$：$(0.006059 \\times 12100) + (0.993941 \\times 6400) \\approx 73.3 + 6361.2 \\approx 6434.5$\n- $i=4$：$(0.999973 \\times 12100) + (0.000027 \\times 6400) \\approx 12099.7 + 0.2 \\approx 12099.9$\n分母之和 $\\approx 6513.1 + 12096.8 + 6434.5 + 12099.9 = 37144.3$\n\n最后，我们计算 $b^{(1)}$：\n$$b^{(1)} = \\frac{40361.2}{37144.3} \\approx 1.086598$$\n四舍五入到五位有效数字，更新后的偏置估计值为 $1.0866$。", "answer": "$$\\boxed{1.0866}$$", "id": "4531103"}, {"introduction": "在影像组学中，应用任何图像处理算法后，验证其效果是必不可少的。对于偏置场校正而言，最终的衡量标准是：校正是否真正提高了我们所关注的影像组学特征的稳定性和可重复性？这个练习将向您展示如何使用严谨的统计学方法来回答这个问题。您将利用配对$t$检验来分析测试-重测数据，从而判断经过偏置场校正后，特征误差的减小是否具有统计学显著性。掌握这项技能对于任何研究人员或从业者都至关重要，它教您如何科学地评估算法的实际效用。[@problem_id:4531093]", "problem": "考虑磁共振成像 (MRI)，其中在扫描 $j$ 中，空间位置 $\\mathbf{x}$ 处的观测强度可以表示为 $I_{j}(\\mathbf{x}) = B_{j}(\\mathbf{x})\\,S(\\mathbf{x}) + \\varepsilon_{j}(\\mathbf{x})$，其中 $B_{j}(\\mathbf{x})$ 代表一个平滑的乘性偏置场，$S(\\mathbf{x})$ 是真实的潜在信号，而 $\\varepsilon_{j}(\\mathbf{x})$ 是随机噪声。在放射组学中，一个标量特征 $F$ 是图像强度分布的一个确定性泛函；对于一个固定的受试者 $i$ 和扫描 $r \\in \\{1,2\\}$，将偏置场校正前的特征记为 $F_{i,r}^{\\text{pre}}$，校正后的特征记为 $F_{i,r}^{\\text{post}}$。校正方法的目的是减少由 $B_{j}(\\mathbf{x})$ 引入的虚假变异性，从而使特征 $F$ 在重复扫描中更具可复现性。\n\n假设对每位受试者 $i$ 进行测试-重测采集，得到两个校正前的特征测量值 $F_{i,1}^{\\text{pre}}$ 和 $F_{i,2}^{\\text{pre}}$，以及两个校正后的测量值 $F_{i,1}^{\\text{post}}$ 和 $F_{i,2}^{\\text{post}}$。定义每位受试者的绝对测试-重测误差为 $e_{i}^{\\text{pre}} = \\lvert F_{i,1}^{\\text{pre}} - F_{i,2}^{\\text{pre}} \\rvert$ 和 $e_{i}^{\\text{post}} = \\lvert F_{i,1}^{\\text{post}} - F_{i,2}^{\\text{post}} \\rvert$。令配对差异为 $d_{i} = e_{i}^{\\text{pre}} - e_{i}^{\\text{post}}$。感兴趣的假设是单侧检验 $H_{0}: \\mu_{d} = 0$ 对比 $H_{1}: \\mu_{d} > 0$，其中 $\\mu_{d}$ 是 $d_{i}$ 的总体均值。在假设受试者是独立的，并且标准化均值差异的抽样分布近似服从学生t分布（Student’s $t$-distribution）的条件下，计算观测到的配对差异的单侧p值，并判断在显著性水平 $\\alpha = 0.05$ 下，偏置场校正后可复现性的改善是否具有统计显著性。\n\n你的程序必须：\n- 对于每个测试用例，计算 $e_{i}^{\\text{pre}}$、$e_{i}^{\\text{post}}$、配对差异 $d_{i}$、针对 $H_{1}: \\mu_{d} > 0$ 的单侧p值，并输出一个决策整数，其中 $1$ 表示在 $\\alpha = 0.05$ 时拒绝 $H_{0}$，$0$ 表示未能拒绝 $H_{0}$。\n- 如果 $d_{i}$ 的样本标准差为零或样本量小于 $2$，则将p值定义为 $1.0$，决策定义为 $0$。\n- 将每个p值四舍五入到六位小数。\n\n测试套件（每个用例列出每位受试者的配对数据；配对数据是单个放射组学特征在校正前和校正后的两次测量值）：\n\n- 用例 $1$（普遍改善，$10$ 名受试者）：\n  受试者 $1$：校正前 $(100, 110)$，校正后 $(100, 102)$。\n  受试者 $2$：校正前 $(95, 85)$，校正后 $(95, 96)$。\n  受试者 $3$：校正前 $(120, 130)$，校正后 $(120, 119)$。\n  受试者 $4$：校正前 $(80, 92)$，校正后 $(80, 81)$。\n  受试者 $5$：校正前 $(60, 72)$，校正后 $(60, 63)$。\n  受试者 $6$：校正前 $(105, 99)$，校正后 $(105, 104)$。\n  受试者 $7$：校正前 $(140, 150)$，校正后 $(140, 142)$。\n  受试者 $8$：校正前 $(77, 88)$，校正后 $(77, 78)$。\n  受试者 $9$：校正前 $(90, 104)$，校正后 $(90, 92)$。\n  受试者 $10$：校正前 $(112, 100)$，校正后 $(112, 111)$。\n\n- 用例 $2$（无改善，误差相同，$4$ 名受试者）：\n  受试者 $1$：校正前 $(100, 105)$，校正后 $(100, 105)$。\n  受试者 $2$：校正前 $(95, 100)$，校正后 $(95, 100)$。\n  受试者 $3$：校正前 $(120, 115)$，校正后 $(120, 115)$。\n  受试者 $4$：校正前 $(80, 85)$，校正后 $(80, 85)$。\n\n- 用例 $3$（小样本，混合效应，$3$ 名受试者）：\n  受试者 $1$：校正前 $(90, 98)$，校正后 $(90, 95)$。\n  受试者 $2$：校正前 $(110, 117)$，校正后 $(110, 117)$。\n  受试者 $3$：校正前 $(70, 76)$，校正后 $(70, 74)$。\n\n- 用例 $4$（校正后更差，$5$ 名受试者）：\n  受试者 $1$：校正前 $(100, 102)$，校正后 $(100, 104)$。\n  受试者 $2$：校正前 $(95, 96)$，校正后 $(95, 98)$。\n  受试者 $3$：校正前 $(120, 123)$，校正后 $(120, 126)$。\n  受试者 $4$：校正前 $(80, 82)$，校正后 $(80, 82)$。\n  受试者 $5$：校正前 $(60, 61)$，校正后 $(60, 65)$。\n\n最终输出格式：\n你的程序应生成单行输出，包含四个用例的结果列表，其中每个用例的结果是一个双元素列表 $[p, d]$，$p$ 是四舍五入到六位小数的单侧p值，$d$ 是决策整数（$1$ 或 $0$）。例如，输出必须采用 $[[p_{1},d_{1}],[p_{2},d_{2}],[p_{3},d_{3}],[p_{4},d_{4}]]$ 的形式，不得包含其他文本。", "solution": "该问题要求对磁共振成像 (MRI) 放射组学中偏置场校正算法的有效性进行统计评估。具体来说，我们需要确定校正方法是否能对放射组学特征 $F$ 的可复现性带来统计上显著的改善。这种改善通过绝对测试-重测误差的减少来量化。这将通过对一组受试者在校正前后测量的测试-重测误差执行单侧配对学生t检验（Student's $t$-test）来完成。\n\n问题的核心在于假设检验。对于每位受试者 $i$，我们都有一组配对数据：校正前的一对测试-重测测量值 $(F_{i,1}^{\\text{pre}}, F_{i,2}^{\\text{pre}})$，以及校正后的一对测量值 $(F_{i,1}^{\\text{post}}, F_{i,2}^{\\text{post}})$。受试者 $i$ 在校正前的绝对测试-重测误差定义为 $e_{i}^{\\text{pre}} = \\lvert F_{i,1}^{\\text{pre}} - F_{i,2}^{\\text{pre}} \\rvert$，校正后的误差定义为 $e_{i}^{\\text{post}} = \\lvert F_{i,1}^{\\text{post}} - F_{i,2}^{\\text{post}} \\rvert$。\n\n为评估改善情况，我们考虑每位受试者的配对差异 $d_{i} = e_{i}^{\\text{pre}} - e_{i}^{\\text{post}}$。$d_{i}$ 的正值表示校正后受试者 $i$ 的测试-重测误差减小，意味着可复现性有所提高。我们的目标是检验这种改善在群体中是否是系统性的，而不仅仅是随机偶然的结果。\n\n统计假设是针对这些差异的总体均值 $\\mu_{d}$ 来制定的：\n- 零假设 ($H_{0}$): $\\mu_{d} = 0$。该假设表明，平均而言，校正前和校正后的误差没有差异。观测到的差异是由随机抽样变异性引起的。\n- 备择假设 ($H_{1}$): $\\mu_{d} > 0$。该假设断定，偏置场校正系统性地减少了测试-重测误差，导致了正的均值差异。\n\n这是一个单侧（右尾）检验，因为我们特别关心校正是否*改善*了可复现性（即减少误差）。问题指出，标准化均值差异服从学生t分布。这是配对t检验的基础。\n\n每个测试用例的处理步骤如下：\n\n1.  **计算配对差异**：对于一个包含 $n$ 名受试者的样本，计算差异向量 $\\mathbf{d} = [d_1, d_2, \\ldots, d_n]$，其中 $d_i = \\lvert F_{i,1}^{\\text{pre}} - F_{i,2}^{\\text{pre}} \\rvert - \\lvert F_{i,1}^{\\text{post}} - F_{i,2}^{\\text{post}} \\rvert$。\n\n2.  **处理边界情况**：问题规定，如果样本量 $n  2$ 或差异的样本标准差为 $0$，则检验无定论。在这些情况下，p值定义为 $1.0$，我们未能拒绝 $H_0$。样本量小于 $2$ 无法计算样本标准差。标准差为 $0$ 意味着所有 $d_i$ 值都相同；如果它们的均值不大于 $0$，则没有证据反对 $H_0$。如果它们的均值大于 $0$ 但 $s_d = 0$，t统计量将为无穷大，这是一个有问题的奇点。该规则提供了一种处理这种情况的实用方法。\n\n3.  **计算检验统计量**：如果 $n \\ge 2$ 且样本标准差 $s_d  0$，我们继续进行计算。\n    -   计算差异的样本均值：\n        $$ \\bar{d} = \\frac{1}{n} \\sum_{i=1}^{n} d_i $$\n    -   计算差异的样本标准差（使用贝塞尔校正）：\n        $$ s_d = \\sqrt{\\frac{1}{n-1} \\sum_{i=1}^{n} (d_i - \\bar{d})^2} $$\n    -   计算均值差异的标准误：\n        $$ SE(\\bar{d}) = \\frac{s_d}{\\sqrt{n}} $$\n    -   计算t统计量，它衡量样本均值 $\\bar{d}$ 与假设均值 $0$ 相差多少个标准误：\n        $$ t = \\frac{\\bar{d} - 0}{SE(\\bar{d})} = \\frac{\\bar{d}}{s_d / \\sqrt{n}} $$\n\n4.  **计算p值**：p值是在假设零假设为真的情况下，观测到至少与计算出的t统计量一样极端的t统计量的概率。对于我们的右尾检验，这对应于自由度为 $\\nu = n-1$ 的学生t分布概率密度函数在我们计算的t统计量右侧的面积。\n    $$ p = P(T_{\\nu} \\ge t) $$\n    这通过t分布的生存函数（1减去累积分布函数）来计算。然后将p值四舍五入到六位小数。\n\n5.  **做出决策**：将p值与给定的显著性水平 $\\alpha = 0.05$ 进行比较。\n    -   如果 $p \\le \\alpha$，我们拒绝零假设 $H_0$。这表明观测到的误差减少在统计上是显著的。决策由整数 $1$ 表示。\n    -   如果 $p  \\alpha$，我们未能拒绝零假设 $H_0$。没有足够的证据断定校正方法改善了可复现性。决策由整数 $0$ 表示。\n\n每个用例的最终输出是一个包含四舍五入后的p值和决策整数的双元素列表。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import t\n\ndef solve():\n    \"\"\"\n    Computes one-sided p-values and decisions for a paired t-test\n    on radiomics feature reproducibility improvement.\n    \"\"\"\n    # Test suite data as provided in the problem statement.\n    test_cases = [\n        # Case 1\n        [\n            {'pre': (100, 110), 'post': (100, 102)},\n            {'pre': (95, 85), 'post': (95, 96)},\n            {'pre': (120, 130), 'post': (120, 119)},\n            {'pre': (80, 92), 'post': (80, 81)},\n            {'pre': (60, 72), 'post': (60, 63)},\n            {'pre': (105, 99), 'post': (105, 104)},\n            {'pre': (140, 150), 'post': (140, 142)},\n            {'pre': (77, 88), 'post': (77, 78)},\n            {'pre': (90, 104), 'post': (90, 92)},\n            {'pre': (112, 100), 'post': (112, 111)},\n        ],\n        # Case 2\n        [\n            {'pre': (100, 105), 'post': (100, 105)},\n            {'pre': (95, 100), 'post': (95, 100)},\n            {'pre': (120, 115), 'post': (120, 115)},\n            {'pre': (80, 85), 'post': (80, 85)},\n        ],\n        # Case 3\n        [\n            {'pre': (90, 98), 'post': (90, 95)},\n            {'pre': (110, 117), 'post': (110, 117)},\n            {'pre': (70, 76), 'post': (70, 74)},\n        ],\n        # Case 4\n        [\n            {'pre': (100, 102), 'post': (100, 104)},\n            {'pre': (95, 96), 'post': (95, 98)},\n            {'pre': (120, 123), 'post': (120, 126)},\n            {'pre': (80, 82), 'post': (80, 82)},\n            {'pre': (60, 61), 'post': (60, 65)},\n        ]\n    ]\n\n    results = []\n    alpha = 0.05\n    rounding_digits = 6\n\n    for case_data in test_cases:\n        # Calculate paired differences d_i for each subject\n        differences = []\n        for subject_data in case_data:\n            e_pre = abs(subject_data['pre'][0] - subject_data['pre'][1])\n            e_post = abs(subject_data['post'][0] - subject_data['post'][1])\n            d_i = e_pre - e_post\n            differences.append(d_i)\n\n        d = np.array(differences)\n        n = len(d)\n\n        # Handle special conditions as per problem statement\n        if n  2:\n            p_value = 1.0\n            decision = 0\n            results.append([round(p_value, rounding_digits), decision])\n            continue\n        \n        s_d = np.std(d, ddof=1) # Sample standard deviation\n\n        if s_d == 0:\n            p_value = 1.0\n            decision = 0\n            results.append([round(p_value, rounding_digits), decision])\n            continue\n\n        # Perform the paired t-test\n        d_bar = np.mean(d)\n        t_statistic = d_bar / (s_d / np.sqrt(n))\n        df = n - 1\n\n        # Calculate one-sided (right-tailed) p-value\n        # p = P(T > t_statistic)\n        p_value = t.sf(t_statistic, df)\n        \n        p_value_rounded = round(p_value, rounding_digits)\n\n        # Make decision based on significance level alpha\n        decision = 1 if p_value_rounded = alpha else 0\n        \n        results.append([p_value_rounded, decision])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "4531093"}]}