## 引言
在放射组学的世界里，我们的目标是从[医学影像](@entry_id:269649)中提取可量化的特征，以揭示肿瘤的生物学特性，并用于疾病诊断、预后预测和治疗反应评估。然而，一个巨大的挑战在于，原始的医学图像强度值往往受到成像设备、采集协议和患者特定因素的严重影响，导致不同图像之间的数据不具有直接可比性。这种与生物学无关的变异掩盖了真实的病理生理信号，严重威胁着放射组学模型的[可重复性](@entry_id:194541)和泛化能力。

为了解决这一根本性问题，必须在[特征提取](@entry_id:164394)之前对图像进行严格的预处理。本文聚焦于其中两个最核心的步骤：**强度归一化**与**强度离散化**。通过本文的学习，您将深刻理解为何这些步骤是构建可靠放射组学模型的基石。第一章“原理与机制”将深入剖析不同成像模态（如CT和MRI）强度值的物理意义差异，阐明归一化的必要性，并详细介绍Z-score标准化、稳健缩放等关键技术，以及固定箱数与固定箱宽等离散化策略。第二章“应用与跨学科交叉”将通过在CT、PET、MRI中的具体案例，展示这些原理如何在真实世界的研究中发挥作用，并探讨其与图像配准、[深度学习](@entry_id:142022)等领域的交叉联系。最后，在“动手实践”部分，您将有机会通过解决具体问题，亲手实现归一化与离散化的核心算法，将理论知识转化为实践技能。

## 原理与机制

在放射组学中，从[医学影像](@entry_id:269649)中提取的量化特征旨在捕捉反映潜在生物学特性的模式。然而，原始的图像强度值本身很少被直接使用。这是因为成像过程会引入各种与生物学无关的变异，这些变异可能掩盖我们试图测量的真实信号。为了确保放射组学特征的**[可重复性](@entry_id:194541) (reproducibility)** 和 **可比性 (comparability)**，必须在特征提取之前应用一系列标准化的预处理步骤。本章将深入探讨两个核心预处理步骤的原理与机制：**强度归一化 (intensity normalization)** 和 **强度离散化 (intensity discretization)**。我们将阐明为何这些步骤是必要的，介绍关键技术及其特性，并最终将它们整合到一个规范的预处理流程中。

### 强度可比性的挑战：从物理单位到任意单位

理解强度标准化的必要性的第一步，是认识不同成像模态下强度值的物理意义差异。

#### [计算机断层扫描 (CT)](@entry_id:747639) 与亨氏单位 (Hounsfield Units)

在[计算机断层扫描 (CT)](@entry_id:747639) 中，图像重建的是人体组织对X射线的**[线性衰减](@entry_id:198935)系数 ($\mu$)** 的空间分布图。这是一个内在的物理特性。为了在不同扫描仪之间实现标准化，这些系数值通过一个[线性变换](@entry_id:143080)被映射到亨氏单位 (Hounsfield Unit, HU) 量表上。该量表根据两种参考物质——水和空气——进行校准：
$$
\text{HU} = 1000 \times \frac{\mu_{\text{组织}} - \mu_{\text{水}}}{\mu_{\text{水}} - \mu_{\text{空气}}}
$$
根据定义，**水**的亨氏单位为 $0$ HU，**空气**为 $-1000$ HU。由于 HU 值与一个基本的物理相互作用（光子衰减）直接锚定，它提供了一个在理想情况下跨扫描仪、跨时间、跨中心的标准化、定量的绝对尺度 [@problem_id:4545744]。例如，一个 $50$ HU 的值理应代表具有相同衰减特性的组织，无论扫描在何处进行。这种内在的一致性为后续处理（如离散化）提供了一个坚实的物理基础。然而，在实践中，CT扫描仪的校准仍可能存在微小的偏移和增益变化，因此即使是CT数据，在进行精细的[纹理分析](@entry_id:202600)前，通常也需要进行窗口化（即选择一个感兴趣的HU范围）和标准化。

#### [磁共振成像 (MRI)](@entry_id:139464) 与任意强度单位

与CT形成鲜明对比的是，[磁共振成像 (MRI)](@entry_id:139464) 的像素强度值**不具有**标准化的物理单位。MRI信号的产生源于原子核（主要是氢质子）在强磁场中复杂的磁化动力学过程。其信号强度不仅依赖于组织的内在生物物理特性（如质子密度 $\rho$、纵向弛豫时间 $T_1$、横向[弛豫时间](@entry_id:191572) $T_2$），还强烈地依赖于大量由操作者设定和硬件决定的外部采集参数（如重复时间 $TR$、回波时间 $TE$、翻转角 $\alpha$、接收器增益等）。

为了形式化地理解这个问题，我们可以构建一个简化模型。在一次特定的MRI扫描 $i$ 中，观测到的体素强度 $I_i(\mathbf{x})$ 可以近似地表示为 [@problem_id:4545783]：
$$
I_i(\mathbf{x}) \approx s_i(\mathbf{x})\big(a_i\,T(\mathbf{x}) + b_i\big) + \epsilon_i(\mathbf{x})
$$
其中：
- $T(\mathbf{x})$ 是由成像序列物理决定的潜在组织对比度变量，它反映了我们关心的生物学信息。
- $a_i$ 是一个扫描特异性的**增益 (gain)** 因子（$a_i > 0$）。
- $b_i$ 是一个扫描特异性的**偏移 (offset)**。
- $s_i(\mathbf{x})$ 是一个空间上缓慢变化的**偏置场 (bias field)**，由接收线圈的灵敏度不均匀造成。
- $\epsilon_i(\mathbf{x})$ 是[加性噪声](@entry_id:194447)。

这个模型清楚地揭示了，即使是相同的组织（即相同的 $T(\mathbf{x})$），在两次不同的扫描（例如，扫描 $i$ 和 $j$）中，由于未知的、变化的增益 $a_i, a_j$ 和偏移 $b_i, b_j$，其观测到的绝对强度值 $I_i$ 和 $I_j$ 也完全没有可比性。从本质上讲，每次MRI扫描都对潜在的物理真实信号施加了一个未知的**仿射变换 (affine transformation)** ($aT+b$) 和一个乘性的空间畸变。因此，为了比较不同被试、不同扫描仪甚至同一被试在不同时间点采集的MRI数据，强度归一化不是一个可选项，而是一个**必需**的步骤 [@problem_id:4545744]。

### 强度归一化的核心原理

**强度归一化**旨在通过一个数学变换，将不同图像的强度值映射到一个共同的、标准化的尺度上，从而消除与采集过程相关的变异。一个有效的归一化方法 $g$ 必须满足几个基本原则 [@problem_id:4545783]。

#### [仿射不变性](@entry_id:275782)

归一化的首要目标是消除扫描特异性增益 $a_i$ 和偏移 $b_i$ 的影响。一个理想的归一化过程，记作 $\mathcal{N}$，应用于经过偏置场校正的图像 $I' = aI+b$ 时，其结果应当与 $a$ 和 $b$ 无关。这种性质被称为**[仿射不变性](@entry_id:275782) (affine invariance)**。实现这一目标通常需要利用图像**内部**的统计量来“锚定”强度尺度。

例如，一个常见的归一化方法是**Z-score标准化 (z-score standardization)**，它将强度值转换为均值为0、标准差为1的分布。如果对图像 $I'$ 计算其均值 $\mu_{I'}$ 和标准差 $\sigma_{I'}$，然后应用变换：
$$
\mathcal{N}(I') = \frac{I' - \mu_{I'}}{\sigma_{I'}}
$$
由于 $\mu_{I'} = a\mu_I + b$ 且 $\sigma_{I'} = a\sigma_I$ (对于 $a>0$)，我们得到：
$$
\frac{(aI+b) - (a\mu_I+b)}{a\sigma_I} = \frac{a(I-\mu_I)}{a\sigma_I} = \frac{I-\mu_I}{\sigma_I}
$$
变换的结果与 $a$ 和 $b$ 无关，从而实现了[仿射不变性](@entry_id:275782)。

#### [单调性](@entry_id:143760)

放射组学特征，特别是纹理特征，依赖于像素强度值的相对排序。如果体素A的强度高于体素B，这通常意味着两者在潜在的组织属性上存在差异。归一化变换**必须**保持这种顺[序关系](@entry_id:138937)，即如果 $I_1 > I_2$，那么变换后的强度 $g(I_1)$ 也必须大于 $g(I_2)$。这种保序性质被称为**严格单调性 (strict monotonicity)**。任何非单调的变换都会打乱像素强度的物理意义，从而破坏图像的内在纹理结构。

#### 与相关概念的区分

理解强度归一化是什么，同样重要的是理解它不是什么 [@problem_id:4545781]。
- **[直方图](@entry_id:178776)均衡化 (Histogram Equalization)**：这是一种旨在增强图像视觉对比度的技术，它通过非线性地重塑[强度分布](@entry_id:163068)，使其趋向于均匀分布。虽然其变换函数是单调的，但它会彻底改变原始的强度[直方图](@entry_id:178776)形状，破坏强度值与组织物理特性之间的定量关系。因此，[直方图](@entry_id:178776)均衡化**通常不适用于**定量的放射组学分析。
- **特征层面的协调 (Feature-level Harmonization)**：这是一种在**[特征提取](@entry_id:164394)之后**应用的统计方法。当数据来自多个中心或设备（即存在“[批次效应](@entry_id:265859)”）时，即使经过了图像预处理，提取出的特征分布仍可能存在系统性差异。协调方法（如ComBat）直接作用于特征矩阵，调整特征的分布以消除技术性变异，同时保留生物学差异。这是一个特征后处理步骤，与图像预处理阶段的强度归一化根本不同。

### 常用的归一化技术及其属性

基于上述原则，研究者们发展了多种归一化技术，每种技术都有其特定的适用场景和稳健性特征。

#### Z-Score 标准化

如前所述，Z-score标准化的公式为 $I' = (I - \mu) / \sigma$，其中 $\mu$ 是均值，$\sigma$ 是标准差。关键在于，这些统计量是在哪个范围内计算的 [@problem_id:4545773]。
- **全图归一化 (Per-image normalization)**：使用单张完整图像的所有体素来计算 $\mu$ 和 $\sigma$。这种方法对图像整体的[仿射变换](@entry_id:144885)具有不变性，并且其结果不受后续感兴趣区域 (ROI) 勾画变化的影响。
- **ROI内归一化 (Per-ROI normalization)**：仅使用特定ROI内的体素来计算 $\mu$ 和 $\sigma$。这种方法同样具有[仿射不变性](@entry_id:275782)，但其归一化结果对ROI的勾画非常敏感。ROI的微小变动（如扩张或侵蚀）都可能改变 $\mu$ 和 $\sigma$，从而改变ROI内所有体素的归一化值。
- **数据集归一化 (Per-dataset normalization)**：从一个大型参考数据集中计算出一个固定的 $\mu_{\text{ds}}$ 和 $\sigma_{\text{ds}}$，然后将它们应用于所有新的图像。这种方法旨在将所有图像置于一个统一的绝对尺度上，但它**不具备**对单张图像特异的增益和偏移的不变性。如果某张图像存在异常的亮暗，这种方法无法纠正。

#### 范围重缩放 (Min-Max Normalization)

这是一种简单的线性重缩放方法，将强度值映射到指定的区间，通常是 $[0, 1]$。其基本形式为 [@problem_id:4545792]：
$$
I' = \frac{I - I_{\min}}{I_{\max} - I_{\min}}
$$
其中 $I_{\min}$ 和 $I_{\max}$ 分别是ROI内的最小和最大强度值。这个变换是仿射的且保序，并且其数学形式唯一确定。然而，它的主要缺点是对**异常值 (outliers)** 极其敏感。单个极端亮或暗的体素（例如，CT图像中的金属伪影）就能极大地改变 $I_{\min}$ 或 $I_{\max}$，从而扭曲整个强度尺度的缩放，压缩大部分正常组织的强度动态范围。

#### 稳健的归一化方法

为了克服传统方法对异常值的敏感性，**[稳健统计学](@entry_id:270055) (robust statistics)** 提供了更好的替代方案。

- **基于百分位数的重缩放**：这是对范围重缩放的直接改进。我们不用不稳定的 $I_{\min}$ 和 $I_{\max}$，而是用更稳健的**百[分位数](@entry_id:178417) (percentiles)**，例如用第1个百分位数 $p_{0.01}$ 和第99个百分位数 $p_{0.99}$ 来代替。变换公式变为 [@problem_id:4545792]：
  $$
  I' = \frac{I - p_{\alpha}}{p_{1-\alpha} - p_{\alpha}}
  $$
  对于落在 $[p_{\alpha}, p_{1-\alpha}]$ 区间内的强度值，进行[线性缩放](@entry_id:197235)。对于低于 $p_{\alpha}$ 的值，裁剪至 $0$；高于 $p_{1-\alpha}$ 的值，裁剪至 $1$。由于百[分位数](@entry_id:178417)的值由其排序位置决定，而不受其排序之外的极端值大小的影响，这种方法对异常值具有很强的稳健性。

- **稳健缩放 (Robust Scaling)**：这种方法使用稳健的统计量来代替均值和标准差。一个常见的选择是使用**[中位数](@entry_id:264877) (median)** 作为中心位置的估计，使用**[四分位距](@entry_id:169909) (interquartile range, IQR)** 作为尺度的估计。IQR定义为第三[四分位数](@entry_id:167370) ($Q_3$) 与第一[四分位数](@entry_id:167370) ($Q_1$)之差。变换公式为 [@problem_id:4545780]：
  $$
  I' = \frac{I - \text{median}(I)}{\text{IQR}(I)}
  $$
  这种方法的稳健性可以用**[崩溃点](@entry_id:165994) (breakdown point)** 和**影响函数 (influence function)** 来量化。[崩溃点](@entry_id:165994)是指能够将估计值推向任意大或小所需的数据污染比例的最小值。均值和标准差的[崩溃点](@entry_id:165994)都是 $0$（一个异常值即可使其崩溃），而中位数的[崩溃点](@entry_id:165994)是 $0.5$（最高可[能值](@entry_id:187992)），IQR的[崩溃点](@entry_id:165994)是 $0.25$。影响函数衡量单个数据点对估计值的无限小影响。均值和标准差的[影响函数](@entry_id:168646)是无界的（异常值影响巨大），而[中位数](@entry_id:264877)和IQR的[影响函数](@entry_id:168646)是有界的。因此，基于中位数和IQR的稳健缩放能有效抵抗异常值对强度尺度造成的扭曲。

### 强度离散化：通往[纹理分析](@entry_id:202600)的桥梁

在强度被归一化之后，下一个关键步骤是**强度离散化 (intensity discretization)** 或**量化 (quantization)**。许多重要的放射组学特征，特别是**纹理特征 (texture features)**，并非直接从连续的强度值计算，而是从一个离散的“灰度等级”集合中计算。例如，**灰度[共生](@entry_id:142479)矩阵 (Gray-Level Co-occurrence Matrix, GLCM)** 和**灰度游程矩阵 (Gray-Level Run-Length Matrix, GLRLM)** 等都依赖于一个预先定义好的、有限数量的灰度等级 [@problem_id:4545786]。

离散化过程通过一个映射函数 $Q$，将连续的（或多位深的）强度值 $I(\mathbf{r})$ 映射到一个整数标签 $g(\mathbf{r}) \in \{1, 2, \ldots, N\}$，其中 $N$ 是预设的灰度等级数量。这个过程本质上是将强度轴划分为 $N$ 个“箱子”(bins)。

#### 离散化策略及其权衡

主要有两种离散化策略，它们在如何定义这些“箱子”上有所不同，并带来了重要的权衡 [@problem_id:4545758] [@problem_id:4545744]。

- **固定箱数 (Fixed Bin Number, FBN)**：此策略将每个ROI内的强度范围 $[I_{\min}, I_{\max}]$ 均匀地划分为一个固定的箱数 $B$（例如，$B=32$ 或 $64$）。每个箱子的宽度因此变为 $w = (I_{\max} - I_{\min}) / B$。
  - **优点**：保证了所有图像的灰度等级数量都是 $B$。这意味着后续计算出的GLCM等矩阵的维度（例如，$B \times B$）在所有图像中都是一致的，这简化了特征的比较 [@problem_id:4545799]。
  - **缺点**：与范围重缩放一样，此方法对异常值非常敏感。考虑一个例子：一张CT图像的ROI强度范围是 $[-100, 300]$ HU，另一张图像因为一个金属伪影，范围变成了 $[-100, 2000]$ HU。如果使用FBN（例如$B=64$），第二张图的箱宽会变得非常大。结果是，绝大多数代表真实组织的强度值（仍在 $[-100, 300]$ HU 范围内）会被“压缩”到极少数几个箱子中，而大部[分箱](@entry_id:264748)子则因为对应着高强度伪影区域而空置。这种压缩会严重损失纹理细节，导致计算出的特征失去信息量 [@problem_id:4545758]。

- **固定箱宽 (Fixed Bin Width, FBW)**：此策略为所有图像使用一个固定的箱宽 $\Delta$。箱子的数量则根据每张图像的强度范围而变化，$B = \lceil (I_{\max} - I_{\min}) / \Delta \rceil$。
  - **优点**：提供了**一致的量化分辨率**。一个固定的箱宽意味着一个灰度等级在所有图像中代表着大致相同的物理强度范围。这对于具有物理单位的CT图像尤其有意义，我们可以设定一个有物理意义的箱宽，如 $\Delta = 25$ HU。这保证了体素被分到哪个箱子是由其物理特性决定的，而不是由图像中的其他像素（特别是异常值）决定的 [@problem_id:4545758]。
  - **缺点**：不同图像的强度范围不同，会导致箱数 $B$ 不同，从而导致GLCM等矩阵的维度也不同。这给跨图像的[特征比](@entry_id:190624)较带来了挑战，因为特征向量的长度可能不一致。

#### 离散化与[可重复性](@entry_id:194541)

无论选择哪种策略，为了保证放射组学研究的[可重复性](@entry_id:194541)，离散化方案本身必须在整个研究队列中**保持一致**。这意味着，必须在经过恰当归一化的强度尺度上，使用相同的箱宽定义（或箱数定义）[@problem_id:4545786]。如果对未经归一化的原始强度应用离散化，那么由于不同图像间存在的[仿射变换](@entry_id:144885)，相同的原始强度值在不同图像中可能代表完全不同的组织，它们将被错误地映射到同一个灰度等级，导致计算出的特征不可靠且无法比较。

### 一个规范的预处理流程

将以上所有原理和机制整合起来，我们可以构建一个逻辑上合理的、旨在最大限度减少失真传播并保证特征可比性的典型预处理流程。对于像MRI这样存在多种显著伪影的模态，操作的**顺序**至关重要，因为这些操作通常是**不可交换的 (non-commutative)** [@problem_id:4545730]。

一个经过充分论证的规范流程如下：

1.  **偏置场校正 ($\mathcal{B}^{-1}$)**：偏置场是一个低频、高幅度的[乘性](@entry_id:187940)伪影，它会扭曲所有后续依赖于强度的计算。因此，在任何其他操作之前，必须首先估计并校正偏置场。

2.  **[去噪](@entry_id:165626) ($\mathcal{F}$)**：在校正了主要的[乘性](@entry_id:187940)伪影后，下一步是处理[加性噪声](@entry_id:194447)。在进行[重采样](@entry_id:142583)或归一化等会受到噪声影响的操作之前进行去噪，可以避免噪声的传播和放大。例如，如果在含噪图像上进行[重采样](@entry_id:142583)，插值过程会使噪声相关联，增加后续去噪的难度。

3.  **[重采样](@entry_id:142583) ($\mathcal{R}_h$)**：在尽可能清除了强度伪影之后，进行几何校正。将图像[重采样](@entry_id:142583)到各项同性的体素网格，可以确保后续计算的特征（特别是纹理和形状特征）不受切片方向和厚度的影响。

4.  **强度归一化 ($\mathcal{N}$)**：在图像的几何结构和强度伪影都得到处理后，进行强度归一化。此时，用于计算归一化参数（如均值/标准差或百[分位数](@entry_id:178417)）的体素集已经处于最终的几何形态，确保了归一化的稳定性和一致性。

5.  **强度离散化 ($\mathcal{Q}_\Delta$)**：作为特征提取的最后准备步骤，将归一化后的连续强度值量化为离散的灰度等级。此步骤必须在所有其他强度和几何变换之后进行，因为它是一个终末的、信息有损的映射，专为后续的特征计算矩阵（如GLCM）服务。

综上所述，一个稳健的放射组学预处理流程遵循**由粗到精、先强度后几何、先校正后标准化**的逻辑顺序：**偏置场校正 $\rightarrow$ [去噪](@entry_id:165626) $\rightarrow$ 重采样 $\rightarrow$ 强度归一化 $\rightarrow$ 强度离散化**。遵循这样的流程是确保从[原始图](@entry_id:262918)像数据中提取出可靠、可重复且具有生物学意义的放射组学特征的基石。