{"hands_on_practices": [{"introduction": "高斯滤波器是放射组学中图像平滑的基石，因其在降低噪声的同时能保留重要结构而备受青睐。然而，其威力在于正确的校准。本练习将指导您完成一个关键过程：将以物理单位（通过半高全宽 FWHM 指定）表示的期望平滑程度，转换为以体素为单位的滤波器标准差参数（$\\sigma$），并考虑各向异性的图像分辨率。掌握这种转换是确保滤波结果可复现且有意义的一项基本技能。[@problem_id:4553384]", "problem": "在放射组学流程中，一幅三维计算机断层扫描（CT）图像将通过一个可分离高斯滤波器进行平滑处理，以减少高频噪声，同时保留病灶的形状特征。该滤波器沿每个笛卡尔坐标轴作用，具有相同的物理模糊效果，其每个轴上的一维平滑轮廓由高斯函数 $g(x) = A \\exp\\!\\left(-\\frac{x^{2}}{2\\sigma^{2}}\\right)$ 建模，其中 $A$ 是 $x=0$ 处的峰值振幅，$\\sigma$ 是标准差。所需的模糊程度在物理空间中由半峰全宽（FWHM）指定，其定义为 $g(x)$ 等于其最大值一半的两个点之间的宽度。\n\n从高斯函数的定义和半峰全宽（FWHM）的定义出发，推导 FWHM 与 $\\sigma$ 之间的解析关系，过程中不使用任何预先给定的简化公式。然后，对于在物理空间中各向同性应用的 $W = 6\\,\\mathrm{mm}$ 的目标 FWHM，计算以毫米为单位的标准差，并将其转换为体素大小为 $s_{x} = 0.8\\,\\mathrm{mm}$、$s_{y} = 0.8\\,\\mathrm{mm}$ 和 $s_{z} = 1.5\\,\\mathrm{mm}$ 的 CT 图像上每个轴以体素为单位的标准差。将最终答案表示为一个包含 $(\\sigma_{x}, \\sigma_{y}, \\sigma_{z})$（以体素为单位）的行矩阵，其中 $\\sigma_{i} = \\sigma_{\\mathrm{mm}}/s_{i}$，$i \\in \\{x,y,z\\}$。将每个分量四舍五入到四位有效数字。最终答案必须以体素为单位给出。", "solution": "在尝试求解之前，对问题陈述的有效性进行评估。\n\n### 第1步：提取已知条件\n- 高斯函数：$g(x) = A \\exp(-\\frac{x^{2}}{2\\sigma^{2}})$\n- $A$：$x=0$ 处的峰值振幅。\n- $\\sigma$：标准差。\n- FWHM（半峰全宽）定义：函数 $g(x)$ 值等于其最大值一半的两个点之间的宽度。\n- 目标 FWHM：$W = 6\\,\\mathrm{mm}$。\n- 平滑在物理空间中是各向同性应用的。\n- 体素大小：$s_{x} = 0.8\\,\\mathrm{mm}$，$s_{y} = 0.8\\,\\mathrm{mm}$，以及 $s_{z} = 1.5\\,\\mathrm{mm}$。\n- 体素单位标准差的转换公式：$\\sigma_{i} = \\sigma_{\\mathrm{mm}}/s_{i}$，其中 $i \\in \\{x,y,z\\}$。\n- 要求输出：一个行矩阵 $(\\sigma_{x}, \\sigma_{y}, \\sigma_{z})$，以体素为单位，每个分量四舍五入到四位有效数字。\n\n### 第2步：使用提取的已知条件进行验证\n该问题具有科学依据，因为它涉及高斯函数和FWHM在图像处理背景下的标准定义和应用，特别是在放射组学领域。所提供的值对于临床CT成像而言是符合实际的。该问题是适定的，提供了得出唯一解所需的所有必要信息和定义。它内容客观，并使用了精确、无歧义的语言。该问题未违反任何无效性标准。\n\n### 第3步：结论与行动\n该问题被视为有效。将提供一个完整的、带推理过程的解答。\n\n### 解题推导\n\n解题过程分为三部分：首先，推导半峰全宽（$W$，在问题中记为FWHM）与标准差（$\\sigma$）之间的解析关系；其次，计算给定$W$下以物理单位（毫米）表示的标准差；最后，将此物理标准差转换为各轴上以体素为单位的标准差。\n\n**第1部分：推导 FWHM 与 $\\sigma$ 之间的关系**\n\n一维高斯函数由下式给出：\n$$g(x) = A \\exp\\left(-\\frac{x^{2}}{2\\sigma^{2}}\\right)$$\n函数最大值 $g_{\\mathrm{max}}$ 出现在高斯函数的峰值处，即 $x=0$ 处。将 $x=0$ 代入方程可得：\n$$g_{\\mathrm{max}} = g(0) = A \\exp\\left(-\\frac{0^{2}}{2\\sigma^{2}}\\right) = A \\exp(0) = A$$\nFWHM 定义为函数值等于其最大值一半的两个点 $x$ 之间的宽度。我们设 $g(x) = \\frac{1}{2} g_{\\mathrm{max}}$：\n$$g(x) = \\frac{A}{2}$$\n代入 $g(x)$ 的表达式，我们得到：\n$$A \\exp\\left(-\\frac{x^{2}}{2\\sigma^{2}}\\right) = \\frac{A}{2}$$\n假设 $A \\neq 0$，我们可以将两边同除以 $A$：\n$$\\exp\\left(-\\frac{x^{2}}{2\\sigma^{2}}\\right) = \\frac{1}{2}$$\n为了解出 $x$，我们对两边取自然对数 ($\\ln$)：\n$$\\ln\\left[\\exp\\left(-\\frac{x^{2}}{2\\sigma^{2}}\\right)\\right] = \\ln\\left(\\frac{1}{2}\\right)$$\n$$-\\frac{x^{2}}{2\\sigma^{2}} = -\\ln(2)$$\n两边同乘以 $-1$ 得：\n$$\\frac{x^{2}}{2\\sigma^{2}} = \\ln(2)$$\n现在，我们解出 $x^2$：\n$$x^{2} = 2\\sigma^{2}\\ln(2)$$\n最后解出 $x$：\n$$x = \\pm \\sqrt{2\\sigma^{2}\\ln(2)} = \\pm \\sigma\\sqrt{2\\ln(2)}$$\n设这两个点为 $x_1 = -\\sigma\\sqrt{2\\ln(2)}$ 和 $x_2 = +\\sigma\\sqrt{2\\ln(2)}$。FWHM，记为 $W$，是这两点之间的距离：\n$$W = x_2 - x_1 = \\left(\\sigma\\sqrt{2\\ln(2)}\\right) - \\left(-\\sigma\\sqrt{2\\ln(2)}\\right)$$\n$$W = 2\\sigma\\sqrt{2\\ln(2)}$$\n这就是 FWHM ($W$) 与标准差 ($\\sigma$) 之间的解析关系。\n\n**第2部分：计算以物理单位（mm）表示的 $\\sigma$**\n\n给定目标 FWHM 为 $W = 6\\,\\mathrm{mm}$。我们可以重新整理推导出的关系式来求解 $\\sigma$：\n$$\\sigma = \\frac{W}{2\\sqrt{2\\ln(2)}}$$\n由于模糊在物理空间中是各向同性的，这个标准差（我们称之为 $\\sigma_{\\mathrm{mm}}$）在所有轴上都是相同的。代入 $W = 6\\,\\mathrm{mm}$：\n$$\\sigma_{\\mathrm{mm}} = \\frac{6}{2\\sqrt{2\\ln(2)}} = \\frac{3}{\\sqrt{2\\ln(2)}}\\,\\mathrm{mm}$$\n为了进行数值计算，我们使用 $\\ln(2) \\approx 0.69314718$ 的值：\n$$\\sigma_{\\mathrm{mm}} = \\frac{3}{\\sqrt{2 \\times 0.69314718}} \\approx \\frac{3}{\\sqrt{1.38629436}} \\approx \\frac{3}{1.17741002}\\,\\mathrm{mm}$$\n$$\\sigma_{\\mathrm{mm}} \\approx 2.5481755\\,\\mathrm{mm}$$\n\n**第3部分：将 $\\sigma_{\\mathrm{mm}}$ 转换为体素单位**\n\n问题要求将标准差表示为每个轴上的体素单位，使用公式 $\\sigma_{i} = \\sigma_{\\mathrm{mm}}/s_{i}$，其中 $s_i$ 是沿 $i$ 轴的体素大小。\n给定的体素大小为 $s_{x} = 0.8\\,\\mathrm{mm}$，$s_{y} = 0.8\\,\\mathrm{mm}$，以及 $s_{z} = 1.5\\,\\mathrm{mm}$。\n\n对于 x 轴：\n$$\\sigma_{x} = \\frac{\\sigma_{\\mathrm{mm}}}{s_{x}} = \\frac{2.5481755\\,\\mathrm{mm}}{0.8\\,\\mathrm{mm}} \\approx 3.185219\\,\\text{voxels}$$\n四舍五入到四位有效数字，$\\sigma_{x} \\approx 3.185$。\n\n对于 y 轴：\n$$\\sigma_{y} = \\frac{\\sigma_{\\mathrm{mm}}}{s_{y}} = \\frac{2.5481755\\,\\mathrm{mm}}{0.8\\,\\mathrm{mm}} \\approx 3.185219\\,\\text{voxels}$$\n四舍五入到四位有效数字，$\\sigma_{y} \\approx 3.185$。\n\n对于 z 轴：\n$$\\sigma_{z} = \\frac{\\sigma_{\\mathrm{mm}}}{s_{z}} = \\frac{2.5481755\\,\\mathrm{mm}}{1.5\\,\\mathrm{mm}} \\approx 1.698784\\,\\text{voxels}$$\n四舍五入到四位有效数字，$\\sigma_{z} \\approx 1.699$。\n\n最终答案是包含计算值的行矩阵 $(\\sigma_x, \\sigma_y, \\sigma_z)$。", "answer": "$$\\boxed{\\begin{pmatrix} 3.185  3.185  1.699 \\end{pmatrix}}$$", "id": "4553384"}, {"introduction": "滤波虽然至关重要，但将其应用于大型三维医学图像可能非常耗时。本练习将探讨一种关键的计算捷径：核的可分离性。您将推导并量化在三维卷积中使用可分离实现所带来的巨大性能提升，而高斯滤波器恰好具备此特性。这个练习突显了算法效率不仅是一个理论问题，更是在处理大规模放射组学数据时的实际需求。[@problem_id:4553315]", "problem": "在放射组学中，一个三维图像（例如计算机断层扫描（CT）容积）可以通过与一个有限支撑核进行离散卷积来去噪。设 $f[x,y,z]$ 为规则网格上的一个三维图像，设 $h[i,j,k]$ 为一个实值核，其在每个轴上的支撑域为长度是奇数 $K$ 的立方体。考虑通过直接三维离散卷积计算每个输出体素的操作计数，假设采用一种直接的实现方式，即对于每个核抽头，执行一次乘法和一次加法，并将每次乘法和每次加法计为一次浮点运算（FLOP），因此每个抽头总共有 $2$ 次浮点运算。接下来，假设该核是可分离的，即 $h[i,j,k] = h_{x}[i]\\,h_{y}[j]\\,h_{z}[k]$，因此三维卷积可以通过沿 $x$、$y$ 和 $z$ 轴的三个连续的一维卷积来实现，每个一维卷积的长度均为相同的奇数 $K$。\n  \n从离散卷积和可分离性的定义出发，推导直接三维卷积和三遍可分离实现的每体素浮点运算数，并说明相应的关于 $K$ 的大O复杂度。然后，对于一个大小为 $512 \\times 512 \\times 128$ 体素的典型CT容积和一个长度为奇数 $K=7$ 的核，假设处理器上的持续处理速率为 $150 \\times 10^{9}$ FLOP/s。在这些假设下并忽略边界效应，计算当对整个容积使用可分离实现而不是直接三维卷积时，所节省的总时间（以秒为单位）。将最终答案四舍五入到四位有效数字，并以秒表示时间。", "solution": "图像 $f[x,y,z]$ 与核 $h[i,j,k]$ 在体素位置 $(x,y,z)$ 的离散三维卷积定义为\n$$\n(f * h)[x,y,z] \\;=\\; \\sum_{i=-a}^{a} \\sum_{j=-a}^{a} \\sum_{k=-a}^{a} h[i,j,k]\\, f[x-i, y-j, z-k],\n$$\n其中 $K=2a+1$ 是沿每个轴的奇数核长度，核支撑域在每个维度上有 $K$ 个样本。对于每个输出体素，直接三维卷积为核支撑域中的每个三元组 $(i,j,k)$ 计算一个乘积 $h[i,j,k]\\,f[\\cdot]$，然后将其加到累加和中。因此，每体素的乘加对数量为 $K^{3}$，如果我们将每次乘法和每次加法计为一次浮点运算（FLOP），则得到\n$$\n\\text{FLOPs per voxel (direct 3D)} \\;=\\; 2\\,K^{3}.\n$$\n由于操作数与 $K$ 的立方成比例，因此每体素的计算复杂度为 $\\mathcal{O}(K^{3})$。\n\n如果核是可分离的，即 $h[i,j,k] = h_{x}[i]\\,h_{y}[j]\\,h_{z}[k]$，则三维卷积可以计算为三个连续的一维卷积：\n$$\ng_{x}[x,y,z] \\;=\\; \\sum_{i=-a}^{a} h_{x}[i]\\, f[x-i, y, z], \\quad\ng_{y}[x,y,z] \\;=\\; \\sum_{j=-a}^{a} h_{y}[j]\\, g_{x}[x, y-j, z], \\quad\n(f*h)[x,y,z] \\;=\\; \\sum_{k=-a}^{a} h_{z}[k]\\, g_{y}[x, y, z-k].\n$$\n每个一维卷积有 $K$ 个抽头，因此每体素执行 $K$ 个乘加对。共有三遍，每轴一遍，这导致每体素有 $3K$ 个乘加对，因此\n$$\n\\text{FLOPs per voxel (separable 3-pass)} \\;=\\; 2 \\times (3K) \\;=\\; 6K.\n$$\n这与 $K$ 呈线性关系，因此每遍的每体素计算复杂度为 $\\mathcal{O}(K)$，总复杂度为 $\\mathcal{O}(3K)$，即 $\\mathcal{O}(K)$。\n\n为量化运行时间的影响，设容积大小为 $N_{x} \\times N_{y} \\times N_{z} = 512 \\times 512 \\times 128$，则体素数量为\n$$\nN \\;=\\; N_{x} N_{y} N_{z} \\;=\\; 512 \\times 512 \\times 128 \\;=\\; 33{,}554{,}432.\n$$\n当 $K=7$（因此 $a=3$）时，对整个容积进行直接三维卷积的总浮点运算数为\n$$\n\\text{FLOPs}_{\\text{direct}} \\;=\\; N \\times 2 K^{3} \\;=\\; 33{,}554{,}432 \\times 2 \\times 7^{3}\n\\;=\\; 33{,}554{,}432 \\times 686 \\;=\\; 23{,}018{,}340{,}352.\n$$\n可分离实现的总浮点运算数为\n$$\n\\text{FLOPs}_{\\text{sep}} \\;=\\; N \\times 6K \\;=\\; 33{,}554{,}432 \\times 42 \\;=\\; 1{,}409{,}286{,}144.\n$$\n因此，通过使用可分离性节省的浮点运算数为\n$$\n\\Delta \\text{FLOPs} \\;=\\; \\text{FLOPs}_{\\text{direct}} - \\text{FLOPs}_{\\text{sep}} \\;=\\; 23{,}018{,}340{,}352 \\;-\\; 1{,}409{,}286{,}144 \\;=\\; 21{,}609{,}054{,}208.\n$$\n假设持续处理速率为 $R = 150 \\times 10^{9}$ FLOP/s，节省的时间为\n$$\n\\Delta t \\;=\\; \\frac{\\Delta \\text{FLOPs}}{R} \\;=\\; \\frac{21{,}609{,}054{,}208}{150 \\times 10^{9}} \\;\\text{s} \\;\\approx\\; 0.144060361386\\ldots \\;\\text{s}.\n$$\n四舍五入到四位有效数字，节省的时间是\n$$\n0.1441 \\;\\text{s}.\n$$\n这个结果说明了计算复杂度从关于 $K$ 的三次方降低到线性，并量化了对于一个典型三维体数据集的运行时间影响。", "answer": "$$\\boxed{0.1441}$$", "id": "4553315"}, {"introduction": "通用滤波器很有用，但我们是否可以设计一种完全根据图像特定信号和噪声特性量身定制的滤波器呢？本练习介绍了维纳滤波器，这是一个能够通过最小化均方误差来实现这一目标的优雅而强大的工具。您将首先从第一性原理推导该滤波器，然后用 Python 实现一个完整的去噪流程，从估计信号和噪声属性到应用滤波器并评估其性能。这个综合性练习提供了一种高级、基于模型的图像复原的动手实践体验。[@problem_id:4553371]", "problem": "给定一个二维计算机断层扫描（CT）切片在加性噪声下的线性成像模型。设真实图像为 $X[\\mathbf{r}]$，噪声为 $N[\\mathbf{r}]$，观测到的图像为 $Y[\\mathbf{r}] = X[\\mathbf{r}] + N[\\mathbf{r}]$，其中 $\\mathbf{r} = (u,v)$ 是有限网格上的像素坐标索引。假设 $X[\\mathbf{r}]$ 和 $N[\\mathbf{r}]$ 是零均值、二阶平稳的随机场，并且它们是不相关的。令 $\\mathcal{F}\\{\\cdot\\}$ 表示二维离散傅里叶变换（DFT），并定义二维角频率为 $\\boldsymbol{\\omega} = (\\omega_x,\\omega_y)$。一个场 $A[\\mathbf{r}]$ 的功率谱密度（PSD）$S_{AA}(\\boldsymbol{\\omega})$ 是其自相关函数的傅里叶变换。在独立性和平稳性假设下，观测PSD满足 $S_{YY}(\\boldsymbol{\\omega}) = S_{XX}(\\boldsymbol{\\omega}) + S_{NN}(\\boldsymbol{\\omega})$。目标是推导出一个线性移不变估计器 $\\widehat{X}[\\mathbf{r}]$，该估计器通过一个频率响应为 $H(\\boldsymbol{\\omega})$ 的滤波器对 $Y[\\mathbf{r}]$ 进行滤波得到，即 $\\mathcal{F}\\{\\widehat{X}\\}(\\boldsymbol{\\omega}) = H(\\boldsymbol{\\omega}) \\,\\mathcal{F}\\{Y\\}(\\boldsymbol{\\omega})$。您必须从第一性原理出发，推导出在所有线性移不变估计器中，使均方误差 $\\mathbb{E}\\{ \\lvert X[\\mathbf{r}] - \\widehat{X}[\\mathbf{r}] \\rvert^2 \\}$ 最小化的最优 $H(\\boldsymbol{\\omega})$。\n\n您将实现一个完整的数值流程来：\n- 构建一个大小为 $N \\times N$（其中 $N = 64$）的合成CT类体模图像 $X[\\mathbf{r}]$，该图像包含具有分段常数强度的简单几何结构。\n- 在三个测试案例（测试套件）下生成带噪观测 $Y[\\mathbf{r}]$，其中噪声实现 $N[\\mathbf{r}]$ 已知但未被观测。\n- 从一个假定只包含噪声的纯背景区域估计 $S_{NN}(\\boldsymbol{\\omega})$，并从整个观测图像估计 $S_{YY}(\\boldsymbol{\\omega})$。\n- 仅使用给定假设，从 $S_{YY}(\\boldsymbol{\\omega})$ 和 $S_{NN}(\\boldsymbol{\\omega})$ 推断 $S_{XX}(\\boldsymbol{\\omega})$。\n- 计算您推导出的最优 $H(\\boldsymbol{\\omega})$，在频域中应用它以获得 $\\widehat{X}[\\mathbf{r}]$，并量化性能。\n\n您可以使用的基本原理：\n- 离散傅里叶变换（DFT）和卷积的线性性质，以及线性移不变滤波对应于频域中的乘法。\n- 功率谱密度（PSD）对于宽义平稳过程的定义是自相关函数的傅里叶变换。\n- 对于不相关的信号和噪声，$S_{YY}(\\boldsymbol{\\omega}) = S_{XX}(\\boldsymbol{\\omega}) + S_{NN}(\\boldsymbol{\\omega})$。\n- 对于线性移不变估计器，可以按频率分析均方误差的最优性。\n\n需要实现的数值细节：\n- 图像大小为 $N \\times N$，其中 $N = 64$；为保证可复现性，使用固定的随机种子 $1337$。\n- 在零背景上按如下方式构建 $X[\\mathbf{r}]$：\n  - 一个以 $(32,32)$ 为中心、半径为 $12$、强度为 $1.00$ 的圆盘。\n  - 一个覆盖所有行以及第 $28$ 至 $31$ 列（含）的垂直条带，强度为 $0.70$。\n  - 一个从第 $12$ 行到第 $19$ 行（含）以及第 $44$ 列到 $51$ 列（含）的正方形，强度为 $1.50$。\n- 将左上角 $16 \\times 16$ 的区块定义为纯背景区域，即索引 $u \\in [0,15]$，$v \\in [0,15]$，根据构造，该区域在清晰体模中只包含背景。\n- 使用以下三个噪声条件的测试套件来创建 $Y[\\mathbf{r}] = X[\\mathbf{r}] + N[\\mathbf{r}]$：\n  1. 标准差为 $0.10$ 的白高斯噪声。\n  2. 有色高斯噪声，由标准差为 $0.20$ 的白高斯噪声与标准差为 $2.0$ 像素的高斯核卷积形成。\n  3. 标准差为 $0.02$ 的白高斯噪声。\n- 通过 $Y[\\mathbf{r}]$ 在整个图像上的周期图来估计 $S_{YY}(\\boldsymbol{\\omega})$：如果在 $N \\times N$ 网格上 $F_Y = \\mathcal{F}\\{Y\\}$，则使用 $\\widehat{S}_{YY}(\\boldsymbol{\\omega}) = \\lvert F_Y \\rvert^2 / (N^2)$。\n- 通过纯噪声区域的周期图来估计 $S_{NN}(\\boldsymbol{\\omega})$，在应用DFT之前将其零填充至 $N \\times N$ 大小。如果该区域大小为 $M \\times M$ 且 $M = 16$，并且 $F_P$ 是零填充区域的 $N \\times N$ DFT，则使用 $\\widehat{S}_{NN}(\\boldsymbol{\\omega}) = \\lvert F_P \\rvert^2 / (M^2)$。\n- 仅使用可观测的量，根据平稳性和不相关性假设推断 $\\widehat{S}_{XX}(\\boldsymbol{\\omega})$，并通过将任何负值截断为 $0$ 来强制非负性。\n- 在实现过程中，在任何需要的地方使用一个小的正则化项 $\\varepsilon = 10^{-8}$ 以避免除以零。\n- 将您推导出的最优 $H(\\boldsymbol{\\omega})$ 应用于频域中的 $Y[\\mathbf{r}]$，并进行DFT逆变换以获得实值估计 $\\widehat{X}[\\mathbf{r}]$。\n- 使用峰值信噪比（PSNR）来量化性能，其定义为 $\\mathrm{PSNR} = 10 \\log_{10}\\!\\left(\\dfrac{A^2}{\\mathrm{MSE}}\\right)$，其中 $A$ 是 $X[\\mathbf{r}]$ 的已知峰值强度，$\\mathrm{MSE}$ 是 $X[\\mathbf{r}]$ 与待比较图像之间的均方误差。使用 $A = 1.50$。以浮点数形式报告PSNR的提升量，即 $\\mathrm{PSNR}(\\widehat{X}, X) - \\mathrm{PSNR}(Y, X)$，针对每个测试案例。\n\n角度单位不适用。不需要物理单位。所有输出必须是实数。您的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，$[\\text{result}_1,\\text{result}_2,\\text{result}_3]$），其中每个结果是对应测试案例的PSNR提升量，四舍五入到 $4$ 位小数。\n\n需要实现的测试套件摘要：\n- 案例 1：白噪声，标准差 $0.10$。\n- 案例 2：通过高斯卷积得到的有色噪声，基础白噪声标准差 $0.20$，高斯核标准差 $2.0$ 像素。\n- 案例 3：白噪声，标准差 $0.02$。\n\n您的代码必须是一个完整、可运行的程序，能够构建 $X[\\mathbf{r}]$，根据每个案例生成 $Y[\\mathbf{r}]$，从指定的区域估计所需的谱，推导并应用最优的 $H(\\boldsymbol{\\omega})$，并以上述单行格式输出PSNR提升量。", "solution": "该问题要求在加性噪声模型下，推导用于图像去噪的最优线性移不变滤波器，然后进行数值实现并在合成数据上进行评估。这是信号和图像处理中的一个标准问题，其解是维纳滤波器。\n\n### 1. 最优滤波器的理论推导\n\n我们给定一个线性成像模型，其中观测图像 $Y[\\mathbf{r}]$ 是真实图像 $X[\\mathbf{r}]$ 与不相关的、零均值的、二阶平稳的加性噪声 $N[\\mathbf{r}]$ 之和：\n$$ Y[\\mathbf{r}] = X[\\mathbf{r}] + N[\\mathbf{r}] $$\n我们寻求 $X[\\mathbf{r}]$ 的一个线性移不变（LSI）估计器 $\\widehat{X}[\\mathbf{r}]$。LSI滤波器由其卷积核 $h[\\mathbf{r}]$ 或等效地由其频率响应 $H(\\boldsymbol{\\omega})$ 定义。恢复后的图像在频域中由下式给出：\n$$ \\mathcal{F}\\{\\widehat{X}\\}(\\boldsymbol{\\omega}) = H(\\boldsymbol{\\omega}) \\mathcal{F}\\{Y\\}(\\boldsymbol{\\omega}) $$\n目标是找到使真实图像与估计图像之间的均方误差（MSE）最小化的滤波器 $H(\\boldsymbol{\\omega})$，MSE定义为 $\\mathrm{MSE} = \\mathbb{E}\\{ |X[\\mathbf{r}] - \\widehat{X}[\\mathbf{r}]|^2 \\}$。由于平稳性假设，MSE与空间坐标 $\\mathbf{r}$ 无关。\n\n令 $F_X(\\boldsymbol{\\omega})$、$F_Y(\\boldsymbol{\\omega})$ 和 $F_{\\widehat{X}}(\\boldsymbol{\\omega})$ 分别是各信号的离散傅里叶变换（DFT）。频域中的误差信号为 $F_E(\\boldsymbol{\\omega}) = F_X(\\boldsymbol{\\omega}) - F_{\\widehat{X}}(\\boldsymbol{\\omega})$。代入滤波器定义，我们得到：\n$$ F_E(\\boldsymbol{\\omega}) = F_X(\\boldsymbol{\\omega}) - H(\\boldsymbol{\\omega}) F_Y(\\boldsymbol{\\omega}) $$\nMSE可以计算为误差信号的功率谱密度（PSD）$S_{EE}(\\boldsymbol{\\omega})$ 在所有频率上的总和（在连续情况下为积分）。PSD与DFT系数的期望平方幅度成正比，$S_{EE}(\\boldsymbol{\\omega}) \\propto \\mathbb{E}\\{ |F_E(\\boldsymbol{\\omega})|^2 \\}$。我们可以通过独立地最小化每个频率 $\\boldsymbol{\\omega}$ 处的 $S_{EE}(\\boldsymbol{\\omega})$ 来最小化总MSE。\n$$ \\mathbb{E}\\{ |F_E(\\boldsymbol{\\omega})|^2 \\} = \\mathbb{E}\\{ |F_X(\\boldsymbol{\\omega}) - H(\\boldsymbol{\\omega}) F_Y(\\boldsymbol{\\omega})|^2 \\} $$\n展开平方幅度：\n$$ \\mathbb{E}\\{ |F_E|^2 \\} = \\mathbb{E}\\{ (F_X - H F_Y)(F_X^* - H^* F_Y^*) \\} = \\mathbb{E}\\{ |F_X|^2 \\} - H \\mathbb{E}\\{ F_Y F_X^* \\} - H^* \\mathbb{E}\\{ F_Y^* F_X \\} + |H|^2 \\mathbb{E}\\{ |F_Y|^2 \\} $$\n这里，$H$ 是 $\\boldsymbol{\\omega}$ 的函数，而 $*$ 表示复共轭。期望项与PSD（$S_{AA}(\\boldsymbol{\\omega}) \\propto \\mathbb{E}\\{|F_A|^2\\}$）和互功率谱密度（$S_{AB}(\\boldsymbol{\\omega}) \\propto \\mathbb{E}\\{F_A F_B^*\\}$）有关。由于 $X$ 和 $N$ 是不相关且零均值的，它们的互功率谱密度 $S_{XN}(\\boldsymbol{\\omega})$ 为零。这意味着 $\\mathbb{E}\\{F_X F_N^*\\} = 0$。\n交叉项 $\\mathbb{E}\\{ F_Y F_X^* \\}$变为：\n$$ \\mathbb{E}\\{ F_Y F_X^* \\} = \\mathbb{E}\\{ (F_X + F_N) F_X^* \\} = \\mathbb{E}\\{ |F_X|^2 \\} + \\mathbb{E}\\{ F_N F_X^* \\} = \\mathbb{E}\\{ |F_X|^2 \\} $$\n因此，频率 $\\boldsymbol{\\omega}$ 处的误差功率表达式与以下成正比：\n$$ S_{EE}(\\boldsymbol{\\omega}) = S_{XX}(\\boldsymbol{\\omega}) - H(\\boldsymbol{\\omega}) S_{XX}(\\boldsymbol{\\omega}) - H^*(\\boldsymbol{\\omega}) S_{XX}(\\boldsymbol{\\omega}) + |H(\\boldsymbol{\\omega})|^2 S_{YY}(\\boldsymbol{\\omega}) $$\n为了找到最小化这个实值量（$S_{XX}$ 和 $S_{YY}$ 是实数）的最优 $H(\\boldsymbol{\\omega}) = H_R + iH_I$，我们可以对其实部 $H_R$ 和虚部 $H_I$ 求偏导数。令 $\\frac{\\partial S_{EE}}{\\partial H_I} = 0$ 表明 $H_I=0$，因此最优滤波器是纯实数的。最小化问题简化为对 $H(\\boldsymbol{\\omega})$ 求导：\n$$ \\frac{\\partial S_{EE}(\\boldsymbol{\\omega})}{\\partial H(\\boldsymbol{\\omega})} = -2 S_{XX}(\\boldsymbol{\\omega}) + 2 H(\\boldsymbol{\\omega}) S_{YY}(\\boldsymbol{\\omega}) = 0 $$\n解出 $H(\\boldsymbol{\\omega})$ 得到最优的滤波器传递函数，即维纳滤波器：\n$$ H_{optimal}(\\boldsymbol{\\omega}) = \\frac{S_{XX}(\\boldsymbol{\\omega})}{S_{YY}(\\boldsymbol{\\omega})} $$\n使用给定的不相关信号PSD的加性性质 $S_{YY}(\\boldsymbol{\\omega}) = S_{XX}(\\boldsymbol{\\omega}) + S_{NN}(\\boldsymbol{\\omega})$，我们也可以将其写为：\n$$ H_{optimal}(\\boldsymbol{\\omega}) = \\frac{S_{XX}(\\boldsymbol{\\omega})}{S_{XX}(\\boldsymbol{\\omega}) + S_{NN}(\\boldsymbol{\\omega})} $$\n该滤波器会智能地衰减那些噪声功率 $S_{NN}$ 相对于信号功率 $S_{XX}$ 较高的频率。\n\n### 2. 数值实现\n实现遵循问题的详细说明。为保证可复现性，使用固定的随机种子 $1337$。\n\n**体模构建：** 创建一个大小为 $N \\times N$（$N=64$）的真实图像 $X[\\mathbf{r}]$。它由一个零强度背景和放置在其上的三个物体组成：一个圆盘（中心 $(32,32)$，半径 $12$，强度 $1.00$），一个垂直条带（第 $28$ 至 $31$ 列，强度 $0.70$），以及一个正方形（第 $12-19$ 行，第 $44-51$ 列，强度 $1.50$）。\n\n**噪声生成与观测：** 对于三个测试案例中的每一个，生成一个噪声场 $N[\\mathbf{r}]$ 并将其加到 $X[\\mathbf{r}]$ 上以形成观测图像 $Y[\\mathbf{r}]$。噪声模型为：\n1.  标准差 $\\sigma=0.10$ 的白高斯噪声。\n2.  有色高斯噪声，通过将白高斯噪声（$\\sigma=0.20$）与标准差为 $2.0$ 像素的高斯核进行卷积创建。\n3.  标准差 $\\sigma=0.02$ 的白高斯噪声。\n\n**PSD估计：** 使用周期图从观测图像 $Y[\\mathbf{r}]$ 估计所需的PSD。\n-   观测图像PSD $S_{YY}(\\boldsymbol{\\omega})$ 使用完整的 $N \\times N$ 图像 $Y[\\mathbf{r}]$ 进行估计：\n    $$ \\widehat{S}_{YY}(\\boldsymbol{\\omega}) = \\frac{|\\mathcal{F}\\{Y[\\mathbf{r}]\\}|^2}{N^2} $$\n-   噪声PSD $S_{NN}(\\boldsymbol{\\omega})$ 从 $Y[\\mathbf{r}]$ 左上角一个 $M \\times M$ 的纯噪声区域（$M=16$）估计，其中 $X[\\mathbf{r}]=0$。在进行DFT之前，该区域被零填充到 $N \\times N$。规定的公式是：\n    $$ \\widehat{S}_{NN}(\\boldsymbol{\\omega}) = \\frac{|\\mathcal{F}\\{\\text{zero-padded patch}\\}|^2}{M^2} $$\n-   然后，从其他两个估计中推断信号PSD $S_{XX}(\\boldsymbol{\\omega})$，并施加非负约束：\n    $$ \\widehat{S}_{XX}(\\boldsymbol{\\omega}) = \\max(0, \\widehat{S}_{YY}(\\boldsymbol{\\omega}) - \\widehat{S}_{NN}(\\boldsymbol{\\omega})) $$\n\n**滤波与恢复：** 使用估计的PSD和一个小的正则化项 $\\varepsilon=10^{-8}$ 来构建数值维纳滤波器，以防止除以零：\n$$ \\widehat{H}(\\boldsymbol{\\omega}) = \\frac{\\widehat{S}_{XX}(\\boldsymbol{\\omega})}{\\widehat{S}_{YY}(\\boldsymbol{\\omega}) + \\varepsilon} $$\n通过将其与观测图像的DFT $F_Y(\\boldsymbol{\\omega})$ 相乘来应用该滤波器。然后，通过对乘积进行DFT逆变换并取实部来获得估计图像 $\\widehat{X}[\\mathbf{r}]$：\n$$ \\widehat{X}[\\mathbf{r}] = \\text{real}(\\mathcal{F}^{-1}\\{ \\widehat{H}(\\boldsymbol{\\omega}) F_Y(\\boldsymbol{\\omega}) \\}) $$\n\n**性能评估：** 性能通过峰值信噪比（PSNR）的提升来衡量，其中 $\\mathrm{PSNR} = 10 \\log_{10}(A^2 / \\mathrm{MSE})$，给定的峰值信号幅度 $A=1.50$。每个案例最终报告的值是差值：$\\mathrm{PSNR}(\\widehat{X}, X) - \\mathrm{PSNR}(Y, X)$。结果四舍五入到 $4$ 位小数。", "answer": "```python\nimport numpy as np\nimport scipy.ndimage\n\ndef solve():\n    \"\"\"\n    Derives and applies a Wiener filter to denoise synthetic CT images.\n    \"\"\"\n    \n    # --- GLOBAL PARAMETERS ---\n    N = 64  # Image size N x N\n    M = 16  # Noise patch size M x M\n    RANDOM_SEED = 1337\n    EPSILON = 1e-8\n    PEAK_AMPLITUDE = 1.50\n\n    rng = np.random.default_rng(RANDOM_SEED)\n\n    # --- HELPER FUNCTIONS ---\n    def create_phantom(n_size):\n        \"\"\"Constructs the synthetic CT-like phantom image.\"\"\"\n        x = np.zeros((n_size, n_size), dtype=np.float64)\n        rows, cols = np.meshgrid(np.arange(n_size), np.arange(n_size), indexing='ij')\n\n        # 1. Disk\n        center_r, center_c, radius = 32, 32, 12\n        disk_mask = (rows - center_r)**2 + (cols - center_c)**2 = radius**2\n        x[disk_mask] = 1.00\n\n        # 2. Vertical bar\n        x[:, 28:32] = 0.70\n\n        # 3. Square\n        x[12:20, 44:52] = 1.50\n        \n        return x\n\n    def calculate_psnr(img1, img2, peak_val):\n        \"\"\"Calculates the Peak Signal-to-Noise Ratio between two images.\"\"\"\n        mse = np.mean((img1 - img2)**2)\n        if mse == 0:\n            return float('inf')\n        return 10 * np.log10(peak_val**2 / mse)\n\n    # --- MAIN PIPELINE ---\n\n    # 1. Construct the true image X\n    X_true = create_phantom(N)\n\n    # 2. Define the test suite\n    test_cases = [\n        {'type': 'white', 'std': 0.10, 'kernel_std': None},\n        {'type': 'colored', 'std': 0.20, 'kernel_std': 2.0},\n        {'type': 'white', 'std': 0.02, 'kernel_std': None}\n    ]\n\n    results = []\n\n    for case in test_cases:\n        # 3. Generate noise and the observed image Y\n        if case['type'] == 'white':\n            noise = rng.normal(loc=0, scale=case['std'], size=(N, N))\n        elif case['type'] == 'colored':\n            white_noise = rng.normal(loc=0, scale=case['std'], size=(N, N))\n            noise = scipy.ndimage.gaussian_filter(white_noise, sigma=case['kernel_std'])\n        \n        Y_observed = X_true + noise\n\n        # 4. Estimate Power Spectral Densities (PSDs)\n        # Estimate S_YY from the full image\n        F_Y = np.fft.fft2(Y_observed)\n        S_YY_hat = np.abs(F_Y)**2 / (N**2)\n\n        # Estimate S_NN from the top-left M x M noise patch\n        noise_patch = Y_observed[0:M, 0:M]\n        padded_patch = np.zeros((N, N), dtype=np.float64)\n        padded_patch[0:M, 0:M] = noise_patch\n        F_P = np.fft.fft2(padded_patch)\n        S_NN_hat = np.abs(F_P)**2 / (M**2)\n\n        # 5. Infer signal PSD S_XX\n        S_XX_hat = S_YY_hat - S_NN_hat\n        S_XX_hat = np.maximum(0, S_XX_hat) # Enforce non-negativity\n\n        # 6. Compute the optimal Wiener filter H\n        H_optimal = S_XX_hat / (S_YY_hat + EPSILON)\n\n        # 7. Apply the filter to obtain the estimated image X_hat\n        F_X_hat = H_optimal * F_Y\n        X_hat = np.real(np.fft.ifft2(F_X_hat))\n\n        # 8. Quantify performance\n        psnr_noisy = calculate_psnr(Y_observed, X_true, PEAK_AMPLITUDE)\n        psnr_filtered = calculate_psnr(X_hat, X_true, PEAK_AMPLITUDE)\n        \n        psnr_improvement = psnr_filtered - psnr_noisy\n        results.append(round(psnr_improvement, 4))\n    \n    # --- FINAL OUTPUT ---\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "4553371"}]}