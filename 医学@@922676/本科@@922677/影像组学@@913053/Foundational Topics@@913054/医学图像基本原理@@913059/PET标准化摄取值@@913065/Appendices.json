{"hands_on_practices": [{"introduction": "定量PET分析的基石是准确计算标准化摄取值（SUV）。本练习将指导您分步计算最常见的SUV指标——基于体重的标准化摄取值 ($SUV_{bw}$) [@problem_id:4555037]。此过程强调了精确计算净注射剂量并进行放射性衰变校正的重要性，这是确保测量结果准确可靠的关键。", "problem": "对一体重为 $m_{bw}=70\\,\\mathrm{kg}$ 的患者进行了一项使用氟-18 ($^{18}\\mathrm{F}$) 的全身正电子发射断层扫描 (PET) 研究。在注射前（时刻 $t=0$），测得注射器中的活度为 $A_{pre}=310\\,\\mathrm{MBq}$；注射后（相对于 $t=0$ 的延迟可忽略不计），测得注射器中的残余活度为 $A_{post}=7\\,\\mathrm{MBq}$。扫描在注射后 $t=60\\,\\mathrm{min}$ 开始。PET 图像经过重建，并针对扫描开始时间进行了衰变校正，报告显示病灶在扫描开始时的平均活度浓度为 $C_t=8.5\\,\\mathrm{kBq}/\\mathrm{ml}$。$^{18}\\mathrm{F}$ 的物理半衰期为 $T_{1/2}=109.77\\,\\mathrm{min}$。假设软组织密度约为 $1\\,\\mathrm{g}/\\mathrm{ml}$。\n\n请仅使用活度的放射性衰变定律以及体重归一化标准摄取值 (SUV) 的定义（即组织活度浓度与每单位体重的注射活度之比，所有量均参考同一时间点即扫描开始时间），计算该病灶的体重归一化标准摄取值 $SUV_{bw}$，计算中需包括对净注射活度到扫描开始时间的适当衰变校正。\n\n将最终的 $SUV_{bw}$ 表示为一个纯数（无单位），并将答案四舍五入至三位有效数字。", "solution": "该问题提法严谨，科学依据充分。下面我们进行完整求解。\n\n目标是计算在正电子发射断层扫描 (PET) 中观察到的病灶的体重归一化标准摄取值 ($SUV_{bw}$)。问题将此量定义为组织活度浓度与每单位体重的注射活度之比，并且所有量均参考同一时间点。指定的时间点是扫描开始时间 $t$。\n\n因此，$SUV_{bw}$ 的公式为：\n$$\nSUV_{bw} = \\frac{C_{t}}{\\left(\\frac{A_{inj,t}}{m_{bw}}\\right)}\n$$\n其中：\n-   $C_{t}$ 是病灶在扫描开始时间 $t$ 的平均活度浓度。\n-   $A_{inj,t}$ 是净注射放射性剂量，并已衰变校正至扫描开始时间 $t$。\n-   $m_{bw}$ 是患者的体重。\n\n为确保 $SUV_{bw}$ 是一个无量纲的量，分子和分母的单位必须等效。分子 $C_t$ 的单位是活度每体积 ($\\mathrm{kBq}/\\mathrm{ml}$)。分母的单位是活度每质量 ($\\mathrm{kBq}/\\mathrm{g}$，进行单位换算后)。问题中假设软组织密度为 $\\rho = 1\\,\\mathrm{g}/\\mathrm{ml}$，这使得体积（单位：毫升, $\\mathrm{ml}$）和质量（单位：克, $\\mathrm{g}$）之间可以等效换算。\n\n解题步骤如下：\n1.  计算注射时（$t = 0$）的净注射活度。\n2.  使用放射性衰变定律将此活度校正至扫描开始时间 $t = 60\\,\\mathrm{min}$。\n3.  将所有具有一致单位的量代入 $SUV_{bw}$ 公式并计算最终值。\n\n**步骤 1：计算 $t=0$ 时的净注射活度**\n\n净注射活度 $A_{inj,0}$ 是注射前注射器活度 $A_{pre}$ 与注射后残余活度 $A_{post}$ 之差。\n已知：\n-   $A_{pre} = 310\\,\\mathrm{MBq}$\n-   $A_{post} = 7\\,\\mathrm{MBq}$\n\n$$\nA_{inj,0} = A_{pre} - A_{post} = 310\\,\\mathrm{MBq} - 7\\,\\mathrm{MBq} = 303\\,\\mathrm{MBq}\n$$\n\n**步骤 2：注射活度的衰变校正**\n\n根据放射性衰变定律，放射性核素的活度随时间呈指数衰减：\n$$\nA(t) = A_0 \\exp(-\\lambda t)\n$$\n其中 $A_0$ 是初始活度，$t$ 是经过的时间，$\\lambda$ 是衰变常数。衰变常数与半衰期 $T_{1/2}$ 的关系如下：\n$$\n\\lambda = \\frac{\\ln(2)}{T_{1/2}}\n$$\n我们需要根据 $t=0$ 时的活度 $A_{inj,0}$ 来计算扫描开始时间时的注射活度 $A_{inj,t}$。\n已知：\n-   扫描开始时间：$t = 60\\,\\mathrm{min}$\n-   $^{18}\\mathrm{F}$ 的半衰期：$T_{1/2} = 109.77\\,\\mathrm{min}$\n\n将 $\\lambda$ 的表达式代入衰变定律：\n$$\nA_{inj,t} = A_{inj,0} \\exp\\left(-\\frac{\\ln(2) \\cdot t}{T_{1/2}}\\right)\n$$\n代入数值：\n$$\nA_{inj,t} = (303\\,\\mathrm{MBq}) \\exp\\left(-\\frac{\\ln(2) \\cdot 60\\,\\mathrm{min}}{109.77\\,\\mathrm{min}}\\right)\n$$\n\n**步骤 3：计算 $SUV_{bw}$**\n\n现在我们可以写出 $SUV_{bw}$ 的完整表达式：\n$$\nSUV_{bw} = \\frac{C_{t} \\cdot m_{bw}}{A_{inj,t}} = \\frac{C_{t} \\cdot m_{bw}}{A_{inj,0} \\exp\\left(-\\frac{\\ln(2) \\cdot t}{T_{1/2}}\\right)}\n$$\n在代入数值之前，我们必须确保所有单位一致。让我们将所有量转换到一个基本单位体系中：\n-   病灶活度浓度：$C_t = 8.5\\,\\mathrm{kBq}/\\mathrm{ml}$\n-   患者体重：$m_{bw} = 70\\,\\mathrm{kg} = 70 \\times 10^3\\,\\mathrm{g} = 70000\\,\\mathrm{g}$\n-   $t=0$ 时的净注射活度：$A_{inj,0} = 303\\,\\mathrm{MBq} = 303 \\times 10^3\\,\\mathrm{kBq} = 303000\\,\\mathrm{kBq}$\n-   时间：$t=60\\,\\mathrm{min}$\n-   半衰期：$T_{1/2}=109.77\\,\\mathrm{min}$\n\n将这些值代入 $SUV_{bw}$ 的表达式中：\n$$\nSUV_{bw} = \\frac{(8.5\\,\\mathrm{kBq}/\\mathrm{ml}) \\cdot (70000\\,\\mathrm{g})}{(303000\\,\\mathrm{kBq}) \\cdot \\exp\\left(-\\frac{\\ln(2) \\cdot 60}{109.77}\\right)}\n$$\n如前所述，由于密度假设，$\\mathrm{g}/\\mathrm{ml}$ 这一项实际上为 1，而活度单位 ($\\mathrm{kBq}$) 会相互抵消，从而得到一个无量纲的结果。\n\n首先，我们计算指数项（衰变因子）：\n$$\n\\exp\\left(-\\frac{\\ln(2) \\cdot 60}{109.77}\\right) \\approx \\exp\\left(-\\frac{0.693147 \\cdot 60}{109.77}\\right) \\approx \\exp(-0.37884) \\approx 0.684654\n$$\n现在，将这个值代回主方程：\n$$\nSUV_{bw} \\approx \\frac{8.5 \\cdot 70000}{303000 \\cdot 0.684654}\n$$\n$$\nSUV_{bw} \\approx \\frac{595000}{207439.84} \\approx 2.86828\n$$\n问题要求将最终答案四舍五入至三位有效数字。\n$$\nSUV_{bw} \\approx 2.87\n$$\n该病灶的体重归一化标准摄取值为 $2.87$。", "answer": "$$\\boxed{2.87}$$", "id": "4555037"}, {"introduction": "在掌握了基本的SUV计算方法后，我们将进一步探讨放射性示踪剂摄取的动态特性。本练习通过一个简化的动力学模型，揭示组织中的示踪剂浓度（即SUV）并非一成不变，而是随时间演变的 [@problem_id:4555029]。通过比较两个不同时间点的SUV值，您将深刻理解为何在临床和研究中统一摄取时间对于获得一致且可比的结果至关重要。", "problem": "一项放射组学研究使用 $^{18}\\mathrm{F}$-氟代脱氧葡萄糖进行静态正电子发射断层扫描 (PET) 采集，并通过标准摄取值 (SUV) 来量化摄取。SUV 定义为组织放射性活度浓度与按体重归一化的注射活度之比。扫描仪重建的图像对注射时间进行了衰变校正，且在各次扫描中，注射活度和体重保持不变。考虑一个单一病灶，其组织放射性活度浓度动态 $C_{t}(t)$ 可用一个简化的指数趋近稳态模型来描述，该模型由一个一级摄取速率常数 $k$ 和一个渐近浓度决定。假设 $k = 0.03\\,\\mathrm{min}^{-1}$。在注射后 $50\\,\\mathrm{min}$ 和 $70\\,\\mathrm{min}$ 进行了两次其他条件完全相同的 PET 扫描。使用所述模型和定义，确定在 $70\\,\\mathrm{min}$ 和 $50\\,\\mathrm{min}$ 两次扫描之间 SUV 的分数变化，定义为 $\\displaystyle \\frac{\\mathrm{SUV}(70\\,\\mathrm{min}) - \\mathrm{SUV}(50\\,\\mathrm{min})}{\\mathrm{SUV}(50\\,\\mathrm{min})}$。将您的答案四舍五入至 $4$ 位有效数字。最终结果以无单位的小数表示。", "solution": "题目要求根据给定的放射性示踪剂摄取动力学模型，计算两个时间点之间的标准摄取值 (SUV) 的分数变化。\n\n首先，我们必须将所提供的定义和模型形式化。标准摄取值 (SUV) 定义为组织放射性活度浓度 $C_t(t)$ 与按体重 $W$ 归一化的注射活度 $A_{inj}$ 之比。\n$$\n\\mathrm{SUV}(t) = \\frac{C_t(t)}{A_{inj} / W}\n$$\n题目指出，在该研究中，注射活度 $A_{inj}$ 和体重 $W$ 是恒定的。因此，我们可以将 SUV 写成与组织浓度成正比：\n$$\n\\mathrm{SUV}(t) = \\left(\\frac{W}{A_{inj}}\\right) C_t(t) = \\beta \\cdot C_t(t)\n$$\n其中 $\\beta = W/A_{inj}$ 是一个常数。\n\n题目还明确指出，PET 图像重建时对注射时间进行了衰变校正。这意味着用于 SUV 计算的浓度值 $C_t(t)$ 已经考虑了 $^{18}\\mathrm{F}$ 放射性示踪剂的物理衰变。因此，所提供的 $C_t(t)$ 模型描述的是摄取和清除的生物动力学，而不是生物动力学和物理衰变的组合。\n\n组织放射性活度浓度 $C_t(t)$ 被描述为一个简化的指数趋近稳态的行为。这是一级过程趋近平衡或渐近状态的特征。这样一个从时间 $t=0$ 时浓度为零开始的过程，其数学描述函数为：\n$$\nC_t(t) = C_{ss} \\left(1 - \\exp(-kt)\\right)\n$$\n其中 $C_{ss}$ 是渐近（稳态）浓度，$k$ 是一级摄取速率常数。给定的速率常数值为 $k = 0.03\\,\\mathrm{min}^{-1}$。\n\n将 $C_t(t)$ 的这个表达式代入 SUV 的方程中，得到：\n$$\n\\mathrm{SUV}(t) = \\beta \\cdot C_{ss} \\left(1 - \\exp(-kt)\\right)\n$$\n我们定义 $\\mathrm{SUV}_{ss} = \\beta \\cdot C_{ss}$，它代表渐近 SUV。SUV 作为时间函数的表达式变为：\n$$\n\\mathrm{SUV}(t) = \\mathrm{SUV}_{ss} \\left(1 - \\exp(-kt)\\right)\n$$\n我们需要计算时间点 $t_1 = 50\\,\\mathrm{min}$ 和 $t_2 = 70\\,\\mathrm{min}$ 之间的 SUV 分数变化。分数变化定义为：\n$$\n\\text{Fractional Change} = \\frac{\\mathrm{SUV}(t_2) - \\mathrm{SUV}(t_1)}{\\mathrm{SUV}(t_1)}\n$$\n代入 SUV 的时间依赖表达式：\n$$\n\\text{Fractional Change} = \\frac{\\mathrm{SUV}_{ss} \\left(1 - \\exp(-kt_2)\\right) - \\mathrm{SUV}_{ss} \\left(1 - \\exp(-kt_1)\\right)}{\\mathrm{SUV}_{ss} \\left(1 - \\exp(-kt_1)\\right)}\n$$\n常数项 $\\mathrm{SUV}_{ss}$ 从分子和分母中消去。这是预料之中的，因为题目没有提供 $A_{inj}$、$W$ 或 $C_{ss}$ 的值，表明最终结果不需要它们。\n$$\n\\text{Fractional Change} = \\frac{\\left(1 - \\exp(-kt_2)\\right) - \\left(1 - \\exp(-kt_1)\\right)}{1 - \\exp(-kt_1)}\n$$\n简化分子：\n$$\n\\text{Fractional Change} = \\frac{1 - \\exp(-kt_2) - 1 + \\exp(-kt_1)}{1 - \\exp(-kt_1)} = \\frac{\\exp(-kt_1) - \\exp(-kt_2)}{1 - \\exp(-kt_1)}\n$$\n现在我们代入给定的数值：$k = 0.03\\,\\mathrm{min}^{-1}$，$t_1 = 50\\,\\mathrm{min}$ 和 $t_2 = 70\\,\\mathrm{min}$。\n首先，我们计算无量纲的指数：\n$$\nkt_1 = (0.03\\,\\mathrm{min}^{-1}) \\cdot (50\\,\\mathrm{min}) = 1.5\n$$\n$$\nkt_2 = (0.03\\,\\mathrm{min}^{-1}) \\cdot (70\\,\\mathrm{min}) = 2.1\n$$\n将这些值代入分数变化的表达式中：\n$$\n\\text{Fractional Change} = \\frac{\\exp(-1.5) - \\exp(-2.1)}{1 - \\exp(-1.5)}\n$$\n使用计算器计算指数函数：\n$$\n\\exp(-1.5) \\approx 0.223130\n$$\n$$\n\\exp(-2.1) \\approx 0.122456\n$$\n现在，我们计算最终值：\n$$\n\\text{Fractional Change} \\approx \\frac{0.223130 - 0.122456}{1 - 0.223130} = \\frac{0.100674}{0.776870} \\approx 0.1295894\n$$\n题目要求答案四舍五入到 $4$ 位有效数字。第五位有效数字是 $8$，所以我们将第四位数字向上取整。\n$$\n\\text{Fractional Change} \\approx 0.1296\n$$\n这就是在 $70\\,\\mathrm{min}$ 和 $50\\,\\mathrm{min}$ 两次扫描之间 SUV 的分数变化。", "answer": "$$\n\\boxed{0.1296}\n$$", "id": "4555029"}, {"introduction": "这项综合性练习将理论计算与实际的放射组学工作流程联系起来。您将处理体素级别的图像数据，以计算一系列重要的SUV相关指标，包括基于瘦体重的校正值以及$SUV_{max}$和$SUV_{peak}$等空间特征 [@problem_id:4554997]。此实践模拟了真实的分析情景，旨在巩固您对基本原理的掌握，并引导您接触更高级、更具临床意义的定量特征。", "problem": "一名开发者接到一项任务，需要实现一个程序来计算正电子发射断层扫描（PET）中一个分割病灶的四项定量放射组学指标，其中 PET 代表正电子发射断层扫描（Positron Emission Tomography），SUV 代表标准化摄取值（Standardized Uptake Value）。要求的指标是体重归一化 SUV ($SUV_{bw}$)、瘦体重归一化 SUV ($SUV_{lbm}$)、峰值 SUV ($SUV_{peak}$) 和最大值 SUV ($SUV_{max}$)。该程序必须从第一性原理出发：指数放射性衰变定律，以及通过每单位参考质量的注射活度对活度浓度进行单位一致的归一化，并且必须包含对扫描时间的残留活度和衰变校正。所有计算必须符合科学现实并正确处理单位。\n\n使用的基本原理：\n- 对于半衰期为 $T_{1/2}$ 的放射性核素的放射性衰变：如果在参考时间测量到活度为 $A_0$，则在时间 $t$ 的活度为 $$A(t) = A_0 \\cdot 2^{-t/T_{1/2}}.$$\n- 扫描时测量的活度浓度 $C_t$ 是一个物理量，单位为千贝克勒尔/毫升（kBq/mL）。\n- 注射时的净注射活度是注射前活度与注射后残留活度之差，两者均在注射时测量。必须使用指数衰变定律将此净活度进行衰变校正至扫描时间。\n- 体重归一化 SUV 定义为组织活度浓度与每单位体重的注射活度之比。为与毫升（假设 $1$ 毫升约对应 $1$ 克组织）具有可比性，单位一致性要求质量以克为单位。瘦体重归一化 SUV 则用瘦体重替代了总体重。\n- 瘦体重（LBM）应使用 Janmahasatian 公式计算，其中体重以千克为单位，身高以米为单位，然后为保证单位一致性转换为克：\n  - 男性：$$LBM = \\frac{9270 \\cdot W}{6680 + 216 \\cdot BMI},$$\n  - 女性：$$LBM = \\frac{9270 \\cdot W}{8780 + 244 \\cdot BMI},$$\n  其中 $$BMI = \\frac{W}{H^2},$$，$W$ 的单位是千克，$H$ 的单位是米。\n\n需精确应用的定义：\n- 设 $A_{pre}$ 和 $A_{post}$ 分别为注射时测量的注射前活度和注射后残留活度，单位均为兆贝克勒尔（MBq）。注射时的净注射活度为 $$A_{inj} = A_{pre} - A_{post}。$$ 为获得扫描时间（摄取时间）$t$（单位为分钟）时的注射活度，需进行衰变校正 $$A_{scan} = A_{inj} \\cdot 2^{-t/T_{1/2}}。$$ 将 $A_{scan}$ 乘以 $1000$ 转换为千贝克勒尔（kBq）。\n- 给定一个扫描时间时单位为 kBq/mL 的 $C_t$ 图，以及一个相同形状的二值病灶掩模，将所有空间汇总限制在掩模值为 $1$ 的体素上。\n- 计算逐体素的体重归一化 SUV 图 $$SUV_{bw}(\\mathbf{r}) = \\frac{C_t(\\mathbf{r}) \\cdot M_{g}}{A_{scan,kBq}},$$ 其中 $M_{g}$ 是以克为单位的总体重（$kg \\times 1000$）。\n- 计算逐体素的瘦体重归一化 SUV 图 $$SUV_{lbm}(\\mathbf{r}) = \\frac{C_t(\\mathbf{r}) \\cdot LBM_{g}}{A_{scan,kBq}},$$ 其中 $LBM_{g}$ 是以克为单位的瘦体重（$kg \\times 1000$）。\n- 计算 $$SUV_{max} = \\max_{\\mathbf{r} \\in \\text{lesion}} SUV_{bw}(\\mathbf{r})。$$\n- 计算 $SUV_{peak}$，其值为完全包含在病灶掩模内的所有连续 $3 \\times 3 \\times 3$ 体素核的 $SUV_{bw}$ 平均值中的最大值。如果病灶掩模不包含任何完全包含的 $3 \\times 3 \\times 3$ 核，则定义 $SUV_{peak} = SUV_{max}$。\n\n所有物理量和单位：\n- $C_t$ 图条目的单位是 kBq/mL，在扫描时间。\n- $A_{pre}$ 和 $A_{post}$ 的单位是 MBq，在注射时间测量。\n- 摄取时间 $t$ 的单位是分钟。\n- 半衰期 $T_{1/2}$ 的单位是分钟。\n- 体重单位为千克，身高单位为厘米；计算身体质量指数（BMI）时使用米。\n- 将所有最终的 SUV 指标表示为无单位的浮点数，并四舍五入到四位小数。\n\n测试套件：\n实现你的程序，为以下三组参数集中的每一组计算 $SUV_{bw}$、$SUV_{lbm}$、$SUV_{peak}$ 和 $SUV_{max}$。每个测试用例提供：\n- 一个 $C_t$ 图（作为 $z \\times y \\times x$ 数组），\n- 一个相同形状的病灶掩模，\n- $A_{pre}$ (MBq)，\n- $A_{post}$ (MBq)，\n- 体重（kg），\n- 身高（cm），\n- 性别（$\\text{male}$ 或 $\\text{female}$），\n- 摄取时间 $t$（分钟），\n- 半衰期 $T_{1/2}$（分钟）。\n\n案例1（一般情况，男性，非零残留，非零摄取时间）：\n- $A_{pre} = 370$ MBq，$A_{post} = 5$ MBq，$M = 80$ kg，$H = 180$ cm，性别 $=$ 男性，$t = 60$ 分钟，$T_{1/2} = 109.77$ 分钟。\n- $C_t$ 图（$4 \\times 4 \\times 4$）：\n  - $z=0$:\n    - $y=0$: $[2.2, 2.4, 2.5, 2.3]$,\n    - $y=1$: $[2.5, 3.0, 3.2, 2.6]$,\n    - $y=2$: $[2.3, 2.9, 3.1, 2.4]$,\n    - $y=3$: $[2.1, 2.2, 2.3, 2.0]$.\n  - $z=1$:\n    - $y=0$: $[2.4, 3.1, 3.5, 2.6]$,\n    - $y=1$: $[3.2, 8.5, 12.0, 4.0]$,\n    - $y=2$: $[3.1, 10.0, 14.5, 4.2]$,\n    - $y=3$: $[2.6, 4.3, 5.0, 3.0]$.\n  - $z=2$:\n    - $y=0$: $[2.3, 3.0, 3.4, 2.5]$,\n    - $y=1$: $[3.1, 9.0, 13.0, 4.1]$,\n    - $y=2$: $[3.0, 11.5, 16.0, 4.4]$,\n    - $y=3$: $[2.5, 4.5, 5.2, 3.1]$.\n  - $z=3$:\n    - $y=0$: $[2.2, 2.8, 3.0, 2.3]$,\n    - $y=1$: $[2.9, 4.0, 4.5, 3.2]$,\n    - $y=2$: $[2.8, 4.2, 4.8, 3.3]$,\n    - $y=3$: $[2.3, 3.2, 3.5, 2.6]$.\n- 病灶掩模（$4 \\times 4 \\times 4$）：索引 $z \\in \\{1,2,3\\}$、$y \\in \\{1,2,3\\}$、$x \\in \\{1,2,3\\}$ 处为1；其他位置为0。\n\n案例2（边界情况：零残留，零摄取时间，女性）：\n- $A_{pre} = 185$ MBq，$A_{post} = 0$ MBq，$M = 55$ kg，$H = 165$ cm，性别 $=$ 女性，$t = 0$ 分钟，$T_{1/2} = 109.77$ 分钟。\n- $C_t$ 图（$3 \\times 3 \\times 3$）：\n  - $z=0$:\n    - $y=0$: $[6.0, 7.0, 6.5]$,\n    - $y=1$: $[6.8, 8.0, 7.2]$,\n    - $y=2$: $[6.2, 7.5, 6.7]$.\n  - $z=1$:\n    - $y=0$: $[7.0, 9.0, 7.5]$,\n    - $y=1$: $[8.5, 12.5, 9.0]$,\n    - $y=2$: $[7.2, 9.5, 7.8]$.\n  - $z=2$:\n    - $y=0$: $[6.5, 7.8, 7.0]$,\n    - $y=1$: $[7.5, 10.5, 8.2]$,\n    - $y=2$: $[6.8, 8.7, 7.1]$.\n- 病灶掩模（$3 \\times 3 \\times 3$）：所有位置均为1。\n\n案例3（边缘情况：极高的残留导致净活度很小，非零摄取时间，男性；病灶太小无法容纳 $3 \\times 3 \\times 3$ 核，因此 $SUV_{peak}$ 回退为 $SUV_{max}$）：\n- $A_{pre} = 100$ MBq，$A_{post} = 90$ MBq，$M = 100$ kg，$H = 175$ cm，性别 $=$ 男性，$t = 120$ 分钟，$T_{1/2} = 109.77$ 分钟。\n- $C_t$ 图（$3 \\times 3 \\times 3$）：\n  - $z=0$:\n    - $y=0$: $[3.0, 4.0, 3.5]$,\n    - $y=1$: $[4.5, 6.0, 5.0]$,\n    - $y=2$: $[3.2, 4.8, 3.8]$.\n  - $z=1$:\n    - $y=0$: $[4.0, 5.0, 4.3]$,\n    - $y=1$: $[6.5, 9.0, 7.5]$,\n    - $y=2$: $[4.0, 6.2, 5.0]$.\n  - $z=2$:\n    - $y=0$: $[3.5, 4.2, 3.7]$,\n    - $y=1$: $[5.2, 7.0, 6.0]$,\n    - $y=2$: $[3.6, 5.5, 4.2]$.\n- 病灶掩模（$3 \\times 3 \\times 3$）：索引 $z \\in \\{0,1\\}$、$y \\in \\{0,1\\}$、$x \\in \\{0,1\\}$ 处为1；其他位置为0。\n\n要求的最终输出：\n- 对于每个测试用例，计算四个浮点数 $[SUV_{bw}, SUV_{lbm}, SUV_{peak}, SUV_{max}]$ 并四舍五入到四位小数。\n- 您的程序应生成单行输出，其中包含一个逗号分隔的列表，该列表被方括号括起，其中每个元素是对应一个测试用例的列表。例如，输出格式必须严格遵循以下形式 $$\\texttt{[[s11,s12,s13,s14],[s21,s22,s23,s24],[s31,s32,s33,s34]]},$$ 其中每个 $s_{ij}$ 是一个十进制表示的浮点数（四舍五入到四位小数）。", "solution": "问题陈述经评估有效。它在科学上基于核医学和定量成像的原理，特别是正电子发射断层扫描（PET）。该问题定义明确，提供了计算放射组学指标所需的所有物理常数、患者数据、影像数据和明确的数学公式。关于标准化摄取值（SUV）的定义，包括体重和瘦体重归一化、放射性衰变以及峰值 SUV，都非常精确，并与该领域的实践相符。使用 Janmahasatian 公式计算瘦体重是一个具体且有效的选择。单位被清晰地说明，其处理方式，特别是基于假设的组织密度 $1 \\text{ g/mL}$ 在质量和体积之间进行的转换，得到了明确的论证并且是正确的。测试用例定义明确，涵盖了一般、边界和边缘条件，确保了对实现的全面测试。没有矛盾、歧义或事实错误。\n\n解决方案首先基于所提供的定义和原理建立一个通用的计算框架。然后将此框架系统地应用于三个测试用例中的每一个。对于 $SUV_{bw}$ 和 $SUV_{lbm}$ 的输出规范中存在的一个歧义（它们被定义为逐体素的图，但要求作为单个浮点数输出）通过最科学合理的解释得以解决：这些值代表整个病灶体积内的平均 SUV。\n\n### 通用计算方法\n\n对于每个测试用例，执行以下计算序列：\n\n1.  **活度计算**：在注射时，净注射活度 $A_{inj}$ 以兆贝克勒尔 ($MBq$) 为单位计算：\n    $$A_{inj} = A_{pre} - A_{post}$$\n    然后使用给定的半衰期 $T_{1/2}$ 将此活度衰变校正至扫描时间 $t$：\n    $$A_{scan} [MBq] = A_{inj} \\cdot 2^{-t/T_{1/2}}$$\n    为了在 SUV 公式中使用，此活度被转换为千贝克勒尔 ($kBq$)：\n    $$A_{scan,kBq} = A_{scan} [MBq] \\cdot 1000$$\n\n2.  **质量和瘦体重计算**：患者的体重 $M$（单位千克，$kg$）和身高 $H$（单位厘米，$cm$）分别转换为克（$g$）和米（$m$）。\n    $$M_g = M [kg] \\cdot 1000$$\n    $$H_m = H [cm] / 100$$\n    身体质量指数 ($BMI$) 计算如下：\n    $$BMI = \\frac{M [kg]}{H_m^2}$$\n    瘦体重 ($LBM$) 以 $kg$ 为单位，使用针对性别的 Janmahasatian 公式计算：\n    $$LBM_{male} [kg] = \\frac{9270 \\cdot M [kg]}{6680 + 216 \\cdot BMI}$$\n    $$LBM_{female} [kg] = \\frac{9270 \\cdot M [kg]}{8780 + 244 \\cdot BMI}$$\n    然后将 $LBM$ 转换为克，以保证 SUV 计算中的单位一致性：\n    $$LBM_g = LBM [kg] \\cdot 1000$$\n\n3.  **SUV 计算**：计算逐体素的 $SUV_{bw}$ 图。为方便起见，首先计算一个转换因子 $F_{bw}$：\n    $$F_{bw} = \\frac{M_g}{A_{scan,kBq}}$$\n    然后，对于位于位置 $\\mathbf{r}$ 的每个体素：\n    $$SUV_{bw}(\\mathbf{r}) = C_t(\\mathbf{r}) \\cdot F_{bw}$$\n    其中 $C_t(\\mathbf{r})$ 是以 $kBq/mL$ 为单位的活度浓度。$SUV_{lbm}$ 值通过缩放 $SUV_{bw}$ 值得到：\n    $$SUV_{lbm}(\\mathbf{r}) = SUV_{bw}(\\mathbf{r}) \\cdot \\frac{LBM_g}{M_g}$$\n\n4.  **放射组学指标计算**：所需的四个指标从 $SUV_{bw}$ 图和病灶掩模计算得出。\n    -   $SUV_{bw,mean}$：病灶内（掩模为 $1$ 的地方）所有体素 $\\mathbf{r}$ 的 $SUV_{bw}(\\mathbf{r})$ 的平均值。\n    -   $SUV_{lbm,mean}$：病灶内所有体素 $\\mathbf{r}$ 的 $SUV_{lbm}(\\mathbf{r})$ 的平均值。这等同于 $SUV_{bw,mean} \\cdot \\frac{LBM_g}{M_g}$。\n    -   $SUV_{max}$：病灶内所有体素 $\\mathbf{r}$ 的 $SUV_{bw}(\\mathbf{r})$ 的最大值。\n    -   $SUV_{peak}$：在所有完全包含在病灶内的连续 $3 \\times 3 \\times 3$ 体素核上计算的平均 $SUV_{bw}$ 值中的最大值。如果不存在这样的核，则 $SUV_{peak} = SUV_{max}$。\n\n### 应用于测试用例\n\n#### 案例 1\n- **输入**：$A_{pre} = 370$ MBq，$A_{post} = 5$ MBq，$M = 80$ kg，$H = 180$ cm，性别=男性，$t = 60$ 分钟，$T_{1/2} = 109.77$ 分钟。\n- **活度**：$A_{inj} = 370 - 5 = 365$ MBq。$A_{scan} = 365 \\cdot 2^{-60/109.77} \\approx 250.40096$ MBq。$A_{scan,kBq} \\approx 250400.96$ kBq。\n- **质量**：$M_g = 80000$ g。$H_m = 1.8$ m。$BMI = 80 / (1.8^2) \\approx 24.6914$。$LBM \\approx \\frac{9270 \\cdot 80}{6680 + 216 \\cdot 24.6914} \\approx 61.7284$ kg。$LBM_g \\approx 61728.4$ g。\n- **SUV 因子**：$F_{bw} = 80000 / 250400.96 \\approx 0.319488$。比率 $\\frac{LBM_g}{M_g} \\approx 0.771605$。\n- **病灶数据**：病灶是一个 $3 \\times 3 \\times 3$ 的子体积。病灶内 $27$ 个体素的 $C_t$ 值总和为 $169.6$ kBq/mL。平均 $C_t = 169.6 / 27 \\approx 6.2815$ kBq/mL。最大 $C_t$ 为 $16.0$ kBq/mL。\n- **指标**：\n    -   $SUV_{bw,mean} = 6.2815 \\cdot 0.319488 \\approx 2.0068$。\n    -   $SUV_{lbm,mean} = 2.0068 \\cdot 0.771605 \\approx 1.5485$。\n    -   $SUV_{max} = 16.0 \\cdot 0.319488 \\approx 5.1118$。\n    -   $SUV_{peak}$：病灶是一个 $3 \\times 3 \\times 3$ 的体积，因此只有一个 $3 \\times 3 \\times 3$ 的核能被完全包含。其平均值就是病灶的平均值。因此，$SUV_{peak} = SUV_{bw,mean} \\approx 2.0068$。\n- **结果**：$[2.0068, 1.5485, 2.0068, 5.1118]$\n\n#### 案例 2\n- **输入**：$A_{pre} = 185$ MBq，$A_{post} = 0$ MBq，$M = 55$ kg，$H = 165$ cm，性别=女性，$t = 0$ 分钟，$T_{1/2} = 109.77$ 分钟。\n- **活度**：$A_{inj} = 185 - 0 = 185$ MBq。由于 $t=0$，$A_{scan} = 185$ MBq。$A_{scan,kBq} = 185000$ kBq。\n- **质量**：$M_g = 55000$ g。$H_m = 1.65$ m。$BMI = 55 / (1.65^2) \\approx 20.2020$。$LBM \\approx \\frac{9270 \\cdot 55}{8780 + 244 \\cdot 20.2020} \\approx 37.1901$ kg。$LBM_g \\approx 37190.1$ g。\n- **SUV 因子**：$F_{bw} = 55000 / 185000 = 11/37 \\approx 0.297297$。比率 $\\frac{LBM_g}{M_g} \\approx 0.676184$。\n- **病灶数据**：病灶是整个 $3 \\times 3 \\times 3$ 的体积。$27$ 个体素的 $C_t$ 总和 = $210.0$ kBq/mL。平均 $C_t = 210.0 / 27 \\approx 7.7778$ kBq/mL。最大 $C_t = 12.5$ kBq/mL。\n- **指标**：\n    -   $SUV_{bw,mean} = (210/27) \\cdot (11/37) \\approx 2.3123$。\n    -   $SUV_{lbm,mean} = 2.3123 \\cdot 0.676184 \\approx 1.5635$。\n    -   $SUV_{max} = 12.5 \\cdot (11/37) \\approx 3.7162$。\n    -   $SUV_{peak}$：与案例 1 类似，病灶是一个 $3 \\times 3 \\times 3$ 的体积，因此 $SUV_{peak} = SUV_{bw,mean} \\approx 2.3123$。\n- **结果**：$[2.3123, 1.5635, 2.3123, 3.7162]$\n\n#### 案例 3\n- **输入**：$A_{pre} = 100$ MBq，$A_{post} = 90$ MBq，$M = 100$ kg，$H = 175$ cm，性别=男性，$t = 120$ 分钟，$T_{1/2} = 109.77$ 分钟。\n- **活度**：$A_{inj} = 100 - 90 = 10$ MBq。$A_{scan} = 10 \\cdot 2^{-120/109.77} \\approx 4.68840$ MBq。$A_{scan,kBq} \\approx 4688.40$ kBq。\n- **质量**：$M_g = 100000$ g。$H_m = 1.75$ m。$BMI = 100 / (1.75^2) \\approx 32.6531$。$LBM \\approx \\frac{9270 \\cdot 100}{6680 + 216 \\cdot 32.6531} \\approx 67.5020$ kg。$LBM_g \\approx 67502.0$ g。\n- **SUV 因子**：$F_{bw} = 100000 / 4688.40 \\approx 21.3292$。比率 $\\frac{LBM_g}{M_g} \\approx 0.675020$。\n- **病灶数据**：病灶是一个 $2 \\times 2 \\times 2$ 的子体积。$8$ 个体素的 $C_t$ 总和 = $42.0$ kBq/mL。平均 $C_t = 42.0 / 8 = 5.25$ kBq/mL。最大 $C_t = 9.0$ kBq/mL。\n- **指标**：\n    -   $SUV_{bw,mean} = 5.25 \\cdot 21.3292 \\approx 111.9785$。\n    -   $SUV_{lbm,mean} = 111.9785 \\cdot 0.675020 \\approx 75.5881$。\n    -   $SUV_{max} = 9.0 \\cdot 21.3292 \\approx 191.9632$。\n    -   $SUV_{peak}$：病灶大小为 $2 \\times 2 \\times 2$，小于 $3 \\times 3 \\times 3$ 的核。没有这样的核可以被完全包含。根据问题定义，$SUV_{peak} = SUV_{max} \\approx 191.9632$。\n- **结果**：$[111.9785, 75.5881, 191.9632, 191.9632]$\n\n以下程序实现了这一逻辑。", "answer": "```python\nimport numpy as np\n\ndef compute_metrics(C_t_map, lesion_mask, A_pre, A_post, M_kg, H_cm, sex, t_min, T_half_min):\n    \"\"\"\n    Computes SUV-based radiomics metrics for a single PET lesion case.\n    \n    Args:\n        C_t_map (np.ndarray): 3D array of activity concentration in kBq/mL.\n        lesion_mask (np.ndarray): 3D binary mask of the lesion.\n        A_pre (float): Pre-injection activity in MBq.\n        A_post (float): Post-injection residual activity in MBq.\n        M_kg (float): Patient body mass in kg.\n        H_cm (float): Patient height in cm.\n        sex (str): Patient sex, 'male' or 'female'.\n        t_min (float): Uptake time from injection to scan in minutes.\n        T_half_min (float): Radionuclide half-life in minutes.\n        \n    Returns:\n        list: A list of four floats [SUV_bw_mean, SUV_lbm_mean, SUV_peak, SUV_max].\n    \"\"\"\n    # Step 1: Activity Calculation\n    A_inj_MBq = A_pre - A_post\n    A_scan_MBq = A_inj_MBq * (2**(-t_min / T_half_min))\n    A_scan_kBq = A_scan_MBq * 1000\n\n    if A_scan_kBq == 0:\n        # Avoid division by zero if there's no activity\n        return [0.0, 0.0, 0.0, 0.0]\n\n    # Step 2: Mass and LBM Calculation\n    M_g = M_kg * 1000\n    H_m = H_cm / 100\n    \n    BMI = M_kg / (H_m**2)\n\n    if sex == 'male':\n        LBM_kg = (9270 * M_kg) / (6680 + 216 * BMI)\n    elif sex == 'female':\n        LBM_kg = (9270 * M_kg) / (8780 + 244 * BMI)\n    else:\n        raise ValueError(\"Sex must be 'male' or 'female'\")\n    LBM_g = LBM_kg * 1000\n\n    # Step 3: SUV Calculation\n    F_bw = M_g / A_scan_kBq\n    suv_bw_map = C_t_map * F_bw\n    \n    # Step 4: Radiomic Metrics Calculation\n    lesion_suv_bw_voxels = suv_bw_map[lesion_mask == 1]\n    \n    # Check if lesion is empty\n    if lesion_suv_bw_voxels.size == 0:\n        return [0.0, 0.0, 0.0, 0.0]\n\n    suv_bw_mean = np.mean(lesion_suv_bw_voxels)\n    \n    lbm_to_bw_ratio = LBM_g / M_g\n    suv_lbm_mean = suv_bw_mean * lbm_to_bw_ratio\n    \n    suv_max = np.max(lesion_suv_bw_voxels)\n\n    # SUV_peak calculation\n    kernel_means = []\n    # Iterate through all possible top-left-front corners of a 3x3x3 kernel\n    lim_z, lim_y, lim_x = [dim - 2 for dim in lesion_mask.shape]\n    if lim_z > 0 and lim_y > 0 and lim_x > 0:\n        for z in range(lim_z):\n            for y in range(lim_y):\n                for x in range(lim_x):\n                    # Define kernel regions for mask and SUV map\n                    mask_kernel = lesion_mask[z:z+3, y:y+3, x:x+3]\n                    \n                    # Check if the kernel is fully contained within the lesion\n                    if np.all(mask_kernel == 1):\n                        suv_kernel = suv_bw_map[z:z+3, y:y+3, x:x+3]\n                        kernel_means.append(np.mean(suv_kernel))\n\n    if not kernel_means:\n        suv_peak = suv_max\n    else:\n        suv_peak = max(kernel_means)\n\n    return [suv_bw_mean, suv_lbm_mean, suv_peak, suv_max]\n\ndef solve():\n    \"\"\"\n    Main function to run test cases and print results.\n    \"\"\"\n    test_cases = [\n        {\n            \"C_t_map\": np.array([\n                [[2.2, 2.4, 2.5, 2.3], [2.5, 3.0, 3.2, 2.6], [2.3, 2.9, 3.1, 2.4], [2.1, 2.2, 2.3, 2.0]],\n                [[2.4, 3.1, 3.5, 2.6], [3.2, 8.5, 12.0, 4.0], [3.1, 10.0, 14.5, 4.2], [2.6, 4.3, 5.0, 3.0]],\n                [[2.3, 3.0, 3.4, 2.5], [3.1, 9.0, 13.0, 4.1], [3.0, 11.5, 16.0, 4.4], [2.5, 4.5, 5.2, 3.1]],\n                [[2.2, 2.8, 3.0, 2.3], [2.9, 4.0, 4.5, 3.2], [2.8, 4.2, 4.8, 3.3], [2.3, 3.2, 3.5, 2.6]]\n            ]),\n            \"lesion_mask_def\": (\"indices\", [1, 2, 3], [1, 2, 3], [1, 2, 3]),\n            \"A_pre\": 370.0, \"A_post\": 5.0, \"M_kg\": 80.0, \"H_cm\": 180.0, \"sex\": \"male\", \"t_min\": 60.0, \"T_half_min\": 109.77\n        },\n        {\n            \"C_t_map\": np.array([\n                [[6.0, 7.0, 6.5], [6.8, 8.0, 7.2], [6.2, 7.5, 6.7]],\n                [[7.0, 9.0, 7.5], [8.5, 12.5, 9.0], [7.2, 9.5, 7.8]],\n                [[6.5, 7.8, 7.0], [7.5, 10.5, 8.2], [6.8, 8.7, 7.1]]\n            ]),\n            \"lesion_mask_def\": (\"all\",),\n            \"A_pre\": 185.0, \"A_post\": 0.0, \"M_kg\": 55.0, \"H_cm\": 165.0, \"sex\": \"female\", \"t_min\": 0.0, \"T_half_min\": 109.77\n        },\n        {\n            \"C_t_map\": np.array([\n                [[3.0, 4.0, 3.5], [4.5, 6.0, 5.0], [3.2, 4.8, 3.8]],\n                [[4.0, 5.0, 4.3], [6.5, 9.0, 7.5], [4.0, 6.2, 5.0]],\n                [[3.5, 4.2, 3.7], [5.2, 7.0, 6.0], [3.6, 5.5, 4.2]]\n            ]),\n            \"lesion_mask_def\": (\"indices\", [0, 1], [0, 1], [0, 1]),\n            \"A_pre\": 100.0, \"A_post\": 90.0, \"M_kg\": 100.0, \"H_cm\": 175.0, \"sex\": \"male\", \"t_min\": 120.0, \"T_half_min\": 109.77\n        }\n    ]\n\n    all_results = []\n    for case in test_cases:\n        shape = case[\"C_t_map\"].shape\n        mask = np.zeros(shape, dtype=int)\n        mask_def = case[\"lesion_mask_def\"]\n        if mask_def[0] == \"all\":\n            mask.fill(1)\n        elif mask_def[0] == \"indices\":\n            z_indices, y_indices, x_indices = mask_def[1], mask_def[2], mask_def[3]\n            for z in z_indices:\n                for y in y_indices:\n                    for x in x_indices:\n                        mask[z, y, x] = 1\n\n        results = compute_metrics(\n            case[\"C_t_map\"], mask, case[\"A_pre\"], case[\"A_post\"],\n            case[\"M_kg\"], case[\"H_cm\"], case[\"sex\"],\n            case[\"t_min\"], case[\"T_half_min\"]\n        )\n        all_results.append(results)\n    \n    # Format the final output string exactly as required\n    outer_parts = []\n    for res in all_results:\n        inner_parts = [f\"{val:.4f}\" for val in res]\n        outer_parts.append(f\"[{','.join(inner_parts)}]\")\n    \n    final_output_str = f\"[{','.join(outer_parts)}]\"\n    print(final_output_str)\n\nsolve()\n```", "id": "4554997"}]}