## 引言
在[医学影像](@entry_id:269649)、数字病理乃至更广泛的科学图像分析领域，如何将人眼观察到的复杂纹理转化为客观、可重复的定量指标，是一个核心挑战。这些纹理模式——无论是肿瘤内部的异质性，还是组织[纤维化](@entry_id:156331)的程度——都蕴含着丰富的生物学信息。灰度游程矩阵 (GLRLM) 作为一种强大的[纹理分析](@entry_id:202600)工具，正是为解决这一问题而生，它提供了一种独特的视角来捕捉和量化图像中像素强度的空间排布规律，尤其是那些具有线性或条带状特征的结构。

本文旨在为读者提供一个关于 GLRLM 的全面而深入的理解。我们将跨越三个章节，系统地剖析这一技术。在“**原理与机制**”中，我们将从第一性原理出发，建立 GLRLM 的数学定义，并探讨其构建过程中的关键实践考量。随后，在“**应用与跨学科联系**”中，我们将展示 GLRLM 如何在临床放射学、细胞生物学等多个领域中发挥作用，将抽象的特征与具体的科学问题联系起来。最后，通过“**动手实践**”部分，读者将有机会通过具体的计算和编程练习，将理论知识内化为解决实际问题的能力。通过本次学习，你将掌握一种先进的定量图像分析方法，为你的研究和实践增添有力的工具。

## 原理与机制

本章在前一章介绍放射组学基本背景的基础上，将深入探讨一种关键的[纹理分析](@entry_id:202600)方法：灰度游程矩阵 (Gray-Level Run-Length Matrix, GLRLM) 及其衍生特征。我们将从其基本定义出发，系统性地阐述其构建过程中的关键考量，并详细解析各类特征的数学原理和物理解释。本章旨在为读者提供一个关于 GLRLM 的严谨、清晰且系统化的知识框架。

### 基本概念：定义游程与灰度游程矩阵

[纹理分析](@entry_id:202600)的核心在于量化图像中像素强度的空间排布模式。灰度游程矩阵 (GLRLM) 是一种从特定视角捕捉这种模式的强大工具。

#### 什么是游程？

在离散的图像栅格中，**游程 (run)** 被定义为沿着一个特定方向上，具有相同灰度级的一组连续、共线的最大像素序列。这里的“最大”至关重要，它意味着这个序列无法再沿着该方向或其反方向进行延伸。例如，在一行像素序列 `[A, A, A, B, B]` 中，对于灰度级 `A`，存在一个长度为 3 的游程；对于灰度级 `B`，存在一个长度为 2 的游程。`[A, A]` 只是 `[A, A, A]` 的一个子序列，因此不构成一个独立的游程。

#### 灰度游程矩阵 (GLRLM) 的定义

**灰度游程矩阵**，记为 $P(i,j)$，是一个二维矩阵，其本质是一个直方图。它系统地记录了在给定方向上，灰度级为 $i$、长度为 $j$ 的游程所出现的次数。矩阵的行索引 $i$ 对应于离散化的灰度级（从 1 到 $N_g$，其中 $N_g$ 是总灰度级数），列索引 $j$ 对应于游程的长度（从 1 到 $N_{rl}$，其中 $N_{rl}$ 是图像中出现的最长游程）。

为了建立一个严谨的数学基础，我们可以精确地定义 GLRLM 中的每一个元素。给定一个三维体素格 $\mathcal{L}$，其灰度图为 $I:\mathcal{L}\to\{1,\dots,N_g\}$，并选定一个离散的方向向量 $\vec{d}$。$P_{\vec{d}}(i,j)$ 的值可以通过对格点 $\mathcal{L}$ 中的每一个体素 $x$ 进行检验来计算。一个体素 $x$ 被计为一个灰度为 $i$、长度为 $j$ 的游程的起点，当且仅当它同时满足以下三个条件 [@problem_id:4564411]：

1.  **游程内容条件 (Run Content Condition)**：从 $x$ 开始，沿着 $\vec{d}$ 方向的 $j$ 个连续体素必须都存在于 $\mathcal{L}$ 内，并且它们的灰度级都是 $i$。
    $$ \forall k \in \{0, 1, \dots, j-1\}: (x+k\vec{d} \in \mathcal{L} \text{ and } I(x+k\vec{d}) = i) $$

2.  **起点最[大性](@entry_id:268856)条件 (Start-of-Run Condition)**：该游程不能向后延伸。这意味着 $x$ 的前一个体素 $x-\vec{d}$ 要么不在 $\mathcal{L}$ 内，要么其灰度级不为 $i$。
    $$ (x-\vec{d} \notin \mathcal{L}) \lor (I(x-\vec{d}) \neq i) $$

3.  **终点最[大性](@entry_id:268856)条件 (End-of-Run Condition)**：该游程不能向前延伸。这意味着游程的最后一个体素 $x+(j-1)\vec{d}$ 之后紧邻的体素 $x+j\vec{d}$，要么不在 $\mathcal{L}$ 内，要么其灰度级不为 $i$。
    $$ (x+j\vec{d} \notin \mathcal{L}) \lor (I(x+j\vec{d}) \neq i) $$

因此，$P_{\vec{d}}(i,j)$ 的严格数学表达式为对所有满足这三个条件的体素 $x$ 的计数：
$$
P_{\vec{d}}(i,j) = \sum_{x\in\mathcal{L}} \mathbf{1}\Big( \underbrace{\big( x-\vec{d}\notin\mathcal{L} \lor I(x-\vec{d})\ne i \big)}_{\text{起点条件}} \land \underbrace{\big( \forall k\in\{0,\dots,j-1\}: x+k\vec{d}\in\mathcal{L}, I(x+k\vec{d})=i \big)}_{\text{内容条件}} \land \underbrace{\big( x+j\vec{d}\notin\mathcal{L} \lor I(x+j\vec{d})\ne i \big)}_{\text{终点条件}} \Big)
$$
其中 $\mathbf{1}(\cdot)$ 是[示性函数](@entry_id:261577)，当其谓词为真时取值为 1，否则为 0。

值得注意的是，GLRLM 与另一种常见的纹理矩阵——**灰度共生矩阵 (Gray-Level Co-occurrence Matrix, GLCM)**——有着本质区别。GLCM 统计的是在特定空间偏移（距离和方向）下，成对出现的像素灰度级组合的频率，它关注的是像素对的空间关系。而 GLRLM 则关注由相同灰度级像素组成的连续线段的属性，捕捉的是图像的“条纹性”或“斑块性”纹理 [@problem_id:4552601]。

### GLRLM 构建中的实践考量

在将 GLRLM 应用于实际医学图像数据时，几个关键的预处理和设置步骤会显著影响最终特征的稳定性和可比性。

#### 强度离散化

医学图像（如 CT、MRI）的原始像素值通常是连续或半连续的。为了构建 GLRLM，必须首先将这些强度值**离散化 (discretization)** 为有限数量 $N_g$ 的灰度级。最常用的方法是**固定宽度分箱 (fixed-bin scheme)** [@problem_id:4564397]。

一个常见的离散化函数是：
$$ g(x) = \lfloor (x - \mu) / \Delta \rfloor + 1 $$
其中 $x$ 是原始体素强度，$\mu$ 是一个锚定水平，$\Delta > 0$ 是固定的箱体宽度，$\lfloor \cdot \rfloor$ 是向下[取整函数](@entry_id:265373)。

选择 $\mu$ 和 $\Delta$ 的策略对特征的**可重复性 (reproducibility)** 至关重要。

-   **自适应分箱 (Adaptive Binning)**：一种策略是根据每个感兴趣区域 (Region of Interest, ROI) 内部的[强度分布](@entry_id:163068)来确定参数，例如，将 $\mu$ 设为 ROI 的平均强度，将 $\Delta$ 设为 ROI 强度范围的函数。这种方法虽然能确保每个 ROI 的灰度级动态范围相似，但它破坏了强度值的物理意义。例如，对于 CT 图像，一个坏[死区](@entry_id:183758)域（如 -50 到 50 HU）和一个钙化区域（如 200 到 300 HU）在生物学上截然不同，但自适应分箱可能将它们映射到相似的离散灰度分布上。这导致在不同患者或扫描之间丧失了可比性。

-   **固定分箱 (Fixed Binning)**：更稳健的方法是采用固定的、具有物理意义的参数。对于已校准的[定量成像](@entry_id:753923)模态（如 CT 的亨斯菲尔德单位 HU），我们可以将 $\mu$ 锚定到一个物理参考点（例如，$\mu=0$ HU，对应于水的密度），并选择一个固定的箱宽 $\Delta$（例如，$\Delta=25$ HU）。这种方法确保了在所有图像中，一个特定的强度区间总是被映射到同一个离散灰度级。这使得跨不同患者、不同扫描仪获得的放射组学特征具有了生物学上的一致性和可比性，是图像生物标志物标准化倡议 (Image Biomarker Standardisation Initiative, IBSI) 等组织推荐的做法 [@problem_id:4564397]。

此外，箱宽 $\Delta$ 的选择本身也会影响纹理特征。对于固定的强度范围，减小 $\Delta$（即更精细的[分箱](@entry_id:264748)）会增加离散灰度级的数量。这使得相邻体素之间微小的强度波动更容易导致它们被分到不同的箱中，从而倾向于打断长游程，产生更多短游程。因此，更精细的量化通常会使纹理显得更“细碎”[@problem_id:4564397]。

#### 方向性与各向同性

GLRLM 的定义是内在地**方向性的 (directional)**。在三维空间中，分析通常需要沿多个方向进行，以全面捕捉纹理。在一个[立方晶格](@entry_id:148452)中，一个体素的邻域由其周围的 26 个体素构成，这些邻居定义了 26 个基本[方向向量](@entry_id:169562)（例如，$(1,0,0), (1,1,0), (1,1,1)$ 及其变体）。

由于相反方向（例如 $\vec{d}$ 和 $-\vec{d}$）上的游程计数是等价的（$P_{\vec{d}} = P_{-\vec{d}}$），这 26 个有向向量实际上构成了 13 条独特的、无方向的分析轴线。为了获得一个**各向同性 (isotropic)** 或旋转不变的纹理描述，标准的做法是分别计算这 13 个唯一方向上的 GLRLM，然后将它们聚合起来。最直接和最常用的聚合方法是**求和** [@problem_id:4564401]：
$$ P_{\mathrm{iso}}(i,j) = \sum_{\vec{d} \in \mathcal{D}} P_{\vec{d}}(i,j) $$
其中 $\mathcal{D}$ 是代表这 13 个唯一方向的向量集合（例如，通过[字典序](@entry_id:143032)规则选出，保证每个方向对只选一个）。这种简单的求和操作确保了最终的 $P_{\mathrm{iso}}(i,j)$ 与选择哪个方向作为代表无关，从而获得了对方向不敏感的稳定纹理描述。

#### 各向异性体素间距

在临床实践中，医学图像的体素往往是**各向异性的 (anisotropic)**，即三个轴向上的物理尺寸不同。例如，CT 扫描的层厚（z 轴间距）通常远大于平面内像素的尺寸（x, y 轴间距）。

当特征的计算仅基于体素计数（如游程长度 $j$）时，这种各向异性会引入严重偏倚。一个在 z 轴上长度为 $j=2$ 的游程，其物理长度可能是在 x 轴上长度为 $j=2$ 的游程的数倍。直接比较这两个方向上计算出的、未校正的特征值是没有意义的 [@problem_id:4564403]。

为了解决这个问题，必须引入**物理长度 (physical length)** 的概念。一个方向上的物理游程长度 $L_j$ 等于体素计数 $j$ 乘以该方向上的体素间距 $s$：
$$ L_j = j \cdot s $$
所有依赖于游程长度的特征都应该使用 $L_j$ 而非 $j$ 进行计算，以保证其物理意义的一致性。以**短游程强调 (Short Run Emphasis, SRE)** 为例，其标准定义与物理校正后的定义关系如下：
$$ \text{SRE}_{\text{uncorr}} = \frac{1}{N_r} \sum_{i,j} \frac{P(i,j)}{j^2} $$
$$ \text{SRE}_{\text{corr}}(s) = \frac{1}{N_r} \sum_{i,j} \frac{P(i,j)}{L_j^2} = \frac{1}{N_r} \sum_{i,j} \frac{P(i,j)}{(j \cdot s)^2} = \frac{1}{s^2} \left( \frac{1}{N_r} \sum_{i,j} \frac{P(i,j)}{j^2} \right) = \frac{1}{s^2} \cdot \text{SRE}_{\text{uncorr}} $$
这个简单的推导表明，通过将无单位的、未校正的特征值除以相应方向上体素间距的平方，可以得到具有物理单位（例如 $\text{mm}^{-2}$）且跨不同扫描参数可比的校正特征值。这是确保放射组学特征稳健性的关键一步 [@problem_id:4564403]。

### 从矩阵到特征：量化纹理

GLRLM 本身是一个[高维数据](@entry_id:138874)结构，为了在[统计模型](@entry_id:755400)中使用，需要从中提取一系列低维的、可解释的标量特征。

#### 基础矩阵属性

从 GLRLM 可以直接计算出两个基本量：

-   **总游程数 (Total Number of Runs)**, $N_r$：矩阵中所有元素的总和。
    $$ N_r = \sum_{i=1}^{N_g} \sum_{j=1}^{N_{rl}} P(i,j) $$

-   **总体素数 (Total Number of Voxels)**, $N_p$：所有游程长度的总和，也等于 ROI 中的总体素数。
    $$ N_p = \sum_{i=1}^{N_g} \sum_{j=1}^{N_{rl}} j \cdot P(i,j) $$
这两个量是计算许多归一化特征的基础 [@problem_id:4554340]。

#### 概率视角下的 GLRLM 特征

通过将 GLRLM 按总游程数 $N_r$ 进行归一化，我们可以得到一个[联合概率质量函数](@entry_id:184238) $p(i,j) = P(i,j) / N_r$。其中，$p(i,j)$ 表示随机抽取一个游程，该游程的灰度级为 $i$ 且长度为 $j$ 的概率。

基于这个概率分布，我们可以定义一系列统计特征。首先，我们可以计算**边缘概率分布 (marginal probability distribution)**。例如，游程长度的边缘分布 $p_l(j)$ 是：
$$ p_l(j) = \sum_{i=1}^{N_g} p(i,j) $$
它表示一个随机游程长度为 $j$ 的概率，而不考虑其灰度级。

利用这个边缘分布，我们可以计算游程长度的均值和方差 [@problem_id:4564390]：

-   **平均游程长度 (Mean Run Length)**, $\mu_j$：
    $$ \mu_j = E[J] = \sum_{j=1}^{N_{rl}} j \cdot p_l(j) $$

-   **游程长度方差 (Run Length Variance, RLV)**：
    $$ \text{RLV} = \text{Var}(J) = E[(J - \mu_j)^2] = \sum_{j=1}^{N_{rl}} (j - \mu_j)^2 p_l(j) $$
    RLV 衡量了游程长度在其均值周围的离散程度。高 RLV 值表示图像中既有很长的游程，也有很短的游程，长度分布不均匀。

#### 标准 GLRLM 特征

以下是一些在放射组学研究中广泛使用的标准 GLRLM 特征。

##### 游程长度强调特征

这类特征通过对不同长度的游程赋予不同权重来评估图像的“粗糙度”。

-   **短游程强调 (Short Run Emphasis, SRE)**：该特征赋予短游程更高的权重，其值越高，表示图像纹理越“细碎”或“斑点状”。其权重与游程长度的平方成反比。
    $$ \text{SRE} = \frac{1}{N_r} \sum_{i=1}^{N_g} \sum_{j=1}^{N_{rl}} \frac{P(i,j)}{j^2} $$

-   **长游程强调 (Long Run Emphasis, LRE)**：该特征赋予长游程更高的权重，其值越高，表示图像纹理越“粗糙”或包含大面积的同质区域。其权重与游程长度的平方成正比。
    $$ \text{LRE} = \frac{1}{N_r} \sum_{i=1}^{N_g} \sum_{j=1}^{N_{rl}} j^2 P(i,j) $$

需要注意的是，这些特征的归一化因子并不唯一。虽然上述公式使用总游程数 $N_r$（IBSI 标准），但某些软件实现可能使用总体素数 $N_p$ 进行归一化。这两种归一化版本的特征值之间存在一个简单的比例关系：$\text{SRE}_{N_p} = (N_r/N_p) \cdot \text{SRE}_{N_r}$。这个比例因子 $N_r/N_p$ 正是平均游程长度的倒数 [@problem_id:4564412]。

##### 分布不均匀性特征

这类特征衡量游程在灰度级或长度上的分布是否均匀。

-   **灰度不均匀性 (Gray-Level Non-Uniformity, GLNU)**：衡量游程在不同灰度级之间的分布是否均匀。如果大多数游程都集中在少数几个灰度级上，GLNU 的值就会很高。
    $$ \text{GLNU} = \frac{1}{N_r} \sum_{i=1}^{N_g} \left( \sum_{j=1}^{N_{rl}} P(i,j) \right)^2 $$

-   **游程长度不均匀性 (Run-Length Non-Uniformity, RLNU)**：衡量游程在不同长度之间的分布是否均匀。如果大多数游程的长度都相近（例如，都集中在短游程或长游程），RLNU 的值就会很高。
    $$ \text{RLNU} = \frac{1}{N_r} \sum_{j=1}^{N_{rl}} \left( \sum_{i=1}^{N_g} P(i,j) \right)^2 $$
这两个特征的高值都反映了纹理的异质性或结构性，而非均匀的随机性 [@problem_id:4613025]。

##### 其他关键特征

-   **游程百分比 (Run Percentage, RP)**：定义为总游程数与总体素数的比值。
    $$ \text{RP} = \frac{N_r}{N_p} = \frac{\sum_{i,j} P(i,j)}{\sum_{i,j} j \cdot P(i,j)} $$
    RP 是平均游程长度的倒数。高 RP 值意味着单位像素内有更多的游程，表明纹理精细且不连续 [@problem_id:4554340]。

-   **组合强调特征**：除了单独强调游程长度或灰度级，还可以同时对两者进行加权，以捕捉更具体的纹理模式。例如：
    -   **长游程高灰度强调 (Long Run High Gray-Level Emphasis, LRHGE)**：权重为 $i^2 j^2$。高值表示图像中存在由高强度（明亮）像素组成的大片连续区域。
    -   **短游程低灰度强调 (Short Run Low Gray-Level Emphasis, SRLGE)**：权重为 $1/(i^2 j^2)$。高值表示图像中存在由低强度（昏暗）像素组成的细小斑点。

    通过组合这些特征，可以形成对特定生物学模式的敏感指标。例如，一个肿瘤区域如果表现为“粗糙的明亮结构”，那么其 LRHGE 值会很高，而 SRLGE 值会很低。这两者的比值可以作为一个强大的复合生物标志物 [@problem_id:4564382]。

### 应用背景：多模态放射组学

在包含多种成像模态（如 CT、PET、MRI）的放射组学研究中，正确应用 GLRLM 至关重要。每种模态的图像强度都反映了不同的物理或生物学特性（CT 的电子密度、PET 的代谢活性、MRI 的质子弛豫特性）。

因此，将不同模态的图像强度直接混合（例如，通过平均）来构建一个单一的“跨模态”GLRLM 是没有物理意义的。正确的做法是**在特征层面进行融合** [@problem_id:4552601]：

1.  将所有模态的图像精确配准到同一个空间坐标系。
2.  在所有图像上分割出相同的感兴趣区域。
3.  **对每种模态的图像分别独立地**计算一整套 GLRLM 特征（以及其他放射组学特征）。
4.  将从 CT、PET、MRI 等模态获得的特征向量进行拼接，形成一个更长的、信息更丰富的组合特征向量。
5.  将这个组合特征向量用于后续的机器学习模型训练和预测。

这种策略确保了每种模态提供的独特信息都得到保留，并通过模型来学习它们之间的复杂关联。