## 引言
在医学成像、[计算机视觉](@entry_id:138301)等领域，图像纹理是揭示物体内部结构和物理特性的关键信息。然而，依赖人眼进行主观的纹理评估往往缺乏一致性和可重复性，这在需要精确定量分析的临床诊断和科学研究中构成了显著的知识鸿沟。邻域灰度差分矩阵（Neighborhood Gray Tone Difference Matrix, NGTDM）作为一种经典的[纹理分析](@entry_id:202600)方法，通过客观量化像素与其局部环境的灰度差异，为解决这一问题提供了强有力的工具。本文旨在系统性地剖析NGTDM，引导读者从理论走向实践。在“原理与机制”一章中，我们将深入其数学基础，揭示它如何捕捉超越传统[直方图](@entry_id:178776)的空间信息。随后的“应用与交叉学科联系”章节将展示NGTDM如何在放射组学、多模态成像乃至地球科学中发挥作用，并探讨确保研究稳健性的关键策略。最后，通过“动手实践”部分，您将有机会亲手计算和应用NGTDM，将理论知识转化为实际技能。

## 原理与机制

本章旨在深入探讨邻域灰度差分矩阵（Neighborhood Gray Tone Difference Matrix, NGTDM）的基本原理与核心机制。我们将从其数学构件出发，系统地阐释NGTDM如何量化图像纹理，并将其与其他经典[纹理分析](@entry_id:202600)方法进行对比。此外，我们还将讨论如何从NGTDM中派生出具有直观物理解释的纹理特征，并解决在实际应用中遇到的关键技术问题。

### NGTDM的核心构件

NGTDM方法旨在捕捉一个像素（或体素）的灰度值与其周围邻域平均灰度值之间的差异。这种差异的大小反映了局部区域的纹理复杂性：差异大表示纹理粗糙或变化剧烈，差异小则表示纹理平滑或均质。

#### 邻域定义与中心像素排除

要计算局部差异，首先必须精确定义“邻域”。在离散的图像网格上，一个像素 $k$ 的邻域 $\mathcal{N}(k)$ 通常被定义为与该像素在一定距离内的所有其他像素的集合。一个常用的[距离度量](@entry_id:636073)是**[切比雪夫距离](@entry_id:174938)**（Chebyshev distance），也称为 $L_{\infty}$ 范数。对于二维图像中的两个像素 $\mathbf{u}=(u_x,u_y)$ 和 $\mathbf{v}=(v_x,v_y)$，其[切比雪夫距离](@entry_id:174938)定义为 $d_{\infty}(\mathbf{u},\mathbf{v}) = \max\{|u_x-v_x|, |u_y-v_y|\}$。因此，一个以像素 $k$ 为中心、半径为 $\delta$ 的邻域可以包含所有满足 $0  d_{\infty}(\mathbf{q}, \mathbf{p}_k) \le \delta$ 的像素 $\mathbf{q}$，其中 $\mathbf{p}_k$ 是像素 $k$ 的坐标 [@problem_id:4565930]。例如，当 $\delta=1$ 时，这对应于一个 $3 \times 3$ 的方形邻域（对于三维图像则是 $3 \times 3 \times 3$ 的立方体邻域）。

在定义了邻域之后，下一步是计算**邻域平均灰度值** $\bar{I}_k$。这是邻域内所有像素灰度值的[算术平均值](@entry_id:165355)。一个至关重要的原则是，在计算 $\bar{I}_k$ 时必须**排除中心像素 $k$ 本身** [@problem_id:4565889]。其理论依据在于，NGTDM的目的是衡量一个像素与其**环境**的差异。如果将中心像素包含在内，其自身的灰度值会“稀释”这种差异，从而引入系统性偏差。

我们可以通过数学推导来证明这一点。假设像素 $k$ 的灰度值为 $i$，其邻域内有 $N_k$ 个邻居。标准的、排除中心像素的邻域平均值为 $\mu_k$。此时，像素 $k$ 的差异贡献为 $d_k = |i - \mu_k|$。如果错误地将中心像素包含进来，新的邻域平均值 $\tilde{\mu}_k$ 会变为：
$$
\tilde{\mu}_k = \frac{i + \sum_{j=1}^{N_k} n_{k,j}}{N_k + 1} = \frac{i + N_k \mu_k}{N_k + 1}
$$
其中 $n_{k,j}$ 是邻居的灰度值。此时的差异贡献 $\tilde{d}_k$ 为：
$$
\tilde{d}_k = \left| i - \tilde{\mu}_k \right| = \left| i - \frac{i + N_k \mu_k}{N_k + 1} \right| = \left| \frac{(N_k+1)i - i - N_k \mu_k}{N_k+1} \right| = \left| \frac{N_k(i - \mu_k)}{N_k+1} \right|
$$
由此可得：
$$
\tilde{d}_k = \frac{N_k}{N_k+1} d_k
$$
这个结果表明，包含中心像素会使每个像素的差异贡献系统性地缩小一个因子 $\frac{N_k}{N_k+1}$。由于 $N_k$ 的值取决于像素在感兴趣区域（ROI）内的位置（例如，内部像素的邻居比边界像素多），这种缩小效应在整个图像上是不均匀的，从而将ROI的几何形状（如边界效应）引入到纹理测量中，这是一种需要避免的人为偏差。此外，对于没有有效邻居的孤立像素（$N_k=0$），包含自身会导致差异为零，而根据标准定义，这类像素本应被排除在计算之外 [@problem_id:4565889]。

#### NGTDM的形式化定义

基于上述原则，我们可以为一张量化为 $G$ 个灰度级的图像形式化地定义NGTDM的各个构件。对于每个灰度级 $i \in \{1, 2, \dots, G\}$：

*   **像素计数 ($n_i$)**: $n_i$ 是图像中所有灰度值为 $i$ 且至少拥有一个有效邻居的像素总数。这个计数构成了后续计算的基础 [@problem_id:4565919]。
    $$
    n_i = \#\{k \mid I_k = i \text{ and } |\mathcal{N}(k)| \ge 1\}
    $$

*   **像素概率 ($p_i$)**: $p_i$ 是灰度级为 $i$ 的像素数占所有有效像素总数的比例。令 $N = \sum_{i=1}^{G} n_i$ 为所有有效像素的总和，则：
    $$
    p_i = \frac{n_i}{N}
    $$
    由于 $n_i$ 是非负计数，且它们的总和为 $N$，因此 $p_i$ 天然地构成了一个在所有出现的灰度级上的**概率质量函数（PMF）**。即 $p_i \ge 0$ 且 $\sum_{i: n_i > 0} p_i = \frac{1}{N}\sum_{i: n_i > 0} n_i = \frac{N}{N} = 1$。这个概率分布本身代表了图像的**一阶统计量**（即灰度[直方图](@entry_id:178776)），但它也是计算更高级纹理特征的权重 [@problem_id:4566025]。

*   **差异总和 ($s_i$)**: $s_i$ 是NGTDM中真正编码纹理信息的关键。它累加了所有灰度值为 $i$ 的像素与其各自邻域平均灰度值 $\bar{I}_k$ 之间的绝对差。
    $$
    s_i = \sum_{k: I_k=i, |\mathcal{N}(k)|\ge 1} |i - \bar{I}_k|
    $$
    $s_i$ 的值越大，表明灰度级 $i$ 的像素与其周围环境的差异越大，对应区域的纹理越不均匀或对比度越高。

这三个量，$n_i$、$p_i$ 和 $s_i$，共同构成了NGTDM。虽然它名为“矩阵”，但在实际应用中，它通常表现为一组与每个灰度级 $i$ 相关联的向量或列表。

### 空间排列的角色：NGTDM如何捕捉纹理

[纹理分析](@entry_id:202600)的核心价值在于其能够区分具有相同灰度分布但空间排列不同的图像。仅仅依赖灰度[直方图](@entry_id:178776)（即 $n_i$ 或 $p_i$）是无法做到这一点的。NGTDM通过引入 $s_i$ 成功地解决了这个问题。

#### 超越灰度[直方图](@entry_id:178776)

我们可以通过一个思想实验来直观理解这一点 [@problem_id:4566002]。假设我们有两幅 $4 \times 4$ 的图像，都只包含灰度级 $0$ 和 $2$：

*   **图像A（棋盘格）**:
    $$
    \begin{pmatrix}
    0  2  0  2 \\
    2  0  2  0 \\
    0  2  0  2 \\
    2  0  2  0
    \end{pmatrix}
    $$

*   **图像B（左右分块）**:
    $$
    \begin{pmatrix}
    0  0  2  2 \\
    0  0  2  2 \\
    0  0  2  2 \\
    0  0  2  2
    \end{pmatrix}
    $$

对于这两幅图像，它们的灰度直方图是完全相同的：都有8个像素值为0，8个像素值为2。因此，它们的 $n_i$ 和 $p_i$ 值完全相同（$n_0=8, n_2=8$）。如果只看一阶统计量，这两幅图像是无法区分的。

#### 揭示空间对比度的 $s_i$

然而，这两幅图像的纹理显然不同：图像A是精细、高对比度的纹理，而图像B是粗糙、大块均匀的纹理。这种差异恰恰被 $s_i$ 捕捉到了。

*   在**图像A**中，每个像素都被不同灰度值的像素所包围。一个值为0的像素，其邻域平均值趋近于2；一个值为2的像素，其邻域平均值趋近于0。因此，对于每个像素，`|中心灰度 - 邻域平均值|` 的差值都很大。这导致了非常大的 $s_0$ 和 $s_2$ 值。

*   在**图像B**中，大部分像素的邻居都和它自己有相同的灰度值。例如，左侧区域内部一个值为0的像素，其邻域平均值也为0，差值为0。只有在两个区域的边界处，像素的邻域平均值才会偏离其自身灰度值。因此，大部分像素对 $s_i$ 的贡献为0，只有边界像素有贡献，从而导致 $s_0$ 和 $s_2$ 的值远小于图像A。

这个例子清晰地表明，$n_i$ 描述了“什么灰度级存在以及其普遍性”，而 $s_i$ 则描述了“这些灰度级是如何在空间上排布的”。$s_i$ 作为局部空间对比度的度量，是NGTDM能够超越直方图、真正捕捉纹理信息的关键所在 [@problem_id:4566002]。

### 与其他[纹理分析](@entry_id:202600)方法的区别：以GLCM为例

为了更好地理解NGTDM的特点，我们可以将其与另一种经典的[纹理分析](@entry_id:202600)方法——灰度[共生](@entry_id:142479)矩阵（Gray Level Co-occurrence Matrix, GLCM）——进行比较。

#### NGTDM：各向同性的平滑度度量

如前所述，NGTDM通过在一个通常对称的邻域（如方形或球形）内进行平均来运作。这意味着它的计算是**各向同性**的，即不依赖于特定方向。它回答的问题是：“一个像素与其周围环境的整体差异有多大？” 因此，NGTDM主要反映的是局部区域的**平滑度**或**粗糙度**。它能有效地检测到不均匀性或边界的存在，但本身不编码这些不均匀性的方向信息 [@problem_id:4565915]。

#### GLCM：各向异性的[共生关系](@entry_id:156340)

相比之下，GLCM的构建基于一个指定的**位移向量** $\Delta = (d_x, d_y)$。它统计的是图像中相隔一个固定位移 $\Delta$ 的两个像素其灰度值分别为 $(i,j)$ 的频率。因此，GLCM是**各向异性**的，其结果强烈依赖于所选的方向和距离。它回答的问题是：“在方向 $\Delta$ 上，灰度级 $i$ 后面紧跟着灰度级 $j$ 的情况有多普遍？”

考虑一个由上半部分全为2、下半部分全为0组成的图像 [@problem_id:4565915]：
$$
\begin{pmatrix}
2  2  2  2 \\
2  2  2  2 \\
0  0  0  0 \\
0  0  0  0
\end{pmatrix}
$$
*   若GLCM的位移向量设为垂直方向，如 $\Delta = (1,0)$（行+1，列+0），它会统计到大量的 $(2,0)$ 灰度对，因为这正好跨越了水平边界。
*   若位移向量设为水平方向，如 $\Delta = (0,1)$，它将只统计到 $(2,2)$ 和 $(0,0)$ 对，而 $(2,0)$ 对的计数为零。
*   对于NGTDM，边界附近的像素（无论在上部还是下部）其邻域平均值都会被另一区域的灰度值“污染”，从而产生显著的差异值。NGTDM会报告该区域存在显著的“不均匀性”，但不会指明这种不均匀性是沿着水平方向的。

总之，NGTDM和GLCM从根本上捕捉了不同类型的纹理信息。NGTDM提供了一个关于局部平滑度的各向同性度量，而GLCM则提供了关于特定空间方向上灰度级关系的各向异性度量。

### 从构件到特征：解读NGTDM度量指标

NGTDM的构件（$p_i$ 和 $s_i$）本身是高维数据。为了便于分析和比较，它们通常被聚合成几个标量纹理特征。这些特征旨在捕捉纹理的特定方面，并具有直观的物理解释。

#### 粗糙度 (Coarseness)

**粗糙度**特征旨在量化纹理的尺度。直观上，大块均匀的区域被认为是“粗糙”的（在[纹理分析](@entry_id:202600)术语中，coarse意为粗粒度，非精细），而快速变化的区域则被认为是“精细”的。其定义如下 [@problem_id:4565999]：
$$
C = \frac{1}{\sum_{i=1}^{G} p_i s_i}
$$
为避免分母为零（在完全均匀的图像中会发生），通常会加上一个极小的正数 $\varepsilon$。

这个公式的巧妙之处在于其分母 $\sum_{i=1}^{G} p_i s_i$。我们可以证明，这个表达式恰好是整幅图像中“像素与其邻域平均值之差的绝对值”的[期望值](@entry_id:150961)（或平均值）。
*   **纹理越平滑（或均质性越高）**，每个像素与其邻域的差异就越小，导致每个 $s_i$ 值变小。因此，分母 $\sum p_i s_i$ 变小，其倒数 $C$ **变大**。
*   **纹理越精细（或变化越剧烈）**，局部差异越大，导致 $s_i$ 值变大。因此，分母变大，其倒数 $C$ **变小**。

因此，**粗糙度值越大，代表纹理越平滑、均匀、粒度越粗**。这与该特征的名称直观上可能带来的印象相反，但它在数学上是自洽的，并反映了纹理的“粗粒度”特性。

#### 繁忙度 (Busyness)

**繁忙度**特征旨在衡量图像中灰度级发生快速、频繁局部变化的程度。一个合理的定义是将局部变化的总量与图像整体的灰度动态范围进行归一化比较。一个可行的公式如下 [@problem_id:4565953]：
$$
B = \frac{\sum_{i=1}^{G} p_i s_i}{\sum_{i=1}^{G} \sum_{j=1}^{G} |i-j| p_i p_j}
$$
我们来分析这个公式的构成：
*   **分子** $\sum p_i s_i$ 正如我们所见，是图像中局部差异的[平均度](@entry_id:261638)量。它直接反映了局部变化的剧烈程度。
*   **分母** $\sum_i \sum_j |i-j| p_i p_j$ 是从图像的灰度分布 $p_i$ 中随机抽取两个像素，其灰度级之差的绝对值的[期望值](@entry_id:150961)。它量化了图像整体的**灰度级广度**或**全局对比度**，而与空间排列无关。

因此，繁忙度 $B$ 是一个归一化的度量。它衡量的是，相对于图像固有的全局灰度范围，局部空间上的灰度变化有多“繁忙”。在两个具有相同灰度[直方图](@entry_id:178776)（即分母相同）的图像中，空间变化更频繁、更剧烈（如棋盘格）的图像将具有更大的分子，从而具有更高的繁忙度值 [@problem_id:4565953]。

### NGTDM的实现要点与注意事项

将NGTDM应用于实际数据（尤其是医学图像）时，必须考虑几个关键的实现细节，以确保结果的准确性和[可复现性](@entry_id:151299)。

#### 灰度离散化与特征[可复现性](@entry_id:151299)

在计算NGTDM之前，通常需要对原始图像的连续或准连续的灰度值进行**离散化**（或称量化），即将其映射到有限数量的灰度级（例如，16、32或64个级别）。这一步骤对于确保特征的**[可复现性](@entry_id:151299)**至关重要 [@problem_id:4565930]。

医学图像的原始灰度值（如CT的亨斯菲尔德单位或MRI的信号强度）对扫描仪型号、采集参数和重建算法的微小变化非常敏感。这些与生物学无关的变异会引入噪声，影响纹理特征的稳定性。通过离散化，一个范围内的原始灰度值被合并到同一个灰度级。这降低了特征对这些微小波动和噪声的敏感性，相当于对不同来源的图像强制执行了一个共同的灰度标尺。因此，灰度离散化是一种关键的**数据协调**步骤，它以牺牲部分灰度分辨率为代价，换取了跨设备、跨时间、跨患者比较时特征的鲁棒性和[可复现性](@entry_id:151299)。

#### ROI边界处理：避免信息“泄露”

当在一个分割出的感兴趣区域（ROI）内计算NGTDM时，靠近ROI边界的像素其部分邻域可能会落在ROI之外。如何处理这些“界外”邻居是一个重要问题。

最符合原则的做法是**仅使用ROI内部的邻居**来计算邻域平均值 $\bar{I}_k$ [@problem_id:4565923]。这是因为[纹理分析](@entry_id:202600)的目标是表征ROI内部的生物学特性。如果将ROI外部（可能代表不同组织或背景）的像素包含进来，就会发生信息“泄露”。

假设ROI内部组织的平均灰度为 $\mu_R$，而外部为 $\mu_O$，且 $\mu_O \neq \mu_R$。对于一个边界像素，如果其邻域计算包含了外部像素，那么其邻域平均值 $\bar{I}_k$ 就会被系统性地拉向 $\mu_O$。这导致 $\bar{I}_k$ 与中心像素的[期望值](@entry_id:150961) $\mu_R$ 之间产生了一个人为的偏差。这个偏差会不真实地增大 $|I_k - \bar{I}_k|$ 的值，从而使计算出的 $s_i$ 值被高估。这种由ROI边界处理不当引入的偏差会污染纹理特征，使其不再纯粹反映ROI内部的纹理，而是反映了其与周围环境的边界对比度。因此，严格限制邻域在ROI内部是保证测量纯粹性的必要条件。

#### 各向异性体素与物理空间邻域

在三维医学成像中，体素（voxel）在三个维度上的物理尺寸（即体素间距）常常是不相等的，这被称为**各向异性**。例如，一张CT图像的层内分辨率可能是 $0.5 \times 0.5$ mm，而层间距可能是 $2.5$ mm。

在这种情况下，如果在**索引空间**（即体素坐标的整数网格）中定义邻域（例如，一个 $3 \times 3 \times 3$ 的体素立方体），这个邻域在**物理空间**中实际上是一个被拉伸的长方体（$1.5 \times 1.5 \times 7.5$ mm）。这严重扭曲了邻域的物理意义，从而破坏了诸如“粗糙度”等特征的物理解释，因为它们本应反映物理尺度上的纹理变化 [@problem_id:4565998]。

为了解决这个问题，有两种主要策略：
1.  **在物理空间中定义邻域**：直接根据物理距离（例如，毫米）来选择邻居。例如，定义邻域为“[中心体](@entry_id:163165)素周围1.5毫米半径球内的所有其他体素”。这样可以确保邻域在物理上是各向同性的，从而保留了纹理特征的物理意义。这是更具原则性的方法。
2.  **图像[重采样](@entry_id:142583)**：在计算纹理特征之前，先将原始的各向异性图像通过插值算法**[重采样](@entry_id:142583)**成具有各向同性体素（例如，$1 \times 1 \times 1$ mm）的新图像。在[重采样](@entry_id:142583)后的图像上，索引空间和物理空间的几何形状变得一致，此时就可以安全地使用基于索引空间的邻域定义了。

忽略体素的各向异性是三维[纹理分析](@entry_id:202600)中一个常见的错误来源，它会损害特征的稳定性和跨研究的可比性。因此，正确处理体素间距是获得有意义和可复现的NGTDM特征的关键步骤之一。