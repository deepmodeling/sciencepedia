{"hands_on_practices": [{"introduction": "在任何显微分析中，了解所观察区域的大小是基础的第一步。本练习将演示如何直接根据显微镜的规格——物镜放大倍率和目镜的视场数（Field Number）——来计算这个区域，即样本视场（Field of View）。通过从基本原理出发，您将深入理解这些关键部件如何共同决定了您的视野范围 [@problem_id:5234273]。", "problem": "在用于实验室诊断的明场显微镜中，目镜的视场数（FN）定义为能够无遮挡地通过目镜视场光阑的中间像的直径（单位为毫米），而物镜放大倍率则定义为中间像的线性尺寸与相应样品区域线性尺寸之比。考虑一台配置了科勒照明的无限远校正显微镜，其配备了视场数为 $\\mathrm{FN} = 22\\ \\mathrm{mm}$ 的目镜和一个 $20\\times$ 的物镜。从这些核心定义和基础几何光学出发，推导样品平面视场（FOV）直径关于 $\\mathrm{FN}$ 和物镜放大倍率的表达式，然后计算其在该显微镜下的数值。结合科勒照明下的几何成像和共轭平面，简要解释视场光阑如何限制照明区域以减少视场边缘的渐晕。将最终的数值直径以微米表示，并将答案四舍五入至 $3$ 位有效数字。", "solution": "推导始于与明场显微镜成像光路相关的两个核心定义：\n\n1. 视场数（FN）是能够通过目镜视场光阑的中间像的直径：如果中间像的直径为 $D_{\\mathrm{intermediate}}$，那么其无渐晕的最大值为 $D_{\\mathrm{intermediate}} = \\mathrm{FN}$。\n\n2. 物镜放大倍率 $M_{o}$ 定义为样品平面和中间像平面之间的线性放大率：\n$$\nM_{o} = \\frac{D_{\\mathrm{intermediate}}}{D_{\\mathrm{spec}}},\n$$\n其中 $D_{\\mathrm{spec}}$ 是样品平面上对应的直径。\n\n通过对最大可用视场（由视场光阑设定）的放大率定义进行重新排列，我们得到：\n$$\nD_{\\mathrm{spec}} = \\frac{D_{\\mathrm{intermediate}}}{M_{o}} = \\frac{\\mathrm{FN}}{M_{o}}.\n$$\n该关系是基础几何光学的结果，并且不依赖于目镜的放大倍率，因为目镜视场光阑定义了中间像的直径，而目镜不会改变该共轭平面上的线性尺寸。\n\n对于给定的显微镜，$\\mathrm{FN} = 22\\ \\mathrm{mm}$ 且 $M_{o} = 20$。代入得，\n$$\nD_{\\mathrm{spec}} = \\frac{22\\ \\mathrm{mm}}{20} = 1.1\\ \\mathrm{mm}.\n$$\n将毫米转换为微米，\n$$\n1.1\\ \\mathrm{mm} = 1.1 \\times 10^{3}\\ \\mu\\mathrm{m}.\n$$\n四舍五入至 $3$ 位有效数字，\n$$\nD_{\\mathrm{spec}} = 1.10 \\times 10^{3}\\ \\mu\\mathrm{m}.\n$$\n\n视场光阑在限制渐晕中的作用：在科勒照明下，视场光阑位于通过聚光镜与样品平面共轭的平面上。它的像在样品平面上形成，从而界定了照明视场。当轴外光线或视场（FOV）边缘的视场点被物镜的入瞳或后续的视场光阑部分阻挡时，会产生渐晕，导致亮度衰减。通过收小视场光阑，使其在样品平面上的像恰好内切于物镜所成的视场（即照明区域与 $D_{\\mathrm{spec}}$ 相匹配），系统可以确保只有对成像视场有贡献的光线被发出，从而减少离轴杂散光并防止在周边过度填充物镜的入瞳。从定量上讲，避免渐晕的条件是，由聚光镜在样品平面上形成的视场光阑的像，在通过物镜中继到中间像时，其直径不超过目镜视场光阑所允许的直径；等效地，将视场光阑设置为与计算出的 $D_{\\mathrm{spec}}$ 相匹配，可确保照明视场不会产生在光瞳或视场光阑处被拦截的光线，从而限制渐晕并改善边缘均匀性。", "answer": "$$\\boxed{1.10 \\times 10^{3}}$$", "id": "5234273"}, {"introduction": "虽然显微镜可以放大物体，但其揭示精细细节的能力从根本上受到光的物理性质的限制，这一概念被称为分辨率。本练习要求您超越简单的公式，运用波动光学的原理来确定分辨特定结构所需的最小数值孔径（$NA$） [@problem_id:5234304]。这个过程将阐明照明光的波长（$\\lambda$）和物镜的光线收集能力在定义明场显微镜最终性能方面所起的关键作用。", "problem": "一家诊断组织学实验室计划在绿色照明下使用明场显微镜来解析薄切片中精细的周期性染色图案。切片呈现出空间周期为 $d=300\\ \\mathrm{nm}$ 的正弦振幅调制，显微镜在标准科勒照明下采用中心波长为 $\\lambda=520\\ \\mathrm{nm}$ 的窄带绿色滤光片。基于波动光学的基本原理和明场成像的衍射受限行为，确定传输与此周期对应的空间频率所需的最小物镜数值孔径（NA），假设光学系统无像差，且样品在相关空间频率下提供振幅衬度。最终答案表示为一个四舍五入到四位有效数字的无量纲数。此外，请解释即使达到了计算出的物镜NA，也可能妨碍实现此分辨率的实际明场限制，包括照明、聚光镜、样本和检测方面的考虑，且在问题陈述中不援引任何捷径公式。", "solution": "该问题要求确定在明场显微镜中解析周期性结构所需的最小物镜数值孔径（$\\text{NA}$）。显微镜的分辨率从根本上受衍射的限制。阿贝成像理论假定，要解析物体的结构，物镜不仅必须收集未衍射（0级）的光，还必须收集由样本产生的至少一个一级衍射光束。这些被捕获的光束在像平面上的干涉重建了该结构的图像。\n\n设样本为一个空间周期为 $d$ 的一维周期性结构。在本例中，$d = 300\\ \\mathrm{nm}$。该结构充当衍射光栅。照明由中心波长为 $\\lambda = 520\\ \\mathrm{nm}$ 的窄带光源提供。\n\n问题指明了科勒照明，这意味着样本由一束平面波锥照明，入射角范围从 $0$ 到一个最大角 $\\alpha_c$，该角度由聚光镜的数值孔径 $\\text{NA}_c = n_i \\sin(\\alpha_c)$ 定义，其中 $n_i$ 是聚光镜和样本之间介质的折射率。\n\n让我们考虑对分辨率最有利的情况，即涉及来自聚光镜的最倾斜的照明光线，以角度 $\\alpha_c$ 入射。这条光线在未经衍射地穿过样本后，成为此照明角度的0级光束，并以同样的角度 $\\alpha_c$ 进入物镜。\n\n该入射光线与周期为 $d$ 的周期性结构相互作用，产生一组衍射光束，其角度 $\\theta_m$ 由斜入射的透射光栅方程决定：\n$$d(\\sin(\\theta_m) - \\sin(\\alpha_c)) = m\\lambda$$\n其中 $m$ 是表示衍射级数的整数（$m = 0, \\pm 1, \\pm 2, \\dots$）。\n\n要形成周期性结构的图像，物镜必须收集至少两束光。最邻近的两束光是0级（$m=0$）和其中一个一级（例如，$m=-1$）。0级光束以角度 $\\theta_0 = \\alpha_c$ 传播。-1级光束以角度 $\\theta_{-1}$ 传播，由下式给出：\n$$d(\\sin(\\theta_{-1}) - \\sin(\\alpha_c)) = -1 \\cdot \\lambda$$\n解出 $\\sin(\\theta_{-1})$ 得到：\n$$\\sin(\\theta_{-1}) = \\sin(\\alpha_c) - \\frac{\\lambda}{d}$$\n\n物镜的数值孔径为 $\\text{NA}_o = n_i \\sin(\\alpha_o)$，其中 $\\alpha_o$ 是物镜可以接收的光锥半角。要使两束光都被收集，它们必须都落入此接收锥内。在分辨率的极限情况下，0级光束在物镜孔径的一侧边缘被收集，而-1级光束在相对的边缘被收集。\n收集0级光束的条件是其入射角在物镜的接收锥内，即 $\\alpha_c \\le \\alpha_o$。\n收集-1级光束的条件是其角度 $\\theta_{-1}$ 也在接收锥内。收集此光束的极限情况发生在其以孔径的最边缘角度 $-\\alpha_o$ 进入时。因此，条件是 $\\theta_{-1} \\ge -\\alpha_o$，这意味着 $\\sin(\\theta_{-1}) \\ge -\\sin(\\alpha_o)$。\n\n将 $\\sin(\\theta_{-1})$ 的表达式代入此不等式，我们得到：\n$$\\sin(\\alpha_c) - \\frac{\\lambda}{d} \\ge -\\sin(\\alpha_o)$$\n整理后得到分辨率的基本条件：\n$$\\sin(\\alpha_o) + \\sin(\\alpha_c) \\ge \\frac{\\lambda}{d}$$\n乘以折射率 $n_i$（假设聚光镜和物镜使用相同的浸液介质，这是标准做法）将角度转换为数值孔径：\n$$\\text{NA}_o + \\text{NA}_c \\ge \\frac{\\lambda}{d}$$\n这个方程表明，显微镜的分辨能力取决于物镜和聚光镜数值孔径之和。\n\n问题要求解析该结构所需的*最小*物镜NA，即 $\\text{NA}_o$。为使给定 $d$ 和 $\\lambda$ 的 $\\text{NA}_o$ 最小化，必须最大化来自聚光镜的贡献 $\\text{NA}_c$。$\\text{NA}_c$ 的最大有效值等于 $\\text{NA}_o$，因为大于物镜NA的聚光镜NA会用物镜无法收集的光照射样品，导致杂散光和衬度降低，而不会提高分辨率。因此，最大化分辨率的最佳设置是设定 $\\text{NA}_c = \\text{NA}_o$。\n\n将 $\\text{NA}_c = \\text{NA}_o$ 代入分辨率不等式得到：\n$$\\text{NA}_o + \\text{NA}_o \\ge \\frac{\\lambda}{d}$$\n$$2\\text{NA}_o \\ge \\frac{\\lambda}{d}$$\n因此，所需的最小物镜NA为：\n$$\\text{NA}_{o, \\text{min}} = \\frac{\\lambda}{2d}$$\n使用给定的值，$\\lambda = 520\\ \\mathrm{nm}$ 和 $d = 300\\ \\mathrm{nm}$：\n$$\\text{NA}_{o, \\text{min}} = \\frac{520\\ \\mathrm{nm}}{2 \\times 300\\ \\mathrm{nm}} = \\frac{520}{600} = \\frac{52}{60} = \\frac{13}{15}$$\n数值上，这是 $13 \\div 15 \\approx 0.86666...$。四舍五入到四位有效数字，所需的最小NA为 $0.8667$。具有此NA的物镜通常是油浸物镜。\n\n除了对物镜NA的理论要求外，一些实际限制可能会妨碍达到此分辨率：\n\n1.  **照明与聚光镜：** 该计算假设了最佳的聚光镜设置，即 $\\text{NA}_c = \\text{NA}_o$。实际上，操作者常常会“缩小”聚光镜孔径光阑，从而减小 $\\text{NA}_c$。虽然这会增加图像衬度和景深，但会降低分辨能力，正如控制方程 $d_{\\text{min}} = \\lambda / (\\text{NA}_o + \\text{NA}_c)$ 所示。如果 $\\text{NA}_c  \\text{NA}_o$，最小可分辨周期 $d_{\\text{min}}$ 会增大。此外，在科勒照明中，聚光镜组件的不正确聚焦或对中会导致不均匀照明，无法提供实现理论分辨率极限所需的明确定义的光锥。\n\n2.  **样本属性：** 问题假设样本提供足够的振幅衬度。许多生物样本是相位物体，这意味着它们改变的是透射光的相位，而不是其振幅。明场显微镜对相位变化的灵敏度非常差。即使经过染色，如果产生的振幅调制很弱，衍射级的强度也会非常低。最终的图像衬度可能不足以使图案被视觉感知或检测到，即使光学系统在技术上“解析”了它。此外，推导假设了一个薄的二维光栅。真实的组织学切片具有有限的厚度。光在厚的三维结构中散射和传播更为复杂，会降低完美图像重建所需的相干性。载玻片、封固剂、盖玻片和浸液之间的折射率不匹配会引入严重的球面像差，特别是对于对这些参数极其敏感的高NA物镜。\n\n3.  **物镜与系统像差：** 计算假设了“无像差光学系统”。现实世界中的物镜，即使是高端的复消色差物镜，也存在残余光学像差（例如，球差、彗差、像散、色差）。特别是球差，会阻止衍射波前聚焦到一个点上，从而使图像模糊并降低有效分辨率。如果“窄带”滤光片具有不可忽略的带宽，色差也可能成为一个因素，导致不同波长分量聚焦在略微不同的平面上。\n\n4.  **检测系统：** 解析出的光学图像必须由探测器（数码相机或人眼）进行采样。奈奎斯特-香农采样定理规定，探测器的空间采样频率必须至少是图像中最高空间频率的两倍。对于数码相机而言，这意味着投影回物平面的像素尺寸最多必须是被解析特征周期的一半。如果放大倍率为 $M$，像素尺寸为 $p$，我们需要满足 $p/M \\le d/2$。如果像素太大，图像将被欠采样，精细图案将丢失或产生混叠。最后，任何探测器都有有限的信噪比（SNR）。如果解析图案的衬度非常低（如第2点所讨论），其信号可能会被探测器的电子噪声所淹没，使其无法被检测到。", "answer": "$$\\boxed{0.8667}$$", "id": "5234304"}, {"introduction": "现代显微技术早已超越了定性观察，能够直接从图像中进行精确的定量测量。这项高级练习将指导您完成计算分析的过程，展示如何应用比尔-朗伯定律（Beer-Lambert law）对数字图像中的颜色进行“解混”，以确定不同染料的相对浓度 [@problem_id:5234320]。通过建立并求解一个线性方程组，您将学习一种在数字病理学中广泛应用的强大技术，它能将染色的组织图像转化为定量的生化数据。", "problem": "你的任务是推导并实现一种有理论依据的算法，用于根据明场显微镜的通道测量值来估计染色浓度比。其科学背景是使用一台红、绿、蓝（RGB）相机对染色的组织学切片进行透射模式成像，该相机的各通道具有已知的光谱响应度。推导必须以 Beer–Lambert 定律和透射光的吸光度定义为出发点。假设独立的染料对光衰减的贡献是可加的，并且通道的光谱响应度可以通过适当的光谱平均整合到有效衰减系数中。仅从这些基础出发，推导一个通过线性解混将测量的通道强度映射到染色浓度比的计算流程。\n\n你的推导必须：\n- 从透射强度的 Beer-Lambert 定律以及吸光度是透射率的负自然对数的定义开始。\n- 在散射可忽略和检测器响应线性的假设下，论证多种独立染料的吸光度具有可加性。\n- 展示通道光谱响应度如何导出可用于线性模型中的各通道有效衰减系数。\n- 建立一个连接通道吸光度与染料浓度的线性系统，并指明在通道数多于染料数时如何求解该系统。\n\n然后，在一个程序中实现所推导的方法，该程序为每个测试用例计算第一种染料浓度与第二种染料浓度的比值（浮点数）。该比值为无量纲，且必须四舍五入到五位小数。\n\n所有测试用例的定义和假设：\n- 设 $I_{c}$ 为通道 $c \\in \\{R,G,B\\}$ 中测得的强度， $I_{0,c}$ 为同一通道中未染色区域的参考强度。所有强度都是无量纲的，并已归一化到 $[0,1]$ 范围内。\n- 设 $L$ 为切片厚度，单位为米（m）。\n- 设 $\\kappa_{c,i}$ 为通道 $c$ 和染料 $i$ 的有效衰减系数，单位为 $\\mathrm{m}^2/\\mathrm{mol}$，通过将染料的摩尔吸光系数对通道的光谱响应度进行积分得到。有两种染料，索引为 $i \\in \\{1,2\\}$。\n- 浓度 $C_i$ 的单位为 $\\mathrm{mol}/\\mathrm{m}^3$。每个测试用例的期望输出是比值 $r = C_1 / C_2$，该值为无量纲。\n\n测试套件（四个用例）。对于每个用例，给定 $I_{R}$、$I_{G}$、$I_{B}$、$I_{0,R}$、$I_{0,G}$、$I_{0,B}$、$L$ 以及 $\\kappa_{c,i}$ 值矩阵（按行 $c \\in \\{R,G,B\\}$ 和列 $i \\in \\{1,2\\}$ 排列）：\n\n- 用例1（良态，中等吸光度）：\n  - $I_{R} = 0.45$, $I_{G} = 0.55$, $I_{B} = 0.80$。\n  - $I_{0,R} = 1.00$, $I_{0,G} = 1.00$, $I_{0,B} = 1.00$。\n  - $L = 5\\times 10^{-6}\\ \\mathrm{m}$。\n  - $\\kappa = \\begin{bmatrix}\n  0.30  1.10 \\\\\n  0.50  0.80 \\\\\n  1.20  0.20\n  \\end{bmatrix}\\ \\mathrm{m}^2/\\mathrm{mol}$。\n\n- 用例2（近共线性系数；病态条件压力测试）：\n  - $I_{R} = 0.50$, $I_{G} = 0.60$, $I_{B} = 0.70$。\n  - $I_{0,R} = 1.00$, $I_{0,G} = 1.00$, $I_{0,B} = 1.00$。\n  - $L = 4\\times 10^{-6}\\ \\mathrm{m}$。\n  - $\\kappa = \\begin{bmatrix}\n  0.80  1.62 \\\\\n  0.60  1.19 \\\\\n  0.40  0.79\n  \\end{bmatrix}\\ \\mathrm{m}^2/\\mathrm{mol}$。\n\n- 用例3（低吸光度；近全透射）：\n  - $I_{R} = 0.95$, $I_{G} = 0.90$, $I_{B} = 0.85$。\n  - $I_{0,R} = 1.00$, $I_{0,G} = 1.00$, $I_{0,B} = 1.00$。\n  - $L = 6\\times 10^{-6}\\ \\mathrm{m}$。\n  - $\\kappa = \\begin{bmatrix}\n  0.30  1.10 \\\\\n  0.50  0.80 \\\\\n  1.20  0.20\n  \\end{bmatrix}\\ \\mathrm{m}^2/\\mathrm{mol}$。\n\n- 用例4（R和G通道高吸光度）：\n  - $I_{R} = 0.10$, $I_{G} = 0.15$, $I_{B} = 0.50$。\n  - $I_{0,R} = 1.00$, $I_{0,G} = 1.00$, $I_{0,B} = 1.00$。\n  - $L = 5\\times 10^{-6}\\ \\mathrm{m}$。\n  - $\\kappa = \\begin{bmatrix}\n  0.30  1.10 \\\\\n  0.50  0.80 \\\\\n  1.20  0.20\n  \\end{bmatrix}\\ \\mathrm{m}^2/\\mathrm{mol}$。\n\n算法要求：\n- 使用自然对数。\n- 使用有效系数和厚度，为每个用例建立连接通道吸光度与染料浓度的线性系统。\n- 使用由你的推导所论证的有理论依据的方法（例如，用于最小二乘估计的 Moore–Penrose 伪逆）求解该超定线性系统，以获得 $C_1$ 和 $C_2$。\n- 计算每个用例的 $r = C_1 / C_2$ 并四舍五入到五位小数。\n\n你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如 $[r_1,r_2,r_3,r_4]$），其中每个 $r_k$ 是用例 $k$ 经四舍五入后的浮点数结果，不含任何其他文本。不涉及角度。为清晰起见，所提供的所有物理量均已注明单位；输出的比值为无量纲。", "solution": "估计染料浓度比的算法推导过程，始于指定的光吸收基本原理。\n\nBeer-Lambert 定律描述了光穿过吸收介质时的衰减。对于在特定波长 $\\lambda$ 的单一吸收物质（染料）$i$，透射强度 $I(\\lambda)$ 与入射强度 $I_0(\\lambda)$ 的关系如下：\n$$\nI(\\lambda) = I_0(\\lambda) \\exp(-\\epsilon_i(\\lambda) C_i L)\n$$\n此处，$\\epsilon_i(\\lambda)$ 是染料 $i$ 在波长 $\\lambda$ 处的摩尔吸光系数（单位如 $\\mathrm{m}^2/\\mathrm{mol}$），$C_i$ 是其摩尔浓度（单位为 $\\mathrm{mol}/\\mathrm{m}^3$），$L$ 是光通过样本的光程长度（单位为 $\\mathrm{m}$）。\n\n透射率 $T(\\lambda)$ 是指穿过样本的光的分数，定义为 $T(\\lambda) = I(\\lambda) / I_0(\\lambda)$。吸光度 $A(\\lambda)$ 定义为透射率的负自然对数：\n$$\nA(\\lambda) = -\\ln(T(\\lambda)) = -\\ln\\left(\\frac{I(\\lambda)}{I_0(\\lambda)}\\right)\n$$\n将 Beer-Lambert 定律代入吸光度的定义，可得出吸光度与浓度和光程长度乘积之间的线性关系：\n$$\nA(\\lambda) = -\\ln\\left(\\exp(-\\epsilon_i(\\lambda) C_i L)\\right) = \\epsilon_i(\\lambda) C_i L\n$$\n在染料独立不相互作用且散射可忽略的假设下，它们对吸光度的贡献是可加的。对于 $N$ 种染料的混合物，在波长 $\\lambda$ 的总吸光度是各染料吸光度的总和：\n$$\nA_{\\text{total}}(\\lambda) = \\sum_{i=1}^{N} A_i(\\lambda) = \\left(\\sum_{i=1}^{N} \\epsilon_i(\\lambda) C_i\\right) L\n$$\n在实践中，数码相机并非测量单一波长的强度，而是在由通道光谱响应度 $S_c(\\lambda)$ 定义的光谱带上进行积分。通道 $c \\in \\{R,G,B\\}$ 中测得的强度为：\n$$\nI_c = \\int S_c(\\lambda) I_0(\\lambda) \\exp\\left(-L \\sum_{i=1}^{N} \\epsilon_i(\\lambda, i) C_i\\right) d\\lambda\n$$\n对于未染色区域（所有 $i$ 的 $C_i=0$），相应的参考强度为 $I_{0,c} = \\int S_c(\\lambda) I_0(\\lambda) d\\lambda$。特定于通道的吸光度为 $A_c = -\\ln(I_c / I_{0,c})$。\n直接使用这种积分形式很复杂。该问题通过引入有效衰减系数 $\\kappa_{c,i}$ 提供了一种标准且强大的简化方法。该方法通过假设通道吸光度可以近似为浓度的线性组合，从而将关系线性化：\n$$\nA_c \\approx L \\sum_{i=1}^{N} \\kappa_{c,i} C_i\n$$\n系数 $\\kappa_{c,i}$ 代表通道 $c$ 所“看到”的染料 $i$ 的光谱平均吸光系数。我们假设这种线性近似是有效的。\n\n基于此线性模型，我们可以建立一个线性方程组。对于本问题，我们有 3 个通道（R, G, B）和 2 种染料（1, 2）。该系统为：\n$$\nA_R = L(\\kappa_{R,1} C_1 + \\kappa_{R,2} C_2) \\\\\nA_G = L(\\kappa_{G,1} C_1 + \\kappa_{G,2} C_2) \\\\\nA_B = L(\\kappa_{B,1} C_1 + \\kappa_{B,2} C_2)\n$$\n其中通道吸光度 $A_c$ 由测量的强度计算得出：$A_c = -\\ln(I_c / I_{0,c})$。\n\n该系统可以表示为矩阵形式。设 $\\mathbf{A}$ 为通道吸光度的列向量，$\\mathbf{K}$ 为有效衰减系数矩阵，$\\mathbf{C}$ 为染料浓度的列向量：\n$$\n\\mathbf{A} = \\begin{pmatrix} A_R \\\\ A_G \\\\ A_B \\end{pmatrix}, \\quad\n\\mathbf{K} = \\begin{pmatrix} \\kappa_{R,1}  \\kappa_{R,2} \\\\ \\kappa_{G,1}  \\kappa_{G,2} \\\\ \\kappa_{B,1}  \\kappa_{B,2} \\end{pmatrix}, \\quad\n\\mathbf{C} = \\begin{pmatrix} C_1 \\\\ C_2 \\end{pmatrix}\n$$\n方程组变为：\n$$\n\\mathbf{A} = L \\cdot \\mathbf{K} \\cdot \\mathbf{C}\n$$\n为求解 $\\mathbf{C}$，我们首先整理方程：\n$$\n\\frac{1}{L}\\mathbf{A} = \\mathbf{K}\\mathbf{C}\n$$\n这是一个超定系统，因为方程数量（3个）多于未知数数量（2个）。在存在测量噪声或建模不准确的情况下，可能不存在精确解。因此，我们寻求一个在最小二乘意义上使误差最小化的解。我们希望找到向量 $\\mathbf{C}$，以最小化残差向量的欧几里得范数平方，即 $\\| \\mathbf{K}\\mathbf{C} - \\frac{1}{L}\\mathbf{A} \\|^2$。\n\n此线性最小二乘问题的解由正规方程给出：\n$$\n(\\mathbf{K}^T \\mathbf{K}) \\mathbf{C} = \\mathbf{K}^T \\left(\\frac{1}{L}\\mathbf{A}\\right)\n$$\n假设 $\\mathbf{K}$ 的列是线性无关的（即，染料具有不同的光谱特征），则矩阵 $\\mathbf{K}^T \\mathbf{K}$ 是可逆的。$\\mathbf{C}$ 的解则为：\n$$\n\\mathbf{C} = (\\mathbf{K}^T \\mathbf{K})^{-1} \\mathbf{K}^T \\left(\\frac{1}{L}\\mathbf{A}\\right)\n$$\n矩阵 $(\\mathbf{K}^T \\mathbf{K})^{-1} \\mathbf{K}^T$ 被称为 $\\mathbf{K}$ 的 Moore–Penrose 伪逆，记作 $\\mathbf{K}^+$。在数值计算上，直接使用如 QR 分解或奇异值分解（SVD）等方法求解最小二乘问题，比显式计算伪逆更稳定。\n\n每个测试用例的计算流程如下：\n1.  构建测量强度向量 $\\mathbf{I} = [I_R, I_G, I_B]^T$ 和参考强度向量 $\\mathbf{I_0} = [I_{0,R}, I_{0,G}, I_{0,B}]^T$。\n2.  计算吸光度向量 $\\mathbf{A}$，其中每个元素为 $A_c = -\\ln(I_c / I_{0,c})$。\n3.  定义最小二乘问题的目标向量为 $\\mathbf{b} = \\mathbf{A} / L$。\n4.  使用给定的有效衰减系数矩阵 $\\mathbf{K}$，求解线性最小二乘系统 $\\mathbf{K}\\mathbf{C} = \\mathbf{b}$，以得到浓度向量 $\\mathbf{C} = [C_1, C_2]^T$。\n5.  计算期望的比值 $r = C_1 / C_2$。\n6.  将结果四舍五入到五位小数。\n该流程将对每个提供的测试用例进行实现。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives stain concentration ratios from brightfield microscopy measurements\n    based on the Beer-Lambert law and linear unmixing.\n    \"\"\"\n\n    # Test suite provided in the problem statement.\n    # Each case is a dictionary containing all necessary parameters.\n    test_cases = [\n        {\n            \"I\": np.array([0.45, 0.55, 0.80]),\n            \"I0\": np.array([1.00, 1.00, 1.00]),\n            \"L\": 5e-6,\n            \"kappa\": np.array([\n                [0.30, 1.10],\n                [0.50, 0.80],\n                [1.20, 0.20]\n            ])\n        },\n        {\n            \"I\": np.array([0.50, 0.60, 0.70]),\n            \"I0\": np.array([1.00, 1.00, 1.00]),\n            \"L\": 4e-6,\n            \"kappa\": np.array([\n                [0.80, 1.62],\n                [0.60, 1.19],\n                [0.40, 0.79]\n            ])\n        },\n        {\n            \"I\": np.array([0.95, 0.90, 0.85]),\n            \"I0\": np.array([1.00, 1.00, 1.00]),\n            \"L\": 6e-6,\n            \"kappa\": np.array([\n                [0.30, 1.10],\n                [0.50, 0.80],\n                [1.20, 0.20]\n            ])\n        },\n        {\n            \"I\": np.array([0.10, 0.15, 0.50]),\n            \"I0\": np.array([1.00, 1.00, 1.00]),\n            \"L\": 5e-6,\n            \"kappa\": np.array([\n                [0.30, 1.10],\n                [0.50, 0.80],\n                [1.20, 0.20]\n            ])\n        }\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        I_vec = case[\"I\"]\n        I0_vec = case[\"I0\"]\n        L = case[\"L\"]\n        K_mat = case[\"kappa\"]\n\n        # Step 1  2: Calculate the absorbance vector from measured intensities.\n        # A_c = -ln(I_c / I_0c)\n        # np.log is the natural logarithm.\n        transmittance = I_vec / I0_vec\n        # To avoid log(0) for saturated pixels, though not present in test cases.\n        transmittance = np.maximum(transmittance, 1e-10)\n        A_vec = -np.log(transmittance)\n\n        # Step 3: Formulate the target vector for the linear system.\n        # b = A / L\n        b_vec = A_vec / L\n\n        # Step 4: Solve the overdetermined linear system KC = b for C\n        # using a least-squares solver. np.linalg.lstsq is a robust choice\n        # that uses SVD and handles potential ill-conditioning.\n        # It solves argmin_C ||b - KC||_2.\n        # The first element of the returned tuple is the solution vector C.\n        C_vec = np.linalg.lstsq(K_mat, b_vec, rcond=None)[0]\n        \n        C1, C2 = C_vec[0], C_vec[1]\n\n        # Step 5: Compute the ratio of the concentrations.\n        # Check for division by zero, although not expected with these test cases.\n        if abs(C2)  1e-9:\n            # Handle the case where C2 is effectively zero.\n            # Depending on context, this could be infinity or an error.\n            # For this problem, it's not expected. If it occurred, the ratio would be undefined.\n            # We will assume C2 is non-zero as per a well-posed problem setup.\n            ratio = np.inf\n        else:\n            ratio = C1 / C2\n\n        # Step 6: Round the result to five decimal places.\n        rounded_ratio = round(ratio, 5)\n        results.append(rounded_ratio)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "5234320"}]}