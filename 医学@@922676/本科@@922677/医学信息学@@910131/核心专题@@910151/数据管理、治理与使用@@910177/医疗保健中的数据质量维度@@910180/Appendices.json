{"hands_on_practices": [{"introduction": "在进行任何复杂的分析之前，我们必须首先检查数据中是否存在基本的逻辑错误。时间数据，例如医院的入院和出院日期，特别容易出现此类错误。本练习提供了一种编程方法，用于检测和量化这些基本但关键的数据质量问题，例如不可能的时间线和重叠的住院事件，从而确保数据的时间合理性与一致性 [@problem_id:4833782]。", "problem": "给定一组源自电子健康记录 (EHR) 数据的患者级别住院时间线，表示为自某一固定原点以来以天为单位计量的入院和出院时间点列表。目标是通过编程方式检测对基本时间合理性和患者内部一致性约束的违反情况，并量化这些违反的比率。\n\n基本核心定义：\n- 一次住院事件的时间合理性要求出院时间不早于入院时间。形式上，对于一次入院时间为 $t_a$、出院时间为 $t_d$ 的住院事件，合理性要求 $t_d \\ge t_a$。\n- 住院期间的患者内部一致性要求单个患者不能有重叠的住院事件。将每次住院建模为一个半开区间 $[t_a, t_d)$，同一患者的两次住院 $(t_{a,i}, t_{d,i})$ 和 $(t_{a,j}, t_{d,j})$ 发生重叠的充要条件是 $\\max(t_{a,i}, t_{a,j})  \\min(t_{d,i}, t_{d,j})$。在边界处相等，即 $\\max(t_{a,i}, t_{a,j}) = \\min(t_{d,i}, t_{d,j})$，表示相邻而非重叠。\n\n需要计算的目标违规项：\n- 出院早于入院的违规：计算 $t_d  t_a$ 的住院事件数量。\n- 重叠的住院事件：在有效住院事件（即 $t_d \\ge t_a$ 的事件）中，按患者计算如上定义的重叠住院事件对的数量。\n\n要求的比率：\n- 记录级别的出院早于入院比率 $R_1$：出院早于入院的违规数量 $V_1$ 与总住院事件数 $N$ 的比值，即 $R_1 = V_1 / N$。\n- 事件对级别的重叠比率 $R_2$：所有患者中重叠的有效住院事件对总数 $V_2$ 与可比较的有效住院事件对总数 $T$ 的比值，即 $R_2 = V_2 / T$。如果 $T = 0$，则定义 $R_2 = 0$。\n- 患者级别的重叠普遍率 $R_{2p}$：至少有一对重叠有效住院事件的患者数量 $P_{\\text{over}}$ 与总患者数 $P$ 的比值，即 $R_{2p} = P_{\\text{over}} / P$。\n\n单位与度量：\n- 所有时间点必须视为以天为单位的实数。不涉及角度测量。所有比率均表示为保留6位小数的小数。\n\n测试套件：\n使用以下四个测试用例，每个用例指定为患者列表，其中每个患者是住院事件的列表，每个住院事件是一个以天为单位的配对 $(t_a, t_d)$。区间被解释为 $[t_a, t_d)$。\n- 测试用例 1 (通用“理想路径”)：\n  - 患者 1: $(1, 3)$, $(3, 5)$。\n  - 患者 2: $(10, 12)$。\n  - 患者 3: $(20, 25)$, $(24, 26)$, $(30, 31)$。\n- 测试用例 2 (包含出院早于入院和重叠)：\n  - 患者 1: $(5, 4)$, $(7, 9)$。\n  - 患者 2: $(0, 10)$, $(2, 8)$。\n  - 患者 3: $(10, 12)$, $(12, 14)$。\n- 测试用例 3 (零可比较对的边界情况)：\n  - 患者 1: $(3, 2)$。\n  - 患者 2: $(0, 1)$。\n  - 患者 3: $(5, 4)$。\n- 测试用例 4 (边界条件与多重重叠)：\n  - 患者 1: $(1, 3)$, $(3, 5)$, $(2, 4)$。\n  - 患者 2: $(10, 12)$, $(10, 12)$。\n  - 患者 3: $(20, 20)$。\n\n程序要求：\n- 实现一个程序，对于每个测试用例，完全按照上述定义计算 $R_1$、$R_2$ 和 $R_{2p}$，并且在计算与重叠相关的量时仅使用有效住院事件。\n- 将每个测试用例的所有三个比率表示为保留6位小数的小数。\n- 最终输出格式：您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，顺序为 $[R_1^{(1)}, R_2^{(1)}, R_{2p}^{(1)}, R_1^{(2)}, R_2^{(2)}, R_{2p}^{(2)}, R_1^{(3)}, R_2^{(3)}, R_{2p}^{(3)}, R_1^{(4)}, R_2^{(4)}, R_{2p}^{(4)}]$，其中上标表示从1到4的测试用例索引。", "solution": "问题陈述已经过分析并被确定为有效。它在医学信息学领域，特别是在数据质量评估方面，具有科学依据。所提供的定义在数学上是精确且内部一致的，构成了一个良构的计算问题。目标清晰，没有歧义或主观性。\n\n任务是根据电子健康记录 (EHR) 数据的患者时间线计算三个特定的数据质量比率。我们将基于所提供的定义来形式化该流程。\n\n一次住院事件由一对时间点 $(t_a, t_d)$ 表示，其中 $t_a$ 是入院时间，$t_d$ 是出院时间。该住院事件对应于半开区间 $[t_a, t_d)$。一个患者记录是此类住院事件的列表。一个测试用例是患者记录的列表。\n\n需要计算的三个比率是：\n1.  记录级别的出院早于入院比率，$R_1$。\n2.  事件对级别的重叠比率，$R_2$。\n3.  患者级别的重叠普遍率，$R_{2p}$。\n\n让我们为这些比率定义必要的量。\n\n**1. 时间合理性与比率 $R_1$**\n\n如果出院时间不早于入院时间，则住院事件 $(t_a, t_d)$ 被认为是时间上合理的。\n$$\n\\text{合理性条件: } t_d \\ge t_a\n$$\n如果 $t_d  t_a$，则发生违规。设 $V_1$ 为一个测试用例中所有住院事件中此类违规的总数。设 $N$ 为所有患者的总住院事件数。比率 $R_1$ 定义为：\n$$\nR_1 = \\frac{V_1}{N}\n$$\n如果 $N=0$，我们定义 $R_1=0$。\n\n**2. 患者内部一致性与比率 $R_2$ 和 $R_{2p}$**\n\n这些比率涉及单个患者的重叠住院事件。分析仅限于*有效*住院事件，即满足合理性条件 $t_d \\ge t_a$ 的事件。\n\n对于给定的患者，如果两个不同的有效住院事件 $(t_{a,i}, t_{d,i})$ 和 $(t_{a,j}, t_{d,j})$ 对应的时间区间 $[t_{a,i}, t_{d,i})$ 和 $[t_{a,j}, t_{d,j})$ 存在非空交集，则定义它们为重叠。这被形式化地表示为：\n$$\n\\text{重叠条件: } \\max(t_{a,i}, t_{a,j})  \\min(t_{d,i}, t_{d,j})\n$$\n请注意，相邻情况，即 $\\max(t_{a,i}, t_{a,j}) = \\min(t_{d,i}, t_{d,j})$，不构成重叠。\n\n为了计算比率 $R_2$ 和 $R_{2p}$，我们为给定的测试用例定义以下量：\n-   $P$：总患者数。\n-   $k_p$：患者 $p$ 的有效住院事件数。\n-   $T$：可比较的有效住院事件对的总数。一个拥有 $k_p$ 个有效住院事件的患者贡献 $\\binom{k_p}{2} = \\frac{k_p(k_p-1)}{2}$ 对。因此，$T = \\sum_{p=1}^{P} \\binom{k_p}{2}$。\n-   $V_2$：所有患者中重叠的有效住院事件对的总数。\n-   $P_{\\text{over}}$：至少有一对重叠有效住院事件的患者数量。\n\n比率 $R_2$ 是重叠对与可比较对的比值：\n$$\nR_2 = \\frac{V_2}{T}\n$$\n根据定义，如果 $T=0$，则 $R_2=0$。\n\n比率 $R_{2p}$ 是存在与重叠相关的数据质量问题的患者比例：\n$$\nR_{2p} = \\frac{P_{\\text{over}}}{P}\n$$\n如果 $P=0$，我们定义 $R_{2p}=0$。\n\n**算法流程**\n\n对于每个测试用例，我们执行以下步骤：\n1.  初始化计数器：$V_1 = 0$，$N = 0$，$V_2 = 0$，$T = 0$，$P_{\\text{over}} = 0$，并将 $P$ 设为测试用例中的总患者数。\n2.  遍历测试用例中的每个患者。\n3.  对于每个患者，将其住院事件划分为一个 `valid_stays`（有效住院事件，$t_d \\ge t_a$）列表，并计算无效住院事件（$t_d  t_a$）的数量。每有一个无效住院事件，就将 $V_1$ 加一。将该患者的总住院事件数加到 $N$ 中。\n4.  对于当前患者，令 $k_p$ 为 `valid_stays` 中的住院事件数。将 $\\binom{k_p}{2}$ 加到总数 $T$ 中。\n5.  如果 $k_p \\ge 2$，则遍历 `valid_stays` 中所有唯一的住院事件对。对于每一对，使用条件 $\\max(t_{a,i}, t_{a,j})  \\min(t_{d,i}, t_{d,j})$ 检查是否重叠。\n6.  计算当前患者的重叠对数量。设其为 `patient_overlap_count`。将此计数加到总数 $V_2$ 中。\n7.  如果 `patient_overlap_count` > 0，则将 $P_{\\text{over}}$ 加一。\n8.  遍历完所有患者后，使用各自的公式计算最终比率 $R_1$、$R_2$ 和 $R_{2p}$。确保按规定处理除以零的情况。\n9.  将每个比率四舍五入到6位小数。\n\n**示例演练：测试用例 1**\n\n-   数据：患者 1: $(1, 3), (3, 5)$；患者 2: $(10, 12)$；患者 3: $(20, 25), (24, 26), (30, 31)$。\n-   总患者数 $P = 3$。\n-   总住院事件数 $N = 2 + 1 + 3 = 6$。\n\n**步骤 1：合理性检查 ($R_1$)**\n-   检查所有住院事件：$3 \\ge 1$, $5 \\ge 3$, $12 \\ge 10$, $25 \\ge 20$, $26 \\ge 24$, $31 \\ge 30$。所有事件均有效。\n-   $V_1 = 0$。\n-   $R_1 = V_1 / N = 0 / 6 = 0.0$。\n\n**步骤 2：重叠分析 ($R_2$, $R_{2p}$)**\n-   **患者 1:** 有效住院事件：`[(1, 3), (3, 5)]`。$k_1 = 2$。\n    -   可比较对数：$\\binom{2}{2} = 1$。\n    -   检查 $((1, 3), (3, 5))$ 的重叠：$\\max(1, 3) = 3$，$\\min(3, 5) = 3$。条件 $3  3$ 为假。无重叠。\n-   **患者 2:** 有效住院事件：`[(10, 12)]`。$k_2 = 1$。\n    -   可比较对数：$\\binom{1}{2} = 0$。没有可检查的对。\n-   **患者 3:** 有效住院事件：`[(20, 25), (24, 26), (30, 31)]`。$k_3 = 3$。\n    -   可比较对数：$\\binom{3}{2} = 3$。\n    -   对 $((20, 25), (24, 26))$：$\\max(20, 24) = 24$，$\\min(25, 26) = 25$。条件 $24  25$ 为真。发现重叠。\n    -   对 $((20, 25), (30, 31))$：$\\max(20, 30) = 30$，$\\min(25, 31) = 25$。条件 $30  25$ 为假。无重叠。\n    -   对 $((24, 26), (30, 31))$：$\\max(24, 30) = 30$，$\\min(26, 31) = 26$。条件 $30  26$ 为假。无重叠。\n    -   患者 3 有 1 个重叠对。由于此值 $>0$，我们将此患者计入 $P_{\\text{over}}$。\n\n**步骤 3：汇总和计算比率**\n-   可比较对总数 $T = \\binom{2}{2} + \\binom{1}{2} + \\binom{3}{2} = 1 + 0 + 3 = 4$。\n-   重叠对总数 $V_2 = 0 (\\text{患者1}) + 0 (\\text{患者2}) + 1 (\\text{患者3}) = 1$。\n-   有重叠的患者总数 $P_{\\text{over}} = 1$ (患者 3)。\n-   $R_2 = V_2 / T = 1 / 4 = 0.25$。\n-   $R_{2p} = P_{\\text{over}} / P = 1 / 3 \\approx 0.333333$。\n\n测试用例 1 的最终比率为 $(0.0, 0.25, 0.333333...)$。其余测试用例以相同方式处理。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom itertools import combinations\nimport math\n\ndef solve():\n    \"\"\"\n    Computes data quality violation rates for EHR inpatient timelines.\n    \"\"\"\n    test_cases = [\n        # Test case 1\n        [\n            [(1, 3), (3, 5)],\n            [(10, 12)],\n            [(20, 25), (24, 26), (30, 31)]\n        ],\n        # Test case 2\n        [\n            [(5, 4), (7, 9)],\n            [(0, 10), (2, 8)],\n            [(10, 12), (12, 14)]\n        ],\n        # Test case 3\n        [\n            [(3, 2)],\n            [(0, 1)],\n            [(5, 4)]\n        ],\n        # Test case 4\n        [\n            [(1, 3), (3, 5), (2, 4)],\n            [(10, 12), (10, 12)],\n            [(20, 20)]\n        ]\n    ]\n\n    all_results = []\n\n    for case_data in test_cases:\n        # Initialize counters for the current test case\n        total_stays_n = 0\n        discharge_before_admission_v1 = 0\n        total_comparable_pairs_t = 0\n        overlapping_pairs_v2 = 0\n        patients_with_overlap_p_over = 0\n        total_patients_p = len(case_data)\n\n        for patient_stays in case_data:\n            total_stays_n += len(patient_stays)\n            \n            valid_stays = []\n            for stay in patient_stays:\n                t_a, t_d = stay\n                if t_d  t_a:\n                    discharge_before_admission_v1 += 1\n                else:\n                    valid_stays.append(stay)\n\n            k_p = len(valid_stays)\n            patient_comparable_pairs = math.comb(k_p, 2)\n            total_comparable_pairs_t += patient_comparable_pairs\n\n            if patient_comparable_pairs > 0:\n                patient_overlap_count = 0\n                for stay1, stay2 in combinations(valid_stays, 2):\n                    t_a1, t_d1 = stay1\n                    t_a2, t_d2 = stay2\n                    \n                    # Overlap condition: max(ta,i, ta,j)  min(td,i, td,j)\n                    if max(t_a1, t_a2)  min(t_d1, t_d2):\n                        patient_overlap_count += 1\n                \n                if patient_overlap_count > 0:\n                    patients_with_overlap_p_over += 1\n                    overlapping_pairs_v2 += patient_overlap_count\n\n        # Calculate rates\n        # R1: Record-level discharge-before-admission rate\n        r1 = (discharge_before_admission_v1 / total_stays_n) if total_stays_n > 0 else 0.0\n\n        # R2: Pair-level overlap rate\n        r2 = (overlapping_pairs_v2 / total_comparable_pairs_t) if total_comparable_pairs_t > 0 else 0.0\n\n        # R2p: Patient-level overlap prevalence\n        r2p = (patients_with_overlap_p_over / total_patients_p) if total_patients_p > 0 else 0.0\n        \n        all_results.extend([r1, r2, r2p])\n\n    # Format the final output string\n    formatted_results = [f\"{res:.6f}\" for res in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "4833782"}, {"introduction": "在确保了数据的基本逻辑一致性之后，下一步是评估数据生成过程本身的可靠性，特别是当它涉及人类判断时。从临床笔记中提取信息是一项常见但主观的任务。本练习介绍了 Cohen's $\\kappa$ 系数，这是一种标准的统计度量，用于量化不同编码员执行此任务的可靠性程度，这对于信任最终生成的数据至关重要 [@problem_id:4833853]。", "problem": "一家医院正在评估从电子健康记录（EHR）临床笔记中提取吸烟状况的可靠性这一数据质量维度。两名临床编码员独立地为每位患者分配四个名义类别中的一个：当前吸烟者 (Current)、既往吸烟者 (Former)、从不吸烟者 (Never) 或未知 (Unknown)。在一个包含 $300$ 名患者的队列中，联合分类结果如下：\n\n- 在编码员 A 标记为“当前吸烟者”的患者中，编码员 B 标记为：“当前吸烟者” $55$ 人，“既往吸烟者” $7$ 人，“从不吸烟者” $6$ 人，“未知” $2$ 人。\n- 在编码员 A 标记为“既往吸烟者”的患者中，编码员 B 标记为：“当前吸烟者” $6$ 人，“既往吸烟者” $75$ 人，“从不吸烟者” $7$ 人，“未知” $2$ 人。\n- 在编码员 A 标记为“从不吸烟者”的患者中，编码员 B 标记为：“当前吸烟者” $4$ 人，“既往吸烟者” $12$ 人，“从不吸烟者” $100$ 人，“未知” $4$ 人。\n- 在编码员 A 标记为“未知”的患者中，编码员 B 标记为：“当前吸烟者” $0$ 人，“既往吸烟者” $1$ 人，“从不吸烟者” $4$ 人，“未知” $15$ 人。\n\n仅使用名义类别评估者间信度的基本定义——该定义在给定评估者边际标签分布的情况下，通过偶然性预期的一致性来调整观察到的一致性——计算这两位编码员的 Cohen's $\\kappa$ 系数。报告结果时，应使用一个无量纲数，并四舍五入到四位有效数字。您的最终答案必须是一个实数。", "solution": "在医疗保健信息提取任务中，可靠性这一数据质量维度量化了不同观察者之间测量的一致性。对于名义类别，广泛使用的、经过机会校正的评估者间信度系数是 Cohen's $\\kappa$，其基本原理定义为超出偶然性的一致性比例，并通过可能达到的超出偶然性的最大一致性进行归一化。设 $P_{o}$ 表示观察到的一致性比例，设 $P_{e}$ 表示在每个编码员的边际标签分布独立的条件下偶然性预期的一致性。该系数为\n$$\n\\kappa \\;=\\; \\frac{P_{o} - P_{e}}{1 - P_{e}}.\n$$\n\n步骤 $1$：从列联表的对角线计算 $P_{o}$。对角线上的计数为：当前吸烟者-当前吸烟者 $55$ 人，既往吸烟者-既往吸烟者 $75$ 人，从不吸烟者-从不吸烟者 $100$ 人，未知-未知 $15$ 人。患者总数为 $300$。因此\n$$\nP_{o} \\;=\\; \\frac{55 + 75 + 100 + 15}{300} \\;=\\; \\frac{245}{300} \\;=\\; \\frac{49}{60}.\n$$\n\n步骤 $2$：从边际分布的乘积计算 $P_{e}$。首先，计算行（编码员 A）的总计：\n- 当前吸烟者 (Current): $55 + 7 + 6 + 2 = 70$，\n- 既往吸烟者 (Former): $6 + 75 + 7 + 2 = 90$，\n- 从不吸烟者 (Never): $4 + 12 + 100 + 4 = 120$，\n- 未知 (Unknown): $0 + 1 + 4 + 15 = 20$。\n\n然后，计算列（编码员 B）的总计：\n- 当前吸烟者 (Current): $55 + 6 + 4 + 0 = 65$，\n- 既往吸烟者 (Former): $7 + 75 + 12 + 1 = 95$，\n- 从不吸烟者 (Never): $6 + 7 + 100 + 4 = 117$，\n- 未知 (Unknown): $2 + 2 + 4 + 15 = 23$。\n\n每个边际比例是相应的总数除以 $300$。因此，\n$$\nP_{e} \\;=\\; \\sum_{\\text{categories}} \\left(\\frac{\\text{row total}}{300}\\right)\\!\\left(\\frac{\\text{column total}}{300}\\right)\n\\;=\\; \\frac{70 \\cdot 65 + 90 \\cdot 95 + 120 \\cdot 117 + 20 \\cdot 23}{300^{2}}.\n$$\n计算分子：\n$$\n70 \\cdot 65 = 4550,\\quad 90 \\cdot 95 = 8550,\\quad 120 \\cdot 117 = 14040,\\quad 20 \\cdot 23 = 460,\n$$\n所以总和为\n$$\n4550 + 8550 + 14040 + 460 = 27600.\n$$\n因此\n$$\nP_{e} \\;=\\; \\frac{27600}{90000} \\;=\\; \\frac{23}{75}.\n$$\n\n步骤 $3$：计算 $\\kappa$：\n$$\n\\kappa \\;=\\; \\frac{P_{o} - P_{e}}{1 - P_{e}} \\;=\\; \\frac{\\frac{49}{60} - \\frac{23}{75}}{1 - \\frac{23}{75}}.\n$$\n简化分子：\n$$\n\\frac{49}{60} - \\frac{23}{75} \\;=\\; \\frac{245}{300} - \\frac{92}{300} \\;=\\; \\frac{153}{300} \\;=\\; \\frac{51}{100}.\n$$\n简化分母：\n$$\n1 - \\frac{23}{75} \\;=\\; \\frac{52}{75}.\n$$\n因此，\n$$\n\\kappa \\;=\\; \\frac{\\frac{51}{100}}{\\frac{52}{75}} \\;=\\; \\frac{51}{100} \\cdot \\frac{75}{52} \\;=\\; \\frac{153}{208}.\n$$\n换算成小数，\n$$\n\\kappa \\approx 0.735576923.\n$$\n四舍五入到四位有效数字，\n$$\n\\kappa \\approx 0.7356.\n$$\n\n临床应用解释：根据常用的定性指导原则（例如，Landis 和 Koch 的量表），$0.61$ 到 $0.80$ 范围内的 $\\kappa$ 值通常被描述为“实质性”一致，而 $\\geq 0.81$ 的值则被描述为“几乎完美”一致。因此，$\\kappa \\approx 0.7356$ 表明吸烟状况提取具有实质性的评估者间信度。这对于临床部署是否足够，取决于具体应用的风险承受能力；高风险决策支持系统通常要求 $\\kappa$ 值接近或超过 $0.80$。", "answer": "$$\\boxed{0.7356}$$", "id": "4833853"}, {"introduction": "当我们对数据的内部逻辑和可靠性有了信心后，我们常常面临整合来自不同系统信息的挑战。本练习探讨了概率性记录链接这一复杂问题，即使在标识符不完美的情况下，我们也必须判断来自两个不同数据表的记录是否指向同一患者。它展示了如何运用统计证据和决策理论来做出最优的链接决策，这是构建综合性患者视图的基石 [@problem_id:4833794]。", "problem": "一家医院计划将其检验信息系统表与入院登记表进行链接，以改善护理协调和数据分析。为遵循数据质量维度——特别是准确性、一致性和完整性——链接将使用三个准标识符进行：姓氏、出生日期（DOB）和住宅邮政编码。假设在概率性记录链接的设定下，给定真实匹配状态，每个字段的一致性是条件独立的。对于一个候选对，我们将每个字段的“$m$-概率”定义为在真实匹配的情况下该字段一致的概率，将“$u$-概率”定义为在非匹配的情况下该字段一致的概率。以下是从历史验证链接中根据经验估计得出的值：\n- 姓氏：$m_{\\text{L}} = 0.97$，$u_{\\text{L}} = 0.02$。\n- 出生日期（DOB）：$m_{\\text{D}} = 0.995$，$u_{\\text{D}} = \\frac{1}{365}$。\n- 邮政编码：$m_{\\text{Z}} = 0.90$，$u_{\\text{Z}} = 0.10$。\n\n假设经过分块处理后，候选对的先验匹配概率为 $p = 0.02$。该医院使用一种决策理论规则来最小化期望损失，其中错误匹配（即链接了两个不同的患者）的成本为 $C_{\\text{FP}} = 80$，漏匹配（即未能链接同一患者）的成本为 $C_{\\text{FN}} = 5$。在独立模型下，一致字段的似然比为比率 $m_{i}/u_{i}$，不一致字段的似然比为 $(1 - m_{i})/(1 - u_{i})$。\n\n考虑两个候选对：\n- 对A：姓氏、出生日期和邮政编码均一致。\n- 对B：姓氏和出生日期一致，但邮政编码不一致。\n\n任务：\n1. 计算对A和对B为真实匹配的后验概率。\n2. 在给定的成本和先验概率 $p$ 下，推导能最小化期望损失的最优似然比阈值。\n3. 在独立性假设和给定的 $u$-概率下，当将此阈值应用于所有候选对时，估计期望的错误匹配率（以小数形式表示）。\n\n将每个数值结果四舍五入到四位有效数字。所有概率均以小数（而非百分比）表示。请按以下顺序提供您的最终答案：对A的后验概率，对B的后验概率，最优阈值，估计的错误匹配率。", "solution": "用户提供的问题已经过验证，被认为是有效的。它在科学上基于已建立的概率性记录链接的Fellegi-Sunter模型，这是医疗信息学和统计学中的一种标准方法。该问题是适定的，提供了唯一解所需的所有必要参数、定义和假设（如条件独立性）。语言客观，数据内部一致。\n\n根据题目要求，解答分为三个部分。\n\n### 1. 对A和对B的匹配后验概率\n\n给定一个一致性模式 $\\gamma$，匹配 $M$ 的后验概率，记为 $P(M|\\gamma)$，可以使用贝叶斯定理以优势比（odds）的形式来计算。匹配的后验优势比是先验优势比与观察到的一致性模式的似然比（LR）的乘积。\n\n给定的先验匹配概率为 $p = 0.02$。非匹配的先验概率为 $P(U) = 1 - p = 1 - 0.02 = 0.98$。\n匹配的先验优势比为：\n$$ O_{\\text{prior}} = \\frac{P(M)}{P(U)} = \\frac{p}{1-p} = \\frac{0.02}{0.98} = \\frac{1}{49} $$\n\n由于条件独立性假设，一个一致性模式 $\\gamma = (\\gamma_L, \\gamma_D, \\gamma_Z)$ 的似然比是每个字段似然比的乘积：\n$$ L(\\gamma) = L_L(\\gamma_L) \\cdot L_D(\\gamma_D) \\cdot L_Z(\\gamma_Z) $$\n其中，一致字段 $i$ 的似然比是 $m_i/u_i$，不一致字段的似然比是 $(1-m_i)/(1-u_i)$。\n\n后验优势比为 $O_{\\text{post}}(\\gamma) = L(\\gamma) \\cdot O_{\\text{prior}}$。\n然后可以从后验优势比中恢复后验概率：\n$$ P(M|\\gamma) = \\frac{O_{\\text{post}}(\\gamma)}{1 + O_{\\text{post}}(\\gamma)} $$\n\n首先，我们计算一致和不一致的单个似然比。\n- 姓氏（L）：\n  - 一致性似然比：$L_L(1) = \\frac{m_L}{u_L} = \\frac{0.97}{0.02} = 48.5$\n- 出生日期（D）：\n  - 一致性似然比：$L_D(1) = \\frac{m_D}{u_D} = \\frac{0.995}{1/365} = 0.995 \\times 365 = 363.175$\n- 邮政编码（Z）：\n  - 一致性似然比：$L_Z(1) = \\frac{m_Z}{u_Z} = \\frac{0.90}{0.10} = 9.0$\n  - 不一致性似然比：$L_Z(0) = \\frac{1-m_Z}{1-u_Z} = \\frac{1-0.90}{1-0.10} = \\frac{0.10}{0.90} = \\frac{1}{9}$\n\n**对于对A（姓氏、出生日期和邮政编码均一致）：**\n一致性模式为 $\\gamma_A = (1, 1, 1)$。\n总似然比为：\n$$ L(\\gamma_A) = L_L(1) \\cdot L_D(1) \\cdot L_Z(1) = 48.5 \\times 363.175 \\times 9.0 = 158302.5375 $$\n对A的后验优势比为：\n$$ O_{\\text{post}}(\\gamma_A) = 158302.5375 \\times \\frac{1}{49} \\approx 3230.66403 $$\n对A的后验概率为：\n$$ P(M|\\gamma_A) = \\frac{3230.66403}{1 + 3230.66403} \\approx 0.99969055 $$\n四舍五入到四位有效数字，对A的后验概率为 $0.9997$。\n\n**对于对B（姓氏和出生日期一致，邮政编码不一致）：**\n一致性模式为 $\\gamma_B = (1, 1, 0)$。\n总似然比为：\n$$ L(\\gamma_B) = L_L(1) \\cdot L_D(1) \\cdot L_Z(0) = 48.5 \\times 363.175 \\times \\frac{1}{9} \\approx 1957.12083 $$\n对B的后验优势比为：\n$$ O_{\\text{post}}(\\gamma_B) = 1957.12083 \\times \\frac{1}{49} \\approx 39.9412415 $$\n对B的后验概率为：\n$$ P(M|\\gamma_B) = \\frac{39.9412415}{1 + 39.9412415} \\approx 0.9755749 $$\n四舍五入到四位有效数字，对B的后验概率为 $0.9756$。\n\n### 2. 最优似然比阈值\n\n决策规则是最小化期望损失。如果判定为匹配的期望损失小于判定为非匹配的期望损失，则该对被判定为匹配。\n设 $C_{\\text{FP}} = 80$ 为错误匹配的成本，$C_{\\text{FN}} = 5$ 为漏匹配的成本。\n- 判定为‘匹配’的期望损失：$E[\\text{loss}|\\text{declare M}] = P(U|\\gamma) \\cdot C_{\\text{FP}} = (1 - P(M|\\gamma)) \\cdot C_{\\text{FP}}$\n- 判定为‘非匹配’的期望损失：$E[\\text{loss}|\\text{declare NM}] = P(M|\\gamma) \\cdot C_{\\text{FN}}$\n\n当满足以下条件时判定为匹配：\n$$ (1 - P(M|\\gamma)) \\cdot C_{\\text{FP}}  P(M|\\gamma) \\cdot C_{\\text{FN}} $$\n$$ C_{\\text{FP}}  P(M|\\gamma) \\cdot (C_{\\text{FP}} + C_{\\text{FN}}) $$\n这给出了后验概率的一个阈值：\n$$ P(M|\\gamma) > \\frac{C_{\\text{FP}}}{C_{\\text{FP}} + C_{\\text{FN}}} $$\n为了找到似然比阈值 $T_{LR}$，我们代入 $P(M|\\gamma) = \\frac{L(\\gamma)O_{\\text{prior}}}{1+L(\\gamma)O_{\\text{prior}}}$：\n$$ \\frac{L(\\gamma)O_{\\text{prior}}}{1+L(\\gamma)O_{\\text{prior}}} > \\frac{C_{\\text{FP}}}{C_{\\text{FP}} + C_{\\text{FN}}} $$\n求解 $L(\\gamma)$：\n$$ L(\\gamma) > \\frac{C_{\\text{FP}}}{C_{\\text{FN}}} \\cdot \\frac{1}{O_{\\text{prior}}} = \\frac{C_{\\text{FP}}}{C_{\\text{FN}}} \\cdot \\frac{1-p}{p} $$\n因此，最优似然比阈值 $T_{LR}$ 为：\n$$ T_{LR} = \\frac{C_{\\text{FP}}}{C_{\\text{FN}}} \\cdot \\frac{1-p}{p} = \\frac{80}{5} \\cdot \\frac{0.98}{0.02} = 16 \\times 49 = 784 $$\n最优阈值恰好是 $784$。为了表示为四位有效数字，我们写作 $784.0$。\n\n### 3. 估计的错误匹配率\n\n错误匹配率（或假阳性率，FPR）是指一个非匹配对被错误地判定为匹配的概率。这即是 $P(\\text{declare match}|U)$。如果给定候选对的一致性模式的似然比 $L(\\gamma)$ 超过阈值 $T_{LR} = 784$，则判定为匹配。\n\n我们必须评估 $2^3 = 8$ 种可能的一致性模式中，哪几种的似然比会大于 $784$。\n姓氏和出生日期均一致的似然比是 $L_L(1) \\times L_D(1) = 48.5 \\times 363.175 = 17614.0875$。由于这个值远大于 $784$，任何在这两个字段上都一致的模式，其似然比都将高于阈值，无论邮政编码的结果如何。\n- 对于L、D和Z均一致（模式 (1,1,1)）：$L(\\gamma) = 17614.0875 \\times 9 \\approx 158527$，大于 $784$。\n- 对于L和D一致，但Z不一致（模式 (1,1,0)）：$L(\\gamma) = 17614.0875 \\times (1/9) \\approx 1957$，大于 $784$。\n\n现在考虑是否有其他模式超过阈值。次高的似然比来自于D和Z一致，但L不一致。L不一致的似然比是 $L_L(0) = \\frac{1-0.97}{1-0.02} = \\frac{0.03}{0.98} \\approx 0.0306$。\n- 对于L不一致，但D和Z一致（模式 (0,1,1)）：$L(\\gamma) \\approx 0.0306 \\times 363.175 \\times 9 \\approx 100$，小于 $784$。\n所有其他模式的似然比都将更低。\n\n因此，当且仅当姓氏和出生日期都一致时，一对记录才被判定为匹配。错误匹配率是在非匹配对（$U$）中发生这种情况的概率：\n$$ \\text{FPR} = P(\\gamma_L=1, \\gamma_D=1 | U) $$\n使用非匹配情况下的条件独立性假设：\n$$ \\text{FPR} = P(\\gamma_L=1|U) \\cdot P(\\gamma_D=1|U) = u_L \\cdot u_D $$\n代入给定值：\n$$ \\text{FPR} = 0.02 \\times \\frac{1}{365} = \\frac{0.02}{365} \\approx 0.0000547945 $$\n四舍五入到四位有效数字，估计的错误匹配率为 $0.00005479$。\n\n最终答案，四舍五入到四位有效数字，为：\n- 对A的后验概率：$0.9997$\n- 对B的后验概率：$0.9756$\n- 最优阈值：$784.0$\n- 估计的错误匹配率：$0.00005479$", "answer": "$$ \\boxed{\n\\begin{pmatrix}\n0.9997  0.9756  784.0  0.00005479\n\\end{pmatrix}\n} $$", "id": "4833794"}]}