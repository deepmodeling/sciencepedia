{"hands_on_practices": [{"introduction": "数据溯源不仅仅是对历史事件的被动记录，它更是一种强大的分析与优化工具。通过将审计追踪视为一个结构化的活动图，我们可以深入洞察复杂的流程。第一个练习将挑战你分析一个典型医疗数据管道的溯源数据，以计算其总运行时间并识别其关键路径，这展示了审计追踪在运营智能中的一个基本应用。[@problem_id:4833565]", "problem": "一个医院联合体维护着一个电子健康记录（EHR）分析仓库，该仓库由一个夜间运行的提取-转换-加载（ETL）管道提供数据。数据溯源系统将每次运行的审计追踪记录为一系列活动，这些活动具有持续时间，并在一个有向无环图（DAG）中捕获了明确的先后顺序约束。可审计性的目标是追踪集成数据集的生成过程，并量化管道的端到端延迟，以用于运营规划。\n\n考虑一次在时间 $t = 0$ 分钟时由一个摄取请求事件开始的单次运行。下面列出了ETL活动及其持续时间（单位：分钟）和它们的先后顺序约束（一个活动只有在其所有前置活动都完成后才能开始）。假设并行执行资源无限，且编排开销可忽略不计，因此任何符合条件的活动在其先决条件满足时即可立即开始。\n\n活动：\n- $A$：从 $X$ 医院提取结构化EHR数据，持续时间 $14$；前置活动：无。\n- $B$：从 $Y$ 医院提取非结构化临床笔记，持续时间 $9$；前置活动：无。\n- $C$：将临床代码标准化为逻辑观察标识符名称和代码（Logical Observation Identifiers Names and Codes, LOINC）和医学临床术语系统命名法（Systematized Nomenclature of Medicine Clinical Terms, SNOMED CT），持续时间 $22$；前置活动：$A$。\n- $D$：对笔记进行自然语言处理以识别诊断，持续时间 $27$；前置活动：$B$。\n- $E$：根据主患者索引进行患者身份解析，持续时间 $20$；前置活动：$C$，$D$。\n- $F$：数据质量验证检查，持续时间 $12$；前置活动：$C$。\n- $G$：为研究队列创建报告快照，持续时间 $15$；前置活动：$E$，$F$。\n- $H$：将集成数据加载到分析仓库中，持续时间 $8$；前置活动：$G$。\n\n仅使用审计追踪中记录的持续时间和先后顺序约束，根据有先后顺序约束的调度的基本原理，推导出管道最早可能的完成时间，并确定决定此延迟的关键路径。以分钟为单位表示总的端到端延迟。提供最终延迟为一个精确的整数；无需四舍五入。", "solution": "该问题要求计算ETL管道的最早完成时间并确定关键路径。我们可以通过计算每个活动的最早开始时间（ES）和最早完成时间（EF）来解决此问题。\n\n**基本原理：**\n- 对于一个没有前置活动的活动 $X$，其最早开始时间 $ES_X = 0$。\n- 对于一个有前置活动集合 $\\{P_i\\}$ 的活动 $X$，其最早开始时间 $ES_X = \\max(\\{EF_{P_i}\\})$。\n- 活动 $X$ 的最早完成时间 $EF_X = ES_X + d_X$，其中 $d_X$ 是其持续时间。\n- 管道的总完成时间是最后一个活动的最早完成时间。\n- 关键路径是图中总持续时间最长的路径，其长度等于管道的总完成时间。\n\n**分步计算：**\n设各活动的持续时间为 $d_A=14, d_B=9, d_C=22, d_D=27, d_E=20, d_F=12, d_G=15, d_H=8$。\n\n1.  **活动 A 和 B (没有前置活动):**\n    -   $ES_A = 0 \\implies EF_A = 0 + 14 = 14$\n    -   $ES_B = 0 \\implies EF_B = 0 + 9 = 9$\n\n2.  **活动 C, D, F (依赖单个前置活动):**\n    -   $C$ 依赖于 $A$: $ES_C = EF_A = 14 \\implies EF_C = 14 + 22 = 36$\n    -   $D$ 依赖于 $B$: $ES_D = EF_B = 9 \\implies EF_D = 9 + 27 = 36$\n    -   $F$ 依赖于 $C$: $ES_F = EF_C = 36 \\implies EF_F = 36 + 12 = 48$\n\n3.  **活动 E 和 G (依赖多个前置活动):**\n    -   $E$ 依赖于 $C$ 和 $D$: $ES_E = \\max(EF_C, EF_D) = \\max(36, 36) = 36 \\implies EF_E = 36 + 20 = 56$\n    -   $G$ 依赖于 $E$ 和 $F$: $ES_G = \\max(EF_E, EF_F) = \\max(56, 48) = 56 \\implies EF_G = 56 + 15 = 71$\n\n4.  **活动 H (最终活动):**\n    -   $H$ 依赖于 $G$: $ES_H = EF_G = 71 \\implies EF_H = 71 + 8 = 79$\n\n管道的最早完成时间是 $79$ 分钟。\n\n**确定关键路径：**\n关键路径是导致总时间达到 $79$ 分钟的活动序列。我们可以通过回溯来找到它：\n-   $H$ 的开始时间由 $G$ 决定 ($ES_H = EF_G = 71$)。\n-   $G$ 的开始时间由 $E$ 决定 ($ES_G = EF_E = 56$)。\n-   $E$ 的开始时间由 $C$ 和 $D$ 共同决定 ($ES_E = \\max(EF_C, EF_D) = 36$)。\n-   $C$ 的开始时间由 $A$ 决定 ($ES_C = EF_A = 14$)。\n-   $D$ 的开始时间由 $B$ 决定 ($ES_D = EF_B = 9$)。\n\n因此，有两条路径的长度（活动持续时间之和）等于管道的总延迟：\n-   路径 1: $A \\to C \\to E \\to G \\to H$。总延迟 = $14 + 22 + 20 + 15 + 8 = 79$ 分钟。\n-   路径 2: $B \\to D \\to E \\to G \\to H$。总延迟 = $9 + 27 + 20 + 15 + 8 = 79$ 分钟。\n\n两条路径都是关键路径。总的端到端延迟为 $79$ 分钟。", "answer": "$$\\boxed{79}$$", "id": "4833565"}, {"introduction": "尽管全面的审计追踪在问责和分析方面提供了巨大价值，但它们也带来了严峻的运营挑战，其中最主要的是存储。本练习将从溯源的“为何做”转向“如何做”，让你解决一个真实的容量规划问题。你将计算医院电子健康记录系统多年的存储需求，并确定数据生命周期策略，将抽象的合规目标转化为具体的基础设施指标。[@problem_id:4833570]", "problem": "一家三级医院为其电子健康记录 (EHR) 系统维护全面的审计追踪。每个审计事件都会捕获数据溯源信息，包括谁在何时、依据何种授权修改了哪条记录，以及加密完整性证据。该医院每天生成 $R$ 个审计事件，并且必须将其保留 $T$ 年，以满足与《健康保险流通与责任法案》(HIPAA) 的治理目标相一致的内部政策。每个事件存储的内容包括一个 $s_{\\text{payload}}$ 字节的负载、 $s_{\\text{metadata}}$ 字节的溯源元数据、一个 $s_{\\text{sig}}$ 字节的数字签名以及一个 $s_{\\text{header}}$ 字节的报头。一个二级索引会额外消耗相当于每个事件总内容 $f_{\\text{index}}$ 的空间。\n\n假设该医院有以下经验观察参数：\n- 每日事件速率：$R = 4.5 \\times 10^{6}$ 事件/天。\n- 保留期限：$T = 7$ 年。\n- 平均每个事件的组成部分：$s_{\\text{payload}} = 180$ 字节， $s_{\\text{metadata}} = 110$ 字节， $s_{\\text{sig}} = 64$ 字节， $s_{\\text{header}} = 18$ 字节。\n- 索引开销：$f_{\\text{index}} = 0.15$ (无量纲)。\n- 使用民用时间近似 $365.25$ 天/年。\n\n此外，为指导热存储层和冷存储层之间的轮换策略，假设审计查询的年龄（自目标事件发生以来的时间）服从速率为 $\\lambda$ (单位：天$^{-1}$) 的指数分布，其中 $\\lambda = 0.08$。热存储层的大小必须能够保留最近 $D_{\\text{hot}}$ 天的事件，以便至少 $0.95$ 的审计查询由热存储层提供服务。\n\n仅从速率、随时间变化的总量、字节大小聚合以及指数分布性质的基本定义出发，计算：\n1. 保留所有审计事件 $T$ 年所需的总存储空间，以太字节 (TB) 为单位表示，其中 $1\\,\\text{TB} = 10^{12}$ 字节。\n2. 最小热存储层保留期限 $D_{\\text{hot}}$ (以天为单位)，使得审计查询目标事件的年龄不超过 $D_{\\text{hot}}$ 的概率至少为 $0.95$。\n\n将两个数值结果都四舍五入到四位有效数字。以两个值的形式提供你的最终答案：总存储空间 (TB) 和 $D_{\\text{hot}}$ (天)。", "solution": "### 第 1 部分：总存储需求\n\n1.  **计算单个事件的原始大小 ($S_{\\text{event}}$):**\n    将所有组成部分的大小相加。\n    $$S_{\\text{event}} = s_{\\text{payload}} + s_{\\text{metadata}} + s_{\\text{sig}} + s_{\\text{header}}$$\n    $$S_{\\text{event}} = 180 + 110 + 64 + 18 = 372\\,\\text{字节}$$\n\n2.  **计算单个事件包含索引的总大小 ($S_{\\text{total\\_per\\_event}}$):**\n    在原始大小的基础上增加索引开销。\n    $$S_{\\text{total\\_per\\_event}} = S_{\\text{event}} \\times (1 + f_{\\text{index}})$$\n    $$S_{\\text{total\\_per\\_event}} = 372 \\times (1 + 0.15) = 372 \\times 1.15 = 427.8\\,\\text{字节}$$\n\n3.  **计算每日生成的总存储量 ($S_{\\text{day}}$):**\n    将每日事件速率与每个事件的总大小相乘。\n    $$S_{\\text{day}} = R \\times S_{\\text{total\\_per\\_event}}$$\n    $$S_{\\text{day}} = (4.5 \\times 10^{6}) \\times 427.8 = 1.9251 \\times 10^{9}\\,\\text{字节/天}$$\n\n4.  **计算总保留天数 ($N_{\\text{days}}$):**\n    将保留年限转换为天数。\n    $$N_{\\text{days}} = T \\times 365.25 = 7 \\times 365.25 = 2556.75\\,\\text{天}$$\n\n5.  **计算总存储空间 ($S_{\\text{total}}$):**\n    将每日存储量与总保留天数相乘，然后转换为太字节 (TB)。\n    $$S_{\\text{total}} = S_{\\text{day}} \\times N_{\\text{days}} = (1.9251 \\times 10^{9}) \\times 2556.75 \\approx 4.9219 \\times 10^{12}\\,\\text{字节}$$\n    $$S_{\\text{total, TB}} = \\frac{4.9219 \\times 10^{12}}{10^{12}} = 4.9219\\,\\text{TB}$$\n    四舍五入到四位有效数字，总存储需求为 **4.922 TB**。\n\n### 第 2 部分：最小热存储层保留期限\n\n1.  **理解问题:**\n    查询事件的年龄 $X$ 服从速率为 $\\lambda = 0.08\\,\\text{天}^{-1}$ 的指数分布。我们需要找到最小的保留期限 $D_{\\text{hot}}$，使得 $P(X \\le D_{\\text{hot}}) \\ge 0.95$。\n\n2.  **使用指数分布的累积分布函数 (CDF):**\n    指数分布的CDF为 $F(d) = P(X \\le d) = 1 - e^{-\\lambda d}$。\n    我们需要求解：\n    $$1 - e^{-\\lambda D_{\\text{hot}}} = 0.95$$\n\n3.  **求解 $D_{\\text{hot}}$:**\n    $$e^{-\\lambda D_{\\text{hot}}} = 1 - 0.95 = 0.05$$\n    对两边取自然对数：\n    $$-\\lambda D_{\\text{hot}} = \\ln(0.05)$$\n    $$D_{\\text{hot}} = -\\frac{\\ln(0.05)}{\\lambda}$$\n    代入 $\\lambda = 0.08$:\n    $$D_{\\text{hot}} = -\\frac{\\ln(0.05)}{0.08} \\approx -\\frac{-2.99573}{0.08} \\approx 37.4466\\,\\text{天}$$\n    四舍五入到四位有效数字，最小热存储层保留期限为 **37.45 天**。", "answer": "$$\\boxed{\\begin{pmatrix} 4.922 & 37.45 \\end{pmatrix}}$$", "id": "4833570"}, {"introduction": "在像医院这样动态协作的环境中，并发的数据更新很常见，如果处理不当，可能会导致危险的冲突。最后一个练习探讨了一个涉及药物医嘱冲突的关键场景。它将挑战你超越简单的解决方案，应用一种结合了因果关系追踪和临床安全原则的复杂方法，从而说明先进的溯源系统如何同时确保数据完整性和患者安全。[@problem_id:4833552]", "problem": "一条华法林 (warfarin) 的电子健康记录 (EHR) 用药医嘱作为状态 $s_0$ 存储，剂量为每日 $5\\,\\mathrm{mg}$。审计追踪是仅追加的 (append-only)，每个事件都记录了数字签名、角色、人类可读的理由、指向先前状态的父指针以及一个向量时钟。在收到一份新的实验室结果后，两名临床医生同时发布了并发更新：\n\n- 一个实验室事件 $e_L$ 发布了国际标准化比值 (INR) 测量值为 $3.8$，其向量时钟为 $v_L = \\langle 1, 1, 1 \\rangle$。此事件由实验室系统签名并引用了 $s_0$。\n- 一名药剂师发布了 $e_P$，将剂量减少到 $4\\,\\mathrm{mg}$，该操作经过签名和凭证验证，向量时钟为 $v_P = \\langle 2, 1, 1 \\rangle$。其理由是 INR升高，并且 $e_P$ 在其溯源信息中引用了 $s_0$ 和 $e_L$。\n- 一名医生发布了 $e_D$，将剂量增加到 $6\\,\\mathrm{mg}$，该操作经过签名和凭证验证，向量时钟为 $v_D = \\langle 1, 2, 1 \\rangle$。其理由是先前就诊中 INR 值低于治疗范围，并且 $e_D$ 引用了 $s_0$ 和 $e_L$。\n\n假设有以下基本前提：\n\n- 数据溯源表示为一个有向无环图 (DAG) $G$，其中节点代表状态，边代表派生关系；审计追踪必须是不可变的、完整的，并通过数字签名支持不可否认性。《健康保险流通与责任法案》(HIPAA) 要求审计日志是不可变且可归属的。\n- 因果关系使用标准的向量时钟偏序：对于向量时间戳 $x$ 和 $y$，$x \\prec y$ 当且仅当对于所有分量 $i$ 都有 $x_i \\le y_i$，并且至少存在一个分量 $j$ 使得 $x_j  y_j$。如果既不是 $x \\prec y$ 也不是 $y \\prec x$，则事件 $x$ 和 $y$ 是并发的，记作 $x \\parallel y$。\n- 临床安全性要求任何自动化冲突解决方案都不得在给定的临床背景下选择会引入高伤害风险的更新（例如，INR升高建议减少华法林剂量而非增加），并且自动化选择必须是可归属的，并可通过记录在溯源信息中的补偿性事务进行撤销。\n\n已知 $v_L \\prec v_P$，$v_L \\prec v_D$ 且 $v_P \\parallel v_D$，并且 $e_P$ 和 $e_D$ 都具有有效的数字签名和凭证，请选择能够最正确地在这些条件下确定权威状态 $s^*$ 的冲突解决规则集和溯源标准，同时保持科学真实性并遵守所述的基本前提。\n\nA. 基于物理时钟的“最后写入者获胜”：选择具有最大物理时钟时间戳 $t$ 的更新作为 $s^*$，从审计追踪中丢弃另一个更新以避免混淆，并且不记录任何解决元数据。\n\nB. 签名优先的字典序决胜：在已签名的更新中，选择事件标识符字典序最小的更新作为 $s^*$，忽略因果关系和临床背景，并且只将所选更新附加到溯源信息中，不包含对被丢弃更新的父引用。\n\nC. 因果引导、安全约束且具有明确溯源的解决方案：如果一个更新在因果上后于另一个更新，则选择因果上较晚的那个作为 $s^*$。如果更新是并发的 ($v_P \\parallel v_D$)，则根据当前背景（例如，INR为 $3.8$ 的升高情况禁止增加华法林剂量）衍生的决策支持约束来评估每个更新；在通过安全检查的更新中，要求验证数字签名和有效的角色凭证；如果两者都安全，则优先选择临床权限更高的更新，但如果只有一个安全，则选择安全的那个，即使其来自级别较低的角色。发出一个新的解决事件 $e_R$，其状态 $s^*$ 将 $e_P$ 和 $e_D$ 都作为父节点引用，记录其理由、应用的策略和加密证明，并保留 DAG。\n\nD. 字段合并启发式方法：计算平均剂量 $(4 + 6)/2 = 5\\,\\mathrm{mg}$ 作为 $s^*$，以在并发更新之间进行折衷，不评估临床背景，并且记录 $s^*$ 时不链接到父事件以最小化溯源复杂性。\n\nE. 无约束的角色最大化：始终选择来自角色权重最高的用户（医生高于药剂师）的更新作为 $s^*$，无视因果关系和决策支持，并用一个指向 $s_0$ 的单一父指针记录该选择，以避免在 DAG 中引入多条边。", "solution": "该问题要求根据给定的溯源、因果关系和临床安全前提，选择最佳的冲突解决策略。我们逐一分析每个选项。\n\n-   **场景分析**: 药剂师的更新 $e_P$（减少剂量）和医生的更新 $e_D$（增加剂量）是并发的（$v_P \\parallel v_D$）。两个更新都是对 INR 值为 $3.8$ 的实验室结果 $e_L$ 的响应。高 INR 值（>$3.0$）表示血液抗凝过度，有出血风险，临床上应减少华法林剂量。因此，药剂师的操作是正确的，而医生的操作是危险的。\n\n-   **选项 A (最后写入者获胜)**: 此方法违反了多个前提。首先，它依赖于不可靠的物理时钟。其次，也是最重要的，它“丢弃另一个更新”，这直接违反了审计追踪“不可变”和“完整”的要求。最后，它完全忽略了临床安全背景。\n\n-   **选项 B (字典序决胜)**: 此方法是一种任意的平局决胜规则，完全“忽略因果关系和临床背景”。这违反了“临床安全性”前提，因为它可能选择危险的更新（$e_D$），仅仅因为其ID恰好较小。同时，它也违反了溯源的完整性要求，因为它“不包含对被丢弃更新的父引用”。\n\n-   **选项 D (字段合并启发式)**: 此方法在临床上是极其危险的。“计算平均剂量”对于药物调整是完全没有根据的，可能导致不可预测的临床后果。它也违反了“不评估临床背景”的前提。此外，“不链接到父事件”破坏了数据溯源图（DAG）的完整性。\n\n-   **选项 E (无约束的角色最大化)**: 此方法“无视因果关系和决策支持”，仅根据角色层次结构做出决定。虽然医生通常具有更高的临床权威，但在这种情况下，他们的操作是错误的。盲目遵循层次结构会选择危险的更新 $e_D$，直接违反了“临床安全性”前提，即自动化解决方案不得选择高风险更新。\n\n-   **选项 C (因果引导、安全约束且具有明确溯源的解决方案)**: 此方法是唯一一个系统性地遵守所有前提的选项。\n    1.  **因果引导**: 它首先检查因果关系，这是处理分布式事件的正确第一步。\n    2.  **安全约束**: 对于并发事件，它应用了关键的“临床安全性”前提，根据上下文（INR=3.8）评估更新，从而排除了危险的剂量增加操作（$e_D$），并选择了安全的剂量减少操作（$e_P$）。它正确地指出，安全比角色层次更重要。\n    3.  **明确溯源**: 它通过创建一个新的解决事件 $e_R$，将冲突的两个分支 ($e_P$ 和 $e_D$) 都作为父节点引用，从而保留了完整的历史记录。这不仅满足了审计追踪的“完整”和“可归属”要求，还明确记录了冲突是如何发生的以及如何解决的，确保了整个过程的透明度和可问责性。\n\n因此，选项 C 是最正确和最稳健的解决方案。", "answer": "$$\\boxed{C}$$", "id": "4833552"}]}