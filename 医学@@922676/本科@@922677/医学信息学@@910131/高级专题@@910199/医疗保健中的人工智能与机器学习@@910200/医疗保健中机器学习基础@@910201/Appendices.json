{"hands_on_practices": [{"introduction": "在医疗保健领域，对罕见不良事件（如药物副作用或术后并发症）的预测是一项常见的挑战。然而，像受试者工作特征曲线下面积（AUROC）这样的标准评估指标可能会产生误导，因为它们对类别流行率不敏感，而阳性预测值（PPV）通常更具临床相关性。本练习将通过第一性原理推理，帮助您理解这一关键区别，并揭示为何一个拥有高 AUROC 的模型在真实世界场景中可能只有极低的 PPV [@problem_id:4841072]，这是避免在临床模型部署中陷入常见误区的关键技能。", "problem": "一家医院开发了一个二元分类器，用于根据常规收集的临床变量预测一种罕见的不良事件。设 $Y \\in \\{0,1\\}$ 表示真实的事件标签，$X$ 为观测到的特征，$\\hat{S}(X) \\in [0,1]$ 为风险评分；在部署时，当 $\\hat{S}(X) \\ge \\tau$（某个阈值 $\\tau$）时，医院将发出警报。训练队列中不良事件的患病率为 $P_{\\text{train}}(Y=1) = \\pi_{\\text{train}} = 0.01$，而模型将要部署的目标病房的患病率为 $P_{\\text{deploy}}(Y=1) = \\pi_{\\text{deploy}} = 0.002$。在从训练分布中抽取的内部验证集上，该分类器在为临床工作流程选择的操作阈值下，实现了真阳性率 (TPR) $= 0.80$ 和假阳性率 (FPR) $= 0.05$，且总体的受试者工作特征曲线下面积 (AUROC) 为 $0.92$。受试者工作特征 (ROC) 曲线总结了在不同阈值下 TPR 与 FPR 之间的权衡。\n\n请从概率论的基本原理出发，而非依赖简便公式，论述类别比例和患病率漂移对部署的影响。请考虑临床效用取决于发出警报时实现的后验概率 $P(Y=1 \\mid \\hat{S}(X) \\ge \\tau)$，而由 AUROC 概括的基于排序的区分能力是跨越所有 $\\tau$ 的 $TPR(\\tau)$ 与 $FPR(\\tau)$ 的聚合。\n\n在当前情境下，哪个选项最准确地定义了类别不平衡和患病率漂移，并正确解释了为什么在所述的部署患病率下，高 AUROC 对于罕见不良事件可能具有误导性？\n\nA. 类别不平衡意味着在训练数据中 $P(Y=1)$ 远小于 $P(Y=0)$；患病率漂移意味着 $P(Y)$ 在训练和部署之间发生变化，而 $P(X \\mid Y)$ 保持稳定。因为 AUROC 总结了跨阈值的 TPR 与 FPR，并且对 $P(Y)$ 不变，所以当 $\\pi$ 非常小时，高 AUROC 仍然可能对应于低的 $P(Y=1 \\mid \\hat{S}(X) \\ge \\tau)$，因为即使是中等的 FPR 也会产生大量假阳性，其数量会超过真阳性。\n\nB. 类别不平衡指的是类别间特征分布 $P(X)$ 的任何差异；患病率漂移意味着条件分布 $P(X \\mid Y)$ 随时间变化，而 $P(Y)$ 保持不变。AUROC 必然会随着患病率的降低而降低，因此即使在罕见事件的情况下，高 AUROC 也能保证高的 $P(Y=1 \\mid \\hat{S}(X) \\ge \\tau)$。\n\nC. 类别不平衡是由标签噪声引起的；当在部署时更改阈值 $\\tau$ 时，会发生患病率漂移。AUROC 对负样本的数量高度敏感，因此是罕见事件校准的首选度量，能确保在 AUROC 高时 $P(Y=1 \\mid \\hat{S}(X) \\ge \\tau)$ 也很高。\n\nD. 类别不平衡意味着 $P(Y=1)$ 远小于 $P(Y=0)$，而患病率漂移意味着在部署时 $P(Y)$ 和 $P(X \\mid Y)$ 都发生任意变化。AUROC 对罕见事件具有误导性，因为它低估了假阴性，而不是因为在操作阈值下假阳性可能超过真阳性。\n\nE. 类别不平衡是指 $P(Y=1)$ 等于 $P(Y=0)$ 但 $P(X)$ 在训练和部署之间有所不同；患病率漂移通过校准被消除，因此无论事件多么罕见，AUROC 完全决定了 $P(Y=1 \\mid \\hat{S}(X) \\ge \\tau)$。", "solution": "### 问题验证\n\n**步骤1：提取已知信息**\n-   一个二元分类器预测一个事件，真实标签为 $Y \\in \\{0,1\\}$。\n-   分类器根据特征 $X$ 输出一个风险评分 $\\hat{S}(X) \\in [0,1]$。\n-   如果对于某个阈值 $\\tau$ 有 $\\hat{S}(X) \\ge \\tau$，则发出警报。\n-   训练队列中的患病率：$P_{\\text{train}}(Y=1) = \\pi_{\\text{train}} = 0.01$。\n-   部署病房中的患病率：$P_{\\text{deploy}}(Y=1) = \\pi_{\\text{deploy}} = 0.002$。\n-   在选定的阈值 $\\tau$下，于训练分布上，分类器具有：\n    -   真阳性率 (TPR) $= P(\\hat{S}(X) \\ge \\tau \\mid Y=1) = 0.80$。\n    -   假阳性率 (FPR) $= P(\\hat{S}(X) \\ge \\tau \\mid Y=0) = 0.05$。\n-   分类器总体性能：受试者工作特征曲线下面积 (AUROC) $= 0.92$。\n-   问题要求对类别不平衡和患病率漂移进行正确定义，并解释为什么高 AUROC 在罕见事件中可能具有误导性，重点关注后验概率 $P(Y=1 \\mid \\hat{S}(X) \\ge \\tau)$。\n\n**步骤2：使用提取的已知信息进行验证**\n-   **科学严谨性**：该问题基于概率论、机器学习和医学信息学中标准、基本原理。所有术语（TPR、FPR、AUROC、患病率、患病率漂移）都是标准术语且使用正确。\n-   **问题定义明确**：该问题定义明确。它呈现了一个清晰、现实的场景，并要求基于第一性原理进行概念性解释，并由所提供的数据支持。存在一个唯一的、正确的解释。\n-   **客观性**：问题使用客观、精确和标准的术语陈述。它不含主观或基于意见的主张。\n-   **完整性与一致性**：问题是自洽的。它提供了所有必要信息，以推断患病率、基于排序的度量（AUROC）和基于阈值的临床相关度量（后验概率）之间的关系。在训练和部署之间，类别条件特征分布 $P(X \\mid Y)$ 保持稳定的隐式假设是“患病率漂移”的标准定义，问题本身也要求定义这一点。因此，这不是一个遗漏，而是问题的一部分。数值内部一致且合理。\n\n**步骤3：结论与行动**\n问题陈述是**有效的**。这是一个关于应用机器学习中关键主题的合理且结构良好的问题。我将继续推导解决方案。\n\n### 从基本原理推导\n\n问题的核心是分类器的区分能力（由 AUROC 衡量）与其在临床环境中的实际效用（由后验概率，如阳性预测值衡量）之间的关系。\n\n1.  **定义与基本原理**\n    -   **类别不平衡**：当数据集中各类的先验概率高度不均等时，数据集就表现出类别不平衡。对于这个二元分类问题，这意味着 $P(Y=1)$ 远小于 $P(Y=0)$，这对于给定的罕见不良事件是成立的（$P(Y=1) = 0.01$ 或 $P(Y=1) = 0.002$）。\n    -   **患病率漂移**：这是一种特定类型的数据集漂移，其中类别先验概率 $P(Y)$ 在训练和部署分布之间发生变化，但类别条件特征分布 $P(X|Y)$ 保持稳定。$P(X|Y)$ 的稳定性意味着分类器的内在属性，即 TPR 和 FPR（它们以 $Y$ 为条件），对于固定的阈值 $\\tau$ 保持不变。\n    -   **AUROC 不变性**：ROC 曲线是对于所有可能的阈值 $\\tau$，将 $TPR(\\tau) = P(\\hat{S}(X) \\ge \\tau \\mid Y=1)$ 对 $FPR(\\tau) = P(\\hat{S}(X) \\ge \\tau \\mid Y=0)$ 作图得到的。由于 TPR 和 FPR 都以真实类别 $Y$ 为条件，因此它们独立于类别患病率 $P(Y)$。因此，整个 ROC 曲线及其面积 (AUROC) 对于患病率的变化是不变的。0.92 的 AUROC 是衡量模型将阳性案例排在阴性案例之前的能力的度量，当群体中阳性案例的比例发生变化时，这种排序能力不会改变。\n    -   **后验概率 (PPV)**：临床效用由 $P(Y=1 \\mid \\hat{S}(X) \\ge \\tau)$ 给出，即收到警报的患者确实发生不良事件的概率。这是阳性预测值 (PPV)。我们可以使用贝叶斯定理来推导它。设 $A$ 为警报事件，$A \\equiv (\\hat{S}(X) \\ge \\tau)$。\n        \n        $$P(Y=1 \\mid A) = \\frac{P(A \\mid Y=1) P(Y=1)}{P(A)}$$\n        \n        对分母使用全概率公式：\n        $P(A) = P(A \\mid Y=1)P(Y=1) + P(A \\mid Y=0)P(Y=0)$\n        \n        设 $\\pi = P(Y=1)$ 为患病率。代入 TPR 和 FPR 的定义，我们得到：\n        \n        $$PPV = \\frac{TPR \\cdot \\pi}{TPR \\cdot \\pi + FPR \\cdot (1-\\pi)}$$\n        \n        这个表达式表明 PPV 是患病率 $\\pi$ 的直接函数。\n\n2.  **应用于场景**\n    现在我们可以使用给定的值计算训练和部署设置下的 PPV：$TPR = 0.80$ 和 $FPR = 0.05$。\n\n    -   **在训练队列中** ($\\pi_{\\text{train}} = 0.01$):\n        $$PPV_{\\text{train}} = \\frac{0.80 \\cdot 0.01}{0.80 \\cdot 0.01 + 0.05 \\cdot (1-0.01)} = \\frac{0.008}{0.008 + 0.05 \\cdot 0.99} = \\frac{0.008}{0.008 + 0.0495} = \\frac{0.008}{0.0575} \\approx 0.139$$\n        在训练环境中，大约 $13.9\\%$ 的警报是针对真实事件的。\n\n    -   **在部署病房中** ($\\pi_{\\text{deploy}} = 0.002$):\n        $$PPV_{\\text{deploy}} = \\frac{0.80 \\cdot 0.002}{0.80 \\cdot 0.002 + 0.05 \\cdot (1-0.002)} = \\frac{0.0016}{0.0016 + 0.05 \\cdot 0.998} = \\frac{0.0016}{0.0016 + 0.0499} = \\frac{0.0016}{0.0515} \\approx 0.031$$\n        在部署环境中，PPV 下降到约 $3.1\\%$。\n\n3.  **差异解释**\n    尽管 AUROC 很高且保持不变 ($0.92$)，但由于患病率的下降，临床效用 (PPV) 从约 $14\\%$ 骤降至约 $3\\%$。原因在于假阳性与真阳性的绝对数量。\n    -   在大小为 $N$ 的群体中，真阳性的数量为 $N \\cdot \\pi \\cdot TPR$。\n    -   假阳性的数量为 $N \\cdot (1-\\pi) \\cdot FPR$。\n    当 $\\pi$ 非常小时，阴性案例的数量 $N(1-\\pi)$ 非常大。即使是一个适度的 FPR（此处为 $0.05$）应用于这个庞大的人群，也会产生大量的假阳性。随着 $\\pi$ 的减少，真阳性的数量减少，而假阳性的数量仍然很高。假阳性“主导”或“压倒”了真阳性，导致 PPV 非常低。高 AUROC 只告诉我们模型擅长排序，但它并不能保证在事件极其罕见时，任何给定的阈值都能提供高纯度的警报集。\n\n### 逐项分析\n\n**A. 类别不平衡意味着在训练数据中 $P(Y=1)$ 远小于 $P(Y=0)$；患病率漂移意味着 $P(Y)$ 在训练和部署之间发生变化，而 $P(X \\mid Y)$ 保持稳定。因为 AUROC 总结了跨阈值的 TPR 与 FPR，并且对 $P(Y)$ 不变，所以当 $\\pi$ 非常小时，高 AUROC 仍然可能对应于低的 $P(Y=1 \\mid \\hat{S}(X) \\ge \\tau)$，因为即使是中等的 FPR 也会产生大量假阳性，其数量会超过真阳性。**\n该选项正确定义了类别不平衡。它正确地将患病率漂移定义为 $P(Y)$ 的变化而 $P(X|Y)$ 稳定。它正确地指出 AUROC 对患病率是不变的。它正确地得出结论，在罕见事件设置中，尽管 AUROC 很高，但 PPV 可能很低，并给出了正确的原因：大量的假阳性压倒了真阳性。这与我们的推导完全一致。\n**结论：正确。**\n\n**B. 类别不平衡指的是类别间特征分布 $P(X)$ 的任何差异；患病率漂移意味着条件分布 $P(X \\mid Y)$ 随时间变化，而 $P(Y)$ 保持不变。AUROC 必然会随着患病率的降低而降低，因此即使在罕见事件的情况下，高 AUROC 也能保证高的 $P(Y=1 \\mid \\hat{S}(X) \\ge \\tau)$。**\n类别不平衡的定义不正确；$P(X|Y=0)$ 和 $P(X|Y=1)$ 之间的差异是使分类成为可能的原因，而不是定义不平衡的原因。患病率漂移的定义不正确；它描述的是概念漂移，并错误地声称 $P(Y)$ 是恒定的。AUROC 随患病率降低而降低的说法不正确。最后的结论与事实相反。\n**结论：错误。**\n\n**C. 类别不平衡是由标签噪声引起的；当在部署时更改阈值 $\\tau$ 时，会发生患病率漂移。AUROC 对负样本的数量高度敏感，因此是罕见事件校准的首选度量，能确保在 AUROC 高时 $P(Y=1 \\mid \\hat{S}(X) \\ge \\tau)$ 也很高。**\n类别不平衡的定义不正确；它与标签噪声无关。患病率漂移的定义不正确；它与更改 $\\tau$ 无关。声称 AUROC “对负样本数量高度敏感”是错误的；它以对类别平衡不敏感而闻名，不像基于精确率-召回率曲线的度量。AUROC 是区分度的度量，而不是校准度的度量。\n**结论：错误。**\n\n**D. 类别不平衡意味着 $P(Y=1)$ 远小于 $P(Y=0)$，而患病率漂移意味着在部署时 $P(Y)$ 和 $P(X \\mid Y)$ 都发生任意变化。AUROC 对罕见事件具有误导性，因为它低估了假阴性，而不是因为在操作阈值下假阳性可能超过真阳性。**\n类别不平衡的定义是正确的。患病率漂移的定义过于宽泛（描述了更广泛的数据集漂移），并且与用于分析患病率漂移影响的 $P(X|Y)$ 稳定的标准假设相矛盾。其推理不正确；核心问题是相对于真阳性而言，*假阳性*的数量很高，而不是低估了*假阴性*。\n**结论：错误。**\n\n**E. 类别不平衡是指 $P(Y=1)$ 等于 $P(Y=0)$ 但 $P(X)$ 在训练和部署之间有所不同；患病率漂移通过校准被消除，因此无论事件多么罕见，AUROC 完全决定了 $P(Y=1 \\mid \\hat{S}(X) \\ge \\tau)$。**\n类别不平衡的定义不正确；$P(Y=1) = P(Y=0)$ 描述的是一个平衡的数据集。声称校准“消除”了患病率漂移是错误的；患病率是总体的属性，而不是模型的属性。声称 AUROC “完全决定”了 PPV 是错误的；我们的推导表明 PPV 严重依赖于患病率，而 AUROC 则不然。\n**结论：错误。**", "answer": "$$\\boxed{A}$$", "id": "4841072"}, {"introduction": "在上一练习的基础上，我们现在将探讨模型性能的另一个关键维度：校准度与区分度。一个模型如果其预测概率能准确反映事件的真实可能性，那么它就是良好校准的。而区分度（通常由 AUROC 衡量）则是其区分阳性与阴性病例的能力，这两个特性是截然不同的。通过一个引导性的计算练习，您将证明一个模型可以达到完美的校准度，但其区分能力却可能非常差，尤其是在底层生物信号微弱的情况下 [@problem_id:4841086]。这个练习阐明了评估一个“好”模型必须从多个维度进行的道理。", "problem": "一家医院正在使用单个连续的实验室生物标志物开发一个脓毒症风险模型。设二元结果由 $Y \\in \\{0,1\\}$ 表示，其中 $Y=1$ 表示患者在 $48$ 小时内发生脓毒症。生物标志物为 $X \\in \\mathbb{R}$。在目标人群中，类别先验（患病率）为 $p = \\mathbb{P}(Y=1) = 0.01$。根据经验，类条件特征分布可以很好地由具有相等方差的正态分布描述：$X \\mid Y=1 \\sim \\mathcal{N}(\\mu_1,\\sigma^2)$ 和 $X \\mid Y=0 \\sim \\mathcal{N}(\\mu_0,\\sigma^2)$，其中 $\\mu_0 = 0$，$\\mu_1 = 0.1$，$\\sigma = 1$。模型输出后验概率得分 $S = s(X)$，其中 $s(x) = \\mathbb{P}(Y=1 \\mid X=x)$ 是使用 Bayes 定理以及真实参数和真实先验 $p$ 计算得出的。因此，模型的得分在数值上等于给定 $X$ 时结果的真实条件概率。\n\n仅使用概率论和统计学中的基本定义：校准的定义为对于几乎所有的 $s$ 都有 $\\mathbb{P}(Y=1 \\mid S=s) = s$，Bayes 定理，以及受试者工作特征（AUROC）曲线下面积的定义为当平局概率为零时，一个随机抽取的阳性病例获得比一个随机抽取的阴性病例严格更高的得分的概率。在抽取一个阳性病例和一个阴性病例时，假设它们是独立的。\n\n从这些定义出发（不借助任何预先记下的“捷径”公式），在给定的数据生成机制下，推导和评估该模型的 AUROC。然后解释该值如何证明，在严重的类别不平衡和弱分离的类条件分布下，一个模型可以被完美校准但区分度很差。\n\n将最终的 AUROC 以四舍五入到四位有效数字的单个实数形式给出。不需要单位。", "solution": "首先根据指定标准对问题进行验证。\n\n**步骤 1：提取已知条件**\n-   结果变量：$Y \\in \\{0,1\\}$，其中 $Y=1$ 表示脓毒症。\n-   连续生物标志物：$X \\in \\mathbb{R}$。\n-   脓毒症的类别先验：$p = \\mathbb{P}(Y=1) = 0.01$。\n-   阳性病例（$Y=1$）的类条件分布：$X \\mid Y=1 \\sim \\mathcal{N}(\\mu_1, \\sigma^2)$。\n-   阴性病例（$Y=0$）的类条件分布：$X \\mid Y=0 \\sim \\mathcal{N}(\\mu_0, \\sigma^2)$。\n-   参数：$\\mu_0 = 0$，$\\mu_1 = 0.1$，$\\sigma = 1$。\n-   模型得分：$S = s(X)$，其中 $s(x) = \\mathbb{P}(Y=1 \\mid X=x)$ 使用真实参数计算。\n-   AUROC 的定义：一个随机抽取的阳性病例获得比一个随机抽取的阴性病例严格更高的得分的概率，即 $\\mathbb{P}(S_1  S_0)$，其中 $S_1$ 是阳性病例的得分，$S_0$ 是阴性病例的得分。\n-   假设：随机抽取的阳性病例和阴性病例之间是独立的。\n-   任务：根据这些定义推导和评估 AUROC，并解释结果。\n\n**步骤 2：使用提取的已知条件进行验证**\n该问题在科学和数学上都是合理的。它提出了统计分类和模型评估中的一个标准情景，使用了诸如 Bayes 定理、正态分布、类别不平衡、校准和 AUROC 等已确立的概念。所提供的信息是完整、一致且定义明确的，允许从第一性原理推导出唯一的解决方案。对于一个带有弱生物标志物的医学诊断问题，这些参数是现实的。该问题是适定且客观的。\n\n**步骤 3：结论与行动**\n该问题被认为是**有效的**。将推导完整的解决方案。\n\n**AUROC 的推导**\n\n受试者工作特征（AUROC）曲线下面积定义为随机选择的阳性病例比随机选择的阴性病例具有更高风险得分的概率。设 $X_1$ 是从阳性类别（$Y=1$）的生物标志物分布中随机抽取的一个样本，而 $X_0$ 是从阴性类别（$Y=0$）的分布中随机抽取的一个样本。相应的得分是 $S_1 = s(X_1)$ 和 $S_0 = s(X_0)$。那么 AUROC 就是 $\\mathbb{P}(S_1  S_0)$。\n\n首先，我们必须刻画得分函数 $s(x) = \\mathbb{P}(Y=1 \\mid X=x)$。使用 Bayes 定理：\n$$s(x) = \\frac{f(x \\mid Y=1) \\mathbb{P}(Y=1)}{f(x \\mid Y=1) \\mathbb{P}(Y=1) + f(x \\mid Y=0) \\mathbb{P}(Y=0)}$$\n其中 $f(x \\mid Y=1)$ 和 $f(x \\mid Y=0)$ 是类条件分布的概率密度函数（PDF）。设 $p = \\mathbb{P}(Y=1)=0.01$，因此 $\\mathbb{P}(Y=0) = 1-p = 0.99$。这些 PDF 是正态分布的：\n$$f(x \\mid Y=1) = f_1(x) = \\frac{1}{\\sqrt{2\\pi}\\sigma} \\exp\\left(-\\frac{(x-\\mu_1)^2}{2\\sigma^2}\\right)$$\n$$f(x \\mid Y=0) = f_0(x) = \\frac{1}{\\sqrt{2\\pi}\\sigma} \\exp\\left(-\\frac{(x-\\mu_0)^2}{2\\sigma^2}\\right)$$\n得分函数可以写成：\n$$s(x) = \\frac{p f_1(x)}{p f_1(x) + (1-p) f_0(x)} = \\frac{1}{1 + \\frac{1-p}{p} \\frac{f_0(x)}{f_1(x)}}$$\n\n我们必须确定 $s(x)$ 是否是 $x$ 的单调函数。$\\mathbb{P}(S_1  S_0)$ 的关系取决于 $s(x)$ 的单调性。PDF 的比率是：\n$$\\frac{f_0(x)}{f_1(x)} = \\frac{\\exp\\left(-\\frac{(x-\\mu_0)^2}{2\\sigma^2}\\right)}{\\exp\\left(-\\frac{(x-\\mu_1)^2}{2\\sigma^2}\\right)} = \\exp\\left(\\frac{(x-\\mu_1)^2 - (x-\\mu_0)^2}{2\\sigma^2}\\right)$$\n指数中的项是：\n$$\\frac{1}{2\\sigma^2} \\left( (x^2 - 2x\\mu_1 + \\mu_1^2) - (x^2 - 2x\\mu_0 + \\mu_0^2) \\right) = \\frac{1}{2\\sigma^2} \\left( 2x(\\mu_0 - \\mu_1) + \\mu_1^2 - \\mu_0^2 \\right) = \\frac{\\mu_0 - \\mu_1}{\\sigma^2} x + \\frac{\\mu_1^2 - \\mu_0^2}{2\\sigma^2}$$\n这是 $x$ 的一个线性函数。设 $g(x) = \\frac{f_0(x)}{f_1(x)}$。其对数关于 $x$ 的导数是 $\\frac{d}{dx} \\ln(g(x)) = \\frac{\\mu_0 - \\mu_1}{\\sigma^2}$。\n给定 $\\mu_1 = 0.1$ 和 $\\mu_0 = 0$，该导数为 $\\frac{0 - 0.1}{1^2} = -0.1$，是负数。因此，$\\ln(g(x))$ 是 $x$ 的严格递减函数，这意味着 $g(x) = \\frac{f_0(x)}{f_1(x)}$ 也是 $x$ 的严格递减函数。\n\n得分函数为 $s(x) = \\left(1 + \\frac{1-p}{p}g(x)\\right)^{-1}$。由于 $g(x)$ 是一个正的、严格递减的函数，并且对于 $c0, z0$，$z \\mapsto (1+c z)^{-1}$ 是一个严格递减的函数，因此复合函数 $s(x)$ 是 $x$ 的一个严格**递增**函数。\n\n因为 $s(x)$ 是严格单调的，不等式 $s(X_1)  s(X_0)$ 等价于不等式 $X_1  X_0$。因此，AUROC 可以计算为：\n$$\\text{AUROC} = \\mathbb{P}(S_1  S_0) = \\mathbb{P}(X_1  X_0)$$\n我们已知 $X_1$ 和 $X_0$ 是独立随机变量，其分布为：\n$$X_1 \\sim \\mathcal{N}(\\mu_1, \\sigma^2)$$\n$$X_0 \\sim \\mathcal{N}(\\mu_0, \\sigma^2)$$\n设差值为 $D = X_1 - X_0$。由于 $X_1$ 和 $X_0$ 是独立的正态变量，它们的差值 $D$ 也服从正态分布。\n$D$ 的均值为 $\\mathbb{E}[D] = \\mathbb{E}[X_1] - \\mathbb{E}[X_0] = \\mu_1 - \\mu_0$。\n$D$ 的方差为 $\\text{Var}(D) = \\text{Var}(X_1) + \\text{Var}(-X_0) = \\text{Var}(X_1) + (-1)^2 \\text{Var}(X_0) = \\sigma^2 + \\sigma^2 = 2\\sigma^2$。\n所以，$D \\sim \\mathcal{N}(\\mu_1 - \\mu_0, 2\\sigma^2)$。\n\n我们需要计算 $\\mathbb{P}(D  0)$。为此，我们对变量 $D$ 进行标准化：\n$$\\mathbb{P}(D  0) = \\mathbb{P}\\left(\\frac{D - \\mathbb{E}[D]}{\\sqrt{\\text{Var}(D)}}  \\frac{0 - \\mathbb{E}[D]}{\\sqrt{\\text{Var}(D)}}\\right)$$\n设 $Z = \\frac{D - \\mathbb{E}[D]}{\\sqrt{\\text{Var}(D)}}$，其中 $Z \\sim \\mathcal{N}(0,1)$ 是一个标准正态变量。\n$$\\mathbb{P}(D  0) = \\mathbb{P}\\left(Z  \\frac{-(\\mu_1 - \\mu_0)}{\\sqrt{2\\sigma^2}}\\right) = \\mathbb{P}\\left(Z  -\\frac{\\mu_1 - \\mu_0}{\\sigma\\sqrt{2}}\\right)$$\n根据标准正态分布的对称性，$\\mathbb{P}(Z  -z) = \\mathbb{P}(Z  z)$。设 $\\Phi(z)$ 是标准正态分布的累积分布函数（CDF）。\n$$\\text{AUROC} = \\mathbb{P}\\left(Z  \\frac{\\mu_1 - \\mu_0}{\\sigma\\sqrt{2}}\\right) = \\Phi\\left(\\frac{\\mu_1 - \\mu_0}{\\sigma\\sqrt{2}}\\right)$$\n\n现在，我们代入给定的数值：$\\mu_1 = 0.1$，$\\mu_0 = 0$，$\\sigma = 1$。\n$$\\text{AUROC} = \\Phi\\left(\\frac{0.1 - 0}{1 \\cdot \\sqrt{2}}\\right) = \\Phi\\left(\\frac{0.1}{\\sqrt{2}}\\right)$$\n数值上，自变量为 $\\frac{0.1}{\\sqrt{2}} \\approx 0.070710678$。在此值处计算标准正态 CDF 得到：\n$$\\text{AUROC} = \\Phi(0.070710678) \\approx 0.528186$$\n四舍五入到四位有效数字，我们得到 $0.5282$。\n\n**解释**\n\n问题陈述该模型是完美校准的。这是由构造决定的：得分 $s(x)$ 被定义为真实条件概率 $\\mathbb{P}(Y=1 \\mid X=x)$。这意味着对于任何一组模型输出得分为（比如说）$s=0.05$ 的患者，这些患者中将发生脓毒症的真实比例恰好是 $5\\%$。校准衡量的是模型概率输出的可靠性。\n\n计算出的 AUROC 约为 $0.5282$。AUROC 是衡量模型**区分度**的指标，即其分离阳性和阴性类别的能力。AUROC 为 $1.0$ 表示完美分离，而 AUROC 为 $0.5$ 表示模型的区分能力不比随机猜测好。我们的值 $0.5282$ 非常接近 $0.5$，表明区分能力非常差。在将随机选择的脓毒症患者的排名排在随机选择的非脓毒症患者之前方面，该模型仅比抛硬币好一点。\n\n这个结果展示了模型评估中的一个关键原则：**完美的校准并不意味着良好的区分度**。区分度差的根本原因是数据生成机制本身。类条件分布 $\\mathcal{N}(0.1, 1)$ 和 $\\mathcal{N}(0, 1)$ 是“弱分离的”，因为它们的均值（$\\mu_1=0.1$, $\\mu_0=0$）相对于它们的标准差（$\\sigma=1$）非常接近。这导致脓毒症患者和非脓毒症患者的生物标志物值之间存在大量重叠，使得仅根据生物标志物 $X$ 来区分这两个群体在本质上是困难的。严重的类别不平衡（$p=0.01$）进一步意味着，无论结果如何，大多数患者的生物标志物值都很低，这使得区分变得具有挑战性。\n\n模型正确地学习了生物标志物和结果之间真实（但有限）的关系，从而产生了完全可靠的概率得分。然而，由于数据中的内在信号非常弱，这些可靠的概率无法有效地分离类别，导致 AUROC 值很低。这种情况在医学中很常见，其中风险因素可能在统计上是显著的，但效应量很小，从而导致模型虽然经过校准，但区分度不高。", "answer": "$$\\boxed{0.5282}$$", "id": "4841086"}, {"introduction": "在评估完模型之后，我们需要使其决策对临床医生来说易于理解和可操作。“反事实解释”能够回答这样一个问题：“需要对患者数据做出何种最小的改变，才能改变模型的决策？” 这种方法能够提供具体且可行的见解。在最后的这个练习中，您将扮演一名机器学习工程师，通过解决一个带约束的优化问题来构建一个生成此类解释的系统 [@problem_id:4841103]。这将使您亲身体验可解释性人工智能（XAI）中的一项先进技术，该技术有助于提升机器学习在临床工作流程中的透明度和实用性。", "problem": "给你一个用于医疗保健环境中重症监护室（ICU）转入的二元决策模型，该模型表示为一个逻辑回归分类器。模型根据逻辑函数 $\\sigma(z) = \\frac{1}{1 + e^{-z}}$ 输出接受概率，其中 $z = \\mathbf{w}^\\top \\mathbf{x} + b$。当 $\\sigma(z) \\geq 0.5$ 时，转入被接受，这等价于阈值条件 $\\mathbf{w}^\\top \\mathbf{x} + b \\geq 0$。反事实解释是一个经过最小程度改变的特征向量 $\\mathbf{x}_{\\mathrm{cf}} = \\mathbf{x} + \\boldsymbol{\\delta}$，它在遵守临床合理性约束的同时，将一个被拒绝的决策翻转为接受。\n\n在以下基于临床的约束条件下，构建对输入特征进行最小程度改变的反事实解释：\n- 不可变特征：某些特征完全不能改变。\n- 单调方向约束：一些特征只能增加（例如，改善氧饱和度），而另一些只能减少（例如，降低乳酸）。\n- 生理学上合理的范围：每个特征在改变后必须保持在预定义的下限和上限之内。\n\n形式上，给定一个患者特征向量 $\\mathbf{x} \\in \\mathbb{R}^n$，找到一个 $\\boldsymbol{\\delta} \\in \\mathbb{R}^n$ 来解决以下约束最小化问题\n$$\n\\begin{aligned}\n\\min_{\\boldsymbol{\\delta}} \\quad  \\|\\boldsymbol{\\delta}\\|_2 \\\\\n\\text{s.t.} \\quad  \\mathbf{w}^\\top(\\mathbf{x} + \\boldsymbol{\\delta}) + b \\geq 0, \\\\\n x_i + \\delta_i \\in [\\ell_i, u_i] \\quad \\forall i \\in \\{1,\\dots,n\\}, \\\\\n \\delta_i = 0 \\quad \\text{if feature } i \\text{ is immutable}, \\\\\n \\delta_i \\geq 0 \\quad \\text{if feature } i \\text{ is restricted to increase only}, \\\\\n \\delta_i \\leq 0 \\quad \\text{if feature } i \\text{ is restricted to decrease only}.\n\\end{aligned}\n$$\n使用以下模型参数、特征顺序和约束。所有特征都归一化到区间 $[0,1]$。\n\n特征顺序和含义（已归一化）：\n$1$: 年龄（不可变），$2$: 合并症指数（不可变），$3$: 心率（仅可减少），$4$: 氧饱和度（仅可增加），$5$: 乳酸（仅可减少），$6$: 平均动脉压（仅可增加），$7$: 尿量（仅可增加），$8$: 吸入氧分数（仅可减少）。\n\n模型参数：\n$\\mathbf{w} = [-1.0,-0.8,-0.5,0.9,-1.2,1.0,0.7,-0.9]$ 且 $b = -0.4$。\n\n生理学上合理的范围（每个特征的下限和上限）：\n$\\boldsymbol{\\ell} = [0.0, 0.0, 0.3, 0.85, 0.0, 0.4, 0.2, 0.3]$，$\\boldsymbol{u} = [1.0, 1.0, 1.0, 1.0, 1.0, 0.9, 0.9, 0.9]$。\n\n单调方向和不可变性：\n- 不可变：特征 $1$ 和 $2$ 有 $\\delta_1 = 0$ 和 $\\delta_2 = 0$。\n- 仅可减少：特征 $3$、$5$、$8$ 有 $\\delta_3 \\leq 0$、$\\delta_5 \\leq 0$、$\\delta_8 \\leq 0$。\n- 仅可增加：特征 $4$、$6$、$7$ 有 $\\delta_4 \\geq 0$、$\\delta_6 \\geq 0$、$\\delta_7 \\geq 0$。\n\n患者特征向量测试套件 $\\mathbf{x}$：\n- 案例 $1$（被拒绝但接近阈值）：$\\mathbf{x}^{(1)} = [0.6, 0.5, 0.6, 0.95, 0.4, 0.6, 0.5, 0.4]$。\n- 案例 $2$（已被接受）：$\\mathbf{x}^{(2)} = [0.3, 0.2, 0.5, 0.98, 0.2, 0.8, 0.7, 0.3]$。\n- 案例 $3$（被拒绝且可能不可行）：$\\mathbf{x}^{(3)} = [0.95, 0.9, 0.8, 0.88, 0.95, 0.5, 0.3, 0.85]$。\n\n对于每个案例，你的程序必须计算一个满足上述约束的反事实特征向量 $\\mathbf{x}_{\\mathrm{cf}}$，该向量以最小的改动改变 $\\mathbf{x}$ 以获得接受。如果患者已被接受，则返回原始的 $\\mathbf{x}$。如果在约束条件下不存在可行的反事实，则为该案例返回一个空列表。\n\n最终输出格式：\n你的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每个元素要么是代表一个案例的 $\\mathbf{x}_{\\mathrm{cf}}$ 的浮点数方括号列表，要么在不可行时为空列表，例如 $[[x_{1},\\dots,x_{8}],[],[x_{1},\\dots,x_{8}]]$。不应打印任何额外的文本。", "solution": "该问题要求计算一个用于临床决策背景下逻辑回归模型的反事实解释 $\\mathbf{x}_{\\mathrm{cf}}$。反事实解释是原始特征向量 $\\mathbf{x}$ 的一个最小扰动版本，表示为 $\\mathbf{x}_{\\mathrm{cf}} = \\mathbf{x} + \\boldsymbol{\\delta}$，它将模型的预测从“拒绝”结果改变为“接受”结果，并受一组合理性约束的限制。目标是找到具有最小欧几里得范数 $\\|\\boldsymbol{\\delta}\\|_2$ 的变化向量 $\\boldsymbol{\\delta}$。\n\n这个问题可以严格地表述为一个约束优化问题。具体来说，它是一个二次规划（QP）问题，涉及在线性约束下最小化一个二次目标函数。\n\n首先，我们分析目标函数。目标是最小化欧几里得范数 $\\|\\boldsymbol{\\delta}\\|_2 = \\sqrt{\\sum_{i=1}^n \\delta_i^2}$。最小化此范数等价于最小化其平方 $\\|\\boldsymbol{\\delta}\\|_2^2 = \\sum_{i=1}^n \\delta_i^2 = \\boldsymbol{\\delta}^\\top \\boldsymbol{\\delta}$，因为平方根函数对于非负值是严格单调的。平方形式是一个凸二次函数，对于标准优化求解器更为理想。因此，我们的目标函数是：\n$$\n\\min_{\\boldsymbol{\\delta}} \\quad f(\\boldsymbol{\\delta}) = \\boldsymbol{\\delta}^\\top \\boldsymbol{\\delta}\n$$\n\n接下来，我们形式化约束条件。问题对扰动向量 $\\boldsymbol{\\delta}$ 定义了几种类型的约束。\n\n1.  **决策边界约束**：反事实点 $\\mathbf{x}_{\\mathrm{cf}} = \\mathbf{x} + \\boldsymbol{\\delta}$ 必须导致“接受”决策。模型在 $\\mathbf{w}^\\top \\mathbf{x}_{\\mathrm{cf}} + b \\geq 0$ 时接受转入。代入 $\\mathbf{x}_{\\mathrm{cf}}$ 得：\n    $$\n    \\mathbf{w}^\\top (\\mathbf{x} + \\boldsymbol{\\delta}) + b \\geq 0\n    $$\n    这可以重排为关于 $\\boldsymbol{\\delta}$ 的一个线性不等式约束：\n    $$\n    \\mathbf{w}^\\top \\boldsymbol{\\delta} \\geq -(\\mathbf{w}^\\top \\mathbf{x} + b)\n    $$\n    设 $z = \\mathbf{w}^\\top \\mathbf{x} + b$ 为模型对原始向量 $\\mathbf{x}$ 的线性得分。对于被拒绝的案例，$z  0$。该约束变为 $\\mathbf{w}^\\top \\boldsymbol{\\delta} \\geq -z$。这是一个单一的线性不等式约束。\n\n2.  **组合的合理性约束**：问题定义了三种类型的特征特定约束：生理学上合理的范围、不可变性和单调方向。这些可以组合成一组盒式约束，即向量 $\\boldsymbol{\\delta}$ 的每个分量 $\\delta_i$ 的下限和上限。\n    - 范围约束是 $x_i + \\delta_i \\in [\\ell_i, u_i]$，这意味着 $\\ell_i - x_i \\leq \\delta_i \\leq u_i - x_i$。\n    - 对于不可变特征（$i \\in \\{1, 2\\}$），$\\delta_i = 0$。这将 $\\delta_i$ 的下限和上限都设置为 $0$。所以，$\\delta_i \\in [0, 0]$。\n    - 对于仅限增加的特征（$i \\in \\{4, 6, 7\\}$），$\\delta_i \\geq 0$。这修改了范围约束的下限。最终的界限是 $\\max(\\ell_i - x_i, 0) \\leq \\delta_i \\leq u_i - x_i$。\n    - 对于仅限减少的特征（$i \\in \\{3, 5, 8\\}$），$\\delta_i \\leq 0$。这修改了上限。最终的界限是 $\\ell_i - x_i \\leq \\delta_i \\leq \\min(u_i - x_i, 0)$。\n\n设每个 $\\delta_i$ 的最终下限和上限分别为 $L_i$ 和 $U_i$。完整的优化问题是：\n$$\n\\begin{aligned}\n\\min_{\\boldsymbol{\\delta}} \\quad  \\sum_{i=1}^{8} \\delta_i^2 \\\\\n\\text{s.t.} \\quad  \\mathbf{w}^\\top \\boldsymbol{\\delta} \\geq -(\\mathbf{w}^\\top \\mathbf{x} + b) \\\\\n L_i \\leq \\delta_i \\leq U_i \\quad \\forall i \\in \\{1,\\dots,8\\}\n\\end{aligned}\n$$\n\n对于每个给定的患者向量 $\\mathbf{x}$ 的求解策略如下：\n1.  首先，评估初始线性得分 $z = \\mathbf{w}^\\top \\mathbf{x} + b$。如果 $z \\geq 0$，则该患者已被分类为“接受”，无需反事实解释。返回原始向量 $\\mathbf{x}$。\n2.  如果 $z  0$，则构建优化问题。我们根据给定的 $\\mathbf{x}$、$\\boldsymbol{\\ell}$、$\\boldsymbol{u}$ 和指定的特征约束，计算每个 $\\delta_i$ 的具体界限 $[L_i, U_i]$。\n3.  得到的 QP 问题使用合适的数值求解器来解决。序列最小二乘规划（SLSQP）方法适用于此任务，因为它既能处理不等式约束也能处理盒式约束。我们使用 `scipy.optimize.minimize` 函数和 `'SLSQP'` 方法。\n4.  求解器的输出决定了结果。如果求解器找到一个可行解（由成功状态指示），则使用最优扰动 $\\boldsymbol{\\delta}^*$ 来计算反事实 $\\mathbf{x}_{\\mathrm{cf}} = \\mathbf{x} + \\boldsymbol{\\delta}^*$。如果约束条件相互不兼容（即，可行集为空），求解器将无法找到解决方案。在这种情况下，不存在可行的反事实，并按规定返回一个空列表，如案例3所示。这可以通过验证盒式约束下 $\\mathbf{w}^\\top\\boldsymbol{\\delta}$ 的最大可能值是否足以满足决策边界要求来预先检查。对于案例3，$\\max(\\mathbf{w}^\\top\\boldsymbol{\\delta}) \\approx 2.813$，而要求是 $\\mathbf{w}^\\top\\boldsymbol{\\delta} \\geq 2.873$，这证实了其不可行性。\n该实现封装了这一逻辑，遍历每个测试案例并应用适当的程序。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import minimize\n\ndef solve():\n    \"\"\"\n    Computes counterfactual explanations for a logistic regression model\n    by solving a constrained quadratic optimization problem.\n    \"\"\"\n    # Model parameters and constraints\n    w = np.array([-1.0, -0.8, -0.5, 0.9, -1.2, 1.0, 0.7, -0.9])\n    b = -0.4\n    \n    # Physiologically plausible ranges (lower and upper bounds)\n    l_bounds = np.array([0.0, 0.0, 0.3, 0.85, 0.0, 0.4, 0.2, 0.3])\n    u_bounds = np.array([1.0, 1.0, 1.0, 1.0, 1.0, 0.9, 0.9, 0.9])\n    \n    # Feature constraint definitions (0-indexed)\n    immutable_idx = [0, 1]\n    decrease_only_idx = [2, 4, 7] # Corresponds to features 3, 5, 8\n    increase_only_idx = [3, 5, 6] # Corresponds to features 4, 6, 7\n    \n    # Test suite of patient feature vectors\n    test_cases = [\n        [0.6, 0.5, 0.6, 0.95, 0.4, 0.6, 0.5, 0.4],\n        [0.3, 0.2, 0.5, 0.98, 0.2, 0.8, 0.7, 0.3],\n        [0.95, 0.9, 0.8, 0.88, 0.95, 0.5, 0.3, 0.85],\n    ]\n\n    results = []\n    \n    for x_list in test_cases:\n        x = np.array(x_list)\n        z = w.T @ x + b\n        \n        # Case: Already accepted, no counterfactual needed\n        if z >= 0:\n            results.append(x.tolist())\n            continue\n            \n        # Case: Denied, find a counterfactual by solving the optimization problem\n        \n        # 1. Define bounds for the perturbation vector delta\n        delta_bounds = []\n        for i in range(len(x)):\n            # Base bounds from plausible ranges\n            lower_delta = l_bounds[i] - x[i]\n            upper_delta = u_bounds[i] - x[i]\n            \n            if i in immutable_idx:\n                delta_bounds.append((0.0, 0.0))\n            elif i in decrease_only_idx:\n                # delta must be = 0 and within range\n                delta_bounds.append((lower_delta, min(upper_delta, 0.0)))\n            elif i in increase_only_idx:\n                # delta must be >= 0 and within range\n                delta_bounds.append((max(lower_delta, 0.0), upper_delta))\n            else:\n                # Should not be reached given problem definition\n                delta_bounds.append((lower_delta, upper_delta))\n        \n        # 2. Define objective function (||delta||_2^2) and its jacobian\n        objective_fn = lambda delta: np.dot(delta, delta)\n        objective_jac = lambda delta: 2 * delta\n        \n        # 3. Define the linear inequality constraint: w.T @ (x + delta) + b >= 0\n        # This simplifies to: w.T @ delta >= -(w.T @ x + b) which is w.T @ delta >= -z\n        # For scipy's 'ineq' type, which is C(x) >= 0, our function is C(delta) = w.T @ delta + z\n        constraint_fun = lambda delta: w.T @ delta + z\n        constraint_jac = lambda delta: w\n        \n        constraints = [{'type': 'ineq', 'fun': constraint_fun, 'jac': constraint_jac}]\n        \n        # 4. Initial guess for delta\n        delta0 = np.zeros(len(x))\n        \n        # 5. Solve the Quadratic Program\n        opt_result = minimize(\n            fun=objective_fn,\n            x0=delta0,\n            jac=objective_jac,\n            bounds=delta_bounds,\n            constraints=constraints,\n            method='SLSQP'\n        )\n        \n        # 6. Process the result\n        if opt_result.success:\n            delta_sol = opt_result.x\n            x_cf = x + delta_sol\n            results.append(x_cf.tolist())\n        else:\n            # If optimization fails, no feasible counterfactual was found\n            results.append([])\n            \n    # Format the final output string exactly as specified\n    output_parts = []\n    for res in results:\n        if not res:\n            output_parts.append(\"[]\")\n        else:\n            output_parts.append(f\"[{','.join(f'{val:.8f}' for val in res)}]\")\n            \n    final_output_str = f\"[{','.join(output_parts)}]\"\n    print(final_output_str)\n\nsolve()\n```", "id": "4841103"}]}