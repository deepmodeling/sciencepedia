{"hands_on_practices": [{"introduction": "影像组学特征是定量描述医学图像中病灶纹理和形态的关键。本练习将带领你从零开始，为一个给定的三维体素兴趣区域（ROI）构建灰度共生矩阵（GLCM），并计算两个核心的二阶纹理特征：对比度（Contrast）和熵（Entropy）。通过这项实践，你将掌握从原始图像数据中提取高级纹理信息的底层机制。[@problem_id:4834547]", "problem": "一个三维感兴趣区域（ROI）已被离散化为三个灰度级 $\\{1,2,3\\}$，位于由整数坐标 $(x,y,z)$索引的体素网格上，其中 $x \\in \\{1,2\\}$，$y \\in \\{1,2\\}$，$z \\in \\{1,2\\}$。该ROI由两个轴向切片（$z=1$ 和 $z=2$）组成，每个切片大小为 $2 \\times 2$，其灰度级如下（行对应增加的 $y$，列对应增加的 $x$）：\n$$\nz=1:\\quad \\begin{bmatrix} 1  2 \\\\ 2  1 \\end{bmatrix}, \\qquad\nz=2:\\quad \\begin{bmatrix} 2  3 \\\\ 1  2 \\end{bmatrix}.\n$$\n使用影像组学中灰度共生矩阵（GLCM）的标准定义，通过计算沿13个唯一三维方向的共生次数，为此ROI构建一个单一的、聚合的、对称的GLCM，距离 $d=1$。这些方向由“第一个非零分量为正”的规则获得。具体来说，方向集为\n$$\n\\{(1,0,0),(0,1,0),(0,0,1),(1,1,0),(1,-1,0),(1,0,1),(1,0,-1),(0,1,1),(0,1,-1),(1,1,1),(1,1,-1),(1,-1,1),(1,-1,-1)\\}.\n$$\n对于ROI内沿上述任一方向 $\\mathbf{v}$、距离 $d=1$ 的每一体素对 $(\\mathbf{p},\\mathbf{p}+\\mathbf{v})$，设 $i$ 为 $\\mathbf{p}$ 处的灰度级，$j$ 为 $\\mathbf{p}+\\mathbf{v}$ 处的灰度级。对于每个这样的体素对，将GLCM中 $(i,j)$ 和 $(j,i)$ 的计数均增加1，以形成对称的GLCM。在累积完所有方向的计数后，将GLCM除以总计数进行归一化，以获得概率 $P(i,j)$，使得 $\\sum_{i}\\sum_{j} P(i,j)=1$。\n\n仅使用GLCM的核心定义和特征公式，计算：\n- 对比度\n$$\nC = \\sum_{i=1}^{3}\\sum_{j=1}^{3} (i-j)^{2}\\, P(i,j),\n$$\n- 和熵\n$$\nH = -\\sum_{i=1}^{3}\\sum_{j=1}^{3} P(i,j)\\, \\ln\\!\\big(P(i,j)\\big),\n$$\n其中 $\\ln$ 表示自然对数，并且根据连续性，当 $P(i,j)=0$ 时，该项贡献为0。\n\n将最终答案表示为行向量 $\\big(C\\ \\ H\\big)$，无单位，并将两个值四舍五入到四位有效数字。", "solution": "问题要求我们为给定的三维感兴趣区域（ROI）计算对比度和熵这两个影像组学特征。该过程涉及构建灰度共生矩阵（GLCM），对其进行归一化，然后应用特征定义。\n\n### 步骤1：问题验证\n\n首先根据所需标准验证问题。\n\n*   **提取已知条件**：\n    *   ROI：一个 $2 \\times 2 \\times 2$ 的体素网格，坐标为 $(x,y,z)$，其中 $x,y,z \\in \\{1,2\\}$。\n    *   灰度级：$G = \\{1, 2, 3\\}$。\n    *   ROI数据：设 $V(x,y,z)$ 为坐标 $(x,y,z)$ 处的灰度级。\n        *   切片 $z=1$：$V(1,1,1)=1$，$V(2,1,1)=2$，$V(1,2,1)=2$，$V(2,2,1)=1$。\n        *   切片 $z=2$：$V(1,1,2)=2$，$V(2,1,2)=3$，$V(1,2,2)=1$，$V(2,2,2)=2$。\n    *   GLCM参数：\n        *   距离 $d=1$ 通过指定的13个方向向量 $\\mathbf{v}$ 的集合来解释：\n        $\\{(1,0,0),(0,1,0),(0,0,1),(1,1,0),(1,-1,0),(1,0,1),(1,0,-1),(0,1,1),(0,1,-1),(1,1,1),(1,1,-1),(1,-1,1),(1,-1,-1)\\}$.\n        *   对称化：对于找到的每个共生对 $(i,j)$，GLCM中 $(i,j)$ 和 $(j,i)$ 的计数均增加1。\n        *   归一化：最终的GLCM除以其所有项的总和。\n    *   特征公式：\n        *   对比度：$C = \\sum_{i=1}^{3}\\sum_{j=1}^{3} (i-j)^{2}\\, P(i,j)$\n        *   熵：$H = -\\sum_{i=1}^{3}\\sum_{j=1}^{3} P(i,j)\\, \\ln\\!\\big(P(i,j)\\big)$\n\n*   **验证结论**：问题是**有效的**。它在科学上基于影像组学的原理，问题提出得很好，提供了所有必要的信息和明确的指令，并且其表述是客观的。这是一个标准的、尽管规模较小的纹理分析计算。\n\n### 步骤2：构建共生矩阵\n\n我们系统地遍历ROI中的8个体素 $\\mathbf{p}$ 和13个方向向量 $\\mathbf{v}$ 中的每一个。对于每一对 $(\\mathbf{p}, \\mathbf{v})$，我们检查相邻体素 $\\mathbf{q} = \\mathbf{p} + \\mathbf{v}$ 是否在ROI边界内。如果是，我们记录灰度级对 $(i,j) = (V(\\mathbf{p}), V(\\mathbf{q}))$。\n\n8个体素及其灰度级为：\n$V(1,1,1)=1, V(2,1,1)=2, V(1,2,1)=2, V(2,2,1)=1$\n$V(1,1,2)=2, V(2,1,2)=3, V(1,2,2)=1, V(2,2,2)=2$\n\n为每个方向找到的共生对如下：\n*   $\\mathbf{v}=(1,0,0)$: $(1,2), (2,1), (2,3), (1,2)$\n*   $\\mathbf{v}=(0,1,0)$: $(1,2), (2,1), (2,1), (3,2)$\n*   $\\mathbf{v}=(0,0,1)$: $(1,2), (2,3), (2,1), (1,2)$\n*   $\\mathbf{v}=(1,1,0)$: $(1,1), (2,2)$\n*   $\\mathbf{v}=(1,-1,0)$: $(2,2), (1,3)$\n*   $\\mathbf{v}=(1,0,1)$: $(1,3), (2,2)$\n*   $\\mathbf{v}=(1,0,-1)$: $(2,2), (1,1)$\n*   $\\mathbf{v}=(0,1,1)$: $(1,1), (2,2)$\n*   $\\mathbf{v}=(0,1,-1)$: $(2,2), (3,1)$\n*   $\\mathbf{v}=(1,1,1)$: $(1,2)$\n*   $\\mathbf{v}=(1,1,-1)$: $(2,1)$\n*   $\\mathbf{v}=(1,-1,1)$: $(2,3)$\n*   $\\mathbf{v}=(1,-1,-1)$: $(1,2)$\n\n总共找到了28个有效的共生对。统计这些对可以得到非对称矩阵 $M$ 的计数，其中 $M_{ij}$ 是对 $(i,j)$ 出现的次数：\n*   $(1,1)$ 的计数：$3$\n*   $(1,2)$ 的计数：$7$\n*   $(1,3)$ 的计数：$2$\n*   $(2,1)$ 的计数：$5$\n*   $(2,2)$ 的计数：$6$\n*   $(2,3)$ 的计数：$3$\n*   $(3,1)$ 的计数：$1$\n*   $(3,2)$ 的计数：$1$\n*   $(3,3)$ 的计数：$0$\n\n这给出了矩阵 $M$：\n$$\nM = \\begin{pmatrix} 3  7  2 \\\\ 5  6  3 \\\\ 1  1  0 \\end{pmatrix}\n$$\n问题指出，对于找到的每一对，我们都增加 $(i,j)$ 和 $(j,i)$ 的计数。这等同于通过将 $M$ 与其转置 $M^T$ 相加来创建一个对称矩阵 $S$。\n$$\nS = M + M^T = \\begin{pmatrix} 3  7  2 \\\\ 5  6  3 \\\\ 1  1  0 \\end{pmatrix} + \\begin{pmatrix} 3  5  1 \\\\ 7  6  1 \\\\ 2  3  0 \\end{pmatrix} = \\begin{pmatrix} 6  12  3 \\\\ 12  12  4 \\\\ 3  4  0 \\end{pmatrix}\n$$\n$S$中的总计数 $N_{total}$ 是其所有元素的总和：\n$N_{total} = 6+12+3+12+12+4+3+4+0 = 56$。正如预期的那样，这是共生对数量（28）的2倍。\n\n### 步骤3：归一化与特征计算\n\n归一化的GLCM，$P$，通过将 $S$ 的每个元素除以 $N_{total}=56$ 得到：\n$$\nP = \\frac{1}{56} S = \\frac{1}{56} \\begin{pmatrix} 6  12  3 \\\\ 12  12  4 \\\\ 3  4  0 \\end{pmatrix} = \\begin{pmatrix} 6/56  12/56  3/56 \\\\ 12/56  12/56  4/56 \\\\ 3/56  4/56  0 \\end{pmatrix}\n$$\n\n**对比度 (C)**\n对比度使用公式 $C = \\sum_{i,j} (i-j)^2 P(i,j)$ 计算。\n$$\nC = (1-1)^2 P(1,1) + (1-2)^2 P(1,2) + (1-3)^2 P(1,3) + \\dots\n$$\n我们可以按 $(i-j)^2$ 的值对各项进行分组：\n*   对角元素 $(i-j)^2 = 0$。\n*   $P(1,2), P(2,1), P(2,3), P(3,2)$ 的 $(i-j)^2 = 1$。\n*   $P(1,3), P(3,1)$ 的 $(i-j)^2 = 4$。\n\n$C = 1^2 \\cdot \\left(P(1,2) + P(2,1) + P(2,3) + P(3,2)\\right) + 2^2 \\cdot \\left(P(1,3) + P(3,1)\\right)$\n$C = 1 \\cdot \\left(\\frac{12}{56} + \\frac{12}{56} + \\frac{4}{56} + \\frac{4}{56}\\right) + 4 \\cdot \\left(\\frac{3}{56} + \\frac{3}{56}\\right)$\n$C = \\frac{32}{56} + 4 \\cdot \\frac{6}{56} = \\frac{32}{56} + \\frac{24}{56} = \\frac{56}{56} = 1$\n所以，对比度 $C$ 恰好是 $1$。\n\n**熵 (H)**\n熵使用公式 $H = -\\sum_{i,j} P(i,j) \\ln(P(i,j))$ 计算，约定 $0 \\ln(0) = 0$。\n矩阵 $P$ 中的非零概率为：\n$P(1,1) = 6/56$\n$P(1,2) = P(2,1) = P(2,2) = 12/56$\n$P(1,3) = P(3,1) = 3/56$\n$P(2,3) = P(3,2) = 4/56$\n\n$H = - \\left[ P(1,1)\\ln P(1,1) + 3 \\cdot P(1,2)\\ln P(1,2) + 2 \\cdot P(1,3)\\ln P(1,3) + 2 \\cdot P(2,3)\\ln P(2,3) \\right]$\n$H = - \\left[ \\frac{6}{56}\\ln\\left(\\frac{6}{56}\\right) + 3\\frac{12}{56}\\ln\\left(\\frac{12}{56}\\right) + 2\\frac{3}{56}\\ln\\left(\\frac{3}{56}\\right) + 2\\frac{4}{56}\\ln\\left(\\frac{4}{56}\\right) \\right]$\n$H = - \\frac{1}{56} \\left[ 6\\ln\\left(\\frac{6}{56}\\right) + 36\\ln\\left(\\frac{12}{56}\\right) + 6\\ln\\left(\\frac{3}{56}\\right) + 8\\ln\\left(\\frac{4}{56}\\right) \\right]$\n使用性质 $\\ln(a/b) = \\ln(a)-\\ln(b)$，并合并各项：\n$H = - \\frac{1}{56} [ (6\\ln 6 + 36\\ln 12 + 6\\ln 3 + 8\\ln 4) - (6+36+6+8)\\ln 56 ]$\n$H = - \\frac{1}{56} [ (6\\ln 6 + 36\\ln 12 + 6\\ln 3 + 8\\ln 4) - 56\\ln 56 ]$\n$H = \\ln(56) - \\frac{1}{56} (6\\ln 6 + 36\\ln 12 + 6\\ln 3 + 8\\ln 4)$\n计算数值：\n$\\ln(56) \\approx 4.02535$\n第二项：\n$\\frac{1}{56} (6\\ln 6 + 36\\ln 12 + 6\\ln 3 + 8\\ln 4) \\approx \\frac{1}{56}(6(1.79176) + 36(2.48491) + 6(1.09861) + 8(1.38629))$\n$\\approx \\frac{1}{56}(10.75056 + 89.45676 + 6.59166 + 11.09032) \\approx \\frac{117.8893}{56} \\approx 2.10517$\n$H \\approx 4.02535 - 2.10517 \\approx 1.92018$\n\n### 步骤4：最终答案\n\n问题要求将结果四舍五入到四位有效数字。\n$C = 1.000$\n$H \\approx 1.920$\n\n最终答案表示为行向量 $(C \\ \\ H)$。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n1.000  1.920\n\\end{pmatrix}\n}\n$$", "id": "4834547"}, {"introduction": "掌握了影像组学特征的计算方法后，理解这些特征的生物学意义同样重要。本练习通过对比均质与非均质两种不同纹理区域的一阶和二阶“能量”特征，揭示了影像组学指标如何量化区分不同的组织特性。这有助于培养将抽象数值与具体病理学模式联系起来的直觉。[@problem_id:4834622]", "problem": "一个放射组学模块正在一个医学信息学流程中与卷积神经网络（CNN）集成，用于分析磁共振成像（MRI）感兴趣区域内的纹理。提取了两个方形图像块：一个视觉上同质的（图像块 $\\mathcal{H}$，例如坏死核心）和一个视觉上异质的（图像块 $\\mathcal{G}$，例如纤维化边缘）。两个图像块中的强度值都被量化为四个灰度级 $i \\in \\{0,1,2,3\\}$。现提供归一化的一阶灰度概率质量函数 $p_{\\mathcal{H}}(i)$ 和 $p_{\\mathcal{G}}(i)$，以及在单一固定空间偏移量下归一化的灰度共生矩阵（GLCM）$P_{\\mathcal{H}}(i,j)$ 和 $P_{\\mathcal{G}}(i,j)$。所有矩阵和分布均已归一化，因此 $\\sum_{i} p(i) = 1$ 且 $\\sum_{i,j} P(i,j) = 1$。\n\n提供的分布如下：\n$$\np_{\\mathcal{H}}(i) = \\begin{pmatrix} 0.78 \\\\ 0.09 \\\\ 0.06 \\\\ 0.07 \\end{pmatrix}, \\quad\nP_{\\mathcal{H}}(i,j) = \\begin{pmatrix}\n0.68  0.06  0.02  0.02 \\\\\n0.04  0.03  0.01  0.01 \\\\\n0.02  0.01  0.02  0.01 \\\\\n0.02  0.01  0.01  0.03\n\\end{pmatrix},\n$$\n$$\np_{\\mathcal{G}}(i) = \\begin{pmatrix} 0.26 \\\\ 0.25 \\\\ 0.25 \\\\ 0.24 \\end{pmatrix}, \\quad\nP_{\\mathcal{G}}(i,j) = \\begin{pmatrix}\n0.08  0.06  0.06  0.06 \\\\\n0.06  0.06  0.06  0.07 \\\\\n0.06  0.06  0.06  0.07 \\\\\n0.06  0.07  0.07  0.04\n\\end{pmatrix}.\n$$\n\n放射组学一阶能量定义为 $E^{(1)} = \\sum_{i} p(i)^{2}$，灰度共生矩阵（GLCM）能量定义为 $E^{(2)} = \\sum_{i,j} P(i,j)^{2}$。请仅使用给定的归一化分布，并从核心概率定义出发，计算：\n$$\nD \\equiv \\frac{E^{(1)}_{\\mathcal{H}}}{E^{(2)}_{\\mathcal{H}}} - \\frac{E^{(1)}_{\\mathcal{G}}}{E^{(2)}_{\\mathcal{G}}}.\n$$\n\n将最终结果表示为一个无量纲实数，并四舍五入到四位有效数字。", "solution": "用户要求计算一个复合放射组学特征 $D$，它被定义为源自同质图像块 $\\mathcal{H}$ 和异质图像块 $\\mathcal{G}$ 的两个能量度量比率之差。该问题在医学图像分析（放射组学）方面具有科学依据，提供了所有必要的数值数据和定义，并且内部一致。提供的概率分布 $p(i)$ 和 $P(i,j)$ 已被正确归一化。该问题是有效且适定的。\n\n需要计算的量为：\n$$\nD \\equiv \\frac{E^{(1)}_{\\mathcal{H}}}{E^{(2)}_{\\mathcal{H}}} - \\frac{E^{(1)}_{\\mathcal{G}}}{E^{(2)}_{\\mathcal{G}}}\n$$\n这需要计算四个独立的能量项，我们将系统地进行计算。\n\n首先，我们计算同质图像块 $\\mathcal{H}$ 的能量项。\n\n一阶能量 $E^{(1)}_{\\mathcal{H}}$ 定义为灰度直方图概率的平方和。\n$$\nE^{(1)}_{\\mathcal{H}} = \\sum_{i=0}^{3} p_{\\mathcal{H}}(i)^{2}\n$$\n使用提供的分布 $p_{\\mathcal{H}}(i) = (0.78, 0.09, 0.06, 0.07)^T$：\n$$\nE^{(1)}_{\\mathcal{H}} = (0.78)^{2} + (0.09)^{2} + (0.06)^{2} + (0.07)^{2}\n$$\n$$\nE^{(1)}_{\\mathcal{H}} = 0.6084 + 0.0081 + 0.0036 + 0.0049 = 0.6250\n$$\n\nGLCM 能量 $E^{(2)}_{\\mathcal{H}}$ 定义为灰度共生矩阵 $P_{\\mathcal{H}}(i,j)$ 中各元素的平方和。\n$$\nE^{(2)}_{\\mathcal{H}} = \\sum_{i=0}^{3} \\sum_{j=0}^{3} P_{\\mathcal{H}}(i,j)^{2}\n$$\n使用提供的矩阵：\n$$\nP_{\\mathcal{H}}(i,j) = \\begin{pmatrix}\n0.68  0.06  0.02  0.02 \\\\\n0.04  0.03  0.01  0.01 \\\\\n0.02  0.01  0.02  0.01 \\\\\n0.02  0.01  0.01  0.03\n\\end{pmatrix}\n$$\n我们将每个元素的平方相加：\n$$\n\\begin{align*} E^{(2)}_{\\mathcal{H}} = (0.68)^2 + (0.06)^2 + (0.02)^2 + (0.02)^2 \\\\ + (0.04)^2 + (0.03)^2 + (0.01)^2 + (0.01)^2 \\\\ + (0.02)^2 + (0.01)^2 + (0.02)^2 + (0.01)^2 \\\\ + (0.02)^2 + (0.01)^2 + (0.01)^2 + (0.03)^2 \\\\ E^{(2)}_{\\mathcal{H}} = ~ 0.4624 + 0.0036 + 0.0004 + 0.0004 \\\\ + 0.0016 + 0.0009 + 0.0001 + 0.0001 \\\\ + 0.0004 + 0.0001 + 0.0004 + 0.0001 \\\\ + 0.0004 + 0.0001 + 0.0001 + 0.0009 \\\\ E^{(2)}_{\\mathcal{H}} = ~ 0.4720\\end{align*}\n$$\n\n接下来，我们计算异质图像块 $\\mathcal{G}$ 的能量项。\n\n一阶能量 $E^{(1)}_{\\mathcal{G}}$ 为：\n$$\nE^{(1)}_{\\mathcal{G}} = \\sum_{i=0}^{3} p_{\\mathcal{G}}(i)^{2}\n$$\n使用提供的分布 $p_{\\mathcal{G}}(i) = (0.26, 0.25, 0.25, 0.24)^T$：\n$$\nE^{(1)}_{\\mathcal{G}} = (0.26)^{2} + (0.25)^{2} + (0.25)^{2} + (0.24)^{2}\n$$\n$$\nE^{(1)}_{\\mathcal{G}} = 0.0676 + 0.0625 + 0.0625 + 0.0576 = 0.2502\n$$\n\nGLCM 能量 $E^{(2)}_{\\mathcal{G}}$ 为：\n$$\nE^{(2)}_{\\mathcal{G}} = \\sum_{i=0}^{3} \\sum_{j=0}^{3} P_{\\mathcal{G}}(i,j)^{2}\n$$\n使用提供的矩阵：\n$$\nP_{\\mathcal{G}}(i,j) = \\begin{pmatrix}\n0.08  0.06  0.06  0.06 \\\\\n0.06  0.06  0.06  0.07 \\\\\n0.06  0.06  0.06  0.07 \\\\\n0.06  0.07  0.07  0.04\n\\end{pmatrix}\n$$\n我们将每个元素的平方相加：\n$$\n\\begin{align*} E^{(2)}_{\\mathcal{G}} = (0.08)^2 + (0.06)^2 + (0.06)^2 + (0.06)^2 \\\\ + (0.06)^2 + (0.06)^2 + (0.06)^2 + (0.07)^2 \\\\ + (0.06)^2 + (0.06)^2 + (0.06)^2 + (0.07)^2 \\\\ + (0.06)^2 + (0.07)^2 + (0.07)^2 + (0.04)^2 \\\\ E^{(2)}_{\\mathcal{G}} = ~ 0.0064 + 0.0036 + 0.0036 + 0.0036 \\\\ + 0.0036 + 0.0036 + 0.0036 + 0.0049 \\\\ + 0.0036 + 0.0036 + 0.0036 + 0.0049 \\\\ + 0.0036 + 0.0049 + 0.0049 + 0.0016 \\\\ E^{(2)}_{\\mathcal{G}} = ~ 0.0636\\end{align*}\n$$\n\n最后，我们将这些值代入其定义中，以计算目标量 $D$。\n$$\nD = \\frac{E^{(1)}_{\\mathcal{H}}}{E^{(2)}_{\\mathcal{H}}} - \\frac{E^{(1)}_{\\mathcal{G}}}{E^{(2)}_{\\mathcal{G}}} = \\frac{0.6250}{0.4720} - \\frac{0.2502}{0.0636}\n$$\n分别计算各项：\n$$\n\\frac{0.6250}{0.4720} \\approx 1.32415254...\n$$\n$$\n\\frac{0.2502}{0.0636} \\approx 3.93396226...\n$$\n用第一项减去第二项：\n$$\nD \\approx 1.32415254... - 3.93396226... \\approx -2.60980972...\n$$\n题目要求结果四舍五入到四位有效数字。四位有效数字是 $2$、$6$、$0$ 和 $9$。第五位有效数字是 $8$，大于或等于 $5$，因此我们将最后一位有效数字向上取整。\n$$\nD \\approx -2.610\n$$\n末尾的零是有效数字，必须包含在内。", "answer": "$$\\boxed{-2.610}$$", "id": "4834622"}, {"introduction": "将深度学习模型应用于三维医学图像分析时，硬件资源（特别是GPU显存）往往是主要瓶颈。本练习模拟了一个在部署三维U-Net模型前进行资源评估的真实场景，要求你估算模型的内存占用和计算需求。掌握这种估算能力是设计和实现可在现有硬件上有效训练的深度学习模型的关键工程技能。[@problem_id:4834626]", "problem": "一个用于计算机断层扫描 (CT) 的放射组学驱动的三维肿瘤分割流程使用一个三维 U-Net，从一个大小为 $256 \\times 256 \\times 256$ 体素的单通道体积感兴趣区域 (ROI) 生成一个二值掩码。该架构具体如下：编码器有 $5$ 个分辨率级别，每个级别有两个三维卷积，使用 $3 \\times 3 \\times 3$ 的卷积核大小、步幅为 $1$ 以及保持空间维度的填充。输入级别的基础特征通道数为 $C_0 = 32$，并且在每个下采样步骤后通道数加倍：$\\{32, 64, 128, 256, 512\\}$。级别之间的下采样通过大小为 $2 \\times 2 \\times 2$、步幅为 $2$ 的最大池化来执行。解码器与编码器镜像对称：每个级别以一个三维转置卷积（卷积核大小 $2 \\times 2 \\times 2$，步幅 $2$）开始，以进行上采样并将通道数减半，然后与编码器的跳跃连接进行拼接，再接两个三维卷积，其卷积核大小为 $3 \\times 3 \\times 3$，步幅为 $1$，并使用保持空间维度的填充。最终输出层是一个 $1 \\times 1 \\times 1$ 的卷积，将 $32$ 个通道映射到 $1$ 个输出通道。所有激活和参数都以单精度浮点（$32$ 位）格式存储，每个元素占用 $4$ 字节。训练使用无动量的随机梯度下降 (SGD)：存储权重及其梯度，忽略优化器的辅助状态。假设所有中间卷积输出都被保留，直到在反向传播中计算出它们的梯度，并在基础估算中忽略框架工作空间和内核启动开销。\n\n使用以下基本定义：张量所需的内存等于其元素数量乘以每元素的字节数，以及对于一个在大小为 $D \\times H \\times W$ 的空间网格上，将输入通道 $C_{\\mathrm{in}}$ 转换为输出通道 $C_{\\mathrm{out}}$，卷积核大小为 $k \\times k \\times k$ 的三维卷积的浮点运算次数等于 $2 \\cdot D \\cdot H \\cdot W \\cdot C_{\\mathrm{in}} \\cdot C_{\\mathrm{out}} \\cdot k^3$，请执行以下操作：\n\n1. 从第一性原理推导，在训练期间对于批量大小 $B$ 所需的激活内存的通用表达式，该表达式是编码器、解码器和最终输出层中所有卷积层输出的总和。使用约定 $1\\,\\mathrm{GB} = 10^9$ 字节，以千兆字节为单位表示结果。\n2. 在此架构规范下，数值计算（不进行四舍五入）批量大小 $B = 1$ 时的总激活内存。然后计算参数内存和参数梯度内存，并将它们相加以获得以千兆字节为单位的基础视频随机存取存储器 (VRAM) 总估算值。\n3. 一块图形处理单元 (GPU) 拥有 $12$ GB 的 VRAM。为了考虑基础估算中未包含的运行时开销（框架工作空间、CUDA cudnn 缓冲区、非模型分配），在与硬件限制进行比较之前，通过将基础 VRAM 估算值乘以 $1.1$ 的保守余量因子来计算。确定在此余量下，能够适应 $12$ GB VRAM 限制的最大整数批量大小 $B_{\\max}$。提供 $B_{\\max}$ 作为您的最终答案。\n4. 简要论证至少两种可在不减小输入空间大小的情况下，使训练适应 $12$ GB VRAM 限制的策略。\n\nVRAM 量以千兆字节表示。中间内存估算无需四舍五入。最终答案必须是单个整数 $B_{\\max}$。", "solution": "在尝试任何解决方案之前，需对问题进行验证。\n\n### 步骤 1：提取已知条件\n- **模型**：用于肿瘤分割的三维 U-Net。\n- **输入**：大小为 $256 \\times 256 \\times 256$ 体素的单通道体积感兴趣区域 (ROI)。\n- **数据精度**：单精度浮点（$32$ 位），每个元素占用 $4$ 字节。\n- **编码器架构**：\n    - $5$ 个分辨率级别。\n    - 每个级别 $2$ 个三维卷积。\n    - 卷积核大小：$3 \\times 3 \\times 3$，步幅 $1$，带保持空间维度的填充。\n    - 基础特征通道数：$C_0 = 32$。\n    - 通道演进：$\\{32, 64, 128, 256, 512\\}$。\n    - 下采样：大小为 $2 \\times 2 \\times 2$、步幅为 $2$ 的最大池化。\n- **解码器架构**：\n    - 与编码器结构镜像对称。\n    - 上采样：三维转置卷积，卷积核大小 $2 \\times 2 \\times 2$，步幅 $2$，通道数减半。\n    - 随后与编码器的跳跃连接进行拼接。\n    - 随后是 $2$ 个三维卷积，卷积核大小 $3 \\times 3 \\times 3$，步幅 $1$，带保持空间维度的填充。\n- **最终层**：一个 $1 \\times 1 \\times 1$ 卷积，将 $32$ 个通道映射到 $1$ 个输出通道。\n- **训练内存假设**：\n    - 批量大小由 $B$ 表示。\n    - 训练使用无动量的随机梯度下降 (SGD)。\n    - 内存存储权重及其梯度。忽略优化器辅助状态。\n    - 所有中间卷积输出都为反向传播而保留。\n    - 基础估算中忽略框架开销。\n- **定义**：\n    - 张量内存 = (元素数量) $\\times$ (每元素字节数)。\n    - $1\\,\\mathrm{GB} = 10^9$ 字节。\n- **硬件与约束**：\n    - GPU 显存：$12$ GB。\n    - 余量因子：$1.1$。\n- **任务**：\n    1. 推导批量大小为 $B$ 时的激活内存的通用表达式。\n    2. 计算 $B = 1$ 时的基础 VRAM 总量。\n    3. 确定最大整数批量大小 $B_{\\max}$。\n    4. 论证两种在 VRAM 限制内进行训练的策略。\n\n### 步骤 2：使用提取的已知条件进行验证\n该问题具有科学依据，描述了一个标准的深度学习架构（三维 U-Net）和一个常见的工程任务（计算内存需求）。诸如输入维度和通道数等参数对于医学成像应用是合理的。问题是适定的，提供了执行所需计算的所有必要定义、常数和架构细节。语言客观、正式。它没有违反任何科学原理，不基于错误的前提，也不包含任何矛盾。所需的计算并非微不足道，代表了部署深度学习模型时的一个现实挑战。\n\n### 步骤 3：结论与行动\n该问题被认为是**有效的**。将提供完整解答。\n\n### 解答推导\n\n我们首先为 U-Net 架构定义符号。\n设 $i \\in \\{0, 1, 2, 3, 4\\}$ 为编码器中分辨率级别的索引。\n级别 $i$ 的空间维度是 $S_i$。输入大小为 $S_0 = 256$。通过步幅为 $2$ 的最大池化，$S_i = \\frac{S_0}{2^i} = \\frac{256}{2^i}$。\n级别 $i$ 的输出通道数是 $C_i$。基础通道数为 $C_0=32$，每个级别通道数加倍，因此 $C_i = C_0 \\cdot 2^i = 32 \\cdot 2^i$。\n单个元素（一个 $32$ 位浮点数）的内存为 $M_{elem} = 4$ 字节。\n激活内存是反向传播所需的所有中间层输出所需的存储空间。\n\n**1. 激活内存的通用表达式**\n\n对于批量大小 $B$，总激活内存 $M_{act}(B)$ 是编码器、解码器和最终层激活内存的总和。\n\n**编码器激活内存 ($M_{enc}$)**\n在每个级别 $i \\in \\{0, 1, 2, 3, 4\\}$，有两个卷积层。由于填充保持了空间维度，两个层都产生一个大小为 $B \\times S_i \\times S_i \\times S_i \\times C_i$ 的输出张量。\n级别 $i$ 的两个卷积输出的内存为 $2 \\cdot B \\cdot S_i^3 \\cdot C_i \\cdot M_{elem}$。\n编码器的总激活内存是所有 $5$ 个级别的总和：\n$$M_{enc}(B) = \\sum_{i=0}^{4} 2 \\cdot B \\cdot S_i^3 \\cdot C_i \\cdot M_{elem}$$\n\n**解码器激活内存 ($M_{dec}$)**\n解码器有 $4$ 个级别，对应于编码器级别 $i \\in \\{0, 1, 2, 3\\}$。在每个级别，它执行一次上采样（转置卷积）、一次拼接和两次常规卷积。我们必须存储每个卷积操作的输出。\n在解码器级别 $j \\in \\{0, 1, 2, 3\\}$，过程如下：\n1.  通过转置卷积进行上采样：输出张量的维度为 $B \\times S_j^3 \\times C_j$。内存：$B \\cdot S_j^3 \\cdot C_j \\cdot M_{elem}$。\n2.  与来自编码器级别 $j$ 的跳跃连接（其维度为 $B \\times S_j^3 \\times C_j$）进行拼接。\n3.  随后的两个卷积都产生维度为 $B \\times S_j^3 \\times C_j$ 的输出张量。两者的内存为：$2 \\cdot B \\cdot S_j^3 \\cdot C_j \\cdot M_{elem}$。\n因此，对于 $4$ 个解码器级别中的每一个，我们存储一个转置卷积和两个常规卷积的输出，它们的大小均为 $B \\times S_j^3 \\times C_j$。\n每个解码器级别 $j$ 的总内存为 $3 \\cdot B \\cdot S_j^3 \\cdot C_j \\cdot M_{elem}$。\n解码器的总激活内存是这 $4$ 个级别的总和：\n$$M_{dec}(B) = \\sum_{j=0}^{3} 3 \\cdot B \\cdot S_j^3 \\cdot C_j \\cdot M_{elem}$$\n\n**最终层激活内存 ($M_{final}$)**\n最终的 $1 \\times 1 \\times 1$ 卷积接收最后一个解码器级别的输出（大小为 $B \\times S_0^3 \\times C_0$），并将其映射到单个通道。输出张量的维度为 $B \\times S_0^3 \\times 1$。\n$$M_{final}(B) = B \\cdot S_0^3 \\cdot 1 \\cdot M_{elem}$$\n\n**总激活内存 ($M_{act}$)**\n$$M_{act}(B) = M_{enc}(B) + M_{dec}(B) + M_{final}(B)$$\n$$M_{act}(B) = \\left( \\sum_{i=0}^{4} 2 S_i^3 C_i \\right) B \\cdot M_{elem} + \\left( \\sum_{j=0}^{3} 3 S_j^3 C_j \\right) B \\cdot M_{elem} + (S_0^3) B \\cdot M_{elem}$$\n我们可以合并公共索引 $i, j \\in \\{0, 1, 2, 3\\}$ 上的求和。\n$$M_{act}(B) = B \\cdot M_{elem} \\left( \\sum_{i=0}^{3} (2 S_i^3 C_i + 3 S_i^3 C_i) + 2 S_4^3 C_4 + S_0^3 \\right)$$\n$$M_{act}(B) = B \\cdot M_{elem} \\left( \\sum_{i=0}^{3} 5 S_i^3 C_i + 2 S_4^3 C_4 + S_0^3 \\right)$$\n让我们代入 $S_i = S_0 / 2^i$ 和 $C_i = C_0 \\cdot 2^i$。乘积 $S_i^3 C_i = (S_0/2^i)^3 (C_0 \\cdot 2^i) = (S_0^3 C_0) / 4^i$。\n$$M_{act}(B) = B \\cdot M_{elem} \\left( 5 S_0^3 C_0 \\sum_{i=0}^{3} \\frac{1}{4^i} + 2 \\frac{S_0^3 C_0}{4^4} + S_0^3 \\right)$$\n几何级数之和为 $\\sum_{i=0}^{3} (1/4)^i = \\frac{1-(1/4)^4}{1-1/4} = \\frac{1-1/256}{3/4} = \\frac{255/256}{3/4} = \\frac{85}{64}$。\n$$M_{act}(B) = B \\cdot M_{elem} \\cdot S_0^3 \\left( 5 C_0 \\frac{85}{64} + \\frac{2 C_0}{256} + 1 \\right)$$\n代入 $S_0 = 256$，$C_0 = 32$，$M_{elem} = 4$ 字节，并转换为 GB（$1\\,\\mathrm{GB} = 10^9$ 字节）：\n$$M_{act}(B) = \\frac{B \\cdot 4 \\cdot 256^3}{10^9} \\left( 5 \\cdot 32 \\cdot \\frac{85}{64} + \\frac{2 \\cdot 32}{256} + 1 \\right)$$\n$$M_{act}(B) = \\frac{B \\cdot 4 \\cdot 16777216}{10^9} \\left( \\frac{5 \\cdot 32 \\cdot 85}{64} + \\frac{64}{256} + 1 \\right) = \\frac{B \\cdot 67108864}{10^9} \\left( 212.5 + 0.25 + 1 \\right)$$\n$$M_{act}(B) = \\frac{B \\cdot 67108864 \\cdot 213.75}{10^9} = B \\cdot \\frac{14344519680}{10^9} = B \\cdot 14.34451968 \\,\\mathrm{GB}$$\n\n**2. B=1 时的基础 VRAM 总量**\n\n当 $B=1$ 时，激活内存为 $M_{act}(1) = 14.34451968\\,\\mathrm{GB}$。\n\n接下来，我们计算参数 ($M_{params}$) 及其梯度 ($M_{grads}$) 的内存。$M_{total}(B) = M_{act}(B) + M_{params} + M_{grads}$。由于使用无动量的 SGD，所以 $M_{grads} = M_{params}$。\n一个卷积层（包括偏置）的参数数量为 $N = C_{in} \\cdot C_{out} \\cdot k_D \\cdot k_H \\cdot k_W + C_{out}$。\n\n**参数计算：**\n- **编码器 ($k=3$):**\n    - L0: $(1 \\cdot 32 \\cdot 3^3 + 32) + (32 \\cdot 32 \\cdot 3^3 + 32) = 28576$\n    - L1: $(32 \\cdot 64 \\cdot 3^3 + 64) + (64 \\cdot 64 \\cdot 3^3 + 64) = 166016$\n    - L2: $(64 \\cdot 128 \\cdot 3^3 + 128) + (128 \\cdot 128 \\cdot 3^3 + 128) = 663808$\n    - L3: $(128 \\cdot 256 \\cdot 3^3 + 256) + (256 \\cdot 256 \\cdot 3^3 + 256) = 2654720$\n    - L4: $(256 \\cdot 512 \\cdot 3^3 + 512) + (512 \\cdot 512 \\cdot 3^3 + 512) = 10617856$\n    - $N_{enc} = 14130976$ 个参数。\n- **解码器：**\n    - L3: 转置卷积 ($k=2$, $C_{in}=512, C_{out}=256$): $512 \\cdot 256 \\cdot 2^3 + 256 = 1048832$。卷积1 ($k=3$, $C_{in}=512, C_{out}=256$): $512 \\cdot 256 \\cdot 3^3 + 256 = 3539200$。卷积2 ($k=3$, $C_{in}=256, C_{out}=256$): $256 \\cdot 256 \\cdot 3^3 + 256 = 1769728$。总计: $6357760$。\n    - L2: ($C_{up,in}=256, C_{out}=128$), ($C_{c1,in}=256, C_{out}=128$), ($C_{c2,in}=128, C_{out}=128$)。总计: $262272 + 884864 + 442496 = 1589632$。\n    - L1: ($C_{up,in}=128, C_{out}=64$), ($C_{c1,in}=128, C_{out}=64$), ($C_{c2,in}=64, C_{out}=64$)。总计: $65600 + 221248 + 110656 = 397504$。\n    - L0: ($C_{up,in}=64, C_{out}=32$), ($C_{c1,in}=64, C_{out}=32$), ($C_{c2,in}=32, C_{out}=32$)。总计: $16416 + 55328 + 27680 = 99424$。\n    - $N_{dec} = 8444320$ 个参数。\n- **最终层：** $1 \\times 1 \\times 1$ 卷积 ($C_{in}=32, C_{out}=1$): $32 \\cdot 1 \\cdot 1^3 + 1 = 33$ 个参数。\n- **总参数：** $N_{total} = N_{enc} + N_{dec} + N_{final} = 14130976 + 8444320 + 33 = 22575329$。\n- **参数和梯度内存：**\n    $M_{params} + M_{grads} = 2 \\cdot N_{total} \\cdot M_{elem} = 2 \\cdot 22575329 \\cdot 4 = 180602632$ 字节。\n    以 GB 计: $180602632 / 10^9 = 0.180602632\\,\\mathrm{GB}$。\n- **B=1 时的基础 VRAM 总量：**\n    $M_{total}(1) = M_{act}(1) + (M_{params} + M_{grads}) / 10^9 = 14.34451968 + 0.180602632 = 14.525122312\\,\\mathrm{GB}$。\n\n**3. 最大整数批量大小 ($B_{\\max}$)**\n\n总分配内存必须在 GPU 的 VRAM 限制之内，包括 $1.1$ 的余量因子。\n设 $V_{lim} = 12\\,\\mathrm{GB} = 12 \\times 10^9$ 字节。\n约束条件是：$1.1 \\cdot M_{total}(B) \\le V_{lim}$。\n$$1.1 \\cdot (B \\cdot M_{act, B=1} + (M_{params} + M_{grads})) \\le 12 \\times 10^9$$\n$$1.1 \\cdot (B \\cdot 14344519680 + 180602632) \\le 12 \\times 10^9$$\n$$B \\cdot 14344519680 + 180602632 \\le \\frac{12 \\times 10^9}{1.1} \\approx 10909090909.09$$\n$$B \\cdot 14344519680 \\le 10909090909.09 - 180602632 = 10728488277.09$$\n$$B \\le \\frac{10728488277.09}{14344519680} \\approx 0.7479$$\n最大整数批量大小 $B$ 必须小于或等于 $0.7479$。因此，最大整数批量大小为 $B_{\\max} = 0$。这表明在给定条件下，使用指定的硬件以批量大小为 $1$ 或更大进行训练是不可行的。\n\n**4. 减少 VRAM 的策略**\n\n为了在不减小输入空间大小的情况下使训练过程适应 $12$ GB VRAM 的限制，可以采用几种策略。以下是两种：\n\n1.  **混合精度训练**：问题指定所有张量使用单精度（$32$ 位）浮点数。通过切换到混合精度训练，即主要使用半精度（$16$ 位）浮点数（例如 `FP16`），激活、参数和梯度的内存占用几乎可以减半。由于激活内存是 VRAM 的主要消耗者（在本例中超过 $98\\%$），这种减少将是巨大的。批量大小 $B=1$ 的内存将减少到大约 $14.53 / 2 \\approx 7.27$ GB，即使有 $1.1 \\times$ 的余量（$1.1 \\cdot 7.27 \\approx 7.99$ GB），也能轻松适应 $12$ GB 的限制。\n\n2.  **梯度检查点（激活重计算）**：VRAM 的主要成本是存储前向传播中的所有中间激活，以供反向传播使用。梯度检查点是一种以计算成本换取内存的技术。它不存储所有激活，而是只保存一个策略性选择的子集（检查点）。在反向传播期间，未存储的用于梯度计算的激活会从最近的检查点实时重新计算。这可以极大地减少激活内存需求，通常从与层数成线性关系 $O(L)$ 减少到大约 $O(\\sqrt{L})$，其代价是一次额外的前向传播。鉴于这个三维模型中激活的极端内存消耗，这种方法将非常有效。", "answer": "$$\\boxed{0}$$", "id": "4834626"}]}