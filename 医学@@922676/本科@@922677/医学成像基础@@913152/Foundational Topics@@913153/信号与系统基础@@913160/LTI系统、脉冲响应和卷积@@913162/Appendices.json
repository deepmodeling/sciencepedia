{"hands_on_practices": [{"introduction": "点扩散函数（PSF）是表征线性移不变（LSI）成像系统的基石。但我们如何确定一个真实显微镜的PSF呢？本实践问题将引导您完成一个使用荧光微球的模拟实验，这是光学显微镜中的一种标准技术。通过分析小微球的图像，您将学习如何从测量结果中解卷积出微球自身的尺寸，从而分离并量化系统固有的PSF [@problem_id:4897191]。", "problem": "一台宽场光学显微镜在其成像可被建模为线性移不变 (LSI) 系统的条件下运行，通过类比，这在信号处理中通常也称为线性时不变 (LTI) 系统。物体强度分布 $f(\\mathbf{r})$ 通过点扩散函数 (PSF) $h(\\mathbf{r})$，经由空间卷积成像为测量强度 $m(\\mathbf{r})$。您的任务是设计并分析一个微球体模实验，以估计系统的PSF，并消除由有限微球尺寸引入的展宽效应。\n\n您必须使用的基本原理包括：\n- LSI成像模型的定义：$m(\\mathbf{r}) = (h * f)(\\mathbf{r})$，其中 $*$ 表示空间卷积。\n- PSF作为脉冲状物体的像的定义。\n- 归一化核函数在卷积下的空间矩性质。\n- 高斯函数的参数形式。\n\n按如下方式设计一个合理的实验，并从第一性原理推导反卷积关系：\n1. 考虑已知半径为 $a$ 的荧光微球（beads），它们在其体积内均匀发光。在焦平面上，每个微球可以被建模为一个半径为 $a$ 的均匀圆盘，归一化后积分值为1，即一个面积“顶帽”核函数 $b(\\mathbf{r})$，其支撑集为 $|\\mathbf{r}| \\leq a$，在其他地方为零，且归一化满足 $\\int_{\\mathbb{R}^{2}} b(\\mathbf{r}) \\,\\mathrm{d}\\mathbf{r} = 1$。稀疏地放置微球以避免重叠，并在相同条件下对它们进行成像，以最小化变异性。\n2. 假设显微镜的横向PSF是各向同性的，并且可以很好地用一个零均值高斯函数 $h(\\mathbf{r})$ 来近似，其沿任何横向轴的标准差 $\\sigma_{\\mathrm{sys}}$ 未知。测得的微球图像 $m(\\mathbf{r})$ 是 $h(\\mathbf{r})$ 和 $b(\\mathbf{r})$ 的卷积，您需要用一个高斯函数来拟合穿过微球中心的 $m(\\mathbf{r})$ 的横向截面，从而获得一个测量标准差 $\\sigma_{\\mathrm{meas}}$。\n3. 从上述定义出发，不使用任何简便公式，通过运用归一化核函数卷积的矩性质，并计算均匀圆盘模型的二阶中心矩，推导出 $\\sigma_{\\mathrm{sys}}$ 关于 $\\sigma_{\\mathrm{meas}}$ 和 $a$ 的解析表达式。\n4. 根据您推导出的 $\\sigma_{\\mathrm{sys}}$，求出系统高斯PSF沿一个横向轴的半峰全宽 (FWHM)。\n\n对于一个具体实验，取微球半径为 $a = 120\\,\\mathrm{nm}$，对测得微球图像的高斯拟合给出其横向截面的 $\\sigma_{\\mathrm{meas}} = 200\\,\\mathrm{nm}$。使用您的推导，计算系统PSF的横向FWHM，并以微米为单位表示您的最终数值答案。将您的答案四舍五入到四位有效数字。最终答案必须是一个实数。", "solution": "问题陈述已经过验证，被认为是科学上可靠、定义明确且客观的。它提出了光学显微镜表征中的一个标准任务，可以使用信号处理和统计学的基本原理解决。因此，我们可以进行推导和计算。\n\n问题描述了一个建模为线性移不变 (LSI) 系统的成像过程。测量的图像强度 $m(\\mathbf{r})$ 是物体固有强度分布 $f(\\mathbf{r})$ 与系统点扩散函数 (PSF) $h(\\mathbf{r})$ 的空间卷积。\n$$m(\\mathbf{r}) = (h * f)(\\mathbf{r}) = \\int_{\\mathbb{R}^2} h(\\mathbf{r} - \\mathbf{r'}) f(\\mathbf{r'}) \\, \\mathrm{d}\\mathbf{r'}$$\n在本实验中，物体是一个单一、孤立的荧光微球，被建模为半径为 $a$ 的均匀圆盘。其强度分布（表示为 $b(\\mathbf{r})$）替代了 $f(\\mathbf{r})$。系统的PSF，$h(\\mathbf{r})$，被假设为一个各向同性的零均值高斯函数。最终测得的微球图像是 $m(\\mathbf{r}) = (h * b)(\\mathbf{r})$。$h(\\mathbf{r})$ 和 $b(\\mathbf{r})$ 都被归一化以使其积分为1，这是将它们作为概率密度函数进行矩分析的一个要求。\n\n我们的推导基于这样一个性质：对于两个零均值、归一化函数的卷积，结果函数的方差是各单个函数方差之和。我们首先来证明这个性质。一个归一化的二维函数 $g(x,y)$ 沿x轴的方差是其二阶中心矩。由于函数是零均值的，因此方差为 $\\sigma_{g,x}^2 = \\int_{\\mathbb{R}^2} x^2 g(x,y) \\, \\mathrm{d}x\\mathrm{d}y$。\n测量图像 $m(x,y)$ 沿x轴的方差为：\n$$\\sigma_{m,x}^2 = \\int_{\\mathbb{R}^2} x^2 m(x,y) \\, \\mathrm{d}x\\mathrm{d}y = \\int_{\\mathbb{R}^2} x^2 \\left( \\int_{\\mathbb{R}^2} h(x-x', y-y') b(x',y') \\, \\mathrm{d}x'\\mathrm{d}y' \\right) \\mathrm{d}x\\mathrm{d}y$$\n令 $u = x-x'$ 和 $v = y-y'$，则 $x = u+x'$ 和 $y=v+y'$。微分元 $\\mathrm{d}x\\mathrm{d}y$ 变为 $\\mathrm{d}u\\mathrm{d}v$。\n$$\\sigma_{m,x}^2 = \\int_{\\mathbb{R}^2} \\int_{\\mathbb{R}^2} (u+x')^2 h(u,v) b(x',y') \\, \\mathrm{d}u\\mathrm{d}v \\, \\mathrm{d}x'\\mathrm{d}y'$$\n展开平方项 $(u+x')^2 = u^2 + 2ux' + (x')^2$：\n$$\\sigma_{m,x}^2 = \\int_{\\mathbb{R}^2} \\int_{\\mathbb{R}^2} (u^2 + 2ux' + (x')^2) h(u,v) b(x',y') \\, \\mathrm{d}u\\mathrm{d}v \\, \\mathrm{d}x'\\mathrm{d}y'$$\n我们可以将其分为三项：\n$$1. \\quad \\int_{\\mathbb{R}^2} u^2 h(u,v) \\, \\mathrm{d}u\\mathrm{d}v \\int_{\\mathbb{R}^2} b(x',y') \\, \\mathrm{d}x'\\mathrm{d}y' = \\sigma_{h,x}^2 \\cdot 1 = \\sigma_{h,x}^2$$\n$$2. \\quad 2 \\int_{\\mathbb{R}^2} u h(u,v) \\, \\mathrm{d}u\\mathrm{d}v \\int_{\\mathbb{R}^2} x' b(x',y') \\, \\mathrm{d}x'\\mathrm{d}y' = 2 \\cdot (\\text{mean of } h) \\cdot (\\text{mean of } b) = 2 \\cdot 0 \\cdot 0 = 0$$\n$$3. \\quad \\int_{\\mathbb{R}^2} h(u,v) \\, \\mathrm{d}u\\mathrm{d}v \\int_{\\mathbb{R}^2} (x')^2 b(x',y') \\, \\mathrm{d}x'\\mathrm{d}y' = 1 \\cdot \\sigma_{b,x}^2 = \\sigma_{b,x}^2$$\n将这些项相加，得到方差的可加性：\n$$\\sigma_{m,x}^2 = \\sigma_{h,x}^2 + \\sigma_{b,x}^2$$\n由于PSF和微球模型都具有各向同性，沿任何横向轴的方差都相同，因此我们可以省略下标 $x$。\n问题陈述，测量的轮廓用高斯函数拟合，得到标准差 $\\sigma_{\\mathrm{meas}}$。这对应于 $\\sigma_m$。系统PSF是一个标准差为 $\\sigma_{\\mathrm{sys}}$ 的高斯函数，这对应于 $\\sigma_h$。因此，关系式为：\n$$\\sigma_{\\mathrm{meas}}^2 = \\sigma_{\\mathrm{sys}}^2 + \\sigma_{b}^2$$\n\n接下来，我们必须计算微球的均匀圆盘模型的方差 $\\sigma_{b}^2$。微球是一个半径为 $a$ 的均匀圆盘。其强度分布 $b(\\mathbf{r})$ 由下式给出：\n$$b(x,y) = \\begin{cases} C  \\text{if } x^2+y^2 \\leq a^2 \\\\ 0  \\text{otherwise} \\end{cases}$$\n归一化条件 $\\int_{\\mathbb{R}^2} b(x,y) \\, \\mathrm{d}x\\mathrm{d}y = 1$ 要求 $C \\cdot (\\pi a^2) = 1$，所以 $C = \\frac{1}{\\pi a^2}$。该模型关于原点对称，所以其均值为零。沿x轴的方差为：\n$$\\sigma_{b}^2 = \\int_{\\mathbb{R}^2} x^2 b(x,y) \\, \\mathrm{d}x\\mathrm{d}y = \\frac{1}{\\pi a^2} \\iint_{x^2+y^2 \\leq a^2} x^2 \\, \\mathrm{d}x\\mathrm{d}y$$\n我们转换为极坐标，其中 $x = r\\cos\\theta$ 且 $\\mathrm{d}x\\mathrm{d}y = r\\,\\mathrm{d}r\\mathrm{d}\\theta$。\n$$\\sigma_{b}^2 = \\frac{1}{\\pi a^2} \\int_0^{2\\pi} \\int_0^a (r\\cos\\theta)^2 r \\, \\mathrm{d}r\\mathrm{d}\\theta = \\frac{1}{\\pi a^2} \\int_0^{2\\pi} \\int_0^a r^3 \\cos^2\\theta \\, \\mathrm{d}r\\mathrm{d}\\theta$$\n该积分是可分离的：\n$$\\sigma_{b}^2 = \\frac{1}{\\pi a^2} \\left(\\int_0^a r^3 \\, \\mathrm{d}r\\right) \\left(\\int_0^{2\\pi} \\cos^2\\theta \\, \\mathrm{d}\\theta\\right)$$\n径向积分为 $\\int_0^a r^3 \\, \\mathrm{d}r = \\left[\\frac{r^4}{4}\\right]_0^a = \\frac{a^4}{4}$。\n角向积分为 $\\int_0^{2\\pi} \\cos^2\\theta \\, \\mathrm{d}\\theta = \\int_0^{2\\pi} \\frac{1+\\cos(2\\theta)}{2} \\, \\mathrm{d}\\theta = \\left[\\frac{\\theta}{2} + \\frac{\\sin(2\\theta)}{4}\\right]_0^{2\\pi} = \\pi$。\n代入这些结果：\n$$\\sigma_{b}^2 = \\frac{1}{\\pi a^2} \\left(\\frac{a^4}{4}\\right) (\\pi) = \\frac{a^2}{4}$$\n现在我们可以写出 $\\sigma_{\\mathrm{sys}}$ 的表达式。将 $\\sigma_b^2 = a^2/4$ 代入方差相加公式：\n$$\\sigma_{\\mathrm{meas}}^2 = \\sigma_{\\mathrm{sys}}^2 + \\frac{a^2}{4}$$\n解出 $\\sigma_{\\mathrm{sys}}$ 得到所需的解析表达式：\n$$\\sigma_{\\mathrm{sys}} = \\sqrt{\\sigma_{\\mathrm{meas}}^2 - \\frac{a^2}{4}}$$\n这就完成了推导的第一部分。\n\n对于第二部分，我们必须求出系统高斯PSF的半峰全宽 (FWHM)。PSF的一维横截面由 $h(x) = A \\exp\\left(-\\frac{x^2}{2\\sigma_{\\mathrm{sys}}^2}\\right)$ 给出，其中 $A$ 为某个振幅。最大值为 $h(0) = A$。FWHM是宽度 $2x_{HM}$，在该宽度处 $h(x_{HM}) = A/2$。\n$$A \\exp\\left(-\\frac{x_{HM}^2}{2\\sigma_{\\mathrm{sys}}^2}\\right) = \\frac{A}{2}$$\n$$\\exp\\left(-\\frac{x_{HM}^2}{2\\sigma_{\\mathrm{sys}}^2}\\right) = \\frac{1}{2}$$\n两边取自然对数：\n$$-\\frac{x_{HM}^2}{2\\sigma_{\\mathrm{sys}}^2} = \\ln\\left(\\frac{1}{2}\\right) = -\\ln(2)$$\n$$x_{HM}^2 = 2 \\sigma_{\\mathrm{sys}}^2 \\ln(2) \\implies x_{HM} = \\sigma_{\\mathrm{sys}} \\sqrt{2 \\ln(2)}$$\nFWHM是这个值的两倍：\n$$\\text{FWHM}_{\\mathrm{sys}} = 2 x_{HM} = 2 \\sqrt{2 \\ln(2)} \\sigma_{\\mathrm{sys}}$$\n代入我们关于 $\\sigma_{\\mathrm{sys}}$ 的表达式：\n$$\\text{FWHM}_{\\mathrm{sys}} = 2 \\sqrt{2 \\ln(2)} \\sqrt{\\sigma_{\\mathrm{meas}}^2 - \\frac{a^2}{4}}$$\n现在我们代入给定的数值：$a = 120\\,\\mathrm{nm}$ 和 $\\sigma_{\\mathrm{meas}} = 200\\,\\mathrm{nm}$。所有计算都将以纳米 (nm) 为单位进行。\n$$\\sigma_{\\mathrm{sys}}^2 = (200)^2 - \\frac{(120)^2}{4} = 40000 - \\frac{14400}{4} = 40000 - 3600 = 36400\\,\\mathrm{nm}^2$$\n$$\\sigma_{\\mathrm{sys}} = \\sqrt{36400}\\,\\mathrm{nm}$$\n现在我们计算FWHM：\n$$\\text{FWHM}_{\\mathrm{sys}} = 2 \\sqrt{2 \\ln(2)} \\sqrt{36400}\\,\\mathrm{nm}$$\n使用值 $\\ln(2) \\approx 0.693147$：\n$$\\text{FWHM}_{\\mathrm{sys}} = 2 \\sqrt{2 \\cdot 0.693147} \\cdot \\sqrt{36400}\\,\\mathrm{nm}$$\n$$\\text{FWHM}_{\\mathrm{sys}} \\approx 2 \\sqrt{1.386294} \\cdot 190.7878...\\,\\mathrm{nm}$$\n$$\\text{FWHM}_{\\mathrm{sys}} \\approx 2.35482 \\cdot 190.7878...\\,\\mathrm{nm} \\approx 449.284\\,\\mathrm{nm}$$\n问题要求答案以微米 ($\\mu$m) 为单位，并四舍五入到四位有效数字。\n$$1\\,\\mathrm{nm} = 10^{-3}\\,\\mu\\mathrm{m}$$\n$$\\text{FWHM}_{\\mathrm{sys}} \\approx 449.284 \\times 10^{-3}\\,\\mu\\mathrm{m} = 0.449284\\,\\mu\\mathrm{m}$$\n四舍五入到四位有效数字得到 $0.4493\\,\\mu\\mathrm{m}$。", "answer": "$$\\boxed{0.4493}$$", "id": "4897191"}, {"introduction": "卷积的计算量可能非常大，而快速傅里叶变换（FFT）通过卷积定理提供了一条高效的捷径。然而，直接应用FFT会得到循环卷积，这与描述成像系统的线性卷积不同。本练习深入探讨了这一关键的实现细节，指导您确定需要进行多少零填充，才能使基于FFT的方法得到正确的线性卷积结果 [@problem_id:4897204]。", "problem": "在医学成像基础中，考虑一个二维线性移不变（LSI）成像系统。该系统的点扩散函数（PSF）是离散脉冲响应 $h[i,j]$，其具有大小为 $K_x \\times K_y$ 的有限矩形支撑域，即对于任何 $i \\notin \\{0,1,\\dots,K_x-1\\}$ 或 $j \\notin \\{0,1,\\dots,K_y-1\\}$，有 $h[i,j] = 0$。一个大小为 $N_x \\times N_y$ 的离散目标 $f[m,n]$ 通过线性卷积产生理想图像 $g[m,n]$，因此从 $f$ 到 $g$ 的映射是线性且移不变的。\n\n在实践中，卷积通过离散傅里叶变换（DFT）的快速傅里叶变换（FFT）算法实现：将 $f$ 和 $h$ 补零至大小为 $P_x \\times P_y$，计算它们的 DFT，将结果相乘，然后应用逆 DFT 在 $P_x \\times P_y$ 网格上获得循环卷积。然后将结果裁剪至 $N_x \\times N_y$。\n\n从线性卷积、循环卷积和有限支撑域的核心定义出发，推导当假定目标在其支撑域外为零时，补零操作如何在边界处产生一个空间变化的、与位置相关的“有效 PSF”。具体来说，将给定像素位置 $(m,n)$ 处的有效 PSF 表示为由 $f[m-i,n-j]$ 的可用索引决定的 $h[i,j]$ 的截断版本。然后，利用线性卷积和循环卷积之间的基本关系以及非零支撑域的范围，推导所需的最小补零长度 $P_x$ 和 $P_y$，以确保当裁剪回 $N_x \\times N_y$ 时，基于 FFT 的卷积在所有位置都能产生精确的线性卷积（即，在任一维度上都没有循环重叠或环绕）。\n\n你的最终答案必须是最小 $P_x$ 和 $P_y$ 作为 $N_x$、$N_y$、$K_x$ 和 $K_y$ 的函数的闭式解析表达式。最终答案无需单位，也无需四舍五入。", "solution": "问题要求对成像系统中离散目标与点扩散函数（PSF）的卷积进行两项推导。第一，描述由有限目标支撑域产生的与位置相关的“有效 PSF”；第二，推导使用 DFT/FFT 方法计算精确线性卷积所需的最小补零尺寸。\n\n设离散目标为 $f[m,n]$，系统的 PSF 为 $h[i,j]$。\n问题指出，$f[m,n]$ 的支撑域大小为 $N_x \\times N_y$，意味着它仅在索引 $(m,n)$ 满足 $m \\in \\{0, 1, \\dots, N_x-1\\}$ 和 $n \\in \\{0, 1, \\dots, N_y-1\\}$ 时非零。\nPSF $h[i,j]$ 具有大小为 $K_x \\times K_y$ 的有限矩形支撑域，意味着它仅在索引 $(i,j)$ 满足 $i \\in \\{0, 1, \\dots, K_x-1\\}$ 和 $j \\in \\{0, 1, \\dots, K_y-1\\}$ 时非零。\n\n理想图像 $g[m,n]$ 由 $f$ 和 $h$ 的二维线性卷积给出，记作 $(f * h)[m,n]$。卷积和可以表示为：\n$$g[m,n] = \\sum_{i=-\\infty}^{\\infty} \\sum_{j=-\\infty}^{\\infty} h[i,j] f[m-i, n-j]$$\n考虑到 PSF $h[i,j]$ 的有限支撑域，求和索引受到限制：\n$$g[m,n] = \\sum_{i=0}^{K_x-1} \\sum_{j=0}^{K_y-1} h[i,j] f[m-i, n-j]$$\n\n**第一部分：有效点扩散函数**\n\n空间变化的“有效 PSF”概念的出现是因为目标 $f$ 也具有有限的支撑域。求和中的项 $f[m-i, n-j]$ 仅当其索引位于 $f$ 的支撑域内时才非零。也就是说，我们必须有：\n$$0 \\le m-i \\le N_x-1$$\n$$0 \\le n-j \\le N_y-1$$\n对于给定的输出像素位置 $(m,n)$，这些条件对能够对求和做出贡献的 PSF $h[i,j]$ 的索引 $(i,j)$ 施加了约束。对于靠近目标域边界的像素 $(m,n)$，某些 $(i,j)$ 的值（对于这些值 $h[i,j]$ 非零）将导致参数 $(m-i, n-j)$ 落在 $f$ 的支撑域之外。在这些情况下，乘积 $h[i,j] f[m-i, n-j]$ 为零。\n\n例如，考虑一个位于 $m=0, n=0$ 的输出像素。其卷积为：\n$$g[0,0] = \\sum_{i=0}^{K_x-1} \\sum_{j=0}^{K_y-1} h[i,j] f[-i, -j]$$\n由于 $f$ 的支撑域在非负索引上，所以 $f[-i,-j]$ 仅在 $i=0$ 和 $j=0$ 时非零。因此，求和坍缩为单项：$g[0,0] = h[0,0] f[0,0]$。此位置的卷积只“看到”了 PSF 的 $h[0,0]$ 这一项。\n\n这表明，对于每个输出位置 $(m,n)$，卷积是与一个“有效 PSF”进行的，我们称之为 $h_{\\text{eff}, (m,n)}[i,j]$，它是真实 PSF $h[i,j]$ 的一个截断版本。这个有效 PSF 可以表示为：\n$$h_{\\text{eff}, (m,n)}[i,j] = \\begin{cases} h[i,j]  \\text{if } 0 \\le m-i \\le N_x-1 \\text{ and } 0 \\le n-j \\le N_y-1 \\\\ 0  \\text{otherwise} \\end{cases}$$\n输出图像可以被认为是：\n$$g[m,n] = \\sum_{i=0}^{K_x-1} \\sum_{j=0}^{K_y-1} h_{\\text{eff}, (m,n)}[i,j] f[m-i, n-j]$$\n这个有效 PSF 是与位置相关的。只有对于离边界足够远的输出像素 $(m,n)$（具体来说，对于 $m \\ge K_x-1$ 和 $n \\ge K_y-1$，使得对于 $h$ 支撑域中的所有 $i,j$，$m-i$ 和 $n-j$ 都映射到 $f$ 中的有效索引），有效 PSF 才等于完整的 PSF，$h_{\\text{eff}, (m,n)}[i,j]=h[i,j]$。这种边界效应是两个有限支撑域信号进行卷积的直接结果。\n\n**第二部分：基于 FFT 卷积的最小补零**\n\n卷积定理指出，空间域中的线性卷积等价于频率域中的乘法。在计算上，这是通过离散傅里叶变换（DFT）完成的，通常由快速傅里叶变换（FFT）实现。然而，DFT 内在地假设信号是周期的，其在频域相乘的性质对应于空间/时间域中的循环卷积，而非线性卷积。\n\n为了使用 DFT 计算线性卷积，我们必须将信号 $f$ 和 $h$ 补零到一个足够大的尺寸，比如 $P_x \\times P_y$，以防止循环卷积固有的环绕（混叠）效应。设补零后的信号为 $f_p[m,n]$ 和 $h_p[m,n]$，两者的大小均为 $P_x \\times P_y$。它们的循环卷积是：\n$$g_{\\text{circ}}[m,n] = (f_p \\circledast h_p)[m,n] = \\sum_{i=0}^{P_x-1} \\sum_{j=0}^{P_y-1} h_p[i,j] f_p[(m-i) \\pmod{P_x}, (n-j) \\pmod{P_y}]$$\n鉴于 $h_p[i,j]$ 的支撑域与 $h[i,j]$ 相同，上式可简化为：\n$$g_{\\text{circ}}[m,n] = \\sum_{i=0}^{K_x-1} \\sum_{j=0}^{K_y-1} h[i,j] f_p[(m-i) \\pmod{P_x}, (n-j) \\pmod{P_y}]$$\n我们要求这个结果与线性卷积结果 $g[m,n]$ 在所有感兴趣区域的输出像素上都相同，即对于 $m \\in \\{0, \\dots, N_x-1\\}$ 和 $n \\in \\{0, \\dots, N_y-1\\}$。\n\n将 $g_{\\text{circ}}[m,n]$ 的表达式与 $g[m,n]$ 的表达式进行比较，如果满足以下条件，两者就相等：\n$$f_p[(m-i) \\pmod{P_x}, (n-j) \\pmod{P_y}] = f[m-i, n-j]$$\n对于输出区域 $\\{0, \\dots, N_x-1\\} \\times \\{0, \\dots, N_y-1\\}$ 中的所有 $(m,n)$ 和 PSF 支撑域 $\\{0, \\dots, K_x-1\\} \\times \\{0, \\dots, K_y-1\\}$ 中的所有 $(i,j)$。\n\n我们来分析第一维度上 $f$ 的参数所需的索引范围。设该索引为 $u = m-i$。\n$m$ 的范围是 $[0, N_x-1]$。\n$i$ 的范围是 $[0, K_x-1]$。\n$u$ 的最小值为 $0 - (K_x-1) = -(K_x-1)$。\n$u$ 的最大值为 $(N_x-1) - 0 = N_x-1$。\n因此，为了计算指定区域的输出，我们需要访问 $f[u, \\cdot]$ 在 $u \\in [-(K_x-1), N_x-1]$ 范围内的值。\n\n信号 $f_p$ 是通过将 $f$ 放置在一个 $P_x \\times P_y$ 大小的零网格中构建的。循环卷积实际上将此网格视为周期信号的一个周期。环绕效应由模运算捕获。让我们分析其对索引 $u$ 的影响：\n1. 对于 $u \\in [0, N_x-1]$：在此范围内，$f[u, \\cdot]$ 可能非零。循环卷积中的项是 $f_p[u \\pmod{P_x}, \\cdot]$。如果我们选择 $P_x  N_x-1$，则 $u \\pmod{P_x} = u$。由于根据补零的定义，在此范围内 $f_p[u, \\cdot] = f[u, \\cdot]$，因此等式成立。\n2. 对于 $u \\in [-(K_x-1), -1]$：在此范围内，根据 $f$ 的支撑域定义，$f[u, \\cdot] = 0$。我们需要循环卷积项也为零。该项是 $f_p[u \\pmod{P_x}, \\cdot]$。对于负数 $u$，$u \\pmod{P_x} = u + P_x$。所以我们要求 $f_p[u+P_x, \\cdot] = 0$。\n补零后的信号 $f_p$ 仅在索引范围 $[0, N_x-1]$ 内非零。我们必须确保环绕的负索引不会落入此范围内。这意味着我们必须有：\n   $$u + P_x  N_x-1$$\n   这个条件必须对范围 $[-(K_x-1), -1]$ 内的所有 $u$ 都成立。最坏的情况（$u+P_x$ 的最小值）发生在 $u$ 的最小值处，即 $u = -(K_x-1)$。\n   $$-(K_x-1) + P_x  N_x - 1$$\n   $$P_x - K_x + 1  N_x - 1$$\n   $$P_x  N_x + K_x - 2$$\n   由于 $P_x$ 必须是整数，满足此严格不等式的 $P_x$ 的最小值为 $P_x = N_x + K_x - 1$。\n\n选择这个 $P_x$ 可以确保 PSF 的“尾部”（它延伸到需要从目标信号中获取负索引）环绕到补零后 DFT 网格中保证为零的区域，从而避免混叠，并正确复制了假定目标在其支撑域外为零的线性卷积边界条件。\n\n同样的推导独立地适用于第二维度，得出条件 $P_y  N_y + K_y - 2$。最小整数值为 $P_y = N_y + K_y - 1$。\n\n因此，为确保基于 FFT 的循环卷积在所需的 $N_x \\times N_y$ 输出网格内产生精确的线性卷积结果，最小补零尺寸必须为：\n$$P_x = N_x + K_x - 1$$\n$$P_y = N_y + K_y - 1$$\n这个尺寸恰好是线性卷积输出的完整支撑域的大小，确保没有信息因混叠而丢失。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\nN_x + K_x - 1  N_y + K_y - 1\n\\end{pmatrix}\n}\n$$", "id": "4897204"}, {"introduction": "我们已经看到，使用FFT是执行卷积的一种可行方法，但它总是最佳选择吗？在直接空间卷积和频域卷积之间的选择，取决于图像和卷积核的大小。本实践问题将要求您进行一次正式的复杂度分析，以比较这两种方法并推导出“盈亏平衡点”，从而揭示在何种情况下FFT的开销是值得的 [@problem_id:4897217]。", "problem": "二维成像系统可以建模为一个线性时不变（LTI）系统，其输出是输入图像与系统点扩散函数（PSF）的卷积。考虑计算一个 $M \\times N$ 大小的图像与一个 $K \\times K$ 大小的方形点扩散函数的离散线性卷积。您将比较直接在空间域进行卷积与使用快速傅里叶变换（FFT）在频率域进行卷积的计算成本。\n\n假设采用以下运算计数模型，其中每次实数浮点加法或乘法计为 $1$ 次运算：\n- 直接空间卷积：对于每个输出像素，离散卷积求和使用 $K^{2}$ 次实数乘法和 $K^{2}-1$ 次实数加法。\n- 大小为 $A \\times B$ 的二维复数FFT：成本为 $10\\,A\\,B\\,\\log_{2}(A B)$ 次实数运算。\n- 逐点复数乘法：每个复数乘积的成本为 $8$ 次实数运算。\n\n对于基于FFT的线性卷积，通过卷积定理实现，使用零填充，并对每个图像执行以下步骤：$2$ 次正向FFT（图像和填充后的PSF），$1$ 次逆向FFT，以及 $1$ 次两个频谱的逐点复数乘法。假设对于每个图像都必须重新对PSF进行变换。进一步假设在大图像情景下，$M, N \\gg K$，因此为了计算运算次数，将零填充至 $(M+K-1)\\times(N+K-1)$ 的大小可以近似为 $M \\times N$。\n\n1) 在上述模型下，推导总运算次数 $C_{\\text{spatial}}(K)$ 和 $C_{\\text{FFT}}$ 作为 $M$、$N$ 和 $K$ 的函数。\n\n2) 将盈亏平衡卷积核大小 $K^{\\ast}$ 定义为使 $C_{\\text{spatial}}(K)$ 等于 $C_{\\text{FFT}}$ 时的 $K$ 值。在大图像近似下，推导 $K^{\\ast}$ 的封闭形式表达式。\n\n3) 对于 $M=N=2048$，计算 $K^{\\ast}$。将您的最终数值答案 $K^{\\ast}$ 四舍五入到两位有效数字。仅提供 $K^{\\ast}$ 的数值作为最终答案，不带单位。", "solution": "问题陈述已经过验证，被认为是科学上合理的、问题定义明确的、客观的且内部一致的。它提出了一个信号处理中标准的计算复杂度分析问题，并为获得唯一解提供了所有必要的模型和数据。\n\n这个问题要求比较二维离散卷积的计算成本。我们将首先推导通过快速傅里叶变换（FFT）进行的直接空间域卷积和频域卷积的运算次数。然后，我们将确定盈亏平衡卷积核大小 $K^{\\ast}$，并针对给定的图像尺寸进行计算。\n\n**1) 运算次数的推导**\n\n设 $M$ 和 $N$ 是输入图像的尺寸，设 $K$ 是方形点扩散函数（PSF）的边长。\n\n直接空间域卷积的成本 $C_{\\text{spatial}}(K)$ 是输出像素数与每个输出像素的运算次数的乘积。\n问题给出每个输出像素的成本为 $K^2$ 次实数乘法和 $K^2 - 1$ 次实数加法。这使得每个输出像素的总浮点运算次数（flops）为 $K^2 + (K^2 - 1) = 2K^2 - 1$。\n\n一个 $M \\times N$ 的图像与一个 $K \\times K$ 的卷积核进行完整的线性卷积，会产生一个大小为 $(M+K-1) \\times (N+K-1)$ 的输出。问题指定使用大图像近似，其中 $M, N \\gg K$，这允许我们将输出像素数近似为 $M \\times N$。\n因此，空间卷积的总成本为：\n$$C_{\\text{spatial}}(K) = (M \\times N) \\times (2K^2 - 1) = MN(2K^2 - 1)$$\n\n频域卷积的成本 $C_{\\text{FFT}}$ 是其组成步骤成本的总和，使用指定的大图像近似，其中FFT的大小被视为 $M \\times N$。\n步骤如下：\n1.  **图像的正向FFT：** 一个大小为 $M \\times N$ 的二维复数FFT的成本给出为 $10MN\\log_2(MN)$ 次实数运算。\n2.  **填充后PSF的正向FFT：** 问题陈述PSF对每个图像都要进行变换。其成本与图像FFT相同：$10MN\\log_2(MN)$ 次实数运算。\n3.  **逐点复数乘法：** 这涉及将两个变换后数组的 $M \\times N$ 个元素相乘。每个复数乘积的成本给出为 $8$ 次实数运算。总成本：$8MN$ 次实数运算。\n4.  **乘积的逆向FFT：** 逆向FFT的计算复杂度与正向FFT相同。成本为 $10MN\\log_2(MN)$ 次实数运算。\n\n将这些成本相加，得到基于FFT方法的总运算次数：\n$$C_{\\text{FFT}} = 10MN\\log_2(MN) + 10MN\\log_2(MN) + 8MN + 10MN\\log_2(MN)$$\n$$C_{\\text{FFT}} = 30MN\\log_2(MN) + 8MN$$\n$$C_{\\text{FFT}} = MN(30\\log_2(MN) + 8)$$\n\n推导出的运算次数为：\n$C_{\\text{spatial}}(K) = MN(2K^2 - 1)$\n$C_{\\text{FFT}} = MN(30\\log_2(MN) + 8)$\n\n**2) 盈亏平衡卷积核大小 $K^{\\ast}$ 的推导**\n\n盈亏平衡卷积核大小 $K^{\\ast}$ 是使空间域和频域成本相等时的 $K$ 值，即 $C_{\\text{spatial}}(K^{\\ast}) = C_{\\text{FFT}}$。\n$$MN(2(K^{\\ast})^2 - 1) = MN(30\\log_2(MN) + 8)$$\n由于 $M, N \\ge 1$，我们可以将等式两边同除以非零项 $MN$：\n$$2(K^{\\ast})^2 - 1 = 30\\log_2(MN) + 8$$\n现在，我们求解 $K^{\\ast}$：\n$$2(K^{\\ast})^2 = 30\\log_2(MN) + 9$$\n$$(K^{\\ast})^2 = \\frac{30\\log_2(MN) + 9}{2}$$\n$$(K^{\\ast})^2 = 15\\log_2(MN) + 4.5$$\n取平方根得到盈亏平衡卷积核大小的封闭形式表达式。由于 $K$ 必须是正数维度，我们取正根：\n$$K^{\\ast} = \\sqrt{15\\log_2(MN) + 4.5}$$\n\n**3) $K^{\\ast}$ 的计算**\n\n我们被要求计算图像大小为 $M=N=2048$ 时的 $K^{\\ast}$。\n首先，我们计算项 $\\log_2(MN)$：\n$$M = 2048 = 2^{11}$$\n$$N = 2048 = 2^{11}$$\n$$MN = 2^{11} \\times 2^{11} = 2^{22}$$\n$$\\log_2(MN) = \\log_2(2^{22}) = 22$$\n现在，我们将这个值代入 $K^{\\ast}$ 的表达式中：\n$$K^{\\ast} = \\sqrt{15 \\times (22) + 4.5}$$\n$$K^{\\ast} = \\sqrt{330 + 4.5}$$\n$$K^{\\ast} = \\sqrt{334.5}$$\n计算数值：\n$$K^{\\ast} \\approx 18.2896144...$$\n问题要求答案四舍五入到两位有效数字。前两位有效数字是 $1$ 和 $8$。第三位数字是 $2$，小于 $5$，所以我们向下取整。\n$$K^{\\ast} \\approx 18$$\n因此，对于一个 $2048 \\times 2048$ 的图像，当卷积核大小大于约 $18 \\times 18$ 时，基于FFT的卷积比直接卷积更高效。", "answer": "$$\\boxed{18}$$", "id": "4897217"}]}