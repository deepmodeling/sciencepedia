{"hands_on_practices": [{"introduction": "在探索复杂应用之前，至关重要的是要掌握自旋回波序列的基本信号行为。本练习将指导您从布洛赫方程出发，推导自旋回波信号方程，从而建立信号强度与组织固有特性（$T_1$ 和 $T_2$）及序列参数（$TR$ 和 $TE$）之间的定量关系。理解这个核心方程是掌握磁共振图像对比度调控的第一步。[@problem_id:4935739]", "problem": "考虑一个理想的双脉冲自旋回波（SE）序列，作用于一个置于静态磁场$B_0$中、具有均匀质子密度$\\rho$的静态、均匀样本。该序列包含一个在$t=0$时施加的$90^{\\circ}$射频（RF）脉冲，随后是一个在$t = TE/2$时施加的$180^{\\circ}$射频脉冲，其中$TE$是回波时间。序列以重复时间$TR$进行重复。假设翻转角完美，扩散可忽略不计，$180^{\\circ}$脉冲能完美地重聚相位（因此只有不可逆的横向弛豫对回波幅度有贡献），并且在两次重复之间任何残留的横向磁化强度都被完全破坏，从而使得每个$90^{\\circ}$脉冲刚结束后的纵向磁化强度为零。样本的纵向弛豫由纵向弛豫时间$T_1$表征，横向弛豫由横向弛豫时间$T_2$表征。接收链将横向磁化强度线性地映射为信号幅度，比例系数为1。\n\n从Bloch方程的纵向分量和给定的物理假设出发，推导回波处的SE信号$S(TE)$作为$\\rho$、$TR$、$T_1$和$T_2$的函数。然后，解析地计算当$TE \\to 0$时$S(TE)$的极限。将最终答案表示为仅包含$\\rho$、$TR$和$T_1$的单一闭式解析表达式。无需进行数值计算。", "solution": "该问题具有科学依据，是良定的，并包含足够的信息以获得唯一解。其中的假设虽然是理想化的，但却是该主题入门介绍中的标准做法，并且内部一致。因此，该问题被认为是有效的。\n\n推导过程分为两个主要阶段：首先，通过求解纵向Bloch方程，确定脉冲序列重复开始时可用的纵向磁化强度；其次，计算回波时间的横向磁化强度，它构成了信号。\n\nBloch方程的纵向分量描述了纵向磁化强度$M_z$随时间恢复到其热平衡值$M_0$的过程，由下式给出：\n$$\n\\frac{dM_z}{dt} = \\frac{M_0 - M_z}{T_1}\n$$\n其中$T_1$是纵向弛豫时间。问题指出样本具有均匀的质子密度$\\rho$。平衡磁化强度$M_0$与该密度成正比。考虑到接收链中单位比例系数的假设，我们可以设定$M_0 = \\rho$。\n\n脉冲序列以重复时间$TR$进行重复。我们在稳态条件下分析该系统。在每个周期的开始（我们设其为$t=0$），施加一个$90^{\\circ}$的射频脉冲。该脉冲将可用的纵向磁化强度旋转到横向平面。问题明确指出“每个$90^{\\circ}$脉冲刚结束后的纵向磁化强度为零”。这是一个完美的$90^{\\circ}$脉冲的直接结果，因为脉冲后的纵向磁化强度$M_z(0^+)$与脉冲前的磁化强度$M_z(0^-)$之间的关系为$M_z(0^+) = M_z(0^-)\\cos(90^{\\circ}) = 0$。\n\n这为我们提供了重复间隔期间纵向弛豫的初始条件。在$t=0$时的$90^{\\circ}$脉冲之后，纵向磁化强度$M_z$从$M_z(0) = 0$向$M_0$恢复。我们用这个初始条件求解该微分方程。\n$$\n\\int_{0}^{M_z(t)} \\frac{dM_z'}{M_0 - M_z'} = \\int_{0}^{t} \\frac{dt'}{T_1}\n$$\n积分得到：\n$$\n[-\\ln(M_0 - M_z')]_{0}^{M_z(t)} = \\frac{t}{T_1}\n$$\n$$\n\\ln\\left(\\frac{M_0 - M_z(t)}{M_0 - 0}\\right) = -\\frac{t}{T_1}\n$$\n解出$M_z(t)$：\n$$\nM_z(t) = M_0 \\left( 1 - \\exp\\left(-\\frac{t}{T_1}\\right) \\right)\n$$\n完全破坏横向磁化强度的假设确保了有一个完整的$TR$周期可用于纵向恢复，且不受$180^{\\circ}$脉冲或回波时间的影响。因此，在重复间隔结束时，即下一个$90^{\\circ}$脉冲之前，纵向磁化强度已经恢复到：\n$$\nM_z(TR^-) = M_0 \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right)\n$$\n这是可用于下一次激发的纵向磁化强度。下一个周期开始时的$90^{\\circ}$脉冲将这全部的量翻转到横向平面。因此，横向磁化强度的初始大小为：\n$$\nM_{xy}(0^+) = M_z(TR^-) = M_0 \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right)\n$$\n在这次激发之后，横向磁化强度由于不可逆的自旋-自旋相互作用而衰减，其特征为横向弛豫时间$T_2$。在$90^{\\circ}$脉冲后$t$时刻的横向磁化强度大小由下式给出：\n$$\nM_{xy}(t) = M_{xy}(0^+) \\exp\\left(-\\frac{t}{T_2}\\right)\n$$\n在$t=TE/2$时的$180^{\\circ}$脉冲完美地重聚由外部磁场不均匀性引起的失相，但它不影响由$T_2$决定的衰减包络。自旋回波信号$S(TE)$在$t=TE$时测量。由于单位比例系数的假设，$S(TE) = M_{xy}(TE)$。\n$$\nS(TE) = M_{xy}(0^+) \\exp\\left(-\\frac{TE}{T_2}\\right)\n$$\n代入$M_{xy}(0^+)$和$M_0 = \\rho$的表达式：\n$$\nS(TE) = \\rho \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right) \\exp\\left(-\\frac{TE}{T_2}\\right)\n$$\n这是理想自旋回波序列中信号的通用表达式。\n\n问题的第二部分要求我们计算当回波时间$TE$趋近于零时该信号的极限。\n$$\n\\lim_{TE \\to 0} S(TE) = \\lim_{TE \\to 0} \\left[ \\rho \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right) \\exp\\left(-\\frac{TE}{T_2}\\right) \\right]\n$$\n项$\\rho \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right)$与$TE$无关，在此极限中可视为常数。\n$$\n\\lim_{TE \\to 0} S(TE) = \\rho \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right) \\lim_{TE \\to 0} \\left[ \\exp\\left(-\\frac{TE}{T_2}\\right) \\right]\n$$\n指数项的极限计算如下：\n$$\n\\lim_{TE \\to 0} \\exp\\left(-\\frac{TE}{T_2}\\right) = \\exp(0) = 1\n$$\n将此结果代回信号极限的表达式中，我们得到最终答案：\n$$\n\\lim_{TE \\to 0} S(TE) = \\rho \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right)\n$$\n正如题目所要求的，此表达式仅依赖于$\\rho$、$TR$和$T_1$。它代表了来自“质子密度加权”或“$T_1$加权”图像的信号，其中通过选择极小的回波时间，消除了$T_2$衰减的影响。", "answer": "$$\n\\boxed{\\rho \\left(1 - \\exp\\left(-\\frac{TR}{T_1}\\right)\\right)}\n$$", "id": "4935739"}, {"introduction": "$180^\\circ$ 重聚焦脉冲是自旋回波序列的核心，但其校正能力并非万能。本练习深入探讨了两种效应的关键区别：一种是静态频率偏移（如脂肪和水之间的化学位移），它能被完美重聚焦；另一种是空间编码效应（如层厚位移），它则无法被重聚焦校正。通过完成这个练习，您将对相位演化的精妙之处以及常见成像伪影的根源有更深刻的理解。[@problem_id:4935717]", "problem": "在磁共振成像（MRI）中，一个自旋回波脉冲序列由一个$90^{\\circ}$射频（RF）激发脉冲，随后在时间$T_E/2$后施加一个$180^{\\circ}$射频重聚脉冲组成，在回波时间$T_E$产生一个回波。考虑一个均匀的静态磁场$B_0$，并在一个频率设置为水共振频率的旋转坐标系中分析相位演化。假设射频脉冲是理想的、瞬时的，在层面选择窗之外的任何残余梯度矩都被完美扰相，并且没有扩散或$T_2$衰减对相位的影响。设旋磁比为$\\gamma$，脂肪-水的化学位移为一个恒定的分数偏移$\\delta$（单位为百万分率），因此脂肪的拉莫尔角频率与水相差一个静态偏移量$\\Delta \\omega = \\delta \\, \\omega_0$，其中$\\omega_0 = \\gamma B_0$。\n\n任务：\n1. 使用旋转坐标系中相位累积的第一性原理，计算在自旋回波中心（$t = T_E$）时，脂肪和水之间的相对相位差$\\Delta \\phi(T_E)$。\n2. 从拉莫尔角频率与在层面选择梯度$G_z$下位置的关系出发，解释为什么$180^{\\circ}$脉冲可以重聚静态频率偏移（包括化学位移），但不能撤销在层面选择过程中产生的层面位移效应。你的解释必须明确使用频率和在$G_z$下位置之间的线性映射，并且必须阐明哪些项是时间可逆的，哪些不是。\n\n以弧度表示最终的相位差。无需四舍五入。", "solution": "自旋回波序列的分析在旋转坐标系中进行，该坐标系的角频率设置为水的拉莫尔频率 $\\omega_0 = \\gamma B_0$。在此坐标系中，自旋相位$\\phi$的演化由其相对于水的频率偏移$\\omega_{rot}$决定。对于一个与时间无关的偏移，在时间间隔$\\Delta t$内累积的相位为$\\Delta \\phi = \\omega_{rot} \\Delta t$。\n\n**1. 相对相位差 $\\Delta \\phi(T_E)$ 的计算**\n\n我们首先在所选的旋转坐标系中确定水和脂肪自旋的频率偏移。\n-   根据旋转坐标系的定义，水自旋的频率偏移为 $\\omega_{W, rot} = 0$。\n-   脂肪自旋的拉莫尔频率与水相差 $\\Delta \\omega = \\delta \\omega_0$。因此，在旋转坐标系中，它们的频率偏移为 $\\omega_{F, rot} = \\Delta \\omega$。\n\n自旋回波序列涉及三个关键时间点：$t=0$时的$90^{\\circ}$激发脉冲，$t=T_E/2$时的$180^{\\circ}$重聚脉冲，以及$t=T_E$时的回波。我们将跟踪水和脂肪自旋在此序列中的相位，假设在$90^{\\circ}$脉冲将它们对准到横向平面后，它们的相位立即为$0$。\n\n**从 $t=0$ 到 $t=T_E/2$ 的相位演化：**\n在这第一个持续时间为$T_E/2$的区间内，自旋根据它们的频率偏移自由进动。\n-   水自旋累积的相位是：\n    $$ \\phi_W(T_E/2^{-}) = \\omega_{W, rot} \\times \\frac{T_E}{2} = 0 \\times \\frac{T_E}{2} = 0 $$\n-   脂肪自旋累积的相位是：\n    $$ \\phi_F(T_E/2^{-}) = \\omega_{F, rot} \\times \\frac{T_E}{2} = \\Delta \\omega \\frac{T_E}{2} $$\n符号 $T_E/2^{-}$ 表示恰好在$180^{\\circ}$脉冲之前的时间。\n\n**$t=T_E/2$ 时 $180^{\\circ}$ 脉冲的作用：**\n一个理想的$180^{\\circ}$射频脉冲，例如沿旋转坐标系中的x轴施加，会将横向磁化矢量绕x轴翻转（$M_y \\rightarrow -M_y$, $M_x \\rightarrow M_x$）。在复相位表示 $M_{xy} = M_x + iM_y$ 中，这对应于复共轭，等效于对累积的相位取负：$\\phi \\rightarrow -\\phi$。\n-   脉冲后瞬间（$t=T_E/2^{+}$）水自旋的相位是：\n    $$ \\phi_W(T_E/2^{+}) = -\\phi_W(T_E/2^{-}) = -0 = 0 $$\n-   脉冲后瞬间脂肪自旋的相位是：\n    $$ \\phi_F(T_E/2^{+}) = -\\phi_F(T_E/2^{-}) = -\\Delta \\omega \\frac{T_E}{2} $$\n\n**从 $t=T_E/2$ 到 $t=T_E$ 的相位演化：**\n在这第二个同样持续时间为$T_E/2$的区间内，自旋再次以相同的静态频率偏移自由进动。在$t=T_E$时的最终相位是脉冲后的相位与在第二个区间内额外累积的相位之和。\n-   在回波时间 $t=T_E$ 时水自旋的最终相位是：\n    $$ \\phi_W(T_E) = \\phi_W(T_E/2^{+}) + \\omega_{W, rot} \\times \\frac{T_E}{2} = 0 + 0 \\times \\frac{T_E}{2} = 0 $$\n-   在回波时间 $t=T_E$ 时脂肪自旋的最终相位是：\n    $$ \\phi_F(T_E) = \\phi_F(T_E/2^{+}) + \\omega_{F, rot} \\times \\frac{T_E}{2} = \\left(-\\Delta \\omega \\frac{T_E}{2}\\right) + \\left(\\Delta \\omega \\frac{T_E}{2}\\right) = 0 $$\n在回波中心，水和脂肪自旋的相位都恢复到零。这证明了自旋回波序列对静态频率偏移的重聚效应。\n\n在回波时间，脂肪和水之间的相对相位差 $\\Delta \\phi(T_E)$ 是：\n$$ \\Delta \\phi(T_E) = \\phi_F(T_E) - \\phi_W(T_E) = 0 - 0 = 0 $$\n\n**2. 层面选择与化学位移重聚的解释**\n\n此解释的关键在于区分一个随时间连续的相位演化过程和一个与射频脉冲持续时间锁定的空间编码事件。\n\n在层面选择梯度$G_z$下，位于位置$z$的自旋的拉莫尔角频率$\\omega$由以下线性映射给出：\n$$ \\omega(z) = \\gamma (B_0 + G_z z) = \\omega_0 + \\gamma G_z z $$\n\n**静态频率偏移（例如化学位移）的重聚：**\n如第1部分所推导，一个静态频率偏移，如化学位移$\\Delta \\omega$，在第一个时间间隔内引起相位累积$\\phi_1 = \\Delta \\omega (T_E/2)$。这个过程可被$180^{\\circ}$脉冲**时间反转**。该脉冲充当一个相位共轭算子，有效地将累积相位的符号翻转为$-\\phi_1$。在第二个时间间隔内，累积了相同量的相位$\\phi_2 = \\Delta \\omega (T_E/2)$。在$t=T_E$时的最终相位是共轭的初始相位与后续相位的和：$\\phi(T_E) = -\\phi_1 + \\phi_2 = -\\Delta \\omega (T_E/2) + \\Delta \\omega (T_E/2) = 0$。失相被抵消，因为其原因（$\\Delta \\omega$）是在整个脉冲间演化期间存在的恒定偏移。\n\n**层面位移的不可逆性：**\n层面选择是通过**同时**施加梯度$G_z$和一个具有特定中心频率$\\omega_{RF}$和带宽的射频脉冲来执行的。只有当自旋的拉莫尔频率$\\omega(z)$与脉冲频谱内的某个频率匹配时，它才会被激发或重聚。\n\n考虑$90^{\\circ}$激发脉冲，它与梯度$G_{z,90}$一起施加，并以$\\omega_{RF}$为中心频率。为了在层面中心$z_W$激发水自旋，其频率必须与脉冲频率匹配：\n$$ \\omega_0 + \\gamma G_{z,90} z_W = \\omega_{RF} \\implies \\gamma G_{z,90} z_W = \\omega_{RF} - \\omega_0 $$\n为了激发脂肪自旋，其包含化学位移偏移$\\Delta\\omega$的频率必须与相同的射频脉冲频率匹配。这发生在另一个位置$z_F$：\n$$ (\\omega_0 + \\Delta\\omega) + \\gamma G_{z,90} z_F = \\omega_{RF} \\implies \\gamma G_{z,90} z_F = \\omega_{RF} - \\omega_0 - \\Delta\\omega $$\n结合这些方程表明，被激发的脂肪层面相对于水层面发生了空间位移：\n$$ \\gamma G_{z,90} (z_W - z_F) = \\Delta\\omega \\implies \\Delta z = z_W - z_F = \\frac{\\Delta\\omega}{\\gamma G_{z,90}} $$\n这个空间编码事件，即“层面位移”，在$90^{\\circ}$脉冲及其伴随梯度结束时完成。其效果是选择了一组物理上不同的自旋（在$z_F$的脂肪，在$z_W$的水）。\n\n现在，考虑$180^{\\circ}$重聚脉冲。它也是层面选择性的，并与它自己的梯度$G_{z,180}$（通常$G_{z,180} = G_{z,90}$）一起施加，以作用于同一层面。该脉冲将只影响满足其共振条件的自旋。这导致了**完全相同的空间位移现象**。$180^{\\circ}$脉冲在位置$z_W$重聚水自旋，在位置$z_F$重聚脂肪自旋。\n\n关键的区别在于：\n- 相位累积$\\Delta \\omega \\cdot t$是一个随时间演化的状态变量。$180^{\\circ}$脉冲可以通过反转其符号来操纵这个历史累积。这个效应是**时间可逆的**。\n- 层面位移$\\Delta z$不是一个累积的相位历史。它是一种基于共振条件的空间选择，而这种条件仅**在射频脉冲期间**存在。$180^{\\circ}$脉冲不能回到过去改变初始$90^{\\circ}$脉冲选择了哪些自旋。相反，它执行自己独立的层面选择，该选择受相同的物理定律约束，因此施加了相同的空间位移。这个效应**不能**被重聚脉冲**时间反转**，因为导致它的原因（梯度$G_z$）不是脉冲间自旋系统的静态属性，而是为定义层面本身而施加的外部场。$180^{\\circ}$脉冲并不会“撤销”第一个空间位移；它只是重复了它。", "answer": "$$\n\\boxed{0}\n$$", "id": "4935717"}, {"introduction": "理想的脉冲和完全均匀的磁场只是理论上的简化，真实的MRI扫描仪不可避免地存在各种不完美。这项计算实践要求您构建一个布洛赫方程模拟器，以直观地观察静态主磁场（$B_0$）和射频场（$B_1$）的不均匀性对自旋回波信号的影响。通过比较常规重聚焦脉冲与先进的绝热脉冲的效果，您将对现代脉冲序列设计中用于增强成像稳健性的策略获得宝贵的实践经验。[@problem_id:4935662]", "problem": "要求您编写一个完整的程序，用于在存在位置相关的射频场不均匀性（记为 $B_1$）和静态场不均匀性（记为 $B_0$）的条件下，模拟磁共振成像 (MRI) 中的单次自旋回波，并量化绝热重聚焦脉冲相对于常规重聚焦脉冲如何减轻对 $B_1$ 的敏感性。该模拟必须基于旋转坐标系中的 Bloch 方程，对射频 (RF) 脉冲使用硬脉冲、瞬时旋转模型，并在演化期间使用带有横向弛豫的自由旋进。\n\n从以下基本依据出发：\n- 旋转坐标系中的 Bloch 方程，$\\frac{d\\mathbf{M}}{dt} = \\gamma \\mathbf{M} \\times \\mathbf{B}_{\\text{eff}}$，其中 $\\mathbf{M}$ 是磁化矢量，$\\mathbf{B}_{\\text{eff}}$ 是有效场。\n- 围绕笛卡尔坐标轴的共振、瞬时硬射频脉冲被建模为磁化矢量围绕该轴旋转角度 $\\theta$，由一个正常旋转矩阵表示。\n- 在自由旋进期间，角频率偏移为 $\\Delta \\omega$ 的失谐会在时间间隔 $\\tau$ 内引起围绕 $z$ 轴角度为 $\\phi = \\Delta \\omega \\, \\tau$ 的旋转，同时伴随着横向分量上的横向弛豫（由指数因子 $e^{-\\tau/T_2}$ 描述），其中 $T_2$ 是自旋-自旋弛豫时间。通过假设重复时间足够长来忽略纵向弛豫 ($T_1$)，使得初始磁化为 $\\mathbf{M}_0 = [0,0,M_0]^\\top$，其中 $M_0$ 为常数。\n- 一个自旋回波序列包含一个激发脉冲，随后是两个等长的自由旋进周期，并在其中点施加一个重聚焦脉冲。使用围绕 $x$ 轴的 $90^{\\circ}$ 激发脉冲和围绕 $y$ 轴的 $180^{\\circ}$ 重聚焦脉冲作为标称脉冲方向。\n\n将视场 (FOV) 建模为一维位置 $x \\in [-L, L]$，其中 $L = 0.1 \\, \\text{m}$。在每个位置 $x$ 处，设相对 $B_1$ 缩放因子为 $s(x)$，静态频率偏移为 $\\Delta f(x)$（单位赫兹），对应的角频率偏移为 $\\Delta \\omega(x) = 2 \\pi \\, \\Delta f(x)$。$B_1$ 不均匀性会缩放激发脉冲和重聚焦脉冲的翻转角。重聚焦脉冲的模型如下：\n- 常规重聚焦：围绕 $y$ 轴的瞬时旋转，角度为 $\\beta(x) = s(x) \\, \\pi$。\n- 绝热重聚焦（简化模型）：当局部 $B_1$ 缩放因子超过阈值时，进行稳健的 $\\pi$ 旋转，即，如果 $s(x) \\ge s_{\\min}$，则 $\\beta_{\\text{adiab}}(x) = \\pi$；否则 $\\beta_{\\text{adiab}}(x) = s(x)\\,\\pi$。为了保持模型的可比性，两种情况都使用相同的旋转轴（$y$ 轴）。\n\n设激发脉冲是围绕 $x$ 轴的 $90^{\\circ}$ 旋转，并由 $s(x)$ 缩放，即 $\\alpha(x) = s(x)\\,\\pi/2$。自由旋进在重聚焦脉冲前后各发生一次，时长为 $\\tau = \\text{TE}/2$，每次都被建模为围绕 $z$ 轴旋转角度 $\\phi(x) = \\Delta \\omega(x)\\, \\tau$，并伴有横向衰减 $e^{-\\tau/T_2}$。\n\n算法要求：\n1. 将 $\\mathbf{M}(x)$ 初始化为 $\\mathbf{M}_0 = [0,0,M_0]^\\top$，其中 $M_0 = 1$。\n2. 应用激发旋转 $R_x(\\alpha(x))$ 以获得激发刚结束时的 $\\mathbf{M}$。\n3. 应用时长为 $\\tau = \\text{TE}/2$ 的自由旋进：以 $R_z(\\phi(x))$ 旋转，并将横向分量乘以 $e^{-\\tau/T_2}$。\n4. 应用重聚焦旋转：\n   - 对于常规情况：$R_y(\\beta(x))$，其中 $\\beta(x) = s(x)\\,\\pi$。\n   - 对于绝热情况：$R_y(\\beta_{\\text{adiab}}(x))$，其中如果 $s(x) \\ge s_{\\min}$，则 $\\beta_{\\text{adiab}}(x) = \\pi$，否则 $\\beta_{\\text{adiab}}(x) = s(x)\\,\\pi$。\n5. 应用第二次时长为 $\\tau = \\text{TE}/2$ 的自由旋进：以 $R_z(\\phi(x))$ 旋转，并将横向分量乘以 $e^{-\\tau/T_2}$。\n6. 在回波时间点，计算复数横向信号 $S(x) = M_x(x) + i M_y(x)$。将在理想脉冲（无不均匀性）情况下的理想回波幅度定义为 $|S|_{\\text{ideal}} = e^{-\\text{TE}/T_2}$。\n7. 对于每种情况（常规和绝热），计算两个空间汇总指标：\n   - 平均归一化幅度：$\\overline{A} = \\frac{1}{N}\\sum_{x} \\frac{|S(x)|}{|S|_{\\text{ideal}}}$（无量纲）。\n   - 平均绝对相位偏差（单位为弧度）：首先计算循环平均相位 $\\bar{\\phi} = \\arg\\left(\\frac{1}{N}\\sum_x e^{i \\arg S(x)}\\right)$，然后计算 $\\frac{1}{N}\\sum_x \\left| \\arg\\left(e^{i(\\arg S(x) - \\bar{\\phi})}\\right) \\right|$。\n\n角度必须以弧度处理。报告涉及物理单位的参数时，请严格遵守下面指定的单位。\n\n测试套件：\n在 $[-L, L]$（$L = 0.1 \\, \\text{m}$）区间内使用 $N = 101$ 个均匀间隔的位置。对于每个测试用例，定义 $s(x) = 1 + a \\, (x/L)$ 和 $\\Delta f(x) = b \\, (x/L)$（单位赫兹），并设定固定的绝热阈值 $s_{\\min} = 0.7$。对于每个测试用例，按指定顺序和单位计算四个输出：$(\\overline{A}_{\\text{conv}}, \\overline{A}_{\\text{adiab}}, \\overline{P}_{\\text{conv}}, \\overline{P}_{\\text{adiab}})$，其中 $\\overline{P}$ 表示以弧度为单位的平均绝对相位偏差。使用：\n- 用例 $1$（理想路径）：$\\text{TE} = 60 \\, \\text{ms}$，$T_2 = 70 \\, \\text{ms}$，$a = -0.2$，$b = 80 \\, \\text{Hz}$。\n- 用例 $2$（具有严重 $B_1$ 和 $B_0$ 的边缘情况）：$\\text{TE} = 80 \\, \\text{ms}$，$T_2 = 60 \\, \\text{ms}$，$a = -0.5$，$b = 120 \\, \\text{Hz}$。\n- 用例 $3$（边界情况，无不均匀性）：$\\text{TE} = 50 \\, \\text{ms}$，$T_2 = 100 \\, \\text{ms}$，$a = 0.0$，$b = 0 \\, \\text{Hz}$。\n\n您的程序必须：\n- 仅使用瞬时旋转和带横向衰减的自由旋进来实现上述物理过程。\n- 内部以秒表示时间，而输入以毫秒给出。\n- 所有角度均使用弧度。\n- 输出一行，其中包含一个由方括号括起来的逗号分隔列表，列表内含 $12$ 个浮点数结果，并严格按以下顺序排列：\n  $[\\overline{A}_{\\text{conv}}^{(1)}, \\overline{A}_{\\text{adiab}}^{(1)}, \\overline{P}_{\\text{conv}}^{(1)}, \\overline{P}_{\\text{adiab}}^{(1)}, \\overline{A}_{\\text{conv}}^{(2)}, \\overline{A}_{\\text{adiab}}^{(2)}, \\overline{P}_{\\text{conv}}^{(2)}, \\overline{P}_{\\text{adiab}}^{(2)}, \\overline{A}_{\\text{conv}}^{(3)}, \\overline{A}_{\\text{adiab}}^{(3)}, \\overline{P}_{\\text{conv}}^{(3)}, \\overline{P}_{\\text{adiab}}^{(3)}]$。\n- 将每个值四舍五入到恰好 $6$ 位小数。\n- 单位：对于 $\\overline{A}$ 使用无量纲归一化，对于 $\\overline{P}$ 报告弧度。\n\n科学真实性要求：\n- 不假设任何 $T_1$ 效应。\n- 除指定的 $\\Delta f(x)$ 外，不假设任何由梯度引起的失相。\n- 射频脉冲是瞬时的；自由旋进仅在两个时长为 $\\text{TE}/2$ 的演化窗口内发生。\n\n您的程序应生成单行输出，其中包含一个由方括号括起来的逗号分隔列表形式的结果（例如，$[0.123456,0.234567,0.012345,0.023456, \\ldots]$）。不允许有任何其他输出。", "solution": "问题陈述已经过分析，并被确定为有效。它在科学上基于核磁共振 (NMR) 的原理，问题定义良好，指令清晰且确定，语言客观。所有参数和模型均已指定，可以得出一个唯一且有意义的解。因此，我们可以着手提供一个正式的解。\n\n自旋回波序列的模拟基于旋转坐标系中的 Bloch 方程，该方程控制宏观磁化矢量 $\\mathbf{M}(t) = [M_x(t), M_y(t), M_z(t)]^\\top$ 的动力学。问题将连续演化简化为一系列离散事件：瞬时射频 (RF) 脉冲和自由旋进周期。每个事件都被建模为应用于磁化矢量的矩阵变换。\n\n根据长重复时间的假设，系统的初始状态是与主磁场（$z$ 轴）对齐的热平衡磁化。我们将此初始磁化归一化为 $M_0 = 1$，因此 $\\mathbf{M}_0 = [0, 0, 1]^\\top$。\n\n在旋转坐标系中，一个围绕轴 $\\mathbf{u}$（例如 $x$ 轴或 $y$ 轴）、翻转角为 $\\theta$ 的瞬时射频脉冲被建模为磁化矢量的旋转。对应于 $x$ 轴和 $y$ 轴的旋转矩阵为：\n$$\nR_x(\\theta) = \\begin{pmatrix} 1  0  0 \\\\ 0  \\cos\\theta  -\\sin\\theta \\\\ 0  \\sin\\theta  \\cos\\theta \\end{pmatrix} \\quad \\text{和} \\quad R_y(\\theta) = \\begin{pmatrix} \\cos\\theta  0  \\sin\\theta \\\\ 0  1  0 \\\\ -\\sin\\theta  0  \\cos\\theta \\end{pmatrix}\n$$\n这些矩阵将用于对激发和重聚焦脉冲进行建模。\n\n在存在静态场偏移 $\\Delta \\omega$ 和横向弛豫时间 $T_2$ 的情况下，持续时间为 $\\tau$ 的自由旋进被建模为两个并发过程：围绕 $z$ 轴旋转角度 $\\phi = \\Delta \\omega \\, \\tau$，以及横向磁化分量（$M_x, M_y$）的指数衰减。由于忽略了纵向弛豫 ($T_1$)，$z$ 分量 $M_z$ 被假定为常数。这个组合操作可以由一个变换矩阵 $P(\\phi, \\tau, T_2)$ 表示：\n$$\nP(\\phi, \\tau, T_2) = \\begin{pmatrix} e^{-\\tau/T_2}  0  0 \\\\ 0  e^{-\\tau/T_2}  0 \\\\ 0  0  1 \\end{pmatrix} \\begin{pmatrix} \\cos\\phi  -\\sin\\phi  0 \\\\ \\sin\\phi  \\cos\\phi  0 \\\\ 0  0  1 \\end{pmatrix} = \\begin{pmatrix} e^{-\\tau/T_2}\\cos\\phi  -e^{-\\tau/T_2}\\sin\\phi  0 \\\\ e^{-\\tau/T_2}\\sin\\phi  e^{-\\tau/T_2}\\cos\\phi  0 \\\\ 0  0  1 \\end{pmatrix}\n$$\n衰减和旋转的顺序是可交换的，因此一次矩阵乘法就足够了。\n\n自旋回波序列包含五个不同的步骤，这些步骤依次应用于初始磁化 $\\mathbf{M}_0$。模拟在一组 $N=101$ 个空间位置 $x \\in [-L, L]$（其中 $L=0.1 \\, \\text{m}$）上执行。射频脉冲的翻转角和失谐频率是位置 $x$ 的函数：\n1.  $B_1$ 不均匀性因子为 $s(x) = 1 + a (x/L)$。\n2.  失谐频率为 $\\Delta f(x) = b (x/L)$，导致角频率偏移 $\\Delta \\omega(x) = 2\\pi \\Delta f(x)$。\n\n变换序列如下：\n1.  **激发脉冲**：一个围绕 $x$ 轴的 $90^{\\circ}$ 脉冲，受 $B_1$ 不均匀性缩放。翻转角为 $\\alpha(x) = s(x) \\frac{\\pi}{2}$。变换为 $R_x(\\alpha(x))$。\n    $$ \\mathbf{M}_1(x) = R_x(\\alpha(x)) \\mathbf{M}_0 $$\n2.  **第一次自由旋进**：演化持续时间为 $\\tau = \\text{TE}/2$。旋进角为 $\\phi(x) = \\Delta \\omega(x) \\tau$。变换为 $P(\\phi(x), \\tau, T_2)$。\n    $$ \\mathbf{M}_2(x) = P(\\phi(x), \\tau, T_2) \\mathbf{M}_1(x) $$\n3.  **重聚焦脉冲**：一个围绕 $y$ 轴的 $180^{\\circ}$ 脉冲。翻转角 $\\beta(x)$ 取决于脉冲类型：\n    -   **常规**：$\\beta_{\\text{conv}}(x) = s(x) \\pi$。\n    -   **绝热（简化模型）**：如果 $s(x) \\ge s_{\\min}$，则 $\\beta_{\\text{adiab}}(x) = \\pi$，否则 $\\beta_{\\text{adiab}}(x) = s(x)\\pi$，其中 $s_{\\min} = 0.7$。\n    变换为 $R_y(\\beta(x))$。\n    $$ \\mathbf{M}_3(x) = R_y(\\beta(x)) \\mathbf{M}_2(x) $$\n4.  **第二次自由旋进**：与第一次旋进周期相同，演化时间为 $\\tau = \\text{TE}/2$。\n    $$ \\mathbf{M}_4(x) = P(\\phi(x), \\tau, T_2) \\mathbf{M}_3(x) $$\n\n在回波时间 TE 处的最终磁化矢量为 $\\mathbf{M}_{\\text{final}}(x) = \\mathbf{M}_4(x)$。复数横向信号 $S(x)$ 由其分量构成：\n$$ S(x) = M_{x, \\text{final}}(x) + i M_{y, \\text{final}}(x) $$\n此计算将针对常规和绝热重聚焦脉冲模型分别进行。\n\n最后，对所有空间位置 $x$ 计算两个汇总指标：\n1.  **平均归一化幅度 ($\\overline{A}$)**：该指标量化了相对于没有任何场不均匀性或脉冲缺陷的理想情况下的平均信号强度。理想信号幅度为 $|S|_{\\text{ideal}} = e^{-\\text{TE}/T_2}$。\n    $$ \\overline{A} = \\frac{1}{N} \\sum_{x} \\frac{|S(x)|}{|S|_{\\text{ideal}}} $$\n2.  **平均绝对相位偏差 ($\\overline{P}$)**：该指标量化了信号的空间相位离散度，这种离散度可能在重建图像中引起伪影。它的计算方法是：首先求出信号相位的循环平均值 $\\bar{\\phi}$，然后计算每个相位与该平均值之间绝对循环距离的平均值。\n    $$ \\bar{\\phi} = \\arg\\left( \\frac{1}{N} \\sum_x e^{i \\arg S(x)} \\right) $$\n    $$ \\overline{P} = \\frac{1}{N} \\sum_x \\left| \\arg\\left( e^{i(\\arg S(x) - \\bar{\\phi})} \\right) \\right| $$\n    其中 $\\arg(e^{i\\theta})$ 操作确保相位差被包裹在 $(-\\pi, \\pi]$ 范围内。\n\n实现部分将对所提供的三个测试用例中的每一个执行这些计算，为每个用例生成四个指标。为了计算效率，该过程在空间维度上进行了矢量化处理。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the spin-echo simulation for the given test cases.\n    \"\"\"\n\n    def get_rotation_matrix(axis, theta):\n        \"\"\"\n        Generates a stack of 3x3 rotation matrices for a given axis and a vector of angles.\n        \n        Args:\n            axis (str): 'x', 'y', or 'z'.\n            theta (np.ndarray): A 1D array of angles in radians.\n\n        Returns:\n            np.ndarray: A (3, 3, N) array of rotation matrices, where N is the size of theta.\n        \"\"\"\n        num_pts = theta.size\n        c = np.cos(theta)\n        s = np.sin(theta)\n        R = np.zeros((3, 3, num_pts))\n\n        if axis == 'x':\n            R[0, 0, :] = 1.0\n            R[1, 1, :] = c\n            R[1, 2, :] = -s\n            R[2, 1, :] = s\n            R[2, 2, :] = c\n        elif axis == 'y':\n            R[0, 0, :] = c\n            R[0, 2, :] = s\n            R[1, 1, :] = 1.0\n            R[2, 0, :] = -s\n            R[2, 2, :] = c\n        elif axis == 'z':\n            R[0, 0, :] = c\n            R[0, 1, :] = -s\n            R[1, 0, :] = s\n            R[1, 1, :] = c\n            R[2, 2, :] = 1.0\n        return R\n\n    def run_simulation(TE, T2, a, b, s_min, L, N):\n        \"\"\"\n        Runs one full spin-echo simulation for both conventional and adiabatic pulses.\n        \n        Returns:\n            A tuple of four floats: (A_conv, A_adiab, P_conv, P_adiab).\n        \"\"\"\n        # Convert times to seconds\n        TE_s = TE / 1000.0\n        T2_s = T2 / 1000.0\n        tau = TE_s / 2.0\n        \n        # 1. Setup spatial grid and inhomogeneity profiles\n        x_pos = np.linspace(-L, L, N)\n        s_x = 1.0 + a * (x_pos / L)\n        delta_f_x = b * (x_pos / L)\n        delta_omega_x = 2.0 * np.pi * delta_f_x\n\n        # Calculate ideal signal magnitude for normalization\n        ideal_mag = np.exp(-TE_s / T2_s) if T2_s > 0 else 0.0\n\n        # Define pulse flip angles\n        alpha_x = s_x * np.pi / 2.0\n        beta_conv_x = s_x * np.pi\n        beta_adiab_x = np.where(s_x >= s_min, np.pi, s_x * np.pi)\n\n        results = []\n        for pulse_type in ['conventional', 'adiabatic']:\n            # 2. Initialize magnetization vectors\n            M = np.zeros((3, N))\n            M[2, :] = 1.0  # M0 is normalized to 1\n\n            # 3. Excitation pulse (90_x)\n            Rx = get_rotation_matrix('x', alpha_x)\n            M = np.einsum('ijk,jk->ik', Rx, M)\n\n            # 4. First free precession\n            phi_x = delta_omega_x * tau\n            Rz = get_rotation_matrix('z', phi_x)\n            M = np.einsum('ijk,jk->ik', Rz, M)\n            M[:2, :] *= np.exp(-tau / T2_s)\n\n            # 5. Refocusing pulse (180_y)\n            if pulse_type == 'conventional':\n                beta_x = beta_conv_x\n            else: # adiabatic\n                beta_x = beta_adiab_x\n            \n            Ry = get_rotation_matrix('y', beta_x)\n            M = np.einsum('ijk,jk->ik', Ry, M)\n\n            # 6. Second free precession\n            # Note: Rz is the same as before\n            M = np.einsum('ijk,jk->ik', Rz, M)\n            M[:2, :] *= np.exp(-tau / T2_s)\n\n            # 7. Compute signal and metrics\n            S_complex = M[0, :] + 1j * M[1, :]\n            \n            # Mean Normalized Magnitude\n            magnitudes = np.abs(S_complex)\n            A_bar = np.mean(magnitudes / ideal_mag) if ideal_mag > 0 else 0.0\n\n            # Mean Absolute Phase Deviation\n            phases = np.angle(S_complex)\n            mean_unit_vector = np.mean(np.exp(1j * phases))\n            phi_bar = np.angle(mean_unit_vector)\n            \n            phase_diffs = phases - phi_bar\n            wrapped_phase_diffs = np.angle(np.exp(1j * phase_diffs))\n            P_bar = np.mean(np.abs(wrapped_phase_diffs))\n\n            results.extend([A_bar, P_bar])\n\n        # Return (A_conv, P_conv, A_adiab, P_adiab) -> reorder to (A_conv, A_adiab, P_conv, P_adiab)\n        return results[0], results[2], results[1], results[3]\n\n    # Define test cases from the problem statement\n    test_cases = [\n        # (TE_ms, T2_ms, a, b_Hz)\n        (60.0, 70.0, -0.2, 80.0),\n        (80.0, 60.0, -0.5, 120.0),\n        (50.0, 100.0, 0.0, 0.0),\n    ]\n\n    L = 0.1  # meters\n    N = 101\n    s_min = 0.7\n\n    all_results = []\n    for case in test_cases:\n        TE_ms, T2_ms, a, b_Hz = case\n        metrics = run_simulation(TE_ms, T2_ms, a, b_Hz, s_min, L, N)\n        all_results.extend(metrics)\n    \n    # Format and print the final output\n    formatted_results = [f\"{val:.6f}\" for val in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "4935662"}]}