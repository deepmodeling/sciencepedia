{"hands_on_practices": [{"introduction": "第一个练习将聚焦于CT窗技术的基本原理。通过从目标组织的期望灰度值反向推算，你将计算出所需的窗位（$WL$），从而加深对这些参数如何直接控制图像亮度和对比度的理解[@problem_id:4873173]。", "problem": "计算机断层扫描 (CT) 的显示流程将选定窗内的亨斯菲尔德单位 (HU) 映射为灰度值。该窗由窗位 $WL$（以HU为单位的窗中心）和窗宽 $WW$（窗的完整HU范围）参数化。窗的下限 $L$ 和上限 $U$ 由 $L = WL - WW/2$ 和 $U = WL + WW/2$ 定义。在窗内，组织值 $h$ 被线性映射，使得 $L$ 对应于灰度值 $0$，而 $U$ 对应于灰度值 $255$。在此线性映射之后，灰度值会根据规则 $\\mathrm{round}(n + 0.5) = n + 1$（对于任意整数 $n$）舍入到最接近的整数。\n\n一个成像协议将窗宽设置为 $WW = 512$ $\\mathrm{HU}$，并旨在选择一个窗位 $WL$，使得HU值为 $h = 40$ 的目标组织在舍入前，能精确映射到期望的灰度值 $y = 153$。确定为实现此舍入前条件所需的 $WL$ 值。\n\n以 $\\mathrm{HU}$ 为单位表示 $WL$ 的最终数值，并将答案舍入到四位有效数字。", "solution": "我们从计算机断层扫描（CT）中窗技术的标准定义开始。设 $WL$ 为窗位，$WW$ 为窗宽。窗的下限和上限为\n$$\nL = WL - \\frac{WW}{2}, \\qquad U = WL + \\frac{WW}{2}.\n$$\n在窗 $[L, U]$ 内，亨斯菲尔德单位 $h$ 被线性映射到 $[0, 255]$ 范围内的灰度值，使得 $h=L$ 映射到 $0$，$h=U$ 映射到 $255$。满足这些端点条件的唯一线性映射具有以下形式\n$$\ng(h) = \\alpha \\,(h - L),\n$$\n其中 $g(L)=0$ 且 $g(U)=255$。应用 $g(U)=255$ 可得\n$$\n255 = \\alpha \\,(U - L) \\quad \\Rightarrow \\quad \\alpha = \\frac{255}{U - L}.\n$$\n因此，对于任意 $h \\in [L, U]$，其舍入前的灰度值为\n$$\ng(h) = \\frac{255\\,(h - L)}{U - L}.\n$$\n将 $L$ 和 $U$ 关于 $WL$ 和 $WW$ 的表达式代入，可得 $U - L = WW$ 和 $h - L = h - \\left(WL - \\frac{WW}{2}\\right) = h - WL + \\frac{WW}{2}$。因此，\n$$\ng(h) = \\frac{255\\left(h - WL + \\frac{WW}{2}\\right)}{WW} = 127.5 + \\frac{255\\,(h - WL)}{WW}.\n$$\n协议要求在舍入前，灰度值等于期望的目标值 $y$。因此我们令\n$$\ng(h) = y,\n$$\n得到\n$$\n127.5 + \\frac{255\\,(h - WL)}{WW} = y.\n$$\n解出 $WL$，\n$$\n\\frac{255\\,(h - WL)}{WW} = y - 127.5\n\\quad \\Rightarrow \\quad\nh - WL = \\frac{WW\\,(y - 127.5)}{255}\n\\quad \\Rightarrow \\quad\nWL = h - \\frac{WW\\,(y - 127.5)}{255}.\n$$\n现在代入给定的数值 $h = 40$，$WW = 512$ 和 $y = 153$：\n$$\nWL = 40 - \\frac{512\\,(153 - 127.5)}{255}.\n$$\n计算括号中的差值：\n$$\n153 - 127.5 = 25.5,\n$$\n所以\n$$\nWL = 40 - \\frac{512 \\times 25.5}{255}.\n$$\n计算该分式：\n$$\n512 \\times 25.5 = 13056, \\qquad \\frac{13056}{255} = 51.2,\n$$\n因此\n$$\nWL = 40 - 51.2 = -11.2.\n$$\n以 $\\mathrm{HU}$ 为单位表示窗位，并舍入到四位有效数字，我们得到 $-11.20$ $\\mathrm{HU}$。", "answer": "$$\\boxed{-11.20}$$", "id": "4873173"}, {"introduction": "在掌握了基本计算后，这个练习将探讨窗技术设置如何影响解剖结构的可视化判读。你将分析一个简化的组织边界模型，量化改变窗宽（$WW$）如何改变边缘的“可见”锐度，这揭示了在对比度增强和因饱和而导致的信息丢失之间的关键权衡[@problem_id:4873184]。", "problem": "一个穿过软组织和皮质骨之间高对比度界面的计算机断层扫描（CT）线性剖面，被建模为一个带部分容积平均效应的一维边缘扩散函数。软组织的真实亨斯菲尔德单位（HU）值为 $h_{s} = 40$，骨骼的真实值为 $h_{b} = 1400$。由于空间分辨率有限，边缘被展宽成一个宽度为 $L = 2$ 像素的线性斜坡，因此，跨越该边缘的HU值作为位置 $x$（单位为像素）的函数为\n$$\nh(x) =\n\\begin{cases}\nh_{s},  x \\leq 0, \\\\\nh_{s} + \\dfrac{h_{b} - h_{s}}{L}\\,x,  0  x  L, \\\\\nh_{b},  x \\geq L.\n\\end{cases}\n$$\n显示的灰度强度是通过标准的线性窗位（WL）和窗宽（WW）变换从HU值得到的：对于 $h \\leq WL - WW/2$，强度被限制为黑色；对于 $h \\geq WL + WW/2$，强度被限制为白色；在这两个边界之间，强度被线性映射。\n\n定义“可见过渡宽度”$W_{\\text{vis}}$（单位为像素）为一段 $x$ 坐标区间的长度，在此区间上，显示强度既不被限制为黑色也不被限制为白色；换言之，即满足 $WL - WW/2  h(x)  WL + WW/2$ 的 $x$ 值集合的长度。\n\n对于固定的窗位 $WL = 200$，比较两种窗宽：窄窗 $WW_{1} = 300$ 和宽窗 $WW_{2} = 1200$。计算比率\n$$\nR = \\dfrac{W_{\\text{vis}}(WW_{1})}{W_{\\text{vis}}(WW_{2})},\n$$\n其中 $W_{\\text{vis}}(WW)$ 是在窗宽为 $WW$ 时的可见过渡宽度（单位为像素）。将 $R$ 的最终答案四舍五入到三位有效数字。将答案表示为一个无单位的小数。", "solution": "问题要求计算，将两种不同的显示窗设置应用于一个建模的CT边缘剖面时，“可见过渡宽度”的比率。\n\n首先，我们必须严谨地验证问题陈述。\n已知条件是：\n- 软组织亨斯菲尔德单位（HU）值：$h_{s} = 40$。\n- 皮质骨HU值：$h_{b} = 1400$。\n- 线性斜坡边缘的宽度：$L = 2$ 像素。\n- HU剖面函数 $h(x)$:\n$$\nh(x) =\n\\begin{cases}\nh_{s},  x \\leq 0, \\\\\nh_{s} + \\dfrac{h_{b} - h_{s}}{L}\\,x,  0  x  L, \\\\\nh_{b},  x \\geq L.\n\\end{cases}\n$$\n- 显示窗位：$WL = 200$。\n- 两种窗宽：$WW_{1} = 300$ 和 $WW_{2} = 1200$。\n- 可见过渡宽度 $W_{\\text{vis}}$ 定义为满足 $WL - WW/2  h(x)  WL + WW/2$ 的 $x$ 值集合的长度。\n- 目标是计算比率 $R = \\frac{W_{\\text{vis}}(WW_{1})}{W_{\\text{vis}}(WW_{2})}$。\n\n该问题在科学上基于CT成像的原理，提法适定，包含了所有必要信息，并且陈述客观。“可见过渡宽度”的定义需要仔细解读。字面上的解读可能会包含HU值恒定的区域（即 $x \\leq 0$ 或 $x \\geq L$），在某些窗设置下这可能导致无限的宽度。然而，“过渡”一词强烈暗示着关注HU值正在变化的区域。斜坡区域，$0  x  L$，是剖面中唯一代表过渡的部分。因此，在物理上和上下文中，最合理的解释是 $W_{\\text{vis}}$ 是过渡区间 $(0, L)$ 中落在显示窗内的子集的长度。我们将基于这个充分合理的解释进行计算。\n\n设HU显示窗的下界和上界分别为 $h_{lower} = WL - WW/2$ 和 $h_{upper} = WL + WW/2$。一个HU值被显示为灰色（即不被限制为黑色或白色）的条件是 $h_{lower}  h(x)  h_{upper}$。\n\n函数的线性斜坡部分定义在 $x \\in (0, L)$ 上。函数为 $h(x) = h_{s} + m x$，其中斜率 $m$ 是：\n$$m = \\dfrac{h_{b} - h_{s}}{L} = \\dfrac{1400 - 40}{2} = \\dfrac{1360}{2} = 680 \\text{ HU/像素}$$\n因此，对于 $x \\in (0, 2)$，我们有 $h(x) = 40 + 680x$。这个斜坡上的HU值范围从 $h(x \\to 0^+) = 40$ 到 $h(x \\to 2^-) = 40 + 680(2) = 1400$。所以，过渡区中的HU值在开区间 $(h_s, h_b) = (40, 1400)$ 内。\n\n过渡区内可见的 $x$ 值集合是 $\\{x \\in (0,L) \\mid h_{lower}  h(x)  h_{upper}\\}$。由于 $h(x)$ 在此区间上是单调的，这个集合将是一个开区间 $(x_{min}, x_{max})$。可见宽度为 $W_{\\text{vis}} = x_{max} - x_{min}$。我们可以找到既在斜坡上又在显示窗内的HU值区间。这个区间是 $(\\max(h_s, h_{lower}), \\min(h_b, h_{upper}))$。我们称这个区间为 $(h_{vis, min}, h_{vis, max})$。如果 $h_{vis, min} \\geq h_{vis, max}$，则可见宽度为0。相应的空间宽度通过反转斜坡方程 $x = (h(x) - h_s)/m$ 得到。\n$$W_{\\text{vis}} = x(h_{vis, max}) - x(h_{vis, min}) = \\dfrac{h_{vis, max} - h_{vis, min}}{m}$$\n\n让我们计算每种情况下的 $W_{\\text{vis}}$。\n\n情况1：窄窗，$WW_{1} = 300$。\n固定的窗位是 $WL = 200$。\nHU窗的边界是：\n$h_{lower,1} = WL - WW_{1}/2 = 200 - 300/2 = 200 - 150 = 50$。\n$h_{upper,1} = WL + WW_{1}/2 = 200 + 300/2 = 200 + 150 = 350$。\nHU的显示窗是 $(50, 350)$。\n\n斜坡上的HU值在 $(40, 1400)$ 范围内。这两个区间的交集是：\n$h_{vis, min, 1} = \\max(40, 50) = 50$。\n$h_{vis, max, 1} = \\min(1400, 350) = 350$。\n斜坡上可见的HU值区间是 $(50, 350)$。\n可见过渡宽度是：\n$$W_{\\text{vis}}(WW_{1}) = \\dfrac{h_{vis, max, 1} - h_{vis, min, 1}}{m} = \\dfrac{350 - 50}{680} = \\dfrac{300}{680} = \\dfrac{30}{68} = \\dfrac{15}{34} \\text{ 像素}$$\n\n情况2：宽窗，$WW_{2} = 1200$。\n固定的窗位是 $WL = 200$。\nHU窗的边界是：\n$h_{lower,2} = WL - WW_{2}/2 = 200 - 1200/2 = 200 - 600 = -400$。\n$h_{upper,2} = WL + WW_{2}/2 = 200 + 1200/2 = 200 + 600 = 800$。\nHU的显示窗是 $(-400, 800)$。\n\n斜坡上的HU值在 $(40, 1400)$ 范围内。这两个区间的交集是：\n$h_{vis, min, 2} = \\max(40, -400) = 40$。\n$h_{vis, max, 2} = \\min(1400, 800) = 800$。\n斜坡上可见的HU值区间是 $(40, 800)$。\n可见过渡宽度是：\n$$W_{\\text{vis}}(WW_{2}) = \\dfrac{h_{vis, max, 2} - h_{vis, min, 2}}{m} = \\dfrac{800 - 40}{680} = \\dfrac{760}{680} = \\dfrac{76}{68} = \\dfrac{19}{17} \\text{ 像素}$$\n\n最后，我们计算所需的比率 $R$。\n$$R = \\dfrac{W_{\\text{vis}}(WW_{1})}{W_{\\text{vis}}(WW_{2})} = \\dfrac{15/34}{19/17}$$\n$$R = \\dfrac{15}{34} \\times \\dfrac{17}{19} = \\dfrac{15}{2 \\times 17} \\times \\dfrac{17}{19} = \\dfrac{15}{2 \\times 19} = \\dfrac{15}{38}$$\n将答案表示为四舍五入到三位有效数字的小数：\n$$R = \\dfrac{15}{38} \\approx 0.3947368...$$\n四舍五入到三位有效数字得到 $0.395$。", "answer": "$$\\boxed{0.395}$$", "id": "4873184"}, {"introduction": "最后的这个练习探讨了定量医学影像中的一个关键问题：在显示图像上进行测量的风险。你将推导在灰度域中应用的分割阈值与其在亨氏单位（$HU$）域中真实等价值之间的数学关系，从而揭示显示设置如何给定量分析引入偏差[@problem_id:4873151]。", "problem": "一幅计算机断层扫描（CT）图像以亨斯菲尔德单位（HU）存储，表示为 $h \\in \\mathbb{R}$。为了进行显示，系统使用窗位 $WL$ 和窗宽 $WW$ 将HU值映射到8位灰度值 $g \\in [0,255]$。显示窗口的下限和上限截止值定义为 $L = WL - \\frac{WW}{2}$ 和 $U = WL + \\frac{WW}{2}$。所有HU值 $h \\leq L$ 显示为 $g = 0$，所有HU值 $h \\geq U$ 显示为 $g = 255$，而值 $h \\in (L, U)$ 则使用0到255之间的线性斜坡进行显示。一个感兴趣区域（ROI）分割算法对显示的灰度值进行阈值处理：一个体素被分类为属于ROI，当且仅当 $g \\geq t_{g}$，其中 $t_{g} \\in [0,255]$ 是用户在显示域中选择的阈值。\n\n从这些定义出发，并且在不假设除了8位离散化之外的任何额外显示非线性或量化效应的情况下，推导出一个HU域阈值 $t_{h}$ 的解析表达式，使得在给定的窗变换下，$h \\geq t_{h}$ 与 $g \\geq t_{g}$ 完全等价，并假设 $t_{g} \\in [0,255]$ 和 $h \\in [L,U]$（即在线性斜坡区域内）。您的推导应清楚地表明，对显示值进行阈值处理如何在等效的HU阈值中引入对 $WW$ 的依赖性。\n\n以亨斯菲尔德单位（HU）表示您对 $t_{h}$ 的最终答案。不需要四舍五入；请提供一个以 $WL$、$WW$ 和 $t_{g}$ 表示的闭式表达式。", "solution": "### 推导过程\n目标是找到亨斯菲尔德单位 (HU) 阈值 $t_h$ 的一个解析表达式，该阈值等价于给定的灰度阈值 $t_g$，适用于 HU 值落在显示窗口线性部分的体素。\n\n首先，我们定义将 HU 值 $h$ 映射到灰度值 $g$ 的线性变换。问题陈述，对于窗口内的 HU 值 $h$，灰度值 $g$ 在 0 到 255 的范围内线性变化。这个线性映射定义在 HU 区间 $[L, U]$ 上。这个线性段的端点是 $(h_1, g_1) = (L, 0)$ 和 $(h_2, g_2) = (U, 255)$。\n\n通过这两点的直线方程可以用点斜式表示为：\n$$g(h) - g_1 = m(h - h_1)$$\n斜率 $m$ 由下式给出：\n$$m = \\frac{g_2 - g_1}{h_2 - h_1} = \\frac{255 - 0}{U - L}$$\n问题将下限和上限截止值定义为 $L = WL - \\frac{WW}{2}$ 和 $U = WL + \\frac{WW}{2}$。其差值，即 HU 窗口的宽度，是：\n$$U - L = \\left(WL + \\frac{WW}{2}\\right) - \\left(WL - \\frac{WW}{2}\\right) = WW$$\n将此代入斜率表达式中，得到：\n$$m = \\frac{255}{WW}$$\n现在，我们可以写出对于 $h \\in [L, U]$ 的完整线性映射函数：\n$$g(h) - 0 = \\frac{255}{WW}(h - L)$$\n$$g(h) = \\frac{255}{WW}(h - L)$$\n问题将显示域中的分割条件定义为 $g \\geq t_g$。我们寻求 HU 域中形式为 $h \\geq t_h$ 的等价条件。分析仅限于域 $h \\in [L, U]$。对于这些值，我们可以代入 $g(h)$ 的表达式：\n$$\\frac{255}{WW}(h - L) \\geq t_g$$\n为了解出 $h$，我们可以将两边乘以 $\\frac{WW}{255}$。由于对于一个非平凡的窗口，$WW$ 必须为正，此操作不会改变不等号的方向：\n$$h - L \\geq t_g \\cdot \\frac{WW}{255}$$\n将 $L$ 加到两边以分离 $h$：\n$$h \\geq L + t_g \\frac{WW}{255}$$\n这个不等式是所期望的 $h \\geq t_h$ 形式。通过直接比较，我们确定 HU 域阈值 $t_h$ 为：\n$$t_h = L + t_g \\frac{WW}{255}$$\n为了用初始参数 $WL$、$WW$ 和 $t_g$ 来表示 $t_h$，我们代入 $L = WL - \\frac{WW}{2}$ 的定义：\n$$t_h = \\left(WL - \\frac{WW}{2}\\right) + t_g \\frac{WW}{255}$$\n这个表达式可以重新整理，以更好地说明 $t_h$ 对窗参数的依赖性。我们可以提出 $WW$ 的因子：\n$$t_h = WL + WW \\left(\\frac{t_g}{255}\\right) - WW \\left(\\frac{1}{2}\\right)$$\n$$t_h = WL + WW \\left( \\frac{t_g}{255} - \\frac{1}{2} \\right)$$\n这个最终表达式代表了亨斯菲尔德单位阈值 $t_h$，它等效于对显示图像应用灰度阈值 $t_g$，其约束条件是分析仅限于落在显示窗口 $[L, U]$ 内的 HU 值。这一结果明确表明，在显示域中应用的阈值 ($t_g$) 对应于一个依赖于窗位 ($WL$) 和窗宽 ($WW$) 的 HU 域阈值 ($t_h$)。", "answer": "$$\\boxed{WL + WW \\left( \\frac{t_g}{255} - \\frac{1}{2} \\right)}$$", "id": "4873151"}]}