{"hands_on_practices": [{"introduction": "要有效抑制散斑，我们首先需要一种量化其强度的方法。本练习将引导您从相干成像的物理基础出发，通过数学推导，揭示“完全形成”的散斑的一个标志性统计特性——单位对比度。通过这个实践，您将深入理解散斑的随机本质，并掌握其最核心的度量标准。[@problem_id:4926689]", "problem": "在完全发展的散斑和单视条件下，相干医学超声成像中单个像素处检测到的基带复数场可以建模为许多具有随机相位的亚分辨率散射体的叠加。根据中心极限定理，该复数场的同相和正交分量可建模为零均值、等方差的独立同分布高斯随机变量。设复数场为 $U = X + \\mathrm{j} Y$，其中 $X \\sim \\mathcal{N}(0,\\sigma^{2})$，$Y \\sim \\mathcal{N}(0,\\sigma^{2})$，且 $X$ 和 $Y$ 相互独立。包络振幅为 $A = \\sqrt{X^{2} + Y^{2}}$，强度为 $I = A^{2}$。定义强度散斑衬比度为 $C = \\sigma_{I}/\\mu_{I}$，其中 $\\mu_{I} = \\mathbb{E}[I]$ 且 $\\sigma_{I} = \\sqrt{\\mathrm{Var}(I)}$；定义振幅衬比度为 $C_{A} = \\sigma_{A}/\\mu_{A}$，其中 $\\mu_{A} = \\mathbb{E}[A]$ 且 $\\sigma_{A} = \\sqrt{\\mathrm{Var}(A)}$。从所述高斯模型出发，并仅在随机变量变换中使用概率守恒和变量替换方法，推导在单视 ($L = 1$) 条件下 $C$ 和 $C_{A}$ 的闭式表达式。将最终答案表示为精确解析形式的数对 $\\left(C, C_{A}\\right)$。不要进行近似或四舍五入。", "solution": "此问题是有效的。它是医学成像统计物理学中一个标准的、适定(well-posed)的问题。我们给定了一个复数场模型 $U = X + \\mathrm{j}Y$，其中 $X$ 和 $Y$ 是独立同分布 (i.i.d.) 的零均值高斯随机变量，$X, Y \\sim \\mathcal{N}(0, \\sigma^2)$。我们需要推导强度 $I = X^2 + Y^2$ 和振幅 $A = \\sqrt{I}$ 的衬比度。\n\n首先，我们求出振幅 $A$ 和强度 $I$ 的概率密度函数 (PDF)。由于 $X$ 和 $Y$ 相互独立，它们的联合概率密度函数由各自概率密度函数的乘积给出：\n$$ p_{X,Y}(x,y) = p_X(x) p_Y(y) = \\frac{1}{\\sqrt{2\\pi\\sigma^2}}\\exp\\left(-\\frac{x^2}{2\\sigma^2}\\right) \\frac{1}{\\sqrt{2\\pi\\sigma^2}}\\exp\\left(-\\frac{y^2}{2\\sigma^2}\\right) = \\frac{1}{2\\pi\\sigma^2}\\exp\\left(-\\frac{x^2+y^2}{2\\sigma^2}\\right) $$\n为了求出振幅 $A$ 的概率密度函数，我们将笛卡尔坐标 $(x,y)$ 变换为极坐标 $(a,\\theta)$，其中 $x=a\\cos\\theta$ 且 $y=a\\sin\\theta$。振幅为 $A=a=\\sqrt{x^2+y^2}$，相位为 $\\Theta=\\theta=\\arctan(y/x)$。此变换的雅可比行列式为 $|J| = a$。使用变量替换公式，得到 $A$ 和 $\\Theta$ 的联合概率密度函数为：\n$$ p_{A,\\Theta}(a,\\theta) = p_{X,Y}(a\\cos\\theta, a\\sin\\theta) |J| = \\frac{1}{2\\pi\\sigma^2}\\exp\\left(-\\frac{a^2}{2\\sigma^2}\\right) a $$\n此式在 $a \\ge 0$ 和 $0 \\le \\theta  2\\pi$ 时有效。为了求出振幅 $A$ 的边缘概率密度函数，我们对所有可能的 $\\theta$ 值进行积分：\n$$ p_A(a) = \\int_0^{2\\pi} p_{A,\\Theta}(a,\\theta) d\\theta = \\int_0^{2\\pi} \\frac{a}{2\\pi\\sigma^2}\\exp\\left(-\\frac{a^2}{2\\sigma^2}\\right) d\\theta = \\frac{a}{\\sigma^2}\\exp\\left(-\\frac{a^2}{2\\sigma^2}\\right) $$\n这就是 $a \\ge 0$ 时的瑞利分布。\n\n接下来，我们计算振幅 $A$ 的矩。$A$ 的 $k$ 阶矩由 $\\mathbb{E}[A^k] = \\int_0^\\infty a^k p_A(a) da$ 给出：\n$$ \\mathbb{E}[A^k] = \\int_0^\\infty a^k \\frac{a}{\\sigma^2}\\exp\\left(-\\frac{a^2}{2\\sigma^2}\\right) da = \\frac{1}{\\sigma^2} \\int_0^\\infty a^{k+1} \\exp\\left(-\\frac{a^2}{2\\sigma^2}\\right) da $$\n令 $z = a^2/(2\\sigma^2)$，这意味着 $a = \\sqrt{2\\sigma^2 z}$ 且 $da = \\frac{\\sigma}{\\sqrt{2z}}dz$。积分变为：\n$$ \\mathbb{E}[A^k] = \\frac{1}{\\sigma^2} \\int_0^\\infty (\\sqrt{2\\sigma^2 z})^{k+1} \\exp(-z) \\frac{\\sigma}{\\sqrt{2z}} dz = \\frac{(2\\sigma^2)^{(k+1)/2}}{\\sigma^2} \\frac{\\sigma}{\\sqrt{2}} \\int_0^\\infty z^{(k+1)/2} z^{-1/2} \\exp(-z) dz $$\n$$ \\mathbb{E}[A^k] = (2\\sigma^2)^{k/2} \\int_0^\\infty z^{k/2} \\exp(-z) dz $$\n该积分为伽玛函数 $\\Gamma(s) = \\int_0^\\infty t^{s-1}e^{-t} dt$，其中 $s = k/2+1$。因此，瑞利分布变量的 $k$ 阶矩的通用表达式为：\n$$ \\mathbb{E}[A^k] = (2\\sigma^2)^{k/2} \\Gamma\\left(\\frac{k}{2}+1\\right) $$\n现在我们可以计算振幅衬比度 $C_A = \\sigma_A/\\mu_A$ 所需的矩。\n平均振幅 $\\mu_A = \\mathbb{E}[A]$（当 $k=1$ 时）：\n$$ \\mu_A = (2\\sigma^2)^{1/2} \\Gamma\\left(\\frac{1}{2}+1\\right) = \\sigma\\sqrt{2} \\Gamma\\left(\\frac{3}{2}\\right) = \\sigma\\sqrt{2} \\left(\\frac{1}{2}\\Gamma\\left(\\frac{1}{2}\\right)\\right) = \\sigma\\sqrt{2} \\frac{\\sqrt{\\pi}}{2} = \\sigma\\sqrt{\\frac{\\pi}{2}} $$\n均方振幅 $\\mathbb{E}[A^2]$（当 $k=2$ 时）：\n$$ \\mathbb{E}[A^2] = (2\\sigma^2)^{2/2} \\Gamma\\left(\\frac{2}{2}+1\\right) = 2\\sigma^2 \\Gamma(2) = 2\\sigma^2 (1!) = 2\\sigma^2 $$\n振幅的方差为 $\\sigma_A^2 = \\mathrm{Var}(A) = \\mathbb{E}[A^2] - (\\mathbb{E}[A])^2$：\n$$ \\sigma_A^2 = 2\\sigma^2 - \\left(\\sigma\\sqrt{\\frac{\\pi}{2}}\\right)^2 = 2\\sigma^2 - \\sigma^2 \\frac{\\pi}{2} = \\sigma^2\\left(2-\\frac{\\pi}{2}\\right) $$\n振幅衬比度 $C_A$ 是标准差与均值的比率：\n$$ C_A = \\frac{\\sigma_A}{\\mu_A} = \\frac{\\sqrt{\\sigma^2(2-\\pi/2)}}{\\sigma\\sqrt{\\pi/2}} = \\sqrt{\\frac{2-\\pi/2}{\\pi/2}} = \\sqrt{\\frac{4-\\pi}{\\pi}} $$\n\n接下来，我们推导强度衬比度 $C = \\sigma_I/\\mu_I$。强度为 $I=A^2$。我们可以利用 $A$ 的矩来求出它的矩。\n平均强度 $\\mu_I = \\mathbb{E}[I] = \\mathbb{E}[A^2]$。我们已经计算过此值：\n$$ \\mu_I = 2\\sigma^2 $$\n为了求出方差 $\\sigma_I^2 = \\mathbb{E}[I^2] - (\\mu_I)^2$，我们首先需要 $\\mathbb{E}[I^2] = \\mathbb{E}[(A^2)^2] = \\mathbb{E}[A^4]$。使用 $A$ 的通用矩公式，并令 $k=4$：\n$$ \\mathbb{E}[A^4] = (2\\sigma^2)^{4/2} \\Gamma\\left(\\frac{4}{2}+1\\right) = (2\\sigma^2)^2 \\Gamma(3) = 4\\sigma^4 (2!) = 8\\sigma^4 $$\n强度的方差为：\n$$ \\sigma_I^2 = \\mathbb{E}[A^4] - (\\mathbb{E}[A^2])^2 = 8\\sigma^4 - (2\\sigma^2)^2 = 8\\sigma^4 - 4\\sigma^4 = 4\\sigma^4 $$\n强度衬比度 $C$ 是强度标准差 $\\sigma_I = \\sqrt{4\\sigma^4} = 2\\sigma^2$ 与平均强度 $\\mu_I$ 的比率：\n$$ C = \\frac{\\sigma_I}{\\mu_I} = \\frac{2\\sigma^2}{2\\sigma^2} = 1 $$\n对于完全发展的单视散斑，这是一个经典结果。\n\n这个问题也可以通过先求出强度 $I=A^2$ 的概率密度函数来解决。利用 $p_I(i)di = p_A(a)da$ 和 $a=\\sqrt{i}$，我们得到 $da/di=1/(2\\sqrt{i})$。\n$$ p_I(i) = p_A(\\sqrt{i})\\left|\\frac{da}{di}\\right| = \\frac{\\sqrt{i}}{\\sigma^2}\\exp\\left(-\\frac{i}{2\\sigma^2}\\right) \\frac{1}{2\\sqrt{i}} = \\frac{1}{2\\sigma^2}\\exp\\left(-\\frac{i}{2\\sigma^2}\\right) $$\n这是 $i \\ge 0$ 的负指数分布，其均值为 $\\mu_I = 2\\sigma^2$，标准差为 $\\sigma_I = 2\\sigma^2$。因此，$C = \\sigma_I/\\mu_I = 1$。这证实了结果。\n\n最终答案是数对 $(C, C_A)$。我们已经求得 $C=1$ 和 $C_A = \\sqrt{\\frac{4-\\pi}{\\pi}}$。", "answer": "$$ \\boxed{\\left(1, \\sqrt{\\frac{4-\\pi}{\\pi}}\\right)} $$", "id": "4926689"}, {"introduction": "在理解了单视图像中散斑的严重性之后，一个自然的问题是：我们如何抑制它？本练习将探讨一种基础且有效的散斑抑制技术——多视复合法。您将推导平均多个独立散斑图样如何显著降低散斑对比度，从而直观地理解为何增加“视”的数量可以改善图像质量。[@problem_id:4926672]", "problem": "在相干医学超声（US）成像中，斑点噪声是由许多未分辨散射体的回波随机干涉产生的，从而产生随机的图像强度。考虑一个像素，其单视强度（对于视指数 $k$ 记为 $I_{k}$）在完全发展的斑点条件下生成，并被建模为均值为 $\\mu$ 的指数随机变量，其中 $k = 1, 2, \\dots, L$。一个多视复合成像系统通过对 $L$ 个视进行算术平均来形成显示的像素强度，因此 $I = \\frac{1}{L}\\sum_{k=1}^{L} I_{k}$。斑点对比度定义为 $C = \\frac{\\sigma_{I}}{\\mu_{I}}$，其中 $\\mu_{I}$ 是 $I$ 的均值，$\\sigma_{I}$ 是 $I$ 的标准差。从期望和方差的基本定义出发，并利用关于完全发展的斑点（指数强度统计特性）的成熟理论，当 $L$ 个视在统计上独立且均值相等时，推导出 $C$ 关于 $L$ 的闭式表达式。清楚地说明所推导的标度关系成立所需的物理-统计假设。将最终答案表示为关于 $L$ 的单个解析表达式。不需要四舍五入。斑点对比度是无量纲的；不要报告单位。", "solution": "所述问题具有科学依据、适定、客观，并包含了获得唯一解所需的所有信息。它基于医学超声成像中斑点形成和抑制的标准、已验证模型。因此，该问题被认为是有效的，下面提供完整解答。\n\n目标是推导多视复合图像强度 $I$ 的斑点对比度 $C$ 的闭式表达式。斑点对比度定义为：\n$$C = \\frac{\\sigma_{I}}{\\mu_{I}}$$\n其中 $\\mu_{I}$ 是复合强度 $I$ 的均值，$\\sigma_{I}$ 是其标准差。\n\n复合强度 $I$ 是由 $L$ 个独立的单视强度 $I_k$ 的算术平均形成的：\n$$I = \\frac{1}{L}\\sum_{k=1}^{L} I_{k}$$\n每个单视强度 $I_k$ 被建模为均值为 $\\mu$ 的指数随机变量。问题陈述了 $L$ 个视是统计独立的并且具有相等的均值。\n\n首先，我们确定复合强度 $\\mu_I$ 的均值。根据期望的定义：\n$$\\mu_I = E[I] = E\\left[\\frac{1}{L}\\sum_{k=1}^{L} I_{k}\\right]$$\n利用期望算子的线性性质，我们可以写出：\n$$\\mu_I = \\frac{1}{L} E\\left[\\sum_{k=1}^{L} I_{k}\\right] = \\frac{1}{L} \\sum_{k=1}^{L} E[I_{k}]$$\n我们已知每个视 $I_k$ 具有相同的均值 $E[I_k] = \\mu$。将此代入方程：\n$$\\mu_I = \\frac{1}{L} \\sum_{k=1}^{L} \\mu = \\frac{1}{L} (L \\mu)$$\n$$\\mu_I = \\mu$$\n这表明复合图像的平均强度与任何单个视的平均强度相同。\n\n接下来，我们确定复合强度的标准差 $\\sigma_I$。我们首先计算方差 $\\sigma_I^2 = \\text{Var}(I)$。\n$$\\sigma_I^2 = \\text{Var}(I) = \\text{Var}\\left(\\frac{1}{L}\\sum_{k=1}^{L} I_{k}\\right)$$\n使用方差的性质 $\\text{Var}(aX) = a^2 \\text{Var}(X)$，其中 $a$ 是一个常数：\n$$\\sigma_I^2 = \\left(\\frac{1}{L}\\right)^2 \\text{Var}\\left(\\sum_{k=1}^{L} I_{k}\\right) = \\frac{1}{L^2} \\text{Var}\\left(\\sum_{k=1}^{L} I_{k}\\right)$$\n提供的一个关键条件是 $L$ 个视 $I_k$ 是统计独立的。对于独立随机变量的和，其和的方差等于各项方差的和：\n$$\\text{Var}\\left(\\sum_{k=1}^{L} I_{k}\\right) = \\sum_{k=1}^{L} \\text{Var}(I_k)$$\n将此代入 $\\sigma_I^2$ 的表达式中：\n$$\\sigma_I^2 = \\frac{1}{L^2} \\sum_{k=1}^{L} \\text{Var}(I_k)$$\n我们现在必须求出单视强度 $\\text{Var}(I_k)$ 的方差。问题陈述 $I_k$ 是一个均值为 $\\mu$ 的指数随机变量。指数分布的一个众所周知的性质是其方差等于其均值的平方。因此：\n$$\\text{Var}(I_k) = \\mu^2$$\n因为所有的视都有相同的均值 $\\mu$，所以它们都有相同的方差 $\\mu^2$。将此代入 $\\sigma_I^2$ 的方程中：\n$$\\sigma_I^2 = \\frac{1}{L^2} \\sum_{k=1}^{L} \\mu^2 = \\frac{1}{L^2} (L \\mu^2)$$\n$$\\sigma_I^2 = \\frac{\\mu^2}{L}$$\n标准差 $\\sigma_I$ 是方差的平方根。由于强度及其均值 $\\mu$ 是非负物理量，我们有：\n$$\\sigma_I = \\sqrt{\\frac{\\mu^2}{L}} = \\frac{\\mu}{\\sqrt{L}}$$\n\n最后，我们可以计算斑点对比度 $C$：\n$$C = \\frac{\\sigma_{I}}{\\mu_{I}} = \\frac{\\frac{\\mu}{\\sqrt{L}}}{\\mu}$$\n$$C = \\frac{1}{\\sqrt{L}}$$\n\n此推导成立所需的物理-统计假设是：\n1.  **完全发展的斑点**：信号是每个分辨单元内大量随机相位、未分辨散射体回波相干叠加的结果。这是产生强度的负指数概率分布的基本条件。\n2.  **指数强度统计特性**：作为完全发展的斑点条件的直接结果，单个未经平均的视的强度 $I_k$ 必须服从负指数分布，对于该分布，标准差等于均值。对于此模型，单视斑点对比度为 $C_1 = \\mu / \\mu = 1$。\n3.  **视的统计独立性**：$L$ 个独立的视 $I_k$ 必须彼此统计独立。这确保了它们的斑点图案是不相关的，这是“和的方差等于方差的和”这一结论的数学基础。在实践中，这是通过诸如空间复合成像（从不同角度采集图像）或频率复合成像（使用不同的换能器频带）等技术实现的，其中视之间的间隔足以确保去相关。\n4.  **各视的平均强度相等**：假设所有 $L$ 个视都具有相同的潜在平均强度 $\\mu$。这意味着在采集这些视的区域内，潜在的组织反射率是恒定的，并且任何系统性变化，如系统增益或衰减，都已被完全补偿。", "answer": "$$\\boxed{\\frac{1}{\\sqrt{L}}}$$", "id": "4926672"}, {"introduction": "多视复合法成功的关键前提是各个“视”的统计独立性，但在实际应用中，这一理想条件可能因运动或系统参数而无法满足。本练习将理论与实践相结合，要求您设计并实现一个算法，用以检验图像帧之间的散斑是否独立。通过这个编码实践，您将学会如何将物理模型和统计检验转化为可执行的工具，来验证成像过程中的关键假设。[@problem_id:4926687]", "problem": "您需要设计并实现一种算法测试，通过估计对数强度残差块的归一化互相关，并使用统计学原理的阈值来判断是否将其纳入帧复合，从而验证两个超声图像帧之间的独立性。该方法的基础必须从相干成像中散斑形成的物理第一性原理推导得出。\n\n从以下基础开始。在诸如超声的相干成像中，散斑是由许多亚分辨率散射体的回波干涉产生的。像素点的射频复基带信号可以建模为许多独立相量的总和，根据中心极限定理，其同相和正交分量近似为零均值高斯分布。包络振幅则服从瑞利分布。对于位置 $\\mathbf{x}$ 处的图像像素，观察到的包络强度被建模为乘性散斑\n$$\nI(\\mathbf{x}) = S(\\mathbf{x}) \\, N(\\mathbf{x}),\n$$\n其中 $S(\\mathbf{x})$ 是组织的确定性反射率，而 $N(\\mathbf{x})$ 是由随机相量求和产生的散斑振幅。在复合处理中，采集的帧具有理想的独立散斑场，而 $S(\\mathbf{x})$ 保持不变。对数变换将乘性噪声转换为加性形式，\n$$\nL(\\mathbf{x}) = \\log I(\\mathbf{x}) = \\log S(\\mathbf{x}) + \\log N(\\mathbf{x}).\n$$\n如果两帧具有独立的散斑场 $N_1(\\mathbf{x})$ 和 $N_2(\\mathbf{x})$，那么在估计并去除缓慢变化的结构分量 $\\log S(\\mathbf{x})$ 后，残差应近似不相关，这启发我们使用 Pearson 相关系数作为独立性检验。\n\n您的程序必须为每个测试用例实现以下步骤：\n- 通过组合平滑梯度和高斯形夹杂物，在指定大小的二维网格上生成一个确定性反射率模型 $S(x,y)$，并可选择添加正弦条纹以引入边缘。确保 $S(x,y)$ 在任何地方都严格为正。\n- 使用物理上合理的模型模拟两个散斑振幅场 $N_1(x,y)$ 和 $N_2(x,y)$，其中同相和正交分量是相关的零均值高斯场。令 $X_1(x,y)$, $Y_1(x,y)$ 和独立的 $X_3(x,y)$, $Y_3(x,y)$ 为标准高斯场。对于给定的相关参数 $\\rho$（$0 \\le \\rho \\le 1$），构造\n$$\nX_2(x,y) = \\rho \\, X_1(x,y) + \\sqrt{1-\\rho^2} \\, X_3(x,y), \\quad\nY_2(x,y) = \\rho \\, Y_1(x,y) + \\sqrt{1-\\rho^2} \\, Y_3(x,y),\n$$\n并设置\n$$\nN_1(x,y) = \\sqrt{X_1(x,y)^2 + Y_1(x,y)^2}, \\quad\nN_2(x,y) = \\sqrt{X_2(x,y)^2 + Y_2(x,y)^2}.\n$$\n- 对 $i \\in \\{1,2\\}$，形成对数强度图像 $L_i(x,y) = \\log\\big(S(x,y) \\, N_i(x,y)\\big)$。\n- 使用指定标准差 $\\sigma$（以像素为单位）的高斯平滑 $G_\\sigma(\\cdot)$ 估计缓慢变化的结构分量，并计算残差\n$$\nR_i(x,y) = L_i(x,y) - G_\\sigma\\big(L_i(x,y)\\big), \\quad i \\in \\{1,2\\}.\n$$\n- 从每个残差图像中提取一个边长为 $p$ 像素的中心方形块，将每个块展平为向量，并计算 Pearson 相关系数\n$$\nr = \\frac{\\sum_{k=1}^{n} \\big(a_k - \\bar{a}\\big)\\big(b_k - \\bar{b}\\big)}{\\sqrt{\\sum_{k=1}^{n} \\big(a_k - \\bar{a}\\big)^2} \\, \\sqrt{\\sum_{k=1}^{n} \\big(b_k - \\bar{b}\\big)^2}},\n$$\n其中 $a_k$ 和 $b_k$ 索引来自两帧的展平残差向量，$\\bar{a}$ 和 $\\bar{b}$ 是它们的均值，$n = p^2$ 是图像块中的样本数。\n- 在独立性的零假设下，使用 Student’s $t$ 分布设置一个双边决策阈值。对于指定的显著性水平 $\\alpha \\in (0,1)$ 和自由度 $n-2$，计算临界值 $t_\\mathrm{crit}$，使得累积分布函数满足 $P\\big(|T| \\le t_\\mathrm{crit}\\big) = 1 - \\alpha$，其中 $T \\sim t(n-2)$。将此映射到相关阈值\n$$\nr_\\mathrm{crit} = \\frac{t_\\mathrm{crit}}{\\sqrt{t_\\mathrm{crit}^2 + (n-2)}}.\n$$\n- 根据规则“当且仅当 $|r| \\le r_\\mathrm{crit}$ 时纳入”来决定是否进行复合。\n\n您的程序必须为以下测试套件实现上述步骤，并使用提供的随机种子以保证可复现性：\n- 案例 1：图像大小 $64 \\times 64$，图像块边长 $p=32$，相关参数 $\\rho=0$，高斯平滑标准差 $\\sigma=3$，显著性水平 $\\alpha=0.05$，种子 $123$，模型中无条纹。\n- 案例 2：图像大小 $64 \\times 64$，图像块边长 $p=32$，相关参数 $\\rho=0.9$，高斯平滑标准差 $\\sigma=3$，显著性水平 $\\alpha=0.05$，种子 $123$，模型中无条纹。\n- 案例 3：图像大小 $64 \\times 64$，图像块边长 $p=16$，相关参数 $\\rho=0$，高斯平滑标准差 $\\sigma=2$，显著性水平 $\\alpha=0.05$，种子 $456$，模型中包含条纹。\n- 案例 4：图像大小 $64 \\times 64$，图像块边长 $p=32$，相关参数 $\\rho=0.5$，高斯平滑标准差 $\\sigma=3$，显著性水平 $\\alpha=0.01$，种子 $789$，模型中无条纹。\n\n您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔的结果列表（例如，$[result1,result2,result3,result4]$）。每个案例的值必须是一个布尔值，表示在指定的阈值规则下是否将其纳入复合。", "solution": "问题陈述被评估为有效。它在科学上基于相干成像物理和统计信号处理的原理，问题定义良好，所有必要的参数和条件都已指定，并以客观、正式的语言表达。该任务是基于已建立的超声散斑模型（这是医学成像中的一个标准课题）来实现一个明确定义的算法。其中没有矛盾、歧义或事实错误。\n\n该算法用于测试两个超声帧之间散斑图案的统计独立性，这是非相干帧平均（通常称为复合）的关键步骤。复合是一种广泛使用的技术，用于减少散斑噪声并提高超声图像的信噪比。该方法的有效性依赖于对具有不相关散斑图案的帧进行平均，从而确保随机散斑噪声被平均掉，而所有帧共有的底层确定性组织结构得到增强。\n\n该验证算法的设计遵循以下基于第一性原理的步骤。\n\n**1. 散斑的物理模型与对数变换**\n\n在像超声这样的相干成像模式中，图像是通过检测反向散射波的振幅形成的。在任何给定的图像像素处，接收到的信号是来自相应分辨率单元内大量亚分辨率散射体的散射子波的复数和。根据中心极限定理，这种对许多独立随机相量的求和产生一个复信号 $A(\\mathbf{x}) = I(\\mathbf{x}) + jQ(\\mathbf{x})$，其同相分量 $I(\\mathbf{x})$ 和正交分量 $Q(\\mathbf{x})$ 是独立的零均值高斯随机变量。因此，包络振幅 $N(\\mathbf{x}) = \\sqrt{I(\\mathbf{x})^2 + Q(\\mathbf{x})^2}$ 服从瑞利分布。\n\nB 模式超声图像中观察到的强度被建模为乘性过程：\n$$\nI_\\mathrm{obs}(\\mathbf{x}) = S(\\mathbf{x}) \\, N(\\mathbf{x})\n$$\n其中 $S(\\mathbf{x})$ 是我们希望成像的确定性、缓慢变化的组织反射率函数，而 $N(\\mathbf{x})$ 是随机散斑场。噪声的乘性特性使得直接滤波具有挑战性。一种标准方法是应用对数变换将乘性噪声转换为加性噪声：\n$$\nL(\\mathbf{x}) = \\log I_\\mathrm{obs}(\\mathbf{x}) = \\log S(\\mathbf{x}) + \\log N(\\mathbf{x})\n$$\n这里，$\\log S(\\mathbf{x})$ 代表缓慢变化的结构分量，而 $\\log N(\\mathbf{x})$ 代表加性散斑噪声分量。\n\n**2. 相关散斑场的模拟**\n\n为了在受控条件下测试算法，我们必须模拟两个具有已知相关程度的散斑场 $N_1(\\mathbf{x})$ 和 $N_2(\\mathbf{x})$。我们首先生成四个独立的标准正态随机场 $X_1, Y_1, X_3, Y_3$，每个场的维度都与图像相同。这些代表了两个不相关复场的独立同相和正交分量。一对新的相关分量 $(X_2, Y_2)$ 可以构造成独立分量的线性组合，由相关参数 $\\rho \\in [0, 1]$ 控制：\n$$\nX_2(\\mathbf{x}) = \\rho \\, X_1(\\mathbf{x}) + \\sqrt{1-\\rho^2} \\, X_3(\\mathbf{x}) \\\\\nY_2(\\mathbf{x}) = \\rho \\, Y_1(\\mathbf{x}) + \\sqrt{1-\\rho^2} \\, Y_3(\\mathbf{x})\n$$\n这种构造确保了 $X_2$ 和 $Y_2$ 也是标准正态场，并且复信号之间的相关性由 $\\rho$ 控制。具体来说，$\\mathrm{Corr}(X_1, X_2) = \\rho$ 且 $\\mathrm{Corr}(Y_1, Y_2) = \\rho$。然后，两个散斑振幅场计算如下：\n$$\nN_1(\\mathbf{x}) = \\sqrt{X_1(\\mathbf{x})^2 + Y_1(\\mathbf{x})^2} \\\\\nN_2(\\mathbf{x}) = \\sqrt{X_2(\\mathbf{x})^2 + Y_2(\\mathbf{x})^2}\n$$\n当 $\\rho=0$ 时，$N_1$ 和 $N_2$ 从独立的复场导出，模拟了复合的理想条件。当 $\\rho  0$ 时，散斑图案是相关的。\n\n**3. 散斑残差的估计**\n\n核心思想是在对数变换后的图像 $L_1$ 和 $L_2$ 中，将散斑分量与结构分量分离开。由于组织反射率 $S(\\mathbf{x})$ 以及 $\\log S(\\mathbf{x})$ 被假定为低频信号，因此可以使用低通滤波器对其进行估计。一个标准差为 $\\sigma$ 的高斯滤波器，记为 $G_\\sigma(\\cdot)$，是一个合适的选择。将此滤波器应用于对数强度图像，可以得到结构分量的估计：$\\widehat{\\log S(\\mathbf{x})}_i \\approx G_\\sigma(L_i(\\mathbf{x}))$。\n\n然后，通过从对数强度图像中减去这个估计值来获得散斑残差：\n$$\nR_i(\\mathbf{x}) = L_i(\\mathbf{x}) - G_\\sigma(L_i(\\mathbf{x})) = \\big(\\log S(\\mathbf{x}) + \\log N_i(\\mathbf{x})\\big) - G_\\sigma\\big(\\log S(\\mathbf{x}) + \\log N_i(\\mathbf{x})\\big)\n$$\n如果滤波器带宽选择得当，$G_\\sigma(\\log S(\\mathbf{x})) \\approx \\log S(\\mathbf{x})$，残差简化为近似于高通滤波后的散斑分量：\n$$\nR_i(\\mathbf{x}) \\approx \\log N_i(\\mathbf{x}) - G_\\sigma(\\log N_i(\\mathbf{x}))\n$$\n现在，$R_1(\\mathbf{x})$ 和 $R_2(\\mathbf{x})$ 之间的相关性可以作为底层散斑场之间相关性的一个代理。\n\n**4. 独立性的统计检验**\n\n为了量化相关性，我们分析来自每个残差图像 $R_1$ 和 $R_2$ 的中心像素块。设图像块被展平为向量 $\\mathbf{a}$ 和 $\\mathbf{b}$，每个向量的长度为 $n=p^2$，其中 $p$ 是图像块的边长。Pearson 相关系数计算如下：\n$$\nr = \\frac{\\sum_{k=1}^{n} (a_k - \\bar{a})(b_k - \\bar{b})}{\\sqrt{\\sum_{k=1}^{n} (a_k - \\bar{a})^2} \\, \\sqrt{\\sum_{k=1}^{n} (b_k - \\bar{b})^2}}\n$$\n在零假设（$H_0$）下，即样本来自不相关的总体，统计量 $T = r \\sqrt{\\frac{n-2}{1-r^2}}$ 服从自由度为 $\\nu = n-2$ 的 Student's t 分布。\n\n为了决定是接受还是拒绝 $H_0$，我们基于显著性水平 $\\alpha$ 建立一个临界区。对于双边检验，我们从 $t$ 分布的逆累积分布函数（CDF）中找到临界值 $t_\\mathrm{crit}$，使得 $P(|T| \\le t_\\mathrm{crit}) = 1 - \\alpha$。这等同于找到 $t_\\mathrm{crit}$ 使得上尾概率为 $\\alpha/2$。\n\n这个临界 $t$ 值可以转换回一个临界相关性值 $r_\\mathrm{crit}$。通过重新排列 $T$ 的公式，我们得到：\n$$\nr_\\mathrm{crit} = \\frac{t_\\mathrm{crit}}{\\sqrt{t_\\mathrm{crit}^2 + \\nu}} = \\frac{t_\\mathrm{crit}}{\\sqrt{t_\\mathrm{crit}^2 + n-2}}\n$$\n那么决策规则是：如果测得的相关性绝对值 $|r|$ 小于或等于临界阈值 $r_\\mathrm{crit}$，我们不拒绝独立性的零假设，并且该帧被认为适合纳入复合。否则，如果 $|r|  r_\\mathrm{crit}$，则认为这些帧显著相关，应拒绝第二帧。\n\n这就完成了算法的原理性设计。实施过程涉及为每个测试用例中给定的特定参数执行这些步骤。", "answer": "```python\nimport numpy as np\nfrom scipy.ndimage import gaussian_filter\nfrom scipy.stats import t\n\ndef solve():\n    \"\"\"\n    Main function to run the speckle independence test for all cases.\n    \"\"\"\n    \n    test_cases = [\n        # (image_size, p, rho, sigma, alpha, seed, include_stripe)\n        (64, 32, 0.0, 3, 0.05, 123, False),\n        (64, 32, 0.9, 3, 0.05, 123, False),\n        (64, 16, 0.0, 2, 0.05, 456, True),\n        (64, 32, 0.5, 3, 0.01, 789, False),\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        img_size, p, rho, sigma, alpha, seed, include_stripe = case\n        \n        # Set the random seed for reproducibility\n        np.random.seed(seed)\n        \n        # 1. Generate deterministic reflectivity phantom S(x,y)\n        coords = np.arange(img_size)\n        xx, yy = np.meshgrid(coords, coords)\n        \n        # Background gradient\n        S = 1.0 + 0.5 * (xx / img_size)\n        \n        # Gaussian-shaped inclusion\n        center_x, center_y = img_size / 2, img_size / 2\n        gauss_std = 8.0\n        inclusion_amplitude = 1.5\n        gaussian_inclusion = inclusion_amplitude * np.exp(\n            -((xx - center_x)**2 + (yy - center_y)**2) / (2 * gauss_std**2)\n        )\n        S += gaussian_inclusion\n        \n        # Optional sinusoidal stripe\n        if include_stripe:\n            stripe_period = 16.0\n            stripe_amplitude = 0.2\n            S += stripe_amplitude * np.sin(2 * np.pi * xx / stripe_period)\n\n        # Ensure S is strictly positive (already guaranteed by construction)\n\n        # 2. Simulate two speckle amplitude fields N1(x,y) and N2(x,y)\n        X1 = np.random.randn(img_size, img_size)\n        Y1 = np.random.randn(img_size, img_size)\n        X3 = np.random.randn(img_size, img_size)\n        Y3 = np.random.randn(img_size, img_size)\n        \n        X2 = rho * X1 + np.sqrt(1 - rho**2) * X3\n        Y2 = rho * Y1 + np.sqrt(1 - rho**2) * Y3\n        \n        N1 = np.sqrt(X1**2 + Y1**2)\n        N2 = np.sqrt(X2**2 + Y2**2)\n        \n        # 3. Form log-intensity images L_i(x,y)\n        I1 = S * N1\n        I2 = S * N2\n        \n        L1 = np.log(I1)\n        L2 = np.log(I2)\n        \n        # 4. Compute residuals R_i(x,y)\n        L1_smooth = gaussian_filter(L1, sigma=sigma, mode='reflect')\n        L2_smooth = gaussian_filter(L2, sigma=sigma, mode='reflect')\n        \n        R1 = L1 - L1_smooth\n        R2 = L2 - L2_smooth\n        \n        # 5. Extract central patch and compute Pearson correlation\n        patch_start = (img_size - p) // 2\n        patch_end = patch_start + p\n        \n        patch_R1 = R1[patch_start:patch_end, patch_start:patch_end]\n        patch_R2 = R2[patch_start:patch_end, patch_start:patch_end]\n        \n        vec_a = patch_R1.flatten()\n        vec_b = patch_R2.flatten()\n        \n        # Using the formula provided in the problem statement\n        mean_a = np.mean(vec_a)\n        mean_b = np.mean(vec_b)\n        \n        numerator = np.sum((vec_a - mean_a) * (vec_b - mean_b))\n        denominator = np.sqrt(np.sum((vec_a - mean_a)**2)) * np.sqrt(np.sum((vec_b - mean_b)**2))\n        \n        # Handle potential division by zero if a patch has zero variance\n        if denominator == 0:\n            r = 0.0\n        else:\n            r = numerator / denominator\n        \n        # 6. Set decision threshold from Student's t distribution\n        n = p**2\n        df = n - 2\n        \n        # ppf is the percent point function (inverse of cdf)\n        # For a two-sided test with significance alpha, we use 1 - alpha/2\n        t_crit = t.ppf(1 - alpha / 2, df)\n        \n        r_crit = t_crit / np.sqrt(t_crit**2 + df)\n        \n        # 7. Decide inclusion\n        include_in_compounding = np.abs(r) = r_crit\n        results.append(include_in_compounding)\n        \n    # Format and print the final output\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "4926687"}]}