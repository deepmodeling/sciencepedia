{"hands_on_practices": [{"introduction": "任何光学显微镜的性能都受到光衍射所施加的基本物理限制。理解分辨率的理论极限是设计任何有意义的成像实验的第一步。这项练习不仅探讨了基于瑞利判据的理论横向分辨率，还挑战您思考实际实验条件（例如折射率不匹配）如何导致光学像差，从而阻止我们达到这一理想性能 [@problem_id:4877601]。通过这个计算，您将把抽象的物理原理与具体的实验结果联系起来，学会批判性地审视理论值与实际的图像质量。", "problem": "一个组织学实验室正在使用点扫描共聚焦显微镜对早期胚胎样本中荧光标记的细胞膜进行成像，该显微镜配备了数值孔径（NA）的油浸物镜和一个光电探测器。荧光团的发射主波长中心位于 $ \\lambda = 520\\ \\mathrm{nm} $，物镜的指定数值孔径为 $ \\mathrm{NA} = 1.4 $。假设系统是理想、无像差、衍射受限的，并且荧光发射是非相干的。仅使用圆形光瞳衍射的第一性原理和数值孔径的定义，根据传统的针对两个点光源的 Rayleigh 分辨判据，确定样本平面上的理论横向分辨率。将最终数值以 $ \\mathrm{nm} $ 为单位表示，并四舍五入到 $ 3 $ 位有效数字。\n\n在同一次实验中，胚胎被封装在水性介质中，其折射率与浸油和盖玻片堆栈的折射率不匹配。使用基本的光学原理解释，为什么在最终的数字图像中，实验测得的点扩散函数（PSF）的半峰全宽（FWHM）可能会偏离您计算出的理论值。此解释不需要定量校正；仅提供定性论证。你的最终数值答案应该是按要求四舍五入的理论横向分辨率，单位为 $ \\mathrm{nm} $。", "solution": "题目提出了两个任务。第一个是基于基本原理计算共聚焦显微镜的理论横向分辨率。第二个是为特定条件下实验性能与此理论理想值的预期偏差提供定性解释。\n\n解答分两部分进行，依次处理每个任务。\n\n第一部分：理论横向分辨率的计算\n\n光学显微镜的理论横向分辨率由光的衍射决定。对于一个具有圆形孔径（物镜）的理想、无像差系统，一个点光源不会成像为一个点，而是形成一个称为艾里斑图样（Airy pattern）的衍射图样。该图样由一个明亮的中心亮斑，即艾里斑（Airy disk），以及周围一系列同心的明暗环组成。分辨率是衡量系统区分两个紧密间隔的点光源能力的指标。\n\n题目指定使用适用于荧光显微镜的非相干光源 Rayleigh 分辨判据。Rayleigh 判据指出，当一个光源的艾里斑中心与另一个光源的艾里斑图样的第一极小值（第一个暗环）重合时，两个点光源恰好可分辨。在此极限下，两个光源之间的间隔距离被定义为横向分辨率 $d$。\n\n为推导 $d$ 的表达式，我们从夫琅禾费衍射（Fraunhofer diffraction）的原理开始。物平面中艾里斑图样的强度分布是径向坐标 $\\rho$ 的函数，由下式给出\n$$\nI(\\rho) \\propto \\left[ \\frac{2 J_1(x)}{x} \\right]^2\n$$\n其中 $J_1$ 是一阶第一类贝塞尔函数。自变量 $x$ 由下式给出\n$$\nx = k \\rho \\sin(\\alpha_{\\text{max}})\n$$\n此处，$k$ 是光在物体所在介质中的波数，$\\rho$ 是物平面上图样中心的径向距离，而 $\\alpha_{\\text{max}}$ 是物镜收集的光锥的最大半角。\n\n波数 $k$ 与光的真空波长 $\\lambda$ 以及介质的折射率 $n$ 相关，关系式为 $k = \\frac{2\\pi n}{\\lambda}$。题目陈述提供了发射波长 $\\lambda = 520 \\text{ nm}$，这被解释为真空波长。物镜的数值孔径（NA）的定义为 $\\text{NA} = n \\sin(\\alpha_{\\text{max}})$。\n\n艾里斑图样的第一极小值出现在贝塞尔函数 $J_1(x)$ 的第一个零点处。这发生在自变量 $x \\approx 3.8317$ 时。根据 Rayleigh 判据，分辨率极限 $d$ 是到这个第一极小值的径向距离 $\\rho$。因此，我们设：\n$$\nk d \\sin(\\alpha_{\\text{max}}) = 3.8317\n$$\n代入 $k$ 和 NA 的表达式，我们得到：\n$$\n\\left(\\frac{2\\pi n}{\\lambda}\\right) d \\sin(\\alpha_{\\text{max}}) = 3.8317\n$$\n重排各项以组合 $n \\sin(\\alpha_{\\text{max}})$，得到：\n$$\n\\frac{2\\pi}{\\lambda} d \\left(n \\sin(\\alpha_{\\text{max}})\\right) = 3.8317\n$$\n$$\n\\frac{2\\pi}{\\lambda} d (\\text{NA}) = 3.8317\n$$\n解出分辨率极限 $d$：\n$$\nd = \\frac{3.8317}{2\\pi} \\frac{\\lambda}{\\text{NA}}\n$$\n计算常数项 $\\frac{3.8317}{2\\pi} \\approx 0.60984$。为方便实际应用，该值通常四舍五入为 $0.61$。因此，Rayleigh 分辨率极限由著名的公式给出：\n$$\nd = 0.61 \\frac{\\lambda}{\\text{NA}}\n$$\n给定值为 $\\lambda = 520 \\text{ nm}$ 和 $\\text{NA} = 1.4$。将这些值代入方程：\n$$\nd = 0.61 \\times \\frac{520 \\text{ nm}}{1.4}\n$$\n$$\nd = \\frac{317.2}{1.4} \\text{ nm} \\approx 226.5714 \\text{ nm}\n$$\n题目要求结果四舍五入到 $3$ 位有效数字。\n$$\nd \\approx 227 \\text{ nm}\n$$\n\n第二部分：理论值偏差的定性解释\n\n理论分辨率 $d \\approx 227 \\text{ nm}$ 是在理想、无像差系统的假设下计算的。题目的第二部分描述了一个更真实的实验场景，其中胚胎被封装在水性介质中。这在浸没介质（油，其 $n_{oil} \\approx 1.515$）和样本封装介质（水性，其 $n_{water} \\approx 1.33$）之间引入了折射率（$n$）不匹配。盖玻片通常具有与油相匹配的折射率（$n_{glass} \\approx 1.515$）。\n\n高数值孔径的油浸物镜经过精心设计，只有当从物镜前透镜到样本内焦点的光路是光学均匀时，才能实现无像差。这意味着物镜、浸油、盖玻片以及盖玻片正下方的介质都应具有相同的折射率。\n\n当盖玻片和水性封装介质之间的界面存在折射率不匹配时，光线会根据斯涅尔定律（Snell's Law）（$n_1 \\sin\\theta_1 = n_2 \\sin\\theta_2$）发生折射。这种折射违反了物镜的设计条件，从而导致光学像差。由这种平面界面折射率不匹配引入的主要像差是**球面像差** (spherical aberration)。\n\n球面像差导致通过物镜光瞳不同径向距离的光线聚焦在不同的轴向位置。边缘光线比近轴光线更靠近透镜聚焦。这种像差的后果是，来自点光源的光不再聚焦成一个清晰的、衍射受限的艾里斑。相反，焦点的能量被分散开，使得点扩散函数（PSF）变得模糊。这种模糊表现为 PSF 中心主峰的展宽，以及能量向其外环的转移。\n\n半峰全宽（FWHM）是 PSF 中心峰宽度的直接量度。由于球面像差会展宽这个峰，实验测得的 PSF 的 FWHM 将大于理论上的衍射受限值。PSF 的这种退化直接对应于有效横向和轴向分辨率的损失，以及图像对比度和信噪比的降低。这种像差的严重程度随着折射率不匹配的大小以及聚焦到样本中的深度的增加而增加。", "answer": "$$\n\\boxed{227}\n$$", "id": "4877601"}, {"introduction": "在了解了光学分辨率之后，下一个关键步骤是如何正确地将显微镜观察到的模拟光信号转换为数字图像，这对于三维成像尤为重要。此项练习将引导您应用数字信号处理的基石——奈奎斯特-香农采样定理，以确定沿轴向（$z$轴）采集图像时所需的最大步长 [@problem_id:4877567]。掌握这一概念对于避免数据失真（混叠效应）至关重要，并能确保您的三维数据集对于后续的定量分析和三维重建是有效和可靠的。", "problem": "一台点扫描共聚焦显微镜用于对经荧光核标记物染色的透明化胚胎组织进行成像。显微镜已校准，并通过对嵌入在与样本相同的透明化介质中的亚分辨率荧光微球进行成像，经验性地测量了轴向点扩展函数 (PSF)。测得的PSF的轴向半峰全宽 (FWHM) 为 $1.2\\ \\mu\\mathrm{m}$。您计划沿轴向 ($z$) 方向采集一个三维图像堆栈，并希望选择一个既能满足该光学系统所记录的轴向强度信息的Nyquist采样要求，又为最大的轴向步长。\n\n从Nyquist–Shannon采样定理以及PSF及其半峰全宽 (FWHM) 的定义出发，将记录图像中最小的有意义的轴向特征尺寸视为由测得的轴向PSF FWHM来表征。确定满足 $z$ 方向Nyquist采样的最大允许轴向步长 $\\Delta z$。\n\n以微米为单位表示您的最终答案，并四舍五入到三位有效数字。在最终的方框答案中不要包含单位。", "solution": "本题要求确定在使用共聚焦显微镜采集三维图像堆栈时，为满足Nyquist–Shannon采样定理所允许的最大轴向步长 $\\Delta z$。此分析的出发点是该定理本身及其在数字成像中的应用。\n\nNyquist–Shannon采样定理指出，要从一系列样本中无损地重建一个带限信号，采样频率必须至少是信号中存在的最高频率分量的两倍。这被称为奈奎斯特率。如果采样频率为 $f_s$，最大信号频率为 $f_{max}$，则条件为：\n$$f_s \\ge 2 f_{max}$$\n\n在一维轴向成像的背景下，信号是沿 $z$ 轴的强度分布 $I(z)$。这里的“频率”是空间频率 $k_z$，其单位是长度的倒数 (例如 $\\mu\\mathrm{m}^{-1}$)。采样频率 $f_{s,z}$ 是轴向步长 $\\Delta z$ 的倒数：\n$$f_{s,z} = \\frac{1}{\\Delta z}$$\n设显微镜传输的最大轴向空间频率为 $k_{z,max}$。因此，轴向采样的Nyquist准则为：\n$$\\frac{1}{\\Delta z} \\ge 2 k_{z,max}$$\n这意味着步长 $\\Delta z$ 必须是：\n$$\\Delta z \\le \\frac{1}{2 k_{z,max}}$$\n题目要求满足此条件的*最大*轴向步长，这对应于等式成立的情况：\n$$\\Delta z_{max} = \\frac{1}{2 k_{z,max}}$$\n\n下一步是确定给定光学系统的 $k_{z,max}$ 的值。显微镜传输的信息受衍射限制。点扩展函数 (PSF) 描述了一个无穷小点源的图像，其傅里叶变换，即光学传递函数 (OTF)，描述了显微镜如何传输不同的空间频率。OTF 作为一个低通滤波器，意味着它会通过某个截止频率以下的频率，并衰减或阻断更高的频率。这个截止频率就是 $k_{z,max}$。\n\n光学系统的空间分辨率与其空间频率截止之间存在基本关系。分辨率 $d_{res}$ 代表最小可分辨特征的尺寸，它与截止频率 $k_{max}$ 成反比。一个常用且有理论依据的近似是：\n$$k_{max} \\approx \\frac{1}{d_{res}}$$\n\n题目指示我们将“记录图像中最小的有意义的轴向特征尺寸视为由测得的轴向PSF FWHM来表征”。这意味着我们应该使用轴向PSF的半峰全宽 (FWHM) 作为我们轴向分辨率的度量，即 $d_{z,res}$。\n已知：\n$$\\text{FWHM}_{\\text{axial}} = 1.2\\ \\mu\\mathrm{m}$$\n因此，我们将轴向分辨率设为此值：\n$$d_{z,res} = \\text{FWHM}_{\\text{axial}} = 1.2\\ \\mu\\mathrm{m}$$\n利用这个值，我们可以估计图像中存在的最大轴向空间频率：\n$$k_{z,max} \\approx \\frac{1}{d_{z,res}} = \\frac{1}{\\text{FWHM}_{\\text{axial}}}$$\n\n现在，我们将 $k_{z,max}$ 的这个表达式代回到最大允许步长 $\\Delta z_{max}$ 的方程中：\n$$\\Delta z_{max} = \\frac{1}{2 k_{z,max}} = \\frac{1}{2 \\left( \\frac{1}{\\text{FWHM}_{\\text{axial}}} \\right)} = \\frac{\\text{FWHM}_{\\text{axial}}}{2}$$\n这个结果是数字显微镜学中一个众所周知的经验法则：为满足Nyquist准则，采样间隔应至多为最小可分辨特征尺寸的一半，而特征尺寸通常用PSF的FWHM来估计。\n\n使用给定的轴向FWHM数值：\n$$\\text{FWHM}_{\\text{axial}} = 1.2\\ \\mu\\mathrm{m}$$\n我们计算最大轴向步长：\n$$\\Delta z_{max} = \\frac{1.2\\ \\mu\\mathrm{m}}{2} = 0.6\\ \\mu\\mathrm{m}$$\n题目要求最终答案四舍五入到三位有效数字。要用三位有效数字表示 $0.6$，我们将其写为 $0.600$。\n\n因此，最大允许轴向步长为 $0.600\\ \\mu\\mathrm{m}$。", "answer": "$$\\boxed{0.600}$$", "id": "4877567"}, {"introduction": "在组织学和胚胎学研究中，我们常常需要同时对多个荧光标记的结构进行成像。然而，不同荧光染料的发射光谱可能会重叠，导致一种称为“光谱串扰”或“信号溢出”的伪影。这项实践将指导您完成一个计算校正流程，您将使用单标控制样本来建立光谱重叠的数学模型（一个串扰矩阵），然后通过求解线性方程组来从混合信号中“分离”出每个荧光分子的真实信号 [@problem_id:4877527]。这个练习让您亲身体验一种强大的图像分析技术，这对于在多色荧光成像中进行准确的共定位分析和定量测量至关重要。", "problem": "一个三通道激光共聚焦扫描显微镜 (CLSM) 系统采集来自三种荧光团的荧光信号。这些荧光团主要在三个探测器通道中的一个通道内发射，但会表现出向其他通道的光谱串扰（荧光泄露）。在组织切片中，假设探测器响应是线性的，并且来自不同荧光团的发射光子是线性叠加的。每个通道的探测器输出以任意单位 (a.u.) 计量。您必须使用每种荧光团的单标记对照样本来估计通道间的串扰系数，然后应用一个数值稳定的补偿程序来校正一个三色数据集。\n\n从探测器线性度和信号叠加原理出发，将测得的三通道观测值视为各荧光团贡献的线性组合。对于每种荧光团，使用其单标记对照测量值来估计其信号在每个通道中相对于其主导（主要）通道的比例。构建一个 $3 \\times 3$ 的串扰矩阵，其列对应于这些相对贡献。然后，对于混合（三色）数据集中的每个像素，通过以数值稳定的方式求解相应的线性系统来计算估计的荧光团贡献。如果系统是病态的，应使用基于分解的稳健方法，而不是直接求逆。通过将任何补偿后的负强度值设置为 $0$ a.u. 来强制实现非负性。最后，将所有补偿后的强度四舍五入到三位小数。\n\n您的程序必须实现上述逻辑，并根据提供的单标记对照测量值（感兴趣区域(ROI)内的平均值，单位为a.u.）和混合三色数据集（逐像素观测值，单位为a.u.）为以下测试套件生成结果。在每种情况下，假设荧光团 $1$ 的主要信号在通道 $1$ 中，荧光团 $2$ 在通道 $2$ 中，荧光团 $3$ 在通道 $3$ 中。\n\n测试用例 $1$ (正常情况，中等串扰):\n- 单标记对照（平均值，单位 a.u.）：\n  - 荧光团 $1$: $[1000, 120, 90]$\n  - 荧光团 $2$: $[80, 1100, 150]$\n  - 荧光团 $3$: $[60, 140, 900]$\n- 混合数据集像素（单位 a.u.）：\n  - $\\text{p}_1$: $[1400, 500, 300]$\n  - $\\text{p}_2$: $[250, 1200, 500]$\n  - $\\text{p}_3$: $[300, 400, 1300]$\n  - $\\text{p}_4$: $[600, 600, 600]$\n\n测试用例 $2$ (病态条件串扰，两种荧光团之间接近共线性):\n- 单标记对照（平均值，单位 a.u.）：\n  - 荧光团 $1$: $[1000, 800, 100]$\n  - 荧光团 $2$: $[950, 1000, 120]$\n  - 荧光团 $3$: $[100, 50, 900]$\n- 混合数据集像素（单位 a.u.）：\n  - $\\text{p}_1$: $[1800, 1600, 300]$\n  - $\\text{p}_2$: $[900, 850, 200]$\n  - $\\text{p}_3$: $[150, 120, 950]$\n\n测试用例 $3$ (边界条件，零观测值):\n- 单标记对照（使用与测试用例 $1$ 相同的数据）。\n- 混合数据集像素（单位 a.u.）：\n  - $\\text{p}_1$: $[0, 0, 0]$\n  - $\\text{p}_2$: $[0, 0, 0]$\n\n测试用例 $4$ (边缘情况，观测值位于对照列向量张成的正锥之外，补偿后需要进行非负性裁剪):\n- 单标记对照（使用与测试用例 $1$ 相同的数据）。\n- 混合数据集像素（单位 a.u.）：\n  - $\\text{p}_1$: $[50, 10, 200]$\n  - $\\text{p}_2$: $[20, 5, 80]$\n\n要求：\n- 通过将每个单标记对照向量按其主通道值进行归一化来估计串扰矩阵的列。\n- 使用数值稳定的方法（当存在不稳定性时，不依赖直接求逆）求解串扰矩阵所隐含的线性系统，从而对每个混合数据集像素进行补偿。\n- 将任何补偿后的负强度值裁剪为 $0$ a.u.。\n- 将所有补偿后的强度四舍五入到三位小数。\n- 所有输出均以任意单位 (a.u.) 表示，并四舍五入到三位小数。\n- 最终输出格式：您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果。每个测试用例的结果应是一个逐像素补偿强度的列表，其中每个像素是一个包含三个浮点数的列表。例如，一个有效的整体结构是 $[[[x_{11},x_{12},x_{13}],\\ldots],[[\\ldots]],[[\\ldots]],[[\\ldots]]]$，方括号前后无额外文本。", "solution": "该问题要求实现一种光谱解混算法，以校正三通道共聚焦显微图像中的串扰。该过程基于线性代数和数值分析的原理，并假设荧光信号符合线性叠加模型。\n\n**1. 光谱串扰的数学模型**\n\n基本假设是，在每个探测器通道中测得的信号是存在的各荧光团真实荧光强度的线性组合。对于一个三通道系统，这可以为每个像素表示为一个矩阵方程：\n\n$$\n\\mathbf{y} = M \\mathbf{x}\n$$\n\n其中：\n- $\\mathbf{y} = \\begin{pmatrix} y_1 \\\\ y_2 \\\\ y_3 \\end{pmatrix}$ 是三个探测器通道中测得的强度向量（混合信号）。\n- $\\mathbf{x} = \\begin{pmatrix} x_1 \\\\ x_2 \\\\ x_3 \\end{pmatrix}$ 是来自三种荧光团中每一种的真实、未知的荧光贡献向量（解混信号）。\n- $M$ 是 $3 \\times 3$ 串扰矩阵（或混合矩阵）。\n\n矩阵 $M$ 的元素 $M_{ij}$ 表示来自荧光团 $j$ 的信号在通道 $i$ 中被探测到的比例。我们的目标是在给定测量值 $\\mathbf{y}$ 和矩阵 $M$ 的情况下，确定 $\\mathbf{x}$。\n\n**2. 串扰矩阵 $M$ 的估计**\n\n串扰矩阵 $M$ 表征了荧光团的光谱特性和检测系统。它是通过使用单标记对照样本凭经验确定的，在这些样本中只存在一种荧光团。\n\n设 $\\mathbf{c}_j$ 为仅用荧光团 $j$ 标记的样本所测得的平均强度向量。\n$$\n\\mathbf{c}_1 = \\begin{pmatrix} c_{11} \\\\ c_{21} \\\\ c_{31} \\end{pmatrix}, \\quad\n\\mathbf{c}_2 = \\begin{pmatrix} c_{12} \\\\ c_{22} \\\\ c_{32} \\end{pmatrix}, \\quad\n\\mathbf{c}_3 = \\begin{pmatrix} c_{13} \\\\ c_{23} \\\\ c_{33} \\end{pmatrix}\n$$\n这里，$c_{ij}$ 是来自荧光团 $j$ 在通道 $i$ 中的信号。问题陈述中说明，荧光团 $j$ 的主要（最强）信号在通道 $j$ 中。因此，$c_{11}$、$c_{22}$ 和 $c_{33}$ 分别是荧光团 $1$、$2$ 和 $3$ 的主要通道信号。\n\n矩阵 $M$ 的列是每种荧光团归一化的光谱特征。$M$ 的第 $j$ 列（表示为 $\\mathbf{m}_j$）是对照向量 $\\mathbf{c}_j$ 除以其主通道值 $c_{jj}$ 进行归一化后的结果。这种归一化使得 $M$ 的对角元素等于 $1$。\n\n$$\n\\mathbf{m}_j = \\frac{\\mathbf{c}_j}{c_{jj}} = \\begin{pmatrix} c_{1j}/c_{jj} \\\\ c_{2j}/c_{jj} \\\\ \\vdots \\\\ c_{jj}/c_{jj} \\\\ \\vdots \\end{pmatrix}\n$$\n\n因此，完整的串扰矩阵构建如下：\n\n$$\nM = \\begin{pmatrix} |  |  | \\\\ \\mathbf{m}_1  \\mathbf{m}_2  \\mathbf{m}_3 \\\\ |  |  | \\end{pmatrix} = \\begin{pmatrix}\n\\frac{c_{11}}{c_{11}}  \\frac{c_{12}}{c_{22}}  \\frac{c_{13}}{c_{33}} \\\\\n\\frac{c_{21}}{c_{11}}  \\frac{c_{22}}{c_{22}}  \\frac{c_{23}}{c_{33}} \\\\\n\\frac{c_{31}}{c_{11}}  \\frac{c_{32}}{c_{22}}  \\frac{c_{33}}{c_{33}}\n\\end{pmatrix} = \\begin{pmatrix}\n1  \\frac{c_{12}}{c_{22}}  \\frac{c_{13}}{c_{33}} \\\\\n\\frac{c_{21}}{c_{11}}  1  \\frac{c_{23}}{c_{33}} \\\\\n\\frac{c_{31}}{c_{11}}  \\frac{c_{32}}{c_{22}}  1\n\\end{pmatrix}\n$$\n\n**3. 求解解混贡献 $\\mathbf{x}$**\n\n为了找到真实的荧光团贡献 $\\mathbf{x}$，我们必须求解线性系统 $\\mathbf{y} = M \\mathbf{x}$。形式上的解是 $\\mathbf{x} = M^{-1} \\mathbf{y}$。然而，直接计算逆矩阵 $M^{-1}$ 通常在数值上是不稳定的，特别是当 $M$ 是病态矩阵时。当两种或多种荧光团的光谱特征非常相似时（即 $M$ 的列向量几乎线性相关），就会出现病态矩阵，这使得系统对测量值 $\\mathbf{y}$ 中的微小噪声非常敏感。\n\n一种更稳健且数值稳定的方法是使用矩阵分解法来求解该系统，例如带主元选择的LU分解。标准的数值库提供了实现这些稳定算法的求解器。例如，`numpy.linalg.solve` 是一个合适的函数，它避免了显式求逆，并且对于大多数适定、非奇异的系统是稳健的。\n\n**4. 物理约束：非负性**\n\n解向量 $\\mathbf{x}$ 的元素代表荧光强度，这是一种不能为负的物理量。然而，由于测量噪声或线性模型中的轻微不准确性，求解 $\\mathbf{y} = M\\mathbf{x}$ 的数学解可能会产生小的负值。这些不符合物理实际的结果必须被修正。标准程序是通过将任何负值裁剪为零来强制执行非负性约束。\n\n如果 $\\mathbf{x}_{\\text{raw}} = \\begin{pmatrix} x_1 \\\\ x_2 \\\\ x_3 \\end{pmatrix}$ 是线性求解器得到的原始解，那么经过物理校正的补偿信号 $\\mathbf{x}_{\\text{comp}}$ 由下式给出：\n\n$$\n(\\mathbf{x}_{\\text{comp}})_i = \\max(0, (\\mathbf{x}_{\\text{raw}})_i) \\quad \\text{for } i=1, 2, 3\n$$\n\n**5. 算法实现摘要**\n\n应用于每个测试用例的完整算法如下：\n\n1.  **对于每个测试用例：**\n    a.  使用提供的单标记对照测量值 $(\\mathbf{c}_1, \\mathbf{c}_2, \\mathbf{c}_3)$，通过将每个对照向量按其主通道强度进行归一化，来构建 $3 \\times 3$ 串扰矩阵 $M$：$M = [\\mathbf{c}_1/c_{11}, \\mathbf{c}_2/c_{22}, \\mathbf{c}_3/c_{33}]$。\n    b.  **对于数据集中的每个混合信号像素向量 $\\mathbf{y}$：**\n        i.   使用数值稳定的线性求解器求解线性系统 $M\\mathbf{x} = \\mathbf{y}$ 以得到 $\\mathbf{x}$。\n        ii.  对解向量 $\\mathbf{x}$ 应用非负性约束，将任何负分量设置为 $0$。\n        iii. 将结果向量的每个分量四舍五入到三位小数。\n\n该程序为每个像素产生三种荧光团的估计真实强度，并校正了光谱串扰。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the spectral unmixing problem for all given test cases.\n    \"\"\"\n    test_cases = [\n        {\n            \"controls\": [\n                [1000, 120, 90],  # Fluorophore 1\n                [80, 1100, 150], # Fluorophore 2\n                [60, 140, 900],   # Fluorophore 3\n            ],\n            \"pixels\": [\n                [1400, 500, 300],\n                [250, 1200, 500],\n                [300, 400, 1300],\n                [600, 600, 600],\n            ],\n        },\n        {\n            \"controls\": [\n                [1000, 800, 100], # Fluorophore 1\n                [950, 1000, 120], # Fluorophore 2\n                [100, 50, 900],   # Fluorophore 3\n            ],\n            \"pixels\": [\n                [1800, 1600, 300],\n                [900, 850, 200],\n                [150, 120, 950],\n            ],\n        },\n        {\n            \"controls\": [\n                [1000, 120, 90],\n                [80, 1100, 150],\n                [60, 140, 900],\n            ],\n            \"pixels\": [\n                [0, 0, 0],\n                [0, 0, 0],\n            ],\n        },\n        {\n            \"controls\": [\n                [1000, 120, 90],\n                [80, 1100, 150],\n                [60, 140, 900],\n            ],\n            \"pixels\": [\n                [50, 10, 200],\n                [20, 5, 80],\n            ],\n        },\n    ]\n\n    all_results = []\n    for case in test_cases:\n        # Convert control data to numpy arrays\n        c1 = np.array(case[\"controls\"][0], dtype=float)\n        c2 = np.array(case[\"controls\"][1], dtype=float)\n        c3 = np.array(case[\"controls\"][2], dtype=float)\n\n        # Construct the cross-talk matrix M.\n        # Each column is the spectral signature of a fluorophore,\n        # normalized by its primary channel's intensity.\n        # Fluorophore j has its primary signal in channel j (index j-1).\n        m1 = c1 / c1[0]\n        m2 = c2 / c2[1]\n        m3 = c3 / c3[2]\n        \n        # Assemble columns into the matrix M.\n        # np.array([m1, m2, m3]) would create a matrix with signatures as rows.\n        # We need them as columns, so we transpose (.T).\n        M = np.array([m1, m2, m3]).T\n\n        case_results = []\n        for pixel_data in case[\"pixels\"]:\n            y = np.array(pixel_data, dtype=float)\n\n            # Solve the linear system Mx = y for the unmixed contributions x.\n            # np.linalg.solve uses a stable decomposition-based method.\n            try:\n                x_raw = np.linalg.solve(M, y)\n            except np.linalg.LinAlgError:\n                # Handle singular matrix case, though not expected with given data.\n                # A least-squares solution would be an alternative here.\n                x_raw = np.linalg.lstsq(M, y, rcond=None)[0]\n\n            # Enforce non-negativity constraint by clipping negative values to 0.\n            x_clipped = np.maximum(0, x_raw)\n\n            # Round the final compensated intensities to three decimal places.\n            x_final = np.round(x_clipped, 3)\n\n            case_results.append(x_final.tolist())\n        \n        all_results.append(case_results)\n    \n    # Format the output string to exactly match the required format,\n    # which is a standard list representation with no extra spaces.\n    # str(list) generates spaces, so we remove them.\n    final_output_string = str(all_results).replace(\" \", \"\")\n\n    print(final_output_string)\n\nsolve()\n```", "id": "4877527"}]}