{"hands_on_practices": [{"introduction": "在预防医学中，数据常常是集群的，例如诊所内的患者。本练习 [@problem_id:4502153] 将指导您在随机截距模型下推导诊所平均结局指标的方差。这个基础性的推导将帮助您理解组内相关系数 (Intraclass Correlation Coefficient, ICC) 如何量化集群效应的影响，以及为什么它是在设计和分析集群研究时的一个关键因素。", "problem": "一项多中心预防医学研究评估了一个在初级保健诊所中实施的新的高血压预防方案。设 $j$ 为诊所的索引（$j=1,\\dots,J$），$i$ 为诊所 $j$ 内患者的索引（$i=1,\\dots,n_j$）。在 6 个月时，每位患者的收缩压被记录为连续性结果 $y_{ij}$。假设数据可以由一个随机截距模型充分描述，\n$$\ny_{ij} = \\beta_{0} + u_{j} + \\varepsilon_{ij},\n$$\n其中 $u_{j}$ 是诊所水平的随机截距，$\\varepsilon_{ij}$ 是患者水平的误差。假设 $u_{j} \\sim \\mathcal{N}(0,\\sigma_{u}^{2})$，$\\varepsilon_{ij} \\sim \\mathcal{N}(0,\\sigma_{e}^{2})$，并且 $\\{u_{j}\\}$ 在诊所间是独立的，$\\{\\varepsilon_{ij}\\}$ 在患者间是独立的，且 $\\{u_{j}\\}$ 与 $\\{\\varepsilon_{ij}\\}$ 相互独立。设诊所均值为\n$$\n\\bar{y}_{j} = \\frac{1}{n_{j}} \\sum_{i=1}^{n_{j}} y_{ij}.\n$$\n仅使用独立性条件下期望和方差的核心性质以及组内相关系数（ICC）的定义，推导无条件方差 $\\operatorname{Var}(\\bar{y}_{j})$，并用总方差 $\\sigma_{t}^{2} = \\sigma_{u}^{2} + \\sigma_{e}^{2}$、定义为 $\\rho = \\frac{\\sigma_{u}^{2}}{\\sigma_{t}^{2}}$ 的组内相关系数（ICC）以及诊所内样本量 $n_{j}$ 来表示它。然后，对于一个 $n_{j} = 25$、总方差 $\\sigma_{t}^{2} = 144$ 且 ICC $\\rho = 0.12$ 的诊所，计算 $\\operatorname{Var}(\\bar{y}_{j})$ 的数值。将方差以 $\\mathrm{mmHg}^2$ 为单位表示，并将最终数值答案四舍五入到四位有效数字。", "solution": "对问题陈述进行验证。\n\n### 步骤 1：提取已知条件\n-   结果 $y_{ij}$（收缩压）的模型：$y_{ij} = \\beta_{0} + u_{j} + \\varepsilon_{ij}$\n-   诊所的索引：$j=1,\\dots,J$\n-   诊所 $j$ 内患者的索引：$i=1,\\dots,n_j$\n-   诊所水平的随机截距：$u_{j} \\sim \\mathcal{N}(0,\\sigma_{u}^{2})$\n-   患者水平的误差：$\\varepsilon_{ij} \\sim \\mathcal{N}(0,\\sigma_{e}^{2})$\n-   独立性假设：$\\{u_{j}\\}$ 在诊所间是独立的，$\\{\\varepsilon_{ij}\\}$ 在患者间是独立的，且 $\\{u_{j}\\}$ 与 $\\{\\varepsilon_{ij}\\}$ 相互独立。\n-   诊所均值的定义：$\\bar{y}_{j} = \\frac{1}{n_{j}} \\sum_{i=1}^{n_{j}} y_{ij}$\n-   总方差的定义：$\\sigma_{t}^{2} = \\sigma_{u}^{2} + \\sigma_{e}^{2}$\n-   组内相关系数（ICC）的定义：$\\rho = \\frac{\\sigma_{u}^{2}}{\\sigma_{t}^{2}}$\n-   用于计算的数值：$n_{j} = 25$, $\\sigma_{t}^{2} = 144$, $\\rho = 0.12$。\n-   任务：\n    1.  推导无条件方差 $\\operatorname{Var}(\\bar{y}_{j})$，并用 $\\sigma_{t}^{2}$、$\\rho$ 和 $n_{j}$ 表示。\n    2.  根据给定的参数计算 $\\operatorname{Var}(\\bar{y}_{j})$ 的数值，并四舍五入到四位有效数字。\n\n### 步骤 2：使用提取的已知条件进行验证\n该问题在科学和数学上是合理的。它描述了一个标准随机截距线性模型，这是多水平或分层建模的基石，在生物统计学和预防医学中广泛用于处理聚类数据结构（例如，诊所内的患者）。正态性和独立性的假设是这类模型的典型假设。总方差和组内相关系数（ICC）的定义是标准的。问题是适定的，提供了推导唯一解析表达式和计算特定数值所需的所有信息和定义。所提供的数值在收缩压的背景下是符合实际的。该问题客观、完整，没有矛盾或歧义。\n\n### 步骤 3：结论与行动\n问题有效。将提供完整解答。\n\n第一步是推导诊所均值方差 $\\operatorname{Var}(\\bar{y}_{j})$ 的解析表达式。诊所均值 $\\bar{y}_{j}$ 定义为：\n$$\n\\bar{y}_{j} = \\frac{1}{n_{j}} \\sum_{i=1}^{n_{j}} y_{ij}\n$$\n我们将模型方程 $y_{ij} = \\beta_{0} + u_{j} + \\varepsilon_{ij}$ 代入此定义：\n$$\n\\bar{y}_{j} = \\frac{1}{n_{j}} \\sum_{i=1}^{n_{j}} (\\beta_{0} + u_{j} + \\varepsilon_{ij})\n$$\n项 $\\beta_{0}$ 和 $u_{j}$ 相对于索引 $i$ 是常数。因此我们可以简化求和：\n$$\n\\bar{y}_{j} = \\frac{1}{n_{j}} \\left( \\sum_{i=1}^{n_{j}} \\beta_{0} + \\sum_{i=1}^{n_{j}} u_{j} + \\sum_{i=1}^{n_{j}} \\varepsilon_{ij} \\right) = \\frac{1}{n_{j}} \\left( n_{j}\\beta_{0} + n_{j}u_{j} + \\sum_{i=1}^{n_{j}} \\varepsilon_{ij} \\right)\n$$\n$$\n\\bar{y}_{j} = \\beta_{0} + u_{j} + \\frac{1}{n_{j}} \\sum_{i=1}^{n_{j}} \\varepsilon_{ij}\n$$\n我们将一个诊所内患者水平误差的均值表示为 $\\bar{\\varepsilon}_{j} = \\frac{1}{n_{j}} \\sum_{i=1}^{n_{j}} \\varepsilon_{ij}$。诊所均值的表达式变为：\n$$\n\\bar{y}_{j} = \\beta_{0} + u_{j} + \\bar{\\varepsilon}_{j}\n$$\n现在我们计算 $\\bar{y}_{j}$ 的方差。项 $\\beta_{0}$ 是一个固定参数，一个常数，因此它对总方差没有贡献。\n$$\n\\operatorname{Var}(\\bar{y}_{j}) = \\operatorname{Var}(\\beta_{0} + u_{j} + \\bar{\\varepsilon}_{j}) = \\operatorname{Var}(u_{j} + \\bar{\\varepsilon}_{j})\n$$\n问题陈述指出，随机截距 $\\{u_{j}\\}$ 与患者水平误差 $\\{\\varepsilon_{ij}\\}$ 相互独立。由此可知，$u_{j}$ 与 $\\bar{\\varepsilon}_{j}$（它是 $\\{\\varepsilon_{ij}\\}$ 的一个函数）相互独立。对于相互独立的随机变量，其和的方差等于方差的和：\n$$\n\\operatorname{Var}(\\bar{y}_{j}) = \\operatorname{Var}(u_{j}) + \\operatorname{Var}(\\bar{\\varepsilon}_{j})\n$$\n根据问题陈述，我们知道 $\\operatorname{Var}(u_{j}) = \\sigma_{u}^{2}$。现在我们需要求 $\\operatorname{Var}(\\bar{\\varepsilon}_{j})$：\n$$\n\\operatorname{Var}(\\bar{\\varepsilon}_{j}) = \\operatorname{Var}\\left(\\frac{1}{n_{j}} \\sum_{i=1}^{n_{j}} \\varepsilon_{ij}\\right)\n$$\n使用性质 $\\operatorname{Var}(aX) = a^2\\operatorname{Var}(X)$，其中 $a = 1/n_j$：\n$$\n\\operatorname{Var}(\\bar{\\varepsilon}_{j}) = \\frac{1}{n_{j}^2} \\operatorname{Var}\\left(\\sum_{i=1}^{n_{j}} \\varepsilon_{ij}\\right)\n$$\n问题陈述指出，误差 $\\{\\varepsilon_{ij}\\}$ 在患者间是独立的。因此，它们和的方差等于它们方差的和：\n$$\n\\operatorname{Var}\\left(\\sum_{i=1}^{n_{j}} \\varepsilon_{ij}\\right) = \\sum_{i=1}^{n_{j}} \\operatorname{Var}(\\varepsilon_{ij})\n$$\n已知对于所有的 $i$，都有 $\\operatorname{Var}(\\varepsilon_{ij}) = \\sigma_{e}^{2}$。因此：\n$$\n\\sum_{i=1}^{n_{j}} \\operatorname{Var}(\\varepsilon_{ij}) = \\sum_{i=1}^{n_{j}} \\sigma_{e}^{2} = n_{j}\\sigma_{e}^{2}\n$$\n将此代回，我们得到平均误差的方差：\n$$\n\\operatorname{Var}(\\bar{\\varepsilon}_{j}) = \\frac{1}{n_{j}^2} (n_{j}\\sigma_{e}^{2}) = \\frac{\\sigma_{e}^{2}}{n_j}\n$$\n组合这些部分，我们得到以方差分量表示的诊所均值的方差：\n$$\n\\operatorname{Var}(\\bar{y}_{j}) = \\sigma_{u}^{2} + \\frac{\\sigma_{e}^{2}}{n_j}\n$$\n下一步是用总方差 $\\sigma_{t}^{2}$、ICC $\\rho$ 和样本量 $n_j$ 来表示这个结果。给定的定义是 $\\sigma_{t}^{2} = \\sigma_{u}^{2} + \\sigma_{e}^{2}$ 和 $\\rho = \\frac{\\sigma_{u}^{2}}{\\sigma_{t}^{2}}$。\n根据这些定义，我们可以表示 $\\sigma_{u}^{2}$ 和 $\\sigma_{e}^{2}$：\n$$\n\\sigma_{u}^{2} = \\rho \\sigma_{t}^{2}\n$$\n$$\n\\sigma_{e}^{2} = \\sigma_{t}^{2} - \\sigma_{u}^{2} = \\sigma_{t}^{2} - \\rho \\sigma_{t}^{2} = \\sigma_{t}^{2}(1-\\rho)\n$$\n现在，将这些代入我们关于 $\\operatorname{Var}(\\bar{y}_{j})$ 的表达式中：\n$$\n\\operatorname{Var}(\\bar{y}_{j}) = (\\rho \\sigma_{t}^{2}) + \\frac{\\sigma_{t}^{2}(1-\\rho)}{n_j}\n$$\n提取公因式 $\\sigma_{t}^{2}$ 得到：\n$$\n\\operatorname{Var}(\\bar{y}_{j}) = \\sigma_{t}^{2} \\left( \\rho + \\frac{1-\\rho}{n_j} \\right)\n$$\n通过通分，这可以写成一个更标准的形式：\n$$\n\\operatorname{Var}(\\bar{y}_{j}) = \\sigma_{t}^{2} \\left( \\frac{n_j\\rho + 1 - \\rho}{n_j} \\right) = \\frac{\\sigma_{t}^{2}}{n_j} [1 + (n_j-1)\\rho]\n$$\n这就是所求的 $\\operatorname{Var}(\\bar{y}_{j})$ 的解析表达式。\n\n最后，我们使用所提供的数据计算数值：$n_{j} = 25$，$\\sigma_{t}^{2} = 144$，以及 $\\rho = 0.12$。\n$$\n\\operatorname{Var}(\\bar{y}_{j}) = \\frac{144}{25} [1 + (25-1)(0.12)]\n$$\n$$\n\\operatorname{Var}(\\bar{y}_{j}) = 5.76 [1 + (24)(0.12)]\n$$\n$$\n\\operatorname{Var}(\\bar{y}_{j}) = 5.76 [1 + 2.88]\n$$\n$$\n\\operatorname{Var}(\\bar{y}_{j}) = 5.76 [3.88]\n$$\n$$\n\\operatorname{Var}(\\bar{y}_{j}) = 22.3488\n$$\n问题指定方差的单位为 $\\mathrm{mmHg}^2$，并要求将最终数值答案四舍五入到四位有效数字。\n$$\n\\operatorname{Var}(\\bar{y}_{j}) \\approx 22.35 \\ \\mathrm{mmHg}^2\n$$", "answer": "$$\n\\boxed{22.35}\n$$", "id": "4502153"}, {"introduction": "拟合多水平模型后，我们常常希望估计单个集群的效应，例如某个特定诊所的表现。本练习 [@problem_id:4502179] 引入了“收缩估计” (shrinkage estimation) 的概念，其中集群的估计效应是其自身数据和总体均值的加权平均。通过亲手实现这一计算，您将直观地理解多水平模型如何通过在集群间“借力” (borrowing strength) 来产生更稳定、更可靠的估计值。", "problem": "考虑一个适用于在诊所内测量的预防医学结果的分层随机截距模型。设 $j$ 为诊所的索引，$i$ 为诊所 $j$ 内个体的索引。诊所 $j$ 中个体 $i$ 的结果建模为 $Y_{ij} = \\beta_0 + u_j + \\epsilon_{ij}$，其中 $u_j$ 是诊所特定的随机截距，$\\epsilon_{ij}$ 是个体水平的误差项。假设 $u_j \\sim \\mathcal{N}(0,\\sigma_u^2)$ 和 $\\epsilon_{ij} \\sim \\mathcal{N}(0,\\sigma_\\epsilon^2)$，并且所有随机变量在诊所和个体之间相互独立。给定 $Y_{ij}$ 的实现值以及已知的方差分量 $\\sigma_u^2$ 和 $\\sigma_\\epsilon^2$。\n\n仅从高斯分层模型的定义和联合高斯随机变量的条件期望规则出发，推导如何将估计的诊所随机截距计算为给定观测数据和方差分量的条件期望。然后，在一个程序中实现此计算，对于下述每个测试用例，该程序使用所有个体的总平均值来估计固定截距 $\\beta_0$，并生成估计的诊所随机截距。对于每个测试用例，您的程序必须输出一个浮点数列表，表示按所列顺序排列的所有诊所的估计随机截距。每个浮点数必须四舍五入到 $6$ 位小数。最终的程序输出必须是单行，包含一个列表的列表，与测试用例的呈现顺序相同，并用方括号括起来。例如，形式为 $[[a_1,a_2],[b_1,b_2,b_3]]$ 的输出，其中每个 $a_k$ 和 $b_\\ell$ 都是四舍五入到 $6$ 位小数的浮点数。\n\n测试套件：\n- 测试用例 1（小样本量，中等方差）：诊所结果\n  - 诊所 1：$[0.9,1.2,1.0]$\n  - 诊所 2：$[1.5,1.3]$\n  - 诊所 3：$[0.7]$\n  - 诊所 4：$[1.1,1.2,0.9,1.0]$\n  其中 $\\sigma_u^2 = 0.05$ 且 $\\sigma_\\epsilon^2 = 0.20$。\n- 测试用例 2（由于个体水平方差高而导致强收缩）：诊所结果\n  - 诊所 1：$[1.0,1.4]$\n  - 诊所 2：$[0.5]$\n  - 诊所 3：$[2.0,1.8,2.2]$\n  其中 $\\sigma_u^2 = 0.05$ 且 $\\sigma_\\epsilon^2 = 2.00$。\n- 测试用例 3（一个诊所样本量大，个体水平方差较小）：诊所结果\n  - 诊所 1：$[1.02,0.98,1.01,0.99,1.00,1.03,0.97,1.05,0.95,1.04,1.02,0.96,1.00,1.01,0.99,1.00,1.03,0.97,1.02,0.98]$\n  - 诊所 2：$[0.9,1.1]$\n  - 诊所 3：$[1.3]$\n  其中 $\\sigma_u^2 = 0.10$ 且 $\\sigma_\\epsilon^2 = 0.05$。\n- 测试用例 4（由于诊所水平方差大而导致弱收缩）：诊所结果\n  - 诊所 1：$[1.8,2.0,1.9]$\n  - 诊所 2：$[0.5,0.6]$\n  - 诊所 3：$[1.2,1.1,1.3,1.4]$\n  其中 $\\sigma_u^2 = 1.00$ 且 $\\sigma_\\epsilon^2 = 0.05$。\n\n您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果，每个元素对应一个测试用例，并且其本身是该案例的估计诊所随机截距列表，每个值都四舍五入到 $6$ 位小数。不涉及物理单位或角度；按规定报告纯数字。总的推理必须阐明向总平均值的收缩如何依赖于 $\\sigma_u^2$、$\\sigma_\\epsilon^2$ 和诊所样本量，但程序的输出必须仅为指定的数值列表。", "solution": "用户想要解决以下问题：\n- **任务**：用户希望在一个分层随机截距模型中，推导并实现对估计的诊所随机截距的计算。模型指定为 $Y_{ij} = \\beta_0 + u_j + \\epsilon_{ij}$，其中 $j$ 是诊所的索引，$i$ 是个体的索引。诊所 $j$ 的随机截距是 $u_j \\sim \\mathcal{N}(0,\\sigma_u^2)$，个体水平的误差是 $\\epsilon_{ij} \\sim \\mathcal{N}(0,\\sigma_\\epsilon^2)$。所有随机变量相互独立。问题要求从第一性原理出发，推导随机截距的条件期望 $E[u_j | \\{Y_{ij}\\}, \\sigma_u^2, \\sigma_\\epsilon^2]$，并将固定截距 $\\beta_0$ 视为通过数据的总平均值来估计。此推导应被实现以解决四个特定的测试用例。\n\n### 第 1 步：提取已知条件\n- **模型**：$Y_{ij} = \\beta_0 + u_j + \\epsilon_{ij}$\n- **索引**：$j$ 用于诊所，$i$ 用于诊所 $j$ 内的个体。\n- **固定效应**：$\\beta_0$ 是固定截距。\n- **随机效应**：\n    - $u_j$：诊所特定的随机截距。\n    - $\\epsilon_{ij}$：个体水平的误差项。\n- **分布假设**：\n    - $u_j \\sim \\mathcal{N}(0,\\sigma_u^2)$\n    - $\\epsilon_{ij} \\sim \\mathcal{N}(0,\\sigma_\\epsilon^2)$\n    - 所有 $u_j$ 和 $\\epsilon_{ij}$ 相互独立。\n- **已知量**：对于每个测试用例，都给定了 $Y_{ij}$ 的实现值和方差分量 $\\sigma_u^2$ 和 $\\sigma_\\epsilon^2$。\n- **任务要求**：\n    1.  推导估计的诊所随机截距的公式，指定为条件期望 $E[u_j | \\{Y_{ij}\\}, \\sigma_u^2, \\sigma_\\epsilon^2]$。\n    2.  使用所有诊所中所有个体的总平均值来估计 $\\beta_0$。\n    3.  实现一个程序，为四个提供的测试用例计算这些估计的随机截距。\n- **测试用例**：\n    - **用例 1**：诊所数据：C1: $[0.9,1.2,1.0]$, C2: $[1.5,1.3]$, C3: $[0.7]$, C4: $[1.1,1.2,0.9,1.0]$；方差：$\\sigma_u^2 = 0.05, \\sigma_\\epsilon^2 = 0.20$。\n    - **用例 2**：诊所数据：C1: $[1.0,1.4]$, C2: $[0.5]$, C3: $[2.0,1.8,2.2]$；方差：$\\sigma_u^2 = 0.05, \\sigma_\\epsilon^2 = 2.00$。\n    - **用例 3**：诊所数据：C1: $[1.02,...,0.98]$ (20 个值), C2: $[0.9,1.1]$, C3: $[1.3]$；方差：$\\sigma_u^2 = 0.10, \\sigma_\\epsilon^2 = 0.05$。\n    - **用例 4**：诊所数据：C1: $[1.8,2.0,1.9]$, C2: $[0.5,0.6]$, C3: $[1.2,1.1,1.3,1.4]$；方差：$\\sigma_u^2 = 1.00, \\sigma_\\epsilon^2 = 0.05$。\n- **输出格式**：单行，包含一个列表的列表，每个内部列表包含一个测试用例的估计随机截距，四舍五入到 $6$ 位小数。\n\n### 第 2 步：使用提取的已知条件进行验证\n1.  **科学依据**：该问题描述了一个标准随机截距模型，这是多层次统计建模中的一个基本工具，广泛应用于流行病学、生物统计学和预防医学等领域。该模型及其分析原则在统计理论中已经很成熟。该问题在科学上是合理的。\n2.  **问题明确**：该问题是明确的。它要求推导和计算随机效应的最佳线性无偏预测（BLUP），在已知方差和固定效应有扩散先验的贝叶斯背景下，这等同于它们的后验均值。所有必要的数据、模型参数（$\\sigma_u^2, \\sigma_\\epsilon^2$）以及如何估计固定效应（$\\beta_0$）的明确指令都已提供。这保证了一个唯一、稳定且有意义的解。\n3.  **客观性**：问题以精确、客观的数学语言陈述。没有主观或基于意见的陈述。\n4.  **未检测到其他缺陷**：问题是自洽的、无矛盾的，并且其要求是可行的。这是一个应用统计学中标准的、非平凡的问题。\n\n### 第 3 步：结论与行动\n该问题是**有效的**。我将继续推导解决方案并实现所需的程序。\n\n### 推导与求解\n目标是计算估计的诊所随机截距，其定义为给定观测数据下 $u_j$ 的条件期望。这个量，记作 $\\hat{u}_j$，是随机效应 $u_j$ 的最佳线性无偏预测（BLUP）。\n模型由 $Y_{ij} = \\beta_0 + u_j + \\epsilon_{ij}$ 给出，其中 $u_j \\sim \\mathcal{N}(0, \\sigma_u^2)$ 且 $\\epsilon_{ij} \\sim \\mathcal{N}(0, \\sigma_\\epsilon^2)$。所有随机变量相互独立。\n\n问题指出，我们应该使用所有观测值的总平均值来估计固定截距 $\\beta_0$。设 $n_j$ 是诊所 $j$ 中的个体数量，$N = \\sum_j n_j$ 是个体总数。$\\beta_0$ 的估计值为：\n$$ \\hat{\\beta}_0 = \\bar{Y}_{..} = \\frac{1}{N} \\sum_{j} \\sum_{i=1}^{n_j} Y_{ij} $$\n我们被要求找到 $\\hat{u}_j = E[u_j | \\{Y_{ik}\\}_{i,k}, \\sigma_u^2, \\sigma_\\epsilon^2]$。由于 $u_j$ 与任何其他诊所 $k \\neq j$ 的数据是独立的，这个期望等价于仅以诊所 $j$ 的数据为条件：\n$$ \\hat{u}_j = E[u_j | \\{Y_{ij}\\}_{i=1}^{n_j}, \\sigma_u^2, \\sigma_\\epsilon^2] $$\n对于此推导，我们将 $\\beta_0$ 视为已知（使用其估计值 $\\hat{\\beta}_0$）。推导过程是通过找到我们想要预测的随机变量 $u_j$ 与来自数据的充分统计量——诊所平均值 $\\bar{Y}_j = \\frac{1}{n_j}\\sum_{i=1}^{n_j} Y_{ij}$ 的联合分布来进行的。\n\n该模型意味着 $u_j$ 和 $\\bar{Y}_j$ 都服从正态分布。\n1.  $u_j$ 的边际分布已知为 $u_j \\sim \\mathcal{N}(0, \\sigma_u^2)$。因此，$E[u_j] = 0$ 且 $\\text{Var}(u_j) = \\sigma_u^2$。\n\n2.  诊所平均值 $\\bar{Y}_j$ 可以表示为：\n    $$ \\bar{Y}_j = \\frac{1}{n_j} \\sum_{i=1}^{n_j} (\\beta_0 + u_j + \\epsilon_{ij}) = \\beta_0 + u_j + \\frac{1}{n_j} \\sum_{i=1}^{n_j} \\epsilon_{ij} = \\beta_0 + u_j + \\bar{\\epsilon}_j $$\n    其中 $\\bar{\\epsilon}_j = \\frac{1}{n_j}\\sum_{i=1}^{n_j} \\epsilon_{ij}$。\n    $\\bar{Y}_j$ 的期望是 $E[\\bar{Y}_j] = E[\\beta_0 + u_j + \\bar{\\epsilon}_j] = \\beta_0 + E[u_j] + E[\\bar{\\epsilon}_j] = \\beta_0 + 0 + 0 = \\beta_0$。\n    $\\bar{Y}_j$ 的方差是：\n    $$ \\text{Var}(\\bar{Y}_j) = \\text{Var}(\\beta_0 + u_j + \\bar{\\epsilon}_j) = \\text{Var}(u_j + \\bar{\\epsilon}_j) $$\n    由于 $u_j$ 和所有 $\\epsilon_{ij}$ 都是独立的，$\\text{Var}(u_j + \\bar{\\epsilon}_j) = \\text{Var}(u_j) + \\text{Var}(\\bar{\\epsilon}_j)$。\n    我们有 $\\text{Var}(u_j) = \\sigma_u^2$ 和 $\\text{Var}(\\bar{\\epsilon}_j) = \\text{Var}(\\frac{1}{n_j}\\sum_i \\epsilon_{ij}) = \\frac{1}{n_j^2}}\\sum_i \\text{Var}(\\epsilon_{ij}) = \\frac{n_j \\sigma_\\epsilon^2}{n_j^2} = \\frac{\\sigma_\\epsilon^2}{n_j}$。\n    因此，$\\text{Var}(\\bar{Y}_j) = \\sigma_u^2 + \\frac{\\sigma_\\epsilon^2}{n_j}$。\n\n3.  $u_j$ 和 $\\bar{Y}_j$ 之间的协方差是：\n    $$ \\text{Cov}(u_j, \\bar{Y}_j) = \\text{Cov}(u_j, \\beta_0 + u_j + \\bar{\\epsilon}_j) = \\text{Cov}(u_j, u_j) + \\text{Cov}(u_j, \\bar{\\epsilon}_j) = \\text{Var}(u_j) + 0 = \\sigma_u^2 $$\n    协方差为零，因为 $u_j$ 与所有 $\\epsilon_{ik}$ 独立。\n\n由于 $u_j$ 和 $\\bar{Y}_j$ 是高斯随机变量的线性组合，它们是联合高斯分布的。对于两个联合高斯随机变量 $X_1$ 和 $X_2$，给定 $X_2=x_2$ 时 $X_1$ 的条件期望是：\n$$ E[X_1 | X_2=x_2] = E[X_1] + \\frac{\\text{Cov}(X_1, X_2)}{\\text{Var}(X_2)} (x_2 - E[X_2]) $$\n令 $X_1 = u_j$ 和 $X_2 = \\bar{Y}_j$，我们代入推导出的矩：\n$$ E[u_j | \\bar{Y}_j=\\bar{y}_j] = E[u_j] + \\frac{\\text{Cov}(u_j, \\bar{Y}_j)}{\\text{Var}(\\bar{Y}_j)} (\\bar{y}_j - E[\\bar{Y}_j]) $$\n$$ E[u_j | \\bar{Y}_j=\\bar{y}_j] = 0 + \\frac{\\sigma_u^2}{\\sigma_u^2 + \\sigma_\\epsilon^2/n_j} (\\bar{y}_j - \\beta_0) $$\n这就是所需的公式。通过代入观测到的诊所平均值 $\\bar{Y}_j$ 和估计的总平均值 $\\hat{\\beta}_0$，可以获得估计的随机截距 $\\hat{u}_j$：\n$$ \\hat{u}_j = \\left( \\frac{\\sigma_u^2}{\\sigma_u^2 + \\sigma_\\epsilon^2/n_j} \\right) (\\bar{Y}_j - \\hat{\\beta}_0) $$\n该公式表明，估计的随机截距是诊所平均值与总平均值原始偏差 $(\\bar{Y}_j - \\hat{\\beta}_0)$ 的“收缩”版本。收缩因子 $S_j = \\frac{\\sigma_u^2}{\\sigma_u^2 + \\sigma_\\epsilon^2/n_j}$ 决定了这种收缩的程度。\n\n- **$n_j$（诊所样本量）的影响**：当 $n_j \\to \\infty$ 时，项 $\\sigma_\\epsilon^2/n_j \\to 0$，所以收缩因子 $S_j \\to 1$。我们更相信诊所的数据，并且 $\\hat{u}_j \\approx \\bar{Y}_j - \\hat{\\beta}_0$。对于小的 $n_j$，项 $\\sigma_\\epsilon^2/n_j$ 很大，$S_j$ 很小，$\\hat{u}_j$ 被收缩到 $0$。\n- **$\\sigma_u^2$（诊所间方差）的影响**：如果 $\\sigma_u^2$ 相对于 $\\sigma_\\epsilon^2/n_j$ 较大，这表明诊所之间确实存在差异。收缩因子 $S_j$ 接近 $1$，导致收缩较少。\n- **$\\sigma_\\epsilon^2$（诊所内方差）的影响**：如果 $\\sigma_\\epsilon^2$ 很大，表示个体测量值噪声较大。这使得诊所平均值 $\\bar{Y}_j$ 成为诊所真实均值（$\\beta_0 + u_j$）的一个不太可靠的估计。因此，收缩因子 $S_j$ 较小，导致向总平均值的收缩更多。\n\n计算步骤如下：\n1. 对于每个测试用例，收集所有诊所的所有结果值 $Y_{ij}$。\n2. 计算总平均值 $\\hat{\\beta}_0 = \\bar{Y}_{..}$。\n3. 对于每个诊所 $j$，计算其样本量 $n_j$ 和其局部平均值 $\\bar{Y}_j$。\n4. 使用给定的 $\\sigma_u^2$ 和 $\\sigma_\\epsilon^2$，利用推导出的公式计算估计的随机截距 $\\hat{u}_j$。\n5. 按指定顺序收集所有诊所计算出的 $\\hat{u}_j$ 值。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for the estimated random intercepts in a hierarchical model for multiple test cases.\n    \"\"\"\n    \n    test_cases = [\n        {\n            \"clinics\": {\n                1: [0.9, 1.2, 1.0],\n                2: [1.5, 1.3],\n                3: [0.7],\n                4: [1.1, 1.2, 0.9, 1.0]\n            },\n            \"sigma_u_sq\": 0.05,\n            \"sigma_eps_sq\": 0.20\n        },\n        {\n            \"clinics\": {\n                1: [1.0, 1.4],\n                2: [0.5],\n                3: [2.0, 1.8, 2.2]\n            },\n            \"sigma_u_sq\": 0.05,\n            \"sigma_eps_sq\": 2.00\n        },\n        {\n            \"clinics\": {\n                1: [1.02, 0.98, 1.01, 0.99, 1.00, 1.03, 0.97, 1.05, 0.95, 1.04, 1.02, 0.96, 1.00, 1.01, 0.99, 1.00, 1.03, 0.97, 1.02, 0.98],\n                2: [0.9, 1.1],\n                3: [1.3]\n            },\n            \"sigma_u_sq\": 0.10,\n            \"sigma_eps_sq\": 0.05\n        },\n        {\n            \"clinics\": {\n                1: [1.8, 2.0, 1.9],\n                2: [0.5, 0.6],\n                3: [1.2, 1.1, 1.3, 1.4]\n            },\n            \"sigma_u_sq\": 1.00,\n            \"sigma_eps_sq\": 0.05\n        }\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        clinic_data = case[\"clinics\"]\n        sigma_u_sq = case[\"sigma_u_sq\"]\n        sigma_eps_sq = case[\"sigma_eps_sq\"]\n        \n        # Step 1: Collect all data points to calculate the grand mean\n        all_outcomes = [outcome for outcomes_list in clinic_data.values() for outcome in outcomes_list]\n        \n        # Step 2: Calculate the grand mean (estimate for beta_0)\n        beta_0_hat = np.mean(all_outcomes)\n        \n        case_results = []\n        \n        # Iterate through clinics in their specified order (keys 1, 2, 3...)\n        for clinic_id in sorted(clinic_data.keys()):\n            outcomes = clinic_data[clinic_id]\n            \n            # Step 3a: Get clinic sample size n_j\n            n_j = len(outcomes)\n            \n            # Step 3b: Calculate clinic mean Y_bar_j\n            y_bar_j = np.mean(outcomes)\n            \n            # Step 4: Calculate the shrinkage factor and the estimated random intercept\n            shrinkage_factor = sigma_u_sq / (sigma_u_sq + sigma_eps_sq / n_j)\n            u_j_hat = shrinkage_factor * (y_bar_j - beta_0_hat)\n            \n            # Round to 6 decimals as required\n            rounded_u_j_hat = round(u_j_hat, 6)\n            \n            case_results.append(rounded_u_j_hat)\n            \n        all_results.append(case_results)\n\n    # Format the final output string as specified\n    # Example: [[a,b],[c,d,e]] becomes \"[[a, b], [c, d, e]]\" by default.\n    # The requirement is a comma-separated list of values without spaces.\n    # So we format it manually.\n    outer_list_str = []\n    for inner_list in all_results:\n        inner_list_str = f\"[{','.join(f'{x:.6f}' for x in inner_list)}]\"\n        outer_list_str.append(inner_list_str)\n    \n    final_output_str = f\"[{','.join(outer_list_str)}]\"\n    \n    # Correction to match the requested output format which uses Python's default list-to-string conversion\n    # [[-0.02, 0.106667, -0.076, -0.015], ...]\n    final_output_str_repr = repr(all_results).replace(\" \", \"\")\n\n    print(final_output_str_repr)\n\nsolve()\n```", "id": "4502179"}, {"introduction": "在对疾病状态等二元结局进行建模时，广义线性混合模型 (Generalized Linear Mixed Models, GLMM) 和广义估计方程 (Generalized Estimating Equations, GEE) 是两种常用的方法。本练习 [@problem_id:4502181] 探讨了它们在解释上的关键区别：GLMM 估计的是特定于个体的 (subject-specific) 效应，而 GEE 估计的是群体平均 (population-averaged) 效应。通过推导两者系数之间的近似数学关系，您将理解为什么它们的估计值不能直接比较，以及如何为您的研究问题选择合适的模型。", "problem": "一项预防医学队列研究在 $T$ 次重复访视中（$t=1,\\dots,T$）跟踪了 $n$ 名患者（$i=1,\\dots,n$），以评估一个基于诊所的生活方式咨询项目在减少每日含糖饮料摄入量方面的效果。令 $Y_{it} \\in \\{0,1\\}$ 表示患者 $i$ 在第 $t$ 天报告摄入 $0$ 份（$Y_{it}=1$）还是至少 $1$ 份（$Y_{it}=0$）。令 $X_{it} \\in \\{0,1\\}$ 表示在第 $t$ 天是否接受了咨询项目。考虑两种建模框架：\n\n1. 一个带随机截距的广义线性混合模型 (GLMM)，其中给定受试者特异性随机效应 $b_i$ 的条件均值为\n$$\n\\Pr(Y_{it}=1 \\mid X_{it}, b_i) = \\frac{1}{1 + \\exp\\!\\big(-(\\alpha + \\beta_{\\text{cond}} X_{it} + b_i)\\big)}, \\quad b_i \\sim \\mathcal{N}(0,\\sigma^{2}).\n$$\n\n2. 一个以群体平均均值 $\\Pr(Y_{it}=1 \\mid X_{it})$ 为目标并使用 logit 链接函数的广义估计方程 (GEE) 模型。\n\n从 logit 链接函数的潜变量解释以及标准逻辑斯谛分布的方差为 $\\pi^{2}/3$ 这一众所周知的事实出发，利用独立分量的基本方差可加性，推导当 $\\sigma^{2} > 0$ 时，群体平均对数优势比系数 $\\beta_{\\text{marg}}$（由 GEE 得到）与受试者特异性条件对数优势比系数 $\\beta_{\\text{cond}}$（由 GLMM 得到）之间的近似关系。然后，对于一个研究，其中 $\\beta_{\\text{cond}} = 1.2$ 且 $\\sigma^{2} = 0.5$，计算 $\\beta_{\\text{marg}}$ 的近似值。将最终数值答案四舍五入至四位有效数字。最终答案不需要单位。", "solution": "问题要求我们推导广义线性混合模型 (GLMM) 中的受试者特异性（条件）对数优势比系数与广义估计方程 (GEE) 模型中的群体平均（边际）对数优势比系数之间的近似关系。然后，我们将使用此关系计算一个数值。\n\n该推导基于逻辑斯谛回归模型的潜变量解释。对于给定的 GLMM，我们可以假设一个连续潜变量 $Y_{it}^*$，使得观测到的二元结果 $Y_{it}$ 由 $Y_{it}^*$ 的符号决定：\n$$\nY_{it} = \\begin{cases} 1  \\text{if } Y_{it}^* > 0 \\\\ 0  \\text{if } Y_{it}^* \\le 0 \\end{cases}\n$$\n潜变量 $Y_{it}^*$ 被建模为预测变量、随机效应和误差项的线性函数：\n$$\nY_{it}^* = \\alpha + \\beta_{\\text{cond}} X_{it} + b_i + \\epsilon_{it}\n$$\n为了使该模型成为逻辑斯谛回归，误差项 $\\epsilon_{it}$ 必须服从标准逻辑斯谛分布。标准逻辑斯谛分布的均值为 $0$，其累积分布函数 (CDF) 为 $F(z) = (1 + \\exp(-z))^{-1}$。问题正确地指出，该分布的方差为 $\\text{Var}(\\epsilon_{it}) = \\frac{\\pi^2}{3}$。\n\n给定随机效应 $b_i$ 的成功概率为：\n$$\n\\Pr(Y_{it}=1 \\mid X_{it}, b_i) = \\Pr(Y_{it}^* > 0 \\mid X_{it}, b_i) = \\Pr(\\alpha + \\beta_{\\text{cond}} X_{it} + b_i + \\epsilon_{it} > 0)\n$$\n$$\n= \\Pr(\\epsilon_{it} > -(\\alpha + \\beta_{\\text{cond}} X_{it} + b_i))\n$$\n由于逻辑斯谛分布关于 $0$ 对称，所以 $\\Pr(\\epsilon_{it} > -z) = \\Pr(\\epsilon_{it}  z) = F(z)$。因此，\n$$\n\\Pr(Y_{it}=1 \\mid X_{it}, b_i) = F(\\alpha + \\beta_{\\text{cond}} X_{it} + b_i) = \\frac{1}{1 + \\exp(-(\\alpha + \\beta_{\\text{cond}} X_{it} + b_i))}\n$$\n这证实了我们的潜变量公式与问题中指定的 GLMM 相对应。\n\n边际模型考虑的是群体平均概率，这涉及到对随机效应 $b_i$ 的分布进行积分。在潜变量框架中，这等同于将随机效应 $b_i$ 视为误差项的一部分。该潜变量模型可以重写为：\n$$\nY_{it}^* = (\\alpha + \\beta_{\\text{cond}} X_{it}) + (b_i + \\epsilon_{it})\n$$\n这里，$(\\alpha + \\beta_{\\text{cond}} X_{it})$ 是线性预测器的固定部分，而 $(b_i + \\epsilon_{it})$ 是复合误差项。令这个复合误差为 $V_{it} = b_i + \\epsilon_{it}$。\n\n假设随机效应 $b_i$ 和误差项 $\\epsilon_{it}$ 是独立的。问题指定 $b_i \\sim \\mathcal{N}(0, \\sigma^2)$，所以 $\\text{Var}(b_i) = \\sigma^2$。利用独立分量的方差可加性原理，复合误差项的方差为：\n$$\n\\text{Var}(V_{it}) = \\text{Var}(b_i + \\epsilon_{it}) = \\text{Var}(b_i) + \\text{Var}(\\epsilon_{it}) = \\sigma^2 + \\frac{\\pi^2}{3}\n$$\n$V_{it}$ 的分布是正态分布和逻辑斯谛分布的卷积，它没有简单的闭式形式。关键的近似方法是，将 $V_{it}$ 视为服从均值为 $0$、方差为 $\\sigma^2 + \\frac{\\pi^2}{3}$ 的逻辑斯谛分布。\n\n一个均值为 $0$、方差为 $v$ 的一般逻辑斯谛分布，其尺度参数 $s$ 满足 $v = s^2 \\frac{\\pi^2}{3}$。因此，$s = \\sqrt{\\frac{3v}{\\pi^2}}$。对于我们的复合误差 $V_{it}$，近似的尺度参数 $s_{\\text{marg}}$ 是：\n$$\ns_{\\text{marg}} = \\sqrt{\\frac{3(\\sigma^2 + \\pi^2/3)}{\\pi^2}} = \\sqrt{\\frac{3\\sigma^2}{\\pi^2} + 1}\n$$\n现在，边际模型可以通过用这个新的尺度参数来缩放预测器的固定部分来近似。\n$$\n\\Pr(Y_{it}=1 \\mid X_{it}) = \\Pr(Y_{it}^*  0 \\mid X_{it}) = \\Pr((\\alpha + \\beta_{\\text{cond}} X_{it}) + V_{it}  0)\n$$\n用尺度为 $s_{\\text{marg}}$ 的逻辑斯谛分布来近似 $V_{it}$，这个概率是：\n$$\n\\Pr(Y_{it}=1 \\mid X_{it}) \\approx F\\left(\\frac{\\alpha + \\beta_{\\text{cond}} X_{it}}{s_{\\text{marg}}}\\right)\n$$\n对该概率进行 logit 变换，得到边际模型的线性预测器：\n$$\n\\text{logit}(\\Pr(Y_{it}=1 \\mid X_{it})) \\approx \\frac{\\alpha}{s_{\\text{marg}}} + \\frac{\\beta_{\\text{cond}}}{s_{\\text{marg}}} X_{it}\n$$\nGEE 模型将边际模型指定为 $\\text{logit}(\\Pr(Y_{it}=1 \\mid X_{it})) = \\alpha_{\\text{marg}} + \\beta_{\\text{marg}} X_{it}$。通过比较系数，我们得到近似关系：\n$$\n\\beta_{\\text{marg}} \\approx \\frac{\\beta_{\\text{cond}}}{s_{\\text{marg}}} = \\frac{\\beta_{\\text{cond}}}{\\sqrt{1 + \\frac{3\\sigma^2}{\\pi^2}}}\n$$\n这就是所要求的关系。只要受试者间方差 $\\sigma^2  0$，分母就大于 $1$，这意味着 $|\\beta_{\\text{marg}}|  |\\beta_{\\text{cond}}|$。群体平均效应相对于受试者特异性效应有所衰减。\n\n现在，我们根据给定的参数计算 $\\beta_{\\text{marg}}$ 的值：$\\beta_{\\text{cond}} = 1.2$ 且 $\\sigma^2 = 0.5$。\n将这些值代入我们推导出的公式：\n$$\n\\beta_{\\text{marg}} \\approx \\frac{1.2}{\\sqrt{1 + \\frac{3 \\times 0.5}{\\pi^2}}} = \\frac{1.2}{\\sqrt{1 + \\frac{1.5}{\\pi^2}}}\n$$\n使用 $\\pi$ 的值，我们计算分母：\n$$\n\\sqrt{1 + \\frac{1.5}{\\pi^2}} \\approx \\sqrt{1 + \\frac{1.5}{9.8696044}} \\approx \\sqrt{1 + 0.1519819} = \\sqrt{1.1519819} \\approx 1.0733042\n$$\n最后，我们计算 $\\beta_{\\text{marg}}$：\n$$\n\\beta_{\\text{marg}} \\approx \\frac{1.2}{1.0733042} \\approx 1.118034\n$$\n问题要求答案四舍五入到四位有效数字。前四位有效数字是 $1.118$。", "answer": "$$\\boxed{1.118}$$", "id": "4502181"}]}