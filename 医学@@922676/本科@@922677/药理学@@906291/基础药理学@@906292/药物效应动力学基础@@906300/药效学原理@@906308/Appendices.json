{"hands_on_practices": [{"introduction": "在临床实践或联合用药中，多种药物可能同时存在于体内，并竞争相同的分子靶点。本练习将演示当一种完全激动剂和一种部分激动剂同时存在时，如何根据每种药物的受体亲和力（由 $K_D$ 决定）及激活受体的内在能力（即内在效能 $\\alpha$）来计算净生理效应。掌握这一原理对于预测药物间的相互作用和设计联合治疗方案至关重要。[@problem_id:4584226]", "problem": "为了阐述药效学（PD）的核心原理，特别是平衡条件下的竞争性结合和内在效能，我们研究一个临床药理学中的受体系统。考虑一个单一群体的正构受体，每个受体只有一个结合位点，不存在受体二聚化、无变构调节剂、也无备用受体。假设系统处于平衡状态，遵循质量作用结合定律，并且游离配体浓度等于总加入浓度。两种激动剂竞争相同的受体位点：\n\n- 一种完全激动剂，标记为 $A$，其解离常数 $K_{D,A} = 10\\,\\mathrm{nM}$，内在效能 $\\alpha_{A} = 1.0$。\n- 一种部分激动剂，标记为 $B$，其解离常数 $K_{D,B} = 5\\,\\mathrm{nM}$，内在效能 $\\alpha_{B} = 0.4$。\n\n两种配体同时存在，浓度固定为 $[A] = 20\\,\\mathrm{nM}$ 和 $[B] = 30\\,\\mathrm{nM}$。假设从受体占有到效应之间存在线性转导关系，即当内在效能为 $\\alpha = 1.0$ 的配体完全占有受体时，系统达到最大可能效应，并且净效应是内在效能的占有率加权和。\n\n仅使用经过充分检验的平衡质量作用结合理论和基于第一性原理的物理一致性推理，计算净效应，并以系统最大效应的小数分数形式表示。将最终答案表示为无单位的小数分数，并四舍五入到 $4$ 位有效数字。", "solution": "该问题要求确定当两种激动剂（完全激动剂 $A$ 和部分激动剂 $B$）竞争同一个正构受体群体时产生的净效应。我们从平衡质量作用结合和线性占有-效应转导的假设出发。\n\n配体 $i$ 的平衡解离常数 $K_{D,i}$ 定义为\n$$\nK_{D,i} \\equiv \\frac{k_{\\mathrm{off},i}}{k_{\\mathrm{on},i}},\n$$\n在平衡时，对于受体 $R$ 和配体 $L_{i}$，\n$$\n\\frac{[RL_{i}]}{[R]} = \\frac{[L_{i}]}{K_{D,i}}.\n$$\n设 $[R_{T}]$ 表示总受体浓度，$[R]$ 表示游离受体浓度，$[RL_{i}]$ 表示与配体 $i$ 结合的受体浓度。受体的质量守恒给出\n$$\n[R_{T}] = [R] + \\sum_{i}[RL_{i}].\n$$\n对每个 $i$ 使用平衡关系，\n$$\n[RL_{i}] = [R]\\frac{[L_{i}]}{K_{D,i}},\n$$\n所以\n$$\n[R_{T}] = [R]\\left(1 + \\sum_{i}\\frac{[L_{i}]}{K_{D,i}}\\right).\n$$\n因此，\n$$\n\\frac{[RL_{i}]}{[R_{T}]} = \\frac{[R]\\frac{[L_{i}]}{K_{D,i}}}{[R]\\left(1 + \\sum_{j}\\frac{[L_{j}]}{K_{D,j}}\\right)} = \\frac{\\frac{[L_{i}]}{K_{D,i}}}{1 + \\sum_{j}\\frac{[L_{j}]}{K_{D,j}}}.\n$$\n因此，在单一位点的竞争性结合下，配体 $i$ 的分数占有率为\n$$\nf_{i} = \\frac{\\frac{[L_{i}]}{K_{D,i}}}{1 + \\sum_{j}\\frac{[L_{j}]}{K_{D,j}}}.\n$$\n对于配体 $A$ 和 $B$ 且无其他竞争者的情况，分母变为\n$$\nD = 1 + \\frac{[A]}{K_{D,A}} + \\frac{[B]}{K_{D,B}}.\n$$\n给定 $[A] = 20\\,\\mathrm{nM}$，$K_{D,A} = 10\\,\\mathrm{nM}$，$[B] = 30\\,\\mathrm{nM}$，$K_{D,B} = 5\\,\\mathrm{nM}$，我们计算无量纲比值\n$$\n\\frac{[A]}{K_{D,A}} = \\frac{20\\,\\mathrm{nM}}{10\\,\\mathrm{nM}} = 2,\n\\qquad\n\\frac{[B]}{K_{D,B}} = \\frac{30\\,\\mathrm{nM}}{5\\,\\mathrm{nM}} = 6,\n$$\n所以\n$$\nD = 1 + 2 + 6 = 9.\n$$\n因此，\n$$\nf_{A} = \\frac{2}{9}, \\qquad f_{B} = \\frac{6}{9}.\n$$\n剩余的部分是游离受体，\n$$\nf_{\\mathrm{free}} = \\frac{1}{9},\n$$\n其对效应没有贡献。\n\n现在我们将占有率与效应联系起来。在线性转导假设下，且内在效能 $\\alpha_{i}$ 被归一化，使得在完全占有时 $\\alpha = 1$ 产生系统的最大响应，则净效应占系统最大效应的分数（记为 $\\frac{E}{E_{\\mathrm{sys}}}$）是 $\\alpha_{i}$ 的占有率加权和：\n$$\n\\frac{E}{E_{\\mathrm{sys}}} = \\sum_{i}\\alpha_{i} f_{i}.\n$$\n当 $\\alpha_{A} = 1.0$ 且 $\\alpha_{B} = 0.4$ 时，\n$$\n\\frac{E}{E_{\\mathrm{sys}}} = \\alpha_{A} f_{A} + \\alpha_{B} f_{B} = 1.0 \\cdot \\frac{2}{9} + 0.4 \\cdot \\frac{6}{9} = \\frac{2}{9} + \\frac{2.4}{9} = \\frac{4.4}{9}.\n$$\n计算小数值：\n$$\n\\frac{4.4}{9} \\approx 0.488888\\ldots\n$$\n四舍五入到 $4$ 位有效数字，无单位的小数分数为\n$$\n0.4889.\n$$\n这就是在所述假设下，净效应占系统最大效应的分数。", "answer": "$$\\boxed{0.4889}$$", "id": "4584226"}, {"introduction": "拮抗剂是药理学中的基础工具，既可在治疗中用于阻断不良效应，也可在实验中用于表征受体系统。本练习将应用受体理论的基石——Gaddum-Schild 方程，来量化竞争性拮抗剂的效应。你将计算需要多少浓度的拮抗剂才能使激动剂的量效曲线产生特定的、可预测的平行右移。[@problem_id:4982958]", "problem": "一种可逆性竞争性拮抗剂与一种完全激动剂结合于同一受体位点。假设以下基本前提：受体结合遵循质量作用定律；拮抗剂的解离常数定义为 $K_{B} = \\frac{[R][B]}{[RB]}$；激动剂的解离常数定义为 $K_{A} = \\frac{[R][A]}{[RA]}$；总受体浓度为 $R_{T} = [R] + [RA] + [RB]$；对于完全激动剂，药理效应与被激动剂占据的受体分数成正比，因此 $E = E_{\\max} \\cdot \\frac{[RA]}{R_{T}}$。在这些条件下，无拮抗剂存在时，激动剂的浓度-效应关系中的半数有效浓度（EC50）等于 $K_{A}$，即半数有效浓度（EC50）满足 $EC_{50,\\ \\text{control}} = K_{A}$。\n\n引入浓度为 $[B]$、自身效能为零的竞争性拮抗剂，它与激动剂竞争相同的结合位点。使用上述基本前提，推导拮抗剂的存在如何改变达到半数最大效应所需的激动剂浓度。然后，对于激动剂浓度-效应曲线期望的向右平移两倍（定义为剂量比 $r = \\frac{EC_{50,\\ \\text{with antagonist}}}{EC_{50,\\ \\text{control}}} = 2$），在给定拮抗剂解离常数 $K_{B} = 37\\ \\text{nM}$ 的情况下，计算所需的拮抗剂浓度 $[B]$，并预测激动剂新的半数有效浓度 $EC_{50,\\ \\text{with antagonist}}$，其中 $EC_{50,\\ \\text{control}} = 13.0\\ \\text{nM}$。\n\n以纳摩尔（nM）为单位表示最终的拮抗剂浓度和预测的半数有效浓度，并将您的数值答案四舍五入到三位有效数字。", "solution": "### 解答推导\n目标是确定在浓度为 $[B]$ 的竞争性拮抗剂存在时，达到半数最大效应（$E = \\frac{1}{2} E_{\\max}$）所需的激动剂浓度 $[A]$。该激动剂浓度将是新的半数有效浓度，记为 $EC_{50,\\ \\text{with antagonist}}$。\n\n根据效应方程 $E = E_{\\max} \\cdot \\frac{[RA]}{R_{T}}$，达到半数最大效应的条件是：\n$$\n\\frac{1}{2} E_{\\max} = E_{\\max} \\cdot \\frac{[RA]}{R_{T}}\n$$\n这可以简化为激动剂的受体占据分数 $\\frac{[RA]}{R_{T}}$ 必须等于 $\\frac{1}{2}$ 的要求：\n$$\n\\frac{[RA]}{R_{T}} = \\frac{1}{2}\n$$\n为求解满足此条件的激动剂浓度 $[A]$，我们首先需要用 $[A]$、$[B]$、$K_{A}$ 和 $K_{B}$ 来表示占据分数 $\\frac{[RA]}{R_{T}}$。\n\n根据解离常数的定义，我们可以用游离受体浓度 $[R]$ 来表示受体-配体复合物的浓度 $[RA]$ 和 $[RB]$：\n$$\nK_{A} = \\frac{[R][A]}{[RA]} \\implies [RA] = \\frac{[R][A]}{K_{A}}\n$$\n$$\nK_{B} = \\frac{[R][B]}{[RB]} \\implies [RB] = \\frac{[R][B]}{K_{B}}\n$$\n总受体浓度 $R_T$ 是游离受体、与激动剂结合的受体以及与拮抗剂结合的受体之和：\n$$\nR_{T} = [R] + [RA] + [RB]\n$$\n将 $[RA]$ 和 $[RB]$ 的表达式代入 $R_T$ 的方程中：\n$$\nR_{T} = [R] + \\frac{[R][A]}{K_{A}} + \\frac{[R][B]}{K_{B}}\n$$\n提取公因子游离受体浓度 $[R]$：\n$$\nR_{T} = [R] \\left( 1 + \\frac{[A]}{K_{A}} + \\frac{[B]}{K_{B}} \\right)\n$$\n现在，我们可以构建激动剂的占据分数表达式 $\\frac{[RA]}{R_{T}}$：\n$$\n\\frac{[RA]}{R_{T}} = \\frac{\\frac{[R][A]}{K_{A}}}{[R] \\left( 1 + \\frac{[A]}{K_{A}} + \\frac{[B]}{K_{B}} \\right)}\n$$\n分子和分母中的 $[R]$ 项相互抵消：\n$$\n\\frac{[RA]}{R_{T}} = \\frac{\\frac{[A]}{K_{A}}}{1 + \\frac{[A]}{K_{A}} + \\frac{[B]}{K_{B}}}\n$$\n为了得到类似于 Michaelis-Menten 方程或 Hill-Langmuir 方程的形式，我们可以将分子和分母同乘以 $K_A$：\n$$\n\\frac{[RA]}{R_{T}} = \\frac{[A]}{K_{A} \\left( 1 + \\frac{[B]}{K_{B}} \\right) + [A]}\n$$\n因此，激动剂的浓度-效应关系为：\n$$\nE = E_{\\max} \\frac{[A]}{K_{A} \\left( 1 + \\frac{[B]}{K_{B}} \\right) + [A]}\n$$\n半数有效浓度 $EC_{50}$ 是使 $E = \\frac{1}{2} E_{\\max}$ 时的 $[A]$ 值。这发生在分母等于 $2[A]$ 时，意味着 $[A]$ 必须等于分母中与之相加的项。因此，在拮抗剂存在下的 $EC_{50}$ 为：\n$$\nEC_{50,\\ \\text{with antagonist}} = K_{A} \\left( 1 + \\frac{[B]}{K_{B}} \\right)\n$$\n题目将剂量比 $r$ 定义为：\n$$\nr = \\frac{EC_{50,\\ \\text{with antagonist}}}{EC_{50,\\ \\text{control}}}\n$$\n已知 $EC_{50,\\ \\text{control}} = K_{A}$，我们可以代入两个 $EC_{50}$ 值的表达式：\n$$\nr = \\frac{K_{A} \\left( 1 + \\frac{[B]}{K_{B}} \\right)}{K_{A}}\n$$\n这简化为 Gaddum-Schild 方程：\n$$\nr = 1 + \\frac{[B]}{K_{B}}\n$$\n该方程将剂量比 $r$ 与拮抗剂浓度 $[B]$ 及其解离常数 $K_{B}$ 联系起来。\n\n### 所需值的计算\n我们已知 $r=2$，$K_{B} = 37\\ \\text{nM}$，以及 $EC_{50,\\ \\text{control}} = 13.0\\ \\text{nM}$。\n\n**1. 计算拮抗剂浓度 $[B]$：**\n使用 Gaddum-Schild 方程，我们求解 $[B]$：\n$$\n2 = 1 + \\frac{[B]}{K_{B}}\n$$\n$$\n1 = \\frac{[B]}{K_{B}}\n$$\n$$\n[B] = K_{B}\n$$\n代入 $K_B$ 的给定值：\n$$\n[B] = 37\\ \\text{nM}\n$$\n四舍五入到三位有效数字，我们得到 $[B] = 37.0\\ \\text{nM}$。\n\n**2. 计算新的半数有效浓度 $EC_{50,\\ \\text{with antagonist}}$：**\n使用剂量比 $r$ 的定义：\n$$\nEC_{50,\\ \\text{with antagonist}} = r \\cdot EC_{50,\\ \\text{control}}\n$$\n代入 $r$ 和 $EC_{50,\\ \\text{control}}$ 的给定值：\n$$\nEC_{50,\\ \\text{with antagonist}} = 2 \\cdot 13.0\\ \\text{nM}\n$$\n$$\nEC_{50,\\ \\text{with antagonist}} = 26.0\\ \\text{nM}\n$$\n该值已经表示为三位有效数字。\n\n所需的拮抗剂浓度为 $37.0\\ \\text{nM}$，预测的激动剂新半数有效浓度为 $26.0\\ \\text{nM}$。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n37.0 & 26.0\n\\end{pmatrix}\n}\n$$", "id": "4982958"}, {"introduction": "药效学理论提供了模型，但其真正的力量来自于将这些模型应用于实验数据。本练习将从纯理论计算转向数据分析，指导你将 S 型 Hill 方程拟合到浓度-效应数据中。这个过程可以从经验上确定药物的最大效应（$E_{\\max}$）、效价（$EC_{50}$）和反应曲线的陡峭程度（Hill 系数 $n$）。[@problem_id:4584147]", "problem": "您的任务是运用临床药理学和药效学（PD）的原理，根据效应-浓度测量数据来估计关键的药效学参数。该场景植根于受体理论和质量作用定律，其中药物效应源于其与有限数量靶点的结合，当可用靶点被完全占据时效应达到饱和，而浓度-效应关系的陡峭程度则反映了结合或信号传导中的协同相互作用。从这些基本思想出发，构建一个非线性最小二乘估计器，用于估计表征可饱和、单调、S型浓度-效应关系的三个参数：最大效应 $E_{\\max}$、半最大效应浓度 $EC_{50}$ 以及常被称为希尔系数 $n$ 的斜率参数。参数 $E_{\\max}$ 和 $EC_{50}$ 必须为严格正值，其物理单位分别为：$E_{\\max}$ 为任意效应单位（a.u.），$EC_{50}$ 为 $\\mathrm{mg}/\\mathrm{L}$。希尔系数 $n$ 必须为严格正值且无量纲。以下数据提供了测量的药物浓度（单位：$\\mathrm{mg}/\\mathrm{L}$）和观测到的效应（单位：a.u.）。您的程序必须拟合一个源自质量作用定律以及效应与占有分数之间比例关系的三参数、与受体占有率一致的模型，且不得对测量数据进行任何线性化或变换处理。\n\n您的估计器必须：\n1. 最小化在每个给定浓度下，观测效应与模型预测效应之间的残差平方和。\n2. 在优化过程中强制执行约束条件 $E_{\\max} \\gt 0$、$EC_{50} \\gt 0$ 和 $n \\gt 0$。\n3. 仅根据数据本身提供稳健的初始猜测值，不使用任何真实参数。\n4. 返回拟合参数 $E_{\\max}$（单位：a.u.）、$EC_{50}$（单位：$\\mathrm{mg}/\\mathrm{L}$）和 $n$（无量纲），每个参数都四舍五入到 $3$ 位小数。\n\n此外，请使用以下分类规则（容差 $\\tau = 0.05$）对希尔系数 $n$ 关于协同行为的解释进行量化编码：如果 $n \\lt 1 - \\tau$（负协同性），则输出 $-1$；如果 $|n - 1| \\le \\tau$（非协同性），则输出 $0$；如果 $n \\gt 1 + \\tau$（正协同性），则输出 $+1$。该分类代码必须是一个整数。\n\n请使用以下包含四个独立数据集的测试套件。对于每个数据集，浓度单位为 $\\mathrm{mg}/\\mathrm{L}$，效应单位为 a.u.。请为每个数据集分别提供估计值。\n\n数据集A（宽范围，中等斜率）：\n- 浓度：$\\{0.25, 0.5, 1, 2, 4, 8, 16\\}$ $\\mathrm{mg}/\\mathrm{L}$\n- 效应：$\\{3.828, 9.520, 21.710, 42.270, 65.880, 83.580, 93.070\\}$ a.u.\n\n数据集B（边界接近非协同性）：\n- 浓度：$\\{0.05, 0.10, 0.20, 0.50, 1.00, 2.00, 5.00\\}$ $\\mathrm{mg}/\\mathrm{L}$\n- 效应：$\\{4.545, 8.333, 14.286, 25.000, 33.333, 40.000, 45.455\\}$ a.u.\n\n数据集C（高协同性，陡峭过渡）：\n- 浓度：$\\{0.10, 0.20, 0.50, 1.00, 2.00, 3.00, 5.00, 10.00\\}$ $\\mathrm{mg}/\\mathrm{L}$\n- 效应：$\\{0.008, 0.128, 4.706, 40.000, 75.294, 79.024, 79.872, 79.992\\}$ a.u.\n\n数据集D（观测范围内饱和度差）：\n- 浓度：$\\{1.00, 2.00, 5.00, 10.00, 20.00, 50.00\\}$ $\\mathrm{mg}/\\mathrm{L}$\n- 效应：$\\{0.891, 1.765, 4.286, 8.182, 15.000, 30.000\\}$ a.u.\n\n角度单位不适用。最终输出必须严格使用上述指定单位表示。\n\n您的程序必须生成单行输出，其中包含一个嵌套的、以逗号分隔的四元组列表形式的结果，每个数据集对应一个四元组，格式为 $[E_{\\max}, EC_{50}, n, \\text{coop\\_code}]$。整个输出必须用方括号括起来，并且每个浮点值都必须四舍五入到 $3$ 位小数。例如，两个数据集的输出应如下所示：$[[e_{1},c_{1},n_{1},k_{1}],[e_{2},c_{2},n_{2},k_{2}]]$，其中 $e_{i}$、$c_{i}$ 和 $n_{i}$ 是浮点数，$k_{i}$ 是整数。\n\n您的程序必须确定性地运行，且不得读取任何外部输入。", "solution": "该问题旨在根据测量的浓度-效应关系来估计药物的药效学参数。问题陈述在科学上是合理的、提法得当且内部一致的。它准确地描述了临床药理学中的一项标准任务：对S型剂量-反应曲线进行参数化。\n\n其基本原理是应用于药物-受体结合的质量作用定律。药物浓度 $C$ 与产生的生理效应 $E$ 之间的关系由希尔-朗缪尔方程描述。该模型假设效应与药物占据的受体分数成正比。对于一个涉及 $n$ 个结合位点的系统，效应 $E$ 作为浓度 $C$ 的函数由下式给出：\n$$\nE(C) = \\frac{E_{\\max} \\cdot C^n}{EC_{50}^n + C^n}\n$$\n待确定的三个参数是：\n1.  $E_{\\max}$：最大效应，表示在药物浓度饱和时的效应。它必须为正值（$E_{\\max} > 0$），单位为效应单位（a.u.）。\n2.  $EC_{50}$：半最大效应浓度，即产生 $50\\%$ 最大效应的药物浓度。它必须为正值（$EC_{50} > 0$），单位为浓度（$\\mathrm{mg}/\\mathrm{L}$）。\n3.  $n$：希尔系数，一个无量纲参数，描述曲线的陡峭程度并反映药物-受体相互作用的协同性。它必须为正值（$n > 0$）。\n\n这些参数（统称为向量 $\\theta = [E_{\\max}, EC_{50}, n]$）的估计是通过非线性最小二乘法进行的。这涉及找到使观测效应数据 $E_{\\text{obs},i}$ 与在每个对应浓度 $C_i$ 下的模型预测效应 $E(C_i, \\theta)$ 之间的残差平方和（SSR）最小化的参数值。要最小化的目标函数是：\n$$\n\\text{SSR}(\\theta) = \\sum_{i=1}^{N} \\left[E_{\\text{obs},i} - E(C_i, \\theta)\\right]^2 = \\sum_{i=1}^{N} \\left[E_{\\text{obs},i} - \\frac{E_{\\max} \\cdot C_i^n}{EC_{50}^n + C_i^n}\\right]^2\n$$\n这个优化问题需要进行数值求解。实现了 Levenberg-Marquardt 算法的 `scipy.optimize.curve_fit` 函数是完成此任务的一个合适且稳健的工具。\n\n非线性优化的一个关键方面是为参数提供良好的初始猜测值。根据希尔方程的性质，我们可以直接从数据中推导出这些猜测值：\n-   **$E_{\\max}$ 的初始猜测值 ($E_{\\max,0}$)**：一个合理的起始点是数据集中的最大观测效应，$E_{\\max,0} = \\max(E_{\\text{obs}})$。这是一个稳健的选择，尽管如果数据未显示出完全饱和，这可能会是一个低估值。\n-   **$EC_{50}$ 的初始猜测值 ($EC_{50,0}$)**：根据定义，$EC_{50}$ 是效应达到半最大值时的浓度。因此，一个合乎逻辑的猜测是数据集中，其对应观测效应 $E_{\\text{obs},i}$ 最接近 $E_{\\max,0} / 2$ 的浓度 $C_i$。\n-   **$n$ 的初始猜测值 ($n_0$)**：希尔系数的一个中性且常用的起始值是 $n_0 = 1$，这对应于非协同性的 Michaelis-Menten 模型。\n\n问题要求物理约束条件 $E_{\\max} > 0$、$EC_{50} > 0$ 和 $n > 0$。通过向 `curve_fit` 函数提供所有三个参数的下界为 $0$ 来强制执行这些约束。\n\n最后，根据结合协同性来解释拟合得到的希尔系数 $n$。使用指定的容差 $\\tau = 0.05$，分类如下：\n-   负协同性（代码 $-1$）：$n < 1 - \\tau = 0.95$。\n-   非协同性（代码 $0$）：$|n - 1| \\le \\tau$，即 $0.95 \\le n \\le 1.05$。\n-   正协同性（代码 $+1$）：$n > 1 + \\tau = 1.05$。\n\n该过程将独立应用于所提供的四个数据集中的每一个。对于每个数据集，算法将：\n1.  定义浓度和效应数据数组。\n2.  计算初始参数猜测值（$p_0 = [E_{\\max,0}, EC_{50,0}, n_0]$）。\n3.  使用 `curve_fit` 执行约束非线性最小二乘拟合，以找到最优参数。\n4.  对得到的希尔系数 $n$ 进行分类，以确定协同性代码。\n5.  将最终参数（$E_{\\max}$、$EC_{50}$、$n$）四舍五入到3位小数，并连同整数协同性代码一起，格式化为指定的输出结构。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import curve_fit\n\ndef solve():\n    \"\"\"\n    Fits a three-parameter Hill equation to pharmacodynamic data and classifies cooperativity.\n    \"\"\"\n    \n    # Define the Hill equation model for the concentration-effect relationship.\n    # The parameters are E_max, EC50, and n (Hill coefficient).\n    # Using np.asarray ensures inputs are arrays and handles C_safe**n correctly for scalars.\n    def hill_equation(C, E_max, EC50, n):\n        C_safe = np.asarray(C, dtype=float)\n        # To prevent 0**n issues for n0 (though n is constrained >0),\n        # we add a small epsilon. Since concentrations are positive, this has no effect.\n        # This also guards against potential warnings or DomainErrors in some math libraries.\n        numerator = E_max * (C_safe**n)\n        denominator = EC50**n + C_safe**n\n        # Avoid division by zero, although denominator is always > 0 \n        # due to the bounds EC50 > 0.\n        return np.divide(numerator, denominator, out=np.zeros_like(numerator), where=denominator!=0)\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"C\": np.array([0.25, 0.5, 1, 2, 4, 8, 16]),\n            \"E\": np.array([3.828, 9.520, 21.710, 42.270, 65.880, 83.580, 93.070])\n        },\n        {\n            \"C\": np.array([0.05, 0.10, 0.20, 0.50, 1.00, 2.00, 5.00]),\n            \"E\": np.array([4.545, 8.333, 14.286, 25.000, 33.333, 40.000, 45.455])\n        },\n        {\n            \"C\": np.array([0.10, 0.20, 0.50, 1.00, 2.00, 3.00, 5.00, 10.00]),\n            \"E\": np.array([0.008, 0.128, 4.706, 40.000, 75.294, 79.024, 79.872, 79.992])\n        },\n        {\n            \"C\": np.array([1.00, 2.00, 5.00, 10.00, 20.00, 50.00]),\n            \"E\": np.array([0.891, 1.765, 4.286, 8.182, 15.000, 30.000])\n        }\n    ]\n\n    all_results = []\n    \n    # Process each dataset\n    for case in test_cases:\n        C_data = case[\"C\"]\n        E_data = case[\"E\"]\n\n        # 1. Generate robust initial guesses from the data.\n        #    - E_max_0: Maximum observed effect.\n        #    - EC50_0: Concentration where effect is closest to half of E_max_0.\n        #    - n_0: Neutral guess of 1.0 (non-cooperative).\n        E_max_0 = np.max(E_data)\n        if E_max_0 == 0: E_max_0 = 1.0 # Fallback for pathological data\n        \n        half_max_effect = E_max_0 / 2.0\n        # Find index of the effect value closest to half_max_effect\n        idx = np.argmin(np.abs(E_data - half_max_effect))\n        EC50_0 = C_data[idx]\n        if EC50_0 == 0: EC50_0 = np.mean(C_data) # Fallback\n\n        n_0 = 1.0\n        \n        p0 = [E_max_0, EC50_0, n_0]\n\n        # 2. Define the bounds for the parameters (Emax > 0, EC50 > 0, n > 0).\n        bounds = ([0, 0, 0], [np.inf, np.inf, np.inf])\n\n        # 3. Perform nonlinear least-squares fitting.\n        try:\n            popt, _ = curve_fit(hill_equation, C_data, E_data, p0=p0, bounds=bounds, maxfev=10000)\n            E_max_fit, EC50_fit, n_fit = popt\n        except RuntimeError:\n            # In case the fit fails, though it shouldn't for these datasets.\n            E_max_fit, EC50_fit, n_fit = np.nan, np.nan, np.nan\n\n        # 4. Classify the Hill coefficient for cooperativity.\n        tau = 0.05\n        if n_fit  1 - tau:\n            coop_code = -1\n        elif n_fit > 1 + tau:\n            coop_code = 1\n        else:\n            coop_code = 0\n            \n        # 5. Store the formatted result quadruple.\n        # The formatting to 3 decimal places happens during string creation.\n        result_quad = [E_max_fit, EC50_fit, n_fit, coop_code]\n        all_results.append(result_quad)\n\n    # 6. Format the final output string as specified.\n    # Each sublist is formatted as a string with no spaces, e.g., '[1.234,5.678,9.012,1]'\n    # Then these strings are joined by commas and enclosed in outer brackets.\n    list_of_quad_strings = []\n    for quad in all_results:\n        # Format floats to 3 decimal places exactly for the output.\n        quad_str = f\"[{quad[0]:.3f},{quad[1]:.3f},{quad[2]:.3f},{quad[3]}]\"\n        list_of_quad_strings.append(quad_str)\n    \n    final_output_string = f\"[{','.join(list_of_quad_strings)}]\"\n    \n    # Final print statement in the exact required format.\n    print(final_output_string)\n\nsolve()\n\n```", "id": "4584147"}]}