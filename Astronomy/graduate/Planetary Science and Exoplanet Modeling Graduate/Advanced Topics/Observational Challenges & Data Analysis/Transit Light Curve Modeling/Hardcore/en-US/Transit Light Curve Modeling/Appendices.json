{
    "hands_on_practices": [
        {
            "introduction": "At the heart of transit modeling lies the calculation of the geometric overlap between the stellar and planetary disks. While the analytic formula for this overlap is well-established, a direct implementation can be numerically fragile, especially near the transit boundaries. This exercise  challenges you to confront the practical issue of catastrophic cancellation and develop a robust algorithm using series expansions, a crucial skill for building reliable scientific software.",
            "id": "4187017",
            "problem": "A star of radius $R_{\\star}$ emits uniformly (no limb darkening), and a planet of radius $R_{p}$ transits across the stellar disk. Let $k = R_{p} / R_{\\star}$ be the planet-to-star radius ratio, and let $z$ be the instantaneous projected center-to-center separation normalized by the stellar radius, $z = d / R_{\\star}$. The normalized stellar flux $F$ during transit is $F = 1 - A / (\\pi R_{\\star}^{2})$, where $A$ is the geometric area of overlap between the two disks of radii $R_{\\star}$ and $R_{p}$ separated by distance $d$. Assume $R_{\\star} = 1$ as the unit length, so $A$ and all distances are dimensionless in units of $R_{\\star}$, and all angles must be expressed in radians.\n\nStarting from fundamental geometric definitions, derive a correct expression for the area of overlap $A$ between two circles of radii $1$ and $k$ at separation $z$ and the corresponding normalized flux $F(k,z)$. Analyze the numerical stability of the analytic expressions near the ingress and egress boundaries, specifically for $z \\approx 1 \\pm k$, where catastrophic cancellation can occur due to differences of nearly equal terms. Propose and justify robust strategies to avoid loss of significance, such as series expansions for $\\arccos$ near $\\pm 1$ and adaptive switching between algebraically equivalent forms (e.g., $\\arccos$ versus $2 \\arctan2(\\cdot,\\cdot)$ identities).\n\nImplement two algorithms:\n\n- A direct analytic evaluator $F_{\\text{naive}}(k,z)$ that follows the classical circle-circle overlap formula using $\\arccos$ and square roots without numerical safeguards beyond minimal clipping of arguments to valid domains.\n- A numerically stabilized evaluator $F_{\\text{stable}}(k,z)$ that uses the same geometric relations but replaces numerically ill-conditioned subexpressions near $z \\approx 1 \\pm k$ by asymptotic series expansions and/or identities that improve numerical behavior, with adaptive switching controlled by thresholds on proximity to the ill-conditioned regime.\n\nYour program must, for each test case below, compute the relative difference $\\Delta = \\left|F_{\\text{naive}} - F_{\\text{stable}}\\right| / \\max\\{F_{\\text{stable}}, \\epsilon\\}$ with a fixed small $\\epsilon = 10^{-30}$, reported as a floating-point number. All quantities are dimensionless; report angles in radians. The final program output should be a single line consisting of a comma-separated list of the $\\Delta$ values enclosed in square brackets.\n\nUse the following test suite to evaluate different regimes:\n\n- Case 1 (moderate partial overlap, happy path): $(k,z) = (0.1, 0.95)$.\n- Case 2 (near external contact, $z \\approx 1 + k$): $(k,z) = (0.1, 1.1 - 10^{-12})$.\n- Case 3 (near internal contact, $z \\approx 1 - k$): $(k,z) = (0.1, 0.9 + 10^{-12})$.\n- Case 4 (very small planet, near external contact): $(k,z) = (10^{-4}, 1 + 10^{-4} - 10^{-12})$.\n- Case 5 (large planet, near internal contact): $(k,z) = (0.5, 0.5 + 10^{-12})$.\n- Case 6 (near-grazing giant, near external contact): $(k,z) = (0.99, 1.99 - 10^{-12})$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,...]\").",
            "solution": "The user-provided problem is a valid and well-posed exercise in computational science, specifically within the domain of exoplanet transit modeling. All provided data and definitions are scientifically sound, and the task addresses a genuine, practical challenge of numerical instability in scientific software.\n\n### 1. Derivation of the Analytic Model\n\nThe problem asks for the normalized stellar flux $F$ during a planetary transit, assuming uniform stellar brightness (no limb darkening). The star has a normalized radius $R_{\\star} = 1$ and the planet has a radius $k = R_p/R_\\star$. The center-to-center projected separation is $z=d/R_\\star$. The normalized flux is given by $F = 1 - A / (\\pi R_{\\star}^2)$, which simplifies to $F = 1 - A/\\pi$ since $R_{\\star}=1$. Here, $A$ is the geometric overlap area of the two circular disks.\n\nThe area of overlap between two circles is the sum of the areas of two circular segments. For a circle of radius $R$ and a chord at a distance $d_c$ from its center, the area of the smaller segment is $A_{seg} = R^2 \\arccos(d_c/R) - d_c \\sqrt{R^2 - d_c^2}$.\n\nLet the star's disk be centered at the origin and the planet's disk be centered at $(z, 0)$. The equation for the star's circle is $x^2 + y^2 = 1$ and for the planet's circle is $(x-z)^2 + y^2 = k^2$. The intersection of these circles occurs along a vertical chord at $x$-coordinate $x_c$:\n$$\nx_c = \\frac{1+z^2-k^2}{2z}\n$$\nThe distance of this chord from the star's center is $x_c$. The distance from the planet's center is $|z-x_c| = |\\frac{z^2+k^2-1}{2z}|$. For the partial-transit regime where $|1-k|  z  1+k$, the term $z^2+k^2-1$ is positive, so the distance is $z-x_c$. The half-length of the chord (the $y$-coordinate of intersection) is $y_{int} = \\sqrt{1-x_c^2}$.\n\nThe total overlap area $A$ is the sum of the two segment areas:\n$$\nA = A_{seg, \\star} + A_{seg, p} = \\left( \\arccos(x_c) - x_c y_{int} \\right) + \\left( k^2 \\arccos\\left(\\frac{z-x_c}{k}\\right) - (z-x_c)y_{int} \\right)\n$$\nCombining terms, we get:\n$$\nA = \\arccos(x_c) + k^2 \\arccos\\left(\\frac{z-x_c}{k}\\right) - (x_c + z - x_c)y_{int} = \\arccos(x_c) + k^2 \\arccos\\left(\\frac{z-x_c}{k}\\right) - z y_{int}\n$$\nThe term $z y_{int}$ can be expressed using Heron's formula for the area of the triangle with sides $1$, $k$, and $z$. The area of this triangle is $\\mathcal{A}_{\\triangle} = \\frac{1}{4}\\sqrt{(-z+k+1)(z+k-1)(z-k+1)(z+k+1)}$. The height of this triangle, corresponding to a base of length $z$, is $y_{int}$. Thus, $\\mathcal{A}_{\\triangle} = \\frac{1}{2} z y_{int}$, which implies $z y_{int} = 2 \\mathcal{A}_{\\triangle}$.\nLet $S_H = \\sqrt{(-z+k+1)(z+k-1)(z-k+1)(z+k+1)}$. Then $z y_{int} = S_H/2$.\nSubstituting $x_c$ and $z-x_c$ into the arccos arguments, we arrive at the standard formula for the overlap area:\n$$\nA(k,z) = \\arccos\\left(\\frac{1+z^2-k^2}{2z}\\right) + k^2 \\arccos\\left(\\frac{z^2+k^2-1}{2zk}\\right) - \\frac{1}{2} S_H\n$$\nThis formula is valid for the partial overlap case, i.e., $1-k  z  1+k$ (for $k1$). For $z \\ge 1+k$, $A=0$. For $z \\le 1-k$, the planet is fully contained and $A = \\pi k^2$.\n\n### 2. Numerical Instability Analysis\n\nThe direct application of this formula is numerically unstable near the transit boundaries, i.e., external contact ($z \\to (1+k)^-$) and internal contact ($z \\to (1-k)^+$).\nLet's analyze the $z \\to (1+k)^-$ case. Let $\\delta = 1+k-z$ be a small positive quantity. The arguments of both $\\arccos$ functions approach $1$. A Taylor expansion of $\\arccos(1-x)$ for small $x$ is $\\sqrt{2x}(1 + x/12 + O(x^2))$.\nThe arguments of the $\\arccos$ functions can be written as $1-d_1$ and $1-d_2$, where:\n$d_1 = 1 - \\frac{1+z^2-k^2}{2z} = \\frac{(k+1-z)(k-1+z)}{2z} \\approx \\frac{\\delta \\cdot 2k}{2(1+k)} = \\frac{k\\delta}{1+k}$\n$d_2 = 1 - \\frac{z^2+k^2-1}{2zk} = \\frac{(1-z+k)(1+z-k)}{2zk} \\approx \\frac{\\delta \\cdot 2}{2k(1+k)} = \\frac{\\delta}{k(1+k)}$\nThe three terms in the area formula $A = \\alpha_1 + k^2\\alpha_2 - S_H/2$ behave as follows:\n$\\alpha_1 \\approx \\sqrt{2d_1} = \\sqrt{\\frac{2k\\delta}{1+k}}$\n$k^2\\alpha_2 \\approx k^2\\sqrt{2d_2} = k^2\\sqrt{\\frac{2\\delta}{k(1+k)}} = \\sqrt{\\frac{2k^3\\delta}{1+k}}$\n$\\frac{S_H}{2} = \\frac{1}{2}\\sqrt{\\delta (2k-\\delta)(2-\\delta)(2k+2-\\delta)} \\approx \\frac{1}{2}\\sqrt{\\delta \\cdot 2k \\cdot 2 \\cdot (2k+2)} = \\sqrt{2k(1+k)\\delta}$\n\nThe sum of the first two terms is:\n$\\alpha_1 + k^2\\alpha_2 \\approx \\frac{\\sqrt{2\\delta}}{\\sqrt{1+k}}(\\sqrt{k} + \\sqrt{k^3}) = \\frac{\\sqrt{2\\delta k}(1+k)}{\\sqrt{1+k}} = \\sqrt{2k(1+k)\\delta}$\nTherefore, to first order in $\\sqrt{\\delta}$, the area is $A \\approx \\sqrt{2k(1+k)\\delta} - \\sqrt{2k(1+k)\\delta} = 0$. This is a classic example of catastrophic cancellation: two large, nearly-equal numbers are subtracted, resulting in a loss of relative precision. The true area scales as $\\delta^{3/2}$, which is a higher-order term lost in this floating-point subtraction. A similar cancellation occurs at the other boundary $z \\to (1-k)^+$.\n\n### 3. Design of the Stable Algorithm\n\nTo circumvent this, a robust algorithm, $F_{\\text{stable}}$, must replace the full expression for $A(k,z)$ in these unstable regimes. While replacing sub-expressions like $\\arccos$ with their series expansions is a partial step, it does not solve the fundamental problem of the final subtraction. The most effective strategy is to replace the entire function $A(k,z)$ with its Taylor series expansion around the boundary points.\n\nThe derivative of the area with respect to separation is $\\frac{dA}{dz} = -\\frac{S_H(z)}{z}$. We can find the area near a boundary $z_0$ by integrating this derivative: $A(z) = A(z_0) + \\int_{z_0}^z A'(t) dt$.\n\nFor external contact, $z_0 = 1+k$ and $A(z_0)=0$. For $z = 1+k-\\delta$:\n$$\nA(z) \\approx \\int_{1+k}^{1+k-\\delta} -\\frac{\\sqrt{8k(1+k)(1+k-t)}}{t} dt \\approx \\frac{\\sqrt{8k(1+k)}}{1+k} \\int_0^{\\delta} \\sqrt{u} du = \\frac{4\\sqrt{2k}}{3\\sqrt{1+k}}\\delta^{3/2}\n$$\nFor internal contact, $z_0 = 1-k$ and $A(z_0)=\\pi k^2$. For $z = 1-k+\\delta$:\n$$\nA(z) \\approx \\pi k^2 + \\int_{1-k}^{1-k+\\delta} -\\frac{\\sqrt{8k(1-k)(t-(1-k))}}{t} dt \\approx \\pi k^2 - \\frac{4\\sqrt{2k}}{3\\sqrt{1-k}}\\delta^{3/2}\n$$\nThese expansions directly compute the leading-order term for the area, avoiding cancellation. The $F_{\\text{stable}}$ algorithm will adaptively switch to these expansions when $z$ is within a small tolerance of $1 \\pm k$. Otherwise, it uses the standard, full `arccos` formula, which is stable away from the boundaries. The $F_{\\text{naive}}$ algorithm implements the direct formula with argument clipping, exposing the numerical fragility.",
            "answer": "```python\nimport numpy as np\n\ndef F_naive(k, z):\n    \"\"\"\n    Computes the normalized flux using a direct, numerically naive \n    implementation of the circle-circle overlap area formula.\n    It relies on clipping arguments to arccos to prevent domain errors,\n    which is a source of inaccuracy at transit boundaries.\n    \n    Args:\n        k (float): Planet-to-star radius ratio (Rp/R*).\n        z (float): Normalized projected center-to-center separation (d/R*).\n        \n    Returns:\n        float: The normalized stellar flux.\n    \"\"\"\n    if z = 0 and k = 1: # Trivial case: star is fully occulted\n        return 0.0\n    if z = 1 + k: # Case 1: No overlap\n        return 1.0\n    if z = 1 - k: # Case 2: Planet is fully contained within the star (k=1)\n        return 1.0 - k**2\n    if k  1 and z = k - 1: # Case 3: Star is fully contained within the planet\n        return 0.0\n\n    # Case 4: Partial overlap. Naively evaluate the standard formula.\n    # Arguments for arccos functions\n    c1_arg = (1 + z**2 - k**2) / (2 * z)\n    c2_arg = (z**2 + k**2 - 1) / (2 * z * k)\n    \n    # Clip arguments to their valid domain [-1, 1] to avoid math errors\n    # from floating-point inaccuracies. This is the main source of error.\n    c1 = np.clip(c1_arg, -1.0, 1.0)\n    c2 = np.clip(c2_arg, -1.0, 1.0)\n    \n    alpha1 = np.arccos(c1)\n    alpha2 = np.arccos(c2)\n    \n    # The third term is half of the area of a triangle with sides 1, k, z, times 4.\n    # This is S_H/2 from the derivation.\n    arg_sqrt = (1 + k - z) * (1 + k + z) * (z + k - 1) * (z - k + 1)\n    sqrt_term = np.sqrt(max(0, arg_sqrt))\n\n    # Total overlap area A\n    A = alpha1 + (k**2 * alpha2) - sqrt_term / 2.0\n    \n    # Normalized flux\n    return 1.0 - A / np.pi\n\ndef F_stable(k, z):\n    \"\"\"\n    Computes the normalized flux using a numerically stable algorithm.\n    It switches to a Taylor series expansion of the area A(z) in the\n    numerically unstable regimes near transit boundaries (z approx 1 +/- k).\n    \n    Args:\n        k (float): Planet-to-star radius ratio (Rp/R*).\n        z (float): Normalized projected center-to-center separation (d/R*).\n        \n    Returns:\n        float: The normalized stellar flux.\n    \"\"\"\n    TOL = 1e-8 # Tolerance for switching to series expansion\n\n    if z = 0 and k = 1: # Trivial case\n        return 0.0\n    if z = 1 + k: # Case 1: No overlap\n        return 1.0\n    if z = 1 - k: # Case 2: Planet is fully contained\n        return 1.0 - k**2\n    if k  1 and z = k - 1: # Case 3: Star is fully contained\n        return 0.0\n\n    # Check for proximity to external contact (z - (1+k)-)\n    delta_ext = 1 + k - z\n    if 0  delta_ext  TOL:\n        C1 = (4 * np.sqrt(2 * k)) / (3 * np.sqrt(1 + k))\n        A = C1 * delta_ext**1.5\n        return 1.0 - A / np.pi\n\n    # Check for proximity to internal contact (z - (1-k)+)\n    delta_int = z - (1 - k)\n    if 0  delta_int  TOL:\n        # The expansion is invalid for k=1, but this case is not tested.\n        # Fallback to general formula if k is very close to 1.\n        if abs(k - 1.0)  1e-9:\n             pass # Fallthrough to general formula\n        else:\n            C2 = (4 * np.sqrt(2 * k)) / (3 * np.sqrt(1 - k))\n            A = np.pi * k**2 - C2 * delta_int**1.5\n            return 1.0 - A / np.pi\n\n    # Case 4: Partial overlap, but in a numerically stable regime.\n    # The general formula is safe to use here.\n    c1 = (1 + z**2 - k**2) / (2 * z)\n    c2 = (z**2 + k**2 - 1) / (2 * z * k)\n    \n    # Although we are in the \"safe\" regime, clipping is good practice.\n    c1 = np.clip(c1, -1.0, 1.0)\n    c2 = np.clip(c2, -1.0, 1.0)\n\n    alpha1 = np.arccos(c1)\n    alpha2 = np.arccos(c2)\n    \n    arg_sqrt = (1 + k - z) * (1 + k + z) * (z + k - 1) * (z - k + 1)\n    # No need for max(0,...) as we are inside the valid partial-overlap domain\n    sqrt_term = np.sqrt(arg_sqrt)\n\n    A = alpha1 + (k**2 * alpha2) - sqrt_term / 2.0\n    \n    return 1.0 - A / np.pi\n\ndef solve():\n    \"\"\"\n    Main function to run test cases and compute the relative difference\n    between the naive and stable flux evaluators.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (k, z)\n        (0.1, 0.95),                  # Case 1: Moderate overlap\n        (0.1, 1.1 - 1e-12),           # Case 2: Near external contact\n        (0.1, 0.9 + 1e-12),           # Case 3: Near internal contact\n        (1e-4, 1 + 1e-4 - 1e-12),     # Case 4: Small planet, near external contact\n        (0.5, 0.5 + 1e-12),           # Case 5: Large planet, near internal contact\n        (0.99, 1.99 - 1e-12),         # Case 6: Grazing giant, near external contact\n    ]\n\n    results = []\n    for k, z in test_cases:\n        f_naive = F_naive(k, z)\n        f_stable = F_stable(k, z)\n        \n        epsilon = 1e-30\n        \n        # Calculate relative difference as specified\n        denominator = max(f_stable, epsilon)\n        if denominator == 0:\n            delta = 0.0 if abs(f_naive - f_stable)  epsilon else np.inf\n        else:\n            delta = abs(f_naive - f_stable) / denominator\n        \n        results.append(delta)\n\n    # Format output as a comma-separated list in brackets\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n\n```"
        },
        {
            "introduction": "A theoretical model of a transit describes the instantaneous stellar flux, but real photometers integrate light over finite exposure times. This time-averaging process \"smears\" the light curve, subtly altering its shape, particularly during the rapid changes of ingress and egress. In this practice , you will implement supersampling, a standard numerical technique to accurately model the effect of finite integration time and quantify its impact on key transit parameters like the ingress slope.",
            "id": "4187052",
            "problem": "You are tasked with quantifying the effect of finite integration time on the modeled ingress slope of a transiting exoplanet using supersampling. Consider a simplified transit model represented by a trapezoid, which approximates the instantaneous stellar flux as a piecewise-linear function of time. Let the out-of-transit flux be $1$, with a transit depth of $\\delta$, a total transit duration of $T_{14}$, and a full-transit (flat-bottom) duration of $T_{23}$. The ingress duration is $T_{12} = (T_{14} - T_{23})/2$. Adopt a time coordinate centered on mid-transit, so that the first contact occurs at $t_1 = -T_{14}/2$ and the second contact at $t_2 = t_1 + T_{12}$. All times must be expressed in seconds ($\\mathrm{s}$), and flux is dimensionless.\n\nDefine the instantaneous trapezoidal flux model $f(t)$ by\n- $f(t) = 1$ for $t  t_1$ and $t  t_4$ where $t_4 = +T_{14}/2$,\n- $f(t) = 1 - \\delta\\,[(t - t_1)/T_{12}]$ for $t_1 \\le t  t_2$ (ingress),\n- $f(t) = 1 - \\delta$ for $t_2 \\le t \\le t_3$ where $t_3 = t_2 + T_{23}$ (full transit),\n- $f(t) = 1 - \\delta\\,[1 - (t - t_3)/T_{12}]$ for $t_3  t \\le t_4$ (egress).\n\nA finite integration time is modeled as a rectangular averaging kernel of width $\\Delta t$. Given a cadence of $\\Delta t = 30\\,\\mathrm{min} = 1800\\,\\mathrm{s}$, define the supersampled, time-averaged model evaluated at cadence-bin centers $t_c$ by\n$$\ng(t_c; N_{\\rm sub}) = \\frac{1}{N_{\\rm sub}} \\sum_{j=1}^{N_{\\rm sub}} f\\!\\left(t_c + u_j\\right),\n$$\nwhere the offsets $u_j$ subdivide the integration window $[-\\Delta t/2, +\\Delta t/2]$ uniformly at midpoints:\n$$\nu_j = -\\frac{\\Delta t}{2} + \\left(j - \\frac{1}{2}\\right)\\frac{\\Delta t}{N_{\\rm sub}}, \\quad j = 1,2,\\dots,N_{\\rm sub}.\n$$\n\nDefine the modeled ingress slope $S(N_{\\rm sub})$ as the slope coefficient from an Ordinary Least Squares (OLS) linear regression of $g(t_c; N_{\\rm sub})$ versus $t_c$, using all bins whose center times satisfy $t_1 \\le t_c \\le t_2$. The \"naive\" non-supersampled case corresponds to $N_{\\rm sub} = 1$, which reduces to evaluating the instantaneous model at bin centers.\n\nFor each specified parameter set, compute the relative change in modeled ingress slope due to supersampling:\n$$\nR = \\frac{S(N_{\\rm sub}) - S(1)}{\\lvert S(1) \\rvert},\n$$\nwhich is a dimensionless scalar that must be reported as a decimal number (without any percent sign). Time must be in $\\mathrm{s}$, and flux is dimensionless. Angles are not used.\n\nImplement a program that:\n1. Constructs the trapezoidal instantaneous model $f(t)$ given $\\delta$, $T_{14}$, and $T_{23}$.\n2. Computes the supersampled, time-averaged model $g(t_c; N_{\\rm sub})$ at cadence-bin centers $t_c = k\\,\\Delta t$ for integer $k$, and selects those with $t_1 \\le t_c \\le t_2$.\n3. Estimates $S(N_{\\rm sub})$ by OLS over the selected ingress bins.\n4. Returns $R$ for each test case below.\n\nUse the fixed cadence $\\Delta t = 1800\\,\\mathrm{s}$. Use the following test suite (each tuple is $(\\delta, T_{14}, T_{23}, N_{\\rm sub})$):\n- Test $1$: $(0.01, 10800, 7200, 1)$.\n- Test $2$: $(0.01, 10800, 7200, 5)$.\n- Test $3$: $(0.01, 18000, 10800, 15)$.\n- Test $4$: $(0.01, 32400, 18000, 60)$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[r1,r2,r3,r4]\"), where each $r_i$ is the value of $R$ for the corresponding test case, formatted as a floating-point number rounded to six decimal places. The output must use the test cases in the order listed above and must not include any additional text or lines.",
            "solution": "The problem requires us to quantify the effect of finite integration time on the measured ingress slope of a simplified exoplanet transit light curve. This is achieved by comparing a \"naive\" model, which samples the flux instantaneously at the center of time bins, with a more realistic supersampled model that averages the flux over the duration of each time bin. The relative difference in the ingress slope derived from these two models serves as the metric for this effect.\n\nThe solution is developed based on the following principles:\n\n1.  **Instantaneous Transit Model**: The physical model for the stellar flux is a trapezoid, a common and effective simplification for transit light curves. The instantaneous flux, denoted $f(t)$, is a piecewise-linear function of time $t$. The time coordinate is centered at mid-transit. The key time points are the first, second, third, and fourth contacts: $t_1$, $t_2$, $t_3$, and $t_4$.\n    -   The out-of-transit flux is normalized to $1$.\n    -   The transit has a uniform depth $\\delta$.\n    -   The total duration is $T_{14}$, so $t_1 = -T_{14}/2$ and $t_4 = +T_{14}/2$.\n    -   The full-transit (flat-bottom) duration is $T_{23}$.\n    -   The ingress and egress phases have equal duration $T_{12} = (T_{14} - T_{23})/2$.\n    -   The contact times are thus $t_1$, $t_2 = t_1 + T_{12}$, $t_3 = t_2 + T_{23}$, and $t_4 = t_3 + T_{12}$.\n\n    The instantaneous flux $f(t)$ is defined as:\n    $$\n    f(t) = \\begin{cases}\n        1  \\text{for } t  t_1 \\text{ or } t  t_4 \\\\\n        1 - \\delta \\frac{t - t_1}{T_{12}}  \\text{for } t_1 \\le t  t_2 \\\\\n        1 - \\delta  \\text{for } t_2 \\le t \\le t_3 \\\\\n        1 - \\delta \\left(1 - \\frac{t - t_3}{T_{12}}\\right)  \\text{for } t_3  t \\le t_4\n    \\end{cases}\n    $$\n    The \"true\" instantaneous slope during ingress is the derivative of $f(t)$ in the interval $[t_1, t_2)$, which is constant: $S_{\\text{true}} = - \\delta / T_{12}$.\n\n2.  **Time-Averaged (Binned) Model**: A realistic measurement does not capture the instantaneous flux $f(t)$, but rather the flux integrated over a finite exposure time, $\\Delta t$. The problem specifies a cadence of $\\Delta t = 1800\\,\\mathrm{s}$ ($30\\,\\mathrm{min}$). The measured flux for a bin centered at time $t_c$ is the average of $f(t)$ over the interval $[t_c - \\Delta t/2, t_c + \\Delta t/2]$. The problem prescribes a numerical method, supersampling, to approximate this average. The integration interval is divided into $N_{\\rm sub}$ sub-intervals, and $f(t)$ is evaluated at the midpoint of each. The supersampled flux $g(t_c; N_{\\rm sub})$ is the average of these $N_{\\rm sub}$ samples:\n    $$\n    g(t_c; N_{\\rm sub}) = \\frac{1}{N_{\\rm sub}} \\sum_{j=1}^{N_{\\rm sub}} f(t_c + u_j)\n    $$\n    where the offsets $u_j$ are uniformly spaced in $[-\\Delta t/2, +\\Delta t/2]$:\n    $$\n    u_j = -\\frac{\\Delta t}{2} + \\left(j - \\frac{1}{2}\\right)\\frac{\\Delta t}{N_{\\rm sub}}\n    $$\n    The \"naive\" model corresponds to $N_{\\rm sub} = 1$. In this case, $u_1 = -\\Delta t/2 + (1/2)\\Delta t = 0$, so $g(t_c; 1) = f(t_c)$. It simply samples the instantaneous flux at the bin center.\n\n3.  **Modeled Ingress Slope Estimation**: The effect of time-averaging is to \"smear\" the sharp corners of the trapezoid, making the ingress and egress transitions appear shallower. To quantify this, we estimate the modeled ingress slope, $S(N_{\\rm sub})$, by performing an Ordinary Least Squares (OLS) linear regression. The data for the regression consist of pairs $(t_c, g(t_c; N_{\\rm sub}))$ for all observation bin centers $t_c$ that fall within the instantaneous ingress phase, i.e., $t_1 \\le t_c \\le t_2$. The bin centers are defined as $t_c = k \\cdot \\Delta t$ for integer values of $k$.\n\n4.  **Algorithmic Implementation**: The final quantity to compute is the relative change in the modeled slope, $R$, between the supersampled model and the naive model:\n    $$\n    R = \\frac{S(N_{\\rm sub}) - S(1)}{|S(1)|}\n    $$\n    The algorithm for each test case $(\\delta, T_{14}, T_{23}, N_{\\rm sub})$ is as follows:\n    a. If $N_{\\rm sub} = 1$, the numerator is $S(1) - S(1) = 0$, so $R=0$ by definition. This handles Test Case $1$.\n    b. For $N_{\\rm sub}  1$, we must compute both $S(N_{\\rm sub})$ and $S(1)$.\n    c. To compute $S(N_{\\text{val}})$ for a given $N_{\\text{val}}$ (either $N_{\\rm sub}$ or $1$):\n        i. Calculate the transit event timings: $T_{12} = (T_{14} - T_{23})/2$, $t_1 = -T_{14}/2$, and $t_2 = t_1 + T_{12}$.\n        ii. Determine the range of integer indices $k$ such that $t_c = k \\cdot \\Delta t$ satisfies $t_1 \\le t_c \\le t_2$. This gives the set of time coordinates $\\{t_c\\}$ for the OLS fit.\n        iii. For each $t_c$ in this set, calculate the corresponding supersampled flux $g(t_c; N_{\\text{val}})$. This involves generating the $N_{\\text{val}}$ sample times $t_c + u_j$, evaluating $f(t)$ at these times, and averaging the results.\n        iv. Perform a linear regression on the set of points $\\{(t_c, g(t_c; N_{\\text{val}}))\\}$ to find the slope, which is $S(N_{\\text{val}})$.\n    d. Substitute the computed slopes $S(N_{\\rm sub})$ and $S(1)$ into the formula for $R$. Since the ingress slope is negative, $|S(1)| = -S(1)$.\n\nThis procedure is implemented for each of the four test cases provided. The calculations are performed using floating-point arithmetic, and the final results are formatted as requested.",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import linregress\n\ndef solve():\n    \"\"\"\n    Main solver function to process test cases and print results.\n    \"\"\"\n    test_cases = [\n        (0.01, 10800, 7200, 1),\n        (0.01, 10800, 7200, 5),\n        (0.01, 18000, 10800, 15),\n        (0.01, 32400, 18000, 60),\n    ]\n\n    results = []\n    for case in test_cases:\n        delta, T14, T23, N_sub = case\n        \n        # Per the problem definition, R is the relative change from S(1).\n        # If N_sub is 1, the change is zero.\n        if N_sub == 1:\n            results.append(0.0)\n            continue\n            \n        S_N = _calculate_slope(delta, T14, T23, N_sub)\n        S_1 = _calculate_slope(delta, T14, T23, 1)\n\n        # The ingress slope S(1) will be negative. abs(S(1)) is used.\n        # Avoid division by zero, though unlikely in this problem.\n        if abs(S_1)  1e-15:\n            R = 0.0\n        else:\n            R = (S_N - S_1) / abs(S_1)\n        \n        results.append(R)\n\n    # Format output as specified.\n    print(f\"[{','.join(f'{r:.6f}' for r in results)}]\")\n\n\ndef _calculate_slope(delta, T14, T23, N_sub, dt=1800.0):\n    \"\"\"\n    Calculates the modeled ingress slope S(N_sub) for a given parameter set.\n    \"\"\"\n    # 1. Define model parameters and timings.\n    T12 = (T14 - T23) / 2.0\n    t1 = -T14 / 2.0\n    t2 = t1 + T12\n    t3 = t2 + T23\n    t4 = T14 / 2.0\n    \n    # 2. Define the instantaneous flux model f(t).\n    def f_model(t):\n        t = np.asarray(t)\n        flux = np.ones_like(t, dtype=float)\n        \n        # Ingress: t1 = t  t2\n        mask_ingress = (t = t1)  (t  t2)\n        flux[mask_ingress] = 1.0 - delta * (t[mask_ingress] - t1) / T12\n        \n        # Full transit: t2 = t = t3\n        mask_full = (t = t2)  (t = t3)\n        flux[mask_full] = 1.0 - delta\n        \n        # Egress: t3  t = t4\n        mask_egress = (t  t3)  (t = t4)\n        flux[mask_egress] = 1.0 - delta * (1.0 - (t[mask_egress] - t3) / T12)\n        \n        return flux\n\n    # 3. Determine the cadence bin centers t_c for the regression.\n    k_min = int(np.ceil(t1 / dt))\n    k_max = int(np.floor(t2 / dt))\n    k_values = np.arange(k_min, k_max + 1)\n    tc_values = k_values * dt\n\n    # 4. Calculate the supersampled, time-averaged flux g(t_c).\n    if N_sub == 1:\n        # The naive case: g(t_c; 1) = f(t_c)\n        g_values = f_model(tc_values)\n    else:\n        # The supersampled case\n        j = np.arange(1, N_sub + 1)\n        u_offsets = -dt / 2.0 + (j - 0.5) * (dt / N_sub)\n        \n        g_values = np.zeros_like(tc_values, dtype=float)\n        for i, tc in enumerate(tc_values):\n            sample_times = tc + u_offsets\n            flux_samples = f_model(sample_times)\n            g_values[i] = np.mean(flux_samples)\n\n    # 5. Perform OLS linear regression to find the slope.\n    # linregress is used as it's a standard and robust OLS implementation.\n    # At least 2 points are guaranteed by the problem's test cases.\n    if len(tc_values)  2:\n        return 0.0 # Slope is undefined for fewer than 2 points.\n        \n    slope, _, _, _, _ = linregress(tc_values, g_values)\n    \n    return slope\n\n# Execute the main function when the script is run.\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "The physical parameters we infer from a transit light curve are only as reliable as the assumptions built into our model. A common simplifying assumption is that the planet's orbit is circular, but this can introduce significant biases if the orbit is actually eccentric. This exercise  guides you through an analytical derivation connecting orbital dynamics to light curve interpretation, revealing how an incorrect assumption about orbital shape propagates into a biased estimate of the mean stellar density, $\\rho_{\\star}$.",
            "id": "4187068",
            "problem": "Consider a single-planet transit observed with high precision, such that the orbital period $P$, the total transit duration $T$ (first-to-fourth contact), and the impact parameter $b$ are well measured. Assume a small planet-to-star radius ratio, $k \\equiv R_{p}/R_{\\star} \\ll 1$, so that the chord length across the stellar disk during transit is approximated by $L \\approx 2 R_{\\star} \\sqrt{1-b^{2}}$. The system’s true orbit is Keplerian with semi-major axis $a$, eccentricity $e$, and argument of periastron $\\omega$. The stellar mass is $M_{\\star}$ and the stellar mean density is $\\rho_{\\star} \\equiv 3 M_{\\star}/(4 \\pi R_{\\star}^{3})$. Neglect the planet mass in the dynamics.\n\nAdopt the following physically justified bases:\n- Kepler’s third law: $n^{2} a^{3} = G M_{\\star}$ with mean motion $n \\equiv 2 \\pi / P$ and gravitational constant $G$.\n- Vis-viva and angular-momentum relations for a Keplerian ellipse: the specific angular momentum $h = \\sqrt{G M_{\\star} a (1-e^{2})}$, radial separation $r(f) = a (1-e^{2})/[1+e \\cos f]$, and transverse (tangential) speed $v_{\\perp}(f) = h/r(f)$ at true anomaly $f$.\n- For a nearly edge-on transit and a duration $T \\ll P$ (transits well away from periastron passage so that the speed is approximately constant over the transit), the total duration is given by $T \\approx L / v_{\\perp}(f_{\\mathrm{tr}})$, where $f_{\\mathrm{tr}}$ is the true anomaly at transit center. For inferior conjunction at high inclination, $f_{\\mathrm{tr}} \\approx \\pi/2 - \\omega$.\n\nA standard, but incorrect, circular-orbit transit fit uses the same measured $P$, $T$, and $b$ to infer a circularly assumed stellar density $\\rho_{\\star,\\mathrm{circ}}$ by replacing the true transverse speed at transit with the circular speed $v_{\\mathrm{circ}} = n a$.\n\nStarting only from the bases above and geometric definitions, derive the multiplicative bias in the inferred stellar density introduced by the circular assumption,\n$$\nC(e,\\omega) \\equiv \\frac{\\rho_{\\star,\\mathrm{circ}}}{\\rho_{\\star}} \\, ,\n$$\nand simplify it to a closed-form expression that depends only on $e$ and $\\omega$. You may assume $k \\ll 1$ so that $L$ depends only on $R_{\\star}$ and $b$, and that the observed $b$ is the same number used by both the true-eccentric and circular fits. Provide your final answer as a single analytic expression for $C(e,\\omega)$ with no units.",
            "solution": "We begin by relating the observed transit duration to the projected orbital speed and the transit chord length. Under the small-planet approximation $k \\ll 1$, the chord length is $L \\approx 2 R_{\\star} \\sqrt{1-b^{2}}$. If the velocity varies negligibly over the short interval $T \\ll P$, the total duration can be approximated by\n$$\nT \\approx \\frac{L}{v_{\\perp}(f_{\\mathrm{tr}})} \\, .\n$$\nWe now compute $v_{\\perp}(f)$ for an eccentric Keplerian orbit. The specific angular momentum is $h = \\sqrt{G M_{\\star} a (1-e^{2})}$, and the star–planet separation at true anomaly $f$ is\n$$\nr(f) = \\frac{a(1-e^{2})}{1 + e \\cos f} \\, .\n$$\nThe transverse (tangential) speed in the orbital plane is given by\n$$\nv_{\\perp}(f) = \\frac{h}{r(f)} = \\frac{\\sqrt{G M_{\\star} a (1-e^{2})}}{a(1-e^{2})/(1 + e \\cos f)} = \\sqrt{\\frac{G M_{\\star}}{a}} \\, \\frac{1 + e \\cos f}{\\sqrt{1 - e^{2}}} \\, .\n$$\nUsing the mean motion $n \\equiv 2 \\pi / P$ and $n a = \\sqrt{G M_{\\star}/a}$, this becomes\n$$\nv_{\\perp}(f) = n a \\, \\frac{1 + e \\cos f}{\\sqrt{1 - e^{2}}} \\, .\n$$\nFor a nearly edge-on transit, inferior conjunction occurs near $f_{\\mathrm{tr}} \\approx \\pi/2 - \\omega$. Substituting $f_{\\mathrm{tr}}$ yields\n$$\n\\cos f_{\\mathrm{tr}} = \\cos\\!\\left(\\frac{\\pi}{2} - \\omega\\right) = \\sin \\omega \\, ,\n$$\nand therefore\n$$\nv_{\\perp}(f_{\\mathrm{tr}}) = n a \\, \\frac{1 + e \\sin \\omega}{\\sqrt{1 - e^{2}}} \\, .\n$$\nHence, the observed duration for the true eccentric orbit is\n$$\nT = \\frac{L}{v_{\\perp}(f_{\\mathrm{tr}})} = \\frac{L}{n a} \\, \\frac{\\sqrt{1 - e^{2}}}{1 + e \\sin \\omega} \\, .\n$$\nNow consider the incorrect circular fit which uses the same measured $P$, $T$, and $b$, but assumes a circular speed $v_{\\mathrm{circ}} = n a_{\\mathrm{circ}}$ and produces an inferred semi-major-axis-to-stellar-radius ratio $(a/R_{\\star})_{\\mathrm{circ}}$. In the circular model,\n$$\nT = \\frac{L}{v_{\\mathrm{circ}}} = \\frac{L}{n a_{\\mathrm{circ}}} \\, .\n$$\nDivide the circular and eccentric expressions for $T$ to eliminate $T$ and $L$:\n$$\n\\frac{L}{n a_{\\mathrm{circ}}} = \\frac{L}{n a} \\, \\frac{\\sqrt{1 - e^{2}}}{1 + e \\sin \\omega} \\quad \\Longrightarrow \\quad \\frac{a_{\\mathrm{circ}}}{a} = \\frac{1 + e \\sin \\omega}{\\sqrt{1 - e^{2}}} \\, .\n$$\nBecause both fits use the same $R_{\\star}$ to interpret the same observed $b$ and chord length $L$ (under $k \\ll 1$), the ratio of the inferred semi-major-axis-to-stellar-radius is identical to the ratio above:\n$$\n\\frac{(a/R_{\\star})_{\\mathrm{circ}}}{(a/R_{\\star})} = \\frac{1 + e \\sin \\omega}{\\sqrt{1 - e^{2}}} \\, .\n$$\nWe now connect $(a/R_{\\star})$ to the stellar density using Kepler’s third law. Neglecting the planet mass,\n$$\nn^{2} a^{3} = G M_{\\star} \\, , \\quad \\rho_{\\star} \\equiv \\frac{3 M_{\\star}}{4 \\pi R_{\\star}^{3}} \\, .\n$$\nEliminating $M_{\\star}$ gives\n$$\n\\rho_{\\star} = \\frac{3}{4 \\pi R_{\\star}^{3}} \\, \\frac{n^{2} a^{3}}{G} = \\frac{3 n^{2}}{4 \\pi G} \\left(\\frac{a}{R_{\\star}}\\right)^{3} \\, .\n$$\nTherefore, the circularly inferred density is\n$$\n\\rho_{\\star,\\mathrm{circ}} = \\frac{3 n^{2}}{4 \\pi G} \\left(\\frac{a}{R_{\\star}}\\right)_{\\mathrm{circ}}^{3} \\, ,\n$$\nand the multiplicative bias factor is\n$$\nC(e,\\omega) \\equiv \\frac{\\rho_{\\star,\\mathrm{circ}}}{\\rho_{\\star}} = \\left[\\frac{(a/R_{\\star})_{\\mathrm{circ}}}{(a/R_{\\star})}\\right]^{3} = \\left(\\frac{1 + e \\sin \\omega}{\\sqrt{1 - e^{2}}}\\right)^{3} \\, .\n$$\nSimplifying,\n$$\nC(e,\\omega) = \\frac{(1 + e \\sin \\omega)^{3}}{(1 - e^{2})^{3/2}} \\, .\n$$\nThis is the desired closed-form correction factor, valid for transits away from periastron where the constant-velocity approximation across the short transit interval is accurate and $f_{\\mathrm{tr}} \\approx \\pi/2 - \\omega$ holds for nearly edge-on geometry. It quantifies how a circular fit biases the inferred stellar density when the true orbit has nonzero eccentricity and argument of periastron $\\omega$.",
            "answer": "$$\\boxed{\\frac{(1+e\\sin\\omega)^{3}}{(1-e^{2})^{3/2}}}$$"
        }
    ]
}