{"hands_on_practices": [{"introduction": "Connecting the immunology of delayed-type hypersensitivity (DTH) to the statistical realities of clinical diagnostics is a critical skill. This first exercise focuses on calculating the Positive Predictive Value (PPV) of a patch test, a common diagnostic tool for Type IV reactions. This practice is essential for understanding that a test's performance depends not only on its intrinsic sensitivity and specificity but also on the prevalence of the condition in the population being tested [@problem_id:2904769]. Mastering this application of Bayes' theorem is crucial for correctly interpreting immunological test results in any real-world clinical or research setting.", "problem": "A dermatology clinic is evaluating a patch test used to diagnose a delayed-type hypersensitivity (DTH) reaction mediated by T helper type 1 (Th1) cells to a particular contact allergen. The patch test is read at $48$–$72$ hours and is considered positive if a characteristic eczematous reaction develops at the application site, reflecting antigen-specific memory T cell activation in the skin. In a target outpatient population with suspected contact dermatitis, the prevalence of true allergen sensitization is $0.10$. Prior validation studies report that, for this allergen, the test sensitivity is $0.85$ and the test specificity is $0.95$. Using only the core definitions of sensitivity, specificity, prevalence, and Bayes’ theorem from probability theory, derive the expression needed to compute the positive predictive value (PPV) of this test in this population, then calculate the PPV. Finally, state in one sentence the clinical implication of this PPV for interpreting a positive patch test in this DTH context. Express the final PPV as a decimal fraction and round your answer to four significant figures.", "solution": "The problem statement is subjected to validation before a solution is attempted.\n\nFirst, the givens are extracted verbatim:\n- The prevalence of true allergen sensitization is $0.10$.\n- The test sensitivity is $0.85$.\n- The test specificity is $0.95$.\n- The task is to derive the expression for the positive predictive value (PPV), calculate it, and state its clinical implication.\n- The final numerical answer must be a decimal fraction rounded to four significant figures.\n\nSecond, the problem is validated against the required criteria. The problem is scientifically grounded, as it describes a standard scenario in diagnostic immunology concerning delayed-type hypersensitivity (DTH) and uses correct terminology and realistic parameters. The concepts of prevalence, sensitivity, specificity, and positive predictive value are fundamental principles in biostatistics and epidemiology. The problem is well-posed; it provides all necessary data to compute a unique, meaningful solution using Bayes' theorem. It is objective and free of ambiguity, contradiction, or logical flaws. The problem is therefore deemed valid and a solution will be provided.\n\nTo derive the expression for the positive predictive value (PPV), we must first define the relevant events in probabilistic terms.\nLet $D$ be the event that a patient has the true allergen sensitization (the \"disease\").\nLet $D^c$ be the event that a patient does not have the true allergen sensitization.\nLet $T^+$ be the event that the patch test result is positive.\nLet $T^-$ be the event that the patch test result is negative.\n\nFrom the problem statement, we translate the given information into conditional probabilities:\n- The prevalence is the a priori probability of having the sensitization: $P(D) = 0.10$.\n- The sensitivity is the probability of a positive test given the patient is sensitized (a true positive): $P(T^+ | D) = 0.85$.\n- The specificity is the probability of a negative test given the patient is not sensitized (a true negative): $P(T^- | D^c) = 0.95$.\n\nThe positive predictive value (PPV) is the probability that a patient is truly sensitized given that they have a positive test result. This is the conditional probability $P(D | T^+)$.\n\nUsing Bayes' theorem, the expression for PPV is:\n$$ \\text{PPV} = P(D | T^+) = \\frac{P(T^+ | D) P(D)}{P(T^+)} $$\n\nThe denominator, $P(T^+)$, is the total probability of a positive test result, which can be found using the law of total probability. A positive test can occur in two mutually exclusive ways: a true positive (patient is sensitized and tests positive) or a false positive (patient is not sensitized but tests positive).\n$$ P(T^+) = P(T^+ \\cap D) + P(T^+ \\cap D^c) $$\n$$ P(T^+) = P(T^+ | D) P(D) + P(T^+ | D^c) P(D^c) $$\n\nWe need to determine the terms $P(D^c)$ and $P(T^+ | D^c)$.\nThe probability of not being sensitized is the complement of the prevalence:\n$$ P(D^c) = 1 - P(D) = 1 - 0.10 = 0.90 $$\nThe probability of a positive test in a non-sensitized patient, $P(T^+ | D^c)$, is the false positive rate. It is the complement of the specificity (the true negative rate):\n$$ P(T^+ | D^c) = 1 - P(T^- | D^c) = 1 - 0.95 = 0.05 $$\n\nNow, we substitute these expressions back into the formula for $P(T^+)$:\n$$ P(T^+) = (0.85)(0.10) + (0.05)(0.90) $$\n\nFinally, we substitute the full expression for $P(T^+)$ into the Bayes' theorem formula for PPV. This provides the complete derived expression required by the problem:\n$$ \\text{PPV} = P(D | T^+) = \\frac{P(T^+ | D) P(D)}{P(T^+ | D) P(D) + P(T^+ | D^c) P(D^c)} $$\n\nNow, we calculate the numerical value by substituting the given probabilities:\n$$ \\text{PPV} = \\frac{(0.85)(0.10)}{(0.85)(0.10) + (0.05)(0.90)} $$\n$$ \\text{PPV} = \\frac{0.085}{0.085 + 0.045} $$\n$$ \\text{PPV} = \\frac{0.085}{0.130} $$\n$$ \\text{PPV} \\approx 0.65384615... $$\n\nRounding to four significant figures, the positive predictive value is $0.6538$.\n\nThe clinical implication of this positive predictive value is that for a patient in this outpatient population with a positive patch test, there is only a $65.38\\%$ probability of true allergen sensitization, indicating that a significant proportion of positive results (approximately $35\\%$) are false positives.", "answer": "$$\\boxed{0.6538}$$", "id": "2904769"}, {"introduction": "The tuberculin skin test (TST) is the archetypal example of a Type IV hypersensitivity reaction, and understanding its mechanism is fundamental to the field of immunology. This exercise challenges you to explain both a classic positive TST reaction and a false-negative result, known as anergy, in an immunosuppressed individual. By dissecting these cases, you will solidify your knowledge of the core cellular and molecular cascade—from antigen presentation and T cell activation to cytokine signaling and leukocyte recruitment—that defines delayed-type hypersensitivity [@problem_id:2904765]. This problem highlights the direct link between molecular pharmacology and clinical immune function.", "problem": "A hospital trainee in occupational health reviews two cases involving the tuberculin skin test (TST) using intradermal purified protein derivative (PPD). Case $1$: A healthy laboratory worker with documented remote exposure to Mycobacterium tuberculosis returns at $48$ hours with a firm, nonpitting area of induration measuring $16$ mm at the injection site. Case $2$: A patient with Crohn’s disease on high-dose prednisone and infliximab (a tumor necrosis factor-$\\alpha$ inhibitor) has a TST read at $72$ hours with $0$ mm induration, despite prior documentation of latent tuberculosis infection by an interferon-$\\gamma$ release assay.\n\nUsing only fundamental immunologic principles—antigen processing and presentation by Major Histocompatibility Complex (MHC), T cell receptor (TCR)-mediated recognition, differentiation and effector functions of T helper cells, cytokine-mediated leukocyte recruitment, and the time course of cell-mediated responses—select the single option that best explains both the mechanism underlying the positive TST reaction in Case $1$ and the most parsimonious reason for the false-negative delayed-type hypersensitivity (DTH) response in Case $2$.\n\nA. The positive TST is driven by antigen-specific memory CD4$^+$ T helper 1 (Th1) cells recognizing PPD-derived peptides presented by MHC class II on dermal antigen-presenting cells (APCs), leading to rapid secretion of interferon-$\\gamma$ and tumor necrosis factor-$\\alpha$, endothelial activation (for example, upregulation of E-selectin, ICAM-$1$, and VCAM-$1$), chemokine production, recruitment and activation of blood monocytes into macrophages, and induration over $48$–$72$ hours; the false-negative in the immunosuppressed patient reflects depletion or functional impairment of these memory Th1 cells and/or blockade of their requisite cytokine signaling, preventing the DTH cascade.\n\nB. The positive TST is mediated by antigen-specific immunoglobulin E (IgE) bound to mast cells that degranulate upon PPD exposure, producing an immediate wheal-and-flare within $15$ minutes; the false-negative arises because immunosuppression reduces serum IgE concentrations below the threshold needed for mast cell activation.\n\nC. The positive TST reflects deposition of circulating immune complexes containing anti-PPD immunoglobulin G (IgG) and complement (an Arthus-type reaction), which damage dermal vessels to produce induration; the false-negative is explained by complement consumption during chronic infection, leading to insufficient complement to drive the reaction.\n\nD. The positive TST requires cytotoxic CD8$^+$ T lymphocyte recognition of PPD peptides presented on MHC class I by keratinocytes, resulting in target-cell apoptosis and edema; the false-negative occurs because neutropenia limits collateral inflammation necessary for visible induration.\n\nE. The positive TST results from nonspecific local irritation and fluid extravasation from the needle trauma, and the false-negative in the immunosuppressed patient is due to reduced skin perfusion rather than altered immunity.", "solution": "The problem statement will be validated before any attempt at a solution.\n\n### Step 1: Extract Givens\n- **Test:** Tuberculin skin test (TST) using intradermal purified protein derivative (PPD).\n- **Case 1:** A healthy laboratory worker with documented remote exposure to *Mycobacterium tuberculosis*.\n- **Observation 1:** At $48$ hours, a firm, nonpitting area of induration measuring $16$ mm is observed at the injection site.\n- **Case 2:** A patient with Crohn’s disease on high-dose prednisone and infliximab (a tumor necrosis factor-$\\alpha$ inhibitor).\n- **Observation 2:** At $72$ hours, $0$ mm induration is observed, despite prior documentation of latent tuberculosis infection demonstrated by an interferon-$\\gamma$ release assay (IGRA).\n- **Objective:** Explain the immunological mechanism for the positive TST in Case $1$ and the reason for the false-negative response in Case $2$, based on fundamental principles of immunology. The principles specified are: antigen processing and presentation by Major Histocompatibility Complex (MHC), T cell receptor (TCR)-mediated recognition, differentiation and effector functions of T helper cells, cytokine-mediated leukocyte recruitment, and the time course of cell-mediated responses.\n\n### Step 2: Validate Using Extracted Givens\n- **Scientifically Grounded:** The problem describes a classic immunological phenomenon, the delayed-type hypersensitivity (DTH) reaction, exemplified by the tuberculin skin test. The details given are entirely consistent with established immunological and clinical facts. Case $1$ presents a standard positive TST in a sensitized individual. Case $2$ presents a state of anergy (a false-negative DTH response) in a patient on known immunosuppressive agents (prednisone, a corticosteroid, and infliximab, a TNF-$\\alpha$ antagonist). The use of these specific drugs to treat Crohn's disease and their known effect on T-cell-mediated immunity are standard medical knowledge. The time course ($48-72$ hours) is the defining characteristic of a DTH reaction.\n- **Well-Posed:** The problem is clearly formulated. It requests a single mechanistic explanation for two related observations, based on a defined set of fundamental principles. A unique and logical solution can be derived from these principles.\n- **Objective:** The problem is described using precise, objective clinical and scientific terminology. There is no subjectivity or ambiguity.\n- **Completeness and Consistency:** The problem provides all necessary information. The subject in Case $1$ is sensitized (\"remote exposure\"). The subject in Case $2$ is known to have memory T cells against tuberculosis antigens (confirmed by a positive IGRA), making the lack of a skin reaction a true false-negative, not a result of non-sensitization. The immunosuppressive agents are specified, allowing a precise mechanistic analysis of the failed response. The setup is internally consistent and complete.\n\n### Step 3: Verdict and Action\nThe problem statement is valid. It is scientifically sound, well-posed, objective, and self-contained. Therefore, a solution will be derived.\n\n### Derivation of Solution\nThe TST is the canonical example of a Type IV hypersensitivity reaction, also known as delayed-type hypersensitivity (DTH). This response is mediated by T lymphocytes, not antibodies. The reaction requires two phases: sensitization and elicitation.\n\n1.  **Sensitization Phase:** This phase occurs upon initial exposure to antigens of *Mycobacterium tuberculosis*. The subject in Case $1$ has undergone this phase due to \"remote exposure\". During sensitization, bacterial antigens are phagocytosed by antigen-presenting cells (APCs), such as macrophages and dendritic cells. The antigens are processed into peptides, which are loaded onto MHC class II molecules and presented on the APC surface. Naive CD4$^+$ T cells with a specific T cell receptor (TCR) recognize this peptide-MHC complex. This recognition, along with co-stimulatory signals (e.g., B$7$-CD$28$), drives the differentiation of these naive T cells into antigen-specific T helper 1 (Th1) cells and memory T cells.\n\n2.  **Elicitation Phase (The TST):** This is what is observed in the problem.\n    - **Case 1 (Positive Reaction):** Intradermal injection of PPD (a mixture of proteins from *M. tuberculosis*) introduces the antigens into the dermis.\n    - Local APCs (e.g., Langerhans cells, dermal macrophages) take up and process these proteins, presenting PPD-derived peptides on MHC class II molecules.\n    - Circulating, antigen-specific memory Th1 cells, created during the prior sensitization, are recruited to the site. They recognize the PPD peptide-MHC II complex on the APCs.\n    - This recognition reactivates the memory Th1 cells, causing them to secrete a profile of pro-inflammatory cytokines, most critically interferon-$\\gamma$ (IFN-$\\gamma$) and tumor necrosis factor-$\\alpha$ (TNF-$\\alpha$).\n    - IFN-$\\gamma$ is a potent activator of macrophages, enhancing their phagocytic and microbicidal capabilities.\n    - Both IFN-$\\gamma$ and TNF-$\\alpha$ act on local vascular endothelial cells, inducing the expression of adhesion molecules such as E-selectin, ICAM-$1$ (Intercellular Adhesion Molecule $1$), and VCAM-$1$ (Vascular Cell Adhesion Molecule $1$).\n    - Activated Th1 cells and activated endothelial cells also produce chemokines (e.g., CCL$2$, CXCL$8$), which establish a chemotactic gradient.\n    - This combination of upregulated adhesion molecules and chemokines facilitates the recruitment of circulating leukocytes, predominantly monocytes and other lymphocytes, from the blood into the tissue. This process of cellular infiltration takes time, peaking at approximately $48$ to $72$ hours after antigen injection.\n    - Once in the tissue, monocytes differentiate into activated macrophages. The accumulation of these infiltrating cells, along with local edema from increased vascular permeability, results in the characteristic firm, raised area of induration. A measurement of $16$ mm is a strong positive result.\n\n3.  **Explanation of Case 2 (False-Negative Reaction):** The patient has a positive IGRA, which directly measures the release of IFN-$\\gamma$ by the patient's T cells when stimulated *ex vivo* with TB antigens. This confirms the presence of functional, antigen-specific memory T cells. The failure of the TST must therefore be due to the suppression of the *in vivo* response.\n    - **Prednisone:** A glucocorticoid, a powerful immunosuppressant. It acts by binding to the cytosolic glucocorticoid receptor. The activated receptor-ligand complex translocates to the nucleus, where it inhibits the transcription of genes encoding numerous pro-inflammatory cytokines, including TNF-$\\alpha$, IFN-$\\gamma$, and various interleukins. It can also induce apoptosis in lymphocytes. Thus, prednisone impairs the ability of Th1 cells to produce their effector cytokines.\n    - **Infliximab:** A monoclonal antibody that specifically binds to and neutralizes TNF-$\\alpha$. TNF-$\\alpha$ is an essential cytokine for the DTH cascade, being critical for endothelial activation and leukocyte recruitment.\n    - **Combined Effect:** The patient's immune system is doubly suppressed at key points in the DTH pathway. Prednisone reduces the production of IFN-$\\gamma$ and TNF-$\\alpha$ by the Th1 cells. Any remaining TNF-$\\alpha$ is then neutralized by infliximab. Without sufficient levels of these two key cytokines, the downstream events—endothelial activation, chemokine production, and monocyte recruitment—are abrogated. No significant cellular infiltrate can form, and thus no induration develops. This state is known as anergy.\n\n### Option-by-Option Analysis\n\n**A. The positive TST is driven by antigen-specific memory CD4$^+$ T helper 1 (Th1) cells recognizing PPD-derived peptides presented by MHC class II on dermal antigen-presenting cells (APCs), leading to rapid secretion of interferon-$\\gamma$ and tumor necrosis factor-$\\alpha$, endothelial activation (for example, upregulation of E-selectin, ICAM-$1$, and VCAM-$1$), chemokine production, recruitment and activation of blood monocytes into macrophages, and induration over $48$–$72$ hours; the false-negative in the immunosuppressed patient reflects depletion or functional impairment of these memory Th1 cells and/or blockade of their requisite cytokine signaling, preventing the DTH cascade.**\n- This option correctly identifies all key components of the DTH reaction as derived above: CD4$^+$ Th1 cells, MHC class II presentation, IFN-$\\gamma$ and TNF-$\\alpha$ as key cytokines, subsequent endothelial activation, cellular recruitment, and the characteristic time course. It also provides a precise and accurate explanation for the false-negative in Case $2$, citing functional impairment (due to prednisone) and blockade of cytokine signaling (due to infliximab). This description is complete and immunologically correct.\n- Verdict: **Correct**.\n\n**B. The positive TST is mediated by antigen-specific immunoglobulin E (IgE) bound to mast cells that degranulate upon PPD exposure, producing an immediate wheal-and-flare within $15$ minutes; the false-negative arises because immunosuppression reduces serum IgE concentrations below the threshold needed for mast cell activation.**\n- This option describes a Type I hypersensitivity reaction. The TST is a Type IV reaction. The mediators (IgE, mast cells), clinical signs (wheal-and-flare), and time course ($15$ minutes) are all incorrect for a TST, which involves T-cells, induration, and a delay of $48-72$ hours.\n- Verdict: **Incorrect**.\n\n**C. The positive TST reflects deposition of circulating immune complexes containing anti-PPD immunoglobulin G (IgG) and complement (an Arthus-type reaction), which damage dermal vessels to produce induration; the false-negative is explained by complement consumption during chronic infection, leading to insufficient complement to drive the reaction.**\n- This option describes a Type III hypersensitivity reaction. The TST is a Type IV reaction. While an Arthus reaction can cause induration, its primary mediators are immune complexes and complement, not T cells, and it peaks at an earlier time point (typically $4-8$ hours). The fundamental mechanism is incorrect for a TST.\n- Verdict: **Incorrect**.\n\n**D. The positive TST requires cytotoxic CD8$^+$ T lymphocyte recognition of PPD peptides presented on MHC class I by keratinocytes, resulting in target-cell apoptosis and edema; the false-negative occurs because neutropenia limits collateral inflammation necessary for visible induration.**\n- This option describes a T-cell mediated response, but incorrectly identifies the principal players. The TST is dominated by CD4$^+$ Th1 cells recognizing exogenous antigen on MHC class II. CD8$^+$ T cells recognize endogenous antigens on MHC class I. While CD8$^+$ T cells play a role in controlling established TB infection, the TST itself is a classic CD4$^+$ response. The primary cell recruited is the monocyte, not the neutrophil.\n- Verdict: **Incorrect**.\n\n**E. The positive TST results from nonspecific local irritation and fluid extravasation from the needle trauma, and the false-negative in the immunosuppressed patient is due to reduced skin perfusion rather than altered immunity.**\n- This option incorrectly dismisses the specific immunological basis of the TST. A $16$ mm induration is a robust, antigen-specific immune response, not a simple reaction to trauma. The explanation for the false-negative is also incorrect; the profound immunosuppressive effects of prednisone and infliximab are the direct and parsimonious cause of anergy, not a hypothetical change in skin perfusion.\n- Verdict: **Incorrect**.", "answer": "$$\\boxed{A}$$", "id": "2904765"}, {"introduction": "This advanced practice moves beyond static diagrams and invites you to build a dynamic simulation of contact hypersensitivity from first principles. By implementing a computational agent-based model, you will translate qualitative immunological knowledge into quantitative rules that govern cell behavior and interactions over time and space. This exercise provides deep insight into how complex emergent phenomena, like the formation of a skin lesion, arise from simple, local cellular rules and introduces a powerful methodology for exploring the dynamics of the immune system [@problem_id:2904755].", "problem": "You are to implement a minimal agent-based simulation of contact hypersensitivity as a delayed-type, cell-mediated reaction in skin microanatomy, in which epidermal keratinocyte damage emerges from the interplay of antigen-bearing dendritic cells, recruited T lymphocytes, and macrophages. The simulation must be constructed from first principles consistent with established immunology: antigen exposure causes danger signaling by damaged keratinocytes, dendritic cell activation and migration to lymph nodes, and after a delay, effector T cells return to the tissue, activate macrophages, and amplify keratinocyte damage.\n\nYour program must execute a discrete-time, two-dimensional agent-based model grounded in these core biological bases without relying on any domain-specific \"black box\" formulas. Use the following fundamental bases and core definitions as the starting point for your model design:\n\n- Cellular agents occupy a two-dimensional lattice and undergo stochastic state changes and movements consistent with local interactions and random motility; such rules approximate diffusion and chemotaxis on microscopic time scales via random walks and neighborhood-dependent transition probabilities.\n- Dendritic cells present antigen to T cells in lymph nodes; the expansion and return of effector T cells to tissue is delayed relative to the initial exposure, characteristic of type IV delayed-type hypersensitivity.\n- T helper type $1$ effector cells produce interferon gamma and activate macrophages; activated macrophages mediate collateral tissue damage on keratinocytes through inflammatory effector functions.\n- Local interaction rates can be modeled as Bernoulli processes per time step with probabilities derived from mass-action-like dependence on neighbor counts.\n\nImplement the following model, parameters, and rules exactly as specified.\n\nState space and geometry:\n- Use a square lattice of size $N \\times N$ with $N = 20$. Indices are integers with $x \\in \\{0,\\dots,N-1\\}$ and $y \\in \\{0,\\dots,N-1\\}$.\n- The epidermis occupies rows $y \\in \\{0,\\dots,N_{e}-1\\}$ and the dermis occupies rows $y \\in \\{N_{e},\\dots,N-1\\}$, where $N_{e} = \\lfloor N/2 \\rfloor = 10$.\n- Keratinocytes reside implicitly on the epidermal lattice sites and have a binary damage state $K(y,x,t) \\in \\{0,1\\}$, where $1$ denotes damaged at time step $t$.\n- Dendritic cells, T cells, and macrophages are explicit agents with integer lattice positions $(x,y)$ constrained to the dermis for all times, i.e., $y \\geq N_{e}$.\n\nTime and initialization:\n- Simulate discrete time steps $t = 0,1,2,\\dots,T_{\\text{end}}-1$ with $T_{\\text{end}} = 72$.\n- The delayed effector phase begins at $t = \\tau_{\\text{sens}}$ with $\\tau_{\\text{sens}} = 24$.\n- At $t=0$, a circular hapten patch centered at $(x_{c},y_{c}) = (\\lfloor N/2 \\rfloor,\\lfloor N_{e}/2 \\rfloor)$ with radius $R(d) = 2 + \\lfloor d \\rfloor$ is applied, where $d$ is the hapten dose parameter from the test suite. Each keratinocyte $(y,x)$ within Euclidean distance $\\leq R(d)$ from the center is independently damaged with probability $p_{0}(d) = 1 - e^{-\\alpha d}$, where $\\alpha = 0.5$.\n- Initialize $N_{\\text{DC}} = 40$ dendritic cell agents at uniformly random dermal positions with $y \\in \\{N_{e},N_{e}+1,N_{e}+2\\}$ and $x \\in \\{0,\\dots,N-1\\}$, all in the resting state.\n- Initialize $N_{\\text{M}} = 60$ macrophage agents at uniformly random dermal positions $y \\in \\{N_{e},\\dots,N-1\\}$ and $x \\in \\{0,\\dots,N-1\\}$, all in the resting state.\n- Initialize zero T cells at $t=0$. Effector T cells will be introduced at $t=\\tau_{\\text{sens}}$ as specified below.\n\nStochasticity and reproducibility:\n- Use a pseudorandom number generator with a deterministic seed per test case: the seed must be $12345 + i$, where $i$ is the zero-based index of the test case in the provided test suite. All random draws in a test case must be derived from this seed.\n\nPer-time-step rules:\n- Dendritic cell activation and migration:\n  - For each dendritic cell at position $(x,y)$ with $y \\geq N_{e}$, define its epidermal contact neighborhood as the basal epidermal row $y^{*} = N_{e}-1$ at columns $x + \\Delta x$ with $\\Delta x \\in \\{-1,0,1\\}$ clamped to lattice bounds. Let $n_{d}(t)$ be the number of damaged keratinocytes among these positions at time $t$.\n  - A resting dendritic cell becomes activated at time $t$ with probability $p_{\\text{act}}(t) = 1 - e^{-\\beta n_{d}(t)}$, where $\\beta = 0.25$.\n  - An activated dendritic cell attempts to migrate toward lymphatic exit at the bottom boundary. At each time step, with probability $m$ (a test-case parameter), it moves one lattice step to $(x, y+1)$ if $y < N-1$. If $y = N-1$, then with probability $m$ it exits the tissue and is removed, and the exited dendritic cell count $E(t)$ is incremented by $1$. If it does not move due to the Bernoulli outcome, it stays in place for that step.\n  - A resting dendritic cell performs a random jitter with probability $p_{\\text{jitter}} = 0.3$ by moving to one of the $3 \\times 3$ Moore neighbors in the dermis (Chebyshev step of at most $1$) uniformly at random; otherwise, it remains in place. All positions must be clamped to remain in the dermis ($y \\geq N_{e}$).\n- Effector T cell recruitment:\n  - At $t = \\tau_{\\text{sens}}$, introduce $N_{\\text{T}}(\\tau_{\\text{sens}}) = \\left\\lfloor 0.5 + k_{T} \\cdot E(\\tau_{\\text{sens}}) \\right\\rfloor$ effector T cells at uniformly random dermal positions, where $k_{T} = 0.8$ and $E(\\tau_{\\text{sens}})$ is the cumulative number of exited dendritic cells up to and including time $\\tau_{\\text{sens}}$. No additional T cells are introduced after $t = \\tau_{\\text{sens}}$.\n  - For all $t \\geq \\tau_{\\text{sens}}$, each T cell performs a simple random walk: at each step it moves to a uniformly chosen Moore neighbor in the dermis (Chebyshev step of at most $1$), with lattice clamping to enforce $y \\geq N_{e}$.\n- Macrophage activation and keratinocyte damage amplification:\n  - For all $t \\geq \\tau_{\\text{sens}}$, any macrophage that has at least one T cell within Chebyshev distance $\\leq 1$ becomes activated and remains activated thereafter.\n  - Each activated macrophage independently attempts to damage an epidermal keratinocyte once per time step. It selects a target epidermal site $(x',y')$ where $x' \\in \\{x-1,x,x+1\\}$ clamped to lattice bounds and $y' \\in \\{N_{e}-2,N_{e}-1\\}$ clamped to $\\{0,\\dots,N_{e}-1\\}$, with equal probability over the available choices. If that keratinocyte is not already damaged, it becomes damaged with probability $p_{K} = \\min(1,c)$, where $c$ is the T cell–macrophage interaction strength parameter for the test case.\n\nOutput observable:\n- The lesion size is defined as the total number of damaged keratinocytes at the end of the simulation, i.e., $L = \\sum_{y=0}^{N_{e}-1} \\sum_{x=0}^{N-1} K(y,x,T_{\\text{end}})$, an integer count.\n\nInput-free execution and test suite:\n- Your program must run without any input and must execute the simulation for each of the following test cases, where each test case is a triple $(d,m,c)$:\n  - Case $0$: $(d,m,c) = (1.5,0.6,0.4)$.\n  - Case $1$: $(d,m,c) = (0.0,0.8,0.7)$.\n  - Case $2$: $(d,m,c) = (3.0,0.9,0.9)$.\n  - Case $3$: $(d,m,c) = (1.5,0.1,0.9)$.\n- For each case $i \\in \\{0,1,2,3\\}$, run the model with the specified parameters, using the random seed $12345 + i$, and compute $L_{i}$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with the lesion sizes in case order, i.e., the exact string format must be $[L_{0},L_{1},L_{2},L_{3}]$ where each $L_{i}$ is an integer written in base-$10$ digits with no spaces.", "solution": "The problem statement has been subjected to rigorous validation and is deemed valid. It provides a complete, self-contained, and scientifically plausible specification for an agent-based model of a delayed-type hypersensitivity reaction. All parameters, initial conditions, and dynamic rules are explicitly defined, permitting a unique and reproducible computational solution. The model, while a simplification, is grounded in established immunological principles: danger signaling, antigen presentation by dendritic cells, delayed clonal expansion of T cells, and macrophage-mediated effector functions. The problem is well-posed and objective. We shall now proceed with the solution.\n\nThe core of the problem is to construct a discrete-time, two-dimensional agent-based simulation. We will design this simulation by defining the state space and the dynamic rules that govern the evolution of agents and the environment over time, adhering strictly to the provided specifications.\n\n**1. State Space Representation**\n\nThe system's state at any time step $t$ is defined by the states of its components: the lattice representing the skin tissue and the populations of mobile cellular agents.\n\n-   **Skin Lattice**: The tissue is a $N \\times N$ grid, with $N=20$. It is divided into an epidermis for $y \\in \\{0, \\dots, N_e-1\\}$ and a dermis for $y \\in \\{N_e, \\dots, N-1\\}$, where $N_e = \\lfloor N/2 \\rfloor = 10$.\n    -   **Keratinocyte Damage**: The state of the epidermis is represented by a two-dimensional integer array $K$ of size $N_e \\times N$. An element $K(y,x,t) = 1$ signifies a damaged keratinocyte at position $(x,y)$ at time $t$, and $K(y,x,t) = 0$ signifies an undamaged one.\n\n-   **Cellular Agents**: Dendritic cells (DCs), T cells, and macrophages are represented as individual agents. For a simulation of this scale, a list of data structures (e.g., Python dictionaries) for each cell type is efficient. Each agent's state includes at a minimum its position $(x,y)$ and an activation status.\n    -   **Dendritic Cells (DCs)**: A list of $N_{DC} = 40$ agents, each defined by its position $(x,y)$ in the dermis ($y \\ge N_e$) and its state (resting or activated).\n    -   **T Cells**: A list of agents, initially empty. Each is defined by its dermal position $(x,y)$.\n    -   **Macrophages (Ms)**: A list of $N_M = 60$ agents, each defined by its fixed dermal position $(x,y)$ and its state (resting or activated).\n\n-   **Global Variables**:\n    -   $E(t)$: The cumulative count of DCs that have exited the tissue by time $t$.\n\n**2. Initialization (Time $t=0$)**\n\nThe simulation begins by setting up the initial state according to the problem rules. A specific seed, $12345 + i$ for test case $i$, is used to initialize a pseudorandom number generator (PRNG) to ensure reproducibility.\n\n-   **Initial Keratinocyte Damage**: A circular patch of initial damage is created. The center is $(x_c, y_c) = (\\lfloor N/2 \\rfloor, \\lfloor N_e/2 \\rfloor) = (10, 5)$. The radius is $R(d) = 2 + \\lfloor d \\rfloor$. For each keratinocyte within this radius, a random number is drawn from the PRNG. If this number is less than the initial damage probability $p_0(d) = 1 - e^{-\\alpha d}$ (with $\\alpha = 0.5$), the keratinocyte state $K(y,x,0)$ is set to $1$.\n\n-   **Initial Agent Populations**:\n    -   $N_{DC} = 40$ DCs are created with uniformly random positions in the upper dermis ($y \\in \\{10, 11, 12\\}$ and $x \\in \\{0, \\dots, 19\\}$) and are all set to the 'resting' state.\n    -   $N_M = 60$ macrophages are created with uniformly random positions throughout the dermis ($y \\in \\{10, \\dots, 19\\}$ and $x \\in \\{0, \\dots, 19\\}$) and are all set to the 'resting' state.\n    -   The T cell population is initially zero.\n    -   The exited DC count $E(0)$ is initialized to $0$.\n\n**3. Simulation Dynamics (Time Evolution)**\n\nThe simulation proceeds in discrete time steps from $t=0$ to $t=T_{\\text{end}}-1$, with $T_{\\text{end}} = 72$. At each step, the state of the system is updated based on the rules applied sequentially to each agent population.\n\n-   **Dendritic Cell Dynamics**:\n    1.  **Activation**: For each resting DC at position $(x,y)$, we count the number of damaged keratinocytes, $n_d(t)$, in its sensory neighborhood. This neighborhood consists of the three basal epidermal sites $\\{(x-1, N_e-1), (x, N_e-1), (x+1, N_e-1)\\}$, with x-coordinates clamped to the lattice boundaries $\\{0, \\dots, N-1\\}$. The DC becomes activated with probability $p_{\\text{act}}(t) = 1 - e^{-\\beta n_d(t)}$, where $\\beta = 0.25$. Once activated, a DC remains activated.\n    2.  **Movement**: An activated DC attempts to migrate towards the lymphatic exit. With probability $m$ (a test parameter), it moves one step in the positive y-direction to $(x, y+1)$. If it is at the boundary $y=N-1$, this move results in its exit from the simulation. Exited DCs are removed, and the counter $E(t)$ is incremented. A resting DC performs a random jitter with probability $p_{\\text{jitter}} = 0.3$. This involves moving to a new position chosen uniformly from its $3 \\times 3$ Moore neighborhood (including its current position), with the new position clamped to remain within the dermis ($y' \\ge N_e$).\n\n-   **T Cell Recruitment and Dynamics**:\n    1.  **Recruitment**: At a single, specific time point, $t = \\tau_{\\text{sens}} = 24$, effector T cells are introduced. Their number is $N_T = \\lfloor 0.5 + k_T \\cdot E(\\tau_{\\text{sens}}) \\rfloor$, where $k_T = 0.8$ and $E(\\tau_{\\text{sens}})$ is the total count of DCs that have exited by this time. These T cells are placed at uniformly random positions in the dermis.\n    2.  **Movement**: For all $t \\ge \\tau_{\\text{sens}}$, each T cell performs a random walk. At each time step, it moves to one of its eight adjacent Moore neighbors (excluding its current position), chosen uniformly at random. The new position is clamped to the dermal boundaries.\n\n-   **Macrophage Dynamics**:\n    1.  **Activation**: For all $t \\ge \\tau_{\\text{sens}}$, any resting macrophage becomes permanently activated if at least one T cell is found within a Chebyshev distance of $1$ (i.e., in its $3 \\times 3$ Moore neighborhood). Macrophages are sessile and do not move.\n    2.  **Keratinocyte Damage**: Each activated macrophage attempts to induce damage once per time step. It selects a target keratinocyte uniformly at random from the sites $(x', y')$ where $x' \\in \\{x_M-1, x_M, x_M+1\\}$ (clamped) and $y' \\in \\{N_e-2, N_e-1\\}$, where $(x_M, y_M)$ is the macrophage's position. If the chosen keratinocyte is not already damaged, it becomes damaged with probability $p_K = \\min(1, c)$, where $c$ is a test parameter.\n\n**4. Output Calculation**\n\nAfter the final time step $t=T_{\\text{end}}-1=71$, the simulation terminates. The final lesion size $L$ is calculated as the total number of damaged keratinocytes:\n$$L = \\sum_{y=0}^{N_e-1} \\sum_{x=0}^{N-1} K(y,x,T_{\\text{end}})$$\nThis process is repeated for each test case, and the resulting integer lesion sizes are reported.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nimport math\nimport itertools\n\nclass ContactHypersensitivitySim:\n    \"\"\"\n    Implements a discrete-time, 2D agent-based model of contact hypersensitivity.\n    \"\"\"\n\n    def __init__(self, d, m, c, seed):\n        # Test case parameters\n        self.d = d\n        self.m = m\n        self.c = c\n        self.seed = seed\n        self.rng = np.random.default_rng(self.seed)\n\n        # Model constants\n        self.N = 20\n        self.N_e = self.N // 2\n        self.T_end = 72\n        self.tau_sens = 24\n        self.alpha = 0.5\n        self.beta = 0.25\n        self.p_jitter = 0.3\n        self.k_T = 0.8\n        self.N_DC = 40\n        self.N_M = 60\n        self.p_K = min(1.0, self.c)\n\n        # Agent state storage\n        self.K = np.zeros((self.N_e, self.N), dtype=np.int8)\n        self.dc_agents = []\n        self.mac_agents = []\n        self.t_cell_agents = []\n        self.E = 0  # Cumulative exited DC count\n\n        # Pre-calculated offsets for Moore neighborhoods\n        self.moore_offsets_8 = np.array([p for p in itertools.product([-1, 0, 1], repeat=2) if p != (0, 0)])\n        self.moore_offsets_9 = np.array(list(itertools.product([-1, 0, 1], repeat=2)))\n\n    def run_simulation(self):\n        \"\"\"Initializes and runs the full simulation, returning the final lesion size.\"\"\"\n        self._initialize_state()\n        for t in range(self.T_end):\n            self._tick(t)\n        return int(np.sum(self.K))\n\n    def _initialize_state(self):\n        \"\"\"Sets up the initial state of the simulation at t=0.\"\"\"\n        # 1. Initial keratinocyte damage\n        x_c, y_c = self.N // 2, self.N_e // 2\n        R_d = 2 + math.floor(self.d)\n        p0_d = 1.0 - math.exp(-self.alpha * self.d)\n\n        if self.d > 0:\n            for y in range(self.N_e):\n                for x in range(self.N):\n                    dist = math.sqrt((x - x_c)**2 + (y - y_c)**2)\n                    if dist = R_d:\n                        if self.rng.random()  p0_d:\n                            self.K[y, x] = 1\n\n        # 2. Initial DC population\n        xs_dc = self.rng.integers(0, self.N, size=self.N_DC)\n        ys_dc = self.rng.integers(self.N_e, self.N_e + 3, size=self.N_DC)\n        self.dc_agents = [{'pos': (xs_dc[i], ys_dc[i]), 'state': 'resting'} for i in range(self.N_DC)]\n\n        # 3. Initial macrophage population\n        xs_m = self.rng.integers(0, self.N, size=self.N_M)\n        ys_m = self.rng.integers(self.N_e, self.N, size=self.N_M)\n        self.mac_agents = [{'pos': (xs_m[i], ys_m[i]), 'state': 'resting'} for i in range(self.N_M)]\n\n    def _tick(self, t):\n        \"\"\"Executes a single time step of the simulation.\"\"\"\n        self._update_dcs()\n        self._recruit_t_cells(t)\n        self._update_t_cells_and_macrophages(t)\n\n    def _update_dcs(self):\n        \"\"\"Updates the state and position of all dendritic cells.\"\"\"\n        next_dc_agents = []\n        exited_this_step = 0\n\n        for dc in self.dc_agents:\n            pos = dc['pos']\n            current_state = dc['state']\n            is_activated = (current_state == 'activated')\n\n            if not is_activated:\n                # Check for activation\n                x_dc, _ = pos\n                n_d = 0\n                for dx in [-1, 0, 1]:\n                    x_contact = np.clip(x_dc + dx, 0, self.N - 1)\n                    if self.K[self.N_e - 1, x_contact] == 1:\n                        n_d += 1\n                \n                p_act = 1.0 - math.exp(-self.beta * n_d) if n_d > 0 else 0.0\n                if self.rng.random()  p_act:\n                    is_activated = True\n\n            # Movement logic\n            if is_activated:\n                if self.rng.random()  self.m:\n                    if pos[1] == self.N - 1:\n                        exited_this_step += 1\n                        continue  # DC exits and is removed\n                    else:\n                        pos = (pos[0], pos[1] + 1)\n            else:  # Resting DC jitter\n                if self.rng.random()  self.p_jitter:\n                    offset_idx = self.rng.integers(0, len(self.moore_offsets_9))\n                    offset = self.moore_offsets_9[offset_idx]\n                    new_x = np.clip(pos[0] + offset[0], 0, self.N - 1)\n                    new_y = np.clip(pos[1] + offset[1], self.N_e, self.N - 1)\n                    pos = (new_x, new_y)\n\n            next_dc_agents.append({'pos': pos, 'state': 'activated' if is_activated else 'resting'})\n\n        self.dc_agents = next_dc_agents\n        self.E += exited_this_step\n\n    def _recruit_t_cells(self, t):\n        \"\"\"Introduces T cells at the sensitization time.\"\"\"\n        if t == self.tau_sens:\n            n_t = math.floor(0.5 + self.k_T * self.E)\n            if n_t > 0:\n                xs_t = self.rng.integers(0, self.N, size=n_t)\n                ys_t = self.rng.integers(self.N_e, self.N, size=n_t)\n                self.t_cell_agents = [{'pos': (xs_t[i], ys_t[i])} for i in range(n_t)]\n\n    def _update_t_cells_and_macrophages(self, t):\n        \"\"\"Updates T-cell positions, macrophage activation, and macrophage-mediated damage.\"\"\"\n        if t  self.tau_sens or not self.t_cell_agents:\n            return\n\n        # Update T-cell positions\n        for tc in self.t_cell_agents:\n            offset_idx = self.rng.integers(0, len(self.moore_offsets_9))\n            offset = self.moore_offsets_9[offset_idx]\n            new_x = np.clip(tc['pos'][0] + offset[0], 0, self.N - 1)\n            new_y = np.clip(tc['pos'][1] + offset[1], self.N_e, self.N - 1)\n            tc['pos'] = (new_x, new_y)\n        \n        t_cell_locs = {tc['pos'] for tc in self.t_cell_agents}\n\n        # Update macrophages and damage\n        for mac in self.mac_agents:\n            # Activation\n            if mac['state'] == 'resting':\n                mac_x, mac_y = mac['pos']\n                for dx in [-1, 0, 1]:\n                    for dy in [-1, 0, 1]:\n                        neighbor_pos = (mac_x + dx, mac_y + dy)\n                        if neighbor_pos in t_cell_locs:\n                            mac['state'] = 'activated'\n                            break\n                    if mac['state'] == 'activated':\n                        break\n\n            # Damage amplification\n            if mac['state'] == 'activated':\n                mac_x, _ = mac['pos']\n                \n                # Determine valid targets\n                valid_x = [x for x in range(mac_x - 1, mac_x + 2) if 0 = x  self.N]\n                valid_y = [y for y in range(self.N_e - 2, self.N_e) if 0 = y  self.N_e]\n                target_choices = list(itertools.product(valid_x, valid_y))\n                \n                target_idx = self.rng.integers(0, len(target_choices))\n                target_x, target_y = target_choices[target_idx]\n\n                if self.K[target_y, target_x] == 0:\n                    if self.rng.random()  self.p_K:\n                        self.K[target_y, target_x] = 1\n\ndef solve():\n    \"\"\"\n    Runs the simulation for all specified test cases and prints the final results.\n    \"\"\"\n    test_cases = [\n        (1.5, 0.6, 0.4),  # Case 0\n        (0.0, 0.8, 0.7),  # Case 1\n        (3.0, 0.9, 0.9),  # Case 2\n        (1.5, 0.1, 0.9),  # Case 3\n    ]\n\n    results = []\n    for i, (d, m, c) in enumerate(test_cases):\n        seed = 12345 + i\n        sim = ContactHypersensitivitySim(d, m, c, seed)\n        lesion_size = sim.run_simulation()\n        results.append(lesion_size)\n\n    # Format the final output string exactly as required\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == '__main__':\n    solve()\n```", "id": "2904755"}]}