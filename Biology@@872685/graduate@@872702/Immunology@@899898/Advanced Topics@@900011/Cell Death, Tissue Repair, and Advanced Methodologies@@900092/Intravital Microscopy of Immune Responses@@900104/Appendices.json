{"hands_on_practices": [{"introduction": "A successful multicolor intravital microscopy experiment begins with careful planning of the fluorescent probes and detection channels. Because the emission spectra of fluorophores often overlap, signal from one reporter can \"bleed through\" into the detection channel intended for another, complicating analysis. This exercise guides you through the process of quantitatively modeling and predicting this spectral crosstalk, providing a foundational skill for designing robust multiplex imaging experiments and for understanding the principles behind spectral unmixing. [@problem_id:2863799]", "problem": "You are modeling fluorescence channel cross-talk in intravital microscopy of immune responses, where multiple fluorophores are imaged simultaneously through distinct detection channels. Assume a linear, wavelength-resolved photon detection model with a flat detector quantum efficiency. For each fluorophore, the probability density of emitted photon wavelength is described by a normalized Gaussian emission spectrum, and each detection channel is described by an ideal rectangular (top-hat) bandpass filter with constant transmission amplitude within its passband and zero transmission outside. Your task is to compute spectral overlap integrals and then derive and numerically evaluate bleed-through fractions between two fluorophores under several specified scenarios.\n\nFoundational starting points and definitions:\n- Let the emission spectrum of fluorophore $i \\in \\{1,2\\}$ be $E_i(\\lambda)$, a normalized Gaussian probability density over wavelength $\\lambda$ (in nanometers), with mean $\\mu_i$ and standard deviation $\\sigma_i$, given by\n$$\nE_i(\\lambda) = \\frac{1}{\\sigma_i \\sqrt{2\\pi}} \\exp\\!\\left(-\\frac{(\\lambda - \\mu_i)^2}{2\\sigma_i^2}\\right).\n$$\n- Let the transmission of detection channel $j \\in \\{1,2\\}$ be $T_j(\\lambda)$, an ideal rectangular bandpass defined by lower and upper cutoffs $a_j$ and $b_j$ (in nanometers) and a constant in-band transmission amplitude $\\tau_j \\in [0,1]$, namely\n$$\nT_j(\\lambda) =\n\\begin{cases}\n\\tau_j, & \\text{if } a_j \\le \\lambda \\le b_j,\\\\\n0, & \\text{otherwise.}\n\\end{cases}\n$$\n- The spectral overlap integral between fluorophore $i$ and channel $j$ is\n$$\nS_{ij} = \\int_{\\lambda_{\\min}}^{\\lambda_{\\max}} E_i(\\lambda)\\, T_j(\\lambda)\\, d\\lambda,\n$$\nwhere $\\lambda_{\\min}$ and $\\lambda_{\\max}$ define the instrument-relevant wavelength bounds. Use $\\lambda_{\\min} = 350\\,\\mathrm{nm}$ and $\\lambda_{\\max} = 800\\,\\mathrm{nm}$.\n- The bleed-through fraction of fluorophore $i$ into channel $j$ relative to its own main channel $i$ is defined as\n$$\nb_{ij} = \\frac{S_{ij}}{S_{ii}}, \\quad \\text{for } i \\ne j.\n$$\n- All integrals must be numerically evaluated using the trapezoidal rule on a uniform wavelength grid with step $\\Delta \\lambda = 0.1\\,\\mathrm{nm}$, from $\\lambda_{\\min}$ to $\\lambda_{\\max}$ inclusive. The detector quantum efficiency is flat and can be taken as unity, so it does not explicitly appear in the formulas.\n\nFor each test case below, compute the two bleed-through fractions $b_{12}$ and $b_{21}$ using the above definitions and numerical prescription. Report each value as a decimal rounded to six digits after the decimal point.\n\nTest suite (four cases), each specified by the tuple\n$(\\mu_1,\\sigma_1,\\mu_2,\\sigma_2,a_1,b_1,\\tau_1,a_2,b_2,\\tau_2)$ with all wavelengths in nanometers and transmissions unitless:\n1. Case A (well-separated spectra):\n   - $(520, 20, 600, 25, 500, 550, 1.0, 580, 650, 1.0)$\n2. Case B (strongly overlapping spectra):\n   - $(530, 30, 560, 30, 520, 580, 1.0, 540, 600, 1.0)$\n3. Case C (essentially non-overlapping spectra and filters):\n   - $(450, 10, 700, 10, 430, 470, 1.0, 680, 720, 1.0)$\n4. Case D (partially transmitting filters with unequal bands):\n   - $(510, 15, 540, 18, 500, 520, 0.6, 530, 560, 0.4)$\n\nInstructions and output requirements:\n- Implement the numerical evaluation exactly as specified: trapezoidal rule with uniform grid step $\\Delta \\lambda = 0.1\\,\\mathrm{nm}$ over $[350\\,\\mathrm{nm}, 800\\,\\mathrm{nm}]$.\n- For each case, compute $b_{12}$ and $b_{21}$ as defined above.\n- The final program output must be a single line containing a Python-style list of eight floating-point numbers corresponding to $[b_{12}^{(A)}, b_{21}^{(A)}, b_{12}^{(B)}, b_{21}^{(B)}, b_{12}^{(C)}, b_{21}^{(C)}, b_{12}^{(D)}, b_{21}^{(D)}]$, where each entry is rounded to six digits after the decimal point.\n- All reported quantities are dimensionless fractions and must be expressed as decimals (no percentage sign).\n\nDesign coverage rationale:\n- Case A tests a typical multiplex design with limited tail overlap.\n- Case B probes substantial spectral overlap.\n- Case C probes near-boundary behavior with negligible overlap.\n- Case D probes partial transmission and unequal band definitions.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[0.012345,0.067890, ... ]\").", "solution": "We begin from first principles for photon detection in fluorescence microscopy under conditions relevant to intravital imaging. The number of detected photons in a channel is proportional to the spectral emission probability density of the fluorophore, the instrument spectral transmission, and the detector quantum efficiency. With a flat detector quantum efficiency assumed to be unity and a linear response, the expected detected fraction from fluorophore $i$ in channel $j$ is proportional to the wavelength integral of the product $E_i(\\lambda) T_j(\\lambda)$ over the instrument-relevant spectral domain.\n\nFoundational definitions used:\n1. The emission spectrum $E_i(\\lambda)$ is modeled as a normalized Gaussian,\n$$\nE_i(\\lambda) = \\frac{1}{\\sigma_i \\sqrt{2\\pi}} \\exp\\!\\left(-\\frac{(\\lambda - \\mu_i)^2}{2\\sigma_i^2}\\right),\n$$\nwith parameters $\\mu_i$ and $\\sigma_i$ given for each fluorophore $i \\in \\{1,2\\}$. This represents a probability density over wavelength and integrates to $1$ over $\\lambda \\in (-\\infty, \\infty)$, which is physically plausible for a single emission band and does not require additional arbitrary scaling when computing fractions.\n\n2. The detection channel $j \\in \\{1,2\\}$ is an ideal rectangular bandpass filter,\n$$\nT_j(\\lambda) =\n\\begin{cases}\n\\tau_j, & \\text{if } a_j \\le \\lambda \\le b_j,\\\\\n0, & \\text{otherwise,}\n\\end{cases}\n$$\nwhere $a_j$ and $b_j$ are the cut-on and cut-off wavelengths and $\\tau_j$ is the in-band transmission amplitude.\n\n3. The spectral overlap integral is\n$$\nS_{ij} = \\int_{\\lambda_{\\min}}^{\\lambda_{\\max}} E_i(\\lambda)\\, T_j(\\lambda)\\, d\\lambda,\n$$\nwith $\\lambda_{\\min} = 350\\,\\mathrm{nm}$ and $\\lambda_{\\max} = 800\\,\\mathrm{nm}$. Because $E_i(\\lambda)$ is negligible outside the visible/near-infrared bands, truncating the integral to this finite interval is a well-tested approximation.\n\n4. The bleed-through fraction of fluorophore $i$ into the non-home channel $j$ relative to its own home channel $i$ is defined as\n$$\nb_{ij} = \\frac{S_{ij}}{S_{ii}}, \\quad i \\ne j.\n$$\nThis ratio is dimensionless and interpretable as the fraction of the fluorophore’s own detected signal that would erroneously appear in the other channel under identical excitation and detector conditions.\n\nAlgorithmic realization:\n- Construct a uniform wavelength grid $\\{\\lambda_k\\}_{k=0}^{K}$ on $[350, 800]$ with step $\\Delta \\lambda = 0.1$. This yields $K = \\frac{800 - 350}{0.1} = 4500$ intervals and $4501$ grid points.\n- For each fluorophore $i$, evaluate $E_i(\\lambda_k)$ at each grid point using the Gaussian formula. This is numerically stable because $\\sigma_i$ and $\\mu_i$ are within realistic spectral ranges.\n- For each channel $j$, construct $T_j(\\lambda_k)$ as $\\tau_j$ for $a_j \\le \\lambda_k \\le b_j$ and $0$ otherwise.\n- Compute the overlap integrals $S_{ij}$ via the trapezoidal rule:\n$$\nS_{ij} \\approx \\sum_{k=0}^{K-1} \\frac{E_i(\\lambda_k) T_j(\\lambda_k) + E_i(\\lambda_{k+1}) T_j(\\lambda_{k+1})}{2} \\Delta \\lambda.\n$$\n- Compute bleed-through fractions $b_{12} = \\frac{S_{12}}{S_{11}}$ and $b_{21} = \\frac{S_{21}}{S_{22}}$ for each test case.\n\nScientific realism:\n- The Gaussian model is a standard approximation for emission bands of fluorophores used in intravital microscopy.\n- Rectangular filters approximate common bandpass filters; partial transmission $\\tau_j \\le 1$ models less-than-unity in-band throughput.\n- The linear model and flat quantum efficiency approximation are consistent with many practical detector configurations when one is computing relative fractions rather than absolute photon numbers.\n\nNumerical details:\n- Using $\\Delta \\lambda = 0.1\\,\\mathrm{nm}$ ensures high-resolution integration and reduces discretization error to well below $10^{-6}$ in the reported ratios for the provided cases.\n- Rounding the final $b_{ij}$ values to six decimal places yields stable, reproducible outputs.\n\nApplying the procedure to the four specified cases yields two values per case, ordered as $[b_{12}^{(A)}, b_{21}^{(A)}, b_{12}^{(B)}, b_{21}^{(B)}, b_{12}^{(C)}, b_{21}^{(C)}, b_{12}^{(D)}, b_{21}^{(D)}]$. The accompanying program implements the above algorithm exactly and prints these eight dimensionless decimals on a single line, rounded to six places.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef gaussian_emission(lmbda: np.ndarray, mu: float, sigma: float) -> np.ndarray:\n    \"\"\"\n    Normalized Gaussian emission spectrum:\n    E(lambda) = (1/(sigma*sqrt(2*pi))) * exp(-(lambda - mu)^2 / (2*sigma^2))\n    \"\"\"\n    coef = 1.0 / (sigma * np.sqrt(2.0 * np.pi))\n    return coef * np.exp(-0.5 * ((lmbda - mu) / sigma) ** 2)\n\ndef top_hat_filter(lmbda: np.ndarray, a: float, b: float, tau: float) -> np.ndarray:\n    \"\"\"\n    Ideal rectangular bandpass filter with transmission tau in [a, b], zero otherwise.\n    \"\"\"\n    mask = (lmbda >= a) & (lmbda <= b)\n    T = np.zeros_like(lmbda, dtype=float)\n    T[mask] = tau\n    return T\n\ndef spectral_overlap(E: np.ndarray, T: np.ndarray, lmbda: np.ndarray) -> float:\n    \"\"\"\n    Compute overlap integral S = \\int E(lambda) * T(lambda) d lambda by trapezoidal rule.\n    \"\"\"\n    return float(np.trapz(E * T, lmbda))\n\ndef bleedthrough_fractions(params):\n    \"\"\"\n    Given parameter tuple:\n    (mu1, sigma1, mu2, sigma2, a1, b1, tau1, a2, b2, tau2)\n    return (b12, b21)\n    \"\"\"\n    mu1, s1, mu2, s2, a1, b1, tau1, a2, b2, tau2 = params\n    # Wavelength grid\n    lmin, lmax, dl = 350.0, 800.0, 0.1\n    lmbda = np.arange(lmin, lmax + dl/2.0, dl)  # inclusive of lmax\n    \n    # Emission spectra\n    E1 = gaussian_emission(lmbda, mu1, s1)\n    E2 = gaussian_emission(lmbda, mu2, s2)\n    \n    # Filters\n    T1 = top_hat_filter(lmbda, a1, b1, tau1)\n    T2 = top_hat_filter(lmbda, a2, b2, tau2)\n    \n    # Overlaps\n    S11 = spectral_overlap(E1, T1, lmbda)\n    S12 = spectral_overlap(E1, T2, lmbda)\n    S22 = spectral_overlap(E2, T2, lmbda)\n    S21 = spectral_overlap(E2, T1, lmbda)\n    \n    # Avoid division by zero by defining bleed-through as 0.0 if home channel integral is zero.\n    b12 = 0.0 if S11 == 0.0 else (S12 / S11)\n    b21 = 0.0 if S22 == 0.0 else (S21 / S22)\n    return b12, b21\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each tuple: (mu1, sigma1, mu2, sigma2, a1, b1, tau1, a2, b2, tau2)\n    test_cases = [\n        (520.0, 20.0, 600.0, 25.0, 500.0, 550.0, 1.0, 580.0, 650.0, 1.0),  # Case A\n        (530.0, 30.0, 560.0, 30.0, 520.0, 580.0, 1.0, 540.0, 600.0, 1.0),  # Case B\n        (450.0, 10.0, 700.0, 10.0, 430.0, 470.0, 1.0, 680.0, 720.0, 1.0),  # Case C\n        (510.0, 15.0, 540.0, 18.0, 500.0, 520.0, 0.6, 530.0, 560.0, 0.4),  # Case D\n    ]\n\n    results = []\n    for case in test_cases:\n        b12, b21 = bleedthrough_fractions(case)\n        # Round to six decimal places as required\n        results.append(f\"{b12:.6f}\")\n        results.append(f\"{b21:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "2863799"}, {"introduction": "Every intravital imaging experiment involves a critical trade-off between acquiring a strong signal and preserving the health of the biological sample. High laser power improves signal-to-noise but accelerates phototoxicity and photobleaching, while frame rate determines the balance between temporal resolution and per-frame signal. This practice challenges you to formalize this trade-off by constructing and solving an optimization problem, helping you develop a rigorous framework for choosing imaging parameters that maximize useful information while minimizing damage to the cells under observation. [@problem_id:2863817]", "problem": "You are designing an intravital laser-scanning microscopy protocol to quantify immune cell motility in living tissue. The goal is to choose the frame rate and laser power to maximize an information objective while accounting for photobleaching damage. Assume the following foundational bases drawn from well-tested principles:\n\n1. Photon detection follows Poisson statistics. For a pixel integrated over an exposure time, the variance equals the mean photon count.\n2. Signal-to-Noise Ratio (SNR) in a photon shot-noise limited regime scales as the square root of the expected photon count. A common information surrogate per frame is proportional to the logarithm of one plus the expected photon count, which captures diminishing returns at high photon counts.\n3. Photobleaching damage is proportional to the cumulative photon dose, which scales with laser power times total exposure time.\n\nModel the system as follows. Let:\n- $f$ be the frame rate in Hz,\n- $P$ be the laser power in mW,\n- $T$ be the fixed total acquisition time in seconds,\n- $\\eta \\in (0,1]$ be the duty cycle (fraction of each frame contributing to exposure),\n- $\\kappa$ be a proportionality constant mapping laser power and exposure time to expected photon count (photons per mW·s), incorporating fluorophore brightness and detection efficiency,\n- $\\beta$ be the penalty coefficient that converts cumulative dose to a penalty term in the objective.\n\nFor one frame, the expected photon count per pixel is modeled as $N = \\kappa P \\tau$, where the exposure time per frame is $\\tau = \\eta / f$. The total information surrogate over the acquisition is the number of frames times the per-frame information, modeled as\n$$\nI_{\\text{total}}(f,P) = f T \\ln\\!\\left(1 + \\frac{\\kappa \\eta P}{f}\\right).\n$$\nThe photobleaching penalty is proportional to the cumulative dose $D = P \\eta T$, yielding a penalty term $\\beta D$. The objective to maximize is\n$$\nJ(f,P) = f T \\ln\\!\\left(1 + \\frac{\\kappa \\eta P}{f}\\right) - \\beta P \\eta T.\n$$\n\nConstraints:\n- Hardware and biological requirements bound $f$ and $P$ as $f_{\\min} \\le f \\le f_{\\max}$ and $P_{\\min} \\le P \\le P_{\\max}$, with $f_{\\min} > 0$ and $P_{\\min} > 0$.\n\nTask:\n- Starting from the principles above, derive the structure of the optimizer and compute the optimal $(f^\\star, P^\\star)$ that maximizes $J(f,P)$ subject to the bounds.\n- Your program must implement the derived optimizer and compute $(f^\\star, P^\\star)$ for each of the provided test cases below.\n\nImportant implementation details to respect:\n- Use the natural logarithm in all expressions.\n- Angles do not appear; no angle units are needed.\n- If any physical quantity must be reported, express frame rate in Hz and laser power in mW. Numerical outputs must be rounded to three decimal places.\n- Your program should produce a single line of output containing all results as a flat, comma-separated list enclosed in square brackets. Specifically, for $n$ test cases, output should be\n  $$\n  [f^\\star_1, P^\\star_1, f^\\star_2, P^\\star_2, \\dots, f^\\star_n, P^\\star_n],\n  $$\n  where each $f^\\star_i$ is in Hz and each $P^\\star_i$ is in mW, rounded to three decimal places.\n\nTest suite (each case gives $(T,\\eta,\\kappa,\\beta,f_{\\min},f_{\\max},P_{\\min},P_{\\max})$):\n- Case 1 (interior optimum for $P$ expected): $T = 60$ s, $\\eta = 0.8$, $\\kappa = 20$, $\\beta = \\dfrac{16}{0.8 \\cdot 9}$, $f_{\\min} = 0.5$ Hz, $f_{\\max} = 20$ Hz, $P_{\\min} = 1$ mW, $P_{\\max} = 50$ mW.\n- Case 2 (high penalty; lower power bound expected): $T = 60$ s, $\\eta = 0.8$, $\\kappa = 20$, $\\beta = 40$, $f_{\\min} = 0.5$ Hz, $f_{\\max} = 20$ Hz, $P_{\\min} = 1$ mW, $P_{\\max} = 50$ mW.\n- Case 3 (low penalty; upper power bound expected): $T = 60$ s, $\\eta = 0.8$, $\\kappa = 20$, $\\beta = 0.3$, $f_{\\min} = 0.5$ Hz, $f_{\\max} = 20$ Hz, $P_{\\min} = 1$ mW, $P_{\\max} = 50$ mW.\n\nYour program should compute and print the list $[f^\\star_1,P^\\star_1,f^\\star_2,P^\\star_2,f^\\star_3,P^\\star_3]$ with each value rounded to three decimal places. All frame rates must be interpreted in Hz and all powers in mW.", "solution": "The problem is to find the optimal frame rate $f$ and laser power $P$ that maximize the objective function $J(f, P)$ within a specified domain. The objective function is given by:\n$$\nJ(f,P) = f T \\ln\\!\\left(1 + \\frac{\\kappa \\eta P}{f}\\right) - \\beta P \\eta T\n$$\nThe optimization is subject to the constraints $f_{\\min} \\le f \\le f_{\\max}$ and $P_{\\min} \\le P \\le P_{\\max}$.\n\nThe problem is well-posed. The objective function $J(f,P)$ is continuous and differentiable on the compact domain $[f_{\\min}, f_{\\max}] \\times [P_{\\min}, P_{\\max}]$. By the Extreme Value Theorem, a maximum value is guaranteed to exist. We shall find the optimal parameters $(f^\\star, P^\\star)$ by analyzing the function's partial derivatives.\n\nThe optimization can be approached by first optimizing with respect to one variable, and then using that result to optimize with respect to the other. We will first find the optimal power $P^\\star(f)$ for an arbitrary, fixed frame rate $f$.\n\nFirst, we compute the partial derivative of $J(f,P)$ with respect to $P$:\n$$\n\\frac{\\partial J}{\\partial P} = f T \\cdot \\frac{1}{1 + \\frac{\\kappa \\eta P}{f}} \\cdot \\left(\\frac{\\kappa \\eta}{f}\\right) - \\beta \\eta T = T \\eta \\left( \\frac{\\kappa}{1 + \\frac{\\kappa \\eta P}{f}} - \\beta \\right)\n$$\nTo determine the concavity of $J(f,P)$ with respect to $P$, we examine the second partial derivative:\n$$\n\\frac{\\partial^2 J}{\\partial P^2} = T \\eta \\kappa \\cdot (-1) \\left(1 + \\frac{\\kappa \\eta P}{f}\\right)^{-2} \\cdot \\left(\\frac{\\kappa \\eta}{f}\\right) = - \\frac{T (\\kappa \\eta)^2}{f} \\left(1 + \\frac{\\kappa \\eta P}{f}\\right)^{-2}\n$$\nGiven that $T, \\kappa, \\eta, f$ are all positive constants, it is evident that $\\frac{\\partial^2 J}{\\partial P^2} < 0$ for all $P$ in the domain. This indicates that for any fixed $f$, $J(f,P)$ is a strictly concave function of $P$. The maximum with respect to $P$ is therefore unique.\n\nThe unconstrained maximum for $P$ is found by setting $\\frac{\\partial J}{\\partial P} = 0$:\n$$\nT \\eta \\left( \\frac{\\kappa}{1 + \\frac{\\kappa \\eta P}{f}} - \\beta \\right) = 0\n$$\n$$\n\\frac{\\kappa}{1 + \\frac{\\kappa \\eta P}{f}} = \\beta \\implies \\kappa = \\beta \\left(1 + \\frac{\\kappa \\eta P}{f}\\right)\n$$\nSolving for $P$ yields the unconstrained optimal power, which we denote $P_{uc}(f)$:\n$$\n\\frac{\\kappa \\eta P}{f} = \\frac{\\kappa}{\\beta} - 1 \\implies P_{uc}(f) = \\frac{f}{\\kappa \\eta} \\left(\\frac{\\kappa}{\\beta} - 1\\right)\n$$\nThis unconstrained solution is physically meaningful (i.e., $P_{uc}(f) > 0$) only if $\\kappa > \\beta$. If $\\kappa \\le \\beta$, then $\\frac{\\kappa}{\\beta} - 1 \\le 0$, which implies $P_{uc}(f) \\le 0$. In this case ($\\kappa \\le \\beta$), we have $\\frac{\\kappa}{1 + \\kappa \\eta P / f} \\le \\kappa \\le \\beta$ for any $P > 0$, which means $\\frac{\\partial J}{\\partial P} \\le 0$. Thus, $J(f, P)$ is a non-increasing function of $P$, and its maximum is achieved at the minimum possible power, $P_{\\min}$.\n\nConsidering the constraints $P_{\\min} \\le P \\le P_{\\max}$, the optimal power $P^\\star(f)$ for a fixed $f$ is obtained by clamping $P_{uc}(f)$ to the allowed interval $[P_{\\min}, P_{\\max}]$:\n$$\nP^\\star(f) = \\text{clamp}(P_{uc}(f), P_{\\min}, P_{\\max}) = \\max(P_{\\min}, \\min(P_{uc}(f), P_{\\max}))\n$$\nThis expression for $P^\\star(f)$ correctly handles all cases, including when $\\kappa \\le \\beta$.\n\nNow, we must optimize $f$ by maximizing the function $\\tilde{J}(f) = J(f, P^\\star(f))$ over the interval $[f_{\\min}, f_{\\max}]$. We analyze the derivative of $\\tilde{J}(f)$ with respect to $f$. Using the chain rule for differentiation, we have:\n$$\n\\frac{d\\tilde{J}}{df} = \\frac{\\partial J}{\\partial f} \\bigg|_{P=P^\\star(f)} + \\frac{\\partial J}{\\partial P} \\bigg|_{P=P^\\star(f)} \\frac{dP^\\star}{df}\n$$\nLet's first compute the partial derivative $\\frac{\\partial J}{\\partial f}$:\n$$\n\\frac{\\partial J}{\\partial f} = T \\ln\\left(1 + \\frac{\\kappa \\eta P}{f}\\right) + f T \\frac{1}{1 + \\frac{\\kappa \\eta P}{f}} \\left(-\\frac{\\kappa \\eta P}{f^2}\\right) = T \\left[ \\ln\\left(1 + \\frac{\\kappa \\eta P}{f}\\right) - \\frac{\\frac{\\kappa \\eta P}{f}}{1 + \\frac{\\kappa \\eta P}{f}} \\right]\n$$\nLet $x = \\frac{\\kappa \\eta P}{f}$. Since $P \\ge P_{\\min} > 0$ and all other parameters are positive, $x > 0$. The expression in the brackets becomes $g(x) = \\ln(1+x) - \\frac{x}{1+x}$. The derivative of this function is $g'(x) = \\frac{1}{1+x} - \\frac{1}{(1+x)^2} = \\frac{x}{(1+x)^2}$. For $x > 0$, $g'(x) > 0$, which means $g(x)$ is a strictly increasing function. Since $g(0)=0$, we have $g(x) > 0$ for all $x > 0$. Consequently, $\\frac{\\partial J}{\\partial f} > 0$ for all valid $f$ and $P$.\n\nWe now analyze $\\frac{d\\tilde{J}}{df}$ based on the definition of $P^\\star(f)$:\n1.  **Interior Region**: If $P_{\\min} < P_{uc}(f) < P_{\\max}$, then $P^\\star(f) = P_{uc}(f)$. By definition of $P_{uc}(f)$, this is precisely the value where $\\frac{\\partial J}{\\partial P} = 0$. Therefore, in this region, the second term of the chain rule vanishes:\n    $$\n    \\frac{d\\tilde{J}}{df} = \\frac{\\partial J}{\\partial f} \\bigg|_{P=P_{uc}(f)} + 0 = \\frac{\\partial J}{\\partial f} \\bigg|_{P=P_{uc}(f)} > 0\n    $$\n2.  **Boundary Regions**: If $P_{uc}(f) \\le P_{\\min}$ or $P_{uc}(f) \\ge P_{\\max}$, then $P^\\star(f)$ is constant, either $P_{\\min}$ or $P_{\\max}$. In these regions, $\\frac{dP^\\star}{df} = 0$. The derivative of $\\tilde{J}(f)$ is again simplified:\n    $$\n    \\frac{d\\tilde{J}}{df} = \\frac{\\partial J}{\\partial f} \\bigg|_{P=P^\\star(f)} + \\frac{\\partial J}{\\partial P} \\bigg|_{P=P^\\star(f)} \\cdot 0 = \\frac{\\partial J}{\\partial f} \\bigg|_{P=P^\\star(f)} > 0\n    $$\n\nIn all cases, we find that $\\frac{d\\tilde{J}}{df} > 0$. The function $\\tilde{J}(f)$ is continuous and its derivative is strictly positive throughout the domain $[f_{\\min}, f_{\\max}]$. This proves that $\\tilde{J}(f)$ is a strictly monotonically increasing function of $f$.\n\nTherefore, the maximum of $\\tilde{J}(f)$ must occur at the upper boundary of the domain of $f$. The optimal frame rate is $f^\\star = f_{\\max}$.\n\nThe complete algorithm for finding the optimal pair $(f^\\star, P^\\star)$ is as follows:\n1.  The optimal frame rate is the maximum allowed value: $f^\\star = f_{\\max}$.\n2.  Calculate the unconstrained optimal power at this frame rate: $P_{uc}(f_{\\max}) = \\frac{f_{\\max}}{\\kappa \\eta} \\left(\\frac{\\kappa}{\\beta} - 1\\right)$.\n3.  The optimal power $P^\\star$ is found by clamping this value to the permitted range: $P^\\star = \\max(P_{\\min}, \\min(P_{uc}(f_{\\max}), P_{\\max}))$.\n\nThis procedure provides the unique solution $(f^\\star, P^\\star)$ that maximizes the objective function $J(f, P)$.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for the optimal frame rate (f) and laser power (P) for a set of\n    intravital microscopy test cases.\n    \"\"\"\n    # Test suite: (T, eta, kappa, beta, f_min, f_max, P_min, P_max)\n    test_cases = [\n        (60, 0.8, 20, 16 / (0.8 * 9), 0.5, 20, 1, 50),\n        (60, 0.8, 20, 40, 0.5, 20, 1, 50),\n        (60, 0.8, 20, 0.3, 0.5, 20, 1, 50),\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        T, eta, kappa, beta, f_min, f_max, P_min, P_max = case\n\n        # From the derivation, the optimal frame rate f* is always f_max because\n        # the objective function J(f, P*(f)) is monotonically increasing with f.\n        f_star = f_max\n\n        # Calculate the unconstrained optimal power P_uc at f_star.\n        # This is derived by setting the partial derivative of J with respect to P to zero.\n        # P_uc = (f_star / (kappa * eta)) * (kappa / beta - 1)\n        # This formula is valid only if kappa > beta.\n        \n        if kappa > beta:\n            P_uc = (f_star / (kappa * eta)) * (kappa / beta - 1)\n        else:\n            # If kappa <= beta, the derivative dJ/dP is non-positive for P > 0,\n            # meaning J is a non-increasing function of P. The optimum is at the\n            # lowest possible power, P_min. Setting P_uc to a value less than\n            # or equal to P_min will achieve this with the clamping logic.\n            P_uc = P_min - 1 # Any value <= P_min will result in P_star = P_min\n\n        # The optimal power P* is the unconstrained optimum clamped to the\n        # allowed power range [P_min, P_max].\n        P_star = np.clip(P_uc, P_min, P_max)\n\n        results.append(f_star)\n        results.append(P_star)\n\n    # Format the results into the required string format:\n    # [f_1, P_1, f_2, P_2, ...], with each value rounded to three decimal places.\n    formatted_results = [f\"{val:.3f}\" for val in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "2863817"}, {"introduction": "After acquiring time-lapse images, the next step is often to track cell movement and quantify dynamics like velocity. However, every position measurement is subject to fundamental physical limitations, including diffraction and photon shot noise, which introduce localization uncertainty. This practice will guide you through deriving how these sources of error propagate into your final velocity calculations, a crucial step for correctly interpreting tracking data and distinguishing genuine biological movement from measurement noise. [@problem_id:2863810]", "problem": "You are imaging motile T cells in a mouse lymph node using two-photon intravital microscopy and estimating cell velocities from frame-to-frame displacements measured by centroid localization of a bright fluorescent spot. Assume the lateral point spread function (PSF) is well approximated by a Gaussian with standard deviation $s$, and $N$ detected photons per frame are independently and identically distributed draws from this PSF centered on the true emitter location. The camera has square pixels of width $a$, and the pixelation can be modeled as a uniform quantization of the photon landing position within a pixel. Frames are acquired at times $t$ and $t+\\Delta t$, and the velocity estimator is the finite difference $v_{x} = \\left(x_{t+\\Delta t} - x_{t}\\right)/\\Delta t$ along one lateral axis. Ignore background, motion blur, and any correlation between frames; treat $N$ as fixed and equal to its mean, and assume that localization errors are independent between frames and across the two error sources (photon shot noise and pixelation).\n\nStarting from the following fundamental bases:\n- In Poisson detection with independent photon arrivals drawn from a distribution of variance $s^{2}$, the variance of the sample mean (centroid) over $N$ samples is $s^{2}/N$.\n- The variance of a continuous uniform distribution on an interval of width $a$ is $a^{2}/12$.\n- For independent error sources, variances add; for a scaled random variable $cX$, $\\mathrm{Var}(cX) = c^{2}\\mathrm{Var}(X)$; for independent $X$ and $Y$, $\\mathrm{Var}(X-Y) = \\mathrm{Var}(X) + \\mathrm{Var}(Y)$.\n\nDerive an expression for the standard deviation of $v_{x}$ due to localization uncertainty and compute its numerical value for\n$s = 0.25\\,\\mu\\mathrm{m}$, $a = 0.13\\,\\mu\\mathrm{m}$, $N = 1200$, and $\\Delta t = 3\\,\\mathrm{s}$. Express the final uncertainty as a standard deviation in $\\mu\\mathrm{m}/\\mathrm{min}$ and round your answer to three significant figures.", "solution": "The problem as stated is scientifically grounded, formally coherent, and provides all necessary information for a unique solution. The model is a standard simplification used in biophysical image analysis. We may therefore proceed with the derivation.\n\nThe velocity along the $x$-axis, $v_x$, is estimated using a finite difference from two position measurements, $x_t$ and $x_{t+\\Delta t}$, separated by a time interval $\\Delta t$. The estimator is given by:\n$$\nv_{x} = \\frac{x_{t+\\Delta t} - x_{t}}{\\Delta t}\n$$\nThe uncertainty in this velocity estimate, represented by its standard deviation $\\sigma_{v_x}$, arises from the uncertainties in the position measurements. The variance of $v_x$, denoted $\\sigma_{v_x}^2$, is related to the variance of the position measurements through standard error propagation rules. Using the rule $\\mathrm{Var}(cX) = c^2 \\mathrm{Var}(X)$, where $c$ is a constant, we have:\n$$\n\\sigma_{v_x}^2 = \\mathrm{Var}\\left(\\frac{x_{t+\\Delta t} - x_{t}}{\\Delta t}\\right) = \\frac{1}{(\\Delta t)^2} \\mathrm{Var}(x_{t+\\Delta t} - x_t)\n$$\nThe problem specifies that the localization errors are independent between frames. Let $\\sigma_x^2$ be the variance of a single position measurement. Since the measurement conditions are identical at time $t$ and $t+\\Delta t$, we have $\\mathrm{Var}(x_t) = \\mathrm{Var}(x_{t+\\Delta t}) = \\sigma_x^2$. For independent random variables $X$ and $Y$, the variance of their difference is the sum of their variances: $\\mathrm{Var}(X-Y) = \\mathrm{Var}(X) + \\mathrm{Var}(Y)$. Applying this to our position measurements:\n$$\n\\mathrm{Var}(x_{t+\\Delta t} - x_t) = \\mathrm{Var}(x_{t+\\Delta t}) + \\mathrm{Var}(x_t) = \\sigma_x^2 + \\sigma_x^2 = 2\\sigma_x^2\n$$\nSubstituting this result into the expression for $\\sigma_{v_x}^2$:\n$$\n\\sigma_{v_x}^2 = \\frac{2\\sigma_x^2}{(\\Delta t)^2}\n$$\nThe standard deviation of the velocity estimate is the square root of the variance:\n$$\n\\sigma_{v_x} = \\sqrt{\\frac{2\\sigma_x^2}{(\\Delta t)^2}} = \\frac{\\sqrt{2}\\,\\sigma_x}{\\Delta t}\n$$\nNext, we must determine the single-frame localization variance, $\\sigma_x^2$. The problem defines two independent sources of error: photon shot noise from the finite number of detected photons, and pixelation noise from the quantization of the photon's position by the camera pixels. Since these error sources are independent, their variances add:\n$$\n\\sigma_x^2 = \\sigma_{\\text{photon}}^2 + \\sigma_{\\text{pixel}}^2\n$$\nThe problem provides the expressions for each of these variance components. The variance in the centroid position due to photon shot noise for $N$ photons drawn from a distribution with variance $s^2$ is:\n$$\n\\sigma_{\\text{photon}}^2 = \\frac{s^2}{N}\n$$\nThe variance due to pixelation, modeled as a uniform distribution over an interval of width $a$, is:\n$$\n\\sigma_{\\text{pixel}}^2 = \\frac{a^2}{12}\n$$\nCombining these gives the total single-frame localization variance:\n$$\n\\sigma_x^2 = \\frac{s^2}{N} + \\frac{a^2}{12}\n$$\nSubstituting this back into our expression for $\\sigma_{v_x}$ yields the final analytical expression for the standard deviation of the velocity estimate:\n$$\n\\sigma_{v_x} = \\frac{\\sqrt{2}}{\\Delta t} \\sqrt{\\frac{s^2}{N} + \\frac{a^2}{12}}\n$$\nWe are now required to compute the numerical value using the provided data: $s = 0.25\\,\\mu\\mathrm{m}$, $a = 0.13\\,\\mu\\mathrm{m}$, $N = 1200$, and $\\Delta t = 3\\,\\mathrm{s}$. All length units are in micrometers ($\\mu\\mathrm{m}$) and time is in seconds ($\\mathrm{s}$).\n\nFirst, calculate the single-frame localization variance $\\sigma_x^2$:\n$$\n\\sigma_x^2 = \\frac{(0.25\\,\\mu\\mathrm{m})^2}{1200} + \\frac{(0.13\\,\\mu\\mathrm{m})^2}{12}\n$$\n$$\n\\sigma_x^2 = \\frac{0.0625}{1200}\\,\\mu\\mathrm{m}^2 + \\frac{0.0169}{12}\\,\\mu\\mathrm{m}^2\n$$\n$$\n\\sigma_x^2 \\approx (5.2083 \\times 10^{-5})\\,\\mu\\mathrm{m}^2 + (1.4083 \\times 10^{-3})\\,\\mu\\mathrm{m}^2\n$$\n$$\n\\sigma_x^2 \\approx 1.460416 \\times 10^{-3}\\,\\mu\\mathrm{m}^2\n$$\nNow, substitute this value into the expression for $\\sigma_{v_x}$:\n$$\n\\sigma_{v_x} = \\frac{\\sqrt{2}}{3\\,\\mathrm{s}} \\sqrt{1.460416 \\times 10^{-3}\\,\\mu\\mathrm{m}^2}\n$$\n$$\n\\sigma_{v_x} \\approx \\frac{1.4142}{3\\,\\mathrm{s}} (0.038215\\,\\mu\\mathrm{m})\n$$\n$$\n\\sigma_{v_x} \\approx 0.018016\\,\\frac{\\mu\\mathrm{m}}{\\mathrm{s}}\n$$\nThe problem requires the final answer in units of $\\mu\\mathrm{m}/\\mathrm{min}$. We perform the unit conversion using the relationship $1\\,\\mathrm{min} = 60\\,\\mathrm{s}$:\n$$\n\\sigma_{v_x} \\approx 0.018016\\,\\frac{\\mu\\mathrm{m}}{\\mathrm{s}} \\times \\frac{60\\,\\mathrm{s}}{1\\,\\mathrm{min}} \\approx 1.08096\\,\\frac{\\mu\\mathrm{m}}{\\mathrm{min}}\n$$\nRounding the result to three significant figures, we obtain the final value for the standard deviation of the velocity estimate.\n$$\n\\sigma_{v_x} \\approx 1.08\\,\\frac{\\mu\\mathrm{m}}{\\mathrm{min}}\n$$", "answer": "$$\n\\boxed{1.08}\n$$", "id": "2863810"}]}