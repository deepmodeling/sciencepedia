{"hands_on_practices": [{"introduction": "This first exercise provides a foundational workout in the algebra of quantitative genetics. By applying the core principles of variance decomposition, you will calculate narrow-sense heritability ($h^2$), a cornerstone concept for predicting a population's response to selection. This practice also illuminates a critical insight: heritability is not an immutable property of a trait but is highly sensitive to environmental context, as you will demonstrate by recalculating $h^2$ under increased environmental heterogeneity [@problem_id:2751927].", "problem": "A quantitative trait is measured in a macro-environment that is held as uniform as possible, but there is measurable micro-environmental heterogeneity. Under this setting, the estimated phenotypic variance is $V_P=10$, the additive genetic variance is $V_A=3$, and the genotype-by-environment interaction variance is $V_{G \\times E}=2$. Assume that dominance and epistatic genetic variances are negligible, and the covariance between genotype and environment is negligible, so that no additional variance components contribute to $V_P$ beyond those stated. \n\nUsing only foundational definitions from quantitative genetics about variance decomposition and narrow-sense heritability, determine the narrow-sense heritability $h^{2}$ for the baseline setting. Then suppose that environmental heterogeneity increases such that the environmental variance $V_{E}$ increases by $50$ percent, while $V_{A}$ and $V_{G\\times E}$ remain unchanged. Determine the new $h^{2}$ under this more heterogeneous environment.\n\nExpress both answers as exact fractions without rounding. Provide your final result as two entries in a single row matrix, ordered as baseline followed by increased heterogeneity, with no units.", "solution": "The problem requires the calculation of narrow-sense heritability, $h^{2}$, under two different environmental conditions. We begin by stating the foundational principles of quantitative genetics concerning the partitioning of phenotypic variance.\n\nFirst, the problem statement must be validated.\nThe givens are:\n- Baseline total phenotypic variance: $V_{P} = 10$\n- Additive genetic variance: $V_{A} = 3$\n- Genotype-by-environment interaction variance: $V_{G \\times E} = 2$\n- Assumptions: Dominance variance ($V_{D}$) and epistatic variance ($V_{I}$) are negligible. The covariance between genotype and environment ($\\text{Cov}(G, E)$) is negligible.\n- Condition for second scenario: Environmental variance ($V_{E}$) increases by $50$ percent. $V_{A}$ and $V_{G \\times E}$ remain unchanged.\n\nThe problem is scientifically grounded in the principles of quantitative genetics, specifically the decomposition of phenotypic variance and the definition of heritability. It is well-posed, objective, and self-contained, providing all necessary data and simplifying assumptions to arrive at a unique solution. The data are numerically consistent and plausible for a theoretical model. Therefore, the problem is valid and we may proceed with the solution.\n\nThe total phenotypic variance, $V_P$, of a quantitative trait is decomposed into its causal components. The comprehensive model is:\n$$V_P = V_G + V_E + V_{G \\times E} + 2 \\text{Cov}(G, E)$$\nwhere $V_G$ is the genetic variance, $V_E$ is the environmental variance, $V_{G \\times E}$ is the variance due to genotype-by-environment interactions, and $\\text{Cov}(G, E)$ is the covariance between genetic and environmental effects. The genetic variance itself is a sum: $V_G = V_A + V_D + V_I$, where $V_A$ is additive, $V_D$ is dominance, and $V_I$ is epistatic variance.\n\nThe problem statement provides constraints that simplify this model. The negligibility of dominance and epistatic variance means $V_G \\approx V_A$. The negligibility of genotype-environment covariance means $2 \\text{Cov}(G, E) \\approx 0$. Thus, the governing equation for this problem becomes:\n$$V_P = V_A + V_E + V_{G \\times E}$$\nNarrow-sense heritability, $h^{2}$, is defined as the proportion of total phenotypic variance that is due to additive genetic variance:\n$$h^{2} = \\frac{V_A}{V_P}$$\nWe will now solve for $h^{2}$ under both specified conditions.\n\nPart 1: Baseline heritability.\nThe problem provides the necessary values for the baseline setting directly:\n- $V_A = 3$\n- $V_P = 10$ (which we will denote $V_{P,1}$ for clarity)\n\nThe baseline narrow-sense heritability, $h_1^{2}$, is therefore:\n$$h_1^{2} = \\frac{V_A}{V_{P,1}} = \\frac{3}{10}$$\nTo prepare for the second part, we must determine the baseline environmental variance, $V_{E,1}$. Using our simplified variance equation:\n$$V_{P,1} = V_A + V_{E,1} + V_{G \\times E}$$\nSubstituting the given values:\n$$10 = 3 + V_{E,1} + 2$$\n$$10 = 5 + V_{E,1}$$\nSolving for $V_{E,1}$ yields:\n$$V_{E,1} = 10 - 5 = 5$$\n\nPart 2: Heritability under increased environmental heterogeneity.\nThe problem states that the environmental variance increases by $50$ percent. The new environmental variance, $V_{E,2}$, is calculated as:\n$$V_{E,2} = V_{E,1} + (0.50 \\times V_{E,1}) = 1.5 \\times V_{E,1}$$\n$$V_{E,2} = 1.5 \\times 5 = 7.5$$\nThe additive genetic variance and the G×E variance remain unchanged, as per the problem statement: $V_A = 3$ and $V_{G \\times E} = 2$.\n\nThe new total phenotypic variance, $V_{P,2}$, is the sum of the updated components:\n$$V_{P,2} = V_A + V_{E,2} + V_{G \\times E}$$\n$$V_{P,2} = 3 + 7.5 + 2 = 12.5$$\nThe new narrow-sense heritability, $h_2^{2}$, is calculated using this new total phenotypic variance:\n$$h_2^{2} = \\frac{V_A}{V_{P,2}} = \\frac{3}{12.5}$$\nTo express this result as an exact fraction as required, we convert the denominator from decimal form:\n$$h_2^{2} = \\frac{3}{\\frac{25}{2}} = \\frac{3 \\times 2}{25} = \\frac{6}{25}$$\nThe two answers are the baseline heritability, $h_1^{2} = \\frac{3}{10}$, and the heritability under increased environmental heterogeneity, $h_2^{2} = \\frac{6}{25}$.", "answer": "$$\\boxed{\\begin{pmatrix} \\frac{3}{10} & \\frac{6}{25} \\end{pmatrix}}$$", "id": "2751927"}, {"introduction": "Moving from calculation to application, this practice places you in the role of an experimental biologist tasked with measuring the very components of variance we've discussed. You will evaluate several common garden experimental designs, which are classic methods for disentangling genetic and environmental effects on phenotypes. This exercise hones your ability to identify robust designs that employ critical principles like randomization, blocking, and appropriate replication to isolate genetic variance ($V_G$) and even distinguish micro-environmental variance ($V_E$) from measurement error ($V_M$) [@problem_id:2751903].", "problem": "You are planning a common garden study of a clonal aquatic plant to quantify the contribution of genetic variance ($V_G$) to variation in frond area, while minimizing environmental variance ($V_E$) and explicitly estimating measurement error variance ($V_M$). Genetic variance ($V_G$) is the component of phenotypic variance attributable to heritable genetic differences among genotypes. Environmental variance ($V_E$) is the component attributable to environmental differences among individuals. Measurement error variance ($V_M$) is the component attributable to imprecision in the measurement process. You have access to $G$ distinct genotypes maintained as clonal lines, a controlled-growth room with uniform lighting and nutrient solution, and $b$ benches (physical blocks) that can experience small microenvironmental differences. You can produce $r$ replicate individuals per genotype per bench and can take $m$ repeated measurements of frond area on each individual using the same imaging pipeline.\n\nFrom first principles in quantitative genetics and experimental design, your goal is to isolate $V_G$ by holding $V_E$ as constant as possible within a common garden, while also planning replication that allows you to quantify $V_M$ separately from residual microenvironmental variation among individuals. Assume that any macro-environmental differences between benches can be approximated by a random block effect if genotypes are randomized within each bench.\n\nWhich of the following experimental designs and analysis plans most effectively achieves these goals and is scientifically defensible for estimating $V_G$ while controlling $V_E$ and quantifying $V_M$? Choose the single best option.\n\nA. Propagate $G$ clonal genotypes. In a single controlled-growth room, implement a randomized complete block design with $b$ benches: within each bench, place $r \\ge 1$ individuals per genotype, fully randomized. Maintain identical nutrient solution and light cycle across all benches, and rotate trays daily to reduce position effects. For each individual, take $m \\ge 2$ independent, blinded image-based measurements of frond area on the same day using a calibrated imaging system. Fit a linear mixed-effects model with random effects for genotype ($G$), block ($B$), individual nested within genotype and block ($I \\mid G,B$), and a residual term representing measurement error. Use variance components to estimate $V_G$, a block component as part of $V_E$, a within-genotype among-individual component as residual $V_E$ at the microenvironmental scale, and the residual as $V_M$.\n\nB. Assign genotypes to two rooms by grouping: place all genotypes from population $1$ in room $1$ and all genotypes from population $2$ in room $2$, maintain identical conditions nominally, grow $r \\ge 3$ replicates per genotype, and take $m=1$ measurement per plant. Analyze using a fixed-effect two-way analysis of variance (ANOVA) with room and genotype as fixed factors, omitting any random effects.\n\nC. Place all replicates of each genotype together on the same bench to facilitate care (one bench per genotype), grow $r \\ge 10$ replicates per genotype, and take $m \\ge 5$ repeated measurements per plant to reduce noise. Analyze by averaging the $m$ measurements per plant and then comparing genotype means with a one-way ANOVA, ignoring bench effects.\n\nD. Establish two outdoor common gardens at sites with contrasting soils and climates to increase environmental range. Randomly assign genotypes to plots at each site, grow $r \\ge 5$ replicates per genotype per site, take $m=1$ measurement per plant, and fit a model with genotype and site as fixed effects to estimate $V_G$ across environments.\n\nE. Use seeds from $G$ half-sib families, plant siblings from each family in the same pot to standardize microenvironment, grow $r \\ge 5$ pots per family on a single bench, and take $m \\ge 2$ measurements per plant. Treat family as a random effect to estimate genetic variance and treat the residual as measurement error, omitting any block or individual-level random effects.\n\nAnswer by selecting the option that best isolates $V_G$ by controlling $V_E$ and that incorporates replication sufficient to separately quantify $V_M$, justified by variance-partitioning logic grounded in first principles of quantitative genetics and experimental design.", "solution": "The problem asks for an experimental design and analysis plan to quantify genetic variance ($V_G$) for frond area in a clonal aquatic plant, while minimizing environmental variance ($V_E$) and explicitly estimating measurement error variance ($V_M$). The validity of the problem statement must first be assessed.\n\n### Step 1: Extract Givens\n- **Objective:** Quantify genetic variance ($V_G$).\n- **Constraint 1:** Minimize environmental variance ($V_E$).\n- **Constraint 2:** Explicitly estimate measurement error variance ($V_M$).\n- **Definitions Provided:**\n    - $V_G$: Component of phenotypic variance from heritable genetic differences among genotypes.\n    - $V_E$: Component of phenotypic variance from environmental differences among individuals.\n    - $V_M$: Component of phenotypic variance from imprecision in measurement.\n- **Available Resources:**\n    - $G$ distinct clonal genotypes.\n    - A controlled-growth room with uniform lighting and nutrient solution.\n    - $b$ benches which can have small microenvironmental differences.\n- **Experimental Levers:**\n    - $r$: replicate individuals per genotype per bench.\n    - $m$: repeated measurements of frond area per individual.\n- **Assumption:** Bench differences can be treated as a random block effect with proper randomization.\n- **Task:** Select the single best option from a list of experimental designs and analysis plans.\n\n### Step 2: Validate Using Extracted Givens\n- **Scientific Grounding:** The problem is firmly grounded in the core principles of quantitative genetics and experimental design. Partitioning phenotypic variance into genetic and environmental components ($V_P = V_G + V_E + ...$) is a fundamental concept. The use of clonal organisms, common garden experiments, blocking, randomization, and replication are standard, scientifically sound methodologies for this purpose. The distinction between environmental variance ($V_E$) and measurement error ($V_M$) is also a critical and standard consideration in biological experiments. The problem is scientifically sound.\n- **Well-Posedness:** The objective is clear and the constraints are well-defined. The available resources and experimental parameters provide a concrete basis for evaluating the proposed options. A unique, best solution among the choices is expected based on established principles.\n- **Objectivity:** The problem is stated in precise, objective, technical language, free from ambiguity or subjective claims.\n\n### Step 3: Verdict and Action\nThe problem statement is scientifically sound, well-posed, and objective. It contains no logical contradictions, missing information, or other flaws that would render it invalid. I will therefore proceed to a full solution and analysis of the options.\n\n### Derivation from First Principles\nThe total phenotypic variance ($V_P$) for a measured trait can be partitioned into its sources. For this specific experimental setup, a comprehensive model of an individual measurement, $Y_{ijkl}$, on the $l$-th measurement of the $k$-th individual of the $i$-th genotype in the $j$-th block is:\n$$Y_{ijkl} = \\mu + G_i + B_j + I_{k(ij)} + M_{l(ijk)}$$\nwhere:\n- $\\mu$ is the grand mean frond area.\n- $G_i$ is the effect of the $i$-th genotype. Treating genotype as a random effect, its variance $\\sigma^2_G$ corresponds to the total genetic variance, $V_G$, because we use clones.\n- $B_j$ is the effect of the $j$-th bench (block). Its variance, $\\sigma^2_B$, is a systematic component of the environmental variance, $V_E$.\n- $I_{k(ij)}$ is the effect of the $k$-th individual, nested within the $i$-th genotype and $j$-th block. This represents the unique micro-environmental effect on that individual. Its variance, $\\sigma^2_I$, represents the residual or micro-environmental variance, another component of $V_E$. To estimate this term, replication of individuals ($r>1$) within a genotype-block combination is required.\n- $M_{l(ijk)}$ is the error associated with the $l$-th measurement on the $ijk$-th individual. Its variance, $\\sigma^2_M$, corresponds to the measurement error variance, $V_M$. To estimate this term, repeated measurements ($m>1$) on each individual are required.\n\nThe total phenotypic variance is thus partitioned as $V_P = V_G + V_{E(\\text{block})} + V_{E(\\text{residual})} + V_M$, which corresponds to $V_P = \\sigma^2_G + \\sigma^2_B + \\sigma^2_I + \\sigma^2_M$.\n\nA successful design must:\n1.  **Isolate $V_G$**: This requires randomization to avoid confounding genotype effects with environmental effects. Clonal material allows estimation of *total* $V_G$.\n2.  **Control $V_E$**: This is done by using a controlled common environment and by statistically accounting for known sources of environmental heterogeneity (e.g., benches) through blocking.\n3.  **Quantify $V_M$**: This requires $m \\ge 2$ repeated, independent measurements on each individual plant.\n\n### Option-by-Option Analysis\n\n**A. Propagate $G$ clonal genotypes. In a single controlled-growth room, implement a randomized complete block design with $b$ benches: within each bench, place $r \\ge 1$ individuals per genotype, fully randomized. Maintain identical nutrient solution and light cycle across all benches, and rotate trays daily to reduce position effects. For each individual, take $m \\ge 2$ independent, blinded image-based measurements of frond area on the same day using a calibrated imaging system. Fit a linear mixed-effects model with random effects for genotype ($G$), block ($B$), individual nested within genotype and block ($I \\mid G,B$), and a residual term representing measurement error. Use variance components to estimate $V_G$, a block component as part of $V_E$, a within-genotype among-individual component as residual $V_E$ at the microenvironmental scale, and the residual as $V_M$.**\n\nThis option is methodologically flawless.\n- **Design:** It correctly uses a randomized complete block design, which is the classical method to control for a single, known source of environmental heterogeneity (the benches). Randomizing genotypes *within* each block prevents confounding of genotype and block effects. Using clonal lines allows for estimation of total $V_G$. Using a single controlled room minimizes overall $V_E$. Setting $m \\ge 2$ allows for the explicit quantification of $V_M$. Setting $r > 1$ allows for the micro-environmental variance among individuals to also be estimated.\n- **Analysis:** The proposed linear mixed-effects model is precisely the correct tool for this structure. It correctly specifies random effects for genotype ($\\sigma^2_G \\equiv V_G$), block ($\\sigma^2_B \\subset V_E$), and individual ($\\sigma^2_I \\subset V_E$). The final residual variance in such a model with repeated measures corresponds to the within-individual variance, which is the measurement error, $V_M$. This plan achieves all stated goals.\n**Verdict: Correct**\n\n**B. Assign genotypes to two rooms by grouping: place all genotypes from population $1$ in room $1$ and all genotypes from population $2$ in room $2$, maintain identical conditions nominally, grow $r \\ge 3$ replicates per genotype, and take $m=1$ measurement per plant. Analyze using a fixed-effect two-way analysis of variance (ANOVA) with room and genotype as fixed factors, omitting any random effects.**\n\nThis option is fundamentally flawed.\n- **Design:** The design deliberately confounds genetics (population origin) with environment (room). Any observed difference between rooms is un-interpretable. This is poor experimental practice. Furthermore, setting $m=1$ makes it impossible to separate measurement error ($V_M$) from individual-level environmental variance ($V_E$).\n- **Analysis:** A fixed-effect model does not estimate variance components like $V_G$. It only tests for significant mean differences among specific, fixed levels. The goal is to estimate a population parameter, $V_G$, which requires treating genotype as a random effect.\n**Verdict: Incorrect**\n\n**C. Place all replicates of each genotype together on the same bench to facilitate care (one bench per genotype), grow $r \\ge 10$ replicates per genotype, and take $m \\ge 5$ repeated measurements per plant to reduce noise. Analyze by averaging the $m$ measurements per plant and then comparing genotype means with a one-way ANOVA, ignoring bench effects.**\n\nThis option contains critical design and analysis errors.\n- **Design:** Placing all replicates of one genotype on a single bench is a textbook example of pseudo-replication. This completely confounds the genotype effect with the bench effect. It is impossible to determine if genotype A is superior to genotype B, or if bench A is simply a better environment than bench B.\n- **Analysis:** Ignoring the bench effects in the analysis exacerbates the design flaw. Averaging the $m \\ge 5$ measurements before analysis prevents the quantification of $V_M$, which is an explicit requirement of the problem. A one-way ANOVA would misattribute the sum of true genetic variance and bench variance to the \"genotype\" factor.\n**Verdict: Incorrect**\n\n**D. Establish two outdoor common gardens at sites with contrasting soils and climates to increase environmental range. Randomly assign genotypes to plots at each site, grow $r \\ge 5$ replicates per genotype per site, take $m=1$ measurement per plant, and fit a model with genotype and site as fixed effects to estimate $V_G$ across environments.**\n\nThis option addresses a different scientific question.\n- **Design:** The stated goal is to *minimize* $V_E$. This design deliberately *maximizes* $V_E$ by using two contrasting outdoor sites. This is a design to study genotype-by-environment interactions ($V_{G \\times E}$), not to isolate $V_G$ in a controlled setting. Furthermore, setting $m=1$ makes it impossible to quantify $V_M$.\n- **Analysis:** As in option B, using genotype as a fixed effect does not yield an estimate of the variance component $V_G$.\n**Verdict: Incorrect**\n\n**E. Use seeds from $G$ half-sib families, plant siblings from each family in the same pot to standardize microenvironment, grow $r \\ge 5$ pots per family on a single bench, and take $m \\ge 2$ measurements per plant. Treat family as a random effect to estimate genetic variance and treat the residual as measurement error, omitting any block or individual-level random effects.**\n\nThis option is flawed in its choice of material, design, and analysis.\n- **Material:** The problem specifies that clonal lines are available. Using half-sib families is an unnecessary deviation. Clones allow for the estimation of *total* genetic variance ($V_G$), whereas half-sib designs typically only allow for estimation of the *additive* genetic variance ($V_A$), which is only one component of $V_G$.\n- **Design:** Planting siblings in the same pot introduces competition and confounds it with other effects; it does not \"standardize\" the microenvironment in a useful way. Placing all pots on a single bench fails to account for environmental gradients across the growth room (i.e., it fails to block).\n- **Analysis:** The analysis plan is incorrect. The residual variance in a model with only a \"family\" effect would conflate variance among individuals within a family (a mix of genetic and environmental variance) and measurement error. To separate these, a nested random effect for \"individual\" is required. The plan fails to partition variance correctly.\n**Verdict: Incorrect**\n\nBased on this rigorous analysis, Option A is the only design and analysis plan that is scientifically defensible and meets all the specific objectives defined in the problem statement. It demonstrates a correct understanding of experimental design for quantitative genetics.", "answer": "$$\\boxed{A}$$", "id": "2751903"}, {"introduction": "Our final practice delves into the nuances of genotype-by-environment ($G \\times E$) interactions by modeling reaction norms—the functions that describe how a genotype's phenotype changes across an environmental gradient. You will move beyond treating the interaction variance ($V_{G \\times E}$) as a single value and instead model its source: variation in the slopes of these norms. This hands-on coding exercise bridges the gap between the theoretical framework of phenotypic plasticity and the practical, statistical challenge of estimating its underlying genetic variation from experimental data [@problem_id:2751899].", "problem": "You are given a framework for modeling a linear reaction norm across environmental temperature, where the phenotype for genotype $i$ at temperature index $j$ is modeled as\n$$\ny_{ij} = \\mu + g_i + \\beta_i T_j + \\epsilon_{ij},\n$$\nwith $g_i$ a genotype-specific deviation from the global mean $\\mu$, $\\beta_i$ a genotype-specific slope (reaction norm), $T_j$ the temperature value at index $j$, and $\\epsilon_{ij}$ an independent residual error. Assume the following:\n- $g_i \\sim \\mathcal N(0,\\sigma_g^2)$ independently across $i$,\n- $\\beta_i \\sim \\mathcal N(0,\\sigma_\\beta^2)$ independently across $i$ and independent of $g_i$,\n- $\\epsilon_{ij} \\sim \\mathcal N(0,\\sigma_\\epsilon^2)$ independently across $i$ and $j$ and independent of $g_i$ and $\\beta_i$,\n- all genotypes share the same set of temperatures $\\{T_j\\}_{j=1}^{J}$ with $J \\ge 3$.\n\nYour task is to derive, from first principles appropriate to linear models and variance decomposition, and then implement, an estimator for the across-genotype variance of slopes $\\sigma_\\beta^2$ using only:\n- the basic properties of Ordinary Least Squares (OLS) regression for a line fitted within each genotype across temperatures,\n- the law of total expectation and the law of total variance,\n- unbiased pooling of residual variance across genotypes.\n\nDerive a method-of-moments estimator that corrects the across-genotype sample variance of the estimated slopes for the expected sampling variance contributed by the residual errors $\\epsilon_{ij}$. Implement this estimator in a program that:\n- simulates data sets under the model using the specified parameters and random seeds,\n- fits, for each genotype, an OLS line $y_{ij} \\sim a_i + b_i T_j$ across $j$,\n- pools the within-genotype residual sums of squares to estimate $\\sigma_\\epsilon^2$,\n- computes the across-genotype sample variance of the estimated slopes $\\{b_i\\}$,\n- subtracts the expected sampling variance term to obtain an estimator for $\\sigma_\\beta^2$.\n\nDesign details to obey:\n- Use the same temperature vector for all genotypes within a test case.\n- Do not truncate negative estimates; report the unbiased method-of-moments value, which may be negative in small samples.\n- The final outputs should be rounded to $6$ decimal places.\n\nTest suite. For each of the following parameter sets, simulate the data and return the estimate of $\\sigma_\\beta^2$. For reproducibility, use the given random seed for each case. Each case specifies the tuple $(\\text{seed}, N, \\mu, \\sigma_g, \\sigma_\\beta, \\sigma_\\epsilon, \\mathbf T)$ where $N$ is the number of genotypes and $\\mathbf T$ is the list of temperatures shared by all genotypes.\n\n- Case $1$: $(12345, 80, 1.0, 0.5, 0.2, 0.3, [-1.0, 0.0, 1.0])$.\n- Case $2$: $(24680, 60, 0.0, 1.0, 0.0, 0.2, [-1.0, 0.0, 1.0, 2.0])$.\n- Case $3$: $(777, 5, 0.5, 0.2, 0.5, 1.0, [-1.0, 0.0, 1.0])$.\n- Case $4$: $(424242, 200, 0.0, 0.5, 0.05, 1.5, [-1.0, 0.0, 1.0])$.\n- Case $5$: $(2023, 100, 2.0, 0.2, 0.1, 0.5, [0.0, 10.0, 20.0, 30.0])$.\n\nFinal output format. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the same order as the cases above, with each value rounded to $6$ decimal places (e.g., $[0.123456,0.000000,0.500000]$). No other text should be printed.\n\nConstraints:\n- Implement the estimator using only the specified principles and do not call any black-box mixed-model solvers.\n- Use the Python programming language and only the permitted libraries.\n- There are no physical units to report for this task; treat all quantities as unitless real numbers.", "solution": "The problem presented is a standard problem in quantitative genetics and statistics, specifically in the estimation of variance components for a random-regression mixed-effects model. The problem is scientifically grounded, well-posed, and all necessary parameters and conditions for its resolution are provided. It is a valid problem. We will proceed with the derivation of the estimator from first principles.\n\nThe model for the phenotype $y_{ij}$ of genotype $i$ at temperature $j$ is given by:\n$$\ny_{ij} = \\mu + g_i + \\beta_i T_j + \\epsilon_{ij}\n$$\nThe parameters and random variables are defined as:\n- $\\mu$ is the global mean phenotype.\n- $g_i$ is the random effect of genotype $i$, with $g_i \\sim \\mathcal{N}(0, \\sigma_g^2)$.\n- $\\beta_i$ is the random slope for genotype $i$, representing the genotype-by-environment interaction, with $\\beta_i \\sim \\mathcal{N}(0, \\sigma_\\beta^2)$.\n- $T_j$ is the value of the environmental variable (temperature) for measurement $j$.\n- $\\epsilon_{ij}$ is the residual error term, with $\\epsilon_{ij} \\sim \\mathcal{N}(0, \\sigma_\\epsilon^2)$.\nAll random effects $g_i$, $\\beta_i$, and $\\epsilon_{ij}$ are assumed to be mutually independent.\n\nOur objective is to derive a method-of-moments estimator for the variance of the slopes, $\\sigma_\\beta^2$. The strategy involves two stages. First, for each genotype $i$, we fit a simple linear regression model to its phenotypic data across the range of temperatures. Second, we analyze the distribution of the estimated slopes from the first stage to estimate $\\sigma_\\beta^2$.\n\n**Step 1: Within-Genotype OLS Regression**\n\nFor a single, fixed genotype $i$, the true values of $g_i$ and $\\beta_i$ are constants. We can define a genotype-specific intercept $\\alpha_i = \\mu + g_i$. The model for genotype $i$ becomes:\n$$\ny_{ij} = \\alpha_i + \\beta_i T_j + \\epsilon_{ij}\n$$\nThis is a standard simple linear regression model. We fit an OLS line, denoted by the estimated equation $\\hat{y}_{ij} = a_i + b_i T_j$, to the data points $\\{(T_j, y_{ij})\\}_{j=1}^J$ for each genotype $i$.\n\nThe OLS estimator for the slope, $b_i$, is given by the formula:\n$$\nb_i = \\frac{\\sum_{j=1}^{J} (T_j - \\bar{T})(y_{ij} - \\bar{y}_i)}{\\sum_{j=1}^{J} (T_j - \\bar{T})^2}\n$$\nwhere $\\bar{T} = \\frac{1}{J}\\sum_{j=1}^J T_j$. Let $S_{TT} = \\sum_{j=1}^{J} (T_j - \\bar{T})^2$. This quantity is constant for all genotypes as they share the same temperature vector $\\mathbf{T}$.\n\nTo understand the properties of $b_i$, we substitute the model for $y_{ij}$:\n$$\nb_i = \\frac{\\sum_{j=1}^{J} (T_j - \\bar{T})(\\alpha_i + \\beta_i T_j + \\epsilon_{ij} - (\\alpha_i + \\beta_i \\bar{T} + \\bar{\\epsilon}_i))}{S_{TT}}\n$$\nwhere $\\bar{\\epsilon}_i = \\frac{1}{J}\\sum_{j=1}^J \\epsilon_{ij}$. The intercept term $\\alpha_i$ cancels. We are left with:\n$$\nb_i = \\frac{\\sum_{j=1}^{J} (T_j - \\bar{T})(\\beta_i T_j - \\beta_i \\bar{T}) + \\sum_{j=1}^{J} (T_j - \\bar{T})(\\epsilon_{ij} - \\bar{\\epsilon}_i)}{S_{TT}}\n$$\n$$\nb_i = \\frac{\\beta_i \\sum_{j=1}^{J} (T_j - \\bar{T})^2 + \\sum_{j=1}^{J} (T_j - \\bar{T})\\epsilon_{ij}}{S_{TT}} = \\beta_i + \\frac{\\sum_{j=1}^{J} (T_j - \\bar{T})\\epsilon_{ij}}{S_{TT}}\n$$\nThis expression shows that the estimated slope $b_i$ is the sum of the true slope $\\beta_i$ and an error term that depends on the residuals $\\epsilon_{ij}$.\n\n**Step 2: Analysis of Estimated Slopes using Law of Total Variance**\n\nNow we treat $b_i$ as a random variable, whose randomness comes from both the sampling of genotypes (i.e., the randomness of $\\beta_i$) and the residual error (the randomness of $\\epsilon_{ij}$). We use the law of total variance, which states $\\text{Var}(X) = E[\\text{Var}(X|Y)] + \\text{Var}(E[X|Y])$. Let us apply this to $b_i$, conditioning on the true slope $\\beta_i$.\n\nFirst, we calculate the conditional expectation and variance of $b_i$ given $\\beta_i$:\nThe conditional expectation is:\n$$\nE[b_i | \\beta_i] = E\\left[\\beta_i + \\frac{\\sum_{j=1}^{J} (T_j - \\bar{T})\\epsilon_{ij}}{S_{TT}} \\ \\Bigg| \\ \\beta_i \\right] = \\beta_i + \\frac{\\sum_{j=1}^{J} (T_j - \\bar{T})E[\\epsilon_{ij}]}{S_{TT}} = \\beta_i\n$$\nsince $E[\\epsilon_{ij}] = 0$. This demonstrates that $b_i$ is a conditionally unbiased estimator of $\\beta_i$.\n\nThe conditional variance, or the sampling variance of the slope estimate, is:\n$$\n\\text{Var}(b_i | \\beta_i) = \\text{Var}\\left(\\frac{\\sum_{j=1}^{J} (T_j - \\bar{T})\\epsilon_{ij}}{S_{TT}} \\ \\Bigg| \\ \\beta_i \\right)\n$$\nDue to the independence of the $\\epsilon_{ij}$ terms, this becomes:\n$$\n\\text{Var}(b_i | \\beta_i) = \\frac{1}{S_{TT}^2} \\sum_{j=1}^{J} (T_j - \\bar{T})^2 \\text{Var}(\\epsilon_{ij}) = \\frac{1}{S_{TT}^2} S_{TT} \\sigma_\\epsilon^2 = \\frac{\\sigma_\\epsilon^2}{S_{TT}}\n$$\nThis is the variance in the estimated slope $b_i$ due to the residual error $\\epsilon_{ij}$ for a fixed genotype.\n\nNow, we apply the law of total variance to find the total variance of $b_i$ across all genotypes:\n$$\n\\text{Var}(b_i) = E[\\text{Var}(b_i | \\beta_i)] + \\text{Var}(E[b_i | \\beta_i])\n$$\nSubstituting the expressions we derived:\n$$\nE[\\text{Var}(b_i | \\beta_i)] = E\\left[\\frac{\\sigma_\\epsilon^2}{S_{TT}}\\right] = \\frac{\\sigma_\\epsilon^2}{S_{TT}}\n$$\n$$\n\\text{Var}(E[b_i | \\beta_i]) = \\text{Var}(\\beta_i) = \\sigma_\\beta^2\n$$\nThus, the total variance of the estimated slopes is the sum of the true biological variance of slopes and the average sampling variance:\n$$\n\\text{Var}(b_i) = \\sigma_\\beta^2 + \\frac{\\sigma_\\epsilon^2}{S_{TT}}\n$$\n\n**Step 3: Constructing the Method-of-Moments Estimator**\n\nThis equation provides a clear path to an estimator for $\\sigma_\\beta^2$. We can rearrange it as:\n$$\n\\sigma_\\beta^2 = \\text{Var}(b_i) - \\frac{\\sigma_\\epsilon^2}{S_{TT}}\n$$\nWe construct an estimator for $\\sigma_\\beta^2$ by substituting estimators for the terms on the right-hand side.\n\n1.  **Estimator for $\\text{Var}(b_i)$**: Given a sample of $N$ estimated slopes $\\{b_1, b_2, \\dots, b_N\\}$, the natural unbiased estimator for their variance is the sample variance:\n    $$\n    \\widehat{\\text{Var}(b_i)} = S_b^2 = \\frac{1}{N-1} \\sum_{i=1}^N (b_i - \\bar{b})^2, \\quad \\text{where} \\quad \\bar{b} = \\frac{1}{N}\\sum_{i=1}^N b_i\n    $$\n\n2.  **Estimator for $\\sigma_\\epsilon^2$**: The problem instructs us to pool the residual variance. For each genotype $i$, an unbiased estimate of $\\sigma_\\epsilon^2$ is the mean squared error from its OLS fit, $\\hat{\\sigma}_{\\epsilon,i}^2 = \\text{RSS}_i / (J-2)$, where $\\text{RSS}_i = \\sum_{j=1}^J (y_{ij} - (a_i + b_i T_j))^2$ is the residual sum of squares and $J-2$ represents the degrees of freedom. To obtain a single, more precise estimate, we pool across all $N$ genotypes:\n    $$\n    \\hat{\\sigma}_\\epsilon^2 = \\frac{\\sum_{i=1}^N \\text{RSS}_i}{\\sum_{i=1}^N (J-2)} = \\frac{\\sum_{i=1}^N \\text{RSS}_i}{N(J-2)}\n    $$\n    This pooled estimator is unbiased for $\\sigma_\\epsilon^2$.\n\nCombining these components, our method-of-moments estimator for $\\sigma_\\beta^2$ is:\n$$\n\\hat{\\sigma}_\\beta^2 = S_b^2 - \\frac{\\hat{\\sigma}_\\epsilon^2}{S_{TT}}\n$$\nThis estimator is unbiased, as $E[S_b^2] = \\text{Var}(b_i)$ and $E[\\hat{\\sigma}_\\epsilon^2] = \\sigma_\\epsilon^2$. In finite samples, particularly when the true $\\sigma_\\beta^2$ is small or $N$ is low, this estimate may be negative due to sampling error. As per the problem specification, such negative values will not be truncated.\n\nThe algorithm for implementation is as follows:\n1.  For each test case, extract parameters $N, \\mu, \\sigma_g, \\sigma_\\beta, \\sigma_\\epsilon$ and the temperature vector $\\mathbf{T}$.\n2.  Set the random seed for reproducibility.\n3.  Simulate the data: generate $N$ values of $g_i \\sim \\mathcal{N}(0, \\sigma_g^2)$, $N$ values of $\\beta_i \\sim \\mathcal{N}(0, \\sigma_\\beta^2)$, and $N \\times J$ values of $\\epsilon_{ij} \\sim \\mathcal{N}(0, \\sigma_\\epsilon^2)$ to construct the $y_{ij}$ matrix.\n4.  Calculate $S_{TT} = \\sum_{j=1}^J (T_j - \\bar{T})^2$.\n5.  Initialize an empty list for slopes, `b_list`, and a variable `total_rss = 0.0`.\n6.  Loop through each genotype $i$ from $1$ to $N$:\n    a. Perform OLS regression of $y_{i\\cdot}$ on $\\mathbf{T}$ to get the estimated slope $b_i$ and intercept $a_i$.\n    b. Append $b_i$ to `b_list`.\n    c. Calculate the residual sum of squares $\\text{RSS}_i = \\sum_j (y_{ij} - (a_i + b_i T_j))^2$.\n    d. Add $\\text{RSS}_i$ to `total_rss`.\n7.  Compute the sample variance of the collected slopes, $S_b^2 = \\text{Var}(\\text{b\\_list})$.\n8.  Compute the pooled estimate of residual variance, $\\hat{\\sigma}_\\epsilon^2 = \\text{total\\_rss} / (N(J-2))$.\n9.  Compute the final estimate: $\\hat{\\sigma}_\\beta^2 = S_b^2 - \\hat{\\sigma}_\\epsilon^2 / S_{TT}$.\n10. Store the rounded result and repeat for all test cases.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run simulations and estimate the variance of slopes.\n    \"\"\"\n    test_cases = [\n        # (seed, N, mu, sigma_g, sigma_beta, sigma_epsilon, T)\n        (12345, 80, 1.0, 0.5, 0.2, 0.3, [-1.0, 0.0, 1.0]),\n        (24680, 60, 0.0, 1.0, 0.0, 0.2, [-1.0, 0.0, 1.0, 2.0]),\n        (777, 5, 0.5, 0.2, 0.5, 1.0, [-1.0, 0.0, 1.0]),\n        (424242, 200, 0.0, 0.5, 0.05, 1.5, [-1.0, 0.0, 1.0]),\n        (2023, 100, 2.0, 0.2, 0.1, 0.5, [0.0, 10.0, 20.0, 30.0]),\n    ]\n\n    results = []\n    for case in test_cases:\n        seed, N, mu, sigma_g, sigma_beta, sigma_epsilon, T_list = case\n        \n        # Initialize random number generator for reproducibility\n        rng = np.random.default_rng(seed)\n\n        # Convert temperature list to a numpy array for vectorized operations\n        T = np.array(T_list)\n        J = len(T)\n\n        # 1. Simulate data according to the model\n        # y_ij = mu + g_i + beta_i * T_j + epsilon_ij\n        \n        # Generate random effects for N genotypes\n        g = rng.normal(0, sigma_g, N)\n        beta = rng.normal(0, sigma_beta, N)\n\n        # Generate phenotype data for N genotypes across J temperatures\n        # Epsilon is a matrix of N rows (genotypes) and J columns (temperatures)\n        epsilon = rng.normal(0, sigma_epsilon, (N, J))\n        \n        # Use broadcasting to generate the phenotype matrix y (N x J)\n        # g[:, np.newaxis] reshapes g from (N,) to (N, 1)\n        # beta[:, np.newaxis] reshapes beta from (N,) to (N, 1)\n        # T is (J,)\n        # The expression beta[:, np.newaxis] * T creates a (N, J) matrix\n        y = mu + g[:, np.newaxis] + beta[:, np.newaxis] * T + epsilon\n\n        # 2. Perform OLS regression for each genotype and collect statistics\n        estimated_slopes = []\n        total_rss = 0.0\n\n        for i in range(N):\n            y_i = y[i, :]\n            \n            # Fit a line y = b*T + a. np.polyfit returns [slope, intercept]\n            # This is equivalent to OLS\n            slope, intercept = np.polyfit(T, y_i, 1)\n            estimated_slopes.append(slope)\n            \n            # Calculate predicted values and residuals\n            y_pred = slope * T + intercept\n            residuals = y_i - y_pred\n            \n            # Calculate Residual Sum of Squares (RSS) for this genotype\n            rss_i = np.sum(residuals**2)\n            total_rss += rss_i\n\n        # 3. Calculate components for the estimator of sigma_beta^2\n        \n        # Calculate S_TT = sum((T_j - T_bar)^2)\n        s_tt = np.sum((T - np.mean(T))**2)\n\n        # Calculate the sample variance of the estimated slopes (S_b^2).\n        # ddof=1 for unbiased sample variance (N-1 denominator).\n        s_b_sq = np.var(estimated_slopes, ddof=1)\n        \n        # Calculate the pooled unbiased estimate of residual variance (sigma_epsilon^2).\n        # Degrees of freedom for residuals is N * (J - 2).\n        # J >= 3 is a prerequisite, checked by inspection of test cases.\n        degrees_of_freedom = N * (J - 2)\n        sigma_epsilon_sq_hat = total_rss / degrees_of_freedom\n        \n        # 4. Compute the final estimate for sigma_beta^2\n        # sigma_beta^2_hat = S_b^2 - (sigma_epsilon^2_hat / S_TT)\n        sigma_beta_sq_hat = s_b_sq - (sigma_epsilon_sq_hat / s_tt)\n        \n        results.append(sigma_beta_sq_hat)\n\n    # Final print statement in the exact required format.\n    # We round the values here and then format to ensure 6 decimal places.\n    formatted_results = [f\"{round(r, 6):.6f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "2751899"}]}