{"hands_on_practices": [{"introduction": "The first step in mastering model selection is to become fluent in the core calculations. This exercise provides a set of maximized log-likelihood scores for several nested substitution models, similar to the output from standard phylogenetic software. Your task is to apply the formulas for the Akaike Information Criterion (AIC) and Bayesian Information Criterion (BIC) to rank these models and quantify the strength of evidence for the best model using Akaike weights. This practice will solidify your understanding of the trade-off between model fit and complexity that lies at the heart of information-theoretic model selection [@problem_id:2734801].", "problem": "A nucleotide alignment of length $5000$ sites has been analyzed on a fixed, fully resolved unrooted topology relating $12$ taxa. For an unrooted binary phylogeny with $m$ taxa, there are $2m - 3$ branches, each with an independent branch-length parameter. The maximum log-likelihoods (natural logarithm) obtained under five time-homogeneous, time-reversible substitution models are given below, all estimated on the same topology and alignment:\n\n- JC69: $\\ln \\hat{L}_{\\mathrm{JC69}} = -7423.6$\n- HKY: $\\ln \\hat{L}_{\\mathrm{HKY}} = -7089.2$\n- GTR: $\\ln \\hat{L}_{\\mathrm{GTR}} = -7012.8$\n- GTR+G (four discrete gamma categories with a single shape parameter): $\\ln \\hat{L}_{\\mathrm{GTR+G}} = -6844.5$\n- GTR+G+I (gamma as above plus a proportion of invariable sites): $\\ln \\hat{L}_{\\mathrm{GTR+G+I}} = -6839.7$\n\nAssume standard parameterizations for nucleotide models: JC69 has equal base frequencies and equal exchangeabilities, contributing no free substitution-process parameters beyond the branch lengths; HKY adds one transition/transversion rate ratio parameter $\\kappa$ and three independent base-frequency parameters; GTR has five independent exchangeability parameters and three independent base-frequency parameters; the $+G$ extension adds one gamma shape parameter $\\alpha$; the $+I$ extension adds one parameter for the proportion of invariable sites. The number of discrete gamma categories is fixed and does not add parameters.\n\nUsing the canonical definitions of the Akaike Information Criterion (AIC) and the Bayesian Information Criterion (BIC), where each criterion balances the maximized log-likelihood against a penalty term that increases with the number of free parameters and, for BIC, with the sample size (here, the number of alignment sites), do the following:\n\n1. Determine the total number of free parameters $k$ for each model, including all branch lengths and model-specific parameters.\n2. Compute the AIC and BIC for each model.\n3. Identify the preferred model under AIC and under BIC (the model with the smallest value of each criterion).\n4. As your final numeric answer, report the Akaike weight (the normalized relative likelihood based on AIC) of the AIC-preferred model, expressed as a decimal fraction. Round your final numeric answer to four significant figures.", "solution": "The problem requires a comparative analysis of five nested models of nucleotide substitution using the Akaike Information Criterion (AIC) and the Bayesian Information Criterion (BIC). The objective is to identify the best-fitting model and quantify its support via its Akaike weight.\n\nFirst, we must define the criteria. The AIC is given by the formula:\n$$\nAIC = 2k - 2\\ln \\hat{L}\n$$\nwhere $k$ is the number of free parameters in the model and $\\ln \\hat{L}$ is the maximized natural log-likelihood. The BIC is given by:\n$$\nBIC = k \\ln(n) - 2\\ln \\hat{L}\n$$\nwhere $n$ is the sample size, which in this context is the number of sites in the nucleotide alignment, given as $n = 5000$.\n\nThe first step is to correctly determine the total number of free parameters, $k$, for each of the five models. The total number of parameters is the sum of the number of branch-length parameters and the number of substitution-process parameters.\nFor an unrooted binary phylogenetic tree with $m$ taxa, the number of branches is $2m - 3$. Here, with $m = 12$ taxa, the number of branches is $2(12) - 3 = 21$. Each branch has a length parameter, so all models share $k_{branches} = 21$ parameters.\n\nWe now determine the number of substitution-process parameters ($k_{subst}$) for each model as described:\n- **JC69**: This model assumes equal base frequencies and a single rate of substitution. It has no free parameters for the substitution process. Thus, $k_{subst, \\mathrm{JC69}} = 0$.\n- **HKY**: This model introduces a parameter for the transition/transversion rate ratio ($\\kappa$) and allows for unequal base frequencies. Since the four base frequencies must sum to $1$, there are $3$ free frequency parameters. Thus, $k_{subst, \\mathrm{HKY}} = 1 + 3 = 4$.\n- **GTR**: This is the general time-reversible model. It has $6$ exchangeability parameters, but they are relative, so only $5$ are free. It also has $3$ free base-frequency parameters. Thus, $k_{subst, \\mathrm{GTR}} = 5 + 3 = 8$.\n- **GTR+G**: This model adds a parameter for the gamma distribution of rates across sites, the shape parameter $\\alpha$. Thus, $k_{subst, \\mathrm{GTR+G}} = k_{subst, \\mathrm{GTR}} + 1 = 8 + 1 = 9$.\n- **GTR+G+I**: This model adds a parameter for the proportion of invariable sites, $p_{inv}$. Thus, $k_{subst, \\mathrm{GTR+G+I}} = k_{subst, \\mathrm{GTR+G}} + 1 = 9 + 1 = 10$.\n\nThe total number of parameters ($k$) for each model is:\n- $k_{\\mathrm{JC69}} = 21 + 0 = 21$\n- $k_{\\mathrm{HKY}} = 21 + 4 = 25$\n- $k_{\\mathrm{GTR}} = 21 + 8 = 29$\n- $k_{\\mathrm{GTR+G}} = 21 + 9 = 30$\n- $k_{\\mathrm{GTR+G+I}} = 21 + 10 = 31$\n\nWith the values of $k$, $\\ln \\hat{L}$, and $n=5000$, we can compute the AIC and BIC for each model.\n\n1. **JC69**: $k = 21$, $\\ln \\hat{L} = -7423.6$\n   $AIC_{\\mathrm{JC69}} = 2(21) - 2(-7423.6) = 42 + 14847.2 = 14889.2$\n   $BIC_{\\mathrm{JC69}} = 21\\ln(5000) - 2(-7423.6) \\approx 21(8.5172) + 14847.2 = 178.8612 + 14847.2 = 15026.0612$\n\n2. **HKY**: $k = 25$, $\\ln \\hat{L} = -7089.2$\n   $AIC_{\\mathrm{HKY}} = 2(25) - 2(-7089.2) = 50 + 14178.4 = 14228.4$\n   $BIC_{\\mathrm{HKY}} = 25\\ln(5000) - 2(-7089.2) \\approx 25(8.5172) + 14178.4 = 212.9300 + 14178.4 = 14391.3300$\n\n3. **GTR**: $k = 29$, $\\ln \\hat{L} = -7012.8$\n   $AIC_{\\mathrm{GTR}} = 2(29) - 2(-7012.8) = 58 + 14025.6 = 14083.6$\n   $BIC_{\\mathrm{GTR}} = 29\\ln(5000) - 2(-7012.8) \\approx 29(8.5172) + 14025.6 = 246.9988 + 14025.6 = 14272.5988$\n\n4. **GTR+G**: $k = 30$, $\\ln \\hat{L} = -6844.5$\n   $AIC_{\\mathrm{GTR+G}} = 2(30) - 2(-6844.5) = 60 + 13689.0 = 13749.0$\n   $BIC_{\\mathrm{GTR+G}} = 30\\ln(5000) - 2(-6844.5) \\approx 30(8.5172) + 13689.0 = 255.5160 + 13689.0 = 13944.5160$\n\n5. **GTR+G+I**: $k = 31$, $\\ln \\hat{L} = -6839.7$\n   $AIC_{\\mathrm{GTR+G+I}} = 2(31) - 2(-6839.7) = 62 + 13679.4 = 13741.4$\n   $BIC_{\\mathrm{GTR+G+I}} = 31\\ln(5000) - 2(-6839.7) \\approx 31(8.5172) + 13679.4 = 264.0332 + 13679.4 = 13943.4332$\n\nThe preferred model is the one that minimizes the information criterion score.\n- For AIC, the minimum value is $AIC_{min} = 13741.4$, corresponding to the **GTR+G+I** model.\n- For BIC, the minimum value is $BIC_{min} \\approx 13943.43$, also corresponding to the **GTR+G+I** model.\n\nFinally, we must calculate the Akaike weight of the preferred model under AIC, which is GTR+G+I. The Akaike weight ($w_i$) for model $i$ is a measure of its relative support among the set of candidate models. It is calculated as:\n$$\nw_i = \\frac{\\exp(-\\frac{1}{2}\\Delta_i)}{\\sum_{j=1}^{R} \\exp(-\\frac{1}{2}\\Delta_j)}\n$$\nwhere $\\Delta_i = AIC_i - AIC_{min}$ and $R=5$ is the number of models.\n\nFirst, we calculate the $\\Delta_i$ values for each model relative to $AIC_{min} = AIC_{\\mathrm{GTR+G+I}} = 13741.4$.\n- $\\Delta_{\\mathrm{JC69}} = 14889.2 - 13741.4 = 1147.8$\n- $\\Delta_{\\mathrm{HKY}} = 14228.4 - 13741.4 = 487.0$\n- $\\Delta_{\\mathrm{GTR}} = 14083.6 - 13741.4 = 342.2$\n- $\\Delta_{\\mathrm{GTR+G}} = 13749.0 - 13741.4 = 7.6$\n- $\\Delta_{\\mathrm{GTR+G+I}} = 13741.4 - 13741.4 = 0$\n\nNext, we calculate the numerator for the Akaike weight of the preferred model (GTR+G+I):\n$\\exp(-\\frac{1}{2}\\Delta_{\\mathrm{GTR+G+I}}) = \\exp(-\\frac{1}{2} \\times 0) = \\exp(0) = 1$.\n\nNow, we calculate the denominator, which is the sum of the relative likelihoods of all models:\n$\\sum_{j=1}^{5} \\exp(-\\frac{1}{2}\\Delta_j) = \\exp(-\\frac{1147.8}{2}) + \\exp(-\\frac{487.0}{2}) + \\exp(-\\frac{342.2}{2}) + \\exp(-\\frac{7.6}{2}) + \\exp(-\\frac{0}{2})$\n$\\sum_{j} \\exp(-\\frac{1}{2}\\Delta_j) = \\exp(-573.9) + \\exp(-243.5) + \\exp(-171.1) + \\exp(-3.8) + \\exp(0)$\nThe first three terms are vanishingly small and numerically negligible. We compute:\n$\\exp(-3.8) \\approx 0.0223708$\n$\\exp(0) = 1$\nSo, the sum is approximately $0 + 0 + 0 + 0.0223708 + 1 = 1.0223708$.\n\nThe Akaike weight for the GTR+G+I model is:\n$w_{\\mathrm{GTR+G+I}} = \\frac{1}{1.0223708} \\approx 0.978119$\n\nRounding to four significant figures, the Akaike weight of the AIC-preferred model is $0.9781$. This indicates that, given the data and the set of candidate models, there is approximately a $97.81\\%$ probability that the GTR+G+I model is the best model in the Kullback-Leibler sense.", "answer": "$$\\boxed{0.9781}$$", "id": "2734801"}, {"introduction": "Information criteria are versatile, but their application requires careful thought about the comparison being made. This problem presents a crucial conceptual challenge: distinguishing between selecting a substitution model on a fixed tree topology versus selecting a topology under a fixed model. By working through the logic and calculations for both scenarios, you will clarify how the parameter penalty ($k$) is treated in each case and why the criteria sometimes reduce to a simple likelihood ranking [@problem_id:2734810].", "problem": "A multiple sequence alignment of $N=10$ taxa has $n=2000$ sites that, conditional on a phylogeny and a substitution model, are assumed to be independent and identically distributed across sites. Consider two distinct but closely related model selection tasks:\n\n- Task 1 (substitution model selection on a fixed topology): The unrooted, fully bifurcating tree topology $T^\\star$ is held fixed. You will compare three time-reversible, stationary, homogeneous substitution-process models that differ in parameterization. For each model $M_i$, let $k_i$ denote the total number of free parameters, including all branch lengths and all substitution-process parameters. The candidates and their maximized log-likelihoods are:\n  - $M_1=\\text{JC69}$ with $k_1=17$ and $\\ell_1=\\log L(M_1,T^\\star \\mid \\text{data})=-5500.0$.\n  - $M_2=\\text{HKY}$ with $k_2=21$ and $\\ell_2=\\log L(M_2,T^\\star \\mid \\text{data})=-5205.0$.\n  - $M_3=\\text{GTR}+\\Gamma+I$ with $k_3=27$ and $\\ell_3=\\log L(M_3,T^\\star \\mid \\text{data})=-5195.0$.\n\n- Task 2 (topology selection under a fixed substitution model): The substitution model is fixed to $M_2=\\text{HKY}$. You will compare three unrooted, fully bifurcating topologies $T_A,T_B,T_C$ on the same $N=10$ taxa. For each topology, all branch lengths and all $M_2$ parameters are optimized. Because all three topologies are fully resolved on the same taxon set under the same substitution model, the total parameter count is the same across them, $k_A=k_B=k_C=21$. The maximized log-likelihoods are:\n  - $\\ell_A=\\log L(M_2,T_A \\mid \\text{data})=-5200.0$,\n  - $\\ell_B=\\log L(M_2,T_B \\mid \\text{data})=-5192.0$,\n  - $\\ell_C=\\log L(M_2,T_C \\mid \\text{data})=-5195.0$.\n\nUsing only general principles of likelihood-based model comparison and information criteria, choose the single option that most accurately and completely:\n\n1) Clarifies the conceptual distinction between selecting among substitution models on a fixed topology versus selecting among tree topologies under a fixed substitution model, including how and why the complexity penalty enters differently in the two tasks.\n\n2) Correctly states, for the numerical values given above, which candidate is selected by the Akaike Information Criterion (AIC) and which by the Bayesian Information Criterion (BIC) in Task $1$, and which topology is selected by both criteria in Task $2$, together with the justification for why both criteria reduce to the same ranking across topologies in this setup.\n\nA. Under a fixed topology $T^\\star$, the three substitution models $M_1,M_2,M_3$ constitute distinct statistical models with different total parameter counts $k_i$, so both AIC and BIC trade off improved fit against added substitution-process and among-site-rate parameters. With the given $\\ell_i$ and $n=2000$, AIC selects $M_3$ while BIC selects $M_2$. Under a fixed substitution model and three fully bifurcating topologies on the same taxa, the total parameter count $k$ (all branch lengths plus substitution parameters) is identical across $T_A,T_B,T_C$, so the penalty terms are equal constants and both AIC and BIC reduce to choosing the maximum-likelihood topology, here $T_B$.\n\nB. The Bayesian Information Criterion should use the number of taxa $N=10$ as the sample size, so its penalty dominates for richer substitution models; therefore both AIC and BIC select $M_1$ in Task $1$. In Task $2$, BIC favors the most balanced topology topologically, so it would select $T_A$ even if its likelihood is lower.\n\nC. Information criteria cannot be applied to discrete objects like tree topologies; only likelihood ratio tests are appropriate. Because $T_A$ versus $T_B$ are non-nested, neither AIC nor BIC is meaningful, and one should pick $T_A$ by parsimony instead.\n\nD. When comparing topologies under a fixed substitution model, the number of parameters $k$ differs because branch length estimates differ across trees, so BIC penalizes trees with longer total branch length; in the given numbers it would pick $T_C$. In Task $1$, both AIC and BIC necessarily pick $M_3$ because it has the highest likelihood.\n\nE. Under a fixed topology, both AIC and BIC select the richest model $M_3$ given the likelihoods, and under a fixed substitution model both criteria select $T_B$; however, because BIC’s penalty varies across topologies even when the model is fixed, it can in principle reverse the likelihood ranking among fully bifurcating trees with the same number of taxa.", "solution": "We begin from the standard likelihood framework for phylogenetic inference under time-reversible, stationary, homogeneous substitution models with site independence. Given an alignment of $n$ sites and a candidate model (which consists of a substitution-process parameterization together with a tree topology and its branch lengths), the likelihood is\n$$\nL(\\text{model} \\mid \\text{data}) \\;=\\; \\prod_{i=1}^{n} p\\big(X_i \\mid \\text{model}\\big),\n$$\nwhere $X_i$ is the site pattern at site $i$ and $p(\\cdot \\mid \\text{model})$ is computed by Felsenstein’s pruning algorithm integrating over unobserved ancestral states. The log-likelihood is additive across sites:\n$$\n\\ell \\;=\\; \\log L \\;=\\; \\sum_{i=1}^{n} \\log p\\big(X_i \\mid \\text{model}\\big).\n$$\n\nInformation criteria provide principled, approximate ways to trade off data fit against model complexity. The Akaike Information Criterion (AIC) and the Bayesian Information Criterion (BIC) are defined by\n$$\n\\mathrm{AIC} \\;=\\; -2 \\ell \\;+\\; 2k, \n\\qquad\n\\mathrm{BIC} \\;=\\; -2 \\ell \\;+\\; k \\log n,\n$$\nwhere $k$ is the total number of free parameters of the model and $n$ is the sample size. Under the conventional independent-sites assumption, the appropriate sample size for BIC in phylogenetics is $n$ equal to the number of alignment sites. Lower values indicate preferred models.\n\nTwo conceptual points follow immediately from these definitions:\n\n- In Task $1$, the topology $T^\\star$ is fixed, so differences in $k$ across $M_1,M_2,M_3$ arise from the substitution-process parameterization (e.g., exchangeability rates, base frequencies, among-site rate variation parameters), while the number of branch-length parameters is the same across the $M_i$. Therefore, AIC and BIC will weigh improvements in $\\ell$ against increases in $k$ across the substitution models.\n\n- In Task $2$, the substitution model is fixed to $M_2$ and all three topologies $T_A,T_B,T_C$ are unrooted and fully bifurcating on the same $N=10$ taxa. Such trees all have the same number of branch-length parameters, namely $2N-3=17$, and the same number of substitution-process parameters (those of $M_2$), so the total $k$ is identical across the candidate topologies. Consequently, the penalty terms $2k$ (for AIC) and $k \\log n$ (for BIC) are equal constants across $T_A,T_B,T_C$, and both criteria reduce to ranking topologies by $\\ell$ alone, i.e., choosing the maximum-likelihood (ML) topology.\n\nWe now carry out the requested calculations.\n\nTask $1$ (fixed topology $T^\\star$, compare $M_1,M_2,M_3$):\n\n- Compute $-2\\ell$ for each model:\n  - $-2\\ell_1 = -2(-5500.0) = 11000.0$,\n  - $-2\\ell_2 = -2(-5205.0) = 10410.0$,\n  - $-2\\ell_3 = -2(-5195.0) = 10390.0$.\n\n- AIC values:\n  - $\\mathrm{AIC}(M_1) = 11000.0 + 2 \\times 17 = 11034.0$,\n  - $\\mathrm{AIC}(M_2) = 10410.0 + 2 \\times 21 = 10452.0$,\n  - $\\mathrm{AIC}(M_3) = 10390.0 + 2 \\times 27 = 10444.0$.\n  The smallest is $\\mathrm{AIC}(M_3)=10444.0$, so AIC selects $M_3$.\n\n- BIC values (with $n=2000$ sites and $\\log n = \\log 2000 \\approx 7.600902$):\n  - Penalties: $k_1 \\log n \\approx 17 \\times 7.600902 \\approx 129.215$, $k_2 \\log n \\approx 21 \\times 7.600902 \\approx 159.619$, $k_3 \\log n \\approx 27 \\times 7.600902 \\approx 205.224$.\n  - $\\mathrm{BIC}(M_1) \\approx 11000.0 + 129.215 = 11129.215$,\n  - $\\mathrm{BIC}(M_2) \\approx 10410.0 + 159.619 = 10569.619$,\n  - $\\mathrm{BIC}(M_3) \\approx 10390.0 + 205.224 = 10595.224$.\n  The smallest is $\\mathrm{BIC}(M_2)\\approx 10569.619$, so BIC selects $M_2$.\n\nThus, in Task $1$ the two criteria disagree in the intended way: AIC, with a parameter penalty that does not scale with $n$, is more permissive and selects the richer $M_3$, whereas BIC, with a penalty that grows with $\\log n$, is more conservative at $n=2000$ and selects the intermediate-complexity $M_2$.\n\nTask $2$ (fixed model $M_2$, compare topologies $T_A,T_B,T_C$):\n\n- Compute $-2\\ell$:\n  - $-2\\ell_A = -2(-5200.0) = 10400.0$,\n  - $-2\\ell_B = -2(-5192.0) = 10384.0$,\n  - $-2\\ell_C = -2(-5195.0) = 10390.0$.\n  Since $k_A=k_B=k_C=21$, both $\\mathrm{AIC}$ and $\\mathrm{BIC}$ differ across topologies only by $-2\\ell$, so both select the topology with the largest $\\ell$ (smallest $-2\\ell$), namely $T_B$.\n\nOption-by-option analysis:\n\n- Option A: This option correctly articulates the conceptual distinction: in Task $1$, differences in $k$ across substitution models drive the penalty trade-off, whereas in Task $2$, with fully bifurcating trees on the same taxa under a fixed substitution model, $k$ is identical across topologies, so penalties are equal constants and both criteria reduce to ML ranking. It also correctly identifies the selected models given the numbers: AIC selects $M_3$, BIC selects $M_2$ in Task $1$, and both select $T_B$ in Task $2$. Verdict — Correct.\n\n- Option B: This asserts that BIC should take the number of taxa $N=10$ as the sample size. Under the independent-sites model, the appropriate $n$ is the number of sites, not the number of taxa. It further claims both AIC and BIC pick $M_1$, which contradicts the explicit calculations above. It also invokes “balanced topology” as a BIC preference, which is not how information criteria operate. Verdict — Incorrect.\n\n- Option C: This claims information criteria cannot be applied to discrete objects like topologies and suggests likelihood ratio tests instead. Both AIC and BIC are explicitly designed to compare any finite set of fitted models, including discrete alternatives such as tree topologies. Moreover, likelihood ratio tests require nesting, which typically does not hold among distinct fully resolved topologies; information criteria are exactly for comparing such non-nested models. Verdict — Incorrect.\n\n- Option D: This claims $k$ differs across topologies because branch length estimates differ. The value estimates differ, but the number of free parameters $k$ does not: all fully bifurcating unrooted trees on the same taxon set have $2N-3$ branch lengths, hence the same $k$. It also asserts that BIC penalizes longer total branch length, which is false; penalties depend on parameter counts, not parameter magnitudes. Its claim that both AIC and BIC “necessarily pick $M_3$” in Task $1$ is contradicted by the BIC calculation above. Verdict — Incorrect.\n\n- Option E: While it correctly identifies $T_B$ in Task $2$, it incorrectly asserts that both AIC and BIC pick $M_3$ in Task $1$. It further claims that BIC’s penalty varies across fully bifurcating topologies with the same model and number of taxa, which is false in this setup because $k$ is the same across $T_A,T_B,T_C$. Verdict — Incorrect.\n\nTherefore, only Option A is correct.", "answer": "$$\\boxed{A}$$", "id": "2734810"}, {"introduction": "While phylogenetic software automates model selection, a true understanding comes from building the engine yourself. This hands-on coding challenge guides you through implementing the likelihood functions for three classic nucleotide models (JC69, K80, and F81) from first principles. By writing the code to perform parameter optimization and calculate AIC scores, you will gain a deep, practical insight into how these powerful statistical tools work under the hood [@problem_id:2406832].", "problem": "You are to implement, from first principles, an Akaike Information Criterion (AIC) model selection procedure for nucleotide substitution models in a simplified phylogenetic setting. The task is to compute the maximum log-likelihood for three classic continuous-time substitution models and then compute their AIC values to select the best model per test case. The models are: Jukes-Cantor $1969$ (JC69), Kimura 2-parameter (K80), and Felsenstein $1981$ (F81). You will assume a fixed rooted star phylogeny with $4$ leaves and identical branch lengths. The alphabet is deoxyribonucleic acid (DNA) nucleotides $\\{A,C,G,T\\}$. The site likelihood is computed using the standard continuous-time Markov chain (CTMC) framework and Felsenstein’s pruning algorithm specialized to a star topology. The final program must produce the results for the test suite given below.\n\nFoundational base and assumptions:\n- Continuous-Time Markov Chain (CTMC) on $\\{A,C,G,T\\}$ with homogeneous, time-reversible dynamics.\n- Sites evolve independently and identically along a rooted star tree with $4$ pendant branches, each of length $t$ (the same $t$ for all branches in a given test).\n- For each model, transition probabilities along a branch of length $t$ are given by the matrix exponential of the rate matrix $\\mathbf{Q}$ under the model’s constraints, with the expected substitution rate normalized to $1$ substitution per unit time. The stationary distribution is $\\boldsymbol{\\pi}$.\n- Root distribution equals the stationary distribution $\\boldsymbol{\\pi}$.\n- Maximum Likelihood Estimation (MLE) is performed over each model’s free parameters while holding the branch length $t$ fixed for the test case.\n\nYou must implement:\n- The site likelihood at the root using the standard pruning recurrence on a star tree. For a single site with observed nucleotides $(x_1,x_2,x_3,x_4)$ at the leaves, and transition matrix $\\mathbf{P}(t)$ with entries $P_{ij}(t)$ and root prior $\\pi_i$, the site likelihood is\n$$\n\\mathcal{L}_{\\text{site}} \\;=\\; \\sum_{i \\in \\{A,C,G,T\\}} \\pi_i \\prod_{\\ell=1}^{4} P_{i,\\,x_\\ell}(t).\n$$\n- The log-likelihood over an alignment as the sum over sites of $\\log \\mathcal{L}_{\\text{site}}$.\n- Model specifications with rate normalization to unit expected rate:\n  - JC69: all off-diagonal instantaneous rates equal; stationary frequencies $\\boldsymbol{\\pi}=(\\tfrac{1}{4},\\tfrac{1}{4},\\tfrac{1}{4},\\tfrac{1}{4})$; no free parameters when $t$ is fixed.\n  - K80: two rate classes for transitions versus transversions with transition/transversion rate ratio $\\kappa$ as the single free parameter; stationary frequencies fixed at $\\tfrac{1}{4}$ each; the expected rate is normalized to $1$ via appropriate scaling of instantaneous rates.\n  - F81: off-diagonal rates proportional to target base frequencies; free parameters are the stationary frequencies $\\boldsymbol{\\pi}=(\\pi_A,\\pi_C,\\pi_G,\\pi_T)$ subject to $\\sum \\pi_i=1$ and $\\pi_i0$; expected rate normalized to $1$ via a global scalar so that $-\\sum_i \\pi_i Q_{ii}=1$.\n- For each model, compute the maximum log-likelihood $\\ell_{\\max}$ with respect to its free parameters given the observed alignment and branch length $t$. Then compute AIC using the definition of Akaike Information Criterion (AIC): for a model with $k$ free parameters,\n$$\n\\mathrm{AIC} \\;=\\; 2k \\;-\\; 2 \\,\\ell_{\\max}.\n$$\n- Parameter counts $k$ for this problem with $t$ fixed per test case: JC69 has $k=0$, K80 has $k=1$ (the $\\kappa$ parameter), and F81 has $k=3$ (the three independent stationary frequencies because $\\sum \\pi_i=1$).\n\nAlgorithmic requirements:\n- Implement numerically stable log-likelihood accumulation across sites. Use log-sum-exp stabilization for the root-state summation when needed.\n- For K80, perform one-dimensional numerical optimization over $\\kappa0$.\n- For F81, perform constrained optimization over $\\boldsymbol{\\pi}$, which you may implement by transforming to unconstrained parameters (for example, via a softmax over $4$ components with one fixed reference) and optimizing those unconstrained parameters.\n\nPrecise model ingredients to be derived and implemented:\n- JC69 transition probabilities should be derived from its $\\mathbf{Q}$ with expected rate $1$, leading to $P_{ii}(t)$ and $P_{ij}(t)$ in terms of $t$ only.\n- K80 transition probabilities should be derived under the expected rate $1$ normalization, with transition versus transversion probabilities depending on $\\kappa$ and $t$.\n- F81 transition probabilities should be derived from its $\\mathbf{Q}$ with stationary frequencies $\\boldsymbol{\\pi}$ and an overall scalar $\\mu$ chosen so that the expected rate is $1$. Under F81,\n$$\nQ_{ij} \\;=\\; \\mu\\, \\pi_j \\quad (i \\neq j), \\qquad Q_{ii} \\;=\\; - \\mu \\,(1-\\pi_i), \\qquad \\mu \\;=\\; \\frac{1}{1-\\sum_{i} \\pi_i^2}.\n$$\nThen\n$$\n\\mathbf{P}(t) \\;=\\; \\boldsymbol{\\Pi} \\;+\\; e^{-\\mu t}\\,(\\mathbf{I}-\\boldsymbol{\\Pi}), \\quad \\text{where } \\boldsymbol{\\Pi} \\text{ has rows all equal to } \\boldsymbol{\\pi}.\n$$\n\nTest suite:\nImplement your program to evaluate the following $4$ test cases. In each case, the star tree has $4$ leaves labeled in order as taxa $1$ through $4$, and a fixed branch length $t$ (the same $t$ for all $4$ pendant branches). Each alignment is given as $4$ sequences of equal length over $\\{A,C,G,T\\}$, one per taxon, aligned by columns.\n\n- Case $1$ (balanced composition, mixed changes; expect parsimony to not favor transition bias; moderate branch length):\n  - Branch length $t = 0.5$.\n  - Sequences of length $16$ specified column-wise; for taxa $\\{1,2,3,4\\}$ the $16$ site-columns are:\n    $[AAAA, CCCC, GGGG, TTTT, AAGG, GGAA, CCTT, TTCC, AACC, CCAA, GGTT, TTGG, ACTG, AGCT, ATAT, CGCG]$.\n- Case $2$ (strong transition bias with overall balanced composition; moderate branch length):\n  - Branch length $t = 0.5$.\n  - Sequences of length $24$ specified as $4$ blocks:\n    - Invariant block: $[AAAA, CCCC, GGGG, TTTT]$,\n    - Transition block A/G repeated $5$ times: $[AAGG, GGAA]$ repeated $5$ times,\n    - Transition block C/T repeated $5$ times: $[CCTT, TTCC]$ repeated $5$ times.\n- Case $3$ (strong base-composition skew favoring $A$; moderate branch length; long alignment so that frequency fit matters):\n  - Branch length $t = 0.5$.\n  - Length $60$ sequences defined by concatenating blocks:\n    - Taxa $1$ and $2$: $45$ copies of $A$, then $5$ copies of $G$, then $10$ copies of $A$.\n    - Taxa $3$ and $4$: $40$ copies of $A$, then $5$ copies of $G$, then $5$ copies of $A$, then $5$ copies of $C$, then $5$ copies of $T$.\n- Case $4$ (near-zero branch length boundary; all taxa identical sequences; model-penalty dominated):\n  - Branch length $t = 0.001$.\n  - All $4$ taxa have the identical sequence of length $12$: the string $ACGTACGTACGT$.\n\nUnits and numerical conventions:\n- There are no physical units; branch length $t$ is dimensionless and measured in expected substitutions per site since the expected rate is $1$ by construction.\n- Angles are not involved.\n- Probabilities should be handled as decimals; do not use percentages.\n\nFinal output format:\n- For each test case, compute the AIC for JC69, K80, and F81, and select the model with the smallest AIC. Encode models as integers: JC69 $\\to 0$, K80 $\\to 1$, F81 $\\to 2$.\n- Your program should produce a single line of output containing the results as a comma-separated list of integers enclosed in square brackets, e.g., $[0,1,2,0]$ for the four cases in order.\n\nYour program must be a complete, runnable program that reads no input and writes exactly one line in the specified format. The program must implement the likelihoods and optimizations from scratch as described above and must not call any external phylogenetics software.", "solution": "The solution will be constructed following a systematic, first-principles approach. First, the core machinery for likelihood calculation under a continuous-time Markov chain framework will be established. Then, specific implementations for each of the three models will be developed, followed by numerical optimization to find the maximum log-likelihood ($\\ell_{\\max}$) for the models with free parameters. Finally, the AIC value for each model will be computed and used to select the best-fitting model for each test case.\n\nThe likelihood of the data for a given model is computed on a site-by-site basis and then combined. The phylogenetic tree is a rooted star topology with four leaves and identical branch lengths $t$. The root is assumed to be in the stationary distribution $\\boldsymbol{\\pi}$ of the substitution process. For a single site with observed nucleotides $(x_1, x_2, x_3, x_4)$ at the leaves, the site likelihood is given by Felsenstein's pruning algorithm, which for this topology simplifies to:\n$$\n\\mathcal{L}_{\\text{site}} = \\sum_{i \\in \\{A,C,G,T\\}} \\pi_i \\prod_{\\ell=1}^{4} P_{i,x_\\ell}(t)\n$$\nwhere $\\pi_i$ is the stationary frequency of the ancestral nucleotide $i$, and $P_{i,x_\\ell}(t)$ is the probability of a transition from nucleotide $i$ to $x_\\ell$ along a branch of length $t$. The total log-likelihood for an alignment is the sum of the logarithms of the individual site likelihoods: $\\ell = \\sum_{\\text{sites}} \\log(\\mathcal{L}_{\\text{site}})$. To handle numerical underflow and maintain precision, this calculation is performed using the log-sum-exp transformation:\n$$\n\\log(\\mathcal{L}_{\\text{site}}) = \\mathrm{logsumexp}_{i} \\left( \\log(\\pi_i) + \\sum_{\\ell=1}^4 \\log(P_{i,x_\\ell}(t)) \\right)\n$$\nThe problem specifies that for each model, the instantaneous rate matrix $\\mathbf{Q}$ is scaled such that the expected number of substitutions per site per unit time is $1$. This is expressed by the condition $-\\sum_i \\pi_i Q_{ii} = 1$.\n\nThe three models are implemented as follows:\n\n1.  **Jukes-Cantor 1969 (JC69)**: This is the simplest model. It assumes equal base frequencies ($\\pi_A=\\pi_C=\\pi_G=\\pi_T=1/4$) and a single rate for all substitution types. The rate normalization condition $3\\alpha=1$ (where $\\alpha$ is the off-diagonal rate) implies the eigenvalues of the rate matrix lead to the following transition probabilities for a branch of length $t$:\n    $$\n    \\begin{aligned}\n    P_{ii}(t) = \\frac{1}{4} + \\frac{3}{4}e^{-\\frac{4}{3}t} \\\\\n    P_{ij}(t) = \\frac{1}{4} - \\frac{1}{4}e^{-\\frac{4}{3}t} \\quad (i \\neq j)\n    \\end{aligned}\n    $$\n    Since the branch length $t$ is fixed for each test case, the JC69 model has no free parameters. Therefore, the parameter count is $k=0$.\n\n2.  **Kimura 1980 (K80)**: This model distinguishes between transitions (purine-purine or pyrimidine-pyrimidine changes, rate $\\alpha$) and transversions (purine-pyrimidine changes, rate $\\beta$). Base frequencies are assumed to be equal ($\\pi_i=1/4$). The single free parameter is the transition/transversion rate ratio, $\\kappa = \\alpha/\\beta$. The rate normalization condition requires $(\\alpha + 2\\beta) = 1$ under our parameterization, yielding $\\alpha = \\kappa / (\\kappa+2)$ and $\\beta = 1/(\\kappa+2)$. The transition probabilities are:\n    $$\n    \\begin{aligned}\n    P_{ii}(t) = \\frac{1}{4} + \\frac{1}{4}e^{-4\\beta t} + \\frac{1}{2}e^{-2(\\alpha+\\beta)t} \\\\\n    P_{ij}(t, \\text{transition}) = \\frac{1}{4} + \\frac{1}{4}e^{-4\\beta t} - \\frac{1}{2}e^{-2(\\alpha+\\beta)t} \\\\\n    P_{ij}(t, \\text{transversion}) = \\frac{1}{4} - \\frac{1}{4}e^{-4\\beta t}\n    \\end{aligned}\n    $$\n    The maximum log-likelihood is found by numerically optimizing over the single parameter $\\kappa  0$. The parameter count is $k=1$.\n\n3.  **Felsenstein 1981 (F81)**: This model allows for unequal base frequencies $\\boldsymbol{\\pi} = (\\pi_A, \\pi_C, \\pi_G, \\pi_T)$, which are treated as free parameters subject to the constraint $\\sum_i \\pi_i = 1$. The substitution rates depend on the target base frequency. The model's rate matrix $\\mathbf{Q}$ and transition matrix $\\mathbf{P}(t)$ are given in the problem statement, with rate normalization achieved via the factor $\\mu = 1 / (1 - \\sum_i \\pi_i^2)$. The resulting transition probabilities are:\n    $$\n    \\begin{aligned}\n    P_{ii}(t) = \\pi_i + (1 - \\pi_i)e^{-\\mu t} \\\\\n    P_{ij}(t) = \\pi_j(1 - e^{-\\mu t}) \\quad (i \\neq j)\n    \\end{aligned}\n    $$\n    Since $\\sum_i \\pi_i = 1$, there are $3$ independent frequencies. Hence, the parameter count is $k=3$. The maximum log-likelihood is found by optimizing over these three parameters. This constrained optimization problem is solved by reparameterizing the simplex using a softmax transformation, enabling the use of unconstrained optimization algorithms.\n\nFor each model and test case, the maximum log-likelihood $\\ell_{\\max}$ is determined. The Akaike Information Criterion is then computed as:\n$$\n\\mathrm{AIC} = 2k - 2\\ell_{\\max}\n$$\nThe model with the lowest AIC is selected as the best fit for the data. The entire procedure is encapsulated in a Python program using the `numpy` and `scipy` libraries for numerical computation and optimization.", "answer": "```python\nimport numpy as np\nfrom scipy.optimize import minimize, minimize_scalar\nfrom scipy.special import logsumexp\nfrom collections import Counter\n\n# Define a mapping from nucleotides to indices for matrix operations.\nNUC_MAP = {'A': 0, 'C': 1, 'G': 2, 'T': 3}\n\ndef process_alignment_cols(cols):\n    \"\"\"\n    Processes a list of alignment column strings into a Counter of site patterns.\n    Each pattern is a tuple of nucleotide indices.\n    \"\"\"\n    site_patterns = [\"\".join(sorted(col)) + \":\" + col for col in cols]\n    \n    counts = Counter()\n    for col_str in cols:\n        indices = tuple(NUC_MAP[nuc] for nuc in col_str)\n        counts[indices] += 1\n    return counts\n\ndef calculate_log_likelihood(site_counts, P, pi):\n    \"\"\"\n    Calculates the total log-likelihood for an alignment given site pattern counts,\n    a transition probability matrix P, and stationary frequencies pi.\n    This implementation is numerically stable, using the log-sum-exp trick.\n    \"\"\"\n    total_log_L = 0.0\n    \n    # Pre-calculate logs to avoid repeated computations inside the loop\n    # Add a small epsilon to prevent log(0) if any probability is exactly zero.\n    log_P = np.log(P + 1e-300)\n    log_pi = np.log(pi + 1e-300)\n\n    for site_indices, count in site_counts.items():\n        # For each ancestral state i, calculate log(P(path | ancestor=i))\n        # This is sum_{leaves l} log(P_{i, x_l})\n        sum_log_probs_over_leaves = (log_P[:, site_indices[0]] +\n                                     log_P[:, site_indices[1]] +\n                                     log_P[:, site_indices[2]] +\n                                     log_P[:, site_indices[3]])\n\n        # Combine with root probability log(pi_i)\n        terms = log_pi + sum_log_probs_over_leaves\n        \n        # Sum over all possible ancestral states i in log-space\n        site_log_L = logsumexp(terms)\n        \n        total_log_L += count * site_log_L\n    \n    return total_log_L\n\n# --- Model-specific implementations ---\n\ndef get_aic_jc69(t, site_counts):\n    \"\"\"Computes AIC for the JC69 model.\"\"\"\n    k = 0\n    pi = np.array([0.25, 0.25, 0.25, 0.25])\n    \n    p_diag = 0.25 + 0.75 * np.exp(-4.0/3.0 * t)\n    p_offdiag = 0.25 - 0.25 * np.exp(-4.0/3.0 * t)\n    \n    P = np.full((4, 4), p_offdiag)\n    np.fill_diagonal(P, p_diag)\n\n    log_L = calculate_log_likelihood(site_counts, P, pi)\n    aic = 2 * k - 2 * log_L\n    return aic\n\ndef get_aic_k80(t, site_counts):\n    \"\"\"Computes AIC for the K80 model via optimization.\"\"\"\n    k = 1\n    pi = np.array([0.25, 0.25, 0.25, 0.25])\n    \n    is_transition_matrix = np.array([\n        [0, 0, 1, 0],  # A - G\n        [0, 0, 0, 1],  # C - T\n        [1, 0, 0, 0],  # G - A\n        [0, 1, 0, 0],  # T - C\n    ])\n\n    def objective_fn(kappa):\n        if kappa = 0:\n            return np.inf\n\n        beta = 1.0 / (kappa + 2.0)\n        alpha = kappa * beta\n        \n        e1 = np.exp(-4.0 * beta * t)\n        e2 = np.exp(-2.0 * (alpha + beta) * t)\n\n        p_identity = 0.25 + 0.25 * e1 + 0.5 * e2\n        p_transition = 0.25 + 0.25 * e1 - 0.5 * e2\n        p_transversion = 0.25 - 0.25 * e1\n\n        P = np.full((4, 4), p_transversion)\n        P[is_transition_matrix == 1] = p_transition\n        np.fill_diagonal(P, p_identity)\n        \n        log_L = calculate_log_likelihood(site_counts, P, pi)\n        return -log_L # Return negative log-likelihood for minimization\n\n    # Optimize over kappa  0\n    res = minimize_scalar(objective_fn, bounds=(1e-9, 100), method='bounded')\n    max_log_L = -res.fun\n    \n    aic = 2 * k - 2 * max_log_L\n    return aic\n\ndef get_aic_f81(t, site_counts):\n    \"\"\"Computes AIC for the F81 model via optimization.\"\"\"\n    k = 3\n    \n    def objective_fn(params):\n        # Softmax transformation from 3 unconstrained params to a 4-dim probability vector pi\n        # Fix one parameter to 0 for identifiability.\n        unconstrained_params = np.concatenate(([0], params))\n        exp_params = np.exp(unconstrained_params)\n        pi = exp_params / np.sum(exp_params)\n        \n        if np.any(pi  1e-9): # Avoid extreme frequencies\n            return np.inf\n\n        mu = 1.0 / (1.0 - np.sum(pi**2))\n        \n        exp_mut = np.exp(-mu * t)\n        \n        # Build P matrix\n        p_offdiag_term = 1.0 - exp_mut\n        P = np.outer(np.ones(4), pi) * p_offdiag_term\n        np.fill_diagonal(P, pi + (1 - pi) * exp_mut)\n\n        log_L = calculate_log_likelihood(site_counts, P, pi)\n        return -log_L\n\n    # Initial guess corresponds to uniform frequencies\n    initial_params = np.array([0.0, 0.0, 0.0])\n    res = minimize(objective_fn, initial_params, method='L-BFGS-B')\n    max_log_L = -res.fun\n    \n    aic = 2 * k - 2 * max_log_L\n    return aic\n\ndef solve():\n    \"\"\"Main function to run the analysis for all test cases.\"\"\"\n    \n    # Test Case 1\n    case1_t = 0.5\n    case1_cols = \"AAAA,CCCC,GGGG,TTTT,AAGG,GGAA,CCTT,TTCC,AACC,CCAA,GGTT,TTGG,ACTG,AGCT,ATAT,CGCG\".split(',')\n    \n    # Test Case 2\n    case2_t = 0.5\n    case2_cols = (['AAAA', 'CCCC', 'GGGG', 'TTTT'] + \n                  ['AAGG', 'GGAA'] * 5 + \n                  ['CCTT', 'TTCC'] * 5)\n\n    # Test Case 3\n    case3_t = 0.5\n    s1 = 'A'*45 + 'G'*5 + 'A'*10\n    s2 = 'A'*45 + 'G'*5 + 'A'*10\n    s3 = 'A'*40 + 'G'*5 + 'A'*5 + 'C'*5 + 'T'*5\n    s4 = 'A'*40 + 'G'*5 + 'A'*5 + 'C'*5 + 'T'*5\n    case3_cols = [''.join(site) for site in zip(s1, s2, s3, s4)]\n\n    # Test Case 4\n    case4_t = 0.001\n    s_ident = 'ACGTACGTACGT'\n    case4_cols = [''.join(site) for site in zip(s_ident, s_ident, s_ident, s_ident)]\n\n    test_cases = [\n        (case1_t, case1_cols),\n        (case2_t, case2_cols),\n        (case3_t, case3_cols),\n        (case4_t, case4_cols),\n    ]\n\n    results = []\n    \n    model_mapping = {0: 'JC69', 1: 'K80', 2: 'F81'}\n    model_funcs = [get_aic_jc69, get_aic_k80, get_aic_f81]\n    \n    for i, (t, cols) in enumerate(test_cases):\n        site_counts = process_alignment_cols(cols)\n        \n        aic_values = []\n        for func in model_funcs:\n            aic_values.append(func(t, site_counts))\n        \n        best_model_idx = np.argmin(aic_values)\n        results.append(best_model_idx)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "2406832"}]}