{"hands_on_practices": [{"introduction": "Before delving into the complexities of rate variation across lineages, it is essential to solidify your understanding of the foundational strict molecular clock. This exercise provides a clear, quantitative baseline by having you calculate a single evolutionary rate and corresponding node ages on an idealized, ultrametric tree. Mastering these fundamental calculations involving the relationship $d = r \\times t$ is the first step toward appreciating why and how relaxed clock models are necessary when the assumption of a constant rate is violated [@problem_id:2749326].", "problem": "A four-taxon ultrametric phylogeny relates taxa $A$, $B$, $C$, and $D$ under a strict molecular clock. The topology is $((A,B),(C,D))$, and the tree is ultrametric with total tip-to-root time $T$ identical for all tips. A single calibration fixes the age of the root (the most recent common ancestor (MRCA) of all four taxa) at $T_{\\mathrm{root}} = 12$ million years (Myr). Along each path from the present to the root, the branch durations (in Myr) are as follows:\n- For taxa $A$ and $B$: each pendant branch from its clade MRCA to the tip has duration $7$, and the internal branch from that clade MRCA to the root has duration $5$.\n- For taxa $C$ and $D$: each pendant branch from its clade MRCA to the tip has duration $8$, and the internal branch from that clade MRCA to the root has duration $4$.\nBy construction, the tree is ultrametric, since $7+5=12$ and $8+4=12$.\n\nFrom an alignment analyzed under the Jukes-Cantor (JC69) model, the corrected distances along each complete tip-to-root path are estimated to be $d_{A}=0.84$, $d_{B}=0.84$, $d_{C}=0.84$, and $d_{D}=0.84$ substitutions per site.\n\nAssume a strict molecular clock with a single global rate $r$ (in substitutions per site per Myr) so that the expected number of substitutions per site accumulated along any lineage over a duration $\\Delta t$ is linear in time with proportionality constant $r$. Under the JC69 model, the corrected path distance equals the expected total number of substitutions per site accumulated along that path.\n\nCompute:\n1. The global rate $r$ in substitutions per site per Myr.\n2. The ages (in Myr before present) of the two internal nodes: the MRCA of $(A,B)$ and the MRCA of $(C,D)$.\n\nReport your three values in the order $\\big(r,\\ \\text{age}_{(A,B)},\\ \\text{age}_{(C,D)}\\big)$. Round your answers to three significant figures. Express $r$ in substitutions per site per Myr and node ages in Myr. Do not include units in your final reported tuple.", "solution": "The problem will first be validated for correctness and consistency.\n\n**Step 1: Extract Givens**\n- **Topology**: A four-taxon tree with topology $((A,B),(C,D))$.\n- **Clock Model**: A strict molecular clock with a single global rate $r$.\n- **Tree Property**: The phylogeny is ultrametric.\n- **Root Age**: The age of the root (MRCA of $(A,B,C,D)$) is $T_{\\mathrm{root}} = 12$ million years (Myr).\n- **Branch Durations for $(A,B)$ clade**:\n    - Pendant branch duration (MRCA of $(A,B)$ to tip): $7$ Myr.\n    - Internal branch duration (root to MRCA of $(A,B)$): $5$ Myr.\n- **Branch Durations for $(C,D)$ clade**:\n    - Pendant branch duration (MRCA of $(C,D)$ to tip): $8$ Myr.\n    - Internal branch duration (root to MRCA of $(C,D)$): $4$ Myr.\n- **Path Time Consistency**: The total time from root to any tip is constant: $7+5=12$ Myr and $8+4=12$ Myr. This is consistent with the ultrametric property and root age.\n- **Genetic Distances**: Corrected tip-to-root distances under the Jukes-Cantor (JC69) model are $d_{A}=0.84$, $d_{B}=0.84$, $d_{C}=0.84$, and $d_{D}=0.84$ substitutions per site.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded, well-posed, and objective. It describes a standard scenario in molecular phylogenetics. The premise is a strict molecular clock, where genetic distance accumulates linearly with time at a constant rate $r$ across all lineages. The tree is specified as ultrametric, meaning the total time from the root to each tip is identical. The provided branch durations ($7+5=12$ and $8+4=12$) are consistent with the stated root age of $T_{\\mathrm{root}} = 12$ Myr. The corrected genetic distances from root to tip are given as equal for all taxa ($d=0.84$), which is a necessary consequence of a strict clock on an ultrametric tree. The problem is internally consistent and contains all necessary information to compute the requested quantities. There are no logical contradictions or factual inaccuracies.\n\n**Step 3: Verdict and Action**\nThe problem is valid. A complete solution will be provided.\n\n**Solution Derivation**\n\nThe problem requires the computation of three values: the global substitution rate $r$, and the ages of the two internal nodes, which are the most recent common ancestors (MRCAs) of the clades $(A,B)$ and $(C,D)$.\n\n**1. Computation of the Global Rate, $r$**\nUnder a strict molecular clock, the expected genetic distance $d$ (in substitutions per site) accumulated along a lineage is directly proportional to the time duration $T$ (in Myr). The constant of proportionality is the substitution rate $r$ (in substitutions per site per Myr). The relationship is expressed as:\n$$d = r \\times T$$\nThe problem states that the total time from the root to any tip is $T = 12$ Myr. It also provides the corresponding corrected genetic distance for any root-to-tip path as $d = 0.84$ substitutions per site. We can therefore solve for the rate $r$:\n$$r = \\frac{d}{T}$$\nSubstituting the given values:\n$$r = \\frac{0.84}{12} \\text{ substitutions per site per Myr}$$\n$$r = 0.07 \\text{ substitutions per site per Myr}$$\nThe problem requires the answer to be rounded to three significant figures. In standard scientific notation, this is:\n$$r = 7.00 \\times 10^{-2} \\text{ substitutions per site per Myr}$$\n\n**2. Computation of Node Ages**\nThe age of a node in a phylogeny is defined as the time from that node to the present. The tips of the tree represent the present time, which can be set to time $0$.\n\n**A. Age of the MRCA of $(A,B)$**\nThe problem states that the duration of a pendant branch for taxa $A$ and $B$, which is the branch from their MRCA to a tip, is $7$ Myr. By definition, this duration represents the time elapsed from the MRCA event to the present. Therefore, the age of the MRCA of $(A,B)$ is:\n$$\\text{age}_{(A,B)} = 7 \\text{ Myr}$$\nThis can be verified using the internal branch information. The root has an age of $12$ Myr. The internal branch connecting the root to the MRCA of $(A,B)$ has a duration of $5$ Myr. The age of the node is the age of the parent node minus the duration of the connecting branch:\n$$\\text{age}_{(A,B)} = T_{\\mathrm{root}} - \\Delta t_{\\text{internal}, (A,B)} = 12 - 5 = 7 \\text{ Myr}$$\nThe values are consistent. To three significant figures, the age is $7.00$ Myr.\n\n**B. Age of the MRCA of $(C,D)$**\nSimilarly, for taxa $C$ and $D$, the duration of a pendant branch from their MRCA to a tip is given as $8$ Myr. This duration is the age of the node.\n$$\\text{age}_{(C,D)} = 8 \\text{ Myr}$$\nVerifying this with the internal branch duration of $4$ Myr:\n$$\\text{age}_{(C,D)} = T_{\\mathrm{root}} - \\Delta t_{\\text{internal}, (C,D)} = 12 - 4 = 8 \\text{ Myr}$$\nThe values are again consistent. To three significant figures, the age is $8.00$ Myr.\n\n**Final Values**\nThe requested values in the specified order $\\big(r,\\ \\text{age}_{(A,B)},\\ \\text{age}_{(C,D)}\\big)$ and rounded to three significant figures are:\n- $r = 7.00 \\times 10^{-2}$\n- $\\text{age}_{(A,B)} = 7.00$\n- $\\text{age}_{(C,D)} = 8.00$", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n7.00 \\times 10^{-2} & 7.00 & 8.00\n\\end{pmatrix}\n}\n$$", "id": "2749326"}, {"introduction": "Real-world molecular dating is rarely as straightforward as the strict clock model suggests. This exercise moves from simple calculation to complex interpretation, presenting a common scenario where fossil calibrations and sequence data may be in conflict. By reasoning through the interplay between priors and the likelihood under an uncorrelated lognormal (UCLN) model, you will learn to diagnose incongruence and evaluate appropriate scientific responses, a critical skill for any practitioner in molecular phylogenetics [@problem_id:2749316].", "problem": "In a molecular dating analysis of a three-taxon tree with topology $\\left((A,B),C\\right)$, sequence data produce estimated patristic distances (in substitutions per site) from the root to each tip of approximately $D_A \\approx 0.12$, $D_B \\approx 0.11$, and $D_C \\approx 0.10$. You adopt an uncorrelated lognormal (UCLN) relaxed clock, in which branch-specific instantaneous rates $r_i$ are drawn independently and identically distributed (i.i.d.) from a lognormal distribution on the log scale with variance parameter $\\sigma^2$, and you place fossil calibration priors on two nodes: the divergence of $A$ and $B$ with a soft minimum at $T_{AB} \\ge 25$ million years (Ma) and the root age with a soft maximum at $T_{\\text{root}} \\le 27$ Ma. The tree prior is a standard Birth–Death process with diffuse hyperparameters. All calibrations are implemented as probabilistic priors with soft bounds, not hard constraints.\n\nConsider the fundamental facts that (i) expected substitutions along a branch equal the time duration multiplied by the branch-specific rate, and (ii) in the UCLN model, increasing $\\sigma^2$ places more prior weight on more extreme among-branch rate differences. You also have the option to perform leave-one-calibration-out cross-validation, in which you remove one calibration prior, fit the model with the remaining calibrations, and examine the posterior predictive distribution of the excluded node’s age.\n\nUsing only these foundational considerations, analyze the likely joint effect of the given calibrations and data on the posterior of $\\sigma^2$, and identify sound modeling or data-justification responses. Which of the following statements are most consistent with the principles above?\n\nA. Under the uncorrelated lognormal (UCLN) model, the tension created by $T_{AB} \\ge 25$ Ma and $T_{\\text{root}} \\le 27$ Ma, together with the observed $D_A$, $D_B$, and $D_C$, will tend to push the posterior of the log-rate variance $\\sigma^2$ upward, because only substantial rate heterogeneity can reconcile long pre-split durations with relatively small accumulated substitutions.\n\nB. Leave-one-calibration-out cross-validation will tend to flag an incongruent calibration: if the $A$–$B$ calibration is excluded and the model is fit with only the root calibration, the posterior predictive for $T_{AB}$ may fall well below $25$ Ma; conversely, excluding the root calibration may produce a posterior predictive for $T_{\\text{root}}$ that exceeds $27$ Ma, revealing conflict.\n\nC. The most appropriate remedy to resolve the tension is to fix a very large prior on $\\sigma^2$ so that the model always admits enough rate variation to satisfy all calibrations; this prevents bias and improves date precision.\n\nD. A defensible response includes re-examining the fossil justifications (phylogenetic placement and stratigraphic context) and, if warranted, softening or widening calibration priors (e.g., using broader lognormal or offset-gamma distributions) to better reflect uncertainty, which can reduce pathological inflation of $\\sigma^2$.\n\nE. As $\\sigma^2$ increases under UCLN, the posterior on divergence times will necessarily narrow, because rate heterogeneity resolves conflicts and thus always reduces uncertainty in node ages.\n\nSelect all that apply.", "solution": "The validity of the problem statement must be established before a solution is attempted.\n\n### Step 1: Extract Givens\n-   **Topology**: A three-taxon tree, `((A,B),C)`.\n-   **Data**: Estimated patristic distances from the root to each tip are $D_A \\approx 0.12$, $D_B \\approx 0.11$, and $D_C \\approx 0.10$ substitutions per site.\n-   **Clock Model**: Uncorrelated lognormal (UCLN) relaxed clock. Branch-specific rates $r_i$ are drawn independently and identically distributed (i.i.d.) from a lognormal distribution. The log-scale variance of this distribution is $\\sigma^2$.\n-   **Calibrations**:\n    1.  Divergence of A and B: $T_{AB} \\ge 25$ million years (Ma), implemented as a soft minimum prior.\n    2.  Root age: $T_{\\text{root}} \\le 27$ Ma, implemented as a soft maximum prior.\n-   **Tree Prior**: Birth–Death process with diffuse hyperparameters.\n-   **Methodological Facts**:\n    1.  Expected substitutions = time duration $\\times$ branch rate.\n    2.  Increasing $\\sigma^2$ in the UCLN model places more prior weight on larger differences among branch rates.\n    3.  Leave-one-calibration-out cross-validation is an available technique.\n\n### Step 2: Validate Using Extracted Givens\nThe problem describes a standard scenario in Bayesian molecular dating. All concepts—UCLN model, $\\sigma^2$, Birth-Death prior, fossil calibrations, patristic distance—are foundational in modern phylogenetics. The problem is scientifically grounded and objective.\n\nThe core of the problem lies in a potential conflict between the sequence data and the calibration priors. Let us analyze this. Let the root node be $R$ and the ancestor of $(A,B)$ be node $N$. The age of the root is $T_R = T_{\\text{root}}$ and the age of node $N$ is $T_N = T_{AB}$.\nThe calibrations impose strong priors such that $T_{AB}$ is pushed towards values $\\ge 25$ Ma and $T_{\\text{root}}$ is pushed towards values $\\le 27$ Ma. This constrains the time duration of the stem branch leading to $(A,B)$, $t_{stemAB} = T_{\\text{root}} - T_{AB}$, to be very short (e.g., $\\approx 2$ Ma). In contrast, the terminal branches leading to $A$ and $B$ have a long duration, $t_A = t_B = T_{AB} \\approx 25$ Ma, and the branch leading to $C$ has a duration $t_C = T_{\\text{root}} \\approx 27$ Ma.\n\nThe sequence data consist of root-to-tip distances: $D_A \\approx 0.12$, $D_B \\approx 0.11$, $D_C \\approx 0.10$. These values are very similar, suggesting the data are \"clock-like\". Under a strict molecular clock ($\\sigma^2=0$), all root-to-tip distances must be equal ($D_A = D_B = D_C = r \\cdot T_{\\text{root}}$). The observed data ($0.12 \\neq 0.11 \\neq 0.10$) already violates a strict clock, necessitating some level of rate variation ($\\sigma^2 > 0$).\n\nThe conflict is more severe when combined with the calibrations. The total distance to tip $C$ is $D_C = r_C \\cdot t_C \\approx r_C \\cdot 27$. This implies a rate $r_C \\approx 0.10/27 \\approx 0.0037$ substitutions/site/Ma. The total distance to tip $A$ is $D_A = r_{stemAB} \\cdot t_{stemAB} + r_A \\cdot t_A \\approx r_{stemAB} \\cdot 2 + r_A \\cdot 25$. To reconcile $D_A \\approx 0.12$ with these highly unequal time durations ($2$ Ma and $25$ Ma), the rates $r_{stemAB}$ and $r_A$ must be substantially different from each other and/or from $r_C$. For instance, a very high rate on the short stem branch must be compensated by a very low rate on the long terminal branch, or vice versa. Such significant rate differences can only be accommodated by the model if the variance parameter, $\\sigma^2$, is large.\n\nThis tension between nearly clock-like data and calibrations that impose a non-clock-like distribution of time across branches is a valid, well-posed, and common problem in phylogenetics. The problem statement is not flawed; it accurately describes a situation requiring careful analysis.\n\n### Step 3: Verdict and Action\nThe problem is valid. A solution will be derived.\n\n### Derivation and Option Analysis\n\nThe problem setup creates a conflict. The calibrations force a specific temporal structure on the tree: a very short internal branch ($t_{stemAB} \\approx 2$ Ma) and very long terminal branches ($t_A, t_B \\approx 25$ Ma; $t_C \\approx 27$ Ma). However, the genetic data show that the total accumulated change along these paths of disparate temporal structure is nearly equal ($D_A \\approx D_B \\approx D_C$). To satisfy the fundamental equation `distance = rate * time` for each branch, the model must infer highly heterogeneous rates. Specifically, to accumulate a significant portion of the total distance on the short stem branch, its rate $r_{stemAB}$ would need to be much higher than the rates on the long terminal branches. Alternatively, if $r_{stemAB}$ is low, the terminal rates $r_A, r_B$ must be high enough to account for the total distances. In either case, the rates $r_A, r_B, r_C, r_{stemAB}$, which are supposedly drawn from a common lognormal distribution, must be very different. The only way the UCLN model can accommodate this is by adopting a high value for the variance parameter $\\sigma^2$, which explicitly allows for large rate differences among branches.\n\n**A. Under the uncorrelated lognormal (UCLN) model, the tension created by $T_{AB} \\ge 25$ Ma and $T_{\\text{root}} \\le 27$ Ma, together with the observed $D_A$, $D_B$, and $D_C$, will tend to push the posterior of the log-rate variance $\\sigma^2$ upward, because only substantial rate heterogeneity can reconcile long pre-split durations with relatively small accumulated substitutions.**\nThis statement accurately diagnoses the situation. The \"tension\" is the conflict between the time structure imposed by the calibrations and the nearly equal root-to-tip distances. As derived above, this conflict can only be resolved within the UCLN framework by invoking substantial rate heterogeneity across branches. A higher posterior estimate for $\\sigma^2$ is the direct consequence, as this parameter controls the degree of rate variation the model permits. The phrasing \"long pre-split durations\" is slightly ambiguous but within the context correctly points to the branch duration asymmetry.\n**Verdict: Correct.**\n\n**B. Leave-one-calibration-out cross-validation will tend to flag an incongruent calibration: if the $A$–$B$ calibration is excluded and the model is fit with only the root calibration, the posterior predictive for $T_{AB}$ may fall well below $25$ Ma; conversely, excluding the root calibration may produce a posterior predictive for $T_{\\text{root}}$ that exceeds $27$ Ma, revealing conflict.**\nThis describes a standard procedure for identifying prior-data conflict.\n1.  If we remove the $T_{AB} \\ge 25$ Ma prior, the age $T_{AB}$ will be informed primarily by the sequence data and the tree prior (Birth-Death). Tree priors like the Birth-Death process typically favor placing divergence events more recently, not deep in the past. The nearly clock-like data provide no strong signal to place $T_{AB}$ so close to the root. Thus, the posterior for $T_{AB}$ would likely be much younger than $25$ Ma.\n2.  Conversely, if we remove the $T_{\\text{root}} \\le 27$ Ma prior but keep $T_{AB} \\ge 25$ Ma, the model is anchored by a very old age for the $A-B$ split. The root must be older still ($T_{\\text{root}} > T_{AB}$). To account for the observed genetic distance on the stem branch $r_{stemAB} \\cdot (T_{\\text{root}}-T_{AB})$, which must be positive, $T_{\\text{root}}-T_{AB}$ must be assigned a non-zero duration. Given the overall amount of evolution in the tree ($D \\approx 0.1$) and typical evolutionary rates, scaling this distance to time might suggest a total time depth ($T_{\\text{root}}$) greater than $27$ Ma. Thus, the posterior predictive for $T_{\\text{root}}$ would likely exceed $27$ Ma.\nBoth scenarios reveal a strong conflict between the two calibrations, which is exactly what cross-validation is designed to detect.\n**Verdict: Correct.**\n\n**C. The most appropriate remedy to resolve the tension is to fix a very large prior on $\\sigma^2$ so that the model always admits enough rate variation to satisfy all calibrations; this prevents bias and improves date precision.**\nThis proposal is scientifically and statistically unsound. Forcing a fit by fixing a parameter (or using a very strong prior) to accommodate conflict is a way of ignoring the underlying problem, not remedying it. The inflated $\\sigma^2$ is a symptom of the conflict. While allowing $\\sigma^2$ to be high will make the model converge, it does so by invoking a potentially unrealistic biological scenario of extreme rate volatility. This does not \"prevent bias\"; it can introduce severe bias by forcing a questionable evolutionary model. Furthermore, increased rate heterogeneity (high $\\sigma^2$) loosens the connection between genetic distance and time, which *increases*, not decreases, the uncertainty (i.e., widens the posterior intervals) of date estimates. The claim of improving precision is false.\n**Verdict: Incorrect.**\n\n**D. A defensible response includes re-examining the fossil justifications (phylogenetic placement and stratigraphic context) and, if warranted, softening or widening calibration priors (e.g., using broader lognormal or offset-gamma distributions) to better reflect uncertainty, which can reduce pathological inflation of $\\sigma^2$.**\nThis describes the proper scientific and statistical response to data-prior conflict. When a model indicates tension, the first step is to critically re-evaluate the inputs, particularly the calibration priors, which are interpretations of external evidence (fossils). This involves scrutinizing the fossil's placement in the phylogeny and the certainty of its geological age. If this re-examination suggests the original priors were overly restrictive (i.e., too \"tight\"), the correct action is to use priors that better represent the true uncertainty (e.g., by using distributions with larger variances or softer bounds). This allows the model more flexibility to find a solution that better balances the information from the sequence data and the calibrations, thereby alleviating the need to invoke extreme parameter values elsewhere (the \"pathological inflation of $\\sigma^2$\").\n**Verdict: Correct.**\n\n**E. As $\\sigma^2$ increases under UCLN, the posterior on divergence times will necessarily narrow, because rate heterogeneity resolves conflicts and thus always reduces uncertainty in node ages.**\nThis statement is fundamentally false. The parameter $\\sigma^2$ quantifies the uncertainty in the evolutionary rate. A larger $\\sigma^2$ implies that the rate on any given branch is less predictable. Since divergence time $t$ is calculated from genetic distance $d$ and rate $r$ via $t = d/r$, a greater uncertainty in $r$ directly translates to a greater uncertainty in $t$. Therefore, increasing $\\sigma^2$ will generally lead to wider, not narrower, posterior distributions for divergence times, reflecting reduced precision. The premise that resolving conflict reduces uncertainty is misapplied; here, the \"resolution\" is achieved by introducing more uncertainty into a key model component (the rates).\n**Verdict: Incorrect.**", "answer": "$$\\boxed{ABD}$$", "id": "2749316"}, {"introduction": "To capstone your practical understanding, this final exercise moves from conceptual diagnosis to direct implementation. You will write a program to perform a simplified Bayesian analysis, finding the maximum a posteriori (MAP) estimates for parameters under a UCLN relaxed clock. This hands-on coding task allows you to directly observe how varying the strength and position of calibration priors impacts the inferred rates and ages, providing a tangible confirmation of the principles explored in the previous exercises [@problem_id:2749338].", "problem": "A rooted phylogenetic tree with $5$ taxa is considered under an Uncorrelated Lognormal (UCLN) relaxed molecular clock model. The objective is to evaluate how a calibration prior with a soft maximum bound on the root age affects posterior modes of rates and ages, using a simplified observation model for branch lengths and a fixed topology. The program you write must compute, for multiple calibration settings, the posterior mode (maximum a posteriori, MAP) of the root age and the posterior mode of the mean branch rate, by solving a constrained optimization problem.\n\nThe fundamental base is as follows.\n\n- Substitutions accumulate along a branch as the product of an instantaneous rate and elapsed time, so that the expected branch length (in substitutions per site) equals rate times time. For an individual branch $i$ with rate $r_i$ and duration $d_i$, the expected length is $r_i d_i$.\n- For a fixed topology with branch durations linked by node ages, the observed branch lengths $\\{b_i\\}$ are treated as noisy measurements of the expected lengths. Under a many-sites approximation (Central Limit Theorem), a Gaussian observation model is used: \n  $$b_i \\mid r_i, d_i \\sim \\mathcal{N}(r_i d_i, \\sigma^2),$$\n  with known variance $\\sigma^2$ shared across branches.\n- Under the Uncorrelated Lognormal (UCLN) model, branch-specific rates are independent and lognormally distributed: \n  $$\\log r_i \\sim \\mathcal{N}(\\mu_r, s_r^2),$$\n  independently for each branch $i$.\n- The root age $t_R$ has a lognormal base prior \n  $$\\log t_R \\sim \\mathcal{N}(\\mu_T, s_T^2),$$ \n  multiplied by a soft maximum bound penalty at maximum $M$, \n  $$w(t_R; M, k) = \\exp\\!\\big(-k \\cdot \\max(0, t_R - M)\\big),$$ \n  where $k$ controls the strength of the soft bound. Other internal node ages have a diffuse uniform prior over the feasible region defined by tree-order constraints.\n\nTree topology and parameterization.\n\n- The rooted bifurcating topology is $((A,B),(C,(D,E)))$ with root $R$, and internal nodes $X=\\mathrm{MRCA}(A,B)$, $Y=\\mathrm{MRCA}(D,E)$, $Z=\\mathrm{MRCA}(C,Y)$.\n- Let the internal node ages be $t_R$, $t_{AB}$, $t_{CDE}$, and $t_{DE}$ for nodes $R$, $X$, $Z$, and $Y$, respectively. Tip ages are $0$. The constraints are \n  $$t_R \\ge t_{AB} \\ge 0,\\quad t_R \\ge t_{CDE} \\ge t_{DE} \\ge 0.$$\n- The $8$ branches and their durations are:\n  - Branch $1$: $R \\to X$ with duration $d_1 = t_R - t_{AB}$.\n  - Branch $2$: $R \\to Z$ with duration $d_2 = t_R - t_{CDE}$.\n  - Branch $3$: $X \\to A$ with duration $d_3 = t_{AB} - 0$.\n  - Branch $4$: $X \\to B$ with duration $d_4 = t_{AB} - 0$.\n  - Branch $5$: $Z \\to C$ with duration $d_5 = t_{CDE} - 0$.\n  - Branch $6$: $Z \\to Y$ with duration $d_6 = t_{CDE} - t_{DE}$.\n  - Branch $7$: $Y \\to D$ with duration $d_7 = t_{DE} - 0$.\n  - Branch $8$: $Y \\to E$ with duration $d_8 = t_{DE} - 0$.\n\nData and hyperparameters.\n\n- The observed branch lengths (in substitutions per site) are fixed at \n  $$\\mathbf{b} = (b_1,\\dots,b_8) = (0.0044,\\, 0.0019,\\, 0.0063,\\, 0.0060,\\, 0.0096,\\, 0.0045,\\, 0.0030,\\, 0.00255).$$\n- The observation noise standard deviation is $\\sigma = 0.0002$ (so variance $\\sigma^2 = 4\\times 10^{-8}$).\n- The UCLN rate prior parameters are $\\mu_r = \\log(0.01)$ and $s_r = 0.25$.\n- The base lognormal prior parameters for the root age are $\\mu_T = \\log(1.0) = 0$ and $s_T = 0.5$.\n\nPosterior and optimization.\n\n- Let $\\mathbf{r} = (r_1,\\dots,r_8)$ and $\\mathbf{t} = (t_R,t_{AB},t_{CDE},t_{DE})$. The posterior density (up to a normalizing constant that does not depend on the variables) is \n  $$p(\\mathbf{r}, \\mathbf{t} \\mid \\mathbf{b}) \\propto \\left[\\prod_{i=1}^8 \\exp\\!\\left(-\\frac{(b_i - r_i d_i)^2}{2 \\sigma^2}\\right)\\right] \\cdot \\left[\\prod_{i=1}^8 \\frac{1}{r_i} \\exp\\!\\left(-\\frac{(\\log r_i - \\mu_r)^2}{2 s_r^2}\\right)\\right] \\cdot \\frac{1}{t_R}\\exp\\!\\left(-\\frac{(\\log t_R - \\mu_T)^2}{2 s_T^2}\\right)\\cdot w(t_R;M,k),$$\n  subject to the tree-order constraints on $\\mathbf{t}$ and positivity of $\\mathbf{r}$. Your program should compute the joint MAP $(\\mathbf{r}^\\star, \\mathbf{t}^\\star)$ for each calibration setting $(M,k)$ by minimizing the negative log posterior.\n- The negative log posterior to be minimized (dropping additive constants not depending on parameters) is\n  $$\\mathcal{L}(\\mathbf{r}, \\mathbf{t}) = \\sum_{i=1}^8 \\frac{(b_i - r_i d_i)^2}{2 \\sigma^2} + \\sum_{i=1}^8 \\left[\\frac{(\\log r_i - \\mu_r)^2}{2 s_r^2} + \\log r_i\\right] + \\left[\\frac{(\\log t_R - \\mu_T)^2}{2 s_T^2} + \\log t_R\\right] + k \\cdot \\max(0, t_R - M),$$\n  with constraints $t_R \\ge t_{AB} \\ge 0$, $t_R \\ge t_{CDE} \\ge t_{DE} \\ge 0$, and $r_i > 0$ for all $i$.\n\nTasks.\n\n- Implement a constrained optimization to obtain the joint MAP for each calibration pair $(M,k)$ in the test suite.\n- For each MAP solution, extract:\n  - The root age posterior mode $t_R^\\star$ (in time units), and\n  - The posterior mode of the mean branch rate $\\bar{r}^\\star = \\frac{1}{8}\\sum_{i=1}^8 r_i^\\star$ (in substitutions per site per time unit).\n- Use the following test suite of calibration settings:\n  - Case $1$ (loose bound): $M = 2.0$, $k = 0.1$.\n  - Case $2$ (moderate bound): $M = 1.0$, $k = 5.0$.\n  - Case $3$ (very tight bound): $M = 0.7$, $k = 20.0$.\n\nScientific realism requirements.\n\n- The solution should respect all constraints on node ages to keep branch durations nonnegative.\n- All ages must be reported in time units, and all rates in substitutions per site per time unit.\n- Angles are not involved.\n- Express any ratios or proportions as decimal numbers.\n\nFinal output specification.\n\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets.\n- For each test case $i$ in the order above, output first $t_R^\\star$ (in time units), then $\\bar{r}^\\star$ (in substitutions per site per time unit).\n- Round each numeric value to six decimal places before printing.\n- The final output therefore must have $2 \\times 3 = 6$ floats in this order: $[t_{R,1}^\\star, \\bar{r}_1^\\star, t_{R,2}^\\star, \\bar{r}_2^\\star, t_{R,3}^\\star, \\bar{r}_3^\\star]$.", "solution": "We begin from the fundamental relationship that the expected number of substitutions per site accumulated along a branch equals the product of the instantaneous substitution rate and the elapsed time along that branch. Denote by $r_i$ the rate on branch $i$ and by $d_i$ the duration (time length) of branch $i$. The expected branch length is then $r_i d_i$. We assume measured branch lengths $b_i$ from sequence data alignments are approximately Gaussian-distributed around the expectation with variance $\\sigma^2$ shared across branches: $b_i \\mid r_i, d_i \\sim \\mathcal{N}(r_i d_i, \\sigma^2)$. This Gaussian approximation can be justified by the Central Limit Theorem applied across many sites under standard substitution models, producing near-normal estimation errors for branch lengths.\n\nUnder the Uncorrelated Lognormal (UCLN) relaxed clock model, the branch-specific rates are independent with $\\log r_i \\sim \\mathcal{N}(\\mu_r, s_r^2)$. This prior captures rate heterogeneity among branches while centering around a baseline rate scale set by $\\mu_r$. For times, we place a base lognormal prior on the root age $t_R$, $\\log t_R \\sim \\mathcal{N}(\\mu_T, s_T^2)$, reflecting positive support and multiplicative variability. To model a soft maximum bound at $M$, we multiply the base prior by a penalty factor $w(t_R; M, k) = \\exp\\big(-k \\max(0, t_R - M)\\big)$; for $t_R \\le M$ the penalty equals $1$, whereas for $t_R > M$ the prior density decays approximately exponentially with rate $k$. The remaining internal node ages receive a diffuse uniform prior over the feasible set defined by the tree-order constraints. These constraints ensure all branch durations are nonnegative: $t_R \\ge t_{AB} \\ge 0$ and $t_R \\ge t_{CDE} \\ge t_{DE} \\ge 0$.\n\nCombining the likelihood and priors via Bayes' theorem yields a posterior density proportional to their product. Dropping normalizing constants that do not involve the parameters, the negative log posterior to be minimized for the joint MAP estimator is\n$$\n\\mathcal{L}(\\mathbf{r}, \\mathbf{t})\n=\n\\sum_{i=1}^8 \\frac{(b_i - r_i d_i)^2}{2 \\sigma^2}\n+ \\sum_{i=1}^8 \\left[\\frac{(\\log r_i - \\mu_r)^2}{2 s_r^2} + \\log r_i\\right]\n+ \\left[\\frac{(\\log t_R - \\mu_T)^2}{2 s_T^2} + \\log t_R\\right]\n+ k \\cdot \\max(0, t_R - M),\n$$\nsubject to $r_i > 0$ for all $i$ and the age constraints above. The first term contracts the prediction errors between observed $b_i$ and expected $r_i d_i$. The second term implements the UCLN prior with the $\\log r_i$ quadratic penalty and the Jacobian term $\\log r_i$. The third term is the base lognormal prior on $t_R$ with its Jacobian $\\log t_R$. The final term is the soft bound penalty, which activates when $t_R$ exceeds $M$ and is scaled by $k$.\n\nThe durations $d_i$ are linear functions of the node ages $\\mathbf{t} = (t_R, t_{AB}, t_{CDE}, t_{DE})$:\n- $d_1 = t_R - t_{AB}$,\n- $d_2 = t_R - t_{CDE}$,\n- $d_3 = t_{AB}$,\n- $d_4 = t_{AB}$,\n- $d_5 = t_{CDE}$,\n- $d_6 = t_{CDE} - t_{DE}$,\n- $d_7 = t_{DE}$,\n- $d_8 = t_{DE}$.\n\nAlgorithmic design proceeds as follows.\n\n- Parameterization and constraints: We optimize over the vector $(\\log r_1,\\dots,\\log r_8, t_R, t_{AB}, t_{CDE}, t_{DE})$, using explicit bounds $r_i > 0$ via the logarithmic parameterization and linear inequality constraints to enforce the ancestral age ordering, namely $t_R - t_{AB} \\ge \\epsilon$, $t_R - t_{CDE} \\ge \\epsilon$, $t_{CDE} - t_{DE} \\ge \\epsilon$, $t_{AB} \\ge \\epsilon$, $t_{DE} \\ge \\epsilon$ with a small $\\epsilon > 0$ to maintain strict positivity of durations. Additional box bounds keep ages within a reasonable search domain.\n- Objective evaluation: For given parameters, compute durations $d_i$, rates $r_i = \\exp(\\log r_i)$, and the Gaussian residual sum of squares term with fixed $\\sigma^2$, then add the UCLN and base lognormal penalties, and the soft maximum penalty $k \\max(0, t_R - M)$. If any duration is nonpositive, apply a large penalty to enforce feasibility.\n- Numerical optimization: Use constrained nonlinear optimization to minimize $\\mathcal{L}$. A method such as Sequential Least Squares Programming (SLSQP) handles smooth objectives with linear inequality constraints and box bounds. The soft bound term is continuous but nonsmooth at $t_R = M$, which SLSQP tolerates in practice.\n- Initialization: Start near the baseline rate and a plausible age configuration: $\\log r_i \\approx \\log(0.01)$ for all $i$, $t_R \\approx 1.0$, $t_{AB} \\approx 0.6$, $t_{CDE} \\approx 0.8$, $t_{DE} \\approx 0.3$.\n- Outputs: At the optimizer’s solution $(\\mathbf{r}^\\star, \\mathbf{t}^\\star)$, compute $t_R^\\star$ and $\\bar{r}^\\star = \\frac{1}{8}\\sum_{i=1}^8 r_i^\\star$. Round each to six decimals.\n\nInterpretation of the test suite cases:\n\n- Case $1$ with $M=2.0$ and $k=0.1$ places a weak, loose upper bound on $t_R$, so the likelihood and the UCLN prior predominantly determine $t_R^\\star$ and $\\bar{r}^\\star$.\n- Case $2$ with $M=1.0$ and $k=5.0$ anchors $t_R$ near $1.0$ time units, pulling the MAP root age downward if the likelihood alone would prefer a larger value, and correspondingly adjusting $\\bar{r}^\\star$ upward or downward to reconcile $r_i d_i$ with the observed $b_i$.\n- Case $3$ with $M=0.7$ and $k=20.0$ imposes a very tight soft maximum; the optimizer must compress $t_R^\\star$ below or near $0.7$, thereby inflating the rates to maintain $r_i d_i \\approx b_i$. Consequently, we expect $t_R^\\star$ to decrease and $\\bar{r}^\\star$ to increase relative to the looser cases.\n\nThe program implements this constrained MAP estimation for each $(M,k)$ pair and prints a single-line list of the six rounded values in the specified order. Ages are reported in time units, and rates are in substitutions per site per time unit.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import minimize, NonlinearConstraint, Bounds\n\ndef solve():\n    # Data: observed branch lengths (substitutions per site)\n    b = np.array([0.0044, 0.0019, 0.0063, 0.0060, 0.0096, 0.0045, 0.0030, 0.00255], dtype=float)\n    sigma = 0.0002  # observation noise std\n\n    # UCLN prior hyperparameters\n    mu_r = np.log(0.01)\n    s_r = 0.25\n\n    # Root age base lognormal prior parameters\n    mu_T = 0.0  # log(1.0)\n    s_T = 0.5\n\n    # Tree structure: durations from node ages\n    def durations(t):\n        tR, tAB, tCDE, tDE = t\n        d = np.empty(8, dtype=float)\n        d[0] = tR - tAB       # R->X\n        d[1] = tR - tCDE      # R->Z\n        d[2] = tAB            # X->A\n        d[3] = tAB            # X->B\n        d[4] = tCDE           # Z->C\n        d[5] = tCDE - tDE     # Z->Y\n        d[6] = tDE            # Y->D\n        d[7] = tDE            # Y->E\n        return d\n\n    # Soft penalty term for root age: k * max(0, tR - M)\n    def soft_penalty(tR, M, k):\n        excess = tR - M\n        return k * excess if excess > 0.0 else 0.0\n\n    # Negative log posterior (up to additive constant)\n    def neg_log_posterior(x, M, k):\n        # x = [log r_1..log r_8, tR, tAB, tCDE, tDE]\n        y = x[:8]\n        t = x[8:]\n        tR, tAB, tCDE, tDE = t\n        # Enforce basic positivity inside objective to avoid invalid logs\n        if tR <= 0 or tAB <= 0 or tCDE <= 0 or tDE <= 0:\n            return 1e20\n        d = durations(t)\n        # If any duration is non-positive, penalize heavily (constraints should prevent this)\n        if np.any(d <= 0):\n            return 1e20\n        r = np.exp(y)\n        # Likelihood term\n        resid = b - r * d\n        ll_term = 0.5 * np.sum((resid / sigma) ** 2)\n        # UCLN prior on rates: sum_i [ (y_i - mu_r)^2/(2 s_r^2) + y_i ]\n        prior_rates = np.sum(((y - mu_r) ** 2) / (2.0 * s_r ** 2) + y)\n        # Root age base lognormal prior: [(log tR - mu_T)^2/(2 s_T^2) + log tR]\n        prior_root = ((np.log(tR) - mu_T) ** 2) / (2.0 * s_T ** 2) + np.log(tR)\n        # Soft maximum penalty\n        soft = soft_penalty(tR, M, k)\n        return ll_term + prior_rates + prior_root + soft\n\n    # Constraints: enforce tree-order and positivity of durations\n    eps = 1e-6\n    def cons_fun(x):\n        tR, tAB, tCDE, tDE = x[8], x[9], x[10], x[11]\n        # c >= 0\n        return np.array([\n            tR - tAB - eps,\n            tR - tCDE - eps,\n            tCDE - tDE - eps,\n            tAB - eps,\n            tDE - eps\n        ], dtype=float)\n\n    nonlin_con = NonlinearConstraint(cons_fun, lb=0.0, ub=np.inf)\n\n    # Bounds: for log rates and ages\n    y_lower = np.full(8, np.log(1e-5))\n    y_upper = np.full(8, np.log(1.0))  # upper rate bound 1 subs/site/time unit\n    # Ages between tiny positive and 5.0 time units\n    t_lower = np.array([1e-6, 1e-6, 1e-6, 1e-6], dtype=float)\n    t_upper = np.array([5.0, 5.0, 5.0, 5.0], dtype=float)\n    lower_bounds = np.concatenate([y_lower, t_lower])\n    upper_bounds = np.concatenate([y_upper, t_upper])\n    bounds = Bounds(lower_bounds, upper_bounds)\n\n    # Initial guess: log rates near baseline, ages plausible\n    y0 = np.full(8, mu_r)\n    t0 = np.array([1.0, 0.6, 0.8, 0.3], dtype=float)\n    x0 = np.concatenate([y0, t0])\n\n    # Test suite: (M, k) pairs\n    test_cases = [\n        (2.0, 0.1),  # loose\n        (1.0, 5.0),  # moderate\n        (0.7, 20.0)  # very tight\n    ]\n\n    results = []\n    for M, k in test_cases:\n        obj = lambda x: neg_log_posterior(x, M, k)\n        res = minimize(\n            obj,\n            x0,\n            method='SLSQP',\n            bounds=bounds,\n            constraints=[nonlin_con],\n            options={'maxiter': 2000, 'ftol': 1e-12, 'disp': False}\n        )\n        # If not successful, try a different method or perturb initial guess\n        if not res.success:\n            # Slight perturbation and retry\n            x0_perturb = x0.copy()\n            x0_perturb[:8] += np.random.default_rng(42).normal(scale=0.05, size=8)\n            x0_perturb[8:] += np.array([0.05, -0.05, 0.0, 0.0])\n            res = minimize(\n                obj,\n                x0_perturb,\n                method='SLSQP',\n                bounds=bounds,\n                constraints=[nonlin_con],\n                options={'maxiter': 3000, 'ftol': 1e-12, 'disp': False}\n            )\n\n        x_star = res.x\n        y_star = x_star[:8]\n        t_star = x_star[8:]\n        r_star = np.exp(y_star)\n        tR_star = t_star[0]\n        rbar_star = float(np.mean(r_star))\n\n        # Round to six decimals\n        tR_rounded = float(f\"{tR_star:.6f}\")\n        rbar_rounded = float(f\"{rbar_star:.6f}\")\n        results.append(tR_rounded)\n        results.append(rbar_rounded)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(lambda v: f'{v:.6f}', results))}]\")\n\nsolve()\n```", "id": "2749338"}]}