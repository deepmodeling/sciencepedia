{"hands_on_practices": [{"introduction": "This first exercise tackles a cornerstone model of population genetics, where we will derive the equilibrium allele frequency difference between two populations subject to divergent selection and symmetric migration. This analytical derivation is a fundamental skill, revealing how the balance between the homogenizing force of migration (rate $m$) and the diversifying force of local selection (strength $s$) determines the degree of genetic differentiation. By working through the weak-migration limit, you will see precisely how the ratio $m/s$ controls the erosion of local adaptation. [@problem_id:2734061]", "problem": "Consider a single biallelic locus with alleles $A$ and $a$ in a spatially structured population consisting of two infinitely large demes connected by symmetric migration at per-generation rate $m$. Within each deme, random mating restores Hardy–Weinberg proportions each generation, and the life cycle is selection followed by migration. Selection is additive and divergent: in deme $1$, the ordered viabilities of genotypes are $1+s$, $1+\\frac{s}{2}$, $1$ for $AA$, $Aa$, $aa$, respectively; in deme $2$ the ordering is reversed, with $1$, $1+\\frac{s}{2}$, $1+s$ for $AA$, $Aa$, $aa$, respectively. Assume $s0$, $m0$, and that $m \\ll s \\ll 1$ so that weak-selection and weak-migration approximations apply and products of small parameters can be neglected at leading order.\n\nLet $p_{1}$ and $p_{2}$ denote the allele $A$ frequencies immediately before selection in demes $1$ and $2$, respectively. At migration–selection balance, let $\\Delta p^{\\ast}=p_{1}^{\\ast}-p_{2}^{\\ast}$ denote the equilibrium allele-frequency difference between the two demes.\n\nStarting only from standard definitions of viability selection and migration and using leading-order approximations justified by $m \\ll s \\ll 1$, derive the asymptotic expression for $\\Delta p^{\\ast}$ as a function of $m$ and $s$ in the limit $m/s \\to 0$, and interpret how the leading dependence on $m/s$ reflects the erosion of local differentiation by migration.\n\nProvide your final result as a single closed-form analytic expression in terms of $m$ and $s$, valid to leading order in the small ratio $m/s$. Do not include higher-order remainder terms. No units are required.", "solution": "The problem statement is subjected to validation.\n\n**Step 1: Extract Givens**\n- **Model:** Single biallelic locus, alleles $A$ and $a$.\n- **Population:** Two infinitely large demes.\n- **Migration:** Symmetric, rate $m$ per generation.\n- **Mating:** Random mating within demes.\n- **Life Cycle:** Selection followed by migration.\n- **Selection:** Additive and divergent.\n- **Viabilities, Deme 1:** $w_{AA,1} = 1+s$, $w_{Aa,1} = 1+\\frac{s}{2}$, $w_{aa,1} = 1$.\n- **Viabilities, Deme 2:** $w_{AA,2} = 1$, $w_{Aa,2} = 1+\\frac{s}{2}$, $w_{aa,2} = 1+s$.\n- **Parameters:** $s0$, $m0$.\n- **Approximations:** $m \\ll s \\ll 1$ (weak selection, weak migration). Products of small parameters are neglected at leading order.\n- **Variables:** $p_{1}$ and $p_{2}$ are allele $A$ frequencies before selection in demes $1$ and $2$.\n- **Objective:** Find the asymptotic expression for the equilibrium allele-frequency difference, $\\Delta p^{\\ast} = p_{1}^{\\ast} - p_{2}^{\\ast}$, in the limit $m/s \\to 0$.\n\n**Step 2: Validate Using Extracted Givens**\n- **Scientific Grounding:** The problem describes a standard two-deme model of migration-selection balance (a variant of the Levene model), a cornerstone of theoretical population genetics. The concepts of viability selection, migration, and allele frequency dynamics are fundamentally sound.\n- **Well-Posedness:** The problem is well-posed. It specifies a deterministic dynamical system and asks for a stable equilibrium state under a specific, well-defined parameter regime ($m \\ll s$). A unique, stable polymorphic equilibrium is known to exist under these conditions.\n- **Objectivity:** The problem is stated in precise, objective mathematical language, free from ambiguity or subjective claims.\n\n**Step 3: Verdict and Action**\nThe problem is valid. It is a standard, non-trivial exercise in mathematical evolutionary theory. A solution will be derived.\n\nThe allele frequency dynamics are determined by the sequential processes of selection and migration within each generation. Let $p_1$ and $p_2$ be the frequencies of allele $A$ in deme $1$ and $2$, respectively, at the start of a generation (before selection).\n\nFirst, we analyze the effect of selection. In deme $1$, selection favors allele $A$. The fitnesses of genotypes $AA$, $Aa$, and $aa$ are $1+s$, $1+s/2$, and $1$. The mean fitness in deme $1$ is $\\bar{w}_1 = p_1^2(1+s) + 2p_1(1-p_1)(1+s/2) + (1-p_1)^2(1) = 1+sp_1$. The frequency of allele $A$ after selection, $p'_1$, is given by:\n$$p'_1 = \\frac{p_1^2(1+s) + p_1(1-p_1)(1+s/2)}{\\bar{w}_1} = \\frac{p_1 + \\frac{s}{2}p_1(1+p_1)}{1+sp_1}$$\nThe change in allele frequency due to selection is $\\Delta_s p_1 = p'_1 - p_1$:\n$$\\Delta_s p_1 = \\frac{p_1 + \\frac{s}{2}p_1(1+p_1) - p_1(1+sp_1)}{1+sp_1} = \\frac{\\frac{s}{2}p_1 - \\frac{s}{2}p_1^2}{1+sp_1} = \\frac{\\frac{s}{2}p_1(1-p_1)}{1+sp_1}$$\nGiven the assumption that selection is weak ($s \\ll 1$), we can approximate the denominator $1+sp_1 \\approx 1$. Thus, to leading order in $s$, the change is:\n$$\\Delta_s p_1 \\approx \\frac{s}{2}p_1(1-p_1)$$\nIn deme $2$, selection favors allele $a$. The fitnesses of $AA$, $Aa$, and $aa$ are $1$, $1+s/2$, and $1+s$. The dynamics for allele $A$ are equivalent to the dynamics for allele $a$ in deme $1$. Letting $q_2 = 1-p_2$ be the frequency of allele $a$ in deme $2$, the change in its frequency is $\\Delta_s q_2 \\approx \\frac{s}{2}q_2(1-q_2)$. The change in frequency of allele $A$ is therefore $\\Delta_s p_2 = -\\Delta_s q_2$.\n$$\\Delta_s p_2 \\approx -\\frac{s}{2}q_2(1-q_2) = -\\frac{s}{2}(1-p_2)p_2$$\nNext, we incorporate migration. The life cycle is selection followed by migration. Migration occurs at a symmetric rate $m$ between the demes. The allele frequencies after migration, $p_1''$ and $p_2''$, are:\n$$p_1'' = (1-m)p'_1 + m p'_2$$\n$$p_2'' = (1-m)p'_2 + m p'_1$$\nThe total change in allele frequency in one generation for deme $1$ is $\\Delta p_1 = p_1'' - p_1$:\n$$\\Delta p_1 = (1-m)(p_1 + \\Delta_s p_1) + m(p_2 + \\Delta_s p_2) - p_1$$\n$$\\Delta p_1 = \\Delta_s p_1 - m(p_1 - p_2) - m\\Delta_s p_1 + m\\Delta_s p_2$$\nThe problem states that products of small parameters ($m$ and $s$) can be neglected at leading order. The terms $m\\Delta_s p_1$ and $m\\Delta_s p_2$ are of order $ms$ and are thus neglected. The recursion for $p_1$ simplifies to:\n$$\\Delta p_1 \\approx \\Delta_s p_1 - m(p_1 - p_2)$$\nAt equilibrium, $\\Delta p_1 = 0$. Let $p_1^*$ and $p_2^*$ denote the equilibrium frequencies. The condition becomes:\n$$\\Delta_s p_1(p_1^*) \\approx m(p_1^* - p_2^*)$$\n$$\\frac{s}{2}p_1^*(1-p_1^*) \\approx m(p_1^* - p_2^*)$$\nA similar analysis for deme $2$ yields $\\Delta p_2 \\approx \\Delta_s p_2 + m(p_1 - p_2)$, which at equilibrium gives:\n$$\\Delta_s p_2(p_2^*) \\approx -m(p_1^* - p_2^*) = m(p_2^* - p_1^*)$$\n$$-\\frac{s}{2}p_2^*(1-p_2^*) \\approx m(p_2^* - p_1^*)$$\nThese two equilibrium conditions are consistent and imply $p_1^*(1-p_1^*) = p_2^*(1-p_2^*)$. This equality admits two solutions: a trivial one $p_1^*=p_2^*$ which is unstable under divergent selection, and a symmetric one $p_1^* = 1 - p_2^*$, or $p_1^* + p_2^* = 1$. This latter solution corresponds to the stable polymorphic equilibrium maintained by migration-selection balance.\n\nWe substitute the symmetry condition $p_2^* = 1 - p_1^*$ into the equilibrium equation for deme $1$:\n$$m(p_1^* - (1-p_1^*)) \\approx \\frac{s}{2}p_1^*(1-p_1^*)$$\n$$m(2p_1^* - 1) \\approx \\frac{s}{2}p_1^*(1-p_1^*)$$\nWe are interested in the limit $m/s \\to 0$, where selection is much stronger than migration. In this regime, we expect the locally favored allele to be near fixation in each deme. Thus, $p_1^* \\to 1$ and $p_2^* \\to 0$. Let $p_1^* = 1-\\epsilon$ and $p_2^* = \\epsilon$ for some small positive quantity $\\epsilon$. The condition $p_1^*+p_2^* = 1$ is automatically satisfied. Substituting $p_1^* = 1-\\epsilon$ into the equilibrium equation:\n$$m(2(1-\\epsilon) - 1) \\approx \\frac{s}{2}(1-\\epsilon)(1 - (1-\\epsilon))$$\n$$m(1 - 2\\epsilon) \\approx \\frac{s}{2}(1-\\epsilon)\\epsilon$$\nSince $m/s \\to 0$, we expect $\\epsilon$ to be small. We can therefore approximate to leading order by taking $\\epsilon \\to 0$ inside the parentheses:\n$$m(1) \\approx \\frac{s}{2}(1)\\epsilon$$\nThis yields a first-order approximation for $\\epsilon$:\n$$\\epsilon \\approx \\frac{2m}{s}$$\nThis confirms that $\\epsilon$ is small when $m/s$ is small.\nThe equilibrium allele frequencies are therefore approximated as:\n$$p_1^* \\approx 1 - \\frac{2m}{s}$$\n$$p_2^* \\approx \\frac{2m}{s}$$\nThe problem asks for the equilibrium allele-frequency difference, $\\Delta p^* = p_1^* - p_2^*$:\n$$\\Delta p^* \\approx \\left(1 - \\frac{2m}{s}\\right) - \\frac{2m}{s} = 1 - \\frac{4m}{s}$$\nThis is the asymptotic expression for $\\Delta p^*$ valid to leading order in the small ratio $m/s$.\n\nInterpretation: The quantity $\\Delta p^*$ measures the extent of genetic differentiation between the two demes. In the absence of migration ($m=0$), selection would drive the locally favored alleles to fixation, resulting in $p_1^*=1$ and $p_2^*=0$, so differentiation would be maximal, $\\Delta p^*=1$. Migration acts as a homogenizing force, counteracting selection by introducing alleles from the other deme. The derived expression $\\Delta p^* \\approx 1 - 4m/s$ shows precisely how this occurs. The deviation from maximal differentiation is $-4m/s$. This leading-order dependence shows that the erosion of local differentiation is directly proportional to the ratio of the migration rate to the selection strength. When migration is weak relative to selection ($m/s \\ll 1$), differentiation remains high, close to $1$.", "answer": "$$\\boxed{1 - \\frac{4m}{s}}$$", "id": "2734061"}, {"introduction": "Building on the core concepts of migration-selection balance, this practice explores a subtle but critical aspect of population genetic modeling: the order of evolutionary events within a life cycle. You will compare the equilibrium allele frequencies in a continent-island model under two different scenarios: one where migration precedes selection, and one where selection precedes migration. This exercise demonstrates that evolutionary processes are not always commutative and that a seemingly minor change in model assumptions can lead to quantitatively different predictions, underscoring the importance of carefully justifying model structure. [@problem_id:2734031]", "problem": "A haploid population inhabits an island that receives migrants every discrete generation from a much larger continent. The continent is fixed for allele $a$. On the island, there are two alleles at a single locus: $A$ (locally adapted) and $a$ (maladapted). Island demography is regulated to constant size after viability selection and migration. Assume an infinite population size and no mutation or genetic drift.\n\nViability selection on the island acts such that the fitness of $A$ is $1$ and the fitness of $a$ is $1 - s$, where $0  s  1$. Each generation, a fraction $m$ of the island individuals are replaced by migrants drawn from the continent, with $0  m  1$. Let $p_t$ denote the frequency of $A$ on the island at generation $t$ just before migration and selection in that generation.\n\nConsider two life cycles that differ only in the order of migration and selection within a generation:\n- Migration-before-selection (denote this order by $\\mathrm{MS}$): migration occurs first, then viability selection.\n- Selection-before-migration (denote this order by $\\mathrm{SM}$): viability selection occurs first, then migration.\n\nStarting only from first principles of haploid viability selection and unidirectional migration (continent-island) and the above definitions, derive the exact deterministic recurrence for $p_{t+1}$ under each life cycle and solve for the nontrivial equilibrium frequency $p^{*}$ of allele $A$ on the island under each order, denoted $p^{*}_{\\mathrm{MS}}$ and $p^{*}_{\\mathrm{SM}}$. Then, working in the asymptotic regime of weak migration relative to selection, where $0  m \\ll s \\ll 1$, determine the leading-order difference\n$$\n\\Delta p^{*} \\equiv p^{*}_{\\mathrm{MS}} - p^{*}_{\\mathrm{SM}}\n$$\nto first order in $m$ and $s$, explicitly neglecting all products of small parameters and higher-order terms (that is, discard all terms of order $m^{2}$, $s^{2}$, and $m s$ and higher). Express your final answer as a single analytic expression in terms of $m$ and $s$. No rounding is required, and the final answer must not include a percent sign.", "solution": "The problem statement must first be validated for scientific soundness, consistency, and completeness.\n\n**Step 1: Extract Givens**\n- Population: Haploid, infinite size, constant size after demography.\n- Model: Continent-island model.\n- Alleles: $A$ (locally adapted) and $a$ (maladapted).\n- Continent: Fixed for allele $a$, frequency of $A$ is $0$.\n- Fitness on island: $w_A = 1$, $w_a = 1-s$, where $0  s  1$.\n- Migration: Unidirectional from continent to island. A fraction $m$ of the island population is replaced by migrants each generation, where $0  m  1$.\n- Variable: $p_t$ is the frequency of allele $A$ on the island at generation $t$ before migration and selection.\n- Life Cycles:\n    1. Migration-before-selection $(\\mathrm{MS})$.\n    2. Selection-before-migration $(\\mathrm{SM})$.\n- Objective:\n    1. Derive the recurrence relation for $p_{t+1}$ for each life cycle.\n    2. Find the nontrivial equilibrium frequency $p^*$ for each life cycle ($p^{*}_{\\mathrm{MS}}$ and $p^{*}_{\\mathrm{SM}}$).\n    3. Determine the leading-order difference $\\Delta p^{*} \\equiv p^{*}_{\\mathrm{MS}} - p^{*}_{\\mathrm{SM}}$ in the asymptotic regime $0  m \\ll s \\ll 1$.\n    4. The approximation is to first order in $m$ and $s$, neglecting all terms of order $m^2$, $s^2$, $ms$, and higher.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is a standard exercise in theoretical population genetics, specifically the analysis of migration-selection balance.\n- **Scientifically Grounded**: The model is a classic and fundamental construct in evolutionary biology for studying the interplay of local adaptation and gene flow. It is scientifically sound.\n- **Well-Posed**: The problem is specified with mathematical precision. All parameters and variables ($m, s, p_t$) are clearly defined. The objectives are specific and admit a unique mathematical solution.\n- **Objective**: The language is technical and devoid of subjective or non-scientific content.\n\nAll other validation criteria are met. The problem does not contain any contradictions, ambiguities, or factual errors.\n\n**Step 3: Verdict and Action**\nThe problem is valid. I will proceed with a full derivation and solution.\n\n**Derivation of Recurrence Relations and Equilibria**\n\nFirst, we define the mean fitness of a population with allele $A$ at frequency $p$ as $\\bar{w}$. For a haploid population, this is:\n$$\n\\bar{w} = p \\cdot w_A + (1-p) \\cdot w_a = p(1) + (1-p)(1-s) = 1 - s(1-p)\n$$\nAfter selection, the new frequency of allele $A$, denoted $p'$, is given by:\n$$\np' = \\frac{p \\cdot w_A}{\\bar{w}} = \\frac{p}{1 - s(1-p)}\n$$\nMigration from the continent, where the frequency of $A$ is $0$, transforms a pre-migration frequency $p$ on the island to a post-migration frequency $p''$:\n$$\np'' = (1-m)p + m(0) = (1-m)p\n$$\n\nWe now analyze the two specified life cycles.\n\n**1. Migration-before-Selection (MS) Life Cycle**\nIn this scenario, migration occurs first, followed by selection.\n- Let $p_t$ be the frequency of $A$ at the start of generation $t$.\n- After migration, the frequency of $A$, let us call it $p_t'$, becomes:\n$$\np_t' = (1-m)p_t\n$$\n- Selection then acts on this post-migration population. The frequency of $A$ at the start of generation $t+1$, which is $p_{t+1}$, is:\n$$\np_{t+1} = \\frac{p_t' \\cdot w_A}{p_t' \\cdot w_A + (1-p_t') \\cdot w_a} = \\frac{(1-m)p_t}{1 - s(1-p_t')} = \\frac{(1-m)p_t}{1 - s(1 - (1-m)p_t)}\n$$\nThis is the recurrence relation for the MS model.\n\nTo find the equilibrium frequency $p^{*}_{\\mathrm{MS}}$, we set $p_{t+1} = p_t = p^*$:\n$$\np^* = \\frac{(1-m)p^*}{1 - s(1 - (1-m)p^*)}\n$$\nThis equation has a trivial solution $p^* = 0$. For the nontrivial solution ($p^* \\neq 0$), we can divide by $p^*$:\n$$\n1 = \\frac{1-m}{1 - s(1 - (1-m)p^*)}\n$$\n$$\n1 - s(1 - (1-m)p^*) = 1-m\n$$\n$$\n1 - s + s(1-m)p^* = 1-m\n$$\n$$\ns(1-m)p^* = s-m\n$$\nSolving for $p^*$, we find the nontrivial equilibrium frequency for the MS model:\n$$\np^{*}_{\\mathrm{MS}} = \\frac{s-m}{s(1-m)}\n$$\n\n**2. Selection-before-Migration (SM) Life Cycle**\nIn this scenario, selection occurs first, followed by migration.\n- Let $p_t$ be the frequency of $A$ at the start of generation $t$.\n- After selection, the frequency of $A$, let us call it $p_t''$, becomes:\n$$\np_t'' = \\frac{p_t \\cdot w_A}{\\bar{w}} = \\frac{p_t}{1-s(1-p_t)}\n$$\n- Migration then acts on this post-selection population. The frequency of $A$ at the start of generation $t+1$ is:\n$$\np_{t+1} = (1-m)p_t'' = (1-m)\\frac{p_t}{1-s(1-p_t)}\n$$\nThis is the recurrence relation for the SM model.\n\nTo find the equilibrium frequency $p^{*}_{\\mathrm{SM}}$, we set $p_{t+1} = p_t = p^*$:\n$$\np^* = (1-m)\\frac{p^*}{1-s(1-p^*)}\n$$\nThis again has a trivial solution $p^*=0$. For the nontrivial solution ($p^* \\neq 0$), we divide by $p^*$:\n$$\n1 = \\frac{1-m}{1-s(1-p^*)}\n$$\n$$\n1-s(1-p^*) = 1-m\n$$\n$$\n1-s+sp^* = 1-m\n$$\n$$\nsp^* = s-m\n$$\nSolving for $p^*$, we find the nontrivial equilibrium frequency for the SM model:\n$$\np^{*}_{\\mathrm{SM}} = \\frac{s-m}{s} = 1 - \\frac{m}{s}\n$$\n\n**Analysis of the Difference in Equilibria**\nWe are asked to find the leading-order difference $\\Delta p^{*} \\equiv p^{*}_{\\mathrm{MS}} - p^{*}_{\\mathrm{SM}}$ in the regime $0  m \\ll s \\ll 1$. First, we compute the exact difference:\n$$\n\\Delta p^{*} = p^{*}_{\\mathrm{MS}} - p^{*}_{\\mathrm{SM}} = \\frac{s-m}{s(1-m)} - \\frac{s-m}{s}\n$$\nFactor out the common term $\\frac{s-m}{s}$:\n$$\n\\Delta p^{*} = \\left(\\frac{s-m}{s}\\right) \\left(\\frac{1}{1-m} - 1\\right) = \\left(\\frac{s-m}{s}\\right) \\left(\\frac{1 - (1-m)}{1-m}\\right) = \\left(\\frac{s-m}{s}\\right) \\left(\\frac{m}{1-m}\\right)\n$$\nThis gives the exact analytical expression for the difference:\n$$\n\\Delta p^{*} = \\frac{m(s-m)}{s(1-m)}\n$$\nNow, we must find the leading-order approximation of this expression under the condition $0  m \\ll s \\ll 1$. This condition implies that $m$, $s$, and the ratio $m/s$ are all small parameters much less than $1$. We can expand the expression for $\\Delta p^{*}$ in terms of these small parameters.\nLet us rewrite the expression as:\n$$\n\\Delta p^{*} = \\frac{ms - m^2}{s - sm}\n$$\nTo find the leading-order behavior, we can approximate the numerator and the denominator.\nIn the numerator, $ms - m^2$, the term $m^2$ is much smaller than $ms$ because $m \\ll s \\implies m^2 \\ll ms$. Thus, the numerator is approximately $ms$.\nIn the denominator, $s - sm$, the term $sm$ is much smaller than $s$ because $m \\ll 1$. Thus, the denominator is approximately $s$.\nCombining these approximations, we find the leading-order behavior of the difference:\n$$\n\\Delta p^{*} \\approx \\frac{ms}{s} = m\n$$\nAlternatively, we can perform a Taylor expansion. We have $\\Delta p^{*} = m \\left(\\frac{s-m}{s}\\right) \\left(\\frac{1}{1-m}\\right) = m \\left(1-\\frac{m}{s}\\right) (1-m)^{-1}$.\nUsing the geometric series expansion $(1-m)^{-1} = 1+m+m^2+\\dots$ for small $m$:\n$$\n\\Delta p^{*} = m \\left(1-\\frac{m}{s}\\right) (1+m+O(m^2)) = m \\left(1+m - \\frac{m}{s} - \\frac{m^2}{s} + \\dots \\right)\n$$\n$$\n\\Delta p^{*} = m + m^2 - \\frac{m^2}{s} - \\frac{m^3}{s} + \\dots\n$$\nThe problem asks for the leading-order difference, which is the dominant term in this expansion as $m, s \\to 0$ under the constraint $m \\ll s$. The terms are $m$, $m^2$, and $-m^2/s$.\n- The term $m$ is first-order in $m$.\n- The term $m^2$ is second-order in $m$.\n- The term $-m^2/s = -m(m/s)$ is a product of two small quantities, $m$ and $m/s$. It is of higher order than $m$.\nThe instruction states to neglect terms of order $m^2$, $s^2$, $ms$ and higher. Both $m^2$ and $m^2/s$ are higher-order terms compared to $m$. Specifically, $m^2/s$ can be considered of order $m \\cdot (m/s)$, a product of small parameters as per the instruction's intent. Therefore, these terms are neglected.\nThe leading-order term is simply $m$.\nThis result indicates that, to first order, the equilibrium frequency of the locally adapted allele is higher by a quantity $m$ when selection precedes migration, as selection can more effectively increase the frequency of the adapted allele before it is diluted by maladapted migrants.", "answer": "$$\n\\boxed{m}\n$$", "id": "2734031"}, {"introduction": "In this final practice, we bridge theory and data analysis by applying the concepts from the previous exercise to a practical, computational problem. You will implement a Bayesian framework to perform model selection, determining whether a \"migration-before-selection\" or \"selection-before-migration\" model provides a better fit to simulated population genetic data. This hands-on coding task will equip you with the skills to use modern statistical methods for testing theoretical assumptions and inferring evolutionary parameters, a crucial capability in contemporary evolutionary biology. [@problem_id:2734038]", "problem": "Consider a single-locus, two-allele, haploid island model with migration and viability selection in a large resident population exchanging migrants with an external immigrant pool whose allele frequency is known. Let the focal allele be denoted by $A$, with frequency $p$ in each resident deme, and by $p_{\\mathrm{m}}$ in the immigrant pool. Let the resident demes be indexed by $j \\in \\{1,\\dots,D\\}$. Assume the following.\n\n- Fundamental base:\n  - Viability selection in haploids is defined by allele-specific relative fitnesses. If $A$ has relative fitness $1+s$ and the alternative allele has fitness $1$, then after selection the allele frequency is proportional to fitness-weighted frequencies. Specifically, the post-selection frequency is the frequency of $A$ after weighting by relative fitness and normalizing by the mean fitness.\n  - Passive migration is mass-action mixing: with migration rate $m \\in [0,1]$, a fraction $m$ of alleles are replaced by immigrants with frequency $p_{\\mathrm{m}}$, and the remaining fraction $1-m$ remain resident.\n  - Observations are generated by binomial sampling: if the expected allele frequency in deme $j$ at the time of sampling is $p'_j$, then observing $x_j$ copies of $A$ in a sample of size $n_j$ has probability given by the binomial distribution with success probability $p'_j$.\n- Two competing life-cycle models are considered:\n  - Model $\\mathcal{M}_{\\mathrm{ms}}$: migration occurs before selection in each generation.\n  - Model $\\mathcal{M}_{\\mathrm{sm}}$: selection occurs before migration in each generation.\n\nSuppose you observe, for each deme $j$, the initial resident allele frequency $p_{0,j}$ immediately before the focal life-cycle stage, the immigrant pool allele frequency $p_{\\mathrm{m},j}$ relevant to deme $j$ (possibly identical across demes), and the sample count $x_j$ of allele $A$ out of $n_j$ sampled immediately after the focal life-cycle stage. Assume conditional independence of demes given parameters.\n\nYour task is to perform Bayesian model comparison between $\\mathcal{M}_{\\mathrm{ms}}$ and $\\mathcal{M}_{\\mathrm{sm}}$ and to evaluate the robustness of inferred migration rate $m$ and selection coefficient $s$ to the ordering of migration and selection.\n\nRequirements:\n\n- Priors:\n  - Place a uniform prior on $m$ over $[0,0.5]$ and a uniform prior on $s$ over $[-0.2,0.5]$. Assume an equal prior over the two models, $\\Pr(\\mathcal{M}_{\\mathrm{ms}}) = \\Pr(\\mathcal{M}_{\\mathrm{sm}}) = 0.5$.\n- Likelihood under a given model:\n  - For each deme $j$, derive the expected post-stage frequency $p'_j$ from the fundamental base definitions by composing selection and migration in the order specified by the model. Then compute the binomial sampling likelihood for observing $x_j$ out of $n_j$ given $p'_j$, and assume independence across demes to obtain the full likelihood. Express all probabilities as decimals, not percentages.\n- Evidence and posteriors:\n  - Compute the marginal likelihood (evidence) for each model by numerically integrating the likelihood over $(m,s)$ with the specified uniform priors. Use a rectangular grid with $201$ evenly spaced points for $m \\in [0,0.5]$ and $251$ evenly spaced points for $s \\in [-0.2,0.5]$. Perform the numerical integration by Riemann summation over the grid and ensure numerical stability (for example, by operating in log space and using a log-sum-exp approach).\n  - Compute the posterior model probabilities $\\Pr(\\mathcal{M}_{\\mathrm{ms}} \\mid \\text{data})$ and $\\Pr(\\mathcal{M}_{\\mathrm{sm}} \\mid \\text{data})$ from the evidences and equal model priors.\n  - Under each model, compute the posterior means $\\mathbb{E}[m \\mid \\text{data}, \\mathcal{M}]$ and $\\mathbb{E}[s \\mid \\text{data}, \\mathcal{M}]$ using the same grid and posterior weights proportional to the likelihood times the prior.\n- Output format:\n  - For each test case in the test suite below, output a list of six floats in the order: $[\\Pr(\\mathcal{M}_{\\mathrm{ms}} \\mid \\text{data}), \\Pr(\\mathcal{M}_{\\mathrm{sm}} \\mid \\text{data}), \\mathbb{E}[m \\mid \\text{data}, \\mathcal{M}_{\\mathrm{ms}}], \\mathbb{E}[s \\mid \\text{data}, \\mathcal{M}_{\\mathrm{ms}}], \\mathbb{E}[m \\mid \\text{data}, \\mathcal{M}_{\\mathrm{sm}}], \\mathbb{E}[s \\mid \\text{data}, \\mathcal{M}_{\\mathrm{sm}}]]$.\n  - Your program should produce a single line of output containing the results for all test cases as a comma-separated list enclosed in square brackets, where each element is the six-float list for one test case, and each float rounded to $6$ decimal places, for example: $[[0.500000,0.500000,0.100000,0.200000,0.100000,0.200000],\\dots]$.\n\nTest suite:\n\n- Case $1$ (migration-before-selection generates the data):\n  - Demes: $D=3$.\n  - Initial resident frequencies: $p_{0} = [0.2, 0.4, 0.6]$.\n  - Immigrant pool frequency: $p_{\\mathrm{m}} = 0.8$ (identical across demes).\n  - Sample sizes: $n = [100, 100, 100]$.\n  - Observed counts: $x = [30, 49, 66]$.\n\n- Case $2$ (selection-before-migration generates the data):\n  - Demes: $D=3$.\n  - Initial resident frequencies: $p_{0} = [0.1, 0.5, 0.9]$.\n  - Immigrant pool frequency: $p_{\\mathrm{m}} = 0.2$.\n  - Sample sizes: $n = [200, 200, 200]$.\n  - Observed counts: $x = [24, 104, 175]$.\n\n- Case $3$ (neutral selection, order irrelevance edge case):\n  - Demes: $D=2$.\n  - Initial resident frequencies: $p_{0} = [0.3, 0.7]$.\n  - Immigrant pool frequency: $p_{\\mathrm{m}} = 0.5$.\n  - Sample sizes: $n = [150, 150]$.\n  - Observed counts: $x = [51, 99]$.\n\n- Case $4$ (high migration dominates, weak order effect):\n  - Demes: $D=3$.\n  - Initial resident frequencies: $p_{0} = [0.0, 0.2, 0.4]$.\n  - Immigrant pool frequency: $p_{\\mathrm{m}} = 0.6$.\n  - Sample sizes: $n = [100, 100, 100]$.\n  - Observed counts: $x = [29, 42, 55]$.\n\nAngle units are not applicable. No physical units are involved. All probabilities must be decimals. Your program must implement the above specifications and produce the single-line output of the aggregated list in the exact format described, with each float rounded to $6$ decimal places.", "solution": "The problem is subjected to validation and is found to be scientifically grounded, well-posed, and complete. It represents a standard exercise in computational population genetics, involving Bayesian model comparison and parameter estimation. All necessary data, models, and prior distributions are specified. There are no contradictions or ambiguities. I shall therefore proceed with a complete solution.\n\nThe core of the problem is to compare two competing models for the joint action of migration and natural selection on a haploid population. The models differ in the order of these two evolutionary processes within a generation.\n\nFirst, we define the operators for selection and migration.\nLet $p$ be the frequency of allele $A$ before an evolutionary process.\nThe frequency after viability selection, $p_s$, with relative fitness of $A$ being $1+s$ and the alternative allele being $1$, is given by:\n$$p_s = \\mathcal{S}(p, s) = \\frac{p(1+s)}{p(1+s) + (1-p)(1)} = \\frac{p(1+s)}{1+ps}$$\nThe frequency after migration, $p_m$, where a fraction $m$ of the population is replaced by immigrants with allele frequency $p_{\\mathrm{m}}$, is given by:\n$$p_m = \\mathcal{M}(p, m, p_{\\mathrm{m}}) = (1-m)p + m p_{\\mathrm{m}}$$\nThese definitions are valid for $s  -1$, $m \\in [0,1]$, and frequencies $p, p_{\\mathrm{m}} \\in [0,1]$. The problem constraints on $s \\in [-0.2, 0.5]$ and $m \\in [0, 0.5]$ ensure the validity of these expressions.\n\nNext, we formulate the expected post-stage allele frequency, $p'_j$, for each deme $j$ under the two models. The initial allele frequency is $p_{0,j}$ and the immigrant frequency is $p_{\\mathrm{m},j}$.\n\nModel $\\mathcal{M}_{\\mathrm{ms}}$ (Migration-before-Selection):\nThe allele frequency is first altered by migration and then by selection.\n$$p'_{\\mathrm{ms}, j}(m, s) = \\mathcal{S}(\\mathcal{M}(p_{0,j}, m, p_{\\mathrm{m},j}), s) = \\frac{((1-m)p_{0,j} + m p_{\\mathrm{m},j})(1+s)}{1 + s((1-m)p_{0,j} + m p_{\\mathrm{m},j})}$$\n\nModel $\\mathcal{M}_{\\mathrm{sm}}$ (Selection-before-Migration):\nThe allele frequency is first altered by selection and then by migration.\n$$p'_{\\mathrm{sm}, j}(m, s) = \\mathcal{M}(\\mathcal{S}(p_{0,j}, s), m, p_{\\mathrm{m},j}) = (1-m)\\left(\\frac{p_{0,j}(1+s)}{1+p_{0,j}s}\\right) + m p_{\\mathrm{m},j}$$\n\nThe likelihood of observing the data for a given model $\\mathcal{M}_k$ (where $k \\in \\{\\text{ms, sm}\\}$) and parameters $(m, s)$ is based on binomial sampling. Assuming independence across the $D$ demes, the total likelihood is the product of the individual binomial probabilities:\n$$L(m,s \\mid \\text{data}, \\mathcal{M}_k) = \\prod_{j=1}^D P(x_j \\mid n_j, p'_{k,j}(m,s)) = \\prod_{j=1}^D \\binom{n_j}{x_j} (p'_{k,j})^{x_j} (1-p'_{k,j})^{n_j - x_j}$$\nFor numerical computation, we use the log-likelihood. The term involving the binomial coefficient, $\\sum_j \\log\\binom{n_j}{x_j}$, is constant with respect to model parameters and is identical for both models. Therefore, it cancels when computing posterior model probabilities and can be omitted when calculating posterior means. We define the partial log-likelihood $J_k(m,s)$ as:\n$$J_k(m,s) = \\log L^*(m,s \\mid \\text{data}, \\mathcal{M}_k) = \\sum_{j=1}^D \\left[ x_j \\log(p'_{k,j}(m,s)) + (n_j-x_j)\\log(1-p'_{k,j}(m,s)) \\right]$$\nThe analysis is performed over a discrete grid of parameter values: $m$ on $N_m = 201$ points in $[0, 0.5]$, and $s$ on $N_s = 251$ points in $[-0.2, 0.5]$.\n\nTo perform Bayesian model comparison, we compute the marginal likelihood (evidence) for each model, $\\Pr(\\text{data} \\mid \\mathcal{M}_k)$. This is obtained by integrating the likelihood over the prior distributions.\n$$\\Pr(\\text{data} \\mid \\mathcal{M}_k) = \\int_{-0.2}^{0.5} \\int_0^{0.5} L(m,s \\mid \\text{data}, \\mathcal{M}_k) \\pi(m,s) \\,dm \\,ds$$\nGiven uniform priors, $\\pi(m,s)$ is a constant. The integral is approximated by a Riemann sum over the parameter grid:\n$$\\Pr(\\text{data} \\mid \\mathcal{M}_k) \\propto \\sum_i \\sum_l L(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)$$\nLet $U_k = \\sum_{i,l} L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)$. Since model priors are equal, $\\Pr(\\mathcal{M}_{\\mathrm{ms}}) = \\Pr(\\mathcal{M}_{\\mathrm{sm}}) = 0.5$, the posterior probability of a model is proportional to its evidence:\n$$\\Pr(\\mathcal{M}_{\\mathrm{ms}} \\mid \\text{data}) = \\frac{U_{\\mathrm{ms}}}{U_{\\mathrm{ms}} + U_{\\mathrm{sm}}}$$\n$$\\Pr(\\mathcal{M}_{\\mathrm{sm}} \\mid \\text{data}) = \\frac{U_{\\mathrm{sm}}}{U_{\\mathrm{ms}} + U_{\\mathrm{sm}}}$$\nTo compute these sums stably, we use the log-sum-exp trick. We compute the grid of log-likelihoods $J_k(m_i, s_l)$, find the maximum value $J_{k, \\text{max}}$, and then compute the sum of exponentiated values relative to this maximum. Let $\\log U_k = J_{k, \\text{max}} + \\log\\left(\\sum_{i,l} \\exp(J_k(m_i, s_l) - J_{k, \\text{max}})\\right)$. The posterior probability for $\\mathcal{M}_{\\mathrm{ms}}$ becomes:\n$$\\Pr(\\mathcal{M}_{\\mathrm{ms}} \\mid \\text{data}) = \\frac{1}{1 + \\exp(\\log U_{\\mathrm{sm}} - \\log U_{\\mathrm{ms}})}$$\n\nThe posterior mean of a parameter, say $m$, under model $\\mathcal{M}_k$ is computed as a weighted average over the grid, where the weights are the posterior probabilities at each grid point, which are proportional to the likelihood values $L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)$.\n$$\\mathbb{E}[m \\mid \\text{data}, \\mathcal{M}_k] \\approx \\frac{\\sum_{i,l} m_i L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)}{\\sum_{i,l} L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)}$$\n$$\\mathbb{E}[s \\mid \\text{data}, \\mathcal{M}_k] \\approx \\frac{\\sum_{i,l} s_l L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)}{\\sum_{i,l} L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)}$$\nThese calculations are also performed using the numerically stable weights derived from the log-likelihood grid. The implementation will proceed by vectorizing these calculations over the parameter grid for efficiency.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the Bayesian model comparison problem for all test cases.\n    \"\"\"\n    test_cases = [\n        # Case 1 (migration-before-selection generates the data)\n        {\n            \"p0\": np.array([0.2, 0.4, 0.6]),\n            \"pm\": 0.8,\n            \"n\": np.array([100, 100, 100]),\n            \"x\": np.array([30, 49, 66]),\n        },\n        # Case 2 (selection-before-migration generates the data)\n        {\n            \"p0\": np.array([0.1, 0.5, 0.9]),\n            \"pm\": 0.2,\n            \"n\": np.array([200, 200, 200]),\n            \"x\": np.array([24, 104, 175]),\n        },\n        # Case 3 (neutral selection, order irrelevance edge case)\n        {\n            \"p0\": np.array([0.3, 0.7]),\n            \"pm\": 0.5,\n            \"n\": np.array([150, 150]),\n            \"x\": np.array([51, 99]),\n        },\n        # Case 4 (high migration dominates, weak order effect)\n        {\n            \"p0\": np.array([0.0, 0.2, 0.4]),\n            \"pm\": 0.6,\n            \"n\": np.array([100, 100, 100]),\n            \"x\": np.array([29, 42, 55]),\n        },\n    ]\n\n    # Define the parameter grid\n    m_grid = np.linspace(0, 0.5, 201)\n    s_grid = np.linspace(-0.2, 0.5, 251)\n    M, S = np.meshgrid(m_grid, s_grid, indexing='ij')\n\n    results = []\n    for case in test_cases:\n        p0, pm, n, x = case[\"p0\"], case[\"pm\"], case[\"n\"], case[\"x\"]\n\n        # Analyze Model M_ms (migration-before-selection)\n        log_evidence_sum_ms, E_m_ms, E_s_ms = analyze_model(\n            p_prime_ms, p0, pm, n, x, M, S\n        )\n\n        # Analyze Model M_sm (selection-before-migration)\n        log_evidence_sum_sm, E_m_sm, E_s_sm = analyze_model(\n            p_prime_sm, p0, pm, n, x, M, S\n        )\n\n        # Calculate posterior model probabilities\n        # Pr(M_ms | data) = E_ms / (E_ms + E_sm) = 1 / (1 + E_sm/E_ms)\n        # log(E_sm/E_ms) = log(E_sm) - log(E_ms)\n        log_ratio = log_evidence_sum_sm - log_evidence_sum_ms\n        \n        # Handle potential overflow/underflow if differences are very large\n        if log_ratio > 700: # exp(700) is large\n            p_ms = 0.0\n        elif log_ratio  -700:\n            p_ms = 1.0\n        else:\n            p_ms = 1.0 / (1.0 + np.exp(log_ratio))\n        \n        p_sm = 1.0 - p_ms\n\n        case_results = [p_ms, p_sm, E_m_ms, E_s_ms, E_m_sm, E_s_sm]\n        results.append(case_results)\n\n    # Format output\n    formatted_results = []\n    for res_list in results:\n        formatted_list_str = \"[\" + \",\".join([f\"{val:.6f}\" for val in res_list]) + \"]\"\n        formatted_results.append(formatted_list_str)\n\n    print(f\"[{','.join(formatted_results)}]\")\n\ndef p_prime_ms(p0_deme, pm, M, S):\n    \"\"\"Calculates final allele frequency for the Migration-before-Selection model.\"\"\"\n    p_post_mig = (1 - M) * p0_deme + M * pm\n    # Denominator 1 + p_post_mig * S is always > 0 for s > -1\n    return (p_post_mig * (1 + S)) / (1 + p_post_mig * S)\n\ndef p_prime_sm(p0_deme, pm, M, S):\n    \"\"\"Calculates final allele frequency for the Selection-before-Migration model.\"\"\"\n    # Denominator 1 + p0_deme * S is always > 0 for s > -1\n    p_post_sel = (p0_deme * (1 + S)) / (1 + p0_deme * S)\n    return (1 - M) * p_post_sel + M * pm\n\ndef analyze_model(model_func, p0, pm, n, x, M, S):\n    \"\"\"\n    Computes log-evidence sum and posterior means for a given model.\n    \"\"\"\n    total_log_likelihood = np.zeros_like(M)\n\n    for j in range(len(p0)):\n        # Calculate expected frequency grid for deme j\n        p_prime_grid = model_func(p0[j], pm, M, S)\n        \n        # Clip for numerical stability of log\n        p_prime_grid = np.clip(p_prime_grid, 1e-12, 1.0 - 1e-12)\n        \n        # Calculate log-likelihood for deme j and add to total\n        deme_log_L = x[j] * np.log(p_prime_grid) + (n[j] - x[j]) * np.log(1.0 - p_prime_grid)\n        total_log_likelihood += deme_log_L\n    \n    # Use log-sum-exp for stable computation of evidence and posterior means\n    log_L_max = np.max(total_log_likelihood)\n    weights = np.exp(total_log_likelihood - log_L_max)\n    total_weight = np.sum(weights)\n\n    log_evidence_sum = log_L_max + np.log(total_weight)\n\n    # Posterior means\n    E_m = np.sum(weights * M) / total_weight\n    E_s = np.sum(weights * S) / total_weight\n\n    return log_evidence_sum, E_m, E_s\n\nsolve()\n```", "id": "2734038"}]}