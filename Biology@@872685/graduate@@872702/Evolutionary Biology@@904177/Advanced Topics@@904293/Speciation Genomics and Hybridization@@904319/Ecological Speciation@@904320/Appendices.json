{"hands_on_practices": [{"introduction": "Speciation is the culmination of barriers that prevent gene flow. To understand the speciation process, it is essential to quantify the total strength of reproductive isolation and identify the relative importance of its different components. This exercise [@problem_id:2702584] provides practice with the standard multiplicative model for sequential barriers, a fundamental tool for summarizing empirical data. By applying sensitivity analysis, you will also learn how to determine which barriers—from habitat choice to hybrid sterility—contribute most significantly to the overall isolation, guiding future research efforts.", "problem": "A pair of diverging insect species experiences multiple, sequential reproductive barriers associated with ecological speciation. Each barrier excludes a fraction of potential interspecific gene flow conditional on having passed all prior barriers. Assume independence among barriers and no frequency dependence, so that the expected fraction of potential gene flow surviving all barriers equals the product of the stage-specific survival fractions. Under this standard sequential barrier framework, overall reproductive isolation is the complement of that surviving fraction.\n\nYou are given the following barrier effects, each defined as the isolation fraction at its stage (i.e., the proportion of potential interspecific gene flow excluded at that stage, conditional on not being excluded earlier). Use the index mapping $i \\in \\{1,\\dots,7\\}$:\n- $i=1$: habitat isolation, $I_{1} = 0.70$\n- $i=2$: temporal isolation, $I_{2} = 0.25$\n- $i=3$: behavioral isolation, $I_{3} = 0.55$\n- $i=4$: mechanical isolation, $I_{4} = 0.15$\n- $i=5$: gametic isolation, $I_{5} = 0.45$\n- $i=6$: hybrid inviability, $I_{6} = 0.40$\n- $i=7$: hybrid sterility, $I_{7} = 0.60$\n\nTasks:\n1) Starting from the definitions above, derive an expression for overall reproductive isolation as a function of the barrier effects $I_{1},\\dots,I_{7}$, and compute its value for the given data.\n2) Perform a local, first-order sensitivity analysis by computing the partial derivatives of overall reproductive isolation with respect to each $I_{i}$, evaluated at the given data. Identify the barrier index $i^{\\ast}$ with the largest absolute first-order sensitivity.\n\nReport only the integer $i^{\\ast}$ as your final answer. Do not include units. No rounding is required for the final answer.", "solution": "The problem as stated is scientifically grounded, well-posed, and objective. It presents a standard model of sequential reproductive isolation used in evolutionary biology. All necessary data and definitions are provided, and the problem is internally consistent. Therefore, a solution will be provided.\n\nLet $I_{i}$ be the reproductive isolation fraction at stage $i$, for $i \\in \\{1, 2, \\dots, 7\\}$. This represents the proportion of potential gene flow that is blocked at stage $i$, conditional on having passed all prior stages. The fraction of gene flow that *survives* stage $i$, denoted by $S_{i}$, is the complement of $I_{i}$:\n$$S_{i} = 1 - I_{i}$$\nThe problem states that the total fraction of gene flow surviving all barriers, $S_{total}$, is the product of the stage-specific survival fractions, a consequence of the assumption of independence.\n$$S_{total} = \\prod_{i=1}^{7} S_{i} = \\prod_{i=1}^{7} (1 - I_{i})$$\nOverall reproductive isolation, $I_{total}$, is defined as the complement of the total surviving fraction $S_{total}$.\n$$I_{total} = 1 - S_{total}$$\nSubstituting the expression for $S_{total}$ yields the expression for overall reproductive isolation as a function of the individual barrier effects $I_{i}$. This completes the first part of Task 1.\n$$I_{total}(I_{1}, \\dots, I_{7}) = 1 - \\prod_{i=1}^{7} (1 - I_{i})$$\nUsing the provided data:\n$I_{1} = 0.70$, $I_{2} = 0.25$, $I_{3} = 0.55$, $I_{4} = 0.15$, $I_{5} = 0.45$, $I_{6} = 0.40$, $I_{7} = 0.60$.\nThe corresponding survival fractions are:\n$S_{1} = 1 - 0.70 = 0.30$\n$S_{2} = 1 - 0.25 = 0.75$\n$S_{3} = 1 - 0.55 = 0.45$\n$S_{4} = 1 - 0.15 = 0.85$\n$S_{5} = 1 - 0.45 = 0.55$\n$S_{6} = 1 - 0.40 = 0.60$\n$S_{7} = 1 - 0.60 = 0.40$\nThe total survival fraction is:\n$S_{total} = (0.30)(0.75)(0.45)(0.85)(0.55)(0.60)(0.40) = 0.01136025$\nThe overall reproductive isolation is:\n$I_{total} = 1 - S_{total} = 1 - 0.01136025 = 0.98863975$\n\nFor Task 2, we must perform a local, first-order sensitivity analysis. This requires computing the partial derivative of $I_{total}$ with respect to each barrier effect $I_{k}$, for $k \\in \\{1, 2, \\dots, 7\\}$.\nThe sensitivity of $I_{total}$ to a change in $I_{k}$ is given by the partial derivative $\\frac{\\partial I_{total}}{\\partial I_{k}}$.\n$$\\frac{\\partial I_{total}}{\\partial I_{k}} = \\frac{\\partial}{\\partial I_{k}} \\left( 1 - \\prod_{i=1}^{7} (1 - I_{i}) \\right)$$\nThe derivative of the constant $1$ is $0$.\n$$\\frac{\\partial I_{total}}{\\partial I_{k}} = - \\frac{\\partial}{\\partial I_{k}} \\left( (1 - I_{1}) \\dots (1 - I_{k}) \\dots (1 - I_{7}) \\right)$$\nUsing the product rule for differentiation, we treat all terms $(1 - I_{i})$ where $i \\neq k$ as constants with respect to $I_{k}$.\n$$\\frac{\\partial I_{total}}{\\partial I_{k}} = - \\left( \\prod_{i \\neq k} (1 - I_{i}) \\right) \\frac{\\partial}{\\partial I_{k}} (1 - I_{k})$$\nThe derivative of $(1 - I_{k})$ with respect to $I_{k}$ is $-1$.\n$$\\frac{\\partial I_{total}}{\\partial I_{k}} = - \\left( \\prod_{i \\neq k} (1 - I_{i}) \\right) (-1) = \\prod_{i \\neq k} (1 - I_{i})$$\nThis derivative represents the proportion of gene flow that successfully passes all barriers except for barrier $k$. It is the amount of gene flow \"at risk\" of being blocked by barrier $k$. An alternative way to express this derivative is by using $S_{total}$:\n$$\\frac{\\partial I_{total}}{\\partial I_{k}} = \\frac{\\prod_{i=1}^{7} (1 - I_{i})}{1 - I_{k}} = \\frac{S_{total}}{1 - I_{k}}$$\nWe seek the barrier index $i^{\\ast}$ that has the largest absolute first-order sensitivity. Since $I_{i} < 1$ for all $i$, the survival fractions $(1 - I_{i})$ are all positive. Therefore, the partial derivative $\\frac{\\partial I_{total}}{\\partial I_{k}}$ is always positive, and its absolute value is simply the derivative itself.\nTo find the maximum sensitivity, we must find the index $k$ that maximizes the expression $\\frac{S_{total}}{1 - I_{k}}$. Since $S_{total}$ is a positive constant with respect to the index $k$, maximizing this fraction is equivalent to minimizing its denominator, $(1 - I_{k})$. Minimizing $(1 - I_{k})$ is, in turn, equivalent to maximizing the isolation fraction $I_{k}$.\n\nWe now inspect the given values of $I_{i}$:\n$I_{1} = 0.70$\n$I_{2} = 0.25$\n$I_{3} = 0.55$\n$I_{4} = 0.15$\n$I_{5} = 0.45$\n$I_{6} = 0.40$\n$I_{7} = 0.60$\n\nThe maximum value among these is $I_{1} = 0.70$. Therefore, the overall reproductive isolation $I_{total}$ is most sensitive to changes in the first barrier, habitat isolation. The index corresponding to this barrier is $1$.\nThus, $i^{\\ast} = 1$.", "answer": "$$\\boxed{1}$$", "id": "2702584"}, {"introduction": "A central pillar of ecological speciation is the idea that divergent selection on traits drives the evolution of reproductive isolation. A powerful method to test for this is to compare the level of differentiation in a quantitative trait, denoted $Q_{ST}$, with the baseline differentiation at neutral genetic markers, $F_{ST}$. This problem [@problem_id:2702632] walks you through the calculation of $Q_{ST}$ from genetic variance components, a key skill in evolutionary quantitative genetics. By comparing your $Q_{ST}$ estimate to a neutral benchmark, you will practice making a formal inference about whether a trait is under divergent selection, a critical line of evidence in studies of adaptation and speciation.", "problem": "A perennial plant species inhabits three contrasting microhabitats has been sampled from $3$ geographically proximate populations that occupy distinct soil regimes and exhibit ecological differentiation. To assess whether a focal quantitative trait is experiencing divergent selection consistent with ecological speciation, you conduct a common garden experiment with replicated maternal sibships and fit an individual-level additive genetic “animal model” to the focal trait using known pedigree. From the fitted model, you obtain the following additive genetic variance components, each expressed on the breeding-value scale and assumed to be homogeneous across populations:\n\n- Additive genetic variance among population mean breeding values: $V_{A,B} = 0.18$.\n- Additive genetic variance within populations: $V_{A,W} = 0.42$.\n\nBecause the common garden removes environmental differences among populations, between-population differences in trait means reflect genetic differentiation. Assume additivity, random mating within populations, and equal within-population additive genetic variance across populations.\n\nGenome-wide neutral divergence was estimated from $12{,}000$ single-nucleotide polymorphisms using a block bootstrap over loci. The bootstrapped empirical $95\\%$ confidence interval for the genome-wide Wright fixation index is [$F_{ST}^{(0.025)}$, $F_{ST}^{(0.975)}$] = [0.046, 0.075].\n\nStarting from core quantitative genetics definitions of additive genetic variance components and population differentiation for quantitative traits under the infinitesimal model, derive an expression for the quantitative trait differentiation index $Q_{ST}$ in terms of $V_{A,B}$ and $V_{A,W}$, and use it to compute a point estimate of $Q_{ST}$ for the focal trait. Then, to formally compare quantitative trait differentiation to the neutral benchmark accounting for bootstrap uncertainty, compute the scalar diagnostic\n$$\nD \\equiv Q_{ST} - F_{ST}^{(0.975)}.\n$$\nA positive value of $D$ implies that quantitative trait differentiation exceeds the upper bound of the bootstrapped neutral benchmark and is therefore consistent with divergent selection; a negative value implies no such evidence.\n\nReport the value of $D$ as a unitless decimal, rounded to four significant figures. The final answer must be the single numerical value of $D$.", "solution": "The problem statement is validated as scientifically grounded, well-posed, and objective. It presents a standard scenario in evolutionary quantitative genetics, utilizing established concepts such as additive genetic variance components ($V_A$), the quantitative trait differentiation index ($Q_{ST}$), and the fixation index ($F_{ST}$). All necessary data and definitions are provided, and no contradictions or ambiguities are present. Therefore, a solution can be derived.\n\nThe primary task is to compute the diagnostic scalar $D$, defined as $D \\equiv Q_{ST} - F_{ST}^{(0.975)}$. This requires first deriving an expression for $Q_{ST}$ from the provided additive genetic variance components and then calculating its point estimate.\n\n$Q_{ST}$ is a measure of population differentiation for a quantitative trait, analogous to Wright's fixation index, $F_{ST}$, for neutral genetic markers. It quantifies the proportion of the total additive genetic variance for a trait that is found among populations. The variance components are provided from an \"animal model,\" where:\n- $V_{A,B}$ is the additive genetic variance among the mean breeding values of the populations. This is given as $V_{A,B} = 0.18$.\n- $V_{A,W}$ is the additive genetic variance among individuals within populations, assumed to be homogeneous across populations. This is given as $V_{A,W} = 0.42$.\n\nThe theoretical foundation of the $Q_{ST}-F_{ST}$ comparison is that under neutral evolution (i.e., genetic drift and mutation only), the expectation is $Q_{ST} \\approx F_{ST}$. Divergence from this expectation signals the action of natural selection. Specifically, $Q_{ST} > F_{ST}$ suggests divergent selection among populations, while $Q_{ST} < F_{ST}$ suggests stabilizing or uniform selection across populations.\n\nFor this comparison to be valid, $Q_{ST}$ must be defined correctly. In a diploid, sexually reproducing population, the definition that aligns with the neutral expectation $Q_{ST} \\approx F_{ST}$ is:\n$$\nQ_{ST} = \\frac{V_{A,B}}{V_{A,B} + 2V_{A,W}}\n$$\nThe denominator represents the total additive genetic variance in the metapopulation. The term $V_{A,B}$ is the among-population component. The term $2V_{A,W}$ represents the within-population component. The factor of $2$ is critical and arises because $V_{A,W}$ represents the variance among diploid individuals within a population, whereas the total additive genetic variance within a randomly mating population, which is the component relevant for comparison with among-population variance, is twice this value. This formulation ensures that $Q_{ST}$ for a trait under additive gene action has the same expectation as $F_{ST}$ for the underlying neutral loci.\n\nUsing the provided values, we first compute the point estimate of $Q_{ST}$:\n$$\nQ_{ST} = \\frac{0.18}{0.18 + 2(0.42)} = \\frac{0.18}{0.18 + 0.84} = \\frac{0.18}{1.02}\n$$\nCalculating this fraction gives:\n$$\nQ_{ST} = \\frac{18}{102} = \\frac{3}{17} \\approx 0.176470588...\n$$\nNext, we compute the diagnostic scalar $D$. The problem defines it as the difference between the point estimate of $Q_{ST}$ and the upper $95\\%$ confidence limit of the neutral benchmark, $F_{ST}^{(0.975)}$. The givens are:\n- The calculated $Q_{ST} \\approx 0.176470588...$\n- The upper bound for neutral divergence, $F_{ST}^{(0.975)} = 0.075$.\n\nThe expression for $D$ is:\n$$\nD = Q_{ST} - F_{ST}^{(0.975)}\n$$\nSubstituting the numerical values:\n$$\nD = \\frac{3}{17} - 0.075 \\approx 0.176470588... - 0.075 = 0.101470588...\n$$\nThe problem requires this value to be rounded to four significant figures. The first significant figure is the $1$ in the tenths place. The fourth significant figure is the $4$ in the ten-thousandths place. The following digit is $7$, which is $\\ge 5$, so we round up.\n$$\nD \\approx 0.1015\n$$\nThe positive value of $D$ indicates that the estimated differentiation for the focal quantitative trait, $Q_{ST}$, is greater than the upper limit of the confidence interval for neutral differentiation, $F_{ST}$. This result is consistent with the hypothesis that the focal trait is under divergent selection among the populations.", "answer": "$$\\boxed{0.1015}$$", "id": "2702632"}, {"introduction": "Modern studies of ecological speciation leverage genome-wide data to pinpoint the specific loci underlying adaptation and reproductive isolation. This requires sophisticated bioinformatic pipelines that can distinguish the signature of selection from the background noise of population history. This advanced coding exercise [@problem_id:2702581] challenges you to build a complete analytical pipeline from first principles. You will implement methods to detect population-specific divergence (Population Branch Statistic, or PBS) and integrate them with environmental association tests, all while properly controlling for population structure, skills essential for cutting-edge research in evolutionary genomics.", "problem": "You are asked to implement a complete, runnable program that operationalizes a principled population-genomic pipeline for identifying candidate ecological adaptation loci consistent with ecological speciation. The pipeline must integrate a divergence-based signal from Population Branch Statistic (PBS) with an environmental association test that controls for population structure using principal components analysis. The Cross Population Composite Likelihood Ratio (XP-CLR) is mentioned as a conceptual alternative to PBS, but your implementation should use the Population Branch Statistic (PBS).\n\nStart from foundational population-genetic and statistical principles and definitions:\n- For each single-nucleotide polymorphism (SNP) locus, between any two populations with allele count data, use the Hudson estimator of Wright’s fixation index $F_{\\mathrm{ST}}$ based on allele counts. Given derived allele counts $x_1$ of $n_1$ chromosomes in population $1$ and $x_2$ of $n_2$ chromosomes in population $2$, let $p_1 = x_1 / n_1$ and $p_2 = x_2 / n_2$. Use the per-locus Hudson estimator\n  \n$$\n  F_{\\mathrm{ST}} = \\frac{(p_1 - p_2)^2 - \\left(\\frac{p_1 (1 - p_1)}{n_1 - 1} + \\frac{p_2 (1 - p_2)}{n_2 - 1}\\right)}{p_1 (1 - p_2) + p_2 (1 - p_1)}.\n  $$\n\n  If the denominator is non-positive or the numerator is negative, set $F_{\\mathrm{ST}} = 0$. Clamp numerical values to avoid taking the logarithm of $0$ or $1$ later by restricting $F_{\\mathrm{ST}} \\in [10^{-12}, 1 - 10^{-12}]$ when used in transformations.\n- Convert per-pair $F_{\\mathrm{ST}}$ to a divergence time proxy\n  \n$$\n  T_{ij} = -\\ln\\left(1 - F_{\\mathrm{ST}, ij}\\right).\n  $$\n\n- For three populations forming a putative tree (focal $A$, reference $B$, reference $C$), define the Population Branch Statistic (PBS) for $A$ as\n  \n$$\n  \\mathrm{PBS}_A = \\frac{T_{AB} + T_{AC} - T_{BC}}{2}.\n  $$\n\n- For environmental association, let the response at each locus be the vector of allele frequencies across populations. Control for structure by including the top $K$ principal components (PCs) of the genome-wide allele frequency matrix (populations $\\times$ loci) as covariates. Use ordinary least squares (OLS) to fit the linear model\n  \n$$\n  \\mathbf{y}_\\ell = \\beta_0 \\mathbf{1} + \\beta_e \\mathbf{e}_z + \\sum_{k=1}^{K} \\gamma_k \\mathbf{PC}_k + \\boldsymbol{\\varepsilon},\n  $$\n\n  where $\\mathbf{y}_\\ell$ is the vector of allele frequencies for locus $\\ell$ across populations, $\\mathbf{e}_z$ is the standardized environment (zero mean and unit variance across populations), and $\\mathbf{PC}_k$ is the $k$-th principal component score vector for populations. Test the null hypothesis $H_0: \\beta_e = 0$ using the Student $t$-statistic with degrees of freedom $d = m - p$, where $m$ is the number of populations and $p$ is the number of fitted regression coefficients (including intercept, environment, and $K$ PCs). Compute two-sided $p$-values using the Student $t$ distribution. If the design matrix is rank-deficient or $d \\le 0$, return a conservative $p$-value of $1$ for that locus.\n- Control the genome-wide false discovery rate for the environmental tests using the Benjamini–Hochberg (BH) procedure at a specified level $\\alpha$.\n- Define candidate ecological adaptation loci as those that are simultaneously environmental-association discoveries under BH at level $\\alpha$ and PBS outliers above a specified empirical quantile $q$ among loci in the specified triad for the focal branch.\n\nYour program must:\n- Implement the computations above precisely.\n- Execute on a fixed test suite specified below.\n- Produce a single line of output that aggregates the results across test cases as a list of lists of integers, where each inner list contains the sorted $0$-based locus indices passing the combined criterion for the corresponding test case.\n\nMathematical and algorithmic details to implement:\n- Principal components for structure: Construct the matrix $\\mathbf{X}$ of allele frequencies with shape $m \\times L$ (populations $\\times$ loci). Center columns by subtracting the per-locus mean across populations. Compute the singular value decomposition $\\mathbf{X} = \\mathbf{U}\\mathbf{S}\\mathbf{V}^\\top$. The population PC score matrix is $\\mathbf{U}\\mathbf{S}$; use its first $K$ columns as covariates. If $K = 0$, omit PCs.\n- Ordinary least squares: For design matrix $\\mathbf{D}$ (columns: intercept, standardized environment, and PCs) and response $\\mathbf{y}_\\ell$, compute $\\hat{\\boldsymbol{\\beta}} = (\\mathbf{D}^\\top \\mathbf{D})^{+} \\mathbf{D}^\\top \\mathbf{y}_\\ell$ using the Moore–Penrose pseudoinverse $(\\cdot)^{+}$ to handle potential rank deficiencies. Let $\\hat{\\mathbf{y}}_\\ell = \\mathbf{D}\\hat{\\boldsymbol{\\beta}}$ and residual sum of squares $\\mathrm{RSS} = \\|\\mathbf{y}_\\ell - \\hat{\\mathbf{y}}_\\ell\\|_2^2$. With degrees of freedom $d = m - \\mathrm{rank}(\\mathbf{D})$, define $\\hat{\\sigma}^2 = \\mathrm{RSS} / d$ if $d > 0$. The variance of the environment coefficient is the $(2,2)$-entry of $\\hat{\\sigma}^2 (\\mathbf{D}^\\top \\mathbf{D})^{+}$. The $t$-statistic is $t = \\hat{\\beta}_e / \\sqrt{\\mathrm{Var}(\\hat{\\beta}_e)}$. Compute the two-sided $p$-value as $2 \\cdot S(t; d)$, where $S(\\cdot; d)$ is the upper-tail survival function of the Student $t$ distribution with $d$ degrees of freedom.\n- Benjamini–Hochberg: Given $L$ $p$-values $p_{(1)} \\le \\dots \\le p_{(L)}$ with ranks $r = 1, \\dots, L$, find the largest $r^*$ such that $p_{(r^*)} \\le \\alpha \\cdot r^*/L$. Declare all $p_{(r)}$ with $r \\le r^*$ significant.\n\nTest suite:\nEach test case specifies populations, loci, derived allele counts, per-population chromosome sample sizes, an environmental covariate, PBS triad, the number of principal components $K$, PBS outlier quantile $q$, and BH level $\\alpha$. All indices are $0$-based.\n\n- Test case $1$:\n  - Populations $m = 5$.\n  - Loci $L = 10$.\n  - Sample sizes per population (chromosomes): $[\\,50, 50, 50, 50, 50\\,]$.\n  - Derived allele counts matrix of shape $5 \\times 10$ (rows are populations $0$ to $4$, columns are loci $0$ to $9$):\n    \n$$\n    \\begin{bmatrix}\n    10 & 8 & 15 & 10 & 40 & 10 & 20 & 5 & 25 & 5 \\\\\n    13 & 10 & 15 & 10 & 35 & 13 & 19 & 8 & 25 & 5 \\\\\n    11 & 12 & 16 & 10 & 30 & 15 & 20 & 6 & 25 & 5 \\\\\n    12 & 43 & 15 & 40 & 10 & 30 & 20 & 35 & 25 & 45 \\\\\n    12 & 40 & 15 & 10 & 15 & 28 & 21 & 34 & 25 & 5\n    \\end{bmatrix}.\n    $$\n\n  - Environment vector (length $5$): $[\\,0.1, 0.2, 0.3, 0.9, 0.85\\,]$.\n  - PBS triad: focal $= 3$, references $= (0, 1)$.\n  - Number of PCs $K = 1$.\n  - PBS outlier quantile $q = 0.8$ (select loci with PBS at or above the $80$-th percentile).\n  - Benjamini–Hochberg level $\\alpha = 0.1$.\n- Test case $2$:\n  - Populations $m = 5$.\n  - Loci $L = 10$.\n  - Sample sizes per population: $[\\,50, 50, 50, 50, 50\\,]$.\n  - Derived allele counts: same as in test case $1$.\n  - Environment vector: same as in test case $1$.\n  - PBS triad: focal $= 0$, references $= (3, 4)$.\n  - Number of PCs $K = 1$.\n  - PBS outlier quantile $q = 0.9$.\n  - Benjamini–Hochberg level $\\alpha = 0.1$.\n- Test case $3$ (edge case with no signal):\n  - Populations $m = 4$.\n  - Loci $L = 4$.\n  - Sample sizes per population: $[\\,40, 40, 40, 40\\,]$.\n  - Derived allele counts matrix $4 \\times 4$:\n    \n$$\n    \\begin{bmatrix}\n    8 & 20 & 12 & 4 \\\\\n    8 & 20 & 12 & 4 \\\\\n    8 & 20 & 12 & 4 \\\\\n    8 & 20 & 12 & 4\n    \\end{bmatrix}.\n    $$\n\n  - Environment vector: $[\\,0.3, 0.6, 0.4, 0.5\\,]$.\n  - PBS triad: focal $= 0$, references $= (1, 2)$.\n  - Number of PCs $K = 0$.\n  - PBS outlier quantile $q = 0.8$.\n  - Benjamini–Hochberg level $\\alpha = 0.1$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element corresponds to one test case and is itself a list of sorted $0$-based locus indices passing the combined criterion. For example, a valid output format is $[ [\\,0,2\\,], [\\,1\\,], [\\,] ]$. The exact numeric content must be computed by your code based on the definitions above; only the format is fixed.", "solution": "The problem is subjected to validation and is determined to be valid. It is scientifically grounded, well-posed, and objective. The problem describes a standard, multi-step population genomics pipeline for identifying loci under selection due to environmental pressures, a process central to the study of ecological speciation. All required data, mathematical formulas, and statistical procedures are specified with sufficient precision to permit a unique and verifiable solution. There are no contradictions, ambiguities, or reliance on non-scientific premises.\n\nThe solution requires the implementation of a computational pipeline comprising two primary analytical components: a divergence-based measure (Population Branch Statistic, PBS) and a test for association between allele frequencies and an environmental variable, controlling for population structure.\n\nThe pipeline is structured as follows:\n\n**1. Population Differentiation and Divergence (PBS Analysis)**\n\nThe first component quantifies the genetic divergence of a focal population along its specific evolutionary branch. This is accomplished in three steps for each genetic locus.\n\n- **Step 1: Pairwise Fixation Index ($F_{\\mathrm{ST}}$)**\n  For any two populations, say population $i$ and population $j$, with derived allele counts $x_i$ and $x_j$ from $n_i$ and $n_j$ sampled chromosomes, we first compute their respective allele frequencies, $p_i = x_i / n_i$ and $p_j = x_j / n_j$. The genetic differentiation between them is measured using the Hudson estimator of Wright's fixation index, $F_{\\mathrm{ST}}$:\n  $$\n  F_{\\mathrm{ST}, ij} = \\frac{(p_i - p_j)^2 - \\left(\\frac{p_i (1 - p_i)}{n_i - 1} + \\frac{p_j (1 - p_j)}{n_j - 1}\\right)}{p_i (1 - p_j) + p_j (1 - p_i)}\n  $$\n  This estimator includes a correction for sampling variance. Following the problem specification, if the numerator is negative or the denominator is non-positive, we set $F_{\\mathrm{ST}, ij} = 0$. To ensure numerical stability in subsequent transformations, the computed $F_{\\mathrm{ST}}$ value is clamped to the interval $[10^{-12}, 1 - 10^{-12}]$.\n\n- **Step 2: Transformation to Divergence Time Proxy ($T$)**\n  $F_{\\mathrm{ST}}$ is related to the coalescent time between populations. Under a simple drift model, this relationship can be linearized. We convert each pairwise $F_{\\mathrm{ST}, ij}$ value into a proxy for divergence time, $T_{ij}$, using the transformation:\n  $$\n  T_{ij} = -\\ln\\left(1 - F_{\\mathrm{ST}, ij}\\right)\n  $$\n  This transformation makes the measure additive along branches of a population tree.\n\n- **Step 3: Population Branch Statistic (PBS)**\n  Given a three-population tree with a focal population $A$ and two reference populations $B$ and $C$, the PBS for the focal population's branch is calculated as:\n  $$\n  \\mathrm{PBS}_A = \\frac{T_{AB} + T_{AC} - T_{BC}}{2}\n  $$\n  This statistic isolates the divergence that has accumulated specifically on the branch leading to population $A$ since its split from the lineage leading to $B$ and $C$. A high $\\mathrm{PBS}_A$ value at a particular locus suggests accelerated differentiation in population $A$, a hallmark of positive selection. We identify loci as PBS outliers if their PBS value is at or above a specified empirical quantile $q$ across all loci.\n\n**2. Environmental Association Analysis**\n\nThe second component tests for a statistical association between allele frequencies and an environmental variable across all populations, accounting for their background genetic relatedness (population structure).\n\n- **Step 1: Controlling for Population Structure with Principal Components Analysis (PCA)**\n  Population structure can create spurious correlations between allele frequencies and environmental variables if both are geographically patterned. To control for this, we use PCA. We construct an allele frequency matrix $\\mathbf{X}$ of size $m \\times L$, where $m$ is the number of populations and $L$ is the number of loci. Each column of this matrix is centered by subtracting its mean. We then perform a Singular Value Decomposition (SVD) on the centered matrix: $\\mathbf{X}_{\\text{centered}} = \\mathbf{U}\\mathbf{S}\\mathbf{V}^\\top$. The principal component (PC) scores for the populations are given by the columns of the matrix product $\\mathbf{U}\\mathbf{S}$. The top $K$ PC score vectors are used as covariates in the regression model to capture the major axes of genetic variation across the populations.\n\n- **Step 2: Linear Regression Model (OLS)**\n  For each locus $\\ell$, we fit an ordinary least squares (OLS) linear model to test for the effect of the environment. The model is:\n  $$\n  \\mathbf{y}_\\ell = \\beta_0 \\mathbf{1} + \\beta_e \\mathbf{e}_z + \\sum_{k=1}^{K} \\gamma_k \\mathbf{PC}_k + \\boldsymbol{\\varepsilon}\n  $$\n  where $\\mathbf{y}_\\ell$ is the $m \\times 1$ vector of allele frequencies at locus $\\ell$, $\\mathbf{e}_z$ is the standardized environmental variable (mean $0$, variance $1$), $\\mathbf{PC}_k$ are the PC score vectors, $\\beta_0, \\beta_e, \\gamma_k$ are regression coefficients, and $\\boldsymbol{\\varepsilon}$ is the error term. The design matrix $\\mathbf{D}$ for this regression consists of a column of ones (for the intercept $\\beta_0$), the vector $\\mathbf{e}_z$, and the $K$ PC vectors.\n\n- **Step 3: Hypothesis Testing**\n  We are interested in the null hypothesis $H_0: \\beta_e = 0$, which states that there is no association between allele frequency and the environment after accounting for population structure. The coefficient vector is estimated using the Moore-Penrose pseudoinverse $(\\cdot)^{+}$ for robustness to an ill-conditioned or rank-deficient design matrix: $\\hat{\\boldsymbol{\\beta}} = (\\mathbf{D}^\\top \\mathbf{D})^{+} \\mathbf{D}^\\top \\mathbf{y}_\\ell$. The test is performed using a Student's $t$-statistic:\n  $$\n  t = \\frac{\\hat{\\beta}_e}{\\mathrm{SE}(\\hat{\\beta}_e)}\n  $$\n  where $\\hat{\\beta}_e$ is the estimated coefficient for the environment and $\\mathrm{SE}(\\hat{\\beta}_e)$ is its standard error. The standard error is derived from the diagonal of the coefficient covariance matrix, $\\mathrm{Cov}(\\hat{\\boldsymbol{\\beta}}) = \\hat{\\sigma}^2 (\\mathbf{D}^\\top \\mathbf{D})^{+}$, where $\\hat{\\sigma}^2 = \\mathrm{RSS} / d$ is the estimated residual variance, $\\mathrm{RSS}$ is the residual sum of squares, and $d = m - \\mathrm{rank}(\\mathbf{D})$ are the residual degrees of freedom. A two-sided $p$-value is computed from the Student's $t$-distribution with $d$ degrees of freedom. If $d \\le 0$, a conservative $p$-value of $1$ is assigned.\n\n**3. Combining Evidence and Controlling for False Discoveries**\n\n- **Step 1: False Discovery Rate (FDR) Control**\n  To account for multiple testing across $L$ loci, we control the false discovery rate using the Benjamini–Hochberg (BH) procedure at a specified significance level $\\alpha$. The $p$-values from all $L$ environmental association tests are sorted in ascending order, $p_{(1)} \\le p_{(2)} \\le \\dots \\le p_{(L)}$. We find the largest rank $r^*$ such that $p_{(r^*)} \\le \\alpha \\cdot r^*/L$. All loci with $p$-values less than or equal to $p_{(r^*)}$ are declared significant.\n\n- **Step 2: Identification of Candidate Loci**\n  The final set of candidate ecological adaptation loci consists of those that satisfy both criteria simultaneously: they must be identified as PBS outliers (PBS value $\\ge$ $q$-th quantile) and must be significant in the environmental association test after BH correction. The final output is a sorted list of the $0$-based indices of these candidate loci for each test case.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import t as t_dist\n\ndef calculate_fst(p1, n1, p2, n2):\n    \"\"\"Calculates the Hudson estimator of F_ST between two populations at a single locus.\"\"\"\n    # Ensure sample sizes are valid for the formula\n    if n1 <= 1 or n2 <= 1:\n        return 0.0\n\n    num = (p1 - p2)**2 - (p1 * (1 - p1) / (n1 - 1) + p2 * (1 - p2) / (n2 - 1))\n    den = p1 * (1 - p2) + p2 * (1 - p1)\n\n    if den <= 0 or num < 0:\n        return 0.0\n    \n    fst = num / den\n    # Clamp F_ST for numerical stability in the log transformation\n    return np.clip(fst, 1e-12, 1 - 1e-12)\n\ndef calculate_pbs(allele_counts, sample_sizes, focal_pop_idx, ref_pop_idx1, ref_pop_idx2):\n    \"\"\"Calculates the Population Branch Statistic (PBS) for all loci.\"\"\"\n    L = allele_counts.shape[1]\n    pbs_scores = np.zeros(L)\n\n    p_focal = allele_counts[focal_pop_idx] / sample_sizes[focal_pop_idx]\n    p_ref1 = allele_counts[ref_pop_idx1] / sample_sizes[ref_pop_idx1]\n    p_ref2 = allele_counts[ref_pop_idx2] / sample_sizes[ref_pop_idx2]\n\n    n_focal = sample_sizes[focal_pop_idx]\n    n_ref1 = sample_sizes[ref_pop_idx1]\n    n_ref2 = sample_sizes[ref_pop_idx2]\n\n    for l in range(L):\n        fst_ab = calculate_fst(p_focal[l], n_focal, p_ref1[l], n_ref1)\n        fst_ac = calculate_fst(p_focal[l], n_focal, p_ref2[l], n_ref2)\n        fst_bc = calculate_fst(p_ref1[l], n_ref1, p_ref2[l], n_ref2)\n\n        T_ab = -np.log(1 - fst_ab)\n        T_ac = -np.log(1 - fst_ac)\n        T_bc = -np.log(1 - fst_bc)\n\n        pbs_scores[l] = (T_ab + T_ac - T_bc) / 2\n        \n    return pbs_scores\n\ndef environmental_association(allele_counts, sample_sizes, env_vector, K):\n    \"\"\"Performs an environmental association test for all loci, controlling for population structure.\"\"\"\n    m, L = allele_counts.shape\n    \n    # 1. Allele frequency matrix (populations x loci)\n    freq_matrix = allele_counts / sample_sizes[:, np.newaxis]\n    \n    # 2. Construct design matrix D\n    intercept = np.ones((m, 1))\n    \n    # Standardize environment vector\n    env_mean = np.mean(env_vector)\n    env_std = np.std(env_vector)\n    e_z = (env_vector - env_mean) / env_std if env_std > 0 else np.zeros(m)\n    \n    design_matrix_components = [intercept, e_z.reshape(-1, 1)]\n    \n    if K > 0 and m > 1:\n        X_centered = freq_matrix - np.mean(freq_matrix, axis=0)\n        # Avoid SVD on all-zero matrix which would result in NaN issues later\n        if np.allclose(X_centered, 0):\n             # If no variation, PCs are meaningless\n             pass\n        else:\n            U, S, _ = np.linalg.svd(X_centered, full_matrices=False)\n            pc_scores = U[:, :K] * S[:K]\n            design_matrix_components.append(pc_scores)\n\n    D = np.hstack(design_matrix_components)\n    \n    rank_D = np.linalg.matrix_rank(D)\n    dof = m - rank_D\n    \n    if dof <= 0:\n        return np.ones(L)\n\n    try:\n        D_pseudo_inv = np.linalg.pinv(D)\n        D_T_D_pseudo_inv = np.linalg.pinv(D.T @ D)\n    except np.linalg.LinAlgError:\n        return np.ones(L)\n\n    p_values = np.zeros(L)\n    \n    for l in range(L):\n        y_l = freq_matrix[:, l]\n        \n        beta_hat = D_pseudo_inv @ y_l\n        beta_e = beta_hat[1]\n        \n        y_hat = D @ beta_hat\n        rss = np.sum((y_l - y_hat)**2)\n        sigma_sq_hat = rss / dof\n        \n        var_beta_e = sigma_sq_hat * D_T_D_pseudo_inv[1, 1]\n        \n        if var_beta_e <= 0:\n            p_values[l] = 1.0\n            continue\n            \n        se_beta_e = np.sqrt(var_beta_e)\n        \n        if se_beta_e == 0:\n             t_stat = np.inf if beta_e != 0 else 0\n        else:\n             t_stat = beta_e / se_beta_e\n        \n        p_val = 2 * t_dist.sf(np.abs(t_stat), df=dof)\n        p_values[l] = p_val\n        \n    return p_values\n\ndef benjamini_hochberg(p_values, alpha):\n    \"\"\"Performs the Benjamini-Hochberg procedure.\"\"\"\n    L = len(p_values)\n    if L == 0:\n        return np.array([], dtype=int)\n        \n    sorted_indices = np.argsort(p_values)\n    sorted_p_values = p_values[sorted_indices]\n    \n    ranks = np.arange(1, L + 1)\n    \n    # Condition for significance\n    significant_mask = sorted_p_values <= (alpha * ranks / L)\n    \n    if not np.any(significant_mask):\n        return np.array([], dtype=int)\n    \n    # Find the largest rank (r*) that satisfies the condition\n    max_rank_idx = np.where(significant_mask)[0][-1]\n    \n    # All loci with p-values up to this threshold are significant\n    significant_indices = sorted_indices[:max_rank_idx + 1]\n    \n    return significant_indices\n\ndef solve_case(case):\n    \"\"\"Processes a single test case.\"\"\"\n    m, L, sample_sizes, allele_counts, env_vector, pbs_triad, K, q, alpha = case\n    \n    sample_sizes = np.array(sample_sizes)\n    allele_counts = np.array(allele_counts)\n    env_vector = np.array(env_vector)\n    \n    # 1. PBS analysis\n    focal_pop, ref_pops = pbs_triad\n    pbs_scores = calculate_pbs(allele_counts, sample_sizes, focal_pop, ref_pops[0], ref_pops[1])\n    pbs_threshold = np.quantile(pbs_scores, q)\n    pbs_outlier_indices = np.where(pbs_scores >= pbs_threshold)[0]\n    \n    # 2. Environmental association analysis\n    p_values = environmental_association(allele_counts, sample_sizes, env_vector, K)\n    \n    # 3. BH correction\n    env_significant_indices = benjamini_hochberg(p_values, alpha)\n    \n    # 4. Intersect the results to find candidate loci\n    candidate_loci = np.intersect1d(pbs_outlier_indices, env_significant_indices)\n    \n    return sorted(list(candidate_loci))\n\ndef solve():\n    \"\"\"Defines and runs the test suite.\"\"\"\n    test_cases = [\n        (5, 10, [50, 50, 50, 50, 50],\n         [[10, 8, 15, 10, 40, 10, 20, 5, 25, 5],\n          [13, 10, 15, 10, 35, 13, 19, 8, 25, 5],\n          [11, 12, 16, 10, 30, 15, 20, 6, 25, 5],\n          [12, 43, 15, 40, 10, 30, 20, 35, 25, 45],\n          [12, 40, 15, 10, 15, 28, 21, 34, 25, 5]],\n         [0.1, 0.2, 0.3, 0.9, 0.85],\n         (3, (0, 1)), 1, 0.8, 0.1),\n        (5, 10, [50, 50, 50, 50, 50],\n         [[10, 8, 15, 10, 40, 10, 20, 5, 25, 5],\n          [13, 10, 15, 10, 35, 13, 19, 8, 25, 5],\n          [11, 12, 16, 10, 30, 15, 20, 6, 25, 5],\n          [12, 43, 15, 40, 10, 30, 20, 35, 25, 45],\n          [12, 40, 15, 10, 15, 28, 21, 34, 25, 5]],\n         [0.1, 0.2, 0.3, 0.9, 0.85],\n         (0, (3, 4)), 1, 0.9, 0.1),\n        (4, 4, [40, 40, 40, 40],\n         [[8, 20, 12, 4],\n          [8, 20, 12, 4],\n          [8, 20, 12, 4],\n          [8, 20, 12, 4]],\n         [0.3, 0.6, 0.4, 0.5],\n         (0, (1, 2)), 0, 0.8, 0.1)\n    ]\n\n    results = []\n    for case in test_cases:\n        result = solve_case(case)\n        results.append(result)\n\n    print(f\"[{','.join([str(r).replace(' ', '') for r in results])}]\")\n\nsolve()\n```", "id": "2702581"}]}