{"hands_on_practices": [{"introduction": "Droplet-based single-cell technologies rely on the random partitioning of cells into droplets, a process governed by Poisson statistics. A critical experimental trade-off exists: loading cells at a high concentration increases throughput but also raises the probability of capturing multiple cells in one droplet, or \"doublets,\" which compromises data integrity. This exercise will guide you through the first-principles derivation of the doublet rate, a fundamental skill for designing and troubleshooting single-cell experiments. [@problem_id:2773333]", "problem": "In a droplet-based single-cell encapsulation workflow used for single-cell measurement, cells are suspended at concentration $c$ (in units of cells per unit volume) and partitioned into identically sized droplets of volume $V$ using a microfluidic generator. Assume that cells are uniformly mixed and arrive in droplets independently, so that the number of cells $N$ per droplet follows a Poisson distribution with mean $\\lambda=cV$. Define a \"doublet\" as a droplet containing exactly $2$ cells. In typical single-cell pipelines, droplets containing $0$ cells are removed downstream by selection, leaving only droplets with $N \\geq 1$ for measurement. Starting from the definition and normalization of the Poisson distribution and basic probability rules, derive an analytic expression for the expected fraction $f_{\\mathrm{dbl}}(c,V)$ of occupied droplets (those with $N \\geq 1$) that are doublets. Express your final answer as a single simplified analytic expression in terms of $c$ and $V$. Report your result as a decimal fraction (not a percentage). Do not round.", "solution": "The problem statement is subject to validation.\n\n**Step 1: Extract Givens**\n- Cell concentration: $c$ (cells per unit volume).\n- Droplet volume: $V$.\n- The number of cells per droplet, $N$, follows a Poisson distribution.\n- The mean of the Poisson distribution is $\\lambda = cV$.\n- A \"doublet\" is defined as a droplet with $N=2$.\n- \"Occupied droplets\" are those with $N \\ge 1$.\n- The objective is to derive an analytic expression for the fraction $f_{\\mathrm{dbl}}(c,V)$ of occupied droplets that are doublets.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded. The use of a Poisson distribution to model the encapsulation of particles (such as cells) in uniformly-sized droplets is a standard and well-validated model in microfluidics and single-cell biology. The assumptions of uniform mixing and independent arrival are fundamental to this model. The problem is well-posed, providing all necessary definitions and parameters ($c, V$) to derive the requested quantity, $f_{\\mathrm{dbl}}(c,V)$. The language is objective and precise. The problem is self-contained, consistent, and requires a non-trivial derivation based on fundamental probability theory. It does not violate any of the invalidity criteria.\n\n**Step 3: Verdict and Action**\nThe problem is deemed **valid**. A solution will be derived.\n\nThe number of cells $N$ in a given droplet is a random variable following a Poisson distribution with mean $\\lambda = cV$. The probability mass function (PMF) for the Poisson distribution is given by:\n$$P(N=k) = \\frac{\\lambda^{k} \\exp(-\\lambda)}{k!}$$\nSubstituting the given expression for the mean, $\\lambda = cV$, we have:\n$$P(N=k) = \\frac{(cV)^{k} \\exp(-cV)}{k!}$$\nwhere $k$ is a non-negative integer representing the number of cells in the droplet.\n\nWe are tasked with finding the fraction of *occupied* droplets that are \"doublets\". An occupied droplet is one containing one or more cells ($N \\ge 1$). A doublet is a droplet containing exactly two cells ($N=2$). This fraction is a conditional probability: the probability that a droplet contains two cells, given that it contains at least one cell. We denote this as $f_{\\mathrm{dbl}}(c,V) = P(N=2 | N \\ge 1)$.\n\nUsing the definition of conditional probability, $P(A|B) = \\frac{P(A \\cap B)}{P(B)}$, we have:\n$$f_{\\mathrm{dbl}}(c,V) = \\frac{P(\\{N=2\\} \\cap \\{N \\ge 1\\})}{P(N \\ge 1)}$$\nThe event $\\{N=2\\}$ is a subset of the event $\\{N \\ge 1\\}$. Therefore, their intersection is simply the event $\\{N=2\\}$ itself. The expression simplifies to:\n$$f_{\\mathrm{dbl}}(c,V) = \\frac{P(N=2)}{P(N \\ge 1)}$$\n\nNow, we must calculate the probabilities in the numerator and the denominator.\n\nFirst, the probability of a droplet being a doublet ($N=2$) is found by setting $k=2$ in the PMF:\n$$P(N=2) = \\frac{(cV)^{2} \\exp(-cV)}{2!} = \\frac{(cV)^{2} \\exp(-cV)}{2}$$\n\nNext, the probability of a droplet being occupied ($N \\ge 1$) is the complement of the probability of a droplet being empty ($N=0$).\n$$P(N \\ge 1) = 1 - P(N=0)$$\nThe probability of a droplet being empty is found by setting $k=0$ in the PMF:\n$$P(N=0) = \\frac{(cV)^{0} \\exp(-cV)}{0!} = \\frac{1 \\cdot \\exp(-cV)}{1} = \\exp(-cV)$$\nTherefore, the probability of a droplet being occupied is:\n$$P(N \\ge 1) = 1 - \\exp(-cV)$$\n\nFinally, we substitute these probabilities back into the expression for $f_{\\mathrm{dbl}}(c,V)$:\n$$f_{\\mathrm{dbl}}(c,V) = \\frac{P(N=2)}{P(N \\ge 1)} = \\frac{\\frac{(cV)^{2} \\exp(-cV)}{2}}{1 - \\exp(-cV)}$$\n\nTo simplify this expression, we can multiply the numerator and the denominator by $\\exp(cV)$:\n$$f_{\\mathrm{dbl}}(c,V) = \\frac{\\left(\\frac{(cV)^{2} \\exp(-cV)}{2}\\right) \\exp(cV)}{(1 - \\exp(-cV)) \\exp(cV)} = \\frac{\\frac{(cV)^{2}}{2}}{\\exp(cV) - 1}$$\nThis gives the final, simplified analytic expression for the expected fraction of occupied droplets that are doublets.\n$$f_{\\mathrm{dbl}}(c,V) = \\frac{(cV)^{2}}{2(\\exp(cV) - 1)}$$\nThis completes the derivation.", "answer": "$$\\boxed{\\frac{(cV)^{2}}{2(\\exp(cV) - 1)}}$$", "id": "2773333"}, {"introduction": "Raw data from single-cell RNA-sequencing experiments exhibit significant technical variability, with sequencing depth and capture efficiency often varying widely from cell to cell. To make meaningful biological comparisons, this technical noise must be removed through a process called normalization. This practice provides a hands-on example of how to compute size factors and normalize a raw count matrix, revealing the underlying expression patterns that were obscured by technical artifacts. [@problem_id:2773346]", "problem": "You are quantifying messenger RNA expression from a synthetic gene circuit using single-cell RNA sequencing (scRNA-seq) with Unique Molecular Identifier (UMI) counting. Consider a toy dataset of $G=4$ genes measured in $N=4$ single cells split across two conditions, $A$ (cells $1$ and $2$) and $B$ (cells $3$ and $4$). Let $x_{g,i}$ denote the raw UMI count for gene $g$ in cell $i$. The observed counts are:\n- Gene $G_1$: $(x_{1,1}, x_{1,2}, x_{1,3}, x_{1,4}) = (80, 120, 100, 150)$.\n- Gene $G_2$: $(x_{2,1}, x_{2,2}, x_{2,3}, x_{2,4}) = (40, 60, 100, 150)$.\n- Gene $G_3$: $(x_{3,1}, x_{3,2}, x_{3,3}, x_{3,4}) = (160, 240, 200, 300)$.\n- Gene $G_4$: $(x_{4,1}, x_{4,2}, x_{4,3}, x_{4,4}) = (64, 96, 80, 120)$.\n\nAssume a multiplicative sampling model for UMI counts in single-cell RNA sequencing where, for gene $g$ and cell $i$, the expectation satisfies $x_{g,i} \\approx s_i \\,\\lambda_{g,c(i)}$ with $s_i>0$ a cell-specific size (sequencing depth and capture efficiency) factor and $\\lambda_{g,c}$ the underlying expression level of gene $g$ in condition $c \\in \\{A,B\\}$. Further assume that for the vast majority of genes $g$, there is no biological differential expression across conditions so that $\\lambda_{g,A}=\\lambda_{g,B}=\\lambda_g$, and that technical noise is negligible in this toy example.\n\nTasks:\n- Using only the multiplicative model and the majority-no-change assumption stated above (and no additional shortcut formulas), derive a robust estimator for the per-cell size factors $s_i$ that is identifiable up to a single positive multiplicative constant across cells. Then compute the estimated $s_i$ for this dataset.\n- Use your estimated $s_i$ to construct normalized counts $\\tilde{x}_{g,i} = x_{g,i}/s_i$ for all genes and cells.\n- Quantitatively assess how normalization changes within-condition dispersion by computing, for each gene $g$, the sample variance of $\\{x_{g,i}: i \\in A\\}$ and $\\{x_{g,i}: i \\in B\\}$ before normalization, and of $\\{\\tilde{x}_{g,i}: i \\in A\\}$ and $\\{\\tilde{x}_{g,i}: i \\in B\\}$ after normalization. Briefly explain the changes you observe in light of the model.\n- Finally, compute the base-$2$ logarithm of the fold-change for gene $G_2$ between conditions $B$ and $A$ using the normalized counts, where the condition-level abundance is defined as the arithmetic mean of the normalized counts across cells in that condition. That is, compute $\\log_{2}\\!\\big(\\bar{\\tilde{x}}_{2,B} / \\bar{\\tilde{x}}_{2,A}\\big)$, where $\\bar{\\tilde{x}}_{2,A}$ and $\\bar{\\tilde{x}}_{2,B}$ are the means over cells $1,2$ and $3,4$, respectively.\n\nReport only the number from the final step as your answer. Round your answer to four significant figures. No units are required.", "solution": "The problem as stated is scientifically grounded and mathematically well-posed. We proceed with the derivation and solution as requested. The analysis will be conducted in four parts as outlined in the problem statement.\n\nThe provided data consists of UMI counts $x_{g,i}$ for $G=4$ genes across $N=4$ cells. The cells are partitioned into condition $A$ (cells $i=1,2$) and condition $B$ (cells $i=3,4$). The data is:\n- Gene $G_1$: $(80, 120, 100, 150)$\n- Gene $G_2$: $(40, 60, 100, 150)$\n- Gene $G_3$: $(160, 240, 200, 300)$\n- Gene $G_4$: $(64, 96, 80, 120)$\n\nThe underlying model is $x_{g,i} \\approx s_i \\lambda_{g,c(i)}$, where $s_i$ is the cell-specific size factor and $\\lambda_{g,c}$ is the true expression of gene $g$ in condition $c$. The core assumption is that for the majority of genes, $\\lambda_{g,A} = \\lambda_{g,B} = \\lambda_g$. For such non-differentially expressed (non-DE) genes, the model simplifies to $x_{g,i} \\approx s_i \\lambda_g$.\n\n**Part 1: Derivation and Estimation of Size Factors $s_i$**\n\nFrom the simplified model for non-DE genes, $x_{g,i} \\approx s_i \\lambda_g$, it follows that the ratio of counts for any two cells $i$ and $j$ should be constant across all non-DE genes: $x_{g,i}/x_{g,j} \\approx s_i/s_j$. We can use this property to identify the set of non-DE genes. Let us compute the ratio $x_{g,3}/x_{g,1}$ for each gene:\n- Gene $G_1$: $x_{1,3}/x_{1,1} = 100/80 = 1.25$\n- Gene $G_2$: $x_{2,3}/x_{2,1} = 100/40 = 2.5$\n- Gene $G_3$: $x_{3,3}/x_{3,1} = 200/160 = 1.25$\n- Gene $G_4$: $x_{4,3}/x_{4,1} = 80/64 = 1.25$\n\nThe ratios for genes $G_1$, $G_3$, and $G_4$ are identical, while the ratio for $G_2$ is an outlier. This confirms that the set of non-DE genes is $G_{nd} = \\{G_1, G_3, G_4\\}$, fulfilling the \"vast majority\" assumption ($3$ out of $4$ genes).\n\nTo derive a robust estimator for $s_i$, we follow a procedure analogous to that used by DESeq2. For each gene $g$, a pseudo-reference sample is created by computing the geometric mean of its counts across all cells: $\\hat{x}_g = (\\prod_{j=1}^N x_{g,j})^{1/N}$. The ratio $x_{g,i} / \\hat{x}_g$ then serves as an estimate of the size factor $s_i$ from gene $g$. To ensure robustness against outlier genes (like $G_2$), we define the size factor for cell $i$ as the median of these ratios over the set of non-DE genes:\n$$s_i = \\underset{g \\in G_{nd}}{\\text{median}} \\left\\{ \\frac{x_{g,i}}{(\\prod_{j=1}^N x_{g,j})^{1/N}} \\right\\}$$\nThe resulting values are identifiable up to a multiplicative constant. The specific choice of this estimator guarantees that the geometric mean of the estimated size factors across all cells is $1$.\n\nDue to the constructed nature of the data where the ratios of counts between genes are constant across cells for non-DE genes (e.g., $x_{3,i} = 2x_{1,i}$), the ratio $x_{g,i}/\\hat{x}_g$ is identical for all $g \\in G_{nd}$. We can therefore compute the factors using any of these genes, for example, $G_1$:\nFirst, we compute the pseudo-reference for $G_1$:\n$$\\hat{x}_1 = (x_{1,1} x_{1,2} x_{1,3} x_{1,4})^{1/4} = (80 \\times 120 \\times 100 \\times 150)^{1/4} = (144,000,000)^{1/4} = 20\\sqrt{30}$$\nNow we compute the size factor for each cell $i$ as $s_i = x_{1,i} / \\hat{x}_1$:\n- $s_1 = 80 / (20\\sqrt{30}) = \\frac{4}{\\sqrt{30}}$\n- $s_2 = 120 / (20\\sqrt{30}) = \\frac{6}{\\sqrt{30}}$\n- $s_3 = 100 / (20\\sqrt{30}) = \\frac{5}{\\sqrt{30}}$\n- $s_4 = 150 / (20\\sqrt{30}) = \\frac{15}{2\\sqrt{30}}$\n\n**Part 2: Construction of Normalized Counts**\n\nThe normalized counts, $\\tilde{x}_{g,i}$, are computed as $\\tilde{x}_{g,i} = x_{g,i}/s_i$. These values represent the underlying expression levels $\\lambda_{g,c(i)}$.\n\n- **Gene $G_1$**:\n  $\\tilde{x}_{1,1} = 80 / (4/\\sqrt{30}) = 20\\sqrt{30}$\n  $\\tilde{x}_{1,2} = 120 / (6/\\sqrt{30}) = 20\\sqrt{30}$\n  $\\tilde{x}_{1,3} = 100 / (5/\\sqrt{30}) = 20\\sqrt{30}$\n  $\\tilde{x}_{1,4} = 150 / (15/(2\\sqrt{30})) = 20\\sqrt{30}$\n\n- **Gene $G_2$**:\n  $\\tilde{x}_{2,1} = 40 / (4/\\sqrt{30}) = 10\\sqrt{30}$\n  $\\tilde{x}_{2,2} = 60 / (6/\\sqrt{30}) = 10\\sqrt{30}$\n  $\\tilde{x}_{2,3} = 100 / (5/\\sqrt{30}) = 20\\sqrt{30}$\n  $\\tilde{x}_{2,4} = 150 / (15/(2\\sqrt{30})) = 20\\sqrt{30}$\n\n- **Gene $G_3$**: $\\tilde{x}_{3,i} = 40\\sqrt{30}$ for all $i=1,2,3,4$.\n- **Gene $G_4$**: $\\tilde{x}_{4,i} = 16\\sqrt{30}$ for all $i=1,2,3,4$.\n\n\n**Part 3: Assessment of Within-Condition Dispersion**\n\nWe compute the sample variance for each gene within each condition, both before and after normalization. For $n=2$ observations $(y_1, y_2)$, the sample variance is $(y_1 - y_2)^2 / 2$.\n\n- **Before Normalization (Raw Counts $x_{g,i}$):**\n  - $G_1$: Var(A) = $(80-120)^2/2 = 800$; Var(B) = $(100-150)^2/2 = 1250$\n  - $G_2$: Var(A) = $(40-60)^2/2 = 200$; Var(B) = $(100-150)^2/2 = 1250$\n  - $G_3$: Var(A) = $(160-240)^2/2 = 3200$; Var(B) = $(200-300)^2/2 = 5000$\n  - $G_4$: Var(A) = $(64-96)^2/2 = 512$; Var(B) = $(80-120)^2/2 = 800$\n\n- **After Normalization (Normalized Counts $\\tilde{x}_{g,i}$):**\n  For all genes, including the DE gene $G_2$, the normalized counts are identical for all cells within the same condition. For example, for $G_1$ in condition A, the counts are $(20\\sqrt{30}, 20\\sqrt{30})$.\n  - For all genes and both conditions, the sample variance of the normalized counts is $0$.\n\n**Explanation**: The multiplicative model $x_{g,i} \\approx s_i \\lambda_{g,c(i)}$ implies that the variation observed in raw counts within a condition (where $\\lambda_{g,c(i)}$ is constant) is attributable entirely to the differing size factors $s_i$. Normalization by dividing by $s_i$ is designed precisely to remove this source of technical variation. In this idealized, noiseless example, the normalization perfectly recovers the underlying expression levels $\\lambda_{g,c(i)}$, resulting in zero variance within each condition.\n\n**Part 4: Calculation of Log-Fold-Change for Gene $G_2$**\n\nWe compute the base-$2$ logarithm of the fold-change between conditions $B$ and $A$ for gene $G_2$ using the average normalized counts.\n\nThe normalized counts for $G_2$ are:\n- Condition A (cells $1,2$): $(10\\sqrt{30}, 10\\sqrt{30})$\n- Condition B (cells $3,4$): $(20\\sqrt{30}, 20\\sqrt{30})$\n\nThe mean normalized abundance for each condition is:\n- $\\bar{\\tilde{x}}_{2,A} = \\frac{10\\sqrt{30} + 10\\sqrt{30}}{2} = 10\\sqrt{30}$\n- $\\bar{\\tilde{x}}_{2,B} = \\frac{20\\sqrt{30} + 20\\sqrt{30}}{2} = 20\\sqrt{30}$\n\nThe fold-change is the ratio of these means:\n$$\\frac{\\bar{\\tilde{x}}_{2,B}}{\\bar{\\tilde{x}}_{2,A}} = \\frac{20\\sqrt{30}}{10\\sqrt{30}} = 2$$\n\nFinally, we compute the base-$2$ logarithm of this fold-change:\n$$\\log_{2}\\left(\\frac{\\bar{\\tilde{x}}_{2,B}}{\\bar{\\tilde{x}}_{2,A}}\\right) = \\log_{2}(2) = 1$$\nRounding to four significant figures as requested, the final answer is $1.000$.", "answer": "$$\\boxed{1.000}$$", "id": "2773346"}, {"introduction": "A defining feature of single-cell data is its sparsity, but a zero count can be ambiguous: does it represent a true biological absence of a transcript, or a technical failure to detect it? This exercise introduces a rigorous method using spike-in controls to quantify a batch's detection efficiency and apply Bayesian reasoning to calculate the posterior probability that any given zero is technical. Mastering this technique is crucial for accurately interpreting gene expression states and dynamics from sparse data. [@problem_id:2773320]", "problem": "You are designing a principled, spike-in based computational test to separate technical non-detections from true biological absence in single-cell transcription measurements, and to quantify batch-specific detection efficiency. Assume the following fundamental base. First, introduced spike-in molecules per cell are independently distributed according to a Poisson law due to dilution and partitioning; specifically, for spike-in species $j$, the number of introduced molecules $N_j$ per cell is Poisson with mean $\\mu_j$. Second, each individual molecule (spike-in or endogenous) is captured and detected independently with a batch-specific detection efficiency $\\eta_b \\in [0,1]$, which is the per-molecule probability of capture and detection for batch $b$. Third, Poisson thinning holds: if $N \\sim \\mathrm{Poisson}(\\mu)$ and each event is independently retained with probability $\\eta$, then the retained count $K$ is $\\mathrm{Poisson}(\\eta \\mu)$. Fourth, for an endogenous gene in a given cell, model the on-off biology as a mixture: with prior probability $\\pi$ the gene is off (biological zero, with true molecule count exactly zero), and with prior probability $(1-\\pi)$ the gene is on with a fixed expected input (before technical losses) of $\\mu_{\\mathrm{on}}$ molecules in that cell. Fifth, use Bayes’ rule to compute posterior probabilities given the observation of a measured zero count for an endogenous gene.\n\nYour task is to implement a program that, for each provided test case, does all of the following from first principles:\n- Using only the fundamental base above, derive and compute the maximum likelihood estimate of the batch detection efficiency $\\eta_b$ from spike-in measurements $(\\mu_j, k_j)$ across spike-in species $j$ in that batch.\n- For each observed endogenous zero provided, derive and compute the posterior probability that it is a technical zero (that is, the gene was on but no molecules were detected) versus a biological zero (that is, the gene was truly off), using the batch’s estimated $\\eta_b$, the gene’s $\\mu_{\\mathrm{on}}$, and the prior $\\pi$.\n- For any test case that contains more than one batch, compute the relative efficiency between batches as the ratio $\\eta_{b_2}/\\eta_{b_1}$, where $b_1$ is the first batch listed in that test case and $b_2$ is the second.\n\nAll quantities in this problem are unit-consistent and scientifically realistic. Molecule quantities $\\mu$ are in molecules per cell; detection efficiencies and probabilities are dimensionless in $[0,1]$. You must express all reported probabilities and efficiencies as decimals (not as percentages). Round all reported outputs to $6$ decimal places.\n\nImplement your solution as a complete, runnable program that does not require user input. Hard-code the following test suite and produce the required outputs in the exact order specified. For each test case, the input is a set of spike-ins with known Poisson means per cell and observed detected counts, and a list of endogenous zero observations each with its $(\\mu_{\\mathrm{on}}, \\pi)$.\n\nTest Case $\\#1$ (single batch):\n- Batch $B_1$ spike-ins: means $\\{\\mu_j\\} = \\{50, 100, 200\\}$ molecules per cell; observed detected counts $\\{k_j\\} = \\{18, 40, 83\\}$ molecules.\n- Endogenous zeros to classify for $B_1$: $(\\mu_{\\mathrm{on}}, \\pi)$ pairs $\\{(5.0, 0.2), (0.5, 0.8)\\}$.\n\nRequired outputs for Test Case $\\#1$:\n$[\\eta_{B_1}, \\; P_{\\mathrm{tech}}(\\text{first zero in } B_1), \\; P_{\\mathrm{tech}}(\\text{second zero in } B_1)]$.\n\nTest Case $\\#2$ (single batch with extreme counts):\n- Batch $B_1$ spike-ins: means $\\{\\mu_j\\} = \\{80, 160\\}$ molecules per cell; observed detected counts $\\{k_j\\} = \\{0, 0\\}$ molecules.\n- Endogenous zeros to classify for $B_1$: $(\\mu_{\\mathrm{on}}, \\pi)$ pairs $\\{(2.0, 0.5), (10.0, 0.1)\\}$.\n\nRequired outputs for Test Case $\\#2$:\n$[\\eta_{B_1}, \\; P_{\\mathrm{tech}}(\\text{first zero in } B_1), \\; P_{\\mathrm{tech}}(\\text{second zero in } B_1)]$.\n\nTest Case $\\#3$ (two batches and cross-batch comparison):\n- Batch $B_1$ spike-ins: means $\\{\\mu_j\\} = \\{20, 60, 120\\}$ molecules per cell; observed detected counts $\\{k_j\\} = \\{12, 34, 65\\}$ molecules.\n- Batch $B_2$ spike-ins: means $\\{\\mu_j\\} = \\{20, 60, 120\\}$ molecules per cell; observed detected counts $\\{k_j\\} = \\{8, 18, 40\\}$ molecules.\n- Endogenous zeros to classify: for $B_1$ use $(\\mu_{\\mathrm{on}}, \\pi) = (3.0, 0.3)$; for $B_2$ use $(\\mu_{\\mathrm{on}}, \\pi) = (3.0, 0.3)$.\n\nRequired outputs for Test Case $\\#3$:\n$[\\eta_{B_1}, \\; \\eta_{B_2}, \\; \\eta_{B_2}/\\eta_{B_1}, \\; P_{\\mathrm{tech}}(\\text{zero in } B_1), \\; P_{\\mathrm{tech}}(\\text{zero in } B_2)]$.\n\nFinal Output Format:\nYour program should produce a single line of output containing the results from all test cases concatenated in order, as a comma-separated list enclosed in square brackets:\n$[\\text{TC1 outputs}, \\text{TC2 outputs}, \\text{TC3 outputs}]$.\nEach entry must be a decimal rounded to $6$ places. For example, your output must have the structure\n$[\\eta_{B_1}^{(1)}, P_{\\mathrm{tech},1}^{(1)}, P_{\\mathrm{tech},2}^{(1)}, \\eta_{B_1}^{(2)}, P_{\\mathrm{tech},1}^{(2)}, P_{\\mathrm{tech},2}^{(2)}, \\eta_{B_1}^{(3)}, \\eta_{B_2}^{(3)}, \\eta_{B_2}^{(3)}/\\eta_{B_1}^{(3)}, P_{\\mathrm{tech}}^{(3,B_1)}, P_{\\mathrm{tech}}^{(3,B_2)}]$.", "solution": "The problem statement has been evaluated and is deemed valid. It is scientifically grounded, self-contained, and well-posed. The a priori assumptions, including the Poisson nature of spike-in distributions and the principles of Poisson thinning, are standard and correct for modeling single-cell counting experiments. The endogenous gene expression model, a zero-inflated mixture, is a conventional and appropriate simplification. A minor ambiguity regarding the distribution of the 'on' state for endogenous genes is resolved by adopting the most logical and standard interpretation in this context: that the number of molecules follows a Poisson distribution with the specified mean $\\mu_{\\mathrm{on}}$. This assumption allows for a rigorous and complete solution. We proceed to the derivations from first principles.\n\nThe solution is structured in three parts: first, the derivation of the maximum likelihood estimator for the batch-specific detection efficiency $\\eta_b$; second, the derivation of the posterior probability of a technical zero using Bayes' rule; third, the trivial computation of relative efficiency.\n\n**Part 1: Maximum Likelihood Estimation of Batch Detection Efficiency ($\\hat{\\eta}_b$)**\n\nWe are given that for a spike-in species $j$, the number of input molecules is a random variable $N_j \\sim \\mathrm{Poisson}(\\mu_j)$. Each of these molecules is detected independently with probability $\\eta_b$. The resulting observed count $k_j$ is therefore a random variable that follows a Poisson distribution with mean $\\eta_b \\mu_j$, according to the provided Poisson thinning property.\n$$ k_j \\sim \\mathrm{Poisson}(\\eta_b \\mu_j) $$\nThe probability mass function for a single observation $k_j$ is:\n$$ P(k_j | \\eta_b, \\mu_j) = \\frac{e^{-\\eta_b \\mu_j} (\\eta_b \\mu_j)^{k_j}}{k_j!} $$\nAssuming that the measurements for $J$ different spike-in species are independent events, the joint likelihood function $L$ for a set of observations $\\{k_1, k_2, \\dots, k_J\\}$ given the known means $\\{\\mu_1, \\mu_2, \\dots, \\mu_J\\}$ is the product of the individual probabilities:\n$$ L(\\eta_b) = \\prod_{j=1}^{J} P(k_j | \\eta_b, \\mu_j) = \\prod_{j=1}^{J} \\frac{e^{-\\eta_b \\mu_j} (\\eta_b \\mu_j)^{k_j}}{k_j!} $$\nFor analytical convenience, we work with the log-likelihood function, $\\ln L(\\eta_b)$:\n$$ \\ln L(\\eta_b) = \\sum_{j=1}^{J} \\ln \\left( \\frac{e^{-\\eta_b \\mu_j} (\\eta_b \\mu_j)^{k_j}}{k_j!} \\right) $$\n$$ \\ln L(\\eta_b) = \\sum_{j=1}^{J} \\left( -\\eta_b \\mu_j + k_j \\ln(\\eta_b \\mu_j) - \\ln(k_j!) \\right) $$\n$$ \\ln L(\\eta_b) = \\sum_{j=1}^{J} \\left( -\\eta_b \\mu_j + k_j \\ln(\\eta_b) + k_j \\ln(\\mu_j) - \\ln(k_j!) \\right) $$\n$$ \\ln L(\\eta_b) = -\\eta_b \\sum_{j=1}^{J} \\mu_j + \\ln(\\eta_b) \\sum_{j=1}^{J} k_j + \\sum_{j=1}^{J} (k_j \\ln(\\mu_j) - \\ln(k_j!)) $$\nTo find the maximum likelihood estimate $\\hat{\\eta}_b$, we differentiate $\\ln L(\\eta_b)$ with respect to $\\eta_b$ and set the result to zero. The terms not depending on $\\eta_b$ vanish.\n$$ \\frac{d}{d\\eta_b} \\ln L(\\eta_b) = - \\sum_{j=1}^{J} \\mu_j + \\frac{1}{\\eta_b} \\sum_{j=1}^{J} k_j $$\nSetting the derivative to zero to find the critical point:\n$$ - \\sum_{j=1}^{J} \\mu_j + \\frac{1}{\\hat{\\eta}_b} \\sum_{j=1}^{J} k_j = 0 $$\nSolving for $\\hat{\\eta}_b$ yields the estimator:\n$$ \\hat{\\eta}_b = \\frac{\\sum_{j=1}^{J} k_j}{\\sum_{j=1}^{J} \\mu_j} $$\nThis result states that the most likely detection efficiency is the ratio of the total number of molecules counted to the total number of molecules expected. The second derivative, $\\frac{d^2}{d\\eta_b^2} \\ln L(\\eta_b) = -\\frac{1}{\\eta_b^2} \\sum_{j=1}^{J} k_j$, is negative for any non-zero counts, confirming that this solution corresponds to a maximum.\n\n**Part 2: Posterior Probability of a Technical Zero**\n\nWe are asked to compute the posterior probability that an observed zero count for an endogenous gene is a \"technical zero\" (gene was on, but no molecules were detected) versus a \"biological zero\" (gene was off).\n\nLet us define the relevant events:\n- $S_{\\mathrm{on}}$: The gene is in the 'on' state. The prior probability is $P(S_{\\mathrm{on}}) = 1 - \\pi$.\n- $S_{\\mathrm{off}}$: The gene is in the 'off' state. The prior probability is $P(S_{\\mathrm{off}}) = \\pi$.\n- $K=0$: The observed count for the gene is zero.\n\nWe seek the posterior probability $P(S_{\\mathrm{on}} | K=0)$, which is the probability of a technical zero. Using Bayes' theorem:\n$$ P(S_{\\mathrm{on}} | K=0) = \\frac{P(K=0 | S_{\\mathrm{on}}) P(S_{\\mathrm{on}})}{P(K=0)} $$\nThe denominator is the total probability of observing a zero, given by the law of total probability:\n$$ P(K=0) = P(K=0 | S_{\\mathrm{on}}) P(S_{\\mathrm{on}}) + P(K=0 | S_{\\mathrm{off}}) P(S_{\\mathrm{off}}) $$\nWe must determine the conditional probabilities (likelihoods):\n1.  $P(K=0 | S_{\\mathrm{off}})$: If the gene is off, the true molecule count is exactly $0$. Consequently, the observed count must also be $0$. Thus, $P(K=0 | S_{\\mathrm{off}}) = 1$.\n2.  $P(K=0 | S_{\\mathrm{on}})$: If the gene is on, we assume the initial number of molecules follows a Poisson distribution with mean $\\mu_{\\mathrm{on}}$. After technical losses, characterized by detection efficiency $\\eta_b$, the observed count $K$ follows a thinned Poisson distribution, $K \\sim \\mathrm{Poisson}(\\eta_b \\mu_{\\mathrm{on}})$. The probability of observing $K=0$ is then:\n    $$ P(K=0 | S_{\\mathrm{on}}) = \\frac{e^{-\\eta_b \\mu_{\\mathrm{on}}} (\\eta_b \\mu_{\\mathrm{on}})^0}{0!} = e^{-\\eta_b \\mu_{\\mathrm{on}}} $$\n\nSubstituting these components back into the formula for $P(K=0)$:\n$$ P(K=0) = (e^{-\\eta_b \\mu_{\\mathrm{on}}})(1 - \\pi) + (1)(\\pi) = e^{-\\eta_b \\mu_{\\mathrm{on}}} (1-\\pi) + \\pi $$\nFinally, we substitute all terms into Bayes' theorem to find the posterior probability of a technical zero, which we denote $P_{\\mathrm{tech}}$:\n$$ P_{\\mathrm{tech}} = P(S_{\\mathrm{on}} | K=0) = \\frac{e^{-\\eta_b \\mu_{\\mathrm{on}}} (1 - \\pi)}{e^{-\\eta_b \\mu_{\\mathrm{on}}} (1 - \\pi) + \\pi} $$\nThis expression will be computed using the estimated efficiency $\\hat{\\eta}_b$ from Part 1.\n\n**Part 3: Relative Efficiency**\n\nFor test cases involving two batches, $b_1$ and $b_2$, the relative detection efficiency is computed as the simple ratio of their estimated efficiencies:\n$$ \\text{Relative Efficiency} = \\frac{\\hat{\\eta}_{b_2}}{\\hat{\\eta}_{b_1}} $$\nThis ratio is meaningful only if $\\hat{\\eta}_{b_1} > 0$.\n\nThese derived formulae are implemented below to solve for the specified test cases.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the quantitative biology problem based on first principles for spike-in analysis.\n    The solution is structured by test case as specified in the problem statement.\n    \"\"\"\n\n    results = []\n\n    # Helper function to calculate the posterior probability of a technical zero.\n    # P_tech = P(gene is ON | observed count is 0)\n    def calculate_p_tech(eta, mu_on, pi):\n        \"\"\"\n        Calculates the posterior probability of a technical zero given an observed zero count.\n\n        Args:\n            eta (float): The estimated detection efficiency for the batch.\n            mu_on (float): The expected molecule count when the gene is 'on'.\n            pi (float): The prior probability that the gene is 'off' (biological zero).\n\n        Returns:\n            float: The posterior probability of a technical zero.\n        \"\"\"\n        # P(K=0 | ON) = exp(-eta * mu_on)\n        p_k0_given_on = np.exp(-eta * mu_on)\n        \n        # P(ON) = 1 - pi\n        p_on = 1.0 - pi\n        \n        # P(OFF) = pi\n        p_off = pi\n        \n        # P(K=0 | OFF) = 1\n        # Denominator P(K=0) = P(K=0|ON)P(ON) + P(K=0|OFF)P(OFF)\n        p_k0 = p_k0_given_on * p_on + 1.0 * p_off\n        \n        # Bayes' Rule: P(ON|K=0) = P(K=0|ON)P(ON) / P(K=0)\n        if p_k0 == 0:\n            # This case should not occur unless pi=0 and p_k0_given_on=0.\n            # If it does, the probability is technically undefined, but\n            # approaching this limit suggests the numerator is zero faster.\n            return 0.0\n\n        p_on_given_k0 = (p_k0_given_on * p_on) / p_k0\n        return p_on_given_k0\n\n    # --- Test Case #1 ---\n    # Batch B1 spike-ins\n    b1_mus_tc1 = [50, 100, 200]\n    b1_ks_tc1 = [18, 40, 83]\n    \n    # Calculate eta_b1\n    eta_b1_tc1 = sum(b1_ks_tc1) / sum(b1_mus_tc1)\n    results.append(round(eta_b1_tc1, 6))\n    \n    # Endogenous zeros for B1\n    # Zero 1: (mu_on=5.0, pi=0.2)\n    p_tech_1_tc1 = calculate_p_tech(eta_b1_tc1, 5.0, 0.2)\n    results.append(round(p_tech_1_tc1, 6))\n    \n    # Zero 2: (mu_on=0.5, pi=0.8)\n    p_tech_2_tc1 = calculate_p_tech(eta_b1_tc1, 0.5, 0.8)\n    results.append(round(p_tech_2_tc1, 6))\n\n    # --- Test Case #2 ---\n    # Batch B1 spike-ins (extreme counts)\n    b1_mus_tc2 = [80, 160]\n    b1_ks_tc2 = [0, 0]\n\n    # Calculate eta_b1\n    eta_b1_tc2 = sum(b1_ks_tc2) / sum(b1_mus_tc2) if sum(b1_mus_tc2) > 0 else 0.0\n    results.append(round(eta_b1_tc2, 6))\n    \n    # Endogenous zeros for B1\n    # Zero 1: (mu_on=2.0, pi=0.5)\n    p_tech_1_tc2 = calculate_p_tech(eta_b1_tc2, 2.0, 0.5)\n    results.append(round(p_tech_1_tc2, 6))\n\n    # Zero 2: (mu_on=10.0, pi=0.1)\n    p_tech_2_tc2 = calculate_p_tech(eta_b1_tc2, 10.0, 0.1)\n    results.append(round(p_tech_2_tc2, 6))\n\n    # --- Test Case #3 ---\n    # Batch B1 spike-ins\n    b1_mus_tc3 = [20, 60, 120]\n    b1_ks_tc3 = [12, 34, 65]\n    eta_b1_tc3 = sum(b1_ks_tc3) / sum(b1_mus_tc3)\n    results.append(round(eta_b1_tc3, 6))\n\n    # Batch B2 spike-ins\n    b2_mus_tc3 = [20, 60, 120]\n    b2_ks_tc3 = [8, 18, 40]\n    eta_b2_tc3 = sum(b2_ks_tc3) / sum(b2_mus_tc3)\n    results.append(round(eta_b2_tc3, 6))\n\n    # Relative efficiency\n    relative_efficiency = eta_b2_tc3 / eta_b1_tc3 if eta_b1_tc3 > 0 else 0.0\n    results.append(round(relative_efficiency, 6))\n    \n    # Endogenous zeros for B1 and B2\n    # Zero for B1: (mu_on=3.0, pi=0.3)\n    p_tech_b1_tc3 = calculate_p_tech(eta_b1_tc3, 3.0, 0.3)\n    results.append(round(p_tech_b1_tc3, 6))\n    \n    # Zero for B2: (mu_on=3.0, pi=0.3)\n    p_tech_b2_tc3 = calculate_p_tech(eta_b2_tc3, 3.0, 0.3)\n    results.append(round(p_tech_b2_tc3, 6))\n    \n    # Final combined output\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "2773320"}]}