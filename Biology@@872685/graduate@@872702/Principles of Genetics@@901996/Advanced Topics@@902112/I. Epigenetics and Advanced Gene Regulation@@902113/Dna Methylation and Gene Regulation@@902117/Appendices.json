{"hands_on_practices": [{"introduction": "The study of DNA methylation is nuanced, as the term can encompass several distinct cytosine modifications, most notably 5-methylcytosine (5mC) and 5-hydroxymethylcytosine (5hmC), which can have different functional roles. This exercise demonstrates how a multi-experiment design, combining conventional and oxidative bisulfite sequencing, allows for the quantitative deconvolution of these distinct epigenetic marks. Mastering this practice will equip you with the skills to build mathematical models from experimental principles, a crucial ability for accurately interpreting data from advanced sequencing technologies. [@problem_id:2805008]", "problem": "A single CpG locus in the gene body of a neuronally expressed gene is profiled by conventional bisulfite sequencing (BS-seq) and oxidative bisulfite sequencing (oxBS-seq). Conventional bisulfite sequencing (BS-seq) reports the fraction of reads calling cytosine as methylated signal, which comprises both 5-methylcytosine and 5-hydroxymethylcytosine, plus residual non-conversion of unmodified cytosine. Oxidative bisulfite sequencing (oxBS-seq) uses a prior oxidation step intended to convert 5-hydroxymethylcytosine into a form that is deaminated by bisulfite, so that only 5-methylcytosine is retained as cytosine, again with a small residual non-conversion of unmodified cytosine. Assume the following, where each probability refers to a single CpG site sampled uniformly at random across sequencing reads:\n- The true fractions of cytosines in states 5-methylcytosine, 5-hydroxymethylcytosine, and unmodified cytosine are $m$, $h$, and $u$, respectively, with $m + h + u = 1$.\n- In BS-seq, 5-methylcytosine and 5-hydroxymethylcytosine are always read as cytosine, while unmodified cytosine is read as cytosine with non-conversion probability $b_{BS}$.\n- In oxBS-seq, 5-methylcytosine is always read as cytosine, 5-hydroxymethylcytosine is oxidized with efficiency $\\epsilon_{ox}$ and, if oxidized, is deaminated and read as thymine; if not oxidized, it is read as cytosine. Unmodified cytosine is read as cytosine with non-conversion probability $b_{ox}$.\nYou measure at this locus the observed methylation fractions $ \\beta_{BS} = 0.78 $ and $ \\beta_{ox} = 0.65 $. Independent spike-in controls estimate the oxidation efficiency as $ \\epsilon_{ox} = 0.92 $ and the bisulfite non-conversion rates as $ b_{BS} = 0.005 $ and $ b_{ox} = 0.004 $. Using only the law of total probability and the definitions above, derive an expression for the true 5-hydroxymethylcytosine fraction $h$ in terms of $ \\beta_{BS}, \\beta_{ox}, \\epsilon_{ox}, b_{BS}, b_{ox} $, and then compute its value for the parameters given. Report the final value of $h$ as a decimal fraction, rounded to four significant figures.", "solution": "The problem requires the derivation of the true fraction of 5-hydroxymethylcytosine, denoted by $h$, from experimental measurements obtained via conventional bisulfite sequencing (BS-seq) and oxidative bisulfite sequencing (oxBS-seq). The solution proceeds by first establishing a mathematical model based on the law of total probability that relates the observable quantities to the true underlying molecular fractions, and then solving the resulting system of equations.\n\nLet $m$, $h$, and $u$ be the true fractions of 5-methylcytosine, 5-hydroxymethylcytosine, and unmodified cytosine at the CpG locus, respectively. These fractions must sum to $1$.\n$$m + h + u = 1$$\n\nThe observed methylation fraction in any experiment, denoted $\\beta$, is the probability that a sequencing read at the CpG site is reported as cytosine (C). We can express this using the law of total probability, conditioned on the true state of the cytosine base.\n$$P(\\text{read C}) = \\sum_{\\text{state } S \\in \\{m, h, u\\}} P(\\text{read C} | \\text{state is } S) \\cdot P(\\text{state is } S)$$\n\nFor conventional bisulfite sequencing (BS-seq), the observed methylation fraction is $\\beta_{BS}$. According to the problem statement:\n- A 5-methylcytosine is always read as cytosine, so $P(\\text{read C} | \\text{state is } m) = 1$.\n- A 5-hydroxymethylcytosine is always read as cytosine, so $P(\\text{read C} | \\text{state is } h) = 1$.\n- An unmodified cytosine is read as cytosine with a non-conversion probability $b_{BS}$, so $P(\\text{read C} | \\text{state is } u) = b_{BS}$.\n\nSubstituting these probabilities and the true fractions ($P(\\text{state is } m)=m$, $P(\\text{state is } h)=h$, $P(\\text{state is } u)=u$) into the law of total probability, we obtain the first equation:\n$$\\beta_{BS} = (1 \\cdot m) + (1 \\cdot h) + (b_{BS} \\cdot u) = m + h + b_{BS} u \\quad (1)$$\n\nFor oxidative bisulfite sequencing (oxBS-seq), the observed methylation fraction is $\\beta_{ox}$. The probabilities are defined as:\n- A 5-methylcytosine is always read as cytosine, so $P(\\text{read C} | \\text{state is } m) = 1$.\n- A 5-hydroxymethylcytosine is read as cytosine only if it fails to be oxidized. The probability of non-oxidation is $1 - \\epsilon_{ox}$. Thus, $P(\\text{read C} | \\text{state is } h) = 1 - \\epsilon_{ox}$.\n- An unmodified cytosine is read as cytosine with a non-conversion probability $b_{ox}$, so $P(\\text{read C} | \\text{state is } u) = b_{ox}$.\n\nThis gives the second equation:\n$$\\beta_{ox} = (1 \\cdot m) + ((1 - \\epsilon_{ox}) \\cdot h) + (b_{ox} \\cdot u) = m + (1 - \\epsilon_{ox})h + b_{ox} u \\quad (2)$$\n\nWe have a system of three linear equations for the three unknowns $m$, $h$, and $u$:\n1. $m + h + b_{BS} u = \\beta_{BS}$\n2. $m + (1 - \\epsilon_{ox})h + b_{ox} u = \\beta_{ox}$\n3. $m + h + u = 1$\n\nOur objective is to derive an expression for $h$. A systematic approach is to first eliminate $m$. By subtracting equation (3) from equation (1), we can find an expression for $u$.\n$$(m + h + b_{BS} u) - (m + h + u) = \\beta_{BS} - 1$$\n$$u(b_{BS} - 1) = \\beta_{BS} - 1$$\n$$u = \\frac{\\beta_{BS} - 1}{b_{BS} - 1} = \\frac{1 - \\beta_{BS}}{1 - b_{BS}}$$\nThis expression gives the true fraction of unmodified cytosine, $u$, in terms of the BS-seq measurement, $\\beta_{BS}$, and its corresponding non-conversion rate, $b_{BS}$.\n\nNext, we can eliminate $m$ by subtracting equation (2) from equation (1):\n$$(\\beta_{BS}) - (\\beta_{ox}) = (m + h + b_{BS} u) - (m + (1 - \\epsilon_{ox})h + b_{ox} u)$$\n$$\\beta_{BS} - \\beta_{ox} = h - (1 - \\epsilon_{ox})h + u(b_{BS} - b_{ox})$$\n$$\\beta_{BS} - \\beta_{ox} = h(1 - (1 - \\epsilon_{ox})) + u(b_{BS} - b_{ox})$$\n$$\\beta_{BS} - \\beta_{ox} = h \\epsilon_{ox} + u(b_{BS} - b_{ox})$$\nThis equation relates $h$ and $u$. We can now substitute the expression for $u$ we previously derived into this equation:\n$$\\beta_{BS} - \\beta_{ox} = h \\epsilon_{ox} + \\left(\\frac{1 - \\beta_{BS}}{1 - b_{BS}}\\right)(b_{BS} - b_{ox})$$\nNow, we solve for $h$. First, isolate the term $h \\epsilon_{ox}$:\n$$h \\epsilon_{ox} = (\\beta_{BS} - \\beta_{ox}) - (b_{BS} - b_{ox})\\frac{1 - \\beta_{BS}}{1 - b_{BS}}$$\nFinally, dividing by $\\epsilon_{ox}$ yields the desired expression for $h$:\n$$h = \\frac{1}{\\epsilon_{ox}} \\left[ (\\beta_{BS} - \\beta_{ox}) - (b_{BS} - b_{ox})\\frac{1 - \\beta_{BS}}{1 - b_{BS}} \\right]$$\n\nNow, we substitute the given numerical values into this expression:\n$\\beta_{BS} = 0.78$\n$\\beta_{ox} = 0.65$\n$\\epsilon_{ox} = 0.92$\n$b_{BS} = 0.005$\n$b_{ox} = 0.004$\n\n$$h = \\frac{1}{0.92} \\left[ (0.78 - 0.65) - (0.005 - 0.004)\\frac{1 - 0.78}{1 - 0.005} \\right]$$\n$$h = \\frac{1}{0.92} \\left[ 0.13 - (0.001)\\frac{0.22}{0.995} \\right]$$\nWe calculate the term inside the bracket:\n$$0.13 - (0.001) \\cdot \\frac{0.22}{0.995} = 0.13 - \\frac{0.00022}{0.995}$$\n$$0.13 - 0.0002211055... = 0.1297788944...$$\nNow we complete the calculation for $h$:\n$$h = \\frac{0.1297788944...}{0.92} \\approx 0.1410640157...$$\nRounding the result to four significant figures as required by the problem statement gives:\n$$h \\approx 0.1411$$\nThis value represents the true fraction of 5-hydroxymethylcytosine at the specified locus.", "answer": "$$\\boxed{0.1411}$$", "id": "2805008"}, {"introduction": "Epigenetic states, such as high or low methylation at a gene promoter, can be remarkably stable through cell divisions, providing a form of cellular memory. This exercise introduces a mathematical model to explore how such stability arises from the interplay of maintenance and demethylation processes. By analyzing this dynamical system, you will identify the conditions that lead to bistability—the coexistence of two stable methylation states—and find the critical \"tipping point\" where this epigenetic memory is lost, providing a powerful framework for understanding cellular decision-making. [@problem_id:2805021]", "problem": "A single-locus, coarse-grained model for Deoxyribonucleic Acid (DNA) methylation state regulation considers the methylation fraction $x(t) \\in [0,1]$ at a locus subject to maintenance methylation and demethylation. Assume that maintenance methylation by DNA methyltransferase $1$ (DNMT1) is more efficient when nearby sites are methylated (positive feedback), and that active demethylation is approximately linear in $x$. After nondimensionalizing time by the demethylation timescale, a minimal model for the methylation dynamics is\n$$\n\\frac{dx}{dt} \\;=\\; m \\, a \\, x \\,(1 - x)\\,(x - \\alpha) \\;-\\; x,\n$$\nwhere $m \\in \\mathbb{R}_{>0}$ is the maintenance efficiency, $a \\in \\mathbb{R}_{>0}$ quantifies the strength of cooperativity arising from methylation-dependent recruitment, and $\\alpha \\in (0,1)$ is an effective activation threshold capturing the minimal local methylation needed for positive feedback to net increase methylation.\n\nTreating $m$, $a$, and $\\alpha$ as control parameters, and using only definitions and first principles of stability and bifurcation in one-dimensional dynamical systems applied to the model above, determine the exact closed-form expression for the critical maintenance efficiency $m^{\\star}$ at which the system loses bistability via the collision of the two nonzero steady states (a saddle-node bifurcation) as $m$ is decreased. Express your final result as a function of $a$ and $\\alpha$. Provide your answer as a single analytic expression with no units.", "solution": "The steady states, or fixed points, of the system are the values of $x$ for which the rate of change is zero, i.e., $\\frac{dx}{dt} = 0$. Let $x^{\\star}$ denote a steady state.\n$$\nm \\, a \\, x^{\\star} \\,(1 - x^{\\star})\\,(x^{\\star} - \\alpha) - x^{\\star} = 0\n$$\nWe can factor out $x^{\\star}$ from this equation:\n$$\nx^{\\star} \\left[ m \\, a \\, (1 - x^{\\star})\\,(x^{\\star} - \\alpha) - 1 \\right] = 0\n$$\nThis equation reveals that one steady state is always present at $x_1^{\\star} = 0$. The other, nonzero steady states are the roots of the expression in the brackets:\n$$\nm \\, a \\, (1 - x^{\\star})\\,(x^{\\star} - \\alpha) - 1 = 0\n$$\n$$\nm \\, a \\, (1 - x^{\\star})\\,(x^{\\star} - \\alpha) = 1\n$$\nLet us define a function $g(x) = (1-x)(x-\\alpha)$. The nonzero steady states are the solutions to the equation $m \\, a \\, g(x) = 1$, or equivalently, $g(x) = \\frac{1}{ma}$.\nThe function $g(x)$ is a parabola opening downwards, with roots at $x=\\alpha$ and $x=1$. Since $\\alpha \\in (0,1)$, these roots are distinct and lie within the domain of interest.\n\nA saddle-node bifurcation occurs when two fixed points collide and annihilate. In this context, this corresponds to the moment when the horizontal line $y = \\frac{1}{ma}$ becomes tangent to the parabola $y = g(x)$. This tangency occurs precisely at the vertex of the parabola, which corresponds to the unique local maximum of $g(x)$.\n\nTo find the location of this maximum, we must find the critical point of $g(x)$ by setting its derivative with respect to $x$ to zero.\nFirst, expand $g(x)$:\n$$\ng(x) = -x^2 + x + \\alpha x - \\alpha = -x^2 + (1+\\alpha)x - \\alpha\n$$\nNow, we compute the derivative $g'(x)$:\n$$\ng'(x) = \\frac{d}{dx} \\left( -x^2 + (1+\\alpha)x - \\alpha \\right) = -2x + (1+\\alpha)\n$$\nSetting the derivative to zero gives the value of $x$ at which the bifurcation occurs, which we denote $x_c$:\n$$\n-2x_c + (1+\\alpha) = 0 \\implies x_c = \\frac{1+\\alpha}{2}\n$$\nSince $\\alpha \\in (0,1)$, it follows that $\\frac{1}{2} < x_c < 1$, which is a valid physical value for the methylation fraction. This $x_c$ is the coordinate where the two nonzero steady states merge.\n\nThe bifurcation occurs when the value of $\\frac{1}{ma}$ is equal to the maximum value of $g(x)$, which is $g(x_c)$. We evaluate $g(x)$ at $x_c$:\n$$\ng(x_c) = g\\left(\\frac{1+\\alpha}{2}\\right) = \\left(1 - \\frac{1+\\alpha}{2}\\right)\\left(\\frac{1+\\alpha}{2} - \\alpha\\right)\n$$\n$$\ng(x_c) = \\left(\\frac{2 - 1 - \\alpha}{2}\\right)\\left(\\frac{1+\\alpha - 2\\alpha}{2}\\right)\n$$\n$$\ng(x_c) = \\left(\\frac{1-\\alpha}{2}\\right)\\left(\\frac{1-\\alpha}{2}\\right) = \\frac{(1-\\alpha)^2}{4}\n$$\nThe saddle-node bifurcation occurs at the critical maintenance efficiency $m = m^{\\star}$ that satisfies the tangency condition:\n$$\n\\frac{1}{m^{\\star}a} = g(x_c)\n$$\nSubstituting the expression for $g(x_c)$:\n$$\n\\frac{1}{m^{\\star}a} = \\frac{(1-\\alpha)^2}{4}\n$$\nWe now solve for $m^{\\star}$:\n$$\nm^{\\star} a (1-\\alpha)^2 = 4\n$$\n$$\nm^{\\star} = \\frac{4}{a(1-\\alpha)^2}\n$$\nThis expression provides the critical maintenance efficiency $m^{\\star}$ as a function of the cooperativity strength $a$ and the activation threshold $\\alpha$. For $m > m^{\\star}$, the line $y=\\frac{1}{ma}$ intersects the parabola $g(x)$ at two distinct points, giving two nonzero steady states (one stable, one unstable), leading to bistability (together with the stable state at $x=0$). For $m < m^{\\star}$, there are no nonzero steady states. At $m = m^{\\star}$, the two nonzero states collide and disappear, which is precisely the bifurcation described in the problem.", "answer": "$$\\boxed{\\frac{4}{a(1-\\alpha)^{2}}}$$", "id": "2805021"}, {"introduction": "A central goal in epigenomics is to understand the functional consequences of DNA methylation, such as its influence on transcription factor (TF) binding. This requires moving beyond simple correlations to rigorous statistical hypothesis testing on genome-wide datasets. This hands-on computational problem guides you through a gold-standard bioinformatics workflow, implementing a stratified permutation test to determine if TF binding sites are significantly depleted of methylation, while carefully controlling for potential confounding variables like local GC content. This practice bridges theory with application, developing essential data analysis skills for modern genetics research. [@problem_id:2805078]", "problem": "You are given a stylized representation of Chromatin Immunoprecipitation followed by sequencing (ChIP-seq) peaks for a Transcription Factor (TF) and Whole-Genome Bisulfite Sequencing (WGBS) methylation measurements at the core CpG of the TF motif within each peak. The task is to formalize and implement a permutation-based enrichment test to determine whether the fraction of unmethylated motif CpGs in TF-bound sites is greater than expected relative to a matched genomic background, accounting for confounding structure via stratification.\n\nFundamental base and definitions:\n- The Central Dogma and gene regulation establish that transcriptional activity is influenced by protein-DNA interactions. Epigenetic DNA methylation at cytosine-phosphate-guanine (CpG) dinucleotides is a widely accepted regulatory mark that can modulate TF binding.\n- Whole-Genome Bisulfite Sequencing (WGBS) yields an estimated methylation proportion at each CpG that can be represented as a real number in the closed interval $[0,1]$.\n- Consider a threshold $\\tau \\in [0,1]$ defining “unmethylated” as having methylation proportion less than or equal to $\\tau$.\n- Let there be a finite set of peaks (candidate TF binding sites) indexed by $i \\in \\{1,\\dots,n\\}$. For each peak $i$, you are given a methylation proportion $m_i \\in [0,1]$ for the motif CpG, and a stratum label $s_i \\in \\{0,1,\\dots,K-1\\}$ indicating a matched covariate class (for example, a bin of GC content or CpG density).\n- For each stratum $k \\in \\{0,1,\\dots,K-1\\}$, you are given a background pool $M^{(k)} = \\{b^{(k)}_1,\\dots,b^{(k)}_{N_k}\\}$ of methylation proportions representing matched genomic sites not bound by the TF. You may assume $N_k$ is sufficiently large for sampling without replacement in the supplied test suite.\n\nYour program must:\n1. Compute the observed fraction of unmethylated motif CpGs across the peaks using the given $\\tau$.\n2. Perform a one-sided enrichment test via a stratified permutation procedure under the null hypothesis that the unmethylated fraction in TF-bound sites is not greater than the matched background:\n   - For each of $B$ permutations, and for each stratum $k$, sample without replacement exactly $n_k$ values from $M^{(k)}$, where $n_k$ is the number of peaks in stratum $k$ (i.e., the count of indices $i$ with $s_i = k$). Combine the sampled values over strata and compute the permuted fraction of unmethylated sites under threshold $\\tau$.\n   - Use a fixed pseudorandom seed for reproducibility as specified per test case.\n   - Compute a one-sided right-tail P-value for enrichment using a plus-one correction to avoid zero-valued P, comparing the observed fraction to the empirical null distribution generated by the $B$ permutations.\n3. For each test case, output the pair consisting of the observed unmethylated fraction and the P-value, as decimals.\n\nTest suite:\nFor each test case below, use the provided parameters exactly as given.\n\n- Test case $1$ (two strata, enrichment expected):\n  - $\\tau = 0.2$\n  - Peaks methylation values $[0.05, 0.10, 0.80, 0.15, 0.25, 0.02, 0.30, 0.05, 0.18, 0.19, 0.40, 0.10]$\n  - Peaks strata $[0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1]$\n  - Background per stratum:\n    - Stratum $0$: $[0.35, 0.60, 0.45, 0.50, 0.70, 0.55, 0.40, 0.65, 0.48, 0.52, 0.33, 0.47, 0.58, 0.62, 0.41, 0.75, 0.28, 0.31, 0.36, 0.44]$\n    - Stratum $1$: $[0.25, 0.20, 0.15, 0.10, 0.05, 0.30, 0.35, 0.40, 0.45, 0.50, 0.55, 0.60, 0.18, 0.22, 0.27, 0.33, 0.12, 0.08, 0.38, 0.42]$\n  - $B = 2000$\n  - Random seed $= 42$\n\n- Test case $2$ (two strata, near-null behavior expected):\n  - $\\tau = 0.25$\n  - Peaks methylation values $[0.20, 0.26, 0.24, 0.35, 0.40, 0.23, 0.28, 0.18, 0.38, 0.27]$\n  - Peaks strata $[0, 0, 0, 0, 0, 1, 1, 1, 1, 1]$\n  - Background per stratum:\n    - Stratum $0$: $[0.10, 0.12, 0.20, 0.26, 0.24, 0.30, 0.35, 0.40, 0.45, 0.50, 0.22, 0.27, 0.29, 0.33, 0.37, 0.41, 0.23, 0.19, 0.28, 0.32]$\n    - Stratum $1$: $[0.15, 0.18, 0.22, 0.26, 0.28, 0.30, 0.12, 0.35, 0.40, 0.45, 0.50, 0.55, 0.20, 0.24, 0.27, 0.29, 0.31, 0.33, 0.17, 0.19]$\n  - $B = 2000$\n  - Random seed $= 123$\n\n- Test case $3$ (one stratum, all peaks unmethylated, strong enrichment expected):\n  - $\\tau = 0.2$\n  - Peaks methylation values $[0.00, 0.02, 0.05, 0.10, 0.12, 0.15, 0.18, 0.19]$\n  - Peaks strata $[0, 0, 0, 0, 0, 0, 0, 0]$\n  - Background per stratum:\n    - Stratum $0$: $[0.30, 0.35, 0.40, 0.45, 0.50, 0.60, 0.55, 0.48, 0.52, 0.58, 0.62, 0.70, 0.75, 0.80, 0.28, 0.33, 0.37, 0.42, 0.47, 0.53, 0.57, 0.63, 0.68, 0.73, 0.77, 0.82, 0.85, 0.90, 0.95, 0.99]$\n  - $B = 2000$\n  - Random seed $= 7$\n\n- Test case $4$ (one stratum, observed depletion; one-sided enrichment P-value should be large):\n  - $\\tau = 0.5$\n  - Peaks methylation values $[0.60, 0.70, 0.40, 0.55, 0.65]$\n  - Peaks strata $[0, 0, 0, 0, 0]$\n  - Background per stratum:\n    - Stratum $0$: $[0.05, 0.10, 0.15, 0.20, 0.25, 0.30, 0.35, 0.40, 0.45, 0.50, 0.55, 0.60, 0.65, 0.70, 0.75, 0.80, 0.85, 0.90, 0.33, 0.47]$\n  - $B = 2000$\n  - Random seed $= 99$\n\nFinal output specification:\n- For each test case, return the observed unmethylated fraction and the P-value as decimals, each rounded to six decimal places.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element is itself a two-element list of the form $[\\text{fraction}, \\text{pvalue}]$; for example: $[[0.500000,0.123000],[0.400000,0.876000]]$.", "solution": "The task is to implement a stratified permutation test to determine if a set of Transcription Factor (TF) binding sites (peaks) is significantly enriched for unmethylated CpGs compared to a matched genomic background. Stratification is used to control for potential confounding variables, such as local GC content, which can influence DNA methylation independently of TF binding.\n\nLet the set of $n$ peak methylation values be $\\{m_1, m_2, \\dots, m_n\\}$, and their corresponding stratum labels be $\\{s_1, s_2, \\dots, s_n\\}$, where $s_i \\in \\{0, 1, \\dots, K-1\\}$. The methylation threshold for being \"unmethylated\" is $\\tau$.\n\n1.  **Calculate the Observed Test Statistic**\n    The test statistic is the fraction of peaks that are unmethylated. Let this observed fraction be $F_{obs}$. It is calculated as:\n    $$ F_{obs} = \\frac{1}{n} \\sum_{i=1}^{n} \\mathbb{I}(m_i \\le \\tau) $$\n    where $\\mathbb{I}(\\cdot)$ is the indicator function, which is $1$ if its argument is true and $0$ otherwise.\n\n2.  **Generate the Null Distribution via Stratified Permutation**\n    The null hypothesis, $H_0$, is that the methylation levels at TF-bound sites are drawn from the same distribution as the matched background sites. The permutation test generates an empirical distribution for the test statistic under this null hypothesis. The stratification ensures that the permuted datasets maintain the same confounding structure as the observed data.\n\n    First, we determine the number of peaks within each stratum $k$, denoted as $n_k$:\n    $$ n_k = \\sum_{i=1}^{n} \\mathbb{I}(s_i = k) \\quad \\text{for } k \\in \\{0, 1, \\dots, K-1\\} $$\n    Note that the total number of peaks is $n = \\sum_{k=0}^{K-1} n_k$.\n\n    The permutation procedure is repeated $B$ times. For each permutation $j \\in \\{1, \\dots, B\\}$:\n    a. A new set of `resampled` methylation values is constructed.\n    b. For each stratum $k$, we randomly sample, without replacement, $n_k$ methylation values from the corresponding background pool $M^{(k)}$.\n    c. These sampled values from all strata are combined into a single set of $n$ values.\n    d. The test statistic is computed for this permuted set, yielding a permuted fraction $F_{perm}^{(j)}$:\n    $$ F_{perm}^{(j)} = \\frac{1}{n} \\sum_{m' \\in \\text{resampled set } j} \\mathbb{I}(m' \\le \\tau) $$\n    This collection of $B$ values, $\\{F_{perm}^{(1)}, F_{perm}^{(2)}, \\dots, F_{perm}^{(B)}\\}$, forms the empirical null distribution.\n\n3.  **Calculate the P-value**\n    We are performing a one-sided test for enrichment, meaning we want to know if $F_{obs}$ is significantly *greater* than what is expected by chance. The P-value is the probability of observing a test statistic as extreme as or more extreme than $F_{obs}$, assuming the null hypothesis is true. This is estimated from the empirical null distribution.\n\n    The number of permutations yielding a fraction greater than or equal to the observed fraction is counted:\n    $$ C = \\sum_{j=1}^{B} \\mathbb{I}(F_{perm}^{(j)} \\ge F_{obs}) $$\n    To avoid a P-value of $0$ when no permuted statistic exceeds the observed one (which can lead to overconfidence in the result), a pseudocount of $1$ is added to both the numerator and the denominator. The final P-value is:\n    $$ P = \\frac{C + 1}{B + 1} $$\n\nThis procedure will be implemented for each test case, using the specified parameters, data, and random seeds to ensure reproducibility. The final result for each case will be the pair $[F_{obs}, P]$, with values formatted to six decimal places.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the stratified permutation test on all test cases.\n    \"\"\"\n    test_cases = [\n        {\n            \"tau\": 0.2,\n            \"peak_methylation\": np.array([0.05, 0.10, 0.80, 0.15, 0.25, 0.02, 0.30, 0.05, 0.18, 0.19, 0.40, 0.10]),\n            \"peak_strata\": np.array([0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1]),\n            \"background\": {\n                0: np.array([0.35, 0.60, 0.45, 0.50, 0.70, 0.55, 0.40, 0.65, 0.48, 0.52, 0.33, 0.47, 0.58, 0.62, 0.41, 0.75, 0.28, 0.31, 0.36, 0.44]),\n                1: np.array([0.25, 0.20, 0.15, 0.10, 0.05, 0.30, 0.35, 0.40, 0.45, 0.50, 0.55, 0.60, 0.18, 0.22, 0.27, 0.33, 0.12, 0.08, 0.38, 0.42])\n            },\n            \"B\": 2000,\n            \"seed\": 42\n        },\n        {\n            \"tau\": 0.25,\n            \"peak_methylation\": np.array([0.20, 0.26, 0.24, 0.35, 0.40, 0.23, 0.28, 0.18, 0.38, 0.27]),\n            \"peak_strata\": np.array([0, 0, 0, 0, 0, 1, 1, 1, 1, 1]),\n            \"background\": {\n                0: np.array([0.10, 0.12, 0.20, 0.26, 0.24, 0.30, 0.35, 0.40, 0.45, 0.50, 0.22, 0.27, 0.29, 0.33, 0.37, 0.41, 0.23, 0.19, 0.28, 0.32]),\n                1: np.array([0.15, 0.18, 0.22, 0.26, 0.28, 0.30, 0.12, 0.35, 0.40, 0.45, 0.50, 0.55, 0.20, 0.24, 0.27, 0.29, 0.31, 0.33, 0.17, 0.19])\n            },\n            \"B\": 2000,\n            \"seed\": 123\n        },\n        {\n            \"tau\": 0.2,\n            \"peak_methylation\": np.array([0.00, 0.02, 0.05, 0.10, 0.12, 0.15, 0.18, 0.19]),\n            \"peak_strata\": np.array([0, 0, 0, 0, 0, 0, 0, 0]),\n            \"background\": {\n                0: np.array([0.30, 0.35, 0.40, 0.45, 0.50, 0.60, 0.55, 0.48, 0.52, 0.58, 0.62, 0.70, 0.75, 0.80, 0.28, 0.33, 0.37, 0.42, 0.47, 0.53, 0.57, 0.63, 0.68, 0.73, 0.77, 0.82, 0.85, 0.90, 0.95, 0.99])\n            },\n            \"B\": 2000,\n            \"seed\": 7\n        },\n        {\n            \"tau\": 0.5,\n            \"peak_methylation\": np.array([0.60, 0.70, 0.40, 0.55, 0.65]),\n            \"peak_strata\": np.array([0, 0, 0, 0, 0]),\n            \"background\": {\n                0: np.array([0.05, 0.10, 0.15, 0.20, 0.25, 0.30, 0.35, 0.40, 0.45, 0.50, 0.55, 0.60, 0.65, 0.70, 0.75, 0.80, 0.85, 0.90, 0.33, 0.47])\n            },\n            \"B\": 2000,\n            \"seed\": 99\n        }\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        tau = case[\"tau\"]\n        peak_methylation = case[\"peak_methylation\"]\n        peak_strata = case[\"peak_strata\"]\n        background = case[\"background\"]\n        B = case[\"B\"]\n        seed = case[\"seed\"]\n\n        n_peaks = len(peak_methylation)\n\n        # 1. Compute the observed fraction of unmethylated peaks\n        observed_unmethylated_count = np.sum(peak_methylation <= tau)\n        observed_fraction = observed_unmethylated_count / n_peaks\n\n        # 2. Perform stratified permutation test\n        \n        # Determine unique strata and counts per stratum\n        strata_labels, strata_counts = np.unique(peak_strata, return_counts=True)\n        strata_info = dict(zip(strata_labels, strata_counts))\n\n        # Initialize random number generator for reproducibility\n        rng = np.random.default_rng(seed)\n\n        permuted_fractions = np.zeros(B)\n        \n        for i in range(B):\n            permuted_methylation = []\n            for stratum, count in strata_info.items():\n                background_pool = background[stratum]\n                # Sample 'count' values from the background pool without replacement\n                samples = rng.choice(background_pool, size=count, replace=False)\n                permuted_methylation.extend(samples)\n            \n            permuted_methylation = np.array(permuted_methylation)\n            permuted_unmethylated_count = np.sum(permuted_methylation <= tau)\n            permuted_fractions[i] = permuted_unmethylated_count / n_peaks\n            \n        # 3. Compute the one-sided P-value with +1 correction\n        # Count how many permuted fractions are >= observed fraction\n        count_ge_observed = np.sum(permuted_fractions >= observed_fraction)\n        p_value = (count_ge_observed + 1) / (B + 1)\n        \n        all_results.append([observed_fraction, p_value])\n\n    # Format the final output string\n    formatted_pairs = []\n    for fraction, pvalue in all_results:\n        formatted_pairs.append(f\"[{fraction:.6f},{pvalue:.6f}]\")\n    \n    final_output_string = f\"[{','.join(formatted_pairs)}]\"\n    print(final_output_string)\n\nsolve()\n```", "id": "2805078"}]}