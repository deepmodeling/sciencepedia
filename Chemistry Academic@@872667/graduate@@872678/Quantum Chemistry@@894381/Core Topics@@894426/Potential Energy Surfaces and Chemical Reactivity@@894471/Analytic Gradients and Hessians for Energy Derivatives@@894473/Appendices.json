{"hands_on_practices": [{"introduction": "Before relying on a complex analytic gradient code, it's essential to have a method for verification, and the most straightforward approach is numerical differentiation using a finite-difference formula. This exercise explores the practical challenges of this seemingly simple task [@problem_id:2874113]. By analyzing the trade-off between truncation error from the mathematical approximation and numerical noise from finite-precision arithmetic, you will derive the optimal step size, a critical skill for obtaining reliable numerical derivatives and appreciating the robustness of analytic methods.", "problem": "In Born–Oppenheimer quantum chemistry, the molecular force component along a single internal coordinate $R$ is $F(R)=-\\frac{dE(R)}{dR}$, where $E(R)$ is the electronic energy at fixed nuclear coordinates. Suppose $E(R)$ is sufficiently smooth and you approximate the derivative $\\frac{dE(R)}{dR}$ by the central finite-difference estimator\n$$\nG_{h}(R)\\;=\\;\\frac{E(R+h)\\;-\\;E(R-h)}{2h}.\n$$\nAssume two independent sources of error:\n- Truncation error arises from the Taylor-series remainder and scales with $h$ as $\\mathcal{O}(h^{2})$.\n- Numerical noise arises because each computed energy evaluation $E(R\\pm h)$ is contaminated by an additive error due to floating-point roundoff and incomplete Self-Consistent Field (SCF) convergence. Model this by assuming the computed energies are $\\tilde{E}(R\\pm h)=E(R\\pm h)+\\delta_{\\pm}$ with $|\\delta_{\\pm}|\\le \\sigma_{E}$, where $\\sigma_{E}$ is a known bound on the absolute energy error that aggregates machine roundoff and SCF residual.\n\nStarting only from the Taylor expansion for $E(R\\pm h)$ about $R$ with an integral-form remainder and the above noise model, derive the leading-order expression for the magnitude of the total error in $G_{h}(R)$ as a function of $h$, $E^{(3)}(R)$, and $\\sigma_{E}$. Then determine the step size $h$ that minimizes this leading-order error. Express your final answer as a single closed-form analytic expression for the optimal step size $h_{\\text{opt}}$ in terms of $\\sigma_{E}$ and $E^{(3)}(R)$. Do not substitute numerical values and do not include units in your final expression.", "solution": "The problem requires the derivation of an optimal step size, $h_{\\text{opt}}$, for a central finite-difference approximation of an energy derivative. The derivation must account for two competing sources of error: the truncation error inherent in the finite-difference formula and the numerical noise from the energy evaluation. The total error must first be expressed as a function of the step size $h$, and then this function must be minimized to find the optimal $h$.\n\nThe quantity to be approximated is the first derivative of the energy, $E'(R) = \\frac{dE(R)}{dR}$. The central finite-difference estimator for this quantity is given by $D_h(R) = \\frac{E(R+h) - E(R-h)}{2h}$. Note that the force is $F(R) = -E'(R)$, so we are computing an approximation to $-F(R)$. The total error in our computation of the derivative is the difference between the computed value, which includes numerical noise, and the true value of the derivative.\n\nLet us first determine the truncation error, $\\epsilon_{\\text{trunc}}$. This error is the difference between the finite-difference approximation using exact energies and the true derivative: $\\epsilon_{\\text{trunc}}(h) = D_h(R) - E'(R)$. We are instructed to use the Taylor series expansion with the integral form of the remainder. For a sufficiently smooth function $E(R)$, the expansions for $E(R+h)$ and $E(R-h)$ about $R$ up to the second-order term are:\n$$\nE(R+h) = E(R) + E'(R)h + \\frac{E''(R)}{2!}h^2 + \\frac{1}{2!} \\int_R^{R+h} (R+h-t)^2 E^{(3)}(t) dt\n$$\n$$\nE(R-h) = E(R) - E'(R)h + \\frac{E''(R)}{2!}h^2 + \\frac{1}{2!} \\int_R^{R-h} (R-h-t)^2 E^{(3)}(t) dt\n$$\nSubtracting the second equation from the first gives:\n$$\nE(R+h) - E(R-h) = 2E'(R)h + \\frac{1}{2} \\left( \\int_R^{R+h} (R+h-t)^2 E^{(3)}(t) dt - \\int_R^{R-h} (R-h-t)^2 E^{(3)}(t) dt \\right)\n$$\nDividing by $2h$ to form the finite-difference expression $D_h(R)$:\n$$\nD_h(R) = E'(R) + \\frac{1}{4h} \\left( \\int_R^{R+h} (R+h-t)^2 E^{(3)}(t) dt - \\int_R^{R-h} (R-h-t)^2 E^{(3)}(t) dt \\right)\n$$\nThe truncation error is therefore:\n$$\n\\epsilon_{\\text{trunc}}(h) = \\frac{1}{4h} \\left( \\int_R^{R+h} (R+h-t)^2 E^{(3)}(t) dt - \\int_R^{R-h} (R-h-t)^2 E^{(3)}(t) dt \\right)\n$$\nTo find the leading-order behavior, we assume $h$ is small. For $t$ in the integration intervals $[R-h, R+h]$, we can approximate the third derivative $E^{(3)}(t)$ by its value at the center of the interval, $E^{(3)}(R)$, as $E^{(3)}(t) \\approx E^{(3)}(R)$. This is justified because the function $E(R)$ is assumed to be smooth.\n$$\n\\epsilon_{\\text{trunc}}(h) \\approx \\frac{E^{(3)}(R)}{4h} \\left( \\int_R^{R+h} (R+h-t)^2 dt - \\int_R^{R-h} (R-h-t)^2 dt \\right)\n$$\nThe integrals evaluate to:\n$$\n\\int_R^{R+h} (R+h-t)^2 dt = \\left[ -\\frac{(R+h-t)^3}{3} \\right]_R^{R+h} = 0 - \\left(-\\frac{h^3}{3}\\right) = \\frac{h^3}{3}\n$$\n$$\n\\int_R^{R-h} (R-h-t)^2 dt = \\left[ -\\frac{(R-h-t)^3}{3} \\right]_R^{R-h} = 0 - \\left(-\\frac{(-h)^3}{3}\\right) = -\\frac{h^3}{3}\n$$\nSubstituting these back into the expression for $\\epsilon_{\\text{trunc}}(h)$:\n$$\n\\epsilon_{\\text{trunc}}(h) \\approx \\frac{E^{(3)}(R)}{4h} \\left( \\frac{h^3}{3} - \\left(-\\frac{h^3}{3}\\right) \\right) = \\frac{E^{(3)}(R)}{4h} \\left( \\frac{2h^3}{3} \\right) = \\frac{E^{(3)}(R)}{6}h^2\n$$\nThe magnitude of the leading-order truncation error is $|\\epsilon_{\\text{trunc}}(h)| \\approx \\frac{|E^{(3)}(R)|}{6}h^2$.\n\nNext, we analyze the error from numerical noise. The computed gradient estimator $\\tilde{G}_h(R)$ uses energies contaminated with errors $\\delta_{\\pm}$:\n$$\n\\tilde{G}_h(R) = \\frac{\\tilde{E}(R+h) - \\tilde{E}(R-h)}{2h} = \\frac{(E(R+h) + \\delta_+) - (E(R-h) + \\delta_-)}{2h}\n$$\n$$\n\\tilde{G}_h(R) = \\frac{E(R+h) - E(R-h)}{2h} + \\frac{\\delta_+ - \\delta_-}{2h} = D_h(R) + \\epsilon_{\\text{noise}}(h)\n$$\nThe error due to numerical noise is $\\epsilon_{\\text{noise}}(h) = \\frac{\\delta_+ - \\delta_-}{2h}$. We are given an upper bound on the magnitude of the individual energy errors: $|\\delta_{\\pm}| \\le \\sigma_E$. We seek a bound for the magnitude of the noise error $|\\epsilon_{\\text{noise}}(h)|$:\n$$\n|\\epsilon_{\\text{noise}}(h)| = \\left| \\frac{\\delta_+ - \\delta_-}{2h} \\right| = \\frac{|\\delta_+ - \\delta_-|}{2h}\n$$\nUsing the triangle inequality, $|\\delta_+ - \\delta_-| \\le |\\delta_+| + |-\\delta_-| = |\\delta_+| + |\\delta_-|$. The worst-case scenario occurs when the errors have opposite signs and maximum magnitude:\n$$\n|\\epsilon_{\\text{noise}}(h)| \\le \\frac{|\\delta_+| + |\\delta_-|}{2h} \\le \\frac{\\sigma_E + \\sigma_E}{2h} = \\frac{2\\sigma_E}{2h} = \\frac{\\sigma_E}{h}\n$$\nThe total error in the computed gradient is $\\epsilon_{\\text{total}} = \\tilde{G}_h(R) - E'(R) = \\epsilon_{\\text{trunc}}(h) + \\epsilon_{\\text{noise}}(h)$. The magnitude of the total error is bounded by the sum of the magnitudes of the individual error contributions (again, by the triangle inequality):\n$$\n|\\epsilon_{\\text{total}}(h)| \\le |\\epsilon_{\\text{trunc}}(h)| + |\\epsilon_{\\text{noise}}(h)|\n$$\nWe define the total error function $\\mathcal{E}(h)$ using the leading-order truncation error and the worst-case noise error:\n$$\n\\mathcal{E}(h) = \\frac{|E^{(3)}(R)|}{6}h^2 + \\frac{\\sigma_E}{h}\n$$\nTo find the step size $h$ that minimizes this total error, we differentiate $\\mathcal{E}(h)$ with respect to $h$ and set the result to zero:\n$$\n\\frac{d\\mathcal{E}(h)}{dh} = \\frac{d}{dh} \\left( \\frac{|E^{(3)}(R)|}{6}h^2 + \\sigma_E h^{-1} \\right) = 2 \\frac{|E^{(3)}(R)|}{6}h - \\sigma_E h^{-2} = \\frac{|E^{(3)}(R)|}{3}h - \\frac{\\sigma_E}{h^2}\n$$\nSetting the derivative to zero to find the optimal step size, $h_{\\text{opt}}$:\n$$\n\\frac{|E^{(3)}(R)|}{3}h_{\\text{opt}} - \\frac{\\sigma_E}{h_{\\text{opt}}^2} = 0\n$$\n$$\n\\frac{|E^{(3)}(R)|}{3}h_{\\text{opt}} = \\frac{\\sigma_E}{h_{\\text{opt}}^2}\n$$\n$$\nh_{\\text{opt}}^3 = \\frac{3\\sigma_E}{|E^{(3)}(R)|}\n$$\nSolving for $h_{\\text{opt}}$ yields:\n$$\nh_{\\text{opt}} = \\left( \\frac{3\\sigma_E}{|E^{(3)}(R)|} \\right)^{\\frac{1}{3}}\n$$\nThe second derivative, $\\frac{d^2\\mathcal{E}}{dh^2} = \\frac{|E^{(3)}(R)|}{3} + \\frac{2\\sigma_E}{h^3}$, is positive for positive $h$, $\\sigma_E$, and non-zero $E^{(3)}(R)$, confirming that this value of $h$ corresponds to a minimum of the error function. The use of the absolute value $|E^{(3)}(R)|$ is necessary to ensure the step size $h_{\\text{opt}}$ is a real and positive quantity.", "answer": "$$\n\\boxed{\\left( \\frac{3\\sigma_{E}}{|E^{(3)}(R)|} \\right)^{\\frac{1}{3}}}\n$$", "id": "2874113"}, {"introduction": "The potential energy of a molecule is naturally a function of its $3N$ Cartesian coordinates, but geometry optimizations are often more efficient when performed in a set of internal coordinates, such as bond lengths, angles, and dihedrals. This requires transforming derivatives between coordinate systems, a key step in many quantum chemistry programs. This practice delves into the analytic differentiation of a dihedral angle, a fundamental and non-trivial internal coordinate, with respect to Cartesian coordinates [@problem_id:2874054]. Mastering this derivation provides deep insight into the geometric underpinnings of molecular gradients and highlights practical challenges, such as the singularities that arise when atoms become collinear.", "problem": "In internal coordinates used for geometry optimization in quantum chemistry, the dihedral angle $\\,\\phi(i,j,k,l)\\,$ associated with four atoms $\\,i,j,k,l\\,$ is the signed angle between the planes $\\, (i,j,k)\\,$ and $\\, (j,k,l)\\,$ with the sign chosen by the right-hand rule about the bond vector from $\\,j\\,$ to $\\,k$. Let the Cartesian positions be $\\,\\mathbf{r}_i,\\mathbf{r}_j,\\mathbf{r}_k,\\mathbf{r}_l \\in \\mathbb{R}^3$. Define the bond vectors $\\,\\mathbf{b}_1 = \\mathbf{r}_j - \\mathbf{r}_i\\,$, $\\,\\mathbf{b}_2 = \\mathbf{r}_k - \\mathbf{r}_j\\,$, and $\\,\\mathbf{b}_3 = \\mathbf{r}_l - \\mathbf{r}_k\\,$. Define the plane normals $\\,\\mathbf{u} = \\mathbf{b}_1 \\times \\mathbf{b}_2\\,$ and $\\,\\mathbf{v} = \\mathbf{b}_2 \\times \\mathbf{b}_3\\,$. A smooth signed definition of the dihedral is $\\,\\phi = \\arctan2(\\beta,\\alpha)\\,$ with $\\,\\alpha = \\mathbf{u}\\cdot\\mathbf{v}\\,$ and $\\,\\beta = \\|\\mathbf{b}_2\\|\\,(\\mathbf{b}_1\\cdot \\mathbf{v})\\,$, where $\\,\\arctan2(y,x)\\,$ returns the angle whose tangent is $\\,y/x\\,$ in the correct quadrant.\n\nTasks:\n1. Starting from these definitions and using only standard vector calculus and differential identities, derive the first-order differential $\\,\\mathrm{d}\\phi\\,$ in terms of $\\,\\mathrm{d}\\mathbf{r}_i, \\mathrm{d}\\mathbf{r}_j, \\mathrm{d}\\mathbf{r}_k, \\mathrm{d}\\mathbf{r}_l\\,$. Express $\\,\\mathrm{d}\\phi\\,$ via $\\,\\mathrm{d}\\alpha\\,$ and $\\,\\mathrm{d}\\beta\\,$ and then in terms of differentials of the Cartesian coordinates through $\\,\\mathrm{d}\\mathbf{b}_1, \\mathrm{d}\\mathbf{b}_2, \\mathrm{d}\\mathbf{b}_3\\,$. You may use the product rules $\\,\\mathrm{d}(\\mathbf{a}\\cdot\\mathbf{b}) = \\mathrm{d}\\mathbf{a}\\cdot\\mathbf{b} + \\mathbf{a}\\cdot\\mathrm{d}\\mathbf{b}\\,$ and $\\,\\mathrm{d}(\\mathbf{a}\\times\\mathbf{b}) = \\mathrm{d}\\mathbf{a}\\times\\mathbf{b} + \\mathbf{a}\\times\\mathrm{d}\\mathbf{b}\\,$, and $\\,\\mathrm{d}\\|\\mathbf{b}_2\\| = (\\mathbf{b}_2\\cdot \\mathrm{d}\\mathbf{b}_2)/\\|\\mathbf{b}_2\\|\\,$.\n2. Use your general expression for $\\,\\mathrm{d}\\phi\\,$ to identify the singular conditions for the analytic derivative $\\,\\partial \\phi/\\partial \\mathbf{r}_a\\,$ (for $\\,a\\in\\{i,j,k,l\\}$) when atoms become collinear. Characterize which collinearities cause singular behavior and how this appears in your formula.\n3. Specialize your general result to the following concrete geometry (all coordinates in ångström): $\\,\\mathbf{r}_i = (0,0,0)\\,$, $\\,\\mathbf{r}_j=(1,0,0)\\,$, $\\,\\mathbf{r}_k=(1,1,0)\\,$, $\\,\\mathbf{r}_l=(1,1,1)\\,$. Compute the single Cartesian partial derivative $\\,\\partial \\phi / \\partial z_i\\,$ at this geometry. Express the derivative in radians per ångström. Provide the exact value (no rounding).", "solution": "The problem is well-posed, scientifically grounded, and contains all necessary information for a complete derivation and calculation. It is a standard problem in theoretical chemistry concerning the geometric derivatives required for molecular structure optimization. We proceed with the solution.\n\nThe dihedral angle $\\phi$ is defined as $\\phi = \\arctan2(\\beta, \\alpha)$ with $\\alpha = \\mathbf{u} \\cdot \\mathbf{v}$ and $\\beta = \\|\\mathbf{b}_2\\| (\\mathbf{b}_1 \\cdot \\mathbf{v})$. The vectors $\\mathbf{u} = \\mathbf{b}_1 \\times \\mathbf{b}_2$ and $\\mathbf{v} = \\mathbf{b}_2 \\times \\mathbf{b}_3$ are the normals to the planes $(i,j,k)$ and $(j,k,l)$ respectively. The bond vectors are $\\mathbf{b}_1 = \\mathbf{r}_j - \\mathbf{r}_i$, $\\mathbf{b}_2 = \\mathbf{r}_k - \\mathbf{r}_j$, and $\\mathbf{b}_3 = \\mathbf{r}_l - \\mathbf{r}_k$.\n\nFirst, we establish a key relationship between $\\alpha, \\beta, \\mathbf{u}, \\mathbf{v}$. The vector quadruple product gives $\\mathbf{u} \\times \\mathbf{v} = (\\mathbf{b}_1 \\times \\mathbf{b}_2) \\times (\\mathbf{b}_2 \\times \\mathbf{b}_3) = (\\mathbf{b}_1 \\cdot (\\mathbf{b}_2 \\times \\mathbf{b}_3)) \\mathbf{b}_2 - ((\\mathbf{b}_1 \\times \\mathbf{b}_2) \\cdot \\mathbf{b}_3) \\mathbf{b}_2$. This identity requires the planes of the cross products to intersect. Using the scalar triple product identity $[\\mathbf{A},\\mathbf{B},\\mathbf{C}] = \\mathbf{A}\\cdot(\\mathbf{B}\\times\\mathbf{C}) = (\\mathbf{A}\\times\\mathbf{B})\\cdot\\mathbf{C}$, the identity simplifies to $\\mathbf{u} \\times \\mathbf{v} = [\\mathbf{b}_1, \\mathbf{b}_2, \\mathbf{b}_3] \\mathbf{b}_2 = (\\mathbf{b}_1 \\cdot \\mathbf{v}) \\mathbf{b}_2$. Substituting the definition of $\\beta$, we find $\\mathbf{u} \\times \\mathbf{v} = \\frac{\\beta}{\\|\\mathbf{b}_2\\|} \\mathbf{b}_2$. The magnitude squared of this vector is $\\|\\mathbf{u} \\times \\mathbf{v}\\|^2 = \\frac{\\beta^2}{\\|\\mathbf{b}_2\\|^2} \\|\\mathbf{b}_2\\|^2 = \\beta^2$. Also, $\\|\\mathbf{u} \\times \\mathbf{v}\\|^2 = \\|\\mathbf{u}\\|^2 \\|\\mathbf{v}\\|^2 \\sin^2(\\phi) = \\|\\mathbf{u}\\|^2 \\|\\mathbf{v}\\|^2 - (\\mathbf{u} \\cdot \\mathbf{v})^2 = \\|\\mathbf{u}\\|^2 \\|\\mathbf{v}\\|^2 - \\alpha^2$. Thus, we have the important relation $\\alpha^2 + \\beta^2 = \\|\\mathbf{u}\\|^2 \\|\\mathbf{v}\\|^2$.\n\n**Task 1: Derivation of the differential $\\mathrm{d}\\phi$**\n\nThe differential of $\\phi = \\arctan2(\\beta, \\alpha)$ is given by the standard formula:\n$$\n\\mathrm{d}\\phi = \\frac{\\alpha\\,\\mathrm{d}\\beta - \\beta\\,\\mathrm{d}\\alpha}{\\alpha^2 + \\beta^2} = \\frac{\\alpha\\,\\mathrm{d}\\beta - \\beta\\,\\mathrm{d}\\alpha}{\\|\\mathbf{u}\\|^2 \\|\\mathbf{v}\\|^2}\n$$\nA more elegant derivation than expanding $\\mathrm{d}\\alpha$ and $\\mathrm{d}\\beta$ term by term uses vector identities to directly find the coefficients for $\\mathrm{d}\\mathbf{b}_n$. The final gradients with respect to atom positions are known to be:\n$$\n\\frac{\\partial\\phi}{\\partial\\mathbf{r}_i} = -\\frac{\\|\\mathbf{b}_2\\|}{\\|\\mathbf{u}\\|^2}\\mathbf{u}\n$$\n$$\n\\frac{\\partial\\phi}{\\partial\\mathbf{r}_l} = \\frac{\\|\\mathbf{b}_2\\|}{\\|\\mathbf{v}\\|^2}\\mathbf{v}\n$$\nThe forces on the other atoms can be found from these and the relationship $\\sum_a \\frac{\\partial\\phi}{\\partial\\mathbf{r}_a} = \\mathbf{0}$. The full differential is:\n$$\n\\mathrm{d}\\phi = \\sum_{a=i,j,k,l} \\frac{\\partial\\phi}{\\partial\\mathbf{r}_a}\\cdot\\mathrm{d}\\mathbf{r}_a\n$$\nUsing the definitions $\\mathrm{d}\\mathbf{b}_1 = \\mathrm{d}\\mathbf{r}_j - \\mathrm{d}\\mathbf{r}_i$, $\\mathrm{d}\\mathbf{b}_2=\\mathrm{d}\\mathbf{r}_k - \\mathrm{d}\\mathbf{r}_j$, $\\mathrm{d}\\mathbf{b}_3=\\mathrm{d}\\mathbf{r}_l - \\mathrm{d}\\mathbf{r}_k$, the gradients are:\n$$\n\\frac{\\partial\\phi}{\\partial\\mathbf{r}_i} = -\\frac{\\|\\mathbf{b}_2\\|}{\\|\\mathbf{u}\\|^2}\\mathbf{u}\n$$\n$$\n\\frac{\\partial\\phi}{\\partial\\mathbf{r}_l} = \\frac{\\|\\mathbf{b}_2\\|}{\\|\\mathbf{v}\\|^2}\\mathbf{v}\n$$\n$$\n\\frac{\\partial\\phi}{\\partial\\mathbf{r}_j} = \\frac{\\|\\mathbf{b}_2\\|}{\\|\\mathbf{u}\\|^2}\\mathbf{u} + \\frac{(\\mathbf{b}_1 \\cdot \\mathbf{b}_2)\\|\\mathbf{b}_2\\|}{\\|\\mathbf{b}_2\\|^2\\|\\mathbf{u}\\|^2}\\mathbf{u} - \\frac{(\\mathbf{b}_3 \\cdot \\mathbf{b}_2)\\|\\mathbf{b}_2\\|}{\\|\\mathbf{b}_2\\|^2\\|\\mathbf{v}\\|^2}\\mathbf{v}\n$$\n$$\n\\frac{\\partial\\phi}{\\partial\\mathbf{r}_k} = -\\frac{\\partial\\phi}{\\partial\\mathbf{r}_i} - \\frac{\\partial\\phi}{\\partial\\mathbf{r}_j} - \\frac{\\partial\\phi}{\\partial\\mathbf{r}_l}\n$$\n\n**Task 2: Singular conditions**\n\nThe analytic derivatives $\\frac{\\partial\\phi}{\\partial\\mathbf{r}_a}$ involve denominators $\\|\\mathbf{u}\\|^2$ and $\\|\\mathbf{v}\\|^2$. A singularity occurs if either of these is zero.\n$\\|\\mathbf{u}\\| = \\|\\mathbf{b}_1 \\times \\mathbf{b}_2\\| = 0$ if and only if the vectors $\\mathbf{b}_1 = \\mathbf{r}_j - \\mathbf{r}_i$ and $\\mathbf{b}_2 = \\mathbf{r}_k - \\mathbf{r}_j$ are collinear. This corresponds to the atoms $i, j, k$ lying on a single straight line.\nSimilarly, $\\|\\mathbf{v}\\| = \\|\\mathbf{b}_2 \\times \\mathbf{b}_3\\| = 0$ if and only if the vectors $\\mathbf{b}_2 = \\mathbf{r}_k - \\mathbf{r}_j$ and $\\mathbf{b}_3 = \\mathbf{r}_l - \\mathbf{r}_k$ are collinear. This corresponds to the atoms $j, k, l$ lying on a single straight line.\n\nWhen atoms $i,j,k$ are collinear, $\\mathbf{u} = \\mathbf{0}$. This leads to $\\alpha = \\mathbf{u}\\cdot\\mathbf{v} = 0$. Furthermore, $\\beta = \\|\\mathbf{b}_2\\|(\\mathbf{b}_1\\cdot\\mathbf{v}) = \\|\\mathbf{b}_2\\|(\\mathbf{b}_1\\cdot(\\mathbf{b}_2\\times\\mathbf{b}_3)) = \\|\\mathbf{b}_2\\|((\\mathbf{b}_1\\times\\mathbf{b}_2)\\cdot\\mathbf{b}_3) = \\|\\mathbf{b}_2\\|(\\mathbf{u}\\cdot\\mathbf{b}_3)=0$.\nIn this case, the denominator of the original differential expression, $\\alpha^2+\\beta^2$, becomes $0$. This indicates a singularity where the dihedral angle itself is not well-defined, and its derivative is therefore undefined.\nThe same logic applies when atoms $j,k,l$ are collinear, which makes $\\mathbf{v}=\\mathbf{0}$, and consequently $\\alpha=0$ and $\\beta=0$.\nTherefore, the analytic derivatives of the dihedral angle are singular whenever any three consecutive atoms in the sequence $(i,j,k,l)$ become collinear.\n\n**Task 3: Calculation for a specific geometry**\n\nWe are given the Cartesian coordinates: $\\mathbf{r}_i = (0,0,0)$, $\\mathbf{r}_j=(1,0,0)$, $\\mathbf{r}_k=(1,1,0)$, and $\\mathbf{r}_l=(1,1,1)$. We need to compute the partial derivative $\\partial \\phi / \\partial z_i$. This is the $z$-component of the gradient vector $\\frac{\\partial \\phi}{\\partial \\mathbf{r}_i}$.\n\nFirst, we compute the necessary vectors for this geometry:\n1.  Bond vectors:\n    $$\n    \\mathbf{b}_1 = \\mathbf{r}_j - \\mathbf{r}_i = (1,0,0) - (0,0,0) = (1,0,0)\n    $$\n    $$\n    \\mathbf{b}_2 = \\mathbf{r}_k - \\mathbf{r}_j = (1,1,0) - (1,0,0) = (0,1,0)\n    $$\n2.  Magnitude of $\\mathbf{b}_2$:\n    $$\n    \\|\\mathbf{b}_2\\| = \\sqrt{0^2 + 1^2 + 0^2} = 1\n    $$\n3.  Normal vector $\\mathbf{u}$:\n    $$\n    \\mathbf{u} = \\mathbf{b}_1 \\times \\mathbf{b}_2 = (1,0,0) \\times (0,1,0) = \\begin{vmatrix} \\mathbf{i} & \\mathbf{j} & \\mathbf{k} \\\\ 1 & 0 & 0 \\\\ 0 & 1 & 0 \\end{vmatrix} = (0,0,1)\n    $$\n4.  Squared magnitude of $\\mathbf{u}$:\n    $$\n    \\|\\mathbf{u}\\|^2 = 0^2 + 0^2 + 1^2 = 1\n    $$\nThe gradient with respect to the coordinates of atom $i$ is given by the formula derived in Task 1:\n$$\n\\frac{\\partial \\phi}{\\partial \\mathbf{r}_i} = -\\frac{\\|\\mathbf{b}_2\\|}{\\|\\mathbf{u}\\|^2}\\mathbf{u}\n$$\nSubstituting the computed values:\n$$\n\\frac{\\partial \\phi}{\\partial \\mathbf{r}_i} = -\\frac{1}{1}(0,0,1) = (0,0,-1)\n$$\nThe components of this gradient vector are the partial derivatives with respect to the Cartesian coordinates of atom $i$:\n$$\n\\frac{\\partial \\phi}{\\partial \\mathbf{r}_i} = \\left(\\frac{\\partial \\phi}{\\partial x_i}, \\frac{\\partial \\phi}{\\partial y_i}, \\frac{\\partial \\phi}{\\partial z_i}\\right)\n$$\nTherefore, the specific partial derivative required is the $z$-component of this vector:\n$$\n\\frac{\\partial \\phi}{\\partial z_i} = -1\n$$\nThe coordinates are in ångström, so the derivative is in units of radians per ångström.", "answer": "$$\\boxed{-1}$$", "id": "2874054"}, {"introduction": "At the most fundamental level, analytic energy derivatives require the differentiation of the underlying electron repulsion integrals (ERIs) with respect to nuclear coordinates. This dependency enters through the Boys function, $F_n(T)$, whose argument $T$ is a function of the Gaussian exponents and inter-nuclear distances. This exercise guides you through deriving the derivative of the Boys function, revealing a simple and elegant relationship that is central to the entire theory of analytic derivatives [@problem_id:2874088]. More importantly, it forces a confrontation with the critical issue of numerical stability, demonstrating how to construct a robust computational algorithm that avoids common pitfalls like catastrophic cancellation.", "problem": "Consider primitive Gaussian-type orbitals with exponents $\\alpha$ and $\\beta$ centered at nuclei located at $\\mathbf{A}$ and $\\mathbf{B}$, respectively. By the Gaussian product theorem, the product of two Gaussians centered at $\\mathbf{A}$ and $\\mathbf{B}$ can be written as a Gaussian centered at the composite center $\\mathbf{P}$ with exponent $\\zeta = \\alpha + \\beta$, multiplied by a Gaussian prefactor depending on $\\mathbf{A}$ and $\\mathbf{B}$. In the standard derivation of analytic expressions for the electron repulsion integral (ERI) over Gaussians, one encounters one-dimensional radial integrals of the form that define the Boys function,\n$$\nF_{n}(T) \\equiv \\int_{0}^{1} t^{2n} \\exp\\!\\big(-T t^{2}\\big)\\,\\mathrm{d}t,\n$$\nwhere $n \\in \\mathbb{N}_{0}$ and $T \\ge 0$ is a scalar that depends on Gaussian exponents and intercenter distances, e.g., $T = \\rho\\,|\\mathbf{P}-\\mathbf{Q}|^{2}$ with $\\rho = \\frac{\\alpha \\beta}{\\alpha + \\beta}$ and $\\mathbf{P}, \\mathbf{Q}$ composite centers arising from the Gaussian product theorem on electron $1$ and electron $2$ coordinates, respectively.\n\nIn analytic energy gradients and Hessians, derivatives of ERIs with respect to nuclear Cartesian coordinates appear. Through the chain rule, differentiation of ERIs introduces derivatives of $F_{n}(T)$ with respect to $T$, multiplied by derivatives of $T$ with respect to nuclear coordinates. Working from the fundamental definition of $F_{n}(T)$ above and standard properties of Gaussian integrals, do the following:\n\n- Explain why derivatives of the ERI with respect to nuclear coordinates necessarily contain factors of $\\frac{\\mathrm{d}F_{n}}{\\mathrm{d}T}$ multiplied by derivatives of $T$.\n- Starting strictly from the defining integral for $F_{n}(T)$, derive a closed-form expression for $\\frac{\\mathrm{d}F_{n}}{\\mathrm{d}T}$ in terms of Boys functions.\n- Analyze the numerical stability of direct differentiation identities for $\\frac{\\mathrm{d}F_{n}}{\\mathrm{d}T}$ across the regimes of small $T$ (i.e., $T \\to 0$) and large $T$ (i.e., $T \\to \\infty$), identifying any potential loss of significance.\n- Construct a stable computational scheme for $\\frac{\\mathrm{d}F_{n}}{\\mathrm{d}T}$ that avoids catastrophic cancellation at small $T$ and retains accuracy at large $T$. Your scheme should rely only on well-tested expansions and recurrences derivable from the integral definition, namely:\n  - the Maclaurin series of $F_{n}(T)$ for small $T$,\n  - the large-$T$ asymptotic form of $F_{n}(T)$,\n  - and a directionally stable three-term recurrence connecting $F_{n+1}(T)$ and $F_{n}(T)$.\nExplain which direction of the recurrence is stable and why, and how to combine initialization and recurrence to cover all $T$.\n\nProvide, as your final answer, the single closed-form analytic expression you have derived for $\\frac{\\mathrm{d}F_{n}}{\\mathrm{d}T}$ in terms of Boys functions. No numerical evaluation is required, and no units are needed because $F_{n}(T)$ is dimensionless. Express your final answer as a single analytic expression.", "solution": "The problem posed is a standard, well-defined exercise in the analytic theory of molecular integrals in quantum chemistry. It is scientifically grounded, objective, and contains sufficient information for a rigorous analysis. We shall proceed with the derivation and discussion as requested.\n\nFirst, we address why derivatives of the electron repulsion integral (ERI) with respect to nuclear coordinates must involve derivatives of the Boys function, $F_n(T)$. An ERI over four Gaussian basis functions is written as $(\\mu\\nu|\\lambda\\sigma)$. By the Gaussian product theorem, the product of two Gaussians, e.g., $\\phi_{\\mu}$ and $\\phi_{\\nu}$, can be expressed as a single Gaussian centered at a new point $\\mathbf{P}$. The ERI then reduces to a two-electron integral over two new charge distributions centered at $\\mathbf{P}$ and $\\mathbf{Q}$. This integral is ultimately expressed as a finite sum of terms, where each term is a product of some constants and a Boys function $F_n(T)$. The argument $T$ is given by $T = \\rho |\\mathbf{P}-\\mathbf{Q}|^2$, where $\\rho$ is a function of the Gaussian exponents, and the centers $\\mathbf{P}$ and $\\mathbf{Q}$ are functions of the original nuclear coordinates $\\{\\mathbf{R}_A\\}$.\nTherefore, any ERI can be schematically written as a function of the nuclear coordinates $\\mathbf{R}_A$ through its dependence on the arguments $T_k$:\n$$\n\\text{ERI}(\\{\\mathbf{R}_A\\}) = \\sum_k C_k F_{n_k}(T_k(\\{\\mathbf{R}_A\\}))\n$$\nwhere $C_k$ are coefficients that also depend on nuclear coordinates. When differentiating with respect to a Cartesian component of a nuclear position, say $R_{A,x}$, the chain rule must be applied:\n$$\n\\frac{\\partial (\\text{ERI})}{\\partial R_{A,x}} = \\sum_k \\left( \\frac{\\partial C_k}{\\partial R_{A,x}} F_{n_k}(T_k) + C_k \\frac{\\mathrm{d}F_{n_k}}{\\mathrm{d}T_k} \\frac{\\partial T_k}{\\partial R_{A,x}} \\right)\n$$\nThe centers $\\mathbf{P}$ and $\\mathbf{Q}$ are weighted averages of nuclear coordinates, so their positions, and thus their separation $|\\mathbf{P}-\\mathbf{Q}|$, depend on $\\{\\mathbf{R}_A\\}$. Consequently, the term $\\frac{\\partial T_k}{\\partial R_{A,x}}$ is, in general, non-zero. This makes the appearance of the derivative $\\frac{\\mathrm{d}F_{n_k}}{\\mathrm{d}T_k}$ an unavoidable consequence of analytic gradient theory.\n\nNext, we derive a closed-form expression for $\\frac{\\mathrm{d}F_{n}}{\\mathrm{d}T}$. We begin with the integral definition of the Boys function:\n$$\nF_{n}(T) = \\int_{0}^{1} t^{2n} \\exp(-T t^{2})\\,\\mathrm{d}t\n$$\nThe integrand and its partial derivative with respect to $T$ are continuous functions of both $t$ and $T$ over the domain of integration and for $T \\ge 0$. Therefore, we can differentiate under the integral sign (Leibniz integral rule):\n$$\n\\frac{\\mathrm{d}F_{n}}{\\mathrm{d}T} = \\frac{\\mathrm{d}}{\\mathrm{d}T} \\int_{0}^{1} t^{2n} \\exp(-T t^{2})\\,\\mathrm{d}t = \\int_{0}^{1} \\frac{\\partial}{\\partial T} \\left( t^{2n} \\exp(-T t^{2}) \\right) \\,\\mathrm{d}t\n$$\nThe partial derivative of the integrand is:\n$$\n\\frac{\\partial}{\\partial T} \\left( t^{2n} \\exp(-T t^{2}) \\right) = t^{2n} \\left( -t^2 \\exp(-T t^{2}) \\right) = -t^{2n+2} \\exp(-T t^{2})\n$$\nSubstituting this back into the integral gives:\n$$\n\\frac{\\mathrm{d}F_{n}}{\\mathrm{d}T} = \\int_{0}^{1} (-1) t^{2(n+1)} \\exp(-T t^{2}) \\,\\mathrm{d}t = - \\int_{0}^{1} t^{2(n+1)} \\exp(-T t^{2}) \\,\\mathrm{d}t\n$$\nBy inspection, the resulting integral is the definition of $F_{n+1}(T)$. Therefore, we arrive at the compact and fundamental relationship:\n$$\n\\frac{\\mathrm{d}F_{n}}{\\mathrm{d}T} = -F_{n+1}(T)\n$$\n\nWe now analyze the numerical stability of using this identity. The identity itself is exact. Any numerical instability arises from the method used to evaluate $F_{n+1}(T)$. A common but flawed approach would be to use the upward recurrence relation for the Boys function, which can be derived through integration by parts:\n$$\nF_{n+1}(T) = \\frac{(2n+1)F_n(T) - \\exp(-T)}{2T}\n$$\nIf one has an accurate value for $F_n(T)$ and uses this formula to compute $F_{n+1}(T)$, severe loss of significance can occur, particularly for large values of $T$. In this regime, $\\exp(-T)$ is exceedingly small, and $F_n(T)$ also becomes small. The numerator involves the subtraction of two numbers, $(2n+1)F_n(T)$ and $\\exp(-T)$, which can be of similar magnitude, leading to catastrophic cancellation. The subsequent division by $2T$ further propagates any error. Thus, upward recursion is numerically unstable and must be avoided for computing the sequence of Boys functions. The \"direct differentiation identity\" is unstable only if coupled with an unstable evaluation method for $F_{n+1}(T)$.\n\nFinally, we construct a stable computational scheme for $\\frac{\\mathrm{d}F_{n}}{\\mathrm{d}T}$, which amounts to a stable scheme for computing $F_{n+1}(T)$. The strategy is partitioned based on the value of $T$.\n\nFor small $T$:\nThe Maclaurin series expansion of $F_n(T)$ is obtained by expanding the exponential term in its defining integral:\n$$\nF_n(T) = \\int_{0}^{1} t^{2n} \\sum_{k=0}^{\\infty} \\frac{(-Tt^2)^k}{k!} \\,\\mathrm{d}t = \\sum_{k=0}^{\\infty} \\frac{(-T)^k}{k!} \\int_{0}^{1} t^{2n+2k} \\,\\mathrm{d}t = \\sum_{k=0}^{\\infty} \\frac{(-T)^k}{k! (2n+2k+1)}\n$$\nFor small $T$, this is an alternating series with rapidly decreasing terms, which is numerically stable and converges quickly. To compute $\\frac{\\mathrm{d}F_n}{\\mathrm{d}T} = -F_{n+1}(T)$, one simply computes $F_{n+1}(T)$ using its own Maclaurin series:\n$$\nF_{n+1}(T) = \\sum_{k=0}^{\\infty} \\frac{(-T)^k}{k! (2n+2k+3)}\n$$\nThis approach is robust for $T$ below some threshold, e.g., $T < 10$.\n\nFor large $T$:\nThe series expansion becomes unsuitable. Instead, we use the downward recurrence relation, which is the stable direction. By rearranging the recurrence previously shown, we get:\n$$\nF_{n}(T) = \\frac{2T F_{n+1}(T) + \\exp(-T)}{2n+1}\n$$\nThis relation is stable for decreasing $n$ because division by the factor $2n+1$ suppresses any propagated error. To compute a set of Boys functions $\\{ F_k(T) \\}_{k=0}^{N_{max}}$, one starts from an index $M > N_{max}$ large enough such that $F_M(T)$ can be accurately approximated. The asymptotic form for large $T$ is $F_M(T) \\sim \\frac{(2M-1)!!\\sqrt{\\pi}}{2^{M+1}} T^{-M-1/2}$. For sufficiently large $M$, one can simply set $F_M(T) = 0$ as the starting guess.\nThe stable computational procedure is:\n1. Choose a starting index $M$ well above the highest required index $n+1$. A typical choice is $M \\approx n_{max} + T$.\n2. Initialize with $F_M(T) = 0$.\n3. Recurse downwards from $k=M$ to $k=1$ using the relation $F_{k-1}(T) = \\frac{2TF_k(T) + \\exp(-T)}{2k-1}$ to generate an un-normalized sequence $\\{F'_{k}(T)\\}$.\n4. Compute the value of $F_0(T)$ accurately. For non-zero $T$, this is given by $F_0(T) = \\frac{\\sqrt{\\pi}}{2\\sqrt{T}}\\text{erf}(\\sqrt{T})$, which itself can be computed using stable methods like continued fraction expansions for large $T$.\n5. The un-normalized value $F'_0(T)$ from the downward recurrence is proportional to the true value $F_0(T)$. The normalization constant is $C = F_0(T) / F'_0(T)$.\n6. Rescale the entire sequence: $F_k(T) = C \\times F'_k(T)$ for all required $k$, including $k=n+1$.\n7. The required derivative is then given by $-F_{n+1}(T)$, computed via this stable procedure.\n\nThis hybrid scheme, combining the Maclaurin series for small $T$ and a normalized downward recurrence for large $T$, provides a numerically robust method for evaluating Boys functions and, by extension, their derivatives with respect to $T$ across the entire domain $T \\ge 0$.", "answer": "$$\n\\boxed{-F_{n+1}(T)}\n$$", "id": "2874088"}]}