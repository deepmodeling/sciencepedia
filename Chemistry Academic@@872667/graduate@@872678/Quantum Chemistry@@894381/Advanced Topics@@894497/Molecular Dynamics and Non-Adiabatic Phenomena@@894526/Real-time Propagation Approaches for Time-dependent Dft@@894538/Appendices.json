{"hands_on_practices": [{"introduction": "Before we can simulate complex quantum dynamics, we must first ensure our numerical tools are reliable, as the choice of time-propagation algorithm is fundamental. This exercise explores the concept of numerical stability through von Neumann analysis, a cornerstone technique for assessing how errors evolve in finite-difference schemes. By comparing the unconditionally unstable explicit Euler method with the unconditionally stable Crank–Nicolson scheme for the time-dependent Schrödinger equation, you will gain a crucial, first-principles understanding of why certain algorithms are preferred for quantum simulations and how the time step $\\Delta t$ and grid spacing $h$ are critically linked [@problem_id:2919790].", "problem": "In real-time Time-Dependent Density Functional Theory (TDDFT), a common task is the numerical propagation of a Kohn–Sham orbital that, in the free-particle limit, satisfies the time-dependent Schrödinger equation in atomic units, $\\mathrm{i} \\,\\partial \\psi(x,t)/\\partial t = -\\frac{1}{2} \\,\\partial^{2}\\psi(x,t)/\\partial x^{2}$. Consider a spatially uniform, one-dimensional real-space grid with spacing $h$ and periodic boundary conditions. Approximate the Laplacian by the standard second-order central finite difference operator, $(\\partial^{2}\\psi/\\partial x^{2})(x_{j}) \\approx \\left(\\psi_{j+1}-2\\psi_{j}+\\psi_{j-1}\\right)/h^{2}$, where $\\psi_{j}(t) \\equiv \\psi(x_{j},t)$ and $x_{j}=j h$. Define the discrete Hamiltonian $H$ by its action $(H\\psi)_{j} = -\\frac{1}{2}\\,(\\psi_{j+1}-2\\psi_{j}+\\psi_{j-1})/h^{2}$.\n\nTwo time-propagation schemes are considered for advancing from $t^{n}$ to $t^{n+1}=t^{n}+\\Delta t$:\n- Explicit forward Euler: $\\psi^{n+1} = \\psi^{n} - \\mathrm{i}\\,\\Delta t\\, H \\psi^{n}$.\n- Crank–Nicolson (CN): $\\left(I + \\mathrm{i}\\,\\frac{\\Delta t}{2}\\,H\\right)\\psi^{n+1} = \\left(I - \\mathrm{i}\\,\\frac{\\Delta t}{2}\\,H\\right)\\psi^{n}$, where $I$ is the identity operator.\n\nPerform a von Neumann stability analysis by considering a Fourier mode $\\psi^{n}_{j} = G^{n}\\,\\exp(\\mathrm{i} \\kappa j h)$ with wavenumber $\\kappa$ in the first Brillouin zone. For each scheme:\n- Derive the amplification factor $G(\\kappa)$ as a function of $\\kappa$, $\\Delta t$, and $h$.\n- Determine the supremum over all $\\kappa$ of the modulus of the amplification factor, and express it as a function of the Courant-like ratio $r \\equiv \\Delta t/h^{2}$.\n- Using the condition for stability that the spectral radius does not exceed unity for all $\\kappa$, deduce the largest admissible $r$ (that is, the supremum of all $r \\ge 0$ that satisfies the stability condition) for each scheme.\n\nProvide your final answer as a single row matrix containing these two largest admissible values of $r$ (first entry for explicit Euler, second entry for Crank–Nicolson). No derivations should appear in the final answer. The final answer must be an exact symbolic expression.", "solution": "The problem statement presents a well-posed task in the field of computational quantum mechanics, specifically the von Neumann stability analysis of numerical schemes for the time-dependent Schrödinger equation. The premises are scientifically grounded, and the objectives are defined with sufficient rigor. The problem is therefore deemed valid and a solution can be constructed.\n\nThe analysis begins with the action of the discrete Hamiltonian operator, $H$, on a general Fourier mode, $\\psi_j = \\exp(\\mathrm{i} \\kappa j h)$, where $\\psi_j \\equiv \\psi(x_j)$ and $x_j = j h$. The operator is defined by its action on the grid points $\\psi_j$ as $(H\\psi)_{j} = -\\frac{1}{2h^{2}}(\\psi_{j+1}-2\\psi_{j}+\\psi_{j-1})$. Applying this to the Fourier mode yields:\n$$ (H \\exp(\\mathrm{i} \\kappa j h))_j = -\\frac{1}{2h^{2}} \\left( \\exp(\\mathrm{i} \\kappa (j+1) h) - 2\\exp(\\mathrm{i} \\kappa j h) + \\exp(-\\mathrm{i} \\kappa (j-1) h) \\right) $$\nFactoring out the term $\\exp(\\mathrm{i} \\kappa j h)$:\n$$ (H \\exp(\\mathrm{i} \\kappa j h))_j = -\\frac{\\exp(\\mathrm{i} \\kappa j h)}{2h^{2}} \\left( \\exp(\\mathrm{i} \\kappa h) - 2 + \\exp(-\\mathrm{i} \\kappa h) \\right) $$\nUsing the identity $2\\cos(\\theta) = \\exp(\\mathrm{i}\\theta) + \\exp(-\\mathrm{i}\\theta)$, the expression in the parenthesis becomes $2\\cos(\\kappa h) - 2$.\n$$ (H \\exp(\\mathrm{i} \\kappa j h))_j = -\\frac{\\exp(\\mathrm{i} \\kappa j h)}{2h^{2}} \\left( 2\\cos(\\kappa h) - 2 \\right) = \\frac{1 - \\cos(\\kappa h)}{h^{2}} \\exp(\\mathrm{i} \\kappa j h) $$\nEmploying the half-angle identity $1 - \\cos(\\theta) = 2\\sin^2(\\theta/2)$, we find that the Fourier mode is an eigenfunction of the discrete Hamiltonian operator $H$ with a real-valued eigenvalue $\\lambda(\\kappa)$:\n$$ \\lambda(\\kappa) = \\frac{2}{h^2} \\sin^2\\left(\\frac{\\kappa h}{2}\\right) $$\nThis result is the foundation for analyzing both propagation schemes.\n\nThe von Neumann stability analysis proceeds by substituting the ansatz $\\psi^{n}_{j} = G^{n}\\,\\exp(\\mathrm{i} \\kappa j h)$ into the finite-difference time-stepping scheme. The condition for stability is that the amplification factor $G(\\kappa)$ must satisfy $|G(\\kappa)| \\le 1$ for all wavenumbers $\\kappa$ within the first Brillouin zone.\n\nAnalysis of the Explicit Forward Euler scheme:\nThe scheme is given by $\\psi^{n+1} = \\psi^{n} - \\mathrm{i}\\,\\Delta t\\, H \\psi^{n} = (I - \\mathrm{i}\\,\\Delta t\\,H)\\psi^n$.\nSubstituting the ansatz gives:\n$$ G^{n+1}\\exp(\\mathrm{i} \\kappa j h) = (I - \\mathrm{i}\\,\\Delta t\\,H) G^{n}\\exp(\\mathrm{i} \\kappa j h) $$\nSince $\\exp(\\mathrm{i} \\kappa j h)$ is an eigenfunction of $H$, we can replace the operator $H$ with its eigenvalue $\\lambda(\\kappa)$:\n$$ G^{n+1} = (1 - \\mathrm{i}\\,\\Delta t\\,\\lambda(\\kappa))G^{n} $$\nThe amplification factor is therefore $G(\\kappa) = 1 - \\mathrm{i}\\,\\Delta t\\,\\lambda(\\kappa)$. Substituting the expression for $\\lambda(\\kappa)$ and the definition $r = \\Delta t/h^2$:\n$$ G(\\kappa) = 1 - \\mathrm{i}\\,\\Delta t\\, \\frac{2}{h^2} \\sin^2\\left(\\frac{\\kappa h}{2}\\right) = 1 - 2 \\mathrm{i} r \\sin^2\\left(\\frac{\\kappa h}{2}\\right) $$\nThe modulus of the amplification factor is:\n$$ |G(\\kappa)| = \\left| 1 - 2 \\mathrm{i} r \\sin^2\\left(\\frac{\\kappa h}{2}\\right) \\right| = \\sqrt{1^2 + \\left(-2r \\sin^2\\left(\\frac{\\kappa h}{2}\\right)\\right)^2} = \\sqrt{1 + 4r^2 \\sin^4\\left(\\frac{\\kappa h}{2}\\right)} $$\nTo determine the stability, we need the supremum of $|G(\\kappa)|$. The term $\\sin^4(\\kappa h/2)$ is maximized when $|\\sin(\\kappa h/2)|$ is maximized. Within the first Brillouin zone, $\\kappa \\in [-\\pi/h, \\pi/h]$, so the argument $\\kappa h/2$ is in $[-\\pi/2, \\pi/2]$. The maximum value of $|\\sin(\\kappa h/2)|$ is $1$. Thus, the supremum of the modulus is:\n$$ \\sup_{\\kappa} |G(\\kappa)| = \\sqrt{1 + 4r^2} $$\nThe stability condition requires $\\sup_{\\kappa} |G(\\kappa)| \\le 1$, which implies:\n$$ \\sqrt{1 + 4r^2} \\le 1 $$\n$$ 1 + 4r^2 \\le 1 $$\n$$ 4r^2 \\le 0 $$\nSince $r = \\Delta t/h^2$ must be non-negative ($r \\ge 0$), the only value of $r$ that satisfies this inequality is $r=0$. The set of admissible $r$ is $\\{0\\}$, and its supremum is $0$. This means the explicit forward Euler scheme is unconditionally unstable for the Schrödinger equation for any non-zero time step. The largest admissible value of $r$ is $0$.\n\nAnalysis of the Crank–Nicolson (CN) scheme:\nThe scheme is defined by $\\left(I + \\mathrm{i}\\,\\frac{\\Delta t}{2}\\,H\\right)\\psi^{n+1} = \\left(I - \\mathrm{i}\\,\\frac{\\Delta t}{2}\\,H\\right)\\psi^{n}$.\nSubstituting the ansatz $\\psi_j^n = G^n \\exp(\\mathrm{i} \\kappa j h)$ and replacing $H$ by its eigenvalue $\\lambda(\\kappa)$:\n$$ \\left(1 + \\mathrm{i}\\,\\frac{\\Delta t}{2}\\,\\lambda(\\kappa)\\right)G^{n+1} = \\left(1 - \\mathrm{i}\\,\\frac{\\Delta t}{2}\\,\\lambda(\\kappa)\\right)G^{n} $$\nThe amplification factor is:\n$$ G(\\kappa) = \\frac{1 - \\mathrm{i}\\,\\frac{\\Delta t}{2}\\,\\lambda(\\kappa)}{1 + \\mathrm{i}\\,\\frac{\\Delta t}{2}\\,\\lambda(\\kappa)} $$\nLet the real, non-negative quantity $A$ be defined as $A = \\frac{\\Delta t}{2}\\lambda(\\kappa) = \\frac{\\Delta t}{2} \\frac{2}{h^2} \\sin^2(\\frac{\\kappa h}{2}) = r \\sin^2(\\frac{\\kappa h}{2})$.\nThe amplification factor can be written as $G(\\kappa) = (1 - \\mathrm{i}A) / (1 + \\mathrm{i}A)$. The modulus is:\n$$ |G(\\kappa)| = \\frac{|1 - \\mathrm{i}A|}{|1 + \\mathrm{i}A|} = \\frac{\\sqrt{1^2 + (-A)^2}}{\\sqrt{1^2 + A^2}} = \\frac{\\sqrt{1+A^2}}{\\sqrt{1+A^2}} = 1 $$\nThe modulus of the amplification factor is exactly $1$ for all values of $\\kappa$, $\\Delta t$, and $h$. Thus, the supremum of the modulus is:\n$$ \\sup_{\\kappa} |G(\\kappa)| = 1 $$\nThe stability condition $\\sup_{\\kappa} |G(\\kappa)| \\le 1$ is satisfied for any choice of $r \\ge 0$. The scheme is unconditionally stable. The set of all admissible $r$ values is $[0, \\infty)$. The problem asks for the supremum of this set, which is $\\infty$.\n\nThe final result consists of the largest admissible values of $r$ for the explicit Euler and Crank-Nicolson schemes, respectively.\nFor explicit Euler, the largest admissible $r$ is $0$.\nFor Crank-Nicolson, the largest admissible $r$ is $\\infty$.", "answer": "$$\\boxed{\\begin{pmatrix} 0 & \\infty \\end{pmatrix}}$$", "id": "2919790"}, {"introduction": "Real-time propagation is not just a numerical exercise; it is a powerful tool for predicting the response of materials to external fields, with optical conductivity being one of the most important linear response properties. This practice demonstrates how to compute the optical conductivity $\\sigma(\\omega)$ by simulating the current response $J(t)$ to an impulsive electric field and then performing a Fourier transform. By implementing this simulation for a simple model and verifying the result against the fundamental f-sum rule, you will bridge the gap between a time-domain simulation and a frequency-domain observable, an essential task in computational materials science [@problem_id:2919765].", "problem": "You will implement a real-time propagation calculation of the optical conductivity in a one-dimensional periodic system using the time-dependent Kohn–Sham framework of Time-Dependent Density Functional Theory (TDDFT). Consider a homogeneous, noninteracting, spin-compensated electron gas in one dimension at zero temperature, modeled as free Kohn–Sham particles of mass $m$ in atomic units (a.u.), so that $e=1$, $\\hbar=1$, and $m$ is a dimensionless parameter equal to the electron mass when $m=1$. The system has number density $n$ (particles per unit length). At time $t=0$, apply a spatially homogeneous impulsive electric field $E(t)=\\kappa\\,\\delta(t)$ (in a.u.), corresponding to a jump in the vector potential. For $t>0$, the external field is zero. In the velocity gauge, the coupling is via minimal substitution, so the current density response $J(t)$ is well-defined for the noninteracting Kohn–Sham system.\n\nYour program must:\n- Work in atomic units (a.u.) throughout. All reported quantities must be in a.u.\n- Use the linear-response regime by taking a small kick amplitude $\\kappa=10^{-3}$ (a.u.).\n- Compute the macroscopic current density $J(t)$ for $t\\ge 0$ for a free-electron Kohn–Sham system after the impulse. You should use the fact that the Kohn–Sham orbitals are plane waves and propagate under the unperturbed Hamiltonian for $t>0$.\n- Construct the damped Fourier transform of the current\n$$\nJ(\\omega) \\equiv \\int_0^T e^{\\mathrm{i}\\omega t} e^{-\\eta t} J(t)\\,dt,\n$$\nwith user-specified damping rate $\\eta>0$ (a.u.), time window $T$ (a.u.), and uniform time step $\\Delta t$ (a.u.).\n- Define the optical conductivity by\n$$\n\\sigma(\\omega) \\equiv \\frac{J(\\omega)}{\\kappa}.\n$$\n- Compute the numerical integral\n$$\nS \\equiv \\int_0^{\\Omega_{\\max}} \\mathrm{Re}\\,\\sigma(\\omega)\\,d\\omega\n$$\nusing a uniform frequency grid from $0$ to $\\Omega_{\\max}$ (a.u.) and the trapezoidal rule.\n\nDesign choices for numerical parameters:\n- Use $T = 50/\\eta$, $\\Delta t = 0.02/\\eta$, and $\\Omega_{\\max} = 100\\,\\eta$.\n- Use $N_{\\omega}=2000$ uniformly spaced frequency points on $[0,\\Omega_{\\max}]$.\n- Implement all integrals with the trapezoidal rule on uniform grids.\n\nTest suite:\n- Use the following four test cases, each specified by $(n, m, \\eta)$ in atomic units:\n  1. $(0.8,\\,1.0,\\,0.05)$\n  2. $(0.2,\\,1.0,\\,0.02)$\n  3. $(1.5,\\,2.0,\\,0.04)$\n  4. $(0.0,\\,1.0,\\,0.03)$\n- For each test case, compute $S$ as above. Also compute the exact free-electron reference value $S_{\\mathrm{ref}}(n,m)$ associated with the f-sum rule for a homogeneous free-electron system, deduced from first principles. Then compute the relative deviation\n$$\n\\varepsilon \\equiv \n\\begin{cases}\n\\left|S - S_{\\mathrm{ref}}\\right|/S_{\\mathrm{ref}}, & \\text{if } S_{\\mathrm{ref}} \\ne 0,\\\\\n0, & \\text{if } S_{\\mathrm{ref}} = 0.\n\\end{cases}\n$$\n\nFinal output format:\n- Your program should produce a single line of output containing the relative deviations for the four test cases as a comma-separated list enclosed in square brackets, for example, \"[e1,e2,e3,e4]\". Each $e_i$ must be a floating-point number in atomic units (dimensionless relative error), with no additional text.", "solution": "The problem posed is a valid and well-defined exercise in computational quantum mechanics, specifically within the framework of real-time Time-Dependent Density Functional Theory (TDDFT). It is scientifically grounded in the established principles of linear response theory applied to a non-interacting electron gas. All parameters and procedures are specified with sufficient clarity to permit a unique numerical solution. I will therefore proceed with the derivation and algorithm design.\n\nThe system is a one-dimensional, homogeneous, spin-compensated gas of non-interacting electrons of mass $m$ and number density $n$ at zero temperature ($T=0$ K). In the absence of external fields, the Kohn-Sham orbitals are plane waves, $\\psi_k(x) = L^{-1/2} e^{\\mathrm{i}kx}$, with corresponding energies $\\epsilon_k = k^2/(2m)$ in atomic units ($\\hbar=1$). The ground state is formed by filling all single-particle states up to the Fermi wavevector, $k_F$. The relation between density $n$ and $k_F$ for a spin-compensated system is found by integrating over the occupied states in $k$-space:\n$$n = 2 \\int_{-k_F}^{k_F} \\frac{dk}{2\\pi} = \\frac{2k_F}{\\pi}$$\nThus, the Fermi wavevector is $k_F = \\pi n / 2$.\n\nAt time $t=0$, a spatially homogeneous, impulsive electric field $E(t) = \\kappa \\delta(t)$ is applied. In the length gauge, this corresponds to an interaction potential $V(x,t) = -x E(t) = -x \\kappa \\delta(t)$. The effect of this impulse on a wavefunction is given by the time-evolution operator over an infinitesimal interval around $t=0$:\n$$U(0^+, 0^-) = \\mathcal{T} \\exp\\left(-\\mathrm{i} \\int_{-\\epsilon}^{\\epsilon} V(x,t') dt'\\right) = \\exp\\left(-\\mathrm{i} \\int (-x \\kappa \\delta(t')) dt'\\right) = \\exp(\\mathrm{i}\\kappa x)$$\nThis operator acts as a momentum translator. Applying it to a ground-state orbital $\\psi_k(x)$ yields the initial state for the subsequent evolution:\n$$\\psi_k(x, t=0^+) = e^{\\mathrm{i}\\kappa x} \\psi_k(x, t=0^-) = e^{\\mathrm{i}\\kappa x} L^{-1/2} e^{\\mathrm{i}kx} = L^{-1/2} e^{\\mathrm{i}(k+\\kappa)x} \\equiv \\psi_{k+\\kappa}(x)$$\nEach initial plane-wave state with wavevector $k$ is instantaneously shifted to a state with wavevector $k+\\kappa$.\n\nFor $t>0$, the external field is zero, and the system evolves under the field-free Hamiltonian $\\hat{H}_0 = \\hat{p}^2/(2m)$. The time evolution of the state that started as $\\psi_k$ is trivial:\n$$\\psi_k(x,t) = e^{-\\mathrm{i}\\hat{H}_0 t} \\psi_{k+\\kappa}(x) = e^{-\\mathrm{i}\\epsilon_{k+\\kappa}t} \\psi_{k+\\kappa}(x)$$\nwhere $\\epsilon_{k+\\kappa} = (k+\\kappa)^2/(2m)$.\n\nThe macroscopic current density $J(t)$ is the expectation value of the total current operator, which for a non-interacting system in the absence of a vector potential is $\\hat{J} = \\sum_i \\hat{p}_i/m$. The expectation value summing over all initially occupied states ($|k| \\le k_F$) is:\n$$J(t) = 2 \\int_{-k_F}^{k_F} \\frac{dk}{2\\pi} \\langle \\psi_k(t) | \\frac{\\hat{p}}{m} | \\psi_k(t) \\rangle$$\nThe expectation value of momentum in the state $\\psi_k(t)$ is time-independent for $t>0$:\n$$\\langle \\psi_k(t) | \\frac{\\hat{p}}{m} | \\psi_k(t) \\rangle = \\frac{k+\\kappa}{m}$$\nSubstituting this into the integral for the total current density gives:\n$$J(t) = 2 \\int_{-k_F}^{k_F} \\frac{dk}{2\\pi} \\left(\\frac{k+\\kappa}{m}\\right) = \\frac{1}{\\pi m} \\left( \\int_{-k_F}^{k_F} k\\,dk + \\kappa \\int_{-k_F}^{k_F} dk \\right)$$\nThe first integral vanishes due to the symmetric integration interval. The second integral yields $2k_F$.\n$$J(t) = \\frac{1}{\\pi m} (\\kappa \\cdot 2k_F) = \\frac{2 k_F \\kappa}{\\pi m}$$\nUsing the relation $n=2k_F/\\pi$, we obtain the simple result that the current density is constant for $t>0$:\n$$J(t) = \\frac{n \\kappa}{m}$$\nThis physically represents the fact that in a homogeneous free-electron gas, there are no scattering mechanisms (like impurities, phonons, or electron-electron interactions in this model) to cause the current to decay.\n\nThe problem requires a fully numerical evaluation. The procedure is as follows:\n1. The analytical expression for the current, $J(t) = n\\kappa/m$, is evaluated on a uniform time grid from $t=0$ to $t=T=50/\\eta$ with step $\\Delta t = 0.02/\\eta$.\n2. For each frequency $\\omega_j$ on a uniform grid from $0$ to $\\Omega_{\\max}=100\\eta$, the damped Fourier transform $J(\\omega_j) = \\int_0^T e^{\\mathrm{i}\\omega_j t} e^{-\\eta t} J(t)\\,dt$ is computed using the trapezoidal rule.\n3. The optical conductivity is found as $\\sigma(\\omega_j) = J(\\omega_j)/\\kappa$.\n4. The integrated real part of the conductivity, $S = \\int_0^{\\Omega_{\\max}} \\mathrm{Re}\\,\\sigma(\\omega)\\,d\\omega$, is computed, again using the trapezoidal rule.\n5. This numerical result $S$ is compared against the theoretical reference value $S_{\\mathrm{ref}}$ given by the conductivity f-sum rule (Thomas-Reiche-Kuhn sum rule) for a 1D system in atomic units ($e=1$):\n$$S_{\\mathrm{ref}} = \\int_0^\\infty \\mathrm{Re}\\,\\sigma(\\omega)\\,d\\omega = \\frac{\\pi n}{2m}$$\nThe relative deviation $\\varepsilon = |S - S_{\\mathrm{ref}}|/S_{\\mathrm{ref}}$ then measures the combined numerical errors from the two trapezoidal integrations and the truncation errors from using a finite time window $T$ and a finite frequency cutoff $\\Omega_{\\max}$. For the special case $n=0$, we have $J(t)=0$, $S=0$, and $S_{\\mathrm{ref}}=0$, for which the deviation is defined as $\\varepsilon=0$.", "answer": "```python\nimport numpy as np\n\ndef calculate_deviation(n: float, m: float, eta: float) -> float:\n    \"\"\"\n    Calculates the relative deviation of the numerically integrated optical\n    conductivity against the f-sum rule reference value.\n\n    Args:\n        n: Electron number density in a.u.\n        m: Electron mass in a.u.\n        eta: Damping rate in a.u.\n\n    Returns:\n        The relative deviation epsilon.\n    \"\"\"\n    KAPPA = 1e-3\n    N_OMEGA = 2000\n\n    # Handle the trivial case of zero density as per the problem statement.\n    if n == 0.0:\n        return 0.0\n\n    # Define numerical parameters based on the given damping rate eta.\n    T = 50.0 / eta\n    dt = 0.02 / eta\n    # The number of time intervals is Nt. The number of points is Nt + 1.\n    # Use round() to prevent floating point inaccuracies from creating an off-by-one error.\n    Nt = int(round(T / dt))  # This should be exactly 2500.\n\n    Omega_max = 100.0 * eta\n\n    # 1. Set up the time grid and the constant current density J(t).\n    t_grid = np.linspace(0.0, T, Nt + 1, dtype=np.float64)\n    # For t > 0, J(t) is constant. We assume J(0) has this value as well for the integral.\n    J_const = n * KAPPA / m\n\n    # 2. Set up the frequency grid and prepare an array for sigma(omega).\n    omega_grid = np.linspace(0.0, Omega_max, N_OMEGA, dtype=np.float64)\n    re_sigma_w = np.zeros(N_OMEGA, dtype=np.float64)\n\n    # 3. Compute the Fourier transform for each frequency to find sigma(omega).\n    for j, omega_j in enumerate(omega_grid):\n        # The integrand for the Fourier transform integral.\n        integrand_ft = J_const * np.exp(1j * omega_j * t_grid - eta * t_grid)\n\n        # Compute J(omega) using the trapezoidal rule.\n        J_w = np.trapz(integrand_ft, t_grid)\n\n        # Calculate conductivity sigma(omega) = J(omega) / kappa.\n        sigma_w = J_w / KAPPA\n\n        # Store the real part.\n        re_sigma_w[j] = np.real(sigma_w)\n\n    # 4. Compute the integrated real part of the conductivity, S.\n    # The integral is performed over the frequency grid using the trapezoidal rule.\n    S = np.trapz(re_sigma_w, omega_grid)\n\n    # 5. Compute the exact reference value from the f-sum rule.\n    S_ref = (np.pi * n) / (2.0 * m)\n    \n    # 6. Compute the relative deviation.\n    if S_ref == 0:\n        # This branch is guarded by the initial n=0 check, but is included for robustness.\n        return 0.0\n    else:\n        epsilon = np.abs(S - S_ref) / S_ref\n        return epsilon\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print the results.\n    \"\"\"\n    # Test cases are given as tuples of (n, m, eta) in atomic units.\n    test_cases = [\n        (0.8, 1.0, 0.05),\n        (0.2, 1.0, 0.02),\n        (1.5, 2.0, 0.04),\n        (0.0, 1.0, 0.03)\n    ]\n\n    results = []\n    for case in test_cases:\n        n_val, m_val, eta_val = case\n        deviation = calculate_deviation(n_val, m_val, eta_val)\n        results.append(deviation)\n\n    # Print the final output in the specified format.\n    print(f\"[{','.join(f'{r:.10f}' for r in results)}]\")\n\n# Execute the solver.\nif __name__ == \"__main__\":\n    solve()\n```", "id": "2919765"}, {"introduction": "The laws of electromagnetism are independent of the choice of gauge, and our numerical simulations of quantum systems interacting with fields must respect this fundamental principle. This exercise challenges you to implement a propagation in two different but physically equivalent pictures: the length gauge, using the electric field $E(t)$, and the velocity gauge, using the vector potential $A(t)$. By confirming that physical observables like the time-dependent dipole moment and the total absorbed energy are identical to within numerical precision in both gauges, you will gain deep insight into the theoretical structure of light-matter interaction and develop robust coding practices for advanced simulations [@problem_id:2919764].", "problem": "In this task you will implement a one-dimensional real-time propagation of a single Kohn–Sham orbital in Time-Dependent Density Functional Theory (TDDFT) under the dipole approximation, in both the length gauge and the velocity gauge, and use it to quantitatively demonstrate gauge consistency for observables. You must start from the Time-Dependent Schrödinger Equation (TDSE) for the single-electron Kohn–Sham orbital in atomic units. The system is a bound electron in a one-dimensional harmonic well. You must implement a numerically unitary propagation scheme in both gauges, compute observables, and compare the results to numerical precision.\n\nUse the following physical and mathematical base:\n- Atomic units: set $\\hbar = 1$, $m_e = 1$, and the electron charge $q = -1$.\n- Field-free Hamiltonian: $H_0 = \\frac{\\hat{p}^2}{2} + \\frac{1}{2}\\,\\omega_0^2\\,x^2$.\n- Length gauge Hamiltonian: $H_L(t) = \\frac{\\hat{p}^2}{2} + \\frac{1}{2}\\,\\omega_0^2\\,x^2 + x\\,E(t)$.\n- Velocity gauge Hamiltonian: $H_V(t) = \\frac{(\\hat{p} + A(t))^2}{2} + \\frac{1}{2}\\,\\omega_0^2\\,x^2$.\n- The electric field and vector potential are related by $E(t) = -\\frac{dA(t)}{dt}$.\n- The initial state is the harmonic oscillator ground state (normalized on the grid you choose): $\\psi(x,0) \\propto \\exp\\!\\left(-\\frac{\\omega_0 x^2}{2}\\right)$.\n\nImplement a split-operator propagation that ensures second-order accuracy in time and numerical unitarity, using a Fourier spectral representation for kinetic energy. You must use a midpoint evaluation in time for the explicitly time-dependent part of the Hamiltonian to ensure second-order accuracy for time-dependent fields. The spatial grid should be uniform, and Fast Fourier Transforms should be used to move between position and momentum representations.\n\nDefine the vector potential pulse on the finite time interval $t \\in [0, T]$ as\n$$\nA(t) = A_0 \\,\\sin^2\\!\\left(\\frac{\\pi t}{T}\\right)\\,\\sin(\\omega\\, t + \\phi),\n$$\nand set $E(t) = -\\frac{dA(t)}{dt}$ exactly by analytic differentiation. Outside the interval $[0,T]$ the field is zero. You must compute the following observables during propagation:\n- The time-dependent dipole $d(t) = \\langle x \\rangle_t$.\n- The field-free energy $E_0(t) = \\langle \\psi(t) | H_0 | \\psi(t) \\rangle$.\n- The absorbed energy with respect to the field-free Hamiltonian, $\\Delta E = E_0(T) - E_0(0)$.\n\nNumerically demonstrate gauge consistency by performing two propagations for each case: one with $H_L(t)$ using $E(t)$ and one with $H_V(t)$ using $A(t)$, starting from the same initial state. For each case, compute:\n- The maximum absolute deviation between the two dipole traces, $\\max_t |d_L(t) - d_V(t)|$.\n- The absolute difference in absorbed energy, $|\\Delta E_L - \\Delta E_V|$.\n\nAll quantities are in atomic units. No angles in degrees appear in the required output; if you internally use angles, take them in radians. Your program must implement the following test suite and produce a single-line output that aggregates all results. For each test case, you must use the indicated parameters and compute the two floats described above. The time step should be used as specified, but you must ensure that the total duration $T$ is a multiple of the time step by adjusting the effective step size to $T/N_t$ where $N_t$ is the nearest integer number of steps.\n\nSpatial discretization and common parameters for all cases:\n- Number of grid points $N_x = 1024$.\n- Box length $L = 40.0$ (so grid spacing is $dx = L/N_x$).\n- Harmonic frequency $\\omega_0 = 0.5$.\n\nFor each case, define $T = N_{\\text{cycles}} \\times \\frac{2\\pi}{\\omega}$ and propagate from $t = 0$ to $t = T$ with the given nominal time step $dt$ (adjusted as noted above).\n\nTest suite:\n- Case $1$ (happy path):\n  - Carrier frequency $\\omega = 0.7$.\n  - Number of cycles $N_{\\text{cycles}} = 6$.\n  - Vector potential amplitude $A_0 = 0.07142857142857142$.\n  - Carrier–envelope phase $\\phi = 0.0$.\n  - Nominal time step $dt = 0.02$.\n- Case $2$ (zero field edge case):\n  - Carrier frequency $\\omega = 0.7$.\n  - Number of cycles $N_{\\text{cycles}} = 6$.\n  - Vector potential amplitude $A_0 = 0.0$.\n  - Carrier–envelope phase $\\phi = 0.0$.\n  - Nominal time step $dt = 0.02$.\n- Case $3$ (stronger field and different phase):\n  - Carrier frequency $\\omega = 0.5$.\n  - Number of cycles $N_{\\text{cycles}} = 6$.\n  - Vector potential amplitude $A_0 = 0.3$.\n  - Carrier–envelope phase $\\phi = 1.0471975511965976$.\n  - Nominal time step $dt = 0.01$.\n\nRequired final output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. The list must contain, in order, for Case $1$ the maximum dipole deviation and the absorbed-energy difference, followed by the same two quantities for Case $2$, and then for Case $3$. For example, the output must look like\n\"[r1,r2,r3,r4,r5,r6]\"\nwith each $r_j$ a float. No other output is permitted.\n\nAll numerical values must be computed in atomic units, and the returned floats should be the raw numerical values (not rounded to a fixed number of decimals).", "solution": "The user has provided a problem that is scientifically grounded, well-posed, and complete. All necessary physical constants, mathematical equations, parameters, and numerical procedures are specified without ambiguity or contradiction. The problem requests the implementation of a standard numerical method (the Fourier split-operator method) to solve the time-dependent Schrödinger equation (TDSE) for a single particle in a harmonic potential under the influence of an external laser pulse. This is a canonical problem in the field of computational quantum dynamics.\n\nThe core of the problem lies in demonstrating the principle of gauge invariance for physical observables. Two separate simulations are required: one in the length gauge and one in the velocity gauge. The Hamiltonians provided for these two gauges, $H_L(t)$ and $H_V(t)$, are the standard, correct forms in atomic units. The relationship between the electric field $E(t)$ and the vector potential $A(t)$, $E(t) = -dA(t)/dt$, is fundamental. The problem also correctly specifies that a gauge transformation connects the wavefunctions in the two gauges, $\\psi_L(x,t) = \\exp(-ixA(t))\\psi_V(x,t)$, given that the charge $q=-1$.\n\nPhysical observables are only meaningful if they are gauge-invariant. The dipole moment, $d(t) = \\langle \\psi(t) | \\hat{x} | \\psi(t) \\rangle$, is an expectation value of a position-dependent operator, which is gauge-invariant. The absorbed energy, $\\Delta E = E_0(T) - E_0(0)$, is also gauge-invariant provided the vector potential $A(t)$ vanishes at the start ($t=0$) and end ($t=T$) of the pulse, which is true for the given pulse shape $A(t) = A_0 \\sin^2(\\pi t/T) \\sin(\\omega t + \\phi)$. Since $A(0)=A(T)=0$, the gauge transformation factor is unity at these times, meaning $\\psi_L(0) = \\psi_V(0)$ and $\\psi_L(T) = \\psi_V(T)$. Consequently, the expectation value of the field-free Hamiltonian $H_0$, which defines $E_0(t)$, must be the same in both gauges at $t=0$ and $t=T$. Therefore, $\\Delta E_L$ and $\\Delta E_V$ must be identical in an exact calculation.\n\nThe problem is to numerically verify these theoretical equivalences. Any computed difference will be a measure of the numerical error introduced by the time-stepping algorithm and spatial discretization. The specified split-operator method is an appropriate choice as it is unitary and second-order accurate in the time step $dt$.\n\nThe solution involves the following steps:\n1.  **Discretization**: A uniform spatial grid for the position coordinate $x$ and a corresponding momentum grid $k$ are established. The momentum grid is determined via the Fast Fourier Transform (FFT) relations.\n2.  **Initial State**: The initial wavefunction $\\psi(x,t=0)$ is the normalized ground state of the one-dimensional quantum harmonic oscillator.\n3.  **Hamiltonian Operators**: The kinetic energy operator $\\hat{T} = \\hat{p}^2/2$ is represented as a diagonal operator $k^2/2$ in momentum space. The potential energy operators are diagonal in position space.\n4.  **Time Propagation**: A symmetric second-order split-operator (Strang splitting) scheme is implemented. The scheme for a Hamiltonian $H = \\hat{T} + \\hat{V}(t)$ is:\n    $$\n    \\psi(t+dt) \\approx e^{-i \\hat{V}(t+dt/2) dt/2} \\, e^{-i \\hat{T} dt} \\, e^{-i \\hat{V}(t+dt/2) dt/2} \\psi(t)\n    $$\n    The operators $e^{-i\\hat{V}dt/2}$ are applied in position space, and $e^{-i\\hat{T}dt}$ is applied in momentum space, with FFTs used to switch between representations. The time-dependent potential is evaluated at the midpoint of the time interval, $t+dt/2$, to maintain second-order accuracy.\n    *   **Length Gauge**: The potential operator is $V_L(x,t) = \\frac{1}{2}\\omega_0^2 x^2 + x E(t)$.\n    *   **Velocity Gauge**: The splitting is between the position-dependent potential $V_0(x) = \\frac{1}{2}\\omega_0^2 x^2$ and the time-dependent kinetic operator $T_V(k,t) = \\frac{(k+A(t))^2}{2}$. The propagator is:\n        $$\n        \\psi(t+dt) \\approx e^{-i \\hat{V}_0 dt/2} \\, e^{-i \\hat{T}_V(t+dt/2) dt} \\, e^{-i \\hat{V}_0 dt/2} \\psi(t)\n        $$\n5.  **Observables**: At each time step, the dipole moment $d(t) = \\int \\psi^*(x,t) x \\psi(x,t) dx$ and the field-free energy $E_0(t) = \\langle \\psi(t) | H_0 | \\psi(t) \\rangle$ are computed. The kinetic energy term in $E_0(t)$ is calculated in momentum space using Parseval's theorem.\n6.  **Comparison**: After completing the propagations from $t=0$ to $t=T$ for both gauges, the maximum absolute deviation between the dipole moment traces, $\\max_t |d_L(t) - d_V(t)|$, and the absolute difference in the total absorbed energy, $|\\Delta E_L - \\Delta E_V|$, are calculated for each test case.\n\nThe implementation will proceed by defining a function that takes the parameters for one test case, performs both gauge propagations, and returns the two required metrics. This function will be called for each of the three specified test cases to generate the final output.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n\n    def run_simulation(case_params):\n        \"\"\"\n        Performs the TDDFT propagation in both length and velocity gauges for a single test case.\n        \"\"\"\n        # Unpack parameters\n        omega, N_cycles, A0, phi, dt_nominal = case_params\n        \n        # Fixed physical and grid parameters\n        Nx = 1024\n        L = 40.0\n        omega0 = 0.5\n\n        # 1. Setup Grid and Time\n        dx = L / Nx\n        x = np.linspace(-L/2, L/2, Nx, endpoint=False)\n        k = 2 * np.pi * np.fft.fftfreq(Nx, d=dx)\n        \n        if omega == 0.0:\n            T = 0.0\n        else:\n            T = N_cycles * 2 * np.pi / omega\n        \n        if T == 0.0 or dt_nominal == 0.0:\n            Nt = 0\n            dt = 0.0\n        else:\n            Nt = int(round(T / dt_nominal))\n            if Nt == 0 and T > 0: Nt = 1\n            dt = T / Nt\n        \n        time_points = np.linspace(0, T, Nt + 1)\n        \n        # 2. Define External Fields\n        def A_field(t):\n            if 0 < t < T:\n                return A0 * (np.sin(np.pi * t / T)**2) * np.sin(omega * t + phi)\n            return 0.0\n\n        def E_field(t):\n            if 0 < t < T:\n                s_pi_t_T = np.sin(np.pi * t / T)\n                s_om_t_p = np.sin(omega * t + phi)\n                c_om_t_p = np.cos(omega * t + phi)\n                s_2pi_t_T = np.sin(2 * np.pi * t / T)\n                \n                term1 = (np.pi / T) * s_2pi_t_T * s_om_t_p\n                term2 = omega * (s_pi_t_T**2) * c_om_t_p\n                return -A0 * (term1 + term2)\n            return 0.0\n            \n        # 3. Initial State\n        psi0 = (omega0 / np.pi)**0.25 * np.exp(-0.5 * omega0 * x**2)\n        psi0 /= np.sqrt(np.sum(np.abs(psi0)**2) * dx)\n        psi0 = psi0.astype(np.complex128)\n        \n        # 4. Operators and Helper Functions\n        V0_op = 0.5 * omega0**2 * x**2\n        T_op_k_space = 0.5 * k**2\n        \n        def calculate_E0(psi):\n            psi_k = np.fft.fft(psi)\n            kin_energy = (dx**2 / L) * np.sum(T_op_k_space * np.abs(psi_k)**2)\n            pot_energy = np.sum(V0_op * np.abs(psi)**2) * dx\n            return np.real(kin_energy + pot_energy)\n\n        if Nt == 0:\n            return 0.0, 0.0\n\n        # ==========================\n        # LENGTH GAUGE PROPAGATION\n        # ==========================\n        psi_L = np.copy(psi0)\n        dipole_L = np.zeros(Nt + 1)\n        energy_L = np.zeros(Nt + 1)\n        \n        dipole_L[0] = np.sum(x * np.abs(psi_L)**2) * dx\n        energy_L[0] = calculate_E0(psi_L)\n\n        exp_T_prop = np.exp(-1j * T_op_k_space * dt)\n\n        for i in range(Nt):\n            t_mid = time_points[i] + dt / 2.0\n            \n            E_mid = E_field(t_mid)\n            V_L_mid = V0_op + x * E_mid\n            exp_V_prop_half = np.exp(-1j * V_L_mid * dt / 2.0)\n            \n            psi_L *= exp_V_prop_half\n            psi_L = np.fft.ifft(np.fft.fft(psi_L) * exp_T_prop)\n            psi_L *= exp_V_prop_half\n            \n            dipole_L[i+1] = np.sum(x * np.abs(psi_L)**2) * dx\n            energy_L[i+1] = calculate_E0(psi_L)\n\n        # ==========================\n        # VELOCITY GAUGE PROPAGATION\n        # ==========================\n        psi_V = np.copy(psi0)\n        dipole_V = np.zeros(Nt + 1)\n        energy_V = np.zeros(Nt + 1)\n\n        dipole_V[0] = np.sum(x * np.abs(psi_V)**2) * dx\n        energy_V[0] = calculate_E0(psi_V)\n        \n        exp_V0_prop_half = np.exp(-1j * V0_op * dt / 2.0)\n\n        for i in range(Nt):\n            t_mid = time_points[i] + dt / 2.0\n            \n            A_mid = A_field(t_mid)\n            T_V_op = 0.5 * (k + A_mid)**2\n            exp_T_V_prop = np.exp(-1j * T_V_op * dt)\n\n            psi_V *= exp_V0_prop_half\n            psi_V = np.fft.ifft(np.fft.fft(psi_V) * exp_T_V_prop)\n            psi_V *= exp_V0_prop_half\n            \n            dipole_V[i+1] = np.sum(x * np.abs(psi_V)**2) * dx\n            energy_V[i+1] = calculate_E0(psi_V)\n        \n        # 5. Final Metrics Calculation\n        delta_E_L = energy_L[-1] - energy_L[0]\n        delta_E_V = energy_V[-1] - energy_V[0]\n        \n        max_dipole_deviation = np.max(np.abs(dipole_L - dipole_V))\n        abs_energy_difference = np.abs(delta_E_L - delta_E_V)\n        \n        return max_dipole_deviation, abs_energy_difference\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (happy path)\n        (0.7, 6, 0.07142857142857142, 0.0, 0.02),\n        # Case 2 (zero field edge case)\n        (0.7, 6, 0.0, 0.0, 0.02),\n        # Case 3 (stronger field and different phase)\n        (0.5, 6, 0.3, 1.0471975511965976, 0.01),\n    ]\n\n    results = []\n    for case in test_cases:\n        res1, res2 = run_simulation(case)\n        results.append(res1)\n        results.append(res2)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "2919764"}]}