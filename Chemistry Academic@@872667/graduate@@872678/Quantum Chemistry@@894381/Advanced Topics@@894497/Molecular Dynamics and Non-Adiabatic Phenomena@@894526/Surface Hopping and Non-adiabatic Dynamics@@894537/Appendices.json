{"hands_on_practices": [{"introduction": "The central question in any surface hopping simulation is when a trajectory should switch from one potential energy surface to another. This exercise [@problem_id:2928383] delves into the heart of the Fewest Switches Surface Hopping (FSSH) algorithm by deriving and applying the formula for the hopping probability. By working through this problem, you will see how the quantum evolution of electronic state amplitudes, governed by the time-dependent Schrödinger equation, is translated into a stochastic criterion for a classical trajectory to 'hop'.", "problem": "Consider a two-state non-adiabatic dynamics problem treated within the Fewest Switches Surface Hopping (FSSH) framework. Let the electronic wavefunction be expanded in the adiabatic basis as $\\Psi(\\mathbf{r},\\mathbf{R},t)=\\sum_{k} c_k(t)\\,\\phi_k(\\mathbf{r};\\mathbf{R}(t))$, where the nuclear trajectory $\\mathbf{R}(t)$ evolves classically. The time-dependent Schrödinger equation in the adiabatic representation implies a coupling between amplitudes $\\{c_k(t)\\}$ through the nuclear velocity $\\mathbf{v}(t)=\\dot{\\mathbf{R}}(t)$ and the non-adiabatic derivative couplings $d_{ij}(\\mathbf{R})=\\langle \\phi_i(\\mathbf{R})|\\nabla_{\\mathbf{R}}\\phi_j(\\mathbf{R})\\rangle$. Assume orthonormal adiabatic states that are sufficiently smooth in $\\mathbf{R}$ so that the derivative couplings are well-defined.\n\nStarting from these fundamentals and the requirement that the ensemble-averaged population transfer between adiabatic states induced by hops matches, to leading order in the time step $\\Delta t$, the population flow dictated by the time-dependent Schrödinger equation, derive the leading-order expression for the probability of a hop from state $i$ to state $j$ over a single time step $\\Delta t$ in terms of $c_i$, $c_j$, $\\mathbf{v}$, and $d_{ij}$.\n\nThen, evaluate this hop probability for the following data at a given instant:\n- $c_i = 0.8\\,\\exp(i\\theta_i)$ and $c_j = 0.6\\,\\exp(i\\theta_j)$ with $\\theta_j-\\theta_i=\\pi/3$ (radians),\n- $\\Delta t = 5.0\\times 10^{-16}\\ \\mathrm{s}$,\n- $\\mathbf{v}=(1500\\ \\mathrm{m\\,s^{-1}})\\,\\hat{\\mathbf{x}}+(1000\\ \\mathrm{m\\,s^{-1}})\\,\\hat{\\mathbf{y}}+0\\,\\hat{\\mathbf{z}}$,\n- $d_{ij}=(1.0\\times 10^{10}\\ \\mathrm{m^{-1}})\\,\\hat{\\mathbf{x}}+(1.0\\times 10^{10}\\ \\mathrm{m^{-1}})\\,\\hat{\\mathbf{y}}+0\\,\\hat{\\mathbf{z}}$.\n\nAssume the adiabatic electronic states are chosen real at this geometry so that $d_{ij}$ is real. Discuss qualitatively how the hop probability depends on the relative phase between $c_i$ and $c_j$, and the role of the phase choice (gauge) for the adiabatic states.\n\nExpress the final hop probability as a pure number (dimensionless) and round your answer to four significant figures.", "solution": "The problem statement has been evaluated and is deemed valid. It is scientifically grounded in the principles of non-adiabatic quantum dynamics, specifically the Fewest Switches Surface Hopping (FSSH) method. The problem is well-posed, objective, self-contained, and all provided data are physically and dimensionally consistent. The populations of the two states sum to unity, $|c_i|^2+|c_j|^2 = (0.8)^2+(0.6)^2 = 0.64+0.36 = 1.0$, as required. We may therefore proceed with the solution.\n\nThe solution is structured in three parts: first, the derivation of the hopping probability formula from fundamental principles; second, the numerical evaluation for the given data; and third, a discussion of the roles of phase and gauge.\n\n**1. Derivation of the Hopping Probability**\n\nThe evolution of the electronic wavefunction $\\Psi(\\mathbf{r},\\mathbf{R},t)=\\sum_{k} c_k(t)\\,\\phi_k(\\mathbf{r};\\mathbf{R}(t))$ is governed by the time-dependent Schrödinger equation (TDSE). In the adiabatic representation, the equation of motion for the complex amplitudes $c_k(t)$ is given by:\n$$ i\\hbar\\frac{d c_k(t)}{dt} = E_k(\\mathbf{R}) c_k(t) - i\\hbar \\sum_j \\mathbf{v}(t) \\cdot d_{kj}(\\mathbf{R}) c_j(t) $$\nwhere $E_k$ are the adiabatic potential energy surfaces, $\\mathbf{v}(t) = \\dot{\\mathbf{R}}(t)$ is the classical nuclear velocity, and $d_{kj} = \\langle \\phi_k | \\nabla_{\\mathbf{R}} \\phi_j \\rangle$ are the non-adiabatic derivative couplings. For simplicity, we shall work in atomic units where $\\hbar=1$.\n$$ \\frac{d c_k}{dt} = -i E_k c_k - \\sum_j (\\mathbf{v} \\cdot d_{kj}) c_j $$\nWe are interested in the rate of change of the population of a given state $j$, which is $\\rho_j(t) = |c_j(t)|^2 = c_j^*(t)c_j(t)$. Using the product rule, the time derivative is:\n$$ \\frac{d\\rho_j}{dt} = \\frac{dc_j^*}{dt}c_j + c_j^*\\frac{dc_j}{dt} $$\nThe complex conjugate of the equation for $c_j$ is:\n$$ \\frac{dc_j^*}{dt} = i E_j c_j^* - \\sum_k (\\mathbf{v} \\cdot d_{jk})^* c_k^* $$\nFrom the definition of the derivative coupling, it can be shown that $d_{jk}^* = -d_{kj}$. For the specific case of real adiabatic wavefunctions, as assumed in the problem, this simplifies to $d_{jk}$ being real and antisymmetric, $d_{jk}=-d_{kj}$. We use the more general relation $d_{jk}^* = -d_{kj}$.\n$$ \\frac{dc_j^*}{dt} = i E_j c_j^* + \\sum_k (\\mathbf{v} \\cdot d_{kj}) c_k^* $$\nSubstituting the expressions for $\\dot{c}_j$ and $\\dot{c}_j^*$ into the derivative of $\\rho_j$:\n$$ \\frac{d\\rho_j}{dt} = \\left( i E_j c_j^* + \\sum_k (\\mathbf{v} \\cdot d_{kj}) c_k^* \\right) c_j + c_j^* \\left( -i E_j c_j - \\sum_k (\\mathbf{v} \\cdot d_{jk}) c_k \\right) $$\nThe terms involving the energy $E_j$ cancel:\n$$ \\frac{d\\rho_j}{dt} = \\sum_k \\left[ (\\mathbf{v} \\cdot d_{kj}) c_k^* c_j - (\\mathbf{v} \\cdot d_{jk}) c_j^* c_k \\right] $$\nRearranging the sums and using the identity $Z - Z^* = 2i\\mathrm{Im}(Z)$:\n$$ \\frac{d\\rho_j}{dt} = \\sum_{k \\neq j} \\left( (\\mathbf{v} \\cdot d_{kj}) c_k^* c_j - (\\mathbf{v} \\cdot d_{jk}) c_j^* c_k \\right) $$\nUsing $d_{kj} = -d_{jk}^*$, the expression becomes:\n$$ \\frac{d\\rho_j}{dt} = \\sum_{k \\neq j} \\left( -(\\mathbf{v} \\cdot d_{jk}^*) c_k^* c_j - (\\mathbf{v} \\cdot d_{jk}) c_j^* c_k \\right) = -2 \\sum_{k \\neq j} \\mathrm{Re}[(\\mathbf{v} \\cdot d_{jk}) c_j^* c_k] $$\nThis equation describes the total rate of population change in state $j$ due to couplings with all other states $k$. The term for a specific state $i$ in the summation, $-2 \\mathrm{Re}[(\\mathbf{v} \\cdot d_{ji}) c_j^* c_i]$, represents the rate of population flow between states $i$ and $j$. The population that flows from state $i$ to state $j$ in a small time step $\\Delta t$ is:\n$$ \\Delta \\rho_{i \\to j} = 2 \\Delta t \\mathrm{Re}[(\\mathbf{v} \\cdot d_{ij}) c_j c_i^*] $$\nHere we have used $d_{ji} = -d_{ij}^*$ and the property $\\mathrm{Re}(-Z^*) = -\\mathrm{Re}(Z)$.\n\nThe central axiom of the FSSH algorithm is that the probability of a stochastic hop, $P_{i \\to j}$, for a trajectory currently on state $i$, must be defined such that the ensemble-averaged population transfer matches the quantum mechanical population flow predicted by the TDSE. The population transfer induced by hops from state $i$ to $j$ in an ensemble is the fraction of trajectories on state $i$, $|c_i|^2$, multiplied by the hop probability, $P_{i \\to j}$. Equating this to the quantum flow:\n$$ |c_i|^2 P_{i \\to j} = \\Delta \\rho_{i \\to j} = 2 \\Delta t \\mathrm{Re}[(\\mathbf{v} \\cdot d_{ij}) c_j c_i^*] $$\nSolving for $P_{i \\to j}$ yields the leading-order expression for the hopping probability:\n$$ P_{i \\to j} = \\frac{2 \\Delta t \\mathrm{Re}[(\\mathbf{v} \\cdot d_{ij}) c_j c_i^*]}{|c_i|^2} $$\nSince probability cannot be negative, a negative value of the right-hand side implies population flow from $j$ to $i$, so the probability of hopping from $i$ to $j$ is zero. The operational formula is $P_{i \\to j} = \\max\\left(0, \\frac{2 \\Delta t \\mathrm{Re}[(\\mathbf{v} \\cdot d_{ij}) c_j c_i^*]}{|c_i|^2}\\right)$.\n\n**2. Discussion of Phase and Gauge**\n\nThe hopping probability depends on the term $\\mathrm{Re}[(\\mathbf{v} \\cdot d_{ij}) c_j c_i^*]$. Let $c_k = |c_k|\\exp(i\\theta_k)$. Let us assume the gauge where $d_{ij}$ is real.\n$$ P_{i \\to j} \\propto (\\mathbf{v} \\cdot d_{ij}) \\mathrm{Re}[c_j c_i^*] = (\\mathbf{v} \\cdot d_{ij}) \\mathrm{Re}[|c_j|\\exp(i\\theta_j) |c_i|\\exp(-i\\theta_i)] $$\n$$ P_{i \\to j} \\propto (\\mathbf{v} \\cdot d_{ij}) |c_i| |c_j| \\cos(\\theta_j - \\theta_i) $$\nThe probability is directly proportional to the cosine of the relative phase between the complex coefficients. Constructive interference ($\\cos(\\Delta\\theta) > 0$) enhances the hopping probability, while destructive interference ($\\cos(\\Delta\\theta)  0$) suppresses it, corresponding to a reversal in the direction of population flow.\n\nThe choice of phase for the adiabatic wavefunctions, $\\phi'_k = \\exp(i\\gamma_k(\\mathbf{R})) \\phi_k$, is a gauge freedom. This transformation induces changes in both the coefficients, $c'_k = c_k \\exp(-i\\gamma_k)$, and the off-diagonal derivative couplings, $d'_{ij} = d_{ij} \\exp(i(\\gamma_j-\\gamma_i))$. A physical observable like the hop probability must be gauge-invariant. We check the invariance of the key term:\n$$ (\\mathbf{v} \\cdot d'_{ij}) c'_j (c'_i)^* = (\\mathbf{v} \\cdot (d_{ij} e^{i(\\gamma_j-\\gamma_i)})) (c_j e^{-i\\gamma_j}) (c_i e^{-i\\gamma_i})^* $$\n$$ = (\\mathbf{v} \\cdot d_{ij}) e^{i(\\gamma_j-\\gamma_i)} c_j e^{-i\\gamma_j} c_i^* e^{i\\gamma_i} = (\\mathbf{v} \\cdot d_{ij}) c_j c_i^* e^{i(\\gamma_j-\\gamma_i-\\gamma_j+\\gamma_i)} = (\\mathbf{v} \\cdot d_{ij}) c_j c_i^* $$\nThe term is indeed invariant under a gauge transformation. The problem's assumption that the states are real (a specific gauge choice where $d_{ij}$ is real) is a convenience, not a physical necessity.\n\n**3. Numerical Evaluation**\n\nWe now calculate the hopping probability $P_{i \\to j}$ using the provided data.\nThe required quantities are:\ni. The denominator $|c_i|^2$:\n$$ |c_i|^2 = |0.8 \\exp(i\\theta_i)|^2 = (0.8)^2 = 0.64 $$\nii. The dot product $\\mathbf{v} \\cdot d_{ij}$:\n$$ \\mathbf{v} = (1500\\,\\hat{\\mathbf{x}} + 1000\\,\\hat{\\mathbf{y}}) \\ \\mathrm{m\\,s^{-1}} $$\n$$ d_{ij} = (1.0 \\times 10^{10}\\,\\hat{\\mathbf{x}} + 1.0 \\times 10^{10}\\,\\hat{\\mathbf{y}}) \\ \\mathrm{m^{-1}} $$\n$$ \\mathbf{v} \\cdot d_{ij} = (1500)(1.0 \\times 10^{10}) + (1000)(1.0 \\times 10^{10}) $$\n$$ \\mathbf{v} \\cdot d_{ij} = 1.5 \\times 10^{13} + 1.0 \\times 10^{13} = 2.5 \\times 10^{13} \\ \\mathrm{s^{-1}} $$\niii. The real part term $\\mathrm{Re}[(\\mathbf{v} \\cdot d_{ij}) c_j c_i^*]$. As $d_{ij}$ is real, this is $(\\mathbf{v} \\cdot d_{ij}) \\mathrm{Re}[c_j c_i^*]$.\n$$ c_j c_i^* = (0.6 \\exp(i\\theta_j)) (0.8 \\exp(-i\\theta_i)) = 0.48 \\exp(i(\\theta_j - \\theta_i)) $$\nGiven $\\theta_j - \\theta_i = \\pi/3$,\n$$ c_j c_i^* = 0.48 \\exp(i\\pi/3) = 0.48 \\left(\\cos(\\frac{\\pi}{3}) + i\\sin(\\frac{\\pi}{3})\\right) $$\n$$ \\mathrm{Re}[c_j c_i^*] = 0.48 \\cos(\\frac{\\pi}{3}) = 0.48 \\times \\frac{1}{2} = 0.24 $$\nThe term is positive, so the hop $i \\to j$ is allowed.\n\nSubstituting these values into the derived formula with $\\Delta t = 5.0 \\times 10^{-16} \\ \\mathrm{s}$:\n$$ P_{i \\to j} = \\frac{2 \\Delta t (\\mathbf{v} \\cdot d_{ij}) \\mathrm{Re}[c_j c_i^*]}{|c_i|^2} $$\n$$ P_{i \\to j} = \\frac{2 \\times (5.0 \\times 10^{-16} \\ \\mathrm{s}) \\times (2.5 \\times 10^{13} \\ \\mathrm{s^{-1}}) \\times (0.24)}{0.64} $$\n$$ P_{i \\to j} = \\frac{(1.0 \\times 10^{-15}) \\times (2.5 \\times 10^{13}) \\times 0.24}{0.64} = \\frac{(2.5 \\times 10^{-2}) \\times 0.24}{0.64} $$\n$$ P_{i \\to j} = \\frac{0.025 \\times 0.24}{0.64} = \\frac{0.006}{0.64} = 0.009375 $$\nThe result is required to four significant figures. The calculated value is $0.009375$, which is already in this form.", "answer": "$$\\boxed{0.009375}$$", "id": "2928383"}, {"introduction": "After a hop is accepted, a crucial step is to adjust the nuclear momenta to ensure the total energy of the system remains conserved. This practice [@problem_id:2809709] guides you through the derivation of the standard momentum rescaling rule used in FSSH. You will learn how to enforce energy conservation by applying a momentum change along the direction of the non-adiabatic coupling vector, a procedure that is fundamental to the stability and physical realism of any surface hopping simulation.", "problem": "Consider a two-state adiabatic representation for a molecular system with nuclear coordinates collected in the vector $\\mathbf{R}$ and diagonal mass matrix $\\mathbf{M} = \\mathrm{diag}(m_{1},\\dots,m_{3N})$. Let the adiabatic potential energies at the instantaneous geometry $\\mathbf{R}$ be $E_{i}(\\mathbf{R})$ and $E_{j}(\\mathbf{R})$. The nuclear momentum vector immediately before a hop is $\\mathbf{p}$, and the nuclear velocity is $\\mathbf{v} = \\mathbf{M}^{-1}\\mathbf{p}$. A hop from state $i$ to state $j$ occurs at fixed $\\mathbf{R}$, and the nuclear momentum is to be adjusted to conserve total energy.\n\nThe non-adiabatic coupling (NAC) vector between states $i$ and $j$ is $\\mathbf{d}_{ij}(\\mathbf{R}) = \\langle \\phi_{i}(\\mathbf{R})|\\nabla_{\\mathbf{R}}|\\phi_{j}(\\mathbf{R})\\rangle$. Assume that the momentum adjustment is restricted to the one-dimensional subspace spanned by the NAC: define the kinetic-energy-metric unit vector along the NAC by\n$$\n\\hat{\\mathbf{n}} \\;=\\; \\frac{\\mathbf{d}_{ij}}{\\| \\mathbf{M}^{-1/2}\\mathbf{d}_{ij}\\|},\n$$\nso that $\\hat{\\mathbf{n}}^{\\mathsf{T}} \\mathbf{M}^{-1}\\hat{\\mathbf{n}}=1$ and $\\hat{\\mathbf{n}} \\propto \\mathbf{d}_{ij}$. The post-hop momentum is taken as $\\mathbf{p}' = \\mathbf{p} + \\alpha\\,\\hat{\\mathbf{n}}$, with a scalar scale factor $\\alpha$ to be determined.\n\nStarting only from (i) conservation of total energy $E_{\\mathrm{tot}} = \\tfrac{1}{2}\\mathbf{p}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p} + E_{i}(\\mathbf{R})$ before the hop and $E'_{\\mathrm{tot}} = \\tfrac{1}{2}\\mathbf{p}'^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p}' + E_{j}(\\mathbf{R})$ after the hop, (ii) the definition of kinetic energy in terms of $\\mathbf{M}$, and (iii) the NAC-based direction for rescaling given above, derive the momentum rescaling rule. In particular:\n\n- Derive the quadratic equation for the scale factor $\\alpha$ implied by energy conservation when $\\mathbf{p}' = \\mathbf{p} + \\alpha\\,\\hat{\\mathbf{n}}$.\n- Solve this quadratic to obtain a closed-form expression for $\\alpha$ in terms of $\\mathbf{p}$, $\\mathbf{M}$, $E_{i}(\\mathbf{R})$, $E_{j}(\\mathbf{R})$, and $\\mathbf{d}_{ij}(\\mathbf{R})$.\n- Choose the root that yields the smallest change in the component of the momentum along $\\hat{\\mathbf{n}}$ (i.e., preserves the sign of the pre-hop component along $\\hat{\\mathbf{n}}$), and express your final answer explicitly in terms of the scalar quantities $\\Delta E \\equiv E_{i}(\\mathbf{R}) - E_{j}(\\mathbf{R})$ and $b \\equiv \\hat{\\mathbf{n}}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p}$, or equivalently $b = \\dfrac{\\mathbf{v}\\cdot \\mathbf{d}_{ij}}{\\|\\mathbf{M}^{-1/2}\\mathbf{d}_{ij}\\|}$.\n\nProvide your final answer as a single closed-form analytic expression for $\\alpha$. If you use any sign function, write it explicitly. No numerical approximation is required.", "solution": "The problem as stated is scientifically sound, self-contained, and well-posed. It describes a standard procedure for momentum adjustment in the context of fewest-switches surface hopping, a cornerstone method in non-adiabatic molecular dynamics. We may therefore proceed with the derivation.\n\nThe starting point is the principle of conservation of total energy during the instantaneous hop from adiabatic state $i$ to state $j$ at a fixed nuclear geometry $\\mathbf{R}$. The total energy before the hop is the sum of the nuclear kinetic energy and the potential energy of state $i$:\n$$\nE_{\\mathrm{tot}} = \\frac{1}{2}\\mathbf{p}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p} + E_{i}(\\mathbf{R})\n$$\nThe total energy after the hop, with the adjusted nuclear momentum $\\mathbf{p}'$ and potential energy of state $j$, is:\n$$\nE'_{\\mathrm{tot}} = \\frac{1}{2}\\mathbf{p}'^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p}' + E_{j}(\\mathbf{R})\n$$\nEnergy conservation demands that $E_{\\mathrm{tot}} = E'_{\\mathrm{tot}}$:\n$$\n\\frac{1}{2}\\mathbf{p}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p} + E_{i}(\\mathbf{R}) = \\frac{1}{2}\\mathbf{p}'^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p}' + E_{j}(\\mathbf{R})\n$$\nWe are given that the post-hop momentum is related to the pre-hop momentum by $\\mathbf{p}' = \\mathbf{p} + \\alpha\\,\\hat{\\mathbf{n}}$, where $\\alpha$ is a scalar to be determined. Substituting this into the energy conservation equation gives:\n$$\n\\frac{1}{2}\\mathbf{p}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p} + E_{i}(\\mathbf{R}) = \\frac{1}{2}(\\mathbf{p} + \\alpha\\,\\hat{\\mathbf{n}})^{\\mathsf{T}}\\mathbf{M}^{-1}(\\mathbf{p} + \\alpha\\,\\hat{\\mathbf{n}}) + E_{j}(\\mathbf{R})\n$$\nWe now expand the kinetic energy term on the right-hand side. The term $(\\mathbf{p} + \\alpha\\,\\hat{\\mathbf{n}})^{\\mathsf{T}}\\mathbf{M}^{-1}(\\mathbf{p} + \\alpha\\,\\hat{\\mathbf{n}})$ is expanded as follows:\n$$\n(\\mathbf{p}^{\\mathsf{T}} + \\alpha\\,\\hat{\\mathbf{n}}^{\\mathsf{T}})\\mathbf{M}^{-1}(\\mathbf{p} + \\alpha\\,\\hat{\\mathbf{n}}) = \\mathbf{p}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p} + \\alpha\\,\\mathbf{p}^{\\mathsf{T}}\\mathbf{M}^{-1}\\hat{\\mathbf{n}} + \\alpha\\,\\hat{\\mathbf{n}}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p} + \\alpha^{2}\\,\\hat{\\mathbf{n}}^{\\mathsf{T}}\\mathbf{M}^{-1}\\hat{\\mathbf{n}}\n$$\nSince the mass matrix $\\mathbf{M}$ is symmetric, its inverse $\\mathbf{M}^{-1}$ is also symmetric. Consequently, the scalar product $\\mathbf{p}^{\\mathsf{T}}\\mathbf{M}^{-1}\\hat{\\mathbf{n}}$ is equal to its transpose $\\hat{\\mathbf{n}}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p}$. The expansion simplifies to:\n$$\n\\mathbf{p}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p} + 2\\alpha\\,\\hat{\\mathbf{n}}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p} + \\alpha^{2}\\,\\hat{\\mathbf{n}}^{\\mathsf{T}}\\mathbf{M}^{-1}\\hat{\\mathbf{n}}\n$$\nThe problem provides the following definitions: $b \\equiv \\hat{\\mathbf{n}}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p}$ and $\\Delta E \\equiv E_{i}(\\mathbf{R}) - E_{j}(\\mathbf{R})$. We are also given that the vector $\\hat{\\mathbf{n}}$ is normalized in the kinetic-energy metric such that $\\hat{\\mathbf{n}}^{\\mathsf{T}} \\mathbf{M}^{-1}\\hat{\\mathbf{n}}=1$. Using these relations, the energy conservation equation becomes:\n$$\n\\frac{1}{2}\\mathbf{p}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p} + E_{i}(\\mathbf{R}) = \\frac{1}{2}(\\mathbf{p}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p} + 2\\alpha\\,b + \\alpha^{2}) + E_{j}(\\mathbf{R})\n$$\n$$\n\\frac{1}{2}\\mathbf{p}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p} + E_{i}(\\mathbf{R}) = \\frac{1}{2}\\mathbf{p}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p} + \\alpha\\,b + \\frac{1}{2}\\alpha^{2} + E_{j}(\\mathbf{R})\n$$\nThe pre-hop kinetic energy term $\\frac{1}{2}\\mathbf{p}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p}$ cancels from both sides, leaving:\n$$\nE_{i}(\\mathbf{R}) = \\alpha\\,b + \\frac{1}{2}\\alpha^{2} + E_{j}(\\mathbf{R})\n$$\nRearranging the terms yields the quadratic equation for $\\alpha$:\n$$\n\\frac{1}{2}\\alpha^{2} + b\\,\\alpha - (E_{i}(\\mathbf{R}) - E_{j}(\\mathbf{R})) = 0\n$$\n$$\n\\frac{1}{2}\\alpha^{2} + b\\,\\alpha - \\Delta E = 0\n$$\nTo solve this quadratic equation, we use the standard formula for the roots of $Ax^2+Bx+C=0$: $x = \\frac{-B \\pm \\sqrt{B^2-4AC}}{2A}$. Here, $A=\\frac{1}{2}$, $B=b$, and $C=-\\Delta E$.\n$$\n\\alpha = \\frac{-b \\pm \\sqrt{b^{2} - 4(\\frac{1}{2})(-\\Delta E)}}{2(\\frac{1}{2})}\n$$\n$$\n\\alpha = -b \\pm \\sqrt{b^{2} + 2\\Delta E}\n$$\nThis gives two possible solutions for the scaling factor $\\alpha$. A hop is physically possible only if the term under the square root is non-negative, $b^{2} + 2\\Delta E \\ge 0$, which ensures the post-hop kinetic energy is not negative.\n\nThe problem requires selecting the root that \"preserves the sign of the pre-hop component along $\\hat{\\mathbf{n}}$\". The pre-hop component in the mass-weighted metric is $b = \\hat{\\mathbf{n}}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p}$. The corresponding post-hop component is:\n$$\n\\hat{\\mathbf{n}}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p}' = \\hat{\\mathbf{n}}^{\\mathsf{T}}\\mathbf{M}^{-1}(\\mathbf{p} + \\alpha\\hat{\\mathbf{n}}) = \\hat{\\mathbf{n}}^{\\mathsf{T}}\\mathbf{M}^{-1}\\mathbf{p} + \\alpha(\\hat{\\mathbf{n}}^{\\mathsf{T}}\\mathbf{M}^{-1}\\hat{\\mathbf{n}}) = b + \\alpha\n$$\nWe must choose the root for $\\alpha$ such that $\\mathrm{sgn}(b+\\alpha) = \\mathrm{sgn}(b)$. Let's examine the two roots:\n1.  For the root $\\alpha_{+} = -b + \\sqrt{b^{2} + 2\\Delta E}$, the post-hop component is $b + \\alpha_{+} = \\sqrt{b^{2} + 2\\Delta E}$. This value is always non-negative. This choice preserves the sign of $b$ only if $b \\ge 0$.\n2.  For the root $\\alpha_{-} = -b - \\sqrt{b^{2} + 2\\Delta E}$, the post-hop component is $b + \\alpha_{-} = -\\sqrt{b^{2} + 2\\Delta E}$. This value is always non-positive. This choice preserves the sign of $b$ only if $b \\le 0$.\n\nTherefore, the correct choice depends on the sign of $b$:\n$$\n\\alpha = \\begin{cases} -b + \\sqrt{b^{2} + 2\\Delta E}  \\text{if } b \\ge 0 \\\\ -b - \\sqrt{b^{2} + 2\\Delta E}  \\text{if } b  0 \\end{cases}\n$$\nThis piecewise definition can be written as a single analytical expression using the sign function, $\\mathrm{sgn}(x)$. We must define the behavior at $x=0$. To obtain a single expression that covers the $b \\ge 0$ case, we adopt the convention that $\\mathrm{sgn}(0)=1$. The sign function is thus defined as:\n$$\n\\mathrm{sgn}(x) = \\begin{cases} 1  \\text{if } x \\ge 0 \\\\ -1  \\text{if } x  0 \\end{cases}\n$$\nWith this definition, the solution for $\\alpha$ can be expressed in a single closed form:\n$$\n\\alpha = -b + \\mathrm{sgn}(b)\\sqrt{b^{2} + 2\\Delta E}\n$$\nThis choice of root is also the one that yields the smallest change in momentum, i.e., corresponds to the root of $\\alpha$ with the smaller absolute magnitude, except for the ambiguous case $b=0$ where both roots have equal magnitude. The stated convention resolves this ambiguity.", "answer": "$$\\boxed{-b + \\mathrm{sgn}(b) \\sqrt{b^{2} + 2\\Delta E}}$$", "id": "2809709"}, {"introduction": "A powerful test for any molecular dynamics simulation is its ability to reproduce the correct statistical mechanical equilibrium. This final exercise [@problem_id:2928309] challenges you to act as a data analyst, processing the output of a long surface hopping simulation to verify a cornerstone of thermodynamics: the principle of detailed balance. You will extract macroscopic rate constants from microscopic event data and check if their ratio correctly conforms to the Boltzmann distribution, connecting the algorithm's dynamics to observable chemical kinetics.", "problem": "A trajectory-based Fewest-Switches Surface Hopping simulation of a diatomic molecule is run on two coupled adiabatic electronic states labeled $1$ and $2$. After an initial transient, the simulation reaches a stationary regime at a constant nuclear temperature $T$ in which time averages equal ensemble averages. The two adiabatic surfaces in the sampled region are approximately parallel and separated by a constant energy gap $\\Delta E = E_{2} - E_{1}$. Over a long observation window, the following statistics are recorded:\n- Total residence time on state $1$: $T_{1} = 9.95\\,\\mu\\mathrm{s}$.\n- Total residence time on state $2$: $T_{2} = 2.04\\,\\mu\\mathrm{s}$.\n- Number of hops from $1 \\to 2$: $N_{1\\to 2} = 50{,}112$.\n- Number of hops from $2 \\to 1$: $N_{2\\to 1} = 49{,}888$.\n\nAssume:\n- The long-time dynamics between the two adiabatic states can be modeled as a continuous-time, time-homogeneous, two-state Markov process for the electronic state, coupled to a canonical nuclear bath at temperature $T = 300\\,\\mathrm{K}$.\n- The ideal-gas constant is $R_{\\mathrm{g}} = 8.314462618\\,\\mathrm{J}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}$, and the energy gap is $\\Delta E = 3.95\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$.\n- Over the long observation window, hop counts may be treated as independent Poisson random variables conditioned on the effective rate constants, and the recorded residence times $T_{1}$ and $T_{2}$ are taken as exact.\n\nStarting only from the fundamental definitions of a continuous-time Markov process, stationarity of the two-state master equation, and canonical equilibrium for the nuclear degrees of freedom, derive expressions for the effective rate constants $k_{12}$ and $k_{21}$ in terms of $(N_{1\\to 2}, T_{1})$ and $(N_{2\\to 1}, T_{2})$, and for the expected equilibrium constraint linking $k_{12}/k_{21}$ to the energy gap and temperature. Then, compute the dimensionless quantity\n$$\nQ \\equiv \\frac{k_{12}/k_{21}}{\\exp\\!\\big(-\\Delta E/(R_{\\mathrm{g}} T)\\big)}.\n$$\nRound your answer for $Q$ to four significant figures. Express your final answer as a pure number (dimensionless). In your derivation, comment on the sampling uncertainty and whether the observed deviation from unity in $Q$ is statistically meaningful under the Poisson assumption, but do not report any additional numerical values beyond $Q$ in your final answer.", "solution": "The problem is subjected to validation and is found to be scientifically grounded, well-posed, and objective. It contains all necessary information for a rigorous solution. We proceed.\n\nThe task is to derive expressions for the kinetic rate constants, establish their relationship under thermal equilibrium, and then compute a dimensionless quantity $Q$ that measures the consistency of simulation data with the theoretical expectation of detailed balance.\n\n**1. Derivation of Effective Rate Constants**\n\nThe problem states that the long-time dynamics of the electronic state can be modeled as a continuous-time, time-homogeneous, two-state Markov process. Let the two states be labeled $1$ and $2$. The transition from state $1$ to state $2$ is a stochastic event with a rate constant $k_{12}$. The definition of such a rate constant is that for a system in state $1$, the probability of transitioning to state $2$ in an infinitesimal time interval $dt$ is $k_{12} dt$.\n\nOver a finite observation time, the number of transitions is proportional to the total time spent in the initial state. The simulation provides the total residence time on state $1$, $T_{1}$, and the total number of hops out of this state, $N_{1\\to 2}$. The most direct estimator for the effective rate constant $k_{12}$ is the observed frequency of transitions, which is the total number of events divided by the total exposure time.\nTherefore, the effective rate constant for the $1 \\to 2$ process is given by:\n$$\nk_{12} = \\frac{N_{1\\to 2}}{T_{1}}\n$$\nSimilarly, for the reverse process, the transition from state $2$ to state $1$, the effective rate constant $k_{21}$ is given by:\n$$\nk_{21} = \\frac{N_{2\\to 1}}{T_{2}}\n$$\nwhere $N_{2\\to 1}$ is the number of hops from state $2$ to $1$ and $T_{2}$ is the total residence time on state $2$.\n\n**2. Derivation of the Equilibrium Constraint (Detailed Balance)**\n\nLet $P_1(t)$ and $P_2(t)$ be the populations of states $1$ and $2$ at time $t$. For a two-state Markov process, the time evolution of these populations is described by the master equation:\n$$\n\\frac{dP_1(t)}{dt} = -k_{12} P_1(t) + k_{21} P_2(t)\n$$\n$$\n\\frac{dP_2(t)}{dt} = +k_{12} P_1(t) - k_{21} P_2(t)\n$$\nThe problem states that the simulation has reached a stationary regime. In a stationary state, the populations are constant, i.e., $\\frac{dP_1}{dt} = \\frac{dP_2}{dt} = 0$. This leads to the condition of detailed balance:\n$$\nk_{12} P_{1}^{\\text{st}} = k_{21} P_{2}^{\\text{st}}\n$$\nwhere $P_{1}^{\\text{st}}$ and $P_{2}^{\\text{st}}$ are the stationary populations of states $1$ and $2$.\n\nThe problem specifies that the nuclear degrees of freedom form a canonical bath at temperature $T = 300\\,\\mathrm{K}$ and that time averages equal ensemble averages. This ergodic hypothesis implies that the stationary populations observed in the simulation correspond to the equilibrium populations predicted by statistical mechanics for a system at this temperature. For two electronic states with energies $E_1$ and $E_2$, the ratio of their equilibrium populations is given by the Boltzmann factor:\n$$\n\\frac{P_{2}^{\\text{eq}}}{P_{1}^{\\text{eq}}} = Z_2/Z_1 \\exp\\left(-\\frac{E_2 - E_1}{k_B T}\\right)\n$$\nwhere $k_B$ is the Boltzmann constant and $Z_i$ are the partition functions for any internal degrees of freedom within each state. For simple electronic states as implied here, we can take $Z_1=Z_2=1$. The problem provides the energy gap as a molar quantity, $\\Delta E = 3.95\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$, and the ideal gas constant $R_{\\mathrm{g}}$. We use the identity $R_{\\mathrm{g}} = N_A k_B$, where $N_A$ is the Avogadro constant, to write the argument of the exponential in molar terms:\n$$\n\\frac{E_2 - E_1}{k_B T} = \\frac{N_A (E_2 - E_1)}{N_A k_B T} = \\frac{\\Delta E}{R_{\\mathrm{g}} T}\n$$\nThus, the equilibrium population ratio is:\n$$\n\\frac{P_{2}^{\\text{eq}}}{P_{1}^{\\text{eq}}} = \\exp\\left(-\\frac{\\Delta E}{R_{\\mathrm{g}} T}\\right)\n$$\nEquating the stationary and equilibrium populations ($P_i^{\\text{st}} = P_i^{\\text{eq}}$) and substituting this into the detailed balance condition, we find the expected relationship between the rate constants at equilibrium:\n$$\n\\frac{k_{12}}{k_{21}} = \\frac{P_{2}^{\\text{eq}}}{P_{1}^{\\text{eq}}} = \\exp\\left(-\\frac{\\Delta E}{R_{\\mathrm{g}} T}\\right)\n$$\nThis is the required equilibrium constraint.\n\n**3. Computation of the Quantity Q**\n\nWe are asked to compute the dimensionless quantity $Q$, defined as the ratio of the experimentally observed rate constant ratio to the theoretically expected one:\n$$\nQ \\equiv \\frac{(k_{12}/k_{21})_{\\text{observed}}}{(k_{12}/k_{21})_{\\text{theory}}} = \\frac{(k_{12}/k_{21})_{\\text{observed}}}{\\exp(-\\Delta E/(R_{\\mathrm{g}} T))}\n$$\nFirst, we compute the observed ratio of rate constants using the derived expressions and the provided simulation data:\n$T_{1} = 9.95 \\times 10^{-6}\\,\\mathrm{s}$, $T_{2} = 2.04 \\times 10^{-6}\\,\\mathrm{s}$, $N_{1\\to 2} = 50{,}112$, and $N_{2\\to 1} = 49{,}888$.\n$$\n\\left(\\frac{k_{12}}{k_{21}}\\right)_{\\text{observed}} = \\frac{N_{1\\to 2}/T_{1}}{N_{2\\to 1}/T_{2}} = \\frac{N_{1\\to 2} T_{2}}{N_{2\\to 1} T_{1}} = \\frac{50112 \\times (2.04 \\times 10^{-6})}{49888 \\times (9.95 \\times 10^{-6})} = \\frac{102228.48}{496385.6} \\approx 0.205946\n$$\nNext, we compute the theoretical ratio from the detailed balance principle. The given values are $\\Delta E = 3.95\\,\\mathrm{kJ}\\,\\mathrm{mol}^{-1} = 3950\\,\\mathrm{J}\\,\\mathrm{mol}^{-1}$, $T = 300\\,\\mathrm{K}$, and $R_{\\mathrm{g}} = 8.314462618\\,\\mathrm{J}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}$.\n$$\n\\frac{\\Delta E}{R_{\\mathrm{g}} T} = \\frac{3950}{8.314462618 \\times 300} \\approx 1.58359\n$$\nThe theoretical ratio is:\n$$\n\\exp\\left(-\\frac{\\Delta E}{R_{\\mathrm{g}} T}\\right) \\approx \\exp(-1.58359) \\approx 0.205234\n$$\nFinally, we compute $Q$:\n$$\nQ = \\frac{0.205946}{0.205234} \\approx 1.003471\n$$\nRounding this result to four significant figures as requested gives $Q = 1.003$.\n\n**4. Commentary on Sampling Uncertainty**\n\nThe value of $Q$ is very close to $1$, which indicates good agreement between the simulation and the theoretical expectation of detailed balance. The question is whether the deviation from $1$ is statistically meaningful or simply a result of finite sampling. We assume the hop counts $N_{1\\to 2}$ and $N_{2\\to 1}$ are independent Poisson random variables, so their standard deviations are $\\sigma_{N_{1\\to 2}} = \\sqrt{N_{1\\to 2}}$ and $\\sigma_{N_{2\\to 1}} = \\sqrt{N_{2\\to 1}}$. The residence times $T_1$ and $T_2$ are treated as exact.\nLet $R_{\\text{obs}} = (N_{1\\to 2} T_2) / (N_{2\\to 1} T_1)$. The relative uncertainty in $R_{\\text{obs}}$ is given by standard error propagation:\n$$\n\\frac{\\sigma_{R_{\\text{obs}}}}{R_{\\text{obs}}} = \\sqrt{\\left(\\frac{\\sigma_{N_{1\\to 2}}}{N_{1\\to 2}}\\right)^2 + \\left(\\frac{\\sigma_{N_{2\\to 1}}}{N_{2\\to 1}}\\right)^2} = \\sqrt{\\frac{1}{N_{1\\to 2}} + \\frac{1}{N_{2\\to 1}}}\n$$\nSubstituting the numerical values:\n$$\n\\frac{\\sigma_{R_{\\text{obs}}}}{R_{\\text{obs}}} = \\sqrt{\\frac{1}{50112} + \\frac{1}{49888}} \\approx \\sqrt{1.9955 \\times 10^{-5} + 2.0045 \\times 10^{-5}} \\approx 0.006324\n$$\nThe absolute uncertainty in the observed ratio is $\\sigma_{R_{\\text{obs}}} = R_{\\text{obs}} \\times 0.006324 \\approx 0.205946 \\times 0.006324 \\approx 0.001302$.\nThe deviation between the observed and theoretical ratios is $|R_{\\text{obs}} - R_{\\text{theory}}| = |0.205946 - 0.205234| = 0.000712$.\nThis deviation is smaller than the calculated standard deviation of the measurement ($0.000712  0.001302$). The Z-score for this deviation is approximately $0.000712 / 0.001302 \\approx 0.55$. As this is less than one standard deviation, the observed difference is statistically insignificant. The simulation results are fully consistent with the principle of detailed balance within the expected statistical noise from a finite-length trajectory. The deviation of $Q$ from unity is not meaningful.", "answer": "$$\\boxed{1.003}$$", "id": "2928309"}]}