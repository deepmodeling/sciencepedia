{
    "hands_on_practices": [
        {
            "introduction": "在仿星器等三维磁约束构型中，准确描述物理量需要使用专门的坐标系，如 Boozer 坐标。磁面平均是分析输运和稳定性的基本工具，它能够从复杂的空间变化中提取出关键的宏观信息。本练习将引导你亲手计算这一平均值，并理解三维非对称几何（由雅可比行列式 $J$ 体现）如何对磁面上的不同区域进行加权，这是解读模拟数据的核心技能。",
            "id": "4208541",
            "problem": "在三维(3D)仿星器几何中，Boozer 坐标系 $(\\psi,\\theta,\\zeta)$ 下的磁面平均是通过使用表面雅可比行列式 $J(\\theta,\\zeta) \\equiv \\left[\\nabla \\psi \\cdot (\\nabla \\theta \\times \\nabla \\zeta)\\right]^{-1}$ 进行加权来定义的。考虑一个简化的、但物理上自洽的非轴对称仿星器磁面模型，其雅可比行列式中只有一个主导的螺旋谐波，\n$$\nJ(\\theta,\\zeta) = J_0 \\left[1 + \\alpha \\cos\\!\\big(p\\,\\theta - q\\,\\zeta\\big)\\right],\n$$\n其中 $J_0 > 0$ 是一个常数，$0  \\alpha  1$ 是一个小的非轴对称调制幅度（确保 $J(\\theta,\\zeta)  0$），$p,q \\in \\mathbb{Z}^{+}$ 编码了场的周期性。设代表磁面上湍流量的标量场为\n$$\nf(\\theta,\\zeta) = f_0 + f_c \\cos\\!\\big(p\\,\\theta - q\\,\\zeta\\big) + f_s \\sin\\!\\big(p\\,\\theta - q\\,\\zeta\\big) + g \\cos\\!\\big(2p\\,\\theta - 2q\\,\\zeta\\big),\n$$\n其中 $f_0, f_c, f_s, g$ 是常数。磁面平均由以下核心几何关系定义\n$$\n\\langle f \\rangle \\equiv \\frac{\\displaystyle \\int_{0}^{2\\pi}\\!\\!\\int_{0}^{2\\pi} f(\\theta,\\zeta)\\, J(\\theta,\\zeta)\\, d\\theta\\, d\\zeta}{\\displaystyle \\int_{0}^{2\\pi}\\!\\!\\int_{0}^{2\\pi} J(\\theta,\\zeta)\\, d\\theta\\, d\\zeta}.\n$$\n假设在 $\\theta \\in [0,2\\pi]$ 和 $\\zeta \\in [0,2\\pi]$ 上具有周期性，并且 $p$ 和 $q$ 是非零整数，从而谐波在环面上是正交的。\n\n使用上述定义，计算 $\\langle f \\rangle$ 关于 $f_0$、$f_c$、$f_s$、$g$ 和 $\\alpha$ 的精确闭式表达式。然后，从第一性原理出发，解释非轴对称性（即 $\\alpha \\neq 0$）如何影响由 $J(\\theta,\\zeta)$ 决定的加权，以及由于这种加权，$f$ 的哪些谐波在 $\\langle f \\rangle$ 中被保留下来。你的最终答案必须是单一的闭式解析表达式。最终表达式无需单位。",
            "solution": "该问题要求计算非轴对称仿星器磁面上标量场 $f(\\theta,\\zeta)$ 的磁面平均 $\\langle f \\rangle$。\n\n### 步骤 1：问题验证\n\n首先，我将验证所提供的问题陈述。\n\n**已知条件：**\n- Boozer 坐标系 $(\\psi,\\theta,\\zeta)$。\n- 雅可比行列式：$J(\\theta,\\zeta) = J_0 \\left[1 + \\alpha \\cos\\!\\big(p\\,\\theta - q\\,\\zeta\\big)\\right]$，其中 $J_0  0$，$0  \\alpha  1$，$p,q \\in \\mathbb{Z}^{+}$。\n- 标量场：$f(\\theta,\\zeta) = f_0 + f_c \\cos\\!\\big(p\\,\\theta - q\\,\\zeta\\big) + f_s \\sin\\!\\big(p\\,\\theta - q\\,\\zeta\\big) + g \\cos\\!\\big(2p\\,\\theta - 2q\\,\\zeta\\big)$，其中 $f_0, f_c, f_s, g$ 为常数。\n- 磁面平均的定义：\n$$\n\\langle f \\rangle \\equiv \\frac{\\displaystyle \\int_{0}^{2\\pi}\\!\\!\\int_{0}^{2\\pi} f(\\theta,\\zeta)\\, J(\\theta,\\zeta)\\, d\\theta\\, d\\zeta}{\\displaystyle \\int_{0}^{2\\pi}\\!\\!\\int_{0}^{2\\pi} J(\\theta,\\zeta)\\, d\\theta\\, d\\zeta}.\n$$\n- 积分域：$\\theta \\in [0,2\\pi]$ 和 $\\zeta \\in [0,2\\pi]$。\n- 周期性假设：$p$ 和 $q$ 是非零整数，确保谐波的正交性。\n\n**对照标准进行验证：**\n1.  **科学依据：** 该问题基于聚变等离子体物理学的标准概念，特别是仿星器磁流体动力学(MHD)平衡理论。Boozer 坐标系、雅可比行列式和磁面平均是基本工具。雅可比行列式和标量场的模型是非轴对称几何和湍流涨落的简化但物理上自洽的表示。该问题在科学上是合理的。\n2.  **良态的：** 该问题提供了进行计算所需的所有函数和定义。积分是良定义的，参数有明确的约束条件 ($p, q \\in \\mathbb{Z}^{+}$)，可防止出现奇点或未定义的结果。存在唯一、稳定且有意义的解。\n3.  **客观的：** 语言精确、数学化，没有任何主观或模糊的术语。\n4.  **未检测到其他缺陷：** 该问题不是不完整的、矛盾的、不切实际的、病态的、微不足道的或无法验证的。这是其科学领域内一个直接而标准的计算。\n\n**结论：** 该问题是有效的。\n\n### 步骤 2：解答\n\n我现在开始计算磁面平均 $\\langle f \\rangle$。计算过程包括分别计算分子和分母中的积分。将要使用的一个关键数学性质是三角函数在域 $[0, 2\\pi] \\times [0, 2\\pi]$ 上的正交性。对于任何整数 $m, n, m', n'$，其中 $(m, n) \\neq (0,0)$：\n$$\n\\int_0^{2\\pi}\\!\\!\\int_0^{2\\pi} \\cos(m\\theta - n\\zeta) d\\theta d\\zeta = 0\n$$\n$$\n\\int_0^{2\\pi}\\!\\!\\int_0^{2\\pi} \\sin(m\\theta - n\\zeta) d\\theta d\\zeta = 0\n$$\n并且对于 $(m,n) \\neq (m',n')$：\n$$\n\\int_0^{2\\pi}\\!\\!\\int_0^{2\\pi} \\cos(m\\theta - n\\zeta)\\cos(m'\\theta-n'\\zeta) d\\theta d\\zeta = 0\n$$\n\n**分母计算：**\n分母是雅可比行列式在整个磁面上的积分。\n$$\n\\text{Denominator} = \\int_{0}^{2\\pi}\\!\\!\\int_{0}^{2\\pi} J(\\theta,\\zeta)\\, d\\theta\\, d\\zeta = \\int_{0}^{2\\pi}\\!\\!\\int_{0}^{2\\pi} J_0 \\left[1 + \\alpha \\cos\\!\\big(p\\,\\theta - q\\,\\zeta\\big)\\right] d\\theta\\, d\\zeta\n$$\n我们可以将积分拆分：\n$$\n\\text{Denominator} = J_0 \\int_{0}^{2\\pi}\\!\\!\\int_{0}^{2\\pi} 1 \\, d\\theta\\, d\\zeta + J_0 \\alpha \\int_{0}^{2\\pi}\\!\\!\\int_{0}^{2\\pi} \\cos(p\\,\\theta - q\\,\\zeta)\\, d\\theta\\, d\\zeta\n$$\n第一项的计算结果为 $J_0 (2\\pi)(2\\pi) = 4\\pi^2 J_0$。第二项是余弦函数在其周期上的积分。由于 $p, q \\in \\mathbb{Z}^{+}$ 是非零整数，根据正交性，该积分为零。\n$$\n\\int_{0}^{2\\pi}\\!\\!\\int_{0}^{2\\pi} \\cos(p\\,\\theta - q\\,\\zeta)\\, d\\theta\\, d\\zeta = \\int_0^{2\\pi} \\left[ \\frac{\\sin(p\\theta - q\\zeta)}{p} \\right]_0^{2\\pi} d\\zeta = \\int_0^{2\\pi} 0 \\, d\\zeta = 0\n$$\n因此，分母为：\n$$\n\\text{Denominator} = 4\\pi^2 J_0\n$$\n\n**分子计算：**\n分子是乘积 $f(\\theta,\\zeta)J(\\theta,\\zeta)$ 的积分。\n$$\n\\text{Numerator} = \\int_{0}^{2\\pi}\\!\\!\\int_{0}^{2\\pi} f(\\theta,\\zeta)\\, J(\\theta,\\zeta)\\, d\\theta\\, d\\zeta\n$$\n我们来写出这个乘积。为简便起见，令 $u = p\\,\\theta - q\\,\\zeta$。\n$$\nf J = J_0 \\left[1 + \\alpha \\cos(u)\\right] \\left[f_0 + f_c \\cos(u) + f_s \\sin(u) + g \\cos(2u)\\right]\n$$\n展开乘积：\n$$\n\\frac{f J}{J_0} = f_0 + f_c \\cos(u) + f_s \\sin(u) + g \\cos(2u) + \\alpha f_0 \\cos(u) + \\alpha f_c \\cos^2(u) + \\alpha f_s \\sin(u)\\cos(u) + \\alpha g \\cos(u)\\cos(2u)\n$$\n我们必须对每一项在 $\\theta \\in [0, 2\\pi]$ 和 $\\zeta \\in [0, 2\\pi]$ 上积分。由于正交性，大多数项的积分将为零。唯一能产生非零结果的项是常数项或经过三角函数化简后包含常数分量的项。\n\\begin{enumerate}\n    \\item $\\int\\int f_0 d\\theta d\\zeta = f_0 (4\\pi^2)$。\n    \\item $\\int\\int f_c \\cos(u) d\\theta d\\zeta = 0$。\n    \\item $\\int\\int f_s \\sin(u) d\\theta d\\zeta = 0$。\n    \\item $\\int\\int g \\cos(2u) d\\theta d\\zeta = 0$。\n    \\item $\\int\\int \\alpha f_0 \\cos(u) d\\theta d\\zeta = 0$。\n    \\item $\\int\\int \\alpha f_c \\cos^2(u) d\\theta d\\zeta$：我们使用恒等式 $\\cos^2(u) = \\frac{1}{2}(1 + \\cos(2u))$。\n    $$\n    \\int_{0}^{2\\pi}\\!\\!\\int_{0}^{2\\pi} \\alpha f_c \\left(\\frac{1}{2} + \\frac{1}{2}\\cos(2u)\\right) d\\theta d\\zeta = \\alpha f_c \\int_{0}^{2\\pi}\\!\\!\\int_{0}^{2\\pi} \\frac{1}{2} d\\theta d\\zeta + \\frac{\\alpha f_c}{2} \\int_{0}^{2\\pi}\\!\\!\\int_{0}^{2\\pi} \\cos(2u) d\\theta d\\zeta\n    $$\n    第二个积分为零。第一个积分得出 $\\frac{1}{2}\\alpha f_c (4\\pi^2) = 2\\pi^2 \\alpha f_c$。\n    \\item $\\int\\int \\alpha f_s \\sin(u)\\cos(u) d\\theta d\\zeta$：我们使用 $\\sin(u)\\cos(u) = \\frac{1}{2}\\sin(2u)$。积分 $\\int\\int \\frac{1}{2}\\alpha f_s \\sin(2u) d\\theta d\\zeta = 0$。\n    \\item $\\int\\int \\alpha g \\cos(u)\\cos(2u) d\\theta d\\zeta$：我们使用 $\\cos(u)\\cos(2u) = \\frac{1}{2}(\\cos(u) + \\cos(3u))$。两项的积分都为零。\n\\end{enumerate}\n将分子积分的非零贡献相加：\n$$\n\\text{Numerator} = J_0 \\left[ 4\\pi^2 f_0 + 2\\pi^2 \\alpha f_c \\right] = 4\\pi^2 J_0 \\left( f_0 + \\frac{\\alpha f_c}{2} \\right)\n$$\n\n**$\\langle f \\rangle$ 的最终结果**\n现在我们计算分子与分母的比值：\n$$\n\\langle f \\rangle = \\frac{4\\pi^2 J_0 \\left( f_0 + \\frac{\\alpha f_c}{2} \\right)}{4\\pi^2 J_0} = f_0 + \\frac{\\alpha f_c}{2}\n$$\n\n### 步骤 3：非轴对称性效应的解释\n\n该问题还要求解释非轴对称性如何影响加权以及哪些谐波被保留下来。\n\n从第一性原理出发，磁面平均 $\\langle f \\rangle$ 是函数 $f$ 在磁面上的加权平均，其中雅可比行列式 $J$ 充当权重函数。\n\n在轴对称极限下，对应于设置非轴对称调制幅度 $\\alpha=0$，雅可比行列式变为一个常数 $J(\\theta,\\zeta) = J_0$。平均值简化为：\n$$\n\\langle f \\rangle_{\\alpha=0} = \\frac{\\displaystyle \\int_{0}^{2\\pi}\\!\\!\\int_{0}^{2\\pi} f(\\theta,\\zeta)\\, J_0\\, d\\theta\\, d\\zeta}{\\displaystyle \\int_{0}^{2\\pi}\\!\\!\\int_{0}^{2\\pi} J_0\\, d\\theta\\, d\\zeta} = \\frac{1}{4\\pi^2} \\int_{0}^{2\\pi}\\!\\!\\int_{0}^{2\\pi} f(\\theta,\\zeta)\\, d\\theta\\, d\\zeta\n$$\n这是 $f$ 在环向角上的简单、非加权平均。由于三角函数的正交性，$f$ 的所有振荡分量（带有 $f_c$、$f_s$ 和 $g$ 的项）的积分都为零。只有常数（或平均）分量 $f_0$ 得以保留：\n$$\n\\langle f \\rangle_{\\alpha=0} = \\frac{1}{4\\pi^2} \\left[ 4\\pi^2 f_0 + 0 + 0 + 0 \\right] = f_0.\n$$\n\n当存在非轴对称性时 ($\\alpha \\neq 0$)，雅可比行列式 $J(\\theta,\\zeta) = J_0 [1 + \\alpha \\cos(p\\theta - q\\zeta)]$ 不再是均匀的。它具有与 $\\cos(p\\theta - q\\zeta)$ 成正比的空间变化。这种空间依赖的加权改变了平均过程的结果。\n\n现在的平均涉及乘积 $f \\cdot J$ 的积分。该积分的值由 $f$ 的傅里叶谐波与 $J$ 的谐波之间的“共振拍频”决定。对平均值的非零贡献仅来自于那些能够产生常数（零波数）分量的谐波乘积。\n$J$ 的谐波是一个常数 ($1$) 和一个余弦模式 $\\cos(p\\theta - q\\zeta)$。\n$f$ 的谐波是一个常数 ($f_0$)、一个余弦模式 $\\cos(p\\theta - q\\zeta)$、一个正弦模式 $\\sin(p\\theta - q\\zeta)$ 和一个高阶余弦模式 $\\cos(2p\\theta - 2q\\zeta)$。\n\n唯一能产生非零平均值的相互作用是：\n1.  $f$ 的常数部分 ($f_0$) 与 $J$ 的常数部分 ($J_0$) 的乘积，在最终答案中贡献了 $f_0$ 项。\n2.  $f$ 中与 $J$ 中谐波具有相同空间依赖性的谐波的乘积。在这里，这是来自 $f$ 的 $f_c \\cos(p\\theta - q\\zeta)$ 项和来自 $J$ 的 $\\alpha \\cos(p\\theta - q\\zeta)$ 项。它们的乘积是 $\\alpha f_c \\cos^2(p\\theta - q\\zeta)$。使用恒等式 $\\cos^2(x) = \\frac{1}{2}(1 + \\cos(2x))$，该乘积包含一个常数分量 $\\frac{1}{2}\\alpha f_c$。这个常数分量在积分后得以保留，并对最终平均值贡献了 $\\frac{\\alpha f_c}{2}$ 项。\n\n$f$ 的其他谐波与 $J$ 的谐波变化是正交的。\n- 正弦项 $f_s \\sin(p\\theta - q\\zeta)$ 产生的乘积为 $\\alpha f_s \\sin(p\\theta - q\\zeta)\\cos(p\\theta - q\\zeta) \\propto \\sin(2p\\theta - 2q\\zeta)$，其平均值为零。\n- 高次谐波 $g \\cos(2p\\theta - 2q\\zeta)$ 产生的乘积为 $\\alpha g \\cos(p\\theta - q\\zeta)\\cos(2p\\theta - 2q\\zeta) \\propto \\cos(p\\theta - q\\zeta) + \\cos(3p\\theta - 3q\\zeta)$，其平均值也为零。\n\n本质上，编码在雅可比行列式 $J$ 中的几何非轴对称性起到了选择性滤波器的作用。它允许标量场 $f$ 的一个特定谐波——即其空间结构与几何形状的主导非轴对称谐波共振的那个谐波——对其自身的磁面平均做出贡献。与几何变化正交的 $f$ 的谐波被平均掉，就像在轴对称情况中一样。这种机制是在复杂的、非对称的坐标系中描述物理学的基本结果。",
            "answer": "$$\n\\boxed{f_0 + \\frac{\\alpha f_c}{2}}\n$$"
        },
        {
            "introduction": "既然我们理解了精确几何描述的重要性，就必须面对一个现实挑战：我们对磁场的数值表示永远无法做到完美。本练习使用一个简化模型，旨在训练一项在模拟验证与确认（VV）中至关重要的技能：量化几何输入中的不确定性如何传播到关键的物理输出中。",
            "id": "4208597",
            "problem": "考虑一个用于描述三维 (3D) 仿星器中单根磁力线上标量涨落振幅 $a(s,t)$ 演化的简化线性模型，该模型在场向坐标系中表示。该模型捕捉了平行扩散和恒定的不稳定性驱动，由以下线性偏微分方程给出\n$$\n\\frac{\\partial a}{\\partial t} = \\gamma_d \\, a + \\nu \\, \\frac{\\partial^2 a}{\\partial s^2},\n$$\n其中 $s$ 是沿磁力线的平行坐标，$t$ 是时间，$\\gamma_d$ 是一个恒定的驱动参数，$\\nu$ 是一个恒定的平行扩散系数。在一个标准化的归一化体系中，所有量都是无量纲的（不需要物理单位）。平行域是一个长度为 $L$ 的区间 $s \\in [0,L]$，边界条件是由磁力线拓扑引起的扭曲周期性映射。如果代码使用微扰的几何输入，边界相位会发生偏移。将真实映射相位记为 $\\Phi_{\\text{true}}$，使用的相位记为 $\\Phi_{\\text{used}} = \\Phi_{\\text{true}} + \\varepsilon$，其中 $\\varepsilon$ 是以弧度为单位的几何误差。扭曲周期性边界条件为\n$$\na(L,t) = e^{i \\Phi_{\\text{used}}} \\, a(0,t), \\quad \\frac{\\partial a}{\\partial s}(L,t) = e^{i \\Phi_{\\text{used}}} \\, \\frac{\\partial a}{\\partial s}(0,t).\n$$\n假设简正模解的形式为 $a(s,t) = A \\, e^{\\lambda t} \\, f(s)$，其中 $f(s)$ 满足上述边界条件。磁力线扭曲引入了一组离散的、由整数模数 $n \\in \\mathbb{Z}$ 索引的允许平行波数，它与 $\\Phi_{\\text{used}}$ 中的微扰共同决定了增长率。模式增长率对几何误差的灵敏度需要相对于 $\\varepsilon$ 进行评估。此外，通过测量施加在 $s=0$ 处单位振幅上的复相位失配的幅值，来量化因使用 $\\Phi_{\\text{used}}$ 而非 $\\Phi_{\\text{true}}$ 引起的边界相位不一致性。\n\n您的任务是：\n- 基于上述基本模型和边界条件，推导一个算法，该算法能够对给定的参数集 $(L,\\gamma_d,\\nu,\\Phi_{\\text{true}},\\varepsilon,n)$ 计算以下三个量：\n  1. 在微扰边界映射下，选定模数 $n$ 的模式增长率，以浮点数形式表示。\n  2. 模式增长率对几何误差 $\\varepsilon$ 的灵敏度（即增长率关于 $\\varepsilon$ 的导数），以浮点数形式表示。\n  3. 边界相位不一致性幅值（其中 $s=0$ 处的振幅归一化为1），以浮点数形式表示。\n- 在一个程序中实现该算法，该程序为提供的测试套件评估这些量，并以指定的格式打印它们。\n\n角度必须以弧度为单位。\n\n测试套件：\n- 情况 1：$L=10.0$，$\\gamma_d=0.3$，$\\nu=0.05$，$\\Phi_{\\text{true}}=0.8$，$\\varepsilon=0.05$，$n=1$ (正常路径)。\n- 情况 2：$L=12.0$，$\\gamma_d=0.25$，$\\nu=0.08$，$\\Phi_{\\text{true}}=1.2$，$\\varepsilon=0.0$，$n=0$ (几何误差为零的边界条件)。\n- 情况 3：$L=8.0$，$\\gamma_d=0.5$，$\\nu=0.03$，$\\Phi_{\\text{true}}=2.6$，$\\varepsilon=-0.02$，$n=5$ (更高的模数和负几何误差)。\n- 情况 4：$L=2.0$，$\\gamma_d=0.15$，$\\nu=0.1$，$\\Phi_{\\text{true}}=0.5$，$\\varepsilon=0.1$，$n=1$ (短连接长度)。\n- 情况 5：$L=10.0$，$\\gamma_d=0.4$，$\\nu=0.05$，$\\Phi_{\\text{true}}=1.0$，$\\varepsilon=\\pi$，$n=0$ (最大相位不一致性)。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的、以逗号分隔的结果列表，且无空格。对于每种情况，输出由增长率 $\\Gamma$、灵敏度 $S$ 和相位不一致性幅值 $P$ 组成的三元组 $[\\Gamma,S,P]$。将所有五种情况聚合到一个列表中，最终得到一个形式为 $[[\\Gamma_1,S_1,P_1],[\\Gamma_2,S_2,P_2],\\dots]$ 的字符串，且只打印一次。",
            "solution": "问题陈述经评估是有效的。它具有科学依据，在数学上是适定的，并且没有矛盾或含糊之处。它提出了一个在等离子体物理学背景下的标准本征值问题，可以为其推导出唯一的解。因此，我们可以继续进行求解。\n\n该问题要求推导一个算法，用于计算与仿星器几何中标量涨落的线性模型相关的三个量。控制偏微分方程 (PDE) 为：\n$$\n\\frac{\\partial a}{\\partial t} = \\gamma_d \\, a + \\nu \\, \\frac{\\partial^2 a}{\\partial s^2}\n$$\n其中 $a(s,t)$ 是涨落振幅，$s$ 是平行坐标，$t$ 是时间，$\\gamma_d$ 是不稳定性驱动，$\\nu$ 是平行扩散系数。域为 $s \\in [0,L]$，具有扭曲周期性边界条件：\n$$\na(L,t) = e^{i \\Phi_{\\text{used}}} \\, a(0,t), \\quad \\frac{\\partial a}{\\partial s}(L,t) = e^{i \\Phi_{\\text{used}}} \\, \\frac{\\partial a}{\\partial s}(0,t)\n$$\n其中 $\\Phi_{\\text{used}} = \\Phi_{\\text{true}} + \\varepsilon$。\n\n我们假设一个形式为 $a(s,t) = A \\, e^{\\lambda t} \\, f(s)$ 的简正模解，其中 $\\lambda$ 是复增长率。$\\lambda$ 的实部对应于模式增长率，我们将其记为 $\\Gamma$。将此试探解代入 PDE，得到关于空间部分 $f(s)$ 的常微分方程 (ODE)：\n$$\n\\lambda f(s) = \\gamma_d f(s) + \\nu \\frac{d^2 f}{ds^2}\n$$\n重新整理后得到一个标准的亥姆霍兹方程：\n$$\n\\frac{d^2 f}{ds^2} + \\left( \\frac{\\lambda - \\gamma_d}{-\\nu} \\right) f(s) = 0\n$$\n$$\n\\frac{d^2 f}{ds^2} + k^2 f(s) = 0, \\quad \\text{其中} \\quad k^2 = \\frac{\\gamma_d - \\lambda}{\\nu}\n$$\n此 ODE 的通解为 $f(s) = C_1 e^{iks} + C_2 e^{-iks}$。然而，形式为 $f(s) = e^{ik_\\parallel s}$ 的本征函数最容易满足边界条件，其中 $k_\\parallel$ 是平行波数。将第一个边界条件应用于此本征函数：\n$$\nf(L) = e^{i\\Phi_{\\text{used}}} f(0)\n$$\n$$\ne^{ik_\\parallel L} = e^{i\\Phi_{\\text{used}}} e^{ik_\\parallel \\cdot 0} = e^{i\\Phi_{\\text{used}}}\n$$\n这意味着指数必须在模 $2\\pi i$ 的意义下相等：\n$$\nik_\\parallel L = i\\Phi_{\\text{used}} + i2\\pi n, \\quad \\text{对于} \\quad n \\in \\mathbb{Z}\n$$\n这就将允许的平行波数进行了量化：\n$$\nk_{\\parallel, n} = \\frac{\\Phi_{\\text{used}} + 2\\pi n}{L}\n$$\n指数 $n$ 是问题中指定的整数模数。对于 $f(s)$ 和 $k_{\\parallel, n}$ 的这种选择，关于导数的第二个边界条件也得到满足。\n\n现在我们可以确定增长率 $\\lambda$。将 $f(s) = e^{ik_{\\parallel,n}s}$ 代回 ODE $f'' + k^2 f = 0$，我们发现：\n$$\n\\frac{d^2}{ds^2} (e^{ik_{\\parallel,n}s}) = (ik_{\\parallel,n})^2 e^{ik_{\\parallel,n}s} = -k_{\\parallel,n}^2 f(s)\n$$\n将其与 $f'' = -k^2 f$ 比较，我们确定 $k^2 = k_{\\parallel,n}^2$。使用我们对 $k^2$ 的定义：\n$$\n\\frac{\\gamma_d - \\lambda_n}{\\nu} = k_{\\parallel,n}^2\n$$\n解出 $\\lambda_n$，我们将其等同于增长率 $\\Gamma_n$，便找到了我们要求的第一个量。\n\n**1. 模式增长率 ($\\Gamma$)**\n模指数为 $n$ 的模式的增长率是几何误差 $\\varepsilon$ 的函数：\n$$\n\\Gamma_n(\\varepsilon) = \\lambda_n = \\gamma_d - \\nu k_{\\parallel, n}^2\n$$\n代入 $k_{\\parallel, n}$ 和 $\\Phi_{\\text{used}} = \\Phi_{\\text{true}} + \\varepsilon$ 的表达式：\n$$\n\\Gamma_n(\\varepsilon) = \\gamma_d - \\nu \\left( \\frac{\\Phi_{\\text{true}} + \\varepsilon + 2\\pi n}{L} \\right)^2\n$$\n\n**2. 对几何误差的灵敏度 ($S$)**\n灵敏度 $S_n$ 是增长率关于误差 $\\varepsilon$ 的导数：\n$$\nS_n = \\frac{d\\Gamma_n}{d\\varepsilon} = \\frac{d}{d\\varepsilon} \\left[ \\gamma_d - \\nu \\left( \\frac{\\Phi_{\\text{true}} + \\varepsilon + 2\\pi n}{L} \\right)^2 \\right]\n$$\n应用链式法则：\n$$\nS_n = 0 - \\frac{\\nu}{L^2} \\cdot 2 (\\Phi_{\\text{true}} + \\varepsilon + 2\\pi n) \\cdot \\frac{d}{d\\varepsilon}(\\Phi_{\\text{true}} + \\varepsilon + 2\\pi n)\n$$\n$$\nS_n = -\\frac{2\\nu}{L^2} (\\Phi_{\\text{true}} + \\varepsilon + 2\\pi n)\n$$\n这也可以使用波数 $k_{\\parallel, n}$ 简洁地表示：\n$$\nS_n = -\\frac{2\\nu}{L} k_{\\parallel, n}\n$$\n\n**3. 边界相位不一致性幅值 ($P$)**\n这个量定义为在 $s=0$ 处单位振幅下的复相位失配的幅值。模型使用的边界相位因子是 $e^{i\\Phi_{\\text{used}}}$，而真实的物理连接对应于 $e^{i\\Phi_{\\text{true}}}$。失配是这两个复相量之间的差。\n$$\n\\text{失配} = e^{i\\Phi_{\\text{used}}} - e^{i\\Phi_{\\text{true}}}\n$$\n所求的幅值 $P$ 是：\n$$\nP = \\left| e^{i\\Phi_{\\text{used}}} - e^{i\\Phi_{\\text{true}}} \\right|\n$$\n代入 $\\Phi_{\\text{used}} = \\Phi_{\\text{true}} + \\varepsilon$：\n$$\nP = \\left| e^{i(\\Phi_{\\text{true}} + \\varepsilon)} - e^{i\\Phi_{\\text{true}}} \\right| = \\left| e^{i\\Phi_{\\text{true}}} (e^{i\\varepsilon} - 1) \\right|\n$$\n由于 $|e^{i\\Phi_{\\text{true}}}| = 1$，这可以简化为：\n$$\nP = \\left| e^{i\\varepsilon} - 1 \\right|\n$$\n我们可以使用欧拉公式 $e^{i\\varepsilon} = \\cos(\\varepsilon) + i\\sin(\\varepsilon)$ 来计算这个幅值：\n$$\nP = \\left| (\\cos(\\varepsilon) - 1) + i\\sin(\\varepsilon) \\right|\n$$\n$$\nP^2 = (\\cos(\\varepsilon) - 1)^2 + \\sin^2(\\varepsilon) = \\cos^2(\\varepsilon) - 2\\cos(\\varepsilon) + 1 + \\sin^2(\\varepsilon)\n$$\n使用恒等式 $\\cos^2(\\varepsilon) + \\sin^2(\\varepsilon) = 1$：\n$$\nP^2 = 1 - 2\\cos(\\varepsilon) + 1 = 2(1 - \\cos(\\varepsilon))\n$$\n最后，使用半角恒等式 $1 - \\cos(\\varepsilon) = 2\\sin^2(\\varepsilon/2)$：\n$$\nP^2 = 4\\sin^2(\\frac{\\varepsilon}{2})\n$$\n取平方根即可得到幅值：\n$$\nP = \\left| 2\\sin(\\frac{\\varepsilon}{2}) \\right|\n$$\n这三个推导出的表达式构成了将要实现的算法的基础。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the mode growth rate, sensitivity to geometry error,\n    and boundary phase inconsistency for a set of test cases.\n    \"\"\"\n\n    def calculate_outputs(L, gamma_d, nu, phi_true, epsilon, n):\n        \"\"\"\n        Calculates the three required quantities for a single parameter set.\n        \n        Args:\n            L (float): Length of the parallel domain.\n            gamma_d (float): Constant drive parameter.\n            nu (float): Constant parallel diffusion coefficient.\n            phi_true (float): True boundary mapping phase in radians.\n            epsilon (float): Geometry error in radians.\n            n (int): Integer mode number.\n            \n        Returns:\n            list: A list containing the growth rate, sensitivity, and inconsistency magnitude.\n        \"\"\"\n        # The phase used in the boundary condition, including the error\n        phi_used = phi_true + epsilon\n\n        # 1. Mode Growth Rate (Gamma)\n        # The parallel wavenumber k_parallel is determined by the boundary condition\n        k_parallel_n = (phi_used + 2.0 * np.pi * n) / L\n        # The growth rate is derived from the dispersion relation of the PDE\n        growth_rate = gamma_d - nu * (k_parallel_n ** 2)\n\n        # 2. Sensitivity (S)\n        # The sensitivity is the derivative of the growth rate with respect to epsilon\n        sensitivity = -2.0 * nu / (L**2) * (phi_used + 2.0 * np.pi * n)\n\n        # 3. Boundary Phase Inconsistency Magnitude (P)\n        # This is the magnitude of the difference between the true and used phase factors\n        # P = |exp(i*phi_used) - exp(i*phi_true)| = |exp(i*epsilon) - 1|\n        inconsistency = np.abs(2.0 * np.sin(epsilon / 2.0))\n\n        return [growth_rate, sensitivity, inconsistency]\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (L, gamma_d, nu, Phi_true, epsilon, n)\n        (10.0, 0.3, 0.05, 0.8, 0.05, 1),\n        (12.0, 0.25, 0.08, 1.2, 0.0, 0),\n        (8.0, 0.5, 0.03, 2.6, -0.02, 5),\n        (2.0, 0.15, 0.1, 0.5, 0.1, 1),\n        (10.0, 0.4, 0.05, 1.0, np.pi, 0),\n    ]\n\n    all_results = []\n    for case in test_cases:\n        params = case\n        result_triple = calculate_outputs(*params)\n        all_results.append(result_triple)\n\n    # Format the final output string exactly as specified:\n    # [[g1,s1,p1],[g2,s2,p2],...] with no spaces.\n    outer_list_str = []\n    for res_triple in all_results:\n        inner_list_str = f\"[{res_triple[0]},{res_triple[1]},{res_triple[2]}]\"\n        outer_list_str.append(inner_list_str)\n    \n    final_output_string = f\"[{','.join(outer_list_str)}]\"\n\n    # Final print statement in the exact required format.\n    print(final_output_string)\n\nsolve()\n```"
        },
        {
            "introduction": "最后，我们来处理数值模拟中最重要的一步：确保结果的正确性。收敛性研究是验证控制方程的数值解是否准确、且不依赖于所选离散化方案（如网格密度）的主要方法。本练习将提供一个亲身实践的机会，让你为一个关键的湍流理论方程编写数值求解器，并进行系统的收敛性分析——这是计算科学的基石。",
            "id": "4208543",
            "problem": "考虑一个简化的三维仿星器几何中线性静电湍流的一维场线模型。平行坐标用 $z$ 表示，定义在一个周期性区间 $z \\in [-\\pi,\\pi)$ 上，角度单位为弧度。沿选定场线的磁场强度为 $B(z)$，它可能表现出多个捕获阱和尖锐特征。从漂移动理学描述出发，在流体闭合和线性化条件下，平行镜像力 $- \\mu \\nabla_{\\parallel} B$ 和平行流 $\\mathrm{d}v_{\\parallel}/\\mathrm{d}t$ 导出一个关于静电势本征函数 $ \\phi(z) $ 的有效自伴随气球模类型方程，其形式为\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d} z} \\left( A(z) \\frac{\\mathrm{d}\\phi}{\\mathrm{d} z} \\right) + Q(z)\\,\\phi(z) \\;=\\; \\lambda\\,\\phi(z),\n$$\n其中 $A(z)$ 代表由几何引起的平行刚度，$Q(z)$ 捕捉了曲率和捕获驱动效应。量 $\\lambda$ 是一个本征值，它参数化了稳定化的平行动力学和非稳定化的曲率/捕获驱动之间的平衡。在该模型中，我们考虑以下选择，这些选择受到 Boozer 类坐标中标准气球模表示的启发：\n- $A(z) = 1/B(z)$,\n- $Q(z) = - C \\,\\frac{B_{\\max} - B(z)}{B_0}$,\n其中 $B_{\\max} = \\max_{z} B(z)$，$B_0$ 是一个参考磁场强度，在归一化单位中取为常数 $B_0 = 1$。在 $B(z)$ 具有捕获阱的区域，负的 $Q(z)$ 会产生非稳定化的贡献。相应的线性增长率 $\\gamma$ 由最不稳定的本征值 $\\lambda_{\\min}$（自伴算子的最小本征值）定义为\n$$\n\\gamma \\;=\\; \\sqrt{\\max\\{-\\lambda_{\\min},\\,0\\}},\n$$\n采用无量纲归一化单位。\n\n你的任务是，通过增加用于离散化周期性区域的分辨率 $N$ 来实现平行坐标 $z$ 的收敛性研究，并量化解析 $B(z)$ 中的捕获阱和尖锐特征如何影响线性增长率 $\\gamma$ 和模结构 $\\phi(z)$。使用保守的有限体积类离散化方法来处理算子 $\\frac{\\mathrm{d}}{\\mathrm{d} z} \\left( A(z) \\frac{\\mathrm{d}\\phi}{\\mathrm{d} z} \\right)$，并施加周期性边界条件：\n- 设网格为均匀的，有 $N$ 个点，间距为 $\\Delta z = 2\\pi/N$，节点为 $z_j = -\\pi + j\\,\\Delta z$，其中 $j=0,\\dots,N-1$。\n- 定义 $A_{j+\\frac{1}{2}} = \\frac{1}{2}\\left(A_j + A_{j+1}\\right)$（周期性环绕），并离散化\n$$\n\\left[\\frac{\\mathrm{d}}{\\mathrm{d} z} \\left( A(z) \\frac{\\mathrm{d}\\phi}{\\mathrm{d} z} \\right)\\right]_j \\;\\approx\\; \\frac{1}{\\Delta z} \\left( \\frac{A_{j+\\frac{1}{2}}\\,(\\phi_{j+1}-\\phi_j)}{\\Delta z} - \\frac{A_{j-\\frac{1}{2}}\\,(\\phi_j-\\phi_{j-1})}{\\Delta z} \\right),\n$$\n这样当组装成具有周期性边界条件的矩阵时，离散算子是对称的，并加上逐点的 $Q_j\\,\\phi_j$ 贡献。\n- 求解离散本征值问题以获得 $\\lambda_{\\min}$ 及其归一化本征矢量 $\\phi(z)$，内积对应于权重为 $\\Delta z$ 的 $L^2$ 范数。\n\n对以下三种磁场剖面 $B(z)$ 进行研究，每种剖面都旨在测试不同的分辨率要求：\n1. 光滑单阱情况（理想情况）：\n   - $B(z) = B_0\\,\\left(1 + \\epsilon \\cos z\\right)$，其中 $B_0 = 1$, $\\epsilon = 0.30$。\n2. 具有中等锐度的多阱情况：\n   - $B(z) = B_0\\,\\left(1 + \\epsilon \\cos z + \\epsilon_2 \\cos(3 z)\\right)$，其中 $B_0 = 1$, $\\epsilon = 0.30$, $\\epsilon_2 = 0.15$。\n3. 高次谐波尖锐特征情况（边缘情况）：\n   - $B(z) = B_0\\,\\left(1 + \\epsilon \\cos(10 z)\\right)$，其中 $B_0 = 1$, $\\epsilon = 0.20$。\n\n在所有情况下，使用固定的驱动参数 $C = 1.0$。对于每种情况，在三种分辨率 $N \\in \\{64, 128, 256\\}$ 下，计算最不稳定的增长率 $\\gamma$ 和相应的归一化本征函数 $\\phi(z)$。为了量化模结构的收敛性，通过将较高分辨率的本征函数降采样到 $N=128$ 的网格上（由于 256 是 128 的整数倍，网格可以精确对齐），比较 $N=128$ 和 $N=256$ 时的本征函数，通过最大化相关性来对齐符号，并计算 $L^2$ 差值\n$$\n\\Delta_{\\phi} \\;=\\; \\left\\| \\phi^{(128)} - \\phi^{(256 \\to 128)} \\right\\|_2,\n$$\n其中 $\\phi^{(128)}$ 和降采样后的 $\\phi^{(256 \\to 128)}$ 都在权重为 $\\Delta z$ 的离散内积下归一化为单位 $L^2$ 范数。\n\n对于每种磁场情况，你的程序应输出两个浮点数：\n- 最高分辨率下的收敛增长率，即 $N=256$ 时的 $\\gamma$（无量纲）。\n- $N=128$ 和 $N=256$ 之间的模结构差异 $\\Delta_{\\phi}$（无量纲）。\n\n将所有三种情况的结果汇总到单行输出中，形式为方括号内包含的逗号分隔列表，顺序如下\n$$\n[\\gamma_1,\\,\\Delta_{\\phi,1},\\,\\gamma_2,\\,\\Delta_{\\phi,2},\\,\\gamma_3,\\,\\Delta_{\\phi,3}],\n$$\n其中下标表示情况编号。最终输出必须是严格符合此格式的单行。\n\n测试套件：\n- 情况 1：$B(z) = 1 + 0.30 \\cos z$, $C=1.0$, $N=64,128,256$。\n- 情况 2：$B(z) = 1 + 0.30 \\cos z + 0.15 \\cos(3 z)$, $C=1.0$, $N=64,128,256$。\n- 情况 3：$B(z) = 1 + 0.20 \\cos(10 z)$, $C=1.0$, $N=64,128,256$。\n\n所有量均视为归一化单位下的无量纲量。角度以弧度为单位。最终输出为浮点数。你的程序必须生成单行输出，其中包含按上述顺序排列的、由方括号括起来的逗号分隔列表形式的结果。",
            "solution": "该问题要求对一个一维、自伴随的二阶常微分方程进行数值研究，该方程模拟了仿星器几何中的静电湍流。该方程属于 Sturm-Liouville 类型：\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d} z} \\left( A(z) \\frac{\\mathrm{d}\\phi}{\\mathrm{d} z} \\right) + Q(z)\\,\\phi(z) = \\lambda\\,\\phi(z)\n$$\n定义在周期性区间 $z \\in [-\\pi, \\pi)$ 上。本征函数 $\\phi(z)$ 代表静电势，本征值 $\\lambda$ 与系统的稳定性有关。目标是找到最小本征值 $\\lambda_{\\min}$，并用它来计算线性增长率 $\\gamma = \\sqrt{\\max\\{-\\lambda_{\\min}, 0\\}}$。此分析针对不同的磁场剖面 $B(z)$ 和数值分辨率 $N$ 进行。\n\n第一步是在均匀网格上离散化微分算子。将区间 $[-\\pi, \\pi)$ 分为 $N$ 个长度为 $\\Delta z = 2\\pi/N$ 的子区间。网格点为 $z_j = -\\pi + j\\Delta z$，其中 $j=0, \\dots, N-1$。本征函数 $\\phi(z)$ 由其在这些网格点上的值组成的向量表示，即 $\\vec{\\phi} = (\\phi_0, \\phi_1, \\dots, \\phi_{N-1})^T$。\n\n我们采用指定的保守有限体积离散化方法。网格点 $z_j$ 处的二阶导数项通过考虑中点 $z_{j \\pm 1/2}$ 处的通量来近似：\n$$\n\\left[\\frac{\\mathrm{d}}{\\mathrm{d} z} \\left( A(z) \\frac{\\mathrm{d}\\phi}{\\mathrm{d} z} \\right)\\right]_j \\approx \\frac{1}{\\Delta z} \\left( F_{j+1/2} - F_{j-1/2} \\right)\n$$\n其中通量 $F_{j+1/2}$ 由下式给出\n$$\nF_{j+1/2} = A(z_{j+1/2}) \\frac{\\phi_{j+1} - \\phi_j}{\\Delta z}\n$$\n中点 $z_{j+1/2}$ 处的系数 $A(z)$ 通过其在相邻网格点上值的算术平均值来近似：$A_{j+1/2} = \\frac{1}{2}(A_j + A_{j+1})$。这导出了算子的离散形式：\n$$\n\\frac{1}{\\Delta z^2} \\left( A_{j+1/2}(\\phi_{j+1} - \\phi_j) - A_{j-1/2}(\\phi_j - \\phi_{j-1}) \\right) + Q_j\\phi_j = \\lambda\\phi_j\n$$\n这个由 $N$ 个线性方程组成的系统可以写成矩阵本征值问题 $M\\vec{\\phi} = \\lambda\\vec{\\phi}$。矩阵 $M$ 是一个 $N \\times N$ 的矩阵。通过重新排列各项，我们可以确定 $M$ 的元素。对于第 $j$ 行，我们有：\n$$\n\\frac{A_{j-1/2}}{\\Delta z^2}\\phi_{j-1} - \\frac{A_{j+1/2} + A_{j-1/2}}{\\Delta z^2}\\phi_j + \\frac{A_{j+1/2}}{\\Delta z^2}\\phi_{j+1} + Q_j\\phi_j = \\lambda\\phi_j\n$$\n这就将矩阵 $M$ 定义为一个三对角矩阵，带有额外的角点元素以强制施加周期性边界条件（$\\phi_{-1} = \\phi_{N-1}$ 和 $\\phi_N = \\phi_0$）。矩阵元素为：\n- 对角元素：$M_{j,j} = -\\frac{1}{\\Delta z^2} \\left(A_{j+1/2} + A_{j-1/2}\\right) + Q_j$\n- 非对角元素：$M_{j,j+1} = \\frac{1}{\\Delta z^2} A_{j+1/2}$ 和 $M_{j,j-1} = \\frac{1}{\\Delta z^2} A_{j-1/2}$。\n索引按模 $N$ 计算。由于 $A_{j,j+1} = M_{j,j+1}$ 且 $M_{j+1,j} = \\frac{1}{\\Delta z^2} A_{j+1-1/2} = \\frac{1}{\\Delta z^2} A_{j+1/2}$，矩阵 $M$ 是对称的。\n\n因此，问题被简化为求解一个实对称矩阵 $M$ 的本征值和本征矢量。这可以使用标准的数值库（如 `scipy.linalg.eigh`）高效而准确地求解。该例程返回所有实数本征值和一组完整的标准正交本征矢量。我们找出最小本征值 $\\lambda_{\\min}$ 及其对应的本征矢量 $\\vec{\\phi}_{\\text{raw}}$。然后，增长率计算为 $\\gamma = \\sqrt{\\max(0, -\\lambda_{\\min})}$。\n\n问题要求本征函数根据权重为 $\\Delta z$ 的离散 $L^2$ 范数进行归一化，使得 $\\sum_{j=0}^{N-1} |\\phi_j|^2 \\Delta z = 1$。标准求解器返回的本征矢量通常被归一化为单位欧几里得范数，即 $\\sum_{j=0}^{N-1} |\\phi_{j, \\text{raw}}|^2 = 1$。为了获得正确归一化的本征函数，我们必须对原始本征矢量进行重新缩放：\n$$\n\\phi_j = \\frac{\\phi_{j, \\text{raw}}}{\\sqrt{\\Delta z}}\n$$\n\n对于收敛性研究，我们比较分辨率 $N=128$ 时的本征函数（表示为 $\\phi^{(128)}$）与 $N=256$ 时的本征函数（表示为 $\\phi^{(256)}$）。为了在相同的网格上进行比较，我们将较高分辨率的本征函数通过每隔一个点取一个点的方式进行降采样，从而得到一个在 $N=128$ 网格上的向量：$\\psi_j = \\phi^{(256)}_{2j}$。这个降采样后的向量 $\\vec{\\psi}$ 必须在 $N=128$ 网格上重新归一化，使其具有单位 $L^2$ 范数。一个重要的细节是，本征矢量的符号是任意的。为了确保有意义的比较，我们通过确保它们的离散内积为正，来将降采样向量的符号与 $\\phi^{(128)}$ 对齐。如果 $\\sum_{j=0}^{127} \\phi^{(128)}_j \\psi_j \\Delta z^{(128)}  0$，我们就翻转 $\\vec{\\psi}$ 的符号。最后，差值 $\\Delta_{\\phi}$ 计算为对齐后的向量之差的 $L^2$ 范数：\n$$\n\\Delta_{\\phi} = \\sqrt{\\sum_{j=0}^{127} \\left(\\phi^{(128)}_j - \\psi_{\\text{aligned},j}\\right)^2 \\Delta z^{(128)}}\n$$\n\n该过程针对三种不同的磁场剖面 $B(z)$ 和一个固定的驱动参数 $C=1.0$ 来实现。对于每种情况，我们计算最高分辨率（$N=256$）下的增长率 $\\gamma$ 以及 $N=128$ 和 $N=256$ 结果之间的本征函数差异 $\\Delta_{\\phi}$。系数 $A(z) = 1/B(z)$ 和 $Q(z) = -C(B_{\\max} - B(z))/B_0$ 是使用 $B_{\\max} = \\max_z B(z)$ 的精确解析值计算的，以提高准确性。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import eigh\n\ndef solve():\n    \"\"\"\n    Main function to perform the convergence study for the given stellarator\n    turbulence model. It iterates through three magnetic field cases, computes\n    growth rates and eigenfunctions at different resolutions, and quantifies\n    the convergence of the mode structure.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"B_func\": lambda z: 1.0 + 0.30 * np.cos(z),\n            \"B_max\": 1.30,\n            \"C\": 1.0,\n            \"B0\": 1.0,\n        },\n        {\n            \"B_func\": lambda z: 1.0 + 0.30 * np.cos(z) + 0.15 * np.cos(3 * z),\n            \"B_max\": 1.45,\n            \"C\": 1.0,\n            \"B0\": 1.0,\n        },\n        {\n            \"B_func\": lambda z: 1.0 + 0.20 * np.cos(10 * z),\n            \"B_max\": 1.20,\n            \"C\": 1.0,\n            \"B0\": 1.0,\n        },\n    ]\n\n    resolutions = [64, 128, 256]\n    aggregated_results = []\n\n    for case_params in test_cases:\n        # Store results for each resolution (gamma, phi, dz)\n        results_per_res = {}\n\n        for N in resolutions:\n            gamma, phi_norm, dz = compute_eigenmode(case_params, N)\n            results_per_res[N] = {\"gamma\": gamma, \"phi\": phi_norm, \"dz\": dz}\n\n        # 1. Converged growth rate at N=256\n        gamma_converged = results_per_res[256][\"gamma\"]\n\n        # 2. Mode structure difference Delta_phi between N=128 and N=256\n        phi_128 = results_per_res[128][\"phi\"]\n        dz_128 = results_per_res[128][\"dz\"]\n        \n        phi_256 = results_per_res[256][\"phi\"]\n\n        # Downsample phi_256 to the N=128 grid\n        phi_256_to_128 = phi_256[::2]\n\n        # Re-normalize the downsampled eigenfunction on the N=128 grid\n        norm_sq = np.sum(phi_256_to_128**2) * dz_128\n        phi_256_to_128_norm = phi_256_to_128 / np.sqrt(norm_sq)\n\n        # Align sign by ensuring the dot product is positive\n        # The L2 inner product is sum(v1*v2*dz). Since dz is a positive\n        # constant, the sign is determined by sum(v1*v2).\n        dot_product = np.sum(phi_128 * phi_256_to_128_norm)\n        if dot_product  0:\n            phi_256_to_128_norm *= -1\n\n        # Calculate the L2 difference norm\n        diff_vector = phi_128 - phi_256_to_128_norm\n        delta_phi_sq = np.sum(diff_vector**2) * dz_128\n        delta_phi = np.sqrt(delta_phi_sq)\n\n        aggregated_results.extend([gamma_converged, delta_phi])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, aggregated_results))}]\")\n\n\ndef compute_eigenmode(params, N):\n    \"\"\"\n    Computes the minimum eigenvalue, growth rate, and normalized eigenfunction\n    for a given set of parameters and grid resolution.\n\n    Args:\n        params (dict): A dictionary containing B_func, B_max, C, and B0.\n        N (int): The number of grid points for the discretization.\n\n    Returns:\n        tuple: (gamma, phi_normalized, dz)\n            - gamma (float): The calculated growth rate.\n            - phi_normalized (np.ndarray): The eigenfunction normalized to unit L2 norm.\n            - dz (float): The grid spacing.\n    \"\"\"\n    # 1. Set up the grid\n    dz = 2.0 * np.pi / N\n    # Grid is z_j = -pi + j*dz, for j=0..N-1\n    z = np.linspace(-np.pi, np.pi, N, endpoint=False)\n\n    # 2. Define coefficients A(z) and Q(z)\n    B = params[\"B_func\"](z)\n    A = 1.0 / B\n    Q = -params[\"C\"] * (params[\"B_max\"] - B) / params[\"B0\"]\n\n    # 3. Construct the discretized operator matrix M\n    # A at staggered grid points, A_{j+1/2}\n    A_plus_half = 0.5 * (A + np.roll(A, -1))\n    A_minus_half = np.roll(A_plus_half, 1)\n\n    inv_dz_sq = 1.0 / (dz**2)\n    \n    # Diagonal and off-diagonal elements\n    diag = -(A_plus_half + A_minus_half) * inv_dz_sq + Q\n    upper_diag = A_plus_half * inv_dz_sq\n    lower_diag = A_minus_half * inv_dz_sq\n\n    # Assemble the full matrix M with periodic boundary conditions\n    M = np.diag(diag) + np.diag(upper_diag[:-1], k=1) + np.diag(lower_diag[1:], k=-1)\n    M[0, N - 1] = lower_diag[0]\n    M[N - 1, 0] = upper_diag[N - 1]\n\n    # 4. Solve the eigenvalue problem M*phi = lambda*phi\n    # eigh is used for symmetric matrices; it is faster and more stable.\n    eigenvalues, eigenvectors = eigh(M)\n\n    # 5. Extract results for the most unstable mode (minimum eigenvalue)\n    min_eigenvalue_index = np.argmin(eigenvalues)\n    lambda_min = eigenvalues[min_eigenvalue_index]\n    phi_raw = eigenvectors[:, min_eigenvalue_index]\n\n    # 6. Calculate the growth rate\n    gamma = np.sqrt(max(-lambda_min, 0.0))\n\n    # 7. Normalize the eigenfunction: integral |phi|^2 dz = 1\n    # eigh returns eigenvectors with sum |phi_raw|^2 = 1.\n    # We need sum |phi|^2 * dz = 1, so phi = phi_raw / sqrt(dz).\n    phi_normalized = phi_raw / np.sqrt(dz)\n\n    return gamma, phi_normalized, dz\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}