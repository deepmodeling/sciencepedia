{
    "hands_on_practices": [
        {
            "introduction": "Magnetic shear is a cornerstone concept in magnetically confined plasmas, but its direct physical consequence can feel abstract. This practice provides a tangible link between the dimensionless shear parameter, $\\hat{s}$, and a fundamental geometric property of the simulation domain: the parallel connection length, $L_\\parallel$. By deriving the relationship between these quantities, you will develop a clear intuition for how shear causes adjacent magnetic field lines to diverge, which is the very reason simple periodic boundary conditions are insufficient for realistic flux-tube simulations .",
            "id": "4198293",
            "problem": "Consider a large-aspect-ratio, circular-cross-section tokamak with major radius $R$, minor radius coordinate $r$, poloidal angle $\\theta$, and toroidal angle $\\varphi$. A local flux-tube Gyrokinetic (GK) domain is constructed at fixed $r$, subject to periodic and twist-and-shift boundary conditions along a magnetic field line that is followed for $N_{\\text{pol}}$ poloidal turns. The equilibrium safety factor is $q(r)=q_0+\\alpha r$, with constants $q_0>0$ and $\\alpha$. Assume the standard, widely used large-aspect-ratio field-line relation $d\\varphi/d\\theta=q(r)$ along the flux surface, and the Euclidean metric approximation on the torus surface so that the line element restricted to a single flux surface is $dl^2=(r\\,d\\theta)^2+(R\\,d\\varphi)^2$. In this setting:\n\n- Use the fundamental definition of magnetic shear $\\hat{s}$ as the dimensionless measure of the radial variation of the safety factor along a family of concentric circular flux surfaces.\n- Derive the parallel connection length $L_\\parallel$ as the geometric arc length along the field line required to traverse $N_{\\text{pol}}$ poloidal turns, starting from $dl$ and the field-line relation above, and assuming $q(r)$ does not vary along $\\theta$ at fixed $r$.\n- To connect the role of magnetic shear to twist-and-shift boundary conditions, quantify the sensitivity of $L_\\parallel$ to the minor radius by computing the dimensionless derivative $\\partial\\ln L_\\parallel/\\partial\\ln r$ and then provide its leading-order approximation in the limit $R\\,q(r)\\gg r$.\n\nProvide your final answer as a single closed-form analytic row matrix containing, in order, the expression for $\\hat{s}(r)$, the expression for $L_\\parallel(N_{\\text{pol}},r)$, and the leading-order approximation for $\\partial\\ln L_\\parallel/\\partial\\ln r$ in the limit $R\\,q(r)\\gg r$. No numerical values are to be substituted.",
            "solution": "The problem statement is first validated against the required criteria.\n\n### Step 1: Extract Givens\n- **System:** Large-aspect-ratio, circular-cross-section tokamak.\n- **Coordinates:** Major radius $R$, minor radius coordinate $r$, poloidal angle $\\theta$, and toroidal angle $\\varphi$.\n- **Domain:** Local flux-tube Gyrokinetic (GK) domain at fixed $r$.\n- **Boundary Conditions:** Periodic and twist-and-shift along a magnetic field line followed for $N_{\\text{pol}}$ poloidal turns.\n- **Equilibrium Safety Factor:** $q(r)=q_0+\\alpha r$, with constants $q_0>0$ and $\\alpha$.\n- **Field-Line Relation:** $d\\varphi/d\\theta=q(r)$ along a flux surface.\n- **Metric Element:** $dl^2=(r\\,d\\theta)^2+(R\\,d\\varphi)^2$ on a single flux surface.\n- **Assumption:** $q(r)$ does not vary along $\\theta$ at fixed $r$.\n- **Tasks:**\n  1. Derive the magnetic shear $\\hat{s}(r)$.\n  2. Derive the parallel connection length $L_\\parallel(N_{\\text{pol}}, r)$.\n  3. Compute the dimensionless derivative $\\partial\\ln L_\\parallel/\\partial\\ln r$ and provide its leading-order approximation in the limit $R\\,q(r)\\gg r$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, situated within the standard theoretical framework of fusion plasma physics, specifically the description of magnetic geometry in a large-aspect-ratio tokamak. The concepts used, such as safety factor $q$, magnetic shear $\\hat{s}$, and the field-line-following equation, are fundamental to this field. The provided metric is a standard Euclidean approximation for a toroidal surface. The problem is well-posed, providing all necessary definitions and constraints to derive the requested quantities uniquely. The language is objective and precise. The assumptions, such as the form of $q(r)$ and the large-aspect-ratio limit, are common and physically relevant simplifications used in theoretical modeling and simulation. The problem is complete, consistent, and does not violate any physical or mathematical principles.\n\n### Step 3: Verdict and Action\nThe problem is deemed **valid**. A solution will be derived.\n\n### Derivation\n\nThe solution proceeds in three parts as requested by the problem statement.\n\n**Part 1: Derivation of Magnetic Shear $\\hat{s}(r)$**\n\nThe magnetic shear, $\\hat{s}$, is defined as the dimensionless logarithmic derivative of the safety factor $q$ with respect to the minor radius $r$. The definition is:\n$$\n\\hat{s}(r) = \\frac{r}{q(r)} \\frac{dq(r)}{dr}\n$$\nThe safety factor is given as a linear function of $r$:\n$$\nq(r) = q_0 + \\alpha r\n$$\nFirst, we compute the derivative of $q(r)$ with respect to $r$:\n$$\n\\frac{dq(r)}{dr} = \\frac{d}{dr}(q_0 + \\alpha r) = \\alpha\n$$\nSubstituting this derivative and the expression for $q(r)$ back into the definition of $\\hat{s}(r)$, we obtain:\n$$\n\\hat{s}(r) = \\frac{r}{q_0 + \\alpha r} (\\alpha) = \\frac{\\alpha r}{q_0 + \\alpha r}\n$$\nThis is the expression for the magnetic shear as a function of the minor radius $r$.\n\n**Part 2: Derivation of Parallel Connection Length $L_\\parallel(N_{\\text{pol}}, r)$**\n\nThe parallel connection length $L_\\parallel$ is the geometric arc length along a magnetic field line. The differential arc length $dl$ on a flux surface is given by the line element:\n$$\ndl^2 = (r\\,d\\theta)^2 + (R\\,d\\varphi)^2\n$$\nTo find the arc length along a field line, we must relate $d\\varphi$ and $d\\theta$. The problem provides the standard field-line relation on a flux surface:\n$$\n\\frac{d\\varphi}{d\\theta} = q(r)\n$$\nwhich can be written as $d\\varphi = q(r) d\\theta$. Substituting this into the expression for $dl^2$:\n$$\ndl^2 = (r\\,d\\theta)^2 + (R\\,q(r)\\,d\\theta)^2 = [r^2 + (R\\,q(r))^2] (d\\theta)^2\n$$\nTaking the square root gives the differential arc length along the field line:\n$$\ndl = \\sqrt{r^2 + R^2 q(r)^2} \\, d\\theta\n$$\nThe total connection length $L_\\parallel$ is found by integrating $dl$ along the field line for a total of $N_{\\text{pol}}$ poloidal turns. One poloidal turn corresponds to a change in $\\theta$ of $2\\pi$. Thus, $N_{\\text{pol}}$ turns corresponds to an integration range for $\\theta$ from $0$ to $2\\pi N_{\\text{pol}}$.\n$$\nL_\\parallel = \\int_{0}^{2\\pi N_{\\text{pol}}} \\sqrt{r^2 + R^2 q(r)^2} \\, d\\theta\n$$\nSince the integration is performed at a fixed minor radius $r$, and $q(r)$ is assumed to be independent of $\\theta$, the entire integrand is constant with respect to the integration variable $\\theta$. Therefore, the integral is simply the integrand multiplied by the length of the integration interval:\n$$\nL_\\parallel(N_{\\text{pol}}, r) = \\sqrt{r^2 + R^2 q(r)^2} \\int_{0}^{2\\pi N_{\\text{pol}}} d\\theta = 2\\pi N_{\\text{pol}} \\sqrt{r^2 + R^2 q(r)^2}\n$$\nSubstituting the given expression for $q(r)$:\n$$\nL_\\parallel(N_{\\text{pol}}, r) = 2\\pi N_{\\text{pol}} \\sqrt{r^2 + R^2 (q_0 + \\alpha r)^2}\n$$\n\n**Part 3: Derivation of $\\partial\\ln L_\\parallel/\\partial\\ln r$ and its leading-order approximation**\n\nThe third task is to compute the dimensionless derivative $\\partial\\ln L_\\parallel/\\partial\\ln r$. This quantity measures the sensitivity of the connection length to a small relative change in the minor radius. Using the chain rule, this derivative can be expressed as:\n$$\n\\frac{\\partial\\ln L_\\parallel}{\\partial\\ln r} = r \\frac{\\partial(\\ln L_\\parallel)}{\\partial r}\n$$\nFirst, we find $\\ln L_\\parallel$ from the result of Part 2:\n$$\n\\ln L_\\parallel = \\ln(2\\pi N_{\\text{pol}}) + \\ln\\left(\\sqrt{r^2 + R^2 q(r)^2}\\right) = \\ln(2\\pi N_{\\text{pol}}) + \\frac{1}{2} \\ln(r^2 + R^2 q(r)^2)\n$$\nNow, we differentiate with respect to $r$:\n$$\n\\frac{\\partial(\\ln L_\\parallel)}{\\partial r} = 0 + \\frac{1}{2} \\frac{1}{r^2 + R^2 q(r)^2} \\frac{\\partial}{\\partial r} [r^2 + R^2 q(r)^2]\n$$\n$$\n\\frac{\\partial(\\ln L_\\parallel)}{\\partial r} = \\frac{1}{2(r^2 + R^2 q(r)^2)} \\left[2r + R^2 \\cdot 2q(r) \\frac{dq(r)}{dr}\\right] = \\frac{r + R^2 q(r) \\frac{dq(r)}{dr}}{r^2 + R^2 q(r)^2}\n$$\nMultiplying by $r$ gives the desired dimensionless derivative:\n$$\n\\frac{\\partial\\ln L_\\parallel}{\\partial\\ln r} = r \\frac{r + R^2 q(r) \\frac{dq(r)}{dr}}{r^2 + R^2 q(r)^2} = \\frac{r^2 + R^2 q(r) \\left(r \\frac{dq(r)}{dr}\\right)}{r^2 + R^2 q(r)^2}\n$$\nWe recognize the term $r \\frac{dq(r)}{dr}$ from the definition of magnetic shear: $\\hat{s}(r) = \\frac{r}{q(r)}\\frac{dq(r)}{dr}$, which implies $r \\frac{dq(r)}{dr} = q(r)\\hat{s}(r)$. Substituting this into our expression:\n$$\n\\frac{\\partial\\ln L_\\parallel}{\\partial\\ln r} = \\frac{r^2 + R^2 q(r) [q(r)\\hat{s}(r)]}{r^2 + R^2 q(r)^2} = \\frac{r^2 + R^2 q(r)^2 \\hat{s}(r)}{r^2 + R^2 q(r)^2}\n$$\nThe final step is to find the leading-order approximation of this expression in the limit $R\\,q(r) \\gg r$. This limit is equivalent to stating that $(R\\,q(r))^2 \\gg r^2$. To analyze the behavior, we can divide the numerator and denominator by $R^2 q(r)^2$:\n$$\n\\frac{\\partial\\ln L_\\parallel}{\\partial\\ln r} = \\frac{\\frac{r^2}{R^2 q(r)^2} + \\hat{s}(r)}{\\frac{r^2}{R^2 q(r)^2} + 1}\n$$\nIn the specified limit, the term $\\frac{r^2}{R^2 q(r)^2}$ approaches zero. Therefore, the leading-order approximation is:\n$$\n\\left.\\frac{\\partial\\ln L_\\parallel}{\\partial\\ln r}\\right|_{R\\,q \\gg r} \\approx \\frac{0 + \\hat{s}(r)}{0 + 1} = \\hat{s}(r)\n$$\nUsing the expression for $\\hat{s}(r)$ from Part 1, the leading-order approximation is:\n$$\n\\frac{\\alpha r}{q_0 + \\alpha r}\n$$\nThis result demonstrates that in the large-aspect-ratio limit, the radial sensitivity of the parallel connection length is directly given by the magnetic shear.\n\nThe final answer is a row matrix containing the three derived expressions in order.\n1. $\\hat{s}(r) = \\frac{\\alpha r}{q_0 + \\alpha r}$\n2. $L_\\parallel(N_{\\text{pol}}, r) = 2\\pi N_{\\text{pol}} \\sqrt{r^2 + R^2 (q_0 + \\alpha r)^2}$\n3. Leading-order approximation of $\\partial\\ln L_\\parallel/\\partial\\ln r = \\frac{\\alpha r}{q_0 + \\alpha r}$",
            "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{\\alpha r}{q_0 + \\alpha r} & 2\\pi N_{\\text{pol}} \\sqrt{r^2 + R^2 (q_0 + \\alpha r)^2} & \\frac{\\alpha r}{q_0 + \\alpha r} \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "Having established the geometric effect of magnetic shear, we now turn to its implementation in modern gyrokinetic codes, which typically operate in Fourier space. In the absence of shear ($\\hat{s}=0$), the field lines close on themselves and simple periodic boundary conditions suffice. However, for the realistic case of $\\hat{s} \\ne 0$, the 'twist' of the magnetic field must be translated into a rule for handling fluctuations at the parallel boundaries. This exercise guides you through the derivation of the crucial 'closure condition' for twist-and-shift boundaries, revealing how a continuous geometric property is mapped to a discrete shift in the radial wavenumber, $k_x$ .",
            "id": "4198300",
            "problem": "Consider a local field-aligned flux-tube model for gyrokinetic turbulence in fusion plasmas, with perpendicular coordinates $(x,y)$ and parallel coordinate $z$ along the magnetic field. The perpendicular plane is doubly periodic with domain sizes $L_x$ and $L_y$, so that any fluctuating scalar field $f(x,y,z)$ can be expanded at each $z$ as a Fourier series in $(x,y)$ using discrete wavenumbers $k_x = \\frac{2\\pi}{L_x} n_x$ and $k_y = \\frac{2\\pi}{L_y} n_y$ with integers $n_x$ and $n_y$. The parallel coordinate is periodic with extent $L_z$, and a twist-and-shift boundary condition is imposed to account for uniform magnetic shear $\\hat{s}$.\n\nAdopt the standard field-aligned binormal coordinate $\\alpha(y,z)$ defined by a linear shear mapping of the form $\\alpha(y,z) = y + \\hat{s}\\,z\\,x$, which relates the perpendicular coordinates to the field-line label in a sheared slab approximation. Assume the fluctuating phase of a Fourier component is constructed to be constant on surfaces of constant $\\alpha$ and $x$ at $z=0$, and use this to infer how the effective radial wavenumber evolves with $z$ under uniform magnetic shear.\n\nStarting only from: (i) the periodicity of $(x,y)$ implying a discrete Fourier grid with spacing $\\Delta k_x = \\frac{2\\pi}{L_x}$ for $k_x$, (ii) the definition of $\\alpha(y,z)$ above, and (iii) the requirement that after advancing by one parallel period $L_z$ the twist-and-shift remap must land exactly on the discrete $k_x$ grid, derive the closure condition that quantifies the necessary relationship among $\\hat{s}$, $k_y$, $L_z$, and $L_x$ in terms of an integer mode index remap. Then, express the integer remap count $m$ as a single closed-form analytic expression in terms of $\\hat{s}$, $k_y$, $L_z$, and $L_x$.\n\nYour final answer must be the expression for $m$ only, written without units. No numerical evaluation is required. If intermediate dimensional analysis is performed, ensure all quantities are used in a physically consistent manner appropriate for field-aligned, sheared-slab gyrokinetic modeling.",
            "solution": "The problem requires the derivation of the closure condition for a twist-and-shift boundary condition in a sheared slab magnetic geometry and to find an expression for the integer remap count $m$. The derivation will proceed by determining how the radial wavenumber evolves along the parallel coordinate and then applying the periodicity constraint.\n\nLet's begin by considering a single Fourier component of a fluctuating scalar field $f(x,y,z)$ at the reference plane $z=0$. Its spatial dependence is given by the phase factor $\\exp[i(k_x x + k_y y)]$, where $k_x$ and $k_y$ are the radial and binormal wavenumbers, respectively. We denote the initial radial wavenumber at $z=0$ as $k_x(0)$.\n\nThe problem introduces a field-aligned binormal coordinate $\\alpha(y,z) = y + \\hat{s} z x$ and states this serves as a field-line label. In a field-aligned coordinate system, magnetic field lines are represented by curves of constant coordinates. Therefore, for a fixed radial position $x=x_c$, a magnetic field line is a curve in the $(y,z)$-plane where $\\alpha$ is constant. Let this constant be $\\alpha_c$. From the definition of $\\alpha$, we have $y(z) + \\hat{s} z x_c = \\alpha_c$. This can be rewritten as $y(z) = \\alpha_c - \\hat{s} z x_c$. Differentiating this expression with respect to $z$ gives the slope of the field line projection:\n$$ \\frac{dy}{dz} = -\\hat{s} x_c $$\nThis equation describes the trajectory of magnetic field lines in this model.\n\nThe principle of a field-aligned representation is that turbulent structures are highly elongated along the magnetic field. Therefore, the phase of a mode at a point $(x,y,z)$ should be determined by its phase at the point $(x,y_0,0)$ at the $z=0$ plane that lies on the same field line. We can find the back-traced coordinate $y_0$ by integrating the field line equation from $z$ to $0$:\n$$ y(0) - y(z) = \\int_z^0 (-\\hat{s} x) dz' = (-\\hat{s} x)(-z) = \\hat{s} x z $$\nSo, the corresponding point at $z=0$ is $(x, y_0)$ with $y_0 = y(z) + \\hat{s} x z$.\n\nLet the phase of the Fourier mode at $z=0$ be $S_0(x,y) = k_x(0) x + k_y y$. Due to the field-aligned nature, the phase $S(x,y,z)$ of the mode at an arbitrary $z$ is given by evaluating $S_0$ at the back-traced coordinates:\n$$ S(x,y,z) = S_0(x, y_0) = S_0(x, y + \\hat{s} x z) = k_x(0) x + k_y (y + \\hat{s} x z) $$\nWe can re-group the terms to identify the effective wavenumbers at coordinate $z$:\n$$ S(x,y,z) = [k_x(0) + k_y \\hat{s} z]x + k_y y $$\nThis demonstrates how the binormal wavenumber $k_y$ remains constant, but the effective radial wavenumber $k_x^{\\text{eff}}$ evolves linearly with $z$:\n$$ k_x^{\\text{eff}}(z) = k_x(0) + k_y \\hat{s} z $$\nThis result follows from premise (ii), the definition of $\\alpha(y,z)$.\n\nNext, we apply the boundary conditions. The system is periodic in the parallel direction with period $L_z$. The twist-and-shift boundary condition, as stated in premise (iii), requires that the field structure at $z=L_z$ must be representable on the same discrete Fourier grid as the field at $z=0$. This implies that the evolved radial wavenumber $k_x^{\\text{eff}}(L_z)$ must coincide with one of the allowed discrete values for $k_x$.\n\nThe total shift in the radial wavenumber after one parallel period $L_z$ is:\n$$ \\Delta k_x = k_x^{\\text{eff}}(L_z) - k_x(0) = (k_x(0) + k_y \\hat{s} L_z) - k_x(0) = k_y \\hat{s} L_z $$\n\nAccording to premise (i), the periodicity of the domain in the $x$ direction with size $L_x$ defines a discrete grid for the radial wavenumber $k_x$. The spacing between adjacent points on this grid is $\\Delta k_x^{\\text{grid}} = \\frac{2\\pi}{L_x}$. For the evolved mode to land on a point on this grid, its total wavenumber shift, $\\Delta k_x$, must be an integer multiple of the grid spacing $\\Delta k_x^{\\text{grid}}$. We denote this integer as $m$, which is the \"integer remap count\".\n$$ \\Delta k_x = m \\cdot \\Delta k_x^{\\text{grid}} $$\nwhere $m$ must be an integer ($m \\in \\mathbb{Z}$).\n\nSubstituting the expressions for the wavenumber shift and the grid spacing gives the closure condition:\n$$ k_y \\hat{s} L_z = m \\frac{2\\pi}{L_x} $$\nThis equation establishes the required relationship among the magnetic shear $\\hat{s}$, the binormal wavenumber $k_y$, the parallel length $L_z$, and the radial length $L_x$.\n\nThe final step is to solve this equation for the integer remap count $m$. Rearranging the terms, we obtain the closed-form expression for $m$:\n$$ m = \\frac{k_y \\hat{s} L_z L_x}{2\\pi} $$\nThis expression quantifies the number of grid spacings the radial wavenumber $k_x$ is shifted by after one parallel transit, ensuring that the twist-and-shift boundary condition is satisfied. For this condition to hold, the parameters of the simulation must be chosen such that the right-hand side evaluates to an integer for the discrete values of $k_y$ used in the simulation.",
            "answer": "$$\n\\boxed{\\frac{k_y \\hat{s} L_z L_x}{2\\pi}}\n$$"
        },
        {
            "introduction": "Theory and implementation come together in this final practice, where you will develop a numerical benchmark to test the effectiveness of different boundary conditions. By calculating the mismatch error for both simple periodic and twist-and-shift conditions in different magnetic configurations, you will quantify the practical necessity of the latter. This exercise not only solidifies your understanding of the concepts but also introduces the important distinction between the constant shear of an idealized tokamak and the spatially varying shear of a non-axisymmetric stellarator .",
            "id": "4198292",
            "problem": "Consider a simplified linear flux-tube representation of an Ion Temperature Gradient (ITG) mode in a magnetized plasma. The perpendicular fluctuation is represented as a single Fourier component in the plane orthogonal to the magnetic field with perpendicular wavevector components $k_x$ and $k_y$. The parallel coordinate $z$ follows the magnetic field line and is an angle measured in radians. In the presence of magnetic shear, the radial wavenumber $k_x$ varies with $z$ due to the transformation of the perpendicular coordinates along the field line. The twist-and-shift boundary condition is designed to ensure continuity of the Fourier mode across the ends of the parallel domain $z \\in [0,L_z]$ by appropriately shifting $k_x$ at $z=L_z$ relative to $z=0$ by an amount that depends on the integrated geometric shear. In contrast, a naive periodic boundary condition applies zero shift in $k_x$.\n\nStarting from first principles, model the effect of magnetic shear by showing that the change in radial wavenumber across the parallel domain, denoted $\\Delta k_x$, is determined by the integral of a local shear function $s(z)$ weighted by $k_y$. Precisely, derive $\\Delta k_x$ in terms of $k_y$, $s(z)$, and $L_z$. For an axisymmetric tokamak, take the local shear to be constant $s(z)=\\hat{s}$, where $\\hat{s}$ is the magnetic shear parameter. For a non-axisymmetric stellarator, take the local shear to be a simple but nontrivial function of the parallel angle,\n$$\ns(z) = s_0 + s_1 \\cos(z) + s_2 \\sin(2z),\n$$\nwhere $s_0$, $s_1$, and $s_2$ are constants determined by the geometry. All angles are measured in radians.\n\nYou must implement an algorithm to quantify the discrete-grid mismatch induced by applying either:\n- periodic boundary condition (no shift in $k_x$ at the boundary), or\n- twist-and-shift boundary condition (apply an integer index shift in the discrete $k_x$ grid to minimize mismatch).\n\nAssume an identical perpendicular $k_x$ grid for both geometries with uniform spacing $\\Delta k_x^{\\mathrm{grid}}$. Given a computed $\\Delta k_x$ for a geometry, define the dimensionless mismatch error for a chosen integer grid shift $\\Delta i$ as\n$$\ne = \\frac{\\left|\\Delta k_x - \\Delta i \\, \\Delta k_x^{\\mathrm{grid}}\\right|}{\\Delta k_x^{\\mathrm{grid}}}.\n$$\nFor the periodic boundary condition, set $\\Delta i = 0$. For the twist-and-shift boundary condition, choose the integer $\\Delta i$ that minimizes $e$.\n\nYour program must compute, for a set of test cases, the four errors:\n- tokamak periodic error $e_{\\text{per,tok}}$,\n- tokamak twist-and-shift error $e_{\\text{tw,tok}}$,\n- stellarator periodic error $e_{\\text{per,stel}}$,\n- stellarator twist-and-shift error $e_{\\text{tw,stel}}$.\n\nUse the following test suite, where all angles are in radians and all wavenumbers are in normalized units typical of gyrokinetic simulations. Each test case specifies the grid spacing $\\Delta k_x^{\\mathrm{grid}}$, the binormal wavenumber $k_y$, the parallel domain length $L_z$, the tokamak shear $\\hat{s}$, and the stellarator shear coefficients $(s_0,s_1,s_2)$:\n\n- Test Case 1 (general case with moderate shear and nontrivial $z$ geometry):\n    - $\\Delta k_x^{\\mathrm{grid}} = 0.125$, $k_y = 0.35$, $L_z = 3.0$,\n    - tokamak $\\hat{s} = 0.8$,\n    - stellarator $(s_0,s_1,s_2) = (0.6,0.3,0.1)$.\n\n- Test Case 2 (perfect registry for tokamak twist-and-shift, near-registry for stellarator):\n    - $\\Delta k_x^{\\mathrm{grid}} = 0.1$, $k_y = 0.4$, $L_z = 2.0$,\n    - tokamak $\\hat{s} = 1.25$,\n    - stellarator $(s_0,s_1,s_2) = (1.1,0.2,-0.1)$.\n\n- Test Case 3 (half-grid mismatch for tokamak, near-exact registry for stellarator):\n    - $\\Delta k_x^{\\mathrm{grid}} = 0.2$, $k_y = 0.5$, $L_z = 1.5$,\n    - tokamak $\\hat{s} = 0.9333333333333$,\n    - stellarator $(s_0,s_1,s_2) = (0.6,0.3,0.0)$.\n\n- Test Case 4 (no binormal variation, both geometries yield zero shift):\n    - $\\Delta k_x^{\\mathrm{grid}} = 0.15$, $k_y = 0.0$, $L_z = 2.5$,\n    - tokamak $\\hat{s} = 1.0$,\n    - stellarator $(s_0,s_1,s_2) = (0.7,0.2,0.05)$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. The list must contain the four errors for each test case in the order\n$$\n\\left[e_{\\text{per,tok}}^{(1)}, e_{\\text{tw,tok}}^{(1)}, e_{\\text{per,stel}}^{(1)}, e_{\\text{tw,stel}}^{(1)}, \\ldots, e_{\\text{per,tok}}^{(4)}, e_{\\text{tw,tok}}^{(4)}, e_{\\text{per,stel}}^{(4)}, e_{\\text{tw,stel}}^{(4)}\\right],\n$$\nwhere the superscript indicates the test case index. All angles must be in radians, and all outputs must be floats without units.",
            "solution": "The problem statement has been critically evaluated and is determined to be valid. It is scientifically grounded within the established framework of gyrokinetic flux-tube simulations in plasma physics, is mathematically well-posed, and is presented in an objective, formal language. All necessary data and definitions for a unique solution are provided.\n\nThe primary task is to derive the total shift in the radial wavenumber, $\\Delta k_x$, over a parallel domain of length $L_z$ for two different magnetic geometries (tokamak and stellarator), and then to quantify the numerical error introduced when discretizing this shift for both periodic and twist-and-shift boundary conditions.\n\nFirst, we establish the theoretical basis for the wavenumber shift. In the flux-tube model, the magnetic field has a local shear, which causes the orientation of the perpendicular coordinates to change as one moves along a magnetic field line. This geometric effect manifests as a change in the radial wavenumber $k_x$ for a fixed binormal wavenumber $k_y$. The rate of change of $k_x$ with respect to the parallel coordinate $z$ is given by the fundamental relation:\n$$\n\\frac{d k_x}{d z} = k_y s(z)\n$$\nwhere $s(z)$ is the local magnetic shear function.\n\nTo find the total change in the radial wavenumber, $\\Delta k_x = k_x(L_z) - k_x(0)$, we integrate this differential equation over the parallel domain, from $z=0$ to $z=L_z$:\n$$\n\\Delta k_x = \\int_0^{L_z} \\frac{d k_x}{d z'} dz' = \\int_0^{L_z} k_y s(z') dz' = k_y \\int_0^{L_z} s(z') dz'\n$$\nThis formula provides the physically required shift in $k_x$ that a numerical scheme must accommodate to maintain the continuity of the mode across the parallel boundary.\n\nNext, we apply this general formula to the two specific cases defined in the problem.\n\nFor an axisymmetric tokamak, the magnetic shear is approximately constant along the field line within the flux tube, so $s(z) = \\hat{s}$. The integral is straightforward:\n$$\n\\int_0^{L_z} \\hat{s} \\, dz' = \\hat{s} \\int_0^{L_z} dz' = \\hat{s} L_z\n$$\nThus, the wavenumber shift for the tokamak is:\n$$\n\\Delta k_{x, \\text{tok}} = k_y \\hat{s} L_z\n$$\n\nFor a non-axisymmetric stellarator, the shear varies along the field line. The problem provides the model function $s(z) = s_0 + s_1 \\cos(z) + s_2 \\sin(2z)$. We must integrate this function from $z=0$ to $z=L_z$:\n$$\n\\int_0^{L_z} \\left(s_0 + s_1 \\cos(z') + s_2 \\sin(2z')\\right) dz' = \\left[ s_0 z' + s_1 \\sin(z') - \\frac{s_2}{2} \\cos(2z') \\right]_0^{L_z}\n$$\nEvaluating the definite integral yields:\n$$\n\\left( s_0 L_z + s_1 \\sin(L_z) - \\frac{s_2}{2} \\cos(2L_z) \\right) - \\left( s_0 \\cdot 0 + s_1 \\sin(0) - \\frac{s_2}{2} \\cos(0) \\right) = s_0 L_z + s_1 \\sin(L_z) - \\frac{s_2}{2} \\cos(2L_z) + \\frac{s_2}{2}\n$$\nTherefore, the wavenumber shift for the stellarator is:\n$$\n\\Delta k_{x, \\text{stel}} = k_y \\left( s_0 L_z + s_1 \\sin(L_z) - \\frac{s_2}{2} (\\cos(2L_z) - 1) \\right)\n$$\n\nThe final step is to quantify the numerical mismatch error. The computational grid for the radial wavenumber is discrete, with a uniform spacing $\\Delta k_x^{\\mathrm{grid}}$. A numerical boundary condition must approximate the physical shift $\\Delta k_x$ by an integer multiple of this grid spacing, i.e., by $\\Delta i \\, \\Delta k_x^{\\mathrm{grid}}$ for some integer $\\Delta i$. The dimensionless mismatch error $e$ is defined as:\n$$\ne = \\frac{\\left|\\Delta k_x - \\Delta i \\, \\Delta k_x^{\\mathrm{grid}}\\right|}{\\Delta k_x^{\\mathrm{grid}}} = \\left| \\frac{\\Delta k_x}{\\Delta k_x^{\\mathrm{grid}}} - \\Delta i \\right|\n$$\n\nFor the periodic boundary condition, no shift is applied, which corresponds to setting the grid shift index $\\Delta i = 0$. The error is then:\n$$\ne_{\\text{per}} = \\left| \\frac{\\Delta k_x}{\\Delta k_x^{\\mathrm{grid}}} \\right|\n$$\n\nFor the twist-and-shift boundary condition, the integer grid shift $\\Delta i$ is chosen to minimize the error $e$. This is achieved by selecting the integer $\\Delta i$ that is closest to the value of the ratio $X = \\frac{\\Delta k_x}{\\Delta k_x^{\\mathrm{grid}}}$. This optimal integer shift is $\\Delta i_{\\text{opt}} = \\text{round}(X)$, where the $\\text{round}$ function maps a real number to its nearest integer. The resulting minimal error is:\n$$\ne_{\\text{tw}} = \\left| \\frac{\\Delta k_x}{\\Delta k_x^{\\mathrm{grid}}} - \\text{round}\\left(\\frac{\\Delta k_x}{\\Delta k_x^{\\mathrm{grid}}}\\right) \\right|\n$$\n\nThe algorithm to be implemented will, for each test case, first compute $\\Delta k_{x, \\text{tok}}$ and $\\Delta k_{x, \\text{stel}}$ using the derived formulas. Then, using these values and the given $\\Delta k_x^{\\mathrm{grid}}$, it will calculate the four required errors: $e_{\\text{per,tok}}$, $e_{\\text{tw,tok}}$, $e_{\\text{per,stel}}$, and $e_{\\text{tw,stel}}$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem of calculating boundary condition mismatch errors for a set of\n    gyrokinetic simulation test cases.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test Case 1: general case\n        {'delta_kx_grid': 0.125, 'ky': 0.35, 'Lz': 3.0, 's_hat': 0.8, 's_coeffs': (0.6, 0.3, 0.1)},\n        # Test Case 2: perfect registry for tokamak T\n        {'delta_kx_grid': 0.1, 'ky': 0.4, 'Lz': 2.0, 's_hat': 1.25, 's_coeffs': (1.1, 0.2, -0.1)},\n        # Test Case 3: half-grid mismatch for tokamak\n        {'delta_kx_grid': 0.2, 'ky': 0.5, 'Lz': 1.5, 's_hat': 0.9333333333333, 's_coeffs': (0.6, 0.3, 0.0)},\n        # Test Case 4: no binormal variation\n        {'delta_kx_grid': 0.15, 'ky': 0.0, 'Lz': 2.5, 's_hat': 1.0, 's_coeffs': (0.7, 0.2, 0.05)},\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        delta_kx_grid = case['delta_kx_grid']\n        ky = case['ky']\n        Lz = case['Lz']\n        s_hat = case['s_hat']\n        s0, s1, s2 = case['s_coeffs']\n\n        # --- Calculate physical wavenumber shifts ---\n\n        # Tokamak shift\n        delta_kx_tok = ky * s_hat * Lz\n\n        # Stellarator shift\n        integral_stel = s0 * Lz + s1 * np.sin(Lz) - (s2 / 2.0) * (np.cos(2.0 * Lz) - 1.0)\n        delta_kx_stel = ky * integral_stel\n\n        # --- Calculate mismatch errors ---\n        \n        def calculate_errors(delta_kx, grid_spacing):\n            \"\"\"\n            Calculates periodic and twist-and-shift errors for a given physical shift.\n            \n            Args:\n                delta_kx (float): The physical shift in kx.\n                grid_spacing (float): The kx grid spacing.\n            \n            Returns:\n                tuple[float, float]: A tuple containing the periodic error and the \n                                     twist-and-shift error.\n            \"\"\"\n            if grid_spacing == 0:\n                # Avoid division by zero, though problem constraints make this unlikely.\n                return (np.inf, np.inf)\n            \n            # The ratio of the physical shift to the grid spacing\n            X = delta_kx / grid_spacing\n            \n            # Periodic error (shift index Delta_i = 0)\n            e_per = np.abs(X)\n            \n            # Twist-and-shift error (optimal integer shift)\n            # np.round rounds to the nearest even integer for .5 cases (e.g., round(2.5)=2, round(3.5)=4)\n            # The resulting error is 0.5 regardless, so this is fine.\n            delta_i_opt = np.round(X)\n            e_tw = np.abs(X - delta_i_opt)\n\n            return e_per, e_tw\n\n        # Calculate the four errors for the current test case\n        e_per_tok, e_tw_tok = calculate_errors(delta_kx_tok, delta_kx_grid)\n        e_per_stel, e_tw_stel = calculate_errors(delta_kx_stel, delta_kx_grid)\n\n        all_results.extend([e_per_tok, e_tw_tok, e_per_stel, e_tw_stel])\n\n    # Final print statement in the exact required format.\n    # The map(str, ...) converts all floats to their string representation.\n    print(f\"[{','.join(map(str, all_results))}]\")\n\nsolve()\n```"
        }
    ]
}