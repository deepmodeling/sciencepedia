{
    "hands_on_practices": [
        {
            "introduction": "This practice serves as a foundational exercise in applying the principles of differential geometry to a simplified tokamak model. Before analyzing complex plasma dynamics, one must be able to describe the geometry of the space in which the plasma is confined. This problem  guides you through the calculation of the metric tensor components, $g_{ij}$, and the volume Jacobian, $J$, which are the essential building blocks for defining distances, angles, and volumes in any curvilinear coordinate system. Mastering these fundamental calculations in the large-aspect-ratio limit provides a crucial stepping stone towards understanding more complex magnetic geometries.",
            "id": "4189287",
            "problem": "In the context of flux-surface aligned and field-aligned coordinate systems for fusion plasma turbulence simulation, consider a large-aspect-ratio circular tokamak. Let the tokamak have a major radius $R_{0}$ and minor radius coordinate $r$, with poloidal angle $\\theta$ and toroidal angle $\\phi$. Assume that flux surfaces are circular and concentric, and that $r/R_{0} \\ll 1$ (large aspect ratio). Use the geometric embedding into cylindrical coordinates $(R,Z,\\phi)$ given by $R = R_{0} + r \\cos\\theta$ and $Z = r \\sin\\theta$, where $\\theta$ and $\\phi$ are measured in radians.\n\nFlux-surface coordinates $(\\psi,\\theta,\\phi)$ are introduced with $\\psi$ a poloidal flux function that is a monotonic function of $r$, and on the specified flux surface the magnitude of the gradient is known to be $|\\nabla \\psi|$. The coordinate metric coefficients $g_{ij}$ are defined by $g_{ij} = \\partial \\boldsymbol{x}/\\partial u_{i} \\cdot \\partial \\boldsymbol{x}/\\partial u_{j}$, where $\\boldsymbol{x}$ is the position vector and $(u_{1},u_{2},u_{3})$ denotes the coordinates. The volume Jacobian for a coordinate system $(u_{1},u_{2},u_{3})$ is defined by $J = \\left|\\frac{\\partial \\boldsymbol{x}}{\\partial u_{1}} \\times \\frac{\\partial \\boldsymbol{x}}{\\partial u_{2}} \\cdot \\frac{\\partial \\boldsymbol{x}}{\\partial u_{3}}\\right|$, so that the volume element is $\\mathrm{d}V = J\\,\\mathrm{d}u_{1}\\mathrm{d}u_{2}\\mathrm{d}u_{3}$.\n\nStarting from these definitions and the geometric embedding above, derive the leading-order expressions for the metric coefficients $g_{\\theta\\theta}$, $g_{\\phi\\phi}$, and $g_{\\theta\\phi}$ on a flux surface in the large-aspect-ratio circular limit, and estimate the flux-coordinate Jacobian $J$ for $(\\psi,\\theta,\\phi)$ to leading order in $r/R_{0}$. Then evaluate these expressions numerically for $R_{0} = 1.7\\,\\mathrm{m}$, $r = 0.35\\,\\mathrm{m}$, and $|\\nabla \\psi| = 12\\,\\mathrm{Wb/m}$. Round your answers to four significant figures. Express $g_{\\theta\\theta}$ and $g_{\\phi\\phi}$ in $\\mathrm{m}^{2}$ and $J$ in $\\mathrm{m}^{3}/\\mathrm{Wb}$. Provide your final answer as a single row matrix in the order $\\left(g_{\\theta\\theta},\\,g_{\\phi\\phi},\\,g_{\\theta\\phi},\\,J\\right)$.",
            "solution": "The user has requested a solution to a problem in plasma physics. As a meticulous professor, I must first validate the problem statement.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n-   **System**: Large-aspect-ratio circular tokamak.\n-   **Parameters**: Major radius $R_{0}$, minor radius coordinate $r$.\n-   **Coordinates**: Poloidal angle $\\theta$, toroidal angle $\\phi$.\n-   **Assumption**: Large aspect ratio, $r/R_{0} \\ll 1$.\n-   **Geometric Embedding**: Cylindrical coordinates $(R,Z,\\phi)$ are defined as $R = R_{0} + r \\cos\\theta$ and $Z = r \\sin\\theta$.\n-   **Flux Coordinates**: $(\\psi,\\theta,\\phi)$, where $\\psi$ is a poloidal flux function, monotonic in $r$.\n-   **Known Quantity**: On a given flux surface, the magnitude of the flux-function gradient is $|\\nabla \\psi|$.\n-   **Definitions**:\n    -   Metric coefficients: $g_{ij} = \\frac{\\partial \\boldsymbol{x}}{\\partial u_{i}} \\cdot \\frac{\\partial \\boldsymbol{x}}{\\partial u_{j}}$.\n    -   Jacobian: $J = \\left|\\frac{\\partial \\boldsymbol{x}}{\\partial u_{1}} \\times \\frac{\\partial \\boldsymbol{x}}{\\partial u_{2}} \\cdot \\frac{\\partial \\boldsymbol{x}}{\\partial u_{3}}\\right|$.\n-   **Tasks**:\n    1.  Derive leading-order expressions for $g_{\\theta\\theta}$, $g_{\\phi\\phi}$, and $g_{\\theta\\phi}$ in the large-aspect-ratio limit.\n    2.  Estimate the flux-coordinate Jacobian $J$ for $(\\psi,\\theta,\\phi)$ to leading order in $r/R_{0}$.\n    3.  Evaluate these expressions numerically.\n-   **Numerical Values**: $R_{0} = 1.7\\,\\mathrm{m}$, $r = 0.35\\,\\mathrm{m}$, $|\\nabla \\psi| = 12\\,\\mathrm{Wb/m}$.\n-   **Output Requirements**:\n    -   Round numerical answers to four significant figures.\n    -   Express final answer as a single row matrix $(g_{\\theta\\theta},\\,g_{\\phi\\phi},\\,g_{\\theta\\phi},\\,J)$.\n    -   Units for numerical values: $g_{\\theta\\theta}$, $g_{\\phi\\phi}$ in $\\mathrm{m}^{2}$; $J$ in $\\mathrm{m}^{3}/\\mathrm{Wb}$.\n\n**Step 2: Validate Using Extracted Givens**\n-   **Scientifically Grounded**: The problem is based on the standard and well-established model of a large-aspect-ratio circular tokamak, a cornerstone of introductory plasma physics and fusion research. The definitions for metric coefficients and the Jacobian are standard in differential geometry and physics. All concepts are scientifically sound.\n-   **Well-Posed**: The problem provides all necessary information. The relationship between $\\psi$ and $r$ is sufficiently defined through $|\\nabla \\psi|$. The tasks are clear and lead to a unique solution under the standard interpretation of \"leading order\" in this context.\n-   **Objective**: The problem is stated using precise, objective, and technical language, free from any subjective or biased elements.\n\nThe problem does not violate any of the invalidity criteria. It is scientifically sound, well-posed, objective, and formalizable. The provided numerical values describe a physically plausible mid-sized tokamak. The aspect ratio inverse is $\\epsilon = r/R_0 = 0.35/1.7 \\approx 0.206$, which is small enough to justify the large-aspect-ratio approximation.\n\n**Step 3: Verdict and Action**\nThe problem is **valid**. A full solution will be provided.\n\n### Solution\n\nThe position vector $\\boldsymbol{x}$ in Cartesian coordinates $(x,y,z)$ can be expressed using the given toroidal geometry. The transformation from cylindrical coordinates $(R, Z, \\phi)$ to Cartesian is $x = R\\cos\\phi$, $y = R\\sin\\phi$, and $z = Z$. Substituting the expressions for $R$ and $Z$:\n$$ \\boldsymbol{x}(\\theta, \\phi; r) = \\begin{pmatrix} (R_{0} + r \\cos\\theta)\\cos\\phi \\\\ (R_{0} + r \\cos\\theta)\\sin\\phi \\\\ r \\sin\\theta \\end{pmatrix} $$\nFor calculations on a single flux surface, $r$ is constant with respect to $\\theta$ and $\\phi$.\n\n**1. Derivation of Metric Coefficients**\n\nThe metric coefficients $g_{ij}$ are the dot products of the basis vectors $\\partial\\boldsymbol{x}/\\partial u_i$. We are interested in the coordinates $u_2=\\theta$ and $u_3=\\phi$.\n\nThe partial derivative with respect to $\\theta$ is:\n$$ \\frac{\\partial \\boldsymbol{x}}{\\partial \\theta} = \\begin{pmatrix} -r \\sin\\theta \\cos\\phi \\\\ -r \\sin\\theta \\sin\\phi \\\\ r \\cos\\theta \\end{pmatrix} $$\nThe partial derivative with respect to $\\phi$ is:\n$$ \\frac{\\partial \\boldsymbol{x}}{\\partial \\phi} = \\begin{pmatrix} -(R_{0} + r \\cos\\theta) \\sin\\phi \\\\ (R_{0} + r \\cos\\theta) \\cos\\phi \\\\ 0 \\end{pmatrix} $$\n\nNow we compute the required metric coefficients:\n$g_{\\theta\\theta} = \\frac{\\partial \\boldsymbol{x}}{\\partial \\theta} \\cdot \\frac{\\partial \\boldsymbol{x}}{\\partial \\theta} = (-r \\sin\\theta \\cos\\phi)^2 + (-r \\sin\\theta \\sin\\phi)^2 + (r \\cos\\theta)^2$\n$$ g_{\\theta\\theta} = r^2\\sin^2\\theta(\\cos^2\\phi + \\sin^2\\phi) + r^2\\cos^2\\theta = r^2\\sin^2\\theta + r^2\\cos^2\\theta = r^2 $$\nThis expression is exact for the given geometry.\n\n$g_{\\phi\\phi} = \\frac{\\partial \\boldsymbol{x}}{\\partial \\phi} \\cdot \\frac{\\partial \\boldsymbol{x}}{\\partial \\phi} = (-(R_{0} + r \\cos\\theta) \\sin\\phi)^2 + ((R_{0} + r \\cos\\theta) \\cos\\phi)^2 + 0^2$\n$$ g_{\\phi\\phi} = (R_{0} + r \\cos\\theta)^2 (\\sin^2\\phi + \\cos^2\\phi) = (R_{0} + r \\cos\\theta)^2 $$\nIn the large-aspect-ratio limit ($r/R_{0} \\ll 1$), we expand this expression:\n$$ g_{\\phi\\phi} = R_{0}^2 \\left(1 + \\frac{r}{R_{0}}\\cos\\theta\\right)^2 = R_{0}^2 \\left(1 + 2\\frac{r}{R_{0}}\\cos\\theta + \\left(\\frac{r}{R_{0}}\\right)^2\\cos^2\\theta\\right) $$\nThe leading-order expression is the term of lowest order in the expansion parameter $\\epsilon = r/R_{0}$, which is the $\\epsilon^0$ term.\n$$ g_{\\phi\\phi} \\approx R_{0}^2 $$\n\n$g_{\\theta\\phi} = \\frac{\\partial \\boldsymbol{x}}{\\partial \\theta} \\cdot \\frac{\\partial \\boldsymbol{x}}{\\partial \\phi}$\n$$ g_{\\theta\\phi} = (-r\\sin\\theta\\cos\\phi)(-(R_0+r\\cos\\theta)\\sin\\phi) + (-r\\sin\\theta\\sin\\phi)((R_0+r\\cos\\theta)\\cos\\phi) + 0 $$\n$$ g_{\\theta\\phi} = r\\sin\\theta(R_0+r\\cos\\theta)(\\cos\\phi\\sin\\phi - \\sin\\phi\\cos\\phi) = 0 $$\nThis coefficient is exactly zero, so its leading-order expression is also $0$. This indicates that $\\theta$ and $\\phi$ are orthogonal coordinates in this geometry.\n\n**2. Derivation of the Jacobian**\n\nThe Jacobian $J$ for the coordinate system $(\\psi, \\theta, \\phi)$ is related to the Jacobian for the $(r, \\theta, \\phi)$ system. The volume element $\\mathrm{d}V$ in the $(r, \\theta, \\phi)$ coordinate system is:\n$$ \\mathrm{d}V = \\mathrm{d}r \\cdot (r\\,\\mathrm{d}\\theta) \\cdot ((R_{0}+r\\cos\\theta)\\,\\mathrm{d}\\phi) = r(R_{0}+r\\cos\\theta)\\,\\mathrm{d}r\\,\\mathrm{d}\\theta\\,\\mathrm{d}\\phi $$\nThe Jacobian for these coordinates is thus $J_{(r,\\theta,\\phi)} = r(R_{0}+r\\cos\\theta)$.\n\nTo find the Jacobian for the $(\\psi, \\theta, \\phi)$ system, we perform a change of variables from $r$ to $\\psi$.\n$$ \\mathrm{d}r = \\frac{\\mathrm{d}r}{\\mathrm{d}\\psi} \\mathrm{d}\\psi $$\nThe problem states that $\\psi$ is a function of $r$ only for these flux surfaces. The magnitude of its gradient is generally $|\\nabla \\psi| = |\\frac{\\mathrm{d}\\psi}{\\mathrm{d}r}\\nabla r|$. Since $\\nabla r$ is a unit vector, $|\\nabla\\psi|=|\\frac{\\mathrm{d}\\psi}{\\mathrm{d}r}|$. Assuming $\\psi$ increases with $r$, we have $\\frac{\\mathrm{d}r}{\\mathrm{d}\\psi} = \\frac{1}{|\\nabla\\psi|}$.\nThe volume element becomes:\n$$ \\mathrm{d}V = r(R_{0}+r\\cos\\theta) \\left(\\frac{1}{|\\nabla\\psi|}\\right) \\mathrm{d}\\psi\\,\\mathrm{d}\\theta\\,\\mathrm{d}\\phi $$\nThe Jacobian $J \\equiv J_{(\\psi,\\theta,\\phi)}$ is the coefficient of $\\mathrm{d}\\psi\\,\\mathrm{d}\\theta\\,\\mathrm{d}\\phi$:\n$$ J = \\frac{r(R_{0}+r\\cos\\theta)}{|\\nabla\\psi|} $$\nTo find the leading-order estimate, we again expand in $r/R_{0}$:\n$$ J = \\frac{rR_{0}}{|\\nabla\\psi|}\\left(1 + \\frac{r}{R_{0}}\\cos\\theta\\right) $$\nThe leading-order term is:\n$$ J \\approx \\frac{rR_{0}}{|\\nabla\\psi|} $$\n\n**Summary of Leading-Order Expressions**\n-   $g_{\\theta\\theta} = r^2$\n-   $g_{\\phi\\phi} \\approx R_0^2$\n-   $g_{\\theta\\phi} = 0$\n-   $J \\approx \\frac{rR_{0}}{|\\nabla\\psi|}$\n\n**3. Numerical Evaluation**\n\nWe are given the values: $R_{0} = 1.7\\,\\mathrm{m}$, $r = 0.35\\,\\mathrm{m}$, and $|\\nabla \\psi| = 12\\,\\mathrm{Wb/m}$. We will evaluate the leading-order expressions and round to four significant figures.\n\n-   $g_{\\theta\\theta} = (0.35\\,\\mathrm{m})^2 = 0.1225\\,\\mathrm{m}^2$.\n\n-   $g_{\\phi\\phi} \\approx (1.7\\,\\mathrm{m})^2 = 2.89\\,\\mathrm{m}^2$. To four significant figures, this is $2.890\\,\\mathrm{m}^2$.\n\n-   $g_{\\theta\\phi} = 0$.\n\n-   $J \\approx \\frac{(0.35\\,\\mathrm{m})(1.7\\,\\mathrm{m})}{12\\,\\mathrm{Wb/m}} = \\frac{0.595\\,\\mathrm{m}^2}{12\\,\\mathrm{Wb/m}} \\approx 0.0495833...\\,\\mathrm{m}^3/\\mathrm{Wb}$.\n    Rounding to four significant figures, $J \\approx 0.04958\\,\\mathrm{m}^3/\\mathrm{Wb}$.\n\n**Final Answer Assembly**\n\nThe final answer is the row matrix $(g_{\\theta\\theta},\\,g_{\\phi\\phi},\\,g_{\\theta\\phi},\\,J)$ with the calculated numerical values.\n$$ (0.1225,\\, 2.890,\\, 0,\\, 0.04958) $$",
            "answer": "$$ \\boxed{ \\begin{pmatrix} 0.1225 & 2.890 & 0 & 0.04958 \\end{pmatrix} } $$"
        },
        {
            "introduction": "The power of field-aligned coordinates becomes apparent when analyzing fluctuations, which are the essence of plasma turbulence. This exercise  directly connects the magnetic geometry to the spectral properties of these fluctuations. By deriving the poloidally varying perpendicular wavenumber, $k_\\perp^2(\\theta)$, you will see how the geometry dictates the spatial structure of turbulent eddies, a concept central to gyrokinetic theory and the analysis of microinstabilities.",
            "id": "4189269",
            "problem": "Consider an axisymmetric, large-aspect-ratio tokamak with circular, concentric magnetic flux surfaces. Use flux-surface aligned coordinates $(r,\\theta,\\phi)$, where $r$ is the minor radius labeling the flux surface, $\\theta$ is the poloidal angle, and $\\phi$ is the toroidal angle. The position-dependent major radius is $R(\\theta)=R_0 + r \\cos\\theta$, with $R_0$ the constant major radius of the magnetic axis. In these orthogonal coordinates, the line element on a flux surface ($r=\\text{const}$) is $ds^2 = r^2\\, d\\theta^2 + R(\\theta)^2\\, d\\phi^2$, and the corresponding scale factors are $h_r=1$, $h_\\theta=r$, and $h_\\phi=R(\\theta)$.\n\nAdopt straight-field-line, field-aligned coordinates in which the Clebsch field-line label is defined by $\\alpha=\\phi - q \\theta$, where $q$ is the safety factor, assumed constant on the chosen flux surface in the local approximation. The magnetic field can be represented in Clebsch form as $\\mathbf{B}=\\nabla\\psi \\times \\nabla\\alpha$, where $\\psi$ is a flux function, but you should not use any shortcut formulas beyond the provided geometric definitions. A fluctuation with binormal Fourier wavenumber $k_y$ has phase $k_y \\alpha$, and its perpendicular wavevector in the local, field-aligned model is directed along $\\nabla\\alpha$.\n\nStarting from first principles of orthogonal curvilinear coordinates and the definition of the gradient, derive the expression for $|\\nabla \\alpha|^2$ on the flux surface. Then use your result to obtain an explicit expression for the poloidally varying perpendicular wavenumber magnitude $k_\\perp^2(\\theta)$ for the Fourier mode with binormal wavenumber $k_y$, assuming zero radial wavenumber in the local model so that $\\mathbf{k}_\\perp(\\theta)=k_y \\nabla \\alpha$.\n\nYour final answer must be a single, closed-form analytic expression for $k_\\perp^2(\\theta)$ in terms of $k_y$, $q$, $r$, $R_0$, and $\\theta$. Do not perform any numerical evaluations.",
            "solution": "The problem is subjected to validation and is deemed valid. It is scientifically grounded in the established theory of magnetic confinement fusion and plasma physics, specifically concerning the geometry of turbulence simulation in tokamaks. The problem is well-posed, providing all necessary definitions and constraints to derive a unique analytical solution. The language is objective and the setup is internally consistent and physically reasonable within the standard local approximations used in the field.\n\nThe derivation of the perpendicular wavenumber magnitude squared, $k_\\perp^2(\\theta)$, proceeds from first principles as requested. We begin with the general definition of the gradient of a scalar function, $\\alpha$, in an orthogonal curvilinear coordinate system $(u_1, u_2, u_3)$ with corresponding unit vectors $(\\hat{e}_1, \\hat{e}_2, \\hat{e}_3)$ and scale factors $(h_1, h_2, h_3)$. The formula for the gradient is:\n$$ \\nabla \\alpha = \\frac{\\hat{e}_1}{h_1} \\frac{\\partial \\alpha}{\\partial u_1} + \\frac{\\hat{e}_2}{h_2} \\frac{\\partial \\alpha}{\\partial u_2} + \\frac{\\hat{e}_3}{h_3} \\frac{\\partial \\alpha}{\\partial u_3} $$\nThe problem specifies the use of flux-surface aligned coordinates $(r, \\theta, \\phi)$, which are orthogonal. Thus, we identify $(u_1, u_2, u_3)$ with $(r, \\theta, \\phi)$. The problem provides the corresponding scale factors as $h_r=1$, $h_\\theta=r$, and $h_\\phi=R(\\theta)$, where $R(\\theta) = R_0 + r \\cos\\theta$.\n\nThe scalar function of interest is the Clebsch field-line label, defined as $\\alpha = \\phi - q\\theta$, where the safety factor $q$ is constant on the flux surface under consideration. We first calculate the partial derivatives of $\\alpha$ with respect to the coordinates $r$, $\\theta$, and $\\phi$:\n$$ \\frac{\\partial \\alpha}{\\partial r} = \\frac{\\partial}{\\partial r}(\\phi - q\\theta) = 0 $$\nThis derivative is zero because $\\theta$ and $\\phi$ are independent of $r$, and $q$ is treated as a constant on the given flux surface ($r = \\text{const}$). This is consistent with the local model assumption of zero radial wavenumber for the fluctuation being analyzed.\n$$ \\frac{\\partial \\alpha}{\\partial \\theta} = \\frac{\\partial}{\\partial \\theta}(\\phi - q\\theta) = -q $$\n$$ \\frac{\\partial \\alpha}{\\partial \\phi} = \\frac{\\partial}{\\partial \\phi}(\\phi - q\\theta) = 1 $$\nSubstituting these partial derivatives and the scale factors into the gradient formula, we obtain the expression for $\\nabla \\alpha$:\n$$ \\nabla \\alpha = \\frac{\\hat{e}_r}{h_r}\\left(\\frac{\\partial \\alpha}{\\partial r}\\right) + \\frac{\\hat{e}_\\theta}{h_\\theta}\\left(\\frac{\\partial \\alpha}{\\partial \\theta}\\right) + \\frac{\\hat{e}_\\phi}{h_\\phi}\\left(\\frac{\\partial \\alpha}{\\partial \\phi}\\right) $$\n$$ \\nabla \\alpha = \\frac{\\hat{e}_r}{1}(0) + \\frac{\\hat{e}_\\theta}{r}(-q) + \\frac{\\hat{e}_\\phi}{R(\\theta)}(1) $$\n$$ \\nabla \\alpha = -\\frac{q}{r} \\hat{e}_\\theta + \\frac{1}{R(\\theta)} \\hat{e}_\\phi $$\nThe squared magnitude of the gradient, $|\\nabla \\alpha|^2$, is the dot product of $\\nabla \\alpha$ with itself. Since the coordinate system is orthogonal, the basis vectors $(\\hat{e}_r, \\hat{e}_\\theta, \\hat{e}_\\phi)$ are orthonormal, meaning $\\hat{e}_i \\cdot \\hat{e}_j = \\delta_{ij}$. The calculation simplifies to the sum of the squares of the components:\n$$ |\\nabla \\alpha|^2 = (\\nabla \\alpha) \\cdot (\\nabla \\alpha) = \\left(-\\frac{q}{r}\\right)^2 + \\left(\\frac{1}{R(\\theta)}\\right)^2 $$\n$$ |\\nabla \\alpha|^2 = \\frac{q^2}{r^2} + \\frac{1}{R(\\theta)^2} $$\nThis completes the first part of the task. For the second part, we use the provided model for the perpendicular wavevector, $\\mathbf{k}_\\perp(\\theta) = k_y \\nabla \\alpha$, where $k_y$ is the constant binormal wavenumber for the Fourier mode. The squared magnitude of the perpendicular wavevector, $k_\\perp^2(\\theta)$, is therefore:\n$$ k_\\perp^2(\\theta) = |\\mathbf{k}_\\perp(\\theta)|^2 = |k_y \\nabla \\alpha|^2 = k_y^2 |\\nabla \\alpha|^2 $$\nSubstituting our derived expression for $|\\nabla \\alpha|^2$:\n$$ k_\\perp^2(\\theta) = k_y^2 \\left( \\frac{q^2}{r^2} + \\frac{1}{R(\\theta)^2} \\right) $$\nFinally, the problem requires the answer in terms of $k_y$, $q$, $r$, $R_0$, and $\\theta$. We substitute the given definition for the position-dependent major radius, $R(\\theta) = R_0 + r \\cos\\theta$, into our expression for $k_\\perp^2(\\theta)$:\n$$ k_\\perp^2(\\theta) = k_y^2 \\left( \\frac{q^2}{r^2} + \\frac{1}{(R_0 + r \\cos\\theta)^2} \\right) $$\nThis is the final, closed-form analytic expression for the poloidally varying perpendicular wavenumber magnitude squared on the flux surface.",
            "answer": "$$\n\\boxed{k_y^2 \\left( \\frac{q^2}{r^2} + \\frac{1}{(R_0 + r \\cos\\theta)^2} \\right)}\n$$"
        },
        {
            "introduction": "Ultimately, theoretical models of fusion plasmas are realized through numerical simulations, which require translating continuous analytical expressions into discrete algorithms. This computational practice  bridges the gap between theory and implementation. You will compute the essential geometric quantities on a numerical grid and then use them to verify a fundamental law of physics: that the magnetic field is divergence-free, $\\nabla \\cdot \\mathbf{B} = 0$. This type of verification is a critical step in developing and validating any numerical code for plasma simulation, ensuring the model's physical and mathematical self-consistency.",
            "id": "4189289",
            "problem": "You are given an axisymmetric, large-aspect-ratio toroidal equilibrium intended to mimic a subset of output from Equilibrium FITting (EFIT) or Variational Moments Equilibrium Code (VMEC). You will work in flux-surface aligned coordinates $(\\psi,\\theta,\\zeta)$, where $\\psi$ is a monotonically increasing flux label, $\\theta$ is the poloidal angle, and $\\zeta$ is the toroidal angle. Angles must be treated in radians. All quantities are dimensionless unless otherwise stated.\n\nGeometry and mapping. In cylindrical coordinates $(R,\\phi,Z)$ with corresponding Cartesian coordinates $(x,y,z)$ defined by $x = R \\cos\\phi$, $y = R \\sin\\phi$, $z = Z$, consider nested circular flux surfaces parameterized as\n$$\nR(\\psi,\\theta) = R_0 + r(\\psi)\\cos\\theta,\\quad Z(\\psi,\\theta) = r(\\psi)\\sin\\theta,\\quad \\phi = \\zeta,\n$$\nwith $r(\\psi) = \\sqrt{2\\psi}$ and $R_0$ a major radius. The coordinate map is $X(\\psi,\\theta,\\zeta) = \\big(R(\\psi,\\theta)\\cos\\zeta,\\,R(\\psi,\\theta)\\sin\\zeta,\\,Z(\\psi,\\theta)\\big)$.\n\nCoordinate calculus. For a general curvilinear coordinate system $(u^1,u^2,u^3)=(\\psi,\\theta,\\zeta)$ mapped to $\\mathbb{R}^3$, define covariant basis vectors $a_i = \\partial X/\\partial u^i$, metric coefficients $g_{ij} = a_i\\cdot a_j$, and Jacobian\n$$\nJ = a_1\\cdot\\left(a_2\\times a_3\\right).\n$$\nThe reciprocal (contravariant) basis vectors satisfy $b^i\\cdot a_j = \\delta^i_{\\;j}$ and can be computed by $b^\\psi = (a_\\theta\\times a_\\zeta)/J$, $b^\\theta = (a_\\zeta\\times a_\\psi)/J$, $b^\\zeta = (a_\\psi\\times a_\\theta)/J$.\n\nMagnetic field and divergence. In field-aligned coordinates, define the Clebsch potential $\\alpha(\\psi,\\theta,\\zeta) = \\zeta - q(\\psi)\\,\\theta$, where $q(\\psi)$ is a prescribed safety-factor-like profile depending only on $\\psi$. Construct the magnetic field using the Clebsch form\n$$\n\\mathbf{B} = \\nabla\\psi \\times \\nabla\\alpha,\n$$\nwhich is divergence-free when $q = q(\\psi)$ (i.e., independent of $\\theta$ and $\\zeta$) because both $\\nabla\\psi$ and $\\nabla\\alpha$ are curl-free and $\\nabla\\cdot(\\nabla\\psi\\times\\nabla\\alpha)=0$. In a general curvilinear coordinate system, the divergence of a vector field $\\mathbf{A}$ written in contravariant components $\\mathbf{A} = A^\\psi a_\\psi + A^\\theta a_\\theta + A^\\zeta a_\\zeta$ is\n$$\n\\nabla\\cdot\\mathbf{A} = \\frac{1}{J}\\left(\\frac{\\partial}{\\partial\\psi}(J A^\\psi) + \\frac{\\partial}{\\partial\\theta}(J A^\\theta) + \\frac{\\partial}{\\partial\\zeta}(J A^\\zeta)\\right).\n$$\n\nTask. Implement a program that, for the given mapping and $\\alpha(\\psi,\\theta,\\zeta)$, computes on a numerical grid:\n- the covariant basis vectors $a_\\psi$, $a_\\theta$, $a_\\zeta$ by direct partial differentiation of $X(\\psi,\\theta,\\zeta)$,\n- the metric coefficients $g_{ij} = a_i\\cdot a_j$,\n- the Jacobian $J = a_\\psi\\cdot(a_\\theta\\times a_\\zeta)$,\n- the magnetic field $\\mathbf{B} = \\nabla\\psi \\times \\nabla\\alpha$ using the reciprocal basis,\n- the numerical divergence $\\nabla\\cdot\\mathbf{B}$ using the curvilinear divergence formula above with finite differences on the $(\\psi,\\theta,\\zeta)$ grid.\n\nVerification metrics. Your program must report, for each test case:\n- the maximum absolute divergence of $\\mathbf{B}$ over the grid, i.e., $\\max|\\nabla\\cdot\\mathbf{B}|$, as a float,\n- the maximum absolute symmetry residual of the metric matrix over the grid, i.e., $\\max|g_{ij}-g_{ji}|$ for $i\\neq j$, as a float.\n\nGrid and differencing. Use periodic central differences in $\\theta$ and $\\zeta$; use second-order central differences in the interior of the $\\psi$ domain and one-sided differences at the $\\psi$ boundaries. Angles must be in radians.\n\nTest suite. Use the following three test cases; for each, construct uniform grids over the specified ranges:\n1. Happy path: $R_0 = 3.0$, $a = 0.5$, $\\psi\\in[\\psi_{\\min},\\psi_{\\max}]$ with $\\psi_{\\max}=a^2/2$ and $\\psi_{\\min}=10^{-4}$, $q(\\psi) = q_0 + s\\,\\psi$ with $q_0=1.2$, $s=1.0$, grid sizes $(N_\\psi,N_\\theta,N_\\zeta)=(33,64,32)$, and $\\theta,\\zeta\\in[0,2\\pi)$.\n2. Near-axis boundary: $R_0 = 3.0$, $a = 0.5$, $\\psi_{\\max}=a^2/2$, $\\psi_{\\min}=10^{-9}$, $q(\\psi) = q_0 + s\\,\\psi$ with $q_0=1.0$, $s=0.0$, $(N_\\psi,N_\\theta,N_\\zeta)=(17,32,8)$, and $\\theta,\\zeta\\in[0,2\\pi)$.\n3. High shear: $R_0 = 3.0$, $a = 0.5$, $\\psi_{\\max}=a^2/2$, $\\psi_{\\min}=10^{-4}$, $q(\\psi) = q_0 + s\\,\\psi$ with $q_0=2.0$, $s=50.0$, $(N_\\psi,N_\\theta,N_\\zeta)=(25,48,24)$, and $\\theta,\\zeta\\in[0,2\\pi)$.\n\nOutput format. Your program should produce a single line of output containing the results for the three test cases as a comma-separated list of pairs, each pair being the two floats described above, enclosed in square brackets. For example: [[div1,sym1],[div2,sym2],[div3,sym3]]. All angles must be in radians and all outputs dimensionless. The floats should be printed in Pythonâ€™s default float format.",
            "solution": "The supplied problem is a valid computational physics task. It is scientifically grounded in the principles of plasma physics and differential geometry, well-posed with a clear objective and sufficient data, and free of any logical contradictions or factual errors. The problem asks for the implementation and verification of fundamental calculations related to flux-surface aligned and field-aligned coordinate systems, a standard topic in the field of fusion plasma turbulence simulation. We may therefore proceed with a complete solution.\n\nThe solution involves a multi-step process: first, we analytically derive the necessary geometric and physical quantities, and then we implement these formulas numerically to compute the specified verification metrics on a discretized grid.\n\n**1. Geometric Framework and Coordinate System**\n\nThe problem is set in a toroidal geometry using flux-surface aligned coordinates $(\\psi, \\theta, \\zeta)$. The mapping to Cartesian coordinates $X(\\psi, \\theta, \\zeta) = (x, y, z)$ is given by:\n$$\nx = R(\\psi, \\theta) \\cos\\zeta, \\quad y = R(\\psi, \\theta) \\sin\\zeta, \\quad z = Z(\\psi, \\theta)\n$$\nwhere $R(\\psi, \\theta) = R_0 + r(\\psi)\\cos\\theta$ and $Z(\\psi, \\theta) = r(\\psi)\\sin\\theta$. The minor radius $r$ is related to the flux label $\\psi$ by $r(\\psi) = \\sqrt{2\\psi}$. The toroidal angle $\\zeta$ is identified with the cylindrical angle $\\phi$.\n\n**2. Covariant Basis Vectors**\n\nThe covariant basis vectors, $a_i = \\partial X / \\partial u^i$, form a local basis at each point in space. For our coordinate system $(u^1, u^2, u^3) = (\\psi, \\theta, \\zeta)$, we compute the basis vectors by direct differentiation of $X(\\psi, \\theta, \\zeta)$. A key derivative is $dr/d\\psi = d(\\sqrt{2\\psi})/d\\psi = (1/2)(2\\psi)^{-1/2}(2) = 1/\\sqrt{2\\psi} = 1/r(\\psi)$.\n\nThe basis vectors are:\n$$\na_\\psi = \\frac{\\partial X}{\\partial\\psi} = \\left( \\frac{\\partial R}{\\partial\\psi}\\cos\\zeta, \\frac{\\partial R}{\\partial\\psi}\\sin\\zeta, \\frac{\\partial Z}{\\partial\\psi} \\right) = \\frac{1}{r}\\left( \\cos\\theta\\cos\\zeta, \\cos\\theta\\sin\\zeta, \\sin\\theta \\right)\n$$\n$$\na_\\theta = \\frac{\\partial X}{\\partial\\theta} = \\left( \\frac{\\partial R}{\\partial\\theta}\\cos\\zeta, \\frac{\\partial R}{\\partial\\theta}\\sin\\zeta, \\frac{\\partial Z}{\\partial\\theta} \\right) = r\\left( -\\sin\\theta\\cos\\zeta, -\\sin\\theta\\sin\\zeta, \\cos\\theta \\right)\n$$\n$$\na_\\zeta = \\frac{\\partial X}{\\partial\\zeta} = \\left( -R\\sin\\zeta, R\\cos\\zeta, 0 \\right)\n$$\n\n**3. Metric Tensor and Jacobian**\n\nThe metric tensor components are $g_{ij} = a_i \\cdot a_j$. Due to the orthogonal nature of the basis vectors in this simplified concentric circular geometry, the metric tensor is diagonal:\n$$\ng_{\\psi\\psi} = a_\\psi \\cdot a_\\psi = \\frac{1}{r^2} = \\frac{1}{2\\psi}\n$$\n$$\ng_{\\theta\\theta} = a_\\theta \\cdot a_\\theta = r^2 = 2\\psi\n$$\n$$\ng_{\\zeta\\zeta} = a_\\zeta \\cdot a_\\zeta = R^2 = (R_0 + r\\cos\\theta)^2\n$$\n$$\ng_{ij} = 0 \\quad \\text{for} \\quad i \\neq j\n$$\nAnalytically, the metric tensor is symmetric ($g_{ij} = g_{ji}$). The numerical check $\\max|g_{ij}-g_{ji}|$ serves as a sanity check on the implementation of the dot products, and is expected to be zero to within machine precision.\n\nThe Jacobian of the transformation, defined as $J = a_\\psi \\cdot (a_\\theta \\times a_\\zeta)$, is computed as:\n$$\na_\\theta \\times a_\\zeta = \\left( -rR\\cos\\theta\\cos\\zeta, -rR\\cos\\theta\\sin\\zeta, -rR\\sin\\theta \\right)\n$$\n$$\nJ = a_\\psi \\cdot (a_\\theta \\times a_\\zeta) = \\frac{1}{r} \\left[ (\\cos\\theta\\cos\\zeta)(-rR\\cos\\theta\\cos\\zeta) + (\\cos\\theta\\sin\\zeta)(-rR\\cos\\theta\\sin\\zeta) + (\\sin\\theta)(-rR\\sin\\theta) \\right] = -R\n$$\nSo, $J = -(R_0 + r\\cos\\theta)$. The negative sign indicates that the coordinate system $(\\psi, \\theta, \\zeta)$ is left-handed.\n\n**4. Magnetic Field Representation**\n\nThe magnetic field is constructed using the Clebsch representation $\\mathbf{B} = \\nabla\\psi \\times \\nabla\\alpha$, with the Clebsch potential $\\alpha = \\zeta - q(\\psi)\\theta$. The gradients of the scalar fields $\\psi$ and $\\alpha$ are expressed in the contravariant basis $b^i$ as $\\nabla f = \\sum_i (\\partial f/\\partial u^i) b^i$.\n$$\n\\nabla\\psi = b^\\psi\n$$\n$$\n\\nabla\\alpha = \\frac{\\partial\\alpha}{\\partial\\psi}b^\\psi + \\frac{\\partial\\alpha}{\\partial\\theta}b^\\theta + \\frac{\\partial\\alpha}{\\partial\\zeta}b^\\zeta = -q'(\\psi)\\theta \\,b^\\psi - q(\\psi) \\,b^\\theta + 1 \\cdot b^\\zeta\n$$\nwhere $q'(\\psi) = dq/d\\psi$. The magnetic field is then:\n$$\n\\mathbf{B} = b^\\psi \\times \\left(-q'(\\psi)\\theta \\,b^\\psi - q(\\psi) \\,b^\\theta + b^\\zeta\\right) = -q(\\psi)(b^\\psi \\times b^\\theta) + (b^\\psi \\times b^\\zeta)\n$$\nUsing the identity $b^i \\times b^j = \\epsilon^{ijk} a_k / J$, where $\\epsilon^{ijk}$ is the Levi-Civita symbol, we have $b^\\psi \\times b^\\theta = a_\\zeta/J$ and $b^\\psi \\times b^\\zeta = -a_\\theta/J$. Substituting these gives:\n$$\n\\mathbf{B} = -q(\\psi)\\frac{a_\\zeta}{J} - \\frac{a_\\theta}{J} = \\frac{1}{-J}\\left( a_\\theta + q(\\psi)a_\\zeta \\right) = \\frac{1}{R}\\left( a_\\theta + q(\\psi)a_\\zeta \\right)\n$$\nTo find the contravariant components $B^i$ required for the divergence formula, we project $\\mathbf{B}$ onto the contravariant basis vectors: $B^i = \\mathbf{B} \\cdot b^i$.\n$$\nB^\\psi = \\mathbf{B} \\cdot b^\\psi = \\frac{1}{R}(a_\\theta + q a_\\zeta)\\cdot b^\\psi = 0\n$$\n$$\nB^\\theta = \\mathbf{B} \\cdot b^\\theta = \\frac{1}{R}(a_\\theta + q a_\\zeta)\\cdot b^\\theta = \\frac{1}{R}(1 + 0) = \\frac{1}{R}\n$$\n$$\nB^\\zeta = \\mathbf{B} \\cdot b^\\zeta = \\frac{1}{R}(a_\\theta + q a_\\zeta)\\cdot b^\\zeta = \\frac{1}{R}(0 + q) = \\frac{q(\\psi)}{R}\n$$\nSo the contravariant components are $B^\\psi=0$, $B^\\theta=1/R$, and $B^\\zeta=q(\\psi)/R$.\n\n**5. Numerical Divergence Calculation**\n\nThe problem provides the divergence formula for a vector field $\\mathbf{A} = \\sum_i A^i a_i$:\n$$\n\\nabla\\cdot\\mathbf{A} = \\frac{1}{J}\\left(\\frac{\\partial}{\\partial\\psi}(J A^\\psi) + \\frac{\\partial}{\\partial\\theta}(J A^\\theta) + \\frac{\\partial}{\\partial\\zeta}(J A^\\zeta)\\right)\n$$\nSubstituting our components $B^i$ and Jacobian $J=-R$:\n$$\nJ B^\\psi = (-R)(0) = 0\n$$\n$$\nJ B^\\theta = (-R)\\left(\\frac{1}{R}\\right) = -1\n$$\n$$\nJ B^\\zeta = (-R)\\left(\\frac{q(\\psi)}{R}\\right) = -q(\\psi)\n$$\nThe divergence expression becomes:\n$$\n\\nabla\\cdot\\mathbf{B} = \\frac{1}{J}\\left(\\frac{\\partial}{\\partial\\psi}(0) + \\frac{\\partial}{\\partial\\theta}(-1) + \\frac{\\partial}{\\partial\\zeta}(-q(\\psi))\\right)\n$$\nAnalytically, each partial derivative is zero, so $\\nabla\\cdot\\mathbf{B} = 0$. The numerical task is to discretize this calculation. The partial derivatives $\\partial/\\partial\\theta$ and $\\partial/\\partial\\zeta$ are computed using second-order periodic central finite differences. The numerical result for $\\nabla\\cdot\\mathbf{B}$ will be a small, non-zero value representative of the floating-point inaccuracies and finite-difference errors, which we quantify by its maximum absolute value over the grid.\n\n**Numerical Implementation Strategy**\n\nThe Python implementation will proceed as follows:\n1.  For each test case, define a uniform 3D grid for $(\\psi, \\theta, \\zeta)$ using `numpy.meshgrid`.\n2.  Calculate the Cartesian components of the covariant basis vectors $a_\\psi, a_\\theta, a_\\zeta$ at each grid point using the analytical formulas.\n3.  Compute the nine components of the metric tensor $g_{ij} = a_i \\cdot a_j$.\n4.  Calculate the maximum symmetry residual, $\\max|g_{ij} - g_{ji}|$, which is expected to be $0.0$.\n5.  Compute the Jacobian $J = a_\\psi \\cdot (a_\\theta \\times a_\\zeta)$ numerically.\n6.  Calculate the contravariant field components $B^\\theta$ and $B^\\zeta$.\n7.  Compute the quantities $J B^\\theta$ and $J B^\\zeta$.\n8.  Numerically differentiate $J B^\\theta$ with respect to $\\theta$ and $J B^\\zeta$ with respect to $\\zeta$ using periodic central differencing.\n9.  Combine terms to compute $\\nabla\\cdot\\mathbf{B}$ and find its maximum absolute value over the grid.\n10. Store the two metrics (divergence and symmetry) for each case and format the final output.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print the results.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: Happy path\n        {'R0': 3.0, 'a': 0.5, 'psi_min': 1e-4, 'q0': 1.2, 's': 1.0, 'grid_size': (33, 64, 32)},\n        # Case 2: Near-axis boundary\n        {'R0': 3.0, 'a': 0.5, 'psi_min': 1e-9, 'q0': 1.0, 's': 0.0, 'grid_size': (17, 32, 8)},\n        # Case 3: High shear\n        {'R0': 3.0, 'a': 0.5, 'psi_min': 1e-4, 'q0': 2.0, 's': 50.0, 'grid_size': (25, 48, 24)},\n    ]\n\n    results = []\n    for case_params in test_cases:\n        result = compute_metrics(**case_params)\n        results.append(result)\n\n    # Format the final output string as a list of lists.\n    output_str = \"[\" + \",\".join([f\"[{div},{sym}]\" for div, sym in results]) + \"]\"\n    print(output_str)\n\ndef compute_metrics(R0, a, psi_min, q0, s, grid_size):\n    \"\"\"\n    Computes verification metrics for a single test case.\n    \"\"\"\n    N_psi, N_theta, N_zeta = grid_size\n    psi_max = a**2 / 2.0\n\n    # 1. Construct uniform grids\n    psi_1d = np.linspace(psi_min, psi_max, N_psi)\n    theta_1d = np.linspace(0, 2 * np.pi, N_theta, endpoint=False)\n    zeta_1d = np.linspace(0, 2 * np.pi, N_zeta, endpoint=False)\n\n    dpsi = psi_1d[1] - psi_1d[0]\n    dtheta = theta_1d[1] - theta_1d[0]\n    dzeta = zeta_1d[1] - zeta_1d[0]\n\n    PSI, THETA, ZETA = np.meshgrid(psi_1d, theta_1d, zeta_1d, indexing='ij')\n\n    # Geometric quantities on the grid\n    r = np.sqrt(2 * PSI)\n    R = R0 + r * np.cos(THETA)\n    \n    # 2. Covariant basis vectors a_i\n    # Each a_i is a tuple of its (x, y, z) components, which are 3D arrays.\n    dr_dpsi = 1.0 / r\n    a_psi = (dr_dpsi * np.cos(THETA) * np.cos(ZETA),\n             dr_dpsi * np.cos(THETA) * np.sin(ZETA),\n             dr_dpsi * np.sin(THETA))\n    \n    a_theta = (-r * np.sin(THETA) * np.cos(ZETA),\n               -r * np.sin(THETA) * np.sin(ZETA),\n               r * np.cos(THETA))\n               \n    a_zeta = (-R * np.sin(ZETA),\n              R * np.cos(ZETA),\n              np.zeros_like(R))\n\n    # Helper function for dot product of two vector fields\n    def dot_product(v1, v2):\n        return v1[0] * v2[0] + v1[1] * v2[1] + v1[2] * v2[2]\n\n    # 3. Metric coefficients g_ij and symmetry residual\n    g_psitheta = dot_product(a_psi, a_theta)\n    g_psizeta = dot_product(a_psi, a_zeta)\n    g_thetazeta = dot_product(a_theta, a_zeta)\n    \n    g_thetapsi = dot_product(a_theta, a_psi)\n    g_zetapsi = dot_product(a_zeta, a_psi)\n    g_zetatheta = dot_product(a_zeta, a_theta)\n\n    res1 = np.max(np.abs(g_psitheta - g_thetapsi))\n    res2 = np.max(np.abs(g_psizeta - g_zetapsi))\n    res3 = np.max(np.abs(g_thetazeta - g_zetatheta))\n    max_sym_res = max(res1, res2, res3)\n\n    # 4. Jacobian J\n    # J = a_psi . (a_theta x a_zeta)\n    cross_theta_zeta_x = a_theta[1] * a_zeta[2] - a_theta[2] * a_zeta[1]\n    cross_theta_zeta_y = a_theta[2] * a_zeta[0] - a_theta[0] * a_zeta[2]\n    cross_theta_zeta_z = a_theta[0] * a_zeta[1] - a_theta[1] * a_zeta[0]\n    J = a_psi[0] * cross_theta_zeta_x + a_psi[1] * cross_theta_zeta_y + a_psi[2] * cross_theta_zeta_z\n    \n    # 5. Magnetic field contravariant components B^i\n    q = q0 + s * PSI\n    B_theta = 1.0 / R\n    B_zeta = q / R\n\n    # 6. Numerical divergence of B\n    # Compute fluxes J*B^i\n    Flux_theta = J * B_theta\n    Flux_zeta = J * B_zeta\n    \n    # Derivatives using second-order periodic central differences\n    # d(F_theta)/d(theta)\n    dF_theta_dtheta = (np.roll(Flux_theta, -1, axis=1) - np.roll(Flux_theta, 1, axis=1)) / (2 * dtheta)\n    \n    # d(F_zeta)/d(zeta)\n    dF_zeta_dzeta = (np.roll(Flux_zeta, -1, axis=2) - np.roll(Flux_zeta, 1, axis=2)) / (2 * dzeta)\n    \n    # Divergence calculation. Note: d(J*B^psi)/d(psi) term is zero.\n    div_B = (1.0 / J) * (dF_theta_dtheta + dF_zeta_dzeta)\n    max_abs_divB = np.max(np.abs(div_B))\n    \n    return max_abs_divB, max_sym_res\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}