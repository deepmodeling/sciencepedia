{
    "hands_on_practices": [
        {
            "introduction": "The gyrokinetic model is built upon a solid foundation of ordering assumptions, which simplify the complex particle dynamics in a magnetized plasma. This practice problem allows you to verify these assumptions firsthand by calculating the fundamental gyrokinetic ordering parameters for a typical tokamak core plasma. By connecting abstract theoretical parameters to concrete physical values, you will develop a deeper intuition for the validity and scope of the gyrokinetic framework. ",
            "id": "4191352",
            "problem": "A tokamak core is modeled for a Gyrokinetic Large-Eddy Simulation (LES) with Subgrid-Scale (SGS) modeling using standard, monotonic exponential profiles. Assume an axisymmetric equilibrium with uniform magnetic field magnitude in the core. The device parameters are: magnetic field $B_{0} = 3.0~\\text{T}$, major radius $R_{0} = 3.0~\\text{m}$, minor radius $a = 1.0~\\text{m}$. The ion species is deuterium with mass $m_{i} = 2 m_{p}$, where the proton mass is $m_{p} = 1.67262192369 \\times 10^{-27}~\\text{kg}$, and the elementary charge is $e = 1.602176634 \\times 10^{-19}~\\text{C}$. The core particle density and ion temperature profiles are\n$$\nn(r) = n_{0} \\exp\\!\\left(-\\frac{r}{L_{n}}\\right), \\quad T_{i}(r) = T_{0} \\exp\\!\\left(-\\frac{r}{L_{T}}\\right),\n$$\nwith $n_{0} = 8.0 \\times 10^{19}~\\text{m}^{-3}$, $T_{0} = 6.0~\\text{keV}$, $L_{n} = 0.40~\\text{m}$, and $L_{T} = 0.30~\\text{m}$. Consider the mid-radius location $r = a/2$.\n\nThe LES filter width is $\\Delta = 0.030~\\text{m}$, and the resolved binormal wavenumber used to characterize the dominant eddies is $k_{y} = \\frac{1}{2} \\frac{\\pi}{\\Delta}$.\n\nUsing the following well-tested definitions:\n- Ion thermal speed $v_{\\text{thi}} = \\sqrt{\\frac{2 T_{i}}{m_{i}}}$,\n- Ion cyclotron frequency $\\Omega_{i} = \\frac{e B_{0}}{m_{i}}$,\n- Ion gyroradius $\\rho_{i} = \\frac{v_{\\text{thi}}}{\\Omega_{i}}$,\n- Macroscopic gradient scale $L = \\min(L_{n}, L_{T})$,\n- Ion diamagnetic drift frequency in a slab approximation $\\omega_{*i} = k_{y} \\frac{T_{i}}{e B_{0} L_{n}}$,\n- Thermal magnetic curvature drift frequency magnitude $\\omega_{di} \\approx k_{y} \\frac{v_{\\text{thi}}^{2}}{2 \\Omega_{i} R_{0}}$,\n\nevaluate at $r = a/2$ the three small-parameter ratios\n$$\n\\epsilon_{1} = \\frac{\\rho_{i}}{L}, \\quad \\epsilon_{2} = \\frac{\\omega_{*i}}{\\Omega_{i}}, \\quad \\epsilon_{3} = \\frac{\\omega_{di}}{\\Omega_{i}}.\n$$\nThen, compute the largest of $\\epsilon_{1}$, $\\epsilon_{2}$, and $\\epsilon_{3}$ as a single real number. Express the final answer as a dimensionless quantity and round your answer to three significant figures.",
            "solution": "The problem statement passes validation. It is scientifically grounded in the principles of plasma physics and gyrokinetics, well-posed with all necessary information provided, and objective in its language. The parameters given are consistent with typical tokamak operation, and the definitions are standard within the field. Therefore, a complete solution will be provided.\n\nThe objective is to calculate three dimensionless ratios, $\\epsilon_{1}$, $\\epsilon_{2}$, and $\\epsilon_{3}$, which are fundamental ordering parameters in gyrokinetic theory, at the specified location within the tokamak core, and then to identify the largest of these three values.\n\nThe analysis is to be performed at the mid-radius location, which is given by $r = a/2$. With the minor radius $a = 1.0~\\text{m}$, the location of interest is $r = 0.5~\\text{m}$.\n\nFirst, we must determine the local ion temperature, $T_{i}$, at this radius. The temperature profile is given by $T_{i}(r) = T_{0} \\exp(-r/L_{T})$, with $T_{0} = 6.0~\\text{keV}$ and $L_{T} = 0.30~\\text{m}$. At $r=0.5~\\text{m}$, the temperature is:\n$$\nT_{i}(r=0.5~\\text{m}) = (6.0~\\text{keV}) \\exp\\left(-\\frac{0.5~\\text{m}}{0.30~\\text{m}}\\right) = (6.0~\\text{keV}) \\exp\\left(-\\frac{5}{3}\\right)\n$$\nFor consistency in SI units, we must convert the temperature from kiloelectron-volts ($keV$) to Joules ($J$). Using the elementary charge $e = 1.602176634 \\times 10^{-19}~\\text{C}$, the conversion is $1~\\text{eV} = 1.602176634 \\times 10^{-19}~\\text{J}$.\n$$\nT_{i} = 6.0 \\times 10^{3} \\exp\\left(-\\frac{5}{3}\\right) \\times (1.602176634 \\times 10^{-19})~\\text{J} \\approx 1.81560 \\times 10^{-16}~\\text{J}.\n$$\n\nNext, we compute the necessary physical quantities for the ratios.\nThe ion mass for deuterium is $m_{i} = 2 m_{p}$, where $m_{p} = 1.67262192369 \\times 10^{-27}~\\text{kg}$.\n$$\nm_{i} = 2 \\times (1.67262192369 \\times 10^{-27}~\\text{kg}) = 3.34524384738 \\times 10^{-27}~\\text{kg}.\n$$\nThe ion gyroradius, $\\rho_{i}$, is defined as $\\rho_{i} = v_{\\text{thi}}/\\Omega_{i}$. Using the given definitions for ion thermal speed $v_{\\text{thi}} = \\sqrt{2 T_{i} / m_{i}}$ and ion cyclotron frequency $\\Omega_{i} = e B_{0} / m_{i}$, we can write $\\rho_{i}$ as:\n$$\n\\rho_{i} = \\frac{\\sqrt{2 T_{i} / m_{i}}}{e B_{0} / m_{i}} = \\frac{\\sqrt{2 T_{i} m_{i}}}{e B_{0}}\n$$\nSubstituting the values for $T_{i}$, $m_{i}$, $e$, and $B_{0} = 3.0~\\text{T}$:\n$$\n\\rho_{i} = \\frac{\\sqrt{2 \\times (1.81560 \\times 10^{-16}~\\text{J}) \\times (3.34524 \\times 10^{-27}~\\text{kg})}}{(1.602176634 \\times 10^{-19}~\\text{C}) \\times (3.0~\\text{T})} \\approx 0.0022931~\\text{m}.\n$$\nThe macroscopic gradient scale length, $L$, is the minimum of the density and temperature gradient scale lengths:\n$$\nL = \\min(L_{n}, L_{T}) = \\min(0.40~\\text{m}, 0.30~\\text{m}) = 0.30~\\text{m}.\n$$\nThe binormal wavenumber, $k_{y}$, is given by:\n$$\nk_{y} = \\frac{1}{2} \\frac{\\pi}{\\Delta} = \\frac{\\pi}{2 \\times 0.030~\\text{m}} = \\frac{\\pi}{0.060}~\\text{m}^{-1} \\approx 52.3599~\\text{m}^{-1}.\n$$\n\nNow we can evaluate the three dimensionless ratios.\n\n1.  The ratio $\\epsilon_{1} = \\rho_{i}/L$:\n    $$\n    \\epsilon_{1} = \\frac{0.0022931~\\text{m}}{0.30~\\text{m}} \\approx 0.0076437.\n    $$\n\n2.  The ratio $\\epsilon_{2} = \\omega_{*i}/\\Omega_{i}$:\n    Using the definitions $\\omega_{*i} = k_{y} \\frac{T_{i}}{e B_{0} L_{n}}$ and $\\Omega_{i} = \\frac{e B_{0}}{m_{i}}$, we can express $\\epsilon_2$ as:\n    $$\n    \\epsilon_{2} = \\frac{\\omega_{*i}}{\\Omega_{i}} = \\frac{k_{y} T_{i} m_{i}}{(e B_{0})^{2} L_{n}}\n    $$\n    This can be simplified by recognizing that $\\rho_{i}^{2} = \\frac{2 T_{i} m_{i}}{(e B_{0})^{2}}$. Therefore:\n    $$\n    \\epsilon_{2} = \\frac{k_{y} \\rho_{i}^{2}}{2 L_{n}}\n    $$\n    Substituting the values for $k_{y}$, $\\rho_{i}$, and $L_{n} = 0.40~\\text{m}$:\n    $$\n    \\epsilon_{2} = \\frac{(52.3599~\\text{m}^{-1}) \\times (0.0022931~\\text{m})^{2}}{2 \\times (0.40~\\text{m})} \\approx \\frac{2.7525 \\times 10^{-4}~\\text{m}}{0.80~\\text{m}} \\approx 0.00034406.\n    $$\n\n3.  The ratio $\\epsilon_{3} = \\omega_{di}/\\Omega_{i}$:\n    Using the approximation $\\omega_{di} \\approx k_{y} \\frac{v_{\\text{thi}}^{2}}{2 \\Omega_{i} R_{0}}$, we find $\\epsilon_3$:\n    $$\n    \\epsilon_{3} = \\frac{\\omega_{di}}{\\Omega_{i}} \\approx k_{y} \\frac{v_{\\text{thi}}^{2}}{2 \\Omega_{i}^{2} R_{0}}\n    $$\n    Since $v_{\\text{thi}} = \\rho_{i} \\Omega_{i}$, this expression simplifies to:\n    $$\n    \\epsilon_{3} = \\frac{k_{y} (\\rho_{i}\\Omega_{i})^{2}}{2 \\Omega_{i}^{2} R_{0}} = \\frac{k_{y} \\rho_{i}^{2}}{2 R_{0}}\n    $$\n    Substituting the values for $k_{y}$, $\\rho_{i}$, and $R_{0} = 3.0~\\text{m}$:\n    $$\n    \\epsilon_{3} = \\frac{(52.3599~\\text{m}^{-1}) \\times (0.0022931~\\text{m})^{2}}{2 \\times (3.0~\\text{m})} \\approx \\frac{2.7525 \\times 10^{-4}~\\text{m}}{6.0~\\text{m}} \\approx 0.000045875.\n    $$\n\nFinally, we compare the three ratios to find the largest:\n$$\n\\epsilon_{1} \\approx 0.0076437 \\\\\n\\epsilon_{2} \\approx 0.0003441 \\\\\n\\epsilon_{3} \\approx 0.0000459\n$$\nThe largest of these is $\\epsilon_{1}$. The problem requires this value rounded to three significant figures.\n$$\n\\max(\\epsilon_{1}, \\epsilon_{2}, \\epsilon_{3}) = \\epsilon_{1} \\approx 0.0076437 \\approx 0.00764.\n$$",
            "answer": "$$\n\\boxed{0.00764}\n$$"
        },
        {
            "introduction": "A key challenge in applying Large-Eddy Simulation (LES) to inhomogeneous systems like tokamaks is that the filtering and differentiation operations do not commute. This practice delves into this advanced topic, tasking you with deriving the commutation error that arises from spatial variations in the plasma geometry and the filter definition. This exercise is crucial for understanding the origin of complex terms in the filtered gyrokinetic equations and appreciating the subtleties of subgrid-scale modeling in fusion devices. ",
            "id": "4191370",
            "problem": "In gyrokinetic Large Eddy Simulation (LES) of magnetized plasma turbulence, spatial filtering is performed in field-aligned coordinates to separate resolved and subgrid scales. Consider straight-field-line flux coordinates $(\\psi,\\theta,\\zeta)$, where $\\psi$ is a flux label (radial-like), $\\theta$ is the poloidal angle, and $\\zeta$ is the toroidal angle. At fixed $\\psi$ and $\\zeta$, define a one-dimensional poloidal Gaussian filter that preserves the metric weight through the Jacobian $J(\\psi,\\theta)$:\n$$\n\\overline{a}(\\psi,\\theta) \\equiv \\frac{\\displaystyle \\int_{-\\infty}^{\\infty} a(\\psi,\\theta+s)\\,J(\\psi,\\theta+s)\\,K_{\\Delta(\\psi)}(s)\\,\\mathrm{d}s}{\\displaystyle \\int_{-\\infty}^{\\infty} J(\\psi,\\theta+s)\\,K_{\\Delta(\\psi)}(s)\\,\\mathrm{d}s},\n$$\nwith the Gaussian kernel\n$$\nK_{\\Delta(\\psi)}(s) \\equiv \\frac{1}{\\sqrt{2\\pi}\\,\\Delta(\\psi)}\\exp\\!\\left(-\\frac{s^2}{2\\,\\Delta(\\psi)^2}\\right),\n$$\nwhere $\\Delta(\\psi)$ is a radially varying filter width. Let the tokamak geometry be large-aspect-ratio and weakly inhomogeneous in the poloidal direction, modeled by\n$$\nJ(\\psi,\\theta) = J_0(\\psi)\\,\\bigl[1+\\epsilon(\\psi)\\cos\\theta\\bigr],\n$$\nwith $|\\epsilon(\\psi)| \\ll 1$.\n\nUsing only the above definitions and standard Taylorâ€“moment expansions of smooth functions, work in the narrow-filter limit and retain contributions through $\\mathcal{O}(\\Delta(\\psi)^2)$ and linear order in $\\epsilon(\\psi)$. Consider the radial derivative operator $\\partial_{\\psi}$ and the commutator between filtering and differentiation acting on the test field\n$$\na(\\psi,\\theta) = g(\\psi)\\cos\\theta,\n$$\nwhere $g(\\psi)$ is a smooth amplitude. Derive the leading-order commutator\n$$\n\\mathcal{C}(\\psi,\\theta) \\equiv \\overline{\\partial_{\\psi} a}(\\psi,\\theta) - \\partial_{\\psi}\\overline{a}(\\psi,\\theta),\n$$\nand evaluate it at $\\theta=\\pi/2$ and at an arbitrary radius $\\psi=\\psi_0$.\n\nYour final answer must be a single closed-form analytic expression for $\\mathcal{C}(\\psi_0,\\pi/2)$, expressed in terms of $g(\\psi_0)$, $\\Delta(\\psi_0)$, $\\Delta'(\\psi_0)$, $\\epsilon(\\psi_0)$, and $\\epsilon'(\\psi_0)$, valid to the stated orders. No numerical evaluation is required. Additionally, in your derivation, identify sufficient conditions (to the same order) under which $\\partial_{\\psi}$ commutes with the filter for all smooth $a(\\psi,\\theta)$. The final boxed answer should contain only the requested analytic expression with no units or extraneous symbols.",
            "solution": "The problem is first validated against the established criteria.\n\n### Step 1: Extract Givens\n- Field-aligned coordinates: $(\\psi, \\theta, \\zeta)$.\n- Poloidal Gaussian filter definition for a quantity $a(\\psi,\\theta)$:\n$$\n\\overline{a}(\\psi,\\theta) \\equiv \\frac{\\displaystyle \\int_{-\\infty}^{\\infty} a(\\psi,\\theta+s)\\,J(\\psi,\\theta+s)\\,K_{\\Delta(\\psi)}(s)\\,\\mathrm{d}s}{\\displaystyle \\int_{-\\infty}^{\\infty} J(\\psi,\\theta+s)\\,K_{\\Delta(\\psi)}(s)\\,\\mathrm{d}s}\n$$\n- Gaussian kernel:\n$$\nK_{\\Delta(\\psi)}(s) \\equiv \\frac{1}{\\sqrt{2\\pi}\\,\\Delta(\\psi)}\\exp\\!\\left(-\\frac{s^2}{2\\,\\Delta(\\psi)^2}\\right)\n$$\n- Jacobian:\n$$\nJ(\\psi,\\theta) = J_0(\\psi)\\,\\bigl[1+\\epsilon(\\psi)\\cos\\theta\\bigr]\n$$\n- Test field:\n$$\na(\\psi,\\theta) = g(\\psi)\\cos\\theta\n$$\n- Commutator to be derived:\n$$\n\\mathcal{C}(\\psi,\\theta) \\equiv \\overline{\\partial_{\\psi} a}(\\psi,\\theta) - \\partial_{\\psi}\\overline{a}(\\psi,\\theta)\n$$\n- Approximations: Narrow-filter limit, retain terms through $\\mathcal{O}(\\Delta(\\psi)^2)$ and linear in $\\epsilon(\\psi)$, where $|\\epsilon(\\psi)| \\ll 1$.\n- Evaluation point: $\\theta=\\pi/2$ and $\\psi=\\psi_0$.\n- Additional task: Identify sufficient conditions for the commutator to be zero for any smooth field $a(\\psi, \\theta)$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, being a standard calculation in the theory of Large Eddy Simulation (LES) for turbulence, specifically concerning the commutation error between filtering and differentiation operators in a non-uniform medium. The mathematical setup, involving integral definitions and Taylor series expansions, is rigorous and well-defined. The problem is self-contained, providing all necessary definitions and constraints. The language is objective and precise. No scientific, mathematical, or logical flaws are identified. The problem is deemed valid.\n\n### Step 3: Verdict and Action\nThe problem is valid. A complete, reasoned solution will be provided.\n\n### Derivation of the Filtered Field\nFirst, we simplify the filter definition. The factor $J_0(\\psi)$ is independent of the integration variable $s$ and thus cancels from the numerator and denominator. The filter becomes:\n$$\n\\overline{a}(\\psi,\\theta) = \\frac{\\displaystyle \\int_{-\\infty}^{\\infty} a(\\psi,\\theta+s)\\,\\bigl[1+\\epsilon(\\psi)\\cos(\\theta+s)\\bigr]\\,K_{\\Delta}(s)\\,\\mathrm{d}s}{\\displaystyle \\int_{-\\infty}^{\\infty} \\bigl[1+\\epsilon(\\psi)\\cos(\\theta+s)\\bigr]\\,K_{\\Delta}(s)\\,\\mathrm{d}s}\n$$\nwhere we use $\\Delta$ for $\\Delta(\\psi)$ and $\\epsilon$ for $\\epsilon(\\psi)$ for brevity. We expand the quantities in the integrands in a Taylor series for small $s$, which is justified by the narrow-filter limit. We need the moments of the Gaussian kernel:\n$\\int_{-\\infty}^{\\infty} s^n K_{\\Delta}(s) \\, \\mathrm{d}s$. For $n=0,1,2,3,4$, these are $1, 0, \\Delta^2, 0, 3\\Delta^4$.\n\nLet's evaluate the denominator, $D$, first, up to order $\\mathcal{O}(\\Delta^2)$ and linear in $\\epsilon$:\n$$\nD = \\int_{-\\infty}^{\\infty} [1+\\epsilon\\cos(\\theta+s)] K_{\\Delta}(s)\\,\\mathrm{d}s = 1 + \\epsilon \\int_{-\\infty}^{\\infty} (\\cos\\theta\\cos s - \\sin\\theta\\sin s) K_{\\Delta}(s)\\,\\mathrm{d}s\n$$\nWe expand $\\cos s \\approx 1-s^2/2$ and $\\sin s \\approx s$. Integrating against the kernel gives:\n$$\nD = 1 + \\epsilon (\\cos\\theta \\langle 1-s^2/2 \\rangle_K - \\sin\\theta \\langle s \\rangle_K) = 1 + \\epsilon\\cos\\theta(1-\\Delta^2/2) = 1 + \\epsilon\\cos\\theta - \\frac{\\epsilon\\Delta^2}{2}\\cos\\theta\n$$\nThe inverse is $D^{-1} \\approx (1+\\epsilon\\cos\\theta)^{-1} \\approx 1-\\epsilon\\cos\\theta$ to leading order in $\\epsilon$. Keeping the $\\epsilon\\Delta^2$ correction:\n$D^{-1} \\approx (1 + \\epsilon\\cos\\theta(1-\\Delta^2/2))^{-1} \\approx 1 - \\epsilon\\cos\\theta(1-\\Delta^2/2) \\approx 1 - \\epsilon\\cos\\theta + \\frac{\\epsilon\\Delta^2}{2}\\cos\\theta$.\n\nNow we evaluate the numerator, $N$, expanding $a(\\psi,\\theta+s)$ and $\\cos(\\theta+s)$ to second order in $s$:\n$a(\\psi,\\theta+s) \\approx a + s\\partial_\\theta a + \\frac{s^2}{2}\\partial^2_\\theta a$\n$\\cos(\\theta+s) \\approx \\cos\\theta - s\\sin\\theta - \\frac{s^2}{2}\\cos\\theta$\nThe integrand of the numerator is $[a(\\psi,\\theta+s)][1+\\epsilon\\cos(\\theta+s)]K_\\Delta(s)$.\n$N = \\int \\left(a + s\\partial_\\theta a + \\frac{s^2}{2}\\partial^2_\\theta a\\right) \\left[1+\\epsilon\\left(\\cos\\theta - s\\sin\\theta - \\frac{s^2}{2}\\cos\\theta\\right)\\right] K_\\Delta(s) \\,\\mathrm{d}s$.\nIntegrating term by term, keeping contributions to $\\mathcal{O}(\\Delta^2)$ and linear in $\\epsilon$:\n$$\nN = \\left( a + \\frac{\\Delta^2}{2}\\partial^2_\\theta a \\right) + \\epsilon \\left( a\\cos\\theta - \\Delta^2\\sin\\theta\\partial_\\theta a - \\frac{\\Delta^2}{2}a\\cos\\theta + \\frac{\\Delta^2}{2}\\cos\\theta\\partial^2_\\theta a \\right)\n$$\nThen $\\overline{a} = N D^{-1}$. We multiply $N$ by $D^{-1}$, retaining terms of order $\\mathcal{O}(\\Delta^2)$ and $\\mathcal{O}(\\epsilon\\Delta^2)$:\n$$\n\\overline{a} \\approx \\left[ a + \\frac{\\Delta^2}{2}\\partial^2_\\theta a + \\epsilon a\\cos\\theta + \\mathcal{O}(\\epsilon\\Delta^2) \\right] \\left( 1 - \\epsilon\\cos\\theta + \\frac{\\epsilon\\Delta^2}{2}\\cos\\theta \\right) + \\epsilon\\left(-\\Delta^2\\sin\\theta\\partial_\\theta a - \\frac{\\Delta^2}{2}a\\cos\\theta + \\frac{\\Delta^2}{2}\\cos\\theta\\partial^2_\\theta a\\right)\n$$\nExpanding and simplifying:\n$$\n\\overline{a} = a + \\frac{\\Delta^2}{2}\\partial^2_\\theta a - a\\epsilon\\cos\\theta + a\\frac{\\epsilon\\Delta^2}{2}\\cos\\theta + \\epsilon a\\cos\\theta - \\epsilon\\Delta^2\\sin\\theta\\partial_\\theta a - \\epsilon\\frac{\\Delta^2}{2}a\\cos\\theta + \\epsilon\\frac{\\Delta^2}{2}\\cos\\theta\\partial^2_\\theta a + \\mathcal{O}(\\epsilon^2, \\Delta^4)\n$$\nMany terms cancel, leaving the expression for the filtered field:\n$$\n\\overline{a}(\\psi,\\theta) = a + \\frac{\\Delta^2}{2}\\partial^2_\\theta a - \\epsilon\\Delta^2\\sin\\theta\\partial_\\theta a + \\frac{\\epsilon\\Delta^2}{2}\\cos\\theta\\partial^2_\\theta a\n$$\nThis is the general expression for any smooth field $a(\\psi, \\theta)$ to the required order.\n\n### Derivation of the Commutator\nWe need to calculate $\\mathcal{C}(\\psi,\\theta) \\equiv \\overline{\\partial_{\\psi} a}(\\psi,\\theta) - \\partial_{\\psi}\\overline{a}(\\psi,\\theta)$.\n\nFirst, let's substitute the test field $a(\\psi,\\theta)=g(\\psi)\\cos\\theta$. Its derivatives are:\n$\\partial_\\theta a = -g\\sin\\theta$ and $\\partial_\\theta^2 a = -g\\cos\\theta$.\nSubstituting these into the expression for $\\overline{a}$:\n$$\n\\overline{a} = g\\cos\\theta + \\frac{\\Delta^2}{2}(-g\\cos\\theta) - \\epsilon\\Delta^2\\sin\\theta(-g\\sin\\theta) + \\frac{\\epsilon\\Delta^2}{2}\\cos\\theta(-g\\cos\\theta)\n$$\n$$\n\\overline{a}(\\psi,\\theta) = g\\cos\\theta - \\frac{g\\Delta^2}{2}\\cos\\theta + \\epsilon g\\Delta^2\\sin^2\\theta - \\frac{\\epsilon g\\Delta^2}{2}\\cos^2\\theta\n$$\nNow we compute the two terms of the commutator.\n\n1.  $\\overline{\\partial_{\\psi} a}(\\psi,\\theta)$:\n    The field to be filtered is $\\partial_\\psi a = g'(\\psi)\\cos\\theta$. We can find the result by replacing $g$ with $g'$ in the expression for $\\overline{a}$:\n    $$\n    \\overline{\\partial_{\\psi} a} = g'\\cos\\theta - \\frac{g'\\Delta^2}{2}\\cos\\theta + \\epsilon g'\\Delta^2\\sin^2\\theta - \\frac{\\epsilon g'\\Delta^2}{2}\\cos^2\\theta\n    $$\n\n2.  $\\partial_{\\psi}\\overline{a}(\\psi,\\theta)$:\n    We differentiate the expression for $\\overline{a}$ with respect to $\\psi$, remembering that $g, \\Delta$, and $\\epsilon$ are functions of $\\psi$. Using the product rule $\\partial_\\psi(f_1 f_2 ...)=f_1'f_2... + f_1f_2'...$, we get:\n    $$\n    \\partial_{\\psi}\\overline{a} = \\partial_\\psi(g\\cos\\theta) - \\partial_\\psi\\left(\\frac{g\\Delta^2}{2}\\cos\\theta\\right) + \\partial_\\psi(\\epsilon g\\Delta^2\\sin^2\\theta) - \\partial_\\psi\\left(\\frac{\\epsilon g\\Delta^2}{2}\\cos^2\\theta\\right)\n    $$\n    $$\n    \\partial_{\\psi}\\overline{a} = g'\\cos\\theta - \\frac{\\cos\\theta}{2}(g'\\Delta^2 + 2g\\Delta\\Delta') + \\sin^2\\theta(\\epsilon'g\\Delta^2 + \\epsilon g'\\Delta^2 + 2\\epsilon g\\Delta\\Delta') - \\frac{\\cos^2\\theta}{2}(\\epsilon'g\\Delta^2 + \\epsilon g'\\Delta^2 + 2\\epsilon g\\Delta\\Delta')\n    $$\n\nNow, we compute the commutator $\\mathcal{C} = \\overline{\\partial_\\psi a} - \\partial_\\psi\\overline{a}$:\n$$\n\\mathcal{C} = \\left( g'\\cos\\theta - \\frac{g'\\Delta^2}{2}\\cos\\theta + \\epsilon g'\\Delta^2\\sin^2\\theta - \\frac{\\epsilon g'\\Delta^2}{2}\\cos^2\\theta \\right) - \\\\ \\left( g'\\cos\\theta - \\frac{g'\\Delta^2}{2}\\cos\\theta - g\\Delta\\Delta'\\cos\\theta + (\\epsilon'g\\Delta^2 + \\epsilon g'\\Delta^2 + 2\\epsilon g\\Delta\\Delta')\\sin^2\\theta - (\\frac{\\epsilon'g\\Delta^2}{2} + \\frac{\\epsilon g'\\Delta^2}{2} + \\epsilon g\\Delta\\Delta')\\cos^2\\theta \\right)\n$$\nMany terms cancel upon subtraction. We are left with:\n$$\n\\mathcal{C}(\\psi,\\theta) = g\\Delta\\Delta'\\cos\\theta - (\\epsilon'g\\Delta^2 + 2\\epsilon g\\Delta\\Delta')\\sin^2\\theta + (\\frac{\\epsilon'g\\Delta^2}{2} + \\epsilon g\\Delta\\Delta')\\cos^2\\theta\n$$\n\n### Evaluation at the Specified Point\nWe evaluate the commutator at $\\theta=\\pi/2$. At this angle, $\\cos(\\pi/2)=0$ and $\\sin(\\pi/2)=1$.\n$$\n\\mathcal{C}(\\psi,\\pi/2) = g\\Delta\\Delta'(0) - (\\epsilon'g\\Delta^2 + 2\\epsilon g\\Delta\\Delta')(1)^2 + (\\frac{\\epsilon'g\\Delta^2}{2} + \\epsilon g\\Delta\\Delta')(0)^2\n$$\n$$\n\\mathcal{C}(\\psi,\\pi/2) = -g(\\psi)\\epsilon'(\\psi)\\Delta(\\psi)^2 - 2g(\\psi)\\epsilon(\\psi)\\Delta(\\psi)\\Delta'(\\psi)\n$$\nThe problem requests this evaluated at an arbitrary radius $\\psi=\\psi_0$.\n$$\n\\mathcal{C}(\\psi_0, \\pi/2) = -g(\\psi_0)\\epsilon'(\\psi_0)\\Delta(\\psi_0)^2 - 2g(\\psi_0)\\epsilon(\\psi_0)\\Delta(\\psi_0)\\Delta'(\\psi_0)\n$$\nFactoring this expression gives:\n$$\n\\mathcal{C}(\\psi_0, \\pi/2) = -g(\\psi_0)\\Delta(\\psi_0)\\left[ \\epsilon'(\\psi_0)\\Delta(\\psi_0) + 2\\epsilon(\\psi_0)\\Delta'(\\psi_0) \\right]\n$$\nThis expression is equivalent to $-g(\\psi_0)\\left[\\frac{d}{d\\psi}(\\epsilon(\\psi)\\Delta(\\psi)^2)\\right]_{\\psi=\\psi_0}$.\n\n### Conditions for Commutativity\nTo find the sufficient conditions under which $\\partial_\\psi$ and the filter commute for any smooth function $a(\\psi, \\theta)$, we require $\\mathcal{C}(\\psi,\\theta)=0$ for all $a$. We must analyze the general operator form of the commutator.\n$$\n\\mathcal{C}[a] = \\overline{\\partial_\\psi a} - \\partial_\\psi \\overline{a}\n$$\nUsing the general expression for $\\overline{a}$ and applying the same steps as for the test function, we find:\n$$\n\\mathcal{C}[a] = -\\Delta\\Delta'\\partial_\\theta^2 a - \\left(\\frac{d}{d\\psi}(\\epsilon\\Delta^2)\\right)\\left(\\frac{\\cos\\theta}{2}\\partial_\\theta^2 a - \\sin\\theta\\partial_\\theta a\\right)\n$$\n$$\n\\mathcal{C}[a] = -\\Delta\\Delta'\\partial_\\theta^2 a - (\\epsilon'\\Delta^2 + 2\\epsilon\\Delta\\Delta')\\left(\\frac{\\cos\\theta}{2}\\partial_\\theta^2 a - \\sin\\theta\\partial_\\theta a\\right)\n$$\nFor $\\mathcal{C}[a]$ to be identically zero for any smooth $a$, the coefficients of the independent differential operators $(\\partial_\\theta a, \\partial_\\theta^2 a)$ must vanish for all $\\theta$.\nThe coefficient of $\\partial_\\theta a$ is:\n$$\n(\\epsilon'\\Delta^2 + 2\\epsilon\\Delta\\Delta')\\sin\\theta = 0\n$$\nSince this must hold for all $\\theta$, we must have $\\epsilon'\\Delta^2 + 2\\epsilon\\Delta\\Delta' = 0$, which is $\\frac{d}{d\\psi}(\\epsilon\\Delta^2)=0$.\nThe coefficient of $\\partial_\\theta^2 a$ is:\n$$\n-\\Delta\\Delta' - (\\epsilon'\\Delta^2 + 2\\epsilon\\Delta\\Delta')\\frac{\\cos\\theta}{2} = 0\n$$\nUsing the first condition, this simplifies to $-\\Delta\\Delta' = 0$. Since the filter width $\\Delta \\neq 0$, this implies $\\Delta'(\\psi)=0$, meaning $\\Delta$ is constant.\nIf $\\Delta'=0$, the first condition $\\epsilon'\\Delta^2=0$ implies $\\epsilon'(\\psi)=0$, meaning $\\epsilon$ is also constant.\nThus, a sufficient condition for the filter to commute with $\\partial_\\psi$ is that both the filter width $\\Delta$ and the geometric factor $\\epsilon$ are independent of $\\psi$.",
            "answer": "$$ \\boxed{-g(\\psi_0)\\Delta(\\psi_0)\\left[ \\Delta(\\psi_0) \\epsilon'(\\psi_0) + 2 \\epsilon(\\psi_0) \\Delta'(\\psi_0) \\right]} $$"
        },
        {
            "introduction": "Dynamic subgrid-scale models offer great promise, but they can sometimes predict negative dissipation, or \"backscatter,\" which may lead to numerical instability if not properly constrained. This hands-on coding practice guides you through the implementation of a positivity-preserving limiter, a crucial tool for ensuring the stability of a Large-Eddy Simulation. You will learn how to enforce a physical constraint based on the gyrokinetic free-energy balance to control backscatter and maintain a robust and realistic simulation. ",
            "id": "4191297",
            "problem": "You are tasked with implementing and analyzing a positivity-preserving limiter for a dynamically computed subgrid-scale coefficient in a Large-Eddy Simulation (LES) of gyrokinetic plasma turbulence. The goal is to prevent destabilization of the resolved system caused by negative dynamic coefficients while allowing controlled backscatter. Your implementation and analysis must be grounded in the gyrokinetic free-energy balance and must be expressed in dimensionless units throughout.\n\nConsider the gyrokinetic free energy $W(t)$, which in standard gyrokinetic theory is a quadratic invariant in the absence of sources and dissipation. In a reduced, resolved-scale model with a subgrid-scale closure, assume the following balance for the resolved free energy:\n$$\n\\frac{dW}{dt} = P - \\epsilon_{\\mathrm{res}} - \\epsilon_{\\mathrm{sgs}},\n$$\nwhere $P \\ge 0$ is the production due to background gradient drive, $\\epsilon_{\\mathrm{res}} \\ge 0$ is the resolved-scale dissipation, and $\\epsilon_{\\mathrm{sgs}}$ is the subgrid-scale term modeled as\n$$\n\\epsilon_{\\mathrm{sgs}} = C \\, \\phi,\n$$\nwith $C$ being a dynamic coefficient determined from a test-filtering procedure and $\\phi \\ge 0$ a resolved-scale positive definite measure of gradients or strain (for example, a norm of resolved gradients). The coefficient $C$ may be negative, representing backscatter. For numerical stability and physical realism, we require a positivity-preserving limiter that enforces an energy-stability constraint while allowing limited backscatter.\n\nStarting from the free-energy balance and the requirement that net backscatter cannot exceed a fixed fraction of production, derive an explicit limiter that ensures\n$$\n\\epsilon_{\\mathrm{sgs}} \\ge -\\beta P,\n$$\nfor a chosen bound $0 \\le \\beta \\le 1$, and additionally caps excessive dissipation via an upper bound $C \\le C_{\\max}$. The limiter must act on the dynamic coefficient $C_{\\mathrm{raw}}$ to produce a limited coefficient $C_{\\mathrm{lim}}$ such that\n$$\nC_{\\mathrm{lim}} = \\min\\left(C_{\\max}, \\max\\left(C_{\\mathrm{raw}}, C_{\\min}\\right)\\right),\n$$\nwith\n$$\nC_{\\min} = \n\\begin{cases}\n-\\dfrac{\\beta P}{\\phi},  \\phi  0, \\\\\n0,  \\phi = 0.\n\\end{cases}\n$$\nThis ensures $C_{\\mathrm{lim}} \\in [C_{\\min}, C_{\\max}]$, $\\epsilon_{\\mathrm{sgs}} \\ge -\\beta P$, and no backscatter when $\\phi = 0$.\n\nYour program must implement this limiter and compute $C_{\\mathrm{lim}}$ for a given set of test cases. All quantities are dimensionless. For each test case, you will be given the tuple $(C_{\\mathrm{raw}}, P, \\phi, C_{\\max}, \\beta)$.\n\nTest suite:\n- Case 1 (happy path, no clipping): $(0.10, 1.0, 2.0, 0.25, 0.30)$\n- Case 2 (allowed backscatter, no clipping): $(-0.05, 1.0, 2.0, 0.25, 0.30)$\n- Case 3 (negative coefficient clipped by lower bound): $(-0.40, 1.0, 2.0, 0.25, 0.30)$\n- Case 4 (positive coefficient clipped by upper bound): $(0.50, 1.0, 2.0, 0.25, 0.30)$\n- Case 5 (no production, disallow backscatter): $(-0.10, 0.0, 3.0, 0.25, 0.30)$\n- Case 6 (zero gradient, disallow backscatter): $(-1.00, 0.5, 0.0, 0.25, 0.30)$\n- Case 7 (tiny gradient, large lower bound magnitude, no clipping): $(-0.01, 0.5, 10^{-6}, 0.25, 0.30)$\n- Case 8 (upper-bound clipping with moderate production and gradient): $(0.30, 0.2, 0.1, 0.25, 0.30)$\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,...]\"), where each result is the limited coefficient $C_{\\mathrm{lim}}$ for the corresponding test case, rounded to six decimal places.",
            "solution": "The problem is valid. It is scientifically grounded in the principles of gyrokinetic turbulence simulation, mathematically well-posed, and all terms and constraints are objectively defined. We shall proceed with the solution.\n\nThe objective is to implement a physically motivated limiter for a dynamic subgrid-scale (SGS) coefficient, $C$, used in a Large-Eddy Simulation (LES) of gyrokinetic plasma turbulence. The limiter must ensure numerical stability by enforcing an energy constraint, while permitting a controlled amount of energy backscatter from subgrid to resolved scales.\n\nThe starting point is the evolution equation for the resolved-scale free energy, $W(t)$:\n$$\n\\frac{dW}{dt} = P - \\epsilon_{\\mathrm{res}} - \\epsilon_{\\mathrm{sgs}}\n$$\nHere, $P \\ge 0$ is the energy production term, $\\epsilon_{\\mathrm{res}} \\ge 0$ is the resolved-scale dissipation, and $\\epsilon_{\\mathrm{sgs}}$ is the energy transfer to the subgrid scales. For the system to be stable, the total dissipation must balance or exceed production. The SGS term is modeled as:\n$$\n\\epsilon_{\\mathrm{sgs}} = C \\phi\n$$\nwhere $\\phi \\ge 0$ is a positive definite measure of resolved-scale gradients, and $C$ is a dynamically computed coefficient. If $C  0$, $\\epsilon_{\\mathrm{sgs}}  0$ represents forward energy cascade (dissipation from the resolved scales). If $C  0$, $\\epsilon_{\\mathrm{sgs}}  0$ represents backscatter (energy injection into the resolved scales). Uncontrolled backscatter can lead to numerical instability.\n\nThe core of the limiter is the energy-stability constraint, which bounds the amount of permissible backscatter. The net backscatter is not allowed to exceed a specified fraction, $\\beta$, of the energy production, $P$. Mathematically, this is expressed as:\n$$\n\\epsilon_{\\mathrm{sgs}} \\ge -\\beta P\n$$\nwhere $0 \\le \\beta \\le 1$. This inequality ensures that even in the worst-case scenario of maximum backscatter, the SGS term cannot drive an unphysical, explosive growth in resolved energy.\n\nWe derive the lower bound for the limited coefficient, $C_{\\mathrm{lim}}$, by substituting the SGS model into the constraint:\n$$\nC_{\\mathrm{lim}} \\phi \\ge -\\beta P\n$$\nWe must consider two cases for the value of $\\phi$:\n\n1.  Case $\\phi  0$: When there are non-zero resolved gradients, we can divide the inequality by the positive quantity $\\phi$ without changing the direction of the inequality sign:\n    $$\n    C_{\\mathrm{lim}} \\ge -\\frac{\\beta P}{\\phi}\n    $$\n    This inequality defines the minimum allowed value for the limited coefficient. We therefore define the lower bound, $C_{\\min}$, as:\n    $$\n    C_{\\min} = -\\frac{\\beta P}{\\phi}\n    $$\n\n2.  Case $\\phi = 0$: When the resolved-scale gradients are zero, the inequality becomes $C_{\\mathrm{lim}} \\cdot 0 \\ge -\\beta P$, which simplifies to $0 \\ge -\\beta P$. Since both $P \\ge 0$ and $\\beta \\ge 0$, the term $-\\beta P$ is always less than or equal to zero, so the inequality $0 \\ge -\\beta P$ is always satisfied, regardless of the value of $C_{\\mathrm{lim}}$. Thus, the energy constraint itself does not impose a lower bound on $C_{\\mathrm{lim}}$ in this situation. However, a physical consideration is required. A value of $\\phi = 0$ implies that the resolved field is locally \"flat\" at the grid scale. In such a region, it is physically meaningless to have any SGS energy transfer. Therefore, we enforce that there should be no SGS dissipation or backscatter by setting the lower bound to zero. This leads to the definition:\n    $$\n    C_{\\min} = 0\n    $$\n\nCombining these two cases gives the complete definition for the lower bound as specified in the problem:\n$$\nC_{\\min} = \n\\begin{cases}\n-\\dfrac{\\beta P}{\\phi},  \\phi  0, \\\\\n0,  \\phi = 0.\n\\end{cases}\n$$\n\nThe full limiter must clip the raw, dynamically computed coefficient, $C_{\\mathrm{raw}}$, to lie within the permissible range defined by this physically derived lower bound $C_{\\min}$ and a user-specified upper bound $C_{\\max}$, which prevents excessive dissipation. The clipping operation is expressed as:\n$$\nC_{\\mathrm{lim}} = \\min\\left(C_{\\max}, \\max\\left(C_{\\mathrm{raw}}, C_{\\min}\\right)\\right)\n$$\nThis is equivalent to clamping $C_{\\mathrm{raw}}$ to the interval $[C_{\\min}, C_{\\max}]$. The algorithm to compute $C_{\\mathrm{lim}}$ for a given set of parameters $(C_{\\mathrm{raw}}, P, \\phi, C_{\\max}, \\beta)$ is as follows:\n1.  Evaluate the inputs.\n2.  Calculate $C_{\\min}$ based on the conditional logic for $\\phi$.\n3.  Apply the clipping formula to $C_{\\mathrmraw}$ using the calculated $C_{\\min}$ and given $C_{\\max}$.\n4.  Return the resulting $C_{\\mathrm{lim}}$.\n\nThis procedure will be implemented for each of the provided test cases.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements and tests a positivity-preserving limiter for a dynamic SGS coefficient\n    in a gyrokinetic LES context.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    # Each case is a tuple: (C_raw, P, phi, C_max, beta)\n    test_cases = [\n        (0.10, 1.0, 2.0, 0.25, 0.30),    # Case 1\n        (-0.05, 1.0, 2.0, 0.25, 0.30),   # Case 2\n        (-0.40, 1.0, 2.0, 0.25, 0.30),   # Case 3\n        (0.50, 1.0, 2.0, 0.25, 0.30),   # Case 4\n        (-0.10, 0.0, 3.0, 0.25, 0.30),   # Case 5\n        (-1.00, 0.5, 0.0, 0.25, 0.30),   # Case 6\n        (-0.01, 0.5, 1e-6, 0.25, 0.30),  # Case 7\n        (0.30, 0.2, 0.1, 0.25, 0.30),    # Case 8\n    ]\n\n    results = []\n    for C_raw, P, phi, C_max, beta in test_cases:\n        # Calculate the lower bound C_min based on the stability constraint.\n        # This is the core logic derived from the free-energy balance principle.\n        \n        # Case 1: phi  0. The lower bound is determined by the ratio of\n        # allowed backscatter to the local gradient measure.\n        if phi  0:\n            C_min = -beta * P / phi\n        # Case 2: phi = 0. No SGS effects should occur if there are no\n        # resolved gradients, so we enforce C_min = 0.\n        else:\n            C_min = 0.0\n\n        # Apply the limiter. The raw coefficient C_raw is clipped to the\n        # range [C_min, C_max] to produce the limited coefficient C_lim.\n        # The numpy.clip function is equivalent to the problem's formulation:\n        # min(C_max, max(C_raw, C_min))\n        C_lim = np.clip(C_raw, C_min, C_max)\n        \n        results.append(C_lim)\n\n    # Format the results as a comma-separated list of strings, with each\n    # number rounded to six decimal places, enclosed in square brackets.\n    # The f-string format specifier \"{:.6f}\" ensures rounding and formatting.\n    formatted_results = [f'{res:.6f}' for res in results]\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n\n```"
        }
    ]
}