{
    "hands_on_practices": [
        {
            "introduction": "在一个代理模型能够被信任之前，检验它是否遵循基本的物理定律至关重要。本练习介绍了一种定量评估模型与基本原理一致性的方法，例如要求在驱动梯度为零时湍流输运也必须为零。通过定义和计算特定的“残差”，我们可以衡量代理模型与这些预期理论行为的偏差。",
            "id": "4194327",
            "problem": "考虑一个用于聚变等离子体湍流输运的机器学习代理模型，该模型将无量纲的局域梯度输入映射到一个经 gyro-Bohm 归一化的径向热通量。设 $x$ 表示无量纲密度梯度参数，$y$ 表示无量纲温度梯度参数，两者均定义为宏观长度尺度与各自梯度尺度长度之比。该代理模型预测的归一化热通量为 $Q_{\\text{s}}(x,y)$，以 Gyro-Bohm (gB) 归一化单位表示。对于一个磁通面平均的局域扩散闭合模型，基本输运理论表明湍流热通量是由热力学梯度驱动的。具体来说，在梯度趋于零时，湍流通量的扩散分量消失；在主导阶上，当单个驱动梯度反向时，通量会反号，这反映了梯度具有奇宇称性。这些解析极限被用来验证代理模型的一致性。\n\n从扩散热输运的基本本构关系（即热通量与负温度梯度成正比）出发，一个物理上一致的代理模型应满足以下两个解析极限：\n- 零梯度极限：$Q_{\\text{true}}(0,0)=0$。\n- 小振幅下单个梯度反转时的奇对称性：对于固定的 $x=0$ 和较小的 $|y|$，主导阶响应满足 $Q_{\\text{true}}(0,-y)=-Q_{\\text{true}}(0,y)$。\n\n定义如下验证残差，以衡量代理模型与这些解析极限的偏离程度：\n- 零梯度残差：$R_{0}=\\left|Q_{\\text{s}}(0,0)-0\\right|$。\n- 在指定测试梯度大小 $y_{0}$ 处的奇对称性残差：\n$$\nR_{\\text{odd}}(y_{0})=\\left|\\frac{Q_{\\text{s}}(0,y_{0})+Q_{\\text{s}}(0,-y_{0})}{Q_{\\text{s}}(0,y_{0})-Q_{\\text{s}}(0,-y_{0})}\\right|,\n$$\n它等于在 $y_{0}$ 处偶分量的大小除以奇分量的大小。\n\n假设代理模型具有以下关于梯度的多项式形式：\n$$\nQ_{\\text{s}}(x,y)=a\\,x+b\\,y+c\\,x\\,y+d\\,y^{2}+e,\n$$\n参数为 $a=0.8$，$b=1.2$，$c=0.05$，$d=0.1$ 和 $e=0.02$。使用测试值 $y_{0}=1.3$。计算两个残差 $R_{0}$ 和 $R_{\\text{odd}}(y_{0})$。将两个残差均表示为无量纲数，并将答案四舍五入到四位有效数字。",
            "solution": "经确认，该问题陈述在科学上是合理的、适定的、客观的且自洽的。代理建模、针对物理极限（零梯度、奇对称性）的验证以及定量残差的使用等概念，是计算物理和工程领域的标准做法。问题已为求得唯一解提供了所有必要的数据和定义。\n\n零梯度残差 $R_{0}$ 定义为 $R_{0}=\\left|Q_{\\text{s}}(0,0)-0\\right|$。热通量的代理模型由以下多项式给出：\n$$\nQ_{\\text{s}}(x,y)=a\\,x+b\\,y+c\\,x\\,y+d\\,y^{2}+e\n$$\n为计算 $R_{0}$，我们在 $x=0$ 和 $y=0$ 处对 $Q_{\\text{s}}(x,y)$ 求值：\n$$\nQ_{\\text{s}}(0,0) = a(0) + b(0) + c(0)(0) + d(0)^{2} + e = e\n$$\n参数 $e$ 的值为 $e=0.02$。因此，零梯度残差为：\n$$\nR_{0} = |Q_{\\text{s}}(0,0)| = |e| = |0.02| = 0.02\n$$\n问题要求答案保留四位有效数字。为将 $0.02$ 表示为四位有效数字，我们写作 $0.02000$。\n\n接下来，我们计算在测试梯度大小 $y_{0}=1.3$ 处的奇对称性残差 $R_{\\text{odd}}(y_{0})$。其定义为：\n$$\nR_{\\text{odd}}(y_{0})=\\left|\\frac{Q_{\\text{s}}(0,y_{0})+Q_{\\text{s}}(0,-y_{0})}{Q_{\\text{s}}(0,y_{0})-Q_{\\text{s}}(0,-y_{0})}\\right|\n$$\n首先，我们确定代理模型在 $x=0$ 时的形式：\n$$\nQ_{\\text{s}}(0,y) = b\\,y + d\\,y^{2} + e\n$$\n然后，我们在 $y=y_{0}$ 和 $y=-y_{0}$ 处对该表达式求值：\n$$\nQ_{\\text{s}}(0,y_{0}) = b\\,y_{0} + d\\,y_{0}^{2} + e\n$$\n$$\nQ_{\\text{s}}(0,-y_{0}) = b(-y_{0}) + d(-y_{0})^{2} + e = -b\\,y_{0} + d\\,y_{0}^{2} + e\n$$\n现在我们计算残差表达式的分子和分母所需的和与差。\n和为：\n$$\nQ_{\\text{s}}(0,y_{0}) + Q_{\\text{s}}(0,-y_{0}) = (b\\,y_{0} + d\\,y_{0}^{2} + e) + (-b\\,y_{0} + d\\,y_{0}^{2} + e) = 2\\,d\\,y_{0}^{2} + 2\\,e\n$$\n差为：\n$$\nQ_{\\text{s}}(0,y_{0}) - Q_{\\text{s}}(0,-y_{0}) = (b\\,y_{0} + d\\,y_{0}^{2} + e) - (-b\\,y_{0} + d\\,y_{0}^{2} + e) = 2\\,b\\,y_{0}\n$$\n将这些代入 $R_{\\text{odd}}(y_{0})$ 的表达式，得到：\n$$\nR_{\\text{odd}}(y_{0}) = \\left|\\frac{2\\,d\\,y_{0}^{2} + 2\\,e}{2\\,b\\,y_{0}}\\right| = \\left|\\frac{d\\,y_{0}^{2} + e}{b\\,y_{0}}\\right|\n$$\n该表达式表明，残差衡量的是代理模型的偶分量（$d\\,y^2$ 和 $e$ 项）与主导阶奇分量（$b\\,y$ 项）之比。\n现在，我们代入指定的数值：$b=1.2$，$d=0.1$，$e=0.02$ 和 $y_{0}=1.3$。\n$$\nR_{\\text{odd}}(1.3) = \\left|\\frac{(0.1)(1.3)^{2} + 0.02}{(1.2)(1.3)}\\right|\n$$\n我们计算分子和分母：\n分子：$(0.1)(1.69) + 0.02 = 0.169 + 0.02 = 0.189$。\n分母：$(1.2)(1.3) = 1.56$。\n$$\nR_{\\text{odd}}(1.3) = \\frac{0.189}{1.56} \\approx 0.121153846...\n$$\n将此结果四舍五入到四位有效数字，得到 $0.1212$。\n\n计算出的两个残差为 $R_{0}=0.02000$ 和 $R_{\\text{odd}}(1.3)=0.1212$。",
            "answer": "$$\\boxed{\\begin{pmatrix} 0.02000 & 0.1212 \\end{pmatrix}}$$"
        },
        {
            "introduction": "一个具有物理意义的代理模型不仅要遵守基本极限，还必须能再现更复杂的输运特性，例如在湍流输运中观测到的“刚度”（stiffness）现象。本动手实践将指导您使用数值微分来探查代理模型的局部行为。通过计算其导数，您可以验证其单调性和凸性等基本属性，这些是核心物理预期的数学表示。",
            "id": "4194355",
            "problem": "给定一个基于机器学习的代理模型，用于描述磁化聚变等离子体中的湍流输运，该模型将无量纲的等离子体参数映射到一个无量纲的类热通量。目标是计算该代理模型的数值导数，以评估其凸性和单调性，并解释其结果是否与基于输运理论的物理预期相符。\n\n此问题的基本基础包括：\n- 菲克扩散定律 (Fick's law of diffusion)，该定律指出热通量 $Q$ 与温度梯度的负值成正比，即 $Q = - n \\chi \\nabla T$，其中 $n$ 为密度，$\\chi$ 为正常数输运系数；这意味着通量随梯度驱动的强度单调增加。\n- 熵产的正定性以及在离子温度梯度（ITG）模区域中，湍流输运随归一化梯度驱动增强的趋势，同时受到碰撞性的抑制，这与 $\\chi$ 随碰撞性增加而减小的规律一致。\n\n代理函数 $S(g,q,s,\\nu,Z)$ 定义为：\n$$\n\\operatorname{sp}(x) = \\ln\\left(1 + e^{x}\\right),\n$$\n$$\nS(g,q,s,\\nu,Z) = A \\, \\left[\\operatorname{sp}\\left(g - g_c\\right)\\right]^{\\alpha} \\, \\left(1 + \\beta s^2\\right) \\, \\left(1 + \\gamma \\left(q-1\\right)\\right) \\, \\exp\\left(-\\delta \\nu\\right) \\, \\left(1 + \\eta \\left(Z - 1\\right)\\right),\n$$\n其中 $g$ 是归一化梯度驱动，$q$ 是安全因子，$s$ 是磁剪切，$\\nu$ 是碰撞性，$Z$ 是有效离子电荷。所有变量和常数都是无量纲的。常数如下：\n$$\nA=0.8,\\quad g_c=3.0,\\quad \\alpha=1.5,\\quad \\beta=0.2,\\quad \\gamma=0.1,\\quad \\delta=0.3,\\quad \\eta=0.05.\n$$\n\n您的程序必须使用步长为 $h = 10^{-3}$ 的对称有限差分法实现数值微分：\n- 关于 $g$ 的一阶导数：\n$$\n\\frac{\\partial S}{\\partial g}(g,q,s,\\nu,Z) \\approx \\frac{S(g+h,q,s,\\nu,Z) - S(g-h,q,s,\\nu,Z)}{2h}.\n$$\n- 关于 $g$ 的二阶导数：\n$$\n\\frac{\\partial^2 S}{\\partial g^2}(g,q,s,\\nu,Z) \\approx \\frac{S(g+h,q,s,\\nu,Z) - 2S(g,q,s,\\nu,Z) + S(g-h,q,s,\\nu,Z)}{h^2}.\n$$\n- 关于 $\\nu$ 的一阶导数：\n$$\n\\frac{\\partial S}{\\partial \\nu}(g,q,s,\\nu,Z) \\approx \\frac{S(g,q,s,\\nu+h,Z) - S(g,q,s,\\nu-h,Z)}{2h}.\n$$\n\n为评估与物理预期的一致性：\n- 关于梯度驱动 $g$ 的单调性：将 $\\frac{\\partial S}{\\partial g} \\ge 0$（非递减）分类为一个布尔值。\n- 关于梯度驱动 $g$ 的凸性：将 $\\frac{\\partial^2 S}{\\partial g^2} \\ge 0$ 分类为一个布尔值。\n- 关于碰撞性 $\\nu$ 的单调性：将 $\\frac{\\partial S}{\\partial \\nu} \\le 0$（非递增）分类为一个布尔值。\n\n与零比较时，使用数值容差 $\\tau = 10^{-10}$ 以考虑数值舍入误差。此问题中的所有变量都是无量纲的；不需要物理单位。\n\n使用以下参数集 $(g,q,s,\\nu,Z)$ 的测试套件实现上述要求：\n- 情况 $1$：$(2.0,\\,1.5,\\,0.5,\\,0.1,\\,1.0)$。\n- 情况 $2$：$(3.0,\\,1.2,\\,0.0,\\,0.2,\\,1.2)$。\n- 情况 $3$：$(3.7,\\,2.0,\\,1.0,\\,0.05,\\,1.5)$。\n- 情况 $4$：$(6.0,\\,1.0,\\,0.0,\\,0.8,\\,1.0)$。\n- 情况 $5$：$(4.0,\\,3.0,\\,2.0,\\,0.0,\\,1.8)$。\n\n对于每种情况，您的程序必须按 $[\\text{monotone\\_g}, \\text{convex\\_g}, \\text{monotone\\_nu}]$ 的顺序计算三个布尔值，其中：\n- 如果 $\\frac{\\partial S}{\\partial g} \\ge -\\tau$，则 $\\text{monotone\\_g}$ 为真，\n- 如果 $\\frac{\\partial^2 S}{\\partial g^2} \\ge -\\tau$，则 $\\text{convex\\_g}$ 为真，\n- 如果 $\\frac{\\partial S}{\\partial \\nu} \\le \\tau$，则 $\\text{monotone\\_nu}$ 为真。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个逗号分隔的列表，列表被方括号包围，每个元素是对应输入测试用例的三个布尔值的列表。例如：\n$$\n\\left[\\left[b_1,b_2,b_3\\right],\\left[\\cdots\\right],\\ldots\\right]\n$$\n以文本形式单行打印，如 $[[\\text{True},\\text{False},\\text{True}],\\ldots]$。",
            "solution": "用户提供的问题已经过验证，并被确认为一个有效、适定的科学计算任务。该问题要求对用于聚变等离子体中湍流输运的代理模型进行数值评估，并根据物理预期评估其性质。解决方案将通过实现所提供的模型和数值方案来构建。\n\n问题的核心是代理函数 $S$，它将一组无量纲的等离子体参数 $(g,q,s,\\nu,Z)$ 映射到一个无量纲的类热通量。该函数定义为：\n$$\nS(g,q,s,\\nu,Z) = A \\, \\left[\\operatorname{sp}\\left(g - g_c\\right)\\right]^{\\alpha} \\, \\left(1 + \\beta s^2\\right) \\, \\left(1 + \\gamma \\left(q-1\\right)\\right) \\, \\exp\\left(-\\delta \\nu\\right) \\, \\left(1 + \\eta \\left(Z - 1\\right)\\right)\n$$\n其中 softplus 函数 $\\operatorname{sp}(x)$ 由下式给出：\n$$\n\\operatorname{sp}(x) = \\ln\\left(1 + e^{x}\\right)\n$$\n模型中的常数已提供：$A=0.8$，$g_c=3.0$，$\\alpha=1.5$，$g_c=3.0$，$\\alpha=1.5$，$\\beta=0.2$，$\\gamma=0.1$，$\\delta=0.3$ 和 $\\eta=0.05$。所有参数和常数都是无量纲的。\n\n该任务要求计算 $S$ 的数值导数以检查其与物理原理的一致性。具体来说，我们必须评估：\n$1$. 关于归一化梯度驱动 $g$ 的一阶偏导数。\n$2$. 关于 $g$ 的二阶偏导数。\n$3$. 关于碰撞性 $\\nu$ 的一阶偏导数。\n\n这些导数将使用步长为 $h = 10^{-3}$ 的二阶对称有限差分格式进行近似。公式如下：\n$$\n\\frac{\\partial S}{\\partial g}(g,q,s,\\nu,Z) \\approx \\frac{S(g+h,q,s,\\nu,Z) - S(g-h,q,s,\\nu,Z)}{2h}\n$$\n$$\n\\frac{\\partial^2 S}{\\partial g^2}(g,q,s,\\nu,Z) \\approx \\frac{S(g+h,q,s,\\nu,Z) - 2S(g,q,s,\\nu,Z) + S(g-h,q,s,\\nu,Z)}{h^2}\n$$\n$$\n\\frac{\\partial S}{\\partial \\nu}(g,q,s,\\nu,Z) \\approx \\frac{S(g,q,s,\\nu+h,Z) - S(g,q,s,\\nu-h,Z)}{2h}\n$$\n\n基于这些导数，将对给定的一组输入参数评估三个物理性质：\n- **关于梯度驱动 $g$ 的单调性**：如果输运不随驱动梯度的增加而减少，则模型是一致的。这通过条件 $\\frac{\\partial S}{\\partial g} \\ge 0$ 进行检查。\n- **关于梯度驱动 $g$ 的凸性**：通常被称为“刚性”，该性质意味着在超过某个阈值后，输运会以加速的方式增加。这通过条件 $\\frac{\\partial^2 S}{\\partial g^2} \\ge 0$ 进行检查。\n- **关于碰撞性 $\\nu$ 的单调性**：输运预计会受到碰撞性的抑制。这通过条件 $\\frac{\\partial S}{\\partial \\nu} \\le 0$ 进行检查。\n\n为了考虑浮点数的不精确性，使用数值容差 $\\tau = 10^{-10}$。布尔条件形式化为：\n- 如果 $\\frac{\\partial S}{\\partial g} \\ge -\\tau$，则 `monotone_g` 为真。\n- 如果 $\\frac{\\partial^2 S}{\\partial g^2} \\ge -\\tau$，则 `convex_g` 为真。\n- 如果 $\\frac{\\partial S}{\\partial \\nu} \\le \\tau$，则 `monotone_nu` 为真。\n\n该过程将通过一个 Python 程序实现。将为代理模型 $S(g,q,s,\\nu,Z)$ 创建一个函数。然后，程序将遍历五个提供的测试用例。对于每个用例，它将使用有限差分公式计算所需的三个导数。随后，它将评估三个布尔条件。每个用例的最终输出是这三个布尔值的列表。所有测试用例的结果将被收集并格式化为问题陈述中指定的单个字符串，表示一个列表的列表。\n每个测试用例的参数 $(g, q, s, \\nu, Z)$ 如下：\n- 情况 $1$：$(2.0,\\,1.5,\\,0.5,\\,0.1,\\,1.0)$\n- 情况 $2$：$(3.0,\\,1.2,\\,0.0,\\,0.2,\\,1.2)$\n- 情况 $3$：$(3.7,\\,2.0,\\,1.0,\\,0.05,\\,1.5)$\n- 情况 $4$：$(6.0,\\,1.0,\\,0.0,\\,0.8,\\,1.0)$\n- 情况 $5$：$(4.0,\\,3.0,\\,2.0,\\,0.0,\\,1.8)$\n计算将使用 `numpy` 库中的数学函数来执行，以确保数值精度。",
            "answer": "[[True,True,True],[True,True,True],[True,True,True],[True,True,True],[True,True,True]]"
        },
        {
            "introduction": "与其仅仅验证一个已经训练好的模型，一种更强大的方法是将物理知识直接注入学习过程。这个高级练习将挑战您设计一个自定义的“损失函数”，以在模型训练期间强制施加物理约束。您将学习如何构建一个惩罚项，以确保模型的输出——热通量——在其驱动梯度超过某个临界阈值时单调增加，这是离子温度梯度驱动湍流的一个关键特征。",
            "id": "4194347",
            "problem": "在由离子温度梯度机制驱动的离子尺度回旋动理学湍流中，根据经验观察，以回旋玻姆单位归一化的离子热通量（表示为 $Q$）具有阈值和刚性主导的特性：在固定的辅助控制变量 $z$（例如，安全因子 $q$、磁剪切 $\\hat{s}$、碰撞率 $\\nu^{\\ast}$、ExB剪切率 $\\gamma_{E}$）下，作为归一化温度梯度 $g \\equiv R/L_{T_{i}}$ 的函数，存在一个临界梯度 $g_{\\mathrm{crit}}(z)$，使得当 $g \\geq g_{\\mathrm{crit}}(z)$ 时，映射 $g \\mapsto Q(z,g)$ 是非递减的。考虑一个机器学习代理模型 $f_{\\theta}(z,g)$，该模型通过经验风险最小化方法，利用训练数据 $\\{(z_{i}, g_{i}, y_{i})\\}_{i=1}^{N}$ 进行训练以预测 $Q$，其中 $y_{i}$ 是对 $Q(z_{i}, g_{i})$ 的带噪声观测值。\n\n假设临界梯度函数 $g_{\\mathrm{crit}}(z)$ 有一个已知的、平滑的近似函数 $T(z)$，目标是施加阈值之上的物理单调性约束：对于具有相同 $z$ 且满足 $g_{a} > g_{b} \\geq T(z)$ 的任意两个输入 $(z, g_{a})$ 和 $(z, g_{b})$，模型必须满足 $f_{\\theta}(z, g_{a}) \\geq f_{\\theta}(z, g_{b})$。由于在高维训练数据中，$z$ 的精确重复值很少见，因此通过比较 $z$ 空间中邻近的输入来构建约束，并使用正定核进行加权。令 $K(r)$ 为一个正径向核（使用带宽为 $\\ell > 0$ 的高斯核 $K(r)=\\exp(-r^{2}/(2\\ell^{2}))$），并令 $\\sigma(x) \\equiv 1/(1+\\exp(-x))$ 为用作平滑指示函数的 logistic sigmoid 函数。使用温度为 $\\tau > 0$ 的 softplus 函数定义整流线性单元的一个平滑近似，即 $\\operatorname{softplus}_{\\tau}(x) \\equiv \\tau \\ln(1+\\exp(x/\\tau))$。可选择性地引入一个非负间隔斜率 $\\lambda \\geq 0$，以偏向于与梯度差成比例的严格递增行为。\n\n从上述单调性和阈值化的定义出发，并仅使用凸代理惩罚项和核的标准属性，推导出一个可微的、成对的、核加权的惩罚项 $L_{\\mathrm{mon}}(\\theta)$，该惩罚项满足：\n- 当模型对于固定的 $z$ 和所有满足 $g_{a} > g_{b} \\geq T(z)$ 的数据对都遵守非递减约束时，该惩罚项为零，\n- 当模型违反该约束时，该惩罚项为严格正值，\n- 平滑地排除那些在 $g$ 上未排序或低于阈值的数据对，并且\n- 平滑地降低在 $z$ 上不相似的数据对的权重。\n\n通过活跃数据对的总有效权重对惩罚项进行归一化，使其尺度与批次构成无关。将最终的单调性损失 $L_{\\mathrm{mon}}(\\theta)$ 明确地表示为关于 $\\{(z_{i}, g_{i})\\}_{i=1}^{N}$、$f_{\\theta}$、$K$、$\\sigma$、$\\operatorname{softplus}_{\\tau}$、$T$、$\\ell$、$\\tau$ 和 $\\lambda$ 的单个闭式解析表达式。您的最终答案必须是这个单一的解析表达式。不需要进行数值计算，也不需要单位。",
            "solution": "用户提供了一个问题，要求为一个机器学习模型推导一个惩罚函数（或损失函数）$L_{\\mathrm{mon}}(\\theta)$。该损失函数旨在对用于聚变等离子体湍流模拟的代理模型 $f_{\\theta}(z,g)$ 施加一个物理上的单调性约束。\n\n### 步骤 1：提取已知条件\n问题提供了以下定义、变量和约束：\n-   **物理系统**：由离子温度梯度（ITG）机制驱动的离子尺度回旋动理学湍流。\n-   **变量**：\n    -   $Q$：归一化的离子热通量。\n    -   $z$：辅助控制变量向量。\n    -   $g \\equiv R/L_{T_{i}}$：归一化的温度梯度。\n-   **物理约束**：存在一个临界梯度 $g_{\\mathrm{crit}}(z)$，使得对于固定的 $z$ 和所有 $g \\geq g_{\\mathrm{crit}}(z)$，映射 $g \\mapsto Q(z,g)$ 是非递减的。\n-   **机器学习模型**：\n    -   $f_{\\theta}(z,g)$：一个由 $\\theta$ 参数化的代理模型，用于预测 $Q$。\n    -   $\\{(z_{i}, g_{i}, y_{i})\\}_{i=1}^{N}$：一个包含 $N$ 个训练数据点的集合。\n-   **约束实现**：\n    -   $T(z)$：一个已知的、平滑的函数，用于近似临界梯度 $g_{\\mathrm{crit}}(z)$。\n    -   **目标**：对于任何固定的 $z$ 和任意两个梯度 $g_{a} > g_{b} \\geq T(z)$，模型必须满足 $f_{\\theta}(z, g_{a}) \\geq f_{\\theta}(z, g_{b})$。\n-   **数学工具**：\n    -   $K(r)$：一个正径向核，特别是带宽为 $\\ell > 0$ 的高斯核 $K(r)=\\exp(-r^{2}/(2\\ell^{2}))$。它用于根据点对的 $z$ 坐标之间的距离对其进行加权。\n    -   $\\sigma(x) \\equiv 1/(1+\\exp(-x))$：logistic sigmoid 函数，用于平滑门控。\n    -   $\\operatorname{softplus}_{\\tau}(x) \\equiv \\tau \\ln(1+\\exp(x/\\tau))$：温度为 $\\tau > 0$ 的 softplus 函数，用作整流线性单元 ($\\operatorname{ReLU}(x) = \\max(0,x)$) 的平滑、可微近似。\n    -   $\\lambda \\geq 0$：一个非负间隔斜率，用于鼓励严格递增的行为。\n-   **损失函数 $L_{\\mathrm{mon}}(\\theta)$ 的所需属性**：\n    1.  它是一个可微的、成对的、核加权的惩罚项。\n    2.  当所有相关数据对都满足单调性约束时，它为零。\n    3.  当约束被违反时，它为严格正值。\n    4.  它包含平滑门，以滤除在 $g$ 上未排序 ($g_a \\le g_b$) 或低于临界梯度阈值 ($g_b  T(z)$) 的数据对。\n    5.  它平滑地降低在 $z$ 空间中相距较远的数据对的权重。\n    6.  它通过活跃数据对的总权重进行归一化。\n\n### 步骤 2：使用提取的已知条件进行验证\n根据验证标准对问题陈述进行评估。\n-   **有科学依据**：该问题植根于计算等离子体物理学的一个真实应用——开发用于湍流的、物理启发的机器学习模型。ITG湍流、临界梯度和模型刚性等概念是公认的。使用自定义损失函数来施加物理约束是科学机器学习中的一种标准和现代技术。\n-   **适定性**：该问题非常具体。它清晰地定义了目标，提供了所有必需的数学函数和常数，并列出了最终表达式必须满足的属性。构建任务是明确无误的。\n-   **客观性**：语言正式、数学化，并且没有主观内容。\n\n该问题没有表现出任何使其无效的缺陷。它在科学上是合理的，可形式化的，完整的，并提出了一个非平凡但可解的构建任务。使用像 `softplus` 这样的平滑函数来近似一个非平滑条件（在半条线上为零）是优化中确保可微性的标准技术，并且在这种情况下，惩罚项“为零”的要求被理解为它变得无穷小。\n\n### 步骤 3：结论和行动\n该问题是**有效的**。现在将推导一个合理的解决方案。\n\n### 单调性损失函数的推导\n\n目标是构建一个损失函数 $L_{\\mathrm{mon}}(\\theta)$，用于惩罚违反单调性约束的情况。该损失将构建为对训练集 $\\{(z_i, g_i, y_i)\\}_{i=1}^N$ 和 $\\{(z_j, g_j, y_j)\\}_{j=1}^N$ 中所有数据点对的求和。\n\n1.  **核心违规惩罚**：\n    约束为对于 $g_a  g_b \\geq T(z)$，必须有 $f_{\\theta}(z, g_a) \\geq f_{\\theta}(z, g_b)$。问题引入了一个间隔斜率 $\\lambda \\geq 0$，将约束加强为 $f_{\\theta}(z, g_a) - f_{\\theta}(z, g_b) \\geq \\lambda(g_a - g_b)$。\n    当 $\\lambda(g_a - g_b) - (f_{\\theta}(z, g_a) - f_{\\theta}(z, g_b))  0$ 时，发生违规。\n    让我们考虑一对数据点 $(i, j)$。令点 $i$ 对应于 $(z_a, g_a)$，点 $j$ 对应于 $(z_b, g_b)$。暂时假设关于 $g$ 和 $z$ 的条件已满足，这对数据点的违规度量为 $V_{ij} = \\lambda(g_i - g_j) - (f_{\\theta}(z_i, g_i) - f_{\\theta}(z_j, g_j)) = f_{\\theta}(z_j, g_j) - f_{\\theta}(z_i, g_i) + \\lambda(g_i - g_j)$。\n    可以使用指定的 softplus 函数为此违规构建一个非负、可微的惩罚项：$P_{ij} = \\operatorname{softplus}_{\\tau}(V_{ij})$。如果 $V_{ij}  0$（违规），该项为严格正值；当 $V_{ij} \\to -\\infty$（约束被满足且间隔增大）时，该项趋近于零。这与要求一致，将“为零”解释为对于平滑函数“趋近于零”。\n\n2.  **平滑门控与加权**：\n    惩罚项 $P_{ij}$ 应该仅在对应的点对 $(i, j)$ 满足物理条件时才应用。这通过将 $P_{ij}$ 乘以一系列平滑的加权和门控因子来实现。我们为有序对 $(i, j)$ 定义一个总权重 $W_{ij}$。\n\n    -   **梯度排序**：约束仅在 $g_a  g_b$ 时适用。对于我们的点对 $(i, j)$，这意味着 $g_i  g_j$。我们使用 sigmoid 函数 $\\sigma(x)$ 作为平滑门。如果 $g_i \\gg g_j$，则 $\\sigma(g_i - g_j)$ 项将接近 $1$；如果 $g_i \\ll g_j$，则该项将接近 $0$，从而对惩罚进行平滑门控。\n\n    -   **阈值条件**：约束要求梯度较低的点高于临界梯度，即 $g_b \\geq T(z)$。对于我们的点对 $(i, j)$，其中 $g_i  g_j$，点 $j$ 对应于 $g_b$。约束变为 $g_j \\geq T(z_j)$（因为我们比较的是不同的数据点，所以我们使用局部值 $T(z_j)$）。对此的一个平滑门是 $\\sigma(g_j - T(z_j))$。\n\n    -   **$z$ 空间中的邻近性**：原始的物理约束在固定的 $z$ 下成立。由于训练数据点 $(i, j)$通常具有 $z_i \\neq z_j$，我们降低在 $z$ 空间中相距较远的点对的权重。这通过使用提供的核函数 $K(r)$ 来实现，其参数为距离 $r = \\|z_i - z_j\\|$。权重为 $K(\\|z_i - z_j\\|)$。\n\n    将这些组合成有序对 $(i, j)$ 的单个加权因子：\n    $$W_{ij} = K(\\|z_i - z_j\\|) \\cdot \\sigma(g_i - g_j) \\cdot \\sigma(g_j - T(z_j))$$\n\n3.  **构建总惩罚项（分子）**：\n    总的、未归一化的惩罚项是所有可能的点对 $(i, j)$ 的惩罚项与其相应权重的乘积之和：\n    $$L'_{\\mathrm{mon}}(\\theta) = \\sum_{i=1}^{N} \\sum_{j=1}^{N} W_{ij} P_{ij}$$\n    $$L'_{\\mathrm{mon}}(\\theta) = \\sum_{i=1}^{N} \\sum_{j=1}^{N} W_{ij} \\operatorname{softplus}_{\\tau}\\left(f_{\\theta}(z_j, g_j) - f_{\\theta}(z_i, g_i) + \\lambda(g_i-g_j)\\right)$$\n    双重求和涵盖了所有有序对。对于任何给定的索引对 $\\{i, j\\}$，如果 $g_i \\approx g_j$，则 $\\sigma(g_i - g_j)$ 和 $\\sigma(g_j - g_i)$ 都将接近 $0.5$。然而，如果 $g_i$ 和 $g_j$ 相差较大，其中一个项将接近 $1$，另一个将接近 $0$，从而有效地选择正确的有序对进行惩罚。\n\n4.  **归一化（分母）**：\n    为了使损失函数的量级与批次大小 $N$ 和数据点的具体分布无关，我们通过所应用的总有效权重的总和进行归一化。归一化分母 $D$ 是所有点对的所有权重 $W_{ij}$ 的总和：\n    $$D = \\sum_{i=1}^{N} \\sum_{j=1}^{N} W_{ij} = \\sum_{i=1}^{N} \\sum_{j=1}^{N} K(\\|z_i - z_j\\|) \\cdot \\sigma(g_i - g_j) \\cdot \\sigma(g_j - T(z_j))$$\n    如果批次中没有点对满足条件（使 $D$ 接近于零），则分子也将接近于零，损失实际上为零。\n\n5.  **最终表达式**：\n    单调性损失 $L_{\\mathrm{mon}}(\\theta)$ 的最终表达式是总加权惩罚与总权重的比值：\n    $$L_{\\mathrm{mon}}(\\theta) = \\frac{L'_{\\mathrm{mon}}(\\theta)}{D}$$\n    代入所有项的完整表达式，得到完整的解析形式。\n    \n    $$L_{\\mathrm{mon}}(\\theta) = \\frac{\\sum_{i=1}^{N} \\sum_{j=1}^{N} K(\\|z_i - z_j\\|) \\sigma(g_i - g_j) \\sigma(g_j - T(z_j)) \\operatorname{softplus}_{\\tau}\\left(f_{\\theta}(z_j, g_j) - f_{\\theta}(z_i, g_i) + \\lambda(g_i-g_j)\\right)}{\\sum_{i=1}^{N} \\sum_{j=1}^{N} K(\\|z_i - z_j\\|) \\sigma(g_i - g_j) \\sigma(g_j - T(z_j))}$$\n    \n    这个表达式对于模型参数 $\\theta$ 是完全可微的（假设 $f_{\\theta}$、$T$ 是可微的），并且满足问题陈述中指定的所有属性。",
            "answer": "$$\n\\boxed{\n\\frac{\\sum_{i=1}^{N} \\sum_{j=1}^{N} K(\\|z_i - z_j\\|) \\sigma(g_i - g_j) \\sigma(g_j - T(z_j)) \\operatorname{softplus}_{\\tau}\\left(f_{\\theta}(z_j, g_j) - f_{\\theta}(z_i, g_i) + \\lambda(g_i-g_j)\\right)}{\\sum_{i=1}^{N} \\sum_{j=1}^{N} K(\\|z_i - z_j\\|) \\sigma(g_i - g_j) \\sigma(g_j - T(z_j))}\n}\n$$"
        }
    ]
}