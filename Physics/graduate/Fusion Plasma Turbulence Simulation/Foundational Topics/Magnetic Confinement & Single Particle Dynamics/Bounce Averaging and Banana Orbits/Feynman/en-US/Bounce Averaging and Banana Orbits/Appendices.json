{
    "hands_on_practices": [
        {
            "introduction": "The first question one might ask about trapped particles is fundamental: how many are there? The fraction of trapped particles is a crucial parameter in models of both neoclassical and turbulent transport, as these particles behave very differently from their passing counterparts. This exercise guides you through a first-principles derivation to estimate this fraction, $f_t$, on a magnetic flux surface in a simplified tokamak geometry. By applying the conservation of energy and magnetic moment, you will derive the famous result that this fraction scales with the square root of the inverse aspect ratio, a cornerstone of tokamak physics. ",
            "id": "4182238",
            "problem": "In a large-aspect-ratio (LAR) tokamak with circular, concentric magnetic flux surfaces, the toroidal magnetic field magnitude varies along a field line primarily due to the change of major radius. Using the well-tested approximation that the toroidal field scales as $B \\propto 1/R$, take the magnetic field on a given flux surface of minor radius $r$ (with $r \\ll R_{0}$) to be\n$$\nB(\\theta) \\approx \\frac{B_{0}}{1 + \\epsilon \\cos\\theta},\n$$\nwhere $R_{0}$ is the major radius, $\\epsilon \\doteq r/R_{0} \\ll 1$ is the inverse aspect ratio, $\\theta$ is the poloidal angle (in radians), and $B_{0}$ is a constant chosen so that $B(\\theta=0)=B_{0}/(1+\\epsilon)$ is the outboard midplane field. Consider a collisionless guiding-center particle of mass $m$ and charge $q$ whose dynamics are governed by conservation of total kinetic energy $E = \\tfrac{1}{2} m v^{2}$ and magnetic moment $\\mu = m v_{\\perp}^{2}/(2 B)$, where $v$ is the speed and $v_{\\perp}$ is the velocity component perpendicular to the magnetic field. Define the pitch-angle cosine at the outboard midplane (where $\\theta = 0$) as $\\xi \\doteq v_{\\parallel}/v$, with $v_{\\parallel}$ the parallel velocity there.\n\nA particle is called trapped if its parallel velocity $v_{\\parallel}$ vanishes at some poloidal angle before completing a full poloidal transit, otherwise it is called passing. In gyrokinetic turbulence modeling, bounce averaging uses the fraction of trapped particles $f_{t}$ on a flux surface as a key weighting.\n\nAssuming the velocity distribution at the outboard midplane is an isotropic Maxwellian,\n$$\nf_{M}(\\mathbf{v}) = n \\left(\\frac{m}{2 \\pi T}\\right)^{3/2} \\exp\\!\\left(-\\frac{m v^{2}}{2 T}\\right),\n$$\nwith density $n$, temperature $T$, and where the distribution is isotropic in velocity space, compute the trapped particle fraction $f_{t}$ on the given flux surface to leading order in $\\epsilon$. Your derivation should start from the conservation of $E$ and $\\mu$ and the given $B(\\theta)$, obtain the trapped-region condition in terms of $\\xi$, and then perform the appropriate average over the Maxwellian velocity distribution. Express your final answer as a single closed-form analytic expression in $\\epsilon$ that is accurate to leading order in $\\epsilon$ and contains no units. Do not provide an inequality or an equation as the final answer.",
            "solution": "The problem asks for the fraction of trapped particles on a given magnetic flux surface in a large-aspect-ratio tokamak, to leading order in the inverse aspect ratio $\\epsilon$. We are given the magnetic field model, the constants of motion for a charged particle, and the velocity distribution function at the outboard midplane.\n\nFirst, we establish the condition for a particle to be trapped. The particle's motion is governed by the conservation of kinetic energy $E$ and magnetic moment $\\mu$.\nThe kinetic energy is $E = \\frac{1}{2}mv^2$, where $m$ is the particle mass and $v$ is its speed. Since $E$ is conserved, the speed $v$ is constant for a given particle.\nThe magnetic moment is $\\mu = \\frac{mv_{\\perp}^2}{2B}$, where $v_{\\perp}$ is the velocity component perpendicular to the magnetic field $\\mathbf{B}$, and $B=|\\mathbf{B}|$. Since $\\mu$ is also conserved, the ratio $v_{\\perp}^2/B$ is constant along the particle's trajectory.\n\nThe total speed squared is $v^2 = v_{\\parallel}^2 + v_{\\perp}^2$, where $v_{\\parallel}$ is the velocity component parallel to $\\mathbf{B}$. We can express $v_{\\parallel}^2$ at any point along the field line as a function of the local magnetic field $B(\\theta)$:\n$v_{\\parallel}^2(\\theta) = v^2 - v_{\\perp}^2(\\theta)$.\nUsing the conservation of $\\mu$, we have $v_{\\perp}^2(\\theta) = \\frac{2B(\\theta)\\mu}{m}$. Therefore,\n$$v_{\\parallel}^2(\\theta) = v^2 - \\frac{2B(\\theta)\\mu}{m}.$$\nTo evaluate $\\mu$, we use the initial conditions at the outboard midplane, where the poloidal angle is $\\theta=0$. At this location, the magnetic field is $B(0)$. The pitch-angle cosine is defined as $\\xi \\doteq v_{\\parallel,0}/v$, where $v_{\\parallel,0}$ is the parallel velocity at $\\theta=0$.\nThe perpendicular velocity at $\\theta=0$ is given by $v_{\\perp,0}^2 = v^2 - v_{\\parallel,0}^2 = v^2 - \\xi^2 v^2 = v^2(1-\\xi^2)$.\nThe magnetic moment can now be written in terms of these midplane quantities:\n$$\\mu = \\frac{m v_{\\perp,0}^2}{2B(0)} = \\frac{m v^2 (1-\\xi^2)}{2B(0)}.$$\nSubstituting this expression for $\\mu$ back into the equation for $v_{\\parallel}^2(\\theta)$, we get:\n$$v_{\\parallel}^2(\\theta) = v^2 - \\frac{2B(\\theta)}{m} \\left( \\frac{m v^2 (1-\\xi^2)}{2B(0)} \\right) = v^2 \\left( 1 - \\frac{B(\\theta)}{B(0)}(1-\\xi^2) \\right).$$\nA particle is defined as trapped if its parallel velocity $v_{\\parallel}$ becomes zero at some poloidal angle $\\theta_b$, called the bounce point. At this point, the particle reverses its parallel direction of motion. For a particle to be trapped, it must have a bounce point before completing a full poloidal transit, i.e., before reaching the point of maximum magnetic field. The given magnetic field is $B(\\theta) = \\frac{B_0}{1 + \\epsilon \\cos\\theta}$. This field is minimum at the outboard midplane ($\\theta=0$), where $B_{min} = B(0) = \\frac{B_0}{1+\\epsilon}$, and maximum at the inboard midplane ($\\theta=\\pi$), where $B_{max} = B(\\pi) = \\frac{B_0}{1-\\epsilon}$.\n\nA particle can pass if its parallel kinetic energy remains non-negative everywhere, including at the point of maximum magnetic field. Conversely, a particle is trapped if its parallel kinetic energy would become negative at the point of maximum field, which is physically impossible, implying it must have reflected before reaching that point. The trapping condition is thus $v_{\\parallel}^2(\\pi) < 0$:\n$$v^2 \\left( 1 - \\frac{B(\\pi)}{B(0)}(1-\\xi^2) \\right) < 0.$$\nSince $v^2 > 0$, this simplifies to:\n$$1 < \\frac{B_{max}}{B_{min}}(1-\\xi^2) \\implies 1-\\xi^2 > \\frac{B_{min}}{B_{max}} \\implies \\xi^2 < 1 - \\frac{B_{min}}{B_{max}}.$$\nNow, we compute the ratio $\\frac{B_{min}}{B_{max}}$:\n$$\\frac{B_{min}}{B_{max}} = \\frac{B_0/(1+\\epsilon)}{B_0/(1-\\epsilon)} = \\frac{1-\\epsilon}{1+\\epsilon}.$$\nThe trapping condition on the pitch-angle cosine $\\xi$ is:\n$$\\xi^2 < 1 - \\frac{1-\\epsilon}{1+\\epsilon} = \\frac{(1+\\epsilon) - (1-\\epsilon)}{1+\\epsilon} = \\frac{2\\epsilon}{1+\\epsilon}.$$\nFor the large-aspect-ratio limit where $\\epsilon \\ll 1$, we can expand this expression to leading order:\n$$\\frac{2\\epsilon}{1+\\epsilon} = 2\\epsilon(1+\\epsilon)^{-1} \\approx 2\\epsilon(1-\\epsilon) \\approx 2\\epsilon.$$\nThus, to leading order in $\\epsilon$, the condition for a particle to be trapped is $|\\xi| < \\sqrt{2\\epsilon}$.\n\nNext, we calculate the fraction of trapped particles, $f_t$. This is the ratio of the number density of trapped particles to the total number density. Given that the velocity distribution $f_M(\\mathbf{v})$ at the outboard midplane is isotropic (depends only on the speed $v=|\\mathbf{v}|$), the fraction of particles in a certain region of velocity space is simply the ratio of the solid angle of that region to the total solid angle ($4\\pi$ steradians).\n$$f_t = \\frac{\\int_{\\text{trapped}} f_M(\\mathbf{v}) d^3v}{\\int_{\\text{all}} f_M(\\mathbf{v}) d^3v}$$\nIn spherical coordinates in velocity space $(v, \\alpha, \\phi)$, where $\\alpha$ is the angle relative to $\\mathbf{B}$ such that $\\xi = \\cos(\\alpha)$, the velocity space volume element is $d^3v = v^2 dv \\sin\\alpha d\\alpha d\\phi = v^2 dv |d\\xi| d\\phi$. The integral separates:\n$$f_t = \\frac{\\int_0^{\\infty} f_M(v) v^2 dv \\int_{\\text{trapped}} d\\Omega}{\\int_0^{\\infty} f_M(v) v^2 dv \\int_{\\text{all}} d\\Omega} = \\frac{\\Omega_{\\text{trapped}}}{\\Omega_{\\text{total}}}.$$\nThe total solid angle is $\\Omega_{\\text{total}} = \\int_0^{2\\pi} d\\phi \\int_{-1}^{1} d\\xi = 2\\pi \\cdot 2 = 4\\pi$.\nThe solid angle corresponding to the trapped particle region, $|\\xi| < \\sqrt{2\\epsilon}$, is:\n$$\\Omega_{\\text{trapped}} = \\int_0^{2\\pi} d\\phi \\int_{-\\sqrt{2\\epsilon}}^{\\sqrt{2\\epsilon}} d\\xi = 2\\pi \\left( \\sqrt{2\\epsilon} - (-\\sqrt{2\\epsilon}) \\right) = 2\\pi(2\\sqrt{2\\epsilon}) = 4\\pi\\sqrt{2\\epsilon}.$$\nThe fraction of trapped particles is the ratio of these solid angles:\n$$f_t = \\frac{\\Omega_{\\text{trapped}}}{\\Omega_{\\text{total}}} = \\frac{4\\pi\\sqrt{2\\epsilon}}{4\\pi} = \\sqrt{2\\epsilon}.$$\nThis result is already the leading-order expression in $\\epsilon$. A more rigorous approach of calculating the exact fraction $f_t = \\sqrt{\\frac{2\\epsilon}{1+\\epsilon}}$ and then expanding for $\\epsilon \\ll 1$ yields the same leading-order term:\n$$f_t = \\sqrt{2\\epsilon}(1+\\epsilon)^{-1/2} = \\sqrt{2\\epsilon} \\left(1 - \\frac{1}{2}\\epsilon + O(\\epsilon^2)\\right) = \\sqrt{2\\epsilon} - \\frac{1}{\\sqrt{2}}\\epsilon^{3/2} + \\dots$$\nThe leading term is $\\sqrt{2\\epsilon}$.",
            "answer": "$$\\boxed{\\sqrt{2\\epsilon}}$$"
        },
        {
            "introduction": "Once we establish that a significant fraction of particles are trapped, the next step is to understand their average behavior over their fast, oscillatory motion. The bounce-averaging technique is a powerful mathematical tool that simplifies the complex bounce dynamics into a more tractable, orbit-averaged picture. This practice focuses on applying the formal definition of a bounce average to a specific, physically important limit: that of \"deeply trapped\" particles confined near the bottom of the magnetic well. By using appropriate approximations for this regime, you will calculate the bounce-averaged value of $\\cos\\theta$, a quantity related to the average poloidal location of the banana orbit, providing a concrete example of how this averaging technique works. ",
            "id": "4182226",
            "problem": "In a large-aspect-ratio, circular, concentric-axis tokamak, the magnetic-field magnitude along a field line on a given flux surface can be modeled to first order in inverse aspect ratio as $B(\\theta) = B_{0} \\left(1 - \\epsilon \\cos\\theta\\right)$, where $B_{0}$ is the on-axis magnetic field, $\\theta$ is the poloidal angle, and $\\epsilon \\equiv r/R_{0} \\ll 1$ is the inverse aspect ratio. Consider a single guiding-center particle of mass $m$ and speed $v$ with conserved total energy $\\mathcal{E} = m v^{2}/2$ and conserved magnetic moment $\\mu = m v_{\\perp}^{2}/(2 B)$. Define the pitch parameter $\\lambda \\equiv \\mu B_{0}/\\mathcal{E}$, so that the parallel velocity satisfies $v_{\\parallel}^{2}(\\theta) = v^{2}\\left[1 - \\lambda \\, B(\\theta)/B_{0}\\right]$. For a trapped particle, there exist turning points $\\pm \\theta_{t}$ where $v_{\\parallel}(\\pm \\theta_{t}) = 0$. The bounce-average of a function $A(\\theta)$ is defined by\n$$\n\\langle A \\rangle_{b} \\equiv \\frac{\\displaystyle \\int_{-\\theta_{t}}^{\\theta_{t}} \\frac{A(\\theta)}{|v_{\\parallel}(\\theta)|} \\,\\frac{d\\ell}{d\\theta}\\, d\\theta}{\\displaystyle \\int_{-\\theta_{t}}^{\\theta_{t}} \\frac{1}{|v_{\\parallel}(\\theta)|} \\,\\frac{d\\ell}{d\\theta}\\, d\\theta},\n$$\nwhere $d\\ell$ is the arc length along the field line. Work to leading order in $\\epsilon$ for deeply trapped particles, meaning $|\\theta_{t}| \\ll 1$ and the well-bottom detuning $1 - \\lambda\\left(1 - \\epsilon\\right)$ is asymptotically small compared with $\\epsilon$. Starting from conservation of $\\mathcal{E}$ and $\\mu$, and keeping only the mathematically necessary leading-order geometric effects near $\\theta = 0$, derive the bounce-average of $A(\\theta) = \\cos\\theta$, and express your final result as a closed-form analytic expression in terms of $\\lambda$ and $\\epsilon$. No numerical approximation is required. State your final answer for $\\langle \\cos\\theta \\rangle_{b}$ as a single analytic expression with no units. Angles are in radians.",
            "solution": "The problem asks for the bounce-average of the function $A(\\theta) = \\cos\\theta$ for a deeply trapped particle in a model tokamak magnetic field. The bounce-average is defined as:\n$$\n\\langle A \\rangle_{b} \\equiv \\frac{\\displaystyle \\int_{-\\theta_{t}}^{\\theta_{t}} \\frac{A(\\theta)}{|v_{\\parallel}(\\theta)|} \\,\\frac{d\\ell}{d\\theta}\\, d\\theta}{\\displaystyle \\int_{-\\theta_{t}}^{\\theta_{t}} \\frac{1}{|v_{\\parallel}(\\theta)|} \\,\\frac{d\\ell}{d\\theta}\\, d\\theta}\n$$\nwhere $\\pm \\theta_{t}$ are the turning points of the trapped particle orbit.\n\nFirst, we establish the expression for the parallel velocity $v_{\\parallel}$. Given the conserved energy $\\mathcal{E} = m v^{2}/2$, the conserved magnetic moment $\\mu = m v_{\\perp}^{2}/(2 B)$, and the pitch parameter $\\lambda = \\mu B_{0}/\\mathcal{E}$, the parallel velocity squared is given by:\n$$\nv_{\\parallel}^{2}(\\theta) = v^{2}\\left[1 - \\lambda \\frac{B(\\theta)}{B_{0}}\\right]\n$$\nSubstituting the given magnetic field model, $B(\\theta) = B_{0} (1 - \\epsilon \\cos\\theta)$, we get:\n$$\nv_{\\parallel}^{2}(\\theta) = v^{2}\\left[1 - \\lambda (1 - \\epsilon \\cos\\theta)\\right] = v^{2}(1 - \\lambda + \\lambda\\epsilon \\cos\\theta)\n$$\nThe problem specifies the analysis is for deeply trapped particles, for which the turning angle is small, i.e., $|\\theta_{t}| \\ll 1$. This allows us to use the small-angle approximation for the poloidal angle $\\theta$ around the bottom of the magnetic well at $\\theta=0$. We expand $\\cos\\theta$ to second order:\n$$\n\\cos\\theta \\approx 1 - \\frac{\\theta^2}{2}\n$$\nSubstituting this into the expression for $v_{\\parallel}^{2}(\\theta)$:\n$$\nv_{\\parallel}^{2}(\\theta) \\approx v^{2}\\left[1 - \\lambda + \\lambda\\epsilon \\left(1 - \\frac{\\theta^2}{2}\\right)\\right] = v^{2}\\left[1 - \\lambda(1-\\epsilon) - \\frac{\\lambda\\epsilon}{2}\\theta^2\\right]\n$$\nThe turning points $\\pm \\theta_{t}$ are defined by the condition $v_{\\parallel}(\\pm \\theta_{t}) = 0$. Using the approximated expression:\n$$\n0 = 1 - \\lambda(1-\\epsilon) - \\frac{\\lambda\\epsilon}{2}\\theta_t^2\n$$\nSolving for $\\theta_t^2$:\n$$\n\\theta_t^2 = \\frac{2(1 - \\lambda(1-\\epsilon))}{\\lambda\\epsilon} = \\frac{2(1 - \\lambda + \\lambda\\epsilon)}{\\lambda\\epsilon}\n$$\nThe problem statement notes that for deeply trapped particles, the quantity $1 - \\lambda(1-\\epsilon)$ is small compared to $\\epsilon$, which is consistent with the condition $|\\theta_t| \\ll 1$.\n\nNow we can express $v_{\\parallel}^{2}(\\theta)$ in terms of $\\theta_t^2$:\n$$\nv_{\\parallel}^{2}(\\theta) \\approx v^{2}\\left[\\frac{\\lambda\\epsilon}{2}\\theta_t^2 - \\frac{\\lambda\\epsilon}{2}\\theta^2\\right] = v^{2}\\frac{\\lambda\\epsilon}{2}(\\theta_t^2 - \\theta^2)\n$$\nSo, the magnitude of the parallel velocity is:\n$$\n|v_{\\parallel}(\\theta)| \\approx v\\sqrt{\\frac{\\lambda\\epsilon}{2}}\\sqrt{\\theta_t^2 - \\theta^2}\n$$\nfor $|\\theta| \\leq |\\theta_t|$.\n\nNext, we consider the arc length element along the magnetic field line, $d\\ell$. For a large-aspect-ratio circular tokamak, $d\\ell/d\\theta \\approx q R_{0}$, where $q$ is the safety factor and $R_{0}$ is the major radius. To leading order, this term is constant. Since $d\\ell/d\\theta$ appears in both the numerator and the denominator of the bounce-average formula, it cancels out. The constant prefactor $v\\sqrt{\\lambda\\epsilon/2}$ in $|v_{\\parallel}(\\theta)|$ also cancels.\n\nThe bounce-average of $A(\\theta) = \\cos\\theta$ is therefore:\n$$\n\\langle \\cos\\theta \\rangle_{b} = \\frac{\\displaystyle \\int_{-\\theta_{t}}^{\\theta_{t}} \\frac{\\cos\\theta}{\\sqrt{\\theta_t^2 - \\theta^2}} \\, d\\theta}{\\displaystyle \\int_{-\\theta_{t}}^{\\theta_{t}} \\frac{1}{\\sqrt{\\theta_t^2 - \\theta^2}} \\, d\\theta}\n$$\nWe must use the same small-angle approximation for $\\cos\\theta$ in the numerator:\n$$\n\\langle \\cos\\theta \\rangle_{b} \\approx \\frac{\\displaystyle \\int_{-\\theta_{t}}^{\\theta_{t}} \\frac{1 - \\theta^2/2}{\\sqrt{\\theta_t^2 - \\theta^2}} \\, d\\theta}{\\displaystyle \\int_{-\\theta_{t}}^{\\theta_{t}} \\frac{1}{\\sqrt{\\theta_t^2 - \\theta^2}} \\, d\\theta}\n$$\nLet's evaluate the denominator integral, $D$:\n$$\nD = \\int_{-\\theta_{t}}^{\\theta_{t}} \\frac{1}{\\sqrt{\\theta_t^2 - \\theta^2}} \\, d\\theta = \\left[ \\arcsin\\left(\\frac{\\theta}{\\theta_t}\\right) \\right]_{-\\theta_{t}}^{\\theta_{t}} = \\arcsin(1) - \\arcsin(-1) = \\frac{\\pi}{2} - \\left(-\\frac{\\pi}{2}\\right) = \\pi\n$$\nNow, we evaluate the numerator integral, $N$:\n$$\nN = \\int_{-\\theta_{t}}^{\\theta_{t}} \\frac{1 - \\theta^2/2}{\\sqrt{\\theta_t^2 - \\theta^2}} \\, d\\theta = \\int_{-\\theta_{t}}^{\\theta_{t}} \\frac{1}{\\sqrt{\\theta_t^2 - \\theta^2}} \\, d\\theta - \\frac{1}{2} \\int_{-\\theta_{t}}^{\\theta_{t}} \\frac{\\theta^2}{\\sqrt{\\theta_t^2 - \\theta^2}} \\, d\\theta\n$$\nThe first term is simply $D = \\pi$. The second integral, let's call it $I_2$, can be solved with the trigonometric substitution $\\theta = \\theta_t \\sin\\phi$, which implies $d\\theta = \\theta_t \\cos\\phi \\, d\\phi$. The integration limits for $\\phi$ go from $-\\pi/2$ to $\\pi/2$.\n$$\nI_2 = \\int_{-\\pi/2}^{\\pi/2} \\frac{(\\theta_t \\sin\\phi)^2}{\\sqrt{\\theta_t^2 - \\theta_t^2 \\sin^2\\phi}} (\\theta_t \\cos\\phi \\, d\\phi) = \\int_{-\\pi/2}^{\\pi/2} \\frac{\\theta_t^2 \\sin^2\\phi}{\\theta_t \\cos\\phi} (\\theta_t \\cos\\phi \\, d\\phi)\n$$\n$$\nI_2 = \\theta_t^2 \\int_{-\\pi/2}^{\\pi/2} \\sin^2\\phi \\, d\\phi = \\theta_t^2 \\int_{-\\pi/2}^{\\pi/2} \\frac{1 - \\cos(2\\phi)}{2} \\, d\\phi\n$$\n$$\nI_2 = \\frac{\\theta_t^2}{2} \\left[ \\phi - \\frac{\\sin(2\\phi)}{2} \\right]_{-\\pi/2}^{\\pi/2} = \\frac{\\theta_t^2}{2} \\left[ \\left(\\frac{\\pi}{2} - 0\\right) - \\left(-\\frac{\\pi}{2} - 0\\right) \\right] = \\frac{\\theta_t^2 \\pi}{2}\n$$\nSubstituting this back into the expression for $N$:\n$$\nN = \\pi - \\frac{1}{2}I_2 = \\pi - \\frac{1}{2}\\left(\\frac{\\theta_t^2 \\pi}{2}\\right) = \\pi\\left(1 - \\frac{\\theta_t^2}{4}\\right)\n$$\nThe bounce average is the ratio of the numerator to the denominator:\n$$\n\\langle \\cos\\theta \\rangle_{b} = \\frac{N}{D} = \\frac{\\pi\\left(1 - \\frac{\\theta_t^2}{4}\\right)}{\\pi} = 1 - \\frac{\\theta_t^2}{4}\n$$\nFinally, we substitute the expression for $\\theta_t^2$ in terms of $\\lambda$ and $\\epsilon$:\n$$\n\\langle \\cos\\theta \\rangle_{b} = 1 - \\frac{1}{4} \\left( \\frac{2(1 - \\lambda + \\lambda\\epsilon)}{\\lambda\\epsilon} \\right) = 1 - \\frac{1 - \\lambda + \\lambda\\epsilon}{2\\lambda\\epsilon}\n$$\nThis expression can be simplified by combining the terms over a common denominator:\n$$\n\\langle \\cos\\theta \\rangle_{b} = \\frac{2\\lambda\\epsilon}{2\\lambda\\epsilon} - \\frac{1 - \\lambda + \\lambda\\epsilon}{2\\lambda\\epsilon} = \\frac{2\\lambda\\epsilon - 1 + \\lambda - \\lambda\\epsilon}{2\\lambda\\epsilon} = \\frac{\\lambda\\epsilon + \\lambda - 1}{2\\lambda\\epsilon}\n$$\nThis is the final closed-form analytic expression for the bounce-average of $\\cos\\theta$ for deeply trapped particles, to leading order in the relevant small parameters.",
            "answer": "$$\\boxed{\\frac{\\lambda\\epsilon + \\lambda - 1}{2\\lambda\\epsilon}}$$"
        },
        {
            "introduction": "While analytical approximations provide crucial physical insight, a full quantitative understanding of neoclassical physics requires tackling the exact, un-approximated bounce-orbit integrals. This comprehensive exercise bridges the gap between simplified theory and computational practice, a vital skill in modern plasma physics. You will be tasked with deriving the exact integral expressions for the bounce period and other bounce-averaged quantities, and then validating a numerical implementation against their well-known analytical solutions in terms of complete elliptic integrals. By successfully building and testing this routine, you will develop a practical tool and gain a deeper appreciation for the mathematical structure of banana orbits across the entire trapped-particle domain. ",
            "id": "4182194",
            "problem": "You are given a large-aspect-ratio, circular, concentric tokamak equilibrium with small inverse aspect ratio $\\epsilon = r / R_0$, safety factor $q$, and major radius $R_0$. Consider guiding-center motion of a single-species particle of speed $v$ in the poloidal angle coordinate $\\theta$ (angle unit: radians). The magnitude of the magnetic field in the large-aspect-ratio approximation is $B(\\theta) = B_0 \\left(1 - \\epsilon \\cos\\theta\\right)$, where $B_0$ is a reference magnetic field. Define the pitch parameter $\\lambda$ by $\\lambda = \\mu B_0 / \\mathcal{E}$ where $\\mu$ is the magnetic moment and $\\mathcal{E}$ is the total energy, so that the parallel speed is $v_{\\parallel}(\\theta) = v \\sqrt{1 - \\lambda \\, B(\\theta)/B_0} = v \\sqrt{1 - \\lambda \\left(1 - \\epsilon \\cos\\theta\\right)}$. Trapped motion occurs for $\\lambda$ satisfying $1/(1+\\epsilon) \\le \\lambda \\le 1/(1-\\epsilon)$, and the bounce points $\\pm \\theta_b$ are determined by $v_{\\parallel}(\\pm \\theta_b) = 0$.\n\nStarting only from these fundamentals (magnetic moment, energy conservation, and the large-aspect-ratio field variation), perform the following:\n\n1. Derive a mathematically explicit procedure to numerically compute the bounce period $\\tau_b(\\lambda)$, defined as the time to go from $-\\theta_b$ to $+\\theta_b$ and back to $-\\theta_b$, and the bounce-average $\\langle \\cos\\theta \\rangle_b$, defined as the time average of $\\cos\\theta$ over one bounce period. Use the definitions\n   $$\\tau_b(\\lambda) = 2 \\int_{-\\theta_b}^{\\theta_b} \\frac{d\\ell}{v_{\\parallel}(\\theta)}, \\quad \\langle \\cos\\theta \\rangle_b = \\frac{1}{\\tau_b(\\lambda)} \\, 2 \\int_{-\\theta_b}^{\\theta_b} \\frac{\\cos\\theta \\, d\\ell}{v_{\\parallel}(\\theta)},$$\n   where $d\\ell$ is the differential length element along the magnetic field line. In the large-aspect-ratio, circular limit, relate $d\\ell$ and $d\\theta$ through a constant metric factor and express both integrals in terms of $\\theta$ only.\n\n2. Independently, derive analytic large-aspect-ratio expressions for $\\tau_b(\\lambda)$ and $\\langle \\cos\\theta \\rangle_b$ in terms of complete elliptic integrals, starting from first principles and appropriate change(s) of variables.\n\n3. Implement a program that, for a given set of parameters, computes both the numerical values and the analytic values, and reports the relative differences for validation.\n\nPhysical and numerical details to be used:\n- Geometry and parameters: $R_0 = 1.8 \\, \\mathrm{m}$, $q = 1.7$ (dimensionless), $\\epsilon = 0.25$ (dimensionless), and particle speed $v = 1.0 \\times 10^6 \\, \\mathrm{m/s}$.\n- Angle unit for $\\theta$: radians.\n- The trapped pitch parameter range is $1/(1+\\epsilon) \\le \\lambda \\le 1/(1-\\epsilon)$. Use the following test suite of five $\\lambda$ values to test different regimes:\n  - Happy-path mid-trapped: $\\lambda = 0.90$.\n  - Moderately trapped: $\\lambda = 1.05$.\n  - More strongly trapped: $\\lambda = 1.20$.\n  - Near lower boundary (marginally trapped) but finite: $\\lambda = \\frac{1}{1+\\epsilon} + 10^{-3}$.\n  - Near upper boundary (deeply trapped) but finite: $\\lambda = \\frac{1}{1-\\epsilon} - 10^{-3}$.\n- Compute the bounce period $\\tau_b(\\lambda)$ in seconds, and $\\langle \\cos\\theta \\rangle_b$ as a dimensionless quantity.\n- For numerical integration, handle endpoint integrable singularities at the bounce points robustly and ensure high accuracy.\n\nAcceptance criterion and required output:\n- For each test case, compute the relative difference for the bounce period,\n  $$\\delta_{\\tau} = \\left|\\tau_b^{\\mathrm{num}} - \\tau_b^{\\mathrm{ana}}\\right| \\Big/ \\left|\\tau_b^{\\mathrm{ana}}\\right|,$$\n  and for the bounce-average,\n  $$\\delta_{\\mathrm{avg}} = \\left|\\langle \\cos\\theta \\rangle_b^{\\mathrm{num}} - \\langle \\cos\\theta \\rangle_b^{\\mathrm{ana}}\\right| \\Big/ \\max\\left(10^{-16}, \\left|\\langle \\cos\\theta \\rangle_b^{\\mathrm{ana}}\\right|\\right).$$\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, ordered by test case and metric. Specifically, list the relative differences for each test case in the order\n  $$\\left[\\delta_{\\tau}^{(1)}, \\delta_{\\mathrm{avg}}^{(1)}, \\delta_{\\tau}^{(2)}, \\delta_{\\mathrm{avg}}^{(2)}, \\ldots, \\delta_{\\tau}^{(5)}, \\delta_{\\mathrm{avg}}^{(5)}\\right].$$\nAll numerical values must be computed in SI units, with $\\tau_b$ expressed in seconds. No percentages are allowed; report the relative differences as decimal floats.",
            "solution": "### Part 1: Derivation for Numerical Computation\n\nWe are given the definitions for the bounce period $\\tau_b$ and an auxiliary integral $I_c$ for the bounce-average $\\langle \\cos\\theta \\rangle_b$:\n$$\n\\tau_b(\\lambda) = 2 \\int_{-\\theta_b}^{\\theta_b} \\frac{d\\ell}{v_{\\parallel}(\\theta)}\n$$\n$$\nI_c(\\lambda) = 2 \\int_{-\\theta_b}^{\\theta_b} \\frac{\\cos\\theta \\, d\\ell}{v_{\\parallel}(\\theta)}\n$$\n$$\n\\langle \\cos\\theta \\rangle_b = \\frac{I_c(\\lambda)}{\\tau_b(\\lambda)}\n$$\n\nThe parallel velocity is given by $v_{\\parallel}(\\theta) = v \\sqrt{1 - \\lambda \\left(1 - \\epsilon \\cos\\theta\\right)}$. The bounce points $\\pm \\theta_b$ are the poloidal angles where the parallel velocity vanishes, $v_{\\parallel}(\\pm \\theta_b) = 0$. This condition leads to:\n$$\n1 - \\lambda \\left(1 - \\epsilon \\cos\\theta_b\\right) = 0 \\implies 1 - \\lambda + \\lambda\\epsilon\\cos\\theta_b = 0\n$$\nSolving for $\\cos\\theta_b$ gives the location of the bounce points:\n$$\n\\cos\\theta_b = \\frac{\\lambda - 1}{\\lambda\\epsilon}\n$$\nThe bounce angle is thus $\\theta_b = \\arccos\\left(\\frac{\\lambda-1}{\\lambda\\epsilon}\\right)$. The integration limits are from $-\\theta_b$ to $\\theta_b$.\n\nThe differential length element along the magnetic field line, $d\\ell$, is related to the differential poloidal angle, $d\\theta$, in a large-aspect-ratio, circular tokamak by $d\\ell \\approx qR_0 d\\theta$. Here, $q$ is the safety factor and $R_0$ is the major radius. This relation arises from considering the pitch of the helical magnetic field lines.\n\nSubstituting $d\\ell$ and $v_{\\parallel}(\\theta)$ into the integrals, and noting that the integrands are even functions of $\\theta$, we can simplify the integration range from $[-\\theta_b, \\theta_b]$ to $[0, \\theta_b]$ and multiply by another factor of $2$:\n$$\n\\tau_b(\\lambda) = 2 \\int_{-\\theta_b}^{\\theta_b} \\frac{qR_0 d\\theta}{v \\sqrt{1 - \\lambda + \\lambda\\epsilon\\cos\\theta}} = \\frac{4qR_0}{v} \\int_{0}^{\\theta_b} \\frac{d\\theta}{\\sqrt{1 - \\lambda + \\lambda\\epsilon\\cos\\theta}}\n$$\nSimilarly, for the numerator of the bounce-average:\n$$\nI_c(\\lambda) = \\frac{4qR_0}{v} \\int_{0}^{\\theta_b} \\frac{\\cos\\theta \\, d\\theta}{\\sqrt{1 - \\lambda + \\lambda\\epsilon\\cos\\theta}}\n$$\nThe bounce-average is then $\\langle \\cos\\theta \\rangle_b = I_c(\\lambda) / \\tau_b(\\lambda)$. These forms are suitable for numerical quadrature. Note that the denominator goes to zero at the upper integration limit $\\theta = \\theta_b$, creating an integrable singularity that must be handled by the numerical routine.\n\n### Part 2: Derivation of Analytic Expressions\n\nTo find an analytic solution, we transform the integrals into the standard forms of complete elliptic integrals. First, we rewrite the term under the square root using half-angle identities:\n$$\n\\cos\\theta = 1 - 2\\sin^2(\\theta/2)\n$$\n$$\n\\cos\\theta_b = 1 - 2\\sin^2(\\theta_b/2)\n$$\nThe expression $\\cos\\theta - \\cos\\theta_b$ becomes $2(\\sin^2(\\theta_b/2) - \\sin^2(\\theta/2))$.\nThe term in the radical is:\n$$\n1 - \\lambda + \\lambda\\epsilon\\cos\\theta = \\lambda\\epsilon\\left(\\frac{1-\\lambda}{\\lambda\\epsilon} + \\cos\\theta\\right) = \\lambda\\epsilon(\\cos\\theta_b - \\cos\\theta) = 2\\lambda\\epsilon\\left(\\sin^2(\\frac{\\theta_b}{2}) - \\sin^2(\\frac{\\theta}{2})\\right)\n$$\nLet's define a parameter $m$ (commonly denoted $k^2$ in literature) as $m = \\sin^2(\\theta_b/2)$. Using the half-angle formula for sine:\n$$\nm = \\sin^2(\\frac{\\theta_b}{2}) = \\frac{1 - \\cos\\theta_b}{2} = \\frac{1 - \\frac{\\lambda-1}{\\lambda\\epsilon}}{2} = \\frac{\\lambda\\epsilon - \\lambda + 1}{2\\lambda\\epsilon}\n$$\nThe radical is now $\\sqrt{2\\lambda\\epsilon(m - \\sin^2(\\theta/2))}$. The integrals become:\n$$\n\\tau_b(\\lambda) = \\frac{4qR_0}{v\\sqrt{2\\lambda\\epsilon}} \\int_{0}^{\\theta_b} \\frac{d\\theta}{\\sqrt{m - \\sin^2(\\theta/2)}}\n$$\n$$\nI_c(\\lambda) = \\frac{4qR_0}{v\\sqrt{2\\lambda\\epsilon}} \\int_{0}^{\\theta_b} \\frac{\\cos\\theta \\, d\\theta}{\\sqrt{m - \\sin^2(\\theta/2)}}\n$$\nWe introduce a change of variables: $\\sin(\\theta/2) = \\sqrt{m} \\sin\\psi$.\nThe differential is $\\frac{1}{2}\\cos(\\theta/2)d\\theta = \\sqrt{m}\\cos\\psi d\\psi$, which gives $d\\theta = \\frac{2\\sqrt{m}\\cos\\psi d\\psi}{\\cos(\\theta/2)} = \\frac{2\\sqrt{m}\\cos\\psi d\\psi}{\\sqrt{1 - m\\sin^2\\psi}}$.\nThe integration limits for $\\psi$ are from $0$ to $\\pi/2$. The term in the square root of the integrand becomes $\\sqrt{m - m\\sin^2\\psi} = \\sqrt{m}\\cos\\psi$.\n\nSubstituting into the integral for $\\tau_b(\\lambda)$:\n$$\n\\tau_b(\\lambda) = \\frac{4qR_0}{v\\sqrt{2\\lambda\\epsilon}} \\int_{0}^{\\pi/2} \\frac{1}{\\sqrt{m}\\cos\\psi} \\frac{2\\sqrt{m}\\cos\\psi d\\psi}{\\sqrt{1 - m\\sin^2\\psi}} = \\frac{8qR_0}{v\\sqrt{2\\lambda\\epsilon}} \\int_{0}^{\\pi/2} \\frac{d\\psi}{\\sqrt{1 - m\\sin^2\\psi}}\n$$\nThe integral is the definition of the complete elliptic integral of the first kind, $K(m)$.\n$$\n\\tau_b^{\\mathrm{ana}}(\\lambda) = \\frac{8qR_0}{v\\sqrt{2\\lambda\\epsilon}} K(m) = \\frac{4\\sqrt{2}qR_0}{v\\sqrt{\\lambda\\epsilon}} K(m)\n$$\nFor the bounce-average, we express $\\cos\\theta$ in terms of $\\psi$: $\\cos\\theta = 1 - 2\\sin^2(\\theta/2) = 1 - 2m\\sin^2\\psi$.\n$$\nI_c(\\lambda) = \\frac{8qR_0}{v\\sqrt{2\\lambda\\epsilon}} \\int_{0}^{\\pi/2} \\frac{1 - 2m\\sin^2\\psi}{\\sqrt{1 - m\\sin^2\\psi}} d\\psi\n$$\nThe integral can be split: $\\int \\frac{d\\psi}{\\sqrt{...}} - 2m \\int \\frac{\\sin^2\\psi}{\\sqrt{...}} d\\psi$. The first part is $K(m)$. The second part is related to the complete elliptic integral of the second kind, $E(m) = \\int_{0}^{\\pi/2} \\sqrt{1-m\\sin^2\\psi} d\\psi$.\nFrom the relation $K(m) - E(m) = m\\int_{0}^{\\pi/2} \\frac{\\sin^2\\psi}{\\sqrt{1 - m\\sin^2\\psi}} d\\psi$, the integral for $I_c$ evaluates to $K(m) - 2(K(m) - E(m)) = 2E(m) - K(m)$.\n$$\nI_c(\\lambda) = \\frac{4\\sqrt{2}qR_0}{v\\sqrt{\\lambda\\epsilon}} \\left( 2E(m) - K(m) \\right)\n$$\nThe bounce-average is the ratio of $I_c$ to $\\tau_b$:\n$$\n\\langle \\cos\\theta \\rangle_b^{\\mathrm{ana}} = \\frac{I_c(\\lambda)}{\\tau_b(\\lambda)} = \\frac{2E(m) - K(m)}{K(m)} = \\frac{2E(m)}{K(m)} - 1\n$$\n\n### Summary of Formulae\n- **Parameters**: $R_0=1.8\\,\\mathrm{m}$, $q=1.7$, $\\epsilon=0.25$, $v=1.0 \\times 10^6\\,\\mathrm{m/s}$.\n- **Numerical Calculation**:\n    - $\\theta_b = \\arccos\\left(\\frac{\\lambda-1}{\\lambda\\epsilon}\\right)$\n    - $\\tau_b^{\\mathrm{num}} = \\frac{4qR_0}{v} \\int_{0}^{\\theta_b} (1 - \\lambda + \\lambda\\epsilon\\cos\\theta)^{-1/2} d\\theta$\n    - $\\langle \\cos\\theta \\rangle_b^{\\mathrm{num}} = \\left(\\int_{0}^{\\theta_b} \\frac{\\cos\\theta \\, d\\theta}{\\sqrt{1 - \\lambda + \\lambda\\epsilon\\cos\\theta}}\\right) \\Big/ \\left(\\int_{0}^{\\theta_b} \\frac{d\\theta}{\\sqrt{1 - \\lambda + \\lambda\\epsilon\\cos\\theta}}\\right)$\n- **Analytical Calculation**:\n    - $m = \\frac{1-\\lambda+\\lambda\\epsilon}{2\\lambda\\epsilon}$\n    - $\\tau_b^{\\mathrm{ana}} = \\frac{4\\sqrt{2}qR_0}{v\\sqrt{\\lambda\\epsilon}} K(m)$\n    - $\\langle \\cos\\theta \\rangle_b^{\\mathrm{ana}} = \\frac{2E(m)}{K(m)} - 1$\nHere $K(m)$ and $E(m)$ are complete elliptic integrals of the first and second kind, respectively, available in SciPy.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import integrate\nfrom scipy import special\n\ndef solve():\n    \"\"\"\n    Implements the solution to calculate and compare numerical and analytical\n    expressions for bounce period and bounce-averaged quantities for trapped\n    particles in a tokamak.\n    \"\"\"\n    # Define physical and geometrical constants from the problem statement.\n    R0 = 1.8  # Major radius in meters\n    q = 1.7   # Safety factor (dimensionless)\n    eps = 0.25 # Inverse aspect ratio (dimensionless)\n    v = 1.0e6 # Particle speed in m/s\n    \n    # Define the suite of test cases for the pitch parameter lambda.\n    # The trapped particle domain is [1/(1+eps), 1/(1-eps)].\n    lambda_min = 1.0 / (1.0 + eps)  # approx 0.8\n    lambda_max = 1.0 / (1.0 - eps)  # approx 1.333...\n\n    test_cases = [\n        0.90,                           # Happy-path mid-trapped\n        1.05,                           # Moderately trapped\n        1.20,                           # More strongly trapped\n        lambda_min + 1e-3,              # Near lower boundary (marginally trapped)\n        lambda_max - 1e-3               # Near upper boundary (deeply trapped)\n    ]\n    \n    results = []\n\n    for lam in test_cases:\n        # --- Numerical Calculation ---\n        \n        # Calculate the bounce angle theta_b.\n        # This is the upper limit of integration and a singularity point.\n        cos_theta_b = (lam - 1.0) / (lam * eps)\n        # Ensure argument is within arccos domain for floating point safety\n        cos_theta_b_clipped = np.clip(cos_theta_b, -1.0, 1.0)\n        theta_b = np.arccos(cos_theta_b_clipped)\n        \n        # Define the integrands for the bounce period and bounce-average numerator.\n        # The common denominator is sqrt(1 - lam + lam*eps*cos(theta)).\n        def integrand_tau(theta, lam_val, eps_val):\n            return 1.0 / np.sqrt(1.0 - lam_val + lam_val * eps_val * np.cos(theta))\n\n        def integrand_cos_avg(theta, lam_val, eps_val):\n            return np.cos(theta) / np.sqrt(1.0 - lam_val + lam_val * eps_val * np.cos(theta))\n\n        # Perform numerical integration using SciPy's quad.\n        # The 'points' argument is critical for handling the integrable singularity\n        # at the endpoint theta_b, ensuring accuracy and performance.\n        tau_integral_val, _ = integrate.quad(\n            integrand_tau, 0, theta_b, args=(lam, eps), points=[theta_b]\n        )\n        cos_integral_val, _ = integrate.quad(\n            integrand_cos_avg, 0, theta_b, args=(lam, eps), points=[theta_b]\n        )\n        \n        # Calculate the numerical values for tau_b and <cos(theta)>_b.\n        # The factor of 4qR0/v comes from 2 * (integral from -theta_b to theta_b)\n        # which becomes 4 * (integral from 0 to theta_b) due to symmetry.\n        tau_b_num = (4.0 * q * R0 / v) * tau_integral_val\n        avg_cos_num = cos_integral_val / tau_integral_val\n\n        # --- Analytical Calculation ---\n        \n        # Calculate the elliptic integral parameter m = k^2.\n        m = (1.0 - lam + lam * eps) / (2.0 * lam * eps)\n        \n        # Get complete elliptic integrals K(m) and E(m).\n        # scipy.special functions take m = k^2 as their argument.\n        K_m = special.ellipk(m)\n        E_m = special.ellipe(m)\n        \n        # Calculate analytic bounce period.\n        tau_b_ana = (4.0 * np.sqrt(2.0) * q * R0) / (v * np.sqrt(lam * eps)) * K_m\n        \n        # Calculate analytic bounce-averaged cos(theta).\n        avg_cos_ana = (2.0 * E_m / K_m) - 1.0\n        \n        # --- Comparison ---\n        \n        # Calculate relative difference for bounce period.\n        delta_tau = np.abs(tau_b_num - tau_b_ana) / np.abs(tau_b_ana)\n        \n        # Calculate relative difference for bounce-average.\n        # Denominator is protected against division by zero, as <cos(theta)> can be zero.\n        denominator_avg = np.maximum(1e-16, np.abs(avg_cos_ana))\n        delta_avg = np.abs(avg_cos_num - avg_cos_ana) / denominator_avg\n        \n        results.extend([delta_tau, delta_avg])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}