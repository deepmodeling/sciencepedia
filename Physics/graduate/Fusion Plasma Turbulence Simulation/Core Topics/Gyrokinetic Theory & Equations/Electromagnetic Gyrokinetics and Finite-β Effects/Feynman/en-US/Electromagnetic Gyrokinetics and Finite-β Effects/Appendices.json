{
    "hands_on_practices": [
        {
            "introduction": "Before diving into complex simulations, it is crucial to grasp *why* finite-$\\beta$ effects are fundamentally important. This exercise guides you through a first-principles derivation based on perpendicular pressure balance, demonstrating how neglecting compressional magnetic fluctuations leads to an error that scales with the plasma beta, $\\beta_i$ . Mastering this connection is key to appreciating the necessary transition from electrostatic to electromagnetic plasma models.",
            "id": "4188499",
            "problem": "Consider a homogeneous, tokamak-like plasma core with a uniform equilibrium magnetic field magnitude $B_0$ and a single ion species characterized by number density $n_i$ and temperature $T_i$, where $T_i$ is measured in energy units so that the ion thermal pressure is $p_{i} = n_i T_i$. Assume low-frequency, anisotropic turbulence in the electromagnetic gyrokinetic (GK) regime with $\\omega \\ll \\Omega_i$ and $k_{\\perp} \\rho_i \\sim 1$, and consider fluctuations that are small in the gyrokinetic ordering sense. In this regime, perpendicular force balance is obtained from the perpendicular component of the Magnetohydrodynamics (MHD) momentum equation and the Maxwell stress tensor. \n\nStarting from the fundamental perpendicular pressure balance implied by the combination of the MHD momentum equation and Maxwell stress, and using that the leading-order magnetic pressure perturbation is $\\delta(B^2/8\\pi) \\simeq (B_0 \\delta B_{\\|})/(4\\pi)$ for compressional magnetic fluctuations $\\delta B_{\\|}$, derive the leading-order balance between the perpendicular thermal pressure perturbation $\\delta p_{\\perp}$ and the compressional magnetic pressure perturbation. Then, define the ion plasma beta as the ratio of ion thermal pressure to equilibrium magnetic pressure, $\\beta_i \\equiv p_i/p_{\\mathrm{mag}}$, with $p_{\\mathrm{mag}} \\equiv B_0^2/(8\\pi)$ in Gaussian centimeter–gram–second (cgs) units. \n\nBy quantifying the effect of neglecting the compressional magnetic fluctuation $\\delta B_{\\|}$ in the perpendicular pressure balance, compute the leading-order fractional error, measured relative to the equilibrium magnetic pressure $p_{\\mathrm{mag}}$, that is introduced by setting $\\delta B_{\\|}=0$. Express your final answer as a single closed-form analytical expression in terms of $n_i$, $T_i$, and $B_0$ only. Do not include units in your final boxed expression. The result should make explicit how the error scales with $\\beta_i$ and hence identify the $\\beta$ regime in which the error is of order $\\beta$.",
            "solution": "The problem asks for the leading-order fractional error introduced in the perpendicular pressure balance by neglecting the compressional magnetic fluctuation $\\delta B_\\|$. The error is to be measured relative to the equilibrium magnetic pressure $p_{\\mathrm{mag}}$.\n\nFirst, we establish the perpendicular pressure balance equation. The problem states that in the low-frequency electromagnetic gyrokinetic regime, the perpendicular force balance is determined by the Magnetohydrodynamics (MHD) momentum equation. The relevant component of this balance, perpendicular to the magnetic field direction, states that the sum of the perpendicular thermal pressure and the magnetic pressure is constant across the magnetic field lines. For a homogeneous equilibrium, this balance applies to the fluctuating quantities:\n$$\n\\delta p_{\\perp} + \\delta p_{\\mathrm{mag}} = 0\n$$\nHere, $\\delta p_{\\perp}$ is the perturbation in the perpendicular thermal pressure and $\\delta p_{\\mathrm{mag}} = \\delta(B^2/8\\pi)$ is the perturbation in the magnetic pressure. The problem provides the leading-order expression for the magnetic pressure perturbation for compressional fluctuations $\\delta B_\\|$ (fluctuations in the magnitude of the magnetic field parallel to the equilibrium field $\\mathbf{B}_0$):\n$$\n\\delta p_{\\mathrm{mag}} = \\delta \\left( \\frac{B^2}{8\\pi} \\right) \\simeq \\frac{B_0 \\delta B_{\\|}}{4\\pi}\n$$\nwhere $B_0$ is the magnitude of the equilibrium magnetic field. Substituting this into the pressure balance equation yields the leading-order balance between the perpendicular thermal pressure perturbation and the compressional magnetic pressure perturbation:\n$$\n\\delta p_{\\perp} + \\frac{B_0 \\delta B_{\\|}}{4\\pi} = 0\n$$\nThis equation represents the \"correct\" physical model in this regime.\n\nNext, we must quantify the error introduced by setting $\\delta B_\\| = 0$. Setting $\\delta B_\\| = 0$ corresponds to adopting an electrostatic model, where magnetic fluctuations are ignored. In the context of the pressure balance equation, this approximation means neglecting the term $\\frac{B_0 \\delta B_{\\|}}{4\\pi}$. Let's call this the \"neglected term\". The magnitude of this term is fixed by the balance equation itself:\n$$\n\\left| \\frac{B_0 \\delta B_{\\|}}{4\\pi} \\right| = | - \\delta p_{\\perp} | = |\\delta p_{\\perp}|\n$$\nThe problem asks for the fractional error, $\\mathcal{E}$, which is the magnitude of the neglected term measured relative to the equilibrium magnetic pressure, $p_{\\mathrm{mag}}$. The equilibrium magnetic pressure is defined as:\n$$\np_{\\mathrm{mag}} = \\frac{B_0^2}{8\\pi}\n$$\nThe fractional error is therefore:\n$$\n\\mathcal{E} = \\frac{\\left| \\text{neglected term} \\right|}{p_{\\mathrm{mag}}} = \\frac{|\\delta p_{\\perp}|}{p_{\\mathrm{mag}}}\n$$\nTo obtain a final expression in terms of equilibrium quantities ($n_i$, $T_i$, $B_0$), we must determine the characteristic magnitude of the perpendicular pressure fluctuation, $|\\delta p_{\\perp}|$. The problem describes a plasma with a single ion species, characterized by density $n_i$ and temperature $T_i$. In the gyrokinetic turbulence regime specified ($\\omega \\ll \\Omega_i$, $k_{\\perp} \\rho_i \\sim 1$), the pressure fluctuations are driven by the free energy available in the plasma, which scales with the thermal energy. Therefore, the characteristic magnitude of the ion perpendicular pressure fluctuation, $\\delta p_{\\perp i}$, is of the order of the equilibrium ion thermal pressure, $p_i$. Assuming that $\\delta p_{\\perp}$ in the balance equation is dominated by the ion contribution, we make the physically motivated substitution:\n$$\n|\\delta p_{\\perp}| \\sim p_i = n_i T_i\n$$\nwhere $T_i$ is in energy units as specified.\n\nSubstituting this characteristic magnitude into the expression for the fractional error $\\mathcal{E}$:\n$$\n\\mathcal{E} \\approx \\frac{p_i}{p_{\\mathrm{mag}}} = \\frac{n_i T_i}{B_0^2 / (8\\pi)}\n$$\nSimplifying this expression gives the final result:\n$$\n\\mathcal{E} \\approx \\frac{8\\pi n_i T_i}{B_0^2}\n$$\nThis expression represents the leading-order fractional error. The problem also asks to relate this to the ion plasma beta, $\\beta_i$, defined as the ratio of ion thermal pressure to equilibrium magnetic pressure:\n$$\n\\beta_i \\equiv \\frac{p_i}{p_{\\mathrm{mag}}} = \\frac{n_i T_i}{B_0^2 / (8\\pi)} = \\frac{8\\pi n_i T_i}{B_0^2}\n$$\nComparing our result for the fractional error with the definition of $\\beta_i$, we find that $\\mathcal{E} \\approx \\beta_i$. This confirms the final part of the problem statement: the error introduced by neglecting compressional magnetic fluctuations (i.e., by using an electrostatic approximation) is of order $\\beta_i$. This is a fundamental result in plasma physics, indicating that electromagnetic effects become significant and cannot be neglected in plasmas where the thermal pressure is a non-negligible fraction of the magnetic pressure (i.e., in a \"finite-$\\beta$\" regime). The final closed-form analytical expression for the leading-order fractional error is $\\frac{8\\pi n_i T_i}{B_0^2}$.",
            "answer": "$$\n\\boxed{\\frac{8\\pi n_i T_i}{B_0^2}}\n$$"
        },
        {
            "introduction": "Having established the importance of magnetic fluctuations, we now dissect their energetic contributions within a key instability. This practice focuses on a model for a kinetic ballooning mode and asks you to derive the energies associated with magnetic field-line bending versus magnetic compression . This calculation provides a tangible understanding of the anisotropic structure of low-frequency electromagnetic turbulence and how energy is partitioned in such systems.",
            "id": "4188503",
            "problem": "Consider a local slab model of a low-frequency electromagnetic perturbation representative of a kinetic ballooning mode in fusion plasma turbulence. The equilibrium magnetic field is uniform, $\\mathbf{B}_0 = B_0 \\hat{\\mathbf{z}}$, and the perturbation can be described in the gyrokinetic (GK) low-frequency limit by a fluid displacement $\\boldsymbol{\\xi}(\\mathbf{r},t)$ that is transverse to $\\mathbf{B}_0$. In this limit, the magnetic perturbation follows from the ideal magnetohydrodynamics (MHD) induction relation, $\\delta \\mathbf{B} = \\nabla \\times (\\boldsymbol{\\xi} \\times \\mathbf{B}_0)$, which is consistent with the perpendicular dynamics retained in electromagnetic GK for $\\omega \\ll \\Omega_i$.\n\nAssume a single Fourier mode with wavevector $\\mathbf{k} = \\mathbf{k}_\\perp + k_\\| \\hat{\\mathbf{z}}$, where $\\mathbf{k}_\\perp = k_\\perp \\hat{\\mathbf{x}}$, and a purely perpendicular polarization $\\boldsymbol{\\xi}(\\mathbf{r}) = \\Re\\{\\xi_0 \\hat{\\mathbf{x}} \\exp(i \\mathbf{k} \\cdot \\mathbf{r})\\}$, with real amplitude $\\xi_0$. Using only the stated fundamental relations, derive the compressional magnetic energy density, defined as the energy in the parallel magnetic perturbation,\n$$U_{\\mathrm{comp}} = \\frac{|\\delta B_\\||^2}{2 \\mu_0},$$\nand the field-line bending magnetic energy density, defined as the energy in the perpendicular magnetic perturbation,\n$$U_{\\mathrm{bend}} = \\frac{|\\delta \\mathbf{B}_\\perp|^2}{2 \\mu_0},$$\nexpressed in terms of $B_0$, $\\mu_0$, $k_\\perp$, $k_\\|$, and $\\xi_0$.\n\nThen, using the parameters $B_0 = 2.5\\,\\mathrm{T}$, $k_\\perp = 40\\,\\mathrm{m}^{-1}$, $k_\\| = 0.8\\,\\mathrm{m}^{-1}$, and $\\xi_0 = 1.5 \\times 10^{-3}\\,\\mathrm{m}$, evaluate the dimensionless ratio\n$$R \\equiv \\frac{U_{\\mathrm{comp}}}{U_{\\mathrm{bend}}}.$$\nThis ratio provides a quantitative comparison of the compressional energy associated with $\\delta B_\\|$ to the field-line bending energy for the given perpendicular scale.\n\nCompute and report the final value of $R$. Round your final answer to four significant figures. The intermediate energy densities $U_{\\mathrm{comp}}$ and $U_{\\mathrm{bend}}$ should be expressed in $\\mathrm{J}\\,\\mathrm{m}^{-3}$, but the final reported quantity $R$ must be dimensionless.",
            "solution": "We begin from the induction relation of ideal magnetohydrodynamics (MHD), which is applicable to the low-frequency electromagnetic gyrokinetic (GK) limit for transverse displacements,\n$$\n\\delta \\mathbf{B} = \\nabla \\times (\\boldsymbol{\\xi} \\times \\mathbf{B}_0).\n$$\nFor a single Fourier mode, $\\boldsymbol{\\xi}(\\mathbf{r}) = \\Re\\{\\boldsymbol{\\xi} \\exp(i \\mathbf{k} \\cdot \\mathbf{r})\\}$, the Fourier amplitude satisfies\n$$\n\\delta \\mathbf{B}(\\mathbf{k}) = i \\mathbf{k} \\times (\\boldsymbol{\\xi} \\times \\mathbf{B}_0).\n$$\nUsing the vector triple product identity,\n$$\n\\mathbf{k} \\times (\\boldsymbol{\\xi} \\times \\mathbf{B}_0) = (\\mathbf{B}_0 \\cdot \\mathbf{k}) \\boldsymbol{\\xi} - (\\boldsymbol{\\xi} \\cdot \\mathbf{k}) \\mathbf{B}_0,\n$$\nwe obtain\n$$\n\\delta \\mathbf{B} = i \\left[ (\\mathbf{B}_0 \\cdot \\mathbf{k}) \\boldsymbol{\\xi} - (\\boldsymbol{\\xi} \\cdot \\mathbf{k}) \\mathbf{B}_0 \\right].\n$$\nWe choose $\\mathbf{B}_0 = B_0 \\hat{\\mathbf{z}}$, $\\mathbf{k} = k_\\perp \\hat{\\mathbf{x}} + k_\\| \\hat{\\mathbf{z}}$, and $\\boldsymbol{\\xi} = \\xi_0 \\hat{\\mathbf{x}}$ (purely perpendicular). Then,\n$$\n\\mathbf{B}_0 \\cdot \\mathbf{k} = B_0 k_\\|, \\quad \\boldsymbol{\\xi} \\cdot \\mathbf{k} = \\xi_0 k_\\perp,\n$$\nand hence\n$$\n\\delta \\mathbf{B} = i \\left[ B_0 k_\\| \\xi_0 \\hat{\\mathbf{x}} - \\xi_0 k_\\perp B_0 \\hat{\\mathbf{z}} \\right].\n$$\nTherefore, separating into perpendicular and parallel components relative to $\\mathbf{B}_0$,\n$$\n\\delta \\mathbf{B}_\\perp = i B_0 k_\\| \\xi_0 \\hat{\\mathbf{x}}, \\quad \\delta B_\\| = - i B_0 k_\\perp \\xi_0.\n$$\nThe magnitudes are\n$$\n|\\delta \\mathbf{B}_\\perp| = B_0 k_\\| |\\xi_0|, \\quad |\\delta B_\\|| = B_0 k_\\perp |\\xi_0|.\n$$\n\nThe compressional magnetic energy density associated with the parallel magnetic perturbation is\n$$\nU_{\\mathrm{comp}} = \\frac{|\\delta B_\\||^2}{2 \\mu_0} = \\frac{B_0^2 k_\\perp^2 \\xi_0^2}{2 \\mu_0}.\n$$\nThe field-line bending magnetic energy density associated with the perpendicular magnetic perturbation is\n$$\nU_{\\mathrm{bend}} = \\frac{|\\delta \\mathbf{B}_\\perp|^2}{2 \\mu_0} = \\frac{B_0^2 k_\\|^2 \\xi_0^2}{2 \\mu_0}.\n$$\nThe ratio of compressional to bending energy is then\n$$\nR \\equiv \\frac{U_{\\mathrm{comp}}}{U_{\\mathrm{bend}}} = \\frac{B_0^2 k_\\perp^2 \\xi_0^2}{2 \\mu_0} \\left/ \\frac{B_0^2 k_\\|^2 \\xi_0^2}{2 \\mu_0} \\right. = \\frac{k_\\perp^2}{k_\\|^2}.\n$$\n\nWe now evaluate $R$ for the given parameters $k_\\perp = 40\\,\\mathrm{m}^{-1}$ and $k_\\| = 0.8\\,\\mathrm{m}^{-1}$:\n$$\nR = \\left( \\frac{40}{0.8} \\right)^2 = 50^2 = 2500.\n$$\n\nFor completeness and unit consistency, we also compute the intermediate energy densities in $\\mathrm{J}\\,\\mathrm{m}^{-3}$ using $B_0 = 2.5\\,\\mathrm{T}$, $\\xi_0 = 1.5 \\times 10^{-3}\\,\\mathrm{m}$, and the magnetic permeability of free space $\\mu_0$:\n$$\nU_{\\mathrm{comp}} = \\frac{B_0^2 k_\\perp^2 \\xi_0^2}{2 \\mu_0} = \\frac{(2.5)^2 \\times (40)^2 \\times (1.5 \\times 10^{-3})^2}{2 \\mu_0}.\n$$\nCompute the factors symbolically first:\n$$\nB_0^2 = 6.25, \\quad k_\\perp^2 = 1600, \\quad \\xi_0^2 = 2.25 \\times 10^{-6},\n$$\nso\n$$\nB_0^2 k_\\perp^2 \\xi_0^2 = 6.25 \\times 1600 \\times 2.25 \\times 10^{-6} = 1.0 \\times 10^{4} \\times 2.25 \\times 10^{-6} = 2.25 \\times 10^{-2}.\n$$\nThus,\n$$\nU_{\\mathrm{comp}} = \\frac{2.25 \\times 10^{-2}}{2 \\mu_0}.\n$$\nUsing $\\mu_0 = 4 \\pi \\times 10^{-7}\\,\\mathrm{H}\\,\\mathrm{m}^{-1}$,\n$$\nU_{\\mathrm{comp}} = \\frac{2.25 \\times 10^{-2}}{8 \\pi \\times 10^{-7}} \\approx 8.95 \\times 10^{3}\\,\\mathrm{J}\\,\\mathrm{m}^{-3}.\n$$\nSimilarly,\n$$\nU_{\\mathrm{bend}} = \\frac{B_0^2 k_\\|^2 \\xi_0^2}{2 \\mu_0} = U_{\\mathrm{comp}} \\times \\frac{k_\\|^2}{k_\\perp^2} = \\frac{8.95 \\times 10^{3}}{2500} \\approx 3.58\\,\\mathrm{J}\\,\\mathrm{m}^{-3}.\n$$\n\nThe requested final quantity is the dimensionless ratio $R$, which evaluates to $2500$. Rounding to four significant figures and expressing in standard scientific notation yields $2.500 \\times 10^{3}$.",
            "answer": "$$\\boxed{2.500 \\times 10^{3}}$$"
        },
        {
            "introduction": "Theoretical understanding must be complemented by robust numerical modeling, which requires careful implementation of schemes that respect physical conservation laws. This exercise challenges you to implement a numerical solver for a simplified two-field electromagnetic gyrokinetic system and verify a core principle: the conservation of a discrete quadratic invariant . Successfully implementing and analyzing a structure-preserving scheme like Crank-Nicolson provides foundational skills for developing and validating complex simulation codes.",
            "id": "4188445",
            "problem": "Consider a single Fourier mode in slab geometry for electromagnetic gyrokinetics with finite plasma beta, characterized by the electrostatic potential $\\phi_k(t)$ and the parallel vector potential $A_{\\parallel,k}(t)$. Work in dimensionless normalization (all quantities are dimensionless; no physical units are used). Assume linear dynamics with adiabatic electrons and neglect compressional magnetic fluctuations so that the parallel dynamics reduces to a two-field system. Define the perpendicular wavenumber parameter $b = k_\\perp^2 \\rho_i^2$, where $\\rho_i$ is the ion Larmor radius, the ion-to-electron temperature ratio $\\tau = T_i/T_e$, and the dimensionless electron beta $\\beta_e$. The ion gyroaveraging enters through the modified Bessel function of the first kind of order $0$, denoted $I_0(b)$, via the standard gyrokinetic operator $\\Gamma_0(b) = I_0(b) e^{-b}$. The ion polarization response is $\\Lambda_i(b,\\tau) = 1 + \\tau - \\Gamma_0(b)$. The Alfvénic coupling frequency is $\\alpha(k_\\|,\\beta_e) = k_\\|/\\sqrt{\\beta_e}$.\n\nStarting from Maxwell's equations (specifically Faraday's law and Ampère's law) and gyrokinetic quasi-neutrality, the linearized spectral system for this single mode can be written as the two-dimensional ordinary differential equation\n$$\n\\frac{d}{dt}\n\\begin{pmatrix}\n\\phi_k \\\\\nA_{\\parallel,k}\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n0 & \\alpha \\\\\n-\\alpha \\Lambda_i & 0\n\\end{pmatrix}\n\\begin{pmatrix}\n\\phi_k \\\\\nA_{\\parallel,k}\n\\end{pmatrix},\n$$\nwhere $\\alpha = \\alpha(k_\\|,\\beta_e)$ and $\\Lambda_i = \\Lambda_i(b,\\tau)$. This system is Hamiltonian and possesses a quadratic energy-like invariant in the continuous-time limit.\n\nYour tasks are:\n- Derive, from the above physical starting point and system structure, a continuous-time quadratic invariant consistent with energy conservation for the above two-field system, expressed as a positive-definite quadratic form in $\\phi_k$ and $A_{\\parallel,k}$ with coefficients depending on $\\Lambda_i$.\n- Design a Crank–Nicolson (CN) time discretization for the system and construct a discrete quadratic invariant that is exactly preserved by the CN update. Your invariant must be expressed as a quadratic form evaluated on the discrete-time solution at time level $n$, and must reduce to the continuous invariant in the limit of vanishing time step. Explain how the skew-adjointness of the linear operator with respect to an appropriate inner product ensures exact preservation under CN.\n- Implement a program that advances the system using the CN scheme and verifies numerically that your discrete invariant remains constant in time for a set of test cases. For each test case, compute the maximum absolute relative change of the invariant over all time steps, defined as\n$$\n\\max_{0 \\leq n \\leq N} \\left| \\frac{\\mathcal{I}^{(n)} - \\mathcal{I}^{(0)}}{\\mathcal{I}^{(0)}} \\right|,\n$$\nwhere $\\mathcal{I}^{(n)}$ is your discrete invariant at step $n$ and $N$ is the total number of steps. The final results for all test cases must be printed as a single comma-separated list enclosed in square brackets, for example $[r_1,r_2,r_3]$, where each $r_i$ is a floating-point number.\n\nUse the following test suite, where each case is specified by ($k_\\|, k_\\perp \\rho_i, \\tau, \\beta_e, \\Delta t, N, \\phi_k(0), A_{\\parallel,k}(0)$):\n- Case 1: ($k_\\| = 0.7, k_\\perp \\rho_i = 0.3, \\tau = 1.0, \\beta_e = 0.02, \\Delta t = 0.05, N = 400, \\phi_k(0) = 0.8, A_{\\parallel,k}(0) = 0.1$).\n- Case 2: ($k_\\| = 0.7, k_\\perp \\rho_i = 0.3, \\tau = 1.0, \\beta_e = 0.02, \\Delta t = 1.5, N = 100, \\phi_k(0) = 0.8, A_{\\parallel,k}(0) = 0.1$).\n- Case 3: ($k_\\| = 0.9, k_\\perp \\rho_i = 10^{-6}, \\tau = 1.0, \\beta_e = 0.05, \\Delta t = 0.07, N = 300, \\phi_k(0) = 1.0, A_{\\parallel,k}(0) = -0.5$).\n- Case 4: ($k_\\| = 0.5, k_\\perp \\rho_i = 10.0, \\tau = 2.0, \\beta_e = 0.03, \\Delta t = 0.04, N = 500, \\phi_k(0) = 0.2, A_{\\parallel,k}(0) = 0.3$).\n- Case 5: ($k_\\| = 1.2, k_\\perp \\rho_i = 0.5, \\tau = 0.7, \\beta_e = 0.005, \\Delta t = 0.2, N = 1000, \\phi_k(0) = -0.123456789, A_{\\parallel,k}(0) = 0.987654321)$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (for example, $[r_1,r_2,r_3,r_4,r_5]$). All quantities are dimensionless; no physical units are required.",
            "solution": "The problem is validated as scientifically grounded, well-posed, and objective. It represents a standard analysis of a simplified, linearized model in electromagnetic gyrokinetics. All necessary parameters and definitions are provided, and the tasks are clear and mathematically rigorous.\n\nWe begin by deriving the continuous-time quadratic invariant. Let the state vector be $\\mathbf{X}(t) = [\\phi_k(t), A_{\\parallel,k}(t)]^T$. The system of ordinary differential equations is given by $\\frac{d\\mathbf{X}}{dt} = \\mathbf{M}\\mathbf{X}$, where the system matrix $\\mathbf{M}$ is\n$$\n\\mathbf{M} =\n\\begin{pmatrix}\n0 & \\alpha \\\\\n-\\alpha \\Lambda_i & 0\n\\end{pmatrix}.\n$$\nA quadratic invariant $\\mathcal{I}(t)$ can be expressed as a quadratic form $\\mathcal{I}(t) = \\mathbf{X}(t)^T \\mathbf{S} \\mathbf{X}(t)$ for some time-independent, symmetric matrix $\\mathbf{S}$. For $\\mathcal{I}(t)$ to be a conserved quantity, its time derivative must be zero:\n$$\n\\frac{d\\mathcal{I}}{dt} = \\frac{d\\mathbf{X}^T}{dt} \\mathbf{S} \\mathbf{X} + \\mathbf{X}^T \\mathbf{S} \\frac{d\\mathbf{X}}{dt} = (\\mathbf{M}\\mathbf{X})^T \\mathbf{S} \\mathbf{X} + \\mathbf{X}^T \\mathbf{S} (\\mathbf{M}\\mathbf{X}) = \\mathbf{X}^T (\\mathbf{M}^T \\mathbf{S} + \\mathbf{S} \\mathbf{M}) \\mathbf{X} = 0.\n$$\nThis equality must hold for any state vector $\\mathbf{X}$, which requires the matrix expression in the parentheses to be the zero matrix: $\\mathbf{M}^T \\mathbf{S} + \\mathbf{S} \\mathbf{M} = \\mathbf{0}$. This condition indicates that the matrix $\\mathbf{M}$ is skew-adjoint with respect to the inner product defined by the bilinear form $\\langle \\mathbf{X}, \\mathbf{Y} \\rangle_{\\mathbf{S}} = \\mathbf{X}^T \\mathbf{S} \\mathbf{Y}$. Let $\\mathbf{S} = \\begin{pmatrix} s_{11} & s_{12} \\\\ s_{12} & s_{22} \\end{pmatrix}$. The condition becomes\n$$\n\\begin{pmatrix}\n0 & -\\alpha \\Lambda_i \\\\\n\\alpha & 0\n\\end{pmatrix}\n\\begin{pmatrix}\ns_{11} & s_{12} \\\\\ns_{12} & s_{22}\n\\end{pmatrix}\n+\n\\begin{pmatrix}\ns_{11} & s_{12} \\\\\ns_{12} & s_{22}\n\\end{pmatrix}\n\\begin{pmatrix}\n0 & \\alpha \\\\\n-\\alpha \\Lambda_i & 0\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n-2 \\alpha \\Lambda_i s_{12} & \\alpha s_{11} - \\alpha \\Lambda_i s_{22} \\\\\n\\alpha s_{11} - \\alpha \\Lambda_i s_{22} & 2 \\alpha s_{12}\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n0 & 0 \\\\\n0 & 0\n\\end{pmatrix}.\n$$\nFrom the off-diagonal elements, we find $\\alpha(s_{11} - \\Lambda_i s_{22}) = 0$. Assuming $\\alpha \\neq 0$, we get $s_{11} = \\Lambda_i s_{22}$. From the diagonal elements, we find $s_{12} = 0$. We can choose $s_{22} = 1$ without loss of generality, as any scalar multiple of an invariant is also an invariant. This gives the matrix $\\mathbf{S}$:\n$$\n\\mathbf{S} = \\begin{pmatrix} \\Lambda_i & 0 \\\\ 0 & 1 \\end{pmatrix}.\n$$\nThe continuous-time quadratic invariant is therefore $\\mathcal{I}(t) = \\Lambda_i \\phi_k(t)^2 + A_{\\parallel,k}(t)^2$. For this invariant to correspond to a conserved energy, the quadratic form must be positive-definite, which requires $\\Lambda_i > 0$. The parameter $\\Lambda_i = 1 + \\tau - \\Gamma_0(b)$ where $\\tau = T_i/T_e > 0$ and $b = k_\\perp^2 \\rho_i^2 \\ge 0$. The function $\\Gamma_0(b) = I_0(b)e^{-b}$ satisfies $\\Gamma_0(0)=1$ and is monotonically decreasing for $b>0$, with $\\lim_{b\\to\\infty} \\Gamma_0(b) = 0$. Thus, $0 < \\Gamma_0(b) \\le 1$ for all $b \\ge 0$. This implies $\\Lambda_i = 1 + \\tau - \\Gamma_0(b) \\ge 1 + \\tau - 1 = \\tau > 0$. Since $\\Lambda_i$ is strictly positive, the invariant $\\mathcal{I}(t)$ is a positive-definite quadratic form.\n\nNext, we design a Crank-Nicolson (CN) time discretization. The CN scheme for the system $\\frac{d\\mathbf{X}}{dt} = \\mathbf{M}\\mathbf{X}$ is an implicit method defined by\n$$\n\\frac{\\mathbf{X}^{n+1} - \\mathbf{X}^{n}}{\\Delta t} = \\frac{1}{2}\\mathbf{M}(\\mathbf{X}^{n+1} + \\mathbf{X}^{n}),\n$$\nwhere $\\mathbf{X}^n$ is the state vector at time $t_n = n\\Delta t$. Rearranging to solve for $\\mathbf{X}^{n+1}$:\n$$\n(\\mathbf{I} - \\frac{\\Delta t}{2}\\mathbf{M})\\mathbf{X}^{n+1} = (\\mathbf{I} + \\frac{\\Delta t}{2}\\mathbf{M})\\mathbf{X}^{n}.\n$$\nThis gives the one-step update rule $\\mathbf{X}^{n+1} = \\mathbf{U} \\mathbf{X}^n$, where the update matrix $\\mathbf{U}$ is\n$$\n\\mathbf{U} = \\left(\\mathbf{I} - \\frac{\\Delta t}{2}\\mathbf{M}\\right)^{-1} \\left(\\mathbf{I} + \\frac{\\Delta t}{2}\\mathbf{M}\\right).\n$$\nThe discrete invariant is the quadratic form evaluated at the discrete time level, $\\mathcal{I}^{(n)} = (\\mathbf{X}^n)^T \\mathbf{S} \\mathbf{X}^n = \\Lambda_i (\\phi_k^{(n)})^2 + (A_{\\parallel,k}^{(n)})^2$. We now show that this invariant is exactly preserved by the CN scheme. We must demonstrate that $\\mathcal{I}^{(n+1)} = \\mathcal{I}^{(n)}$ for all $n$.\n$$\n\\mathcal{I}^{(n+1)} = (\\mathbf{X}^{n+1})^T \\mathbf{S} \\mathbf{X}^{n+1} = (\\mathbf{U} \\mathbf{X}^n)^T \\mathbf{S} (\\mathbf{U} \\mathbf{X}^n) = (\\mathbf{X}^n)^T \\mathbf{U}^T \\mathbf{S} \\mathbf{U} \\mathbf{X}^n.\n$$\nExact conservation requires that $\\mathbf{U}^T \\mathbf{S} \\mathbf{U} = \\mathbf{S}$, which means the update matrix $\\mathbf{U}$ must be $\\mathbf{S}$-orthogonal. This property is a direct consequence of the skew-adjointness of $\\mathbf{M}$ with respect to the $\\mathbf{S}$-inner product. Let $\\tau_{dt} = \\Delta t/2$. Then $\\mathbf{U} = (\\mathbf{I} - \\tau_{dt}\\mathbf{M})^{-1}(\\mathbf{I} + \\tau_{dt}\\mathbf{M})$. We use the property $\\mathbf{M}^T\\mathbf{S} + \\mathbf{S}\\mathbf{M} = \\mathbf{0}$, which can be written as $\\mathbf{M}^T = -\\mathbf{S}\\mathbf{M}\\mathbf{S}^{-1}$.\nThe transpose of the update matrix is $\\mathbf{U}^T = ((\\mathbf{I} + \\tau_{dt}\\mathbf{M})^T)((\\mathbf{I} - \\tau_{dt}\\mathbf{M})^{-1})^T = (\\mathbf{I} + \\tau_{dt}\\mathbf{M}^T)(\\mathbf{I} - \\tau_{dt}\\mathbf{M}^T)^{-1}$.\nSubstituting $\\mathbf{M}^T$:\n$$\n\\mathbf{I} \\pm \\tau_{dt}\\mathbf{M}^T = \\mathbf{I} \\mp \\tau_{dt}\\mathbf{S}\\mathbf{M}\\mathbf{S}^{-1} = \\mathbf{S}(\\mathbf{I} \\mp \\tau_{dt}\\mathbf{M})\\mathbf{S}^{-1}.\n$$\nSo, $\\mathbf{U}^T = [\\mathbf{S}(\\mathbf{I} - \\tau_{dt}\\mathbf{M})\\mathbf{S}^{-1}] [\\mathbf{S}(\\mathbf{I} + \\tau_{dt}\\mathbf{M})\\mathbf{S}^{-1}]^{-1} = \\mathbf{S}(\\mathbf{I} - \\tau_{dt}\\mathbf{M})\\mathbf{S}^{-1} \\mathbf{S}(\\mathbf{I} + \\tau_{dt}\\mathbf{M})^{-1}\\mathbf{S}^{-1} = \\mathbf{S}(\\mathbf{I} - \\tau_{dt}\\mathbf{M})(\\mathbf{I} + \\tau_{dt}\\mathbf{M})^{-1}\\mathbf{S}^{-1}$.\nThen, $\\mathbf{U}^T \\mathbf{S} \\mathbf{U} = \\mathbf{S}(\\mathbf{I} - \\tau_{dt}\\mathbf{M})(\\mathbf{I} + \\tau_{dt}\\mathbf{M})^{-1}\\mathbf{S}^{-1} \\mathbf{S} (\\mathbf{I} - \\tau_{dt}\\mathbf{M})^{-1}(\\mathbf{I} + \\tau_{dt}\\mathbf{M})$.\nSince $(\\mathbf{I} + \\tau_{dt}\\mathbf{M})$ and $(\\mathbf{I} - \\tau_{dt}\\mathbf{M})$ commute, so do their inverses. Thus $(\\mathbf{I} + \\tau_{dt}\\mathbf{M})^{-1}(\\mathbf{I} - \\tau_{dt}\\mathbf{M})^{-1} = (\\mathbf{I} - \\tau_{dt}\\mathbf{M})^{-1}(\\mathbf{I} + \\tau_{dt}\\mathbf{M})^{-1}$.\nMore simply, let $\\mathbf{A} = \\mathbf{I} - \\tau_{dt}\\mathbf{M}$ and $\\mathbf{B} = \\mathbf{I} + \\tau_{dt}\\mathbf{M}$. $\\mathbf{A}$ and $\\mathbf{B}$ commute. $\\mathbf{U} = \\mathbf{A}^{-1}\\mathbf{B}$. We showed $\\mathbf{A}^T = \\mathbf{S}\\mathbf{B}\\mathbf{S}^{-1}$ and $\\mathbf{B}^T = \\mathbf{S}\\mathbf{A}\\mathbf{S}^{-1}$.\n$\\mathbf{U}^T = (\\mathbf{B}^T)((\\mathbf{A}^{-1})^T) = (\\mathbf{S}\\mathbf{A}\\mathbf{S}^{-1})(\\mathbf{A}^T)^{-1} = (\\mathbf{S}\\mathbf{A}\\mathbf{S}^{-1})(\\mathbf{S}\\mathbf{B}\\mathbf{S}^{-1})^{-1} = \\mathbf{S}\\mathbf{A}\\mathbf{S}^{-1}\\mathbf{S}\\mathbf{B}^{-1}\\mathbf{S}^{-1} = \\mathbf{S}\\mathbf{A}\\mathbf{B}^{-1}\\mathbf{S}^{-1}$.\n$\\mathbf{U}^T \\mathbf{S} \\mathbf{U} = (\\mathbf{S}\\mathbf{A}\\mathbf{B}^{-1}\\mathbf{S}^{-1}) \\mathbf{S} (\\mathbf{A}^{-1}\\mathbf{B}) = \\mathbf{S}\\mathbf{A}\\mathbf{B}^{-1}\\mathbf{A}^{-1}\\mathbf{B}$. Since $\\mathbf{A}$ and $\\mathbf{B}$ commute, $\\mathbf{B}^{-1}\\mathbf{A}^{-1} = \\mathbf{A}^{-1}\\mathbf{B}^{-1}$.\nSo, $\\mathbf{S}\\mathbf{A}(\\mathbf{B}^{-1}\\mathbf{A}^{-1})\\mathbf{B} = \\mathbf{S}\\mathbf{A}(\\mathbf{A}^{-1}\\mathbf{B}^{-1})\\mathbf{B} = \\mathbf{S}(\\mathbf{A}\\mathbf{A}^{-1})(\\mathbf{B}^{-1}\\mathbf{B}) = \\mathbf{S}\\mathbf{I}\\mathbf{I} = \\mathbf{S}$.\nThis confirms that the discrete invariant $\\mathcal{I}^{(n)}$ is exactly preserved by the CN scheme. This invariant has the same functional form as the continuous one; its conservation is a property of the numerical integration scheme itself.\n\nFor implementation, we construct the explicit update matrix $\\mathbf{U}$. Let $\\tau_{dt}=\\Delta t/2$, $\\alpha' = \\tau_{dt}\\alpha$, $\\Lambda_i' = \\tau_{dt}\\alpha\\Lambda_i$.\n$\\mathbf{I} - \\tau_{dt}\\mathbf{M} = \\begin{pmatrix} 1 & -\\alpha' \\\\ \\Lambda_i' & 1 \\end{pmatrix}$. Its determinant is $1+\\alpha'\\Lambda_i' = 1 + (\\Delta t/2)^2\\alpha^2\\Lambda_i$.\n$\\mathbf{I} + \\tau_{dt}\\mathbf{M} = \\begin{pmatrix} 1 & \\alpha' \\\\ -\\Lambda_i' & 1 \\end{pmatrix}$.\n$(\\mathbf{I} - \\tau_{dt}\\mathbf{M})^{-1} = \\frac{1}{1+\\alpha'\\Lambda_i'} \\begin{pmatrix} 1 & \\alpha' \\\\ -\\Lambda_i' & 1 \\end{pmatrix} = \\frac{1}{1+\\alpha'\\Lambda_i'}(\\mathbf{I} + \\frac{\\Delta t}{2}\\mathbf{M})$.\nThus, $\\mathbf{U} = \\frac{1}{1+(\\Delta t/2)^2\\alpha^2\\Lambda_i}(\\mathbf{I} + \\frac{\\Delta t}{2}\\mathbf{M})^2$.\n$$\n(\\mathbf{I} + \\frac{\\Delta t}{2}\\mathbf{M})^2 = \\begin{pmatrix} 1 & \\alpha' \\\\ -\\Lambda_i' & 1 \\end{pmatrix}^2 = \\begin{pmatrix} 1-\\alpha'\\Lambda_i' & 2\\alpha' \\\\ -2\\Lambda_i' & 1-\\alpha'\\Lambda_i' \\end{pmatrix}.\n$$\nThis provides an explicit formula for updating the state vector, which is then used to numerically verify the conservation of $\\mathcal{I}^{(n)}$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import i0\n\ndef solve():\n    \"\"\"\n    Solves the given problem for electromagnetic gyrokinetics,\n    verifying the conservation of a discrete invariant for a Crank-Nicolson scheme.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    # Format: (k_parallel, k_perp_rho_i, tau, beta_e, dt, N, phi0, A0)\n    test_cases = [\n        (0.7, 0.3, 1.0, 0.02, 0.05, 400, 0.8, 0.1),\n        (0.7, 0.3, 1.0, 0.02, 1.5, 100, 0.8, 0.1),\n        (0.9, 1e-6, 1.0, 0.05, 0.07, 300, 1.0, -0.5),\n        (0.5, 10.0, 2.0, 0.03, 0.04, 500, 0.2, 0.3),\n        (1.2, 0.5, 0.7, 0.005, 0.2, 1000, -0.123456789, 0.987654321),\n    ]\n\n    results = []\n\n    for case in test_cases:\n        # 1. Unpack parameters for the current test case\n        k_parallel, k_perp_rho_i, tau, beta_e, dt, N, phi0, A0 = case\n        \n        # 2. Calculate physical constants for the system\n        # Perpendicular wavenumber parameter b\n        b = k_perp_rho_i**2\n        \n        # Ion gyroaveraging operator Gamma_0(b)\n        # Using scipy.special.i0 for the modified Bessel function I_0\n        gamma0_b = i0(b) * np.exp(-b)\n        \n        # Ion polarization response Lambda_i\n        lambda_i = 1.0 + tau - gamma0_b\n        \n        # Alfvenic coupling frequency alpha\n        alpha = k_parallel / np.sqrt(beta_e)\n        \n        # 3. Set up the Crank-Nicolson scheme\n        # The system is dX/dt = M X, where X = [phi, A_par]^T\n        # M = [[0, alpha], [-alpha * lambda_i, 0]]\n        # The CN update is X_{n+1} = U X_n, where U = (I - dt/2 M)^-1 (I + dt/2 M)\n        \n        # We pre-calculate the update matrix U\n        tau_dt = dt / 2.0\n        \n        # Denominator of the update matrix U\n        denom = 1.0 + (tau_dt**2) * (alpha**2) * lambda_i\n        \n        # Elements of B = (I + dt/2 M)\n        # B = [[1, tau_dt * alpha], [-tau_dt * alpha * lambda_i, 1]]\n        # U = (1/denom) * B^2\n        \n        # Elements of B^2\n        # B^2 = [[1 - (tau_dt*alpha)^2*lambda_i, 2*tau_dt*alpha],\n        #        [-2*tau_dt*alpha*lambda_i, 1 - (tau_dt*alpha)^2*lambda_i]]\n        \n        u11 = (1.0 - (tau_dt**2) * (alpha**2) * lambda_i) / denom\n        u12 = (2.0 * tau_dt * alpha) / denom\n        u21 = (-2.0 * tau_dt * alpha * lambda_i) / denom\n        u22 = u11\n        \n        U = np.array([\n            [u11, u12],\n            [u21, u22]\n        ])\n        \n        # 4. Initialize the simulation\n        # State vector X = [phi_k, A_parallel,k]^T\n        X = np.array([phi0, A0], dtype=np.float64)\n        \n        # The discrete invariant is I = lambda_i * phi^2 + A_par^2\n        invariant_initial = lambda_i * X[0]**2 + X[1]**2\n        \n        # List to store all relative changes of the invariant\n        relative_changes = [0.0] # At n=0, the change is 0\n        \n        # 5. Run the time evolution\n        for _ in range(N):\n            # Update the state vector\n            X = U @ X\n            \n            # Calculate the invariant at the new time step\n            invariant_current = lambda_i * X[0]**2 + X[1]**2\n            \n            # Calculate and store the absolute relative change\n            if invariant_initial != 0:\n                rel_change = np.abs((invariant_current - invariant_initial) / invariant_initial)\n                relative_changes.append(rel_change)\n            else: # Should not happen with the given test cases\n                relative_changes.append(0.0)\n\n        # 6. Find the maximum absolute relative change over all steps\n        max_rel_change = np.max(relative_changes)\n        results.append(max_rel_change)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}