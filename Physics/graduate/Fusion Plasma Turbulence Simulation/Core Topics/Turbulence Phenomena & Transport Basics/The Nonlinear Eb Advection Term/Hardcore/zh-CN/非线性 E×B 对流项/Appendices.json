{
    "hands_on_practices": [
        {
            "introduction": "我们从一个基础但至关重要的编码练习开始。这个练习的目标是实现 $E \\times B$ 平流项的保守离散格式，并验证其是否在离散层面正确地再现了连续算子的两个关键性质：$E \\times B$ 漂移速度的无散度特性和总积分量的守恒性。完成这个练习  将为你构建更复杂的湍流模型打下坚实的基础，并确保你的数值方案在物理上是可靠的。",
            "id": "4205468",
            "problem": "您将实现并验证一个二维周期性区域中电场叉乘磁场 ($E \\times B$) 非线性平流项的守恒通量形式离散化，并证明在一致的中心差分离散格式下，$E \\times B$ 漂移速度的离散散度在舍入误差范围内为零。\n\n该问题的基本依据包括以下物理定义和数学事实：\n- 在静电学中，电场为 $\\mathbf{E} = -\\nabla \\phi$，其中 $\\phi$ 是静电势。\n- 对于均匀磁场 $\\mathbf{B} = B_0 \\,\\hat{\\mathbf{z}}$，电场叉乘磁场 ($E \\times B$) 漂移速度为 $\\mathbf{v}_E = \\dfrac{\\mathbf{E} \\times \\mathbf{B}}{B_0^2}$。在无量纲归一化中，设 $B_0 = 1$ 且系数被吸收到单位中，这在二维情况下简化为 $\\mathbf{v}_E = \\hat{\\mathbf{z}} \\times \\nabla \\phi$，因此有 $v_x = -\\partial_y \\phi$ 和 $v_y = \\partial_x \\phi$。\n- 矢量微积分恒等式 $\\mathbf{v}\\cdot\\nabla f = \\nabla\\cdot(f\\,\\mathbf{v}) - f\\,\\nabla\\cdot\\mathbf{v}$ 意味着当 $\\nabla\\cdot\\mathbf{v}_E = 0$ 时，有 $\\mathbf{v}_E\\cdot\\nabla f = \\nabla\\cdot(f\\,\\mathbf{v}_E)$。\n- 在均匀网格上，带周期性边界条件的一致中心差分会产生可交换的离散导数，这是连续恒等式 $\\partial_x\\partial_y = \\partial_y\\partial_x$ 的离散模拟。\n\n您必须使用无量纲单位和以弧度为单位的角度来实现以下内容：\n1. 一个二维周期性网格，在 $x$ 方向有 $N_x$ 个点，在 $y$ 方向有 $N_y$ 个点，范围分别为 $[0,L_x)$ 和 $[0,L_y)$。使用均匀间距 $\\Delta x = L_x/N_x$ 和 $\\Delta y = L_y/N_y$。\n2. 中心差分离散导数\n   $$D_x g_{i,j} = \\frac{g_{i+1,j} - g_{i-1,j}}{2\\,\\Delta x}, \\quad D_y g_{i,j} = \\frac{g_{i,j+1} - g_{i,j-1}}{2\\,\\Delta y},$$\n   使用周期性环绕索引。\n3. 由 $v_x = -D_y \\phi$ 和 $v_y = D_x \\phi$ 离散定义的 $E \\times B$ 漂移速度。\n4. $E \\times B$ 速度的离散散度 $\\nabla\\cdot\\mathbf{v}_E \\approx D_x v_x + D_y v_y$。\n5. 标量场 $f$ 的守恒通量形式平流，\n   $$\\mathcal{A}(f,\\phi) \\equiv D_x\\!\\left(f\\,v_x\\right) + D_y\\!\\left(f\\,v_y\\right),$$\n   其中 $v_x$ 和 $v_y$ 由与上述相同的离散导数算子一致地构造。\n\n您的程序必须定义并运行以下由参数集和场组成的测试套件，涵盖一般行为和边界情况。所有量都是无量纲的，角度以弧度为单位。对于下述每种情况，请完全按照指定的方式构造 $\\phi(x,y)$ 和 $f(x,y)$：\n\n- 情况 1（光滑、非平凡的场，奇数 $N_y$）：\n  - $N_x = 64$, $N_y = 65$, $L_x = 2\\pi$, $L_y = 2\\pi$。\n  - $\\phi(x,y) = \\sin(3x)\\,\\cos(4y)$。\n  - $f(x,y) = \\cos(2x)\\,\\sin(3y)$。\n\n- 情况 2（零速度场）：\n  - $N_x = 4$, $N_y = 4$, $L_x = 2\\pi$, $L_y = 2\\pi$。\n  - $\\phi(x,y) = 0.37$（常数）。\n  - $f(x,y) = \\sin(x) + \\cos(y)$。\n\n- 情况 3（恒定平流场）：\n  - $N_x = 33$, $N_y = 31$, $L_x = 2\\pi$, $L_y = 2\\pi$。\n  - $\\phi(x,y) = \\sin(5x) + \\sin(7y)$。\n  - $f(x,y) = 1.0$（常数）。\n\n- 情况 4（随机场，通过固定种子实现可复现性）：\n  - $N_x = 128$, $N_y = 128$, $L_x = 2\\pi$, $L_y = 2\\pi$。\n  - $\\phi(x,y)$ 和 $f(x,y)$ 是网格上独立同分布的伪随机场，每个都使用固定的种子 $42$ 从 $[0,1)$ 中均匀采样。\n\n对于每种情况，计算并返回以下三个指标：\n- $m_1$：$\\mathbf{v}_E$ 离散散度的最大绝对值，即 $\\max_{i,j}\\left|\\left(D_x v_x + D_y v_y\\right)_{i,j}\\right|$。\n- $m_2$：$\\mathbf{v}_E$ 散度的离散 $L^2$ 范数，按单元面积缩放，即\n  $$m_2 = \\sqrt{\\sum_{i,j} \\left(D_x v_x + D_y v_y\\right)_{i,j}^2\\,\\Delta x\\,\\Delta y}.$$\n- $m_3$：守恒通量形式平流项在全区域积分的绝对值，即\n  $$m_3 = \\left|\\sum_{i,j} \\mathcal{A}(f,\\phi)_{i,j}\\,\\Delta x\\,\\Delta y\\right|.$$\n\n您的程序应生成单行输出，其中包含一个逗号分隔的四个情况的结果列表，顺序从情况 1 到情况 4，每个情况的结果是一个用方括号括起来的逗号分隔的三元组。例如，输出格式必须是\n`\\texttt{[[m1_case1,m2_case1,m3_case1],[m1_case2,m2_case2,m3_case2],[m1_case3,m2_case3,m3_case3],[m1_case4,m2_case4,m3_case4]]}`\n其中每个 $m_k$ 都表示为浮点数。所有量都是无量纲的，角度以弧度为单位。",
            "solution": "该问题陈述是有效的。它提出了一个在计算等离子体物理领域中，关于 E×B 平流项数值性质的、适定的且有科学依据的任务。所有必要的参数和定义都已提供，问题没有矛盾或歧义。\n\n这个问题的核心是验证 E×B 非线性项在二维周期性区域上特定数值离散化的两个基本性质。这些性质是连续数学恒等式的离散模拟，对于模拟的物理保真度至关重要，特别是在守恒律方面。\n\n首先，我们考虑连续的 E×B 漂移速度。给定一个均匀磁场 $\\mathbf{B} = B_0 \\hat{\\mathbf{z}}$ 和一个静电势 $\\phi$，电场为 $\\mathbf{E} = -\\nabla \\phi$。在系数 $1/B_0$ 被吸收到单位的无量纲单位中，二维（x, y）下的 E×B 漂移速度由 $\\mathbf{v}_E = \\hat{\\mathbf{z}} \\times \\nabla \\phi$ 给出。该叉积展开为分量 $v_x = -\\partial_y \\phi$ 和 $v_y = \\partial_x \\phi$。\n\n该速度场的一个关键性质是它是无散度的。其散度计算如下：\n$$\n\\nabla \\cdot \\mathbf{v}_E = \\frac{\\partial v_x}{\\partial x} + \\frac{\\partial v_y}{\\partial y} = \\frac{\\partial}{\\partial x}\\left(-\\frac{\\partial \\phi}{\\partial y}\\right) + \\frac{\\partial}{\\partial y}\\left(\\frac{\\partial \\phi}{\\partial x}\\right) = -\\frac{\\partial^2 \\phi}{\\partial x \\partial y} + \\frac{\\partial^2 \\phi}{\\partial y \\partial x}\n$$\n根据关于混合偏导数相等性的克莱罗定理 (Clairaut's theorem)，如果 $\\phi$ 具有连续的二阶偏导数，则 $\\frac{\\partial^2 \\phi}{\\partial x \\partial y} = \\frac{\\partial^2 \\phi}{\\partial y \\partial x}$。因此，$\\nabla \\cdot \\mathbf{v}_E = 0$。\n\n该问题要求我们研究此性质的离散模拟。我们使用一个具有间距 $\\Delta x$ 和 $\\Delta y$ 的均匀网格，以及用于偏导数的中心差分算子：\n$$\nD_x g_{i,j} = \\frac{g_{i+1,j} - g_{i-1,j}}{2\\,\\Delta x}, \\quad D_y g_{i,j} = \\frac{g_{i,j+1} - g_{i,j-1}}{2\\,\\Delta y}\n$$\n这些算子作用于网格函数 $g_{i,j}$ 并利用周期性边界条件。离散速度分量被一致地定义为 $v_x = -D_y \\phi$ 和 $v_y = D_x \\phi$。于是，离散散度为：\n$$\n(D_x v_x + D_y v_y)_{i,j} = D_x(-D_y \\phi)_{i,j} + D_y(D_x \\phi)_{i,j} = (-D_x D_y + D_y D_x)\\phi_{i,j}\n$$\n这些特定有限差分算子在均匀网格上的一个基本性质是它们是可交换的，即对于任何网格函数 $g$，都有 $D_x D_y g = D_y D_x g$。这可以通过展开算子来证明。因此，离散 E×B 速度的离散散度 $(D_y D_x - D_x D_y)\\phi$ 在精确算术中必须恒为零。在浮点计算中获得的任何非零结果都将是由于舍入误差。指标 $m_1$ 和 $m_2$ 被设计用来衡量此数值误差的大小。\n- $m_1 = \\max_{i,j}\\left|\\left(D_x v_x + D_y v_y\\right)_{i,j}\\right|$ 测量最大逐点误差。\n- $m_2 = \\sqrt{\\sum_{i,j} \\left(D_x v_x + D_y v_y\\right)_{i,j}^2\\,\\Delta x\\,\\Delta y}$ 在 $L^2$ 意义上测量网格积分误差。\n我们预期 $m_1$ 和 $m_2$ 都在机器精度的数量级上。\n\n其次，我们考虑标量 $f$ 被速度场 $\\mathbf{v}_E$ 平流。平流项 $\\mathbf{v}_E \\cdot \\nabla f$ 可以使用矢量恒等式 $\\mathbf{v}\\cdot\\nabla f = \\nabla\\cdot(f\\,\\mathbf{v}) - f\\,(\\nabla\\cdot\\mathbf{v})$ 写成“通量形式”或“守恒形式”。由于 $\\nabla \\cdot \\mathbf{v}_E = 0$，这简化为 $\\mathbf{v}_E \\cdot \\nabla f = \\nabla \\cdot (f \\mathbf{v}_E)$。项 $\\nabla \\cdot (f \\mathbf{v}_E)$ 是通量 $f \\mathbf{v}_E$ 的散度。\n\n该问题以这种守恒通量形式定义了离散平流算子：\n$$\n\\mathcal{A}(f,\\phi) \\equiv D_x\\!\\left(f\\,v_x\\right) + D_y\\!\\left(f\\,v_y\\right)\n$$\n这是离散通量矢量 $(f v_x, f v_y)$ 的离散散度。守恒格式的一个关键性质是，它们不应在区域内凭空产生或销毁被平流的量 $f$ 的总量。总量是区域积分，在离散情况下是总和 $\\sum_{i,j} f_{i,j} \\Delta x \\Delta y$。这个总量的变化率由平流项在整个区域上的总和给出：$\\sum_{i,j} \\mathcal{A}(f,\\phi)_{i,j} \\Delta x \\Delta y$。\n\n根据周期性区域上散度定理的离散等价形式，离散散度在所有网格单元上的总和必须为零。让我们检查 $x$ 分量的总和：\n$$\n\\sum_{i,j} D_x(f v_x)_{i,j} = \\sum_j \\left( \\sum_i \\frac{(f v_x)_{i+1,j} - (f v_x)_{i-1,j}}{2\\Delta x} \\right)\n$$\n关于索引 $i$ 的内层求和是一个可对消求和。由于周期性边界条件，对于每个带正号出现的项 $(f v_x)_{k,j}$，它也会带负号出现（索引偏移两位），导致总和恒为零。同样的逻辑也适用于 $y$ 分量。因此，在精确算术中，总和必须为零。指标 $m_3$ 测量用浮点数计算的这个总和的绝对值：\n$$\nm_3 = \\left|\\sum_{i,j} \\mathcal{A}(f,\\phi)_{i,j}\\,\\Delta x\\,\\Delta y\\right|\n$$\n我们预期 $m_3$ 也将在机器精度的数量级上，从而证实该数值格式是守恒的。\n\n实现过程将是为每个测试用例定义网格和场，应用离散算子计算速度、其散度和通量形式平流，最后计算三个指标 $m_1, m_2$ 和 $m_3$。\n测试用例旨在在各种条件下验证这些性质：光滑场、零速度（常数 $\\phi$）、恒定平流量 $f$ 以及一般的随机场。在所有情况下，预计这些指标都会非常小，接近浮点零。对于情况 2，其中 $\\phi$ 是常数，速度场解析地为零，因此所有指标都应精确为 $0.0$。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements and verifies a conservative discretization of the E×B nonlinear advection term.\n    \"\"\"\n    \n    test_cases = [\n        {\n            \"id\": 1,\n            \"Nx\": 64, \"Ny\": 65, \"Lx\": 2 * np.pi, \"Ly\": 2 * np.pi,\n            \"phi_func\": lambda x, y: np.sin(3 * x) * np.cos(4 * y),\n            \"f_func\": lambda x, y: np.cos(2 * x) * np.sin(3 * y),\n            \"is_random\": False\n        },\n        {\n            \"id\": 2,\n            \"Nx\": 4, \"Ny\": 4, \"Lx\": 2 * np.pi, \"Ly\": 2 * np.pi,\n            \"phi_func\": lambda x, y: np.full_like(x, 0.37),\n            \"f_func\": lambda x, y: np.sin(x) + np.cos(y),\n            \"is_random\": False\n        },\n        {\n            \"id\": 3,\n            \"Nx\": 33, \"Ny\": 31, \"Lx\": 2 * np.pi, \"Ly\": 2 * np.pi,\n            \"phi_func\": lambda x, y: np.sin(5 * x) + np.sin(7 * y),\n            \"f_func\": lambda x, y: np.ones_like(x),\n            \"is_random\": False\n        },\n        {\n            \"id\": 4,\n            \"Nx\": 128, \"Ny\": 128, \"Lx\": 2 * np.pi, \"Ly\": 2 * np.pi,\n            \"phi_func\": None, # Will be generated randomly\n            \"f_func\": None,   # Will be generated randomly\n            \"is_random\": True,\n            \"seed\": 42\n        }\n    ]\n\n    # Helper functions for central differences with periodic boundaries\n    def central_diff_x(g, dx):\n        \"\"\"Computes the central difference derivative along the x-axis (axis 0).\"\"\"\n        return (np.roll(g, -1, axis=0) - np.roll(g, 1, axis=0)) / (2 * dx)\n\n    def central_diff_y(g, dy):\n        \"\"\"Computes the central difference derivative along the y-axis (axis 1).\"\"\"\n        return (np.roll(g, -1, axis=1) - np.roll(g, 1, axis=1)) / (2 * dy)\n\n    results = []\n\n    for case in test_cases:\n        # 1. Setup grid and parameters\n        Nx, Ny = case[\"Nx\"], case[\"Ny\"]\n        Lx, Ly = case[\"Lx\"], case[\"Ly\"]\n        dx, dy = Lx / Nx, Ly / Ny\n\n        x = np.linspace(0, Lx, Nx, endpoint=False)\n        y = np.linspace(0, Ly, Ny, endpoint=False)\n        xx, yy = np.meshgrid(x, y, indexing='ij')\n\n        # 2. Construct scalar fields phi and f\n        if case[\"is_random\"]:\n            rng = np.random.default_rng(seed=case[\"seed\"])\n            phi = rng.uniform(size=(Nx, Ny))\n            f = rng.uniform(size=(Nx, Ny))\n        else:\n            phi = case[\"phi_func\"](xx, yy)\n            f = case[\"f_func\"](xx, yy)\n        \n        # 3. Compute discrete E×B velocity components\n        # vx = -Dy(phi)\n        vx = -central_diff_y(phi, dy)\n        # vy = Dx(phi)\n        vy = central_diff_x(phi, dx)\n        \n        # 4. Compute the discrete divergence of the E×B velocity\n        div_vE = central_diff_x(vx, dx) + central_diff_y(vy, dy)\n        \n        # 5. Compute the conservative flux-form advection term\n        flux_x = f * vx\n        flux_y = f * vy\n        advection_term = central_diff_x(flux_x, dx) + central_diff_y(flux_y, dy)\n        \n        # 6. Calculate the three metrics\n        # m1: max absolute value of the discrete divergence of v_E\n        m1 = np.max(np.abs(div_vE))\n        \n        # m2: L2 norm of the divergence of v_E\n        cell_area = dx * dy\n        m2 = np.sqrt(np.sum(div_vE**2) * cell_area)\n        \n        # m3: absolute value of the domain-integrated advection\n        m3 = np.abs(np.sum(advection_term) * cell_area)\n        \n        results.append([m1, m2, m3])\n\n    # Format the final output string as specified\n    formatted_results = [f\"[{r[0]},{r[1]},{r[2]}]\" for r in results]\n    output_string = f\"[{','.join(formatted_results)}]\"\n    \n    print(output_string)\n\nsolve()\n```"
        },
        {
            "introduction": "在掌握了基本离散化之后，我们转向一种在等离子体湍流模拟中广泛使用的高效数值方法——伪谱法。虽然该方法精度高，但它引入了一个必须小心处理的数值陷阱：混叠误差 (aliasing error)。通过这个分析练习 ，你将从第一性原理出发，亲手推导在非线性项的计算中混叠误差是如何产生的，并学习如何应用标准的 $2/3$ 去混叠规则来消除这种非物理效应，这对于确保谱方法模拟的准确性至关重要。",
            "id": "4205506",
            "problem": "考虑一个无碰撞的静电二维周期性区域，其尺寸为 $L_x = 2\\pi$ 和 $L_y = 2\\pi$，并存在一个沿 $\\hat{\\mathbf{z}}$ 方向的均匀磁场。在无量纲单位下，并将匀强磁场大小设为1，由静电势 $\\phi(x,y)$ 引起的标量涨落 $g(x,y)$ 的非线性电场-磁场（$E \\times B$）平流项可以写为泊松括号的形式\n$$\nJ(\\phi,g) \\equiv \\hat{\\mathbf{z}} \\times \\nabla \\phi \\cdot \\nabla g \\;=\\; \\partial_{x}\\phi\\,\\partial_{y}g \\;-\\; \\partial_{y}\\phi\\,\\partial_{x}g \\, .\n$$\n我们将在一个 $N_x \\times N_y$ 的网格上用伪谱法计算此非线性项，其中 $N_x = N_y = 12$，每个方向上有等距的格点。使用复指数傅里叶级数约定\n$$\nf(x,y) \\;=\\; \\sum_{k_x=-N_x/2}^{N_x/2-1} \\sum_{k_y=-N_y/2}^{N_y/2-1} \\hat{f}_{k_x,k_y}\\,\\exp\\!\\big(i(k_x x + k_y y)\\big) \\, ,\n$$\n其中 $k_x$ 和 $k_y$ 是整数，每个方向上应取主波数集 $\\{-6,-5,\\ldots,5\\}$。伪谱法计算指的是在谱空间中精确计算空间导数，变换到物理空间在网格上逐点相乘，然后使用离散傅里叶变换（DFT）将乘积变换回谱空间。\n\n设场为具有实数振幅的单傅里叶模，\n$$\n\\phi(x,y) \\;=\\; \\Phi_0 \\,\\cos(4x + 2y) \\, , \\qquad g(x,y) \\;=\\; G_0 \\,\\cos(3x + 5y) \\, ,\n$$\n其中 $\\Phi_0$ 和 $G_0$ 是实常数。由于有限网格上的离散傅里叶变换会将波数相差 $x$ 和 $y$ 方向上 $N_x$ 和 $N_y$ 整数倍的序列视为相同，二次乘积会产生混叠，导致不可表示波数上的谱能量出现在不同的可表示波数上。\n\n从上述定义和 $J(\\phi,g)$ 的 $E \\times B$ 平流形式出发，完全基于傅里叶分析和离散采样的第一性原理，完成以下任务：\n\n1. 推导 $J(\\phi,g)$ 关于其结果波矢的三角函数的精确连续表达式，然后将 $J(\\phi,g)$ 表示为复指数形式，以确定其连续傅里叶系数。\n2. 使用 $12 \\times 12$ 的网格采样和上述指定的主波数集，确定在应用任何去混叠方法之前，伪谱法在波矢 $\\big(-5,-5\\big)$ 处产生的复傅里叶系数 $\\widehat{J}_{-5,-5}^{(\\mathrm{ps})}$。您的结果必须是关于 $\\Phi_0$ 和 $G_0$ 的解析表达式。\n3. 应用三分之二去混叠规则，对非线性项进行离散傅里叶变换后进行截断：当 $|k_x| > N_x/3$ 或 $|k_y| > N_y/3$ 时（对于此网格，$N_x/3 = N_y/3 = 4$），设 $\\widehat{J}_{k_x,k_y}^{(2/3)} = 0$。确定去混叠后的复傅里叶系数 $\\widehat{J}_{-5,-5}^{(2/3)}$。\n\n最终答案必须是应用三分之二去混叠规则前后，在 $\\big(-5,-5\\big)$ 处的复傅里叶系数对，排列成一个单行矩阵。不需要数值近似；请给出精确的符号表达式。如果需要任何四舍五入，则需要指定有效数字，但此处不需要。",
            "solution": "用户提供的问题是有效的，因为它具有科学依据、问题适定、客观，并包含唯一解所需的所有信息。$E \\times B$ 非线性、伪谱法和混叠等概念是计算等离子体物理学中的标准内容。我们接下来进行详细求解。\n\n该问题要求计算非线性 $E \\times B$ 平流项在有和没有去混叠过程时的特定傅里叶系数。平流项由泊松括号 $J(\\phi,g) = \\partial_{x}\\phi\\,\\partial_{y}g - \\partial_{y}\\phi\\,\\partial_{x}g$ 给出。\n\n设给定的标量场为：\n$$ \\phi(x,y) = \\Phi_0 \\cos(4x + 2y) $$\n$$ g(x,y) = G_0 \\cos(3x + 5y) $$\n\n**第1部分：$J(\\phi,g)$ 的精确连续表达式及其傅里叶系数**\n\n首先，我们计算 $\\phi(x,y)$ 和 $g(x,y)$ 的空间导数。\n$$ \\partial_{x}\\phi = -4\\Phi_0 \\sin(4x + 2y) $$\n$$ \\partial_{y}\\phi = -2\\Phi_0 \\sin(4x + 2y) $$\n$$ \\partial_{x}g = -3G_0 \\sin(3x + 5y) $$\n$$ \\partial_{y}g = -5G_0 \\sin(3x + 5y) $$\n接下来，我们将这些导数代入 $J(\\phi,g)$ 的表达式中：\n$$ J(\\phi,g) = (\\partial_{x}\\phi)(\\partial_{y}g) - (\\partial_{y}\\phi)(\\partial_{x}g) $$\n$$ J(\\phi,g) = \\big(-4\\Phi_0 \\sin(4x + 2y)\\big)\\big(-5G_0 \\sin(3x + 5y)\\big) - \\big(-2\\Phi_0 \\sin(4x + 2y)\\big)\\big(-3G_0 \\sin(3x + 5y)\\big) $$\n$$ J(\\phi,g) = 20\\Phi_0 G_0 \\sin(4x + 2y)\\sin(3x + 5y) - 6\\Phi_0 G_0 \\sin(4x + 2y)\\sin(3x + 5y) $$\n$$ J(\\phi,g) = 14\\Phi_0 G_0 \\sin(4x + 2y)\\sin(3x + 5y) $$\n为了确定傅里叶模，我们使用积化和差三角恒等式 $\\sin(A)\\sin(B) = \\frac{1}{2}[\\cos(A-B) - \\cos(A+B)]$。令 $A = 4x+2y$ 和 $B = 3x+5y$。\n则 $A-B = (4x+2y) - (3x+5y) = x - 3y$，且 $A+B = (4x+2y) + (3x+5y) = 7x + 7y$。\n将此代入 $J(\\phi,g)$ 的表达式中：\n$$ J(\\phi,g) = 14\\Phi_0 G_0 \\left( \\frac{1}{2}\\big[\\cos(x - 3y) - \\cos(7x + 7y)\\big] \\right) $$\n$$ J(\\phi,g) = 7\\Phi_0 G_0 \\big(\\cos(x - 3y) - \\cos(7x + 7y)\\big) $$\n这就是 $J(\\phi,g)$ 的精确连续表达式。为了求其傅里叶系数，我们使用 $\\cos(\\theta) = \\frac{1}{2}(\\exp(i\\theta) + \\exp(-i\\theta))$ 将其表示为复指数形式。\n$$ J(x,y) = 7\\Phi_0 G_0 \\left( \\frac{\\exp(i(x - 3y)) + \\exp(-i(x - 3y))}{2} - \\frac{\\exp(i(7x + 7y)) + \\exp(-i(7x + 7y))}{2} \\right) $$\n$$ J(x,y) = \\frac{7}{2}\\Phi_0 G_0 \\exp(i(x - 3y)) + \\frac{7}{2}\\Phi_0 G_0 \\exp(-i(x - 3y)) - \\frac{7}{2}\\Phi_0 G_0 \\exp(i(7x + 7y)) - \\frac{7}{2}\\Phi_0 G_0 \\exp(-i(7x + 7y)) $$\n通过将其与傅里叶级数形式 $f(x,y) = \\sum_{k_x, k_y} \\hat{f}_{k_x, k_y} \\exp(i(k_x x + k_y y))$ 匹配，我们可以确定波矢 $\\mathbf{k} = (k_x, k_y)$ 的非零连续傅里叶系数 $\\hat{J}_{k_x,k_y}$：\n$$ \\hat{J}_{1,-3} = \\frac{7}{2}\\Phi_0 G_0 $$\n$$ \\hat{J}_{-1,3} = \\frac{7}{2}\\Phi_0 G_0 $$\n$$ \\hat{J}_{7,7} = -\\frac{7}{2}\\Phi_0 G_0 $$\n$$ \\hat{J}_{-7,-7} = -\\frac{7}{2}\\Phi_0 G_0 $$\n所有其他连续傅里叶系数均为零。\n\n**第2部分：伪谱系数 $\\widehat{J}_{-5,-5}^{(\\mathrm{ps})}}$**\n\n伪谱法涉及将场变换到实空间网格上，逐点进行乘法运算，然后将乘积变换回谱空间。在有限网格上，此过程可能导致混叠，即来自不可表示的高波数的能量被错误地映射到可表示的低波数上。\n\n网格有 $N_x=12$ 和 $N_y=12$ 个点。可表示的波数集合是 $k_x, k_y \\in \\{-6, -5, \\dots, 5\\}$。$\\phi$（模在 $\\mathbf{k}_\\phi = \\pm(4,2)$）和 $g$（模在 $\\mathbf{k}_g = \\pm(3,5)$）的非线性相互作用产生和波数与差波数：$\\pm \\mathbf{k}_\\phi \\pm \\mathbf{k}_g$。它们是 $\\pm(7,7)$ 和 $\\pm(1,-3)$。\n\n我们来检查这些‘真实’波数中哪些在网格上是可表示的：\n- $\\mathbf{k} = (1,-3)$: $k_x=1$ 和 $k_y=-3$ 都在范围 $[-6,5]$ 内。此模式是可表示的。\n- $\\mathbf{k} = (-1,3)$: $k_x=-1$ 和 $k_y=3$ 都在范围 $[-6,5]$ 内。此模式是可表示的。\n- $\\mathbf{k} = (7,7)$: $k_x=7$ 和 $k_y=7$ 都在范围 $[-6,5]$ 之外。此模式不可表示，将会发生混叠。\n- $\\mathbf{k} = (-7,-7)$: $k_x=-7$ 和 $k_y=-7$ 都在范围 $[-6,5]$ 之外。此模式也不可表示，将会发生混叠。\n\n如果 $k' = k + mN$（其中 $m$ 为某个整数，N 是该方向上的格点数），则波数 $k$ 会混叠到主集中的波数 $k'$。\n对于 $\\mathbf{k} = (7,7)$ 和 $N_x=N_y=12$：\n- $k_x = 7$：混叠波数为 $k_x' = 7 - 1 \\cdot 12 = -5$。\n- $k_y = 7$：混叠波数为 $k_y' = 7 - 1 \\cdot 12 = -5$。\n因此，在 $\\mathbf{k}=(7,7)$ 处的模式混叠到 $\\mathbf{k}_{alias} = (-5,-5)$。\n\n对于 $\\mathbf{k} = (-7,-7)$：\n- $k_x = -7$：混叠波数为 $k_x' = -7 + 1 \\cdot 12 = 5$。\n- $k_y = -7$：混叠波数为 $k_y' = -7 + 1 \\cdot 12 = 5$。\n因此，在 $\\mathbf{k}=(-7,-7)$ 处的模式混叠到 $\\mathbf{k}_{alias} = (5,5)$。\n\n网格上给定波矢 $\\mathbf{k}$ 处的伪谱系数 $\\widehat{J}_{\\mathbf{k}}^{(\\mathrm{ps})}$，是在 $\\mathbf{k}$ 处的真实连续系数与所有混叠到 $\\mathbf{k}$ 的其他波数的真实系数之和。\n我们关心的是在 $\\mathbf{k} = (-5,-5)$ 处的系数。\n$$ \\widehat{J}_{-5,-5}^{(\\mathrm{ps})} = \\hat{J}_{-5,-5} + \\hat{J}_{7,7} + \\hat{J}_{-17,-17} + \\dots $$\n根据我们的分析，真实系数 $\\hat{J}_{-5,-5}$ 为零。唯一混叠到 $(-5,-5)$ 的非零真实系数是 $\\hat{J}_{7,7}$。\n因此，在 $(-5,-5)$ 处的总伪谱系数等于在 $(7,7)$ 处的真实系数。\n$$ \\widehat{J}_{-5,-5}^{(\\mathrm{ps})} = \\hat{J}_{7,7} = -\\frac{7}{2}\\Phi_0 G_0 $$\n\n**第3部分：去混叠系数 $\\widehat{J}_{-5,-5}^{(2/3)}$**\n\n该问题指定了一种去混叠程序，包括对伪谱法计算的非线性项进行截断。规则是：当 $|k_x| > N_x/3$ 或 $|k_y| > N_y/3$ 时，设置 $\\widehat{J}_{k_x,k_y}^{(2/3)} = 0$。\n对于我们的网格，$N_x = N_y = 12$，因此截断条件是 $|k_x| > 4$ 或 $|k_y| > 4$。\n\n我们将此规则应用于波矢 $\\mathbf{k} = (-5,-5)$ 处的系数。我们检查此波矢是否满足截断条件：\n- 对于 $k_x = -5$，我们有 $|k_x| = |-5| = 5$。由于 $5 > 4$，满足条件 $|k_x| > N_x/3$。\n- 对于 $k_y = -5$，我们有 $|k_y| = |-5| = 5$。由于 $5 > 4$，也满足条件 $|k_y| > N_y/3$。\n\n由于波矢 $(-5,-5)$ 满足该条件（只需一个分量满足即可），去混叠场中相应的系数必须设为零。\n$$ \\widehat{J}_{-5,-5}^{(2/3)} = 0 $$\n该过程有效地滤除了出现在 $\\mathbf{k}=(-5,-5)$ 处的混叠能量。\n\n最终答案是系数对 $\\widehat{J}_{-5,-5}^{(\\mathrm{ps})}$ 和 $\\widehat{J}_{-5,-5}^{(2/3)}$。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n-\\frac{7}{2}\\Phi_0 G_0  0\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "最后，我们将前述概念应用于一个高级的实践任务：计算非线性谱能量转移。这是分析湍流模拟数据以理解能量如何在不同尺度间流动的核心诊断工具。通过这个编码练习 ，你将使用去混叠的伪谱法来量化由 $E \\times B$ 非线性项所驱动的能量串级，从而将数值实现的技能与深刻的物理洞察力结合起来，体验从模拟数据中提取物理规律的过程。",
            "id": "4205469",
            "problem": "给定一个方形域上的二维、周期性、静电回旋动理学（GK）快照。在归一化单位下，电场 $E$ 穿过磁场 $B$ 引起的垂直平流产生了非线性的 $E \\times B$ 项。对于一个被不可压缩速度 $v_E = \\hat{z} \\times \\nabla \\phi$ 平流的广义场 $g(x,y)$，其守恒形式的非线性项是 $x$-$y$ 空间中的泊松括号 $\\{\\phi,g\\}$。您将为特定的快照定义并计算从该括号推导出的谱非线性能量输运 $T(k_r,k_\\theta)$，然后将其聚合到波数大小 $k_r$ 和极角 $k_\\theta$ 的极坐标分箱中。\n\n基本出发点：\n- 周期性板状域，$x \\in [0,2\\pi)$ 且 $y \\in [0,2\\pi)$。\n- 归一化的不可压缩平流速度为 $v_E = \\hat{z} \\times \\nabla \\phi$，因此非线性项是泊松括号\n$$\n\\{\\phi, g\\} = \\partial_x \\phi \\, \\partial_y g - \\partial_y \\phi \\, \\partial_x g.\n$$\n- 傅里叶模式 $(k_x,k_y)$ 的非线性能量输运需要直接从括号的定义、实空间能量密度以及周期函数的傅里叶变换性质推断出来。您必须使用快速傅里叶变换（FFT）和周期性边界条件。\n\n您的程序必须为每个测试用例计算以下内容：\n1. 使用提供的 $\\phi(x,y)$ 和 $g(x,y)$ 的解析形式，在 $[0,2\\pi)\\times[0,2\\pi)$ 上大小为 $N_x \\times N_y$ 的均匀网格上构建场。\n2. 通过在傅里叶空间乘以 $i k_x$ 和 $i k_y$ 的方法，在谱空间计算 $\\phi$ 和 $g$ 的空间导数。\n3. 在实空间中构建泊松括号场 $\\{\\phi,g\\}(x,y)$，并将其变换回傅里叶空间以获得非线性谱内容。\n4. 根据在没有源和汇的情况下二次能量 $\\frac{1}{2} \\sum_{k_x,k_y} |g_{k_x,k_y}|^2$ 守恒所蕴含的意义，仅使用括号和场 $g$ 为每个傅里叶模式定义谱非线性能量输运密度 $T(k_x,k_y)$，然后将所有其大小和角度落入相应分箱的 $(k_x,k_y)$ 的贡献相加，从而将 $T$ 聚合到极坐标分箱 $T(k_r,k_\\theta)$ 中。角度必须以弧度计算。\n5. 应用标准的三分之二去混叠规则，在形成导数之前对两个场以及括号的谱，一致地将 $|k_x|  N_x/3$ 或 $|k_y|  N_y/3$ 的傅里叶模式置零，以确保模式相互作用保持在解析尺度内。\n6. 对于每个测试用例，计算：\n   - 所有谱模式上的总非线性输运和，\n   $$\n   S = \\sum_{k_x,k_y} T(k_x,k_y),\n   $$\n   其结果应反映平流的不可压缩性质。\n   - 分箱后的 $T(k_r,k_\\theta)$ 中的最大绝对值，\n   $$\n   M = \\max_{r,\\theta} \\left| T(k_r,k_\\theta) \\right|.\n   $$\n   - 出现最大绝对值的分箱索引 $(r_\\star,\\theta_\\star)$，其中 $r_\\star$ 是 $[0, N_r-1]$ 内的整数，$\\theta_\\star$ 是 $[0, N_\\theta-1]$ 内的整数。\n\n分箱细节：\n- 使用 $N_r$ 个均匀间隔的径向分箱，覆盖范围为 $[0, k_{\\max}]$，其中 $k_{\\max} = \\max \\sqrt{k_x^2 + k_y^2}$ 是整个网格上的最大值。\n- 使用 $N_\\theta$ 个均匀间隔的角度分箱，覆盖范围为 $[-\\pi, \\pi]$（以弧度为单位）。\n- 使用标准的半开区间将 $(k_x,k_y)$ 分配到分箱中，但最后一个分箱包含其最右侧的边界。如果一个模式正好位于边界上，则将其分配到较高的分箱中，但对于最终边界，它被分配到最后一个分箱中。\n\n数值和单位约定：\n- 所有量都是无量纲的，与归一化的 GK 板和 $2\\pi$ 周期性一致。角度必须以弧度计算和分箱。\n- 在周期性网格上通过傅里叶变换使用谱微分。\n- 使用如上所述的三分之二去混叠规则。\n\n测试套件：\n对于每个测试用例 $i$，给定 $(N_x,N_y)$、振幅 $A$ 和 $B$、$\\phi(x,y)$ 和 $g(x,y)$ 的解析形式，以及分箱数量 $(N_r,N_\\theta)$。\n- 用例1（一般相互作用）：$N_x=16$, $N_y=16$, $A=1.0$, $B=0.8$,\n  $$\n  \\phi(x,y) = A \\cos(2 x)\\cos(y), \\quad g(x,y) = B \\sin(x)\\sin(2 y),\n  $$\n  $N_r=4$, $N_\\theta=4$。\n- 用例2（各向异性激发）：$N_x=32$, $N_y=16$, $A=0.9$, $B=0.7$,\n  $$\n  \\phi(x,y) = A\\left[\\cos(3 x) + 0.5\\cos(4 y)\\right], \\quad g(x,y) = B \\cos(3 x)\\sin(y),\n  $$\n  $N_r=5$, $N_\\theta=8$。\n- 用例3（自括号边界情况）：$N_x=8$, $N_y=8$, $A=1.0$, $B=1.0$,\n  $$\n  \\phi(x,y) = A \\sin(2 x)\\sin(3 y), \\quad g(x,y) = B \\sin(2 x)\\sin(3 y),\n  $$\n  $N_r=3$, $N_\\theta=6$。\n\n最终输出格式：\n- 对于每个测试用例，返回一个列表 $[S, M, r_\\star, \\theta_\\star]$，其中 $S$ 和 $M$ 是四舍五入到10位小数的浮点数，$r_\\star$ 和 $\\theta_\\star$ 是整数。\n- 您的程序应生成单行输出，其中包含结果，格式为这些列表的逗号分隔列表，并用方括号括起来，例如：`[[S_1,M_1,r_1,theta_1],[S_2,M_2,r_2,theta_2],[S_3,M_3,r_3,theta_3]]`。",
            "solution": "在尝试求解之前，用户提供的问题陈述会经过严格的验证过程。\n\n### 步骤1：提取给定信息\n- **域：** 周期性板状域，$x \\in [0,2\\pi)$，$y \\in [0,2\\pi)$。\n- **平流速度：** 不可压缩 $E \\times B$ 速度，$v_E = \\hat{z} \\times \\nabla \\phi$。\n- **非线性项：** $x-y$ 空间中的泊松括号，$\\{\\phi, g\\} = \\partial_x \\phi \\, \\partial_y g - \\partial_y \\phi \\, \\partial_x g$。\n- **任务：** 计算谱非线性能量输运 $T(k_r,k_\\theta)$，并聚合到极坐标分箱中。\n- **数值网格：** 大小为 $N_x \\times N_y$ 的均匀网格。\n- **数值方法：**\n    - 空间导数在谱空间计算（傅里叶空间中乘以 $i k_x$, $i k_y$）。\n    - 泊松括号的伪谱方法。\n    - 三分之二去混叠规则：将 $|k_x|  N_x/3$ 或 $|k_y|  N_y/3$ 的傅里叶模式置零。\n- **能量输运定义：** 从二次能量守恒 $\\frac{1}{2} \\sum_{k_x,k_y} |g_{k_x,k_y}|^2$ 推断。\n- **分箱：**\n    - 在 $[0,k_{\\max}]$ 上的 $N_r$ 个均匀径向分箱，其中 $k_{\\max} = \\max \\sqrt{k_x^2 + k_y^2}$。\n    - 在 $[-\\pi,\\pi]$ 上的 $N_\\theta$ 个均匀角度分箱。\n    - 分箱规则：在边界上时分配到较高的分箱，但最终边界值包含在最后一个分箱中。\n- **每个用例的输出：**\n    1.  总输运和，$S = \\sum_{k_x,k_y} T(k_x,k_y)$。\n    2.  分箱后的最大绝对输运，$M = \\max_{r,\\theta} \\left| T(k_r,k_\\theta) \\right|$。\n    3.  最大值所在分箱的索引，$(r_\\star, \\theta_\\star)$。\n- **测试用例：**\n    - **用例1：** $N_x=16, N_y=16, A=1.0, B=0.8, \\phi(x,y) = A \\cos(2 x)\\cos(y), g(x,y) = B \\sin(x)\\sin(2 y), N_r=4, N_\\theta=4$。\n    - **用例2：** $N_x=32, N_y=16, A=0.9, B=0.7, \\phi(x,y) = A[\\cos(3 x) + 0.5\\cos(4 y)], g(x,y) = B \\cos(3 x)\\sin(y), N_r=5, N_\\theta=8$。\n    - **用例3：** $N_x=8, N_y=8, A=1.0, B=1.0, \\phi(x,y) = A \\sin(2 x)\\sin(3 y), g(x,y) = B \\sin(2 x)\\sin(3 y), N_r=3, N_\\theta=6$。\n\n### 步骤2：使用提取的给定信息进行验证\n- **科学基础：** 该问题在根本上是合理的。它涉及通过 $E \\times B$ 平流项（表示为泊松括号）计算非线性能量输运。这是研究二维流体和等离子体湍流中的一个典型问题，特别是在回旋动理学的框架内。指定的方法——伪谱评估、谱微分和三分之二去混叠规则——是解决此类问题的标准且严谨的技术。\n- **适定性：** 该问题是适定的。所有输入，包括网格参数、场定义和分箱规范，都已明确提供。期望的输出是从这些输入中导出的精确定义的数学量。该过程是算法化和确定性的，保证了唯一解。\n- **客观性：** 该问题以客观、形式化的语言陈述，使用了物理学和数值分析的标准术语。它没有主观或模糊的陈述。\n- **缺陷分析：**\n    - 不存在科学或事实上的不合理之处。不可压缩平流和能量守恒的基本物理原理得到了正确表述。\n    - 该问题与聚变等离子体湍流模拟直接相关，并且是完全形式化的。\n    - 设置是完整的且内部一致。\n    - 参数的选择使得问题在数值上是可处理的，并且作为湍流系统中的模式在物理上是合理的。\n    - 问题结构清晰，并能导出一个唯一的、稳定的解。\n    - 这是一个计算物理学中不平凡的练习，需要正确实现几个标准算法。包含 $\\{\\phi,\\phi\\}=0$ 的边界情况（用例3）展示了概念深度。\n    - 结果是可通过计算验证的。\n\n### 步骤3：结论与行动\n该问题被判定为**有效**。将基于流体动力学中谱方法的原理来开发解决方案。\n\n### 求解设计\n\n解决方案将基于以下原则构建。\n\n**1. 控制方程和能量守恒**\n在速度场 $v_E$ 的平流作用下，标量场 $g$ 的演化由连续性方程给出：\n$$\n\\frac{\\partial g}{\\partial t} + \\nabla \\cdot (g v_E) = 0\n$$\n鉴于速度是不可压缩的，$\\nabla \\cdot v_E = 0$，这可以简化为：\n$$\n\\frac{\\partial g}{\\partial t} + v_E \\cdot \\nabla g = 0\n$$\n代入 $v_E = \\hat{z} \\times \\nabla \\phi = (\\partial_y \\phi, -\\partial_x \\phi, 0)$，平流项变为：\n$$\nv_E \\cdot \\nabla g = (\\partial_y \\phi)(\\partial_x g) - (\\partial_x \\phi)(\\partial_y g) = -\\{\\phi, g\\}\n$$\n因此，控制动力学由以下方程描述：\n$$\n\\frac{\\partial g}{\\partial t} - \\{\\phi, g\\} = 0\n$$\n总能量 $E_{total} = \\frac{1}{2} \\int g^2 \\,dx\\,dy$ 是守恒的。其时间导数为：\n$$\n\\frac{dE_{total}}{dt} = \\int g \\frac{\\partial g}{\\partial t} \\,dx\\,dy = \\int g \\{\\phi, g\\} \\,dx\\,dy\n$$\n使用分部积分和周期性边界条件，可以证明 $\\int g \\{\\phi, g\\} \\,dx\\,dy = 0$。这意味着总能量是恒定的，任何从某些模式损失的能量必须被其他模式获得。因此，所有模式上的谱能量输运之和必须为零，即 $S = \\sum_{k_x,k_y} T(k_x,k_y) = 0$。这可作为数值实现的一个关键验证。\n\n**2. 谱表示和伪谱方法**\n我们使用离散傅里叶级数在离散网格上表示场。函数 $f(x,y)$ 的傅里叶变换 $\\mathcal{F}$ 记为 $\\hat{f}(k_x, k_y)$。谱微分的关键性质是 $\\mathcal{F}\\{\\partial_x f\\} = i k_x \\hat{f}$ 和 $\\mathcal{F}\\{\\partial_y f\\} = i k_y \\hat{f}$，其中 $k_x$ 和 $k_y$ 是对应于大小为 $2\\pi \\times 2\\pi$ 的周期性域的整数波数。\n\n泊松括号 $\\{\\phi,g\\}$ 涉及场的乘积。在傅里叶空间中直接求值需要昂贵的卷积运算。伪谱方法效率更高：\n1.  计算傅里叶变换 $\\hat{\\phi}$ 和 $\\hat{g}$。\n2.  计算导数的谱，例如 $\\widehat{\\partial_x \\phi} = i k_x \\hat{\\phi}$。\n3.  逆变换回实空间以获得导数，例如 $\\partial_x \\phi = \\mathcal{F}^{-1}\\{i k_x \\hat{\\phi}\\}$。\n4.  在实空间中执行乘法和减法：$\\{\\phi,g\\}(x,y) = (\\partial_x \\phi)(\\partial_y g) - (\\partial_y \\phi)(\\partial_x g)$。\n5.  对结果场进行傅里叶变换以获得其谱 $\\widehat{\\{\\phi,g\\}}$。\n\n**3. 去混叠**\n实空间中的乘积可能导致混叠误差，即乘积产生的高频内容在离散网格上被错误地表示为较低频率。三分之二去混叠规则可以减轻此问题。我们定义一个滤波器，将所有满足 $|k_x|  N_x/3$ 或 $|k_y|  N_y/3$ 的傅里叶模式 $(k_x, k_y)$ 置零。在计算导数之前，此滤波器应用于 $\\phi$ 和 $g$ 的谱，也应用于泊松括号的最终谱，以确保所有非线性相互作用都在没有混叠的情况下被解析。\n\n**4. 谱能量输运**\n傅里叶空间中的演化方程是 $\\frac{\\partial \\hat{g}_k}{\\partial t} = \\widehat{\\{\\phi,g\\}}_k$，其中 $k$ 是对 $(k_x, k_y)$ 的简写。特定模式 $k$ 中的能量为 $E_k \\propto |\\hat{g}_k|^2$。其变化率定义了谱能量输运 $T_k$：\n$$\nT_k = \\frac{d}{dt} \\left(\\frac{1}{2} |\\hat{g}_k|^2\\right) = \\frac{1}{2} \\left( \\hat{g}_k^* \\frac{\\partial \\hat{g}_k}{\\partial t} + \\frac{\\partial \\hat{g}_k^*}{\\partial t} \\hat{g}_k \\right) = \\text{Re}\\left(\\hat{g}_k^* \\frac{\\partial \\hat{g}_k}{\\partial t}\\right)\n$$\n代入演化方程，我们得到计算场 $g$ 的模式 $k$ 的谱输运的公式：\n$$\nT(k_x, k_y) = \\text{Re}\\left( \\hat{g}_{k_x,k_y}^* \\cdot \\widehat{\\{\\phi,g\\}}_{k_x,k_y} \\right)\n$$\n其中为保持一致性，必须使用谱的去混叠版本。\n\n**5. 实现算法**\n最终的算法综合了这些原则：\n1.  **初始化：** 为给定的 $N_x, N_y$ 构建空间网格和波数网格。\n2.  **场生成：** 在空间网格上计算 $\\phi(x,y)$ 和 $g(x,y)$ 的解析形式。\n3.  **谱变换：** 计算 $\\hat{\\phi} = \\text{FFT}(\\phi)$ 和 $\\hat{g} = \\text{FFT}(g)$。\n4.  **去混叠：** 基于三分之二规则创建低通滤波器掩码，并将其应用于 $\\hat{\\phi}$ 和 $\\hat{g}$。\n5.  **导数计算：** 使用去混叠后的场计算所有四个所需空间导数的谱，并进行逆变换以获得实空间中的导数。\n6.  **括号计算：** 在实空间中计算泊松括号 $\\{\\phi,g\\}$，然后变换到傅里叶空间以获得 $\\widehat{\\{\\phi,g\\}}$。为保持一致性，再次应用去混叠掩码。\n7.  **输运谱：** 使用去混叠的 $\\hat{g}$ 和去混叠的 $\\widehat{\\{\\phi,g\\}}$ 计算所有模式的 $T(k_x,k_y)$。\n8.  **聚合：** 计算总输运 $S = \\sum_k T_k$。\n9.  **分箱：**\n    - 对于每个模式 $(k_x, k_y)$，计算其极坐标 $(k_r, k_\\theta)$。\n    - 确定径向和角度分箱的边界。\n    - 使用 `np.digitize` 找出每个模式的 $k_r$ 和 $k_\\theta$ 的分箱索引。按规定处理边界条件。\n    - 将 $T(k_x, k_y)$ 的值累加到二维累加器数组中相应的 $(r, \\theta)$ 分箱中。\n10. **最终度量：** 从分箱后的输运数据中，找到最大绝对值 $M$ 及其分箱索引 $(r_\\star, \\theta_\\star)$。\n11. **输出：** 按要求为每个测试用例格式化结果 $[S, M, r_\\star, \\theta_\\star]$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import __version__ as scipy_version  # Used only for complying with problem spec on libraries\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases for nonlinear spectral energy transfer.\n    \"\"\"\n\n    def compute_transfer(case):\n        \"\"\"\n        Computes the nonlinear transfer for a single test case.\n        \"\"\"\n        Nx, Ny, A, B, phi_func, g_func, Nr, Ntheta = case\n\n        # 1. Grid and Field Setup\n        x = np.linspace(0, 2 * np.pi, Nx, endpoint=False)\n        y = np.linspace(0, 2 * np.pi, Ny, endpoint=False)\n        xx, yy = np.meshgrid(x, y, indexing='ij')\n\n        phi = phi_func(xx, yy, A)\n        g = g_func(xx, yy, B)\n\n        # 2. Wavenumber Grids\n        kx = np.fft.fftfreq(Nx) * Nx\n        ky = np.fft.fftfreq(Ny) * Ny\n        kxx, kyy = np.meshgrid(kx, ky, indexing='ij')\n\n        # 3. FFTs of the fields\n        phi_k = np.fft.fft2(phi)\n        g_k = np.fft.fft2(g)\n\n        # 4. De-aliasing (2/3 rule)\n        k_max_x_dealias = Nx / 3.0\n        k_max_y_dealias = Ny / 3.0\n        dealias_mask = (np.abs(kxx) = k_max_x_dealias)  (np.abs(kyy) = k_max_y_dealias)\n        \n        phi_k_dealiased = phi_k * dealias_mask\n        g_k_dealiased = g_k * dealias_mask\n\n        # 5. Spectral Derivatives\n        dphi_dx_k = 1j * kxx * phi_k_dealiased\n        dphi_dy_k = 1j * kyy * phi_k_dealiased\n        dg_dx_k = 1j * kxx * g_k_dealiased\n        dg_dy_k = 1j * kyy * g_k_dealiased\n\n        # 6. Inverse FFT to get real-space derivatives\n        dphi_dx = np.fft.ifft2(dphi_dx_k).real\n        dphi_dy = np.fft.ifft2(dphi_dy_k).real\n        dg_dx = np.fft.ifft2(dg_dx_k).real\n        dg_dy = np.fft.ifft2(dg_dy_k).real\n\n        # 7. Poisson Bracket\n        poisson_bracket = dphi_dx * dg_dy - dphi_dy * dg_dx\n\n        # 8. Spectrum of the bracket\n        poisson_bracket_k = np.fft.fft2(poisson_bracket)\n        poisson_bracket_k_dealiased = poisson_bracket_k * dealias_mask\n\n        # 9. Spectral Energy Transfer T(k_x, k_y)\n        T_k = np.real(np.conj(g_k_dealiased) * poisson_bracket_k_dealiased)\n\n        # 10. Total Transfer S\n        S = np.sum(T_k)\n\n        # 11. Binning\n        kr = np.sqrt(kxx**2 + kyy**2)\n        ktheta = np.arctan2(kyy, kxx)\n\n        # Flatten arrays for easier indexing\n        T_k_flat = T_k.flatten()\n        kr_flat = kr.flatten()\n        ktheta_flat = ktheta.flatten()\n\n        k_max_val = np.max(kr_flat)\n        \n        # Define bin edges. k_max_val=0 is a special case.\n        if k_max_val > 0:\n            r_bins = np.linspace(0, k_max_val, Nr + 1)\n        else: # Handle case of zero field\n            r_bins = np.zeros(Nr + 1)\n            \n        theta_bins = np.linspace(-np.pi, np.pi, Ntheta + 1)\n        \n        # Get bin indices for each k-mode\n        r_indices = np.digitize(kr_flat, r_bins) - 1\n        theta_indices = np.digitize(ktheta_flat, theta_bins) - 1\n\n        # Clip indices to be within [0, N-1] to handle edges correctly\n        # The specified rule puts values on the last edge into the last bin.\n        # np.digitize puts x=bins[-1] into bin N, so clipping to N-1 is correct.\n        r_indices = np.clip(r_indices, 0, Nr - 1)\n        theta_indices = np.clip(theta_indices, 0, Ntheta - 1)\n\n        # Sum T_k into the polar bins\n        T_binned = np.zeros((Nr, Ntheta))\n        np.add.at(T_binned, (r_indices, theta_indices), T_k_flat)\n\n        # 12. Find max absolute value and its indices\n        abs_T_binned = np.abs(T_binned)\n        M = np.max(abs_T_binned)\n        \n        # np.argmax returns the first occurrence in case of ties.\n        max_loc_flat = np.argmax(abs_T_binned)\n        r_star, theta_star = np.unravel_index(max_loc_flat, abs_T_binned.shape)\n\n        return [round(S, 10), round(M, 10), int(r_star), int(theta_star)]\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (16, 16, 1.0, 0.8,\n         lambda x, y, A: A * np.cos(2 * x) * np.cos(y),\n         lambda x, y, B: B * np.sin(x) * np.sin(2 * y),\n         4, 4),\n\n        (32, 16, 0.9, 0.7,\n         lambda x, y, A: A * (np.cos(3 * x) + 0.5 * np.cos(4 * y)),\n         lambda x, y, B: B * np.cos(3 * x) * np.sin(y),\n         5, 8),\n\n        (8, 8, 1.0, 1.0,\n         lambda x, y, A: A * np.sin(2 * x) * np.sin(3 * y),\n         lambda x, y, B: B * np.sin(2 * x) * np.sin(3 * y),\n         3, 6)\n    ]\n\n    results = []\n    for case in test_cases:\n        result = compute_transfer(case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\".replace(\" \", \"\"))\n\nsolve()\n\n```"
        }
    ]
}