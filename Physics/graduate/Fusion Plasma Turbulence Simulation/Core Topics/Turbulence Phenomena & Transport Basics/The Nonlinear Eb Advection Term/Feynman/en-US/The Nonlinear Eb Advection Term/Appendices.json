{
    "hands_on_practices": [
        {
            "introduction": "Before developing complex turbulence simulations, it is crucial to ensure that our discrete operators correctly mirror the fundamental properties of the continuous equations. This first practice  provides a foundational coding exercise using a simple central-difference scheme. You will verify two key properties of the $E \\times B$ flow: its discrete incompressibility and the exact conservation of the total advected scalar on a periodic domain, building a solid base for more advanced implementations.",
            "id": "4205468",
            "problem": "You will implement and verify a conservative, flux-form discretization of the Electric field cross Magnetic field (E x B) nonlinear advection term in a two-dimensional, periodic domain, and demonstrate that the discrete divergence of the E x B drift velocity vanishes to round-off under a consistent central-difference discretization.\n\nThe fundamental base for this problem consists of the following physical definitions and mathematical facts:\n- In electrostatics, the electric field is $\\mathbf{E} = -\\nabla \\phi$, where $\\phi$ is the electrostatic potential.\n- For a uniform magnetic field $\\mathbf{B} = B_0 \\,\\hat{\\mathbf{z}}$, the Electric field cross Magnetic field (E x B) drift velocity is $\\mathbf{v}_E = \\dfrac{\\mathbf{E} \\times \\mathbf{B}}{B_0^2}$. In dimensionless normalization with $B_0 = 1$ and the coefficient absorbed into units, this reduces in two dimensions to $\\mathbf{v}_E = \\hat{\\mathbf{z}} \\times \\nabla \\phi$, hence $v_x = -\\partial_y \\phi$ and $v_y = \\partial_x \\phi$.\n- The vector calculus identity $\\mathbf{v}\\cdot\\nabla f = \\nabla\\cdot(f\\,\\mathbf{v}) - f\\,\\nabla\\cdot\\mathbf{v}$ implies $\\mathbf{v}_E\\cdot\\nabla f = \\nabla\\cdot(f\\,\\mathbf{v}_E)$ when $\\nabla\\cdot\\mathbf{v}_E = 0$.\n- On a uniform grid, consistent central differences with periodic boundary conditions lead to commuting discrete derivatives, which is the discrete analog of the continuous identity $\\partial_x\\partial_y = \\partial_y\\partial_x$.\n\nYou must implement the following, using dimensionless units and angles in radians:\n1. A two-dimensional, periodic grid with $N_x$ points in the $x$ direction and $N_y$ points in the $y$ direction, spanning $[0,L_x)$ and $[0,L_y)$, respectively. Use uniform spacings $\\Delta x = L_x/N_x$ and $\\Delta y = L_y/N_y$.\n2. The central-difference discrete derivatives\n   $$D_x g_{i,j} = \\frac{g_{i+1,j} - g_{i-1,j}}{2\\,\\Delta x}, \\quad D_y g_{i,j} = \\frac{g_{i,j+1} - g_{i,j-1}}{2\\,\\Delta y},$$\n   with periodic wrap-around indexing.\n3. The E x B drift velocity defined discretely by $v_x = -D_y \\phi$ and $v_y = D_x \\phi$.\n4. The discrete divergence of the E x B velocity $\\nabla\\cdot\\mathbf{v}_E \\approx D_x v_x + D_y v_y$.\n5. The conservative flux-form advection of a scalar field $f$,\n   $$\\mathcal{A}(f,\\phi) \\equiv D_x\\!\\left(f\\,v_x\\right) + D_y\\!\\left(f\\,v_y\\right),$$\n   where $v_x$ and $v_y$ are constructed consistently from the same discrete derivative operators as above.\n\nYour program must define and run the following test suite of parameter sets and fields, covering general behavior and edge cases. All quantities are dimensionless, and angles are in radians. For each case below, construct $\\phi(x,y)$ and $f(x,y)$ exactly as specified:\n\n- Case $1$ (smooth, nontrivial fields, odd $N_y$):\n  - $N_x = 64$, $N_y = 65$, $L_x = 2\\pi$, $L_y = 2\\pi$.\n  - $\\phi(x,y) = \\sin(3x)\\,\\cos(4y)$.\n  - $f(x,y) = \\cos(2x)\\,\\sin(3y)$.\n\n- Case $2$ (zero velocity field):\n  - $N_x = 4$, $N_y = 4$, $L_x = 2\\pi$, $L_y = 2\\pi$.\n  - $\\phi(x,y) = 0.37$ (constant).\n  - $f(x,y) = \\sin(x) + \\cos(y)$.\n\n- Case $3$ (constant advected field):\n  - $N_x = 33$, $N_y = 31$, $L_x = 2\\pi$, $L_y = 2\\pi$.\n  - $\\phi(x,y) = \\sin(5x) + \\sin(7y)$.\n  - $f(x,y) = 1.0$ (constant).\n\n- Case $4$ (random fields, reproducibility via a fixed seed):\n  - $N_x = 128$, $N_y = 128$, $L_x = 2\\pi$, $L_y = 2\\pi$.\n  - $\\phi(x,y)$ and $f(x,y)$ are independent, identically distributed pseudo-random fields on the grid, each sampled uniformly from $[0,1)$ using a fixed seed $42$.\n\nFor each case, compute and return the following three metrics:\n- $m_1$: the maximum absolute value of the discrete divergence of $\\mathbf{v}_E$, namely $\\max_{i,j}\\left|\\left(D_x v_x + D_y v_y\\right)_{i,j}\\right|$.\n- $m_2$: the discrete $L^2$ norm of the divergence of $\\mathbf{v}_E$ scaled by the cell area, namely\n  $$m_2 = \\sqrt{\\sum_{i,j} \\left(D_x v_x + D_y v_y\\right)_{i,j}^2\\,\\Delta x\\,\\Delta y}.$$\n- $m_3$: the absolute value of the domain-integrated conservative flux-form advection, namely\n  $$m_3 = \\left|\\sum_{i,j} \\mathcal{A}(f,\\phi)_{i,j}\\,\\Delta x\\,\\Delta y\\right|.$$\n\nYour program should produce a single line of output containing the results as a comma-separated list of four case results, in order from Case $1$ to Case $4$, where each case result is a comma-separated triple enclosed in square brackets. For example, the output format must be\n$$\\texttt{[[m1\\_case1,m2\\_case1,m3\\_case1],[m1\\_case2,m2\\_case2,m3\\_case2],[m1\\_case3,m2\\_case3,m3\\_case3],[m1\\_case4,m2\\_case4,m3\\_case4]]}$$\nwith each $m_k$ represented as a floating-point number. All quantities are dimensionless and angles are in radians.",
            "solution": "The problem statement is valid. It presents a well-posed, scientifically grounded task in computational plasma physics concerning the numerical properties of the E×B advection term. All necessary parameters and definitions are provided, and the problem is free of contradictions or ambiguities.\n\nThe core of this problem is to verify two fundamental properties of a specific numerical discretization of the E×B nonlinearity on a two-dimensional periodic domain. These properties are discrete analogues of continuous mathematical identities that are crucial for the physical fidelity of simulations, particularly with respect to conservation laws.\n\nFirst, we consider the continuous E×B drift velocity. Given a uniform magnetic field $\\mathbf{B} = B_0 \\hat{\\mathbf{z}}$ and an electrostatic potential $\\phi$, the electric field is $\\mathbf{E} = -\\nabla \\phi$. In dimensionless units where the coefficient $1/B_0$ is absorbed, the E×B drift velocity in two dimensions ($x, y$) is given by $\\mathbf{v}_E = \\hat{\\mathbf{z}} \\times \\nabla \\phi$. This cross product expands to the components $v_x = -\\partial_y \\phi$ and $v_y = \\partial_x \\phi$.\n\nA key property of this velocity field is that it is divergence-free. The divergence is calculated as:\n$$\n\\nabla \\cdot \\mathbf{v}_E = \\frac{\\partial v_x}{\\partial x} + \\frac{\\partial v_y}{\\partial y} = \\frac{\\partial}{\\partial x}\\left(-\\frac{\\partial \\phi}{\\partial y}\\right) + \\frac{\\partial}{\\partial y}\\left(\\frac{\\partial \\phi}{\\partial x}\\right) = -\\frac{\\partial^2 \\phi}{\\partial x \\partial y} + \\frac{\\partial^2 \\phi}{\\partial y \\partial x}\n$$\nAccording to Clairaut's theorem on the equality of mixed partials, if $\\phi$ has continuous second partial derivatives, then $\\frac{\\partial^2 \\phi}{\\partial x \\partial y} = \\frac{\\partial^2 \\phi}{\\partial y \\partial x}$. Consequently, $\\nabla \\cdot \\mathbf{v}_E = 0$.\n\nThe problem asks us to investigate the discrete analogue of this property. We use a uniform grid with spacings $\\Delta x$ and $\\Delta y$, and central-difference operators for the partial derivatives:\n$$\nD_x g_{i,j} = \\frac{g_{i+1,j} - g_{i-1,j}}{2\\,\\Delta x}, \\quad D_y g_{i,j} = \\frac{g_{i,j+1} - g_{i,j-1}}{2\\,\\Delta y}\n$$\nThese operators act on a grid function $g_{i,j}$ and utilize periodic boundary conditions. The discrete velocity components are defined consistently as $v_x = -D_y \\phi$ and $v_y = D_x \\phi$. The discrete divergence is then:\n$$\n(D_x v_x + D_y v_y)_{i,j} = D_x(-D_y \\phi)_{i,j} + D_y(D_x \\phi)_{i,j} = (-D_x D_y + D_y D_x)\\phi_{i,j}\n$$\nA fundamental property of these specific finite difference operators on a uniform grid is that they commute, i.e., $D_x D_y g = D_y D_x g$ for any grid function $g$. This can be shown by expanding the operators. Therefore, the discrete divergence of the discrete E×B velocity, $(D_y D_x - D_x D_y)\\phi$, must be identically zero in exact arithmetic. Any non-zero result obtained in a floating-point computation will be due to round-off error. The metrics $m_1$ and $m_2$ are designed to measure the magnitude of this numerical error.\n- $m_1 = \\max_{i,j}\\left|\\left(D_x v_x + D_y v_y\\right)_{i,j}\\right|$ measures the maximum point-wise error.\n- $m_2 = \\sqrt{\\sum_{i,j} \\left(D_x v_x + D_y v_y\\right)_{i,j}^2\\,\\Delta x\\,\\Delta y}$ measures the grid-integrated error in an $L^2$ sense.\nWe expect both $m_1$ and $m_2$ to be on the order of machine precision.\n\nSecond, we consider the advection of a scalar quantity $f$ by the velocity field $\\mathbf{v}_E$. The advection term, $\\mathbf{v}_E \\cdot \\nabla f$, can be written in a \"flux-form\" or \"conservation-form\" using the vector identity $\\mathbf{v}\\cdot\\nabla f = \\nabla\\cdot(f\\,\\mathbf{v}) - f\\,(\\nabla\\cdot\\mathbf{v})$. Since $\\nabla \\cdot \\mathbf{v}_E = 0$, this simplifies to $\\mathbf{v}_E \\cdot \\nabla f = \\nabla \\cdot (f \\mathbf{v}_E)$. The term $\\nabla \\cdot (f \\mathbf{v}_E)$ is the divergence of the flux $f \\mathbf{v}_E$.\n\nThe problem defines the discrete advection operator in this conservative flux-form:\n$$\n\\mathcal{A}(f,\\phi) \\equiv D_x\\!\\left(f\\,v_x\\right) + D_y\\!\\left(f\\,v_y\\right)\n$$\nThis is the discrete divergence of the discrete flux vector $(f v_x, f v_y)$. A key property of conservative schemes is that they should not spuriously create or destroy the total amount of the advected quantity $f$ in the domain. The total amount is the domain integral, or in the discrete case, the sum $\\sum_{i,j} f_{i,j} \\Delta x \\Delta y$. The rate of change of this total quantity is given by the sum of the advection term over the domain: $\\sum_{i,j} \\mathcal{A}(f,\\phi)_{i,j} \\Delta x \\Delta y$.\n\nBy the discrete equivalent of the divergence theorem on a periodic domain, the sum of a discrete divergence over all grid cells must be zero. Let's examine the sum for the $x$-component:\n$$\n\\sum_{i,j} D_x(f v_x)_{i,j} = \\sum_j \\left( \\sum_i \\frac{(f v_x)_{i+1,j} - (f v_x)_{i-1,j}}{2\\Delta x} \\right)\n$$\nThe inner sum over index $i$ is a telescoping sum. Due to the periodic boundary conditions, for every term $(f v_x)_{k,j}$ appearing with a positive sign, it also appears with a negative sign (shifted by two indices), causing the sum to be identically zero. The same logic applies to the $y$-component. Thus, the total sum must be zero in exact arithmetic. The metric $m_3$ measures the absolute value of this sum computed with floating-point numbers:\n$$\nm_3 = \\left|\\sum_{i,j} \\mathcal{A}(f,\\phi)_{i,j}\\,\\Delta x\\,\\Delta y\\right|\n$$\nWe expect $m_3$ to also be on the order of machine precision, confirming that the numerical scheme is conservative.\n\nThe implementation will proceed by defining the grid and fields for each test case, applying the discrete operators to compute the velocity, its divergence, and the flux-form advection, and finally calculating the three metrics $m_1, m_2$, and $m_3$.\nThe test cases are designed to verify these properties under various conditions: smooth fields, zero velocity (constant $\\phi$), constant advected quantity $f$, and general random fields. In all cases, the metrics are expected to be very small, close to floating-point zero. For Case $2$ where $\\phi$ is constant, the velocity field is analytically zero, so all metrics should be exactly $0.0$.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements and verifies a conservative discretization of the E×B nonlinear advection term.\n    \"\"\"\n    \n    test_cases = [\n        {\n            \"id\": 1,\n            \"Nx\": 64, \"Ny\": 65, \"Lx\": 2 * np.pi, \"Ly\": 2 * np.pi,\n            \"phi_func\": lambda x, y: np.sin(3 * x) * np.cos(4 * y),\n            \"f_func\": lambda x, y: np.cos(2 * x) * np.sin(3 * y),\n            \"is_random\": False\n        },\n        {\n            \"id\": 2,\n            \"Nx\": 4, \"Ny\": 4, \"Lx\": 2 * np.pi, \"Ly\": 2 * np.pi,\n            \"phi_func\": lambda x, y: np.full_like(x, 0.37),\n            \"f_func\": lambda x, y: np.sin(x) + np.cos(y),\n            \"is_random\": False\n        },\n        {\n            \"id\": 3,\n            \"Nx\": 33, \"Ny\": 31, \"Lx\": 2 * np.pi, \"Ly\": 2 * np.pi,\n            \"phi_func\": lambda x, y: np.sin(5 * x) + np.sin(7 * y),\n            \"f_func\": lambda x, y: np.ones_like(x),\n            \"is_random\": False\n        },\n        {\n            \"id\": 4,\n            \"Nx\": 128, \"Ny\": 128, \"Lx\": 2 * np.pi, \"Ly\": 2 * np.pi,\n            \"phi_func\": None, # Will be generated randomly\n            \"f_func\": None,   # Will be generated randomly\n            \"is_random\": True,\n            \"seed\": 42\n        }\n    ]\n\n    # Helper functions for central differences with periodic boundaries\n    def central_diff_x(g, dx):\n        \"\"\"Computes the central difference derivative along the x-axis (axis 0).\"\"\"\n        return (np.roll(g, -1, axis=0) - np.roll(g, 1, axis=0)) / (2 * dx)\n\n    def central_diff_y(g, dy):\n        \"\"\"Computes the central difference derivative along the y-axis (axis 1).\"\"\"\n        return (np.roll(g, -1, axis=1) - np.roll(g, 1, axis=1)) / (2 * dy)\n\n    results = []\n\n    for case in test_cases:\n        # 1. Setup grid and parameters\n        Nx, Ny = case[\"Nx\"], case[\"Ny\"]\n        Lx, Ly = case[\"Lx\"], case[\"Ly\"]\n        dx, dy = Lx / Nx, Ly / Ny\n\n        x = np.linspace(0, Lx, Nx, endpoint=False)\n        y = np.linspace(0, Ly, Ny, endpoint=False)\n        xx, yy = np.meshgrid(x, y, indexing='ij')\n\n        # 2. Construct scalar fields phi and f\n        if case[\"is_random\"]:\n            rng = np.random.default_rng(seed=case[\"seed\"])\n            phi = rng.uniform(size=(Nx, Ny))\n            f = rng.uniform(size=(Nx, Ny))\n        else:\n            phi = case[\"phi_func\"](xx, yy)\n            f = case[\"f_func\"](xx, yy)\n        \n        # 3. Compute discrete E×B velocity components\n        # vx = -Dy(phi)\n        vx = -central_diff_y(phi, dy)\n        # vy = Dx(phi)\n        vy = central_diff_x(phi, dx)\n        \n        # 4. Compute the discrete divergence of the E×B velocity\n        div_vE = central_diff_x(vx, dx) + central_diff_y(vy, dy)\n        \n        # 5. Compute the conservative flux-form advection term\n        flux_x = f * vx\n        flux_y = f * vy\n        advection_term = central_diff_x(flux_x, dx) + central_diff_y(flux_y, dy)\n        \n        # 6. Calculate the three metrics\n        # m1: max absolute value of the discrete divergence of v_E\n        m1 = np.max(np.abs(div_vE))\n        \n        # m2: L2 norm of the divergence of v_E\n        cell_area = dx * dy\n        m2 = np.sqrt(np.sum(div_vE**2) * cell_area)\n        \n        # m3: absolute value of the domain-integrated advection\n        m3 = np.abs(np.sum(advection_term) * cell_area)\n        \n        results.append([m1, m2, m3])\n\n    # Format the final output string as specified\n    formatted_results = [f\"[{r[0]},{r[1]},{r[2]}]\" for r in results]\n    output_string = f\"[{','.join(formatted_results)}]\"\n    \n    print(output_string)\n\nsolve()\n```"
        },
        {
            "introduction": "While finite-difference methods are intuitive, many high-performance simulation codes employ spectral methods for their superior accuracy. These powerful techniques, however, come with their own unique numerical challenges. This analytical exercise  guides you through the pseudospectral evaluation of the nonlinear term, demonstrating precisely how non-physical aliasing errors arise from quadratic products and how the standard two-thirds de-aliasing rule effectively removes them.",
            "id": "4205506",
            "problem": "Consider a collisionless, electrostatic, two-dimensional periodic domain with $L_x = 2\\pi$ and $L_y = 2\\pi$, and a uniform magnetic field in the $\\hat{\\mathbf{z}}$ direction. The nonlinear electric-field–magnetic-field ($E \\times B$) advection term of a scalar fluctuation $g(x,y)$ by the electrostatic potential $\\phi(x,y)$ can be written, in non-dimensional units with constant magnetic field magnitude set to unity, as the Poisson bracket\n$$\nJ(\\phi,g) \\equiv \\hat{\\mathbf{z}} \\times \\nabla \\phi \\cdot \\nabla g \\;=\\; \\partial_{x}\\phi\\,\\partial_{y}g \\;-\\; \\partial_{y}\\phi\\,\\partial_{x}g \\, .\n$$\nYou will evaluate this nonlinearity pseudospectrally on an $N_x \\times N_y$ grid with $N_x = N_y = 12$ equispaced points in each direction, using the complex-exponential Fourier series convention\n$$\nf(x,y) \\;=\\; \\sum_{k_x=-N_x/2}^{N_x/2-1} \\sum_{k_y=-N_y/2}^{N_y/2-1} \\hat{f}_{k_x,k_y}\\,\\exp\\!\\big(i(k_x x + k_y y)\\big) \\, ,\n$$\nwhere $k_x$ and $k_y$ are integers and you should take the principal wavenumber set $\\{-6,-5,\\ldots,5\\}$ in each direction. The pseudospectral evaluation means computing spatial derivatives exactly in spectral space, transforming to physical space to form products pointwise on the grid, and then transforming the product back to spectral space using the Discrete Fourier Transform (DFT).\n\nLet the fields be single Fourier modes with real amplitudes,\n$$\n\\phi(x,y) \\;=\\; \\Phi_0 \\,\\cos(4x + 2y) \\, , \\qquad g(x,y) \\;=\\; G_0 \\,\\cos(3x + 5y) \\, ,\n$$\nwhere $\\Phi_0$ and $G_0$ are real constants. Because the DFT on a finite grid identifies sequences corresponding to wavenumbers that differ by integer multiples of $N_x$ and $N_y$ in the $x$ and $y$ directions respectively, quadratic products can produce aliasing, in which spectral energy at non-representable wavenumbers appears at different representable wavenumbers.\n\nStarting from the above definitions and the $E \\times B$ advection form of $J(\\phi,g)$, and working entirely from first principles of Fourier analysis and discrete sampling, carry out the following:\n\n1. Derive the exact continuous expression for $J(\\phi,g)$ in terms of trigonometric functions at the resulting wavevectors, and then express $J(\\phi,g)$ in complex-exponential form to identify its continuous Fourier coefficients.\n2. Using the $12 \\times 12$ grid sampling and the principal wavenumber set specified above, determine the complex Fourier coefficient $\\widehat{J}_{-5,-5}^{(\\mathrm{ps})}$ that the pseudospectral procedure produces at wavevector $\\big(-5,-5\\big)$ before any de-aliasing is applied. Your result must be an analytic expression in terms of $\\Phi_0$ and $G_0$.\n3. Apply the two-thirds de-aliasing rule by truncating the nonlinear term after its DFT: set $\\widehat{J}_{k_x,k_y}^{(2/3)} = 0$ whenever $|k_x| > N_x/3$ or $|k_y| > N_y/3$ (with $N_x/3 = N_y/3 = 4$ for this grid). Determine the de-aliased complex Fourier coefficient $\\widehat{J}_{-5,-5}^{(2/3)}$.\n\nYour final answer must be the pair of complex Fourier coefficients at $\\big(-5,-5\\big)$ before and after applying the two-thirds de-aliasing rule, arranged as a single row matrix. No numerical approximation is required; give exact symbolic expressions. If any rounding were required, it would need to be specified in significant figures, but it is not required here.",
            "solution": "The user-provided problem is valid as it is scientifically grounded, well-posed, objective, and contains all necessary information for a unique solution. The concepts of the $E \\times B$ nonlinearity, pseudospectral methods, and aliasing are standard in computational plasma physics. We proceed with a detailed solution.\n\nThe problem asks for the calculation of a specific Fourier coefficient of the nonlinear $E \\times B$ advection term, both with and without a de-aliasing procedure. The advection term is given by the Poisson bracket $J(\\phi,g) = \\partial_{x}\\phi\\,\\partial_{y}g - \\partial_{y}\\phi\\,\\partial_{x}g$.\n\nLet the given scalar fields be:\n$$ \\phi(x,y) = \\Phi_0 \\cos(4x + 2y) $$\n$$ g(x,y) = G_0 \\cos(3x + 5y) $$\n\n**Part 1: Exact Continuous Expression for $J(\\phi,g)$ and its Fourier Coefficients**\n\nFirst, we compute the spatial derivatives of $\\phi(x,y)$ and $g(x,y)$.\n$$ \\partial_{x}\\phi = -4\\Phi_0 \\sin(4x + 2y) $$\n$$ \\partial_{y}\\phi = -2\\Phi_0 \\sin(4x + 2y) $$\n$$ \\partial_{x}g = -3G_0 \\sin(3x + 5y) $$\n$$ \\partial_{y}g = -5G_0 \\sin(3x + 5y) $$\nNext, we substitute these into the expression for $J(\\phi,g)$:\n$$ J(\\phi,g) = (\\partial_{x}\\phi)(\\partial_{y}g) - (\\partial_{y}\\phi)(\\partial_{x}g) $$\n$$ J(\\phi,g) = \\big(-4\\Phi_0 \\sin(4x + 2y)\\big)\\big(-5G_0 \\sin(3x + 5y)\\big) - \\big(-2\\Phi_0 \\sin(4x + 2y)\\big)\\big(-3G_0 \\sin(3x + 5y)\\big) $$\n$$ J(\\phi,g) = 20\\Phi_0 G_0 \\sin(4x + 2y)\\sin(3x + 5y) - 6\\Phi_0 G_0 \\sin(4x + 2y)\\sin(3x + 5y) $$\n$$ J(\\phi,g) = 14\\Phi_0 G_0 \\sin(4x + 2y)\\sin(3x + 5y) $$\nTo identify the Fourier modes, we use the product-to-sum trigonometric identity $\\sin(A)\\sin(B) = \\frac{1}{2}[\\cos(A-B) - \\cos(A+B)]$. Let $A = 4x+2y$ and $B = 3x+5y$.\nThen $A-B = (4x+2y) - (3x+5y) = x - 3y$, and $A+B = (4x+2y) + (3x+5y) = 7x + 7y$.\nSubstituting this into the expression for $J(\\phi,g)$:\n$$ J(\\phi,g) = 14\\Phi_0 G_0 \\left( \\frac{1}{2}\\big[\\cos(x - 3y) - \\cos(7x + 7y)\\big] \\right) $$\n$$ J(\\phi,g) = 7\\Phi_0 G_0 \\big(\\cos(x - 3y) - \\cos(7x + 7y)\\big) $$\nThis is the exact continuous expression for $J(\\phi,g)$. To find its Fourier coefficients, we express it in complex-exponential form using $\\cos(\\theta) = \\frac{1}{2}(\\exp(i\\theta) + \\exp(-i\\theta))$.\n$$ J(x,y) = 7\\Phi_0 G_0 \\left( \\frac{\\exp(i(x - 3y)) + \\exp(-i(x - 3y))}{2} - \\frac{\\exp(i(7x + 7y)) + \\exp(-i(7x + 7y))}{2} \\right) $$\n$$ J(x,y) = \\frac{7}{2}\\Phi_0 G_0 \\exp(i(x - 3y)) + \\frac{7}{2}\\Phi_0 G_0 \\exp(-i(x - 3y)) - \\frac{7}{2}\\Phi_0 G_0 \\exp(i(7x + 7y)) - \\frac{7}{2}\\Phi_0 G_0 \\exp(-i(7x + 7y)) $$\nBy matching this to the Fourier series form $f(x,y) = \\sum_{k_x, k_y} \\hat{f}_{k_x, k_y} \\exp(i(k_x x + k_y y))$, we can identify the non-zero continuous Fourier coefficients $\\hat{J}_{k_x,k_y}$ for the wavevectors $\\mathbf{k} = (k_x, k_y)$:\n$$ \\hat{J}_{1,-3} = \\frac{7}{2}\\Phi_0 G_0 $$\n$$ \\hat{J}_{-1,3} = \\frac{7}{2}\\Phi_0 G_0 $$\n$$ \\hat{J}_{7,7} = -\\frac{7}{2}\\Phi_0 G_0 $$\n$$ \\hat{J}_{-7,-7} = -\\frac{7}{2}\\Phi_0 G_0 $$\nAll other continuous Fourier coefficients are zero.\n\n**Part 2: Pseudospectral Coefficient $\\widehat{J}_{-5,-5}^{(\\mathrm{ps})}}$**\n\nThe pseudospectral method involves transforming fields to a grid in real space, performing multiplications pointwise, and transforming the product back to spectral space. On a finite grid, this procedure can cause aliasing, where energy from non-representable high wavenumbers is incorrectly mapped to representable low wavenumbers.\n\nThe grid has $N_x=12$ and $N_y=12$ points. The set of representable wavenumbers is $k_x, k_y \\in \\{-6, -5, \\dots, 5\\}$. The nonlinear interaction of $\\phi$ (with modes at $\\mathbf{k}_\\phi = \\pm(4,2)$) and $g$ (with modes at $\\mathbf{k}_g = \\pm(3,5)$) generates sum and difference wavenumbers: $\\pm \\mathbf{k}_\\phi \\pm \\mathbf{k}_g$. These are $\\pm(7,7)$ and $\\pm(1,-3)$.\n\nLet's check which of these 'true' wavenumbers are representable on the grid:\n- $\\mathbf{k} = (1,-3)$: $k_x=1$ and $k_y=-3$ are both in the range $[-6,5]$. This mode is representable.\n- $\\mathbf{k} = (-1,3)$: $k_x=-1$ and $k_y=3$ are both in the range $[-6,5]$. This mode is representable.\n- $\\mathbf{k} = (7,7)$: $k_x=7$ and $k_y=7$ are outside the range $[-6,5]$. This mode is not representable and will be aliased.\n- $\\mathbf{k} = (-7,-7)$: $k_x=-7$ and $k_y=-7$ are outside the range $[-6,5]$. This mode is also not representable and will be aliased.\n\nA wavenumber $k$ aliases to a wavenumber $k'$ in the principal set if $k' = k + mN$ for some integer $m$, where $N$ is the number of grid points in that direction.\nFor $\\mathbf{k} = (7,7)$ and $N_x=N_y=12$:\n- $k_x = 7$: aliased wavenumber is $k_x' = 7 - 1 \\cdot 12 = -5$.\n- $k_y = 7$: aliased wavenumber is $k_y' = 7 - 1 \\cdot 12 = -5$.\nSo, the mode at $\\mathbf{k}=(7,7)$ aliases to $\\mathbf{k}_{alias} = (-5,-5)$.\n\nFor $\\mathbf{k} = (-7,-7)$:\n- $k_x = -7$: aliased wavenumber is $k_x' = -7 + 1 \\cdot 12 = 5$.\n- $k_y = -7$: aliased wavenumber is $k_y' = -7 + 1 \\cdot 12 = 5$.\nSo, the mode at $\\mathbf{k}=(-7,-7)$ aliases to $\\mathbf{k}_{alias} = (5,5)$.\n\nThe pseudospectral coefficient at a given wavevector $\\mathbf{k}$ on the grid, $\\widehat{J}_{\\mathbf{k}}^{(\\mathrm{ps})}$, is the sum of the true continuous coefficient at $\\mathbf{k}$ and all true coefficients from other wavenumbers that alias to $\\mathbf{k}$.\nWe are interested in the coefficient at $\\mathbf{k} = (-5,-5)$.\n$$ \\widehat{J}_{-5,-5}^{(\\mathrm{ps})} = \\hat{J}_{-5,-5} + \\hat{J}_{7,7} + \\hat{J}_{-17,-17} + \\dots $$\nFrom our analysis, the true coefficient $\\hat{J}_{-5,-5}$ is zero. The only non-zero true coefficient that aliases to $(-5,-5)$ is $\\hat{J}_{7,7}$.\nTherefore, the total pseudospectral coefficient at $(-5,-5)$ is equal to the true coefficient at $(7,7)$.\n$$ \\widehat{J}_{-5,-5}^{(\\mathrm{ps})} = \\hat{J}_{7,7} = -\\frac{7}{2}\\Phi_0 G_0 $$\n\n**Part 3: De-aliased Coefficient $\\widehat{J}_{-5,-5}^{(2/3)}$**\n\nThe problem specifies a de-aliasing procedure which consists of truncating the pseudospectrally computed nonlinear term. The rule is to set $\\widehat{J}_{k_x,k_y}^{(2/3)} = 0$ whenever $|k_x| > N_x/3$ or $|k_y| > N_y/3$.\nFor our grid, $N_x = N_y = 12$, so the truncation condition is $|k_x| > 4$ or $|k_y| > 4$.\n\nWe apply this rule to the coefficient at $\\mathbf{k} = (-5,-5)$. We check if this wavevector satisfies the truncation condition:\n- For $k_x = -5$, we have $|k_x| = |-5| = 5$. Since $5 > 4$, the condition $|k_x| > N_x/3$ is met.\n- For $k_y = -5$, we have $|k_y| = |-5| = 5$. Since $5 > 4$, the condition $|k_y| > N_y/3$ is also met.\n\nSince the wavevector $(-5,-5)$ satisfies the condition (it is sufficient that one component does), the corresponding coefficient in the de-aliased field must be set to zero.\n$$ \\widehat{J}_{-5,-5}^{(2/3)} = 0 $$\nThis procedure effectively filters out the aliased energy that appeared at $\\mathbf{k}=(-5,-5)$.\n\nThe final answer is the pair of coefficients $\\widehat{J}_{-5,-5}^{(\\mathrm{ps})}$ and $\\widehat{J}_{-5,-5}^{(2/3)}$.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n-\\frac{7}{2}\\Phi_0 G_0 & 0\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "Armed with an understanding of both the power and the potential pitfalls of spectral methods, we can now apply them to answer a central question in turbulence physics: how does the $E \\times B$ nonlinearity facilitate the transfer of energy across different scales? This final practice  integrates the preceding concepts by having you implement a pseudospectral calculation of the nonlinear energy transfer spectrum. This quantity is a critical diagnostic for visualizing and quantifying the turbulent cascade in plasma simulations.",
            "id": "4205469",
            "problem": "You are given a two-dimensional, periodic, electrostatic Gyrokinetic (GK) snapshot on a square domain. In normalized units, the perpendicular advection by the electric field $E$ across the magnetic field $B$ produces the nonlinear $E \\times B$ term. For a generalized field $g(x,y)$ that is advected by the incompressible velocity $v_E = \\hat{z} \\times \\nabla \\phi$, the nonlinear term in conservation form is the $x$-$y$ space Poisson bracket $\\{\\phi,g\\}$. You will define and compute the spectral nonlinear energy transfer $T(k_r,k_\\theta)$ derived from this bracket for specific snapshots, and then aggregate it in polar bins of wavenumber magnitude $k_r$ and polar angle $k_\\theta$.\n\nFundamental base to start from:\n- Periodic slab domain with $x \\in [0,2\\pi)$ and $y \\in [0,2\\pi)$.\n- The normalized, incompressible advection velocity is $v_E = \\hat{z} \\times \\nabla \\phi$, so the nonlinear term is the Poisson bracket\n$$\n\\{\\phi, g\\} = \\partial_x \\phi \\, \\partial_y g - \\partial_y \\phi \\, \\partial_x g.\n$$\n- The nonlinear energy transfer for a Fourier mode $(k_x,k_y)$ is to be inferred directly from the definition of the bracket, the real-space energy density, and the Fourier transform properties for periodic functions. You must use the Fast Fourier Transform (FFT) and periodic boundary conditions.\n\nYour program must compute the following for each test case:\n1. Use the provided analytic forms of $\\phi(x,y)$ and $g(x,y)$ to construct the fields on a uniform grid of size $N_x \\times N_y$ on $[0,2\\pi)\\times[0,2\\pi)$.\n2. Compute spatial derivatives of $\\phi$ and $g$ spectrally using the Fourier-space multiplication by $i k_x$ and $i k_y$.\n3. Construct the Poisson bracket field $\\{\\phi,g\\}(x,y)$ in real space and transform it back to Fourier space to obtain the nonlinear spectral content.\n4. Define the spectral nonlinear energy transfer density $T(k_x,k_y)$ for each Fourier mode using only the bracket and the field $g$ as implied by the conservation of the quadratic energy $\\frac{1}{2} \\sum_{k_x,k_y} |g_{k_x,k_y}|^2$ in the absence of sources and sinks, then aggregate $T$ into the polar bins $T(k_r,k_\\theta)$ by summing contributions from all $(k_x,k_y)$ whose magnitude and angle fall into the corresponding bin. Angles must be computed in radians.\n5. Apply the standard two-thirds de-aliasing rule by zeroing Fourier modes with $|k_x| > N_x/3$ or $|k_y| > N_y/3$ consistently for both fields before forming derivatives and also for the bracket’s spectrum, so that mode interactions remain within the resolved scales.\n6. For each test case, compute:\n   - The total summed nonlinear transfer across all spectral modes,\n   $$\n   S = \\sum_{k_x,k_y} T(k_x,k_y),\n   $$\n   which should reflect the incompressible nature of the advection.\n   - The maximum absolute value among the binned $T(k_r,k_\\theta)$,\n   $$\n   M = \\max_{r,\\theta} \\left| T(k_r,k_\\theta) \\right|.\n   $$\n   - The indices $(r_\\star,\\theta_\\star)$ of the bin where the maximum absolute value occurs, with $r_\\star$ an integer in $[0, N_r-1]$ and $\\theta_\\star$ an integer in $[0, N_\\theta-1]$.\n\nBinning details:\n- Use $N_r$ uniformly spaced radial bins covering $[0,k_{\\max}]$, where $k_{\\max} = \\max \\sqrt{k_x^2 + k_y^2}$ across the grid.\n- Use $N_\\theta$ uniformly spaced angular bins covering $[-\\pi,\\pi]$ in radians.\n- Assign $(k_x,k_y)$ to bins using standard half-open intervals except include the rightmost edge in the last bin. If a mode lies exactly on an edge, assign it to the upper bin except for the final edge, where it is assigned to the last bin.\n\nNumerical and unit conventions:\n- All quantities are dimensionless, consistent with the normalized GK slab and $2\\pi$ periodicity. Angles must be computed and binned in radians.\n- Use spectral differentiation via the Fourier transform on the periodic grid.\n- Use two-thirds de-aliasing as stated above.\n\nTest suite:\nFor each test case $i$, you are given $(N_x,N_y)$, amplitudes $A$ and $B$, analytic forms for $\\phi(x,y)$ and $g(x,y)$, and bin counts $(N_r,N_\\theta)$.\n- Case 1 (general interaction): $N_x=16$, $N_y=16$, $A=1.0$, $B=0.8$,\n  $$\n  \\phi(x,y) = A \\cos(2 x)\\cos(y), \\quad g(x,y) = B \\sin(x)\\sin(2 y),\n  $$\n  with $N_r=4$, $N_\\theta=4$.\n- Case 2 (anisotropic excitation): $N_x=32$, $N_y=16$, $A=0.9$, $B=0.7$,\n  $$\n  \\phi(x,y) = A\\left[\\cos(3 x) + 0.5\\cos(4 y)\\right], \\quad g(x,y) = B \\cos(3 x)\\sin(y),\n  $$\n  with $N_r=5$, $N_\\theta=8$.\n- Case 3 (self-bracket edge case): $N_x=8$, $N_y=8$, $A=1.0$, $B=1.0$,\n  $$\n  \\phi(x,y) = A \\sin(2 x)\\sin(3 y), \\quad g(x,y) = B \\sin(2 x)\\sin(3 y),\n  $$\n  with $N_r=3$, $N_\\theta=6$.\n\nFinal output format:\n- For each test case, return a list $[S, M, r_\\star, \\theta_\\star]$ where $S$ and $M$ are floating-point numbers rounded to $10$ decimal places, and $r_\\star$, $\\theta_\\star$ are integers.\n- Your program should produce a single line of output containing the results as a comma-separated list of these lists, enclosed in square brackets, for example:\n\"[ [S_1,M_1,r_1,theta_1], [S_2,M_2,r_2,theta_2], [S_3,M_3,r_3,theta_3] ]\".",
            "solution": "The user-provided problem statement is subjected to a rigorous validation process prior to attempting a solution.\n\n### Step 1: Extract Givens\n- **Domain:** Periodic slab, $x \\in [0,2\\pi)$, $y \\in [0,2\\pi)$.\n- **Advection Velocity:** Incompressible $E \\times B$ velocity, $v_E = \\hat{z} \\times \\nabla \\phi$.\n- **Nonlinear Term:** Poisson bracket in $x-y$ space, $\\{\\phi, g\\} = \\partial_x \\phi \\, \\partial_y g - \\partial_y \\phi \\, \\partial_x g$.\n- **Task:** Compute the spectral nonlinear energy transfer $T(k_r,k_\\theta)$, aggregated in polar bins.\n- **Numerical Grid:** Uniform grid of size $N_x \\times N_y$.\n- **Numerical Method:**\n    - Spatial derivatives computed spectrally ($i k_x$, $i k_y$ multiplication in Fourier space).\n    - Pseudospectral method for the Poisson bracket.\n    - Two-thirds de-aliasing rule: zeroing Fourier modes with $|k_x| > N_x/3$ or $|k_y| > N_y/3$.\n- **Energy Transfer Definition:** Inferred from the conservation of quadratic energy $\\frac{1}{2} \\sum_{k_x,k_y} |g_{k_x,k_y}|^2$.\n- **Binning:**\n    - $N_r$ uniform radial bins on $[0,k_{\\max}]$, where $k_{\\max} = \\max \\sqrt{k_x^2 + k_y^2}$.\n    - $N_\\theta$ uniform angular bins on $[-\\pi,\\pi]$.\n    - Binning Rule: Assign to the upper bin on edges, except the final edge value is included in the last bin.\n- **Outputs per Case:**\n    1.  Total summed transfer, $S = \\sum_{k_x,k_y} T(k_x,k_y)$.\n    2.  Maximum absolute binned transfer, $M = \\max_{r,\\theta} \\left| T(k_r,k_\\theta) \\right|$.\n    3.  Indices of the max bin, $(r_\\star, \\theta_\\star)$.\n- **Test Cases:**\n    - **Case 1:** $N_x=16, N_y=16, A=1.0, B=0.8, \\phi(x,y) = A \\cos(2 x)\\cos(y), g(x,y) = B \\sin(x)\\sin(2 y), N_r=4, N_\\theta=4$.\n    - **Case 2:** $N_x=32, N_y=16, A=0.9, B=0.7, \\phi(x,y) = A[\\cos(3 x) + 0.5\\cos(4 y)], g(x,y) = B \\cos(3 x)\\sin(y), N_r=5, N_theta=8$.\n    - **Case 3:** $N_x=8, N_y=8, A=1.0, B=1.0, \\phi(x,y) = A \\sin(2 x)\\sin(3 y), g(x,y) = B \\sin(2 x)\\sin(3 y), N_r=3, N_\\theta=6$.\n\n### Step 2: Validate Using Extracted Givens\n- **Scientific Grounding:** The problem is fundamentally sound. It addresses the computation of the nonlinear energy transfer via the $E \\times B$ advection term, cast as a Poisson bracket. This is a canonical problem in the study of two-dimensional fluid and plasma turbulence, particularly within the framework of gyrokinetics. The specified methods—pseudospectral evaluation, spectral differentiation, and the two-thirds de-aliasing rule—are standard and rigorous techniques for this class of problem.\n- **Well-Posedness:** The problem is well-posed. All inputs, including grid parameters, field definitions, and binning specifications, are explicitly provided. The desired outputs are precisely defined mathematical quantities derived from these inputs. The procedure is algorithmic and deterministic, guaranteeing a unique solution.\n- **Objectivity:** The problem is stated in objective, formal language, using standard terminology from physics and numerical analysis. It is free from subjective or ambiguous statements.\n- **Flaw Analysis:**\n    - No scientific or factual unsoundness is present. The underlying physics of incompressible advection and energy conservation are correctly represented.\n    - The problem is directly relevant to fusion plasma turbulence simulation and is entirely formalizable.\n    - The setup is complete and internally consistent.\n    - The parameters are chosen for a numerically tractable problem and are physically plausible as modes in a turbulent system.\n    - The problem structure is clear and leads to a unique, stable solution.\n    - The problem is a non-trivial exercise in computational physics, requiring correct implementation of several standard algorithms. The inclusion of the $\\{\\phi,\\phi\\}=0$ edge case (Case 3) demonstrates conceptual depth.\n    - The results are computationally verifiable.\n\n### Step 3: Verdict and Action\nThe problem is deemed **valid**. A solution will be developed based on the principles of spectral methods in fluid dynamics.\n\n### Solution Design\n\nThe solution will be constructed based on the following principles.\n\n**1. Governing Equation and Energy Conservation**\nThe evolution of the scalar field $g$ under advection by the velocity field $v_E$ is given by the continuity equation:\n$$\n\\frac{\\partial g}{\\partial t} + \\nabla \\cdot (g v_E) = 0\n$$\nGiven that the velocity is incompressible, $\\nabla \\cdot v_E = 0$, this simplifies to:\n$$\n\\frac{\\partial g}{\\partial t} + v_E \\cdot \\nabla g = 0\n$$\nSubstituting $v_E = \\hat{z} \\times \\nabla \\phi = (\\partial_y \\phi, -\\partial_x \\phi, 0)$, the advection term becomes:\n$$\nv_E \\cdot \\nabla g = (\\partial_y \\phi)(\\partial_x g) - (\\partial_x \\phi)(\\partial_y g) = -\\{\\phi, g\\}\n$$\nThus, the governing dynamics are described by:\n$$\n\\frac{\\partial g}{\\partial t} - \\{\\phi, g\\} = 0\n$$\nThe total energy, defined as $E_{total} = \\frac{1}{2} \\int g^2 \\,dx\\,dy$ over the domain, is conserved. Its time derivative is:\n$$\n\\frac{dE_{total}}{dt} = \\int g \\frac{\\partial g}{\\partial t} \\,dx\\,dy = \\int g \\{\\phi, g\\} \\,dx\\,dy\n$$\nUsing integration by parts and the periodic boundary conditions, it can be shown that $\\int g \\{\\phi, g\\} \\,dx\\,dy = 0$. This implies that the total energy is constant, and any energy lost from some modes must be gained by others. Consequently, the sum of the spectral energy transfer over all modes must be zero, $S = \\sum_{k_x,k_y} T(k_x,k_y) = 0$. This serves as a critical validation for the numerical implementation.\n\n**2. Spectral Representation and Pseudospectral Method**\nWe represent the fields on the discrete grid using a discrete Fourier series. The Fourier transform $\\mathcal{F}$ of a function $f(x,y)$ is denoted $\\hat{f}(k_x, k_y)$. The key property for spectral differentiation is $\\mathcal{F}\\{\\partial_x f\\} = i k_x \\hat{f}$ and $\\mathcal{F}\\{\\partial_y f\\} = i k_y \\hat{f}$, where $k_x$ and $k_y$ are the integer wavenumbers corresponding to the periodic domain of size $2\\pi \\times 2\\pi$.\n\nThe Poisson bracket $\\{\\phi,g\\}$ involves products of fields. A direct evaluation in Fourier space would require expensive convolutions. The pseudospectral method is more efficient:\n1.  Compute the Fourier transforms $\\hat{\\phi}$ and $\\hat{g}$.\n2.  Calculate the spectra of the derivatives, e.g., $\\widehat{\\partial_x \\phi} = i k_x \\hat{\\phi}$.\n3.  Inverse transform back to real space to obtain the derivatives, e.g., $\\partial_x \\phi = \\mathcal{F}^{-1}\\{i k_x \\hat{\\phi}\\}$.\n4.  Perform the multiplications and subtraction in real space: $\\{\\phi,g\\}(x,y) = (\\partial_x \\phi)(\\partial_y g) - (\\partial_y \\phi)(\\partial_x g)$.\n5.  Fourier transform the resulting field to get its spectrum, $\\widehat{\\{\\phi,g\\}}$.\n\n**3. De-aliasing**\nThe products in real space can lead to aliasing errors, where high-frequency content generated by the product is incorrectly represented as a lower frequency on the discrete grid. The two-thirds de-aliasing rule mitigates this. We define a filter that zeroes out all Fourier modes $(k_x, k_y)$ for which $|k_x| > N_x/3$ or $|k_y| > N_y/3$. This filter is applied to the spectra of $\\phi$ and $g$ before computing their derivatives, and also to the final spectrum of the Poisson bracket, ensuring that all nonlinear interactions are resolved without aliasing.\n\n**4. Spectral Energy Transfer**\nThe evolution equation in Fourier space is $\\frac{\\partial \\hat{g}_k}{\\partial t} = \\widehat{\\{\\phi,g\\}}_k$, where $k$ is shorthand for the pair $(k_x, k_y)$. The energy in a specific mode $k$ is $E_k \\propto |\\hat{g}_k|^2$. Its rate of change defines the spectral energy transfer $T_k$:\n$$\nT_k = \\frac{d}{dt} \\left(\\frac{1}{2} |\\hat{g}_k|^2\\right) = \\frac{1}{2} \\left( \\hat{g}_k^* \\frac{\\partial \\hat{g}_k}{\\partial t} + \\frac{\\partial \\hat{g}_k^*}{\\partial t} \\hat{g}_k \\right) = \\text{Re}\\left(\\hat{g}_k^* \\frac{\\partial \\hat{g}_k}{\\partial t}\\right)\n$$\nSubstituting the evolution equation, we arrive at the computational formula for the spectral transfer into mode $k$ of field $g$:\n$$\nT(k_x, k_y) = \\text{Re}\\left( \\hat{g}_{k_x,k_y}^* \\cdot \\widehat{\\{\\phi,g\\}}_{k_x,k_y} \\right)\n$$\nwhere the de-aliased versions of the spectra must be used for consistency.\n\n**5. Implementation Algorithm**\nThe final algorithm synthesizes these principles:\n1.  **Initialization:** Construct the spatial and wavenumber grids for the given $N_x, N_y$.\n2.  **Field Generation:** Evaluate the analytic forms for $\\phi(x,y)$ and $g(x,y)$ on the spatial grid.\n3.  **Spectral Transformation:** Compute $\\hat{\\phi} = \\text{FFT}(\\phi)$ and $\\hat{g} = \\text{FFT}(g)$.\n4.  **De-aliasing:** Create a low-pass filter mask based on the two-thirds rule and apply it to $\\hat{\\phi}$ and $\\hat{g}$.\n5.  **Derivative Calculation:** Compute the spectra of all four required spatial derivatives using the de-aliased fields and inverse transform to get the derivatives in real space.\n6.  **Bracket Calculation:** Compute the Poisson bracket $\\{\\phi,g\\}$ in real space, then transform to Fourier space to obtain $\\widehat{\\{\\phi,g\\}}$. Apply the de-aliasing mask again for consistency.\n7.  **Transfer Spectrum:** Compute $T(k_x,k_y)$ for all modes using the de-aliased $\\hat{g}$ and de-aliased $\\widehat{\\{\\phi,g\\}}$.\n8.  **Aggregation:** Calculate the total transfer $S = \\sum_k T_k$.\n9.  **Binning:**\n    - For each mode $(k_x, k_y)$, compute its polar coordinates $(k_r, k_\\theta)$.\n    - Determine the radial and angular bin edges.\n    - Use `np.digitize` to find the bin index for each mode's $k_r$ and $k_\\theta$. Handle boundary conditions as specified.\n    - Sum the $T(k_x, k_y)$ values into the appropriate $(r, \\theta)$ bin of a 2D accumulator array.\n10. **Final Metrics:** From the binned transfer data, find the maximum absolute value $M$ and its bin indices $(r_\\star, \\theta_\\star)$.\n11. **Output:** Format the results $[S, M, r_\\star, \\theta_\\star]$ as required for each test case.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import __version__ as scipy_version  # Used only for complying with problem spec on libraries\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases for nonlinear spectral energy transfer.\n    \"\"\"\n\n    def compute_transfer(case):\n        \"\"\"\n        Computes the nonlinear transfer for a single test case.\n        \"\"\"\n        Nx, Ny, A, B, phi_func, g_func, Nr, Ntheta = case\n\n        # 1. Grid and Field Setup\n        x = np.linspace(0, 2 * np.pi, Nx, endpoint=False)\n        y = np.linspace(0, 2 * np.pi, Ny, endpoint=False)\n        xx, yy = np.meshgrid(x, y, indexing='ij')\n\n        phi = phi_func(xx, yy, A)\n        g = g_func(xx, yy, B)\n\n        # 2. Wavenumber Grids\n        kx = np.fft.fftfreq(Nx) * Nx\n        ky = np.fft.fftfreq(Ny) * Ny\n        kxx, kyy = np.meshgrid(kx, ky, indexing='ij')\n\n        # 3. FFTs of the fields\n        phi_k = np.fft.fft2(phi)\n        g_k = np.fft.fft2(g)\n\n        # 4. De-aliasing (2/3 rule)\n        k_max_x_dealias = Nx / 3.0\n        k_max_y_dealias = Ny / 3.0\n        dealias_mask = (np.abs(kxx) <= k_max_x_dealias) & (np.abs(kyy) <= k_max_y_dealias)\n        \n        phi_k_dealiased = phi_k * dealias_mask\n        g_k_dealiased = g_k * dealias_mask\n\n        # 5. Spectral Derivatives\n        dphi_dx_k = 1j * kxx * phi_k_dealiased\n        dphi_dy_k = 1j * kyy * phi_k_dealiased\n        dg_dx_k = 1j * kxx * g_k_dealiased\n        dg_dy_k = 1j * kyy * g_k_dealiased\n\n        # 6. Inverse FFT to get real-space derivatives\n        dphi_dx = np.fft.ifft2(dphi_dx_k).real\n        dphi_dy = np.fft.ifft2(dphi_dy_k).real\n        dg_dx = np.fft.ifft2(dg_dx_k).real\n        dg_dy = np.fft.ifft2(dg_dy_k).real\n\n        # 7. Poisson Bracket\n        poisson_bracket = dphi_dx * dg_dy - dphi_dy * dg_dx\n\n        # 8. Spectrum of the bracket\n        poisson_bracket_k = np.fft.fft2(poisson_bracket)\n        poisson_bracket_k_dealiased = poisson_bracket_k * dealias_mask\n\n        # 9. Spectral Energy Transfer T(k_x, k_y)\n        T_k = np.real(np.conj(g_k_dealiased) * poisson_bracket_k_dealiased)\n\n        # 10. Total Transfer S\n        S = np.sum(T_k)\n\n        # 11. Binning\n        kr = np.sqrt(kxx**2 + kyy**2)\n        ktheta = np.arctan2(kyy, kxx)\n\n        # Flatten arrays for easier indexing\n        T_k_flat = T_k.flatten()\n        kr_flat = kr.flatten()\n        ktheta_flat = ktheta.flatten()\n\n        k_max_val = np.max(kr_flat)\n        \n        # Define bin edges. k_max_val=0 is a special case.\n        if k_max_val > 0:\n            r_bins = np.linspace(0, k_max_val, Nr + 1)\n        else: # Handle case of zero field\n            r_bins = np.zeros(Nr + 1)\n            \n        theta_bins = np.linspace(-np.pi, np.pi, Ntheta + 1)\n        \n        # Get bin indices for each k-mode\n        r_indices = np.digitize(kr_flat, r_bins) - 1\n        theta_indices = np.digitize(ktheta_flat, theta_bins) - 1\n\n        # Clip indices to be within [0, N-1] to handle edges correctly\n        # The specified rule puts values on the last edge into the last bin.\n        # np.digitize puts x=bins[-1] into bin N, so clipping to N-1 is correct.\n        r_indices = np.clip(r_indices, 0, Nr - 1)\n        theta_indices = np.clip(theta_indices, 0, Ntheta - 1)\n\n        # Sum T_k into the polar bins\n        T_binned = np.zeros((Nr, Ntheta))\n        np.add.at(T_binned, (r_indices, theta_indices), T_k_flat)\n\n        # 12. Find max absolute value and its indices\n        abs_T_binned = np.abs(T_binned)\n        M = np.max(abs_T_binned)\n        \n        # np.argmax returns the first occurrence in case of ties.\n        max_loc_flat = np.argmax(abs_T_binned)\n        r_star, theta_star = np.unravel_index(max_loc_flat, abs_T_binned.shape)\n\n        return [round(S, 10), round(M, 10), int(r_star), int(theta_star)]\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (16, 16, 1.0, 0.8,\n         lambda x, y, A: A * np.cos(2 * x) * np.cos(y),\n         lambda x, y, B: B * np.sin(x) * np.sin(2 * y),\n         4, 4),\n\n        (32, 16, 0.9, 0.7,\n         lambda x, y, A: A * (np.cos(3 * x) + 0.5 * np.cos(4 * y)),\n         lambda x, y, B: B * np.cos(3 * x) * np.sin(y),\n         5, 8),\n\n        (8, 8, 1.0, 1.0,\n         lambda x, y, A: A * np.sin(2 * x) * np.sin(3 * y),\n         lambda x, y, B: B * np.sin(2 * x) * np.sin(3 * y),\n         3, 6)\n    ]\n\n    results = []\n    for case in test_cases:\n        result = compute_transfer(case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\".replace(\" \", \"\"))\n\nsolve()\n\n```"
        }
    ]
}