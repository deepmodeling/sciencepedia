{
    "hands_on_practices": [
        {
            "introduction": "在深入研究复杂的数值模拟之前，建立对简化模型解析解的深刻理解至关重要。这些解析解不仅为我们的物理直觉提供了基础，也为验证更复杂的数值代码提供了宝贵的基准。这项练习  探讨了最基础的一维动力学平衡问题，要求您推导在一个具有恒定源和线性汇的系统中，粒子分布函数的稳态解析解。通过求解这个经典问题，您将亲身体验粒子自由流动、源项和汇项之间如何达到平衡，以及边界条件如何唯一地确定最终的分布形态。",
            "id": "4196643",
            "problem": "考虑一个一维板模型，用于对磁化聚变等离子体进行全分布函数（full-$f$）动理学模拟。该模型沿着与磁场对齐的直角坐标 $x \\in [0,L]$ 展开。全分布函数 $f(x)$ 表示具有固定平行速度 $v>0$（单能近似）并沿 $+x$ 方向流动的导向中心的相空间密度。在稳态下，$f(x)$ 的演化由平行自由流、空间均匀的粒子源以及一个模拟材料边界损失或有效碰撞吸收的线性汇之间的平衡所决定。从动理学平流-源-汇平衡方程出发\n$$\n\\frac{\\partial f}{\\partial t} + v \\frac{\\partial f}{\\partial x} = S(x) - \\Sigma(f,x),\n$$\n假设稳态 $\\partial f/\\partial t=0$，一个常数源 $S(x)=S_0$（其中 $S_0 \\ge 0$），以及一个线性汇 $\\Sigma(f,x) = \\alpha f$（其中 $\\alpha>0$，例如，Bhatnagar–Gross–Krook (BGK) 型向零的弛豫）。该区域在 $x=0$ 处有一个适用于右行特征线的入流边界条件，\n$$\nf(0) = f_{\\mathrm{in}},\n$$\n给定 $f_{\\mathrm{in}} \\ge 0$，并在 $x=L$ 处有一个自由出流（对于 $v>0$ 的情况，在 $x=L$ 处不施加额外的边界约束）。\n\n请使用上述基本动理学平衡和适当的特征线边界布局，从第一性原理推导稳态解析解 $f(x)$。然后验证您的解满足 $x=0$ 处的入流边界条件，并且在物理上是可接受的（在 $S_0 \\ge 0$、$\\alpha>0$、$f_{\\mathrm{in}} \\ge 0$ 的条件下有界且非负）。请将最终答案表示为 $f(x)$ 的单个闭式解析表达式。无需四舍五入，最终表达式中不应包含单位。",
            "solution": "在尝试求解之前，对问题陈述进行验证。\n\n### 步骤 1：提取已知条件\n- **控制方程：** 时变动理学方程为 $\\frac{\\partial f}{\\partial t} + v \\frac{\\partial f}{\\partial x} = S(x) - \\Sigma(f,x)$。\n- **区域：** 空间区域为一维板，$x \\in [0,L]$。\n- **粒子速度：** 粒子是单能的，具有固定的平行速度 $v > 0$，并沿 $x$ 正方向流动。\n- **稳态：** 系统处于稳态，因此 $\\frac{\\partial f}{\\partial t} = 0$。\n- **源项：** 粒子源是空间均匀的，$S(x) = S_0$，其中 $S_0 \\ge 0$。\n- **汇项：** 粒子汇是线性的，$\\Sigma(f,x) = \\alpha f$，其中 $\\alpha > 0$。\n- **入流边界条件：** 入流边界 $x=0$ 处的分布函数指定为 $f(0) = f_{\\mathrm{in}}$，其中 $f_{\\mathrm{in}} \\ge 0$。\n- **出流条件：** 在 $x=L$ 处假设为自由出流条件，对于 $v>0$ 的粒子，这意味着在此边界上不施加约束。\n\n### 步骤 2：使用提取的已知条件进行验证\n根据已建立的有效性标准对问题进行评估。\n\n- **科学基础：** 该问题基于一维稳态动理学输运方程。这是输运理论和等离子体物理学中的一个基本方程。源项（$S_0$）和汇项（$\\alpha f$）是标准的简化模型（例如，BGK 型碰撞算子弛豫到零背景），用于表示粒子源和损失。该模型在物理上和数学上都是合理的。\n- **适定性：** 在稳态下，控制偏微分方程简化为关于空间坐标 $x$ 的一阶常微分方程。一个一阶常微分方程需要一个边界条件才能得到唯一解。该问题恰好提供了一个边界条件，$f(0) = f_{\\mathrm{in}}$。由于方程 $v \\frac{df}{dx} = \\dots$ 的特征线沿 $x$ 增大的方向传播（因为 $v>0$），边界条件必须在入流边界 $x=0$ 处指定。该问题正确地做到了这一点。因此，该问题是适定的。\n- **客观性：** 问题以精确的数学和物理术语陈述，没有歧义或主观语言。\n\n### 步骤 3：结论与行动\n该问题具有科学基础，是适定且客观的。它没有矛盾、信息缺失或其他缺陷。因此，该问题被判定为 **有效的**。现在将推导求解过程。\n\n起点是给定的动理学方程：\n$$\n\\frac{\\partial f}{\\partial t} + v \\frac{\\partial f}{\\partial x} = S(x) - \\Sigma(f,x)\n$$\n应用稳态条件 $\\frac{\\partial f}{\\partial t} = 0$，并代入给定的源项 $S(x) = S_0$ 和汇项 $\\Sigma(f,x) = \\alpha f$ 的形式，我们得到分布函数 $f(x)$ 的稳态方程：\n$$\nv \\frac{df}{dx} = S_0 - \\alpha f\n$$\n这是一个一阶线性常微分方程。为了求解它，我们将其重排为标准形式 $\\frac{dy}{dx} + P(x)y = Q(x)$：\n$$\nv \\frac{df}{dx} + \\alpha f = S_0\n$$\n除以恒定速度 $v$（因为 $v>0$），我们得到：\n$$\n\\frac{df}{dx} + \\frac{\\alpha}{v} f = \\frac{S_0}{v}\n$$\n这个方程可以用积分因子法求解。积分因子 $I(x)$ 由下式给出：\n$$\nI(x) = \\exp\\left(\\int \\frac{\\alpha}{v} dx\\right) = \\exp\\left(\\frac{\\alpha x}{v}\\right)\n$$\n将微分方程乘以积分因子 $I(x)$，得到：\n$$\n\\exp\\left(\\frac{\\alpha x}{v}\\right) \\frac{df}{dx} + \\frac{\\alpha}{v} \\exp\\left(\\frac{\\alpha x}{v}\\right) f = \\frac{S_0}{v} \\exp\\left(\\frac{\\alpha x}{v}\\right)\n$$\n根据乘积法则，左边是乘积 $f(x)I(x)$ 的导数：\n$$\n\\frac{d}{dx}\\left[f(x) \\exp\\left(\\frac{\\alpha x}{v}\\right)\\right] = \\frac{S_0}{v} \\exp\\left(\\frac{\\alpha x}{v}\\right)\n$$\n我们对两边关于 $x$ 积分以求得通解：\n$$\n\\int \\frac{d}{dx}\\left[f(x) \\exp\\left(\\frac{\\alpha x}{v}\\right)\\right] dx = \\int \\frac{S_0}{v} \\exp\\left(\\frac{\\alpha x}{v}\\right) dx\n$$\n$$\nf(x) \\exp\\left(\\frac{\\alpha x}{v}\\right) = \\frac{S_0}{v} \\left(\\frac{v}{\\alpha}\\right) \\exp\\left(\\frac{\\alpha x}{v}\\right) + C\n$$\n其中 $C$ 是积分常数。简化此表达式得到：\n$$\nf(x) \\exp\\left(\\frac{\\alpha x}{v}\\right) = \\frac{S_0}{\\alpha} \\exp\\left(\\frac{\\alpha x}{v}\\right) + C\n$$\n为了得到 $f(x)$，我们乘以 $\\exp\\left(-\\frac{\\alpha x}{v}\\right)$：\n$$\nf(x) = \\frac{S_0}{\\alpha} + C \\exp\\left(-\\frac{\\alpha x}{v}\\right)\n$$\n这是该常微分方程的通解。常数 $C$ 由入流边界条件 $f(0) = f_{\\mathrm{in}}$ 决定。我们在 $x=0$ 处计算通解的值：\n$$\nf(0) = \\frac{S_0}{\\alpha} + C \\exp(0) = \\frac{S_0}{\\alpha} + C\n$$\n将其设为等于给定的边界值 $f_{\\mathrm{in}}$：\n$$\nf_{\\mathrm{in}} = \\frac{S_0}{\\alpha} + C\n$$\n求解 $C$：\n$$\nC = f_{\\mathrm{in}} - \\frac{S_0}{\\alpha}\n$$\n将 $C$ 的表达式代回通解，得到 $f(x)$ 的唯一特解：\n$$\nf(x) = \\frac{S_0}{\\alpha} + \\left(f_{\\mathrm{in}} - \\frac{S_0}{\\alpha}\\right) \\exp\\left(-\\frac{\\alpha x}{v}\\right)\n$$\n这就是最终的解析解。\n\n最后，我们验证该解在物理上是可接受的。\n首先，我们检查 $x=0$ 处的边界条件：\n$$\nf(0) = \\frac{S_0}{\\alpha} + \\left(f_{\\mathrm{in}} - \\frac{S_0}{\\alpha}\\right) \\exp(0) = \\frac{S_0}{\\alpha} + f_{\\mathrm{in}} - \\frac{S_0}{\\alpha} = f_{\\mathrm{in}}\n$$\n入流边界条件得到满足。\n\n其次，我们检查非负性，即在约束条件 $S_0 \\ge 0$、$f_{\\mathrm{in}} \\ge 0$、$\\alpha > 0$ 和 $v > 0$ 下，对于所有 $x \\in [0, L]$ 是否有 $f(x) \\ge 0$。我们可以将解重写为：\n$$\nf(x) = \\frac{S_0}{\\alpha} \\left(1 - \\exp\\left(-\\frac{\\alpha x}{v}\\right)\\right) + f_{\\mathrm{in}} \\exp\\left(-\\frac{\\alpha x}{v}\\right)\n$$\n对于 $x \\ge 0$，我们有 $\\frac{\\alpha x}{v} \\ge 0$。因此，$0 < \\exp\\left(-\\frac{\\alpha x}{v}\\right) \\le 1$。\n所以项 $\\left(1 - \\exp\\left(-\\frac{\\alpha x}{v}\\right)\\right)$ 的界限在 0（在 $x=0$ 处）和 1（当 $x \\to \\infty$ 时）之间，因此它总是非负的。\n因为 $S_0 \\ge 0$ 和 $\\alpha > 0$，第一项 $\\frac{S_0}{\\alpha} \\left(1 - \\exp\\left(-\\frac{\\alpha x}{v}\\right)\\right)$ 是非负的。\n因为 $f_{\\mathrm{in}} \\ge 0$ 和 $\\exp\\left(-\\frac{\\alpha x}{v}\\right) > 0$，第二项 $f_{\\mathrm{in}} \\exp\\left(-\\frac{\\alpha x}{v}\\right)$ 也是非负的。\n两个非负项之和是非负的，所以对于所有 $x \\ge 0$，$f(x) \\ge 0$。该解在区域 $[0,L]$ 上是物理上可接受且有界的。\n该解代表一种平衡：分布函数从 $f_{\\mathrm{in}}$ 开始，在长度尺度 $v/\\alpha$ 上演化，趋向于平衡值 $S_0/\\alpha$，该值是局部平衡源和汇的值（$S_0 - \\alpha f = 0$）。",
            "answer": "$$\n\\boxed{\\frac{S_0}{\\alpha} + \\left(f_{\\mathrm{in}} - \\frac{S_0}{\\alpha}\\right) \\exp\\left(-\\frac{\\alpha x}{v}\\right)}\n$$"
        },
        {
            "introduction": "从连续的解析世界过渡到离散的数值模拟时，一个核心挑战是确保数值解始终遵守物理约束。例如，作为概率密度的分布函数 $f$ 必须保持非负性。然而，简单的显式时间推进格式，如前向欧拉法，可能会在某些条件下产生非物理的负值。这项练习  直面这一基本数值问题，要求您从第一性原理出发，为源项和汇项的更新推导并实现一个保持正定性的限制器。这种技术是确保全-$f$模拟稳定性和物理真实性的关键组成部分。",
            "id": "4196640",
            "problem": "您正在对聚变等离子体的全分布函数（full-f）模拟中由源项和线性汇项引起的单步更新进行建模。考虑在离散时间索引 $n$ 处具有非负分布函数值 $f^n \\ge 0$ 的单个相空间点。在大小为 $\\Delta t$ 的一个时间步长内，源项 $S$（可正可负）和系数为 $\\alpha \\ge 0$ 的线性汇项的影响通过显式前向欧拉更新进行建模：\n$$\nf^{n+1} \\;=\\; f^n \\;+\\; \\Delta t\\,\\big(S \\;-\\; \\alpha f^n\\big)\n\\;=\\; \\big(1 - \\alpha \\Delta t\\big)\\,f^n \\;+\\; \\Delta t\\,S.\n$$\n所有量均为无量纲。在算子分裂的背景下，您将实现一个局部的、逐点的保正限制器，该限制器在应用前仅修改源的幅值，以使得当 $f^n \\ge 0$ 时，总有 $f^{n+1} \\ge 0$。该限制器必须基于第一性原理进行设计，且不得依赖于对 $f^n$ 或 $\\alpha$ 的非物理调整。假设线性汇项的库朗数满足 $0 \\le \\alpha \\Delta t \\le 1$。\n\n您的任务是：\n1) 从第一性原理出发，推导一个充分条件（表示为对有效源幅值的界限），该条件在给定 $f^n \\ge 0$ 和 $0 \\le \\alpha \\Delta t \\le 1$ 的情况下，保证 $f^{n+1} \\ge 0$。您的推导必须从上述显式前向欧拉公式开始，并且除了您所设计的限制器之外，不得对 $S$ 假设任何未强制执行的约束。解释为什么该条件在数学上足以确保 $f^{n+1} \\ge 0$。\n2) 设计一个局部限制器，通过在更新 $f$ 之前仅修改源幅值 $S$ 来强制执行您推导出的条件。该限制器必须逐点作用，如果 $S$ 已经满足该界限，则不得增加 $S$ 的值，并且必须在满足条件的最小必要改变的意义上对 $S$ 进行最小化修改。证明对于任何 $f^n \\ge 0$ 和 $0 \\le \\alpha \\Delta t \\le 1$，您的限制器都满足第 1 部分的条件。\n3) 实现一个程序，该程序：\n   - 定义一个函数，该函数接受 $(f^n,\\alpha,\\Delta t,S)$ 作为输入，并使用您的限制器返回更新后的值 $f^{n+1}$。\n   - 将此函数应用于一组参数测试集，并生成单行输出，其中包含所得的 $f^{n+1}$ 值列表，每个值都四舍五入到六位小数。\n\n使用以下测试集，该测试集涵盖了代表性的“理想路径”情况、边界情况和重要的边缘情况。所有量均为无量纲且满足 $0 \\le \\alpha \\Delta t \\le 1$：\n- 测试 A：$f^n = 1.0$，$\\alpha = 0.3$，$\\Delta t = 1.0$，$S = -0.5$。\n- 测试 B：$f^n = 0.2$，$\\alpha = 0.2$，$\\Delta t = 1.0$，$S = -0.16$。\n- 测试 C：$f^n = 0.1$，$\\alpha = 0.4$，$\\Delta t = 1.0$，$S = -0.3$。\n- 测试 D：$f^n = 5.0$，$\\alpha = 1.0$，$\\Delta t = 1.0$，$S = -1.0$。\n- 测试 E：$f^n = 0.0$，$\\alpha = 0.6$，$\\Delta t = 1.0$，$S = -10.0$。\n- 测试 F：$f^n = 0.7$，$\\alpha = 0.5$，$\\Delta t = 0.5$，$S = 0.4$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果（例如，\"[x,y,z]\"），每个 $f^{n+1}$ 值都四舍五入到六位小数。",
            "solution": "该问题要求针对分布函数 $f$ 的前向欧拉更新，推导、设计并实现一个保正限制器。该更新模拟了在一个时间步长 $\\Delta t$ 内，源项 $S$ 和线性汇项 $\\alpha$ 的影响。\n\n更新的控制方程为：\n$$f^{n+1} = f^n + \\Delta t (S - \\alpha f^n) = (1 - \\alpha \\Delta t) f^n + \\Delta t S$$\n给定以下条件：初始分布函数值非负，即 $f^n \\ge 0$；汇项系数非负，即 $\\alpha \\ge 0$；线性汇项的库朗数满足 $0 \\le \\alpha \\Delta t \\le 1$。任务是通过仅修改源幅值 $S$ 来确保更新后的值也非负，即 $f^{n+1} \\ge 0$。我们将假设时间步长非零，即 $\\Delta t > 0$，因为零时间步长意味着没有演化。\n\n首先，我们推导一个关于 $S$ 的充分条件，以保证 $f^{n+1} \\ge 0$。要求是：\n$$f^{n+1} \\ge 0$$\n代入更新公式，我们得到：\n$$(1 - \\alpha \\Delta t) f^n + \\Delta t S \\ge 0$$\n我们来分析第一项 $(1 - \\alpha \\Delta t) f^n$。问题陈述提供了两个关键约束：$f^n \\ge 0$ 和 $0 \\le \\alpha \\Delta t \\le 1$。第二个约束意味着因子 $(1 - \\alpha \\Delta t)$ 的取值范围在 0 和 1 之间：\n$$0 \\le \\alpha \\Delta t \\le 1 \\implies -1 \\le -\\alpha \\Delta t \\le 0 \\implies 0 \\le 1 - \\alpha \\Delta t \\le 1$$\n由于 $(1 - \\alpha \\Delta t)$ 和 $f^n$ 均为非负，它们的乘积也非负：\n$$(1 - \\alpha \\Delta t) f^n \\ge 0$$\n为了满足关于 $f^{n+1}$ 的不等式，我们现在可以建立对源项 $S$ 的一个界限。我们重排该不等式：\n$$\\Delta t S \\ge - (1 - \\alpha \\Delta t) f^n$$\n由于我们假设 $\\Delta t > 0$，我们可以用 $\\Delta t$ 除该不等式而不用改变其方向，从而得到关于 $S$ 的充分条件：\n$$S \\ge - \\frac{(1 - \\alpha \\Delta t) f^n}{\\Delta t}$$\n如果源幅值 $S$ 遵守此下界，则 $f^{n+1}$ 就保证是非负的。这可以通过反转此推导的步骤直接得出。\n\n第二，我们设计一个强制执行此条件的限制器。限制器必须将源项 $S$ 修改为一个新值 $S_{\\text{lim}}$，该新值总是满足推导出的界限。我们将允许的最小源幅值定义为 $S_{\\text{min}}$：\n$$S_{\\text{min}} = - \\frac{(1 - \\alpha \\Delta t) f^n}{\\Delta t}$$\n因此，所需条件为 $S \\ge S_{\\text{min}}$。如果 $S$ 已经满足此条件，限制器不得改变 $S$；如果不满足，则必须对 $S$ 进行最小调整。实现这一点的唯一数学运算是最大值函数。我们将限制后的源定义为：\n$$S_{\\text{lim}} = \\max(S, S_{\\text{min}})$$\n这个限制器正确地满足了设计要求。如果 $S \\ge S_{\\text{min}}$，则 $S_{\\text{lim}} = S$，源项不被修改。如果 $S < S_{\\text{min}}$，则 $S_{\\text{lim}} = S_{\\text{min}}$，这是为了满足保正条件而对 $S$ 做出的最小可能修改。使用这个限制后的源，更新方程变为：\n$$f^{n+1} = (1 - \\alpha \\Delta t) f^n + \\Delta t S_{\\text{lim}}$$\n根据我们限制器的定义，对于 $S$ 的任何值，我们都有 $S_{\\text{lim}} \\ge S_{\\text{min}}$。将此代入更新公式可保证非负性条件得到满足，因此 $f^{n+1} \\ge 0$。\n\n第三，我们概述实现算法。一个函数将接受 $(f^n, \\alpha, \\Delta t, S)$ 作为输入。假设 $\\Delta t > 0$，该函数将：\n1. 计算最小源值，$S_{\\text{min}} = - \\frac{(1 - \\alpha \\Delta t) f^n}{\\Delta t}$。\n2. 计算限制后的源，$S_{\\text{lim}} = \\max(S, S_{\\text{min}})$。\n3. 计算新的分布函数值，$f^{n+1} = (1 - \\alpha \\Delta t)f^n + \\Delta t S_{\\text{lim}}$。\n4. 返回 $f^{n+1}$。\n此过程将应用于所提供的每个测试用例。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem of applying a positivity-preserving limiter to a\n    forward-Euler update of a distribution function.\n    \"\"\"\n    # Test cases from the problem statement.\n    # Each tuple is (f^n, alpha, Delta_t, S)\n    test_cases = [\n        (1.0, 0.3, 1.0, -0.5),   # Test A\n        (0.2, 0.2, 1.0, -0.16),  # Test B\n        (0.1, 0.4, 1.0, -0.3),   # Test C\n        (5.0, 1.0, 1.0, -1.0),   # Test D\n        (0.0, 0.6, 1.0, -10.0),  # Test E\n        (0.7, 0.5, 0.5, 0.4),    # Test F\n    ]\n\n    def update_with_limiter(f_n: float, alpha: float, dt: float, S: float) -> float:\n        \"\"\"\n        Calculates the updated distribution function f^{n+1} using the\n        derived positivity-preserving limiter for the source term.\n        \n        Args:\n            f_n: Distribution function value at time n.\n            alpha: Linear sink coefficient.\n            dt: Time step size.\n            S: Source amplitude.\n            \n        Returns:\n            The updated distribution value f^{n+1}, guaranteed to be non-negative.\n        \"\"\"\n        if dt == 0.0:\n            # If time step is zero, no change occurs.\n            return f_n\n\n        alpha_dt = alpha * dt\n        \n        # Calculate the minimum allowed source term to ensure positivity.\n        # S_min = - (1 - alpha*dt) * f_n / dt\n        s_min = - (1.0 - alpha_dt) * f_n / dt\n        \n        # Apply the limiter: take the maximum of the original source and the minimum allowed value.\n        s_lim = np.maximum(S, s_min)\n        \n        # Calculate f^{n+1} using the limited source term.\n        # f^{n+1} = (1 - alpha*dt) * f_n + dt * S_lim\n        f_next = (1.0 - alpha_dt) * f_n + dt * s_lim\n        \n        return f_next\n\n    results = []\n    for case in test_cases:\n        f_n, alpha, dt, S = case\n        f_next = update_with_limiter(f_n, alpha, dt, S)\n        results.append(f_next)\n\n    # Format the results to six decimal places as specified.\n    formatted_results = [f'{r:.6f}' for r in results]\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在保证了时间步进的局部物理约束（如正定性）之后，我们必须将注意力转向空间离散化带来的全局约束，其中最核心的就是守恒律。无论是粒子数、动量还是能量，其总量的变化必须严格等于总源和总汇的净效应。这项练习  引入了有限体积法，并要求您设计一个能够精确保持粒子数守恒的源沉积格式。通过对高斯源函数进行解析积分，您将确保离散源的总和精确等于连续源在整个空间域上的积分，这是实现高保真度模拟的基石。",
            "id": "4196662",
            "problem": "考虑一个长度为 $L$、单位横截面积为 $A=1\\,\\mathrm{m}^2$ 的一维板状等离子体。在全分布函数（full-f）方法中，令 $f(x,t)$ 表示粒子数密度，单位为 $\\mathrm{m}^{-3}$。在存在平流、体积源和线性汇的情况下，$f$ 的演化由守恒定律决定\n$$\n\\frac{\\partial f}{\\partial t} + \\frac{\\partial}{\\partial x}\\left(u f\\right) = S(x) - \\nu f,\n$$\n其中 $u$ 是恒定的平流速度（单位 $\\mathrm{m/s}$），$S(x)$ 是给定的体积源率密度（单位 $\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}$），$\\nu$ 是线性汇率（单位 $\\mathrm{s}^{-1}$）。\n\n将空间域 $[0,L]$ 离散为 $N$ 个宽度为 $\\Delta x = L/N$ 的均匀有限体积单元。令第 $i$ 个单元为 $C_i = [x_{i-\\frac{1}{2}}, x_{i+\\frac{1}{2}}]$，其中 $x_{i-\\frac{1}{2}} = i\\,\\Delta x$ 且 $x_{i+\\frac{1}{2}} = (i+1)\\,\\Delta x$，并定义在时间 $t^n$ 的单元平均密度为 $f_i^n = \\frac{1}{\\Delta x} \\int_{C_i} f(x,t^n)\\,dx$。通过在控制体积 $C_i$ 上对守恒定律进行积分，并对通量项应用散度定理，可以得到大小为 $\\Delta t$ 的单个显式时间步长的有限体积离散更新。单元面通量应根据 $u$ 的符号进行迎风处理，并且源的沉积必须保证守恒，即单元积分源等于在单元上积分的给定体积率：\n$$\n\\int_{C_i} S(x)\\,dx = \\bar{S}_i\\,\\Delta x,\n$$\n其中 $\\bar{S}_i$ 是更新中使用的离散单元平均源。线性汇作显式处理。\n\n您的任务是：\n- 从守恒定律出发，根据单元面上的迎风数值通量、单元平均源 $\\bar{S}_i$ 和汇 $\\nu$，推导 $f_i^{n+1}$ 的显式、守恒的有限体积更新格式。\n- 设计一个源沉积方案，对于给定的解析 $S(x)$，将 $\\bar{S}_i$ 精确计算为单元平均值 $\\bar{S}_i = \\frac{1}{\\Delta x}\\int_{C_i} S(x)\\,dx$。特别地，取 $S(x)$ 为高斯分布之和\n$$\nS(x) = \\sum_{k=1}^{K} A_k \\exp\\!\\left(-\\frac{(x-\\mu_k)^2}{2\\sigma_k^2}\\right),\n$$\n其振幅为 $A_k$（单位 $\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}$），中心为 $\\mu_k$（单位 $\\mathrm{m}$），宽度为 $\\sigma_k$（单位 $\\mathrm{m}$）。在每个单元上对高斯函数进行解析积分，以保证 $\\sum_i \\bar{S}_i\\,\\Delta x = \\int_0^L S(x)\\,dx$。\n- 假设平流通量为周期性边界条件。\n\n使用推导出的离散格式，实现从 $t^n$ 到 $t^{n+1}$ 的单步更新。对于每个测试用例，计算以下两个诊断量：\n1. 离散源沉积的绝对守恒误差，\n$$\nE_S = \\left| \\sum_{i=0}^{N-1} \\bar{S}_i\\,\\Delta x - \\int_0^L S(x)\\,dx \\right|,\n$$\n单位为 $\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$。\n2. 单步有限体积更新（具有周期性平流通量）的绝对全局守恒误差，\n$$\nE_{\\text{cons}} = \\left| \\frac{\\sum_{i=0}^{N-1} \\left( f_i^{n+1} - f_i^{n} \\right)\\,\\Delta x}{\\Delta t} - \\left( \\sum_{i=0}^{N-1} \\bar{S}_i\\,\\Delta x - \\sum_{i=0}^{N-1} \\nu\\, f_i^{n}\\,\\Delta x \\right) \\right|,\n$$\n单位为 $\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$。\n\n对平流项使用迎风数值通量：\n- 如果 $u > 0$，则通过面 $x_{i+\\frac{1}{2}}$ 的通量为 $F_{i+\\frac{1}{2}}^n = u\\, f_i^n$。\n- 如果 $u < 0$，则通过面 $x_{i+\\frac{1}{2}}$ 的通量为 $F_{i+\\frac{1}{2}}^n = u\\, f_{i+1}^n$。\n周期性边界条件意味着在计算面通量时，$f_{N}^n \\equiv f_0^n$ 和 $f_{-1}^n \\equiv f_{N-1}^n$。\n\n每个高斯函数在区间 $[a,b]$ 上的解析积分为\n$$\n\\int_a^b A\\,\\exp\\!\\left(-\\frac{(x-\\mu)^2}{2\\sigma^2}\\right)\\,dx\n=\nA\\,\\sqrt{\\frac{\\pi}{2}}\\,\\sigma \\left[\n\\operatorname{erf}\\!\\left(\\frac{b-\\mu}{\\sqrt{2}\\,\\sigma}\\right)\n-\n\\operatorname{erf}\\!\\left(\\frac{a-\\mu}{\\sqrt{2}\\,\\sigma}\\right)\n\\right],\n$$\n其中 $\\operatorname{erf}$ 是误差函数。\n\n所有测试用例的初始条件：对于所有单元，$f_i^{n} = f_0$ 为常数。\n\n测试套件规范：\n- 测试用例 1（正常路径）：\n    - $L = 1.0\\,\\mathrm{m}$，$N = 64$，$\\Delta t = 1.0\\times 10^{-3}\\,\\mathrm{s}$，$u = 100.0\\,\\mathrm{m/s}$，$\\nu = 10.0\\,\\mathrm{s}^{-1}$，$f_0 = 2.0\\times 10^{5}\\,\\mathrm{m}^{-3}$，\n    - 源：$K=2$，参数为 $(A_1,\\mu_1,\\sigma_1) = (1.0\\times 10^{6}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1},\\,0.3\\,\\mathrm{m},\\,0.05\\,\\mathrm{m})$，$(A_2,\\mu_2,\\sigma_2) = (2.0\\times 10^{6}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1},\\,0.7\\,\\mathrm{m},\\,0.08\\,\\mathrm{m})$。\n- 测试用例 2（边界中心源，负平流）：\n    - $L = 1.0\\,\\mathrm{m}$，$N = 64$，$\\Delta t = 2.0\\times 10^{-3}\\,\\mathrm{s}$，$u = -50.0\\,\\mathrm{m/s}$，$\\nu = 0.0\\,\\mathrm{s}^{-1}$，$f_0 = 2.0\\times 10^{5}\\,\\mathrm{m}^{-3}$，\n    - 源：$K=2$，参数为 $(A_1,\\mu_1,\\sigma_1) = (5.0\\times 10^{5}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1},\\,0.02\\,\\mathrm{m},\\,0.03\\,\\mathrm{m})$，$(A_2,\\mu_2,\\sigma_2) = (1.0\\times 10^{6}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1},\\,0.98\\,\\mathrm{m},\\,0.03\\,\\mathrm{m})$。\n- 测试用例 3（窄源，零平流，强汇）：\n    - $L = 1.0\\,\\mathrm{m}$，$N = 128$，$\\Delta t = 5.0\\times 10^{-4}\\,\\mathrm{s}$，$u = 0.0\\,\\mathrm{m/s}$，$\\nu = 20.0\\,\\mathrm{s}^{-1}$，$f_0 = 2.0\\times 10^{5}\\,\\mathrm{m}^{-3}$，\n    - 源：$K=1$，参数为 $(A_1,\\mu_1,\\sigma_1) = (1.0\\times 10^{9}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1},\\,0.5\\,\\mathrm{m},\\,1.0\\times 10^{-4}\\,\\mathrm{m})$。\n\n您的程序必须：\n- 通过在每个单元上进行精确的高斯积分来计算 $\\bar{S}_i$。\n- 执行一次从 $t^n$ 到 $t^{n+1}$ 的显式迎风有限体积更新。\n- 计算并返回每个测试用例的 $E_S$ 和 $E_{\\text{cons}}$，单位为 $\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含结果，格式为逗号分隔的列表的列表。每个内部列表对应一个测试用例（按上述顺序），其中每个内部列表为 $[E_S,E_{\\text{cons}}]$。例如，格式必须类似于 $[[e_{1,1},e_{1,2}],[e_{2,1},e_{2,2}],[e_{3,1},e_{3,2}]]$（用实际数值代替符号）。",
            "solution": "用户要求推导并实现一个用于一维平流-反应-源方程的守恒有限体积格式。该问题在科学上是合理的、适定的，并为获得唯一解提供了所有必要信息。\n\n### 第1步：有限体积更新格式的推导\n\n控制偏微分方程是守恒定律：\n$$\n\\frac{\\partial f}{\\partial t} + \\frac{\\partial}{\\partial x}\\left(u f\\right) = S(x) - \\nu f\n$$\n这里，$f(x,t)$ 是粒子数密度，$u$ 是恒定的平流速度，$S(x)$ 是体积源率，$\\nu$ 是线性汇率。\n\n我们将空间域 $[0, L]$ 离散为 $N$ 个有限体积单元，$C_i = [x_{i-\\frac{1}{2}}, x_{i+\\frac{1}{2}}]$，其中 $i=0, 1, \\dots, N-1$。问题将单元边界定义为 $x_{i-\\frac{1}{2}} = i\\,\\Delta x$ 和 $x_{i+\\frac{1}{2}} = (i+1)\\,\\Delta x$，其中 $\\Delta x = L/N$。\n\n为推导离散更新规则，我们在一个通用单元 $C_i$ 上对偏微分方程进行积分：\n$$\n\\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} \\frac{\\partial f}{\\partial t} \\,dx + \\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} \\frac{\\partial}{\\partial x}(u f) \\,dx = \\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} S(x) \\,dx - \\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} \\nu f \\,dx\n$$\n\n我们对每一项进行计算。单元平均密度定义为 $f_i(t) = \\frac{1}{\\Delta x} \\int_{C_i} f(x,t)\\,dx$。\n1.  **时间导数项**：假设积分顺序可以交换：\n    $$\n    \\int_{C_i} \\frac{\\partial f}{\\partial t} \\,dx = \\frac{d}{dt} \\int_{C_i} f(x,t) \\,dx = \\frac{d}{dt} (f_i(t)\\,\\Delta x) = \\Delta x \\frac{df_i}{dt}\n    $$\n2.  **平流（通量）项**：使用微积分基本定理（一维散度定理）：\n    $$\n    \\int_{C_i} \\frac{\\partial}{\\partial x}(u f) \\,dx = [u f]_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} = (uf)\\big|_{x_{i+\\frac{1}{2}}} - (uf)\\big|_{x_{i-\\frac{1}{2}}}\n    $$\n    我们将单元面上的数值通量定义为 $F_{i+\\frac{1}{2}}$ 和 $F_{i-\\frac{1}{2}}$。该项变为 $F_{i+\\frac{1}{2}} - F_{i-\\frac{1}{2}}$。\n3.  **源项**：问题要求这是精确的单元积分源，我们将其表示为 $\\bar{S}_i \\Delta x$：\n    $$\n    \\int_{C_i} S(x) \\,dx = \\bar{S}_i \\Delta x, \\quad \\text{其中} \\quad \\bar{S}_i = \\frac{1}{\\Delta x} \\int_{C_i} S(x) \\,dx\n    $$\n4.  **汇项**：我们使用单元平均密度来近似该积分：\n    $$\n    \\int_{C_i} \\nu f \\,dx \\approx \\nu \\left( \\int_{C_i} f \\,dx \\right) = \\nu f_i \\Delta x\n    $$\n\n结合这些项，得到每个单元平均值 $f_i$ 的半离散常微分方程：\n$$\n\\Delta x \\frac{df_i}{dt} = - \\left( F_{i+\\frac{1}{2}} - F_{i-\\frac{1}{2}} \\right) + \\bar{S}_i \\Delta x - \\nu f_i \\Delta x\n$$\n除以 $\\Delta x$：\n$$\n\\frac{df_i}{dt} = -\\frac{F_{i+\\frac{1}{2}} - F_{i-\\frac{1}{2}}}{\\Delta x} + \\bar{S}_i - \\nu f_i\n$$\n我们采用步长为 $\\Delta t$ 的显式（前向欧拉）时间步进格式。令 $f_i^n$ 为 $f_i(t^n)$ 的近似值。时间导数近似为 $\\frac{df_i}{dt} \\approx \\frac{f_i^{n+1} - f_i^n}{\\Delta t}$。右侧的项在时间 $t^n$ 进行计算。\n$$\n\\frac{f_i^{n+1} - f_i^n}{\\Delta t} = -\\frac{F_{i+\\frac{1}{2}}^n - F_{i-\\frac{1}{2}}^n}{\\Delta x} + \\bar{S}_i - \\nu f_i^n\n$$\n整理得到 $f_i^{n+1}$，我们获得最终的全离散更新规则：\n$$\nf_i^{n+1} = f_i^n - \\frac{\\Delta t}{\\Delta x} \\left( F_{i+\\frac{1}{2}}^n - F_{i-\\frac{1}{2}}^n \\right) + \\Delta t \\bar{S}_i - \\Delta t \\nu f_i^n\n$$\n这可以重新组合为：\n$$\nf_i^{n+1} = f_i^n(1 - \\nu \\Delta t) - \\frac{\\Delta t}{\\Delta x} \\left( F_{i+\\frac{1}{2}}^n - F_{i-\\frac{1}{2}}^n \\right) + \\Delta t \\bar{S}_i\n$$\n\n### 第2步：迎风通量和周期性边界条件\n\n在单元 $C_i$ 和 $C_{i+1}$ 之间的界面上的数值通量 $F_{i+\\frac{1}{2}}^n$ 由迎风格式确定，这取决于平流速度 $u$ 的符号：\n-   如果 $u > 0$，信息从左向右传播。通量取决于上游单元 $C_i$ 中的状态：\n    $$F_{i+\\frac{1}{2}}^n = u f_i^n$$\n-   如果 $u < 0$，信息从右向左传播。通量取决于上游单元 $C_{i+1}$ 中的状态：\n    $$F_{i+\\frac{1}{2}}^n = u f_{i+1}^n$$\n-   如果 $u = 0$，通量为零：$F_{i+\\frac{1}{2}}^n = 0$。\n\n周期性边界条件要求 $f_N^n \\equiv f_0^n$ 和 $f_{-1}^n \\equiv f_{N-1}^n$。这些条件在计算域边界处的通量时使用，即用于 $F_{-1/2}^n$（单元 0 的左侧）和 $F_{N-1/2}^n$（单元 $N-1$ 的左侧，用于计算单元 $N-1$ 右侧的通量）。\n\n### 第3步：源沉积方案\n\n源项 $S(x)$ 是 $K$ 个高斯函数之和：\n$$\nS(x) = \\sum_{k=1}^{K} A_k \\exp\\!\\left(-\\frac{(x-\\mu_k)^2}{2\\sigma_k^2}\\right)\n$$\n单元平均源 $\\bar{S}_i$ 是通过在单元 $C_i = [x_{i-\\frac{1}{2}}, x_{i+\\frac{1}{2}}]$ 上对 $S(x)$ 进行解析积分来计算的：\n$$\n\\bar{S}_i = \\frac{1}{\\Delta x} \\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} S(x)\\,dx = \\frac{1}{\\Delta x} \\sum_{k=1}^{K} \\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} A_k \\exp\\!\\left(-\\frac{(x-\\mu_k)^2}{2\\sigma_k^2}\\right)\\,dx\n$$\n使用所提供的高斯积分公式，总和中的每一项为：\n$$\n\\int_{a}^{b} A_k e^{-\\frac{(x-\\mu_k)^2}{2\\sigma_k^2}}\\,dx = A_k \\sigma_k \\sqrt{\\frac{\\pi}{2}} \\left[ \\operatorname{erf}\\left(\\frac{b-\\mu_k}{\\sqrt{2}\\sigma_k}\\right) - \\operatorname{erf}\\left(\\frac{a-\\mu_k}{\\sqrt{2}\\sigma_k}\\right) \\right]\n$$\n其中 $a = x_{i-\\frac{1}{2}}$ 且 $b = x_{i+\\frac{1}{2}}$。此方法确保离散源的总强度 $\\sum_{i=0}^{N-1} \\bar{S}_i \\Delta x$ 在浮点精度范围内，与解析源的总强度 $\\int_0^L S(x)\\,dx$ 完全相等。\n\n### 第4步：诊断量的计算\n\n解答需要在单个时间步后计算两个误差度量。\n\n1.  **源守恒误差 $E_S$**：该度量量化了局部积分的离散源之和与全局积分的解析源之间的差异。\n    $$\n    E_S = \\left| \\sum_{i=0}^{N-1} \\bar{S}_i \\Delta x - \\int_0^L S(x)\\,dx \\right|\n    $$\n    其中 $\\int_0^L S(x)\\,dx$ 是通过对整个域 $[0, L]$ 上的每个高斯函数应用相同的解析积分公式来计算的。由于我们源沉积的守恒性质，该误差预计接近机器精度。\n\n2.  **全局守恒误差 $E_{\\text{cons}}$**：该度量验证离散更新是否根据源和汇在全局上守恒粒子数。\n    $$\n    E_{\\text{cons}} = \\left| \\frac{\\sum_{i=0}^{N-1} \\left( f_i^{n+1} - f_i^{n} \\right)\\,\\Delta x}{\\Delta t} - \\left( \\sum_{i=0}^{N-1} \\bar{S}_i\\,\\Delta x - \\sum_{i=0}^{N-1} \\nu\\, f_i^{n}\\,\\Delta x \\right) \\right|\n    $$\n    为分析此问题，我们将离散更新规则对所有单元 $i=0, \\dots, N-1$ 求和：\n    $$\n    \\sum_{i=0}^{N-1} \\frac{f_i^{n+1} - f_i^n}{\\Delta t} \\Delta x = - \\sum_{i=0}^{N-1} (F_{i+\\frac{1}{2}}^n - F_{i-\\frac{1}{2}}^n) + \\sum_{i=0}^{N-1} \\bar{S}_i \\Delta x - \\sum_{i=0}^{N-1} \\nu f_i^n \\Delta x\n    $$\n    通量和是一个伸缩和：$\\sum_{i=0}^{N-1} (F_{i+\\frac{1}{2}}^n - F_{i-\\frac{1}{2}}^n) = F_{N-\\frac{1}{2}}^n - F_{-\\frac{1}{2}}^n$。由于周期性边界条件（$f_{-1} \\equiv f_{N-1}$ 和 $f_N \\equiv f_0$），最后一个单元的流出通量等于第一个单元的流入通量（即，如果我们使用一致的索引，$F_{N-\\frac{1}{2}}^n = F_{-\\frac{1}{2}}^n$，或者更简单地说，跨周期性边界的净通量为零）。例如，如果 $u > 0$，通量差为 $u f_{N-1}^n - u f_{-1}^n = u f_{N-1}^n - u f_{N-1}^n = 0$。如果 $u < 0$，则为 $u f_N^n - u f_0^n = u f_0^n - u f_0^n = 0$。因此，平流项的总贡献为零。全局守恒定律简化为：\n    $$\n    \\frac{\\sum \\Delta x (f_i^{n+1} - f_i^n)}{\\Delta t} = \\sum \\bar{S}_i \\Delta x - \\sum \\nu f_i^n \\Delta x\n    $$\n    因此，$E_{\\text{cons}}$ 应在浮点表示误差范围内为零，这证实了整个数值格式的守恒性质。",
            "answer": "```python\nimport numpy as np\nfrom scipy.special import erf\n\ndef solve():\n    \"\"\"\n    Main function to run test cases and print results.\n    \"\"\"\n\n    test_cases = [\n        # Test case 1 (happy path)\n        {\n            \"L\": 1.0, \"N\": 64, \"dt\": 1.0e-3, \"u\": 100.0, \"nu\": 10.0,\n            \"f0\": 2.0e5,\n            \"sources\": [\n                {\"A\": 1.0e6, \"mu\": 0.3, \"sigma\": 0.05},\n                {\"A\": 2.0e6, \"mu\": 0.7, \"sigma\": 0.08},\n            ]\n        },\n        # Test case 2 (boundary-centered sources, negative advection)\n        {\n            \"L\": 1.0, \"N\": 64, \"dt\": 2.0e-3, \"u\": -50.0, \"nu\": 0.0,\n            \"f0\": 2.0e5,\n            \"sources\": [\n                {\"A\": 5.0e5, \"mu\": 0.02, \"sigma\": 0.03},\n                {\"A\": 1.0e6, \"mu\": 0.98, \"sigma\": 0.03},\n            ]\n        },\n        # Test case 3 (narrow source, zero advection, strong sink)\n        {\n            \"L\": 1.0, \"N\": 128, \"dt\": 5.0e-4, \"u\": 0.0, \"nu\": 20.0,\n            \"f0\": 2.0e5,\n            \"sources\": [\n                {\"A\": 1.0e9, \"mu\": 0.5, \"sigma\": 1.0e-4},\n            ]\n        }\n    ]\n\n    results = []\n    for params in test_cases:\n        result = run_simulation_step(**params)\n        results.append(result)\n\n    # Format the final output string exactly as required.\n    output_str = \"[\" + \",\".join([f\"[{e_s},{e_cons}]\" for e_s, e_cons in results]) + \"]\"\n    print(output_str)\n\ndef run_simulation_step(L, N, dt, u, nu, f0, sources):\n    \"\"\"\n    Performs a single time step of the finite-volume simulation and computes diagnostics.\n    \n    Args:\n        L (float): Length of the domain.\n        N (int): Number of cells.\n        dt (float): Time step size.\n        u (float): Advection speed.\n        nu (float): Sink rate.\n        f0 (float): Initial density.\n        sources (list): List of dicts, each specifying a Gaussian source.\n\n    Returns:\n        tuple: A tuple containing (E_S, E_cons).\n    \"\"\"\n    dx = L / N\n    \n    # Cell face coordinates. x_faces[i] is the left boundary of cell i.\n    x_faces = np.linspace(0.0, L, N + 1)\n    \n    # Initial condition: f^n\n    f_n = np.full(N, f0, dtype=np.float64)\n\n    # --- Step 1: Compute cell-averaged source S_bar ---\n    \n    s_bar = np.zeros(N, dtype=np.float64)\n    sqrt2 = np.sqrt(2.0)\n    sqrt_pi_over_2 = np.sqrt(np.pi / 2.0)\n\n    # Helper function for Gaussian integral\n    def gaussian_integral(a, b, A, mu, sigma):\n        # Integral of A * exp(-(x-mu)^2 / (2*sigma^2)) from a to b\n        # Avoid division by zero if sigma is extremely small\n        if sigma == 0:\n            return 0.0\n        z_a = (a - mu) / (sqrt2 * sigma)\n        z_b = (b - mu) / (sqrt2 * sigma)\n        integral = A * sigma * sqrt_pi_over_2 * (erf(z_b) - erf(z_a))\n        return integral\n\n    # Calculate cell-averaged source by integrating over each cell\n    for k in range(N):\n        a, b = x_faces[k], x_faces[k+1]\n        cell_integral = 0.0\n        for src in sources:\n            cell_integral += gaussian_integral(a, b, src[\"A\"], src[\"mu\"], src[\"sigma\"])\n        s_bar[k] = cell_integral / dx\n\n    # --- Step 2: Perform one finite-volume update step ---\n\n    # Compute flux difference term using upwinding and periodic BCs\n    flux_diff = np.zeros(N, dtype=np.float64)\n    if u > 0:\n        # F_{i+1/2} = u*f_i, F_{i-1/2} = u*f_{i-1}\n        # Difference = u * (f_i - f_{i-1})\n        f_im1 = np.roll(f_n, 1)  # f_{i-1} for each i, with periodicity\n        flux_diff = u * (f_n - f_im1)\n    elif u < 0:\n        # F_{i+1/2} = u*f_{i+1}, F_{i-1/2} = u*f_i\n        # Difference = u * (f_{i+1} - f_i)\n        f_ip1 = np.roll(f_n, -1) # f_{i+1} for each i, with periodicity\n        flux_diff = u * (f_ip1 - f_n)\n    # If u == 0, flux_diff remains zero, which is correct.\n    \n    # Full discrete update equation for f^{n+1}\n    f_np1 = f_n * (1.0 - nu * dt) - (dt / dx) * flux_diff + dt * s_bar\n\n    # --- Step 3: Compute diagnostics ---\n\n    # 1. Source conservation error E_S\n    total_discrete_source = np.sum(s_bar * dx)\n    total_analytic_source = 0.0\n    for src in sources:\n        total_analytic_source += gaussian_integral(0.0, L, src[\"A\"], src[\"mu\"], src[\"sigma\"])\n    \n    e_s = np.abs(total_discrete_source - total_analytic_source)\n\n    # 2. Global conservation error E_cons\n    # LHS: Time rate of change of total particle number\n    change_in_total_f = np.sum((f_np1 - f_n) * dx)\n    lhs = change_in_total_f / dt\n\n    # RHS: Total source rate minus total sink rate\n    total_source_rate = np.sum(s_bar * dx)\n    total_sink_rate = np.sum(nu * f_n * dx)\n    rhs = total_source_rate - total_sink_rate\n    \n    e_cons = np.abs(lhs - rhs)\n\n    return e_s, e_cons\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}