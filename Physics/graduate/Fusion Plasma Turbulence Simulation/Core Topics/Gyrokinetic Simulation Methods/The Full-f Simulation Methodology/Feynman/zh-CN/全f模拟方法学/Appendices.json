{
    "hands_on_practices": [
        {
            "introduction": "与背景固定的 $\\delta f$ 方法不同，全分布函数（full-f）模拟必须精确地演化整个分布函数，这使得守恒定律的数值保持成为一项核心挑战。长时间模拟中的数值误差可能导致总密度或能量等宏观量产生非物理性的漂移。本练习  通过一个具有精确解析解的简化模型，提供了一种具体的方法来设计检验并量化这类数值漂移的测试，这是验证 full-f 代码保真度的关键一步。",
            "id": "4203284",
            "problem": "你的任务是为聚变等离子体湍流模拟中的简化全分布函数方法设计并实现一个数值测试，该测试能够检测总密度或温度的不当漂移，而这种漂移在微扰分布形式中是不可见的。这必须使用物理上一致的模型和量化的诊断方法来完成。该测试将离散化速度分布的数值计算矩与规定源和汇下的解析矩演化进行比较。\n\n考虑一个单粒子种类、各向同性、零整体流动的等离子体，其粒子质量为 $m$，且无空间依赖性。速度为 $v$ 的全分布函数 $f(v,t)$ 在线性源-汇模型下演化，\n$$\n\\frac{\\partial f}{\\partial t} = \\nu_s \\left(f_S - f\\right) - \\nu_\\ell f,\n$$\n其中 $\\nu_s$ 是源率，$\\nu_\\ell$ 是损失率，$f_S(v)$ 是一个稳态源分布。初始条件是密度为 $n_0$、温度为 $T_0$ 的麦克斯韦分布 $f(v,0)=f_M(v;n_0,T_0)$。源分布也是密度为 $n_S$、温度为 $T_S$ 的麦克斯韦分布 $f_S(v)=f_M(v;n_S,T_S)$。零整体流动的各向同性三维麦克斯韦分布函数为\n$$\nf_M(v;n,T) = n \\left(\\frac{m}{2\\pi k_B T}\\right)^{3/2} \\exp\\left(-\\frac{m v^2}{2 k_B T}\\right),\n$$\n其中 $k_B$ 是玻尔兹曼常数。温度以电子伏特 (eV) 为单位提供，并且必须通过 $k_B T = e \\, T_{\\mathrm{eV}}$ 转换为能量，其中 $e$ 是基本电荷。$f$ 的密度矩和能量矩计算如下\n$$\nn(t) = \\int_0^{\\infty} 4\\pi v^2 f(v,t)\\,dv, \\quad E(t) = \\int_0^{\\infty} \\frac{1}{2} m v^2 \\, 4\\pi v^2 f(v,t)\\,dv.\n$$\n相应的温度由理想气体关系 $E(t) = \\frac{3}{2} n(t) k_B T(t)$ 定义。\n\n对于上述源-汇模型，矩的精确演化为\n$$\n\\mu = \\nu_s + \\nu_\\ell, \\quad n_{\\mathrm{exact}}(t) = e^{-\\mu t} n_0 + \\frac{\\nu_s}{\\mu} \\left(1 - e^{-\\mu t}\\right) n_S,\n$$\n$$\nE_{\\mathrm{exact}}(t) = e^{-\\mu t} E_0 + \\frac{\\nu_s}{\\mu} \\left(1 - e^{-\\mu t}\\right) E_S, \\quad E_0 = \\frac{3}{2} n_0 e T_0, \\quad E_S = \\frac{3}{2} n_S e T_S,\n$$\n和\n$$\nT_{\\mathrm{exact}}(t) = \\frac{E_{\\mathrm{exact}}(t)}{\\frac{3}{2} n_{\\mathrm{exact}}(t) k_B}.\n$$\n\n你的程序必须在具有 $N_v$ 个点的有限速度域 $v \\in [0, v_{\\max}]$ 上对 $f(v,t)$ 进行数值离散化，并使用时间步长 $\\Delta t$ 和显式欧拉更新方法随时间演化，\n$$\nf^{n+1}(v) = f^{n}(v) + \\Delta t \\left[ \\nu_s \\left(f_S(v) - f^{n}(v)\\right) - \\nu_\\ell f^{n}(v)\\right],\n$$\n从 $f^0(v)=f_M(v;n_0,T_0)$ 开始，并使用 $f_S(v)=f_M(v;n_S,T_S)$。在每个时间步 $t_n = n \\Delta t$，通过在 $v\\in[0,v_{\\max}]$ 上的离散积分计算 $n_{\\mathrm{num}}(t_n)$ 和 $E_{\\mathrm{num}}(t_n)$，并从 $E_{\\mathrm{num}}(t_n)=\\frac{3}{2} n_{\\mathrm{num}}(t_n) k_B T_{\\mathrm{num}}(t_n)$ 获得 $T_{\\mathrm{num}}(t_n)$。数值积分必须使用因子 $4\\pi v^2$ 来近似上述连续积分。数值单位为：$m$ 单位是千克， $n_0$ 和 $n_S$ 单位是 $\\mathrm{m}^{-3}$，$T_0$ 和 $T_S$ 单位是电子伏特 (eV)，$\\nu_s$ 和 $\\nu_\\ell$ 单位是 $\\mathrm{s}^{-1}$，$t$ 单位是秒，$v$ 单位是米/秒。所有计算出的温度必须在内部以电子伏特 (eV) 报告，与 $k_B T = e T_{\\mathrm{eV}}$ 一致，但下面指定的最终输出是无量纲的漂移度量。\n\n为了检测总密度或温度的不当漂移，定义在模拟时域 $t \\in [0, t_{\\mathrm{end}}]$ 上的最大相对漂移度量，\n$$\nD_n = \\max_{0 \\le n \\le N_t} \\left| \\frac{n_{\\mathrm{num}}(t_n) - n_{\\mathrm{exact}}(t_n)}{n_{\\mathrm{exact}}(t_n)} \\right|, \\quad\nD_T = \\max_{0 \\le n \\le N_t} \\left| \\frac{T_{\\mathrm{num}}(t_n) - T_{\\mathrm{exact}}(t_n)}{T_{\\mathrm{exact}}(t_n)} \\right|,\n$$\n其中 $N_t = t_{\\mathrm{end}}/\\Delta t$ 是时间步数。每个测试案例的单个标量诊断量是\n$$\nD = \\max\\left(D_n, D_T\\right).\n$$\n较大的 $D$ 值表示总矩存在漂移，而这种漂移是微扰分布形式无法揭示的，尤其是在速度空间域截断或粗分辨率导致矩捕获不正确时。\n\n为以下测试套件实现计算，该套件涵盖了充分解析的案例、无源衰减、带截断域的热源以及粗网格分辨率。在每种情况下，基于与相关温度关联的热速度 $v_{\\mathrm{th}}(T)=\\sqrt{2 e T/m}$ 选择 $v_{\\max}$，并将速度网格设置为在 $[0,v_{\\max}]$ 上的 $N_v$ 个均匀间隔点。\n\n- 案例 1 (充分解析，源-汇平衡)：\n  - $m = 3.344 \\times 10^{-27}\\ \\mathrm{kg}$，$n_0 = 1.0 \\times 10^{19}\\ \\mathrm{m}^{-3}$，$T_0 = 100\\ \\mathrm{eV}$，\n  - $n_S = 1.0 \\times 10^{19}\\ \\mathrm{m}^{-3}$，$T_S = 100\\ \\mathrm{eV}$，\n  - $\\nu_s = 1.0 \\times 10^{4}\\ \\mathrm{s}^{-1}$，$\\nu_\\ell = 1.0 \\times 10^{4}\\ \\mathrm{s}^{-1}$，\n  - $v_{\\max} = 6\\, v_{\\mathrm{th}}(T_0)$，$N_v = 800$，\n  - $\\Delta t = 1.0 \\times 10^{-6}\\ \\mathrm{s}$，$t_{\\mathrm{end}} = 1.0 \\times 10^{-3}\\ \\mathrm{s}$。\n\n- 案例 2 (无源衰减，适度截断)：\n  - $m = 3.344 \\times 10^{-27}\\ \\mathrm{kg}$，$n_0 = 1.0 \\times 10^{19}\\ \\mathrm{m}^{-3}$，$T_0 = 500\\ \\mathrm{eV}$，\n  - $n_S = 1.0 \\times 10^{19}\\ \\mathrm{m}^{-3}$，$T_S = 500\\ \\mathrm{eV}$，\n  - $\\nu_s = 0\\ \\mathrm{s}^{-1}$，$\\nu_\\ell = 5.0 \\times 10^{4}\\ \\mathrm{s}^{-1}$，\n  - $v_{\\max} = 5\\, v_{\\mathrm{th}}(T_0)$，$N_v = 400$，\n  - $\\Delta t = 1.0 \\times 10^{-6}\\ \\mathrm{s}$，$t_{\\mathrm{end}} = 1.0 \\times 10^{-4}\\ \\mathrm{s}$。\n\n- 案例 3 (热源，截断域以引发漂移)：\n  - $m = 3.344 \\times 10^{-27}\\ \\mathrm{kg}$，$n_0 = 1.0 \\times 10^{19}\\ \\mathrm{m}^{-3}$，$T_0 = 300\\ \\mathrm{eV}$，\n  - $n_S = 2.0 \\times 10^{19}\\ \\mathrm{m}^{-3}$，$T_S = 5000\\ \\mathrm{eV}$，\n  - $\\nu_s = 3.0 \\times 10^{4}\\ \\mathrm{s}^{-1}$，$\\nu_\\ell = 1.0 \\times 10^{4}\\ \\mathrm{s}^{-1}$，\n  - $v_{\\max} = 2\\, v_{\\mathrm{th}}(T_S)$，$N_v = 200$，\n  - $\\Delta t = 5.0 \\times 10^{-7}\\ \\mathrm{s}$，$t_{\\mathrm{end}} = 5.0 \\times 10^{-4}\\ \\mathrm{s}$。\n\n- 案例 4 (粗速度网格分辨率)：\n  - $m = 3.344 \\times 10^{-27}\\ \\mathrm{kg}$，$n_0 = 8.0 \\times 10^{18}\\ \\mathrm{m}^{-3}$，$T_0 = 800\\ \\mathrm{eV}$，\n  - $n_S = 8.0 \\times 10^{18}\\ \\mathrm{m}^{-3}$，$T_S = 800\\ \\mathrm{eV}$，\n  - $\\nu_s = 2.0 \\times 10^{4}\\ \\mathrm{s}^{-1}$，$\\nu_\\ell = 2.0 \\times 10^{4}\\ \\mathrm{s}^{-1}$，\n  - $v_{\\max} = 4\\, v_{\\mathrm{th}}(T_0)$，$N_v = 50$，\n  - $\\Delta t = 5.0 \\times 10^{-7}\\ \\mathrm{s}$，$t_{\\mathrm{end}} = 5.0 \\times 10^{-4}\\ \\mathrm{s}$。\n\n你的程序必须为每个案例计算如上定义的单个标量诊断量 $D$，并生成一行输出，其中包含用方括号括起来的逗号分隔的结果列表（例如，$[\\mathrm{result}_1,\\mathrm{result}_2,\\mathrm{result}_3,\\mathrm{result}_4]$）。输出是无量纲的浮点数。所有计算和常数必须是科学上可信且自洽的，数值积分、演化和诊断必须从第一性原理出发实现。不允许用户输入；程序必须是独立完整的。",
            "solution": "问题陈述为一个数值求解器构成了一个有效且良态的验证测试。它在科学上基于动理学理论的原理，特别是利用了 Krook 型源-汇模型来描述粒子分布函数的演化。所有参数、方程和数值程序都得到了明确定义，是完整且一致的。任务是实现这个测试，该测试旨在突显全分布函数 (`full-f`) 模拟方法中的潜在故障，例如由于数值不准确性导致的人为粒子或能量漂移。这些正是较简单的微扰 (`delta-f`) 方法可能掩盖的错误类型。该问题是计算等离子体物理代码验证中的一个标准练习。\n\n问题的核心在于比较从离散化数值模拟中获得的宏观矩（密度和温度）的时间演化与它们的精确解析解。依赖于速度 $v$ 和时间 $t$ 的分布函数 $f(v,t)$ 的控制方程是一个线性常微分方程：\n$$\n\\frac{\\partial f}{\\partial t} = \\nu_s \\left(f_S(v) - f(v,t)\\right) - \\nu_\\ell f(v,t)\n$$\n在此，$\\nu_s$ 是源率，$\\nu_\\ell$ 是损失率，$f_S(v)$ 是一个规定的稳态源分布。初始条件 $f(v,0)$ 和源 $f_S(v)$ 以麦克斯韦分布的形式给出：\n$$\nf_M(v;n,T) = n \\left(\\frac{m}{2\\pi k_B T}\\right)^{3/2} \\exp\\left(-\\frac{m v^2}{2 k_B T}\\right)\n$$\n其中 $n$ 是密度，$T$ 是温度，$m$ 是粒子质量，$k_B$ 是玻尔兹曼常数。请注意，此物理公式中的温度 $T$ 必须以能量单位（焦耳）或开尔文为单位。问题指定输入温度 $T_{\\mathrm{eV}}$ 以电子伏特为单位，通过关系式 $k_B T = e T_{\\mathrm{eV}}$ 进行转换，其中 $e$ 是基本电荷。\n\n通过对速度空间上的控制动理学方程进行积分，可以推导出密度矩 $n(t) = \\int_0^{\\infty} 4\\pi v^2 f(v,t)\\,dv$ 和能量矩 $E(t) = \\int_0^{\\infty} \\frac{1}{2} m v^2 \\, 4\\pi v^2 f(v,t)\\,dv$ 的精确演化方程。这些演化由以下公式给出：\n$$\n\\frac{dn}{dt} = \\nu_s n_S - (\\nu_s + \\nu_\\ell) n(t)\n$$\n$$\n\\frac{dE}{dt} = \\nu_s E_S - (\\nu_s + \\nu_\\ell) E(t)\n$$\n在初始条件 $n(0)=n_0$ 和 $E(0)=E_0 = \\frac{3}{2} n_0 e T_0$ 下，并定义 $\\mu = \\nu_s + \\nu_\\ell$，解为：\n$$\nn_{\\mathrm{exact}}(t) = n_0 e^{-\\mu t} + \\frac{\\nu_s n_S}{\\mu} \\left(1 - e^{-\\mu t}\\right)\n$$\n$$\nE_{\\mathrm{exact}}(t) = E_0 e^{-\\mu t} + \\frac{\\nu_s E_S}{\\mu} \\left(1 - e^{-\\mu t}\\right)\n$$\n其中 $E_S = \\frac{3}{2} n_S e T_S$。然后，可以从理想气体定律 $E_{\\mathrm{exact}}(t) = \\frac{3}{2} n_{\\mathrm{exact}}(t) e T_{\\mathrm{exact}}(t)$ 求得以电子伏特为单位的精确温度。\n\n数值程序涉及将速度域和时间域离散化。速度域 $v \\in [0, \\infty)$ 被截断为有限区间 $[0, v_{\\max}]$，并离散为 $N_v$ 个间距为 $\\Delta v$ 的均匀间隔点 $v_i$。每个网格点上分布函数的时间演化 $f_i^n \\equiv f(v_i, t_n)$，使用时间步长为 $\\Delta t$ 的显式欧拉方法计算：\n$$\nf_i^{n+1} = f_i^{n} + \\Delta t \\left[ \\nu_s \\left(f_{S,i} - f_i^{n}\\right) - \\nu_\\ell f_i^{n}\\right] = f_i^{n} (1 - \\mu \\Delta t) + \\Delta t \\nu_s f_{S,i}\n$$\n在每个时间步 $t_n = n\\Delta t$，数值矩 $n_{\\mathrm{num}}(t_n)$ 和 $E_{\\mathrm{num}}(t_n)$ 通过在离散速度网格上使用数值求积法则（如梯形法则）来近似连续积分进行计算：\n$$\nn_{\\mathrm{num}}(t_n) \\approx \\sum_{i=0}^{N_v-1} w_i \\cdot 4\\pi v_i^2 f_i^n\n$$\n$$\nE_{\\mathrm{num}}(t_n) \\approx \\sum_{i=0}^{N_v-1} w_i \\cdot \\frac{1}{2} m v_i^2 \\cdot 4\\pi v_i^2 f_i^n\n$$\n其中 $w_i$ 代表求积权重。对于梯形法则，这对应于 `numpy.trapz`。随后计算数值温度 $T_{\\mathrm{num}}(t_n)$。\n\n数值解的质量由诊断量 $D = \\max(D_n, D_T)$ 来量化，其中 $D_n$ 和 $D_T$ 是在整个模拟时间内数值矩和精确矩之间的最大相对差异：\n$$\nD_n = \\max_{t_n} \\left| \\frac{n_{\\mathrm{num}}(t_n) - n_{\\mathrm{exact}}(t_n)}{n_{\\mathrm{exact}}(t_n)} \\right|, \\quad\nD_T = \\max_{t_n} \\left| \\frac{T_{\\mathrm{num}}(t_n) - T_{\\mathrm{exact}}(t_n)}{T_{\\mathrm{exact}}(t_n)} \\right|\n$$\n较小的 $D$ 值表示高保真度模拟，其中数值误差（例如来自速度空间截断或粗网格分辨率的误差）是最小的。提供的测试案例旨在探查这些特定的误差源。例如，案例 3 使用了具有严重截断速度域的热源分布，预计会产生较大的 $D$ 值，表明未能正确捕获来自源的能量输入。案例 4 使用粗速度网格，这将导致显著的数值积分误差。案例 1 是一个充分解析的基线，案例 2 检查了一个简单的衰减情景。实现将通过为每个测试案例执行这些步骤来进行。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the full-f distribution function test problem for four cases.\n    \"\"\"\n    # Physical constants\n    E_CHARGE = 1.602176634e-19  # Elementary charge in Coulombs\n    BOLTZMANN_K = 1.380649e-23   # Boltzmann constant in J/K\n\n    test_cases = [\n        # Case 1: well-resolved, balanced source-loss\n        {\n            \"m\": 3.344e-27, \"n0\": 1.0e19, \"T0_eV\": 100.0,\n            \"nS\": 1.0e19, \"TS_eV\": 100.0,\n            \"nu_s\": 1.0e4, \"nu_l\": 1.0e4,\n            \"vmax_factor\": 6.0, \"vmax_T_ref\": \"T0\", \"Nv\": 800,\n            \"dt\": 1.0e-6, \"t_end\": 1.0e-3\n        },\n        # Case 2: source-free decay, moderate truncation\n        {\n            \"m\": 3.344e-27, \"n0\": 1.0e19, \"T0_eV\": 500.0,\n            \"nS\": 1.0e19, \"TS_eV\": 500.0,\n            \"nu_s\": 0.0, \"nu_l\": 5.0e4,\n            \"vmax_factor\": 5.0, \"vmax_T_ref\": \"T0\", \"Nv\": 400,\n            \"dt\": 1.0e-6, \"t_end\": 1.0e-4\n        },\n        # Case 3: hot source, truncated domain to induce drift\n        {\n            \"m\": 3.344e-27, \"n0\": 1.0e19, \"T0_eV\": 300.0,\n            \"nS\": 2.0e19, \"TS_eV\": 5000.0,\n            \"nu_s\": 3.0e4, \"nu_l\": 1.0e4,\n            \"vmax_factor\": 2.0, \"vmax_T_ref\": \"TS\", \"Nv\": 200,\n            \"dt\": 5.0e-7, \"t_end\": 5.0e-4\n        },\n        # Case 4: coarse velocity grid resolution\n        {\n            \"m\": 3.344e-27, \"n0\": 8.0e18, \"T0_eV\": 800.0,\n            \"nS\": 8.0e18, \"TS_eV\": 800.0,\n            \"nu_s\": 2.0e4, \"nu_l\": 2.0e4,\n            \"vmax_factor\": 4.0, \"vmax_T_ref\": \"T0\", \"Nv\": 50,\n            \"dt\": 5.0e-7, \"t_end\": 5.0e-4\n        },\n    ]\n\n    results = []\n\n    def thermal_speed(T_eV, m):\n        \"\"\"Calculates thermal speed from temperature in eV.\"\"\"\n        return np.sqrt(2 * E_CHARGE * T_eV / m)\n\n    def maxwellian_f(v, n, T_eV, m):\n        \"\"\"Calculates Maxwellian distribution.\"\"\"\n        T_K = T_eV * E_CHARGE / BOLTZMANN_K\n        if T_K == 0: return np.zeros_like(v)\n        # Handle potential overflow in normalization factor if T_K is very small\n        # Although problem parameters avoid this, it is good practice.\n        norm_factor = n * (m / (2 * np.pi * BOLTZMANN_K * T_K))**1.5\n        exponent = -m * v**2 / (2 * BOLTZMANN_K * T_K)\n        return norm_factor * np.exp(exponent)\n\n    for case in test_cases:\n        m, n0, T0_eV = case[\"m\"], case[\"n0\"], case[\"T0_eV\"]\n        nS, TS_eV = case[\"nS\"], case[\"TS_eV\"]\n        nu_s, nu_l = case[\"nu_s\"], case[\"nu_l\"]\n        vmax_factor, vmax_T_ref, Nv = case[\"vmax_factor\"], case[\"vmax_T_ref\"], case[\"Nv\"]\n        dt, t_end = case[\"dt\"], case[\"t_end\"]\n\n        # Setup parameters\n        mu = nu_s + nu_l\n        E0 = 1.5 * n0 * E_CHARGE * T0_eV\n        ES = 1.5 * nS * E_CHARGE * TS_eV\n\n        ref_T_for_vmax = T0_eV if vmax_T_ref == \"T0\" else TS_eV\n        v_max = vmax_factor * thermal_speed(ref_T_for_vmax, m)\n        v_grid = np.linspace(0, v_max, Nv)\n\n        Nt = int(np.round(t_end / dt))\n        time_pts = np.linspace(0, t_end, Nt + 1)\n        \n        # Initialize distribution function\n        f_n = maxwellian_f(v_grid, n0, T0_eV, m)\n        f_S = maxwellian_f(v_grid, nS, TS_eV, m)\n\n        n_num_hist, T_num_hist = [], []\n        n_exact_hist, T_exact_hist = [], []\n\n        # Time evolution loop\n        for t in time_pts:\n            # --- Analytical Solution ---\n            exp_mu_t = np.exp(-mu * t)\n            \n            # Handle case where mu=0 to avoid division by zero\n            if mu == 0:\n                n_exact = n0 + nu_s * nS * t\n                E_exact = E0 + nu_s * ES * t\n            else:\n                n_exact = n0 * exp_mu_t + (nu_s * nS / mu) * (1 - exp_mu_t)\n                E_exact = E0 * exp_mu_t + (nu_s * ES / mu) * (1 - exp_mu_t)\n            \n            # T_exact is in eV\n            T_exact = E_exact / (1.5 * n_exact * E_CHARGE) if n_exact > 0 else 0.0\n\n            n_exact_hist.append(n_exact)\n            T_exact_hist.append(T_exact)\n\n            # --- Numerical Solution ---\n            integrand_n = 4 * np.pi * v_grid**2 * f_n\n            n_num = np.trapz(integrand_n, v_grid)\n            \n            integrand_E = 0.5 * m * v_grid**2 * integrand_n\n            E_num = np.trapz(integrand_E, v_grid)\n\n            # T_num is in eV\n            T_num = E_num / (1.5 * n_num * E_CHARGE) if n_num > 0 else 0.0\n\n            n_num_hist.append(n_num)\n            T_num_hist.append(T_num)\n\n            # --- Update distribution function using Explicit Euler ---\n            f_n = f_n * (1 - mu * dt) + dt * nu_s * f_S\n\n        # Calculate diagnostics\n        n_num_hist = np.array(n_num_hist)\n        T_num_hist = np.array(T_num_hist)\n        n_exact_hist = np.array(n_exact_hist)\n        T_exact_hist = np.array(T_exact_hist)\n        \n        # Avoid division by zero if exact value is zero (though not expected here)\n        # Use np.divide with a 'where' clause for robustness\n        with np.errstate(divide='ignore', invalid='ignore'):\n            rel_err_n = np.abs((n_num_hist - n_exact_hist) / n_exact_hist)\n            rel_err_T = np.abs((T_num_hist - T_exact_hist) / T_exact_hist)\n        \n        # Replace NaNs or Infs from division-by-zero with 0.0\n        rel_err_n[~np.isfinite(rel_err_n)] = 0.0\n        rel_err_T[~np.isfinite(rel_err_T)] = 0.0\n        \n        D_n = np.max(rel_err_n)\n        D_T = np.max(rel_err_T)\n\n        D = max(D_n, D_T)\n        results.append(D)\n    \n    print(f\"[{','.join(f'{r:.10f}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在验证了代码的数值准确性之后，我们转向粒子模拟方法（PIC）固有的统计特性。Full-f 模拟使用离散的宏粒子来表示连续的分布函数，这必然会引入统计噪声。本练习  将引导你从第一性原理出发，推导一个关键物理观测量（动能密度）的估计方差，从而让你对模拟参数如何影响噪声水平有一个定量的理解。",
            "id": "4203338",
            "problem": "考虑对均匀、静态等离子体中质量为 $m$ 的单一离子种类进行全分布函数（full-f）网格粒子（PIC）模拟。在体积为 $V_c$ 的单个空间单元格中，该离子种类的数密度为 $n$，速度分布为温度是 $T$ 的麦克斯韦-玻尔兹曼分布。其分布函数可分解为 $f(\\mathbf{x},\\mathbf{v}) = n\\,F_{\\mathrm{MB}}(\\mathbf{v};T)$，其中麦克斯韦-玻尔兹曼速度概率密度函数 (PDF) 为\n$$\nF_{\\mathrm{MB}}(\\mathbf{v};T) = \\left(\\frac{m}{2\\pi k_{B}T}\\right)^{3/2}\\exp\\!\\left(-\\frac{m\\,|\\mathbf{v}|^{2}}{2k_{B}T}\\right),\n$$\n其中 $k_{B}$ 是玻尔兹曼常数。\n\n您希望估计动能密度矩\n$$\nK = \\int_{\\mathbb{R}^{3}} \\frac{1}{2}\\,m\\,|\\mathbf{v}|^{2}\\,f(\\mathbf{x},\\mathbf{v})\\,\\mathrm{d}^{3}\\mathbf{v} = n\\int_{\\mathbb{R}^{3}} \\frac{1}{2}\\,m\\,|\\mathbf{v}|^{2}\\,F_{\\mathrm{MB}}(\\mathbf{v};T)\\,\\mathrm{d}^{3}\\mathbf{v}\n$$\n使用 $N$ 个独立的宏粒子，在感兴趣的瞬间，这些宏粒子的速度从概率密度函数 $F_{\\mathrm{MB}}(\\mathbf{v};T)$ 中进行独立同分布抽样（即，在固定的 $\\mathbf{x}$ 处对速度空间进行标准的 full-f PIC 抽样）。自然的 PIC 估计量是被积函数的样本均值乘以 $n$。\n\n从蒙特卡洛估计的基本原理和麦克斯韦-玻尔兹曼分布的性质出发，推导该 PIC 估计量方差的闭式解析表达式，该表达式是 $n$、$T$、$k_{B}$、$m$ 和 $N$ 的函数。\n\n此外，提出并论证一种在 full-f PIC 背景下保持估计量无偏性的方差缩减策略。\n\n以 $(\\mathrm{J}/\\mathrm{m}^{3})^{2}$ 为单位表示最终的方差。您的最终答案必须是单一的闭式表达式；不要将中间方程作为最终答案。无需四舍五入。",
            "solution": "用户希望我解决以下问题：\n“考虑对均匀、静态等离子体中质量为 $m$ 的单一离子种类进行全分布函数（full-f）网格粒子（PIC）模拟。在体积为 $V_c$ 的单个空间单元格中，该离子种类的数密度为 $n$，速度分布为温度是 $T$ 的麦克斯韦-玻尔兹曼分布。其分布函数可分解为 $f(\\mathbf{x},\\mathbf{v}) = n\\,F_{\\mathrm{MB}}(\\mathbf{v};T)$，其中麦克斯韦-玻尔兹曼速度概率密度函数 (PDF) 为\n$$\nF_{\\mathrm{MB}}(\\mathbf{v};T) = \\left(\\frac{m}{2\\pi k_{B}T}\\right)^{3/2}\\exp\\!\\left(-\\frac{m\\,|\\mathbf{v}|^{2}}{2k_{B}T}\\right),\n$$\n其中 $k_{B}$ 是玻尔兹曼常数。\n\n您希望估计动能密度矩\n$$\nK = \\int_{\\mathbb{R}^{3}} \\frac{1}{2}\\,m\\,|\\mathbf{v}|^{2}\\,f(\\mathbf{x},\\mathbf{v})\\,\\mathrm{d}^{3}\\mathbf{v} = n\\int_{\\mathbb{R}^{3}} \\frac{1}{2}\\,m\\,|\\mathbf{v}|^{2}\\,F_{\\mathrm{MB}}(\\mathbf{v};T)\\,\\mathrm{d}^{3}\\mathbf{v}\n$$\n使用 $N$ 个独立的宏粒子，在感兴趣的瞬间，这些宏粒子的速度从概率密度函数 $F_{\\mathrm{MB}}(\\mathbf{v};T)$ 中进行独立同分布抽样（即，在固定的 $\\mathbf{x}$ 处对速度空间进行标准的 full-f PIC 抽样）。自然的 PIC 估计量是被积函数的样本均值乘以 $n$。\n\n从蒙特卡洛估计的基本原理和麦克斯韦-玻尔兹曼分布的性质出发，推导该 PIC 估计量方差的闭式解析表达式，该表达式是 $n$、$T$、$k_{B}$、$m$ 和 $N$ 的函数。\n\n此外，提出并论证一种在 full-f PIC 背景下保持估计量无偏性的方差缩减策略。”\n\n### 步骤1：提取已知条件\n-   系统：均匀、静态等离子体中的单一离子种类。\n-   粒子质量：$m$。\n-   单元格体积：$V_c$。\n-   种类数密度：$n$。\n-   种类温度：$T$。\n-   分布函数：$f(\\mathbf{x},\\mathbf{v}) = n\\,F_{\\mathrm{MB}}(\\mathbf{v};T)$。\n-   速度PDF：$F_{\\mathrm{MB}}(\\mathbf{v};T) = \\left(\\frac{m}{2\\pi k_{B}T}\\right)^{3/2}\\exp\\!\\left(-\\frac{m\\,|\\mathbf{v}|^{2}}{2k_{B}T}\\right)$。\n-   常数：$k_{B}$ (玻尔兹曼常数)。\n-   待估计量：动能密度，$K = n\\int_{\\mathbb{R}^{3}} \\frac{1}{2}\\,m\\,|\\mathbf{v}|^{2}\\,F_{\\mathrm{MB}}(\\mathbf{v};T)\\,\\mathrm{d}^{3}\\mathbf{v}$。\n-   估计方法：使用 $N$ 个独立同分布的宏粒子进行蒙特卡洛抽样。\n-   粒子速度 $\\{\\mathbf{v}_i\\}_{i=1}^N$ 从 $F_{\\mathrm{MB}}(\\mathbf{v};T)$ 中抽取。\n-   PIC 估计量形式：被积函数的样本均值乘以 $n$。\n\n### 步骤2：使用提取的已知条件进行验证\n-   **科学基础**：该问题在统计力学和计算等离子体物理领域有坚实的科学基础。麦克斯韦-玻尔兹曼分布、网格粒子方法和蒙特卡洛估计都是标准和基本概念。\n-   **良态性**：问题陈述清晰，所有必要的参数和分布都已定义。它要求推导特定估计量的方差并提出一种方差缩减技术，这两者都是可解的任务。方差存在唯一的解析解。\n-   **客观性**：语言精确客观，使用了标准的科学术语。没有主观或含糊的陈述。\n\n该问题没有指令中列出的任何缺陷（例如，科学上不健全、不完整、矛盾等）。这是一个计算物理学中标准的、表述良好的问题。\n\n### 步骤3：判断与行动\n问题有效。我将继续进行解答。\n\n### 第1部分：PIC 估计量方差的推导\n\n动能密度由 $K = n \\langle E_k \\rangle$ 给出，其中 $E_k(\\mathbf{v}) = \\frac{1}{2}m|\\mathbf{v}|^2$ 是单个粒子的动能，尖括号表示在速度 PDF $F_{\\mathrm{MB}}(\\mathbf{v};T)$ 上的期望值。\n$$\n\\langle E_k \\rangle = \\int_{\\mathbb{R}^3} E_k(\\mathbf{v}) F_{\\mathrm{MB}}(\\mathbf{v};T) \\, \\mathrm{d}^3\\mathbf{v}\n$$\n$K$ 的 PIC 估计量是通过将期望值替换为对从 $F_{\\mathrm{MB}}$ 中抽样的 $N$ 个粒子（速度为 $\\mathbf{v}_i$）的样本均值来构建的。问题陈述该估计量为被积函数的样本均值乘以 $n$。如果我们将积分写作 $K = \\int (\\frac{1}{2}m|\\mathbf{v}|^2 n) F_{\\mathrm{MB}}(\\mathbf{v}) \\mathrm{d}^3\\mathbf{v}$，并从 $F_{\\mathrm{MB}}$ 抽样，那么被平均的项是 $H(\\mathbf{v}) = \\frac{1}{2} m |\\mathbf{v}|^2 n$。因此，$K$ 的估计量为：\n$$\n\\hat{K} = \\frac{1}{N} \\sum_{i=1}^{N} H(\\mathbf{v}_i) = \\frac{1}{N} \\sum_{i=1}^{N} \\frac{1}{2} m |\\mathbf{v}_i|^2 n = \\frac{n}{N} \\sum_{i=1}^{N} \\frac{1}{2} m |\\mathbf{v}_i|^2\n$$\n如果将“被积函数”理解为 $\\frac{1}{2}m|\\mathbf{v}|^2$，这就与“被积函数的样本均值乘以 $n$”的解释相符。令 $E_{k,i} = \\frac{1}{2} m |\\mathbf{v}_i|^2$。则 $\\hat{K} = \\frac{n}{N} \\sum_{i=1}^N E_{k,i}$。\n\n此估计量的方差 $\\mathrm{Var}(\\hat{K})$ 由方差的性质给出。由于速度 $\\mathbf{v}_i$ 是独立同分布的，因此动能 $E_{k,i}$ 也是独立同分布的随机变量。\n$$\n\\mathrm{Var}(\\hat{K}) = \\mathrm{Var}\\left(\\frac{n}{N} \\sum_{i=1}^{N} E_{k,i}\\right) = \\frac{n^2}{N^2} \\mathrm{Var}\\left(\\sum_{i=1}^{N} E_{k,i}\\right) = \\frac{n^2}{N^2} \\sum_{i=1}^{N} \\mathrm{Var}(E_{k,i}) = \\frac{n^2}{N^2} N \\mathrm{Var}(E_k) = \\frac{n^2}{N} \\mathrm{Var}(E_k)\n$$\n任务简化为计算单个粒子动能的方差 $\\mathrm{Var}(E_k)$。方差定义为 $\\mathrm{Var}(E_k) = \\langle E_k^2 \\rangle - \\langle E_k \\rangle^2$。我们必须计算 $E_k$ 的前两阶矩。\n\n令 $a = \\frac{m}{2k_B T}$。麦克斯韦-玻尔兹曼 PDF 在球坐标系中对立体角积分后，变为速率 $v=|\\mathbf{v}|$ 的 PDF：\n$$\nP(v) = 4\\pi v^2 \\left(\\frac{m}{2\\pi k_B T}\\right)^{3/2} \\exp\\left(-\\frac{mv^2}{2k_B T}\\right) = 4\\pi v^2 \\left(\\frac{a}{\\pi}\\right)^{3/2} \\exp(-av^2)\n$$\n一阶矩，$\\langle E_k \\rangle$：\n$$\n\\langle E_k \\rangle = \\int_0^\\infty \\left(\\frac{1}{2}mv^2\\right) P(v) \\, \\mathrm{d}v = \\frac{1}{2}m \\int_0^\\infty v^2 \\left( 4\\pi v^2 \\left(\\frac{a}{\\pi}\\right)^{3/2} \\exp(-av^2) \\right) \\, \\mathrm{d}v\n$$\n$$\n\\langle E_k \\rangle = 2\\pi m \\left(\\frac{a}{\\pi}\\right)^{3/2} \\int_0^\\infty v^4 \\exp(-av^2) \\, \\mathrm{d}v\n$$\n我们使用标准积分公式 $\\int_0^\\infty x^{2n} \\exp(-ax^2) \\, \\mathrm{d}x = \\frac{(2n-1)!!}{2^{n+1}} \\sqrt{\\frac{\\pi}{a^{2n+1}}}$。对于 $n=2$，积分为 $\\frac{3!!}{2^3}\\sqrt{\\frac{\\pi}{a^5}} = \\frac{3}{8}\\sqrt{\\frac{\\pi}{a^5}}$。\n$$\n\\langle E_k \\rangle = 2\\pi m \\left(\\frac{a}{\\pi}\\right)^{3/2} \\frac{3}{8}\\sqrt{\\frac{\\pi}{a^5}} = 2\\pi m \\frac{a^{3/2}}{\\pi^{3/2}} \\frac{3\\pi^{1/2}}{8a^{5/2}} = \\frac{6\\pi m}{8\\pi} \\frac{1}{a} = \\frac{3m}{4a}\n$$\n代入 $a = \\frac{m}{2k_B T}$：\n$$\n\\langle E_k \\rangle = \\frac{3m}{4} \\left(\\frac{2k_B T}{m}\\right) = \\frac{3}{2}k_B T\n$$\n这是能量均分定理的著名结果。真实的动能密度是 $K = n\\langle E_k \\rangle = \\frac{3}{2}nk_BT$。\n\n二阶矩，$\\langle E_k^2 \\rangle$：\n$$\n\\langle E_k^2 \\rangle = \\left\\langle \\left(\\frac{1}{2}mv^2\\right)^2 \\right\\rangle = \\frac{m^2}{4} \\langle v^4 \\rangle = \\frac{m^2}{4} \\int_0^\\infty v^4 P(v) \\, \\mathrm{d}v\n$$\n$$\n\\langle E_k^2 \\rangle = \\frac{m^2}{4} \\int_0^\\infty v^4 \\left( 4\\pi v^2 \\left(\\frac{a}{\\pi}\\right)^{3/2} \\exp(-av^2) \\right) \\, \\mathrm{d}v = \\pi m^2 \\left(\\frac{a}{\\pi}\\right)^{3/2} \\int_0^\\infty v^6 \\exp(-av^2) \\, \\mathrm{d}v\n$$\n对于 $n=3$ 使用积分公式，积分为 $\\frac{5!!}{2^4}\\sqrt{\\frac{\\pi}{a^7}} = \\frac{15}{16}\\sqrt{\\frac{\\pi}{a^7}}$。\n$$\n\\langle E_k^2 \\rangle = \\pi m^2 \\frac{a^{3/2}}{\\pi^{3/2}} \\frac{15\\pi^{1/2}}{16a^{7/2}} = \\frac{15\\pi m^2}{16\\pi} \\frac{1}{a^2} = \\frac{15 m^2}{16 a^2}\n$$\n代入 $a = \\frac{m}{2k_B T}$：\n$$\n\\langle E_k^2 \\rangle = \\frac{15 m^2}{16} \\left(\\frac{2k_B T}{m}\\right)^2 = \\frac{15 m^2}{16} \\frac{4(k_B T)^2}{m^2} = \\frac{15}{4}(k_B T)^2\n$$\n现在，我们计算 $E_k$ 的方差：\n$$\n\\mathrm{Var}(E_k) = \\langle E_k^2 \\rangle - \\langle E_k \\rangle^2 = \\frac{15}{4}(k_B T)^2 - \\left(\\frac{3}{2}k_B T\\right)^2 = \\frac{15}{4}(k_B T)^2 - \\frac{9}{4}(k_B T)^2 = \\frac{6}{4}(k_B T)^2 = \\frac{3}{2}(k_B T)^2\n$$\n最后，我们可以写出估计量 $\\hat{K}$ 的方差：\n$$\n\\mathrm{Var}(\\hat{K}) = \\frac{n^2}{N} \\mathrm{Var}(E_k) = \\frac{n^2}{N} \\left(\\frac{3}{2}(k_B T)^2\\right) = \\frac{3n^2(k_B T)^2}{2N}\n$$\n单位是 $(1/\\mathrm{m}^3)^2 \\cdot (\\mathrm{J})^2 = (\\mathrm{J}/\\mathrm{m}^3)^2$，这对于能量密度的方差是正确的。\n\n### 第2部分：方差缩减策略\n\n对于一个随时间演化的 full-f PIC 模拟，一种强大且广泛使用的、能保持无偏性的方差缩减技术是**基于初始状态相减的控制变量法**。这有时被称为“$\\delta f$ 控制变量”法。\n\n**提案：**\n设 $f_0(\\mathbf{x}, \\mathbf{v})$ 是等离子体的初始分布函数，即问题中给出的麦克斯韦-玻尔兹曼分布，$f_0(\\mathbf{v}) = n F_{MB}(\\mathbf{v}; T)$。初始动能密度是解析已知的：$K_0 = \\int (\\frac{1}{2}m|\\mathbf{v}|^2) f_0(\\mathbf{v}) \\mathrm{d}^3\\mathbf{v} = \\frac{3}{2}nk_BT$。\n模拟在时间 $t=0$ 开始，单元格内有 $N$ 个粒子，其速度 $\\{\\mathbf{v}_{i,0}\\}$ 从 $F_{MB}$ 中抽样得到。然后模拟将这些粒子演化到稍后的时间 $t$，得到新的速度 $\\{\\mathbf{v}_{i}(t)\\}$。\n\n在时间 $t$ 的动能密度的标准估计量是：\n$$\n\\hat{K}(t) = \\frac{n}{N} \\sum_{i=1}^N \\frac{1}{2}m|\\mathbf{v}_i(t)|^2\n$$\n提议的控制变量估计量 $\\hat{K}_{cv}(t)$ 是：\n$$\n\\hat{K}_{cv}(t) = \\hat{K}(t) - (\\hat{K}(0) - K_0)\n$$\n其中 $\\hat{K}(0)$ 是用初始粒子速度计算的估计量：\n$$\n\\hat{K}(0) = \\frac{n}{N} \\sum_{i=1}^N \\frac{1}{2}m|\\mathbf{v}_{i,0}|^2\n$$\n\n**论证：**\n1.  **无偏性**：该估计量是无偏的。$\\hat{K}(t)$ 的期望值是时间 $t$ 的真实动能密度 $K(t)$。$\\hat{K}(0)$ 的期望值是真实的初始能量密度 $K_0$，因为初始粒子是从 $f_0$ 中抽样的。\n    $$\n    \\mathrm{E}[\\hat{K}_{cv}(t)] = \\mathrm{E}[\\hat{K}(t)] - (\\mathrm{E}[\\hat{K}(0)] - K_0) = K(t) - (K_0 - K_0) = K(t)\n    $$\n    因此，该估计量正确地估计了时间 $t$ 的动能密度。\n\n2.  **方差缩减**：新估计量的方差是：\n    $$\n    \\mathrm{Var}(\\hat{K}_{cv}(t)) = \\mathrm{Var}(\\hat{K}(t) - \\hat{K}(0)) = \\mathrm{Var}(\\hat{K}(t)) + \\mathrm{Var}(\\hat{K}(0)) - 2\\mathrm{Cov}(\\hat{K}(t), \\hat{K}(0))\n    $$\n    项 $\\hat{K}(t)$ 是在时间 $t$ 的物理量的估计值，而 $\\hat{K}(0)$ 是在时间 $0$ 的估计值。项 $(\\hat{K}(0) - K_0)$ 代表了初始的统计抽样噪声。通过减去它，我们从时间 $t$ 的测量中移除了这个噪声。该方法的有效性依赖于 $\\hat{K}(t)$ 和 $\\hat{K}(0)$ 之间的强正相关性。由于粒子轨迹 $\\mathbf{v}_i(t)$ 是从 $\\mathbf{v}_{i,0}$ 连续演化而来的，估计量 $\\hat{K}(t)$ 和 $\\hat{K}(0)$ 高度相关，特别是当分布函数变化很小时。协方差项 $2\\mathrm{Cov}(\\hat{K}(t), \\hat{K}(0))$ 会变得很大，几乎抵消了方差之和，导致 $\\hat{K}_{cv}(t)$ 的方差远小于 $\\mathrm{Var}(\\hat{K}(t))$。这使得能够精确测量动能密度的微小变化，否则这些变化将被淹没在初始抽样噪声中。\n\n这一策略是现代低噪声 full-f 和 $\\delta f$ PIC 模拟的基石。它有效地将矩的物理演化与初始粒子加载所固有的统计噪声分离开来。",
            "answer": "$$\n\\boxed{\\frac{3 n^{2} (k_{B} T)^{2}}{2N}}\n$$"
        },
        {
            "introduction": "掌握了代码验证和噪声分析后，我们进入模拟工作流程的最后阶段：数据分析与物理诠释。从模拟产生的海量原始数据中提取有意义的物理信息是至关重要的一步。本练习  将指导你构建一个频率-波数诊断工具，用于识别等离子体湍流中的主导模式，例如离子温度梯度模（ITG）和捕获电子模（TEM），这是计算等离子体物理学家的必备技能。",
            "id": "4203273",
            "problem": "您的任务是为磁约束聚变等离子体湍流的全分布函数方法（“full-f”模拟）产生的涨落设计一种频率-波数诊断工具。其目标是从合成的 full-f 涨落数据中提取主要的谱峰，并根据其在副法向波数方向的传播方向，将其分类为离子温度梯度（ITG）模或捕获电子模（TEM）。请将该诊断工具实现为一个完整的、可运行的程序，该程序能为指定的测试套件生成所需输出，并遵循以下所有说明。\n\n从适用于聚变等离子体湍流的第一性原理和核心定义开始：\n\n- 全分布函数（“full-f”）方法演化的是粒子在动理学方程下的整个分布函数，而不仅仅是其涨落。对于无碰撞静电涨落，分布函数 $f$ 的弗拉索夫方程可以写成简化形式：\n  $$\\frac{\\partial f}{\\partial t} + \\mathbf{v}\\cdot \\nabla f + \\frac{q}{m}\\left(\\mathbf{E} + \\mathbf{v}\\times\\mathbf{B}\\right)\\cdot \\frac{\\partial f}{\\partial \\mathbf{v}} = 0,$$\n  其中 $q$ 是电荷，$m$ 是质量，$\\mathbf{E}$ 是电场，$\\mathbf{B}$ 是磁场。在 full-f 方法中，通常分析从 $f$ 中提取的可观测量（例如密度、电势）的涨落，将其作为副法向坐标 $y$ 和时间 $t$ 的函数。\n- 频率-波数谱通过二维傅里叶变换定义。对于一个涨落信号 $s(y,t)$，定义其连续变换为\n  $$S(k,\\omega) = \\int_{-\\infty}^{\\infty}\\int_{-\\infty}^{\\infty} s(y,t)\\,e^{-i(ky - \\omega t)}\\,dy\\,dt,$$\n  以及相应的功率谱密度\n  $$P(k,\\omega) = |S(k,\\omega)|^2.$$\n  在数值计算上，我们将在均匀采样的网格上使用离散傅里叶变换，并应用可分离的窗函数来减少谱泄漏。\n\n将谱与模识别联系起来的物理解释标准：\n\n- 离子温度梯度（ITG）模主要是由离子温度梯度驱动的漂移波，并倾向于沿离子逆磁方向（副法向传播）传播。捕获电子模（TEM）由电子动力学驱动，并沿电子逆磁方向传播。为了此诊断的目的，通过相速度的符号来对谱峰进行分类\n  $$v_{\\mathrm{ph}} = \\frac{\\omega}{k},$$\n  并与已知的副法向逆磁传播方向的符号进行比较。令 $s_i \\in \\{-1,+1\\}$ 表示离子逆磁方向的符号，$s_e \\in \\{-1,+1\\}$ 表示电子逆磁方向的符号。如果 $\\mathrm{sign}(v_{\\mathrm{ph}}) = s_i$，则分类为 ITG；如果 $\\mathrm{sign}(v_{\\mathrm{ph}}) = s_e$，则分类为 TEM；否则分类为模糊。\n- 由于实值信号会在 $(k,\\omega)$ 和 $(-k,-\\omega)$ 处产生对称的谱峰，因此将峰值搜索限制在 $k>0$ 的范围，以避免无关紧要的对称重复。如果在 $k>0$ 的半平面内，有多个峰在数值容差范围内共享相同的最大功率，则将该情况标记为模糊。\n\n按如下方式构建合成的 full-f 涨落数据并实现诊断工具：\n\n1. 在副法向方向上定义一个具有 $N_y$ 个点的均匀空间网格，其域长度为 $L_y$（单位：米），以及一个具有 $N_t$ 个点的均匀时间网格，其持续时间为 $T$（单位：秒）。令离散坐标为 $y_j$（$j=0,\\dots,N_y-1$）和 $t_n$（$n=0,\\dots,N_t-1$）。\n2. 对于每个测试用例，生成一个信号\n   $$s(y,t) = \\sum_{p=1}^{N_{\\mathrm{waves}}} A_p \\cos(k_p y - \\omega_p t + \\phi_p) + \\eta(y,t),$$\n   其中 $A_p$ 是振幅（无量纲），$k_p$ 是波数（单位：rad/m），$\\omega_p$ 是角频率（单位：rad/s），$\\phi_p$ 是相位（单位：弧度），$\\eta(y,t)$ 是具有指定标准差 $\\sigma$（与 $s$ 单位相同）的加性零均值高斯噪声。在进行傅里叶变换之前，使用可复现的噪声种子，并在 $y$ 和 $t$ 两个维度上应用可分离的汉宁（Hann）窗函数。\n3. 计算加窗数据的二维离散傅里叶变换，以获得在离散网格上的 $S(k,\\omega)$\n   $$k_m = \\frac{2\\pi}{L_y} m,\\quad m = -\\frac{N_y}{2},\\dots,\\frac{N_y}{2}-1,$$\n   $$\\omega_\\ell = \\frac{2\\pi}{T} \\ell,\\quad \\ell = -\\frac{N_t}{2},\\dots,\\frac{N_t}{2}-1.$$\n   使用与上述连续定义一致的离散傅里叶变换定义，并计算功率谱密度 $P(k,\\omega) = |S(k,\\omega)|^2$。\n4. 将峰值搜索限制在 $k>0$。识别最大功率 $P_{\\max}$ 以及使 $P(k^*,\\omega^*)$ 在一个小的容差范围内达到 $P_{\\max}$ 的一组索引 $(k^*,\\omega^*)$。如果存在多个这样的 $(k^*,\\omega^*)$ 且 $k^*>0$，则将该情况分类为模糊。否则，计算 $v_{\\mathrm{ph}} = \\omega^*/k^*$ 并根据测试用例中定义的逆磁符号 $s_i$ 和 $s_e$ 对主导模进行分类。\n5. 处理边界条件：如果 $|k^*|$ 或 $|\\omega^*|$ 低于由网格间距设定的分辨率阈值（例如，低于半个单元格），则分类为模糊。\n\n实现程序以评估以下测试套件。所有角频率必须以 rad/s 为单位，波数以 rad/m 为单位，相位以弧度为单位，空间域长度以米为单位，时间持续以秒为单位。为了数值稳定性和可解释性，所提供的 $k_p$ 和 $\\omega_p$ 值与所选网格的精确离散频率单元格重合。\n\n令 $L_y = 10.0$ 且 $T = 1.0$。令 $N_y = 256$ 且 $N_t = 512$。令 $\\sigma = 0.10$ 并使用固定的随机种子。对于所有情况，设置离子逆磁符号 $s_i = -1$ 和电子逆磁符号 $s_e = +1$。\n\n定义波数单元格增量 $\\Delta k = \\frac{2\\pi}{L_y}$ 和角频率单元格增量 $\\Delta \\omega = \\frac{2\\pi}{T}$。\n\n- 测试用例 1（单个类 ITG 波）：\n  - 波：一个，其 $A_1 = 1.0$，$k_1 = 5\\Delta k = 3.141592653589793$ rad/m，$\\omega_1 = -2\\Delta \\omega = -12.566370614359172$ rad/s，$\\phi_1 = 0.2$ 弧度。\n- 测试用例 2（单个类 TEM 波）：\n  - 波：一个，其 $A_1 = 0.8$，$k_1 = 4\\Delta k = 2.5132741228718345$ rad/m，$\\omega_1 = +1\\Delta \\omega = 6.283185307179586$ rad/s，$\\phi_1 = 1.0$ 弧度。\n- 测试用例 3（在相同 $k$ 值下混合等幅反向传播导致模糊）：\n  - 波：两个，一个为 $A_1 = 1.0$，$k_1 = 6\\Delta k = 3.7699111843077517$ rad/m，$\\omega_1 = +3\\Delta \\omega = 18.84955592153876$ rad/s，$\\phi_1 = 0.5$ 弧度；另一个为 $A_2 = 1.0$，$k_2 = 6\\Delta k = 3.7699111843077517$ rad/m，$\\omega_2 = -3\\Delta \\omega = -18.84955592153876$ rad/s，$\\phi_2 = -0.3$ 弧度。\n- 测试用例 4（近奈奎斯特、高频类 TEM 波）：\n  - 波：一个，其 $A_1 = 0.6$，$k_1 = 120\\Delta k = 75.39822368615503$ rad/m，$\\omega_1 = 200\\Delta \\omega = 1256.6370614359173$ rad/s，$\\phi_1 = -1.2$ 弧度。\n\n您的程序必须为每个测试用例构建信号，使用汉宁窗函数计算二维离散傅里叶变换，在半平面 $k>0$ 中提取主导的 $(k^*,\\omega^*)$，计算相速度 $v_{\\mathrm{ph}} = \\omega^*/k^*$，并根据上述符号规则对模进行分类。如果在 $k>0$ 范围内有多个 $(k^*,\\omega^*)$ 在容差内达到相同的最大功率，或者如果 $|k^*|$ 或 $|\\omega^*|$ 低于半个单元格分辨率，则返回模糊分类。\n\n最终输出格式要求：\n\n- 您的程序应生成单行输出，其中包含四个测试用例的结果，格式为一个用方括号括起来的逗号分隔的整数列表，其中 $1$ 表示 ITG，$2$ 表示 TEM，$0$ 表示模糊（例如，“[1,2,0,2]”）。\n\n不允许用户输入；所有参数必须按照规定进行硬编码。实现必须在物理上和数值上自洽，并且必须遵守所描述的定义和标准。",
            "solution": "该问题要求为合成的涨落数据设计并实现一种频率-波数诊断工具，以模拟全分布函数（“full-f”）等离子体湍流代码的输出。目标是识别主导的谱模，并根据其传播方向将其分类为离子温度梯度（ITG）模或捕获电子模（TEM）。分析将在一系列测试用例上进行。\n\n问题陈述经确认为具有科学依据、问题定义清晰且完整。它基于等离子体动理学理论、傅里叶分析和数值信号处理的既定原则。获得唯一解所需的所有参数和条件均已提供。因此，我们可以着手求解。\n\n该诊断的核心在于将信号从时空域 $(y, t)$ 变换到频率-波数域 $(k, \\omega)$，在后一域中，波模表现为功率谱中的明显峰值。\n\n首先，我们定义数学和物理框架。一个由实值信号 $s(y,t)$ 表示的涨落，定义在一个二维网格上。副法向空间坐标为 $y \\in [0, L_y)$，时间坐标为 $t \\in [0, T)$。该信号由相干的类波结构和随机噪声分量的叠加组成：\n$$\ns(y,t) = \\sum_{p=1}^{N_{\\mathrm{waves}}} A_p \\cos(k_p y - \\omega_p t + \\phi_p) + \\eta(y,t)\n$$\n这里，对于每个波分量 $p$，$A_p$ 是振幅，$k_p$ 是波数，$\\omega_p$ 是角频率，$\\phi_p$ 是一个恒定的相移。项 $\\eta(y,t)$ 表示标准差为 $\\sigma$ 的零均值高斯噪声。\n\n主要的分析工具是二维傅里叶变换，它将信号分解为其组成的频率和波数。连续傅里叶变换由下式给出：\n$$\nS(k,\\omega) = \\int_{-\\infty}^{\\infty}\\int_{-\\infty}^{\\infty} s(y,t)\\,e^{-i(ky - \\omega t)}\\,dy\\,dt\n$$\n功率谱密度 $P(k,\\omega) = |S(k,\\omega)|^2$ 量化了信号功率在 $(k, \\omega)$ 平面上的分布。此谱中的峰值对应于信号中的主导波模。\n\n在数值上，信号在一个离散网格上采样：$y_j = j \\frac{L_y}{N_y}$（$j=0, \\dots, N_y-1$）和 $t_n = n \\frac{T}{N_t}$（$n=0, \\dots, N_t-1$）。连续傅里叶变换被二维离散傅里叶变换（DFT）所取代，后者通过快速傅里叶变换（FFT）算法高效计算。相应的离散波数和频率为：\n$$\nk_m = \\frac{2\\pi}{L_y} m, \\quad m \\in \\{-\\frac{N_y}{2}, \\dots, \\frac{N_y}{2}-1\\}\n$$\n$$\n\\omega_\\ell = \\frac{2\\pi}{T} \\ell, \\quad \\ell \\in \\{-\\frac{N_t}{2}, \\dots, \\frac{N_t}{2}-1\\}\n$$\n基本分辨率单元格为 $\\Delta k = 2\\pi/L_y$ 和 $\\Delta \\omega = 2\\pi/T$。\n\n数值谱分析中的一个关键步骤是应用窗函数。由于 DFT 假设信号在域上是周期的，有限信号的起点和终点之间的任何不连续性都会产生谱泄漏，即单个频率的功率“泄漏”到相邻的频率单元格中。为了减轻这种情况，我们将信号乘以一个在边界处平滑衰减至零的窗函数。使用可分离的二维汉宁（Hann）窗：\n$$\nw(y_j, t_n) = \\left(\\frac{1}{2} - \\frac{1}{2}\\cos\\frac{2\\pi j}{N_y}\\right) \\left(\\frac{1}{2} - \\frac{1}{2}\\cos\\frac{2\\pi n}{N_t}\\right)\n$$\n然后在加窗信号 $s'(y_j, t_n) = s(y_j, t_n) \\cdot w(y_j, t_n)$ 上执行 DFT。\n\n模的分类基于相速度 $v_{\\mathrm{ph}} = \\omega/k$。在托卡马克湍流的简化模型中，ITG 模沿离子逆磁方向传播，而 TEM 模沿电子逆磁方向传播。这些方向由符号 $s_i$ 和 $s_e$ 指定。对于本问题，$s_i = -1$ 和 $s_e = +1$，分别对应于负相速度和正相速度。\n由于信号 $s(y,t)$ 是实值的，其傅里叶谱表现出埃尔米特对称性：$S(k, \\omega) = S^*(-k, -\\omega)$，这意味着 $P(k, \\omega) = P(-k, -\\omega)$。因此，所有唯一的信息都包含在 $k$ 平面的一半中。我们将主导模的搜索限制在 $k > 0$ 的半平面。对于在 $k^* > 0$ 处找到的峰值 $(k^*, \\omega^*)$，相速度的符号就是频率的符号，即 $\\mathrm{sign}(v_{\\mathrm{ph}}) = \\mathrm{sign}(\\omega^*)$。\n\n分类逻辑如下：\n1.  在功率谱中找到最大功率 $P_{\\max}$ 的位置 $(k^*, \\omega^*)$，并将搜索限制在 $k > 0$。\n2.  检查模糊性。在以下情况下宣布为模糊情况：\n    a. 在搜索域中有多个 $(k, \\omega)$ 对的功率在数值容差范围内等于 $P_{\\max}$。这可以处理像等强度反向传播模这样的情况。\n    b. 主导模位于零频率处（即 $\\omega^*=0$），这对应于低于 $0.5 \\Delta \\omega$ 的频率分辨率阈值。在这种情况下，相速度是未明确定义的。对 $k^*$ 的条件通过在 $k>0$ 中搜索而自然满足。\n3.  如果模不模糊，则对其进行分类：\n    - 如果 $\\mathrm{sign}(\\omega^*) = s_i$，则为 ITG 模（分配代码 $1$）。\n    - 如果 $\\mathrm{sign}(\\omega^*) = s_e$，则为 TEM 模（分配代码 $2$）。\n    - 如果两个条件都不满足（对于非零 $\\omega^*$ 不应发生），则为模糊（代码 $0$）。\n\n实现将通过为每个测试用例构建信号，应用汉宁窗，执行二维 FFT，计算功率谱，并执行上述峰值查找和分类逻辑来进行。固定的随机种子确保了噪声分量的可复现性。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements a frequency-wavenumber diagnostic for synthetic plasma\n    fluctuation data to classify dominant turbulence modes.\n    \"\"\"\n    # Global parameters as specified in the problem statement\n    Ly = 10.0  # meters\n    T = 1.0    # seconds\n    Ny = 256   # spatial grid points\n    Nt = 512   # temporal grid points\n    sigma = 0.10 # standard deviation of Gaussian noise\n    random_seed = 42 # for reproducible noise\n    \n    # Diamagnetic direction signs\n    s_i = -1  # ion diamagnetic direction sign\n    s_e = +1  # electron diamagnetic direction sign\n    \n    # Fundamental frequency and wavenumber bins\n    delta_k = 2.0 * np.pi / Ly\n    delta_omega = 2.0 * np.pi / T\n\n    # Test case definitions\n    test_cases = [\n        # Case 1: Single ITG-like wave\n        [{'A': 1.0, 'k': 5 * delta_k, 'omega': -2 * delta_omega, 'phi': 0.2}],\n        # Case 2: Single TEM-like wave\n        [{'A': 0.8, 'k': 4 * delta_k, 'omega': 1 * delta_omega, 'phi': 1.0}],\n        # Case 3: Mixed equal-amplitude counter-propagating waves\n        [\n            {'A': 1.0, 'k': 6 * delta_k, 'omega': 3 * delta_omega, 'phi': 0.5},\n            {'A': 1.0, 'k': 6 * delta_k, 'omega': -3 * delta_omega, 'phi': -0.3}\n        ],\n        # Case 4: Near-Nyquist, high-frequency TEM-like wave\n        [{'A': 0.6, 'k': 120 * delta_k, 'omega': 200 * delta_omega, 'phi': -1.2}]\n    ]\n    \n    results = []\n    \n    # Create spatial and temporal grids\n    y = np.linspace(0, Ly, Ny, endpoint=False)\n    t = np.linspace(0, T, Nt, endpoint=False)\n    yy, tt = np.meshgrid(y, t)\n\n    # Create frequency and wavenumber axes for analysis\n    k_axis = np.fft.fftshift(np.fft.fftfreq(Ny, d=Ly/Ny) * 2.0 * np.pi)\n    omega_axis = np.fft.fftshift(np.fft.fftfreq(Nt, d=T/Nt) * 2.0 * np.pi)\n\n    # Initialize random number generator\n    rng = np.random.default_rng(random_seed)\n\n    for waves in test_cases:\n        # 1. Generate signal\n        signal = np.zeros((Nt, Ny))\n        for wave in waves:\n            signal += wave['A'] * np.cos(wave['k'] * yy - wave['omega'] * tt + wave['phi'])\n        \n        # Add reproducible Gaussian noise\n        noise = rng.normal(loc=0.0, scale=sigma, size=(Nt, Ny))\n        signal += noise\n        \n        # 2. Apply separable Hann window\n        hann_y = np.hanning(Ny)\n        hann_t = np.hanning(Nt)\n        window = np.outer(hann_t, hann_y)\n        signal_windowed = signal * window\n        \n        # 3. Compute 2D FFT and Power Spectral Density\n        S = np.fft.fft2(signal_windowed)\n        # Shift the zero-frequency component to the center of the spectrum\n        S_shifted = np.fft.fftshift(S)\n        P_shifted = np.abs(S_shifted)**2\n        \n        # 4. Peak search and classification\n        \n        # Restrict search to k > 0\n        k_positive_start_idx = Ny // 2 + 1\n        search_region = P_shifted[:, k_positive_start_idx:]\n        \n        if search_region.size == 0:\n            results.append(0) # Ambiguous if no k>0 region\n            continue\n\n        P_max = np.max(search_region)\n        \n        # Ambiguity check 1: multiple peaks with the same max power\n        # Use a relative tolerance to account for floating point inaccuracies.\n        peak_indices = np.argwhere(np.isclose(search_region, P_max, rtol=1e-3))\n        \n        if len(peak_indices) > 1:\n            results.append(0) # Ambiguous\n            continue\n\n        # Single dominant peak found\n        idx_omega_shifted, idx_k_sub = peak_indices[0]\n        \n        # Convert sub-region k index to full spectrum index\n        idx_k_shifted = idx_k_sub + k_positive_start_idx\n        \n        omega_star = omega_axis[idx_omega_shifted]\n        k_star = k_axis[idx_k_shifted]\n\n        # Ambiguity check 2: peak at or below resolution threshold\n        # |k*| > 0.5*delta_k is impossible due to k>0 search.\n        # Check if |omega*|  0.5*delta_omega, which means omega* = 0.\n        if np.isclose(omega_star, 0.0, atol=1e-9):\n            results.append(0) # Ambiguous\n            continue\n\n        # 5. Classify the mode\n        sign_v_ph = np.sign(omega_star) # since k_star > 0\n\n        if sign_v_ph == s_i:\n            results.append(1) # ITG\n        elif sign_v_ph == s_e:\n            results.append(2) # TEM\n        else:\n            results.append(0) # Ambiguous\n            \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}