{
    "hands_on_practices": [
        {
            "introduction": "The first step in any Particle-in-Cell (PIC) simulation is to initialize a set of macro-particles that accurately represents the initial physical state. In gyrokinetics, this requires careful consideration of the phase-space volume element because gyrocenter coordinates are non-canonical. The phase-space measure includes a Jacobian, often denoted $B^{\\star}_{\\parallel}$, which must be accounted for to correctly sample the distribution function and recover the desired density profile. This exercise  guides you through the fundamental principles of phase-space sampling in gyrokinetics, connecting abstract guiding-center theory to the concrete task of normalizing an equilibrium distribution.",
            "id": "4205894",
            "problem": "Consider a single-ion species of mass $m$ and charge $q$ in a slab geometry used for fusion plasma turbulence simulation with the Particle-In-Cell (PIC) method for gyrokinetics. Let the background magnetic field have constant magnitude $B_0$ and unit vector $\\boldsymbol{b}(\\boldsymbol{R})$ such that $\\boldsymbol{b} \\cdot \\nabla \\times \\boldsymbol{b} = \\tau$, where $\\tau$ is a constant (torsion), and assume the electrostatic limit with no fluctuating vector potential. The gyrocenter phase-space measure is $d^3 R \\, 2\\pi \\, d\\mu \\, dv_{\\parallel} \\, B^{\\star}_{\\parallel}/m$, where $B^{\\star}_{\\parallel}$ is the parallel component of the modified magnetic field $\\boldsymbol{B}^{\\star}$ that arises from the guiding-center transformation.\n\nAssume the equilibrium gyrocenter distribution function is spatially uniform in $\\boldsymbol{R}$ and separable in $\\mu$ and $v_{\\parallel}$,\n$$\nf_{\\mathrm{gc}}(\\boldsymbol{R},\\mu,v_{\\parallel}) = C \\, \\exp\\!\\left(-\\frac{m v_{\\parallel}^{2}}{2 T} - \\frac{\\mu B_0}{T}\\right),\n$$\nwith unknown normalization constant $C$, temperature $T$, and target constant number density $n_0$. Using only fundamental principles (phase-space volume preservation and correct noncanonical Jacobian for guiding centers), require that the physical number density at each $\\boldsymbol{R}$ satisfies\n$$\nn_0 \\;=\\; \\int_{-\\infty}^{\\infty} dv_{\\parallel} \\int_{0}^{\\infty} 2\\pi \\, d\\mu \\, \\frac{B^{\\star}_{\\parallel}}{m} \\, f_{\\mathrm{gc}}(\\boldsymbol{R},\\mu,v_{\\parallel}).\n$$\n\nStarting from the guiding-center, noncanonical Hamiltonian structure and Liouville theorem, determine $B^{\\star}_{\\parallel}$ for this geometry and compute the closed-form analytic expression for $C$ such that the above density constraint is exactly satisfied. Finally, explain the role of $B^{\\star}_{\\parallel}$ in the sampling of gyrocenter phase space in PIC, and justify whether its $v_{\\parallel}$-dependent part affects the value of $C$ for the given equilibrium. Your final answer must be the single analytic expression for $C$. No numerical rounding is required.",
            "solution": "The Particle-In-Cell (PIC) method for gyrokinetics represents the gyrocenter distribution by discrete markers and weights sampled from the correct phase-space measure. For guiding centers, the natural phase-space measure is noncanonical due to the transformation from particle coordinates to gyrocenter coordinates. The fundamental starting point is the guiding-center phase-space Lagrangian and Liouville theorem, which together imply that the phase-space volume element is preserved under the dynamics when written with the correct Jacobian factor. In gyrocenter coordinates $(\\boldsymbol{R}, \\mu, v_{\\parallel}, \\theta)$, where $\\boldsymbol{R}$ is the gyrocenter position, $\\mu$ is the magnetic moment, $v_{\\parallel}$ is the parallel velocity, and $\\theta$ is the gyrophase, the invariant measure is\n$$\nd^3 R \\, 2\\pi \\, d\\mu \\, dv_{\\parallel} \\, \\frac{B^{\\star}_{\\parallel}}{m},\n$$\nwhere $2\\pi$ arises from integrating over the gyrophase angle $\\theta$, and $B^{\\star}_{\\parallel}$ is the gyrocenter Jacobian factor that ensures phase-space volume preservation in the noncanonical variables.\n\nFrom guiding-center theory, the modified magnetic field is\n$$\n\\boldsymbol{B}^{\\star} = \\boldsymbol{B} + \\frac{m v_{\\parallel}}{q} \\nabla \\times \\boldsymbol{b},\n$$\nand its parallel component is\n$$\nB^{\\star}_{\\parallel} = \\boldsymbol{b} \\cdot \\boldsymbol{B}^{\\star} = B + \\frac{m v_{\\parallel}}{q} \\, \\boldsymbol{b} \\cdot \\nabla \\times \\boldsymbol{b}.\n$$\nIn the given geometry, $B(\\boldsymbol{R}) = B_0$ is constant and $\\boldsymbol{b} \\cdot \\nabla \\times \\boldsymbol{b} = \\tau$ is constant, hence\n$$\nB^{\\star}_{\\parallel}(v_{\\parallel}) = B_0 + \\frac{m v_{\\parallel}}{q} \\, \\tau.\n$$\n\nThe equilibrium gyrocenter distribution function is specified as\n$$\nf_{\\mathrm{gc}}(\\boldsymbol{R},\\mu,v_{\\parallel}) = C \\, \\exp\\!\\left(-\\frac{m v_{\\parallel}^{2}}{2 T} - \\frac{\\mu B_0}{T}\\right),\n$$\nwith $C$ to be determined so that the number density constraint is satisfied:\n$$\nn_0 = \\int_{-\\infty}^{\\infty} dv_{\\parallel} \\int_{0}^{\\infty} 2\\pi \\, d\\mu \\, \\frac{B^{\\star}_{\\parallel}(v_{\\parallel})}{m} \\, C \\, \\exp\\!\\left(-\\frac{m v_{\\parallel}^{2}}{2 T} - \\frac{\\mu B_0}{T}\\right).\n$$\nInsert $B^{\\star}_{\\parallel}(v_{\\parallel})$:\n$$\nn_0 = \\int_{-\\infty}^{\\infty} dv_{\\parallel} \\int_{0}^{\\infty} 2\\pi \\, d\\mu \\, \\frac{1}{m} \\left(B_0 + \\frac{m v_{\\parallel}}{q} \\tau\\right) C \\, \\exp\\!\\left(-\\frac{m v_{\\parallel}^{2}}{2 T} - \\frac{\\mu B_0}{T}\\right).\n$$\nSeparate the integral into two parts:\n$$\nn_0 = \\frac{2\\pi C}{m} \\left[ B_0 \\int_{-\\infty}^{\\infty} dv_{\\parallel} \\exp\\!\\left(-\\frac{m v_{\\parallel}^{2}}{2 T}\\right) \\int_{0}^{\\infty} d\\mu \\, \\exp\\!\\left(-\\frac{\\mu B_0}{T}\\right) \\right. \\\\\n\\left. + \\frac{m \\tau}{q} \\int_{-\\infty}^{\\infty} dv_{\\parallel} \\, v_{\\parallel} \\exp\\!\\left(-\\frac{m v_{\\parallel}^{2}}{2 T}\\right) \\int_{0}^{\\infty} d\\mu \\, \\exp\\!\\left(-\\frac{\\mu B_0}{T}\\right) \\right].\n$$\nEvaluate the $\\mu$-integral:\n$$\n\\int_{0}^{\\infty} d\\mu \\, \\exp\\!\\left(-\\frac{\\mu B_0}{T}\\right) = \\frac{T}{B_0}.\n$$\nEvaluate the Gaussian integrals over $v_{\\parallel}$. The even Gaussian integral is\n$$\n\\int_{-\\infty}^{\\infty} dv_{\\parallel} \\exp\\!\\left(-\\frac{m v_{\\parallel}^{2}}{2 T}\\right) = \\sqrt{\\frac{2\\pi T}{m}},\n$$\nand the odd Gaussian integral vanishes:\n$$\n\\int_{-\\infty}^{\\infty} dv_{\\parallel} \\, v_{\\parallel} \\exp\\!\\left(-\\frac{m v_{\\parallel}^{2}}{2 T}\\right) = 0.\n$$\nTherefore,\n$$\nn_0 = \\frac{2\\pi C}{m} \\left[ B_0 \\, \\sqrt{\\frac{2\\pi T}{m}} \\, \\frac{T}{B_0} + \\frac{m \\tau}{q} \\cdot 0 \\cdot \\frac{T}{B_0} \\right] = \\frac{2\\pi C}{m} \\, \\sqrt{\\frac{2\\pi T}{m}} \\, T.\n$$\nThus,\n$$\nn_0 = 2\\pi C \\, \\frac{T}{m} \\, \\sqrt{\\frac{2\\pi T}{m}}.\n$$\nSolve for $C$:\n$$\nC = \\frac{n_0}{2\\pi} \\, \\frac{m}{T} \\left(\\frac{m}{2\\pi T}\\right)^{\\frac{1}{2}} = n_0 \\left(\\frac{m}{2\\pi T}\\right)^{\\frac{3}{2}}.\n$$\n\nThis result matches the conventional Maxwellian normalization expressed in gyrocenter invariants when combined with the correct noncanonical Jacobian. The role of $B^{\\star}_{\\parallel}$ is to provide the correct phase-space Jacobian in the noncanonical guiding-center coordinates, ensuring Liouville invariance and thus correct density and moment evaluation in PIC sampling. In this geometry, $B^{\\star}_{\\parallel} = B_0 + (m v_{\\parallel}/q)\\tau$ contains a $v_{\\parallel}$-dependent term that is odd in $v_{\\parallel}$. For an isotropic equilibrium Maxwellian that is even in $v_{\\parallel}$, that odd contribution integrates to zero, so it does not affect the normalization constant $C$. However, for non-symmetric distributions (e.g., with parallel drifts), the $v_{\\parallel}$-dependent part of $B^{\\star}_{\\parallel}$ would contribute to moments and must be retained to avoid bias in sampling and diagnostics. In all cases, inclusion of $B^{\\star}_{\\parallel}$ in the measure is essential for physically consistent PIC sampling of gyrocenter phase space.",
            "answer": "$$\\boxed{n_0\\left(\\frac{m}{2\\pi T}\\right)^{\\frac{3}{2}}}$$"
        },
        {
            "introduction": "A defining feature of the gyrokinetic model is the replacement of fast particle gyromotion with an average over the gyro-ring, which is the primary mechanism through which particles interact with the electromagnetic fields. This practice  focuses on the numerical implementation and analysis of this crucial operator. You are challenged to determine the number of quadrature points needed to resolve the gyroaveraged field to a specified accuracy, providing direct insight into a core component of any gyrokinetic PIC code and the trade-offs between computational cost and numerical precision.",
            "id": "4205877",
            "problem": "Consider the Particle-In-Cell (PIC) method for gyrokinetics, where gyroaveraging of fields over fast gyromotion is required to correctly model the interaction between charged particles and electromagnetic fluctuations. The gyroaverage of a scalar field $\\phi$ at a guiding-center position $\\mathbf{R}$ with gyroradius $\\rho$ in the plane perpendicular to the background magnetic field is defined by the operator\n$$\n\\langle \\phi \\rangle(\\mathbf{R},\\rho) \\equiv \\frac{1}{2\\pi} \\int_{0}^{2\\pi} \\phi\\big(\\mathbf{R} + \\rho\\,\\hat{\\mathbf{e}}_\\perp(\\theta)\\big)\\, d\\theta,\n$$\nwhere $\\hat{\\mathbf{e}}_\\perp(\\theta)$ is the unit vector in the plane perpendicular to the background magnetic field rotated by angle $\\theta$. A ring-sum numerical scheme approximates this operator by uniformly sampling $N$ quadrature points around the ring:\n$$\n\\langle \\phi \\rangle_N(\\mathbf{R},\\rho) \\equiv \\frac{1}{N} \\sum_{j=0}^{N-1} \\phi\\big(\\mathbf{R} + \\rho\\,\\hat{\\mathbf{e}}_\\perp(\\theta_j)\\big), \\quad \\theta_j = \\frac{2\\pi j}{N}.\n$$\nIn the special case where $\\phi(\\mathbf{x})$ is a plane wave $\\exp\\big(i\\,\\mathbf{k}\\cdot \\mathbf{x}\\big)$ with perpendicular wavenumber magnitude $k_\\perp = \\|\\mathbf{k}_\\perp\\|$, the exact scalar factor produced by gyroaveraging is known analytically and is the zeroth-order Bessel function of the first kind evaluated at the dimensionless argument $a \\equiv k_\\perp \\rho$, specifically $J_0(a)$. Therefore, for a plane wave field, resolving the gyroaverage reduces to resolving $J_0(k_\\perp \\rho)$.\n\nYour task is to implement the ring-sum gyroaverage scheme for the plane-wave case and to estimate the minimal number of quadrature points $N$ needed so that the absolute error between the ring-sum and the exact analytic value $J_0(k_\\perp \\rho)$ is less than or equal to a specified tolerance $\\varepsilon$:\n$$\n\\left| \\frac{1}{N} \\sum_{j=0}^{N-1} \\exp\\big(i\\,a\\,\\cos \\theta_j\\big) - J_0(a) \\right| \\le \\varepsilon, \\quad a \\equiv k_\\perp \\rho, \\quad \\theta_j = \\frac{2\\pi j}{N}.\n$$\nThe scalar value to be resolved is $J_0(k_\\perp \\rho)$; there is no need to return the phase factor associated with $\\exp\\big(i\\,\\mathbf{k}\\cdot \\mathbf{R}\\big)$.\n\nRequirements:\n- Implement a function that, given $a$ and $N$, computes the ring-sum approximation\n$$\nA_N(a) \\equiv \\frac{1}{N} \\sum_{j=0}^{N-1} \\exp\\big(i\\,a\\,\\cos \\tfrac{2\\pi j}{N}\\big),\n$$\nand its absolute error with respect to $J_0(a)$.\n- Implement a search procedure that, given $a$, tolerance $\\varepsilon$, and an upper bound $N_{\\max}$, returns the minimal integer $N \\in \\{1,2,\\dots,N_{\\max}\\}$ such that the above error criterion is satisfied. If no such $N$ exists up to $N_{\\max}$, return $-1$.\n- All physical parameters must be treated with consistent units. Use $k_\\perp$ in $\\mathrm{m}^{-1}$ and $\\rho$ in $\\mathrm{m}$, so that $a = k_\\perp \\rho$ is dimensionless.\n- Angles must be in radians.\n\nTest suite:\nFor each tuple $(k_\\perp, \\rho, \\varepsilon, N_{\\max})$, compute $a = k_\\perp \\rho$, then estimate the minimal $N$ satisfying the tolerance. Use the following cases:\n- Case $1$: $k_\\perp = 100$, $\\rho = 1.0\\times 10^{-3}$, $\\varepsilon = 1.0\\times 10^{-10}$, $N_{\\max} = 512$.\n- Case $2$: $k_\\perp = 1.0\\times 10^{4}$, $\\rho = 1.0\\times 10^{-3}$, $\\varepsilon = 1.0\\times 10^{-8}$, $N_{\\max} = 4096$.\n- Case $3$: $k_\\perp = 0$, $\\rho = 3.0\\times 10^{-3}$, $\\varepsilon = 1.0\\times 10^{-12}$, $N_{\\max} = 64$.\n- Case $4$: $k_\\perp = 300$, $\\rho = 5.0\\times 10^{-3}$, $\\varepsilon = 1.0\\times 10^{-12}$, $N_{\\max} = 2048$.\n- Case $5$ (edge case, large argument): $k_\\perp = 2.0\\times 10^{5}$, $\\rho = 2.5\\times 10^{-4}$, $\\varepsilon = 1.0\\times 10^{-6}$, $N_{\\max} = 4096$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list of integers enclosed in square brackets, ordered as specified above, for example, $[N_1,N_2,N_3,N_4,N_5]$. There must be no additional output text.",
            "solution": "The Particle-In-Cell (PIC) method for gyrokinetics replaces the rapid gyromotion around magnetic field lines with an averaged effect over the gyroangle. The guiding-center position $\\mathbf{R}$ evolves on a slower timescale while the gyrophase $\\theta$ is averaged out. The gyroaverage of a scalar field $\\phi$ at fixed $\\mathbf{R}$ and gyroradius $\\rho$ is defined by\n$$\n\\langle \\phi \\rangle(\\mathbf{R},\\rho) = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\phi\\big(\\mathbf{R} + \\rho\\,\\hat{\\mathbf{e}}_\\perp(\\theta)\\big)\\, d\\theta,\n$$\nwhich is a consequence of averaging over uniform circular motion at angular frequency equal to the cyclotron frequency. In numerical PIC implementations, this integral is commonly approximated by a uniform quadrature on the ring, often referred to as a ring-sum:\n$$\n\\langle \\phi \\rangle_N(\\mathbf{R},\\rho) = \\frac{1}{N} \\sum_{j=0}^{N-1} \\phi\\big(\\mathbf{R} + \\rho\\,\\hat{\\mathbf{e}}_\\perp(\\theta_j)\\big), \\quad \\theta_j = \\frac{2\\pi j}{N}.\n$$\nTo design and analyze the scheme from first principles, consider the fundamental test field for spectral analysis: a plane wave $\\phi(\\mathbf{x}) = \\exp(i\\,\\mathbf{k}\\cdot\\mathbf{x})$. Writing $\\mathbf{k}$ as the sum of parallel and perpendicular components relative to the magnetic field, the dependence of the gyroaverage on the perpendicular component $\\mathbf{k}_\\perp$ isolates the essential behavior. Denote the perpendicular magnitude by $k_\\perp = \\|\\mathbf{k}_\\perp\\|$ and define a dimensionless parameter $a \\equiv k_\\perp \\rho$.\n\nSubstituting the plane wave into the continuous gyroaverage yields\n$$\n\\frac{1}{2\\pi} \\int_0^{2\\pi} \\exp\\Big(i\\,\\mathbf{k}\\cdot\\big(\\mathbf{R} + \\rho\\,\\hat{\\mathbf{e}}_\\perp(\\theta)\\big)\\Big)\\, d\\theta\n= \\exp(i\\,\\mathbf{k}\\cdot\\mathbf{R}) \\cdot \\frac{1}{2\\pi} \\int_0^{2\\pi} \\exp\\big(i\\,a\\,\\cos\\theta\\big)\\, d\\theta,\n$$\nwhere the identity $\\mathbf{k}_\\perp \\cdot \\hat{\\mathbf{e}}_\\perp(\\theta) = k_\\perp \\cos\\theta$ is used by aligning axes. The integral\n$$\n\\frac{1}{2\\pi} \\int_0^{2\\pi} \\exp\\big(i\\,a\\,\\cos\\theta\\big)\\, d\\theta\n$$\nevaluates to the zeroth-order Bessel function of the first kind $J_0(a)$, yielding the exact gyroaverage factor for a plane wave. Consequently, the continuous operator reduces to $J_0(a)$ for the scalar magnitude, with an overall phase $\\exp(i\\,\\mathbf{k}\\cdot\\mathbf{R})$ that is irrelevant for resolving the scalar factor.\n\nFor the ring-sum approximation with $N$ uniformly spaced angles $\\theta_j = 2\\pi j/N$, the discrete numerical approximation of the scalar factor is\n$$\nA_N(a) \\equiv \\frac{1}{N} \\sum_{j=0}^{N-1} \\exp\\big(i\\,a\\,\\cos\\theta_j\\big).\n$$\nTo understand its error relative to $J_0(a)$, one uses the Fourier series of the generating function (a fundamental identity derived from the Jacobi-Anger expansion):\n$$\n\\exp\\big(i\\,a\\,\\cos\\theta\\big) = \\sum_{m=-\\infty}^{\\infty} i^m J_m(a)\\, \\exp(i\\,m\\,\\theta),\n$$\nwhere $J_m$ is the $m$-th order Bessel function of the first kind. The continuous average over $\\theta$ eliminates all Fourier modes except $m=0$, recovering $J_0(a)$. The discrete sum over a uniform grid implements the trapezoidal rule on a periodic analytic function and exactly passes Fourier modes whose indices are integer multiples of $N$. Therefore,\n$$\nA_N(a) = \\sum_{q=-\\infty}^{\\infty} i^{qN} J_{qN}(a),\n$$\nand the error is the aliasing tail\n$$\nE_N(a) \\equiv A_N(a) - J_0(a) = \\sum_{q\\ne 0} i^{qN} J_{qN}(a).\n$$\nThis expression shows that the error is controlled by high-order Bessel functions $J_{qN}(a)$ at indices that are multiples of $N$. For fixed $a$, the magnitude of $J_n(a)$ decays rapidly with increasing $n$. A classical bound derived from the series definition of $J_n$ states\n$$\n|J_n(a)| \\le \\frac{(|a|/2)^n}{n!}, \\quad \\text{for all integers } n \\ge 0,\n$$\nwhich implies super-algebraic decay of aliasing terms with $N$. In practice, the dominant aliasing term is often $J_N(a)$, and ensuring that $|J_N(a)|$ is below the tolerance $\\varepsilon$ typically suffices to make the total error smaller than $\\varepsilon$.\n\nAlgorithmic design:\n- Compute the dimensionless argument $a = k_\\perp \\rho$ from input values in $\\mathrm{m}^{-1}$ and $\\mathrm{m}$, respectively.\n- For a given $N$, compute $A_N(a)$ by evaluating the uniform sum:\n$$\nA_N(a) = \\frac{1}{N} \\sum_{j=0}^{N-1} \\exp\\left(i\\,a\\,\\cos\\left(\\frac{2\\pi j}{N}\\right)\\right).\n$$\n- Evaluate the exact analytic target $J_0(a)$ using a reliable special function implementation.\n- Compute the absolute error:\n$$\n\\mathrm{err}(N;a) \\equiv \\left| A_N(a) - J_0(a) \\right|.\n$$\n- To estimate the minimal $N$ satisfying $\\mathrm{err}(N;a) \\le \\varepsilon$ within an upper bound $N_{\\max}$, perform a search over $N \\in \\{1,2,\\dots,N_{\\max}\\}$ and select the smallest $N$ satisfying the criterion. If no such $N$ exists up to $N_{\\max}$, return $-1$.\n- Special case: when $a = 0$, we have $A_N(0) = 1$ for any $N$, and $J_0(0) = 1$, so the minimal $N$ is $1$ for any tolerance.\n\nThis procedure is principle-based: it starts from the definition of gyroaverage in gyrokinetics, applies it to a plane wave to derive the exact $J_0(a)$ dependence, and constructs the discrete ring-sum as a trapezoidal rule in the gyroangle. The Fourier analysis demonstrates why the ring-sum converges rapidly and provides a physics-informed justification for searching the minimal number of quadrature points required to achieve a specified tolerance. The test suite includes a variety of regimes: small $a$ (Case $1$), moderate $a$ (Case $4$), zero $a$ (Case $3$), and large $a$ with tight tolerance (Cases $2$ and $5$), covering typical and challenging scenarios relevant to fusion plasma turbulence simulation.\n\nThe final program must output a single line containing the integer results $[N_1,N_2,N_3,N_4,N_5]$ for the specified cases, with no additional text.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import special\n\ndef ring_sum(a: float, N: int) -> complex:\n    \"\"\"\n    Compute the ring-sum approximation A_N(a) = (1/N) sum_{j=0}^{N-1} exp(i a cos(2Ï€ j / N)).\n    \"\"\"\n    # Handle trivial case to avoid unnecessary computation\n    if N <= 0:\n        raise ValueError(\"N must be a positive integer.\")\n    if a == 0.0:\n        return 1.0 + 0.0j\n    j = np.arange(N, dtype=np.float64)\n    thetas = (2.0 * np.pi * j) / N\n    values = np.exp(1j * a * np.cos(thetas))\n    return np.mean(values)\n\ndef estimate_min_N(a: float, tol: float, N_max: int) -> int:\n    \"\"\"\n    Estimate the minimal N (1 <= N <= N_max) such that |A_N(a) - J0(a)| <= tol,\n    where A_N(a) is the ring-sum approximation. If not found, return -1.\n    \"\"\"\n    # Exact analytic target\n    J0 = special.j0(a)\n    # Special case: a == 0 => exact for any N, choose N=1\n    if a == 0.0:\n        return 1\n\n    # Linear search over N, ensuring minimality\n    for N in range(1, N_max + 1):\n        A_N = ring_sum(a, N)\n        err = abs(A_N - J0)\n        if err <= tol:\n            return N\n    return -1\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case: (k_perp [1/m], rho [m], tol, N_max)\n    test_cases = [\n        (100.0, 1.0e-3, 1.0e-10, 512),\n        (1.0e4, 1.0e-3, 1.0e-8, 4096),\n        (0.0, 3.0e-3, 1.0e-12, 64),\n        (300.0, 5.0e-3, 1.0e-12, 2048),\n        (2.0e5, 2.5e-4, 1.0e-6, 4096),\n    ]\n\n    results = []\n    for k_perp, rho, tol, N_max in test_cases:\n        a = k_perp * rho  # Dimensionless\n        N_min = estimate_min_N(a, tol, N_max)\n        results.append(N_min)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "A robust numerical simulation must not only be accurate but must also respect the fundamental conservation laws of the physical system it models. Verifying that a discrete numerical scheme conserves quantities like energy is a cornerstone of code verification, providing strong evidence of a correct implementation. This practice  delves into this topic by having you implement a numerical diagnostic to test energy conservation in a 1D gyrokinetic system. You will verify an exact discrete conservation law that arises from a specific pairing of spatial difference operators, a powerful property of well-designed \"mimetic\" or \"structure-preserving\" algorithms.",
            "id": "4205831",
            "problem": "You are asked to design and implement a numerical diagnostic for energy conservation in a one-dimensional electrostatic gyrokinetic Particle-In-Cell (PIC) method in the long-wavelength limit. The goal is to compute the energy exchange between particles and fields over one timestep and verify that the net exchange matches the change in field energy, using a discretization that reflects the gyrokinetic polarization physics. Your program must produce results for a specified test suite and aggregate them into a single line of output.\n\nStart from the following fundamental base:\n\n- Electrostatics with quasineutrality and polarization in the long-wavelength gyrokinetic limit: the free charge density from particles, denoted by $\\rho_{\\mathrm{free}}(x,t)$, and the polarization charge density, denoted by $\\rho_{\\mathrm{pol}}(x,t)$, satisfy $\\rho_{\\mathrm{free}}(x,t) + \\rho_{\\mathrm{pol}}(x,t) = 0$.\n- The polarization charge density is modeled as $\\rho_{\\mathrm{pol}}(x,t) = -\\epsilon \\,\\partial_x^2 \\phi(x,t)$, where $\\phi(x,t)$ is the electrostatic potential and $\\epsilon$ is a constant representing the long-wavelength polarization coefficient $\\epsilon = n_0 m_i/B^2$ in normalized units.\n- The electrostatic field energy is $W_{\\mathrm{field}}(t) = \\frac{1}{2} \\int \\epsilon \\left(\\partial_x \\phi(x,t)\\right)^2 \\, dx$.\n- The energy exchange rate between particles and fields in this electrostatic gyrokinetic model follows from energy conservation: $\\frac{d}{dt} W_{\\mathrm{field}}(t) + \\int \\rho_{\\mathrm{free}}(x,t) \\,\\partial_t \\phi(x,t)\\, dx = 0$.\n\nDiscretize the domain, operators, and the time interval as follows:\n\n- Use a one-dimensional periodic domain of length $L$ with a uniform grid of $N$ points and spacing $\\Delta x = L/N$.\n- Represent fields on the grid at two successive times $t^n$ and $t^{n+1}$ by arrays $\\phi^n_i$ and $\\phi^{n+1}_i$ for $i = 0,1,\\dots,N-1$.\n- Use the forward difference for the spatial gradient:\n  $$\n  D_+ \\phi_i = \\frac{\\phi_{i+1} - \\phi_i}{\\Delta x}\n  $$\n- Use the backward difference for the divergence:\n  $$\n  D_- \\phi_i = \\frac{\\phi_i - \\phi_{i-1}}{\\Delta x}\n  $$\n- Use the second-order centered Laplacian constructed as $D_- D_+$:\n  $$\n  \\partial_x^2 \\phi_i \\approx \\frac{\\phi_{i+1} - 2\\phi_i + \\phi_{i-1}}{\\Delta x^2}\n  $$\n- Approximate spatial integrals as discrete sums with $\\int f(x)\\,dx \\approx \\sum_i f_i \\,\\Delta x$.\n- Approximate the time midpoint with the trapezoidal rule: define $\\phi^{\\mathrm{avg}}_i = \\frac{1}{2}(\\phi^n_i + \\phi^{n+1}_i)$ and $\\rho_{\\mathrm{free}}^{\\mathrm{avg}}_i = \\frac{1}{2}(\\rho_{\\mathrm{free}}^n{}_i + \\rho_{\\mathrm{free}}^{n+1}{}_i)$. Use quasineutrality to obtain the free charge from fields: $\\rho_{\\mathrm{free}}^n{}_i = \\epsilon \\,\\partial_x^2 \\phi^n_i$ and $\\rho_{\\mathrm{free}}^{n+1}{}_i = \\epsilon \\,\\partial_x^2 \\phi^{n+1}_i$.\n\nWith these definitions, compute over one timestep:\n\n- The particle-field energy exchange:\n  $$\n  Q_{\\mathrm{part}} = -\\sum_{i=0}^{N-1} \\rho_{\\mathrm{free}}^{\\mathrm{avg}}{}_i \\left(\\phi^{n+1}_i - \\phi^n_i\\right)\\,\\Delta x\n  $$\n- The change in field energy:\n  $$\n  \\Delta W_{\\mathrm{field}} = W_{\\mathrm{field}}^{n+1} - W_{\\mathrm{field}}^{n} = \\frac{1}{2}\\epsilon \\sum_{i=0}^{N-1} \\left[\\left(D_+ \\phi^{n+1}_i\\right)^2 - \\left(D_+ \\phi^{n}_i\\right)^2\\right] \\Delta x\n  $$\n\nCompute the absolute mismatch\n$$\nM = \\left| Q_{\\mathrm{part}} - \\Delta W_{\\mathrm{field}} \\right|\n$$\nfor each test case. In exact arithmetic with the specified discretization and periodic boundary conditions, $M$ should be extremely small due to a discrete integration-by-parts identity.\n\nUse normalized units throughout so no physical unit conversion is required. All angles must be in radians.\n\nImplement the following test suite. For each case, construct the grid $x_i = i\\,\\Delta x$ for $i=0,1,\\dots,N-1$, with $\\Delta x = L/N$, and define $\\phi^n_i$ and $\\phi^{n+1}_i$ explicitly as below.\n\n- Case 1 (smooth single mode, amplitude change):\n  - $N = 128$, $L = 2\\pi$, $\\epsilon = 1$.\n  - $k = 2$, $A = 0.3$, $\\delta A = 0.01$.\n  - $\\phi^n_i = A \\,\\sin(k x_i)$, $\\phi^{n+1}_i = (A + \\delta A)\\,\\sin(k x_i)$.\n- Case 2 (no change, exact zero):\n  - $N = 128$, $L = 2\\pi$, $\\epsilon = 1$.\n  - $k = 4$, $A = 0.25$.\n  - $\\phi^n_i = A \\,\\sin(k x_i)$, $\\phi^{n+1}_i = A \\,\\sin(k x_i)$.\n- Case 3 (two-mode combination with amplitude and phase changes):\n  - $N = 256$, $L = 2\\pi$, $\\epsilon = 0.5$.\n  - $k_1 = 3$, $k_2 = 5$, $A_1 = 0.2$, $A_2 = 0.1$, $A_1' = 0.205$, $A_2' = 0.095$, $\\delta\\varphi_1 = 0.02$, $\\delta\\varphi_2 = -0.015$.\n  - $\\phi^n_i = A_1 \\,\\sin(k_1 x_i) + A_2 \\,\\cos(k_2 x_i)$,\n    $\\phi^{n+1}_i = A_1' \\,\\sin(k_1 x_i + \\delta\\varphi_1) + A_2' \\,\\cos(k_2 x_i + \\delta\\varphi_2)$.\n- Case 4 (Nyquist mode, grid-scale oscillation):\n  - $N = 64$, $L = 2\\pi$, $\\epsilon = 1$.\n  - $k_{\\mathrm{nyq}} = N/2$ (integer), $A = 0.1$, $A' = 0.11$.\n  - $\\phi^n_i = A \\,\\cos(k_{\\mathrm{nyq}}\\, x_i)$, $\\phi^{n+1}_i = A' \\,\\cos(k_{\\mathrm{nyq}}\\, x_i)$.\n\nYour program should compute $M$ for each case and produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[m_1,m_2,m_3,m_4]$). The values should be real numbers (floats). Angles used in trigonometric functions must be in radians, and the grid must use periodic boundary conditions exactly as specified. No input is provided at runtime; all parameters of the test suite must be hardcoded in the program.",
            "solution": "The objective is to verify a discrete energy conservation law for a specific numerical scheme. The law states that the energy exchanged between particles and the electrostatic field, $Q_{\\mathrm{part}}$, should equal the change in the total energy stored in the field, $\\Delta W_{\\mathrm{field}}$, over a single time step. The problem provides discrete definitions for these quantities and we must show they are indeed equal, up to floating-point precision.\n\nThe two quantities to be compared are:\n1.  The energy exchange, $Q_{\\mathrm{part}} = -\\sum_{i=0}^{N-1} \\rho_{\\mathrm{free}}^{\\mathrm{avg}}{}_i \\left(\\phi^{n+1}_i - \\phi^n_i\\right)\\,\\Delta x$.\n2.  The change in field energy, $\\Delta W_{\\mathrm{field}} = \\frac{1}{2}\\epsilon \\sum_{i=0}^{N-1} \\left[\\left(D_+ \\phi^{n+1}_i\\right)^2 - \\left(D_+ \\phi^{n}_i\\right)^2\\right] \\Delta x$.\n\nWe will now demonstrate that the chosen discretization ensures $Q_{\\mathrm{part}} = \\Delta W_{\\mathrm{field}}$ algebraically.\n\nThe free charge is given by $\\rho_{\\mathrm{free}} = \\epsilon \\partial_x^2\\phi$. The time-averaged free charge density at grid point $i$ is discretized as:\n$$\n\\rho_{\\mathrm{free}}^{\\mathrm{avg}}{}_i = \\frac{1}{2}(\\rho_{\\mathrm{free}}^n{}_i + \\rho_{\\mathrm{free}}^{n+1}{}_i) = \\frac{1}{2} \\epsilon (D_- D_+ \\phi^n_i + D_- D_+ \\phi^{n+1}_i)\n$$\nSince the operator $D_-D_+$ is linear, this is equivalent to:\n$$\n\\rho_{\\mathrm{free}}^{\\mathrm{avg}}{}_i = \\epsilon D_- D_+ \\left( \\frac{\\phi^n_i + \\phi^{n+1}_i}{2} \\right) = \\epsilon D_- D_+ \\phi^{\\mathrm{avg}}_i\n$$\nSubstituting this into the expression for $Q_{\\mathrm{part}}$:\n$$\nQ_{\\mathrm{part}} = - \\sum_{i=0}^{N-1} \\epsilon (D_- D_+ \\phi^{\\mathrm{avg}}_i) (\\phi^{n+1}_i - \\phi^n_i) \\Delta x\n$$\nLet's denote the change in potential as $\\delta\\phi_i = \\phi^{n+1}_i - \\phi^{n}_i$.\n$$\nQ_{\\mathrm{part}} = - \\epsilon \\sum_{i=0}^{N-1} (D_- (D_+ \\phi^{\\mathrm{avg}}_i)) \\delta\\phi_i \\Delta x\n$$\nWe now apply the discrete summation-by-parts identity on a periodic grid, which states $\\sum_i a_i (D_- b_i) \\Delta x = - \\sum_i (D_+ a_i) b_i \\Delta x$. Let $a_i = \\delta\\phi_i$ and $b_i = D_+ \\phi^{\\mathrm{avg}}_i$. Applying the identity:\n$$\n\\sum_{i=0}^{N-1} \\delta\\phi_i (D_- (D_+ \\phi^{\\mathrm{avg}}_i)) \\Delta x = - \\sum_{i=0}^{N-1} (D_+ \\delta\\phi_i) (D_+ \\phi^{\\mathrm{avg}}_i) \\Delta x\n$$\nSubstituting this back into the expression for $Q_{\\mathrm{part}}$:\n$$\nQ_{\\mathrm{part}} = - \\epsilon \\left( - \\sum_{i=0}^{N-1} (D_+ \\delta\\phi_i) (D_+ \\phi^{\\mathrm{avg}}_i) \\Delta x \\right) = \\epsilon \\sum_{i=0}^{N-1} (D_+ \\delta\\phi_i) (D_+ \\phi^{\\mathrm{avg}}_i) \\Delta x\n$$\nNow, we expand the terms $\\delta\\phi_i$ and $\\phi^{\\mathrm{avg}}_i$:\n$$\nD_+ \\delta\\phi_i = D_+(\\phi^{n+1}_i - \\phi^n_i) = D_+\\phi^{n+1}_i - D_+\\phi^n_i\n$$\n$$\nD_+ \\phi^{\\mathrm{avg}}_i = D_+\\left(\\frac{\\phi^{n+1}_i + \\phi^n_i}{2}\\right) = \\frac{1}{2}(D_+\\phi^{n+1}_i + D_+\\phi^n_i)\n$$\nSubstituting these into the expression for $Q_{\\mathrm{part}}$:\n$$\nQ_{\\mathrm{part}} = \\epsilon \\sum_{i=0}^{N-1} (D_+\\phi^{n+1}_i - D_+\\phi^n_i) \\frac{1}{2}(D_+\\phi^{n+1}_i + D_+\\phi^n_i) \\Delta x\n$$\nUsing the algebraic identity $(a-b)(a+b) = a^2 - b^2$, the expression simplifies to:\n$$\nQ_{\\mathrm{part}} = \\frac{1}{2}\\epsilon \\sum_{i=0}^{N-1} \\left[ (D_+\\phi^{n+1}_i)^2 - (D_+\\phi^n_i)^2 \\right] \\Delta x\n$$\nThis expression is identical to the definition of $\\Delta W_{\\mathrm{field}}$. Thus, we have shown that with the specified discretizations, $Q_{\\mathrm{part}} = \\Delta W_{\\mathrm{field}}$. The calculated mismatch $M = |Q_{\\mathrm{part}} - \\Delta W_{\\mathrm{field}}|$ should be zero, or a very small number attributable to floating-point arithmetic errors.\n\nThe computational procedure for each test case is as follows:\n1.  Define the grid parameters $N$, $L$, and the physical constant $\\epsilon$.\n2.  Construct the spatial grid $x_i = i \\Delta x$ for $i = 0, \\dots, N-1$, where $\\Delta x = L/N$.\n3.  Generate the potential arrays $\\phi^n$ and $\\phi^{n+1}$ according to the specified formulas for the test case.\n4.  Compute $Q_{\\mathrm{part}}$:\n    a. Calculate the time-averaged potential $\\phi^{\\mathrm{avg}} = (\\phi^n + \\phi^{n+1})/2$.\n    b. Compute the discrete Laplacian of $\\phi^{\\mathrm{avg}}$: $\\text{Lap}(\\phi^{\\mathrm{avg}})_i = (\\phi^{\\mathrm{avg}}_{i+1} - 2\\phi^{\\mathrm{avg}}_i + \\phi^{\\mathrm{avg}}_{i-1})/\\Delta x^2$, respecting periodic boundaries.\n    c. Compute the time-averaged free charge density $\\rho_{\\mathrm{free}}^{\\mathrm{avg}} = \\epsilon \\cdot \\text{Lap}(\\phi^{\\mathrm{avg}})$.\n    d. Compute the potential difference $\\delta\\phi = \\phi^{n+1} - \\phi^n$.\n    e. Calculate $Q_{\\mathrm{part}} = -\\text{sum}(\\rho_{\\mathrm{free}}^{\\mathrm{avg}} \\cdot \\delta\\phi) \\cdot \\Delta x$.\n5.  Compute $\\Delta W_{\\mathrm{field}}$:\n    a. Compute the discrete forward gradients $D_+\\phi^n$ and $D_+\\phi^{n+1}$. For an array $\\psi$, $(D_+\\psi)_i = (\\psi_{i+1}-\\psi_i)/\\Delta x$, respecting periodic boundaries.\n    b. Square these gradient arrays element-wise.\n    c. Compute $\\Delta W_{\\mathrm{field}} = (1/2)\\epsilon \\cdot \\text{sum}((D_+\\phi^{n+1})^2 - (D_+\\phi^n)^2) \\cdot \\Delta x$.\n6.  Calculate the mismatch $M = |Q_{\\mathrm{part}} - \\Delta W_{\\mathrm{field}}|$.\n\nThis procedure is implemented for each of the four test cases. Case 2, where $\\phi^n = \\phi^{n+1}$, serves as a null test where both $Q_{\\mathrm{part}}$ and $\\Delta W_{\\mathrm{field}}$ should be identically zero. Case 4 tests the scheme's behavior for the highest-frequency mode resolvable on the grid (the Nyquist mode), where discrete operators can behave differently from their continuous counterparts. The identity is expected to hold in all cases.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the energy conservation mismatch for a 1D electrostatic gyrokinetic\n    PIC model using a specific finite-difference scheme.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"case_id\": 1,\n            \"N\": 128, \"L\": 2.0 * np.pi, \"epsilon\": 1.0,\n            \"params\": {\"k\": 2.0, \"A\": 0.3, \"deltaA\": 0.01},\n            \"phi_n_func\": lambda x, p: p[\"A\"] * np.sin(p[\"k\"] * x),\n            \"phi_n1_func\": lambda x, p: (p[\"A\"] + p[\"deltaA\"]) * np.sin(p[\"k\"] * x)\n        },\n        {\n            \"case_id\": 2,\n            \"N\": 128, \"L\": 2.0 * np.pi, \"epsilon\": 1.0,\n            \"params\": {\"k\": 4.0, \"A\": 0.25},\n            \"phi_n_func\": lambda x, p: p[\"A\"] * np.sin(p[\"k\"] * x),\n            \"phi_n1_func\": lambda x, p: p[\"A\"] * np.sin(p[\"k\"] * x)\n        },\n        {\n            \"case_id\": 3,\n            \"N\": 256, \"L\": 2.0 * np.pi, \"epsilon\": 0.5,\n            \"params\": {\n                \"k1\": 3.0, \"k2\": 5.0, \"A1\": 0.2, \"A2\": 0.1,\n                \"A1_prime\": 0.205, \"A2_prime\": 0.095,\n                \"d_phi1\": 0.02, \"d_phi2\": -0.015\n            },\n            \"phi_n_func\": lambda x, p: p[\"A1\"] * np.sin(p[\"k1\"] * x) + p[\"A2\"] * np.cos(p[\"k2\"] * x),\n            \"phi_n1_func\": lambda x, p: p[\"A1_prime\"] * np.sin(p[\"k1\"] * x + p[\"d_phi1\"]) + p[\"A2_prime\"] * np.cos(p[\"k2\"] * x + p[\"d_phi2\"])\n        },\n        {\n            \"case_id\": 4,\n            \"N\": 64, \"L\": 2.0 * np.pi, \"epsilon\": 1.0,\n            \"params\": {\"k_nyq\": 32.0, \"A\": 0.1, \"A_prime\": 0.11},\n            \"phi_n_func\": lambda x, p: p[\"A\"] * np.cos(p[\"k_nyq\"] * x),\n            \"phi_n1_func\": lambda x, p: p[\"A_prime\"] * np.cos(p[\"k_nyq\"] * x)\n        }\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        N = case[\"N\"]\n        L = case[\"L\"]\n        epsilon = case[\"epsilon\"]\n        params = case[\"params\"]\n\n        dx = L / N\n        x = np.linspace(0.0, L, N, endpoint=False)\n\n        # Generate potential fields at times t^n and t^{n+1}\n        phi_n = case[\"phi_n_func\"](x, params)\n        phi_n1 = case[\"phi_n1_func\"](x, params)\n\n        # ---- Calculate Q_part ----\n        \n        # Calculate time-averaged free charge density, rho_free_avg\n        # rho_free_avg = epsilon * laplacian(phi_avg)\n        # where phi_avg = (phi_n + phi_n1) / 2\n        phi_avg = 0.5 * (phi_n + phi_n1)\n        \n        # Discrete Laplacian operator D_- D_+ using periodic boundaries\n        # np.roll(phi, -1) gives phi_{i+1}\n        # np.roll(phi, 1)  gives phi_{i-1}\n        laplacian_phi_avg = (np.roll(phi_avg, -1) - 2.0 * phi_avg + np.roll(phi_avg, 1)) / (dx**2)\n        \n        rho_free_avg = epsilon * laplacian_phi_avg\n        \n        # Calculate potential difference\n        delta_phi = phi_n1 - phi_n\n        \n        # Calculate energy exchange Q_part\n        Q_part = -np.sum(rho_free_avg * delta_phi) * dx\n\n        # ---- Calculate Delta_W_field ----\n        \n        # Discrete forward difference operator D_+ using periodic boundaries\n        d_plus_phi_n = (np.roll(phi_n, -1) - phi_n) / dx\n        d_plus_phi_n1 = (np.roll(phi_n1, -1) - phi_n1) / dx\n\n        # Calculate field energy at each time\n        W_field_n_sq_term = d_plus_phi_n**2\n        W_field_n1_sq_term = d_plus_phi_n1**2\n        \n        # Calculate change in field energy Delta_W_field\n        delta_W_field = 0.5 * epsilon * np.sum(W_field_n1_sq_term - W_field_n_sq_term) * dx\n\n        # ---- Calculate the mismatch M ----\n        mismatch = np.abs(Q_part - delta_W_field)\n        results.append(mismatch)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}