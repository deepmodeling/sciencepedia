{
    "hands_on_practices": [
        {
            "introduction": "在应用任何复杂理论之前，首要任务是理解其有效性范畴。第一个练习  要求您计算真实天体物理环境下的基本等离子体参数，如离子回旋频率和拉莫尔半径。通过评估关键的无量纲参数 $k_{\\perp}\\rho_i$，您将直接判断回旋动理学近似是否适用于描述特定尺度上的湍流。",
            "id": "4216719",
            "problem": "考虑星系团中的团内介质 (Intracluster Medium, ICM)，将其建模为弱碰撞、磁化的氢等离子体。假设磁场强度大小均匀，为 $B = 1 \\times 10^{-6}\\,\\mathrm{G}$，数密度为 $n = 1 \\times 10^{-3}\\,\\mathrm{cm}^{-3}$。设离子为质子，其各向同性温度为 $T_i = 5\\,\\mathrm{keV}$。使用高斯单位制（厘米–克–秒，cgs）。从第一性原理出发，基于洛伦兹力 (Lorentz force) 和麦克斯韦–玻尔兹曼分布 (Maxwell–Boltzmann distribution)，推导离子回旋频率 $\\Omega_i$ 和离子热拉莫尔半径 $\\rho_i$，并计算特征垂直波数 $k_{\\perp} = 1 \\times 10^{-6}\\,\\mathrm{cm}^{-1}$ 下的有限拉莫尔半径参数 $k_{\\perp}\\rho_i$。然后，仅根据有限拉莫尔半径参数的量级，采用判据 $k_{\\perp}\\rho_i \\leq 1$ 作为有效性阈值，评估回旋动理学 (Gyrokinetic, GK) 理论的有效性。\n\n您可以使用以下常数：\n-   基本电荷（高斯 cgs）：$e = 4.803204712 \\times 10^{-10}\\,\\mathrm{statC}$。\n-   质子质量：$m_p = 1.672621923 \\times 10^{-24}\\,\\mathrm{g}$。\n-   光速：$c = 2.99792458 \\times 10^{10}\\,\\mathrm{cm/s}$。\n-   玻尔兹曼常数：$k_B = 1.380649 \\times 10^{-16}\\,\\mathrm{erg/K}$。\n-   电子伏特换算：$1\\,\\mathrm{eV} = 1.602176634 \\times 10^{-12}\\,\\mathrm{erg}$。\n\n说明：\n-   从洛伦兹力推导 $\\Omega_i$，并从麦克斯韦离子分布的热速度推导 $\\rho_i$。\n-   计算有序四元组 $(\\Omega_i, \\rho_i, k_{\\perp}\\rho_i, V)$，其中当 $k_{\\perp}\\rho_i \\leq 1$ 时 $V = 1$，否则 $V = 0$。\n-   将 $\\Omega_i$ 以 $\\mathrm{s}^{-1}$ 表示，$\\rho_i$ 以 $\\mathrm{cm}$ 表示，并将 $k_{\\perp}\\rho_i$ 和 $V$ 表示为无量纲量。\n-   将四元组的每个条目四舍五入到三位有效数字。\n-   以单行矩阵的形式，按 $(\\Omega_i, \\rho_i, k_{\\perp}\\rho_i, V)$ 的顺序提供您的最终数值答案。",
            "solution": "用户要求我解决一个等离子体物理学问题，具体涉及团内介质 (ICM)。\n\n### 问题验证\n\n**步骤 1：提取已知条件**\n-   磁场强度大小：$B = 1 \\times 10^{-6}\\,\\mathrm{G}$\n-   数密度：$n = 1 \\times 10^{-3}\\,\\mathrm{cm}^{-3}$\n-   离子（质子）各向同性温度：$T_i = 5\\,\\mathrm{keV}$\n-   特征垂直波数：$k_{\\perp} = 1 \\times 10^{-6}\\,\\mathrm{cm}^{-1}$\n-   单位制：高斯厘米–克–秒 (cgs)\n-   基本电荷：$e = 4.803204712 \\times 10^{-10}\\,\\mathrm{statC}$\n-   质子质量：$m_p = 1.672621923 \\times 10^{-24}\\,\\mathrm{g}$\n-   光速：$c = 2.99792458 \\times 10^{10}\\,\\mathrm{cm/s}$\n-   玻尔兹曼常数：$k_B = 1.380649 \\times 10^{-16}\\,\\mathrm{erg/K}$\n-   电子伏特换算：$1\\,\\mathrm{eV} = 1.602176634 \\times 10^{-12}\\,\\mathrm{erg}$\n-   回旋动理学 (GK) 有效性判据：$k_{\\perp}\\rho_i \\leq 1$\n-   输出定义：一个有序四元组 $(\\Omega_i, \\rho_i, k_{\\perp}\\rho_i, V)$，其中若 $k_{\\perp}\\rho_i \\leq 1$ 则 $V=1$，否则 $V=0$。\n\n**步骤 2：使用提取的已知条件进行验证**\n-   **科学依据：**该问题基于等离子体物理学的基本原理，包括洛伦兹力和麦克斯韦–玻尔兹曼统计。其应用涉及团内介质 (ICM)，给定的物理参数（$B$、$n$、$T_i$）是此类环境的典型值。回旋动理学的概念及其基于有限拉莫尔半径参数的有效性范围是等离子体理论中的一个标准课题。\n-   **定义明确：**该问题提供了计算所求量所需的所有必要数据和常数。任务规定清晰，可得出唯一的数值结果。数密度 $n$ 已给出但计算中无需使用；这不构成矛盾，只是额外信息。\n-   **客观性：**该问题以精确、技术性的语言陈述，没有任何主观或模棱两可的术语。\n\n**步骤 3：结论与行动**\n该问题是有效的。它具有科学合理性、定义明确且客观。我现在将着手求解。\n\n### 求解推导\n\n该问题要求计算离子回旋频率 $\\Omega_i$、离子热拉莫尔半径 $\\rho_i$、有限拉莫尔半径参数 $k_{\\perp}\\rho_i$ 以及一个有效性标志 $V$。\n\n**1. 离子回旋频率 ($\\Omega_i$)**\n\n带电粒子在磁场中的运动由洛伦兹力决定。在高斯 cgs 单位制中，对于电荷为 $e$、质量为 $m_p$ 的离子（质子），该力为：\n$$\n\\vec{F} = \\frac{e}{c} (\\vec{v} \\times \\vec{B})\n$$\n对于垂直于均匀磁场 $\\vec{B}$ 的运动，该力提供了圆周运动所需的向心力：\n$$\nF = m_p a_c = \\frac{m_p v_{\\perp}^2}{r}\n$$\n其中 $v_{\\perp}$ 是离子速度垂直于 $\\vec{B}$ 的分量，$r$ 是圆形路径的半径。洛伦兹力的大小为 $F = \\frac{e v_{\\perp} B}{c}$。令两个力相等，得到：\n$$\n\\frac{m_p v_{\\perp}^2}{r} = \\frac{e v_{\\perp} B}{c}\n$$\n这种回旋运动的角频率，即回旋频率 $\\Omega_i$，定义为 $\\Omega_i = v_{\\perp} / r$。重新整理力平衡方程以求解 $\\Omega_i$：\n$$\n\\Omega_i = \\frac{v_{\\perp}}{r} = \\frac{e B}{m_p c}\n$$\n代入给定值：\n$e = 4.803204712 \\times 10^{-10}\\,\\mathrm{statC}$\n$B = 1 \\times 10^{-6}\\,\\mathrm{G}$\n$m_p = 1.672621923 \\times 10^{-24}\\,\\mathrm{g}$\n$c = 2.99792458 \\times 10^{10}\\,\\mathrm{cm/s}$\n$$\n\\Omega_i = \\frac{(4.8032 \\times 10^{-10}) (1 \\times 10^{-6})}{(1.6726 \\times 10^{-24}) (2.9979 \\times 10^{10})} = \\frac{4.8032 \\times 10^{-16}}{5.0143 \\times 10^{-14}} \\approx 0.009579\\,\\mathrm{s}^{-1}\n$$\n\n**2. 离子热拉莫尔半径 ($\\rho_i$)**\n\n单个粒子的拉莫尔半径取决于其垂直速度 $v_{\\perp}$，即 $\\rho = v_{\\perp} / \\Omega_i$。对于给定温度下的粒子群，我们使用特征热速度来定义一个*热*拉莫尔半径。我们从麦克斯韦–玻尔兹曼分布推导这个速度。\n\n对于各向同性的温度 $T_i$，与每个自由度相关的平均动能是 $\\frac{1}{2} k_B T_i$。垂直于磁场的运动有两个自由度。因此，平均垂直动能是：\n$$\n\\langle \\frac{1}{2} m_p v_{\\perp}^2 \\rangle = 2 \\times \\frac{1}{2} k_B T_i = k_B T_i\n$$\n均方根垂直速度 $v_{th, \\perp} = \\sqrt{\\langle v_{\\perp}^2 \\rangle}$ 则为：\n$$\nv_{th, \\perp} = \\sqrt{\\frac{2 k_B T_i}{m_p}}\n$$\n问题给出的离子温度以能量单位表示，$T_i = 5\\,\\mathrm{keV}$。我们必须将其转换为尔格 (erg)，即 cgs 单位制中的能量单位，这等效于使用乘积 $k_B T_i$：\n$$\nT_{i, \\mathrm{erg}} = (5 \\times 10^3\\,\\mathrm{eV}) \\times (1.602176634 \\times 10^{-12}\\,\\mathrm{erg/eV}) = 8.01088 \\times 10^{-9}\\,\\mathrm{erg}\n$$\n现在我们计算热速度：\n$$\nv_{th, \\perp} = \\sqrt{\\frac{2 \\times (8.01088 \\times 10^{-9}\\,\\mathrm{erg})}{1.67262 \\times 10^{-24}\\,\\mathrm{g}}} \\approx \\sqrt{9.5788 \\times 10^{15}\\,\\mathrm{cm}^2/\\mathrm{s}^2} \\approx 9.7871 \\times 10^7\\,\\mathrm{cm/s}\n$$\n热拉莫尔半径 $\\rho_i$ 则为：\n$$\n\\rho_i = \\frac{v_{th, \\perp}}{\\Omega_i} = \\frac{9.7871 \\times 10^7\\,\\mathrm{cm/s}}{0.009579\\,\\mathrm{s}^{-1}} \\approx 1.0217 \\times 10^{10}\\,\\mathrm{cm}\n$$\n\n**3. 有限拉莫尔半径参数 ($k_{\\perp}\\rho_i$)**\n\n该参数比较了由 $1/k_{\\perp}$ 表征的涨落空间尺度与离子回旋半径 $\\rho_i$。\n给定 $k_{\\perp} = 1 \\times 10^{-6}\\,\\mathrm{cm}^{-1}$：\n$$\nk_{\\perp}\\rho_i = (1 \\times 10^{-6}\\,\\mathrm{cm}^{-1}) \\times (1.0217 \\times 10^{10}\\,\\mathrm{cm}) \\approx 1.0217 \\times 10^4\n$$\n这是一个无量纲量。\n\n**4. 回旋动理学有效性评估 ($V$)**\n\n问题提供了回旋动理学近似的有效性判据为 $k_{\\perp}\\rho_i \\leq 1$。我们的计算值为：\n$$\nk_{\\perp}\\rho_i \\approx 1.02 \\times 10^4\n$$\n由于 $1.02 \\times 10^4$ 远大于 $1$，该条件不满足。因此，在此判据下，对于给定的参数，回旋动理学模型无效。问题定义了一个标志 $V$，如果条件满足则 $V=1$，否则 $V=0$。因此：\n$$\nV = 0\n$$\n\n### 结果总结\n计算结果四舍五入到三位有效数字后为：\n-   $\\Omega_i \\approx 9.58 \\times 10^{-3}\\,\\mathrm{s}^{-1}$\n-   $\\rho_i \\approx 1.02 \\times 10^{10}\\,\\mathrm{cm}$\n-   $k_{\\perp}\\rho_i \\approx 1.02 \\times 10^4$\n-   $V = 0$\n\n最终答案是这些值的有序四元组。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n9.58 \\times 10^{-3} & 1.02 \\times 10^{10} & 1.02 \\times 10^{4} & 0\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "数值稳定性是成功模拟的基石，而时间步长通常是其中最关键的参数。在本练习  中，您将推导回旋动理学模型中最快的物理过程——平行流和 $\\mathbf{E} \\times \\mathbf{B}$ 漂移——对模拟时间步长的限制。这个练习将教您如何应用 Courant-Friedrichs-Lewy (CFL) 条件来确保您的显式时间积分方案保持稳定。",
            "id": "4216743",
            "problem": "考虑对以吸积盘冕为代表的热、磁化天体物理等离子体的静电回旋动理学方程进行显式时间积分。重点关注限制时间步长的平流过程：沿磁场的平行流和由电场叉磁场漂移引起的垂直平流。设计算网格是均匀的，沿磁场方向的间距为 $\\Delta z$，在一个垂直方向上的间距为 $\\Delta x$。最大稳定时间步长必须满足 Courant–Friedrichs–Lewy (CFL) 条件，该条件基于平流信息在一个时间步长内传播的距离不超过网格单元一小部分的要求。\n\n使用以下物理上一致的数据：\n- 磁场强度 $B = 0.01\\,\\mathrm{T}$。\n- 电子温度 $T_e = 1.0\\times 10^7\\,\\mathrm{K}$。\n- 静电势振幅 $\\phi = 150\\,\\mathrm{V}$。\n- 主导垂直涨落波数 $k_\\perp = 20\\,\\mathrm{m^{-1}}$。\n- 平行网格间距 $\\Delta z = 20\\,\\mathrm{m}$。\n- 垂直网格间距 $\\Delta x = 0.05\\,\\mathrm{m}$。\n- Courant 安全因子 $C_{\\mathrm{CFL}} = 0.5$。\n\n从一维中标量 $f$ 满足 $f_t + v\\,f_x = 0$ 的平流及其推广到回旋动理学平行流项 $v_\\parallel\\,\\partial f/\\partial z$ 和垂直电场叉磁场漂移平流 $\\mathbf{v}_E\\cdot\\nabla_\\perp f$ 开始。使用第一性原理为这两个过程推导显式时间步长 $\\Delta t$ 的 CFL 约束。使用麦克斯韦电子布居的热速度 $v_{\\mathrm{th},e}$ 估计电子平行流速度，并根据电势涨落所隐含的电场振幅估计垂直漂移速度 $v_E$。在国际单位制 (SI) 中，使用 $v_E = |\\mathbf{E}|/B$ 表示电场叉磁场漂移的大小。对于电场振幅，使用 $|\\mathbf{E}| \\simeq |\\nabla_\\perp \\phi| \\simeq k_\\perp \\phi$。忽略相对论修正。\n\n计算同时满足平行流和电场叉磁场漂移平流的 CFL 约束的最大允许显式时间步长 $\\Delta t_{\\max}$（单位为秒）。将您的答案四舍五入到三位有效数字，并以秒为单位表示。",
            "solution": "该问题是有效的。其科学依据在于计算等离子体物理的原理，特别是关于求解回旋动理学方程的数值格式的稳定性。所提供的数据在物理上是一致的，并且问题是适定的，会得出一个唯一的解。\n\nCourant–Friedrichs–Lewy (CFL) 条件是求解涉及平流的偏微分方程的显式时间积分格式稳定性的一个必要条件。对于形式为 $\\frac{\\partial f}{\\partial t} + v \\frac{\\partial f}{\\partial x} = 0$ 的一维平流方程，其中 $v$ 是平流速度，一个简单的显式有限差分格式的 CFL 条件指出，数值依赖域必须包含物理依赖域。这可转化为信息在单个时间步长内传播的距离不能超过一个网格单元的约束。对于具有 Courant 安全因子 $C_{\\mathrm{CFL}}$ 的格式，这表示为：\n$$|v| \\frac{\\Delta t}{\\Delta x} \\le C_{\\mathrm{CFL}}$$\n这给出了对于给定速度 $|v|$ 和网格间距 $\\Delta x$ 的最大稳定时间步长 $\\Delta t$：\n$$\\Delta t \\le C_{\\mathrm{CFL}} \\frac{\\Delta x}{|v|}$$\n\n问题要求我们考虑限制时间步长 $\\Delta t$ 的两个平流过程：平行流和垂直 $\\mathbf{E} \\times \\mathbf{B}$ 漂移。总的最大允许时间步长 $\\Delta t_{\\max}$ 必须同时满足这两个过程的 CFL 条件。\n\n此计算所需的物理常数是玻尔兹曼常数 $k_B \\approx 1.380649 \\times 10^{-23}\\,\\mathrm{J/K}$ 和电子质量 $m_e \\approx 9.109384 \\times 10^{-31}\\,\\mathrm{kg}$。\n\n首先，我们分析来自平行流的约束。回旋动理学方程中的平流项是 $v_\\parallel \\frac{\\partial f}{\\partial z}$。特征速度是平行粒子速度 $v_\\parallel$，相关的网格间距是平行网格间距 $\\Delta z$。最严格的约束来自最快的粒子。问题指示我们使用电子热速度 $v_{\\mathrm{th},e}$ 作为特征最大速度。麦克斯韦分布的热速度由以下公式给出：\n$$v_{\\mathrm{th},e} = \\sqrt{\\frac{k_B T_e}{m_e}}$$\n使用给定的电子温度 $T_e = 1.0 \\times 10^7\\,\\mathrm{K}$：\n$$v_{\\mathrm{th},e} = \\sqrt{\\frac{(1.380649 \\times 10^{-23}\\,\\mathrm{J/K}) \\times (1.0 \\times 10^7\\,\\mathrm{K})}{9.109384 \\times 10^{-31}\\,\\mathrm{kg}}} \\approx 1.231 \\times 10^7\\,\\mathrm{m/s}$$\n因此，平行流的 CFL 约束 $\\Delta t_\\parallel$ 为：\n$$\\Delta t_\\parallel \\le C_{\\mathrm{CFL}} \\frac{\\Delta z}{v_{\\mathrm{th},e}}$$\n使用给定值 $C_{\\mathrm{CFL}} = 0.5$ 和 $\\Delta z = 20\\,\\mathrm{m}$：\n$$\\Delta t_\\parallel \\le 0.5 \\times \\frac{20\\,\\mathrm{m}}{1.231 \\times 10^7\\,\\mathrm{m/s}} \\approx 8.123 \\times 10^{-7}\\,\\mathrm{s}$$\n\n其次，我们分析来自垂直 $\\mathbf{E} \\times \\mathbf{B}$ 漂移的约束。平流项是 $\\mathbf{v}_E \\cdot \\nabla_\\perp f$。特征速度是漂移速度的大小 $v_E = |\\mathbf{v}_E|$，相关的网格间距是垂直网格间距 $\\Delta x$。问题提供了漂移速度的公式：\n$$v_E = \\frac{|\\mathbf{E}|}{B}$$\n以及基于静电势涨落 $\\phi$ 和主导垂直波数 $k_\\perp$ 的电场强度的近似：\n$$|\\mathbf{E}| \\simeq |\\nabla_\\perp \\phi| \\simeq k_\\perp \\phi$$\n将这些结合起来，得到漂移速度的表达式：\n$$v_E \\simeq \\frac{k_\\perp \\phi}{B}$$\n使用给定值 $B = 0.01\\,\\mathrm{T}$，$\\phi = 150\\,\\mathrm{V}$ 和 $k_\\perp = 20\\,\\mathrm{m^{-1}}$：\n$$v_E \\simeq \\frac{(20\\,\\mathrm{m^{-1}}) \\times (150\\,\\mathrm{V})}{0.01\\,\\mathrm{T}} = \\frac{3000}{0.01}\\,\\mathrm{m/s} = 3.0 \\times 10^5\\,\\mathrm{m/s}$$\n垂直平流的 CFL 约束 $\\Delta t_\\perp$ 为：\n$$\\Delta t_\\perp \\le C_{\\mathrm{CFL}} \\frac{\\Delta x}{v_E}$$\n使用给定值 $C_{\\mathrm{CFL}} = 0.5$ 和 $\\Delta x = 0.05\\,\\mathrm{m}$：\n$$\\Delta t_\\perp \\le 0.5 \\times \\frac{0.05\\,\\mathrm{m}}{3.0 \\times 10^5\\,\\mathrm{m/s}} = \\frac{0.025}{3.0 \\times 10^5}\\,\\mathrm{s} \\approx 8.333 \\times 10^{-8}\\,\\mathrm{s}$$\n\n最后，为使显式时间积分稳定，时间步长 $\\Delta t$ 必须同时满足这两个约束。因此，最大允许时间步长 $\\Delta t_{\\max}$ 是各个限制中的最小值：\n$$\\Delta t_{\\max} = \\min(\\Delta t_\\parallel, \\Delta t_\\perp)$$\n比较计算出的值：\n$$\\Delta t_{\\max} = \\min(8.123 \\times 10^{-7}\\,\\mathrm{s}, 8.333 \\times 10^{-8}\\,\\mathrm{s}) = 8.333 \\times 10^{-8}\\,\\mathrm{s}$$\n在这种情况下，垂直 $\\mathbf{E} \\times \\mathbf{B}$ 平流对时间步长施加了更严格的约束。\n\n将结果四舍五入到三位有效数字，得到 $8.33 \\times 10^{-8}\\,\\mathrm{s}$。",
            "answer": "$$\\boxed{8.33 \\times 10^{-8}}$$"
        },
        {
            "introduction": "现在，我们从分析转向具体实现。最后一个练习  是一个编码实践，您将在此实现并验证回旋动理学模拟中两个最核心的算子。您需要数值上检验由贝塞尔函数 $J_0(k_{\\perp}\\rho)$ 表示的回旋平均算子的准确性，并确认用于平行流项的有限体积格式的守恒特性。",
            "id": "4216799",
            "problem": "考虑一个线性静电回旋动理学（GK）模型，用于描述在与坐标 $s$ 平行的均匀磁场中的单一离子种类。使用场向坐标系，其中垂直方向采用谱表示，而沿 $s$ 方向采用有限体积离散化。未知量是分布函数的非绝热部分 $g(s,v_\\parallel,\\mu,t)$，其中 $s$ 是沿磁力线的弧长，$v_\\parallel$ 是平行速度，$\\mu$ 是磁矩。假设磁场强度 $B$、粒子质量 $m$ 和电荷 $q$ 均为匀值。静电势 $\\phi$ 具有单一的垂直傅里叶模式，其波数为 $k_\\perp$，并且沿 $s$ 方向是周期的。沿 $s$ 方向显式地施加周期性边界条件。\n\n从经过充分检验的基本定律出发：Vlasov 方程和导心简化，在尺度分离和平均化之后可以得到 GK 方程。在线性、静电、无碰撞、均匀的极限下，当没有磁漂移且 $B$ 为常数时，GK 方程简化为 $g$ 的平行流，并带有一个与回旋平均静电势成正比的源项。在这种简化设定下，使用守恒的有限体积更新来离散化平行流项，并通过乘以一个回旋平均因子来谱方法表示垂直动力学。回旋平均算符通过在自变量 $k_\\perp \\rho$ 处求值的第一类零阶贝塞尔函数来实现，其中拉莫尔半径 $\\rho$ 通过导心定义与磁矩相关联。对平行流项使用带有迎风格式数值通量的时间显式更新。\n\n您的任务是：\n\n- 推导目标：从场向、线性、静电、无碰撞、均匀 $B$ 场的 GK 模型出发，识别平行流项的结构以及与回旋平均势耦合的源项。将回旋平均表示为 $k_\\perp$ 和 $\\rho$ 的函数的乘积，并通过导心定义将 $\\rho$ 与 $\\mu$、$B$、$m$ 和 $q$ 联系起来。\n\n- 沿 $s$ 方向的离散化目标：令 $s \\in [0,L_s]$ 被划分为 $N_s$ 个宽度为 $\\Delta s = L_s/N_s$ 的均匀有限体积，索引为 $i = 0,\\dots,N_s-1$。对于固定的 $v_\\parallel$，平行流项是 $g$ 以速度 $v_\\parallel$ 的平流。实现一个具有周期性边界条件的守恒迎风通量，使得单元平均值 $g_i^n$ 在一个时间步长 $\\Delta t$ 内的更新为\n$$\ng_i^{n+1} = g_i^n - \\frac{\\Delta t}{\\Delta s}\\left(F_{i+\\frac{1}{2}}^n - F_{i-\\frac{1}{2}}^n\\right),\n$$\n其中数值通量 $F_{i+\\frac{1}{2}}^n$ 根据 $v_\\parallel$ 的符号通过迎风格式选择，且 $F_{-\\frac{1}{2}}^n \\equiv F_{N_s-\\frac{1}{2}}^n$ 及 $F_{N_s+\\frac{1}{2}}^n \\equiv F_{\\frac{1}{2}}^n$（周期性环绕）。确保 Courant 数 $C \\equiv |v_\\parallel|\\Delta t/\\Delta s \\le 1$。\n\n- 回旋平均目标：对于给定的 $k_\\perp$，将回旋平均因子实现为 $\\rho$ 的函数，其中 $\\rho$ 通过导心关系从 $\\mu$ 计算得出。通过将解析因子与对回旋角的直接数值平均进行比较，来数值验证回旋平均。\n\n- 验证指标：\n  1. 解析回旋平均因子与在 $\\theta \\in [0,2\\pi]$ 上的直接数值回旋角积分之间的无量纲相对误差，\n  $$\n  \\varepsilon \\equiv \\sqrt{\\frac{\\sum_j \\left( A_j - N_j \\right)^2}{\\sum_j A_j^2}},\n  $$\n  其中 $A_j$ 是在第 $j$ 个 $\\rho$ 网格点上求值的解析回旋平均因子，$N_j$ 是相应的数值回旋角平均值。\n  2. 在周期性边界和零源项条件下，一次有限体积流更新前后的总质量（$g$ 在 $s$ 上的积分）之间的无量纲绝对差。\n\n在单个可运行程序中实现以下内容：\n\n- 使用从导心定义中导出的磁矩和垂直速度之间的关系。磁矩 $\\mu$ 和垂直速度 $v_\\perp$ 满足 $v_\\perp^2 = \\frac{2 \\mu B}{m}$，拉莫尔半径为 $\\rho = \\frac{v_\\perp}{\\Omega}$，其中回旋频率 $\\Omega = \\frac{q B}{m}$。使用这些关系从 $\\mu$、$B$、$m$ 和 $q$ 计算 $\\rho$。\n- 将解析回旋平均因子计算为在 $k_\\perp \\rho$ 处求值的第一类零阶贝塞尔函数。\n- 通过在 $\\theta \\in [0,2\\pi]$ 上均匀离散化并计算 $\\cos(k_\\perp \\rho \\cos\\theta)$ 的平均值，来计算数值回旋角平均。这对应于垂直相位因子的回旋角平均的实部。\n- 在一组 $\\rho$ 值上计算相对误差 $\\varepsilon$，该组 $\\rho$ 值由一个在 $v_\\perp$ 上的均匀网格生成，转换为 $\\mu$，然后再转换为 $\\rho$。\n- 使用具有周期性边界条件的守恒迎风通量离散化一个时间步的平行流更新，并计算绝对质量差。\n\n单位和数值规范：\n\n- 使用的单位如下：$B$ 为特斯拉（T），$m$ 为千克（kg），$q$ 为库仑（C），$k_\\perp$ 为米分之一（$\\mathrm{m}^{-1}$），$s$ 为米（m），$v_\\parallel$ 为米每秒（$\\mathrm{m/s}$），时间为秒（s），磁矩 $\\mu$ 为焦耳每特斯拉（$\\mathrm{J/T}$）。输出指标是无量纲浮点数。\n\n测试套件和参数：\n\n- 测试 1（回旋平均精度，正常路径）：$B = 5\\times 10^{-5}\\ \\mathrm{T}$，$m = 1.6726219\\times 10^{-27}\\ \\mathrm{kg}$，$q = 1.602176634\\times 10^{-19}\\ \\mathrm{C}$，$k_\\perp = 50\\ \\mathrm{m}^{-1}$，一个由 $v_\\perp \\in [0, 2\\times 10^{4}]\\ \\mathrm{m/s}$ 生成并映射到 $\\mu$ 再到 $\\rho$ 的 $N_\\mu = 256$ 个值的均匀网格，以及在 $[0,2\\pi]$ 上有 $N_\\theta = 4096$ 个点的回旋角网格。\n- 测试 2（回旋平均精度，边界情况 $k_\\perp = 0$）：与测试 1 相同的 $B$、$m$、$q$、$N_\\mu$、$N_\\theta$ 和 $v_\\perp$ 范围，但 $k_\\perp = 0\\ \\mathrm{m}^{-1}$。\n- 测试 3（回旋平均精度，大 $k_\\perp$ 边缘情况）：与测试 1 相同的 $B$、$m$、$q$、$N_\\mu$、$N_\\theta$ 和 $v_\\perp$ 范围，但 $k_\\perp = 500\\ \\mathrm{m}^{-1}$。\n- 测试 4（有限体积流质量守恒）：$L_s = 1\\ \\mathrm{m}$，$N_s = 64$，$v_\\parallel = 1000\\ \\mathrm{m/s}$，$\\Delta t = \\Delta s/|v_\\parallel|$，初始单元平均值 $g_i^0 = 1 + 0.1 \\sin\\left(2\\pi s_i/L_s\\right)$ 在单元中心 $s_i = (i+1/2)\\Delta s$ 处求值，并使用周期性边界条件和零源项执行单个时间步。\n\n最终输出格式：\n\n- 您的程序应生成单行输出，其中包含一个逗号分隔的列表，用方括号括起来（例如，$[result1,result2,result3,result4]$），其中 $result1$、$result2$ 和 $result3$ 分别是测试 1、2 和 3 的相对误差 $\\varepsilon$，$result4$ 是测试 4 的绝对质量差。所有输出必须是十进制浮点数。",
            "solution": "该问题要求实现和验证回旋动理学（GK）模拟代码的两个核心组件：回旋平均算符和平行流算符。验证基于基本原理和数值分析。\n\n首先，我们建立理论框架。对于在均匀磁场 $\\mathbf{B} = B \\mathbf{\\hat{s}}$ 中、无平衡漂移的单一离子种类，其线性、静电、无碰撞的 GK 方程由下式给出：\n$$\n\\frac{\\partial g}{\\partial t} + v_\\parallel \\frac{\\partial g}{\\partial s} = S(g, \\phi)\n$$\n这里，$g(s, v_\\parallel, \\mu, t)$ 是离子分布函数的非绝热部分，$s$ 是沿磁场的坐标，$v_\\parallel$ 是平行速度，$\\mu$ 是磁矩。项 $v_\\parallel \\frac{\\partial g}{\\partial s}$ 表示导心沿磁力线的平流，称为平行流。项 $S$ 表示与自洽静电势 $\\phi$ 相互作用产生的源。对于波数为 $k_\\perp$ 的单一垂直傅里叶模式，源项与回旋平均势成正比。\n\n一个场 $\\psi(\\mathbf{x})$ 的回旋平均是其在以导心位置 $\\mathbf{R}$ 为中心的回旋环上的平均值：\n$$\n\\langle \\psi \\rangle(\\mathbf{R}) = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\psi(\\mathbf{R} + \\boldsymbol{\\rho}(\\alpha)) d\\alpha\n$$\n其中 $\\boldsymbol{\\rho}$ 是大小为 $\\rho$、回旋角为 $\\alpha$ 的拉莫尔半径矢量。对于势的一个平面波分量 $\\phi_\\mathbf{k}(\\mathbf{x}) = \\hat{\\phi}_{\\mathbf{k}_\\perp} e^{i \\mathbf{k}_\\perp \\cdot \\mathbf{x}}$，其回旋平均为：\n$$\n\\langle \\phi_\\mathbf{k} \\rangle(\\mathbf{R}) = \\hat{\\phi}_{\\mathbf{k}_\\perp} e^{i \\mathbf{k}_\\perp \\cdot \\mathbf{R}} \\left( \\frac{1}{2\\pi} \\int_0^{2\\pi} e^{i \\mathbf{k}_\\perp \\cdot \\boldsymbol{\\rho}(\\alpha)} d\\alpha \\right)\n$$\n该积分的计算结果为第一类零阶贝塞尔函数 $J_0(k_\\perp \\rho)$。因此，傅里叶空间中的回旋平均算符的作用是乘以因子 $J_0(k_\\perp \\rho)$。问题指定使用相位因子的实部进行数值验证，这依赖于以下积分表示：\n$$\nJ_0(x) = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\cos(x \\cos\\theta) d\\theta\n$$\n拉莫尔半径 $\\rho$ 由粒子的性质和磁场决定。根据所提供的导心关系 $v_\\perp^2 = \\frac{2\\mu B}{m}$ 和 $\\rho = \\frac{v_\\perp}{\\Omega}$（其中 $\\Omega = \\frac{qB}{m}$），我们可以用 $\\mu$ 来表示 $\\rho$。将 $v_\\perp = \\sqrt{2\\mu B/m}$ 代入 $\\rho$ 的表达式中得到：\n$$\n\\rho = \\frac{\\sqrt{2\\mu B/m}}{qB/m} = \\frac{m}{qB} \\sqrt{\\frac{2\\mu B}{m}} = \\frac{\\sqrt{2m\\mu B}}{qB}\n$$\n另外，对于指定的任务而言，更直接的方法是通过 $\\rho = \\frac{m v_\\perp}{qB}$ 从 $v_\\perp$ 计算 $\\rho$。\n\n对于前三个测试，我们验证回旋平均的计算。生成一组包含 $N_\\mu=256$ 个值的拉莫尔半径 $\\rho_j$。对于每个 $\\rho_j$，我们计算解析回旋平均因子 $A_j = J_0(k_\\perp \\rho_j)$ 及其数值近似 $N_j$。该数值是通过使用 $N_\\theta=4096$ 个回旋角 $\\theta$ 点来离散化 $J_0(k_\\perp \\rho_j)$ 的积分计算得出的：\n$$\nN_j = \\frac{1}{N_\\theta} \\sum_{k=0}^{N_\\theta-1} \\cos(k_\\perp \\rho_j \\cos\\theta_k)\n$$\n精度由无量纲相对误差 $\\varepsilon$ 量化：\n$$\n\\varepsilon = \\sqrt{\\frac{\\sum_j (A_j - N_j)^2}{\\sum_j A_j^2}}\n$$\n\n对于第四个测试，我们验证平行流算符。平行流方程 $\\frac{\\partial g}{\\partial t} + v_\\parallel \\frac{\\partial g}{\\partial s} = 0$ 是一个线性平流方程。我们使用守恒有限体积法在包含 $N_s=64$ 个宽度为 $\\Delta s = L_s/N_s$ 的单元的均匀网格上对其进行离散化。单元 $i$ 中单元平均值 $g_i$ 的更新法则是：\n$$\ng_i^{n+1} = g_i^n - \\frac{\\Delta t}{\\Delta s} \\left( F_{i+\\frac{1}{2}}^n - F_{i-\\frac{1}{2}}^n \\right)\n$$\n其中 $F_{i\\pm 1/2}$ 是单元交界面上的数值通量。对于 $v_\\parallel > 0$ 的迎风格式，交界面 $i+1/2$ 处的通量由迎风单元 $i$ 中的状态决定，因此 $F_{i+1/2}^n = v_\\parallel g_i^n$。更新变为：\n$$\ng_i^{n+1} = g_i^n - \\frac{v_\\parallel \\Delta t}{\\Delta s} (g_i^n - g_{i-1}^n)\n$$\n问题指定的时间步长 $\\Delta t$ 使得 Courant 数 $C \\equiv v_\\parallel \\Delta t / \\Delta s = 1$。这将更新法则简化为：\n$$\ng_i^{n+1} = g_i^n - (g_i^n - g_{i-1}^n) = g_{i-1}^n\n$$\n在周期性边界条件下，这对应于将整个数值数组 $g_i^0$ 沿 $v_\\parallel$ 方向移动一个单元。具体来说，对于 $v_\\parallel > 0$，$g_i^1$ 是之前在单元 $i-1$ 中的值（其中 $g_0^1 = g_{N_s-1}^0$）。\n\n守恒律的守恒数值格式的一个关键特性是总积分量的守恒。对于平行流，总“质量” $M = \\int_0^{L_s} g(s) ds$ 必须守恒。在时间步 $n$ 的离散化总质量是 $M^n = \\sum_{i=0}^{N_s-1} g_i^n \\Delta s$。由于当 $C=1$ 时更新只是单元值的简单置换，因此 $\\sum_i g_i^{n+1} = \\sum_i g_i^n$。所以，$M^{n+1}=M^n$，离散质量在无限精度算术中是精确守恒的。验证指标是无量纲绝对差 $|\\sum_i g_i^1 - \\sum_i g_i^0|$，其值应该在浮点机器精度的量级。$g$ 的初始条件是无量纲的，这也使得这个差值是无量纲的。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import j0\n\ndef calculate_gyro_error(B, m, q, k_perp, N_mu, v_perp_max, N_theta):\n    \"\"\"\n    Calculates the relative error between analytic and numerical gyroaveraging.\n    \n    Args:\n        B (float): Magnetic field strength in Teslas.\n        m (float): Particle mass in kg.\n        q (float): Particle charge in Coulombs.\n        k_perp (float): Perpendicular wavenumber in m^-1.\n        N_mu (int): Number of points on the v_perp/mu/rho grid.\n        v_perp_max (float): Maximum perpendicular velocity in m/s.\n        N_theta (int): Number of points for numerical gyroangle integration.\n        \n    Returns:\n        float: The dimensionless relative error epsilon.\n    \"\"\"\n    # Create a uniform grid in perpendicular velocity.\n    v_perp_grid = np.linspace(0.0, v_perp_max, N_mu)\n    \n    # Calculate the Larmor radius grid.\n    # Cyclotron frequency Omega = q*B/m.\n    # Larmor radius rho = v_perp / Omega = m*v_perp / (q*B).\n    if q == 0 or B == 0:\n        # Avoid division by zero, though test cases are well-behaved.\n        # This case would correspond to infinite Larmor radius.\n        return np.inf\n    \n    omega = q * B / m\n    rho_grid = v_perp_grid / omega\n    \n    # 1. Analytic gyroaverage factor: J0(k_perp * rho)\n    analytic_factors = j0(k_perp * rho_grid)\n    \n    # 2. Numerical gyroaverage factor: average of cos(k_perp * rho * cos(theta))\n    # Using 'endpoint=False' for the theta grid is standard for periodic integrals.\n    theta_grid = np.linspace(0, 2 * np.pi, N_theta, endpoint=False)\n    \n    # Use numpy broadcasting for an efficient calculation across all rho values.\n    # rho_grid[:, np.newaxis] has shape (N_mu, 1).\n    # theta_grid has shape (N_theta,).\n    # cos(theta_grid) has shape (N_theta,).\n    # The argument to np.cos will have shape (N_mu, N_theta).\n    integration_args = k_perp * rho_grid[:, np.newaxis] * np.cos(theta_grid)\n    numerical_factors = np.mean(np.cos(integration_args), axis=1)\n    \n    # 3. Calculate the dimensionless relative error.\n    numerator = np.sum((analytic_factors - numerical_factors)**2)\n    denominator = np.sum(analytic_factors**2)\n    \n    # Handle the case where the denominator might be zero.\n    # For k_perp=0 (Test 2), analytic_factors are all 1, so denominator is N_mu != 0.\n    if denominator == 0.0:\n        return 0.0 if numerator == 0.0 else np.inf\n        \n    error = np.sqrt(numerator / denominator)\n    return error\n\ndef calculate_streaming_conservation(L_s, N_s, v_parallel):\n    \"\"\"\n    Calculates the mass conservation error for a single finite-volume streaming step.\n\n    Args:\n        L_s (float): Length of the periodic domain in s.\n        N_s (int): Number of finite volumes (cells).\n        v_parallel (float): Parallel streaming velocity in m/s.\n\n    Returns:\n        float: The dimensionless absolute difference in total mass.\n    \"\"\"\n    # Setup spatial grid and cell properties.\n    delta_s = L_s / N_s\n    # Cell centers grid s_i = (i+0.5)*delta_s\n    s_grid_centers = (np.arange(N_s) + 0.5) * delta_s\n    \n    # Set the initial condition for cell averages g_i^0.\n    g0 = 1.0 + 0.1 * np.sin(2 * np.pi * s_grid_centers / L_s)\n    \n    # The time step is chosen for a Courant number of 1.\n    # C = |v_parallel| * delta_t / delta_s = 1.\n    # The update for C=1 upwind is a simple shift.\n    \n    # Perform a single time-step update.\n    if v_parallel > 0:\n        # Upwind flux comes from the left (cell i-1).\n        # For C=1, this is g_i^1 = g_{i-1}^0.\n        # This is a right shift of the array.\n        g1 = np.roll(g0, 1)\n    elif v_parallel  0:\n        # Upwind flux comes from the right (cell i+1).\n        # For C=1, this is g_i^1 = g_{i+1}^0.\n        # This is a left shift of the array.\n        g1 = np.roll(g0, -1)\n    else: # v_parallel == 0\n        # No advection, solution does not change.\n        g1 = g0.copy()\n        \n    # Calculate total \"mass\" before and after.\n    # As g is dimensionless, sum(g) is the dimensionless total mass.\n    mass0 = np.sum(g0)\n    mass1 = np.sum(g1)\n    \n    # The problem asks for the dimensionless absolute mass difference.\n    abs_mass_difference = np.abs(mass1 - mass0)\n    \n    return abs_mass_difference\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print results.\n    \"\"\"\n    # ----- Test Parameters -----\n    # Common parameters for gyroaverage tests\n    B_common = 5e-5  # T\n    m_common = 1.6726219e-27  # kg (proton mass)\n    q_common = 1.602176634e-19  # C (proton charge)\n    N_mu_common = 256\n    v_perp_max_common = 2e4  # m/s\n    N_theta_common = 4096\n\n    test_cases = [\n        # Test 1: Gyroaverage accuracy, happy path\n        {'type': 'gyro', 'B': B_common, 'm': m_common, 'q': q_common, 'k_perp': 50.0,\n         'N_mu': N_mu_common, 'v_perp_max': v_perp_max_common, 'N_theta': N_theta_common},\n        \n        # Test 2: Gyroaverage accuracy, boundary case k_perp = 0\n        {'type': 'gyro', 'B': B_common, 'm': m_common, 'q': q_common, 'k_perp': 0.0,\n         'N_mu': N_mu_common, 'v_perp_max': v_perp_max_common, 'N_theta': N_theta_common},\n\n        # Test 3: Gyroaverage accuracy, large k_perp edge case\n        {'type': 'gyro', 'B': B_common, 'm': m_common, 'q': q_common, 'k_perp': 500.0,\n         'N_mu': N_mu_common, 'v_perp_max': v_perp_max_common, 'N_theta': N_theta_common},\n        \n        # Test 4: Finite-volume streaming mass conservation\n        {'type': 'stream', 'L_s': 1.0, 'N_s': 64, 'v_parallel': 1000.0}\n    ]\n\n    results = []\n    for case in test_cases:\n        if case['type'] == 'gyro':\n            result = calculate_gyro_error(\n                case['B'], case['m'], case['q'], case['k_perp'],\n                case['N_mu'], case['v_perp_max'], case['N_theta']\n            )\n        elif case['type'] == 'stream':\n            result = calculate_streaming_conservation(\n                case['L_s'], case['N_s'], case['v_parallel']\n            )\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}