{
    "hands_on_practices": [
        {
            "introduction": "非完整系统的核心特征在于其约束虽然不做功，却能深刻地影响系统的动力学行为。本练习  将引导您通过拉格朗日-达朗贝尔原理，精确计算无滑动约束对直立硬币平动动量的影响。这是一个基础性的实践，它将抽象的约束力概念具体化，揭示其如何改变动量，尽管它并不改变系统的总能量。",
            "id": "3759503",
            "problem": "考虑一个质量为 $m$、半径为 $R$ 的均匀、竖直、薄圆盘（“竖立的硬币”），在水平面上滚动。设 $(x,y)\\in\\mathbb{R}^{2}$ 表示圆盘中心的平面位置，$\\theta\\in \\mathbb{R}/2\\pi\\mathbb{Z}$ 表示圆盘直径的平面内朝向（航向），从 $x$ 轴开始测量。设 $\\phi\\in \\mathbb{R}/2\\pi\\mathbb{Z}$ 表示圆盘围绕其对称轴的自旋角。位形空间是二维特殊欧几里得群与一个圆的乘积，即 $\\mathrm{SE}(2)\\times S^{1}$。动能由下式给出\n$$\nT=\\frac{1}{2}m\\big(\\dot{x}^{2}+\\dot{y}^{2}\\big)+\\frac{1}{2}I_{\\theta}\\dot{\\theta}^{2}+\\frac{1}{2}I_{\\phi}\\dot{\\phi}^{2},\n$$\n其中 $I_{\\theta}$ 和 $I_{\\phi}$ 分别是与 $\\theta$ 和 $\\phi$ 相关联的轴的相应转动惯量。由于水平面约束了竖直运动，且重力被法向反作用力平衡，因此没有 $x$–$y$ 平面内的势能。\n\n假设存在禁止硬币侧向滑动的非完整无滑移约束：\n$$\n-\\dot{x}\\sin\\theta+\\dot{y}\\cos\\theta=0.\n$$\n这是一个线性的非完整（依赖于速度、不可积）约束，它定义了容许的速度分布 $\\mathcal{D}\\subset TQ$。非完整动力学由 Lagrange–d’Alembert 原理支配：其运动方程是 Euler–Lagrange 方程，其中的广义力等于约束反作用力，这些力位于约束分布的零化子 $\\mathcal{D}^{\\circ}$ 中。\n\n从 Lagrange–d’Alembert 原理和上述约束出发，推导平面平动动量\n$$\np_{x}=\\frac{\\partial T}{\\partial \\dot{x}}=m\\dot{x},\\qquad p_{y}=\\frac{\\partial T}{\\partial \\dot{y}}=m\\dot{y},\n$$\n在存在无滑移约束的情况下的演化方程，并明确说明约束力如何改变其变化率。将 $\\big(\\dot{p}_{x},\\dot{p}_{y}\\big)$ 的最终答案用与无滑移约束相关的 Lagrange 乘子 $\\lambda$ 和朝向 $\\theta$ 表示。\n\n使用一个行矩阵，将两个分量的最终答案作为一个单一的解析表达式提供。如果代入数值，每个分量都以牛顿为单位表示。",
            "solution": "该问题是有效的。它提出了一个非完整力学中的标准、适定的情景，该情景在科学上是合理的且内部一致。我们可以进行推导。\n\n系统的动力学由 Lagrange–d’Alembert 原理支配。系统的拉格朗日量 $L$ 等于其动能 $T$，因为势能为零。动能由下式给出：\n$$\nL = T = \\frac{1}{2}m\\big(\\dot{x}^{2}+\\dot{y}^{2}\\big)+\\frac{1}{2}I_{\\theta}\\dot{\\theta}^{2}+\\frac{1}{2}I_{\\phi}\\dot{\\phi}^{2}\n$$\n系统受到一个单一的非完整约束：\n$$\nC(q, \\dot{q}) = -\\dot{x}\\sin\\theta + \\dot{y}\\cos\\theta = 0\n$$\n该约束是一个普法夫约束，形式为 $\\sum_{i} \\omega_i(q)\\dot{q}^i = 0$。对于我们具有广义坐标 $q = (x, y, \\theta, \\phi)$ 的系统，相应的约束一形式为：\n$$\n\\omega = -\\sin\\theta \\, dx + \\cos\\theta \\, dy + 0 \\, d\\theta + 0 \\, d\\phi\n$$\nLagrange–d’Alembert 原理指出，运动方程由下式给出：\n$$\n\\frac{d}{dt}\\left(\\frac{\\partial L}{\\partial \\dot{q}^i}\\right) - \\frac{\\partial L}{\\partial q^i} = Q_i\n$$\n其中 $Q_i$ 是广义约束力。这些力由约束一形式和 Lagrange 乘子 $\\lambda$ 决定。总约束力余矢量（一形式）是 $\\lambda \\omega$。广义力 $Q_i$ 是此余矢量中 $dq^i$ 的系数。\n因此，对于我们的坐标，广义约束力为：\n$$\nQ_x = -\\lambda \\sin\\theta\n$$\n$$\nQ_y = \\lambda \\cos\\theta\n$$\n$$\nQ_\\theta = 0\n$$\n$$\nQ_\\phi = 0\n$$\n问题要求平面平动动量 $p_x$ 和 $p_y$ 的演化方程。我们通过将 Lagrange–d’Alembert 原理应用于坐标 $x$ 和 $y$ 来推导这些方程。\n\n对于 $x$ 坐标：\n与 $x$ 共轭的广义动量定义为 $p_x = \\frac{\\partial L}{\\partial \\dot{x}}$。\n$$\np_x = \\frac{\\partial}{\\partial \\dot{x}} \\left( \\frac{1}{2}m\\big(\\dot{x}^{2}+\\dot{y}^{2}\\big)+\\frac{1}{2}I_{\\theta}\\dot{\\theta}^{2}+\\frac{1}{2}I_{\\phi}\\dot{\\phi}^{2} \\right) = m\\dot{x}\n$$\n拉格朗日量不显式依赖于 $x$，因此 $\\frac{\\partial L}{\\partial x} = 0$。坐标 $x$ 是循环坐标。在没有约束的情况下，其共轭动量将是守恒的。\n$x$ 的运动方程为：\n$$\n\\frac{d}{dt}\\left(\\frac{\\partial L}{\\partial \\dot{x}}\\right) - \\frac{\\partial L}{\\partial x} = Q_x\n$$\n代入计算出的项：\n$$\n\\frac{d}{dt}(p_x) - 0 = -\\lambda \\sin\\theta\n$$\n$$\n\\dot{p}_x = -\\lambda \\sin\\theta\n$$\n这个方程表明，$x$ 动量的变化率等于约束力的 $x$ 分量。\n\n对于 $y$ 坐标：\n类似地，与 $y$ 共轭的广义动量为 $p_y = \\frac{\\partial L}{\\partial \\dot{y}}$。\n$$\np_y = \\frac{\\partial}{\\partial \\dot{y}} \\left( \\frac{1}{2}m\\big(\\dot{x}^{2}+\\dot{y}^{2}\\big)+\\frac{1}{2}I_{\\theta}\\dot{\\theta}^{2}+\\frac{1}{2}I_{\\phi}\\dot{\\phi}^{2} \\right) = m\\dot{y}\n$$\n拉格朗日量不显式依赖于 $y$，因此 $\\frac{\\partial L}{\\partial y} = 0$。坐标 $y$ 也是循环坐标。\n$y$ 的运动方程为：\n$$\n\\frac{d}{dt}\\left(\\frac{\\partial L}{\\partial \\dot{y}}\\right) - \\frac{\\partial L}{\\partial y} = Q_y\n$$\n代入计算出的项：\n$$\n\\frac{d}{dt}(p_y) - 0 = \\lambda \\cos\\theta\n$$\n$$\n\\dot{p}_y = \\lambda \\cos\\theta\n$$\n这个方程表明，$y$ 动量的变化率等于约束力的 $y$ 分量。\n\n向量 $(\\dot{p}_x, \\dot{p}_y)$ 代表作用在圆盘质心上的约束力，该力是为满足无滑移条件所必需的。这个力向量是 $(-\\lambda \\sin\\theta, \\lambda\\cos\\theta)$，它与圆盘的航向 $(\\cos\\theta, \\sin\\theta)$ 垂直，这与阻止侧向运动的力的预期相符。\n\n因此，平面平动动量的演化方程为：\n$$\n\\dot{p}_x = -\\lambda \\sin\\theta\n$$\n$$\n\\dot{p}_y = \\lambda \\cos\\theta\n$$\n按照要求，我们将 $(\\dot{p}_x, \\dot{p}_y)$ 的结果表示为单个表达式。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n-\\lambda\\sin\\theta  \\lambda\\cos\\theta\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "尽管非完整约束限制了系统在任一瞬间的运动方向——例如，硬币不能侧向滑动——但这并不意味着它的可达状态空间受到了限制。本实践  将带您探索这一迷人特性，即通过一系列允许的微小运动组合，实现“禁止”的运动。您将运用李括号这一强大的几何工具来分析系统的可控性，并从根本上理解如何为这类系统规划运动轨迹。",
            "id": "3759469",
            "problem": "考虑一个竖直滚动的圆盘，该模型为一个半径为 $r$ 的均匀圆盘，在水平面上无滑移地滚动。位形流形为 $Q = \\mathbb{R}^{2} \\times S^{1} \\times S^{1}$，坐标为 $(x,y,\\theta,\\phi)$，其中 $(x,y)$ 是接触点在平面上的位置，$\\theta$ 是体偏航（航向）角，$\\phi$ 是圆盘的自旋（滚动）角。无滑移滚动约束意味着接触点在平面上的瞬时速度为零。从无滑移约束的运动学形式和速度是位置对时间导数的定义出发，推导控制该圆盘的无漂移控制仿射系统 $\\dot{q} = u_{1} X_{1}(q) + u_{2} X_{2}(q)$，其中 $q = (x,y,\\theta,\\phi)$ 且 $u_{1},u_{2}$ 是容许控制。然后，对自旋速率施加硬饱和，使得对于给定的 $s \\ge 0$，$u_{1}$ 被约束在闭区间 $[-s,s]$ 内，而 $u_{2}$ 保持不受约束。仅使用第一性原理（特别是滚动约束、矢量场李括号的定义以及李代数秩条件），计算标量四维体积系数\n$$\n\\Delta = \\det\\begin{pmatrix}\nX_{1}  X_{2}  [X_{1},X_{2}]  [X_{2},[X_{1},X_{2}]]\n\\end{pmatrix},\n$$\n将列解释为这些矢量场在任意位形 $(x,y,\\theta,\\phi)$ 下，在坐标基 $(\\partial_{x},\\partial_{y},\\partial_{\\theta},\\partial_{\\phi})$ 中表示的分量。你的任务是：\n- 从约束中推导 $X_{1}$ 和 $X_{2}$，并计算 $[X_{1},X_{2}]$ 和 $[X_{2},[X_{1},X_{2}]]$。\n- 用 $r$ 和 $\\theta$ 解析地计算行列式 $\\Delta$。\n- 根据李代数秩条件和容许控制的结构，解释饱和 $u_{1}$ 如何影响小时间局部可达性，并描述可达性丧失时 $s$ 需满足的条件。\n\n将你最终报告的值表示为 $\\Delta$ 的精确闭式表达式。无需数值四舍五入，最终表达式中不应包含任何物理单位。如果出现角度，应以弧度处理。",
            "solution": "首先验证问题，确认其提法恰当、科学上合理且内部一致。我们可以开始求解。\n\n竖直滚动圆盘的位形由状态向量 $q = (x, y, \\theta, \\phi) \\in \\mathbb{R}^{2} \\times S^{1} \\times S^{1}$ 描述，其中 $(x,y)$ 是接触点在水平面上的坐标，$\\theta$ 是偏航角（航向），$\\phi$ 是圆盘的自旋角。圆盘的半径为 $r$。\n\n无滑移滚动约束决定了接触点 $(\\dot{x}, \\dot{y})$ 的速度。速度矢量必须平行于圆盘平面的方向，该方向由单位矢量 $(\\cos\\theta, \\sin\\theta)$ 给出。此速度的大小由滚动速率 $r \\dot{\\phi}$ 决定。综合这些，我们得到非完整约束方程：\n$$\n\\dot{x} = r \\dot{\\phi} \\cos\\theta\n$$\n$$\n\\dot{y} = r \\dot{\\phi} \\sin\\theta\n$$\n这两个方程描述了接触点的运动。方向角 $\\theta$ 和 $\\phi$ 的演化由它们各自的角速度，即偏航速率 $\\dot{\\theta}$ 和自旋速率 $\\dot{\\phi}$ 所控制。这些角速度是系统的自然控制输入。我们定义控制为 $u_{1} = \\dot{\\phi}$（自旋速率）和 $u_{2} = \\dot{\\theta}$（偏航速率）。\n\n将这些控制代入运动学方程，我们可以将系统动力学表示为状态空间形式 $\\dot{q} = f(q, u)$：\n$$\n\\dot{x} = r u_{1} \\cos\\theta\n$$\n$$\n\\dot{y} = r u_{1} \\sin\\theta\n$$\n$$\n\\dot{\\theta} = u_{2}\n$$\n$$\n\\dot{\\phi} = u_{1}\n$$\n该系统是无漂移控制仿射形式 $\\dot{q} = u_{1} X_{1}(q) + u_{2} X_{2}(q)$。通过收集乘以 $u_{1}$ 和 $u_{2}$ 的项，我们确定控制矢量场 $X_{1}$ 和 $X_{2}$：\n$$\nX_{1}(q) = \\begin{pmatrix} r\\cos\\theta \\\\ r\\sin\\theta \\\\ 0 \\\\ 1 \\end{pmatrix} \\quad , \\quad X_{2}(q) = \\begin{pmatrix} 0 \\\\ 0 \\\\ 1 \\\\ 0 \\end{pmatrix}\n$$\n在坐标基 $(\\partial_{x}, \\partial_{y}, \\partial_{\\theta}, \\partial_{\\phi})$ 中，这些矢量场是：\n$$\nX_{1} = r\\cos\\theta \\, \\partial_{x} + r\\sin\\theta \\, \\partial_{y} + \\partial_{\\phi}\n$$\n$$\nX_{2} = \\partial_{\\theta}\n$$\n接下来，我们计算所需的李括号。两个矢量场 $X$ 和 $Y$ 的李括号 $[X, Y]$ 可以使用公式 $[X,Y] = (\\nabla Y)X - (\\nabla X)Y$ 计算，其中 $\\nabla$ 是关于状态 $q$ 的雅可比算子。\n\n$X_{1}$ 关于 $q=(x,y,\\theta,\\phi)$ 的雅可比矩阵是：\n$$\n\\nabla X_{1} = \\frac{\\partial X_{1}}{\\partial q} = \\begin{pmatrix}\n\\partial_{x}X_{1x}  \\partial_{y}X_{1x}  \\partial_{\\theta}X_{1x}  \\partial_{\\phi}X_{1x} \\\\\n\\partial_{x}X_{1y}  \\partial_{y}X_{1y}  \\partial_{\\theta}X_{1y}  \\partial_{\\phi}X_{1y} \\\\\n\\partial_{x}X_{1\\theta}  \\partial_{y}X_{1\\theta}  \\partial_{\\theta}X_{1\\theta}  \\partial_{\\phi}X_{1\\theta} \\\\\n\\partial_{x}X_{1\\phi}  \\partial_{y}X_{1\\phi}  \\partial_{\\theta}X_{1\\phi}  \\partial_{\\phi}X_{1\\phi}\n\\end{pmatrix} = \\begin{pmatrix}\n0  0  -r\\sin\\theta  0 \\\\\n0  0  r\\cos\\theta  0 \\\\\n0  0  0  0 \\\\\n0  0  0  0\n\\end{pmatrix}\n$$\n矢量场 $X_{2}$ 是常数，因此其雅可比矩阵是零矩阵：$\\nabla X_{2} = \\mathbf{0}$。\n\n第一个李括号是 $[X_{1}, X_{2}]$：\n$$\n[X_{1}, X_{2}] = (\\nabla X_{2})X_{1} - (\\nabla X_{1})X_{2} = \\mathbf{0} \\cdot X_{1} - (\\nabla X_{1})X_{2} = -(\\nabla X_{1})X_{2}\n$$\n$$\n[X_{1}, X_{2}] = - \\begin{pmatrix}\n0  0  -r\\sin\\theta  0 \\\\\n0  0  r\\cos\\theta  0 \\\\\n0  0  0  0 \\\\\n0  0  0  0\n\\end{pmatrix} \\begin{pmatrix} 0 \\\\ 0 \\\\ 1 \\\\ 0 \\end{pmatrix} = - \\begin{pmatrix} -r\\sin\\theta \\\\ r\\cos\\theta \\\\ 0 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} r\\sin\\theta \\\\ -r\\cos\\theta \\\\ 0 \\\\ 0 \\end{pmatrix}\n$$\n该矢量场对应于通过交替转向和滚动产生的无穷小侧向运动。我们将其记为 $X_{3} = [X_{1}, X_{2}]$。\n\n第二个所需的李括号是 $[X_{2}, [X_{1}, X_{2}]] = [X_{2}, X_{3}]$。\n$$\n[X_{2}, X_{3}] = (\\nabla X_{3})X_{2} - (\\nabla X_{2})X_{3} = (\\nabla X_{3})X_{2} - \\mathbf{0} \\cdot X_{3} = (\\nabla X_{3})X_{2}\n$$\n首先，我们计算 $X_{3}$ 的雅可比矩阵：\n$$\n\\nabla X_{3} = \\frac{\\partial X_{3}}{\\partial q} = \\begin{pmatrix}\n0  0  r\\cos\\theta  0 \\\\\n0  0  -(-r\\sin\\theta)  0 \\\\\n0  0  0  0 \\\\\n0  0  0  0\n\\end{pmatrix} = \\begin{pmatrix}\n0  0  r\\cos\\theta  0 \\\\\n0  0  r\\sin\\theta  0 \\\\\n0  0  0  0 \\\\\n0  0  0  0\n\\end{pmatrix}\n$$\n现在我们计算该括号：\n$$\n[X_{2}, [X_{1}, X_{2}]] = \\begin{pmatrix}\n0  0  r\\cos\\theta  0 \\\\\n0  0  r\\sin\\theta  0 \\\\\n0  0  0  0 \\\\\n0  0  0  0\n\\end{pmatrix} \\begin{pmatrix} 0 \\\\ 0 \\\\ 1 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} r\\cos\\theta \\\\ r\\sin\\theta \\\\ 0 \\\\ 0 \\end{pmatrix}\n$$\n这产生了一个新的矢量场，记为 $X_{4}$，它代表了在不改变自旋角 $\\phi$ 的情况下的前向运动。\n\n现在我们计算标量四维体积系数 $\\Delta$。这是由我们已确定的四个矢量场 $X_{1}$、$X_{2}$、$ [X_{1}, X_{2}]$ 和 $[X_{2}, [X_{1}, X_{2}]]$ 作为列构成的矩阵的行列式。\n$$\n\\Delta = \\det \\begin{pmatrix} X_{1}  X_{2}  [X_{1},X_{2}]  [X_{2},[X_{1},X_{2}]] \\end{pmatrix}\n$$\n$$\n\\Delta = \\det \\begin{pmatrix}\nr\\cos\\theta  0  r\\sin\\theta  r\\cos\\theta \\\\\nr\\sin\\theta  0  -r\\cos\\theta  r\\sin\\theta \\\\\n0  1  0  0 \\\\\n1  0  0  0\n\\end{pmatrix}\n$$\n我们通过代数余子式展开来计算行列式。沿着第二列展开，该列仅在位置 $(3,2)$ 有一个非零项：\n$$\n\\Delta = (-1)^{3+2} \\cdot 1 \\cdot \\det \\begin{pmatrix}\nr\\cos\\theta  r\\sin\\theta  r\\cos\\theta \\\\\nr\\sin\\theta  -r\\cos\\theta  r\\sin\\theta \\\\\n1  0  0\n\\end{pmatrix} = - \\det \\begin{pmatrix}\nr\\cos\\theta  r\\sin\\theta  r\\cos\\theta \\\\\nr\\sin\\theta  -r\\cos\\theta  r\\sin\\theta \\\\\n1  0  0\n\\end{pmatrix}\n$$\n接下来，我们沿第三行展开这个 $3 \\times 3$ 行列式：\n$$\n\\Delta = - \\left( (-1)^{3+1} \\cdot 1 \\cdot \\det \\begin{pmatrix}\nr\\sin\\theta  r\\cos\\theta \\\\\n-r\\cos\\theta  r\\sin\\theta\n\\end{pmatrix} \\right) = - \\left( 1 \\cdot ((r\\sin\\theta)(r\\sin\\theta) - (r\\cos\\theta)(-r\\cos\\theta)) \\right)\n$$\n$$\n\\Delta = - (r^{2}\\sin^{2}\\theta + r^{2}\\cos^{2}\\theta) = -r^{2}(\\sin^{2}\\theta + \\cos^{2}\\theta)\n$$\n$$\n\\Delta = -r^{2}\n$$\n该行列式是一个常数值 $-r^{2}$，与位形 $(x,y,\\theta,\\phi)$ 无关。\n\n最后，我们分析小时间局部可达性（STLA）。李代数秩条件（LARC）指出，如果一个无漂移系统的控制矢量场生成的李代数在点 $q$ 处张成其切空间，则该系统在点 $q$ 是小时间局部可达的。我们的位形流形 $Q$ 的维数是 $4$。该李代数由控制场及其所有迭代括号张成。我们已找到一组 $4$ 个矢量 $\\{X_{1}, X_{2}, [X_{1},X_{2}], [X_{2},[X_{1},X_{2}]]\\}$，它们的线性无关性由行列式 $\\Delta$ 决定。\n由于 $r$ 是一个物理半径，$r0$，这意味着 $\\Delta = -r^{2} \\neq 0$。因此，这四个矢量场在每个点 $q$ 处都是线性无关的，并张成切空间 $T_{q}Q$。由 $\\{X_{1}, X_{2}\\}$ 生成的李代数处处秩为 $4$。\n\n对于有控制约束的系统，如果容许控制值集合 $U$ 在其内部包含原点，则 LARC 保证 STLA。这里，控制集合是 $U = [-s, s] \\times \\mathbb{R}$。\n\n情况 1：$s  0$。$u_{1}$ 的控制集是区间 $[-s, s]$，它包含 $0$ 作为内点。$u_{2}$ 的控制集是 $\\mathbb{R}$，它也包含 $0$ 在其内部。由于原点 $(0,0)$ 是控制域 $U$ 的一个内点，并且 LARC 被满足（秩为 $4$），因此该系统是小时间局部可达的。对 $u_{1}$ 的饱和限制了机动的速度，但并未消除在位形空间中向所有方向移动的能力。\n\n情况 2：$s = 0$。约束变为 $u_{1}=0$。控制系统退化为 $\\dot{q} = u_{2} X_{2}(q)$。唯一可用的控制矢量场是 $X_{2}$。由 $\\{X_{2}\\}$ 生成的李代数仅仅是 $\\text{span}\\{X_{2}\\}$（因为 $[X_2, X_2]=0$），这是一个一维空间。李代数的秩为 $1$，小于流形维数 $4$。LARC 被违反。从任何初始状态出发，系统只能改变其 $\\theta$ 坐标，而 $x, y$ 和 $\\phi$ 保持不变。系统不是 STLA。\n\n因此，当且仅当饱和限制 $s$ 恰好为零时，小时间局部可达性才会丧失。\n\n问题要求 $\\Delta$ 的解析表达式。\n$$\n\\Delta = -r^{2}\n$$\n这是所需的最终解析表达式。",
            "answer": "$$\\boxed{-r^{2}}$$"
        },
        {
            "introduction": "理论分析揭示了“什么”和“为何”，而数值模拟则向我们展示了“如何”。这个终极动手实践  邀请您亲自构建一个非完整系统的仿真程序，将抽象的运动方程转化为生动的视觉轨迹。您的挑战在于设计一个“保结构”积分器，它不仅能计算出运动轨迹，还能在数值上严格遵守物理定律，即精确地维持约束并近似地守恒能量，从而确保模拟的真实性和长期稳定性。",
            "id": "3759448",
            "problem": "为非完整约束的垂直硬币实现、论证并评估一种保结构的时间步进方法。该垂直硬币被理想化为一个半径为 $R$ 的刚性薄圆盘，在水平面上无滑滚动。其构型变量为 $q = (x, y, \\psi, \\phi)$，其中 $x$ 和 $y$ 是硬币中心的笛卡尔坐标，$\\psi$ 是硬币的偏航角（朝向） (单位为弧度)，$\\phi$ 是自旋角（绕硬币对称轴的转动） (单位为弧度)。硬币的速度为 $v = (\\dot{x}, \\dot{y}, \\dot{\\psi}, \\dot{\\phi})$。拉格朗日量是纯动能的，$L(q, v) = T(v)$，其动能由对角质量矩阵指定\n$$\nM = \\mathrm{diag}(m, m, I_{\\psi}, I_{\\phi}),\n$$\n因此\n$$\nT(v) = \\frac{1}{2} v^{\\mathsf{T}} M v = \\frac{1}{2} \\left( m \\dot{x}^{2} + m \\dot{y}^{2} + I_{\\psi} \\dot{\\psi}^{2} + I_{\\phi} \\dot{\\phi}^{2} \\right).\n$$\n假设没有势能，也没有外力。非完整滚动约束在速度上是线性的，由以下公式给出\n$$\n\\dot{x} - R \\dot{\\phi} \\cos \\psi = 0, \\quad \\dot{y} - R \\dot{\\phi} \\sin \\psi = 0,\n$$\n这些约束定义了一个约束分布 $D(q) \\subset T_{q}Q$，即在构型 $q$ 处满足上述等式的速度 $v$ 的集合。\n\n从力学的第一性原理（牛顿定律和 Lagrange–d’Alembert 原理）出发，设计并实现一种时间步进方法，该方法需满足：\n- 在每一步中，以一种与在适当离散构型（使用中点构型来定义约束）下评估的约束分布 $D(q)$ 相一致的方式强制施加非完整约束。\n- 是保结构的，即它能将约束分布 $D(q)$ 维持在数值精度范围内，并且在没有外力的情况下近似守恒动能。\n\n您的方法必须是自洽的，并从一个有效的力学原理推导而来；不要使用临时的修正。特别地，您必须在速度层面上处理约束，并论证它们是如何在您的积分器中被强制施加的。角度必须以弧度为单位处理。所有物理单位都必须指定并遵守：$x$ 和 $y$ 单位为米，$R$ 单位为米，$m$ 单位为千克，$I_{\\psi}$ 和 $I_{\\phi}$ 单位为千克-平方米，时间单位为秒，角度量单位为弧度，速度单位为米/秒或弧度/秒，能量单位为焦耳。\n\n为了进行评估，为每次模拟定义以下度量指标：\n- 所有步中的最大约束违反幅度，\n$$\n\\max_{n} \\left\\| A(q_{n+\\frac{1}{2}}) \\, v_{n+1} \\right\\|,\n$$\n其中 $A(q)$ 是编码约束的 $2 \\times 4$ 矩阵，使得 $A(q) v = \\begin{bmatrix}\\dot{x} - R \\dot{\\phi} \\cos \\psi \\\\ \\dot{y} - R \\dot{\\phi} \\sin \\psi \\end{bmatrix}$，$q_{n+\\frac{1}{2}} = q_{n} + \\frac{h}{2} v_{n}$ 是用于评估约束的中点构型，$h$ 是时间步长 (单位为秒)，$\\|\\cdot\\|$ 是欧几里得范数 (单位为米/秒)。\n- 能量漂移，\n$$\n\\Delta T = T(v_{\\mathrm{final}}) - T(v_{\\mathrm{init}}),\n$$\n单位为焦耳，其中 $T$ 是动能，$v_{\\mathrm{init}}$ 是从给定的初始条件执行一个保约束步后的第一个投影后速度，$v_{\\mathrm{final}}$ 是最后一个时间步的速度。\n\n实现您的方法，并在以下测试套件上进行评估。在每种情况下，角度都以弧度为单位，所有其他量均使用指定的物理单位。\n\n测试用例 1 (典型参数，中等步长):\n- $m = 1.0 \\, \\mathrm{kg}$, $R = 0.3 \\, \\mathrm{m}$, $I_{\\psi} = 0.12 \\, \\mathrm{kg \\, m^{2}}$, $I_{\\phi} = 0.045 \\, \\mathrm{kg \\, m^{2}}$。\n- $h = 0.01 \\, \\mathrm{s}$, $\\text{steps} = 1000$。\n- 初始构型 $q_{0} = (0.0 \\, \\mathrm{m}, 0.0 \\, \\mathrm{m}, 0.7 \\, \\mathrm{rad}, 0.0 \\, \\mathrm{rad})$。\n- 初始角速度 $\\dot{\\phi}_{0} = 5.0 \\, \\mathrm{rad/s}$, $\\dot{\\psi}_{0} = 0.5 \\, \\mathrm{rad/s}$；设置 $\\dot{x}_{0} = R \\dot{\\phi}_{0} \\cos \\psi_{0}$ 和 $\\dot{y}_{0} = R \\dot{\\phi}_{0} \\sin \\psi_{0}$。\n\n测试用例 2 (小时间步长，需要修正的初始约束违反):\n- $m = 0.8 \\, \\mathrm{kg}$, $R = 0.25 \\, \\mathrm{m}$, $I_{\\psi} = 0.10 \\, \\mathrm{kg \\, m^{2}}$, $I_{\\phi} = 0.03 \\, \\mathrm{kg \\, m^{2}}$。\n- $h = 10^{-4} \\, \\mathrm{s}$, $\\text{steps} = 5000$。\n- 初始构型 $q_{0} = (0.0 \\, \\mathrm{m}, 0.0 \\, \\mathrm{m}, 1.2 \\, \\mathrm{rad}, 0.0 \\, \\mathrm{rad})$。\n- 初始速度 $\\dot{x}_{0} = 0.1 \\, \\mathrm{m/s}$, $\\dot{y}_{0} = 0.0 \\, \\mathrm{m/s}$, $\\dot{\\psi}_{0} = -2.0 \\, \\mathrm{rad/s}$, $\\dot{\\phi}_{0} = 3.0 \\, \\mathrm{rad/s}$。\n\n测试用例 3 (大时间步长以探究能量行为):\n- $m = 1.2 \\, \\mathrm{kg}$, $R = 0.35 \\, \\mathrm{m}$, $I_{\\psi} = 0.20 \\, \\mathrm{kg \\, m^{2}}$, $I_{\\phi} = 0.06 \\, \\mathrm{kg \\, m^{2}}$。\n- $h = 0.1 \\, \\mathrm{s}$, $\\text{steps} = 300$。\n- 初始构型 $q_{0} = (0.0 \\, \\mathrm{m}, 0.0 \\, \\mathrm{m}, 0.2 \\, \\mathrm{rad}, 0.0 \\, \\mathrm{rad})$。\n- 初始角速度 $\\dot{\\phi}_{0} = 4.0 \\, \\mathrm{rad/s}$, $\\dot{\\psi}_{0} = 1.5 \\, \\mathrm{rad/s}$；设置 $\\dot{x}_{0} = R \\dot{\\phi}_{0} \\cos \\psi_{0}$ 和 $\\dot{y}_{0} = R \\dot{\\phi}_{0} \\sin \\psi_{0}$。\n\n测试用例 4 (高偏航率，中等步长):\n- $m = 0.9 \\, \\mathrm{kg}$, $R = 0.28 \\, \\mathrm{m}$, $I_{\\psi} = 0.15 \\, \\mathrm{kg \\, m^{2}}$, $I_{\\phi} = 0.04 \\, \\mathrm{kg \\, m^{2}}$。\n- $h = 0.02 \\, \\mathrm{s}$, $\\text{steps} = 800$。\n- 初始构型 $q_{0} = (0.0 \\, \\mathrm{m}, 0.0 \\, \\mathrm{m}, 1.0 \\, \\mathrm{rad}, 0.0 \\, \\mathrm{rad})$。\n- 初始角速度 $\\dot{\\phi}_{0} = 3.0 \\, \\mathrm{rad/s}$, $\\dot{\\psi}_{0} = 10.0 \\, \\mathrm{rad/s}$；设置 $\\dot{x}_{0} = R \\dot{\\phi}_{0} \\cos \\psi_{0}$ 和 $\\dot{y}_{0} = R \\dot{\\phi}_{0} \\sin \\psi_{0}$。\n\n您的程序必须：\n- 实现指定的保结构方法。\n- 对每个测试用例，模拟系统并计算两个度量指标：以 $\\mathrm{m/s}$ 为单位的最大约束违反幅度和以 $\\mathrm{J}$ 为单位的能量漂移，如上文所定义。\n- 生成单行输出，其中包含聚合结果，形式为方括号内由逗号分隔的列表，每个测试用例贡献一个包含两个浮点数的列表 $[\\text{max\\_violation}, \\Delta T]$。最终格式必须是\n$$\n\\big[ [\\text{case1\\_max\\_violation}, \\text{case1\\_energy\\_drift}], [\\text{case2\\_max\\_violation}, \\text{case2\\_energy\\_drift}], [\\text{case3\\_max\\_violation}, \\text{case3\\_energy\\_drift}], [\\text{case4\\_max\\_violation}, \\text{case4\\_energy\\_drift}] \\big].\n$$\n角度单位为弧度，能量单位为焦耳，约束违反幅度单位为米/秒。",
            "solution": "该问题要求为垂直滚动硬币的非完整动力学设计并实现一种保结构的时间步进方法。该方法必须从第一性原理推导，并正确处理非完整约束。\n\n### 基于原理的积分器推导\n\n系统的动力学由 Lagrange–d’Alembert 原理控制。拉格朗日量是纯动能的，$L(q, \\dot{q}) = T(\\dot{q}) = \\frac{1}{2}\\dot{q}^{\\mathsf{T}} M \\dot{q}$，并且不依赖于构型 $q$。系统受到形如 $A(q)\\dot{q} = 0$ 的线性速度约束。运动方程为：\n$$\n\\begin{cases}\nM\\ddot{q} = A(q)^{\\mathsf{T}} \\lambda \\\\\nA(q)\\dot{q} = 0\n\\end{cases}\n$$\n其中 $\\lambda$ 是表示约束力的拉格朗日乘子向量。\n\n为了构造一个保结构的数值积分器，我们以一种尊重其底层几何结构的方式对这些方程进行离散化。我们寻求一个在时间步长 $h$ 上的格式 $(q_n, v_n) \\mapsto (q_{n+1}, v_{n+1})$。问题指定约束必须在显式中点构型 $q_{n+\\frac{1}{2}} = q_n + \\frac{h}{2}v_n$ 下进行评估。\n\n一种鲁棒且对称的离散化方法，类似于用于完整系统的 RATTLE 算法，其公式如下：\n1.  **动量更新**：动量的微分方程 $M\\dot{v} = A(q)^{\\mathsf{T}}\\lambda$ 使用在 $t_{n+\\frac{1}{2}}$ 处中心化的有限差分进行离散化：\n    $$\n    M \\frac{v_{n+1} - v_n}{h} = A(q_{n+\\frac{1}{2}})^{\\mathsf{T}} \\lambda_{n+1}\n    $$\n2.  **约束强制**：非完整约束 $A(q)v = 0$ 被施加到新速度 $v_{n+1}$ 上，其中约束矩阵在中心点构型 $q_{n+\\frac{1}{2}}$ 处求值：\n    $$\n    A(q_{n+\\frac{1}{2}}) v_{n+1} = 0\n    $$\n3.  **位置更新**：位置使用对称的二阶精确梯形法则进行更新，该法则隐式地使用了区间上的平均速度：\n    $$\n    \\frac{q_{n+1} - q_n}{h} = \\frac{v_n + v_{n+1}}{2} \\implies q_{n+1} = q_n + \\frac{h}{2}(v_n + v_{n+1})\n    $$\n\n这组方程定义了积分器。给定 $(q_n, v_n)$，我们首先通过求解速度 $v_{n+1}$ 和乘子 $\\lambda_{n+1}$ 来找到 $(q_{n+1}, v_{n+1})$。动量更新和约束强制方程构成了一个关于 $(v_{n+1}, \\lambda_{n+1})$ 的耦合线性系统：\n$$\n\\begin{pmatrix} M  -h A(q_{n+\\frac{1}{2}})^{\\mathsf{T}} \\\\ A(q_{n+\\frac{1}{2}})  0 \\end{pmatrix}\n\\begin{pmatrix} v_{n+1} \\\\ \\lambda_{n+1} \\end{pmatrix}\n=\n\\begin{pmatrix} M v_n \\\\ 0 \\end{pmatrix}\n$$\n从第一行，我们将 $v_{n+1}$ 表示为 $\\lambda_{n+1}$ 的函数：\n$$\nv_{n+1} = v_n + h M^{-1} A(q_{n+\\frac{1}{2}})^{\\mathsf{T}} \\lambda_{n+1}\n$$\n将此代入第二行，得到一个关于 $\\lambda_{n+1}$ 的方程：\n$$\nA(q_{n+\\frac{1}{2}}) \\left( v_n + h M^{-1} A(q_{n+\\frac{1}{2}})^{\\mathsf{T}} \\lambda_{n+1} \\right) = 0\n$$\n$$\nh \\left( A(q_{n+\\frac{1}{2}}) M^{-1} A(q_{n+\\frac{1}{2}})^{\\mathsf{T}} \\right) \\lambda_{n+1} = -A(q_{n+\\frac{1}{2}}) v_n\n$$\n让我们定义 $2 \\times 2$ 的 Gram 矩阵 $G(q) = A(q) M^{-1} A(q)^{\\mathsf{T}}$。方程变为：\n$$\nh G(q_{n+\\frac{1}{2}}) \\lambda_{n+1} = -A(q_{n+\\frac{1}{2}}) v_n\n$$\n求解 $\\lambda_{n+1}$ 得到：\n$$\n\\lambda_{n+1} = -\\frac{1}{h} G(q_{n+\\frac{1}{2}})^{-1} A(q_{n+\\frac{1}{2}}) v_n\n$$\n将此代回 $v_{n+1}$ 的表达式中，我们得到最终的速度更新规则：\n$$\nv_{n+1} = v_n - M^{-1} A(q_{n+\\frac{1}{2}})^{\\mathsf{T}} G(q_{n+\\frac{1}{2}})^{-1} A(q_{n+\\frac{1}{2}}) v_n\n$$\n这可以写成 $v_{n+1} = P_{q_{n+1/2}}(v_n)$，其中 $P_q$ 是一个算子，它将一个速度向量投影到由 $A(q)$ 定义的约束子空间上，该投影是关于由 $M$ 定义的动能内积的。\n\n### 算法实现步骤\n\n对于每个时间步，给定 $(q_n, v_n)$：\n1.  计算中点构型：$q_{n+\\frac{1}{2}} = q_n + \\frac{h}{2}v_n$。令 $\\psi_{n+\\frac{1}{2}}$ 为 $q_{n+\\frac{1}{2}}$ 中的偏航角。\n2.  构建约束矩阵 $A(\\psi_{n+\\frac{1}{2}})$ 和 Gram 矩阵 $G(\\psi_{n+\\frac{1}{2}}) = A(\\psi_{n+\\frac{1}{2}}) M^{-1} A(\\psi_{n+\\frac{1}{2}})^{\\mathsf{T}}$。矩阵 $M^{-1} = \\mathrm{diag}(1/m, 1/m, 1/I_{\\psi}, 1/I_{\\phi})$ 是对角的。\n    Gram 矩阵是：\n    $$\n    G(\\psi) = \\begin{pmatrix} 1/m + (R^2 \\cos^2\\psi)/I_\\phi  (R^2 \\cos\\psi \\sin\\psi)/I_\\phi \\\\ (R^2 \\cos\\psi \\sin\\psi)/I_\\phi  1/m + (R^2 \\sin^2\\psi)/I_\\phi \\end{pmatrix}\n    $$\n3.  计算逆矩阵 $G(\\psi_{n+\\frac{1}{2}})^{-1}$。\n4.  使用上面推导的公式计算拉格朗日乘子 $\\lambda_{n+1}$。\n5.  将速度更新为 $v_{n+1} = v_n + h M^{-1} A(\\psi_{n+\\frac{1}{2}})^{\\mathsf{T}} \\lambda_{n+1}$。\n6.  根据构造，新速度满足 $A(\\psi_{n+\\frac{1}{2}})v_{n+1} = 0$，精度达到浮点精度。约束违反度量指标 $\\left\\| A(q_{n+\\frac{1}{2}}) v_{n+1} \\right\\|$ 在此阶段计算。\n7.  将构型更新为 $q_{n+1} = q_n + \\frac{h}{2}(v_n + v_{n+1})$。\n\n### 保结构特性\n\n*   **约束保持**：该算法是一种投影方法，在每一步都显式地强制施加约束 $A(q_{n+\\frac{1}{2}})v_{n+1}=0$。因此，度量指标 $\\max_n \\|A(q_{n+1/2})v_{n+1}\\|$ 预计将接近机器精度。\n*   **能量行为**：每步的动能变化为 $\\Delta T_n = T(v_{n+1}) - T(v_n)$。详细的计算表明 $\\Delta T_n = -\\frac{1}{2} (A_h v_n)^{\\mathsf{T}} G_h^{-1} (A_h v_n)$，其中下标 $h$ 表示在 $q_{n+1/2}$ 处求值。项 $A_h v_n$ 表示速度 $v_n$ 对中点约束的违反程度。如果 $v_n$ 满足在 $q_n$ 处的约束（即 $A(q_n)v_n=0$），那么 $A_h v_n$ 的阶为 $O(h)$。这使得每步的能量误差为 $\\Delta T_n = O(h^2)$，在固定时间间隔内的总能量漂移为 $O(h)$。这表明对于小的 $h$，能量是近似守恒的，符合要求。\n\n### 初始条件\n对于初始速度 $v_0$ 给定为满足约束的测试用例，$A(q_0)v_0 = 0$。对于测试用例 2，$v_0$ 是不一致的。计算能量漂移的指定程序是使用 $v_1$（第一个完整步长后的速度）作为能量计算的初始速度，即 $\\Delta T = T(v_{\\text{final}}) - T(v_1)$。这样可以在模拟开始前处理初始不一致性，而无需单独的投影步骤。\n\n接下来的实现将遵循这个推导出的算法。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements and evaluates a structure-preserving time-stepping method \n    for the nonholonomic vertical coin.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"m\": 1.0, \"R\": 0.3, \"I_psi\": 0.12, \"I_phi\": 0.045,\n            \"h\": 0.01, \"steps\": 1000,\n            \"q0\": np.array([0.0, 0.0, 0.7, 0.0]),\n            \"v0_params\": {\"phi_dot\": 5.0, \"psi_dot\": 0.5, \"inconsistent\": False},\n        },\n        {\n            \"m\": 0.8, \"R\": 0.25, \"I_psi\": 0.10, \"I_phi\": 0.03,\n            \"h\": 1e-4, \"steps\": 5000,\n            \"q0\": np.array([0.0, 0.0, 1.2, 0.0]),\n            \"v0_params\": {\"v0_vec\": np.array([0.1, 0.0, -2.0, 3.0]), \"inconsistent\": True},\n        },\n        {\n            \"m\": 1.2, \"R\": 0.35, \"I_psi\": 0.20, \"I_phi\": 0.06,\n            \"h\": 0.1, \"steps\": 300,\n            \"q0\": np.array([0.0, 0.0, 0.2, 0.0]),\n            \"v0_params\": {\"phi_dot\": 4.0, \"psi_dot\": 1.5, \"inconsistent\": False},\n        },\n        {\n            \"m\": 0.9, \"R\": 0.28, \"I_psi\": 0.15, \"I_phi\": 0.04,\n            \"h\": 0.02, \"steps\": 800,\n            \"q0\": np.array([0.0, 0.0, 1.0, 0.0]),\n            \"v0_params\": {\"phi_dot\": 3.0, \"psi_dot\": 10.0, \"inconsistent\": False},\n        },\n    ]\n\n    results = []\n    for params in test_cases:\n        result = run_simulation(params)\n        results.append(result)\n\n    # Format the final output string exactly as specified.\n    # The str() representation of a list includes the required spaces.\n    print(f\"[{', '.join(map(str, results))}]\")\n\ndef run_simulation(params):\n    \"\"\"\n    Runs a single simulation for a given set of parameters.\n    \"\"\"\n    m, R, I_psi, I_phi = params[\"m\"], params[\"R\"], params[\"I_psi\"], params[\"I_phi\"]\n    h, steps = params[\"h\"], params[\"steps\"]\n    \n    q = np.copy(params[\"q0\"])\n    \n    # Set initial velocity\n    v0_params = params[\"v0_params\"]\n    if v0_params[\"inconsistent\"]:\n        v = np.copy(v0_params[\"v0_vec\"])\n    else:\n        psi0 = q[2]\n        phi_dot0 = v0_params[\"phi_dot\"]\n        psi_dot0 = v0_params[\"psi_dot\"]\n        x_dot0 = R * phi_dot0 * np.cos(psi0)\n        y_dot0 = R * phi_dot0 * np.sin(psi0)\n        v = np.array([x_dot0, y_dot0, psi_dot0, phi_dot0])\n\n    M_inv_diag = np.array([1/m, 1/m, 1/I_psi, 1/I_phi])\n    \n    max_violation_mag = 0.0\n    T_init = 0.0\n    \n    for i in range(steps):\n        # 1. Compute midpoint configuration for constraint evaluation\n        q_mid = q + (h / 2.0) * v\n        psi_mid = q_mid[2]\n        cos_psi_mid = np.cos(psi_mid)\n        sin_psi_mid = np.sin(psi_mid)\n\n        # 2. Derive G and compute its inverse\n        g11 = 1/m + (R**2 * cos_psi_mid**2) / I_phi\n        g12 = (R**2 * cos_psi_mid * sin_psi_mid) / I_phi\n        g22 = 1/m + (R**2 * sin_psi_mid**2) / I_phi\n        det_G = g11 * g22 - g12 * g12\n        inv_det_G = 1.0 / det_G\n\n        G_inv = np.array([\n            [g22 * inv_det_G, -g12 * inv_det_G],\n            [-g12 * inv_det_G, g11 * inv_det_G]\n        ])\n        \n        # 3. Compute constraint violation of v_n at midpoint: A(q_mid) @ v_n\n        A_v = np.array([\n            v[0] - R * v[3] * cos_psi_mid,\n            v[1] - R * v[3] * sin_psi_mid\n        ])\n\n        # 4. Calculate Lagrange multipliers\n        lambda_val = - (1/h) * (G_inv @ A_v)\n\n        # 5. Update velocity\n        v_next = np.copy(v)\n        # Force from lambda on x,y\n        v_next[0] += h * M_inv_diag[0] * lambda_val[0]\n        v_next[1] += h * M_inv_diag[1] * lambda_val[1]\n        # Force from lambda on phi\n        v_next[3] += h * M_inv_diag[3] * (-R * cos_psi_mid * lambda_val[0] - R * sin_psi_mid * lambda_val[1])\n\n        # 6. Calculate constraint violation for the new velocity v_next\n        violation_vec = np.array([\n            v_next[0] - R * v_next[3] * cos_psi_mid,\n            v_next[1] - R * v_next[3] * sin_psi_mid\n        ])\n        current_violation_mag = np.linalg.norm(violation_vec)\n        if current_violation_mag  max_violation_mag:\n            max_violation_mag = current_violation_mag\n\n        # 7. Update configuration\n        q_next = q + (h/2.0) * (v + v_next)\n        \n        # Handle energy calculation as per problem spec\n        if i == 0:\n            T_init = 0.5 * (m*v_next[0]**2 + m*v_next[1]**2 + I_psi*v_next[2]**2 + I_phi*v_next[3]**2)\n            \n        # Update state for next iteration\n        q = q_next\n        v = v_next\n\n    # After the loop, v is v_final\n    T_final = 0.5 * (m*v[0]**2 + m*v[1]**2 + I_psi*v[2]**2 + I_phi*v[3]**2)\n    energy_drift = T_final - T_init\n\n    return [max_violation_mag, energy_drift]\n\nsolve()\n```"
        }
    ]
}