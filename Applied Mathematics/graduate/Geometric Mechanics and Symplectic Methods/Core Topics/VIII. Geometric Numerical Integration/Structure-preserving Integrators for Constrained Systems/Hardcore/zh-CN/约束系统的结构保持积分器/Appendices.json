{
    "hands_on_practices": [
        {
            "introduction": "SHAKE 算法是处理完整约束系统的基石方法。本练习将引导你推导其核心机制：将一个无约束的预测步产生的位置投影回约束流形上。通过一个直观的平面摆模型，你将亲手实践如何精确满足位置约束，这是构建更复杂结构保持积分器的第一步。",
            "id": "3767134",
            "problem": "考虑一个质量为 $m$ 的刚性平面摆，其运动被约束在以原点为中心、半径为 $\\ell$ 的圆上，其笛卡尔构型为 $q=(x,y)$，完整约束为 $g(q)=x^{2}+y^{2}-\\ell^{2}=0$。其动力学源于拉格朗日量 $L(q,\\dot{q})=\\tfrac{1}{2}m\\,\\dot{q}^{\\mathsf{T}}\\dot{q}-V(q)$，约束力通过拉格朗日乘子 $\\lambda(t)$ 引入，使得 $m\\,\\ddot{q}=-\\nabla V(q)+\\lambda(t)\\,\\nabla g(q)$，其中 $g(q)=0$。设 $h>0$ 为一个固定的时间步长，并用 $q_{k}=(x_{k},y_{k})$ 和 $v_{k}=(\\dot{x}_{k},\\dot{y}_{k})$ 分别表示在时间 $t_{k}$ 的位置和速度。定义无约束的 Stoermer–Verlet 预测子（也称为速度-Verlet 位置预测）\n$$\ns \\equiv q_{k} + h\\,v_{k} + \\frac{h^{2}}{2}\\,a(q_{k}),\n$$\n其中 $a(q)=\\frac{1}{m}\\big(-\\nabla V(q)\\big)$ 是物理加速度场。在 SHAKE 方法（一种用于完整约束的投影法）的第一个位置校正阶段，需要寻找一个校正量 $\\Delta q_{k+1}$，使得 $q_{k+1}=s+\\Delta q_{k+1}$ 精确地位于约束流形上，即 $g(q_{k+1})=0$，并且该校正量沿着质量加权的约束梯度方向。对于给定的各向同性质量矩阵和圆形约束，这意味着校正量与预测位置 $s$ 共线。\n\n从第一性原理出发，推导 SHAKE 位置校正量 $\\Delta q_{k+1}$ 的闭式解析表达式，该表达式确保 $g(q_{k+1})=0$ 精确成立，并直接用 $q_{k}$、$v_{k}$、$h$、$a(q_{k})$ 和 $\\ell$ 表示。您的最终答案必须是 $\\Delta q_{k+1}=\\big(\\Delta x_{k+1},\\Delta y_{k+1}\\big)$ 的显式双分量表达式，形式为单个行矩阵。不需要进行数值计算，也无需四舍五入。请仅使用上文定义的符号量来表示您的答案，不带单位。",
            "solution": "首先根据指定标准对问题进行验证。\n\n### 问题验证\n\n**第 1 步：提取已知条件**\n- **系统**：单个刚性平面摆。\n- **质量**：$m$。\n- **构型**：$q=(x,y)$。\n- **拉格朗日量**：$L(q,\\dot{q})=\\tfrac{1}{2}m\\,\\dot{q}^{\\mathsf{T}}\\dot{q}-V(q)$。\n- **完整约束**：质量被约束在以原点为中心、半径为 $\\ell$ 的圆上运动。约束函数为 $g(q)=x^{2}+y^{2}-\\ell^{2}=0$。\n- **运动方程**：$m\\,\\ddot{q}=-\\nabla V(q)+\\lambda(t)\\,\\nabla g(q)$，其中 $\\lambda(t)$ 是拉格朗日乘子。\n- **离散化**：时间步长 $h>0$。在时间 $t_k$ 的状态由位置 $q_{k}=(x_{k},y_{k})$ 和速度 $v_{k}=(\\dot{x}_{k},\\dot{y}_{k})$ 给出。\n- **加速度场**：物理加速度为 $a(q)=\\frac{1}{m}\\big(-\\nabla V(q)\\big)$。\n- **预测步**：无约束的预测位置为 $s \\equiv q_{k} + h\\,v_{k} + \\frac{h^{2}}{2}\\,a(q_{k})$。\n- **校正步**：校正后的位置为 $q_{k+1}=s+\\Delta q_{k+1}$。\n- **校正条件**：\n    1. 校正后的位置必须满足约束：$g(q_{k+1})=0$。\n    2. 校正向量 $\\Delta q_{k+1}$ 与预测位置向量 $s$ 共线。\n\n**第 2 步：使用提取的已知条件进行验证**\n- **科学依据**：该问题设置在几何力学和数值分析的背景下，具体涉及约束系统的保结构积分器（SHAKE 算法）。所有概念、方程和定义在计算物理和数学中都是标准且公认的。\n- **适定性**：该问题提供了一个明确的目标（推导 $\\Delta q_{k+1}$ 的表达式）和一套完整的条件以唯一确定解。校正量与预测位置 $s$ 共线的先验假设是问题陈述的明确部分，对应于 SHAKE 算法的一个特定变体。\n- **客观性**：该问题使用精确的数学语言表述，没有歧义或主观内容。\n\n**第 3 步：结论与行动**\n该问题被判定为**有效**，因为它具有科学依据、适定、客观且自洽。因此，将推导其完整解。\n\n### 求解推导\n\n目标是根据所提供的条件，找到 SHAKE 算法中使用的位置校正向量 $\\Delta q_{k+1}$ 的闭式表达式。\n\n在不考虑约束的情况下，时间 $t_{k+1}$ 的预测位置由 Stoermer-Verlet 预测子给出：\n$$\ns = q_{k} + h\\,v_{k} + \\frac{h^{2}}{2}\\,a(q_{k})\n$$\n校正后的位置 $q_{k+1}$ 是通过将校正项 $\\Delta q_{k+1}$ 加到预测子 $s$ 上得到的：\n$$\nq_{k+1} = s + \\Delta q_{k+1}\n$$\n问题陈述了必须满足的两个条件。\n首先，校正向量 $\\Delta q_{k+1}$ 与预测位置向量 $s$ 共线。这可以用数学方式表示为：\n$$\n\\Delta q_{k+1} = \\mu s\n$$\n其中 $\\mu$ 是一个需要确定的标量参数。\n\n将此校正形式代入 $q_{k+1}$ 的方程中，得到：\n$$\nq_{k+1} = s + \\mu s = (1+\\mu)s\n$$\n这个关系表明，校正后的位置向量 $q_{k+1}$ 只是预测位置向量 $s$ 的一个缩放版本。\n\n其次，校正后的位置 $q_{k+1}$ 必须位于约束流形上，即半径为 $\\ell$ 的圆。这由约束方程 $g(q_{k+1}) = 0$ 表示。对于给定的圆形约束，这意味着位置向量的范数平方必须等于 $\\ell^2$：\n$$\n\\|q_{k+1}\\|^2 = \\ell^2\n$$\n将以 $s$ 表示的 $q_{k+1}$ 的表达式代入约束方程中：\n$$\n\\|(1+\\mu)s\\|^2 = \\ell^2\n$$\n对于标量 $c$ 和向量 $\\mathbf{v}$，使用范数的性质 $\\|c\\mathbf{v}\\| = |c|\\|\\mathbf{v}\\|$：\n$$\n(1+\\mu)^2 \\|s\\|^2 = \\ell^2\n$$\n求解 $(1+\\mu)$：\n$$\n(1+\\mu)^2 = \\frac{\\ell^2}{\\|s\\|^2} \\implies 1+\\mu = \\pm \\frac{\\ell}{\\|s\\|}\n$$\nSHAKE 校正旨在进行微小调整。对于小的时间步长 $h$，预测位置 $s$ 应接近约束流形，意味着其范数 $\\|s\\|$ 应接近 $\\ell$。因此，校正后的位置 $q_{k+1}$ 应在 $s$ 附近。这意味着缩放因子 $(1+\\mu)$ 应接近于 1 且为正。因此，我们选择正根：\n$$\n1+\\mu = \\frac{\\ell}{\\|s\\|}\n$$\n由此，我们可以解出标量参数 $\\mu$：\n$$\n\\mu = \\frac{\\ell}{\\|s\\|} - 1\n$$\n现在我们可以写出校正向量 $\\Delta q_{k+1}$ 的最终表达式：\n$$\n\\Delta q_{k+1} = \\mu s = \\left( \\frac{\\ell}{\\|s\\|} - 1 \\right) s\n$$\n问题要求以初始状态 $(q_k, v_k)$、时间步长 $h$、加速度 $a(q_k)$ 和半径 $\\ell$ 来表示 $\\Delta q_{k+1} = (\\Delta x_{k+1}, \\Delta y_{k+1})$ 的显式双分量表达式。我们定义各向量的分量：$q_k = (x_k, y_k)$，$v_k = (\\dot{x}_k, \\dot{y}_k)$ 和 $a(q_k)=(a_x(q_k), a_y(q_k))$。预测向量 $s=(s_x,s_y)$ 的分量为：\n$$\ns_x = x_k + h \\dot{x}_k + \\frac{h^2}{2} a_x(q_k)\n$$\n$$\ns_y = y_k + h \\dot{y}_k + \\frac{h^2}{2} a_y(q_k)\n$$\n$s$ 的范数为 $\\|s\\| = \\sqrt{s_x^2 + s_y^2}$。因此，校正向量 $\\Delta q_{k+1}$ 的分量为：\n$$\n\\Delta x_{k+1} = \\left( \\frac{\\ell}{\\sqrt{s_x^2 + s_y^2}} - 1 \\right) s_x\n$$\n$$\n\\Delta y_{k+1} = \\left( \\frac{\\ell}{\\sqrt{s_x^2 + s_y^2}} - 1 \\right) s_y\n$$\n代入 $s_x$ 和 $s_y$ 的表达式，我们得到校正向量各分量的最终解析表达式。\n第一个分量是：\n$$\n\\Delta x_{k+1} = \\left( \\frac{\\ell}{\\sqrt{\\left(x_k + h \\dot{x}_k + \\frac{h^2}{2} a_x(q_k)\\right)^2 + \\left(y_k + h \\dot{y}_k + \\frac{h^2}{2} a_y(q_k)\\right)^2}} - 1 \\right) \\left(x_k + h \\dot{x}_k + \\frac{h^2}{2} a_x(q_k)\\right)\n$$\n第二个分量是：\n$$\n\\Delta y_{k+1} = \\left( \\frac{\\ell}{\\sqrt{\\left(x_k + h \\dot{x}_k + \\frac{h^2}{2} a_x(q_k)\\right)^2 + \\left(y_k + h \\dot{y}_k + \\frac{h^2}{2} a_y(q_k)\\right)^2}} - 1 \\right) \\left(y_k + h \\dot{y}_k + \\frac{h^2}{2} a_y(q_k)\\right)\n$$\n这些就是 SHAKE 位置校正的显式双分量表达式。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\left( \\frac{\\ell}{\\sqrt{\\left(x_k + h \\dot{x}_k + \\frac{h^2}{2} a_x(q_k)\\right)^2 + \\left(y_k + h \\dot{y}_k + \\frac{h^2}{2} a_y(q_k)\\right)^2}} - 1 \\right) \\left(x_k + h \\dot{x}_k + \\frac{h^2}{2} a_x(q_k)\\right) & \\left( \\frac{\\ell}{\\sqrt{\\left(x_k + h \\dot{x}_k + \\frac{h^2}{2} a_x(q_k)\\right)^2 + \\left(y_k + h \\dot{y}_k + \\frac{h^2}{2} a_y(q_k)\\right)^2}} - 1 \\right) \\left(y_k + h \\dot{y}_k + \\frac{h^2}{2} a_y(q_k)\\right)\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "RATTLE 算法可以看作是 SHAKE 算法的扩展，它不仅处理位置约束，还巧妙地处理了与之相关的速度（或称“隐藏”）约束。本练习将带你走过一个完整的 RATTLE 积分步，在一个分子动力学中常见的刚性双原子分子模型上进行演算。这将让你体验如何将理论应用于实际计算，确保系统的几何结构在离散化后得以保持。",
            "id": "3767145",
            "problem": "考虑一个刚性二聚体，它被建模为两个质点，其位置分别为 $r_1 \\in \\mathbb{R}^2$ 和 $r_2 \\in \\mathbb{R}^2$，动量分别为 $p_1 \\in \\mathbb{R}^2$ 和 $p_2 \\in \\mathbb{R}^2$。哈密顿量是可分离的，$H(q,p) = T(p) + V(q)$，其中动能为 $T(p) = \\frac{1}{2 m} \\left( |p_1|^2 + |p_2|^2 \\right)$，势能为零 $V(q) = 0$，且质量相等 $m = 1$。该二聚体受到一个完整约束\n$$\ng(q) = |r_2 - r_1|^2 - L^2 = 0,\n$$\n固定键长为 $L = 1$。设时间步长为 $h = \\frac{1}{2}$，使用带约束的可逆积分器 (RATTLE 算法，一种速度 Verlet 算法的保约束变体) 将状态从时间 $t_k$ 向前推进一个完整步长至 $t_{k+1} = t_k + h$，并强制满足位置约束 $g(q_{k+1}) = 0$ 和速度 (隐藏) 约束 $\\dot{g}(q_{k+1},p_{k+1}) = 0$。\n\n在无量纲单位下进行计算，其中 $m$、$L$ 和 $h$ 如上所述，因此位置和动量不带物理单位。在时间 $t_k$ 的初始状态为\n$$\nr_1^k = \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix}, \\quad r_2^k = \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix}, \\quad p_1^k = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix}, \\quad p_2^k = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix}.\n$$\n\n从哈密顿方程和完整约束的定义出发，推导此自由刚性二聚体的一步 RATTLE 更新过程。具体来说：\n- 执行无约束的半步动量更新和无约束的位置更新。\n- 通过求解标量校正来应用位置校正 (SHAKE 阶段)，该校正强制满足 $g(q_{k+1}) = 0$，同时在质量相等的情况下保持质心位置不变。\n- 通过计算并沿约束方向应用动量校正 (冲量) 来在 $t_{k+1}$ 时刻强制满足速度约束，使得 $(r_2^{k+1} - r_1^{k+1}) \\cdot \\left( \\frac{p_2^{k+1}}{m} - \\frac{p_1^{k+1}}{m} \\right) = 0$。\n\n计算 $r_1^{k+1}$、$r_2^{k+1}$、$p_1^{k+1}$ 和 $p_2^{k+1}$ 的精确分量，并将你的最终答案表示为一个包含八个条目的单行矩阵\n$$\nx_1^{k+1}, \\ y_1^{k+1}, \\ x_2^{k+1}, \\ y_2^{k+1}, \\ p_{1x}^{k+1}, \\ p_{1y}^{k+1}, \\ p_{2x}^{k+1}, \\ p_{2y}^{k+1}.\n$$\n不要四舍五入；以指定单位提供精确的解析值。",
            "solution": "用户希望使用 RATTLE 算法求出刚性二聚体在一个时间步长之后的状态。\n\n### 第一步：提取已知条件\n-   **系统**：由两个质点组成的刚性二聚体。\n-   **位置**：$r_1 \\in \\mathbb{R}^2$, $r_2 \\in \\mathbb{R}^2$。令 $q=(r_1, r_2)$。\n-   **动量**：$p_1 \\in \\mathbb{R}^2$, $p_2 \\in \\mathbb{R}^2$。令 $p=(p_1, p_2)$。\n-   **质量**：$m_1 = m_2 = m = 1$。\n-   **哈密顿量**：$H(q,p) = T(p) + V(q)$。\n-   **动能**：$T(p) = \\frac{1}{2 m} \\left( |p_1|^2 + |p_2|^2 \\right)$。\n-   **势能**：$V(q) = 0$。\n-   **完整约束**：$g(q) = |r_2 - r_1|^2 - L^2 = 0$。\n-   **键长**：$L = 1$。\n-   **时间步长**：$h = \\frac{1}{2}$。\n-   **在时间 $t_k$ 的初始状态**：\n    -   $r_1^k = \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix}$\n    -   $r_2^k = \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix}$\n    -   $p_1^k = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix}$\n    -   $p_2^k = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix}$\n-   **任务**：计算在时间 $t_{k+1}=t_k+h$ 的状态 $(r_1^{k+1}, r_2^{k+1}, p_1^{k+1}, p_2^{k+1})$。\n-   **算法**：RATTLE (带约束的可逆积分器)。\n\n### 第二步：使用提取的已知条件进行验证\n1.  **科学依据**：该问题是 RATTLE 算法的标准应用，RATTLE 算法是几何力学和分子动力学领域中一个成熟的保结构数值积分器。哈密顿框架和完整约束的使用是经典力学的基础。该设置在科学上是合理的。\n2.  **适定性**：该问题为确定性算法提供了一套完整的初始条件。算法的步骤定义明确。预期可以得到下一个时间步状态的唯一、稳定且有意义的解。\n3.  **客观性**：该问题以精确的数学语言表述，没有任何主观或模棱两可的术语。\n4.  **完整性**：所有必要的参数（$m, L, h$）和初始条件都已提供。势能为零是对于自由二聚体的有效简化。我们可以验证初始状态是否满足约束条件：\n    -   位置约束：$g(q_k) = |r_2^k - r_1^k|^2 - L^2 = |\\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} - \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix}|^2 - 1^2 = 1 - 1 = 0$。满足。\n    -   速度 (隐藏) 约束：$\\dot{g}(q,p) = \\frac{d}{dt}g(q) = \\nabla_q g(q) \\cdot \\dot{q} = \\nabla_q g(q) \\cdot (M^{-1} p) = 0$。约束的梯度是 $\\nabla_q g(q) = (\\nabla_{r_1} g, \\nabla_{r_2} g) = (-2(r_2-r_1), 2(r_2-r_1))$。在 $t_k$ 时，$r_2^k - r_1^k = \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix}$。所以 $\\nabla_q g(q_k) = ( \\begin{pmatrix} -2 \\\\ 0 \\end{pmatrix}, \\begin{pmatrix} 2 \\\\ 0 \\end{pmatrix})$。在 $t_k$ 时的速度约束是 $\\begin{pmatrix} -2 \\\\ 0 \\end{pmatrix} \\cdot \\frac{p_1^k}{m} + \\begin{pmatrix} 2 \\\\ 0 \\end{pmatrix} \\cdot \\frac{p_2^k}{m} = \\begin{pmatrix} -2 \\\\ 0 \\end{pmatrix} \\cdot \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} + \\begin{pmatrix} 2 \\\\ 0 \\end{pmatrix} \\cdot \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix} = 0 + 0 = 0$。满足。\n5.  **结论**：该问题是有效的。\n\n### 第三步：结论与行动\n该问题是有效的。我们继续进行求解。\n\n### 解法\n\nRATTLE 算法是速度 Verlet 算法的一种变体，适用于完整约束。对于一个具有哈密顿量 $H = T(p) + V(q)$ 和约束 $g(q)=0$ 的系统，从 $t_k$到 $t_{k+1}$ 的一个步长按以下方式进行：\n\n1.  **动量第一半步更新**：\n    $p_{k+1/2} = p_k - \\frac{h}{2} \\nabla_q V(q_k)$\n    由于势能 $V(q) = 0$，其梯度 $\\nabla_q V(q_k)$ 为零。\n    $p_{k+1/2} = p_k$。\n    因此，$p_{1, k+1/2} = p_1^k = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix}$ 且 $p_{2, k+1/2} = p_2^k = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix}$。\n\n2.  **无约束位置全步更新**：\n    我们计算在没有约束力的情况下会达到的位置 $q_{k+1}^* = (r_{1,k+1}^*, r_{2,k+1}^*)$。\n    $r_{1, k+1}^* = r_1^k + h \\frac{p_{1, k+1/2}}{m} = \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix} + \\frac{1}{2} \\cdot \\frac{1}{1} \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 1/2 \\end{pmatrix}$。\n    $r_{2, k+1}^* = r_2^k + h \\frac{p_{2, k+1/2}}{m} = \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} + \\frac{1}{2} \\cdot \\frac{1}{1} \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix} = \\begin{pmatrix} 1 \\\\ -1/2 \\end{pmatrix}$。\n\n3.  **位置约束校正 (SHAKE)**：\n    我们校正位置以满足 $g(q_{k+1}) = 0$。由于更新必须保持质心（对于相等质量），我们可以使用相对坐标 $\\Delta r = r_2 - r_1$。无约束的相对位置是：\n    $\\Delta r_{k+1}^* = r_{2, k+1}^* - r_{1, k+1}^* = \\begin{pmatrix} 1 \\\\ -1/2 \\end{pmatrix} - \\begin{pmatrix} 0 \\\\ 1/2 \\end{pmatrix} = \\begin{pmatrix} 1 \\\\ -1 \\end{pmatrix}$。\n    该向量的长度是 $|\\Delta r_{k+1}^*| = \\sqrt{1^2 + (-1)^2} = \\sqrt{2}$。\n    校正后的相对位置向量 $\\Delta r_{k+1}$ 的长度必须为 $L=1$，并且应该是约束流形上最接近 $\\Delta r_{k+1}^*$ 的向量。这通过缩放实现：\n    $\\Delta r_{k+1} = \\frac{L}{|\\Delta r_{k+1}^*|} \\Delta r_{k+1}^* = \\frac{1}{\\sqrt{2}} \\begin{pmatrix} 1 \\\\ -1 \\end{pmatrix} = \\begin{pmatrix} \\frac{\\sqrt{2}}{2} \\\\ -\\frac{\\sqrt{2}}{2} \\end{pmatrix}$。\n    质心必须保持不变。无约束的质心是：\n    $R_{CM}^* = \\frac{m_1 r_{1,k+1}^* + m_2 r_{2,k+1}^*}{m_1+m_2} = \\frac{1}{2}\\left( \\begin{pmatrix} 0 \\\\ 1/2 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ -1/2 \\end{pmatrix} \\right) = \\begin{pmatrix} 1/2 \\\\ 0 \\end{pmatrix}$。\n    最终位置通过将相对向量 $\\Delta r_{k+1}$ 分布在质心 $R_{CM}^*$ 周围来找到：\n    $r_{1, k+1} = R_{CM}^* - \\frac{1}{2}\\Delta r_{k+1} = \\begin{pmatrix} 1/2 \\\\ 0 \\end{pmatrix} - \\frac{1}{2}\\begin{pmatrix} \\frac{\\sqrt{2}}{2} \\\\ -\\frac{\\sqrt{2}}{2} \\end{pmatrix} = \\begin{pmatrix} \\frac{1}{2} - \\frac{\\sqrt{2}}{4} \\\\ \\frac{\\sqrt{2}}{4} \\end{pmatrix}$。\n    $r_{2, k+1} = R_{CM}^* + \\frac{1}{2}\\Delta r_{k+1} = \\begin{pmatrix} 1/2 \\\\ 0 \\end{pmatrix} + \\frac{1}{2}\\begin{pmatrix} \\frac{\\sqrt{2}}{2} \\\\ -\\frac{\\sqrt{2}}{2} \\end{pmatrix} = \\begin{pmatrix} \\frac{1}{2} + \\frac{\\sqrt{2}}{4} \\\\ -\\frac{\\sqrt{2}}{4} \\end{pmatrix}$。\n\n4.  **动量更新与速度约束**：\n    动量的第二个半步是 $p_{k+1}^* = p_{k+1/2} - \\frac{h}{2}\\nabla_q V(q_{k+1})$。同样，由于 $V=0$，我们有 $p_{k+1}^* = p_{k+1/2} = p_k$。\n    所以，$p_{1,k+1}^* = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix}$ 且 $p_{2,k+1}^* = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix}$。\n    接下来，我们施加一个冲量来强制满足速度约束 $\\dot{g}(q_{k+1}, p_{k+1}) = 0$。最终动量由 $p_{k+1} = p_{k+1}^* - \\mu \\nabla_q g(q_{k+1})$ 给出，其中 $\\mu$ 是某个拉格朗日乘子。速度约束为 $\\nabla_q g(q_{k+1}) \\cdot (M^{-1} p_{k+1}) = 0$。\n    代入 $p_{k+1}$ 的表达式，我们求解 $\\mu$：\n    $\\mu = \\frac{\\nabla_q g(q_{k+1}) \\cdot (M^{-1} p_{k+1}^*)}{\\nabla_q g(q_{k+1}) \\cdot (M^{-1} \\nabla_q g(q_{k+1}))}$。\n    我们来计算各项：\n    _梯度_：$\\nabla_q g(q_{k+1}) = (-2\\Delta r_{k+1}, 2\\Delta r_{k+1})$。\n    $\\Delta r_{k+1} = \\begin{pmatrix} \\frac{\\sqrt{2}}{2} \\\\ -\\frac{\\sqrt{2}}{2} \\end{pmatrix}$。\n    $\\nabla_{r_1} g = -2 \\begin{pmatrix} \\frac{\\sqrt{2}}{2} \\\\ -\\frac{\\sqrt{2}}{2} \\end{pmatrix} = \\begin{pmatrix} -\\sqrt{2} \\\\ \\sqrt{2} \\end{pmatrix}$。\n    $\\nabla_{r_2} g = 2 \\begin{pmatrix} \\frac{\\sqrt{2}}{2} \\\\ -\\frac{\\sqrt{2}}{2} \\end{pmatrix} = \\begin{pmatrix} \\sqrt{2} \\\\ -\\sqrt{2} \\end{pmatrix}$。\n    _分子_：$\\nabla_q g \\cdot (M^{-1} p^*) = \\frac{1}{m}(\\nabla_{r_1} g \\cdot p_{1,k+1}^* + \\nabla_{r_2} g \\cdot p_{2,k+1}^*)$。当 $m=1$ 时：\n    $\\begin{pmatrix} -\\sqrt{2} \\\\ \\sqrt{2} \\end{pmatrix} \\cdot \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} + \\begin{pmatrix} \\sqrt{2} \\\\ -\\sqrt{2} \\end{pmatrix} \\cdot \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix} = \\sqrt{2} + \\sqrt{2} = 2\\sqrt{2}$。\n    _分母_：$\\nabla_q g \\cdot (M^{-1} \\nabla_q g) = \\frac{1}{m}(|\\nabla_{r_1} g|^2 + |\\nabla_{r_2} g|^2)$。当 $m=1$ 时：\n    $|\\begin{pmatrix} -\\sqrt{2} \\\\ \\sqrt{2} \\end{pmatrix}|^2 + |\\begin{pmatrix} \\sqrt{2} \\\\ -\\sqrt{2} \\end{pmatrix}|^2 = (2+2) + (2+2) = 8$。\n    _乘子_：$\\mu = \\frac{2\\sqrt{2}}{8} = \\frac{\\sqrt{2}}{4}$。\n    现在我们求出最终动量：\n    $p_{1, k+1} = p_{1, k+1}^* - \\mu \\nabla_{r_1} g = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} - \\frac{\\sqrt{2}}{4} \\begin{pmatrix} -\\sqrt{2} \\\\ \\sqrt{2} \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} - \\begin{pmatrix} -2/4 \\\\ 2/4 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} - \\begin{pmatrix} -1/2 \\\\ 1/2 \\end{pmatrix} = \\begin{pmatrix} 1/2 \\\\ 1/2 \\end{pmatrix}$。\n    $p_{2, k+1} = p_{2, k+1}^* - \\mu \\nabla_{r_2} g = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix} - \\frac{\\sqrt{2}}{4} \\begin{pmatrix} \\sqrt{2} \\\\ -\\sqrt{2} \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix} - \\begin{pmatrix} 2/4 \\\\ -2/4 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix} - \\begin{pmatrix} 1/2 \\\\ -1/2 \\end{pmatrix} = \\begin{pmatrix} -1/2 \\\\ -1/2 \\end{pmatrix}$。\n\n### 最终状态\n在时间 $t_{k+1}$ 的状态是：\n$r_1^{k+1} = \\begin{pmatrix} \\frac{1}{2} - \\frac{\\sqrt{2}}{4} \\\\ \\frac{\\sqrt{2}}{4} \\end{pmatrix}$\n$r_2^{k+1} = \\begin{pmatrix} \\frac{1}{2} + \\frac{\\sqrt{2}}{4} \\\\ -\\frac{\\sqrt{2}}{4} \\end{pmatrix}$\n$p_1^{k+1} = \\begin{pmatrix} 1/2 \\\\ 1/2 \\end{pmatrix}$\n$p_2^{k+1} = \\begin{pmatrix} -1/2 \\\\ -1/2 \\end{pmatrix}$\n\n最终答案的分量是：\n$x_1^{k+1} = \\frac{1}{2} - \\frac{\\sqrt{2}}{4}$\n$y_1^{k+1} = \\frac{\\sqrt{2}}{4}$\n$x_2^{k+1} = \\frac{1}{2} + \\frac{\\sqrt{2}}{4}$\n$y_2^{k+1} = -\\frac{\\sqrt{2}}{4}$\n$p_{1x}^{k+1} = \\frac{1}{2}$\n$p_{1y}^{k+1} = \\frac{1}{2}$\n$p_{2x}^{k+1} = -\\frac{1}{2}$\n$p_{2y}^{k+1} = -\\frac{1}{2}$",
            "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{1}{2} - \\frac{\\sqrt{2}}{4} & \\frac{\\sqrt{2}}{4} & \\frac{1}{2} + \\frac{\\sqrt{2}}{4} & -\\frac{\\sqrt{2}}{4} & \\frac{1}{2} & \\frac{1}{2} & -\\frac{1}{2} & -\\frac{1}{2} \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "在学习了如何实现像 RATTLE 这样精巧的积分器之后，我们有必要探究其设计的深层原因。本练习将分析一种看似合理的“朴素”投影方法，并证明尽管它能满足约束，却破坏了哈密顿系统内在的辛结构。通过计算其雅可比行列式，你将清楚地看到为何需要更复杂的算法来真正实现“结构保持”，这也是几何积分器设计的精髓所在。",
            "id": "3767126",
            "problem": "考虑一个单位质量的质点，其运动被约束在 $\\mathbb{R}^{2}$ 中的单位圆上。设位形为 $q \\in \\mathbb{R}^{2}$，动量为 $p \\in \\mathbb{R}^{2}$，哈密顿量为 $H(q,p) = \\frac{1}{2} |p|^{2}$。完整约束为 $g(q) = |q|^{2} - 1 = 0$，隐含的速度约束为 $q \\cdot p = 0$。连续的约束动力学在单位圆的余切丛上是哈密顿的，并具有典范辛形式。\n\n定义一个时间步长为 $h > 0$ 的朴素两步显式积分器如下：\n1. 对无约束系统执行一个显式欧拉步：\n$$\nq^{\\ast} = q + h p, \\qquad p^{\\ast} = p.\n$$\n2. 正交投影回约束流形及其切空间：\n$$\n\\hat{q} = \\frac{q^{\\ast}}{|q^{\\ast}|}, \\qquad \\hat{p} = p^{\\ast} - (\\hat{q} \\cdot p^{\\ast}) \\hat{q}.\n$$\n这定义了一个单步映射 $\\Phi_{h} : (q,p) \\mapsto (\\hat{q}, \\hat{p})$。\n\n通过角-动量坐标 $(\\theta,\\pi)$ 对约束相空间进行参数化：\n$$\nq = \\begin{pmatrix} \\cos \\theta \\\\ \\sin \\theta \\end{pmatrix}, \\qquad p = \\pi \\begin{pmatrix} -\\sin \\theta \\\\ \\cos \\theta \\end{pmatrix}.\n$$\n仅使用上述定义和映射 $\\Phi_{h}$ 的结构，在这些坐标下推导诱导出的单步映射 $(\\theta,\\pi) \\mapsto (\\hat{\\theta}, \\hat{\\pi})$。然后计算此诱导映射的雅可比矩阵 $D\\Phi_{h}(\\theta,\\pi)$ 及其行列式 $\\det(D\\Phi_{h}(\\theta,\\pi))$。\n\n请提供一个仅用 $h$ 和 $\\pi$ 表示的 $\\det(D\\Phi_{h}(\\theta,\\pi))$ 的单闭式解析表达式作为最终答案。无需四舍五入，最终答案中不包含单位。",
            "solution": "用户想要分析一个用于约束哈密顿系统的特定数值积分器。\n\n### 第1步：问题验证\n\n该问题以数学的严谨性陈述，涉及几何数值积分中的一个标准课题：约束力学系统的投影方法分析。\n\n-   **已知条件：**\n    -   质点质量：$m=1$。\n    -   位形：$q \\in \\mathbb{R}^2$，动量：$p \\in \\mathbb{R}^2$。\n    -   哈密顿量：$H(q,p) = \\frac{1}{2}|p|^2$。\n    -   约束：$g(q) = |q|^2 - 1 = 0$ 和 $q \\cdot p = 0$。\n    -   积分器映射 $\\Phi_h: (q,p) \\mapsto (\\hat{q}, \\hat{p})$:\n        1.  $q^{\\ast} = q + h p$, $p^{\\ast} = p$。\n        2.  $\\hat{q} = \\frac{q^{\\ast}}{|q^{\\ast}|}$, $\\hat{p} = p^{\\ast} - (\\hat{q} \\cdot p^{\\ast}) \\hat{q}$。\n    -   坐标参数化：\n        $q = (\\cos\\theta, \\sin\\theta)^T$, $p = \\pi(-\\sin\\theta, \\cos\\theta)^T$。\n\n-   **验证：**\n    -   **科学合理性：** 该问题是计算力学和微分几何中一个明确定义的练习。它在科学上和数学上都是合理的。\n    -   **适定性：** 定义清晰，目标具体，可通过直接计算实现。存在唯一解。\n    -   **完备性与一致性：** 提供了所有必要信息。参数化与约束条件一致：$|q|^2 = \\cos^2\\theta + \\sin^2\\theta = 1$ 和 $q \\cdot p = \\pi(-\\cos\\theta\\sin\\theta + \\sin\\theta\\cos\\theta) = 0$。哈密顿量变为 $H = \\frac{1}{2}|p|^2 = \\frac{1}{2}\\pi^2$。\n\n-   **结论：** 问题有效。\n\n### 第2步：求解\n\n目标是求出映射 $\\Phi_h$ 在 $(\\theta, \\pi)$ 坐标下的雅可比矩阵的行列式。首先，我们推导映射 $(\\theta, \\pi) \\mapsto (\\hat{\\theta}, \\hat{\\pi})$。\n\n**1. 用 $(\\theta, \\pi)$ 坐标表示积分器动力学。**\n\n我们从由 $(\\theta, \\pi)$ 定义的初始状态开始：\n$q = \\begin{pmatrix} \\cos\\theta \\\\ \\sin\\theta \\end{pmatrix}$, $p = \\pi \\begin{pmatrix} -\\sin\\theta \\\\ \\cos\\theta \\end{pmatrix}$。\n\n**第1步：无约束显式欧拉步。**\n中间状态 $(q^*, p^*)$ 计算如下：\n$p^* = p$.\n$q^* = q + hp = \\begin{pmatrix} \\cos\\theta \\\\ \\sin\\theta \\end{pmatrix} + h\\pi \\begin{pmatrix} -\\sin\\theta \\\\ \\cos\\theta \\end{pmatrix} = \\begin{pmatrix} \\cos\\theta - h\\pi\\sin\\theta \\\\ \\sin\\theta + h\\pi\\cos\\theta \\end{pmatrix}$。\n\n**第2步：正交投影。**\n首先，我们求 $q^*$ 的模：\n$|q^*|^2 = (\\cos\\theta - h\\pi\\sin\\theta)^2 + (\\sin\\theta + h\\pi\\cos\\theta)^2$\n$= (\\cos^2\\theta - 2h\\pi\\cos\\theta\\sin\\theta + h^2\\pi^2\\sin^2\\theta) + (\\sin^2\\theta + 2h\\pi\\sin\\theta\\cos\\theta + h^2\\pi^2\\cos^2\\theta)$\n$= (\\cos^2\\theta + \\sin^2\\theta) + h^2\\pi^2(\\sin^2\\theta + \\cos^2\\theta) = 1 + h^2\\pi^2$。\n因此， $|q^*| = \\sqrt{1 + h^2\\pi^2}$。注意这与 $\\theta$ 无关。\n\n新位置 $\\hat{q}$ 通过将 $q^*$ 单位化得到：\n$\\hat{q} = \\frac{q^*}{|q^*|} = \\frac{1}{\\sqrt{1+h^2\\pi^2}} \\begin{pmatrix} \\cos\\theta - h\\pi\\sin\\theta \\\\ \\sin\\theta + h\\pi\\cos\\theta \\end{pmatrix}$。\n\n这个更新后的位置 $\\hat{q}$ 必须对应一个新的角度 $\\hat{\\theta}$，使得 $\\hat{q} = (\\cos\\hat{\\theta}, \\sin\\hat{\\theta})^T$。向量 $q^*$ 可被解释为在标准正交基 $\\{q, p/|p|\\}$ 中坐标为 $(1, h\\pi)$ 的一个点。该向量相对于第一个基向量 $q$ 的夹角为 $\\Delta\\theta = \\arctan(h\\pi)$。因此，新角度 $\\hat{\\theta}$ 是旧角度 $\\theta$ 加上这个增量：\n$\\hat{\\theta} = \\theta + \\arctan(h\\pi)$。\n\n接下来，我们求新动量 $\\hat{p}：$\n$\\hat{p} = p^* - (\\hat{q} \\cdot p^*) \\hat{q}$。\n我们计算点积 $\\hat{q} \\cdot p^*：$\n$\\hat{q} \\cdot p^* = \\frac{q^*}{|q^*|} \\cdot p = \\frac{(q+hp)\\cdot p}{\\sqrt{1+h^2\\pi^2}} = \\frac{q \\cdot p + h(p \\cdot p)}{\\sqrt{1+h^2\\pi^2}}$。\n使用 $q \\cdot p = 0$ 和 $p \\cdot p = |p|^2 = \\pi^2$，我们得到：\n$\\hat{q} \\cdot p^* = \\frac{h\\pi^2}{\\sqrt{1+h^2\\pi^2}}$。\n\n将此代入 $\\hat{p}$ 的表达式中：\n$\\hat{p} = p - \\left(\\frac{h\\pi^2}{\\sqrt{1+h^2\\pi^2}}\\right) \\hat{q} = p - \\frac{h\\pi^2}{1+h^2\\pi^2} q^*$。\n$\\hat{p} = p - \\frac{h\\pi^2}{1+h^2\\pi^2}(q+hp) = \\left(1 - \\frac{h^2\\pi^2}{1+h^2\\pi^2}\\right)p - \\frac{h\\pi^2}{1+h^2\\pi^2}q$。\n$\\hat{p} = \\frac{1}{1+h^2\\pi^2}p - \\frac{h\\pi^2}{1+h^2\\pi^2}q$。\n\n新动量 $\\hat{p}$ 必须对应一个新的动量坐标 $\\hat{\\pi}$，使得 $\\hat{p} = \\hat{\\pi}(-\\sin\\hat{\\theta}, \\cos\\hat{\\theta})^T$。其模为 $|\\hat{p}| = |\\hat{\\pi}|$。让我们计算 $\\hat{p}$ 的模的平方：\n$|\\hat{p}|^2 = \\left|\\frac{1}{1+h^2\\pi^2}p - \\frac{h\\pi^2}{1+h^2\\pi^2}q\\right|^2$。\n因为 $p$ 和 $q$ 是正交的，这可以简化为：\n$|\\hat{p}|^2 = \\left(\\frac{1}{1+h^2\\pi^2}\\right)^2|p|^2 + \\left(\\frac{h\\pi^2}{1+h^2\\pi^2}\\right)^2|q|^2$\n$|\\hat{p}|^2 = \\frac{\\pi^2}{(1+h^2\\pi^2)^2} + \\frac{h^2\\pi^4}{(1+h^2\\pi^2)^2} = \\frac{\\pi^2(1+h^2\\pi^2)}{(1+h^2\\pi^2)^2} = \\frac{\\pi^2}{1+h^2\\pi^2}$。\n所以， $|\\hat{\\pi}| = |\\hat{p}| = \\frac{|\\pi|}{\\sqrt{1+h^2\\pi^2}}$。\n计算证实了 $\\hat{p}$ 在 $\\hat{q}$ 处正确地与圆相切，并且符号分析证实 $\\hat{\\pi}$ 与 $\\pi$ 的符号相同。因此：\n$\\hat{\\pi} = \\frac{\\pi}{\\sqrt{1+h^2\\pi^2}}$。\n\n诱导映射 $\\Phi_h: (\\theta, \\pi) \\mapsto (\\hat{\\theta}, \\hat{\\pi})$ 为：\n$\\hat{\\theta}(\\theta, \\pi) = \\theta + \\arctan(h\\pi)$\n$\\hat{\\pi}(\\theta, \\pi) = \\pi(1+h^2\\pi^2)^{-1/2}$\n\n**2. 计算雅可比矩阵 $D\\Phi_h(\\theta, \\pi)$。**\n\n雅可比矩阵是 $D\\Phi_h = \\begin{pmatrix} \\frac{\\partial \\hat{\\theta}}{\\partial \\theta} & \\frac{\\partial \\hat{\\theta}}{\\partial \\pi} \\\\ \\frac{\\partial \\hat{\\pi}}{\\partial \\theta} & \\frac{\\partial \\hat{\\pi}}{\\partial \\pi} \\end{pmatrix}$。我们计算偏导数：\n$\\frac{\\partial \\hat{\\theta}}{\\partial \\theta} = \\frac{\\partial}{\\partial \\theta}(\\theta + \\arctan(h\\pi)) = 1$。\n$\\frac{\\partial \\hat{\\theta}}{\\partial \\pi} = \\frac{\\partial}{\\partial \\pi}(\\arctan(h\\pi)) = \\frac{1}{1+(h\\pi)^2} \\cdot h = \\frac{h}{1+h^2\\pi^2}$。\n$\\frac{\\partial \\hat{\\pi}}{\\partial \\theta} = \\frac{\\partial}{\\partial \\theta}(\\pi(1+h^2\\pi^2)^{-1/2}) = 0$。\n$\\frac{\\partial \\hat{\\pi}}{\\partial \\pi} = \\frac{d}{d\\pi} \\left( \\pi(1+h^2\\pi^2)^{-1/2} \\right)$。使用乘法法则：\n$\\frac{\\partial \\hat{\\pi}}{\\partial \\pi} = 1 \\cdot (1+h^2\\pi^2)^{-1/2} + \\pi \\cdot \\left(-\\frac{1}{2}(1+h^2\\pi^2)^{-3/2} \\cdot 2h^2\\pi\\right)$\n$= (1+h^2\\pi^2)^{-1/2} - h^2\\pi^2(1+h^2\\pi^2)^{-3/2}$\n$= \\frac{1+h^2\\pi^2}{(1+h^2\\pi^2)^{3/2}} - \\frac{h^2\\pi^2}{(1+h^2\\pi^2)^{3/2}} = \\frac{1}{(1+h^2\\pi^2)^{3/2}}$。\n\n所以，雅可比矩阵是：\n$D\\Phi_h(\\theta, \\pi) = \\begin{pmatrix} 1 & \\frac{h}{1+h^2\\pi^2} \\\\ 0 & \\frac{1}{(1+h^2\\pi^2)^{3/2}} \\end{pmatrix}$。\n\n**3. 计算行列式。**\n\n该矩阵是上三角矩阵，所以其行列式是对角线元素的乘积：\n$\\det(D\\Phi_h(\\theta, \\pi)) = 1 \\cdot \\frac{1}{(1+h^2\\pi^2)^{3/2}} = \\frac{1}{(1+h^2\\pi^2)^{3/2}}$。\n\n该表达式按要求仅依赖于 $h$ 和 $\\pi$。它表明该映射不是辛的（行列式不为1），并且会压缩相空间体积，这是此类耗散投影方法的一个特征。",
            "answer": "$$\n\\boxed{\\frac{1}{(1+h^2\\pi^2)^{3/2}}}\n$$"
        }
    ]
}