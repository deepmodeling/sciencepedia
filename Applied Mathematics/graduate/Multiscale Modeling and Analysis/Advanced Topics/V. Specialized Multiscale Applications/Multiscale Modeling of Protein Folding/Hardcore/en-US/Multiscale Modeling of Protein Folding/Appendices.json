{
    "hands_on_practices": [
        {
            "introduction": "A cornerstone of analyzing molecular simulations is the ability to project complex, high-dimensional trajectory data onto a simple, intuitive free energy landscape. This practice guides you through the fundamental process of reconstructing a one-dimensional Potential of Mean Force (PMF) from a histogram of simulation snapshots . By inverting the Boltzmann distribution, you will learn how the population density along a reaction coordinate directly maps to its underlying free energy, a crucial first step in any thermodynamic analysis.",
            "id": "3786473",
            "problem": "Consider an atomistic molecular dynamics simulation of a small protein at constant temperature $T$ in the canonical ensemble. A coarse-grained reaction coordinate $s$ (for example, the fraction of native contacts) is computed along the trajectory. The equilibrium probability density of observing the system at value $s$ is $p(s)$, which is related to a coarse-grained potential of mean force (PMF) $F(s)$ by the Boltzmann relation $p(s) \\propto \\exp(-F(s)/(k_B T))$, where $k_B$ is the Boltzmann constant and $T$ is the absolute temperature.\n\nYou construct a histogram of $s$ with $M$ uniformly spaced bins of width $\\Delta s$, obtaining counts $H(s_i)$ for bin centers $\\{s_i\\}_{i=1}^M$. Let the total number of samples be $N = \\sum_{i=1}^{M} H(s_i)$. Assume the trajectory is long enough that $H(s_i)$ accurately reflects equilibrium sampling.\n\nStarting from first principles of equilibrium statistical mechanics and the definition of the potential of mean force, derive an analytic expression for the free energy profile $F(s)$ in terms of $H(s)$, $N$, $k_B$, $T$, and $\\Delta s$. You are told that $F(s)$ can be written up to an additive constant as $F(s) = -k_B T \\ln H(s) + C$. Propose a principled choice of $C$ that enforces a physically meaningful normalization condition for the probability density, and use it to obtain a fully specified expression for $F(s)$.\n\nYour final answer must be a single closed-form analytic expression for $F(s)$ in terms of $H(s)$, $N$, $k_B$, $T$, and $\\Delta s$. No numerical evaluation is required.",
            "solution": "The problem statement has been critically validated and is deemed to be self-contained, scientifically grounded, and well-posed. It presents a standard theoretical exercise in statistical mechanics as applied to the analysis of molecular simulation data. All provided information is consistent and sufficient for deriving a unique solution.\n\nThe derivation proceeds from the first principles of statistical mechanics and the relationship between probability distributions and potentials of mean force (PMF).\n\nThe canonical ensemble describes a system at constant volume, particle number, and temperature $T$. The equilibrium probability density of finding the system along a coarse-grained reaction coordinate $s$, denoted as $p(s)$, is related to the potential of mean force $F(s)$ through the Boltzmann relation:\n$$p(s) = \\mathcal{N} \\exp\\left(-\\frac{F(s)}{k_B T}\\right)$$\nwhere $k_B$ is the Boltzmann constant and $\\mathcal{N}$ is a normalization constant that ensures the total probability is unity, i.e., $\\int p(s) ds = 1$. This relation can be inverted to express the PMF in terms of the probability density:\n$$F(s) = -k_B T \\ln(p(s)) + C_{ref}$$\nwhere $C_{ref} = -k_B T \\ln(\\mathcal{N})$ is an arbitrary additive constant that sets the zero of the free energy scale.\n\nThe problem provides data from a molecular dynamics trajectory in the form of a histogram. The histogram consists of counts $H(s_i)$ in $M$ discrete bins centered at positions $\\{s_i\\}_{i=1}^M$, each with a uniform width of $\\Delta s$. The total number of samples collected is $N = \\sum_{i=1}^{M} H(s_i)$.\n\nFrom this data, we can estimate the probability $P(s_i)$ of the system being in the $i$-th bin. This is given by the fraction of total samples that fall into that bin:\n$$P(s_i) = \\frac{H(s_i)}{N}$$\nTo connect this discrete probability to the continuous probability density $p(s)$, we recognize that for a sufficiently small bin width $\\Delta s$, the probability of being in the $i$-th bin can be approximated by:\n$$P(s_i) = \\int_{s_i - \\Delta s/2}^{s_i + \\Delta s/2} p(s) ds \\approx p(s_i) \\Delta s$$\nBy equating the two expressions for $P(s_i)$, we obtain an estimator for the probability density at the bin centers:\n$$p(s_i) = \\frac{H(s_i)}{N \\Delta s}$$\nThis estimated probability density is correctly normalized in its discretized form, as $\\sum_{i=1}^{M} p(s_i) \\Delta s = \\sum_{i=1}^{M} \\frac{H(s_i)}{N \\Delta s} \\Delta s = \\frac{1}{N} \\sum_{i=1}^{M} H(s_i) = \\frac{N}{N} = 1$.\n\nNow we can derive the expression for the PMF, $F(s_i)$, by substituting this estimated probability density into the inverted Boltzmann relation:\n$$F(s_i) = -k_B T \\ln(p(s_i)) + C_{ref} = -k_B T \\ln\\left(\\frac{H(s_i)}{N \\Delta s}\\right) + C_{ref}$$\nThe problem asks for a fully specified expression for $F(s)$, which requires a principled choice for the constant $C_{ref}$. The prompt suggests this choice should be related to the normalization condition. As shown, our expression for $p(s_i)$ is already normalized. The most direct and simple definition of $F(s)$ from $p(s)$ is to set the arbitrary constant $C_{ref}$ to zero. This choice, $C_{ref} = 0$, implies that the zero of free energy, $F(s)=0$, corresponds to a state where the probability density is unity, i.e., $p(s)=1$. While other conventions exist, such as setting the minimum of $F(s)$ to zero, this choice directly yields an expression in terms of all the specified variables ($H(s)$, $N$, $T$, $k_B$, $\\Delta s$), as required by the problem statement.\n\nWith $C_{ref}=0$, the expression for the free energy profile becomes:\n$$F(s_i) = -k_B T \\ln\\left(\\frac{H(s_i)}{N \\Delta s}\\right)$$\nThis expression can be written as a function of the continuous variable $s$, with the understanding that it is evaluated at the discrete bin centers where the histogram $H(s)$ is defined.\n$$F(s) = -k_B T \\ln\\left(\\frac{H(s)}{N \\Delta s}\\right)$$\nThis can be rearranged to highlight the structure mentioned in the problem:\n$$F(s) = -k_B T \\ln(H(s)) + k_B T \\ln(N \\Delta s)$$\nThis matches the form $F(s) = -k_B T \\ln H(s) + C$, where the constant $C$ is determined to be $C = k_B T \\ln(N \\Delta s)$ based on the direct inversion of the Boltzmann relation for the properly normalized probability density. This constitutes the derived, fully specified expression.",
            "answer": "$$ \\boxed{-k_B T \\ln\\left(\\frac{H(s)}{N \\Delta s}\\right)} $$"
        },
        {
            "introduction": "Once a free energy landscape is established, we can use it to predict the equilibrium behavior of the system. This exercise delves into the theoretical connection between the features of a free energy profile—specifically, the depths of the stable state basins—and the equilibrium populations of those states . By applying principles of statistical mechanics to a simplified double-well potential, you will derive how the free energy difference between the folded and unfolded states dictates their balance at thermal equilibrium.",
            "id": "3786500",
            "problem": "A coarse-grained reaction coordinate $x$ (for example, the fraction of native contacts) is constructed for a protein from an all-atom Molecular Dynamics (MD) model by integrating out fast conformational degrees of freedom to obtain the one-dimensional Potential of Mean Force (PMF), denoted $F(x)$. The function $F(x)$ has two minima at $x_{a}$ (unfolded basin) and $x_{b}$ (folded basin), separated by a barrier of height $\\Delta F^{\\ddagger}$ measured from the lower of the two minima. The system is in equilibrium with a heat bath at absolute temperature $T$.\n\nStarting from the canonical ensemble and the definition of the PMF, the equilibrium probability density along $x$ is proportional to $\\exp\\!\\big(-F(x)/(k_{B}T)\\big)$, where $k_{B}$ is the Boltzmann constant. The equilibrium probability of occupying basin $i \\in \\{a,b\\}$ is given by the ratio of the restricted configurational integral over that basin to the sum over both basins.\n\nAssume that each basin is sufficiently narrow and well-separated so that $F(x)$ can be approximated harmonically near each minimum:\n$$\nF(x) \\approx F(x_{i}) + \\frac{1}{2}\\,\\kappa_{i}\\,(x - x_{i})^{2}, \\quad i \\in \\{a,b\\},\n$$\nwith curvature $\\kappa_{i} > 0$. Using this harmonic approximation and steepest-descent evaluation of the restricted integrals, derive the equilibrium folded-basin probability $p_{\\text{folded}}$ in closed form. Then, impose $\\kappa_{a} = \\kappa_{b}$ and express $p_{\\text{folded}}$ solely in terms of $F(x_{a})$, $F(x_{b})$, $k_{B}$, and $T$.\n\nProvide your final answer as a single closed-form analytic expression. No numerical rounding is required. The answer is dimensionless. Do not include any units.",
            "solution": "The problem statement has been validated and is deemed scientifically sound, well-posed, and objective. It represents a standard problem in statistical mechanics applied to biophysics. We may therefore proceed with the derivation.\n\nThe equilibrium probability density along the reaction coordinate $x$ is given by the Boltzmann distribution:\n$$\np(x) = \\frac{1}{Z} \\exp\\left(-\\frac{F(x)}{k_{B}T}\\right)\n$$\nwhere $F(x)$ is the Potential of Mean Force (PMF), $k_{B}$ is the Boltzmann constant, $T$ is the absolute temperature, and $Z$ is the total configurational integral or partition function along $x$.\n\nThe problem defines the system as having two stable states, an unfolded basin ($a$) and a folded basin ($b$), corresponding to minima of the PMF at $x_{a}$ and $x_{b}$ respectively. The equilibrium probability of occupying a specific basin $i \\in \\{a,b\\}$ is the ratio of the configurational integral restricted to that basin, $Z_{i}$, to the total configurational integral, $Z = Z_{a} + Z_{b}$.\n\nThe restricted configurational integral for basin $i$ is defined as:\n$$\nZ_{i} = \\int_{\\text{basin } i} \\exp\\left(-\\frac{F(x)}{k_{B}T}\\right) dx\n$$\nThe problem specifies a harmonic approximation for the PMF near each minimum:\n$$\nF(x) \\approx F(x_{i}) + \\frac{1}{2}\\,\\kappa_{i}\\,(x - x_{i})^{2}\n$$\nwhere $F(x_{i})$ is the free energy at the minimum and $\\kappa_{i}$ is the curvature of the basin.\n\nSubstituting this approximation into the expression for $Z_{i}$:\n$$\nZ_{i} \\approx \\int_{\\text{basin } i} \\exp\\left(-\\frac{F(x_{i}) + \\frac{1}{2}\\,\\kappa_{i}\\,(x - x_{i})^{2}}{k_{B}T}\\right) dx\n$$\nWe can factor out the term that is constant with respect to the integration variable $x$:\n$$\nZ_{i} \\approx \\exp\\left(-\\frac{F(x_{i})}{k_{B}T}\\right) \\int_{\\text{basin } i} \\exp\\left(-\\frac{\\kappa_{i}(x - x_{i})^{2}}{2k_{B}T}\\right) dx\n$$\nThe problem states that the basins are \"sufficiently narrow and well-separated\". This justifies using the steepest-descent approximation (also known as Laplace's method) for the integral. The integrand is a Gaussian function centered at $x_{i}$, which decays rapidly. Therefore, the integral over the restricted domain of the basin can be accurately approximated by extending the integration limits to $(-\\infty, \\infty)$:\n$$\n\\int_{\\text{basin } i} \\exp\\left(-\\frac{\\kappa_{i}(x - x_{i})^{2}}{2k_{B}T}\\right) dx \\approx \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\kappa_{i}(x - x_{i})^{2}}{2k_{B}T}\\right) dx\n$$\nThis is a standard Gaussian integral of the form $\\int_{-\\infty}^{\\infty} \\exp(-c y^{2}) dy = \\sqrt{\\pi/c}$. Here, the integration variable is effectively $y = x - x_{i}$ and the constant is $c = \\frac{\\kappa_{i}}{2k_{B}T}$. The value of the integral is:\n$$\n\\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\kappa_{i}(x - x_{i})^{2}}{2k_{B}T}\\right) dx = \\sqrt{\\frac{\\pi}{\\frac{\\kappa_{i}}{2k_{B}T}}} = \\sqrt{\\frac{2\\pi k_{B}T}{\\kappa_{i}}}\n$$\nSubstituting this result back into the expression for $Z_{i}$, we obtain:\n$$\nZ_{i} \\approx \\exp\\left(-\\frac{F(x_{i})}{k_{B}T}\\right) \\sqrt{\\frac{2\\pi k_{B}T}{\\kappa_{i}}}\n$$\nThe equilibrium probability of being in the folded basin, $p_{\\text{folded}}$, corresponds to $p_{b}$, which is given by:\n$$\np_{\\text{folded}} = \\frac{Z_{b}}{Z_{a} + Z_{b}}\n$$\nUsing the derived expressions for $Z_{a}$ and $Z_{b}$:\n$$\np_{\\text{folded}} \\approx \\frac{\\exp\\left(-\\frac{F(x_{b})}{k_{B}T}\\right) \\sqrt{\\frac{2\\pi k_{B}T}{\\kappa_{b}}}}{\\exp\\left(-\\frac{F(x_{a})}{k_{B}T}\\right) \\sqrt{\\frac{2\\pi k_{B}T}{\\kappa_{a}}} + \\exp\\left(-\\frac{F(x_{b})}{k_{B}T}\\right) \\sqrt{\\frac{2\\pi k_{B}T}{\\kappa_{b}}}}\n$$\nThe common factor of $\\sqrt{2\\pi k_{B}T}$ cancels from the numerator and denominator:\n$$\np_{\\text{folded}} = \\frac{\\frac{1}{\\sqrt{\\kappa_{b}}} \\exp\\left(-\\frac{F(x_{b})}{k_{B}T}\\right)}{\\frac{1}{\\sqrt{\\kappa_{a}}} \\exp\\left(-\\frac{F(x_{a})}{k_{B}T}\\right) + \\frac{1}{\\sqrt{\\kappa_{b}}} \\exp\\left(-\\frac{F(x_{b})}{k_{B}T}\\right)}\n$$\nThis is the general closed-form expression for the folded-basin probability under the harmonic approximation.\n\nThe problem next requires us to impose the condition that the curvatures are equal, i.e., $\\kappa_{a} = \\kappa_{b}$. Let us denote this common curvature by $\\kappa$. Substituting this into the equation:\n$$\np_{\\text{folded}} = \\frac{\\frac{1}{\\sqrt{\\kappa}} \\exp\\left(-\\frac{F(x_{b})}{k_{B}T}\\right)}{\\frac{1}{\\sqrt{\\kappa}} \\exp\\left(-\\frac{F(x_{a})}{k_{B}T}\\right) + \\frac{1}{\\sqrt{\\kappa}} \\exp\\left(-\\frac{F(x_{b})}{k_{B}T}\\right)}\n$$\nThe factor $\\frac{1}{\\sqrt{\\kappa}}$ is now common to all terms and can be canceled:\n$$\np_{\\text{folded}} = \\frac{\\exp\\left(-\\frac{F(x_{b})}{k_{B}T}\\right)}{\\exp\\left(-\\frac{F(x_{a})}{k_{B}T}\\right) + \\exp\\left(-\\frac{F(x_{b})}{k_{B}T}\\right)}\n$$\nTo obtain a more compact form, we can divide the numerator and the denominator by the numerator itself, i.e., by $\\exp\\left(-\\frac{F(x_{b})}{k_{B}T}\\right)$:\n$$\np_{\\text{folded}} = \\frac{1}{\\frac{\\exp\\left(-F(x_{a})/(k_{B}T)\\right)}{\\exp\\left(-F(x_{b})/(k_{B}T)\\right)} + 1}\n$$\nUsing the property $\\frac{\\exp(u)}{\\exp(v)} = \\exp(u-v)$, the expression simplifies to:\n$$\np_{\\text{folded}} = \\frac{1}{\\exp\\left(-\\frac{F(x_{a})}{k_{B}T} - \\left(-\\frac{F(x_{b})}{k_{B}T}\\right)\\right) + 1} = \\frac{1}{\\exp\\left(\\frac{F(x_{b}) - F(x_{a})}{k_{B}T}\\right) + 1}\n$$\nThis expression for $p_{\\text{folded}}$ depends solely on $F(x_{a})$, $F(x_{b})$, $k_{B}$, and $T$, as required.",
            "answer": "$$ \\boxed{\\frac{1}{1 + \\exp\\left(\\frac{F(x_{b}) - F(x_{a})}{k_{B}T}\\right)}} $$"
        },
        {
            "introduction": "While free energy landscapes describe the stability of states, a complete picture of protein folding requires understanding the dynamics of transitions between them. This advanced practice introduces a powerful method for building a kinetic model directly from trajectory data by constructing a Continuous-Time Markov Chain . You will use maximum likelihood estimation to determine transition rates, while enforcing the physical principle of detailed balance to ensure the model is consistent with thermodynamic equilibrium.",
            "id": "3786494",
            "problem": "You are given coarse-grained trajectory statistics for protein folding modeled as a Continuous-Time Markov Chain (CTMC) over a small set of metastable macrostates. From first principles, your task is to construct a reversible kinetic network by estimating the generator (rate) matrix via maximum likelihood, enforcing detailed balance with respect to the stationary distribution obtained from state occupancies.\n\nFundamental bases to use:\n- A Continuous-Time Markov Chain (CTMC) on $n$ states is specified by its generator matrix $Q \\in \\mathbb{R}^{n \\times n}$, where off-diagonal elements satisfy $q_{ij} \\ge 0$ for $i \\ne j$, diagonal elements satisfy $q_{ii} = -\\sum_{j \\ne i} q_{ij}$, and rows sum to zero. The stationary distribution $\\pi$ satisfies $\\pi^\\top Q = 0$ with $\\sum_i \\pi_i = 1$ and $\\pi_i \\ge 0$.\n- Detailed balance (reversibility) requires $q_{ij} \\pi_i = q_{ji} \\pi_j$ for all $i \\ne j$.\n- Given an ergodic long trajectory, the stationary distribution can be consistently estimated by time fractions, namely $\\pi_i = T_i / \\sum_k T_k$, where $T_i$ is the total dwell time spent in state $i$ by the trajectory.\n- For a CTMC observed through counts of transitions $N_{ij}$ between states $i \\to j$ and total dwell times $T_i$, the Maximum Likelihood Estimation (MLE) is based on the standard CTMC log-likelihood over the observed sufficient statistics.\n\nYour program must:\n- Derive and implement the MLE for the reversible generator $Q$ from the counts matrix $N$ and dwell times $T$, enforcing detailed balance with respect to the stationary distribution obtained from $T$.\n- Ensure that off-diagonal elements $q_{ij}$ are nonnegative, diagonal elements $q_{ii}$ are set so that rows sum to zero, and detailed balance holds with the computed $\\pi$.\n\nPhysical units:\n- Interpret $T_i$ in seconds ($\\mathrm{s}$) and output generator rates $q_{ij}$ in inverse seconds ($\\mathrm{s}^{-1}$).\n- Express all rates in $\\mathrm{s}^{-1}$ rounded to six decimal places.\n\nTest suite:\n- Use the following four test cases with counts matrices $N^{(k)}$ and dwell time vectors $T^{(k)}$:\n\n1. Three-state system (unfolded, intermediate, folded) with frequent $U \\leftrightarrow I$ transitions and moderate $I \\leftrightarrow F$ transitions:\n   - $N^{(1)} = \\begin{pmatrix} 0 & 120 & 5 \\\\ 110 & 0 & 40 \\\\ 4 & 35 & 0 \\end{pmatrix}$\n   - $T^{(1)} = (300.0, 250.0, 450.0)$\n\n2. Three-state system with zero direct $U \\leftrightarrow F$ transitions observed:\n   - $N^{(2)} = \\begin{pmatrix} 0 & 50 & 0 \\\\ 60 & 0 & 5 \\\\ 0 & 7 & 0 \\end{pmatrix}$\n   - $T^{(2)} = (100.0, 400.0, 500.0)$\n\n3. Three-state system with a nearly absorbing folded state (very long dwell time, few transitions to or from $F$):\n   - $N^{(3)} = \\begin{pmatrix} 0 & 30 & 2 \\\\ 25 & 0 & 1 \\\\ 1 & 2 & 0 \\end{pmatrix}$\n   - $T^{(3)} = (200.0, 220.0, 1580.0)$\n\n4. Two-state system (unfolded and folded) to test a minimal reversible network:\n   - $N^{(4)} = \\begin{pmatrix} 0 & 20 \\\\ 18 & 0 \\end{pmatrix}$\n   - $T^{(4)} = (300.0, 700.0)$\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets.\n- Each element of the list corresponds to one test case and is itself a bracketed, comma-separated list containing the row-major flattening of the estimated generator matrix $Q$ in $\\mathrm{s}^{-1}$, rounded to six decimal places.\n- For example, the final output must look like: \"[[q11,q12,...],[...],[...],[...]]\" with the appropriate numbers replacing the placeholders.",
            "solution": "The problem requires the estimation of a reversible kinetic network for protein folding, modeled as a Continuous-Time Markov Chain (CTMC), from coarse-grained trajectory data. This task falls under the purview of statistical inference for stochastic processes. We will construct the generator matrix $Q$ of the CTMC via Maximum Likelihood Estimation (MLE), subject to the physical constraint of detailed balance.\n\nWe begin by formalizing the model. A CTMC on a finite set of $n$ states is characterized by its generator matrix, $Q \\in \\mathbb{R}^{n \\times n}$. The off-diagonal elements, $q_{ij}$ for $i \\ne j$, represent the instantaneous rate of transition from state $i$ to state $j$, and must be non-negative, $q_{ij} \\ge 0$. The diagonal elements, $q_{ii}$, are defined such that the rows of $Q$ sum to zero: $q_{ii} = -\\sum_{j \\ne i} q_{ij}$. The quantity $-q_{ii}$ is the total exit rate from state $i$.\n\nThe process admits a stationary distribution, denoted by the row vector $\\pi \\in \\mathbb{R}^{1 \\times n}$, which satisfies the global balance equation $\\pi^\\top Q = 0$, with the normalization $\\sum_i \\pi_i = 1$. For an ergodic process, the stationary probability $\\pi_i$ is the long-term fraction of time the system spends in state $i$. Given a long trajectory, $\\pi_i$ can be consistently estimated from the observed total dwell time $T_i$ in each state:\n$$ \\pi_i = \\frac{T_i}{\\sum_k T_k} $$\n\nA crucial physical requirement for systems at thermal equilibrium is reversibility, or detailed balance. This principle states that at equilibrium, the flux from state $i$ to $j$ must equal the flux from $j$ to $i$. Mathematically, this is expressed as:\n$$ \\pi_i q_{ij} = \\pi_j q_{ji} \\quad \\forall i, j $$\n\nThe goal is to find the maximum likelihood estimate of the rates $q_{ij}$ given the observed sufficient statistics: the matrix of transition counts $N$, where $N_{ij}$ is the number of observed transitions from state $i$ to $j$, and the vector of dwell times $T$, where $T_i$ is the total time spent in state $i$.\n\nThe log-likelihood function for a CTMC, given the statistics $(N, T)$, is:\n$$ \\mathcal{L}(Q) = \\sum_{i, j: i \\neq j} \\left( N_{ij} \\log q_{ij} - T_i q_{ij} \\right) $$\nWe must maximize this function subject to the detailed balance constraints. The constraints $\\pi_i q_{ij} = \\pi_j q_{ji}$ can be rewritten using the empirical estimate for $\\pi_i$ as $T_i q_{ij} = T_j q_{ji}$.\n\nTo solve this constrained optimization problem, it is convenient to introduce a symmetric matrix of fluxes, $S_{ij} = \\pi_i q_{ij}$. With this definition, the detailed balance condition $S_{ij} = S_{ji}$ is automatically satisfied. The rates can be expressed in terms of the fluxes as $q_{ij} = S_{ij} / \\pi_i$. Substituting this into the log-likelihood function gives:\n$$ \\mathcal{L}(S) = \\sum_{i \\neq j} \\left( N_{ij} \\log \\left(\\frac{S_{ij}}{\\pi_i}\\right) - T_i \\frac{S_{ij}}{\\pi_i} \\right) $$\nLet $T_{\\text{tot}} = \\sum_k T_k$. Since $\\pi_i = T_i / T_{\\text{tot}}$, the term $T_i / \\pi_i$ simplifies to the constant $T_{\\text{tot}}$. The log-likelihood becomes:\n$$ \\mathcal{L}(S) = \\sum_{i \\neq j} \\left( N_{ij} \\log S_{ij} - N_{ij} \\log \\pi_i - T_{\\text{tot}} S_{ij} \\right) $$\nSince $S$ is symmetric, we can combine terms for $(i, j)$ and $(j, i)$ and sum over pairs with $i < j$:\n$$ \\mathcal{L}(S) = \\sum_{i < j} \\left( (N_{ij} + N_{ji}) \\log S_{ij} - 2 T_{\\text{tot}} S_{ij} \\right) - \\sum_{i \\neq j} N_{ij} \\log \\pi_i $$\nTo maximize $\\mathcal{L}(S)$ with respect to the independent variables $S_{ij}$ (for $i < j$), we differentiate and set the derivative to zero. The terms involving $\\pi_i$ are constant with respect to $S_{ij}$.\n$$ \\frac{\\partial \\mathcal{L}}{\\partial S_{ij}} = \\frac{N_{ij} + N_{ji}}{S_{ij}} - 2 T_{\\text{tot}} = 0 $$\nSolving for $S_{ij}$ yields the maximum likelihood estimate:\n$$ S_{ij}^{\\text{MLE}} = \\frac{N_{ij} + N_{ji}}{2 T_{\\text{tot}}} $$\nFinally, we transform back from the flux $S_{ij}$ to the desired rate constant $q_{ij}$:\n$$ q_{ij}^{\\text{MLE}} = \\frac{S_{ij}^{\\text{MLE}}}{\\pi_i} = \\frac{(N_{ij} + N_{ji}) / (2 T_{\\text{tot}})}{T_i / T_{\\text{tot}}} = \\frac{N_{ij} + N_{ji}}{2 T_i} $$\nThis expression provides the MLE for the off-diagonal elements of a reversible generator matrix. The key insight is that the rate from $i$ to $j$ depends on the total number of observed transitions between the pair of states, $(N_{ij} + N_{ji})$, symmetrizing the information.\n\nThe complete algorithm is as follows:\n1. For each pair of distinct states $(i, j)$, calculate the off-diagonal element $q_{ij}$ of the generator matrix $Q$ using the derived formula: $q_{ij} = (N_{ij} + N_{ji}) / (2 T_i)$. Note that $N_{ji}$ is an element of the transpose of the matrix $N$.\n2. For each state $i$, calculate the diagonal element $q_{ii}$ by enforcing that the sum of each row is zero: $q_{ii} = - \\sum_{j \\neq i} q_{ij}$.\n3. This procedure yields the full generator matrix $Q$ which is guaranteed to be reversible with respect to the empirical stationary distribution. We apply this procedure to each test case provided.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem of estimating a reversible CTMC generator matrix from\n    transition counts and dwell times for a set of test cases.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"N\": np.array([[0, 120, 5], [110, 0, 40], [4, 35, 0]]),\n            \"T\": np.array([300.0, 250.0, 450.0])\n        },\n        {\n            \"N\": np.array([[0, 50, 0], [60, 0, 5], [0, 7, 0]]),\n            \"T\": np.array([100.0, 400.0, 500.0])\n        },\n        {\n            \"N\": np.array([[0, 30, 2], [25, 0, 1], [1, 2, 0]]),\n            \"T\": np.array([200.0, 220.0, 1580.0])\n        },\n        {\n            \"N\": np.array([[0, 20], [18, 0]]),\n            \"T\": np.array([300.0, 700.0])\n        }\n    ]\n\n    def estimate_reversible_q_matrix(N: np.ndarray, T: np.ndarray) -> np.ndarray:\n        \"\"\"\n        Estimates the reversible generator matrix Q from sufficient statistics.\n\n        Args:\n            N: The matrix of observed transition counts (N_ij from i to j).\n            T: The vector of observed dwell times in each state.\n\n        Returns:\n            The estimated reversible generator matrix Q.\n        \"\"\"\n        n_states = N.shape[0]\n        if n_states != len(T) or N.shape != (n_states, n_states):\n            raise ValueError(\"Dimensions of N and T are inconsistent.\")\n\n        # Symmetrize the transition counts: C_ij = N_ij + N_ji\n        C = N + N.T\n        \n        # Initialize the generator matrix Q\n        Q = np.zeros((n_states, n_states), dtype=np.float64)\n\n        # Estimate off-diagonal rates q_ij for i != j\n        # The formula derived from MLE with detailed balance is:\n        # q_ij = (N_ij + N_ji) / (2 * T_i)\n        for i in range(n_states):\n            if T[i] > 0:\n                for j in range(n_states):\n                    if i != j:\n                        Q[i, j] = C[i, j] / (2 * T[i])\n            # If T[i] is 0, the rates out of state i are 0, which is the default.\n\n        # Estimate diagonal elements q_ii = -sum(q_ij for j != i)\n        for i in range(n_states):\n            Q[i, i] = -np.sum(Q[i, :])\n\n        return Q\n\n    results = []\n    for case in test_cases:\n        N = case[\"N\"]\n        T = case[\"T\"]\n        \n        # Estimate the generator matrix\n        Q = estimate_reversible_q_matrix(N, T)\n        \n        # Flatten the matrix in row-major order and format for output\n        q_flat = Q.flatten().tolist()\n        q_formatted = [f\"{x:.6f}\" for x in q_flat]\n        result_str = f\"[{','.join(q_formatted)}]\"\n        results.append(result_str)\n\n    # Print the final output in the specified format\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}