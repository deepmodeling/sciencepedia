{
    "hands_on_practices": [
        {
            "introduction": "The first step to understanding and eliminating ghost forces is to see how they arise directly from the energy formulation of a coupled system. This foundational exercise guides you through a first-principles derivation for a simplified 1D harmonic chain . By calculating the variation of the quasicontinuum energy functional, you will analytically compute the non-physical residual force that emerges at the atomistic-continuum interface under a uniform deformation, providing a clear illustration of the underlying inconsistency.",
            "id": "3765543",
            "problem": "Consider a $1$-dimensional harmonic chain of atoms indexed by $i \\in \\{-N_{\\mathrm{a}},\\ldots,-1,0,1,\\ldots,M\\}$ with reference lattice spacing $a>0$. Let the deformed positions be $y_i \\in \\mathbb{R}$, and assume nearest-neighbor interactions with quadratic bond energy $\\frac{k}{2}\\big((y_{i+1}-y_i)-a\\big)^2$, where $k>0$ is the spring stiffness. The chain is partitioned into an atomistic subregion on the left, $\\mathcal{A}=\\{-N_{\\mathrm{a}},\\ldots,0\\}$, and a continuum subregion on the right, $\\mathcal{C}=\\{1,\\ldots,M\\}$, which is coarsened to a single finite element with nodes at atoms $i=1$ and $i=M$. The continuum energy is modeled by the Cauchy–Born rule: the strain energy density per unit reference length is $W(F)=\\frac{k a}{2}(F-1)^2$, where $F$ is the $1$-dimensional deformation gradient. The atomistic–continuum coupling is defined by the energy-based Quasicontinuum Energy-based (QCE) functional\n$$\n\\mathcal{E}_{\\mathrm{QCE}}(y) \\;=\\; \\sum_{i=-N_{\\mathrm{a}}}^{-1} \\frac{k}{2}\\big((y_{i+1}-y_i)-a\\big)^2 \\;+\\; \\int_{X=a}^{X=M a} W(F)\\,\\mathrm{d}X,\n$$\nwith the continuum element strain $F$ taken piecewise constant over $\\mathcal{C}$ via linear interpolation between the continuum nodes, that is,\n$$\nF \\;=\\; \\frac{y_M - y_1}{(M-1)a}.\n$$\nIn this coupling, the cross-interface bond $(0,1)$ is not included in the atomistic energy, and there is no special interface correction.\n\n(a) Starting from fundamental principles of energy minimization and static equilibrium (zero external body forces), derive the stationarity (equilibrium) equations for the QCE model by computing the first variation of $\\mathcal{E}_{\\mathrm{QCE}}(y)$ with respect to the atomistic degrees of freedom $y_i$ for $i\\in\\{-N_{\\mathrm{a}}+1,\\ldots,0\\}$ and the continuum nodal degrees of freedom $y_1$ and $y_M$.\n\n(b) Consider the homogeneous deformation $y_i=(1+\\epsilon)\\, i\\, a$ with constant strain $\\epsilon \\in \\mathbb{R}$, imposed by Dirichlet boundary conditions at the outermost atoms $y_{-N_{\\mathrm{a}}}=-(1+\\epsilon)N_{\\mathrm{a}}a$ and $y_M=(1+\\epsilon) M a$ and no external forces. Using the QCE equilibrium equations derived in part (a), analytically compute the residual internal force (the ghost force) at the first continuum node $i=1$ under this uniform strain state. Express your final answer for the ghost force in Newtons (N). No rounding is required; provide the exact closed-form expression in terms of $k$, $a$, and $\\epsilon$.",
            "solution": "The problem is valid as it is scientifically grounded in the principles of computational multiscale modeling, specifically the Quasicontinuum (QC) method. It is well-posed, objective, self-contained, and describes a standard, albeit simplified, scenario used to demonstrate the well-known artifact of \"ghost forces\" that arise from inconsistent energy-based coupling at an atomistic-continuum interface. The derivation and calculation are mathematically sound and address a core concept in the field.\n\nThe solution is presented in two parts as requested.\n\n(a) Derivation of the Stationarity (Equilibrium) Equations\n\nThe Quasicontinuum Energy-based (QCE) functional is given by\n$$\n\\mathcal{E}_{\\mathrm{QCE}}(y) \\;=\\; \\sum_{i=-N_{\\mathrm{a}}}^{-1} \\frac{k}{2}\\big((y_{i+1}-y_i)-a\\big)^2 \\;+\\; \\int_{X=a}^{X=M a} W(F)\\,\\mathrm{d}X\n$$\nwhere $y$ is the vector of all atomic positions $y_i$, the strain energy density is $W(F)=\\frac{k a}{2}(F-1)^2$, and the deformation gradient $F$ is constant over the continuum element, $F = \\frac{y_M - y_1}{(M-1)a}$. The integral can be evaluated directly, as the integrand is constant over the domain of integration $[a, Ma]$ of length $(M-1)a$:\n$$\n\\int_{X=a}^{X=M a} W(F)\\,\\mathrm{d}X = (M-1)a \\cdot W(F) = (M-1)a \\cdot \\frac{k a}{2}(F-1)^2 = \\frac{ka^2(M-1)}{2} \\left( \\frac{y_M-y_1}{(M-1)a} - 1 \\right)^2.\n$$\nSo the full energy functional can be written as:\n$$\n\\mathcal{E}_{\\mathrm{QCE}}(y) = \\sum_{i=-N_{\\mathrm{a}}}^{-1} \\frac{k}{2}(y_{i+1}-y_i-a)^2 + \\frac{ka^2(M-1)}{2} \\left( \\frac{y_M-y_1}{(M-1)a} - 1 \\right)^2.\n$$\nThe static equilibrium equations are obtained by requiring the first variation of the energy to be zero, which for a discrete system corresponds to setting the partial derivative of the energy with respect to each unconstrained degree of freedom to zero. The force on atom $j$ is $f_j = -\\frac{\\partial \\mathcal{E}_{\\mathrm{QCE}}}{\\partial y_j}$. In equilibrium with no external forces, $f_j=0$, so $\\frac{\\partial \\mathcal{E}_{\\mathrm{QCE}}}{\\partial y_j} = 0$.\n\nWe compute these derivatives for the specified nodes.\n\nFor an internal atomistic node $j \\in \\{-N_{\\mathrm{a}}+1, \\ldots, -1\\}$:\nThe position $y_j$ appears in two terms of the atomistic sum: the bond $(j-1, j)$ and the bond $(j, j+1)$.\n$$\n\\frac{\\partial \\mathcal{E}_{\\mathrm{QCE}}}{\\partial y_j} = \\frac{\\partial}{\\partial y_j} \\left[ \\frac{k}{2}(y_j-y_{j-1}-a)^2 + \\frac{k}{2}(y_{j+1}-y_j-a)^2 \\right]\n$$\n$$\n\\frac{\\partial \\mathcal{E}_{\\mathrm{QCE}}}{\\partial y_j} = k(y_j-y_{j-1}-a)(1) + k(y_{j+1}-y_j-a)(-1) = k(y_j-y_{j-1}-a) - k(y_{j+1}-y_j-a).\n$$\nThe equilibrium equation is: $k(y_j-y_{j-1}-a) - k(y_{j+1}-y_j-a) = 0$.\n\nFor the atomistic interface node $j=0$:\nThe position $y_0$ only appears in the bond $(-1,0)$ within the atomistic sum, as the summation index $i$ goes up to $-1$. The continuum energy does not depend on $y_0$.\n$$\n\\frac{\\partial \\mathcal{E}_{\\mathrm{QCE}}}{\\partial y_0} = \\frac{\\partial}{\\partial y_0} \\left[ \\frac{k}{2}(y_0-y_{-1}-a)^2 \\right] = k(y_0-y_{-1}-a).\n$$\nThe equilibrium equation is: $k(y_0-y_{-1}-a) = 0$.\n\nFor the continuum interface node $j=1$:\nThe position $y_1$ only appears in the continuum energy term.\n$$\n\\frac{\\partial \\mathcal{E}_{\\mathrm{QCE}}}{\\partial y_1} = \\frac{\\partial}{\\partial y_1} \\left[ \\frac{ka^2(M-1)}{2} \\left( \\frac{y_M-y_1}{(M-1)a} - 1 \\right)^2 \\right]\n$$\nUsing the chain rule:\n$$\n\\frac{\\partial \\mathcal{E}_{\\mathrm{QCE}}}{\\partial y_1} = \\frac{ka^2(M-1)}{2} \\cdot 2 \\left( \\frac{y_M-y_1}{(M-1)a} - 1 \\right) \\cdot \\frac{\\partial}{\\partial y_1}\\left( \\frac{y_M-y_1}{(M-1)a} \\right)\n$$\n$$\n\\frac{\\partial \\mathcal{E}_{\\mathrm{QCE}}}{\\partial y_1} = ka^2(M-1) \\left( \\frac{y_M-y_1}{(M-1)a} - 1 \\right) \\left( \\frac{-1}{(M-1)a} \\right) = -ka \\left( \\frac{y_M-y_1}{(M-1)a} - 1 \\right).\n$$\nThe equilibrium equation is: $-ka \\left( \\frac{y_M-y_1}{(M-1)a} - 1 \\right) = 0$.\n\nFor the continuum boundary node $j=M$:\nThe position $y_M$ also only appears in the continuum energy term.\n$$\n\\frac{\\partial \\mathcal{E}_{\\mathrm{QCE}}}{\\partial y_M} = \\frac{\\partial}{\\partial y_M} \\left[ \\frac{ka^2(M-1)}{2} \\left( \\frac{y_M-y_1}{(M-1)a} - 1 \\right)^2 \\right]\n$$\n$$\n\\frac{\\partial \\mathcal{E}_{\\mathrm{QCE}}}{\\partial y_M} = ka^2(M-1) \\left( \\frac{y_M-y_1}{(M-1)a} - 1 \\right) \\left( \\frac{1}{(M-1)a} \\right) = ka \\left( \\frac{y_M-y_1}{(M-1)a} - 1 \\right).\n$$\nThe equilibrium equation is: $ka \\left( \\frac{y_M-y_1}{(M-1)a} - 1 \\right) = 0$.\n\n(b) Calculation of the Ghost Force at Node $i=1$\n\nThe residual internal force, or ghost force, at a node $j$ is the net force on that node, $f_j = -\\frac{\\partial \\mathcal{E}_{\\mathrm{QCE}}}{\\partial y_j}$, when the system is subjected to a state of uniform deformation that should correspond to a natural equilibrium state. We evaluate this force at node $j=1$ for the homogeneous deformation $y_i=(1+\\epsilon)ia$.\n\nFrom part (a), the partial derivative of the energy with respect to $y_1$ is:\n$$\n\\frac{\\partial \\mathcal{E}_{\\mathrm{QCE}}}{\\partial y_1} = -ka \\left( \\frac{y_M-y_1}{(M-1)a} - 1 \\right).\n$$\nThe ghost force at node $1$ is therefore:\n$$\nf_{\\text{ghost},1} = - \\frac{\\partial \\mathcal{E}_{\\mathrm{QCE}}}{\\partial y_1} \\Bigg|_{y_i=(1+\\epsilon)ia} = ka \\left( \\frac{y_M-y_1}{(M-1)a} - 1 \\right) \\Bigg|_{y_i=(1+\\epsilon)ia}.\n$$\nWe substitute the positions for the homogeneous deformation into this expression. The relevant nodal positions are:\n$$\ny_1 = (1+\\epsilon)(1)a = (1+\\epsilon)a\n$$\n$$\ny_M = (1+\\epsilon)Ma\n$$\nSubstituting these into the expression for the ghost force:\n$$\nf_{\\text{ghost},1} = ka \\left( \\frac{(1+\\epsilon)Ma - (1+\\epsilon)a}{(M-1)a} - 1 \\right)\n$$\nFactor out the common terms in the numerator:\n$$\nf_{\\text{ghost},1} = ka \\left( \\frac{(1+\\epsilon)(M-1)a}{(M-1)a} - 1 \\right)\n$$\nCancel the $(M-1)a$ term:\n$$\nf_{\\text{ghost},1} = ka \\left( (1+\\epsilon) - 1 \\right)\n$$\nThis simplifies to:\n$$\nf_{\\text{ghost},1} = ka\\epsilon.\n$$\nThis non-zero force for $\\epsilon \\neq 0$ is the ghost force at the first continuum node. It signifies that the homogeneous deformation is not an equilibrium state of the QCE model, due to the inconsistent force balance at the interface. The force arises because the interaction between atoms $0$ and $1$ is not represented by a discrete atomistic bond in the energy functional, but is instead implicitly and inconsistently accounted for by the continuum model. The units of the expression are stiffness ($k$, force/length) times length ($a$), which correctly yields units of force, compatible with the request for the answer in Newtons (N).",
            "answer": "$$\\boxed{ka\\epsilon}$$"
        },
        {
            "introduction": "In computational mechanics, the patch test serves as a fundamental check for the consistency of a numerical method. This practice challenges you to implement several common 1D coupling strategies and subject them to a numerical patch test . By comparing the computed nodal forces against analytical predictions for both consistent and inconsistent schemes, you will gain hands-on experience in verifying the integrity of a multiscale model and diagnosing the presence of ghost forces.",
            "id": "3765609",
            "problem": "Consider a one-dimensional lattice of $N+1$ nodes indexed by $i=0,1,\\dots,N$ with reference lattice spacing $a>0$. The position of node $i$ is $x_i = i a + u_i$, where $u_i$ is the displacement. Neighbor interactions are governed by a harmonic pair potential $\\phi(r) = \\frac{k}{2}(r - a)^2$ with stiffness $k>0$. The total atomistic energy for the full lattice is\n$$\nE_{\\mathrm{a}}(x) = \\sum_{i=0}^{N-1} \\phi\\big(x_{i+1} - x_i\\big) = \\sum_{i=0}^{N-1} \\frac{k}{2}\\big(x_{i+1}-x_i-a\\big)^2.\n$$\nForces are defined as the negative gradient of the energy with respect to positions, i.e., $f_i = -\\frac{\\partial E}{\\partial x_i}$. In the complete atomistic model, for interior nodes $i=1,\\dots,N-1$, equilibrium under a uniform linear displacement field yields zero forces, i.e., the patch test passes.\n\nWe study multiscale couplings between an atomistic region and a continuum region in this one-dimensional setting. Let the atomistic region be $\\{0,1,\\dots,M\\}$ and the continuum region be $\\{M+1, M+2, \\dots, N\\}$ for an interface index $M\\in\\{0,1,\\dots,N-1\\}$. We evaluate three coupling strategies:\n\n1. A naive energy-based coupling that sums the atomistic energy over bonds in the atomistic region and sums a continuum Cauchy-Born energy over segments in the continuum region and, critically, double counts the interface bond $(M,M+1)$. This causes the so-called ghost force problem.\n2. A quasinonlocal (QNL) coupling that modifies the energy treatment at the interface to avoid double counting of the bond $(M,M+1)$, ensuring patch-test consistency for harmonic nearest-neighbor interactions.\n3. A force-based blending coupling that blends atomistic and continuum forces locally via a smooth blending function; this is nonconservative but is patch-test consistent since both constituent forces vanish under uniform strain.\n\nFor the harmonic nearest-neighbor case, the atomistic interior force at node $i\\in\\{1,\\dots,N-1\\}$ is\n$$\nf^{\\mathrm{a}}_i = k\\big[(x_i - x_{i-1} - a) - (x_{i+1} - x_i - a)\\big].\n$$\nThe continuum force for a uniform strain derived via the Cauchy-Born rule reduces, on the lattice, to the same discrete second-difference form for interior nodes, i.e.,\n$$\nf^{\\mathrm{c}}_i = k\\big[(x_i - x_{i-1} - a) - (x_{i+1} - x_i - a)\\big],\n$$\nwhich vanishes under uniform strain for interior nodes.\n\nDefine the patch-test displacements as either a rigid translation $u_i = c$ (constant $c\\in\\mathbb{R}$) or a uniform strain plus translation $u_i = \\epsilon i a + c$ (strain $\\epsilon\\in\\mathbb{R}$). Under these displacements, the pure atomistic and pure continuum models yield zero interior forces. In the naive coupling with double counting at the interface, for uniform strain the interior forces at nodes $M$ and $M+1$ become imbalanced due to the doubled contribution of the interface bond. Specifically, for $u_i = \\epsilon i a + c$, the analytical ghost force magnitude is\n$$\n\\|f\\|_{\\infty,\\mathrm{interface}} = k\\, a\\, \\epsilon,\n$$\nappearing as $f_M = -k a \\epsilon$ and $f_{M+1} = k a \\epsilon$ when both nodes are interior.\n\nWe define the patch-test residual as the infinity norm of the interior forces,\n$$\nR = \\max_{i\\in\\{1,\\dots,N-1\\}} |f_i|,\n$$\ncomputed from the chosen coupling strategy. We compare the computed numerical residual $R_{\\mathrm{num}}$ against the analytical expectation $R_{\\mathrm{ana}}$, which is $R_{\\mathrm{ana}}=0$ for all ghost-force-free configurations and $R_{\\mathrm{ana}}=k a \\epsilon$ for the naive coupling under uniform strain. For rigid translation ($\\epsilon=0$), $R_{\\mathrm{ana}}=0$ for all strategies.\n\nYour task is to implement a program that:\n- Constructs positions $x_i$ for each test case from $x_i = i a + \\epsilon i a + c$.\n- Computes interior forces $f_i$ under three coupling strategies:\n  - Naive energy-based coupling with interface bond double counting, modeled by weights $w^{\\mathrm{L}}_i$ and $w^{\\mathrm{R}}_i$ for the left $(i-1,i)$ and right $(i,i+1)$ bonds in the interior force expression $f_i = k\\big[w^{\\mathrm{L}}_i(x_i-x_{i-1}-a) - w^{\\mathrm{R}}_i(x_{i+1}-x_i-a)\\big]$; set $w^{\\mathrm{L}}_i=w^{\\mathrm{R}}_i=1$ except for the interface bond $(M,M+1)$ where $w^{\\mathrm{R}}_{M}=2$ and $w^{\\mathrm{L}}_{M+1}=2$.\n  - Quasinonlocal (QNL) coupling that uses $w^{\\mathrm{L}}_i=w^{\\mathrm{R}}_i=1$ everywhere (no double counting).\n  - Force-based blending coupling that computes $f^{\\mathrm{a}}_i$ and $f^{\\mathrm{c}}_i$ as above and blends $f_i = \\beta_i f^{\\mathrm{a}}_i + (1-\\beta_i) f^{\\mathrm{c}}_i$ using a blending function $\\beta_i$ equal to $1$ on the atomistic side, $0$ on the continuum side, and linearly ramping from $1$ to $0$ over a small number of nodes past $M$.\n- Computes the residual $R_{\\mathrm{num}}$ and compares to $R_{\\mathrm{ana}}$ with a provided tolerance $\\mathrm{tol}$, returning a boolean indicating whether $|R_{\\mathrm{num}} - R_{\\mathrm{ana}}| \\le \\mathrm{tol}$.\n\nPhysical units can be treated as dimensionless for this harmonic model; all quantities are unitless. Angles are not involved.\n\nTest Suite:\nProvide the following test cases, each as a tuple $(N,a,k,\\epsilon,c,\\mathrm{method},M,\\mathrm{tol},\\mathrm{blend\\_width})$ where $\\mathrm{blend\\_width}$ is only used for the force-based blending method (set to $0$ otherwise):\n1. $(50, 1.0, 200.0, 0.005, 0.0, \\text{\"qnl\"}, 25, 1\\text{e-12}, 0)$\n2. $(50, 1.0, 200.0, 0.005, 0.0, \\text{\"naive\"}, 25, 1\\text{e-12}, 0)$\n3. $(50, 1.0, 200.0, 0.0, 3.2, \\text{\"naive\"}, 25, 1\\text{e-12}, 0)$\n4. $(30, 0.8, 120.0, 0.02, -1.0, \\text{\"force\\_blend\"}, 12, 1\\text{e-12}, 3)$\n5. $(10, 1.0, 1000.0, 1\\text{e-12}, 0.0, \\text{\"naive\"}, 0, 1\\text{e-12}, 0)$\n\nAnalytical expectations for these cases are:\n- Case 1: $R_{\\mathrm{ana}}=0$ (ghost-force-free quasinonlocal coupling).\n- Case 2: $R_{\\mathrm{ana}}=k a \\epsilon=200.0\\times 1.0\\times 0.005=1.0$ (naive coupling under uniform strain).\n- Case 3: $R_{\\mathrm{ana}}=0$ (rigid translation).\n- Case 4: $R_{\\mathrm{ana}}=0$ (force-based blending under uniform strain).\n- Case 5: $R_{\\mathrm{ana}}=k a \\epsilon=1000.0\\times 1.0\\times 1\\text{e-12}=1\\text{e-9}$ (naive coupling at boundary interface under uniform strain; the interior node $i=1$ experiences the ghost force).\n\nFinal Output Format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3]\"). Each result should be the boolean outcome for the corresponding test case in the order listed above.",
            "solution": "The problem requires the numerical validation of three distinct atomistic-continuum coupling strategies in a one-dimensional harmonic lattice model. The validation is performed using a patch test, a fundamental verification procedure in computational mechanics. The patch test assesses whether a numerical method can exactly reproduce a constant strain state with zero nodal forces, a property that should hold for any physically consistent model. The failure of a method to pass this test indicates the presence of non-physical \"ghost forces\" at the interface between the atomistic and continuum domains.\n\nFirst, we establish the physical and mathematical model. The positions of the nodes in the one-dimensional lattice are given by $x_i = i a + u_i$ for $i=0, \\dots, N$, where $a$ is the reference lattice spacing and $u_i$ is the displacement of node $i$. The interaction between adjacent nodes is described by the harmonic potential $\\phi(r) = \\frac{k}{2}(r - a)^2$. The force on an interior node $i \\in \\{1, \\dots, N-1\\}$ is derived from the total energy $E = \\sum_{j=0}^{N-1} \\phi(x_{j+1}-x_j)$ as $f_i = -\\frac{\\partial E}{\\partial x_i}$. This yields the expression $f_i = k\\big[(x_{i+1}-x_i-a) - (x_i-x_{i-1}-a)\\big]$. The problem statement uses an alternative sign convention, $f_i = k\\big[(x_i - x_{i-1} - a) - (x_{i+1} - x_i - a)\\big]$, which we will adopt for consistency. Let us define the elongation of the bond between nodes $j-1$ and $j$ as $\\Delta_j = x_j - x_{j-1} - a$. Then the force on node $i$ can be written as $f_i = k(\\Delta_i - \\Delta_{i+1})$.\n\nThe patch test involves applying specific displacement fields. For a rigid translation, $u_i = c$, the bond elongations are $\\Delta_j = (ja+c) - ((j-1)a+c) - a = 0$ for all $j$. For a uniform strain, $u_i = \\epsilon i a + c$, the elongations are $\\Delta_j = (j(1+\\epsilon)a+c) - ((j-1)(1+\\epsilon)a+c) - a = a(1+\\epsilon) - a = \\epsilon a$. In both cases, the elongation $\\Delta_j$ is constant for all bonds $j$. Consequently, for a pure atomistic model, the interior force $f_i = k(\\Delta_j - \\Delta_j) = 0$. The patch test is passed.\n\nThe core of the problem is to evaluate the forces under different coupling schemes which partition the chain into an atomistic region $\\{0, \\ldots, M\\}$ and a continuum region $\\{M+1, \\ldots, N\\}$. The patch-test residual is defined as the maximum absolute force over the interior nodes, $R = \\max_{i\\in\\{1,\\dots,N-1\\}} |f_i|$.\n\n1.  **Naive Energy-Based Coupling**: This method models the total energy by summing atomistic and continuum contributions, but erroneously double-counts the energy of the interface bond $(M, M+1)$. The resulting forces for interior nodes are modeled by $f_i = k\\big[w^{\\mathrm{L}}_i \\Delta_i - w^{\\mathrm{R}}_i \\Delta_{i+1}\\big]$, where the weights are unity except for $w^{\\mathrm{R}}_{M}=2$ and $w^{\\mathrm{L}}_{M+1}=2$.\n    Under uniform strain, $\\Delta_j = \\epsilon a$ for all $j$. The forces are:\n    -   For $i \\notin \\{M, M+1\\}$ (and $i$ interior), $f_i = k(1 \\cdot \\epsilon a - 1 \\cdot \\epsilon a) = 0$.\n    -   At node $M$ (assuming $1 \\le M < N-1$), $f_M = k(w^{\\mathrm{L}}_M \\Delta_M - w^{\\mathrm{R}}_M \\Delta_{M+1}) = k(1 \\cdot \\epsilon a - 2 \\cdot \\epsilon a) = -ka\\epsilon$.\n    -   At node $M+1$ (assuming $1 < M+1 \\le N-1$), $f_{M+1} = k(w^{\\mathrm{L}}_{M+1} \\Delta_{M+1} - w^{\\mathrm{R}}_{M+1} \\Delta_{M+2}) = k(2 \\cdot \\epsilon a - 1 \\cdot \\epsilon a) = ka\\epsilon$.\n    These non-zero forces are the ghost forces. The analytical residual is $R_{\\mathrm{ana}} = \\max(|-ka\\epsilon|, |ka\\epsilon|, 0) = |ka\\epsilon|$. For rigid translation ($\\epsilon=0$), all forces are zero, so $R_{\\mathrm{ana}}=0$.\n\n2.  **Quasinonlocal (QNL) Coupling**: This method corrects the energy formulation to avoid double-counting. For the nearest-neighbor harmonic model, this is equivalent to using the standard atomistic force calculation across the entire chain. Hence, $w^{\\mathrm{L}}_i = w^{\\mathrm{R}}_i = 1$ for all interior nodes $i$. As shown before, for any constant strain field, $f_i = k(\\epsilon a - \\epsilon a) = 0$. Thus, $R_{\\mathrm{ana}}=0$ for both patch tests. The QNL method is patch-test consistent.\n\n3.  **Force-Based Blending Coupling**: This method constructs the force at each node by blending the atomistic and continuum forces: $f_i = \\beta_i f^{\\mathrm{a}}_i + (1-\\beta_i) f^{\\mathrm{c}}_i$. The problem states that for this harmonic model, the Cauchy-Born approximation for the continuum force yields a discrete expression identical to the atomistic one, i.e., $f^{\\mathrm{a}}_i = f^{\\mathrm{c}}_i = k(\\Delta_i - \\Delta_{i+1})$.\n    Therefore, the blended force is $f_i = \\beta_i f^{\\mathrm{a}}_i + (1-\\beta_i) f^{\\mathrm{a}}_i = f^{\\mathrm{a}}_i$.\n    The force calculation is identical to the pure atomistic (and QNL) case, regardless of the blending function $\\beta_i$. Consequently, under any patch-test displacement field, all interior forces are zero, and $R_{\\mathrm{ana}}=0$. This method is also patch-test consistent.\n\nThe implementation will proceed by first constructing the nodal positions $x_i$ for each test case. Then, it will calculate the bond elongations $\\Delta_j$. Based on the specified coupling method, the corresponding forces $f_i$ for interior nodes $i \\in \\{1, \\dots, N-1\\}$ are computed. The numerical residual $R_{\\mathrm{num}}$ is the maximum absolute value of these forces. Finally, this numerical result is compared against the pre-determined analytical residual $R_{\\mathrm{ana}}$ within the given tolerance. For the `force_blend` method, although it simplifies to the QNL method, the blending function $\\beta_i$ will be implemented as described: $\\beta_i=1$ for $i \\le M$, $\\beta_i=0$ for $i \\ge M + \\mathrm{blend\\_width}$, and linearly interpolated for $i \\in (M, M+\\mathrm{blend\\_width})$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_residual(N, a, k, epsilon, c, method, M, blend_width):\n    \"\"\"\n    Calculates the patch-test residual for a given 1D multiscale model setup.\n\n    Args:\n        N (int): Number of segments in the lattice (N+1 nodes).\n        a (float): Reference lattice spacing.\n        k (float): Stiffness constant.\n        epsilon (float): Uniform strain.\n        c (float): Rigid translation constant.\n        method (str): Coupling strategy ('naive', 'qnl', 'force_blend').\n        M (int): Index of the last atomistic node.\n        blend_width (int): Width of the blending region for 'force_blend'.\n\n    Returns:\n        float: The numerical patch-test residual, R_num.\n    \"\"\"\n    \n    # Step 1: Construct nodal positions\n    indices = np.arange(N + 1)\n    u = epsilon * indices * a + c\n    x = indices * a + u\n\n    # Step 2: Calculate bond elongations delta_j = x_j - x_{j-1} - a\n    # bond_elongations[j-1] corresponds to the bond (j-1, j), giving Delta_j\n    bond_elongations = x[1:] - x[:-1] - a\n    \n    # Step 3: Calculate interior forces\n    forces = np.zeros(N + 1)\n    interior_indices = range(1, N)\n\n    if method == \"qnl\":\n        for i in interior_indices:\n            # For QNL, forces are standard atomistic forces\n            # f_i = k * (Delta_i - Delta_{i+1})\n            delta_i = bond_elongations[i-1]\n            delta_i_plus_1 = bond_elongations[i]\n            forces[i] = k * (delta_i - delta_i_plus_1)\n\n    elif method == \"naive\":\n        for i in interior_indices:\n            # f_i = k * (w_L * Delta_i - w_R * Delta_{i+1})\n            w_L = 1.0\n            w_R = 1.0\n            if i == M:\n                w_R = 2.0\n            if i == M + 1:\n                w_L = 2.0\n            \n            delta_i = bond_elongations[i-1]\n            delta_i_plus_1 = bond_elongations[i]\n            forces[i] = k * (w_L * delta_i - w_R * delta_i_plus_1)\n\n    elif method == \"force_blend\":\n        # For this harmonic potential, f^a = f^c, so f_blend = f^a.\n        # The calculation is identical to QNL, but we can implement\n        # the blending logic for completeness.\n        beta = np.ones(N + 1)\n        if blend_width > 0:\n            for i in range(M + 1, M + blend_width):\n                beta[i] = 1.0 - (i - M) / float(blend_width)\n        beta[M + blend_width:] = 0.0\n\n        for i in interior_indices:\n            delta_i = bond_elongations[i-1]\n            delta_i_plus_1 = bond_elongations[i]\n            \n            f_a = k * (delta_i - delta_i_plus_1)\n            f_c = f_a  # As per problem description\n            \n            forces[i] = beta[i] * f_a + (1.0 - beta[i]) * f_c\n\n    # Step 4: Compute numerical residual\n    # The max is taken over interior nodes only.\n    if N > 1:\n        R_num = np.max(np.abs(forces[1:N]))\n    else:\n        R_num = 0.0\n        \n    return R_num\n\ndef solve():\n    \"\"\"\n    Main function to run test cases and print results.\n    \"\"\"\n    # Test cases: (N, a, k, epsilon, c, method, M, tol, blend_width)\n    test_cases = [\n        (50, 1.0, 200.0, 0.005, 0.0, \"qnl\", 25, 1e-12, 0),\n        (50, 1.0, 200.0, 0.005, 0.0, \"naive\", 25, 1e-12, 0),\n        (50, 1.0, 200.0, 0.0, 3.2, \"naive\", 25, 1e-12, 0),\n        (30, 0.8, 120.0, 0.02, -1.0, \"force_blend\", 12, 1e-12, 3),\n        (10, 1.0, 1000.0, 1e-12, 0.0, \"naive\", 0, 1e-12, 0),\n    ]\n\n    analytical_residuals = [\n        0.0,                                      # Case 1: qnl, passes patch test\n        200.0 * 1.0 * 0.005,                      # Case 2: naive, has ghost force |k*a*e|\n        0.0,                                      # Case 3: naive, rigid body motion\n        0.0,                                      # Case 4: force_blend, passes patch test\n        1000.0 * 1.0 * 1e-12,                     # Case 5: naive, M=0, ghost force at i=1\n    ]\n\n    results = []\n    for i, case in enumerate(test_cases):\n        N, a, k, epsilon, c, method, M, tol, blend_width = case\n        R_ana = analytical_residuals[i]\n        \n        R_num = calculate_residual(N, a, k, epsilon, c, method, M, blend_width)\n        \n        passed = np.abs(R_num - R_ana) <= tol\n        results.append(str(passed))\n\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "While patch tests are crucial for verification, the true measure of a method's utility is its performance in complex simulations. This practice demonstrates the tangible consequences of ghost forces in a 2D fracture mechanics problem . By implementing and comparing a method plagued by ghost forces (QCE) against a consistent one (QNL), you will quantify the error introduced into a critical engineering parameter—the stress intensity factor ($K$)—thereby highlighting why ghost force removal is essential for achieving predictive accuracy.",
            "id": "3765607",
            "problem": "Consider a two-dimensional anti-plane shear lattice model on a square grid that represents a crystalline solid with a semi-infinite crack. The displacement is a scalar field $w$ out of plane. The lattice nodes are indexed by integer coordinates $(x,y)$ with $x,y \\in \\{-L,-L+1,\\dots,L-1,L\\}$ and lattice spacing equal to $1$. Two nearest-neighbor bonds (horizontal and vertical) with identical linear springs of stiffness $k$ connect adjacent nodes. The total atomistic energy for an intact lattice (no crack) is\n$$\n\\mathcal{E}_{\\mathrm{A}}(w) \\;=\\; \\frac{1}{2} k \\sum_{\\langle i,j\\rangle} \\left(w_j - w_i\\right)^2,\n$$\nwhere the sum is over all intact nearest-neighbor bonds $\\langle i,j\\rangle$. Equilibrium displacements minimize $\\mathcal{E}_{\\mathrm{A}}(w)$ subject to boundary conditions, equivalently satisfying the discrete Euler–Lagrange equations given by the balance of linear spring forces. In the continuum limit, the Cauchy–Born rule identifies the energy density\n$$\nW(\\nabla w) \\;=\\; \\frac{\\mu}{2} \\left( \\left(\\frac{\\partial w}{\\partial x}\\right)^2 + \\left(\\frac{\\partial w}{\\partial y}\\right)^2 \\right),\n$$\nwith shear modulus $\\mu = k$, and the corresponding anti-plane equilibrium is $-\\mu \\Delta w = 0$ away from defects.\n\nA crack is introduced by removing all vertical bonds that cross the line $y=0$ for $x \\le -1$, i.e., bonds connecting $(x,0)$ to $(x,-1)$ for all integer $x \\le -1$. The crack tip is thus located at the origin. The specimen is loaded by prescribing a uniform anti-plane shear displacement on the outer boundary $\\partial\\Omega$,\n$$\nw(x,y)\\big|_{\\partial\\Omega} \\;=\\; \\gamma \\, y,\n$$\nfor a given shear parameter $\\gamma > 0$.\n\nWe compare two multiscale coupling methods between an atomistic region $\\mathcal{A}$ and a continuum region $\\mathcal{C}$ for this setting:\n\n- Quasicontinuum Energy-based (QCE): Define the atomistic region $\\mathcal{A} := \\{(x,y): x^2 + y^2 \\le R_{\\mathrm{A}}^2\\}$ and its complement in the computational domain $\\mathcal{C} := \\Omega \\setminus \\mathcal{A}$. The QCE energy is defined as the sum of atomistic bond energies for bonds with both endpoints in $\\mathcal{A}$ plus a continuum Cauchy–Born contribution for bonds with both endpoints in $\\mathcal{C}$. Bonds that cross between $\\mathcal{A}$ and $\\mathcal{C}$ are omitted in the QCE energy. This omission produces nonzero residual forces under uniform strain, known as ghost forces.\n\n- Quasi-Nonlocal (QNL): The QNL energy equals the atomistic bond energy for all bonds that are either entirely inside $\\mathcal{A}$ or crossing between $\\mathcal{A}$ and $\\mathcal{C}$, and uses the continuum Cauchy–Born contribution only for bonds entirely inside $\\mathcal{C}$. With nearest-neighbor linear springs and $\\mu = k$, the QNL energy equals the full atomistic energy for all bonds except those entirely within $\\mathcal{C}$, where the Cauchy–Born contribution coincides with the atomistic one. Therefore, QNL is patch-test consistent and removes ghost forces for uniform strains.\n\nLet the discrete set of intact bonds be $\\mathcal{B}$ after removing crack bonds as described above. For any bond $\\langle i,j\\rangle \\in \\mathcal{B}$, the contribution to the global stiffness has the standard $2\\times 2$ form $k \\begin{bmatrix} 1 & -1 \\\\ -1 & 1\\end{bmatrix}$ in the degrees of freedom corresponding to $i$ and $j$. Let $\\mathcal{B}_{\\mathcal{A}\\mathcal{A}} := \\{\\langle i,j\\rangle \\in \\mathcal{B} : i \\in \\mathcal{A}, j \\in \\mathcal{A}\\}$, $\\mathcal{B}_{\\mathcal{C}\\mathcal{C}} := \\{\\langle i,j\\rangle \\in \\mathcal{B} : i \\in \\mathcal{C}, j \\in \\mathcal{C}\\}$, and $\\mathcal{B}_{\\times} := \\{\\langle i,j\\rangle \\in \\mathcal{B} : i \\in \\mathcal{A}, j \\in \\mathcal{C} \\text{ or } i \\in \\mathcal{C}, j \\in \\mathcal{A}\\}$. Then:\n\n- The QCE stiffness uses $\\mathcal{B}_{\\mathcal{A}\\mathcal{A}} \\cup \\mathcal{B}_{\\mathcal{C}\\mathcal{C}}$.\n\n- The QNL stiffness uses $\\mathcal{B}_{\\mathcal{A}\\mathcal{A}} \\cup \\mathcal{B}_{\\mathcal{C}\\mathcal{C}} \\cup \\mathcal{B}_{\\times}$, i.e., all bonds in $\\mathcal{B}$.\n\nDefine the discrete shear stress magnitude at a cell center $(x+\\tfrac{1}{2}, y+\\tfrac{1}{2})$ by the discrete gradient magnitude\n$$\n\\left|\\nabla_h w\\right|(x+\\tfrac{1}{2}, y+\\tfrac{1}{2}) \\;=\\; \\sqrt{\\left(\\frac{w(x+1,y)+w(x+1,y+1)-w(x,y)-w(x,y+1)}{2}\\right)^2 + \\left(\\frac{w(x,y+1)+w(x+1,y+1)-w(x,y)-w(x+1,y)}{2}\\right)^2},\n$$\nand the corresponding shear stress magnitude $|\\boldsymbol{\\tau}| = \\mu \\left|\\nabla_h w\\right|$.\n\nIn the continuum anti-plane model, the Mode III stress intensity factor $K$ characterizes the near-tip singularity\n$$\n|\\boldsymbol{\\tau}|(r,\\theta) \\;\\approx\\; \\frac{K}{\\sqrt{2\\pi r}} \\quad \\text{as } r \\to 0^+,\n$$\nwhere $(r,\\theta)$ are polar coordinates centered at the crack tip. We estimate $K$ numerically from the discrete solution by sampling ahead of the crack tip in the upper half-plane near the line $\\theta = 0^+$, using\n$$\nK_{\\mathrm{est}} \\;=\\; \\operatorname{mean}_{j \\in \\mathcal{S}} \\left\\{ \\mu \\, \\left|\\nabla_h w\\right|(x_j+\\tfrac{1}{2}, \\tfrac{1}{2}) \\, \\sqrt{2\\pi \\, r_j} \\right\\},\n$$\nwhere $\\mathcal{S}$ is a chosen set of sampling indices ahead of the tip with $x_j \\in \\{1,2,\\dots\\}$ and $r_j = \\sqrt{(x_j+\\tfrac{1}{2})^2 + (\\tfrac{1}{2})^2}$.\n\nGhost forces are quantified under a uniform shear field in an intact lattice (no crack). Let $w^{\\mathrm{uni}}(x,y) = \\gamma y$ be the uniform anti-plane shear field. For QCE on an intact lattice, evaluate the residual force at each interior node\n$$\nf_i^{\\mathrm{QCE}} \\;=\\; -\\left.\\frac{\\partial \\mathcal{E}_{\\mathrm{QCE}}}{\\partial w_i}\\right|_{w = w^{\\mathrm{uni}}},\n$$\nwhich is nonzero only near the atomistic–continuum interface. Define the maximum ghost-force-induced stress scale by\n$$\nG_{\\max} \\;=\\; \\frac{\\max_{i \\,\\mathrm{interior}} |f_i^{\\mathrm{QCE}}|}{\\mu \\, \\gamma}.\n$$\n\nTask: For each test case below, assemble and solve the linear systems corresponding to QCE and QNL for the cracked lattice with the same boundary loading $w = \\gamma y$, and compute:\n\n- The displacement field $w^{\\mathrm{QCE}}$ and $w^{\\mathrm{QNL}}$ on the full grid.\n\n- The Mode III stress intensity factor estimates $K_{\\mathrm{QCE}}$ and $K_{\\mathrm{QNL}}$ by the sampling estimator defined above, with sampling set $\\mathcal{S} = \\{1,2,\\dots,R_{\\mathrm{fit}}\\}$ where $R_{\\mathrm{fit}} = \\min(6, L-2)$.\n\n- The relative error in $K$ for QCE with QNL taken as the reference:\n$$\n\\mathrm{err}_K \\;=\\; \\frac{|K_{\\mathrm{QCE}} - K_{\\mathrm{QNL}}|}{|K_{\\mathrm{QNL}}|}.\n$$\n\n- The maximum ghost-force-induced stress scale $G_{\\max}$ for the same partition but on the intact lattice (no crack), under the uniform field $w^{\\mathrm{uni}} = \\gamma y$.\n\nUse $k = 1$ so that $\\mu = 1$. All quantities are dimensionless. Angles are not directly used. Implement the computations exactly on the discrete grid as described, using linear algebra to impose the Dirichlet boundary conditions on the outer boundary.\n\nTest Suite:\n\n- Test $1$: $L = 15$, $R_{\\mathrm{A}} = 4$, $\\gamma = 0.01$.\n\n- Test $2$: $L = 15$, $R_{\\mathrm{A}} = 2$, $\\gamma = 0.01$.\n\n- Test $3$: $L = 22$, $R_{\\mathrm{A}} = 5$, $\\gamma = 0.02$.\n\nRequired final output format: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each test case’s result must be a list of two floats $[\\mathrm{err}_K, G_{\\max}]$ in this order. The overall output must therefore be a list of three such lists, e.g., $[[a_1,b_1],[a_2,b_2],[a_3,b_3]]$, with no additional text. All numerical answers are dimensionless floats. Round nothing; print full precision as produced by default string conversion of Python floats.",
            "solution": "The user has provided a problem from the field of computational multiscale modeling, specifically focusing on the comparison of two coupling schemes, Quasicontinuum Energy-based (QCE) and Quasi-Nonlocal (QNL), for simulating a cracked solid. The task is to quantify the error introduced by the so-called \"ghost forces\" in the QCE method.\n\n### **Problem Validation**\n\nFirst, the problem statement must be rigorously validated.\n\n**Step 1: Extract Givens**\n-   **Model**: A two-dimensional anti-plane shear problem on a square lattice with nodes at integer coordinates $(x,y)$ where $x,y \\in \\{-L, \\dots, L\\}$. Lattice spacing is $1$. Nearest-neighbor bonds are represented by linear springs of stiffness $k$.\n-   **Atomistic Energy**: $\\mathcal{E}_{\\mathrm{A}}(w) = \\frac{1}{2} k \\sum_{\\langle i,j\\rangle} (w_j - w_i)^2$.\n-   **Continuum Limit**: The continuum shear modulus is $\\mu = k$.\n-   **Crack Geometry**: All vertical bonds connecting nodes $(x,0)$ and $(x,-1)$ for $x \\le -1$ are removed. The crack tip is at the origin.\n-   **Boundary Conditions**: A uniform anti-plane shear displacement $w(x,y) = \\gamma y$ is prescribed on the outer boundary of the domain (where $|x|=L$ or $|y|=L$).\n-   **Multiscale Partition**: Atomistic region $\\mathcal{A} = \\{(x,y): x^2 + y^2 \\le R_{\\mathrm{A}}^2\\}$; continuum region $\\mathcal{C}$ is the complement.\n-   **QCE Method**: The stiffness matrix is assembled using only bonds with both endpoints in $\\mathcal{A}$ or both endpoints in $\\mathcal{C}$. Crossing bonds are omitted.\n-   **QNL Method**: The stiffness matrix is assembled using all intact bonds. For the given linear model, this is equivalent to a full atomistic simulation.\n-   **Stress Intensity Factor (SIF) Estimation**: The Mode III SIF, $K$, is estimated via $K_{\\mathrm{est}} = \\operatorname{mean}_{j \\in \\mathcal{S}} \\{ \\mu \\, |\\nabla_h w|(x_j+\\tfrac{1}{2}, \\tfrac{1}{2}) \\, \\sqrt{2\\pi \\, r_j} \\}$, with $|\\nabla_h w|$ being the discrete gradient magnitude, sampling indices $j \\in \\mathcal{S} = \\{1,2,\\dots,R_{\\mathrm{fit}}\\}$ where $R_{\\mathrm{fit}} = \\min(6, L-2)$, and $r_j = \\sqrt{(x_j+\\tfrac{1}{2})^2 + (\\tfrac{1}{2})^2}$.\n-   **Ghost Force Quantification**: The maximum ghost-force-induced stress scale is $G_{\\max} = \\frac{\\max_{i \\,\\mathrm{interior}} |f_i^{\\mathrm{QCE}}|}{\\mu \\, \\gamma}$, where $f_i^{\\mathrm{QCE}} = -\\frac{\\partial \\mathcal{E}_{\\mathrm{QCE}}}{\\partial w_i}$ is the residual force on an interior node $i$ under a uniform strain field $w^{\\mathrm{uni}} = \\gamma y$ on an *intact* lattice.\n-   **Quantities to be Computed**: The relative error in the SIF, $\\mathrm{err}_K = |K_{\\mathrm{QCE}} - K_{\\mathrm{QNL}}| / |K_{\\mathrm{QNL}}|$, and the ghost force metric $G_{\\max}$.\n-   **Parameters and Test Cases**: $k=1$ (so $\\mu=1$). Three test cases with specified values for $L$, $R_A$, and $\\gamma$.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded in established principles of computational solid mechanics and multiscale modeling. The QCE and QNL methods are standard examples of energy-based coupling schemes. The concept of ghost forces arising from the omission of inter-regional bonds in QCE is a well-known artifact. The problem is well-posed; it describes the assembly and solution of a sparse linear system for the unknown nodal displacements, which, given the Dirichlet boundary conditions, will have a unique solution. All quantities to be computed are defined with mathematical precision. The problem is objective, complete, and self-contained, providing all necessary information for an implementation.\n\n**Step 3: Verdict and Action**\nThe problem is **valid**. A solution will be developed and implemented.\n\n### **Methodology and Algorithmic Design**\n\nThe core of the problem is to solve a system of linear equations of the form $\\mathbf{K}\\mathbf{w} = \\mathbf{f}$ for the unknown displacements $\\mathbf{w}$ of the interior lattice nodes. The global stiffness matrix $\\mathbf{K}$ and force vector $\\mathbf{f}$ are constructed based on the principles of the finite element method applied to a discrete lattice.\n\n1.  **Grid and Discretization**:\n    A square grid of $(2L+1) \\times (2L+1)$ nodes is established. A mapping scheme is used to convert two-dimensional coordinates $(x,y)$ to a one-dimensional array index $p$, from $0$ to $(2L+1)^2-1$. Nodes are classified as either *interior* (degrees of freedom to be solved for) or *boundary* (displacements are prescribed). Further, each node is classified as belonging to the atomistic region $\\mathcal{A}$ or the continuum region $\\mathcal{C}$.\n\n2.  **Stiffness Matrix Assembly**:\n    We solve for the displacements of interior nodes. Let the set of interior node indices be $I$ and boundary indices be $B$. The full system of equilibrium equations $\\mathbf{K}_{\\mathrm{full}}\\mathbf{w}_{\\mathrm{full}} = \\mathbf{f}_{\\mathrm{ext}}$ can be partitioned as:\n    $$\n    \\begin{pmatrix} \\mathbf{K}_{II} & \\mathbf{K}_{IB} \\\\ \\mathbf{K}_{BI} & \\mathbf{K}_{BB} \\end{pmatrix} \\begin{pmatrix} \\mathbf{w}_I \\\\ \\mathbf{w}_B \\end{pmatrix} = \\begin{pmatrix} \\mathbf{f}_I \\\\ \\mathbf{f}_B \\end{pmatrix}\n    $$\n    Assuming no external forces on the interior nodes ($\\mathbf{f}_I=0$), the system to solve for the interior displacements $\\mathbf{w}_I$ becomes:\n    $$\n    \\mathbf{K}_{II} \\mathbf{w}_I = -\\mathbf{K}_{IB} \\mathbf{w}_B\n    $$\n    The stiffness matrix $\\mathbf{K}_{II}$ and the right-hand side vector $\\mathbf{b} = -\\mathbf{K}_{IB} \\mathbf{w}_B$ are assembled by iterating over all valid bonds in the model. A bond between nodes $i$ and $j$ contributes $+k$ to the diagonal elements $K_{ii}$ and $K_{jj}$, and $-k$ to the off-diagonal elements $K_{ij}$ and $K_{ji}$. If node $j$ is a boundary node, its displacement $w_j = \\gamma y_j$ is known. The term $-k w_j$ is moved to the right-hand side, contributing $+k w_j$ to the force vector component for node $i$.\n\n    This assembly process is performed twice:\n    -   **QCE**: Includes only bonds in $\\mathcal{B}_{\\mathcal{A}\\mathcal{A}} \\cup \\mathcal{B}_{\\mathcal{C}\\mathcal{C}}$ (i.e., those not crossing the $\\mathcal{A}-\\mathcal{C}$ interface).\n    -   **QNL**: Includes all intact bonds in the cracked lattice.\n\n    The resulting sparse linear systems are solved using `scipy.sparse.linalg.spsolve`.\n\n3.  **Calculation of Stress Intensity Factor ($K_{\\mathrm{QCE}}, K_{\\mathrm{QNL}}$)**:\n    Once the displacement fields $w^{\\mathrm{QCE}}$ and $w^{\\mathrm{QNL}}$ are obtained, the discrete gradient magnitude $|\\nabla_h w|$ is computed for cells just ahead of the crack tip $(x_j > 0, y=0)$. The specified formula is used, which is a centered difference approximation on a unit cell.\n    $$\n    (\\partial_x w)_h = \\frac{w(x+1,y)+w(x+1,y+1)-w(x,y)-w(x,y+1)}{2}, \\quad (\\partial_y w)_h = \\frac{w(x,y+1)+w(x+1,y+1)-w(x,y)-w(x+1,y)}{2}\n    $$\n    The SIF is then estimated by averaging the quantity $\\mu |\\nabla_h w| \\sqrt{2\\pi r}$ over the sampling points specified.\n\n4.  **Calculation of Relative Error ($\\mathrm{err}_K$)**:\n    The relative error is computed directly from the two SIF estimates: $\\mathrm{err}_K = |K_{\\mathrm{QCE}} - K_{\\mathrm{QNL}}| / |K_{\\mathrm{QNL}}|$.\n\n5.  **Calculation of Ghost Force Metric ($G_{\\max}$)**:\n    This metric is calculated on an intact lattice (no crack) under a uniform displacement field $w^{\\mathrm{uni}}(x,y)=\\gamma y$. The residual force on an interior node $i$ for the QCE model is:\n    $$\n    f_i^{\\mathrm{QCE}} = \\sum_{j \\in N_i^{\\mathrm{QCE}}} k(w_j^{\\mathrm{uni}} - w_i^{\\mathrm{uni}}) = k\\gamma \\sum_{j \\in N_i^{\\mathrm{QCE}}} (y_j - y_i)\n    $$\n    where $N_i^{\\mathrm{QCE}}$ are the neighbors of $i$ such that the bond $\\langle i,j \\rangle$ is included in the QCE model (i.e., $j$ is in the same region, $\\mathcal{A}$ or $\\mathcal{C}$, as $i$). The metric $G_{\\max}$ is then:\n    $$\n    G_{\\max} = \\frac{\\max_i |f_i^{\\mathrm{QCE}}|}{\\mu\\gamma} = \\max_i \\left| \\sum_{j \\in N_i^{\\mathrm{QCE}}} (y_j - y_i) \\right|\n    $$\n    This value is computed by iterating through all interior nodes, calculating the sum for each, and find the maximum of their absolute values. For a nearest-neighbor square lattice, this sum evaluates to an integer. Non-zero values arise only for nodes adjacent to the $\\mathcal{A}-\\mathcal{C}$ interface.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.sparse import lil_matrix\nfrom scipy.sparse.linalg import spsolve\n\ndef solve():\n    \"\"\"\n    Main function to orchestrate the solving process for all test cases and print the final output.\n    \"\"\"\n    test_cases = [\n        {'L': 15, 'R_A': 4, 'gamma': 0.01},\n        {'L': 15, 'R_A': 2, 'gamma': 0.01},\n        {'L': 22, 'R_A': 5, 'gamma': 0.02},\n    ]\n\n    results = []\n    for case in test_cases:\n        result = solve_case(**case)\n        results.append(result)\n\n    # Format the final output string as a list of lists of floats.\n    # e.g., [[err_K1,G_max1],[err_K2,G_max2],[err_K3,G_max3]]\n    output_str = '[' + ','.join([f'[{r[0]},{r[1]}]' for r in results]) + ']'\n    print(output_str)\n\ndef solve_case(L, R_A, gamma):\n    \"\"\"\n    Solves the problem for a single specified test case. It computes the relative\n    error in the stress intensity factor (err_K) and the maximum ghost-force\n    induced stress scale (G_max).\n    \"\"\"\n    k = 1.0\n    mu = 1.0\n    side = 2 * L + 1\n    n_nodes = side * side\n    R_A_sq = R_A**2\n\n    # Helper functions for mapping between 2D coordinates and 1D indices\n    def coord_to_idx(x, y):\n        ix, iy = int(round(x)) + L, int(round(y)) + L\n        return iy * side + ix\n\n    def idx_to_coord(idx):\n        iy = idx // side\n        ix = idx % side\n        return float(ix - L), float(iy - L)\n\n    # Pre-compute node properties: interior, in atomistic region A, and mappings\n    is_interior = np.ones(n_nodes, dtype=bool)\n    is_in_A = np.zeros(n_nodes, dtype=bool)\n    interior_indices = []\n    global_to_interior = -np.ones(n_nodes, dtype=int)\n    interior_counter = 0\n\n    for i in range(n_nodes):\n        x, y = idx_to_coord(i)\n        if abs(x) == L or abs(y) == L:\n            is_interior[i] = False\n        else:\n            global_to_interior[i] = interior_counter\n            interior_indices.append(i)\n            interior_counter += 1\n        \n        if x**2 + y**2 = R_A_sq:\n            is_in_A[i] = True\n    \n    n_interior = len(interior_indices)\n\n    def build_and_solve(use_qce_rule):\n        \"\"\"Builds and solves the linear system for the cracked lattice.\"\"\"\n        K_II = lil_matrix((n_interior, n_interior), dtype=float)\n        b_I = np.zeros(n_interior, dtype=float)\n        \n        for i in interior_indices:\n            i_int_idx = global_to_interior[i]\n            xi, yi = idx_to_coord(i)\n            \n            neighbors_coords = [(xi, yi + 1), (xi, yi - 1), (xi + 1, yi), (xi - 1, yi)]\n            \n            for xj, yj in neighbors_coords:\n                if not (abs(xj) = L and abs(yj) = L):\n                    continue\n                j = coord_to_idx(xj, yj)\n\n                is_crack_bond = (xi == xj and xi = -1 and \n                                 ((yi == 0 and yj == -1) or (yi == -1 and yj == 0)))\n                if is_crack_bond:\n                    continue\n                \n                include_bond = True\n                if use_qce_rule and (is_in_A[i] != is_in_A[j]):\n                    include_bond = False\n\n                if include_bond:\n                    K_II[i_int_idx, i_int_idx] += k\n                    if is_interior[j]:\n                        j_int_idx = global_to_interior[j]\n                        K_II[i_int_idx, j_int_idx] -= k\n                    else:\n                        b_I[i_int_idx] += k * (gamma * yj)\n\n        w_I = spsolve(K_II.tocsr(), b_I)\n        \n        w_full = np.zeros(n_nodes, dtype=float)\n        for i in range(n_nodes):\n            if is_interior[i]:\n                w_full[i] = w_I[global_to_interior[i]]\n            else:\n                x, y = idx_to_coord(i)\n                w_full[i] = gamma * y\n        return w_full\n\n    w_qce = build_and_solve(use_qce_rule=True)\n    w_qnl = build_and_solve(use_qce_rule=False)\n\n    def compute_K_est(w):\n        \"\"\"Estimates the Stress Intensity Factor, K.\"\"\"\n        R_fit = min(6, L - 2)\n        K_samples = []\n        for xj_int in range(1, R_fit + 1):\n            x, y = float(xj_int), 0.0\n            \n            w00 = w[coord_to_idx(x, y)]\n            w10 = w[coord_to_idx(x + 1, y)]\n            w01 = w[coord_to_idx(x, y + 1)]\n            w11 = w[coord_to_idx(x + 1, y + 1)]\n            \n            dw_dx_h = (w10 + w11 - w00 - w01) / 2.0\n            dw_dy_h = (w01 + w11 - w00 - w10) / 2.0\n            grad_w_mag = np.sqrt(dw_dx_h**2 + dw_dy_h**2)\n            \n            rx, ry = x + 0.5, 0.5\n            r_j = np.sqrt(rx**2 + ry**2)\n            \n            K_sample = mu * grad_w_mag * np.sqrt(2 * np.pi * r_j)\n            K_samples.append(K_sample)\n        \n        return np.mean(K_samples) if K_samples else 0.0\n    \n    K_qce = compute_K_est(w_qce)\n    K_qnl = compute_K_est(w_qnl)\n\n    err_K = abs(K_qce - K_qnl) / abs(K_qnl) if abs(K_qnl) > 1e-15 else 0.0\n\n    max_force_term = 0.0\n    for i in interior_indices:\n        xi, yi = idx_to_coord(i)\n        neighbors_coords = [(xi, yi + 1), (xi, yi - 1), (xi + 1, yi), (xi - 1, yi)]\n        force_term = 0.0\n        for xj, yj in neighbors_coords:\n            if not (abs(xj) = L and abs(yj) = L):\n                continue\n            j = coord_to_idx(xj, yj)\n            if is_in_A[i] == is_in_A[j]:\n                force_term += (yj - yi)\n        max_force_term = max(max_force_term, abs(force_term))\n    \n    G_max = max_force_term\n\n    return [err_K, G_max]\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}