{
    "hands_on_practices": [
        {
            "introduction": "A cornerstone of the Heterogeneous Multiscale Method (HMM) is the ability to derive macroscopic effective properties from underlying microscopic structures. This first exercise provides a fundamental, analytical demonstration of this principle. By considering a simple, layered medium, we can explicitly solve the microscale cell problem and compute the homogenized diffusion tensor, offering clear insight into how geometric arrangement at the microscale dictates the effective behavior, such as anisotropy, at the macroscale .",
            "id": "3767072",
            "problem": "Consider the second-order elliptic boundary value problem with rapidly oscillating coefficients,\n$$\n-\\nabla \\cdot \\big( a\\!\\left(\\tfrac{\\boldsymbol{x}}{\\varepsilon}\\right) \\nabla u^{\\varepsilon}(\\boldsymbol{x}) \\big) = f(\\boldsymbol{x})\n\\quad \\text{in} \\quad \\Omega \\subset \\mathbb{R}^{2},\n$$\nwhere $\\varepsilon > 0$ is a small-scale parameter and $a(\\boldsymbol{y})$ is a strictly positive, bounded, $\\mathbb{Z}^{2}$-periodic scalar field. Assume the microstructure is layered: $a(\\boldsymbol{y})$ depends only on the first coordinate, i.e., $a(\\boldsymbol{y}) = a(y_1)$, and is piecewise constant over one period according to\n$$\na(y_1) =\n\\begin{cases}\na_{1}, & 0 \\leq y_1 < \\theta, \\\\\na_{2}, & \\theta \\leq y_1 < 1,\n\\end{cases}\n\\quad \\text{with periodic extension,}\n$$\nwhere $a_1 > 0$, $a_2 > 0$, and $0  \\theta  1$. Let $Y=(0,1)^2$ be the reference microcell.\n\nUsing the Heterogeneous Multiscale Method (HMM), defined here as follows: for each prescribed constant macroscopic gradient $\\boldsymbol{d} \\in \\{\\boldsymbol{e}_{1}, \\boldsymbol{e}_{2}\\}$, solve the micro cell problem on $Y$\n$$\n-\\nabla_{\\boldsymbol{y}} \\cdot \\big( a(y_1) \\big( \\boldsymbol{d} + \\nabla_{\\boldsymbol{y}} w^{\\boldsymbol{d}}(\\boldsymbol{y}) \\big) \\big) = 0\n\\quad \\text{in } Y,\n$$\nwith periodic boundary conditions on $\\partial Y$ and the gauge constraint $\\int_{Y} w^{\\boldsymbol{d}}(\\boldsymbol{y})\\,\\mathrm{d}\\boldsymbol{y} = 0$, and define the homogenized flux by directional averaging\n$$\n\\boldsymbol{q}^{\\ast}(\\boldsymbol{d}) = \\frac{1}{|Y|} \\int_{Y} a(y_1) \\big( \\boldsymbol{d} + \\nabla_{\\boldsymbol{y}} w^{\\boldsymbol{d}}(\\boldsymbol{y}) \\big)\\,\\mathrm{d}\\boldsymbol{y}.\n$$\nThe homogenized (effective) diffusion tensor $\\boldsymbol{A}^{\\ast}$ is defined by $\\boldsymbol{q}^{\\ast}(\\boldsymbol{d}) = \\boldsymbol{A}^{\\ast}\\boldsymbol{d}$ for each $\\boldsymbol{d}\\in\\{\\boldsymbol{e}_{1},\\boldsymbol{e}_{2}\\}$.\n\nStarting from these definitions and standard properties of divergence-form elliptic operators and periodic microproblems, derive the explicit analytical expression for the homogenized tensor $\\boldsymbol{A}^{\\ast}$ in terms of $a_{1}$, $a_{2}$, and $\\theta$. Express your final answer as a $2\\times 2$ matrix. No rounding is required. Treat $a_{1}$, $a_{2}$, and $\\theta$ as dimensionless parameters and report a dimensionless result.",
            "solution": "The problem statement is a well-posed, self-contained, and scientifically sound exercise in the field of multiscale analysis and homogenization theory. It asks for the derivation of the effective diffusion tensor for a layered medium using the Heterogeneous Multiscale Method (HMM) framework. All definitions and parameters are provided, and no contradictions or ambiguities are present. Therefore, the problem is valid, and we may proceed with the solution.\n\nThe objective is to compute the homogenized tensor $\\boldsymbol{A}^{\\ast}$, defined by the linear relationship $\\boldsymbol{q}^{\\ast}(\\boldsymbol{d}) = \\boldsymbol{A}^{\\ast}\\boldsymbol{d}$. The columns of the $2 \\times 2$ matrix $\\boldsymbol{A}^{\\ast}$ can be determined by evaluating the homogenized flux $\\boldsymbol{q}^{\\ast}(\\boldsymbol{d})$ for the standard basis vectors $\\boldsymbol{d} = \\boldsymbol{e}_{1}$ and $\\boldsymbol{d} = \\boldsymbol{e}_{2}$, where $\\boldsymbol{e}_{1} = (1, 0)^{T}$ and $\\boldsymbol{e}_{2} = (0, 1)^{T}$. Specifically, the $j$-th column of $\\boldsymbol{A}^{\\ast}$ is the vector $\\boldsymbol{q}^{\\ast}(\\boldsymbol{e}_{j})$.\n\nLet $\\boldsymbol{y} = (y_1, y_2)$ be the coordinates in the microcell $Y = (0,1)^2$. The coefficient $a(\\boldsymbol{y})$ is given as $a(y_1)$, independent of $y_2$.\n\n**Step 1: Determine the first column of $\\boldsymbol{A}^{\\ast}$**\n\nWe set the macroscopic gradient to $\\boldsymbol{d} = \\boldsymbol{e}_{1} = (1,0)^{T}$. The corresponding microproblem for the corrector function $w^{\\boldsymbol{e}_{1}}(\\boldsymbol{y})$, which we denote simply as $w(\\boldsymbol{y})$, is:\n$$\n-\\nabla_{\\boldsymbol{y}} \\cdot \\left( a(y_1) \\left( \\boldsymbol{e}_{1} + \\nabla_{\\boldsymbol{y}} w(\\boldsymbol{y}) \\right) \\right) = 0 \\quad \\text{in } Y,\n$$\nwith periodic boundary conditions on $\\partial Y$. In component form, this equation becomes:\n$$\n-\\frac{\\partial}{\\partial y_1} \\left( a(y_1) \\left( 1 + \\frac{\\partial w}{\\partial y_1} \\right) \\right) - \\frac{\\partial}{\\partial y_2} \\left( a(y_1) \\frac{\\partial w}{\\partial y_2} \\right) = 0.\n$$\nGiven that the coefficient $a(y_1)$ depends only on $y_1$ and the forcing is in the $y_1$ direction, it is natural to seek a solution that also depends only on $y_1$, i.e., $w(\\boldsymbol{y}) = w(y_1)$. With this ansatz, $\\frac{\\partial w}{\\partial y_2} = 0$, and the equation simplifies to an ordinary differential equation:\n$$\n-\\frac{d}{d y_1} \\left( a(y_1) \\left( 1 + \\frac{d w}{d y_1} \\right) \\right) = 0.\n$$\nIntegrating with respect to $y_1$ yields:\n$$\na(y_1) \\left( 1 + \\frac{d w}{d y_1} \\right) = C_{1},\n$$\nwhere $C_{1}$ is a constant of integration. We can solve for the gradient of $w$:\n$$\n\\frac{d w}{d y_1} = \\frac{C_{1}}{a(y_1)} - 1.\n$$\nThe function $w(y_1)$ must be periodic, which implies that its integral over one period must be zero: $w(1) - w(0) = \\int_{0}^{1} \\frac{d w}{d y_1} \\, \\mathrm{d} y_1 = 0$. This condition allows us to determine $C_{1}$:\n$$\n\\int_{0}^{1} \\left( \\frac{C_{1}}{a(y_1)} - 1 \\right) \\mathrm{d} y_1 = 0 \\implies C_{1} \\int_{0}^{1} \\frac{1}{a(y_1)} \\mathrm{d} y_1 = \\int_{0}^{1} 1 \\, \\mathrm{d} y_1 = 1.\n$$\nThus, $C_{1}$ is the harmonic average of $a(y_1)$:\n$$\nC_{1} = \\left( \\int_{0}^{1} \\frac{1}{a(y_1)} \\mathrm{d} y_1 \\right)^{-1}.\n$$\nUsing the piecewise constant definition of $a(y_1)$:\n$$\n\\int_{0}^{1} \\frac{1}{a(y_1)} \\mathrm{d} y_1 = \\int_{0}^{\\theta} \\frac{1}{a_{1}} \\mathrm{d} y_1 + \\int_{\\theta}^{1} \\frac{1}{a_{2}} \\mathrm{d} y_1 = \\frac{\\theta}{a_{1}} + \\frac{1-\\theta}{a_{2}}.\n$$\nSo, $C_{1} = \\left( \\frac{\\theta}{a_{1}} + \\frac{1-\\theta}{a_{2}} \\right)^{-1}$.\n\nThe first column of $\\boldsymbol{A}^{\\ast}$ is the vector $\\boldsymbol{q}^{\\ast}(\\boldsymbol{e}_{1})$. Since $|Y|=1$, it is given by:\n$$\n\\boldsymbol{q}^{\\ast}(\\boldsymbol{e}_{1}) = \\int_{Y} a(y_1) \\left( \\boldsymbol{e}_{1} + \\nabla_{\\boldsymbol{y}} w(\\boldsymbol{y}) \\right) \\mathrm{d}\\boldsymbol{y}.\n$$\nThe first component is:\n$$\nq^{\\ast}_{1}(\\boldsymbol{e}_{1}) = \\int_{0}^{1}\\int_{0}^{1} a(y_1) \\left( 1 + \\frac{\\partial w}{\\partial y_1} \\right) \\mathrm{d} y_1 \\mathrm{d} y_2 = \\int_{0}^{1}\\int_{0}^{1} C_{1} \\, \\mathrm{d} y_1 \\mathrm{d} y_2 = C_{1}.\n$$\nThe second component is:\n$$\nq^{\\ast}_{2}(\\boldsymbol{e}_{1}) = \\int_{0}^{1}\\int_{0}^{1} a(y_1) \\frac{\\partial w}{\\partial y_2} \\, \\mathrm{d} y_1 \\mathrm{d} y_2 = 0,\n$$\nsince $\\frac{\\partial w}{\\partial y_2}=0$. Therefore, the first column of $\\boldsymbol{A}^{\\ast}$ is $(C_{1}, 0)^{T}$.\n$$\nA_{11}^{\\ast} = \\left( \\frac{\\theta}{a_{1}} + \\frac{1-\\theta}{a_{2}} \\right)^{-1}, \\quad A_{21}^{\\ast} = 0.\n$$\n\n**Step 2: Determine the second column of $\\boldsymbol{A}^{\\ast}$**\n\nWe set the macroscopic gradient to $\\boldsymbol{d} = \\boldsymbol{e}_{2} = (0,1)^{T}$. The microproblem for $w^{\\boldsymbol{e}_{2}}(\\boldsymbol{y})$, again denoted $w(\\boldsymbol{y})$, is:\n$$\n-\\nabla_{\\boldsymbol{y}} \\cdot \\left( a(y_1) \\left( \\boldsymbol{e}_{2} + \\nabla_{\\boldsymbol{y}} w(\\boldsymbol{y}) \\right) \\right) = 0 \\quad \\text{in } Y.\n$$\nExpanding this, we get:\n$$\n-\\nabla_{\\boldsymbol{y}} \\cdot (a(y_1)\\nabla_{\\boldsymbol{y}} w) - \\nabla_{\\boldsymbol{y}} \\cdot (a(y_1)\\boldsymbol{e}_{2}) = 0.\n$$\nThe second term is $\\nabla_{\\boldsymbol{y}} \\cdot (a(y_1)\\boldsymbol{e}_{2}) = \\frac{\\partial}{\\partial y_1}(a(y_1) \\cdot 0) + \\frac{\\partial}{\\partial y_2}(a(y_1) \\cdot 1) = \\frac{\\partial a(y_1)}{\\partial y_2} = 0$.\nThe microproblem for $w$ thus simplifies to a homogeneous equation:\n$$\n-\\nabla_{\\boldsymbol{y}} \\cdot (a(y_1)\\nabla_{\\boldsymbol{y}} w) = 0 \\quad \\text{in } Y.\n$$\nFor a strictly positive coefficient $a(y_1)$, the only periodic solutions to this elliptic equation are constants, $w(\\boldsymbol{y}) = C_{2}$. Applying the gauge constraint $\\int_{Y} w(\\boldsymbol{y})\\,\\mathrm{d}\\boldsymbol{y} = 0$:\n$$\n\\int_{Y} C_{2} \\, \\mathrm{d}\\boldsymbol{y} = C_{2} |Y| = C_{2} \\cdot 1 = 0 \\implies C_{2} = 0.\n$$\nThus, the unique solution is $w^{\\boldsymbol{e}_{2}}(\\boldsymbol{y}) = 0$.\n\nThe second column of $\\boldsymbol{A}^{\\ast}$ is the vector $\\boldsymbol{q}^{\\ast}(\\boldsymbol{e}_{2})$:\n$$\n\\boldsymbol{q}^{\\ast}(\\boldsymbol{e}_{2}) = \\int_{Y} a(y_1) \\left( \\boldsymbol{e}_{2} + \\nabla_{\\boldsymbol{y}} w(\\boldsymbol{y}) \\right) \\mathrm{d}\\boldsymbol{y} = \\int_{Y} a(y_1) (\\boldsymbol{e}_{2} + \\boldsymbol{0}) \\, \\mathrm{d}\\boldsymbol{y} = \\boldsymbol{e}_{2} \\int_{Y} a(y_1) \\, \\mathrm{d}\\boldsymbol{y}.\n$$\nThe integral corresponds to the arithmetic average of $a(y_1)$ over the cell:\n$$\n\\int_{Y} a(y_1) \\, \\mathrm{d}\\boldsymbol{y} = \\int_{0}^{1}\\int_{0}^{1} a(y_1) \\, \\mathrm{d} y_1 \\mathrm{d} y_2 = \\int_{0}^{1} a(y_1) \\, \\mathrm{d} y_1 = \\int_{0}^{\\theta} a_{1} \\, \\mathrm{d} y_1 + \\int_{\\theta}^{1} a_{2} \\, \\mathrm{d} y_1 = \\theta a_{1} + (1-\\theta)a_{2}.\n$$\nSo, the second column is $(0, \\theta a_{1} + (1-\\theta)a_{2})^{T}$.\n$$\nA_{12}^{\\ast} = 0, \\quad A_{22}^{\\ast} = \\theta a_{1} + (1-\\theta)a_{2}.\n$$\n\n**Step 3: Assemble the homogenized tensor $\\boldsymbol{A}^{\\ast}$**\n\nCombining the columns, we obtain the homogenized tensor $\\boldsymbol{A}^{\\ast}$:\n$$\n\\boldsymbol{A}^{\\ast} = \\begin{pmatrix} A_{11}^{\\ast}  A_{12}^{\\ast} \\\\ A_{21}^{\\ast}  A_{22}^{\\ast} \\end{pmatrix} = \\begin{pmatrix} \\left( \\frac{\\theta}{a_{1}} + \\frac{1-\\theta}{a_{2}} \\right)^{-1}  0 \\\\ 0  \\theta a_{1} + (1-\\theta)a_{2} \\end{pmatrix}.\n$$\nThis is a diagonal tensor. The term $A_{11}^{\\ast}$ is the harmonic average, which accounts for effective transport perpendicular to the layers. The term $A_{22}^{\\ast}$ is the arithmetic average, for transport parallel to the layers. Simplifying the expression for $A_{11}^{\\ast}$:\n$$\nA_{11}^{\\ast} = \\left( \\frac{\\theta a_{2} + (1-\\theta)a_{1}}{a_{1}a_{2}} \\right)^{-1} = \\frac{a_{1}a_{2}}{\\theta a_{2} + (1-\\theta)a_{1}}.\n$$\nThe final expression for the homogenized tensor is:\n$$\n\\boldsymbol{A}^{\\ast} = \\begin{pmatrix} \\frac{a_{1}a_{2}}{\\theta a_{2} + (1-\\theta)a_{1}}  0 \\\\ 0  \\theta a_{1} + (1-\\theta)a_{2} \\end{pmatrix}.\n$$",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{a_{1}a_{2}}{\\theta a_{2} + (1-\\theta)a_{1}}  0 \\\\\n0  \\theta a_{1} + (1-\\theta)a_{2}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "After computing an effective tensor, the next logical step is to use it within a macroscopic simulation framework. This practice bridges the theoretical concept of homogenization with the practical application in numerical methods like the Finite Element Method (FEM). You will derive the general expression for the stiffness matrix entries using the HMM-estimated tensor, solidifying the link between the micro-scale computations and the discrete macro-scale problem, and confirm that HMM correctly reduces to standard FEM for a simple homogeneous medium .",
            "id": "3767040",
            "problem": "Consider the second-order linear elliptic boundary value problem in strong form on a bounded Lipschitz domain $\\Omega \\subset \\mathbb{R}^{d}$, with $d \\in \\{2,3\\}$,\n$$\n-\\nabla \\cdot \\left( a^{\\varepsilon}(x) \\nabla u(x) \\right) = f(x) \\quad \\text{in } \\Omega, \\qquad u(x) = 0 \\quad \\text{on } \\partial \\Omega,\n$$\nwhere $a^{\\varepsilon}(x)$ is a uniformly elliptic, symmetric, rapidly varying tensor field that arises from a heterogeneous medium with a representative microscopic scale $\\varepsilon \\ll 1$. Let $V := H_0^1(\\Omega)$ and let the weak formulation be understood in the usual sense: find $u \\in V$ such that for all $v \\in V$,\n$$\n\\int_{\\Omega} a^{\\varepsilon}(x) \\nabla u(x) \\cdot \\nabla v(x) \\,\\mathrm{d}x = \\int_{\\Omega} f(x)\\, v(x) \\,\\mathrm{d}x.\n$$\nLet $\\mathcal{T}_{h}$ be a conforming finite element triangulation of $\\Omega$ and let $V_{h} \\subset V$ be a conforming finite element space with basis functions $\\{\\phi_{I}\\}_{I=1}^{N}$, where $N$ is the number of global degrees of freedom. Denote the global stiffness matrix by $K = (K_{IJ})_{I,J=1}^{N}$.\n\nIn the Heterogeneous Multiscale Method (HMM), the macroscopic bilinear form is closed by upscaling fluxes obtained from localized microscopic problems. On each macroscopic element $E \\in \\mathcal{T}_{h}$, let there be a quadrature rule with points $\\{x_{q}^{E}\\}_{q=1}^{Q_{E}} \\subset E$ and positive weights $\\{w_{q}^{E}\\}_{q=1}^{Q_{E}}$ that exactly integrate polynomials up to the degree needed by the chosen element and coefficient approximation. Around each quadrature point $x_{q}^{E}$, define a microscopic sampling domain (cell) $Y_{q}^{E}$ of characteristic size $\\delta$ satisfying $\\varepsilon \\ll \\delta \\ll h$, equipped with periodic boundary conditions. For any macroscopic gradient $p \\in \\mathbb{R}^{d}$, define the microscopic corrector $w_{p}^{q,E} \\in H_{\\#}^{1}(Y_{q}^{E})$ (periodic Sobolev space with zero mean) as the unique solution of the cell problem\n$$\n-\\nabla_{y} \\cdot \\left( a(x_{q}^{E}, y) \\left( p + \\nabla_{y} w_{p}^{q,E}(y) \\right) \\right) = 0 \\quad \\text{in } Y_{q}^{E}, \n\\qquad \\int_{Y_{q}^{E}} w_{p}^{q,E}(y) \\,\\mathrm{d}y = 0,\n$$\nwhere $a(x,y)$ is the locally stationary microscopic tensor parametrized by the macroscopic position $x$ and the fast variable $y$. Define the HMM-estimated effective tensor at $x_{q}^{E}$ by the linear map $A^{\\mathrm{HMM}}(x_{q}^{E}) : \\mathbb{R}^{d} \\to \\mathbb{R}^{d}$ that satisfies\n$$\nA^{\\mathrm{HMM}}(x_{q}^{E})\\, p := \\frac{1}{|Y_{q}^{E}|} \\int_{Y_{q}^{E}} a(x_{q}^{E}, y) \\left( p + \\nabla_{y} w_{p}^{q,E}(y) \\right) \\,\\mathrm{d}y,\n$$\nfor all $p \\in \\mathbb{R}^{d}$, where $|Y_{q}^{E}|$ denotes the Lebesgue measure of $Y_{q}^{E}$. Assume $A^{\\mathrm{HMM}}(x)$ is symmetric and uniformly elliptic for all macroscopic points $x$.\n\nStarting from the weak formulation and the above HMM micro-to-macro closure, derive the expression for the global macroscopic stiffness matrix entries $K_{IJ}$ in terms of the basis functions $\\phi_{I}$, $\\phi_{J}$, the quadrature data $\\{(x_{q}^{E}, w_{q}^{E})\\}$, and the HMM-estimated tensors $A^{\\mathrm{HMM}}(x_{q}^{E})$. Then, explain why this expression is equivalent to the classical Finite Element Method (FEM) stiffness matrix when the coefficient is homogeneous, that is, when $a(x,y) \\equiv a_{0}$ is a constant symmetric positive-definite tensor independent of $x$ and $y$.\n\nYour final answer must be a single closed-form analytical expression for $K_{IJ}$ (no units required). No numerical rounding is needed.",
            "solution": "The problem is evaluated to be scientifically grounded, well-posed, objective, and contains all necessary information for a unique solution. It is a standard derivation exercise in the field of multiscale modeling and numerical analysis. Therefore, the problem is deemed valid.\n\nThe solution proceeds in two parts. First, we derive the general expression for the entry $K_{IJ}$ of the global stiffness matrix in the Heterogeneous Multiscale Method (HMM). Second, we demonstrate that this expression simplifies to the classical Finite Element Method (FEM) stiffness matrix for a homogeneous medium.\n\n**Part 1: Derivation of the HMM Stiffness Matrix Entry $K_{IJ}$**\n\nThe weak formulation of the original problem is to find $u \\in V := H_0^1(\\Omega)$ such that for all $v \\in V$:\n$$ B(u, v) := \\int_{\\Omega} a^{\\varepsilon}(x) \\nabla u(x) \\cdot \\nabla v(x) \\,\\mathrm{d}x = \\int_{\\Omega} f(x)\\, v(x) \\,\\mathrm{d}x =: L(v) $$\nThe HMM framework replaces the rapidly oscillating bilinear form $B(u,v)$ with an effective macroscopic bilinear form $B^{\\mathrm{HMM}}(u_h, v_h)$ for functions in the finite element space $V_h \\subset V$. This is achieved by replacing the microscopic coefficient tensor $a^{\\varepsilon}(x)$ with the HMM-estimated effective tensor $A^{\\mathrm{HMM}}(x)$. The HMM bilinear form is thus defined as:\n$$ B^{\\mathrm{HMM}}(u_h, v_h) = \\int_{\\Omega} A^{\\mathrm{HMM}}(x) \\nabla u_h(x) \\cdot \\nabla v_h(x) \\,\\mathrm{d}x $$\nLet the finite element solution be represented as a linear combination of basis functions, $u_h(x) = \\sum_{J=1}^{N} U_J \\phi_J(x)$, where $\\{U_J\\}$ are the unknown coefficients (degrees of freedom). The finite element system of equations is given by $K U = F$, where the entries of the global stiffness matrix $K$ are $K_{IJ}$ and the entries of the load vector $F$ are $F_I$. The matrix entries are defined by testing the weak form against each basis function $\\phi_I$:\n$$ \\sum_{J=1}^{N} K_{IJ} U_J = F_I $$\nFrom the structure of the finite element method, the stiffness matrix entry $K_{IJ}$ is given by the bilinear form evaluated on the basis functions $\\phi_J$ and $\\phi_I$:\n$$ K_{IJ} = B^{\\mathrm{HMM}}(\\phi_J, \\phi_I) $$\nGiven that the problem assumes $a^{\\varepsilon}(x)$ is symmetric and that the resulting $A^{\\mathrm{HMM}}(x)$ is also symmetric, the bilinear form $B^{\\mathrm{HMM}}$ is symmetric, meaning $B^{\\mathrm{HMM}}(\\phi_J, \\phi_I) = B^{\\mathrm{HMM}}(\\phi_I, \\phi_J)$. We proceed with the definition $K_{IJ} = B^{\\mathrm{HMM}}(\\phi_J, \\phi_I)$.\n$$ K_{IJ} = \\int_{\\Omega} A^{\\mathrm{HMM}}(x) \\nabla \\phi_J(x) \\cdot \\nabla \\phi_I(x) \\,\\mathrm{d}x $$\nThe integral over the global domain $\\Omega$ is computed as a sum of integrals over the elements $E$ of the triangulation $\\mathcal{T}_h$:\n$$ K_{IJ} = \\sum_{E \\in \\mathcal{T}_{h}} \\int_{E} A^{\\mathrm{HMM}}(x) \\nabla \\phi_J(x) \\cdot \\nabla \\phi_I(x) \\,\\mathrm{d}x $$\nThese element integrals are computed numerically using the provided quadrature rule with points $\\{x_{q}^{E}\\}$ and weights $\\{w_{q}^{E}\\}$ for each element $E$. The integrand is evaluated at each quadrature point $x_q^E$. Crucially, in HMM, the effective tensor $A^{\\mathrm{HMM}}(x)$ is only computed at these discrete quadrature points via the solution of local cell problems. So, we replace $A^{\\mathrm{HMM}}(x)$ with $A^{\\mathrm{HMM}}(x_{q}^{E})$.\nApplying the quadrature rule to the element integral gives:\n$$ \\int_{E} A^{\\mathrm{HMM}}(x) \\nabla \\phi_J(x) \\cdot \\nabla \\phi_I(x) \\,\\mathrm{d}x \\approx \\sum_{q=1}^{Q_{E}} w_{q}^{E} \\, \\left( A^{\\mathrm{HMM}}(x_{q}^{E}) \\nabla \\phi_J(x_{q}^{E}) \\cdot \\nabla \\phi_I(x_{q}^{E}) \\right) $$\nDue to the symmetry of the tensor $A^{\\mathrm{HMM}}(x_{q}^{E})$, we can write the dot product as:\n$$ A^{\\mathrm{HMM}}(x_{q}^{E}) \\nabla \\phi_J(x_{q}^{E}) \\cdot \\nabla \\phi_I(x_{q}^{E}) = \\nabla \\phi_I(x_{q}^{E}) \\cdot \\left( A^{\\mathrm{HMM}}(x_{q}^{E}) \\nabla \\phi_J(x_{q}^{E}) \\right) $$\nSumming the contributions from all elements yields the final expression for the global stiffness matrix entry:\n$$ K_{IJ} = \\sum_{E \\in \\mathcal{T}_{h}} \\sum_{q=1}^{Q_{E}} w_{q}^{E} \\, \\nabla \\phi_{I}(x_{q}^{E}) \\cdot \\left( A^{\\mathrm{HMM}}(x_{q}^{E}) \\nabla \\phi_{J}(x_{q}^{E}) \\right) $$\nThis expression defines the entries of the HMM stiffness matrix in terms of the FEM basis functions, the quadrature data, and the upscaled effective tensors computed at the quadrature points.\n\n**Part 2: Equivalence to Classical FEM for a Homogeneous Coefficient**\n\nNow, we consider the special case where the medium is homogeneous, meaning the coefficient tensor is a constant symmetric positive-definite tensor $a_0$, independent of both the macroscopic variable $x$ and the microscopic variable $y$. So, $a(x, y) = a_0$.\n\nWe must first determine the HMM-estimated effective tensor $A^{\\mathrm{HMM}}(x_{q}^{E})$ for this case. The cell problem for the microscopic corrector $w_{p}^{q,E}$ is:\n$$ -\\nabla_{y} \\cdot \\left( a_0 \\left( p + \\nabla_{y} w_{p}^{q,E}(y) \\right) \\right) = 0 \\quad \\text{in } Y_{q}^{E} $$\nSince $a_0$ and $p$ are constant with respect to $y$, the term $\\nabla_y \\cdot (a_0 p)$ is zero. The equation simplifies to:\n$$ -\\nabla_{y} \\cdot \\left( a_0 \\nabla_{y} w_{p}^{q,E}(y) \\right) = 0 $$\nThis is a second-order elliptic equation for $w_{p}^{q,E}$ with periodic boundary conditions on $Y_q^E$ and the constraint of zero mean. Multiplying by a test function $v \\in H_{\\#}^{1}(Y_{q}^{E})$ and integrating over $Y_{q}^{E}$ gives the weak form:\n$$ \\int_{Y_{q}^{E}} a_0 \\nabla_{y} w_{p}^{q,E}(y) \\cdot \\nabla_{y} v(y) \\,\\mathrm{d}y = 0 $$\nChoosing the test function $v = w_{p}^{q,E}$ yields:\n$$ \\int_{Y_{q}^{E}} a_0 \\nabla_{y} w_{p}^{q,E}(y) \\cdot \\nabla_{y} w_{p}^{q,E}(y) \\,\\mathrm{d}y = 0 $$\nSince $a_0$ is a positive-definite tensor, the integrand is non-negative. The integral can only be zero if the integrand is zero almost everywhere, which implies $\\nabla_{y} w_{p}^{q,E}(y) = 0$. This means $w_{p}^{q,E}(y)$ must be a constant. Given the constraint that the function has zero mean, $\\int_{Y_{q}^{E}} w_{p}^{q,E}(y) \\,\\mathrm{d}y = 0$, the constant must be zero. Therefore, the unique solution is $w_{p}^{q,E}(y) = 0$. The microscopic corrector vanishes for a homogeneous medium.\n\nNext, we compute the effective tensor $A^{\\mathrm{HMM}}(x_{q}^{E})$ using its definition:\n$$ A^{\\mathrm{HMM}}(x_{q}^{E})\\, p = \\frac{1}{|Y_{q}^{E}|} \\int_{Y_{q}^{E}} a(x_{q}^{E}, y) \\left( p + \\nabla_{y} w_{p}^{q,E}(y) \\right) \\,\\mathrm{d}y $$\nSubstituting $a(x_{q}^{E}, y) = a_0$ and $w_{p}^{q,E}(y) = 0$:\n$$ A^{\\mathrm{HMM}}(x_{q}^{E})\\, p = \\frac{1}{|Y_{q}^{E}|} \\int_{Y_{q}^{E}} a_0 (p + 0) \\,\\mathrm{d}y = \\frac{1}{|Y_{q}^{E}|} \\int_{Y_{q}^{E}} a_0 p \\,\\mathrm{d}y $$\nSince $a_0 p$ is a constant vector, the integral is simply $(a_0 p)|Y_{q}^{E}|$.\n$$ A^{\\mathrm{HMM}}(x_{q}^{E})\\, p = \\frac{1}{|Y_{q}^{E}|} (a_0 p) |Y_{q}^{E}| = a_0 p $$\nThis holds for any vector $p \\in \\mathbb{R}^d$, which implies that the HMM-estimated effective tensor is the constant tensor $a_0$ itself, i.e., $A^{\\mathrm{HMM}}(x_{q}^{E}) = a_0$ for all $x_{q}^{E}$.\n\nFinally, we substitute this result back into the general expression for $K_{IJ}$:\n$$ K_{IJ} = \\sum_{E \\in \\mathcal{T}_{h}} \\sum_{q=1}^{Q_{E}} w_{q}^{E} \\, \\nabla \\phi_{I}(x_{q}^{E}) \\cdot \\left( a_0 \\nabla \\phi_{J}(x_{q}^{E}) \\right) $$\nThis expression is precisely the numerical realization of the stiffness matrix entry for the classical FEM applied to the homogeneous problem $-\\nabla \\cdot (a_0 \\nabla u) = f$. The standard FEM stiffness matrix entry is given by the integral:\n$$ K_{IJ}^{\\mathrm{FEM}} = \\int_{\\Omega} a_0 \\nabla \\phi_J(x) \\cdot \\nabla \\phi_I(x) \\,\\mathrm{d}x $$\nWhen this integral is evaluated using numerical quadrature, it becomes:\n$$ K_{IJ}^{\\mathrm{FEM}} \\approx \\sum_{E \\in \\mathcal{T}_{h}} \\sum_{q=1}^{Q_{E}} w_{q}^{E} \\, \\left(a_0 \\nabla \\phi_{J}(x_{q}^{E}) \\cdot \\nabla \\phi_{I}(x_{q}^{E}) \\right) $$\nwhich is identical to the HMM expression we derived for the homogeneous case (using the symmetry of $a_0$). Thus, for a homogeneous medium, the HMM formulation and its resulting stiffness matrix are equivalent to the classical FEM formulation.",
            "answer": "$$\\boxed{\\sum_{E \\in \\mathcal{T}_{h}} \\sum_{q=1}^{Q_{E}} w_{q}^{E} \\, \\nabla \\phi_{I}(x_{q}^{E}) \\cdot \\left( A^{\\mathrm{HMM}}(x_{q}^{E}) \\nabla \\phi_{J}(x_{q}^{E}) \\right)}$$"
        },
        {
            "introduction": "Many real-world systems exhibit nonlinear behavior, where material properties depend on the local state of the system itself. This exercise extends the HMM framework to such nonlinear problems, a scenario where a single effective tensor is no longer sufficient. Instead, we must construct a surrogate model for the effective flux as a function of the macroscopic state variables, a common task in modern computational science that requires blending numerical micro-problem solving with data-driven modeling techniques .",
            "id": "3767066",
            "problem": "Consider the Heterogeneous Multiscale Method (HMM), where a slowly varying macroscopic state is represented by the scalar field $U(x)$ and a rapidly oscillating microscopic coordinate is represented by $y \\in [0,1]$ with periodic identification. Assume scale separation so that the microscopic coefficient depends on a local macroscopic state $U$ and the microscopic coordinate $y$ around a fixed macroscopic location $x_0$ through a parametric phase shift. The effective flux is defined as a function $F(U,\\nabla U,x_0)$, which must be evaluated by solving a microscopic cell problem local to $x_0$ and aggregating its flux. All quantities in this problem are dimensionless.\n\nLet the microscopic coefficient be given by\n$$\na(u,y;x_0) = \\left(1 + \\delta \\sin\\big(2\\pi(y + \\varphi(x_0))\\big)\\right)^2 \\left(1 + \\eta u^2\\right) + \\left(0.3 + 0.1 \\cos\\big(4\\pi(y + \\varphi(x_0))\\big)\\right)\\exp(\\sigma u),\n$$\nwhere $\\delta = 0.5$, $\\eta = 0.4$, $\\sigma = 0.3$, and the phase function is $\\varphi(x_0) = x_0$. The coefficient $a(u,y;x_0)$ is strictly positive for all $(u,y)$.\n\nFor a given macroscopic state characterized by a value $U^\\star$ and a constant macroscopic gradient $G^\\star$ in a neighborhood of $x_0$, the microscopic cell problem is one-dimensional, posed on the periodic interval $y \\in [0,1]$ with periodic boundary conditions, and is defined by the requirement that the microscopic flux be divergence-free. Denote the microscopic corrector by $w(y)$ and the microscopic flux by $j(y)$. The cell problem is:\n$$\n\\frac{d}{dy}\\left(a(U^\\star,y;x_0)\\left(G^\\star + \\frac{dw}{dy}(y)\\right)\\right) = 0, \\quad y \\in [0,1],\n$$\nwith periodic boundary conditions on $w$ and the normalization $\\int_0^1 \\frac{dw}{dy}(y) \\, dy = 0$.\n\nThe effective flux $F(U^\\star,\\nabla U^\\star,x_0)$ is defined as the cell-averaged microscopic flux resulting from the solution of this micro problem at the macroscopic state $(U^\\star,G^\\star)$ and location $x_0$.\n\nTask: Derive the dependence of the effective flux on $U$ by solving the above micro problems at multiple macroscopic states and construct a local surrogate $F(U,\\nabla U,x_0)$ at each specified $x_0$ using least-squares regression. Specifically:\n\n1. For each specified $x_0$, build a local surrogate model of the form\n$F(U,G,x_0) \\approx G \\sum_{n=0}^{3} c_n(x_0) U^n$,\nwhere the coefficients $c_n(x_0)$ are obtained by least-squares fitting to microscopic evaluations of the effective flux at training macroscopic states.\n\n2. The training sets for the surrogate construction at each $x_0$ are:\n- $U$-training values: $U \\in \\{-0.5, 0.0, 0.5, 1.0, 1.5, 2.0\\}$.\n- $G$-training values: $G \\in \\{-0.6, 0.4, 1.0\\}$.\n\n3. For each training pair $(U,G)$ at a given $x_0$, numerically solve the micro problem on a uniform grid of $N = 4096$ points over $y \\in [0,1]$ with periodic boundary conditions to obtain the cell-averaged effective flux, and use these to fit the coefficients $c_n(x_0)$ by least squares. The numerical solution should respect the periodicity and the divergence-free nature of the microscopic flux. The microscopic computation must be performed by discretizing the domain and computing the cell-averaged flux; analytical shortcuts are not permitted in the program.\n\n4. After constructing the local surrogate at each $x_0$, evaluate its prediction at the test macroscopic states and compare it against the corresponding numerically computed cell-averaged effective flux obtained by solving the micro problem at the test state. Report the absolute error for each test case.\n\nUse the following test suite, each case given by $(x_0,U^\\star,G^\\star)$:\n- Case 1 (general case): $(0.125, 0.3, 0.5)$.\n- Case 2 (small gradient): $(0.33, 1.2, 0.05)$.\n- Case 3 (large $U$): $(0.75, 2.0, 1.0)$.\n- Case 4 (negative values): $(0.5, -0.5, -0.3)$.\n- Case 5 (zero gradient): $(0.9, 0.0, 0.0)$.\n\nYour program must:\n- Implement the microscopic coefficient $a(u,y;x_0)$ as specified.\n- For each $x_0$ in the test suite, construct the local surrogate $F(U,G,x_0)$ using the given training sets and a degree-$3$ polynomial in $U$ multiplied by $G$.\n- For each test case, compute the absolute error between the surrogate prediction and the numerically computed effective flux from the micro problem using a uniform grid with $N=4096$ points.\n\nFinal output format: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3,result4,result5]\"), where each entry is the absolute error (a float) for the corresponding test case in the order given above. All quantities are dimensionless, and angles are not involved.",
            "solution": "The problem requires the construction and validation of a surrogate model for the effective flux in a one-dimensional Heterogeneous Multiscale Method (HMM) framework. The approach involves solving a microscopic cell problem to determine the effective material properties, which are then used to build a macroscopic surrogate.\n\nThe core of the problem lies in the microscopic cell problem, defined for a given macroscopic state $(U^\\star, G^\\star)$ at a macroscopic location $x_0$. The cell problem is a second-order ordinary differential equation on the periodic domain $y \\in [0,1]$:\n$$\n\\frac{d}{dy}\\left(a(U^\\star,y;x_0)\\left(G^\\star + \\frac{dw}{dy}(y)\\right)\\right) = 0\n$$\nwhere $w(y)$ is a periodic function representing the microscopic corrector, and the normalization condition is $\\int_0^1 \\frac{dw}{dy}(y) \\, dy = 0$.\n\nThe term inside the outer derivative is the microscopic flux, $j(y)$:\n$$\nj(y) = a(U^\\star,y;x_0)\\left(G^\\star + \\frac{dw}{dy}(y)\\right)\n$$\nThe differential equation states that the flux $j(y)$ is constant with respect to the microscopic coordinate $y$. Let this constant be $J$.\n$$\nj(y) = J\n$$\nWe can rearrange this equation to solve for the gradient of the corrector, $\\frac{dw}{dy}$:\n$$\nG^\\star + \\frac{dw}{dy}(y) = \\frac{J}{a(U^\\star,y;x_0)}\n$$\n$$\n\\frac{dw}{dy}(y) = \\frac{J}{a(U^\\star,y;x_0)} - G^\\star\n$$\nTo find the constant flux $J$, we apply the normalization condition by integrating $\\frac{dw}{dy}$ over the periodic cell $[0,1]$:\n$$\n\\int_0^1 \\frac{dw}{dy}(y) \\, dy = \\int_0^1 \\left(\\frac{J}{a(U^\\star,y;x_0)} - G^\\star\\right) \\, dy = 0\n$$\nSeparating the integral and using the linearity of integration, we get:\n$$\nJ \\int_0^1 \\frac{1}{a(U^\\star,y;x_0)} \\, dy - G^\\star \\int_0^1 \\, dy = 0\n$$\n$$\nJ \\int_0^1 \\frac{dy}{a(U^\\star,y;x_0)} - G^\\star = 0\n$$\nSolving for $J$ yields:\n$$\nJ = G^\\star \\left( \\int_0^1 \\frac{dy}{a(U^\\star,y;x_0)} \\right)^{-1}\n$$\nThe problem defines the effective flux, $F(U^\\star, G^\\star, x_0)$, as the cell-average of the microscopic flux $j(y)$. Since $j(y) = J$ is a constant, its average over the cell is simply $J$.\n$$\nF(U^\\star, G^\\star, x_0) = \\int_0^1 j(y) \\, dy = \\int_0^1 J \\, dy = J\n$$\nThus, the effective flux is directly proportional to the macroscopic gradient $G^\\star$:\n$$\nF(U^\\star, G^\\star, x_0) = A_{eff}(U^\\star, x_0) G^\\star\n$$\nwhere $A_{eff}(U^\\star, x_0)$ is the effective coefficient, given by the harmonic average of the microscopic coefficient $a$:\n$$\nA_{eff}(U, x_0) = \\left( \\int_0^1 \\frac{dy}{a(U,y;x_0)} \\right)^{-1}\n$$\nThe task is to construct a surrogate model of the form $F(U,G,x_0) \\approx G \\sum_{n=0}^{3} c_n(x_0) U^n$. This is equivalent to approximating the effective coefficient $A_{eff}(U, x_0)$ with a degree-$3$ polynomial in $U$:\n$$\nA_{eff}(U, x_0) \\approx P_3(U; x_0) = \\sum_{n=0}^{3} c_n(x_0) U^n\n$$\nThe coefficients $c_n(x_0)$ are to be determined by a least-squares fit for each specified $x_0$.\n\nThe procedure for each test case $(x_0, U^\\star, G^\\star)$ is as follows:\n1.  **Surrogate Construction at $x_0$**:\n    a. For each macroscopic state value $U_i$ in the training set $U_{train} = \\{-0.5, 0.0, 0.5, 1.0, 1.5, 2.0\\}$, we compute the corresponding \"true\" effective coefficient $A_{eff}(U_i, x_0)$. This requires numerically evaluating the integral $\\int_0^1 \\frac{dy}{a(U_i,y;x_0)}$. Given that $a(U, y, x_0)$ is a periodic function of $y$ with period $1$, the trapezoidal rule on a uniform grid provides high accuracy. On a grid $y_k = k/N$ for $k=0, \\ldots, N-1$ with $N=4096$, the integral is approximated as $\\frac{1}{N}\\sum_{k=0}^{N-1} \\frac{1}{a(U_i, y_k, x_0)}$.\n    b. Let the computed effective coefficients be $A_i = A_{eff}(U_i, x_0)$. We seek the coefficients $c = [c_0, c_1, c_2, c_3]^T$ of the polynomial $P_3(U; x_0)$ that minimize the sum of squared errors $\\sum_i (A_i - P_3(U_i; x_0))^2$. This is a standard linear least-squares problem, which can be expressed in matrix form as minimizing $\\|\\mathbf{M}c - \\mathbf{A}\\|^2$, where $\\mathbf{A}$ is the vector of $A_i$ values and $\\mathbf{M}$ is a Vandermonde-like matrix with entries $M_{in} = U_i^n$. This system is solved for $c$. The specified $G$-training values ultimately factor out of the minimization problem for the polynomial coefficients and do not alter the unweighted nature of the fit for $A_{eff}(U)$.\n\n2.  **Evaluation at $(U^\\star, G^\\star)$**:\n    a. The constructed surrogate model provides a prediction for the effective flux: $F_{surrogate} = G^\\star \\cdot P_3(U^\\star; x_0) = G^\\star \\sum_{n=0}^3 c_n (U^\\star)^n$.\n    b. The \"true\" effective flux, $F_{true}$, is computed by numerically solving the micro problem for the specific state $(U^\\star, G^\\star)$ at $x_0$, which amounts to calculating $F_{true} = G^\\star \\cdot A_{eff}(U^\\star, x_0)$ using the numerical integration method with $N=4096$.\n    c. The absolute error is then $|F_{true} - F_{surrogate}|$. A special case occurs when $G^\\star=0$, for which both $F_{true}$ and $F_{surrogate}$ are exactly $0$, resulting in zero error.\n\nThis entire procedure is implemented for each test case provided in the problem statement.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the HMM surrogate modeling problem.\n    \"\"\"\n    # Define constants and problem parameters\n    DELTA = 0.5\n    ETA = 0.4\n    SIGMA = 0.3\n    N_POINTS = 4096\n    POLY_DEGREE = 3\n\n    # Training and test data as specified in the problem\n    U_train = np.array([-0.5, 0.0, 0.5, 1.0, 1.5, 2.0])\n    test_cases = [\n        (0.125, 0.3, 0.5),   # Case 1\n        (0.33, 1.2, 0.05),  # Case 2\n        (0.75, 2.0, 1.0),   # Case 3\n        (0.5, -0.5, -0.3),  # Case 4\n        (0.9, 0.0, 0.0),    # Case 5\n    ]\n\n    y_grid = np.linspace(0, 1, N_POINTS, endpoint=False)\n\n    def a(u, y, x0):\n        \"\"\"\n        Computes the microscopic coefficient a(u, y; x0).\n        \"\"\"\n        term1_sin = np.sin(2 * np.pi * (y + x0))\n        term1 = ((1 + DELTA * term1_sin)**2) * (1 + ETA * u**2)\n\n        term2_cos = np.cos(4 * np.pi * (y + x0))\n        term2 = (0.3 + 0.1 * term2_cos) * np.exp(SIGMA * u)\n\n        return term1 + term2\n\n    def compute_effective_coeff(u, x0):\n        \"\"\"\n        Computes the effective coefficient A_eff(u, x0) using numerical integration.\n        A_eff = (integral(1/a))^{-1}.\n        \"\"\"\n        a_inv_values = 1.0 / a(u, y_grid, x0)\n        # For a periodic function, trapezoidal rule is equivalent to mean value\n        integral_a_inv = np.mean(a_inv_values)\n        return 1.0 / integral_a_inv\n    \n    def compute_effective_flux(u, g, x0):\n        \"\"\"\n        Computes the effective flux F(u, g, x0) = g * A_eff(u, x0).\n        \"\"\"\n        if g == 0.0:\n            return 0.0\n        return g * compute_effective_coeff(u, x0)\n\n    results = []\n    \n    for x0, u_star, g_star in test_cases:\n        # Step 1: Construct the surrogate model for the given x0\n        \n        # Calculate the \"true\" effective coefficients at training points\n        A_eff_train = np.array([compute_effective_coeff(u_val, x0) for u_val in U_train])\n\n        # Build the Vandermonde matrix for a degree-3 polynomial fit\n        M = np.vander(U_train, POLY_DEGREE + 1, increasing=True)\n        \n        # Solve the least squares problem M*c = A_eff_train for coefficients c\n        coeffs, _, _, _ = np.linalg.lstsq(M, A_eff_train, rcond=None)\n        \n        # Step 2: Evaluate the surrogate and the true flux at the test point\n        \n        # Surrogate prediction\n        # np.polyval expects coeffs from highest power to lowest, so we reverse the list\n        A_eff_surrogate = np.polyval(coeffs[::-1], u_star)\n        F_surrogate = g_star * A_eff_surrogate\n        \n        # True flux computation\n        F_true = compute_effective_flux(u_star, g_star, x0)\n        \n        # Step 3: Compute the absolute error\n        error = np.abs(F_true - F_surrogate)\n        results.append(error)\n\n    # Format the results for the final output\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}