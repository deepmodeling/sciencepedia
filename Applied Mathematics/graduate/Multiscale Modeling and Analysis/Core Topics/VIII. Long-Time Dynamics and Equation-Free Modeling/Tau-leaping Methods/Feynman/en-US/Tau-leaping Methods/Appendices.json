{
    "hands_on_practices": [
        {
            "introduction": "The first step in simulating any stochastic reaction network is to translate its chemical rules into a precise mathematical framework. This foundational exercise guides you through that process by asking you to construct the stoichiometry matrix $S$ and the propensity vector $a(x,y)$ for a simple catalytic system . Mastering this translation from a list of reactions to these core mathematical objects is the essential starting point for correctly implementing and interpreting any stochastic kinetic model.",
            "id": "3812855",
            "problem": "Consider a stochastic reaction network with two molecular species $X$ and $Y$. The network consists of the reactions $X \\xrightarrow{k_1} X+Y$ and $Y \\xrightarrow{k_2} \\emptyset$, where $k_1$ and $k_2$ are positive rate constants. Let $(x,y)$ denote the integer-valued molecular population counts of species $X$ and $Y$, respectively. Using the Chemical Master Equation (CME) framework and standard mass-action kinetics, derive the stoichiometric change vectors for each reaction and assemble them into a stoichiometry matrix $S$ whose columns are these change vectors. Then derive the mass-action propensity functions and collect them into a propensity vector $a(x,y)$. Finally, under the $\\tau$-leaping approximation, assume that over a small time interval of length $\\tau$, the reaction counts $K_i$ for reaction $i$ are independent Poisson random variables with parameters $a_i(x,y)\\,\\tau$, and define the state update for the population vector in the form $x \\mapsto x + \\sum_{i} \\nu_i K_i$ (with $x$ denoting the state vector and $\\nu_i$ the stoichiometric change vectors). Express the update both as a component-wise mapping and in matrix form $x \\mapsto x + S K$, where $K$ is the vector of reaction counts.\n\nProvide the final answer as a single analytic expression that simultaneously gives the stoichiometry matrix $S$, the propensity vector $a(x,y)$, and the state update mapping $x \\mapsto x + S K$ for this network. No numerical evaluation is required, and no rounding is necessary.",
            "solution": "The problem is first validated to ensure it is self-contained, scientifically sound, and well-posed.\n\n### Step 1: Extract Givens\n- **Species**: $X$, $Y$.\n- **State Vector**: The population counts are denoted by the pair $(x,y)$. The problem also specifies using the symbol $x$ to denote the state vector. To avoid ambiguity in the derivation, the state vector will be denoted as $\\mathbf{x} = \\begin{pmatrix} x \\\\ y \\end{pmatrix}$.\n- **Reactions**:\n    - $R_1: X \\xrightarrow{k_1} X+Y$\n    - $R_2: Y \\xrightarrow{k_2} \\emptyset$\n- **Rate Constants**: $k_1 > 0$ and $k_2 > 0$.\n- **Kinetics**: Standard mass-action kinetics.\n- **Framework**: Chemical Master Equation (CME) and the $\\tau$-leaping approximation.\n- **$\\tau$-leaping Assumption**: For a time step $\\tau$, the number of occurrences of reaction $j$, denoted $K_j$, is a random variable drawn from a Poisson distribution: $K_j \\sim \\text{Poisson}(a_j(\\mathbf{x})\\tau)$, where $a_j(\\mathbf{x})$ is the propensity function for reaction $j$.\n- **State Update Rule**: The state vector $\\mathbf{x}$ is updated according to the rule $\\mathbf{x} \\mapsto \\mathbf{x} + \\sum_{j} \\nu_j K_j$, which can be written in matrix form as $\\mathbf{x} \\mapsto \\mathbf{x} + S K$, where $\\nu_j$ are the stoichiometric change vectors, $S$ is the stoichiometry matrix, and $K$ is the vector of reaction counts.\n\n### Step 2: Validate Using Extracted Givens\nThe problem statement is evaluated against the validation criteria.\n- **Scientifically Grounded**: The problem is based on the standard, well-established theory of stochastic chemical kinetics, specifically the Gillespie stochastic simulation algorithm and its $\\tau$-leaping approximation. The reactions represent a catalysed production and a first-order degradation, which are fundamental motifs in systems biology.\n- **Well-Posed**: The problem asks for the derivation of specific mathematical constructs ($S$, $a(x,y)$, and the update rule) from a fully specified reaction network. The definitions and required outputs are clear and lead to a unique solution.\n- **Objective**: The problem is stated in precise, formal language, free of any subjectivity or ambiguity.\n\nThe problem does not exhibit any flaws such as scientific unsoundness, incompleteness, contradiction, or being ill-posed. The notational choice of using $x$ to represent both a component of the state vector and the state vector itself is a common convention in the literature, though potentially confusing. We will proceed by adhering to this convention as instructed.\n\n### Step 3: Verdict and Action\nThe problem is **valid**. A full, reasoned solution will be provided.\n\n### Solution Derivation\nThe solution is derived by systematically constructing the components required for the $\\tau$-leaping method based on the provided reaction network.\n\n**1. Stoichiometric Change Vectors and Stoichiometry Matrix ($S$)**\n\nThe state of the system is described by the vector of molecular populations, $\\mathbf{x} = \\begin{pmatrix} x \\\\ y \\end{pmatrix}$. A chemical reaction $R_j$ causes a change in the state vector by a specific integer-valued vector, the stoichiometric change vector $\\nu_j$.\n\n- **Reaction $R_1: X \\xrightarrow{k_1} X+Y$**:\n  In this reaction, the population of $X$ changes by $1 - 1 = 0$, and the population of $Y$ changes by $1 - 0 = 1$.\n  The change vector is $\\nu_1 = \\begin{pmatrix} \\Delta x \\\\ \\Delta y \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix}$.\n\n- **Reaction $R_2: Y \\xrightarrow{k_2} \\emptyset$**:\n  In this reaction, the population of $X$ does not change, so $\\Delta x = 0$. The population of $Y$ decreases by $1$, so $\\Delta y = -1$.\n  The change vector is $\\nu_2 = \\begin{pmatrix} \\Delta x \\\\ \\Delta y \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix}$.\n\nThe stoichiometry matrix $S$ is formed by taking the stoichiometric change vectors as its columns. For a system with $M$ species and $N$ reactions, $S$ is an $M \\times N$ matrix. Here, we have $2$ species and $2$ reactions.\n$$\nS = \\begin{pmatrix} \\nu_1 & \\nu_2 \\end{pmatrix} = \\begin{pmatrix} 0 & 0 \\\\ 1 & -1 \\end{pmatrix}\n$$\n\n**2. Propensity Functions and Propensity Vector ($a(x,y)$)**\n\nThe propensity function $a_j(\\mathbf{x})$ for reaction $R_j$ gives the probability, per unit time, that reaction $R_j$ will occur given the state $\\mathbf{x}$. For mass-action kinetics, the propensity is the product of the stochastic rate constant $k_j$ and the number of distinct combinations of reactant molecules.\n\n- **For Reaction $R_1: X \\xrightarrow{k_1} X+Y$**:\n  The reactant is a single molecule of $X$. The number of molecules is $x$.\n  The propensity function is $a_1(x,y) = k_1 x$.\n\n- **For Reaction $R_2: Y \\xrightarrow{k_2} \\emptyset$**:\n  The reactant is a single molecule of $Y$. The number of molecules is $y$.\n  The propensity function is $a_2(x,y) = k_2 y$.\n\nThe propensity vector $a(x,y)$ collects these individual propensity functions.\n$$\na(x,y) = \\begin{pmatrix} a_1(x,y) \\\\ a_2(x,y) \\end{pmatrix} = \\begin{pmatrix} k_1 x \\\\ k_2 y \\end{pmatrix}\n$$\n\n**3. The $\\tau$-Leaping State Update Rule**\n\nThe $\\tau$-leaping method approximates the evolution of the system by assuming that over a small time interval $\\tau$, the propensities remain approximately constant. The number of times each reaction $j$ occurs in $[t, t+\\tau)$, $K_j$, is modelled as an independent Poisson random variable with parameter $a_j(\\mathbf{x}(t))\\tau$.\n\nLet $x$ denote the state vector $\\begin{pmatrix} x \\\\ y \\end{pmatrix}$ at time $t$, as per the problem's specified notation. The vector of reaction counts is $K = \\begin{pmatrix} K_1 \\\\ K_2 \\end{pmatrix}$, where:\n- $K_1 \\sim \\text{Poisson}(a_1(x,y)\\tau) = \\text{Poisson}(k_1 x \\tau)$\n- $K_2 \\sim \\text{Poisson}(a_2(x,y)\\tau) = \\text{Poisson}(k_2 y \\tau)$\n\nThe state vector at time $t+\\tau$, denoted $x'$, is given by the matrix form of the update rule:\n$$\nx' = x + S K\n$$\nSubstituting the derived $S$ and the vector $K$:\n$$\n\\begin{pmatrix} x' \\\\ y' \\end{pmatrix} = \\begin{pmatrix} x \\\\ y \\end{pmatrix} + \\begin{pmatrix} 0 & 0 \\\\ 1 & -1 \\end{pmatrix} \\begin{pmatrix} K_1 \\\\ K_2 \\end{pmatrix} = \\begin{pmatrix} x + 0 \\cdot K_1 + 0 \\cdot K_2 \\\\ y + 1 \\cdot K_1 - 1 \\cdot K_2 \\end{pmatrix} = \\begin{pmatrix} x \\\\ y + K_1 - K_2 \\end{pmatrix}\n$$\nThe update can be expressed as a mapping $x \\mapsto x + SK$. The component-wise mapping is:\n- $x \\mapsto x$\n- $y \\mapsto y + K_1 - K_2$\nThis confirms that the population of species $X$ is unaffected (it acts as a catalyst), while the population of species $Y$ is increased by the number of $R_1$ events and decreased by the number of $R_2$ events over the interval $\\tau$.\n\nThe problem asks for $S$, $a(x,y)$, and the state update mapping $x \\mapsto x + S K$. These three components constitute the complete specification for a $\\tau$-leaping step for this system.",
            "answer": "$$\n\\boxed{\n\\begin{align*} S &= \\begin{pmatrix} 0 & 0 \\\\ 1 & -1 \\end{pmatrix} \\\\[1.5em] a(x,y) &= \\begin{pmatrix} k_1 x \\\\ k_2 y \\end{pmatrix} \\\\[1.5em] x &\\mapsto x + S K, \\quad \\text{where } x = \\begin{pmatrix} x \\\\ y \\end{pmatrix}, K = \\begin{pmatrix} K_1 \\\\ K_2 \\end{pmatrix}, \\text{and } K_j \\sim \\text{Poisson}(a_j(x,y)\\tau) \\end{align*}\n}\n$$"
        },
        {
            "introduction": "With the mathematical formalism established, we can now implement a single step of the tau-leaping algorithm. This practice moves beyond mere formalism to hands-on coding, but it also pushes for a deeper theoretical understanding of the approximation being made . By simulating a single leap and simultaneously calculating the conditional drift and diffusion terms, you will connect the discrete update rule of the algorithm to the continuous-time stochastic process it approximates. These moments are fundamental to the Chemical Langevin Equation and provide insight into the local behavior of the system's trajectory.",
            "id": "3812859",
            "problem": "Consider a well-mixed stochastic reaction network governed by the Chemical Master Equation (CME), where the system state is the integer-valued population vector $X(t) \\in \\mathbb{Z}_{\\ge 0}^d$ for $d$ chemical species and $m$ reaction channels. Let the stoichiometry matrix be $S \\in \\mathbb{Z}^{d \\times m}$, where each column $S_{\\cdot j}$ gives the net change in species counts produced by one firing of reaction $j$. Under mass-action kinetics, each reaction $j$ has a propensity $a_j(x)$ that depends on the current state $x$ and a rate constant $c_j$, and that encodes the instantaneous hazard of firing.\n\nYour task is to implement one explicit $\\tau$-leaping step for a specified three-reaction network and, from first principles, derive and compute the conditional drift and diffusion terms at the current state $X^n$. The $\\tau$-leaping approximation over a short interval of length $\\tau$ assumes that reaction propensities remain approximately constant at their values at $X^n$ and that the number of firings of each reaction within the interval are described by independent counting statistics consistent with the CME.\n\nWork from the foundational definitions of the CME and mass-action kinetics to derive the expressions required for:\n- The update $X^{n+1}$ produced by one explicit $\\tau$-leap starting from $X^n$.\n- The conditional drift vector evaluated at $X^n$.\n- The conditional diffusion matrix evaluated at $X^n$.\n\nFor the network below, all species and reactions are labeled, and mass-action propensities are to be used exactly as specified:\n- Species: $A$ and $B$.\n- Reactions ($m = 3$):\n    - $R_1$: $A + B \\to 2B$ with stoichiometry change $(-1, +1)$ and mass-action propensity $a_1(x) = c_1 \\, x_A \\, x_B$.\n    - $R_2$: $B \\to \\emptyset$ with stoichiometry change $(0, -1)$ and mass-action propensity $a_2(x) = c_2 \\, x_B$.\n    - $R_3$: $\\emptyset \\to A$ with stoichiometry change $(+1, 0)$ and mass-action propensity $a_3(x) = c_3$.\n- Stoichiometry matrix (columns correspond to $R_1$, $R_2$, $R_3$):\n$$\nS = \\begin{bmatrix}\n-1 & 0 & +1 \\\\\n+1 & -1 & 0\n\\end{bmatrix}.\n$$\n\nImplement the explicit $\\tau$-leaping step as follows:\n- Given $X^n$, a vector of rate constants $c = (c_1,c_2,c_3)$, and a time step $\\tau > 0$, compute the propensities $a_j(X^n)$ for $j \\in \\{1,2,3\\}$ under mass-action kinetics.\n- Using a fixed random number generator seed for reproducibility, sample the reaction counts within the interval of length $\\tau$ under the standard independence assumptions of the $\\tau$-leaping approximation.\n- Update $X^{n+1}$ according to the stoichiometry matrix and the sampled reaction counts.\n- Compute the conditional drift vector at $X^n$ and the conditional diffusion matrix at $X^n$ implied by the approximation and the independence of reaction firings. Report these per unit time (not multiplied by $\\tau$).\n\nYour program must evaluate the following test suite. Each test case is given by $(X^n, c, \\tau)$:\n- Case $1$ (happy path): $X^n = (50, 10)$, $c = (10^{-3}, 2 \\times 10^{-1}, 5)$, $\\tau = 10^{-1}$.\n- Case $2$ (moderate activity): $X^n = (100, 200)$, $c = (5 \\times 10^{-4}, 5 \\times 10^{-2}, 1)$, $\\tau = 2$.\n- Case $3$ (boundary with zero propensities): $X^n = (0, 0)$, $c = (10^{-3}, 2 \\times 10^{-1}, 0)$, $\\tau = 1$.\n\nFor each test case, your program must compute and return a list containing:\n- The updated state $X^{n+1}$ as a list of integers.\n- The conditional drift vector at $X^n$ as a list of floats (per unit time).\n- The conditional diffusion matrix at $X^n$ as a list of floats corresponding to the matrix flattened in row-major order (per unit time).\n\nFinal output format requirement:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each element of the top-level list corresponds to one test case and must itself be a bracketed, comma-separated list containing the three items listed above. For example, the output format is $[r_1,r_2,r_3]$, where $r_k = [X^{n+1}, \\text{drift}, \\text{diff\\_flat}]$ for case $k$.\n\nNo physical units are involved; all quantities are dimensionless counts and rates. Use a fixed random seed of $123456789$ for all random sampling to ensure reproducibility.",
            "solution": "The problem requires the implementation and theoretical justification of a single step of the explicit $\\tau$-leaping algorithm for a given stochastic reaction network. This involves deriving the state update rule, the conditional drift vector, and the conditional diffusion matrix from the foundational principles of the Chemical Master Equation (CME) and its approximations.\n\n### 1. Theoretical Foundation\n\nThe evolution of a well-mixed stochastic chemical system is governed by the Chemical Master Equation (CME). The CME describes the time evolution of the probability $P(x, t)$ that the system is in state $X(t)=x$, where $x \\in \\mathbb{Z}_{\\ge 0}^d$ is the vector of species populations. For a system with $m$ reaction channels, the CME is:\n$$\n\\frac{dP(x, t)}{dt} = \\sum_{j=1}^{m} \\left[ a_j(x - S_{\\cdot j}) P(x - S_{\\cdot j}, t) - a_j(x) P(x, t) \\right]\n$$\nHere, $a_j(x)$ is the propensity function of reaction $j$, representing the probability per unit time that reaction $j$ occurs given the state is $x$. $S_{\\cdot j}$ is the $j$-th column of the stoichiometry matrix $S$, representing the change in species counts from one occurrence of reaction $j$.\n\nThe explicit $\\tau$-leaping method is an approximation scheme that advances the system state by a time step $\\tau$. It relies on the \"leap condition\": $\\tau$ must be small enough that the propensity functions $a_j(x)$ do not change significantly during the interval $[t, t+\\tau]$. Consequently, we can approximate $a_j(X(t')) \\approx a_j(X(t))$ for $t' \\in [t, t+\\tau]$.\n\nUnder this assumption, the firing of each reaction $j$ in the interval becomes a Poisson process with a constant rate $a_j(X(t))$. The number of times reaction $j$ fires, $K_j(\\tau)$, is a random variable sampled from a Poisson distribution. Crucially, the reaction channels are assumed to be independent.\n$$\nK_j(\\tau) \\sim \\text{Poisson}(\\lambda_j) \\quad \\text{where the rate is } \\lambda_j = a_j(X(t)) \\tau\n$$\n\n### 2. State Update Rule\n\nLet $X^n$ be the state at time $t_n$. The state at time $t_{n+1} = t_n + \\tau$, denoted $X^{n+1}$, is obtained by summing the changes caused by all reaction firings in the interval.\n$$\nX^{n+1} = X^n + \\sum_{j=1}^{m} K_j S_{\\cdot j} = X^n + S K\n$$\nwhere $K = [K_1, K_2, \\dots, K_m]^T$ is the vector of sampled reaction counts.\n\nFor the specified network:\n- Species: $A$, $B$. State vector: $X = [x_A, x_B]^T$.\n- Stoichiometry matrix: $S = \\begin{bmatrix} -1 & 0 & 1 \\\\ 1 & -1 & 0 \\end{bmatrix}$.\n- Propensities (mass-action): $a_1(X) = c_1 x_A x_B$, $a_2(X) = c_2 x_B$, $a_3(X) = c_3$.\n\nThe step-by-step update procedure is:\n1. Given $X^n = [x_A^n, x_B^n]^T$, constants $c=[c_1, c_2, c_3]^T$, and time step $\\tau$.\n2. Calculate propensities at $X^n$:\n   - $a_1(X^n) = c_1 x_A^n x_B^n$\n   - $a_2(X^n) = c_2 x_B^n$\n   - $a_3(X^n) = c_3$\n3. Sample the number of reaction firings $K_j$ from independent Poisson distributions:\n   - $K_1 \\sim \\text{Poisson}(a_1(X^n)\\tau)$\n   - $K_2 \\sim \\text{Poisson}(a_2(X^n)\\tau)$\n   - $K_3 \\sim \\text{Poisson}(a_3(X^n)\\tau)$\n4. Compute the new state $X^{n+1}$:\n   $$\n   X^{n+1} = \\begin{bmatrix} x_A^n \\\\ x_B^n \\end{bmatrix} + \\begin{bmatrix} -1 & 0 & 1 \\\\ 1 & -1 & 0 \\end{bmatrix} \\begin{bmatrix} K_1 \\\\ K_2 \\\\ K_3 \\end{bmatrix} = \\begin{bmatrix} x_A^n - K_1 + K_3 \\\\ x_B^n + K_1 - K_2 \\end{bmatrix}\n   $$\n\n### 3. Conditional Drift and Diffusion\n\nThe conditional drift vector $\\mu(x)$ and diffusion matrix $D(x)$ characterize the infinitesimal moments of the state change $\\Delta X = X(t+\\tau) - X(t)$, conditioned on $X(t)=x$. They are defined as limits as $\\tau \\to 0$ and are reported per unit time.\n\n**Drift Vector:** The drift is the expected rate of change of the state.\n$$\n\\mu(x) = \\lim_{\\tau \\to 0} \\frac{1}{\\tau} \\mathbb{E}[\\Delta X | X(t)=x]\n$$\nWithin the $\\tau$-leaping framework, $\\Delta X = S K$. Using the linearity of expectation and that for a Poisson variable $\\mathbb{E}[K_j] = a_j(x)\\tau$:\n$$\n\\mathbb{E}[\\Delta X | X(t)=x] = \\mathbb{E}[S K] = S \\mathbb{E}[K] = S (a(x)\\tau) = (S a(x)) \\tau\n$$\nwhere $a(x) = [a_1(x), a_2(x), a_3(x)]^T$.\nDividing by $\\tau$ gives the drift vector per unit time:\n$$\n\\mu(x) = S a(x) = \\begin{bmatrix} -1 & 0 & 1 \\\\ 1 & -1 & 0 \\end{bmatrix} \\begin{bmatrix} a_1(x) \\\\ a_2(x) \\\\ a_3(x) \\end{bmatrix} = \\begin{bmatrix} -a_1(x) + a_3(x) \\\\ a_1(x) - a_2(x) \\end{bmatrix}\n$$\n\n**Diffusion Matrix:** The diffusion matrix is related to the second moment of the state change.\n$$\nD(x) = \\lim_{\\tau \\to 0} \\frac{1}{\\tau} \\mathbb{E}[\\Delta X \\Delta X^T | X(t)=x]\n$$\nWe evaluate the expectation of $\\Delta X \\Delta X^T = (SK)(SK)^T = S K K^T S^T$:\n$$\n\\mathbb{E}[\\Delta X \\Delta X^T] = S \\mathbb{E}[K K^T] S^T\n$$\nThe entries of the matrix $\\mathbb{E}[K K^T]$ are $\\mathbb{E}[K_i K_j]$. For independent Poisson variables, we have:\n- For $i \\neq j$: $\\mathbb{E}[K_i K_j] = \\mathbb{E}[K_i]\\mathbb{E}[K_j] = (a_i(x)\\tau)(a_j(x)\\tau) = a_i(x)a_j(x)\\tau^2$.\n- For $i = j$: $\\mathbb{E}[K_j^2] = \\text{Var}(K_j) + (\\mathbb{E}[K_j])^2 = a_j(x)\\tau + (a_j(x)\\tau)^2$.\nThis can be written compactly as $\\mathbb{E}[K_i K_j] = a_i(x)a_j(x)\\tau^2 + \\delta_{ij} a_j(x)\\tau$, where $\\delta_{ij}$ is the Kronecker delta.\nThe matrix $\\mathbb{E}[K K^T]$ is $\\tau^2 a(x) a(x)^T + \\tau \\, \\text{diag}(a(x))$.\nSubstituting this back:\n$$\n\\mathbb{E}[\\Delta X \\Delta X^T] = S (\\tau^2 a(x) a(x)^T + \\tau \\, \\text{diag}(a(x))) S^T = \\tau^2 (S a(x))(S a(x))^T + \\tau S \\, \\text{diag}(a(x)) S^T\n$$\nDividing by $\\tau$ and taking the limit $\\tau \\to 0$, the $\\tau^2$ term vanishes:\n$$\nD(x) = \\lim_{\\tau \\to 0} \\left( \\tau (S a(x))(S a(x))^T + S \\, \\text{diag}(a(x)) S^T \\right) = S \\, \\text{diag}(a(x)) S^T\n$$\nThis can be computed as $\\sum_{j=1}^m a_j(x) S_{\\cdot j} S_{\\cdot j}^T$. For our system:\n$$\nD(x) = a_1(x) \\begin{bmatrix} 1 & -1 \\\\ -1 & 1 \\end{bmatrix} + a_2(x) \\begin{bmatrix} 0 & 0 \\\\ 0 & 1 \\end{bmatrix} + a_3(x) \\begin{bmatrix} 1 & 0 \\\\ 0 & 0 \\end{bmatrix} = \\begin{bmatrix} a_1(x) + a_3(x) & -a_1(x) \\\\ -a_1(x) & a_1(x) + a_2(x) \\end{bmatrix}\n$$\nThese derived formulae for $\\mu(x)$ and $D(x)$ are evaluated at $X^n$ to find the required conditional terms.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements one explicit tau-leaping step for a 3-reaction network and\n    computes the conditional drift and diffusion terms.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: (Xn, c, tau)\n        (np.array([50, 10]), np.array([1e-3, 2e-1, 5.0]), 1e-1),\n        # Case 2: (Xn, c, tau)\n        (np.array([100, 200]), np.array([5e-4, 5e-2, 1.0]), 2.0),\n        # Case 3: (Xn, c, tau)\n        (np.array([0, 0]), np.array([1e-3, 2e-1, 0.0]), 1.0),\n    ]\n\n    # Use a fixed random seed for reproducibility as requested.\n    # The generator is created once and used for all subsequent sampling.\n    rng = np.random.default_rng(123456789)\n\n    # Stoichiometry matrix S\n    # Columns correspond to R1, R2, R3\n    # Rows correspond to species A, B\n    S = np.array([\n        [-1, 0, 1],\n        [1, -1, 0]\n    ])\n\n    results = []\n    for Xn, c, tau in test_cases:\n        # Unpack species counts and rate constants\n        x_A, x_B = Xn\n        c1, c2, c3 = c\n\n        # 1. Compute propensities a_j(X^n)\n        a1 = c1 * x_A * x_B\n        a2 = c2 * x_B\n        a3 = c3\n        propensities = np.array([a1, a2, a3])\n\n        # 2. Sample reaction counts K_j\n        # The number of firings of each reaction j in interval tau is\n        # drawn from a Poisson distribution with mean a_j * tau.\n        poisson_means = propensities * tau\n        K = rng.poisson(poisson_means)\n        \n        # 3. Update state to X^{n+1}\n        # X^{n+1} = X^n + S * K\n        delta_X = S @ K\n        Xn1 = Xn + delta_X\n        \n        # 4. Compute conditional drift vector (per unit time)\n        # mu = S * a(X^n)\n        drift_vector = S @ propensities\n        \n        # 5. Compute conditional diffusion matrix (per unit time)\n        # D = S * diag(a(X^n)) * S^T\n        # which is equivalent to sum(a_j * S_j * S_j^T for j in reactions)\n        # For this specific system, the matrix is:\n        # [ a1+a3  -a1   ]\n        # [ -a1    a1+a2 ]\n        D = np.array([\n            [a1 + a3, -a1],\n            [-a1, a1 + a2]\n        ])\n        diff_flat = D.flatten()\n\n        # Append the list of results for this case\n        # Ensure data types match the requirements (int for state, float for others)\n        case_result = [\n            Xn1.tolist(),\n            drift_vector.tolist(),\n            diff_flat.tolist()\n        ]\n        results.append(case_result)\n\n    # Format the final output string as a list of lists.\n    # str() on a list automatically includes spaces, which is a standard representation.\n    # The format requirement '[r1,r2,r3]' is achieved by joining string\n    # representations of each result list.\n    output_str = f\"[{','.join(map(str, results))}]\"\n    \n    # The final print statement in the exact required format.\n    # The `replace` calls are to remove spaces for a more compact representation,\n    # matching a common interpretation of such formatting requirements.\n    print(output_str.replace(\" \", \"\"))\n\nsolve()\n```"
        },
        {
            "introduction": "A naive implementation of the explicit tau-leaping method can produce unphysical negative population counts, a critical flaw that occurs when a leap is too large. This final exercise tackles this practical challenge by having you analyze the probability of such an event and design a \"post-leap check and rollback\" strategy . This reactive control mechanism is a standard technique for ensuring the physical validity of a simulation and introduces a simple, yet essential, form of adaptive time-stepping.",
            "id": "3812871",
            "problem": "You are given a single-species stochastic reaction network in the well-mixed limit governed by the Chemical Master Equation (CME), with a single linear decay reaction $X \\xrightarrow{c} \\emptyset$ where $c$ is a positive rate constant in $\\text{s}^{-1}$. Under the leap condition, the tau-leaping method advances the system by a fixed time increment $\\tau$ (in seconds) by assuming propensities are constant over $[t,t+\\tau)$ and drawing a random number of reaction firings over the interval. Consider the standard post-leap check that rejects a tentative step when it would make any species count negative, followed by a rollback to the previous state and a reduction of the time increment $\\tau$ until acceptance.\n\nTask A (derivation): Using fundamental laws and core definitions of the CME and the assumption underlying tau-leaping, start from the definition of the propensity function for the linear decay network, the well-tested fact that under constant hazard the event count over an interval is described by a Poisson process, and the discrete nature of molecule counts. Derive from first principles, without introducing shortcut formulas, an exact expression for the probability that a tau-leap tentative step is rejected at state $x$ (a nonnegative integer molecule count) with time increment $\\tau$ (in seconds). The rejection occurs if the tentative update would produce a negative count.\n\nTask B (algorithmic design): Design a post-leap check and rollback strategy that operates as follows. Given current state $x$, rate $c$, and initial $\\tau$, perform a tentative tau-leap by drawing the number of firings over $[t,t+\\tau)$ and computing the tentative next state. If any species count would be negative, reject the tentative step, rollback to the previous state, reduce $\\tau$ by a multiplicative factor strictly between $0$ and $1$ (e.g., halve $\\tau$), and retry. Provide a clear description explaining why this strategy will almost surely terminate with an accepted step for the linear decay network, and how its behavior depends on the parameters.\n\nTask C (program requirements): Implement a program that computes the analytical probability of rejection for the first tentative tau-leap step in the linear decay network described above, for each of the test cases below. Use scientifically realistic units: $c$ in $\\text{s}^{-1}$, $\\tau$ in $\\text{s}$, and $x$ as a molecule count (dimensionless integer). The required output for each test case is a single unitless decimal number equal to the rejection probability derived in Task A. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each probability must be rounded to twelve decimal places.\n\nTest suite:\n- Case 1 (happy path): $c=0.1\\,\\text{s}^{-1}$, $x=50$, $\\tau=0.2\\,\\text{s}$.\n- Case 2 (moderate rejection): $c=1.0\\,\\text{s}^{-1}$, $x=3$, $\\tau=2.0\\,\\text{s}$.\n- Case 3 (boundary condition): $c=0.2\\,\\text{s}^{-1}$, $x=0$, $\\tau=1.0\\,\\text{s}$.\n- Case 4 (large-time edge): $c=0.5\\,\\text{s}^{-1}$, $x=10$, $\\tau=10.0\\,\\text{s}$.\n- Case 5 (small-time edge): $c=0.05\\,\\text{s}^{-1}$, $x=1$, $\\tau=0.5\\,\\text{s}$.\n\nFinal output format specification: Your program should produce a single line of output containing a list in the exact form \"[r1,r2,r3,r4,r5]\" where each $r_i$ is the rejection probability for Case $i$, rounded to twelve decimal places.",
            "solution": "The problem statement has been critically validated and is deemed to be scientifically grounded, well-posed, and objective. It presents a standard, non-trivial problem in the field of multiscale modeling and analysis, specifically concerning the tau-leaping method for stochastic simulation. All necessary data and definitions are provided, and there are no contradictions or ambiguities. The problem is valid.\n\n### Task A: Derivation of the Rejection Probability\n\nWe are tasked with deriving from first principles the probability that a tentative tau-leap step is rejected for a single-species linear decay network.\n\n1.  **System Definition**: The system consists of a single chemical species $X$ undergoing a linear decay reaction:\n    $$ X \\xrightarrow{c} \\emptyset $$\n    The state of the system at time $t$ is given by the number of molecules of $X$, denoted by the non-negative integer $x(t)$. The rate constant is $c$, with units of $\\text{s}^{-1}$.\n\n2.  **Propensity Function**: The propensity function, $a(x)$, gives the instantaneous probability rate of a reaction occurring, given the system is in state $x$. For a first-order reaction in a well-mixed volume, this is directly proportional to the number of reactant molecules:\n    $$ a(x) = c \\cdot x $$\n\n3.  **Tau-Leaping Approximation**: The explicit tau-leaping method approximates the system's evolution by assuming the propensity function remains constant over a time interval $[t, t+\\tau)$. The value of this constant propensity is taken at the beginning of the interval, $a(x(t))$.\n\n4.  **Poisson Process**: A process with a constant event rate (hazard) is a Poisson process. Consequently, under the tau-leaping assumption, the number of reaction events, $K$, that occur in the interval $[t, t+\\tau)$ is a random variable drawn from a Poisson distribution.\n\n5.  **Poisson Parameter $\\lambda$**: The parameter of the Poisson distribution, $\\lambda$, is the expected number of events in the interval. It is calculated as the product of the constant rate (propensity) and the duration of the interval:\n    $$ \\lambda = a(x(t)) \\cdot \\tau = (c \\cdot x(t)) \\cdot \\tau $$\n    Letting $x$ represent the current state $x(t)$, the parameter is $\\lambda = cx\\tau$. The probability of observing exactly $k$ reaction events is given by the Poisson probability mass function (PMF):\n    $$ P(K=k) = \\frac{\\lambda^k e^{-\\lambda}}{k!} = \\frac{(cx\\tau)^k e^{-cx\\tau}}{k!} $$\n    where $k$ is a non-negative integer.\n\n6.  **State Update and Rejection Condition**: Each reaction event consumes one molecule of species $X$. If $k$ reactions occur, the tentative state at time $t+\\tau$, denoted $x'$, is:\n    $$ x' = x - k $$\n    The post-leap check rejects this tentative step if any species count becomes negative. In this single-species system, the condition for rejection is:\n    $$ x' < 0 \\implies x - k < 0 \\implies k > x $$\n    Therefore, a rejection occurs if the randomly drawn number of reaction events, $k$, is strictly greater than the number of molecules, $x$, present at the start of the interval.\n\n7.  **Rejection Probability**: The probability of rejection, $P_{\\text{reject}}$, is the probability that the random variable $K$ takes a value greater than $x$.\n    $$ P_{\\text{reject}}(x, c, \\tau) = P(K > x) $$\n    This can be expressed as an infinite sum over the probabilities of all rejectable outcomes:\n    $$ P_{\\text{reject}} = \\sum_{k=x+1}^{\\infty} P(K=k) = \\sum_{k=x+1}^{\\infty} \\frac{(cx\\tau)^k e^{-cx\\tau}}{k!} $$\n    For computational purposes, it is more convenient to express this using the complement rule and the cumulative distribution function (CDF) of the Poisson distribution, $F_K(x) = P(K \\le x)$:\n    $$ P_{\\text{reject}} = 1 - P(K \\le x) = 1 - \\sum_{k=0}^{x} P(K=k) = 1 - \\sum_{k=0}^{x} \\frac{(cx\\tau)^k e^{-cx\\tau}}{k!} $$\n    This expression is the exact analytical probability of rejection for the first tentative step, derived from first principles.\n\n8.  **Boundary Case $x=0$**: If the system starts with $x=0$ molecules, the propensity is $a(0) = c \\cdot 0 = 0$. The Poisson parameter is $\\lambda = 0 \\cdot c \\tau = 0$. The Poisson distribution with $\\lambda=0$ is a point mass at $k=0$, meaning $P(K=0)=1$ and $P(K>0)=0$. The rejection condition is $k > 0$. Therefore, the rejection probability is $P(K>0) = 0$. This aligns with chemical reality: if no molecules are present, no reaction can occur. Our derived formula is also consistent, as $P_{\\text{reject}} = P(K > 0) = 1 - P(K \\le 0) = 1 - P(K=0) = 1 - \\frac{0^0 e^{-0}}{0!} = 1 - 1 = 0$, where we use the standard convention $0^0=1$.\n\n### Task B: Post-Leap Check, Rollback Strategy, and Termination\n\nThe post-leap check and rollback strategy is an essential component for ensuring the physical constraint of non-negative populations in tau-leaping.\n\n1.  **Algorithmic Design**: Given an initial state $x$, rate constant $c$, and an initial time step $\\tau_{\\text{init}}$:\n    a. Initialize the current time step for the attempt: $\\tau \\leftarrow \\tau_{\\text{init}}$.\n    b. **Begin Rollback Loop**:\n        i. Calculate the Poisson parameter $\\lambda = cx\\tau$.\n        ii. Draw a random number of reaction firings $k$ from a Poisson distribution: $k \\sim \\text{Poisson}(\\lambda)$.\n        iii. **Check for validity**: If the number of firings is less than or equal to the current population, $k \\le x$, the step is valid. Accept the step, update the state $x \\leftarrow x-k$, and exit the loop.\n        iv. **Handle rejection**: If $k > x$, the step is invalid. Reject the step, keeping the state at $x$. Reduce the time step by a multiplicative factor $f$ where $0 < f < 1$: $\\tau \\leftarrow f \\cdot \\tau$. Return to the beginning of the loop (step 1b) to retry with the smaller $\\tau$.\n\n2.  **Termination Argument**: The strategy is guaranteed to terminate with an accepted step with probability $1$ (almost surely). The reasoning is as follows:\n    *   Each time a step is rejected, the time increment $\\tau$ is strictly reduced. After $n$ rejections, the time step becomes $\\tau_n = \\tau_{\\text{init}} \\cdot f^n$.\n    *   Since $0 < f < 1$, as the number of retries $n \\to \\infty$, the time step $\\tau_n \\to 0$.\n    *   The Poisson parameter $\\lambda_n = cx\\tau_n$ also approaches $0$.\n    *   The probability of acceptance is $P_{\\text{accept}} = P(K \\le x)$, where $K \\sim \\text{Poisson}(\\lambda_n)$. Since the population $x$ is a non-negative integer, the acceptance condition always includes the event $K=0$.\n    *   Therefore, the probability of acceptance is bounded below by the probability of zero reactions: $P_{\\text{accept}} \\ge P(K=0)$.\n    *   For a Poisson distribution, $P(K=0) = e^{-\\lambda_n}$. As $\\tau_n \\to 0$, we have $\\lambda_n \\to 0$, and thus $P(K=0) = e^{-\\lambda_n} \\to e^{-0} = 1$.\n    *   Since the probability of acceptance approaches $1$ as the number of retries increases, the probability of an infinite sequence of rejections is $0$. Thus, the loop must terminate.\n\n3.  **Parameter Dependence**:\n    *   **$c$ and initial $\\tau$**: The rejection probability scales with the product $c\\tau$. Larger values of $c$ or the initial $\\tau$ lead to a larger initial $\\lambda$, increasing the spread of the Poisson distribution and making it more likely to draw a large $k > x$. This results in a higher initial rejection probability and more expected rollback iterations.\n    *   **$x$**: The effect of $x$ is twofold. It increases the mean of the Poisson distribution ($\\lambda = cx\\tau$), but it also raises the threshold for rejection ($k>x$). For a large mean $\\lambda$, the Poisson distribution is approximately normal $N(\\lambda, \\lambda)$. The probability of rejection, $P(K>x)$, is high if the mean $\\lambda=cx\\tau$ is significantly larger than the threshold $x$, which occurs when $c\\tau > 1$. Conversely, it is low if $c\\tau < 1$.\n    *   **Reduction factor $f$**: A small $f$ (e.g., $0.1$) causes $\\tau$ to shrink rapidly, ensuring quick termination of the rollback loop, but potentially yielding an inefficiently small final time step. A large $f$ (e.g., $0.9$) reduces $\\tau$ slowly, possibly requiring more iterations but finding a larger final accepted step, which is more efficient for the overall simulation progress. The common choice of $f=0.5$ balances these concerns.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import poisson\n\ndef solve():\n    \"\"\"\n    Computes the analytical probability of rejection for the first tentative\n    tau-leap step in a single-species linear decay network for a suite of test cases.\n    \"\"\"\n    # Test cases from the problem statement.\n    # Each case is a tuple (c, x, tau) where:\n    # c: rate constant in s^-1\n    # x: molecule count (dimensionless integer)\n    # tau: time increment in s\n    test_cases = [\n        (0.1, 50, 0.2),   # Case 1\n        (1.0, 3, 2.0),   # Case 2\n        (0.2, 0, 1.0),   # Case 3\n        (0.5, 10, 10.0),  # Case 4\n        (0.05, 1, 0.5),    # Case 5\n    ]\n\n    results = []\n    for c, x, tau in test_cases:\n        # The species count x must be an integer for the Poisson distribution functions.\n        # The problem statement guarantees x is an integer, so we cast to ensure type correctness.\n        x_int = int(x)\n\n        # The core of the tau-leaping method assumes the number of reaction events K\n        # in the interval tau follows a Poisson distribution. The parameter lambda\n        # is the expected number of events, given by propensity * tau.\n        # Propensity for X -> 0 is a(x) = c * x.\n        lambda_param = c * x * tau\n\n        # Rejection occurs if the number of events k is greater than the current\n        # population x, as this would lead to a negative count (x - k < 0).\n        # The rejection probability is therefore P(K > x), where K ~ Poisson(lambda).\n        # This is calculated using the survival function (sf) of the Poisson distribution,\n        # which is defined as sf(k, mu) = P(X > k) for a random variable X ~ Poisson(mu).\n        # Using sf is numerically more stable than calculating 1 - cdf(k, mu),\n        # especially for values in the tail of the distribution.\n        rejection_prob = poisson.sf(x_int, lambda_param)\n\n        # The result must be formatted as a string rounded to twelve decimal places.\n        results.append(f\"{rejection_prob:.12f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}