{
    "hands_on_practices": [
        {
            "introduction": "要真正掌握Gillespie算法，最好的方法是亲手进行一次完整的迭代。这个练习将引导您为一个常见的基因表达模型，手动执行Gillespie算法（也称为随机模拟算法或SSA）的单步计算。通过这个实践，您将巩固对计算反应倾向（propensity）、抽样等待时间（waiting time）和选择下一个反应事件的理解 。",
            "id": "4388732",
            "problem": "考虑一个单细胞中的本构基因表达微环路，其中包含两种分子：信使核糖核酸（$M$）和蛋白质（$P$）。该系统在质量作用动力学下被建模为一个由化学主方程（CME）控制的连续时间马尔可夫链。应用了随机模拟算法（SSA；Gillespie算法）。反应网络如下：\n1. $\\varnothing \\rightarrow M$，随机速率常数为 $c_{1}$，\n2. $M \\rightarrow M + P$，随机速率常数为 $c_{2}$，\n3. $M \\rightarrow \\varnothing$，随机速率常数为 $c_{3}$，\n4. $P \\rightarrow \\varnothing$，随机速率常数为 $c_{4}$。\n\n假设随机速率常数为 $c_{1} = 0.05\\,\\mathrm{s}^{-1}$、$c_{2} = 0.50\\,\\mathrm{s}^{-1}$、$c_{3} = 0.10\\,\\mathrm{s}^{-1}$ 和 $c_{4} = 0.02\\,\\mathrm{s}^{-1}$。在时间 $t(0)$ 时的初始分子数为 $x_{M}(0) = 3$ 和 $x_{P}(0) = 10$，初始时间为 $t(0) = 0\\,\\mathrm{s}$。对于单次SSA迭代，使用$(0,1)$上两个独立的均匀分布随机变量，给定为 $r_{1} = \\exp(-2)$ 和 $r_{2} = 0.925$。\n\n从CME中倾向函数的基础定义和控制SSA反应时间的指数等待时间的无记忆性出发，执行一次SSA迭代：计算 $\\mu \\in \\{1,2,3,4\\}$ 的倾向 $a_{\\mu}(x)$、总倾向 $a_{0}$、等待时间 $\\tau$、下一个反应的索引 $j$，以及在反应 $j$ 发生后更新的时间和状态。将等待时间和更新后的时间四舍五入到四位有效数字，并以秒为单位表示更新后的时间。提供 $a_{0}$、$\\tau$、$j$、更新后的时间 $t(0)+\\tau$ 以及更新后的状态 $(x_{M}, x_{P})$ 的最终数值。",
            "solution": "该问题要求对给定的基因表达网络执行一次随机模拟算法（SSA）（也称为Gillespie算法）的迭代。系统的状态由分子数向量 $x(t) = (x_{M}(t), x_{P}(t))$ 描述，其中 $x_{M}$ 是信使RNA分子的数量，$x_{P}$ 是蛋白质分子的数量。\n\n四个化学反应如下：\n1. $R_1: \\varnothing \\xrightarrow{c_1} M$\n2. $R_2: M \\xrightarrow{c_2} M + P$\n3. $R_3: M \\xrightarrow{c_3} \\varnothing$\n4. $R_4: P \\xrightarrow{c_4} \\varnothing$\n\n在时间 $t(0) = 0\\,\\mathrm{s}$ 时的初始状态给定为 $x(0) = (x_{M}(0), x_{P}(0)) = (3, 10)$。随机速率常数为 $c_{1} = 0.05\\,\\mathrm{s}^{-1}$、$c_{2} = 0.50\\,\\mathrm{s}^{-1}$、$c_{3} = 0.10\\,\\mathrm{s}^{-1}$ 和 $c_{4} = 0.02\\,\\mathrm{s}^{-1}$。\n\nSSA的第一步是为每个反应 $\\mu \\in \\{1, 2, 3, 4\\}$ 计算倾向函数 $a_{\\mu}(x)$。倾向函数表示在给定当前状态 $x$ 的情况下，单位时间内某一特定反应发生的概率。对于质量作用动力学，倾向为：\n- $a_{1}(x) = c_{1}$ (零级反应)\n- $a_{2}(x) = c_{2} x_{M}$ (一级反应)\n- $a_{3}(x) = c_{3} x_{M}$ (一级反应)\n- $a_{4}(x) = c_{4} x_{P}$ (一级反应)\n\n我们在初始状态 $x(0) = (3, 10)$ 下计算这些倾向：\n- $a_{1}(x(0)) = 0.05\\,\\mathrm{s}^{-1}$\n- $a_{2}(x(0)) = (0.50\\,\\mathrm{s}^{-1})(3) = 1.50\\,\\mathrm{s}^{-1}$\n- $a_{3}(x(0)) = (0.10\\,\\mathrm{s}^{-1})(3) = 0.30\\,\\mathrm{s}^{-1}$\n- $a_{4}(x(0)) = (0.02\\,\\mathrm{s}^{-1})(10) = 0.20\\,\\mathrm{s}^{-1}$\n\n总倾向 $a_{0}(x)$ 是各个倾向之和。它代表任何反应发生的速率。\n$$a_{0}(x(0)) = \\sum_{\\mu=1}^{4} a_{\\mu}(x(0)) = 0.05 + 1.50 + 0.30 + 0.20 = 2.05\\,\\mathrm{s}^{-1}$$\n\n第二步是从$(0, 1)$上的均匀分布中生成两个独立的随机数 $r_{1}$ 和 $r_{2}$。给定值为 $r_{1} = \\exp(-2)$ 和 $r_{2} = 0.925$。\n\n到下一个反应发生的等待时间 $\\tau$ 是一个速率为 $a_{0}(x)$ 的指数分布随机变量。指数分布的无记忆性在这里是基础。我们可以使用反演法生成 $\\tau$：\n$$\\tau = \\frac{1}{a_{0}(x)} \\ln\\left(\\frac{1}{r_{1}}\\right) = -\\frac{\\ln(r_{1})}{a_{0}(x)}$$\n代入给定的 $r_{1}$ 值和计算出的 $a_{0}(x(0))$：\n$$\\tau = -\\frac{\\ln(\\exp(-2))}{2.05} = -\\frac{-2}{2.05} = \\frac{2}{2.05} \\approx 0.975609756\\,\\mathrm{s}$$\n按要求四舍五入到四位有效数字，我们得到 $\\tau \\approx 0.9756\\,\\mathrm{s}$。\n\n下一个要发生的反应（索引为 $j$）是使用第二个随机数 $r_{2}$ 确定的。索引 $j$ 是满足以下条件的最小整数：\n$$\\sum_{\\mu=1}^{j} a_{\\mu}(x) \\ge r_{2} \\cdot a_{0}(x)$$\n首先，我们计算目标值：\n$$r_{2} \\cdot a_{0}(x(0)) = 0.925 \\cdot 2.05 = 1.89625$$\n现在我们检查倾向的累积和：\n- 对于 $j=1$：$\\sum_{\\mu=1}^{1} a_{\\mu} = a_{1} = 0.05$。这小于 $1.89625$。\n- 对于 $j=2$：$\\sum_{\\mu=1}^{2} a_{\\mu} = a_{1} + a_{2} = 0.05 + 1.50 = 1.55$。这小于 $1.89625$。\n- 对于 $j=3$：$\\sum_{\\mu=1}^{3} a_{\\mu} = a_{1} + a_{2} + a_{3} = 1.55 + 0.30 = 1.85$。这小于 $1.89625$。\n- 对于 $j=4$：$\\sum_{\\mu=1}^{4} a_{\\mu} = a_{1} + a_{2} + a_{3} + a_{4} = 1.85 + 0.20 = 2.05$。这大于或等于 $1.89625$。\n\n该条件对于 $j=4$ 满足。因此，下一个发生的反应是 $R_4$。\n\n最后一步是更新系统时间和状态。\n新时间 $t'$ 是旧时间和等待时间 $\\tau$ 的和：\n$$t' = t(0) + \\tau = 0\\,\\mathrm{s} + 0.9756\\,\\mathrm{s} = 0.9756\\,\\mathrm{s}$$\n\n新状态 $x'$ 是通过将反应 $j=4$ 的状态改变向量 $\\nu_j$ 加到旧状态 $x(0)$ 上得到的。反应 $R_4: P \\rightarrow \\varnothing$ 对应于一个蛋白质 $P$ 分子的减少。状态改变向量为 $\\nu_4 = (0, -1)$。\n$$x' = x(0) + \\nu_4 = (3, 10) + (0, -1) = (3, 9)$$\n更新后的状态为 $x_{M}' = 3$ 和 $x_{P}' = 9$。\n\n总而言之，一次SSA迭代的结果是：\n- 总倾向 $a_{0} = 2.05\\,\\mathrm{s}^{-1}$。\n- 等待时间 $\\tau \\approx 0.9756\\,\\mathrm{s}$。\n- 下一个反应的索引 $j=4$。\n- 更新后的时间 $t' \\approx 0.9756\\,\\mathrm{s}$。\n- 更新后的状态 $(x_{M}', x_{P}') = (3, 9)$。\n\n将这些值汇编成最终答案。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n2.05 & 0.9756 & 4 & 0.9756 & 3 & 9\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "在手动计算之后，下一步是将理论转化为实际可用的代码，而这需要对算法的边界条件有精确的把握。这个练习将指导您编写一个鲁棒的Gillespie模拟程序，重点处理如何正确识别和处理“吸收态”（absorbing states），以及如何管理模拟的终止时间 。对于任何旨在进行精确随机模拟的建模者来说，这些都是确保模型正确性的关键技能。",
            "id": "3935575",
            "problem": "请考虑用于合成生物学建模的离散状态、连续时间反应网络的 Gillespie 随机模拟算法 (SSA) 的直接法。一个反应网络由一组有限的反应通道组成，每个通道都有一个依赖于当前分子数量的倾向函数。在任何状态 $\\mathbf{x}$ 下，发生任何反应的总倾向是所有反应倾向之和，记为 $a_0(\\mathbf{x})$。为了确保对吸收态和终止行为的正确建模，需要对 $a_0(\\mathbf{x}) = 0$ 的情况进行严格解释。\n\n从连续时间马尔可夫跳跃过程和离散分子的质量作用动力学的第一性原理出发，推导系统处于吸收态的条件，以及当 $a_0(\\mathbf{x}) = 0$ 时直接法应如何停止。然后，实现一个程序，该程序能够稳健地检测和处理在模拟初始和过程中出现的 $a_0(\\mathbf{x}) = 0$ 情况，并且如果 $a_0(\\mathbf{x}) > 0$ 但下一次反应时间将超过用户指定的最终时间 $T_{\\mathrm{end}}$，程序应在 $T_{\\mathrm{end}}$ 停止。\n\n实现必须：\n- 使用具有整数分子数量的离散质量作用动力学。为每个反应定义一个非负整数反应物化学计量向量和一个单位为 $\\mathrm{s}^{-1}$ 的正常数速率常数。反应的倾向应计算为速率常数乘以所有物种的二项式项 $\\binom{x_i}{r_i}$ 的乘积，其中当 $x_i < r_i$ 时，$\\binom{x_i}{0} = 1$ 且 $\\binom{x_i}{r_i} = 0$。\n- 在每一步，计算 $a_0(\\mathbf{x})$；如果 $a_0(\\mathbf{x}) = 0$，则将状态 $\\mathbf{x}$ 解释为吸收态并立即停止。\n- 如果 $a_0(\\mathbf{x}) > 0$，通过使用正确的风险率抽样，得到一个指数分布的等待时间，并按与单个倾向成比例的概率选择下一个反应的索引。如果提议的下一次反应时间将超过 $T_{\\mathrm{end}}$，则不触发任何反应并在 $T_{\\mathrm{end}}$ 停止。\n- 对于每个测试用例，返回已触发的反应次数（整数）、运行是否在吸收态结束（布尔值），以及以秒表示的最终时间（浮点数）。\n\n所有时间均以 $\\mathrm{s}$ 表示。本问题不涉及角度。本问题中没有百分比。\n\n实现该程序以运行以下测试套件，每个测试套件由一个反应网络、一个初始状态、一个最终时间和一个伪随机种子定义。对于质量作用动力学，请如上所述使用基于二项式的离散公式计算倾向。\n\n测试套件：\n- 案例 1（模拟期间达到吸收态）：单物种降解。物种 $X$ 发生一个反应 $X \\to \\varnothing$，速率常数 $c = 1.0\\,\\mathrm{s}^{-1}$。初始数量 $x(0) = 3$。最终时间 $T_{\\mathrm{end}} = 2.0\\,\\mathrm{s}$。种子 $12345$。\n- 案例 2（初始吸收态）：单物种二聚化为惰性物质。物种 $X$ 发生一个反应 $2X \\to \\varnothing$，速率常数 $c = 1.0\\,\\mathrm{s}^{-1}$。初始数量 $x(0) = 1$。最终时间 $T_{\\mathrm{end}} = 1.0\\,\\mathrm{s}$。种子 $42$。\n- 案例 3（最终时间前永不吸收）：生灭过程。物种 $X$ 发生两个反应：$\\varnothing \\to X$（速率 $k_0 = 2.0\\,\\mathrm{s}^{-1}$）和 $X \\to \\varnothing$（速率 $k_1 = 1.0\\,\\mathrm{s}^{-1}$）。初始数量 $x(0) = 0$。最终时间 $T_{\\mathrm{end}} = 1.0\\,\\mathrm{s}$。种子 $314159$。\n- 案例 4（经过有限链后吸收）：双物种链式反应。物种 $X,Y$ 发生反应 $X \\to Y$（速率 $c_1 = 0.5\\,\\mathrm{s}^{-1}$）和 $Y \\to \\varnothing$（速率 $c_2 = 0.7\\,\\mathrm{s}^{-1}$）。初始数量 $(x(0), y(0)) = (1,0)$。最终时间 $T_{\\mathrm{end}} = 5.0\\,\\mathrm{s}$。种子 $2024$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果。每个测试用例的结果本身必须是一个形如 $[N_{\\mathrm{events}}, \\mathrm{absorbed}, t_{\\mathrm{final}}]$ 的列表，其中 $N_{\\mathrm{events}}$ 是整数，$\\mathrm{absorbed}$ 是布尔值，$t_{\\mathrm{final}}$ 是以秒为单位的浮点数。例如，整个输出行应类似于 $[[\\ldots],[\\ldots],[\\ldots],[\\ldots]]$。",
            "solution": "用户提供了一个有效的问题陈述。它具有科学依据，问题设定良好且客观。它包含两部分请求：一是推导在 Gillespie 随机模拟算法 (SSA) 中处理吸收态的理论基础，二是实现该算法以解决一系列测试用例。所有参数、条件和要求都已明确定义。\n\n### 理论推导与算法设计\n\nGillespie 随机模拟算法 (SSA) 是一种为随机化学系统生成统计上正确的轨迹的方法，该系统被建模为一个连续时间、离散状态的马尔可夫跳跃过程。系统的状态是一个向量 $\\mathbf{X}(t) = (X_1(t), X_2(t), \\ldots, X_N(t))$，表示在时间 $t$ 时 $N$ 种分子物质的整数数量。系统通过一系列 $M$ 个反应通道进行演化。\n\n#### 到下一次反应的等待时间\n\nSSA 的核心基于每个反应 $j \\in \\{1, \\ldots, M\\}$ 的**倾向函数** $a_j(\\mathbf{x})$。量 $a_j(\\mathbf{x})dt$ 表示在时间 $t$ 系统处于状态 $\\mathbf{x}$ 的条件下，反应 $j$ 将在无穷小时间区间 $[t, t+dt)$ 内发生的概率。如问题所述，离散质量作用动力学的倾向函数由下式给出：\n$$ a_j(\\mathbf{x}) = c_j \\prod_{i=1}^{N} \\binom{x_i}{r_{ij}} $$\n其中 $c_j$ 是反应 $j$ 的随机速率常数，$x_i$ 是物种 $i$ 的分子数，$r_{ij}$ 是反应物化学计量，即反应 $j$ 的单次发生所消耗的物种 $i$ 的分子数。二项式系数 $\\binom{n}{k}$ 在 $k > n$ 时定义为 $0$，这自然地保证了当反应物不足时反应无法发生。\n\n总倾向 $a_0(\\mathbf{x})$ 是所有可能反应的倾向之和：\n$$ a_0(\\mathbf{x}) = \\sum_{j=1}^{M} a_j(\\mathbf{x}) $$\n量 $a_0(\\mathbf{x})dt$ 是*任何*反应将在区间 $[t, t+dt)$ 内发生的概率。\n\n为了确定下一次反应*何时*发生，我们需求解等待时间 $\\tau$ 的概率分布。设 $P_0(\\tau, \\mathbf{x})$ 是从时间 $t$ 的状态 $\\mathbf{x}$ 开始，在区间 $[t, t+\\tau)$ 内没有反应发生的概率。要在 $[t, t+\\tau+d\\tau)$ 内不发生反应，必须在 $[t, t+\\tau)$ 内不发生反应，并且在 $[t+\\tau, t+\\tau+d\\tau)$ 内也不发生反应。由于该过程是马尔可夫过程，这些事件是独立的。在 $[t+\\tau, t+\\tau+d\\tau)$ 内不发生反应的概率是 $1 - a_0(\\mathbf{x})d\\tau$。因此：\n$$ P_0(\\tau+d\\tau, \\mathbf{x}) = P_0(\\tau, \\mathbf{x}) (1 - a_0(\\mathbf{x})d\\tau) $$\n整理后得到微分方程：\n$$ \\frac{P_0(\\tau+d\\tau, \\mathbf{x}) - P_0(\\tau, \\mathbf{x})}{d\\tau} = \\frac{dP_0(\\tau, \\mathbf{x})}{d\\tau} = -a_0(\\mathbf{x}) P_0(\\tau, \\mathbf{x}) $$\n在初始条件 $P_0(0, \\mathbf{x}) = 1$（在零时间内不发生反应的概率为 $1$）下，解为：\n$$ P_0(\\tau, \\mathbf{x}) = e^{-a_0(\\mathbf{x})\\tau} $$\n这是等待时间 $\\tau$ 的生存函数。其概率密度函数 $p(\\tau | \\mathbf{x})$ 可通过微分求得：\n$$ p(\\tau | \\mathbf{x}) = -\\frac{dP_0(\\tau, \\mathbf{x})}{d\\tau} = a_0(\\mathbf{x}) e^{-a_0(\\mathbf{x})\\tau} $$\n这是速率参数为 $a_0(\\mathbf{x})$ 的指数分布的概率密度函数。为了对 $\\tau$ 进行抽样，我们使用逆变换采样法。我们从 $(0,1)$ 中抽取一个均匀随机数 $u_1$，并令累积分布 $F(\\tau) = 1 - e^{-a_0(\\mathbf{x})\\tau}$ 等于 $u_1$。解出 $\\tau$：\n$$ \\tau = \\frac{1}{a_0(\\mathbf{x})} \\ln\\left(\\frac{1}{1-u_1}\\right) $$\n由于 $1-u_1$ 也在 $(0,1)$ 上均匀分布，我们可以将其简化为：\n$$ \\tau = \\frac{1}{a_0(\\mathbf{x})} \\ln\\left(\\frac{1}{u_1}\\right) $$\n\n#### 吸收态条件：$a_0(\\mathbf{x}) = 0$\n\n通过考察 $a_0(\\mathbf{x}) = 0$ 的情况，可以得出一个关键的洞见。\n到下一次反应的平均等待时间是 $E[\\tau] = 1/a_0(\\mathbf{x})$。如果 $a_0(\\mathbf{x}) = 0$，平均等待时间将变为无穷大。概率密度函数 $p(\\tau | \\mathbf{x})$ 对于任何有限的 $\\tau$ 都变为 $0$，这意味着在任何有限时间间隔内发生反应的概率为零。系统将无限期地保持在状态 $\\mathbf{x}$。这样的状态被称为**吸收态**。\n\n由于所有倾向 $a_j(\\mathbf{x})$ 都是非负的，条件 $a_0(\\mathbf{x}) = \\sum_j a_j(\\mathbf{x}) = 0$ 当且仅当对于所有反应 $j = 1, \\ldots, M$ 都有 $a_j(\\mathbf{x}) = 0$ 时成立。根据倾向函数的定义，$a_j(\\mathbf{x})$ 变为 $0$ 的条件是，对于其至少一种反应物 $i$，可用的分子数 $x_i$ 小于反应所需的数量 $r_{ij}$。因此，当网络中的每个反应都因缺少至少一种所需反应物而“断供”时，系统就达到了吸收态。\n\n因此，SSA 的实现必须在每一步检查 $a_0(\\mathbf{x})$ 的值。如果 $a_0(\\mathbf{x}) = 0$，模拟必须立即终止，并且该状态必须被标记为吸收态。这个条件可能在模拟开始时（如果初始状态是吸收态）或在任何后续步骤中满足。\n\n#### 下一个反应的选择\n\n如果 $a_0(\\mathbf{x}) > 0$，则在时间 $\\tau$ 后将发生一个反应。为了确定*哪个*反应发生，我们计算该事件具体为反应 $\\mu$ 的概率。这是反应 $\\mu$ 发生的概率与任何反应发生的概率之比：\n$$ P(\\text{反应 } \\mu) = \\frac{a_\\mu(\\mathbf{x})dt}{a_0(\\mathbf{x})dt} = \\frac{a_\\mu(\\mathbf{x})}{a_0(\\mathbf{x})} $$\nGillespie 直接法从这个离散概率分布中抽样一个反应索引 $\\mu$。这是通过抽取第二个均匀随机数 $u_2 \\in (0,1)$ 并找到满足以下条件的最小整数 $\\mu$ 来完成的：\n$$ \\sum_{j=1}^{\\mu} a_j(\\mathbf{x}) > u_2 \\cdot a_0(\\mathbf{x}) $$\n\n#### 算法与停止条件\n\n所实现的算法将按以下步骤进行：\n1. 初始化时间 $t=0$，状态向量 $\\mathbf{x} = \\mathbf{x}_0$，以及事件数 $N_{\\mathrm{events}}=0$。\n2. 开始一个循环，只要模拟时间 $t$ 小于最终时间 $T_{\\mathrm{end}}$，循环就继续。\n3. 在每一步，计算所有反应的倾向 $a_j(\\mathbf{x})$ 及其总和 $a_0(\\mathbf{x})$。\n4. **第一个停止条件（吸收）：** 如果 $a_0(\\mathbf{x}) = 0$，系统处于吸收态。循环终止。最终时间是当前时间 $t$，`absorbed` 标志设置为 `True`。\n5. 如果 $a_0(\\mathbf{x}) > 0$，从 $U(0,1)$ 中抽取两个随机数 $u_1, u_2$ 并计算等待时间 $\\tau$。\n6. **第二个停止条件（结束时间）：** 如果下一次反应的时间 $t + \\tau$ 大于或等于 $T_{\\mathrm{end}}$，则不再处理任何反应。模拟时间设置为 $T_{\\mathrm{end}}$，循环终止。`absorbed` 标志为 `False`。\n7. 如果反应在 $T_{\\mathrm{end}}$ 之前发生，更新时间 $t \\leftarrow t + \\tau$。使用 $u_2$ 选择反应索引 $\\mu$。更新状态向量 $\\mathbf{x} \\leftarrow \\mathbf{x} + \\mathbf{v}_{\\mu}$，其中 $\\mathbf{v}_{\\mu}$ 是反应 $\\mu$ 的状态改变向量。将 $N_{\\mathrm{events}}$ 加一。\n8. 循环从第 3 步重复。\n9. 终止时，算法返回触发的总事件数、一个指示终止是否因吸收而发生的布尔值以及最终的模拟时间。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import comb\n\ndef solve():\n    \"\"\"\n    Sets up and runs the test suite for the Gillespie SSA implementation.\n    \"\"\"\n\n    def run_gillespie(initial_state, reactant_stoich, state_change, rate_constants, T_end, seed):\n        \"\"\"\n        Implements the Gillespie Direct Method SSA.\n\n        Args:\n            initial_state (list or np.ndarray): Initial molecular counts.\n            reactant_stoich (np.ndarray): Matrix of reactant stoichiometries (reactions x species).\n            state_change (np.ndarray): State-change matrix (reactions x species).\n            rate_constants (list or np.ndarray): Vector of reaction rate constants.\n            T_end (float): The final simulation time.\n            seed (int): Seed for the pseudorandom number generator.\n\n        Returns:\n            list: A list containing [N_events, absorbed, t_final].\n        \"\"\"\n        rng = np.random.default_rng(seed)\n\n        num_species = len(initial_state)\n        num_reactions = len(rate_constants)\n\n        t = 0.0\n        x = np.array(initial_state, dtype=int)\n        n_events = 0\n        absorbed = False\n\n        def calculate_propensities(current_x):\n            propensities = np.zeros(num_reactions, dtype=float)\n            for j in range(num_reactions):\n                # Calculate the product of binomial terms, h_j\n                h_j = 1.0\n                possible = True\n                for i in range(num_species):\n                    r_ij = reactant_stoich[j, i]\n                    if r_ij > 0:\n                        x_i = current_x[i]\n                        if x_i  r_ij:\n                            possible = False\n                            break\n                        h_j *= comb(x_i, r_ij, exact=False)\n                \n                if possible:\n                    propensities[j] = rate_constants[j] * h_j\n            return propensities\n\n        # Main simulation loop\n        while t  T_end:\n            propensities = calculate_propensities(x)\n            a0 = np.sum(propensities)\n\n            if a0 == 0.0:\n                absorbed = True\n                break\n\n            u1, u2 = rng.random(2)\n            tau = (1.0 / a0) * np.log(1.0 / u1)\n\n            if t + tau >= T_end:\n                t = T_end\n                break\n            \n            t += tau\n\n            # Select the next reaction\n            target = u2 * a0\n            a_sum = 0.0\n            mu = -1  # reaction index\n            for j in range(num_reactions):\n                a_sum += propensities[j]\n                if a_sum >= target:\n                    mu = j\n                    break\n\n            # Update state and event count\n            x += state_change[mu]\n            n_events += 1\n\n        t_final = t\n        return [n_events, absorbed, t_final]\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: Absorption reached during simulation\n        {\n            \"initial_state\": [3],\n            \"reactant_stoich\": np.array([[1]]),\n            \"state_change\": np.array([[-1]]),\n            \"rate_constants\": [1.0],\n            \"T_end\": 2.0,\n            \"seed\": 12345,\n        },\n        # Case 2: Initial absorbing state\n        {\n            \"initial_state\": [1],\n            \"reactant_stoich\": np.array([[2]]),\n            \"state_change\": np.array([[-2]]),\n            \"rate_constants\": [1.0],\n            \"T_end\": 1.0,\n            \"seed\": 42,\n        },\n        # Case 3: Never absorbing before final time\n        {\n            \"initial_state\": [0],\n            \"reactant_stoich\": np.array([[0], [1]]),\n            \"state_change\": np.array([[1], [-1]]),\n            \"rate_constants\": [2.0, 1.0],\n            \"T_end\": 1.0,\n            \"seed\": 314159,\n        },\n        # Case 4: Absorption after a finite chain\n        {\n            \"initial_state\": [1, 0],\n            \"reactant_stoich\": np.array([[1, 0], [0, 1]]),\n            \"state_change\": np.array([[-1, 1], [0, -1]]),\n            \"rate_constants\": [0.5, 0.7],\n            \"T_end\": 5.0,\n            \"seed\": 2024,\n        },\n    ]\n\n    results = []\n    for case_params in test_cases:\n        result = run_gillespie(**case_params)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    # Format: [[N_events,absorbed,t_final],[...],[...],[...]]\n    outer_list = []\n    for res in results:\n        # res is like [3, True, 1.2345]\n        inner_list_str = f\"[{res[0]},{str(res[1])},{res[2]}]\"\n        outer_list.append(inner_list_str)\n    \n    print(f\"[{','.join(outer_list)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "对于包含大量反应的复杂系统，朴素的Gillespie算法在每一步都重新计算所有反应倾向，这会变得非常低效。这个练习介绍了一种强大的优化方法：依赖图（dependency graph）。通过构建和分析这个图，您可以精确地找出在每次反应事件后，哪些反应的倾向受到了影响，从而只更新必要的倾向函数，极大地提升模拟速度 。",
            "id": "3935525",
            "problem": "考虑一个充分混合的、等温的单细胞合成基因线路，该线路被建模为化学主方程下的连续时间马尔可夫过程，并通过吉勒斯皮随机模拟算法（SSA）进行模拟，其中每个反应的倾向性是当前分子数的函数。该线路涉及一个可以结合转录因子的启动子，从而导致受调控的转录和翻译以及降解。设分子种类为 $G$（未结合的启动子）、$C$（与转录因子结合的启动子）、$T$（转录因子）、$M$（信使核糖核酸）和 $P$（蛋白质）。反应网络如下：\n- $R_{1}: G + T \\xrightarrow{k_{1}} C$\n- $R_{2}: C \\xrightarrow{k_{2}} G + T$\n- $R_{3}: C \\xrightarrow{k_{3}} C + M$\n- $R_{4}: G \\xrightarrow{k_{4}} G + M$\n- $R_{5}: M \\xrightarrow{k_{5}} \\varnothing$\n- $R_{6}: M \\xrightarrow{k_{6}} M + P$\n- $R_{7}: P \\xrightarrow{k_{7}} \\varnothing$\n- $R_{8}: P \\xrightarrow{k_{8}} P + T$\n- $R_{9}: T \\xrightarrow{k_{9}} \\varnothing$\n\n假设所有反应都遵循随机质量作用动力学，因此每个倾向性 $a_{j}$ 仅取决于反应 $R_{j}$ 的反应物种类的分子数（例如，$a_{1}(G,T) = k_{1} G T$，$a_{2}(C) = k_{2} C$，$a_{3}(C) = k_{3} C$，$a_{4}(G) = k_{4} G$，$a_{5}(M) = k_{5} M$，$a_{6}(M) = k_{6} M$，$a_{7}(P) = k_{7} P$，$a_{8}(P) = k_{8} P$，$a_{9}(T) = k_{9} T$）。设 $\\nu_{i}$ 表示反应 $R_{i}$ 的净化学计量变化向量，物种顺序为 $(G, T, C, M, P)$。\n\n从化学主方程和吉勒斯皮随机模拟算法（SSA）的定义出发，并仅使用倾向性对分子数的标准质量作用依赖关系，完成以下任务：\n1. 定义确定依赖图中反应 $R_{i}$ 和 $R_{j}$ 之间边的规则，该规则用 $R_{i}$ 改变的物种和出现在 $a_{j}$ 中的物种来表示。\n2. 通过对每个 $i \\in \\{1,\\dots,9\\}$ 识别出索引集合 $j$，使得在 $R_{i}$ 发生后必须立即重新计算倾向性 $a_{j}$，来构建给定网络的依赖图。\n3. 使用你的图，确定在 $R_{1}$ 单次发生后必须立即重新计算的不同倾向性的最小数量。\n\n将最终答案表示为整数。无需四舍五入，也无需单位。",
            "solution": "题目要求解答与吉勒斯皮随机模拟算法（SSA）及其通过依赖图对给定生化反应网络进行优化相关的三个问题。我们将依次解答。系统在任何时刻 $t$ 的状态由分子数向量 $X(t) = (N_G, N_T, N_C, N_M, N_P)$ 给出，其中 $N_S$ 是物种 $S$ 的分子数。\n\nSSA 的核心思想是在每一步确定到下一个反应发生的时间以及哪个反应会发生。这需要了解每个反应 $R_j$ 的倾向性函数 $a_j(X)$。在一个反应 $R_i$ 发生后，状态向量从 $X$ 更新为 $X + \\nu_i$，其中 $\\nu_i$ 是 $R_i$ 的化学计量变化向量。因此，所有倾向性函数都必须更新以反映新的状态。然而，一个倾向性函数 $a_j(X)$ 仅当其值发生变化时才需要重新计算，而这当且仅当其至少一种反应物的数量发生改变时才会发生。依赖图将这种关系形式化。\n\n### 第1部分：定义依赖图规则\n\n反应网络的依赖图是一个有向图，其节点是反应 $\\{R_1, \\dots, R_M\\}$，如果反应 $R_i$ 的发生使得倾向性 $a_j$ 必须重新计算，则存在从节点 $i$ 到节点 $j$ 的有向边（记作 $R_i \\to R_j$）。\n\n设所有分子种类的集合为 $\\mathcal{S} = \\{S_1, \\dots, S_N\\}$。系统状态为 $X = (N_1, \\dots, N_N)$，其中 $N_k$ 是物种 $S_k$ 的数量。\n反应 $R_i$ 的化学计量变化向量是 $\\nu_i = (\\nu_{i1}, \\nu_{i2}, \\dots, \\nu_{iN})$，其中 $\\nu_{ik}$ 是当反应 $R_i$ 发生一次时物种 $S_k$ 的分子数的净变化。\n因 $R_i$ 发生而数量改变的物种集合是 $\\mathcal{U}_i = \\{ S_k \\in \\mathcal{S} \\mid \\nu_{ik} \\neq 0 \\}$。\n\n反应 $R_j$ 的倾向性函数 $a_j(X)$ 取决于其反应物的数量。设反应 $R_j$ 的反应物集合为 $\\mathcal{R}_j$。\n倾向性 $a_j$ 在反应 $R_i$ 发生后必须重新计算，当且仅当 $\\mathcal{R}_j$ 中至少一种物种的数量因 $R_i$ 而改变。这发生在 $R_i$ 改变的物种集合与 $R_j$ 的反应物集合的交集非空时。\n\n因此，确定依赖图中边的规则是：\n从 $R_i$ 到 $R_j$ 存在一条有向边，当且仅当 $\\mathcal{U}_i \\cap \\mathcal{R}_j \\neq \\emptyset$。\n\n### 第2部分：构建依赖图\n\n我们将上述定义的规则应用于给定的反应网络。物种为 $G, T, C, M, P$。\n\n首先，我们确定每个反应改变其数量的物种集合 $\\mathcal{U}_i = \\{S_k \\mid \\nu_{ik} \\neq 0\\}$，以及每个反应的反应物集合 $\\mathcal{R}_j$。\n物种顺序为 $(G, T, C, M, P)$。化学计量向量 $\\nu_i$ 如下：\n- $R_1: G + T \\to C \\implies \\nu_1 = (-1, -1, 1, 0, 0) \\implies \\mathcal{U}_1 = \\{G, T, C\\}$\n- $R_2: C \\to G + T \\implies \\nu_2 = (1, 1, -1, 0, 0) \\implies \\mathcal{U}_2 = \\{G, T, C\\}$\n- $R_3: C \\to C + M \\implies \\nu_3 = (0, 0, 0, 1, 0) \\implies \\mathcal{U}_3 = \\{M\\}$\n- $R_4: G \\to G + M \\implies \\nu_4 = (0, 0, 0, 1, 0) \\implies \\mathcal{U}_4 = \\{M\\}$\n- $R_5: M \\to \\varnothing \\implies \\nu_5 = (0, 0, 0, -1, 0) \\implies \\mathcal{U}_5 = \\{M\\}$\n- $R_6: M \\to M + P \\implies \\nu_6 = (0, 0, 0, 0, 1) \\implies \\mathcal{U}_6 = \\{P\\}$\n- $R_7: P \\to \\varnothing \\implies \\nu_7 = (0, 0, 0, 0, -1) \\implies \\mathcal{U}_7 = \\{P\\}$\n- $R_8: P \\to P + T \\implies \\nu_8 = (0, 1, 0, 0, 0) \\implies \\mathcal{U}_8 = \\{T\\}$\n- $R_9: T \\to \\varnothing \\implies \\nu_9 = (0, -1, 0, 0, 0) \\implies \\mathcal{U}_9 = \\{T\\}$\n\n倾向性 $a_j$ 的反应物集合 $\\mathcal{R}_j$（假设为质量作用动力学）如下：\n- $a_1(G,T) = k_1GT \\implies \\mathcal{R}_1 = \\{G, T\\}$\n- $a_2(C) = k_2C \\implies \\mathcal{R}_2 = \\{C\\}$\n- $a_3(C) = k_3C \\implies \\mathcal{R}_3 = \\{C\\}$\n- $a_4(G) = k_4G \\implies \\mathcal{R}_4 = \\{G\\}$\n- $a_5(M) = k_5M \\implies \\mathcal{R}_5 = \\{M\\}$\n- $a_6(M) = k_6M \\implies \\mathcal{R}_6 = \\{M\\}$\n- $a_7(P) = k_7P \\implies \\mathcal{R}_7 = \\{P\\}$\n- $a_8(P) = k_8P \\implies \\mathcal{R}_8 = \\{P\\}$\n- $a_9(T) = k_9T \\implies \\mathcal{R}_9 = \\{T\\}$\n\n现在，我们通过检查所有对 $(i,j)$ 的条件 $\\mathcal{U}_i \\cap \\mathcal{R}_j \\neq \\emptyset$ 来构建图：\n- **$R_1$ 发生 ($\\mathcal{U}_1 = \\{G, T, C\\}$):**\n  - $\\mathcal{U}_1 \\cap \\mathcal{R}_1 = \\{G, T\\} \\neq \\emptyset \\implies R_1 \\to R_1$\n  - $\\mathcal{U}_1 \\cap \\mathcal{R}_2 = \\{C\\} \\neq \\emptyset \\implies R_1 \\to R_2$\n  - $\\mathcal{U}_1 \\cap \\mathcal{R}_3 = \\{C\\} \\neq \\emptyset \\implies R_1 \\to R_3$\n  - $\\mathcal{U}_1 \\cap \\mathcal{R}_4 = \\{G\\} \\neq \\emptyset \\implies R_1 \\to R_4$\n  - $\\mathcal{U}_1 \\cap \\mathcal{R}_9 = \\{T\\} \\neq \\emptyset \\implies R_1 \\to R_9$\n  - 其他交集为空。\n  - $R_1$ 的依赖项: $\\{R_1, R_2, R_3, R_4, R_9\\}$。\n\n- **$R_2$ 发生 ($\\mathcal{U}_2 = \\{G, T, C\\}$):** 与 $R_1$ 相同。$R_2$ 的依赖项: $\\{R_1, R_2, R_3, R_4, R_9\\}$。\n\n- **$R_3$ 发生 ($\\mathcal{U}_3 = \\{M\\}$):**\n  - $\\mathcal{U}_3 \\cap \\mathcal{R}_5 = \\{M\\} \\neq \\emptyset \\implies R_3 \\to R_5$\n  - $\\mathcal{U}_3 \\cap \\mathcal{R}_6 = \\{M\\} \\neq \\emptyset \\implies R_3 \\to R_6$\n  - $R_3$ 的依赖项: $\\{R_5, R_6\\}$。\n\n- **$R_4$ 发生 ($\\mathcal{U}_4 = \\{M\\}$):** 与 $R_3$ 相同。$R_4$ 的依赖项: $\\{R_5, R_6\\}$。\n- **$R_5$ 发生 ($\\mathcal{U}_5 = \\{M\\}$):** 与 $R_3$ 相同。$R_5$ 的依赖项: $\\{R_5, R_6\\}$。\n\n- **$R_6$ 发生 ($\\mathcal{U}_6 = \\{P\\}$):**\n  - $\\mathcal{U}_6 \\cap \\mathcal{R}_7 = \\{P\\} \\neq \\emptyset \\implies R_6 \\to R_7$\n  - $\\mathcal{U}_6 \\cap \\mathcal{R}_8 = \\{P\\} \\neq \\emptyset \\implies R_6 \\to R_8$\n  - $R_6$ 的依赖项: $\\{R_7, R_8\\}$。\n\n- **$R_7$ 发生 ($\\mathcal{U}_7 = \\{P\\}$):** 与 $R_6$ 相同。$R_7$ 的依赖项: $\\{R_7, R_8\\}$。\n\n- **$R_8$ 发生 ($\\mathcal{U}_8 = \\{T\\}$):**\n  - $\\mathcal{U}_8 \\cap \\mathcal{R}_1 = \\{T\\} \\neq \\emptyset \\implies R_8 \\to R_1$\n  - $\\mathcal{U}_8 \\cap \\mathcal{R}_9 = \\{T\\} \\neq \\emptyset \\implies R_8 \\to R_9$\n  - $R_8$ 的依赖项: $\\{R_1, R_9\\}$。\n\n- **$R_9$ 发生 ($\\mathcal{U}_9 = \\{T\\}$):** 与 $R_8$ 相同。$R_9$ 的依赖项: $\\{R_1, R_9\\}$。\n\n依赖图由这些有向边集合完全确定。\n\n### 第3部分：$R_1$ 发生后需要重新计算的最小倾向性数量\n\n在反应 $R_i$ 单次发生后必须立即重新计算的不同倾向性的最小数量，对应于存在依赖边 $R_i \\to R_j$ 的反应 $R_j$ 的数量。这就是依赖图中节点 $R_i$ 的出度。\n\n从第2部分，我们确定了倾向性受 $R_1$ 发生影响的反应集合。当 $R_1$ 发生时，$G$、$T$ 和 $C$ 的物种数量发生变化 ($\\mathcal{U}_1 = \\{G, T, C\\}$)。我们必须重新计算任何以 $G$、$T$ 或 $C$ 为反应物的反应 $R_j$ 的倾向性。\n\n倾向性依赖于这些物种的反应是：\n1.  $R_1$: 倾向性 $a_1$ 依赖于 $G$ 和 $T$。\n2.  $R_2$: 倾向性 $a_2$ 依赖于 $C$。\n3.  $R_3$: 倾向性 $a_3$ 依赖于 $C$。\n4.  $R_4$: 倾向性 $a_4$ 依赖于 $G$。\n5.  $R_9$: 倾向性 $a_9$ 依赖于 $T$。\n\n倾向性 $a_5, a_6, a_7, a_8$ 依赖于 $M$ 和 $P$，它们的数量不受 $R_1$ 影响。因此，这些倾向性不发生变化，也无需重新计算。\n\n需要重新计算的倾向性索引集合是 $\\{1, 2, 3, 4, 9\\}$。每个 $a_j$ 是一个不同反应通道的不同倾向性。必须重新计算的不同倾向性的最小数量是该集合的大小。\n数量是 $5$。",
            "answer": "$$\\boxed{5}$$"
        }
    ]
}