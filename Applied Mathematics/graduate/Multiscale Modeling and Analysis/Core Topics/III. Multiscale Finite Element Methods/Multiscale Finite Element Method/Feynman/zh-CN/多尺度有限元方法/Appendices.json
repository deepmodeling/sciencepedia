{
    "hands_on_practices": [
        {
            "introduction": "这个基础练习将引导我们从第一性原理出发，在一个简化的一维环境中推导多尺度有限元（MsFEM）基函数。通过这个过程，我们将清晰地看到材料的微观结构信息（即变化的系数 $A(x)$）是如何被直接编码到基函数的形状中的。这正是多尺度基函数与标准的、对材料“无知”的基函数的核心区别。",
            "id": "3784497",
            "problem": "考虑一个散度形式的标量一维二阶椭圆问题，其在细尺度$\\epsilon$上具有快速变化的扩散系数：对于一个足够光滑的函数$u$，其算子由 $-\\frac{d}{dx}\\left(A(x)\\frac{du}{dx}\\right)$ 给出。在一个长度为$H>0$的单个粗有限元区间$K=[0,H]$上，假设系数$A(x)$是分段常数，在$x=\\theta H$处有一个细尺度界面，其中$0<\\theta<1$。具体来说，令当$x\\in[0,\\theta H]$时$A(x)=a_{1}>0$，当$x\\in(\\theta H,H]$时$A(x)=a_{2}>0$。\n\n将与左侧粗节点$x=0$相关联的多尺度有限元方法(MsFEM)基函数$\\phi(x)$定义为满足以下齐次局部单元问题的唯一函数$\\phi\\in H^{1}(K)$：\n$$\n-\\frac{d}{dx}\\left(A(x)\\frac{d\\phi}{dx}\\right)=0\\quad\\text{for }x\\in(0,H),\n$$\n其粗网格边界条件为\n$$\n\\phi(0)=1,\\quad \\phi(H)=0.\n$$\n相比之下，与$x=0$相关联的、$K$上的标准线性有限元基函数$\\hat{\\phi}(x)$定义为\n$$\n\\hat{\\phi}(x)=1-\\frac{x}{H}.\n$$\n\n从上述微分算子和边界条件出发，推导出MsFEM基函数$\\phi(x)$在$[0,H]$上的显式分段公式。然后，通过计算比率$R$来量化$\\phi$和$\\hat{\\phi}$之间的差异：\n$$\nR=\\frac{E_{\\mathrm{lin}}}{E_{\\mathrm{ms}}},\n$$\n其中函数$v$的$A$加权能量为\n$$\nE[v]=\\int_{0}^{H}A(x)\\left(\\frac{dv}{dx}\\right)^{2}\\,dx,\n$$\n且$E_{\\mathrm{lin}}=E[\\hat{\\phi}]$, $E_{\\mathrm{ms}}=E[\\phi]$。将$R$表示为以$a_{1}$、$a_{2}$和$\\theta$表示的闭式解析表达式。不需要进行数值近似或舍入。请给出$R$作为最终答案。",
            "solution": "用户提供了一个来自数值分析领域的有效问题陈述，具体涉及多尺度有限元方法(MsFEM)。该问题是自洽的，具有科学依据，且是适定的。我将进行完整的推导。\n\n此任务包含两个部分：第一，推导在粗单元$K=[0,H]$上与节点$x=0$相关联的MsFEM基函数$\\phi(x)$的显式公式；第二，计算比率$R = \\frac{E_{\\mathrm{lin}}}{E_{\\mathrm{ms}}}$，其中$E_{\\mathrm{lin}}$和$E_{\\mathrm{ms}}$分别是标准线性基函数$\\hat{\\phi}(x)$和MsFEM基函数$\\phi(x)$的$A$加权能量。\n\n**第1部分：MsFEM基函数$\\phi(x)$的推导**\n\nMsFEM基函数$\\phi(x)$由区间$K=(0,H)$上的齐次局部问题定义：\n$$\n-\\frac{d}{dx}\\left(A(x)\\frac{d\\phi}{dx}\\right)=0\n$$\n边界条件为$\\phi(0)=1$和$\\phi(H)=0$。系数$A(x)$是分段常数：\n$$\nA(x) = \\begin{cases} a_1  &\\text{for } x \\in [0, \\theta H] \\\\ a_2  &\\text{for } x \\in (\\theta H, H] \\end{cases}\n$$\n其中$a_1 > 0$，$a_2 > 0$且$0  \\theta  1$。\n\n将微分方程对$x$积分一次可得：\n$$\n-A(x)\\frac{d\\phi}{dx} = C_0\n$$\n其中$C_0$是一个积分常数。这个被称为通量(flux)的物理量在整个区域$[0,H]$上是恒定的。由此，我们可以将$\\phi(x)$的导数表示为：\n$$\n\\frac{d\\phi}{dx} = -\\frac{C_0}{A(x)}\n$$\n由于$A(x)$是分段常数，所以$\\frac{d\\phi}{dx}$也是。我们可以在两个子区间上对此表达式进行积分：\n对于$x \\in [0, \\theta H]$，其中$A(x) = a_1$：\n$$\n\\phi(x) = \\int -\\frac{C_0}{a_1} dx = -\\frac{C_0}{a_1}x + C_1\n$$\n对于$x \\in [\\theta H, H]$，其中$A(x) = a_2$：\n$$\n\\phi(x) = \\int -\\frac{C_0}{a_2} dx = -\\frac{C_0}{a_2}x + C_2\n$$\n函数$\\phi(x)$必须属于索博列夫空间$H^1(K)$，这意味着$\\phi(x)$在$[0,H]$上是连续的。我们有三个未知常数（$C_0, C_1, C_2$）和三个条件来确定它们：两个边界条件以及在界面$x=\\theta H$处的连续性条件。\n\n1.  在$x=0$处的边界条件：$\\phi(0)=1$。\n    $ \\phi(0) = -\\frac{C_0}{a_1}(0) + C_1 = 1 \\implies C_1 = 1$。\n    因此，对于$x \\in [0, \\theta H]$，$\\phi(x) = 1 - \\frac{C_0}{a_1}x$。\n\n2.  在$x=H$处的边界条件：$\\phi(H)=0$。\n    $\\phi(H) = -\\frac{C_0}{a_2}(H) + C_2 = 0 \\implies C_2 = \\frac{C_0 H}{a_2}$。\n    因此，对于$x \\in [\\theta H, H]$，$\\phi(x) = -\\frac{C_0}{a_2}x + \\frac{C_0 H}{a_2} = \\frac{C_0}{a_2}(H-x)$。\n\n3.  在$x=\\theta H$处的连续性：$\\phi(\\theta H^-) = \\phi(\\theta H^+)$。\n    $$\n    1 - \\frac{C_0}{a_1}(\\theta H) = \\frac{C_0}{a_2}(H - \\theta H)\n    $$\n    我们求解$C_0$：\n    $$\n    1 = C_0 \\left( \\frac{\\theta H}{a_1} + \\frac{(1-\\theta)H}{a_2} \\right) = C_0 H \\left( \\frac{\\theta}{a_1} + \\frac{1-\\theta}{a_2} \\right)\n    $$\n    $$\n    1 = C_0 H \\left( \\frac{\\theta a_2 + (1-\\theta)a_1}{a_1 a_2} \\right)\n    $$\n    $$\n    C_0 = \\frac{1}{H} \\frac{a_1 a_2}{\\theta a_2 + (1-\\theta)a_1}\n    $$\n将$C_0$代回，得到$\\phi(x)$的显式公式：\n对于$x \\in [0, \\theta H]$：\n$$\n\\phi(x) = 1 - \\frac{1}{a_1} \\left( \\frac{1}{H} \\frac{a_1 a_2}{\\theta a_2 + (1-\\theta)a_1} \\right) x = 1 - \\frac{a_2 x}{H(\\theta a_2 + (1-\\theta)a_1)}\n$$\n对于$x \\in (\\theta H, H]$：\n$$\n\\phi(x) = \\frac{1}{a_2} \\left( \\frac{1}{H} \\frac{a_1 a_2}{\\theta a_2 + (1-\\theta)a_1} \\right) (H-x) = \\frac{a_1 (H-x)}{H(\\theta a_2 + (1-\\theta)a_1)}\n$$\n这给出了MsFEM基函数$\\phi(x)$的完整分段定义。\n\n**第2部分：能量比$R$的计算**\n\n$A$加权能量定义为$E[v] = \\int_{0}^{H}A(x)\\left(\\frac{dv}{dx}\\right)^{2}\\,dx$。\n\n首先，我们计算MsFEM基函数的能量，$E_{\\mathrm{ms}} = E[\\phi]$。其导数$\\frac{d\\phi}{dx} = -\\frac{C_0}{A(x)}$是分段常数：\n$$\n\\frac{d\\phi}{dx} = \\begin{cases}\n-\\frac{C_0}{a_1} = -\\frac{a_2}{H(\\theta a_2 + (1-\\theta)a_1)}  \\text{for } x \\in (0, \\theta H) \\\\\n-\\frac{C_0}{a_2} = -\\frac{a_1}{H(\\theta a_2 + (1-\\theta)a_1)}  \\text{for } x \\in (\\theta H, H)\n\\end{cases}\n$$\n令分母为$D = H(\\theta a_2 + (1-\\theta)a_1)$。\n$$\nE_{\\mathrm{ms}} = \\int_{0}^{\\theta H} a_1 \\left( -\\frac{a_2}{D} \\right)^2 dx + \\int_{\\theta H}^{H} a_2 \\left( -\\frac{a_1}{D} \\right)^2 dx\n$$\n$$\nE_{\\mathrm{ms}} = a_1 \\frac{a_2^2}{D^2} (\\theta H) + a_2 \\frac{a_1^2}{D^2} (H-\\theta H) = \\frac{H}{D^2} (a_1 a_2^2 \\theta + a_2 a_1^2 (1-\\theta))\n$$\n$$\nE_{\\mathrm{ms}} = \\frac{H a_1 a_2}{D^2} (a_2 \\theta + a_1 (1-\\theta))\n$$\n代入$D = H(\\theta a_2 + (1-\\theta)a_1)$，我们得到：\n$$\nE_{\\mathrm{ms}} = \\frac{H a_1 a_2}{H^2 (\\theta a_2 + (1-\\theta)a_1)^2} (a_2 \\theta + a_1 (1-\\theta)) = \\frac{a_1 a_2}{H(\\theta a_2 + (1-\\theta)a_1)}\n$$\n\n接下来，我们计算标准线性基函数的能量，$E_{\\mathrm{lin}} = E[\\hat{\\phi}]$。\n给定$\\hat{\\phi}(x) = 1 - \\frac{x}{H}$，其导数是常数：$\\frac{d\\hat{\\phi}}{dx} = -\\frac{1}{H}$。\n$$\nE_{\\mathrm{lin}} = \\int_{0}^{H} A(x) \\left( -\\frac{1}{H} \\right)^2 dx = \\frac{1}{H^2} \\int_{0}^{H} A(x) dx\n$$\n$A(x)$的积分为：\n$$\n\\int_{0}^{H} A(x) dx = \\int_{0}^{\\theta H} a_1 dx + \\int_{\\theta H}^{H} a_2 dx = a_1(\\theta H) + a_2(H-\\theta H) = H(a_1\\theta + a_2(1-\\theta))\n$$\n将此代回$E_{\\text{lin}}$的表达式中：\n$$\nE_{\\mathrm{lin}} = \\frac{1}{H^2} \\left[ H(a_1\\theta + a_2(1-\\theta)) \\right] = \\frac{a_1\\theta + a_2(1-\\theta)}{H}\n$$\n\n最后，我们计算比率$R = \\frac{E_{\\mathrm{lin}}}{E_{\\mathrm{ms}}}$：\n$$\nR = \\frac{\\frac{a_1\\theta + a_2(1-\\theta)}{H}}{\\frac{a_1 a_2}{H(\\theta a_2 + (1-\\theta)a_1)}}\n$$\n$$\nR = \\frac{a_1\\theta + a_2(1-\\theta)}{H} \\cdot \\frac{H(\\theta a_2 + (1-\\theta)a_1)}{a_1 a_2}\n$$\n$$\nR = \\frac{(a_1\\theta + a_2(1-\\theta))(\\theta a_2 + (1-\\theta)a_1)}{a_1 a_2}\n$$\n此表达式也可以写成系数的加权算术平均值与它们的加权调和平均值的倒数之积：\n$$\nR = (a_1\\theta + a_2(1-\\theta)) \\left(\\frac{\\theta}{a_1} + \\frac{1-\\theta}{a_2}\\right)\n$$\n问题要求一个以$a_1$、$a_2$和$\\theta$表示的闭式表达式。推导出的表达式符合要求的形式。",
            "answer": "$$\n\\boxed{\\frac{(a_1\\theta + a_2(1-\\theta))(a_1(1-\\theta) + a_2\\theta)}{a_1 a_2}}\n$$"
        },
        {
            "introduction": "在解析推导的基础上，这个实践将我们带入计算领域。您将实现多尺度有限元方法（MsFEM）的核心工作流程：为更复杂的材料属性数值化地计算基函数，并利用它们来组装全局刚度矩阵和力向量。这个练习将弥合理论理解与实际应用之间的鸿沟，为解决更真实的多尺度问题做好准备。",
            "id": "3733626",
            "problem": "给定一个在域 $[0,1]$ 上，使用双单元粗网格的一维非均匀扩散问题。目标是在每个粗单元上计算局部的多尺度有限元法（MsFEM）基函数，并组装相应的全局刚度矩阵和全局力向量。扩散系数 $a(x)  0$ 是非均匀的，并随位置变化，源项为 $f(x)$。所有物理量均为无量纲。\n\n从散度形式的扩散方程 $-\\frac{d}{dx}\\left(a(x)\\frac{du}{dx}\\right)=f(x)$ 和多尺度有限元法（MsFEM）的定义出发。对于每个粗单元 $E=[x_i,x_{i+1}]$，通过求解局部单元问题来定义两个局部基函数 $\\phi_{i}^{E}(x)$ 和 $\\phi_{i+1}^{E}(x)$\n$$\n-\\frac{d}{dx}\\left(a(x)\\frac{d\\phi}{dx}\\right)=0 \\quad \\text{for } x\\in E,\n$$\n其狄利克雷（Dirichlet）边界条件与 $E$ 边界上的标准分段线性节点基函数相匹配：\n$$\n\\phi_{i}^{E}(x_i)=1,\\quad \\phi_{i}^{E}(x_{i+1})=0,\\quad \\phi_{i+1}^{E}(x_i)=0,\\quad \\phi_{i+1}^{E}(x_{i+1})=1.\n$$\n使用这些局部基函数，单元刚度贡献定义为\n$$\nK^{E}_{mn}=\\int_{E} a(x)\\,\\frac{d\\phi_{m}^{E}}{dx}(x)\\,\\frac{d\\phi_{n}^{E}}{dx}(x)\\,dx,\n$$\n对于 $m,n\\in\\{i,i+1\\}$，单元力贡献定义为\n$$\nF^{E}_{m}=\\int_{E} f(x)\\,\\phi_{m}^{E}(x)\\,dx.\n$$\n全局刚度矩阵 $K\\in\\mathbb{R}^{3\\times 3}$ 和全局力向量 $F\\in\\mathbb{R}^{3}$ 是通过在两个粗单元 $[0,0.5]$ 和 $[0.5,1]$ 上进行组装得到的，全局节点位于 $x_0=0$、$x_1=0.5$ 和 $x_2=1$。\n\n您的任务是实现一个数值程序来：\n- 如上所述，在每个粗单元上求解局部单元问题，以获得 MsFEM 基函数 $\\phi_{i}^{E}$ 和 $\\phi_{i+1}^{E}$，\n- 通过数值积分计算单元刚度贡献 $K^{E}_{mn}$ 和单元力贡献 $F^{E}_{m}$，\n- 组装全局刚度矩阵 $K$ 和全局力向量 $F$。\n\n数值积分要求：\n- 在每个粗单元上使用包含两个端点的 $N=4097$ 个点的均匀细网格，并对每个单元上的所有积分使用复合梯形法则。\n\n测试套件：\n为以下三个测试用例计算并组装 $K$ 和 $F$。在每个用例中，粗网格如上所述是固定的，您必须使用指定的 $a(x)$ 和 $f(x)$ 执行局部的 MsFEM 基函数计算和组装。\n\n- 测试用例 1（平滑非均匀性）：\n  - 扩散系数：$a(x)=1+0.5\\sin(10\\pi x)$。\n  - 源项：$f(x)=x$。\n\n- 测试用例 2（不连续，跨单元高对比度）：\n  - 扩散系数：\n    $$\n    a(x)=\n    \\begin{cases}\n    1,  0\\le x\\le 0.5,\\\\\n    10,  0.5  x\\le 1.\n    \\end{cases}\n    $$\n  - 源项：$f(x)=1$。\n\n- 测试用例 3（强振荡微结构）：\n  - 扩散系数：$a(x)=\\exp\\big(3\\sin(100\\pi x)\\big)$。\n  - 源项：$f(x)=\\sin(2\\pi x)$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含所有测试用例的结果，形式为方括号括起来的逗号分隔列表。每个测试用例的结果本身必须是一个双元素列表，包含：\n- 全局刚度矩阵 $K$ 按行主序展平为一个包含 $9$ 个浮点数的列表，\n- 全局力向量 $F$ 作为一个包含 $3$ 个浮点数的列表。\n\n因此，总输出必须是以下形式的单行\n$$\n[\\,[K^{(1)}\\text{-flat},F^{(1)}],\\,[K^{(2)}\\text{-flat},F^{(2)}],\\,[K^{(3)}\\text{-flat},F^{(3)}]\\,],\n$$\n其中 $K^{(t)}\\text{-flat}$ 表示测试用例 $t$ 的全局刚度矩阵的行主序展平形式，$F^{(t)}$ 表示相应的全局力向量。不应打印任何额外文本。",
            "solution": "用户提供的问题是有效的。它在科学上基于数值分析和有限元法的原理，特别是多尺度有限元法（MsFEM）。这是一个适定问题，提供了所有必要的定义、数据和数值参数，以确保可以计算出唯一、稳定且有意义的解。问题陈述是客观的、无歧义的，并且可以形式化为一个直接的计算任务。所提供的测试用例是多尺度方法的标准基准，旨在测试算法针对不同类型系数非均匀性的鲁棒性。该问题是自洽的且内部一致的。\n\n任务是使用 MsFEM 在一个双单元粗网格上，为一个一维扩散问题计算全局刚度矩阵 $K$ 和全局力向量 $F$。该过程包括在每个粗单元上求解局部问题以找到专门的基函数，然后使用这些基函数计算单元矩阵和向量，最后将它们组装成全局系统。\n\n控制方程是散度形式的稳态扩散方程：\n$$\n-\\frac{d}{dx}\\left(a(x)\\frac{du}{dx}\\right) = f(x), \\quad x \\in [0, 1]\n$$\n其中 $a(x)  0$ 是非均匀扩散系数，$f(x)$ 是源项。\n\nMsFEM 框架在粗网格上寻求一个近似解 $u_H(x)$。该解是全局多尺度基函数的线性组合，而这些全局基函数是由定义在每个粗单元 $E$ 上的局部基函数构建的。对于一个一维单元 $E=[x_i, x_{i+1}]$，我们定义两个局部基函数 $\\phi_i^E(x)$ 和 $\\phi_{i+1}^E(x)$。这些函数是通过在单元内求解控制偏微分方程（PDE）的局部齐次版本获得的：\n$$\n-\\frac{d}{dx}\\left(a(x)\\frac{d\\phi}{dx}\\right) = 0, \\quad x \\in E\n$$\n指定的边界条件旨在匹配标准线性 Lagrange 基函数在单元节点处的行为。具体而言：\n- 对于 $\\phi_i^E(x)$：$\\phi_i^E(x_i)=1$ 且 $\\phi_i^E(x_{i+1})=0$。\n- 对于 $\\phi_{i+1}^E(x)$：$\\phi_{i+1}^E(x_i)=0$ 且 $\\phi_{i+1}^E(x_{i+1})=1$。\n\n为了找到这些基函数的解析形式，我们可以对局部单元方程积分两次。第一次积分得到：\n$$\na(x)\\frac{d\\phi}{dx} = C_1\n$$\n其中 $C_1$ 是一个积分常数。这意味着 $\\frac{d\\phi}{dx} = \\frac{C_1}{a(x)}$。第二次积分给出：\n$$\n\\phi(x) = \\int_{x_i}^{x} \\frac{C_1}{a(t)} dt + C_2\n$$\n常数 $C_1$ 和 $C_2$ 由每个基函数的边界条件确定。\n\n对于 $\\phi_{i+1}^E(x)$，其边界条件为 $\\phi_{i+1}^E(x_i)=0$ 和 $\\phi_{i+1}^E(x_{i+1})=1$：\n- 在 $x=x_i$ 处：$\\phi_{i+1}^E(x_i) = \\int_{x_i}^{x_i} \\frac{C_1}{a(t)} dt + C_2 = 0 + C_2 = 0 \\implies C_2=0$。\n- 在 $x=x_{i+1}$ 处：$\\phi_{i+1}^E(x_{i+1}) = C_1 \\int_{x_i}^{x_{i+1}} \\frac{1}{a(t)} dt = 1 \\implies C_1 = \\frac{1}{\\int_{x_i}^{x_{i+1}} \\frac{1}{a(t)} dt}$。\n因此，$\\phi_{i+1}^E(x)$ 的表达式为：\n$$\n\\phi_{i+1}^E(x) = \\frac{\\int_{x_i}^{x} \\frac{1}{a(t)} dt}{\\int_{x_i}^{x_{i+1}} \\frac{1}{a(t)} dt}\n$$\n对 $\\phi_i^E(x)$ 进行类似的推导表明，它满足单位分解性质，即 $\\phi_i^E(x) + \\phi_{i+1}^E(x) = 1$。因此：\n$$\n\\phi_i^E(x) = 1 - \\phi_{i+1}^E(x) = 1 - \\frac{\\int_{x_i}^{x} \\frac{1}{a(t)} dt}{\\int_{x_i}^{x_{i+1}} \\frac{1}{a(t)} dt}\n$$\n其导数为：\n$$\n\\frac{d\\phi_{i+1}^E}{dx}(x) = \\frac{1/a(x)}{\\int_{x_i}^{x_{i+1}} \\frac{1}{a(t)} dt}, \\quad \\text{and} \\quad \\frac{d\\phi_i^E}{dx}(x) = -\\frac{d\\phi_{i+1}^E}{dx}(x)\n$$\n利用这些基函数，单元刚度矩阵 $K^E$ 和力向量 $F^E$ 由以下积分定义：\n$$\nK^{E}_{mn} = \\int_{E} a(x)\\,\\frac{d\\phi_{m}^{E}}{dx}(x)\\,\\frac{d\\phi_{n}^{E}}{dx}(x)\\,dx, \\quad \\text{for } m,n \\in \\{i, i+1\\}\n$$\n$$\nF^{E}_{m} = \\int_{E} f(x)\\,\\phi_{m}^{E}(x)\\,dx, \\quad \\text{for } m \\in \\{i, i+1\\}\n$$\n对于刚度矩阵，可以得到一个关键的简化。令 $I_E = \\int_{x_i}^{x_{i+1}} \\frac{1}{a(t)} dt$。$K^E$ 的各项变为：\n$$\nK^E_{i+1,i+1} = \\int_{x_i}^{x_{i+1}} a(x) \\left( \\frac{1/a(x)}{I_E} \\right)^2 dx = \\frac{1}{I_E^2} \\int_{x_i}^{x_{i+1}} \\frac{1}{a(x)} dx = \\frac{I_E}{I_E^2} = \\frac{1}{I_E}\n$$\n由于导数之间的关系，$K^E_{i,i} = K^E_{i+1,i+1}$ 且 $K^E_{i,i+1} = -K^E_{i+1,i+1}$。这得到了一个对称的单元刚度矩阵：\n$$\nK^E = \\frac{1}{\\int_E \\frac{1}{a(x)} dx}\n\\begin{pmatrix}\n1  -1 \\\\\n-1  1\n\\end{pmatrix}\n$$\n\n对于每个粗单元 $E = [x_i, x_{i+1}]$，数值实现过程如下：\n1.  在 $E$ 上建立一个包含 $N=4097$ 个点的均匀细网格。\n2.  在细网格的每个点上计算函数 $a(x)$ 和 $f(x)$ 的值。\n3.  使用复合梯形法则，根据 $1/a(x)$ 在细网格上的值来计算积分 $I_E = \\int_E (1/a(x)) dx$。\n4.  使用上面推导的简化公式计算单元刚度矩阵 $K^E$。尽管我们推导出了这个简化形式，但实现将计算完整的积分，以严格遵守提示中计算 $a(x)(d\\phi/dx)^2$ 积分的指令，这会得到相同的结果。\n5.  为了计算单元力向量 $F^E$，必须首先在细网格上计算基函数 $\\phi_m^E(x)$ 的值。这需要为细网格上的所有点 $x$ 计算累积积分 $I(x) = \\int_{x_i}^x (1/a(t)) dt$，这一步使用 `scipy.integrate.cumulative_trapezoid` 完成。\n6.  然后使用 $\\phi_m^E(x)$ 的值构成被积函数 $f(x)\\phi_m^E(x)$，再通过复合梯形法则进行数值积分，以获得 $F^E$ 的各项。\n\n7. 最后，组装全局刚度矩阵 $K \\in \\mathbb{R}^{3 \\times 3}$ 和力向量 $F \\in \\mathbb{R}^3$。粗网格由单元 $E_1 = [0, 0.5]$ 和 $E_2 = [0.5, 1]$ 组成，全局节点位于 $x_0=0$、$x_1=0.5$ 和 $x_2=1$。\n- 来自 $E_1$（节点 0, 1）的局部贡献被加到 $K$ 和 $F$ 中对应全局索引 $(0,1)$ 的项上。\n- 来自 $E_2$（节点 1, 2）的局部贡献被加到 $K$ 和 $F$ 中对应全局索引 $(1,2)$ 的项上。\n中心节点 $x_1=0.5$ 接收来自两个单元的贡献。这个标准的组装过程产生了最终的全局系统。以下代码为三个指定的测试用例实现了这一逻辑。",
            "answer": "```python\nimport numpy as np\nimport scipy.integrate\nimport json\n\ndef solve():\n    \"\"\"\n    Computes the MsFEM global stiffness matrix and force vector for three test cases.\n    \"\"\"\n\n    # Define test cases as a list of dictionaries with coefficient functions\n    test_cases = [\n        {\n            \"a\": lambda x: 1.0 + 0.5 * np.sin(10.0 * np.pi * x),\n            \"f\": lambda x: x,\n        },\n        {\n            \"a\": lambda x: np.piecewise(x, [x = 0.5, x > 0.5], [1.0, 10.0]),\n            \"f\": lambda x: np.ones_like(x), # Use np.ones_like to handle array inputs\n        },\n        {\n            \"a\": lambda x: np.exp(3.0 * np.sin(100.0 * np.pi * x)),\n            \"f\": lambda x: np.sin(2.0 * np.pi * x),\n        },\n    ]\n\n    # Global parameters defined in the problem\n    coarse_elements = [(0.0, 0.5), (0.5, 1.0)]\n    num_fine_points = 4097\n    \n    all_results = []\n\n    for case in test_cases:\n        a_func = case[\"a\"]\n        f_func = case[\"f\"]\n        \n        # Initialize global stiffness matrix and force vector\n        K_global = np.zeros((3, 3))\n        F_global = np.zeros(3)\n\n        # Loop over the coarse elements to compute local contributions\n        for i, (x_start, x_end) in enumerate(coarse_elements):\n            # 1. Define the uniform fine grid for the current element\n            x_fine = np.linspace(x_start, x_end, num_fine_points)\n            \n            # 2. Evaluate coefficients a(x) and f(x) on the fine grid\n            a_vals = a_func(x_fine)\n            f_vals = f_func(x_fine)\n\n            # 3. Compute integral of 1/a(x), the key quantity for basis functions\n            inv_a_vals = 1.0 / a_vals\n            integral_inv_a_total = np.trapz(inv_a_vals, x_fine)\n\n            # 4. Compute element stiffness matrix K_elem\n            # Derivatives of basis functions on the fine grid\n            dphi_0_dx_vals = -inv_a_vals / integral_inv_a_total  # Corresponds to left node\n            dphi_1_dx_vals =  inv_a_vals / integral_inv_a_total  # Corresponds to right node\n            \n            # Integrands for stiffness matrix entries\n            integrand_K00 = a_vals * dphi_0_dx_vals * dphi_0_dx_vals\n            integrand_K01 = a_vals * dphi_0_dx_vals * dphi_1_dx_vals\n            integrand_K11 = a_vals * dphi_1_dx_vals * dphi_1_dx_vals\n\n            # Compute stiffness entries via numerical quadrature (trapezoidal rule)\n            k00 = np.trapz(integrand_K00, x_fine)\n            k01 = np.trapz(integrand_K01, x_fine)\n            k11 = np.trapz(integrand_K11, x_fine)\n            K_elem = np.array([[k00, k01], [k01, k11]])\n\n            # 5. Compute MsFEM basis functions phi_0 and phi_1 on the element\n            # Numerically evaluate the cumulative integral of 1/a(t)\n            integral_inv_a_cumulative = scipy.integrate.cumulative_trapezoid(inv_a_vals, x_fine, initial=0)\n            \n            # Evaluate basis functions on the fine grid\n            phi_0_vals = 1.0 - integral_inv_a_cumulative / integral_inv_a_total\n            phi_1_vals = integral_inv_a_cumulative / integral_inv_a_total\n\n            # 6. Compute element force vector F_elem\n            # Integrands for force vector entries\n            integrand_F0 = f_vals * phi_0_vals\n            integrand_F1 = f_vals * phi_1_vals\n\n            # Compute force entries via numerical quadrature\n            f0 = np.trapz(integrand_F0, x_fine)\n            f1 = np.trapz(integrand_F1, x_fine)\n            F_elem = np.array([f0, f1])\n\n            # 7. Assemble local contributions into the global system\n            # Element `i` connects global nodes `i` and `i+1`\n            global_indices = np.array([i, i + 1])\n            # Use np.ix_ for elegant submatrix indexing\n            ix = np.ix_(global_indices, global_indices)\n            K_global[ix] += K_elem\n            F_global[global_indices] += F_elem\n\n        # Store the results for the current test case\n        K_flat = K_global.flatten().tolist()\n        F_list = F_global.tolist()\n        all_results.append([K_flat, F_list])\n\n    # Format the final output string exactly as requested, without spaces\n    # json.dumps provides a compact, standard representation.\n    print(json.dumps(all_results, separators=(',', ':')))\n\nsolve()\n```"
        },
        {
            "introduction": "我们已经了解了多尺度有限元方法（MsFEM）的“是什么”和“如何做”，最后一个练习将探讨其“为什么”这个关键问题。通过分析一个经典的高对比度棋盘问题，我们将揭示标准有限元方法的固有缺陷，例如当计算网格过于粗糙以至于无法解析材料的精细尺度变化时，会出现“共振误差”和人为的各向异性。这个概念性练习旨在巩固发展多尺度方法的根本动机。",
            "id": "3784521",
            "problem": "考虑以下标量椭圆边值问题\n$$\n-\\nabla\\cdot\\big(A(x)\\nabla u(x)\\big)=f(x)\\quad\\text{in}\\quad \\Omega=(0,1)^2,\\qquad u(x)=0\\quad\\text{on}\\quad \\partial\\Omega,\n$$\n其中扩散系数 $A(x)$ 是一个高对比度的棋盘场，它在边长为 $\\epsilon$ 的方形单元上在两个正常数 $\\alpha$ 和 $\\beta$ 之间交替变化，其中 $0  \\epsilon\\ll 1$ 且 $\\beta/\\alpha\\gg 1$。假设在一个网格尺寸为 $H$ 的粗三角剖分上应用标准的协调 $P_1$ 有限元方法 (FEM)，满足 $H\\gg \\epsilon$，并假设精确数值积分。分片线性基函数没有编码关于 $A(x)$ 的任何微观尺度信息。\n\n根据椭圆算子的控制变分原理以及单元上 $P_1$ 有限元刚度项的定义，推断计算出的粗网格解 $u_h$ 的定性行为，以及由于未解析的 $\\epsilon$-尺度棋盘可能出现的与网格相关的伪影类型。特别地，讨论粗尺度 $H$、微观尺度 $\\epsilon$、对比度 $\\beta/\\alpha$ 以及网格方向之间的相互作用如何影响离散通量和表观有效属性。\n\n选择所有与此情景的第一性原理分析最一致的陈述。\n\nA. 在每个粗单元 $K$ 上，$P_1$ 有限元刚度使用 $A(x)$ 的单元算术平均值，产生一个离散算子，其作用类似于一个分片常数系数 $A_K=|K|^{-1}\\int_K A(x)\\,\\mathrm{d}x$。当 $\\alpha$ 和 $\\beta$ 的局部比例在单元之间变化时（如果 $H/\\epsilon$ 不是整数或网格未对齐，这种情况通常会发生），这会在 $u_h$ 中引起网格尺度的振荡，并可能产生伪各向异性和与均匀化极限相比不正确的有效电导率。\n\nB. 因为积分是精确的，并且 $P_1$ 基函数的梯度在单元上是常数，所以粗网格 $P_1$ 有限元方法在对比度 $\\beta/\\alpha$ 上一致地恢复了均匀化极限，并且与比率 $H/\\epsilon$ 无关；共振效应不会发生。\n\nC. 误差表现出与微观尺度的共振：它可能非单调地依赖于 $H/\\epsilon$ 以及粗网格相对于棋盘结构的方向，导致依赖于网格的振荡和人为的方向偏差。带过采样的多尺度有限元方法 (MsFEM) 通过构建在片区内部求解 $-\\nabla\\cdot\\big(A(x)\\nabla\\phi(x)\\big)=0$ 的局部基函数来减少这种共振，其中边界条件施加在远离单元边界的地方。\n\nD. 对于精确积分，该方法变得等同于用全局平均值 $|\\Omega|^{-1}\\int_{\\Omega}A(x)\\,\\mathrm{d}x$ 替换 $A(x)$，因此 $u_h$ 在粗尺度上是光滑的，不会发生单元尺度的振荡。\n\nE. 由于 $P_1$ 基函数在每个单元上强制梯度为常数，离散通量 $A(x)\\nabla u_h$ 受到人为约束，导致对高电导率通道的阻断或错误表示，以及在粗单元界面上出现类似边界层的跳跃。相关的建模误差随对比度 $\\beta/\\alpha$ 增长，并且除非 $H$ 解析 $\\epsilon$（或使用多尺度基函数来包含微观尺度），否则不会消失。\n\n选择所有适用的选项。",
            "solution": "我们从标量二阶椭圆问题的基本变分形式出发：求 $u\\in H_0^1(\\Omega)$ 使得\n$$\n\\int_{\\Omega} A(x)\\,\\nabla u(x)\\cdot \\nabla v(x)\\,\\mathrm{d}x = \\int_{\\Omega} f(x)\\,v(x)\\,\\mathrm{d}x\\quad\\text{for all}\\quad v\\in H_0^1(\\Omega).\n$$\n标准的协调 $P_1$ 有限元方法 (FEM) 在一个从属于网格尺寸为 $H$ 的粗三角剖分的分片线性子空间 $V_h\\subset H_0^1(\\Omega)$ 中寻找 $u_h$。对于剖分中的任何单元 $K$ 和局部节点基函数 $\\{\\varphi_i\\}$（其梯度 $\\nabla \\varphi_i$ 在 $K$ 上为常数），单元刚度矩阵项为\n$$\nk_{ij}^{(K)} = \\int_K A(x)\\,\\nabla \\varphi_i \\cdot \\nabla \\varphi_j\\,\\mathrm{d}x = \\big(\\nabla \\varphi_i \\cdot \\nabla \\varphi_j\\big)\\int_K A(x)\\,\\mathrm{d}x,\n$$\n假设使用精确积分。因为 $\\nabla \\varphi_i$ 在 $K$ 上是常数，非均匀系数 $A(x)$ 对 $k_{ij}^{(K)}$ 的唯一影响是通过单元积分 $\\int_K A(x)\\,\\mathrm{d}x$，即算术平均值 $A_K=|K|^{-1}\\int_K A(x)\\,\\mathrm{d}x$。因此，离散算子等价于一个将真实 $A(x)$ 替换为其单元算术平均值的单元分片常系数问题。\n\n在一个单元尺寸为 $\\epsilon$ 且 $H\\gg \\epsilon$ 的棋盘结构中，每个粗单元 $K$ 通常包含许多 $\\epsilon$-单元。$K$ 内 $\\alpha$ 与 $\\beta$ 的比例取决于粗网格如何与棋盘结构相交。如果 $H/\\epsilon$ 不是整数或网格与棋盘剖分未对齐，这个比例在不同单元间会发生变化。因此，$A_K$ 在粗尺度上波动，产生一个单元系数的拼凑图，从而在 $u_h$ 中引起网格尺度的振荡。即使 $H/\\epsilon$ 是整数且网格对齐，使得每个单元包含相同比例的 $\\alpha$ 和 $\\beta$，单元平均也得到算术平均值 $A_K\\approx \\tfrac{1}{2}(\\alpha+\\beta)$，这通常与棋盘复合材料的均匀化有效张量 $A^\\ast$ 不一致（在二维中，某些自对偶各向同性微结构的 $A^\\ast$ 更接近于几何平均值）。因此，粗网格 $P_1$ 有限元方法在有效属性上引入了建模误差，并通过 $A_K$ 的单元可变性引入了依赖于网格方向的伪影。\n\n共振效应源于微观尺度 $\\epsilon$ 和粗尺度 $H$ 的相互作用。因为试验空间无法表示由 $A(x)$ 在 $\\epsilon$ 尺度上引起的微观尺度边界层或 $\\nabla u$ 的振荡，伽辽金投影仅通过单元平均来采样 $A(x)$。由此产生的误差可能非单调地依赖于 $H/\\epsilon$ 以及粗网格相对于周期结构的方向，这种现象在多尺度数值方法中通常被称为共振。特别是，不同的对齐方式可能部分抵消或放大 $A_K$ 和 $A^\\ast$ 之间的不匹配，导致依赖于网格的振荡、伪各向异性（由网格引起的与方向相关的表观电导率），以及由于分片常数梯度与变化的 $A_K$ 相互作用，在单元界面上离散通量 $A(x)\\nabla u_h$ 出现人为的类似边界层的跳跃。\n\n多尺度有限元方法 (MsFEM) 通过用微观尺度信息丰富基函数来解决这些问题：局部基函数通过在单元或过采样片区上求解 $-\\nabla\\cdot\\big(A(x)\\nabla\\phi(x)\\big)=0$ 来计算，边界条件施加在单元边界或扩大的域上。过采样将边界约束移离单元边界，降低了对 $H/\\epsilon$ 的敏感性，从而抑制了共振伪影。\n\n我们现在分析每个选项：\n\nA. 该陈述准确反映了每个单元上梯度为常数的后果：$k_{ij}^{(K)}$ 对 $A(x)$ 的依赖仅通过 $\\int_K A(x)\\,\\mathrm{d}x$，即算术平均值。当 $\\alpha$ 和 $\\beta$ 的局部比例随 $K$ 变化时，$A_K$ 在粗尺度上变化并在 $u_h$ 中引起网格尺度的振荡。此外，算术平均通常会错误地表示均匀化有效属性，而未对齐会印上人为的各向异性。结论 — 正确。\n\nB. 精确积分并不能补偿试验空间中微观尺度分辨率的缺乏。该方法不能在对比度上一致地恢复均匀化极限，也不能独立于 $H/\\epsilon$。由于微观结构混叠到单元平均值中，共振可能并且确实会发生。结论 — 不正确。\n\nC. 这描述了共振现象：对 $H/\\epsilon$ 和方向的非单调依赖、依赖于网格的振荡以及人为的方向偏差。通过使用过采样和局部计算的 $A$-感知基函数的多尺度有限元方法 (MsFEM) 进行补救，与已建立的多尺度方法论一致。结论 — 正确。\n\nD. 单元刚度使用 $A(x)$ 的单元平均值，而不是全局平均值，因此该方法不等同于用 $|\\Omega|^{-1}\\int_{\\Omega}A(x)\\,\\mathrm{d}x$ 替换 $A(x)$。即使在每个单元比例相等的特殊情况下，虽然 $A_K$ 可能在各单元间保持不变，但由此产生的粗算子仍然错误地表示了均匀化极限，并且在一般的未对齐情况下，确实会发生单元尺度的振荡。结论 — 不正确。\n\nE. 因为 $\\nabla u_h$ 是分片常数，所以 $A(x)\\nabla u_h$ 仅通过每个单元内的 $A(x)$ 继承微观结构；这会约束通量，并可能阻断或错误表示需要 $\\nabla u$ 微观尺度变化的高电导率通道。单元间的不匹配在单元界面处产生类似边界层的特征。误差通常随对比度 $\\beta/\\alpha$ 增长，并且除非 $H$ 解析 $\\epsilon$ 或使用多尺度基函数，否则不会消失。结论 — 正确。\n\n因此，正确的选项是 A、C 和 E。",
            "answer": "$$\\boxed{ACE}$$"
        }
    ]
}