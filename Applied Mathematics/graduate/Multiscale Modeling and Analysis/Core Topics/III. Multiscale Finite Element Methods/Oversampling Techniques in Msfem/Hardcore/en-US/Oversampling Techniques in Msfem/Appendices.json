{
    "hands_on_practices": [
        {
            "introduction": "The effectiveness of oversampling is best understood by first examining what goes wrong without it. This exercise presents a simple one-dimensional scenario with a sharp material discontinuity, a classic source of error in multiscale methods. By analytically computing the multiscale basis function with naive boundary conditions and comparing it to an ideal one, you will directly quantify the spurious boundary layer effect that oversampling is designed to mitigate .",
            "id": "3790695",
            "problem": "Consider the scalar, second-order, linear elliptic model problem in one space dimension with discontinuous coefficient. Let the physical domain be $D=(0,1)$, and let the element of interest be $K=\\left(0,\\frac{1}{2}\\right)$. For a given oversampling width $\\delta \\in \\left(0,\\frac{1}{2}\\right)$, define the oversampling patch $U_{K}=\\left(0,\\frac{1}{2}+\\delta\\right)$. Let the coefficient $A(x)$ be discontinuous and piecewise constant, given by\n$$\nA(x)=\\begin{cases}\n1, & x \\in \\left(0,\\frac{1}{2}\\right),\\\\\n\\varepsilon, & x \\in \\left(\\frac{1}{2},\\frac{1}{2}+\\delta\\right),\n\\end{cases}\n$$\nwith a fixed contrast parameter $\\varepsilon \\in (0,1)$. In the Multiscale Finite Element Method (MsFEM), consider the local basis function on $U_{K}$ defined by the naive Dirichlet boundary conditions\n$$\n-(A(x)\\,\\psi^{\\mathrm{os}\\,'}(x))' = 0 \\text{ on } U_{K}, \\quad \\psi^{\\mathrm{os}}(0)=1, \\quad \\psi^{\\mathrm{os}}\\!\\left(\\tfrac{1}{2}+\\delta\\right)=0,\n$$\nand define its restriction to $K$ by $\\psi^{\\mathrm{os}}|_{K}$. Also define the ideal, non-oversampled local basis on $K$,\n$$\n-(A(x)\\,\\psi^{\\mathrm{id}\\,'}(x))' = 0 \\text{ on } K, \\quad \\psi^{\\mathrm{id}}(0)=1, \\quad \\psi^{\\mathrm{id}}\\!\\left(\\tfrac{1}{2}\\right)=0,\n$$\nwith $A(x)\\equiv 1$ on $K$. In one dimension, the stiffness contribution scales with the square of the constant gradient on $K$, and the restriction procedure uses $\\psi^{\\mathrm{os}}|_{K}$ directly.\n\nUsing only the fundamental properties of one-dimensional elliptic operators and the constancy of the flux in each subinterval where $A$ is constant, compute a closed-form expression for the ratio\n$$\nE(\\varepsilon,\\delta)\\equiv \\frac{\\psi^{\\mathrm{os}\\,'}(x)}{\\psi^{\\mathrm{id}\\,'}(x)} \\quad \\text{for any } x \\in K,\n$$\nwhich quantifies the spurious boundary layer influence that is not removed by restriction. Express your final answer as a simplified analytic expression in terms of $\\varepsilon$ and $\\delta$. No numerical evaluation is required and no units are involved.",
            "solution": "The user-provided problem is critically examined and found to be valid. It is scientifically grounded in the theory of elliptic partial differential equations and their numerical approximation by multiscale methods. The problem is well-posed, with a unique solution guaranteed by the specified boundary conditions for the one-dimensional, second-order ordinary differential equations. All data and definitions are provided, and there are no internal contradictions, ambiguities, or unrealistic assumptions. We may therefore proceed with the solution.\n\nThe objective is to compute the ratio $E(\\varepsilon,\\delta)\\equiv \\frac{\\psi^{\\mathrm{os}\\,'}(x)}{\\psi^{\\mathrm{id}\\,'}(x)}$ for $x \\in K = \\left(0,\\frac{1}{2}\\right)$. This requires finding the expressions for the gradients $\\psi^{\\mathrm{id}\\,'}(x)$ and $\\psi^{\\mathrm{os}\\,'}(x)$ on the interval $K$.\n\nFirst, we solve for the ideal basis function $\\psi^{\\mathrm{id}}(x)$ on the domain $K = \\left(0,\\frac{1}{2}\\right)$.\nThe governing equation is\n$$\n-(A(x)\\,\\psi^{\\mathrm{id}\\,'}(x))' = 0 \\quad \\text{on } K.\n$$\nOn the interval $K$, the coefficient is specified as $A(x)=1$. Thus, the equation simplifies to\n$$\n-\\psi^{\\mathrm{id}\\,''}(x) = 0.\n$$\nThe general solution to this equation is a linear function of $x$:\n$$\n\\psi^{\\mathrm{id}}(x) = c_1 x + c_2,\n$$\nwhere $c_1$ and $c_2$ are constants of integration. We determine these constants using the given boundary conditions: $\\psi^{\\mathrm{id}}(0)=1$ and $\\psi^{\\mathrm{id}}\\!\\left(\\frac{1}{2}\\right)=0$.\nApplying the first boundary condition at $x=0$:\n$$\n\\psi^{\\mathrm{id}}(0) = c_1(0) + c_2 = 1 \\implies c_2 = 1.\n$$\nApplying the second boundary condition at $x=\\frac{1}{2}$:\n$$\n\\psi^{\\mathrm{id}}\\!\\left(\\frac{1}{2}\\right) = c_1\\left(\\frac{1}{2}\\right) + 1 = 0 \\implies \\frac{c_1}{2} = -1 \\implies c_1 = -2.\n$$\nSo, the ideal basis function is $\\psi^{\\mathrm{id}}(x) = -2x + 1$ on $K$. The gradient is constant over this interval:\n$$\n\\psi^{\\mathrm{id}\\,'}(x) = -2 \\quad \\text{for } x \\in K.\n$$\n\nNext, we solve for the oversampled basis function $\\psi^{\\mathrm{os}}(x)$ on the oversampling patch $U_K = \\left(0, \\frac{1}{2}+\\delta\\right)$.\nThe governing equation is\n$$\n-(A(x)\\,\\psi^{\\mathrm{os}\\,'}(x))' = 0 \\quad \\text{on } U_K.\n$$\nThis equation implies that the flux, $J(x) = -A(x)\\,\\psi^{\\mathrm{os}\\,'}(x)$, is constant throughout the domain $U_K$. Let us denote this constant flux by $J_0$.\n$$\n-A(x)\\,\\psi^{\\mathrm{os}\\,'}(x) = J_0.\n$$\nThis gives an expression for the gradient:\n$$\n\\psi^{\\mathrm{os}\\,'}(x) = -\\frac{J_0}{A(x)}.\n$$\nThe function $\\psi^{\\mathrm{os}}(x)$ can be found by integrating its gradient from $0$ to $x$, using the boundary condition $\\psi^{\\mathrm{os}}(0)=1$:\n$$\n\\psi^{\\mathrm{os}}(x) = \\psi^{\\mathrm{os}}(0) + \\int_0^x \\psi^{\\mathrm{os}\\,'}(s)\\,ds = 1 - \\int_0^x \\frac{J_0}{A(s)}\\,ds.\n$$\nTo find the constant $J_0$, we apply the second boundary condition, $\\psi^{\\mathrm{os}}\\!\\left(\\frac{1}{2}+\\delta\\right)=0$:\n$$\n\\psi^{\\mathrm{os}}\\!\\left(\\frac{1}{2}+\\delta\\right) = 1 - J_0 \\int_0^{\\frac{1}{2}+\\delta} \\frac{1}{A(s)}\\,ds = 0.\n$$\nFrom this, we see that $J_0$ is the reciprocal of the total resistance of the domain:\n$$\nJ_0 = \\left( \\int_0^{\\frac{1}{2}+\\delta} \\frac{1}{A(s)}\\,ds \\right)^{-1}.\n$$\nWe evaluate the integral by splitting it at the point of discontinuity $x=\\frac{1}{2}$:\n$$\n\\int_0^{\\frac{1}{2}+\\delta} \\frac{1}{A(s)}\\,ds = \\int_0^{\\frac{1}{2}} \\frac{1}{A(s)}\\,ds + \\int_{\\frac{1}{2}}^{\\frac{1}{2}+\\delta} \\frac{1}{A(s)}\\,ds.\n$$\nUsing the piecewise definition of $A(x)$: $A(x)=1$ for $x \\in (0, \\frac{1}{2})$ and $A(x)=\\varepsilon$ for $x \\in (\\frac{1}{2}, \\frac{1}{2}+\\delta)$:\n$$\n\\int_0^{\\frac{1}{2}+\\delta} \\frac{1}{A(s)}\\,ds = \\int_0^{\\frac{1}{2}} \\frac{1}{1}\\,ds + \\int_{\\frac{1}{2}}^{\\frac{1}{2}+\\delta} \\frac{1}{\\varepsilon}\\,ds = \\left[s\\right]_0^{\\frac{1}{2}} + \\frac{1}{\\varepsilon}\\left[s\\right]_{\\frac{1}{2}}^{\\frac{1}{2}+\\delta} = \\frac{1}{2} + \\frac{1}{\\varepsilon}\\left(\\left(\\frac{1}{2}+\\delta\\right)-\\frac{1}{2}\\right) = \\frac{1}{2} + \\frac{\\delta}{\\varepsilon}.\n$$\nCombining the terms gives the total resistance: $\\frac{\\varepsilon + 2\\delta}{2\\varepsilon}$.\nNow we can find $J_0$:\n$$\nJ_0 = \\left(\\frac{\\varepsilon + 2\\delta}{2\\varepsilon}\\right)^{-1} = \\frac{2\\varepsilon}{\\varepsilon + 2\\delta}.\n$$\nThe problem asks for the gradient $\\psi^{\\mathrm{os}\\,'}(x)$ for $x \\in K=\\left(0,\\frac{1}{2}\\right)$. In this interval, $A(x)=1$. The gradient is therefore:\n$$\n\\psi^{\\mathrm{os}\\,'}(x) = -\\frac{J_0}{A(x)} = -\\frac{J_0}{1} = -J_0 = -\\frac{2\\varepsilon}{\\varepsilon + 2\\delta}.\n$$\n\nFinally, we compute the ratio $E(\\varepsilon, \\delta)$:\n$$\nE(\\varepsilon, \\delta) = \\frac{\\psi^{\\mathrm{os}\\,'}(x)}{\\psi^{\\mathrm{id}\\,'}(x)} \\quad \\text{for } x \\in K.\n$$\nSince both gradients are constant on $K$, we can substitute their derived values:\n$$\nE(\\varepsilon, \\delta) = \\frac{-\\frac{2\\varepsilon}{\\varepsilon + 2\\delta}}{-2} = \\frac{1}{2} \\cdot \\frac{2\\varepsilon}{\\varepsilon + 2\\delta} = \\frac{\\varepsilon}{\\varepsilon + 2\\delta}.\n$$\nTo maintain standard algebraic form, we write the denominator as $2\\delta + \\varepsilon$.\n$$\nE(\\varepsilon, \\delta) = \\frac{\\varepsilon}{2\\delta + \\varepsilon}.\n$$\nThis expression quantifies the error in the gradient of the multiscale basis function on the element $K$ due to the boundary layer effects from the material discontinuity at $x=1/2$, which are not fully captured and removed by the naive oversampling and restriction procedure.",
            "answer": "$$\\boxed{\\frac{\\varepsilon}{2\\delta + \\varepsilon}}$$"
        },
        {
            "introduction": "Having established the theoretical need for oversampling, this practice moves from analysis to implementation. You will construct a one-dimensional surrogate model for a Mixed MsFEM to simulate flow in a layered medium . By programming and comparing a non-oversampled case with an oversampled one, you will gain tangible, quantitative evidence of how enlarging the local computation domains suppresses non-physical oscillations in the solution.",
            "id": "3790689",
            "problem": "You are tasked with constructing and analyzing a one-dimensional layered medium in the context of the Multi-scale Finite Element Method (MsFEM), specifically its mixed formulation (Mixed MsFEM), to demonstrate how oversampling reduces spurious oscillations in the pressure approximation across layers. The physical setting is a dimensionless one-dimensional domain with coordinate $x \\in [0,1]$. The governing equations for steady Darcy flow are the constitutive relation $u(x) = -k(x) \\,\\dfrac{dp}{dx}$ and conservation of mass $\\dfrac{d u}{dx} = f(x)$, where $u(x)$ is the volumetric flux, $k(x)$ is the heterogeneous permeability, $p(x)$ is the pressure, and $f(x)$ is a source term. In this problem, take $f(x) = 0$ and impose Dirichlet boundary conditions $p(0) = 1$ and $p(1) = 0$, both dimensionless.\n\nStarting from these fundamental laws and the definition of Mixed MsFEM oversampling (which constructs multiscale velocity basis functions on enlarged patches to mitigate resonance between coarse-grid partitioning and fine-scale heterogeneity), design a computable surrogate that retains the principle of patch-based upscaling for the one-dimensional case. Specifically, discretize the domain into $N_f$ fine cells with uniform length $\\Delta x_f = \\dfrac{1}{N_f}$ and a coarse partition into $N_c$ coarse cells with uniform length $H = \\dfrac{1}{N_c}$. Define a layered medium by alternating blocks of fine cells with permeability $k_{\\mathrm{low}}$ and $k_{\\mathrm{high}}$, each block having a width of $n_{\\mathrm{per}}$ fine cells. The alternation continues until the $N_f$ fine cells are filled.\n\nTo emulate mixed oversampling in one dimension, associate to each coarse interface (between coarse cells $i$ and $i+1$) an oversampled patch consisting of the coarse-index interval $[a,b]$, where $a = \\max(0,i-m)$ and $b = \\min(N_c-1,i+1+m)$ for an oversampling size $m \\in \\mathbb{N}$. Over this patch, define the effective permeability by the series law of resistances derived from Darcy’s law and flux conservation:\n$$\nk_{\\mathrm{eff}}(i+\\tfrac{1}{2};m) \\;=\\; \\frac{L_{\\mathrm{patch}}}{\\sum_{j \\in \\mathcal{J}(a,b)} \\frac{\\Delta x_f}{k_j}},\n$$\nwhere $L_{\\mathrm{patch}} = (b-a+1)\\,H$ is the physical length of the patch, $\\mathcal{J}(a,b)$ is the set of fine-cell indices covered by the patch, and $k_j$ is the permeability on fine cell $j$. The coarse transmissibility at the interface is then defined as\n$$\nT_{i+\\tfrac{1}{2}}(m) \\;=\\; \\frac{k_{\\mathrm{eff}}(i+\\tfrac{1}{2};m)}{H}.\n$$\nFor the non-oversampled case, set $m = 0$. For the oversampled case, set $m$ to a specified positive integer. Assemble the coarse two-point flux system for the pressure unknowns at coarse cell centers, $\\{p_i\\}_{i=0}^{N_c-1}$, with $p_0 = 1$ and $p_{N_c-1} = 0$ and, for $i = 1,\\dots,N_c-2$,\n$$\nT_{i+\\tfrac{1}{2}}(m) \\big( p_i - p_{i+1} \\big) + T_{i-\\tfrac{1}{2}}(m) \\big( p_i - p_{i-1} \\big) \\;=\\; 0.\n$$\nSolve this system twice: once with $m=0$ (no oversampling) to obtain $p^{(0)}$, and once with the specified oversampling size $m$ to obtain $p^{(m)}$.\n\nTo quantify spurious oscillations in the coarse pressure, use the discrete second-difference seminorm\n$$\n\\mathcal{O}(p) \\;=\\; \\sum_{i=1}^{N_c-2} \\left| p_{i+1} - 2p_i + p_{i-1} \\right|.\n$$\nSince perfectly linear coarse solutions yield $\\mathcal{O}(p) = 0$, introduce a small regularization constant $\\delta = 10^{-12}$ to avoid degeneracy when forming a reduction factor. Define the oscillation-reduction factor\n$$\nR \\;=\\; \\frac{\\mathcal{O}\\!\\left(p^{(0)}\\right) + \\delta}{\\mathcal{O}\\!\\left(p^{(m)}\\right) + \\delta}.\n$$\nYour program must implement this construction and compute $R$ for each test case in the suite below. There are no physical units in this dimensionless formulation, and all answers must be reported as dimensionless floats.\n\nImplement the layered medium and solve for the reduction factor $R$ for each of the following test cases, which are selected to cover a general case, an aligned-layer boundary case, and an extreme-contrast edge case:\n\n- Test case $1$ (general misaligned layering): $N_f=120$, $N_c=12$, $n_{\\mathrm{per}}=9$, $k_{\\mathrm{low}}=1$, $k_{\\mathrm{high}}=100$, $m=2$.\n- Test case $2$ (aligned layering with coarse cells): $N_f=120$, $N_c=12$, $n_{\\mathrm{per}}=10$, $k_{\\mathrm{low}}=1$, $k_{\\mathrm{high}}=100$, $m=2$.\n- Test case $3$ (extreme contrast, misaligned layering): $N_f=140$, $N_c=14$, $n_{\\mathrm{per}}=7$, $k_{\\mathrm{low}}=1$, $k_{\\mathrm{high}}=10^6$, $m=3$.\n\nYour program should produce a single line of output containing the reduction factors as a comma-separated list enclosed in square brackets, for example, $[r_1,r_2,r_3]$, where each $r_i$ is the computed float for the corresponding test case.",
            "solution": "The problem is founded on steady Darcy flow in one dimension with zero source, where the governing relations are $u(x) = -k(x) \\dfrac{dp}{dx}$ and $\\dfrac{d u}{dx} = 0$, leading to constant flux on any connected interval with well-posed boundary conditions. In a heterogeneous layered medium, the exact fine-scale solution has piecewise linear pressure with slope determined by the local permeability and the constant flux. For a sequence of layers in series, classical homogenization in one dimension gives the effective permeability over an interval $I$:\n$$\nk_{\\mathrm{eff}}(I) \\;=\\; \\frac{|I|}{\\int_I \\dfrac{1}{k(x)} \\, dx},\n$$\nwhich is the harmonic average in continuous form. This result follows from the series law for resistances: for piecewise constant $k(x)$ on fine cells of length $\\Delta x_f$, the resistance of cell $j$ is $R_j = \\dfrac{\\Delta x_f}{k_j}$, so the net resistance over $I$ is $R_I = \\sum_j R_j$, with the flux under a unit pressure drop given by $q = \\dfrac{1}{R_I}$ and thus $k_{\\mathrm{eff}} = \\dfrac{|I|}{R_I}$.\n\nMixed Multi-scale Finite Element Method (Mixed MsFEM) constructs multiscale velocity basis functions that respect $u = -k \\nabla p$ and $\\nabla \\cdot u = 0$, and couples them with a coarse pressure space, typically piecewise constants or low-order polynomials. A central issue is resonance error: when coarse-grid cells are not aligned with the fine-scale heterogeneity, basis functions computed on minimal local cells can imprint the artificial boundary conditions used in local solves, which inject spurious oscillations into the coarse pressure solution. Mixed oversampling mitigates this by solving local basis problems on enlarged patches, so that artificial boundary effects decay within the oversampled interior region where the basis is then restricted.\n\nIn one dimension, we can capture the essence of mixed oversampling with a transmissibility-based surrogate derived from first principles. For the coarse interface between cells $i$ and $i+1$, we define an oversampled patch $[a,b]$ of coarse cells, with $a = \\max(0,i-m)$ and $b = \\min(N_c-1,i+1+m)$. Over this patch, we invoke the series law to compute $k_{\\mathrm{eff}}(i+\\tfrac{1}{2};m) = \\dfrac{L_{\\mathrm{patch}}}{\\sum_{j \\in \\mathcal{J}(a,b)} \\frac{\\Delta x_f}{k_j}}$, where $L_{\\mathrm{patch}} = (b-a+1)H$ and $\\mathcal{J}(a,b)$ is the set of fine-cell indices belonging to the union of coarse cells $a$ through $b$. The transmissibility at the interface, which relates the flux to the pressure drop across that interface, is then set to\n$$\nT_{i+\\tfrac{1}{2}}(m) \\;=\\; \\frac{k_{\\mathrm{eff}}(i+\\tfrac{1}{2};m)}{H}.\n$$\nThis scaling is consistent with the two-point flux discretization in one dimension: if a segment of length $H$ has effective permeability $\\kappa$, then under a pressure drop $\\Delta p$ across $H$, the flux is $q = \\kappa \\dfrac{\\Delta p}{H}$, yielding $T = \\dfrac{\\kappa}{H}$.\n\nWith $T_{i+\\tfrac{1}{2}}(m)$ defined, the coarse pressure equations for interior cells are\n$$\nT_{i+\\tfrac{1}{2}}(m)\\,(p_i - p_{i+1}) + T_{i-\\tfrac{1}{2}}(m)\\,(p_i - p_{i-1}) \\;=\\; 0,\\quad i = 1,\\dots,N_c-2,\n$$\nwith Dirichlet boundaries $p_0 = 1$ and $p_{N_c-1} = 0$. This is a tridiagonal linear system. Solving it for $m=0$ gives $p^{(0)}$, and solving it for the specified $m$ gives $p^{(m)}$.\n\nTo measure spurious oscillations, we use the discrete second-difference seminorm\n$$\n\\mathcal{O}(p) \\;=\\; \\sum_{i=1}^{N_c-2} \\left| p_{i+1} - 2p_i + p_{i-1} \\right|.\n$$\nFor a perfectly linear pressure sequence, second differences vanish, so $\\mathcal{O}(p) = 0$. In practice, misalignment between coarse interfaces and fine-scale layers produces alternating variations in the local transmissibilities, causing $p$ to deviate from linearity and $\\mathcal{O}(p)$ to be strictly positive. To avoid division by zero in cases where oversampling achieves near-perfect linearity, we introduce a small regularization constant $\\delta = 10^{-12}$ and define the reduction factor as\n$$\nR \\;=\\; \\frac{\\mathcal{O}\\!\\left(p^{(0)}\\right) + \\delta}{\\mathcal{O}\\!\\left(p^{(m)}\\right) + \\delta}.\n$$\nValues $R > 1$ indicate that oversampling reduces oscillations relative to the non-oversampled case. The choice of layered media and coarse/fine grids in the test suite is designed to exhibit three behaviors: a general misaligned scenario (where resonance is present and oversampling helps), an aligned scenario (where resonance is minimized and oversampling yields little improvement), and an extreme-contrast, misaligned scenario (where oversampling yields a pronounced reduction).\n\nAlgorithmic steps that implement the principle-based derivation:\n- Define $N_f$, $N_c$, $n_{\\mathrm{per}}$, $k_{\\mathrm{low}}$, $k_{\\mathrm{high}}$, and $m$.\n- Construct the fine-scale permeability array $\\{k_j\\}_{j=0}^{N_f-1}$ by alternating blocks of length $n_{\\mathrm{per}}$ with values $k_{\\mathrm{low}}$ and $k_{\\mathrm{high}}$ until $N_f$ cells are filled.\n- Compute transmissibilities $\\{T_{i+\\tfrac{1}{2}}(m)\\}_{i=0}^{N_c-2}$ via the oversampled patch formula for both $m=0$ and the given $m$.\n- Assemble and solve the tridiagonal coarse system for $p^{(0)}$ and $p^{(m)}$ with $p_0 = 1$ and $p_{N_c-1} = 0$.\n- Compute $\\mathcal{O}\\!\\left(p^{(0)}\\right)$ and $\\mathcal{O}\\!\\left(p^{(m)}\\right)$, and then compute $R$ using the regularized ratio.\n- Repeat for each test case and output the list $[R_1, R_2, R_3]$.\n\nThis approach adheres to the fundamental laws of Darcy flow and mass conservation, uses the well-tested harmonic averaging for series media, and captures the essence of mixed oversampling in one dimension by enlarging the patch over which local effective properties are computed. The enlarged patches damp the artificial boundary effects that would otherwise yield oscillatory transmissibility coefficients and, consequently, oscillatory coarse pressures, thus demonstrating the reduction in spurious oscillations due to oversampling.",
            "answer": "```python\n# Python 3.12 code using numpy 1.23.5, no external files or input.\nimport numpy as np\n\ndef build_layered_k(Nf, n_per, k_low, k_high):\n    \"\"\"\n    Build a fine-scale permeability array of length Nf by alternating blocks:\n    n_per cells of k_low, then n_per cells of k_high, repeating until filled.\n    \"\"\"\n    k = np.empty(Nf, dtype=float)\n    vals = [k_low] * n_per + [k_high] * n_per\n    idx = 0\n    vlen = len(vals)\n    for j in range(Nf):\n        k[j] = vals[idx]\n        idx += 1\n        if idx == vlen:\n            idx = 0\n    return k\n\ndef transmissibilities(k, Nf, Nc, m):\n    \"\"\"\n    Compute coarse-edge transmissibilities T_{i+1/2}(m) for i=0..Nc-2\n    using oversampled patches defined on coarse cells.\n\n    - Fine cell length: dx_f = 1.0 / Nf\n    - Coarse cell length: H = 1.0 / Nc\n    - Each coarse cell contains F = Nf // Nc fine cells (assumed integer).\n    \"\"\"\n    F = Nf // Nc\n    dx_f = 1.0 / Nf\n    H = 1.0 / Nc\n    T = np.empty(Nc - 1, dtype=float)\n\n    # Precompute cumulative sums of (dx_f / k_j) for fast patch resistance queries.\n    resist = dx_f / k\n    cumR = np.zeros(Nf + 1, dtype=float)\n    cumR[1:] = np.cumsum(resist)\n\n    for i in range(Nc - 1):\n        a = max(0, i - m)\n        b = min(Nc - 1, i + 1 + m)\n        # Fine index range for coarse cells [a..b]: j in [a*F .. (b+1)*F - 1]\n        j_start = a * F\n        j_end = (b + 1) * F  # exclusive\n        # Patch length\n        L_patch = (b - a + 1) * H\n        # Patch resistance: sum_{j=j_start}^{j_end-1} dx_f / k_j\n        R_patch = cumR[j_end] - cumR[j_start]\n        k_eff_patch = L_patch / R_patch\n        T[i] = k_eff_patch / H\n    return T\n\ndef solve_coarse_pressure(T, Nc):\n    \"\"\"\n    Solve the coarse pressure system with Dirichlet boundary conditions:\n    p0 = 1.0, p_{Nc-1} = 0.0\n\n    Interior equations for i=1..Nc-2:\n        T_{i+1/2}(p_i - p_{i+1}) + T_{i-1/2}(p_i - p_{i-1}) = 0\n    \"\"\"\n    n = Nc - 2\n    if n = 0:\n        # Trivial case with only boundaries\n        return np.array([1.0] + [0.0]*(Nc-1), dtype=float)\n\n    A = np.zeros((n, n), dtype=float)\n    b = np.zeros(n, dtype=float)\n    # Indices:\n    # Interior unknowns are p[1]..p[Nc-2], map to rows 0..n-1\n    for row in range(n):\n        i = row + 1  # actual coarse index\n        T_left = T[i - 1]        # T_{i-1/2}\n        T_right = T[i] if i  Nc - 1 else 0.0  # T_{i+1/2}, valid for i=Nc-2\n\n        # Diagonal\n        A[row, row] = T_left + T_right\n\n        # Left neighbor (i-1): could be boundary at i=1\n        if i - 1 == 0:\n            b[row] += T_left * 1.0  # p0 = 1.0\n        else:\n            A[row, row - 1] = -T_left\n\n        # Right neighbor (i+1): could be boundary at i=Nc-2\n        if i + 1 == Nc - 1:\n            # p_{Nc-1} = 0.0, contributes nothing to b\n            pass\n        else:\n            A[row, row + 1] = -T_right\n\n    p_interior = np.linalg.solve(A, b)\n    p = np.zeros(Nc, dtype=float)\n    p[0] = 1.0\n    p[-1] = 0.0\n    p[1:Nc-1] = p_interior\n    return p\n\ndef oscillation_metric(p):\n    \"\"\"\n    Compute discrete second-difference seminorm:\n        O(p) = sum_{i=1}^{Nc-2} |p_{i+1} - 2 p_i + p_{i-1}|\n    \"\"\"\n    # Requires Nc >= 3\n    if p.size  3:\n        return 0.0\n    second_diff = p[2:] - 2.0 * p[1:-1] + p[:-2]\n    return np.sum(np.abs(second_diff))\n\ndef run_case(Nf, Nc, n_per, k_low, k_high, m):\n    k = build_layered_k(Nf, n_per, k_low, k_high)\n    # No oversampling\n    T0 = transmissibilities(k, Nf, Nc, m=0)\n    p0 = solve_coarse_pressure(T0, Nc)\n    O0 = oscillation_metric(p0)\n    # Oversampling\n    Tm = transmissibilities(k, Nf, Nc, m=m)\n    pm = solve_coarse_pressure(Tm, Nc)\n    Om = oscillation_metric(pm)\n    delta = 1e-12\n    R = (O0 + delta) / (Om + delta)\n    return R\n\ndef solve():\n    test_cases = [\n        # Test case 1: Nf=120, Nc=12, n_per=9, k_low=1, k_high=100, m=2\n        (120, 12, 9, 1.0, 100.0, 2),\n        # Test case 2: Nf=120, Nc=12, n_per=10, k_low=1, k_high=100, m=2\n        (120, 12, 10, 1.0, 100.0, 2),\n        # Test case 3: Nf=140, Nc=14, n_per=7, k_low=1, k_high=1e6, m=3\n        (140, 14, 7, 1.0, 1e6, 3),\n    ]\n\n    results = []\n    for case in test_cases:\n        Nf, Nc, n_per, k_low, k_high, m = case\n        result = run_case(Nf, Nc, n_per, k_low, k_high, m)\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "A deep understanding of any method includes knowing its limitations. This final exercise probes the fundamental assumption of locality that underpins MsFEM and its oversampling extension. We will construct a hypothetical medium with long-range correlations, where a significant feature lies far outside the local oversampling patch, to demonstrate that local corrections are inherently blind to certain global effects, resulting in an irreducible modeling error .",
            "id": "3790674",
            "problem": "Consider the scalar elliptic boundary value problem in one space dimension,\n$$\n-\\frac{\\mathrm{d}}{\\mathrm{d}x}\\Big(a(x)\\,\\frac{\\mathrm{d}u(x)}{\\mathrm{d}x}\\Big)=f(x),\\qquad x\\in(0,1),\\qquad u(0)=0,\\quad u(1)=0,\n$$\nwith a strictly positive diffusion coefficient $a(x)0$. The Multiscale Finite Element Method (MsFEM) with oversampling constructs coarse-scale basis functions by solving local homogeneous cell problems on enlarged patches and restricting them to coarse elements. Let a single coarse element be $K=[x_{0}-H/2,x_{0}+H/2]\\subset(0,1)$ of length $H$, and let its oversampling patch be\n$$\nK_{r}=\\big[x_{0}-\\tfrac{H}{2}-r,\\;x_{0}+\\tfrac{H}{2}+r\\big]\\cap[0,1],\n$$\nwhere $r0$ is the oversampling radius. On any interval $I\\subset[0,1]$, the associated flux-based MsFEM basis function $\\phi$ for the homogeneous equation satisfies\n$$\n-\\frac{\\mathrm{d}}{\\mathrm{d}x}\\Big(a(x)\\,\\frac{\\mathrm{d}\\phi(x)}{\\mathrm{d}x}\\Big)=0,\\qquad \\phi(x_{L})=0,\\quad \\phi(x_{R})=1,\n$$\nfor the interval endpoints $x_{L}x_{R}$ of $I$, with restriction to $K$ when $I=K_{r}$. The corresponding “global reference” basis $\\phi_{\\mathrm{glob}}$ is defined by solving the same homogeneous problem on $I=[0,1]$ with $\\phi_{\\mathrm{glob}}(0)=0$ and $\\phi_{\\mathrm{glob}}(1)=1$, and restricting it to $K$.\n\nConstruct a diffusion coefficient with long-range correlations as follows. Fix parameters $0w1$, $0\\alpha\\ll 1$, and a center $x_{c}\\in(0,1)$ such that the inclusion interval\n$$\nI=\\big[x_{c}-\\tfrac{w}{2},\\;x_{c}+\\tfrac{w}{2}\\big]\n$$\nis disjoint from $K$ and from $K_{r}$. Assume $K$ lies entirely in the complement of $I$, and that the oversampling radius $r$ is “practical” in the sense that $K_{r}\\cap I=\\emptyset$ (equivalently, the distance from $K$ to $I$ exceeds $r+H/2$). Define\n$$\na(x)=\\begin{cases}\n\\alpha, x\\in I,\\\\\n1, x\\in[0,1]\\setminus I.\n\\end{cases}\n$$\nThis $a(x)$ has long-range correlations in the sense that the harmonic coordinate for the global homogeneous problem depends on the integral of $a^{-1}$ over the entire domain, which is influenced by the distant interval $I$ even though $I$ lies outside any practical oversampling patch $K_{r}$.\n\nDefine the local modeling error on $K$ as the difference between the local energy contributions of the oversampled MsFEM basis restricted to $K$ and the global reference basis restricted to $K$:\n$$\nE_{\\mathrm{mod}}(K)\\coloneqq\\int_{K}a(x)\\Big(\\big(\\phi_{r}'(x)\\big)^{2}-\\big(\\phi_{\\mathrm{glob}}'(x)\\big)^{2}\\Big)\\,\\mathrm{d}x,\n$$\nwhere $\\phi_{r}$ is the solution on $K_{r}$ with $\\phi_{r}(x_{0}-H/2-r)=0$ and $\\phi_{r}(x_{0}+H/2+r)=1$, and $\\phi_{\\mathrm{glob}}$ is the solution on $[0,1]$ with $\\phi_{\\mathrm{glob}}(0)=0$ and $\\phi_{\\mathrm{glob}}(1)=1$. Using only fundamental principles, derive a closed-form analytical expression for $E_{\\mathrm{mod}}(K)$ in terms of $H$, $r$, $w$, and $\\alpha$, under the assumption $K_{r}\\cap I=\\emptyset$. Your answer must be a single closed-form expression. No rounding is required, and no units are involved. Finally, justify from your derivation why, under the stated disjointness assumption, increasing the oversampling radius $r$ within practical limits fails to control the modeling error generated by the long-range correlations in $a(x)$.",
            "solution": "The problem is subjected to validation and is found to be scientifically grounded, well-posed, objective, and self-contained. The problem is valid.\n\nThe central task is to derive an expression for the local modeling error, $E_{\\mathrm{mod}}(K)$, and to analyze its dependence on the oversampling radius $r$. The modeling error is defined as:\n$$\nE_{\\mathrm{mod}}(K) \\coloneqq \\int_{K}a(x)\\Big(\\big(\\phi_{r}'(x)\\big)^{2}-\\big(\\phi_{\\mathrm{glob}}'(x)\\big)^{2}\\Big)\\,\\mathrm{d}x\n$$\nThis requires the calculation of the derivatives of two multiscale basis functions: the oversampled basis $\\phi_{r}$ and the global reference basis $\\phi_{\\mathrm{glob}}$. Both are solutions to the homogeneous elliptic equation on different intervals.\n\nLet's first find the general form for a basis function $\\phi$ that solves the homogeneous problem on an interval $[x_L, x_R]$:\n$$\n-\\frac{\\mathrm{d}}{\\mathrm{d}x}\\Big(a(x)\\,\\frac{\\mathrm{d}\\phi(x)}{\\mathrm{d}x}\\Big)=0,\\qquad \\phi(x_{L})=0,\\quad \\phi(x_{R})=1\n$$\nIntegrating the equation once yields $a(x)\\frac{\\mathrm{d}\\phi}{\\mathrm{d}x} = C_1$ for some constant $C_1$. This implies $\\frac{\\mathrm{d}\\phi}{\\mathrm{d}x} = \\frac{C_1}{a(x)}$.\nIntegrating a second time from $x_L$ to $x$ gives:\n$$\n\\phi(x) - \\phi(x_L) = C_1 \\int_{x_L}^{x} \\frac{1}{a(s)}\\,\\mathrm{d}s\n$$\nUsing the boundary condition $\\phi(x_L)=0$, we get $\\phi(x) = C_1 \\int_{x_L}^{x} \\frac{1}{a(s)}\\,\\mathrm{d}s$.\nThe second boundary condition $\\phi(x_R)=1$ determines the constant $C_1$:\n$$\n1 = C_1 \\int_{x_L}^{x_R} \\frac{1}{a(s)}\\,\\mathrm{d}s \\implies C_1 = \\frac{1}{\\int_{x_L}^{x_R} \\frac{1}{a(s)}\\,\\mathrm{d}s}\n$$\nThe derivative of the basis function is thus given by:\n$$\n\\phi'(x) = \\frac{C_1}{a(x)} = \\frac{1}{a(x)\\int_{x_L}^{x_R} \\frac{1}{a(s)}\\,\\mathrm{d}s}\n$$\nThe local energy contribution over a subinterval $J \\subseteq [x_L, x_R]$ is:\n$$\n\\int_{J} a(x) (\\phi'(x))^2\\,\\mathrm{d}x = \\int_{J} a(x) \\left( \\frac{1}{a(x)\\int_{x_L}^{x_R} \\frac{1}{a(s)}\\,\\mathrm{d}s} \\right)^2 \\,\\mathrm{d}x = \\frac{1}{\\left(\\int_{x_L}^{x_R} \\frac{1}{a(s)}\\,\\mathrm{d}s\\right)^2} \\int_{J} \\frac{1}{a(x)}\\,\\mathrm{d}x\n$$\n\nWe apply this general formula to our two specific cases.\n\n**1. The Oversampled Basis Function $\\phi_r$**\n\nThe function $\\phi_r$ is defined on the oversampling patch $K_r = [x_0 - \\frac{H}{2} - r, x_0 + \\frac{H}{2} + r] \\cap [0,1]$. The problem statement implies we consider a coarse element $K$ and its patch $K_r$ that are not at the domain boundaries, so we can assume $K_r \\subset (0,1)$ and its length is $H+2r$. The boundary conditions are applied at the endpoints of this patch.\nThe key assumption is $K_r \\cap I = \\emptyset$. This means for any $x \\in K_r$, the diffusion coefficient is $a(x)=1$.\nThe integral of $a^{-1}$ over the patch $K_r$ is:\n$$\n\\int_{K_r} \\frac{1}{a(s)}\\,\\mathrm{d}s = \\int_{x_0 - H/2 - r}^{x_0 + H/2 + r} \\frac{1}{1}\\,\\mathrm{d}s = (x_0 + H/2 + r) - (x_0 - H/2 - r) = H+2r\n$$\nThe energy of $\\phi_r$ over the coarse element $K$ is the first term in $E_{\\mathrm{mod}}(K)$. The interval of integration is $K$.\n$$\nE_r(K) \\coloneqq \\int_{K} a(x) (\\phi_r'(x))^2\\,\\mathrm{d}x = \\frac{1}{\\left(\\int_{K_r} \\frac{1}{a(s)}\\,\\mathrm{d}s\\right)^2} \\int_{K} \\frac{1}{a(x)}\\,\\mathrm{d}x\n$$\nSince $K \\subset K_r$, we have $a(x)=1$ on $K$. The integral of $a(x)^{-1}$ over $K$ is therefore $\\int_K 1\\,\\mathrm{d}x = H$.\nSubstituting the values, we find:\n$$\nE_r(K) = \\frac{H}{(H+2r)^2}\n$$\n\n**2. The Global Reference Basis Function $\\phi_{\\mathrm{glob}}$**\n\nThe function $\\phi_{\\mathrm{glob}}$ is defined on the entire domain $[0,1]$.\nThe integral of $a^{-1}$ over $[0,1]$ is:\n$$\n\\int_{0}^{1} \\frac{1}{a(s)}\\,\\mathrm{d}s = \\int_I \\frac{1}{a(s)}\\,\\mathrm{d}s + \\int_{[0,1]\\setminus I} \\frac{1}{a(s)}\\,\\mathrm{d}s\n$$\nGiven $a(x)=\\alpha$ on $I$ (an interval of length $w$) and $a(x)=1$ on $[0,1]\\setminus I$ (a set of measure $1-w$), we have:\n$$\n\\int_{0}^{1} \\frac{1}{a(s)}\\,\\mathrm{d}s = \\int_I \\frac{1}{\\alpha}\\,\\mathrm{d}s + \\int_{[0,1]\\setminus I} 1\\,\\mathrm{d}s = \\frac{w}{\\alpha} + (1-w)\n$$\nThe energy of $\\phi_{\\mathrm{glob}}$ over the coarse element $K$ is the second term in $E_{\\mathrm{mod}}(K)$.\n$$\nE_{\\mathrm{glob}}(K) \\coloneqq \\int_{K} a(x) (\\phi_{\\mathrm{glob}}'(x))^2\\,\\mathrm{d}x = \\frac{1}{\\left(\\int_{0}^{1} \\frac{1}{a(s)}\\,\\mathrm{d}s\\right)^2} \\int_{K} \\frac{1}{a(x)}\\,\\mathrm{d}x\n$$\nFrom the initial setup, we know $K \\cap I = \\emptyset$, so $a(x)=1$ for all $x \\in K$. Thus, $\\int_K a(x)^{-1}\\,\\mathrm{d}x = H$.\nSubstituting the values, we find:\n$$\nE_{\\mathrm{glob}}(K) = \\frac{H}{\\left(1-w+\\frac{w}{\\alpha}\\right)^2}\n$$\n\n**3. The Modeling Error $E_{\\mathrm{mod}}(K)$**\n\nCombining the two results, the modeling error is:\n$$\nE_{\\mathrm{mod}}(K) = E_r(K) - E_{\\mathrm{glob}}(K) = \\frac{H}{(H+2r)^2} - \\frac{H}{\\left(1-w+\\frac{w}{\\alpha}\\right)^2}\n$$\nFactoring out $H$ gives the final closed-form expression:\n$$\nE_{\\mathrm{mod}}(K) = H \\left( \\frac{1}{(H+2r)^2} - \\frac{1}{\\left(1-w+\\frac{w}{\\alpha}\\right)^2} \\right)\n$$\n\n**Justification of Oversampling Failure**\n\nThe modeling error, $E_{\\mathrm{mod}}(K)$, quantifies the discrepancy in local energy between the oversampled basis function $\\phi_r$ and the global reference basis $\\phi_{\\mathrm{glob}}$. For oversampling to be effective, this error should be controllable and driven to zero by increasing the oversampling radius $r$.\n\nOur derived expression for $E_{\\mathrm{mod}}(K)$ consists of two terms:\n- The local energy of the oversampled basis, $E_r(K) = \\frac{H}{(H+2r)^2}$. This term depends only on the local geometry ($H$, $r$) and the local value of the diffusion coefficient $a(x)=1$ on $K_r$.\n- The local energy of the global basis, $E_{\\mathrm{glob}}(K) = \\frac{H}{(1-w+w/\\alpha)^2}$. This term depends on the global properties of the medium, specifically the parameters $w$ and $\\alpha$ of the distant inclusion $I$.\n\nThe failure of oversampling to control the error is evident from this structure. The oversampled basis $\\phi_r$ is computed by solving a local problem on $K_r$. By the problem's assumption ($K_r \\cap I = \\emptyset$), this local problem has no information about the existence or properties of the inclusion $I$. The local solver on $K_r$ effectively \"sees\" a homogeneous medium with $a(x) \\equiv 1$. Consequently, the resulting energy term $E_r(K)$ is completely independent of $w$ and $\\alpha$.\n\nIn contrast, the global reference basis $\\phi_{\\mathrm{glob}}$ and its energy $E_{\\mathrm{glob}}(K)$ are sensitive to the \"long-range correlation\" introduced by $I$, as captured by the term $(1-w+w/\\alpha)^2$.\n\nIncreasing the oversampling radius $r$ (within \"practical limits,\" i.e., $r$ is small enough that $K_r$ does not reach $I$) only changes the value of $E_r(K)$. It drives $E_r(K)$ towards $0$ as $r \\to \\infty$. However, the target value, $E_{\\mathrm{glob}}(K)$, is a fixed, non-zero constant (for a given $a(x)$). The error $E_{\\mathrm{mod}}(K)$ therefore converges to $-E_{\\mathrm{glob}}(K)$, not to $0$.\n\nThus, increasing $r$ does not make $E_r(K)$ a better approximation of $E_{\\mathrm{glob}}(K)$. It simply drives the local energy term to zero, while the error itself asymptotes to a non-zero value. This exposes a fundamental limitation of oversampling: it cannot correct for modeling errors caused by long-range features of the medium that lie outside the oversampling region. The local basis remains \"unaware\" of the global structure, and this ignorance manifests as an irreducible modeling error.",
            "answer": "$$\n\\boxed{H \\left( \\frac{1}{(H+2r)^2} - \\frac{1}{\\left(1-w+\\frac{w}{\\alpha}\\right)^2} \\right)}\n$$"
        }
    ]
}