{
    "hands_on_practices": [
        {
            "introduction": "The power of the Multiscale Finite Element Method (MsFEM) lies in its use of local computations to capture fine-scale information. However, the accuracy of this approach hinges on the boundary conditions applied to these local problems. This exercise explores a scenario where naive boundary conditions, even on an oversampled domain, fail to isolate the local solution from exterior influences. By analytically calculating the error introduced by a nearby material discontinuity, you will gain a concrete understanding of the \"boundary layer\" effect and why sophisticated oversampling techniques are essential for robust multiscale modeling .",
            "id": "3790695",
            "problem": "Consider the scalar, second-order, linear elliptic model problem in one space dimension with discontinuous coefficient. Let the physical domain be $D=(0,1)$, and let the element of interest be $K=\\left(0,\\frac{1}{2}\\right)$. For a given oversampling width $\\delta \\in \\left(0,\\frac{1}{2}\\right)$, define the oversampling patch $U_{K}=\\left(0,\\frac{1}{2}+\\delta\\right)$. Let the coefficient $A(x)$ be discontinuous and piecewise constant, given by\n$$\nA(x)=\\begin{cases}\n1, & x \\in \\left(0,\\frac{1}{2}\\right),\\\\\n\\varepsilon, & x \\in \\left(\\frac{1}{2},\\frac{1}{2}+\\delta\\right),\n\\end{cases}\n$$\nwith a fixed contrast parameter $\\varepsilon \\in (0,1)$. In the Multiscale Finite Element Method (MsFEM), consider the local basis function on $U_{K}$ defined by the naive Dirichlet boundary conditions\n$$\n-(A(x)\\,\\psi^{\\mathrm{os}'}(x))' = 0 \\text{ on } U_{K}, \\quad \\psi^{\\mathrm{os}}(0)=1, \\quad \\psi^{\\mathrm{os}}\\!\\left(\\tfrac{1}{2}+\\delta\\right)=0,\n$$\nand define its restriction to $K$ by $\\psi^{\\mathrm{os}}|_{K}$. Also define the ideal, non-oversampled local basis on $K$,\n$$\n-(A(x)\\,\\psi^{\\mathrm{id}'}(x))' = 0 \\text{ on } K, \\quad \\psi^{\\mathrm{id}}(0)=1, \\quad \\psi^{\\mathrm{id}}\\!\\left(\\tfrac{1}{2}\\right)=0,\n$$\nwith $A(x)\\equiv 1$ on $K$. In one dimension, the stiffness contribution scales with the square of the constant gradient on $K$, and the restriction procedure uses $\\psi^{\\mathrm{os}}|_{K}$ directly.\n\nUsing only the fundamental properties of one-dimensional elliptic operators and the constancy of the flux in each subinterval where $A$ is constant, compute a closed-form expression for the ratio\n$$\nE(\\varepsilon,\\delta)\\equiv \\frac{\\psi^{\\mathrm{os}'}(x)}{\\psi^{\\mathrm{id}'}(x)} \\quad \\text{for any } x \\in K,\n$$\nwhich quantifies the spurious boundary layer influence that is not removed by restriction. Express your final answer as a simplified analytic expression in terms of $\\varepsilon$ and $\\delta$. No numerical evaluation is required and no units are involved.",
            "solution": "The user-provided problem is critically examined and found to be valid. It is scientifically grounded in the theory of elliptic partial differential equations and their numerical approximation by multiscale methods. The problem is well-posed, with a unique solution guaranteed by the specified boundary conditions for the one-dimensional, second-order ordinary differential equations. All data and definitions are provided, and there are no internal contradictions, ambiguities, or unrealistic assumptions. We may therefore proceed with the solution.\n\nThe objective is to compute the ratio $E(\\varepsilon,\\delta)\\equiv \\frac{\\psi^{\\mathrm{os}'}(x)}{\\psi^{\\mathrm{id}'}(x)}$ for $x \\in K = \\left(0,\\frac{1}{2}\\right)$. This requires finding the expressions for the gradients $\\psi^{\\mathrm{id}'}(x)$ and $\\psi^{\\mathrm{os}'}(x)$ on the interval $K$.\n\nFirst, we solve for the ideal basis function $\\psi^{\\mathrm{id}}(x)$ on the domain $K = \\left(0,\\frac{1}{2}\\right)$.\nThe governing equation is\n$$\n-(A(x)\\,\\psi^{\\mathrm{id}'}(x))' = 0 \\quad \\text{on } K.\n$$\nOn the interval $K$, the coefficient is specified as $A(x)=1$. Thus, the equation simplifies to\n$$\n-\\psi^{\\mathrm{id}''}(x) = 0.\n$$\nThe general solution to this equation is a linear function of $x$:\n$$\n\\psi^{\\mathrm{id}}(x) = c_1 x + c_2,\n$$\nwhere $c_1$ and $c_2$ are constants of integration. We determine these constants using the given boundary conditions: $\\psi^{\\mathrm{id}}(0)=1$ and $\\psi^{\\mathrm{id}}\\!\\left(\\frac{1}{2}\\right)=0$.\nApplying the first boundary condition at $x=0$:\n$$\n\\psi^{\\mathrm{id}}(0) = c_1(0) + c_2 = 1 \\implies c_2 = 1.\n$$\nApplying the second boundary condition at $x=\\frac{1}{2}$:\n$$\n\\psi^{\\mathrm{id}}\\!\\left(\\frac{1}{2}\\right) = c_1\\left(\\frac{1}{2}\\right) + 1 = 0 \\implies \\frac{c_1}{2} = -1 \\implies c_1 = -2.\n$$\nSo, the ideal basis function is $\\psi^{\\mathrm{id}}(x) = -2x + 1$ on $K$. The gradient is constant over this interval:\n$$\n\\psi^{\\mathrm{id}'}(x) = -2 \\quad \\text{for } x \\in K.\n$$\n\nNext, we solve for the oversampled basis function $\\psi^{\\mathrm{os}}(x)$ on the oversampling patch $U_K = \\left(0, \\frac{1}{2}+\\delta\\right)$.\nThe governing equation is\n$$\n-(A(x)\\,\\psi^{\\mathrm{os}'}(x))' = 0 \\quad \\text{on } U_K.\n$$\nThis equation implies that the flux, $J(x) = -A(x)\\,\\psi^{\\mathrm{os}'}(x)$, is constant throughout the domain $U_K$. Let us denote this constant flux by $J_0$.\n$$\n-A(x)\\,\\psi^{\\mathrm{os}'}(x) = J_0.\n$$\nThis gives an expression for the gradient:\n$$\n\\psi^{\\mathrm{os}'}(x) = -\\frac{J_0}{A(x)}.\n$$\nThe function $\\psi^{\\mathrm{os}}(x)$ can be found by integrating its gradient from $0$ to $x$, using the boundary condition $\\psi^{\\mathrm{os}}(0)=1$:\n$$\n\\psi^{\\mathrm{os}}(x) = \\psi^{\\mathrm{os}}(0) + \\int_0^x \\psi^{\\mathrm{os}'}(s)\\,ds = 1 - \\int_0^x \\frac{J_0}{A(s)}\\,ds.\n$$\nTo find the constant $J_0$, we apply the second boundary condition, $\\psi^{\\mathrm{os}}\\!\\left(\\frac{1}{2}+\\delta\\right)=0$:\n$$\n\\psi^{\\mathrm{os}}\\!\\left(\\frac{1}{2}+\\delta\\right) = 1 - J_0 \\int_0^{\\frac{1}{2}+\\delta} \\frac{1}{A(s)}\\,ds = 0.\n$$\nFrom this, we see that $J_0$ is the reciprocal of the total resistance of the domain:\n$$\nJ_0 = \\left( \\int_0^{\\frac{1}{2}+\\delta} \\frac{1}{A(s)}\\,ds \\right)^{-1}.\n$$\nWe evaluate the integral by splitting it at the point of discontinuity $x=\\frac{1}{2}$:\n$$\n\\int_0^{\\frac{1}{2}+\\delta} \\frac{1}{A(s)}\\,ds = \\int_0^{\\frac{1}{2}} \\frac{1}{A(s)}\\,ds + \\int_{\\frac{1}{2}}^{\\frac{1}{2}+\\delta} \\frac{1}{A(s)}\\,ds.\n$$\nUsing the piecewise definition of $A(x)$: $A(x)=1$ for $x \\in (0, \\frac{1}{2})$ and $A(x)=\\varepsilon$ for $x \\in (\\frac{1}{2}, \\frac{1}{2}+\\delta)$:\n$$\n\\int_0^{\\frac{1}{2}+\\delta} \\frac{1}{A(s)}\\,ds = \\int_0^{\\frac{1}{2}} \\frac{1}{1}\\,ds + \\int_{\\frac{1}{2}}^{\\frac{1}{2}+\\delta} \\frac{1}{\\varepsilon}\\,ds = \\left[s\\right]_0^{\\frac{1}{2}} + \\frac{1}{\\varepsilon}\\left[s\\right]_{\\frac{1}{2}}^{\\frac{1}{2}+\\delta} = \\frac{1}{2} + \\frac{1}{\\varepsilon}\\left(\\left(\\frac{1}{2}+\\delta\\right)-\\frac{1}{2}\\right) = \\frac{1}{2} + \\frac{\\delta}{\\varepsilon}.\n$$\nCombining the terms gives the total resistance: $\\frac{\\varepsilon + 2\\delta}{2\\varepsilon}$.\nNow we can find $J_0$:\n$$\nJ_0 = \\left(\\frac{\\varepsilon + 2\\delta}{2\\varepsilon}\\right)^{-1} = \\frac{2\\varepsilon}{\\varepsilon + 2\\delta}.\n$$\nThe problem asks for the gradient $\\psi^{\\mathrm{os}'}(x)$ for $x \\in K=\\left(0,\\frac{1}{2}\\right)$. In this interval, $A(x)=1$. The gradient is therefore:\n$$\n\\psi^{\\mathrm{os}'}(x) = -\\frac{J_0}{A(x)} = -\\frac{J_0}{1} = -J_0 = -\\frac{2\\varepsilon}{\\varepsilon + 2\\delta}.\n$$\n\nFinally, we compute the ratio $E(\\varepsilon, \\delta)$:\n$$\nE(\\varepsilon, \\delta) = \\frac{\\psi^{\\mathrm{os}'}(x)}{\\psi^{\\mathrm{id}'}(x)} \\quad \\text{for } x \\in K.\n$$\nSince both gradients are constant on $K$, we can substitute their derived values:\n$$\nE(\\varepsilon, \\delta) = \\frac{-\\frac{2\\varepsilon}{\\varepsilon + 2\\delta}}{-2} = \\frac{1}{2} \\cdot \\frac{2\\varepsilon}{\\varepsilon + 2\\delta} = \\frac{\\varepsilon}{\\varepsilon + 2\\delta}.\n$$\nTo maintain standard algebraic form, we write the denominator as $2\\delta + \\varepsilon$.\n$$\nE(\\varepsilon, \\delta) = \\frac{\\varepsilon}{2\\delta + \\varepsilon}.\n$$\nThis expression quantifies the error in the gradient of the multiscale basis function on the element $K$ due to the boundary layer effects from the material discontinuity at $x=1/2$, which are not fully captured and removed by the naive oversampling and restriction procedure.",
            "answer": "$$\\boxed{\\frac{\\varepsilon}{2\\delta + \\varepsilon}}$$"
        },
        {
            "introduction": "Having seen a potential pitfall of local computations, we now turn to a practical implementation that demonstrates the success of a well-designed oversampling strategy. This exercise guides you through building and analyzing a one-dimensional model for fluid flow through a layered medium, a common application for Mixed MsFEM. You will implement a hands-on computational surrogate for oversampling, where effective properties are calculated on enlarged domains to average out fine-scale heterogeneity. This coding practice will provide a tangible demonstration of how oversampling effectively dampens the spurious oscillations that plague non-oversampled methods, leading to a more accurate and physically meaningful coarse-scale solution .",
            "id": "3790689",
            "problem": "You are tasked with constructing and analyzing a one-dimensional layered medium in the context of the Multi-scale Finite Element Method (MsFEM), specifically its mixed formulation (Mixed MsFEM), to demonstrate how oversampling reduces spurious oscillations in the pressure approximation across layers. The physical setting is a dimensionless one-dimensional domain with coordinate $x \\in [0,1]$. The governing equations for steady Darcy flow are the constitutive relation $u(x) = -k(x) \\,\\dfrac{dp}{dx}$ and conservation of mass $\\dfrac{d u}{dx} = f(x)$, where $u(x)$ is the volumetric flux, $k(x)$ is the heterogeneous permeability, $p(x)$ is the pressure, and $f(x)$ is a source term. In this problem, take $f(x) = 0$ and impose Dirichlet boundary conditions $p(0) = 1$ and $p(1) = 0$, both dimensionless.\n\nStarting from these fundamental laws and the definition of Mixed MsFEM oversampling (which constructs multiscale velocity basis functions on enlarged patches to mitigate resonance between coarse-grid partitioning and fine-scale heterogeneity), design a computable surrogate that retains the principle of patch-based upscaling for the one-dimensional case. Specifically, discretize the domain into $N_f$ fine cells with uniform length $\\Delta x_f = \\dfrac{1}{N_f}$ and a coarse partition into $N_c$ coarse cells with uniform length $H = \\dfrac{1}{N_c}$. Define a layered medium by alternating blocks of fine cells with permeability $k_{\\mathrm{low}}$ and $k_{\\mathrm{high}}$, each block having a width of $n_{\\mathrm{per}}$ fine cells. The alternation continues until the $N_f$ fine cells are filled.\n\nTo emulate mixed oversampling in one dimension, associate to each coarse interface (between coarse cells $i$ and $i+1$) an oversampled patch consisting of the coarse-index interval $[a,b]$, where $a = \\max(0,i-m)$ and $b = \\min(N_c-1,i+1+m)$ for an oversampling size $m \\in \\mathbb{N}$. Over this patch, define the effective permeability by the series law of resistances derived from Darcyâ€™s law and flux conservation:\n$$\nk_{\\mathrm{eff}}(i+\\tfrac{1}{2};m) \\;=\\; \\frac{L_{\\mathrm{patch}}}{\\sum_{j \\in \\mathcal{J}(a,b)} \\frac{\\Delta x_f}{k_j}},\n$$\nwhere $L_{\\mathrm{patch}} = (b-a+1)\\,H$ is the physical length of the patch, $\\mathcal{J}(a,b)$ is the set of fine-cell indices covered by the patch, and $k_j$ is the permeability on fine cell $j$. The coarse transmissibility at the interface is then defined as\n$$\nT_{i+\\tfrac{1}{2}}(m) \\;=\\; \\frac{k_{\\mathrm{eff}}(i+\\tfrac{1}{2};m)}{H}.\n$$\nFor the non-oversampled case, set $m = 0$. For the oversampled case, set $m$ to a specified positive integer. Assemble the coarse two-point flux system for the pressure unknowns at coarse cell centers, $\\{p_i\\}_{i=0}^{N_c-1}$, with $p_0 = 1$ and $p_{N_c-1} = 0$ and, for $i = 1,\\dots,N_c-2$,\n$$\nT_{i+\\tfrac{1}{2}}(m) \\big( p_i - p_{i+1} \\big) + T_{i-\\tfrac{1}{2}}(m) \\big( p_i - p_{i-1} \\big) \\;=\\; 0.\n$$\nSolve this system twice: once with $m=0$ (no oversampling) to obtain $p^{(0)}$, and once with the specified oversampling size $m$ to obtain $p^{(m)}$.\n\nTo quantify spurious oscillations in the coarse pressure, use the discrete second-difference seminorm\n$$\n\\mathcal{O}(p) \\;=\\; \\sum_{i=1}^{N_c-2} \\left| p_{i+1} - 2p_i + p_{i-1} \\right|.\n$$\nSince perfectly linear coarse solutions yield $\\mathcal{O}(p) = 0$, introduce a small regularization constant $\\delta = 10^{-12}$ to avoid degeneracy when forming a reduction factor. Define the oscillation-reduction factor\n$$\nR \\;=\\; \\frac{\\mathcal{O}\\!\\left(p^{(0)}\\right) + \\delta}{\\mathcal{O}\\!\\left(p^{(m)}\\right) + \\delta}.\n$$\nYour program must implement this construction and compute $R$ for each test case in the suite below. There are no physical units in this dimensionless formulation, and all answers must be reported as dimensionless floats.\n\nImplement the layered medium and solve for the reduction factor $R$ for each of the following test cases, which are selected to cover a general case, an aligned-layer boundary case, and an extreme-contrast edge case:\n\n- Test case $1$ (general misaligned layering): $N_f=120$, $N_c=12$, $n_{\\mathrm{per}}=9$, $k_{\\mathrm{low}}=1$, $k_{\\mathrm{high}}=100$, $m=2$.\n- Test case $2$ (aligned layering with coarse cells): $N_f=120$, $N_c=12$, $n_{\\mathrm{per}}=10$, $k_{\\mathrm{low}}=1$, $k_{\\mathrm{high}}=100$, $m=2$.\n- Test case $3$ (extreme contrast, misaligned layering): $N_f=140$, $N_c=14$, $n_{\\mathrm{per}}=7$, $k_{\\mathrm{low}}=1$, $k_{\\mathrm{high}}=10^6$, $m=3$.\n\nYour program should produce a single line of output containing the reduction factors as a comma-separated list enclosed in square brackets, for example, `[r_1,r_2,r_3]`, where each $r_i$ is the computed float for the corresponding test case.",
            "solution": "The problem is founded on steady Darcy flow in one dimension with zero source, where the governing relations are $u(x) = -k(x) \\dfrac{dp}{dx}$ and $\\dfrac{d u}{dx} = 0$, leading to constant flux on any connected interval with well-posed boundary conditions. In a heterogeneous layered medium, the exact fine-scale solution has piecewise linear pressure with slope determined by the local permeability and the constant flux. For a sequence of layers in series, classical homogenization in one dimension gives the effective permeability over an interval $I$:\n$$\nk_{\\mathrm{eff}}(I) \\;=\\; \\frac{|I|}{\\int_I \\dfrac{1}{k(x)} \\, dx},\n$$\nwhich is the harmonic average in continuous form. This result follows from the series law for resistances: for piecewise constant $k(x)$ on fine cells of length $\\Delta x_f$, the resistance of cell $j$ is $R_j = \\dfrac{\\Delta x_f}{k_j}$, so the net resistance over $I$ is $R_I = \\sum_j R_j$, with the flux under a unit pressure drop given by $q = \\dfrac{1}{R_I}$ and thus $k_{\\mathrm{eff}} = \\dfrac{|I|}{R_I}$.\n\nMixed Multi-scale Finite Element Method (Mixed MsFEM) constructs multiscale velocity basis functions that respect $u = -k \\nabla p$ and $\\nabla \\cdot u = 0$, and couples them with a coarse pressure space, typically piecewise constants or low-order polynomials. A central issue is resonance error: when coarse-grid cells are not aligned with the fine-scale heterogeneity, basis functions computed on minimal local cells can imprint the artificial boundary conditions used in local solves, which inject spurious oscillations into the coarse pressure solution. Mixed oversampling mitigates this by solving local basis problems on enlarged patches, so that artificial boundary effects decay within the oversampled interior region where the basis is then restricted.\n\nIn one dimension, we can capture the essence of mixed oversampling with a transmissibility-based surrogate derived from first principles. For the coarse interface between cells $i$ and $i+1$, we define an oversampled patch $[a,b]$ of coarse cells, with $a = \\max(0,i-m)$ and $b = \\min(N_c-1,i+1+m)$. Over this patch, we invoke the series law to compute $k_{\\mathrm{eff}}(i+\\tfrac{1}{2};m) = \\dfrac{L_{\\mathrm{patch}}}{\\sum_{j \\in \\mathcal{J}(a,b)} \\frac{\\Delta x_f}{k_j}}$, where $L_{\\mathrm{patch}} = (b-a+1)H$ and $\\mathcal{J}(a,b)$ is the set of fine-cell indices belonging to the union of coarse cells $a$ through $b$. The transmissibility at the interface, which relates the flux to the pressure drop across that interface, is then set to\n$$\nT_{i+\\tfrac{1}{2}}(m) \\;=\\; \\frac{k_{\\mathrm{eff}}(i+\\tfrac{1}{2};m)}{H}.\n$$\nThis scaling is consistent with the two-point flux discretization in one dimension: if a segment of length $H$ has effective permeability $\\kappa$, then under a pressure drop $\\Delta p$ across $H$, the flux is $q = \\kappa \\dfrac{\\Delta p}{H}$, yielding $T = \\dfrac{\\kappa}{H}$.\n\nWith $T_{i+\\tfrac{1}{2}}(m)$ defined, the coarse pressure equations for interior cells are\n$$\nT_{i+\\tfrac{1}{2}}(m)\\,(p_i - p_{i+1}) + T_{i-\\tfrac{1}{2}}(m)\\,(p_i - p_{i-1}) \\;=\\; 0,\\quad i = 1,\\dots,N_c-2,\n$$\nwith Dirichlet boundaries $p_0 = 1$ and $p_{N_c-1} = 0$. This is a tridiagonal linear system. Solving it for $m=0$ gives $p^{(0)}$, and solving it for the specified $m$ gives $p^{(m)}$.\n\nTo measure spurious oscillations, we use the discrete second-difference seminorm\n$$\n\\mathcal{O}(p) \\;=\\; \\sum_{i=1}^{N_c-2} \\left| p_{i+1} - 2p_i + p_{i-1} \\right|.\n$$\nFor a perfectly linear pressure sequence, second differences vanish, so $\\mathcal{O}(p) = 0$. In practice, misalignment between coarse interfaces and fine-scale layers produces alternating variations in the local transmissibilities, causing $p$ to deviate from linearity and $\\mathcal{O}(p)$ to be strictly positive. To avoid division by zero in cases where oversampling achieves near-perfect linearity, we introduce a small regularization constant $\\delta = 10^{-12}$ and define the reduction factor as\n$$\nR \\;=\\; \\frac{\\mathcal{O}\\!\\left(p^{(0)}\\right) + \\delta}{\\mathcal{O}\\!\\left(p^{(m)}\\right) + \\delta}.\n$$\nValues $R > 1$ indicate that oversampling reduces oscillations relative to the non-oversampled case. The choice of layered media and coarse/fine grids in the test suite is designed to exhibit three behaviors: a general misaligned scenario (where resonance is present and oversampling helps), an aligned scenario (where resonance is minimized and oversampling yields little improvement), and an extreme-contrast, misaligned scenario (where oversampling yields a pronounced reduction).\n\nAlgorithmic steps that implement the principle-based derivation:\n- Define $N_f$, $N_c$, $n_{\\mathrm{per}}$, $k_{\\mathrm{low}}$, $k_{\\mathrm{high}}$, and $m$.\n- Construct the fine-scale permeability array $\\{k_j\\}_{j=0}^{N_f-1}$ by alternating blocks of length $n_{\\mathrm{per}}$ with values $k_{\\mathrm{low}}$ and $k_{\\mathrm{high}}$ until $N_f$ cells are filled.\n- Compute transmissibilities $\\{T_{i+\\tfrac{1}{2}}(m)\\}_{i=0}^{N_c-2}$ via the oversampled patch formula for both $m=0$ and the given $m$.\n- Assemble and solve the tridiagonal coarse system for $p^{(0)}$ and $p^{(m)}$ with $p_0 = 1$ and $p_{N_c-1} = 0$.\n- Compute $\\mathcal{O}\\!\\left(p^{(0)}\\right)$ and $\\mathcal{O}\\!\\left(p^{(m)}\\right)$, and then compute $R$ using the regularized ratio.\n- Repeat for each test case and output the list $[R_1, R_2, R_3]$.\n\nThis approach adheres to the fundamental laws of Darcy flow and mass conservation, uses the well-tested harmonic averaging for series media, and captures the essence of mixed oversampling in one dimension by enlarging the patch over which local effective properties are computed. The enlarged patches damp the artificial boundary effects that would otherwise yield oscillatory transmissibility coefficients and, consequently, oscillatory coarse pressures, thus demonstrating the reduction in spurious oscillations due to oversampling.\n\n### Implementation\n```python\n# Python 3.12 code using numpy 1.23.5, no external files or input.\nimport numpy as np\n\ndef build_layered_k(Nf, n_per, k_low, k_high):\n    \"\"\"\n    Build a fine-scale permeability array of length Nf by alternating blocks:\n    n_per cells of k_low, then n_per cells of k_high, repeating until filled.\n    \"\"\"\n    k = np.empty(Nf, dtype=float)\n    vals = [k_low] * n_per + [k_high] * n_per\n    idx = 0\n    vlen = len(vals)\n    for j in range(Nf):\n        k[j] = vals[idx]\n        idx += 1\n        if idx == vlen:\n            idx = 0\n    return k\n\ndef transmissibilities(k, Nf, Nc, m):\n    \"\"\"\n    Compute coarse-edge transmissibilities T_{i+1/2}(m) for i=0..Nc-2\n    using oversampled patches defined on coarse cells.\n\n    - Fine cell length: dx_f = 1.0 / Nf\n    - Coarse cell length: H = 1.0 / Nc\n    - Each coarse cell contains F = Nf // Nc fine cells (assumed integer).\n    \"\"\"\n    F = Nf // Nc\n    dx_f = 1.0 / Nf\n    H = 1.0 / Nc\n    T = np.empty(Nc - 1, dtype=float)\n\n    # Precompute cumulative sums of (dx_f / k_j) for fast patch resistance queries.\n    resist = dx_f / k\n    cumR = np.zeros(Nf + 1, dtype=float)\n    cumR[1:] = np.cumsum(resist)\n\n    for i in range(Nc - 1):\n        a = max(0, i - m)\n        b = min(Nc - 1, i + 1 + m)\n        # Fine index range for coarse cells [a..b]: j in [a*F .. (b+1)*F - 1]\n        j_start = a * F\n        j_end = (b + 1) * F  # exclusive\n        # Patch length\n        L_patch = (b - a + 1) * H\n        # Patch resistance: sum_{j=j_start}^{j_end-1} dx_f / k_j\n        R_patch = cumR[j_end] - cumR[j_start]\n        k_eff_patch = L_patch / R_patch\n        T[i] = k_eff_patch / H\n    return T\n\ndef solve_coarse_pressure(T, Nc):\n    \"\"\"\n    Solve the coarse pressure system with Dirichlet boundary conditions:\n    p0 = 1.0, p_{Nc-1} = 0.0\n\n    Interior equations for i=1..Nc-2:\n        T_{i+1/2}(p_i - p_{i+1}) + T_{i-1/2}(p_i - p_{i-1}) = 0\n    \"\"\"\n    n = Nc - 2\n    if n = 0:\n        # Trivial case with only boundaries\n        return np.array([1.0] + [0.0]*(Nc-1), dtype=float)\n\n    A = np.zeros((n, n), dtype=float)\n    b = np.zeros(n, dtype=float)\n    # Indices:\n    # Interior unknowns are p[1]..p[Nc-2], map to rows 0..n-1\n    for row in range(n):\n        i = row + 1  # actual coarse index\n        T_left = T[i - 1]        # T_{i-1/2}\n        T_right = T[i] if i  Nc - 1 else 0.0  # T_{i+1/2}, valid for i=Nc-2\n\n        # Diagonal\n        A[row, row] = T_left + T_right\n\n        # Left neighbor (i-1): could be boundary at i=1\n        if i - 1 == 0:\n            b[row] += T_left * 1.0  # p0 = 1.0\n        else:\n            A[row, row - 1] = -T_left\n\n        # Right neighbor (i+1): could be boundary at i=Nc-2\n        if i + 1 == Nc - 1:\n            # p_{Nc-1} = 0.0, contributes nothing to b\n            pass\n        else:\n            A[row, row + 1] = -T_right\n\n    p_interior = np.linalg.solve(A, b)\n    p = np.zeros(Nc, dtype=float)\n    p[0] = 1.0\n    p[-1] = 0.0\n    p[1:Nc-1] = p_interior\n    return p\n\ndef oscillation_metric(p):\n    \"\"\"\n    Compute discrete second-difference seminorm:\n        O(p) = sum_{i=1}^{Nc-2} |p_{i+1} - 2 p_i + p_{i-1}|\n    \"\"\"\n    # Requires Nc >= 3\n    if p.size  3:\n        return 0.0\n    second_diff = p[2:] - 2.0 * p[1:-1] + p[:-2]\n    return np.sum(np.abs(second_diff))\n\ndef run_case(Nf, Nc, n_per, k_low, k_high, m):\n    k = build_layered_k(Nf, n_per, k_low, k_high)\n    # No oversampling\n    T0 = transmissibilities(k, Nf, Nc, m=0)\n    p0 = solve_coarse_pressure(T0, Nc)\n    O0 = oscillation_metric(p0)\n    # Oversampling\n    Tm = transmissibilities(k, Nf, Nc, m=m)\n    pm = solve_coarse_pressure(Tm, Nc)\n    Om = oscillation_metric(pm)\n    delta = 1e-12\n    R = (O0 + delta) / (Om + delta)\n    return R\n\ndef solve():\n    test_cases = [\n        # Test case 1: Nf=120, Nc=12, n_per=9, k_low=1, k_high=100, m=2\n        (120, 12, 9, 1.0, 100.0, 2),\n        # Test case 2: Nf=120, Nc=12, n_per=10, k_low=1, k_high=100, m=2\n        (120, 12, 10, 1.0, 100.0, 2),\n        # Test case 3: Nf=140, Nc=14, n_per=7, k_low=1, k_high=1e6, m=3\n        (140, 14, 7, 1.0, 1e6, 3),\n    ]\n\n    results = []\n    for case in test_cases:\n        Nf, Nc, n_per, k_low, k_high, m = case\n        result = run_case(Nf, Nc, n_per, k_low, k_high, m)\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```",
            "answer": "[37.76011162489467,1.0,808.3150531557348]"
        },
        {
            "introduction": "We have established that oversampling is a powerful tool, but its benefits come at an increased computational cost. This raises a crucial design question: how large should the oversampling domain be? This final practice addresses this by framing the choice of the oversampling radius, $\\delta$, as a formal optimization problem. You will analyze the fundamental trade-off between the computational cost, which grows with $\\delta$, and the modeling error, which decays exponentially. By deriving an analytical expression for the optimal radius $\\delta(H)$, you will learn how to balance accuracy and efficiency, a core skill in the design of any practical numerical method .",
            "id": "3790708",
            "problem": "Consider the scalar, second-order, linear elliptic boundary value problem posed on a bounded Lipschitz domain $\\Omega \\subset \\mathbb{R}^{d}$ with $d \\in \\{2,3\\}$,\n$$\n-\\nabla \\cdot \\big(a\\big(\\tfrac{x}{\\varepsilon}\\big)\\nabla u(x)\\big) = f(x)\\quad \\text{in }\\Omega,\\qquad u=0\\quad \\text{on }\\partial\\Omega,\n$$\nwhere $\\varepsilon  0$ is a small microscale parameter and $a(y)$ is a uniformly elliptic, bounded, measurable tensor with $\\lambda |\\xi|^{2} \\le \\xi^{\\top} a(y)\\,\\xi \\le \\Lambda |\\xi|^{2}$ for some $0\\lambda\\le\\Lambda\\infty$ and all $\\xi\\in\\mathbb{R}^{d}$, $y\\in\\mathbb{R}^{d}$. In the Multiscale Finite Element Method (MsFEM), let $H0$ denote the coarse mesh size and $\\delta \\ge H$ the oversampling radius used to construct local basis functions on enlarged patches. It is a well-tested fact in the MsFEM oversampling literature that:\n- The computational cost of constructing all local oversampled basis functions scales like $O\\big(H^{-d}(\\delta/H)^{d}\\big)$.\n- The global energy-norm discretization error can be bounded as $O\\big(H+\\exp(-c\\,\\delta/\\varepsilon)\\big)$, for some constant $c0$ independent of $H$, $\\delta$, and $\\varepsilon$.\n\nAssume you aim for an overall accuracy that is asymptotically dominated by the coarse-mesh contribution so that the boundary-layer term is required not to exceed a fixed proportion of the coarse error, namely $\\exp(-c\\,\\delta/\\varepsilon)\\le K\\,H$ for a fixed constant $K\\in(0,1]$ independent of $H$, $\\delta$, and $\\varepsilon$. Among all functions $\\delta(H)$ satisfying this asymptotic accuracy requirement, propose the choice of $\\delta(H)$ that asymptotically minimizes the stated computational cost scaling by exploiting the monotonicity of the cost in $\\delta$. Provide your final answer as a closed-form analytic expression for $\\delta(H)$ in terms of $H$, $\\varepsilon$, $c$, and $K$. No numerical evaluation is required and no units are involved in the answer.",
            "solution": "The starting point is the coercive elliptic model problem with rapidly oscillating coefficients at scale $\\varepsilon$. In the Multiscale Finite Element Method (MsFEM), oversampling constructs local basis functions on patches larger than the coarse elements to mitigate boundary effects. Two widely accepted and well-tested scaling relations govern the design trade-off:\n1. The computational cost to assemble all local oversampled basis functions across the domain scales like\n$$\n\\mathcal{C}(H,\\delta)\\sim H^{-d}\\left(\\frac{\\delta}{H}\\right)^{d},\n$$\nbecause there are $O(H^{-d})$ coarse elements and each local solve within an oversampled patch has volume scaling like $O(\\delta^{d})$ relative to the element volume $O(H^{d})$.\n2. The energy-norm error (or equivalently an $H^{1}$-seminorm bound) scales like\n$$\n\\mathcal{E}(H,\\delta)\\sim H+\\exp\\!\\left(-c\\,\\frac{\\delta}{\\varepsilon}\\right),\n$$\nwhere the first term $H$ is the coarse discretization error and the second term reflects the exponential decay of boundary-layer mismatch due to oversampling.\n\nThe design objective is to achieve accuracy asymptotically dominated by the coarse-mesh contribution, which is stated by the requirement\n$$\n\\exp\\!\\left(-c\\,\\frac{\\delta}{\\varepsilon}\\right)\\le K\\,H,\n$$\nfor a fixed $K\\in(0,1]$. This constraint ensures that the oversampling-induced boundary-layer term does not exceed a fixed proportion of the coarse error, so that $\\mathcal{E}(H,\\delta)\\sim H$ as $H\\to 0$.\n\nGiven that the computational cost $\\mathcal{C}(H,\\delta)$ is strictly increasing in $\\delta$ for fixed $H$ (because $\\delta/H\\ge 1$ and the exponent $d0$), the cost-minimizing choice under the inequality constraint is attained at the smallest $\\delta$ that still satisfies the constraint, i.e., by enforcing the constraint with equality:\n$$\n\\exp\\!\\left(-c\\,\\frac{\\delta}{\\varepsilon}\\right)=K\\,H.\n$$\nSolving for $\\delta$ yields\n$$\n-c\\,\\frac{\\delta}{\\varepsilon}=\\ln(K\\,H)\\quad\\Longrightarrow\\quad \\delta(H)=\\frac{\\varepsilon}{c}\\,\\ln\\!\\left(\\frac{1}{K\\,H}\\right).\n$$\nThis expression is positive for all sufficiently small $H$ because $K\\,H\\in(0,1]$ and thus $\\ln\\!\\big(\\frac{1}{K\\,H}\\big)\\ge 0$, and it satisfies $\\delta(H)\\ge H$ asymptotically for small $H$ provided $H$ is not exponentially small compared to $\\varepsilon/c$; more precisely, the requirement $\\delta(H)\\ge H$ can be checked case-by-case if needed, but the oversampling literature typically allows choosing $\\delta$ multiple of $H$ or larger, and the derived $\\delta(H)$ grows logarithmically as $H\\to 0$.\n\nSubstituting this choice back into the error scaling yields\n$$\n\\mathcal{E}\\big(H,\\delta(H)\\big)\\sim H+\\exp\\!\\left(-c\\,\\frac{(\\varepsilon/c)\\ln(1/(K\\,H))}{\\varepsilon}\\right)=H+\\exp\\!\\big(-\\ln(1/(K\\,H))\\big)=H+K\\,H\\sim H,\n$$\nshowing the intended balance. The induced computational cost scales as\n$$\n\\mathcal{C}\\big(H,\\delta(H)\\big)\\sim H^{-d}\\left(\\frac{\\delta(H)}{H}\\right)^{d}\n=H^{-d}\\left(\\frac{1}{H}\\cdot\\frac{\\varepsilon}{c}\\,\\ln\\!\\left(\\frac{1}{K\\,H}\\right)\\right)^{d}\n\\sim \\left(\\frac{\\varepsilon}{c}\\right)^{d} H^{-2d}\\left[\\ln\\!\\left(\\frac{1}{K\\,H}\\right)\\right]^{d},\n$$\nmaking explicit the trade-off: achieving an error $\\sim H$ incurs a computational cost that grows like $H^{-2d}$ up to a logarithmic factor in $H$. Because any larger $\\delta$ would strictly increase $\\mathcal{C}(H,\\delta)$ while leaving the error dominated by $H$, the proposed $\\delta(H)$ is optimal (in the sense of minimizing cost under the stated accuracy constraint).\n\nTherefore, the cost-minimizing oversampling radius as a function of $H$ is\n$$\n\\delta(H)=\\frac{\\varepsilon}{c}\\,\\ln\\!\\left(\\frac{1}{K\\,H}\\right).\n$$",
            "answer": "$$\\boxed{\\frac{\\varepsilon}{c}\\,\\ln\\!\\left(\\frac{1}{K\\,H}\\right)}$$"
        }
    ]
}