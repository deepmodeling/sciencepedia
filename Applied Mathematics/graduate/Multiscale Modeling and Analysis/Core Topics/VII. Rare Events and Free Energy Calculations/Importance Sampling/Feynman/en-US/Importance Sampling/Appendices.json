{
    "hands_on_practices": [
        {
            "introduction": "To begin, we will ground our understanding by computing the variance of a basic importance sampling estimator. This exercise is designed to build your fluency with the core mechanics, starting from the definition of the unnormalized estimator and applying the standard formula for variance. Mastering this foundational calculation  is the first step toward developing an intuition for how and why importance sampling works.",
            "id": "767758",
            "problem": "In importance sampling, we aim to estimate an expectation $I = E_p[f(x)] = \\int f(x) p(x) dx$ with respect to a target probability distribution $p(x)$. This is done by sampling from a different, simpler proposal distribution $q(x)$ and re-weighting the samples. The expectation can be rewritten as $I = E_q\\left[f(x) \\frac{p(x)}{q(x)}\\right]$.\n\nIn many practical scenarios, the target distribution $p(x)$ is only known up to a normalization constant, i.e., $p(x) = \\tilde{p}(x) / Z_p$, where $\\tilde{p}(x)$ is a known, unnormalized density and $Z_p = \\int \\tilde{p}(x) dx$ may be difficult to compute.\n\nA related but simpler task is to estimate the unnormalized integral $I' = \\int f(x) \\tilde{p}(x) dx$. A single-sample Monte Carlo estimator for $I'$ can be constructed using a sample $X$ drawn from the proposal distribution $q(x)$. This estimator is the random variable $Y = f(X) \\frac{\\tilde{p}(X)}{q(X)}$. The expectation of this estimator is $E_q[Y] = I'$.\n\nYour task is to derive the variance of this single-sample estimator, $Var_q(Y)$.\n\nUse the following specifications:\n- The unnormalized target density is given by $\\tilde{p}(x) = x^{\\alpha-1}(1-x)^{\\beta-1}$ for $x \\in [0, 1]$, with parameters $\\alpha=2$ and $\\beta=2$. This corresponds to an unnormalized Beta distribution.\n- The function of interest is $f(x) = x$.\n- The proposal distribution is given by the probability density function $q(x) = (\\gamma+1)x^{\\gamma}$ for $x \\in [0, 1]$, with parameter $\\gamma=1$.",
            "solution": "The problem asks for the variance of the single-sample importance sampling estimator $Y = f(X) \\frac{\\tilde{p}(X)}{q(X)}$, where the sample $X$ is drawn from the proposal distribution $q(x)$.\n\nFirst, let's establish the specific forms of the functions based on the given parameters.\nThe unnormalized target density is $\\tilde{p}(x) = x^{\\alpha-1}(1-x)^{\\beta-1}$ with $\\alpha=2, \\beta=2$.\n$$ \\tilde{p}(x) = x^{2-1}(1-x)^{2-1} = x(1-x) $$\nThe function of interest is:\n$$ f(x) = x $$\nThe proposal distribution is $q(x) = (\\gamma+1)x^{\\gamma}$ with $\\gamma=1$.\n$$ q(x) = (1+1)x^1 = 2x $$\nThis is a valid probability density function on $[0,1]$ since $\\int_0^1 2x dx = [x^2]_0^1 = 1$.\n\nThe single-sample estimator is the random variable $Y$, where $X \\sim q(x)$.\n$$ Y = f(X) \\frac{\\tilde{p}(X)}{q(X)} = X \\cdot \\frac{X(1-X)}{2X} = \\frac{X(1-X)}{2} $$\nNote that the factor of $X$ from $f(X)$ and one from $\\tilde{p}(X)$ cancels with the $X$ in $q(X)$.\n\nThe variance of $Y$ is given by the formula:\n$$ Var_q(Y) = E_q[Y^2] - (E_q[Y])^2 $$\nWe need to compute the first and second moments of $Y$ with respect to the proposal distribution $q(x)$.\n\n**1. Calculate the first moment, $E_q[Y]$:**\nThe expectation $E_q[Y]$ is calculated by integrating $Y(x)$ against the proposal density $q(x)$.\n$$ E_q[Y] = \\int_0^1 Y(x) q(x) dx = \\int_0^1 \\left(\\frac{x(1-x)}{2}\\right) (2x) dx $$\n$$ E_q[Y] = \\int_0^1 x^2(1-x) dx = \\int_0^1 (x^2 - x^3) dx $$\n$$ E_q[Y] = \\left[ \\frac{x^3}{3} - \\frac{x^4}{4} \\right]_0^1 = \\left(\\frac{1}{3} - \\frac{1}{4}\\right) - 0 = \\frac{4-3}{12} = \\frac{1}{12} $$\n\n**2. Calculate the second moment, $E_q[Y^2]$:**\nFirst, we find the expression for $Y^2$.\n$$ Y^2 = \\left(\\frac{X(1-X)}{2}\\right)^2 = \\frac{X^2(1-X)^2}{4} $$\nThe expectation $E_q[Y^2]$ is then:\n$$ E_q[Y^2] = \\int_0^1 Y(x)^2 q(x) dx = \\int_0^1 \\left(\\frac{x^2(1-x)^2}{4}\\right) (2x) dx $$\n$$ E_q[Y^2] = \\frac{1}{2} \\int_0^1 x^3(1-x)^2 dx = \\frac{1}{2} \\int_0^1 x^3(1 - 2x + x^2) dx $$\n$$ E_q[Y^2] = \\frac{1}{2} \\int_0^1 (x^3 - 2x^4 + x^5) dx $$\n$$ E_q[Y^2] = \\frac{1}{2} \\left[ \\frac{x^4}{4} - \\frac{2x^5}{5} + \\frac{x^6}{6} \\right]_0^1 = \\frac{1}{2} \\left(\\frac{1}{4} - \\frac{2}{5} + \\frac{1}{6}\\right) $$\nTo evaluate the expression in the parenthesis, we find a common denominator, which is 60.\n$$ E_q[Y^2] = \\frac{1}{2} \\left(\\frac{15}{60} - \\frac{24}{60} + \\frac{10}{60}\\right) = \\frac{1}{2} \\left(\\frac{15 - 24 + 10}{60}\\right) = \\frac{1}{2} \\left(\\frac{1}{60}\\right) = \\frac{1}{120} $$\n\n**3. Calculate the variance, $Var_q(Y)$:**\nNow, we substitute the moments back into the variance formula.\n$$ Var_q(Y) = E_q[Y^2] - (E_q[Y])^2 = \\frac{1}{120} - \\left(\\frac{1}{12}\\right)^2 $$\n$$ Var_q(Y) = \\frac{1}{120} - \\frac{1}{144} $$\nTo subtract the fractions, we find a common denominator for 120 and 144.\n$120 = 12 \\times 10 = (2^2 \\times 3) \\times (2 \\times 5) = 2^3 \\times 3 \\times 5$\n$144 = 12^2 = (2^2 \\times 3)^2 = 2^4 \\times 3^2$\nThe least common multiple is $2^4 \\times 3^2 \\times 5 = 16 \\times 9 \\times 5 = 144 \\times 5 = 720$.\n$$ Var_q(Y) = \\frac{1 \\times (720/120)}{720} - \\frac{1 \\times (720/144)}{720} = \\frac{6}{720} - \\frac{5}{720} $$\n$$ Var_q(Y) = \\frac{6-5}{720} = \\frac{1}{720} $$",
            "answer": "$$\\boxed{\\frac{1}{720}}$$"
        },
        {
            "introduction": "Building on the basics, our next practice explores the crucial relationship between the proposal distribution and the estimator's performance. Here, we analyze how the variance of an estimator for a Gaussian moment changes as we adjust a parameter in our Gaussian proposal distribution. This exercise  demonstrates a vital principle: the success of importance sampling hinges on a carefully chosen proposal, as a poor choice can dramatically, or even infinitely, increase variance.",
            "id": "767801",
            "problem": "Importance Sampling is a variance reduction technique used in Monte Carlo methods to estimate properties of a particular distribution, while sampling from a different distribution. Consider the problem of estimating the expectation $I = E_p[h(x)]$, where $p(x)$ is the target probability density function (PDF) and $h(x)$ is a function of interest. Instead of drawing samples from $p(x)$, we draw $N$ samples $\\{x_i\\}_{i=1}^N$ from a proposal distribution $q(x)$. The expectation is then estimated using the importance sampling estimator:\n$$\n\\hat{I}_N = \\frac{1}{N} \\sum_{i=1}^N w(x_i) h(x_i)\n$$\nwhere $w(x) = \\frac{p(x)}{q(x)}$ are the importance weights. The estimator is unbiased, i.e., $E_q[\\hat{I}_N] = I$. The variance of the estimator for a single sample ($N=1$) is given by $\\text{Var}_q(w(X)h(X))$, where $X \\sim q(x)$.\n\n**Problem:**\nLet the target distribution $p(x)$ be the standard normal distribution, $\\mathcal{N}(x|0, 1)$, whose PDF is $p(x) = \\frac{1}{\\sqrt{2\\pi}} e^{-x^2/2}$. We wish to estimate the fourth moment of this distribution, corresponding to the function $h(x) = x^4$.\n\nThe proposal distribution $q(x)$ is chosen to be a zero-mean normal distribution with a different variance $\\sigma_q^2$, i.e., $q(x) = \\mathcal{N}(x|0, \\sigma_q^2)$, with PDF $q(x) = \\frac{1}{\\sqrt{2\\pi}\\sigma_q} e^{-x^2/(2\\sigma_q^2)}$.\n\nDerive a closed-form expression for the variance of the single-sample importance sampling estimator, $\\text{Var}_q(w(X)h(X))$, as a function of $\\sigma_q$. You may assume that the variance is finite, which holds for $\\sigma_q^2 > 1/2$.",
            "solution": "1. The variance is  \n$$\n\\mathrm{Var}_q\\bigl(w(X)h(X)\\bigr)\n=E_q\\bigl[(w(X)h(X))^2\\bigr]-\\bigl(E_q[w(X)h(X)]\\bigr)^2.\n$$\nSince $h(x)=x^4$, $w(x)=\\frac{p(x)}{q(x)}$, and $I=E_p[x^4]=3$, we need \n$$\nE_q\\bigl[(w(X)x^4)^2\\bigr]\n=\\int q(x)\\Bigl(\\frac{p(x)}{q(x)}\\Bigr)^2 x^8\\,dx\n=\\int \\frac{p(x)^2}{q(x)}\\,x^8\\,dx.\n$$\n\n2. Substitute the Gaussian densities:\n$$\np(x)=\\frac{1}{\\sqrt{2\\pi}}e^{-x^2/2},\\quad\nq(x)=\\frac{1}{\\sqrt{2\\pi}\\,\\sigma_q}e^{-x^2/(2\\sigma_q^2)}.\n$$\nThen\n$$\n\\frac{p(x)^2}{q(x)}\n=\\frac{\\frac1{2\\pi}e^{-x^2}}{\\frac1{\\sqrt{2\\pi}\\,\\sigma_q}e^{-x^2/(2\\sigma_q^2)}}\n=\\frac{\\sigma_q}{\\sqrt{2\\pi}}\\,e^{-x^2\\bigl(1-\\tfrac1{2\\sigma_q^2}\\bigr)}.\n$$\n\n3. Let \n$$\na=1-\\frac1{2\\sigma_q^2}=\\frac{2\\sigma_q^2-1}{2\\sigma_q^2},\\quad\n\\int_{-\\infty}^{\\infty}x^8e^{-a x^2}dx\n=\\frac{7!!}{2^4}\\,a^{-4-\\frac12}\\sqrt\\pi\n=\\frac{105\\sqrt\\pi}{16\\,a^{9/2}}.\n$$\nThus\n$$\nE_q\\bigl[(w(X)x^4)^2\\bigr]\n=\\frac{\\sigma_q}{\\sqrt{2\\pi}}\\cdot\\frac{105\\sqrt\\pi}{16\\,a^{9/2}}\n=\\frac{105\\,\\sigma_q}{16\\sqrt2\\,a^{9/2}}\n=\\frac{105\\,\\sigma_q^{10}}{(2\\sigma_q^2-1)^{9/2}}.\n$$\n\n4. Hence\n$$\n\\mathrm{Var}_q(w(X)x^4)\n=\\frac{105\\,\\sigma_q^{10}}{(2\\sigma_q^2-1)^{9/2}}-3^2\n=\\frac{105\\,\\sigma_q^{10}}{(2\\sigma_q^2-1)^{9/2}}-9.\n$$",
            "answer": "$$\\boxed{\\frac{105\\,\\sigma_q^{10}}{(2\\sigma_q^2-1)^{9/2}}-9}$$"
        },
        {
            "introduction": "In our final exercise, we shift from analyzing variance to actively minimizing itâ€”the ultimate goal of designing an efficient Monte Carlo method. You will determine the optimal parameter for a proposal distribution that minimizes the estimator's variance for a given integration problem. This practice  synthesizes our learning by using calculus to find the most efficient sampling strategy, illustrating the power of importance sampling to dramatically improve computational accuracy.",
            "id": "767686",
            "problem": "Importance sampling is a variance reduction technique used in Monte Carlo methods to estimate properties of a distribution. A primary application is the estimation of an integral $I = \\int h(x) dx$. The integral is rewritten as an expectation with respect to a proposal probability distribution $q(x)$, from which it is easy to draw samples:\n$$I = \\int \\frac{h(x)}{q(x)} q(x) dx = E_q\\left[\\frac{h(x)}{q(x)}\\right]$$\nThe quantity $w(x) = h(x)/q(x)$ can be thought of as a corrected value, and its expectation under $q(x)$ is the desired integral $I$. The variance of a single-sample Monte Carlo estimator $\\hat{I}(x) = w(x)$ where $x \\sim q(x)$ is given by:\n$$ \\text{Var}_q(\\hat{I}) = E_q[\\hat{I}^2] - (E_q[\\hat{I}])^2 $$\nSince $E_q[\\hat{I}] = I$ is a constant, minimizing the variance is equivalent to minimizing the second moment, $V = E_q[\\hat{I}^2]$.\n\nConsider the problem of estimating the integral\n$$I = \\int_0^\\infty x^a e^{-bx} dx$$\nwhere $a$ and $b$ are real-valued parameters satisfying $a > -1/2$ and $b > 0$.\n\nFor this estimation, we employ an exponential proposal distribution parameterized by $\\theta$:\n$$q(x; \\theta) = \\theta e^{-\\theta x}, \\quad x \\ge 0, \\theta > 0$$\nThe single-sample estimator is $\\hat{I}(x) = \\frac{x^a e^{-bx}}{q(x; \\theta)}$.\n\nDerive the value of the parameter $\\theta$ that minimizes the variance of this estimator.",
            "solution": "1. We have the single-sample weight  \n$$w(x)=\\frac{x^a e^{-b x}}{q(x;\\theta)}=\\frac{x^a e^{-b x}}{\\theta e^{-\\theta x}}=\\frac{x^a}{\\theta}e^{-(b-\\theta)x}\\,. $$  \nThus the second moment under $q$ is  \n$$V(\\theta)=E_q[w(x)^2]\n=\\int_0^\\infty \\frac{x^{2a}}{\\theta^2}e^{-2(b-\\theta)x}\\,\\theta e^{-\\theta x}dx\n=\\frac{1}{\\theta}\\int_0^\\infty x^{2a}e^{-(2b-\\theta)x}dx\\,. $$  \n2. Use the gamma-integral  \n$$\\int_0^\\infty x^{2a}e^{-\\gamma x}dx=\\frac{\\Gamma(2a+1)}{\\gamma^{2a+1}}\\,,\\quad \\Re(\\gamma)>0,$$  \nwith $\\gamma=2b-\\theta$. Hence  \n$$V(\\theta)\n=\\frac{\\Gamma(2a+1)}{\\theta\\,(2b-\\theta)^{2a+1}}\\,. $$  \n3. Differentiate $V(\\theta)$ w.r.t.\\ $\\theta$ and set to zero:  \n$$\\frac{dV}{d\\theta}\n=\\Gamma(2a+1)\\frac{d}{d\\theta}\\Bigl[\\theta^{-1}(2b-\\theta)^{-(2a+1)}\\Bigr]\n=0\\,.$$  \nCompute the derivative:  \n$$\\frac{dV}{d\\theta}\n=\\Gamma(2a+1)\\theta^{-2}(2b-\\theta)^{-(2a+2)}\\Bigl[-(2b-\\theta)+\\theta(2a+1)\\Bigr]=0\\,.$$  \nThus the bracket must vanish:  \n$$-(2b-\\theta)+\\theta(2a+1)=0\n\\;\\Longrightarrow\\;\\theta(2a+2)=2b\n\\;\\Longrightarrow\\;\\theta^*=\\frac{2b}{2(a+1)}=\\frac{b}{a+1}\\,. $$",
            "answer": "$$\\boxed{\\frac{b}{a+1}}$$"
        }
    ]
}