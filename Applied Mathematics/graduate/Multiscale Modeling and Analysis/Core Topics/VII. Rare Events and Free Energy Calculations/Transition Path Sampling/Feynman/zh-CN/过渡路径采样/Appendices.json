{
    "hands_on_practices": [
        {
            "introduction": "“打点”移动 (shooting move) 是过渡路径抽样中生成新的、去相关的过渡路径的主要机制。整个模拟的有效性取决于此移动的正确接受准则，该准则必须维持路径系综的细致平衡。本练习  将引导您推导其接受概率，揭示它与微正则 (NVE) 和正则 (NVT) 系综中统计力学基本原理的直接联系。",
            "id": "3826162",
            "problem": "考虑一个包含 $N$ 个粒子的系统，其哈密顿量为 $H(\\mathbf{q},\\mathbf{p}) = K(\\mathbf{p}) + U(\\mathbf{q})$，其中 $K(\\mathbf{p}) = \\sum_{i=1}^{N} \\frac{|\\mathbf{p}_{i}|^{2}}{2 m_{i}}$ 是动能，$U(\\mathbf{q})$ 是光滑的势能。在过渡路径采样中，通过选择一个发射时间 $t^{\\star}$ 和相点 $x^{\\star} = (\\mathbf{q}^{\\star}, \\mathbf{p}^{\\star})$ 来构造发射移动 (shooting move)，然后通过对称高斯微扰提出新的动量\n$$\n\\mathbf{p}^{\\text{prop}} = \\mathbf{p}^{\\star} + \\boldsymbol{\\eta}, \\quad \\boldsymbol{\\eta} \\sim \\mathcal{N}\\big( \\mathbf{0}, \\sigma^{2} \\mathbf{M} \\big),\n$$\n其中 $\\mathbf{M}$ 是一个对角质量矩阵，其元素为 $m_{i}$，且 $\\sigma > 0$。对于微正则（恒定能量，牛顿）动力学（记为 NVE），会施加一个标量速度重缩放因子 $c$，以使微扰后的状态满足 $H(\\mathbf{q}^{\\star}, c \\mathbf{p}^{\\text{prop}}) = E_{0}$，其中 $E_{0}$ 是目标能量。假设动力学是确定性的、时间可逆的、测度保持的，并且发射提议分布是对称的。\n\n从路径系综的细致平衡要求出发，并仅使用微正则分布和正则分布的核心定义，推导此发射移动的接受率。将您的结果表示为一个单一的闭式解析表达式，该表达式在以下两种情况下均可计算：\n- 对于具有能量守恒重缩放的微正则系综 (NVE)，\n- 对于在逆温度 $\\beta$ 下应用恒温器的正则系综（等温，记为 NVT）。\n\n将发射点处的能量变化定义为 $\\Delta E = H(\\mathbf{q}^{\\star}, \\mathbf{p}^{\\text{new}}) - H(\\mathbf{q}^{\\star}, \\mathbf{p}^{\\star})$，其中 $\\mathbf{p}^{\\text{new}}$ 是在提议步骤后（无论是否重缩放，与系综一致）进入前向和后向积分的动量。您的最终答案必须是一个关于 $\\beta$ 和 $\\Delta E$ 的单一解析表达式，无量纲，且不得包含不等式或方程。不要四舍五入；无需数值计算。",
            "solution": "我们使用第一性原理推导过渡路径采样中发射移动的接受率：细致平衡、提议的对称性以及系综的平衡相空间权重。\n\n路径系综的权重与发射点的平衡权重以及强制执行边界条件（属于反应物和产物盆地）的特征函数成正比。在确定性、时间可逆、测度保持的动力学下，并且对于发射微扰的提议是对称的，Metropolis-Hastings 接受率简化为在微扰前后于发射点处计算的平衡权重之比。这源于应用于路径的细致平衡条件，但由于前向和后向积分是确定性的，且提议核是对称的，将相点映射到路径的雅可比行列式为1，并且提议概率在接受率中被抵消。\n\n令 $x^{\\star} = (\\mathbf{q}^{\\star}, \\mathbf{p}^{\\star})$ 为原始发射点，$x' = (\\mathbf{q}^{\\star}, \\mathbf{p}^{\\text{new}})$ 为（可能经过重缩放后）作为新路径种子的微扰发射点。接受率 $R$ 可以用平衡权重 $\\rho$ 表示为\n$$\nR = \\frac{\\rho(x')}{\\rho(x^{\\star})}.\n$$\n\n我们现在考虑系综权重：\n\n1. 微正则系综 (NVE)。微正则密度为\n$$\n\\rho_{\\text{micro}}(x) \\propto \\delta\\big(H(x) - E_{0}\\big),\n$$\n其中 $\\delta$ 是狄拉克δ分布，$E_{0}$ 是系综的固定能量。根据 NVE 中发射移动的构造，我们通过一个标量 $c$ 重缩放所提议的动量来强制执行\n$$\nH(\\mathbf{q}^{\\star}, c \\mathbf{p}^{\\text{prop}}) = E_{0}.\n$$\n因此，微扰后的状态 $x'$ 满足 $H(x') = E_{0}$，与原始状态 $x^{\\star}$ 完全相同。因此，$\\rho_{\\text{micro}}(x')$ 和 $\\rho_{\\text{micro}}(x^{\\star})$ 都支撑在相同的能量壳层上，它们的比值等于1：\n$$\nR_{\\text{micro}} = \\frac{\\rho_{\\text{micro}}(x')}{\\rho_{\\text{micro}}(x^{\\star})} = 1.\n$$\n这个结果与对称高斯微扰的细节无关，因为提议的对称性和重缩放确保了两个点都位于同一个微正则流形上。\n\n2. 正则系综 (NVT)。当应用恒温器且系统在逆温度 $\\beta$ 下从正则分布中采样时，平衡权重为\n$$\n\\rho_{\\text{can}}(x) \\propto \\exp\\big(-\\beta H(x)\\big).\n$$\n对于对称提议，接受率变为\n$$\nR_{\\text{can}} = \\frac{\\exp\\big(-\\beta H(x')\\big)}{\\exp\\big(-\\beta H(x^{\\star})\\big)} = \\exp\\big(-\\beta\\big[H(x') - H(x^{\\star})\\big]\\big).\n$$\n将发射点处的能量变化定义为\n$$\n\\Delta E = H(\\mathbf{q}^{\\star}, \\mathbf{p}^{\\text{new}}) - H(\\mathbf{q}^{\\star}, \\mathbf{p}^{\\star}),\n$$\n我们得到\n$$\nR_{\\text{can}} = \\exp(-\\beta \\Delta E).\n$$\n\n我们寻求一个在两种情况下都有效的单一解析表达式。在微正则情况下，通过重缩放强制的能量变化为 $\\Delta E = 0$，这给出\n$$\nR_{\\text{micro}} = \\exp(-\\beta \\cdot 0) = 1.\n$$\n在正则情况下，$\\Delta E$ 是由发射微扰引起的实际能量变化，所以\n$$\nR_{\\text{can}} = \\exp(-\\beta \\Delta E).\n$$\n\n因此，发射移动的接受率可以统一地用 $\\beta$ 和 $\\Delta E$ 表示为\n$$\nR = \\exp(-\\beta \\Delta E),\n$$\n在微正则情况下，由于能量守恒重缩放下 $\\Delta E = 0$，该表达式正确地简化为1；而在应用恒温器时，它给出了正则权重比。\n\n没有出现额外的因子，因为提议是对称的（零均值且在前向和反向移动中具有相等协方差的高斯分布），确定性动力学是测度保持的，并且从发射点到路径的映射具有单位雅可比行列式，这确保了接受率仅由发射点处的平衡权重之比确定。最终的表达式是无量纲的，并且仅依赖于逆温度 $\\beta$ 和能量变化 $\\Delta E$。",
            "answer": "$$\\boxed{\\exp(-\\beta \\Delta E)}$$"
        },
        {
            "introduction": "除了生成全新的路径，高效的过渡路径抽样模拟还必须包含能够探索现有路径系综的移动。平移移动 (shifting move) 是一种计算成本低廉但功能强大的方法，但其高接受率似乎有悖直觉。本问题  要求您阐明，对于稳态动力学，为何保持边界条件的平移移动会以概率 $1$ 被接受，从而突出路径空间中测度保持的关键作用。",
            "id": "3826172",
            "problem": "考虑一个相空间上的时间均匀马尔可夫动力学，其稳态密度为 $\\rho(x)$，转移核为 $p(x' \\mid x)$；或者，考虑由保测流 $\\Phi$ 和保持相空间体积的数值积分描述的确定性动力学。在过渡路径采样 (Transition Path Sampling, TPS) 中，固定长度路径系综对长度为 $L$ 的序列 $\\omega = (x_0, x_1, \\dots, x_L)$ 进行采样，这些序列满足边界条件，要求初始状态 $x_0$ 属于集合 $A$，最终状态 $x_L$ 属于集合 $B$，这由指示函数 $I_A(x_0) I_B(x_L)$ 编码。目标路径分布可以通过一个平稳过程构建，方法是根据每条路径初始点的稳态密度和沿路径的转移概率乘积对路径进行加权，并受限于边界指示函数。\n\n一次纯粹平移移动提议将当前路径 $\\omega = (x_0, x_1, \\dots, x_L)$ 替换为一个连续片段 $\\omega' = (x_k, x_{k+1}, \\dots, x_{k+L})$，该片段从同一条长的底层轨迹 $(\\dots, x_{-1}, x_0, x_1, \\dots)$ 中提取，其中 $k$ 是一个具有对称提议概率的整数平移量。假设底层动力学是平稳的，路径空间上的平移映射是双射且保测的，并且 $k$ 的提议核是对称的，因此向前平移 $k$ 与向后平移 $k$ 具有相同的提议概率。\n\n利用路径空间中针对目标分布和对称提议的 Metropolis–Hastings 接受准则，以及动力学的平稳性和保测性质，哪个选项正确解释了为什么在固定长度 TPS 中，当平移后的路径保持边界条件时，纯粹平移移动可以以概率 $1$ 被接受，并给出了正确的形式化接受准则？\n\nA. 如果动力学是平稳的，且平移映射是双射和保测的，那么路径权重在纯粹平移下是不变的。对于对称提议，Metropolis–Hastings 接受率简化为边界指示函数的比值。因此，当且仅当对于平移后的路径 $\\omega' = (x'_0, \\dots, x'_L)$ 有 $I_A(x'_0) I_B(x'_L) = 1$ 时，接受概率恰好为 $1$，否则为 $0$。\n\nB. 平移不改变沿路径的转移概率的乘积，因此接受概率总是 $1$，即使平移后的路径违反了任一边界条件，因为动力学是平稳的。\n\nC. 接受概率仅取决于平移下初始点稳态密度的变化，由 $\\min\\{1, \\rho(x'_0)/\\rho(x_0)\\}$ 给出；由于动力学是保测的，边界条件不参与计算。\n\nD. 接受概率等于路径空间上平移映射的雅可比行列式；仅对于使用辛积分器的哈密顿动力学，该值是 $1$，而对于随机动力学，它严格小于 $1$，无论边界条件如何。",
            "solution": "让我们仔细检查一下逻辑。\n目标分布：$\\pi[\\omega] = \\frac{1}{Z} W[\\omega] I_A(x_0) I_B(x_L)$，其中 $Z$ 是归一化常数，$W[\\omega]$ 是稳态路径概率。\n对于随机动力学，$W[\\omega] = \\rho(x_0) \\prod_{i=0}^{L-1} p(x_{i+1}|x_i)$。\n对于确定性动力学（路径由 $x_0$ 决定），$W[\\omega] = \\rho(x_0)$。\n提议：\n1.  从对称分布 $g(k)$ 中选择平移量 $k$，因此 $g(k)=g(-k)$。\n2.  提议 $\\omega' = T_k(\\omega) = (x_k, \\dots, x_{k+L})$。\n提议概率为 $g(\\omega'|\\omega) = g(k)$。从 $\\omega'$ 到 $\\omega$ 的逆向移动通过 $-k$ 的平移实现，因此 $g(\\omega|\\omega') = g(-k)$。由于 $g(k)=g(-k)$，提议是对称的：$g(\\omega'|\\omega) = g(\\omega|\\omega')$。\nMetropolis-Hastings 接受概率：\n$P_{acc} = \\min\\left\\{ 1, \\frac{\\pi[\\omega']}{\\pi[\\omega]} \\frac{g(\\omega|\\omega')}{g(\\omega'|\\omega)} \\right\\} = \\min\\left\\{ 1, \\frac{\\pi[\\omega']}{\\pi[\\omega]} \\right\\}$。\n目标概率的比值为：\n$\\frac{\\pi[\\omega']}{\\pi[\\omega]} = \\frac{W[\\omega'] I_A(x'_0) I_B(x'_L)}{W[\\omega] I_A(x_0) I_B(x_L)}$。\n问题假设平移映射对于平稳动力学是保测的。这是一个关键陈述，意味着与平稳过程相关的测度在平移下是不变的。这直接意味着路径权重是不变的：$W[\\omega'] = W[\\omega]$。\n因此比值简化为：\n$\\frac{\\pi[\\omega']}{\\pi[\\omega]} = \\frac{I_A(x'_0) I_B(x'_L)}{I_A(x_0) I_B(x_L)}$。\n由于 $\\omega$ 是系综中的一条有效路径，我们必须有 $I_A(x_0)I_B(x_L) = 1$。\n因此，该比值就是 $I_A(x'_0) I_B(x'_L)$。\n$P_{acc} = \\min\\left\\{ 1, I_A(x'_0) I_B(x'_L) \\right\\}$。\n指示函数乘积 $I_A(x'_0) I_B(x'_L)$ 的值要么是 $0$ 要么是 $1$。\n如果 $I_A(x'_0) I_B(x'_L) = 1$，那么 $P_{acc} = \\min\\{1, 1\\} = 1$。\n如果 $I_A(x'_0) I_B(x'_L) = 0$，那么 $P_{acc} = \\min\\{1, 0\\} = 0$。\n这等价于一个陈述，即当且仅当新路径满足边界条件时，接受概率为 $1$。\n这个逻辑证实了选项A是对情况的精确和正确的描述。所有其他选项都包含根本性错误。该逻辑似乎无懈可击。我现在将按照指定格式编写最终输出。",
            "answer": "$$\n\\boxed{A}\n$$"
        },
        {
            "introduction": "虽然过渡路径抽样非常适合研究稀有事件的机理，但一个关键的定量目标通常是计算反应速率。过渡界面取样 (TIS) 扩展了 TPS 的核心思想，为速率常数的计算建立了一个强大的框架。这个实践性的编程练习  将让您扮演分析模拟数据的研究人员角色，任务是实现 TIS 速率公式及其误差传播，从而根据原始抽样计数计算出成核速率。",
            "id": "3826148",
            "problem": "考虑一个使用过渡界面采样 (TIS) 建模的粗粒化成核过程，其中序参量 $n$ 定义了亚稳态盆地 $A$ (小 $n$) 和产物盆地 $B$ (大 $n$) 之间的嵌套界面 $\\{n_0,n_1,\\dots,n_m\\}$。假设一个稳态分子动力学过程，其中离开盆地 $A$ 的轨迹可以穿越界面 $n_0$，然后返回 $A$，或者通过依次穿越界面最终到达盆地 $B$。仅使用以下基本依据：(i) 将通量定义为单位时间内的事件数，(ii) 应用于序贯界面穿越的全概率定律，以及 (iii) 用于计数实验的标准统计模型，特别是用于通量事件的泊松模型和用于界面穿越成功的二项模型。\n\n您的任务是根据采样计数推导并实现一个用于估算总成核速率及其不确定度的估计量。对于每个测试用例，您将获得：\n- 在总模拟时间 $T$ (单位：秒) 内，源自盆地 $A$ 的 $n_0$ 反应性穿越的通量计数 $N_{\\mathrm{flux}}$。\n- 对于每个界面 $i \\in \\{0,1,\\dots,m-1\\}$，从界面 $n_i$ 开始生成的尝试路径数 $M_i$，以及在返回盆地 $A$ 之前成功到达界面 $n_{i+1}$ 的尝试次数 $S_i$。\n\n根据这些数据，构建：\n- 条件概率 $P(n_{i+1}\\mid n_i)$ 的估计量 $\\hat{p}_i = S_i/M_i$。\n- 离开盆地 A 穿过 $n_0$ 的通量估计量 $\\hat{\\phi} = N_{\\mathrm{flux}}/T$ (单位：$\\mathrm{s}^{-1}$)。\n- 与 TIS 定义一致的总成核速率估计量 $\\hat{k}$ (单位：$\\mathrm{s}^{-1}$)，仅使用上述基本依据。\n- 通过在对数空间中传播不确定度，计算一个近似的 $95\\%$ 置信区间 $[\\hat{k}_{\\mathrm{low}}, \\hat{k}_{\\mathrm{high}}]$ (单位均为 $\\mathrm{s}^{-1}$)。此计算基于以下假设：$N_{\\mathrm{flux}}$ 服从泊松分布，每个 $S_i$ 服从具有 $M_i$ 次试验和成功概率 $p_i$ 的二项分布。将所有分量视为独立的。如果任意 $\\hat{p}_i=0$ 或 $N_{\\mathrm{flux}}=0$，则定义 $\\hat{k}=0$ 并设置 $\\hat{k}_{\\mathrm{low}}=\\hat{k}_{\\mathrm{high}}=0$。\n\n为以下测试套件实现计算。每个测试用例列出 $(N_{\\mathrm{flux}}, T, [(M_0,S_0), (M_1,S_1), \\dots])$：\n- 测试用例 1：$N_{\\mathrm{flux}}=500$，$T=100000$，界面 $\\left[(1000,200),(800,160),(600,120)\\right]$。\n- 测试用例 2：$N_{\\mathrm{flux}}=50$，$T=10000$，界面 $\\left[(300,300),(200,2),(500,25)\\right]$。\n- 测试用例 3：$N_{\\mathrm{flux}}=100$，$T=100000$，界面 $\\left[(100,10),(200,0),(400,200)\\right]$。\n- 测试用例 4：$N_{\\mathrm{flux}}=0$，$T=100000$，界面 $\\left[(1000,500),(1000,500)\\right]$。\n\n所有速率必须以 $\\mathrm{s}^{-1}$ 表示，所有输出必须是浮点数。您的程序应生成单行输出，其中包含上述测试用例的结果，形式为用方括号括起来的逗号分隔列表。每个测试用例的结果本身必须是按 $[\\hat{k},\\hat{k}_{\\mathrm{low}},\\hat{k}_{\\mathrm{high}}]$ 顺序排列的三个浮点数列表，例如：$[[k_1,\\ell_1,u_1],[k_2,\\ell_2,u_2],\\dots]$。",
            "solution": "问题陈述被评估为有效。它在科学上基于统计力学和稀有事件采样（特别是过渡界面采样，TIS）的原理。该问题是良构的、客观的，并提供了推导唯一、有意义的解所需的所有信息，没有矛盾或歧义。所要求的计算代表了 TIS 理论和统计误差传播的标准应用。\n\n成核速率估计量及其置信区间的推导过程如下，基于问题中指定的基本原理。\n\n**1. 成核速率估计量 $\\hat{k}$**\n\n总成核速率 $k$ 定义为离开亚稳态盆地 $A$ 并继续到达产物盆地 $B$ 的轨迹通量。这可以表示为两个量的乘积：\n1.  从盆地 $A$ 穿过第一个界面 $n_0$ 的轨迹通量 $\\phi$。\n2.  一条轨迹在穿过 $n_0$ 后，将继续前进到盆地 $B$ 而非返回 $A$ 的概率 $P(B \\mid n_0)$。\n\n这给出了基本速率表达式：\n$$k = \\phi \\cdot P(B \\mid n_0)$$\n问题提供了估计每一项的数据。通量的估计量 $\\hat{\\phi}$ 是观测到的 $n_0$ 穿越次数 $N_{\\mathrm{flux}}$ 除以总模拟时间 $T$：\n$$\\hat{\\phi} = \\frac{N_{\\mathrm{flux}}}{T}$$\n概率 $P(B \\mid n_0)$ 是指一条轨迹在已穿过 $n_0$ 的条件下到达盆地 $B$（定义为穿过最后一个界面 $n_m$）的概率。在 TIS 中，这被分解为穿越连续界面的条件概率的乘积。使用全概率定律，并假设界面穿越具有马尔可夫性质（这是 TIS 的一个核心假设），我们有：\n$$P(B \\mid n_0) = P(n_m \\mid n_0) = \\prod_{i=0}^{m-1} P(n_{i+1} \\mid n_i)$$\n令 $p_i = P(n_{i+1} \\mid n_i)$。每个条件概率的估计量 $\\hat{p}_i$ 由成功尝试次数 $S_i$ 与从界面 $n_i$ 生成的总尝试路径数 $M_i$ 之比给出：\n$$\\hat{p}_i = \\frac{S_i}{M_i}$$\n结合这些估计量，我们构建了总成核速率的估计量 $\\hat{k}$：\n$$\\hat{k} = \\hat{\\phi} \\cdot \\prod_{i=0}^{m-1} \\hat{p}_i = \\frac{N_{\\mathrm{flux}}}{T} \\prod_{i=0}^{m-1} \\frac{S_i}{M_i}$$\n该表达式与问题中的条件一致，即如果 $N_{\\mathrm{flux}} = 0$ 或任何 $S_i = 0$，则 $\\hat{k}=0$。\n\n**2. 不确定度传播和置信区间**\n\n为了找到 $\\hat{k}$ 的 $95\\%$ 置信区间，我们按照规定，在对数空间中传播来自采样量（$N_{\\mathrm{flux}}$ 和每个 $S_i$）的不确定度。令 $Y = \\ln(\\hat{k})$。\n$$Y = \\ln(\\hat{k}) = \\ln\\left( \\frac{N_{\\mathrm{flux}}}{T} \\right) + \\sum_{i=0}^{m-1} \\ln\\left( \\frac{S_i}{M_i} \\right)$$\n由于 $T$ 和每个 $M_i$ 是没有统计不确定性的固定模拟参数，我们可以写出：\n$$Y = \\ln(N_{\\mathrm{flux}}) - \\ln(T) + \\sum_{i=0}^{m-1} \\left( \\ln(S_i) - \\ln(M_i) \\right)$$\n问题指出所有分量（$N_{\\mathrm{flux}}$ 和每个 $S_i$）都是独立的。因此，和的方差等于各项方差之和：\n$$\\sigma_Y^2 = \\mathrm{Var}(Y) = \\mathrm{Var}(\\ln(N_{\\mathrm{flux}})) + \\sum_{i=0}^{m-1} \\mathrm{Var}(\\ln(S_i))$$\n我们使用 delta 方法进行误差传播，该方法将函数 $f(X)$ 的方差近似为 $\\mathrm{Var}(f(X)) \\approx (f'(E[X]))^2 \\mathrm{Var}(X)$。对于对数函数，这导出了基于相对不确定度的近似：$\\mathrm{Var}(\\ln(X)) \\approx \\mathrm{Var}(X) / (E[X])^2$。\n\n**$\\ln(N_{\\mathrm{flux}})$ 的方差：**\n$N_{\\mathrm{flux}}$ 被建模为一个服从泊松分布的随机变量。对于泊松分布，方差等于均值。我们用观测到的计数值 $N_{\\mathrm{flux}}$ 来估计均值 $\\lambda$。因此，$E[N_{\\mathrm{flux}}] \\approx N_{\\mathrm{flux}}$ 且 $\\mathrm{Var}(N_{\\mathrm{flux}}) \\approx N_{\\mathrm{flux}}$。\n$$\\mathrm{Var}(\\ln(N_{\\mathrm{flux}})) \\approx \\frac{\\mathrm{Var}(N_{\\mathrm{flux}})}{ (E[N_{\\mathrm{flux}}])^2 } \\approx \\frac{N_{\\mathrm{flux}}}{ (N_{\\mathrm{flux}})^2 } = \\frac{1}{N_{\\mathrm{flux}}}$$\n当 $N_{\\mathrm{flux}}=0$ 时，此项无定义，这由不确定度为 $0$ 的特殊情况处理。\n\n**$\\ln(S_i)$ 的方差：**\n每个 $S_i$ 被建模为一个服从二项分布的随机变量，$S_i \\sim \\mathrm{Binom}(M_i, p_i)$。其均值为 $E[S_i] = M_i p_i$，方差为 $\\mathrm{Var}(S_i) = M_i p_i (1-p_i)$。我们使用估计量 $\\hat{p}_i = S_i / M_i$。\n$$\\mathrm{Var}(\\ln(S_i)) \\approx \\frac{\\mathrm{Var}(S_i)}{ (E[S_i])^2 } \\approx \\frac{M_i \\hat{p}_i (1-\\hat{p}_i)}{ (M_i \\hat{p}_i)^2 } = \\frac{1-\\hat{p}_i}{M_i \\hat{p}_i}$$\n代入 $\\hat{p}_i = S_i / M_i$：\n$$\\mathrm{Var}(\\ln(S_i)) \\approx \\frac{1 - (S_i/M_i)}{M_i (S_i/M_i)} = \\frac{(M_i-S_i)/M_i}{S_i} = \\frac{M_i-S_i}{M_i S_i}$$\n当 $S_i=0$ 时，此项无定义（由特殊情况处理），如果 $S_i=M_i$，则此项等于 $0$，这正确地反映了该特定概率估计没有不确定性。\n\n**总方差和置信区间：**\n$Y = \\ln(\\hat{k})$ 的总方差是这些分量的和：\n$$\\sigma_Y^2 \\approx \\frac{1}{N_{\\mathrm{flux}}} + \\sum_{i=0}^{m-1} \\frac{M_i-S_i}{M_i S_i}$$\n假设 $Y$ 近似服从正态分布（根据中心极限定理），$Y$ 的 $95\\%$ 置信区间由 $[Y - z \\sigma_Y, Y + z \\sigma_Y]$ 给出，其中 $\\sigma_Y = \\sqrt{\\sigma_Y^2}$，$z$ 是标准正态分布的第 $97.5$ 百分位数 ($z \\approx 1.96$)。\n为了获得 $\\hat{k}$ 的置信区间，我们对 $Y$ 区间的端点取指数：\n$$[\\hat{k}_{\\mathrm{low}}, \\hat{k}_{\\mathrm{high}}] = [\\exp(\\ln(\\hat{k}) - z \\sigma_Y), \\exp(\\ln(\\hat{k}) + z \\sigma_Y)] = [\\hat{k} e^{-z \\sigma_Y}, \\hat{k} e^{z \\sigma_Y}]$$\n如果 $N_{\\mathrm{flux}} = 0$ 或任何 $S_i = 0$，问题规定 $\\hat{k}=0$ 且区间为 $[\\hat{k}_{\\mathrm{low}}, \\hat{k}_{\\mathrm{high}}] = [0, 0, 0]$。这就是下面实现的算法。",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Solves the Transition Interface Sampling problem for the given test cases.\n    \"\"\"\n    test_cases = [\n        (500, 100000, [(1000, 200), (800, 160), (600, 120)]),\n        (50, 10000, [(300, 300), (200, 2), (500, 25)]),\n        (100, 100000, [(100, 10), (200, 0), (400, 200)]),\n        (0, 100000, [(1000, 500), (1000, 500)]),\n    ]\n\n    def calculate_rate_and_ci(N_flux, T, interfaces):\n        \"\"\"\n        Calculates the nucleation rate estimator and its 95% confidence interval.\n\n        Args:\n            N_flux (int): The flux count of reactive crossings of n0.\n            T (float): The total simulation time in seconds.\n            interfaces (list): A list of tuples (Mi, Si) for each interface.\n\n        Returns:\n            list: A list containing [k_hat, k_low, k_high].\n        \"\"\"\n        S_counts = [s for m, s in interfaces]\n\n        # Handle the special case where rate is zero due to no flux or no successes\n        if N_flux == 0 or any(s == 0 for s in S_counts):\n            return [0.0, 0.0, 0.0]\n\n        # 1. Calculate the rate estimator k_hat\n        # Flux estimator\n        phi_hat = N_flux / T\n        \n        # Conditional probability estimators\n        p_hats = [s / m for m, s in interfaces]\n        \n        # Overall rate estimator\n        k_hat = phi_hat * np.prod(p_hats)\n\n        # 2. Calculate the variance of log(k_hat) for uncertainty propagation\n        # Flux contribution to variance\n        var_log_k = 1.0 / N_flux\n        \n        # Interface crossing contributions to variance\n        for m, s in interfaces:\n            # The case s=m results in a zero term, correctly reflecting no uncertainty from this interface.\n            # The case s=0 is already handled above.\n            if s  m:\n                var_log_k += (m - s) / (m * s)\n        \n        sigma_log_k = np.sqrt(var_log_k)\n\n        # 3. Construct the 95% confidence interval\n        # z-score for a 95% confidence interval (two-tailed)\n        z = norm.ppf(1 - 0.05 / 2)\n        \n        # Calculate lower and upper bounds by exponentiating the log-space interval\n        factor = np.exp(z * sigma_log_k)\n        k_low = k_hat / factor\n        k_high = k_hat * factor\n\n        return [k_hat, k_low, k_high]\n\n    results = []\n    for case in test_cases:\n        N_flux_case, T_case, interfaces_case = case\n        result = calculate_rate_and_ci(N_flux_case, T_case, interfaces_case)\n        results.append(result)\n\n    # Format the final output string exactly as required\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}