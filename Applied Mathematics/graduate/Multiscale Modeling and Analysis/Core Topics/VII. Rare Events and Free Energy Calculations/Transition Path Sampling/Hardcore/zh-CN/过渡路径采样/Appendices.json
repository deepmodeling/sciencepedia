{
    "hands_on_practices": [
        {
            "introduction": "在深入研究复杂的路径取样算法之前，我们必须首先理解它们旨在解决的根本挑战：反应事件的极端稀有性。第一个练习将帮助您对这一问题建立定量的认识。通过将相变过程模拟为一个简单的泊松过程，您将推导出一个反应事件的观测概率，从而揭示为何直接模拟的方法往往是不可行的。",
            "id": "3826181",
            "problem": "考虑一个平衡分子系统，在构型空间中的两个亚稳态盆 $A$ 和 $B$ 之间表现出罕见的势垒穿越。在时间尺度分离的情况下，将微观动力学粗粒化到盆地标签，可以得到一个双态动力学描述，其中 $A \\to B$ 的转变作为一个更新过程发生，其风险（速率）恒为 $k_{AB}$。假设系统是稳态的，并且穿越事件可以很好地由强度为 $k_{AB}$ 的齐次泊松过程描述。从一个长的平衡轨迹中进行采样，并在时间上均匀随机地选择一个持续时间为 $T$ 的片段。在过渡路径采样（TPS）的背景下，过渡路径采样（TPS）关注盆地之间罕见的反应性偏移；在本问题中，将反应事件 $A \\to B$ 视为由上述泊松过程在时间上生成的点。\n\n从齐次泊松过程的定义及其相关的指数等待时间分布出发，推导所选持续时间为 $T$ 的轨迹片段包含至少一次 $A \\to B$ 转变的概率。请用 $k_{AB}$ 和 $T$ 表示你的最终答案，形式为一个封闭形式的解析表达式。不要引入任何数值。不需要四舍五入，最终表达式中也不应包含单位。",
            "solution": "首先根据所需标准对问题陈述进行验证。\n\n### 第1步：提取已知条件\n- 该系统是一个具有两个亚稳态盆 $A$ 和 $B$ 的平衡分子系统。\n- $A \\to B$ 的转变作为一个更新过程发生，其风险（速率）恒为 $k_{AB}$。\n- 转变事件由强度为 $k_{AB}$ 的齐次泊松过程描述。\n- 一个持续时间为 $T$ 的轨迹片段被均匀随机地选择。\n- 目标是推导该片段包含至少一次 $A \\to B$ 转变的概率。\n- 推导必须从齐次泊松过程的定义及其相关的指数等待时间分布出发。\n- 最终答案必须是用 $k_{AB}$ 和 $T$ 表示的封闭形式解析表达式。\n\n### 第2步：使用提取的已知条件进行验证\n- **科学依据：** 该问题使用了统计力学和化学物理学中一个标准且成熟的模型。将罕见事件建模为泊松过程是过渡态理论和分子动力学模拟分析的基石。过渡路径采样（TPS）的背景是恰当的。该问题在科学上是合理的。\n- **适定性：** 问题定义清晰。它提供了所有必要的参数（$k_{AB}$，$T$）并要求一个特定的、可计算的量（一个概率）。存在一个唯一的、稳定的、有意义的解。\n- **客观性：** 问题以物理学和数学中常见的精确、正式的语言陈述，没有主观性或模糊性。\n\n问题陈述是有效的，因为它具有科学依据、适定、客观且自洽。没有矛盾、信息缺失或其他缺陷。可以进行求解过程。\n\n### 解题推导\n\n问题要求在持续时间为 $T$ 的时间间隔内观察到至少一次 $A \\to B$ 转变的概率。这些转变的发生被建模为一个齐次泊松过程，其速率恒定，强度记为 $k_{AB}$。\n\n设 $N(t)$ 为随机变量，表示在时间间隔 $[0, t]$ 内发生的转变次数。问题要求概率 $P(N(T) \\ge 1)$。计算其互补概率通常更简单，即观察到恰好零次转变的概率 $P(N(T) = 0)$。那么，所求概率由下式给出：\n$$ P(N(T) \\ge 1) = 1 - P(N(T) = 0) $$\n\n问题明确要求从齐次泊松过程的性质及其相关的指数等待时间分布出发。速率为 $\\lambda$（此处 $\\lambda = k_{AB}$）的齐次泊松过程的一个定义特征是，连续事件之间的等待时间是遵循指数分布的独立同分布（i.i.d.）随机变量。\n\n设 $\\tau$ 为从任意时间点开始，第一次 $A \\to B$ 转变发生的等待时间。此等待时间的概率密度函数（PDF）由指数分布给出：\n$$ f(\\tau; k_{AB}) = k_{AB} \\exp(-k_{AB} \\tau) \\quad \\text{for } \\tau \\ge 0 $$\n“在区间 $[0, T]$ 内发生零次转变”这一事件等价于“第一次转变的等待时间大于 $T$”这一事件。我们可以将其表示为：\n$$ P(N(T) = 0) = P(\\tau  T) $$\n概率 $P(\\tau  T)$ 也称为生存函数 $S(T)$。它可以通过将概率密度函数（PDF）从 $T$ 积分到无穷大来计算，或者更简单地，通过使用累积分布函数（CDF）来计算。累积分布函数（CDF）$F(T) = P(\\tau \\le T)$ 给出第一次事件在时间 $T$ 之前发生的概率。CDF 计算如下：\n$$ F(T) = P(\\tau \\le T) = \\int_{0}^{T} f(t; k_{AB}) dt = \\int_{0}^{T} k_{AB} \\exp(-k_{AB} t) dt $$\n计算该积分：\n$$ F(T) = \\left[ -\\exp(-k_{AB} t) \\right]_{0}^{T} = (-\\exp(-k_{AB} T)) - (-\\exp(-k_{AB} \\cdot 0)) = 1 - \\exp(-k_{AB} T) $$\n在 $[0, T]$ 内没有事件发生的概率是 CDF 的补集：\n$$ P(N(T) = 0) = P(\\tau  T) = 1 - P(\\tau \\le T) = 1 - F(T) $$\n代入 $F(T)$ 的表达式：\n$$ P(N(T) = 0) = 1 - (1 - \\exp(-k_{AB} T)) = \\exp(-k_{AB} T) $$\n该表达式表示所选持续时间为 $T$ 的轨迹片段包含零次转变的概率。\n\n最后，该片段包含至少一次转变的概率是：\n$$ P(N(T) \\ge 1) = 1 - P(N(T) = 0) = 1 - \\exp(-k_{AB} T) $$\n这就是所求概率关于速率 $k_{AB}$ 和持续时间 $T$ 的封闭形式解析表达式。",
            "answer": "$$\n\\boxed{1 - \\exp(-k_{AB} T)}\n$$"
        },
        {
            "introduction": "过渡路径取样方法的核心是“打点移动” (shooting move) 算法，它能从现有反应路径中生成新的路径。理解其接受准则是掌握 TPS 如何在正确取样目标系综的同时高效探索路径空间的关键。本练习要求您在不同的热力学系综条件下推导打点移动的接受概率，从而突显细致平衡原理的核心作用。",
            "id": "3826162",
            "problem": "考虑一个包含 $N$ 个粒子的系统，其哈密顿量为 $H(\\mathbf{q},\\mathbf{p}) = K(\\mathbf{p}) + U(\\mathbf{q})$，其中 $K(\\mathbf{p}) = \\sum_{i=1}^{N} \\frac{|\\mathbf{p}_{i}|^{2}}{2 m_{i}}$ 是动能，$U(\\mathbf{q})$ 是一个光滑的势能。在过渡路径采样中，通过选择一个打点时间 $t^{\\star}$ 和相点 $x^{\\star} = (\\mathbf{q}^{\\star}, \\mathbf{p}^{\\star})$ 来构造一个打点移动 (shooting move)，然后通过对称的高斯微扰提出新的动量\n$$\n\\mathbf{p}^{\\text{prop}} = \\mathbf{p}^{\\star} + \\boldsymbol{\\eta}, \\quad \\boldsymbol{\\eta} \\sim \\mathcal{N}\\big( \\mathbf{0}, \\sigma^{2} \\mathbf{M} \\big),\n$$\n其中 $\\mathbf{M}$ 是一个对角质量矩阵，其元素为 $m_{i}$，且 $\\sigma  0$。对于微正则（恒定能量，牛顿）动力学（记为 NVE），会应用一个标量速度重标定因子 $c$，使得微扰后的状态满足 $H(\\mathbf{q}^{\\star}, c \\mathbf{p}^{\\text{prop}}) = E_{0}$，其中 $E_{0}$ 是目标能量。假设动力学是确定性的、时间可逆的、测度保持的，并且打点提议分布是对称的。\n\n从路径系综的细致平衡要求出发，并仅使用微正则和正则分布的核心定义，推导此打点移动的接受率。将您的结果表示为一个单一的封闭形式解析表达式，该表达式在以下两种情况下均可评估：\n- 对于具有能量守恒重标定的微正则系综 (NVE)，\n- 对于在逆温 $\\beta$ 下应用恒温器的正则系综（等温，记为 NVT）。\n\n将打点处的能量变化定义为 $\\Delta E = H(\\mathbf{q}^{\\star}, \\mathbf{p}^{\\text{new}}) - H(\\mathbf{q}^{\\star}, \\mathbf{p}^{\\star})$，其中 $\\mathbf{p}^{\\text{new}}$ 是提议步骤后（无论是否重标定，与系综一致）进入前向和后向积分的动量。您的最终答案必须是关于 $\\beta$ 和 $\\Delta E$ 的单一解析表达式，无量纲，且不得包含不等式或方程。不要四舍五入；不需要进行数值评估。",
            "solution": "我们利用第一性原理推导过渡路径采样中打点移动的接受率：细致平衡、提议的对称性以及系综的平衡相空间权重。\n\n路径系综的权重与打点处的平衡权重以及强制执行边界条件（属于反应物和产物盆地）的特征函数成正比。在确定性的、时间可逆的、测度保持的动力学下，并且对于打点微扰的对称提议，Metropolis-Hastings 接受率简化为微扰前后在打点处评估的平衡权重之比。这源于应用于路径的细致平衡条件，但由于前向和后向积分是确定性的，且提议核是对称的，因此将相点映射到路径的雅可比行列式为1，并且提议概率在接受率中被抵消。\n\n令 $x^{\\star} = (\\mathbf{q}^{\\star}, \\mathbf{p}^{\\star})$ 为原始打点，$x' = (\\mathbf{q}^{\\star}, \\mathbf{p}^{\\text{new}})$ 为（可能重标定后）生成新路径的微扰后打点。接受率 $R$ 可以用平衡权重 $\\rho$ 表示为\n$$\nR = \\frac{\\rho(x')}{\\rho(x^{\\star})}.\n$$\n\n我们现在考虑系综权重：\n\n1. 微正则系综 (NVE)。微正则密度为\n$$\n\\rho_{\\text{micro}}(x) \\propto \\delta\\big(H(x) - E_{0}\\big),\n$$\n其中 $\\delta$ 是狄拉克δ分布，$E_{0}$ 是系综的固定能量。根据 NVE 中打点移动的构造，我们通过一个标量 $c$ 重标定提议的动量以强制执行\n$$\nH(\\mathbf{q}^{\\star}, c \\mathbf{p}^{\\text{prop}}) = E_{0}.\n$$\n因此，微扰后的状态 $x'$ 满足 $H(x') = E_{0}$，与原始状态 $x^{\\star}$ 完全相同。因此，$\\rho_{\\text{micro}}(x')$ 和 $\\rho_{\\text{micro}}(x^{\\star})$ 都支撑在同一个能壳上，它们的比值等于1：\n$$\nR_{\\text{micro}} = \\frac{\\rho_{\\text{micro}}(x')}{\\rho_{\\text{micro}}(x^{\\star})} = 1.\n$$\n这个结果与对称高斯微扰的细节无关，因为提议的对称性和重标定确保了两个点都位于同一个微正则流形上。\n\n2. 正则系综 (NVT)。当应用恒温器并且系统在逆温 $\\beta$ 下从正则分布中采样时，平衡权重为\n$$\n\\rho_{\\text{can}}(x) \\propto \\exp\\big(-\\beta H(x)\\big).\n$$\n对于对称提议，接受率变为\n$$\nR_{\\text{can}} = \\frac{\\exp\\big(-\\beta H(x')\\big)}{\\exp\\big(-\\beta H(x^{\\star})\\big)} = \\exp\\big(-\\beta\\big[H(x') - H(x^{\\star})\\big]\\big).\n$$\n将打点处的能量变化定义为\n$$\n\\Delta E = H(\\mathbf{q}^{\\star}, \\mathbf{p}^{\\text{new}}) - H(\\mathbf{q}^{\\star}, \\mathbf{p}^{\\star}),\n$$\n我们得到\n$$\nR_{\\text{can}} = \\exp(-\\beta \\Delta E).\n$$\n\n我们寻求一个在两种情况下都有效的单一解析表达式。在微正则情况下，通过重标定强制的能量变化为 $\\Delta E = 0$，这给出\n$$\nR_{\\text{micro}} = \\exp(-\\beta \\cdot 0) = 1.\n$$\n在正则情况下，$\\Delta E$ 是由打点微扰引起的实际能量变化，因此\n$$\nR_{\\text{can}} = \\exp(-\\beta \\Delta E).\n$$\n\n因此，打点移动的接受率可以统一地用 $\\beta$ 和 $\\Delta E$ 表示为\n$$\nR = \\exp(-\\beta \\Delta E),\n$$\n在微正则情况下，由于能量守恒的重标定下 $\\Delta E = 0$，该表达式正确地简化为1；而在应用恒温器时，它给出了正则权重比。\n\n没有出现额外的因子，因为提议是对称的（前向和反向移动中均值为零且协方差相等的高斯分布），确定性动力学是测度保持的，并且从打点到路径的映射具有单位雅可比行列式，从而确保接受率仅由打点处的平衡权重之比确定。最终的表达式是无量纲的，并且仅取决于逆温 $\\beta$ 和能量变化 $\\Delta E$。",
            "answer": "$$\\boxed{\\exp(-\\beta \\Delta E)}$$"
        },
        {
            "introduction": "从根本上说，过渡路径取样及其强大的变体——过渡界面取样 (TIS) ——的目标是从微观模拟数据中计算出宏观速率常数。最后一个练习提供了一个端到端的实践工作流程。您将通过编程实现 TIS 速率的计算，处理原始的界面穿越数据来估算成核速率，并关键地，计算其统计不确定性。",
            "id": "3826148",
            "problem": "考虑一个使用过渡界面采样（TIS）建模的粗粒化成核过程，其中序参数 $n$ 定义了亚稳态盆地 $A$（小 $n$）和产物盆地 $B$（大 $n$）之间的嵌套界面 $\\{n_0,n_1,\\dots,n_m\\}$。假设一个稳态分子动力学过程，其中离开盆地 $A$ 的轨迹可以穿过界面 $n_0$，然后返回 $A$，或者通过依次穿过各个界面最终到达盆地 $B$。仅使用以下基本依据：(i) 通量定义为单位时间内的事件数，(ii) 应用于顺序界面穿越的全概率定律，以及 (iii) 用于计数实验的标准统计模型，特别是用于通量事件的泊松模型和用于界面穿越成功事件的二项模型。\n\n您的任务是根据采样计数推导并实现一个对总成核速率及其不确定度的估计量。对于每个测试用例，您将获得：\n- 在总模拟时间 $T$（单位：秒）内，源自盆地 $A$ 的、对 $n_0$ 的反应性穿越的通量计数 $N_{\\mathrm{flux}}$。\n- 对于每个界面 $i \\in \\{0,1,\\dots,m-1\\}$，从界面 $n_i$ 开始生成的尝试路径数 $M_i$，以及在返回盆地 $A$ 之前成功到达界面 $n_{i+1}$ 的尝试次数 $S_i$。\n\n根据这些数据，构建：\n- 条件概率 $P(n_{i+1}\\mid n_i)$ 的估计量 $\\hat{p}_i = S_i/M_i$。\n- 离开盆地 $A$ 穿过 $n_0$ 的通量估计量 $\\hat{\\phi} = N_{\\mathrm{flux}}/T$（单位：$\\mathrm{s}^{-1}$）。\n- 与 TIS 定义一致的总成核速率估计量 $\\hat{k}$（单位：$\\mathrm{s}^{-1}$），仅使用上述基本依据。\n- 一个近似的 $95\\%$ 置信区间 $[\\hat{k}_{\\mathrm{low}}, \\hat{k}_{\\mathrm{high}}]$（单位均为 $\\mathrm{s}^{-1}$），通过在对数空间中传播不确定度，并假设 $N_{\\mathrm{flux}}$ 服从泊松分布，每个 $S_i$ 服从具有 $M_i$ 次试验和成功概率 $p_i$ 的二项分布。将所有分量视为独立的。如果任意 $\\hat{p}_i=0$ 或 $N_{\\mathrm{flux}}=0$，则定义 $\\hat{k}=0$ 并设置 $\\hat{k}_{\\mathrm{low}}=\\hat{k}_{\\mathrm{high}}=0$。\n\n为以下测试套件实现计算。每个测试用例列出 $(N_{\\mathrm{flux}}, T, [(M_0,S_0), (M_1,S_1), \\dots])$：\n- 测试用例 1：$N_{\\mathrm{flux}}=500$，$T=100000$，界面 $\\left[(1000,200),(800,160),(600,120)\\right]$。\n- 测试用例 2：$N_{\\mathrm{flux}}=50$，$T=10000$，界面 $\\left[(300,300),(200,2),(500,25)\\right]$。\n- 测试用例 3：$N_{\\mathrm{flux}}=100$，$T=100000$，界面 $\\left[(100,10),(200,0),(400,200)\\right]$。\n- 测试用例 4：$N_{\\mathrm{flux}}=0$，$T=100000$，界面 $\\left[(1000,500),(1000,500)\\right]$。\n\n所有速率必须以 $\\mathrm{s}^{-1}$ 表示，所有输出必须是浮点数。您的程序应生成单行输出，其中包含上述测试用例的结果，形式为方括号括起来的逗号分隔列表。每个测试用例的结果本身必须是按 $[\\hat{k},\\hat{k}_{\\mathrm{low}},\\hat{k}_{\\mathrm{high}}]$ 顺序排列的三个浮点数的列表，例如：$[[k_1,\\ell_1,u_1],[k_2,\\ell_2,u_2],\\dots]$。",
            "solution": "问题陈述被评估为有效。它在科学上基于统计力学和稀有事件采样（特别是过渡界面采样 (TIS)）的原理。该问题是适定的、客观的，并提供了所有必要的信息来推导出唯一、有意义的解，没有矛盾或歧义。所需的计算代表了 TIS 理论和统计误差传播的标准应用。\n\n成核速率估计量及其置信区间的推导过程如下，基于问题中指定的基本原理。\n\n**1. 成核速率估计量 $\\hat{k}$**\n\n总成核速率 $k$ 定义为离开亚稳态盆地 $A$ 并继续到达产物盆地 $B$ 的轨迹的通量。这可以表示为两个量的乘积：\n1.  从盆地 $A$ 穿过第一个界面 $n_0$ 的轨迹通量 $\\phi$。\n2.  一条轨迹在穿过 $n_0$ 后，将前进到盆地 $B$ 而非返回到 $A$ 的概率 $P(B \\mid n_0)$。\n\n这给出了基本速率表达式：\n$$k = \\phi \\cdot P(B \\mid n_0)$$\n问题提供了估计每个项的数据。通量的估计量 $\\hat{\\phi}$ 是观测到的穿过 $n_0$ 的次数 $N_{\\mathrm{flux}}$ 除以总模拟时间 $T$：\n$$\\hat{\\phi} = \\frac{N_{\\mathrm{flux}}}{T}$$\n概率 $P(B \\mid n_0)$ 是指一条轨迹在已穿过 $n_0$ 的条件下，到达盆地 $B$（定义为穿过最后一个界面 $n_m$）的概率。在 TIS 中，这被分解为穿越连续界面的条件概率的乘积。使用全概率定律，并假设界面穿越具有马尔可夫性质（TIS 的一个核心假设），我们有：\n$$P(B \\mid n_0) = P(n_m \\mid n_0) = \\prod_{i=0}^{m-1} P(n_{i+1} \\mid n_i)$$\n令 $p_i = P(n_{i+1} \\mid n_i)$。每个条件概率的估计量 $\\hat{p}_i$ 由成功试验次数 $S_i$ 与从界面 $n_i$ 生成的总尝试路径数 $M_i$ 之比给出：\n$$\\hat{p}_i = \\frac{S_i}{M_i}$$\n结合这些估计量，我们构建总成核速率的估计量 $\\hat{k}$：\n$$\\hat{k} = \\hat{\\phi} \\cdot \\prod_{i=0}^{m-1} \\hat{p}_i = \\frac{N_{\\mathrm{flux}}}{T} \\prod_{i=0}^{m-1} \\frac{S_i}{M_i}$$\n此表达式与问题的条件一致，即如果 $N_{\\mathrm{flux}} = 0$ 或任何 $S_i = 0$，则 $\\hat{k}=0$。\n\n**2. 不确定度传播和置信区间**\n\n为了找到 $\\hat{k}$ 的 $95\\%$ 置信区间，我们按照指定，在对数空间中传播来自采样量（$N_{\\mathrm{flux}}$ 和每个 $S_i$）的不确定度。令 $Y = \\ln(\\hat{k})$。\n$$Y = \\ln(\\hat{k}) = \\ln\\left( \\frac{N_{\\mathrm{flux}}}{T} \\right) + \\sum_{i=0}^{m-1} \\ln\\left( \\frac{S_i}{M_i} \\right)$$\n由于 $T$ 和每个 $M_i$ 是固定的模拟参数，没有统计不确定性，我们可以写成：\n$$Y = \\ln(N_{\\mathrm{flux}}) - \\ln(T) + \\sum_{i=0}^{m-1} \\left( \\ln(S_i) - \\ln(M_i) \\right)$$\n问题指出所有分量（$N_{\\mathrm{flux}}$ 和每个 $S_i$）都是独立的。因此，和的方差是方差的和：\n$$\\sigma_Y^2 = \\mathrm{Var}(Y) = \\mathrm{Var}(\\ln(N_{\\mathrm{flux}})) + \\sum_{i=0}^{m-1} \\mathrm{Var}(\\ln(S_i))$$\n我们使用德尔塔方法进行误差传播，该方法将函数 $f(X)$ 的方差近似为 $\\mathrm{Var}(f(X)) \\approx (f'(E[X]))^2 \\mathrm{Var}(X)$。对于对数函数，这导致了基于相对不确定度的近似：$\\mathrm{Var}(\\ln(X)) \\approx \\mathrm{Var}(X) / (E[X])^2$。\n\n**$\\ln(N_{\\mathrm{flux}})$ 的方差：**\n$N_{\\mathrm{flux}}$被建模为服从泊松分布的随机变量。对于泊松分布，方差等于均值。我们用观测到的计数值 $N_{\\mathrm{flux}}$ 来估计均值 $\\lambda$。因此，$E[N_{\\mathrm{flux}}] \\approx N_{\\mathrm{flux}}$ 且 $\\mathrm{Var}(N_{\\mathrm{flux}}) \\approx N_{\\mathrm{flux}}$。\n$$\\mathrm{Var}(\\ln(N_{\\mathrm{flux}})) \\approx \\frac{\\mathrm{Var}(N_{\\mathrm{flux}})}{ (E[N_{\\mathrm{flux}}])^2 } \\approx \\frac{N_{\\mathrm{flux}}}{ (N_{\\mathrm{flux}})^2 } = \\frac{1}{N_{\\mathrm{flux}}}$$\n当 $N_{\\mathrm{flux}}=0$ 时，此项未定义，这由不确定度为 $0$ 的特殊情况处理。\n\n**$\\ln(S_i)$ 的方差：**\n每个 $S_i$ 被建模为服从二项分布的随机变量，$S_i \\sim \\mathrm{Binom}(M_i, p_i)$。其均值为 $E[S_i] = M_i p_i$，方差为 $\\mathrm{Var}(S_i) = M_i p_i (1-p_i)$。我们使用估计量 $\\hat{p}_i = S_i / M_i$。\n$$\\mathrm{Var}(\\ln(S_i)) \\approx \\frac{\\mathrm{Var}(S_i)}{ (E[S_i])^2 } \\approx \\frac{M_i \\hat{p}_i (1-\\hat{p}_i)}{ (M_i \\hat{p}_i)^2 } = \\frac{1-\\hat{p}_i}{M_i \\hat{p}_i}$$\n代入 $\\hat{p}_i = S_i / M_i$：\n$$\\mathrm{Var}(\\ln(S_i)) \\approx \\frac{1 - (S_i/M_i)}{M_i (S_i/M_i)} = \\frac{(M_i-S_i)/M_i}{S_i} = \\frac{M_i-S_i}{M_i S_i}$$\n当 $S_i=0$ 时此项未定义（由特殊情况处理），如果 $S_i=M_i$ 则等于 $0$，正确地反映了该特定概率估计中没有不确定性。\n\n**总方差和置信区间：**\n$Y = \\ln(\\hat{k})$ 的总方差是这些分量之和：\n$$\\sigma_Y^2 \\approx \\frac{1}{N_{\\mathrm{flux}}} + \\sum_{i=0}^{m-1} \\frac{M_i-S_i}{M_i S_i}$$\n假设 $Y$ 近似服从正态分布（根据中心极限定理），$Y$ 的一个 $95\\%$ 置信区间由 $[Y - z \\sigma_Y, Y + z \\sigma_Y]$ 给出，其中 $\\sigma_Y = \\sqrt{\\sigma_Y^2}$ 且 $z$ 是标准正态分布的第 $97.5$ 百分位数（$z \\approx 1.96$）。\n为了获得 $\\hat{k}$ 的置信区间，我们将 $Y$ 区间的端点取指数：\n$$[\\hat{k}_{\\mathrm{low}}, \\hat{k}_{\\mathrm{high}}] = [\\exp(\\ln(\\hat{k}) - z \\sigma_Y), \\exp(\\ln(\\hat{k}) + z \\sigma_Y)] = [\\hat{k} e^{-z \\sigma_Y}, \\hat{k} e^{z \\sigma_Y}]$$\n如果 $N_{\\mathrm{flux}} = 0$ 或任何 $S_i = 0$，问题规定 $\\hat{k}=0$ 且区间为 $[\\hat{k}_{\\mathrm{low}}, \\hat{k}_{\\mathrm{high}}] = [0, 0, 0]$。这是下面实现的算法。",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Solves the Transition Interface Sampling problem for the given test cases.\n    \"\"\"\n    test_cases = [\n        (500, 100000, [(1000, 200), (800, 160), (600, 120)]),\n        (50, 10000, [(300, 300), (200, 2), (500, 25)]),\n        (100, 100000, [(100, 10), (200, 0), (400, 200)]),\n        (0, 100000, [(1000, 500), (1000, 500)]),\n    ]\n\n    def calculate_rate_and_ci(N_flux, T, interfaces):\n        \"\"\"\n        Calculates the nucleation rate estimator and its 95% confidence interval.\n\n        Args:\n            N_flux (int): The flux count of reactive crossings of n0.\n            T (float): The total simulation time in seconds.\n            interfaces (list): A list of tuples (Mi, Si) for each interface.\n\n        Returns:\n            list: A list containing [k_hat, k_low, k_high].\n        \"\"\"\n        S_counts = [s for m, s in interfaces]\n\n        # Handle the special case where rate is zero due to no flux or no successes\n        if N_flux == 0 or any(s == 0 for s in S_counts):\n            return [0.0, 0.0, 0.0]\n\n        # 1. Calculate the rate estimator k_hat\n        # Flux estimator\n        phi_hat = N_flux / T\n        \n        # Conditional probability estimators\n        p_hats = [s / m for m, s in interfaces]\n        \n        # Overall rate estimator\n        k_hat = phi_hat * np.prod(p_hats)\n\n        # 2. Calculate the variance of log(k_hat) for uncertainty propagation\n        # Flux contribution to variance\n        var_log_k = 1.0 / N_flux\n        \n        # Interface crossing contributions to variance\n        for m, s in interfaces:\n            # The case s=m results in a zero term, correctly reflecting no uncertainty from this interface.\n            # The case s=0 is already handled above.\n            if s  m:\n                var_log_k += (m - s) / (m * s)\n        \n        sigma_log_k = np.sqrt(var_log_k)\n\n        # 3. Construct the 95% confidence interval\n        # z-score for a 95% confidence interval (two-tailed)\n        z = norm.ppf(1 - 0.05 / 2)\n        \n        # Calculate lower and upper bounds by exponentiating the log-space interval\n        factor = np.exp(z * sigma_log_k)\n        k_low = k_hat / factor\n        k_high = k_hat * factor\n\n        return [k_hat, k_low, k_high]\n\n    results = []\n    for case in test_cases:\n        N_flux_case, T_case, interfaces_case = case\n        result = calculate_rate_and_ci(N_flux_case, T_case, interfaces_case)\n        results.append(result)\n\n    # Format the final output string exactly as required\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}