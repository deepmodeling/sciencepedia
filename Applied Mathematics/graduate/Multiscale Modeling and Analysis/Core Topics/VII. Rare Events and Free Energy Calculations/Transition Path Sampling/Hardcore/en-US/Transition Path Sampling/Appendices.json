{
    "hands_on_practices": [
        {
            "introduction": "The shooting move is the engine of Transition Path Sampling, generating new candidate pathways by perturbing a point along an existing trajectory. To ensure the sampled paths correctly represent the true transition path ensemble, we must accept or reject these new paths according to a criterion that satisfies detailed balance. This foundational exercise  guides you through deriving this acceptance ratio from first principles, demonstrating how it unifies under different thermodynamic ensembles and depends only on the change in energy at the shooting point.",
            "id": "3826162",
            "problem": "Consider a system of $N$ particles with Hamiltonian $H(\\mathbf{q},\\mathbf{p}) = K(\\mathbf{p}) + U(\\mathbf{q})$, where $K(\\mathbf{p}) = \\sum_{i=1}^{N} \\frac{|\\mathbf{p}_{i}|^{2}}{2 m_{i}}$ is the kinetic energy and $U(\\mathbf{q})$ is a smooth potential energy. In transition path sampling, a shooting move is constructed by selecting a shooting time $t^{\\star}$ and phase point $x^{\\star} = (\\mathbf{q}^{\\star}, \\mathbf{p}^{\\star})$, then proposing new momenta via a symmetric Gaussian perturbation\n$$\n\\mathbf{p}^{\\text{prop}} = \\mathbf{p}^{\\star} + \\boldsymbol{\\eta}, \\quad \\boldsymbol{\\eta} \\sim \\mathcal{N}\\big( \\mathbf{0}, \\sigma^{2} \\mathbf{M} \\big),\n$$\nwhere $\\mathbf{M}$ is a diagonal mass matrix with entries $m_{i}$ and $\\sigma  0$. For microcanonical (constant-energy, Newtonian) dynamics (denoted NVE), a scalar velocity rescaling $c$ is applied so that the post-perturbation state satisfies $H(\\mathbf{q}^{\\star}, c \\mathbf{p}^{\\text{prop}}) = E_{0}$, where $E_{0}$ is the target energy. Assume deterministic, time-reversible, measure-preserving dynamics and that the shooting proposal distribution is symmetric.\n\nStarting from the requirement of detailed balance for the path ensemble and using only the core definitions of the microcanonical and canonical distributions, derive the acceptance ratio for this shooting move. Express your result as a single closed-form analytic expression that can be evaluated under both scenarios:\n- For the microcanonical ensemble (NVE) with the energy-conserving rescaling,\n- For a canonical ensemble (isothermal, denoted NVT) when thermostatting is applied at inverse temperature $\\beta$.\n\nDefine the energy change at the shooting point by $\\Delta E = H(\\mathbf{q}^{\\star}, \\mathbf{p}^{\\text{new}}) - H(\\mathbf{q}^{\\star}, \\mathbf{p}^{\\star})$, where $\\mathbf{p}^{\\text{new}}$ is the momentum entering forward and backward integration after the proposal step (with or without rescaling, consistent with the ensemble). Your final answer must be a single analytic expression in terms of $\\beta$ and $\\Delta E$, dimensionless, and must not contain inequalities or equations. Do not round; no numerical evaluation is required.",
            "solution": "We derive the acceptance ratio for a shooting move in transition path sampling using first principles: detailed balance, symmetry of the proposal, and the equilibrium phase-space weights of the ensemble.\n\nThe path ensemble weight is proportional to the equilibrium weight of the shooting point and the characteristic functions that enforce boundary conditions (membership in reactant and product basins). Under deterministic, time-reversible, measure-preserving dynamics, and with a symmetric proposal for the shooting perturbation, the Metropolis-Hastings acceptance ratio reduces to the ratio of equilibrium weights evaluated at the shooting point before and after the perturbation. This follows from the detailed balance condition applied to paths, but because the forward and backward integrations are deterministic and the proposal kernel is symmetric, the Jacobian determinant for mapping phase points to paths is unity, and the proposal probabilities cancel in the acceptance ratio.\n\nLet $x^{\\star} = (\\mathbf{q}^{\\star}, \\mathbf{p}^{\\star})$ be the original shooting point and $x' = (\\mathbf{q}^{\\star}, \\mathbf{p}^{\\text{new}})$ be the perturbed shooting point that seeds the new path (after possible rescaling). The acceptance ratio $R$ can be written in terms of the equilibrium weights $\\rho$ as\n$$\nR = \\frac{\\rho(x')}{\\rho(x^{\\star})}.\n$$\n\nWe now consider the ensemble weights:\n\n1. Microcanonical ensemble (NVE). The microcanonical density is\n$$\n\\rho_{\\text{micro}}(x) \\propto \\delta\\big(H(x) - E_{0}\\big),\n$$\nwhere $\\delta$ is the Dirac delta distribution and $E_{0}$ is the fixed energy of the ensemble. By construction of the shooting move in NVE, we rescale the proposed momenta by a scalar $c$ to enforce\n$$\nH(\\mathbf{q}^{\\star}, c \\mathbf{p}^{\\text{prop}}) = E_{0}.\n$$\nThus, the post-perturbation state $x'$ satisfies $H(x') = E_{0}$, exactly as the original state $x^{\\star}$ does. Therefore, both $\\rho_{\\text{micro}}(x')$ and $\\rho_{\\text{micro}}(x^{\\star})$ are supported at the same energy shell, and their ratio is equal to one:\n$$\nR_{\\text{micro}} = \\frac{\\rho_{\\text{micro}}(x')}{\\rho_{\\text{micro}}(x^{\\star})} = 1.\n$$\nThis result is independent of the details of the symmetric Gaussian perturbation because the proposal symmetry and the rescaling ensure both points lie on the same microcanonical manifold.\n\n2. Canonical ensemble (NVT). When thermostatting is applied and the system is sampled from the canonical distribution at inverse temperature $\\beta$, the equilibrium weight is\n$$\n\\rho_{\\text{can}}(x) \\propto \\exp\\big(-\\beta H(x)\\big).\n$$\nFor a symmetric proposal, the acceptance ratio becomes\n$$\nR_{\\text{can}} = \\frac{\\exp\\big(-\\beta H(x')\\big)}{\\exp\\big(-\\beta H(x^{\\star})\\big)} = \\exp\\big(-\\beta\\big[H(x') - H(x^{\\star})\\big]\\big).\n$$\nDefining the energy change at the shooting point by\n$$\n\\Delta E = H(\\mathbf{q}^{\\star}, \\mathbf{p}^{\\text{new}}) - H(\\mathbf{q}^{\\star}, \\mathbf{p}^{\\star}),\n$$\nwe obtain\n$$\nR_{\\text{can}} = \\exp(-\\beta \\Delta E).\n$$\n\nWe seek a single analytic expression that is valid in both settings. In the microcanonical case, the energy change enforced by rescaling is $\\Delta E = 0$, which gives\n$$\nR_{\\text{micro}} = \\exp(-\\beta \\cdot 0) = 1.\n$$\nIn the canonical case, $\\Delta E$ is the actual energy change induced by the shooting perturbation, so\n$$\nR_{\\text{can}} = \\exp(-\\beta \\Delta E).\n$$\n\nThus, the acceptance ratio for the shooting move can be uniformly expressed in terms of $\\beta$ and $\\Delta E$ as\n$$\nR = \\exp(-\\beta \\Delta E),\n$$\nwhich correctly reduces to unity in the microcanonical case because $\\Delta E = 0$ under the energy-conserving rescaling, and yields the canonical weight ratio when thermostatting is applied.\n\nNo additional factors appear because the proposal is symmetric (Gaussian with zero mean and equal covariance in forward and reverse moves), the deterministic dynamics are measure-preserving, and the mapping from the shooting point to the path has unit Jacobian, ensuring that the acceptance ratio is determined solely by the ratio of equilibrium weights at the shooting point. The final expression is dimensionless and depends only on the inverse temperature $\\beta$ and the energy change $\\Delta E$.",
            "answer": "$$\\boxed{\\exp(-\\beta \\Delta E)}$$"
        },
        {
            "introduction": "After mastering the acceptance criterion for a shooting move, a key question for practical efficiency arises: where along a path should we choose to shoot from? The choice of shooting point significantly influences the likelihood of generating a new, successful reactive trajectory. This problem  delves into this strategic aspect by connecting the shooting move's acceptance probability to the committor function, a central concept in the theory of rare events. By analyzing different selection strategies, you will gain a deeper understanding of how to optimize TPS simulations.",
            "id": "3826190",
            "problem": "Consider Transition Path Sampling (TPS) for a symmetric one-dimensional double-well system with potential $U(x) = \\frac{1}{4}\\left(x^{2} - 1\\right)^{2}$, minima near $x=-1$ and $x=1$, and a barrier at $x=0$. Let $A$ and $B$ denote disjoint sets corresponding to the left and right wells, respectively, and suppose the dynamics is ergodic, Markovian, and time-reversible with detailed balance with respect to the Boltzmann weight proportional to $\\exp(-\\beta U(x))$ at inverse temperature $\\beta$. Define the forward committor $q^{+}(x)$ as the probability that a trajectory initiated at $x$ reaches $B$ before $A$, and the backward committor $q^{-}(x)$ as the probability that the trajectory came from $A$ rather than $B$ when traced backward in time.\n\nIn TPS shooting, a new path is proposed by selecting a shooting point on the current reactive path and regenerating both the backward and forward segments using a symmetric perturbation consistent with time-reversibility. Assume that the acceptance of a proposed shooting move requires that the backward segment reaches $A$ and the forward segment reaches $B$, and that, given a shooting point, these outcomes follow the Markov property.\n\nTwo shooting point selection strategies are considered:\n\n- Scheme U (uniform in committor): select shooting points with a probability density that is uniform in the forward committor $q^{+}$, i.e., treat $q^{+}$ as a reaction-coordinate-like parametrization and choose shooting points with equal probability per unit increment of $q^{+}\\in[0,1]$.\n\n- Scheme LV (low-variance bias): select shooting points only when the forward committor lies in the sets $q^{+}\\in[0,\\delta]\\cup[1-\\delta,1]$ for a fixed $0\\delta\\frac{1}{2}$, with uniform probability density within these sets, motivated by the low Bernoulli variance $q^{+}(1-q^{+})$ for estimates of the committor near $0$ or $1$.\n\nStarting from the fundamental definitions of the forward and backward committors and the detailed-balance property of the reversible dynamics, derive the expression for the expected acceptance probability under each scheme. Then, compute the expected acceptance change, defined as the expected acceptance under Scheme LV minus that under Scheme U, as a closed-form analytic expression in terms of $\\delta$. Express your final answer without units. No rounding is required.",
            "solution": "The problem asks for the expected acceptance change between two shooting point selection schemes in Transition Path Sampling (TPS). We begin by establishing the fundamental expression for the acceptance probability of a shooting move.\n\nA proposed new path is generated by selecting a point $x$ on an existing reactive path and regenerating the forward and backward segments of the trajectory from this point. The move is accepted if the new forward-propagated segment reaches state $B$ before state $A$, and the new backward-propagated segment reaches state $A$ before state $B$. The problem states that, given the shooting point $x$, these two outcomes are independent due to the Markov property of the dynamics.\n\nThe probability that a trajectory initiated at $x$ reaches $B$ before $A$ is given by the forward committor, $q^{+}(x)$. The probability that a trajectory traced backward in time from $x$ came from $A$ rather than $B$ is given by the backward committor, $q^{-}(x)$. Therefore, the acceptance probability for a shooting move initiated at point $x$, denoted $P_{\\text{acc}}(x)$, is the product of these two probabilities:\n$$P_{\\text{acc}}(x) = q^{+}(x) q^{-}(x)$$\n\nThe problem specifies that the system dynamics are governed by a symmetric potential $U(x) = \\frac{1}{4}\\left(x^{2} - 1\\right)^{2}$, which satisfies $U(x) = U(-x)$. The states $A$ and $B$ correspond to the wells near $x=-1$ and $x=1$, respectively, forming a symmetric arrangement. Furthermore, the dynamics are ergodic, Markovian, and exhibit time-reversibility with respect to the Boltzmann weight.\n\nFor such a time-reversible system with spatial symmetry, there is a direct relationship between the forward and backward committors. The backward committor $q^{-}(x)$ is the probability that the trajectory, traced backward in time from $x$, came from $A$. Due to time-reversibility, this is equivalent to the probability that a time-reversed trajectory initiated at $x$ will reach state $A$ before state $B$. For dynamics on a symmetric potential energy surface, the probability of a path is identical to that of its spatially inverted counterpart (i.e., $x(t) \\to -x(t)$). Hence, the probability of reaching $A$ from $x$ is equivalent to reaching $-A$ from $-x$. With the symmetric definitions of states $A$ and $B$, we have $-A=B$ and $-B=A$. However, the more direct consequence of time-reversibility on a symmetric equilibrium system is that the probability of a forward trajectory from $x$ reaching $A$ before $B$ is precisely $q^{-}(x)$. The probability of reaching $B$ before $A$ is $q^{+}(x)$, and since these are the only two possible outcomes for a trajectory starting outside of $A$ and $B$, their probabilities must sum to $1$. Thus, the probability of reaching $A$ before $B$ is $1 - q^{+}(x)$. This leads to the crucial identity:\n$$q^{-}(x) = 1 - q^{+}(x)$$\nSubstituting this into the expression for the acceptance probability, we find that $P_{\\text{acc}}$ depends only on the forward committor value:\n$$P_{\\text{acc}}(q^{+}(x)) = q^{+}(x) \\left(1 - q^{+}(x)\\right)$$\nTo simplify notation, let $q_p$ represent a value of the forward committor, $q_p \\in [0, 1]$. The acceptance probability for a point with committor value $q_p$ is $P_{\\text{acc}}(q_p) = q_p(1-q_p)$.\n\nWe now compute the expected acceptance probability for each selection scheme by integrating $P_{\\text{acc}}(q_p)$ over the probability density of selecting a shooting point with committor value $q_p$.\n\n**Scheme U (uniform in committor):**\nThe shooting points are selected with a probability density $p_U(q_p)$ that is uniform in the forward committor $q_p \\in [0,1]$. For the density to be normalized, $\\int_0^1 p_U(q_p) dq_p = 1$, we must have $p_U(q_p) = 1$ for $q_p \\in [0,1]$ and $0$ otherwise.\nThe expected acceptance probability, $\\langle P_{\\text{acc}} \\rangle_U$, is:\n$$\\langle P_{\\text{acc}} \\rangle_U = \\int_{0}^{1} P_{\\text{acc}}(q_p) p_U(q_p) dq_p = \\int_{0}^{1} q_p(1-q_p) \\cdot 1 \\, dq_p$$\n$$\\langle P_{\\text{acc}} \\rangle_U = \\int_{0}^{1} (q_p - q_p^2) dq_p = \\left[ \\frac{q_p^2}{2} - \\frac{q_p^3}{3} \\right]_0^1 = \\frac{1^2}{2} - \\frac{1^3}{3} = \\frac{1}{2} - \\frac{1}{3} = \\frac{1}{6}$$\n\n**Scheme LV (low-variance bias):**\nThe shooting points are selected with a uniform probability density $p_{LV}(q_p)$ only within the sets where $q_p \\in [0, \\delta] \\cup [1-\\delta, 1]$, for a fixed $0  \\delta  \\frac{1}{2}$. The total width of this support in committor space is $\\delta + (1 - (1-\\delta)) = 2\\delta$. Normalizing the probability density over this support gives:\n$$p_{LV}(q_p) = \\begin{cases} \\frac{1}{2\\delta}  \\text{if } q_p \\in [0, \\delta] \\cup [1-\\delta, 1] \\\\ 0  \\text{otherwise} \\end{cases}$$\nThe expected acceptance probability, $\\langle P_{\\text{acc}} \\rangle_{LV}$, is:\n$$\\langle P_{\\text{acc}} \\rangle_{LV} = \\int_{0}^{1} P_{\\text{acc}}(q_p) p_{LV}(q_p) dq_p = \\frac{1}{2\\delta} \\left( \\int_{0}^{\\delta} q_p(1-q_p) dq_p + \\int_{1-\\delta}^{1} q_p(1-q_p) dq_p \\right)$$\nThe integrand $f(q_p) = q_p(1-q_p)$ is symmetric about $q_p = \\frac{1}{2}$. Therefore, the integral over $[0, \\delta]$ is equal to the integral over $[1-\\delta, 1]$. We can write:\n$$\\langle P_{\\text{acc}} \\rangle_{LV} = \\frac{1}{2\\delta} \\cdot 2 \\int_{0}^{\\delta} q_p(1-q_p) dq_p = \\frac{1}{\\delta} \\int_{0}^{\\delta} (q_p - q_p^2) dq_p$$\n$$\\langle P_{\\text{acc}} \\rangle_{LV} = \\frac{1}{\\delta} \\left[ \\frac{q_p^2}{2} - \\frac{q_p^3}{3} \\right]_0^\\delta = \\frac{1}{\\delta} \\left( \\frac{\\delta^2}{2} - \\frac{\\delta^3}{3} \\right) = \\frac{\\delta}{2} - \\frac{\\delta^2}{3}$$\n\n**Expected Acceptance Change:**\nFinally, we compute the expected acceptance change, defined as the expected acceptance under Scheme LV minus that under Scheme U.\n$$\\Delta \\langle P_{\\text{acc}} \\rangle = \\langle P_{\\text{acc}} \\rangle_{LV} - \\langle P_{\\text{acc}} \\rangle_U$$\n$$\\Delta \\langle P_{\\text{acc}} \\rangle = \\left(\\frac{\\delta}{2} - \\frac{\\delta^2}{3}\\right) - \\frac{1}{6}$$\nTo present this as a single expression, we find a common denominator:\n$$\\Delta \\langle P_{\\text{acc}} \\rangle = \\frac{3\\delta}{6} - \\frac{2\\delta^2}{6} - \\frac{1}{6} = \\frac{3\\delta - 2\\delta^2 - 1}{6}$$\nThis is the final closed-form analytic expression for the expected acceptance change in terms of $\\delta$.",
            "answer": "$$ \\boxed{\\frac{3\\delta - 2\\delta^2 - 1}{6}} $$"
        },
        {
            "introduction": "Ultimately, the goal of many rare event simulations is to compute a physical rate constant. Transition Interface Sampling (TIS) is a powerful framework built upon the principles of TPS that accomplishes this by breaking down a rare transition into a series of more frequent events. This hands-on coding problem  challenges you to implement the TIS rate calculation, combining the flux out of the reactant state with a product of conditional crossing probabilities. Crucially, it also requires you to perform a complete uncertainty analysis, a vital skill for any computational scientist seeking to produce robust, credible results.",
            "id": "3826148",
            "problem": "Consider a coarse-grained nucleation process modeled with Transition Interface Sampling (TIS), where the order parameter $n$ defines nested interfaces $\\{n_0,n_1,\\dots,n_m\\}$ between a metastable basin $A$ (small $n$) and product basin $B$ (large $n$). Assume a steady-state molecular dynamics in which trajectories leaving basin $A$ can cross interface $n_0$ and either return to $A$ or eventually reach basin $B$ by sequentially crossing interfaces. Use only the following fundamental bases: (i) the definition of flux as the number of events per unit time, (ii) the law of total probability applied to sequential interface crossings, and (iii) standard statistical models for counting experiments, specifically the Poisson model for flux events and the Binomial model for interface-crossing successes.\n\nYour task is to derive and implement an estimator for the overall nucleation rate and its uncertainty from sampled counts. For each test case, you are given:\n- A flux count $N_{\\mathrm{flux}}$ of reactive crossings of $n_0$ originating from basin $A$ during a total simulation time $T$ (in seconds).\n- For each interface $i \\in \\{0,1,\\dots,m-1\\}$, the number of generated trial paths $M_i$ started from interface $n_i$ and the number of those trials $S_i$ that successfully reached interface $n_{i+1}$ before returning to basin $A$.\n\nFrom these data, construct:\n- The estimator $\\hat{p}_i = S_i/M_i$ for the conditional probability $P(n_{i+1}\\mid n_i)$.\n- The estimator $\\hat{\\phi} = N_{\\mathrm{flux}}/T$ (in $\\mathrm{s}^{-1}$) for the flux across $n_0$ out of basin $A$.\n- The overall nucleation rate estimator $\\hat{k}$ (in $\\mathrm{s}^{-1}$) consistent with TIS definitions, using only the above fundamental bases.\n- An approximate $95\\%$ confidence interval $[\\hat{k}_{\\mathrm{low}}, \\hat{k}_{\\mathrm{high}}]$ (both in $\\mathrm{s}^{-1}$) by propagating uncertainty in log-space under the assumptions that $N_{\\mathrm{flux}}$ is Poisson-distributed and each $S_i$ is Binomial-distributed with $M_i$ trials and success probability $p_i$. Treat all components as independent. If any $\\hat{p}_i=0$ or $N_{\\mathrm{flux}}=0$, define $\\hat{k}=0$ and set $\\hat{k}_{\\mathrm{low}}=\\hat{k}_{\\mathrm{high}}=0$.\n\nImplement the computation for the following test suite. Each test case lists $(N_{\\mathrm{flux}}, T, [(M_0,S_0), (M_1,S_1), \\dots])$:\n- Test case $1$: $N_{\\mathrm{flux}}=500$, $T=100000$, interfaces $\\left[(1000,200),(800,160),(600,120)\\right]$.\n- Test case $2$: $N_{\\mathrm{flux}}=50$, $T=10000$, interfaces $\\left[(300,300),(200,2),(500,25)\\right]$.\n- Test case $3$: $N_{\\mathrm{flux}}=100$, $T=100000$, interfaces $\\left[(100,10),(200,0),(400,200)\\right]$.\n- Test case $4$: $N_{\\mathrm{flux}}=0$, $T=100000$, interfaces $\\left[(1000,500),(1000,500)\\right]$.\n\nAll rates must be expressed in $\\mathrm{s}^{-1}$, and all outputs must be floating-point numbers. Your program should produce a single line of output containing the results for the above test cases as a comma-separated list enclosed in square brackets. Each test case result must itself be a list of three floating-point numbers in the order $[\\hat{k},\\hat{k}_{\\mathrm{low}},\\hat{k}_{\\mathrm{high}}]$, for example: $[[k_1,l_1,u_1],[k_2,l_2,u_2],\\dots]$.",
            "solution": "The problem statement is evaluated as valid. It is scientifically grounded in the principles of statistical mechanics and rare event sampling, specifically Transition Interface Sampling (TIS). The problem is well-posed, objective, and provides all necessary information to derive a unique, meaningful solution without contradiction or ambiguity. The required calculations represent a standard application of TIS theory and statistical error propagation.\n\nThe derivation of the nucleation rate estimator and its confidence interval proceeds as follows, based on the fundamental principles specified in the problem.\n\n**1. Nucleation Rate Estimator $\\hat{k}$**\n\nThe overall nucleation rate, $k$, is defined as the flux of trajectories leaving the metastable basin $A$ that go on to reach the product basin $B$. This can be expressed as the product of two quantities:\n1.  The flux, $\\phi$, of trajectories crossing the first interface $n_0$ from basin $A$.\n2.  The probability, $P(B \\mid n_0)$, that a trajectory, having crossed $n_0$, will proceed to basin $B$ rather than return to $A$.\n\nThis gives the fundamental rate expression:\n$$k = \\phi \\cdot P(B \\mid n_0)$$\nThe problem provides data to estimate each term. The estimator for the flux, $\\hat{\\phi}$, is the number of observed crossings of $n_0$, $N_{\\mathrm{flux}}$, divided by the total simulation time, $T$:\n$$\\hat{\\phi} = \\frac{N_{\\mathrm{flux}}}{T}$$\nThe probability $P(B \\mid n_0)$ is the probability of a trajectory reaching basin $B$ (defined by crossing the final interface $n_m$) given it has crossed $n_0$. In TIS, this is decomposed into a product of conditional probabilities of crossing successive interfaces. Using the law of total probability, and assuming the Markovian nature of interface crossings (a core assumption in TIS), we have:\n$$P(B \\mid n_0) = P(n_m \\mid n_0) = \\prod_{i=0}^{m-1} P(n_{i+1} \\mid n_i)$$\nLet $p_i = P(n_{i+1} \\mid n_i)$. The estimator for each conditional probability, $\\hat{p}_i$, is given by the ratio of successful trials, $S_i$, to the total number of trial paths generated from interface $n_i$, $M_i$:\n$$\\hat{p}_i = \\frac{S_i}{M_i}$$\nCombining these estimators, we construct the estimator for the overall nucleation rate, $\\hat{k}$:\n$$\\hat{k} = \\hat{\\phi} \\cdot \\prod_{i=0}^{m-1} \\hat{p}_i = \\frac{N_{\\mathrm{flux}}}{T} \\prod_{i=0}^{m-1} \\frac{S_i}{M_i}$$\nThis expression is consistent with the problem's condition that if $N_{\\mathrm{flux}} = 0$ or any $S_i = 0$, then $\\hat{k}=0$.\n\n**2. Uncertainty Propagation and Confidence Interval**\n\nTo find the $95\\%$ confidence interval for $\\hat{k}$, we propagate the uncertainties from the sampled quantities ($N_{\\mathrm{flux}}$ and each $S_i$) in logarithmic space, as specified. Let $Y = \\ln(\\hat{k})$.\n$$Y = \\ln(\\hat{k}) = \\ln\\left( \\frac{N_{\\mathrm{flux}}}{T} \\right) + \\sum_{i=0}^{m-1} \\ln\\left( \\frac{S_i}{M_i} \\right)$$\nSince $T$ and each $M_i$ are fixed simulation parameters without statistical uncertainty, we can write:\n$$Y = \\ln(N_{\\mathrm{flux}}) - \\ln(T) + \\sum_{i=0}^{m-1} \\left( \\ln(S_i) - \\ln(M_i) \\right)$$\nThe problem states that all components ($N_{\\mathrm{flux}}$ and each $S_i$) are independent. Therefore, the variance of the sum is the sum of the variances:\n$$\\sigma_Y^2 = \\mathrm{Var}(Y) = \\mathrm{Var}(\\ln(N_{\\mathrm{flux}})) + \\sum_{i=0}^{m-1} \\mathrm{Var}(\\ln(S_i))$$\nWe use the delta method for error propagation, which approximates the variance of a function $f(X)$ as $\\mathrm{Var}(f(X)) \\approx (f'(E[X]))^2 \\mathrm{Var}(X)$. For a logarithmic function, this leads to the approximation based on relative uncertainty: $\\mathrm{Var}(\\ln(X)) \\approx \\mathrm{Var}(X) / (E[X])^2$.\n\n**Variance of $\\ln(N_{\\mathrm{flux}})$:**\n$N_{\\mathrm{flux}}$ is modeled as a Poisson-distributed random variable. For a Poisson distribution, the variance is equal to the mean. We estimate the mean $\\lambda$ with the observed count $N_{\\mathrm{flux}}$. Thus, $E[N_{\\mathrm{flux}}] \\approx N_{\\mathrm{flux}}$ and $\\mathrm{Var}(N_{\\mathrm{flux}}) \\approx N_{\\mathrm{flux}}$.\n$$\\mathrm{Var}(\\ln(N_{\\mathrm{flux}})) \\approx \\frac{\\mathrm{Var}(N_{\\mathrm{flux}})}{ (E[N_{\\mathrm{flux}}])^2 } \\approx \\frac{N_{\\mathrm{flux}}}{ (N_{\\mathrm{flux}})^2 } = \\frac{1}{N_{\\mathrm{flux}}}$$\nThis term is undefined for $N_{\\mathrm{flux}}=0$, which is handled by the special case where the uncertainty is $0$.\n\n**Variance of $\\ln(S_i)$:**\nEach $S_i$ is modeled as a Binomial-distributed random variable, $S_i \\sim \\mathrm{Binom}(M_i, p_i)$. The mean is $E[S_i] = M_i p_i$ and the variance is $\\mathrm{Var}(S_i) = M_i p_i (1-p_i)$. We use the estimators $\\hat{p}_i = S_i / M_i$.\n$$\\mathrm{Var}(\\ln(S_i)) \\approx \\frac{\\mathrm{Var}(S_i)}{ (E[S_i])^2 } \\approx \\frac{M_i \\hat{p}_i (1-\\hat{p}_i)}{ (M_i \\hat{p}_i)^2 } = \\frac{1-\\hat{p}_i}{M_i \\hat{p}_i}$$\nSubstituting $\\hat{p}_i = S_i / M_i$:\n$$\\mathrm{Var}(\\ln(S_i)) \\approx \\frac{1 - (S_i/M_i)}{M_i (S_i/M_i)} = \\frac{(M_i-S_i)/M_i}{S_i} = \\frac{M_i-S_i}{M_i S_i}$$\nThis term is undefined for $S_i=0$ (handled by the special case) and is equal to $0$ if $S_i=M_i$, correctly reflecting no uncertainty in that specific probability estimate.\n\n**Total Variance and Confidence Interval:**\nThe total variance of $Y = \\ln(\\hat{k})$ is the sum of these components:\n$$\\sigma_Y^2 \\approx \\frac{1}{N_{\\mathrm{flux}}} + \\sum_{i=0}^{m-1} \\frac{M_i-S_i}{M_i S_i}$$\nAssuming $Y$ is approximately normally distributed (by the Central Limit Theorem), a $95\\%$ confidence interval for $Y$ is given by $[Y - z \\sigma_Y, Y + z \\sigma_Y]$, where $\\sigma_Y = \\sqrt{\\sigma_Y^2}$ and $z$ is the $97.5$-th percentile of the standard normal distribution ($z \\approx 1.96$).\nTo obtain the confidence interval for $\\hat{k}$, we exponentiate the endpoints of the interval for $Y$:\n$$[\\hat{k}_{\\mathrm{low}}, \\hat{k}_{\\mathrm{high}}] = [\\exp(\\ln(\\hat{k}) - z \\sigma_Y), \\exp(\\ln(\\hat{k}) + z \\sigma_Y)] = [\\hat{k} e^{-z \\sigma_Y}, \\hat{k} e^{z \\sigma_Y}]$$\nIf $N_{\\mathrm{flux}} = 0$ or any $S_i = 0$, the problem specifies $\\hat{k}=0$ and the interval is $[\\hat{k}_{\\mathrm{low}}, \\hat{k}_{\\mathrm{high}}] = [0, 0, 0]$. This is the algorithm implemented below.",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Solves the Transition Interface Sampling problem for the given test cases.\n    \"\"\"\n    test_cases = [\n        (500, 100000, [(1000, 200), (800, 160), (600, 120)]),\n        (50, 10000, [(300, 300), (200, 2), (500, 25)]),\n        (100, 100000, [(100, 10), (200, 0), (400, 200)]),\n        (0, 100000, [(1000, 500), (1000, 500)]),\n    ]\n\n    def calculate_rate_and_ci(N_flux, T, interfaces):\n        \"\"\"\n        Calculates the nucleation rate estimator and its 95% confidence interval.\n\n        Args:\n            N_flux (int): The flux count of reactive crossings of n0.\n            T (float): The total simulation time in seconds.\n            interfaces (list): A list of tuples (Mi, Si) for each interface.\n\n        Returns:\n            list: A list containing [k_hat, k_low, k_high].\n        \"\"\"\n        S_counts = [s for m, s in interfaces]\n\n        # Handle the special case where rate is zero due to no flux or no successes\n        if N_flux == 0 or any(s == 0 for s in S_counts):\n            return [0.0, 0.0, 0.0]\n\n        # 1. Calculate the rate estimator k_hat\n        # Flux estimator\n        phi_hat = N_flux / T\n        \n        # Conditional probability estimators\n        p_hats = [s / m for m, s in interfaces]\n        \n        # Overall rate estimator\n        k_hat = phi_hat * np.prod(p_hats)\n\n        # 2. Calculate the variance of log(k_hat) for uncertainty propagation\n        # Flux contribution to variance\n        var_log_k = 1.0 / N_flux\n        \n        # Interface crossing contributions to variance\n        for m, s in interfaces:\n            # The case s=m results in a zero term, correctly reflecting no uncertainty from this interface.\n            # The case s=0 is already handled above.\n            if s  m:\n                var_log_k += (m - s) / (m * s)\n        \n        sigma_log_k = np.sqrt(var_log_k)\n\n        # 3. Construct the 95% confidence interval\n        # z-score for a 95% confidence interval (two-tailed)\n        z = norm.ppf(1 - 0.05 / 2)\n        \n        # Calculate lower and upper bounds by exponentiating the log-space interval\n        factor = np.exp(z * sigma_log_k)\n        k_low = k_hat / factor\n        k_high = k_hat * factor\n\n        return [k_hat, k_low, k_high]\n\n    results = []\n    for case in test_cases:\n        N_flux_case, T_case, interfaces_case = case\n        result = calculate_rate_and_ci(N_flux_case, T_case, interfaces_case)\n        results.append(result)\n\n    # Format the final output string exactly as required\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}