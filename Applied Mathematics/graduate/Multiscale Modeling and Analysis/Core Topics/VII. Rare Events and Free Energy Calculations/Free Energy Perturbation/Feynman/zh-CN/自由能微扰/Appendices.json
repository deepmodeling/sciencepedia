{
    "hands_on_practices": [
        {
            "introduction": "理论的优雅常常体现在简单的、可解析的模型中。在深入研究自由能计算的复杂应用之前，通过一个理想化的谐振子系统来检验自由能微扰（FEP）的基本原理是至关重要的。这项练习  将引导你通过两种不同的路径推导自由能差，从而深刻理解FEP公式与统计力学基本定义的内在联系。",
            "id": "3847564",
            "problem": "考虑一个处于固定温度 $T$ 下的经典一维系统，该系统由单一坐标 $x$ 和两个谐波势能函数描述：$U_{A}(x)=\\tfrac{1}{2}k_{A}x^{2}$ 和 $U_{B}(x)=\\tfrac{1}{2}k_{B}x^{2}$，其中 $k_{A}>0$ 和 $k_{B}>0$ 是力常数。仅使用正则系综的定义和经典统计力学的基本事实，用两种方法推导状态 $B$ 和状态 $A$ 之间的自由能差 $\\Delta F \\equiv F_{B}-F_{A}$：\n1. 从 $U_{A}(x)$ 下的正则平均定义出发，计算系综平均值 $\\langle \\exp(-\\beta\\Delta U)\\rangle_{A}$，其中 $\\Delta U(x)\\equiv U_{B}(x)-U_{A}(x)$ 且 $\\beta\\equiv 1/(k_{\\mathrm{B}}T)$，$k_{\\mathrm{B}}$ 是 Boltzmann 常数。使用这个平均值来获得 $\\Delta F$ 的解析表达式，除了正则定义之外，不借助任何预先陈述的恒等式。\n2. 独立地计算 $U_{B}$ 和 $U_{A}$ 的精确构型配分函数之比，并用它来获得 $\\Delta F$。证明两个结果一致。\n\n假设哈密顿量可分离为动能和势能部分，并注意在自由能差中，任何动量贡献都会相互抵消，因为状态 $A$ 和 $B$ 的动能是相同的。将您的最终答案以 $k_{A}$、$k_{B}$、$k_{\\mathrm{B}}$ 和 $T$ 的单个封闭形式表达式给出。以焦耳为单位表示自由能。不需要进行数值计算或四舍五入。",
            "solution": "题目要求推导一个一维经典系统的两个状态之间的 Helmholtz 自由能差 $\\Delta F \\equiv F_{B}-F_{A}$，该系统由谐波势能函数 $U_{A}(x)=\\tfrac{1}{2}k_{A}x^{2}$ 和 $U_{B}(x)=\\tfrac{1}{2}k_{B}x^{2}$ 描述。推导必须以两种不同的方式进行，以证明它们等价。我们已知逆温度 $\\beta \\equiv 1/(k_{\\mathrm{B}}T)$，其中 $k_{\\mathrm{B}}$ 是 Boltzmann 常数，$T$ 是固定温度。\n\n首先，我们建立自由能和配分函数之间的基本关系。Helmholtz 自由能 $F$ 由总正则配分函数 $Z$ 定义为：\n$$F = -k_{\\mathrm{B}}T \\ln Z = -\\frac{1}{\\beta} \\ln Z$$\n对于具有可分离哈密顿量 $H(p,x) = K(p) + U(x)$ 的一维系统，总配分函数 $Z$ 由对所有相空间坐标 $(p,x)$ 的积分给出：\n$$Z = \\frac{1}{h} \\int \\int \\exp(-\\beta H(p,x)) dp dx = \\left(\\frac{1}{h} \\int \\exp(-\\beta K(p)) dp\\right) \\left(\\int \\exp(-\\beta U(x)) dx\\right)$$\n其中 $h$ 是一个具有作用量单位的常数，用以使 $Z$ 无量纲，通常为 Planck 常数。我们可以将其写为 $Z = Z_{\\mathrm{kin}} Q$，其中 $Z_{\\mathrm{kin}}$ 是动能贡献，$Q$ 是构型配分函数，$Q = \\int_{-\\infty}^{\\infty} \\exp(-\\beta U(x)) dx$。\n\n自由能差 $\\Delta F$ 为：\n$$\\Delta F = F_{B} - F_{A} = \\left(-\\frac{1}{\\beta} \\ln Z_{B}\\right) - \\left(-\\frac{1}{\\beta} \\ln Z_{A}\\right) = -\\frac{1}{\\beta} \\ln\\left(\\frac{Z_{B}}{Z_{A}}\\right)$$\n由于状态 A 和 B 的动能项 $K(p)$ 相同，它们的动能配分函数 $Z_{\\mathrm{kin},A}$ 和 $Z_{\\mathrm{kin},B}$ 是相同的。因此，总配分函数之比简化为构型配分函数之比：\n$$\\frac{Z_{B}}{Z_{A}} = \\frac{Z_{\\mathrm{kin}} Q_{B}}{Z_{\\mathrm{kin}} Q_{A}} = \\frac{Q_{B}}{Q_{A}}$$\n因此，自由能差与构型配分函数直接相关：\n$$\\Delta F = -\\frac{1}{\\beta} \\ln\\left(\\frac{Q_{B}}{Q_{A}}\\right)$$\n这个从正则定义推导出的关系，将是两种方法的核心。\n\n**方法一：使用系综平均值进行推导**\n\n该方法要求我们计算系综平均值 $\\langle \\exp(-\\beta\\Delta U)\\rangle_{A}$ 并将其与 $\\Delta F$ 联系起来。首先，我们必须按要求从基本定义推导这个关系。\n\n状态 A 中某个量 $O(x)$ 的正则系综平均值定义为：\n$$\\langle O(x) \\rangle_{A} = \\frac{\\int_{-\\infty}^{\\infty} O(x) \\exp(-\\beta U_{A}(x)) dx}{\\int_{-\\infty}^{\\infty} \\exp(-\\beta U_{A}(x)) dx} = \\frac{\\int_{-\\infty}^{\\infty} O(x) \\exp(-\\beta U_{A}(x)) dx}{Q_{A}}$$\n我们感兴趣的是 $O(x) = \\exp(-\\beta\\Delta U(x))$ 的特定平均值，其中 $\\Delta U(x) = U_{B}(x) - U_{A}(x)$。将其代入定义中：\n$$\\langle \\exp(-\\beta\\Delta U) \\rangle_{A} = \\frac{\\int_{-\\infty}^{\\infty} \\exp(-\\beta(U_{B}(x) - U_{A}(x))) \\exp(-\\beta U_{A}(x)) dx}{Q_{A}}$$\n通过合并分子中的指数，我们发现：\n$$\\int_{-\\infty}^{\\infty} \\exp(-\\beta U_{B}(x) + \\beta U_{A}(x) - \\beta U_{A}(x)) dx = \\int_{-\\infty}^{\\infty} \\exp(-\\beta U_{B}(x)) dx = Q_{B}$$\n因此，系综平均值恰好是构型配分函数之比：\n$$\\langle \\exp(-\\beta\\Delta U) \\rangle_{A} = \\frac{Q_{B}}{Q_{A}}$$\n将此结果与前面推导的 $\\Delta F$ 表达式结合，我们得到自由能微扰恒等式：\n$$\\Delta F = -k_{\\mathrm{B}}T \\ln \\langle \\exp(-\\beta\\Delta U) \\rangle_{A}$$\n现在，我们为给定的势能显式计算该平均值。势能差为：\n$$\\Delta U(x) = U_{B}(x) - U_{A}(x) = \\frac{1}{2}k_{B}x^{2} - \\frac{1}{2}k_{A}x^{2} = \\frac{1}{2}(k_{B} - k_{A})x^{2}$$\n系综平均值为：\n$$\\langle \\exp(-\\beta\\Delta U) \\rangle_{A} = \\frac{\\int_{-\\infty}^{\\infty} \\exp\\left(-\\beta \\left(\\frac{1}{2}(k_{B}-k_{A})x^{2}\\right)\\right) \\exp\\left(-\\beta \\left(\\frac{1}{2}k_{A}x^{2}\\right)\\right) dx}{\\int_{-\\infty}^{\\infty} \\exp\\left(-\\beta \\left(\\frac{1}{2}k_{A}x^{2}\\right)\\right) dx}$$\n分子的积分为：\n$$I_{\\mathrm{num}} = \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\beta}{2}(k_{B}-k_{A}+k_{A})x^{2}\\right) dx = \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\beta k_{B}}{2}x^{2}\\right) dx$$\n分母的积分为：\n$$I_{\\mathrm{den}} = \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\beta k_{A}}{2}x^{2}\\right) dx$$\n这些是标准的高斯积分，形式为 $\\int_{-\\infty}^{\\infty} \\exp(-ax^{2})dx = \\sqrt{\\pi/a}$。\n对于分子，$a = \\frac{\\beta k_{B}}{2}$，所以 $I_{\\mathrm{num}} = \\sqrt{\\frac{2\\pi}{\\beta k_{B}}}$。\n对于分母，$a = \\frac{\\beta k_{A}}{2}$，所以 $I_{\\mathrm{den}} = \\sqrt{\\frac{2\\pi}{\\beta k_{A}}}$。\n系综平均值是这两个结果的比值：\n$$\\langle \\exp(-\\beta\\Delta U) \\rangle_{A} = \\frac{\\sqrt{2\\pi/(\\beta k_{B})}}{\\sqrt{2\\pi/(\\beta k_{A})}} = \\sqrt{\\frac{2\\pi}{\\beta k_{B}} \\cdot \\frac{\\beta k_{A}}{2\\pi}} = \\sqrt{\\frac{k_{A}}{k_{B}}}$$\n最后，我们将此代入 $\\Delta F$ 的表达式中：\n$$\\Delta F = -k_{\\mathrm{B}}T \\ln\\left(\\sqrt{\\frac{k_{A}}{k_{B}}}\\right) = -k_{\\mathrm{B}}T \\ln\\left(\\left(\\frac{k_{A}}{k_{B}}\\right)^{1/2}\\right) = -\\frac{1}{2}k_{\\mathrm{B}}T \\ln\\left(\\frac{k_{A}}{k_{B}}\\right)$$\n利用对数性质 $\\ln(1/x) = -\\ln(x)$，这可以写成：\n$$\\Delta F = \\frac{1}{2}k_{\\mathrm{B}}T \\ln\\left(\\frac{k_{B}}{k_{A}}\\right)$$\n\n**方法二：使用配分函数之比进行推导**\n\n此方法直接从构型配分函数之比 $Q_{B}/Q_{A}$ 计算 $\\Delta F$。如引言中所述，$\\Delta F = -k_{\\mathrm{B}}T \\ln(Q_{B}/Q_{A})$。\n\n状态 A 和 B 的构型配分函数为：\n$$Q_{A} = \\int_{-\\infty}^{\\infty} \\exp(-\\beta U_{A}(x)) dx = \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\beta k_{A}}{2}x^{2}\\right) dx$$\n$$Q_{B} = \\int_{-\\infty}^{\\infty} \\exp(-\\beta U_{B}(x)) dx = \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\beta k_{B}}{2}x^{2}\\right) dx$$\n使用高斯积分结果 $\\int_{-\\infty}^{\\infty} \\exp(-ax^{2})dx = \\sqrt{\\pi/a}$，我们计算每个配分函数：\n$$Q_{A} = \\sqrt{\\frac{\\pi}{(\\beta k_{A}/2)}} = \\sqrt{\\frac{2\\pi}{\\beta k_{A}}}$$\n$$Q_{B} = \\sqrt{\\frac{\\pi}{(\\beta k_{B}/2)}} = \\sqrt{\\frac{2\\pi}{\\beta k_{B}}}$$\n接下来，我们计算它们的比值：\n$$\\frac{Q_{B}}{Q_{A}} = \\frac{\\sqrt{2\\pi/(\\beta k_{B})}}{\\sqrt{2\\pi/(\\beta k_{A})}} = \\sqrt{\\frac{k_{A}}{k_{B}}}$$\n将此比值代入自由能差的方程中：\n$$\\Delta F = -k_{\\mathrm{B}}T \\ln\\left(\\frac{Q_{B}}{Q_{A}}\\right) = -k_{\\mathrm{B}}T \\ln\\left(\\sqrt{\\frac{k_{A}}{k_{B}}}\\right)$$\n这可以简化为：\n$$\\Delta F = -\\frac{1}{2}k_{\\mathrm{B}}T \\ln\\left(\\frac{k_{A}}{k_{B}}\\right) = \\frac{1}{2}k_{\\mathrm{B}}T \\ln\\left(\\frac{k_{B}}{k_{A}}\\right)$$\n\n**结论**\n\n两种方法都得出了相同的自由能差结果：$\\Delta F = \\frac{1}{2}k_{\\mathrm{B}}T \\ln(k_{B}/k_{A})$。这证实了两种方法的一致性，它们都是统计力学和计算自由能计算的基石。该表达式具有能量单位（国际单位制中为焦耳），因为乘积 $k_{\\mathrm{B}}T$ 具有能量单位，而对数项是无量纲的。",
            "answer": "$$\n\\boxed{\\frac{1}{2} k_{\\mathrm{B}}T \\ln\\left(\\frac{k_{B}}{k_{A}}\\right)}\n$$"
        },
        {
            "introduction": "在计算科学中，设计一个严谨的实验方案与运行模拟本身同等重要。本练习  提供了一个模拟计算药物分子与蛋白质结合自由能的“案例研究”，但其方案充满了方法论上的缺陷。通过批判性地分析这个方案，你将学会识别自由能计算中常见的、可能导致结果完全失效的严重错误，这是培养科研洞察力的关键一步。",
            "id": "2455870",
            "problem": "最近一篇论文报道了使用单步自由能微扰（FEP）方案计算一个大的、柔性的、类药物配体与蛋白质结合的“绝对”结合自由能。作者在正则系综（NVT）中，于 $T=300\\ \\mathrm{K}$ 温度下，使用 $2\\ \\mathrm{fs}$ 的时间步长，在一个显式溶剂盒子中模拟了蛋白质-配体复合物 $5\\ \\mathrm{ns}$。Lennard-Jones 相互作用在 $1.0\\ \\mathrm{nm}$ 的球形截断半径处被截断，且没有长程色散校正；静电相互作用在周期性边界条件下使用 Particle Mesh Ewald (PME) 方法处理。配体通过炼金术方法在单一步骤中被“关闭”：其与环境的非键相互作用被移除，所报告的自由能使用 Zwanzig 指数平均公式计算得出\n\n$$\n\\Delta G_{0\\to 1} \\;=\\; -k_{\\mathrm{B}}T \\,\\ln \\left\\langle \\exp\\!\\left[-\\beta\\big(U_{1}-U_{0}\\big)\\right]\\right\\rangle_{0},\n$$\n\n其中 $\\beta=1/(k_{\\mathrm{B}}T)$，$U_{0}$ 是完全相互作用的结合复合物的势能，$U_{1}$ 是配体与其环境完全解偶联时的势能，$\\langle\\cdot\\rangle_{0}$ 表示在从 $U_{0}$ 采样的构象上进行的系综平均。计算中没有使用中间耦合参数，没有对范德华相互作用应用软核修饰，并且只评估了正向 $0\\to 1$ 的过程。在解偶联过程中，配体的净电荷变化了 $+1e$；没有添加显式抗衡离子（依赖于 PME 的均匀中和背景）。没有施加位置或取向限制来将解偶联的配体保持在结合位点中，并且在通过 $\\Delta G^{\\circ}=RT\\ln K_{\\mathrm{d}}$ 将 $\\Delta G$ 转换为解离常数时没有添加标准态校正。作者没有进行溶剂“分支”（配体在体相水中的解偶联）的计算，也没有报告不确定度或收敛性诊断。\n\n根据所描述的方法学，下列哪些评论在科学上是合理的？选择所有适用的选项。\n\nA. 对于一个大的、柔性的配体，执行从完全相互作用态到完全不相互作用态的单步 FEP 可能会遭遇相空间重叠差的问题，这使得在没有中间态的情况下，指数平均 $-k_{\\mathrm{B}}T\\ln\\langle e^{-\\beta\\Delta U}\\rangle$ 变得不稳定且有偏。\n\nB. 忽略对结合位点中配体的限制以及相关的标准态校正，会使绝对结合自由能产生偏差，因为解偶联的配体可以自由平移和旋转；必须包含限制自由能和 $\\Delta G^{\\circ}$ 校正。\n\nC. 在有限周期性盒子中使用 PME 方法时，净电荷改变 $+1e$ 会因均匀中和背景和镜像相互作用而引入有限尺寸效应；需要进行净电荷校正，忽略它会使 $\\Delta G$ 产生偏差。\n\nD. 仅计算复合物“分支”（配体在蛋白质结合位点中的解偶联）不足以得到绝对结合自由能；一个热力学循环需要将复合物分支与溶剂分支（配体在水中的解偶联）以及限制和标准态项结合起来。\n\nE. 使用正则（NVT）系综而非等温等压（NPT）系综必然会使来自 FEP 的结合自由能无效，因此所报告的值在根本上是无意义的。\n\nF. 在单一步骤中关闭 Lennard-Jones 相互作用而不使用软核势，当原子重叠时可能导致端点奇异性和巨大的力尖峰，从而导致数值不稳定性和严重偏差。\n\nG. PME 静电学不适用于炼金术转换，因此会使任何此类结合自由能计算变得不可靠。\n\nH. 仅仅依赖正向指数估计器，而没有进行反向计算或使用 Bennett 接受率（BAR）或跨多个中间态的多态 BAR（MBAR），会带来巨大的偏差风险，并且缺乏可靠的不确定度量化。",
            "solution": "问题陈述描述了一个计算实验，旨在确定配体与蛋白质的绝对结合自由能。该问题是对计算化学中自由能计算理论和实践知识的有效检验。所描述的方法学充满了严重的错误，任务是识别所提供的评论中哪些在科学上是合理的。我现在将逐一评估每个评论。\n\n计算的核心是 Zwanzig 公式，或称自由能微扰（FEP）：\n$$\n\\Delta G_{0\\to 1} \\;=\\; -k_{\\mathrm{B}}T \\,\\ln \\left\\langle \\exp\\!\\left[-\\beta\\big(U_{1}-U_{0}\\big)\\right]\\right\\rangle_{0}\n$$\n其中，态 $0$ 是完全相互作用的蛋白质-配体复合物，态 $1$ 是配体的非键相互作用被炼金术方法“关闭”的体系。\n\nA. 对于一个大的、柔性的配体，执行从完全相互作用态到完全不相互作用态的单步 FEP 可能会遭遇相空间重叠差的问题，这使得在没有中间态的情况下，指数平均 $-k_{\\mathrm{B}}T\\ln\\langle e^{-\\beta\\Delta U}\\rangle$ 变得不稳定且有偏。\n这个评论是**正确**的。FEP 公式的有效性取决于参考态（态 $0$）的系综与目标态（态 $1$）的相空间有足够的重叠。当两个态差异很大时，例如湮灭一个大配体的所有非键相互作用，对于几乎所有从态 $0$ 采样的构象，势能差 $\\Delta U = U_1 - U_0$ 将会是很大的正值。指数平均 $\\langle e^{-\\beta\\Delta U} \\rangle_{0}$ 将由 $\\Delta U$ 较小的极其罕见的构象所主导。一个 $5\\ \\mathrm{ns}$ 的有限模拟极不可能充分采样到这些关键构象。这会导致系统性的欠采样问题，从而在计算出的 $\\Delta G$ 中产生巨大的统计误差（方差）和显著的系统误差（偏差）。标准且必要的过程是将转换分解为多个更小的步骤（例如，使用由耦合参数 $\\lambda$ 定义的中间态），以确保相邻步骤之间有足够的相空间重叠。\n\nB. 忽略对结合位点中配体的限制以及相关的标准态校正，会使绝对结合自由能产生偏差，因为解偶联的配体可以自由平移和旋转；必须包含限制自由能和 $\\Delta G^{\\circ}$ 校正。\n这个评论是**正确**的。“绝对”结合自由能的目标是得到标准的结合自由能 $\\Delta G^{\\circ}$。该值与标准条件下（例如 $1\\ \\mathrm{M}$ 浓度）的平衡常数 $K_d$ 或 $K_a$ 相关。原始的炼金术计算得到的是将配体从其结合态转移到一个仍被限制在蛋白质结合位点内的不相互作用状态的自由能。要将其与 $\\Delta G^{\\circ}$ 联系起来，需要一个严谨的方案。这包括对配体施加位置和取向限制，计算在这些限制下的自由能变化，然后解析地计算并加上将这些限制释放到标准态体积（$V^\\circ$，对应于 $1\\ \\mathrm{M}$）所需的自由能。通过忽略限制，配体的最终状态没有被明确定义（它在口袋内的一个未知体积中采样），而通过忽略标准态校正，得到的数值无法有意义地转换或与实验解离常数进行比较。\n\nC. 在有限周期性盒子中使用 PME 方法时，净电荷改变 $+1e$ 会因均匀中和背景和镜像相互作用而引入有限尺寸效应；需要进行净电荷校正，忽略它会使 $\\Delta G$ 产生偏差。\n这个评论是**正确**的。在周期性体系中计算静电相互作用的 Particle Mesh Ewald (PME) 方法假设整个模拟单元是电中性的。如果体系带有净电荷，PME 会隐式地添加一个均匀的背景电荷（中和等离子体）以维持电中性。由于电荷与其自身的周期性镜像以及这个背景的相互作用，这会引入一个与体系大小相关的人为能量项。当炼金术转换改变了体系的净电荷时，如此处所述（$+1e$），这种人为效应不会抵消。它会在计算出的自由能差中引入一个显著的误差。存在已被广泛认可的校正方案来估计和移除这种有限尺寸效应。对于改变电荷的转换忽略这样的校正是严重的方法学错误。\n\nD. 仅计算复合物“分支”（配体在蛋白质结合位点中的解偶联）不足以得到绝对结合自由能；一个热力学循环需要将复合物分支与溶剂分支（配体在水中的解偶联）以及限制和标准态项结合起来。\n这个评论是**正确**的。绝对结合自由能 $\\Delta G_{bind}^\\circ$ 对应于将配体从体相溶剂转移到蛋白质结合位点的过程。这个过程不是直接模拟的。相反，需要构建一个热力学循环：\n$$\n\\begin{array}{ccc} \\text{复合物(aq)}  \\xrightarrow{\\Delta G_{\\text{bind}}^\\circ}  \\text{蛋白质(aq) + 配体(aq)} \\\\ \\downarrow \\Delta G_{\\text{complex}}   \\downarrow \\Delta G_{\\text{solvent}} \\\\ \\text{蛋白质(aq) + \"虚拟\"配体(在位点中)}  \\xrightarrow{\\approx 0}  \\text{蛋白质(aq) + \"虚拟\"配体(在溶剂中)} \\end{array}\n$$\n根据这个循环，$\\Delta G_{\\text{bind}}^\\circ = \\Delta G_{\\text{solvent}} - \\Delta G_{\\text{complex}}$。问题陈述中描述的计算只计算了这个循环的一部分，即“复合物分支” ($\\Delta G_{\\text{complex}}$)。如果不计算“溶剂分支” ($\\Delta G_{\\text{solvent}}$)，即同一个配体在体相水中解偶联的自由能，就不可能确定结合自由能。将复合物分支的数值单独报告为绝对结合自由能是对该方法的根本性误解。\n\nE. 使用正则（NVT）系综而非等温等压（NPT）系综必然会使来自 FEP 的结合自由能无效，因此所报告的值在根本上是无意义的。\n这个评论是**不正确**的。FEP 计算可以在多种统计系综中进行。在 NVT 系综中，结果是 Helmholtz 自由能差 $\\Delta A$。在 NPT 系综中，结果是 Gibbs 自由能差 $\\Delta G$。两者通过 $\\Delta G = \\Delta A + P\\Delta V$ 相关。对于凝聚相生物分子体系，配体结合或解偶联时的体积变化 $\\Delta V$ 通常非常小，使得 $P\\Delta V$ 项与其他误差来源相比可以忽略不计。虽然 NPT 系综在理论上更适合与通常在恒定压力下进行的实验进行比较，但使用 NVT 系综是一种常见且通常合理的近似。声称它“必然使”结果无效是一种夸张的说法。所描述的其他错误（A, B, C, D, F, H）要严重得多。\n\nF. 在单一步骤中关闭 Lennard-Jones 相互作用而不使用软核势，当原子重叠时可能导致端点奇异性和巨大的力尖峰，从而导致数值不稳定性和严重偏差。\n这个评论是**正确**的。Lennard-Jones 势有一个强排斥性的 $r^{-12}$ 项，当原子间距 $r \\to 0$ 时会发散。当通过炼金术方法湮灭一个粒子时，其相互作用被关闭。在反向过程（创建）中，人们会从一个粒子是无相互作用的“虚拟”原子的状态进行采样。这个虚拟原子可能漂移到一个位置，与环境中的原子发生空间位阻碰撞。为这样的构象评估完全相互作用的势将产生近乎无穷大的能量和力，这个问题被称为“端点奇异性”。软核势是一种标准技术，通过在短程修改势函数来防止这种发散，并使自由能计算稳定和收敛。试图在没有软核势的情况下单步关闭 LJ 相互作用是极具问题的，可能导致模拟崩溃，或者充其量因为这些高能事件而得到一个无可救药的有偏结果。\n\nG. PME 静电学不适用于炼金术转换，因此会使任何此类结合自由能计算变得不可靠。\n这个评论是**不正确**的。这是一个错误且过于宽泛的概括。PME 是在周期性模拟中处理长程静电相互作用的标准、最先进的方法，包括用于炼金术自由能计算的模拟。尽管它有已知的、必须正确处理的人为误差（如评论 C 中所述），但该方法本身并非“不合适”。文献中绝大多数可靠的 FEP 研究都使用了 PME。\n\nH. 仅仅依赖正向指数估计器，而没有进行反向计算或使用 Bennett 接受率（BAR）或跨多个中间态的多态 BAR（MBAR），会带来巨大的偏差风险，并且缺乏可靠的不确定度量化。\n这个评论是**正确**的。正向 FEP 估计器（Zwanzig 公式）已知是有偏的，尤其是在相空间重叠差的情况下。它收敛非常缓慢，并且没有提供对其自身有效性的内部检验。现代自由能计算的最佳实践要求使用统计上更稳健的估计器。Bennett 接受率（BAR）方法结合了正向（$0 \\to 1$）和反向（$1 \\to 0$）模拟的数据，为给定的模拟时间提供了一个偏差最小、方差最小的自由能估计。正向和反向估计之间的差异也可以作为一种有用但并不完美的收敛性诊断工具。仅仅依赖单向的 Zwanzig 公式是不好的做法，很可能产生有偏的结果，并且无法提供可靠的方法来评估计算的统计不确定度或系统误差。",
            "answer": "$$\\boxed{ABCDF H}$$"
        },
        {
            "introduction": "为了精确计算复杂系统中的自由能变化，通常需要引入多个中间态以确保充分的相空间重叠。多态贝内特接受率（MBAR）方法是当前从所有这些状态的模拟数据中提取自由能的最优方法。这项综合性练习  要求你从理论推导到编码实现，完整地构建MBAR求解器，这代表了从理论学习到掌握现代自由能计算前沿技术的飞跃。",
            "id": "3847551",
            "problem": "给定从多个热力学状态中抽取的样本集合，这些状态由 $k \\in \\{0,1,\\ldots,K-1\\}$ 索引，每个状态由一个折合势 $u_k(\\mathbf{x})$ 表征。折合势的定义为 $u_k(\\mathbf{x}) = \\beta U_k(\\mathbf{x}) + \\text{在恒定热力学参数下的项}$，其中 $U_k(\\mathbf{x})$ 是势能。在下文中，您可以取 $\\beta = 1$（无量纲温度），并将所有折合势视为无量纲的。目标是使用称为多态贝内特接受率（Multi-state Bennett Acceptance Ratio, MBAR）的多态最大似然方法，从跨多个状态合并的数据中估计无量纲自由能 $f_k$（至多相差一个加性常数）。您必须推导、实现并应用相关的自洽方程和数值稳定的迭代方案，以计算自由能及其不确定度。\n\n从平衡统计力学和重要性采样的基本原理出发，仅使用以下核心事实：\n- 配分函数为 $Z_k = \\int d\\mathbf{x}\\, e^{-u_k(\\mathbf{x})}$，无量纲自由能为 $f_k = -\\ln Z_k$（至多相差一个加性常数）。\n- 样本是从对应于状态 $k$ 的 $K$ 个平衡分布的混合中抽取的，每个状态的样本数 $N_k$ 和总样本数 $N = \\sum_{k=0}^{K-1} N_k$ 已知。\n- 已知采样比例的混合模型的重要性采样恒等式和最大似然估计会产生用于参数的自洽估计方程，这些参数能使观测到的合并数据的似然最大化。\n- 最大似然估计量的渐近协方差由观测到的费雪信息（Fisher information）（对数似然函数的负海森矩阵）的逆给出，并通过投影移除由 $f_k$ 的加性规范不变性引起的任何不可辨识性。\n\n您的任务是：\n- 推导 MBAR 自洽方程，这些方程根据所有状态 $k$ 和合并样本 $\\{\\mathbf{x}_n\\}_{n=1}^N$ 的折合势 $u_k(\\mathbf{x}_n)$ 以及已知的样本数 $N_k$ 来确定 $K$ 个未知的自由能 $f_k$（定义至多相差一个加性常数）。\n- 提出一个数值稳定的不动点迭代方案来求解这些方程。您的方案必须明确使用 log-sum-exp 技巧以确保数值稳定性，通过固定 $f_0 = 0$ 来强制执行参考规范，并包含一个基于 $f_k$ 的最大绝对变化小于用户指定容差的收敛准则。\n- 推导估计的 $f_k$ 的观测费雪信息（以解所蕴含的状态责任权重表示），解释如何通过将信息矩阵约化到满秩子空间（例如，通过固定 $f_0 = 0$）来处理加性常数的不可辨识性，并获得自由能差 $\\Delta f_{k0} = f_k - f_0$ 的渐近标准误差。\n\n然后, 实现一个完整的程序，该程序：\n- 使用一维谐振子折合势（$\\beta = 1$）构建合成测试数据。对于每个状态 $k$，定义一个谐振子折合势 $u_k(x) = \\tfrac{1}{2}\\,k_{\\text{spring}}\\,(x - \\mu_k)^2$，并从相应的平衡分布 $p_k(x) \\propto \\exp\\!\\left[-u_k(x)\\right]$ 中抽取 $N_k$ 个独立样本 $x$，对于谐振子而言，这是一个均值为 $\\mu_k$、方差为 $1/k_{\\text{spring}}$ 的正态分布。\n- 从合并的样本集 $\\{x_n\\}_{n=1}^N$ 中，为所有 $k \\in \\{0,\\ldots,K-1\\}$ 和 $n \\in \\{1,\\ldots,N\\}$ 构建完整的折合势矩阵 $[u_k(x_n)]$。\n- 通过您提出的迭代方案求解 $f_k$ 的 MBAR 自洽方程，通过设置 $f_0 = 0$ 来固定参考，计算 $k \\in \\{1,\\ldots,K-1\\}$ 的 $\\Delta f_{k0}$，并通过约化到可辨识子空间的观测费雪信息计算它们的渐近标准误差。\n\n科学真实性要求：\n- 假设所有样本均有效不相关，因此有效样本量因子为一。所有量均为无量纲；不需要物理单位。\n- 使用对近简并态具有鲁棒性的数值稳定实现。\n\n测试套件：\n您的程序必须运行以下三种情况，每种情况由状态数 $K$、每个状态的样本数 $\\{N_k\\}$、谐振子均值 $\\{\\mu_k\\}$、公共弹簧常数 $k_{\\text{spring}}$ 和一个随机种子指定。对于每种情况，为每个状态 $k$ 从 $\\mathcal{N}(\\mu_k, 1/k_{\\text{spring}})$ 中独立抽取恰好 $N_k$ 个样本，然后在各状态间合并样本。必须按照指定的方式为随机数生成器设定种子，以确保确定性。\n- 情况 1：$K = 2$, $\\{\\mu_k\\} = [-1.0, 1.0]$, $k_{\\text{spring}} = 5.0$, $\\{N_k\\} = [80, 80]$, 种子 $= 246810$。\n- 情况 2：$K = 3$, $\\{\\mu_k\\} = [-1.0, 0.0, 1.5]$, $k_{\\text{spring}} = 4.0$, $\\{N_k\\} = [100, 10, 5]$, 种子 $= 13579$。\n- 情况 3：$K = 2$, $\\{\\mu_k\\} = [0.0, 0.2]$, $k_{\\text{spring}} = 10.0$, $\\{N_k\\} = [50, 50]$, 种子 $= 424242$。\n\n答案规格：\n- 对于每种情况，计算自由能差 $\\Delta f_{k0}$（对于 $k \\in \\{1,\\ldots,K-1\\}$）及其从约化后的观测费雪信息矩阵得到的渐近标准误差 $s_{k0}$。所有输出均为无量纲浮点数。\n- 最终输出格式：您的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果。对于上述顺序中的每种情况，将序列 $\\left[\\Delta f_{10}, s_{10}, \\Delta f_{20}, s_{20}, \\ldots, \\Delta f_{(K-1)0}, s_{(K-1)0}\\right]$ 追加到一个扁平化的列表中。每个浮点数在打印前必须四舍五入到恰好 $6$ 位小数。例如，一个有效的输出可能看起来像 $[\\ldots]$，其中所有条目都有 $6$ 位小数。",
            "solution": "### 1. MBAR 自洽方程的推导\n\n我们从统计力学的基础开始。一个热力学状态 $k$ 的配分函数由 $Z_k = \\int e^{-u_k(\\mathbf{x})} d\\mathbf{x}$ 给出，其中 $u_k(\\mathbf{x})$ 是系统在构型 $\\mathbf{x}$ 下的折合势能。无量纲自由能为 $f_k = -\\ln Z_k$，其定义相差一个取决于参考体积选择的加性常数。\n\n我们给定一个包含 $N$ 个构型的集合 $\\{\\mathbf{x}_n\\}_{n=1}^N$，这些构型是从 $K$ 个不同的热力学状态中抽取的。对于每个状态 $k \\in \\{0, \\ldots, K-1\\}$，我们有 $N_k$ 个样本，使得总样本数为 $N = \\sum_{k=0}^{K-1} N_k$。\n\nMBAR 方程提供了自由能的最小方差无偏估计。它们可以从多个角度推导，包括最大似然估计。一个直接的推导遵循最优重要性采样的原理。任何状态 $i$ 的配分函数 $Z_i$ 可以写成一个积分：\n$$\nZ_i = \\int e^{-u_i(\\mathbf{x})} d\\mathbf{x}\n$$\n我们可以通过对合并的样本 $\\{\\mathbf{x}_n\\}$ 进行重新加权来估计这个积分。所有状态样本的最优组合导出了以下 $Z_i$ 的自洽估计量：\n$$\n\\hat{Z}_i = \\sum_{n=1}^{N} \\frac{e^{-u_i(\\mathbf{x}_n)}}{\\sum_{j=0}^{K-1} N_j \\hat{Z}_j^{-1} e^{-u_j(\\mathbf{x}_n)}}\n$$\n该方程表明，配分函数 $\\hat{Z}_i$ 的估计是所有 $N$ 个样本的平均值。每个样本 $\\mathbf{x}_n$ 从其原生的“混合”系综被重新加权到目标系综 $i$。权重分母 $\\sum_j N_j \\hat{Z}_j^{-1} e^{-u_j(\\mathbf{x}_n)}$ 代表在所有 $K$ 个系综的混合中观察到构型 $\\mathbf{x}_n$ 的未归一化概率密度。\n\n为了获得自由能 $f_k = -\\ln Z_k$ 的方程，我们将 $\\hat{Z}_k = e^{-\\hat{f}_k}$ 代入上述方程：\n$$\ne^{-\\hat{f}_i} = \\sum_{n=1}^{N} \\frac{e^{-u_i(\\mathbf{x}_n)}}{\\sum_{j=0}^{K-1} N_j e^{\\hat{f}_j} e^{-u_j(\\mathbf{x}_n)}}\n$$\n整理后得到 MBAR 自洽方程的最终形式：\n$$\n\\hat{f}_i = -\\ln \\left( \\sum_{n=1}^{N} \\frac{e^{-u_i(\\mathbf{x}_n)}}{\\sum_{j=0}^{K-1} N_j e^{\\hat{f}_j - u_j(\\mathbf{x}_n)}} \\right)\n$$\n这 $K$ 个耦合的非线性方程必须求解，以得到 $K$ 个自由能 $\\hat{f}_0, \\ldots, \\hat{f}_{K-1}$。这些自由能仅能确定至相差一个任意的加性常数，因为将所有 $\\hat{f}_j$ 平移一个常数 $c$ 并不会改变方程。我们通过将一个自由能固定为参考值（通常为 $\\hat{f}_0 = 0$）来解决这个问题。\n\n### 2. 数值稳定的不动点迭代方案\n\n自洽方程可以使用不动点迭代来求解：\n$$\nf_i^{\\text{new}} = -\\ln \\left( \\sum_{n=1}^{N} \\frac{e^{-u_i(\\mathbf{x}_n)}}{\\sum_{j=0}^{K-1} N_j e^{f_j^{\\text{old}} - u_j(\\mathbf{x}_n)}} \\right)\n$$\n直接以这种形式计算指数在数值上是不稳定的，存在浮点数上溢或下溢的风险。我们可以使用 log-sum-exp (LSE) 技巧构建一个稳定的方案，其中 $\\text{LSE}(\\mathbf{v}) = \\ln(\\sum_i e^{v_i})$。$f_i$ 的迭代更新可以重写为：\n$$\nf_i^{\\text{new}} = -\\ln \\left( \\sum_{n=1}^{N} \\exp\\left[ -u_i(\\mathbf{x}_n) - \\ln\\left(\\sum_{j=0}^{K-1} \\exp\\left[ \\ln N_j + f_j^{\\text{old}} - u_j(\\mathbf{x}_n) \\right]\\right) \\right] \\right)\n$$\n这个表达式是 LSE 的嵌套应用。我们定义 LSE 函数的参数：\n- 对于内部 LSE（对每个样本 $n$ 遍历状态 $j$）：$A_{jn} = \\ln N_j + f_j^{\\text{old}} - u_j(\\mathbf{x}_n)$。\n- 内部 LSE 的结果是每个样本的对数分母：$L_n = \\text{LSE}_j(A_{jn}) = \\ln(\\sum_j e^{A_{jn}})$。\n- 对于外部 LSE（对每个状态 $i$ 遍历样本 $n$）：$B_{in} = -u_i(\\mathbf{x}_n) - L_n$。\n- 未经平移的更新后自由能则为 $f'_i = -\\text{LSE}_n(B_{in}) = -\\ln(\\sum_n e^{B_{in}})$。\n\n计算出未平移的值 $f'_i$ 后，我们通过平移所有自由能来强制执行规范条件 $f_0=0$：\n$$\nf_i^{\\text{new}} = f'_i - f'_0 \\quad \\text{对于 } i \\in \\{0, \\ldots, K-1\\}\n$$\n这确保了 $f_0^{\\text{new}} = 0$。迭代从一个初始猜测（例如，对所有 $i$，$f_i=0$）开始，并重复更新，直到连续两次迭代中任何自由能值的最大绝对变化小于指定的容差 $\\epsilon$：\n$$\n\\max_{i} |f_i^{\\text{new}} - f_i^{\\text{old}}|  \\epsilon\n$$\n\n### 3. 渐近误差估计\n\n估计的自由能 $\\hat{\\mathbf{f}}$ 的渐近协方差矩阵由观测到的费雪信息矩阵 $\\mathbf{I}$ 的逆给出。费雪信息是在最大似然估计处求值的对数似然函数的负海森矩阵。相关的对数似然函数（在相差一个加性常数的情况下）是：\n$$\n\\ln \\mathcal{L}(\\mathbf{f}) = \\sum_{k=0}^{K-1} N_k f_k - \\sum_{n=1}^{N} \\ln\\left( \\sum_{j=0}^{K-1} N_j e^{f_j - u_j(\\mathbf{x}_n)} \\right)\n$$\n关于 $f_i$ 的一阶导数为：\n$$\n\\frac{\\partial \\ln \\mathcal{L}}{\\partial f_i} = N_i - \\sum_{n=1}^{N} \\frac{N_i e^{f_i - u_i(\\mathbf{x}_n)}}{\\sum_{j=0}^{K-1} N_j e^{f_j - u_j(\\mathbf{x}_n)}} = N_i - \\sum_{n=1}^{N} W_{in}\n$$\n其中 $W_{in}$ 是样本 $n$（从任何状态抽取）在热力学上属于状态 $i$ 的概率：\n$$\nW_{in} = \\frac{N_i e^{f_i - u_i(\\mathbf{x}_n)}}{\\sum_{j=0}^{K-1} N_j e^{f_j - u_j(\\mathbf{x}_n)}}\n$$\n注意，对于任何样本 $n$，$\\sum_{i=0}^{K-1} W_{in} = 1$。在最大似然解处，$\\frac{\\partial \\ln \\mathcal{L}}{\\partial f_i} = 0$，这意味着 $N_i = \\sum_{n=1}^N W_{in}$。\n\n海森矩阵元素 $H_{ij} = \\frac{\\partial^2 \\ln \\mathcal{L}}{\\partial f_i \\partial f_j}$ 为：\n$$\nH_{ij} = -\\sum_{n=1}^{N} \\frac{\\partial W_{in}}{\\partial f_j} = -\\sum_{n=1}^{N} (W_{in}\\delta_{ij} - W_{in}W_{jn})\n$$\n其中 $\\delta_{ij}$ 是克罗内克 delta。观测到的费雪信息矩阵是 $\\mathbf{I} = -\\mathbf{H}$：\n$$\nI_{ij} = \\sum_{n=1}^{N} (W_{in}\\delta_{ij} - W_{in}W_{jn})\n$$\n这个 $K \\times K$ 矩阵是奇异的，反映了绝对自由能的不可辨识性。向量 $(1, 1, \\ldots, 1)^T$ 是一个零特征向量，因为 $\\sum_j I_{ij} = 0$。\n\n为了获得一个非奇异矩阵，我们在相对于状态 0 的自由能差的约化空间中工作，即对 $k \\in \\{1, \\ldots, K-1\\}$，$\\Delta f_{k0} = f_k - f_0$。这等价于设置 $f_0=0$ 并估计剩余的 $K-1$ 个自由能。这 $K-1$ 个参数的费雪信息矩阵是通过移除与状态 0 对应的行和列从 $\\mathbf{I}$ 得到的 $(K-1) \\times (K-1)$ 子矩阵：\n$$\n\\mathbf{I}_{\\text{red}} = (I_{ij})_{i,j \\in \\{1,\\ldots,K-1\\}}\n$$\n这个约化矩阵是可逆的。自由能差 $(\\Delta f_{10}, \\ldots, \\Delta f_{(K-1)0})$ 的协方差矩阵由其逆给出：\n$$\n\\mathbf{C} = \\mathbf{I}_{\\text{red}}^{-1}\n$$\n$\\Delta f_{k0}$ 估计的渐近标准误差是 $\\mathbf{C}$ 相应对角元素的平方根：\n$$\ns_{k0} = \\sqrt{C_{k-1, k-1}} \\quad \\text{对于 } k \\in \\{1, \\ldots, K-1\\}\n$$\n（对矩阵 $\\mathbf{C}$ 使用 0-based 索引）。",
            "answer": "```python\nimport numpy as np\nfrom scipy.special import logsumexp\n\ndef solve_mbar(u_kn, N_k, tol=1e-12, max_iter=10000):\n    \"\"\"\n    Solves the MBAR self-consistent equations for the free energies.\n\n    Args:\n        u_kn (np.ndarray): A KxN matrix of reduced potentials u_k(x_n).\n        N_k (np.ndarray): A K-element array of sample counts per state.\n        tol (float): The convergence tolerance.\n        max_iter (int): The maximum number of iterations.\n\n    Returns:\n        tuple: A tuple containing:\n            - f_k (np.ndarray): K-element array of estimated dimensionless free energies with f_0 = 0.\n            - df_k (np.ndarray): (K-1)-element array of standard errors for f_k - f_0.\n    \"\"\"\n    K, N = u_kn.shape\n    f_k = np.zeros(K, dtype=np.float64)\n    log_N_k = np.log(N_k)\n\n    for i in range(max_iter):\n        f_k_old = np.copy(f_k)\n\n        # Numerically stable calculation of new free energies\n        # A_kn = log(N_k) + f_k - u_kn\n        A_kn = log_N_k[:, np.newaxis] + f_k[:, np.newaxis] - u_kn\n        \n        # log_D_n = log(sum_k exp(A_kn))\n        log_D_n = logsumexp(A_kn, axis=0)\n        \n        # log [ exp(-u_kn) / D_n ] = -u_kn - log_D_n\n        log_term = -u_kn - log_D_n[np.newaxis, :]\n        \n        # f'_k = -log(sum_n exp(log_term))\n        f_k_new_unshifted = -logsumexp(log_term, axis=1)\n        \n        # Enforce gauge f_0 = 0\n        f_k = f_k_new_unshifted - f_k_new_unshifted[0]\n\n        if np.max(np.abs(f_k - f_k_old))  tol:\n            break\n    else:\n        raise RuntimeError(\"MBAR did not converge in {} iterations.\".format(max_iter))\n\n    # Calculate uncertainties\n    # A_kn = log(N_k) + f_k - u_kn for converged f_k\n    A_kn = log_N_k[:, np.newaxis] + f_k[:, np.newaxis] - u_kn\n    log_D_n = logsumexp(A_kn, axis=0)\n    \n    # W_kn = exp(A_kn) / D_n = exp(A_kn - log_D_n)\n    log_W_kn = A_kn - log_D_n[np.newaxis, :]\n    W_kn = np.exp(log_W_kn)\n\n    # Fisher information matrix I_ij = sum_n (W_in * delta_ij - W_in * W_jn)\n    # This can be written as I = diag(sum(W, axis=1)) - W @ W.T\n    I = np.diag(np.sum(W_kn, axis=1)) - W_kn @ W_kn.T\n\n    # Invert the reduced (K-1)x(K-1) Fisher information matrix\n    # for states 1..K-1 to get the covariance of (f_1-f_0, ..., f_{K-1}-f_0)\n    I_red = I[1:, 1:]\n    try:\n        C_red = np.linalg.inv(I_red)\n        df_k = np.sqrt(np.diag(C_red))\n    except np.linalg.LinAlgError:\n        # This can happen if states are not well-connected,\n        # but shouldn't for the given test cases.\n        df_k = np.full(K - 1, np.nan)\n\n    return f_k[1:], df_k\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n    test_cases = [\n        {'K': 2, 'mu_k': [-1.0, 1.0], 'k_spring': 5.0, 'N_k': [80, 80], 'seed': 246810},\n        {'K': 3, 'mu_k': [-1.0, 0.0, 1.5], 'k_spring': 4.0, 'N_k': [100, 10, 5], 'seed': 13579},\n        {'K': 2, 'mu_k': [0.0, 0.2], 'k_spring': 10.0, 'N_k': [50, 50], 'seed': 424242},\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        K = case['K']\n        mu_k = np.array(case['mu_k'])\n        k_spring = case['k_spring']\n        N_k = np.array(case['N_k'])\n        seed = case['seed']\n        \n        rng = np.random.default_rng(seed)\n\n        # 1. Generate synthetic data\n        samples_per_state = []\n        for k in range(K):\n            # Samples drawn from N(mu_k, sigma^2 = 1/k_spring)\n            std_dev = np.sqrt(1.0 / k_spring)\n            samples = rng.normal(loc=mu_k[k], scale=std_dev, size=N_k[k])\n            samples_per_state.append(samples)\n        \n        # Pool all samples\n        x_n = np.concatenate(samples_per_state)\n        N = x_n.shape[0]\n\n        # 2. Construct reduced potential matrix u_kn\n        # u_k(x_n) = 0.5 * k_spring * (x_n - mu_k)^2\n        u_kn = 0.5 * k_spring * (x_n[np.newaxis, :] - mu_k[:, np.newaxis])**2\n\n        # 3. Solve MBAR equations\n        f_k_diff, df_k_err = solve_mbar(u_kn, N_k)\n\n        # 4. Collect results for this case\n        case_results = []\n        for f, df in zip(f_k_diff, df_k_err):\n            case_results.extend([f, df])\n        all_results.extend(case_results)\n\n    # Format and print the final output\n    formatted_results = [f\"{x:.6f}\" for x in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}