{"hands_on_practices": [{"introduction": "任何分子动力学(MD)模拟的核心都是其数值积分器，而时间步长 $ \\Delta t $ 的选择对模拟的稳定性和准确性至关重要。本实践将引导你探索广泛使用的速度Verlet算法的线性稳定性。通过分析一个代表材料中最高频率振动模式的简谐振子，你将推导出时间步长的绝对上限，这是设置任何稳定MD模拟所需的一项基本技能。[@problem_id:2469790]", "problem": "在原子级分子动力学 (MD) 中，速度 Verlet 积分器被广泛用于积分牛顿运动方程。考虑一个代表晶体固体单个简正模式的一维谐振子，其势能为 $U(x)=\\tfrac{1}{2}k x^{2}$，质量为 $m$。其运动方程为 $m\\,\\ddot{x}(t)=-k\\,x(t)$，可写为 $\\ddot{x}(t)=-\\omega^{2}x(t)$，其中 $\\omega=\\sqrt{k/m}$。标准的速度 Verlet 更新在一个时间步长 $\\Delta t$ 内通过以下步骤推进位置和速度：首先，使用当前加速度进行半步速度更新；然后，使用半步速度进行全步位置更新；接着，根据更新后的位置完全计算加速度；最后，使用新的加速度进行第二个半步速度更新。\n\n从牛顿第二定律和速度 Verlet 更新的定义出发，将离散时间更新写成线性形式 $\\begin{pmatrix}x_{n+1}\\\\ v_{n+1}\\end{pmatrix}=M(\\Delta t)\\begin{pmatrix}x_{n}\\\\ v_{n}\\end{pmatrix}$，其中 $M(\\Delta t)$ 是一个依赖于 $\\omega$ 和 $\\Delta t$ 的 $2\\times 2$ 矩阵。通过要求 $M(\\Delta t)$ 的所有特征值的模长小于或等于 1，来进行线性稳定性分析。确定对于此谐振子，速度 Verlet 算法保持线性稳定的最大时间步长 $\\Delta t_{\\text{max}}$。将最终答案表示为关于 $\\omega$ 的单个闭合形式解析表达式，并以秒为单位。不需要进行数值计算或四舍五入。", "solution": "提交问题陈述以进行验证。\n\n**步骤1：提取已知条件**\n- 系统：一维谐振子。\n- 势能：$U(x)=\\tfrac{1}{2}k x^{2}$。\n- 质量：$m$。\n- 运动方程：$m\\,\\ddot{x}(t)=-k\\,x(t)$，或 $\\ddot{x}(t)=-\\omega^{2}x(t)$，其中 $\\omega=\\sqrt{k/m}$。\n- 算法：速度 Verlet 积分器。\n- 速度 Verlet 更新步骤：\n    1. 使用当前加速度进行半步速度更新。\n    2. 使用半步速度进行全步位置更新。\n    3. 根据更新后的位置完全计算加速度。\n    4. 使用新的加速度进行第二个半步速度更新。\n- 任务：推导离散时间更新矩阵 $M(\\Delta t)$，形式为 $\\begin{pmatrix}x_{n+1}\\\\ v_{n+1}\\end{pmatrix}=M(\\Delta t)\\begin{pmatrix}x_{n}\\\\ v_{n}\\end{pmatrix}$。\n- 任务：通过要求 $M(\\Delta t)$ 的所有特征值的模长小于或等于 1，进行线性稳定性分析。\n- 任务：确定积分保持稳定的最大时间步长 $\\Delta t_{\\text{max}}$，用 $\\omega$ 表示。\n\n**步骤2：使用提取的已知条件进行验证**\n对问题的有效性进行严格审查。\n- **科学基础**：该问题在科学上是合理的。它探讨了速度 Verlet 算法的稳定性，这是分子动力学模拟的基石，并将其应用于谐振子这一物理学中的基本模型。这些概念在计算物理学和材料化学中都是标准内容。\n- **适定性**：该问题是适定的。它提供了所有必要的信息：物理系统、运动方程、具体的数值积分方案，以及一个清晰、数学上精确的稳定性判据。这些任务导向一个唯一、可推导的结果。\n- **客观性**：该问题以客观、正式的语言陈述，没有歧义或主观看法。\n\n该问题不具有任何列出的缺陷。它不是科学上不合理、不可形式化、不完整、不切实际、不适定、微不足道或无法验证的。\n\n**步骤3：结论与行动**\n问题被判定为**有效**。将构建一个解答。\n\n速度 Verlet 算法将运动方程离散化。设 $x_n = x(t_n)$，$v_n = v(t_n)$ 和 $a_n = a(t_n)$ 分别是时间步 $n$ 时的位置、速度和加速度。对于谐振子，加速度为 $a(t) = -\\omega^2 x(t)$。从时间 $t_n$ 到 $t_{n+1} = t_n + \\Delta t$ 的更新步骤如下。\n\n首先，将速度更新半个时间步：\n$$v_{n+1/2} = v_n + a_n \\frac{\\Delta t}{2} = v_n - \\omega^2 x_n \\frac{\\Delta t}{2}$$\n\n其次，使用这个中间速度将位置更新一个完整的时间步：\n$$x_{n+1} = x_n + v_{n+1/2} \\Delta t = x_n + \\left(v_n - \\omega^2 x_n \\frac{\\Delta t}{2}\\right) \\Delta t$$\n$$x_{n+1} = \\left(1 - \\frac{\\omega^2 (\\Delta t)^2}{2}\\right) x_n + (\\Delta t) v_n$$\n这提供了更新矩阵 $M(\\Delta t)$ 的第一行。\n\n第三，使用新位置 $x_{n+1}$ 计算新加速度 $a_{n+1}$：\n$$a_{n+1} = -\\omega^2 x_{n+1}$$\n\n第四，使用新加速度通过第二个半步更新计算最终速度 $v_{n+1}$：\n$$v_{n+1} = v_{n+1/2} + a_{n+1} \\frac{\\Delta t}{2} = \\left(v_n - \\omega^2 x_n \\frac{\\Delta t}{2}\\right) - \\omega^2 x_{n+1} \\frac{\\Delta t}{2}$$\n$$v_{n+1} = v_n - \\frac{\\omega^2 \\Delta t}{2} (x_n + x_{n+1})$$\n为了将 $v_{n+1}$ 完全用 $x_n$ 和 $v_n$ 表示，我们代入 $x_{n+1}$ 的表达式：\n$$v_{n+1} = v_n - \\frac{\\omega^2 \\Delta t}{2} \\left(x_n + \\left(1 - \\frac{\\omega^2 (\\Delta t)^2}{2}\\right) x_n + (\\Delta t) v_n \\right)$$\n$$v_{n+1} = v_n - \\frac{\\omega^2 \\Delta t}{2} \\left(\\left(2 - \\frac{\\omega^2 (\\Delta t)^2}{2}\\right) x_n + (\\Delta t) v_n \\right)$$\n$$v_{n+1} = \\left(-\\omega^2 \\Delta t + \\frac{\\omega^4 (\\Delta t)^3}{4}\\right) x_n + \\left(1 - \\frac{\\omega^2 (\\Delta t)^2}{2}\\right) v_n$$\n这可以写成：\n$$v_{n+1} = \\left(-\\omega^2 \\Delta t \\left(1 - \\frac{\\omega^2 (\\Delta t)^2}{4}\\right)\\right) x_n + \\left(1 - \\frac{\\omega^2 (\\Delta t)^2}{2}\\right) v_n$$\n这提供了更新矩阵的第二行。\n\n结合这些结果，线性方程组为：\n$$\\begin{pmatrix} x_{n+1} \\\\ v_{n+1} \\end{pmatrix} = \\begin{pmatrix} 1 - \\frac{\\omega^2 (\\Delta t)^2}{2} & \\Delta t \\\\ -\\omega^2 \\Delta t \\left(1 - \\frac{\\omega^2 (\\Delta t)^2}{4}\\right) & 1 - \\frac{\\omega^2 (\\Delta t)^2}{2} \\end{pmatrix} \\begin{pmatrix} x_n \\\\ v_n \\end{pmatrix}$$\n所以，更新矩阵是：\n$$M(\\Delta t) = \\begin{pmatrix} 1 - \\frac{\\omega^2 (\\Delta t)^2}{2} & \\Delta t \\\\ -\\omega^2 \\Delta t \\left(1 - \\frac{\\omega^2 (\\Delta t)^2}{4}\\right) & 1 - \\frac{\\omega^2 (\\Delta t)^2}{2} \\end{pmatrix}$$\n\n为了进行稳定性分析，我们必须通过求解特征方程 $\\det(M - \\lambda I) = 0$ 来找到 $M(\\Delta t)$ 的特征值 $\\lambda$。需要 $M$ 的迹和行列式。\n$$\\text{Tr}(M) = \\left(1 - \\frac{\\omega^2 (\\Delta t)^2}{2}\\right) + \\left(1 - \\frac{\\omega^2 (\\Delta t)^2}{2}\\right) = 2 - \\omega^2 (\\Delta t)^2$$\n$$\\det(M) = \\left(1 - \\frac{\\omega^2 (\\Delta t)^2}{2}\\right)^2 - (\\Delta t)\\left(-\\omega^2 \\Delta t \\left(1 - \\frac{\\omega^2 (\\Delta t)^2}{4}\\right)\\right)$$\n$$\\det(M) = \\left(1 - \\omega^2 (\\Delta t)^2 + \\frac{\\omega^4 (\\Delta t)^4}{4}\\right) + \\left(\\omega^2 (\\Delta t)^2 - \\frac{\\omega^4 (\\Delta t)^4}{4}\\right) = 1$$\n$\\det(M)=1$ 这一事实是辛积分器的标志，它能正确地为哈密顿系统保持相空间体积。\n\n特征方程为 $\\lambda^2 - \\text{Tr}(M) \\lambda + \\det(M) = 0$：\n$$\\lambda^2 - \\left(2 - \\omega^2 (\\Delta t)^2\\right) \\lambda + 1 = 0$$\n特征值由二次公式给出：\n$$\\lambda = \\frac{(2 - \\omega^2 (\\Delta t)^2) \\pm \\sqrt{(2 - \\omega^2 (\\Delta t)^2)^2 - 4}}{2}$$\n该算法是稳定的，当且仅当两个特征值的模长都小于或等于 1，即 $|\\lambda| \\le 1$。由于它们的乘积 $\\lambda_1 \\lambda_2 = \\det(M) = 1$，如果特征值是实数且不等于 $\\pm 1$，那么其中一个的模长必须大于 1，从而导致不稳定。因此，稳定性要求特征值是在单位圆上的共轭复数。这发生在特征多项式的判别式非正时。\n$$\\text{Discriminant} = (2 - \\omega^2 (\\Delta t)^2)^2 - 4 \\le 0$$\n$$(2 - \\omega^2 (\\Delta t)^2)^2 \\le 4$$\n两边取平方根：\n$$|2 - \\omega^2 (\\Delta t)^2| \\le 2$$\n这个不等式等价于两个线性不等式的合取：\n$$-2 \\le 2 - \\omega^2 (\\Delta t)^2 \\quad \\text{和} \\quad 2 - \\omega^2 (\\Delta t)^2 \\le 2$$\n第一个不等式给出：\n$$-4 \\le -\\omega^2 (\\Delta t)^2$$\n$$\\omega^2 (\\Delta t)^2 \\le 4$$\n由于 $\\omega > 0$ 且 $\\Delta t > 0$，这变为：\n$$\\omega \\Delta t \\le 2$$\n第二个不等式给出：\n$$-\\omega^2 (\\Delta t)^2 \\le 0$$\n$$\\omega^2 (\\Delta t)^2 \\ge 0$$\n这对于实数 $\\omega$ 和 $\\Delta t$ 总是成立的。\n\n因此，线性稳定性的条件是 $\\omega \\Delta t \\le 2$。允许的最大时间步长 $\\Delta t_{\\text{max}}$ 是使该不等式饱和的值。\n$$\\Delta t_{\\text{max}} = \\frac{2}{\\omega}$$\n角频率 $\\omega$ 的单位是弧度每秒，或秒的倒数 ($\\text{s}^{-1}$)。因此，表达式 $\\frac{2}{\\omega}$ 正确地得出一个以秒为单位的结果。", "answer": "$$\\boxed{\\frac{2}{\\omega}}$$", "id": "2469790"}, {"introduction": "在周期性体系中准确计算长程静电相互作用是原子模拟中的一个主要挑战，由于库仑势的缓慢衰减特性，简单的截断方法并不能胜任。本实践将引导你实现Ewald求和方法，这是一种巧妙的技术，它通过将计算分解为快速收敛的实空间和倒易空间两部分求和来解决此问题。通过为经典的氯化钠（NaCl）离子晶体计算马德隆常数，你将获得关于这一核心算法的实践经验，这对于模拟离子材料、生物分子和其他带电体系是必不可少的。[@problem_id:2469742]", "problem": "考虑一个具有岩盐（氯化钠）结构的无限离子晶体，该晶体由边长为 $a = 1$（无量纲单位）的常规立方晶胞周期性重复构成。晶胞包含8个离子，其电荷为 $q_j \\in \\{+1,-1\\}$，位于以下分数坐标处（以 $a$ 为单位）：阴离子 ($q_j = -1$) 位于 $(0,0,0)$、$(0,\\tfrac{1}{2},\\tfrac{1}{2})$、$(\\tfrac{1}{2},0,\\tfrac{1}{2})$、$(\\tfrac{1}{2},\\tfrac{1}{2},0)$；阳离子 ($q_j = +1$) 位于 $(\\tfrac{1}{2},0,0)$、$(0,\\tfrac{1}{2},0)$、$(0,0,\\tfrac{1}{2})$、$(\\tfrac{1}{2},\\tfrac{1}{2},\\tfrac{1}{2})$。在所选的无量纲体系中，位于位置 $\\mathbf{r}$ 和 $\\mathbf{r}'$ 的两个离子之间的静电相互作用由 Coulomb 势 $1/\\lVert \\mathbf{r}-\\mathbf{r}' \\rVert$ 给出，并且该晶体采用周期性边界条件 (PBC) 处理。\n\n您的任务是计算氯化钠的 Madelung 常数，该常数被定义为此晶格的一个无量纲数 $\\mathcal{M}$，通过以下公式与每个常规晶胞的总静电能 $E_{\\mathrm{cell}}$ 相关：\n$$\nE_{\\mathrm{cell}} = -\\frac{8\\,\\mathcal{M}}{r_0},\n$$\n其中 $r_0$ 是以 $a$ 为单位的最近邻距离。对于这个 $a=1$ 的常规立方晶胞中的岩盐结构，最近邻距离为 $r_0 = \\tfrac{1}{2}$，因此：\n$$\n\\mathcal{M} = -\\frac{E_{\\mathrm{cell}}}{16}.\n$$\n\n从 Coulomb 相互作用以及使用宽度为 $\\alpha^{-1}$ 的高斯屏蔽将 $1/r$ 势分解为一个快速收敛的实空间部分和一个快速收敛的倒易空间部分的原理出发，推导并实现用于计算每个常规晶胞静电能的 Ewald 求和方法。采用导电（锡箔）边界条件。使用以下标准构件作为您推导的起点：\n- Coulomb 定律 $1/\\lVert \\mathbf{r} \\rVert$，\n- 周期性边界条件下的叠加，\n- 用于实空间屏蔽的互补误差函数 $\\operatorname{erfc}(x)$，\n- 长程部分在倒易空间中的 Fourier 表示。\n\n在您的实现中，实空间晶格矢量为 $\\mathbf{R} = (n_x, n_y, n_z)$，其中 $n_x,n_y,n_z \\in \\mathbb{Z}$，倒易空间矢量为 $\\mathbf{k} = 2\\pi(m_x,m_y,m_z)$，其中 $m_x,m_y,m_z \\in \\mathbb{Z}$。每个常规晶胞的能量必须作为对基底中所有电荷对以及所有周期性镜像的求和来评估，并适当移除自相互作用。在实空间中使用球形距离截断 $r_{\\mathrm{cut}}$ 和一个最大整数索引 $N_{\\mathrm{real}}$ 以通过 $n_\\alpha \\in \\{-N_{\\mathrm{real}},\\dots,N_{\\mathrm{real}}\\}$ 界定实空间晶格盒，并在倒易空间中使用一个最大整数索引 $N_{\\mathbf{k}}$ 以通过 $m_\\alpha \\in \\{-N_{\\mathbf{k}},\\dots,N_{\\mathbf{k}}\\}$（不包括 $\\mathbf{k}=\\mathbf{0}$）界定。\n\n编写一个程序，对于给定的参数元组 $(\\alpha, N_{\\mathrm{real}}, r_{\\mathrm{cut}}, N_{\\mathbf{k}})$，计算 Ewald 能量 $E_{\\mathrm{cell}}$ 并返回相应的 Madelung 常数 $\\mathcal{M}$。将报告的每个 $\\mathcal{M}$ 四舍五入到8位小数。\n\n测试套件：\n- 案例 1：$(\\alpha, N_{\\mathrm{real}}, r_{\\mathrm{cut}}, N_{\\mathbf{k}}) = (2.0, 4, 4.0, 4)$\n- 案例 2：$(\\alpha, N_{\\mathrm{real}}, r_{\\mathrm{cut}}, N_{\\mathbf{k}}) = (3.5, 5, 5.0, 6)$\n- 案例 3：$(\\alpha, N_{\\mathrm{real}}, r_{\\mathrm{cut}}, N_{\\mathbf{k}}) = (6.0, 3, 3.0, 8)$\n- 案例 4：$(\\alpha, N_{\\mathrm{real}}, r_{\\mathrm{cut}}, N_{\\mathbf{k}}) = (4.0, 8, 8.0, 3)$\n- 案例 5：$(\\alpha, N_{\\mathrm{real}}, r_{\\mathrm{cut}}, N_{\\mathbf{k}}) = (4.5, 10, 10.0, 10)$\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，$[\\text{result}_1,\\text{result}_2,\\dots]$），其中每个 $\\text{result}_i$ 是对应测试案例计算出的 $\\mathcal{M}$，四舍五入到8位小数。不需要物理单位，因为所有量根据构造都是无量纲的。确保所有三角函数参数都被解释为弧度。最终输出必须是浮点数。", "solution": "用户提供了一个来自计算材料化学领域的有效、定义明确的问题陈述。任务是推导并实现 Ewald 求和方法，以在特定的、明确定义的条件下计算无限岩盐晶体结构的 Madelung 常数。该问题具有科学依据、客观，并包含唯一解所需的所有必要信息。因此，我将继续进行推导和实现。\n\n对于一个无限周期性晶格，其晶胞由晶格矢量 $\\mathbf{a}_1, \\mathbf{a}_2, \\mathbf{a}_3$ 定义，内部包含 $N$ 个离子，电荷为 $q_j$，位于分数坐标 $\\mathbf{u}_j$ 处，每个晶胞的静电能 $E_{\\mathrm{cell}}$ 由下式给出：\n$$\nE_{\\mathrm{cell}} = \\frac{1}{2} \\sum_{i=1}^{N} \\sum_{j=1}^{N} \\sum_{\\mathbf{R}}' \\frac{q_i q_j}{|\\mathbf{r}_{ij} + \\mathbf{R}|}\n$$\n其中静电常数 $1/(4\\pi\\epsilon_0)$ 设为 1，$\\mathbf{r}_{ij} = \\mathbf{r}_i - \\mathbf{r}_j = (\\mathbf{u}_i - \\mathbf{u}_j)a$ 是主晶胞中离子间的矢量间隔（此处边长 $a=1$），$\\mathbf{R} = n_1\\mathbf{a}_1 + n_2\\mathbf{a}_2 + n_3\\mathbf{a}_3$ 是实空间晶格矢量，其中 $n_1, n_2, n_3$ 为整数。求和符号上的撇号表示当 $\\mathbf{R}=\\mathbf{0}$ 时，排除 $i=j$ 的项，以避免点电荷的无限自能。这个和是条件收敛的，并且收敛速度极慢。\n\nEwald 求和方法通过使用涉及互补误差函数 $\\operatorname{erfc}(x)$ 和误差函数 $\\operatorname{erf}(x)$ 的恒等式，将 Coulomb 势 $1/r$ 分解为一个短程分量和一个长程分量，从而加速收敛：\n$$\n\\frac{1}{r} = \\frac{\\operatorname{erfc}(\\alpha r)}{r} + \\frac{\\operatorname{erf}(\\alpha r)}{r}\n$$\n参数 $\\alpha$ 控制用于屏蔽的高斯电荷分布的宽度，其值的选择是为了平衡两个结果和的收敛性。静电能 $E_{\\mathrm{cell}}$ 随后表示为三个分量的和：一个实空间和 ($E_{\\mathrm{real}}$)、一个倒易空间和 ($E_{\\mathrm{recip}}$) 和一个自能校正 ($E_{\\mathrm{self}}$)。\n\n$E_{\\mathrm{cell}} = E_{\\mathrm{real}} + E_{\\mathrm{recip}} - E_{\\mathrm{self}}$\n\n**1. 实空间项 ($E_{\\mathrm{real}}$)**\n\n涉及 $\\operatorname{erfc}(\\alpha r)/r$ 的短程部分衰减迅速，允许在合理的较小截断距离 $r_{\\mathrm{cut}}$ 处截断求和。实空间能量为：\n$$\nE_{\\mathrm{real}} = \\frac{1}{2} \\sum_{i=1}^{N} \\sum_{j=1}^{N} \\sum_{\\mathbf{R}}' \\frac{q_i q_j \\operatorname{erfc}(\\alpha |\\mathbf{r}_{ij} + \\mathbf{R}|)}{|\\mathbf{r}_{ij} + \\mathbf{R}|}\n$$\n为了计算方便，通过将不同离子相互作用的项（$i \\neq j$）与周期性镜像的自相互作用项（$i=j, \\mathbf{R} \\neq \\mathbf{0}$）分开，可以更高效地计算：\n$$\nE_{\\mathrm{real}} = \\sum_{i=1}^{N-1} \\sum_{j=i+1}^{N} q_i q_j \\sum_{\\mathbf{R}} \\frac{\\operatorname{erfc}(\\alpha |\\mathbf{r}_{ij} + \\mathbf{R}|)}{|\\mathbf{r}_{ij} + \\mathbf{R}|} + \\frac{1}{2} \\sum_{i=1}^{N} q_i^2 \\sum_{\\mathbf{R} \\neq \\mathbf{0}} \\frac{\\operatorname{erfc}(\\alpha |\\mathbf{R}|)}{|\\mathbf{R}|}\n$$\n对 $\\mathbf{R} = (n_x, n_y, n_z)a$ 的求和是针对整数 $n_\\alpha \\in \\{-N_{\\mathrm{real}}, \\dots, N_{\\mathrm{real}}\\}$ 以及相互作用距离小于 $r_{\\mathrm{cut}}$ 的情况进行的。\n\n**2. 倒易空间项 ($E_{\\mathrm{recip}}$)**\n\n涉及 $\\operatorname{erf}(\\alpha r)/r$ 的长程部分变化平缓，使用 Fourier 变换在倒易空间中进行高效计算。晶胞的电荷分布 $\\rho(\\mathbf{r}) = \\sum_{j=1}^N q_j \\delta(\\mathbf{r}-\\mathbf{r}_j)$ 被展开成 Fourier 级数。倒易空间能量贡献由下式给出：\n$$\nE_{\\mathrm{recip}} = \\frac{1}{2V} \\sum_{\\mathbf{k} \\neq \\mathbf{0}} \\frac{4\\pi}{k^2} e^{-k^2 / (4\\alpha^2)} |S(\\mathbf{k})|^2\n$$\n此处，$V=a^3$ 是晶胞的体积（在此问题中，$V=1^3=1$）。矢量 $\\mathbf{k} = 2\\pi(m_x/a, m_y/a, m_z/a)$ 是倒易晶格矢量，其中 $m_\\alpha$ 为整数，取值范围为 $\\{-N_{\\mathbf{k}}, \\dots, N_{\\mathbf{k}}\\}$（$a=1$）。排除 $\\mathbf{k}=\\mathbf{0}$ 项，这对应于导电（锡箔）边界条件，适用于电中性体系（$\\sum q_j = 0$）。结构因子 $S(\\mathbf{k})$ 是晶胞中电荷分布的 Fourier 变换：\n$$\nS(\\mathbf{k}) = \\sum_{j=1}^{N} q_j e^{-i \\mathbf{k} \\cdot \\mathbf{r}_j}\n$$\n$|S(\\mathbf{k})|^2$ 是结构因子的模的平方。代入此问题的常数，表达式变为：\n$$\nE_{\\mathrm{recip}} = 2\\pi \\sum_{\\mathbf{k} \\neq \\mathbf{0}} \\frac{e^{-k^2 / (4\\alpha^2)}}{k^2} \\left| \\sum_{j=1}^{N} q_j e^{-i\\mathbf{k} \\cdot \\mathbf{r}_j} \\right|^2\n$$\n\n**3. 自能校正 ($E_{\\mathrm{self}}$)**\n\nEwald 方法实际上将每个点电荷 $q_j$ 替换为一个点电荷加上一个符号相反的屏蔽高斯电荷分布 $-q_j$，然后再添加一个在倒易空间中处理的补偿电荷分布 $+q_j$。倒易空间求和错误地包含了每个电荷的补偿高斯分布与其自身的相互作用能。必须减去这个虚假的自相互作用能。对于单个高斯电荷分布，此能量为 $q_j^2 \\alpha / \\sqrt{\\pi}$。对晶胞中所有离子求和得到：\n$$\nE_{\\mathrm{self}} = \\frac{\\alpha}{\\sqrt{\\pi}} \\sum_{j=1}^{N} q_j^2\n$$\n对于给定的岩盐晶胞，我们有 8 个离子，电荷为 $q_j \\in \\{+1, -1\\}$，因此 $\\sum q_j^2 = 8$。于是，$E_{\\mathrm{self}} = 8\\alpha/\\sqrt{\\pi}$。\n\n**4. Madelung 常数计算**\n\n每个常规晶胞的总静电能为 $E_{\\mathrm{cell}} = E_{\\mathrm{real}} + E_{\\mathrm{recip}} - E_{\\mathrm{self}}$。问题通过以下关系定义 Madelung 常数 $\\mathcal{M}$：\n$$\nE_{\\mathrm{cell}} = -\\frac{8 \\mathcal{M}}{r_0}\n$$\n由于给定的最近邻距离 $r_0 = 1/2$，该式简化为 $E_{\\mathrm{cell}} = -16 \\mathcal{M}$。\n因此，要计算的 Madelung 常数为：\n$$\n\\mathcal{M} = -\\frac{E_{\\mathrm{cell}}}{16} = -\\frac{1}{16} (E_{\\mathrm{real}} + E_{\\mathrm{recip}} - E_{\\mathrm{self}})\n$$\n以下程序实现了这些公式，用于计算给定测试案例的 $\\mathcal{M}$。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import erfc\n\ndef calculate_madelung(params):\n    \"\"\"\n    Calculates the Madelung constant for a NaCl crystal using Ewald summation.\n    \n    The implementation follows the derived formulas for the real-space sum,\n    reciprocal-space sum, and self-energy correction.\n    \"\"\"\n    alpha, N_real, r_cut, N_k = params\n    a = 1.0  # Unit cell side length\n    V = a**3 # Unit cell volume\n\n    # Define ion charges and fractional coordinates for the conventional cell\n    charges = np.array([-1, -1, -1, -1, 1, 1, 1, 1], dtype=np.float64)\n    positions = np.array([\n        [0.0, 0.0, 0.0], [0.0, 0.5, 0.5], [0.5, 0.0, 0.5], [0.5, 0.5, 0.0], # Anions\n        [0.5, 0.0, 0.0], [0.0, 0.5, 0.0], [0.0, 0.0, 0.5], [0.5, 0.5, 0.5]  # Cations\n    ], dtype=np.float64) * a\n    \n    num_ions = len(charges)\n\n    # 1. Real-space sum (E_real)\n    # This part sums the short-range interactions.\n    # It is split into two parts for clarity and efficiency:\n    # E_real_ij for interactions between different ions (i != j) and their periodic images.\n    # E_real_ii for interactions between an ion and its own periodic images.\n    \n    # Part 1.1: Sum over distinct pairs (i > j)\n    E_real_ij = 0.0\n    for i in range(num_ions):\n        for j in range(i + 1, num_ions):\n            q_i, q_j = charges[i], charges[j]\n            r_ij = positions[i] - positions[j]\n            \n            for nx in range(-N_real, N_real + 1):\n                for ny in range(-N_real, N_real + 1):\n                    for nz in range(-N_real, N_real + 1):\n                        R = np.array([nx, ny, nz], dtype=np.float64) * a\n                        dist = np.linalg.norm(r_ij + R)\n                        if dist < r_cut and dist > 1e-9: # Avoid division by zero for r_ij + R = 0\n                            E_real_ij += q_i * q_j * erfc(alpha * dist) / dist\n                            \n    # Part 1.2: Sum over self-interactions with periodic images (i == j, R != 0)\n    E_real_ii_summand = 0.0\n    for nx in range(-N_real, N_real + 1):\n        for ny in range(-N_real, N_real + 1):\n            for nz in range(-N_real, N_real + 1):\n                if nx == 0 and ny == 0 and nz == 0:\n                    continue\n                R = np.array([nx, ny, nz], dtype=np.float64) * a\n                dist = np.linalg.norm(R)\n                if dist < r_cut:\n                    E_real_ii_summand += erfc(alpha * dist) / dist\n    \n    E_real_ii = 0.5 * np.sum(charges**2) * E_real_ii_summand\n    E_real = E_real_ij + E_real_ii\n\n    # 2. Reciprocal-space sum (E_recip)\n    # This part sums the long-range interactions in Fourier space.\n    E_recip = 0.0\n    for mx in range(-N_k, N_k + 1):\n        for my in range(-N_k, N_k + 1):\n            for mz in range(-N_k, N_k + 1):\n                if mx == 0 and my == 0 and mz == 0:\n                    continue\n                \n                k_vec = 2 * np.pi / a * np.array([mx, my, mz], dtype=np.float64)\n                k_sq = np.dot(k_vec, k_vec)\n\n                # Structure factor S(k)\n                k_dot_r = np.dot(positions, k_vec)\n                S_k = np.sum(charges * np.exp(-1j * k_dot_r))\n                S_k_sq_abs = np.abs(S_k)**2\n                \n                E_recip += np.exp(-k_sq / (4 * alpha**2)) / k_sq * S_k_sq_abs\n\n    E_recip *= 2 * np.pi / V\n\n    # 3. Self-energy correction (E_self)\n    # This term corrects for the spurious self-interaction of the screening\n    # Gaussian charge distributions included in the reciprocal-space sum.\n    E_self = (alpha / np.sqrt(np.pi)) * np.sum(charges**2)\n\n    # 4. Total energy and Madelung Constant (M)\n    E_cell = E_real + E_recip - E_self\n    \n    # Relation from problem statement: E_cell = -16 * M\n    M = -E_cell / 16.0\n    \n    return round(M, 8)\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (2.0, 4, 4.0, 4),\n        (3.5, 5, 5.0, 6),\n        (6.0, 3, 3.0, 8),\n        (4.0, 8, 8.0, 3),\n        (4.5, 10, 10.0, 10),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = calculate_madelung(case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "2469742"}, {"introduction": "计算自由能差异是分子模拟最重要但计算成本最高的应用之一，而这些计算的效率关键取决于所选方法和计算资源的分配策略。本练习要求你扮演一名计算科学家的角色，利用初步模拟得到的统计数据，来比较诸如自由能微扰（FEP）、热力学积分（TI）和Bennett接受率（BAR）等不同自由能计算方法的效率。你将学会如何诊断并处理如相空间重叠不良等潜在问题，并学习如何优化资源分配以最小化统计误差，从而实现从仅仅运行模拟到为获得最佳结果而进行策略性设计的跃升。[@problem_id:2469749]", "problem": "您正在比较一个分子体系在温度$T$下，其两个炼金术状态之间亥姆霍兹自由能差（Helmholtz free energy difference）的三种估计方法：自由能微扰（Free Energy Perturbation, FEP）、热力学积分（Thermodynamic Integration, TI）和 Bennett 接受率方法（Bennett Acceptance Ratio, BAR）。该体系由一个炼金术坐标 $\\lambda \\in [0,1]$ 参数化，其势能为 $U(x,\\lambda)$，可观测量为 $g(x,\\lambda) \\equiv \\partial U(x,\\lambda)/\\partial \\lambda$。目标自由能差由标准恒等式 $\\Delta F = \\int_{0}^{1} \\langle g \\rangle_{\\lambda}\\, d\\lambda$ 定义，其中 $\\langle \\cdot \\rangle_{\\lambda}$ 表示在固定 $\\lambda$ 下的正则系综平均。\n\n您有固定的总计算时间预算 $\\mathcal{T} = 1000\\,\\mathrm{ps}$ 用于分配。您将在间隔均匀（$\\Delta \\lambda = 0.25$）的窗口 $\\lambda_k \\in \\{0, 0.25, 0.5, 0.75, 1\\}$ 中进行独立的分子动力学（Molecular Dynamics, MD）模拟。TI 的数值积分使用梯形法则，其权重为 $w_0 = w_4 = \\Delta \\lambda/2$ 和 $w_1 = w_2 = w_3 = \\Delta \\lambda$。预模拟（短时间的已平衡模拟）为每个窗口中 $g(x,\\lambda_k)$ 的时间序列提供了以下统计数据：\n- 标准差：$\\sigma_0 = 3, \\sigma_1 = 4, \\sigma_2 = 6, \\sigma_3 = 4, \\sigma_4 = 3$（单位为一致的能量单位）。\n- 积分自相关时间：$\\tau_0 = 1\\,\\mathrm{ps}, \\tau_1 = 2\\,\\mathrm{ps}, \\tau_2 = 3\\,\\mathrm{ps}, \\tau_3 = 2\\,\\mathrm{ps}, \\tau_4 = 1\\,\\mathrm{ps}$。\n\n假设在 $[0,1]$ 区间上 $g(\\lambda)$ 可以很好地用关于 $\\lambda$ 的线性函数近似，并且预模拟的统计数据在正式的模拟过程中保持有效。对于从稳态 MD 轨迹获得的时间平均可观测量，使用中心极限定理和时间序列理论的一个经过充分检验的推论，即在时长为 $t$ 的时间段内，时间平均值的方差近似为 $\\mathrm{Var}[\\bar{g}] \\approx 2 \\tau_{\\mathrm{int}} \\sigma^2 / t$（对于足够大的 $t$），其中 $\\sigma^2$ 是可观测量的平衡方差，$\\tau_{\\mathrm{int}}$ 是积分自相关时间。假设不同窗口中的模拟是独立的，并忽略任何额外开销或非平衡瞬态过程。\n\n对于基于端点的估计方法，有以下额外的预模拟信息。在 $\\lambda=0$（状态 A）采样时，约化势能差 $\\Delta u \\equiv \\beta [U(x,1) - U(x,0)]$（其中 $\\beta = 1/(k_B T)$）近似服从均值为 $\\mu = 10$、标准差为 $s = 5$ 的高斯分布。这意味着端点系综之间的构型空间重叠非常差。\n\n在固定的预算 $\\mathcal{T}$ 下，考虑以下估计 $\\Delta F$ 的策略：\n- A. 仅从 $\\lambda=0$ 进行前向 FEP，将全部预算 $\\mathcal{T}$ 用于对状态 A 采样，并使用 $e^{-\\Delta u}$ 的指数平均。\n- B. 仅在 $\\lambda=0$ 和 $\\lambda=1$ 之间进行 BAR，对状态 A 和 B 各使用一半时间 $\\mathcal{T}/2$ 进行采样，并求解标准 BAR 方程来估计 $\\Delta F$。\n- C. 在 5 个窗口中进行 TI，每个窗口均匀分配时间 $\\mathcal{T}/5$。\n- D. 在 5 个窗口中进行 TI，在窗口间采用非均匀的时间分配，以在总时间为 $\\mathcal{T}$ 的约束下，最小化梯形估计的总均方误差。\n\n在这些假设下，哪种策略产生的均方误差最小？为什么？\n\n选择一个选项：\nA. 在 $\\lambda=0$ 进行前向 FEP，所有时间用于状态 A。\nB. 两状态 BAR，在 $\\lambda=0$ 和 $\\lambda=1$ 之间平分时间。\nC. 5 个窗口的 TI，每个窗口时间均匀。\nD. 5 个窗口的 TI，在窗口间采用最优选择的非均匀时间分配，以在时间约束下最小化梯形估计量的方差。\n\n用唯一最佳选项作答。", "solution": "所述问题具有科学依据且提法严谨。它呈现了计算统计力学中一个比较自由能计算方法效率的标准场景。进行定量分析所需的所有数据和假设均已提供。我们来着手求解。\n\n目标是找出能够最小化亥姆霍兹自由能差估计值 $\\Delta F$ 的均方误差（Mean Squared Error, MSE）的策略。MSE 是方差和偏差平方的和：$\\mathrm{MSE} = \\mathrm{Var} + (\\mathrm{Bias})^2$。对于一个设计良好的计算，偏差通常远小于方差，因此我们致力于最小化估计量的方差。\n\n让我们分析每种提议的策略。\n\n对于像热力学积分（TI）这样的多步方法，总自由能差是通过对 $\\partial U/\\partial\\lambda$ 的系综平均值进行数值积分来估计的。估计量为 $\\Delta \\hat{F}_{\\mathrm{TI}} = \\sum_{k=0}^{4} w_k \\hat{g}_k$，其中 $\\hat{g}_k$ 是在窗口 $\\lambda_k$ 进行时长为 $t_k$ 的模拟所得到的 $g(x,\\lambda_k) = \\partial U(x,\\lambda_k)/\\partial\\lambda$ 的估计平均值。权重 $w_k$ 由梯形法则给出：$w_0 = w_4 = \\Delta\\lambda/2 = 0.25/2 = 0.125$，以及 $w_1 = w_2 = w_3 = \\Delta\\lambda = 0.25$。\n\n时间平均可观测量 $\\bar{g}$ 的方差由 $\\mathrm{Var}[\\bar{g}] \\approx 2 \\tau_{\\mathrm{int}} \\sigma^2 / t$ 给出。让我们定义一个特定于窗口的“难度因子” $C_k = 2 \\tau_k \\sigma_k^2$。因此，平均值估计量 $\\hat{g}_k$ 的方差为 $\\mathrm{Var}(\\hat{g}_k) \\approx C_k/t_k$。根据问题数据：\n- $C_0 = 2 \\cdot (1\\,\\mathrm{ps}) \\cdot (3)^2 = 18$\n- $C_1 = 2 \\cdot (2\\,\\mathrm{ps}) \\cdot (4)^2 = 64$\n- $C_2 = 2 \\cdot (3\\,\\mathrm{ps}) \\cdot (6)^2 = 216$\n- $C_3 = 2 \\cdot (2\\,\\mathrm{ps}) \\cdot (4)^2 = 64$\n- $C_4 = 2 \\cdot (1\\,\\mathrm{ps}) \\cdot (3)^2 = 18$\n$C_k$ 的单位是 (能量)$^2 \\cdot \\mathrm{ps}$。\n\n由于不同窗口中的模拟是独立的，TI 估计量的总方差为：\n$$ \\mathrm{Var}(\\Delta \\hat{F}_{\\mathrm{TI}}) = \\mathrm{Var}\\left(\\sum_{k=0}^{4} w_k \\hat{g}_k\\right) = \\sum_{k=0}^{4} w_k^2 \\mathrm{Var}(\\hat{g}_k) = \\sum_{k=0}^{4} \\frac{w_k^2 C_k}{t_k} $$\n总模拟时间受约束：$\\sum_{k=0}^{4} t_k = \\mathcal{T} = 1000\\,\\mathrm{ps}$。\n\n现在我们评估各个选项。\n\n**A. 在 $\\lambda=0$ 进行前向 FEP，所有时间用于状态 A。**\n\n自由能微扰（FEP）依赖于恒等式 $\\Delta F = -k_B T \\ln \\langle e^{-\\beta \\Delta U} \\rangle_A$。问题提供了从状态 A（$\\lambda=0$）采样的约化势能差 $\\Delta u \\equiv \\beta \\Delta U$ 的预模拟数据：其分布近似为均值 $\\mu = 10$、标准差 $s = 5$ 的高斯分布。这些数值表明两个端点状态（$\\lambda=0$ 和 $\\lambda=1$）的相空间重叠极差。从状态 A 采样的构型对状态 B 具有热力学相关性的概率小到可以忽略不计。\n\n这种差的重叠导致 FEP 存在两个致命问题：\n1.  **系统性偏差**：对于有限的样本量，琴生不等式确保 FEP 估计量是有偏的，会系统性地低估真实的自由能差。当重叠很差时，偏差会非常严重。\n2.  **巨大的方差**：估计量的方差与被平均的量 $e^{-\\Delta u}$ 的方差有关。对于高斯分布的 $\\Delta u$，方差为 $\\mathrm{Var}(e^{-\\Delta u}) = e^{-2\\mu + 2s^2} - e^{-2\\mu + s^2} = e^{-20+50} - e^{-20+25} = e^{30} - e^5$。这是一个灾难性的大数字，意味着 FEP 的估计值将被那些不太可能被充分采样的罕见高权重事件所带来的噪声主导。\n\n这个策略存在根本性缺陷，并将产生一个具有极大均方误差的结果。\n\n**结论：不正确。**\n\n**B. 两状态 BAR，在 $\\lambda=0$ 和 $\\lambda=1$ 之间平分时间。**\n\nBennett 接受率（BAR）方法是组合两个状态数据的最小方差无偏估计量。虽然它比 FEP 稳健得多，但其准确性仍然从根本上取决于相空间重叠的程度。问题明确指出重叠“非常差”，这一点由给出的 $\\Delta u$ 统计数据所证实。状态间 $10 \\,k_B T$ 的平均能量差是巨大的。试图一步跨越如此大的差距，即使使用最优的 BAR 方法，效率也很低。BAR 估计的方差虽然是有限的，但会非常大，因为端点分布之间的重叠积分极小。一种在统计上效率高得多的方法是引入中间状态来弥合差距，就像在 TI 策略中那样。因此，虽然 BAR 优于 FEP，但预计其效率将远低于一个执行良好的 TI 计算。\n\n**结论：不正确。**\n\n**C. 5 个窗口的 TI，每个窗口时间均匀。**\n\n这个策略将总时间 $\\mathcal{T} = 1000\\,\\mathrm{ps}$ 均匀分配到 5 个窗口中。因此，对于所有 $k \\in \\{0, 1, 2, 3, 4\\}$，$t_k = \\mathcal{T}/5 = 200\\,\\mathrm{ps}$。$\\Delta F$ 估计的方差为：\n$$ \\mathrm{Var}(\\Delta \\hat{F}_{\\mathrm{unif}}) = \\sum_{k=0}^{4} \\frac{w_k^2 C_k}{t_k} = \\frac{1}{200} \\sum_{k=0}^{4} w_k^2 C_k $$\n我们计算这个和：\n$$ \\sum_{k=0}^{4} w_k^2 C_k = (0.125)^2(18) + (0.25)^2(64) + (0.25)^2(216) + (0.25)^2(64) + (0.125)^2(18) $$\n$$ = 0.28125 + 4.0 + 13.5 + 4.0 + 0.28125 = 22.0625 $$\n方差为：\n$$ \\mathrm{Var}(\\Delta \\hat{F}_{\\mathrm{unif}}) = \\frac{22.0625}{200} \\approx 0.1103 $$\n这是一个合理的策略，它正确地使用了中间状态来处理端点重叠差的问题，但时间分配不一定是最优的。\n\n**结论：不正确。**（因为存在更好的选项）。\n\n**D. 5 个窗口的 TI，采用最优选择的非均匀时间分配。**\n\n该策略旨在最小化总方差 $\\mathrm{Var}(\\Delta \\hat{F}_{\\mathrm{TI}}) = \\sum_{k=0}^{4} \\frac{w_k^2 C_k}{t_k}$，并受约束 $\\sum_{k=0}^{4} t_k = \\mathcal{T}$。这是一个标准的约束优化问题，可以使用拉格朗日乘数法求解。拉格朗日函数为 $\\mathcal{L} = \\sum_{k} \\frac{w_k^2 C_k}{t_k} + \\mu(\\sum_{k} t_k - \\mathcal{T})$。令偏导数 $\\partial\\mathcal{L}/\\partial t_j = 0$ 可得最优时间 $t_j$ 正比于 $w_j \\sqrt{C_j}$。\n具体的分配是：\n$$ t_j = \\mathcal{T} \\frac{w_j \\sqrt{C_j}}{\\sum_{k=0}^{4} w_k \\sqrt{C_k}} $$\n当使用这些最优时间时，可实现的最小方差由下式给出：\n$$ \\mathrm{Var}(\\Delta \\hat{F}_{\\mathrm{opt}}) = \\frac{1}{\\mathcal{T}} \\left( \\sum_{k=0}^{4} w_k \\sqrt{C_k} \\right)^2 $$\n让我们计算总和 $\\sum w_k \\sqrt{C_k}$：\n- $w_0 \\sqrt{C_0} = 0.125 \\cdot \\sqrt{18} = 0.125 \\cdot 3\\sqrt{2} \\approx 0.5303$\n- $w_1 \\sqrt{C_1} = 0.25 \\cdot \\sqrt{64} = 2.0$\n- $w_2 \\sqrt{C_2} = 0.25 \\cdot \\sqrt{216} = 0.25 \\cdot 6\\sqrt{6} \\approx 3.6742$\n- $w_3 \\sqrt{C_3} = 0.25 \\cdot \\sqrt{64} = 2.0$\n- $w_4 \\sqrt{C_4} = 0.125 \\cdot \\sqrt{18} \\approx 0.5303$\n总和为 $\\sum w_k \\sqrt{C_k} \\approx 0.5303 + 2.0 + 3.6742 + 2.0 + 0.5303 = 8.7348$。\n最小方差是：\n$$ \\mathrm{Var}(\\Delta \\hat{F}_{\\mathrm{opt}}) \\approx \\frac{(8.7348)^2}{1000} = \\frac{76.297}{1000} \\approx 0.0763 $$\n根据其构造，该方差必须小于或等于任何其他分配（包括策略 C 的均匀分配）所产生的方差。确实，$0.0763 < 0.1103$。此策略将更多的模拟时间分配给对总误差贡献最大的窗口（由积分权重 $w_k$ 和统计难度 $\\sqrt{C_k}$ 的乘积决定），从而最有效地利用计算预算。\n\n**结论：正确。**\n\n比较所有选项，端点方法（A 和 B）因相空间重叠差而失败。分步的 TI 方法（C 和 D）要优越得多。在两种 TI 策略之间，根据定义，最优时间分配（D）比均匀分配（C）产生更低的方差。因此，策略 D 提供了具有最小均方误差的估计量。", "answer": "$$\\boxed{D}$$", "id": "2469749"}]}