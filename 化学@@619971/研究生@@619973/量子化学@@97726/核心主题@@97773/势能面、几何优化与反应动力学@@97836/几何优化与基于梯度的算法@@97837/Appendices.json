{"hands_on_practices": [{"introduction": "在所有基于梯度的几何优化算法中，梯度（即作用在原子核上力的负值）是基石。尽管解析梯度因其准确性和效率而成为首选，但并非所有理论水平下都能得到解析梯度。本练习将演示一种实用的数值替代方法——有限差分法，它通过单点能计算来估算梯度。此外，本练习还将介绍一种强大的技术，即理查森外推法 (Richardson extrapolation)，通过结合不同步长的计算结果来系统性地提高数值梯度的准确性 [@problem_id:2894227]。", "problem": "在玻恩–奥本海默（Born–Oppenheimer, BO）近似中，分子的绝热电子能量 $E(q)$ 在参考几何构型 $q=0$ 附近是关于一维内坐标 $q$ 的解析函数。考虑沿单一非质量加权简正坐标（单位为玻尔）的位移 $q=\\pm h$、$q=\\pm h/2$ 和 $q=\\pm h/4$。您在这些位移后的几何构型上进行了高精度的电子能量计算，并获得了以下总能量（单位为哈特里）：\n- 当 $h = 0.02$ 玻尔时，$E(+h) = -99.99982079201315556$, $E(-h) = -99.99985919198648889$\n- $E\\!\\left(+\\frac{h}{2}\\right) = -99.99995009999950041$, $E\\!\\left(-\\frac{h}{2}\\right) = -99.99996989999949958$\n- $E\\!\\left(+\\frac{h}{4}\\right) = -99.99998501249996876$, $E\\!\\left(-\\frac{h}{4}\\right) = -99.99999498749996874$\n\n仅从 $E(q)$ 在 $q=0$ 点的泰勒展开和导数的定义出发，完成以下任务：\n- 推导在 $q=0$ 处，使用步长 $h$ 的中心有限差分梯度估计量 $G(h)$，及其领头阶截断误差随 $h$ 的标度关系。\n- 根据给定的能量计算 $G(h)$、$G(h/2)$ 和 $G(h/4)$。\n- 应用理查森外推法（Richardson extrapolation）构成两个改进的梯度估计值，\n  $$G_{1}=\\frac{4\\,G(h/2)-G(h)}{3}, \\qquad G_{2}=\\frac{4\\,G(h/4)-G(h/2)}{3},$$\n  并且，假设 $G(h)$ 的误差级数由 $h$ 的偶次幂主导，使用 $|G_{2}-G_{1}|/15$ 估计 $G_{2}$ 中剩余的截断误差。\n- 仅报告理查森外推法得到的梯度 $G_{2}$，并四舍五入至十位有效数字。梯度以哈特里/玻尔为单位表示。", "solution": "该问题是数值分析在量子化学中应用的一个标准习题，具体涉及为几何优化计算分子梯度。该问题在科学上是合理的、提法明确，并包含了求解所需的所有信息。我将开始解题。\n\n核心任务是确定在参考几何构型 $q=0$ 处的电子能量梯度 $G(0) = E'(0)$。该方法将基于从能量函数 $E(q)$ 的泰勒级数展开推导出的有限差分近似。\n\n首先，我们建立一阶导数的中心有限差分公式。题目说明函数 $E(q)$ 在 $q=0$ 附近是解析的。因此，我们可以写出其在该点附近的泰勒级数展开式：\n$$ E(q) = E(0) + E'(0)q + \\frac{1}{2!}E''(0)q^2 + \\frac{1}{3!}E'''(0)q^3 + \\frac{1}{4!}E''''(0)q^4 + \\frac{1}{5!}E^{(5)}(0)q^5 + O(q^6) $$\n让我们在点 $q=+h$ 和 $q=-h$ 处计算该展开式：\n$$ E(+h) = E(0) + E'(0)h + \\frac{1}{2}E''(0)h^2 + \\frac{1}{6}E'''(0)h^3 + \\frac{1}{24}E''''(0)h^4 + \\frac{1}{120}E^{(5)}(0)h^5 + O(h^6) $$\n$$ E(-h) = E(0) - E'(0)h + \\frac{1}{2}E''(0)h^2 - \\frac{1}{6}E'''(0)h^3 + \\frac{1}{24}E''''(0)h^4 - \\frac{1}{120}E^{(5)}(0)h^5 + O(h^6) $$\n从第一个表达式中减去第二个表达式，得到：\n$$ E(+h) - E(-h) = 2E'(0)h + \\frac{2}{6}E'''(0)h^3 + \\frac{2}{120}E^{(5)}(0)h^5 + O(h^7) $$\n求解梯度 $E'(0)$，我们发现：\n$$ E'(0) = \\frac{E(+h) - E(-h)}{2h} - \\frac{1}{6}E'''(0)h^2 - \\frac{1}{60}E^{(5)}(0)h^4 - O(h^6) $$\n梯度的中心有限差分估计量，我们记为 $G(h)$，是等式右边的第一项：\n$$ G(h) = \\frac{E(+h) - E(-h)}{2h} $$\n真实梯度 $G_{true} = E'(0)$ 可以用估计量 $G(h)$ 及其截断误差来表示：\n$$ G_{true} = G(h) - \\frac{1}{6}E'''(0)h^2 - \\frac{1}{60}E^{(5)}(0)h^4 - \\dots $$\n这表明估计量 $G(h)$ 的截断误差可以写成一个关于 $h$ 的偶次幂的级数：\n$$ G(h) = G_{true} + c_2 h^2 + c_4 h^4 + c_6 h^6 + \\dots $$\n其中 $c_2 = \\frac{1}{6}E'''(0)$，$c_4 = \\frac{1}{60}E^{(5)}(0)$，以此类推。领头阶截断误差是 $c_2 h^2$，其标度关系为 $O(h^2)$。\n\n接下来，我们使用给定的能量值和步长 $h = 0.02$ 玻尔来计算梯度估计量 $G(h)$、$G(h/2)$ 和 $G(h/4)$ 的数值。梯度的单位将是哈特里/玻尔。\n\n对于 $s = h = 0.02$：\n$$ G(h) = \\frac{E(+h) - E(-h)}{2h} = \\frac{-99.99982079201315556 - (-99.99985919198648889)}{2 \\times 0.02} $$\n$$ G(h) = \\frac{0.00003839997333333333}{0.04} = 0.00095999933333333325 $$\n\n对于 $s = h/2 = 0.01$：\n$$ G(h/2) = \\frac{E(+h/2) - E(-h/2)}{2(h/2)} = \\frac{-99.99995009999950041 - (-99.99996989999949958)}{0.02} $$\n$$ G(h/2) = \\frac{0.00001979999999917}{0.02} = 0.0009899999999585 $$\n\n对于 $s = h/4 = 0.005$：\n$$ G(h/4) = \\frac{E(+h/4) - E(-h/4)}{2(h/4)} = \\frac{-99.99998501249996876 - (-99.99999498749996874)}{0.01} $$\n$$ G(h/4) = \\frac{0.00000997499999998}{0.01} = 0.000997499999998 $$\n\n现在，我们应用理查森外推法（Richardson extrapolation）来改进这些估计值。误差级数为 $G(s) = G_{true} + c_2 s^2 + c_4 s^4 + O(s^6)$。我们考虑两个步长 $h$ 和 $h/2$：\n$$ G(h) = G_{true} + c_2 h^2 + c_4 h^4 + O(h^6) $$\n$$ G(h/2) = G_{true} + c_2 (h/2)^2 + c_4 (h/2)^4 + O(h^6) = G_{true} + \\frac{1}{4}c_2 h^2 + \\frac{1}{16}c_4 h^4 + O(h^6) $$\n为了消除 $O(h^2)$ 项，我们构造一个线性组合。将第二个方程乘以 $4$ 并减去第一个方程，得到：\n$$ 4G(h/2) - G(h) = 3G_{true} - \\frac{3}{4}c_4 h^4 + O(h^6) $$\n那么，第一个外推估计值 $G_1$ 是：\n$$ G_1 = \\frac{4G(h/2) - G(h)}{3} = G_{true} - \\frac{1}{4}c_4 h^4 + O(h^6) $$\n该估计值的领头误差阶数为 $O(h^4)$。使用我们计算出的值：\n$$ G_1 = \\frac{4(0.0009899999999585) - 0.00095999933333325}{3} $$\n$$ G_1 = \\frac{0.003959999999834 - 0.00095999933333325}{3} = \\frac{0.00300000066650075}{3} \\approx 0.0010000002221669 $$\n\n第二个外推估计值 $G_2$ 以同样的方式由步长 $h/2$ 和 $h/4$ 形成：\n$$ G_2 = \\frac{4G(h/4) - G(h/2)}{3} $$\n这消除了 $O((h/2)^2)$ 误差项，得到一个领头误差阶数为 $O((h/2)^4) = O(h^4/16)$ 的估计值。\n$$ G_2 = \\frac{4(0.000997499999998) - 0.0009899999999585}{3} $$\n$$ G_2 = \\frac{0.003989999999992 - 0.0009899999999585}{3} = \\frac{0.0030000000000335}{3} \\approx 0.0010000000000112 $$\n\n题目要求估计 $G_2$ 中剩余的截断误差。设 $A(h)$ 为外推值，所以 $G_1 = A(h)$ 且 $G_2 = A(h/2)$。我们已经证明，对于某个常数 $K_4 = -c_4/4$，有 $A(s) = G_{true} + K_4 s^4 + O(s^6)$。\n$$ G_1 = G_{true} + K_4 h^4 + O(h^6) $$\n$$ G_2 = G_{true} + K_4 (h/2)^4 + O(h^6) = G_{true} + \\frac{1}{16}K_4 h^4 + O(h^6) $$\n将这两个方程相减，我们得到 $G_1 - G_2 \\approx \\frac{15}{16}K_4 h^4$。\n$G_2$ 的误差是 $Err(G_2) = G_2 - G_{true} \\approx \\frac{1}{16}K_4 h^4$。\n从这些关系中，我们可以看到 $Err(G_2) \\approx \\frac{1}{15}(G_1 - G_2)$。因此，误差的大小可以估计为 $|G_2 - G_1|/15$，这证实了问题陈述中提供的公式。这提供了一种评估外推法准确性的方法。\n\n最后的任务是报告理查森外推法得到的梯度 $G_2$，并四舍五入到十位有效数字。\n计算出的值为 $G_2 \\approx 0.0010000000000112$。用科学记数法表示，这是 $1.0000000000112 \\times 10^{-3}$。\n前十位有效数字是 $1$，后面跟着九个 $0$。第十一位有效数字是 $0$，因此，在四舍五入时，第十位有效数字（一个 $0$）保持不变。\n最终结果是 $1.000000000 \\times 10^{-3}$ 哈特里/玻尔。", "answer": "$$\n\\boxed{1.000000000 \\times 10^{-3}}\n$$", "id": "2894227"}, {"introduction": "虽然可以在笛卡尔坐标系中进行优化，但使用一组化学上直观的内坐标（键长、键角和二面角）通常效率要高得多。本练习将探究实现这一转换的基础：Wilson B 矩阵。掌握 B 矩阵的构建是理解力与位移如何在笛卡尔坐标系和内坐标系之间相互转换的关键，并且本问题特别关注为线性或近线性几何结构定义非奇异坐标这一重要的实际挑战 [@problem_id:2894221]。", "problem": "考虑一个三原子分子，其原子标记为 $\\mathrm{A}$、$\\mathrm{B}$ 和 $\\mathrm{C}$，笛卡尔坐标汇集为 $\\mathbf{x} = (x_{\\mathrm{A}}, y_{\\mathrm{A}}, z_{\\mathrm{A}}, x_{\\mathrm{B}}, y_{\\mathrm{B}}, z_{\\mathrm{B}}, x_{\\mathrm{C}}, y_{\\mathrm{C}}, z_{\\mathrm{C}})^{\\top}$。在内坐标中，对于一个非线性三原子分子，一个常见的非冗余选择是集合 $q = (r_{1}, r_{2}, \\theta)^{\\top}$，其中 $r_{1} = |\\mathbf{R}_{\\mathrm{B}} - \\mathbf{R}_{\\mathrm{A}}|$，$r_{2} = |\\mathbf{R}_{\\mathrm{C}} - \\mathbf{R}_{\\mathrm{B}}|$，$\\theta$ 是键角 $\\angle \\mathrm{ABC}$。Wilson $B$ 矩阵定义为 $d\\mathbf{q} = B\\, d\\mathbf{x}$，其元素为 $B_{ij} = \\partial q_{i}/\\partial x_{j}$。\n\n1. 从定义 $r_{ij} = |\\mathbf{R}_{j} - \\mathbf{R}_{i}|$ 和 $\\cos\\theta = \\hat{\\mathbf{u}} \\cdot \\hat{\\mathbf{v}}$（其中 $\\hat{\\mathbf{u}} = (\\mathbf{R}_{\\mathrm{A}} - \\mathbf{R}_{\\mathrm{B}})/r_{1}$ 且 $\\hat{\\mathbf{v}} = (\\mathbf{R}_{\\mathrm{C}} - \\mathbf{R}_{\\mathrm{B}})/r_{2}$）出发，描述如何通过计算内坐标相对于笛卡尔坐标的梯度来为 $(r_{1}, r_{2}, \\theta)$ 构建 Wilson $B$ 矩阵。您的纲要应指明被微分的几何量以及必须遵守的不变性，且无需引用任何现成的最终公式。\n\n2. 现在考虑一个特殊情况，即一个沿 $z$ 轴的线性平衡构型，其中 $\\mathbf{R}_{\\mathrm{B}} = (0,0,0)$、$\\mathbf{R}_{\\mathrm{A}} = (0,0,-r_{1})$ 和 $\\mathbf{R}_{\\mathrm{C}} = (0,0,+r_{2})$。在这种情况下，键角坐标 $\\theta$ 是奇异的。将 $\\theta$ 替换为两个绕 $x$ 轴和 $y$ 轴的正交小角度彎曲坐标，定义如下：\n$$\nq_{x} = \\frac{x_{\\mathrm{A}} - x_{\\mathrm{B}}}{r_{1}} + \\frac{x_{\\mathrm{C}} - x_{\\mathrm{B}}}{r_{2}}, \n\\qquad\nq_{y} = \\frac{y_{\\mathrm{A}} - y_{\\mathrm{B}}}{r_{1}} + \\frac{y_{\\mathrm{C}} - y_{\\mathrm{B}}}{r_{2}}.\n$$\n使用这四个内坐标 $q = (r_{1}, r_{2}, q_{x}, q_{y})^{\\top}$，在所述的线性构型下显式计算 Wilson $B$ 矩阵。将笛卡尔变量排序为 $(x_{\\mathrm{A}}, y_{\\mathrm{A}}, z_{\\mathrm{A}}, x_{\\mathrm{B}}, y_{\\mathrm{B}}, z_{\\mathrm{B}}, x_{\\mathrm{C}}, y_{\\mathrm{C}}, z_{\\mathrm{C}})$，并仅用 $r_{1}$ 和 $r_{2}$ 表示您最终的 $B$ 矩阵。您的最终答案必须是 $B$ 的单一矩阵表达式，形式为符号解析表达式。不必包含单位。", "solution": "该问题陈述已经过审查且被认定有效。这是一个理论化学中适定、有科学依据的问题，没有矛盾或歧义。它要求为一般非线性三原子分子构建 Wilson $B$ 矩阵提供一个概念性纲要，然后为一个具有特定内坐标集的线性三原子分子进行显式计算。这两项任务在分子振动研究中都是标准且基础的。\n\n第一部分：为非线性三原子分子构建 Wilson $B$ 矩阵\n\nWilson $B$ 矩阵通过线性变换 $d\\mathbf{q} = B \\, d\\mathbf{x}$ 将内坐标的无穷小变化 $d\\mathbf{q}$ 与笛卡尔坐标的无穷小变化 $d\\mathbf{x}$ 联系起来。因此，$B$ 矩阵的元素是偏导数 $B_{ij} = \\frac{\\partial q_i}{\\partial x_j}$。我们通过计算每个内坐标相对于原子笛卡尔坐标的梯度来构建该矩阵的行。该分子由原子 $\\mathrm{A}$、$\\mathrm{B}$ 和 $\\mathrm{C}$ 组成，其位置矢量分别为 $\\mathbf{R}_{\\mathrm{A}}$、$\\mathbf{R}_{\\mathrm{B}}$ 和 $\\mathbf{R}_{\\mathrm{C}}$。内坐标为 $q = (r_{1}, r_{2}, \\theta)^{\\top}$，其中 $r_{1} = |\\mathbf{R}_{\\mathrm{B}} - \\mathbf{R}_{\\mathrm{A}}|$，$r_{2} = |\\mathbf{R}_{\\mathrm{C}} - \\mathbf{R}_{\\mathrm{B}}|$，且 $\\theta = \\angle\\mathrm{ABC}$。\n\n1. 键伸缩（$r_{1}$ 和 $r_{2}$）的导数：\n考虑键长 $r_{1}$。它是原子 $\\mathrm{A}$ 和 $\\mathrm{B}$ 坐标的函数。为求其导数，我们从其平方的定义开始，以避免直接处理平方根：\n$$r_{1}^{2} = (\\mathbf{R}_{\\mathrm{B}} - \\mathbf{R}_{\\mathrm{A}}) \\cdot (\\mathbf{R}_{\\mathrm{B}} - \\mathbf{R}_{\\mathrm{A}}) = \\sum_{\\alpha=x,y,z} (R_{\\mathrm{B}\\alpha} - R_{\\mathrm{A}\\alpha})^2$$\n两边对原子 $\\mathrm{A}$ 的一个笛卡尔坐标（例如 $x_{\\mathrm{A}}$）求导，得到：\n$$2r_{1} \\frac{\\partial r_{1}}{\\partial x_{\\mathrm{A}}} = \\frac{\\partial}{\\partial x_{\\mathrm{A}}} (x_{\\mathrm{B}} - x_{\\mathrm{A}})^2 = 2(x_{\\mathrm{B}} - x_{\\mathrm{A}})(-1)$$\n$$\\implies \\frac{\\partial r_{1}}{\\partial x_{\\mathrm{A}}} = \\frac{x_{\\mathrm{A}} - x_{\\mathrm{B}}}{r_{1}}$$\n这个结果可以通过将相对于 $x_{\\mathrm{A}}$、$y_{\\mathrm{A}}$ 和 $z_{\\mathrm{A}}$ 的导数汇集到一个梯度矢量 $\\nabla_{\\mathrm{A}}$ 中来推广：\n$$\\nabla_{\\mathrm{A}} r_{1} = \\frac{\\mathbf{R}_{\\mathrm{A}} - \\mathbf{R}_{\\mathrm{B}}}{r_{1}} = \\hat{\\mathbf{u}}$$\n其中 $\\hat{\\mathbf{u}} = (\\mathbf{R}_{\\mathrm{A}} - \\mathbf{R}_{\\mathrm{B}})/r_{1}$ 是从 $\\mathrm{B}$ 指向 $\\mathrm{A}$ 的单位矢量，如问题中所定义。类似地，对原子 $\\mathrm{B}$ 的坐标进行微分得出：\n$$\\nabla_{\\mathrm{B}} r_{1} = \\frac{\\mathbf{R}_{\\mathrm{B}} - \\mathbf{R}_{\\mathrm{A}}}{r_{1}} = -\\hat{\\mathbf{u}}$$\n原子 $\\mathrm{C}$ 的坐标不出现在 $r_{1}$ 的定义中，因此其相对于 $\\mathbf{R}_{\\mathrm{C}}$ 的梯度是零矢量：\n$$\\nabla_{\\mathrm{C}} r_{1} = \\mathbf{0}$$\n$r_{2} = |\\mathbf{R}_{\\mathrm{C}} - \\mathbf{R}_{\\mathrm{B}}|$ 的过程是类似的，得出 $\\nabla_{\\mathrm{B}} r_{2} = -\\hat{\\mathbf{v}}$、$\\nabla_{\\mathrm{C}} r_{2} = \\hat{\\mathbf{v}}$ 和 $\\nabla_{\\mathrm{A}} r_{2} = \\mathbf{0}$，其中 $\\hat{\\mathbf{v}} = (\\mathbf{R}_{\\mathrm{C}} - \\mathbf{R}_{\\mathrm{B}})/r_{2}$ 是从 $\\mathrm{B}$ 指向 $\\mathrm{C}$ 的单位矢量。\n\n2. 键角（$\\theta$）的导数：\n键角 $\\theta$ 由单位矢量 $\\hat{\\mathbf{u}}$ 和 $\\hat{\\mathbf{v}}$ 的点积定义：\n$$\\cos\\theta = \\hat{\\mathbf{u}} \\cdot \\hat{\\mathbf{v}}$$\n为求 $\\theta$ 的导数，我们使用链式法则和乘积法则对此表达式进行微分。对任意笛卡尔坐标 $x_j$ 求导：\n$$-\\sin\\theta \\frac{\\partial \\theta}{\\partial x_j} = \\frac{\\partial\\hat{\\mathbf{u}}}{\\partial x_j} \\cdot \\hat{\\mathbf{v}} + \\hat{\\mathbf{u}} \\cdot \\frac{\\partial\\hat{\\mathbf{v}}}{\\partial x_j}$$\n核心任务是微分单位矢量。对于 $\\hat{\\mathbf{u}} = (\\mathbf{R}_{\\mathrm{A}} - \\mathbf{R}_{\\mathrm{B}})/r_{1}$，其相对于（例如）$\\mathbf{R}_{\\mathrm{A}}$ 的导数（梯度）可以使用矢量微积分的法则求得：\n$$\\nabla_{\\mathrm{A}} \\hat{\\mathbf{u}} = \\nabla_{\\mathrm{A}} \\left( \\frac{\\mathbf{R}_{\\mathrm{A}} - \\mathbf{R}_{\\mathrm{B}}}{r_{1}} \\right) = \\frac{1}{r_{1}} \\nabla_{\\mathrm{A}}(\\mathbf{R}_{\\mathrm{A}} - \\mathbf{R}_{\\mathrm{B}}) + (\\mathbf{R}_{\\mathrm{A}} - \\mathbf{R}_{\\mathrm{B}}) \\nabla_{\\mathrm{A}}\\left(\\frac{1}{r_{1}}\\right)$$\n$$= \\frac{1}{r_{1}} \\mathbf{I} + (\\mathbf{R}_{\\mathrm{A}} - \\mathbf{R}_{\\mathrm{B}}) \\left(-\\frac{1}{r_{1}^2} \\nabla_{\\mathrm{A}} r_{1}\\right) = \\frac{1}{r_{1}} \\left( \\mathbf{I} - \\hat{\\mathbf{u}}\\hat{\\mathbf{u}}^{\\top} \\right)$$\n其中 $\\mathbf{I}$ 是单位矩阵，$\\hat{\\mathbf{u}}\\hat{\\mathbf{u}}^{\\top}$ 是外积。这表明单位矢量的变化与矢量本身正交。通过计算 $\\hat{\\mathbf{u}}$ 和 $\\hat{\\mathbf{v}}$ 相对于每个原子（$\\mathrm{A}$、$\\mathrm{B}$、$\\mathrm{C}$）坐标的导数，并将其代入微分后的余弦表达式中，我们便可得到 $\\theta$ 的梯度矢量。例如，相对于 $\\mathbf{R}_{\\mathrm{A}}$ 的梯度是：\n$$\\nabla_{\\mathrm{A}} \\theta = \\frac{1}{-\\sin\\theta} \\left( (\\nabla_{\\mathrm{A}}\\hat{\\mathbf{u}})\\cdot\\hat{\\mathbf{v}} + \\hat{\\mathbf{u}}\\cdot(\\nabla_{\\mathrm{A}}\\hat{\\mathbf{v}}) \\right)$$\n由于 $\\hat{\\mathbf{v}}$ 不依赖于 $\\mathbf{R}_{\\mathrm{A}}$，第二项消失。经过代入和矢量代数简化，可以得到 $\\nabla_{\\mathrm{A}}\\theta$、$\\nabla_{\\mathrm{B}}\\theta$ 和 $\\nabla_{\\mathrm{C}}\\theta$ 的表达式。\n\n3. 不变性：\n所得的梯度矢量必须满足物理不变性。内坐标在整个分子的均匀平移或刚性转动下保持不变。这对 $B$ 矩阵的行施加了约束。\n- 平移不变性：$\\sum_{I=\\mathrm{A,B,C}} \\nabla_{I} q_{i} = \\mathbf{0}$。对于 $r_{1}$，这是 $\\nabla_{\\mathrm{A}}r_{1} + \\nabla_{\\mathrm{B}}r_{1} + \\nabla_{\\mathrm{C}}r_{1} = \\hat{\\mathbf{u}} - \\hat{\\mathbf{u}} + \\mathbf{0} = \\mathbf{0}$。\n- 转动不变性：$\\sum_{I=\\mathrm{A,B,C}} \\mathbf{R}_{I} \\times (\\nabla_{I} q_{i}) = \\mathbf{0}$。\n这些条件对于任何有效的内坐标都必须成立，并作为对推导出的表达式的关键检验。\n\n第二部分：线性三原子分子的显式 B 矩阵\n\n给定一个线性构型，其中 $\\mathbf{R}_{\\mathrm{A}} = (0,0,-r_{1})$、$\\mathbf{R}_{\\mathrm{B}} = (0,0,0)$ 和 $\\mathbf{R}_{\\mathrm{C}} = (0,0,r_{2})$。内坐标为 $q = (r_{1}, r_{2}, q_{x}, q_{y})^{\\top}$。我们通过求偏导数来计算 $4 \\times 9$ 的 $B$ 矩阵。笛卡尔矢量排序为 $\\mathbf{x} = (x_{\\mathrm{A}}, y_{\\mathrm{A}}, z_{\\mathrm{A}}, x_{\\mathrm{B}}, y_{\\mathrm{B}}, z_{\\mathrm{B}}, x_{\\mathrm{C}}, y_{\\mathrm{C}}, z_{\\mathrm{C}})^{\\top}$。\n\n第 1 行：$q_{1} = r_{1} = \\sqrt{(x_{\\mathrm{A}}-x_{\\mathrm{B}})^2 + (y_{\\mathrm{A}}-y_{\\mathrm{B}})^2 + (z_{\\mathrm{A}}-z_{\\mathrm{B}})^2}$\n一般导数为 $\\frac{\\partial r_{1}}{\\partial R_{\\mathrm{A}\\alpha}} = \\frac{R_{\\mathrm{A}\\alpha} - R_{\\mathrm{B}\\alpha}}{r_1}$ 和 $\\frac{\\partial r_{1}}{\\partial R_{\\mathrm{B}\\alpha}} = \\frac{R_{\\mathrm{B}\\alpha} - R_{\\mathrm{A}\\alpha}}{r_1}$。\n在线性构型下计算：\n$\\frac{\\partial r_{1}}{\\partial x_{\\mathrm{A}}} = \\frac{0-0}{r_{1}} = 0$，$\\frac{\\partial r_{1}}{\\partial y_{\\mathrm{A}}} = \\frac{0-0}{r_{1}} = 0$，$\\frac{\\partial r_{1}}{\\partial z_{\\mathrm{A}}} = \\frac{-r_{1}-0}{r_{1}} = -1$。\n$\\frac{\\partial r_{1}}{\\partial x_{\\mathrm{B}}} = \\frac{0-0}{r_{1}} = 0$，$\\frac{\\partial r_{1}}{\\partial y_{\\mathrm{B}}} = \\frac{0-0}{r_{1}} = 0$，$\\frac{\\partial r_{1}}{\\partial z_{\\mathrm{B}}} = \\frac{0-(-r_{1})}{r_{1}} = 1$。\n相对于原子 $\\mathrm{C}$ 坐标的导数均为零。\n第 1 行为：$(0, 0, -1, 0, 0, 1, 0, 0, 0)$。\n\n第 2 行：$q_{2} = r_{2} = \\sqrt{(x_{\\mathrm{C}}-x_{\\mathrm{B}})^2 + (y_{\\mathrm{C}}-y_{\\mathrm{B}})^2 + (z_{\\mathrm{C}}-z_{\\mathrm{B}})^2}$\n一般导数为 $\\frac{\\partial r_{2}}{\\partial R_{\\mathrm{B}\\alpha}} = \\frac{R_{\\mathrm{B}\\alpha} - R_{\\mathrm{C}\\alpha}}{r_2}$ 和 $\\frac{\\partial r_{2}}{\\partial R_{\\mathrm{C}\\alpha}} = \\frac{R_{\\mathrm{C}\\alpha} - R_{\\mathrm{B}\\alpha}}{r_2}$。\n在线性构型下计算：\n相对于原子 $\\mathrm{A}$ 坐标的导数均为零。\n$\\frac{\\partial r_{2}}{\\partial x_{\\mathrm{B}}} = \\frac{0-0}{r_{2}} = 0$，$\\frac{\\partial r_{2}}{\\partial y_{\\mathrm{B}}} = \\frac{0-0}{r_{2}} = 0$，$\\frac{\\partial r_{2}}{\\partial z_{\\mathrm{B}}} = \\frac{0-r_{2}}{r_{2}} = -1$。\n$\\frac{\\partial r_{2}}{\\partial x_{\\mathrm{C}}} = \\frac{0-0}{r_{2}} = 0$，$\\frac{\\partial r_{2}}{\\partial y_{\\mathrm{C}}} = \\frac{0-0}{r_{2}} = 0$，$\\frac{\\partial r_{2}}{\\partial z_{\\mathrm{C}}} = \\frac{r_{2}-0}{r_{2}} = 1$。\n第 2 行为：$(0, 0, 0, 0, 0, -1, 0, 0, 1)$。\n\n第 3 行：$q_{x} = \\frac{x_{\\mathrm{A}} - x_{\\mathrm{B}}}{r_{1}} + \\frac{x_{\\mathrm{C}} - x_{\\mathrm{B}}}{r_{2}}$\n分母中的量 $r_{1}$ 和 $r_{2}$ 是恒定的平衡键长，而不是坐标的函数。它们是线性弯曲坐标定义中的参数。\n$\\frac{\\partial q_{x}}{\\partial x_{\\mathrm{A}}} = \\frac{1}{r_{1}}$。\n$\\frac{\\partial q_{x}}{\\partial x_{\\mathrm{B}}} = -\\frac{1}{r_{1}} - \\frac{1}{r_{2}}$。\n$\\frac{\\partial q_{x}}{\\partial x_{\\mathrm{C}}} = \\frac{1}{r_{2}}$。\n所有其他导数均为零。\n第 3 行为：$(\\frac{1}{r_{1}}, 0, 0, -(\\frac{1}{r_{1}} + \\frac{1}{r_{2}}), 0, 0, \\frac{1}{r_{2}}, 0, 0)$。\n\n第 4 行：$q_{y} = \\frac{y_{\\mathrm{A}} - y_{\\mathrm{B}}}{r_{1}} + \\frac{y_{\\mathrm{C}} - y_{\\mathrm{B}}}{r_{2}}$\n与 $q_x$ 类比：\n$\\frac{\\partial q_{y}}{\\partial y_{\\mathrm{A}}} = \\frac{1}{r_{1}}$。\n$\\frac{\\partial q_{y}}{\\partial y_{\\mathrm{B}}} = -\\frac{1}{r_{1}} - \\frac{1}{r_{2}}$。\n$\\frac{\\partial q_{y}}{\\partial y_{\\mathrm{C}}} = \\frac{1}{r_{2}}$。\n所有其他导数均为零。\n第 4 行为：$(0, \\frac{1}{r_{1}}, 0, 0, -(\\frac{1}{r_{1}} + \\frac{1}{r_{2}}), 0, 0, \\frac{1}{r_{2}}, 0)$。\n\n将这四行组合起来，得到最终的 $4 \\times 9$ Wilson $B$ 矩阵。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n0 & 0 & -1 & 0 & 0 & 1 & 0 & 0 & 0 \\\\\n0 & 0 & 0 & 0 & 0 & -1 & 0 & 0 & 1 \\\\\n\\frac{1}{r_{1}} & 0 & 0 & -\\left(\\frac{1}{r_{1}} + \\frac{1}{r_{2}}\\right) & 0 & 0 & \\frac{1}{r_{2}} & 0 & 0 \\\\\n0 & \\frac{1}{r_{1}} & 0 & 0 & -\\left(\\frac{1}{r_{1}} + \\frac{1}{r_{2}}\\right) & 0 & 0 & \\frac{1}{r_{2}} & 0\n\\end{pmatrix}\n}\n$$", "id": "2894221"}, {"introduction": "一个成熟的优化器所做的远不止是沿着最速下降方向前进。本练习将深入探讨广泛使用的限制内存 Broyden–Fletcher–Goldfarb–Shanno (L-BFGS) 算法的内部工作原理。你将亲手实践这一准牛顿方法如何巧妙地利用最近的梯度差向量 ($\\mathbf{y}_k$) 和步长向量 ($\\mathbf{s}_k$) 的历史信息，来构建一个计算成本低廉的、隐式的逆 Hessian 矩阵近似，从而计算出更高效的、指向极小点的搜索方向 [@problem_id:2894174]。", "problem": "您正在使用准牛顿几何优化方法，在质量加权笛卡尔坐标下对一个小分子的Born–Oppenheimer势能面（PES）$E(\\mathbf{R})$进行最小化。在当前迭代点$\\mathbf{R}_{k+1}$，梯度为$\\mathbf{g}_{k+1} = \\nabla E(\\mathbf{R}_{k+1})$。有限内存Broyden–Fletcher–Goldfarb–Shanno（L-BFGS）方法通过应用一个隐式的逆Hessian近似$H_{k+1}$来构造步长$\\mathbf{p}_{k+1} = - H_{k+1} \\mathbf{g}_{k+1}$，该近似由满足割线条件的过去的位移和梯度差对构造而成。假设一个由两个内坐标（以原子单位计）张成的二维子空间，并且最近的$3$个数据对，从旧到新依次为：\n$\\mathbf{s}_{0} = \\begin{pmatrix}1 \\\\ 0\\end{pmatrix}\\,\\text{bohr}$，$\\mathbf{y}_{0} = \\begin{pmatrix}2 \\\\ 0\\end{pmatrix}\\,\\text{Ha}\\,\\text{bohr}^{-1}$，\n$\\mathbf{s}_{1} = \\begin{pmatrix}0 \\\\ 1\\end{pmatrix}\\,\\text{bohr}$，$\\mathbf{y}_{1} = \\begin{pmatrix}0 \\\\ 1\\end{pmatrix}\\,\\text{Ha}\\,\\text{bohr}^{-1}$，\n$\\mathbf{s}_{2} = \\begin{pmatrix}1 \\\\ 1\\end{pmatrix}\\,\\text{bohr}$，$\\mathbf{y}_{2} = \\begin{pmatrix}2 \\\\ 1\\end{pmatrix}\\,\\text{Ha}\\,\\text{bohr}^{-1}$。\n在$\\mathbf{R}_{k+1}$处的梯度为\n$\\mathbf{g}_{k+1} = \\begin{pmatrix}3 \\\\ 2\\end{pmatrix}\\,\\text{Ha}\\,\\text{bohr}^{-1}$。\n使用内存为$m=3$的L-BFGS逆Hessian乘积的标准双循环递归算法来计算步长$\\mathbf{p}_{k+1} = -H_{k+1}\\mathbf{g}_{k+1}$，其初始矩阵为标量乘以单位矩阵$H_{0} = \\gamma I$，其中$\\gamma = \\dfrac{\\mathbf{s}_{2}^{\\top} \\mathbf{y}_{2}}{\\mathbf{y}_{2}^{\\top} \\mathbf{y}_{2}}$。然后，报告其欧几里得范数$\\|\\mathbf{p}_{k+1}\\|_{2}$。\n将您的答案四舍五入到四位有效数字，并以bohr为单位表示最终结果。\n您的最终答案必须是一个实数值。", "solution": "该问题要求使用有限内存Broyden–Fletcher–Goldfarb–Shanno（L-BFGS）算法为几何优化计算搜索方向（或步长）$\\mathbf{p}_{k+1}$。步长由$\\mathbf{p}_{k+1} = -H_{k+1}\\mathbf{g}_{k+1}$给出，其中$H_{k+1}$是近似的逆Hessian矩阵，$\\mathbf{g}_{k+1}$是在当前几何构型$\\mathbf{R}_{k+1}$下势能的梯度。计算需要使用标准的L-BFGS双循环递归算法来执行。\n\n首先，我们来验证问题陈述的有效性。问题提供了所有必要信息：梯度向量$\\mathbf{g}_{k+1}$，内存大小$m=3$，最近$m$个位移向量$\\mathbf{s}_i$和梯度差向量$\\mathbf{y}_i$的历史记录，以及初始逆Hessian近似$H_0$的具体公式。L-BFGS方法要求内存中所有的向量对都满足曲率条件$\\mathbf{s}_i^\\top \\mathbf{y}_i > 0$，以确保Hessian近似保持正定。我们来检查给定数据是否满足此条件。\n对于$i=0$：$\\mathbf{s}_{0}^{\\top} \\mathbf{y}_{0} = \\begin{pmatrix}1 & 0\\end{pmatrix} \\begin{pmatrix}2 \\\\ 0\\end{pmatrix} = 2 > 0$。\n对于$i=1$：$\\mathbf{s}_{1}^{\\top} \\mathbf{y}_{1} = \\begin{pmatrix}0 & 1\\end{pmatrix} \\begin{pmatrix}0 \\\\ 1\\end{pmatrix} = 1 > 0$。\n对于$i=2$：$\\mathbf{s}_{2}^{\\top} \\mathbf{y}_{2} = \\begin{pmatrix}1 & 1\\end{pmatrix} \\begin{pmatrix}2 \\\\ 1\\end{pmatrix} = (1)(2) + (1)(1) = 3 > 0$。\n所有数据对都满足曲率条件。该问题是适定的且科学上是合理的。我们继续进行求解。\n\nL-BFGS双循环递归算法在不显式构造矩阵$H_{k+1}$的情况下计算乘积$\\mathbf{r} = H_{k+1}\\mathbf{g}_{k+1}$。该算法如下，并根据问题的索引（$i=0, 1, 2$从旧到新）进行了调整：\n\n令 $\\mathbf{g} = \\mathbf{g}_{k+1} = \\begin{pmatrix}3 \\\\ 2\\end{pmatrix}$。\n历史数据对为：\n$\\mathbf{s}_{0} = \\begin{pmatrix}1 \\\\ 0\\end{pmatrix}$，$\\mathbf{y}_{0} = \\begin{pmatrix}2 \\\\ 0\\end{pmatrix}$\n$\\mathbf{s}_{1} = \\begin{pmatrix}0 \\\\ 1\\end{pmatrix}$，$\\mathbf{y}_{1} = \\begin{pmatrix}0 \\\\ 1\\end{pmatrix}$\n$\\mathbf{s}_{2} = \\begin{pmatrix}1 \\\\ 1\\end{pmatrix}$，$\\mathbf{y}_{2} = \\begin{pmatrix}2 \\\\ 1\\end{pmatrix}$\n\n我们首先计算标量$\\rho_i = 1 / (\\mathbf{y}_i^\\top \\mathbf{s}_i)$：\n$\\rho_0 = (\\mathbf{y}_0^\\top \\mathbf{s}_0)^{-1} = (2)^{-1} = \\frac{1}{2}$。\n$\\rho_1 = (\\mathbf{y}_1^\\top \\mathbf{s}_1)^{-1} = (1)^{-1} = 1$。\n$\\rho_2 = (\\mathbf{y}_2^\\top \\mathbf{s}_2)^{-1} = (3)^{-1} = \\frac{1}{3}$。\n\n双循环递归过程如下：\n初始化 $\\mathbf{q} = \\mathbf{g} = \\begin{pmatrix}3 \\\\ 2\\end{pmatrix}$。\n\n**第一个循环（从$i=2$到$0$）：**\n对于$i=2$：\n$\\alpha_2 = \\rho_2 \\mathbf{s}_2^\\top \\mathbf{q} = \\frac{1}{3} \\begin{pmatrix}1 & 1\\end{pmatrix} \\begin{pmatrix}3 \\\\ 2\\end{pmatrix} = \\frac{1}{3}(3+2) = \\frac{5}{3}$。\n$\\mathbf{q} \\leftarrow \\mathbf{q} - \\alpha_2 \\mathbf{y}_2 = \\begin{pmatrix}3 \\\\ 2\\end{pmatrix} - \\frac{5}{3} \\begin{pmatrix}2 \\\\ 1\\end{pmatrix} = \\begin{pmatrix}3 - \\frac{10}{3} \\\\ 2 - \\frac{5}{3}\\end{pmatrix} = \\begin{pmatrix}-\\frac{1}{3} \\\\ \\frac{1}{3}\\end{pmatrix}$。\n\n对于$i=1$：\n$\\alpha_1 = \\rho_1 \\mathbf{s}_1^\\top \\mathbf{q} = 1 \\begin{pmatrix}0 & 1\\end{pmatrix} \\begin{pmatrix}-\\frac{1}{3} \\\\ \\frac{1}{3}\\end{pmatrix} = \\frac{1}{3}$。\n$\\mathbf{q} \\leftarrow \\mathbf{q} - \\alpha_1 \\mathbf{y}_1 = \\begin{pmatrix}-\\frac{1}{3} \\\\ \\frac{1}{3}\\end{pmatrix} - \\frac{1}{3} \\begin{pmatrix}0 \\\\ 1\\end{pmatrix} = \\begin{pmatrix}-\\frac{1}{3} \\\\ 0\\end{pmatrix}$。\n\n对于$i=0$：\n$\\alpha_0 = \\rho_0 \\mathbf{s}_0^\\top \\mathbf{q} = \\frac{1}{2} \\begin{pmatrix}1 & 0\\end{pmatrix} \\begin{pmatrix}-\\frac{1}{3} \\\\ 0\\end{pmatrix} = -\\frac{1}{6}$。\n$\\mathbf{q} \\leftarrow \\mathbf{q} - \\alpha_0 \\mathbf{y}_0 = \\begin{pmatrix}-\\frac{1}{3} \\\\ 0\\end{pmatrix} - (-\\frac{1}{6}) \\begin{pmatrix}2 \\\\ 0\\end{pmatrix} = \\begin{pmatrix}-\\frac{1}{3} + \\frac{2}{6} \\\\ 0\\end{pmatrix} = \\begin{pmatrix}0 \\\\ 0\\end{pmatrix}$。\n\n第一个循环结束后，向量$\\mathbf{q}$为$\\begin{pmatrix}0 \\\\ 0\\end{pmatrix}$。计算出的系数为$\\alpha_0 = -1/6$，$\\alpha_1 = 1/3$，$\\alpha_2 = 5/3$。\n\n**缩放和初始步长：**\n初始逆Hessian矩阵为$H_0 = \\gamma I$，其中$\\gamma = \\frac{\\mathbf{s}_{2}^{\\top} \\mathbf{y}_{2}}{\\mathbf{y}_{2}^{\\top} \\mathbf{y}_{2}}$。\n$\\mathbf{s}_{2}^{\\top} \\mathbf{y}_{2} = 3$。\n$\\mathbf{y}_{2}^{\\top} \\mathbf{y}_{2} = \\begin{pmatrix}2 & 1\\end{pmatrix} \\begin{pmatrix}2 \\\\ 1\\end{pmatrix} = 2^2 + 1^2 = 5$。\n因此，$\\gamma = \\frac{3}{5}$。\n初始步长向量$\\mathbf{r}$计算为$\\mathbf{r} = H_0 \\mathbf{q} = \\frac{3}{5} I \\begin{pmatrix}0 \\\\ 0\\end{pmatrix} = \\begin{pmatrix}0 \\\\ 0\\end{pmatrix}$。\n\n**第二个循环（从$i=0$到$2$）：**\n初始化 $\\mathbf{r} = \\begin{pmatrix}0 \\\\ 0\\end{pmatrix}$。\n\n对于$i=0$：\n$\\beta_0 = \\rho_0 \\mathbf{y}_0^\\top \\mathbf{r} = \\frac{1}{2} \\begin{pmatrix}2 & 0\\end{pmatrix} \\begin{pmatrix}0 \\\\ 0\\end{pmatrix} = 0$。\n$\\mathbf{r} \\leftarrow \\mathbf{r} + \\mathbf{s}_0 (\\alpha_0 - \\beta_0) = \\begin{pmatrix}0 \\\\ 0\\end{pmatrix} + \\begin{pmatrix}1 \\\\ 0\\end{pmatrix} (-\\frac{1}{6} - 0) = \\begin{pmatrix}-\\frac{1}{6} \\\\ 0\\end{pmatrix}$。\n\n对于$i=1$：\n$\\beta_1 = \\rho_1 \\mathbf{y}_1^\\top \\mathbf{r} = 1 \\begin{pmatrix}0 & 1\\end{pmatrix} \\begin{pmatrix}-\\frac{1}{6} \\\\ 0\\end{pmatrix} = 0$。\n$\\mathbf{r} \\leftarrow \\mathbf{r} + \\mathbf{s}_1 (\\alpha_1 - \\beta_1) = \\begin{pmatrix}-\\frac{1}{6} \\\\ 0\\end{pmatrix} + \\begin{pmatrix}0 \\\\ 1\\end{pmatrix} (\\frac{1}{3} - 0) = \\begin{pmatrix}-\\frac{1}{6} \\\\ \\frac{1}{3}\\end{pmatrix}$。\n\n对于$i=2$：\n$\\beta_2 = \\rho_2 \\mathbf{y}_2^\\top \\mathbf{r} = \\frac{1}{3} \\begin{pmatrix}2 & 1\\end{pmatrix} \\begin{pmatrix}-\\frac{1}{6} \\\\ \\frac{1}{3}\\end{pmatrix} = \\frac{1}{3}(-\\frac{2}{6} + \\frac{1}{3}) = \\frac{1}{3}(-\\frac{1}{3} + \\frac{1}{3}) = 0$。\n$\\mathbf{r} \\leftarrow \\mathbf{r} + \\mathbf{s}_2 (\\alpha_2 - \\beta_2) = \\begin{pmatrix}-\\frac{1}{6} \\\\ \\frac{1}{3}\\end{pmatrix} + \\begin{pmatrix}1 \\\\ 1\\end{pmatrix} (\\frac{5}{3} - 0) = \\begin{pmatrix}-\\frac{1}{6} + \\frac{5}{3} \\\\ \\frac{1}{3} + \\frac{5}{3}\\end{pmatrix} = \\begin{pmatrix}-\\frac{1}{6} + \\frac{10}{6} \\\\ \\frac{6}{3}\\end{pmatrix} = \\begin{pmatrix}\\frac{9}{6} \\\\ 2\\end{pmatrix} = \\begin{pmatrix}1.5 \\\\ 2\\end{pmatrix}$。\n\n双循环递归的结果是$\\mathbf{r} = H_{k+1}\\mathbf{g}_{k+1} = \\begin{pmatrix}1.5 \\\\ 2\\end{pmatrix}$。\nL-BFGS步长为$\\mathbf{p}_{k+1} = -\\mathbf{r} = \\begin{pmatrix}-1.5 \\\\ -2\\end{pmatrix}$。该向量的单位是bohr。\n\n最后的任务是计算该步长向量的欧几里得范数$\\|\\mathbf{p}_{k+1}\\|_2$。\n$$\n\\|\\mathbf{p}_{k+1}\\|_2 = \\left\\| \\begin{pmatrix}-1.5 \\\\ -2\\end{pmatrix} \\right\\|_2 = \\sqrt{(-1.5)^2 + (-2)^2} = \\sqrt{2.25 + 4} = \\sqrt{6.25} = 2.5\n$$\n其值恰好为$2.5$。题目要求答案四舍五入到四位有效数字。因此，结果是$2.500$。", "answer": "$$ \\boxed{2.500} $$", "id": "2894174"}]}