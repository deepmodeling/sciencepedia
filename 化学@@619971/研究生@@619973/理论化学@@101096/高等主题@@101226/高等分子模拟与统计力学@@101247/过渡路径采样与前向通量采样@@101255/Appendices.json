{"hands_on_practices": [{"introduction": "本练习是应用前向通量采样（Forward Flux Sampling, FFS）的基石。我们将把速率常数 $\\widehat{k}_{AB}$ 及其统计不确定性 $\\sigma_{\\widehat{k}}$ 的理论公式转化为一个可执行的程序。通过这项实践，你将巩固对如何将原始模拟数据——通量穿越次数和行进概率——结合起来计算稀有事件最终速率的理解。[@problem_id:2826627]", "problem": "您将实现一个程序，该程序使用“过渡路径取样”和“前向通量取样”的逻辑来计算稀有事件转变的基于界面的速率常数。从区域 $A$ 到区域 $B$ 的速率常数将根据第一性原理计算，其值为穿过一个选定初始界面的反应轨迹的概率通量，乘以一条刚刚穿过该界面的轨迹在返回 $A$ 之前到达 $B$ 的条件概率。\n\n基本原理和假设：\n- 考虑一个序参量 $\\lambda(\\mathbf{x})$，它用于定义一组不相交的界面 $\\{\\lambda_{0}, \\lambda_{1}, \\dots, \\lambda_{M}\\}$，其中 $\\lambda_{0}$ 作为 $A$ 的边界，而 $\\lambda_{M}$ 位于 $B$ 内。一条离开 $A$ 的轨迹在到达 $B$ 之前必须穿过 $\\lambda_{0}$。\n- 速率常数 $k_{AB}$ 定义为从 $A$ 穿过 $\\lambda_{0}$ 的反应轨迹的平均正向通量，乘以一条从 $\\lambda_{0}$ 开始的轨迹在返回 $A$ 之前到达 $B$ 的概率。\n- 测量模型：\n  - 穿过 $\\lambda_{0}$ 的通量通过计算在总模拟时间 $T$ 内观察到的正向穿越次数 $N_{\\mathrm{flux}}$ 来估计，并使用 $\\widehat{\\Phi} = N_{\\mathrm{flux}}/T$。假设穿越次数服从均值为 $\\Phi T$ 的泊松分布，这意味着 $\\mathrm{Var}(\\widehat{\\Phi}) \\approx \\Phi/T$ 并且对于 $N_{\\mathrm{flux}} \\gg 1$，有 $\\mathrm{Var}(\\log \\widehat{\\Phi}) \\approx 1/N_{\\mathrm{flux}}$。\n  - 连续界面之间的条件前进概率通过独立的伯努利试验来估计。在界面 $\\lambda_{i}$ 处，您进行 $n_{i}$ 次轨迹尝试，并观察到 $s_{i}$ 次成功（即在返回 $A$ 之前到达 $\\lambda_{i+1}$）。其估计量为 $\\widehat{p}_{i} = s_{i}/n_{i}$。在界面间独立的二项分布模型下，且 $n_{i}$ 足够大时，$\\mathrm{Var}(\\widehat{p}_{i}) \\approx \\widehat{p}_{i}(1-\\widehat{p}_{i})/n_{i}$，并且根据delta方法，当 $0 < \\widehat{p}_{i} < 1$ 时，有 $\\mathrm{Var}(\\log \\widehat{p}_{i}) \\approx (1-\\widehat{p}_{i})/(n_{i}\\widehat{p}_{i})$。\n- 基于界面的速率估计量是以下乘积：\n$$\n\\widehat{k}_{AB} \\;=\\; \\widehat{\\Phi} \\;\\prod_{i=0}^{M-1} \\widehat{p}_{i}\\,,\n$$\n按照惯例，当没有中间界面时，空积等于 $1$。\n- 在独立性假设和上述近似下，速率估计量对数的方差为：\n$$\n\\mathrm{Var}(\\log \\widehat{k}_{AB}) \\;\\approx\\; \\frac{1}{N_{\\mathrm{flux}}} \\;+\\; \\sum_{i=0}^{M-1} \\frac{1-\\widehat{p}_{i}}{n_{i}\\,\\widehat{p}_{i}}\\,,\n$$\n并且 $\\widehat{k}_{AB}$ 的近似标准差为：\n$$\n\\sigma_{\\widehat{k}} \\;\\approx\\; \\widehat{k}_{AB}\\,\\sqrt{ \\frac{1}{N_{\\mathrm{flux}}} \\;+\\; \\sum_{i=0}^{M-1} \\frac{1-\\widehat{p}_{i}}{n_{i}\\,\\widehat{p}_{i}} }\\,.\n$$\n\n您的程序必须实现以下规则：\n- 给定 $N_{\\mathrm{flux}}$、$T$（单位为皮秒）和一个界面试验数据列表 $\\{(n_{i}, s_{i})\\}_{i=0}^{M-1}$，使用上述公式计算 $\\widehat{k}_{AB}$ 和 $\\sigma_{\\widehat{k}}$，并以 $\\mathrm{ps}^{-1}$ 为单位表示。\n- 如果 $N_{\\mathrm{flux}} = 0$，或者任何界面有 $s_{i} = 0$，或者任何 $n_{i} = 0$，则在这种情况下将估计量定义为 $\\widehat{k}_{AB} = 0$ 且 $\\sigma_{\\widehat{k}} = 0$。\n- 如果没有界面（列表为空），则将乘积定义为 $1$，并使用上述的泊松近似计算仅考虑通量的速率及其不确定度。\n\n实现的输入规范：\n- 没有外部输入。程序必须为硬编码在程序中的测试套件计算结果。\n\n输出规范：\n- 对于每个测试用例，输出一个双元素列表 $[\\widehat{k}_{AB},\\sigma_{\\widehat{k}}]$，单位为 $\\mathrm{ps}^{-1}$，两个值都四舍五入到六位有效数字。您的程序应生成单行输出，其中包含所有给定测试用例的结果，格式为一个由方括号括起来的逗号分隔列表，其中每个元素是对应一个测试用例的双元素列表，例如 $[[x_{1},y_{1}],[x_{2},y_{2}],\\dots]$，没有额外的空白字符要求。\n\n测试套件：\n- 情况 A（常规多界面情况）：\n  - $N_{\\mathrm{flux}} = 300$，$T = 20000$ $\\mathrm{ps}$，界面 $[(1000, 300), (900, 270), (800, 160)]$。\n- 情况 B（低通量和多个具有小前进概率的界面）：\n  - $N_{\\mathrm{flux}} = 10$，$T = 10000$ $\\mathrm{ps}$，界面 $[(50, 5), (40, 4), (30, 3), (20, 2)]$。\n- 情况 C（具有高计数且下一个界面近似吸收）：\n  - $N_{\\mathrm{flux}} = 5000$，$T = 100000$ $\\mathrm{ps}$，界面 $[(100, 99)]$。\n- 情况 D（退化的零成功边界情况）：\n  - $N_{\\mathrm{flux}} = 1000$，$T = 100000$ $\\mathrm{ps}$，界面 $[(100, 0), (100, 100)]$。\n- 情况 E（无界面；仅通量估计）：\n  - $N_{\\mathrm{flux}} = 75$，$T = 5000$ $\\mathrm{ps}$，界面 $[]$。\n\n物理单位：\n- 所有速率和不确定度都必须以 $\\mathrm{ps}^{-1}$ 为单位表示。\n\n最终输出格式：\n- 程序必须打印单行输出，包含一个包含五个双元素列表的列表，每个测试用例对应一个，每个内部列表为 $[\\widehat{k}_{AB},\\sigma_{\\widehat{k}}]$，四舍五入到六位有效数字，例如 $[[0.1,0.01],[0.2,0.02],[0.3,0.03],[0.4,0.04],[0.5,0.05]]$。", "solution": "所述问题在科学上是合理的、自洽的且良定的。它提出了一个理论化学领域的标准计算任务，具体是使用前向通量取样（FFS）方法论计算速率常数。所提供的速率估计量及其不确定度的公式是统计学原理的正确应用。我们将着手推导解决方案。\n\n目标是计算从状态 $A$ 到状态 $B$ 的稀有事件转变的速率常数 $\\widehat{k}_{AB}$ 及其相关的统计不确定度 $\\sigma_{\\widehat{k}}$。该计算基于从模拟中收集的数据，即离开状态 $A$ 的轨迹通量以及这些轨迹朝着状态 $B$ 穿过一系列界面的成功概率。\n\n速率常数估计量 $\\widehat{k}_{AB}$ 由两个量的乘积给出：通过第一个界面的估计通量 $\\widehat{\\Phi}$，以及从该界面到达状态 $B$ 的估计条件概率 $\\widehat{P}(\\lambda_M|\\lambda_0)$。\n\n通量 $\\widehat{\\Phi}$ 是根据在总模拟时间 $T$ 内观察到的第一个界面 $\\lambda_0$ 的正向穿越次数 $N_{\\mathrm{flux}}$ 来估计的。\n$$\n\\widehat{\\Phi} = \\frac{N_{\\mathrm{flux}}}{T}\n$$\n$\\widehat{\\Phi}$ 的单位是时间的倒数，此处为 $\\mathrm{ps}^{-1}$。\n\n条件概率 $\\widehat{P}(\\lambda_M|\\lambda_0)$ 是作为连续界面 $\\{\\lambda_0, \\lambda_1, \\dots, \\lambda_M\\}$ 之间前进概率的乘积来计算的。一条轨迹从界面 $\\lambda_i$ 前进到 $\\lambda_{i+1}$ 而不返回状态 $A$ 的概率被估计为 $\\widehat{p}_i$。\n$$\n\\widehat{p}_i = \\frac{s_i}{n_i}\n$$\n其中 $n_i$ 是从 $\\lambda_i$ 开始的尝试轨迹的数量，$s_i$ 是其中成功到达 $\\lambda_{i+1}$ 的数量。\n\n假设界面之间的前进是独立事件，总条件概率是这些单个概率的乘积。\n$$\n\\widehat{P}(\\lambda_M|\\lambda_0) = \\prod_{i=0}^{M-1} \\widehat{p}_i\n$$\n综合这些，速率常数估计量为：\n$$\n\\widehat{k}_{AB} = \\widehat{\\Phi} \\prod_{i=0}^{M-1} \\widehat{p}_i\n$$\n如果没有中间界面（$M=0$），则乘积为空，按惯例等于 $1$，因此 $\\widehat{k}_{AB} = \\widehat{\\Phi}$。\n\n为了估计不确定度 $\\sigma_{\\widehat{k}}$，我们首先计算速率常数对数的方差 $\\mathrm{Var}(\\log \\widehat{k}_{AB})$。假设通量和前进概率的估计量是独立的，则它们对数之和的方差等于它们各自方差之和：\n$$\n\\mathrm{Var}(\\log \\widehat{k}_{AB}) = \\mathrm{Var}(\\log \\widehat{\\Phi}) + \\sum_{i=0}^{M-1} \\mathrm{Var}(\\log \\widehat{p}_i)\n$$\n问题为这些方差项提供了标准近似：\n- 通量穿越次数 $N_{\\mathrm{flux}}$ 被建模为服从泊松分布的随机变量。对于 $N_{\\mathrm{flux}} \\gg 1$，通量估计量对数的方差为 $\\mathrm{Var}(\\log \\widehat{\\Phi}) \\approx 1/N_{\\mathrm{flux}}$。\n- 成功试验次数 $s_i$ 被建模为服从二项分布的随机变量。使用delta方法，概率估计量对数的方差为 $\\mathrm{Var}(\\log \\widehat{p}_i) \\approx (1-\\widehat{p}_i)/(n_i\\widehat{p}_i)$，在 $0 < \\widehat{p}_i < 1$ 时有效。\n\n将这些代入求和式，得到对数的总方差：\n$$\n\\mathrm{Var}(\\log \\widehat{k}_{AB}) \\approx \\frac{1}{N_{\\mathrm{flux}}} + \\sum_{i=0}^{M-1} \\frac{1-\\widehat{p}_i}{n_i\\widehat{p}_i}\n$$\n$\\widehat{k}_{AB}$ 的标准差可以从其对数的方差近似得出。对于均值为 $\\mu_X$ 的随机变量 $X$，有 $\\mathrm{Var}(\\log X) \\approx \\sigma_X^2/\\mu_X^2$。重新整理此式并应用于我们的估计量，我们得到：\n$$\n\\sigma_{\\widehat{k}} \\approx \\widehat{k}_{AB} \\sqrt{\\mathrm{Var}(\\log \\widehat{k}_{AB})}\n$$\n因此，标准差的最终表达式为：\n$$\n\\sigma_{\\widehat{k}} \\approx \\widehat{k}_{AB} \\sqrt{ \\frac{1}{N_{\\mathrm{flux}}} + \\sum_{i=0}^{M-1} \\frac{1-\\widehat{p}_i}{n_i\\widehat{p}_i} }\n$$\n\n必须处理特定的计算规则：\n1. 如果 $N_{\\mathrm{flux}} = 0$，则通量为零，因此 $\\widehat{k}_{AB} = 0$。\n2. 如果任何 $n_i = 0$，则概率 $\\widehat{p}_i$ 未定义。\n3. 如果任何 $s_i = 0$，则 $\\widehat{p}_i = 0$，这使得总乘积为零，所以 $\\widehat{k}_{AB} = 0$。\n这些退化情况导致速率常数为零。对于这些情况，问题将不确定度 $\\sigma_{\\widehat{k}}$ 也定义为零。这些条件可以防止在方差计算中出现除以零的情况。\n\n将要实现的算法会首先检查这些退化条件。如果没有满足任何退化条件，它将继续使用上述公式计算 $\\widehat{k}_{AB}$ 和 $\\sigma_{\\widehat{k}}$。两个量的最终数值结果都将四舍五入到六位有效数字。该实现将是一个处理硬编码测试套件的Python脚本。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes interface-based rate constants and their uncertainties for a given test suite,\n    adhering to the principles of Forward Flux Sampling.\n    \"\"\"\n\n    test_cases = [\n        # Case A: General multi-interface case\n        {\"N_flux\": 300, \"T_ps\": 20000, \"interfaces\": [(1000, 300), (900, 270), (800, 160)]},\n        # Case B: Low flux and many interfaces\n        {\"N_flux\": 10, \"T_ps\": 10000, \"interfaces\": [(50, 5), (40, 4), (30, 3), (20, 2)]},\n        # Case C: Nearly absorbing next interface\n        {\"N_flux\": 5000, \"T_ps\": 100000, \"interfaces\": [(100, 99)]},\n        # Case D: Degenerate zero-success edge case\n        {\"N_flux\": 1000, \"T_ps\": 100000, \"interfaces\": [(100, 0), (100, 100)]},\n        # Case E: No interfaces; flux-only estimate\n        {\"N_flux\": 75, \"T_ps\": 5000, \"interfaces\": []},\n    ]\n\n    def round_to_6_sf(x):\n        \"\"\"Rounds a number to 6 significant figures.\"\"\"\n        if x == 0:\n            return 0.0\n        # Format to 5 decimal places in scientific notation, then convert back to float.\n        # This effectively rounds to 6 significant figures.\n        return float(f'{x:.5e}')\n\n    def format_num(n):\n        \"\"\"Formats a number into a string, using standard or scientific notation as appropriate.\"\"\"\n        if n == 0.0:\n            return \"0.0\"\n        # The {:.6g} format specifier rounds to 6 significant digits.\n        return f\"{n:.6g}\"\n\n    case_results = []\n    for case in test_cases:\n        N_flux = case[\"N_flux\"]\n        T_ps = case[\"T_ps\"]\n        interfaces = case[\"interfaces\"]\n\n        # Check for degenerate conditions as per problem statement\n        is_degenerate = (\n            N_flux == 0 or\n            any(n == 0 for n, s in interfaces) or\n            any(s == 0 for n, s in interfaces)\n        )\n\n        if is_degenerate:\n            k_ab_hat = 0.0\n            sigma_k_hat = 0.0\n        else:\n            # Calculate flux\n            phi_hat = N_flux / T_ps\n\n            # Calculate product of probabilities and variance sum\n            p_prod = 1.0\n            var_log_k_sum = 1.0 / N_flux\n\n            for n_i, s_i in interfaces:\n                p_i_hat = s_i / n_i\n                p_prod *= p_i_hat\n                \n                # The condition s_i > 0 is guaranteed by the initial check\n                var_log_k_sum += (1.0 - p_i_hat) / (n_i * p_i_hat)\n\n            # Calculate rate constant\n            k_ab_hat = phi_hat * p_prod\n\n            # Calculate standard deviation\n            sigma_k_hat = k_ab_hat * np.sqrt(var_log_k_sum)\n\n        # Round final results to 6 significant figures\n        k_ab_rounded = round_to_6_sf(k_ab_hat)\n        sigma_k_rounded = round_to_6_sf(sigma_k_hat)\n        \n        # Format for final output string.\n        # Using format_num to get a clean string representation.\n        case_results.append(f\"[{format_num(k_ab_rounded)},{format_num(sigma_k_rounded)}]\")\n\n    # Print the final output in the exact required format\n    print(f\"[{','.join(case_results)}]\")\n\nsolve()\n```", "id": "2826627"}, {"introduction": "除了计算的具体操作，对路径采样方法的深刻理解还需要掌握“归宿几率”（committor）函数 $p_B(\\mathbf{x})$ 的中心作用。本问题探讨了归宿几率函数、过渡路径采样（Transition Path Sampling, TPS）中“打靶”移动的接受率以及前向通量采样速率估计的无偏性之间的理论联系。这将帮助你领会这些强大方法在理论上为何是严谨的。[@problem_id:2826631]", "problem": "一个高维分子系统中的稀有事件反应由过阻尼朗之万动力学在温度$T$和光滑势能$U(\\mathbf{x})$下建模，该系统具有两个不相交的亚稳态盆$A$和$B$。该动力学是可逆的，并相对于玻尔兹曼分布$\\rho_{\\mathrm{eq}}(\\mathbf{x}) \\propto \\exp\\!\\left(-\\beta U(\\mathbf{x})\\right)$满足细致平衡条件，其中$\\beta = 1/(k_{\\mathrm{B}} T)$。归宿几率函数（committor function）$p_B(\\mathbf{x})$定义为从构型$\\mathbf{x}$开始的轨迹在到达盆$A$之前先到达盆$B$的概率。等归宿几率面（isocommittor surface）是对于固定的$p \\in (0,1)$，满足$\\{\\mathbf{x}: p_B(\\mathbf{x}) = p\\}$的构型集合。\n\n考虑使用过渡路径取样（Transition Path Sampling, TPS），特别是双向打靶移动（two-way shooting move），对连接$A$和$B$的反应轨迹进行取样：在当前反应路径上选择一个打靶点$\\mathbf{x}^{\\ast}$，扰动其状态，然后正向积分直到首次到达$A$或$B$，再反向积分直到首次到达$A$或$B$。如果反向片段在到达$B$之前先到达$A$，并且正向片段在到达$A$之前先到达$B$，则接受提议的路径。假设：\n- 扰动不改变构型$\\mathbf{x}^{\\ast}$，但为正向和反向片段独立地重新抽取驱动动力学的随机噪声。\n- 动力学和扰动的选择方式使得路径空间中的细致平衡通过Metropolis接受/拒绝规则得到满足，该规则接受任何提议的反应轨迹并拒绝任何非反应轨迹。\n\n另外，考虑通过前向通量取样（Forward Flux Sampling, FFS）来估计反应速率常数$k_{AB}$。设$\\lambda(\\mathbf{x})$为一个标量进展坐标，定义了界面$\\{\\lambda = \\lambda_0 < \\lambda_1 < \\dots < \\lambda_n\\}$，其中$\\{ \\mathbf{x} \\in A \\} \\subset \\{ \\lambda < \\lambda_0 \\}$且$\\{ \\mathbf{x} \\in B \\} \\subset \\{ \\lambda > \\lambda_n \\}$。FFS估计量将从$A$到第一个界面$\\{\\lambda = \\lambda_0\\}$的首次穿越稳态通量，乘以在不返回$A$的情况下到达连续界面的条件概率的乘积。\n\n选择所有在上述假设下严格正确的陈述。\n\nA. 在正向和反向片段具有独立随机实现的双向打靶中，对于提交值为$p_B(\\mathbf{x}^{\\ast}) = p$的打靶点，其期望接受概率在$p = 0.5$时最大，并且严格高于从$A$深处（$p \\approx 0$）打靶时的概率。\n\nB. 在前向通量取样（FFS）中，只要通过该界面的稳态首次穿越通量和随后的条件概率被一致地计算，将第一个界面放置在任何满足$0 < \\alpha < 1$的等提交面$\\{ p_B(\\mathbf{x}) = \\alpha \\}$上，都能得到$k_{AB}$的无偏估计。\n\nC. 在$p_B(\\mathbf{x}) = 0.5$的等提交面上均匀选择打靶点，并接受任何反应轨迹而不进行进一步的重加权，所产生的轨迹分布与平衡过渡路径系综（Transition Path Ensemble, TPE）完全相同。\n\nD. 对于确定性的哈密顿动力学，在$p_B(\\mathbf{x}) = 0.5$的打靶点上施加对称的、无穷小的动量扰动，双向打靶的接受概率恰好为$0.25$。\n\nE. 对于可逆的过阻尼朗之万动力学，且正向和反向积分的噪声实现是独立的，从一个提交值为$p_B(\\mathbf{x}^{\\ast}) = p$的点进行双向打靶的期望接受概率等于$p (1 - p)$，因此$p = 0.5$的等提交面使接受率最大化。", "solution": "我们从第一性原理出发：提交函数的定义、可逆稳态动力学下的全概率定律，以及双向打靶移动的构造和前向通量取样（FFS）的基本分解。\n\n提交函数的定义和性质。提交函数$p_B(\\mathbf{x})$是条件概率\n$$\np_B(\\mathbf{x}) = \\mathbb{P}\\!\\left( \\tau_B < \\tau_A \\,\\big|\\, \\mathbf{X}_0 = \\mathbf{x} \\right),\n$$\n其中$\\tau_A$和$\\tau_B$是过程$\\mathbf{X}_t$首次到达集合$A$和$B$的时间。对于满足细致平衡的可逆动力学，反向提交函数（在时间上反向积分时，遇到的第一个盆是$A$而不是$B$的概率）等于$1 - p_B(\\mathbf{x})$。对于马尔可夫动力学，在提议构造中使用的正向和反向积分具有独立的噪声实现，因此正向和反向的首次到达事件在给定打靶状态的条件下是独立的。\n\n随机动力学下双向打靶的接受概率。在所述的TPS设置中，当且仅当两个独立事件发生时，提议的路径才被接受：\n- 正向片段在到达$A$之前到达$B$，根据提交函数的定义，其概率为$p_B(\\mathbf{x}^{\\ast})$。\n- 反向片段在到达$B$之前到达$A$，根据可逆性，其概率为$1 - p_B(\\mathbf{x}^{\\ast})$。\n\n由于正向和反向片段的噪声实现是独立的，联合概率可以因式分解，因此对于提交值为$p$的打靶点，其期望接受概率为\n$$\nP_{\\mathrm{acc}}(p) \\;=\\; p \\,[1 - p].\n$$\n该函数在$p = 0.5$时取得最大值，此时$P_{\\mathrm{acc}}(0.5) = 0.25$，并且当$p \\to 0$或$p \\to 1$时，该函数趋近于$0$。因此，从$p = 0.5$的等提交面打靶比从$p \\approx 0$的$A$深处（或$p \\approx 1$的$B$深处）打靶产生显著更高的接受率。\n\n前向通量取样的无偏性。速率常数$k_{AB}$定义为从$A$开始首次到达$B$的稳态频率，可写作\n$$\nk_{AB} \\;=\\; \\Phi_{A \\to \\lambda_0} \\, \\mathbb{P}\\!\\left( \\text{reach } B \\text{ before } A \\,\\big|\\, \\text{first crossed } \\{\\lambda=\\lambda_0\\} \\text{ from } A \\right),\n$$\n其中$\\Phi_{A \\to \\lambda_0}$是从$A$发出并首次穿越界面$\\{\\lambda=\\lambda_0\\}$的稳态通量。根据全概率定律和马尔可夫性质，到达$B$的条件概率可以分解为嵌套界面上的乘积，\n$$\n\\mathbb{P}\\!\\left( \\text{reach } B \\,\\big|\\, \\text{first crossed } \\lambda_0 \\right)\n\\;=\\;\n\\prod_{i=0}^{n-1} \\mathbb{P}\\!\\left( \\text{reach } \\lambda_{i+1} \\text{ before } A \\,\\big|\\, \\text{first crossed } \\lambda_{i} \\text{ from } A \\right),\n$$\n前提是每个条件概率都是相对于源界面上正确的、由稳态通量决定的分布来计算的。这个恒等式对于任何分隔$A$和$B$的界面$\\{\\lambda_i\\}$的选择都成立，包括选择$\\{\\lambda=\\lambda_0\\}$与某个满足$0<\\alpha<1$的等提交面$\\{ p_B(\\mathbf{x}) = \\alpha \\}$重合的情况。因此，当通量和条件概率在稳态下被一致地估计时，FFS估计量是无偏的，与界面的位置无关；移动界面只会影响方差，而不会影响期望值。\n\n过渡路径系综与等提交面上的均匀选择。平衡过渡路径系综（TPE）根据稳态动力学下的路径概率，对反应轨迹上的构型进行加权。对于可逆的过阻尼动力学，穿过分隔面上一个面元$\\mathrm{d}\\sigma$的反应穿越密度涉及反应流，该反应流与$\\rho_{\\mathrm{eq}}(\\mathbf{x})$乘以一个编码局部提交倾向的因子成正比，例如涉及$\\nabla p_B(\\mathbf{x})$和扩散张量的项。因此，沿等提交面的TPE密度通常是不均匀的，并且与反应流$J_{\\mathrm{R}}(\\mathbf{x})$相关。在$\\{p_B=0.5\\}$上均匀选择打靶点，并接受每一个反应提议而不进行额外的重加权，会使得取样分布相对于TPE偏向于代表性不足或过高的区域；通常情况下，这不能复现精确的TPE。\n\n确定性动力学和随机独立性的缺乏。在确定性的哈密顿动力学中，一旦选定一个受扰动的状态$(\\mathbf{x}^{\\ast},\\mathbf{p}^{\\ast})$，正向和反向片段都由运动方程唯一确定（其中反向积分等同于在时间反演动量下的正向积分）。没有独立的随机性可以将接受概率分解为乘积$p\\,[1-p]$。接受率由位于反应管（reactive tubes）上的受扰动状态的测度决定（在动量扰动分布下），即那些反向片段到达$A$且正向片段到达$B$的状态。这个测度通常不等于$p_B(\\mathbf{x}^{\\ast})\\,[1 - p_B(\\mathbf{x}^{\\ast})]$，在$p_B(\\mathbf{x}^{\\ast})=0.5$时也并非恰好为$0.25$，除非在特殊的、非一般性的情况下。因此，断言在确定性的、无穷小扰动极限下接受概率恰好为$0.25$是不正确的。\n\n逐项分析：\n- 选项A：根据在独立正/反向噪声下的推导$P_{\\mathrm{acc}}(p) = p\\,[1-p]$，最大值出现在$p = 0.5$处，而在$A$深处$p \\approx 0$时，$P_{\\mathrm{acc}} \\approx 0$。因此，接受率在提交函数值接近0.5处最大，并严格大于在盆内部的接受率。正确。\n- 选项B：根据FFS将$k_{AB}$分解为首个界面通量和一系列条件界面到界面概率的乘积，该分解在稳态下对任何有效的界面放置都成立，因此在等提交面上选择第一个界面会得到一个无偏估计量。正确。\n- 选项C：沿等提交面的TPE权重通常是不均匀的，并且与反应流成正比，而不是与均匀的表面测度成正比。没有适当重加权的均匀选择不能复现TPE。不正确。\n- 选项D：确定性动力学对于给定的扰动不提供独立的正/反向结果；接受概率通常不是$p\\,[1-p]$，在$p=0.5$时也并非恰好为$0.25$。不正确。\n- 选项E：这重申了在可逆过阻尼朗之万动力学下，且正向和反向片段噪声实现独立时的乘积法则$P_{\\mathrm{acc}}(p) = p\\,[1-p]$。正确。\n\n因此，正确的陈述是A、B和E。", "answer": "$$\\boxed{ABE}$$", "id": "2826631"}, {"introduction": "前向通量采样（FFS）模拟的效率对界面的设置位置高度敏感。这个高级练习将挑战你像算法设计者一样思考，考虑如何自适应地放置界面，以便在固定的计算成本下最小化统计误差。掌握这一概念是从基本实现迈向针对复杂问题进行高效实用FFS应用的关键。[@problem_id:2690120]", "problem": "一个稀有的反应事件 $A \\to B$ 通过一种基于界面的过渡路径方法进行研究，例如 Forward Flux Sampling (FFS) 或 Transition Interface Sampling (TIS)。设 $\\lambda(\\mathbf{x})$ 是一个从势阱 $A$ 到 $B$ 单调递增的序参量，并考虑一系列界面 $A \\equiv \\{\\lambda \\le \\lambda_{0}\\} \\prec \\{\\lambda=\\lambda_{1}\\} \\prec \\cdots \\prec \\{\\lambda=\\lambda_{M}\\} \\equiv \\{\\lambda \\ge \\lambda_{B}\\}$，其中 $\\lambda_{0}<\\lambda_{1}<\\cdots<\\lambda_{M}=\\lambda_{B}$。在每个界面 $\\lambda_{i}$ 处，放出 $N_{i}$ 条试探轨迹，当它们到达 $\\lambda_{i+1}$（成功）或返回到 $A$（失败）时终止，从而得到条件概率 $p_{i}\\equiv P(\\lambda_{i+1}\\mid \\lambda_{i})$ 的一个估计量 $\\hat{p}_{i}$。总穿越概率为 $P_{A\\to B}=\\prod_{i=0}^{M-1}p_{i}$，速率为 $k_{AB}=\\Phi_{A0}\\,P_{A\\to B}$，其中 $\\Phi_{A0}$ 是离开 $A$ 并穿越 $\\lambda_{0}$ 的轨迹的稳态通量。假设一个简单的成本模型，其中每条试探轨迹的成本在各个界面上近似恒定，并且在主导阶上，各界面的估计量是统计独立的，且在每个界面上具有二项涨落。\n\n哪个选项最好地描述了一种科学上合理的自适应算法，该算法用于放置界面，使得 $P(\\lambda_{i+1}\\mid \\lambda_{i})$ 对所有 $i$ 近似恒定，并为在固定总计算预算下估计量方差的预期减少提供了正确的第一性原理的论证？\n\nA. 从 $\\lambda_{0}$ 开始，选择一个目标成功概率 $p^{\\star}\\in(0,1)$（例如，$p^{\\star}\\approx 0.2$）。对于每个 $i$，使用 $K$ 次试验的短引导批次从 $\\lambda_{i}$ 出发，以框定两个候选位置 $\\lambda_{i+1}^{-}$ 和 $\\lambda_{i+1}^{+}$，使得观察到的成功分数跨越 $p^{\\star}$，然后用新的引导试验在 $\\lambda$ 中进行二分查找，直到估计的 $\\hat{p}_{i}\\approx p^{\\star}$ 在一个容差范围内。重复此过程以构建 $\\lambda_{i+1}$，并令 $i\\leftarrow i+1$，直到 $\\lambda_{M}=\\lambda_B$。在正式计算中，将 $N_{i}$ 大致平均分配到各个界面（或者如果每个界面的成本不同，则进行小幅调整）。论证：由于二项方差为 $\\mathrm{Var}(\\hat{p}_{i})=p_{i}(1-p_{i})/N_{i}$ 且各界面独立，delta 方法展开给出相对方差 $\\mathrm{Var}(\\hat{P}_{A\\to B})/P_{A\\to B}^{2}\\approx \\sum_{i}(1-p_{i})/(p_{i}N_{i})$。对于固定的 $\\prod_{i}p_{i}$ 和固定的 $\\{N_{i}\\}$，当所有 $p_{i}$ 都相等时，此和达到最小，因此自适应地强制 $p_{i}\\approx p^{\\star}$ 会在固定总成本下减少方差。\n\nB. 在 $\\lambda$ 中均匀放置界面: $\\lambda_{i}=\\lambda_{0}+i(\\lambda_{B}-\\lambda_{0})/M$。在采样过程中，调整 $N_{i}$ ，使得每个界面都达到相同数量的成功试验 $N_{i} \\hat{p}_{i}$，这会使信息内容均等，从而最小化方差。论证：相等的成功次数意味着对乘积的贡献是平衡的，这是最优的。\n\nC. 首先计算平均力势 $F(\\lambda)$，然后放置界面，使得自由能增量 $\\Delta F_{i}=F(\\lambda_{i+1})-F(\\lambda_{i})$ 相等。这将势垒均匀划分，从而隐式地使 $p_{i}$ 均一，并因为势垒被均匀采样而最小化方差。\n\nD. 使界面非常稀疏，以至于每个 $p_{i}\\ll 1$，然后通过在这些界面上选择非常大的 $N_{i}$ 来补偿。因为每个 $\\mathrm{Var}(\\hat{p}_{i})$ 随后与 $p_{i}/N_{i}$ 成正比，所以增大 $N_{i}$ 比增加更多界面能更有效地减少方差。\n\nE. 动态地估计 committor $q(\\mathbf{x})\\equiv P(B\\ \\text{before}\\ A\\mid \\mathbf{x})$，并在 committor 的分位数 $q_{i}$ 处放置界面，使得 $q_{i+1}-q_{i}$ 是恒定的。因为 committor 在界面之间是线性变化的，所以条件概率 $p_{i}$ 相等，并且无需进一步论证即可最小化方差。", "solution": "该问题要求评估在过渡路径采样方法（如 Forward Flux Sampling (FFS)）中放置界面的不同自适应算法，其目标是在固定的计算成本下，最小化估计速率常数的统计误差。其核心思想是理解界面的放置（它决定了条件概率 $p_i$）和计算量的分配（$N_i$）如何影响总穿越概率 $P_{A\\to B}$ 的估计量的总方差。\n\n首先，让我们建立基本原理。问题陈述，总穿越概率由条件概率的乘积给出：\n$$P_{A\\to B} = \\prod_{i=0}^{M-1} p_i$$\n其中 $p_i = P(\\lambda_{i+1} \\mid \\lambda_i)$ 是从界面 $i$ 开始的轨迹在返回状态 $A$ 之前到达界面 $i+1$ 的概率。该概率的估计量为 $\\hat{P}_{A\\to B} = \\prod_{i=0}^{M-1} \\hat{p}_i$。\n\n分析统计误差的关键是计算该估计量的相对方差, $\\mathrm{Var}(\\hat{P}_{A\\to B}) / P_{A\\to B}^2$。对于小误差，这可以近似为估计量对数的方差。这是 delta 方法的一个标准应用。\n$$ \\frac{\\mathrm{Var}(\\hat{P}_{A\\to B})}{P_{A\\to B}^2} \\approx \\mathrm{Var}(\\ln \\hat{P}_{A\\to B}) = \\mathrm{Var}\\left(\\sum_{i=0}^{M-1} \\ln \\hat{p}_i\\right) $$\n问题陈述，不同界面的估计量 $\\hat{p}_i$ 是统计独立的。因此，和的方差是方差的和：\n$$ \\mathrm{Var}\\left(\\sum_{i=0}^{M-1} \\ln \\hat{p}_i\\right) = \\sum_{i=0}^{M-1} \\mathrm{Var}(\\ln \\hat{p}_i) $$\n对每一项再次使用 delta 方法，我们得到 $\\mathrm{Var}(\\ln \\hat{p}_i) \\approx \\mathrm{Var}(\\hat{p}_i) / p_i^2$。\n问题假设每個界面上 $N_i$ 次试验的成功/失败服从二项涨落。估计量 $\\hat{p}_i$ 是成功试验的比例，因此其方差由二项方差给出：\n$$ \\mathrm{Var}(\\hat{p}_i) = \\frac{p_i(1 - p_i)}{N_i} $$\n结合这些结果，得到总概率估计量的相对方差的表达式：\n$$ \\mathcal{V} \\equiv \\frac{\\mathrm{Var}(\\hat{P}_{A\\to B})}{P_{A\\to B}^2} \\approx \\sum_{i=0}^{M-1} \\frac{\\mathrm{Var}(\\hat{p}_i)}{p_i^2} = \\sum_{i=0}^{M-1} \\frac{p_i(1 - p_i)/N_i}{p_i^2} = \\sum_{i=0}^{M-1} \\frac{1 - p_i}{p_i N_i} $$\n优化问题是在固定总计算成本的约束下最小化此方差 $\\mathcal{V}$。假设每次试验的成本是恒定的，这等同于固定总试验次数, $N_{tot} = \\sum_{i=0}^{M-1} N_i$。界面位置的选择决定了概率集合 $\\{p_i\\}$，该集合受约束 $\\prod_{i=0}^{M-1} p_i = P_{A\\to B}$。\n\n最直接的策略，也是某些选项所隐式建议的策略，是均匀分配计算预算，使得对所有 $i$ 都有 $N_i = N_{tot}/M$。在这种情况下，方差变为：\n$$ \\mathcal{V} \\approx \\frac{M}{N_{tot}} \\sum_{i=0}^{M-1} \\frac{1 - p_i}{p_i} = \\frac{M}{N_{tot}} \\left( \\sum_{i=0}^{M-1} \\frac{1}{p_i} - M \\right) $$\n为了在固定的 $M$ 下最小化此表达式，我们必须最小化和 $\\sum_{i=0}^{M-1} 1/p_i$，约束条件是乘积 $\\prod_{i=0}^{M-1} p_i = P_{A\\to B}$ 为常数。这是一个可以使用拉格朗日乘子法解决的经典优化问题。令 $f(\\{p_i\\}) = \\sum 1/p_i$，约束为 $g(\\{p_i\\}) = \\prod p_i - P_{A\\to B} = 0$。条件 $\\nabla f = \\mu \\nabla g$ 导致 $-\\frac{1}{p_k^2} = \\mu \\frac{\\prod p_i}{p_k}$，这意味着 $1/p_k$ 对所有 $k$ 都是常数。因此，当所有概率都相等时达到最小值：$p_i = p = (P_{A\\to B})^{1/M}$。\n\n因此，在 $N_i$ 相等的假设下，放置界面的最优策略是选择界面使得所有条件概率 $p_i$ 都相等。\n\n现在，我们基于此推导来评估每个选项。\n\n**A. 从 $\\lambda_{0}$ 开始，选择一个目标成功概率 $p^{\\star}\\in(0,1)$（例如，$p^{\\star}\\approx 0.2$）。对于每个 $i$，使用 $K$ 次试验的短引导批次从 $\\lambda_{i}$ 出发，以框定两个候选位置 $\\lambda_{i+1}^{-}$ 和 $\\lambda_{i+1}^{+}$，使得观察到的成功分数跨越 $p^{\\star}$，然后用新的引导试验在 $\\lambda$ 中进行二分查找，直到估计的 $\\hat{p}_{i}\\approx p^{\\star}$ 在一个容差范围内。重复此过程以构建 $\\lambda_{i+1}$，并令 $i\\leftarrow i+1$，直到 $\\lambda_{M}=\\lambda_{B}$。在正式计算中，将 $N_{i}$ 大致平均分配到各个界面（或者如果每个界面的成本不同，则进行小幅调整）。论证：由于二项方差为 $\\mathrm{Var}(\\hat{p}_{i})=p_{i}(1-p_{i})/N_{i}$ 且各界面独立，delta 方法展开给出相对方差 $\\mathrm{Var}(\\hat{P}_{A\\to B})/P_{A\\to B}^{2}\\approx \\sum_{i}(1-p_{i})/(p_{i}N_{i})$。对于固定的 $\\prod_{i}p_{i}$ 和固定的 $\\{N_{i}\\}$，当所有 $p_{i}$ 都相等时，此和达到最小，因此自适应地强制 $p_{i}\\approx p^{\\star}$ 会在固定总成本下减少方差。**\n\n该选项提出了一种自适应算法，直接旨在使所有的 $p_i$ 等于一个目标值 $p^\\star$。所描述的使用引导批次和二分查找的程序是实现这一目标的实用且稳健的方法。其提供的论证恰好是上面推导出的那个：它正确地陈述了相对方差的公式，并断言对于固定的 $\\{N_i\\}$，当所有 $p_i$ 都相等时，最小值便达到。这是一个正确的陈述。因此，所提出的算法及其论证都是合理的。**正确**。\n\n**B. 在 $\\lambda$ 中均匀放置界面: $\\lambda_{i}=\\lambda_{0}+i(\\lambda_{B}-\\lambda_{0})/M$。在采样过程中，调整 $N_{i}$ ，使得每个界面都达到相同数量的成功试验 $N_{i} \\hat{p}_{i}$，这会使信息内容均等，从而最小化方差。论证：相等的成功次数意味着对乘积的贡献是平衡的，这是最优的。**\n\n该选项是有缺陷的。首先，在 $\\lambda$ 中均匀放置界面是一种幼稚的、非自适应的策略，通常会导致高度不均匀的概率 $p_i$。其次，调整 $N_i$ 以使 $N_i p_i$ 恒定的提议不是最优的。对于给定的 $\\{p_i\\}$ 集合，$N_i$ 的最优分配是 $N_i \\propto \\sqrt{(1-p_i)/p_i}$，而不是 $N_i \\propto 1/p_i$。所提供的论证是模糊的（“使信息内容均等”）且不正确。正如思考过程中所示，该策略实际上最大化了与方差相关的项，使其成为次优选择。**不正确**。\n\n**C. 首先计算平均力势 $F(\\lambda)$，然后放置界面，使得自由能增量 $\\Delta F_{i}=F(\\lambda_{i+1})-F(\\lambda_{i})$ 相等。这将势垒均匀划分，从而隐式地使 $p_{i}$ 均一，并因为势垒被均匀采样而最小化方差。**\n\n该策略效率低下且通常不正确。跨越高峰垒计算平均力势(PMF)通常比稀有事件计算本身计算成本更高，违背了 FFS 的目的。更重要的是，假设相等的自由能增量 $\\Delta F_i$ 会导致相等的条件概率 $p_i$ 是一种严重的过度简化。概率 $p_i$ 取决于动力学和自由能面的完整形状，特别是前进到 $\\lambda_{i+1}$ 和返回到状态 $A$ 之间的竞争。其论证含糊其辞且缺乏严谨性。**不正确**。\n\n**D. 使界面非常稀疏，以至于每个 $p_{i}\\ll 1$，然后通过在这些界面上选择非常大的 $N_{i}$ 来补偿。因为每个 $\\mathrm{Var}(\\hat{p}_{i})$ 随后與 $p_{i}/N_{i}$ 成正比，所以增大 $N_{i}$ 比增加更多界面能更有效地减少方差。**\n\n这种方法根本上是错误的。基于界面的方法的全部目的就是将一个单一、非常稀有的事件（概率为 $P_{A\\to B} \\ll 1$）分解为一系列更频繁的事件（概率 $p_i$ 不会过小）。对于一个非常小的 $p_i$，必须运行極大量试验 $N_i \\gg 1/p_i$ 才能观察到几次成功。这会导致灾难性的效率损失。相对方差 $\\mathcal{V} \\approx \\sum_i 1/(p_i N_i)$ 表明，小的 $p_i$ 值在方差方面成本极高。增加更多界面以提高单个 $p_i$ 值，其效率远高于试图通过暴力增加 $N_i$ 来克服小 $p_i$ 的问题。**不正确**。\n\n**E. 动态地估计 committor $q(\\mathbf{x})\\equiv P(B\\ \\text{before}\\ A\\mid \\mathbf{x})$，并在 committor 的分位数 $q_{i}$ 处放置界面，使得 $q_{i+1}-q_{i}$ 是恒定的。因为 committor 在界面之间是线性变化的，所以条件概率 $p_{i}$ 相等，并且无需进一步论证即可最小化方差。**\n\n该选项包含几个理论和实践上的问题。虽然 committor $q(\\mathbf{x})$ 确实是理想的反应坐标，但它通常是未知的。准确地估计它通常与原始的速率计算问题一样困难，这使得该建议成为循环论证。此外，“committor 在界面之间是线性变化的”这一说法是错误的；committor 是系统坐标的一个复杂的非线性函数。最后，即使可以在真实 committor 的水平集上定义界面，這些界面与 FFS 条件概率 $p_i$ 之间的关系也并不像所暗示的那么简单，并且它不自动保证 $p_i$ 相等。该选项没有为最小化方差提供有效的论证。**不正确**。\n\n总之，选项 A 正确地描述了一种用于 FFS 中界面放置的标准、实用的自适应算法，并基于第一性原理的统计分析为其有效性提供了严谨且正确的论证。", "answer": "$$\\boxed{A}$$", "id": "2690120"}]}