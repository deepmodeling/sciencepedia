{"hands_on_practices": [{"introduction": "在分子动力学模拟中，周期性边界条件（PBC）是模拟体相系统的关键技术，但它也给数据分析带来了独特的挑战。由于粒子穿过边界时其坐标会被“折叠”回主模拟盒子中，其记录的位置矢量会发生不连续的跳跃。这个练习旨在阐明如何正确处理这些“折叠”坐标，以计算平均均方位移（$\\langle \\Delta r^2(t)\\rangle$）和速度自相关函数（VACF）等关键物理量，这是实践中一个常见的错误来源 [@problem_id:2825806]。通过辨析几种常见方法的正误，您将掌握确保位移和速度相关物理量计算准确性的核心原则。", "problem": "在边长为 $L$ 的立方盒子中，使用周期性边界条件 (PBC)，对单个扩散溶质进行分子动力学模拟，其轨迹在时间 $t_n = n\\,\\Delta t$ 被保存为两个序列：折叠坐标 $\\{\\mathbf{r}_{\\mathrm{wrap}}(t_n)\\}$（其中每个笛卡尔坐标在每一帧都被对 $L$ 取模到 $[0,L)$ 区间内），以及由积分器产生的瞬时速度 $\\{\\mathbf{v}(t_n)\\}$。你需要计算均方根位移 $\\langle \\Delta r^2(t)\\rangle$ 和速度自相关函数 (VACF)。你的同事就何时必须使用展开坐标以及在只有折叠坐标时如何处理提出了几个论点。\n\n仅使用位移、周期性成像和时间自相关的基本定义，判断下列哪些陈述是正确的。选择所有适用项。\n\nA. 对于 $\\langle \\Delta r^2(t)\\rangle$，只需对 $\\mathbf{r}_{\\mathrm{wrap}}(t)-\\mathbf{r}_{\\mathrm{wrap}}(0)$ 应用一次最小镜像约定即可；这能在所有时间 $t$ 得到真实位移，因此无需显式展开坐标就能得到正确的均方根位移。\n\nB. 在 PBC 条件下计算 $\\langle \\Delta r^2(t)\\rangle$ 时，必须在无限平铺空间中重建连续轨迹，这可以通过显式展开（跟踪整数盒子穿越次数）或通过累积帧间的最小镜像位移来获得净位移；否则，在长时间尺度下结果将出现系统性错误。\n\nC. VACF 可以直接从存储的速度 $\\mathbf{v}(t)$ 计算，无需任何坐标展开，因为镜像操作影响的是存储的位置，而不是求解运动方程的瞬时速度。\n\nD. 如果没有存储速度，仍然可以通过估计 $\\mathbf{v}(t_n)\\approx\\big[\\mathbf{r}_{\\mathrm{wrap}}(t_{n+1})-\\mathbf{r}_{\\mathrm{wrap}}(t_n)\\big]_{\\mathrm{MIC}}/\\Delta t$ 来计算正确的 VACF，而无需展开坐标。其中 $[\\cdot]_{\\mathrm{MIC}}$ 表示在每一步将差值的每个分量映射到 $(-L/2,L/2]$ 区间内；对于足够小的 $\\Delta t$，这等于真实的有限差分速度。\n\nE. 在盒子是立方体的情况下，可以使用朴素有限差分 $\\big(\\mathbf{r}_{\\mathrm{wrap}}(t+\\tau)-\\mathbf{r}_{\\mathrm{wrap}}(t)\\big)/\\tau$ 在长的时间间隔 $\\tau$ 上估计用于 VACF 的速度，而无需任何最小镜像映射；任何由边界穿越引起的误差都会在自相关计算中被平均掉。", "solution": "该问题要求评估关于如何从使用周期性边界条件(PBC)生成的分子动力学轨迹中计算均方根位移 $\\langle \\Delta r^2(t)\\rangle$ 和速度自相关函数 $C_{vv}(t)$ 的几个流程性论断。问题的核心在于区分“折叠”坐标（限制在主模拟盒子内）和“展开”坐标（代表粒子在无限周期性平铺空间中的真实连续路径）。\n\n首先，让我们建立基本定义。\n\n从时间 $\\tau$ 开始，在时间间隔 $t$ 内溶质的真实位移由连接其展开位置的向量给出：\n$$\n\\Delta \\mathbf{r}(t; \\tau) = \\mathbf{r}_{\\mathrm{unwrapped}}(t+\\tau) - \\mathbf{r}_{\\mathrm{unwrapped}}(\\tau)\n$$\n展开位置 $\\mathbf{r}_{\\mathrm{unwrapped}}(t)$ 跟踪连续路径，累积跨越周期性边界的位移。折叠位置 $\\mathbf{r}_{\\mathrm{wrap}}(t)$ 与其关系为 $\\mathbf{r}_{\\mathrm{unwrapped}}(t) = \\mathbf{r}_{\\mathrm{wrap}}(t) + L \\mathbf{n}(t)$，其中 $\\mathbf{n}(t)$ 是一个整数向量，记录了粒子在每个笛卡尔方向上穿越盒子边界的次数。\n\n均方根位移 (MSD) 是这个真实位移模的平方的系综平均：\n$$\n\\langle \\Delta r^2(t)\\rangle = \\left\\langle |\\Delta \\mathbf{r}(t; \\tau)|^2 \\right\\rangle_\\tau = \\left\\langle |\\mathbf{r}_{\\mathrm{unwrapped}}(t+\\tau) - \\mathbf{r}_{\\mathrm{unwrapped}}(\\tau)|^2 \\right\\rangle_\\tau\n$$\n其中平均 $\\langle \\cdot \\rangle_\\tau$ 是对所有可能的时间起点 $\\tau$ 进行的。对于三维空间中的扩散粒子，我们期望在长时间 $t$ 下 $\\langle \\Delta r^2(t)\\rangle \\to 6Dt$，其中 $D$ 是扩散系数。这表明 MSD 必须是一个无界且随时间增长的函数。\n\n速度自相关函数 (VACF) 定义为：\n$$\nC_{vv}(t) = \\langle \\mathbf{v}(\\tau) \\cdot \\mathbf{v}(t+\\tau) \\rangle_\\tau\n$$\n其中 $\\mathbf{v}(t)$ 是粒子在时间 $t$ 的瞬时速度。\n\n对于边长为 $L$ 的立方盒子中的位移向量 $\\Delta\\mathbf{r} = \\mathbf{r}_2 - \\mathbf{r}_1$，最小镜像约定 (MIC) 产生一个新向量 $[\\Delta\\mathbf{r}]_{\\mathrm{MIC}}$，其中每个分量 $\\Delta r_i$ 通过加上或减去 $L$ 的整数倍被映射到区间 $[-L/2, L/2)$ 内。这给出了连接粒子1到粒子2的任意周期性镜像的最短向量。\n\n基于这些定义，我们开始分析每个陈述。\n\n**A. 对于 $\\langle \\Delta r^2(t)\\rangle$，只需对 $\\mathbf{r}_{\\mathrm{wrap}}(t)-\\mathbf{r}_{\\mathrm{wrap}}(0)$ 应用一次最小镜像约定即可；这能在所有时间 $t$ 得到真实位移，因此无需显式展开坐标就能得到正确的均方根位移。**\n\n该陈述声称真实位移 $\\Delta \\mathbf{r}(t; 0)$ 等于 $[\\mathbf{r}_{\\mathrm{wrap}}(t) - \\mathbf{r}_{\\mathrm{wrap}}(0)]_{\\mathrm{MIC}}$。对于一般的时间 $t$ 来说，这是不正确的。通过 MIC 获得的向量的模是有界的；具体来说，其模的平方不能超过 $(L/2)^2 + (L/2)^2 + (L/2)^2 = 3L^2/4$。然而，扩散粒子的真实均方根位移必须随时间线性增长并且是无界的。对于任何足够长的时间 $t$，当粒子在任一方向上扩散的距离可能大于 $L/2$ 时，MIC 位移将不再等于真实位移。由此产生的 MSD 曲线将被系统性地低估，并人为地在一个与 $L^2$ 相关的值上达到平台期，这在物理上是不正确的。此方法仅在非常短的时间内有效。\n结论：**不正确**。\n\n**B. 在 PBC 条件下计算 $\\langle \\Delta r^2(t)\\rangle$ 时，必须在无限平铺空间中重建连续轨迹，这可以通过显式展开（跟踪整数盒子穿越次数）或通过累积帧间的最小镜像位移来获得净位移；否则，在长时间尺度下结果将出现系统性错误。**\n\n该陈述准确地描述了必要的操作流程。要计算真实位移 $\\Delta \\mathbf{r}(t; \\tau)$，必须知道展开坐标。这些坐标可以通过对轨迹进行后处理获得。一个标准算法是迭代地重建展开路径：\n$$\n\\mathbf{r}_{\\mathrm{unwrapped}}(t_{n+1}) = \\mathbf{r}_{\\mathrm{unwrapped}}(t_n) + [\\mathbf{r}_{\\mathrm{wrap}}(t_{n+1}) - \\mathbf{r}_{\\mathrm{wrap}}(t_n)]_{\\mathrm{MIC}}\n$$\n这等同于“累积帧间的最小镜像位移”。只要模拟时间步长 $\\Delta t = t_{n+1}-t_n$ 足够小，使得粒子在单步内的位移在所有维度上都小于 $L/2$，该方法就是正确的。正如在对陈述 A 的分析中所确立的，由于对位移的人为限制，未重建此连续路径会在长时间尺度下导致系统性错误的 MSD。\n结论：**正确**。\n\n**C. VACF 可以直接从存储的速度 $\\mathbf{v}(t)$ 计算，无需任何坐标展开，因为镜像操作影响的是存储的位置，而不是求解运动方程的瞬时速度。**\n\n该陈述是正确的。在标准的 MD 模拟中，粒子受力是根据最小镜像距离计算的。然后，这些力通过积分器（例如 Velocity-Verlet）用于更新速度。位置更新可能导致坐标值超出主盒子 $[0,L)$。然后 PBC 操作将此位置映射回主盒子，例如，$x \\to x \\pmod L$。这是存储坐标中的一个不连续跳跃。然而，代表位置瞬时变化率的速度向量 $\\mathbf{v}(t)$ 不会被此折叠操作修改。一个粒子从盒子的一个面离开，会以完全相同的速度向量从对面重新进入。因此，由模拟程序存储的速度时间序列 $\\{\\mathbf{v}(t_n)\\}$ 代表了粒子的真实、连续的速度，可以直接用于计算 VACF，无需任何“展开”过程。\n结论：**正确**。\n\n**D. 如果没有存储速度，仍然可以通过估计 $\\mathbf{v}(t_n)\\approx\\big[\\mathbf{r}_{\\mathrm{wrap}}(t_{n+1})-\\mathbf{r}_{\\mathrm{wrap}}(t_n)\\big]_{\\mathrm{MIC}}/\\Delta t$ 来计算正确的 VACF，而无需展开坐标。其中 $[\\cdot]_{\\mathrm{MIC}}$ 表示在每一步将差值的每个分量映射到 $(-L/2,L/2]$ 区间内；对于足够小的 $\\Delta t$ 这等于真实的有限差分速度。**\n\n该陈述提出了一种从位置近似计算速度的方法。真实的有限差分速度是 $\\mathbf{v}_{\\mathrm{FD}}(t_n) = (\\mathbf{r}_{\\mathrm{unwrapped}}(t_{n+1}) - \\mathbf{r}_{\\mathrm{unwrapped}}(t_n)) / \\Delta t$。表达式 $[\\mathbf{r}_{\\mathrm{wrap}}(t_{n+1})-\\mathbf{r}_{\\mathrm{wrap}}(t_n)]_{\\mathrm{MIC}}$ 给出了连接两个连续帧之间折叠位置的最短向量。“对于足够小的 $\\Delta t$” 意味着在一个时间步长内的真实位移在任何维度上都小于 $L/2$。在这个标准条件下，真实位移向量与最小镜像位移向量相同：\n$$\n\\mathbf{r}_{\\mathrm{unwrapped}}(t_{n+1}) - \\mathbf{r}_{\\mathrm{unwrapped}}(t_n) = [\\mathbf{r}_{\\mathrm{wrap}}(t_{n+1}) - \\mathbf{r}_{\\mathrm{wrap}}(t_n)]_{\\mathrm{MIC}}\n$$\n因此，除以 $\\Delta t$ 会得到对真实瞬时速度的正确有限差分近似。从这个估算的速度序列计算出的 VACF 将是正确的。此过程通过使用局部的、帧间的信息，正确地避免了完全展开轨迹的需要。\n结论：**正确**。\n\n**E. 在盒子是立方体的情况下，可以使用朴素有限差分 $\\big(\\mathbf{r}_{\\mathrm{wrap}}(t+\\tau)-\\mathbf{r}_{\\mathrm{wrap}}(t)\\big)/\\tau$ 在长的时间间隔 $\\tau$ 上估计用于 VACF 的速度，而无需任何最小镜像映射；任何由边界穿越引起的误差都会在自相关计算中被平均掉。**\n\n该陈述在多个方面都根本不正确。首先，使用折叠位置的朴素差值 $\\mathbf{r}_{\\mathrm{wrap}}(t+\\tau)-\\mathbf{r}_{\\mathrm{wrap}}(t)$ 是不正确的。当粒子穿越边界时，其折叠坐标会发生约 $\\pm L$ 的不连续变化。因此，朴素差值会产生一个非常大的、虚假的位移分量（例如，$x_2 \\approx 0, x_1 \\approx L \\implies x_2-x_1 \\approx -L$），这与真实速度无关。声称这些巨大的系统性误差会“被平均掉”没有任何物理或数学依据；它们会引入严重的假象并产生毫无意义的 VACF。其次，估算瞬时速度需要一个非常短的时间差，理想情况下是 $\\tau = \\Delta t \\to 0$。使用“长的时间间隔 $\\tau$”计算的是该间隔内的平均速度，而不是 VACF 所需的瞬时速度。由此得到的相关函数不会是 VACF。\n结论：**不正确**。", "answer": "$$\\boxed{BCD}$$", "id": "2825806"}, {"introduction": "在确保了单个粒子运动轨迹的正确处理之后，我们必须考虑另一个可能影响模拟结果的系统性伪影：质心（COM）漂移。由于数值积分误差或某些恒温器的非动量守恒特性，整个模拟体系可能会出现一个缓慢但非零的总动量，导致整个系统产生非物理性的集体漂移。这个练习将指导您完成从轨迹数据中移除此伪影的正确步骤，确保您计算的相关函数和输运系数反映的是真实的微观热涨落，而不是整个模拟盒子的漂移 [@problem_id:2825787]。", "problem": "在温度 $T$ 下，对一个采用周期性边界条件的均匀流体进行分子动力学（MD）模拟，该体系包含 $N$ 个粒子（质量为 $m_i$，电荷为 $q_i$），置于一个体积为 $V$ 的立方盒子中。您希望通过 Green-Kubo 形式计算用于输运系数的时间相关函数，例如速度自相关函数和流自相关函数。由于有限精度的积分以及与恒温器的弱耦合，轨迹显示出缓慢变化但非零的总线性动量，即存在瞬时质心（COM）速度 $v_{\\mathrm{CM}}(t) = P_{\\mathrm{tot}}(t)/M$（其中 $M=\\sum_{i=1}^{N} m_i$），这会在周期性边界条件下引起整个模拟单元的漂移。\n\n请选择一种程序，当在计算任何基于速度或流的相关函数之前将其应用于存储的轨迹时，该程序能移除质心运动和任何净动量，以防止相关函数中出现虚假的长时尾迹和偏移，同时保留与输运相关的、具有物理意义的涨落：\n\nA. 对于每个保存的时间点 $t_n$，计算瞬时质心速度 $v_{\\mathrm{CM}}(t_n) = \\left(\\sum_{i=1}^{N} m_i v_i(t_n)\\right) / M$，并在构建任何类速度或类流的可观测量之前，将所有粒子速度替换为独异速度 $w_i(t_n) = v_i(t_n) - v_{\\mathrm{CM}}(t_n)$；对于任何基于位移的估计量，也通过使用 $\\Delta r_i'(t) = \\left[r_i(t)-r_i(0)\\right] - \\left[R_{\\mathrm{CM}}(t)-R_{\\mathrm{CM}}(0)\\right]$（其中 $R_{\\mathrm{CM}}(t) = \\left(\\sum_{i=1}^{N} m_i r_i(t)\\right)/M$）来移除质心位移。\n\nB. 在 $t=0$ 时，一次性地重标定所有速度以使 $\\sum_{i=1}^{N} m_i v_i(0)=0$，然后在此后使用原始保存的速度 $v_i(t)$ 计算相关函数；不改变位移。\n\nC. 使用未修改的速度和流计算相关函数，然后对相关函数应用一个时域窗（例如，一个 Hann 窗）来抑制长时尾迹。\n\nD. 在周期性边界条件下解开（unwrap）粒子位置，并通过这些解开位置的有限差分来估计速度；保持净动量不变，但仅对带电物质使用 $w_i(t) = v_i(t) - v_{\\mathrm{CM}}(t)$ 来计算电荷流。\n\nE. 在持续时间为 $T_{\\mathrm{traj}}$ 的整个轨迹上估计时间平均的质心速度 $\\bar{v}_{\\mathrm{CM}} = \\left(1/T_{\\mathrm{traj}}\\right)\\int_{0}^{T_{\\mathrm{traj}}} v_{\\mathrm{CM}}(t)\\,dt$，并将这个恒定的漂移从所有粒子速度中一次性减去以获得 $v_i'(t) = v_i(t) - \\bar{v}_{\\mathrm{CM}}$；保持位移不变。", "solution": "该问题要求确定正确的程序，以便在计算输运系数的时间相关函数之前，从分子动力学（MD）轨迹中移除由虚假的、缓慢变化的质心（COM）运动所产生的伪影。在一个均匀流体的周期性边界条件模拟中，非零的总动量 $P_{\\mathrm{tot}}(t)$ 及由此产生的非零质心速度 $v_{\\mathrm{CM}}(t) = P_{\\mathrm{tot}}(t)/M$ 的存在，是一种非物理的伪影，因为这样的系统平均而言应没有净流动。这种伪影源于数值积分误差和动量不守恒的恒温器。\n\n为了推导出正确的程序，我们必须分析这种质心运动如何影响 Green-Kubo 和 Einstein 关系式中使用的物理量。粒子 $i$ 的瞬时速度 $v_i(t)$ 可以分解为其相对于质心的独异速度 $w_i(t)$ 和质心本身的速度 $v_{\\mathrm{CM}}(t)$:\n$$v_i(t) = w_i(t) + v_{\\mathrm{CM}}(t)$$\n根据定义，独异速度在任何时候都满足 $\\sum_{i=1}^{N} m_i w_i(t) = 0$。均匀流体中的物理输运性质源于粒子之间相对的热涨落，这些涨落由独异速度 $w_i(t)$ 描述。质心速度 $v_{\\mathrm{CM}}(t)$ 代表了整个系统的集体性、非热的漂移，必须被移除。\n\n考虑一个一般的速度自相关函数 $\\langle A(0) \\cdot A(t) \\rangle$，其中 $A$ 是一个基于速度的可观测量。使用原始速度 $v_i(t)$ 意味着我们计算的是：\n$$\\langle (A_w(0) + A_{\\mathrm{CM}}(0)) \\cdot (A_w(t) + A_{\\mathrm{CM}}(t)) \\rangle = \\langle A_w(0) \\cdot A_w(t) \\rangle + \\langle A_{\\mathrm{CM}}(0) \\cdot A_{\\mathrm{CM}}(t) \\rangle + \\text{交叉项}$$\n其中 $A_w$ 是由独异速度计算的可观测量，而 $A_{\\mathrm{CM}}$ 是由质心运动引起的分量。假设随机热运动与集体质心运动不相关，交叉项的平均值为零。计算出的相关函数是真实物理相关函数 $\\langle A_w(0) \\cdot A_w(t) \\rangle$ 与一个虚假伪影项 $\\langle A_{\\mathrm{CM}}(0) \\cdot A_{\\mathrm{CM}}(t) \\rangle$ 的和。由于 $v_{\\mathrm{CM}}(t)$ 被描述为“缓慢变化的”，其自相关是长寿命的，这会给总相关函数引入一个非物理的长时尾迹或偏移。当进行积分时，这将导致一个不正确的、通常被高估的输运系数。\n\n正确的方法是使用独异速度 $w_i(t)$ 来计算所有依赖于速度的可观测量。由于问题陈述 $v_{\\mathrm{CM}}(t)$ 是“缓慢变化的”而非恒定的，因此必须在轨迹的每个保存时间步 $t_n$ 上执行减法操作：\n$$w_i(t_n) = v_i(t_n) - v_{\\mathrm{CM}}(t_n) = v_i(t_n) - \\frac{\\sum_{j=1}^{N} m_j v_j(t_n)}{M}$$\n这个程序保证了在分析中使用的每一帧，系统的总动量都为零。\n\n类似的逻辑也适用于基于位移的估计量，例如在爱因斯坦扩散关系式中使用的均方位移（MSD）。粒子位移 $\\Delta r_i(t) = r_i(t) - r_i(0)$ 也包含来自质心位移 $\\Delta R_{\\mathrm{CM}}(t) = R_{\\mathrm{CM}}(t) - R_{\\mathrm{CM}}(0)$ 的贡献。用原始位置计算的 MSD 会被质心的均方位移 $\\langle |\\Delta R_{\\mathrm{CM}}(t)|^2 \\rangle$ 所污染。对于一个漂移的系统，这一项通常按 $t^2$（弹道运动）增长，这将淹没物理上相关的扩散（$t^1$）行为。因此，质心位移也必须被减去：\n$$\\Delta r_i'(t) = \\Delta r_i(t) - \\Delta R_{\\mathrm{CM}}(t) = [r_i(t) - r_i(0)] - [R_{\\mathrm{CM}}(t) - R_{\\mathrm{CM}}(0)]$$\n\n这就构成了一个完整且正确的程序。我们现在根据这个推导来评估给出的选项。\n\n**A. 对于每个保存的时间点 $t_n$，计算瞬时质心速度 $v_{\\mathrm{CM}}(t_n) = \\left(\\sum_{i=1}^{N} m_i v_i(t_n)\\right) / M$，并在构建任何类速度或类流的可观测量之前，将所有粒子速度替换为独异速度 $w_i(t_n) = v_i(t_n) - v_{\\mathrm{CM}}(t_n)$；对于任何基于位移的估计量，也通过使用 $\\Delta r_i'(t) = \\left[r_i(t)-r_i(0)\\right] - \\left[R_{\\mathrm{CM}}(t)-R_{\\mathrm{CM}}(0)\\right]$（其中 $R_{\\mathrm{CM}}(t) = \\left(\\sum_{i=1}^{N} m_i r_i(t)\\right)/M$）来移除质心位移。**\n该选项精确地描述了从第一性原理推导出的程序。它在每个时间步正确地减去*瞬时*质心速度以获得用于 Green-Kubo 计算的独异速度。它也正确地减去质心位移以用于爱因斯坦类型的关系式。这个方法稳健地移除了质心漂移的伪影。\n结论：**正确**。\n\n**B. 在 $t=0$ 时，一次性地重标定所有速度以使 $\\sum_{i=1}^{N} m_i v_i(0)=0$，然后在此后使用原始保存的速度 $v_i(t)$ 计算相关函数；不改变位移。**\n这个操作是不够的。虽然它在 $t=0$ 时将动量归零，但问题陈述了动量会随时间漂移。对于 $t > 0$，动量将再次变为非零，伪影将持续存在于相关函数中。这个程序未能解决整个轨迹中问题的根本原因。\n结论：**不正确**。\n\n**C. 使用未修改的速度和流计算相关函数，然后对相关函数应用一个时域窗（例如，一个 Hann 窗）来抑制长时尾迹。**\n这是一种临时的修复方法。长时尾迹是一个系统误差，而不是随机噪声。应用一个任意的窗函数会修改相关函数，并且得到的输运系数将依赖于窗函数的选择和参数。这种方法掩盖了物理信息，并没有从根本上纠正数据。这不是一种处理这种特定伪影的科学严谨的方法。\n结论：**不正确**。\n\n**D. 在周期性边界条件下解开（unwrap）粒子位置，并通过这些解开位置的有限差分来估计速度；保持净动量不变，但仅对带电物质使用 $w_i(t) = v_i(t) - v_{\\mathrm{CM}}(t)$ 来计算电荷流。**\n这个程序在多个方面都存在缺陷。首先，它不一致地应用了校正——质心漂移影响所有粒子，而不仅仅是带电粒子，因此污染了所有基于速度的相关函数。其次，对于某些计算保留净动量，而对于另一些计算移除它，在物理上是不自洽的。这种伪影是全局性的，必须全局性地移除。\n结论：**不正确**。\n\n**E. 在持续时间为 $T_{\\mathrm{traj}}$ 的整个轨迹上估计时间平均的质心速度 $\\bar{v}_{\\mathrm{CM}} = \\left(1/T_{\\mathrm{traj}}\\right)\\int_{0}^{T_{\\mathrm{traj}}} v_{\\mathrm{CM}}(t)\\,dt$，并将这个恒定的漂移从所有粒子速度中一次性减去以获得 $v_i'(t) = v_i(t) - \\bar{v}_{\\mathrm{CM}}$；保持位移不变。**\n这是一种近似，只有当 $v_{\\mathrm{CM}}(t)$ 是完全恒定时才有效，但这与问题陈述中它是“缓慢变化的”相矛盾。只减去平均速度 $\\bar{v}_{\\mathrm{CM}}$，未能移除质心速度随时间变化的涨落 $\\delta v_{\\mathrm{CM}}(t) = v_{\\mathrm{CM}}(t) - \\bar{v}_{\\mathrm{CM}}$。由这些涨落的自相关 $\\langle \\delta v_{\\mathrm{CM}}(0) \\cdot \\delta v_{\\mathrm{CM}}(t) \\rangle$ 引起的伪影项将会保留下来。正确的程序是移除完整的瞬时质心速度。\n结论：**不正确**。", "answer": "$$\\boxed{A}$$", "id": "2825787"}, {"introduction": "当数据经过正确处理以消除伪影后，下一个挑战便是计算的可行性。分子动力学模拟通常会产生包含数百万个时间步的海量数据，直接计算时间相关函数可能是一个计算成本极高的任务。本练习将探讨这个问题的算法核心，对比两种主要方法：直观但缓慢的直接求和法（其复杂度为 $O(N^2)$）与基于快速傅里叶变换（FFT）的、效率高得多的方法（其复杂度为 $O(N \\log N)$）[@problem_id:2825820]。通过对这两种策略的计算成本进行量化分析，您将深刻理解FFT在现代科学计算中为何是不可或缺的工具。", "problem": "从分子动力学 (MD) 轨迹中，以 $\\Delta t = 2$ fs 的时间间隔对一个实值、零均值的可观测量 $A(t)$ 进行均匀采样，总共获得 $N = 10^{6}$ 个样本。目标是计算离散线性时间自相关函数，最大延迟时间为 $T_{\\max} = 5 \\tau_{c}$，其中相关时间为 $\\tau_{c} = 1$ ps。定义离散时间序列为 $A_{n} = A(n \\Delta t)$，其中 $n = 0, 1, \\dots, N-1$，自相关的无偏线性估计量（延迟为 $k$）定义为\n$$\nC(k) = \\frac{1}{N-k} \\sum_{n=0}^{N-k-1} A_{n} A_{n+k}, \\quad 0 \\le k \\le K,\n$$\n其中 $K$ 是满足 $K \\Delta t \\le T_{\\max}$ 的最大整数。您将比较两种计算策略：\n\n- 一种直接求和法，该方法对所有 $k = 0, 1, \\dots, K$ 计算上述定义。\n- 一种基于快速傅里叶变换 (FFT) 的方法，该方法使用离散傅里叶变换 (DFT) 计算循环相关，并通过补零使其在延迟 $K$ 以内与线性相关等效。\n\n仅从线性相关和循环卷积的定义以及以下经过充分检验的复杂度模型出发，推导并计算基于FFT的方法相对于直接法的计算加速比，并说明在您选择的补零方案下，两种方法对于所有延迟 $k \\le K$ 是否在数值上（在舍入误差范围内）等效：\n\n- 长度为 $M$ 的复数FFT大约需要 $5 M \\log_{2} M$ 次实数浮点运算 (flops)。\n- 基于FFT的相关计算需要对补零后的实数序列进行一次正向FFT（在本估计中，其成本按相同长度的复数FFT计算），一次在频域中逐元素求模平方的运算（成本为 $3 M$ flops），以及一次与正向FFT成本相同的逆向FFT。\n- 直接法对每个延迟 $k$ 需要 $(N-k)$ 次乘加运算；每个项计为一次乘法和一次加法，即两个flops。忽略归一化成本和任何去均值开销。\n\n任务：\n\n1) 从线性相关作为线性卷积的定义出发，确定最小补零长度 $M_{\\min}$，使得通过FFT计算的循环相关对于所有 $0 \\le k \\le K$ 都等于线性相关。然后将实际补零长度设置为 $N_{p} = 2^{\\lceil \\log_{2} M_{\\min} \\rceil}$。\n\n2) 使用给定的flops计数模型，推导总flops数 $F_{\\text{dir}}$ 和 $F_{\\text{fft}}$ 的封闭形式表达式，并使用给定的 $N$、$\\Delta t$ 和 $\\tau_{c}$ 对其进行数值计算，然后计算加速比\n$$\nS = \\frac{F_{\\text{dir}}}{F_{\\text{fft}}}.\n$$\n\n3) 简要论证（无需计算）在您选择的补零方案下，除了浮点舍入误差外，基于FFT的方法和直接法是否对所有 $k \\le K$ 产生相同的线性相关结果。\n\n报告单个数值 $S$，四舍五入到三位有效数字。加速比是无量纲的，不报告单位。", "solution": "该问题要求对计算离散时间自相关函数的两种方法进行分析和比较：直接求和法和基于快速傅里叶变换 (FFT) 的方法。该问题陈述的有效性得到确认，因为它在科学上基于信号处理和统计力学的原理，问题设定良好并提供了所有必要数据，且以客观、正式的语言表述。我们继续进行解答。\n\n首先，我们根据给定数据确定必要的参数。\n样本数量为 $N = 10^{6}$。\n采样间隔为 $\\Delta t = 2$ fs。\n相关时间为 $\\tau_{c} = 1$ ps，相当于 $1000$ fs。\n最大延迟时间为 $T_{\\max} = 5 \\tau_{c} = 5 \\times 1 \\text{ ps} = 5$ ps，或 $5000$ fs。\n最大延迟指数 $K$ 是满足 $K \\Delta t \\le T_{\\max}$ 的最大整数。\n$$\nK = \\left\\lfloor \\frac{T_{\\max}}{\\Delta t} \\right\\rfloor = \\left\\lfloor \\frac{5000 \\text{ fs}}{2 \\text{ fs}} \\right\\rfloor = 2500\n$$\n需要在延迟 $k = 0, 1, \\dots, K$ 的范围内计算自相关。\n\n第一个任务是确定基于FFT方法所需的适当补零长度。维纳-辛钦定理 (Wiener-Khinchin theorem) 允许通过傅里叶变换计算自相关函数。具体而言，序列的自相关可以通过对其功率谱密度进行傅里叶逆变换得到。为了使用具有内在循环性的离散傅里叶变换 (DFT) 计算线性相关，必须将序列补零到足够长的长度，以防止环绕（混叠）误差。\n\n设原始序列为 $A_n$，长度为 $N$。我们通过对 $A_n$ 补零来创建一个长度为 $M$ 的新序列 $A'_{n}$：当 $0 \\le n < N$ 时，$A'_{n} = A_n$；当 $N \\le n < M$ 时，$A'_{n} = 0$。$A'_{n}$ 在延迟 $k$ 处的循环自相关由下式给出：\n$$\nC'_{\\text{circ}}(k) = \\sum_{n=0}^{M-1} A'_{n} A'_{(n+k) \\pmod{M}}\n$$\n我们需要 $C'_{\\text{circ}}(k)$ 对于所有延迟 $0 \\le k \\le K$ 都等于未归一化的线性相关 $\\sum_{n=0}^{N-k-1} A_n A_{n+k}$。\n展开循环相关的表达式得到两部分：\n$$\nC'_{\\text{circ}}(k) = \\sum_{n=0}^{M-k-1} A'_{n} A'_{n+k} + \\sum_{n=M-k}^{M-1} A'_{n} A'_{n+k-M}\n$$\n第一个求和项 $\\sum_{n=0}^{M-k-1} A'_{n} A'_{n+k}$ 等于我们期望的未归一化线性相关和，因为 $A'_{n}$ 仅在 $n < N$ 时非零，所以乘积 $A'_{n} A'_{n+k}$ 仅在 $n<N$ 和 $n+k<N$ 同时成立时非零。这正确地将求和截断在 $n=N-k-1$ 处。\n第二个求和项是环绕项，为了使循环相关与线性相关匹配，该项必须为零。为使该项对所有 $0 \\le k \\le K$ 都为零，每个乘积 $A'_{n} A'_{n+k-M}$ 中至少有一个因子必须为零。此和中的索引 $n$ 的范围是从 $M-k$ 到 $M-1$。如果索引 $n$ 大于或等于 $N$，则 $A'_{n}$ 为零。因此，如果我们确保对于所有相关的 $k$，和中的最小索引 $M-k$ 大于或等于 $N$，环绕项就会消失。最严格的要求出现在最大延迟 $k=K$ 时。因此，我们必须有 $M - K \\ge N$，即 $M \\ge N+K$。\n\n这个条件为等价性在所有延迟直至 $K$ 均成立设定了最小补零长度 $M_{\\min}$。\n$$\nM_{\\min} = N+K = 10^{6} + 2500 = 1002500\n$$\n问题规定，为了FFT的效率，实际的补零长度 $N_p$ 必须是下一个更高的2的幂。\n$$\nN_p = 2^{\\lceil \\log_{2}(M_{\\min}) \\rceil} = 2^{\\lceil \\log_{2}(1002500) \\rceil}\n$$\n我们计算 $\\log_{2}(1002500) \\approx 19.936$。其向上取整为 $\\lceil 19.936 \\rceil = 20$。\n$$\nN_p = 2^{20} = 1048576\n$$\n\n第二个任务是推导总浮点运算 (flop) 次数并计算加速比。\n对于直接求和法，单个延迟 $k$ 的flop计数为 $2(N-k)$，计及求和中每项的一次乘法和一次加法。总flop计数 $F_{\\text{dir}}$ 是从 $k=0$ 到 $k=K$ 的所有所需延迟的flop数之和。\n$$\nF_{\\text{dir}} = \\sum_{k=0}^{K} 2(N-k) = 2 \\left( \\sum_{k=0}^{K} N - \\sum_{k=0}^{K} k \\right)\n$$\n使用常数求和与前 $K$ 个整数求和的公式：\n$$\nF_{\\text{dir}} = 2 \\left( N(K+1) - \\frac{K(K+1)}{2} \\right) = (K+1)(2N-K)\n$$\n代入数值 $N=10^6$ 和 $K=2500$：\n$$\nF_{\\text{dir}} = (2500+1)(2 \\times 10^{6} - 2500) = 2501 \\times (2000000 - 2500) = 2501 \\times 1997500 = 4995747500\n$$\n对于基于FFT的方法，flop计数基于对长度为 $N_p$ 的序列进行的操作。该过程包括一次正向FFT、一次逐元素求模平方运算和一次逆向FFT。\n长度为 $N_p$ 的正向复数FFT的成本给定为 $5 N_p \\log_{2} N_p$。逆向FFT具有相同的成本。问题指出实数到复数的变换也使用此成本。逐元素求模平方运算的成本为 $3 N_p$ flops。\nFFT方法的总flop计数 $F_{\\text{fft}}$为：\n$$\nF_{\\text{fft}} = (5 N_p \\log_{2} N_p) + 3 N_p + (5 N_p \\log_{2} N_p) = 10 N_p \\log_{2} N_p + 3 N_p = N_p (10 \\log_{2} N_p + 3)\n$$\n代入 $N_p=2^{20}$，这意味着 $\\log_{2} N_p = 20$：\n$$\nF_{\\text{fft}} = 2^{20} (10 \\times 20 + 3) = 1048576 \\times (200 + 3) = 1048576 \\times 203 = 212860928\n$$\n加速比 $S$ 是两个flop计数的比值。\n$$\nS = \\frac{F_{\\text{dir}}}{F_{\\text{fft}}} = \\frac{4995747500}{212860928} \\approx 23.47163\n$$\n四舍五入到三位有效数字，加速比为 $S \\approx 23.5$。\n\n第三个任务是论证两种方法的数值等效性。直接求和法被定义为计算无偏线性估计量 $C(k) = \\frac{1}{N-k} \\sum_{n=0}^{N-k-1} A_{n} A_{n+k}$。FFT方法计算一个补零序列的循环相关。如第一部分所述，我们选择的补零长度 $N_p \\ge N+K$ 确保了对于所有延迟 $0 \\le k \\le K$，循环相关的原始结果（在任何归一化之前）在数学上与未归一化的线性相关和 $\\sum_{n=0}^{N-k-1} A_n A_{n+k}$ 完全相同。因此，如果FFT方法对每个延迟 $k$ 的结果随后也像直接法一样乘以相同的因子 $1/(N-k)$ 进行归一化，那么两种方法将产生相同的最终值。任何差异将仅源于两种算法不同的浮点舍入误差累积路径。因此，在指定的补零和假设后续使用相同归一化的情况下，这两种方法在机器精度范围内是数值等效的。", "answer": "$$\\boxed{23.5}$$", "id": "2825820"}]}