{"hands_on_practices": [{"introduction": "这项练习通过回归第一性原理来巩固我们对系综平均的理解。我们将为一个由谐振子组成的系统推导其系综平均的解析表达式，这是统计力学中的一个基石模型。[@problem_id:2772366] 该实践将加深我们对哈密顿量、正则概率分布以及最终宏观平均值之间联系的认识，特别是展示了可分离性带来的强大简化能力。", "problem": "考虑一个逆温度为 $\\beta$ 的经典正则系综，其相空间点为 $\\Gamma=(q,p)$，其中 $q=(q_{1},\\dots,q_{N})$ 和 $p=(p_{1},\\dots,p_{N})$ 分别是 $N$ 个独立一维谐振子的坐标和动量，这些谐振子的质量为 $\\{m_{i}\\}_{i=1}^{N}$，角频率为 $\\{\\omega_{i}\\}_{i=1}^{N}$。其哈密顿量为 $H(\\Gamma)=\\sum_{i=1}^{N}\\left[\\frac{p_{i}^{2}}{2m_{i}}+\\frac{1}{2}m_{i}\\omega_{i}^{2}q_{i}^{2}\\right]$。正则相空间密度为 $\\rho(\\Gamma)=Z^{-1}\\exp(-\\beta H(\\Gamma))$，其中配分函数 $Z$ 定义为 $Z=\\int \\mathrm{d}\\Gamma\\,\\exp(-\\beta H(\\Gamma))$ 且 $\\mathrm{d}\\Gamma=\\prod_{i=1}^{N}\\mathrm{d}q_{i}\\,\\mathrm{d}p_{i}$。一个我们感兴趣的可观测量是可分离的，形式为 $A(q,p)=A_{q}(q)+A_{p}(p)$，其中 $A_{q}$ 仅依赖于 $q$，$A_{p}$ 仅依赖于 $p$。请仅从上述定义出发，推导 $A$ 的正则系综平均值，其形式应能明确展示坐标和动量贡献的分解，并产生归一化的位形空间和动量空间概率密度。请将您的最终结果以单个闭合形式的解析表达式给出，其中包含 $\\beta$, $\\{m_{i}\\}$, $\\{\\omega_{i}\\}$, $A_{q}$ 和 $A_{p}$，所有高斯归一化常数都需明确写出，并且所有积分的积分域都写作 $\\mathbb{R}^{N}$。不要对 $A_{q}$ 或 $A_{p}$ 的形式做任何特定假设。你的最终答案必须是单个表达式（而非多个方程），且不得包含单位。如果引入任何数值常数，请以标准数学形式书写。", "solution": "该问题陈述具有科学依据、问题良定、客观且内容自洽。它提出了一个经典统计力学中的标准问题。因此，该问题是有效的，我将着手解答。\n\n可观测量 $A$ 的正则系综平均定义为\n$$\n\\langle A \\rangle = \\frac{\\int A(\\Gamma) \\exp(-\\beta H(\\Gamma)) \\mathrm{d}\\Gamma}{\\int \\exp(-\\beta H(\\Gamma)) \\mathrm{d}\\Gamma}\n$$\n分母是配分函数 $Z = \\int \\exp(-\\beta H(\\Gamma)) \\mathrm{d}\\Gamma$。相空间点为 $\\Gamma = (q,p)$，其中 $q=(q_{1},\\dots,q_{N})$ 且 $p=(p_{1},\\dots,p_{N})$。积分测度为 $\\mathrm{d}\\Gamma = \\prod_{i=1}^{N}\\mathrm{d}q_{i}\\,\\mathrm{d}p_{i}$，我们可以将其写作 $\\mathrm{d}q\\,\\mathrm{d}p$。\n\n哈密顿量为 $H(\\Gamma) = \\sum_{i=1}^{N}\\left[\\frac{p_{i}^{2}}{2m_{i}}+\\frac{1}{2}m_{i}\\omega_{i}^{2}q_{i}^{2}\\right]$。它可以分离为一个依赖于动量的部分 $H_p(p) = \\sum_{i=1}^{N}\\frac{p_{i}^{2}}{2m_{i}}$ 和一个依赖于坐标的部分 $H_q(q) = \\sum_{i=1}^{N}\\frac{1}{2}m_{i}\\omega_{i}^{2}q_{i}^{2}$ 的和。因此，$H(\\Gamma) = H_p(p) + H_q(q)$。\n\n我们感兴趣的可观测量也是可分离的：$A(q,p) = A_{q}(q) + A_{p}(p)$。\n\n首先，我们分析配分函数 $Z$。由于哈密顿量和积分测度的可分离性，$Z$ 可以分解为：\n$$\nZ = \\int \\exp(-\\beta(H_q(q) + H_p(p)))\\,\\mathrm{d}q\\,\\mathrm{d}p = \\left(\\int \\exp(-\\beta H_q(q))\\,\\mathrm{d}q\\right) \\left(\\int \\exp(-\\beta H_p(p))\\,\\mathrm{d}p\\right) = Z_q Z_p\n$$\n其中 $Z_q = \\int_{\\mathbb{R}^N} \\exp(-\\beta H_q(q))\\,\\mathrm{d}q$ 且 $Z_p = \\int_{\\mathbb{R}^N} \\exp(-\\beta H_p(p))\\,\\mathrm{d}p$。\n\n接下来，我们计算 $\\langle A \\rangle$ 表达式的分子：\n$$\n\\text{分子} = \\int (A_{q}(q) + A_{p}(p)) \\exp(-\\beta(H_q(q) + H_p(p)))\\,\\mathrm{d}q\\,\\mathrm{d}p\n$$\n该积分可以分裂成两项：\n$$\n\\text{分子} = \\int A_{q}(q) \\exp(-\\beta H_q(q)) \\exp(-\\beta H_p(p))\\,\\mathrm{d}q\\,\\mathrm{d}p + \\int A_{p}(p) \\exp(-\\beta H_q(q)) \\exp(-\\beta H_p(p))\\,\\mathrm{d}q\\,\\mathrm{d}p\n$$\n每一项关于 $q$ 和 $p$ 的积分也可以分解：\n$$\n\\text{分子} = \\left(\\int_{\\mathbb{R}^N} A_{q}(q) \\exp(-\\beta H_q(q))\\,\\mathrm{d}q\\right)\\left(\\int_{\\mathbb{R}^N} \\exp(-\\beta H_p(p))\\,\\mathrm{d}p\\right) + \\left(\\int_{\\mathbb{R}^N} \\exp(-\\beta H_q(q))\\,\\mathrm{d}q\\right)\\left(\\int_{\\mathbb{R}^N} A_{p}(p) \\exp(-\\beta H_p(p))\\,\\mathrm{d}p\\right)\n$$\n使用 $Z_q$ 和 $Z_p$ 的定义，我们可以将分子写为：\n$$\n\\text{分子} = \\left(\\int_{\\mathbb{R}^N} A_{q}(q) \\exp(-\\beta H_q(q))\\,\\mathrm{d}q\\right)Z_p + Z_q\\left(\\int_{\\mathbb{R}^N} A_{p}(p) \\exp(-\\beta H_p(p))\\,\\mathrm{d}p\\right)\n$$\n现在我们组合得到系综平均 $\\langle A \\rangle$：\n$$\n\\langle A \\rangle = \\frac{\\left(\\int_{\\mathbb{R}^N} A_{q}(q) \\exp(-\\beta H_q(q))\\,\\mathrm{d}q\\right)Z_p + Z_q\\left(\\int_{\\mathbb{R}^N} A_{p}(p) \\exp(-\\beta H_p(p))\\,\\mathrm{d}p\\right)}{Z_q Z_p}\n$$\n$$\n\\langle A \\rangle = \\frac{\\int_{\\mathbb{R}^N} A_{q}(q) \\exp(-\\beta H_q(q))\\,\\mathrm{d}q}{Z_q} + \\frac{\\int_{\\mathbb{R}^N} A_{p}(p) \\exp(-\\beta H_p(p))\\,\\mathrm{d}p}{Z_p}\n$$\n此表达式表明，和的平均值等于平均值的和，其中平均值是分别在位形空间和动量空间上计算的。我们可以定义归一化的概率密度 $\\rho_q(q) = Z_q^{-1} \\exp(-\\beta H_q(q))$ 和 $\\rho_p(p) = Z_p^{-1} \\exp(-\\beta H_p(p))$。于是 $\\langle A \\rangle = \\int_{\\mathbb{R}^N} A_q(q) \\rho_q(q)\\,\\mathrm{d}q + \\int_{\\mathbb{R}^N} A_p(p) \\rho_p(p)\\,\\mathrm{d}p$。\n\n为了提供包含明确归一化常数的最终表达式，我们必须计算 $Z_q$ 和 $Z_p$。\n位形空间配分函数为：\n$$\nZ_q = \\int_{\\mathbb{R}^N} \\exp\\left(-\\beta \\sum_{i=1}^N \\frac{1}{2}m_{i}\\omega_{i}^{2}q_{i}^{2}\\right) \\prod_{i=1}^N \\mathrm{d}q_i = \\prod_{i=1}^N \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\beta m_i \\omega_i^2}{2}q_i^2\\right) \\mathrm{d}q_i\n$$\n使用标准高斯积分 $\\int_{-\\infty}^{\\infty} \\exp(-ax^2)\\,\\mathrm{d}x = \\sqrt{\\pi/a}$，并令 $a_i = \\frac{\\beta m_i \\omega_i^2}{2}$，我们得到：\n$$\nZ_q = \\prod_{i=1}^N \\sqrt{\\frac{2\\pi}{\\beta m_i \\omega_i^2}}\n$$\n动量空间配分函数为：\n$$\nZ_p = \\int_{\\mathbb{R}^N} \\exp\\left(-\\beta \\sum_{i=1}^N \\frac{p_{i}^{2}}{2m_{i}}\\right) \\prod_{i=1}^N \\mathrm{d}p_i = \\prod_{i=1}^N \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\beta}{2m_i}p_i^2\\right) \\mathrm{d}p_i\n$$\n使用同样的高斯积分，并令 $a_i = \\frac{\\beta}{2m_i}$，我们得到：\n$$\nZ_p = \\prod_{i=1}^N \\sqrt{\\frac{2\\pi m_i}{\\beta}}\n$$\n概率密度的归一化常数是这些配分函数的倒数：\n$$\n\\frac{1}{Z_q} = \\prod_{i=1}^N \\sqrt{\\frac{\\beta m_i \\omega_i^2}{2\\pi}} \\quad \\text{和} \\quad \\frac{1}{Z_p} = \\prod_{i=1}^N \\sqrt{\\frac{\\beta}{2\\pi m_i}}\n$$\n将这些代入 $\\langle A \\rangle$ 的表达式中，我们便得到了最终的表达式，其中归一化的概率密度被明确地写出。积分的范围被指定为 $\\mathbb{R}^N$，积分测度 $\\mathrm{d}q$ 和 $\\mathrm{d}p$ 分别代表 $N$ 维体积元 $\\prod_{i=1}^N \\mathrm{d}q_i$ 和 $\\prod_{i=1}^N \\mathrm{d}p_i$。\n\n最终形式是两个积分的和。第一个积分是 $A_q(q)$ 在归一化位形概率分布下的平均值。第二个积分是 $A_p(p)$ 在归一化动量概率分布下的平均值。", "answer": "$$\n\\boxed{\\int_{\\mathbb{R}^N} A_{q}(q) \\left(\\prod_{i=1}^N \\sqrt{\\frac{\\beta m_i \\omega_i^2}{2\\pi}}\\right) \\exp\\left(-\\frac{\\beta}{2}\\sum_{i=1}^N m_i \\omega_i^2 q_i^2\\right) \\mathrm{d}q + \\int_{\\mathbb{R}^N} A_{p}(p) \\left(\\prod_{i=1}^N \\sqrt{\\frac{\\beta}{2\\pi m_i}}\\right) \\exp\\left(-\\beta\\sum_{i=1}^N \\frac{p_i^2}{2m_i}\\right) \\mathrm{d}p}\n$$", "id": "2772366"}, {"introduction": "真实的模拟产生的是有限且充满噪声的数据，如何从中提取精确的平均值是一个关键挑战。这个问题介绍了一种强大的方差缩减技术——控制变量法，用以提高模拟估算的统计精度。[@problem_id:2772376] 通过利用一个具有已知平均值的相关可观测量，我们可以在不增加模拟时间的情况下，显著降低目标物理量的统计不确定性。", "problem": "在一个温度固定的正则系综中，您进行了一次长时间的分子动力学 (MD) 模拟，产生了一个由两个可观测量组成的时间序列 $\\{(A_i,B_i)\\}_{i=1}^N$。可观测量 $A$ 是溶质-溶剂相互作用能，可观测量 $B$ 是施加于某个集体变量上的谐波限制能，根据能量均分定理，其系综平均值 $\\mu_B$ 是解析已知的。$A$ 和 $B$ 的单位均为 kJ/mol，因此 $A$ 和 $B$ 的任何线性组合都保持能量单位。\n\n您希望通过使用 $B$ 作为控制变量来估计系综平均值 $\\langle A \\rangle$，并减小其统计不确定性。考虑如下的估计量族\n$$\n\\widehat{A}_{\\mathrm{cv}}(\\alpha) \\equiv \\frac{1}{N}\\sum_{i=1}^{N} \\left[A_i - \\alpha\\left(B_i - \\mu_B\\right)\\right],\n$$\n其中 $\\alpha$ 是一个标量系数。假设采用标准的统计力学框架：遍历性确保了时间平均收敛于系综平均，系综方差和协方差由通常的二阶中心矩定义。模拟时间足够长，因此样本矩是相应系综矩的相合估计量。\n\n任务：\n1. 仅从系综平均、方差、协方差的定义以及期望的线性性出发，证明当 $\\mu_B$ 是 $B$ 的精确系综平均值时，$\\widehat{A}_{\\mathrm{cv}}(\\alpha)$ 是 $\\langle A \\rangle$ 的一个无偏估计量。\n2. 推导 $\\widehat{A}_{\\mathrm{cv}}(\\alpha)$ 的方差表达式（用 $\\mathrm{Var}(A)$、$\\mathrm{Var}(B)$ 和 $\\mathrm{Cov}(A,B)$ 表示），并确定使该方差最小化的值 $\\alpha^\\star$。\n3. 某次 MD 运行产生了 $N = 2.0\\times 10^{6}$ 帧。已知限制能的精确平均值为 $\\mu_B = 3.000$ kJ/mol。您从轨迹中计算出相合的样本协方差和方差，\n$$\n\\hat{C}_{AB} = -8.6135 \\;\\text{(kJ/mol)}^{2}, \\quad \\hat{C}_{BB} = 24.61 \\;\\text{(kJ/mol)}^{2}.\n$$\n使用这些统计量作为 $\\mathrm{Cov}(A,B)$ 和 $\\mathrm{Var}(B)$ 的估计量，计算最优系数 $\\alpha^\\star$。将您的答案四舍五入到四位有效数字。将该系数表示为无量纲数。", "solution": "所提出的问题是分子模拟统计估计中方差缩减技术的一个标准练习，具体涉及控制变量法。该问题有科学依据，提法明确且客观。我们将按顺序完成三个指定任务来解答此问题。\n\n任务1：证明 $\\widehat{A}_{\\mathrm{cv}}(\\alpha)$ 是 $\\langle A \\rangle$ 的一个无偏估计量。\n\n如果一个估计量的期望值等于被估计量的真值，则该估计量是无偏的。因此，我们必须计算估计量 $\\widehat{A}_{\\mathrm{cv}}(\\alpha)$ 的期望值。在这种情况下，一个可观测量的期望值即为其系综平均值，记作 $\\langle \\cdot \\rangle$。\n\n估计量定义为：\n$$\n\\widehat{A}_{\\mathrm{cv}}(\\alpha) = \\frac{1}{N}\\sum_{i=1}^{N} \\left[A_i - \\alpha\\left(B_i - \\mu_B\\right)\\right]\n$$\n我们对等式两边取期望值。根据期望算符的线性性，我们可以写出：\n$$\n\\langle \\widehat{A}_{\\mathrm{cv}}(\\alpha) \\rangle = \\left\\langle \\frac{1}{N}\\sum_{i=1}^{N} \\left[A_i - \\alpha\\left(B_i - \\mu_B\\right)\\right] \\right\\rangle\n$$\n$$\n\\langle \\widehat{A}_{\\mathrm{cv}}(\\alpha) \\rangle = \\frac{1}{N}\\sum_{i=1}^{N} \\langle A_i - \\alpha(B_i - \\mu_B) \\rangle\n$$\n再次对求和号内的项应用线性性：\n$$\n\\langle A_i - \\alpha(B_i - \\mu_B) \\rangle = \\langle A_i \\rangle - \\alpha \\langle B_i - \\mu_B \\rangle\n$$\n问题假设了遍历性和长时间模拟，因此单个样本 $A_i$ 或 $B_i$ 的系综平均等同于可观测量 $A$ 或 $B$ 的系综平均。因此，对于任意样本 $i$，$\\langle A_i \\rangle = \\langle A \\rangle$ 且 $\\langle B_i \\rangle = \\langle B \\rangle$。\n问题指出 $\\mu_B$ 是 $B$ 的精确系综平均值，所以 $\\langle B \\rangle = \\mu_B$。\n我们来计算第二项：\n$$\n\\langle B_i - \\mu_B \\rangle = \\langle B_i \\rangle - \\langle \\mu_B \\rangle\n$$\n由于 $\\mu_B$ 是一个常数，其期望值就是它本身，即 $\\langle \\mu_B \\rangle = \\mu_B$。\n$$\n\\langle B_i - \\mu_B \\rangle = \\langle B \\rangle - \\mu_B = \\mu_B - \\mu_B = 0\n$$\n将此结果代回，我们得到：\n$$\n\\langle A_i - \\alpha(B_i - \\mu_B) \\rangle = \\langle A \\rangle - \\alpha(0) = \\langle A \\rangle\n$$\n现在，将此代入估计量的期望表达式中：\n$$\n\\langle \\widehat{A}_{\\mathrm{cv}}(\\alpha) \\rangle = \\frac{1}{N}\\sum_{i=1}^{N} \\langle A \\rangle = \\frac{1}{N} (N \\langle A \\rangle) = \\langle A \\rangle\n$$\n由于对于任意 $\\alpha$ 值，都有 $\\langle \\widehat{A}_{\\mathrm{cv}}(\\alpha) \\rangle = \\langle A \\rangle$，因此该估计量确实是无偏的。这就完成了第一个任务。\n\n任务2：推导 $\\widehat{A}_{\\mathrm{cv}}(\\alpha)$ 的方差并求出最优系数 $\\alpha^\\star$。\n\n估计量的方差代表了统计不确定性，是我们希望最小化的量。估计量 $\\widehat{A}_{\\mathrm{cv}}(\\alpha)$ 是随机变量 $Y_i(\\alpha) = A_i - \\alpha(B_i - \\mu_B)$ 的样本均值。为简单起见，如果我们假设样本 $\\{Y_i\\}$ 是独立同分布的（这是一个常见的简化，尽管 MD 数据是相关的），那么均值的方差就是单个样本的方差除以样本数 $N$：\n$$\n\\mathrm{Var}(\\widehat{A}_{\\mathrm{cv}}(\\alpha)) = \\frac{1}{N} \\mathrm{Var}(Y_i(\\alpha))\n$$\n对于 $\\alpha$ 最小化 $\\mathrm{Var}(\\widehat{A}_{\\mathrm{cv}}(\\alpha))$ 等价于最小化 $\\mathrm{Var}(Y_i(\\alpha))$。我们来计算这个方差。\n$$\n\\mathrm{Var}(Y_i(\\alpha)) = \\mathrm{Var}(A_i - \\alpha(B_i - \\mu_B))\n$$\n利用方差的一般性质 $\\mathrm{Var}(X - cZ) = \\mathrm{Var}(X) + c^2\\mathrm{Var}(Z) - 2c\\mathrm{Cov}(X,Z)$，并注意到常数不影响方差或协方差（即 $\\mathrm{Var}(B_i - \\mu_B) = \\mathrm{Var}(B_i)$ 且 $\\mathrm{Cov}(A_i, B_i - \\mu_B) = \\mathrm{Cov}(A_i, B_i)$），我们得到：\n$$\n\\mathrm{Var}(Y_i(\\alpha)) = \\mathrm{Var}(A_i) + \\alpha^2 \\mathrm{Var}(B_i) - 2\\alpha \\mathrm{Cov}(A_i, B_i)\n$$\n为使符号清晰，省去样本索引 $i$，完整估计量方差的表达式变为：\n$$\n\\mathrm{Var}(\\widehat{A}_{\\mathrm{cv}}(\\alpha)) = \\frac{1}{N} \\left( \\mathrm{Var}(A) + \\alpha^2 \\mathrm{Var}(B) - 2\\alpha \\mathrm{Cov}(A,B) \\right)\n$$\n这就是所要求的表达式。为了找到使该方差最小化的最优值 $\\alpha^\\star$，我们对 $\\alpha$ 求导并令其为零。\n$$\n\\frac{d}{d\\alpha} \\mathrm{Var}(\\widehat{A}_{\\mathrm{cv}}(\\alpha)) = \\frac{1}{N} \\left( 2\\alpha \\mathrm{Var}(B) - 2 \\mathrm{Cov}(A,B) \\right) = 0\n$$\n解出 $\\alpha$：\n$$\n2\\alpha \\mathrm{Var}(B) - 2 \\mathrm{Cov}(A,B) = 0\n$$\n$$\n\\alpha \\mathrm{Var}(B) = \\mathrm{Cov}(A,B)\n$$\n$$\n\\alpha^\\star = \\frac{\\mathrm{Cov}(A,B)}{\\mathrm{Var}(B)}\n$$\n二阶导数 $\\frac{d^2}{d\\alpha^2} \\mathrm{Var}(\\widehat{A}_{\\mathrm{cv}}(\\alpha)) = \\frac{2}{N}\\mathrm{Var}(B)$ 为正，因为方差是非负的（对于一个有波动的可观测量 $B$，方差是严格为正的），这证实了 $\\alpha^\\star$ 对应一个最小值。需要注意的是，$\\alpha$ 的这个最优值与样本不相关的假设无关；它最小化了基础变量 $Y$ 的方差，因此无论时间相关性如何，都将最小化样本均值的方差。\n\n任务3：计算最优系数 $\\alpha^\\star$。\n\n根据任务2，最优系数由 $\\alpha^\\star = \\frac{\\mathrm{Cov}(A,B)}{\\mathrm{Var}(B)}$ 给出。\n问题为这些系综矩提供了相合的样本估计：\n样本协方差为 $\\hat{C}_{AB} = -8.6135 \\ (\\text{kJ/mol})^2$。这是我们对 $\\mathrm{Cov}(A,B)$ 的估计量。\nB 的样本方差为 $\\hat{C}_{BB} = 24.61 \\ (\\text{kJ/mol})^2$。这是我们对 $\\mathrm{Var}(B)$ 的估计量。\n我们将这些数值代入 $\\alpha^\\star$ 的表达式中：\n$$\n\\alpha^\\star \\approx \\frac{\\hat{C}_{AB}}{\\hat{C}_{BB}} = \\frac{-8.6135 \\ (\\text{kJ/mol})^2}{24.61 \\ (\\text{kJ/mol})^2}\n$$\n单位相消，得到所要求的无量纲系数。\n$$\n\\alpha^\\star \\approx -0.34999999...\n$$\n问题要求将答案四舍五入到四位有效数字。\n$$\n\\alpha^\\star \\approx -0.3500\n$$\n其他给定的值，$N = 2.0 \\times 10^6$ 和 $\\mu_B = 3.000 \\ \\text{kJ/mol}$，对于问题的定义和背景是必要的，但对于计算 $\\alpha^\\star$ 本身则不是。", "answer": "$$\n\\boxed{-0.3500}\n$$", "id": "2772376"}, {"introduction": "探索复杂过程通常需要使用有偏模拟，例如伞形采样，但这类模拟并不直接对玻尔兹曼分布进行抽样。这项实践练习将演示如何从这类高级模拟的输出（特别是经过加权直方图分析方法/WHAM处理的数据）中，恢复某个可观测量的真实、无偏的系综平均值。[@problem_id:2772333] 你将实现一个数值稳定的估算器，这对于分析增强采样方法产生的数据是一项至关重要的技能。", "problem": "给定一组有偏分子动力学模拟，这些模拟使用了以一维反应坐标 $\\xi$ 的重叠值为中心的谐波伞形约束。这些模拟使用加权直方图分析方法（WHAM）进行分析，该方法返回一个在以 $i$ 为索引的 $\\xi$ 箱（bin）上的离散、基于网格的约化自由能分布 $f(\\xi_i)$，其中约化自由能的定义使得无偏稳态概率密度满足 $\\rho(\\xi_i) \\propto \\exp\\!\\left(-f(\\xi_i)\\right)$。此外，您还从相同的模拟中计算了无偏的条件箱平均值 $\\overline{A}(\\xi_i)$，该值估计了每个箱 $i$ 内标量可观测量 $A$ 的条件期望 $\\langle A \\mid \\xi_i \\rangle$。对于可观测量 $A$，某些箱的采样可能不充分，因此 $\\overline{A}(\\xi_i)$ 可能不可用；此类条目被编码为缺失值。每个箱具有有限的宽度 $\\Delta \\xi_i$，该宽度可以是不均匀的。\n\n基于正则系综和全期望定律的第一性原理，仅使用 $f(\\xi_i)$、$\\overline{A}(\\xi_i)$ 和 $\\Delta \\xi_i$ 构建一个对 $\\xi$ 边缘化的无偏系综平均 $\\langle A \\rangle$ 的数值稳定估计器。您的估计器必须：\n- 仅使用提供的 WHAM 输出 $f(\\xi_i)$、条件箱平均值 $\\overline{A}(\\xi_i)$ 和箱宽度 $\\Delta \\xi_i$。\n- 作为对 $\\xi$ 积分的黎曼和近似，正确处理不均匀的 $\\Delta \\xi_i$。\n- 排除 $\\overline{A}(\\xi_i)$ 缺失的箱，并在剩余的箱上重新归一化概率。\n- 通过采用避免下溢或上溢的数值稳定归一化策略，对较大的 $f(\\xi_i)$ 值具有鲁棒性。\n- 将所有量视为无量纲。\n\n您的推导应仅基于以下基本要素：\n- 微观状态 $\\mathbf{x}$ 的正则（玻尔兹曼）分布：$p(\\mathbf{x}) \\propto \\exp\\!\\left(-\\beta U(\\mathbf{x})\\right)$，其中 $\\beta$ 是逆温度，$U(\\mathbf{x})$ 是势能。\n- 反应坐标 $\\xi(\\mathbf{x})$ 的定义以及从 $p(\\mathbf{x})$ 获得的边缘概率密度 $\\rho(\\xi)$。\n- 用于条件期望的全期望定律。\n\n将您的估计器实现为一个程序，为以下每个测试用例计算 $\\langle A \\rangle$。所有量均为无量纲。缺失的 $\\overline{A}(\\xi_i)$ 值由字符串“NaN”表示，并应作为缺失数据处理。\n\n测试套件：\n- 测试用例 1 (理想情况，对称，均匀箱宽):\n  - $\\xi_i = [-2, -1, 0, 1, 2]$\n  - $f(\\xi_i) = [2.0, 1.0, 0.0, 1.0, 2.0]$\n  - $\\overline{A}(\\xi_i) = [4.0, 1.0, 0.0, 1.0, 4.0]$\n  - $\\Delta \\xi_i = [1.0, 1.0, 1.0, 1.0, 1.0]$\n- 测试用例 2 (含缺失数据的箱，均匀箱宽):\n  - $\\xi_i = [0, 1, 2, 3, 4, 5, 6]$\n  - $f(\\xi_i) = [0.0, 0.2, 0.4, 0.6, 0.8, 1.0, 1.2]$\n  - $\\overline{A}(\\xi_i) = [1.0, \\mathrm{NaN}, 2.0, \\mathrm{NaN}, 3.0, 4.0, 5.0]$\n  - $\\Delta \\xi_i = [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5]$\n- 测试用例 3 (非均匀箱宽，极端的约化自由能):\n  - $\\xi_i = [-1.5, -0.5, 0.5, 1.5]$\n  - $f(\\xi_i) = [10.0, 0.0, 5.0, 20.0]$\n  - $\\overline{A}(\\xi_i) = [10.0, 20.0, 30.0, 40.0]$\n  - $\\Delta \\xi_i = [0.1, 0.4, 0.2, 0.3]$\n\n您的程序应：\n- 使用稳定算术实现上述估计器。您必须通过排除那些箱并在剩余的箱上重新归一化来显式处理缺失的 $\\overline{A}(\\xi_i)$ 值。\n- 以保留六位小数的实数形式生成输出。\n- 生成单行输出，其中包含测试用例的结果，格式为用方括号括起来的逗号分隔列表（例如，“[0.123456,0.234567,0.345678]”）。\n\n不应读取任何外部输入。所有计算必须仅使用上面提供的数据进行。最终输出必须是测试用例 1、2 和 3 的三个估计值 $\\langle A \\rangle$，按此顺序并按指定格式排列。", "solution": "所呈现的问题陈述在化学和数学上是合理的，自洽且适定的。它要求从离散化的模拟数据中推导并实现一个无偏系综平均的估计器。在验证过程中未检测到任何缺陷。我们将从第一性原理开始推导。\n\n宏观可观测量 $A$ 的正则系综平均，它是系统微观状态 $\\mathbf{x}$ 的函数，定义为：\n$$\n\\langle A \\rangle = \\frac{\\int A(\\mathbf{x}) \\exp(-\\beta U(\\mathbf{x})) \\, d\\mathbf{x}}{\\int \\exp(-\\beta U(\\mathbf{x})) \\, d\\mathbf{x}}\n$$\n其中 $U(\\mathbf{x})$ 是势能，$\\beta = (k_B T)^{-1}$ 是逆温度，积分遍及所有可及的相空间。\n\n该问题是根据一维反应坐标 $\\xi = \\xi(\\mathbf{x})$ 来表述的。我们可以通过应用全期望定律来表达系综平均。该定律允许我们首先计算在 $\\xi$ 固定值下 $A$ 的条件期望，记作 $\\langle A \\mid \\xi \\rangle$，然后将此量在 $\\xi$ 的边缘概率分布（记作 $\\rho(\\xi)$）上进行平均。\n$$\n\\langle A \\rangle = \\int_{-\\infty}^{\\infty} \\langle A \\mid \\xi \\rangle \\rho(\\xi) \\, d\\xi\n$$\n\n边缘概率密度 $\\rho(\\xi)$ 与平均力势（或自由能）$F(\\xi)$ 相关，关系式为 $\\rho(\\xi) \\propto \\exp(-\\beta F(\\xi))$。问题提供了一个离散化的约化自由能分布 $f(\\xi_i)$，其定义使得无偏稳态概率密度满足 $\\rho(\\xi_i) \\propto \\exp(-f(\\xi_i))$。术语“约化”意味着因子 $\\beta$ 已被吸收到 $f$ 的定义中，因此 $f(\\xi) = \\beta F(\\xi)$。\n\n所提供的数据是离散的，对应于以 $i$ 为索引的箱，每个箱都有一个中心 $\\xi_i$ 和一个宽度 $\\Delta \\xi_i$。$\\langle A \\rangle$ 的连续积分可以近似为在这些箱上的黎曼和：\n$$\n\\langle A \\rangle \\approx \\sum_i \\langle A \\mid \\xi_i \\rangle P(\\xi_i)\n$$\n其中 $P(\\xi_i)$ 是在箱 $i$ 中找到系统的总概率，而 $\\langle A \\mid \\xi_i \\rangle$ 是在系统位于箱 $i$ 的条件下 $A$ 的条件期望。问题提供了该条件期望的估计值 $\\overline{A}(\\xi_i)$。\n\n在箱 $i$ 中的概率 $P(\\xi_i)$ 是概率密度 $\\rho(\\xi)$ 在该箱宽度上的积分。对于足够小的箱宽 $\\Delta \\xi_i$，这可以近似为：\n$$\nP(\\xi_i) \\approx \\rho(\\xi_i) \\Delta \\xi_i\n$$\n使用给定的关系 $\\rho(\\xi_i) \\propto \\exp(-f(\\xi_i))$，我们有：\n$$\nP(\\xi_i) = \\frac{\\exp(-f(\\xi_i)) \\Delta \\xi_i}{Z}\n$$\n其中 $Z$ 是归一化常数，或称配分函数，由所有箱 $j$ 的总和给出：\n$$\nZ = \\sum_j \\exp(-f(\\xi_j)) \\Delta \\xi_j\n$$\n将这些表达式代入系综平均的公式中，得到：\n$$\n\\langle A \\rangle = \\sum_i \\overline{A}(\\xi_i) P(\\xi_i) = \\sum_i \\overline{A}(\\xi_i) \\frac{\\exp(-f(\\xi_i)) \\Delta \\xi_i}{\\sum_j \\exp(-f(\\xi_j)) \\Delta \\xi_j}\n$$\n这可以写成一个单一的分数形式：\n$$\n\\langle A \\rangle = \\frac{\\sum_i \\overline{A}(\\xi_i) \\exp(-f(\\xi_i)) \\Delta \\xi_i}{\\sum_j \\exp(-f(\\xi_j)) \\Delta \\xi_j}\n$$\n问题指明，对于某些箱，$\\overline{A}(\\xi_i)$ 的值可能缺失。设 $S$ 为 $\\overline{A}(\\xi_i)$ 可用的索引 $i$ 的集合。求和必须限制在这个“有效”箱的集合内。这等同于在可观测量平均值已知的状态子集上重新归一化概率分布。估计器变为：\n$$\n\\langle A \\rangle = \\frac{\\sum_{i \\in S} \\overline{A}(\\xi_i) \\exp(-f(\\xi_i)) \\Delta \\xi_i}{\\sum_{j \\in S} \\exp(-f(\\xi_j)) \\Delta \\xi_j}\n$$\n如果 $f(\\xi_i)$ 是大的正数，计算 $\\exp(-f(\\xi_i))$ 可能导致数值下溢；如果是大的负数，则可能导致上溢。为确保数值稳定性，我们在进行指数运算前从所有自由能值中减去一个常数。一个明智的选择是有效箱中的最小自由能值，$f_{\\min, S} = \\min_{i \\in S} \\{f(\\xi_i)\\}$。表达式修改如下：\n$$\n\\langle A \\rangle = \\frac{\\sum_{i \\in S} \\overline{A}(\\xi_i) \\exp(-f(\\xi_i) + f_{\\min, S}) \\Delta \\xi_i}{\\sum_{j \\in S} \\exp(-f(\\xi_j) + f_{\\min, S}) \\Delta \\xi_j}\n$$\n这个表达式在数学上与前一个表达式相同，因为因子 $\\exp(f_{\\min, S})$ 同时出现在分子和分母中，因此可以消去。然而，这种形式在数值上是鲁棒的。指数函数的最大参数现在是 $0$，对应于 $\\exp(0)=1$，这可以防止上溢。其他参数是负数，防止其他项变得过大，同时保留了具有最高统计权重的项。\n\n因此，算法如下：\n1. 识别出 $\\overline{A}(\\xi_i)$ 不是缺失值的索引集合 $S$。\n2. 创建与索引 $S$ 对应的筛选后数组 $f_S, \\overline{A}_S, \\Delta \\xi_S$。\n3. 在筛选后的自由能数组中找到最小值：$f_{\\min, S} = \\min(f_S)$。\n4. 计算平移后的自由能：$f'_S = f_S - f_{\\min, S}$。\n5. 为每个有效箱计算未归一化的玻尔兹曼权重：$w_i = \\exp(-f'_i)$，其中 $i \\in S$。\n6. 分子是条件平均值、权重和箱宽乘积的总和：$N = \\sum_{i \\in S} \\overline{A}_i \\cdot w_i \\cdot \\Delta \\xi_i$。\n7. 分母是权重和箱宽乘积的总和，它将集合 $S$ 上的总概率归一化为 1：$D = \\sum_{i \\in S} w_i \\cdot \\Delta \\xi_i$。\n8. 最终估计值是比率 $\\langle A \\rangle = N/D$。\n此过程正确地实现了离散化数据的统计力学原理，同时处理了缺失信息并确保了数值稳定性。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for the ensemble average <A> for multiple test cases.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"f_xi\": np.array([2.0, 1.0, 0.0, 1.0, 2.0]),\n            \"A_bar_xi\": np.array([4.0, 1.0, 0.0, 1.0, 4.0]),\n            \"delta_xi\": np.array([1.0, 1.0, 1.0, 1.0, 1.0]),\n        },\n        {\n            \"f_xi\": np.array([0.0, 0.2, 0.4, 0.6, 0.8, 1.0, 1.2]),\n            \"A_bar_xi\": np.array([1.0, np.nan, 2.0, np.nan, 3.0, 4.0, 5.0]),\n            \"delta_xi\": np.array([0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5]),\n        },\n        {\n            \"f_xi\": np.array([10.0, 0.0, 5.0, 20.0]),\n            \"A_bar_xi\": np.array([10.0, 20.0, 30.0, 40.0]),\n            \"delta_xi\": np.array([0.1, 0.4, 0.2, 0.3]),\n        },\n    ]\n\n    def estimate_ensemble_average(f_xi, A_bar_xi, delta_xi):\n        \"\"\"\n        Computes the unbiased ensemble average <A> using a numerically stable method.\n\n        Args:\n            f_xi (np.ndarray): Array of reduced free energies.\n            A_bar_xi (np.ndarray): Array of conditional averages of A. May contain NaNs.\n            delta_xi (np.ndarray): Array of bin widths.\n\n        Returns:\n            float: The estimated ensemble average <A>.\n        \"\"\"\n        # 1. Identify valid bins where A_bar is not NaN.\n        valid_mask = ~np.isnan(A_bar_xi)\n\n        if not np.any(valid_mask):\n            # If no valid bins exist, the average is undefined.\n            return np.nan\n\n        # 2. Filter arrays to include only data from valid bins.\n        f_valid = f_xi[valid_mask]\n        A_bar_valid = A_bar_xi[valid_mask]\n        delta_xi_valid = delta_xi[valid_mask]\n\n        # 3. Find the minimum free energy among valid bins for numerical stability.\n        f_min = np.min(f_valid)\n\n        # 4. Calculate shifted free energies.\n        f_shifted = f_valid - f_min\n\n        # 5. Compute unnormalized Boltzmann weights.\n        weights = np.exp(-f_shifted)\n\n        # 6. Calculate the numerator of the estimator equation.\n        # This is the sum over valid bins of A_bar * weight * bin_width.\n        numerator = np.sum(A_bar_valid * weights * delta_xi_valid)\n\n        # 7. Calculate the denominator (normalization constant over the valid subset).\n        # This is the sum over valid bins of weight * bin_width.\n        denominator = np.sum(weights * delta_xi_valid)\n\n        # 8. Compute the final estimate.\n        if denominator == 0:\n            # This case is unlikely with the f_min shift but is a safeguard.\n            return np.nan\n\n        ensemble_average = numerator / denominator\n        return ensemble_average\n\n    results = []\n    for case in test_cases:\n        result = estimate_ensemble_average(case[\"f_xi\"], case[\"A_bar_xi\"], case[\"delta_xi\"])\n        # Format the result to six decimal places.\n        results.append(f\"{result:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```", "id": "2772333"}]}