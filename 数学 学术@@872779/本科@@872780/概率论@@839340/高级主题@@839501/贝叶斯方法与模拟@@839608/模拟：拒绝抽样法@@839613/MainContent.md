## 引言
在概率论和统计学的广阔天地中，我们经常需要从复杂的[概率分布](@entry_id:146404)中生成随机样本，而这些[分布](@entry_id:182848)往往没有直接的、简单的[抽样方法](@entry_id:141232)。[拒绝采样](@entry_id:142084)（Rejection Sampling）是一种优雅而强大的[蒙特卡洛方法](@entry_id:136978)，它巧妙地解决了这一难题。该方法通过引入一个更简单的“提议分布”，以“接受-拒绝”的机制，精确地生成符合目标分布的样本，为模拟、推断和优化等任务提供了坚实的计算基础。本文旨在全面解析[拒绝采样](@entry_id:142084)的理论与实践。在“原理与机制”一章中，我们将深入探讨其数学基础、效率决定因素以及关键假设。随后，在“应用与跨学科联系”一章中，我们将展示该方法在几何、统计、数值分析和[随机过程](@entry_id:159502)等多个领域的广泛应用。最后，通过“动手实践”环节，读者将有机会将理论知识应用于解决具体问题，从而真正掌握这一核心的模拟技术。

## 原理与机制

在对[拒绝采样](@entry_id:142084)的基本思想有了初步了解之后，本章将深入探讨其背后的数学原理与核心机制。我们将详细剖析该算法为何能够精确地生成符合[目标分布](@entry_id:634522)的样本，如何量化并优化其效率，以及在违反其核心假设时会产生何种后果。理解这些原理对于在实践中正确并高效地应用[拒绝采样](@entry_id:142084)至关重要。

### 核心算法：提议-接受/拒绝框架

[拒绝采样](@entry_id:142084)的本质是一个巧妙的概率游戏，它利用一个容易抽样的**提议分布 (proposal distribution)** 来生成来自一个复杂或难以直接抽样的**目标分布 (target distribution)** 的样本。设我们希望抽样的目标[概率密度函数](@entry_id:140610)（PDF）为 $f(x)$，而已知的一个可以轻松抽样的提议分布的PDF为 $g(x)$。

该算法的执行步骤如下：

1.  从提议分布 $g(x)$ 中抽取一个候选样本 $Y$。
2.  找到一个常数 $M$，使得对于所有的 $x$，$f(x) \le M g(x)$ 恒成立。这个条件至关重要，我们稍后会详细讨论。
3.  从区间 $[0, 1]$ 上的[均匀分布](@entry_id:194597)中抽取一个随机数 $U$。
4.  执行**接受检验**：如果满足不等式 $U \le \frac{f(Y)}{M g(Y)}$，则接受样本 $Y$，将其作为来自[目标分布](@entry_id:634522) $f(x)$ 的一个有效样本。
5.  如果上述不等式不成立，则拒绝样本 $Y$，并返回步骤1，重复整个过程，直到获得一个接受的样本。

**为什么这个方法有效？**

要证明该算法的正确性，我们只需证明被接受的样本的[概率分布](@entry_id:146404)确实是 $f(x)$。让我们来推导一个被接受样本 $X_{acc}$ 的[概率密度函数](@entry_id:140610)。

一个候选样本 $Y$ 被接受的事件，取决于两个条件：首先，我们从 $g(x)$ 中抽样得到 $Y=x$；其次，随机数 $U$ 小于等于接受阈值。给定 $Y=x$，其被接受的条件概率为：

$$
\mathbb{P}(\text{接受} | Y=x) = \mathbb{P}\left(U \le \frac{f(x)}{M g(x)}\right) = \frac{f(x)}{M g(x)}
$$

这里我们利用了 $U$ 在 $[0, 1]$ 上[均匀分布](@entry_id:194597)的特性，并且 $f(x) \le M g(x)$ 保证了比率 $\frac{f(x)}{M g(x)} \le 1$。

一个样本被接受且其值落在某个微小区间 $[x, x+dx]$ 的概率，等于在 $g(x)$ 下该值落在该区间的概率（即 $g(x)dx$）乘以它被接受的条件概率：

$$
\mathbb{P}(X_{acc} \in [x, x+dx]) = \mathbb{P}(\text{接受} | Y=x) \times \mathbb{P}(Y \in [x, x+dx]) = \frac{f(x)}{M g(x)} \cdot g(x)dx = \frac{f(x)}{M}dx
$$

这表明，被接受样本的[概率分布](@entry_id:146404)与 $\frac{f(x)}{M}$ 成正比。为了得到一个合法的概率密度函数，我们需要对其进行归一化。归一化常数是该函数在整个定义域上的积分：

$$
\int_{-\infty}^{\infty} \frac{f(x)}{M} dx = \frac{1}{M} \int_{-\infty}^{\infty} f(x) dx
$$

由于 $f(x)$ 本身是一个合法的PDF，其积分为1。因此，归一化常数为 $\frac{1}{M}$。将未归一化的密度 $\frac{f(x)}{M}$ 除以[归一化常数](@entry_id:752675) $\frac{1}{M}$，我们得到被接受样本的最终PDF：

$$
h(x) = \frac{f(x)/M}{1/M} = f(x)
$$

这精确地证明了通过[拒绝采样](@entry_id:142084)方法所接受的样本，其[分布](@entry_id:182848)确实是我们期望的目标分布 $f(x)$。

### 关键常数 M：包络原理与最优化

在[拒绝采样](@entry_id:142084)的机制中，常数 $M$ 扮演着核心角色。不等式 $f(x) \le M g(x)$ 可以直观地理解为：函数 $M g(x)$ 必须像一个“信封”或“包络线”一样，在所有点上都“包住”目标函数 $f(x)$。

为了使算法有效，我们必须找到一个满足此条件的有限常数 $M$。理论上任何足够大的 $M$ 都可以，但为了最大化算法的效率，我们应该选择满足条件的**最小** $M$ 值。这个最优值 $M^*$ 定义为：

$$
M^* = \sup_{x} \frac{f(x)}{g(x)}
$$

其中 $\sup$ 表示[上确界](@entry_id:140512)（supremum），即该比值所有可能取值的[最小上界](@entry_id:142911)。如果 $g(x)$ 在 $f(x) > 0$ 的区域内也恒为正，这个比值就是良定义的。

**如何计算最优 M？**

通常，寻找最优 $M^*$ 的过程归结为一个微积分中的最值问题。例如，考虑一个任务：我们需要从[目标分布](@entry_id:634522) $f(x) = 6(x - x^2)$（$x \in [0, 1]$）中抽样，并使用最简单的[提议分布](@entry_id:144814)，即在 $[0, 1]$ 上的[均匀分布](@entry_id:194597) $g(x) = 1$ [@problem_id:1387123]。

在这种情况下，我们需要找到 $M$ 使得 $6(x-x^2) \le M \cdot 1$ 在 $[0, 1]$ 上成立。最优的 $M$ 就是 $f(x)$ 在该区间的最大值。通过求导：

$$
f'(x) = 6(1-2x)
$$

令 $f'(x) = 0$ 得到驻点 $x = \frac{1}{2}$。由于[二阶导数](@entry_id:144508) $f''(x) = -12 < 0$，该点为极大值点。$f(\frac{1}{2}) = 6(\frac{1}{2} - \frac{1}{4}) = \frac{3}{2}$。在边界点 $f(0)=0$ 和 $f(1)=0$，因此 $f(x)$ 的最大值为 $\frac{3}{2}$。所以，最优常数 $M^* = \frac{3}{2}$。

另一个例子是[目标分布](@entry_id:634522) $f(x) = 2x$（$x \in [0, 1]$）和[提议分布](@entry_id:144814) $g(x) = 1$ [@problem_id:1387108]。比值 $\frac{f(x)}{g(x)} = 2x$ 在 $[0, 1]$ 上是一个增函数，其最大值在 $x=1$ 处取得，为 $2$。因此，最优 $M^*=2$。

### 算法效率：[接受概率](@entry_id:138494)与期望试验次数

常数 $M$ 不仅是算法正确性的保证，它还直接决定了算法的**效率 (efficiency)**。效率通常用单个候选样本被接受的概率来衡量。

我们已经知道，在给定 $Y=x$ 的条件下，[接受概率](@entry_id:138494)是 $\frac{f(x)}{M g(x)}$。为了得到总的、无条件的接受概率 $p_{accept}$，我们需要对所有可能的 $x$ 值进行加权平均，权重为 $x$ 本身被提出的概率 $g(x)$：

$$
p_{accept} = \int_{-\infty}^{\infty} \mathbb{P}(\text{接受} | Y=x) g(x) dx = \int_{-\infty}^{\infty} \frac{f(x)}{M g(x)} g(x) dx = \frac{1}{M} \int_{-\infty}^{\infty} f(x) dx
$$

由于 $\int f(x) dx = 1$，我们得到了一个极为简洁和重要的结果：

$$
p_{accept} = \frac{1}{M}
$$

这个公式告诉我们，接受概率完全由常数 $M$ 的倒数决定。这立即揭示了为什么我们要寻找最小的 $M$：$M$ 越小，接受概率 $p_{accept}$ 越大，算法的效率就越高。例如，在一个[拒绝采样](@entry_id:142084)方案中，如果计算出最优 $M=2$，则其效率（即[接受概率](@entry_id:138494)）为 $1/2 = 0.5$ [@problem_id:1387077]。

在实践中，我们更关心的是“平均需要多少次尝试才能成功获得一个样本？”。获取第一个接受样本所需的试验次数 $K$ 是一个[随机变量](@entry_id:195330)。由于每次试验（提议-检验）都是独立的，且成功概率恒为 $p_{accept}$，所以 $K$ 服从参数为 $p=p_{accept}$ 的**几何分布 (Geometric distribution)** [@problem_id:1387125]。

[几何分布](@entry_id:154371)的[期望值](@entry_id:153208)为成功概率的倒数。因此，获得一个接受样本所需的期望试验次数 $E[K]$ 为：

$$
E[K] = \frac{1}{p_{accept}} = M
$$

这个结果同样优雅：最优常数 $M$ 的值直接等于平均需要从[提议分布](@entry_id:144814)中抽样的次数，才能成功生成一个来自[目标分布](@entry_id:634522)的样本。例如，若要从 $f(\theta) = \frac{1}{2}\sin(\theta)$（$\theta \in [0, \pi]$）抽样，使用在 $[0, \pi]$ 上的均匀提议分布 $g(\theta) = \frac{1}{\pi}$，我们首先计算最优 $M$：

$$
M = \sup_{\theta \in [0, \pi]} \frac{f(\theta)}{g(\theta)} = \sup_{\theta \in [0, \pi]} \frac{\frac{1}{2}\sin(\theta)}{1/\pi} = \frac{\pi}{2} \sup_{\theta \in [0, \pi]} \sin(\theta) = \frac{\pi}{2}
$$

因此，期望的试验次数就是 $M = \frac{\pi}{2} \approx 1.57$ [@problem_id:1387124]。

### 几何直观：从高维空间看[拒绝采样](@entry_id:142084)

[拒绝采样](@entry_id:142084)最直观的例子是几何抽样。假设我们的目标是在一个单位半径的圆盘内均匀抽样。一个简单的方法是在一个恰好包住这个圆盘的正方形（边长为2，范围为 $[-1, 1] \times [-1, 1]$）内均匀抽样，然后只保留落在圆盘内的点 [@problem_id:1387095]。

在这个场景中，$f(x, y)$ 是圆盘内的[均匀分布](@entry_id:194597)（值为 $1/(\pi R^2)$），$g(x, y)$ 是正方形内的[均匀分布](@entry_id:194597)（值为 $1/((2R)^2)$）。接受概率 $p_{accept}$ 就是“提议点”落在“目标区域”的概率。由于提议是在正方形内均匀的，这个概率就等于两个区域的面积之比：

$$
p_{accept} = \frac{\text{Area}(\text{圆盘})}{\text{Area}(\text{正方形})} = \frac{\pi R^2}{(2R)^2} = \frac{\pi}{4}
$$

根据我们之前的推导，$p_{accept} = 1/M$，所以 $M = 4/\pi \approx 1.27$。这意味着平均约1.27次提议就能获得一个圆盘内的点。

然而，这种几何直观在高维空间中揭示了[拒绝采样](@entry_id:142084)的一个严重局限性，即所谓的**“维度灾难” (curse of dimensionality)**。考虑将上述问题推广到 $d$ 维空间：我们希望在一个 $d$ 维[单位球](@entry_id:142558) $B_d$ 内均匀抽样，[提议分布](@entry_id:144814)是在一个边长为2的 $d$ 维[超立方体](@entry_id:273913) $C_d$ 内的[均匀分布](@entry_id:194597) [@problem_id:1387132]。

效率（[接受概率](@entry_id:138494)）等于 $d$ 维球和 $d$ 维超立方体的体积之比：

$$
p_d = \frac{\text{Vol}(B_d)}{\text{Vol}(C_d)} = \frac{\pi^{d/2} / \Gamma(\frac{d}{2}+1)}{2^d}
$$

其中 $\Gamma$ 是伽马函数。期望试验次数 $E_d = 1/p_d = \frac{2^d \Gamma(\frac{d}{2}+1)}{\pi^{d/2}}$。当维度 $d$ 增加时，球的体积相对于其外切[超立方体](@entry_id:273913)的体积会急剧缩小。例如，对于偶数维 $d=2k$，该期望次数可以简化为 $E_{2k} = k! (\frac{4}{\pi})^k$。这个值随着 $k$ 的增加而爆炸式增长。例如，在20维空间中（$k=10$），$E_{20} = 10! (\frac{4}{\pi})^{10} \approx 2.5 \times 10^8$。这意味着平均需要数亿次尝试才能获得一个有效样本，使得该方法在高维空间中完全不可行。

### 算法的稳健性：违反核心假设的后果

[拒绝采样](@entry_id:142084)的优雅和正确性依赖于几个关键假设。如果这些假设被违反，算法要么会彻底失败，要么会产生错误的、偏离[目标分布](@entry_id:634522)的样本。

**1. [提议分布](@entry_id:144814)的支撑集不足**

一个基本要求是，提议分布 $g(x)$ 的**支撑集 (support)** 必须覆盖[目标分布](@entry_id:634522) $f(x)$ 的支撑集。换句话说，在任何 $f(x) > 0$ 的地方，必须有 $g(x) > 0$。否则，我们永远无法生成目标分布中某些区域的样本。

一个极端但具启发性的例子是，尝试使用正态分布 $g(x)$ 作为[提议分布](@entry_id:144814)来抽样标准柯西分布 $f(x) = \frac{1}{\pi(1+x^2)}$ [@problem_id:1387101]。柯西分布具有“重尾”，其密度函数 $f(x)$ 随 $|x| \to \infty$ 按 $1/x^2$ 的速度递减。而[正态分布](@entry_id:154414)的密度函数 $g(x)$ 包含一个 $\exp(-x^2)$ 项，其尾部以指数速度趋于零，是“轻尾”的。

它们的比值 $R(x) = \frac{f(x)}{g(x)}$ 会包含一个 $\frac{\exp(x^2/2\sigma^2)}{1+x^2}$ 这样的项。当 $|x| \to \infty$ 时，指数项的增长速度远快于多项式项，导致 $R(x) \to \infty$。这意味着不存在一个有限的常数 $M$ 能够使得 $M g(x)$ 包住 $f(x)$，算法从根本上无法建立。

一个更微妙的错误是，提议分布的支撑集只覆盖了[目标分布](@entry_id:634522)的一部分 [@problem_id:1387084]。例如，若目标 $p(x)$ 定义在 $[0, 2]$ 上，而我们误用了仅在 $[0, 1.5]$ 上有定义的提议分布 $q(x)$。那么，无论我们进行多少次抽样，都不可能生成任何大于1.5的样本。最终得到的样本[分布](@entry_id:182848)将是[目标分布](@entry_id:634522)在 $[0, 1.5]$ 上的一个**截断版本 (truncated version)**，其真实的PDF会被重新归一化到区间 $[0, 1.5]$ 上，而不再是原始的目标分布 $p(x)$。

**2. 选择了过小的常数 M**

如果选择的常数 $M$ 过小，违反了 $f(x) \le M g(x)$ 的条件，会发生什么？算法不会崩溃，但会产生**错误**的样本。

考虑目标 $f(x)=2x$ 和提议 $g(x)=1$（在 $[0,1]$ 上）。我们知道最优 $M^*=2$。假设一位研究者错误地设置了 $M=1$ [@problem_id:1387128]。此时，[接受概率](@entry_id:138494)的计算公式 $\frac{f(x)}{M g(x)} = \frac{2x}{1} = 2x$ 在 $x > 1/2$ 时会大于1，这在概率上是不可能的。

在实际执行中，一个候选样本 $x$ 的[接受概率](@entry_id:138494)是 $\min(1, \frac{f(x)}{M g(x)})$。因此，在这个错误的设置下，对于 $x \in [0, 1]$：
$$
\mathbb{P}(\text{接受} | Y=x) = \min(1, 2x) = \begin{cases} 2x, & 0 \le x \le 1/2 \\ 1, & 1/2  x \le 1 \end{cases}
$$
在 $x  1/2$ 的区域，本应按 $2x$ 的比例进行接受（以抵消均匀[提议分布](@entry_id:144814)的“平坦性”），但现在接受概率被人为地“削平”至1。这意味着相对于 $x \le 1/2$ 的区域，$[1/2, 1]$ 中的值被接受的频率不足。最终得到的样本[分布](@entry_id:182848)将不再是 $f(x)=2x$，而是一个被扭曲的[分布](@entry_id:182848)，其密度函数在 $[1/2, 1]$ 区间会偏低，而在 $[0, 1/2]$ 区间会相对偏高（经过归一化后）。这个例子深刻地说明了包络条件 $f(x) \le M g(x)$ 对于保证抽样正确性是不可或缺的。

通过对这些原理和潜在陷阱的深入理解，我们才能更有信心地在各种应用场景中，设计和实现既正确又高效的[拒绝采样算法](@entry_id:260966)。