## 引言
在处理“事件发生时间”数据时，[生存分析](@entry_id:163785)提供了一套不可或缺的统计工具，而Cox[比例风险模型](@entry_id:171806)无疑是该领域中最具影响力和应用最广泛的模型之一。自David Cox爵士于1972年提出以来，它彻底改变了研究人员分析从临床试验到社会经济现象等各种领域中时间依赖性结果的方式。然而，其强大的灵活性背后是一套需要仔细理解的独特原理和假设。

本文旨在系统性地揭开Cox[比例风险模型](@entry_id:171806)的面纱，解决在处理带有删失（censoring）的[生存数据](@entry_id:165675)时所面临的根本挑战。许多标准统计方法在面对这类不完整数据时会失效，而[Cox模型](@entry_id:164053)则提供了一个优雅的解决方案。

为实现这一目标，本文将引导您逐步深入模型的三个核心层面。在第一章“原理与机制”中，我们将剖析模型的数学结构、核心的[比例风险](@entry_id:166780)假定以及巧妙的[偏似然](@entry_id:165240)估计法。随后，在第二章“应用与跨学科联系”中，我们将跨出传统的生物医学领域，展示该模型在工程、金融、社会科学等多个学科中的强大应用能力。最后，在第三章“动手实践”中，您将通过具体的计算练习，将理论知识转化为可操作的技能。通过这一结构化的学习路径，您将全面掌握[Cox模型](@entry_id:164053)，并能够自信地将其应用于解决真实世界的研究问题。

## 原理与机制

在上一章介绍[生存分析](@entry_id:163785)的基本概念之后，本章将深入探讨Cox[比例风险模型](@entry_id:171806)的内部工作原理。我们将剖析该模型的数学结构，阐明其核心的[比例风险](@entry_id:166780)假定，并详细解释用于估计模型参数的[偏似然](@entry_id:165240)方法。通过理解这些基本原理，研究者可以更有效地应用和解读[Cox模型](@entry_id:164053)，从而在各种科学领域中，从[事件发生时间数据](@entry_id:165675)中提取深刻的洞见。

### [Cox模型](@entry_id:164053)的结构

Cox[比例风险模型](@entry_id:171806)，或简称[Cox模型](@entry_id:164053)，由David Cox爵士于1972年提出，它为研究一个或多个[协变](@entry_id:634097)量对特定事件发生时间的影响提供了一个强大而灵活的框架。该模型的核心在于其独特的数学形式，将风险与时间和[协变](@entry_id:634097)量的影响分离开来。

对于一个个体，其在时间 $t$ 的**[风险函数](@entry_id:166593) (hazard function)** $h(t | \mathbf{X})$，即在该时刻事件发生的[瞬时速率](@entry_id:182981)（假定个体存活至此刻），由以下公式给出：

$$h(t | \mathbf{X}) = h_0(t) \exp(\boldsymbol{\beta}^T \mathbf{X})$$

其中：
- $t$ 代表自某个起点开始的时间。
- $\mathbf{X} = (X_1, X_2, \dots, X_p)$ 是一个协变量向量，代表可能影响生存时间的各种因素。
- $\boldsymbol{\beta} = (\beta_1, \beta_2, \dots, \beta_p)$ 是一个[回归系数](@entry_id:634860)向量，量化了每个[协变](@entry_id:634097)量对风险的影响。
- $h_0(t)$ 是**基准[风险函数](@entry_id:166593) (baseline hazard function)**，代表当所有协变量值都为零（即 $\mathbf{X} = \mathbf{0}$）时的[风险函数](@entry_id:166593)。

这个公式简洁地将模型分解为两个关键部分：一个与时间相关的部分 $h_0(t)$，和一个与协变量相关的部分 $\exp(\boldsymbol{\beta}^T \mathbf{X})$。接下来，我们将深入探讨模型的这些组成部分及其在实践中的意义。

#### [风险函数](@entry_id:166593)与[删失数据](@entry_id:173222)

在深入模型结构之前，我们必须首先处理[生存分析](@entry_id:163785)中的一个核心挑战：**删失 (censoring)**。在许多研究中，我们无法观察到所有研究对象的完整事件发生时间。最常见的情况是**[右删失](@entry_id:164686) (right-censoring)**，即我们只知道事件在某个特定时间点之后才发生（或尚未发生），但不知道确切的发生时间。

例如，在一个技术公司分析新功能采纳率的研究中，事件是用户首次使用新功能。如果研究持续90天，可能会出现以下几种情况 [@problem_id:1911727]：
- **事件发生**：用户在第30天首次使用了该功能。这是一个完整的观测。
- **管理性删失 (Administrative censoring)**：到第90天研究结束时，某用户仍未使用该功能。我们只知道其事件时间大于90天。这个观测在第90天被[右删失](@entry_id:164686)。
- **失访 (Loss to follow-up)**：某用户在第60天注销了账户，且在此之前从未使用过该功能。我们只知道其事件时间（如果发生的话）会大于60天。这个观测在第60天被[右删失](@entry_id:164686)。
- **延迟进入 (Late entry)**：某用户在研究开始后的第75天才注册，到第90天研究结束时仍未使用该功能。该用户从第75天开始处于“风险”中，其观测在第90天被[右删失](@entry_id:164686)。

[Cox模型](@entry_id:164053)以及本章稍后将讨论的[偏似然](@entry_id:165240)估计方法，都经过精心设计，能够正确地处理这些[删失数据](@entry_id:173222)，确保删失的观测值仍然能为其在被观察期间“存活”这一事实贡献信息。

#### 核心组成部分：基准风险与[协变](@entry_id:634097)量效应

[Cox模型](@entry_id:164053) $h(t | \mathbf{X}) = h_0(t) \exp(\boldsymbol{\beta}^T \mathbf{X})$ 的优雅之处在于其对时间和协变量效应的分离。

首先，**基准[风险函数](@entry_id:166593)** $h_0(t)$ 描述了风险如何随时间演变。它代表了一个“基准”个体的风险，即所有[协变](@entry_id:634097)量取值为零的个体的风险。这个基准的定义完全取决于协变量的编码方式。例如，在一个电子商务研究中，模型分析顾客的重复购买行为，[协变](@entry_id:634097)量包括是否为付费会员（$x_1=1$ 表示是，$x_1=0$ 表示否）和收到的[折扣](@entry_id:139170)券金额（$x_2$） [@problem_id:1911764]。在这种情况下，$h_0(t)$ 精确地表示在时间 $t$，一个非付费会员（$x_1=0$）且未收到任何折扣券（$x_2=0$）的顾客，在假定他/她尚未进行重复购买的条件下，发生重复购买的[瞬时速率](@entry_id:182981)。$h_0(t)$ 的形状可以是任意的——它可以随时间增加、减少、保持不变，或者呈现更复杂的模式。

其次，**协变量效应**部分 $\exp(\boldsymbol{\beta}^T \mathbf{X})$ 是一个调节因子，它将基准风险 $h_0(t)$ 向上或向下缩放，具体取决于个体的协变量值。[指数函数](@entry_id:161417) $\exp(\cdot)$ 的使用确保了这个调节因子始终为正，从而保证了总风险 $h(t | \mathbf{X})$ 是非负的。这个部分是模型的“参数”部分，因为它涉及需要从数据中估计的有限数量的参数 $\boldsymbol{\beta}$。

#### 模型的半参数性质

[Cox模型](@entry_id:164053)的这种结构——一个未指定函数形式的非参数部分和一个具有特定函数形式的参数部分——使其成为一个**半参数 (semi-parametric)** 模型 [@problem_id:1911752]。

- **非参数部分**：基准[风险函数](@entry_id:166593) $h_0(t)$。我们不对其随时间变化的具体形式（如指数分布、[威布尔分布](@entry_id:270143)等）做任何预设假定。这种灵活性是[Cox模型](@entry_id:164053)最大的优势之一，因为它使模型能够适应各种 underlying hazard shapes，而无需担心因错误指定基准风险的[分布](@entry_id:182848)而导致模型失当。

- **参数部分**：[协变](@entry_id:634097)量效应 $\exp(\boldsymbol{\beta}^T \mathbf{X})$。模型假定协变量通过一个特定的、由参数 $\boldsymbol{\beta}$ 控制的[对数线性形式](@entry_id:180514)来影响风险。正是这一部分使我们能够估计协变量效应的大小和方向。

这种半参数特性使[Cox模型](@entry_id:164053)在灵活性和可解释性之间取得了理想的平衡。它足够灵活，能够捕捉复杂的时间依赖性，同时又提供了易于解释的参数来量化协变量的影响。

### [比例风险](@entry_id:166780)假定

[Cox模型](@entry_id:164053)之所以被称为“[比例风险](@entry_id:166780)”模型，源于其最核心、也是最具限制性的假定：**[比例风险](@entry_id:166780)假定 (proportional hazards assumption)**。

#### 定义比例性

该假定指出，任意两个个体[风险函数](@entry_id:166593)的比率在所有时间点上都是一个常数。让我们通过比较两个具有不同协变量向量 $\mathbf{X}_A$ 和 $\mathbf{X}_B$ 的个体A和个体B的风险来理解这一点。

它们的[风险函数](@entry_id:166593)分别是：
$h(t | \mathbf{X}_A) = h_0(t) \exp(\boldsymbol{\beta}^T \mathbf{X}_A)$
$h(t | \mathbf{X}_B) = h_0(t) \exp(\boldsymbol{\beta}^T \mathbf{X}_B)$

它们的比率，即**[风险比](@entry_id:173429) (Hazard Ratio, HR)**，为：
$$
\text{HR} = \frac{h(t | \mathbf{X}_A)}{h(t | \mathbf{X}_B)} = \frac{h_0(t) \exp(\boldsymbol{\beta}^T \mathbf{X}_A)}{h_0(t) \exp(\boldsymbol{\beta}^T \mathbf{X}_B)} = \exp(\boldsymbol{\beta}^T (\mathbf{X}_A - \mathbf{X}_B))
$$
正如我们所见，基准[风险函数](@entry_id:166593) $h_0(t)$ 在这个比率中被完全消除了。结果表达式完全不依赖于时间 $t$。这就是[比例风险](@entry_id:166780)的含义：无论是在研究初期、中期还是[末期](@entry_id:169480)，个体A的风险始终是个体B风险的某个固定倍数。它们的风险曲线在对数尺度上是平行且垂直间隔固定的。

#### 将系数解释为对数[风险比](@entry_id:173429)

[比例风险](@entry_id:166780)假定使得模型系数 $\beta$ 的解释变得直观。考虑一个只含单个连续协变量 $X$ 的简单模型 $h(t|X) = h_0(t) \exp(\beta X)$ [@problem_id:1911757]。比较[协变](@entry_id:634097)量值为 $x+1$ 和 $x$ 的两个个体，其[风险比](@entry_id:173429)为：
$$
\text{HR} = \frac{h(t | x+1)}{h(t | x)} = \frac{h_0(t) \exp(\beta (x+1))}{h_0(t) \exp(\beta x)} = \frac{\exp(\beta x) \exp(\beta)}{\exp(\beta x)} = \exp(\beta)
$$
这表明，[协变](@entry_id:634097)量 $X$ 每增加一个单位，风险就乘以一个因子 $\exp(\beta)$。因此，$\beta$ 本身可以被解释为与 $X$ 单位增加相关联的**对数[风险比](@entry_id:173429) (log-hazard ratio)**。
- 如果 $\beta > 0$，则 $\exp(\beta) > 1$，表明协变量增加会提高事件风险。
- 如果 $\beta  0$，则 $\exp(\beta)  1$，表明[协变](@entry_id:634097)量增加会降低事件风险（即具有保护作用）。
- 如果 $\beta = 0$，则 $\exp(\beta) = 1$，表明[协变](@entry_id:634097)量对风险没有影响。

我们可以将此逻辑应用于更复杂的场景。例如，在一个临床研究中，模型为 $h(t | \mathbf{X}) = h_0(t) \exp(\beta_1 X_1 + \beta_2 X_2)$，其中 $X_1$ 是治疗组（1=新药，0=安慰剂），$X_2$ 是年龄（相对于平均年龄50岁的中心化值）。假设估计的系数为 $\beta_1 = -0.450$ 和 $\beta_2 = 0.020$ [@problem_id:1911710]。现在比较两位患者：患者A（60岁，服用新药）和患者B（45岁，服用安慰剂）。

患者A的协变量为 $X_{1A}=1, X_{2A}=60-50=10$。
患者B的[协变](@entry_id:634097)量为 $X_{1B}=0, X_{2B}=45-50=-5$。

患者[A相](@entry_id:195484)对于患者B的[风险比](@entry_id:173429)为：
$$
\text{HR}_{A \text{ vs } B} = \exp(\beta_1(X_{1A} - X_{1B}) + \beta_2(X_{2A} - X_{2B})) = \exp(-0.450(1-0) + 0.020(10 - (-5)))
$$
$$
= \exp(-0.450 + 0.020 \times 15) = \exp(-0.450 + 0.300) = \exp(-0.150) \approx 0.861
$$
这意味着在任何时间点 $t$，患者A的康复风险（事件）大约是患者B的86.1%。

#### [比例风险](@entry_id:166780)假定的违背

尽管[比例风险](@entry_id:166780)假定非常方便，但在现实世界中它并不总是成立。当一个[协变](@entry_id:634097)量对风险的影响随时间变化时，该假定就被违背了。

一个经典的例子是比较两种[癌症治疗](@entry_id:139037)方案：一种是高风险的积极手术，另一种是标准的药物治疗 [@problem_id:1911730]。
- **手术组**：术后短期内，由于并发症风险，死亡风险可能很高，但随着时间推移，如果手术成功，长期风险会降至很低水平。其[风险函数](@entry_id:166593) $h_T(t)$ 可能呈指数衰减状。
- **药物组**：初期风险较低，但随着时间推移，药物可能失效或产生[耐药性](@entry_id:261859)，导致风险逐渐增加。其[风险函数](@entry_id:166593) $h_C(t)$ 可能呈线性增加状。

在这种情况下，[风险比](@entry_id:173429) $\frac{h_T(t)}{h_C(t)} = \frac{A \exp(-kt) + C_1}{Bt + C_2}$ 显然依赖于时间 $t$，因此[比例风险](@entry_id:166780)假定被违背。它们的风险曲线可能会[交叉](@entry_id:147634)：手术在短期内风险更高，但在长期内风险更低。

检查[比例风险](@entry_id:166780)假定是[Cox模型](@entry_id:164053)应用中的一个关键步骤。一个常用的诊断工具是**Schoenfeld[残差图](@entry_id:169585)**。该图将每个事件的Schoenfeld残差与时间（或时间的某个函数，如[对数时间](@entry_id:636778)）绘制出来。如果[比例风险](@entry_id:166780)假定成立，残差应该随机散布在零线周围。如果图中出现明显的趋势（例如，拟合的回归线有显著的非零斜率），则表明相应协变量的效应是随时间变化的，从而违背了[比例风险](@entry_id:166780)假定 [@problem_id:1911774]。例如，如果在一个客户流失模型中，促销活动[协变](@entry_id:634097)量的Schoenfeld[残差图](@entry_id:169585)显示出显著的正斜率，这表明该促销活动的效应随时间变化。具体来说，促销活动对留存用户的“保护”作用随着时间的推移而减弱，导致促销组相对于非促销组的流失[风险比](@entry_id:173429)随时间增加。

### 通过[偏似然](@entry_id:165240)进行参数估计

既然[Cox模型](@entry_id:164053)包含一个未知的非参数部分 $h_0(t)$，我们如何估计参数 $\boldsymbol{\beta}$ 呢？答案在于一种巧妙的方法，称为**[偏似然](@entry_id:165240) (partial likelihood)**。

#### [偏似然](@entry_id:165240)的直观理解

[偏似然](@entry_id:165240)法的核心思想是，不尝试构建包含未知函数 $h_0(t)$ 的完整似然函数，而是构建一个只依赖于 $\boldsymbol{\beta}$ 的“部分”[似然](@entry_id:167119)。这是通过在每个事件发生的时间点，只关注事件发生的相对概率来实现的。

想象一下，在时间 $t_j$，一个事件发生在个体 $j$ 身上。在这一刻，还有一群其他个体也处于“风险”之中——也就是说，他们在那一刻之前既没有发生事件也没有被删失。这个群体被称为**风险集 (risk set)**，记为 $R(t_j)$。

[偏似然](@entry_id:165240)的思想是，在给定 $t_j$ 时刻有一个事件发生且风险集为 $R(t_j)$ 的条件下，计算这个事件恰好发生在个体 $j$ 身上的[条件概率](@entry_id:151013)。这个概率可以看作是个体 $j$ 的风险在风险集中所有个体总风险中所占的比例。

构建风险集是[偏似然](@entry_id:165240)法的关键一步。风险集 $R(t_j)$ 包含了在时间 $t_j$ 仍处于观察中且事件尚未发生的所有个体，包括将在 $t_j$ 时刻经历事件的个体本身。重要的是，那些在 $t_j$ 之前被删失的个体，虽然没有经历事件，但他们在被删失之前的时间里，都曾是风险集的成员，并为较早发生的事件的分母提供了信息 [@problem_id:1911718]。例如，在一个临床试验中，事件发生在第9个月时，一个在第7个月失访的患者将不包含在第9个月的风险集中，但一个在第12个月研究结束时仍存活的患者（删失在12个月）则包含在第9个月的风险集中。

#### 构建偏似然函数

在时间 $t_{(j)}$ 发生了一个事件（假设没有重复时间），事件发生在个体 $j$ 身上。风险集为 $R(t_{(j)})$。那么，在给定风险集中发生一个事件的条件下，事件发生在个体 $j$ 身上的[条件概率](@entry_id:151013)是：

$$
P(\text{个体 } j \text{ 在 } t_{(j)} \text{ 发生事件} | \text{一个事件在 } t_{(j)} \text{ 发生于 } R(t_{(j)})) = \frac{\text{个体 } j \text{ 的风险}}{\sum_{k \in R(t_{(j)})} \text{个体 } k \text{ 的风险}}
$$

代入[Cox模型](@entry_id:164053)的形式：

$$
= \frac{h(t_{(j)} | \mathbf{X}_j)}{\sum_{k \in R(t_{(j)})} h(t_{(j)} | \mathbf{X}_k)} = \frac{h_0(t_{(j)}) \exp(\boldsymbol{\beta}^T \mathbf{X}_j)}{\sum_{k \in R(t_{(j)})} h_0(t_{(j)}) \exp(\boldsymbol{\beta}^T \mathbf{X}_k)}
$$

在这里，神奇的事情发生了：未知的基准[风险函数](@entry_id:166593) $h_0(t_{(j)})$ 作为分子和分母的公因子被约掉了！[@problem_id:1911762]

$$
= \frac{\exp(\boldsymbol{\beta}^T \mathbf{X}_j)}{\sum_{k \in R(t_{(j)})} \exp(\boldsymbol{\beta}^T \mathbf{X}_k)}
$$

这个表达式只依赖于需要估计的参数 $\boldsymbol{\beta}$ 和数据。**Cox偏[似然函数](@entry_id:141927)** $L(\boldsymbol{\beta})$ 就是将所有 $k$ 个独立事件的这些条件概率项连乘起来：

$$
L(\boldsymbol{\beta}) = \prod_{j=1}^{k} \frac{\exp(\boldsymbol{\beta}^T \mathbf{X}_{(j)})}{\sum_{i \in R(t_{(j)})} \exp(\boldsymbol{\beta}^T \mathbf{X}_i)}
$$

其中 $\mathbf{X}_{(j)}$ 是在第 $j$ 个有序事件时间 $t_{(j)}$ 经历事件的个体的[协变](@entry_id:634097)量向量。通过最大化这个偏[似然函数](@entry_id:141927)（通常是其对数形式），我们就可以得到 $\boldsymbol{\beta}$ 的估计值，而完全无需知道或估计 $h_0(t)$。

#### 更深层次的视角：作为[剖面似然](@entry_id:269700)的[偏似然](@entry_id:165240)

虽然上述推导直观地解释了[偏似然](@entry_id:165240)的构造，但它也可以从一个更严谨的统计理论框架——**[剖面似然](@entry_id:269700) (profile likelihood)**——中导出 [@problem_id:1911739]。

我们可以将基准风险建模为一个在每个事件时间 $t_{(j)}$ 都有离散“跳跃” $\lambda_j$ 的阶梯函数。在这种参数化下，可以写出一个包含参数 $\boldsymbol{\beta}$ 和所有 nuisance parameters $\lambda_j$ 的完整似然函数。接下来，对于一个固定的 $\boldsymbol{\beta}$，我们可以通过求解 $\frac{\partial L}{\partial \lambda_j} = 0$ 来最大化这个完整似然函数，从而得到 $\lambda_j$ 的最优解 $\hat{\lambda}_j(\boldsymbol{\beta})$。将这些解代回到完整似然函数中，我们就得到了只关于 $\boldsymbol{\beta}$ 的[剖面似然](@entry_id:269700)函数 $L_p(\boldsymbol{\beta})$。

经过推导可以证明，这个[剖面似然](@entry_id:269700)函数与Cox偏[似然函数](@entry_id:141927)成正比：
$$
L_p(\boldsymbol{\beta}) \propto \prod_{j=1}^{k} \frac{\exp(\boldsymbol{\beta}^T \mathbf{X}_{(j)})}{\sum_{i \in R(t_{(j)})} \exp(\boldsymbol{\beta}^T \mathbf{X}_i)}
$$
这一结果为[偏似然](@entry_id:165240)法提供了坚实的理论基础，表明它等价于在一个更一般的似然框架下，将未知的基准风险“剖面化”处理掉。

总之，本章阐述了[Cox模型](@entry_id:164053)的核心原理。我们理解了其半参数结构，掌握了其核心的[比例风险](@entry_id:166780)假定及其解释，并深入探讨了允许我们在不指定基准风险的情况下估计协变量效应的[偏似然](@entry_id:165240)方法。掌握了这些原理与机制，我们便为在下一章中学习模型的实际应用、诊断和扩展做好了准备。