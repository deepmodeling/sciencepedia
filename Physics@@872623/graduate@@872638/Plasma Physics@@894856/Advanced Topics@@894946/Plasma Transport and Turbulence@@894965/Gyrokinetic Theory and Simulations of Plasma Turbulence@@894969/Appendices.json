{"hands_on_practices": [{"introduction": "The delta-f ($\\delta f$) method is a powerful variance-reduction technique for simulating small perturbations around a known equilibrium. Instead of evolving the full distribution function $f$, we evolve only the perturbation $\\delta f$ by assigning weights to simulation markers that sample the background distribution $f_0$. This exercise [@problem_id:264074] explores the crucial first step of any $\\delta f$ simulation: initialization. You will derive the condition on the initial particle weights needed to represent a pure temperature perturbation, ensuring the initial perturbed density $\\delta n$ is zero, a common requirement for studying temperature-gradient-driven turbulence.", "problem": "In the delta-f ($\\delta f$) particle-in-cell (PIC) method for plasma simulation, the total distribution function, $f$, is decomposed into a large, stationary background component, $f_0$, and a small, evolving perturbation, $\\delta f$, such that $f = f_0 + \\delta f$. The simulation tracks the evolution of marker particles, which sample the phase space according to the background distribution $f_0$. Each marker particle, labeled $p$, is assigned a weight, $w_p$, defined as the ratio of the perturbation to the background distribution at the particle's phase-space position $\\mathbf{Z}_p$:\n$$w_p(t) = \\frac{\\delta f(\\mathbf{Z}_p, t)}{f_0(\\mathbf{Z}_p)}$$\nThe perturbed number density, $\\delta n$, is a moment of the perturbed distribution function, given by the integral over velocity space:\n$$\\delta n(\\mathbf{x}, t) = \\int \\delta f(\\mathbf{x}, \\mathbf{v}, t) d^3v$$\nConsider a spatially homogeneous, unmagnetized plasma where the background distribution function $f_0$ for a given species is a 3D Maxwellian:\n$$f_0(\\mathbf{v}) = n_0 \\left(\\frac{m}{2\\pi T_0}\\right)^{3/2} \\exp\\left(-\\frac{m|\\mathbf{v}|^2}{2T_0}\\right)$$\nHere, $n_0$ is the equilibrium number density, $m$ is the mass of the particles, and $T_0$ is the equilibrium temperature in energy units.\n\nA simulation is to be initialized with a specific type of perturbation that corresponds to a pure temperature perturbation, without any associated density perturbation. To achieve this, the initial weights of the simulation particles are set according to the following form, which depends on the particle's kinetic energy:\n$$w_p = A\\left(\\frac{m v_p^2}{2 T_0} - C\\right)$$\nwhere $v_p=|\\mathbf{v}_p|$ is the speed of particle $p$, $A$ is an arbitrary non-zero amplitude constant, and $C$ is a dimensionless constant.\n\nAssuming the particle loading at time $t=0$ provides a perfect sampling of the continuous background distribution $f_0$, derive the exact numerical value of the constant $C$ required to ensure that the initial perturbed number density, $\\delta n$, is zero everywhere in space.", "solution": "We require the initial perturbed density \n$$\\delta n \\;=\\;\\int \\delta f\\,d^3v \\;=\\;\\int w(\\mathbf v)\\,f_0(\\mathbf v)\\,d^3v \\;=\\;0.$$\nSince $w(\\mathbf v)=A\\bigl(\\frac{m v^2}{2T_0}-C\\bigr)$ and $A\\neq0$, we have\n$$\\int\\!f_0\\frac{m v^2}{2T_0}\\,d^3v \\;-\\;C\\int\\!f_0\\,d^3v \\;=\\;0.$$\nEvaluate the moments of the Maxwellian:\n$$\\int f_0\\,d^3v = n_0,$$\n$$\\int f_0\\,\\frac{m v^2}{2}\\,d^3v = \\frac{3}{2}n_0T_0\n\\quad\\Longrightarrow\\quad\n\\int f_0\\,\\frac{m v^2}{2T_0}\\,d^3v = \\frac{3}{2}n_0.$$\nHence\n$$C = \\frac{\\displaystyle\\int f_0\\,\\frac{m v^2}{2T_0}\\,d^3v}{\\displaystyle\\int f_0\\,d^3v}\n= \\frac{\\frac{3}{2}n_0}{n_0} = \\frac{3}{2}.$$", "answer": "$$\\boxed{\\frac{3}{2}}$$", "id": "264074"}, {"introduction": "A cornerstone of gyrokinetic theory is the concept of gyroaveraging, which accounts for the finite Larmor radius (FLR) effect on how particles experience turbulent fields. This physical effect is mathematically represented by the zeroth-order Bessel function $J_0(k_\\perp \\rho)$ in Fourier space. In this problem [@problem_id:263858], you will tackle the practical task of designing a high-fidelity numerical representation of this operator for a grid-based simulation, deriving the coefficients for a fourth-order accurate finite-difference stencil.", "problem": "In gyrokinetic simulations of magnetically confined plasmas, the effect of the finite Larmor radius (FLR) of particles is captured by the gyroaveraging operator. In Fourier space, for a fluctuating quantity $\\phi$, this operation corresponds to multiplying its perpendicular wavevector component $\\hat{\\phi}(\\mathbf{k}_\\perp)$ by the zeroth-order Bessel function of the first kind, $J_0(k_\\perp \\rho)$, where $k_\\perp=|\\mathbf{k}_\\perp|$ is the perpendicular wavenumber and $\\rho$ is the particle Larmor radius.\n\nFor numerical implementation on a spatial grid, this operator must be approximated using a finite-difference scheme. Consider a one-dimensional problem where quantities vary only in the $x$-direction, such that $k_\\perp = k_x$. The grid has a uniform spacing $\\Delta x$. We wish to construct a symmetric, 5-point finite-difference stencil to approximate the gyroaveraging operator. The action of this finite-difference operator, $\\mathcal{J}_{FD}$, on the field $\\phi$ at a grid point $x_i$ is given by:\n$$\n(\\mathcal{J}_{FD}\\phi)_i = c_2 \\phi_{i-2} + c_1 \\phi_{i-1} + c_0 \\phi_i + c_1 \\phi_{i+1} + c_2 \\phi_{i+2}\n$$\nThe Fourier representation (or symbol) of this stencil is:\n$$\n\\widehat{\\mathcal{J}_{FD}}(k_x) = c_0 + 2c_1\\cos(k_x \\Delta x) + 2c_2\\cos(2k_x \\Delta x)\n$$\nTo determine the coefficients $c_0, c_1, c_2$, we demand that the Taylor series expansion of $\\widehat{\\mathcal{J}_{FD}}(k_x)$ in powers of $k_x$ matches the expansion of the exact operator $J_0(k_x \\rho)$ up to the fourth order in $k_x$. This ensures the scheme is fourth-order accurate.\n\nThe relevant Taylor series expansions are:\n$$\nJ_0(z) = 1 - \\frac{z^2}{4} + \\frac{z^4}{64} - \\mathcal{O}(z^6)\n$$\n$$\n\\cos(u) = 1 - \\frac{u^2}{2!} + \\frac{u^4}{4!} - \\mathcal{O}(u^6)\n$$\nLet the dimensionless parameter $b = \\left(\\frac{\\rho}{\\Delta x}\\right)^2$.\n\nDerive the coefficient $c_1$ for this fourth-order finite-difference scheme as a function of the parameter $b$.", "solution": "We match the Taylor expansion of \n$$\\widehat{\\mathcal{J}_{FD}}(k_x)=c_0+2c_1\\cos(u)+2c_2\\cos(2u),\\quad u=k_x\\Delta x$$ \nto that of \n$$J_0(k_x\\rho)=1-\\frac{(k_x\\rho)^2}{4}+\\frac{(k_x\\rho)^4}{64}+\\mathcal{O}(k_x^6)$$ \nwith $b=(\\rho/\\Delta x)^2$, so $k_x\\rho=u\\sqrt b$.\n\n1. Expand the stencil symbol to fourth order in $u$:\n$$\\cos(u)=1-\\frac{u^2}{2}+\\frac{u^4}{24},\\quad\n\\cos(2u)=1-2u^2+\\frac{2u^4}{3}.$$\nHence\n$$\\widehat{\\mathcal{J}_{FD}}=c_0+2c_1\\Bigl(1-\\frac{u^2}{2}+\\frac{u^4}{24}\\Bigr)\n+2c_2\\Bigl(1-2u^2+\\frac{2u^4}{3}\\Bigr)+\\mathcal{O}(u^6).$$\n\n2. Collect coefficients:\nConstant: $c_0+2c_1+2c_2=1.$  \n$u^2$ term: $-c_1-4c_2=-\\frac b4.$  \n$u^4$ term: $\\frac{c_1}{12}+\\frac{4c_2}{3}=\\frac{b^2}{64}.$\n\n3. Solve the linear system. From\n$$c_1+4c_2=\\frac b4,\\quad c_1+16c_2=\\frac{3b^2}{16},$$\nsubtracting gives \n$$12c_2=\\frac{3b^2-4b}{16},\\quad c_2=\\frac{3b^2-4b}{192}.$$\nThen \n$$c_1=\\frac b4-4c_2=\\frac{12b-(3b^2-4b)}{48}=\\frac{16b-3b^2}{48}.$$", "answer": "$$\\boxed{\\frac{b(16 - 3b)}{48}}$$", "id": "263858"}, {"introduction": "While powerful, particle-based simulations are inherently subject to statistical noise, which can obscure the physical quantities we aim to measure, such as the turbulent heat flux $Q_s$. This exercise [@problem_id:263876] introduces the sophisticated control variate method, a variance-reduction technique crucial for modern gyrokinetic codes. You will derive the optimal form of a control variate function that dramatically reduces the noise in the heat flux diagnostic by exploiting known properties of the background distribution and the governing equations.", "problem": "In gyrokinetic $\\delta f$ particle-in-cell (PIC) simulations of plasma turbulence, a key diagnostic is the turbulent heat flux, which for a species $s$ is given by the turbulent correlation $Q_s = \\left\\langle \\int (\\frac{1}{2}m_s v^2) (\\mathbf{v}_E \\cdot \\hat{\\mathbf{r}}) \\delta f_s \\, d^6z \\right\\rangle$. Here, $m_s$ is the particle mass, $\\mathbf{v}_E$ is the $\\mathbf{E}\\times\\mathbf{B}$ drift velocity, $\\hat{\\mathbf{r}}$ is the unit vector in the direction of transport (e.g., radial), $\\delta f_s$ is the perturbed part of the distribution function, $d^6z$ is the phase-space volume element, and $\\langle\\dots\\rangle$ denotes an ensemble or time average. In a PIC simulation, this integral is estimated by a sum over marker particles: $\\hat{Q}_s \\approx \\sum_i w_i H(\\mathbf{z}_i)$, where $w_i$ is the particle weight and $H(\\mathbf{z}) = (\\frac{1}{2} m_s v^2) (\\mathbf{v}_E \\cdot \\hat{\\mathbf{r}})$ is the diagnostic phase-space function.\n\nThis diagnostic is often very noisy. The control variate method can be used to reduce the statistical variance. A modified diagnostic integrand $H' = H - C$ is used, where $C(\\mathbf{z})$ is a control variate function. For the modified estimator to be unbiased, the time-averaged contribution from the control variate must be zero, i.e., $\\langle \\int C \\delta f_s \\, d^6z \\rangle = 0$.\n\nA powerful way to construct such a $C$ is to relate it to the source of the particle weight evolution. In the collisionless, electrostatic limit, the weight $w = \\delta f/f_0$ evolves according to $\\frac{dw}{dt} = S_w$, where $S_w = -\\frac{1}{f_0}(\\mathbf{v}_E \\cdot \\nabla f_0)$. By choosing a control variate of the form $C(\\mathbf{z}) = \\alpha S_w(\\mathbf{z})$, where $\\alpha$ is a constant, the unbiased condition is satisfied for a turbulent steady state.\n\nThe optimal coefficient $\\alpha$ is the one that minimizes the variance of the diagnostic. This variance is proportional to the phase-space average of the squared diagnostic integrand, weighted by the background distribution $f_0$ from which particles are sampled. Thus, $\\alpha$ is found by minimizing the functional:\n$$\n\\mathcal{J}[\\alpha] = \\int [H(\\mathbf{z}) - \\alpha S_w(\\mathbf{z})]^2 f_0(\\mathbf{z}) \\, d^6z\n$$\n\n**Problem:**\n\nConsider a single ion species in a local slab geometry with a uniform magnetic field $\\mathbf{B} = B\\hat{\\mathbf{z}}$. The background distribution $f_0$ is a Maxwellian, whose density $n_0(x)$ and temperature $T_0(x)$ vary in the radial ($x$) direction. These variations are characterized by constant inverse gradient scale lengths, $\\kappa_n = -d(\\ln n_0)/dx$ and $\\kappa_T = -d(\\ln T_0)/dx$. The radial component of the $\\mathbf{E}\\times\\mathbf{B}$ drift is denoted by $v_{Ex}$. The particle kinetic energy is $E_{\\text{kin}} = \\frac{1}{2}mv^2$. The heat flux diagnostic function is $H = E_{\\text{kin}} v_{Ex}$.\n\nDerive the optimal coefficient $\\alpha$ for the control variate function $C = \\alpha S_w$. Express your final answer in terms of the background temperature $T_0$, and the gradient scale lengths $\\kappa_n$ and $\\kappa_T$.", "solution": "We seek the coefficient Î± minimizing\n$$\n\\mathcal{J}[\\alpha]=\\int\\bigl[H(\\mathbf z)-\\alpha S_w(\\mathbf z)\\bigr]^2f_0(\\mathbf z)\\,d^6z\n$$\nso that\n$$\n\\alpha=\\frac{\\displaystyle\\int H\\,S_w\\,f_0\\,d^6z}{\\displaystyle\\int S_w^2\\,f_0\\,d^6z}\\,.\n$$\n\n1. Background Maxwellian:\n$$\nf_0=n_0(x)\\biggl(\\frac{m}{2\\pi T_0(x)}\\biggr)^{3/2}e^{-E_{\\rm kin}/T_0(x)}\\,,\n\\quad\nE_{\\rm kin}=\\tfrac12mv^2\\,.\n$$\nDefine inverse scale lengths $\\kappa_n=-d\\ln n_0/dx$, $\\kappa_T=-d\\ln T_0/dx$.\n\n2. Compute \n$$\n\\frac{1}{f_0}\\frac{df_0}{dx}\n=\\frac{d\\ln f_0}{dx}\n=-\\kappa_n+\\tfrac32\\kappa_T-\\frac{E_{\\rm kin}}{T_0}\\kappa_T\n=-\\Bigl[\\kappa_n+\\kappa_T\\bigl(\\tfrac{E_{\\rm kin}}{T_0}-\\tfrac32\\bigr)\\Bigr].\n$$\nThus\n$$\nS_w=-\\frac1{f_0}v_{Ex}\\frac{df_0}{dx}\n=v_{Ex}\\Bigl[\\kappa_n+\\kappa_T\\bigl(\\tfrac{E_{\\rm kin}}{T_0}-\\tfrac32\\bigr)\\Bigr],\n\\quad\nH=E_{\\rm kin}\\,v_{Ex}.\n$$\n\n3. Factor out $v_{Ex}^2$ and integrate over velocity space:\nlet \n$$A=\\kappa_n,\\quad B=\\kappa_T,\n$$\nand moments\n$$\n\\int f_0\\,d^3v=n_0,\\quad\n\\int E_{\\rm kin}f_0\\,d^3v=\\tfrac32n_0T_0,\\quad\n\\int E_{\\rm kin}^2f_0\\,d^3v=\\tfrac{15}{4}n_0T_0^2.\n$$\n\nNumerator:\n\n$$\n\\begin{aligned}\nN&=\\int E_{\\rm kin}v_{Ex}^2\\bigl[A+B(\\tfrac{E_{\\rm kin}}{T_0}-\\tfrac32)\\bigr]f_0\\,d^3v\\,d^3x\\\\\n&\\propto A\\!\\int E_{\\rm kin}f_0\\,d^3v\n+B\\!\\int\\Bigl(\\tfrac{E_{\\rm kin}^2}{T_0}-\\tfrac32E_{\\rm kin}\\Bigr)f_0\\,d^3v\n=n_0T_0\\Bigl(\\tfrac32A+\\tfrac32B\\Bigr).\n\\end{aligned}\n$$\n\n\nDenominator:\n\n$$\n\\begin{aligned}\nD&=\\int v_{Ex}^2\\bigl[A+B(\\tfrac{E_{\\rm kin}}{T_0}-\\tfrac32)\\bigr]^2f_0\\,d^3v\\,d^3x\\\\\n&\\propto A^2n_0+B^2\\!\\int(\\tfrac{E_{\\rm kin}}{T_0}-\\tfrac32)^2f_0\\,d^3v\n=n_0\\Bigl(A^2+\\tfrac32B^2\\Bigr).\n\\end{aligned}\n$$\n\n\nHence\n$$\n\\alpha=\\frac{N}{D}\n=\\frac{\\tfrac32\\,n_0T_0\\,(A+B)}{n_0\\,(A^2+\\tfrac32B^2)}\n=\\frac{\\tfrac32T_0(\\kappa_n+\\kappa_T)}{\\kappa_n^2+\\tfrac32\\kappa_T^2}\n=\\frac{3T_0(\\kappa_n+\\kappa_T)}{2\\kappa_n^2+3\\kappa_T^2}.\n$$", "answer": "$$\\boxed{\\frac{3T_0(\\kappa_n+\\kappa_T)}{2\\kappa_n^2+3\\kappa_T^2}}$$", "id": "263876"}]}