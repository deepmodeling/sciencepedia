{
    "hands_on_practices": [
        {
            "introduction": "背景选择的根本驱动力是针对有害突变的净化选择。要理解背景选择，我们必须首先掌握突变和选择如何相互作用，共同决定这些有害等位基因的频率。本练习将引导你推导突变-选择平衡这一基本概念。通过推导平衡频率，你将从第一性原理层面理解群体中清除有害突变的作用力，这是量化其对连锁中性位点多样性影响的必要起点。",
            "id": "2693173",
            "problem": "一个单一、随机交配、有效种群大小无限的混合种群，拥有一个双等位基因座，等位基因为 $A$ (野生型) 和 $a$ (有害)。生存力选择的作用下，适应度分别为 $w_{AA}=1$、$w_{Aa}=1-hs$ 和 $w_{aa}=1-s$，其中 $s \\in (0,1]$ 是针对纯合子的选择系数，$h \\in (0,1]$ 是显性系数。从 $A$ 到 $a$ 的正向突变以每个基因拷贝每代 $u$ 的速率发生，没有反向突变。假设每代都进行随机交配，使得选择前的基因型频率符合哈代-温伯格平衡比例。设 $q$ 表示某一代中选择前的等位基因 $a$ 的频率。\n\n从这些假设以及标准的确定性生存力选择和突变递推式出发，推导在突变-选择平衡下，当有害等位基因为半显性（即 $h>0$）时，其平衡频率 $\\hat{q}$ 的前导渐近表达式（对小量取一阶近似）。你的推导必须明确：\n- 写出结合选择和突变后，$q$ 跨越一代的精确递推式。\n- 在 $q$ 很小且 $u$ 很小的范围内，对此递推式进行线性化，仅保留至一阶项，并舍弃在明确说明的条件下可忽略的高阶项。\n- 通过将 $q$ 跨越一代的变化量设为零，并求解得到的近似方程，来解出 $\\hat{q}$。\n\n陈述该近似有效的生物学和数学条件，包括 $u$、$h$ 和 $s$ 之间的关系以及关于种群遗传过程的假设。将 $\\hat{q}$ 的最终结果表示为包含 $u$、$h$ 和 $s$ 的符号表达式。不需要进行数值计算，也不需要报告单位。",
            "solution": "问题要求在突变-选择平衡下，半显性有害等位基因平衡频率的前导渐近表达式。我们首先验证问题陈述的合理性。\n\n已知条件如下：\n- 一个单一、随机交配、有效种群大小无限的混合种群。\n- 一个双等位基因座，等位基因为 $A$ (野生型) 和 $a$ (有害)。\n- 生存力适应度：$w_{AA}=1$、$w_{Aa}=1-hs$ 和 $w_{aa}=1-s$。\n- 选择系数 $s \\in (0,1]$。\n- 显性系数 $h \\in (0,1]$。\n- 正向突变率（$A \\to a$）为每个基因拷贝每代 $u$。\n- 无反向突变（$a \\to A$）。\n- 生命周期顺序：随机交配，然后选择，然后突变。\n- $q$ 是选择前等位基因 $a$ 的频率。\n\n该问题具有科学依据，表述清晰且客观。它代表了群体遗传学中的一个经典模型，并为确定性推导提供了所有必要信息。这些假设是用于研究突变和选择相互作用的标准简化。因此，该问题是有效的，我们可以继续进行求解。\n\n推导过程按要求分为三个主要步骤。\n\n首先，我们建立有害等位基因频率 $q$ 从一代到下一代的精确递推式。设 $q_t$ 为一代开始时（选择前）等位基因 $a$ 的频率。由于随机交配，基因型频率由哈代-温伯格平衡比例给出：\n- $AA$ 的频率：$(1-q_t)^2$\n- $Aa$ 的频率：$2q_t(1-q_t)$\n- $aa$ 的频率：$q_t^2$\n\n选择根据各个基因型的适应度对其产生作用。种群的平均适应度 $\\bar{w}$ 是由各基因型频率加权的适应度平均值：\n$$\n\\bar{w} = (1-q_t)^2 w_{AA} + 2q_t(1-q_t) w_{Aa} + q_t^2 w_{aa}\n$$\n代入给定的适应度值：\n$$\n\\bar{w} = (1-q_t)^2 (1) + 2q_t(1-q_t) (1-hs) + q_t^2 (1-s)\n$$\n展开此表达式可得：\n$$\n\\bar{w} = (1 - 2q_t + q_t^2) + (2q_t - 2q_t^2)(1-hs) + q_t^2(1-s)\n$$\n$$\n\\bar{w} = 1 - 2q_t + q_t^2 + 2q_t - 2hsq_t - 2q_t^2 + 2hsq_t^2 + q_t^2 - sq_t^2\n$$\n$$\n\\bar{w} = 1 - 2hsq_t - (s - 2hs)q_t^2\n$$\n选择后，等位基因 $a$ 的频率（记为 $q'_t$）是其在纯合子（$aa$）和杂合子（$Aa$）个体中频率的总和，按其选择后频率加权：\n$$\nq'_t = \\frac{q_t^2 w_{aa} + q_t(1-q_t) w_{Aa}}{\\bar{w}} = \\frac{q_t^2(1-s) + q_t(1-q_t)(1-hs)}{\\bar{w}}\n$$\n$$\nq'_t = \\frac{q_t^2 - sq_t^2 + q_t - q_t^2 - hsq_t + hsq_t^2}{\\bar{w}} = \\frac{q_t(1-hs) - (s-hs)q_t^2}{\\bar{w}}\n$$\n选择之后，发生突变。新的等位基因 $a$ 以速率 $u$ 从等位基因 $A$ 产生。选择后等位基因 $A$ 的频率是 $1-q'_t$。下一代中等位基因 $a$ 的频率 $q_{t+1}$ 是：\n$$\nq_{t+1} = q'_t + u(1-q'_t) = q'_t(1-u) + u\n$$\n代入 $q'_t$ 的表达式，我们得到精确的递推式：\n$$\nq_{t+1} = (1-u) \\left( \\frac{q_t(1-hs) - (s-hs)q_t^2}{1 - 2hsq_t - (s-2hs)q_t^2} \\right) + u\n$$\n\n第二，我们在线性化此递推式，其假设是突变率 $u$ 很小，因此有害等位基因频率 $q_t$ 也很小。我们分析每代的等位基因频率变化 $\\Delta q = q_{t+1} - q_t$。\n$$\n\\Delta q = q'_{t}(1-u) + u - q_t = (q'_{t} - q_t) - u q'_{t} + u\n$$\n项 $q'_{t} - q_t$ 代表由选择引起的变化 $\\Delta q_{sel}$。对于小的 $q_t$，我们可以近似这个变化。\n$$\n\\Delta q_{sel} = q'_{t} - q_t = \\frac{q_t(1-hs) - (s-hs)q_t^2}{\\bar{w}} - q_t\n$$\n使用对于小 $q_t$ 的近似 $\\bar{w} \\approx 1-2hsq_t$，以及对于小 $x$ 的几何级数近似 $1/(1-x) \\approx 1+x$：\n$$\n\\Delta q_{sel} \\approx (q_t(1-hs) - O(q_t^2))(1+2hsq_t + O(q_t^2)) - q_t\n$$\n$$\n\\Delta q_{sel} \\approx (q_t - hsq_t)(1+2hsq_t) - q_t + O(q_t^2)\n$$\n$$\n\\Delta q_{sel} \\approx q_t + 2hsq_t^2 - hsq_t - 2h^2s^2q_t^2 - q_t + O(q_t^2)\n$$\n仅保留 $q_t$ 的最低阶项（线性项），我们得到：\n$$\n\\Delta q_{sel} \\approx -hsq_t\n$$\n这就是由选择引起的线性化变化。它表明对于半显性等位基因（$h>0$），选择以与其频率成正比的速率移除该等位基因。\n\n现在，我们近似总变化 $\\Delta q$。\n$$\n\\Delta q = \\Delta q_{sel} - u q'_{t} + u\n$$\n由于 $q_t$ 很小，选择的影响也很小，所以 $q'_t \\approx q_t$。因此，一阶近似为：\n$$\n\\Delta q \\approx -hsq_t - uq_t + u\n$$\n在突变-选择平衡时，由突变产生新等位基因的输入被选择的清除所抵消。平衡频率 $\\hat{q}$ 将会很小，与 $u$ 处于同一数量级。如果我们假设 $u$ 是一个小参数，那么 $\\hat{q}$ 的数量级是 $O(u)$。我们来分析一下 $\\Delta q$ 表达式中各项的量级：\n- $u$：数量级为 $O(u)$\n- $-hsq_t$：数量级为 $O(u)$，因为 $q_t \\sim O(u)$ 且 $h,s \\sim O(1)$\n- $-uq_t$：数量级为 $O(u^2)$，因为 $u \\sim O(u)$ 且 $q_t \\sim O(u)$\n\n为了得到前导阶近似（对小参数 $u$ 取一阶），我们保留 $O(u)$ 数量级的项，并舍弃如 $O(u^2)$ 的高阶项。这就得到了等位基因频率变化的线性化方程：\n$$\n\\Delta q \\approx u - hsq_t\n$$\n\n第三，我们求解平衡频率 $\\hat{q}$。在平衡状态下，等位基因频率不发生变化，因此 $\\Delta q = 0$。\n$$\n0 = u - hs\\hat{q}\n$$\n求解 $\\hat{q}$ 得到半显性有害等位基因的经典结果：\n$$\nhs\\hat{q} = u \\implies \\hat{q} = \\frac{u}{hs}\n$$\n\n该近似的有效性取决于几个条件：\n1.  **生物学假设**：该推导假设了一个理想化的种群（无限大小，随机交配），其中只有突变和生存力选择在起作用。参数 $u$、$h$ 和 $s$ 被假定为随时间恒定。\n2.  **近似的数学条件**：近似的核心是将 $u$ 和 $q$ 视为小量并忽略高阶项。如果平衡频率 $\\hat{q} = u/hs$ 确实很小，那么这样做是合理的。这要求 $u \\ll hs$。由于 $u$（突变率）通常非常小（例如，$10^{-6}$ 到 $10^{-5}$），而 $s$ 可能很大，因此对于任何针对杂合子的非平凡选择（即 $h$ 不极度接近于零），该条件都成立。条件 $h>0$ 至关重要；如果 $h=0$（完全隐性），则此公式及其推导均无效。",
            "answer": "$$\n\\boxed{\\frac{u}{hs}}\n$$"
        },
        {
            "introduction": "在理解了单个有害等位基因如何维持在低频率后，我们现在可以考虑它们的集体效应对基因组多样性的影响。此练习将探讨在一个完全无重组的基因组中的经典背景选择模型，它展示了有害突变的持续清除如何有效减少“可遗传”谱系的数量，从而降低有效种群大小和连锁的中性多样性。推导著名的 $B \\approx e^{-U/s}$ 公式，将为你建立有害突变率 ($U$)、选择强度 ($s$) 与遗传多样性可预测的降低之间的直接、机械的联系。",
            "id": "2693239",
            "problem": "考虑一个大的、充分混合的单倍体种群，其基因组完全不重组，因此重组率 $r=0$。有害突变以每个世代的总基因组速率 $U$ 发生，在个体间和位点间均独立。每个有害突变都以相同的因子降低适合度，且各位点间的适合度是乘性的：携带 $k$ 个有害突变的个体的相对适合度为 $(1 - s)^{k}$，其中 $s \\in (0,1)$。假设每个世代新有害突变的涌入遵循均值为 $U$ 的泊松分布，选择足够强，以致于携带有害突变的谱系对长期中性谱系树的贡献可以忽略不计，并且种群就其有害负荷而言处于稳定的突变-选择平衡状态。\n\n令 $p_{k}$ 表示携带恰好 $k$ 个有害突变的个体的平衡频率。令 $B$ 表示一个与该基因组完全连锁的、作为研究焦点且完全中性的位点上中性多样性的比例性降低，其定义为选择作用下的中性杂合度与无选择作用但具有相同中性突变过程时的中性杂合度之比。在上述假设下，仅用 $U$ 和 $s$ 从第一性原理推导出一个关于 $B$ 的解析表达式。你的推导应从突变-选择平衡和指定乘性适合度模型的基本定义开始，并应论证在强选择、$r=0$ 的极限情况下，$B$ 如何与平衡分布 $\\{p_{k}\\}_{k \\ge 0}$ 相关联。\n\n请以仅包含 $U$ 和 $s$ 的单个闭式表达式的形式给出你的最终答案。不要包含单位。不需要数值近似或四舍五入。",
            "solution": "该问题要求在一个不重组的单倍体种群中，根据背景选择模型，推导中性多样性比例性降低 $B$ 的表达式。推导必须从第一性原理出发。\n\n首先，我们必须确定携带 $k$ 个有害突变的个体的平衡频率分布 $\\{p_{k}\\}_{k \\ge 0}$。令 $p_{k}$ 为一代开始时携带 $k$ 个有害突变的个体类别的频率。该类别的相对适合度为 $w_{k} = (1 - s)^{k}$。种群在平衡时的平均适合度为 $\\bar{w} = \\sum_{j=0}^{\\infty} p_{j} w_{j} = \\sum_{j=0}^{\\infty} p_{j} (1 - s)^{j}$。\n\n经过选择后，第 $k$ 类的频率（记为 $p_{k}^{*}$）变为与其初始频率按其适合度加权成正比：\n$$ p_{k}^{*} = \\frac{p_{k} w_{k}}{\\bar{w}} = \\frac{p_{k} (1 - s)^{k}}{\\bar{w}} $$\n选择之后，会发生新的有害突变。问题陈述，每个个体每个世代的新突变数遵循均值为 $U$ 的泊松分布。一个个体获得恰好 $i$ 个新突变的概率是 $\\frac{U^{i} \\exp(-U)}{i!}$。\n\n如果一个下一代的个体有 $k$ 个突变，那么它的亲代（在选择后有 $j$ 个突变）必然获得了额外的 $k-j$ 个突变。对所有可能的亲代类别 $j \\le k$ 求和，下一代中第 $k$ 类的频率 $p'_{k}$ 由卷积给出：\n$$ p'_{k} = \\sum_{j=0}^{k} p_{j}^{*} \\left( \\frac{U^{k-j} \\exp(-U)}{(k-j)!} \\right) = \\frac{\\exp(-U)}{\\bar{w}} \\sum_{j=0}^{k} p_{j} (1-s)^{j} \\frac{U^{k-j}}{(k-j)!} $$\n在突变-选择平衡时，频率分布是稳态的，因此对于所有 $k \\ge 0$，有 $p'_{k} = p_{k}$。\n对于没有突变的类别（$k=0$），平衡条件是：\n$$ p_{0} = \\frac{\\exp(-U)}{\\bar{w}} p_{0} (1-s)^{0} \\frac{U^{0}}{0!} = \\frac{\\exp(-U) p_{0}}{\\bar{w}} $$\n由于对于一个有害等位基因未被固定的可存活种群，$p_{0}$ 必须大于 0，我们可以用 $p_{0}$ 去除等式两边，从而找到平衡时种群的平均适合度：\n$$ \\bar{w} = \\exp(-U) $$\n这个结果表明，平均适合度降低的因子等于逃脱新有害突变的概率，这是一个经典结果。\n\n我们现在寻求完整的分布 $\\{p_{k}\\}$。我们假设平衡分布是泊松分布，即 $p_{k} = \\exp(-\\lambda) \\frac{\\lambda^{k}}{k!}$，其中 $\\lambda$ 是某个参数。我们必须验证这个假设并确定 $\\lambda$。\n在该假设下，选择后第 $k$ 类的频率 $p_{k}^{*}$ 为：\n$$ p_{k}^{*} = \\frac{p_{k} (1-s)^{k}}{\\bar{w}} = \\frac{\\exp(-\\lambda) \\frac{\\lambda^{k}}{k!} (1-s)^{k}}{\\sum_{j=0}^{\\infty} \\exp(-\\lambda) \\frac{\\lambda^{j}}{j!} (1-s)^{j}} = \\frac{\\frac{(\\lambda(1-s))^{k}}{k!}}{\\sum_{j=0}^{\\infty} \\frac{(\\lambda(1-s))^{j}}{j!}} = \\frac{\\frac{(\\lambda(1-s))^{k}}{k!}}{\\exp(\\lambda(1-s))} = \\exp(-\\lambda(1-s)) \\frac{(\\lambda(1-s))^{k}}{k!} $$\n这表明经过选择后，突变的分布仍然是泊松分布，但其新的均值为 $\\lambda(1-s)$。下一代中的突变数量是被选择亲代的突变数（一个均值为 $\\lambda(1-s)$ 的泊松变量）与新突变数（一个均值为 $U$ 的泊松变量）之和。两个独立泊松变量之和也是一个泊松变量，其均值等于它们的均值之和。因此，下一代的分布是均值为 $\\lambda(1-s) + U$ 的泊松分布。\n为使分布处于平衡状态，分布的均值必须在代际间保持不变。因此：\n$$ \\lambda = \\lambda(1-s) + U $$\n$$ \\lambda s = U \\implies \\lambda = \\frac{U}{s} $$\n有害突变的平衡分布是均值为 $\\bar{k} = U/s$ 的泊松分布：\n$$ p_{k} = \\exp\\left(-\\frac{U}{s}\\right) \\frac{(U/s)^{k}}{k!} $$\n\n接下来，我们将其与中性多样性的降低 $B$ 联系起来。根据定义，$B$ 是选择作用下的中性杂合度（$H_s$）与无选择作用时的中性杂合度（$H_0$）之比。中性杂合度与有效种群大小 $N_e$ 成正比。在没有选择的情况下，有效种群大小等于普查规模 $N$。因此，$B = H_{s}/H_{0} \\propto N_{e}/N$。假设为正比关系，我们可以写成 $B = N_{e}/N$。\n\n问题陈述选择是强的，且没有重组（$r=0$）。这意味着一个中性位点永久地与其有害突变的遗传背景连锁。“携带有害突变的谱系对长期中性谱系树的贡献可以忽略不计”这一假设至关重要。它意味着任何携带一个或多个有害突变的谱系最终都会被选择从种群中清除，无法对遥远未来的种群祖先做出贡献。因此，构成种群长期谱系树基础的唯一群体是那些不含有害突变的个体，即 $k=0$ 类别中的个体。\n因此，有效种群大小由这个无突变类别中的个体数量决定。如果普查规模是 $N$，那么无突变类别中的个体数量是 $N p_{0}$。因此，有效种群大小是：\n$$ N_{e} = N p_{0} $$\n我们现在可以计算多样性的降低程度 $B$：\n$$ B = \\frac{N_{e}}{N} = \\frac{N p_{0}}{N} = p_{0} $$\n使用我们推导出的平衡分布，$k=0$ 类的频率是：\n$$ p_{0} = \\exp\\left(-\\frac{U}{s}\\right) \\frac{(U/s)^{0}}{0!} = \\exp\\left(-\\frac{U}{s}\\right) $$\n结合这些结果，可以得到 $B$ 的最终表达式。",
            "answer": "$$\\boxed{\\exp\\left(-\\frac{U}{s}\\right)}$$"
        },
        {
            "introduction": "前面的练习在理想化的场景中建立了背景选择的基本理论。然而，真实的基因组拥有复杂的重组图谱和功能元件景观。这项综合性练习将挑战你通过编程实现一个计算模型，从而连接理论与应用。你将沿着一条具有可变重组率和不同类型选择位点的染色体，计算背景选择系数 $B(x)$。这项动手编程练习让你超越简化的假设，为你提供在现实基因组环境中预测多样性模式的实用技能，并理解如何通过正向时间模拟来验证这些预测。",
            "id": "2693266",
            "problem": "设计并实现一个完整、可运行的程序，用于计算背景选择沿染色体导致的中性多样性降低的解析预测值，并指定可用于验证这些预测的前向时间模拟输出。你需要模拟一条长度为 $L = 10{,}000{,}000$ 个碱基对的染色体，该染色体具有分段恒定的重组图谱和一组经历有害突变和选择的功能注释。目标是计算指定中性位点 $x$ 处的背景选择降低因子 $B(x)$，并为一套测试情景生成结果。\n\n背景与基本原理：背景选择模型描述了在连锁位点上，针对有害突变的纯化选择所导致的中性多样性降低。在强选择、低频率有害等位基因、乘性适应度及半显性的假设下，相对于中性期望，位置 $x$ 处的期望中性多样性会降低一个因子 $B(x) \\in (0,1]$。一个源自溯祖理论和突变-选择平衡的广泛使用的近似表明，对于一个中性位置 $x$，如果有害输入沿基因组分布，其位置依赖的每碱基有害突变率为 $\\mu_{d}(y)$，针对杂合子的选择系数为 $s(y)$，则\n$$\nB(x) \\approx \\exp\\!\\left(- \\int_{\\text{selected regions}} \\frac{\\mu_{d}(y)}{s(y) + r(x,y)} \\, \\mathrm{d}y \\right),\n$$\n其中 $r(x,y)$ 是位置 $x$ 和位置 $y$ 之间每代的重组率。该积分可以通过对功能元件求和并将其跨度离散化来进行数值计算。在 $x$ 附近没有重组的特殊情况下，该积分简化为经典的无重组结果 $B(x) = \\exp(-U/s)$，其中 $U$ 表示连锁区域的总有害突变率，$s$ 表示选择系数。\n\n数学和算法规范：\n- 重组图谱以厘摩尔根/兆碱基（cM/Mb）为单位给出。通过 $1\\,\\text{cM}/\\text{Mb} = 10^{-8}$ 每碱基每代重组分数，将其转换为每碱基每代的重组率。将累积遗传图谱 $G(p)$ 定义为\n$$\nG(p) = \\int_{0}^{p} \\rho(u)\\, \\mathrm{d}u,\n$$\n其中 $\\rho(u)$ 是碱基位置 $u$ 处每碱基每代的重组分数。然后通过\n$$\nr(x,y) = \\min\\!\\left(|G(x) - G(y)|,\\; 0.5\\right),\n$$\n来近似 $r(x,y)$，以强制执行每代重组分数不超过 $0.5$ 的生物学限制。\n- 功能注释表示为区间 $[a_j,b_j]$，具有恒定的每碱基有害突变率 $\\mu_{j}$ 和恒定的选择系数 $s_{j}$。通过对划分每个注释区间的划分单元进行中点黎曼和来近似 $B(x)$ 的积分：\n$$\n\\int_{a_j}^{b_j} \\frac{\\mu_{j}}{s_{j} + r(x,y)} \\, \\mathrm{d}y \\approx \\sum_{k=1}^{n_j} \\frac{\\mu_{j}}{s_{j} + r(x,m_{jk})} \\Delta y_{jk},\n$$\n其中 $m_{jk}$ 是划分单元 $k$ 的中点，$\\Delta y_{jk}$ 是其宽度。\n\n您的程序必须实现上述逻辑，完全自包含，并为以下测试套件生成结果。所有数值均为每代的值。如果使用角度，必须以弧度为单位。除了碱基对外，输出中不需要其他物理单位；重组图谱以 cM/Mb 为单位指定，但您必须按照指示在内部进行转换。最终输出必须是十进制形式的浮点数。\n\n染色体长度：\n- $L = 10{,}000{,}000$ 碱基对。\n\n情景 A（基线现实图谱和注释）：\n- 重组图谱（在cM/Mb单位下分段恒定）：\n    - $[0,2{,}000{,}000)$: $0.5$，\n    - $[2{,}000{,}000,5{,}000{,}000)$: $1.5$，\n    - $[5{,}000{,}000,8{,}000{,}000)$: $0.8$，\n    - $[8{,}000{,}000,10{,}000{,}000]$: $2.0$.\n- 功能注释（以碱基对为单位的区间，包含起始，不包含结束），每个区间具有恒定的 $\\mu_{d}$ 和 $s$：\n    - 外显子：$\\mu_{d} = 5\\times 10^{-9}$，$s = 10^{-2}$：\n        - $[800{,}000,1{,}200{,}000)$,\n        - $[3{,}000{,}000,3{,}300{,}000)$,\n        - $[6{,}400{,}000,6{,}600{,}000)$.\n    - 非翻译区（UTRs）：$\\mu_{d} = 2\\times 10^{-9}$，$s = 5\\times 10^{-3}$：\n        - $[1{,}800{,}000,1{,}900{,}000)$,\n        - $[4{,}700{,}000,4{,}800{,}000)$.\n    - 保守非编码元件（CNEs）：$\\mu_{d} = 10^{-9}$，$s = 2\\times 10^{-3}$：\n        - $[7{,}000{,}000,7{,}300{,}000)$,\n        - $[8{,}200{,}000,8{,}250{,}000)$.\n- 查询中性位点 $x$（以碱基对为单位）：\n    - $1{,}000{,}000$, $4{,}000{,}000$, $7{,}500{,}000$, $9{,}500{,}000$.\n\n情景 B（无选择元件对照）：\n- 与情景A相同的重组图谱。\n- 无功能注释（空集）。\n- 查询中性位点：\n    - $5{,}000{,}000$。\n- 这是一个边界条件；您的结果在逻辑上应等于 $1.0$。\n\n情景 C（重组冷点谷）：\n- 重组图谱（cM/Mb）：\n    - $[0,2{,}000{,}000)$: $1.0$,\n    - $[2{,}000{,}000,4{,}000{,}000)$: $0.0$,\n    - $[4{,}000{,}000,10{,}000{,}000]$: $1.0$.\n- 功能注释：\n    - 谷内外显子：$\\mu_{d} = 5\\times 10^{-9}$，$s = 10^{-2}$：\n        - $[2{,}500{,}000,3{,}500{,}000)$。\n    - 谷外外显子：$\\mu_{d} = 5\\times 10^{-9}$，$s = 10^{-2}$：\n        - $[6{,}000{,}000,6{,}500{,}000)$。\n- 查询中性位点：\n    - $3{,}000{,}000$（位于重组冷点内），\n    - $6{,}250{,}000$（位于冷点外）。\n\n数值方法要求：\n- 在每个注释区间内，使用中点法则和统一的划分单元大小 $\\Delta y = 1000$ 碱基对来近似积分。如果一个区间的长度小于 $\\Delta y$，则使用一个宽度等于该区间长度的单一划分单元。\n- 使用上述 $r(x,y)$ 的定义，即 $r(x,y) = \\min(|G(x) - G(y)|, 0.5)$。\n- 对每个测试用例，使用上述指数公式计算 $B(x)$。\n\n前向时间模拟规范部分（非计算性，需在解决方案中论证）：指明在 SLiM 中的前向时间模拟应输出哪些结果，以验证 $B(x)$ 的解析预测。至少需要确定要记录的中性总结统计量，如何将它们与 $B(x)$ 对齐，以及如何放置中性标记以实现对不同位置 $x$ 的测量。\n\n要求的最终输出格式：\n- 您的程序必须生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，列表包含与以下顺序的测试用例相对应的八个值：\n    - 情景 A 在 $x = 1{,}000{,}000$, $4{,}000{,}000$, $7{,}500{,}000$, $9{,}500{,}000$ 处的值，\n    - 情景 B 在 $x = 5{,}000{,}000$ 处的值，\n    - 情景 C 在 $x = 3{,}000{,}000$, $6{,}250{,}000$ 处的值。\n- 每个值都必须是四舍五入到六位小数的浮点数。\n- 仅为格式示例（非实际值）：\"[0.923456,0.812345,0.998765,0.912345,1.000000,0.654321,0.987654]\"。\n\n所有数值都是无量纲的每代速率或指定的碱基对计数。不应打印其他单位。代码必须是完全自包含的，并且不需要任何输入。",
            "solution": "问题陈述已经过分析并被认定为有效。它在科学上植根于群体遗传学的既定原则，特别是背景选择理论。该问题提法恰当，提供了所有必要的参数、公式和数值规范，以推导出唯一且有意义的解。问题是客观的，没有逻辑矛盾或含糊之处。\n\n解决方案是基于对所提供理论模型的分步实现而构建的。核心任务是计算背景选择系数 $B(x)$，其定义为：\n$$\nB(x) \\approx \\exp\\!\\left(- \\int_{\\text{selected regions}} \\frac{\\mu_{d}(y)}{s(y) + r(x,y)} \\, \\mathrm{d}y \\right)\n$$\n其中 $B(x)$ 是由于对连锁有害突变的纯化选择，在染色体位置 $x$ 处的期望中性多样性的分数降低。参数包括每碱基的有害突变率 $\\mu_{d}(y)$、针对杂合子的选择系数 $s(y)$，以及位置 $x$ 和 $y$ 之间的重组率 $r(x,y)$。\n\n总积分是所有受有害突变影响的不相交基因组区间的积分之和。对于一组注释的功能区域 $\\{[a_j, b_j)\\}$，每个区域具有恒定的参数 $\\mu_j$ 和 $s_j$，表达式变为：\n$$\nB(x) \\approx \\exp\\left( - \\sum_j \\int_{a_j}^{b_j} \\frac{\\mu_{j}}{s_{j} + r(x,y)} \\, \\mathrm{d}y \\right)\n$$\n\n该解决方案需要三个主要组成部分：\n1.  一个根据物理碱基对位置 $p$ 计算遗传距离 $G(p)$ 的函数。\n2.  一个使用 $G(p)$ 计算重组率 $r(x,y)$ 的函数。\n3.  一个为每个选定区域近似积分并对结果求和的数值过程。\n\n遗传图谱 $G(p)$ 是从染色体起点到位置 $p$ 的累积重组率。其定义为：\n$$\nG(p) = \\int_{0}^{p} \\rho(u)\\, \\mathrm{d}u\n$$\n其中 $\\rho(u)$ 是位置 $u$ 处的每碱基重组率。问题指定了一个以厘摩尔根/兆碱基（cM/Mb）为单位的分段恒定重组图谱，必须使用提供的转换因子 $1\\,\\text{cM}/\\text{Mb} = 10^{-8}$ 每碱基每代，将其转换为每碱基速率 $\\rho$。鉴于 $\\rho(u)$ 是分段恒定的，函数 $G(p)$ 是分段线性的。一种有效的计算策略是预先计算每个恒定速率片段边界处的累积遗传距离。对于片段 $[p_i, p_{i+1})$ 内的任何位置 $p$，其遗传距离随后可以通过从片段起点进行线性插值来计算：$G(p) = G(p_i) + (p - p_i) \\cdot \\rho_i$，其中 $\\rho_i$ 是该片段的速率。\n\n建立函数 $G(p)$ 后，任意两个位置 $x$ 和 $y$ 之间的重组率 $r(x,y)$ 按指定方式计算：\n$$\nr(x,y) = \\min(|G(x) - G(y)|, 0.5)\n$$\n这个公式正确地反映了对于非连锁位点，重组分数在最大值 $0.5$ 处饱和。\n\n每个选定区域的积分使用中点黎曼和进行近似。对于给定的注释区间 $[a_j, b_j)$，它被划分为宽度为 $\\Delta y = 1000$ 碱基对的划分单元（bin）。每个划分单元对积分的贡献是该划分单元中点处的被积函数值乘以其宽度。总指数是所有选定区间中所有划分单元贡献的总和。在注释区域 $j$ 内，一个中点为 $m_{jk}$、宽度为 $\\Delta y_{jk}$ 的单一划分单元的贡献是：\n$$\n\\text{Term}_{jk} = \\frac{\\mu_{j}}{s_{j} + r(x,m_{jk})} \\Delta y_{jk}\n$$\n$B(x)$ 指数中的值是所有这些项之和的负数。如果注释区间的长度小于 $\\Delta y$，则使用一个跨越整个区间的单一划分单元。\n\n对于非计算部分，即使用如 SLiM 等前向时间模拟软件指定验证协议，概述了以下程序。解析公式预测了中性多样性的平衡期望值 $\\mathbb{E}[\\pi(x)]$，该值是相对于中性参考情景下的多样性 $\\pi_0$ 而言的。关系为 $\\mathbb{E}[\\pi(x)] = \\pi_0 B(x)$。\n\n可以配置前向时间模拟，以便在这些相同参数下随机实现进化过程，并检验这一预测。\n1.  **模拟设置：**将为一个恒定有效种群大小为 $N_e$ 的二倍体种群构建一个 SLiM 模型。模拟的基因组长度为 $L=10^7$ bp。使用 `initializeRecombinationRate()` 实现问题中给出的分段重组图谱。使用 `initializeGenomicElement()` 定义与注释区域（外显子、UTRs、CNEs）相对应的基因组元件。每种元件类型都被分配一个突变类型，具有指定的有害突变率 $\\mu_j$ 和选择系数 $s_j$（显性系数 $h=0.5$ 以表示半显性）。在整个染色体上定义一个独立的、速率为 $\\mu_0$ 的中性突变类型，作为多样性测量的基础。\n2.  **模拟执行：**模拟运行足够多的代数（例如 $10 N_e$），以使种群达到突变-选择-漂变平衡。\n3.  **数据收集与分析：**达到平衡后，沿着模拟的染色体在多个不重叠的窗口中测量核苷酸多样性 $\\pi$。这可以通过使用 SLiM 的 `nucleotideDiversity()` 函数或通过后处理 VCF 输出实现。这将产生一个经验多样性剖面 $\\pi(x_i)$，其中 $x_i$ 是窗口 $i$ 的中心。\n4.  **验证：**理论预测为 $\\pi(x) / \\pi_0 = B(x)$。中性期望 $\\pi_0$ 从模拟中估算，可以来自一个等效的中性模拟（无有害突变），也可以通过对远离选择元件和位于高重组区域的染色体区域的多样性取平均值得到。然后，将模拟的、归一化的多样性剖面 $\\pi(x_i) / \\pi_0$ 与解析计算出的 $B(x_i)$ 进行绘图比较。两者之间的强对应性（理想情况下围绕等值线 $y=x$ 聚集）表明验证成功。为了解释随机进化过程的高方差，应将结果在多个独立的模拟重复中取平均。\n\n最终的程序实现了这一逻辑，为所有指定的情景和查询点计算 $B(x)$。",
            "answer": "```python\nimport numpy as np\nimport math\n\ndef solve():\n    \"\"\"\n    Computes the background selection factor B(x) for specified scenarios.\n    \"\"\"\n\n    def make_g_map_calculator(rec_map, L, conv=1e-8):\n        \"\"\"\n        Creates a function that calculates cumulative genetic distance G(p).\n\n        Args:\n            rec_map (list): List of tuples (start, end, rate_cM_per_Mb).\n            L (int): Chromosome length.\n            conv (float): Conversion factor from cM/Mb to per-base rate.\n\n        Returns:\n            function: A function g(p) that returns the genetic distance at position p.\n        \"\"\"\n        processed_map = []\n        sorted_map = sorted(rec_map, key=lambda x: x[0])\n        \n        last_pos = 0\n        for start, end, rate_cM in sorted_map:\n            if start > last_pos:\n                # Gap with zero recombination\n                processed_map.append({'start': last_pos, 'end': start, 'rate': 0.0})\n            \n            # The problem statement uses [start, end) for annotations and does not\n            # specify exclusivity for rec map. We assume [start, end).\n            # The last interval for scenario A is inclusive, [..., L], but we treat it\n            # as [..., L) and handle the endpoint L separately.\n            processed_map.append({'start': start, 'end': end, 'rate': rate_cM * conv})\n            last_pos = end\n        \n        if last_pos < L:\n            processed_map.append({'start': last_pos, 'end': L, 'rate': 0.0})\n\n        # Pre-calculate cumulative distance at the start of each interval\n        cumulative_g = 0.0\n        for i in range(len(processed_map)):\n            processed_map[i]['g_start'] = cumulative_g\n            length = processed_map[i]['end'] - processed_map[i]['start']\n            cumulative_g += length * processed_map[i]['rate']\n        \n        # Store for endpoint query\n        g_at_L = cumulative_g\n            \n        def g(p):\n            if p <= 0:\n                return 0.0\n            if p >= L:\n                return g_at_L\n            \n            # This linear search is acceptable for a small number of segments.\n            for seg in processed_map:\n                if seg['start'] <= p < seg['end']:\n                    return seg['g_start'] + (p - seg['start']) * seg['rate']\n            \n            # This should technically not be reached if p < L.\n            return g_at_L\n\n        return g\n\n    def calculate_B(x, L, rec_map, annotations, bin_size=1000):\n        \"\"\"\n        Calculates the B-factor for a given neutral site x.\n        \"\"\"\n        if not annotations:\n            return 1.0\n\n        g_calculator = make_g_map_calculator(rec_map, L, conv=1e-8)\n        \n        def r(pos_x, pos_y):\n            return min(abs(g_calculator(pos_x) - g_calculator(pos_y)), 0.5)\n\n        total_integral_sum = 0.0\n        \n        for ann in annotations:\n            a, b, mu, s = ann['interval'][0], ann['interval'][1], ann['mu'], ann['s']\n            length = b - a\n            \n            if length <= 0:\n                continue\n\n            # Midpoint Riemann sum\n            if length < bin_size:\n                # Single bin for small intervals\n                midpoint = a + length / 2\n                r_val = r(x, midpoint)\n                integrand = mu / (s + r_val)\n                total_integral_sum += integrand * length\n            else:\n                num_full_bins = math.floor(length / bin_size)\n                \n                # Full-sized bins\n                for i in range(num_full_bins):\n                    y_start = a + i * bin_size\n                    midpoint = y_start + bin_size / 2\n                    r_val = r(x, midpoint)\n                    integrand = mu / (s + r_val)\n                    total_integral_sum += integrand * bin_size\n                \n                # Remainder bin\n                remaining_length = length - num_full_bins * bin_size\n                if remaining_length > 0:\n                    y_start = a + num_full_bins * bin_size\n                    midpoint = y_start + remaining_length / 2\n                    r_val = r(x, midpoint)\n                    integrand = mu / (s + r_val)\n                    total_integral_sum += integrand * remaining_length\n                    \n        return np.exp(-total_integral_sum)\n\n    # --- Problem Definition ---\n    L_chromosome = 10_000_000\n\n    # Scenario A\n    rec_map_A = [\n        (0, 2_000_000, 0.5),\n        (2_000_000, 5_000_000, 1.5),\n        (5_000_000, 8_000_000, 0.8),\n        (8_000_000, 10_000_000, 2.0)\n    ]\n    annotations_A = [\n        {'type': 'Exon', 'interval': (800_000, 1_200_000), 'mu': 5e-9, 's': 1e-2},\n        {'type': 'Exon', 'interval': (3_000_000, 3_300_000), 'mu': 5e-9, 's': 1e-2},\n        {'type': 'Exon', 'interval': (6_400_000, 6_600_000), 'mu': 5e-9, 's': 1e-2},\n        {'type': 'UTR', 'interval': (1_800_000, 1_900_000), 'mu': 2e-9, 's': 5e-3},\n        {'type': 'UTR', 'interval': (4_700_000, 4_800_000), 'mu': 2e-9, 's': 5e-3},\n        {'type': 'CNE', 'interval': (7_000_000, 7_300_000), 'mu': 1e-9, 's': 2e-3},\n        {'type': 'CNE', 'interval': (8_200_000, 8_250_000), 'mu': 1e-9, 's': 2e-3}\n    ]\n    query_x_A = [1_000_000, 4_000_000, 7_500_000, 9_500_000]\n\n    # Scenario B\n    rec_map_B = rec_map_A\n    annotations_B = []\n    query_x_B = [5_000_000]\n\n    # Scenario C\n    rec_map_C = [\n        (0, 2_000_000, 1.0),\n        (2_000_000, 4_000_000, 0.0),\n        (4_000_000, 10_000_000, 1.0)\n    ]\n    annotations_C = [\n        {'type': 'ValleyExon', 'interval': (2_500_000, 3_500_000), 'mu': 5e-9, 's': 1e-2},\n        {'type': 'OutsideExon', 'interval': (6_000_000, 6_500_000), 'mu': 5e-9, 's': 1e-2}\n    ]\n    query_x_C = [3_000_000, 6_250_000]\n\n    # --- Calculation ---\n    results = []\n\n    # Scenario A\n    for x in query_x_A:\n        b_val = calculate_B(x, L_chromosome, rec_map_A, annotations_A)\n        results.append(round(b_val, 6))\n\n    # Scenario B\n    for x in query_x_B:\n        b_val = calculate_B(x, L_chromosome, rec_map_B, annotations_B)\n        results.append(round(b_val, 6))\n\n    # Scenario C\n    for x in query_x_C:\n        b_val = calculate_B(x, L_chromosome, rec_map_C, annotations_C)\n        results.append(round(b_val, 6))\n\n    # --- Final Output ---\n    formatted_results = [f\"{r:.6f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}