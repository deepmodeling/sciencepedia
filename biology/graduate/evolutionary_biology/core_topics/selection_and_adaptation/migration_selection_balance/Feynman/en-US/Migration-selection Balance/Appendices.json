{
    "hands_on_practices": [
        {
            "introduction": "Understanding the interplay between local adaptation and gene flow is central to evolutionary biology. This first exercise provides a foundational hands-on derivation within a classic two-deme model, where divergent selection favors different alleles in each location. By working through the weak-selection and weak-migration approximations, you will derive the equilibrium allele frequency difference between the demes, revealing how genetic differentiation is quantitatively eroded by the ratio of migration rate to selection strength .",
            "id": "2734061",
            "problem": "Consider a single biallelic locus with alleles $A$ and $a$ in a spatially structured population consisting of two infinitely large demes connected by symmetric migration at per-generation rate $m$. Within each deme, random mating restores Hardy–Weinberg proportions each generation, and the life cycle is selection followed by migration. Selection is additive and divergent: in deme $1$, the ordered viabilities of genotypes are $1+s$, $1+\\frac{s}{2}$, $1$ for $AA$, $Aa$, $aa$, respectively; in deme $2$ the ordering is reversed, with $1$, $1+\\frac{s}{2}$, $1+s$ for $AA$, $Aa$, $aa$, respectively. Assume $s>0$, $m>0$, and that $m \\ll s \\ll 1$ so that weak-selection and weak-migration approximations apply and products of small parameters can be neglected at leading order.\n\nLet $p_{1}$ and $p_{2}$ denote the allele $A$ frequencies immediately before selection in demes $1$ and $2$, respectively. At migration–selection balance, let $\\Delta p^{\\ast}=p_{1}^{\\ast}-p_{2}^{\\ast}$ denote the equilibrium allele-frequency difference between the two demes.\n\nStarting only from standard definitions of viability selection and migration and using leading-order approximations justified by $m \\ll s \\ll 1$, derive the asymptotic expression for $\\Delta p^{\\ast}$ as a function of $m$ and $s$ in the limit $m/s \\to 0$, and interpret how the leading dependence on $m/s$ reflects the erosion of local differentiation by migration.\n\nProvide your final result as a single closed-form analytic expression in terms of $m$ and $s$, valid to leading order in the small ratio $m/s$. Do not include higher-order remainder terms. No units are required.",
            "solution": "The problem statement is subjected to validation.\n\n**Step 1: Extract Givens**\n- **Model:** Single biallelic locus, alleles $A$ and $a$.\n- **Population:** Two infinitely large demes.\n- **Migration:** Symmetric, rate $m$ per generation.\n- **Mating:** Random mating within demes.\n- **Life Cycle:** Selection followed by migration.\n- **Selection:** Additive and divergent.\n- **Viabilities, Deme 1:** $w_{AA,1} = 1+s$, $w_{Aa,1} = 1+\\frac{s}{2}$, $w_{aa,1} = 1$.\n- **Viabilities, Deme 2:** $w_{AA,2} = 1$, $w_{Aa,2} = 1+\\frac{s}{2}$, $w_{aa,2} = 1+s$.\n- **Parameters:** $s>0$, $m>0$.\n- **Approximations:** $m \\ll s \\ll 1$ (weak selection, weak migration). Products of small parameters are neglected at leading order.\n- **Variables:** $p_{1}$ and $p_{2}$ are allele $A$ frequencies before selection in demes $1$ and $2$.\n- **Objective:** Find the asymptotic expression for the equilibrium allele-frequency difference, $\\Delta p^{\\ast} = p_{1}^{\\ast} - p_{2}^{\\ast}$, in the limit $m/s \\to 0$.\n\n**Step 2: Validate Using Extracted Givens**\n- **Scientific Grounding:** The problem describes a standard two-deme model of migration-selection balance (a variant of the Levene model), a cornerstone of theoretical population genetics. The concepts of viability selection, migration, and allele frequency dynamics are fundamentally sound.\n- **Well-Posedness:** The problem is well-posed. It specifies a deterministic dynamical system and asks for a stable equilibrium state under a specific, well-defined parameter regime ($m \\ll s$). A unique, stable polymorphic equilibrium is known to exist under these conditions.\n- **Objectivity:** The problem is stated in precise, objective mathematical language, free from ambiguity or subjective claims.\n\n**Step 3: Verdict and Action**\nThe problem is valid. It is a standard, non-trivial exercise in mathematical evolutionary theory. A solution will be derived.\n\nThe allele frequency dynamics are determined by the sequential processes of selection and migration within each generation. Let $p_1$ and $p_2$ be the frequencies of allele $A$ in deme $1$ and $2$, respectively, at the start of a generation (before selection).\n\nFirst, we analyze the effect of selection. In deme $1$, selection favors allele $A$. The fitnesses of genotypes $AA$, $Aa$, and $aa$ are $1+s$, $1+s/2$, and $1$. The mean fitness in deme $1$ is $\\bar{w}_1 = p_1^2(1+s) + 2p_1(1-p_1)(1+s/2) + (1-p_1)^2(1) = 1+sp_1$. The frequency of allele $A$ after selection, $p'_1$, is given by:\n$$p'_1 = \\frac{p_1^2(1+s) + p_1(1-p_1)(1+s/2)}{\\bar{w}_1} = \\frac{p_1 + \\frac{s}{2}p_1(1+p_1)}{1+sp_1}$$\nThe change in allele frequency due to selection is $\\Delta_s p_1 = p'_1 - p_1$:\n$$\\Delta_s p_1 = \\frac{p_1 + \\frac{s}{2}p_1(1+p_1) - p_1(1+sp_1)}{1+sp_1} = \\frac{\\frac{s}{2}p_1 - \\frac{s}{2}p_1^2}{1+sp_1} = \\frac{\\frac{s}{2}p_1(1-p_1)}{1+sp_1}$$\nGiven the assumption that selection is weak ($s \\ll 1$), we can approximate the denominator $1+sp_1 \\approx 1$. Thus, to leading order in $s$, the change is:\n$$\\Delta_s p_1 \\approx \\frac{s}{2}p_1(1-p_1)$$\nIn deme $2$, selection favors allele $a$. The fitnesses of $AA$, $Aa$, and $aa$ are $1$, $1+s/2$, and $1+s$. The dynamics for allele $A$ are equivalent to the dynamics for allele $a$ in deme $1$. Letting $q_2 = 1-p_2$ be the frequency of allele $a$ in deme $2$, the change in its frequency is $\\Delta_s q_2 \\approx \\frac{s}{2}q_2(1-q_2)$. The change in frequency of allele $A$ is therefore $\\Delta_s p_2 = -\\Delta_s q_2$.\n$$\\Delta_s p_2 \\approx -\\frac{s}{2}q_2(1-q_2) = -\\frac{s}{2}(1-p_2)p_2$$\nNext, we incorporate migration. The life cycle is selection followed by migration. Migration occurs at a symmetric rate $m$ between the demes. The allele frequencies after migration, $p_1''$ and $p_2''$, are:\n$$p_1'' = (1-m)p'_1 + m p'_2$$\n$$p_2'' = (1-m)p'_2 + m p'_1$$\nThe total change in allele frequency in one generation for deme $1$ is $\\Delta p_1 = p_1'' - p_1$:\n$$\\Delta p_1 = (1-m)(p_1 + \\Delta_s p_1) + m(p_2 + \\Delta_s p_2) - p_1$$\n$$\\Delta p_1 = \\Delta_s p_1 - m(p_1 - p_2) - m\\Delta_s p_1 + m\\Delta_s p_2$$\nThe problem states that products of small parameters ($m$ and $s$) can be neglected at leading order. The terms $m\\Delta_s p_1$ and $m\\Delta_s p_2$ are of order $ms$ and are thus neglected. The recursion for $p_1$ simplifies to:\n$$\\Delta p_1 \\approx \\Delta_s p_1 - m(p_1 - p_2)$$\nAt equilibrium, $\\Delta p_1 = 0$. Let $p_1^*$ and $p_2^*$ denote the equilibrium frequencies. The condition becomes:\n$$\\Delta_s p_1(p_1^*) \\approx m(p_1^* - p_2^*)$$\n$$\\frac{s}{2}p_1^*(1-p_1^*) \\approx m(p_1^* - p_2^*)$$\nA similar analysis for deme $2$ yields $\\Delta p_2 \\approx \\Delta_s p_2 + m(p_1 - p_2)$, which at equilibrium gives:\n$$\\Delta_s p_2(p_2^*) \\approx -m(p_1^* - p_2^*) = m(p_2^* - p_1^*)$$\n$$-\\frac{s}{2}p_2^*(1-p_2^*) \\approx m(p_2^* - p_1^*)$$\nThese two equilibrium conditions are consistent and imply $p_1^*(1-p_1^*) = p_2^*(1-p_2^*)$. This equality admits two solutions: a trivial one $p_1^*=p_2^*$ which is unstable under divergent selection, and a symmetric one $p_1^* = 1 - p_2^*$, or $p_1^* + p_2^* = 1$. This latter solution corresponds to the stable polymorphic equilibrium maintained by migration-selection balance.\n\nWe substitute the symmetry condition $p_2^* = 1 - p_1^*$ into the equilibrium equation for deme $1$:\n$$m(p_1^* - (1-p_1^*)) \\approx \\frac{s}{2}p_1^*(1-p_1^*)$$\n$$m(2p_1^* - 1) \\approx \\frac{s}{2}p_1^*(1-p_1^*)$$\nWe are interested in the limit $m/s \\to 0$, where selection is much stronger than migration. In this regime, we expect the locally favored allele to be near fixation in each deme. Thus, $p_1^* \\to 1$ and $p_2^* \\to 0$. Let $p_1^* = 1-\\epsilon$ and $p_2^* = \\epsilon$ for some small positive quantity $\\epsilon$. The condition $p_1^*+p_2^* = 1$ is automatically satisfied. Substituting $p_1^* = 1-\\epsilon$ into the equilibrium equation:\n$$m(2(1-\\epsilon) - 1) \\approx \\frac{s}{2}(1-\\epsilon)(1 - (1-\\epsilon))$$\n$$m(1 - 2\\epsilon) \\approx \\frac{s}{2}(1-\\epsilon)\\epsilon$$\nSince $m/s \\to 0$, we expect $\\epsilon$ to be small. We can therefore approximate to leading order by taking $\\epsilon \\to 0$ inside the parentheses:\n$$m(1) \\approx \\frac{s}{2}(1)\\epsilon$$\nThis yields a first-order approximation for $\\epsilon$:\n$$\\epsilon \\approx \\frac{2m}{s}$$\nThis confirms that $\\epsilon$ is small when $m/s$ is small.\nThe equilibrium allele frequencies are therefore approximated as:\n$$p_1^* \\approx 1 - \\frac{2m}{s}$$\n$$p_2^* \\approx \\frac{2m}{s}$$\nThe problem asks for the equilibrium allele-frequency difference, $\\Delta p^* = p_1^* - p_2^*$:\n$$\\Delta p^* \\approx \\left(1 - \\frac{2m}{s}\\right) - \\frac{2m}{s} = 1 - \\frac{4m}{s}$$\nThis is the asymptotic expression for $\\Delta p^*$ valid to leading order in the small ratio $m/s$.\n\nInterpretation: The quantity $\\Delta p^*$ measures the extent of genetic differentiation between the two demes. In the absence of migration ($m=0$), selection would drive the locally favored alleles to fixation, resulting in $p_1^*=1$ and $p_2^*=0$, so differentiation would be maximal, $\\Delta p^*=1$. Migration acts as a homogenizing force, counteracting selection by introducing alleles from the other deme. The derived expression $\\Delta p^* \\approx 1 - 4m/s$ shows precisely how this occurs. The deviation from maximal differentiation is $-4m/s$. This leading-order dependence shows that the erosion of local differentiation is directly proportional to the ratio of the migration rate to the selection strength. When migration is weak relative to selection ($m/s \\ll 1$), differentiation remains high, close to $1$.",
            "answer": "$$\\boxed{1 - \\frac{4m}{s}}$$"
        },
        {
            "introduction": "While analytical models provide deep insights, a crucial skill for an evolutionary biologist is understanding how to connect these models to empirical data. This practice moves from discrete demes to continuous space, focusing on a genetic cline maintained by migration-selection balance. You will explore a fundamental challenge in evolutionary genetics: the problem of parameter identifiability, and critically evaluate which types of data—beyond a simple snapshot of the cline—are required to disentangle the effects of migration ($m$) from selection ($s$) .",
            "id": "2734006",
            "problem": "In a spatially structured population along a one-dimensional environmental transition, a single diallelic locus experiences opposing selection across space, and dispersal occurs each generation. Let $m$ denote a per-generation migration parameter that determines an effective dispersal scale, and let $s$ denote the strength of selection maintaining the cline. At equilibrium, the allele-frequency profile $p(x)$ forms a stable cline. Suppose you can measure the cline steepness at its center, for example via the magnitude of the spatial derivative $\\left|\\frac{dp}{dx}\\right|$ at the cline center, or any equivalent measure of cline width.\n\nFrom fundamental principles of migration-selection balance in continuous space, explain whether $m$ and $s$ are separately identifiable from cline steepness alone, and evaluate which additional observables could, in principle, allow separate estimation of $m$ and $s$.\n\nSelect all options that are correct.\n\nA. Cline steepness alone generally cannot separate $m$ from $s$ because steepness is governed by a single compound spatial scale that combines dispersal and selection; however, observing how quickly a deliberately perturbed cline returns to equilibrium (a temporal relaxation rate) provides an independent timescale that is dominated by $s$, enabling separation of $m$ and $s$ when combined with steepness.\n\nB. If an independent field study provides a direct estimate of the per-generation dispersal variance of individuals (for example, by parentage assignment or mark–recapture), then combining this dispersal estimate with the observed cline steepness allows separate estimation of $s$.\n\nC. In a roughly homogeneous two-dimensional landscape away from the cline, the genome-wide isolation-by-distance slope for neutral loci yields an estimate of the neighborhood size, which depends on the product of effective population size and dispersal scale. If effective population size can be estimated independently, this yields the dispersal scale and hence allows $m$ and $s$ to be separately estimated when combined with cline steepness.\n\nD. Increasing the number of genotyped individuals at a single time point and location within the cline always resolves the ambiguity between $m$ and $s$ inherent to using cline steepness alone.\n\nE. Knowing the geographic location of the cline center uniquely determines $m$ and $s$, even if only a single locus and a single time point are observed.\n\nF. Measuring pairwise two-locus linkage disequilibrium across the cline as a function of recombination rate provides an observable that depends on dispersal and recombination in a way that is separable from the dependence on selection; when such two-locus data are combined with single-locus cline steepness, $m$ and $s$ can be estimated separately.\n\nYour answer should consist of the letters corresponding to all correct options.",
            "solution": "The problem statement concerns the identifiability of dispersal and selection parameters from the shape of a genetic cline at equilibrium. This is a classic problem in theoretical population genetics. The problem is scientifically grounded and well-posed. We shall proceed to the derivation and analysis.\n\nThe fundamental model describing the evolution of an allele frequency $p(x,t)$ at a single locus in a continuous one-dimensional space under migration and selection is a reaction-diffusion equation:\n$$ \\frac{\\partial p}{\\partial t} = D \\frac{\\partial^2 p}{\\partial x^2} + S(p, x) $$\nHere, $D$ is the diffusion coefficient, which is proportional to the migration parameter $m$ mentioned in the problem; specifically, $D = \\sigma^2/2$, where $\\sigma^2$ is the variance of dispersal distance per generation. Let us associate $m$ with the dispersal scale $\\sigma$, so $D \\propto m^2$. The term $S(p, x)$ represents selection. For a simple cline driven by opposing directional selection, this term is often of the form $s \\cdot g(x) \\cdot f(p)$, where $s$ is the selection strength, $g(x)$ describes the spatial change in selection, and $f(p)$ is typically of the form $p(1-p)$.\n\nAt equilibrium, $\\frac{\\partial p}{\\partial t} = 0$, leading to the ordinary differential equation:\n$$ 0 = D \\frac{d^2 p}{dx^2} + S(p, x) $$\nTo analyze the structure of this equation, we can non-dimensionalize the spatial coordinate $x$. Let us define a characteristic length scale, $l_c$. The balance between dispersal (the second derivative term) and selection (the reaction term) dictates this scale. By balancing the terms, we find that $l_c \\propto \\sqrt{D/s}$. Substituting our parameter relations, we have:\n$$ l_c \\propto \\sqrt{m^2/s} = \\frac{m}{\\sqrt{s}} $$\nThe solution to the equilibrium equation, $p_{eq}(x)$, when plotted against the rescaled spatial coordinate $z = x/l_c$, becomes a universal function that is independent of the individual parameters $m$ and $s$. All clines with the same form of selection have the same shape when space is measured in units of their characteristic length.\n\nThe cline steepness, measured by $|\\frac{dp}{dx}|$ at the center, is inversely proportional to the cline width, $w$. The width of the cline is, in turn, proportional to the characteristic length $l_c$.\n$$ \\left|\\frac{dp}{dx}\\right|_{max} \\propto \\frac{1}{w} \\propto \\frac{1}{l_c} \\propto \\frac{\\sqrt{s}}{m} $$\nObserving the cline steepness provides an estimate of the compound parameter $\\sqrt{s}/m$. It is impossible to determine $s$ and $m$ separately from this single observable. Any combination of $s$ and $m$ that preserves this ratio will produce an identical equilibrium cline shape. This is a fundamental problem of parameter confounding. To resolve this ambiguity, one must find a second, independent observable that depends on $s$ and $m$ through a different functional relationship. We will now evaluate each option based on this principle.\n\n**A. Cline steepness alone generally cannot separate $m$ from $s$ because steepness is governed by a single compound spatial scale that combines dispersal and selection; however, observing how quickly a deliberately perturbed cline returns to equilibrium (a temporal relaxation rate) provides an independent timescale that is dominated by $s$, enabling separation of $m$ and $s$ when combined with steepness.**\n\nThis statement is correct. The first clause correctly identifies the confounding of $m$ and $s$ in a single spatial scale, as derived above. The second clause proposes using temporal data. The rate of return to equilibrium after a perturbation is governed by the eigenvalues of the linearized version of the full time-dependent equation. The primary timescale of this process is set by the strength of selection, $s$, because selection is the active force driving allele frequencies towards their equilibrium values. While dispersal ($m$) also affects the relaxation dynamics by smoothing spatial variations, the characteristic timescale for a cline to form or to recover from perturbation is on the order of $1/s$ generations. Therefore, measuring this relaxation rate provides a second relationship, of the form $R \\approx f(s, m)$ where $f$ is not proportional to $\\sqrt{s}/m$. For small perturbations, this rate is approximately proportional to $s$. Thus, we would have two equations: one for steepness ($C_1 \\propto \\sqrt{s}/m$) and one for the relaxation rate ($C_2 \\propto s$), which allows for the separate estimation of $m$ and $s$.\n**Verdict: Correct**\n\n**B. If an independent field study provides a direct estimate of the per-generation dispersal variance of individuals (for example, by parentage assignment or mark–recapture), then combining this dispersal estimate with the observed cline steepness allows separate estimation of $s$.**\n\nThis statement is correct. As established, cline steepness yields an estimate for the ratio $\\sqrt{s}/m$. The parameter $m$ is the dispersal scale, which is directly related to the dispersal variance $\\sigma^2$ (e.g., $m = \\sigma$). Methods such as mark-recapture studies or genetic parentage analysis can provide a direct, independent estimate of dispersal distances and thus of $m$. If one obtains such an estimate, let us call it $m_{est}$, one can substitute it into the relationship from the cline steepness:\n$$ \\text{Steepness} \\propto \\frac{\\sqrt{s}}{m_{est}} $$\nThis equation can then be solved directly for the single unknown parameter, $s$. This is the most straightforward way to break the confounding.\n**Verdict: Correct**\n\n**C. In a roughly homogeneous two-dimensional landscape away from the cline, the genome-wide isolation-by-distance slope for neutral loci yields an estimate of the neighborhood size, which depends on the product of effective population size and dispersal scale. If effective population size can be estimated independently, this yields the dispersal scale and hence allows $m$ and $s$ to be separately estimated when combined with cline steepness.**\n\nThis statement is correct. It proposes a more indirect but powerful genetic method to estimate the dispersal parameter. According to the theory of isolation by distance (IBD) for neutral loci, the slope of the relationship between genetic differentiation and geographic distance depends on the product of the effective population density, $\\rho_e$, and the dispersal variance, $\\sigma^2$. In two dimensions, this product is related to the neighborhood size, $N_b = 4\\pi\\rho_e\\sigma^2$. By measuring the IBD slope using many neutral markers, one can estimate the product $\\rho_e \\sigma^2$. If the effective population density $\\rho_e$ can be estimated through other means (e.g., ecological surveys, or other genetic estimators that depend on $\\rho_e$ but not $\\sigma^2$), one can then solve for $\\sigma^2$. Since $m \\propto \\sigma$, this provides the required independent estimate of the dispersal parameter. As in option B, this knowledge allows for the estimation of $s$ from the cline steepness.\n**Verdict: Correct**\n\n**D. Increasing the number of genotyped individuals at a single time point and location within the cline always resolves the ambiguity between $m$ and $s$ inherent to using cline steepness alone.**\n\nThis statement is incorrect. The issue of confounding between $m$ and $s$ is a structural property of the deterministic model of the equilibrium cline shape. Increasing the sample size of individuals at one or more locations reduces the statistical sampling error in the estimation of the allele frequency function $p(x)$. This leads to a more precise estimate of the cline shape and, consequently, a more precise estimate of the compound parameter $\\sqrt{s}/m$. However, no amount of precision in measuring this ratio can decompose it into its constituent parts. This option confuses statistical precision with parameter identifiability.\n**Verdict: Incorrect**\n\n**E. Knowing the geographic location of the cline center uniquely determines $m$ and $s$, even if only a single locus and a single time point are observed.**\n\nThis statement is incorrect. The geographic location of the cline's center is determined by the spatial structure of the selective environment, specifically, the point where the direction of selection flips or balances. For a symmetric selection gradient $s(x)$ centered at $x_c$, the cline will be centered at $x_c$ regardless of the magnitudes of the selection strength $s$ and the dispersal parameter $m$. Therefore, knowing the location of the center provides information about the spatial symmetry of selection, but it yields no information about the values of $m$ and $s$ themselves and thus cannot be used to disentangle them.\n**Verdict: Incorrect**\n\n**F. Measuring pairwise two-locus linkage disequilibrium across the cline as a function of recombination rate provides an observable that depends on dispersal and recombination in a way that is separable from the dependence on selection; when such two-locus data are combined with single-locus cline steepness, $m$ and $s$ can be estimated separately.**\n\nThis statement is correct. Linkage disequilibrium (LD) between a selected locus and linked neutral loci provides another source of information. The cline in the selected allele creates a \"barrier\" to gene flow for linked loci. LD is generated by the mixing of populations with different genetic backgrounds from either side of the cline and is broken down by recombination. The resulting equilibrium pattern of LD depends on the interplay of three processes: migration (parameter $m$), selection (parameter $s$), and recombination (parameter $r$, the recombination rate). The magnitude and spatial extent of LD as a function of $r$ provide a second set of observables. For example, the amount of LD generated is related to the square of the allele frequency gradient, while it is dissipated by recombination. The resulting functional dependencies on $m$, $s$, and $r$ are different from the simple $\\sqrt{s}/m$ dependency of the cline width. By measuring LD for pairs of loci with different, known recombination rates, one can fit a model to estimate $m$ and $s$ separately. This is a well-established principle in advanced cline analysis.\n**Verdict: Correct**",
            "answer": "$$\\boxed{ABCF}$$"
        },
        {
            "introduction": "The ultimate goal of modeling is often to make inferences from data. This final practice bridges the gap between analytical theory and computational statistics by implementing a Bayesian analysis of migration-selection balance. You will develop code to compare two competing models that differ only in the order of life-cycle events—migration before selection versus selection before migration—and learn how to use a formal model comparison framework to evaluate the posterior probability of each model and the robustness of your parameter estimates for $m$ and $s$ .",
            "id": "2734038",
            "problem": "Consider a single-locus, two-allele, haploid island model with migration and viability selection in a large resident population exchanging migrants with an external immigrant pool whose allele frequency is known. Let the focal allele be denoted by $A$, with frequency $p$ in each resident deme, and by $p_{\\mathrm{m}}$ in the immigrant pool. Let the resident demes be indexed by $j \\in \\{1,\\dots,D\\}$. Assume the following.\n\n- Fundamental base:\n  - Viability selection in haploids is defined by allele-specific relative fitnesses. If $A$ has relative fitness $1+s$ and the alternative allele has fitness $1$, then after selection the allele frequency is proportional to fitness-weighted frequencies. Specifically, the post-selection frequency is the frequency of $A$ after weighting by relative fitness and normalizing by the mean fitness.\n  - Passive migration is mass-action mixing: with migration rate $m \\in [0,1]$, a fraction $m$ of alleles are replaced by immigrants with frequency $p_{\\mathrm{m}}$, and the remaining fraction $1-m$ remain resident.\n  - Observations are generated by binomial sampling: if the expected allele frequency in deme $j$ at the time of sampling is $p'_j$, then observing $x_j$ copies of $A$ in a sample of size $n_j$ has probability given by the binomial distribution with success probability $p'_j$.\n- Two competing life-cycle models are considered:\n  - Model $\\mathcal{M}_{\\mathrm{ms}}$: migration occurs before selection in each generation.\n  - Model $\\mathcal{M}_{\\mathrm{sm}}$: selection occurs before migration in each generation.\n\nSuppose you observe, for each deme $j$, the initial resident allele frequency $p_{0,j}$ immediately before the focal life-cycle stage, the immigrant pool allele frequency $p_{\\mathrm{m},j}$ relevant to deme $j$ (possibly identical across demes), and the sample count $x_j$ of allele $A$ out of $n_j$ sampled immediately after the focal life-cycle stage. Assume conditional independence of demes given parameters.\n\nYour task is to perform Bayesian model comparison between $\\mathcal{M}_{\\mathrm{ms}}$ and $\\mathcal{M}_{\\mathrm{sm}}$ and to evaluate the robustness of inferred migration rate $m$ and selection coefficient $s$ to the ordering of migration and selection.\n\nRequirements:\n\n- Priors:\n  - Place a uniform prior on $m$ over $[0,0.5]$ and a uniform prior on $s$ over $[-0.2,0.5]$. Assume an equal prior over the two models, $\\Pr(\\mathcal{M}_{\\mathrm{ms}}) = \\Pr(\\mathcal{M}_{\\mathrm{sm}}) = 0.5$.\n- Likelihood under a given model:\n  - For each deme $j$, derive the expected post-stage frequency $p'_j$ from the fundamental base definitions by composing selection and migration in the order specified by the model. Then compute the binomial sampling likelihood for observing $x_j$ out of $n_j$ given $p'_j$, and assume independence across demes to obtain the full likelihood. Express all probabilities as decimals, not percentages.\n- Evidence and posteriors:\n  - Compute the marginal likelihood (evidence) for each model by numerically integrating the likelihood over $(m,s)$ with the specified uniform priors. Use a rectangular grid with $201$ evenly spaced points for $m \\in [0,0.5]$ and $251$ evenly spaced points for $s \\in [-0.2,0.5]$. Perform the numerical integration by Riemann summation over the grid and ensure numerical stability (for example, by operating in log space and using a log-sum-exp approach).\n  - Compute the posterior model probabilities $\\Pr(\\mathcal{M}_{\\mathrm{ms}} \\mid \\text{data})$ and $\\Pr(\\mathcal{M}_{\\mathrm{sm}} \\mid \\text{data})$ from the evidences and equal model priors.\n  - Under each model, compute the posterior means $\\mathbb{E}[m \\mid \\text{data}, \\mathcal{M}]$ and $\\mathbb{E}[s \\mid \\text{data}, \\mathcal{M}]$ using the same grid and posterior weights proportional to the likelihood times the prior.\n- Output format:\n  - For each test case in the test suite below, output a list of six floats in the order: $[\\Pr(\\mathcal{M}_{\\mathrm{ms}} \\mid \\text{data}), \\Pr(\\mathcal{M}_{\\mathrm{sm}} \\mid \\text{data}), \\mathbb{E}[m \\mid \\text{data}, \\mathcal{M}_{\\mathrm{ms}}], \\mathbb{E}[s \\mid \\text{data}, \\mathcal{M}_{\\mathrm{ms}}], \\mathbb{E}[m \\mid \\text{data}, \\mathcal{M}_{\\mathrm{sm}}], \\mathbb{E}[s \\mid \\text{data}, \\mathcal{M}_{\\mathrm{sm}}]]$.\n  - Your program should produce a single line of output containing the results for all test cases as a comma-separated list enclosed in square brackets, where each element is the six-float list for one test case, and each float rounded to $6$ decimal places, for example: $[[0.500000,0.500000,0.100000,0.200000,0.100000,0.200000],\\dots]$.\n\nTest suite:\n\n- Case $1$ (migration-before-selection generates the data):\n  - Demes: $D=3$.\n  - Initial resident frequencies: $p_{0} = [0.2, 0.4, 0.6]$.\n  - Immigrant pool frequency: $p_{\\mathrm{m}} = 0.8$ (identical across demes).\n  - Sample sizes: $n = [100, 100, 100]$.\n  - Observed counts: $x = [30, 49, 66]$.\n\n- Case $2$ (selection-before-migration generates the data):\n  - Demes: $D=3$.\n  - Initial resident frequencies: $p_{0} = [0.1, 0.5, 0.9]$.\n  - Immigrant pool frequency: $p_{\\mathrm{m}} = 0.2$.\n  - Sample sizes: $n = [200, 200, 200]$.\n  - Observed counts: $x = [24, 104, 175]$.\n\n- Case $3$ (neutral selection, order irrelevance edge case):\n  - Demes: $D=2$.\n  - Initial resident frequencies: $p_{0} = [0.3, 0.7]$.\n  - Immigrant pool frequency: $p_{\\mathrm{m}} = 0.5$.\n  - Sample sizes: $n = [150, 150]$.\n  - Observed counts: $x = [51, 99]$.\n\n- Case $4$ (high migration dominates, weak order effect):\n  - Demes: $D=3$.\n  - Initial resident frequencies: $p_{0} = [0.0, 0.2, 0.4]$.\n  - Immigrant pool frequency: $p_{\\mathrm{m}} = 0.6$.\n  - Sample sizes: $n = [100, 100, 100]$.\n  - Observed counts: $x = [29, 42, 55]$.\n\nAngle units are not applicable. No physical units are involved. All probabilities must be decimals. Your program must implement the above specifications and produce the single-line output of the aggregated list in the exact format described, with each float rounded to $6$ decimal places.",
            "solution": "The problem is subjected to validation and is found to be scientifically grounded, well-posed, and complete. It represents a standard exercise in computational population genetics, involving Bayesian model comparison and parameter estimation. All necessary data, models, and prior distributions are specified. There are no contradictions or ambiguities. I shall therefore proceed with a complete solution.\n\nThe core of the problem is to compare two competing models for the joint action of migration and natural selection on a haploid population. The models differ in the order of these two evolutionary processes within a generation.\n\nFirst, we define the operators for selection and migration.\nLet $p$ be the frequency of allele $A$ before an evolutionary process.\nThe frequency after viability selection, $p_s$, with relative fitness of $A$ being $1+s$ and the alternative allele being $1$, is given by:\n$$p_s = \\mathcal{S}(p, s) = \\frac{p(1+s)}{p(1+s) + (1-p)(1)} = \\frac{p(1+s)}{1+ps}$$\nThe frequency after migration, $p_m$, where a fraction $m$ of the population is replaced by immigrants with allele frequency $p_{\\mathrm{m}}$, is given by:\n$$p_m = \\mathcal{M}(p, m, p_{\\mathrm{m}}) = (1-m)p + m p_{\\mathrm{m}}$$\nThese definitions are valid for $s > -1$, $m \\in [0,1]$, and frequencies $p, p_{\\mathrm{m}} \\in [0,1]$. The problem constraints on $s \\in [-0.2, 0.5]$ and $m \\in [0, 0.5]$ ensure the validity of these expressions.\n\nNext, we formulate the expected post-stage allele frequency, $p'_j$, for each deme $j$ under the two models. The initial allele frequency is $p_{0,j}$ and the immigrant frequency is $p_{\\mathrm{m},j}$.\n\nModel $\\mathcal{M}_{\\mathrm{ms}}$ (Migration-before-Selection):\nThe allele frequency is first altered by migration and then by selection.\n$$p'_{\\mathrm{ms}, j}(m, s) = \\mathcal{S}(\\mathcal{M}(p_{0,j}, m, p_{\\mathrm{m},j}), s) = \\frac{((1-m)p_{0,j} + m p_{\\mathrm{m},j})(1+s)}{1 + s((1-m)p_{0,j} + m p_{\\mathrm{m},j})}$$\n\nModel $\\mathcal{M}_{\\mathrm{sm}}$ (Selection-before-Migration):\nThe allele frequency is first altered by selection and then by migration.\n$$p'_{\\mathrm{sm}, j}(m, s) = \\mathcal{M}(\\mathcal{S}(p_{0,j}, s), m, p_{\\mathrm{m},j}) = (1-m)\\left(\\frac{p_{0,j}(1+s)}{1+p_{0,j}s}\\right) + m p_{\\mathrm{m},j}$$\n\nThe likelihood of observing the data for a given model $\\mathcal{M}_k$ (where $k \\in \\{\\text{ms, sm}\\}$) and parameters $(m, s)$ is based on binomial sampling. Assuming independence across the $D$ demes, the total likelihood is the product of the individual binomial probabilities:\n$$L(m,s \\mid \\text{data}, \\mathcal{M}_k) = \\prod_{j=1}^D P(x_j \\mid n_j, p'_{k,j}(m,s)) = \\prod_{j=1}^D \\binom{n_j}{x_j} (p'_{k,j})^{x_j} (1-p'_{k,j})^{n_j - x_j}$$\nFor numerical computation, we use the log-likelihood. The term involving the binomial coefficient, $\\sum_j \\log\\binom{n_j}{x_j}$, is constant with respect to model parameters and is identical for both models. Therefore, it cancels when computing posterior model probabilities and can be omitted when calculating posterior means. We define the partial log-likelihood $J_k(m,s)$ as:\n$$J_k(m,s) = \\log L^*(m,s \\mid \\text{data}, \\mathcal{M}_k) = \\sum_{j=1}^D \\left[ x_j \\log(p'_{k,j}(m,s)) + (n_j-x_j)\\log(1-p'_{k,j}(m,s)) \\right]$$\nThe analysis is performed over a discrete grid of parameter values: $m$ on $N_m = 201$ points in $[0, 0.5]$, and $s$ on $N_s = 251$ points in $[-0.2, 0.5]$.\n\nTo perform Bayesian model comparison, we compute the marginal likelihood (evidence) for each model, $\\Pr(\\text{data} \\mid \\mathcal{M}_k)$. This is obtained by integrating the likelihood over the prior distributions.\n$$\\Pr(\\text{data} \\mid \\mathcal{M}_k) = \\int_{-0.2}^{0.5} \\int_0^{0.5} L(m,s \\mid \\text{data}, \\mathcal{M}_k) \\pi(m,s) \\,dm \\,ds$$\nGiven uniform priors, $\\pi(m,s)$ is a constant. The integral is approximated by a Riemann sum over the parameter grid:\n$$\\Pr(\\text{data} \\mid \\mathcal{M}_k) \\propto \\sum_i \\sum_l L(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)$$\nLet $U_k = \\sum_{i,l} L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)$. Since model priors are equal, $\\Pr(\\mathcal{M}_{\\mathrm{ms}}) = \\Pr(\\mathcal{M}_{\\mathrm{sm}}) = 0.5$, the posterior probability of a model is proportional to its evidence:\n$$\\Pr(\\mathcal{M}_{\\mathrm{ms}} \\mid \\text{data}) = \\frac{U_{\\mathrm{ms}}}{U_{\\mathrm{ms}} + U_{\\mathrm{sm}}}$$\n$$\\Pr(\\mathcal{M}_{\\mathrm{sm}} \\mid \\text{data}) = \\frac{U_{\\mathrm{sm}}}{U_{\\mathrm{ms}} + U_{\\mathrm{sm}}}$$\nTo compute these sums stably, we use the log-sum-exp trick. We compute the grid of log-likelihoods $J_k(m_i, s_l)$, find the maximum value $J_{k, \\text{max}}$, and then compute the sum of exponentiated values relative to this maximum. Let $\\log U_k = J_{k, \\text{max}} + \\log\\left(\\sum_{i,l} \\exp(J_k(m_i, s_l) - J_{k, \\text{max}})\\right)$. The posterior probability for $\\mathcal{M}_{\\mathrm{ms}}$ becomes:\n$$\\Pr(\\mathcal{M}_{\\mathrm{ms}} \\mid \\text{data}) = \\frac{1}{1 + \\exp(\\log U_{\\mathrm{sm}} - \\log U_{\\mathrm{ms}})}$$\n\nThe posterior mean of a parameter, say $m$, under model $\\mathcal{M}_k$ is computed as a weighted average over the grid, where the weights are the posterior probabilities at each grid point, which are proportional to the likelihood values $L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)$.\n$$\\mathbb{E}[m \\mid \\text{data}, \\mathcal{M}_k] \\approx \\frac{\\sum_{i,l} m_i L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)}{\\sum_{i,l} L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)}$$\n$$\\mathbb{E}[s \\mid \\text{data}, \\mathcal{M}_k] \\approx \\frac{\\sum_{i,l} s_l L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)}{\\sum_{i,l} L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)}$$\nThese calculations are also performed using the numerically stable weights derived from the log-likelihood grid. The implementation will proceed by vectorizing these calculations over the parameter grid for efficiency.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the Bayesian model comparison problem for all test cases.\n    \"\"\"\n    test_cases = [\n        # Case 1 (migration-before-selection generates the data)\n        {\n            \"p0\": np.array([0.2, 0.4, 0.6]),\n            \"pm\": 0.8,\n            \"n\": np.array([100, 100, 100]),\n            \"x\": np.array([30, 49, 66]),\n        },\n        # Case 2 (selection-before-migration generates the data)\n        {\n            \"p0\": np.array([0.1, 0.5, 0.9]),\n            \"pm\": 0.2,\n            \"n\": np.array([200, 200, 200]),\n            \"x\": np.array([24, 104, 175]),\n        },\n        # Case 3 (neutral selection, order irrelevance edge case)\n        {\n            \"p0\": np.array([0.3, 0.7]),\n            \"pm\": 0.5,\n            \"n\": np.array([150, 150]),\n            \"x\": np.array([51, 99]),\n        },\n        # Case 4 (high migration dominates, weak order effect)\n        {\n            \"p0\": np.array([0.0, 0.2, 0.4]),\n            \"pm\": 0.6,\n            \"n\": np.array([100, 100, 100]),\n            \"x\": np.array([29, 42, 55]),\n        },\n    ]\n\n    # Define the parameter grid\n    m_grid = np.linspace(0, 0.5, 201)\n    s_grid = np.linspace(-0.2, 0.5, 251)\n    M, S = np.meshgrid(m_grid, s_grid, indexing='ij')\n\n    results = []\n    for case in test_cases:\n        p0, pm, n, x = case[\"p0\"], case[\"pm\"], case[\"n\"], case[\"x\"]\n\n        # Analyze Model M_ms (migration-before-selection)\n        log_evidence_sum_ms, E_m_ms, E_s_ms = analyze_model(\n            p_prime_ms, p0, pm, n, x, M, S\n        )\n\n        # Analyze Model M_sm (selection-before-migration)\n        log_evidence_sum_sm, E_m_sm, E_s_sm = analyze_model(\n            p_prime_sm, p0, pm, n, x, M, S\n        )\n\n        # Calculate posterior model probabilities\n        # Pr(M_ms | data) = E_ms / (E_ms + E_sm) = 1 / (1 + E_sm/E_ms)\n        # log(E_sm/E_ms) = log(E_sm) - log(E_ms)\n        log_ratio = log_evidence_sum_sm - log_evidence_sum_ms\n        \n        # Handle potential overflow/underflow if differences are very large\n        if log_ratio > 700: # exp(700) is large\n            p_ms = 0.0\n        elif log_ratio  -700:\n            p_ms = 1.0\n        else:\n            p_ms = 1.0 / (1.0 + np.exp(log_ratio))\n        \n        p_sm = 1.0 - p_ms\n\n        case_results = [p_ms, p_sm, E_m_ms, E_s_ms, E_m_sm, E_s_sm]\n        results.append(case_results)\n\n    # Format output\n    formatted_results = []\n    for res_list in results:\n        formatted_list_str = \"[\" + \",\".join([f\"{val:.6f}\" for val in res_list]) + \"]\"\n        formatted_results.append(formatted_list_str)\n\n    print(f\"[{','.join(formatted_results)}]\")\n\ndef p_prime_ms(p0_deme, pm, M, S):\n    \"\"\"Calculates final allele frequency for the Migration-before-Selection model.\"\"\"\n    p_post_mig = (1 - M) * p0_deme + M * pm\n    # Denominator 1 + p_post_mig * S is always > 0 for s > -1\n    return (p_post_mig * (1 + S)) / (1 + p_post_mig * S)\n\ndef p_prime_sm(p0_deme, pm, M, S):\n    \"\"\"Calculates final allele frequency for the Selection-before-Migration model.\"\"\"\n    # Denominator 1 + p0_deme * S is always > 0 for s > -1\n    p_post_sel = (p0_deme * (1 + S)) / (1 + p0_deme * S)\n    return (1 - M) * p_post_sel + M * pm\n\ndef analyze_model(model_func, p0, pm, n, x, M, S):\n    \"\"\"\n    Computes log-evidence sum and posterior means for a given model.\n    \"\"\"\n    total_log_likelihood = np.zeros_like(M)\n\n    for j in range(len(p0)):\n        # Calculate expected frequency grid for deme j\n        p_prime_grid = model_func(p0[j], pm, M, S)\n        \n        # Clip for numerical stability of log\n        p_prime_grid = np.clip(p_prime_grid, 1e-12, 1.0 - 1e-12)\n        \n        # Calculate log-likelihood for deme j and add to total\n        deme_log_L = x[j] * np.log(p_prime_grid) + (n[j] - x[j]) * np.log(1.0 - p_prime_grid)\n        total_log_likelihood += deme_log_L\n    \n    # Use log-sum-exp for stable computation of evidence and posterior means\n    log_L_max = np.max(total_log_likelihood)\n    weights = np.exp(total_log_likelihood - log_L_max)\n    total_weight = np.sum(weights)\n\n    log_evidence_sum = log_L_max + np.log(total_weight)\n\n    # Posterior means\n    E_m = np.sum(weights * M) / total_weight\n    E_s = np.sum(weights * S) / total_weight\n\n    return log_evidence_sum, E_m, E_s\n\nsolve()\n```"
        }
    ]
}