{
    "hands_on_practices": [
        {
            "introduction": "Mastering population genetics begins with a firm grasp of its foundational metrics. This first practice exercise  guides you through the fundamental calculation of Wright's F-statistics directly from observed genotype counts. By computing the key components of heterozygosity—within and between populations—you will build a concrete understanding of how $F_{IS}$ and $F_{ST}$ quantify deviations from Hardy-Weinberg expectations and the extent of population differentiation.",
            "id": "2745312",
            "problem": "A bi-allelic Single Nucleotide Polymorphism (SNP) is genotyped in two demes. Deme $1$ has genotype counts $AA: 40$, $Aa: 20$, $aa: 40$. Deme $2$ has genotype counts $AA: 60$, $Aa: 20$, $aa: 20$. Assume the locus is neutral and the expected within-deme genotype frequencies are those of Hardy–Weinberg equilibrium (HWE) computed from the deme-specific sample allele frequencies. Using Wright’s fixation indices (F-statistics), do the following:\n\n1. For each deme, compute the observed heterozygosity $H_{O}$ and the expected heterozygosity under HWE, $H_{E} = 2p(1-p)$, where $p$ is the deme-specific allele frequency of $A$. Then compute the within-deme inbreeding coefficient $F_{IS}$, defined as the proportional deficit of heterozygotes relative to HWE within demes.\n\n2. Compute the mean within-deme expected heterozygosity $H_{S}$ by averaging $H_{E}$ across demes (note that the two demes have equal sample sizes).\n\n3. Compute the total allele frequency $p_{T}$ from the pooled sample, the total expected heterozygosity $H_{T} = 2p_{T}(1-p_{T})$, and the among-deme fixation index $F_{ST}$ defined as the standardized reduction in heterozygosity within demes relative to the total.\n\nReport your final results as exact values (simplified fractions, not decimals) in the order ($F_{IS}$ for deme 1, $F_{IS}$ for deme 2, $H_S$, $H_T$, $F_{ST}$). No rounding is required. Express your final answer as a row matrix.",
            "solution": "The problem as stated is subjected to validation.\n\nStep 1: Extract Givens.\n- A bi-allelic Single Nucleotide Polymorphism (SNP) is analyzed. The alleles are denoted as $A$ and $a$.\n- Two demes are sampled.\n- Deme $1$ genotype counts: $AA: 40$, $Aa: 20$, $aa: 40$.\n- Deme $2$ genotype counts: $AA: 60$, $Aa: 20$, $aa: 20$.\n- The locus is assumed to be neutral.\n- Expected within-deme genotype frequencies are those of Hardy–Weinberg equilibrium (HWE).\n- Formula for expected heterozygosity: $H_{E} = 2p(1-p)$, where $p$ is the deme-specific allele frequency of $A$.\n- Definition of within-deme inbreeding coefficient $F_{IS}$: proportional deficit of heterozygotes relative to HWE within demes. The standard formula is $F_{IS} = \\frac{H_E - H_O}{H_E}$.\n- Definition of mean within-deme expected heterozygosity $H_{S}$: average of $H_{E}$ across demes. The demes have equal sample sizes.\n- Definition of total expected heterozygosity: $H_{T} = 2p_{T}(1-p_{T})$, where $p_T$ is the total allele frequency from the pooled sample.\n- Definition of among-deme fixation index $F_{ST}$: standardized reduction in heterozygosity within demes relative to the total. The standard formula is $F_{ST} = \\frac{H_T - H_S}{H_T}$.\n\nStep 2: Validate Using Extracted Givens.\nThe problem is a standard exercise in population genetics concerning Wright's F-statistics. All terms are well-defined, and the provided data are consistent. The sample size for deme $1$ is $N_1 = 40 + 20 + 40 = 100$. The sample size for deme $2$ is $N_2 = 60 + 20 + 20 = 100$. The statement that the demes have equal sample sizes is verified by the data. The problem is scientifically grounded, well-posed, and objective. It contains no logical contradictions, missing information, or ambiguities.\n\nStep 3: Verdict and Action.\nThe problem is deemed valid. A complete solution will be provided.\n\nThe solution proceeds by following the steps outlined in the problem statement.\n\nPart 1: Per-deme calculations ($F_{IS}$)\n\nFor Deme $1$:\nThe sample size is $N_1 = 40 + 20 + 40 = 100$.\nThe count of allele $A$ is $2 \\times (\\text{count of } AA) + 1 \\times (\\text{count of } Aa) = 2 \\times 40 + 20 = 100$.\nThe total number of alleles is $2N_1 = 200$.\nThe frequency of allele $A$ in deme $1$ is $p_1 = \\frac{100}{200} = \\frac{1}{2}$.\nThe frequency of allele $a$ is $q_1 = 1 - p_1 = 1 - \\frac{1}{2} = \\frac{1}{2}$.\nThe observed heterozygosity in deme $1$ is the frequency of heterozygotes: $H_{O,1} = \\frac{\\text{count of } Aa}{N_1} = \\frac{20}{100} = \\frac{1}{5}$.\nThe expected heterozygosity under HWE is $H_{E,1} = 2p_1q_1 = 2 \\times \\frac{1}{2} \\times \\frac{1}{2} = \\frac{1}{2}$.\nThe within-deme inbreeding coefficient for deme $1$ is $F_{IS,1} = \\frac{H_{E,1} - H_{O,1}}{H_{E,1}} = \\frac{\\frac{1}{2} - \\frac{1}{5}}{\\frac{1}{2}} = \\frac{\\frac{5-2}{10}}{\\frac{1}{2}} = \\frac{\\frac{3}{10}}{\\frac{1}{2}} = \\frac{3}{10} \\times 2 = \\frac{3}{5}$.\n\nFor Deme $2$:\nThe sample size is $N_2 = 60 + 20 + 20 = 100$.\nThe count of allele $A$ is $2 \\times (\\text{count of } AA) + 1 \\times (\\text{count of } Aa) = 2 \\times 60 + 20 = 140$.\nThe total number of alleles is $2N_2 = 200$.\nThe frequency of allele $A$ in deme $2$ is $p_2 = \\frac{140}{200} = \\frac{7}{10}$.\nThe frequency of allele $a$ is $q_2 = 1 - p_2 = 1 - \\frac{7}{10} = \\frac{3}{10}$.\nThe observed heterozygosity in deme $2$ is $H_{O,2} = \\frac{\\text{count of } Aa}{N_2} = \\frac{20}{100} = \\frac{1}{5}$.\nThe expected heterozygosity under HWE is $H_{E,2} = 2p_2q_2 = 2 \\times \\frac{7}{10} \\times \\frac{3}{10} = \\frac{42}{100} = \\frac{21}{50}$.\nThe within-deme inbreeding coefficient for deme $2$ is $F_{IS,2} = \\frac{H_{E,2} - H_{O,2}}{H_{E,2}} = \\frac{\\frac{21}{50} - \\frac{1}{5}}{\\frac{21}{50}} = \\frac{\\frac{21-10}{50}}{\\frac{21}{50}} = \\frac{\\frac{11}{50}}{\\frac{21}{50}} = \\frac{11}{21}$.\n\nPart 2: Mean within-deme expected heterozygosity ($H_S$)\n$H_S$ is the average of the expected heterozygosities of the demes. Since the sample sizes are equal ($N_1 = N_2$), we compute a simple arithmetic mean.\n$H_S = \\frac{H_{E,1} + H_{E,2}}{2} = \\frac{\\frac{1}{2} + \\frac{21}{50}}{2} = \\frac{\\frac{25}{50} + \\frac{21}{50}}{2} = \\frac{\\frac{46}{50}}{2} = \\frac{23}{50}$.\n\nPart 3: Total population calculations ($H_T$, $F_{ST}$)\nFirst, we compute the allele frequency in the total pooled population.\nTotal sample size $N_T = N_1 + N_2 = 100 + 100 = 200$.\nTotal count of allele $A$ = (count in deme $1$) + (count in deme $2$) = $100 + 140 = 240$.\nTotal number of alleles = $2N_T = 2 \\times 200 = 400$.\nThe total allele frequency for $A$ is $p_T = \\frac{240}{400} = \\frac{24}{40} = \\frac{3}{5}$.\nThe total allele frequency for $a$ is $q_T = 1 - p_T = 1 - \\frac{3}{5} = \\frac{2}{5}$.\nThe total expected heterozygosity, if the pooled population were a single random-mating unit, is $H_T = 2p_Tq_T = 2 \\times \\frac{3}{5} \\times \\frac{2}{5} = \\frac{12}{25}$.\n\nFinally, we compute the among-deme fixation index, $F_{ST}$.\n$F_{ST} = \\frac{H_T - H_S}{H_T}$.\nWe convert $H_T$ to a common denominator with $H_S$: $H_T = \\frac{12}{25} = \\frac{24}{50}$.\n$H_S = \\frac{23}{50}$.\n$F_{ST} = \\frac{\\frac{24}{50} - \\frac{23}{50}}{\\frac{24}{50}} = \\frac{\\frac{1}{50}}{\\frac{24}{50}} = \\frac{1}{24}$.\n\nThe final results, in the specified order, are:\n- $F_{IS}$ of deme $1 = \\frac{3}{5}$\n- $F_{IS}$ of deme $2 = \\frac{11}{21}$\n- $H_S = \\frac{23}{50}$\n- $H_T = \\frac{12}{25}$\n- $F_{ST} = \\frac{1}{24}$",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{3}{5} & \\frac{11}{21} & \\frac{23}{50} & \\frac{12}{25} & \\frac{1}{24}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "F-statistics offer a powerful summary of population structure, but their interpretation requires nuance. This exercise  presents a carefully constructed scenario to demonstrate that different evolutionary processes can operate simultaneously at different hierarchical levels, leading to seemingly contradictory results. By analyzing a case where an excess of heterozygotes exists locally ($F_{IS} \\lt 0$) despite significant overall population subdivision ($F_{ST} \\gt 0$), you will learn to dissect the distinct biological stories told by each F-statistic.",
            "id": "2745275",
            "problem": "A bi-allelic locus with alleles $A$ and $a$ is genotyped in two demes of equal sample size. In deme $1$ ($n=100$), the observed genotype counts are $AA=45$, $Aa=50$, and $aa=5$. In deme $2$ ($n=100$), the observed genotype counts are $AA=5$, $Aa=50$, and $aa=45$. Treat these samples as representative of the demes. Assume random sampling, no genotyping error, and use sample-size weighting across demes wherever a weighted average is required.\n\nUsing only the fundamental definitions of allele frequency, observed heterozygosity, and Hardy–Weinberg equilibrium (HWE) expectations, and adopting Wright’s classical fixation index (F-statistics) framework relating observed and expected heterozygosity, do the following:\n\n- Compute the allele frequency of $A$ in each deme.\n- Compute the observed heterozygosity in each deme and the expected heterozygosity under HWE in each deme.\n- Compute the sample-size-weighted within-deme average of observed heterozygosity, denoted $H_{I}$, and the sample-size-weighted within-deme average of expected heterozygosity under HWE, denoted $H_{S}$.\n- Compute the total allele frequency across demes and the corresponding expected heterozygosity under HWE for the total, denoted $H_{T}$.\n- From these quantities, compute $F_{IS}$ and $F_{ST}$, and demonstrate that $F_{IS}0$ while $F_{ST}>0$.\n- Briefly interpret the biological meaning of heterozygote excess within demes despite population structure.\n\nReport the value of $F_{ST}$ as your final answer, expressed as a decimal and rounded to four significant figures.",
            "solution": "The problem as stated is scientifically sound, self-contained, and logically consistent. It represents a standard exercise in the application of Wright's F-statistics in population genetics. We will proceed to solve it methodically.\n\nThe fundamental definitions required are for allele frequency, observed heterozygosity ($H_O$), and expected heterozygosity under Hardy–Weinberg equilibrium ($H_E$). For a bi-allelic locus with alleles $A$ and $a$, in a sample of $n$ individuals with genotype counts $N_{AA}$, $N_{Aa}$, and $N_{aa}$:\nThe frequency of allele $A$, denoted $p$, is $p = \\frac{2 N_{AA} + N_{Aa}}{2n}$.\nThe observed heterozygosity is $H_O = \\frac{N_{Aa}}{n}$.\nThe expected heterozygosity is $H_E = 2pq$, where $q = 1-p$.\n\nWe first analyze each deme separately.\n\nFor deme $1$:\nSample size $n_1 = 100$.\nGenotype counts are $N_{AA,1} = 45$, $N_{Aa,1} = 50$, $N_{aa,1} = 5$.\nThe frequency of allele $A$ is:\n$$p_1 = \\frac{2 \\times 45 + 50}{2 \\times 100} = \\frac{90 + 50}{200} = \\frac{140}{200} = 0.7$$\nThe observed heterozygosity is:\n$$H_{O,1} = \\frac{50}{100} = 0.5$$\nThe corresponding expected heterozygosity under HWE, given $p_1 = 0.7$ and $q_1 = 1 - 0.7 = 0.3$, is:\n$$H_{E,1} = 2 p_1 q_1 = 2 \\times 0.7 \\times 0.3 = 0.42$$\n\nFor deme $2$:\nSample size $n_2 = 100$.\nGenotype counts are $N_{AA,2} = 5$, $N_{Aa,2} = 50$, $N_{aa,2} = 45$.\nThe frequency of allele $A$ is:\n$$p_2 = \\frac{2 \\times 5 + 50}{2 \\times 100} = \\frac{10 + 50}{200} = \\frac{60}{200} = 0.3$$\nThe observed heterozygosity is:\n$$H_{O,2} = \\frac{50}{100} = 0.5$$\nThe corresponding expected heterozygosity under HWE, given $p_2 = 0.3$ and $q_2 = 1 - 0.3 = 0.7$, is:\n$$H_{E,2} = 2 p_2 q_2 = 2 \\times 0.3 \\times 0.7 = 0.42$$\n\nNext, we calculate the hierarchical heterozygosity components required for F-statistics.\n$H_I$ is the weighted average of observed heterozygosity within demes. As sample sizes are equal ($n_1=n_2$), this is the arithmetic mean:\n$$H_I = \\frac{H_{O,1} + H_{O,2}}{2} = \\frac{0.5 + 0.5}{2} = 0.5$$\n$H_S$ is the weighted average of expected heterozygosity within demes:\n$$H_S = \\frac{H_{E,1} + H_{E,2}}{2} = \\frac{0.42 + 0.42}{2} = 0.42$$\n$H_T$ is the expected heterozygosity for the total population. First, we compute the total allele frequency, $\\bar{p}$, as the weighted average of deme frequencies:\n$$\\bar{p} = \\frac{n_1 p_1 + n_2 p_2}{n_1 + n_2} = \\frac{100 \\times 0.7 + 100 \\times 0.3}{100 + 100} = \\frac{70 + 30}{200} = 0.5$$\nThen, $H_T$ is calculated based on $\\bar{p}$:\n$$H_T = 2 \\bar{p} (1-\\bar{p}) = 2 \\times 0.5 \\times (1-0.5) = 0.5$$\n\nNow, we compute the F-statistics, $F_{IS}$ and $F_{ST}$.\n$F_{IS}$ measures the correlation of alleles within individuals relative to their subpopulation, indicating local deviations from random mating.\n$$F_{IS} = \\frac{H_S - H_I}{H_S} = \\frac{0.42 - 0.50}{0.42} = \\frac{-0.08}{0.42} \\approx -0.190476$$\nThe result $F_{IS}  0$ demonstrates a clear excess of heterozygotes within the demes compared to what is expected under HWE within those demes.\n\n$F_{ST}$ measures the effect of population subdivision by quantifying the reduction in heterozygosity due to allele frequency differences among subpopulations (the Wahlund effect).\n$$F_{ST} = \\frac{H_T - H_S}{H_T} = \\frac{0.50 - 0.42}{0.50} = \\frac{0.08}{0.50} = 0.16$$\nThe result $F_{ST} > 0$ demonstrates the existence of significant genetic differentiation between the two demes, as their allele frequencies ($p_1=0.7$, $p_2=0.3$) are substantially different.\n\nThe biological interpretation is as follows: The negative value of $F_{IS}$ indicates a non-random mating system within demes, specifically one that generates an excess of heterozygotes. This could be due to negative assortative mating or heterozygote advantage (overdominance). The positive value of $F_{ST}$ confirms population structure; the two demes are genetically distinct. This differentiation leads to a deficit of heterozygotes when the subpopulations are considered as a single entity, which is the essence of the Wahlund effect. The apparently paradoxical situation of local heterozygote excess ($F_{IS}0$) combined with population subdivision ($F_{ST}>0$) is a classic case study in population genetics, illustrating that different evolutionary processes can operate simultaneously at different hierarchical levels.\n\nThe final answer requested is the value of $F_{ST}$ rounded to four significant figures.\nOur calculated value is exactly $0.16$. Expressed to four significant figures, this is $0.1600$.",
            "answer": "$$\\boxed{0.1600}$$"
        },
        {
            "introduction": "Modern population genomics relies on analyzing hundreds or thousands of loci, requiring robust statistical methods that account for the complexities of genomic data. This advanced practice  moves from single-locus theory to real-world application by tasking you with deriving and implementing a multilocus estimator for global $F_{ST}$. You will also confront the critical issue of non-independence among loci by designing a block-bootstrap procedure to generate reliable confidence intervals, a cornerstone of rigorous genomic analysis.",
            "id": "2745310",
            "problem": "You are given multilocus allele count data from multiple subpopulations and asked to construct a principled, implementable estimator for the global fixation index ($F_{ST}$) and a confidence interval that accounts for linkage disequilibrium (LD). Your task is to start from the basic definitions of gene diversity and population structure, derive a valid ratio-of-sums estimator for global multilocus $F_{ST}$ based on per-locus within- and total-gene diversities, and then design and implement a block-bootstrap algorithm to obtain an empirical confidence interval that accounts for statistical dependence among loci due to LD. All computations must be expressed as decimals, not percentages.\n\nFundamental assumptions for derivation:\n- Consider $K$ subpopulations and a biallelic locus $\\ell$. Let $x_{k,\\ell}$ be the count of a focal allele in subpopulation $k$ at locus $\\ell$, and let $m_{k,\\ell}$ be the total number of sampled gene copies in subpopulation $k$ at locus $\\ell$, with $m_{k,\\ell} \\ge 1$ and $0 \\le x_{k,\\ell} \\le m_{k,\\ell}$.\n- Define the sample allele frequency in subpopulation $k$ at locus $\\ell$ by $p_{k,\\ell} = x_{k,\\ell} / m_{k,\\ell}$, and the locus-specific total sample size $M_{\\ell} = \\sum_{k=1}^{K} m_{k,\\ell}$.\n- Define the locus-specific sample-size weights $w_{k,\\ell} = m_{k,\\ell} / M_{\\ell}$ so that $\\sum_{k=1}^{K} w_{k,\\ell} = 1$.\n- Define within-subpopulation gene diversity at locus $\\ell$ by $H_{S,\\ell} = \\sum_{k=1}^{K} w_{k,\\ell} \\cdot \\left(2 p_{k,\\ell} \\left(1 - p_{k,\\ell}\\right)\\right)$ and the total gene diversity by $H_{T,\\ell} = 2 \\bar{p}_{\\ell} \\left(1 - \\bar{p}_{\\ell}\\right)$, where $\\bar{p}_{\\ell} = \\sum_{k=1}^{K} w_{k,\\ell} p_{k,\\ell}$.\n- Use only loci with $H_{T,\\ell}  0$ to avoid degenerate cases.\n\nTasks:\n1. From the above definitions, derive a multilocus ratio-of-sums estimator for the global $F_{ST}$ across a set of loci $\\mathcal{L}$ that aggregates per-locus contributions additively in the numerator and denominator. Your derivation should start with the definition of $F_{ST}$ as a standardized reduction in gene diversity within subpopulations relative to the total gene pool and proceed to a ratio-of-sums form over loci.\n2. Propose a block-bootstrap procedure that accounts for linkage disequilibrium by resampling predefined, non-overlapping blocks of loci with replacement. Resample blocks until at least the original number of loci is reached and then truncate the resampled concatenation back to the original locus count to keep the sample size fixed. Use the empirical distribution of the bootstrapped estimator to form a two-sided confidence interval using the lower and upper quantiles at $0.025$ and $0.975$.\n3. Implement a program that, for each test case described below, computes the global multilocus estimator and a 95% confidence interval as decimals. Your implementation must:\n   - Use only the data structures provided in each test case.\n   - Exclude loci with $H_{T,\\ell} = 0$ from contributing to the numerator and denominator.\n   - Use $B = 2000$ bootstrap replicates and a fixed random seed of $12345$ for reproducibility.\n   - Treat the input as biallelic allele counts without requiring individual-level genotypes.\n\nTest suite:\nFor each test case, you are given the number of subpopulations $K$, the number of loci $L$, per-population allele counts $x_{k,\\ell}$ and totals $m_{k,\\ell}$ as arrays indexed by subpopulation and locus, a vector of block identifiers for each locus, and the bootstrap replicate count $B$.\n\n- Test case $1$ (happy path, uneven sample sizes, nontrivial LD blocks):\n  - $K = 3$, $L = 8$.\n  - Allele counts $x_{k,\\ell}$ by subpopulation:\n    - Subpopulation $1$: $[12, 15, 18, 5, 22, 30, 8, 25]$.\n    - Subpopulation $2$: $[20, 19, 12, 6, 30, 12, 10, 30]$.\n    - Subpopulation $3$: $[28, 24, 20, 10, 35, 20, 6, 35]$.\n  - Total gene copies $m_{k,\\ell}$ by subpopulation:\n    - Subpopulation $1$: $[40, 36, 38, 30, 44, 40, 32, 50]$.\n    - Subpopulation $2$: $[42, 30, 34, 28, 46, 36, 28, 52]$.\n    - Subpopulation $3$: $[48, 40, 36, 26, 50, 38, 30, 54]$.\n  - Block identifiers for loci (positions $1$ through $8$): $[0, 0, 0, 1, 1, 2, 2, 2]$.\n  - Bootstrap replicates $B = 2000$.\n\n- Test case $2$ (edge case with a monomorphic locus and independent blocks):\n  - $K = 2$, $L = 5$.\n  - Allele counts $x_{k,\\ell}$ by subpopulation:\n    - Subpopulation $1$: $[10, 18, 0, 35, 22]$.\n    - Subpopulation $2$: $[12, 17, 0, 25, 23]$.\n  - Total gene copies $m_{k,\\ell}$ by subpopulation:\n    - Subpopulation $1$: $[40, 36, 40, 50, 44]$.\n    - Subpopulation $2$: $[42, 34, 38, 50, 46]$.\n  - Block identifiers: $[0, 1, 2, 3, 4]$.\n  - Bootstrap replicates $B = 2000$.\n\n- Test case $3$ (strong structure with LD blocks of size two):\n  - $K = 2$, $L = 6$.\n  - Allele counts $x_{k,\\ell}$ by subpopulation:\n    - Subpopulation $1$: $[1, 5, 0, 1, 22, 2]$.\n    - Subpopulation $2$: $[39, 45, 30, 33, 24, 58]$.\n  - Total gene copies $m_{k,\\ell}$ by subpopulation:\n    - Subpopulation $1$: $[40, 50, 30, 36, 44, 60]$.\n    - Subpopulation $2$: $[40, 50, 30, 34, 46, 60]$.\n  - Block identifiers: $[0, 0, 1, 1, 2, 2]$.\n  - Bootstrap replicates $B = 2000$.\n\nFinal output format:\n- For each test case, compute the global multilocus estimator and its two-sided 95% block-bootstrap confidence interval endpoints as decimals and return them as a list $[ \\widehat{F}_{ST}, \\mathrm{low}, \\mathrm{high} ]$.\n- Your program should produce a single line of output containing a list of these per-test-case lists, in the exact format\n  \"[[f1,l1,u1],[f2,l2,u2],[f3,l3,u3]]\"\n  where each symbol denotes a decimal number.",
            "solution": "The problem is valid as it is scientifically grounded in population genetics theory, well-posed with sufficient data and clear objectives, and free of contradictions or ambiguities. I shall proceed with the derivation and implementation.\n\nThe analysis is based on the quantification of genetic differentiation using the Fixation Index, $F_{ST}$. This index measures the reduction in heterozygosity in subpopulations compared to the total population due to population structure.\n\n**Part 1: Derivation of the Global Multilocus Estimator for $F_{ST}$**\n\nThe foundation of the $F_{ST}$ statistic is the partitioning of gene diversity (heterozygosity). For a single biallelic locus $\\ell$, we define two levels of gene diversity based on sample allele frequencies.\n\nLet $p_{k,\\ell}$ be the frequency of a focal allele in subpopulation $k$ ($k=1, \\dots, K$) at locus $\\ell$. The expected heterozygosity, assuming Hardy-Weinberg equilibrium within this subpopulation, is $2 p_{k,\\ell}(1-p_{k,\\ell})$.\n\nThe average gene diversity within subpopulations, $H_{S,\\ell}$, is the weighted average of these subpopulation heterozygosities. The weights $w_{k,\\ell} = m_{k,\\ell} / M_{\\ell}$ account for differing sample sizes $m_{k,\\ell}$ across subpopulations, where $M_{\\ell} = \\sum_{k=1}^K m_{k,\\ell}$.\n$$ H_{S,\\ell} = \\sum_{k=1}^{K} w_{k,\\ell} \\left(2 p_{k,\\ell} (1 - p_{k,\\ell})\\right) $$\n\nThe total gene diversity, $H_{T,\\ell}$, is the expected heterozygosity in a hypothetical total population formed by pooling all subpopulations. This is calculated using the weighted average allele frequency across subpopulations, $\\bar{p}_{\\ell} = \\sum_{k=1}^{K} w_{k,\\ell} p_{k,\\ell}$.\n$$ H_{T,\\ell} = 2 \\bar{p}_{\\ell} (1 - \\bar{p}_{\\ell}) $$\nIt is a mathematical fact that $H_{T,\\ell} \\ge H_{S,\\ell}$, with equality holding only when allele frequencies are identical across all subpopulations ($p_{1,\\ell} = p_{2,\\ell} = \\dots = p_{K,\\ell}$).\n\nThe fixation index for locus $\\ell$, $F_{ST,\\ell}$, is defined as the proportion of total gene diversity that is found among subpopulations. It is the standardized difference between total and within-subpopulation diversity:\n$$ F_{ST,\\ell} = \\frac{H_{T,\\ell} - H_{S,\\ell}}{H_{T,\\ell}} $$\nThis per-locus estimator can be noisy, especially for loci with low polymorphism (low $H_{T,\\ell}$).\n\nTo obtain a more robust global estimate across multiple loci $\\mathcal{L}$, we must combine the information. A simple average of $F_{ST,\\ell}$ values is ill-advised as it gives undue weight to noisy estimates from loci with low diversity. The standard and principled approach, as requested, is a ratio-of-sums estimator. This method aggregates the components of diversity across all informative loci before calculating the ratio. An informative locus is one with non-zero total gene diversity, i.e., $H_{T,\\ell}  0$. Let this set of informative loci be $\\mathcal{L}'$.\n\nThe global multilocus estimator, $\\widehat{F}_{ST}$, is therefore defined as:\n$$ \\widehat{F}_{ST} = \\frac{\\sum_{\\ell \\in \\mathcal{L}'} (H_{T,\\ell} - H_{S,\\ell})}{\\sum_{\\ell \\in \\mathcal{L}'} H_{T,\\ell}} $$\nThis can be expressed more simply for computation:\n$$ \\widehat{F}_{ST} = 1 - \\frac{\\sum_{\\ell \\in \\mathcal{L}'} H_{S,\\ell}}{\\sum_{\\ell \\in \\mathcal{L}'} H_{T,\\ell}} $$\nThis estimator pools the diversity components, effectively weighting each locus by its total gene diversity, $H_{T,\\ell}$. This is a robust and widely used estimator, equivalent to Nei's $G_{ST}$ for multiple loci.\n\n**Part 2: Block-Bootstrap Procedure for Confidence Interval Estimation**\n\nTo assess the statistical uncertainty of the $\\widehat{F}_{ST}$ point estimate, we require a confidence interval. The classical theoretical approach is often intractable, especially with complex dependencies among loci. The bootstrap is a computational alternative. However, standard bootstrapping, which resamples individual loci with replacement, is inappropriate here as it assumes independence among loci. This assumption is violated by linkage disequilibrium (LD), the non-random association of alleles at different loci, typically due to physical proximity on a chromosome.\n\nThe block bootstrap is designed to account for such dependencies. It works by resampling blocks of linked loci instead of individual loci, thus preserving the local correlation structure.\n\nThe procedure is as follows:\n1.  **Define Blocks**: The set of $L$ loci is partitioned into a set of $N_B$ non-overlapping blocks based on the provided block identifiers. These blocks represent segments of the genome where loci within a block might be in LD, but loci in different blocks are assumed to be effectively unlinked.\n2.  **Bootstrap Resampling**: A total of $B$ bootstrap replicates are generated. For each replicate $b = 1, \\dots, B$:\n    a. A new sequence of loci is created by sampling blocks, with replacement, from the original set of $N_B$ blocks.\n    b. The loci from these sampled blocks are concatenated. Sampling continues until the total number of loci in the concatenated list is at least the original number of loci, $L$.\n    c. This list is then truncated to exactly length $L$. This creates a bootstrap sample of locus indices, $\\mathcal{L}^{*(b)}$, which maintains the size of the original dataset while mimicking stochasticity in both locus sampling and LD patterns.\n3.  **Compute Bootstrap Estimates**: For each bootstrap sample of loci $\\mathcal{L}^{*(b)}$, the global estimator $\\widehat{F}_{ST}^{(b)}$ is calculated using the allele count and sample size data corresponding to the resampled loci.\n    $$ \\widehat{F}_{ST}^{(b)} = 1 - \\frac{\\sum_{\\ell \\in \\mathcal{L}^{*(b')}} H_{S,\\ell}}{\\sum_{\\ell \\in \\mathcal{L}^{*(b')}} H_{T,\\ell}} $$\n    where $\\mathcal{L}^{*(b')}$ is the subset of resampled loci with $H_{T,\\ell}  0$.\n4.  **Construct Confidence Interval**: The $B$ bootstrap estimates $\\{ \\widehat{F}_{ST}^{(1)}, \\dots, \\widehat{F}_{ST}^{(B)} \\}$ form an empirical sampling distribution of the estimator. A two-sided $95\\%$ confidence interval is constructed by taking the $2.5$-th and $97.5$-th percentiles of this distribution. For $B=2000$ replicates, these are typically the $50$-th and $1950$-th values of the sorted estimates.\n\nThis procedure yields a confidence interval that properly accounts for the statistical non-independence among loci due to LD, providing a more reliable measure of the estimate's precision.\n\n**Part 3: Implementation Strategy**\n\nThe implementation will follow the derived formulas and the block-bootstrap procedure.\nFirst, a function `_calculate_fst` will compute the point estimate $\\widehat{F}_{ST}$ from input allele counts and sample sizes. This function will calculate $p_{k,\\ell}$, $w_{k,\\ell}$, $\\bar{p}_{\\ell}$, $H_{S,\\ell}$, and $H_{T,\\ell}$ for all loci using vectorized operations with `numpy`. It will then filter out non-informative loci ($H_{T,\\ell}=0$) and compute the final ratio-of-sums.\nSecond, a main function `compute_f_stats_and_ci` will orchestrate the entire process for a single test case. It will first call `_calculate_fst` to get the point estimate. Then, it will implement the block-bootstrap loop for $B=2000$ replicates. Inside the loop, it will generate resampled locus indices according to the specified procedure, create bootstrapped data matrices, and call `_calculate_fst` to get a bootstrap estimate. Finally, it will use `numpy.percentile` on the collected bootstrap estimates to determine the $95\\%$ confidence interval. The random number generator will be seeded for reproducibility.\nThe main program will iterate through all provided test cases, calling this function for each and formatting the results into the specified final output string.",
            "answer": "```python\nimport numpy as np\nfrom collections import defaultdict\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the final results.\n    \"\"\"\n    \n    test_cases = [\n        {\n            \"K\": 3, \"L\": 8,\n            \"x_counts\": np.array([\n                [12, 15, 18, 5, 22, 30, 8, 25],\n                [20, 19, 12, 6, 30, 12, 10, 30],\n                [28, 24, 20, 10, 35, 20, 6, 35]\n            ]),\n            \"m_counts\": np.array([\n                [40, 36, 38, 30, 44, 40, 32, 50],\n                [42, 30, 34, 28, 46, 36, 28, 52],\n                [48, 40, 36, 26, 50, 38, 30, 54]\n            ]),\n            \"block_ids\": [0, 0, 0, 1, 1, 2, 2, 2],\n            \"B\": 2000\n        },\n        {\n            \"K\": 2, \"L\": 5,\n            \"x_counts\": np.array([\n                [10, 18, 0, 35, 22],\n                [12, 17, 0, 25, 23]\n            ]),\n            \"m_counts\": np.array([\n                [40, 36, 40, 50, 44],\n                [42, 34, 38, 50, 46]\n            ]),\n            \"block_ids\": [0, 1, 2, 3, 4],\n            \"B\": 2000\n        },\n        {\n            \"K\": 2, \"L\": 6,\n            \"x_counts\": np.array([\n                [1, 5, 0, 1, 22, 2],\n                [39, 45, 30, 33, 24, 58]\n            ]),\n            \"m_counts\": np.array([\n                [40, 50, 30, 36, 44, 60],\n                [40, 50, 30, 34, 46, 60]\n            ]),\n            \"block_ids\": [0, 0, 1, 1, 2, 2],\n            \"B\": 2000\n        }\n    ]\n\n    # Set the fixed random seed for reproducibility\n    np.random.seed(12345)\n    \n    all_results = []\n    for case in test_cases:\n        result = compute_f_stats_and_ci(\n            case[\"x_counts\"],\n            case[\"m_counts\"],\n            case[\"block_ids\"],\n            case[\"L\"],\n            case[\"B\"]\n        )\n        all_results.append(result)\n    \n    # Format the final output string as required\n    formatted_results = [f\"[{res[0]:.7f},{res[1]:.7f},{res[2]:.7f}]\" for res in all_results]\n    print(f\"[[{','.join(formatted_results)}]]\")\n\ndef _calculate_fst(x_counts, m_counts):\n    \"\"\"\n    Calculates the global multilocus F_ST estimator.\n    \"\"\"\n    # Suppress divide-by-zero warnings for cases where m_k,l might be 0, though problem states m = 1\n    with np.errstate(divide='ignore', invalid='ignore'):\n        p_kl = x_counts / m_counts\n        # Replace NaNs that might arise from 0/0 with 0\n        p_kl = np.nan_to_num(p_kl)\n\n    M_l = np.sum(m_counts, axis=0)\n    w_kl = m_counts / M_l\n    \n    p_bar_l = np.sum(w_kl * p_kl, axis=0)\n    \n    H_T_l = 2 * p_bar_l * (1 - p_bar_l)\n    H_S_l = np.sum(w_kl * (2 * p_kl * (1 - p_kl)), axis=0)\n\n    # Filter for polymorphic loci where H_T  0\n    valid_loci_mask = H_T_l  0\n    \n    num_sum = np.sum(H_T_l[valid_loci_mask] - H_S_l[valid_loci_mask])\n    den_sum = np.sum(H_T_l[valid_loci_mask])\n    \n    if den_sum == 0:\n        return 0.0\n        \n    return num_sum / den_sum\n\ndef compute_f_stats_and_ci(x_counts, m_counts, block_ids, L, B):\n    \"\"\"\n    Computes the F_ST point estimate and its block-bootstrap confidence interval.\n    \"\"\"\n    # 1. Calculate the point estimate\n    fst_point_estimate = _calculate_fst(x_counts, m_counts)\n    \n    # 2. Prepare for block bootstrap\n    blocks = defaultdict(list)\n    for i, block_id in enumerate(block_ids):\n        blocks[block_id].append(i)\n    \n    unique_block_ids = list(blocks.keys())\n    \n    # 3. Run bootstrap replicates\n    bootstrap_estimates = []\n    for _ in range(B):\n        resampled_loci_indices = []\n        while len(resampled_loci_indices)  L:\n            # Sample a block ID with replacement\n            chosen_block_id = np.random.choice(unique_block_ids)\n            # Add all loci from that block\n            resampled_loci_indices.extend(blocks[chosen_block_id])\n        \n        # Truncate to the original number of loci\n        truncated_indices = resampled_loci_indices[:L]\n        \n        # Create bootstrap data samples\n        x_boot = x_counts[:, truncated_indices]\n        m_boot = m_counts[:, truncated_indices]\n        \n        # Calculate F_ST for the bootstrap sample\n        fst_boot = _calculate_fst(x_boot, m_boot)\n        bootstrap_estimates.append(fst_boot)\n        \n    # 4. Calculate confidence interval from bootstrap distribution\n    bootstrap_estimates = np.array(bootstrap_estimates)\n    # Using percentile method for CI\n    ci_low, ci_high = np.percentile(bootstrap_estimates, [2.5, 97.5])\n    \n    return [fst_point_estimate, ci_low, ci_high]\n\nsolve()\n```"
        }
    ]
}