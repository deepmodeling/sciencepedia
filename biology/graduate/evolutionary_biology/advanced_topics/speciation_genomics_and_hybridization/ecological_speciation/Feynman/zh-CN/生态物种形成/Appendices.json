{
    "hands_on_practices": [
        {
            "introduction": "物种形成很少是单一基因流屏障作用的结果；相反，它通常是多个（通常是微妙的）生殖隔离屏障累积效应的产物。本练习将演示如何通过对不同合子前和合子后屏障的连续作用进行建模，来量化两个正在分化的种群之间的总生殖隔离。通过进行敏感性分析，你还将学会识别哪个阶段对整体隔离的贡献最大，这是理解物种形成过程的关键一步 。",
            "id": "2702584",
            "problem": "一对正在分化的昆虫物种经历了与生态物种形成相关的多个连续生殖屏障。每个屏障在已通过所有先前屏障的条件下，会阻断一部分潜在的种间基因流。假设各屏障间相互独立且不存在频率依赖性，因此，存活并通过所有屏障的潜在基因流的期望比例等于各阶段存活比例的乘积。在这种标准的顺序屏障框架下，总体生殖隔离是该存活比例的补集。\n\n给定以下屏障效应，每个效应都定义为其所在阶段的隔离比例（即，在未被更早阶段阻断的条件下，在该阶段被阻断的潜在种间基因流的比例）。使用索引映射 $i \\in \\{1,\\dots,7\\}$：\n- $i=1$：生境隔离, $I_{1} = 0.70$\n- $i=2$：时间隔离, $I_{2} = 0.25$\n- $i=3$：行为隔离, $I_{3} = 0.55$\n- $i=4$：机械隔离, $I_{4} = 0.15$\n- $i=5$：配子隔离, $I_{5} = 0.45$\n- $i=6$：杂种不存活, $I_{6} = 0.40$\n- $i=7$：杂种不育, $I_{7} = 0.60$\n\n任务：\n1) 从上述定义出发，推导总体生殖隔离作为屏障效应 $I_{1},\\dots,I_{7}$ 函数的表达式，并根据给定数据计算其值。\n2) 通过计算总体生殖隔离对每个 $I_{i}$ 的偏导数（在给定数据点上求值），进行局部一阶敏感性分析。找出具有最大一阶绝对敏感性的屏障指数 $i^{\\ast}$。\n\n最终答案仅报告整数 $i^{\\ast}$。不包含单位。最终答案无需四舍五入。",
            "solution": "所述问题具有科学依据，提法明确且客观。它提出了演化生物学中使用的顺序生殖隔离的标准模型。所有必要的数据和定义均已提供，且问题内部逻辑一致。因此，将提供解答。\n\n设 $I_{i}$ 为阶段 $i$ 的生殖隔离比例，其中 $i \\in \\{1, 2, \\dots, 7\\}$。这代表在已通过所有先前阶段的条件下，在阶段 $i$ 被阻断的潜在基因流的比例。在阶段 $i$ *存活*的基因流比例，记为 $S_{i}$，是 $I_{i}$ 的补集：\n$$S_{i} = 1 - I_{i}$$\n问题陈述，通过所有屏障后存活的总基因流比例 $S_{total}$，是各阶段存活比例的乘积，这是独立性假设的结果。\n$$S_{total} = \\prod_{i=1}^{7} S_{i} = \\prod_{i=1}^{7} (1 - I_{i})$$\n总体生殖隔离 $I_{total}$ 定义为总存活比例 $S_{total}$ 的补集。\n$$I_{total} = 1 - S_{total}$$\n代入 $S_{total}$ 的表达式，可得到总体生殖隔离作为各独立屏障效应 $I_{i}$ 的函数表达式。这完成了任务1的第一部分。\n$$I_{total}(I_{1}, \\dots, I_{7}) = 1 - \\prod_{i=1}^{7} (1 - I_{i})$$\n使用所提供的数据：\n$I_{1} = 0.70$, $I_{2} = 0.25$, $I_{3} = 0.55$, $I_{4} = 0.15$, $I_{5} = 0.45$, $I_{6} = 0.40$, $I_{7} = 0.60$。\n对应的存活比例如下：\n$S_{1} = 1 - 0.70 = 0.30$\n$S_{2} = 1 - 0.25 = 0.75$\n$S_{3} = 1 - 0.55 = 0.45$\n$S_{4} = 1 - 0.15 = 0.85$\n$S_{5} = 1 - 0.45 = 0.55$\n$S_{6} = 1 - 0.40 = 0.60$\n$S_{7} = 1 - 0.60 = 0.40$\n总存活比例为：\n$S_{total} = (0.30)(0.75)(0.45)(0.85)(0.55)(0.60)(0.40) = 0.01136025$\n总体生殖隔离为：\n$I_{total} = 1 - S_{total} = 1 - 0.01136025 = 0.98863975$\n\n对于任务2，我们必须进行局部一阶敏感性分析。这需要计算 $I_{total}$ 对每个屏障效应 $I_{k}$ 的偏导数，其中 $k \\in \\{1, 2, \\dots, 7\\}$。\n$I_{total}$ 对 $I_{k}$ 变化的敏感性由偏导数 $\\frac{\\partial I_{total}}{\\partial I_{k}}$ 给出。\n$$\\frac{\\partial I_{total}}{\\partial I_{k}} = \\frac{\\partial}{\\partial I_{k}} \\left( 1 - \\prod_{i=1}^{7} (1 - I_{i}) \\right)$$\n常数 $1$ 的导数为 $0$。\n$$\\frac{\\partial I_{total}}{\\partial I_{k}} = - \\frac{\\partial}{\\partial I_{k}} \\left( (1 - I_{1}) \\dots (1 - I_{k}) \\dots (1 - I_{7}) \\right)$$\n根据乘法求导法则，我们将所有 $i \\neq k$ 的项 $(1 - I_{i})$ 视为关于 $I_{k}$ 的常数。\n$$\\frac{\\partial I_{total}}{\\partial I_{k}} = - \\left( \\prod_{i \\neq k} (1 - I_{i}) \\right) \\frac{\\partial}{\\partial I_{k}} (1 - I_{k})$$\n$(1 - I_{k})$ 关于 $I_{k}$ 的导数是 $-1$。\n$$\\frac{\\partial I_{total}}{\\partial I_{k}} = - \\left( \\prod_{i \\neq k} (1 - I_{i}) \\right) (-1) = \\prod_{i \\neq k} (1 - I_{i})$$\n该导数代表成功通过除屏障 $k$ 之外所有屏障的基因流比例。这是“有风险”被屏障 $k$ 阻断的基因流量。表达该导数的另一种方式是使用 $S_{total}$：\n$$\\frac{\\partial I_{total}}{\\partial I_{k}} = \\frac{\\prod_{i=1}^{7} (1 - I_{i})}{1 - I_{k}} = \\frac{S_{total}}{1 - I_{k}}$$\n我们寻求具有最大一阶绝对敏感性的屏障指数 $i^{\\ast}$。由于对所有 $i$ 都有 $I_{i} < 1$，存活比例 $(1 - I_{i})$ 均为正值。因此，偏导数 $\\frac{\\partial I_{total}}{\\partial I_{k}}$ 始终为正，其绝对值就是导数本身。\n为找到最大敏感性，我们必须找到使表达式 $\\frac{S_{total}}{1 - I_{k}}$ 最大化的指数 $k$。由于 $S_{total}$ 是一个相对于指数 $k$ 的正常数，最大化该分数等价于最小化其分母 $(1 - I_{k})$。而最小化 $(1 - I_{k})$ 又等价于最大化隔离比例 $I_{k}$。\n\n我们现在检查给定的 $I_{i}$ 值：\n$I_{1} = 0.70$\n$I_{2} = 0.25$\n$I_{3} = 0.55$\n$I_{4} = 0.15$\n$I_{5} = 0.45$\n$I_{6} = 0.40$\n$I_{7} = 0.60$\n\n这些值中的最大值是 $I_{1} = 0.70$。因此，总体生殖隔离 $I_{total}$ 对第一个屏障——生境隔离的变化最敏感。与此屏障对应的指数是 $1$。\n因此，$i^{\\ast} = 1$。",
            "answer": "$$\\boxed{1}$$"
        },
        {
            "introduction": "生态物种形成的一个核心原则是，趋异选择驱动了种群分化。检验这一假说的一个强有力方法是，比较数量性状的分化程度（$Q_{ST}$）与中性遗传标记的分化程度（$F_{ST}$）。本练习将指导你如何根据遗传方差组分计算 $Q_{ST}$，并将其与中性基准进行比较，从而推断某一性状是否处于趋异选择作用之下，这是进化数量遗传学中的一项基石性分析 。",
            "id": "2702632",
            "problem": "从栖息在三个差异显著的微生境中的一个多年生植物物种的$3$个地理上邻近的种群中进行了取样，这些种群占据着不同的土壤环境并表现出生态分化。为了评估一个目标数量性状是否正在经历与生态物种形成相一致的趋异选择，你使用重复的母系同胞群进行了一项同质园实验，并利用已知的谱系对该目标性状拟合了一个个体水平的加性遗传“动物模型”。从拟合的模型中，你获得了以下的加性遗传方差组分，每个组分都以育种值尺度表示，并假定在各种群间是同质的：\n\n- 种群平均育种值之间的加性遗传方差：$V_{A,B} = 0.18$。\n- 种群内的加性遗传方差：$V_{A,W} = 0.42$。\n\n因为同质园实验消除了种群间的环境差异，所以种群间性状均值的差异反映了遗传分化。假设存在加性效应、种群内随机交配，并且各种群的种群内加性遗传方差相等。\n\n全基因组中性分化是根据 $12{,}000$ 个单核苷酸多态性，通过对基因座使用分块自助法估计的。全基因组 Wright 固定指数的自助法经验 $95\\%$ 置信区间为 $\\left[F_{ST}^{(0.025)}, F_{ST}^{(0.975)}\\right] = \\left[0.046, 0.075\\right]$。\n\n从无穷小模型下加性遗传方差组分和数量性状种群分化的核心数量遗传学定义出发，推导数量性状分化指数 $Q_{ST}$ 用 $V_{A,B}$ 和 $V_{A,W}$ 表示的表达式，并用它来计算目标性状 $Q_{ST}$ 的点估计值。然后，为了在考虑自助法不确定性的情况下，将数量性状分化与中性基准进行正式比较，请计算标量诊断值\n$$\nD \\equiv Q_{ST} - F_{ST}^{(0.975)}。\n$$\n$D$ 的正值意味着数量性状分化超过了自助法得到的中性基准的上限，因此与趋异选择一致；负值则意味着没有此类证据。\n\n将 $D$ 的值以无单位小数形式报告，四舍五入到四位有效数字。最终答案必须是 $D$ 的单个数值。",
            "solution": "题目陈述经确认具有科学依据、问题明确且客观。它呈现了进化数量遗传学中的一个标准情景，使用了诸如加性遗传方差组分 ($V_A$)、数量性状分化指数 ($Q_{ST}$) 和固定指数 ($F_{ST}$) 等既定概念。所有必要的数据和定义均已提供，且不存在矛盾或歧义。因此，可以推导出解决方案。\n\n主要任务是计算诊断标量 $D$，其定义为 $D \\equiv Q_{ST} - F_{ST}^{(0.975)}$。这需要首先从给定的加性遗传方差组分中推导出 $Q_{ST}$ 的表达式，然后计算其点估计值。\n\n$Q_{ST}$ 是衡量数量性状种群分化的指标，类似于用于中性遗传标记的 Wright 固定指数 $F_{ST}$。它量化了性状的总加性遗传方差中，存在于种群间的部分所占的比例。方差组分由“动物模型”提供，其中：\n- $V_{A,B}$ 是种种群平均育种值之间的加性遗传方差。给定值为 $V_{A,B} = 0.18$。\n- $V_{A,W}$ 是种群内个体间的加性遗传方差，假定在各种群间是同质的。给定值为 $V_{A,W} = 0.42$。\n\n$Q_{ST}-F_{ST}$ 比较的理论基础是，在中性进化（即仅有遗传漂变和突变）下，期望值为 $Q_{ST} \\approx F_{ST}$。对该期望值的偏离表明了自然选择的作用。具体来说，$Q_{ST} > F_{ST}$ 表明种群间存在趋异选择，而 $Q_{ST} < F_{ST}$ 表明各种群间存在稳定选择或均一选择。\n\n为使此比较有效，$Q_{ST}$ 必须被正确定义。在一个二倍体、有性生殖的种群中，与中性期望 $Q_{ST} \\approx F_{ST}$ 一致的定义是：\n$$\nQ_{ST} = \\frac{V_{A,B}}{V_{A,B} + 2V_{A,W}}\n$$\n分母代表复合种群中的总加性遗传方差。项 $V_{A,B}$ 是种群间组分。项 $2V_{A,W}$ 代表种群内组分。因子 $2$ 至关重要，它源于在二倍体生物中划分方差的方式，以确保在中性条件下，$Q_{ST}$ 的期望值与 $F_{ST}$ 相匹配。\n\n使用给定的值，我们首先计算 $Q_{ST}$ 的点估计值：\n$$\nQ_{ST} = \\frac{0.18}{0.18 + 2(0.42)} = \\frac{0.18}{0.18 + 0.84} = \\frac{0.18}{1.02}\n$$\n计算此分数可得：\n$$\nQ_{ST} = \\frac{18}{102} = \\frac{3}{17} \\approx 0.176470588...\n$$\n接下来，我们计算诊断标量 $D$。题目将其定义为 $Q_{ST}$ 的点估计值与中性基准的 $95\\%$ 置信上限 $F_{ST}^{(0.975)}$ 之间的差值。给定值为：\n- 计算出的 $Q_{ST} \\approx 0.176470588...$\n- 中性分化的上限，$F_{ST}^{(0.975)} = 0.075$。\n\n$D$ 的表达式为：\n$$\nD = Q_{ST} - F_{ST}^{(0.975)}\n$$\n代入数值：\n$$\nD = \\frac{3}{17} - 0.075 \\approx 0.176470588... - 0.075 = 0.101470588...\n$$\n题目要求将此值四舍五入到四位有效数字。第一位有效数字是十分位上的 $1$。第四位有效数字是万分位上的 $4$。随后的数字是 $7$，由于 $7 \\ge 5$，所以我们向上取整。\n$$\nD \\approx 0.1015\n$$\n$D$ 的正值表明，目标数量性状的估计分化度 $Q_{ST}$ 大于中性分化 $F_{ST}$ 置信区间的上限。这一结果与目标性状在各种群间受到趋异选择的假设相符。",
            "answer": "$$\\boxed{0.1015}$$"
        },
        {
            "introduction": "随着基因组学的出现，研究人员现在可以扫描整个基因组，以寻找生态适应和物种形成的特定基因座。这项高级实践将挑战你实现一个计算流程，该流程结合了种群特异性分化（如种群分支统计量，Population Branch Statistic, PBS）的测量和环境关联测试。掌握这种方法将使你具备一套最前沿的技能，能够从种群基因组数据中识别驱动生态物种形成的候选基因 。",
            "id": "2702581",
            "problem": "您的任务是实现一个完整的、可运行的程序，该程序将一个原则性的种群基因组学分析流程付诸实践，用于识别与生态物种形成一致的候选生态适应性位点。该分析流程必须整合来自种群分支统计量 (Population Branch Statistic, PBS) 的基于分化的信号，以及一个使用主成分分析来控制种群结构的环境关联检验。跨种群复合似然比 (Cross Population Composite Likelihood Ratio, XP-CLR) 被提及作为PBS的一个概念性替代方案，但您的实现应使用种群分支统计量 (PBS)。\n\n从基本的种群遗传学和统计学原理及定义开始：\n- 对于每个单核苷酸多态性 (SNP) 位点，在任意两个具有等位基因计数数据的种群之间，使用基于等位基因计数的 Wright 固定指数 $F_{\\mathrm{ST}}$ 的 Hudson 估计量。给定种群1中 $n_1$ 条染色体的衍生等位基因计数为 $x_1$，种群2中 $n_2$ 条染色体的衍生等位基因计数为 $x_2$，设 $p_1 = x_1 / n_1$ 和 $p_2 = x_2 / n_2$。使用针对单位点的 Hudson 估计量\n  \n$$\n  F_{\\mathrm{ST}} = \\frac{(p_1 - p_2)^2 - \\left(\\frac{p_1 (1 - p_1)}{n_1 - 1} + \\frac{p_2 (1 - p_2)}{n_2 - 1}\\right)}{p_1 (1 - p_2) + p_2 (1 - p_1)}.\n  $$\n\n  如果分母非正或分子为负，则设 $F_{\\mathrm{ST}} = 0$。为避免后续对 $0$ 或 $1$ 取对数，通过将 $F_{\\mathrm{ST}}$ 限制在 $[10^{-12}, 1 - 10^{-12}]$ 区间内来约束数值，以便进行转换。\n- 将每对种群的 $F_{\\mathrm{ST}}$ 转换为分化时间代理指标\n  \n$$\n  T_{ij} = -\\ln\\left(1 - F_{\\mathrm{ST}, ij}\\right).\n  $$\n\n- 对于形成一个推定树的三个种群（焦点种群 $A$，参考种群 $B$，参考种群 $C$），将 $A$ 的种群分支统计量 (PBS) 定义为\n  \n$$\n  \\mathrm{PBS}_A = \\frac{T_{AB} + T_{AC} - T_{BC}}{2}.\n  $$\n\n- 对于环境关联分析，设每个位点的响应变量为跨种群的等位基因频率向量。通过将全基因组等位基因频率矩阵（种群 $\\times$ 位点）的前 $K$ 个主成分 (PCs) 作为协变量来控制种群结构。使用普通最小二乘法 (OLS) 拟合线性模型\n  \n$$\n  \\mathbf{y}_\\ell = \\beta_0 \\mathbf{1} + \\beta_e \\mathbf{e}_z + \\sum_{k=1}^{K} \\gamma_k \\mathbf{PC}_k + \\boldsymbol{\\varepsilon},\n  $$\n\n  其中 $\\mathbf{y}_\\ell$ 是位点 $\\ell$ 在各种群间的等位基因频率向量，$\\mathbf{e}_z$ 是标准化的环境变量（在各种群间均值为零，方差为一），$\\mathbf{PC}_k$ 是种群的第 $k$ 个主成分得分向量。使用学生t统计量检验原假设 $H_0: \\beta_e = 0$，其自由度为 $d = m - p$，其中 $m$ 是种群数量，$p$ 是拟合的回归系数数量（包括截距、环境变量和 $K$ 个主成分）。使用学生t分布计算双侧p值。如果设计矩阵是秩亏的或 $d \\le 0$，则对该位点返回一个保守的p值1。\n- 使用 Benjamini–Hochberg (BH) 程序，在指定的水平 $\\alpha$ 下，控制环境关联检验的全基因组错误发现率。\n- 将候选生态适应性位点定义为那些在指定的三种群组合的焦点分支中，同时满足在水平 $\\alpha$ 下通过 BH 校正被识别为环境关联显著，并且其 PBS 值高于指定的经验分位数 $q$ 的位点。\n\n您的程序必须：\n- 精确地实现上述计算。\n- 在下文指定的固定测试套件上执行。\n- 生成单行输出，该输出将所有测试用例的结果汇总为一个整数列表的列表，其中每个内部列表包含相应测试用例中通过组合标准的、排序后的、从0开始的位点索引。\n\n需要实现的数学和算法细节：\n- 用于种群结构的主成分：构建一个形状为 $m \\times L$（种群 $\\times$ 位点）的等位基因频率矩阵 $\\mathbf{X}$。通过减去每个位点在各种群间的均值来中心化各列。计算奇异值分解 $\\mathbf{X} = \\mathbf{U}\\mathbf{S}\\mathbf{V}^\\top$。种群的主成分得分矩阵为 $\\mathbf{U}\\mathbf{S}$；使用其前 $K$ 列作为协变量。如果 $K = 0$，则省略主成分。\n- 普通最小二乘法：对于设计矩阵 $\\mathbf{D}$（列：截距、标准化环境和主成分）和响应变量 $\\mathbf{y}_\\ell$，使用 Moore–Penrose 伪逆 $(\\cdot)^{+}$ 计算 $\\hat{\\boldsymbol{\\beta}} = (\\mathbf{D}^\\top \\mathbf{D})^{+} \\mathbf{D}^\\top \\mathbf{y}_\\ell$ 以处理潜在的秩亏问题。设 $\\hat{\\mathbf{y}}_\\ell = \\mathbf{D}\\hat{\\boldsymbol{\\beta}}$ 且残差平方和为 $\\mathrm{RSS} = \\|\\mathbf{y}_\\ell - \\hat{\\mathbf{y}}_\\ell\\|_2^2$。自由度为 $d = m - \\mathrm{rank}(\\mathbf{D})$，若 $d > 0$，则定义 $\\hat{\\sigma}^2 = \\mathrm{RSS} / d$。环境系数的方差是 $\\hat{\\sigma}^2 (\\mathbf{D}^\\top \\mathbf{D})^{+}$ 的 $(2,2)$ 项。$t$统计量为 $t = \\hat{\\beta}_e / \\sqrt{\\mathrm{Var}(\\hat{\\beta}_e)}$。双侧p值的计算公式为 $2 \\cdot S(t; d)$，其中 $S(\\cdot; d)$ 是自由度为 $d$ 的学生t分布的右尾生存函数。\n- Benjamini–Hochberg：给定 $L$ 个p值 $p_{(1)} \\le \\dots \\le p_{(L)}$ 及其秩 $r = 1, \\dots, L$，找到满足 $p_{(r^*)} \\le \\alpha \\cdot r^*/L$ 的最大 $r^*$。宣布所有满足 $r \\le r^*$ 的 $p_{(r)}$ 为显著。\n\n测试套件：\n每个测试用例都指定了种群、位点、衍生等位基因计数、各种群的染色体样本量、一个环境变量、PBS三种群组合、主成分数量 $K$、PBS离群值分位数 $q$ 以及BH水平 $\\alpha$。所有索引均从0开始。\n\n- 测试用例 1：\n  - 种群数量 $m = 5$。\n  - 位点数量 $L = 10$。\n  - 各种群样本量（染色体）：$[\\,50, 50, 50, 50, 50\\,]$。\n  - 形状为 $5 \\times 10$ 的衍生等位基因计数矩阵（行是种群0到4，列是位点0到9）：\n    \n$$\n    \\begin{bmatrix}\n    10 & 8 & 15 & 10 & 40 & 10 & 20 & 5 & 25 & 5 \\\\\n    13 & 10 & 15 & 10 & 35 & 13 & 19 & 8 & 25 & 5 \\\\\n    11 & 12 & 16 & 10 & 30 & 15 & 20 & 6 & 25 & 5 \\\\\n    12 & 43 & 15 & 40 & 10 & 30 & 20 & 35 & 25 & 45 \\\\\n    12 & 40 & 15 & 10 & 15 & 28 & 21 & 34 & 25 & 5\n    \\end{bmatrix}.\n    $$\n\n  - 环境变量向量（长度为5）：$[\\,0.1, 0.2, 0.3, 0.9, 0.85\\,]$。\n  - PBS三种群组合：焦点 $= 3$，参考 $= (0, 1)$。\n  - 主成分数量 $K = 1$。\n  - PBS离群值分位数 $q = 0.8$（选择PBS值处于或高于第80百分位的位点）。\n  - Benjamini–Hochberg水平 $\\alpha = 0.1$。\n- 测试用例 2：\n  - 种群数量 $m = 5$。\n  - 位点数量 $L = 10$。\n  - 各种群样本量：$[\\,50, 50, 50, 50, 50\\,]$。\n  - 衍生等位基因计数：与测试用例1相同。\n  - 环境变量向量：与测试用例1相同。\n  - PBS三种群组合：焦点 $= 0$，参考 $= (3, 4)$。\n  - 主成分数量 $K = 1$。\n  - PBS离群值分位数 $q = 0.9$。\n  - Benjamini–Hochberg水平 $\\alpha = 0.1$。\n- 测试用例 3（无信号的边界情况）：\n  - 种群数量 $m = 4$。\n  - 位点数量 $L = 4$。\n  - 各种群样本量：$[\\,40, 40, 40, 40\\,]$。\n  - 衍生等位基因计数矩阵 $4 \\times 4$：\n    \n$$\n    \\begin{bmatrix}\n    8 & 20 & 12 & 4 \\\\\n    8 & 20 & 12 & 4 \\\\\n    8 & 20 & 12 & 4 \\\\\n    8 & 20 & 12 & 4\n    \\end{bmatrix}.\n    $$\n\n  - 环境变量向量：$[\\,0.3, 0.6, 0.4, 0.5\\,]$。\n  - PBS三种群组合：焦点 $= 0$，参考 $= (1, 2)$。\n  - 主成分数量 $K = 0$。\n  - PBS离群值分位数 $q = 0.8$。\n  - Benjamini–Hochberg水平 $\\alpha = 0.1$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每个元素对应一个测试用例，其本身是满足组合标准的、排序后的、从0开始的位点索引列表。例如，一个有效的输出格式是 `[[0,2],[1],[]]`。确切的数值内容必须由您的代码根据上述定义计算得出；只有格式是固定的。",
            "solution": "该问题已经过验证，并被确定为有效。它具有科学依据，问题陈述清晰且客观。该问题描述了一个标准的多步骤种群基因组学分析流程，用于识别因环境压力而处于选择状态的位点，这一过程是生态物种形成研究的核心。所有必需的数据、数学公式和统计程序都已足够精确地指定，以确保一个唯一且可验证的解决方案。其中不存在矛盾、歧义或对非科学前提的依赖。\n\n解决方案要求实现一个计算流程，该流程包含两个主要的分析组件：一个基于分化的度量（种群分支统计量，PBS）和一个检验等位基因频率与环境变量之间关联性的测试，同时控制种群结构的影响。\n\n该流程的结构如下：\n\n**1. 种群分化与差异（PBS分析）**\n\n第一个组件用于量化焦点种群在其特定进化分支上的遗传分化程度。对每个遗传位点，此过程通过三个步骤完成。\n\n- **步骤1：成对固定指数（$F_{\\mathrm{ST}}$）**\n  对于任意两个种群，比如种群 $i$ 和种群 $j$，其衍生等位基因计数分别为 $x_i$ 和 $x_j$（来自 $n_i$ 和 $n_j$ 条抽样染色体），我们首先计算它们各自的等位基因频率，$p_i = x_i / n_i$ 和 $p_j = x_j / n_j$。它们之间的遗传分化使用 Wright 固定指数 $F_{\\mathrm{ST}}$ 的 Hudson 估计量来衡量：\n  $$\n  F_{\\mathrm{ST}, ij} = \\frac{(p_i - p_j)^2 - \\left(\\frac{p_i (1 - p_i)}{n_i - 1} + \\frac{p_j (1 - p_j)}{n_j - 1}\\right)}{p_i (1 - p_j) + p_j (1 - p_i)}\n  $$\n  该估计量包含了对抽样方差的校正。根据问题规范，如果分子为负或分母非正，我们设置 $F_{\\mathrm{ST}, ij} = 0$。为确保后续转换中的数值稳定性，计算出的 $F_{\\mathrm{ST}}$ 值被限制在区间 $[10^{-12}, 1 - 10^{-12}]$ 内。\n\n- **步骤2：转换为分化时间代理指标（$T$）**\n  $F_{\\mathrm{ST}}$ 与种群间的溯祖时间相关。在一个简单的漂变模型下，这种关系可以被线性化。我们使用以下转换将每个成对的 $F_{\\mathrm{ST}, ij}$ 值转换为分化时间的代理指标 $T_{ij}$：\n  $$\n  T_{ij} = -\\ln\\left(1 - F_{\\mathrm{ST}, ij}\\right)\n  $$\n  这种转换使得该度量沿着种群树的分支具有可加性。\n\n- **步骤3：种群分支统计量（PBS）**\n  给定一个包含一个焦点种群 $A$ 和两个参考种群 $B$ 和 $C$ 的三种群树，焦点种群分支的 PBS 计算如下：\n  $$\n  \\mathrm{PBS}_A = \\frac{T_{AB} + T_{AC} - T_{BC}}{2}\n  $$\n  该统计量分离出了自种群 $A$ 从导向 $B$ 和 $C$ 的谱系中分离出来后，在导向种群 $A$ 的分支上特异性积累的分化。某个位点上较高的 $\\mathrm{PBS}_A$ 值表明种群 $A$ 中存在加速分化，是正选择的一个标志。如果某个位点的 PBS 值在所有位点中达到或超过指定的经验分位数 $q$，我们将其识别为 PBS 离群点。\n\n**2. 环境关联分析**\n\n第二个组件检验所有种群中等位基因频率与环境变量之间的统计关联，同时考虑它们背景上的遗传相关性（种群结构）。\n\n- **步骤1：使用主成分分析（PCA）控制种群结构**\n  如果等位基因频率和环境变量都具有地理格局，种群结构可能会在它们之间产生虚假的关联。为了控制这一点，我们使用PCA。我们构建一个大小为 $m \\times L$ 的等位基因频率矩阵 $\\mathbf{X}$，其中 $m$ 是种群数量，$L$ 是位点数量。通过减去均值来中心化此矩阵的每一列。然后我们对中心化后的矩阵执行奇异值分解（SVD）：$\\mathbf{X}_{\\text{centered}} = \\mathbf{U}\\mathbf{S}\\mathbf{V}^\\top$。种群的主成分（PC）得分由矩阵乘积 $\\mathbf{U}\\mathbf{S}$ 的列给出。前 $K$ 个PC得分向量被用作回归模型中的协变量，以捕捉跨种群遗传变异的主要轴线。\n\n- **步骤2：线性回归模型（OLS）**\n  对于每个位点 $\\ell$，我们拟合一个普通最小二乘法（OLS）线性模型来检验环境的影响。该模型为：\n  $$\n  \\mathbf{y}_\\ell = \\beta_0 \\mathbf{1} + \\beta_e \\mathbf{e}_z + \\sum_{k=1}^{K} \\gamma_k \\mathbf{PC}_k + \\boldsymbol{\\varepsilon}\n  $$\n  其中 $\\mathbf{y}_\\ell$ 是位点 $\\ell$ 的 $m \\times 1$ 等位基因频率向量，$\\mathbf{e}_z$ 是标准化的环境变量（均值为0，方差为1），$\\mathbf{PC}_k$ 是PC得分向量，$\\beta_0, \\beta_e, \\gamma_k$ 是回归系数，$\\boldsymbol{\\varepsilon}$ 是误差项。此回归的设计矩阵 $\\mathbf{D}$ 由一列1（用于截距 $\\beta_0$）、向量 $\\mathbf{e}_z$ 和 $K$ 个PC向量组成。\n\n- **步骤3：假设检验**\n  我们感兴趣的是原假设 $H_0: \\beta_e = 0$，该假设表明在考虑了种群结构后，等位基因频率与环境之间没有关联。系数向量使用 Moore-Penrose 伪逆 $(\\cdot)^{+}$ 进行估计，以增强对病态或秩亏设计矩阵的鲁棒性：$\\hat{\\boldsymbol{\\beta}} = (\\mathbf{D}^\\top \\mathbf{D})^{+} \\mathbf{D}^\\top \\mathbf{y}_\\ell$。检验使用学生t统计量进行：\n  $$\n  t = \\frac{\\hat{\\beta}_e}{\\mathrm{SE}(\\hat{\\beta}_e)}\n  $$\n  其中 $\\hat{\\beta}_e$ 是环境的估计系数，$\\mathrm{SE}(\\hat{\\beta}_e)$ 是其标准误。标准误从系数协方差矩阵的对角线推导得出，$\\mathrm{Cov}(\\hat{\\boldsymbol{\\beta}}) = \\hat{\\sigma}^2 (\\mathbf{D}^\\top \\mathbf{D})^{+}$，其中 $\\hat{\\sigma}^2 = \\mathrm{RSS} / d$ 是估计的残差方差，$\\mathrm{RSS}$ 是残差平方和，$d = m - \\mathrm{rank}(\\mathbf{D})$ 是残差自由度。双侧p值由自由度为 $d$ 的学生t分布计算得出。如果 $d \\le 0$，则指定一个保守的p值1。\n\n**3. 整合证据并控制错误发现**\n\n- **步骤1：错误发现率（FDR）控制**\n  为了对跨 $L$ 个位点的多重检验进行校正，我们使用 Benjamini–Hochberg (BH) 程序在指定的显著性水平 $\\alpha$ 下控制错误发现率。来自所有 $L$ 个环境关联检验的p值按升序排序，$p_{(1)} \\le p_{(2)} \\le \\dots \\le p_{(L)}$。我们找到满足 $p_{(r^*)} \\le \\alpha \\cdot r^*/L$ 的最大秩 $r^*$。所有p值小于或等于 $p_{(r^*)}$ 的位点都被宣布为显著。\n\n- **步骤2：候选位点的识别**\n  最终的候选生态适应性位点集合由同时满足两个标准的位点组成：它们必须被识别为 PBS 离群点（PBS 值 $\\ge$ 第 $q$ 分位数），并且在 BH 校正后的环境关联检验中必须是显著的。最终输出是每个测试用例中这些候选位点的、从0开始的索引的排序列表。",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import t as t_dist\n\ndef calculate_fst(p1, n1, p2, n2):\n    \"\"\"Calculates the Hudson estimator of F_ST between two populations at a single locus.\"\"\"\n    # Ensure sample sizes are valid for the formula\n    if n1 <= 1 or n2 <= 1:\n        return 0.0\n\n    num = (p1 - p2)**2 - (p1 * (1 - p1) / (n1 - 1) + p2 * (1 - p2) / (n2 - 1))\n    den = p1 * (1 - p2) + p2 * (1 - p1)\n\n    if den <= 0 or num < 0:\n        return 0.0\n    \n    fst = num / den\n    # Clamp F_ST for numerical stability in the log transformation\n    return np.clip(fst, 1e-12, 1 - 1e-12)\n\ndef calculate_pbs(allele_counts, sample_sizes, focal_pop_idx, ref_pop_idx1, ref_pop_idx2):\n    \"\"\"Calculates the Population Branch Statistic (PBS) for all loci.\"\"\"\n    L = allele_counts.shape[1]\n    pbs_scores = np.zeros(L)\n\n    p_focal = allele_counts[focal_pop_idx] / sample_sizes[focal_pop_idx]\n    p_ref1 = allele_counts[ref_pop_idx1] / sample_sizes[ref_pop_idx1]\n    p_ref2 = allele_counts[ref_pop_idx2] / sample_sizes[ref_pop_idx2]\n\n    n_focal = sample_sizes[focal_pop_idx]\n    n_ref1 = sample_sizes[ref_pop_idx1]\n    n_ref2 = sample_sizes[ref_pop_idx2]\n\n    for l in range(L):\n        fst_ab = calculate_fst(p_focal[l], n_focal, p_ref1[l], n_ref1)\n        fst_ac = calculate_fst(p_focal[l], n_focal, p_ref2[l], n_ref2)\n        fst_bc = calculate_fst(p_ref1[l], n_ref1, p_ref2[l], n_ref2)\n\n        T_ab = -np.log(1 - fst_ab)\n        T_ac = -np.log(1 - fst_ac)\n        T_bc = -np.log(1 - fst_bc)\n\n        pbs_scores[l] = (T_ab + T_ac - T_bc) / 2\n        \n    return pbs_scores\n\ndef environmental_association(allele_counts, sample_sizes, env_vector, K):\n    \"\"\"Performs an environmental association test for all loci, controlling for population structure.\"\"\"\n    m, L = allele_counts.shape\n    \n    # 1. Allele frequency matrix (populations x loci)\n    freq_matrix = allele_counts / sample_sizes[:, np.newaxis]\n    \n    # 2. Construct design matrix D\n    intercept = np.ones((m, 1))\n    \n    # Standardize environment vector\n    env_mean = np.mean(env_vector)\n    env_std = np.std(env_vector)\n    e_z = (env_vector - env_mean) / env_std if env_std > 0 else np.zeros(m)\n    \n    design_matrix_components = [intercept, e_z.reshape(-1, 1)]\n    \n    if K > 0 and m > 1:\n        X_centered = freq_matrix - np.mean(freq_matrix, axis=0)\n        # Avoid SVD on all-zero matrix which would result in NaN issues later\n        if np.allclose(X_centered, 0):\n             # If no variation, PCs are meaningless\n             pass\n        else:\n            U, S, _ = np.linalg.svd(X_centered, full_matrices=False)\n            pc_scores = U[:, :K] * S[:K]\n            design_matrix_components.append(pc_scores)\n\n    D = np.hstack(design_matrix_components)\n    \n    rank_D = np.linalg.matrix_rank(D)\n    dof = m - rank_D\n    \n    if dof <= 0:\n        return np.ones(L)\n\n    try:\n        D_pseudo_inv = np.linalg.pinv(D)\n        D_T_D_pseudo_inv = np.linalg.pinv(D.T @ D)\n    except np.linalg.LinAlgError:\n        return np.ones(L)\n\n    p_values = np.zeros(L)\n    \n    for l in range(L):\n        y_l = freq_matrix[:, l]\n        \n        beta_hat = D_pseudo_inv @ y_l\n        beta_e = beta_hat[1]\n        \n        y_hat = D @ beta_hat\n        rss = np.sum((y_l - y_hat)**2)\n        sigma_sq_hat = rss / dof\n        \n        var_beta_e = sigma_sq_hat * D_T_D_pseudo_inv[1, 1]\n        \n        if var_beta_e <= 0:\n            p_values[l] = 1.0\n            continue\n            \n        se_beta_e = np.sqrt(var_beta_e)\n        \n        if se_beta_e == 0:\n             t_stat = np.inf if beta_e != 0 else 0\n        else:\n             t_stat = beta_e / se_beta_e\n        \n        p_val = 2 * t_dist.sf(np.abs(t_stat), df=dof)\n        p_values[l] = p_val\n        \n    return p_values\n\ndef benjamini_hochberg(p_values, alpha):\n    \"\"\"Performs the Benjamini-Hochberg procedure.\"\"\"\n    L = len(p_values)\n    if L == 0:\n        return np.array([], dtype=int)\n        \n    sorted_indices = np.argsort(p_values)\n    sorted_p_values = p_values[sorted_indices]\n    \n    ranks = np.arange(1, L + 1)\n    \n    # Condition for significance\n    significant_mask = sorted_p_values <= (alpha * ranks / L)\n    \n    if not np.any(significant_mask):\n        return np.array([], dtype=int)\n    \n    # Find the largest rank (r*) that satisfies the condition\n    max_rank_idx = np.where(significant_mask)[0][-1]\n    \n    # All loci with p-values up to this threshold are significant\n    significant_indices = sorted_indices[:max_rank_idx + 1]\n    \n    return significant_indices\n\ndef solve_case(case):\n    \"\"\"Processes a single test case.\"\"\"\n    m, L, sample_sizes, allele_counts, env_vector, pbs_triad, K, q, alpha = case\n    \n    sample_sizes = np.array(sample_sizes)\n    allele_counts = np.array(allele_counts)\n    env_vector = np.array(env_vector)\n    \n    # 1. PBS analysis\n    focal_pop, ref_pops = pbs_triad\n    pbs_scores = calculate_pbs(allele_counts, sample_sizes, focal_pop, ref_pops[0], ref_pops[1])\n    pbs_threshold = np.quantile(pbs_scores, q)\n    pbs_outlier_indices = np.where(pbs_scores >= pbs_threshold)[0]\n    \n    # 2. Environmental association analysis\n    p_values = environmental_association(allele_counts, sample_sizes, env_vector, K)\n    \n    # 3. BH correction\n    env_significant_indices = benjamini_hochberg(p_values, alpha)\n    \n    # 4. Intersect the results to find candidate loci\n    candidate_loci = np.intersect1d(pbs_outlier_indices, env_significant_indices)\n    \n    return sorted(list(candidate_loci))\n\ndef solve():\n    \"\"\"Defines and runs the test suite.\"\"\"\n    test_cases = [\n        (5, 10, [50, 50, 50, 50, 50],\n         [[10, 8, 15, 10, 40, 10, 20, 5, 25, 5],\n          [13, 10, 15, 10, 35, 13, 19, 8, 25, 5],\n          [11, 12, 16, 10, 30, 15, 20, 6, 25, 5],\n          [12, 43, 15, 40, 10, 30, 20, 35, 25, 45],\n          [12, 40, 15, 10, 15, 28, 21, 34, 25, 5]],\n         [0.1, 0.2, 0.3, 0.9, 0.85],\n         (3, (0, 1)), 1, 0.8, 0.1),\n        (5, 10, [50, 50, 50, 50, 50],\n         [[10, 8, 15, 10, 40, 10, 20, 5, 25, 5],\n          [13, 10, 15, 10, 35, 13, 19, 8, 25, 5],\n          [11, 12, 16, 10, 30, 15, 20, 6, 25, 5],\n          [12, 43, 15, 40, 10, 30, 20, 35, 25, 45],\n          [12, 40, 15, 10, 15, 28, 21, 34, 25, 5]],\n         [0.1, 0.2, 0.3, 0.9, 0.85],\n         (0, (3, 4)), 1, 0.9, 0.1),\n        (4, 4, [40, 40, 40, 40],\n         [[8, 20, 12, 4],\n          [8, 20, 12, 4],\n          [8, 20, 12, 4],\n          [8, 20, 12, 4]],\n         [0.3, 0.6, 0.4, 0.5],\n         (0, (1, 2)), 0, 0.8, 0.1)\n    ]\n\n    results = []\n    for case in test_cases:\n        result = solve_case(case)\n        results.append(result)\n\n    # Format output as a string representation of a list of lists.\n    # The problem asks for format like: [[0,2],[1],[]]\n    # str(results) produces '[...]', but f-string can wrap it in '[' and ']' again.\n    # The template 'print(f\"[{','.join(map(str, results))}]\")' produces '[[0, 2],[1],[]]'\n    # which is a valid interpretation of the request, accounting for Python's list-to-string conversion.\n    print(f\"[{','.join([str(r).replace(' ', '') for r in results])}]\")\n\nsolve()\n```"
        }
    ]
}