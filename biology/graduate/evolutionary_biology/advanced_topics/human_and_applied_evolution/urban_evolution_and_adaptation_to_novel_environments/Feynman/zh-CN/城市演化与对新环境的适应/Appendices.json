{
    "hands_on_practices": [
        {
            "introduction": "研究适应性演化的核心是量化自然选择。本练习将引导您应用经典的Lande-Arnold框架，这是一个强大的多元统计方法，用于处理现实世界中性状常常相关的复杂情况。通过分析一个关于城市鸣禽的假设数据集，您将学习如何区分作用于某一性状的直接选择（以选择梯度 $\\beta$ 衡量）和由性状间遗传或功能关联引起的间接选择，这是演化定量遗传学中的一项基本技能 。",
            "id": "2761337",
            "problem": "在一个城市鸣禽种群中，研究人员检验了与应对人为干扰相关的性状如何预测其在城市中的实际繁殖成功度。他们关注两个连续性状：最低鸣唱频率（性状 $z_1$）和大胆性（性状 $z_2$）。为了估计定向选择，他们采用Lande–Arnold方法，将个体相对适合度对这些性状进行回归分析。在分析前，每个性状都被标准化，使其样本均值为 $0$，样本方差为 $1$。相对适合度 $w$ 定义为个体的离巢幼鸟数除以该繁殖季节的平均离巢幼鸟数，因此 $\\bar{w}=1$。线性模型为\n$$\nw = \\alpha + \\beta_1 z_1 + \\beta_2 z_2 + \\varepsilon,\n$$\n其中 $\\beta_1$ 和 $\\beta_2$ 是定向选择梯度。\n\n从一个包含 $n=200$ 只领域性雄鸟的样本中，获得了以下样本矩：\n- $\\operatorname{Var}(z_1)=1$, $\\operatorname{Var}(z_2)=1$, 以及 $\\operatorname{Cov}(z_1,z_2)=0.5$,\n- $\\operatorname{Cov}(z_1,w)=0.08$ 以及 $\\operatorname{Cov}(z_2,w)=0.02$.\n\n假设满足普通最小二乘法的常规正则性条件，并忽略本问题中的非线性（二次）选择。仅使用相对适合度、方差-协方差和普通最小二乘法的基本定义，推导出这些样本矩所蕴含的估计值 $\\hat{\\beta}_1$ 和 $\\hat{\\beta}_2$，并根据城市环境中这两个性状受到的直接选择来解释它们。下面哪个选项正确报告了数值估计并提供了有效的解释？\n\n- A. $\\hat{\\beta}_1 \\approx 0.093$, $\\hat{\\beta}_2 \\approx -0.027$。解释：在考虑了性状之间的相关性后，对较高鸣唱频率存在正向直接选择，对大胆性存在轻微的负向直接选择；系数表示性状每变化一个标准差，相对适合度的变化单位。\n\n- B. $\\hat{\\beta}_1 = 0.08$, $\\hat{\\beta}_2 = 0.02$。解释：这些是定向选择梯度，因为它们等于每个性状与相对适合度的协方差。\n\n- C. $\\hat{\\beta}_1 \\approx 0.120$, $\\hat{\\beta}_2 \\approx 0.080$。解释：两个性状都受到相似强度的正向直接选择，因为它们呈正相关。\n\n- D. 梯度是不可估计的，因为将性状中心化至均值为 $0$ 并缩放至方差为 $1$ 会消除中心化回归中关于选择的信息。",
            "solution": "对问题陈述进行验证。\n\n**步骤1：提取已知条件**\n- 相对适合度 ($w$) 的模型是关于两个性状 ($z_1$, $z_2$) 的线性回归：$w = \\alpha + \\beta_1 z_1 + \\beta_2 z_2 + \\varepsilon$。\n- 性状 ($z_1$, $z_2$) 被标准化，使其样本均值为 $0$，样本方差为 $1$。\n- 相对适合度 ($w$) 的定义使其样本均值为 $\\bar{w}=1$。\n- 系数 $\\beta_1$ 和 $\\beta_2$ 是定向选择梯度。\n- 样本量 $n=200$。\n- 性状的样本矩：$\\operatorname{Var}(z_1)=1$, $\\operatorname{Var}(z_2)=1$, $\\operatorname{Cov}(z_1,z_2)=0.5$。\n- 性状与相对适合度之间的样本协方差：$\\operatorname{Cov}(z_1,w)=0.08$, $\\operatorname{Cov}(z_2,w)=0.02$。\n- 分析假设满足普通最小二乘法（OLS）的正则性条件，并忽略非线性选择。\n\n**步骤2：使用提取的已知条件进行验证**\n该问题陈述清晰且有科学依据。它展示了定量演化遗传学中的一个基础方法——Lande-Arnold (1983) 多元选择分析的标准应用。所提供的数据是自洽且一致的。性状被标准化为均值为 $0$、方差为 $1$，这是此类分析中常见且推荐的步骤。提供的性状协方差矩阵是正定的（$\\operatorname{det} = 1 - 0.5^2 = 0.75  0$），确保了唯一解的存在。协方差的值是合理的。问题是客观的，要求将统计学原理直接应用于生物学问题。未发现任何缺陷。\n\n**步骤3：结论与行动**\n问题有效，继续进行解答。\n\n**选择梯度的推导**\n问题要求计算偏回归系数 $\\beta_1$ 和 $\\beta_2$ 的普通最小二乘法（OLS）估计值，在本背景下，它们即为定向选择梯度。系数向量 $\\boldsymbol{\\beta}$ 的OLS估计量的一般矩阵形式为 $\\hat{\\boldsymbol{\\beta}} = (\\mathbf{Z}'\\mathbf{Z})^{-1}\\mathbf{Z}'\\mathbf{w}$。当使用样本矩时，这等价于以下方程：\n$$\n\\hat{\\boldsymbol{\\beta}} = \\mathbf{P}^{-1}\\mathbf{s}\n$$\n其中 $\\hat{\\boldsymbol{\\beta}}$ 是估计的选择梯度向量，$\\mathbf{P}$ 是性状的表型方差-协方差矩阵，$\\mathbf{s}$ 是选择差异向量（即性状与相对适合度的协方差）。\n\n根据问题陈述，我们定义选择梯度向量和选择差异向量：\n$$\n\\hat{\\boldsymbol{\\beta}} = \\begin{pmatrix} \\hat{\\beta}_1 \\\\ \\hat{\\beta}_2 \\end{pmatrix}, \\quad \\mathbf{s} = \\begin{pmatrix} \\operatorname{Cov}(z_1, w) \\\\ \\operatorname{Cov}(z_2, w) \\end{pmatrix} = \\begin{pmatrix} 0.08 \\\\ 0.02 \\end{pmatrix}\n$$\n表型方差-协方差矩阵 $\\mathbf{P}$ 为：\n$$\n\\mathbf{P} = \\begin{pmatrix} \\operatorname{Var}(z_1)  \\operatorname{Cov}(z_1, z_2) \\\\ \\operatorname{Cov}(z_2, z_1)  \\operatorname{Var}(z_2) \\end{pmatrix} = \\begin{pmatrix} 1  0.5 \\\\ 0.5  1 \\end{pmatrix}\n$$\n为了求解 $\\hat{\\boldsymbol{\\beta}}$，我们首先计算 $\\mathbf{P}$ 的逆矩阵，记为 $\\mathbf{P}^{-1}$。对于一个通用的 $2 \\times 2$ 矩阵 $\\begin{pmatrix} a  b \\\\ c  d \\end{pmatrix}$，其逆矩阵为 $\\frac{1}{ad-bc}\\begin{pmatrix} d  -b \\\\ -c  a \\end{pmatrix}$。\n$\\mathbf{P}$ 的行列式为 $\\det(\\mathbf{P}) = (1)(1) - (0.5)(0.5) = 1 - 0.25 = 0.75$。\n因此，逆矩阵为：\n$$\n\\mathbf{P}^{-1} = \\frac{1}{0.75} \\begin{pmatrix} 1  -0.5 \\\\ -0.5  1 \\end{pmatrix} = \\frac{4}{3} \\begin{pmatrix} 1  -0.5 \\\\ -0.5  1 \\end{pmatrix} = \\begin{pmatrix} 4/3  -2/3 \\\\ -2/3  4/3 \\end{pmatrix}\n$$\n现在，我们通过将 $\\mathbf{P}^{-1}$ 乘以 $\\mathbf{s}$ 来计算选择梯度向量：\n$$\n\\hat{\\boldsymbol{\\beta}} = \\mathbf{P}^{-1}\\mathbf{s} = \\begin{pmatrix} 4/3  -2/3 \\\\ -2/3  4/3 \\end{pmatrix} \\begin{pmatrix} 0.08 \\\\ 0.02 \\end{pmatrix}\n$$\n各个元素为：\n$$\n\\hat{\\beta}_1 = \\left(\\frac{4}{3}\\right)(0.08) + \\left(-\\frac{2}{3}\\right)(0.02) = \\frac{4 \\times 0.08 - 2 \\times 0.02}{3} = \\frac{0.32 - 0.04}{3} = \\frac{0.28}{3} \\approx 0.09333...\n$$\n$$\n\\hat{\\beta}_2 = \\left(-\\frac{2}{3}\\right)(0.08) + \\left(\\frac{4}{3}\\right)(0.02) = \\frac{-2 \\times 0.08 + 4 \\times 0.02}{3} = \\frac{-0.16 + 0.08}{3} = \\frac{-0.08}{3} \\approx -0.02666...\n$$\n所以，估计的定向选择梯度为 $\\hat{\\beta}_1 \\approx 0.093$ 和 $\\hat{\\beta}_2 \\approx -0.027$。\n\n**解释**\n选择梯度 $\\beta_1$ 和 $\\beta_2$ 衡量了每个性状对相对适合度的直接因果效应，同时在统计上保持另一个性状不变。\n- $\\hat{\\beta}_1 \\approx 0.093  0$：这表示对性状 $z_1$（最低鸣唱频率）存在正向直接选择。在考虑了大胆性的影响后，鸣唱频率每增加一个标准差，相对适合度会增加约 $0.093$ 个单位。\n- $\\hat{\\beta}_2 \\approx -0.027  0$：这表示对性状 $z_2$（大胆性）存在负向直接选择。在考虑了鸣唱频率的影响后，大胆性每增加一个标准差，相对适合度会减少约 $0.027$ 个单位。\n值得注意的是，由选择差异 $\\operatorname{Cov}(z_2,w)=0.02$ 给出的对大胆性的总选择是正向的。这种差异的产生是由于性状之间的正相关性（$\\operatorname{Cov}(z_1,z_2)=0.5$）。大胆性看起来受到青睐，仅仅是因为它与一个受到强烈正向选择的性状（高鸣唱频率）相关联。当移除了这种间接效应后，大胆性对适合度的直接效应显示为负。\n\n**逐项分析**\n- **A. $\\hat{\\beta}_1 \\approx 0.093$, $\\hat{\\beta}_2 \\approx -0.027$。解释：在考虑了性状之间的相关性后，对较高鸣唱频率存在正向直接选择，对大胆性存在轻微的负向直接选择；系数表示性状每变化一个标准差，相对适合度的变化单位。**\n  计算出的 $\\hat{\\beta}_1$ 和 $\\hat{\\beta}_2$ 的数值与此选项匹配。解释完全正确。偏回归系数衡量的是在“考虑了”其他预测变量后，一个预测变量的效应。系数的符号对应于对鸣唱频率的正向直接选择和对大胆性的负向直接选择。因为性状被标准化为单位方差，所以梯度代表性状每变化一个标准差，相对适合度的改变量。\n  结论：**正确**。\n\n- **B. $\\hat{\\beta}_1 = 0.08$, $\\hat{\\beta}_2 = 0.02$。解释：这些是定向选择梯度，因为它们等于每个性状与相对适合度的协方差。**\n  这是不正确的。数值 $0.08$ 和 $0.02$ 是选择差异（$s_1$ 和 $s_2$），而不是选择梯度（$\\beta_1$ 和 $\\beta_2$）。只有当预测性状不相关时，即 $\\mathbf{P}$ 为单位矩阵时，$\\boldsymbol{\\beta} = \\mathbf{s}$ 才成立。此处 $\\operatorname{Cov}(z_1,z_2)=0.5 \\neq 0$，因此这是错误的。该选项混淆了总选择与直接选择。\n  结论：**不正确**。\n\n- **C. $\\hat{\\beta}_1 \\approx 0.120$, $\\hat{\\beta}_2 \\approx 0.080$。解释：两个性状都受到相似强度的正向直接选择，因为它们呈正相关。**\n  数值不正确。解释也有缺陷；我们的计算表明 $\\hat{\\beta}_2$ 是负值，表示负向直接选择，而非正向。此外，性状之间的正相关性并不必然导致两者都受到正向直接选择。\n  结论：**不正确**。\n\n- **D. 梯度是不可估计的，因为将性状中心化至均值为 $0$ 并缩放至方差为 $1$ 会消除中心化回归中关于选择的信息。**\n  这种说法根本上是错误的。预测变量的标准化在多元回归中，特别是在Lande-Arnold框架中，是一个标准且通常被推荐的步骤。它不妨碍估计；反而通过将性状置于共同的尺度上以便比较，从而促进了估计。如上述推导所示，梯度是完全可以估计的。\n  结论：**不正确**。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "在表型层面量化了选择之后，演化生物学家们通常希望找到驱动适应性变化的遗传基础。本练习将带您进入群体基因组学的世界，结合使用两种当代最主流的方法——分化指数（$F_{ST}$）异常值分析和环境关联分析——来扫描全基因组数据。您将亲手实现一个计算流程，从原始等位基因计数数据出发，识别出与城市污染等新选择压力相关的候选基因位点 。",
            "id": "2761622",
            "problem": "你的任务是实现一个程序，给定多个单核苷酸多态性（SNP）位点在重复的城市和农村种群中的等位基因计数数据，以及每个种群的连续污染测量值，该程序将执行两种互补的扫描来寻找城市适应的信号：一个固定指数离群值扫描和一项环境关联分析。其生物学基础是，在不同环境之间受到趋异选择的位点倾向于表现出更高的种群间分化，并且参与城市污染适应的等位基因其频率会与污染梯度表现出系统性的关联。你的任务是从第一性原理出发将这些思想形式化，并在一个可复现的计算流程中实现它们。\n\n从以下基本原理开始：\n- Wright 的固定指数（fixation index）量化了种群间遗传变异在总遗传变异中所占的比例。对于一个双等位基因位点，其在 $K$ 个种群中的等位基因频率为 $p_i$，总体平均等位基因频率为 $\\bar{p}$，种群间方差分量与 $\\mathrm{Var}(p_i)$ 成正比，而在 Hardy–Weinberg 平衡下的总二项方差为 $\\bar{p}(1-\\bar{p})$。固定指数的方差比率估计量形式为种群间方差除以总方差基线。\n- 环境变数与等位基因频率之间的基于秩次的关联由 Spearman 秩相关系数捕捉，该系数定义为两个变量秩次的 Pearson 相关性。在无关联的原假设下，Spearman 系数的绝对值期望值很小，并且可以为其计算双侧检验的 $p$ 值。\n- Benjamini–Hochberg (BH) 程序通过对 $p$ 值进行排序，并在一个数据依赖的阈值内宣告发现，从而将错误发现率（FDR）控制在用户指定的水平上。\n\n需要推导和实现的要求：\n1. 给定整数等位基因计数 $x_{i\\ell}$（参考等位基因计数）和样本量 $n_{i\\ell}$，对于位点 $\\ell \\in \\{0,\\dots,L-1\\}$ 的种群 $i \\in \\{0,\\dots,K-1\\}$，计算等位基因频率估计值 $p_{i\\ell} = x_{i\\ell} / n_{i\\ell}$。\n2. 对于每个位点 $\\ell$，使用跨 $K$ 个种群的 $p_{i\\ell}$ 的无偏样本方差以及 Hardy–Weinberg 总方差基线，计算固定指数的估计量，以获得种群间分化的比率估计量。处理边界情况，即当 $\\bar{p}_{\\ell} \\in \\{0,1\\}$ 或分母为零时，将该位点的固定指数设置为 $0$。\n3. 对于每个位点 $\\ell$，计算向量 $\\{p_{i\\ell}\\}_{i=0}^{K-1}$ 与污染向量 $\\{z_i\\}_{i=0}^{K-1}$ 之间的 Spearman 秩相关，并获得一个双侧 $p$ 值。如果污染向量是恒定的或秩相关未定义，则将该位点的 $p$ 值设置为 $1$。\n4. 通过在用户指定的上分位数 $q_{\\mathrm{FST}} \\in (0,1)$ 处对跨位点的固定指数的经验分布设置阈值来执行离群值扫描：如果一个位点的固定指数大于或等于经验 $q_{\\mathrm{FST}}$-分位数，则该位点是离群值。\n5. 执行环境关联发现步骤，通过使用 Benjamini–Hochberg 程序将错误发现率（FDR）控制在用户指定的水平 $q_{\\mathrm{BH}} \\in (0,1)$，该程序应用于给定测试用例中所有位点的 Spearman 相关性双侧 $p$ 值。\n6. 将同时满足两个标准的位点报告为候选位点：它们是固定指数离群值，并且是 Benjamini–Hochberg 程序下的发现。正相关和负相关均可作为候选。\n\n你的程序必须在没有外部输入的情况下实现上述功能，并且必须确定性地运行。对位点使用基于 $0$ 的索引。对于下面定义的每个测试用例，你必须输出候选位点索引的排序列表，作为整数列表。\n\n测试套件：\n- 测试用例 A（混合信号的正常路径）：\n  - 种群 $K = 4$，对应两个城市和两个农村的重复。\n  - 位点 $L = 8$。\n  - 污染向量（任意单位）：$[\\,7.0,\\,6.5,\\,1.0,\\,1.2\\,]$，对应种群 $[\\,\\mathrm{U1},\\,\\mathrm{U2},\\,\\mathrm{R1},\\,\\mathrm{R2}\\,]$。\n  - 每个种群 $i$ 和位点 $\\ell$ 的等位基因计数 $x_{i\\ell}$ 和样本量 $n_{i\\ell}$：\n    - 在此测试中，对所有 $i,\\ell$，所有位点的 $n_{i\\ell} = 50$。\n    - 位点 0：计数 $[\\,45,\\,42,\\,5,\\,10\\,]$。\n    - 位点 1：计数 $[\\,25,\\,26,\\,24,\\,25\\,]$。\n    - 位点 2：计数 $[\\,45,\\,5,\\,45,\\,5\\,]$。\n    - 位点 3：计数 $[\\,30,\\,31,\\,31,\\,30\\,]$。\n    - 位点 4：计数 $[\\,5,\\,10,\\,40,\\,35\\,]$。\n    - 位点 5：计数 $[\\,0,\\,0,\\,0,\\,0\\,]$。\n    - 位点 6：计数 $[\\,28,\\,30,\\,25,\\,24\\,]$。\n    - 位点 7：计数 $[\\,47,\\,45,\\,3,\\,5\\,]$。\n  - 固定指数离群值的分位数 $q_{\\mathrm{FST}} = 0.75$。\n  - Benjamini–Hochberg FDR 水平 $q_{\\mathrm{BH}} = 0.10$。\n- 测试用例 B（边界：单态位点）：\n  - 种群 $K = 4$。\n  - 位点 $L = 3$。\n  - 污染向量：$[\\,2.0,\\,3.0,\\,1.0,\\,4.0\\,]$。\n  - 对所有位点，所有 $i,\\ell$ 的 $n_{i\\ell} = 40$ 且 $x_{i\\ell} = 0$。\n  - 分位数 $q_{\\mathrm{FST}} = 0.80$。\n  - FDR 水平 $q_{\\mathrm{BH}} = 0.10$。\n- 测试用例 C（边缘：高固定指数的负相关）：\n  - 种群 $K = 3$。\n  - 位点 $L = 6$。\n  - 污染向量：$[\\,0.5,\\,2.0,\\,5.0\\,]$。\n  - 对所有位点，$n_{i\\ell} = 40$。\n  - 位点 0：计数 $[\\,36,\\,24,\\,8\\,]$。\n  - 位点 1：计数 $[\\,20,\\,20,\\,20\\,]$。\n  - 位点 2：计数 $[\\,8,\\,32,\\,8\\,]$。\n  - 位点 3：计数 $[\\,18,\\,20,\\,22\\,]$。\n  - 位点 4：计数 $[\\,32,\\,16,\\,4\\,]$。\n  - 位点 5：计数 $[\\,4,\\,12,\\,8\\,]$。\n  - 分位数 $q_{\\mathrm{FST}} = 0.66$。\n  - FDR 水平 $q_{\\mathrm{BH}} = 0.10$。\n- 测试用例 D（边界：恒定环境）：\n  - 种群 $K = 3$。\n  - 位点 $L = 4$。\n  - 污染向量：$[\\,2.0,\\,2.0,\\,2.0\\,]$。\n  - 对所有位点，$n_{i\\ell} = 30$。\n  - 位点 0：计数 $[\\,15,\\,15,\\,15\\,]$。\n  - 位点 1：计数 $[\\,25,\\,5,\\,15\\,]$。\n  - 位点 2：计数 $[\\,10,\\,20,\\,15\\,]$。\n  - 位点 3：计数 $[\\,0,\\,0,\\,0\\,]$。\n  - 分位数 $q_{\\mathrm{FST}} = 0.75$。\n  - FDR 水平 $q_{\\mathrm{BH}} = 0.10$。\n\n最终输出格式：\n- 你的程序应生成单行输出，其中包含四个测试用例的结果，形式为用方括号括起来的逗号分隔列表，每个元素是相应测试用例的候选位点索引列表（按升序排序）。例如，包含列表 $L_A$、$L_B$、$L_C$ 和 $L_D$ 的输出必须严格按照 $[\\,[\\dots],\\,[\\dots],\\,[\\dots],\\,[\\dots]\\,]$ 的格式打印，除了列表语法中的空格外，不需要其他空格。\n\n所有计算都是无单位的。不涉及角度。将所有报告的数值结果表示为索引列表中的普通整数。不得使用百分号；按照测试套件中已定义的，内部将所有比例和概率指定为小数。",
            "solution": "所提出的问题是计算种群遗传学中一个提法恰当且有科学依据的练习。它要求通过结合两种标准方法——固定指数（$F_{ST}$）离群值扫描和环境关联分析——来实现一个流程，用以检测城市环境下受选择的位点。该问题为所需的计算提供了所有必要的数据、参数和明确定义，包括边界情况的处理。问题没有歧义、矛盾和事实错误。因此，我们可以直接进行解决方案的形式化推导和实现。\n\n核心任务是识别那些既表现出异常高的种群间遗传分化，又在等位基因频率与污染梯度之间存在统计上显著关联的基因组位点。这是寻找局部适应候选基因的常用策略。\n\n我们将为每个测试用例系统地实现所需的步骤。设 $K$ 为种群数量，$L$ 为位点数量，$\\{x_{i\\ell}\\}$ 和 $\\{n_{i\\ell}\\}$ 分别为种群 $i$ 和位点 $\\ell$ 的参考等位基因计数和样本量，$\\{z_i\\}$ 为每个种群的污染水平。\n\n**步骤 1：等位基因频率计算**\n\n对于每个种群 $i \\in \\{0, \\dots, K-1\\}$ 中的每个位点 $\\ell \\in \\{0, \\dots, L-1\\}$，等位基因频率 $p_{i\\ell}$ 被估计为参考等位基因计数与抽样等位基因总数的比率：\n$$p_{i\\ell} = \\frac{x_{i\\ell}}{n_{i\\ell}}$$\n这个计算构成了所有后续分析的基础。\n\n**步骤 2：固定指数（$F_{ST}$）估计**\n\n固定指数 $F_{ST}$ 量化了由于种群间等位基因频率差异所导致的遗传变异比例。根据问题的定义，我们为每个位点 $\\ell$ 使用一个基于方差的估计量。\n\n首先，我们计算位点 $\\ell$ 在所有 $K$ 个种群中的平均等位基因频率：\n$$\\bar{p}_{\\ell} = \\frac{1}{K} \\sum_{i=0}^{K-1} p_{i\\ell}$$\n\n接下来，我们计算这些等位基因频率的无偏样本方差，这代表了种群间的方差分量：\n$$s^2_{p_\\ell} = \\frac{1}{K-1} \\sum_{i=0}^{K-1} (p_{i\\ell} - \\bar{p}_{\\ell})^2$$\n对于这个计算，我们使用 $1$ 的自由度校正（即除以 $K-1$）。\n\n在 Hardy-Weinberg 平衡下，平均等位基因频率的总期望方差是分母：\n$$V_{\\text{total}, \\ell} = \\bar{p}_{\\ell}(1 - \\bar{p}_{\\ell})$$\n\n固定指数的估计量是这两个量的比率：\n$$F_{ST, \\ell} = \\frac{s^2_{p_\\ell}}{V_{\\text{total}, \\ell}}$$\n\n根据问题对边界情况的规定，如果分母 $V_{\\text{total}, \\ell}$ 为零（这发生在 $\\bar{p}_{\\ell}=0$ 或 $\\bar{p}_{\\ell}=1$ 时，即位点在所有抽样种群中是单态的），我们将 $F_{ST, \\ell}$ 设为 $0$。\n\n**步骤 3：环境关联分析（Spearman 秩相关）**\n\n为了检验等位基因频率与环境变量（污染）之间的关联，我们使用 Spearman 秩相关系数 $\\rho_S$。对于每个位点 $\\ell$，我们计算等位基因频率向量 $\\{p_{i\\ell}\\}_{i=0}^{K-1}$ 与污染测量值向量 $\\{z_i\\}_{i=0}^{K-1}$ 之间的 $\\rho_S$。这等同于在排序后的数据上计算 Pearson 相关系数。\n\n然后，在无相关性的原假设下计算一个双侧 $p$ 值。这个 $p$ 值表示，假设不存在真实关联的情况下，观察到与检测到的相关性一样强或更强的相关性的概率。\n\n如规定，如果污染向量 $\\{z_i\\}$ 是恒定的，或者对于给定位点，等位基因频率向量 $\\{p_{i\\ell}\\}$ 是恒定的，则秩相关是未定义的。在这种情况下，我们遵循指令将得到的 $p$ 值设为 $1$。这是一个保守的选择，意味着没有证据表明存在关联。\n\n**步骤 4：固定指数离群值识别**\n\n离群值扫描识别出具有异常高 $F_{ST}$ 值的位点，这些位点是可能受到趋异选择的候选者。我们首先计算所有 $L$ 个位点的 $F_{ST, \\ell}$ 值。然后，我们确定这个 $F_{ST}$ 值分布的经验 $q_{\\mathrm{FST}}$-分位数。如果一个位点 $\\ell$ 的固定指数大于或等于这个分位数阈值，则被归类为 $F_{ST}$ 离群值：\n$$F_{ST, \\ell} \\ge \\text{Quantile}(\\{F_{ST, k}\\}_{k=0}^{L-1}, q_{\\mathrm{FST}})$$\n\n**步骤 5：使用 Benjamini-Hochberg (BH) 控制错误发现率（FDR）**\n\n为了在环境关联分析中对 $L$ 个位点的多重检验进行校正，我们使用 Benjamini-Hochberg (BH) 程序来控制错误发现率（FDR）。FDR 是所有发现中假阳性所占的预期比例。\n\n该程序如下：\n1.  收集 $L$ 个 Spearman 相关性 $p$ 值，$\\{p_{\\ell}\\}_{\\ell=0}^{L-1}$。\n2.  将这些 $p$ 值按升序排序：$p_{(1)} \\le p_{(2)} \\le \\dots \\le p_{(L)}$。\n3.  给定 FDR 水平 $q_{\\mathrm{BH}}$，找到满足以下条件的最大整数 $k$：\n    $$p_{(k)} \\le \\frac{k}{L} q_{\\mathrm{BH}}$$\n4.  如果存在这样的 $k$，则拒绝对应于 $p$ 值 $p_{(1)}, \\dots, p_{(k)}$ 的所有检验的原假设（即宣告一次发现）。如果不存在这样的 $k$，则没有发现。\n\n**步骤 6：最终候选位点的识别**\n\n城市适应的最终候选位点集合包括那些同时满足两个标准的位点：它们在步骤 4 中被识别为 $F_{ST}$ 离群值，并且在步骤 5 的 BH 校正环境关联分析中被视为显著发现。这些位点的索引按升序排序，构成了每个测试用例的结果。",
            "answer": "```python\nimport numpy as np\nfrom scipy import stats\n\ndef solve():\n    \"\"\"\n    Main solver function to process all test cases for urban adaptation analysis.\n    \"\"\"\n    test_cases = [\n        {\n            \"K\": 4, \"L\": 8,\n            \"pollution\": [7.0, 6.5, 1.0, 1.2],\n            \"n\": np.full((4, 8), 50),\n            \"x\": np.array([\n                [45, 25, 45, 30, 5, 0, 28, 47],    # Pop U1\n                [42, 26, 5, 31, 10, 0, 30, 45],   # Pop U2\n                [5, 24, 45, 31, 40, 0, 25, 3],     # Pop R1\n                [10, 25, 5, 30, 35, 0, 24, 5]     # Pop R2\n            ]).T, # Transpose to get L x K shape\n            \"q_fst\": 0.75, \"q_bh\": 0.10\n        },\n        {\n            \"K\": 4, \"L\": 3,\n            \"pollution\": [2.0, 3.0, 1.0, 4.0],\n            \"n\": np.full((4, 3), 40),\n            \"x\": np.array([\n                [0, 0, 0], # Pop 1\n                [0, 0, 0], # Pop 2\n                [0, 0, 0], # Pop 3\n                [0, 0, 0]  # Pop 4\n            ]).T,\n            \"q_fst\": 0.80, \"q_bh\": 0.10\n        },\n        {\n            \"K\": 3, \"L\": 6,\n            \"pollution\": [0.5, 2.0, 5.0],\n            \"n\": np.full((3, 6), 40),\n            \"x\": np.array([\n                [36, 20, 8, 18, 32, 4],    # Pop 1\n                [24, 20, 32, 20, 16, 12],  # Pop 2\n                [8, 20, 8, 22, 4, 8]      # Pop 3\n            ]).T,\n            \"q_fst\": 0.66, \"q_bh\": 0.10\n        },\n        {\n            \"K\": 3, \"L\": 4,\n            \"pollution\": [2.0, 2.0, 2.0],\n            \"n\": np.full((3, 4), 30),\n            \"x\": np.array([\n                [15, 25, 10, 0], # Pop 1\n                [15, 5, 20, 0],  # Pop 2\n                [15, 15, 15, 0]  # Pop 3\n            ]).T,\n            \"q_fst\": 0.75, \"q_bh\": 0.10\n        }\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        K, L = case[\"K\"], case[\"L\"]\n        pollution = case[\"pollution\"]\n        x = case[\"x\"] # Shape L x K\n        n = case[\"n\"] # Shape K x L, needs transpose\n        q_fst_thresh = case[\"q_fst\"]\n        q_bh = case[\"q_bh\"]\n\n        # Step 1: Allele Frequencies\n        # Use np.divide to handle 0/0, resulting in np.nan, which we then convert to 0.\n        p = np.divide(x, n.T, out=np.zeros_like(x, dtype=float), where=n.T!=0)\n\n        # Step 2: Fixation Index (FST)\n        fst_values = np.zeros(L)\n        for l in range(L):\n            p_locus = p[l, :]\n            p_mean = np.mean(p_locus)\n            \n            # Denominator V_total = p_mean * (1 - p_mean)\n            v_total = p_mean * (1.0 - p_mean)\n\n            if v_total == 0.0:\n                fst_values[l] = 0.0\n            else:\n                # Numerator is unbiased sample variance\n                var_p = np.var(p_locus, ddof=1)\n                fst_values[l] = var_p / v_total\n\n        # Step 3: Spearman's Rank Correlation\n        p_values = np.ones(L)\n        is_pollution_constant = len(set(pollution)) = 1\n        for l in range(L):\n            p_locus = p[l, :]\n            is_p_constant = len(set(p_locus)) = 1\n            if is_pollution_constant or is_p_constant:\n                p_values[l] = 1.0\n            else:\n                try:\n                    # scipy.stats.spearmanr handles NaN correctly for p-value if corr is undefined.\n                    # We will ensure this is handled by our explicit constant checks.\n                    res = stats.spearmanr(p_locus, pollution)\n                    p_values[l] = res.pvalue if not np.isnan(res.pvalue) else 1.0\n                except Exception:\n                    p_values[l] = 1.0\n\n        # Step 4: FST Outlier Scan\n        if L  0:\n            fst_quantile_val = np.quantile(fst_values, q_fst_thresh)\n            is_fst_outlier = fst_values = fst_quantile_val\n        else:\n            is_fst_outlier = np.array([], dtype=bool)\n\n        # Step 5: Benjamini-Hochberg Procedure\n        is_bh_discovery = np.zeros(L, dtype=bool)\n        if L  0:\n            sorted_indices = np.argsort(p_values)\n            sorted_p_values = p_values[sorted_indices]\n            \n            # (k/L) * q_bh threshold line\n            bh_thresholds = (np.arange(1, L + 1) / L) * q_bh\n            \n            # Find where sorted p-values are under the threshold line\n            is_under_threshold = sorted_p_values = bh_thresholds\n            \n            # Find the largest k for which this is true\n            significant_indices = np.where(is_under_threshold)[0]\n            if len(significant_indices)  0:\n                max_k_idx = significant_indices.max()\n                # All loci up to that k are discoveries\n                significant_original_indices = sorted_indices[:max_k_idx + 1]\n                is_bh_discovery[significant_original_indices] = True\n\n        # Step 6: Identify Candidate Loci\n        candidate_loci_mask = np.logical_and(is_fst_outlier, is_bh_discovery)\n        candidate_indices = np.where(candidate_loci_mask)[0]\n        \n        all_results.append(sorted(candidate_indices.tolist()))\n\n    print(str(all_results).replace(' ', ''))\n\nsolve()\n```"
        },
        {
            "introduction": "演化适应的最终意义体现在其对种群命运的影响上。理解个体性状的适应性变化如何转化为种群的增长、稳定或衰退，是生态学和演化生物学交叉领域的关键问题。在此练习中，您将构建一个阶段结构的生命周期模型，并计算关键的人口统计学参数——净生殖率 $R_{0}$，从而预测一个城市鸟类种群在复杂的异质环境中（如公园和道路）的长期生存能力 。",
            "id": "2761598",
            "problem": "一种城市栖息的雀形目鸟类表现出两阶段的年度生命周期：幼鸟和成鸟。在这种城市镶嵌体中，幼鸟的存活率受到与主干道距离的强烈影响，而成鸟在公园中繁殖时繁殖力会提高。假设一个离散时间、阶段结构的种群模型，具有以下经验估计量：\n\n- 幼鸟在其第一年遇到以道路为主区域的概率为 $q = 0.70$，在这种情况下，其年存活率为 $s_{R} = 0.25$。如果幼鸟停留在公园内部，其年存活率为 $s_{P} = 0.65$。将第一年的存活率视为一个混合值，$s_{J} = q s_{R} + (1 - q) s_{P}$。\n- 成鸟的年存活概率为 $s_{A} = 0.55$。\n- 成鸟每年繁殖一次。如果在公园繁殖，每只成年雌鸟每年产下的雌性后代平均数量为 $b_{P} = 2.8$；如果在公园外的建成区基质中繁殖，则为 $b_{U} = 0.90$。每只成鸟在公园繁殖的概率为 $p = 0.60$，否则在建成区基质中繁殖。将每只成年雌鸟的年繁殖力视为一个混合值，$f = p b_{P} + (1 - p) b_{U}$。\n- 幼鸟不参与繁殖，如果存活下来，一年后成熟进入成鸟阶段。假设环境稳定，生命率不随时间变化，性别比已包含在 $b_{P}$ 和 $b_{U}$ 中，且密度制约效应可以忽略不计。\n\n使用第一性原理，针对一个幼鸟不繁殖、成鸟每年繁殖一次的两阶段、离散时间生命周期，推导净生殖率（每只新生雌性个体一生中预期的雌性后代数量），记为 $R_{0}$，并用 $s_{J}$、$s_{A}$ 和 $f$ 表示。然后，根据上述参数值计算其数值。将你的答案四舍五入到三位有效数字。将最终答案表示为一个纯数（无量纲）。\n\n计算出 $R_{0}$ 后，请根据你的表达式结构和给定值简要论证，该城市种群的增长究竟是主要由公园中提高的成鸟繁殖力所驱动，还是被靠近道路的较低幼鸟存活率所抑制。你的最终数值答案应仅为 $R_{0}$ 的值。",
            "solution": "问题陈述需要经过验证。\n\n**步骤1：提取已知条件**\n- 幼鸟遇到以道路为主区域的概率：$q = 0.70$\n- 道路区域幼鸟年存活概率：$s_{R} = 0.25$\n- 公园内部幼鸟年存活概率：$s_{P} = 0.65$\n- 幼鸟第一年综合存活率：$s_{J} = q s_{R} + (1 - q) s_{P}$\n- 成鸟年存活概率：$s_{A} = 0.55$\n- 公园中每只成年雌鸟的平均雌性后代数：$b_{P} = 2.8$\n- 建成区基质中每只成年雌鸟的平均雌性后代数：$b_{U} = 0.90$\n- 成鸟在公园繁殖的概率：$p = 0.60$\n- 每只成年雌鸟的综合年繁殖力：$f = p b_{P} + (1 - p) b_{U}$\n- 生命周期：离散时间，两阶段（幼鸟，成鸟）。幼鸟不繁殖，一年后成熟为成鸟。成鸟每年繁殖一次。\n- 假设：环境稳定，生命率恒定，性别比已计入繁殖力，密度制约效应可忽略。\n- 目标：用 $s_{J}$、$s_{A}$ 和 $f$ 推导净生殖率 $R_{0}$；计算其数值；并为种群增长的主要驱动因素提供论证。\n\n**步骤2：使用提取的已知条件进行验证**\n该问题具有科学依据，提法恰当，且客观。它描述了一个标准的阶段结构种群模型，这是种群生态学中的一个基本工具。所提供的参数对于一种雀形目鸟类是合理的。该问题是自足的，为得出唯一且有意义的解提供了所有必要的数据。问题没有违反科学原理、不存在逻辑矛盾或含糊不清之处。\n\n**步骤3：结论与行动**\n问题有效。将提供解答。\n\n净生殖率 $R_{0}$ 定义为一只新生的雌性个体在其整个生命周期中预期产生的雌性后代的数量。这可以通过将每个年龄的预期繁殖力按存活到该年龄的概率进行加权求和来计算。设 $l_x$ 是从出生存活到年龄组 $x$ 开始的概率，设 $b_x$ 是年龄为 $x$ 的个体产生的雌性后代的平均数量。那么，$R_{0} = \\sum_{x=0}^{\\infty} l_x b_x$。\n\n生命周期结构如下：\n- 年龄 $x=0$：新生个体是幼鸟。其到1岁的存活尚未实现。$l_0 = 1$。幼鸟不繁殖，所以 $b_0 = 0$。对 $R_{0}$ 的贡献是 $l_0 b_0 = 0$。\n- 年龄 $x=1$：存活过第一年的个体成为成鸟。存活到1岁的概率是 $l_1 = s_J$。在这个年龄，该个体首次繁殖，预期繁殖力为 $b_1 = f$。对 $R_{0}$ 的贡献是 $l_1 b_1 = s_J f$。\n- 年龄 $x=2$：要活到2岁，个体必须存活过其幼鸟年（概率为 $s_J$）和其第一个成鸟年（概率为 $s_A$）。因此，存活到2岁的概率是 $l_2 = s_J s_A$。此年龄的繁殖力是 $b_2 = f$。对 $R_{0}$ 的贡献是 $l_2 b_2 = s_J s_A f$。\n- 年龄 $x$ (对于 $x \\geq 1$)：一般地，要活到年龄 $x$，个体必须存活过幼鸟年和 $x-1$ 个成鸟年。存活概率是 $l_x = s_J s_A^{x-1}$。繁殖力是 $b_x = f$。贡献是 $l_x b_x = s_J s_A^{x-1} f$。\n\n对所有繁殖年龄（$x \\geq 1$）的贡献求和：\n$$R_{0} = \\sum_{x=1}^{\\infty} l_x b_x = \\sum_{x=1}^{\\infty} (s_J s_A^{x-1} f)$$\n我们可以将常数项 $s_J$ 和 $f$ 提取出来：\n$$R_{0} = s_J f \\sum_{x=1}^{\\infty} s_A^{x-1}$$\n令 $k = x-1$。求和变为：\n$$R_{0} = s_J f \\sum_{k=0}^{\\infty} s_A^{k}$$\n该求和是一个标准的几何级数。由于 $s_A$ 是一个存活概率，其值在0和1之间。因此，该级数收敛于 $\\frac{1}{1 - s_A}$。\n净生殖率的最终表达式是：\n$$R_{0} = \\frac{s_J f}{1 - s_A}$$\n这个表达式很直观：它是存活到性成熟的概率（$s_J$）与一只成鸟预期终生总繁殖量（$f / (1 - s_A)$）的乘积。\n\n接下来，我们计算数值。首先，我们计算综合参数 $s_J$ 和 $f$。\n综合幼鸟存活率为：\n$$s_{J} = q s_{R} + (1 - q) s_{P} = (0.70)(0.25) + (1 - 0.70)(0.65) = 0.175 + (0.30)(0.65) = 0.175 + 0.195 = 0.370$$\n综合成鸟繁殖力为：\n$$f = p b_{P} + (1 - p) b_{U} = (0.60)(2.8) + (1 - 0.60)(0.90) = 1.68 + (0.40)(0.90) = 1.68 + 0.36 = 2.04$$\n现在，将这些值与 $s_A = 0.55$ 一起代入 $R_{0}$ 的表达式中：\n$$R_{0} = \\frac{s_J f}{1 - s_A} = \\frac{(0.370)(2.04)}{1 - 0.55} = \\frac{0.7548}{0.45} \\approx 1.67733...$$\n四舍五入到三位有效数字，净生殖率为 $R_{0} = 1.68$。\n\n最后，我们必须论证种群增长究竟是主要由公园中提高的繁殖力驱动，还是被道路附近降低的幼鸟存活率所抑制。如果 $R_{0}  1$，则种群增长。此处，$R_0 \\approx 1.68$，所以种群正在增长。\n方程式 $R_{0} = \\frac{s_{J} f}{1 - s_{A}}$ 的结构表明，$R_0$ 与幼鸟存活率 $s_{J}$ 和成鸟繁殖力 $f$ 都成正比。为了确定增长的主要驱动因素（即，使 $R_{0}  1$ 的因素），我们进行反事实分析。\n\n1.  考虑一个没有公园中繁殖力提高的情景。假设所有成鸟都在建成区基质中繁殖，因此繁殖力统一较低，$f = b_{U} = 0.90$。所有其他参数保持不变。\n    $$R_{0}' = \\frac{s_J b_U}{1 - s_A} = \\frac{(0.370)(0.90)}{1 - 0.55} = \\frac{0.333}{0.45} \\approx 0.74$$\n    在这种情况下，$R_{0}'  1$，种群将走向衰退直至灭绝。这表明，来自公园繁殖的高繁殖力对于种群实现增长是必不可少的。\n\n2.  考虑一个没有道路附近幼鸟存活率降低的情景。假设所有幼鸟都经历公园内部较高的存活率，$s_J = s_P = 0.65$。\n    $$R_{0}'' = \\frac{s_P f}{1 - s_A} = \\frac{(0.65)(2.04)}{1 - 0.55} = \\frac{1.326}{0.45} \\approx 2.95$$\n    在这种情况下，$R_{0}'' \\gg 1$，表明增长速度快得多。这说明，降低的幼鸟存活率是一个强大的限制因素，但种群是在 *尽管有* 这个因素的情况下增长的，而不是 *因为* 这个因素。\n\n增长条件（$R_{0}  1$）之所以能够实现，唯一的原因是公园生境提供的高繁殖力足以克服来自道路主导区域低幼鸟存活率的强大负面压力。因此，该种群的增长主要是由公园中提高的成鸟繁殖力驱动的。",
            "answer": "$$\\boxed{1.68}$$"
        }
    ]
}