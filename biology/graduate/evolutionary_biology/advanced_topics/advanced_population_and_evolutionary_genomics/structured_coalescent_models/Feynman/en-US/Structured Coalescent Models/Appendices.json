{
    "hands_on_practices": [
        {
            "introduction": "The structured coalescent model describes the ancestral history of lineages as a stochastic process governed by competing events: coalescence within demes and migration between them. Understanding the probability of each potential event is the first step toward mastering the model's dynamics. This exercise  guides you through a foundational derivation, asking you to calculate the probability that a specific pair of lineages coalesces next, using the principle of competing exponential hazards. This is a core skill that builds intuition for how population sizes and migration rates jointly determine the shape of a genealogy.",
            "id": "2753786",
            "problem": "Consider a standard structured coalescent model with $D$ demes, where deme $j$ has constant effective population size $N_{j}$ and backward-in-time migration rates $m_{j\\ell}$ for a lineage to move from deme $j$ to deme $\\ell$ with $j \\ne \\ell$. Let $M_{j} = \\sum_{\\ell \\ne j} m_{j\\ell}$ denote the total backward migration rate out of deme $j$ for a single lineage. At some time point, the configuration of sampled ancestral lineages is $(k_{1},\\dots,k_{D})$, where $k_{j}$ is the number of ancestral lineages currently in deme $j$. Assume $k_{d} \\ge 2$ so that there exists at least one unordered pair of lineages in deme $d$.\n\nUnder the standard continuous-time coalescent scaling for a diploid Wright–Fisher population, the instantaneous coalescence rate for any unordered pair of lineages that reside in the same deme $j$ is $1/(2N_{j})$, and each lineage in deme $j$ migrates out of deme $j$ at instantaneous rate $M_{j}$. The next event backward in time is either a within-deme coalescence or a migration of a single lineage, and the waiting time to the next event is exponentially distributed with rate equal to the sum of all instantaneous event rates implied by the current configuration.\n\nDerive, from first principles of competing exponential hazards, a closed-form expression for the probability that a particular specified unordered pair of lineages in deme $d$ is the next event and that this next event is their coalescence, conditioned on the current configuration $(k_{1},\\dots,k_{D})$, the sizes $(N_{1},\\dots,N_{D})$, and the migration rates through $(M_{1},\\dots,M_{D})$ only. Your expression must be fully simplified in terms of $D$, $(k_{1},\\dots,k_{D})$, $(N_{1},\\dots,N_{D})$, and $(M_{1},\\dots,M_{D})$ only. In addition, briefly state the structural conditions on the model under which lineages within a deme are exchangeable so that all unordered pairs within that deme have equal instantaneous coalescent hazard. Express your final probability as a single closed-form analytic expression. Do not include any units. Do not approximate.",
            "solution": "The problem statement is scientifically grounded, well-posed, unambiguous, and internally consistent. It describes a standard scenario in theoretical population genetics based on the structured coalescent model. It provides all necessary parameters and definitions to derive the requested probability from first principles. Therefore, the problem is valid, and a solution will be provided.\n\nThe foundation for this derivation is the theory of competing exponential processes. The time to the next event in a structured coalescent model is exponentially distributed. When multiple independent events can occur, the total rate of any event occurring is the sum of the individual event rates. The probability that a specific event is the first to occur is the ratio of its rate to the total rate of all possible events.\n\nLet $\\Lambda$ be the total instantaneous rate of any event occurring across all $D$ demes. The possible events are either a coalescence of two lineages within a deme or the migration of a single lineage from one deme to another. We must sum the rates of all such possible events.\n\nFirst, consider the coalescence events. In any deme $j$, containing $k_{j}$ ancestral lineages, there are $\\binom{k_{j}}{2} = \\frac{k_{j}(k_{j}-1)}{2}$ distinct unordered pairs of lineages. The problem states that the instantaneous rate of coalescence for any such specific pair is $\\frac{1}{2N_{j}}$, which is consistent with the continuous-time approximation of a diploid Wright–Fisher model where time is measured in generations. Therefore, the total rate of coalescence within deme $j$, which we denote $\\Lambda_{\\text{coal}, j}$, is the sum of the rates for all possible pairs:\n$$\n\\Lambda_{\\text{coal}, j} = \\binom{k_{j}}{2} \\times \\frac{1}{2N_{j}} = \\frac{k_{j}(k_{j}-1)}{2} \\times \\frac{1}{2N_{j}} = \\frac{k_{j}(k_{j}-1)}{4N_{j}}\n$$\nThis applies for any deme $j$ where $k_{j} \\ge 2$. If $k_{j} < 2$, this rate is $0$, which the formula correctly yields.\n\nSecond, consider the migration events. In any deme $j$, there are $k_{j}$ lineages. Each lineage migrates out of deme $j$ at an instantaneous rate $M_{j}$. Since the migration events for each lineage are independent, the total rate of migration out of deme $j$, denoted $\\Lambda_{\\text{mig}, j}$, is the sum of the rates for all lineages present:\n$$\n\\Lambda_{\\text{mig}, j} = k_{j} \\times M_{j}\n$$\n\nThe total rate of any event, $\\Lambda$, is the sum of all coalescence and migration rates across all $D$ demes:\n$$\n\\Lambda = \\sum_{j=1}^{D} (\\Lambda_{\\text{coal}, j} + \\Lambda_{\\text{mig}, j}) = \\sum_{j=1}^{D} \\left( \\frac{k_{j}(k_{j}-1)}{4N_{j}} + k_{j}M_{j} \\right)\n$$\n\nThe problem asks for the probability that the next event is the coalescence of a *particular specified* unordered pair of lineages in deme $d$. Let this event be $E_{d}^{*}$. The rate of this specific event, $\\lambda_{E_{d}^{*}}$, is given directly in the problem statement as the rate for any single pair in deme $d$:\n$$\n\\lambda_{E_{d}^{*}} = \\frac{1}{2N_{d}}\n$$\nThis is valid because the problem specifies $k_{d} \\ge 2$, ensuring at least one such pair exists.\n\nThe probability $P(E_{d}^{*})$ that this specific coalescence is the next event to occur is the ratio of its specific rate to the total rate of all events:\n$$\nP(E_{d}^{*}) = \\frac{\\lambda_{E_{d}^{*}}}{\\Lambda} = \\frac{\\frac{1}{2N_{d}}}{\\sum_{j=1}^{D} \\left( \\frac{k_{j}(k_{j}-1)}{4N_{j}} + k_{j}M_{j} \\right)}\n$$\nThis expression is in terms of the specified parameters and is in its most direct and interpretable form.\n\nFinally, the problem asks for the structural conditions under which lineages within a deme are exchangeable, meaning all unordered pairs within that deme have an equal instantaneous coalescent hazard. This property of exchangeability within a deme is a foundational assumption of the standard Wright-Fisher model applied at the deme level. The specific conditions are:\n$1$. **Panmixia**: All individuals within the deme mate randomly, so any lineage is equally likely to trace its ancestry to any individual in the parent generation.\n$2$. **Non-overlapping Generations and Neutrality**: All individuals in a generation are replaced simultaneously, and there is no selection acting on the genetic locus under study, ensuring that all lineages have equal fitness and thus symmetric ancestry probabilities.\nThese conditions ensure that there is no further population subdivision, selective heterogeneity, or variation in reproductive success that would differentiate the ancestral process for different lineages within the same deme. The problem statement's reference to a \"standard structured coalescent model\" implicitly assumes these conditions hold for each deme.",
            "answer": "$$\\boxed{\\frac{\\frac{1}{2N_{d}}}{\\sum_{j=1}^{D} \\left( \\frac{k_{j}(k_{j}-1)}{4N_{j}} + k_{j}M_{j} \\right)}}$$"
        },
        {
            "introduction": "While the probability of the next immediate event is fundamental, we often need a more integrated view of how population structure affects the overall pace of evolution. This requires connecting the fine-grained migration process to the long-term rate of coalescence. This practice problem  challenges you to derive the marginal instantaneous coalescent rate, a key metric that averages over the uncertainty of lineage locations according to their stationary distribution. Completing this exercise will illuminate how demes that are small or act as migration sinks disproportionately drive the coalescence of lineages.",
            "id": "2753750",
            "problem": "Consider a structured neutral coalescent in a subdivided haploid population with $D$ demes, labeled $d \\in \\{1,\\dots,D\\}$. Deme $d$ contains $N_d$ exchangeable haploid gene copies per generation, with $N_d$ finite and allowed to vary across demes. Reproduction within each deme follows the Wright–Fisher (WF) model: each gene copy in generation $t-1$ independently chooses a parent uniformly from $N_d$ possible parents in generation $t$. Backward-in-time migration of ancestral lineages is modeled as a continuous-time Markov chain (CTMC) on the set of demes with generator matrix $M = (m_{ij})_{i,j=1}^{D}$, where $m_{ij} \\ge 0$ for $i \\ne j$ and $m_{ii} = -\\sum_{j \\ne i} m_{ij}$. Assume $M$ is irreducible so that there is a unique stationary distribution $\\pi = (\\pi_1,\\dots,\\pi_D)$ satisfying $\\pi^{\\top} M = 0$ and $\\sum_{d=1}^{D} \\pi_d = 1$. Consider two ancestral lineages traced backward in time under the structured coalescent (SC) limit, in which $N_d \\to \\infty$ with $m_{ij}$ held $O(1)$, and coalescence within a deme occurs on $O(1)$ generational time scales only when two lineages reside in the same deme.\n\nStarting from the fundamental definitions of the Wright–Fisher model and the CTMC description of migration, and without invoking any pre-stated coalescent formulas, do the following:\n\n1) Derive the instantaneous within-deme coalescent rate when, at some backward time $t$, both lineages are in the same deme $d$. Justify the continuous-time approximation from the discrete-generation WF model.\n\n2) Suppose the two lineages are sampled at backward time $t=0$ from the stationary distribution of the migration CTMC, and, conditional on their deme locations, they evolve independently until a coalescence event occurs. Derive a closed-form expression, in terms of $M$ and $\\{N_d\\}_{d=1}^{D}$, for the marginal instantaneous coalescent rate at $t=0$. Your final expression must be simplified into a single closed-form analytic expression.\n\nExplain in your derivation how and why the contributions of different demes to the marginal coalescent rate vary with deme size and with the structure of migration. The final answer to report is the single closed-form analytic expression for the marginal instantaneous coalescent rate at $t=0$ in item $2)$. No numerical evaluation is required, and no units are needed.",
            "solution": "The problem as stated is scientifically grounded and well-posed, permitting a rigorous derivation from first principles. The analysis proceeds in two parts as requested.\n\n(1) Derivation of the within-deme coalescent rate.\n\nLet us consider two ancestral lineages present in a single deme $d$ at generation $t-1$ in backward time. The population in this deme consists of $N_d$ haploid individuals. According to the Wright–Fisher model, each lineage in generation $t-1$ selects a single parent from the $N_d$ individuals in generation $t$ uniformly at random and independently.\n\nLet the first lineage choose parent $P_1$ from the set of $N_d$ potential parents. The probability of choosing any specific parent is $1/N_d$. Let the second lineage choose parent $P_2$. Coalescence occurs if and only if both lineages choose the same parent, i.e., $P_1 = P_2$. The choice of $P_2$ is independent of the choice of $P_1$. Given that $P_1$ is some specific individual, the probability that $P_2$ is the same individual is also $1/N_d$.\n\nTherefore, the probability of coalescence for two lineages within deme $d$ in a single generation is precisely\n$$\nP(\\text{coalescence in one generation}) = \\frac{1}{N_d}\n$$\nThe problem specifies a continuous-time model for migration. To maintain consistency, we must approximate the discrete-generation coalescence process with a continuous-time one. We measure time in units of generations. Let $\\lambda_d$ be the instantaneous rate of coalescence for a pair of lineages residing in deme $d$. In a small time interval $\\Delta t$, the probability of a single event occurring in a Poisson process with rate $\\lambda_d$ is $\\lambda_d \\Delta t + o(\\Delta t)$.\n\nLet us set the duration of one generation to be our time interval, $\\Delta t = 1$. For large $N_d$, the probability of coalescence in one generation, $1/N_d$, is small. In this limit, the probability of more than one event (e.g., in a model with more than two lineages) in a single generation is negligible, of order $(1/N_d)^2$. Thus, the discrete probability of coalescence can be equated to the probability from the continuous-time Poisson process:\n$$\n\\lambda_d \\Delta t \\approx P(\\text{coalescence in } \\Delta t)\n$$\nSubstituting $\\Delta t = 1$ and the derived probability gives\n$$\n\\lambda_d \\approx \\frac{1}{N_d}\n$$\nThis approximation becomes exact in the limit as $N_d \\to \\infty$ where the discrete-time random process converges to a continuous-time one. Therefore, the instantaneous rate of coalescence for two lineages, conditioned on them both being in deme $d$, is\n$$\n\\lambda_d = \\frac{1}{N_d}\n$$\nThe units of this rate are events per generation. The statement in the problem that coalescence occurs on $O(1)$ generational time scales is interpreted as defining the time unit, not as implying a coalescence rate of $O(1)$, which would be inconsistent with the Wright-Fisher model as $N_d \\to \\infty$.\n\n(2) Derivation of the marginal instantaneous coalescent rate.\n\nWe are asked for the marginal instantaneous coalescent rate at backward time $t=0$. Let the locations of the two ancestral lineages be denoted by the random variables $L_1(t)$ and $L_2(t)$, which take values in the set of demes $\\{1, \\dots, D\\}$.\n\nThe problem states that the two lineages are sampled at $t=0$ from the stationary distribution of the migration process, $\\pi = (\\pi_1, \\dots, \\pi_D)$. It also states that, conditional on their locations, they evolve independently. This implies that the initial locations $L_1(0)$ and $L_2(0)$ are independent and identically distributed random variables, with probability mass function\n$$\nP(L_k(0) = d) = \\pi_d \\quad \\text{for } k=1,2 \\text{ and } d \\in \\{1, \\dots, D\\}\n$$\nCoalescence can only occur if the two lineages are in the same deme. The instantaneous rate of coalescence is a function of the lineages' locations. Let this rate be denoted $C(i, j)$ for lineages in demes $i$ and $j$. From Part (1), this rate is\n$$\nC(i, j) =\n\\begin{cases}\n\\frac{1}{N_d} & \\text{if } i=j=d \\\\\n0 & \\text{if } i \\neq j\n\\end{cases}\n$$\nThis can be written more compactly using the Kronecker delta, $\\delta_{ij}$, as $C(i, j) = \\frac{1}{N_i}\\delta_{ij}$.\n\nThe marginal instantaneous coalescent rate at $t=0$, which we shall denote by $\\Lambda$, is the expected value of this location-dependent rate, where the expectation is taken over the joint distribution of the lineages' initial locations.\n$$\n\\Lambda = E[C(L_1(0), L_2(0))]\n$$\nUsing the law of total expectation, we sum over all possible pairs of locations $(i, j)$ for the two lineages, weighted by the probability of each configuration:\n$$\n\\Lambda = \\sum_{i=1}^{D} \\sum_{j=1}^{D} P(L_1(0)=i, L_2(0)=j) \\cdot C(i, j)\n$$\nDue to the independence of the initial lineage locations, the joint probability is the product of the marginal probabilities:\n$$\nP(L_1(0)=i, L_2(0)=j) = P(L_1(0)=i) \\cdot P(L_2(0)=j) = \\pi_i \\pi_j\n$$\nSubstituting this and the expression for $C(i, j)$ into the sum for $\\Lambda$:\n$$\n\\Lambda = \\sum_{i=1}^{D} \\sum_{j=1}^{D} (\\pi_i \\pi_j) \\left( \\frac{1}{N_i}\\delta_{ij} \\right)\n$$\nThe Kronecker delta $\\delta_{ij}$ is zero for all $j \\neq i$ and one for $j=i$. This collapses the inner sum over $j$, retaining only the term where $j=i$:\n$$\n\\Lambda = \\sum_{i=1}^{D} (\\pi_i \\pi_i) \\left( \\frac{1}{N_i} \\right)\n$$\nRewriting with the deme index as $d$ yields the final closed-form expression:\n$$\n\\Lambda = \\sum_{d=1}^{D} \\frac{\\pi_d^2}{N_d}\n$$\nThe stationary distribution $\\pi$ is uniquely determined by the migration matrix $M$ via the system of linear equations $\\pi^{\\top} M = 0^{\\top}$ and the normalization constraint $\\sum_d \\pi_d = 1$. Thus, the expression is implicitly in terms of $M$ and $\\{N_d\\}_{d=1}^D$.\n\nThis result illuminates the factors controlling the marginal rate of coalescence.\nFirst, the contribution of each deme $d$ is inversely proportional to its size, $N_d$. This is because the within-deme coalescent rate is $1/N_d$; larger populations offer more potential parents, making coalescence a rarer event. Consequently, large demes act as \"refuges\" from coalescence.\nSecond, the contribution of each deme is proportional to $\\pi_d^2$. The stationary probability $\\pi_d$ represents the proportion of time a single lineage is expected to spend in deme $d$ in the long run. The term $\\pi_d^2$ arises because it is the probability that two lineages, sampled independently, are both found in deme $d$. The migration structure, encoded in $M$, dictates the values of $\\pi_d$. Demes that are more retentive (low total emigration rate $m_{ii}$) or well-connected sinks in the migration network will have a higher stationary probability $\\pi_d$. The quadratic dependence means that such demes contribute disproportionately to the initial rate of coalescence because lineages are much more likely to be found together there.\n\nTherefore, the overall rate of coalescence is highest when lineages are concentrated in small demes.",
            "answer": "$$\\boxed{\\sum_{d=1}^{D} \\frac{\\pi_d^2}{N_d}}$$"
        },
        {
            "introduction": "Theoretical models are powerful, but their application to real-world data requires a critical understanding of their limitations. All models are simplifications, and it is crucial to know how our assumptions can influence our conclusions. This final exercise  delves into the practical consequences of model misspecification. By comparing a true three-deme system to a simplified two-deme analysis, you will quantify the systematic bias introduced into parameter estimates, a vital lesson for any researcher performing demographic inference using structured coalescent models.",
            "id": "2753757",
            "problem": "Consider a symmetric Wright–Fisher island model with the structured coalescent limit. There are $D$ demes, each with constant diploid size $N$, and symmetric migration among demes at per-generation probability $m$ per lineage. Let time be measured in units of $2N$ generations, and define the scaled migration rate $M = 2 N m$. In the structured coalescent, when two ancestral lineages are in the same deme, they coalesce at rate $1$ and each lineage migrates at rate $M$; when they are in different demes, no coalescence occurs and each lineage migrates at rate $M$ to a uniformly chosen other deme.\n\nSuppose the true model has $D=3$ demes and you observe two lineages sampled from two different demes. An analyst, however, fits a misspecified model that collapses the demography to $D=2$ demes, assumes the same per-deme size $N$, and estimates the migration parameter by equating the expected pairwise coalescent time for two lineages sampled from different demes under the $D=2$ model to the true expected value under the $D=3$ model. Assume $M>0$.\n\nStarting only from the structured coalescent transition rates described above and first-step analysis, do the following:\n\n- Derive an expression for the estimator $\\hat{m}$ returned by this misspecified $D=2$ analysis as a function of the true $m$ and $N$.\n\n- Using that $\\hat{m}$, determine the signed error in the expected coalescent time prediction for two lineages sampled from the same deme when using the $D=2$ model relative to the true $D=3$ model. Express the time difference in units of $2N$ generations.\n\nYour final answer must be a single analytic expression. If you return multiple quantities, write them as a row vector. Do not include units in your final boxed answer.",
            "solution": "The problem statement is scientifically valid, self-contained, and well-posed. It describes a standard scenario of model misspecification within the established framework of the structured coalescent. We may proceed directly to the solution.\n\nThe core of the problem requires the calculation of expected coalescence times. Let $T_S$ be the expected coalescence time for two ancestral lineages sampled from the same deme, and $T_D$ be the expected time for two lineages from different demes. All time is measured in units of $2N$ generations. The scaled migration rate for a model with $D$ demes is $M = 2Nm$.\n\nWe will derive general expressions for $T_S$ and $T_D$ for a symmetric island model with $D$ demes using first-step analysis, based on the provided transition rates.\n\nThe state of the two-lineage system is either 'Same' (S) or 'Different' (D).\nIn state S, the lineages are in the same deme. They can either coalesce, at rate $1$, or one of them can migrate to another deme. Since there are two lineages, each migrating at rate $M$, the total rate of migration out of the deme is $2M$. The total rate of any event from state S is $\\lambda_S = 1 + 2M$.\nIn state D, the lineages are in different demes. Coalescence cannot occur. Each lineage migrates at rate $M$ to one of the $D-1$ other demes. A transition to state S occurs if one lineage migrates to the specific deme where the other lineage resides. The rate of this for a single lineage is $M \\times \\frac{1}{D-1}$. As either lineage can make this transition, the total rate of transition from D to S is $\\frac{2M}{D-1}$.\n\nWe can set up a system of linear equations for $T_S$ and $T_D$ by considering the expected time until the first event and the state of the system after that event. An equivalent and robust method is to use the standard formulae derived from integrating the backward Kolmogorov equations for the system:\n$$1 = (1+2M)T_S - 2M T_D$$\n$$1 = \\frac{2M}{D-1}(T_D - T_S)$$\nThe first equation arises from considering state S, and the second from considering state D. From the second equation, we isolate the difference $T_D - T_S$:\n$$T_D - T_S = \\frac{D-1}{2M}$$\nThis allows us to express $T_D$ in terms of $T_S$:\n$$T_D = T_S + \\frac{D-1}{2M}$$\nNow, we substitute this expression for $T_D$ into the first equation:\n$$1 = (1+2M)T_S - 2M \\left( T_S + \\frac{D-1}{2M} \\right)$$\n$$1 = T_S + 2M T_S - 2M T_S - 2M \\left( \\frac{D-1}{2M} \\right)$$\n$$1 = T_S - (D-1)$$\n$$T_S = 1 + (D-1) = D$$\nThus, for a symmetric island model with $D$ demes, the expected coalescence time for two lineages sampled from the same deme is exactly $D$ (in units of $2N$ generations), provided $M > 0$.\nThe expected coalescence time for lineages from different demes is:\n$$T_D = T_S + \\frac{D-1}{2M} = D + \\frac{D-1}{2M}$$\nNow we apply these general results to the problem.\n\nFor the true model, we have $D = 3$ and parameters $m$, $N$, and $M = 2Nm$. The true expected times are:\n$$T_{S, D=3}(M) = 3$$\n$$T_{D, D=3}(M) = 3 + \\frac{3-1}{2M} = 3 + \\frac{1}{M}$$\nFor the misspecified model, we have $D = 2$ and estimated migration parameter $\\hat{m}$, with scaled rate $\\hat{M} = 2N\\hat{m}$. The predicted expected times under this model are:\n$$T_{S, D=2}(\\hat{M}) = 2$$\n$$T_{D, D=2}(\\hat{M}) = 2 + \\frac{2-1}{2\\hat{M}} = 2 + \\frac{1}{2\\hat{M}}$$\nThe analyst estimates the migration parameter by equating the expected coalescence time for lineages sampled from different demes:\n$$T_{D, D=2}(\\hat{M}) = T_{D, D=3}(M)$$\n$$2 + \\frac{1}{2\\hat{M}} = 3 + \\frac{1}{M}$$\nSolving for $\\hat{M}$:\n$$\\frac{1}{2\\hat{M}} = (3-2) + \\frac{1}{M} = 1 + \\frac{1}{M} = \\frac{M+1}{M}$$\n$$2\\hat{M} = \\frac{M}{M+1} \\implies \\hat{M} = \\frac{M}{2(M+1)}$$\nThe problem asks for the estimator $\\hat{m}$ as a function of $m$ and $N$. We substitute $\\hat{M}=2N\\hat{m}$ and $M=2Nm$:\n$$2N\\hat{m} = \\frac{2Nm}{2(2Nm+1)}$$\n$$\\hat{m} = \\frac{m}{2(2Nm+1)}$$\nThis is the first required result.\n\nThe second task is to find the signed error in the predicted expected coalescence time for two lineages sampled from the *same* deme. The error is the predicted value from the misspecified model minus the true value.\n$$\\text{Error} = T_{S, D=2}(\\hat{M}) - T_{S, D=3}(M)$$\nUsing our derived results, where $T_{S,D}=D$:\n$$\\text{Error} = 2 - 3 = -1$$\nThis error is given in units of $2N$ generations, as required. The misspecified $D=2$ model underestimates the true expected coalescence time for lineages from the same deme by one unit of $2N$ generations.\n\nThe final answer requires both quantities, which we present as a row vector.",
            "answer": "$$\\boxed{\\begin{pmatrix} \\frac{m}{2(2Nm+1)} & -1 \\end{pmatrix}}$$"
        }
    ]
}