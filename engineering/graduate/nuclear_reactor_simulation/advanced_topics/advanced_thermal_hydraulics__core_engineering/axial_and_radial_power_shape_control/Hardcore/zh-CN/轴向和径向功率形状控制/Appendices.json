{
    "hands_on_practices": [
        {
            "introduction": "在反应堆运行中，一项核心技能是能够预测功率分布对微小控制操作（如控制棒的移动）的响应。微扰理论为此提供了一个强大而高效的分析与计算工具，使我们无需重新进行完整的堆芯计算，就能估算出功率形状的变化。本练习将引导你推导并实现适用于中子扩散方程的广义特征值问题的一阶微扰理论，通过一个具体的编程任务，你将亲手计算吸收体扰动如何引起轴向和径向功率形状的倾斜 ()。",
            "id": "4214988",
            "problem": "你需要使用灵敏度与微扰理论，在二维单能群中子扩散反应堆模拟中，对轴向和径向功率形状控制进行建模和分析。从具有真空（狄利克雷）边界条件的均匀矩形堆芯中的稳态单能群中子扩散方程开始。其控制方程是扩散、吸收和裂变源之间的平衡，表示为\n$$\n-\\nabla \\cdot \\left(D \\nabla \\phi(\\mathbf{r})\\right) + \\Sigma_a(\\mathbf{r}) \\,\\phi(\\mathbf{r}) = \\frac{1}{k} \\,\\nu \\Sigma_f(\\mathbf{r}) \\,\\phi(\\mathbf{r}),\n$$\n其中 $D$ 是扩散系数，$\\Sigma_a$ 是宏观吸收截面，$\\nu \\Sigma_f$ 是宏观裂变产生截面，$\\phi(\\mathbf{r})$ 是中子通量，$k$ 是增殖因子。将此方程转化为广义特征值问题\n$$\nL \\,\\phi = \\lambda \\,F \\,\\phi,\n$$\n其中 $\\lambda = \\frac{1}{k}$，$L$ 是离散的扩散加吸收算子，$F$ 是离散的裂变产生算子。在轴向使用 $N_x$ 个点，径向使用 $N_y$ 个点进行均匀的笛卡尔有限差分离散，并通过在边界上设置通量固定为零来实现真空边界条件。所有物理量均为无量纲；$D$、$\\Sigma_a$ 和 $\\nu \\Sigma_f$ 仅在施加微扰时才随空间变化。\n\n将功率密度矢量 $p$ 定义为按通量加权的裂变源，\n$$\np = F \\,\\phi,\n$$\n并将归一化功率形状 $s$ 定义为\n$$\ns = \\frac{p}{\\sum_i p_i},\n$$\n其中求和遍及所有空间自由度。假设对于离散问题，在标准欧几里得内积下，$L$ 和 $F$ 是对称正定算子，并且基波模占主导地位。\n\n对吸收截面场施加一个小的、空间变化的微扰量 $\\delta \\Sigma_a(\\mathbf{r})$，使得\n$$\n\\Sigma_a(\\mathbf{r}) \\rightarrow \\Sigma_a(\\mathbf{r}) + \\epsilon\\,\\delta \\Sigma_a(\\mathbf{r}),\n$$\n其中标量 $\\epsilon > 0$ 很小。根据一阶微扰理论，从广义特征值问题推导特征值变化量 $\\delta \\lambda$、特征函数变化量 $\\delta \\phi$ 以及相应的归一化功率形状变化量 $\\delta s$ 的一阶表达式。构建任何必要的归一化约束和辅助线性系统，以使问题适定。你的推导必须从控制平衡方程开始，通过广义特征值问题公式进行，不得引用任何快捷公式。\n\n实现一个程序，该程序：\n- 离散化一个矩形堆芯，其参数为 $N_x = 20$，$N_y = 20$，常数 $D = 1$，基准 $\\Sigma_a = 0.01$，以及基准 $\\nu \\Sigma_f = 0.02$。\n- 使用对 $L^{-1} F$ 的反幂法迭代计算基波广义特征对 $(\\phi, \\lambda)$，并对 $\\phi$进行归一化，使得 $\\phi^\\top F \\phi = 1$，然后计算基准归一化功率形状 $s$。\n- 对吸收场应用三种测试案例的微扰，每种都按 $\\epsilon = 10^{-4}$ 进行缩放，并对每种情况：\n  1. 通过你推导的灵敏度与微扰理论，预测一阶变化量 $\\delta s$。\n  2. 通过重新求解受微扰的特征值问题，并从受微扰的 $(\\phi', \\lambda')$ 形成 $s'$，然后计算 $s' - s$，来独立地计算形状的实际变化量。\n  3. 输出一个标量误差，该误差定义为预测变化量与实际变化量之差的无穷范数，即 $\\|\\delta s - (s' - s)\\|_\\infty$。\n\n使用以下 $\\delta \\Sigma_a(\\mathbf{r})$ 的测试微扰套件：\n- 案例 A（轴向顶部半区吸收体）：对于轴向索引 $i \\in \\{10,11,\\dots,19\\}$，$\\delta \\Sigma_a(\\mathbf{r}_{i,j}) = 1$，否则为 $0$。\n- 案例 B（径向边缘吸收体）：对于任何与矩形边界的最小距离 $\\leq 2$ 个网格单元的栅元，$\\delta \\Sigma_a(\\mathbf{r}_{i,j}) = 1$，否则为 $0$。\n- 案例 C（无微扰）：对所有栅元，$\\delta \\Sigma_a(\\mathbf{r}_{i,j}) = 0$。\n\n最终输出必须是单行文本，包含案例 A、B 和 C 的三个误差值，按此顺序排列，形式为逗号分隔的列表并用方括号括起，例如 $[x_A,x_B,x_C]$。所有量都是无量纲的，输出值必须是不带单位的普通浮点数。",
            "solution": "用户希望分析吸收截面的微扰对核反应堆功率分布的影响。这是反应堆物理学中的一个经典问题，可以使用广义特征值问题的一阶微扰理论来解决。该解决方案涉及理论推导和数值实现，以验证该理论。\n\n### 问题验证\n**步骤 1：提取已知条件**\n- **控制方程：** $-\\nabla \\cdot \\left(D \\nabla \\phi(\\mathbf{r})\\right) + \\Sigma_a(\\mathbf{r}) \\,\\phi(\\mathbf{r}) = \\frac{1}{k} \\,\\nu \\Sigma_f(\\mathbf{r}) \\,\\phi(\\mathbf{r})$\n- **算子形式：** $L \\,\\phi = \\lambda \\,F \\,\\phi$，其中 $\\lambda = \\frac{1}{k}$。\n- **算子：** $L$ 是离散的扩散加吸收算子，$F$ 是离散的裂变产生算子。假设为对称正定。\n- **功率定义：** 功率密度 $p = F \\,\\phi$，归一化功率形状 $s = p / \\sum_i p_i$。\n- **微扰：** $\\Sigma_a(\\mathbf{r}) \\rightarrow \\Sigma_a(\\mathbf{r}) + \\epsilon\\,\\delta \\Sigma_a(\\mathbf{r})$，其中 $\\epsilon = 10^{-4}$。\n- **离散化：** 均匀笛卡尔有限差分，$N_x=20$（轴向），$N_y=20$（径向）。真空（零通量）边界条件。\n- **基准参数：** $D=1$，$\\Sigma_a=0.01$，$\\nu\\Sigma_f=0.02$。所有量均为无量纲。\n- **归一化：** 基波特征函数 $\\phi$ 被归一化，使得 $\\phi^\\top F \\phi = 1$。\n- **$\\delta \\Sigma_a(\\mathbf{r}_{i,j})$ 的测试案例：**\n  - 案例 A（轴向顶部半区）：对于轴向索引 $i \\in \\{10,11,\\dots,19\\}$（假设为0-索引网格）为 $1$，否则为 $0$。\n  - 案例 B（径向边缘）：对于任何到边界的最小距离 $\\leq 2$ 个网格单元的栅元为 $1$，否则为 $0$。解释为索引 $i$ 或 $j$ 在 $\\{0, 1, 18, 19\\}$ 中。\n  - 案例 C（无微扰）：对所有栅元均为 $0$。\n- **任务：**\n  1. 推导 $\\delta \\lambda$、$\\delta \\phi$ 和 $\\delta s$ 的一阶表达式。\n  2. 实现一个程序来计算基准状态 $(\\phi, \\lambda)$。\n  3. 对每个测试案例，计算预测的变化量 $\\delta s$ 和“实际”变化量 $s' - s$（通过重新求解受微扰的特征值问题得到）。\n  4. 对每个案例，输出差异的无穷范数 $\\|\\delta s - (s'-s)\\|_\\infty$。\n\n**步骤 2：使用已知条件进行验证**\n- **科学依据：** 该问题基于单能群中子扩散方程，这是反应堆物理学的基石。在此领域，使用微扰理论是一种标准且有效的分析技术。该设置是一个成熟的学术模型。对于一个无量纲模型来说，这些参数在物理上是合理的。\n- **适定性：** 该问题是一个对称正定算子系统的广义特征值问题。基波模的存在性和唯一性（在缩放范围内）得到保证。问题指定了归一化条件，使得 $\\phi$ 的解是唯一的。问题要求推导一个辅助线性系统来求解 $\\delta\\phi$，这表明问题意识到了朴素微扰方程的病态性质以及如何修正它。\n- **客观性：** 问题以精确的数学和物理术语陈述，没有主观性。\n- **完整性：** 所有必要的参数（$N_x, N_y, D, \\Sigma_a, \\nu\\Sigma_f, \\epsilon$）和边界条件都已指定。测试案例定义清晰。计算特征值的方法（反幂法迭代）和误差度量也已指定。\n- **一致性：** 问题陈述中没有明显的矛盾。\n\n**步骤 3：结论与行动**\n该问题在科学上是合理的、适定的且完整的。它代表了数值反应堆物理学中一个标准的、严谨的练习。\n**结论：有效。** 我将继续进行求解。\n\n### 理论推导\n\n分析始于算子形式的未受微扰的、不含时的广义特征值问题：\n$$ L_0 \\phi_0 = \\lambda_0 F_0 \\phi_0 $$\n其中 $\\phi_0$ 是基波模特征函数（中子通量），$\\lambda_0 = 1/k_0$ 是对应的基波特征值。问题指出，算子 $L_0$（扩散和吸收）和 $F_0$（裂变产生）是实对称的。因此，伴随特征函数与正向特征函数相同。\n\n在吸收截面中引入一个小的微扰，$\\Sigma_a \\rightarrow \\Sigma_a + \\delta\\Sigma_a$。这只影响算子 $L$。裂变算子 $F$ 保持不变。受微扰的系统为：\n$$ L' \\phi' = \\lambda' F_0 \\phi' $$\n其中 $L' = L_0 + \\delta L$，$\\lambda' = \\lambda_0 + \\delta\\lambda$，$\\phi' = \\phi_0 + \\delta\\phi$。微扰算子 $\\delta L$ 是一个对角矩阵，其元素是在每个空间点处宏观吸收截面的变化量 $\\delta\\Sigma_a$。对于此问题，$\\delta L = \\epsilon \\cdot \\text{diag}(\\delta\\Sigma_{a,i})$，其中 $\\delta\\Sigma_{a,i}$ 是吸收体微扰的模式。\n\n将受微扰的量代入特征值方程：\n$$ (L_0 + \\delta L)(\\phi_0 + \\delta\\phi) = (\\lambda_0 + \\delta\\lambda) F_0 (\\phi_0 + \\delta\\phi) $$\n展开并只保留到一阶小量，得到：\n$$ L_0 \\phi_0 + L_0 \\delta\\phi + \\delta L \\phi_0 \\approx \\lambda_0 F_0 \\phi_0 + \\lambda_0 F_0 \\delta\\phi + \\delta\\lambda F_0 \\phi_0 $$\n未受微扰的项 $L_0 \\phi_0 = \\lambda_0 F_0 \\phi_0$ 相互抵消，留下一阶方程：\n$$ (L_0 - \\lambda_0 F_0) \\delta\\phi \\approx (\\delta\\lambda F_0 - \\delta L) \\phi_0 $$\n\n**1. 特征值的变化量, $\\delta\\lambda$**\n为了求得 $\\delta\\lambda$，我们将一阶方程与未受微扰的特征函数 $\\phi_0$ 作内积（这里是标准矢量点积）：\n$$ \\langle \\phi_0, (L_0 - \\lambda_0 F_0) \\delta\\phi \\rangle = \\langle \\phi_0, (\\delta\\lambda F_0 - \\delta L) \\phi_0 \\rangle $$\n利用 $L_0$ 和 $F_0$ 的对称性，左侧为 $\\langle (L_0 - \\lambda_0 F_0) \\phi_0, \\delta\\phi \\rangle = \\langle 0, \\delta\\phi \\rangle = 0$。因此，右侧也必须为零：\n$$ \\langle \\phi_0, (\\delta\\lambda F_0 - \\delta L) \\phi_0 \\rangle = 0 $$\n$$ \\delta\\lambda \\langle \\phi_0, F_0 \\phi_0 \\rangle - \\langle \\phi_0, \\delta L \\phi_0 \\rangle = 0 $$\n解出 $\\delta\\lambda$ 得到经典的一阶微扰理论结果：\n$$ \\delta\\lambda = \\frac{\\langle \\phi_0, \\delta L \\phi_0 \\rangle}{\\langle \\phi_0, F_0 \\phi_0 \\rangle} $$\n根据指定的归一化条件 $\\langle \\phi_0, F_0 \\phi_0 \\rangle = \\phi_0^\\top F_0 \\phi_0 = 1$，上式简化为 $\\delta\\lambda = \\langle \\phi_0, \\delta L \\phi_0 \\rangle$。\n\n**2. 特征函数的变化量, $\\delta\\phi$**\n求解 $\\delta\\phi$ 的方程是 $(L_0 - \\lambda_0 F_0) \\delta\\phi = (\\delta\\lambda F_0 - \\delta L) \\phi_0$。算子 $(L_0 - \\lambda_0 F_0)$ 是奇异的，因为 $\\lambda_0$ 是它的一个特征值。解之所以存在，是因为右端项与伴随算子 $(L_0 - \\lambda_0 F_0)^\\dagger = (L_0 - \\lambda_0 F_0)$ 的零空间正交，该零空间由 $\\phi_0$ 张成。然而，解不是唯一的；可以在解上加上任意倍数的 $\\phi_0$。为了获得唯一解，我们必须施加一个额外的约束。对于广义特征值问题，一个标准的选择是要求微扰 $\\delta\\phi$ 与原始特征函数 $\\phi_0$ 是 $F_0$-正交的：\n$$ \\langle \\phi_0, F_0 \\delta\\phi \\rangle = 0 $$\n这个奇异线性系统和正交性约束可以合并成一个单一的、非奇异的分块矩阵系统：\n$$\n\\begin{pmatrix}\nL_0 - \\lambda_0 F_0  F_0 \\phi_0 \\\\\n\\phi_0^\\top F_0  0\n\\end{pmatrix}\n\\begin{pmatrix}\n\\delta\\phi \\\\ c\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n(\\delta\\lambda F_0 - \\delta L) \\phi_0 \\\\ 0\n\\end{pmatrix}\n$$\n其中 $c$ 是一个拉格朗日乘子，结果为零。求解这个 $(N+1) \\times (N+1)$ 的系统可以得到满足微扰方程和正交性约束的唯一 $\\delta\\phi$。\n\n**3. 归一化功率形状的变化量, $\\delta s$**\n归一化功率形状为 $s = p / (\\mathbf{1}^\\top p)$，其中 $p = F_0 \\phi$，$\\mathbf{1}$ 是一个全一矢量。受微扰的形状为 $s' = s + \\delta s$。到一阶精度：\n$$ s' = \\frac{F_0(\\phi_0 + \\delta\\phi)}{\\mathbf{1}^\\top F_0(\\phi_0 + \\delta\\phi)} = \\frac{p_0 + \\delta p}{P_{tot,0} + \\delta P_{tot}} $$\n其中 $p_0=F_0\\phi_0$，$\\delta p=F_0\\delta\\phi$，$P_{tot,0}=\\mathbf{1}^\\top p_0$，$\\delta P_{tot}=\\mathbf{1}^\\top \\delta p$。\n使用一阶近似 $(1+x)^{-1} \\approx 1-x$：\n$$ s' \\approx \\frac{p_0 + \\delta p}{P_{tot,0}} \\left(1 - \\frac{\\delta P_{tot}}{P_{tot,0}}\\right) \\approx \\frac{p_0}{P_{tot,0}} + \\frac{\\delta p}{P_{tot,0}} - \\frac{p_0 \\delta P_{tot}}{P_{tot,0}^2} $$\n注意到 $s_0 = p_0 / P_{tot,0}$，我们找到功率形状的一阶变化量：\n$$ \\delta s = s' - s_0 \\approx \\frac{\\delta p}{P_{tot,0}} - s_0 \\frac{\\delta P_{tot}}{P_{tot,0}} $$\n$\\delta s$ 中各项之和为 $\\mathbf{1}^\\top\\delta s = \\frac{\\mathbf{1}^\\top\\delta p}{P_{tot,0}} - (\\mathbf{1}^\\top s_0) \\frac{\\delta P_{tot}}{P_{tot,0}} = \\frac{\\delta P_{tot}}{P_{tot,0}} - 1 \\cdot \\frac{\\delta P_{tot}}{P_{tot,0}} = 0$，这是归一化分布变化的必要条件。\n\n### 数值实现计划\n实现将按以下步骤进行：\n1.  **离散化：** 建立一个大小为 $N_x \\times N_y = 20 \\times 20$ 的二维网格。使用单位间距（$h_x=h_y=1$）和零通量边界条件下，拉普拉斯算子的五点有限差分格式构建稀疏系统矩阵 $L_0$ 和 $F_0$。算子表示为 $N \\times N$ 的稀疏矩阵，其中 $N=N_x N_y = 400$。\n2.  **基准解：** 求解未受微扰的广义特征值问题 $L_0\\phi_0 = \\lambda_0 F_0\\phi_0$，得到基波特征对 $(\\lambda_0, \\phi_0)$。这通过对算子 $L_0^{-1}F_0$ 使用反幂法迭代来完成，该方法收敛到对应于最大特征值 $k_0 = 1/\\lambda_0$ 的特征向量。得到的通量 $\\phi_0$ 被归一化，使得 $\\phi_0^\\top F_0 \\phi_0 = 1$。然后计算基准功率形状 $s_0$。\n3.  **微扰分析（对每个案例）：**\n    a. 基于给定的 $\\delta\\Sigma_a$ 构建微扰矩阵 $\\delta L$。\n    b. 使用推导出的公式计算预测的特征值变化量 $\\delta\\lambda$。\n    c. 构建并求解增广线性系统以找到预测的通量变化量 $\\delta\\phi$。\n    d. 从 $\\delta\\phi$ 计算预测的功率形状变化量 $\\delta s$。\n4.  **直接求解（对每个案例）：**\n    a. 构建受微扰的算子 $L' = L_0 + \\delta L$。\n    b. 使用相同的反幂法迭代方法求解新的特征值问题 $L'\\phi' = \\lambda' F_0\\phi'$。\n    c. 归一化受微扰的通量 $\\phi'$ 并计算新的功率形状 $s'$。\n    d. “实际”变化量是差值 $s'-s_0$。\n5.  **误差计算：** 对于三个案例中的每一个，计算预测和实际功率形状变化量之差的无穷范数作为误差：$\\|\\delta s - (s'-s_0)\\|_\\infty$。\n6.  **输出：** 按指定格式报告三个误差值。案例 C 可作为一个有价值的合理性检查，因为预测和实际的变化量都应为零，从而导致零误差。",
            "answer": "```python\nimport numpy as np\nfrom scipy.sparse import diags, csc_matrix, bmat\nfrom scipy.sparse.linalg import spsolve\n\ndef build_operators(Nx, Ny, D, Sigma_a, nu_Sigma_f):\n    \"\"\"\n    Builds the finite difference operators L and F for the 2D neutron diffusion equation.\n    \n    Args:\n        Nx (int): Number of grid points in the x-direction.\n        Ny (int): Number of grid points in the y-direction.\n        D (float or np.ndarray): Diffusion coefficient.\n        Sigma_a (float or np.ndarray): Absorption cross-section.\n        nu_Sigma_f (float or np.ndarray): Fission production cross-section.\n        \n    Returns:\n        (csc_matrix, csc_matrix): Sparse matrices L and F.\n    \"\"\"\n    N = Nx * Ny\n    # Assume grid spacing hx=hy=1 as problem is dimensionless\n    hx2, hy2 = 1.0, 1.0\n\n    # Create the 5-point stencil for the Laplacian part of L\n    # Main diagonal from centered difference and absorption\n    diag_L = (2 * D / hx2 + 2 * D / hy2) * np.ones(N) + Sigma_a.flatten()\n    \n    # Off-diagonals for x-dir coupling\n    off_diag_x = -D / hx2 * np.ones(N - Ny)\n    \n    # Off-diagonals for y-dir coupling\n    off_diag_y = -D / hy2 * np.ones(N - 1)\n    # Remove connections at grid boundaries (row wraps)\n    for i in range(1, Nx):\n        off_diag_y[i * Ny - 1] = 0\n\n    L = diags(\n        [off_diag_x, off_diag_y, diag_L, off_diag_y, off_diag_x],\n        [-Ny, -1, 0, 1, Ny],\n        format='csc'\n    )\n    \n    # Fission operator F is a diagonal matrix\n    F = diags([nu_Sigma_f.flatten()], [0], format='csc')\n    \n    return L, F\n\ndef inverse_power_iteration(L, F, tol=1e-10, max_iter=200):\n    \"\"\"\n    Solves the generalized eigenvalue problem L*phi = lambda*F*phi for the\n    fundamental mode (largest k = 1/lambda) using inverse power iteration.\n    \n    Args:\n        L (csc_matrix): Diffusion/absorption operator.\n        F (csc_matrix): Fission operator.\n        tol (float): Convergence tolerance.\n        max_iter (int): Maximum number of iterations.\n        \n    Returns:\n        (float, np.ndarray): Fundamental eigenvalue lambda_0 and eigenvector phi_0.\n    \"\"\"\n    N = L.shape[0]\n    # Initial guess for the flux (must be positive for fundamental mode)\n    phi_guess = np.ones(N)\n    \n    k_eff = 1.0\n    for _ in range(max_iter):\n        source = F @ phi_guess\n        # Solve L * phi_new = source\n        phi_new = spsolve(L, source)\n        \n        # New eigenvalue estimate k = 1/lambda\n        k_new = np.linalg.norm(phi_new)\n        \n        # Normalize for next iteration\n        phi_new /= k_new\n        \n        # Check for convergence\n        if np.linalg.norm(phi_new - phi_guess)  tol:\n            break\n        \n        phi_guess = phi_new\n        k_eff = k_new\n\n    # Final eigenvalue is 1/k_eff\n    lambda_val = 1.0 / k_eff\n    phi_vec = phi_new\n    \n    return lambda_val, phi_vec\n\ndef solve():\n    \"\"\"\n    Main function to orchestrate the perturbation analysis.\n    \"\"\"\n    # 1. Problem setup\n    Nx, Ny = 20, 20\n    D_val = 1.0\n    Sigma_a_base = 0.01\n    nu_Sigma_f_base = 0.02\n    epsilon = 1e-4\n\n    N = Nx * Ny\n    \n    Sigma_a_grid = np.full((Nx, Ny), Sigma_a_base)\n    nu_Sigma_f_grid = np.full((Nx, Ny), nu_Sigma_f_base)\n\n    # 2. Baseline Calculation\n    L0, F0 = build_operators(Nx, Ny, D_val, Sigma_a_grid, nu_Sigma_f_grid)\n    lambda0_un, phi0_un = inverse_power_iteration(L0, F0)\n    \n    # Normalize phi0 such that phi0.T @ F0 @ phi0 = 1\n    norm_factor = np.sqrt(phi0_un.T @ F0 @ phi0_un)\n    phi0 = phi0_un / norm_factor\n    \n    # Recalculate lambda0 with normalized phi0 for better accuracy\n    lambda0 = (phi0.T @ L0 @ phi0) / (phi0.T @ F0 @ phi0)\n    \n    # Calculate baseline power shape s0\n    p0 = F0 @ phi0\n    P_total0 = np.sum(p0)\n    s0 = p0 / P_total0\n\n    # 3. Define Test Cases for delta_Sigma_a\n    test_cases = []\n\n    # Case A: Axial top-half absorber\n    delta_Sa_A = np.zeros((Nx, Ny))\n    delta_Sa_A[10:20, :] = 1.0\n    test_cases.append(delta_Sa_A)\n\n    # Case B: Radial rim absorber\n    delta_Sa_B = np.zeros((Nx, Ny))\n    for i in range(Nx):\n        for j in range(Ny):\n            if i = 1 or i >= Nx - 2 or j = 1 or j >= Ny - 2:\n                delta_Sa_B[i, j] = 1.0\n    test_cases.append(delta_Sa_B)\n    \n    # Case C: No perturbation\n    delta_Sa_C = np.zeros((Nx, Ny))\n    test_cases.append(delta_Sa_C)\n    \n    errors = []\n\n    for delta_Sa_pattern in test_cases:\n        # --- PERTURBATION THEORY PREDICTION ---\n        delta_L = diags([epsilon * delta_Sa_pattern.flatten()], [0], format='csc')\n        \n        # Predicted change in eigenvalue (using phi0.T @ F0 @ phi0 = 1)\n        delta_lambda = phi0.T @ delta_L @ phi0\n        \n        # Form RHS for the delta_phi system\n        rhs = (delta_lambda * F0 - delta_L) @ phi0\n\n        # Form and solve the augmented system for delta_phi\n        N = L0.shape[0]\n        op_A = L0 - lambda0 * F0\n        F_phi_col = F0 @ phi0\n        \n        # Build augmented matrix\n        A_aug = bmat([\n            [op_A, csc_matrix(F_phi_col).T],\n            [csc_matrix(F_phi_col), None]\n        ], format='csc')\n        \n        b_aug = np.zeros(N + 1)\n        b_aug[:N] = rhs\n        \n        x_aug = spsolve(A_aug, b_aug)\n        delta_phi = x_aug[:N]\n        \n        # Predicted change in power shape\n        delta_p = F0 @ delta_phi\n        delta_P_total = np.sum(delta_p)\n        delta_s_predicted = (delta_p / P_total0) - (s0 * delta_P_total / P_total0)\n        \n        # --- \"ACTUAL\" CHANGE FROM DIRECT RE-SOLVE ---\n        L_prime = L0 + delta_L\n        lambda_prime_un, phi_prime_un = inverse_power_iteration(L_prime, F0)\n\n        # Normalize phi_prime\n        norm_factor_prime = np.sqrt(phi_prime_un.T @ F0 @ phi_prime_un)\n        phi_prime = phi_prime_un / norm_factor_prime\n        \n        # Calculate new power shape s_prime\n        p_prime = F0 @ phi_prime\n        P_total_prime = np.sum(p_prime)\n        s_prime = p_prime / P_total_prime\n        \n        delta_s_actual = s_prime - s0\n        \n        # --- ERROR CALCULATION ---\n        error = np.linalg.norm(delta_s_predicted - delta_s_actual, np.inf)\n        errors.append(f\"{error:.6e}\")\n        \n    print(f\"[{','.join(errors)}]\")\n\nsolve()\n\n```"
        },
        {
            "introduction": "在掌握了对瞬时扰动的响应后，我们转向更长尺度上的挑战：燃料燃耗引起的功率形状演变。随着燃料的消耗和嬗变，堆芯的材料成分会发生变化，这反过来会持续改变中子通量和功率的分布。本练习聚焦于模拟这种多物理场耦合过程的核心数值方法，要求你基于反应速率驱动的燃耗原理，设计一个能够精确处理功率形状与材料组分相互作用的预测-校正耦合策略 ()。",
            "id": "4241754",
            "problem": "一个热中子核反应堆堆芯被建模为一个三维区域，其空间坐标用 $(\\mathbf{r})$ 表示。设中子标量通量为 $\\phi(\\mathbf{r},t)$，宏观裂变截面为 $\\Sigma_f(\\mathbf{r},t)$，后者通过燃耗依赖于核素的数密度。局部热功率密度为 $q(\\mathbf{r},t)$，定义为 $q(\\mathbf{r},t)=\\kappa\\,\\Sigma_f(\\mathbf{r},t)\\,\\phi(\\mathbf{r},t)$，其中 $\\kappa$ 是每次裂变释放的平均能量乘以一个适当的单位转换因子。反应堆总功率为 $P_{\\mathrm{tot}}(t)=\\int_V q(\\mathbf{r},t)\\,\\mathrm{d}V$。假设在时间区间 $[t_n,t_{n+1}]$ 内，存在一个运行约束，即 $P_{\\mathrm{tot}}(t)$ 保持在常数 $P_0$。\n\n核素数密度 $\\{N_j(\\mathbf{r},t)\\}$ 的演化遵循由反应率和衰变驱动的耦合常微分方程（ODE），其燃耗通用形式写作\n$$\n\\frac{\\partial N_j(\\mathbf{r},t)}{\\partial t}=\\sum_{k} \\lambda_{k\\to j} N_k(\\mathbf{r},t) - \\lambda_j N_j(\\mathbf{r},t) - \\sum_{r} \\sigma_{r,j}(\\mathbf{r},t)\\,\\phi(\\mathbf{r},t)\\,N_j(\\mathbf{r},t),\n$$\n其中 $\\lambda_j$ 是衰变常数，$\\lambda_{k\\to j}$ 是嬗变产额，$\\sigma_{r,j}$ 是反应 $r$（例如，裂变、俘获）的微观截面。\n\n在时间步 $t_n$ 的开始，通量形状是已知的，并由一个非负函数 $s_n(\\mathbf{r})$ 表示，该函数归一化以满足 $\\int_V s_n(\\mathbf{r})\\,\\mathrm{d}V=1$。在一个小的燃耗时间步 $\\Delta t=t_{n+1}-t_n$ 内，一个常见的近似是将通量表示为一个标量归一化因子和一个形状函数的乘积，即 $\\phi(\\mathbf{r},t)\\approx C(t)\\,s(\\mathbf{r},t)$，其中 $s(\\mathbf{r},t)$ 捕捉了通量（等效于功率密度）的轴向和径向分布，而 $C(t)$ 确保了总功率约束。\n\n根据反应率驱动的燃耗和功率定义的第一性原理，解释 $s(\\mathbf{r},t)$ 的空间变化（轴向或径向功率分布）如何影响核素的局部燃耗，并基于此理解，选择一种预测-校正耦合策略，该策略能在 $[t_n,t_{n+1}]$ 区间内维持形状一致的归一化并强制执行总功率约束。\n\n哪个选项最正确地捕捉了空间功率分布对局部燃耗的影响，并描述了一种在恒定总功率下保持形状一致归一化的科学一致的预测-校正算法？\n\nA. 在预测步中，将通量建模为 $\\phi(\\mathbf{r},t)\\approx C(t)\\,s_n(\\mathbf{r})$，其中 $C_{\\mathrm{pred}}$ 的选择需满足 $P_0=\\int_V \\kappa\\,\\Sigma_f^n(\\mathbf{r})\\,s_n(\\mathbf{r})\\,C_{\\mathrm{pred}}\\,\\mathrm{d}V$，使用步初的成分。在 $\\Delta t$ 上对燃耗常微分方程进行积分，以获得预测的数密度 $\\{N_j^{\\mathrm{pred}}(\\mathbf{r})\\}$。在校正步中，使用 $\\{N_j^{\\mathrm{pred}}(\\mathbf{r})\\}$ 通过中子学计算重新计算通量形状 $s_{n+1}(\\mathbf{r})$ 和截面 $\\Sigma_f^{n+1}(\\mathbf{r})$，并从 $P_0=\\int_V \\kappa\\,\\Sigma_f^{n+1}(\\mathbf{r})\\,s_{n+1}(\\mathbf{r})\\,C_{\\mathrm{corr}}\\,\\mathrm{d}V$ 确定 $C_{\\mathrm{corr}}$。使用与 $s_n(\\mathbf{r})+s_{n+1}(\\mathbf{r})$ 成比例的梯形平均值 $s_{\\mathrm{avg}}(\\mathbf{r})$ 和 $C_{\\mathrm{avg}}=(C_{\\mathrm{pred}}+C_{\\mathrm{corr}})/2$ 在 $\\Delta t$ 上重新对燃耗常微分方程进行积分，确保 $P_0=\\int_V \\kappa\\,\\overline{\\Sigma_f}(\\mathbf{r})\\,s_{\\mathrm{avg}}(\\mathbf{r})\\,C_{\\mathrm{avg}}\\,\\mathrm{d}V$，其中 $\\overline{\\Sigma_f}$ 是该步长上的一个适当平均值。这将轴向/径向功率形状与局部反应率耦合起来，并保持了形状一致的归一化。\n\nB. 在 $[t_n,t_{n+1}]$ 区间内将通量形状固定为 $s_n(\\mathbf{r})$，并在每个子步中选择 $C(t)$ 以使得 $\\max_{\\mathbf{r}\\in V} q(\\mathbf{r},t)$ 等于其在 $t_n$ 时的值。这确保了最热点的功率不变，从而无论 $\\Sigma_f(\\mathbf{r},t)$ 如何变化，都能在局部稳定燃耗。\n\nC. 使用预测-校正迭代来更新 $s(\\mathbf{r},t)$，但通过强制总中子通量 $\\int_V \\phi(\\mathbf{r},t)\\,\\mathrm{d}V$ 恒定来归一化通量，因为即使 $\\Sigma_f(\\mathbf{r},t)$ 演化，这也能保证反应率积分保持不变。\n\nD. 用单一体积模型替换空间分辨的燃耗，其中 $N_j(\\mathbf{r},t)$ 被体积平均，并使用 $P_0/V$ 进行均匀燃耗。预测-校正是不必要的，因为轴向/径向形状不影响恒定总功率所施加的均匀燃耗。\n\nE. 在预测步中，使用 $\\phi(\\mathbf{r},t)\\approx C(t)\\,s_n(\\mathbf{r})$ 并根据 $P_0$ 确定 $C(t)$；在校正步中，在各节点间重新分配 $C(t)$，使得每个节点的时间积分燃耗 $\\int_{t_n}^{t_{n+1}} q(\\mathbf{r},t)\\,\\mathrm{d}t$ 相等，从而确保均匀燃耗并通过构造保持形状归一化。",
            "solution": "## 问题验证\n\n### 步骤 1：提取已知信息\n问题陈述提供了以下信息：\n- **区域：** 一个三维区域，其空间坐标用 $\\mathbf{r}$ 表示。\n- **中子标量通量：** $\\phi(\\mathbf{r},t)$。\n- **宏观裂变截面：** $\\Sigma_f(\\mathbf{r},t)$，它依赖于核素数密度。\n- **局部热功率密度：** $q(\\mathbf{r},t)=\\kappa\\,\\Sigma_f(\\mathbf{r},t)\\,\\phi(\\mathbf{r},t)$，其中 $\\kappa$ 是每次裂变释放的平均能量乘以一个单位转换因子。\n- **反应堆总功率：** $P_{\\mathrm{tot}}(t)=\\int_V q(\\mathbf{r},t)\\,\\mathrm{d}V$。\n- **运行约束：** 在时间区间 $[t_n,t_{n+1}]$ 内，$P_{\\mathrm{tot}}(t)$ 保持在常数 $P_0$。\n- **燃耗方程：** 核素数密度 $\\{N_j(\\mathbf{r},t)\\}$ 的演化由以下常微分方程组给出：\n$$\n\\frac{\\partial N_j(\\mathbf{r},t)}{\\partial t}=\\sum_{k} \\lambda_{k\\to j} N_k(\\mathbf{r},t) - \\lambda_j N_j(\\mathbf{r},t) - \\sum_{r} \\sigma_{r,j}(\\mathbf{r},t)\\,\\phi(\\mathbf{r},t)\\,N_j(\\mathbf{r},t)\n$$\n- **通量近似：** 在一个小的时间步 $\\Delta t = t_{n+1} - t_n$ 内，通量近似为一个标量归一化因子 $C(t)$ 和一个形状函数 $s(\\mathbf{r},t)$ 的乘积：$\\phi(\\mathbf{r},t)\\approx C(t)\\,s(\\mathbf{r},t)$。\n- **$t_n$ 时的初始条件：** 通量形状 $s_n(\\mathbf{r})$ 是已知的，并归一化以满足 $\\int_V s_n(\\mathbf{r})\\,\\mathrm{d}V=1$。\n\n### 步骤 2：使用提取的已知信息进行验证\n根据验证标准对问题陈述进行审查。\n\n- **科学依据：** 该问题坚实地基于核反应堆物理的标准模型。功率密度的定义、总功率积分、用于核素燃耗的贝特曼方程，以及将中子通量分离为幅值和形状分量的准静态近似，都是核工程和反应堆分析中的基本且普遍接受的概念。\n- **适定性：** 该问题提供了一个清晰的物理和数学框架，并要求确定一个一致的数值算法（预测-校正）来求解该耦合系统。目标定义明确：在精确模拟空间依赖性燃耗的同时，保持恒定的总功率。预期会有一个唯一的概念性答案。\n- **客观性：** 术语在反应堆物理领域是精确和标准的。方程以其常规形式呈现。问题没有主观或模糊的语言。\n- **完整性和一致性：** 该问题提供了理解中子学（通量形状和幅值）与燃耗（材料成分变化）之间耦合所需的所有必要元素。反馈回路被隐含地定义为：$\\phi \\rightarrow N_j \\rightarrow \\Sigma_f \\rightarrow \\phi$。恒定总功率的约束被明确陈述。该设置内部一致，足以对数值方法进行概念性分析。\n- **真实性：** 该场景描述了燃料循环分析中的一个标准运行模式（恒功率）和一个标准的计算挑战。虽然是对真实反应堆的简化，但该模型捕捉了基本物理原理，并非不切实际或不可行。\n\n### 步骤 3：结论与行动\n问题陈述科学合理、适定、客观且内部一致。它提出了一个计算反应堆物理领域的有效且标准的问题。因此，该问题是 **有效的**，我将继续进行完整解答。\n\n## 解题推导\n\n问题的核心在于中子通量 $\\phi(\\mathbf{r},t)$ 和核素数密度 $N_j(\\mathbf{r},t)$ 之间的耦合。燃耗方程，\n$$\n\\frac{\\partial N_j}{\\partial t} = \\dots - \\sigma_{r,j}\\phi N_j\n$$\n表明，在特定位置 $\\mathbf{r}$ 的核素浓度变化率与当地的中子通量 $\\phi(\\mathbf{r},t)$ 成正比。更高的通量导致材料更快的嬗变和燃耗。\n\n由所有 $\\{N_j(\\mathbf{r},t)\\}$ 集合代表的材料成分决定了宏观截面，包括裂变截面：\n$$\n\\Sigma_f(\\mathbf{r},t) = \\sum_j N_j(\\mathbf{r},t) \\sigma_{f,j}\n$$\n其中 $\\sigma_{f,j}$ 是核素 $j$ 的微观裂变截面。\n\n中子通量分布 $\\phi(\\mathbf{r},t)$ 本身是中子输运（或扩散）方程的解，该方程的系数是宏观截面。因此，随着核素密度因燃耗而变化，截面也随之变化，这反过来又会改变平衡通量分布的形状和幅值。\n\n该问题施加了恒定总功率 $P_0$ 的约束。使用通量分离近似 $\\phi(\\mathbf{r},t) \\approx C(t)s(\\mathbf{r},t)$，功率约束变为：\n$$\nP_0 = \\int_V \\kappa\\,\\Sigma_f(\\mathbf{r},t)\\,C(t)s(\\mathbf{r},t)\\,\\mathrm{d}V\n$$\n这使我们能够确定归一化因子 $C(t)$：\n$$\nC(t) = \\frac{P_0}{\\int_V \\kappa\\,\\Sigma_f(\\mathbf{r},t)\\,s(\\mathbf{r},t)\\,\\mathrm{d}V}\n$$\n由于 $\\Sigma_f(\\mathbf{r},t)$ 和通量形状 $s(\\mathbf{r},t)$ 在时间步 $[t_n, t_{n+1}]$ 内都会演化，归一化因子 $C(t)$ 也必须进行调整以维持 $P_0$。一种简单的“显式”方法，即在整个步长内都使用通量 $\\phi(\\mathbf{r},t_n)$，很容易产生显著误差，因为它忽略了这种演化。\n\n预测-校正方法通过以下方式解决这个问题：\n1.  **预测步：** 使用时间步开始（$t_n$）时的信息，估计时间步结束（$t_{n+1}$）时的状态。一种常见的方法是假设通量在整个步长内保持不变，即 $\\phi(\\mathbf{r},t) \\approx \\phi(\\mathbf{r},t_n)$。\n2.  **校正步：** 使用预测的步末状态来形成对步长*内部*行为的更好近似（例如，通过对步初和步末状态进行平均），然后用这个改进的近似重新计算最终状态。\n\n现在让我们基于这些原则来评估各个选项。\n\n### 逐项分析\n\n**A. 在预测步中，将通量建模为 $\\phi(\\mathbf{r},t)\\approx C(t)\\,s_n(\\mathbf{r})$，其中 $C_{\\mathrm{pred}}$ 的选择需满足 $P_0=\\int_V \\kappa\\,\\Sigma_f^n(\\mathbf{r})\\,s_n(\\mathbf{r})\\,C_{\\mathrm{pred}}\\,\\mathrm{d}V$，使用步初的成分。在 $\\Delta t$ 上对燃耗常微分方程进行积分，以获得预测的数密度 $\\{N_j^{\\mathrm{pred}}(\\mathbf{r})\\}$。在校正步中，使用 $\\{N_j^{\\mathrm{pred}}(\\mathbf{r})\\}$ 通过中子学计算重新计算通量形状 $s_{n+1}(\\mathbf{r})$ 和截面 $\\Sigma_f^{n+1}(\\mathbf{r})$，并从 $P_0=\\int_V \\kappa\\,\\Sigma_f^{n+1}(\\mathbf{r})\\,s_{n+1}(\\mathbf{r})\\,C_{\\mathrm{corr}}\\,\\mathrm{d}V$ 确定 $C_{\\mathrm{corr}}$。使用与 $s_n(\\mathbf{r})+s_{n+1}(\\mathbf{r})$ 成比例的梯形平均值 $s_{\\mathrm{avg}}(\\mathbf{r})$ 和 $C_{\\mathrm{avg}}=(C_{\\mathrm{pred}}+C_{\\mathrm{corr}})/2$ 在 $\\Delta t$ 上重新对燃耗常微分方程进行积分，确保 $P_0=\\int_V \\kappa\\,\\overline{\\Sigma_f}(\\mathbf{r})\\,s_{\\mathrm{avg}}(\\mathbf{r})\\,C_{\\mathrm{avg}}\\,\\mathrm{d}V$，其中 $\\overline{\\Sigma_f}$ 是该步长上的一个适当平均值。这将轴向/径向功率形状与局部反应率耦合起来，并保持了形状一致的归一化。**\n\n该选项描述了一种科学上严谨的预测-校正方案。\n- **预测步：** 它正确地使用了步初（BOS）的通量形状 $s_n$，并计算归一化因子 $C_{\\mathrm{pred}}$ 以满足使用BOS成分 $\\Sigma_f^n$ 时的功率约束 $P_0$。然后求解燃耗方程，得到步末（EOS）核素密度 $N_j^{\\mathrm{pred}}$ 的初步估计。这是一个标准的显式欧拉或一阶预测方法。\n- **校正步：** 它正确地使用了预测的密度 $N_j^{\\mathrm{pred}}$ 来将截面更新为 $\\Sigma_f^{n+1}$，然后执行新的中子学计算以找到更新后的EOS通量形状 $s_{n+1}$。这直接考虑了燃耗对通量形状的反馈。它还计算了与EOS状态一致的新的归一化因子 $C_{\\mathrm{corr}}$。最后，它使用平均通量表示（结合了BOS和EOS信息，这是梯形法或二阶方法的特征）再次执行燃耗计算，为最终的EOS密度提供了更准确的解。这整个过程正确地将空间功率分布与局部燃耗率耦合起来，并保持了与宏观功率约束的一致性。\n结论是 **正确**。\n\n**B. 在 $[t_n,t_{n+1}]$ 区间内将通量形状固定为 $s_n(\\mathbf{r})$，并在每个子步中选择 $C(t)$ 以使得 $\\max_{\\mathbf{r}\\in V} q(\\mathbf{r},t)$ 等于其在 $t_n$ 时的值。这确保了最热点的功率不变，从而无论 $\\Sigma_f(\\mathbf{r},t)$ 如何变化，都能在局部稳定燃耗。**\n\n这个选项有两个主要缺陷。首先，它提出的方法只是“将通量形状固定”，这是一种显式的、一阶的方法，而不是预测-校正方法。它未能根据变化的材料成分更新通量形状。其次，更关键的是，它使用了一个错误的运行约束。问题陈述是*总*功率 $\\int_V q(\\mathbf{r},t)\\,\\mathrm{d}V$ 恒定，而不是*峰值*功率密度 $\\max_{\\mathbf{r}\\in V} q(\\mathbf{r},t)$ 恒定。在一个以恒定总功率运行的反应堆中，功率形状会随着时间变得扁平，这意味着峰值功率密度通常会下降。这个选项描述了一个物理上不正确的运行模式。\n结论是 **不正确**。\n\n**C. 使用预测-校正迭代来更新 $s(\\mathbf{r},t)$，但通过强制总中子通量 $\\int_V \\phi(\\mathbf{r},t)\\,\\mathrm{d}V$ 恒定来归一化通量，因为即使 $\\Sigma_f(\\mathbf{r},t)$ 演化，这也能保证反应率积分保持不变。**\n\n这个选项提出了一个不正确的归一化约束。问题明确指出，恒定量是总功率 $P_0 = \\int_V \\kappa\\,\\Sigma_f(\\mathbf{r},t)\\,\\phi(\\mathbf{r},t)\\,\\mathrm{d}V$。随着燃料的燃烧，宏观裂变截面 $\\Sigma_f(\\mathbf{r},t)$ 在整个堆芯中通常会减小。为了保持恒定功率，通量水平 $\\phi(\\mathbf{r},t)$ 必须增加。因此，总中子通量 $\\int_V \\phi(\\mathbf{r},t)\\,\\mathrm{d}V$ 不是恒定的，而是在燃料循环中通常会增加。这个选项的前提在物理上是错误的。\n结论是 **不正确**。\n\n**D. 用单一体积模型替换空间分辨的燃耗，其中 $N_j(\\mathbf{r},t)$ 被体积平均，并使用 $P_0/V$ 进行均匀燃耗。预测-校正是不必要的，因为轴向/径向形状不影响恒定总功率所施加的均匀燃耗。**\n\n这个选项直接回避了问题。问题具体是关于*空间变化*如何影响局部燃耗。通过提出一个单一体积（或“点”）模型，这个选项从一开始就抛弃了所有空间信息。在这样的模型中，没有所谓的通量形状 $s(\\mathbf{r},t)$，因此无法分析其对燃耗的影响。这种方法从根本上无法解决所提出的问题。虽然预测-校正方法在点模型中仍然可以用于处理非线性问题，但这里提供的理由是有缺陷的，并且完全偏离了问题的重点。\n结论是 **不正确**。\n\n**E. 在预测步中，使用 $\\phi(\\mathbf{r},t)\\approx C(t)\\,s_n(\\mathbf{r})$ 并根据 $P_0$ 确定 $C(t)$；在校正步中，在各节点间重新分配 $C(t)$，使得每个节点的时间积分燃耗 $\\int_{t_n}^{t_{n+1}} q(\\mathbf{r},t)\\,\\mathrm{d}t$ 相等，从而确保均匀燃耗并通过构造保持形状归一化。**\n\n所描述的预测步是合理的。然而，校正步在物理上是不可能且毫无意义的。反应堆中的通量分布由中子输运方程决定；它是系统几何和材料成分的基本属性，本质上是不均匀的。为了实现均匀燃耗（处处相等的时间积分功率密度）而“重新分配”通量的想法，将需要一个违反物理定律的通量形状。这样的过程在数值意义上不是“校正”；它是对系统状态的任意且非物理的操作。均匀燃耗是一个虚构的概念，而不是实际模拟的计算目标。\n结论是 **不正确**。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "宏观的功率形状控制最终需要落实到对微观安全参数的精确评估上，例如燃料棒内的功率峰值。这需要我们将粗网格计算得到的平均功率，重构为精细的棒内功率分布。本练习将你置于高性能计算科学家的角色，挑战你设计一种高效的数据结构来存储和评估依赖于多种局部状态参数的复杂功率形态函数，旨在内存占用、计算速度和精度之间取得最佳平衡 ()。",
            "id": "4241011",
            "problem": "在高保真燃料棒功率重建中，横向形状函数表示为一个二维棒内径向形式函数与一个一维轴向形式函数的可分离乘积。对每个燃料棒索引 $p$，在燃料棒横截面上定义二维径向形式函数 $F_{p}^{xy}(x,y;\\mathbf{s})$，并在堆芯高度上定义一维轴向形式函数 $F^{z}(z;\\mathbf{s})$。此处 $\\mathbf{s}\\in\\mathbb{R}^{d}$ 是一个状态向量，捕捉了局部运行和材料参数（例如，燃耗、冷却剂密度、燃料温度、硼浓度和控制棒插入份额），其中 $d=5$。假设：\n\n- 重建的局部裂变功率密度为 $q_{p}(x,y,z;\\mathbf{s})=\\Phi_{p}^{\\mathrm{avg}}(\\mathbf{s})\\,F_{p}^{xy}(x,y;\\mathbf{s})\\,F^{z}(z;\\mathbf{s})$，其中 $\\Phi_{p}^{\\mathrm{avg}}(\\mathbf{s})$ 是由粗网格求解器提供的燃料棒平均量。\n- $F_{p}^{xy}(x,y;\\mathbf{s})$ 和 $F^{z}(z;\\mathbf{s})$ 在其空间变量上是光滑的，并且在运行包络线内对 $\\mathbf{s}$ 是解析的，这与多群扩散算子的椭圆特性以及宏观截面对参数的光滑依赖性相一致。\n- 形式函数被归一化，使得 $\\int_{\\text{pin}}F_{p}^{xy}(x,y;\\mathbf{s})\\,\\mathrm{d}A=1$ 且 $\\int_{0}^{H}F^{z}(z;\\mathbf{s})\\,\\mathrm{d}z=1$，其中 $H$ 是堆芯高度。\n\n您必须选择一个数据结构来存储和评估 $F_{p}^{xy}(x,y;\\mathbf{s})$ 和 $F^{z}(z;\\mathbf{s})$，并满足以下约束条件：\n\n- 模拟中有 $P=50{,}000$ 个燃料棒，分为 $T=10$ 种燃料棒类型，它们具有共享的几何形状和相似的形状；您可以按燃料棒类型共享数据，但不能假设在所有 $\\mathbf{s}$ 上都完全相同。\n- 查询工作负载为每个时间步长 $Q=2\\times 10^{7}$ 次点评估，针对各种 $(x,y,z)$ 和 $\\mathbf{s}$ 值，径向和轴向形状的 $L^{2}$ 相对误差精度目标为 $\\leq 10^{-3}$。\n- 存储所有形式函数数据的内存预算为 $1\\,\\mathrm{GB}$（双精度，每个 double 为 $8$ 字节），并且评估过程应便于单指令多数据 (SIMD) 矢量化。\n- 评估必须支持梯度 $\\nabla_{xy}F_{p}^{xy}(x,y;\\mathbf{s})$ 和 $\\partial_{z}F^{z}(z;\\mathbf{s})$，其额外成本与函数值相比可以忽略不计。\n\n从扩散算子的控制属性（光滑的空间和参数依赖性，以及燃料棒内部无间断点）和函数逼近复杂度的标准概念出发，从以下选项中选择最合适的数据结构，并根据内存复杂度和插值/评估速度来证明您的选择。如果合适，可以分别处理 $F_{p}^{xy}(x,y;\\mathbf{s})$ 和 $F^{z}(z;\\mathbf{s})$，但要确保整体设计满足所有约束条件。\n\nA. 通过固有正交分解 (POD) 在状态向量上使用可分离的低秩表示：对于每种燃料棒类型，将 $F_{p}^{xy}(x,y;\\mathbf{s})$ 表示为 $\\approx\\sum_{k=1}^{r}a_{p,k}(\\mathbf{s})\\,\\phi_{k}^{xy}(x,y)$，其中每个空间模态 $\\phi_{k}^{xy}$ 存储为阶数为 $N_{x}=N_{y}=16$ 的张量积 Chebyshev 展开，每个系数图 $a_{p,k}(\\mathbf{s})$ 使用 $d=5$ 维、层级 $\\ell=3$ 的 Smolyak 稀疏网格分层余量进行存储。对于 $F^{z}(z;\\mathbf{s})$，每种燃料棒类型存储一个具有 $M_{z}=32$ 个节点的立方 Hermite 样条，并将节点值表示为 $\\sum_{m=1}^{r_{z}}b_{m}(\\mathbf{s})\\,\\psi_{m}^{z}$，其中 $r_{z}=3$，且 $b_{m}(\\mathbf{s})$ 存储在相同的稀疏网格上。使用 Clenshaw 算法和样条递归进行评估；梯度使用导数递归，额外成本可忽略不计。\n\nB. 对每个燃料棒存储原始节点表：对于具有每个状态维度 $8$ 个节点（总共 $8^{5}$ 个状态）的完整张量状态网格的每个点，在 $(x,y)$ 上存储一个均匀的 $64\\times 64$ 的 $F_{p}^{xy}$ 值网格，在 $(x,y)$ 上进行双线性插值，在 $\\mathbf{s}$ 上进行多线性插值。对于 $F^{z}$，每个状态网格点存储 $128$ 个均匀间隔的样本，并在 $z$ 上进行线性插值。\n\nC. 对每种燃料棒类型，为训练集中的每个不同状态样本在 $(x,y)$ 上构建一个自适应四叉树；每个叶节点存储分段线性段，并在 $\\mathbf{s}$ 中使用最近邻查找。对于 $F^{z}$，存储一个带有状态依赖断点的自适应分段线性分区。评估时对每个查询遍历该树。\n\nD. 对每种燃料棒类型，在 $(x,y,\\mathbf{s})$ 上存储一个完整的张量积三次B样条，其中空间节点数为 $K_{x}=K_{y}=21$，在 $d=5$ 的状态维度上每个维度有 $K_{s}=6$ 个节点（均匀节点），使用标准样条系数。对于 $F^{z}$，存储一个独立的三次B样条，在 $z$ 方向有 $64$ 个节点，每个状态维度有 $6$ 个节点。评估使用局部B样条基函数；通过对基多项式求导获得梯度。\n\n哪个选项最能满足基于光滑性的逼近属性、内存预算和评估速度的约束，为什么？请选择唯一的最佳选项。",
            "solution": "该问题要求评估四种不同的数据结构，用于表示核反应堆模拟中燃料棒内的裂变功率形式函数。所选方案必须满足内存、评估速度、精度和梯度支持方面的严格约束，同时要与基本的中子扩散方程的物理特性保持一致。\n\n问题的核心是逼近两个函数：径向形式函数 $F_{p}^{xy}(x,y;\\mathbf{s})$ 和轴向形式函数 $F^{z}(z;\\mathbf{s})$。已知这些函数在其空间变量 $(x,y,z)$ 上是光滑的，并在状态参数向量 $\\mathbf{s} \\in \\mathbb{R}^{5}$ 上是解析的。我们必须在考虑所有约束条件的情况下，从给定选项中选择最佳的表示方法。\n\n约束条件如下：\n- 燃料棒数量, $P = 50,000$。\n- 燃料棒类型数量, $T = 10$。\n- 状态向量维度, $d = 5$。\n- 内存预算: $1\\,\\mathrm{GB}$，即 $1 \\times 1024^3 \\text{ 字节} / (8 \\text{ 字节/double}) = 134,217,728$ 个双精度浮点数。\n- 精度: 相对 $L^2$ 误差 $\\leq 10^{-3}$。\n- 评估: 必须快速，便于 SIMD 矢量化，并以可忽略的额外成本提供空间梯度。\n\n我们现在来分析每个选项。\n\n### 逐项分析\n\n**选项 A：可分离低秩 (POD) + Chebyshev + 稀疏网格**\n\n这个选项提出了一种复杂的多级分层逼近方法。\n\n- **径向函数, $F_{p}^{xy}(x,y;\\mathbf{s})$**: 表示为 $F_{p}^{xy}(x,y;\\mathbf{s}) \\approx \\sum_{k=1}^{r} a_{p,k}(\\mathbf{s}) \\phi_{k}^{xy}(x,y)$。这分离了空间依赖性（在 $\\phi_{k}^{xy}$ 中）和参数依赖性（在 $a_{p,k}$ 中）。\n    - 空间模态 $\\phi_{k}^{xy}(x,y)$ 由阶数为 $N_{x}=N_{y}=16$ 的张量积 Chebyshev 展开表示。对于光滑函数，Chebyshev 展开提供谱精度（指数收敛），这对于用适量的项数满足像 $10^{-3}$ 这样严格的误差容限是理想的。每个模态的系数数量为 $(N_x+1)(N_y+1) = 17 \\times 17 = 289$。模态按燃料棒类型定义，因此它们的存储量为 $T \\times r \\times 289$ 个双精度浮点数。\n    - 系数图 $a_{p,k}(\\mathbf{s})$ 按燃料棒定义，并依赖于状态向量 $\\mathbf{s}$。它们在维度 $d=5$、层级 $\\ell=3$ 的 Smolyak 稀疏网格上表示。稀疏网格是一种先进技术，用于在中到高维度下对抗光滑函数的维数灾难。对于层级为 $3$、维度为 $5$ 的稀疏网格（使用 Clenshaw-Curtis 点），节点数为 $171$。存储每个图的分层余量需要 $171$ 个双精度浮点数。由于这些图是针对每个燃料棒的，这部分的存储量为 $P \\times r \\times 171$ 个双精度浮点数。\n- **轴向函数, $F^{z}(z;\\mathbf{s})$**: 空间依赖性使用具有 $M_{z}=32$ 个节点的立方 Hermite 样条。这提供了 $C^1$ 连续性和高效的评估。$2 \\times M_z = 64$ 个样条参数（节点上的函数值和导数值）的参数依赖性由另一个秩为 $r_z=3$ 的低秩分解处理，其系数存储在相同的稀疏网格上。这是按燃料棒类型定义的。这部分的内存占用可以忽略不计：$T \\times (r_z \\times 64 + r_z \\times 171) = 10 \\times (3 \\times 64 + 3 \\times 171) = 7,050$ 个双精度浮点数。\n- **内存计算**: 总内存主要由径向函数的燃料棒特定系数决定：$M_{total} = (P \\times r \\times 171) + (T \\times r \\times 289) + 7,050 = r \\times (50,000 \\times 171 + 10 \\times 289) + 7,050 = r \\times (8,550,000 + 2,890) + 7,050 \\approx r \\times 8.55 \\times 10^6$ 个双精度浮点数。秩 $r$ 未指定，但必须足以达到 $10^{-3}$ 的精度。对于光滑参数问题的 POD 表示，秩 $r \\in [10, 15]$ 是典型的。当 $r=12$ 时，内存约为 $12 \\times 8.55 \\times 10^6 \\approx 102.6 \\times 10^6$ 个双精度浮点数。这在 $134.2 \\times 10^6$ 的预算范围内。\n- **评估和梯度**: 评估涉及稀疏网格插值、Chebyshev 多项式评估（通过 Clenshaw 算法）和点积。所有这些操作计算效率高且高度规则，使其适合 SIMD 矢量化。至关重要的是，Chebyshev 多项式和样条的导数可以通过递归关系计算，其成本与函数评估本身相当，符合“可忽略的额外成本”约束。\n- **对 A 的结论**: 这个选项在科学上是合理的，它利用了先进的数值方法（谱方法、稀疏网格、POD），这些方法最适合所述的光滑性和解析性。它满足所有约束，尽管内存预算紧张但可行，具体取决于所需的 POD 秩。\n\n**选项 B：原始节点表**\n\n这个选项提出了一种简单的、带有多线性插值的查找表。\n\n- **内存计算**: 该方案要求为 $8^5$ 个状态网格点中的每一个存储一个 $64 \\times 64$ 的空间网格。如果按燃料棒类型存储，径向函数的内存为 $T \\times (64 \\times 64) \\times 8^5 = 10 \\times 4,096 \\times 32,768 = 1,342,177,280$ 个双精度浮点数。这是 $1.34 \\times 10^9$ 个双精度浮点数，是 $1.34 \\times 10^8$ 双精度浮点数内存预算的十倍。这个计算仅针对径向函数。轴向函数会增加更多内存。如果数据按燃料棒存储，内存需求将大得离谱（大 $P$ 倍）。在 $d=5$ 的状态空间中使用完整的张量积网格会遭受维数灾难，这个计算清楚地证明了这一点。\n- **评估和梯度**: 插值速度快，但梯度逼近效果差。多线性插值产生分段常数梯度，无法精确表示光滑函数的梯度。\n- **对 B 的结论**: 这个选项在内存约束上灾难性地失败了。这是一种蛮力方法，无法扩展到 5 维参数空间。\n\n**选项 C：自适应四叉树 + 最近邻**\n\n这个选项使用自适应空间网格，但参数表示非常粗糙。\n\n- **逼近质量**: 在状态空间 $\\mathbf{s}$ 中使用最近邻查找导致形式函数对参数的依赖性呈分段常数逼近。这对于解析函数来说是根本不合适的，因为它引入了人为的间断点，并且在 $\\mathbf{s}$ 上提供零阶精度。为了达到 $10^{-3}$ 的误差目标，将需要在状态空间中使用极其密集的训练样本集，从而导致巨大的内存占用。\n- **评估和梯度**: 评估涉及最近邻搜索（对于大型数据集速度较慢），然后是四叉树遍历。树遍历涉及指针追踪，并且众所周知难以用 SIMD 进行优化。空间梯度在四叉树的每个叶节点内是分段常数，精度很差。关于状态参数的梯度 $\\nabla_{\\mathbf{s}}F$ 在除了最近邻区域边界之外的所有地方都为零，而在边界处未定义。这完全不满足梯度要求。\n- **对 C 的结论**: 这个选项在处理状态空间依赖性方面存在根本性缺陷，不适合 SIMD 或提供精确的梯度。\n\n**选项 D：完整张量积 B 样条**\n\n这个选项在完整的张量积结构中对空间和参数维度都使用 B 样条。\n\n- **内存计算**:\n    - 对于 $F^{xy}$，每种燃料棒类型的系数数量是所有 7 个维度（$x, y, s_1, ..., s_5$）中基函数数量的乘积。对于三次样条（$p=3$），基函数的数量通常是（区间数 + 次数）。对于 $K_x=K_y=21$ 个节点，我们有 $20$ 个区间，因此有 $23$ 个基函数。对于 $K_s=6$ 个节点，我们有 $5$ 个区间，因此有 $8$ 个基函数。每种类型的总系数为 $23 \\times 23 \\times 8^5 = 529 \\times 32,768 = 17,332,288$。对于 $T=10$ 种类型，这是 $173,322,880$ 个双精度浮点数。\n    - 对于 $F^z$，每种类型的系数为 $(64-1+3) \\times 8^5 = 66 \\times 32,768 \\approx 2.16 \\times 10^6$。对于 $T=10$ 种类型，这是 $21.6 \\times 10^6$ 个双精度浮点数。\n    - 总内存约为 $173.3 \\times 10^6 + 21.6 \\times 10^6 = 194.9 \\times 10^6$ 个双精度浮点数。这超过了 $134.2 \\times 10^6$ 的预算超过 45%。\n- **评估和梯度**: B 样条具有优异的属性。它们提供 $C^2$ 光滑性，由于局部支撑性，评估速度快，并且通过对样条基进行微分，可以轻松且廉价地计算梯度。该提议的这一部分很强大。\n- **对 D 的结论**: 虽然 B 样条是逼近光滑函数的好选择，但这个选项依赖于 5 维状态空间上的完整张量积，使其内存消耗过大，类似于选项 B。它不满足内存约束。\n\n### 最终裁决\n\n比较四个选项：\n- **选项 A** 是唯一满足所有约束的选项。它采用了一系列先进的现代数值方法，这些方法专门设计用于处理问题的特性：光滑性（Chebyshev）、高维性（稀疏网格）和可分离性（POD）。\n- **选项 B** 和 **选项 D** 由于维数灾难而失败，通过在状态空间中使用完整的张量积网格导致过度的内存消耗。\n- **选项 C** 从根本上失败，因为它对解析函数使用了分段常数逼近（最近邻），并使用了一种不利于高性能计算的数据结构（树）。\n\n因此，选项 A 代表了最复杂和最合适的设计，它以符合计算科学最佳实践的方式平衡了精度、内存和计算性能。",
            "answer": "$$\\boxed{A}$$"
        }
    ]
}