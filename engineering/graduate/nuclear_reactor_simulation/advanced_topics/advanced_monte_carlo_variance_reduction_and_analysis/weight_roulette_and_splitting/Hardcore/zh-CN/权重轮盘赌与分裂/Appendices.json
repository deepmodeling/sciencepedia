{
    "hands_on_practices": [
        {
            "introduction": "在蒙特卡罗模拟中，有效的方差降低技术通常需要的不仅仅是方法的简单堆砌。本练习将深入探讨一个常见且实际的场景：根据粒子能量策略性地应用分裂技术，以平衡来自不同能量组的方差贡献。通过解决这个问题，您将学习如何设计最优的、依赖于能量的分裂因子 $n_g$ 以满足特定的方差目标，这是设计高效输运模拟的一项关键技能 。",
            "id": "4260711",
            "problem": "蒙特卡洛（MC）中子输运模拟估算嵌入在反应堆堆芯内一个小球形区域中的点探测器响应。为了在保持无偏性的同时减少估计量方差，该模拟对上游的低权重粒子应用权重轮盘赌，并在紧邻探测器周围的一个薄球壳（“窗”）内应用能量相关的分裂。探测器响应与粒子权重成线性关系，并计为每个克隆独立贡献的总和。\n\n在窗的上游，一个初始权重为 $w_{0}$ 的粒子以概率 $w_{0}/w_{c}$ 在俄罗斯轮盘赌中存活，如果存活，其权重被设置为 $w_{c}$，从而期望权重守恒。在窗内，能量被划分为三个群 $G_{1}$、 $G_{2}$ 和 $G_{3}$，进入窗的粒子落入每个群的概率分别为 $p_{1}$、 $p_{2}$ 和 $p_{3}$。进入群 $G_{g}$ 后，该粒子分裂成 $n_{g}$ 个独立的克隆，每个克隆的权重为 $w_{c}/n_{g}$。对于群 $G_{g}$ 中一个单位权重的粒子，其对探测器的得分贡献均值为零，标准差为 $\\sigma_{g}$；对于权重为 $w$ 的粒子，其得分贡献是线性缩放的，其方差按 $w^{2}\\sigma_{g}^{2}$ 的比例缩放。假设克隆得分之间相互独立，并且各群之间也相互独立。\n\n你的任务是设计依赖于群的分裂因子 $n_{g}$，以均衡每次历史记录中来自窗内每个群的方差贡献，同时满足一个指定的目标总单次历史方差 $V_{\\text{target}}$。上游截断权重为 $w_{c}=2.0$。能群概率和单位权重得分标准差如下：\n$$\np_{1}=0.4,\\quad p_{2}=0.35,\\quad p_{3}=0.25,\\qquad \\sigma_{1}=1.2,\\quad \\sigma_{2}=0.8,\\quad \\sigma_{3}=2.0.\n$$\n设来自窗的目标总单次历史方差为\n$$\nV_{\\text{target}}=0.5.\n$$\n在每个群对总方差贡献相等的平衡准则下，计算每次历史记录在窗内的期望分裂数，\n$$\nB \\equiv \\sum_{g=1}^{3} p_{g} n_{g}.\n$$\n将最终值表示为一个纯数，并将你的答案四舍五入到四位有效数字。",
            "solution": "用户要求我解决一个关于蒙特卡洛中子输运模拟中方差减少技术的问题。\n\n这是我的计划：\n1.  **验证问题陈述：** 我将根据我的内部验证标准，仔细检查问题。\n    *   **步骤1：提取已知条件：** 我将逐字列出所有给定的参数和关系。\n    *   **步骤2：验证：** 我将检查问题是否具有科学依据、适定、客观和完整。这似乎是蒙特卡洛方法中的一个标准问题，所以我预计它是有效的。\n    *   **步骤3：结论：** 基于验证，我将决定是继续还是宣布其无效。\n\n2.  **解决问题（如果有效）：** 假设问题是有效的，我将执行以下步骤：\n    *   **构建方差公式：** 我需要推导出来自窗的总单次历史方差的表达式，记为 $V$。此方差将是分裂因子 $n_g$ 的函数。\n    *   **分解过程：**\n        *   一个粒子到达窗。如果它在轮盘赌中存活，其权重为 $w_c$。问题陈述说“对于一个单位权重的粒子……”但随后又对其进行了缩放。让我们追踪一下权重。\n        *   问题陈述“在窗的上游，一个初始权重为 $w_{0}$ 的粒子以概率 $w_{0}/w_{c}$ 在俄罗斯轮盘赌中存活，如果存活，其权重被设置为 $w_{c}$”。这部分描述了到达窗*之前*的过程。当一个粒子*进入*窗时，其权重为 $w_c$。\n        *   在窗内，它以概率 $p_g$ 被分配到一个群 $G_g$。\n        *   进入群 $G_g$ 后，该粒子分裂成 $n_g$ 个克隆。\n        *   每个克隆的权重为 $w' = w_c / n_g$。\n        *   需要分析来自单个克隆的得分贡献。\n        *   问题说：“对于群 $G_{g}$ 中一个单位权重的粒子，其对探测器的得分贡献均值为零，标准差为 $\\sigma_{g}$”。设 $S_{g,1}$ 是来自单位权重粒子的得分。我们已知 $E[S_{g,1}] = 0$ 和 $\\text{Var}(S_{g,1}) = \\sigma_g^2$。\n        *   对于权重为 $w'$ 的粒子，得分是线性缩放的。设此得分为 $S_{g,w'}$。因此，$S_{g,w'} = w' S_{g,1}$。\n        *   来自一个克隆的得分均值为 $E[S_{g,w'}] = E[w' S_{g,1}] = w' E[S_{g,1}] = 0$。\n        *   来自一个克隆的得分方差为 $\\text{Var}(S_{g,w'}) = \\text{Var}(w' S_{g,1}) = (w')^2 \\text{Var}(S_{g,1}) = (w_c/n_g)^2 \\sigma_g^2$。这与问题陈述“方差按 $w^2 \\sigma_g^2$ 的比例缩放”相符。\n\n    *   **计算来自单个群的方差：**\n        *   如果一个粒子进入群 $G_g$，它会分裂成 $n_g$ 个克隆。\n        *   来自群 $G_g$ 的总得分（我们称之为 $S_g$）是来自 $n_g$ 个独立克隆的得分之和。\n        *   $S_g = \\sum_{i=1}^{n_g} S_{g,w', i}$，其中 $S_{g,w', i}$ 是来自第 $i$ 个克隆的得分。\n        *   来自群 $G_g$ 的期望总得分为 $E[S_g] = \\sum_{i=1}^{n_g} E[S_{g,w', i}] = \\sum_{i=1}^{n_g} 0 = 0$。\n        *   给定粒子进入了群 $G_g$，来自该群的总得分的方差为 $\\text{Var}(S_g | \\text{group } G_g)$。由于克隆是独立的：\n            $\\text{Var}(S_g) = \\sum_{i=1}^{n_g} \\text{Var}(S_{g,w', i}) = n_g \\times \\text{Var}(S_{g,w'}) = n_g \\left( \\frac{w_c}{n_g} \\right)^2 \\sigma_g^2 = \\frac{w_c^2 \\sigma_g^2}{n_g}$。\n        *   我们将此条件方差称为 $V_g = \\text{Var}(S_g | \\text{group } G_g) = \\frac{w_c^2 \\sigma_g^2}{n_g}$。\n\n    *   **计算来自窗的总单次历史方差：**\n        *   来自窗的总得分（我们称之为 $S_{\\text{window}}$）是一个随机变量。它以概率 $p_g$ 等于 $S_g$。\n        *   总方差由全方差公式给出：\n            $V_{\\text{total}} = \\text{Var}(S_{\\text{window}}) = E[\\text{Var}(S_{\\text{window}} | G)] + \\text{Var}(E[S_{\\text{window}} | G])$。\n            这里，$G$ 是表示群选择的随机变量。\n        *   $E[S_{\\text{window}} | G=G_g] = E[S_g] = 0$。所以，$E[S_{\\text{window}} | G]$ 总是 $0$，无论在哪个群。\n        *   因此，$\\text{Var}(E[S_{\\text{window}} | G]) = \\text{Var}(0) = 0$。\n        *   $\\text{Var}(S_{\\text{window}} | G=G_g) = V_g = \\frac{w_c^2 \\sigma_g^2}{n_g}$。\n        *   所以，$E[\\text{Var}(S_{\\text{window}} | G)] = \\sum_{g=1}^3 p_g \\text{Var}(S_{\\text{window}} | G=G_g) = \\sum_{g=1}^3 p_g V_g = \\sum_{g=1}^3 p_g \\frac{w_c^2 \\sigma_g^2}{n_g}$。\n        *   因此，来自窗的总单次历史方差为 $V = \\sum_{g=1}^3 p_g \\frac{w_c^2 \\sigma_g^2}{n_g}$。\n\n    *   **应用问题约束：**\n        *   **约束1：目标总方差。** 总方差必须等于 $V_{\\text{target}}$。\n            $V = \\sum_{g=1}^3 p_g \\frac{w_c^2 \\sigma_g^2}{n_g} = V_{\\text{target}}$。\n        *   **约束2：各群方差贡献相等。** 问题陈述的设计目标是“均衡每次历史记录中来自窗内每个群的方差贡献”。\n            这意味着构成总方差的求和项必须相等。\n            设 $V_{\\text{group}, g}$ 为来自群 $g$ 的贡献。\n            $V_{\\text{group}, g} = p_g \\frac{w_c^2 \\sigma_g^2}{n_g}$。\n            约束条件为 $V_{\\text{group}, 1} = V_{\\text{group}, 2} = V_{\\text{group}, 3}$。\n            我们称这个共同的贡献值为 $V_{\\text{contrib}}$。\n        *   由此，我们有 $p_1 \\frac{w_c^2 \\sigma_1^2}{n_1} = p_2 \\frac{w_c^2 \\sigma_2^2}{n_2} = p_3 \\frac{w_c^2 \\sigma_3^2}{n_3}$。\n        *   总方差是这些贡献之和：$V = V_{\\text{group}, 1} + V_{\\text{group}, 2} + V_{\\text{group}, 3} = 3 V_{\\text{contrib}}$。\n        *   因为我们已知 $V = V_{\\text{target}}$，所以有 $3 V_{\\text{contrib}} = V_{\\text{target}}$。\n        *   这意味着每个群的贡献必须是 $V_{\\text{contrib}} = \\frac{V_{\\text{target}}}{3}$。\n\n    *   **求解分裂因子 $n_g$：**\n        *   现在我可以为每个 $n_g$ 建立方程：\n            $p_g \\frac{w_c^2 \\sigma_g^2}{n_g} = \\frac{V_{\\text{target}}}{3}$。\n        *   解出 $n_g$：\n            $n_g = \\frac{3 p_g w_c^2 \\sigma_g^2}{V_{\\text{target}}}$。\n        *   这就得到了 $n_1, n_2, n_3$ 的表达式。\n        *   值得注意的是，在实际的蒙特卡洛代码中，$n_g$ 通常是整数，但问题没有说明这一点。它要求的是“期望分裂数”，这可以是非整数。在某些方差减少方案中，分裂因子 $n_g$ 本身可以是非整数（例如，分裂成 $\\lfloor n_g \\rfloor$ 个权重为一种值的粒子和一个权重为另一种值的粒子，保持期望粒子数为 $n_g$）。该问题似乎暗示 $n_g$ 可以是实数。我将基于这个假设继续，因为这是对所提出的连续优化问题的最自然解释。\n\n    *   **计算目标量：**\n        *   问题要求计算每次历史记录在窗内的期望分裂数 $B$。\n        *   定义已给出：$B \\equiv \\sum_{g=1}^{3} p_{g} n_{g}$。\n        *   我需要将我刚找到的 $n_g$ 的表达式代入这个和中。\n        *   $B = \\sum_{g=1}^3 p_g \\left( \\frac{3 p_g w_c^2 \\sigma_g^2}{V_{\\text{target}}} \\right)$。\n        *   $B = \\frac{3 w_c^2}{V_{\\text{target}}} \\sum_{g=1}^3 p_g^2 \\sigma_g^2$。\n\n    *   **代入数值：**\n        *   $w_c = 2.0$\n        *   $V_{\\text{target}} = 0.5$\n        *   $p_1 = 0.4, p_2 = 0.35, p_3 = 0.25$\n        *   $\\sigma_1 = 1.2, \\sigma_2 = 0.8, \\sigma_3 = 2.0$\n        *   $w_c^2 = 4.0$\n        *   $\\sigma_1^2 = 1.44$\n        *   $\\sigma_2^2 = 0.64$\n        *   $\\sigma_3^2 = 4.0$\n        *   首先，计算和 $\\sum p_g^2 \\sigma_g^2$：\n            *   第1群项: $(0.4)^2 \\times (1.2)^2 = 0.16 \\times 1.44 = 0.2304$\n            *   第2群项: $(0.35)^2 \\times (0.8)^2 = 0.1225 \\times 0.64 = 0.0784$\n            *   第3群项: $(0.25)^2 \\times (2.0)^2 = 0.0625 \\times 4.0 = 0.2500$\n            *   和 = $0.2304 + 0.0784 + 0.2500 = 0.5588$。\n        *   现在，计算 $B$：\n            *   $B = \\frac{3 \\times (2.0)^2}{0.5} \\times (0.5588)$\n            *   $B = \\frac{3 \\times 4.0}{0.5} \\times 0.5588$\n            *   $B = \\frac{12}{0.5} \\times 0.5588$\n            *   $B = 24 \\times 0.5588$\n        *   计算：\n            $24 \\times 0.5588 = 13.4112$\n\n    *   **最终答案格式化：**\n        *   问题要求将答案四舍五入到四位有效数字。\n        *   $13.4112$ 四舍五入到四位有效数字是 $13.41$。\n        *   最终答案应放在 `$$\\boxed{...}$$` 块中。\n\n3.  **复查和定稿：** 我将重读问题和我的解答，以确保一切都一致，并且我没有遗漏任何细节。\n\n    *   **自洽性检查：**\n        *   让我们计算 $n_g$ 的值。\n            $n_g = \\frac{3 p_g w_c^2 \\sigma_g^2}{V_{\\text{target}}} = \\frac{3 \\times 4}{0.5} p_g \\sigma_g^2 = 24 p_g \\sigma_g^2$。\n            *   $n_1 = 24 \\times 0.4 \\times (1.2)^2 = 24 \\times 0.4 \\times 1.44 = 9.6 \\times 1.44 = 13.824$。\n            *   $n_2 = 24 \\times 0.35 \\times (0.8)^2 = 24 \\times 0.35 \\times 0.64 = 8.4 \\times 0.64 = 5.376$。\n            *   $n_3 = 24 \\times 0.25 \\times (2.0)^2 = 24 \\times 0.25 \\times 4 = 6 \\times 4 = 24$。\n        *   现在检查每个群的方差贡献：$V_{\\text{group}, g} = p_g \\frac{w_c^2 \\sigma_g^2}{n_g}$。对于所有群，这应该等于 $V_{\\text{target}}/3 = 0.5/3 \\approx 0.1666...$。\n            *   $V_{\\text{group}, 1} = 0.4 \\times \\frac{4 \\times 1.44}{13.824} = 0.4 \\times \\frac{5.76}{13.824}$。注意 $13.824 = 24 \\times 0.4 \\times 1.44$。所以 $V_{\\text{group}, 1} = 0.4 \\times \\frac{4 \\times 1.44}{24 \\times 0.4 \\times 1.44} = \\frac{4}{24} = \\frac{1}{6}$。\n            *   $V_{\\text{group}, 2} = 0.35 \\times \\frac{4 \\times 0.64}{5.376} = 0.35 \\times \\frac{2.56}{5.376}$。注意 $5.376 = 24 \\times 0.35 \\times 0.64$。所以 $V_{\\text{group}, 2} = 0.35 \\times \\frac{4 \\times 0.64}{24 \\times 0.35 \\times 0.64} = \\frac{4}{24} = \\frac{1}{6}$。\n            *   $V_{\\text{group}, 3} = 0.25 \\times \\frac{4 \\times 4}{24} = 0.25 \\times \\frac{16}{24} = 0.25 \\times \\frac{2}{3} = \\frac{1}{4} \\times \\frac{2}{3} = \\frac{1}{6}$。\n            *   所有贡献都是 $1/6$。\n        *   总方差：$V = \\sum V_{\\text{group}, g} = 3 \\times (1/6) = 1/2 = 0.5$。这与 $V_{\\text{target}}$ 相符。逻辑是正确的。\n        *   现在计算 $B = \\sum p_g n_g$。\n            *   $B = p_1 n_1 + p_2 n_2 + p_3 n_3$\n            *   $B = 0.4 \\times 13.824 + 0.35 \\times 5.376 + 0.25 \\times 24$\n            *   $B = 5.5296 + 1.8816 + 6.0$\n            *   $B = 13.4112$。\n        *   这证实了我之前对 $B$ 的计算。推导 $B = \\frac{3 w_c^2}{V_{\\text{target}}} \\sum_{g=1}^3 p_g^2 \\sigma_g^2$ 是正确的并且更快。\n        *   四舍五入到四位有效数字得到 $13.41$。\n\n整个过程看起来很稳健。我准备好撰写解答了。我将从验证步骤开始。\n\n**问题验证**\n\n**步骤1：提取已知条件**\n-   模拟类型：蒙特卡洛（MC）中子输运。\n-   目标：估算点探测器响应。\n-   方差减少：权重轮盘赌和能量相关的分裂。\n-   分裂位置：探测器周围的薄球壳（“窗”）。\n-   探测器计分：与粒子权重成线性关系，是每个克隆独立贡献的总和。\n-   上游轮盘赌：权重为 $w_0$ 的粒子以概率 $w_0/w_c$ 存活。如果存活，其新权重为 $w_c$。\n-   窗内过程：\n    -   进入的粒子权重为 $w_c$。\n    -   能量被划分为三个群 $G_1, G_2, G_3$。\n    -   粒子进入群 $G_g$ 的概率为 $p_g$。\n    -   在群 $G_g$ 中，粒子分裂成 $n_g$ 个独立的克隆。\n    -   群 $G_g$ 中的每个克隆权重为 $w_c/n_g$。\n-   得分统计：\n    -   对于 $G_g$ 中的单位权重粒子，得分贡献的均值为 $0$，标准差为 $\\sigma_g$。\n    -   对于权重为 $w$ 的粒子，方差按 $w^2 \\sigma_g^2$ 的比例缩放。\n-   假设：克隆得分的独立性和各群之间的独立性。\n-   设计任务：选择 $n_g$ 以均衡每个群的单次历史方差贡献。\n-   约束：来自窗的总单次历史方差 $V_{\\text{target}} = 0.5$。\n-   常数：\n    -   上游截断权重：$w_c = 2.0$。\n    -   群概率：$p_1=0.4, p_2=0.35, p_3=0.25$。\n    -   单位权重标准差：$\\sigma_1=1.2, \\sigma_2=0.8, \\sigma_3=2.0$。\n-   待计算量：每次历史记录在窗内的期望分裂数，$B \\equiv \\sum_{g=1}^{3} p_{g} n_{g}$。\n-   输出格式：纯数，四舍五入到四位有效数字。\n\n**步骤2：使用提取的已知条件进行验证**\n-   **科学性**：该问题描述了蒙特卡洛粒子输运模拟中使用的标准方差减少技术（俄罗斯轮盘赌、分裂），这是核工程和计算物理学的核心课题。粒子权重、计分、方差及其操纵的概念是该领域的基础。该设置在科学上是合理的。\n-   **适定性**：问题提供了所有必要的数据，并定义了一个清晰的目标和足够的约束，以确定分裂因子 $n_g$ 的唯一解，并因此确定量 $B$。平衡准则（“均衡每个历史方差贡献”）和总方差约束（$V_{\\text{target}}$）定义了一个可解的方程组。\n-   **客观性**：问题使用物理和工程学中常见的精确、形式化的语言陈述。所有术语在蒙特卡洛方法的背景下都有明确的定义。没有主观或基于意见的内容。\n-   **完整性和一致性**：给出的条件是充分且一致的。例如，群概率之和为一：$0.4 + 0.35 + 0.25 = 1.0$。权重、分裂和方差之间的关系被清晰地阐述，并且与蒙特卡洛估计量的理论一致。\n-   **现实性**：参数和场景对于反应堆物理学中的一个程式化学术问题来说是合理的。使用权重窗和能量相关的方差减少是一种实用且重要的技术。\n-   **结构性**：问题结构良好，引导求解者从物理原理到具体的数值计算。它不是琐碎或循环论证的。\n\n**步骤3：结论和行动**\n-   **结论**：问题是**有效的**。这是一个在核反应堆模拟领域中适定的、有科学依据的问题。\n-   **行动**：继续解决问题。\n\n一切看起来都很好。我现在将以要求的格式写出完整的解答。我将细致地对每个数学实体使用LaTeX。",
            "answer": "$$\\boxed{13.41}$$"
        },
        {
            "introduction": "确定了理想的分裂比后，一个实际问题随之而来：我们如何从一个可能是非整数的比率中生成整数数量的粒子，同时不引入偏差？本练习介绍了随机取整这一基本技术，该方法能够保持期望粒子数不变。您将分析这种取整对总方差的影响，从而更深入地理解在分裂算法的实际执行中固有的权衡 。",
            "id": "4260739",
            "problem": "在核反应堆模拟的蒙特卡洛（MC）粒子输运中，使用权重分裂来控制方差：一个分裂前权重为 $W$ 的粒子被 $N$ 个相同的后代粒子替换，每个后代粒子的权重为 $W_{\\text{tgt}}$，其中 $N$ 是通过对比例 $\\rho = W / W_{\\text{tgt}}$ 进行随机取整来选择的。具体来说，如果对于某个整数 $k$，有 $\\rho \\in [k, k+1)$，则以概率 $f = \\rho - k$ 设 $N = k+1$，以概率 $1 - f$ 设 $N = k$。这种“轮盘赌与分裂”规则被广泛用于在蒙特卡洛统计中保持无偏性。\n\n假设 $W$ 是一个均值为 $\\mu$、方差为 $\\sigma^{2}$ 的随机变量，并且 $\\sigma$ 相对于 $W_{\\text{tgt}}$ 足够小，使得 $\\rho$ 的小数部分以高概率集中而不会跨越整数边界。使用条件期望和全方差定律的基本原理，结合德尔塔方法，推导分裂后总权重 $T = N W_{\\text{tgt}}$ 的无条件方差的主阶近似。\n\n对于具体情况 $W \\sim \\mathcal{N}(\\mu, \\sigma^{2})$，其中 $\\mu = 1.7$ 且 $\\sigma^{2} = 5.0 \\times 10^{-3}$，并且 $W_{\\text{tgt}} = 0.5$，计算 $\\operatorname{Var}(T)$ 的德尔塔方法近似值。将最终数值答案四舍五入至四位有效数字，并报告结果，不带单位。",
            "solution": "我们从蒙特卡洛（MC）粒子输运中的标准权重分裂原理开始：分裂的构造是为了通过适当的随机取整来保持期望总权重。令 $W$ 表示分裂前权重，$W_{\\text{tgt}}$ 表示目标后代权重，$\\rho = W / W_{\\text{tgt}}$，以及 $N$ 表示由随机取整决定的整数分裂数：\n- 如果对于整数 $k$，有 $\\rho \\in [k, k+1)$，定义小数部分 $f = \\rho - k \\in [0,1)$。\n- 以概率 $f$ 设 $N = k+1$，以概率 $1 - f$ 设 $N = k$。\n\n定义分裂后总权重 $T = N W_{\\text{tgt}}$。我们将首先证明其无偏性，然后使用德尔塔方法推导 $\\operatorname{Var}(T)$ 的主阶近似。\n\n无偏性可以从随机取整的定义中得出：\n\n$$\n\\mathbb{E}[N \\mid W] = (k+1) f + k (1 - f) = k + f = \\rho = \\frac{W}{W_{\\text{tgt}}}.\n$$\n\n因此，\n\n$$\n\\mathbb{E}[T \\mid W] = \\mathbb{E}[N W_{\\text{tgt}} \\mid W] = W_{\\text{tgt}} \\, \\mathbb{E}[N \\mid W] = W,\n$$\n\n由此可得\n\n$$\n\\mathbb{E}[T] = \\mathbb{E}\\big[ \\mathbb{E}[T \\mid W] \\big] = \\mathbb{E}[W] = \\mu,\n$$\n\n证明了无偏性。\n\n为了分析方差，我们使用全方差定律：\n\n$$\n\\operatorname{Var}(T) = \\operatorname{Var}\\big( \\mathbb{E}[T \\mid W] \\big) + \\mathbb{E}\\big[ \\operatorname{Var}(T \\mid W) \\big].\n$$\n\n由 $\\mathbb{E}[T \\mid W] = W$ 可得\n\n$$\n\\operatorname{Var}\\big( \\mathbb{E}[T \\mid W] \\big) = \\operatorname{Var}(W) = \\sigma^{2}.\n$$\n\n此外，由于 $T \\mid W = N W_{\\text{tgt}}$ 且 $N \\mid W$ 是一个在 $k$ 和 $k+1$ 之间的伯努利混合，成功概率为 $f$，我们有\n\n$$\n\\operatorname{Var}(N \\mid W) = f (1 - f),\n$$\n\n因此\n\n$$\n\\operatorname{Var}(T \\mid W) = W_{\\text{tgt}}^{2} \\, \\operatorname{Var}(N \\mid W) = W_{\\text{tgt}}^{2} f(1 - f).\n$$\n\n合并起来，\n\n$$\n\\operatorname{Var}(T) = \\sigma^{2} + \\mathbb{E}\\big[ W_{\\text{tgt}}^{2} f(1 - f) \\big] = \\sigma^{2} + W_{\\text{tgt}}^{2} \\, \\mathbb{E}\\big[ f(1 - f) \\big].\n$$\n\n\n现在我们应用德尔塔方法来近似 $\\mathbb{E}[ f(1 - f) ]$，当 $\\sigma$ 相对于 $W_{\\text{tgt}}$ 很小时。令 $\\rho = W / W_{\\text{tgt}}$，并用 $\\phi$ 表示平均比率 $\\mu / W_{\\text{tgt}}$ 的小数部分：\n\n$$\n\\phi = \\left\\{ \\frac{\\mu}{W_{\\text{tgt}}} \\right\\} \\in [0,1).\n$$\n\n当波动小到足以忽略跨越整数边界的环绕效应时，小数部分 $f$ 可以局部参数化为\n\n$$\nf \\approx \\phi + Z, \\quad Z = \\frac{W - \\mu}{W_{\\text{tgt}}}.\n$$\n\n在 $W \\sim \\mathcal{N}(\\mu, \\sigma^{2})$ 的条件下，我们有 $Z \\sim \\mathcal{N}(0, \\sigma^{2} / W_{\\text{tgt}}^{2})$。定义 $g(u) = u(1 - u) = u - u^{2}$。那么\n\n$$\n\\mathbb{E}[ f(1 - f) ] \\approx \\mathbb{E}[ g(\\phi + Z) ].\n$$\n\n二阶德尔塔方法给出\n\n$$\n\\mathbb{E}[ g(\\phi + Z) ] \\approx g(\\phi) + \\frac{1}{2} g''(\\phi) \\operatorname{Var}(Z),\n$$\n\n因为 $\\mathbb{E}[Z] = 0$。由于 $g'(u) = 1 - 2u$ 且 $g''(u) = -2$，我们得到\n\n$$\n\\mathbb{E}[ f(1 - f) ] \\approx \\phi(1 - \\phi) - \\operatorname{Var}(Z) = \\phi(1 - \\phi) - \\frac{\\sigma^{2}}{W_{\\text{tgt}}^{2}}.\n$$\n\n代回到全方差定律中，\n\n$$\n\\operatorname{Var}(T) \\approx \\sigma^{2} + W_{\\text{tgt}}^{2} \\left( \\phi(1 - \\phi) - \\frac{\\sigma^{2}}{W_{\\text{tgt}}^{2}} \\right) = W_{\\text{tgt}}^{2} \\, \\phi(1 - \\phi).\n$$\n\n因此，在无环绕假设下，到主阶为止，分裂后总权重的无条件方差取决于 $W_{\\text{tgt}}$ 和 $\\mu / W_{\\text{tgt}}$ 的小数部分，并且在此阶上与 $\\sigma$ 无关。\n\n我们现在对给定的数值参数进行计算。当 $\\mu = 1.7$ 和 $W_{\\text{tgt}} = 0.5$ 时，\n\n$$\n\\frac{\\mu}{W_{\\text{tgt}}} = \\frac{1.7}{0.5} = 3.4, \\quad \\phi = \\{ 3.4 \\} = 0.4.\n$$\n\n因此，\n\n$$\n\\operatorname{Var}(T) \\approx W_{\\text{tgt}}^{2} \\, \\phi(1 - \\phi) = (0.5)^{2} \\times 0.4 \\times 0.6 = 0.25 \\times 0.24 = 0.06.\n$$\n\n考虑到较小的 $\\sigma$ 以及 $\\phi = 0.4$ 与最近整数边界的距离，环绕的概率，\n\n$$\n\\mathbb{P}\\big( |Z|  \\min\\{\\phi, 1 - \\phi\\} \\big) = \\mathbb{P}\\big( |Z|  0.4 \\big),\n$$\n\n其中 $Z \\sim \\mathcal{N}\\!\\left(0, \\sigma^{2} / W_{\\text{tgt}}^{2}\\right)$ 且 $\\sigma^{2} / W_{\\text{tgt}}^{2} = (5.0 \\times 10^{-3}) / (0.5)^{2} = 0.02$，这个概率很小（约为 $10^{-3}$ 量级），这为德尔塔方法的近似提供了依据。\n\n最后，四舍五入到四位有效数字，近似的无条件方差为 $0.06000$。",
            "answer": "$$\\boxed{0.06000}$$"
        },
        {
            "introduction": "一个理论上完美的算法，如果在执行时不够谨慎，也可能失败，尤其是在处理计算机算术的局限性时。本问题探讨了有限精度的浮点运算如何给轮盘赌算法引入微妙的偏差，从而破坏其无偏性的核心保证。通过分析这些数值误差的来源，您将理解设计数值稳定算法对于确保模拟结果可靠性的重要性 。",
            "id": "4260721",
            "problem": "用于核反应堆分析的蒙特卡洛（MC）中子输运模拟使用权重窗，通过俄罗斯轮盘赌（Russian roulette）和分裂（splitting）来控制方差。设一个权重为 $w$ 的粒子进入一个权重窗下限为 $w_{L}$、上限为 $w_{U}$ 的单元。方差缩减策略为：如果 $w  w_{L}$，则应用俄罗斯轮盘赌；如果 $w  w_{U}$，则应用分裂；否则保持权重不变。对于任何线性统计量，无偏性要求是调整后的期望总权重等于调整前的权重。\n\n假设算术运算在有限精度浮点数下进行，遵循单位舍入误差为 $u$ 的电气和电子工程师协会（IEEE）“舍入到最近”模型。每当执行一次基本算术运算，其计算结果 $\\mathrm{fl}(\\cdot)$ 被建模为 $\\mathrm{fl}(x) = x (1 + \\delta)$，其中 $|\\delta| \\le u$，并且在主阶上，不同运算的 $\\delta$ 被视为独立的。具体考虑俄罗斯轮盘赌分支：一种朴素的实现计算存活概率为 $\\hat{p} = \\mathrm{fl}(w / w_{L})$，并且在存活时，将存活粒子的权重设为 $\\hat{w}_{L} = \\mathrm{fl}(w_{L})$；否则，粒子被杀死，权重变为 $0$。实际的存活事件是概率为 $\\hat{p}$ 的伯努利事件。\n\n从无舍入的轮盘赌无偏性原理以及上面给出的浮点舍入模型出发，推导由这两次舍入引起的、轮盘赌后期望权重相对于 $w$ 的偏差 $b$ 的主阶（关于 $u$）解析表达式，其中 $b$ 定义为\n$$\nb \\equiv \\mathbb{E}[\\hat{W}] - w,\n$$\n且 $\\hat{W}$ 是由朴素实现产生的轮盘赌后权重。你的答案需用 $w$、计算 $\\hat{p}$ 时的除法舍入误差 $\\delta_{p}$ 以及计算 $\\hat{w}_{L}$ 时的舍入误差 $\\delta_{L}$ 的闭式形式表示。除了有界性 $|\\delta_{p}| \\le u$ 和 $|\\delta_{L}| \\le u$ 之外，不要对 $\\delta_{p}$ 或 $\\delta_{L}$ 作任何特殊分布的假设。\n\n此外，（在你的推导中定性地）讨论极端的比率 $r = w / w_{L}$ 和 $w / w_{U}$ 如何影响数值稳定性和无偏性，并为非常小或非常大的 $r$ 提出能在保持无偏的同时减轻下溢或上溢风险的公式。你的最终答案必须是上面推导出的关于 $b$ 的单一闭式表达式。最终表达式无需舍入，最终答案中也不应包含任何单位。",
            "solution": "问题要求分析在蒙特卡洛模拟中，一种朴素的俄罗斯轮盘赌方差缩减技术的浮点实现所引入的数值偏差。我们将首先在指定的舍入模型下推导偏差的表达式，然后讨论数值精度对此类算法的更广泛影响。\n\n首先，让我们回顾一下在理想算术下的无偏俄罗斯轮盘赌原理。一个权重为 $w$ 的粒子，因其权重低于阈值 $w_{L}$（$w  w_{L}$）而受到轮盘赌，它以概率 $p = w/w_{L}$ 存活下来。存活后，其新权重变为 $w_{L}$。此过程后的期望权重 $\\mathbb{E}[W]$ 为：\n$$\n\\mathbb{E}[W] = (w_{L} \\times p) + (0 \\times (1-p)) = w_{L} \\times \\left(\\frac{w}{w_{L}}\\right) = w\n$$\n由于游戏后的期望权重等于初始权重，该过程是无偏的。这是确保模拟结果在统计上正确的关键属性。\n\n现在，我们使用有限精度浮点算术来分析这种朴素的实现。问题为浮点运算 $\\mathrm{fl}(\\cdot)$ 提供了一个模型，即 $\\mathrm{fl}(x) = x(1+\\delta)$，其中对于某个单位舍入误差 $u$，有 $|\\delta| \\le u$。在这种朴素实现中，我们面临两个舍入误差来源：\n\n1.  存活概率 $\\hat{p}$ 的计算：\n$$\n\\hat{p} = \\mathrm{fl}\\left(\\frac{w}{w_{L}}\\right) = \\frac{w}{w_{L}}(1 + \\delta_{p})\n$$\n其中 $\\delta_{p}$ 是此除法的相对舍入误差，且 $|\\delta_{p}| \\le u$。\n\n2.  存活后新权重 $\\hat{w}_{L}$ 的表示：\n$$\n\\hat{w}_{L} = \\mathrm{fl}(w_{L}) = w_{L}(1 + \\delta_{L})\n$$\n其中 $\\delta_{L}$ 是表示或加载值 $w_{L}$ 的相对舍入误差，且 $|\\delta_{L}| \\le u$。注意，如果 $w_L$ 已经是一个可以精确表示的浮点数，那么 $\\delta_L$ 将为 $0$。但是，我们必须遵循所提供的一般模型。\n\n轮盘赌后的权重 $\\hat{W}$ 是一个随机变量，它以概率 $\\hat{p}$ 取值 $\\hat{w}_{L}$，以概率 $1-\\hat{p}$ 取值 $0$。因此，轮盘赌后的期望权重 $\\mathbb{E}[\\hat{W}]$ 为：\n$$\n\\mathbb{E}[\\hat{W}] = \\hat{w}_{L} \\times \\hat{p}\n$$\n将浮点模型中 $\\hat{w}_{L}$ 和 $\\hat{p}$ 的表达式代入：\n$$\n\\mathbb{E}[\\hat{W}] = \\left[ w_{L}(1 + \\delta_{L}) \\right] \\times \\left[ \\frac{w}{w_{L}}(1 + \\delta_{p}) \\right]\n$$\n我们可以通过消去 $w_{L}$ 项来简化此表达式：\n$$\n\\mathbb{E}[\\hat{W}] = w (1 + \\delta_{L})(1 + \\delta_{p})\n$$\n展开括号中的项可得：\n$$\n\\mathbb{E}[\\hat{W}] = w (1 + \\delta_{p} + \\delta_{L} + \\delta_{p}\\delta_{L})\n$$\n问题要求偏差的主阶表达式。误差 $\\delta_{p}$ 和 $\\delta_{L}$ 是单位舍入误差 $u$ 的量级。因此，它们的乘积 $\\delta_{p}\\delta_{L}$ 是 $u^2$ 量级，在一阶分析中可以忽略。期望权重的主阶近似为：\n$$\n\\mathbb{E}[\\hat{W}] \\approx w (1 + \\delta_{p} + \\delta_{L})\n$$\n偏差 $b$ 定义为轮盘赌后的期望权重与原始权重 $w$ 之间的差值：\n$$\nb \\equiv \\mathbb{E}[\\hat{W}] - w\n$$\n代入我们对 $\\mathbb{E}[\\hat{W}]$ 的近似值：\n$$\nb \\approx w(1 + \\delta_{p} + \\delta_{L}) - w\n$$\n$$\nb \\approx w + w\\delta_{p} + w\\delta_{L} - w\n$$\n这简化为主阶偏差的最终表达式：\n$$\nb \\approx w(\\delta_{p} + \\delta_{L})\n$$\n这个结果表明，偏差与粒子的初始权重以及来自除法和权重下限表示的相对舍入误差之和成正比。由于 $\\delta_p$ 和 $\\delta_L$ 可以是正的也可以是负的，偏差可以是正的或负的，但其量级由大约 $2wu$ 界定。这个偏差对于单个事件来说虽然很小，但它可以在许多粒子历史和代中累积，从而可能扭曲最终的模拟结果。\n\n问题还要求对数值稳定性进行定性讨论。比率 $r = w/w_L$ 是俄罗斯轮盘赌的核心。如果 $r$ 极小（即 $w \\ll w_L$），计算出的存活概率 $\\hat{p} = \\mathrm{fl}(w/w_L)$ 有下溢到恰好为 $0$ 的风险。如果 $\\hat{p}=0$，粒子将被确定性地杀死，从而引入一个 $-w$ 的系统性负偏差。这在需要模拟粒子深度穿透衰减介质的问题中是有害的，因为它系统性地消除了携带重要信息的低权重粒子。\n\n相反，对于分裂，其中 $r = w/w_U  1$，一个非常大的比率本身通常不会造成上溢风险，但这确实意味着一个粒子被分裂成非常大量的子粒子。这在计算上可能代价高昂，并可能导致内存问题，这种现象有时被称为“权重尖峰”。\n\n为了减轻这些问题并保持无偏性，需要更稳健的公式。朴素方法中的偏差之所以产生，是因为在理想理论公式中 $w_L$ 的抵消在浮点实现中并未发生，即 $\\mathrm{fl}(w_L) \\times \\mathrm{fl}(w/w_L) \\ne w$。一种更优越的方法，通常称为“权重抵消”，旨在在浮点算术内部强制执行无偏条件 $p \\times w_{\\text{new}} = w$。一种改进的轮盘赌算法将是：\n1. 计算存活概率：$\\hat{p} = \\mathrm{fl}(w/w_L)$。\n2. 如果一个随机数 $\\xi \\in [0,1)$ 小于 $\\hat{p}$，则粒子存活。\n3. 新的权重 $\\hat{w}_{\\text{new}}$ 不被设置为 $\\mathrm{fl}(w_L)$，而是 $\\hat{w}_{\\text{new}} = \\mathrm{fl}(w/\\hat{p})$。\n\n让我们分析这种改进算法的期望权重。设 $\\delta_1$ 是计算 $\\hat{p}$ 时的误差，$\\delta_2$ 是计算 $\\hat{w}_{\\text{new}}$ 时的误差。\n$$ \\mathbb{E}[\\hat{W}] = \\hat{p} \\times \\hat{w}_{\\text{new}} = \\hat{p} \\times \\mathrm{fl}\\left(\\frac{w}{\\hat{p}}\\right) = \\hat{p} \\times \\left(\\frac{w}{\\hat{p}}(1+\\delta_2)\\right) = w(1+\\delta_2) $$\n现在偏差为 $b \\approx w\\delta_2$。这个公式并非完全无偏，但偏差现在只取决于来自最终除法的单个舍入误差，而不是两个可能复合的误差之和。这通常更稳健。然而，这种方法有一个致命的失效模式：如果 $w/w_L$ 小到使 $\\hat{p}$ 下溢为零，那么 $\\hat{w}_{\\text{new}}$ 的计算将涉及除以零，导致致命错误。因此，实际的实现必须包含对此条件的检查并进行处理，例如，在极端情况下杀死粒子并接受由此产生的偏差。\n\n对于分裂，一种类似稳健、近乎无偏的方法是整数分裂。如果一个粒子的权重 $w  w_U$，则计算期望的粒子数 $N_{\\text{split}} = w/w_U$。然后创建整数个粒子 $N$，使得 $\\mathbb{E}[N] = N_{\\text{split}}$（例如，对于一个随机数 $\\xi \\in [0,1)$，$N = \\lfloor N_{\\text{split}} + \\xi \\rfloor$）。这 $N$ 个粒子中的每一个随后被赋予新的权重 $w_{\\text{new}} = w/N$。分裂后的期望总权重为 $\\mathbb{E}[N \\times w_{\\text{new}}] = \\mathbb{E}[N \\times (w/N)] = w$，在理想算术中保持了无偏性。浮点实现 $\\hat{w}_{\\text{new}} = \\mathrm{fl}(w/N)$ 会引入一个小的偏差，但同样，它通常比朴素方案中的偏差更小且更可控。",
            "answer": "$$\n\\boxed{w(\\delta_{p} + \\delta_{L})}\n$$"
        }
    ]
}