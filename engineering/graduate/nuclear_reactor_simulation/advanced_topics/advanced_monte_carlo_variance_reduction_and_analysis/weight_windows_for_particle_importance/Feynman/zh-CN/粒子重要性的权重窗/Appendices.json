{
    "hands_on_practices": [
        {
            "introduction": "俄式轮盘赌是管理低权重粒子的关键过程，本练习旨在探究其内在机制。通过比较单步权重调整与多阶段调整策略，您将推导出生存概率和预期计算成本，从而深入理解这种无偏权重调整技术中固有的权衡关系 。这种分析对于设计高效的方差缩减方案至关重要。",
            "id": "4260955",
            "problem": "在使用权重窗的蒙特卡罗 (MC) 中子输运中，权重 $w_0$ 低于目标下限 $w_T$ 的低权重粒子通常使用俄罗斯轮盘赌进行调整，以保持无偏性。考虑一个权重为 $w_0$ 且满足 $0  w_0  w_T$ 的中子进入一个低重要性区域。在保持无偏性的前提下，有两种策略可用于将其权重提升至 $w_T$。\n\n策略 A (直接重新赋值)：应用单次俄罗斯轮盘赌操作，该操作要么杀死粒子，要么将其权重直接提升到 $w_T$。\n\n策略 B (多阶段重新赋值)：通过一个由中间目标 $w_1, w_2, \\ldots, w_m$ 构成的几何阶梯，应用 $m$ 次连续的俄罗斯轮盘赌操作。其中 $w_i = w_0 \\gamma^i$ 且 $w_m = w_T$，而 $\\gamma = \\left(\\frac{w_T}{w_0}\\right)^{\\frac{1}{m}}$。在每个阶段 $i \\in \\{1,2,\\ldots,m\\}$，粒子要么死亡，要么其权重从 $w_{i-1}$ 提升到 $w_i$。每次轮盘赌检验的期望计算成本为单位1，与结果无关。如果粒子在某个阶段死亡，则不再尝试后续阶段。直接重新赋值（策略A）使用单次轮盘赌检验，因此其期望计算成本为单位1。\n\n仅从每个阶段操作后的期望权重必须等于操作前的权重的无偏性要求出发，完成以下任务：\n\n1. 推导阶段存活概率作为对 $(w_{i-1}, w_i)$ 的函数，然后推导策略 B 下的总存活概率 $p_m$。\n2. 计算策略 B 下轮盘赌检验的期望次数，并表示其相对于策略 A 的期望计算功。\n3. 为简洁起见，定义 $r = \\frac{w_0}{w_T}$，并令 $J(m)$ 表示总存活概率与相对期望功的乘积，即 $J(m) = p_m \\times \\left(\\text{策略 B 相对于策略 A 的相对期望功}\\right)$。\n\n提供 $J(m)$ 关于 $r$ 和 $m$ 的闭式表达式。无需数值舍入，也不涉及单位。最终答案仅用 $r$ 和 $m$ 表示。",
            "solution": "经评估，问题陈述是有效的，因为它在科学上基于蒙特卡罗粒子输运的原理，信息充分且一致，表述良好，并以客观、正式的语言表达。陈述中没有矛盾、歧义或事实性错误。因此，我们可以着手求解。\n\n问题要求给出量 $J(m)$ 的闭式表达式，该量定义为多阶段俄罗斯轮盘赌方案（策略 B）下的总存活概率与该方案相对于单阶段方案（策略 A）的期望计算功的乘积。推导过程如问题陈述中所述，分为三个部分。\n\n**1. 存活概率的推导**\n\n我们首先考虑俄罗斯轮盘赌过程中的单个通用阶段 $i$，其中一个权重为 $w_{i-1}$ 的粒子被提升到更高的权重 $w_i$。设 $p_{\\text{stage}, i}$ 为粒子“存活”此阶段的概率。如果存活，其新权重为 $w_i$。如果不存活（概率为 $1 - p_{\\text{stage}, i}$），则粒子被“杀死”，其权重变为 $0$。\n\n该过程必须是无偏的，即操作后的期望权重必须等于操作前的权重。这是任何方差缩减技术（如俄罗斯轮盘赌）的基本要求。\n期望权重 $E[w_{\\text{after}}]$ 由下式给出：\n$$E[w_{\\text{after}}] = p_{\\text{stage}, i} \\cdot w_i + (1 - p_{\\text{stage}, i}) \\cdot 0$$\n将此等式与操作前权重 $w_{\\text{before}} = w_{i-1}$ 相等：\n$$p_{\\text{stage}, i} \\cdot w_i = w_{i-1}$$\n求解阶段存活概率，得：\n$$p_{\\text{stage}, i} = \\frac{w_{i-1}}{w_i}$$\n对于策略 B，一个粒子必须连续存活 $m$ 个阶段，才能成功地从初始权重 $w_0$ 提升到最终目标权重 $w_m = w_T$。总存活概率 $p_m$ 是各个阶段存活概率的乘积，因为在第 $i-1$ 阶段存活是尝试第 $i$ 阶段的先决条件。\n$$p_m = \\prod_{i=1}^{m} p_{\\text{stage}, i} = \\prod_{i=1}^{m} \\frac{w_{i-1}}{w_i}$$\n这是一个伸缩积：\n$$p_m = \\left(\\frac{w_0}{w_1}\\right) \\cdot \\left(\\frac{w_1}{w_2}\\right) \\cdot \\ldots \\cdot \\left(\\frac{w_{m-1}}{w_m}\\right) = \\frac{w_0}{w_m}$$\n鉴于最终目标权重为 $w_m = w_T$，总存活概率为：\n$$p_m = \\frac{w_0}{w_T}$$\n使用问题中的定义 $r = \\frac{w_0}{w_T}$，我们发现总存活概率即为：\n$$p_m = r$$\n\n**2. 相对期望功的推导**\n\n计算功由所执行的轮盘赌检验次数来衡量。策略 A 只涉及一次检验，因此其期望计算功为 $E[C_A] = 1$。\n\n对于策略 B，当且仅当粒子在前 $i-1$ 个阶段全部存活时，才会在阶段 $i$ 进行检验。此事件的概率为：\n$$P(\\text{到达阶段 } i) = \\prod_{j=1}^{i-1} p_{\\text{stage}, j} = \\prod_{j=1}^{i-1} \\frac{w_{j-1}}{w_j} = \\frac{w_0}{w_{i-1}}$$\n对于第一阶段（$i=1$），该乘积为空积，取值为 1，因此 $P(\\text{到达阶段 } 1) = \\frac{w_0}{w_0} = 1$，这是正确的，因为第一次检验总是会进行。\n\n策略 B 的总期望检验次数 $E[C_B]$ 是在每个阶段执行检验的概率之和：\n$$E[C_B] = \\sum_{i=1}^{m} P(\\text{到达阶段 } i) = \\sum_{i=1}^{m} \\frac{w_0}{w_{i-1}}$$\n根据中间权重的定义 $w_i = w_0 \\gamma^i$，我们有 $w_{i-1} = w_0 \\gamma^{i-1}$。将此代入求和式中：\n$$E[C_B] = \\sum_{i=1}^{m} \\frac{w_0}{w_0 \\gamma^{i-1}} = \\sum_{i=1}^{m} \\left(\\frac{1}{\\gamma}\\right)^{i-1}$$\n这是一个包含 $m$ 项的有限几何级数，其首项 $a=1$，公比 $q = \\frac{1}{\\gamma}$。其和由公式 $\\frac{a(1-q^m)}{1-q}$ 给出。\n$$E[C_B] = \\frac{1 \\cdot \\left(1 - \\left(\\frac{1}{\\gamma}\\right)^m\\right)}{1 - \\frac{1}{\\gamma}} = \\frac{1 - \\gamma^{-m}}{1 - \\gamma^{-1}}$$\n现在，我们使用 $\\gamma$ 的定义 $\\gamma = \\left(\\frac{w_T}{w_0}\\right)^{\\frac{1}{m}}$。用 $r = \\frac{w_0}{w_T}$ 表示，我们有 $\\gamma = \\left(\\frac{1}{r}\\right)^{\\frac{1}{m}} = r^{-\\frac{1}{m}}$。\n由此，我们求得表达式 $E[C_B]$ 中所需的各项：\n$$\\gamma^{-1} = \\left(r^{-\\frac{1}{m}}\\right)^{-1} = r^{\\frac{1}{m}}$$\n$$\\gamma^{-m} = \\left(r^{-\\frac{1}{m}}\\right)^{-m} = r$$\n将这些代入 $E[C_B]$ 的表达式中：\n$$E[C_B] = \\frac{1-r}{1 - r^{\\frac{1}{m}}}$$\n策略 B 相对于策略 A 的相对期望功是它们期望成本的比率：\n$$\\text{相对期望功} = \\frac{E[C_B]}{E[C_A]} = \\frac{ \\frac{1-r}{1 - r^{\\frac{1}{m}}} }{1} = \\frac{1-r}{1 - r^{\\frac{1}{m}}}$$\n\n**3. $J(m)$ 的最终表达式**\n\n问题将 $J(m)$ 定义为总存活概率 $p_m$ 与相对期望功的乘积。\n$$J(m) = p_m \\times (\\text{相对期望功})$$\n代入前面部分推导出的表达式：\n$$J(m) = r \\cdot \\left(\\frac{1-r}{1 - r^{\\frac{1}{m}}}\\right)$$\n这就得出了最终的闭式表达式：\n$$J(m) = \\frac{r(1-r)}{1 - r^{\\frac{1}{m}}}$$",
            "answer": "$$\n\\boxed{\\frac{r(1-r)}{1 - r^{\\frac{1}{m}}}}\n$$"
        },
        {
            "introduction": "在理解了单个权重调整的机制后，本练习将考察粒子分裂和俄式轮盘赌对整个粒子布居的集体效应。您将为一个给定的权重窗和粒子权重统计分布计算期望分支因子 $B$，这对预测模拟的稳定性和效率至关重要。该练习将微观规则与模拟的宏观行为联系起来 。",
            "id": "4260917",
            "problem": "在核反应堆模拟中，一种用于中子输运的蒙特卡洛（MC）权重窗方差缩减方案根据目标粒子权重来实施分裂和俄罗斯轮盘赌。设入射粒子权重为 $W$，定义无量纲比率 $X = W / w_T$，其中 $w_T$ 是目标权重。设定一个权重窗，其下界为 $w_L = \\frac{w_T}{2}$，上界为 $w_U = 2 w_T$。分裂和俄罗斯轮盘赌的规则如下：\n\n- 如果 $X  \\frac{w_U}{w_T} = 2$，则执行无偏分裂，使得子代粒子的期望数量等于 $X$，并且出射总权重的期望值等于 $W$。一种无偏的实现方式是随机取整，它能在不偏倚期望权重的情况下实现期望多重性 $X$。\n- 如果 $X  \\frac{w_L}{w_T} = \\frac{1}{2}$，则执行俄罗斯轮盘赌，存活概率为 $p = X$。如果粒子存活，其权重提升至 $w_T$；否则，该粒子被终止。\n- 如果 $\\frac{1}{2} \\leq X \\leq 2$，则不应用分裂或轮盘赌，粒子以其当前权重继续。\n\n假设 $X$ 服从对数正态分布，参数为 $\\mu = 0$ 和 $\\sigma = 0.5$；等价地，$Y = \\ln X$ 服从正态分布，均值为 $0$，方差为 $\\sigma^2 = 0.25$。仅使用这些定义以及正态分布和对数正态分布的标准性质，推导并计算在该方案下，每个入射粒子离开权重窗操作后的期望粒子数，即期望分支因子 $B$。将最终数值结果四舍五入至四位有效数字。",
            "solution": "此问题已经过验证。\n\n### 第一步：提取已知条件\n- 入射粒子权重：$W$\n- 目标粒子权重：$w_T$\n- 无量纲比率：$X = W / w_T$\n- 权重窗下界：$w_L = \\frac{w_T}{2}$\n- 权重窗上界：$w_U = 2 w_T$\n- 分裂和俄罗斯轮盘赌的规则：\n  - 如果 $X > \\frac{w_U}{w_T} = 2$：无偏分裂，子代粒子的期望数量为 $X$。\n  - 如果 $X  \\frac{w_L}{w_T} = \\frac{1}{2}$：俄罗斯轮盘赌，存活概率 $p = X$。如果存活，权重变为 $w_T$。\n  - 如果 $\\frac{1}{2} \\leq X \\leq 2$：无操作，粒子以权重 $W$ 继续。\n- $X$ 的分布：$X$ 服从对数正态分布，参数为 $\\mu = 0$ 和 $\\sigma = 0.5$。\n- 等价分布：$Y = \\ln X$ 服从正态分布，均值为 $\\mu_Y = 0$，方差为 $\\sigma_Y^2 = (0.5)^2 = 0.25$。\n- 目标：推导并计算期望分支因子 $B$，即每个入射粒子离开权重窗操作后的期望粒子数。\n- 最终精度：将数值结果四舍五入至四位有效数字。\n\n### 第二步：使用提取的已知条件进行验证\n1.  **科学依据：** 问题描述了一种在蒙特卡洛粒子输运模拟中（尤其是在核反应堆物理学中）使用的标准方差缩减技术（权重窗）。分裂和俄罗斯轮盘赌的规则是标准的无偏实现。使用对数正态分布来模拟粒子权重是合理的。该问题在科学上是合理的。\n2.  **适定性：** 该问题是适定的。它提供了输入变量 $X$ 的概率分布以及一套涵盖 $X$ 所有可能值（$X  0$）的完整规则。这使得可以计算出射粒子数的唯一期望值。\n3.  **客观性：** 问题以精确、客观的语言陈述，没有歧义或主观论断。\n4.  **完整性与一致性：** 提供了所有必要信息（$\\mu$、$\\sigma$、规则、边界）。这些规则是互斥的，并覆盖了 $X$ 的整个定义域。\n5.  **其他缺陷：** 该问题不是琐碎的、不可形式化的、不切实际的或不适定的。它是概率论在一个明确定义的工程问题上的直接应用。\n\n### 第三步：结论与行动\n此问题有效。将提供解答。\n\n***\n\n分支因子 $B$ 定义为每个入射粒子经过权重窗操作后离开的粒子数 $N_{out}$ 的期望值。我们可以使用全期望定律来求得：$B = E[N_{out}] = E[E[N_{out}|X]]$。\n\n让我们确定问题中定义的三种情况下，条件期望 $E[N_{out}|X=x]$ 的值。\n1.  对于分裂情况，当 $x > 2$ 时：问题指出，子代粒子的期望数量为 $x$。因此，$E[N_{out}|X=x] = x$。\n2.  对于俄罗斯轮盘赌情况，当 $x  1/2$ 时：一个粒子以概率 $p=x$ 存活，产生 1 个粒子；以概率 $1-x$ 被终止，产生 0 个粒子。期望粒子数为 $E[N_{out}|X=x] = 1 \\cdot p + 0 \\cdot (1-p) = p = x$。\n3.  对于通过情况，当 $1/2 \\leq x \\leq 2$ 时：单个粒子未经修改继续运动。因此，$E[N_{out}|X=x] = 1$。\n\n我们可以定义一个函数 $g(x) = E[N_{out}|X=x]$：\n$$\ng(x) =\n\\begin{cases}\nx   \\text{如果 } 0  x  1/2 \\\\\n1   \\text{如果 } 1/2 \\leq x \\leq 2 \\\\\nx   \\text{如果 } x > 2\n\\end{cases}\n$$\n\n总的期望分支因子 $B$ 是 $g(X)$ 的期望值，通过将 $g(x)$ 对 $X$ 的概率密度函数（PDF）$f(x)$ 进行积分来计算。\n$$\nB = E[g(X)] = \\int_0^\\infty g(x) f(x) dx\n$$\n根据 $g(x)$ 的定义，这个积分可以分为三个部分：\n$$\nB = \\int_0^{1/2} x f(x) dx + \\int_{1/2}^2 1 \\cdot f(x) dx + \\int_2^\\infty x f(x) dx\n$$\n变量 $X$ 服从参数为 $\\mu=0$ 和 $\\sigma=0.5$ 的对数正态分布。其概率密度函数（PDF）由下式给出：\n$$\nf(x) = \\frac{1}{x\\sigma\\sqrt{2\\pi}} \\exp\\left(-\\frac{(\\ln x - \\mu)^2}{2\\sigma^2}\\right) \\quad \\text{for } x > 0\n$$\n为了计算这些积分，更方便的方法是将积分变量改为 $Y = \\ln X$。变量 $Y$ 服从正态分布，其均值为 $\\mu_Y = \\mu = 0$，方差为 $\\sigma_Y^2 = \\sigma^2 = 0.25$。$Y$ 的概率密度函数（我们记为 $\\phi(y)$）是：\n$$\n\\phi(y) = \\frac{1}{\\sigma\\sqrt{2\\pi}} \\exp\\left(-\\frac{(y - \\mu)^2}{2\\sigma^2}\\right)\n$$\n变量代换为 $x = e^y$ 和 $dx = e^y dy$。$Y$ 的积分限变为：$x \\to 0 \\implies y \\to -\\infty$；$x=1/2 \\implies y=\\ln(1/2)=-\\ln(2)$；$x=2 \\implies y=\\ln(2)$；$x \\to \\infty \\implies y \\to \\infty$。\n\n我们来计算 $B$ 的每一项。\n\n中间项是 $X$ 落在通过窗口内的概率：\n$$\n\\int_{1/2}^2 f(x) dx = P\\left(\\frac{1}{2} \\leq X \\leq 2\\right) = P(-\\ln(2) \\leq Y \\leq \\ln(2))\n$$\n用 $Z = \\frac{Y-\\mu}{\\sigma} = \\frac{Y}{0.5} = 2Y$ 对 $Y$ 进行标准化，其中 $Z$ 服从标准正态分布 $N(0,1)$，我们得到：\n$$\nP(-2\\ln(2) \\leq Z \\leq 2\\ln(2)) = \\Phi(2\\ln(2)) - \\Phi(-2\\ln(2))\n$$\n其中 $\\Phi(\\cdot)$ 是标准正态分布的累积分布函数（CDF）。\n\n对于第一项和第三项，它们涉及 $\\int x f(x) dx$，我们使用对数正态分布的一个已知性质。在变量代换下，$x f(x)$ 这一项可以很好地简化：\n$$\nx f(x) dx = x \\left( \\frac{1}{x\\sigma\\sqrt{2\\pi}} \\exp\\left(-\\frac{(\\ln x - \\mu)^2}{2\\sigma^2}\\right) \\right) dx = \\phi(\\ln x) dx\n$$\n通过代换 $y = \\ln x$，我们有 $dy = \\frac{1}{x} dx$，所以 $dx = x dy = e^y dy$。被积函数变为：\n$$\nx f(x) dx = \\phi(y) e^y dy = \\frac{1}{\\sigma\\sqrt{2\\pi}} \\exp\\left(-\\frac{(y - \\mu)^2}{2\\sigma^2}\\right) e^y dy\n$$\n我们在指数部分进行配方：\n$$\ny - \\frac{(y-\\mu)^2}{2\\sigma^2} = -\\frac{y^2 - 2y(\\mu+\\sigma^2) + \\mu^2}{2\\sigma^2} = -\\frac{(y - (\\mu+\\sigma^2))^2 - (\\mu+\\sigma^2)^2 + \\mu^2}{2\\sigma^2} = -\\frac{(y - \\mu')^2}{2\\sigma^2} + \\mu + \\frac{\\sigma^2}{2}\n$$\n其中 $\\mu' = \\mu + \\sigma^2$。被积函数变为：\n$$\n\\exp\\left(\\mu + \\frac{\\sigma^2}{2}\\right) \\frac{1}{\\sigma\\sqrt{2\\pi}} \\exp\\left(-\\frac{(y - \\mu')^2}{2\\sigma^2}\\right) dy = E[X] \\cdot \\phi'(y) dy\n$$\n其中 $E[X] = \\exp(\\mu + \\sigma^2/2)$ 是对数正态分布 $X$ 的均值，而 $\\phi'(y)$ 是均值为 $\\mu' = \\mu + \\sigma^2$、方差为 $\\sigma^2$ 的正态分布的概率密度函数。\n设 $Y'$ 是一个服从 $N(\\mu', \\sigma^2)$ 分布的随机变量。那么 $\\int_a^b x f(x) dx = E[X] \\cdot P(a \\le Y' \\le b)$。\n\n现在我们可以计算 $B$ 的第一项和第三项：\n$$\n\\int_0^{1/2} x f(x) dx = E[X] \\int_{-\\infty}^{-\\ln(2)} \\phi'(y) dy = E[X] \\cdot P(Y' \\leq -\\ln(2))\n$$\n用 $Z = \\frac{Y'-\\mu'}{\\sigma}$ 对 $Y'$ 进行标准化，我们得到：\n$$\nP\\left(Z \\leq \\frac{-\\ln(2) - \\mu'}{\\sigma}\\right) = \\Phi\\left(\\frac{-\\ln(2) - (\\mu+\\sigma^2)}{\\sigma}\\right)\n$$\n对于第三项：\n$$\n\\int_2^\\infty x f(x) dx = E[X] \\int_{\\ln(2)}^{\\infty} \\phi'(y) dy = E[X] \\cdot P(Y' \\geq \\ln(2)) = E[X] \\left(1 - \\Phi\\left(\\frac{\\ln(2) - \\mu'}{\\sigma}\\right)\\right)\n$$\n\n现在，我们代入给定的值：$\\mu=0$ 和 $\\sigma=0.5$（因此 $\\sigma^2=0.25$）。\n$E[X] = \\exp(0 + 0.25/2) = \\exp(0.125)$。\n$\\mu' = 0 + 0.25 = 0.25$。\n$\\Phi$ 函数的自变量是：\n对于中间项：\n$z_1 = \\frac{\\ln(2)}{\\sigma} = \\frac{\\ln(2)}{0.5} = 2\\ln(2) \\approx 1.38629$。\n$\\int_{1/2}^2 f(x) dx = \\Phi(2\\ln(2)) - \\Phi(-2\\ln(2)) \\approx \\Phi(1.38629) - \\Phi(-1.38629) \\approx 0.917165 - 0.082835 = 0.834330$。\n\n对于第一项：\n$z_2 = \\frac{-\\ln(2) - \\mu'}{\\sigma} = \\frac{-\\ln(2) - 0.25}{0.5} = -2\\ln(2) - 0.5 \\approx -1.38629 - 0.5 = -1.88629$。\n$\\int_0^{1/2} x f(x) dx = \\exp(0.125) \\cdot \\Phi(-1.88629) \\approx 1.133148 \\times 0.029630 = 0.033586$。\n\n对于第三项：\n$z_3 = \\frac{\\ln(2) - \\mu'}{\\sigma} = \\frac{\\ln(2) - 0.25}{0.5} = 2\\ln(2) - 0.5 \\approx 1.38629 - 0.5 = 0.88629$。\n$\\int_2^\\infty x f(x) dx = \\exp(0.125) \\cdot (1 - \\Phi(0.88629)) \\approx 1.133148 \\times (1 - 0.812284) = 1.133148 \\times 0.187716 = 0.212711$。\n\n最后，我们将这三项相加得到 $B$：\n$$\nB \\approx 0.033586 + 0.834330 + 0.212711 = 1.080627\n$$\n问题要求将结果四舍五入到四位有效数字。前四位有效数字是 $1.080$，第五位数字是 $6$。因此，我们向上舍入。\n$$\nB \\approx 1.081\n$$",
            "answer": "$$\n\\boxed{1.081}\n$$"
        },
        {
            "introduction": "现实世界的重要性图，通常源于确定论伴随计算，永远不会是完美的。这项高级练习直面此现实，分析了重要性函数中的微小误差如何传播到模拟方差和整体品质因数 (FOM) 中。通过推导 FOM 对这些误差的敏感性，您将理解权重窗方法的稳健性以及对伴随求解器精度的要求 。",
            "id": "4260973",
            "problem": "考虑一个反应堆屏蔽问题中的深穿透中子响应计数，该计数被离散为 $B$ 个不相交的相空间单元，索引为 $b \\in \\{1,\\dots,B\\}$。令一个粒子历史在单元 $b$ 中实现其贡献的模拟概率为 $p_b$，并令确定性伴随重要性为 $I_b$，其与对计数器的单元贡献成正比。假设由权重窗引起的蒙特卡罗偏倚使用的抽样分布与确定性伴随重要性和模拟概率的乘积成正比。具体来说，预期的最优重要性抽样分布为 $q_b^{\\ast} \\propto I_b p_b$。在实践中，确定性伴随重要性包含小的、与单元相关的分数误差，因此实施的重要性为 $\\hat{I}_b = I_b (1 + \\varepsilon_b)$，其中 $|\\varepsilon_b| \\ll 1$。因此，实施的抽样分布是 $q_b = C (1 + \\varepsilon_b) I_b p_b$，其中 $C$ 是确保 $\\sum_{b=1}^{B} q_b = 1$ 的归一化常数。\n\n您将使用标准的重要性抽样估计量来计算响应，\n$$\n\\mu = \\sum_{b=1}^{B} I_b p_b,\n$$\n每个历史的权重为\n$$\nw_b = \\frac{I_b p_b}{q_b}.\n$$\n从重要性抽样的基本原理出发：估计量是无偏的，$E_{q}[w] = \\mu$，每个历史的方差是 $\\sigma_{1}^{2} = E_{q}[w^{2}] - \\mu^{2}$。在小参数 $\\varepsilon_b$ 的二阶精度下，推导一个由权重窗引起的方差增量的闭式表达式，即 $\\sigma_{1}^{2}(\\boldsymbol{\\varepsilon})$ 中仅由 $q_b$ 和 $q_b^{\\ast}$ 之间的不匹配引起的领先非零项。然后，采用品质因数 (FOM) 的标准定义，其中品质因数 (FOM) 为 $F = 1/(\\sigma^{2} T)$，且每个历史的中央处理器 (CPU) 时间是恒定的，$T = \\kappa N$（对于 $N$ 个历史，常数 $\\kappa  0$），计算 $F$ 对各单元分数误差 $\\varepsilon_b$ 的灵敏度，表示为梯度向量 $\\nabla_{\\boldsymbol{\\varepsilon}} F$，其第 $b$ 个分量为 $\\partial F / \\partial \\varepsilon_b$。\n\n您的推导必须从重要性抽样的无偏性和方差定义开始，并通过对小参数 $\\varepsilon_b$ 的系统展开来进行。将您关于灵敏度的最终答案表示为一个单一的闭式解析行向量，用 $I_b$、$p_b$、$\\varepsilon_b$、$\\kappa$ 和 $\\mu$ 表示。不需要进行数值计算。最终答案必须是解析表达式。不要在最终的方框答案中包含单位。",
            "solution": "该问题要求进行与使用不完美重要性抽样的蒙特卡罗模拟相关的两项推导。第一，由重要性函数中的误差引入的方差的主阶表达式。第二，品质因数 (FOM) 对这些误差的灵敏度。\n\n问题陈述具有科学依据、提法恰当且客观。它基于蒙特卡罗粒子输运模拟的既定原理，特别是重要性抽样和方差减少技术。所有提供的信息都是自洽和一致的。因此，该问题是有效的，可以构建解决方案。\n\n待估计的响应由所有相空间单元 $b$ 的总和给出：\n$$\n\\mu = \\sum_{b=1}^{B} I_b p_b\n$$\n其中 $I_b$ 是真实的伴随重要性，$p_b$ 是一个历史在单元 $b$ 中贡献的模拟概率。\n\n实施的、非理想的抽样分布是 $q_b = C \\hat{I}_b p_b = C I_b (1 + \\varepsilon_b) p_b$，其中 $\\hat{I}_b$ 是带有小分数误差 $\\varepsilon_b$ 的实施重要性，$C$ 是一个归一化常数。条件 $\\sum_{b=1}^{B} q_b = 1$ 决定了 $C$：\n$$\n\\sum_{b=1}^{B} C I_b (1 + \\varepsilon_b) p_b = 1\n$$\n$$\nC \\left( \\sum_{b=1}^{B} I_b p_b + \\sum_{b=1}^{B} \\varepsilon_b I_b p_b \\right) = 1\n$$\n$$\nC \\left( \\mu + \\sum_{j=1}^{B} \\varepsilon_j I_j p_j \\right) = 1\n$$\n$$\nC = \\frac{1}{\\mu + \\sum_{j=1}^{B} \\varepsilon_j I_j p_j}\n$$\n在单元 $b$ 中贡献的一个历史的权重由 $w_b = \\frac{I_b p_b}{q_b}$ 给出。代入 $q_b$ 的表达式：\n$$\nw_b = \\frac{I_b p_b}{C I_b (1 + \\varepsilon_b) p_b} = \\frac{1}{C (1 + \\varepsilon_b)}\n$$\n代入 $C$ 的表达式：\n$$\nw_b = \\frac{\\mu + \\sum_{j=1}^{B} \\varepsilon_j I_j p_j}{1 + \\varepsilon_b}\n$$\n\n每个历史的方差 $\\sigma_{1}^{2}$ 定义为 $\\sigma_{1}^{2} = E_{q}[w^{2}] - (E_{q}[w])^{2}$。估计量是无偏的，所以 $E_q[w] = \\sum_b w_b q_b = \\sum_b \\frac{I_b p_b}{q_b} q_b = \\sum_b I_b p_b = \\mu$。那么方差就是 $\\sigma_{1}^{2} = E_{q}[w^{2}] - \\mu^{2}$。\n\n我们现在计算 $E_{q}[w^{2}] = \\sum_{b=1}^{B} w_b^2 q_b$：\n$$\nE_{q}[w^{2}] = \\sum_{b=1}^{B} \\left(\\frac{I_b p_b}{q_b}\\right)^2 q_b = \\sum_{b=1}^{B} \\frac{(I_b p_b)^2}{q_b}\n$$\n代入 $q_b = C I_b (1 + \\varepsilon_b) p_b$：\n$$\nE_{q}[w^{2}] = \\sum_{b=1}^{B} \\frac{(I_b p_b)^2}{C I_b (1 + \\varepsilon_b) p_b} = \\frac{1}{C} \\sum_{b=1}^{B} \\frac{I_b p_b}{1 + \\varepsilon_b}\n$$\n代入 $C$ 的表达式：\n$$\nE_{q}[w^{2}] = \\left(\\mu + \\sum_{j=1}^{B} \\varepsilon_j I_j p_j\\right) \\left(\\sum_{b=1}^{B} \\frac{I_b p_b}{1 + \\varepsilon_b}\\right)\n$$\n由于 $|\\varepsilon_b| \\ll 1$，我们使用泰勒级数展开 $\\frac{1}{1+x} = 1 - x + x^2 - O(x^3)$。我们需要保留到 $\\varepsilon_b$ 的二阶项，以找到方差中的领先非零项。\n$$\n\\sum_{b=1}^{B} \\frac{I_b p_b}{1 + \\varepsilon_b} \\approx \\sum_{b=1}^{B} I_b p_b (1 - \\varepsilon_b + \\varepsilon_b^2) = \\sum_{b=1}^{B} I_b p_b - \\sum_{b=1}^{B} \\varepsilon_b I_b p_b + \\sum_{b=1}^{B} \\varepsilon_b^2 I_b p_b\n$$\n让我们定义 $S_1 = \\sum_{b=1}^{B} \\varepsilon_b I_b p_b$ 和 $S_2 = \\sum_{b=1}^{B} \\varepsilon_b^2 I_b p_b$。上面的表达式变为 $\\mu - S_1 + S_2$。\n现在，我们将此代回 $E_{q}[w^{2}]$ 的表达式中：\n$$\nE_{q}[w^{2}] \\approx (\\mu + S_1) (\\mu - S_1 + S_2) = \\mu^2 - \\mu S_1 + \\mu S_2 + S_1 \\mu - S_1^2 + S_1 S_2\n$$\n保留到 $\\varepsilon$ 的二阶项（注意 $S_1$ 是 $O(\\varepsilon)$ 阶，$S_2$ 是 $O(\\varepsilon^2)$ 阶）：\n$$\nE_{q}[w^{2}] \\approx \\mu^2 + \\mu S_2 - S_1^2 = \\mu^2 + \\mu \\sum_{b=1}^{B} \\varepsilon_b^2 I_b p_b - \\left(\\sum_{b=1}^{B} \\varepsilon_b I_b p_b\\right)^2\n$$\n方差增量 $\\sigma_{1}^{2}(\\boldsymbol{\\varepsilon})$ 于是为：\n$$\n\\sigma_{1}^{2}(\\boldsymbol{\\varepsilon}) = E_{q}[w^{2}] - \\mu^2 \\approx \\mu \\sum_{b=1}^{B} \\varepsilon_b^2 I_b p_b - \\left(\\sum_{b=1}^{B} \\varepsilon_b I_b p_b\\right)^2\n$$\n这是在 $\\varepsilon_b$ 的二阶精度下，由权重窗引起的方差增量的所需闭式表达式。注意，如果所有的 $\\varepsilon_b = 0$，那么 $\\sigma_{1}^{2} = 0$，这与这种离散形式下理想重要性抽样的预期相符。\n\n接下来，我们计算品质因数 (FOM) $F$ 对误差 $\\varepsilon_b$ 的灵敏度。FOM 定义为 $F = 1/(\\sigma^2 T)$，其中 $\\sigma^2 = \\sigma_1^2/N$ 是 $N$ 个历史后均值的方差，$T = \\kappa N$ 是总 CPU 时间。因此：\n$$\nF = \\frac{1}{(\\sigma_1^2/N)(\\kappa N)} = \\frac{1}{\\kappa \\sigma_1^2}\n$$\n我们需要计算梯度向量 $\\nabla_{\\boldsymbol{\\varepsilon}} F$，其第 $b$ 个分量是 $\\frac{\\partial F}{\\partial \\varepsilon_b}$。使用链式法则：\n$$\n\\frac{\\partial F}{\\partial \\varepsilon_b} = \\frac{dF}{d\\sigma_1^2} \\frac{\\partial \\sigma_1^2}{\\partial \\varepsilon_b}\n$$\n第一项是：\n$$\n\\frac{dF}{d\\sigma_1^2} = -\\frac{1}{\\kappa (\\sigma_1^2)^2}\n$$\n第二项需要将我们的 $\\sigma_1^2$ 表达式对特定误差分量 $\\varepsilon_k$ 求导：\n$$\n\\frac{\\partial \\sigma_1^2}{\\partial \\varepsilon_k} = \\frac{\\partial}{\\partial \\varepsilon_k} \\left[ \\mu \\sum_{b=1}^{B} \\varepsilon_b^2 I_b p_b - \\left(\\sum_{b=1}^{B} \\varepsilon_b I_b p_b\\right)^2 \\right]\n$$\n逐项求导：\n$$\n\\frac{\\partial}{\\partial \\varepsilon_k} \\left( \\mu \\sum_{b=1}^{B} \\varepsilon_b^2 I_b p_b \\right) = \\mu (2 \\varepsilon_k I_k p_k)\n$$\n$$\n\\frac{\\partial}{\\partial \\varepsilon_k} \\left( \\sum_{b=1}^{B} \\varepsilon_b I_b p_b \\right)^2 = 2 \\left( \\sum_{b=1}^{B} \\varepsilon_b I_b p_b \\right) \\frac{\\partial}{\\partial \\varepsilon_k} \\left( \\sum_{b=1}^{B} \\varepsilon_b I_b p_b \\right) = 2 \\left( \\sum_{b=1}^{B} \\varepsilon_b I_b p_b \\right) (I_k p_k)\n$$\n结合这些结果：\n$$\n\\frac{\\partial \\sigma_1^2}{\\partial \\varepsilon_k} = 2 \\mu \\varepsilon_k I_k p_k - 2 I_k p_k \\left( \\sum_{b=1}^{B} \\varepsilon_b I_b p_b \\right) = 2 I_k p_k \\left( \\mu \\varepsilon_k - \\sum_{b=1}^{B} \\varepsilon_b I_b p_b \\right)\n$$\n现在，我们组合 $F$ 的梯度分量：\n$$\n\\frac{\\partial F}{\\partial \\varepsilon_k} = -\\frac{1}{\\kappa (\\sigma_1^2)^2} \\left[ 2 I_k p_k \\left( \\mu \\varepsilon_k - \\sum_{b=1}^{B} \\varepsilon_b I_b p_b \\right) \\right]\n$$\n代入 $\\sigma_1^2$ 的表达式：\n$$\n\\frac{\\partial F}{\\partial \\varepsilon_k} = - \\frac{2 I_k p_k \\left( \\mu \\varepsilon_k - \\sum_{b=1}^{B} \\varepsilon_b I_b p_b \\right)}{\\kappa \\left[ \\mu \\sum_{b=1}^{B} \\varepsilon_b^2 I_b p_b - \\left(\\sum_{b=1}^{B} \\varepsilon_b I_b p_b\\right)^2 \\right]^2}\n$$\n梯度向量 $\\nabla_{\\boldsymbol{\\varepsilon}} F$ 是一个行向量，其第 $b$ 个分量由该表达式给出。\n$$\n\\nabla_{\\boldsymbol{\\varepsilon}} F = \\left( \\frac{\\partial F}{\\partial \\varepsilon_1}, \\frac{\\partial F}{\\partial \\varepsilon_2}, \\dots, \\frac{\\partial F}{\\partial \\varepsilon_B} \\right)\n$$\n这可以通过陈述通用第 $b$ 个分量的表达式来紧凑地书写，该表达式构成了最终答案。",
            "answer": "$$\n\\boxed{\n\\left( - \\frac{2 I_b p_b \\left( \\mu \\varepsilon_b - \\sum_{j=1}^{B} \\varepsilon_j I_j p_j \\right)}{\\kappa \\left[ \\mu \\sum_{j=1}^{B} \\varepsilon_j^2 I_j p_j - \\left(\\sum_{j=1}^{B} \\varepsilon_j I_j p_j\\right)^2 \\right]^2} \\right)_{b=1, \\dots, B}\n}\n$$"
        }
    ]
}