{
    "hands_on_practices": [
        {
            "introduction": "此首个练习为强迫碰撞技术奠定了数学基础。通过推导一个简单均匀平板中的碰撞概率和相应的权重调整，您将掌握该方法如何保持模拟无偏性的核心原理 ()。这项基本练习对于理解所有方差缩减技术都至关重要，在这些技术中，修改抽样概率必须通过精确的权重校正来补偿。",
            "id": "4246746",
            "problem": "考虑一个厚度为 $d$、宏观总截面为常数 $\\Sigma_{t}$ 的一维均匀板。一个初始统计权重为 $w_{0}$ 的中性粒子在 $x=0$ 处垂直入射穿过该板。在模拟蒙特卡罗 (Monte Carlo (MC)) 输运中，飞行路径上的碰撞被建模为单位长度发生率为 $\\Sigma_{t}$ 的空间泊松过程，自由程长度呈指数分布。在抽样碰撞类型时，一种常见的方差缩减技术是有限区域内的“强迫碰撞”法：不让历史在没有相互作用的情况下逃逸，而是通过从适当的条件概率密度函数 (Probability Density Function (PDF)) 中抽样碰撞深度，来强迫在板内发生一次碰撞，同时单独计算未碰撞的透射。\n\n从均匀介质中碰撞的泊松过程模型和比尔-朗伯衰减定律出发，推导在离开板之前至少发生一次碰撞的概率，然后推导赋予强迫碰撞历史的权重，以保证对于任何依赖于碰撞深度 $x \\in [0,d]$ 的基于碰撞的统计量，其无偏性得以保持。用 $\\Sigma_{t}$、$d$ 和 $w_{0}$ 的符号形式表示你的最终答案。无需进行数值计算。如果在推导中引入了中间的PDF，请明确写出它们。以解析闭合形式提供最终表达式。最终表达式中不要包含任何单位。",
            "solution": "该问题要求求解与一维板中粒子输运相关的两个量：板内至少发生一次碰撞的概率，以及强迫碰撞方差缩减技术所需的权重调整。推导将基于粒子输运和统计抽样的原理。\n\n均匀介质中中性粒子输运的基本模型是空间泊松过程。单位长度的碰撞率由宏观总截面 $\\Sigma_{t}$ 给出。由此，自由程长度 $s$（即粒子在两次碰撞之间行进的距离）的概率分布是指数分布。对于一个在 $x=0$ 处进入的粒子，其首次碰撞发生在深度 $x$ 处的概率密度函数 (PDF) 由下式给出：\n$$p(x) = \\Sigma_{t} \\exp(-\\Sigma_{t} x), \\quad x \\ge 0$$\n\n第一部分：板内至少发生一次碰撞的概率\n一个在 $x=0$ 处进入的粒子，如果在行进距离超过板厚 $d$ 之前没有发生相互作用，则会穿出板。粒子在区间 $[0, d]$ 内不发生碰撞的概率，等价于其首次碰撞发生在深度 $x > d$ 处的概率。这个概率，我们记为 $P_{trans}$（代表透射），可以通过将自由程PDF从 $d$ 积分到无穷大来计算：\n$$P_{trans} = P(x > d) = \\int_{d}^{\\infty} p(x) \\,dx = \\int_{d}^{\\infty} \\Sigma_{t} \\exp(-\\Sigma_{t} x) \\,dx$$\n计算该积分：\n$$P_{trans} = \\Sigma_{t} \\left[ -\\frac{1}{\\Sigma_{t}} \\exp(-\\Sigma_{t} x) \\right]_{d}^{\\infty} = -[\\exp(-\\Sigma_{t} x)]_{d}^{\\infty}$$\n$$P_{trans} = -(\\lim_{x\\to\\infty} \\exp(-\\Sigma_{t} x) - \\exp(-\\Sigma_{t} d)) = -(0 - \\exp(-\\Sigma_{t} d)) = \\exp(-\\Sigma_{t} d)$$\n这个结果就是著名的比尔-朗伯粒子衰减定律。\n\n“在离开板之前至少发生一次碰撞”这一事件是“粒子未经碰撞而透射”事件的补集。因此，至少发生一次碰撞的概率，我们记为 $P_{coll}$，是：\n$$P_{coll} = 1 - P_{trans} = 1 - \\exp(-\\Sigma_{t} d)$$\n\n第二部分：强迫碰撞历史的权重\n蒙特卡罗模拟的目标是估计某个量（统计量）的期望值。为了使模拟无偏，非模拟（方差缩减）方案的期望得分必须与模拟方案的期望得分相同。\n\n设 $T(x)$ 是在深度 $x \\in [0, d]$ 发生碰撞时对统计量的得分贡献。在模拟仿真中，一个粒子以权重 $w_0$ 开始。板内碰撞的期望得分 $E_{analog}[\\text{Tally}]$ 是在 $x$ 处的得分乘以在 $x$ 处发生碰撞的概率密度的积分：\n$$E_{analog}[\\text{Tally}] = \\int_{0}^{d} (w_0 T(x)) p(x) \\,dx = \\int_{0}^{d} w_0 T(x) \\Sigma_{t} \\exp(-\\Sigma_{t} x) \\,dx$$\n注意，这个表达式正确地表示了在板内发生碰撞的历史子集上的期望。透射出去的历史对板内基于碰撞的统计量没有贡献。\n\n在强迫碰撞方法中，有两件事发生了改变。首先，未碰撞的透射被确定性地处理。一个等于 $w_0 P_{trans} = w_0 \\exp(-\\Sigma_{t} d)$ 的权重被立即作为透射部分进行统计，并从活粒子的权重中移除。剩余的权重 $w_0' = w_0 (1-P_{trans}) = w_0(1-\\exp(-\\Sigma_t d))$ 被赋给一个被*强迫*在板内碰撞的粒子。这是一种常见的实现方式，但题目要求的是从条件PDF中抽样的历史本身的权重，这是一个略有不同但等效的视角。我们遵循题目的框架。\n\n题目陈述我们通过从一个适当的条件PDF中抽样，来强迫一次碰撞发生在板 $[0, d]$ 内。这意味着我们从碰撞位置的PDF $p(x)$ 中进行抽样，条件是碰撞发生在 $[0, d]$ 内。我们称这个新的抽样PDF为 $p_{forced}(x)$。根据条件概率的定义：\n$$p_{forced}(x) \\equiv p(x | x \\in [0, d]) = \\frac{p(x)}{P(x \\in [0, d])}$$\n我们已经计算出 $P(x \\in [0, d]) = P_{coll} = 1 - \\exp(-\\Sigma_{t} d)$。\n因此，用于抽样强迫碰撞位置的PDF是：\n$$p_{forced}(x) = \\frac{\\Sigma_{t} \\exp(-\\Sigma_{t} x)}{1 - \\exp(-\\Sigma_{t} d)}, \\quad \\text{for } x \\in [0, d]$$\n其他情况下 $p_{forced}(x)=0$。\n\n在这种强迫碰撞方案中，碰撞保证发生在 $[0, d]$ 内。我们从 $p_{forced}(x)$ 中抽样碰撞位置 $x$。为了保持无偏估计，必须调整粒子的权重。设赋给这个强迫碰撞历史的新权重为 $w_{forced}$。在强迫碰撞方案中，期望得分 $E_{forced}[\\text{Tally}]$ 为：\n$$E_{forced}[\\text{Tally}] = \\int_{0}^{d} (w_{forced} T(x)) p_{forced}(x) \\,dx$$\n代入 $p_{forced}(x)$ 的表达式：\n$$E_{forced}[\\text{Tally}] = \\int_{0}^{d} w_{forced} T(x) \\frac{\\Sigma_{t} \\exp(-\\Sigma_{t} x)}{1 - \\exp(-\\Sigma_{t} d)} \\,dx$$\n\n为了使统计量无偏，对于任意的统计函数 $T(x)$，模拟方案和强迫方案的期望得分必须相等：\n$$E_{analog}[\\text{Tally}] = E_{forced}[\\text{Tally}]$$\n$$\\int_{0}^{d} w_0 T(x) \\Sigma_{t} \\exp(-\\Sigma_{t} x) \\,dx = \\int_{0}^{d} w_{forced} T(x) \\frac{\\Sigma_{t} \\exp(-\\Sigma_{t} x)}{1 - \\exp(-\\Sigma_{t} d)} \\,dx$$\n由于这个等式必须对任何有效的、非平凡的统计函数 $T(x)$ 都成立，因此被积函数必须相等：\n$$w_0 T(x) \\Sigma_{t} \\exp(-\\Sigma_{t} x) = w_{forced} T(x) \\frac{\\Sigma_{t} \\exp(-\\Sigma_{t} x)}{1 - \\exp(-\\Sigma_{t} d)}$$\n我们可以消去两边共有的项 $T(x)$、$\\Sigma_{t}$ 和 $\\exp(-\\Sigma_{t} x)$（因为它们在积分域上非零）：\n$$w_0 = \\frac{w_{forced}}{1 - \\exp(-\\Sigma_{t} d)}$$\n求解强迫碰撞历史的权重 $w_{forced}$：\n$$w_{forced} = w_0 (1 - \\exp(-\\Sigma_{t} d))$$\n这个结果证实了我们的直觉：当我们强迫一个事件发生（其原始概率为 $P_{coll}$）时，我们必须将粒子的权重乘以该概率，以保持期望结果不变。要赋予的权重是初始权重 $w_0$ 乘以至少发生一次碰撞的概率 $P_{coll}$。\n\n所要求的两个量是：\n1.  至少发生一次碰撞的概率：$P_{coll} = 1 - \\exp(-\\Sigma_{t} d)$。\n2.  赋予强迫碰撞历史的权重：$w_{forced} = w_0 (1 - \\exp(-\\Sigma_{t} d))$。",
            "answer": "$$\n\\boxed{\n1 - \\exp(-\\Sigma_{t} d), \\quad w_{0} (1 - \\exp(-\\Sigma_{t} d))\n}\n$$"
        },
        {
            "introduction": "真实世界的系统很少是均匀的，通常包含具有不同材料属性甚至空区的复杂几何结构。这项练习在前一个练习的基础上，引入了非均匀性，包括一个在反应堆建模中很常见的空区 ()。您将学习如何将强迫碰撞框架应用于分段常数截面，这是处理实际输运问题的一项关键技能。",
            "id": "4227234",
            "problem": "在一个非均匀栅元中的粒子输运模拟，对沿中性粒子穿过的直弦采用了一种强迫碰撞技术。沿一维路径的中性粒子输运的线性玻尔兹曼方程表明，在宏观总截面 $\\Sigma_{t}(s)$ 为分段常数的情况下，到径程 $s$ 未发生碰撞的生存概率 $S(s)$ 满足 $\\frac{dS}{ds}=-\\Sigma_{t}(s)S(s)$，其解为 $S(s)=\\exp\\!\\left(-\\int_{0}^{s}\\Sigma_{t}(u)\\,du\\right)$。强迫碰撞方法根据粒子在出射前是否发生碰撞，将粒子权重分为碰撞部分和泄漏部分。\n\n考虑一个弦，它首先穿过一个长度为 $L_{0}$ 且 $\\Sigma_{t}(s)=0$ 的真空子区域（无材料），然后穿过两个具有分段常数总截面的非真空材料子区域：段1的长度为 $L_{1}$ 且 $\\Sigma_{t}(s)=\\Sigma_{1}$，段2的长度为 $L_{2}$ 且 $\\Sigma_{t}(s)=\\Sigma_{2}$。粒子在 $s=0$ 处以初始权重 $w_{0}$ 进入该弦。所关注的材料反应是吸收，段1中的宏观吸收截面为 $\\Sigma_{a1}$，段2中的为 $\\Sigma_{a2}$。假设为直线飞行，无角度效应，并忽略碰撞点处反应选择之外的源和散射。\n\n任务：\n1. 从生存概率定义 $S(s)=\\exp\\!\\left(-\\int_{0}^{s}\\Sigma_{t}(u)\\,du\\right)$ 和首次碰撞自由程的概率密度函数 (PDF) $f(s)=\\Sigma_{t}(s)S(s)$ 出发，推导此弦的权重分裂为碰撞部分 $w_{c}$ 和泄漏部分 $w_{\\ell}$，并得到强迫碰撞下沿弦的碰撞位置的条件PDF，其中需明确考虑 $\\Sigma_{t}=0$ 的真空子区域以及两个材料段中分段常数的 $\\Sigma_{t}$。\n2. 使用推导出的条件碰撞PDF和反应选择概率 $p_{a1}=\\Sigma_{a1}/\\Sigma_{1}$ 及 $p_{a2}=\\Sigma_{a2}/\\Sigma_{2}$，推导沿弦的单次强迫碰撞所贡献的期望吸收权重 $W_{\\text{abs}}$ 的闭式表达式。\n3. 对于以下物理上合理的参数，计算你的表达式的值：$w_{0}=1$, $L_{0}=2\\,\\text{cm}$, $L_{1}=0.5\\,\\text{cm}$, $L_{2}=0.8\\,\\text{cm}$, $\\Sigma_{1}=1.2\\,\\text{cm}^{-1}$, $\\Sigma_{a1}=0.3\\,\\text{cm}^{-1}$, $\\Sigma_{2}=0.6\\,\\text{cm}^{-1}$, and $\\Sigma_{a2}=0.1\\,\\text{cm}^{-1}$。将最终的吸收权重表示为无量纲的小数，并将你的答案四舍五入到四位有效数字。",
            "solution": "首先根据所需标准对问题陈述进行验证。\n\n### 问题验证\n\n**步骤1：提取已知条件**\n- 生存概率微分方程：$\\frac{dS}{ds}=-\\Sigma_{t}(s)S(s)$\n- 生存概率解：$S(s)=\\exp\\left(-\\int_{0}^{s}\\Sigma_{t}(u)\\,du\\right)$\n- 首次碰撞的概率密度函数 (PDF)：$f(s)=\\Sigma_{t}(s)S(s)$\n- 弦结构：\n  - 真空子区域：长度 $L_{0}$，宏观总截面 $\\Sigma_{t}(s)=0$ 对于 $s \\in [0, L_{0}]$。\n  - 段1：长度 $L_{1}$，宏观总截面 $\\Sigma_{t}(s)=\\Sigma_{1}$ 对于 $s \\in (L_{0}, L_{0}+L_{1}]$。\n  - 段2：长度 $L_{2}$，宏观总截面 $\\Sigma_{t}(s)=\\Sigma_{2}$ 对于 $s \\in (L_{0}+L_{1}, L_{0}+L_{1}+L_{2}]$。\n- 初始粒子权重：$w_{0}$\n- 宏观吸收截面：段1中为 $\\Sigma_{a1}$，段2中为 $\\Sigma_{a2}$。\n- 反应选择概率：$p_{a1}=\\Sigma_{a1}/\\Sigma_{1}$ 和 $p_{a2}=\\Sigma_{a2}/\\Sigma_{2}$。\n- 假设：直线飞行，无角度效应，忽略源，忽略反应选择之外的散射。\n- 用于计算的数值参数：$w_{0}=1$, $L_{0}=2\\,\\text{cm}$, $L_{1}=0.5\\,\\text{cm}$, $L_{2}=0.8\\,\\text{cm}$, $\\Sigma_{1}=1.2\\,\\text{cm}^{-1}$, $\\Sigma_{a1}=0.3\\,\\text{cm}^{-1}$, $\\Sigma_{2}=0.6\\,\\text{cm}^{-1}$, and $\\Sigma_{a2}=0.1\\,\\text{cm}^{-1}$。\n\n**步骤2：使用提取的已知条件进行验证**\n- **科学依据：** 该问题牢固地植根于中性粒子输运理论的原理，特别是一维线性玻尔兹曼方程的积分形式。宏观截面、生存概率、强迫碰撞方差缩减和反应概率等概念在核反应堆物理与模拟中是标准内容。\n- **良态问题：** 该问题提供了推导唯一解析解并进行数值计算所需的所有必要定义、数据和约束。任务陈述清晰且逻辑连贯。\n- **客观性：** 该问题使用了粒子输运领域的精确、标准和无偏见的术语来表述。\n- **缺陷检查：** 该问题没有任何不合格的缺陷。它在科学上是合理的、可形式化的、完整的和现实的。数据在量纲上是一致的（长度单位为 $\\text{cm}$，截面单位为 $\\text{cm}^{-1}$）。\n\n**步骤3：结论与行动**\n该问题是**有效的**。将提供完整解答。\n\n### 解题推导\n\n分析按顺序解决三个任务。弦的总长度为 $L = L_{0} + L_{1} + L_{2}$。\n\n**任务1：权重分裂与条件碰撞PDF**\n\n首先，我们确定粒子穿过整个弦而不发生碰撞的概率（泄漏概率，$P_{\\ell}$）以及它在弦上某处发生碰撞的概率（碰撞概率，$P_{c}$）。\n\n弦的总光学厚度 $\\tau_{tot}$ 是总宏观截面 $\\Sigma_t(s)$ 在整个路径长度 $L$ 上的积分。\n$$ \\tau_{tot} = \\int_{0}^{L_{0}+L_{1}+L_{2}} \\Sigma_t(u) \\, du $$\n鉴于 $\\Sigma_t(s)$ 的分段常数性质：\n$$ \\tau_{tot} = \\int_{0}^{L_{0}} 0 \\, du + \\int_{L_{0}}^{L_{0}+L_{1}} \\Sigma_{1} \\, du + \\int_{L_{0}+L_{1}}^{L_{0}+L_{1}+L_{2}} \\Sigma_{2} \\, du $$\n$$ \\tau_{tot} = 0 + \\Sigma_{1} [u]_{L_{0}}^{L_{0}+L_{1}} + \\Sigma_{2} [u]_{L_{0}+L_{1}}^{L_{0}+L_{1}+L_{2}} = \\Sigma_{1}L_{1} + \\Sigma_{2}L_{2} $$\n到达弦末端的生存概率，即泄漏概率 $P_{\\ell}$，为：\n$$ P_{\\ell} = S(L) = \\exp(-\\tau_{tot}) = \\exp(-(\\Sigma_{1}L_{1} + \\Sigma_{2}L_{2})) $$\n在弦内至少发生一次碰撞的概率是泄漏概率的补集：\n$$ P_{c} = 1 - P_{\\ell} = 1 - \\exp(-(\\Sigma_{1}L_{1} + \\Sigma_{2}L_{2})) $$\n强迫碰撞技术将初始权重 $w_{0}$ 分裂为泄漏部分 $w_{\\ell}$ 和碰撞部分 $w_{c}$：\n$$ w_{\\ell} = w_{0} P_{\\ell} = w_{0} \\exp(-(\\Sigma_{1}L_{1} + \\Sigma_{2}L_{2})) $$\n$$ w_{c} = w_{0} P_{c} = w_{0} (1 - \\exp(-(\\Sigma_{1}L_{1} + \\Sigma_{2}L_{2}))) $$\n这两部分之和等于初始权重：$w_{c} + w_{\\ell} = w_{0}$。\n\n接下来，我们推导在弦内发生碰撞的条件下，碰撞位置的条件PDF $f_{c}(s)$。这是无条件PDF $f(s)=\\Sigma_{t}(s)S(s)$ 除以总碰撞概率 $P_{c}$ 进行归一化的结果。\n$$ f_{c}(s) = \\frac{f(s)}{P_{c}} = \\frac{\\Sigma_{t}(s) S(s)}{1 - \\exp(-(\\Sigma_{1}L_{1} + \\Sigma_{2}L_{2}))} $$\n我们对弦的每一段计算 $f_c(s)$。生存概率为 $S(s) = \\exp(-\\int_0^s \\Sigma_t(u)du)$。\n- 对于 $s \\in [0, L_{0}]$：$\\Sigma_{t}(s)=0$，所以 $f_{c}(s) = 0$。在真空中不可能发生碰撞。\n- 对于 $s \\in (L_{0}, L_{0}+L_{1}]$：\n  $$ \\int_{0}^{s} \\Sigma_{t}(u)du = \\int_{L_{0}}^{s} \\Sigma_{1}du = \\Sigma_{1}(s-L_{0}) $$\n  $$ S(s) = \\exp(-\\Sigma_{1}(s-L_{0})) $$\n  $$ f_{c}(s) = \\frac{\\Sigma_{1} \\exp(-\\Sigma_{1}(s-L_{0}))}{1 - \\exp(-(\\Sigma_{1}L_{1} + \\Sigma_{2}L_{2}))} $$\n- 对于 $s \\in (L_{0}+L_{1}, L_{0}+L_{1}+L_{2}]$：\n  $$ \\int_{0}^{s} \\Sigma_{t}(u)du = \\int_{L_{0}}^{L_{0}+L_{1}} \\Sigma_{1}du + \\int_{L_{0}+L_{1}}^{s} \\Sigma_{2}du = \\Sigma_{1}L_{1} + \\Sigma_{2}(s - L_{0} - L_{1}) $$\n  $$ S(s) = \\exp(-(\\Sigma_{1}L_{1} + \\Sigma_{2}(s - L_{0} - L_{1}))) $$\n  $$ f_{c}(s) = \\frac{\\Sigma_{2} \\exp(-(\\Sigma_{1}L_{1} + \\Sigma_{2}(s-L_{0}-L_{1})))}{1 - \\exp(-(\\Sigma_{1}L_{1} + \\Sigma_{2}L_{2}))} $$\n\n**任务2：期望吸收权重**\n\n期望吸收权重 $W_{\\text{abs}}$ 是通过对所有可能的碰撞位置积分吸收的微分贡献来找到的。在位置 $s$ 处，权重为 $w_c$ 的强迫碰撞粒子发生一次碰撞。这次碰撞导致吸收的概率是 $p_a(s)$。期望吸收权重是这个吸收权重 $w_{c} \\cdot p_{a}(s)$ 由条件PDF $f_{c}(s)$ 加权的积分。\n$$ W_{\\text{abs}} = \\int_{0}^{L_{0}+L_{1}+L_{2}} (w_{c} \\cdot p_{a}(s)) f_{c}(s) \\, ds $$\n代入 $w_c$ 和 $f_c(s)$ 的表达式：\n$$ W_{\\text{abs}} = \\int_{0}^{L} \\left[ w_{0} (1 - P_{\\ell}) \\cdot p_{a}(s) \\cdot \\frac{\\Sigma_{t}(s) S(s)}{1 - P_{\\ell}} \\right] ds $$\n项 $(1 - P_{\\ell})$ 消掉了，这是一个关键特征，表明期望值是守恒的。\n$$ W_{\\text{abs}} = w_{0} \\int_{0}^{L} p_{a}(s) \\Sigma_{t}(s) S(s) \\, ds $$\n使用定义 $p_{a}(s) = \\Sigma_{a}(s) / \\Sigma_{t}(s)$，乘积 $p_{a}(s)\\Sigma_{t}(s)$ 简化为宏观吸收截面 $\\Sigma_{a}(s)$。\n$$ W_{\\text{abs}} = w_{0} \\int_{0}^{L_{0}+L_{1}+L_{2}} \\Sigma_{a}(s) S(s) \\, ds $$\n我们将积分分解到非真空区域上：\n$$ W_{\\text{abs}} = w_{0} \\left[ \\int_{L_{0}}^{L_{0}+L_{1}} \\Sigma_{a1} S(s) \\, ds + \\int_{L_{0}+L_{1}}^{L_0+L_1+L_2} \\Sigma_{a2} S(s) \\, ds \\right] $$\n让我们计算这两个积分 $I_1$ 和 $I_2$。\n$$ I_{1} = \\int_{L_{0}}^{L_{0}+L_{1}} \\Sigma_{a1} \\exp(-\\Sigma_{1}(s-L_{0})) \\, ds = \\Sigma_{a1} \\left[ \\frac{\\exp(-\\Sigma_{1}(s-L_{0}))}{-\\Sigma_{1}} \\right]_{L_{0}}^{L_{0}+L_{1}} $$\n$$ I_{1} = -\\frac{\\Sigma_{a1}}{\\Sigma_{1}} ( \\exp(-\\Sigma_{1}L_{1}) - \\exp(0) ) = \\frac{\\Sigma_{a1}}{\\Sigma_{1}} (1 - \\exp(-\\Sigma_{1}L_{1})) = p_{a1}(1 - \\exp(-\\Sigma_{1}L_{1})) $$\n对于第二个积分，\n$$ I_{2} = \\int_{L_{0}+L_{1}}^{L_{0}+L_{1}+L_{2}} \\Sigma_{a2} \\exp(-(\\Sigma_{1}L_{1} + \\Sigma_{2}(s-L_{0}-L_{1}))) \\, ds $$\n$$ I_{2} = \\Sigma_{a2} \\exp(-\\Sigma_{1}L_{1}) \\int_{L_{0}+L_{1}}^{L_{0}+L_{1}+L_{2}} \\exp(-\\Sigma_{2}(s-L_{0}-L_{1})) \\, ds $$\n$$ I_{2} = \\Sigma_{a2} \\exp(-\\Sigma_{1}L_{1}) \\left[ \\frac{\\exp(-\\Sigma_{2}(s-L_{0}-L_{1}))}{-\\Sigma_{2}} \\right]_{L_{0}+L_{1}}^{L_{0}+L_{1}+L_{2}} $$\n$$ I_{2} = -\\frac{\\Sigma_{a2}}{\\Sigma_{2}} \\exp(-\\Sigma_{1}L_{1}) (\\exp(-\\Sigma_{2}L_{2}) - \\exp(0)) = \\frac{\\Sigma_{a2}}{\\Sigma_{2}} \\exp(-\\Sigma_{1}L_{1}) (1 - \\exp(-\\Sigma_{2}L_{2})) $$\n$$ I_{2} = p_{a2} \\exp(-\\Sigma_{1}L_{1}) (1 - \\exp(-\\Sigma_{2}L_{2})) $$\n综合这些结果，总的期望吸收权重是：\n$$ W_{\\text{abs}} = w_{0} (I_{1} + I_{2}) = w_{0} \\left[ p_{a1} (1 - \\exp(-\\Sigma_{1}L_{1})) + p_{a2} \\exp(-\\Sigma_{1}L_{1}) (1 - \\exp(-\\Sigma_{2}L_{2})) \\right] $$\n\n**任务3：数值计算**\n\n我们得到以下参数：\n$w_{0}=1$\n$L_{1}=0.5\\,\\text{cm}$，$\\Sigma_{1}=1.2\\,\\text{cm}^{-1}$，$\\Sigma_{a1}=0.3\\,\\text{cm}^{-1}$\n$L_{2}=0.8\\,\\text{cm}$，$\\Sigma_{2}=0.6\\,\\text{cm}^{-1}$，$\\Sigma_{a2}=0.1\\,\\text{cm}^{-1}$\n\n首先，我们计算所需的中间值：\n- 段1中的吸收概率：$p_{a1} = \\frac{\\Sigma_{a1}}{\\Sigma_{1}} = \\frac{0.3}{1.2} = 0.25$\n- 段2中的吸收概率：$p_{a2} = \\frac{\\Sigma_{a2}}{\\Sigma_{2}} = \\frac{0.1}{0.6} = \\frac{1}{6}$\n- 段1的光学厚度：$\\tau_{1} = \\Sigma_{1}L_{1} = 1.2 \\times 0.5 = 0.6$\n- 段2的光学厚度：$\\tau_{2} = \\Sigma_{2}L_{2} = 0.6 \\times 0.8 = 0.48$\n\n现在，将这些值代入 $W_{\\text{abs}}$ 的表达式中：\n$$ W_{\\text{abs}} = 1 \\cdot \\left[ 0.25 \\cdot (1 - \\exp(-0.6)) + \\frac{1}{6} \\cdot \\exp(-0.6) \\cdot (1 - \\exp(-0.48)) \\right] $$\n我们计算指数项：\n$$ \\exp(-0.6) \\approx 0.548811635 $$\n$$ \\exp(-0.48) \\approx 0.618783392 $$\n将这些代入主表达式中：\n$$ W_{\\text{abs}} \\approx 0.25 \\cdot (1 - 0.548811635) + \\frac{1}{6} \\cdot 0.548811635 \\cdot (1 - 0.618783392) $$\n$$ W_{\\text{abs}} \\approx 0.25 \\cdot (0.451188365) + \\frac{1}{6} \\cdot (0.20919199) $$\n$$ W_{\\text{abs}} \\approx 0.112797091 + 0.034865332 $$\n$$ W_{\\text{abs}} \\approx 0.147662423 $$\n将结果四舍五入到四位有效数字，得到：\n$$ W_{\\text{abs}} \\approx 0.1477 $$\n这是初始粒子权重通过一次强迫碰撞事件在两个材料区域中被吸收的期望分数。",
            "answer": "$$\\boxed{0.1477}$$"
        },
        {
            "introduction": "将理论与实践相结合是掌握任何计算技术的最后一步。这个问题挑战您在一个输运核心程序中概述强迫碰撞的实现，重点关注算法工作流程和关键的数值稳定性考虑因素 ()。这项练习从程序员的角度巩固了您的理解，为您进行实际的代码开发做好准备。",
            "id": "4227173",
            "problem": "考虑一个使用蒙特卡洛（MC）方法的中性粒子输运模拟，其中有一个单能、各向同性散射的均匀化栅元。您的任务是为一个输运核心程序实现确定性双向分裂版本的强迫碰撞技术，该技术应用于每个进入栅元的粒子。目标是以保持无偏性的方式计算碰撞与逃逸分支及权重更新，并在选择碰撞分支时在栅元内对碰撞位置进行抽样。所有距离都应以无量纲化的平均自由程为单位进行处理，因此宏观总截面与距离的乘积即为光学厚度。将所有请求的输出表示为四舍五入到 $6$ 位小数的无量纲数。\n\n您必须仅从以下基本原理出发，并推导出您需要的一切：\n- 指数衰减定律：在宏观总截面为 $\\Sigma_t$ 的均匀介质中，粒子在路径长度 $s$ 上不发生相互作用的概率为 $P_0(s) = \\exp(-\\Sigma_t s)$。\n- 每次碰撞的反应概率：吸收和散射的概率分别为 $p_a = \\Sigma_a / \\Sigma_t$ 和 $p_s = \\Sigma_s / \\Sigma_t$，其中 $\\Sigma_t = \\Sigma_a + \\Sigma_s$，且 $p_a + p_s = 1$。\n- 概率密度函数（PDF）和累积分布函数（CDF）的定义，以及用于逆变换采样的基本变量变换方法。\n\n为每个独立的测试用例执行以下步骤，不得使用任何非从上述基础推导出的公式：\n1. 给定初始粒子权重 $w$、宏观总截面 $\\Sigma_t$ 以及沿飞行路径到下一个栅元边界的几何距离 $d$，推导并计算在到达边界前发生碰撞的总概率 $D$。仅使用指数衰减定律和概率公理。\n2. 构造一个对任何线性得分泛函都无偏的、分为碰撞分支和逃逸分支的确定性双向分裂。从第一性原理出发，推导并计算相应的分支权重 $w_c$ 和 $w_e$（用 $w$、$\\Sigma_t$ 和 $d$ 表示）。\n3. 对于碰撞分支，推导在碰撞发生在边界之前这一条件下，碰撞位置 $s$ 的条件概率密度函数（PDF），其支撑集在区间 $[0,d]$ 上。使用逆变换采样和一个单一的均匀变量 $U \\in (0,1)$ 从此条件分布中生成一个样本 $s$。每个测试用例的均匀变量必须使用提供的整数种子可复现地生成。确保您的实现在光学厚度非常小或非常大时具有数值稳定性。\n4. 给定吸收概率 $p_a$（因此 $p_s = 1 - p_a$），计算强迫碰撞后紧接着的预期吸收子分支权重 $w_{\\text{abs}}$ 和预期散射子分支权重 $w_{\\text{scat}}$。这些是在碰撞位置上对反应类型的期望值，必须用 $w_c$、$p_a$ 和 $p_s$ 表示。\n\n每个测试用例的输入数据以元组 $(w,\\ \\Sigma_t,\\ d,\\ p_a,\\ \\text{seed})$ 的形式提供。对于每个测试用例，您的程序必须按顺序输出以下 $6$ 个值：\n- $D$，\n- $w_c$，\n- $w_e$，\n- $s$，\n- $w_{\\text{abs}}$，\n- $w_{\\text{scat}}$。\n\n数值和实现要求：\n- 使用提供的整数种子初始化伪随机数生成器，并通过对您推导的条件概率密度函数进行逆变换采样来抽取一个 $U \\in (0,1)$ 以采样 $s$。每个测试用例的播种和采样必须是可复现且独立的。\n- 在计算光学厚度 $\\tau = \\Sigma_t d$ 非常小或非常大时的表达式时，通过避免灾难性抵消来确保数值稳定性。您的实现必须对 $\\tau \\ll 1$ 和 $\\tau \\gg 1$ 都是稳健的。\n- 将所有输出表示为四舍五入到 $6$ 位小数的无量纲数。\n\n测试套件：\n- 情况 1 (正常路径): $(w=\\;1.25,\\ \\Sigma_t=\\;0.7,\\ d=\\;2.0,\\ p_a=\\;0.35,\\ \\text{seed}=\\;314159)$。\n- 情况 2 (边界：极小光学厚度): $(w=\\;0.8,\\ \\Sigma_t=\\;10.0,\\ d=\\;10^{-6},\\ p_a=\\;0.5,\\ \\text{seed}=\\;271828)$。\n- 情况 3 (边界：极大光学厚度): $(w=\\;1.0,\\ \\Sigma_t=\\;2.0,\\ d=\\;10.0,\\ p_a=\\;0.2,\\ \\text{seed}=\\;42)$。\n- 情况 4 (低吸收概率): $(w=\\;2.0,\\ \\Sigma_t=\\;1.2,\\ d=\\;0.5,\\ p_a=\\;0.01,\\ \\text{seed}=\\;7)$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含按测试用例顺序连接的所有结果，形式为方括号括起来的逗号分隔列表（例如，$[r_{1,1},r_{1,2},\\dots,r_{N,6}]$）。每个测试用例必须有恰好 $6$ 个四舍五入的浮点数，顺序如上所述，并与测试套件的顺序相同。",
            "solution": "该问题陈述是计算物理学中的一个有效练习，具体涉及蒙特卡洛中性粒子输运模拟中的方差减少技术。它具有科学依据，问题提法恰当且客观。它要求从第一性原理推导基本公式并进行稳健的数值实现。我们将着手解决此问题。\n\n所有的推导都将基于所提供的基本原理：指数衰减定律、反应概率的定义以及逆变换采样的原理。设栅元的光学厚度表示为 $\\tau = \\Sigma_t d$，其中 $\\Sigma_t$ 是宏观总截面，$d$ 是到栅元边界的路径长度。根据问题陈述，所有量均为无量纲。\n\n### 步骤 1：碰撞概率 $D$ 的推导\n\n粒子行进距离 $s$ 而不发生相互作用的概率由指数衰减定律给出，$P_0(s) = \\exp(-\\Sigma_t s)$。这是存活概率。到第一次碰撞距离 $s_{\\text{coll}}$ 的累积分布函数（CDF）是在距离 $s$ 或之前发生碰撞的概率，即存活概率的补集：\n$$ F(s) = P(s_{\\text{coll}} \\le s) = 1 - P_0(s) = 1 - \\exp(-\\Sigma_t s), \\quad s \\ge 0 $$\n概率密度函数（PDF）是CDF的导数：\n$$ f(s) = \\frac{dF(s)}{ds} = \\Sigma_t \\exp(-\\Sigma_t s) $$\n在粒子到达距离为 $d$ 的边界之前发生碰撞的总概率 $D$ 是碰撞距离小于 $d$ 的概率，即 $P(s_{\\text{coll}}  d)$。这可直接由在 $s=d$ 处计算CDF得到：\n$$ D = F(d) = 1 - \\exp(-\\Sigma_t d) = 1 - e^{-\\tau} $$\n其互补概率，即粒子未发生碰撞而逃逸出栅元的概率为 $1-D = \\exp(-\\Sigma_t d) = e^{-\\tau}$。\n\n### 步骤 2：分支权重 $w_c$ 和 $w_e$ 的推导\n\n确定性双向分裂技术用两个确定性分支取代了单一的随机选择（碰撞或逃逸）。一个权重为 $w$ 的初始粒子被分裂成一个权重为 $w_c$ 的“碰撞”粒子和一个权重为 $w_e$ 的“逃逸”粒子。这种分裂必须是无偏的，意味着任何线性得分泛函的期望值都必须保持不变。\n\n让我们考虑一个粒子逃逸出栅元的得分。在模拟模拟中，一个权重为 $w$ 的粒子以 $1-D$ 的概率逃逸。对逃逸记录的预期贡献是 $w \\cdot (1-D)$。在分裂分支模型中，一个权重为 $w_e$ 的逃逸粒子被创建并被强迫逃逸。其贡献为 $w_e$。为了保持期望值不变，我们必须使这些贡献相等：\n$$ w_e = w \\cdot (1-D) = w \\exp(-\\Sigma_t d) = w e^{-\\tau} $$\n类似地，让我们考虑一个粒子在栅元内碰撞的得分。在模拟模拟中，一个权重为 $w$ 的粒子以概率 $D$ 发生碰撞。进入碰撞的预期权重是 $w \\cdot D$。在分裂分支模型中，一个权重为 $w_c$ 的碰撞粒子被创建并被强迫在 $[0, d]$ 内碰撞。其贡献为 $w_c$。为了保持期望值不变：\n$$ w_c = w \\cdot D = w (1 - \\exp(-\\Sigma_t d)) = w(1 - e^{-\\tau}) $$\n作为一致性检查，分支权重的总和是 $w_c + w_e = w(1 - e^{-\\tau}) + w e^{-\\tau} = w$，这保持了总粒子权重守恒。\n\n### 步骤 3：碰撞位置 $s$ 的条件PDF推导和抽样\n\n对于碰撞分支，我们必须在碰撞发生在区间 $[0, d]$ 内的条件下，从碰撞距离的条件分布中抽样一个碰撞位置 $s$。条件PDF，$f(s|s_{\\text{coll}}  d)$，由贝叶斯定理给出：\n$$ f(s|s_{\\text{coll}}  d) = \\frac{P(s_{\\text{coll}}  d | s_{\\text{coll}}=s) f(s)}{P(s_{\\text{coll}}  d)} $$\n对于 $s \\in [0, d]$，事件 $s_{\\text{coll}}=s$ 意味着 $s_{\\text{coll}}  d$，所以 $P(s_{\\text{coll}}  d | s_{\\text{coll}}=s) = 1$。分母是 $P(s_{\\text{coll}}  d) = D$。因此，对于 $s \\in [0, d]$，条件PDF是：\n$$ f(s | s_{\\text{coll}}  d) = \\frac{f(s)}{D} = \\frac{\\Sigma_t \\exp(-\\Sigma_t s)}{1 - \\exp(-\\Sigma_t d)} $$\n为了执行逆变换采样，我们需要对于 $x \\in [0, d]$ 的条件CDF，$F(x | s_{\\text{coll}}  d)$：\n$$ F(x | s_{\\text{coll}}  d) = \\int_0^x f(s' | s_{\\text{coll}}  d) ds' = \\int_0^x \\frac{\\Sigma_t \\exp(-\\Sigma_t s')}{1 - \\exp(-\\Sigma_t d)} ds' $$\n$$ F(x | s_{\\text{coll}}  d) = \\frac{\\Sigma_t}{1 - e^{-\\tau}} \\left[ -\\frac{1}{\\Sigma_t} \\exp(-\\Sigma_t s') \\right]_0^x = \\frac{1}{1 - e^{-\\tau}} \\left( -\\exp(-\\Sigma_t x) - (-\\exp(0)) \\right) $$\n$$ F(x | s_{\\text{coll}}  d) = \\frac{1 - \\exp(-\\Sigma_t x)}{1 - \\exp(-\\Sigma_t d)} $$\n为了抽样一个碰撞位置 $s$，我们将此CDF设为等于一个均匀随机变量 $U \\in (0,1)$，然后解出 $s$：\n$$ U = \\frac{1 - \\exp(-\\Sigma_t s)}{1 - \\exp(-\\Sigma_t d)} $$\n$$ U(1 - \\exp(-\\Sigma_t d)) = 1 - \\exp(-\\Sigma_t s) $$\n$$ \\exp(-\\Sigma_t s) = 1 - U(1 - \\exp(-\\Sigma_t d)) $$\n$$ -\\Sigma_t s = \\ln\\left(1 - U(1 - \\exp(-\\Sigma_t d))\\right) $$\n$$ s = -\\frac{1}{\\Sigma_t} \\ln\\left(1 - U(1 - e^{-\\tau})\\right) $$\n为了数值稳定性，特别是当 $\\tau = \\Sigma_t d$ 非常小时，直接计算 $1 - e^{-\\tau}$ 可能导致灾难性抵消。我们可以使用函数 $\\text{expm1}(x) = e^x - 1$，它在 $|x|$ 很小时是精确的。注意到 $1 - e^{-\\tau} = -(e^{-\\tau}-1) = -\\text{expm1}(-\\tau)$，因此 $D$ 的项变为 $D = -\\text{expm1}(-\\tau)$。\n同样，对于 $s$ 的抽样，对数的参数形式为 $1-y$，其中 $y$ 可能很小。为了获得更好的精度，我们可以使用函数 $\\text{log1p}(x) = \\ln(1+x)$。抽样公式变为：\n$$ s = -\\frac{1}{\\Sigma_t} \\text{log1p}\\left(-U(1-e^{-\\tau})\\right) = -\\frac{1}{\\Sigma_t} \\text{log1p}(-U \\cdot D) $$\n这个实现在 $\\tau$ 非常小和非常大时都是稳健的。\n\n### 步骤 4：预期子分支权重 $w_{\\text{abs}}$ 和 $w_{\\text{scat}}$ 的推导\n\n碰撞后，权重为 $w_c$ 的粒子与介质相互作用。相互作用要么是吸收（概率为 $p_a = \\Sigma_a / \\Sigma_t$），要么是散射（概率为 $p_s = \\Sigma_s / \\Sigma_t = 1 - p_a$）。问题要求的是紧随碰撞之后的子分支的*预期*权重。\n\n进入吸收通道的预期权重 $w_{\\text{abs}}$ 是碰撞的入射权重 $w_c$ 乘以吸收反应的概率：\n$$ w_{\\text{abs}} = w_c \\cdot p_a $$\n类似地，进入散射通道的预期权重 $w_{\\text{scat}}$ 是入射权重 $w_c$ 乘以散射反应的概率。在完整的模拟中，这个散射权重将被用来生成一个新的粒子状态（能量和方向）。\n$$ w_{\\text{scat}} = w_c \\cdot p_s = w_c (1 - p_a) $$\n这些直接源于期望值的定义和所提供的每次碰撞的反应概率。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the forced collision problem for a series of test cases.\n    \n    This function implements a deterministic two-way splitting for a particle\n    entering a homogeneous cell. It calculates branch probabilities and weights,\n    samples a collision site, and determines expected sub-branch weights for\n    absorption and scattering, all derived from first principles.\n    \n    The implementation is designed to be numerically stable for a wide range of\n    optical thicknesses by using numpy's special functions `expm1` and `log1p`.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (w, Sigma_t, d, p_a, seed)\n        (1.25, 0.7, 2.0, 0.35, 314159),  # Case 1 (happy path)\n        (0.8, 10.0, 1e-6, 0.5, 271828),   # Case 2 (very small optical thickness)\n        (1.0, 2.0, 10.0, 0.2, 42),       # Case 3 (very large optical thickness)\n        (2.0, 1.2, 0.5, 0.01, 7),        # Case 4 (low absorption probability)\n    ]\n\n    results = []\n    \n    for w, sigma_t, d, p_a, seed in test_cases:\n        # Initialize a reproducible random number generator for each case.\n        rng = np.random.default_rng(seed)\n        \n        # Draw a single uniform variate U in (0, 1) for inverse transform sampling.\n        U = rng.random()\n\n        # Calculate the optical thickness tau.\n        tau = sigma_t * d\n        \n        # Step 1: Calculate D, the collision probability before reaching the boundary.\n        # D = 1 - exp(-tau). Use expm1 for numerical stability for small tau.\n        # 1 - exp(-x) = - (exp(-x) - 1) = -expm1(-x).\n        D = -np.expm1(-tau)\n\n        # Step 2: Calculate the branch weights w_c and w_e.\n        # w_c = w * D\n        # w_e = w * (1-D) = w * exp(-tau)\n        w_c = w * D\n        w_e = w - w_c  # More numerically stable than w * exp(-tau)\n        \n        # Step 3: Sample the collision site 's' from the conditional distribution.\n        # s = (-1/sigma_t) * ln(1 - U * (1 - exp(-tau)))\n        # Use log1p for stability: ln(1+x) - log1p(x)\n        # Argument for log1p is -U * D\n        # A check for sigma_t  0 is prudent in a general-purpose code.\n        # Here, based on problem constraints, sigma_t  0 is implicitly assumed.\n        if sigma_t  0:\n            s_arg = -U * D\n            s = (-1.0 / sigma_t) * np.log1p(s_arg)\n        else:\n            # If sigma_t is 0, tau=0, D=0. Collision is impossible.\n            # The collision site is undefined. We can set it to a conventional value\n            # like 0 or NaN, but the collision branch weight w_c will be 0 anyway.\n            # Based on the limit s - U*d as sigma_t - 0, this is the consistent value.\n            s = U * d\n\n        # Step 4: Calculate expected sub-branch weights for absorption and scattering.\n        # w_abs = w_c * p_a\n        # w_scat = w_c * (1 - p_a)\n        w_abs = w_c * p_a\n        w_scat = w_c * (1.0 - p_a)\n        \n        # Append the 6 required output values, rounded to 6 decimal places.\n        case_results = [\n            np.round(D, 6),\n            np.round(w_c, 6),\n            np.round(w_e, 6),\n            np.round(s, 6),\n            np.round(w_abs, 6),\n            np.round(w_scat, 6)\n        ]\n        results.extend(case_results)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}