{
    "hands_on_practices": [
        {
            "introduction": "中子源迭代收敛的速度由裂变算子的“优势比”（次主特征值与主特征值的模之比）决定。这个实践通过一个简化的矩阵模型，让你亲手计算在使用有偏的方差缩减技术时，优势比会如何变化，并直接影响达到收敛所需的迭代次数。这有助于你将抽象的特征值理论与蒙特卡罗模拟中具体的性能表现联系起来。",
            "id": "4250530",
            "problem": "考虑一个用于蒙特卡洛中子输运 (MCNT) $k$-特征值计算中源收敛诊断 (SCD) 的临界板式反应堆的双区模型。设区域 $A$ 和 $B$ 上的裂变源分布在第 $n$ 次迭代（代）时由列向量 $s_n \\in \\mathbb{R}^2_{\\ge 0}$ 表示，并且设在没有任何偏差的情况下的平均线性裂变源映射由非负矩阵 $\\mathbf{M}_0 \\in \\mathbb{R}^{2 \\times 2}$ 表示，\n$$\n\\mathbf{M}_0 = \\begin{pmatrix}\n0.6  0.2 \\\\\n0.4  0.8\n\\end{pmatrix}.\n$$\n假设在无偏抽样和粒子数管理下系统是临界的，并且在代际之间应用了将源归一化至单位总权重的操作。\n\n现在假设使用了一个错误指定的重要性函数，并结合了权重窗 (Weight Window, WW) 粒子数控制，该控制与俄罗斯轮盘 (Russian Roulette, RR) 和分裂法一起，在每个区域对裂变源的期望贡献中引入了一个系统性偏差：落入区域 $A$ 的贡献被缩放因子 $b_A = 1.10$ 缩放，而落入区域 $B$ 的贡献被缩放因子 $b_B = 0.95$ 缩放。将此建模为应用于该映射的对角缩放 $\\mathbf{B} = \\mathrm{diag}(b_A,b_B)$，从而得到一个有偏的平均算子\n$$\n\\mathbf{M}_b = \\mathbf{B}\\mathbf{M}_0.\n$$\n假设初始源 $s_0$ 被分解为 $\\mathbf{M}_b$ 的主右特征向量 $v_1$ 和次主右特征向量 $v_2$ 的线性组合，即 $s_0 = c_1 v_1 + \\varepsilon v_2$，其中与 SCD 相关的次主模幅度为 $\\varepsilon = 0.3$。SCD 阈值要求经过 $n$ 代之后，次主模的幅度至多为 $\\delta = 1.0 \\times 10^{-5}$。\n\n使用非负矩阵线性算子迭代的第一性原理以及所述的建模假设，确定在有偏算子 $\\mathbf{M}_b$ 的作用下，使得次主模幅度低于阈值 $\\delta$ 所需的源迭代的最小整数次数 $n_{\\min}$。以单个整数形式提供 $n_{\\min}$。无需四舍五入到指定数量的有效数字；报告确切的最小整数。",
            "solution": "## 问题验证\n\n### 步骤 1：提取已知条件\n问题提供了以下数据和定义：\n- 无偏裂变源映射矩阵：\n$$\n\\mathbf{M}_0 = \\begin{pmatrix}\n0.6  0.2 \\\\\n0.4  0.8\n\\end{pmatrix}\n$$\n- 系统在无偏抽样下是临界的，这意味着 $\\mathbf{M}_0$ 的主特征值为 $1$。\n- 通过对角缩放矩阵 $\\mathbf{B} = \\mathrm{diag}(b_A, b_B)$ 引入了偏差，其中缩放因子为 $b_A = 1.10$ 和 $b_B = 0.95$。\n- 有偏平均算子由 $\\mathbf{M}_b = \\mathbf{B}\\mathbf{M}_0$ 给出。\n- 初始源分布 $s_0$ 被分解为 $\\mathbf{M}_b$ 的特征向量，即 $s_0 = c_1 v_1 + \\varepsilon v_2$，其中 $v_1$ 是主特征向量，$v_2$ 是次主特征向量。\n- 次主模的初始幅度为 $\\varepsilon = 0.3$。\n- 次主模幅度的收敛阈值为 $\\delta = 1.0 \\times 10^{-5}$。\n- 目标是找到使次主模幅度降至 $\\delta$ 以下所需的最小整数源迭代次数 $n_{\\min}$。\n\n### 步骤 2：使用提取的已知条件进行验证\n根据验证标准对问题进行评估：\n- **科学依据：** 该问题使用了一个成熟的线性代数模型（对裂变矩阵进行幂迭代）来分析蒙特卡洛模拟中的源收敛问题，这是核反应堆物理学中的一个标准课题。使用矩阵表示离散区域间的中子输运、由权重窗等方差缩减技术引入的偏差概念，以及通过优势比分析收敛速度，都是该领域中基本且科学正确的原理。给定的矩阵 $\\mathbf{M}_0$ 是非负的，这符合裂变算子的要求，其主特征值确实为 $1$，与“临界”系统的陈述一致。\n- **适定性：** 该问题在数学上是适定的。它要求计算一个量衰减到阈值以下所需的最小迭代次数，这是数值分析中的一个标准问题，并且有唯一的解。所有必要的参数（$\\mathbf{M}_0$、$\\mathbf{B}$、$\\varepsilon$、$\\delta$）都已提供。\n- **客观性：** 该问题使用核工程和线性代数的标准术语，以精确、定量和客观的语言陈述。没有主观或含糊不清的陈述。\n\n### 步骤 3：结论与行动\n该问题是有效的。它具有科学依据，是适定的，并且是客观的。将制定解决方案。\n\n## 解决方案\n\n该问题描述了用于寻找有偏裂变算子 $\\mathbf{M}_b$ 的主特征向量的幂迭代过程。在第 $n$ 次迭代时的源向量（记为 $s_n$）是通过将算子 $\\mathbf{M}_b$ 应用于前一次的源向量 $s_{n-1}$ 并对结果进行归一化得到的。初始源向量 $s_0$ 被给出为 $\\mathbf{M}_b$ 的主特征向量 $v_1$ 和次主特征向量 $v_2$ 的线性组合：\n$$\ns_0 = c_1 v_1 + \\varepsilon v_2\n$$\n其中 $\\mathbf{M}_b v_1 = \\lambda_1 v_1$ 且 $\\mathbf{M}_b v_2 = \\lambda_2 v_2$，并且 $|\\lambda_1| > |\\lambda_2|$。矩阵 $\\mathbf{M}_b$ 将是一个正矩阵，因此根据 Perron-Frobenius 定理，$\\lambda_1$ 是实数、正数，并且其模严格大于任何其他特征值的模。\n\n经过一次迭代后，在归一化之前，源向量变为：\n$$\ns'_1 = \\mathbf{M}_b s_0 = \\mathbf{M}_b (c_1 v_1 + \\varepsilon v_2) = c_1 \\lambda_1 v_1 + \\varepsilon \\lambda_2 v_2\n$$\n经过 $n$ 次迭代后，未归一化的源向量为：\n$$\ns'_n = \\mathbf{M}_b^n s_0 = c_1 \\lambda_1^n v_1 + \\varepsilon \\lambda_2^n v_2\n$$\n源向量 $s_n$ 在每一步都会被归一化，但特征向量的相对幅度不受此标量归一化的影响。我们可以通过提出主特征值项来分析次主模的衰减：\n$$\ns'_n = \\lambda_1^n \\left( c_1 v_1 + \\varepsilon \\left(\\frac{\\lambda_2}{\\lambda_1}\\right)^n v_2 \\right)\n$$\n经过 $n$ 次迭代后，次主模的幅度（记为 $\\varepsilon_n$）是初始幅度乘以优势比 $\\rho = |\\lambda_2 / \\lambda_1|$ 的 $n$ 次方。\n$$\n\\varepsilon_n = \\varepsilon \\rho^n = \\varepsilon \\left| \\frac{\\lambda_2}{\\lambda_1} \\right|^n\n$$\n我们需要找到最小的整数 $n$ 使得 $\\varepsilon_n \\le \\delta$。这导致不等式：\n$$\n\\varepsilon \\left| \\frac{\\lambda_2}{\\lambda_1} \\right|^n \\le \\delta\n$$\n首先，我们计算有偏算子 $\\mathbf{M}_b$：\n$$\n\\mathbf{M}_b = \\mathbf{B}\\mathbf{M}_0 = \\begin{pmatrix} 1.10  0 \\\\ 0  0.95 \\end{pmatrix} \\begin{pmatrix} 0.6  0.2 \\\\ 0.4  0.8 \\end{pmatrix} = \\begin{pmatrix} (1.10)(0.6)  (1.10)(0.2) \\\\ (0.95)(0.4)  (0.95)(0.8) \\end{pmatrix} = \\begin{pmatrix} 0.66  0.22 \\\\ 0.38  0.76 \\end{pmatrix}\n$$\n接下来，我们通过求解特征方程 $\\det(\\mathbf{M}_b - \\lambda\\mathbf{I}) = 0$ 来找到 $\\mathbf{M}_b$ 的特征值。\n$$\n\\det \\begin{pmatrix} 0.66 - \\lambda  0.22 \\\\ 0.38  0.76 - \\lambda \\end{pmatrix} = 0\n$$\n$$\n(0.66 - \\lambda)(0.76 - \\lambda) - (0.22)(0.38) = 0\n$$\n$$\n\\lambda^2 - (0.66 + 0.76)\\lambda + (0.66)(0.76) - (0.0836) = 0\n$$\n$$\n\\lambda^2 - 1.42\\lambda + 0.5016 - 0.0836 = 0\n$$\n$$\n\\lambda^2 - 1.42\\lambda + 0.418 = 0\n$$\n使用二次公式 $\\lambda = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$：\n$$\n\\lambda = \\frac{1.42 \\pm \\sqrt{(-1.42)^2 - 4(1)(0.418)}}{2} = \\frac{1.42 \\pm \\sqrt{2.0164 - 1.672}}{2} = \\frac{1.42 \\pm \\sqrt{0.3444}}{2}\n$$\n主特征值为 $\\lambda_1 = \\frac{1.42 + \\sqrt{0.3444}}{2}$，次主特征值为 $\\lambda_2 = \\frac{1.42 - \\sqrt{0.3444}}{2}$。两个特征值都是正数，所以优势比的绝对值符号可以去掉。\n$$\n\\rho = \\frac{\\lambda_2}{\\lambda_1} = \\frac{\\frac{1.42 - \\sqrt{0.3444}}{2}}{\\frac{1.42 + \\sqrt{0.3444}}{2}} = \\frac{1.42 - \\sqrt{0.3444}}{1.42 + \\sqrt{0.3444}}\n$$\n现在我们求解关于 $n$ 的不等式：\n$$\n\\varepsilon \\rho^n \\le \\delta\n$$\n$$\n\\rho^n \\le \\frac{\\delta}{\\varepsilon}\n$$\n对两边取自然对数：\n$$\nn \\ln(\\rho) \\le \\ln\\left(\\frac{\\delta}{\\varepsilon}\\right)\n$$\n由于 $\\rho  1$，$\\ln(\\rho)$ 是负数。除以 $\\ln(\\rho)$ 会反转不等号的方向：\n$$\nn \\ge \\frac{\\ln(\\delta/\\varepsilon)}{\\ln(\\rho)}\n$$\n我们代入给定的值 $\\varepsilon = 0.3$ 和 $\\delta = 1.0 \\times 10^{-5}$。\n$$\n\\frac{\\delta}{\\varepsilon} = \\frac{1.0 \\times 10^{-5}}{0.3} = \\frac{1}{30000}\n$$\n现在，我们计算对数的数值：\n$$\n\\ln\\left(\\frac{\\delta}{\\varepsilon}\\right) = \\ln\\left(\\frac{1}{30000}\\right) = -\\ln(30000) \\approx -10.30895\n$$\n$$\n\\rho = \\frac{1.42 - \\sqrt{0.3444}}{1.42 + \\sqrt{0.3444}} \\approx \\frac{1.42 - 0.586856}{1.42 + 0.586856} \\approx \\frac{0.833144}{2.006856} \\approx 0.415143\n$$\n一个更精确的 $\\rho$ 计算值为 $0.4151213$。为了准确起见，我们使用这个值。\n$$\n\\ln(\\rho) \\approx \\ln(0.4151213) \\approx -0.87913\n$$\n将这些值代入关于 $n$ 的不等式中：\n$$\nn \\ge \\frac{-10.30895}{-0.87913} \\approx 11.7263\n$$\n由于迭代次数 $n$ 必须是整数，我们取该值的向上取整。\n$$\nn_{\\min} = \\lceil 11.7263 \\rceil = 12\n$$\n因此，至少需要 12 次源迭代，才能使次主模的幅度降至指定阈值以下。",
            "answer": "$$\\boxed{12}$$"
        },
        {
            "introduction": "在蒙特卡罗模拟达到平稳状态后，我们需要量化其输出结果的统计不确定性。由于源迭代过程的马尔可夫链性质，连续批次产生的诊断量（如信息熵）是自相关的，不能简单地视为独立样本。本练习将指导你如何使用积分自相关时间来修正标准误差的计算，从而为相关时间序列的均值构建一个准确的置信区间。",
            "id": "4250569",
            "problem": "在对压水堆堆芯进行的蒙特卡罗$k$特征值模拟中，裂变源分布通过幂次迭代法在每一代进行更新，从而产生一个相关的逐代源指标序列。用于评估源稳定的一个诊断指标是归一化裂变源直方图的香农熵，对每一代 $t$ 定义为 $H_{t} = -\\sum_{i=1}^{B} p_{t,i} \\ln p_{t,i}$，其中 $p_{t,i}$ 是在第 $t$ 代期间于空间栅元 $i$ 中产生的裂变中子份额，且 $\\sum_{i=1}^{B} p_{t,i} = 1$。在舍弃非活跃代以消除初始瞬态效应后，假设收集了 $N = 1000$ 个活跃代，并将平稳熵过程 $\\{H_{t}\\}_{t=1}^{N}$ 视为由源迭代生成的平稳遍历序列的一个实现。\n\n从这些活跃代中，计算出以下诊断数据：样本均值 $\\bar{H} = 3.182$（单位为自然对数），$\\{H_{t}\\}$ 的样本方差 $s^{2} = 3.6 \\times 10^{-3}$，以及基于经验自相关函数估算的 $\\{H_{t}\\}$ 的积分自相关时间 $\\tau_{\\text{int}} = 8.2$。基于 $H_{t}$ 的定义和适用于相关平稳序列的渐近理论进行推导，构建平稳平均熵水平的渐近双侧 $95\\%$ 置信区间，并计算其对应的 $95\\%$ 半宽。只需报告半宽的数值，四舍五入至四位有效数字，并以自然对数单位表示。",
            "solution": "用户希望求出一个相关时间序列均值的 $95\\%$ 置信区间的半宽。\n\n### 第1步：提取已知条件\n-   活跃代（样本）数量为 $N = 1000$。\n-   该过程是一个香农熵值的平稳遍历序列 $\\{H_{t}\\}_{t=1}^{N}$。\n-   熵的样本均值为 $\\bar{H} = 3.182$。\n-   熵序列的样本方差为 $s^{2} = 3.6 \\times 10^{-3}$。\n-   该序列的估计积分自相关时间为 $\\tau_{\\text{int}} = 8.2$。\n-   期望的置信水平为 $95\\%$。\n\n### 第2步：使用提取的已知条件进行验证\n-   **科学依据：** 该问题设定在蒙特卡罗核反应堆分析的标准框架内。使用香农熵作为源收敛诊断、幂次迭代、活跃代以及对结果时间序列的统计处理（包括自相关）都是该领域的既定做法。所提供的值在物理上和数值上都是合理的。该问题具有科学合理性。\n-   **适定性：** 计算所求量所需的所有数据（$N$、$s^2$、$\\tau_{\\text{int}}$ 和置信水平）均已提供。问题要求一个唯一的数值，即置信区间的半宽，该值可使用标准的时间序列统计理论确定。\n-   **客观性：** 问题采用统计学和核工程领域通用的精确、无歧义的技术语言进行陈述。不存在主观或基于观点的内容。\n\n### 第3步：结论与行动\n问题有效。将提供完整的解答。\n\n### 解题推导\n问题要求为一个平稳、遍历但自相关的随机过程 $\\{H_t\\}$ 的真实均值 $\\mu_H = E[H_t]$ 构建置信区间。我们已知该过程的一个大小为 $N = 1000$ 的有限样本。\n\n根据相关性充分衰减的平稳序列的中心极限定理，样本均值 $\\bar{H} = \\frac{1}{N}\\sum_{t=1}^{N} H_t$ 渐近服从正态分布。该分布的均值是过程的真实均值 $\\mu_H$，其方差 $\\sigma^2_{\\bar{H}}$ 由下式给出：\n$$ \\sigma^2_{\\bar{H}} = \\text{Var}(\\bar{H}) = \\frac{\\sigma^2}{N} \\left( 1 + 2\\sum_{k=1}^{N-1} \\left(1 - \\frac{k}{N}\\right) \\rho_k \\right) $$\n其中 $\\sigma^2 = \\text{Var}(H_t)$ 是过程的真实方差，$\\rho_k$ 是过程在延迟为 $k$ 时的自相关系数。\n\n对于大的 $N$，该表达式可以使用积分自相关时间 $\\tau_{\\text{int}}$ 进行近似，其定义为：\n$$ \\tau_{\\text{int}} = 1 + 2\\sum_{k=1}^{\\infty} \\rho_k $$\n根据此定义，大样本 $N$ 下样本均值的方差变为：\n$$ \\sigma^2_{\\bar{H}} \\approx \\frac{\\sigma^2 \\tau_{\\text{int}}}{N} $$\n这个表达式表明，与不相关的过程相比，相关性使样本均值的方差增加了 $\\tau_{\\text{int}}$ 倍。量 $N_{\\text{eff}} = N/\\tau_{\\text{int}}$ 可以解释为有效独立样本数。\n\n为了计算置信区间，我们必须首先估计均值的标准误 $s_{\\bar{H}}$。它是样本均值估计方差 $s^2_{\\bar{H}}$ 的平方根。我们使用给定的样本方差 $s^2$ 作为真实过程方差 $\\sigma^2$ 的估计量，来估计 $\\sigma^2_{\\bar{H}}$。\n$$ s^2_{\\bar{H}} = \\frac{s^2 \\tau_{\\text{int}}}{N} $$\n代入给定值：\n$N = 1000$\n$s^2 = 3.6 \\times 10^{-3}$\n$\\tau_{\\text{int}} = 8.2$\n$$ s^2_{\\bar{H}} = \\frac{(3.6 \\times 10^{-3}) \\cdot (8.2)}{1000} = \\frac{0.02952}{1000} = 2.952 \\times 10^{-5} $$\n均值的标准误是该值的平方根：\n$$ s_{\\bar{H}} = \\sqrt{2.952 \\times 10^{-5}} \\approx 0.005433231 $$\n\n真实均值 $\\mu_H$ 的双侧 $95\\%$ 置信区间由下式给出：\n$$ \\bar{H} \\pm z_{\\alpha/2} s_{\\bar{H}} $$\n对于 $95\\%$ 的置信水平，显著性水平为 $\\alpha = 0.05$，这意味着 $\\alpha/2 = 0.025$。来自标准正态分布的临界值 $z_{0.025}$ 是使累积概率为 $1 - 0.025 = 0.975$ 的值。该值为：\n$$ z_{0.025} = 1.96 $$\n由于样本量大（$N=1000$），使用正态分布是合理的。\n\n置信区间的半宽（$HW$）是在样本均值上加减的量。其定义为：\n$$ HW = z_{\\alpha/2} s_{\\bar{H}} $$\n代入 $z_{0.025}$ 和 $s_{\\bar{H}}$ 的值：\n$$ HW = 1.96 \\times \\sqrt{\\frac{s^2 \\tau_{\\text{int}}}{N}} $$\n$$ HW = 1.96 \\times \\sqrt{2.952 \\times 10^{-5}} $$\n$$ HW \\approx 1.96 \\times 0.005433231 \\approx 0.010649133 $$\n问题要求答案四舍五入至四位有效数字。\n$$ HW \\approx 0.01065 $$\n半宽的单位与被测量量的单位相同，即自然对数单位。",
            "answer": "$$\n\\boxed{0.01065}\n$$"
        },
        {
            "introduction": "真实的反应堆模拟需要同时监控空间上多个区域的中子源分布，这本质上是一个多变量监控问题。本练习将引导你实现一个多变量控制图，这是一种强大的统计过程控制工具，用于自动检测中子源分布是否偏离了已收敛的平稳状态。你将学习如何使用二次型统计量（如Hotelling的$T^2$检验），处理可能奇异的协方差矩阵，并基于卡方分布设定报警阈值，构建一个稳健的自动化诊断系统。",
            "id": "4250525",
            "problem": "一项用于核反应堆堆芯中子输运的 Monte Carlo 特征值模拟，会生成一系列关于固定空间分区上裂变源分布的批次估计值。设空间分区由 $p$ 个区域组成，归一化裂变源统计的批次向量表示为 $x_t \\in \\mathbb{R}^p$，其中 $t$ 为批次索引。在源收敛的情况下，当每批的粒子历史足够多时，根据 Central Limit Theorem，连续的批次均值近似为来自一个多元正态分布的独立实现，该分布具有未知的均值向量 $\\mu \\in \\mathbb{R}^p$ 和未知的半正定协方差矩阵 $\\Sigma \\in \\mathbb{R}^{p \\times p}$。源收敛诊断的目的是通过监测 $x_t$ 来检测对该平稳分布的偏离，例如均值漂移或结构性变化。\n\n设计一个多元控制图，该控制图使用从中心化多元正态向量的分布特性中导出的二次型决策规则，并将其阈值表示为用户指定的、以小数 $\\alpha$ 表示的误报概率的函数。从一个“受控”的训练段中估计未知参数。为了稳健地处理奇异或病态的协方差估计，引入一个岭正则化参数 $\\lambda \\ge 0$，通过将协方差估计加上 $\\lambda$ 倍的单位矩阵来进行修正。在需要时使用 Moore–Penrose 伪逆。该控制图必须处理一个后续的检测段，并返回在检测段中检测到失控信号的最小正批次索引；如果未检测到信号，则返回 $0$。\n\n您的程序必须为每个测试用例实现以下步骤：\n- 给定一个训练矩阵 $X_0 \\in \\mathbb{R}^{m \\times p}$（其行为训练向量）和一个检测矩阵 $X_1 \\in \\mathbb{R}^{n \\times p}$（其行为检测向量），计算 $X_0$ 各行的样本均值 $\\hat{\\mu} \\in \\mathbb{R}^p$ 和 $X_0$ 各行的无偏样本协方差 $\\hat{\\Sigma} \\in \\mathbb{R}^{p \\times p}$。\n- 构建正则化协方差 $\\hat{\\Sigma}_\\lambda = \\hat{\\Sigma} + \\lambda I_p$，其中 $I_p$ 是 $p \\times p$ 的单位矩阵。\n- 对于每个检测向量 $x \\in \\mathbb{R}^p$（按其在 $X_1$ 中出现的顺序处理），使用 $\\hat{\\mu}$ 和 $\\hat{\\Sigma}_\\lambda$ 的伪逆计算二次型统计量。根据该统计量在平稳状态下的分布，推导出与指定的误报概率 $\\alpha$ 对应的阈值。在第一个其统计量超过阈值的检测向量处发出失控信号。如果没有任何向量的统计量超过阈值，则返回 $0$。\n- 程序的最终输出必须为单行，其中包含所有测试用例的结果，结果聚合为一个用方括号括起来的逗号分隔列表，例如 $[r_1,r_2,r_3]$，其中每个 $r_i$ 是一个整数，表示最早的检测索引或 $0$。\n\n所有量均为无量纲。本问题不涉及角度。误报概率必须作为小数 $\\alpha$ 处理，而不是百分比符号。\n\n使用以下测试套件。每个测试用例明确指定 $(X_0, X_1, \\alpha, \\lambda)$。\n\n测试用例 1 (受控，预计无信号)：\n- $p = 3$, $m = 5$, $n = 2$,\n- $X_0$ 各行：$\\left[1,2,3\\right], \\left[2,3,4\\right], \\left[1,3,5\\right], \\left[2,2,2\\right], \\left[0,1,2\\right]$,\n- $X_1$ 各行：等于 $X_0$ 的样本均值重复两次,\n- $\\alpha = 0.01$, $\\lambda = 0$.\n\n测试用例 2 (均值漂移，预计有明确信号)：\n- $p = 3$, $m = 6$, $n = 3$,\n- $X_0$ 各行：$\\left[1,0,0\\right], \\left[-1,0,0\\right], \\left[0,1,0\\right], \\left[0,-1,0\\right], \\left[0,0,1\\right], \\left[0,0,-1\\right]$,\n- $X_1$ 各行：$\\left[2,2,2\\right], \\left[2,2,2\\right], \\left[2,2,2\\right]$,\n- $\\alpha = 0.01$, $\\lambda = 0$.\n\n测试用例 3 (奇异协方差，正则化可防止误报信号)：\n- $p = 2$, $m = 3$, $n = 1$,\n- $X_0$ 各行：$\\left[1,1\\right], \\left[1,1\\right], \\left[1,1\\right]$,\n- $X_1$ 各行：$\\left[1.2,1.2\\right]$,\n- $\\alpha = 0.01$, $\\lambda = 0.1$.\n\n测试用例 4 (高维秩亏协方差；在未观测方向上的漂移不产生信号)：\n- $p = 5$, $m = 4$, $n = 2$,\n- $X_0$ 各行：$\\left[1,0,0,0,0\\right], \\left[-1,0,0,0,0\\right], \\left[0,2,0,0,0\\right], \\left[0,-2,0,0,0\\right]$,\n- $X_1$ 各行：$\\left[0,0,1,0,0\\right], \\left[0,0,1,0,0\\right]$,\n- $\\alpha = 0.01$, $\\lambda = 0$.\n\n您的程序应生成单行输出，其中包含按上述测试用例顺序列出的结果，格式为用方括号括起来的逗号分隔列表，例如 $[r_1,r_2,r_3,r_4]$，其中每个 $r_i$ 是一个整数。",
            "solution": "该问题要求设计并实现一个多元统计过程控制图，用于监测 Monte Carlo 核反应堆模拟中的源收敛情况。该控制图基于二次型统计量，并且必须能够通过正则化和使用 Moore-Penrose 伪逆来处理潜在的奇异协方差矩阵。\n\n该控制图的基本原理是检验新的观测值（批次裂变源向量）是否与以多元正态分布为特征的基准“受控”过程在统计上一致。\n\n设 $p$ 维批次裂变源向量序列表示为 $\\{x_t\\}_{t \\ge 1}$。在平稳的“受控”条件下，问题陈述指出这些向量近似为来自多元正态分布 $x_t \\sim \\mathcal{N}(\\mu, \\Sigma)$ 的独立同分布实现，其中均值向量 $\\mu \\in \\mathbb{R}^p$ 和协方差矩阵 $\\Sigma \\in \\mathbb{R}^{p \\times p}$ 是未知的。\n\n这个受控分布的参数从一个训练数据集（给定为矩阵 $X_0 \\in \\mathbb{R}^{m \\times p}$，包含 $m$ 个观测值）中估计。均值和协方差的标准无偏估计量为：\n-   样本均值：$\\hat{\\mu} = \\frac{1}{m} \\sum_{i=1}^{m} x_{0,i}$\n-   无偏样本协方差：$\\hat{\\Sigma} = \\frac{1}{m-1} \\sum_{i=1}^{m} (x_{0,i} - \\hat{\\mu})(x_{0,i} - \\hat{\\mu})^T$\n其中 $x_{0,i}$ 表示 $X_0$ 的第 $i$ 行。\n\n样本协方差矩阵 $\\hat{\\Sigma}$ 可能是奇异或病态的，特别是当训练样本数 $m$ 不远大于维度 $p$ 时。为确保稳健性，构建一个正则化的协方差矩阵：\n$$\n\\hat{\\Sigma}_\\lambda = \\hat{\\Sigma} + \\lambda I_p\n$$\n其中 $\\lambda \\ge 0$ 是一个用户指定的正则化参数，而 $I_p$ 是 $p \\times p$ 的单位矩阵。这种技术被称为岭正则化或 Tikhonov 正则化，它向 $\\hat{\\Sigma}$ 的对角线元素添加一个小的正值，使得生成的矩阵条件更好，并确保当 $\\lambda > 0$ 时其为正定矩阵。\n\n对于来自检测集 $X_1 \\in \\mathbb{R}^{n \\times p}$ 的每个新观测向量 $x$，我们检验零假设 $H_0$，即 $x$ 与训练数据来自同一分布。这是通过计算一个测试统计量来完成的，该统计量衡量 $x$ 与训练数据估计中心 $\\hat{\\mu}$ 的“距离”，并根据数据的协方差结构进行调整。这是一种广义马氏距离。该统计量，一个二次型，定义为：\n$$\nT^2 = (x - \\hat{\\mu})^T (\\hat{\\Sigma}_\\lambda)^+ (x - \\hat{\\mu})\n$$\n其中 $(\\hat{\\Sigma}_\\lambda)^+$ 表示正则化协方差矩阵的 Moore-Penrose 伪逆。使用伪逆是为了妥善处理 $\\hat{\\Sigma}_\\lambda$ 可能仍然是奇异的情况（即，如果 $\\lambda=0$ 且 $\\hat{\\Sigma}$ 是奇异的）。\n\n为了判断一个观测到的 $T^2$ 值是否显著大，我们必须知道它在零假设下的概率分布。对于足够大的训练集（$m \\to \\infty$），$\\hat{\\mu} \\to \\mu$ 且 $\\hat{\\Sigma} \\to \\Sigma$。在这个渐近极限下，统计量 $(x-\\mu)^T \\Sigma^{-1} (x-\\mu)$ 服从自由度为 $p$ 的卡方（$\\chi^2$）分布。当使用有限样本的估计参数时，特别是当对可能秩亏的协方差矩阵使用伪逆时，$T^2$ 的参考分布更准确地近似为 $\\chi^2$ 分布，其自由度等于协方差矩阵的秩。\n设 $r = \\text{rank}(\\hat{\\Sigma}_\\lambda)$。我们将统计量的零分布近似为：\n$$\nT^2 \\sim \\chi^2_r\n$$\n控制图的决策规则是，如果计算出的 $T^2$ 统计量超过一个临界阈值 $C$，就发出“失控”信号。这个阈值由指定的误报概率 $\\alpha$ 决定，$\\alpha$ 是指当过程实际上处于受控状态时发出信号的概率（第一类错误）。我们设定 $C$ 使得 $P(T^2 > C | H_0) = \\alpha$。根据我们的分布近似，阈值 $C$ 是 $\\chi^2_r$ 分布的上 $\\alpha$ 分位数：\n$$\nC = F_{\\chi^2_r}^{-1}(1-\\alpha)\n$$\n其中 $F_{\\chi^2_r}^{-1}$ 是自由度为 $r$ 的卡方分布的逆累积分布函数（百分点函数）。\n\n每个测试用例的总体算法如下：\n1.  从训练矩阵 $X_0$ 计算样本均值 $\\hat{\\mu}$ 和无偏样本协方差 $\\hat{\\Sigma}$。\n2.  构建正则化协方差矩阵 $\\hat{\\Sigma}_\\lambda = \\hat{\\Sigma} + \\lambda I_p$。\n3.  确定 $\\hat{\\Sigma}_\\lambda$ 的秩 $r$。\n4.  计算检测阈值 $C = F_{\\chi^2_r}^{-1}(1-\\alpha)$。\n5.  计算伪逆 $(\\hat{\\Sigma}_\\lambda)^+$。\n6.  对检测矩阵 $X_1$ 的各行 $x_k$ 进行迭代（$k=1, 2, ..., n$）。\n    a. 对于每个 $x_k$，计算偏差向量 $d_k = x_k - \\hat{\\mu}$。\n    b. 计算统计量 $T_k^2 = d_k^T (\\hat{\\Sigma}_\\lambda)^+ d_k$。\n    c. 如果 $T_k^2 > C$，则检测到失控状态。过程终止，并返回当前批次索引 $k$。\n7.  如果循环完成而没有任何统计量超过阈值，则认为检测段处于受控状态，并返回 $0$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import chi2\n\ndef solve():\n    \"\"\"\n    Solves the multivariate control chart problem for a given suite of test cases.\n    \"\"\"\n    \n    # Test case 1 (in-control, no signal expected)\n    X0_1 = np.array([\n        [1, 2, 3],\n        [2, 3, 4],\n        [1, 3, 5],\n        [2, 2, 2],\n        [0, 1, 2]\n    ])\n    mu_hat_1 = np.mean(X0_1, axis=0)\n    X1_1 = np.array([mu_hat_1, mu_hat_1])\n    alpha_1 = 0.01\n    lambda_1 = 0.0\n    case_1 = (X0_1, X1_1, alpha_1, lambda_1)\n\n    # Test case 2 (mean shift, clear signal expected)\n    X0_2 = np.array([\n        [1, 0, 0],\n        [-1, 0, 0],\n        [0, 1, 0],\n        [0, -1, 0],\n        [0, 0, 1],\n        [0, 0, -1]\n    ])\n    X1_2 = np.array([\n        [2, 2, 2],\n        [2, 2, 2],\n        [2, 2, 2]\n    ])\n    alpha_2 = 0.01\n    lambda_2 = 0.0\n    case_2 = (X0_2, X1_2, alpha_2, lambda_2)\n\n    # Test case 3 (singular covariance, regularization prevents false signal)\n    X0_3 = np.array([\n        [1, 1],\n        [1, 1],\n        [1, 1]\n    ])\n    X1_3 = np.array([\n        [1.2, 1.2]\n    ])\n    alpha_3 = 0.01\n    lambda_3 = 0.1\n    case_3 = (X0_3, X1_3, alpha_3, lambda_3)\n\n    # Test case 4 (high dimension with rank-deficient covariance; shift in an unobserved direction yields no signal)\n    X0_4 = np.array([\n        [1, 0, 0, 0, 0],\n        [-1, 0, 0, 0, 0],\n        [0, 2, 0, 0, 0],\n        [0, -2, 0, 0, 0]\n    ])\n    X1_4 = np.array([\n        [0, 0, 1, 0, 0],\n        [0, 0, 1, 0, 0]\n    ])\n    alpha_4 = 0.01\n    lambda_4 = 0.0\n    case_4 = (X0_4, X1_4, alpha_4, lambda_4)\n\n    test_cases = [case_1, case_2, case_3, case_4]\n\n    results = []\n    for case in test_cases:\n        X0, X1, alpha, lam = case\n        \n        # Determine dimensions\n        m, p = X0.shape\n        \n        # Step 1: Compute sample mean and unbiased sample covariance\n        mu_hat = np.mean(X0, axis=0)\n        \n        # np.cov with rowvar=False treats columns as variables. ddof=1 for unbiased estimator.\n        # This requires m > 1, which is true for all test cases.\n        if m > 1:\n            sigma_hat = np.cov(X0, rowvar=False, ddof=1)\n        else: # Handle case m = 1, covariance is zero\n            sigma_hat = np.zeros((p, p))\n\n        # Step 2: Form regularized covariance\n        sigma_lambda = sigma_hat + lam * np.identity(p)\n        \n        # Step 3: Determine rank for degrees of freedom\n        # Use a small tolerance for numerical stability\n        rank = np.linalg.matrix_rank(sigma_lambda)\n        \n        # Step 4: Calculate threshold\n        # If rank is 0, the chi-squared distribution is a point mass at 0.\n        # ppf(1-alpha, 0) is 0 for alpha  1.\n        # The statistic will also be 0, so no signal is possible.\n        if rank == 0:\n            threshold = 0.0\n        else:\n            threshold = chi2.ppf(1 - alpha, df=rank)\n            \n        # Step 5: Compute pseudoinverse\n        pinv_sigma_lambda = np.linalg.pinv(sigma_lambda)\n\n        detected_index = 0\n        # Step 6: Process detection segment\n        for i, x_detect in enumerate(X1):\n            # a. Deviation vector\n            d = x_detect - mu_hat\n            # b. Quadratic form statistic\n            T_squared = d.T @ pinv_sigma_lambda @ d\n            # c. Check against threshold\n            if T_squared > threshold:\n                detected_index = i + 1\n                break\n        \n        results.append(detected_index)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}