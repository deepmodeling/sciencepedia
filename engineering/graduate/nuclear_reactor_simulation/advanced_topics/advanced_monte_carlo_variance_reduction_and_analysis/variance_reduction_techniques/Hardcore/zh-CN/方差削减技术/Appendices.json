{
    "hands_on_practices": [
        {
            "introduction": "粒子分裂 (Splitting) 与俄罗斯轮盘 (Russian Roulette) 是蒙特卡罗方法中控制粒子权重和数量的基本工具。本练习旨在通过从第一性原理出发，推导在保持期望权重不变（无偏估计）的前提下，最小化权重方差的最优策略。掌握这一核心推导 ，对于理解和实现更高级的权重窗等自动方差缩减技术至关重要。",
            "id": "4259825",
            "problem": "在一次蒙特卡洛（MC）反应堆堆芯模拟中，一个权重为 $w0$ 的中子进入一个重要性更高或更低的区域，该区域的重要性由相对于前一区域的重要性比 $m0$ 来表征，其定义与反应堆物理学中使用的伴随通量加权归一化相一致。为了在粒子数控制后保持统计量的无偏性，事件后的总权重 $W_{\\text{out}}$ 必须满足约束条件 $\\mathbb{E}[W_{\\text{out}}]=w$。考虑两种方差减小技术：\n\n1. 分裂（Splitting），适用于 $m \\geq 1$：后代粒子数 $N$ 是一个取整数值的随机变量。每个后代粒子的权重被赋为 $w/m$，事件后的总权重为 $W_{\\text{out}}=N\\cdot(w/m)$。数对 $(n,p)$ 指定了 $N$ 的一个两点分布，其中 $N=n$ 的概率为 $1-p$，$N=n+1$ 的概率为 $p$，且 $n \\in \\mathbb{Z}_{\\ge 0}$，$p \\in [0,1]$。\n\n2. 俄罗斯轮盘赌（Russian roulette），适用于 $0  m  1$ 的情况。后代粒子数 $N$ 是一个取整数值的随机变量。每个后代粒子的权重被赋为 $w/m$，事件后的总权重为 $W_{\\text{out}}=N\\cdot(w/m)$。数对 $(n,p)$ 指定了 $N$ 的一个两点分布，其中 $N=n$ 的概率为 $1-p$，$N=n+1$ 的概率为 $p$，且 $n \\in \\mathbb{Z}_{\\ge 0}$，$p \\in [0,1]$。\n\n对于任意给定的重要性比 $m0$，确定能使事件后总权重 $W_{\\text{out}}$ 的方差最小化的最优数对 $(n,p)$。将您的答案表示为一个单行矩阵，其第一项是最优的 $n$，第二项是最优的 $p$，形式为关于 $m$ 的解析函数的封闭形式。",
            "solution": "该问题要求推导两种方差减小技术（分裂和俄罗斯轮盘赌）下事件后权重 $W_{\\text{out}}$ 的方差，并确定在无偏性约束下，对于任意给定的重要性比 $m0$，能使该方差最小化的最优参数 $(n,p)$。\n\n首先，我们必须验证问题陈述的有效性。\n\n**步骤1：提取已知条件**\n- 初始中子权重：$w0$。\n- 重要性比：$m0$。\n- 事件后总权重：$W_{\\text{out}} = N \\cdot (w/m)$，其中 $N$ 是后代粒子数。\n- 无偏性约束：$\\mathbb{E}[W_{\\text{out}}]=w$。\n- 对于分裂和俄罗斯轮盘赌，后代粒子数 $N$ 均由一个两点概率分布决定：$N=n$ 的概率为 $1-p$，$N=n+1$ 的概率为 $p$。\n- 参数约束为：$n \\in \\mathbb{Z}_{\\ge 0}$ 且 $p \\in [0,1]$。\n- 分裂对应于 $m \\geq 1$ 的情况。\n- 俄罗斯轮盘赌对应于 $0  m  1$ 的情况。\n\n**步骤2：使用提取的已知条件进行验证**\n- **科学依据**：该问题深深植根于成熟的粒子输运蒙特卡洛方法理论，这是核反应堆物理和计算物理学的核心课题。分裂和俄罗斯轮盘赌是标准的、有充分文献记载的方差减小技术。使用由 $\\mathbb{E}[W_{\\text{out}}]=w$ 定义的无偏估计量是一项基本原则。\n- **适定性**：问题陈述清晰，包含了所有必要的定义、变量和约束。在这些约束下最小化方差的目标是一个标准的优化问题，可以导出一个明确定义的解。\n- **客观性**：语言精确且数学化，没有主观或模糊的术语。\n\n该问题在科学上是合理的、自洽的且客观的。这是一个计算物理学领域中有效且适定的问题。\n\n**求解推导**\n该问题可以通过将分裂和俄罗斯轮盘赌置于一个由 $N$ 的两点分布定义的统一框架中来解决。\n\n1.  **施加无偏性约束**\n事件后权重的期望为 $\\mathbb{E}[W_{\\text{out}}] = \\mathbb{E}[N \\cdot \\frac{w}{m}] = \\frac{w}{m} \\mathbb{E}[N]$。\n因此，无偏性约束 $\\mathbb{E}[W_{\\text{out}}] = w$ 要求后代粒子的期望数量等于重要性比：\n$$ \\mathbb{E}[N] = m $$\n后代粒子数 $N$ 服从分布 $P(N=n)=1-p$ 和 $P(N=n+1)=p$。$N$ 的期望为：\n$$ \\mathbb{E}[N] = n \\cdot P(N=n) + (n+1) \\cdot P(N=n+1) = n(1-p) + (n+1)p = n - np + np + p = n+p $$\n将其与 $m$ 相等，我们得到参数 $n$，$p$ 和重要性比 $m$ 之间的直接关系：\n$$ n+p = m $$\n\n2.  **推导 $W_{\\text{out}}$ 的方差**\n事件后权重的方差由 $\\mathrm{Var}(W_{\\text{out}}) = \\mathrm{Var}(N \\cdot \\frac{w}{m})$ 给出。使用性质 $\\mathrm{Var}(cX) = c^2\\mathrm{Var}(X)$，我们有：\n$$ \\mathrm{Var}(W_{\\text{out}}) = \\left(\\frac{w}{m}\\right)^2 \\mathrm{Var}(N) $$\n为了求 $\\mathrm{Var}(N)$，我们首先计算二阶矩 $\\mathbb{E}[N^2]$：\n$$ \\mathbb{E}[N^2] = n^2(1-p) + (n+1)^2 p = n^2 - n^2p + (n^2+2n+1)p = n^2 + 2np + p $$\n$N$ 的方差为 $\\mathrm{Var}(N) = \\mathbb{E}[N^2] - (\\mathbb{E}[N])^2$。代入 $\\mathbb{E}[N^2]$ 和 $\\mathbb{E}[N]=n+p$ 的表达式：\n$$ \\mathrm{Var}(N) = (n^2 + 2np + p) - (n+p)^2 = (n^2 + 2np + p) - (n^2 + 2np + p^2) = p - p^2 = p(1-p) $$\n因此，事件后权重的方差为：\n$$ \\mathrm{Var}(W_{\\text{out}}) = \\left(\\frac{w}{m}\\right)^2 p(1-p) $$\n\n3.  **最小化方差**\n目标是找到使 $\\mathrm{Var}(W_{\\text{out}})$ 最小化的数对 $(n,p)$，并满足给定的约束条件：\n1.  $n+p = m$\n2.  $n \\in \\mathbb{Z}_{\\ge 0}$（即 $n$ 是非负整数）\n3.  $p \\in [0,1]$（即 $p$ 是一个有效的概率）\n\n根据约束（1），我们有 $p = m - n$。将其代入约束（3），我们得到关于 $n$ 的一个不等式：\n$$ 0 \\le m - n \\le 1 $$\n这是一个复合不等式，可以分为两部分：\n- $m - n \\ge 0 \\implies n \\le m$\n- $m - n \\le 1 \\implies n \\ge m - 1$\n\n将这些与 $n$ 必须为非负整数的约束相结合，我们发现 $n$ 必须是一个满足 $m-1 \\le n \\le m$ 的非负整数。\n\n让我们分析 $n$ 可能的整数值。\n- 如果 $m$ 不是整数，则区间 $(m-1, m)$ 的长度为 $1$，且只包含一个整数。这个整数必须是 $\\lfloor m \\rfloor$。因此，$n$ 的选择被唯一确定为 $n = \\lfloor m \\rfloor$。相应地，$p$ 也被唯一确定为 $p = m - \\lfloor m \\rfloor$。由于这是唯一满足所有约束的 $(n,p)$ 值，它自然就是最优解。\n- 如果 $m$ 是整数，则区间 $[m-1, m]$ 包含两个整数：$n=m-1$ 和 $n=m$（假设 $m \\ge 1$，这对于分裂机制中的整数值是成立的）。\n    - 如果我们选择 $n=m$，那么 $p = m-m=0$。方差变为 $\\mathrm{Var}(W_{\\text{out}}) = (\\frac{w}{m})^2 \\cdot 0 \\cdot (1-0) = 0$。\n    - 如果我们选择 $n=m-1$，那么 $p = m-(m-1)=1$。方差变为 $\\mathrm{Var}(W_{\\text{out}}) = (\\frac{w}{m})^2 \\cdot 1 \\cdot (1-1) = 0$。\n两种选择都得到方差为 $0$，这是可能的绝对最小值。因此，两者都是最优解。\n\n问题要求为任意 $m0$ 给出最优数对 $(n,p)$ 的单一解析表达式。表达式 $n = \\lfloor m \\rfloor$ 在所有情况下都提供了一个有效且最优的选择。对于非整数的 $m$，这是唯一的选择。对于整数的 $m$，它给出 $n=m$，这是两个零方差解之一。\n\n因此，对于 $n$ 的一般最优选择是：\n$$ n = \\lfloor m \\rfloor $$\n对应的最优 $p$ 值由无偏性条件 $p = m-n$ 决定：\n$$ p = m - \\lfloor m \\rfloor $$\n这一对表达式为整个 $m > 0$ 的范围提供了最优参数。\n- 对于**分裂**（$m \\ge 1$），我们有 $n = \\lfloor m \\rfloor \\ge 1$。\n- 对于**俄罗斯轮盘赌**（$0  m  1$），我们有 $n = \\lfloor m \\rfloor = 0$。这将 $N$ 的两点分布简化为 $P(N=0)=1-p$ 和 $P(N=1)=p$。当 $p=m-0=m$ 时，这变为 $P(N=1)=m$ 和 $P(N=0)=1-m$，这与俄罗斯轮盘赌的标准形式（存活概率等于重要性比）相一致。\n\n最优数对 $(n,p)$ 仅是 $m$ 的函数。",
            "answer": "$$ \\boxed{ \\begin{pmatrix} \\lfloor m \\rfloor  m - \\lfloor m \\rfloor \\end{pmatrix} } $$"
        },
        {
            "introduction": "存活偏倚 (Survival biasing) 是一种经典的方差缩减技术，它通过调整粒子权重来替代物理上的吸收事件，从而确保每个粒子历史都能对结果做出贡献。本练习  将引导你分析在一个理想化模型中，相比于传统的模拟方法 (analog transport)，存活偏倚如何改变两种常用估计量（碰撞估计量和径迹长度估计量）的期望和方差。通过直接量化方差的缩减程度，你将深刻体会到方差缩减技术在提升计算效率方面的巨大威力。",
            "id": "4259769",
            "problem": "考虑一个单能中子在无限均匀介质中的历史，该介质的特征是宏观吸收截面 $\\Sigma_{a}  0$ 和宏观散射截面 $\\Sigma_{s} \\ge 0$，因此宏观总截面为 $\\Sigma_{t} = \\Sigma_{a} + \\Sigma_{s}$。一个初始统计权重为 $1$ 的中子在任意位置以各向同性的方向产生。假设采用标准的蒙特卡洛（MC）自由飞行模型：径迹段长度 $\\ell$ 是独立同分布的，其概率密度为 $p(\\ell) = \\Sigma_{t} \\exp(-\\Sigma_{t} \\ell)$。在模拟输运中，每次碰撞的吸收概率为 $\\Sigma_{a}/\\Sigma_{t}$，散射概率为 $\\Sigma_{s}/\\Sigma_{t}$。在整个空间上积分的标量通量通过碰撞估计量或径迹长度估计量对每个历史进行统计，定义如下：\n\n- 碰撞估计量：每次碰撞对统计量的贡献为 $w/\\Sigma_{t}$，其中 $w$ 是粒子在该次碰撞时的当前统计权重。\n- 径迹长度估计量：每个自由飞行径迹段对统计量的贡献为 $w \\ell$，其中 $w$ 是粒子在该径迹段期间的当前统计权重。\n\n现在应用存活偏倚（也称为隐式俘获）：在每次碰撞时，强制发生散射事件，并将粒子的权重乘以因子 $c = \\Sigma_{s}/\\Sigma_{t}$，粒子历史不终止。在此方案下，碰撞估计量和径迹长度估计量通过几何权重序列 $1, c, c^{2}, \\ldots$ 进行修正，该序列应用于连续的碰撞及其中间的飞行径迹段。\n\n仅从所述的自由飞行定律和事件选择概率出发，并利用关于独立和与简单离散分布的基本概率事实，推导在该无限介质中单个历史的以下量：\n\n(i) 在模拟输运下，碰撞估计量和径迹长度估计量的期望和方差。\n\n(ii) 在存活偏倚下，碰撞估计量和径迹长度估计量的期望和方差。\n\n然后，构建比值\n$$\nR_{\\mathrm{TL}} = \\frac{\\operatorname{Var}_{\\mathrm{SB}}(\\Phi_{\\mathrm{TL}})}{\\operatorname{Var}_{\\mathrm{AN}}(\\Phi_{\\mathrm{TL}})}, \n\\qquad\nR_{\\mathrm{C}} = \\frac{\\operatorname{Var}_{\\mathrm{SB}}(\\Phi_{\\mathrm{C}})}{\\operatorname{Var}_{\\mathrm{AN}}(\\Phi_{\\mathrm{C}})},\n$$\n其中 $\\Phi_{\\mathrm{TL}}$ 和 $\\Phi_{\\mathrm{C}}$ 分别是单历史的径迹长度和碰撞通量估计量，下标 $\\mathrm{SB}$ 和 $\\mathrm{AN}$ 分别表示存活偏倚和模拟输运。将您的最终答案表示为一个单行矩阵，其第一项是 $R_{\\mathrm{TL}}$，第二项是 $R_{\\mathrm{C}}$，形式为关于 $\\Sigma_{a}$ 和 $\\Sigma_{s}$ 的解析函数的封闭形式。不需要数值近似或四舍五入，也无需报告单位。",
            "solution": "问题陈述已经过验证，被认为是粒子输运蒙特卡洛方法领域中一个定义良好且具有科学依据的问题。我们继续进行推导。\n\n设宏观散射截面和吸收截面分别为 $\\Sigma_s$ 和 $\\Sigma_a$。总截面为 $\\Sigma_t = \\Sigma_a + \\Sigma_s$。每次碰撞的存活概率，即散射概率，为 $c = \\Sigma_s / \\Sigma_t$。吸收概率为 $1-c = \\Sigma_a / \\Sigma_t$。问题陈述 $\\Sigma_a  0$，这意味着 $c  1$。\n\n粒子的自由飞行径迹段长度 $\\ell$ 是一个随机变量 $L$，服从参数为 $\\Sigma_t$ 的指数分布。其概率密度函数为 $p(\\ell) = \\Sigma_t \\exp(-\\Sigma_t \\ell)$，其中 $\\ell \\ge 0$。飞行路径长度的期望和方差为：\n$$\n\\operatorname{E}[L] = \\frac{1}{\\Sigma_t}\n$$\n$$\n\\operatorname{Var}(L) = \\frac{1}{\\Sigma_t^2}\n$$\n由此，我们也可以求出其二阶矩：\n$$\n\\operatorname{E}[L^2] = \\operatorname{Var}(L) + (\\operatorname{E}[L])^2 = \\frac{1}{\\Sigma_t^2} + \\left(\\frac{1}{\\Sigma_t}\\right)^2 = \\frac{2}{\\Sigma_t^2}\n$$\n\n**第(i)部分：模拟输运**\n\n在模拟输运中，粒子历史在发生吸收时终止。设 $N$ 为代表粒子经历的总碰撞次数的随机变量。只要粒子发生散射，其历史就会继续。在一次碰撞中散射的概率是 $c$。在第 $k$ 次碰撞时被吸收的概率，是其在前 $k-1$ 次碰撞中存活下来，然后在第 $k$ 次碰撞时被吸收的概率，即 $c^{k-1}(1-c)$。\n因此，$N$ 服从成功参数为 $p=1-c$ 的几何分布。\n其概率质量函数为 $P(N=k) = c^{k-1}(1-c)$，其中 $k=1, 2, \\ldots$。\n$N$ 的期望和方差为：\n$$\n\\operatorname{E}[N] = \\frac{1}{1-c} = \\frac{1}{\\Sigma_a / \\Sigma_t} = \\frac{\\Sigma_t}{\\Sigma_a}\n$$\n$$\n\\operatorname{Var}(N) = \\frac{c}{(1-c)^2} = \\frac{\\Sigma_s / \\Sigma_t}{(\\Sigma_a / \\Sigma_t)^2} = \\frac{\\Sigma_s \\Sigma_t}{\\Sigma_a^2}\n$$\n\n**模拟碰撞估计量 ($\\Phi_{\\mathrm{C,AN}}$)**\n在模拟输运中，粒子权重 $w$ 始终为 $1$。每次碰撞的得分是 $1/\\Sigma_t$。对于一个有 $N$ 次碰撞的历史，总得分为：\n$$\n\\Phi_{\\mathrm{C,AN}} = \\sum_{i=1}^{N} \\frac{1}{\\Sigma_t} = \\frac{N}{\\Sigma_t}\n$$\n其期望为：\n$$\n\\operatorname{E}[\\Phi_{\\mathrm{C,AN}}] = \\operatorname{E}\\left[\\frac{N}{\\Sigma_t}\\right] = \\frac{1}{\\Sigma_t} \\operatorname{E}[N] = \\frac{1}{\\Sigma_t} \\frac{\\Sigma_t}{\\Sigma_a} = \\frac{1}{\\Sigma_a}\n$$\n其方差为：\n$$\n\\operatorname{Var}(\\Phi_{\\mathrm{C,AN}}) = \\operatorname{Var}\\left(\\frac{N}{\\Sigma_t}\\right) = \\frac{1}{\\Sigma_t^2} \\operatorname{Var}(N) = \\frac{1}{\\Sigma_t^2} \\frac{\\Sigma_s \\Sigma_t}{\\Sigma_a^2} = \\frac{\\Sigma_s}{\\Sigma_t \\Sigma_a^2} = \\frac{\\Sigma_s}{(\\Sigma_a + \\Sigma_s) \\Sigma_a^2}\n$$\n\n**模拟径迹长度估计量 ($\\Phi_{\\mathrm{TL,AN}}$)**\n每个长度为 $L_i$ 的飞行径迹段的得分是 $w \\ell = \\ell$。一个有 $N$ 次碰撞的历史由 $N$ 个飞行径迹段 $L_1, \\ldots, L_N$ 组成。总得分是这些长度之和：\n$$\n\\Phi_{\\mathrm{TL,AN}} = \\sum_{i=1}^{N} L_i\n$$\n这是一个随机数量的独立同分布随机变量之和。其期望由 Wald's identity 给出：\n$$\n\\operatorname{E}[\\Phi_{\\mathrm{TL,AN}}] = \\operatorname{E}[N] \\operatorname{E}[L] = \\left(\\frac{\\Sigma_t}{\\Sigma_a}\\right) \\left(\\frac{1}{\\Sigma_t}\\right) = \\frac{1}{\\Sigma_a}\n$$\n其方差由 Blackwell-Girshick 方程（全方差定律的一个推论）给出：\n$$\n\\operatorname{Var}(\\Phi_{\\mathrm{TL,AN}}) = \\operatorname{E}[N] \\operatorname{Var}(L) + (\\operatorname{E}[L])^2 \\operatorname{Var}(N)\n$$\n代入已知值：\n$$\n\\operatorname{Var}(\\Phi_{\\mathrm{TL,AN}}) = \\left(\\frac{\\Sigma_t}{\\Sigma_a}\\right) \\left(\\frac{1}{\\Sigma_t^2}\\right) + \\left(\\frac{1}{\\Sigma_t}\\right)^2 \\left(\\frac{\\Sigma_s \\Sigma_t}{\\Sigma_a^2}\\right) = \\frac{1}{\\Sigma_a \\Sigma_t} + \\frac{\\Sigma_s}{\\Sigma_t \\Sigma_a^2}\n$$\n合并各项，使用公分母 $\\Sigma_t \\Sigma_a^2$：\n$$\n\\operatorname{Var}(\\Phi_{\\mathrm{TL,AN}}) = \\frac{\\Sigma_a}{\\Sigma_t \\Sigma_a^2} + \\frac{\\Sigma_s}{\\Sigma_t \\Sigma_a^2} = \\frac{\\Sigma_a + \\Sigma_s}{\\Sigma_t \\Sigma_a^2} = \\frac{\\Sigma_t}{\\Sigma_t \\Sigma_a^2} = \\frac{1}{\\Sigma_a^2}\n$$\n\n**第(ii)部分：存活偏倚**\n\n在存活偏倚下，每次碰撞都被强制为散射事件，并且粒子权重被降低。第 $k$ 次碰撞前（以及在第 $k$ 个飞行径迹段期间）的权重为 $w_k = c^{k-1}$，从 $w_1=1$ 开始。历史是一个无限的飞行和碰撞序列。\n\n**存活偏倚碰撞估计量 ($\\Phi_{\\mathrm{C,SB}}$)**\n第 $k$ 次碰撞的得分是 $w_k/\\Sigma_t = c^{k-1}/\\Sigma_t$。总得分是所有（无限次）碰撞得分之和：\n$$\n\\Phi_{\\mathrm{C,SB}} = \\sum_{k=1}^{\\infty} \\frac{w_k}{\\Sigma_t} = \\sum_{k=1}^{\\infty} \\frac{c^{k-1}}{\\Sigma_t}\n$$\n这是一个确定性几何级数。由于 $c  1$，该级数收敛：\n$$\n\\Phi_{\\mathrm{C,SB}} = \\frac{1}{\\Sigma_t} \\sum_{j=0}^{\\infty} c^j = \\frac{1}{\\Sigma_t} \\frac{1}{1-c} = \\frac{1}{\\Sigma_t} \\frac{1}{\\Sigma_a/\\Sigma_t} = \\frac{1}{\\Sigma_a}\n$$\n由于任何历史的得分都是一个恒定值 $1/\\Sigma_a$，所以该估计量没有统计涨落。\n其期望为：\n$$\n\\operatorname{E}[\\Phi_{\\mathrm{C,SB}}] = \\operatorname{E}\\left[\\frac{1}{\\Sigma_a}\\right] = \\frac{1}{\\Sigma_a}\n$$\n其方差为：\n$$\n\\operatorname{Var}(\\Phi_{\\mathrm{C,SB}}) = \\operatorname{Var}\\left(\\frac{1}{\\Sigma_a}\\right) = 0\n$$\n\n**存活偏倚径迹长度估计量 ($\\Phi_{\\mathrm{TL,SB}}$)**\n第 $k$ 个长度为 $L_k$ 的飞行径迹段的得分是 $w_k L_k = c^{k-1}L_k$。总得分是所有径迹段得分之和：\n$$\n\\Phi_{\\mathrm{TL,SB}} = \\sum_{k=1}^{\\infty} w_k L_k = \\sum_{k=1}^{\\infty} c^{k-1} L_k\n$$\n其中 $L_k$ 是独立同分布的指数随机变量。期望为：\n$$\n\\operatorname{E}[\\Phi_{\\mathrm{TL,SB}}] = \\operatorname{E}\\left[\\sum_{k=1}^{\\infty} c^{k-1} L_k\\right] = \\sum_{k=1}^{\\infty} c^{k-1} \\operatorname{E}[L_k] = \\operatorname{E}[L] \\sum_{k=1}^{\\infty} c^{k-1} = \\frac{1}{\\Sigma_t} \\frac{1}{1-c} = \\frac{1}{\\Sigma_a}\n$$\n由于和中的各项是独立的随机变量，和的方差是方差的和：\n$$\n\\operatorname{Var}(\\Phi_{\\mathrm{TL,SB}}) = \\operatorname{Var}\\left(\\sum_{k=1}^{\\infty} c^{k-1} L_k\\right) = \\sum_{k=1}^{\\infty} \\operatorname{Var}(c^{k-1} L_k) = \\sum_{k=1}^{\\infty} (c^{k-1})^2 \\operatorname{Var}(L_k)\n$$\n$$\n\\operatorname{Var}(\\Phi_{\\mathrm{TL,SB}}) = \\operatorname{Var}(L) \\sum_{k=1}^{\\infty} (c^2)^{k-1} = \\frac{1}{\\Sigma_t^2} \\sum_{j=0}^{\\infty} (c^2)^j\n$$\n该级数是公比为 $c^2  1$ 的几何级数，因此它收敛：\n$$\n\\operatorname{Var}(\\Phi_{\\mathrm{TL,SB}}) = \\frac{1}{\\Sigma_t^2} \\frac{1}{1-c^2} = \\frac{1}{\\Sigma_t^2(1 - (\\Sigma_s/\\Sigma_t)^2)} = \\frac{1}{\\Sigma_t^2 - \\Sigma_s^2}\n$$\n使用 $\\Sigma_t = \\Sigma_a + \\Sigma_s$，分母变为：\n$$\n\\Sigma_t^2 - \\Sigma_s^2 = (\\Sigma_a+\\Sigma_s)^2 - \\Sigma_s^2 = \\Sigma_a^2 + 2\\Sigma_a\\Sigma_s + \\Sigma_s^2 - \\Sigma_s^2 = \\Sigma_a^2 + 2\\Sigma_a\\Sigma_s = \\Sigma_a(\\Sigma_a + 2\\Sigma_s)\n$$\n因此，方差为：\n$$\n\\operatorname{Var}(\\Phi_{\\mathrm{TL,SB}}) = \\frac{1}{\\Sigma_a(\\Sigma_a + 2\\Sigma_s)}\n$$\n\n**第(iii)部分：方差比值**\n\n我们现在使用上面推导出的方差来构建所需的比值。\n\n径迹长度估计量的比值：\n$$\nR_{\\mathrm{TL}} = \\frac{\\operatorname{Var}_{\\mathrm{SB}}(\\Phi_{\\mathrm{TL}})}{\\operatorname{Var}_{\\mathrm{AN}}(\\Phi_{\\mathrm{TL}})} = \\frac{1 / (\\Sigma_a(\\Sigma_a + 2\\Sigma_s))}{1 / \\Sigma_a^2} = \\frac{\\Sigma_a^2}{\\Sigma_a(\\Sigma_a + 2\\Sigma_s)} = \\frac{\\Sigma_a}{\\Sigma_a + 2\\Sigma_s}\n$$\n\n碰撞估计量的比值：\n$$\nR_{\\mathrm{C}} = \\frac{\\operatorname{Var}_{\\mathrm{SB}}(\\Phi_{\\mathrm{C}})}{\\operatorname{Var}_{\\mathrm{AN}}(\\Phi_{\\mathrm{C}})} = \\frac{0}{\\Sigma_s / ((\\Sigma_a + \\Sigma_s) \\Sigma_a^2)}\n$$\n给定 $\\Sigma_a  0$。如果 $\\Sigma_s  0$，分母非零，因此 $R_{\\mathrm{C}} = 0$。如果 $\\Sigma_s = 0$，分子和分母都为 $0$。然而，该表达式必须对所有 $\\Sigma_s \\ge 0$ 成立。当 $\\Sigma_s \\to 0^+$ 时，比值仍为 $0$。因此，我们定义对于所有有效参数，$R_{\\mathrm{C}} = 0$。\n\n比值的最终结果是 $R_{\\mathrm{TL}} = \\frac{\\Sigma_a}{\\Sigma_a + 2\\Sigma_s}$ 和 $R_{\\mathrm{C}} = 0$。",
            "answer": "$$ \\boxed{ \\begin{pmatrix} \\frac{\\Sigma_a}{\\Sigma_a + 2\\Sigma_s}  0 \\end{pmatrix} } $$"
        },
        {
            "introduction": "在解决了粒子权重和存活问题后，我们可以转向更精细的方差缩减策略：偏倚源抽样，特别是在连续变量（如散射角）上的应用。本练习  模拟了一个实际的屏蔽问题，要求你设计并实现一种指数角向偏倚 (exponential angular biasing) 方案，以优先抽样那些更有可能到达探测器的前向散射路径。你需要编写代码，通过数值积分来量化该偏倚方案相比于标准模拟所带来的方差改善，从而将理论知识转化为解决实际计算问题的能力。",
            "id": "4259798",
            "problem": "一个快中子点探测器紧邻一个厚度为 $L$、垂直于 $z$ 轴的平行平面含氢屏蔽层的下游。一个准直的、单能的、前向发射的源入射到位于 $z=0$ 的上游表面。考虑单次碰撞近似，其中每个中子在板内发生恰好一次弹性碰撞，然后不再发生相互作用而穿行至位于 $z=L$ 的出口。该屏蔽层是均匀的，其宏观总截面为 $\\Sigma_t$。碰撞后中子方向相对于 $+z$ 轴的角余弦记为 $\\mu \\in [-1,1]$。只有 $\\mu0$ 的粒子才能对下游探测器产生贡献，该探测器记录单次散射后穿过平面 $z=L$ 的中子。\n\n假设在实验室坐标系中，$\\mu \\in [-1,1]$ 上的散射角概率密度函数 (PDF) 由以下一阶各向异性模型表示\n$$\np_0(\\mu) = \\frac{1 + a \\mu}{2},\n$$\n其中 $a \\in [-1,1]$ 是包含了材料和能量效应信息的各向异性参数。在快能区，含氢屏蔽层中氢和碳的混合物所产生的 $a$ 值范围涵盖了从近各向同性散射到前向峰化散射。将 $\\mu$ 的范围限制在 $[0,1]$，定义归一化的物理（模拟）散射后 PDF\n$$\np_0^+(\\mu) = \\frac{1 + a \\mu}{1 + \\frac{a}{2}}, \\quad \\mu \\in [0,1].\n$$\n在单次碰撞近似下，对于在深度 $x \\in [0,L]$ 发生的碰撞，当 $\\mu0$ 时，到达出口的自由飞行程长为 $(L-x)/\\mu$，相应的存活概率为 $\\exp\\!\\left(-\\Sigma_t \\frac{L-x}{\\mu}\\right)$。对碰撞深度 $x$ 进行均匀平均，得到接收-存活因子为\n$$\ng(\\mu; L, \\Sigma_t) = \\frac{1}{L} \\int_0^L \\exp\\!\\left(-\\Sigma_t \\frac{L-x}{\\mu}\\right) \\, dx = \n\\begin{cases}\n\\frac{\\mu}{\\Sigma_t L} \\left(1 - \\exp\\!\\left(-\\frac{\\Sigma_t L}{\\mu}\\right)\\right),  \\mu  0,\\\\\n0,  \\mu \\le 0.\n\\end{cases}\n$$\n\n通过重要性抽样进行的方差缩减，旨在寻找一个偏倚角 PDF $q(\\mu)$ 来对 $\\mu$ 进行抽样，同时为探测器响应 $S(L,\\Sigma_t,a)$ 保持一个无偏估计量 $w(\\mu) = \\frac{p_0^+(\\mu)}{q(\\mu)} g(\\mu;L,\\Sigma_t)$：\n$$\nS(L,\\Sigma_t,a) = \\int_0^1 p_0^+(\\mu) \\, g(\\mu;L,\\Sigma_t) \\, d\\mu.\n$$\n零方差解的目标是 $q(\\mu) \\propto p_0^+(\\mu) g(\\mu;L,\\Sigma_t)$，但这在实践中无法直接获得。一个强调前向峰化路径、具有物理动机的参数族是指数角偏倚：\n$$\nq_\\beta(\\mu) = \n\\begin{cases}\n\\displaystyle \\frac{\\beta}{e^{\\beta}-1} \\, e^{\\beta \\mu},  \\beta \\ne 0, \\\\\n1,  \\beta = 0,\n\\end{cases}\n\\quad \\mu \\in [0,1],\n$$\n其中 $\\beta \\ge 0$ 用于调节前向强调程度（越大的 $\\beta$ 会增强前向峰化）。这种函数形式的合理性在于，它近似了朝向下游探测器的伴随通量（该通量随着 $\\mu$ 的增大而增大，因为路径长度和衰减减小），以及指数倾斜在输运问题的重要性抽样中的普遍应用。\n\n对于任何固定的 $(L,\\Sigma_t,a,\\beta)$，在 $q_\\beta$ 分布下无偏估计量的方差为\n$$\n\\operatorname{Var}_{q_\\beta}[w] = \\mathbb{E}_{q_\\beta}\\!\\left[w(\\mu)^2\\right] - S(L,\\Sigma_t,a)^2\n= \\int_0^1 \\frac{p_0^+(\\mu)^2 \\, g(\\mu;L,\\Sigma_t)^2}{q_\\beta(\\mu)} \\, d\\mu \\;-\\; S(L,\\Sigma_t,a)^2.\n$$\n模拟（无偏倚）方差是通过从 $p_0^+(\\mu)$ 抽样 $\\mu$ 并使用估计量 $g(\\mu;L,\\Sigma_t)$ 得到的，其表达式为：\n$$\n\\operatorname{Var}_{\\text{analog}}[g] = \\int_0^1 p_0^+(\\mu) \\, g(\\mu;L,\\Sigma_t)^2 \\, d\\mu \\;-\\; S(L,\\Sigma_t,a)^2.\n$$\n定义相对方差比\n$$\nR(L,\\Sigma_t,a,\\beta) = \\frac{\\operatorname{Var}_{q_\\beta}[w]}{\\operatorname{Var}_{\\text{analog}}[g]},\n$$\n该比值为无量纲。$R  1$ 的值表示相对于模拟抽样有所改进。\n\n你的任务是编写一个完整的、可运行的程序，该程序针对以下测试套件，通过在 $\\mu \\in [0,1]$ 上使用稳定的求积法进行数值积分来计算 $R(L,\\Sigma_t,a,\\beta)$。以数值上稳健的方式处理 $g(\\mu;L,\\Sigma_t)$ 在 $\\mu \\to 0^+$ 附近的极限行为。所有长度必须以厘米 (cm) 表示；所有截面必须以反厘米 ($\\text{cm}^{-1}$) 表示。角度由无量纲的余弦 $\\mu$ 表示。\n\n测试套件参数集 $(L,\\Sigma_t,a,\\beta)$:\n1. $(20 \\text{ cm}, 0.10 \\text{ cm}^{-1}, 0.20, 2.0)$\n2. $(50 \\text{ cm}, 0.20 \\text{ cm}^{-1}, 0.00, 3.0)$\n3. $(20 \\text{ cm}, 0.10 \\text{ cm}^{-1}, -0.30, 2.0)$\n4. $(20 \\text{ cm}, 0.10 \\text{ cm}^{-1}, 0.20, 0.0)$\n5. $(30 \\text{ cm}, 0.15 \\text{ cm}^{-1}, -0.80, 6.0)$\n\n最终输出格式：你的程序应生成单行输出，其中包含一个方括号括起来的逗号分隔结果列表（例如，“[result1,result2,result3,result4,result5]”）。每个结果必须是四舍五入到六位小数的浮点数。",
            "solution": "该问题是有效的，因为它在科学上基于中子输运理论和蒙特卡洛方法，在数学上是适定的，并提供了一套完整且一致的定义和参数。任务是计算相对方差比 $R(L,\\Sigma_t,a,\\beta)$，该值量化了在一个简化的辐射屏蔽问题中，指数偏倚重要性抽样方案相对于模拟仿真的有效性。解决方案需要对碰撞后角余弦 $\\mu \\in [0,1]$ 上的三个不同积分进行数值评估。\n\n问题的核心是计算两个方差的比率：\n$$\nR(L,\\Sigma_t,a,\\beta) = \\frac{\\operatorname{Var}_{q_\\beta}[w]}{\\operatorname{Var}_{\\text{analog}}[g]} = \\frac{\\int_0^1 \\frac{p_0^+(\\mu)^2 \\, g(\\mu;L,\\Sigma_t)^2}{q_\\beta(\\mu)} \\, d\\mu \\;-\\; S(L,\\Sigma_t,a)^2}{\\int_0^1 p_0^+(\\mu) \\, g(\\mu;L,\\Sigma_t)^2 \\, d\\mu \\;-\\; S(L,\\Sigma_t,a)^2}.\n$$\n此计算分三个主要步骤进行：定义必要的函数，对积分进行数值评估，以及组合结果。\n\n首先，我们必须实现问题陈述中提供的数学函数。用于前向散射中子（$\\mu  0$）的归一化物理散射后概率密度函数 (PDF) 是：\n$$\np_0^+(\\mu) = \\frac{1 + a \\mu}{1 + a/2}, \\quad \\mu \\in [0,1].\n$$\n参数 $a$ 被限制在 $[-1,1]$ 范围内，确保分母 $1+a/2$ 始终为正，其值域为 $1/2$ 到 $3/2$。\n\n接收-存活因子 $g(\\mu; L, \\Sigma_t)$ 表示在板内随机深度处发生散射的中子，在不发生另一次碰撞的情况下到达出口平面的概率。其形式为：\n$$\ng(\\mu; L, \\Sigma_t) = \\frac{\\mu}{\\Sigma_t L} \\left(1 - \\exp\\left(-\\frac{\\Sigma_t L}{\\mu}\\right)\\right), \\quad \\mu  0.\n$$\n为了数值稳定性，我们必须考虑 $\\mu \\to 0^+$ 时的行为。在此极限下，指数的参数 $-\\frac{\\Sigma_t L}{\\mu}$ 会变成一个很大的负数，导致 $\\exp(-\\frac{\\Sigma_t L}{\\mu})$ 在浮点运算中下溢为零。此时函数可以安全地简化为 $g(\\mu; L, \\Sigma_t) \\approx \\frac{\\mu}{\\Sigma_t L}$。在 $\\mu=0$ 处的值恰好为 $0$，确保了函数的连续性。一个稳健的实现会在 $\\mu$ 非常小时切换到线性近似，以避免数值问题。为方便起见，我们定义光学厚度 $\\tau = \\Sigma_t L$。\n\n指数偏倚 PDF，$q_\\beta(\\mu)$，是用于重要性抽样的参数化函数：\n$$\nq_\\beta(\\mu) = \n\\begin{cases}\n\\displaystyle \\frac{\\beta}{e^{\\beta}-1} \\, e^{\\beta \\mu},  \\beta \\ne 0,\\\\\n1,  \\beta = 0,\n\\end{cases}\n\\quad \\mu \\in [0,1].\n$$\n这个函数在 $\\mu \\in [0,1]$ 上是正确归一化的。特殊情况 $\\beta=0$ 对应于均匀重要性抽样，这与从 $p_0^+(\\mu)$进行的物理（模拟）抽样是不同的。\n\n第二，我们构建计算 $R$ 所需的三个积分。\n1. 期望探测器响应 $S$，是模拟估计量 $g(\\mu)$ 相对于物理 PDF $p_0^+(\\mu)$ 的一阶矩：\n$$\nS(L,\\Sigma_t,a) = \\mathbb{E}_{p_0^+}[g] = \\int_0^1 p_0^+(\\mu) \\, g(\\mu;L,\\Sigma_t) \\, d\\mu.\n$$\n2. 偏倚估计量 $w(\\mu) = \\frac{p_0^+(\\mu)}{q_\\beta(\\mu)} g(\\mu)$ 的二阶矩，是计算分子方差所必需的：\n$$\n\\mathbb{E}_{q_\\beta}[w^2] = \\int_0^1 w(\\mu)^2 q_\\beta(\\mu) \\, d\\mu = \\int_0^1 \\frac{\\left(p_0^+(\\mu) \\, g(\\mu;L,\\Sigma_t)\\right)^2}{q_\\beta(\\mu)} \\, d\\mu.\n$$\n3. 模拟估计量的二阶矩，是计算分母方差所必需的：\n$$\n\\mathbb{E}_{\\text{analog}}[g^2] = \\mathbb{E}_{p_0^+}[g^2] = \\int_0^1 g(\\mu;L,\\Sigma_t)^2 \\, p_0^+(\\mu) \\, d\\mu.\n$$\n这些都是在有限域 $[0,1]$ 上的良态连续函数的定积分，因此适合使用标准数值求积法进行计算。\n\n第三，使用数值积分的结果，我们计算方差及其比率。偏倚估计量的方差为：\n$$\n\\operatorname{Var}_{q_\\beta}[w] = \\mathbb{E}_{q_\\beta}[w^2] - S^2.\n$$\n注意，偏倚估计量的期望为 $\\mathbb{E}_{q_\\beta}[w] = \\int_0^1 \\frac{p_0^+(\\mu)}{q_\\beta(\\mu)} g(\\mu) q_\\beta(\\mu) d\\mu = S$，这证实了它是一个无偏估计量。模拟估计量的方差为：\n$$\n\\operatorname{Var}_{\\text{analog}}[g] = \\mathbb{E}_{\\text{analog}}[g^2] - S^2.\n$$\n最终的相对方差比则计算为 $R = \\operatorname{Var}_{q_\\beta}[w] / \\operatorname{Var}_{\\text{analog}}[g]$。该实现将系统地将此过程应用于测试套件中的每个参数集，并使用高质量的数值积分程序来确保准确性。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import quad\n\ndef solve():\n    \"\"\"\n    Computes the relative variance ratio R for a simplified neutron transport problem\n    using an exponential biasing importance sampling scheme.\n    \"\"\"\n\n    def p_plus(mu: float, a: float) - float:\n        \"\"\"\n        Renormalized physical post-scatter PDF for mu in [0,1].\n        p_0^+(\\mu) = (1 + a*\\mu) / (1 + a/2)\n        \"\"\"\n        if not (0.0 = mu = 1.0):\n            return 0.0\n        # The constraint a in [-1, 1] ensures the denominator is non-zero.\n        return (1.0 + a * mu) / (1.0 + a / 2.0)\n\n    def g_func(mu: float, tau: float) - float:\n        \"\"\"\n        Acceptance-survival factor, g(\\mu; L, \\Sigma_t).\n        g = (\\mu / \\tau) * (1 - exp(-\\tau / \\mu))\n        tau is the optical thickness L * Sigma_t.\n        \"\"\"\n        if mu = 1e-12: # For mu -> 0+, g -> 0\n            return 0.0\n        \n        arg = tau / mu\n        # Use approximation for large arg to avoid underflow of exp(-arg)\n        # exp(-709) is near the limit of float64 precision.\n        if arg > 709.0:\n            return mu / tau\n        else:\n            return (mu / tau) * (1.0 - np.exp(-arg))\n\n    def q_beta(mu: float, beta: float) - float:\n        \"\"\"\n        Exponential biasing PDF for importance sampling.\n        q_\\beta(\\mu)\n        \"\"\"\n        if not (0.0 = mu = 1.0):\n            return 0.0\n            \n        if abs(beta)  1e-9: # Case beta = 0\n            return 1.0\n        else:\n            # The constraint beta >= 0 ensures the denominator is non-zero.\n            return (beta / (np.exp(beta) - 1.0)) * np.exp(beta * mu)\n\n    def calculate_R(L: float, Sigma_t: float, a: float, beta: float) - float:\n        \"\"\"\n        Calculates the relative variance ratio R for a given set of parameters.\n        \"\"\"\n        tau = L * Sigma_t\n\n        # Integrands for the three required integrals\n        # I1: S = E_p+[g]\n        integrand_S = lambda mu: p_plus(mu, a) * g_func(mu, tau)\n        \n        # I2: E_q[w^2] = integral of (p+ * g)^2 / q_beta\n        integrand_E_w_sq = lambda mu: (p_plus(mu, a) * g_func(mu, tau))**2 / q_beta(mu, beta)\n        \n        # I3: E_analog[g^2] = E_p+[g^2]\n        integrand_E_g_sq = lambda mu: p_plus(mu, a) * (g_func(mu, tau))**2\n\n        # Perform numerical integrations using scipy.integrate.quad\n        S, _ = quad(integrand_S, 0, 1, epsabs=1e-12, epsrel=1e-12)\n        E_w_sq, _ = quad(integrand_E_w_sq, 0, 1, epsabs=1e-12, epsrel=1e-12)\n        E_g_sq, _ = quad(integrand_E_g_sq, 0, 1, epsabs=1e-12, epsrel=1e-12)\n\n        # Calculate variances\n        var_q_beta = E_w_sq - S**2\n        var_analog = E_g_sq - S**2\n\n        # Calculate the relative variance ratio\n        # Avoid division by zero if analog variance is negligible\n        if abs(var_analog)  1e-30:\n            # If both variances are zero, the performance is identical (R=1).\n            # If only analog variance is zero, the ratio is infinite.\n            # This case is unlikely given the physical context.\n            return 1.0 if abs(var_q_beta)  1e-30 else np.inf\n        \n        R = var_q_beta / var_analog\n        return R\n\n    # Define the test cases from the problem statement.\n    # (L, Sigma_t, a, beta)\n    test_cases = [\n        (20.0, 0.10, 0.20, 2.0),\n        (50.0, 0.20, 0.00, 3.0),\n        (20.0, 0.10, -0.30, 2.0),\n        (20.0, 0.10, 0.20, 0.0),\n        (30.0, 0.15, -0.80, 6.0)\n    ]\n\n    results = []\n    for case in test_cases:\n        L, Sigma_t, a, beta = case\n        result = calculate_R(L, Sigma_t, a, beta)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.6f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}