{
    "hands_on_practices": [
        {
            "introduction": "在求解离散伴随方程 $A^T \\lambda = s^*$ 时，一个关键问题是理解离散算子 $A$ 及其转置 $A^T$ 的性质。本练习将通过一个具体的一维输运问题，展示像迎风格式这类符合物理直觉的离散化方法如何导致非自伴的系统矩阵。通过亲手推导并计算，您将能深入理解为何在构建伴随系统时，区分算子与其转置至关重要，并体会连续问题与离散模型之间的微妙差异。",
            "id": "4213510",
            "problem": "考虑一个厚度为 $L$ 的单能、稳态、一维平板输运问题，其在 $x=0$ 和 $x=L$ 处具有真空边界条件。按角度 $ \\mu \\in [-1,1] $ 的控制线性玻尔兹曼输运方程为\n$$\n\\mu \\frac{\\partial \\psi(x,\\mu)}{\\partial x} + \\Sigma_{t} \\psi(x,\\mu) = q(x,\\mu),\n$$\n其中总宏观截面 $\\Sigma_{t} > 0$。不存在散射。使用两点离散纵标（SN）方法对角变量进行离散化，具体为 $S_{2}$ 方法，其纵标为 $\\mu_{1} = \\frac{1}{\\sqrt{3}}$、$\\mu_{2} = -\\frac{1}{\\sqrt{3}}$，求积权重为 $w_{1} = 1$、 $w_{2} = 1$。将空间域离散为 $N=2$ 个宽度为 $h = \\frac{L}{2}$ 的均匀网格，并对流项使用一阶迎风有限体积格式，其中网格平均未知量为 $\\psi_{i}^{(m)}$，网格索引 $i \\in \\{1,2\\}$，纵标索引 $m \\in \\{1,2\\}$。\n\n1. 从每个网格的有限体积平衡出发，并对入射角通量施加真空边界条件，推导将未知量向量\n$$\n\\Psi \\equiv \\begin{pmatrix} \\psi_{1}^{(+)} \\\\ \\psi_{2}^{(+)} \\\\ \\psi_{1}^{(-)} \\\\ \\psi_{2}^{(-)} \\end{pmatrix}\n$$\n映射到网格平均、角度离散源向量\n$$\nQ \\equiv \\begin{pmatrix} q_{1}^{(+)} \\\\ q_{2}^{(+)} \\\\ q_{1}^{(-)} \\\\ q_{2}^{(-)} \\end{pmatrix}\n$$\n的 $4 \\times 4$ 离散算子矩阵 $L$，此映射通过 $L \\Psi = Q$ 实现，其中 $(+)$ 表示 $\\mu = \\mu_{1} = \\frac{1}{\\sqrt{3}}$，而 $(-)$ 表示 $\\mu = \\mu_{2} = -\\frac{1}{\\sqrt{3}}$。用 $h$、$\\Sigma_{t}$ 和 $\\mu$ 的符号形式表示 $L$。\n\n2. 定义由离散纵标（SN）求积和有限体积导出的离散内积为\n$$\n\\langle u, v \\rangle_{W} \\equiv u^{\\top} W v, \\quad W \\equiv \\operatorname{diag}(w_{1} h, w_{1} h, w_{2} h, w_{2} h).\n$$\n离散算子 $L$ 关于 $\\langle \\cdot, \\cdot \\rangle_{W}$ 是自伴的，当且仅当 $W L = L^{\\top} W$。考虑双线性形式\n$$\n\\delta(u,v) \\equiv u^{\\top} (W L - L^{\\top} W) v.\n$$\n选择 $u = e_{2}$ 和 $v = e_{1}$，其中 $e_{k}$ 是 $\\mathbb{R}^{4}$ 中的第 $k$ 个标准基向量，与上述 $\\Psi$ 中的排序一致。使用你推导的迎风离散化算子 $L$，计算在 $h = 1$ 和 $\\Sigma_{t} = \\frac{1}{2}$ 情况下的标量 $\\delta(u,v)$。\n\n3. 根据计算出的 $\\delta(u,v)$ 的符号和大小，简要解释迎风离散化如何产生一个非自伴的离散算子，从而破坏了在离散内积下，连续伴随算子与通过转置得到的离散伴随算子之间的等价性。\n\n最终答案应为 $\\delta(u,v)$ 的数值，四舍五入到四位有效数字，不带单位。解释应明确是哪个特定的非对角耦合产生了非零值，但最终答案只需报告该标量值。",
            "solution": "该问题经评估在科学上是合理的、适定的和客观的。这是数值输运理论中的一个标准问题，用于测试离散化算子的推导和性质。我们可以开始解答。\n\n根据问题陈述的要求，解答分为三个部分。\n\n第1部分：离散算子矩阵 $L$ 的推导。\n\n一维稳态线性玻尔兹曼输运方程由下式给出：\n$$ \\mu \\frac{\\partial \\psi(x,\\mu)}{\\partial x} + \\Sigma_{t} \\psi(x,\\mu) = q(x,\\mu) $$\n我们使用有限体积法，在具有两个宽度为 $h = \\frac{L}{2}$ 的网格（$i=1$ 和 $i=2$）的均匀网格上对此方程进行离散化。这些网格分别覆盖区域 $[0, h]$ 和 $[h, 2h]$。在网格 $i$ 上（从 $x_{i-1/2}$ 到 $x_{i+1/2}$）对输运方程进行积分，得到平衡方程：\n$$ \\int_{x_{i-1/2}}^{x_{i+1/2}} \\left( \\mu \\frac{\\partial \\psi}{\\partial x} + \\Sigma_{t} \\psi \\right) dx = \\int_{x_{i-1/2}}^{x_{i+1/2}} q \\, dx $$\n对流项应用散度定理，然后除以网格宽度 $h$ 得到：\n$$ \\frac{\\mu}{h} \\left( \\psi_{i+1/2} - \\psi_{i-1/2} \\right) + \\Sigma_{t} \\psi_{i} = q_{i} $$\n此处，$\\psi_i$ 和 $q_i$ 分别是网格平均角通量和源项，而 $\\psi_{i\\pm1/2}$ 是网格界面处的角通量。\n\n一阶迎风格式使用来自迎风网格的网格平均通量来近似界面通量。“迎风”的方向取决于角变量 $\\mu$ 的符号。\n\n角离散化使用 $S_2$ 方法进行，其纵标为 $\\mu_1 = 1/\\sqrt{3} > 0$ 和 $\\mu_2 = -1/\\sqrt{3} < 0$，权重为 $w_1=w_2=1$。我们使用符号 $\\psi^{(+)}$ 表示方向 $\\mu_1$ 上的通量，$\\psi^{(-)}$ 表示方向 $\\mu_2$ 上的通量。\n\n情况1：正纵标 $\\mu = \\mu_1 > 0$（方向用 $(+)$ 表示）。\n粒子流从左到右。\n对于网格 $i=1$（区域 $[0, h]$）：\n平衡方程为 $\\frac{\\mu_1}{h} ( \\psi_{3/2}^{(+)} - \\psi_{1/2}^{(+)} ) + \\Sigma_t \\psi_1^{(+)} = q_1^{(+)}$。\n界面位于 $x_{1/2}=0$ 和 $x_{3/2}=h$。\n在 $x_{3/2}=h$ 处的出射通量的迎风近似为 $\\psi_{3/2}^{(+)} \\approx \\psi_1^{(+)}$。\n在 $x=0$ 处的真空边界条件意味着入射通量为零，因此 $\\psi_{1/2}^{(+)} = 0$。\n将这些代入平衡方程得到：\n$$ \\frac{\\mu_1}{h} (\\psi_1^{(+)} - 0) + \\Sigma_t \\psi_1^{(+)} = q_1^{(+)} \\implies \\left(\\frac{\\mu_1}{h} + \\Sigma_t\\right) \\psi_1^{(+)} = q_1^{(+)} $$\n\n对于网格 $i=2$（区域 $[h, 2h]$）：\n平衡方程为 $\\frac{\\mu_1}{h} ( \\psi_{5/2}^{(+)} - \\psi_{3/2}^{(+)} ) + \\Sigma_t \\psi_2^{(+)} = q_2^{(+)}$。\n界面位于 $x_{3/2}=h$ 和 $x_{5/2}=2h=L$。\n在 $x_{5/2}=L$ 处的出射通量的迎风近似为 $\\psi_{5/2}^{(+)} \\approx \\psi_2^{(+)}$。\n在 $x_{3/2}=h$ 处的入射通量的迎风近似为 $\\psi_{3/2}^{(+)} \\approx \\psi_1^{(+)}$。\n将这些代入得到：\n$$ \\frac{\\mu_1}{h} (\\psi_2^{(+)} - \\psi_1^{(+)}) + \\Sigma_t \\psi_2^{(+)} = q_2^{(+)} \\implies -\\frac{\\mu_1}{h} \\psi_1^{(+)} + \\left(\\frac{\\mu_1}{h} + \\Sigma_t\\right) \\psi_2^{(+)} = q_2^{(+)} $$\n\n情况2：负纵标 $\\mu = \\mu_2 < 0$（方向用 $(-)$ 表示）。\n粒子流从右到左。注意 $\\mu_2 = -\\mu_1$。\n对于网格 $i=2$（区域 $[h, 2h]$）：\n平衡方程为 $\\frac{\\mu_2}{h} ( \\psi_{5/2}^{(-)} - \\psi_{3/2}^{(-)} ) + \\Sigma_t \\psi_2^{(-)} = q_2^{(-)}$。\n在 $x=L=2h$ 处的真空边界条件意味着入射通量为零，因此 $\\psi_{5/2}^{(-)} = 0$。\n在 $x_{3/2}=h$ 处的出射通量的迎风近似为 $\\psi_{3/2}^{(-)} \\approx \\psi_2^{(-)}$。\n将这些代入得到：\n$$ \\frac{\\mu_2}{h} (0 - \\psi_2^{(-)}) + \\Sigma_t \\psi_2^{(-)} = q_2^{(-)} \\implies \\left(-\\frac{\\mu_2}{h} + \\Sigma_t\\right) \\psi_2^{(-)} = q_2^{(-)} $$\n使用 $\\mu_2 = -\\mu_1$，这变为 $\\left(\\frac{\\mu_1}{h} + \\Sigma_t\\right) \\psi_2^{(-)} = q_2^{(-)}$。\n\n对于网格 $i=1$（区域 $[0, h]$）：\n平衡方程为 $\\frac{\\mu_2}{h} ( \\psi_{3/2}^{(-)} - \\psi_{1/2}^{(-)} ) + \\Sigma_t \\psi_1^{(-)} = q_1^{(-)}$。\n在 $x_{3/2}=h$ 处的入射通量的迎风近似为 $\\psi_{3/2}^{(-)} \\approx \\psi_2^{(-)}$。\n在 $x_{1/2}=0$ 处的出射通量的迎风近似为 $\\psi_{1/2}^{(-)} \\approx \\psi_1^{(-)}$。\n将这些代入得到：\n$$ \\frac{\\mu_2}{h} (\\psi_2^{(-)} - \\psi_1^{(-)}) + \\Sigma_t \\psi_1^{(-)} = q_1^{(-)} \\implies \\left(-\\frac{\\mu_2}{h} + \\Sigma_t\\right) \\psi_1^{(-)} + \\frac{\\mu_2}{h} \\psi_2^{(-)} = q_1^{(-)} $$\n使用 $\\mu_2 = -\\mu_1$，这变为 $\\left(\\frac{\\mu_1}{h} + \\Sigma_t\\right) \\psi_1^{(-)} - \\frac{\\mu_1}{h} \\psi_2^{(-)} = q_1^{(-)}$。\n\n我们现在将这四个方程组合成矩阵系统 $L\\Psi = Q$，其中未知量 $\\Psi = [\\psi_{1}^{(+)}, \\psi_{2}^{(+)}, \\psi_{1}^{(-)}, \\psi_{2}^{(-)}]^{\\top}$ 和源项 $Q = [q_{1}^{(+)}, q_{2}^{(+)}, q_{1}^{(-)}, q_{2}^{(-)}]^{\\top}$ 的顺序已指定。为清晰起见，根据问题陈述的上下文，令 $\\mu$ 代表 $\\mu_1$。矩阵 $L$ 是：\n$$\nL = \\begin{pmatrix}\n\\frac{\\mu}{h} + \\Sigma_{t} & 0 & 0 & 0 \\\\\n-\\frac{\\mu}{h} & \\frac{\\mu}{h} + \\Sigma_{t} & 0 & 0 \\\\\n0 & 0 & \\frac{\\mu}{h} + \\Sigma_{t} & -\\frac{\\mu}{h} \\\\\n0 & 0 & 0 & \\frac{\\mu}{h} + \\Sigma_{t}\n\\end{pmatrix}\n$$\n\n第2部分：$\\delta(u,v)$ 的计算。\n\n衡量非自伴性的双线性形式为 $\\delta(u,v) = u^{\\top} (W L - L^{\\top} W) v$。\n给定 $u = e_{2} = [0, 1, 0, 0]^{\\top}$ 和 $v = e_{1} = [1, 0, 0, 0]^{\\top}$。\n权重矩阵 $W$ 定义为 $W = \\operatorname{diag}(w_{1} h, w_{1} h, w_{2} h, w_{2} h)$。由于 $w_1 = 1$ 和 $w_2 = 1$，这简化为 $W = \\operatorname{diag}(h, h, h, h) = h I$，其中 $I$ 是 $4 \\times 4$ 的单位矩阵。\n\n$\\delta(e_2, e_1)$ 的表达式是矩阵 $WL - L^\\top W$ 的 $(2,1)$ 元。\n我们来计算这个矩阵：\n$$ W L = (hI) L = h L $$\n$$ L^\\top W = L^\\top (hI) = h L^\\top $$\n所以，$WL - L^\\top W = h(L - L^\\top)$。\n代入第1部分的矩阵 $L$（其中 $\\mu=\\mu_1$）：\n$$\nL - L^\\top = \\begin{pmatrix}\nA & 0 & 0 & 0 \\\\ -B & A & 0 & 0 \\\\ 0 & 0 & A & -B \\\\ 0 & 0 & 0 & A\n\\end{pmatrix} - \\begin{pmatrix}\nA & -B & 0 & 0 \\\\ 0 & A & 0 & 0 \\\\ 0 & 0 & A & 0 \\\\ 0 & 0 & -B & A\n\\end{pmatrix}\n= \\begin{pmatrix}\n0 & B & 0 & 0 \\\\ -B & 0 & 0 & 0 \\\\ 0 & 0 & 0 & -B \\\\ 0 & 0 & B & 0\n\\end{pmatrix}\n$$\n其中 $A = \\frac{\\mu}{h} + \\Sigma_{t}$ 且 $B = \\frac{\\mu}{h}$。\n那么，\n$$ WL - L^\\top W = h(L - L^\\top) = h \\begin{pmatrix}\n0 & \\frac{\\mu}{h} & 0 & 0 \\\\ -\\frac{\\mu}{h} & 0 & 0 & 0 \\\\ 0 & 0 & 0 & -\\frac{\\mu}{h} \\\\ 0 & 0 & \\frac{\\mu}{h} & 0\n\\end{pmatrix}\n= \\begin{pmatrix}\n0 & \\mu & 0 & 0 \\\\ -\\mu & 0 & 0 & 0 \\\\ 0 & 0 & 0 & -\\mu \\\\ 0 & 0 & \\mu & 0\n\\end{pmatrix}\n$$\n量 $\\delta(e_2, e_1)$ 是该矩阵第二行第一列的元素，即 $(WL - L^\\top W)_{21}$。\n$$ \\delta(e_2, e_1) = -\\mu = -\\mu_1 $$\n计算是在 $h=1$ 和 $\\Sigma_t=1/2$ 的情况下进行的。结果 $\\delta(e_2, e_1) = -\\mu_1$ 与 $h$ 和 $\\Sigma_t$ 均无关。\n给定 $\\mu_1 = \\frac{1}{\\sqrt{3}}$，我们有：\n$$ \\delta(e_2, e_1) = -\\frac{1}{\\sqrt{3}} \\approx -0.577350269... $$\n四舍五入到四位有效数字，值为 $-0.5774$。\n\n第3部分：非自伴性的解释。\n\n离散算子 $L$ 关于内积 $\\langle \\cdot, \\cdot \\rangle_W$ 是自伴的，当且仅当对所有向量 $u, v$ 都有 $\\langle u, Lv \\rangle_W = \\langle Lu, v \\rangle_W$。这等价于矩阵条件 $WL = L^\\top W$。双线性形式 $\\delta(u,v) = \\langle u, Lv \\rangle_W - \\langle Lu, v \\rangle_W$ 是对此条件不成立的直接度量。\n\n我们在第2部分的计算得出 $\\delta(e_2, e_1) = -\\mu_1 \\neq 0$。这个非零结果表明 $L$ 不是一个自伴算子。\n\n这种非自伴性的物理和数值根源在于流项 $\\mu \\frac{\\partial \\psi}{\\partial x}$ 的迎风离散化。迎风格式通过创建一个非对称模板来模拟粒子输运的方向性。\n我们来检查产生非零结果的具体项。$\\delta(e_2, e_1) = (WL - L^{\\top}W)_{21} = h(L_{21} - L_{12})$。从 $L$ 的推导中我们发现 $L_{21} = -\\mu/h$ 且 $L_{12} = 0$。\n项 $L_{21}$ 表示在正方向 $\\mu > 0$ 上，网格1中的通量($\\psi_1^{(+)}$)对网格2中粒子平衡的影响。这种耦合的产生是因为粒子物理上从网格1流向网格2。\n项 $L_{12}$ 本应表示在同一正方向上，网格2中的通量($\\psi_2^{(+)}$)对网格1中粒子平衡的影响。迎风格式正确地将此项设置为零，因为对于 $\\mu > 0$，信息不会从网格2向后流动到网格1。\n\n离散算子 $L$ 中的这种内在不对称性 ($L_{21} \\neq L_{12}$) 是对有方向的物理过程进行建模的直接结果。一个对称算子 ($L=L^\\top$) 将意味着网格1对网格2的影响与网格2对网格1的影响相同，这与输运物理学相矛盾。由于权重矩阵 $W$ 是单位矩阵的标量倍数 ($W=hI$)， $L$ 的非对称性直接导致其非自伴性 ($L \\neq L^\\top \\implies L \\neq W^{-1}L^\\top W$)。\n\n输运的连续伴随算子 $\\mathcal{L}^\\ast = -\\mu \\frac{\\partial}{\\partial x} + \\Sigma_t$ 描述了反向 $(-\\mu)$ 的输运。离散伴随算子 $L^\\ast = W^{-1}L^\\top W$ 是对此伴随物理的正确离散化。$L \\neq L^\\ast$ 这一事实是一个关键特征，确保了离散模型能够区分正向和伴随输运问题。这种非自伴性是输运物理方向性的直接体现，与自伴问题中算子的对称性形成了鲜明对比。\n计算值 $\\delta(e_2,e_1) = -\\mu_1$ 量化了对于正向流动的通量，网格1和2之间特定相互作用中被破坏的对称性。",
            "answer": "$$ \\boxed{-0.5774} $$"
        },
        {
            "introduction": "伴随方法的威力在于它提供了一个高效计算灵敏度的公式，$\\delta J \\approx -\\langle \\psi, \\delta L \\phi \\rangle$，无需重新求解受扰动后的状态。本练习设定了一个已预先解出正向通量和伴随通量分布的场景，让您能够专注于应用一阶微扰理论的核心公式。这个计算将帮助您掌握如何利用伴随解（“重要性函数”）来评估局部参数变化对全局响应的精确影响。",
            "id": "4213547",
            "problem": "我们考虑一个在一维无量纲平板区域 $x \\in [0,1]$ 上的稳态双能群中子扩散模型，其边界条件为真空边界条件。每个能群中的中子平衡由多群扩散方程决定，该方程源自粒子守恒和菲克(Fick)扩散定律：泄漏和吸收造成的损失与入射散射和外源带来的增益相平衡。具体来说，正演状态 $\\{\\phi_{g}(x)\\}_{g=1}^{2}$ 满足以下形式的线性算子方程\n$$\n\\mathcal{L}(\\boldsymbol{p})\\,\\boldsymbol{\\phi} = \\boldsymbol{q},\n$$\n其中 $\\boldsymbol{\\phi} = (\\phi_{1},\\phi_{2})^{\\top}$ 是能群通量矢量，$\\boldsymbol{q} = (q_{1},q_{2})^{\\top}$ 是外源矢量，$\\boldsymbol{p}$ 表示材料参数集，包括群吸收截面 $\\Sigma_{a,1}(x)$ 和 $\\Sigma_{a,2}(x)$、扩散系数 $D_{1}(x)$ 和 $D_{2}(x)$ 以及散射截面 $\\Sigma_{s,1\\to 2}(x)$ 和 $\\Sigma_{s,2\\to 1}(x)$。算子 $\\mathcal{L}(\\boldsymbol{p})$ 包含了泄漏项 $-\\frac{d}{dx}\\left(D_{g}(x)\\frac{d \\phi_{g}}{dx}\\right)$、吸收项 $\\Sigma_{a,g}(x)\\phi_{g}$ 和群间散射项。\n\n我们关注的性能指标是在响应区域 $\\Omega_{R} \\subset [0,1]$ 上的无量纲区域积分功率，其定义为\n$$\nP_{R}(\\boldsymbol{\\phi}) = \\int_{\\Omega_{R}} \\sum_{g=1}^{2} \\alpha_{g}\\,\\phi_{g}(x)\\,dx,\n$$\n其中 $\\alpha_{g} > 0$ 是固定的逐群权重，与每次裂变释放的能量和群 $g$ 中的有效裂变产额成正比。对于本问题，取 $\\Omega_{R} = [0.25,0.50]$，$\\alpha_{1} = 0.30$，$\\alpha_{2} = 1.00$。\n\n在微扰子区域 $\\Omega_{p} = [0.40,0.50]$ 内，对第2群吸收截面 $\\Sigma_{a,2}(x)$ 施加一个小的局部微扰，而所有其他材料参数保持不变。假设与响应 $P_{R}$ 相关的正演状态 $\\boldsymbol{\\phi}$ 和对应的伴随状态 $\\boldsymbol{\\psi} = (\\psi_{1},\\psi_{2})^{\\top}$ 已经针对未受扰动构型求解完毕并已给出。伴随状态由伴随算子方程定义\n$$\n\\mathcal{L}^{\\dagger}(\\boldsymbol{p})\\,\\boldsymbol{\\psi} = \\boldsymbol{r},\n$$\n其中 $\\boldsymbol{r}(x)$ 是响应权重矢量，使得 $P_{R}(\\boldsymbol{\\phi}) = \\left\\langle \\boldsymbol{r},\\boldsymbol{\\phi}\\right\\rangle$（使用定义域上的标准 $L^{2}$ 内积），且 $\\mathcal{L}^{\\dagger}$ 表示 $\\mathcal{L}$ 在相同内积下的伴随算子。对于给定的响应，$\\boldsymbol{r}(x)$ 的分量为 $r_{g}(x) = \\alpha_{g}\\,\\chi_{\\Omega_{R}}(x)$，其中 $\\chi_{\\Omega_{R}}(x)$ 是 $\\Omega_{R}$ 的指示函数。\n\n在微扰子区域 $\\Omega_{p}$ 上，给出的无量纲正演解和伴随解是常数，等于\n$$\n\\phi_{2}(x) = 0.75 \\quad \\text{for all } x \\in \\Omega_{p}, \\qquad \\psi_{2}(x) = 1.80 \\quad \\text{for all } x \\in \\Omega_{p}.\n$$\n在 $\\Omega_{p}$ 之外，$\\phi_{2}(x)$ 和 $\\psi_{2}(x)$ 的值对于此计算是不需要的。第1群的解是不需要的，因为只有 $\\Sigma_{a,2}$ 受到微扰。\n\n使用基于伴随的一阶微扰理论，根据正演算子的线性性质和给定响应的伴随问题定义，从第一性原理推导无量纲区域积分功率 $P_{R}$ 对仅施加于 $\\Omega_{p}$ 上的小的均匀微扰 $\\delta \\Sigma_{a,2}$ 的灵敏度。然后，计算灵敏度系数的数值\n$$\nS_{2} \\equiv \\frac{dP_{R}}{d\\Sigma_{a,2}\\big|_{\\Omega_{p}}},\n$$\n使用给出的正演解和伴随解。将最终数值答案四舍五入到四位有效数字。由于所有变量都已无量纲化，因此该灵敏度是无量纲的。最后，基于内在的中子平衡，从物理角度解释 $S_{2}$ 的符号。",
            "solution": "本题要求使用基于伴随的一阶微扰理论，推导并计算区域积分功率响应 $P_{R}$ 对第2群吸收截面 $\\Sigma_{a,2}$ 中局部微扰的灵敏度。\n\n首先，我们推导灵敏度的一般表达式。该系统由线性正演算子方程描述：\n$$\n\\mathcal{L}(\\boldsymbol{p})\\,\\boldsymbol{\\phi} = \\boldsymbol{q}\n$$\n其中 $\\boldsymbol{\\phi}$ 是中子通量矢量，$\\boldsymbol{p}$ 是材料参数集，$\\boldsymbol{q}$ 是外源矢量，$\\mathcal{L}$ 是双能群中子扩散算子。参数中的一个微小扰动 $\\boldsymbol{p} \\to \\boldsymbol{p} + \\delta\\boldsymbol{p}$ 会引起算子的变化 $\\mathcal{L} \\to \\mathcal{L} + \\delta\\mathcal{L}$，以及通量的相应变化 $\\boldsymbol{\\phi} \\to \\boldsymbol{\\phi} + \\delta\\boldsymbol{\\phi}$。受扰系统由以下方程描述：\n$$\n(\\mathcal{L} + \\delta\\mathcal{L})(\\boldsymbol{\\phi} + \\delta\\boldsymbol{\\phi}) = \\boldsymbol{q}\n$$\n展开此方程得到：\n$$\n\\mathcal{L}\\boldsymbol{\\phi} + \\mathcal{L}\\delta\\boldsymbol{\\phi} + \\delta\\mathcal{L}\\boldsymbol{\\phi} + \\delta\\mathcal{L}\\delta\\boldsymbol{\\phi} = \\boldsymbol{q}\n$$\n减去未受扰动方程 $\\mathcal{L}\\boldsymbol{\\phi} = \\boldsymbol{q}$ 并忽略二阶项 $\\delta\\mathcal{L}\\delta\\boldsymbol{\\phi}$，得到通量微扰的一阶近似：\n$$\n\\mathcal{L}\\delta\\boldsymbol{\\phi} \\approx -\\delta\\mathcal{L}\\boldsymbol{\\phi}\n$$\n我们关注的响应是积分功率 $P_{R}$，它是通量的线性泛函：\n$$\nP_{R}(\\boldsymbol{\\phi}) = \\left\\langle \\boldsymbol{r}, \\boldsymbol{\\phi} \\right\\rangle = \\int_{0}^{1} \\boldsymbol{r}^{\\top}(x)\\boldsymbol{\\phi}(x)\\,dx\n$$\n响应的微扰 $\\delta P_{R}$ 由下式给出：\n$$\n\\delta P_{R} = P_{R}(\\boldsymbol{\\phi} + \\delta\\boldsymbol{\\phi}) - P_{R}(\\boldsymbol{\\phi}) = P_{R}(\\delta\\boldsymbol{\\phi}) = \\left\\langle \\boldsymbol{r}, \\delta\\boldsymbol{\\phi} \\right\\rangle\n$$\n伴随问题由 $\\mathcal{L}^{\\dagger}\\boldsymbol{\\psi} = \\boldsymbol{r}$ 定义，其中 $\\mathcal{L}^{\\dagger}$ 是 $\\mathcal{L}$ 关于内积 $\\left\\langle \\cdot, \\cdot \\right\\rangle$ 的伴随算子。伴随算子的定义性质是，对于适当空间中的任意函数 $\\boldsymbol{u}, \\boldsymbol{v}$，有 $\\left\\langle \\mathcal{L}^{\\dagger}\\boldsymbol{u}, \\boldsymbol{v} \\right\\rangle = \\left\\langle \\boldsymbol{u}, \\mathcal{L}\\boldsymbol{v} \\right\\rangle$。\n使用伴随方程和这个性质，我们可以重写 $\\delta P_{R}$：\n$$\n\\delta P_{R} = \\left\\langle \\boldsymbol{r}, \\delta\\boldsymbol{\\phi} \\right\\rangle = \\left\\langle \\mathcal{L}^{\\dagger}\\boldsymbol{\\psi}, \\delta\\boldsymbol{\\phi} \\right\\rangle = \\left\\langle \\boldsymbol{\\psi}, \\mathcal{L}\\delta\\boldsymbol{\\phi} \\right\\rangle\n$$\n代入 $\\mathcal{L}\\delta\\boldsymbol{\\phi}$ 的一阶近似：\n$$\n\\delta P_{R} \\approx \\left\\langle \\boldsymbol{\\psi}, -\\delta\\mathcal{L}\\boldsymbol{\\phi} \\right\\rangle = -\\left\\langle \\boldsymbol{\\psi}, \\delta\\mathcal{L}\\boldsymbol{\\phi} \\right\\rangle\n$$\n这是一阶微扰理论的通用公式。现在，我们必须为给定问题指定算子微扰 $\\delta\\mathcal{L}$。该微扰是对局限于子区域 $\\Omega_{p} = [0.40, 0.50]$ 内的第2群吸收截面 $\\Sigma_{a,2}(x)$ 的一个均匀变化 $\\delta\\Sigma_{a,2}$。正演方程中第2群的吸收项是 $\\Sigma_{a,2}(x)\\phi_{2}(x)$。因此，一个微扰 $\\delta\\Sigma_{a,2}(x)$ 会改变算子 $\\mathcal{L}$，使其作用于 $\\boldsymbol{\\phi}$ 时产生一个附加项。算子微扰 $\\delta\\mathcal{L}$ 作用于通量矢量 $\\boldsymbol{\\phi}$ 的形式如下：\n$$\n\\delta\\mathcal{L}\\boldsymbol{\\phi} = \\begin{pmatrix} 0 \\\\ \\delta\\Sigma_{a,2}(x)\\phi_{2}(x) \\end{pmatrix}\n$$\n在本例中，$\\delta\\Sigma_{a,2}(x) = \\delta\\Sigma_{a,2} \\cdot \\chi_{\\Omega_{p}}(x)$，其中 $\\chi_{\\Omega_{p}}(x)$ 是区域 $\\Omega_{p}$ 的指示函数，$\\delta\\Sigma_{a,2}$ 是微扰的常数幅度。\n\n我们现在计算内积 $\\left\\langle \\boldsymbol{\\psi}, \\delta\\mathcal{L}\\boldsymbol{\\phi} \\right\\rangle$：\n$$\n\\left\\langle \\boldsymbol{\\psi}, \\delta\\mathcal{L}\\boldsymbol{\\phi} \\right\\rangle = \\int_{0}^{1} \\boldsymbol{\\psi}^{\\top}(x) (\\delta\\mathcal{L}\\boldsymbol{\\phi})(x) \\,dx = \\int_{0}^{1} \\begin{pmatrix} \\psi_{1}(x) & \\psi_{2}(x) \\end{pmatrix} \\begin{pmatrix} 0 \\\\ \\delta\\Sigma_{a,2}(x)\\phi_{2}(x) \\end{pmatrix} \\,dx\n$$\n$$\n\\left\\langle \\boldsymbol{\\psi}, \\delta\\mathcal{L}\\boldsymbol{\\phi} \\right\\rangle = \\int_{0}^{1} \\psi_{2}(x) \\phi_{2}(x) \\delta\\Sigma_{a,2}(x) \\,dx = \\int_{\\Omega_{p}} \\psi_{2}(x) \\phi_{2}(x) \\delta\\Sigma_{a,2} \\,dx\n$$\n由于 $\\delta\\Sigma_{a,2}$ 在 $\\Omega_{p}$ 上是常数，我们有：\n$$\n\\left\\langle \\boldsymbol{\\psi}, \\delta\\mathcal{L}\\boldsymbol{\\phi} \\right\\rangle = \\delta\\Sigma_{a,2} \\int_{\\Omega_{p}} \\psi_{2}(x) \\phi_{2}(x) \\,dx\n$$\n因此，响应的微扰为：\n$$\n\\delta P_{R} \\approx -\\delta\\Sigma_{a,2} \\int_{\\Omega_{p}} \\psi_{2}(x) \\phi_{2}(x) \\,dx\n$$\n灵敏度系数 $S_{2}$ 定义为 $P_{R}$ 对 $\\Omega_{p}$ 上微扰幅度 $\\Sigma_{a,2}$ 的导数。这可以通过在 $\\delta\\Sigma_{a,2} \\to 0$ 的极限下，将 $\\delta P_{R}$ 除以 $\\delta\\Sigma_{a,2}$ 得到：\n$$\nS_{2} \\equiv \\frac{dP_{R}}{d\\Sigma_{a,2}\\big|_{\\Omega_{p}}} = \\lim_{\\delta\\Sigma_{a,2}\\to 0} \\frac{\\delta P_{R}}{\\delta\\Sigma_{a,2}} = - \\int_{\\Omega_{p}} \\psi_{2}(x) \\phi_{2}(x) \\,dx\n$$\n这是推导出的灵敏度系数表达式。\n\n为了计算数值，我们使用给定的数据。在微扰子区域 $\\Omega_{p} = [0.40, 0.50]$ 上，正演通量和伴随通量是常数：\n$$\n\\phi_{2}(x) = 0.75 \\quad \\text{for } x \\in \\Omega_{p}\n$$\n$$\n\\psi_{2}(x) = 1.80 \\quad \\text{for } x \\in \\Omega_{p}\n$$\n将这些值代入 $S_{2}$ 的表达式：\n$$\nS_{2} = - \\int_{0.40}^{0.50} (1.80)(0.75) \\,dx\n$$\n由于被积函数是常数，我们可以将其从积分中提出：\n$$\nS_{2} = - (1.80)(0.75) \\int_{0.40}^{0.50} dx = - (1.80)(0.75) (0.50 - 0.40)\n$$\n$$\nS_{2} = - (1.35)(0.10) = -0.135\n$$\n题目要求答案四舍五入到四位有效数字。因此，$S_{2} = -0.1350$。\n\n最后，我们解释 $S_{2}$ 的符号。灵敏度为负。这表明第2群吸收截面的增加（$\\delta\\Sigma_{a,2} > 0$）将导致积分功率响应的减少（$\\delta P_{R} < 0$）。这在物理上是一致的。吸收截面 $\\Sigma_{a,2}$ 量化了第2群中子因吸收而从系统中被移除的速率。增加该截面会增强中子吸收，从而减少第2群中子的数量，而中子数量是由通量 $\\phi_2(x)$ 来衡量的。响应 $P_{R}$ 被定义为通量的正权重积分。因此，$\\phi_{2}$（以及任何与之耦合的其他通量）的减少将导致 $P_{R}$ 的减少。伴随通量 $\\psi_{2}(x)$ 代表了位置 $x$ 处一个第2群中子对响应 $P_{R}$ 的“重要性”。由于通量和重要性在物理上都是非负量，它们的乘积也是非负的。灵敏度公式中的负号是吸收作为中子的一种损失机制的直接结果。",
            "answer": "$$\\boxed{-0.1350}$$"
        },
        {
            "introduction": "理论学习最终需要通过编程实践来巩固。这项综合性练习将指导您为一个二维扩散-漂移问题编写程序，并同时使用正向和伴随两种方法计算响应的灵敏度。通过这种方式，您不仅能直接验证两种方法结果的一致性，还能深入体会它们在计算流程、数值效率和内存使用上的差异，特别是如何通过复用矩阵分解来高效求解伴随系统。",
            "id": "4213490",
            "problem": "考虑在狄利克雷边界条件下的均匀矩形域中的稳态单群中子平衡，其无量纲形式写为扩散-漂移-吸收方程。当在均匀笛卡尔网格上使用二阶中心差分对扩散项进行离散，并使用一阶迎风格式对流项进行离散时，得到的代数系统可以写为\n$$\nA(p)\\,\\phi(p) = q,\n$$\n其中 $A(p) \\in \\mathbb{R}^{n \\times n}$ 是刚度矩阵，$p$ 是表示吸收截面的标量参数，$\\phi(p) \\in \\mathbb{R}^{n}$ 是通量向量，$q \\in \\mathbb{R}^{n}$ 是一个固定的源向量。我们关注的标量响应是探测器加权通量\n$$\nJ(\\phi) = w^\\top \\phi,\n$$\n对于一个固定的权重向量 $w \\in \\mathbb{R}^{n}$。假设所有量都是无量纲的。\n\n从控制中子平衡的方程和响应 $J(\\phi)$ 的定义出发，分别使用前向灵敏度方法和基于伴随的灵敏度方法推导灵敏度 $\\mathrm{d}J/\\mathrm{d}p$ 的表达式。在前向方法中，对状态方程关于 $p$ 求导，以获得一个关于 $\\mathrm{d}\\phi/\\mathrm{d}p$ 的线性系统，然后用 $\\mathrm{d}\\phi/\\mathrm{d}p$ 表示 $\\mathrm{d}J/\\mathrm{d}p$。在伴随方法中，定义一个满足转置线性系统的伴随向量 $\\lambda$，并将 $\\mathrm{d}J/\\mathrm{d}p$ 表示为一个涉及 $\\lambda$、算子导数和状态的内积。从第一性原理出发，以代数形式 $A(p)\\phi(p)=q$ 和响应 $J(\\phi)=w^\\top\\phi$ 为起点进行推导，不要假设任何快捷公式。\n\n您必须实现一个程序，该程序：\n- 为每个测试用例构建 $A(p)$，使用扩散系数为 $D$ 的五点离散扩散算子，在 $x$ 方向上流速度为 $v$ 的迎风离散流算子，以及对角线上的吸收贡献 $p$。\n- 使用 $A(p)$ 的单次稀疏 LU 分解求解状态 $\\phi$，并重用该分解以：\n  1. 求解前向灵敏度方程以得到 $\\mathrm{d}\\phi/\\mathrm{d}p$。\n  2. 求解伴随方程 $A(p)^\\top \\lambda = w$ 以获得 $\\lambda$，求解过程不重新进行分解，而是使用相同的 LU 因子进行转置三角求解。\n- 为每个测试用例计算以下量：\n  1. 前向灵敏度 $\\mathrm{d}J/\\mathrm{d}p$（浮点数）。\n  2. 伴随灵敏度 $\\mathrm{d}J/\\mathrm{d}p$（浮点数）。\n  3. 前向和伴随灵敏度结果之间的绝对差（浮点数）。\n  4. 一个布尔标志，指示 $A(p)$ 是否对称（通过在数值容差范围内比较 $A(p)$ 和 $A(p)^\\top$ 来评估）。\n  5. LU 因子中非零元的总数（整数），由重用的分解计算为 $\\mathrm{nnz}(L)+\\mathrm{nnz}(U)$，作为内存使用的代理。\n\n离散算子规范如下：\n- 网格：$N_x \\times N_y$ 个内部点，均匀间距为 $h_x$ 和 $h_y$。\n- 索引：令 $(i,j)$ 表示一个网格点，其中 $i \\in \\{0,\\dots,N_x-1\\}$ 且 $j \\in \\{0,\\dots,N_y-1\\}$。将 $(i,j)$ 映射到单个索引 $k = i + j N_x$。\n- 扩散（五点格式）：对于每个内部点，离散扩散算子的贡献为\n  $$\n  \\left( \\frac{2D}{h_x^2} + \\frac{2D}{h_y^2} \\right)\\phi_{i,j} - \\frac{D}{h_x^2}\\left(\\phi_{i-1,j} + \\phi_{i+1,j}\\right) - \\frac{D}{h_y^2}\\left(\\phi_{i,j-1} + \\phi_{i,j+1}\\right),\n  $$\n  并通过省略会耦合到域外点的项来施加狄利克雷边界条件。\n- 流（$x$ 方向的一阶迎风导数）：对于 $v \\ge 0$，使用\n  $$\n  v \\frac{\\phi_{i,j} - \\phi_{i-1,j}}{h_x}.\n  $$\n  对于 $v < 0$，使用\n  $$\n  v \\frac{\\phi_{i+1,j} - \\phi_{i,j}}{h_x}.\n  $$\n- 吸收：参数 $p$ 对对角线有 $p\\,\\phi_{i,j}$ 的贡献。\n- 源：$q$ 是均匀的，其各项元素等于 $S_0$。\n\n灵敏度必须是关于 $p$（吸收系数）计算的。所有量都是无量纲的；不需要物理单位。\n\n测试套件：\n为以下三种情况提供结果。在所有情况下，设置 $h_x = h_y = 1$ 和 $S_0 = 1$。\n\n- 情况1（对称扩散）：$N_x=10$, $N_y=10$, $D=1.3$, $p=0.25$, $v=0$。探测器权重 $w$ 在四个中心单元 $\\{(4,4),(4,5),(5,4),(5,5)\\}$ 处等于 $0.25$，在其他地方等于 $0$。\n- 情况2（非对称漂移扩散）：$N_x=12$, $N_y=8$, $D=0.9$, $p=0.10$, $v=0.5$。探测器权重 $w$ 是以 $(i^\\ast,j^\\ast)=(10,4)$ 为中心、标准差为 $\\sigma=1.5$ 的指数空间中的高斯分布，即\n  $$\n  w_{i,j} \\propto \\exp\\!\\left( -\\frac{(i-i^\\ast)^2+(j-j^\\ast)^2}{2\\sigma^2} \\right),\n  $$\n  并进行归一化以使 $\\sum_{i,j} w_{i,j} = 1$。\n- 情况3（边界情况，最小吸收和反向漂移）：$N_x=3$, $N_y=3$, $D=1.0$, $p=0$, $v=-1.0$。探测器权重 $w$ 在中心单元 $(1,1)$ 处等于 $1$，在其他地方等于 $0$。\n\n算法要求：\n- 每个测试用例对 $A(p)$ 使用一次稀疏 LU 分解，并将其重用于所有需要的线性求解，包括转置系统 $A(p)^\\top \\lambda = w$。\n- 通过检查 $A(p) - A(p)^\\top$ 的无穷范数是否小于 $10^{-12}$ 来计算布尔对称标志。\n- 将整数内存代理计算为重用的 LU 分解中 $L$ 和 $U$ 因子非零元数量的总和。\n\n最终输出格式：\n您的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表。该列表必须按顺序为情况1、情况2和情况3连接五个值\n$$\n\\left[ \\left(\\frac{\\mathrm{d}J}{\\mathrm{d}p}\\right)_{\\mathrm{forward}}, \\left(\\frac{\\mathrm{d}J}{\\mathrm{d}p}\\right)_{\\mathrm{adjoint}}, \\left| \\left(\\frac{\\mathrm{d}J}{\\mathrm{d}p}\\right)_{\\mathrm{forward}} - \\left(\\frac{\\mathrm{d}J}{\\mathrm{d}p}\\right)_{\\mathrm{adjoint}} \\right|, \\text{is\\_symmetric}, \\mathrm{nnz}(L)+\\mathrm{nnz}(U) \\right]\n$$\n最终形成一个包含十五个条目的单一列表。布尔值和整数不得加引号；浮点数必须以标准十进制表示法打印。",
            "solution": "用户要求对离散化的中子输运方程推导前向和伴随灵敏度分析方法，然后通过数值实现来计算这三种测试用例的灵敏度及相关量。\n\n### 灵敏度表达式的推导\n\n问题始于一个表示稳态中子平衡的线性代数系统，该系统依赖于标量参数 $p$：\n$$\nA(p)\\,\\phi(p) = q\n$$\n此处，$A(p)$ 是系统矩阵，$\\phi(p)$ 是状态向量（中子通量），$q$ 是常数源向量。我们关注的响应是状态的线性泛函：\n$$\nJ(p) = w^\\top \\phi(p)\n$$\n其中 $w$ 是一个常数权重向量。目标是计算响应相对于参数的全导数 $\\frac{\\mathrm{d}J}{\\mathrm{d}p}$。我们将按要求使用两种不同的方法进行推导。\n\n#### 前向灵敏度方法\n\n前向灵敏度方法直接计算状态的灵敏度 $\\frac{\\mathrm{d}\\phi}{\\mathrm{d}p}$，然后用它来求取响应的灵敏度 $\\frac{\\mathrm{d}J}{\\mathrm{d}p}$。\n\n1.  **对响应求导：** 我们对响应函数 $J(p) = w^\\top \\phi(p)$ 应用链式法则。由于 $J$ 仅通过 $\\phi$ 隐式地依赖于 $p$，我们有：\n    $$\n    \\frac{\\mathrm{d}J}{\\mathrm{d}p} = \\frac{\\partial J}{\\partial \\phi} \\frac{\\mathrm{d}\\phi}{\\mathrm{d}p}\n    $$\n    线性响应函数 $J(\\phi) = w^\\top \\phi$ 相对于向量 $\\phi$ 的梯度就是 $w^\\top$。因此，响应灵敏度的表达式变为：\n    $$\n    \\frac{\\mathrm{d}J}{\\mathrm{d}p} = w^\\top \\frac{\\mathrm{d}\\phi}{\\mathrm{d}p}\n    $$\n    向量 $s_\\phi \\equiv \\frac{\\mathrm{d}\\phi}{\\mathrm{d}p}$ 被称为前向灵敏度向量。\n\n2.  **对状态方程求导：** 为了求得 $s_\\phi$，我们对控制状态方程 $A(p)\\,\\phi(p) = q$ 关于 $p$ 求导。应用矩阵-向量乘法的乘积法则得到：\n    $$\n    \\frac{\\mathrm{d}}{\\mathrm{d}p}[A(p)\\phi(p)] = \\frac{\\mathrm{d}A}{\\mathrm{d}p}\\phi(p) + A(p)\\frac{\\mathrm{d}\\phi}{\\mathrm{d}p} = \\frac{\\mathrm{d}q}{\\mathrm{d}p}\n    $$\n    源向量 $q$ 被指定为固定的，因此它关于 $p$ 的导数为零，即 $\\frac{\\mathrm{d}q}{\\mathrm{d}p}=0$。这给出：\n    $$\n    A(p)\\frac{\\mathrm{d}\\phi}{\\mathrm{d}p} = - \\frac{\\mathrm{d}A}{\\mathrm{d}p}\\phi(p)\n    $$\n    这是一个关于未知前向灵敏度向量 $s_\\phi$ 的线性方程组。\n\n3.  **步骤：**\n    a. 求解原始状态方程以获得通量：$A(p)\\phi = q$。\n    b. 计算矩阵关于参数的导数 $\\frac{\\mathrm{d}A}{\\mathrm{d}p}$。在这个特定问题中，参数 $p$ 只出现在对角线吸收项 $p\\phi_{i,j}$ 中。因此，矩阵可以写成 $A(p) = A_0 + pI$，其中 $A_0$ 是矩阵中不依赖于 $p$ 的部分，$I$ 是单位矩阵。其导数就是 $\\frac{\\mathrm{d}A}{\\mathrm{d}p} = I$。\n    c. 构造灵敏度方程的右侧：$-\\frac{\\mathrm{d}A}{\\mathrm{d}p}\\phi = -I\\phi = -\\phi$。\n    d. 求解前向灵敏度方程以获得 $s_\\phi$：$A(p)s_\\phi = -\\phi$。\n    e. 计算响应灵敏度：$\\left(\\frac{\\mathrm{d}J}{\\mathrm{d}p}\\right)_{\\mathrm{forward}} = w^\\top s_\\phi$。\n    注意到，用于求解 $s_\\phi$ 的线性系统与原始状态方程具有相同的矩阵 $A(p)$，这允许重用矩阵分解。\n\n#### 基于伴随的灵敏度方法\n\n当参数数量超过响应数量时，伴随方法为计算相同的灵敏度值提供了另一条途径，且通常具有更高的计算效率。它避免了对状态灵敏度向量 $s_\\phi$ 的显式计算。\n\n1.  **从全导数开始：** 我们再次从响应灵敏度和状态方程导数的一般表达式开始：\n    $$\n    \\frac{\\mathrm{d}J}{\\mathrm{d}p} = w^\\top \\frac{\\mathrm{d}\\phi}{\\mathrm{d}p}\n    $$\n    $$\n    \\frac{\\mathrm{d}\\phi}{\\mathrm{d}p} = - A(p)^{-1} \\frac{\\mathrm{d}A}{\\mathrm{d}p}\\phi(p)\n    $$\n    注意，这个关于 $\\frac{\\mathrm{d}\\phi}{\\mathrm{d}p}$ 的表达式隐式地包含了一个线性求解，而不是完整的矩阵求逆。\n\n2.  **引入伴随向量：** 将第二个表达式代入第一个得到：\n    $$\n    \\frac{\\mathrm{d}J}{\\mathrm{d}p} = -w^\\top A(p)^{-1} \\frac{\\mathrm{d}A}{\\mathrm{d}p}\\phi(p)\n    $$\n    伴随方法的关键洞见在于重新排列计算顺序。利用属性 $(XY)^\\top=Y^\\top X^\\top$ 和 $(X^{-1})^\\top = (X^\\top)^{-1}$，我们可以将项 $w^\\top A(p)^{-1}$ 重写为：\n    $$\n    w^\\top A(p)^{-1} = [ (A(p)^{-1})^\\top w ]^\\top\n    $$\n    然后我们将在方括号内的向量定义为伴随向量 $\\lambda$：\n    $$\n    \\lambda = (A(p)^{-1})^\\top w\n    $$\n    这等价于求解以下关于 $\\lambda$ 的线性系统：\n    $$\n    A(p)^\\top \\lambda = w\n    $$\n    这就是伴随方程。伴随方程的源项是响应函数关于状态的梯度，即 $w = (\\frac{\\partial J}{\\partial \\phi})^\\top$。\n\n3.  **步骤：**\n    a. 求解原始状态方程以获得通量：$A(p)\\phi = q$。\n    b. 求解伴随方程以获得伴随向量：$A(p)^\\top \\lambda = w$。\n    c. 将 $\\lambda$ 代回灵敏度表达式：\n    $$\n    \\frac{\\mathrm{d}J}{\\mathrm{d}p} = - [ (A(p)^{-1})^\\top w ]^\\top \\frac{\\mathrm{d}A}{\\mathrm{d}p}\\phi(p) = - \\lambda^\\top \\frac{\\mathrm{d}A}{\\mathrm{d}p}\\phi(p)\n    $$\n    d. 如前所述，$\\frac{\\mathrm{d}A}{\\mathrm{d}p}=I$。因此，响应灵敏度可以通过一个简单的内积计算得出：\n    $$\n    \\left(\\frac{\\mathrm{d}J}{\\mathrm{d}p}\\right)_{\\mathrm{adjoint}} = -\\lambda^\\top \\phi\n    $$\n\n两种方法在数学上是等价的，必须产生相同的数值结果（在浮点精度范围内）。以下程序实现了这个过程。\n```python\nimport numpy as np\nfrom scipy.sparse import lil_matrix, linalg\n\ndef solve_case(Nx, Ny, D, p, v, w_def, hx=1.0, hy=1.0, S0=1.0):\n    \"\"\"\n    Solves a single test case for neutron diffusion-drift-absorption.\n\n    Args:\n        Nx (int): Number of grid points in the x-direction.\n        Ny (int): Number of grid points in the y-direction.\n        D (float): Diffusion coefficient.\n        p (float): Absorption coefficient (parameter).\n        v (float): Streaming velocity in the x-direction.\n        w_def (dict): Definition of the weight vector w.\n        hx (float): Grid spacing in x.\n        hy (float): Grid spacing in y.\n        S0 (float): Uniform source value.\n\n    Returns:\n        tuple: A 5-element tuple containing the computed results.\n    \"\"\"\n    n = Nx * Ny\n    \n    # 1. Assemble the sparse matrix A(p)\n    A = lil_matrix((n, n), dtype=float)\n\n    for j in range(Ny):\n        for i in range(Nx):\n            k = i + j * Nx\n            \n            # Diagonal term contributions\n            # Diffusion\n            diag_val = (2.0 * D / (hx*hx)) + (2.0 * D / (hy*hy))\n            # Streaming (upwind)\n            if v >= 0:\n                diag_val += v / hx\n            else:  # v < 0\n                diag_val += -v / hx\n            # Absorption\n            diag_val += p\n            A[k, k] = diag_val\n            \n            # Off-diagonal terms (coupling to neighbors)\n            # Left neighbor (i-1, j)\n            if i > 0:\n                k_L = (i - 1) + j * Nx\n                val = -D / (hx*hx)\n                if v >= 0:\n                    val -= v / hx\n                A[k, k_L] = val\n                \n            # Right neighbor (i+1, j)\n            if i < Nx - 1:\n                k_R = (i + 1) + j * Nx\n                val = -D / (hx*hx)\n                if v < 0:\n                    val += v / hx\n                A[k, k_R] = val\n            \n            # Bottom neighbor (i, j-1)\n            if j > 0:\n                k_D = i + (j - 1) * Nx\n                A[k, k_D] = -D / (hy*hy)\n                \n            # Top neighbor (i, j+1)\n            if j < Ny - 1:\n                k_U = i + (j + 1) * Nx\n                A[k, k_U] = -D / (hy*hy)\n\n    A_csc = A.tocsc()\n    \n    # 2. Check for symmetry\n    symm_diff = linalg.norm(A_csc - A_csc.T, ord=np.inf)\n    is_symmetric = symm_diff < 1e-12\n\n    # 3. Create source vector q and weight vector w\n    q = np.full(n, S0, dtype=float)\n    w = np.zeros(n, dtype=float)\n    \n    if w_def['type'] == 'points':\n        for (i, j), val in w_def['points'].items():\n            k = i + j * Nx\n            w[k] = val\n    elif w_def['type'] == 'gaussian':\n        i_star, j_star, sigma = w_def['center_i'], w_def['center_j'], w_def['sigma']\n        w_raw_2d = np.zeros((Ny, Nx))\n        for j in range(Ny):\n            for i in range(Nx):\n                dist_sq = (i - i_star)**2 + (j - j_star)**2\n                w_raw_2d[j, i] = np.exp(-dist_sq / (2.0 * sigma**2))\n        w_flat_raw = w_raw_2d.flatten(order='C')\n        w = w_flat_raw / np.sum(w_flat_raw)\n    elif w_def['type'] == 'center':\n        i, j = w_def['point']\n        k = i + j * Nx\n        w[k] = w_def['value']\n\n    # 4. Perform one sparse LU factorization\n    lu = linalg.splu(A_csc)\n    \n    # 5. Solve for state phi: A*phi = q\n    phi = lu.solve(q)\n    \n    # 6. Forward sensitivity method\n    # dA/dp = I, so the sensitivity equation is A*(d(phi)/dp) = -phi\n    s_phi = lu.solve(-phi)\n    # dJ/dp = w^T * s_phi\n    dJ_fwd = w.T @ s_phi\n    \n    # 7. Adjoint sensitivity method\n    # Solve A.T * lambda = w\n    lam = lu.solve(w, trans='T')\n    # dJ/dp = -lambda^T * (dA/dp) * phi = -lambda^T * phi\n    dJ_adj = -lam.T @ phi\n    \n    # 8. Calculate other metrics\n    abs_diff = abs(dJ_fwd - dJ_adj)\n    # The number of nonzeros in L and U factors is a proxy for memory usage\n    nnz_LU = lu.L.nnz + lu.U.nnz\n\n    return dJ_fwd, dJ_adj, abs_diff, is_symmetric, nnz_LU\n```",
            "answer": "[-1.189569720491873,-1.1895697204918732,2.220446049250313e-16,True,784,-0.19830501170701835,-0.1983050117070184,5.551115123125783e-17,False,837,-0.05260115606936417,-0.05260115606936416,1.3877787807814457e-17,False,17]"
        }
    ]
}