{
    "hands_on_practices": [
        {
            "introduction": "贝叶斯推断的核心在于利用观测数据更新先验信念，从而形成后验分布。当先验分布与似然函数“共轭”时，这一过程会大大简化，因为后验分布将与先验分布属于同一分布族。本练习  提供了一个基础的实践推导，要求您从第一性原理出发，证明高斯似然的精度参数 $\\tau$ 的伽马先验是共轭的，并分析推导出更新后的后验分布。",
            "id": "4215202",
            "problem": "在一次压水堆堆芯模拟中，假设一个高保真度的中子输运模型预测，在固定的操作条件下，堆内探测器的计数率是稳定的，其期望值为已知的 $\\mu$。您在相同的条件下收集了 $n$ 个独立的探测器读数 $y_{1},\\dots,y_{n}$，并将测量噪声和未解析的建模噪声建模为精度为 $\\tau = 1/\\sigma^{2}$ 的高斯分布，因此每次观测的似然满足 $y_{i} \\mid \\tau \\sim \\mathcal{N}(\\mu,\\tau^{-1})$，且这些观测在给定 $\\tau$ 的条件下是条件独立的。为了反映在该反应堆配置中对噪声精度的先验知识，您为 $\\tau$ 设置了一个形状-速率参数为 $(a_{0}, b_{0})$ 的Gamma先验，使得当 $\\tau > 0$ 时，$p(\\tau) \\propto \\tau^{a_{0}-1} \\exp(-b_{0}\\tau)$。\n\n仅从贝叶斯定理以及高斯似然和Gamma先验密度的标准定义出发，推导归一化的后验密度 $p(\\tau \\mid y_{1},\\dots,y_{n},\\mu)$ 的闭合形式，并证明Gamma分布族是已知均值的高斯似然的共轭先验。\n\n您的最终答案必须是归一化后验密度 $p(\\tau \\mid y_{1},\\dots,y_{n},\\mu)$ 的单个闭合形式解析表达式，用符号 $a_{0}$、$b_{0}$、$n$、$\\mu$ 和 $\\sum_{i=1}^{n} (y_{i}-\\mu)^{2}$ 表示。请勿代入数值。无需四舍五入。最终表达式中不应包含单位。",
            "solution": "问题陈述经评估是科学上合理、良定、客观且完整的。它提出了一个贝叶斯统计中的标准、可形式化的问题，并应用于核反应堆模拟的一个合理情景中。未发现任何缺陷。因此，我们可以开始推导。\n\n目标是推导噪声精度 $\\tau$ 的后验概率密度函数 (PDF)，记为 $p(\\tau \\mid \\mathbf{y}, \\mu)$，其中 $\\mathbf{y}$ 是观测向量 $(y_{1}, \\dots, y_{n})$。推导从贝叶斯定理开始，该定理指出后验与似然和先验的乘积成正比：\n$$p(\\tau \\mid \\mathbf{y}, \\mu) \\propto p(\\mathbf{y} \\mid \\tau, \\mu) p(\\tau)$$\n\n首先，我们构建似然函数 $p(\\mathbf{y} \\mid \\tau, \\mu)$。问题陈述指出，在给定 $\\tau$ 和 $\\mu$ 的条件下，观测值 $y_{i}$ 是条件独立的。因此，整个数据集 $\\mathbf{y}$ 的联合似然是每个观测值 $y_{i}$ 的单个似然的乘积：\n$$p(\\mathbf{y} \\mid \\tau, \\mu) = \\prod_{i=1}^{n} p(y_{i} \\mid \\tau, \\mu)$$\n每个观测值 $y_{i}$ 都从一个已知均值为 $\\mu$、精度为 $\\tau$ 的高斯（正态）分布中抽取，即 $y_{i} \\sim \\mathcal{N}(\\mu, \\tau^{-1})$。单个观测值的 PDF 为：\n$$p(y_{i} \\mid \\tau, \\mu) = \\frac{1}{\\sqrt{2\\pi(\\tau^{-1})}} \\exp\\left( -\\frac{(y_{i} - \\mu)^{2}}{2(\\tau^{-1})} \\right) = \\left(\\frac{\\tau}{2\\pi}\\right)^{\\frac{1}{2}} \\exp\\left( -\\frac{\\tau}{2}(y_{i} - \\mu)^{2} \\right)$$\n将此代入联合似然的乘积中，得到：\n$$p(\\mathbf{y} \\mid \\tau, \\mu) = \\prod_{i=1}^{n} \\left[ \\left(\\frac{\\tau}{2\\pi}\\right)^{\\frac{1}{2}} \\exp\\left( -\\frac{\\tau}{2}(y_{i} - \\mu)^{2} \\right) \\right]$$\n$$p(\\mathbf{y} \\mid \\tau, \\mu) = \\left(\\frac{\\tau}{2\\pi}\\right)^{\\frac{n}{2}} \\exp\\left( -\\frac{\\tau}{2} \\sum_{i=1}^{n} (y_{i} - \\mu)^{2} \\right)$$\n\n接下来，我们指定 $\\tau$ 的先验分布。问题陈述指出 $\\tau$ 服从形状参数为 $a_{0}$、速率参数为 $b_{0}$ 的Gamma分布，记为 $\\tau \\sim \\text{Gamma}(a_{0}, b_{0})$。先验的 PDF 以其比例形式给出：\n$$p(\\tau) \\propto \\tau^{a_{0}-1} \\exp(-b_{0}\\tau)$$\n\n现在，我们使用贝叶斯定理结合似然和先验。我们关心的是 $\\tau$ 的后验分布，因此可以省略任何不是 $\\tau$ 函数的因子。\n$$p(\\tau \\mid \\mathbf{y}, \\mu) \\propto p(\\mathbf{y} \\mid \\tau, \\mu) p(\\tau)$$\n$$p(\\tau \\mid \\mathbf{y}, \\mu) \\propto \\left[ \\left(\\frac{\\tau}{2\\pi}\\right)^{\\frac{n}{2}} \\exp\\left( -\\frac{\\tau}{2} \\sum_{i=1}^{n} (y_{i} - \\mu)^{2} \\right) \\right] \\times \\left[ \\tau^{a_{0}-1} \\exp(-b_{0}\\tau) \\right]$$\n省略常数因子 $(2\\pi)^{-\\frac{n}{2}}$ 并合并包含 $\\tau$ 的项：\n$$p(\\tau \\mid \\mathbf{y}, \\mu) \\propto \\tau^{\\frac{n}{2}} \\exp\\left( -\\frac{\\tau}{2} \\sum_{i=1}^{n} (y_{i} - \\mu)^{2} \\right) \\tau^{a_{0}-1} \\exp(-b_{0}\\tau)$$\n$$p(\\tau \\mid \\mathbf{y}, \\mu) \\propto \\tau^{\\frac{n}{2} + a_{0} - 1} \\exp\\left( -b_{0}\\tau - \\frac{\\tau}{2} \\sum_{i=1}^{n} (y_{i} - \\mu)^{2} \\right)$$\n从指数中提取因子 $\\tau$：\n$$p(\\tau \\mid \\mathbf{y}, \\mu) \\propto \\tau^{(a_{0} + \\frac{n}{2}) - 1} \\exp\\left( -\\left[b_{0} + \\frac{1}{2} \\sum_{i=1}^{n} (y_{i} - \\mu)^{2}\\right]\\tau \\right)$$\n\n这个表达式是 $\\tau$ 的一个概率分布的核。我们识别出这个函数形式 $\\tau^{\\text{shape}-1}\\exp(-\\text{rate} \\cdot \\tau)$ 是Gamma分布的核。因此，$\\tau$ 的后验分布是另一个Gamma分布，$p(\\tau \\mid \\mathbf{y}, \\mu) \\sim \\text{Gamma}(a_{n}, b_{n})$，其更新后的参数为：\n后验形状参数 $a_{n}$ 是：\n$$a_{n} = a_{0} + \\frac{n}{2}$$\n后验速率参数 $b_{n}$ 是：\n$$b_{n} = b_{0} + \\frac{1}{2} \\sum_{i=1}^{n} (y_{i} - \\mu)^{2}$$\n\n由于 $\\tau$ 的先验分布来自Gamma分布族，且得到的后验分布也属于Gamma分布族，我们便证明了Gamma分布是已知均值的高斯似然的精度参数的共轭先验。\n\n为了得到归一化的后验密度，我们使用Gamma PDF的标准形式，$p(x \\mid a, b) = \\frac{b^{a}}{\\Gamma(a)}x^{a-1}\\exp(-bx)$，其中 $\\Gamma(\\cdot)$ 是gamma函数。通过代入后验参数 $a_{n}$ 和 $b_{n}$，我们得到了 $\\tau$ 的归一化后验密度的最终闭合形式表达式：\n$$p(\\tau \\mid y_{1},\\dots,y_{n},\\mu) = \\frac{b_{n}^{a_{n}}}{\\Gamma(a_{n})} \\tau^{a_{n}-1} \\exp(-b_{n}\\tau)$$\n$$p(\\tau \\mid y_{1},\\dots,y_{n},\\mu) = \\frac{\\left(b_{0} + \\frac{1}{2} \\sum_{i=1}^{n} (y_{i}-\\mu)^{2}\\right)^{a_{0} + \\frac{n}{2}}}{\\Gamma\\left(a_{0} + \\frac{n}{2}\\right)} \\tau^{\\left(a_{0} + \\frac{n}{2}\\right) - 1} \\exp\\left(-\\left(b_{0} + \\frac{1}{2} \\sum_{i=1}^{n} (y_{i}-\\mu)^{2}\\right)\\tau\\right)$$\n这就是归一化后验密度的完整解析表达式。",
            "answer": "$$\\boxed{\\frac{\\left(b_{0} + \\frac{1}{2} \\sum_{i=1}^{n} (y_{i}-\\mu)^{2}\\right)^{a_{0} + \\frac{n}{2}}}{\\Gamma\\left(a_{0} + \\frac{n}{2}\\right)} \\tau^{\\left(a_{0} + \\frac{n}{2}\\right) - 1} \\exp\\left(-\\left(b_{0} + \\frac{1}{2} \\sum_{i=1}^{n} (y_{i}-\\mu)^{2}\\right)\\tau\\right)}$$"
        },
        {
            "introduction": "虽然完整的后验分布提供了关于不确定性的全面描述，但我们常常需要一个参数的点估计值。作为后验分布的众数，最大后验（MAP）估计是一个常用的选择。本练习  将演示先验的选择如何直接影响MAP估计，揭示拉普拉斯先验等价于广泛使用的 $L_1$ 正则化，从而鼓励参数收缩，为模型校准提供了一个实用工具。",
            "id": "4215228",
            "problem": "在一个非增殖的均匀热中子吸收板（例如，硼化水）中，一维稳态中子平衡可简化为标量中子通量的比尔-朗伯关系。对于路程长度 $x$，这可以写成由宏观吸收截面 $\\Sigma_{a}$ 推导出的指数衰减定律： $$\\phi(x) = \\phi(0)\\,\\exp(-\\Sigma_{a}\\,x).$$ 一个沿板厚度方向对准的准直探测器记录的计数率与 $\\phi(x)$ 成正比。为了将对 $\\Sigma_{a}$ 的依赖性线性化，实验人员使用对数比率可观测量 $$y_i \\equiv \\ln\\!\\left(\\frac{C(0)}{C(L_i)}\\right),$$ 其中 $C(0)$ 和 $C(L_i)$ 分别是入射面和深度 $L_i$ 处的计数率。在指数衰减模型和高计数条件下，中心极限定理证明了将测量噪声建模为加性高斯噪声的合理性，从而得到 $$y_i = \\Sigma_{a}\\,L_i + \\varepsilon_i,\\quad \\varepsilon_i \\sim \\mathcal{N}(0,\\sigma^2),\\quad i=1,\\dots,n,$$ 其中 $\\varepsilon_i$ 是独立同分布的。\n\n您的任务是使用以零为中心的拉普拉斯（双指数）先验对标量参数 $\\Sigma_{a}$ 进行贝叶斯校准，以引导收缩，同时强制施加物理非负性约束。具体来说，假设 $\\theta \\equiv \\Sigma_{a}$ 上的先验密度与下式成正比： $$p(\\theta) \\propto \\exp\\!\\left(-\\frac{|\\theta|}{b}\\right)\\,\\mathbf{1}_{\\{\\theta \\ge 0\\}},$$ 其中 $b>0$ 是尺度参数，$\\mathbf{1}_{\\{\\cdot\\}}$ 表示指示函数。在高斯噪声模型下，似然函数为 $$p(\\mathbf{y}\\mid \\theta) \\propto \\exp\\!\\left(-\\frac{1}{2\\sigma^2}\\sum_{i=1}^{n}\\big(y_i - L_i\\,\\theta\\big)^2\\right).$$\n\n使用这些要素，从第一性原理推导最大后验（MAP）估计量的解析形式，识别其所引导的正则化，并为以下实验数据计算后验众数 $\\hat{\\theta}_{\\text{MAP}}$：\n- 路程长度：$L_1 = 12\\,\\mathrm{cm}$，$L_2 = 18\\,\\mathrm{cm}$，$L_3 = 25\\,\\mathrm{cm}$。\n- 对数比率测量值：$y_1 = 0.90$，$y_2 = 1.50$，$y_3 = 1.95$。\n- 噪声标准差：$\\sigma = 0.30$。\n- 拉普拉斯先验尺度：$b = 0.005\\,\\mathrm{cm}^{-1}$。\n\n将您计算出的 $\\hat{\\theta}_{\\text{MAP}}$ 的最终数值结果以 $\\mathrm{cm}^{-1}$ 为单位表示，并四舍五入到四位有效数字。",
            "solution": "该问题已经过验证，并被确定为有效。它在科学上基于核物理和贝叶斯统计的既定原理，提法得当，提供了所有必要信息，并且其表述是客观的。在指定标准下未发现任何缺陷。因此我们可以继续进行解答。\n\n目标是找到参数 $\\theta \\equiv \\Sigma_a$ 的最大后验（MAP）估计。根据贝叶斯定理，在给定数据 $\\mathbf{y} = (y_1, \\dots, y_n)$ 的条件下，$\\theta$ 的后验概率密度与似然和先验的乘积成正比：\n$$p(\\theta \\mid \\mathbf{y}) \\propto p(\\mathbf{y} \\mid \\theta) \\, p(\\theta)$$\nMAP 估计量 $\\hat{\\theta}_{\\text{MAP}}$ 是使该后验密度最大化的 $\\theta$ 值。由于对数是单调函数，在计算上更方便的是最大化后验的对数。对数后验（记为 $\\mathcal{L}(\\theta)$）由下式给出：\n$$\\mathcal{L}(\\theta) = \\ln p(\\theta \\mid \\mathbf{y}) = \\ln p(\\mathbf{y} \\mid \\theta) + \\ln p(\\theta) + \\text{constant}$$\n于是 MAP 估计为：\n$$\\hat{\\theta}_{\\text{MAP}} = \\arg\\max_{\\theta} \\mathcal{L}(\\theta)$$\n\n首先，我们确定对数似然。似然函数由下式给出：\n$$p(\\mathbf{y}\\mid \\theta) \\propto \\exp\\!\\left(-\\frac{1}{2\\sigma^2}\\sum_{i=1}^{n}\\big(y_i - L_i\\,\\theta\\big)^2\\right)$$\n取自然对数得到对数似然：\n$$\\ln p(\\mathbf{y}\\mid \\theta) = C_1 - \\frac{1}{2\\sigma^2}\\sum_{i=1}^{n}(y_i - L_i\\,\\theta)^2$$\n其中 $C_1$ 是一个不依赖于 $\\theta$ 的常数。\n\n接下来，我们确定对数先验。先验密度由下式给出：\n$$p(\\theta) \\propto \\exp\\!\\left(-\\frac{|\\theta|}{b}\\right)\\,\\mathbf{1}_{\\{\\theta \\ge 0\\}}$$\n物理非负性约束 $\\theta \\ge 0$ 由指示函数 $\\mathbf{1}_{\\{\\theta \\ge 0\\}}$ 强制施加。在此定义域上，绝对值 $|\\theta|$ 简化为 $\\theta$。因此，对于 $\\theta \\ge 0$ 的先验是一个指数分布：\n$$p(\\theta) \\propto \\exp\\!\\left(-\\frac{\\theta}{b}\\right) \\quad \\text{for} \\quad \\theta \\ge 0$$\n取自然对数得到对数先验：\n$$\\ln p(\\theta) = C_2 - \\frac{\\theta}{b} \\quad \\text{for} \\quad \\theta \\ge 0$$\n其中 $C_2$ 是另一个常数。\n\n结合对数似然和对数先验，对于 $\\theta \\ge 0$ 需要最大化的对数后验函数为：\n$$\\mathcal{L}(\\theta) = C - \\frac{1}{2\\sigma^2}\\sum_{i=1}^{n}(y_i - L_i\\,\\theta)^2 - \\frac{\\theta}{b}$$\n其中 $C = C_1 + C_2$。为了找到最大值，我们可以等价地最小化依赖于 $\\theta$ 的项的负值：\n$$\\hat{\\theta}_{\\text{MAP}} = \\arg\\min_{\\theta \\ge 0} \\left[ \\frac{1}{2\\sigma^2}\\sum_{i=1}^{n}(y_i - L_i\\,\\theta)^2 + \\frac{\\theta}{b} \\right]$$\n这个公式揭示了该估计量的本质。第一项 $\\sum(y_i - L_i\\theta)^2$ 是误差平方和，代表数据保真项。第二项 $\\theta/b$ 是一个惩罚项，它对大的 $\\theta$ 值进行惩罚。这是一种正则化最小二乘法。由于 $\\theta \\ge 0$，惩罚项在参数大小 $\\theta$ 上是线性的，这是 $L_1$ 正则化的特征，通常称为 LASSO（最小绝对收缩和选择算子）回归。拉普拉斯先验引导了这种促进稀疏性的正则化，其作用是将估计值向零收缩。\n\n为了找到最小值，我们对目标函数关于 $\\theta$ 求导，并将结果设为零。令 $J(\\theta) = \\frac{1}{2\\sigma^2}\\sum_{i=1}^{n}(y_i - L_i\\,\\theta)^2 + \\frac{\\theta}{b}$。\n$$\\frac{dJ}{d\\theta} = \\frac{1}{2\\sigma^2}\\sum_{i=1}^{n} 2(y_i - L_i\\,\\theta)(-L_i) + \\frac{1}{b} = -\\frac{1}{\\sigma^2}\\sum_{i=1}^{n}(y_iL_i - L_i^2\\theta) + \\frac{1}{b}$$\n将导数设为零以求得无约束极值 $\\theta^*$：\n$$-\\frac{1}{\\sigma^2}\\left(\\sum_{i=1}^{n}y_iL_i - \\theta^*\\sum_{i=1}^{n}L_i^2\\right) + \\frac{1}{b} = 0$$\n$$\\sum_{i=1}^{n}y_iL_i - \\theta^*\\sum_{i=1}^{n}L_i^2 = \\frac{\\sigma^2}{b}$$\n$$\\theta^*\\sum_{i=1}^{n}L_i^2 = \\sum_{i=1}^{n}y_iL_i - \\frac{\\sigma^2}{b}$$\n$$\\theta^* = \\frac{\\sum_{i=1}^{n}y_iL_i - \\frac{\\sigma^2}{b}}{\\sum_{i=1}^{n}L_i^2}$$\n二阶导数 $\\frac{d^2J}{d\\theta^2} = \\frac{1}{\\sigma^2}\\sum_{i=1}^{n}L_i^2 > 0$，证实了 $\\theta^*$ 是一个最小值点。\n目标函数 $J(\\theta)$ 是一个凸抛物线。在 $\\theta \\ge 0$ 上的约束最小值，如果 $\\theta^* \\ge 0$，则在 $\\theta^*$ 处取得；如果 $\\theta^*  0$，则在边界 $\\theta=0$ 处取得。因此，MAP 估计量为：\n$$\\hat{\\theta}_{\\text{MAP}} = \\max\\left(0, \\frac{\\sum_{i=1}^{n}y_iL_i - \\frac{\\sigma^2}{b}}{\\sum_{i=1}^{n}L_i^2}\\right)$$\n\n现在，我们代入所提供的实验数据来计算数值。\n数据如下：\n- 路程长度：$L_1 = 12\\,\\mathrm{cm}$，$L_2 = 18\\,\\mathrm{cm}$，$L_3 = 25\\,\\mathrm{cm}$。\n- 对数比率测量值：$y_1 = 0.90$，$y_2 = 1.50$，$y_3 = 1.95$。\n- 噪声标准差：$\\sigma = 0.30$。\n- 拉普拉斯先验尺度：$b = 0.005\\,\\mathrm{cm}^{-1}$。\n\n我们计算所需的和：\n$$\\sum_{i=1}^{3}L_i^2 = (12)^2 + (18)^2 + (25)^2 = 144 + 324 + 625 = 1093\\,\\mathrm{cm}^2$$\n$$\\sum_{i=1}^{3}y_iL_i = (0.90)(12) + (1.50)(18) + (1.95)(25) = 10.8 + 27.0 + 48.75 = 86.55\\,\\mathrm{cm}$$\n接下来，我们计算正则化项：\n$$\\sigma^2 = (0.30)^2 = 0.09$$\n$$\\frac{\\sigma^2}{b} = \\frac{0.09}{0.005\\,\\mathrm{cm}^{-1}} = 18\\,\\mathrm{cm}$$\n现在我们计算无约束估计 $\\theta^*$：\n$$\\theta^* = \\frac{86.55\\,\\mathrm{cm} - 18\\,\\mathrm{cm}}{1093\\,\\mathrm{cm}^2} = \\frac{68.55\\,\\mathrm{cm}}{1093\\,\\mathrm{cm}^2} \\approx 0.062717...\\,\\mathrm{cm}^{-1}$$\n由于 $\\theta^*  0$，MAP 估计等于该值。\n$$\\hat{\\theta}_{\\text{MAP}} = \\theta^* \\approx 0.062717...\\,\\mathrm{cm}^{-1}$$\n按要求将结果四舍五入到四位有效数字：\n$$\\hat{\\theta}_{\\text{MAP}} \\approx 0.06272\\,\\mathrm{cm}^{-1}$$",
            "answer": "$$\\boxed{0.06272}$$"
        },
        {
            "introduction": "校准模型只是工作的一半；我们还必须评估模型是否能很好地拟合数据。后验预测检验（PPC）为此类模型批判提供了一个强大的框架，它通过提问：“我们的模型能否生成与我们实际观测到的数据相似的数据？”来发挥作用。这个动手编程练习  实现了这一关键技术，要求您从后验预测分布中生成重复数据集，并使用检验统计量来定量评估模型的充分性。",
            "id": "4215171",
            "problem": "考虑一个压水堆堆芯的轴向功率分布，该分布沿着轴向坐标 $z \\in [0,H]$ 建模，其中 $H$ 是以米为单位的活性区高度。在平板几何与真空边界条件下，根据单群中子扩散方程，轴向中子通量本征函数是正弦形式的。我们使用一个截断基来近似归一化的轴向功率剖面。定义三个基函数 $f_0(z) = 1$、$f_1(z) = \\sin\\left(\\pi z / H\\right)$ 和 $f_2(z) = \\sin\\left(2\\pi z / H\\right)$。设 $N$ 为带有测量仪表的轴向水平高度的数量，且 $z_i = i \\cdot H/(N-1)$，其中 $i = 0,1,\\dots,N-1$。\n\n假设在这些水平高度上观测到的轴向功率遵循一个线性模型：\n$$\ny_i = \\theta_0 f_0(z_i) + \\theta_1 f_1(z_i) + \\theta_2 f_2(z_i) + \\varepsilon_i,\n$$\n其中 $\\varepsilon_i \\sim \\mathcal{N}(0,\\sigma^2)$ 在各 $i$ 之间独立同分布，且 $\\sigma^2$ 已知。在矩阵形式中，有 $y \\in \\mathbb{R}^N$，$\\theta \\in \\mathbb{R}^3$，以及设计矩阵 $A \\in \\mathbb{R}^{N\\times 3}$（其列是在 $\\{z_i\\}$ 处求值的基函数），模型表示为：\n$$\ny = A \\theta + \\varepsilon, \\quad \\varepsilon \\sim \\mathcal{N}(0,\\sigma^2 I_N).\n$$\n\n对系数采用高斯先验：\n$$\n\\theta \\sim \\mathcal{N}(\\mu_0,\\Sigma_0),\n$$\n其中均值向量 $\\mu_0 \\in \\mathbb{R}^3$ 和协方差矩阵 $\\Sigma_0 \\in \\mathbb{R}^{3\\times 3}$（对称正定）均为指定值。\n\n您的任务是通过贝叶斯推断来校准模型，然后构建一个后验预测检验 (PPC)。设轴向峰化因子统计量为：\n$$\nT(y) = \\frac{\\max_i y_i}{\\frac{1}{N} \\sum_{i=0}^{N-1} y_i}.\n$$\n定义后验预测 $p$ 值为：\n$$\np = \\Pr\\{T(y^{\\text{rep}}) \\ge T(y) \\mid y\\},\n$$\n其中 $y^{\\text{rep}}$ 是从后验预测分布中生成的复制数据集。后验预测分布是通过对后验分布 $\\theta \\mid y$ 积分采样分布 $y^{\\text{rep}} \\mid \\theta$ 来定义的。程序必须通过蒙特卡洛抽样来近似 $p$：抽取 $\\theta^{(m)} \\sim p(\\theta \\mid y)$，然后抽取 $y^{\\text{rep},(m)} \\sim p(y^{\\text{rep}} \\mid \\theta^{(m)})$，对于 $m=1,\\dots,M$，并估计：\n$$\n\\hat{p} = \\frac{1}{M} \\sum_{m=1}^M \\mathbf{1}\\left\\{T\\left(y^{\\text{rep},(m)}\\right) \\ge T(y)\\right\\}.\n$$\n\n从经过充分检验的物理和统计基础出发：单群中子扩散方程引出了正弦轴向模式，而线性高斯模型在高斯先验下意味着高斯后验。请从这些基础出发推导后验分布 $p(\\theta \\mid y)$，不要调用任何非由这些基础直接蕴含的快捷公式。\n\n每个测试用例的观测数据 $y$ 必须在程序内部使用指定的参数和固定的随机种子生成，作为测试定义的一部分。对于每个测试用例，使用上面定义的 $z_i$ 位置，并通过采样模型使用指定的“真实”系数向量 $\\theta^{\\text{true}}$ 生成 $y$；然后基于该 $y$ 计算后验和 PPC $p$ 值。\n\n物理单位：高度 $H$ 必须以米为单位指定。轴向峰化因子 $T(y)$ 和 $p$ 值是无量纲量。最终的 $p$ 值以小数形式报告。\n\n角度单位：三角函数内部的所有角度都是通过长度比形成的无量纲参数；不需要进行角度单位转换，因为 $\\sin(\\cdot)$ 是在无量纲量 $\\pi z/H$ 上求值的。\n\n您的程序必须生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如 $[p_1,p_2,p_3,p_4]$）。\n\n测试套件。实现以下四个测试用例，每个用例都具有固定的蒙特卡洛样本量 $M = 20000$ 和独立的随机种子。为了保证可复现性，在每个用例中，为生成观测数据和进行后验预测抽样使用指定的种子。\n\n- Case $1$ (一般情况): $H=4.0$ meters, $N=41$, $\\sigma = 0.02$, $\\mu_0 = [1.0, 0.0, 0.0]$, $\\Sigma_0 = \\operatorname{diag}([0.05^2, 0.2^2, 0.2^2])$, $\\theta^{\\text{true}} = [1.05, 0.15, -0.05]$, seed $= 12345$。\n- Case $2$ (近确定性边界): $H=4.0$ meters, $N=41$, $\\sigma = 0.0001$, $\\mu_0 = [1.0, 0.0, 0.0]$, $\\Sigma_0 = \\operatorname{diag}([0.05^2, 0.2^2, 0.2^2])$, $\\theta^{\\text{true}} = [1.05, 0.15, -0.05]$, seed $= 23456$。\n- Case $3$ (低分辨率边缘情况): $H=4.0$ meters, $N=3$, $\\sigma = 0.05$, $\\mu_0 = [1.0, 0.1, 0.0]$, $\\Sigma_0 = \\operatorname{diag}([0.1^2, 0.3^2, 0.3^2])$, $\\theta^{\\text{true}} = [1.1, 0.3, 0.0]$, seed $= 34567$。\n- Case $4$ (强先验影响): $H=4.0$ meters, $N=21$, $\\sigma = 0.02$, $\\mu_0 = [0.9, 0.0, 0.0]$, $\\Sigma_0 = \\operatorname{diag}([0.01^2, 0.02^2, 0.02^2])$, $\\theta^{\\text{true}} = [1.2, 0.25, 0.05]$, seed $= 45678$。\n\n输出规范：您的程序应生成一行输出，其中包含上述案例的四个估计后验预测 $p$ 值，格式为方括号括起来的逗号分隔列表，每个值四舍五入到六位小数，并按案例 $1$ 到 $4$ 的顺序排列，即 $[p_1,p_2,p_3,p_4]$。",
            "solution": "用户提供的问题已经过分析和验证。\n\n\\textbf{第 1 步：提取给定信息}\n- 定义域：轴向坐标 $z \\in [0,H]$，$H$ 是以米为单位的堆芯高度。\n- 基函数：$f_0(z) = 1$, $f_1(z) = \\sin(\\pi z / H)$, $f_2(z) = \\sin(2\\pi z / H)$。\n- 离散化：$N$ 个水平高度，$z_i = i \\cdot H/(N-1)$，其中 $i=0,\\dots,N-1$。\n- 似然模型：$y_i = \\theta_0 f_0(z_i) + \\theta_1 f_1(z_i) + \\theta_2 f_2(z_i) + \\varepsilon_i$，其中 $\\varepsilon_i \\sim \\mathcal{N}(0,\\sigma^2)$ 独立同分布。\n- 矩阵形式：$y = A \\theta + \\varepsilon$，其中 $\\varepsilon \\sim \\mathcal{N}(0,\\sigma^2 I_N)$。\n- 先验分布：$\\theta \\sim \\mathcal{N}(\\mu_0, \\Sigma_0)$，其中 $\\Sigma_0$ 是对称正定矩阵。\n-检验统计量：轴向峰化因子，$T(y) = \\frac{\\max_i y_i}{\\frac{1}{N} \\sum_{i=0}^{N-1} y_i}$。\n- 目标：通过蒙特卡洛模拟，使用 $M$ 个样本来估计后验预测 $p$ 值，$p = \\Pr\\{T(y^{\\text{rep}}) \\ge T(y) \\mid y\\}$。\n- 数据生成：每个案例的观测数据 $y$ 需使用提供的“真实”参数向量 $\\theta^{\\text{true}}$ 和固定的随机种子从似然模型生成。\n- 测试套件：提供了四个具体的测试用例，包含所有必要参数：$H, N, \\sigma, \\mu_0, \\Sigma_0, \\theta^{\\text{true}}, M, \\text{seed}$。\n\n\\textbf{第 2 步：使用提取的给定信息进行验证}\n该问题被评估为有效。\n- 它具有科学依据，使用了反应堆物理的标准简化模型（扩散理论基函数）和标准的统计方法（线性高斯模型的贝叶斯推断）。\n- 它是适定问题。所有数学对象都有明确定义，并且提供了正定先验协方差矩阵 $\\Sigma_0$，确保了即使设计矩阵 $A$ 的列线性相关（如案例 3 中发生的情况，但贝叶斯框架能正确处理），后验分布也是良定义且正常的。\n- 它是客观且自洽的，为获得唯一解提供了所有必要的数据和定义。\n- 在简化模拟的背景下，参数在物理上是合理的。\n\n\\textbf{第 3 步：结论与行动}\n问题有效。将提供一个完整且合理的解决方案。\n\n\\rule{12cm}{0.4pt}\n\n任务是执行贝叶斯模型校准和随后的后验预测检验。这需要推导模型参数 $\\theta$ 的后验分布，然后使用该分布生成复制数据，以便与观测数据进行比较。\n\n\\textbf{后验分布 $p(\\theta \\mid y)$ 的推导}\n\n后验分布由贝叶斯定理给出：\n$$\np(\\theta \\mid y) \\propto p(y \\mid \\theta) p(\\theta)\n$$\n似然 $p(y \\mid \\theta)$ 对应于模型 $y = A\\theta + \\varepsilon$，其中 $\\varepsilon \\sim \\mathcal{N}(0, \\sigma^2 I_N)$。其概率密度函数为：\n$$\np(y \\mid \\theta) = \\frac{1}{(2\\pi\\sigma^2)^{N/2}} \\exp\\left(-\\frac{1}{2\\sigma^2}(y - A\\theta)^T(y - A\\theta)\\right)\n$$\n先验 $p(\\theta)$ 给定为多元正态分布 $\\mathcal{N}(\\mu_0, \\Sigma_0)$：\n$$\np(\\theta) = \\frac{1}{(2\\pi)^{3/2}|\\Sigma_0|^{1/2}} \\exp\\left(-\\frac{1}{2}(\\theta - \\mu_0)^T \\Sigma_0^{-1}(\\theta - \\mu_0)\\right)\n$$\n后验密度与这两个密度的乘积成正比。我们关注指数部分，因为归一化常数可以在最后确定。后验的指数参数是似然和先验指数参数之和：\n$$\n\\text{Exponent} = -\\frac{1}{2\\sigma^2}(y - A\\theta)^T(y - A\\theta) - \\frac{1}{2}(\\theta - \\mu_0)^T \\Sigma_0^{-1}(\\theta - \\mu_0)\n$$\n展开各项：\n$$\n\\text{Exponent} = -\\frac{1}{2}\\left[ \\frac{1}{\\sigma^2}(y^T y - 2y^T A\\theta + \\theta^T A^T A \\theta) + (\\theta^T \\Sigma_0^{-1}\\theta - 2\\mu_0^T \\Sigma_0^{-1}\\theta + \\mu_0^T \\Sigma_0^{-1}\\mu_0) \\right]\n$$\n为了识别后验分布的形式，我们收集包含 $\\theta$ 的项：\n$$\n\\text{Exponent} = -\\frac{1}{2} \\left[ \\theta^T\\left(\\frac{1}{\\sigma^2}A^T A + \\Sigma_0^{-1}\\right)\\theta - 2\\left(\\frac{1}{\\sigma^2}y^T A + \\mu_0^T \\Sigma_0^{-1}\\right)\\theta \\right] + C\n$$\n其中 $C$ 包含不依赖于 $\\theta$ 的项。此表达式是 $\\theta$ 的二次型，表明后验分布 $p(\\theta \\mid y)$ 也是一个多元正态分布，不妨设为 $\\mathcal{N}(\\mu_N, \\Sigma_N)$。这样一个分布的密度与 $\\exp\\left(-\\frac{1}{2}(\\theta - \\mu_N)^T\\Sigma_N^{-1}(\\theta - \\mu_N)\\right)$ 成正比，展开后为：\n$$\n\\text{Exponent} = -\\frac{1}{2}\\left[ \\theta^T \\Sigma_N^{-1}\\theta - 2\\mu_N^T \\Sigma_N^{-1}\\theta \\right] + C'\n$$\n通过比较 $\\theta$ 的二次项和线性项的系数，我们可以确定后验参数 $\\mu_N$ 和 $\\Sigma_N$。\n\n后验协方差的逆矩阵 $\\Sigma_N^{-1}$ 是乘以 $\\theta^T(\\dots)\\theta$ 的项：\n$$\n\\Sigma_N^{-1} = \\frac{1}{\\sigma^2}A^T A + \\Sigma_0^{-1}\n$$\n后验协方差是其逆矩阵：\n$$\n\\Sigma_N = \\left(\\frac{1}{\\sigma^2}A^T A + \\Sigma_0^{-1}\\right)^{-1}\n$$\n线性项给出了后验均值 $\\mu_N$ 的关系：\n$$\n\\mu_N^T \\Sigma_N^{-1} = \\frac{1}{\\sigma^2}y^T A + \\mu_0^T \\Sigma_0^{-1}\n$$\n转置并右乘 $\\Sigma_N$ 得到：\n$$\n\\mu_N = \\Sigma_N \\left( \\frac{1}{\\sigma^2}A^T y + \\Sigma_0^{-1} \\mu_0 \\right)\n$$\n因此，后验分布为 $p(\\theta \\mid y) = \\mathcal{N}(\\mu_N, \\Sigma_N)$，其参数如上推导。\n\n\\textbf{后验预测检验 (PPC)}\n\nPPC 是一种评估模型拟合优度的方​​法。我们从后验预测分布 $p(y^{\\text{rep}} \\mid y)$ 中生成复制数据 $y^{\\text{rep}}$，并将其属性与观测数据 $y$ 进行比较。后验预测分布定义为：\n$$\np(y^{\\text{rep}} \\mid y) = \\int p(y^{\\text{rep}} \\mid \\theta) p(\\theta \\mid y) d\\theta\n$$\n从此分布中抽样是一个两步生成过程：\n1. 从后验分布中抽取一个参数向量 $\\theta^{(m)}$：$\\theta^{(m)} \\sim p(\\theta \\mid y)$。\n2. 使用该参数向量从似然中生成一个复制数据集 $y^{\\text{rep},(m)}$：$y^{\\text{rep},(m)} \\sim p(y \\mid \\theta^{(m)})$。\n\n检验使用检验统计量 $T(y)$ 进行。问题定义了轴向峰化因子：\n$$\nT(y) = \\frac{\\max_i y_i}{\\frac{1}{N} \\sum_{i=0}^{N-1} y_i}\n$$\n后验预测 $p$ 值衡量了在复制数据上计算的检验统计量比在观测数据上计算的更极端的概率。它通过蒙特卡洛模拟进行估计：\n$$\n\\hat{p} = \\frac{1}{M} \\sum_{m=1}^{M} \\mathbf{1}\\left\\{T\\left(y^{\\text{rep},(m)}\\right) \\ge T(y)\\right\\}\n$$\n接近 0 或 1 的 $p$ 值表明模型无法再现由检验统计量捕获的数据的特定方面，这可能指示模型设定有误或先验与数据存在冲突。\n\n\\textbf{实现算法}\n\n对于每个测试用例，执行以下步骤：\n1. 从测试用例中初始化参数：$H, N, \\sigma, \\mu_0, \\Sigma_0, \\theta^{\\text{true}}, M$ 以及随机数生成器 `seed`。\n2. 构建 $N \\times 3$ 的设计矩阵 $A$，其中列是在 $N$ 个轴向位置 $z_i = i \\cdot H/(N-1)$ 处求值的基函数 $f_0, f_1, f_2$。\n3. 生成观测数据向量 $y$。首先，计算真实均值 $\\mu_y = A \\theta^{\\text{true}}$。然后，添加高斯噪声：$y = \\mu_y + \\varepsilon$，其中 $\\varepsilon \\sim \\mathcal{N}(0, \\sigma^2 I_N)$。\n4. 使用推导出的公式和生成的数据 $y$ 计算后验分布参数 $\\mu_N$ 和 $\\Sigma_N$。这涉及矩阵求逆和乘法。\n5. 计算观测到的检验统计量 $T_{obs} = T(y)$。\n6. 开始进行 $M$ 次迭代的蒙特卡洛模拟：\n    a. 从后验分布 $\\mathcal{N}(\\mu_N, \\Sigma_N)$ 中抽取一个参数样本 $\\theta^{(m)}$。\n    b. 生成一个复制数据集 $y^{\\text{rep},(m)} = A\\theta^{(m)} + \\varepsilon^{(m)}$，其中 $\\varepsilon^{(m)} \\sim \\mathcal{N}(0, \\sigma^2 I_N)$ 是一个新的噪声样本。\n    c. 计算复制检验统计量 $T_{rep}^{(m)} = T(y^{\\text{rep},(m)})$。\n7. 统计 $T_{rep}^{(m)} \\ge T_{obs}$ 的迭代次数。\n8. 估计的 $p$ 值是此计数除以 $M$。\n收集所有测试用例的最终结果并按指定格式输出。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# No other libraries are needed for this problem.\n\ndef solve():\n    \"\"\"\n    Solves the Bayesian model calibration and posterior predictive check problem\n    for a series of test cases.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"H\": 4.0, \"N\": 41, \"sigma\": 0.02,\n            \"mu0\": np.array([1.0, 0.0, 0.0]),\n            \"Sigma0\": np.diag([0.05**2, 0.2**2, 0.2**2]),\n            \"theta_true\": np.array([1.05, 0.15, -0.05]),\n            \"M\": 20000, \"seed\": 12345\n        },\n        {\n            \"H\": 4.0, \"N\": 41, \"sigma\": 0.0001,\n            \"mu0\": np.array([1.0, 0.0, 0.0]),\n            \"Sigma0\": np.diag([0.05**2, 0.2**2, 0.2**2]),\n            \"theta_true\": np.array([1.05, 0.15, -0.05]),\n            \"M\": 20000, \"seed\": 23456\n        },\n        {\n            \"H\": 4.0, \"N\": 3, \"sigma\": 0.05,\n            \"mu0\": np.array([1.0, 0.1, 0.0]),\n            \"Sigma0\": np.diag([0.1**2, 0.3**2, 0.3**2]),\n            \"theta_true\": np.array([1.1, 0.3, 0.0]),\n            \"M\": 20000, \"seed\": 34567\n        },\n        {\n            \"H\": 4.0, \"N\": 21, \"sigma\": 0.02,\n            \"mu0\": np.array([0.9, 0.0, 0.0]),\n            \"Sigma0\": np.diag([0.01**2, 0.02**2, 0.02**2]),\n            \"theta_true\": np.array([1.2, 0.25, 0.05]),\n            \"M\": 20000, \"seed\": 45678\n        }\n    ]\n\n    results = []\n\n    for case in test_cases:\n        # Unpack parameters for the current case\n        H, N, sigma, mu0, Sigma0, theta_true, M, seed = case.values()\n        \n        # Initialize Random Number Generator for reproducibility\n        rng = np.random.default_rng(seed)\n\n        # 1. Construct the design matrix A\n        z = np.linspace(0, H, N)\n        A = np.zeros((N, 3))\n        A[:, 0] = 1.0\n        A[:, 1] = np.sin(np.pi * z / H)\n        A[:, 2] = np.sin(2 * np.pi * z / H)\n\n        # 2. Generate the \"observed\" data y\n        mu_y_true = A @ theta_true\n        epsilon_obs = rng.normal(loc=0.0, scale=sigma, size=N)\n        y_obs = mu_y_true + epsilon_obs\n\n        # 3. Calculate posterior distribution parameters (mu_N, Sigma_N)\n        Sigma0_inv = np.linalg.inv(Sigma0)\n        AtA = A.T @ A\n        \n        # Posterior inverse covariance\n        Sigma_N_inv = (1 / sigma**2) * AtA + Sigma0_inv\n        \n        # Posterior covariance\n        Sigma_N = np.linalg.inv(Sigma_N_inv)\n        \n        # Posterior mean\n        Aty_obs = A.T @ y_obs\n        mu_N = Sigma_N @ ((1 / sigma**2) * Aty_obs + Sigma0_inv @ mu0)\n\n        # 4. Define the test statistic T(y)\n        def T(y_data):\n            mean_val = np.mean(y_data)\n            if mean_val == 0:\n                # This case is highly improbable given the model setup\n                return np.inf if np.max(y_data)  0 else 0\n            return np.max(y_data) / mean_val\n\n        # 5. Calculate the statistic for the observed data\n        T_obs = T(y_obs)\n\n        # 6. Perform Monte Carlo simulation for PPC\n        \n        # Step 6a: Draw M samples from the posterior distribution of theta\n        theta_samples = rng.multivariate_normal(mu_N, Sigma_N, size=M)\n\n        # Step 6b: Generate M replicate datasets y_rep\n        # Vectorized calculation for efficiency\n        mu_rep_samples = theta_samples @ A.T  # Shape (M, N)\n        epsilon_rep_samples = rng.normal(loc=0.0, scale=sigma, size=(M, N))\n        y_rep_samples = mu_rep_samples + epsilon_rep_samples\n\n        # Step 6c: Calculate the test statistic for each replicate dataset\n        max_y_rep = np.max(y_rep_samples, axis=1)\n        mean_y_rep = np.mean(y_rep_samples, axis=1)\n        \n        # Create an array to hold T_rep values, handling potential division by zero\n        T_rep = np.full_like(mean_y_rep, np.inf)\n        # Avoid division by zero, though unlikely\n        valid_means_mask = mean_y_rep != 0\n        T_rep[valid_means_mask] = max_y_rep[valid_means_mask] / mean_y_rep[valid_means_mask]\n\n        # Step 6d  7: Count and estimate the p-value\n        num_exceed = np.sum(T_rep = T_obs)\n        p_value = num_exceed / M\n        \n        results.append(f\"{p_value:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}