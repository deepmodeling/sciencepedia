{
    "hands_on_practices": [
        {
            "introduction": "At the heart of any Accelerator-Driven System (ADS) is the interplay between an external neutron source and a subcritical multiplying medium. This first exercise provides a foundational understanding of this relationship by simplifying the system to a uniform, infinite medium . By applying the principle of neutron conservation in a steady state, you will derive and quantify how the required source strength, $S_{0}$, depends directly on the system's subcriticality and the desired power level, represented by the neutron density $n_{0}$.",
            "id": "4249254",
            "problem": "Consider a spatially uniform, homogeneous, infinite medium relevant to an Accelerator-Driven System (ADS), modeled with one-speed neutrons of constant speed $v$. The medium is subcritical with a known effective multiplication factor $k_{\\text{eff}}$, a known macroscopic removal cross section $\\Sigma_{r}$, and is driven by an isotropic, spatially uniform external neutron source of strength $S_{0}$ (neutrons added per unit volume per unit time). Assume steady state and neglect delayed neutrons. The neutron density is $n$ and the scalar flux is related by $\\phi = v n$.\n\nStarting only from neutron-number conservation at steady state in an infinite homogeneous one-speed medium and standard definitions of production, loss, and external source, derive an expression for the external source strength $S_{0}$ required to sustain a target neutron density $n_{0}$ in terms of $k_{\\text{eff}}$, $\\Sigma_{r}$, $v$, and $n_{0}$. Then evaluate $S_{0}$ numerically for the following data:\n- $k_{\\text{eff}} = 0.97$,\n- $\\Sigma_{r} = 0.35 \\ \\text{cm}^{-1}$,\n- $v = 1.8 \\times 10^{9} \\ \\text{cm} \\ \\text{s}^{-1}$,\n- $n_{0} = 7.0 \\times 10^{5} \\ \\text{cm}^{-3}$.\n\nExpress $S_{0}$ in $\\text{n} \\ \\text{cm}^{-3} \\ \\text{s}^{-1}$. Round your answer to $3$ significant figures.",
            "solution": "The core of the problem is the principle of neutron conservation. For a homogeneous medium, we can write a balance equation for the neutron density $n$ in a unit volume. The rate of change of neutron density is the sum of the rates of production, loss, and any external sources.\n$$\n\\frac{dn}{dt} = \\text{Production Rate} - \\text{Loss Rate} + \\text{External Source Rate}\n$$\nThe problem specifies a steady-state condition, which means the neutron population is constant in time. Therefore, $\\frac{dn}{dt} = 0$.\n$$\n0 = \\text{Production Rate} - \\text{Loss Rate} + \\text{External Source Rate}\n$$\nLet us define each term per unit volume.\nThe external source strength is given as $S_{0}$, which is the number of neutrons added per unit volume per unit time.\n\nThe loss of neutrons is due to removal processes (primarily absorption in a one-group model). The rate of removal reactions per unit volume is given by the product of the macroscopic removal cross section, $\\Sigma_{r}$, and the scalar neutron flux, $\\phi$.\n$$\n\\text{Loss Rate} = \\Sigma_{r} \\phi\n$$\nThe production of neutrons arises from fission events. The rate of fission reactions per unit volume is $\\Sigma_{f} \\phi$, where $\\Sigma_{f}$ is the macroscopic fission cross section. If each fission releases an average of $\\nu$ neutrons, the production rate of neutrons per unit volume is:\n$$\n\\text{Production Rate} = \\nu \\Sigma_{f} \\phi\n$$\nSubstituting these rates into the steady-state balance equation gives:\n$$\n0 = \\nu \\Sigma_{f} \\phi - \\Sigma_{r} \\phi + S_{0}\n$$\nThis equation can be rearranged to solve for the required external source strength, $S_{0}$:\n$$\nS_{0} = \\Sigma_{r} \\phi - \\nu \\Sigma_{f} \\phi = (\\Sigma_{r} - \\nu \\Sigma_{f}) \\phi\n$$\nThe problem provides the effective multiplication factor, $k_{\\text{eff}}$. For an infinite homogeneous medium, $k_{\\text{eff}}$ is equivalent to the infinite multiplication factor, $k_{\\infty}$. This factor is defined as the ratio of the rate of neutron production to the rate of neutron loss (in this one-group model, removal is equivalent to absorption, which is the only loss mechanism in an infinite medium).\n$$\nk_{\\text{eff}} = \\frac{\\text{Production Rate}}{\\text{Loss Rate}} = \\frac{\\nu \\Sigma_{f} \\phi}{\\Sigma_{r} \\phi} = \\frac{\\nu \\Sigma_{f}}{\\Sigma_{r}}\n$$\nWe can use this definition to express the production term $\\nu \\Sigma_{f}$ in terms of $k_{\\text{eff}}$ and $\\Sigma_{r}$:\n$$\n\\nu \\Sigma_{f} = k_{\\text{eff}} \\Sigma_{r}\n$$\nSubstituting this back into the equation for $S_{0}$:\n$$\nS_{0} = (\\Sigma_{r} - k_{\\text{eff}} \\Sigma_{r}) \\phi = \\Sigma_{r} (1 - k_{\\text{eff}}) \\phi\n$$\nThe problem asks for the source strength required to sustain a specific target neutron density, $n_{0}$. The scalar flux $\\phi$ is related to the neutron density $n$ and the neutron speed $v$ by the definition $\\phi = v n$. Thus, for the target density $n_{0}$, the corresponding target flux is $\\phi_{0} = v n_{0}$.\nSubstituting $\\phi_{0}$ for $\\phi$ yields the final expression for $S_{0}$:\n$$\nS_{0} = \\Sigma_{r} (1 - k_{\\text{eff}}) v n_{0}\n$$\nThis expression gives the required external source strength in terms of the given quantities.\n\nNow, we evaluate $S_{0}$ numerically using the provided data:\n- $k_{\\text{eff}} = 0.97$\n- $\\Sigma_{r} = 0.35 \\ \\text{cm}^{-1}$\n- $v = 1.8 \\times 10^{9} \\ \\text{cm} \\ \\text{s}^{-1}$\n- $n_{0} = 7.0 \\times 10^{5} \\ \\text{cm}^{-3}$\n\nSubstituting these values into the derived expression:\n$$\nS_{0} = (0.35 \\ \\text{cm}^{-1}) \\times (1 - 0.97) \\times (1.8 \\times 10^{9} \\ \\text{cm} \\ \\text{s}^{-1}) \\times (7.0 \\times 10^{5} \\ \\text{cm}^{-3})\n$$\n$$\nS_{0} = 0.35 \\times 0.03 \\times 1.8 \\times 10^{9} \\times 7.0 \\times 10^{5} \\ \\text{n} \\ \\text{cm}^{-3} \\ \\text{s}^{-1}\n$$\nLet's compute the numerical product:\n$$\nS_{0} = (0.35 \\times 0.03 \\times 1.8 \\times 7.0) \\times 10^{9+5} \\ \\text{n} \\ \\text{cm}^{-3} \\ \\text{s}^{-1}\n$$\n$$\nS_{0} = (0.0105 \\times 1.8 \\times 7.0) \\times 10^{14} \\ \\text{n} \\ \\text{cm}^{-3} \\ \\text{s}^{-1}\n$$\n$$\nS_{0} = (0.0189 \\times 7.0) \\times 10^{14} \\ \\text{n} \\ \\text{cm}^{-3} \\ \\text{s}^{-1}\n$$\n$$\nS_{0} = 0.1323 \\times 10^{14} \\ \\text{n} \\ \\text{cm}^{-3} \\ \\text{s}^{-1}\n$$\nExpressing this in standard scientific notation:\n$$\nS_{0} = 1.323 \\times 10^{13} \\ \\text{n} \\ \\text{cm}^{-3} \\ \\text{s}^{-1}\n$$\nThe problem requires the answer to be rounded to $3$ significant figures.\n$$\nS_{0} \\approx 1.32 \\times 10^{13} \\ \\text{n} \\ \\text{cm}^{-3} \\ \\text{s}^{-1}\n$$",
            "answer": "$$\\boxed{1.32 \\times 10^{13}}$$"
        },
        {
            "introduction": "While the infinite medium model is useful, real reactor cores have finite boundaries and spatial variations. This practice moves into the spatial dimension by applying one-speed neutron diffusion theory to a simplified slab geometry, which represents the active region of an ADS . Solving the diffusion equation with a uniform source will allow you to derive the analytical expression for the neutron flux profile, $\\phi_g(x)$, revealing how the neutron population is shaped by the geometry and material properties of the core.",
            "id": "4249221",
            "problem": "A subcritical one-dimensional slab of width $L$ represents the active region of an Accelerator-Driven System (ADS), where an external source of spallation neutrons produces a spatially uniform, isotropic source density $Q_0$ in energy group $g$. The material properties in group $g$ are spatially uniform and characterized by a diffusion coefficient $D_g$ and an absorption macroscopic cross section $\\Sigma_{a,g}$. The boundaries at $x=0$ and $x=L$ are perfectly absorbing, so the scalar neutron flux satisfies $\\phi_g(0)=0$ and $\\phi_g(L)=0$.\n\nStarting from the steady-state neutron balance and Fickâ€™s law, derive the one-speed diffusion equation appropriate for this slab and use it, together with the absorbing boundary conditions, to obtain the closed-form analytic expression for the steady-state scalar flux distribution $\\phi_g(x)$ for $0  x  L$.\n\nProvide your final answer as a single closed-form analytic expression in terms of $x$, $L$, $D_g$, $\\Sigma_{a,g}$, and $Q_0$. No numerical evaluation is required, and no rounding is needed. If you evaluate the expression numerically, express the flux in neutrons per square centimeter per second. Do not include units in the final boxed expression.",
            "solution": "The derivation begins from the steady-state neutron balance equation. In an arbitrary volume $V$, the rate of neutron loss must equal the rate of neutron production. For a differential volume element in one dimension, this balance is expressed as:\n$$\n\\text{Leakage rate} + \\text{Absorption rate} = \\text{Source rate}\n$$\nIn group $g$, for a one-dimensional slab geometry, the balance equation is:\n$$\n\\frac{dJ_g(x)}{dx} + \\Sigma_{a,g} \\phi_g(x) = S_g(x)\n$$\nHere, $J_g(x)$ is the neutron current density, $\\Sigma_{a,g} \\phi_g(x)$ is the reaction rate density for absorption, and $S_g(x)$ is the total source density of neutrons into group $g$. For this problem, scattering from other energy groups is ignored (one-speed model), and any fission source is neglected. The source term is therefore just the external source, $S_g(x) = Q_0$, which is spatially uniform. The balance equation becomes:\n$$\n\\frac{dJ_g(x)}{dx} + \\Sigma_{a,g} \\phi_g(x) = Q_0\n$$\nThe neutron current $J_g(x)$ is related to the gradient of the scalar flux $\\phi_g(x)$ by Fick's law of diffusion:\n$$\nJ_g(x) = -D_g \\frac{d\\phi_g(x)}{dx}\n$$\nSubstituting Fick's law into the neutron balance equation yields:\n$$\n\\frac{d}{dx} \\left(-D_g \\frac{d\\phi_g(x)}{dx}\\right) + \\Sigma_{a,g} \\phi_g(x) = Q_0\n$$\nSince the diffusion coefficient $D_g$ is spatially uniform, it can be taken out of the derivative:\n$$\n-D_g \\frac{d^2\\phi_g(x)}{dx^2} + \\Sigma_{a,g} \\phi_g(x) = Q_0\n$$\nRearranging the terms, we obtain the one-speed, steady-state neutron diffusion equation for the slab with a uniform source:\n$$\n\\frac{d^2\\phi_g(x)}{dx^2} - \\frac{\\Sigma_{a,g}}{D_g} \\phi_g(x) = -\\frac{Q_0}{D_g}\n$$\nLet's define the square of the inverse of the diffusion length, $k^2 \\equiv \\frac{\\Sigma_{a,g}}{D_g}$. The equation is a second-order, linear, inhomogeneous ordinary differential equation:\n$$\n\\frac{d^2\\phi_g(x)}{dx^2} - k^2 \\phi_g(x) = -\\frac{Q_0}{D_g}\n$$\nThe general solution $\\phi_g(x)$ is the sum of a homogeneous solution $\\phi_h(x)$ and a particular solution $\\phi_p(x)$.\n\nThe homogeneous equation is $\\frac{d^2\\phi_h(x)}{dx^2} - k^2 \\phi_h(x) = 0$. The characteristic equation is $r^2 - k^2 = 0$, with roots $r = \\pm k$. The homogeneous solution can be written as:\n$$\n\\phi_h(x) = A \\cosh(kx) + B \\sinh(kx)\n$$\nwhere $A$ and $B$ are constants to be determined by the boundary conditions.\n\nFor the particular solution, since the right-hand side is a constant, we can assume a constant particular solution $\\phi_p(x) = C$. Substituting this into the full differential equation gives:\n$$\n0 - k^2 C = -\\frac{Q_0}{D_g} \\implies C = \\frac{Q_0}{k^2 D_g} = \\frac{Q_0}{(\\Sigma_{a,g}/D_g) D_g} = \\frac{Q_0}{\\Sigma_{a,g}}\n$$\nSo, the particular solution is $\\phi_p(x) = \\frac{Q_0}{\\Sigma_{a,g}}$.\n\nThe general solution is the sum of the homogeneous and particular solutions:\n$$\n\\phi_g(x) = A \\cosh(kx) + B \\sinh(kx) + \\frac{Q_0}{\\Sigma_{a,g}}\n$$\nNow, we apply the boundary conditions $\\phi_g(0)=0$ and $\\phi_g(L)=0$.\nAt $x=0$:\n$$\n\\phi_g(0) = A \\cosh(0) + B \\sinh(0) + \\frac{Q_0}{\\Sigma_{a,g}} = A \\cdot 1 + B \\cdot 0 + \\frac{Q_0}{\\Sigma_{a,g}} = 0\n$$\nThis gives $A = -\\frac{Q_0}{\\Sigma_{a,g}}$.\n\nAt $x=L$:\n$$\n\\phi_g(L) = A \\cosh(kL) + B \\sinh(kL) + \\frac{Q_0}{\\Sigma_{a,g}} = 0\n$$\nSubstitute the value of $A$:\n$$\n-\\frac{Q_0}{\\Sigma_{a,g}} \\cosh(kL) + B \\sinh(kL) + \\frac{Q_0}{\\Sigma_{a,g}} = 0\n$$\n$$\nB \\sinh(kL) = \\frac{Q_0}{\\Sigma_{a,g}} (\\cosh(kL) - 1)\n$$\n$$\nB = \\frac{Q_0}{\\Sigma_{a,g}} \\frac{\\cosh(kL)-1}{\\sinh(kL)}\n$$\nA more elegant approach is to recognize the symmetry of the problem and center the coordinate system at $x' = x - L/2$, where the domain is $[-L/2, L/2]$. The solution must be an even function in this new system, so the $\\sinh$ term vanishes. The solution takes the form $\\phi_g(x') = A' \\cosh(kx') + \\frac{Q_0}{\\Sigma_{a,g}}$ with boundary conditions $\\phi_g(\\pm L/2) = 0$. This leads to:\n$$\nA' \\cosh(kL/2) + \\frac{Q_0}{\\Sigma_{a,g}} = 0 \\implies A' = -\\frac{Q_0/\\Sigma_{a,g}}{\\cosh(kL/2)}\n$$\nSo, the solution in the shifted coordinates is:\n$$\n\\phi_g(x') = \\frac{Q_0}{\\Sigma_{a,g}} \\left( 1 - \\frac{\\cosh(kx')}{\\cosh(kL/2)} \\right)\n$$\nTransforming back to the original coordinate system $x = x' + L/2$:\n$$\n\\phi_g(x) = \\frac{Q_0}{\\Sigma_{a,g}} \\left( 1 - \\frac{\\cosh(k(x - L/2))}{\\cosh(kL/2)} \\right)\n$$\nFinally, substituting back $k = \\sqrt{\\frac{\\Sigma_{a,g}}{D_g}}$ gives the final expression for the scalar flux distribution:\n$$\n\\phi_g(x) = \\frac{Q_0}{\\Sigma_{a,g}} \\left( 1 - \\frac{\\cosh\\left(\\left(x - \\frac{L}{2}\\right) \\sqrt{\\frac{\\Sigma_{a,g}}{D_g}}\\right)}{\\cosh\\left(\\frac{L}{2} \\sqrt{\\frac{\\Sigma_{a,g}}{D_g}}\\right)} \\right)\n$$\nThis is the closed-form analytic expression for the steady-state scalar flux.",
            "answer": "$$\n\\boxed{\\frac{Q_{0}}{\\Sigma_{a,g}} \\left(1 - \\frac{\\cosh\\left(\\left(x - \\frac{L}{2}\\right) \\sqrt{\\frac{\\Sigma_{a,g}}{D_g}}\\right)}{\\cosh\\left(\\frac{L}{2} \\sqrt{\\frac{\\Sigma_{a,g}}{D_g}}\\right)}\\right)}\n$$"
        },
        {
            "introduction": "Simulating particle transport in an ADS, particularly through thick shielding, presents a significant computational challenge known as a \"deep penetration\" problem. This advanced exercise introduces a powerful variance reduction technique, Consistent Adjoint-Driven Importance Sampling (CADIS), used in Monte Carlo simulations to overcome this difficulty . By working through a conceptual shielding model, you will learn how the adjoint flux, which represents the \"importance\" of particles, can be used to bias the simulation and dramatically improve its efficiency without sacrificing accuracy.",
            "id": "4249230",
            "problem": "Consider a one-dimensional radial shielding model for an Accelerator-Driven System (ADS), in which source particles originate uniformly within a target region and traverse a slab of shielding of thickness $L$ (in meters) toward a detector at the outer surface. Neglect scattering and secondary production, and assume that transport is purely absorbing with groupwise macroscopic total cross sections $\\Sigma_t(g)$ (in inverse meters) for $g = 1, \\dots, G$. The slab is partitioned into $Z$ equal-width spatial zones with midpoints $x_i$ (in meters) for $i = 1, \\dots, Z$, and the detector is located at $x = L$. The survival probability from a source at zone $i$ and energy group $g$ to the detector is modeled by $s_{i,g} = \\exp\\left(-\\Sigma_t(g)\\,\\left(L - x_i\\right)\\right)$.\n\nLet the primary source distribution be uniform over spatial zones and energy groups, so that the discrete source weights $q_{i,g}$ satisfy $\\sum_{i=1}^{Z} \\sum_{g=1}^{G} q_{i,g} = 1$ and $q_{i,g} = 1/(Z\\,G)$. Assume that the adjoint flux map $\\phi^+_{i,g}$ is known for all $(i,g)$ and quantifies the importance of a source at $(x_i, g)$ to the detector response. The Consistent Adjoint-Driven Importance Sampling (CADIS) method biases source sampling according to adjoint importance while preserving the unbiased expectation of the detector response. Under unbiased sampling, the per-history score is constructed to yield the correct expectation of the detector response. Under CADIS-biased sampling, the per-history score must be adjusted consistently so that the expectation remains identical to the physical response while the variance is reduced.\n\nStarting from the linear Boltzmann transport equation and the definition of the adjoint flux as the solution of the adjoint transport equation corresponding to the detector response functional, derive the per-history score under unbiased sampling and under adjoint-biased sampling that preserves the correct expectation. From these, derive expressions for the variance of the per-history score under each sampling strategy and the variance reduction factor, defined as the ratio of the unbiased variance to the adjoint-biased variance.\n\nImplement a program that, for each test case specified below, computes the variance reduction factor using these derived expressions. Treat any zero adjoint flux entries by replacing them with a small positive floor $\\epsilon$ to avoid singular behavior, with $\\epsilon = 10^{-12}$.\n\nPhysical units: express the slab thickness $L$ in meters and the macroscopic total cross sections $\\Sigma_t(g)$ in inverse meters. The final variance reduction factor is dimensionless. Angles are not used. The final outputs must be floats.\n\nTest suite:\n- Common geometric discretization: $Z = 5$, $G = 3$, $L = 1.0$ (meters), zone midpoints $x_i = L\\,\\frac{i - 0.5}{Z}$ for $i \\in \\{1,2,3,4,5\\}$, i.e., $x_1 = 0.1$ (meters), $x_2 = 0.3$ (meters), $x_3 = 0.5$ (meters), $x_4 = 0.7$ (meters), $x_5 = 0.9$ (meters).\n- Case A (baseline shielding, uniform adjoint): $\\Sigma_t = [\\,1.0,\\,2.0,\\,4.0\\,]$ (inverse meters), $\\phi^+$ matrix is uniform with $\\phi^+_{i,g} = 1.0$ for all $i,g$.\n- Case B (moderate shielding, adjoint increases toward detector and favors higher energy): $\\Sigma_t = [\\,1.0,\\,2.0,\\,4.0\\,]$ (inverse meters), spatial base factors $b_i = [\\,0.2,\\,0.4,\\,0.6,\\,0.8,\\,1.0\\,]$, energy factors $e_g = [\\,0.5,\\,1.0,\\,2.0\\,]$, adjoint map defined by $\\phi^+_{i,g} = b_i\\,e_g$, i.e., the $5 \\times 3$ array\n$$\n\\begin{bmatrix}\n0.1  0.2  0.4 \\\\\n0.2  0.4  0.8 \\\\\n0.3  0.6  1.2 \\\\\n0.4  0.8  1.6 \\\\\n0.5  1.0  2.0\n\\end{bmatrix}\n$$\n- Case C (strong shielding, sharply peaked adjoint near detector with energy preference): $\\Sigma_t = [\\,2.0,\\,4.0,\\,8.0\\,]$ (inverse meters), spatial base factors $b_i = [\\,0.01,\\,0.02,\\,0.05,\\,0.2,\\,1.0\\,]$, energy factors $e_g = [\\,0.2,\\,1.0,\\,3.0\\,]$, adjoint map $\\phi^+_{i,g} = b_i\\,e_g$, i.e.,\n$$\n\\begin{bmatrix}\n0.002  0.01  0.03 \\\\\n0.004  0.02  0.06 \\\\\n0.01  0.05  0.15 \\\\\n0.04  0.2  0.6 \\\\\n0.2  1.0  3.0\n\\end{bmatrix}\n$$\n- Case D (moderate shielding, adjoint zero in low-importance regions): $\\Sigma_t = [\\,1.0,\\,2.0,\\,4.0\\,]$ (inverse meters), spatial base factors $b_i = [\\,0.0,\\,0.0,\\,0.1,\\,0.5,\\,1.0\\,]$, energy factors $e_g = [\\,1.0,\\,1.0,\\,1.0\\,]$, adjoint map $\\phi^+_{i,g} = b_i\\,e_g$, i.e.,\n$$\n\\begin{bmatrix}\n0.0  0.0  0.0 \\\\\n0.0  0.0  0.0 \\\\\n0.1  0.1  0.1 \\\\\n0.5  0.5  0.5 \\\\\n1.0  1.0  1.0\n\\end{bmatrix}\n$$\nYour program should compute the survival probabilities $s_{i,g}$, the physical response $R$, the unbiased per-history variance $\\mathrm{Var}_u$, the CADIS-biased per-history variance $\\mathrm{Var}_b$ using the derived consistent weights, and the variance reduction factor $\\mathrm{VRF} = \\mathrm{Var}_u / \\mathrm{Var}_b$ for each case. If $\\mathrm{Var}_b$ is below a numerical threshold (e.g., less than $10^{-18}$), treat the variance reduction factor as a large finite float by capping the denominator at $10^{-18}$ to avoid overflow, which corresponds to near-zero-variance behavior.\n\nFinal output format: Your program should produce a single line of output containing the variance reduction factors for the four cases in order A, B, C, D, as a comma-separated list enclosed in square brackets, with each float rounded to six decimal places (e.g., \"[1.234567,2.345678,3.456789,4.567890]\").",
            "solution": "This solution provides the derivation for the variance of the detector response score under both unbiased and adjoint-biased (CADIS) sampling, leading to the expression for the variance reduction factor (VRF). Let the discrete phase space be indexed by $(i,g)$, where $i \\in \\{1, \\dots, Z\\}$ is the spatial zone and $g \\in \\{1, \\dots, G\\}$ is the energy group.\n\n**1. Detector Response and Unbiased Sampling**\nThe physical detector response $R$ is the expectation of the survival probability $s_{i,g}$ over the source distribution $q_{i,g}$. Since the source is uniform, $q_{i,g} = 1/(ZG)$.\n$$ R = E[s] = \\sum_{i=1}^{Z} \\sum_{g=1}^{G} q_{i,g} s_{i,g} = \\frac{1}{ZG} \\sum_{i,g} s_{i,g} $$\nUnder unbiased sampling, a source particle's starting state $(i,g)$ is sampled from the probability distribution $q_{i,g}$. The score for this history is simply the survival probability, $s_{i,g}$.\nThe variance of this per-history score, $\\mathrm{Var}_u$, is given by the standard formula $\\mathrm{Var}(X) = E[X^2] - (E[X])^2$.\n$$ \\mathrm{Var}_u = E[s^2] - R^2 = \\left( \\sum_{i,g} q_{i,g} s_{i,g}^2 \\right) - R^2 $$\n$$ \\mathrm{Var}_u = \\frac{1}{ZG} \\sum_{i,g} s_{i,g}^2 - \\left(\\frac{1}{ZG} \\sum_{i,g} s_{i,g}\\right)^2 $$\n\n**2. Adjoint-Biased (CADIS) Sampling**\nIn CADIS, the goal is to sample source particles from a biased distribution $q'_{i,g}$ that is proportional to the particle importance, given by the adjoint flux $\\phi^+_{i,g}$. To maintain a valid probability distribution, $q'_{i,g}$ is normalized:\n$$ q'_{i,g} = \\frac{q_{i,g} \\phi^+_{i,g}}{\\sum_{j,k} q_{j,k} \\phi^+_{j,k}} = \\frac{q_{i,g} \\phi^+_{i,g}}{R_{\\text{adj}}} $$\nwhere $R_{\\text{adj}} = \\sum_{j,k} q_{j,k} \\phi^+_{j,k}$ is the adjoint-weighted source strength. To handle cases where $\\phi^+_{i,g}=0$, we use a floored adjoint flux $\\tilde{\\phi}^+_{i,g} = \\max(\\phi^+_{i,g}, \\epsilon)$. The biased distribution and normalization factor become:\n$$ \\tilde{q}'_{i,g} = \\frac{q_{i,g} \\tilde{\\phi}^+_{i,g}}{\\tilde{R}_{\\text{adj}}} \\quad \\text{with} \\quad \\tilde{R}_{\\text{adj}} = \\sum_{j,k} q_{j,k} \\tilde{\\phi}^+_{j,k} $$\nTo ensure the score remains unbiased, each history must be multiplied by a weight $w_{i,g}$ that corrects for the sampling bias. This weight is the ratio of the true probability to the biased probability:\n$$ w_{i,g} = \\frac{q_{i,g}}{\\tilde{q}'_{i,g}} = \\frac{q_{i,g}}{q_{i,g} \\tilde{\\phi}^+_{i,g} / \\tilde{R}_{\\text{adj}}} = \\frac{\\tilde{R}_{\\text{adj}}}{\\tilde{\\phi}^+_{i,g}} $$\nThe new, biased-sampling score for a history starting at $(i,g)$ is $s'_{i,g} = w_{i,g} s_{i,g}$. The expectation of this new score remains $R$:\n$$ E'[s'] = \\sum_{i,g} \\tilde{q}'_{i,g} s'_{i,g} = \\sum_{i,g} \\frac{q_{i,g} \\tilde{\\phi}^+_{i,g}}{\\tilde{R}_{\\text{adj}}} \\left( \\frac{\\tilde{R}_{\\text{adj}}}{\\tilde{\\phi}^+_{i,g}} s_{i,g} \\right) = \\sum_{i,g} q_{i,g} s_{i,g} = R $$\nThe variance under biased sampling, $\\mathrm{Var}_b$, is:\n$$ \\mathrm{Var}_b = E'[(s')^2] - (E'[s'])^2 = E'[(s')^2] - R^2 $$\nThe expectation of the squared score is:\n$$ E'[(s')^2] = \\sum_{i,g} \\tilde{q}'_{i,g} (s'_{i,g})^2 = \\sum_{i,g} \\frac{q_{i,g} \\tilde{\\phi}^+_{i,g}}{\\tilde{R}_{\\text{adj}}} \\left( \\frac{\\tilde{R}_{\\text{adj}} s_{i,g}}{\\tilde{\\phi}^+_{i,g}} \\right)^2 = \\tilde{R}_{\\text{adj}} \\sum_{i,g} q_{i,g} \\frac{s_{i,g}^2}{\\tilde{\\phi}^+_{i,g}} $$\nSo the biased variance is:\n$$ \\mathrm{Var}_b = \\left( \\tilde{R}_{\\text{adj}} \\sum_{i,g} q_{i,g} \\frac{s_{i,g}^2}{\\tilde{\\phi}^+_{i,g}} \\right) - R^2 $$\n$$ \\mathrm{Var}_b = \\left( \\left(\\frac{1}{ZG} \\sum_{j,k} \\tilde{\\phi}^+_{j,k}\\right) \\left(\\frac{1}{ZG} \\sum_{i,g} \\frac{s_{i,g}^2}{\\tilde{\\phi}^+_{i,g}}\\right) \\right) - R^2 $$\n\n**3. Variance Reduction Factor (VRF)**\nThe VRF is the ratio of the unbiased variance to the biased variance:\n$$ \\mathrm{VRF} = \\frac{\\mathrm{Var}_u}{\\mathrm{Var}_b} = \\frac{\\frac{1}{ZG} \\sum_{i,g} s_{i,g}^2 - R^2}{\\left( \\left(\\frac{1}{ZG} \\sum_{j,k} \\tilde{\\phi}^+_{j,k}\\right) \\left(\\frac{1}{ZG} \\sum_{i,g} \\frac{s_{i,g}^2}{\\tilde{\\phi}^+_{i,g}}\\right) \\right) - R^2} $$\nThe Python code implements these final expressions to calculate the VRF for each test case.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the variance reduction factor (VRF) for several test cases\n    of an ADS shielding problem using the CADIS method.\n    \"\"\"\n    # Common parameters\n    Z = 5  # Number of spatial zones\n    G = 3  # Number of energy groups\n    L = 1.0  # Slab thickness in meters\n    epsilon = 1e-12  # Floor for zero adjoint flux\n    var_b_floor = 1e-18 # Floor for biased variance denominator\n\n    # Define test cases\n    test_cases = [\n        {\n            \"name\": \"A\",\n            \"sigma_t\": [1.0, 2.0, 4.0],\n            \"phi_plus\": np.ones((Z, G))\n        },\n        {\n            \"name\": \"B\",\n            \"sigma_t\": [1.0, 2.0, 4.0],\n            \"phi_plus\": np.array([\n                [0.1, 0.2, 0.4],\n                [0.2, 0.4, 0.8],\n                [0.3, 0.6, 1.2],\n                [0.4, 0.8, 1.6],\n                [0.5, 1.0, 2.0]\n            ])\n        },\n        {\n            \"name\": \"C\",\n            \"sigma_t\": [2.0, 4.0, 8.0],\n            \"phi_plus\": np.array([\n                [0.002, 0.01, 0.03],\n                [0.004, 0.02, 0.06],\n                [0.01, 0.05, 0.15],\n                [0.04, 0.2, 0.6],\n                [0.2, 1.0, 3.0]\n            ])\n        },\n        {\n            \"name\": \"D\",\n            \"sigma_t\": [1.0, 2.0, 4.0],\n            \"phi_plus\": np.array([\n                [0.0, 0.0, 0.0],\n                [0.0, 0.0, 0.0],\n                [0.1, 0.1, 0.1],\n                [0.5, 0.5, 0.5],\n                [1.0, 1.0, 1.0]\n            ])\n        }\n    ]\n\n    results = []\n    \n    # Pre-compute spatial and source probability terms\n    x_midpoints = L * (np.arange(1, Z + 1) - 0.5) / Z\n    q_ig = 1.0 / (Z * G)\n    \n    for case in test_cases:\n        sigma_t = np.array(case[\"sigma_t\"]).reshape(1, G)\n        phi_plus = case[\"phi_plus\"]\n        \n        # 1. Calculate survival probabilities, s_ig\n        # Reshape for broadcasting: (Z,1) @ (1,G) -> (Z,G)\n        distances_to_detector = (L - x_midpoints).reshape(Z, 1)\n        s = np.exp(-distances_to_detector * sigma_t)\n        \n        # 2. Calculate true response R_true and unbiased variance Var_u\n        R_true = np.mean(s)\n        # Var_u = E[score^2] - (E[score])^2 = E[s^2] - R_true^2\n        # Since q_ig is uniform, the expectation is the mean.\n        Var_u = np.mean(s**2) - R_true**2\n        \n        # 3. Apply flooring to the adjoint flux map\n        phi_plus_tilde = np.maximum(phi_plus, epsilon)\n        \n        # 4. Calculate adjoint-based response estimate R_adj_tilde\n        # R_adj_tilde = sum(q_ig * phi_plus_tilde) = mean(phi_plus_tilde)\n        R_adj_tilde = np.mean(phi_plus_tilde)\n        \n        # 5. Calculate biased variance Var_b\n        # Var_b = R_adj_tilde * sum(q_ig * s_ig^2 / phi_plus_tilde_ig) - R_true^2\n        #       = R_adj_tilde * mean(s^2 / phi_plus_tilde) - R_true^2\n        term1_b = R_adj_tilde * np.mean((s**2) / phi_plus_tilde)\n        Var_b = term1_b - R_true**2\n        \n        # 6. Calculate Variance Reduction Factor (VRF)\n        # Apply floor to Var_b to handle near-zero variance cases\n        VRF = Var_u / np.maximum(Var_b, var_b_floor)\n        \n        results.append(VRF)\n\n    # Format and print the final output\n    print(f\"[{','.join(f'{r:.6f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}