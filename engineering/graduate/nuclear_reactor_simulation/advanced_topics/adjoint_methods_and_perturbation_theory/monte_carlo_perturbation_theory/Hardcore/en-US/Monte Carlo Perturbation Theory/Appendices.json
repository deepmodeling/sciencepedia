{
    "hands_on_practices": [
        {
            "introduction": "The foundation of the Likelihood Ratio (LR) method is the \"score,\" which is the derivative of the logarithm of the path probability density. This exercise provides hands-on practice in deriving this score from first principles for an analog Monte Carlo simulation, breaking it down into contributions from individual physical events like free flights and collisions . Mastering this decomposition is the first and most critical step toward implementing any LR-based sensitivity analysis in a transport code.",
            "id": "4236703",
            "problem": "A fixed-source neutron transport problem is simulated with an analog Monte Carlo (MC) method. The geometry is piecewise-homogeneous with a subregion $D$ in which only the microscopic absorption cross section is subject to a small multiplicative perturbation. Specifically, for $\\varepsilon$ in a neighborhood of $0$, the absorption and scattering macroscopic cross sections satisfy $\\Sigma_a(\\mathbf{r};\\varepsilon) = (1+\\varepsilon)\\,\\Sigma_a^0(\\mathbf{r})$ and $\\Sigma_s(\\mathbf{r};\\varepsilon) = \\Sigma_s^0(\\mathbf{r})$, so that $\\Sigma_t(\\mathbf{r};\\varepsilon) = \\Sigma_s^0(\\mathbf{r}) + (1+\\varepsilon)\\,\\Sigma_a^0(\\mathbf{r})$, with $\\Sigma_a^0(\\mathbf{r})>0$ only in $D$. The source probability density function (PDF) $q(\\mathbf{r},\\mathbf{\\Omega},E)$ and all angular/energy scattering PDFs are independent of $\\varepsilon$, and the geometry is not perturbed. A response is defined as $R = h(X)$, where $X$ denotes a full analog history (source to termination) and $h$ is a bounded tally functional that does not depend explicitly on $\\varepsilon$ (e.g., a track-length estimate of scalar flux in a detector volume disjoint from $D$).\n\nLet $p_\\varepsilon(X)$ denote the analog-history PDF under parameter $\\varepsilon$, and let $\\mathbb{E}_\\varepsilon[\\cdot]$ denote expectation with respect to $p_\\varepsilon$. The quantity of interest is $\\delta R \\equiv \\left.\\dfrac{\\mathrm{d}}{\\mathrm{d}\\varepsilon}\\mathbb{E}_\\varepsilon[R]\\right|_{\\varepsilon=0}$.\n\nThe Likelihood Ratio (LR) or score-function identity states that if $p_\\varepsilon$ is differentiable in $\\varepsilon$ and $h(X)$ is integrable, then $\\delta R = \\mathbb{E}_0\\!\\left[R\\,S(X)\\right]$, where $S(X) \\equiv \\left.\\dfrac{\\partial}{\\partial \\varepsilon}\\ln p_\\varepsilon(X)\\right|_{\\varepsilon=0}$ is the per-history score that can be accumulated along the analog trajectory as a sum of per-event contributions.\n\nWhich of the following option(s) correctly describe an implementable per-event LR accumulation in this setting to estimate $\\delta R$ without running the perturbed system? Select all that apply.\n\nA. At each free-flight segment of length $\\ell$ inside $D$, add the flight contribution $-\\displaystyle\\int_{\\text{segment}}\\dfrac{\\partial \\Sigma_t(\\mathbf{r};\\varepsilon)}{\\partial \\varepsilon}\\Big|_{\\varepsilon=0}\\,\\mathrm{d}s$ to the running score. At each analog collision in $D$ of reaction type $c\\in\\{a,s,f,\\dots\\}$, add the collision contribution $\\displaystyle\\left.\\dfrac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_c(\\mathbf{r};\\varepsilon)\\right|_{\\varepsilon=0}-\\left.\\dfrac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t(\\mathbf{r};\\varepsilon)\\right|_{\\varepsilon=0}$. Do not add any term for events outside $D$ or for angular/energy sampling, and add a source term $\\left.\\dfrac{\\partial}{\\partial \\varepsilon}\\ln q\\right|_{\\varepsilon=0}$ only if the source PDF depends on $\\varepsilon$. Form the unbiased estimator $\\widehat{\\delta R}=\\dfrac{1}{N}\\sum_{n=1}^{N} h(X_n)\\,S(X_n)$ from i.i.d. nominal histories $X_n\\sim p_0$.\n\nB. Ignore free-flight contributions and only add collision contributions at events in $D$ by incrementing the score by $\\dfrac{\\partial \\Sigma_c(\\mathbf{r};\\varepsilon)}{\\partial \\varepsilon}\\big|_{\\varepsilon=0}$ at each collision of type $c$, without any normalization by $\\Sigma_t$ or subtraction of a total cross section term. Form $\\widehat{\\delta R}$ as in Option A.\n\nC. At each free-flight segment inside $D$, add $-\\displaystyle\\int_{\\text{segment}}\\dfrac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t(\\mathbf{r};\\varepsilon)\\Big|_{\\varepsilon=0}\\,\\mathrm{d}s$, and at each collision in $D$, add $\\left.\\dfrac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t(\\mathbf{r};\\varepsilon)\\right|_{\\varepsilon=0}$. No other terms are needed. Form $\\widehat{\\delta R}$ as in Option A.\n\nD. Specializing to the given absorption-only perturbation, at each free-flight segment inside $D$ accumulate $-\\displaystyle\\int_{\\text{segment}}\\Sigma_a^0(\\mathbf{r})\\,\\mathrm{d}s$. At a collision in $D$, if the reaction is absorption, add $1-\\dfrac{\\Sigma_a^0(\\mathbf{r})}{\\Sigma_t^0(\\mathbf{r})}$; if it is scattering, add $-\\dfrac{\\Sigma_a^0(\\mathbf{r})}{\\Sigma_t^0(\\mathbf{r})}$. Do not add any score for events outside $D$, for boundary crossings, for angular/energy sampling, or for the source (since $q$ is independent of $\\varepsilon$). Estimate $\\delta R$ by multiplying the per-history score by $R$ and averaging over nominal histories.\n\nE. Each time a boundary between $D$ and the unperturbed region is crossed, add a jump term equal to $\\left(\\Sigma_t^0\\big|_{\\text{inside }D}-\\Sigma_t^0\\big|_{\\text{outside }D}\\right)\\times \\ell_{\\text{prev}}$, where $\\ell_{\\text{prev}}$ is the immediately preceding free-flight length, to account for the discontinuity of $\\Sigma_t$. Free-flight and collision contributions are otherwise unnecessary. Estimate $\\delta R$ as in Option A.\n\nAssume standard analog MC sampling: free flights from the exponential attenuation law, reaction type selected with probability proportional to reaction cross sections, and history termination on absorption, with no variance-reduction biasing and no fission source coupling (i.e., fixed source). State all correct options.",
            "solution": "We begin from first principles: the analog Monte Carlo (MC) method samples a neutron history $X$ according to the transport-process probability density function (PDF) $p_\\varepsilon(X)$ induced by the exponential attenuation between collisions, the selection of reaction type with probability proportional to the reaction macroscopic cross sections, the sampling of scattering kinematics from prescribed angular/energy PDFs, and the source PDF $q$. The response is $R=h(X)$, which does not depend explicitly on $\\varepsilon$. The Likelihood Ratio (LR) identity (also known as the score-function identity) asserts\n$$\n\\delta R \\equiv \\left.\\frac{\\mathrm{d}}{\\mathrm{d}\\varepsilon}\\mathbb{E}_\\varepsilon[R]\\right|_{\\varepsilon=0}\n= \\left.\\frac{\\mathrm{d}}{\\mathrm{d}\\varepsilon}\\int h(X)\\,p_\\varepsilon(X)\\,\\mathrm{d}X\\right|_{\\varepsilon=0}\n= \\int h(X)\\, \\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln p_\\varepsilon(X)\\right|_{\\varepsilon=0} p_0(X)\\,\\mathrm{d}X\n= \\mathbb{E}_0\\!\\left[R\\,S(X)\\right],\n$$\nwith the per-history score\n$$\nS(X) \\equiv \\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln p_\\varepsilon(X)\\right|_{\\varepsilon=0}.\n$$\nTo implement a per-event accumulation of $S(X)$, we factorize $\\ln p_\\varepsilon(X)$ as a sum over events. For a sequence of free-flight segments $j=1,\\dots,J$ of lengths $\\ell_j$ along paths $\\gamma_j$ between events and collisions $k=1,\\dots,K$ at locations $\\mathbf{r}_k$, in analog sampling we have\n- a free-flight survival factor $\\exp\\!\\left(-\\int_{\\gamma_j} \\Sigma_t(\\mathbf{r};\\varepsilon)\\,\\mathrm{d}s\\right)$, and hence a log-term $-\\int_{\\gamma_j} \\Sigma_t(\\mathbf{r};\\varepsilon)\\,\\mathrm{d}s$,\n- a reaction-type selection probability $\\Sigma_{c_k}(\\mathbf{r}_k;\\varepsilon)/\\Sigma_t(\\mathbf{r}_k;\\varepsilon)$, and hence a log-term $\\ln \\Sigma_{c_k}(\\mathbf{r}_k;\\varepsilon) - \\ln \\Sigma_t(\\mathbf{r}_k;\\varepsilon)$,\n- angular and energy PDFs and the source $q$, which by assumption do not depend on $\\varepsilon$.\n\nTherefore,\n$$\n\\ln p_\\varepsilon(X)\n= \\sum_{j=1}^{J} \\left(-\\int_{\\gamma_j} \\Sigma_t(\\mathbf{r};\\varepsilon)\\,\\mathrm{d}s\\right)\n+ \\sum_{k=1}^{K} \\left(\\ln \\Sigma_{c_k}(\\mathbf{r}_k;\\varepsilon) - \\ln \\Sigma_t(\\mathbf{r}_k;\\varepsilon)\\right)\n+ \\text{terms independent of }\\varepsilon,\n$$\nso that\n$$\nS(X) = \\sum_{j=1}^{J} \\left(-\\int_{\\gamma_j} \\left.\\frac{\\partial \\Sigma_t(\\mathbf{r};\\varepsilon)}{\\partial \\varepsilon}\\right|_{\\varepsilon=0}\\,\\mathrm{d}s\\right)\n+ \\sum_{k=1}^{K} \\left(\\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_{c_k}(\\mathbf{r}_k;\\varepsilon)\\right|_{\\varepsilon=0}\n- \\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t(\\mathbf{r}_k;\\varepsilon)\\right|_{\\varepsilon=0}\\right).\n$$\nSince only $\\Sigma_a$ is perturbed and only inside $D$, we have inside $D$\n$$\n\\left.\\frac{\\partial \\Sigma_t}{\\partial \\varepsilon}\\right|_{\\varepsilon=0} = \\Sigma_a^0,\\quad\n\\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_a\\right|_{\\varepsilon=0} = 1,\\quad\n\\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_s\\right|_{\\varepsilon=0} = 0,\\quad\n\\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t\\right|_{\\varepsilon=0} = \\frac{\\Sigma_a^0}{\\Sigma_t^0},\n$$\nand outside $D$ all these derivatives are $0$. Therefore, the score accumulates only when the particle is in $D$:\n- For any free-flight segment $\\gamma$ inside $D$, the flight contribution is\n$$\nS_{\\text{flight}}(\\gamma) = -\\int_{\\gamma} \\Sigma_a^0(\\mathbf{r})\\,\\mathrm{d}s.\n$$\n- For a collision in $D$:\n  - If the reaction is absorption ($c=a$), the collision contribution is\n  $$\n  S_{\\text{coll}} = \\left(1\\right) - \\left(\\frac{\\Sigma_a^0}{\\Sigma_t^0}\\right) = 1 - \\frac{\\Sigma_a^0}{\\Sigma_t^0}.\n  $$\n  - If the reaction is scattering ($c=s$), the collision contribution is\n  $$\n  S_{\\text{coll}} = \\left(0\\right) - \\left(\\frac{\\Sigma_a^0}{\\Sigma_t^0}\\right) = - \\frac{\\Sigma_a^0}{\\Sigma_t^0}.\n  $$\nThere are no source terms (since $q$ is independent of $\\varepsilon$), no terms from angular/energy sampling (by assumption), and no explicit boundary-crossing jump terms because $\\ln p_\\varepsilon$ is a sum of integrals and local reaction probabilities; boundaries only segment the path integrals.\n\nWith these principles established, we assess each option:\n\n- Option A: This option states the general per-event LR accumulation that follows directly from the factorization of $\\ln p_\\varepsilon(X)$ into free-flight and collision contributions, with source and other sampling contributions included only if their PDFs depend on $\\varepsilon$. It matches the derived form:\n$$\nS = \\sum_{\\text{segments}} \\left(-\\int \\frac{\\partial \\Sigma_t}{\\partial \\varepsilon}\\,\\mathrm{d}s\\right)\n+ \\sum_{\\text{collisions}} \\left(\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_c - \\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t\\right),\n$$\nwith contributions confined to $D$. The estimator $\\widehat{\\delta R} = \\frac{1}{N}\\sum h(X_n) S(X_n)$ is the standard LR estimator. Verdict: Correct.\n\n- Option B: This option ignores the free-flight contribution and adds an unnormalized $\\frac{\\partial \\Sigma_c}{\\partial \\varepsilon}$ at collisions. From the derivation, the collision term must be the derivative of the log of the reaction probability, i.e., $\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_c - \\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t$, and the free-flight survival contributes $-\\int \\frac{\\partial \\Sigma_t}{\\partial \\varepsilon}\\,\\mathrm{d}s$. Omitting the flight term and failing to subtract the $\\ln \\Sigma_t$ part yields a biased score. Verdict: Incorrect.\n\n- Option C: This option uses a flight term $-\\int \\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t\\,\\mathrm{d}s$ and a collision term $+\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t$. The correct flight contribution arises from the derivative of $-\\int \\Sigma_t\\,\\mathrm{d}s$, not of its logarithm; thus it should be $-\\int \\frac{\\partial \\Sigma_t}{\\partial \\varepsilon}\\,\\mathrm{d}s$. The collision term should be the difference of reaction and total log-derivatives, not a bare $\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t$. This double-counts the total cross section and mis-specifies the flight contribution. Verdict: Incorrect.\n\n- Option D: This is the specialization of Option A to the given perturbation. It uses\n$$\nS_{\\text{flight}} = -\\int \\Sigma_a^0\\,\\mathrm{d}s,\\quad\nS_{\\text{coll}} = \\begin{cases}\n1 - \\Sigma_a^0/\\Sigma_t^0, & c=a,\\\\\n-\\Sigma_a^0/\\Sigma_t^0, & c=s,\n\\end{cases}\n$$\napplied only inside $D$, with no source or boundary-crossing terms. This matches exactly the derived expressions. Verdict: Correct.\n\n- Option E: This posits a boundary-crossing jump term proportional to the difference in $\\Sigma_t^0$ times a preceding flight length, and dispenses with the principled free-flight and collision contributions. There is no such boundary jump in the derivative of $\\ln p_\\varepsilon$ when the geometry is fixed; the contributions come from the integral of $\\frac{\\partial \\Sigma_t}{\\partial \\varepsilon}$ along the path and the local reaction log-probabilities. Verdict: Incorrect.\n\nTherefore, the correct options are A and D.",
            "answer": "$$\\boxed{AD}$$"
        },
        {
            "introduction": "Real-world Monte Carlo simulations, especially for reactor eigenvalue problems, are rarely purely analog; they rely on variance reduction techniques like splitting and Russian roulette to be efficient. This practice explores the critical and non-trivial interaction between these population control mechanisms and the Likelihood Ratio estimator . Understanding how to correctly account for these algorithmic features is essential for implementing unbiased sensitivity calculations in production-level codes.",
            "id": "4236732",
            "problem": "Consider a steady-state neutron multiplication problem in a nuclear reactor core, where the fundamental mode eigenvalue problem of the linear Boltzmann transport with fission is simulated by Monte Carlo (MC) power iteration. Let the physical path measure for a single particle history be denoted by the parameterized density $p_{\\epsilon}(\\omega)$, where $\\epsilon$ controls a small perturbation to material cross sections and $p_{\\epsilon}$ encodes the analog physics of free flights, collisions, and fission events. Let a scalar response be $R(\\epsilon) = \\mathbb{E}_{\\epsilon}[T(\\omega)]$ for a cycle-average tally $T(\\omega)$ taken with the standard per-cycle source normalization used in eigenvalue MC. Define $\\delta R = \\left.\\frac{\\mathrm{d}}{\\mathrm{d}\\epsilon} R(\\epsilon)\\right|_{\\epsilon=0}$. The Likelihood Ratio (LR) method constructs the pathwise score \n$$\nL(\\omega) = \\left.\\frac{\\partial}{\\partial \\epsilon} \\ln p_{\\epsilon}(\\omega)\\right|_{\\epsilon=0}\n$$\nand forms an unbiased estimator of $\\delta R$ by augmenting the tally with $L(\\omega)$ (together with any additional terms required when the tally includes $\\epsilon$-dependent normalization). In eigenvalue MC, population control and variance reduction are often implemented by splitting and Russian roulette. In splitting, a particle of weight $w$ is replaced by $M$ offspring, each initially assigned weight $w/M$, where $M$ may depend on a user-prescribed importance map but is designed so that expected weight is conserved. In Russian roulette, a particle of weight $w$ is terminated with kill probability $p_{k}$ and, conditional on survival, its weight is increased to $w/(1-p_{k})$, again conserving expected weight. Population control and MC power iteration apply a per-cycle normalization factor $c_{\\epsilon}$ to stabilize the particle population, which depends (implicitly or explicitly) on the eigenvalue and therefore on $\\epsilon$.\n\nFrom first principles of importance sampling and change-of-measure, the LR estimator is constructed with respect to the physical path density $p_{\\epsilon}$, while splitting, roulette, and per-cycle normalization are parts of the sampling scheme that may or may not depend on $\\epsilon$. Analyze how splitting and Russian roulette affect the accumulation of $L(\\omega)$ and the unbiasedness of $\\delta R$. Choose all statements that are correct.\n\nA. In eigenvalue MC, the per-cycle source normalization introduces a factor $c_{\\epsilon}$ in the tally definition. The LR score must include the contribution $\\left.\\frac{\\partial}{\\partial \\epsilon}\\ln c_{\\epsilon}\\right|_{\\epsilon=0}$ to preserve unbiasedness of $\\delta R$. Splitting and Russian roulette, when implemented with $\\epsilon$-independent branching and weight adjustments that conserve expected weight, do not alter $L(\\omega)$ and do not bias the LR-based $\\delta R$ estimator.\n\nB. Splitting multiplies the LR $L(\\omega)$ by the realized multiplicity $M$, because each offspring copies the parent’s $L(\\omega)$; unless $L(\\omega)$ is divided by $M$ after splitting, the LR-based estimator of $\\delta R$ is biased high.\n\nC. Russian roulette affects only the variance of the LR-based estimator. If the survival probability $p_{\\text{surv}} = 1 - p_{k}$ is independent of $\\epsilon$ and survivors are reweighted by $1/p_{\\text{surv}}$, then the accumulation of $L(\\omega)$ is unchanged and $\\delta R$ remains unbiased.\n\nD. In eigenvalue MC, any use of splitting or Russian roulette necessarily biases the LR-based estimator of $\\delta R$ because the number of contributing histories changes under population control; to avoid bias, these techniques must be disabled when computing $\\delta R$.\n\nE. If the splitting importance map or roulette thresholds depend on cross sections that are perturbed by $\\epsilon$, then the branching probabilities depend on $\\epsilon$; in this case, the LR must include the derivative of the log of the splitting or roulette decision probability, and omitting this term biases $\\delta R$.\n\nSelect all correct options.",
            "solution": "### Derivation from First Principles\nThe response is given by $R(\\epsilon) = \\mathbb{E}_{\\epsilon}[T(\\omega)]$. The problem states that the tally $T(\\omega)$ includes an $\\epsilon$-dependent normalization factor $c_{\\epsilon}$. Let us write the tally as $T(\\omega, \\epsilon) = c_{\\epsilon} T_u(\\omega)$, where $T_u(\\omega)$ is an unnormalized tally score that depends only on the physical path $\\omega$ and not on $\\epsilon$. The expectation is taken over the path measure $p_{\\epsilon}(\\omega)$:\n$$\nR(\\epsilon) = \\int T(\\omega, \\epsilon) p_{\\epsilon}(\\omega) \\mathrm{d}\\omega = c_{\\epsilon} \\int T_u(\\omega) p_{\\epsilon}(\\omega) \\mathrm{d}\\omega\n$$\nWe seek the derivative $\\delta R = \\left.\\frac{\\mathrm{d}R}{\\mathrm{d}\\epsilon}\\right|_{\\epsilon=0}$. Using the product rule:\n$$\n\\frac{\\mathrm{d}R}{\\mathrm{d}\\epsilon} = \\frac{\\mathrm{d}c_{\\epsilon}}{\\mathrm{d}\\epsilon} \\int T_u(\\omega) p_{\\epsilon}(\\omega) \\mathrm{d}\\omega + c_{\\epsilon} \\int T_u(\\omega) \\frac{\\mathrm{d}p_{\\epsilon}(\\omega)}{\\mathrm{d}\\epsilon} \\mathrm{d}\\omega\n$$\nUsing the identity $\\frac{\\mathrm{d}p_{\\epsilon}}{\\mathrm{d}\\epsilon} = \\left(\\frac{\\mathrm{d} \\ln p_{\\epsilon}}{\\mathrm{d}\\epsilon}\\right) p_{\\epsilon}$, we substitute this into the second term:\n$$\n\\frac{\\mathrm{d}R}{\\mathrm{d}\\epsilon} = \\frac{\\mathrm{d}c_{\\epsilon}}{\\mathrm{d}\\epsilon} \\int T_u(\\omega) p_{\\epsilon}(\\omega) \\mathrm{d}\\omega + c_{\\epsilon} \\int T_u(\\omega) \\left(\\frac{\\mathrm{d} \\ln p_{\\epsilon}}{\\mathrm{d}\\epsilon}\\right) p_{\\epsilon}(\\omega) \\mathrm{d}\\omega\n$$\nEvaluating this expression at $\\epsilon=0$, we note that the integrals become expectations with respect to the unperturbed measure $p_{0}(\\omega)$, denoted by $\\mathbb{E}_{0}[\\cdot]$.\n$$\n\\delta R = \\left.\\frac{\\mathrm{d}c_{\\epsilon}}{\\mathrm{d}\\epsilon}\\right|_{\\epsilon=0} \\mathbb{E}_{0}[T_u(\\omega)] + c_{0} \\mathbb{E}_{0}\\left[T_u(\\omega) \\left.\\left(\\frac{\\mathrm{d} \\ln p_{\\epsilon}}{\\mathrm{d}\\epsilon}\\right)\\right|_{\\epsilon=0}\\right]\n$$\nBy definition, $L(\\omega) = \\left.\\frac{\\partial}{\\partial \\epsilon} \\ln p_{\\epsilon}(\\omega)\\right|_{\\epsilon=0}$. Also, $\\left.\\frac{\\mathrm{d}c_{\\epsilon}}{\\mathrm{d}\\epsilon}\\right|_{\\epsilon=0} = c_0 \\left.\\frac{\\mathrm{d} \\ln c_{\\epsilon}}{\\mathrm{d}\\epsilon}\\right|_{\\epsilon=0}$. Furthermore, $T(\\omega, 0) = c_0 T_u(\\omega)$. Substituting these gives:\n$$\n\\delta R = c_0 \\left.\\frac{\\mathrm{d} \\ln c_{\\epsilon}}{\\mathrm{d}\\epsilon}\\right|_{\\epsilon=0} \\frac{1}{c_0}\\mathbb{E}_{0}[T(\\omega, 0)] + \\mathbb{E}_{0}[T(\\omega, 0) L(\\omega)]\n$$\n$$\n\\delta R = \\mathbb{E}_{0}\\left[ T(\\omega, 0) \\left( L(\\omega) + \\left.\\frac{\\mathrm{d} \\ln c_{\\epsilon}}{\\mathrm{d}\\epsilon}\\right|_{\\epsilon=0} \\right) \\right]\n$$\nThis shows that an unbiased estimator for $\\delta R$ is obtained by scoring the quantity $T(\\omega, 0) \\left( L(\\omega) + \\left.\\frac{\\mathrm{d} \\ln c_{\\epsilon}}{\\mathrm{d}\\epsilon}\\right|_{\\epsilon=0} \\right)$ for each history $\\omega$ sampled from the unperturbed system $p_{0}(\\omega)$.\n\nNow, consider the effect of splitting and Russian roulette. These are variance reduction techniques that operate on weighted particles. They are designed to preserve the expectation of any tallied score. Let $S(\\omega)$ be any score for an analog history $\\omega$. In a non-analog simulation with weights, the estimator is the average of $w(\\omega)S(\\omega)$, where $w$ is the particle weight. The games are constructed such that $\\mathbb{E}_{\\text{non-analog}}[w S] = \\mathbb{E}_{\\text{analog}}[S]$. The LR method requires tallying $S'(\\omega) = T(\\omega, 0) \\left( L(\\omega) + \\left.\\frac{\\mathrm{d} \\ln c_{\\epsilon}}{\\mathrm{d}\\epsilon}\\right|_{\\epsilon=0} \\right)$. The MC code will estimate $\\mathbb{E}_{0}[S'(\\omega)]$ by averaging $w(\\omega)S'(\\omega)$. The key question is whether the use of splitting and RR makes this estimate biased.\n\nCase 1: Splitting/RR rules are independent of $\\epsilon$.\nIn this case, the probabilities governing the splitting/RR decisions are not part of the physical path density $p_{\\epsilon}(\\omega)$. They are part of the sampling algorithm, not the underlying probability measure being differentiated. The LR score $L(\\omega)$ is accumulated along the physical path, unaffected by these games.\n-   At a splitting event, a particle with weight $w$ and accumulated score $L$ is replaced by $M$ particles, each given weight $w/M$ and inheriting the score $L$. The total score-weight product is conserved: $w L \\rightarrow \\sum_{i=1}^M (w/M) L = wL$.\n-   At an RR event, a particle with weight $w$ and score $L$ is killed with probability $p_k$ or survives with weight $w/(1-p_k)$ and score $L$ with probability $1-p_k$. The expected score-weight product is conserved: $(0 \\cdot p_k) + ( \\frac{w}{1-p_k} L \\cdot (1-p_k) ) = wL$.\nSince the expected value of the score-weight product is conserved at each step, the overall expectation of the final tallied quantity $w(\\omega)S'(\\omega)$ is preserved. The estimator remains unbiased.\n\nCase 2: Splitting/RR rules depend on $\\epsilon$.\nThis occurs if the importance map or other parameters for these games are functions of the perturbed cross sections. In this scenario, the probabilities of the splitting/RR branching events must be considered part of the overall path density $p_{\\epsilon}(\\omega)$. For instance, if the probability of a specific splitting decision is $q_{\\epsilon}$, then $\\ln p_{\\epsilon}(\\omega)$ contains a term $\\ln q_{\\epsilon}$. Consequently, the LR score $L(\\omega)$ must include the term $\\left.\\frac{\\partial}{\\partial \\epsilon} \\ln q_{\\epsilon}\\right|_{\\epsilon=0}$. Omitting this term means the score $L(\\omega)$ is incomplete, and the resulting estimator for $\\delta R$ will be biased.\n\n### Option-by-Option Analysis\n\n**A. In eigenvalue MC, the per-cycle source normalization introduces a factor $c_{\\epsilon}$ in the tally definition. The LR score must include the contribution $\\left.\\frac{\\partial}{\\partial \\epsilon}\\ln c_{\\epsilon}\\right|_{\\epsilon=0}$ to preserve unbiasedness of $\\delta R$. Splitting and Russian roulette, when implemented with $\\epsilon$-independent branching and weight adjustments that conserve expected weight, do not alter $L(\\omega)$ and do not bias the LR-based $\\delta R$ estimator.**\n-   The first part regarding the normalization constant $c_{\\epsilon}$ is confirmed by our derivation. The full multiplier on the tally a posteriori is the sum of the physical score $L(\\omega)$ and the term from the normalization derivative. It is common practice to refer to this entire corrective factor as the \"score.\"\n-   The second part corresponds to Case $1$ in our analysis. If the variance reduction games are $\\epsilon$-independent, they are simply part of the machinery for sampling from $p_0(\\omega)$ and correctly preserve the expectation of the LR estimator.\n-   **Verdict: Correct.**\n\n**B. Splitting multiplies the LR $L(\\omega)$ by the realized multiplicity $M$, because each offspring copies the parent’s $L(\\omega)$; unless $L(\\omega)$ is divided by $M$ after splitting, the LR-based estimator of $\\delta R$ is biased high.**\n-   This statement fundamentally misunderstands the interplay between weights and scores. Each of the $M$ offspring inherits the parent's score $L(\\omega)$, but also has its weight divided by $M$. The quantity that is conserved in expectation is the score-weight product $w L$. The statement incorrectly suggests that the total score is multiplied by $M$. The total score-weight is what is conserved instantaneously at the split ($w L \\rightarrow M \\times \\frac{w}{M} \\times L = w L$), and the estimator remains unbiased without any ad-hoc division of $L(\\omega)$.\n-   **Verdict: Incorrect.**\n\n**C. Russian roulette affects only the variance of the LR-based estimator. If the survival probability $p_{\\text{surv}} = 1 - p_{k}$ is independent of $\\epsilon$ and survivors are reweighted by $1/p_{\\text{surv}}$, then the accumulation of $L(\\omega)$ is unchanged and $\\delta R$ remains unbiased.**\n-   This is a correct and specific instance of Case $1$ from our analysis, applied to Russian roulette. If the survival probability is $\\epsilon$-independent, the RR game does not contribute to the LR score $L(\\omega)$. The weight adjustment $w \\rightarrow w/p_{\\text{surv}}$ ensures that the expected score-weight product is conserved, thereby preserving unbiasedness. The purpose of RR is indeed to control variance (by culling low-importance particles).\n-   **Verdict: Correct.**\n\n**D. In eigenvalue MC, any use of splitting or Russian roulette necessarily biases the LR-based estimator of $\\delta R$ because the number of contributing histories changes under population control; to avoid bias, these techniques must be disabled when computing $\\delta R$.**\n-   This statement is an overgeneralization and is factually incorrect. As demonstrated by the analysis for options A and C, if the splitting and RR games are designed to be independent of the perturbation parameter $\\epsilon$, they do not introduce bias. The weight adjustment mechanism is precisely what accounts for the changing number of particles/histories to ensure the expectation remains correct. Disabling these techniques is a sufficient but not a necessary condition for unbiasedness, and doing so would often be computationally prohibitive.\n-   **Verdict: Incorrect.**\n\n**E. If the splitting importance map or roulette thresholds depend on cross sections that are perturbed by $\\epsilon$, then the branching probabilities depend on $\\epsilon$; in this case, the LR must include the derivative of the log of the splitting or roulette decision probability, and omitting this term biases $\\delta R$.**\n-   This statement correctly describes Case $2$ from our analysis. If the rules of the variance reduction game depend on $\\epsilon$, their probabilities are part of the full path measure $p_{\\epsilon}(\\omega)$. Therefore, the LR score $L(\\omega)$ must be augmented with terms corresponding to the derivatives of the logarithms of these branching probabilities. Failing to include these terms leads to an incomplete score and a biased estimator for $\\delta R$.\n-   **Verdict: Correct.**",
            "answer": "$$\\boxed{ACE}$$"
        },
        {
            "introduction": "After implementing a complex algorithm, how can you be confident it is correct? This exercise provides a powerful hands-on lesson in verification and validation by tasking you with building a test to compare a Monte Carlo sensitivity estimate against a deterministic \"gold standard\" . By implementing an adjoint-weighted estimator and comparing it to a direct solution of the adjoint diffusion equation, you will not only verify your method but also gain a deeper appreciation for the profound connection between forward Monte Carlo simulations and adjoint-based perturbation theory.",
            "id": "4236743",
            "problem": "Consider a one-dimensional slab model suitable for nuclear reactor simulation. Let the spatial variable be dimensionless and restricted to the interval $x \\in [0,1]$. The forward neutron diffusion problem is defined by the equation $-D \\frac{d^2 \\phi}{dx^2} + \\Sigma_a \\phi = S(x)$ with boundary conditions $\\phi(0) = 0$ and $\\phi(1) = 0$, where $D > 0$ is the diffusion coefficient, $\\Sigma_a > 0$ is the absorption coefficient, $S(x)$ is a prescribed source, and $\\phi(x)$ is the scalar flux. Define the response functional $R[\\phi] = \\int_0^1 \\Sigma_a \\phi(x) \\, dx$ in dimensionless units.\n\nYour task is to use first principles of Monte Carlo perturbation theory to derive and implement an adjoint-weighted sensitivity estimator for a small perturbation $\\delta \\Sigma_a(x)$ in the absorption coefficient. The estimator must be compared against a deterministic adjoint-based computation for the same model. Begin from the following foundational bases:\n\n- The forward diffusion operator for the scalar flux, $A[\\phi] = -D \\frac{d^2 \\phi}{dx^2} + \\Sigma_a \\phi$, with homogeneous Dirichlet boundary conditions on $[0,1]$.\n- The adjoint problem defined by the adjoint operator $A^\\dagger$ acting on the adjoint flux $\\psi^\\dagger(x)$ corresponding to the response functional $R[\\phi]$, under the same type of boundary conditions.\n- The first-order perturbation theory relation between the change in a response and the adjoint-weighted interaction with the operator variation, expressed in inner-product form on $[0,1]$.\n\nConstruct a program that:\n1. Solves the forward problem to obtain $\\phi(x)$ for constant $S(x) = S_0$ and constant coefficients $D$ and $\\Sigma_a$.\n2. Solves the adjoint problem to obtain $\\psi^\\dagger(x)$ for the same domain and boundary conditions.\n3. Computes a deterministic first-order sensitivity to $\\delta \\Sigma_a(x)$ using the adjoint-based perturbation framework.\n4. Computes a Monte Carlo estimate of the same sensitivity by sampling $x \\in [0,1]$ and applying the adjoint-weighted estimator derived from first principles. Use uniform sampling on $[0,1]$ and express all quantities in dimensionless units.\n5. Compares the Monte Carlo estimate and the deterministic adjoint-based result using the relative difference defined as $|S_{\\text{MC}} - S_{\\text{DET}}| / |S_{\\text{DET}}|$ and returns a boolean indicating whether the relative difference is less than a specified tolerance for each test case.\n\nUse the following test suite, with all parameters expressed in dimensionless units:\n- Test case $1$: $D = 0.2$, $\\Sigma_a = 0.5$, $S_0 = 1.0$, $\\delta \\Sigma_a(x) = 0.05$ for all $x \\in [0,1]$.\n- Test case $2$: $D = 0.2$, $\\Sigma_a = 0.5$, $S_0 = 1.0$, $\\delta \\Sigma_a(x) = 0.1$ for $x \\in [0.4,0.6]$ and $\\delta \\Sigma_a(x) = 0$ elsewhere.\n- Test case $3$: $D = 0.3$, $\\Sigma_a = 0.01$, $S_0 = 1.0$, $\\delta \\Sigma_a(x) = 0.02$ for all $x \\in [0,1]$.\n- Test case $4$: $D = 0.05$, $\\Sigma_a = 2.0$, $S_0 = 1.0$, $\\delta \\Sigma_a(x) = -0.02$ for all $x \\in [0,1]$.\n\nMonte Carlo sampling details:\n- For each test case, use $N = 500000$ independent uniform samples of $x$ over $[0,1]$.\n- Use a deterministic numerical integration over a fine spatial grid to compute the adjoint-based sensitivity for comparison.\n\nAcceptance criterion:\n- For each test case, produce a boolean value that is $true$ if the relative difference is less than $0.01$, and $false$ otherwise.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[true,false,true,false]\"), where each entry corresponds to the test cases in the order listed above. All values are to be dimensionless floats or booleans as specified; no physical units are to be used in the output.",
            "solution": "### 1. The Forward Problem and its Solution\n\nThe physical system is described by the one-dimensional, one-group neutron diffusion equation for the scalar flux $\\phi(x)$ in a slab of dimensionless width $1$:\n$$ -D \\frac{d^2 \\phi}{dx^2} + \\Sigma_a \\phi = S_0, \\quad x \\in (0, 1) $$\nwith homogeneous Dirichlet boundary conditions $\\phi(0) = 0$ and $\\phi(1) = 0$. The parameters $D$, $\\Sigma_a$, and $S_0$ are positive constants.\n\nThis is a second-order linear ordinary differential equation with constant coefficients. Its solution can be found by combining a particular solution with the general solution of the homogeneous equation.\nLet $k^2 = \\Sigma_a / D$. The equation can be written as $\\phi''(x) - k^2 \\phi(x) = -S_0/D$.\nA particular solution is $\\phi_p(x) = S_0 / \\Sigma_a$.\nThe homogeneous solution is $\\phi_h(x) = C_1 \\cosh(kx) + C_2 \\sinh(kx)$.\nThe general solution is $\\phi(x) = C_1 \\cosh(kx) + C_2 \\sinh(kx) + S_0 / \\Sigma_a$.\n\nApplying the boundary conditions to find the constants $C_1$ and $C_2$ yields a solution that can be expressed in a symmetric form:\n$$ \\phi(x) = \\frac{S_0}{\\Sigma_a} \\left( 1 - \\frac{\\cosh(k(x - 1/2))}{\\cosh(k/2)} \\right) $$\nwhere $k = \\sqrt{\\Sigma_a / D}$. This analytical expression for the forward flux will be used in subsequent calculations.\n\n### 2. The Adjoint Problem and its Solution\n\nThe adjoint problem is necessary for an efficient calculation of the sensitivity of the response functional. The response functional is given by:\n$$ R[\\phi] = \\int_0^1 \\Sigma_a \\phi(x) \\, dx $$\nThis is a linear functional of the flux $\\phi$. In inner product notation, $\\langle f, g \\rangle = \\int_0^1 f(x)g(x)dx$, the response is $R[\\phi] = \\langle \\Sigma_a, \\phi \\rangle$.\n\nThe adjoint equation is defined by $A^\\dagger \\psi^\\dagger = S^\\dagger$, where $A^\\dagger$ is the adjoint of the forward operator $A[\\phi] = -D \\frac{d^2 \\phi}{dx^2} + \\Sigma_a \\phi$, and $S^\\dagger$ is the adjoint source. The adjoint operator $A^\\dagger$ is found via the relation $\\langle \\psi^\\dagger, A\\phi \\rangle = \\langle A^\\dagger\\psi^\\dagger, \\phi \\rangle$. For the given operator and homogeneous Dirichlet boundary conditions on both $\\phi$ and $\\psi^\\dagger$, the operator is self-adjoint, meaning $A^\\dagger = A$.\n\nThe adjoint source $S^\\dagger$ is the kernel of the response functional. For $R[\\phi] = \\langle \\Sigma_a, \\phi \\rangle$, the adjoint source is $S^\\dagger(x) = \\Sigma_a$.\n\nThus, the adjoint problem for the adjoint flux, $\\psi^\\dagger(x)$, is:\n$$ -D \\frac{d^2 \\psi^\\dagger}{dx^2} + \\Sigma_a \\psi^\\dagger = \\Sigma_a, \\quad x \\in (0, 1) $$\nwith boundary conditions $\\psi^\\dagger(0) = 0$ and $\\psi^\\dagger(1) = 0$.\n\nThis equation is structurally identical to the forward problem, with the source term $S_0$ replaced by $\\Sigma_a$. By inspection, a particular solution is $\\psi^\\dagger_p(x)=1$. Following the same solution procedure as for the forward flux, we obtain the analytical solution for the adjoint flux:\n$$ \\psi^\\dagger(x) = 1 - \\frac{\\cosh(k(x - 1/2))}{\\cosh(k/2)} $$\nwhere $k$ is the same as in the forward problem.\n\n### 3. First-Order Perturbation Theory and Deterministic Sensitivity\n\nWe are interested in the first-order change in the response, $\\delta R$, due to a small perturbation in the absorption cross-section, $\\Sigma_a \\rightarrow \\Sigma_a + \\delta\\Sigma_a(x)$. This perturbation affects both the operator $A$ and the response functional $R$.\nThe perturbed operator is $A' = A + \\delta A$, where $\\delta A[\\phi] = \\delta\\Sigma_a(x)\\phi(x)$.\nThe perturbed response functional is $R'[\\phi'] = \\int_0^1 (\\Sigma_a + \\delta\\Sigma_a)\\phi' dx$, where $\\phi'$ is the perturbed flux.\n\nThe first-order change $\\delta R$ is given by:\n$$ \\delta R = R'[\\phi'] - R[\\phi] \\approx \\underbrace{\\int_0^1 \\delta\\Sigma_a(x) \\phi(x) \\, dx}_{\\text{Direct Effect}} + \\underbrace{\\int_0^1 \\Sigma_a \\delta\\phi(x) \\, dx}_{\\text{Indirect Effect}} $$\nwhere $\\delta\\phi = \\phi' - \\phi$.\nThe indirect effect can be evaluated using the adjoint flux. From first-order perturbation theory, $A\\delta\\phi \\approx -\\delta A \\phi$.\n$$ \\text{Indirect Effect} = \\langle \\Sigma_a, \\delta\\phi \\rangle = \\langle S^\\dagger, \\delta\\phi \\rangle = \\langle A^\\dagger \\psi^\\dagger, \\delta\\phi \\rangle = \\langle \\psi^\\dagger, A \\delta\\phi \\rangle \\approx \\langle \\psi^\\dagger, -\\delta A \\phi \\rangle $$\nSubstituting $\\delta A[\\phi] = \\delta\\Sigma_a(x)\\phi(x)$, the indirect effect becomes $-\\int_0^1 \\psi^\\dagger(x) \\delta\\Sigma_a(x) \\phi(x) \\, dx$.\n\nCombining the direct and indirect effects, the total sensitivity, which we denote $S_{DET}$, is:\n$$ S_{DET} = \\delta R \\approx \\int_0^1 \\delta\\Sigma_a(x) \\phi(x) \\, dx - \\int_0^1 \\psi^\\dagger(x) \\delta\\Sigma_a(x) \\phi(x) \\, dx $$\n$$ S_{DET} = \\int_0^1 \\delta\\Sigma_a(x) \\phi(x) (1 - \\psi^\\dagger(x)) \\, dx $$\nThis integral will be computed numerically to high precision using the derived analytical expressions for $\\phi(x)$ and $\\psi^\\dagger(x)$ to serve as the deterministic reference value.\n\n### 4. Monte Carlo Sensitivity Estimator\n\nThe integral for $S_{DET}$ can be estimated using the Monte Carlo method. The problem specifies sampling the spatial variable $x$ uniformly from the interval $[0, 1]$. Let the integrand be $I(x) = \\delta\\Sigma_a(x) \\phi(x) (1 - \\psi^\\dagger(x))$.\nThe integral is $S_{DET} = \\int_0^1 I(x) \\, dx$.\n\nFor a set of $N$ independent samples $\\{x_i\\}_{i=1}^N$ drawn from the uniform distribution $U(0, 1)$, whose probability density function is $p(x) = 1$ on $[0, 1]$, the Monte Carlo estimator for the integral is the sample mean of the integrand:\n$$ S_{MC} = \\frac{1}{N} \\sum_{i=1}^{N} I(x_i) = \\frac{1}{N} \\sum_{i=1}^{N} \\delta\\Sigma_a(x_i) \\phi(x_i) (1 - \\psi^\\dagger(x_i)) $$\nThis is the \"adjoint-weighted sensitivity estimator\" required by the problem. The term $\\phi(x_i) (1 - \\psi^\\dagger(x_i))$ represents the contribution to the sensitivity from a perturbation at location $x_i$, weighted by the forward and adjoint fluxes at that point.\n\n### 5. Computational Procedure\n\nFor each test case, the following procedure is implemented:\n1.  Define the physical parameters $D$, $\\Sigma_a$, $S_0$, and the perturbation function $\\delta\\Sigma_a(x)$.\n2.  Define the analytical functions for the forward flux $\\phi(x)$ and adjoint flux $\\psi^\\dagger(x)$ based on these parameters.\n3.  Compute the deterministic sensitivity $S_{DET}$ by numerically integrating the integrand $I(x) = \\delta\\Sigma_a(x) \\phi(x) (1 - \\psi^\\dagger(x))$ over the domain $[0, 1]$ (or the relevant sub-domain where $\\delta\\Sigma_a(x) \\neq 0$).\n4.  Compute the Monte Carlo estimate $S_{MC}$ by generating $N = 500000$ uniform random samples of $x$ in $[0, 1]$, evaluating $I(x)$ for each sample, and calculating the average.\n5.  Calculate the relative difference, $RelDiff = |S_{MC} - S_{DET}| / |S_{DET}|$.\n6.  Compare the relative difference to the tolerance of $0.01$. The result for the test case is `true` if $RelDiff < 0.01$ and `false` otherwise.\n\nThis procedure is repeated for all specified test cases, and the boolean results are collected.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import integrate\n\ndef solve():\n    \"\"\"\n    Solves the problem of comparing deterministic and Monte Carlo sensitivity\n    calculations for a 1D neutron diffusion problem.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            'D': 0.2, 'Sigma_a': 0.5, 'S0': 1.0,\n            'delta_Sigma_a_func': lambda x: 0.05,\n            'delta_Sigma_a_info': {'type': 'const', 'val': 0.05, 'range': (0.0, 1.0)}\n        },\n        {\n            'D': 0.2, 'Sigma_a': 0.5, 'S0': 1.0,\n            'delta_Sigma_a_func': lambda x: 0.1 if 0.4 <= x <= 0.6 else 0.0,\n            'delta_Sigma_a_info': {'type': 'piecewise', 'val': 0.1, 'range': (0.4, 0.6)}\n        },\n        {\n            'D': 0.3, 'Sigma_a': 0.01, 'S0': 1.0,\n            'delta_Sigma_a_func': lambda x: 0.02,\n            'delta_Sigma_a_info': {'type': 'const', 'val': 0.02, 'range': (0.0, 1.0)}\n        },\n        {\n            'D': 0.05, 'Sigma_a': 2.0, 'S0': 1.0,\n            'delta_Sigma_a_func': lambda x: -0.02,\n            'delta_Sigma_a_info': {'type': 'const', 'val': -0.02, 'range': (0.0, 1.0)}\n        },\n    ]\n\n    N_samples = 500000\n    tolerance = 0.01\n    results = []\n    \n    # Set a seed for reproducibility of Monte Carlo results\n    np.random.seed(0)\n\n    for case in test_cases:\n        D = case['D']\n        Sigma_a = case['Sigma_a']\n        S0 = case['S0']\n        delta_Sigma_a_func = case['delta_Sigma_a_func']\n        delta_Sigma_a_info = case['delta_Sigma_a_info']\n\n        k = np.sqrt(Sigma_a / D)\n        cosh_k_half = np.cosh(k / 2.0)\n\n        # Analytic forward flux phi(x)\n        def phi(x):\n            return (S0 / Sigma_a) * (1.0 - np.cosh(k * (x - 0.5)) / cosh_k_half)\n\n        # Analytic adjoint flux psi_dagger(x)\n        def psi_dagger(x):\n            return 1.0 - np.cosh(k * (x - 0.5)) / cosh_k_half\n\n        # Integrand for sensitivity calculation\n        def integrand(x):\n            return delta_Sigma_a_func(x) * phi(x) * (1.0 - psi_dagger(x))\n\n        # 1. Deterministic sensitivity calculation using numerical integration\n        # The integral is non-zero only where delta_Sigma_a is non-zero.\n        integration_range = delta_Sigma_a_info['range']\n        s_det, _ = integrate.quad(integrand, integration_range[0], integration_range[1])\n\n        # 2. Monte Carlo sensitivity calculation\n        # Generate uniform random samples for x in [0, 1]\n        x_samples = np.random.uniform(0.0, 1.0, N_samples)\n        \n        # Evaluate the integrand at sample points\n        # Use vectorized operations for efficiency\n        delta_vals = np.zeros(N_samples)\n        if delta_Sigma_a_info['type'] == 'const':\n            delta_vals[:] = delta_Sigma_a_info['val']\n        elif delta_Sigma_a_info['type'] == 'piecewise':\n            low, high = delta_Sigma_a_info['range']\n            mask = (x_samples >= low) & (x_samples <= high)\n            delta_vals[mask] = delta_Sigma_a_info['val']\n        \n        integrand_samples = delta_vals * phi(x_samples) * (1.0 - psi_dagger(x_samples))\n\n        # The MC estimate is the mean of the integrand values,\n        # since the integral is over a domain of length 1.\n        s_mc = np.mean(integrand_samples)\n        \n        # 3. Comparison\n        if s_det != 0:\n            relative_difference = np.abs(s_mc - s_det) / np.abs(s_det)\n        else: # Should not happen in these test cases\n            relative_difference = 0.0 if s_mc == 0.0 else float('inf')\n\n        is_within_tolerance = relative_difference < tolerance\n        results.append(str(is_within_tolerance).lower())\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}