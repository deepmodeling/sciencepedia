{
    "hands_on_practices": [
        {
            "introduction": "本节的第一个实践是基础性的。我们将从第一性原理出发，分解如何推导似然比（LR）方法的“分数”（score）。理解这一点是实现任何基于LR的灵敏度分析的关键，因为它揭示了物理参数的微小变化如何在一个单一的蒙特卡罗模拟中转化为一个可测量的量。",
            "id": "4236703",
            "problem": "一个固定源中子输运问题通过模拟蒙特卡罗（MC）方法进行模拟。该几何结构是分区均匀的，其中一个子区域 $D$ 内只有微观吸收截面受到一个小的乘性微扰。具体来说，对于 $0$ 邻域内的 $\\varepsilon$，吸收和散射宏观截面满足 $\\Sigma_a(\\mathbf{r};\\varepsilon) = (1+\\varepsilon)\\,\\Sigma_a^0(\\mathbf{r})$ 和 $\\Sigma_s(\\mathbf{r};\\varepsilon) = \\Sigma_s^0(\\mathbf{r})$，因此 $\\Sigma_t(\\mathbf{r};\\varepsilon) = \\Sigma_s^0(\\mathbf{r}) + (1+\\varepsilon)\\,\\Sigma_a^0(\\mathbf{r})$，其中 $\\Sigma_a^0(\\mathbf{r})>0$ 仅在 $D$ 区域内成立。源概率密度函数（PDF）$q(\\mathbf{r},\\mathbf{\\Omega},E)$ 和所有角/能量散射PDF都与 $\\varepsilon$ 无关，且几何结构不受微扰。响应定义为 $R = h(X)$，其中 $X$ 表示一个完整的模拟径迹（从源到终止），$h$ 是一个不显式依赖于 $\\varepsilon$ 的有界记录泛函（例如，在与 $D$ 不相交的探测器体积内对标量通量的径迹长度估计）。\n\n令 $p_\\varepsilon(X)$ 表示参数为 $\\varepsilon$ 下的模拟径迹PDF，令 $\\mathbb{E}_\\varepsilon[\\cdot]$ 表示关于 $p_\\varepsilon$ 的期望。待求量为 $\\delta R \\equiv \\left.\\dfrac{\\mathrm{d}}{\\mathrm{d}\\varepsilon}\\mathbb{E}_\\varepsilon[R]\\right|_{\\varepsilon=0}$。\n\n似然比（LR）或得分函数恒等式表明，如果 $p_\\varepsilon$ 对 $\\varepsilon$ 可微且 $h(X)$ 可积，则 $\\delta R = \\mathbb{E}_0\\!\\left[R\\,S(X)\\right]$，其中 $S(X) \\equiv \\left.\\dfrac{\\partial}{\\partial \\varepsilon}\\ln p_\\varepsilon(X)\\right|_{\\varepsilon=0}$ 是单径迹得分，可以沿模拟轨迹作为单事件贡献之和进行累积。\n\n在当前设定下，下列哪个（些）选项正确描述了一种可实现的单事件LR累积方法，用于在不运行微扰系统的情况下估计 $\\delta R$？选择所有适用项。\n\nA. 在 $D$ 区域内每个长度为 $\\ell$ 的自由飞行段上，将飞行贡献 $-\\displaystyle\\int_{\\text{segment}}\\dfrac{\\partial \\Sigma_t(\\mathbf{r};\\varepsilon)}{\\partial \\varepsilon}\\Big|_{\\varepsilon=0}\\,\\mathrm{d}s$ 加到累计得分上。在 $D$ 区域内每次反应类型为 $c\\in\\{a,s,f,\\dots\\}$ 的模拟碰撞时，加上碰撞贡献 $\\displaystyle\\left.\\dfrac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_c(\\mathbf{r};\\varepsilon)\\right|_{\\varepsilon=0}-\\left.\\dfrac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t(\\mathbf{r};\\varepsilon)\\right|_{\\varepsilon=0}$。对于 $D$ 区域外的事件或角/能量抽样，不添加任何项，并且仅当源PDF依赖于 $\\varepsilon$ 时，才添加源项 $\\left.\\dfrac{\\partial}{\\partial \\varepsilon}\\ln q\\right|_{\\varepsilon=0}$。从独立同分布的标称径迹 $X_n\\sim p_0$ 构建无偏估计量 $\\widehat{\\delta R}=\\dfrac{1}{N}\\sum_{n=1}^{N} h(X_n)\\,S(X_n)$。\n\nB. 忽略自由飞行贡献，仅在 $D$ 区域内的事件处添加碰撞贡献，即在每次类型为 $c$ 的碰撞时将得分增加 $\\dfrac{\\partial \\Sigma_c(\\mathbf{r};\\varepsilon)}{\\partial \\varepsilon}\\big|_{\\varepsilon=0}$，不进行任何通过 $\\Sigma_t$ 的归一化或减去总截面项。如选项A中那样构建 $\\widehat{\\delta R}$。\n\nC. 在 $D$ 区域内每个自由飞行段上，添加 $-\\displaystyle\\int_{\\text{segment}}\\dfrac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t(\\mathbf{r};\\varepsilon)\\Big|_{\\varepsilon=0}\\,\\mathrm{d}s$，在 $D$ 区域内每次碰撞时，添加 $\\left.\\dfrac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t(\\mathbf{r};\\varepsilon)\\right|_{\\varepsilon=0}$。不需要其他项。如选项A中那样构建 $\\widehat{\\delta R}$。\n\nD. 针对给定的仅吸收截面微扰进行特化，在 $D$ 区域内每个自由飞行段上累积 $-\\displaystyle\\int_{\\text{segment}}\\Sigma_a^0(\\mathbf{r})\\,\\mathrm{d}s$。在 $D$ 区域内发生碰撞时，如果反应是吸收，则添加 $1-\\dfrac{\\Sigma_a^0(\\mathbf{r})}{\\Sigma_t^0(\\mathbf{r})}$；如果是散射，则添加 $-\\dfrac{\\Sigma_a^0(\\mathbf{r})}{\\Sigma_t^0(\\mathbf{r})}$。对于 $D$ 区域外的事件、穿过边界、角/能量抽样或源（因为 $q$ 与 $\\varepsilon$ 无关）不添加任何得分。通过将单径迹得分乘以 $R$ 并在标称径迹上取平均来估计 $\\delta R$。\n\nE. 每次穿过 $D$ 和未受微扰区域之间的边界时，添加一个等于 $\\left(\\Sigma_t^0\\big|_{\\text{inside }D}-\\Sigma_t^0\\big|_{\\text{outside }D}\\right)\\times \\ell_{\\text{prev}}$ 的跳跃项，其中 $\\ell_{\\text{prev}}$ 是紧邻的前一个自由飞行长度，以解释 $\\Sigma_t$ 的不连续性。此外，自由飞行和碰撞贡献是不必要的。如选项A中那样估计 $\\delta R$。\n\n假设采用标准模拟MC抽样：自由飞行遵循指数衰减定律，反应类型按与反应截面成正比的概率选择，径迹在吸收时终止，没有方差缩减偏倚，也没有裂变源耦合（即固定源）。说明所有正确选项。",
            "solution": "我们从第一性原理出发：模拟蒙特卡罗（MC）方法根据输运过程的概率密度函数（PDF）$p_\\varepsilon(X)$ 对中子径迹 $X$ 进行抽样。该PDF由碰撞间的指数衰减、按与宏观反应截面成正比的概率选择反应类型、从给定的角/能量PDF中抽样散射运动学以及源PDF $q$ 所共同导出。响应为 $R=h(X)$，其不显式依赖于 $\\varepsilon$。似然比（LR）恒等式（也称为得分函数恒等式）断言\n$$\n\\delta R \\equiv \\left.\\frac{\\mathrm{d}}{\\mathrm{d}\\varepsilon}\\mathbb{E}_\\varepsilon[R]\\right|_{\\varepsilon=0}\n= \\left.\\frac{\\mathrm{d}}{\\mathrm{d}\\varepsilon}\\int h(X)\\,p_\\varepsilon(X)\\,\\mathrm{d}X\\right|_{\\varepsilon=0}\n= \\int h(X)\\, \\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln p_\\varepsilon(X)\\right|_{\\varepsilon=0} p_0(X)\\,\\mathrm{d}X\n= \\mathbb{E}_0\\!\\left[R\\,S(X)\\right],\n$$\n其中单径迹得分为\n$$\nS(X) \\equiv \\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln p_\\varepsilon(X)\\right|_{\\varepsilon=0}.\n$$\n为了实现 $S(X)$ 的单事件累积，我们将 $\\ln p_\\varepsilon(X)$ 分解为各事件贡献之和。对于一系列在事件之间沿路径 $\\gamma_j$ 的长度为 $\\ell_j$ 的自由飞行段 $j=1,\\dots,J$ 和在位置 $\\mathbf{r}_k$ 的碰撞 $k=1,\\dots,K$，在模拟抽样中我们有\n- 自由飞行的存活因子 $\\exp\\!\\left(-\\int_{\\gamma_j} \\Sigma_t(\\mathbf{r};\\varepsilon)\\,\\mathrm{d}s\\right)$，因此有一个对数项 $-\\int_{\\gamma_j} \\Sigma_t(\\mathbf{r};\\varepsilon)\\,\\mathrm{d}s$，\n- 反应类型选择概率 $\\Sigma_{c_k}(\\mathbf{r}_k;\\varepsilon)/\\Sigma_t(\\mathbf{r}_k;\\varepsilon)$，因此有一个对数项 $\\ln \\Sigma_{c_k}(\\mathbf{r}_k;\\varepsilon) - \\ln \\Sigma_t(\\mathbf{r}_k;\\varepsilon)$，\n- 角分布和能量分布PDF以及源 $q$，根据假设它们不依赖于 $\\varepsilon$。\n\n因此，\n$$\n\\ln p_\\varepsilon(X)\n= \\sum_{j=1}^{J} \\left(-\\int_{\\gamma_j} \\Sigma_t(\\mathbf{r};\\varepsilon)\\,\\mathrm{d}s\\right)\n+ \\sum_{k=1}^{K} \\left(\\ln \\Sigma_{c_k}(\\mathbf{r}_k;\\varepsilon) - \\ln \\Sigma_t(\\mathbf{r}_k;\\varepsilon)\\right)\n+ \\text{与}\\varepsilon\\text{无关的项},\n$$\n从而\n$$\nS(X) = \\sum_{j=1}^{J} \\left(-\\int_{\\gamma_j} \\left.\\frac{\\partial \\Sigma_t(\\mathbf{r};\\varepsilon)}{\\partial \\varepsilon}\\right|_{\\varepsilon=0}\\,\\mathrm{d}s\\right)\n+ \\sum_{k=1}^{K} \\left(\\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_{c_k}(\\mathbf{r}_k;\\varepsilon)\\right|_{\\varepsilon=0}\n- \\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t(\\mathbf{r}_k;\\varepsilon)\\right|_{\\varepsilon=0}\\right).\n$$\n因为只有 $\\Sigma_a$ 受到微扰且仅在 $D$ 区域内，我们在 $D$ 区域内有\n$$\n\\left.\\frac{\\partial \\Sigma_t}{\\partial \\varepsilon}\\right|_{\\varepsilon=0} = \\Sigma_a^0,\\quad\n\\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_a\\right|_{\\varepsilon=0} = 1,\\quad\n\\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_s\\right|_{\\varepsilon=0} = 0,\\quad\n\\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t\\right|_{\\varepsilon=0} = \\frac{\\Sigma_a^0}{\\Sigma_t^0},\n$$\n而在 $D$ 区域外所有这些导数均为 $0$。因此，得分仅在粒子位于 $D$ 区域内时累积：\n- 对于 $D$ 区域内的任何自由飞行段 $\\gamma$，飞行贡献为\n$$\nS_{\\text{flight}}(\\gamma) = -\\int_{\\gamma} \\Sigma_a^0(\\mathbf{r})\\,\\mathrm{d}s.\n$$\n- 对于 $D$ 区域内的一次碰撞：\n  - 如果反应是吸收（$c=a$），碰撞贡献为\n  $$\n  S_{\\text{coll}} = \\left(1\\right) - \\left(\\frac{\\Sigma_a^0}{\\Sigma_t^0}\\right) = 1 - \\frac{\\Sigma_a^0}{\\Sigma_t^0}.\n  $$\n  - 如果反应是散射（$c=s$），碰撞贡献为\n  $$\n  S_{\\text{coll}} = \\left(0\\right) - \\left(\\frac{\\Sigma_a^0}{\\Sigma_t^0}\\right) = - \\frac{\\Sigma_a^0}{\\Sigma_t^0}.\n  $$\n没有源项（因为 $q$ 与 $\\varepsilon$ 无关），没有来自角/能量抽样的项（根据假设），也没有显式的穿过边界的跳跃项，因为 $\\ln p_\\varepsilon$ 是积分和局部反应概率之和；边界只是将路径积分分段。\n\n在确立了这些原则之后，我们评估每个选项：\n\n- 选项 A：这个选项陈述了通用的单事件LR累积方法，它直接由 $\\ln p_\\varepsilon(X)$ 分解为自由飞行和碰撞贡献得出，其中仅当源和其他抽样的PDF依赖于 $\\varepsilon$ 时才包括它们的贡献。它与推导出的形式相匹配：\n$$\nS = \\sum_{\\text{飞行段}} \\left(-\\int \\frac{\\partial \\Sigma_t}{\\partial \\varepsilon}\\,\\mathrm{d}s\\right)\n+ \\sum_{\\text{碰撞}} \\left(\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_c - \\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t\\right),\n$$\n其中贡献仅限于 $D$ 区域内。估计量 $\\widehat{\\delta R} = \\frac{1}{N}\\sum h(X_n) S(X_n)$ 是标准的LR估计量。结论：正确。\n\n- 选项 B：这个选项忽略了自由飞行贡献，并在碰撞时添加了一个未归一化的 $\\frac{\\partial \\Sigma_c}{\\partial \\varepsilon}$。根据推导，碰撞项必须是反应概率对数的导数，即 $\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_c - \\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t$，而自由飞行存活贡献了 $-\\int \\frac{\\partial \\Sigma_t}{\\partial \\varepsilon}\\,\\mathrm{d}s$。省略飞行项并且未能减去 $\\ln \\Sigma_t$ 部分会产生有偏的得分。结论：错误。\n\n- 选项 C：这个选项使用了一个飞行项 $-\\int \\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t\\,\\mathrm{d}s$ 和一个碰撞项 $+\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t$。正确的飞行贡献来自 $-\\int \\Sigma_t\\,\\mathrm{d}s$ 的导数，而不是其对数的导数；因此它应该是 $-\\int \\frac{\\partial \\Sigma_t}{\\partial \\varepsilon}\\,\\mathrm{d}s$。碰撞项应该是反应截面和总截面对数导数之差，而不是一个光秃秃的 $\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t$。这重复计算了总截面并错误地指定了飞行贡献。结论：错误。\n\n- 选项 D：这是选项A在给定微扰下的特化形式。它使用\n$$\nS_{\\text{flight}} = -\\int \\Sigma_a^0\\,\\mathrm{d}s,\\quad\nS_{\\text{coll}} = \\begin{cases}\n1 - \\Sigma_a^0/\\Sigma_t^0,  & c=a,\\\\\n-\\Sigma_a^0/\\Sigma_t^0,  & c=s,\n\\end{cases}\n$$\n仅应用于 $D$ 内部，没有源项或穿过边界的项。这与推导出的表达式完全匹配。结论：正确。\n\n- 选项 E：这个选项假设存在一个与 $\\Sigma_t^0$ 的差值乘以先前飞行长度成正比的穿过边界的跳跃项，并摒弃了基于原理的自由飞行和碰撞贡献。当几何结构固定时，在 $\\ln p_\\varepsilon$ 的导数中没有这样的边界跳跃项；贡献来自于沿路径的 $\\frac{\\partial \\Sigma_t}{\\partial \\varepsilon}$ 的积分以及局部的反应对数概率。结论：错误。\n\n因此，正确选项是 A 和 D。",
            "answer": "$$\\boxed{AD}$$"
        },
        {
            "introduction": "虽然似然比方法功能强大，但它并非唯一的工具。本实践将探讨LR估计量与路径导数（Pathwise或IPA）估计量之间的一个关键比较，尤其是在具有挑战性的深穿透问题中。通过分析它们的方差，您将学会批判性地评估哪种方法更适合特定问题，这是计算科学家的一项关键技能。",
            "id": "4236709",
            "problem": "考虑一个单能、各向同性散射的平板，其厚度为 $L$，具有均匀的总宏观截面 $\\Sigma_t$ 和吸收宏观截面 $\\Sigma_a$。光学厚度为 $\\tau = \\Sigma_t L$，散射比为 $c = \\Sigma_s / \\Sigma_t$，其中 $0  c  1$ 且 $\\Sigma_s = \\Sigma_t - \\Sigma_a$。一个单位强度的单能中子源垂直入射到平板的左边界。放置在右边界的探测器记录出射的流响应 $R(\\theta)$，其中参数 $\\theta$ 通过 $\\Sigma_a \\mapsto \\Sigma_a + \\theta \\,\\delta \\Sigma_a$ 扰动了平板内宽度为 $\\Delta L$ 的子区域中的吸收截面，其中 $\\delta \\Sigma_a > 0$ 是固定的且 $|\\theta| \\ll 1$。假设在未扰动物理（$\\theta = 0$）下进行粒子输运的模拟蒙特卡罗（MC）模拟。\n\n设 $X$ 表示未扰动物理下的随机路径，其在扰动物理下的路径密度为 $f_\\theta(X)$。探测器响应可以写为 $R(\\theta) = \\mathbb{E}_\\theta[G(X)]$，其中 $G(X)$ 是给定路径 $X$ 的探测器记录泛函。考虑了两种用于 $\\partial_\\theta R(\\theta)\\big|_{\\theta = 0}$ 的无偏 MC 灵敏度估计量：\n\n- 似然比（LR）或得分函数估计量：$Z_{\\mathrm{LR}}(X) = G(X)\\,\\partial_\\theta \\log f_\\theta(X)\\big|_{\\theta = 0}$。\n- 路径导数或无穷小扰动分析（IPA）估计量：$Z_{\\mathrm{PW}}(X) = \\partial_\\theta G(X)\\big|_{\\theta = 0}$，在允许导数与期望互换的条件下。\n\n假设为深穿透问题，即 $\\tau \\gg 1$，并进一步假设记录 $G(X)$ 是路径权重的平滑泛函，从而使得 IPA 估计量对于吸收扰动是有效的。从粒子输运中 MC 估计量和路径概率的基本定义出发，推断当 $\\tau \\to \\infty$ 且 $\\Delta L$ 固定时，方差 $\\mathrm{Var}[Z_{\\mathrm{LR}}]$ 和 $\\mathrm{Var}[Z_{\\mathrm{PW}}]$ 的主阶标度关系，并比较它们的渐近效率。在深穿透吸收扰动问题中，哪个陈述最能预测哪种方法的方差更低？\n\nA. 似然比估计量的渐近方差比路径导数估计量低，因为它使用了整个路径似然的得分，这能更有效地集中稀有事件信息。\n\nB. 路径导数估计量的渐近方差比似然比估计量低，因为 LR 得分包含了额外的零均值分支贡献，这些贡献随碰撞累积，并在光学厚度增加时导致方差膨胀。\n\nC. 两种估计量具有相同的渐近方差，因为吸收扰动仅通过路径长度衰减进入，使得这两种估计量等效。\n\nD. 似然比估计量保持有限方差，而路径导数估计量的方差随光学厚度发散，因为记录的导数放大了稀有事件。\n\n基于路径似然分解为自由飞行衰减和碰撞类型分支，以及碰撞次数随光学厚度的标度关系，提供一个基于原理的推导。仔细论证方差项的渐近标度关系，并得出哪个选项是正确的结论。",
            "solution": "用户需要对一个比较蒙特卡罗灵敏度计算中似然比（LR）和路径导数（PW）/无穷小扰动分析（IPA）估计量方差的问题进行详细验证和求解，该问题背景为深穿透粒子输运问题。\n\n### 问题验证\n\n**第一步：提取已知条件**\n- **系统：** 一个单能、各向同性散射的平板，厚度为 $L$。\n- **截面：** 均匀的总宏观截面 $\\Sigma_t$，吸收宏观截面 $\\Sigma_a$。\n- **导出参数：** 光学厚度 $\\tau = \\Sigma_t L$，散射比 $c = \\Sigma_s / \\Sigma_t$，其中 $0  c  1$ 且 $\\Sigma_s = \\Sigma_t - \\Sigma_a$。\n- **源：** 单位强度的单能中子源，垂直入射到左边界。\n- **探测器：** 位于右边界，记录出射的流响应 $R(\\theta)$。\n- **扰动：** 宽度为 $\\Delta L$ 的子区域内的吸收截面被扰动：$\\Sigma_a \\mapsto \\Sigma_a + \\theta \\,\\delta \\Sigma_a$，其中 $\\delta \\Sigma_a > 0$ 是固定的且 $|\\theta| \\ll 1$。\n- **模拟：** 在未扰动物理（$\\theta = 0$）下进行模拟蒙特卡罗（MC）模拟。\n- **路径和响应定义：** $X$ 是一个随机路径，$f_\\theta(X)$ 是扰动物理下的路径密度，响应为 $R(\\theta) = \\mathbb{E}_\\theta[G(X)]$，其中 $G(X)$ 是探测器记录泛函。\n- **估计量定义：**\n    - 似然比（LR）：$Z_{\\mathrm{LR}}(X) = G(X)\\,\\partial_\\theta \\log f_\\theta(X)\\big|_{\\theta = 0}$。\n    - 路径导数（PW/IPA）：$Z_{\\mathrm{PW}}(X) = \\partial_\\theta G(X)\\big|_{\\theta = 0}$。\n- **假设：**\n    1. 深穿透区域：$\\tau \\gg 1$。\n    2. 扰动宽度 $\\Delta L$ 是固定的。\n    3. IPA 估计量对吸收扰动有效，意味着记录泛函 $G(X)$ 足够平滑。\n- **问题：** 确定当 $\\tau \\to \\infty$ 时，方差 $\\mathrm{Var}[Z_{\\mathrm{LR}}]$ 和 $\\mathrm{Var}[Z_{\\mathrm{PW}}]$ 的主阶标度关系，并比较它们的渐近效率，以确定哪种方法的方差更低。\n\n**第二步：使用提取的已知条件进行验证**\n- **科学上合理：** 该问题是在核反应堆物理学，特别是蒙特卡罗粒子输运和微扰理论的标准数学和物理框架内提出的。截面、路径密度、LR和IPA估计量等概念都是公认的。这是该领域的经典问题。\n- **问题适定：** 该问题提供了足够的信息来推导出关于两种估计量相对性能的概念性结论。假设条件，特别是IPA估计量的有效性，被明确陈述以构建一个可处理的问题。问题清晰，并指向一个唯一的物理和数学结论。\n- **客观性：** 语言正式、精确，没有任何主观或模棱两可的术语。所有术语在相关科学文献中都是标准术语。\n\n**缺陷检查清单：**\n1.  **科学或事实不准确：** 无。物理和数学定义是正确的。\n2.  **非形式化或不相关：** 无。该问题是蒙特卡罗方法领域的核心问题。\n3.  **不完整或矛盾的设置：** 这个问题在指定“模拟MC”和假设“IPA估计量对吸收扰动有效”之间存在轻微的内部矛盾。在严格的模拟仿真中，记录 $G(X)$ 通常是二值的（1或0），不可微。然而，IPA有效性的假设表明我们应该继续考虑一种非模拟的基于权重的记录，这是IPA被明确定义的一种标准方法。这是理论问题中常见的简化，并不会使核心问题无效。\n4.  **不切实际或不可行：** 无。深穿透是仿真中一个物理上相关且具有挑战性的领域。\n5.  **不适定或结构不良：** 无。\n6.  **伪深刻、琐碎或同义反复：** 无。这些估计量的比较是一个非平凡的课题。\n7.  **超出科学可验证性：** 无。结果可以通过数学推导得出。\n\n**第三步：结论和行动**\n该问题是**有效的**。关于模拟类型的轻微模糊性通过对IPA有效性的明确假设得到了解决，这为解释指明了方向。我们开始求解。\n\n### 推导与求解\n\n该问题要求比较两种估计量对灵敏度 $\\partial_\\theta R(\\theta)|_{\\theta=0}$ 的方差。关键在于根据粒子输运的物理原理推导出估计量的显式形式。\n\n**1. 路径表示与记录泛函**\n粒子路径 $X$ 是一系列自由飞行和碰撞。在带有存活偏倚（隐式俘获）的非模拟仿真中，粒子的权重在每次碰撞时都会被修改。这个框架对于吸收扰动下IPA估计量的良定义是必要的。对于一个经过 $N$ 次碰撞并成功穿出平板的路径，其记录泛函 $G(X)$ 是最终的粒子权重：\n$$ G(X) = \\left( \\frac{\\Sigma_s}{\\Sigma_t} \\right)^N = c^N $$\n对于未穿出的路径，$G(X) = 0$。\n\n**2. 路径导数（PW/IPA）估计量**\nPW估计量是记录泛函相对于扰动参数 $\\theta$ 的导数，并在 $\\theta=0$ 处取值。扰动为 $\\Sigma_a \\mapsto \\Sigma_{a,\\theta} = \\Sigma_a + \\theta\\delta\\Sigma_a$，这使得总截面在扰动区域内变为 $\\Sigma_t \\mapsto \\Sigma_{t,\\theta} = \\Sigma_t + \\theta\\delta\\Sigma_a$。散射截面 $\\Sigma_s$ 未受扰动。\n\n在扰动区域内一次碰撞的扰动后存活概率是 $c_\\theta = \\Sigma_s / \\Sigma_{t,\\theta}$。设 $N$ 是路径 $X$ 的总碰撞次数，$N_p$ 是在扰动子区域内发生的碰撞次数。扰动后的记录泛函为：\n$$ G_\\theta(X) = \\left(\\frac{\\Sigma_s}{\\Sigma_t}\\right)^{N-N_p} \\left(\\frac{\\Sigma_s}{\\Sigma_{t,\\theta}}\\right)^{N_p} = c^{N-N_p} \\left(\\frac{\\Sigma_s}{\\Sigma_t + \\theta\\delta\\Sigma_a}\\right)^{N_p} $$\n对 $\\theta$ 求导：\n$$ \\frac{\\partial G_\\theta(X)}{\\partial \\theta} = c^{N-N_p} N_p \\left(\\frac{\\Sigma_s}{\\Sigma_t + \\theta\\delta\\Sigma_a}\\right)^{N_p-1} \\left( \\frac{-\\Sigma_s \\delta\\Sigma_a}{(\\Sigma_t + \\theta\\delta\\Sigma_a)^2} \\right) $$\n在 $\\theta=0$ 处求值：\n$$ Z_{\\mathrm{PW}}(X) = \\frac{\\partial G_\\theta(X)}{\\partial \\theta}\\bigg|_{\\theta=0} = c^{N-N_p} N_p (c^{N_p-1}) \\left( \\frac{-c \\Sigma_t \\delta\\Sigma_a}{\\Sigma_t^2} \\right) = c^N N_p \\left(-\\frac{\\delta\\Sigma_a}{\\Sigma_t}\\right) $$\n认识到 $G(X)=c^N$，PW估计量为：\n$$ Z_{\\mathrm{PW}}(X) = -G(X) \\frac{\\delta\\Sigma_a}{\\Sigma_t} N_p $$\n\n**3. 似然比（LR）估计量**\nLR估计量需要“得分”，即路径概率密度函数（PDF）对数 $\\log f_\\theta(X)$ 的导数。扰动与未扰动PDF之比 $f_\\theta(X)/f_0(X)$ 是Radon-Nikodym导数。对于一条路径 $X$，它解释了输运核（衰减）和碰撞核（存活概率）的变化。\n$$ \\frac{f_\\theta(X)}{f_0(X)} = \\exp\\left(-\\int_{\\text{path}} (\\Sigma_{t,\\theta} - \\Sigma_t) dl \\right) \\prod_{j \\in \\text{coll}} \\frac{c_\\theta(x_j)}{c_0(x_j)} \\frac{\\Sigma_{t,\\theta}(x_j)}{\\Sigma_{t,0}(x_j)} $$\n似然变化的一个更直接的形式是：\n$$ \\frac{f_\\theta(X)}{f_0(X)} = \\exp(-\\theta \\delta\\Sigma_a S_p) \\left( \\frac{\\Sigma_t}{\\Sigma_t + \\theta\\delta\\Sigma_a} \\right)^{N_p} $$\n其中 $S_p$ 是在扰动区域内走过的总路径长度。\n得分是对数似然的导数：\n$$ \\partial_\\theta \\log \\left( \\frac{f_\\theta(X)}{f_0(X)} \\right) \\bigg|_{\\theta=0} = \\partial_\\theta \\left( -\\theta\\delta\\Sigma_a S_p - N_p \\log(\\Sigma_t + \\theta\\delta\\Sigma_a) + N_p \\log\\Sigma_t \\right) \\bigg|_{\\theta=0} $$\n$$ = -\\delta\\Sigma_a S_p - N_p \\frac{\\delta\\Sigma_a}{\\Sigma_t} $$\nLR估计量是 $Z_{\\mathrm{LR}}(X) = G(X) \\times (\\text{得分})$：\n$$ Z_{\\mathrm{LR}}(X) = -G(X) \\left( \\delta\\Sigma_a S_p + \\frac{\\delta\\Sigma_a}{\\Sigma_t} N_p \\right) $$\n\n**4. 估计量与方差的比较**\n比较这两个表达式：\n$$ Z_{\\mathrm{LR}}(X) = Z_{\\mathrm{PW}}(X) - G(X)\\delta\\Sigma_a S_p $$\n令 $Z_{\\mathrm{branch}}(X) = -G(X)\\delta\\Sigma_a S_p$。该项源于对输运核（路径似然的衰减部分）求导。微扰理论中的一个已知结果是该项的均值为零：$\\mathbb{E}[Z_{\\mathrm{branch}}] = 0$。这可以被解释为在粒子轨迹上位于扰动区域内的每一点，都有一个零均值的“分支”博弈被加到得分上。\n因此，$Z_{\\mathrm{LR}}(X) = Z_{\\mathrm{PW}}(X) + Z_{\\mathrm{branch}}(X)$。由于两种估计量对于同一量都是无偏的，即 $\\mathbb{E}[Z_{\\mathrm{LR}}] = \\mathbb{E}[Z_{\\mathrm{PW}}]$，那么必定有 $\\mathbb{E}[Z_{\\mathrm{branch}}] = 0$。\n\n现在，我们来比较方差。\n$$ \\mathrm{Var}[Z_{\\mathrm{LR}}] = \\mathrm{Var}[Z_{\\mathrm{PW}} + Z_{\\mathrm{branch}}] = \\mathrm{Var}[Z_{\\mathrm{PW}}] + \\mathrm{Var}[Z_{\\mathrm{branch}}] + 2\\mathrm{Cov}[Z_{\\mathrm{PW}}, Z_{\\mathrm{branch}}] $$\n由于 $\\mathbb{E}[Z_{\\mathrm{branch}}]=0$，其方差为 $\\mathrm{Var}[Z_{\\mathrm{branch}}] = \\mathbb{E}[Z_{\\mathrm{branch}}^2] = (\\delta\\Sigma_a)^2 \\mathbb{E}[(G(X)S_p)^2]$。这一定是正数。\n协方差项为 $\\mathrm{Cov}[Z_{\\mathrm{PW}}, Z_{\\mathrm{branch}}] = \\mathbb{E}[Z_{\\mathrm{PW}} Z_{\\mathrm{branch}}]$。\n$$ \\mathbb{E}[Z_{\\mathrm{PW}} Z_{\\mathrm{branch}}] = \\mathbb{E}\\left[ \\left(-G(X)\\frac{\\delta\\Sigma_a}{\\Sigma_t}N_p\\right) \\left(-G(X)\\delta\\Sigma_a S_p\\right) \\right] = \\frac{(\\delta\\Sigma_a)^2}{\\Sigma_t} \\mathbb{E}[G(X)^2 N_p S_p] $$\n因为对于任何路径，$G(X)$、$N_p$ 和 $S_p$ 都是非负的，所以这个协方差项也是正的。\n因此，$\\mathrm{Var}[Z_{\\mathrm{LR}}]$ 比 $\\mathrm{Var}[Z_{\\mathrm{PW}}]$ 大一个正量：\n$$ \\mathrm{Var}[Z_{\\mathrm{LR}}] = \\mathrm{Var}[Z_{\\mathrm{PW}}] + (\\text{一个正量}) $$\n\n**5. 渐近行为（深穿透, $\\tau \\to \\infty$）**\n在深穿透问题中，成功到达探测器的粒子是稀有的，并且通常经历了大量的碰撞。对于一个随机行走过程，行进距离 $L$ 所需的碰撞次数 $N$ 大致按 $N \\propto (\\Sigma_t L)^2 = \\tau^2$ 的标度关系变化。\n这样一条粒子的路径很长。这意味着 $N$（以及 $N_p$）和路径长度 $S$（以及 $S_p$）都变得很大。\nLR估计量中的额外方差来自 $Z_{\\mathrm{branch}}$ 项。该项可以看作是沿着粒子路径累积的零均值随机得分。随着路径变长（即 $\\tau$ 增加），这种噪声有更多机会累积，从而使方差膨胀。而只依赖于碰撞事件的PW估计量不包含这种噪声源。因此，随着光学厚度的增加，LR估计量的方差相对于PW估计量会变得越来越差。\n\n### 逐项分析\n\n**A. 似然比估计量的渐近方差比路径导数估计量低，因为它使用了整个路径似然的得分，这能更有效地集中稀有事件信息。**\n**不正确。** 虽然LR使用了完整的路径似然，但对于吸收类型的扰动，这会引入一个与输运核相关的额外的、有害的方差源。此陈述错误地评估了其效果。LR方法对于源或抽样分布的扰动更有效，而不是截面。\n\n**B. 路径导数估计量的渐近方差比似然比估计量低，因为 LR 得分包含了额外的零均值分支贡献，这些贡献随碰撞累积，并在光学厚度增加时导致方差膨胀。**\n**正确。** 这个陈述准确地反映了推导出的关系 $Z_{\\mathrm{LR}} = Z_{\\mathrm{PW}} + Z_{\\mathrm{branch}}$。$Z_{\\mathrm{branch}}$ 项代表了额外的零均值贡献（“分支”贡献），其方差加到了LR估计量的总方差上。在深穿透问题中，路径很长，导致这种噪声的累积，从而产生更高的方差，这种效应被加剧了。\n\n**C. 两种估计量具有相同的渐近方差，因为吸收扰动仅通过路径长度衰减进入，使得这两种估计量等效。**\n**不正确。** 如推导所示，这两种估计量不等效。扰动既影响碰撞存活概率（由PW处理），也影响输运核/路径衰减（LR中的额外项）。\n\n**D. 似然比估计量保持有限方差，而路径导数估计量的方差随光学厚度发散，因为记录的导数放大了稀有事件。**\n**不正确。** 这个陈述颠倒了实际行为。众所周知，对于此类问题，LR估计量的方差性质较差，有时甚至方差为无穷大。PW估计量通常更稳定。当 $\\tau \\to \\infty$ 时，任何成功路径的记录都变得极小且稀有，导致*任何*无偏估计量的方差都会增长，但LR方差的增长速度比PW方差更快。",
            "answer": "$$\\boxed{B}$$"
        },
        {
            "introduction": "理解的最终考验是实现。本实践将指导您完成一个验证过程，将蒙特卡罗灵敏度计算结果与一个简单扩散问题的确定论解进行对比。这个练习弥合了抽象微扰理论与具体、可信的代码之间的鸿沟，并强调了验证与确认在计算建模中的关键作用。",
            "id": "4236743",
            "problem": "考虑一个适用于核反应堆模拟的一维板模型。设空间变量为无量纲，并限制在区间 $x \\in [0,1]$ 内。正向中子扩散问题由方程 $-D \\frac{d^2 \\phi}{dx^2} + \\Sigma_a \\phi = S(x)$ 定义，边界条件为 $\\phi(0) = 0$ 和 $\\phi(1) = 0$，其中 $D > 0$ 是扩散系数，$\\Sigma_a > 0$ 是吸收系数，$S(x)$ 是给定的源项，$\\phi(x)$ 是标量通量。定义响应泛函 $R[\\phi] = \\int_0^1 \\Sigma_a \\phi(x) \\, dx$（无量纲单位）。\n\n您的任务是利用蒙特卡洛微扰理论的第一性原理，推导并实现一个伴随加权的灵敏度估计器，用于计算吸收系数的微小扰动 $\\delta \\Sigma_a(x)$。该估计器必须与同一模型的确定性伴随计算结果进行比较。从以下基本原理出发：\n\n- 标量通量的正向扩散算子 $A[\\phi] = -D \\frac{d^2 \\phi}{dx^2} + \\Sigma_a \\phi$，在 $[0,1]$ 上具有齐次狄利克雷边界条件。\n- 伴随问题由伴随算子 $A^\\dagger$ 定义，该算子作用于与响应泛函 $R[\\phi]$ 对应的伴随通量 $\\psi^\\dagger(x)$，且具有相同类型的边界条件。\n- 响应变化与算子变化的伴随加权相互作用之间的一阶微扰理论关系，以 $[0,1]$ 上的内积形式表示。\n\n构建一个程序，该程序：\n1. 求解正向问题以获得 $\\phi(x)$，其中 $S(x) = S_0$ 为常数，系数 $D$ 和 $\\Sigma_a$ 也为常数。\n2. 求解伴随问题以获得 $\\psi^\\dagger(x)$，其定义域和边界条件与正向问题相同。\n3. 使用基于伴随的微扰框架，计算对 $\\delta \\Sigma_a(x)$ 的确定性一阶灵敏度。\n4. 通过在 $[0,1]$ 上采样 $x$ 并应用从第一性原理推导出的伴随加权估计器，计算相同灵敏度的蒙特卡洛估计值。在 $[0,1]$ 上使用均匀采样，并以无量纲单位表示所有量。\n5. 使用相对差异 $|S_{\\text{MC}} - S_{\\text{DET}}| / |S_{\\text{DET}}|$ 比较蒙特卡洛估计值和确定性伴随计算结果，并为每个测试用例返回一个布尔值，指示相对差异是否小于指定的容差。\n\n使用以下测试套件，所有参数均以无量纲单位表示：\n- 测试用例 1：$D = 0.2$，$\\Sigma_a = 0.5$， $S_0 = 1.0$，对于所有 $x \\in [0,1]$，$\\delta \\Sigma_a(x) = 0.05$。\n- 测试用例 2：$D = 0.2$，$\\Sigma_a = 0.5$， $S_0 = 1.0$，对于 $x \\in [0.4,0.6]$，$\\delta \\Sigma_a(x) = 0.1$，其他情况 $\\delta \\Sigma_a(x) = 0$。\n- 测试用例 3：$D = 0.3$，$\\Sigma_a = 0.01$， $S_0 = 1.0$，对于所有 $x \\in [0,1]$，$\\delta \\Sigma_a(x) = 0.02$。\n- 测试用例 4：$D = 0.05$，$\\Sigma_a = 2.0$， $S_0 = 1.0$，对于所有 $x \\in [0,1]$，$\\delta \\Sigma_a(x) = -0.02$。\n\n蒙特卡洛采样细节：\n- 对于每个测试用例，在 $[0,1]$ 上使用 $N = 500000$ 个独立的均匀样本 $x$。\n- 使用在精细空间网格上的确定性数值积分来计算基于伴随的灵敏度以进行比较。\n\n验收标准：\n- 对于每个测试用例，如果相对差异小于 $0.01$，则生成布尔值 $true$，否则生成 $false$。\n\n最终输出格式：\n- 您的程序应生成一行输出，其中包含用方括号括起来的逗号分隔列表形式的结果（例如，“[true,false,true,false]”），每个条目按上面列出的顺序对应于测试用例。所有值都应为指定的无量纲浮点数或布尔值；输出中不使用任何物理单位。",
            "solution": "该问题已经过验证并确认为有效。它在科学上基于核反应堆物理的既定原理，具体来说是一维中子扩散理论和一阶微扰理论。该问题是适定的，具有足够的信息和一致的条件来推导出唯一且有意义的解。\n\n任务是推导并实现一个伴随加权的蒙特卡洛估计器，用于计算响应泛函对吸收截面扰动的灵敏度，并将其与确定性计算进行比较。该过程涉及多个步骤，基于微分方程和微扰理论的原理。\n\n### 1. 正向问题及其解\n\n该物理系统由一维单群中子扩散方程描述，用于计算无量纲宽度为 1 的板中的标量通量 $\\phi(x)$：\n$$ -D \\frac{d^2 \\phi}{dx^2} + \\Sigma_a \\phi = S_0, \\quad x \\in (0, 1) $$\n具有齐次狄利克雷边界条件 $\\phi(0) = 0$ 和 $\\phi(1) = 0$。参数 $D$、$\\Sigma_a$ 和 $S_0$ 是正常数。\n\n这是一个二阶常系数线性常微分方程。其解可以通过组合一个特解和齐次方程的通解来找到。\n令 $k^2 = \\Sigma_a / D$。该方程可以写成 $\\phi''(x) - k^2 \\phi(x) = -S_0/D$。\n一个特解是 $\\phi_p(x) = S_0 / \\Sigma_a$。\n齐次解是 $\\phi_h(x) = C_1 \\cosh(kx) + C_2 \\sinh(kx)$。\n通解是 $\\phi(x) = C_1 \\cosh(kx) + C_2 \\sinh(kx) + S_0 / \\Sigma_a$。\n\n应用边界条件求出常数 $C_1$ 和 $C_2$，得到一个可以表示为对称形式的解：\n$$ \\phi(x) = \\frac{S_0}{\\Sigma_a} \\left( 1 - \\frac{\\cosh(k(x - 1/2))}{\\cosh(k/2)} \\right) $$\n其中 $k = \\sqrt{\\Sigma_a / D}$。这个正向通量的解析表达式将用于后续计算。\n\n### 2. 伴随问题及其解\n\n伴随问题对于高效计算响应泛函的灵敏度是必需的。响应泛函由下式给出：\n$$ R[\\phi] = \\int_0^1 \\Sigma_a \\phi(x) \\, dx $$\n这是通量 $\\phi$ 的一个线性泛函。在内积表示法中，$\\langle f, g \\rangle = \\int_0^1 f(x)g(x)dx$，响应为 $R[\\phi] = \\langle \\Sigma_a, \\phi \\rangle$。\n\n伴随方程由 $A^\\dagger \\psi^\\dagger = S^\\dagger$ 定义，其中 $A^\\dagger$ 是正向算子 $A[\\phi] = -D \\frac{d^2 \\phi}{dx^2} + \\Sigma_a \\phi$ 的伴随算子，而 $S^\\dagger$ 是伴随源。伴随算子 $A^\\dagger$ 通过关系式 $\\langle \\psi^\\dagger, A\\phi \\rangle = \\langle A^\\dagger\\psi^\\dagger, \\phi \\rangle$ 求得。对于给定的算子以及在 $\\phi$ 和 $\\psi^\\dagger$ 上的齐次狄利克雷边界条件，该算子是自伴的，即 $A^\\dagger = A$。\n\n伴随源 $S^\\dagger$ 是响应泛函的核。对于 $R[\\phi] = \\langle \\Sigma_a, \\phi \\rangle$，伴随源为 $S^\\dagger(x) = \\Sigma_a$。\n\n因此，伴随通量 $\\psi^\\dagger(x)$ 的伴随问题是：\n$$ -D \\frac{d^2 \\psi^\\dagger}{dx^2} + \\Sigma_a \\psi^\\dagger = \\Sigma_a, \\quad x \\in (0, 1) $$\n边界条件为 $\\psi^\\dagger(0) = 0$ 和 $\\psi^\\dagger(1) = 0$。\n\n此方程在结构上与正向问题相同，只是源项 $S_0$ 被替换为 $\\Sigma_a$。通过观察，一个特解是 $\\psi^\\dagger_p(x)=1$。遵循与求解正向通量相同的解题步骤，我们得到伴随通量的解析解：\n$$ \\psi^\\dagger(x) = 1 - \\frac{\\cosh(k(x - 1/2))}{\\cosh(k/2)} $$\n其中 $k$ 与正向问题中的相同。\n\n### 3. 一阶微扰理论与确定性灵敏度\n\n我们关心的是由吸收截面的微小扰动 $\\Sigma_a \\rightarrow \\Sigma_a + \\delta\\Sigma_a(x)$ 引起的响应的一阶变化 $\\delta R$。这种扰动同时影响算子 $A$ 和响应泛函 $R$。\n扰动后的算子是 $A' = A + \\delta A$，其中 $\\delta A[\\phi] = \\delta\\Sigma_a(x)\\phi(x)$。\n扰动后的响应泛函是 $R'[\\phi'] = \\int_0^1 (\\Sigma_a + \\delta\\Sigma_a)\\phi' dx$，其中 $\\phi'$ 是扰动后的通量。\n\n一阶变化 $\\delta R$ 由下式给出：\n$$ \\delta R = R'[\\phi'] - R[\\phi] \\approx \\underbrace{\\int_0^1 \\delta\\Sigma_a(x) \\phi(x) \\, dx}_{\\text{直接效应}} + \\underbrace{\\int_0^1 \\Sigma_a \\delta\\phi(x) \\, dx}_{\\text{间接效应}} $$\n其中 $\\delta\\phi = \\phi' - \\phi$。\n间接效应可以使用伴随通量来评估。根据一阶微扰理论，$A\\delta\\phi \\approx -\\delta A \\phi$。\n$$ \\text{间接效应} = \\langle \\Sigma_a, \\delta\\phi \\rangle = \\langle S^\\dagger, \\delta\\phi \\rangle = \\langle A^\\dagger \\psi^\\dagger, \\delta\\phi \\rangle = \\langle \\psi^\\dagger, A \\delta\\phi \\rangle \\approx \\langle \\psi^\\dagger, -\\delta A \\phi \\rangle $$\n代入 $\\delta A[\\phi] = \\delta\\Sigma_a(x)\\phi(x)$，间接效应变为 $-\\int_0^1 \\psi^\\dagger(x) \\delta\\Sigma_a(x) \\phi(x) \\, dx$。\n\n结合直接和间接效应，我们记为 $S_{DET}$ 的总灵敏度为：\n$$ S_{DET} = \\delta R \\approx \\int_0^1 \\delta\\Sigma_a(x) \\phi(x) \\, dx - \\int_0^1 \\psi^\\dagger(x) \\delta\\Sigma_a(x) \\phi(x) \\, dx $$\n$$ S_{DET} = \\int_0^1 \\delta\\Sigma_a(x) \\phi(x) (1 - \\psi^\\dagger(x)) \\, dx $$\n此积分将使用推导出的 $\\phi(x)$ 和 $\\psi^\\dagger(x)$ 的解析表达式进行高精度数值计算，以作为确定性参考值。\n\n### 4. 蒙特卡洛灵敏度估计器\n\n$S_{DET}$ 的积分可以使用蒙特卡洛方法进行估计。问题指定从区间 $[0, 1]$ 中均匀采样空间变量 $x$。设被积函数为 $I(x) = \\delta\\Sigma_a(x) \\phi(x) (1 - \\psi^\\dagger(x))$。\n积分为 $S_{DET} = \\int_0^1 I(x) \\, dx$。\n\n对于从均匀分布 $U(0, 1)$（其概率密度函数在 $[0, 1]$ 上为 $p(x) = 1$）中抽取的 $N$ 个独立样本 $\\{x_i\\}_{i=1}^N$，该积分的蒙特卡洛估计器是该被积函数的样本均值：\n$$ S_{MC} = \\frac{1}{N} \\sum_{i=1}^{N} I(x_i) = \\frac{1}{N} \\sum_{i=1}^{N} \\delta\\Sigma_a(x_i) \\phi(x_i) (1 - \\psi^\\dagger(x_i)) $$\n这就是问题所要求的“伴随加权灵敏度估计器”。项 $\\phi(x_i) (1 - \\psi^\\dagger(x_i))$ 表示在位置 $x_i$ 处的扰动对灵敏度的贡献，该贡献由该点的正向和伴随通量加权。\n\n### 5. 计算流程\n\n对于每个测试用例，执行以下流程：\n1.  定义物理参数 $D$、$\\Sigma_a$、$S_0$ 和扰动函数 $\\delta\\Sigma_a(x)$。\n2.  基于这些参数定义正向通量 $\\phi(x)$ 和伴随通量 $\\psi^\\dagger(x)$ 的解析函数。\n3.  通过在定义域 $[0, 1]$（或 $\\delta\\Sigma_a(x) \\neq 0$ 的相关子域）上对被积函数 $I(x) = \\delta\\Sigma_a(x) \\phi(x) (1 - \\psi^\\dagger(x))$ 进行数值积分来计算确定性灵敏度 $S_{DET}$。\n4.  通过在 $[0, 1]$ 中生成 $N = 500000$ 个均匀随机样本 $x$，对每个样本评估 $I(x)$ 并计算平均值，来计算蒙特卡洛估计值 $S_{MC}$。\n5.  计算相对差异，$RelDiff = |S_{MC} - S_{DET}| / |S_{DET}|$。\n6.  将相对差异与 $0.01$ 的容差进行比较。如果 $RelDiff  0.01$，则该测试用例的结果为 `true`，否则为 `false`。\n\n对所有指定的测试用例重复此流程，并收集布尔结果。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import integrate\n\ndef solve():\n    \"\"\"\n    Solves the problem of comparing deterministic and Monte Carlo sensitivity\n    calculations for a 1D neutron diffusion problem.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            'D': 0.2, 'Sigma_a': 0.5, 'S0': 1.0,\n            'delta_Sigma_a_func': lambda x: 0.05,\n            'delta_Sigma_a_info': {'type': 'const', 'val': 0.05, 'range': (0.0, 1.0)}\n        },\n        {\n            'D': 0.2, 'Sigma_a': 0.5, 'S0': 1.0,\n            'delta_Sigma_a_func': lambda x: 0.1 if 0.4 = x = 0.6 else 0.0,\n            'delta_Sigma_a_info': {'type': 'piecewise', 'val': 0.1, 'range': (0.4, 0.6)}\n        },\n        {\n            'D': 0.3, 'Sigma_a': 0.01, 'S0': 1.0,\n            'delta_Sigma_a_func': lambda x: 0.02,\n            'delta_Sigma_a_info': {'type': 'const', 'val': 0.02, 'range': (0.0, 1.0)}\n        },\n        {\n            'D': 0.05, 'Sigma_a': 2.0, 'S0': 1.0,\n            'delta_Sigma_a_func': lambda x: -0.02,\n            'delta_Sigma_a_info': {'type': 'const', 'val': -0.02, 'range': (0.0, 1.0)}\n        },\n    ]\n\n    N_samples = 500000\n    tolerance = 0.01\n    results = []\n    \n    # Set a seed for reproducibility of Monte Carlo results\n    np.random.seed(0)\n\n    for case in test_cases:\n        D = case['D']\n        Sigma_a = case['Sigma_a']\n        S0 = case['S0']\n        delta_Sigma_a_func = case['delta_Sigma_a_func']\n        delta_Sigma_a_info = case['delta_Sigma_a_info']\n\n        k = np.sqrt(Sigma_a / D)\n        cosh_k_half = np.cosh(k / 2.0)\n\n        # Analytic forward flux phi(x)\n        def phi(x):\n            return (S0 / Sigma_a) * (1.0 - np.cosh(k * (x - 0.5)) / cosh_k_half)\n\n        # Analytic adjoint flux psi_dagger(x)\n        def psi_dagger(x):\n            return 1.0 - np.cosh(k * (x - 0.5)) / cosh_k_half\n\n        # Integrand for sensitivity calculation\n        def integrand(x):\n            return delta_Sigma_a_func(x) * phi(x) * (1.0 - psi_dagger(x))\n\n        # 1. Deterministic sensitivity calculation using numerical integration\n        # The integral is non-zero only where delta_Sigma_a is non-zero.\n        integration_range = delta_Sigma_a_info['range']\n        s_det, _ = integrate.quad(integrand, integration_range[0], integration_range[1], limit=200)\n\n        # 2. Monte Carlo sensitivity calculation\n        # Generate uniform random samples for x in [0, 1]\n        x_samples = np.random.uniform(0.0, 1.0, N_samples)\n        \n        # Evaluate the integrand at sample points\n        # Use vectorized operations for efficiency\n        delta_vals = np.zeros(N_samples)\n        if delta_Sigma_a_info['type'] == 'const':\n            delta_vals[:] = delta_Sigma_a_info['val']\n        elif delta_Sigma_a_info['type'] == 'piecewise':\n            low, high = delta_Sigma_a_info['range']\n            mask = (x_samples >= low)  (x_samples = high)\n            delta_vals[mask] = delta_Sigma_a_info['val']\n        \n        integrand_samples = delta_vals * phi(x_samples) * (1.0 - psi_dagger(x_samples))\n\n        # The MC estimate is the mean of the integrand values,\n        # since the integral is over a domain of length 1.\n        s_mc = np.mean(integrand_samples)\n        \n        # 3. Comparison\n        if s_det != 0:\n            relative_difference = np.abs(s_mc - s_det) / np.abs(s_det)\n        else: # Should not happen in these test cases\n            relative_difference = 0.0 if s_mc == 0.0 else float('inf')\n\n        is_within_tolerance = relative_difference  tolerance\n        results.append(str(is_within_tolerance).lower())\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}