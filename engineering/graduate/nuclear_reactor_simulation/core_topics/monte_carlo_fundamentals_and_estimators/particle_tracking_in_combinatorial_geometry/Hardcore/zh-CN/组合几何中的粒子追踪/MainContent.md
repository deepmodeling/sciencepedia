## 引言
精确模拟粒子在复杂系统中的行为，是现代科学与工程研究的基石，尤其在核反应堆的设计、安全分析和优化中扮演着至关重要的角色。为了实现对中子和光子等粒子输运过程的高保真模拟，我们必须能够在一个[计算模型](@entry_id:637456)中同时精确地描述复杂的几何环境和粒子遵循的物理定律。组合几何（Combinatorial Geometry）中的粒子追踪技术正是应对这一挑战的核心方法，它提供了一套强大而灵活的框架，用于在计算机中构建并“导航”从单个燃料棒到整个反应堆堆芯的复杂结构。本文旨在系统性地剖析这一关键技术，解决在复杂几何中高效、准确追踪粒子这一核心难题。

本文将引导读者逐步深入该领域。在第一章“原理与机制”中，我们将奠定理论基础，详细阐述如何定义粒子的状态，如何使用[构造实体几何](@entry_id:1122948)（CSG）构建模型，以及驱动粒子运动的核心追踪算法。接着，在第二章“应用与交叉学科联系”中，我们将这些原理与实际问题相结合，展示[粒子追踪](@entry_id:190741)技术在核工程中的核心应用，如反应堆建模、[多物理场耦合](@entry_id:171389)，并探索其思想如何延伸至[计算声学](@entry_id:172112)、[高能物理](@entry_id:181260)和[分子动力学](@entry_id:147283)等多个前沿交叉学科。最后，在第三章“动手实践”中，读者将有机会通过一系列精心设计的编程问题，将理论知识转化为解决实际几何追踪挑战的实践能力。通过这一结构化的学习路径，本文将为读者构建一个关于组合几何[粒子追踪](@entry_id:190741)的完整知识体系。

## 原理与机制

在上一章引言的基础上，本章深入探讨中子在组合几何中进行粒子追踪的底层原理和核心机制。我们将系统地阐述如何描述粒子的状态与运动、如何用数学语言构建复杂的几何环境、粒子如何在这些环境中运动的物理定律，以及最终将这些要素结合起来形成稳健追踪算法的具体步骤。

### 粒子的状态与运动

在[蒙特卡洛输运](@entry_id:752178)模拟中，每个计算粒子都代表了大量具有相似状态的物理粒子的集合。为了完整描述一个中子的行为，我们必须精确定义其状态。一个计算粒子的状态由一个多元组 $(\mathbf{r}, \mathbf{\Omega}, E, t, w)$ 描述，其中每个分量都扮演着至关重要的角色 。

- **位置 $\mathbf{r}$**: 一个三维矢量，用于指定粒子在三维[笛卡尔坐标系](@entry_id:169789)中的空间位置。仅由位置构成的空间被称为**[位形空间](@entry_id:149531)**（Configuration Space）。

- **方向 $\mathbf{\Omega}$**: 一个三维单位矢量，表示粒子的运动方向。它通常由三个**[方向余弦](@entry_id:170591)** $(\mu, \eta, \xi)$ 构成，即 $\mathbf{\Omega} = (\mu, \eta, \xi)$，其中 $\mu = \cos\theta_x, \eta = \cos\theta_y, \xi = \cos\theta_z$ 分别是[方向矢量](@entry_id:1132366)与 $x, y, z$ 轴的夹角余弦。作为单位矢量，它必须始终满足[归一化条件](@entry_id:156486) $\mu^2 + \eta^2 + \xi^2 = 1$ 。

- **能量 $E$**: 粒子的动能。在非相对论情况下，粒子的动量矢量 $\mathbf{p}$ 与能量 $E$ 和方向 $\mathbf{\Omega}$ 的关系为 $\mathbf{p} = \sqrt{2mE} \mathbf{\Omega}$，其中 $m$ 是[粒子质量](@entry_id:156313)。因此，用 $(\mathbf{\Omega}, E)$ 或 $\mathbf{p}$ 来描述粒子的运动状态在物理上是等价的。然而，在[反应堆物理](@entry_id:158170)中，由于微观[截面](@entry_id:154995)数据通常是关于能量 $E$ 的函数，因此在蒙特卡洛程序中直接存储和使用能量 $E$ 更为便捷 。

位置、方向和能量共同定义了粒子的物理状态，它们构成的空间 $(\mathbf{r}, \mathbf{\Omega}, E)$ 被称为**相空间**（Phase Space）。角度通量密度 $\psi(\mathbf{r}, \mathbf{\Omega}, E, t)$ 作为[玻尔兹曼输运方程](@entry_id:140472)的解，其定义域就是相空间和时间的组合。

- **时间 $t$**: 粒子历史中的[绝对时间](@entry_id:265046)。对于[稳态](@entry_id:139253)问题，其中源、材料和几何形状不随时间变化，粒子的行为不依赖于其“年龄”，因此时间 $t$ 可以从状态中省略。然而，在[瞬态分析](@entry_id:262795)中，如反应堆启动或事故模拟，材料[截面](@entry_id:154995)或几何边界可能随时间变化，此时时间 $t$ 成为追踪粒子和正确取样的必要[状态变量](@entry_id:138790) 。

- **权重 $w$**: 粒子的[统计权重](@entry_id:186394)。这是一个计算上的辅助变量，而非粒子的物理属性。在纯模拟（Analog Simulation）中，每个计算粒子代表一个物理粒子，权重恒为 $1$。在非模拟（Non-analog）计算中，为了提高计算效率和降低统计方差，会使用诸如隐式俘获（Implicit Capture）等减方差技巧。在这些技巧中，粒子在发生吸收反应时不会被终止，而是其权重 $w$ 会乘以一个生存概率。因此，权重 $w$ 是[蒙特卡洛估计量](@entry_id:1128148)和减方差方案的一部分，但它不属于物理相空间。权重的改变不会影响粒子的几何轨迹 。

粒子在两次相互作用事件之间沿[直线运动](@entry_id:165142)。其[运动学方程](@entry_id:173032)可以简洁地表示为 $d\mathbf{r}/ds = \mathbf{\Omega}$，其中 $s$ 是沿轨迹的物理[弧长](@entry_id:191173)。这个关系式直接要求了[方向矢量](@entry_id:1132366) $\mathbf{\Omega}$ 必须是一个单位矢量，即 $\|\mathbf{\Omega}\|=1$。然而，在模拟过程中，当粒子与表面相互作用（如反射）时，其[方向矢量](@entry_id:1132366)会经过旋转或反射等数值变换。由于[浮点运算](@entry_id:749454)的[舍入误差](@entry_id:162651)，即使是理论上的[正交变换](@entry_id:155650)（如镜面反射 $\mathbf{\Omega}' = \mathbf{\Omega} - 2(\mathbf{\Omega}\cdot\mathbf{n})\mathbf{n}$），计算后的新[方向矢量](@entry_id:1132366) $\mathbf{\Omega}'$ 的模长也可能微小地偏离 $1$。这种偏差若不加以纠正，会在多次相互作用后累积，导致参数 $s$ 不再精确代表物理[弧长](@entry_id:191173)，从而引入系统性偏差。因此，在每次更新[方向矢量](@entry_id:1132366)后，必须进行一次归一化操作，即 $\mathbf{\Omega} \leftarrow \mathbf{\Omega}/\|\mathbf{\Omega}\|$，以将其投影回[单位球](@entry_id:142558)面上，确保模拟的物理一致性 。

### 几何表示方法：[构造实体几何](@entry_id:1122948)

为了模拟粒子在复杂环境（如反应堆堆芯）中的运动，我们首先需要一种强大而灵活的几何表示方法。**[构造实体几何](@entry_id:1122948)**（Constructive Solid Geometry, CSG）是[粒子输运模拟](@entry_id:753220)中最常用的技术之一。其核心思想是通过对一组简单的**几何基元**（Primitive Solids）执行**布尔运算**（Boolean Operations）来构建复杂的几何区域。

#### 隐函数与几何基元

在CSG中，每个几何基元（如平面、球面、圆柱面等）的边界都由一个**隐函数** $f(\mathbf{r}) = 0$ 定义。这个函数将三维空间中的任意一点 $\mathbf{r}$ 映射为一个标量值。根据惯例，我们定义满足 $f(\mathbf{r}) \le 0$ 的点集为该基元所定义的实体“内部”（包括边界）。因此，隐函数不仅定义了边界，还对整个空间进行了内外划分 。

在[粒子追踪](@entry_id:190741)中，一个关键任务是确定一个点相对于一个表面的位置。这可以通过计算隐函数值的符号来完成。此外，表面的[法向量](@entry_id:264185)对于判断粒子是进入还是穿出区域至关重要。对于由光滑隐函数 $f(\mathbf{r}) \le 0$ 定义的区域，在边界上任意正则点（即 $\nabla f \neq \mathbf{0}$ 的点），其指向区域外部的[单位法向量](@entry_id:178851) $\mathbf{n}$ 可以通过归一化的梯度得到：
$$
\mathbf{n} = \frac{\nabla f(\mathbf{r})}{\|\nabla f(\mathbf{r})\|}
$$
因为梯度方向是函数值增长最快的方向，而根据定义，$f$ 的值从内部 ($f \le 0$) 到外部 ($f > 0$) 是增加的 。

以下是一些常用几何基元的隐函数定义：
- **[半空间](@entry_id:634770)（由平面定义）**: 对于一个通过点 $\mathbf{r}_0$、向外[单位法向量](@entry_id:178851)为 $\mathbf{n}$ 的平面，其定义的[半空间](@entry_id:634770)内部由 $f_{\text{plane}}(\mathbf{r}) = \mathbf{n} \cdot (\mathbf{r} - \mathbf{r}_0) \le 0$ 描述。
- **球体**: 对于一个中心在 $\mathbf{c}$、半径为 $R$ 的球体，其内部由 $f_{\text{sphere}}(\mathbf{r}) = \|\mathbf{r} - \mathbf{c}\| - R \le 0$ 描述。
- **无限长圆柱**: 对于轴向为单位矢量 $\mathbf{a}$、通过点 $\mathbf{c}$、半径为 $R$ 的无限长圆柱，其内部点的径向距离小于等于 $R$。径向距离是点 $\mathbf{r}$ 到轴线的[垂直距离](@entry_id:176279)，其平方为 $\|(\mathbf{r}-\mathbf{c}) - ((\mathbf{r}-\mathbf{c})\cdot\mathbf{a})\mathbf{a}\|^2$。因此，隐函数为 $f_{\text{inf-cyl}}(\mathbf{r}) = \|(\mathbf{r}-\mathbf{c}) - ((\mathbf{r}-\mathbf{c})\cdot\mathbf{a})\mathbf{a}\| - R \le 0$。

#### 布尔运算与复合实体

CSG的威力在于通过布尔运算（并集 $\cup$、交集 $\cap$、[差集](@entry_id:140904) $\setminus$）将简单的基元组合成复杂的物体。这些[集合运算](@entry_id:143311)可以优雅地转化为对隐函数的操作。假设我们有两个实体 $A = \{\mathbf{r} : f_A(\mathbf{r}) \le 0\}$ 和 $B = \{\mathbf{r} : f_B(\mathbf{r}) \le 0\}$：

- **交集 ($A \cap B$)**: 一个点属于交集，当且仅当它同时属于 $A$ 和 $B$。这等价于 $f_A(\mathbf{r}) \le 0$ 且 $f_B(\mathbf{r}) \le 0$。这个条件可以用函数 $g_I(\mathbf{r}) = \max(f_A(\mathbf{r}), f_B(\mathbf{r}))$ 来表示。只有当 $f_A$ 和 $f_B$ 均非正时，$g_I(\mathbf{r}) \le 0$ 才成立。

- **并集 ($A \cup B$)**: 一个点属于并集，当且仅当它属于 $A$ 或 $B$。这等价于 $f_A(\mathbf{r}) \le 0$ 或 $f_B(\mathbf{r}) \le 0$。这个条件可以用函数 $g_U(\mathbf{r}) = \min(f_A(\mathbf{r}), f_B(\mathbf{r}))$ 来表示。只要 $f_A$ 和 $f_B$ 中至少有一个非正，$g_U(\mathbf{r}) \le 0$ 就成立。

- **[补集](@entry_id:161099) ($A^c$)**: 实体 $A$ 的[补集](@entry_id:161099)是所有不属于 $A$ 的点，即满足 $f_A(\mathbf{r}) > 0$ 的点集。为了符合 $g(\mathbf{r}) \le 0$ 的约定，我们可以定义[补集](@entry_id:161099)的函数为 $g_C(\mathbf{r}) = -f_A(\mathbf{r})$。这样，$g_C(\mathbf{r}) \le 0$ 就等价于 $f_A(\mathbf{r}) \ge 0$，这恰好定义了 $A$ 的外部空间（包括边界）。

利用这些规则，我们可以构建复杂的几何形状。例如，一个有限长的圆柱体可以被看作是一个无限长圆柱体与一个由两个[平行平面](@entry_id:165919)定义的厚板的交集。一个被截断的圆锥体则是一个无限圆锥与两个平面[半空间](@entry_id:634770)的交集 。一个球壳 $R=A\setminus C$（其中$A$为大球，$C$为小球）的CSG表示为 $A \cap C^c$。在其内边界上，区域 $R$ 的向外法向量指向球心，与基元 $C$ 的向外法向量正好相反 。

### 粒子输运的物理学：[截面](@entry_id:154995)与自由程

在几何模型中，粒子沿直线运动，直到与材料中的原子核发生相互作用。这种相互作用的概率由**[宏观截面](@entry_id:1127564)**（Macroscopic Cross Section）$\Sigma$ 来量化。

#### 宏观截面

宏观总截面 $\Sigma_t(\mathbf{r}, E)$ 定义为能量为 $E$ 的粒子在位置 $\mathbf{r}$ 处单位路径长度上发生任何类型相互作用的概率。它具有反长度的单位（如 $\text{cm}^{-1}$）。如果一个区域内的材料是均匀的，由 $Z$ 种核素混合而成，那么其宏观[总截面](@entry_id:151809)是各组分贡献的线性加和：
$$
\Sigma_t(E) = \sum_{i=1}^{Z} N_i \sigma_{t,i}(E)
$$
其中，$N_i$ 是第 $i$ 种核素的原子核密度（单位：$\text{atoms}/\text{cm}^3$），而 $\sigma_{t,i}(E)$ 是该核素对应能量 $E$ 的**微观总截面**（单位：$\text{cm}^2$，通常用靶恩，$1 \text{ barn} = 10^{-24} \text{ cm}^2$）。微观[截面](@entry_id:154995)是粒子与单个原子核相互作用的[有效面积](@entry_id:197911)，是一个依赖于相互作用类型和入射粒子能量的物理量。宏观总截面 $\Sigma_t$ 包括了所有可能发生的相互作用，如散射（$\Sigma_s$）、俘获（$\Sigma_a$）、裂变（$\Sigma_f$）等 。

#### 自由程的概率分布

在一个[宏观截面](@entry_id:1127564) $\Sigma_t$ 恒定的均匀介质中，粒子在运动中幸存（即不发生相互作用）的概率随路径长度的增加而指数衰减。考虑粒子已经行进了距离 $\ell$，它在接下来的无穷小距离 $d\ell$ 内发生相互作用的概率为 $\Sigma_t d\ell$。设 $S(\ell)$为粒子行进距离 $\ell$ 而未发生相互作用的生存概率，则有：
$$
S(\ell + d\ell) = S(\ell) (1 - \Sigma_t d\ell)
$$
这导出一个[微分](@entry_id:158422)方程 $dS/d\ell = -\Sigma_t S(\ell)$，其解为 $S(\ell) = \exp(-\Sigma_t \ell)$（假定 $S(0)=1$）。

粒子到下一次碰撞的飞行距离，即**自由程**（Free Path）$\ell_c$，是一个[随机变量](@entry_id:195330)。其[累积分布函数 (CDF)](@entry_id:264700) $F(\ell_c)$ 是粒子在距离 $\ell_c$ 内发生碰撞的概率，它等于 $1$ 减去生存概率：$F(\ell_c) = 1 - S(\ell_c) = 1 - \exp(-\Sigma_t \ell_c)$。其概率密度函数 (PDF) $p(\ell_c)$ 是CDF的导数：
$$
p(\ell_c) = \frac{dF(\ell_c)}{d\ell_c} = \Sigma_t \exp(-\Sigma_t \ell_c) \quad (\ell_c \ge 0)
$$
这正是指数分布。在蒙特卡洛模拟中，我们可以通过**[逆变换采样法](@entry_id:142402)**（Inverse Transform Sampling）来抽取一个服从此分布的自由程。令 $\xi$ 是一个在 $(0, 1)$ 上均匀分布的随机数，我们令 $F(\ell_c) = \xi$，然后求解 $\ell_c$：
$$
1 - \exp(-\Sigma_t \ell_c) = \xi \implies \ell_c = -\frac{\ln(1-\xi)}{\Sigma_t}
$$
由于 $1-\xi$ 与 $\xi$ 具有相同的分布，该抽样公式通常简化为：
$$
\ell_c = -\frac{\ln\xi}{\Sigma_t}
$$
。

#### 马尔可夫属性与可[组合性](@entry_id:637804)

[指数分布](@entry_id:273894)的一个关键特性是**[无记忆性](@entry_id:201790)**（Memoryless Property）。这意味着，给定一个粒子已经行进了距离 $s$ 而未发生碰撞，它再继续行进距离 $t$ 仍不发生碰撞的[条件概率](@entry_id:151013)，与它从一开始就行进距离 $t$ 而不发生碰撞的概率是相同的：
$$
P(\ell_c > s+t \mid \ell_c > s) = \frac{P(\ell_c > s+t)}{P(\ell_c > s)} = \frac{\exp(-\Sigma_t(s+t))}{\exp(-\Sigma_t s)} = \exp(-\Sigma_t t) = P(\ell_c > t)
$$
这个性质是[粒子输运](@entry_id:1129401)过程具有**马尔可夫属性**（Markov Property）的根本原因。该属性指出，一个粒子未来的演化只依赖于其**当前**的状态（位置、方向、能量等），而与它如何到达当前状态的历史无关。

马尔可夫属性是蒙特卡洛[粒子追踪](@entry_id:190741)方法得以“分步进行”的理论基石。当一个粒子从一个区域穿过边界进入另一个具有不同[截面](@entry_id:154995) $\Sigma_{t, \text{new}}$ 的区域时，我们不需要记录它在旧区域“剩余”的自由程。相反，由于[无记忆性](@entry_id:201790)，我们可以完全“忘记”过去，在新的区域内根据新的[截面](@entry_id:154995) $\Sigma_{t, \text{new}}$ 重新抽样一个全新的自由程。这种将复杂的粒子历史分解为一系列独立的、可组合的追踪步（从一个事件到下一个事件）的能力，极大地简化了算法的设计 。

### 核心追踪算法：事件竞争

[粒子追踪算法](@entry_id:1129400)的核心循环在于模拟粒子从一个事件点到下一个事件点的过程。在任何时刻，粒子面前都存在两种相互竞争的可能事件：
1.  与材料发生**碰撞**（Collision）。
2.  穿过一个**几何边界**（Boundary Crossing）。

算法必须确定哪一个事件会先发生。这通过比较两个关键距离来实现 ：

- **碰撞距离 $\ell_c$**: 这是根据当前所在区域的[宏观截面](@entry_id:1127564) $\Sigma_t$ [随机抽样](@entry_id:175193)的自由程，$ \ell_c = -\ln(\xi)/\Sigma_t $。
- **边界距离 $\ell_b$**: 这是从粒子当前位置 $\mathbf{r}$ 沿其当前方向 $\mathbf{\Omega}$ 到最近的几何边界的确定性距离。这个距离通过射线追踪（Ray Tracing）计算得出，即[求解方程组](@entry_id:152624) $f_i(\mathbf{r} + s\mathbf{\Omega}) = 0$ 对所有相关表面 $i$ 的最小正实数解 $s$。

粒子实际行进的距离 $\ell_{\text{step}}$ 是这两者的最小值：
$$
\ell_{\text{step}} = \min(\ell_c, \ell_b)
$$
在粒子沿方向 $\mathbf{\Omega}$ 移动了 $\ell_{\text{step}}$ 的距离后，其位置更新为 $\mathbf{r}_{\text{new}} = \mathbf{r} + \ell_{\text{step}}\mathbf{\Omega}$。接下来，根据哪个事件获胜来执行相应的处理：

- **如果 $\ell_c  \ell_b$**: 碰撞事件先发生。粒子在当前区域内部的 $\mathbf{r}_{\text{new}}$ 处发生了一次碰撞。算法随后会模拟碰撞的物理过程：首先判断碰撞类型（如散射、俘获或裂变），然后根据物理模型抽样新的能量和方向（如果是散射或裂变），或者终止该粒子（如果是俘获）。

- **如果 $\ell_b \le \ell_c$**: 边界穿越事件先发生。粒子到达了区域边界。算法需要处理边界穿越逻辑：
    1.  **判断穿越方向**: 通过计算粒子速度方向 $\mathbf{\Omega}$ 与边界表面向外法向量 $\mathbf{n}$ 的点积来判断。如果 $\mathbf{\Omega} \cdot \mathbf{n} > 0$，粒子正在穿出该区域；如果 $\mathbf{\Omega} \cdot \mathbf{n}  0$，粒子正在进入该区域 。
    2.  **更新区域信息**: 算法将粒子定位到新的几何区域，并加载该区域的材料属性（即新的 $\Sigma_t$）。
    3.  **重新开始竞争**: 根据马尔可夫属性，之前抽样的碰撞距离 $\ell_c$ 作废。算法会在新区域中，基于新的[截面](@entry_id:154995)值，重新抽样一个碰撞距离 $\ell_c'$，并计算到新区域边界的距离 $\ell_b'$，开始新一轮的事件竞争。

这个“抽样-比较-移动-处理”的循环不断重复，直到粒子被吸收、逃逸出整个几何系统，或者其权重低于某个阈值而被轮盘赌消去。

### 层次化与重[复几何](@entry_id:159080)结构

真实的反应堆几何模型极其复杂，但往往包含大量重复的结构，例如成千上万个排列成阵列的燃料棒。为了高效地表示和处理这类几何，CSG系统引入了层次化的概念，主要通过**栅格**（Lattices）、**单元**（Cells）和**宇宙**（Universes）来实现 。

- **单元 (Cell)**: 是最基本的几何建筑块，由一个[布尔表达式](@entry_id:262805)定义的一个特定材料填充的空间区域。例如，“位于A球体内部且在B圆柱外部的区域，填充材料为水”。

- **宇宙 (Universe)**: 是一个包含一个或多个不相交单元的集合，这些单元共同构成一个完整的局部空间。例如，一个燃料棒“宇宙”可以包含一个填充[二氧化铀](@entry_id:1133640)的中心单元和一个填充锆合金的包[壳单元](@entry_id:176094)。

- **栅格 (Lattice)**: 是一种特殊的单元，它本身不填充材料，而是定义一个规则的网格（如矩形或六边形阵列）。网格的每个位置都可以被一个指定的宇宙实例填充。这使得用非常紧凑的数据结构来描述大规模重[复几何](@entry_id:159080)成为可能。

这种层次化结构的关键在于**实例化**（Instancing）。一个宇宙的定义可以被多次“实例化”并放置在几何模型的不同位置。当一个粒子进入一个被栅格填充的单元时，追踪算法需要执行以下步骤：
1.  **确定栅格索引**: 根据粒子的全局坐标 $\mathbf{x}_g$ 和栅格的尺寸（如节距 $p$），计算出粒子位于哪个栅格元素 $(i,j,k)$ 中。例如，对于一个中心在 $(ip, jp)$ 的二维方格栅格，正确的索引计算公式是 $i = \lfloor x_g/p + 1/2 \rfloor$ 和 $j = \lfloor y_g/p + 1/2 \rfloor$。
2.  **坐标变换**: 每个实例化的宇宙都有一个从其[局部坐标系](@entry_id:751394)到全局坐标系的变换，通常包括平移和旋转。为了在宇宙内部进行追踪，必须将粒子的全局状态 $(\mathbf{x}_g, \mathbf{\Omega}_g)$ 变换到该实例的[局部坐标系](@entry_id:751394)。如果从局部到全局的变换是先旋转（由矩阵 $\mathbf{R}$ 表示）后平移（由矢量 $\mathbf{t}$ 表示），即 $\mathbf{x}_g = \mathbf{R}\mathbf{x}_\ell + \mathbf{t}$，那么从全局到局部的逆变换为：
    $$
    \mathbf{x}_\ell = \mathbf{R}^{-1}(\mathbf{x}_g - \mathbf{t}) = \mathbf{R}^T(\mathbf{x}_g - \mathbf{t})
    $$
    $$
    \mathbf{\Omega}_\ell = \mathbf{R}^{-1}\mathbf{\Omega}_g = \mathbf{R}^T\mathbf{\Omega}_g
    $$
    这里利用了旋转矩阵是[正交矩阵](@entry_id:169220)的性质，即其逆等于其[转置](@entry_id:142115) $\mathbf{R}^{-1} = \mathbf{R}^T$ 。
3.  **局部追踪**: 在该宇宙的[局部坐标系](@entry_id:751394)中，使用标准的事件竞争算法进行粒子追踪。
4.  **逆变换**: 如果粒子穿出该局部宇宙的边界，其最终的局部状态需要被逆变换回[全局坐标系](@entry_id:171029)，然后继续在上一层级的几何中进行追踪。

通过这种方式，复杂的重[复结构](@entry_id:269128)可以用一个单一的宇宙定义和一系列变换来高效表示，极大地减少了模型定义的复杂性和内存占用。

### 数值稳健性与高级专题

将理想的几何与物理模型在有限精度的计算机上实现，会遇到一系列微妙但至关重要的数值挑战。一个稳健的[粒子追踪](@entry_id:190741)器必须能够优雅地处理这些问题。

#### 边界处的数值精度问题

当粒子运动到非常靠近几何边界时，浮点数的[舍入误差](@entry_id:162651)可能导致错误的判断，引发两种典型问题：

1.  **振荡性重复穿越**: 粒子在穿越一个表面后，由于计算出的新位置仍处于[数值误差](@entry_id:635587)范围内，程序可能错误地判断它仍在旧区域，导致它在下一步立即“重新穿越”回旧区域，从而在边界上来回振荡，陷入死循环。为了解决这个问题，在每次成功的边界穿越后，必须将粒子沿其运动方向（或表面法向）“推”过一个微小的距离 $\epsilon$，确保其新位置在数值上能被稳健地判断为在新区域内 。这个 $\epsilon$ 必须仔细选择，它需要大于典型的[浮点误差](@entry_id:173912)，但远小于几何模型中的最小特征尺寸，以避免“跳过”薄层区域。

2.  **边或角的处理**: 当粒子恰好撞击到两个或多个表面的交界处（一条边或一个顶点）时，射线追踪计算会发现到多个表面的距离是相同（或在数值容差内）的最小值。这是一个“平局”情况。一个不稳健的算法如果只随机或根据表面ID等任意规则选择其中一个表面进行处理，很可能会导致拓扑错误，即将粒子置于一个不正确的相邻区域。正确的处理方法是，识别出所有距离“打平”的表面，将粒子推进到该交点，然后再向前“推”一个微小距离 $\delta$，最后在新的位置 $\mathbf{r}^+ = \mathbf{r}(s+\delta)$ 处，重新对完整的CSG[布尔表达式](@entry_id:262805)进行求值，以确定粒子究竟进入了哪个区域。这种“推进并重新评估”的策略能保证在复杂的几何角落处做出拓扑一致的判断 。

#### 重合表面与零厚度间隙

在建模时，经常需要让两个不同的材料区域紧密贴合。在CSG中，这通常通过定义两个共享同一物理边界但法向相反的表面来实现。例如，区域A由 $f_A(\mathbf{r}) \le 0$ 定义，区域B由 $f_B(\mathbf{r}) \le 0$ 定义，它们在 $S$ 处贴合，则在 $S$ 上有 $f_A(\mathbf{r}) = 0$ 和 $f_B(\mathbf{r})=0$ 成立，且[法向量](@entry_id:264185)相反。这种**重合表面**（Coincident Surfaces）在数值上构成了**零厚度间隙**（Zero-thickness Gap），对追踪算法是一个严峻的挑战 。

当粒子到达这样一个重合边界时，由于[浮点误差](@entry_id:173912)，程序很难精确判断它应该进入哪个区域。一个微小的误差就可能让粒子“卡”在两个区域之间，或者在一个区域的边界上反复触发穿越。一个稳健的解决方案是在几何模型[预处理](@entry_id:141204)阶段，识别出所有重合表面，并将它们合并成一个单一的拓扑界面，同时显式地存储该界面两侧的区域邻接关系。这样，当粒子撞击该界面时，算法不再依赖于有风险的[浮点数](@entry_id:173316)几何判断，而是通过简单的查表操作来确定正确的区域转换，从而保证追踪的确定性和稳健性 。

#### δ-追踪方法

处理复杂异构介质的另一种强大技术是**δ-追踪**（Delta Tracking），也称为伍德科克方法（Woodcock Method）。它通过引入一个**优选[截面](@entry_id:154995)**（Majorant Cross Section）$\Sigma_M$，该值大于或等于整个问题域中任何材料在任何能量下的最大宏观截面，即 $\Sigma_M \ge \max_{\mathbf{r},E} \Sigma_t(\mathbf{r}, E)$。

算法流程变为：
1.  忽略所有几何边界，假设粒子在一个[截面](@entry_id:154995)恒为 $\Sigma_M$ 的均匀介质中运动。
2.  抽样一个基于 $\Sigma_M$ 的自由程 $\ell_c = -\ln(\xi)/\Sigma_M$，得到一个“候选碰撞点”。
3.  在候选碰撞点 $\mathbf{r}_{\text{cand}}$，算法进行一次“接受-拒绝”测试。它以概率 $P_{\text{real}} = \Sigma_t(\mathbf{r}_{\text{cand}}, E) / \Sigma_M$ 接受这次碰撞为**真实碰撞**。如果接受，就正常处理[碰撞物理](@entry_id:164923)。
4.  如果碰撞被拒绝（以概率 $1-P_{\text{real}}$），则其被视为一次**虚拟碰撞**（或称空碰撞）。粒子不改变能量和方向，仿佛什么都没发生，然后从该点继续开始新一轮的δ-追踪。

δ-追踪的巧妙之处在于，它将复杂的几何追踪问题（计算到边界的距离）转化为了一个纯粹的随机行走过程，完全避免了射线-表面相交计算。这使得它在处理极其复杂或连续变化的几何与材料时特别有效。这个过程在数学上是完全无偏的，并且同样遵循马尔可夫属性 。