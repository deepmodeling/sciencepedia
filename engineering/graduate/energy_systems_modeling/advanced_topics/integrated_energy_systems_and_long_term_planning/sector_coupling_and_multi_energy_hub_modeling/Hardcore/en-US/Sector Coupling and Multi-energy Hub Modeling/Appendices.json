{
    "hands_on_practices": [
        {
            "introduction": "The foundation of any energy system model is the principle of energy conservation. This first practice provides a concrete application of this principle within a simple multi-energy hub. By tracking energy as it flows from external sources (electricity and natural gas) through conversion devices (a boiler and a chiller) to meet final demands, you will perform a fundamental energy balance calculation . This exercise is crucial for mastering the core concepts of conversion efficiency ($\\eta$) and coefficient of performance ($COP$) and how they determine the operational capabilities of a hub.",
            "id": "4122226",
            "problem": "A single multi-energy hub serves co-located heating and cooling end-uses at steady state. The hub has two external energy inflows: an electrical inflow of $u_{e}=5\\,\\mathrm{MW}$ and a natural gas inflow of $u_{g}=8\\,\\mathrm{MW}$ measured on a higher heating value (HHV) basis. The hub contains two conversion devices:\n- A gas-fired boiler that delivers useful heat with constant first-law efficiency $\\eta_{h}=0.9$ defined on an HHV basis.\n- An electric vapor-compression chiller that delivers useful cooling with a constant coefficient of performance $\\mathrm{COP}_{c}=3.5$, defined as the ratio of delivered cooling to electrical input.\n\nThe hub also has a fixed internal auxiliary electrical demand (pumps and controls) of $\\dot{E}_{\\mathrm{loss}}=1\\,\\mathrm{MW}$. This auxiliary demand must be supplied from the electrical inflow before any electricity is available to the chiller. Assume all remaining electricity can be supplied to the chiller, and all natural gas can be supplied to the boiler. There is no electricity generation from gas and no other devices present. Waste heat and rejected heat leave the hub boundary and are not counted as useful outputs.\n\nUsing only conservation of energy at the device level and the definitions of efficiency and coefficient of performance, determine the maximum simultaneous steady-state useful heat output $\\dot{Q}_{h}$ and useful cooling output $\\dot{Q}_{c}$ that the hub can deliver when all available inflows are directed to these services subject to the auxiliary electrical demand. Express the final answer as exact values in $\\mathrm{MW}$. Provide your final answer as a row vector containing the two numbers in the order $\\dot{Q}_{h}$, $\\dot{Q}_{c}$.",
            "solution": "The user-provided problem is first subjected to a rigorous validation process.\n\n### Step 1: Extract Givens\nThe following data and definitions are extracted verbatim from the problem statement:\n- Electrical inflow: $u_{e}=5\\,\\mathrm{MW}$\n- Natural gas inflow (HHV basis): $u_{g}=8\\,\\mathrm{MW}$\n- Gas-fired boiler efficiency (HHV basis): $\\eta_{h}=0.9$\n- Electric vapor-compression chiller coefficient of performance: $\\mathrm{COP}_{c}=3.5$\n- Internal auxiliary electrical demand: $\\dot{E}_{\\mathrm{loss}}=1\\,\\mathrm{MW}$\n- System is at steady state.\n- Boiler efficiency is defined as $\\eta_{h} = (\\text{useful heat}) / (\\text{gas input, HHV})$.\n- Chiller COP is defined as $\\mathrm{COP}_{c} = (\\text{delivered cooling}) / (\\text{electrical input})$.\n- The auxiliary demand must be supplied from the electrical inflow before any electricity is available to the chiller.\n- All remaining electricity is supplied to the chiller.\n- All natural gas is supplied to the boiler.\n- There is no electricity generation from gas and no other devices are present.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is assessed against the required criteria.\n- **Scientifically Grounded**: The problem is based on the first law of thermodynamics and standard definitions of energy conversion performance metrics (efficiency $\\eta$ and coefficient of performance $\\mathrm{COP}$). The numerical values provided ($\\eta_h = 0.9$, $\\mathrm{COP}_c = 3.5$) are physically realistic for modern boiler and chiller technologies.\n- **Well-Posed**: The problem is well-posed. It provides all necessary inputs, conversion parameters, and internal demands to uniquely determine the outputs. The objective is clearly stated: find the maximum simultaneous useful heat and cooling outputs.\n- **Objective**: The problem is stated using precise, objective, and quantitative language. No subjective or opinion-based statements are present.\n- **Flaw Analysis**: The problem statement exhibits no flaws. It is scientifically sound, fully specified, contains no contradictions, and uses standard, well-defined terminology. The constraints are clear and lead to a unique solution. The two energy conversion pathways (gas-to-heat and electricity-to-cooling) are decoupled, allowing for a straightforward calculation of their respective maximum outputs.\n\n### Step 3: Verdict and Action\nThe problem is valid. A complete solution will be provided.\n\nThe problem requires the calculation of two distinct energy outputs: useful heat ($\\dot{Q}_{h}$) and useful cooling ($\\dot{Q}_{c}$). These are determined by applying the principles of energy conservation to each conversion device within the multi-energy hub.\n\nFirst, we calculate the useful heat output, $\\dot{Q}_{h}$, from the gas-fired boiler. The boiler's energy input is the entire natural gas inflow, $u_{g} = 8\\,\\mathrm{MW}$. The conversion efficiency, $\\eta_{h}$, is given as $0.9$. The definition of this efficiency is the ratio of useful heat output to the energy input from the fuel.\n$$\n\\eta_{h} = \\frac{\\dot{Q}_{h}}{u_{g}}\n$$\nSolving for $\\dot{Q}_{h}$, we obtain:\n$$\n\\dot{Q}_{h} = \\eta_{h} \\cdot u_{g}\n$$\nSubstituting the given values:\n$$\n\\dot{Q}_{h} = 0.9 \\cdot 8\\,\\mathrm{MW} = 7.2\\,\\mathrm{MW}\n$$\n\nNext, we calculate the useful cooling output, $\\dot{Q}_{c}$, from the electric chiller. The total electrical inflow to the hub is $u_{e} = 5\\,\\mathrm{MW}$. According to the problem statement, the internal auxiliary electrical demand, $\\dot{E}_{\\mathrm{loss}} = 1\\,\\mathrm{MW}$, must be satisfied first. The remaining electrical power, which we denote as $\\dot{E}_{\\mathrm{chiller}}$, is available to the chiller.\n$$\n\\dot{E}_{\\mathrm{chiller}} = u_{e} - \\dot{E}_{\\mathrm{loss}}\n$$\nSubstituting the given values:\n$$\n\\dot{E}_{\\mathrm{chiller}} = 5\\,\\mathrm{MW} - 1\\,\\mathrm{MW} = 4\\,\\mathrm{MW}\n$$\nThe performance of the chiller is described by its coefficient of performance for cooling, $\\mathrm{COP}_{c}$, which is given as $3.5$. This is defined as the ratio of the useful cooling output to the required electrical input.\n$$\n\\mathrm{COP}_{c} = \\frac{\\dot{Q}_{c}}{\\dot{E}_{\\mathrm{chiller}}}\n$$\nSolving for $\\dot{Q}_{c}$, we obtain:\n$$\n\\dot{Q}_{c} = \\mathrm{COP}_{c} \\cdot \\dot{E}_{\\mathrm{chiller}}\n$$\nSubstituting the calculated value for $\\dot{E}_{\\mathrm{chiller}}$ and the given value for $\\mathrm{COP}_{c}$:\n$$\n\\dot{Q}_{c} = 3.5 \\cdot 4\\,\\mathrm{MW} = 14.0\\,\\mathrm{MW}\n$$\n\nThe problem asks for the maximum simultaneous steady-state outputs. Since the heat production pathway (using gas) and the cooling production pathway (using electricity) are independent and all available inputs are being fully utilized as directed, the calculated values represent the maximum possible simultaneous outputs.\n\nTherefore, the useful heat output is $\\dot{Q}_{h} = 7.2\\,\\mathrm{MW}$, and the useful cooling output is $\\dot{Q}_{c} = 14.0\\,\\mathrm{MW}$.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n7.2 & 14.0\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "While introductory models often assume constant efficiencies, the performance of real-world energy conversion devices is typically non-linear and dependent on operating conditions. This practice addresses this complexity by exploring the performance of a heat pump, which is described by a non-linear, convex function. You will learn the critical technique of creating a piecewise-linear approximation of this function, a method essential for incorporating realistic device behavior into computationally tractable optimization models like Mixed-Integer Linear Programs (MILPs) . This skill is vital for bridging the gap between simplified theory and practical, large-scale energy systems modeling.",
            "id": "4122243",
            "problem": "Consider a multi-energy hub coupling electricity and heat via a vapor-compression heat pump. The effective performance of the heat pump depends on the source temperature and cycling behavior at partial load. Let the sink (delivery) temperature be fixed at $T_h$ (in K). The Coefficient of Performance (COP) is defined as the ratio of useful heat provided to electrical energy consumed, and we use the following physically motivated nonlinear performance map for the baseline Coefficient of Performance (COP) as a function of the source temperature $T_s$ (in K) over an admissible range $T_s \\in [T_{\\min}, T_{\\max}]$ with $T_{\\max} < T_h$:\n$$\nCOP(T_s) = \\eta_0 \\cdot \\frac{T_h}{T_h - T_s} \\;-\\; \\beta \\cdot (T_h - T_s),\n$$\nwhere $\\eta_0 \\in (0,1)$ represents an aggregate efficiency factor and $\\beta > 0$ represents an empirical degradation term that increases electricity usage for larger temperature lift $(T_h - T_s)$. Cycling at part-load ratio $\\lambda \\in [0,1]$ reduces performance. Define a cycling penalty factor\n$$\n\\phi(\\lambda) = 1 - \\gamma \\cdot (1 - \\lambda),\n$$\nwith $\\gamma \\in (0,1)$ such that $0 < \\phi(\\lambda) \\leq 1$. The effective Coefficient of Performance including cycling penalty is\n$$\nCOP_{\\text{eff}}(T_s,\\lambda) = \\phi(\\lambda) \\cdot COP(T_s).\n$$\n\nStarting from the fundamental definition of Coefficient of Performance (COP) and the classical Carnot bound, the above map is a plausible, scientifically sound, strictly convex function of $T_s$ over the admissible domain. In multi-energy hub modeling, to preserve convexity in optimization, one frequently employs convex piecewise-linear approximations. Your task is to construct a convex piecewise-linear upper approximation of $COP_{\\text{eff}}(T_s,\\lambda)$ on $[T_{\\min}, T_{\\max}]$ by connecting consecutive breakpoints with straight lines (i.e., linear interpolation between sampled points), and to compute approximation error bounds.\n\nRequirements:\n- Use $N$ equally spaced breakpoints on $[T_{\\min}, T_{\\max}]$ to define $N-1$ linear segments. Let these breakpoints be $T_0, T_1, \\dots, T_{N-1}$ with $T_0 = T_{\\min}$ and $T_{N-1} = T_{\\max}$. Evaluate $COP_{\\text{eff}}(T_i,\\lambda)$ at each breakpoint. The approximation on each interval $[T_i, T_{i+1}]$ is the chord joining points $(T_i, COP_{\\text{eff}}(T_i,\\lambda))$ and $(T_{i+1}, COP_{\\text{eff}}(T_{i+1},\\lambda))$. This yields a convex piecewise-linear upper approximation of $COP_{\\text{eff}}(T_s,\\lambda)$ on $[T_{\\min}, T_{\\max}]$.\n- Over the entire range $[T_{\\min}, T_{\\max}]$, compute:\n  1. The maximum absolute approximation error $E_{\\text{abs}} = \\max_{T_s \\in [T_{\\min}, T_{\\max}]} \\left( \\widehat{COP}_{\\text{eff}}(T_s,\\lambda) - COP_{\\text{eff}}(T_s,\\lambda) \\right)$.\n  2. The maximum relative approximation error $E_{\\text{rel}} = \\max_{T_s \\in [T_{\\min}, T_{\\max}]} \\left( \\frac{\\widehat{COP}_{\\text{eff}}(T_s,\\lambda) - COP_{\\text{eff}}(T_s,\\lambda)}{COP_{\\text{eff}}(T_s,\\lambda)} \\right)$.\n- Verify that the approximation is an upper bound everywhere by checking that $\\widehat{COP}_{\\text{eff}}(T_s,\\lambda) \\geq COP_{\\text{eff}}(T_s,\\lambda)$ for all $T_s$ on a dense grid in $[T_{\\min}, T_{\\max}]$, and report a boolean indicating whether the upper-bound property holds on the grid.\n- Temperatures must be in K. Coefficient of Performance (COP) is dimensionless. Errors must be expressed as dimensionless decimals. Angles are not used in this problem.\n\nTest Suite:\nProvide results for the following parameter sets, which together test typical cases and edge conditions:\n- Case A (general case):\n  - $T_h = 323.15$ K, $T_{\\min} = 273.15$ K, $T_{\\max} = 313.15$ K, $\\eta_0 = 0.35$, $\\beta = 0.02$, $\\gamma = 0.20$, $\\lambda = 0.70$, $N = 7$ breakpoints.\n- Case B (boundary near high source temperature):\n  - $T_h = 330.00$ K, $T_{\\min} = 300.00$ K, $T_{\\max} = 320.00$ K, $\\eta_0 = 0.35$, $\\beta = 0.015$, $\\gamma = 0.20$, $\\lambda = 0.30$, $N = 5$ breakpoints.\n- Case C (low source temperature edge):\n  - $T_h = 310.00$ K, $T_{\\min} = 260.00$ K, $T_{\\max} = 300.00$ K, $\\eta_0 = 0.32$, $\\beta = 0.02$, $\\gamma = 0.20$, $\\lambda = 0.95$, $N = 9$ breakpoints.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. For each test case, return a list with three elements: $[E_{\\text{abs}}, E_{\\text{rel}}, \\text{is\\_upper\\_bound}]$, where $E_{\\text{abs}}$ and $E_{\\text{rel}}$ are floats and $\\text{is\\_upper\\_bound}$ is a boolean. The overall output format must be\n$$\n[ [E_{\\text{abs}}^{(A)}, E_{\\text{rel}}^{(A)}, \\text{is\\_upper\\_bound}^{(A)}], [E_{\\text{abs}}^{(B)}, E_{\\text{rel}}^{(B)}, \\text{is\\_upper\\_bound}^{(B)}], [E_{\\text{abs}}^{(C)}, E_{\\text{rel}}^{(C)}, \\text{is\\_upper\\_bound}^{(C)}] ]\n$$",
            "solution": "The problem is assessed as **valid**. The scientific and mathematical premises are sound, the problem is well-posed, and all necessary data are provided. A complete solution can be derived.\n\nThe core of the problem rests on the convexity of the heat pump's Coefficient of Performance (COP) function. The problem statement asserts that the given function is strictly convex. This claim must be validated as a prerequisite.\n\nThe baseline COP is given as a function of the source temperature $T_s$:\n$$\nCOP(T_s) = \\eta_0 \\cdot \\frac{T_h}{T_h - T_s} - \\beta \\cdot (T_h - T_s)\n$$\nTo determine its convexity, we compute the second derivative with respect to $T_s$. The first derivative is:\n$$\n\\frac{d}{dT_s} COP(T_s) = \\eta_0 T_h \\frac{d}{dT_s}(T_h - T_s)^{-1} - \\beta \\frac{d}{dT_s}(T_h - T_s)\n$$\n$$\n\\frac{d}{dT_s} COP(T_s) = \\eta_0 T_h (-1)(T_h - T_s)^{-2}(-1) - \\beta(-1) = \\frac{\\eta_0 T_h}{(T_h - T_s)^2} + \\beta\n$$\nThe second derivative is:\n$$\n\\frac{d^2}{dT_s^2} COP(T_s) = \\eta_0 T_h \\frac{d}{dT_s}(T_h - T_s)^{-2} = \\eta_0 T_h (-2)(T_h - T_s)^{-3}(-1) = \\frac{2 \\eta_0 T_h}{(T_h - T_s)^3}\n$$\nThe problem specifies that the parameters are in the ranges $\\eta_0 \\in (0,1)$ and $\\beta > 0$. Temperatures are in Kelvin, so the sink temperature $T_h > 0$. The domain for the source temperature is restricted such that $T_s < T_h$. Consequently, every term in the expression for the second derivative is positive: $2 > 0$, $\\eta_0 > 0$, $T_h > 0$, and $(T_h - T_s)^3 > 0$.\nTherefore, $\\frac{d^2}{dT_s^2} COP(T_s) > 0$ over the entire domain, which proves that $COP(T_s)$ is a strictly convex function of $T_s$.\n\nThe effective COP, $COP_{\\text{eff}}(T_s,\\lambda) = \\phi(\\lambda) \\cdot COP(T_s)$, is the product of $COP(T_s)$ and the cycling penalty factor $\\phi(\\lambda) = 1 - \\gamma(1-\\lambda)$. Given $\\gamma \\in (0,1)$ and $\\lambda \\in [0,1]$, the factor $\\phi(\\lambda)$ is always positive. The product of a strictly convex function and a positive scalar is also strictly convex. Thus, $COP_{\\text{eff}}(T_s, \\lambda)$ is a strictly convex function of $T_s$ for any fixed $\\lambda$. This confirms the problem's central premise.\n\nThe piecewise-linear approximation, $\\widehat{COP}_{\\text{eff}}(T_s, \\lambda)$, is constructed by connecting successive points $(T_i, COP_{\\text{eff}}(T_i, \\lambda))$ on the function's graph with straight line segments (chords). A fundamental property of convex functions is that any chord connecting two points on the function's graph lies on or above the graph of the function between those two points. This guarantees that $\\widehat{COP}_{\\text{eff}}(T_s, \\lambda) \\ge COP_{\\text{eff}}(T_s, \\lambda)$ for all $T_s \\in [T_{\\min}, T_{\\max}]$, meaning the approximation is indeed an upper bound. This property is also verified numerically as requested.\n\nThe solution proceeds as follows:\n\n**1. Maximum Absolute Approximation Error, $E_{\\text{abs}}$**\n\nThe absolute error is $E(T_s) = \\widehat{COP}_{\\text{eff}}(T_s, \\lambda) - COP_{\\text{eff}}(T_s, \\lambda)$. Due to convexity, the maximum error in any segment $[T_i, T_{i+1}]$ occurs where the slope of the function equals the slope of the approximation chord. The slope of the chord is:\n$$\nm_i = \\frac{COP_{\\text{eff}}(T_{i+1}, \\lambda) - COP_{\\text{eff}}(T_i, \\lambda)}{T_{i+1} - T_i}\n$$\nWe seek the point $T_s^*$ where $\\frac{d}{dT_s} COP_{\\text{eff}}(T_s, \\lambda) = m_i$.\n$$\n\\phi(\\lambda) \\left[ \\frac{\\eta_0 T_h}{(T_h - T_s)^2} + \\beta \\right] = \\phi(\\lambda) \\left[ \\frac{COP(T_{i+1}) - COP(T_i)}{T_{i+1} - T_i} \\right]\n$$\nLetting $m_i^{\\text{cop}} = \\frac{COP(T_{i+1}) - COP(T_i)}{T_{i+1} - T_i}$, we can simplify and solve for $T_s$:\n$$\n\\frac{\\eta_0 T_h}{(T_h - T_s)^2} + \\beta = m_i^{\\text{cop}} \\implies (T_h - T_s)^2 = \\frac{\\eta_0 T_h}{m_i^{\\text{cop}} - \\beta}\n$$\nSince $T_s < T_h$, we take the positive root for $(T_h - T_s)$:\n$$\nT_s^* = T_h - \\sqrt{\\frac{\\eta_0 T_h}{m_i^{\\text{cop}} - \\beta}}\n$$\nThis analytical solution gives the location of maximum absolute error within each segment $[T_i, T_{i+1}]$. We compute the error $E(T_s^*)$ for each segment and take the maximum among them to find the overall $E_{\\text{abs}}$.\n\n**2. Maximum Relative Approximation Error, $E_{\\text{rel}}$**\n\nThe relative error is $E_{\\text{rel}}(T_s) = \\frac{\\widehat{COP}_{\\text{eff}}(T_s, \\lambda) - COP_{\\text{eff}}(T_s, \\lambda)}{COP_{\\text{eff}}(T_s, \\lambda)}$. Finding the maximum of this function analytically is significantly more complex. Therefore, a robust numerical approach is chosen. For each segment $[T_i, T_{i+1}]$, a bounded scalar optimization routine is used to find the maximum value of $E_{\\text{rel}}(T_s)$. The overall $E_{\\text{rel}}$ is the maximum of these values over all segments.\n\n**3. Algorithmic Implementation**\n\nFor each test case:\n- The parameters $(T_h, T_{\\min}, T_{\\max}, \\eta_0, \\beta, \\gamma, \\lambda, N)$ are defined.\n- $N$ equally spaced breakpoints $T_0, \\dots, T_{N-1}$ are generated on $[T_{\\min}, T_{\\max}]$.\n- The values of $COP_{\\text{eff}}(T_i, \\lambda)$ are computed at each breakpoint. This defines the piecewise-linear function $\\widehat{COP}_{\\text{eff}}(T_s, \\lambda)$, which can be evaluated efficiently using linear interpolation.\n- For each of the $N-1$ intervals $[T_i, T_{i+1}]$:\n  a. The location of maximum absolute error, $T_s^*$, is computed analytically. The absolute error $E(T_s^*)$ is then calculated.\n  b. The maximum relative error is found using `scipy.optimize.minimize_scalar` on the negative of the relative error function, bounded within the interval.\n- The maximum absolute and relative errors found across all intervals are recorded as $E_{\\text{abs}}$ and $E_{\\text{rel}}$.\n- The upper-bound property is verified by evaluating the error $E(T_s)$ on a dense grid of $10,000$ points in $[T_{\\min}, T_{\\max}]$ and confirming that all values are non-negative within a small floating-point tolerance. The result is stored as a boolean.\n- The final result for the test case is compiled into a list: $[E_{\\text{abs}}, E_{\\text{rel}}, \\text{is\\_upper\\_bound}]$.",
            "answer": "```python\nimport numpy as np\nfrom scipy.optimize import minimize_scalar\n\ndef solve():\n    \"\"\"\n    Constructs a convex piecewise-linear upper approximation for a heat pump's\n    Coefficient of Performance (COP) and computes approximation errors.\n    \"\"\"\n    test_cases = [\n        # Case A (general case)\n        # Th, Tmin, Tmax, eta0, beta, gamma, lambda, N\n        (323.15, 273.15, 313.15, 0.35, 0.02, 0.20, 0.70, 7),\n        # Case B (boundary near high source temperature)\n        (330.00, 300.00, 320.00, 0.35, 0.015, 0.20, 0.30, 5),\n        # Case C (low source temperature edge)\n        (310.00, 260.00, 300.00, 0.32, 0.02, 0.20, 0.95, 9),\n    ]\n\n    all_results = []\n    for case in test_cases:\n        Th, Tmin, Tmax, eta0, beta, gamma, lambda_val, N = case\n\n        # 1. Define COP and related functions\n        def cop_func(Ts):\n            # Ensure Ts is not equal to Th to avoid division by zero\n            delta_T = Th - Ts\n            # Handle array and scalar inputs\n            if isinstance(delta_T, np.ndarray):\n                delta_T[delta_T == 0] = 1e-12\n            elif delta_T == 0:\n                delta_T = 1e-12\n            return eta0 * Th / delta_T - beta * delta_T\n\n        phi = 1.0 - gamma * (1.0 - lambda_val)\n\n        def cop_eff_func(Ts):\n            return phi * cop_func(Ts)\n\n        # 2. Generate breakpoints for the piecewise-linear approximation\n        T_nodes = np.linspace(Tmin, Tmax, N)\n        cop_eff_nodes = cop_eff_func(T_nodes)\n\n        # 3. Define the piecewise-linear approximation function\n        def cop_hat_eff_func(Ts):\n            return np.interp(Ts, T_nodes, cop_eff_nodes)\n\n        max_abs_error = 0.0\n        max_rel_error = 0.0\n\n        # 4. Iterate over segments to find maximum errors\n        for i in range(N - 1):\n            T_i, T_i_plus_1 = T_nodes[i], T_nodes[i + 1]\n            \n            # --- Absolute Error Calculation (Analytical) ---\n            cop_T_i = cop_func(T_i)\n            cop_T_i_plus_1 = cop_func(T_i_plus_1)\n            \n            m_i_cop = (cop_T_i_plus_1 - cop_T_i) / (T_i_plus_1 - T_i)\n            \n            denominator = m_i_cop - beta\n            if denominator > 1e-12: # Check to avoid sqrt of negative or division by zero\n                numerator = eta0 * Th\n                Ts_star = Th - np.sqrt(numerator / denominator)\n\n                # Check if the extremum is within the current interval\n                if T_i < Ts_star < T_i_plus_1:\n                    error = cop_hat_eff_func(Ts_star) - cop_eff_func(Ts_star)\n                    if error > max_abs_error:\n                        max_abs_error = error\n\n            # --- Relative Error Calculation (Numerical) ---\n            def neg_rel_error_func(Ts_scalar):\n                approx_val = cop_hat_eff_func(Ts_scalar)\n                true_val = cop_eff_func(Ts_scalar)\n                if abs(true_val) < 1e-12:\n                    return 0.0\n                return -((approx_val - true_val) / true_val)\n            \n            res = minimize_scalar(\n                neg_rel_error_func,\n                bounds=(T_i, T_i_plus_1),\n                method='bounded'\n            )\n            \n            current_max_rel_error = -res.fun\n            if current_max_rel_error > max_rel_error:\n                max_rel_error = current_max_rel_error\n\n        # 5. Verify the upper-bound property on a dense grid\n        dense_grid = np.linspace(Tmin, Tmax, 10000)\n        errors = cop_hat_eff_func(dense_grid) - cop_eff_func(dense_grid)\n        is_upper_bound = bool(np.all(errors >= -1e-9))\n\n        # 6. Store results for the current case\n        all_results.append([max_abs_error, max_rel_error, is_upper_bound])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, all_results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Real-world energy system management involves making significant operational and investment decisions in the face of uncertainty about future prices, demand, and resource availability. This final practice introduces you to this challenge through the lens of two-stage stochastic optimization. You will determine the optimal on/off commitment for a Combined Heat and Power (CHP) unit before the future scenario is known, balancing upfront costs against expected operational savings . This exercise provides direct experience with formulating and solving a stochastic programming problem, a powerful and indispensable tool for robust decision-making in modern, sector-coupled energy systems.",
            "id": "4122248",
            "problem": "Consider a single-period multi-energy hub that couples electricity and heat through a Combined Heat and Power (CHP) unit. The hub faces two demand-price scenarios with probabilities $p_1 = 0.6$ and $p_2 = 0.4$. The first-stage decision is the binary on/off commitment of the CHP unit, denoted by $y \\in \\{0,1\\}$, chosen before the scenario is realized. In each scenario $s \\in \\{1,2\\}$, the recourse decisions dispatch the hubâ€™s components to satisfy electricity and heat demands. The goal is to minimize the total expected cost, which is the probability-weighted sum of scenario-specific operating costs plus the first-stage startup cost if applicable.\n\nFundamental base and physical realism:\n- By the First Law of Energy Conservation, the energy balances must hold in each scenario: the sum of supplied electricity equals the electricity demand, and the sum of supplied heat equals the heat demand.\n- The CHP unit converts fuel into electricity and heat at fixed conversion efficiencies. Let $f_s$ be the fuel input in scenario $s$, with electricity output $e_s = \\eta_e f_s$ and heat output $h_s = \\eta_h f_s$, where $\\eta_e \\in (0,1)$ and $\\eta_h \\in (0,1)$ are given.\n- Non-CHP supplies are electricity purchased from the grid and heat produced by a boiler. Grid electricity and boiler heat are purchased at given scenario-dependent prices.\n- CHP has a maximum fuel input capacity $F^{\\max}$, which is enforceable only if $y=1$; i.e., $0 \\le f_s \\le F^{\\max} y$.\n- Startup cost is incurred if and only if $y=1$ and the previous commitment state was off.\n\nScenario-wise constraints for each $s \\in \\{1,2\\}$:\n- Electricity balance: $\\eta_e f_s + g_s = D^e_s$, where $g_s \\ge 0$ is electricity purchased from the grid and $D^e_s$ is the electricity demand.\n- Heat balance: $\\eta_h f_s + b_s = D^h_s$, where $b_s \\ge 0$ is heat produced by the boiler and $D^h_s$ is the heat demand.\n- CHP fuel input bound: $0 \\le f_s \\le F^{\\max} y$.\n- Nonnegativity: $g_s \\ge 0$, $b_s \\ge 0$, $f_s \\ge 0$.\n\nScenario-wise operating cost in each $s$ is the sum of purchases and fuel:\n- Grid electricity: $c^e_s$ dollars per megawatt-hour electricity, so cost $c^e_s g_s$.\n- Boiler heat: $c^b_s$ dollars per megawatt-hour thermal, so cost $c^b_s b_s$.\n- CHP fuel: $c^{f}$ dollars per megawatt-hour fuel, so cost $c^{f} f_s$.\n\nTotal expected cost is $\\sum_{s=1}^2 p_s \\cdot \\left(c^e_s g_s + c^b_s b_s + c^{f} f_s\\right)$ plus startup cost $c^{su}$ if $y=1$ and $y^{prev}=0$, otherwise zero.\n\nAll physical quantities must use the specified units:\n- Electricity demand $D^e_s$ in megawatt-hours ($\\mathrm{MWh}$).\n- Heat demand $D^h_s$ in megawatt-hours thermal ($\\mathrm{MWh_{th}}$).\n- Fuel input $f_s$ in megawatt-hours fuel ($\\mathrm{MWh_{fuel}}$).\n- Prices $c^e_s$, $c^b_s$ in dollars per megawatt-hour ($\\$/\\mathrm{MWh}$), $c^{f}$ in dollars per megawatt-hour fuel ($\\$/\\mathrm{MWh_{fuel}}$).\n- Efficiencies $\\eta_e$, $\\eta_h$ are dimensionless.\n\nYour task is to compute the optimal first-stage commitment $y \\in \\{0,1\\}$ that minimizes the total expected cost for each parameter set below. For each parameter set, the program must:\n- Treat $p_1 = 0.6$ and $p_2 = 0.4$.\n- Use the given $y^{prev}$, $F^{\\max}$, $c^{su}$, $c^{f}$, $\\eta_e$, $\\eta_h$, and scenario data $\\{D^e_s, D^h_s, c^e_s, c^b_s\\}_{s=1,2}$.\n- Solve the recourse dispatch problem under each scenario for both $y=0$ and $y=1$, respecting all constraints.\n- Compute the total expected cost for $y=0$ and $y=1$ by summing scenario costs weighted by $p_s$ and adding startup cost if applicable.\n- Select the $y$ that yields the lower expected cost. In case of exact equality, choose $y=0$.\n\nTest suite (five parameter sets):\n- Case $1$ (happy path, beneficial CHP in both scenarios):\n    - $y^{prev} = 0$, $F^{\\max} = 100$, $c^{su} = 500$, $c^{f} = 35$, $\\eta_e = 0.35$, $\\eta_h = 0.45$.\n    - Scenario $1$: $D^e_1 = 60$, $D^h_1 = 70$, $c^e_1 = 110$, $c^b_1 = 50$.\n    - Scenario $2$: $D^e_2 = 40$, $D^h_2 = 30$, $c^e_2 = 90$, $c^b_2 = 40$.\n- Case $2$ (low prices, high startup, CHP never used):\n    - $y^{prev} = 0$, $F^{\\max} = 100$, $c^{su} = 3000$, $c^{f} = 50$, $\\eta_e = 0.35$, $\\eta_h = 0.45$.\n    - Scenario $1$: $D^e_1 = 40$, $D^h_1 = 30$, $c^e_1 = 70$, $c^b_1 = 30$.\n    - Scenario $2$: $D^e_2 = 40$, $D^h_2 = 30$, $c^e_2 = 60$, $c^b_2 = 25$.\n- Case $3$ (previously on, beneficial in one scenario):\n    - $y^{prev} = 1$, $F^{\\max} = 50$, $c^{su} = 1000$, $c^{f} = 45$, $\\eta_e = 0.35$, $\\eta_h = 0.45$.\n    - Scenario $1$: $D^e_1 = 50$, $D^h_1 = 20$, $c^e_1 = 120$, $c^b_1 = 70$.\n    - Scenario $2$: $D^e_2 = 30$, $D^h_2 = 30$, $c^e_2 = 50$, $c^b_2 = 20$.\n- Case $4$ (heat demand caps CHP use; savings below startup):\n    - $y^{prev} = 0$, $F^{\\max} = 1000$, $c^{su} = 1500$, $c^{f} = 35$, $\\eta_e = 0.35$, $\\eta_h = 0.45$.\n    - Scenario $1$: $D^e_1 = 200$, $D^h_1 = 10$, $c^e_1 = 130$, $c^b_1 = 30$.\n    - Scenario $2$: $D^e_2 = 100$, $D^h_2 = 5$, $c^e_2 = 90$, $c^b_2 = 30$.\n- Case $5$ (capacity-limited, savings exceed startup):\n    - $y^{prev} = 0$, $F^{\\max} = 10$, $c^{su} = 200$, $c^{f} = 35$, $\\eta_e = 0.35$, $\\eta_h = 0.45$.\n    - Scenario $1$: $D^e_1 = 30$, $D^h_1 = 30$, $c^e_1 = 100$, $c^b_1 = 60$.\n    - Scenario $2$: $D^e_2 = 35$, $D^h_2 = 25$, $c^e_2 = 80$, $c^b_2 = 50$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with one integer per case indicating the optimal $y$ (where $0$ denotes off and $1$ denotes on). For example: $[y_1,y_2,y_3,y_4,y_5]$.",
            "solution": "The problem is a two-stage stochastic optimization problem for a multi-energy hub. The objective is to determine the optimal first-stage commitment decision for a Combined Heat and Power (CHP) unit, denoted by the binary variable $y \\in \\{0, 1\\}$, to minimize the total expected cost over two possible future scenarios, $s \\in \\{1, 2\\}$.\n\nThe total expected cost, $C(y)$, is the sum of a first-stage cost and the expected value of the second-stage (recourse) costs. The first-stage cost is the startup cost, $C^{su}$, which is incurred if and only if the CHP is turned on ($y=1$) from an off state ($y^{prev}=0$). The second-stage cost is the operating cost in each scenario, which depends on the dispatch of the hub's assets.\n\nThe total expected cost can be formulated as:\n$$\nC(y) = C_{\\text{startup}}(y, y^{prev}) + \\sum_{s=1}^{2} p_s \\cdot C_{\\text{op}, s}(y)\n$$\nwhere $C_{\\text{startup}}(y, y^{prev}) = c^{su} \\cdot y \\cdot (1 - y^{prev})$ is the startup cost, $p_s$ is the probability of scenario $s$, and $C_{\\text{op}, s}(y)$ is the minimum operating cost in scenario $s$ for a given commitment $y$.\n\nOur task is to compute $C(0)$ and $C(1)$ and select the value of $y$ that yields the minimum cost. If $C(0) = C(1)$, we select $y=0$.\n\n### Analysis for Commitment $y=0$ (CHP Off)\nIf the CHP unit is not committed, its fuel consumption $f_s$ must be zero for both scenarios ($f_s=0$). The energy balance constraints become:\n- Electricity: $g_s = D^e_s$\n- Heat: $b_s = D^h_s$\nThis means all electricity demand $D^e_s$ must be met by purchasing from the grid, and all heat demand $D^h_s$ must be met by the boiler.\nThe operating cost in scenario $s$ for $y=0$ is therefore fixed:\n$$\nC_{\\text{op}, s}(0) = c^e_s D^e_s + c^b_s D^h_s\n$$\nThe startup cost is $C_{\\text{startup}}(0, y^{prev}) = 0$.\nThe total expected cost for $y=0$ is the baseline cost against which we evaluate the decision to run the CHP:\n$$\nC(0) = p_1 (c^e_1 D^e_1 + c^b_1 D^h_1) + p_2 (c^e_2 D^e_2 + c^b_2 D^h_2)\n$$\n\n### Analysis for Commitment $y=1$ (CHP On)\nIf the CHP unit is committed, we must solve a recourse optimization problem for each scenario $s$ to find the optimal dispatch and the corresponding minimum operating cost, $C_{\\text{op}, s}(1)$.\n\nFor a given scenario $s$, the objective is to minimize the operating cost:\n$$\n\\min_{f_s, g_s, b_s} \\left( c^{f} f_s + c^e_s g_s + c^b_s b_s \\right)\n$$\nsubject to the constraints:\n1. $\\eta_e f_s + g_s = D^e_s$ (Electricity balance)\n2. $\\eta_h f_s + b_s = D^h_s$ (Heat balance)\n3. $0 \\le f_s \\le F^{\\max}$ (CHP capacity, since $y=1$)\n4. $g_s \\ge 0, b_s \\ge 0$ (Non-negativity of purchases)\n\nWe can express the purchased electricity $g_s$ and heat $b_s$ as functions of the CHP fuel input $f_s$ using the balance equations:\n$g_s = D^e_s - \\eta_e f_s$\n$b_s = D^h_s - \\eta_h f_s$\n\nSubstituting these into the cost function allows us to express it solely in terms of $f_s$:\n$$\nC_{\\text{op}, s}(f_s) = c^{f} f_s + c^e_s (D^e_s - \\eta_e f_s) + c^b_s (D^h_s - \\eta_h f_s)\n$$\nRearranging the terms:\n$$\nC_{\\text{op}, s}(f_s) = (c^e_s D^e_s + c^b_s D^h_s) + (c^{f} - c^e_s \\eta_e - c^b_s \\eta_h) f_s\n$$\nThe first term, $(c^e_s D^e_s + c^b_s D^h_s)$, is precisely the operating cost if the CHP is off, $C_{\\text{op}, s}(0)$. Let $\\Delta_s = c^e_s \\eta_e + c^b_s \\eta_h - c^{f}$ be the marginal economic value of using $1 \\, \\mathrm{MWh_{fuel}}$ in the CHP. A positive $\\Delta_s$ means that the value of the electricity and heat produced by the CHP exceeds the cost of the fuel required. The cost function simplifies to:\n$$\nC_{\\text{op}, s}(f_s) = C_{\\text{op}, s}(0) - \\Delta_s f_s\n$$\nTo minimize this cost, our strategy for choosing the optimal fuel input, $f_s^*$, is clear:\n- If $\\Delta_s > 0$, we should make $f_s$ as large as possible.\n- If $\\Delta_s \\le 0$, it is not economical to run the CHP, so we should make $f_s$ as small as possible, which is $f_s=0$.\n\nThe feasible range for $f_s$ must satisfy all constraints. The constraints $g_s \\ge 0$ and $b_s \\ge 0$ translate to upper bounds on $f_s$:\n- $D^e_s - \\eta_e f_s \\ge 0 \\implies f_s \\le D^e_s / \\eta_e$\n- $D^h_s - \\eta_h f_s \\ge 0 \\implies f_s \\le D^h_s / \\eta_h$\nCombining these with the CHP capacity constraint ($f_s \\le F^{\\max}$) and non-negativity ($f_s \\ge 0$), the feasible range for $f_s$ is:\n$$\n0 \\le f_s \\le \\min\\left( F^{\\max}, \\frac{D^e_s}{\\eta_e}, \\frac{D^h_s}{\\eta_h} \\right)\n$$\nLet's call this upper bound $f_{s, \\text{max-feasible}}$. The optimal fuel dispatch $f_s^*$ is:\n$$\nf_s^* =\n\\begin{cases}\nf_{s, \\text{max-feasible}} & \\text{if } \\Delta_s > 0 \\\\\n0 & \\text{if } \\Delta_s \\le 0\n\\end{cases}\n$$\nThe minimum operating cost for scenario $s$ with $y=1$ is then $C_{\\text{op}, s}(1) = C_{\\text{op}, s}(0) - \\Delta_s f_s^*$. Note that if $\\Delta_s \\le 0$, then $f_s^*=0$ and $C_{\\text{op}, s}(1) = C_{\\text{op}, s}(0)$.\n\nThe total expected cost for $y=1$ is computed by summing the startup cost and the probability-weighted optimal operating costs for each scenario:\n$$\nC(1) = C_{\\text{startup}}(1, y^{prev}) + \\sum_{s=1}^{2} p_s \\cdot C_{\\text{op}, s}(1)\n$$\n$$\nC(1) = c^{su} \\cdot (1 - y^{prev}) + \\sum_{s=1}^{2} p_s \\cdot (C_{\\text{op}, s}(0) - \\Delta_s f_s^*)\n$$\n\n### Final Decision\nThe optimal first-stage decision is found by comparing the total expected costs:\n- If $C(1) < C(0)$, the optimal decision is $y_{opt} = 1$.\n- Otherwise (if $C(1) \\ge C(0)$), the optimal decision is $y_{opt} = 0$.\n\nThis completes the logical procedure for solving the problem for any given set of parameters.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the two-stage stochastic energy hub commitment problem for a series of test cases.\n    \"\"\"\n    \n    test_cases = [\n        # Case 1 (happy path, beneficial CHP in both scenarios)\n        {\n            \"params\": {\"y_prev\": 0, \"F_max\": 100, \"c_su\": 500, \"c_f\": 35, \"eta_e\": 0.35, \"eta_h\": 0.45},\n            \"s1\": {\"D_e\": 60, \"D_h\": 70, \"c_e\": 110, \"c_b\": 50},\n            \"s2\": {\"D_e\": 40, \"D_h\": 30, \"c_e\": 90, \"c_b\": 40},\n        },\n        # Case 2 (low prices, high startup, CHP never used)\n        {\n            \"params\": {\"y_prev\": 0, \"F_max\": 100, \"c_su\": 3000, \"c_f\": 50, \"eta_e\": 0.35, \"eta_h\": 0.45},\n            \"s1\": {\"D_e\": 40, \"D_h\": 30, \"c_e\": 70, \"c_b\": 30},\n            \"s2\": {\"D_e\": 40, \"D_h\": 30, \"c_e\": 60, \"c_b\": 25},\n        },\n        # Case 3 (previously on, beneficial in one scenario)\n        {\n            \"params\": {\"y_prev\": 1, \"F_max\": 50, \"c_su\": 1000, \"c_f\": 45, \"eta_e\": 0.35, \"eta_h\": 0.45},\n            \"s1\": {\"D_e\": 50, \"D_h\": 20, \"c_e\": 120, \"c_b\": 70},\n            \"s2\": {\"D_e\": 30, \"D_h\": 30, \"c_e\": 50, \"c_b\": 20},\n        },\n        # Case 4 (heat demand caps CHP use; savings below startup)\n        {\n            \"params\": {\"y_prev\": 0, \"F_max\": 1000, \"c_su\": 1500, \"c_f\": 35, \"eta_e\": 0.35, \"eta_h\": 0.45},\n            \"s1\": {\"D_e\": 200, \"D_h\": 10, \"c_e\": 130, \"c_b\": 30},\n            \"s2\": {\"D_e\": 100, \"D_h\": 5, \"c_e\": 90, \"c_b\": 30},\n        },\n        # Case 5 (capacity-limited, savings exceed startup)\n        {\n            \"params\": {\"y_prev\": 0, \"F_max\": 10, \"c_su\": 200, \"c_f\": 35, \"eta_e\": 0.35, \"eta_h\": 0.45},\n            \"s1\": {\"D_e\": 30, \"D_h\": 30, \"c_e\": 100, \"c_b\": 60},\n            \"s2\": {\"D_e\": 35, \"D_h\": 25, \"c_e\": 80, \"c_b\": 50},\n        },\n    ]\n\n    p1, p2 = 0.6, 0.4\n    results = []\n\n    for case in test_cases:\n        params = case[\"params\"]\n        s1 = case[\"s1\"]\n        s2 = case[\"s2\"]\n\n        # --- Calculate Total Expected Cost for y = 0 ---\n        # No startup cost for y=0.\n        # Operating cost is simply satisfying all demand from grid/boiler.\n        op_cost_s1_y0 = s1[\"c_e\"] * s1[\"D_e\"] + s1[\"c_b\"] * s1[\"D_h\"]\n        op_cost_s2_y0 = s2[\"c_e\"] * s2[\"D_e\"] + s2[\"c_b\"] * s2[\"D_h\"]\n        cost_y0 = p1 * op_cost_s1_y0 + p2 * op_cost_s2_y0\n\n        # --- Calculate Total Expected Cost for y = 1 ---\n        # Calculate startup cost for y=1\n        startup_cost_y1 = params[\"c_su\"] * 1 * (1 - params[\"y_prev\"])\n\n        # Calculate recourse (operating) cost for scenario 1 with y=1\n        delta_s1 = s1[\"c_e\"] * params[\"eta_e\"] + s1[\"c_b\"] * params[\"eta_h\"] - params[\"c_f\"]\n        f_star_s1 = 0\n        if delta_s1 > 0:\n            f_max_feasible_s1 = np.min([\n                params[\"F_max\"],\n                s1[\"D_e\"] / params[\"eta_e\"],\n                s1[\"D_h\"] / params[\"eta_h\"]\n            ])\n            f_star_s1 = f_max_feasible_s1\n        \n        op_cost_s1_y1 = op_cost_s1_y0 - delta_s1 * f_star_s1\n\n        # Calculate recourse (operating) cost for scenario 2 with y=1\n        delta_s2 = s2[\"c_e\"] * params[\"eta_e\"] + s2[\"c_b\"] * params[\"eta_h\"] - params[\"c_f\"]\n        f_star_s2 = 0\n        if delta_s2 > 0:\n            f_max_feasible_s2 = np.min([\n                params[\"F_max\"],\n                s2[\"D_e\"] / params[\"eta_e\"],\n                s2[\"D_h\"] / params[\"eta_h\"]\n            ])\n            f_star_s2 = f_max_feasible_s2\n\n        op_cost_s2_y1 = op_cost_s2_y0 - delta_s2 * f_star_s2\n\n        expected_op_cost_y1 = p1 * op_cost_s1_y1 + p2 * op_cost_s2_y1\n        cost_y1 = startup_cost_y1 + expected_op_cost_y1\n\n        # --- Decision ---\n        # Choose y that yields lower cost. In case of equality, choose y=0.\n        optimal_y = 1 if cost_y1 < cost_y0 else 0\n        results.append(optimal_y)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}