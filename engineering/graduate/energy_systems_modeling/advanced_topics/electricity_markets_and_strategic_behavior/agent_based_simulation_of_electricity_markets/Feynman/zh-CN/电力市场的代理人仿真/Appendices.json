{
    "hands_on_practices": [
        {
            "introduction": "现实世界的电力运营和基于智能体的模型通常涉及多个市场阶段，例如日前市场和实时市场。本练习探讨了一个智能体在其实际出力偏离其日前计划时所面临的财务后果。理解不平衡结算机制对于模拟智能体的风险偏好和预测误差至关重要。",
            "id": "4069020",
            "problem": "考虑一个发电机代理参与双结算电力市场的基于代理的模型，该市场包括日前市场 (DAM) 和实时市场 (RTM)。在双结算设计中，适用以下基本定义：DAM 以日前价格结算计划发电量，而 RTM 则以实时价格结算实际发电量与日前计划之间的任何偏差。此外，假设系统运营商施加与偏差绝对值成正比的线性偏差惩罚。假设单个结算周期的时长为 $\\Delta t = 1$ 小时，因此在该周期内，以兆瓦为单位的功率在数值上对应于以兆瓦时为单位的能量。\n\n一个发电机代理在日前市场承诺了 $q^{DA} = 50$ 兆瓦的电量，并在实时产生了 $q = 45$ 兆瓦的电量。日前价格为 $\\pi^{DA} = 30$ 美元/兆瓦时，实时价格为 $\\pi^{RT} = 60$ 美元/兆瓦时。对偏差绝对值处以费率为 $\\gamma = 5$ 美元/兆瓦时的偏差惩罚。\n\n仅使用双结算设计和线性偏差惩罚的定义，通过结合计划电量的日前结算、偏差的实时不平衡结算以及偏差惩罚，推导出净货币收益。将最终的净货币收益以美元表示为一个实数。无需进行四舍五入。",
            "solution": "问题要求计算在给定一组电量、价格和惩罚费率的情况下，参与双结算电力市场的发电机的净货币收益。首先，评估问题陈述的有效性。\n\n### 步骤1：提取已知条件\n问题陈述中提供的数据如下：\n-   日前计划电量：$q^{DA} = 50$ 兆瓦。\n-   实时发电量：$q = 45$ 兆瓦。\n-   日前市场价格：$\\pi^{DA} = 30$ 美元/兆瓦时。\n-   实时市场价格：$\\pi^{RT} = 60$ 美元/兆瓦时。\n-   偏差惩罚费率：$\\gamma = 5$ 美元/兆瓦时。\n-   结算周期时长：$\\Delta t = 1$ 小时。\n\n问题还定义了结算机制：\n1.  日前市场 (DAM) 以日前价格 $\\pi^{DA}$ 结算计划电量 $q^{DA}$。\n2.  实时市场 (RTM) 以实时价格 $\\pi^{RT}$ 结算与计划的偏差，定义为 $q - q^{DA}$。\n3.  对偏差的绝对值 $|q - q^{DA}|$ 施加费率为 $\\gamma$ 的线性偏差惩罚。\n\n### 步骤2：使用提取的已知条件进行验证\n该问题具有科学依据，因为带有不平衡惩罚的双结算市场模型是电力系统经济学和能源系统建模中的一个标准和基本概念。该问题提法恰当；它提供了计算唯一货币收益所需的所有数据和定义。语言客观、精确。所提供的数值对于电力市场运营是合理的。问题是自洽的，没有矛盾或缺失信息。因此，该问题被认为是有效的。\n\n### 步骤3：求解推导\n净货币收益，记为 $M_{net}$，是所述三个组成部分现金流的总和：日前结算、实时不平衡结算和偏差惩罚。结算周期时长为 $\\Delta t = 1$ 小时，这意味着以兆瓦 (MW) 为单位的功率值在数值上等同于以兆瓦时 (MWh) 为单位的能量值。\n\n1.  **日前市场 (DAM) 结算：** 发电机因其计划电量 $q^{DA}$ 而以日前价格 $\\pi^{DA}$ 获得报酬。这是一笔收入。\n    $$M_{DA} = q^{DA} \\times \\pi^{DA}$$\n\n2.  **实时市场 (RTM) 不平衡结算：** 发电机与其计划的偏差为 $\\Delta q = q - q^{DA}$。此不平衡量以实时价格 $\\pi^{RT}$ 进行结算。如果偏差为负（发电不足），此结算代表一笔成本，因为发电机必须以实时价格有效地购回缺额。如果偏差为正（发电过剩），则代表出售多余能量带来的额外收入。\n    $$M_{RT} = (q - q^{DA}) \\times \\pi^{RT}$$\n\n3.  **偏差惩罚结算：** 对偏差的绝对值 $|q - q^{DA}|$ 按指定费率 $\\gamma$ 处以惩罚。这对发电机来说总是一项成本。\n    $$M_{penalty} = - \\gamma \\times |q - q^{DA}|$$\n\n总净货币收益是这三个部分的代数和：\n$$M_{net} = M_{DA} + M_{RT} + M_{penalty}$$\n代入每个部分的表达式，得到净收益的通用公式：\n$$M_{net} = (q^{DA} \\times \\pi^{DA}) + ((q - q^{DA}) \\times \\pi^{RT}) - (\\gamma \\times |q - q^{DA}|)$$\n\n现在，我们将给定的数值代入此公式：\n-   $q^{DA} = 50$ MWh\n-   $q = 45$ MWh\n-   $\\pi^{DA} = 30$ $/MWh\n-   $\\pi^{RT} = 60$ $/MWh\n-   $\\gamma = 5$ $/MWh\n\n首先，计算偏差量 $\\Delta q$：\n$$\\Delta q = q - q^{DA} = 45 - 50 = -5 \\text{ MWh}$$\n绝对偏差为：\n$$|\\Delta q| = |45 - 50| = |-5| = 5 \\text{ MWh}$$\n\n现在，计算每个结算部分：\n1.  日前市场结算：\n    $$M_{DA} = 50 \\times 30 = 1500 \\text{ 美元}$$\n2.  实时市场不平衡结算：\n    $$M_{RT} = (-5) \\times 60 = -300 \\text{ 美元}$$\n3.  偏差惩罚：\n    $$M_{penalty} = - 5 \\times 5 = -25 \\text{ 美元}$$\n\n最后，净货币收益是这些值的总和：\n$$M_{net} = 1500 + (-300) + (-25)$$\n$$M_{net} = 1500 - 300 - 25 = 1175 \\text{ 美元}$$\n\n因此，该发电机的最终净货币收益为 1175 美元。",
            "answer": "$$\\boxed{1175}$$"
        },
        {
            "introduction": "基于智能体建模的真正威力在于模拟具有复杂、目标导向策略的智能体。本练习要求您通过线性规划实现一个利润最大化的储能智能体。这使我们从简单的反应式智能体过渡到主动的、优化的智能体，这对于研究储能对市场动态的影响等主题至关重要。",
            "id": "4068999",
            "problem": "考虑一个批发电力市场的基于代理的模型（ABM），其中单个储能代理在有限的时间范围内进行价格套利。该储能设备在以 $t \\in \\{0,1,\\dots,T-1\\}$ 为索引的 $T$ 个小时周期内运行，并观察到外生的市场价格 $p_t$，单位为美元/兆瓦时（$/MWh）。储能设备具有能量状态 $e_t$（单位：兆瓦时，MWh），能量容量为 $E_{\\max}$（单位：MWh），并选择非负的充电和放电行为 $u_t^{\\text{ch}}$ 和 $u_t^{\\text{dis}}$（单位：兆瓦时/小时，MWh/h），并受限于斜坡限制 $R^{\\text{ch}}$ 和 $R^{\\text{dis}}$（单位：兆瓦，MW），假设时间步长为一小时，因此 MW 等于 MWh/小时。往返效率为 $\\eta \\in (0,1]$，必须对称地分解为 $\\eta_{\\text{ch}} = \\sqrt{\\eta}$ 和 $\\eta_{\\text{dis}} = \\sqrt{\\eta}$，从而得到标准的线性电量平衡方程\n$$\ne_{t+1} = e_t + \\eta_{\\text{ch}}\\, u_t^{\\text{ch}} - \\frac{1}{\\eta_{\\text{dis}}}\\, u_t^{\\text{dis}},\n$$\n对于所有 $t \\in \\{0,1,\\dots,T-1\\}$，且 $0 \\le e_t \\le E_{\\max}$。充电时，储能设备支付每兆瓦时 $p_t$ 美元；放电时，则收入每兆瓦时 $p_t$ 美元。为避免人为的终端价值效应，施加中性约束 $e_T = e_0$，其中初始电量 $e_0$ 为给定值。假设不施加同时充放电的约束；在正电价下，这对最优性而言并非必要，线性规划将相应地选择 $u_t^{\\text{ch}}$ 和 $u_t^{\\text{dis}}$。单小时利润总和为\n$$\n\\Pi = \\sum_{t=0}^{T-1} \\big( p_t\\, u_t^{\\text{dis}} - p_t\\, u_t^{\\text{ch}} \\big),\n$$\n该利润必须在所有约束条件下最大化。决策变量为向量 $\\{u_t^{\\text{ch}}\\}_{t=0}^{T-1}$、$\\{u_t^{\\text{dis}}\\}_{t=0}^{T-1}$ 和 $\\{e_t\\}_{t=0}^{T}$，其边界为 $0 \\le u_t^{\\text{ch}} \\le R^{\\text{ch}}$、$0 \\le u_t^{\\text{dis}} \\le R^{\\text{dis}}$ 和 $0 \\le e_t \\le E_{\\max}$，其中 $e_0$ 为固定值，且 $e_T = e_0$。请用纯数学术语进行描述，并实现一个科学上真实且自洽的线性优化。用适当的单位表示所有物理量，并计算以美元 ($) 为单位的利润，四舍五入到小数点后两位。\n\n您的任务是实现一个完整的、可运行的程序，通过线性规划为以下测试套件解决这个带斜坡约束的储能套利问题。对于每个测试用例，程序必须计算以美元 ($) 为单位的最优利润 $\\Pi$，并四舍五入到小数点后两位。\n\n测试套件参数集（每个用例指定了 $T$、价格序列 $\\{p_t\\}$（单位：$/MWh）、$R^{\\text{ch}}$（单位：MW）、$R^{\\text{dis}}$（单位：MW）、往返效率 $\\eta$、能量容量 $E_{\\max}$（单位：MWh）和初始能量 $e_0$（单位：MWh）):\n- 用例 1（正常路径，提供缩略图）：$T = 4$，价格 $\\{30,10,50,40\\}$，$R^{\\text{ch}} = 25$，$R^{\\text{dis}} = 25$，$\\eta = 0.9$，$E_{\\max} = 50$，$e_0 = 0$。\n- 用例 2（容量约束）：$T = 4$，价格 $\\{30,10,50,40\\}$，$R^{\\text{ch}} = 25$，$R^{\\text{dis}} = 25$，$\\eta = 0.9$，$E_{\\max} = 25$，$e_0 = 0$。\n- 用例 3（因单调递减而无套利空间）：$T = 4$，价格 $\\{50,40,30,20\\}$，$R^{\\text{ch}} = 25$，$R^{\\text{dis}} = 25$，$\\eta = 0.9$，$E_{\\max} = 50$，$e_0 = 0$。\n- 用例 4（负价格利用）：$T = 4$，价格 $\\{10,-20,60,-10\\}$，$R^{\\text{ch}} = 25$，$R^{\\text{dis}} = 25$，$\\eta = 0.9$，$E_{\\max} = 50$，$e_0 = 0$。\n- 用例 5（边界情况，放电能力为零）：$T = 4$，价格 $\\{30,10,50,40\\}$，$R^{\\text{ch}} = 25$，$R^{\\text{dis}} = 0$，$\\eta = 0.9$，$E_{\\max} = 50$，$e_0 = 0$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如 $[result_1,result_2,\\dots]$），其中每个 $result_i$ 是对应测试用例计算出的最优利润，以美元 ($) 表示，并四舍五入到小数点后两位。",
            "solution": "用户提供的问题是一个形式良好且有科学依据的有限时间范围内的最优储能套利问题公式。该问题被构建为一个线性规划（LP），这是解决此类优化任务的标准且合适的方法。所有必要的参数、约束和目标函数都得到了清晰的定义，没有任何内部矛盾或违反物理原则的情况。该问题是有效的。\n\n任务是为一个在 $T$ 个周期的时间范围内运行的储能代理最大化其总利润 $\\Pi$。利润函数由下式给出：\n$$\n\\Pi = \\sum_{t=0}^{T-1} \\big( p_t\\, u_t^{\\text{dis}} - p_t\\, u_t^{\\text{ch}} \\big)\n$$\n其中 $p_t$ 是市场价格，$u_t^{\\text{ch}}$ 和 $u_t^{\\text{dis}}$ 分别是充电和放电行为。最大化 $\\Pi$ 等同于最小化 $-\\Pi$，这符合许多线性规划求解器的标准形式。\n$$\n\\min \\sum_{t=0}^{T-1} \\big( p_t\\, u_t^{\\text{ch}} - p_t\\, u_t^{\\text{dis}} \\big)\n$$\n该优化受到一系列线性约束的限制，这些约束控制着储能的物理和操作限制。\n\n为了解决这个问题，我们将问题表述为标准的LP形式：\n$$\n\\min_{\\mathbf{x}} \\mathbf{c}^T \\mathbf{x} \\quad \\text{subject to} \\quad \\mathbf{A}_{eq} \\mathbf{x} = \\mathbf{b}_{eq}, \\quad \\mathbf{l} \\le \\mathbf{x} \\le \\mathbf{u}\n$$\n\n首先，我们定义决策向量 $\\mathbf{x}$。该向量包含整个时间范围内的所有决策变量。一个合乎逻辑的安排是拼接充电行为、放电行为和能量状态：\n$$\n\\mathbf{x} = [u_0^{\\text{ch}}, \\dots, u_{T-1}^{\\text{ch}}, u_0^{\\text{dis}}, \\dots, u_{T-1}^{\\text{dis}}, e_1, \\dots, e_T]^T\n$$\n$t=0$ 时的能量状态 $e_0$ 是一个给定的参数，而不是变量。决策变量的总数为 $3T$。\n\n目标向量 $\\mathbf{c}$ 包含 $\\mathbf{x}$ 中每个变量的成本系数。基于最小化 $\\sum (p_t u_t^{\\text{ch}} - p_t u_t^{\\text{dis}})$ 的目标函数，大小为 $3T$ 的向量 $\\mathbf{c}$ 构建如下：\n- 对于变量 $u_t^{\\text{ch}}$（索引 $t=0, \\dots, T-1$）：系数为 $p_t$。\n- 对于变量 $u_t^{\\text{dis}}$（索引 $t=T, \\dots, 2T-1$）：系数为 $-p_t$。\n- 对于变量 $e_t$（索引 $t=2T, \\dots, 3T-1$）：系数为 $0$，因为能量状态本身不直接贡献于成本。\n$$\n\\mathbf{c}^T = [p_0, \\dots, p_{T-1}, -p_0, \\dots, -p_{T-1}, 0, \\dots, 0]\n$$\n\n等式约束 $\\mathbf{A}_{eq} \\mathbf{x} = \\mathbf{b}_{eq}$ 强制执行系统动态和终端条件。共有 $T+1$ 个此类约束。\n1.  **能量平衡（$T$ 个方程）：** 状态转移方程 $e_{t+1} = e_t + \\eta_{\\text{ch}}\\, u_t^{\\text{ch}} - \\frac{1}{\\eta_{\\text{dis}}}\\, u_t^{\\text{dis}}$ 必须对每个时间步 $t \\in \\{0, \\dots, T-1\\}$ 成立。当 $\\eta_{\\text{ch}} = \\eta_{\\text{dis}} = \\sqrt{\\eta}$ 时，我们可以将它们写成一个线性方程组。\n    - 对于 $t=0$：$e_1 = e_0 + \\sqrt{\\eta}\\, u_0^{\\text{ch}} - \\frac{1}{\\sqrt{\\eta}}\\, u_0^{\\text{dis}}$。 重新排列将变量放在左侧（LHS），常数 $e_0$ 放在右侧（RHS）：\n    $$\n    e_1 - \\sqrt{\\eta}\\, u_0^{\\text{ch}} + \\frac{1}{\\sqrt{\\eta}}\\, u_0^{\\text{dis}} = e_0\n    $$\n    - 对于 $t \\in \\{1, \\dots, T-1\\}$：$e_{t+1} = e_t + \\sqrt{\\eta}\\, u_t^{\\text{ch}} - \\frac{1}{\\sqrt{\\eta}}\\, u_t^{\\text{dis}}$。 重新排列后得到：\n    $$\n    e_{t+1} - e_t - \\sqrt{\\eta}\\, u_t^{\\text{ch}} + \\frac{1}{\\sqrt{\\eta}}\\, u_t^{\\text{dis}} = 0\n    $$\n2.  **终端状态（1 个方程）：** 中性约束 $e_T = e_0$ 确保不会通过在时间范围结束时耗尽储能来提取人为价值。这是对最终状态变量的直接线性等式约束。\n\n这 $T+1$ 个方程填充了矩阵 $\\mathbf{A}_{eq}$（大小为 $(T+1) \\times 3T$）和向量 $\\mathbf{b}_{eq}$（大小为 $T+1$）。\n\n最后，边界 $\\mathbf{l} \\le \\mathbf{x} \\le \\mathbf{u}$ 定义了每个决策变量的有效范围。\n- **充电行为：** 对于 $t \\in \\{0, \\dots, T-1\\}$，$0 \\le u_t^{\\text{ch}} \\le R^{\\text{ch}}$。\n- **放电行为：** 对于 $t \\in \\{0, \\dots, T-1\\}$，$0 \\le u_t^{\\text{dis}} \\le R^{\\text{dis}}$。\n- **能量状态：** 对于 $t \\in \\{1, \\dots, T\\}$，$0 \\le e_t \\le E_{\\max}$。\n\n当LP由 $(\\mathbf{c}, \\mathbf{A}_{eq}, \\mathbf{b}_{eq}, \\mathbf{l}, \\mathbf{u})$ 完全指定后，可以使用标准求解器（例如 `scipy.optimize.linprog`）来找到最优决策向量 $\\mathbf{x}^*$。从求解器得到的最优目标值将是 $-\\Pi^*$。因此，最大利润为 $\\Pi^* = -(\\mathbf{c}^T \\mathbf{x}^*)$。该实现将为每个测试用例构建这些矩阵和向量，并求解得到的LP以找到最大利润。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import linprog\n\ndef solve():\n    \"\"\"\n    Main function to solve the test suite for the storage arbitrage problem.\n    \"\"\"\n    test_cases = [\n        # Case 1: T=4, prices={30,10,50,40}, R_ch=25, R_dis=25, eta=0.9, E_max=50, e_0=0\n        (4, np.array([30, 10, 50, 40]), 25, 25, 0.9, 50, 0),\n        # Case 2: T=4, prices={30,10,50,40}, R_ch=25, R_dis=25, eta=0.9, E_max=25, e_0=0\n        (4, np.array([30, 10, 50, 40]), 25, 25, 0.9, 25, 0),\n        # Case 3: T=4, prices={50,40,30,20}, R_ch=25, R_dis=25, eta=0.9, E_max=50, e_0=0\n        (4, np.array([50, 40, 30, 20]), 25, 25, 0.9, 50, 0),\n        # Case 4: T=4, prices={10,-20,60,-10}, R_ch=25, R_dis=25, eta=0.9, E_max=50, e_0=0\n        (4, np.array([10, -20, 60, -10]), 25, 25, 0.9, 50, 0),\n        # Case 5: T=4, prices={30,10,50,40}, R_ch=25, R_dis=0, eta=0.9, E_max=50, e_0=0\n        (4, np.array([30, 10, 50, 40]), 25, 0, 0.9, 50, 0),\n    ]\n\n    results = []\n    for case in test_cases:\n        profit = solve_storage_lp(*case)\n        results.append(f\"{profit:.2f}\")\n\n    print(f\"[{','.join(results)}]\")\n\ndef solve_storage_lp(T, p, R_ch, R_dis, eta, E_max, e_0):\n    \"\"\"\n    Solves the storage arbitrage linear programming problem for a single case.\n\n    The decision vector x is structured as:\n    x = [u_ch_0, ..., u_ch_{T-1},  (T variables)\n         u_dis_0, ..., u_dis_{T-1}, (T variables)\n         e_1, ..., e_T]             (T variables)\n    Total variables = 3T.\n    \n    Args:\n        T (int): Number of time periods.\n        p (np.array): Price series for T periods.\n        R_ch (float): Charging ramp limit in MW.\n        R_dis (float): Discharging ramp limit in MW.\n        eta (float): Round-trip efficiency.\n        E_max (float): Energy capacity in MWh.\n        e_0 (float): Initial energy state in MWh.\n    \n    Returns:\n        float: Maximum profit in dollars.\n    \"\"\"\n    \n    # Symmetrical efficiency split\n    eta_ch = np.sqrt(eta)\n    eta_dis = np.sqrt(eta)\n\n    num_vars = 3 * T\n\n    # 1. Objective function vector c\n    # We want to maximize sum(p*u_dis - p*u_ch), which is equivalent to\n    # minimizing sum(p*u_ch - p*u_dis).\n    c = np.zeros(num_vars)\n    c[0:T] = p  # Costs for charging\n    c[T:2*T] = -p # Revenues (negative costs) for discharging\n\n    # 2. Equality constraints matrix A_eq and vector b_eq\n    # T energy balance equations + 1 terminal state equation\n    A_eq = np.zeros((T + 1, num_vars))\n    b_eq = np.zeros(T + 1)\n\n    # Populate T energy balance equations: e_{t+1} - e_t - eta_ch*u_ch_t + (1/eta_dis)*u_dis_t = 0\n    for t in range(T):\n        # Coefficient for u_ch_t\n        A_eq[t, t] = -eta_ch\n        # Coefficient for u_dis_t\n        A_eq[t, T + t] = 1/eta_dis\n        \n        if t == 0:\n            # e_1 - eta_ch*u_ch_0 + (1/eta_dis)*u_dis_0 = e_0\n            # Coefficient for e_1\n            A_eq[t, 2*T] = 1\n            b_eq[t] = e_0\n        else:\n            # e_{t+1} - e_t - ... = 0\n            # Coefficient for e_{t+1}\n            A_eq[t, 2*T + t] = 1\n            # Coefficient for e_t\n            A_eq[t, 2*T + t - 1] = -1\n            b_eq[t] = 0\n\n    # Populate terminal state constraint: e_T = e_0\n    A_eq[T, 3*T - 1] = 1  # Coefficient for e_T\n    b_eq[T] = e_0\n\n    # 3. Bounds for variables (l = x = u)\n    u_ch_bounds = [(0, R_ch)] * T\n    u_dis_bounds = [(0, R_dis)] * T\n    e_bounds = [(0, E_max)] * T\n    bounds = u_ch_bounds + u_dis_bounds + e_bounds\n\n    # Solve the linear program\n    # The 'highs' method is robust and the default in recent SciPy versions.\n    res = linprog(c, A_eq=A_eq, b_eq=b_eq, bounds=bounds, method='highs')\n\n    if res.success:\n        # The solver minimizes the objective function. Profit is the negative of the result.\n        max_profit = -res.fun\n        return max_profit\n    else:\n        # If optimization fails, which it shouldn't for a feasible LP, return 0.\n        # This case suggests no profitable arbitrage is possible, or the problem is ill-formulated.\n        return 0.0\n\nif __name__ == \"__main__\":\n    solve()\n\n```"
        }
    ]
}