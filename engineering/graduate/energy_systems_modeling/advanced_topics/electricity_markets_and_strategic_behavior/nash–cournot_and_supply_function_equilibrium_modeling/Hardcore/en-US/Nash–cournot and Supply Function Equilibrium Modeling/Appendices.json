{
    "hands_on_practices": [
        {
            "introduction": "The Nash-Cournot model is a cornerstone of oligopoly theory and a fundamental tool for analyzing strategic interactions in markets with a few dominant firms, such as wholesale electricity markets. This first exercise guides you through deriving the symmetric N-firm Cournot equilibrium from foundational principles. By working through the profit-maximization problem for a representative firm, you will solidify your understanding of best-response functions and the logic of Nash equilibrium in quantities .",
            "id": "4106985",
            "problem": "Consider a stylized short-run wholesale electricity market with $N$ symmetric generating firms. Each firm $i \\in \\{1,\\dots,N\\}$ simultaneously chooses a nonnegative quantity $q_{i}$ to maximize profit, taking the quantities of all other firms as given, consistent with the definition of a Nash equilibrium. The inverse residual demand faced by the aggregate supply is $P(Q)=a-bQ$, where $Q=\\sum_{j=1}^{N}q_{j}$ is total output, $a>0$ is the intercept of the inverse demand, and $b>0$ is the slope coefficient. Each firm has constant marginal cost $c$ with total cost $C(q_{i})=cq_{i}$, with $0 \\leq c  a$, and there are no capacity constraints. Assume the market is cleared by a central system operator and firms compete in quantities in the sense of Cournot, rather than bidding supply functions as in a Supply Function Equilibrium (SFE).\n\nStarting only from the profit-maximization principle and the definition of Nash equilibrium in quantities (Cournot), and without invoking any shortcut formulas, derive closed-form expressions for:\n1. The per-firm symmetric Nash–Cournot equilibrium quantity $q^{*}$ as a function of $a$, $b$, $c$, and $N$.\n2. The resulting total equilibrium output $Q^{*}$.\n\nProvide your final answer as a single row matrix containing the two expressions $q^{*}$ and $Q^{*}$. No numerical approximation or rounding is required. No units need to be reported in the final answer.",
            "solution": "The problem is valid as it is a well-posed, scientifically grounded, and objective problem in microeconomic theory, specifically Cournot competition, which is a standard model in energy systems analysis. It provides all necessary information and contains no contradictions or ambiguities.\n\nWe begin by formalizing the profit-maximization problem for an arbitrary firm $i$. The profit for firm $i$, denoted by $\\pi_{i}$, is its total revenue minus its total cost. The total revenue is the market price $P(Q)$ multiplied by the firm's own output $q_{i}$. The total cost is given as $C(q_{i}) = cq_{i}$.\n\nThe profit function for firm $i$ is:\n$$ \\pi_{i}(q_{1}, q_{2}, \\dots, q_{N}) = P(Q)q_{i} - C(q_{i}) $$\nThe inverse demand function is $P(Q) = a - bQ$, where $Q$ is the total market output, defined as $Q = \\sum_{j=1}^{N} q_{j}$. We can express $Q$ as the sum of firm $i$'s output and the aggregate output of all other firms, $Q_{-i} = \\sum_{j \\neq i} q_{j}$. Thus, $Q = q_{i} + Q_{-i}$.\n\nSubstituting these expressions into the profit function, we get:\n$$ \\pi_{i}(q_{i}, Q_{-i}) = (a - b(q_{i} + Q_{-i}))q_{i} - cq_{i} $$\nExpanding this expression gives:\n$$ \\pi_{i}(q_{i}, Q_{-i}) = aq_{i} - bq_{i}^{2} - bQ_{-i}q_{i} - cq_{i} $$\n\nIn the Cournot model, each firm chooses its quantity $q_{i}$ to maximize its own profit, taking the quantities of all other firms ($Q_{-i}$) as fixed. To find the optimal quantity for firm $i$, we take the partial derivative of the profit function $\\pi_{i}$ with respect to $q_{i}$ and set it to zero. This is the first-order condition for profit maximization.\n$$ \\frac{\\partial \\pi_{i}}{\\partial q_{i}} = \\frac{\\partial}{\\partial q_{i}} (aq_{i} - bq_{i}^{2} - bQ_{-i}q_{i} - cq_{i}) = 0 $$\n$$ a - 2bq_{i} - bQ_{-i} - c = 0 $$\nThis equation defines firm $i$'s best response to the output of its competitors. We can solve for $q_{i}$ to express it as a function of $Q_{-i}$:\n$$ 2bq_{i} = a - c - bQ_{-i} $$\n$$ q_{i}(Q_{-i}) = \\frac{a - c - bQ_{-i}}{2b} $$\n\nA Nash equilibrium is a situation where all firms are simultaneously playing their best response. The problem specifies a symmetric market structure where all firms are identical. We therefore seek a symmetric Nash equilibrium where every firm produces the same quantity, which we denote as $q^{*}$. In such an equilibrium, $q_{i} = q^{*}$ for all $i \\in \\{1, \\dots, N\\}$.\n\nFor any given firm $i$, the aggregate output of all other firms, $Q_{-i}$, will be the sum of the outputs of the other $N-1$ firms. In a symmetric equilibrium, this is:\n$$ Q_{-i} = \\sum_{j \\neq i} q^{*} = (N-1)q^{*} $$\nNow, we substitute this expression for $Q_{-i}$ back into the best response function. Since firm $i$ is also producing $q^{*}$ in equilibrium, we have:\n$$ q^{*} = \\frac{a - c - b((N-1)q^{*})}{2b} $$\nWe now solve this equation for the equilibrium quantity $q^{*}$.\n$$ 2bq^{*} = a - c - b(N-1)q^{*} $$\n$$ 2bq^{*} = a - c - bNq^{*} + bq^{*} $$\n$$ 2bq^{*} + bNq^{*} - bq^{*} = a - c $$\n$$ bq^{*} + bNq^{*} = a - c $$\n$$ q^{*}(b + bN) = a - c $$\n$$ q^{*}b(N+1) = a - c $$\nSolving for $q^{*}$, we obtain the per-firm symmetric Nash–Cournot equilibrium quantity:\n$$ q^{*} = \\frac{a - c}{b(N+1)} $$\nThe condition $0 \\leq c  a$ ensures that $q^{*} \\geq 0$, which is consistent with the problem's constraint of non-negative output.\n\nNext, we derive the total equilibrium output, $Q^{*}$. This is the sum of the equilibrium quantities produced by all $N$ firms.\n$$ Q^{*} = \\sum_{i=1}^{N} q^{*} = Nq^{*} $$\nSubstituting the expression for $q^{*}$:\n$$ Q^{*} = N \\left( \\frac{a - c}{b(N+1)} \\right) = \\frac{N(a - c)}{b(N+1)} $$\n\nThe two required expressions are the per-firm equilibrium quantity $q^{*}$ and the total equilibrium output $Q^{*}$.",
            "answer": "$$ \\boxed{\\begin{pmatrix} \\frac{a - c}{b(N+1)}  \\frac{N(a - c)}{b(N+1)} \\end{pmatrix}} $$"
        },
        {
            "introduction": "After determining the equilibrium price and quantity in a Cournot market, a crucial next step is to evaluate its economic efficiency. This practice extends the analysis to the domain of welfare economics, tasking you with quantifying consumer surplus, producer surplus, and total welfare. By comparing the Cournot outcome to the perfectly competitive benchmark, you will derive an expression for the deadweight loss caused by market power and see how it depends on the number of competitors .",
            "id": "4106970",
            "problem": "Consider a static wholesale electricity market without network constraints and with a single aggregate demand. The inverse demand function is given by $P(Q) = \\alpha - \\beta Q$, where $P$ is the market-clearing price, $Q$ is the total quantity consumed, $\\alpha > 0$ is the choke price, and $\\beta > 0$ is the slope of the inverse demand. There are $N$ symmetric generating firms that choose quantities in a Nash–Cournot fashion. Each firm $i \\in \\{1, \\dots, N\\}$ has linear variable cost $C_i(q_i) = c\\, q_i$ with constant marginal cost $c$ satisfying $0  c  \\alpha$. Assume that firms have no capacity constraints and no fixed costs.\n\nStarting from the foundational definitions of a Nash–Cournot equilibrium and surplus measures, derive from first principles:\n- the Cournot equilibrium output per firm, the total output, and the resulting price,\n- the consumer surplus, producer surplus, and total welfare at the Cournot equilibrium,\n- the competitive benchmark outcomes under price-taking behavior, including the consumer surplus, producer surplus, and total welfare.\n\nFinally, report the Cournot-to-competitive total welfare ratio $R$, defined as the ratio of total welfare under Cournot to total welfare under perfect competition. Provide $R$ as a single closed-form analytic expression in terms of $N$ only. The ratio is unitless; no rounding is required.",
            "solution": "The problem statement is first validated against the required criteria.\n\n### Step 1: Extract Givens\n-   Inverse demand function: $P(Q) = \\alpha - \\beta Q$\n-   $P$: market-clearing price\n-   $Q$: total quantity consumed\n-   $\\alpha > 0$: choke price\n-   $\\beta > 0$: slope of the inverse demand\n-   $N$: number of symmetric generating firms\n-   Market structure: Nash–Cournot competition\n-   Cost function for firm $i$: $C_i(q_i) = c\\, q_i$\n-   $c$: constant marginal cost\n-   Constraint on marginal cost: $0  c  \\alpha$\n-   Firms have no capacity constraints and no fixed costs.\n-   Required outputs: Cournot equilibrium outcomes, welfare measures, competitive benchmark outcomes, and the ratio of total welfare under Cournot to total welfare under perfect competition ($R$) as a function of $N$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is evaluated based on the established criteria:\n-   **Scientifically Grounded**: The problem describes the canonical Nash–Cournot oligopoly model with linear demand and constant marginal costs. This is a fundamental and well-established model in microeconomics and industrial organization, frequently applied to energy markets. The setup is scientifically sound.\n-   **Well-Posed**: The problem is well-posed. The assumptions of linear demand, constant marginal costs, and the condition $0  c  \\alpha$ ensure that a unique and economically meaningful Nash equilibrium exists. All required parameters are defined.\n-   **Objective**: The problem is stated using precise, objective, and standard economic terminology. It is free from subjective or ambiguous language.\n-   **Completeness**: The problem is self-contained and provides all necessary information (demand function, cost structure, number of firms, market conduct) to derive the specified quantities.\n-   **Realism**: While a simplification of a real electricity market (e.g., no network constraints, static model), it is a standard and scientifically valid simplification used for analyzing market power. The parameters are physically and dimensionally consistent within the model's framework.\n\n### Step 3: Verdict and Action\nThe problem is **valid**. It is a standard, well-posed theoretical problem from microeconomic theory. A detailed solution can be derived from first principles as requested.\n\n### Derivation of the Cournot Equilibrium\n\nEach firm $i$ chooses its quantity $q_i$ to maximize its profit $\\pi_i$, taking the quantities of all other firms, $Q_{-i} = \\sum_{j \\neq i} q_j$, as given. The total market quantity is $Q = q_i + Q_{-i}$.\n\nThe profit function for firm $i$ is its revenue minus its cost:\n$$ \\pi_i(q_i, Q_{-i}) = P(Q)q_i - C_i(q_i) = (\\alpha - \\beta(q_i + Q_{-i}))q_i - c q_i $$\nTo find the profit-maximizing quantity, we take the first derivative of $\\pi_i$ with respect to $q_i$ and set it to zero (the first-order condition for a maximum):\n$$ \\frac{\\partial \\pi_i}{\\partial q_i} = \\frac{\\partial}{\\partial q_i} [(\\alpha - c)q_i - \\beta q_i^2 - \\beta Q_{-i}q_i] = (\\alpha - c) - 2\\beta q_i - \\beta Q_{-i} = 0 $$\nThis equation defines firm $i$'s best response to the output of its competitors. Since all firms are symmetric (they have the same cost function), we look for a symmetric Nash equilibrium where all firms produce the same quantity, $q_i = q_C$ for all $i$.\nIn this symmetric case, $Q_{-i} = (N-1)q_C$. Substituting this into the first-order condition:\n$$ (\\alpha - c) - 2\\beta q_C - \\beta (N-1)q_C = 0 $$\n$$ (\\alpha - c) - \\beta (2 + N - 1)q_C = 0 $$\n$$ (\\alpha - c) - \\beta (N+1)q_C = 0 $$\nSolving for the Cournot equilibrium output per firm, $q_C$:\n$$ q_C = \\frac{\\alpha - c}{\\beta(N+1)} $$\nThe total Cournot equilibrium output, $Q_C$, is the sum of the individual firms' outputs:\n$$ Q_C = N q_C = \\frac{N(\\alpha - c)}{\\beta(N+1)} $$\nThe resulting Cournot equilibrium price, $P_C$, is found by substituting $Q_C$ into the inverse demand function:\n$$ P_C = \\alpha - \\beta Q_C = \\alpha - \\beta \\left(\\frac{N(\\alpha - c)}{\\beta(N+1)}\\right) = \\alpha - \\frac{N(\\alpha - c)}{N+1} $$\n$$ P_C = \\frac{\\alpha(N+1) - N(\\alpha - c)}{N+1} = \\frac{\\alpha N + \\alpha - \\alpha N + Nc}{N+1} = \\frac{\\alpha + Nc}{N+1} $$\nThe condition $0  c  \\alpha$ ensures that $q_C > 0$ and $P_C > c$.\n\n### Welfare Analysis at the Cournot Equilibrium\n\nConsumer Surplus (CS) is the area of the triangle below the demand curve and above the market price $P_C$.\n$$ CS_C = \\frac{1}{2}(\\text{base}) \\times (\\text{height}) = \\frac{1}{2} Q_C (\\alpha - P_C) $$\nSubstituting the expressions for $Q_C$ and $P_C$:\n$$ \\alpha - P_C = \\alpha - \\frac{\\alpha + Nc}{N+1} = \\frac{\\alpha(N+1) - (\\alpha+Nc)}{N+1} = \\frac{N(\\alpha-c)}{N+1} $$\n$$ CS_C = \\frac{1}{2} \\left(\\frac{N(\\alpha - c)}{\\beta(N+1)}\\right) \\left(\\frac{N(\\alpha-c)}{N+1}\\right) = \\frac{1}{2\\beta} \\left(\\frac{N(\\alpha-c)}{N+1}\\right)^2 $$\nProducer Surplus (PS) is the sum of all firms' profits. Since there are no fixed costs, it is the total revenue minus total variable cost.\n$$ PS_C = (P_C - c)Q_C $$\nSubstituting the expressions for $Q_C$ and $(P_C - c)$:\n$$ P_C - c = \\frac{\\alpha + Nc}{N+1} - c = \\frac{\\alpha + Nc - c(N+1)}{N+1} = \\frac{\\alpha - c}{N+1} $$\n$$ PS_C = \\left(\\frac{\\alpha - c}{N+1}\\right) \\left(\\frac{N(\\alpha - c)}{\\beta(N+1)}\\right) = \\frac{N}{\\beta} \\left(\\frac{\\alpha-c}{N+1}\\right)^2 $$\nTotal Welfare (TW) is the sum of consumer and producer surplus.\n$$ TW_C = CS_C + PS_C = \\frac{1}{2\\beta} \\frac{N^2(\\alpha-c)^2}{(N+1)^2} + \\frac{N}{\\beta} \\frac{(\\alpha-c)^2}{(N+1)^2} $$\n$$ TW_C = \\frac{(\\alpha-c)^2}{\\beta(N+1)^2} \\left(\\frac{N^2}{2} + N\\right) = \\frac{(\\alpha-c)^2}{\\beta(N+1)^2} \\frac{N^2 + 2N}{2} $$\n$$ TW_C = \\frac{N(N+2)}{2\\beta(N+1)^2}(\\alpha-c)^2 $$\n\n### The Competitive Benchmark\n\nIn a perfectly competitive market, firms are price-takers, and the market price is driven down to the marginal cost of production.\n$$ P_{pc} = c $$\nThe total quantity produced, $Q_{pc}$, is determined by the demand at this price:\n$$ P_{pc} = \\alpha - \\beta Q_{pc} \\implies c = \\alpha - \\beta Q_{pc} $$\n$$ Q_{pc} = \\frac{\\alpha - c}{\\beta} $$\nConsumer Surplus under perfect competition is:\n$$ CS_{pc} = \\frac{1}{2} Q_{pc} (\\alpha - P_{pc}) = \\frac{1}{2} \\left(\\frac{\\alpha-c}{\\beta}\\right) (\\alpha - c) = \\frac{1}{2\\beta}(\\alpha-c)^2 $$\nProducer Surplus under perfect competition is zero, as price equals marginal cost and there are no fixed costs.\n$$ PS_{pc} = (P_{pc} - c)Q_{pc} = (c-c)Q_{pc} = 0 $$\nTotal Welfare under perfect competition is the sum of consumer and producer surplus:\n$$ TW_{pc} = CS_{pc} + PS_{pc} = \\frac{1}{2\\beta}(\\alpha-c)^2 $$\n\n### Cournot-to-Competitive Total Welfare Ratio\n\nThe ratio $R$ is defined as the total welfare under Cournot competition divided by the total welfare under perfect competition.\n$$ R = \\frac{TW_C}{TW_{pc}} = \\frac{\\frac{N(N+2)}{2\\beta(N+1)^2}(\\alpha-c)^2}{\\frac{1}{2\\beta}(\\alpha-c)^2} $$\nThe terms $\\frac{(\\alpha-c)^2}{2\\beta}$ cancel out from the numerator and denominator, leaving an expression that depends only on $N$.\n$$ R = \\frac{N(N+2)}{(N+1)^2} $$\nThis is the final closed-form analytic expression for the welfare ratio.",
            "answer": "$$\\boxed{\\frac{N(N+2)}{(N+1)^2}}$$"
        },
        {
            "introduction": "Moving beyond the Cournot model where firms choose a single quantity, the Supply Function Equilibrium (SFE) offers a more sophisticated framework where firms strategically submit entire supply curves. This practice provides a hands-on introduction to the computational methods required to solve SFE models, which are highly relevant in modern electricity auction design. You will discretize the governing differential equation and implement a numerical shooting method to find the equilibrium supply function, gaining valuable skills in computational economic modeling .",
            "id": "4106987",
            "problem": "Consider a setting with $N$ firms that submit non-decreasing, differentiable supply functions $S_i(p)$ mapping a market price $p$ to a quantity, and a piecewise linear inverse demand function $P(Q)$ defined on quantity $Q$ such that, over each contiguous quantity interval where the inverse demand is linear, $P(Q)$ has a constant negative slope. Equivalently, over each contiguous price interval, the inverse demand can be described by a constant slope parameter per segment. Each firm $i$ has a convex, differentiable cost function $C_i(q)$ with constant marginal cost $C_i'(q) = c_i$, where $c_i$ is strictly less than the minimum price considered. In a supply function equilibrium, firms choose functions $S_i(p)$ to maximize profit for each possible realized price $p$ arising from an uncertain demand intercept, subject to market clearing.\n\nStarting from fundamental definitions:\n- Profit for firm $i$ at realized price $p$ and its supplied quantity $q_i = S_i(p)$ is $\\pi_i(p) = p \\, S_i(p) - C_i(S_i(p))$.\n- Market clearing requires $\\sum_{j=1}^N S_j(p) = Q(p)$ at the realized price $p$, where $Q(p)$ is the demand at price $p$ induced by the uncertain demand intercept.\n\nAssume the inverse demand is piecewise linear in the standard form $P(Q) = \\alpha_k - \\beta_k Q$ with $\\beta_k > 0$ on each segment $k$, so that within segment $k$ the quantity sensitivity to price changes is constant and given by $\\frac{dQ}{dp} = -\\frac{1}{\\beta_k}$. Further assume identical firms with identical constant marginal costs $c_i = c$ and interior activity (no binding corner solutions within the interior of each price segment). Derive, from first principles, the necessary local optimality condition for supply function equilibrium in this setting that yields a first-order linear differential equation in continuous price $p$ for each firm $i$ within a demand segment $k$ of the form\n$$\n\\bigl(p - c\\bigr) \\, \\frac{d S_i(p)}{dp} + S_i(p) = \\frac{\\lambda_i}{\\beta_k},\n$$\nwhere $\\lambda_i$ is a segment-independent constant determined by equilibrium selection and boundary conditions. Then, construct a discrete analog using a forward finite difference scheme on a uniform price grid $\\{p_m\\}_{m=0}^{M-1}$ with spacing $\\Delta p = p_{m+1} - p_m$, so that for interior points within segment $k$ you obtain the recurrence\n$$\nS_{i,m+1} = S_{i,m} \\left( 1 - \\frac{\\Delta p}{p_m - c} \\right) + \\frac{\\Delta p}{p_m - c} \\cdot \\frac{\\lambda_i}{\\beta_k},\n$$\nand boundary conditions $S_i(p_{\\min}) = 0$ and $S_i(p_{\\max}) = K_i$ for a given firm-specific capacity $K_i$ at the maximum price. Use a shooting method argument to show that linearity in $\\lambda_i$ implies solving the scheme once with $\\lambda_i = 1$ and scaling the resulting discrete solution by a factor chosen to meet $S_i(p_{\\max}) = K_i$ exactly.\n\nImplement a complete program that:\n- Constructs a uniform price grid spanning the union of segments.\n- Applies the above finite difference recurrence with a baseline $\\lambda_i = 1$ to obtain a discrete solution $\\widehat{S}_i(p_m)$.\n- Scales the solution by $\\lambda_i = K_i / \\widehat{S}_i(p_{\\max})$ to enforce $S_i(p_{\\max}) = K_i$.\n- For specified evaluation prices, returns $S_i(p)$ at those prices via linear interpolation on the discrete solution.\n\nAll quantities are purely mathematical and dimensionless; no physical units are required. Angles do not appear. Express numerical answers as floating-point numbers.\n\nTest Suite:\nProvide the following three test cases. Each test case specifies $(N, c, \\text{segments}, K_i, M, \\text{eval\\_prices})$ where segments is a list of $(p_{\\text{lo}}, p_{\\text{hi}}, \\beta)$ tuples with contiguous coverage. The program must compute and return $S_i(p)$ for the specified evaluation prices for a representative firm $i$ with capacity $K_i$ and identical cost $c$.\n\n- Case A (happy path, three segments):\n    - $N = 3$, $c = 20$,\n    - segments $= \\{(25, 60, 0.02), (60, 95, 0.04), (95, 120, 0.06)\\}$,\n    - $K_i = 50$, $M = 241$,\n    - eval\\_prices $= [40, 60, 80, 100, 120]$.\n\n- Case B (two segments, different slope mix):\n    - $N = 2$, $c = 30$,\n    - segments $= \\{(35, 80, 0.03), (80, 110, 0.05)\\}$,\n    - $K_i = 60$, $M = 151$,\n    - eval\\_prices $= [35, 75, 95, 110]$.\n\n- Case C (edge case with a relatively flat segment and tighter range):\n    - $N = 4$, $c = 10$,\n    - segments $= \\{(12, 40, 0.008), (40, 55, 0.015)\\}$,\n    - $K_i = 20$, $M = 173$,\n    - eval\\_prices $= [12, 30, 45, 55]$.\n\nFinal Output Format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element is a sublist of floating-point values corresponding to the computed $S_i(p)$ at the evaluation prices for each test case in order, for example, $[[s_{A,1}, s_{A,2}, \\dots], [s_{B,1}, s_{B,2}, \\dots], [s_{C,1}, s_{C,2}, \\dots]]$.",
            "solution": "The problem is assessed to be valid. It presents a well-defined task in computational economics, specifically the numerical solution of a supply function equilibrium model. The governing equations, boundary conditions, and numerical scheme are specified unambiguously. The provided parameters are self-consistent and sufficient for deriving a unique solution.\n\nThe solution proceeds in four main stages:\n1.  **Statement of the Governing Equation**: We begin with the provided ordinary differential equation (ODE) that describes the firm's optimal supply function $S_i(p)$ within a given demand segment $k$.\n2.  **Discretization**: We derive the specified recurrence relation by applying a forward finite difference scheme to the ODE.\n3.  **Shooting Method**: We formalize the shooting method used to satisfy the boundary conditions, leveraging the linearity of the system to determine the unknown constant $\\lambda_i$.\n4.  **Numerical Implementation**: We outline the algorithm to compute the supply function for the given test cases, including grid generation, iterative solution, scaling, and interpolation.\n\n**1. Governing Differential Equation**\nThe problem states that, from the first principles of profit maximization in a supply function equilibrium, the optimal supply function $S_i(p)$ for a firm $i$ with constant marginal cost $c$ must satisfy the following first-order linear ordinary differential equation for a price $p$ within a segment $k$ of the piecewise linear inverse demand function:\n$$\n\\bigl(p - c\\bigr) \\, \\frac{d S_i(p)}{dp} + S_i(p) = \\frac{\\lambda_i}{\\beta_k}\n$$\nHere, $\\beta_k > 0$ is the negative of the inverse demand slope for segment $k$, and $\\lambda_i$ is a constant for firm $i$ that is determined by the equilibrium conditions across all segments. The left-hand side of this equation is equivalent to the derivative of the product $(p-c)S_i(p)$, which represents the firm's per-unit markup multiplied by its quantity.\n\n**2. Discretization via Forward Finite Difference**\nTo solve this ODE numerically, we discretize the continuous price domain into a uniform grid of $M$ points, $\\{p_m\\}_{m=0}^{M-1}$, where $p_0 = p_{\\min}$ and $p_{M-1} = p_{\\max}$. The grid spacing is $\\Delta p = p_{m+1} - p_m = (p_{\\max} - p_{\\min}) / (M - 1)$. Let $S_{i,m}$ denote the numerical approximation of $S_i(p_m)$.\n\nWe approximate the first derivative $\\frac{d S_i(p)}{dp}$ at grid point $p_m$ using a forward finite difference formula:\n$$\n\\frac{d S_i(p)}{dp}\\Bigg|_{p=p_m} \\approx \\frac{S_i(p_{m+1}) - S_i(p_m)}{\\Delta p} = \\frac{S_{i,m+1} - S_{i,m}}{\\Delta p}\n$$\nSubstituting this approximation into the governing ODE, we obtain an algebraic equation for each interior grid point $m \\in \\{0, 1, \\dots, M-2\\}$:\n$$\n(p_m - c) \\left( \\frac{S_{i,m+1} - S_{i,m}}{\\Delta p} \\right) + S_{i,m} = \\frac{\\lambda_i}{\\beta_{k(m)}}\n$$\nwhere $\\beta_{k(m)}$ is the value of $\\beta_k$ for the segment $k$ that contains the price $p_m$.\n\nThe task is to find a recurrence relation for $S_{i,m+1}$ in terms of $S_{i,m}$. We rearrange the equation to isolate $S_{i,m+1}$:\n$$\n(p_m - c) (S_{i,m+1} - S_{i,m}) = \\Delta p \\left( \\frac{\\lambda_i}{\\beta_{k(m)}} - S_{i,m} \\right)\n$$\n$$\nS_{i,m+1} - S_{i,m} = \\frac{\\Delta p}{p_m - c} \\left( \\frac{\\lambda_i}{\\beta_{k(m)}} - S_{i,m} \\right)\n$$\n$$\nS_{i,m+1} = S_{i,m} + \\frac{\\Delta p}{p_m - c} \\frac{\\lambda_i}{\\beta_{k(m)}} - \\frac{\\Delta p}{p_m - c} S_{i,m}\n$$\nFactoring out $S_{i,m}$ yields the final recurrence relation as specified in the problem statement:\n$$\nS_{i,m+1} = S_{i,m} \\left( 1 - \\frac{\\Delta p}{p_m - c} \\right) + \\frac{\\Delta p}{p_m - c} \\cdot \\frac{\\lambda_i}{\\beta_{k(m)}}\n$$\nThis recurrence allows us to compute the entire discrete supply function, step-by-step, starting from an initial condition.\n\n**3. The Shooting Method**\nThe problem is an initial value problem with a boundary condition at the end. We are given two boundary conditions: $S_i(p_{\\min}) = 0$ and $S_i(p_{\\max}) = K_i$, where $p_{\\min}$ is the lowest price in the domain and $p_{\\max}$ is the highest, and $K_i$ is the firm's capacity. The recurrence relation depends on the unknown constant $\\lambda_i$. The shooting method provides a way to find the correct value of $\\lambda_i$ that ensures the final boundary condition $S_i(p_{\\max}) = K_i$ is met.\n\nThe key insight is that the recurrence relation is linear with respect to $\\lambda_i$. Let $S_{i,m}(\\lambda_i)$ denote the solution at step $m$ for a given $\\lambda_i$. The initial condition is $S_{i,0} = S_i(p_{\\min}) = 0$, which is independent of $\\lambda_i$. If we assume $S_{i,m}$ is a linear function of $\\lambda_i$, the recurrence shows that $S_{i,m+1}$ is also a linear combination of $S_{i,m}$ and a term linear in $\\lambda_i$, thus preserving linearity. Also, since $S_{i,0}=0$, the homogeneous part of the solution is zero, meaning $S_{i,m}(\\lambda_i)$ is not just linear, but directly proportional to $\\lambda_i$. Let $\\widehat{S}_{i,m}$ be the solution obtained by setting $\\lambda_i = 1$. Then the general solution for an arbitrary $\\lambda_i$ is simply $S_{i,m} = \\lambda_i \\widehat{S}_{i,m}$.\n\nWe can therefore use the following procedure:\n1.  Set a baseline value $\\lambda_i = 1$.\n2.  Solve the recurrence relation starting with $\\widehat{S}_{i,0} = 0$ to find the full tentative solution $\\widehat{S}_i = \\{\\widehat{S}_{i,m}\\}_{m=0}^{M-1}$.\n3.  Evaluate this tentative solution at the final price point, $p_{M-1} = p_{\\max}$, which gives $\\widehat{S}_{i,M-1}$.\n4.  Use the proportionality $S_{i,M-1} = \\lambda_i \\widehat{S}_{i,M-1}$ and the boundary condition $S_{i,M-1} = K_i$ to solve for the correct $\\lambda_i$:\n    $$\n    K_i = \\lambda_i \\widehat{S}_{i,M-1} \\implies \\lambda_i = \\frac{K_i}{\\widehat{S}_{i,M-1}}\n    $$\n5.  The final, correct discrete supply function is obtained by scaling the tentative solution: $S_i = \\lambda_i \\widehat{S}_i$.\n\n**4. Numerical Algorithm and Implementation**\nThe complete algorithm to solve the problem for each test case is as follows:\n1.  **Define Grid**: Given the segments, identify $p_{\\min}$ and $p_{\\max}$. Construct a uniform price grid `p_grid` of size $M$ from $p_{\\min}$ to $p_{\\max}$. Calculate the step size $\\Delta p$.\n2.  **Map Beta Parameter**: Create an array `beta_vals` of size $M$, where `beta_vals[m]` contains the $\\beta_k$ value corresponding to the segment containing the price `p_grid[m]`. A price $p$ is in segment $(p_{\\text{lo}}, p_{\\text{hi}}, \\beta)$ if $p_{\\text{lo}} \\le p  p_{\\text{hi}}$, with the final point $p_{\\max}$ belonging to the last segment.\n3.  **Compute Tentative Solution**: Initialize an array $\\widehat{S}_i$ of size $M$ with $\\widehat{S}_{i,0}=0$. Iterate from $m=0$ to $M-2$, applying the recurrence relation with $\\lambda_i=1$ to compute $\\widehat{S}_{i,m+1}$ at each step.\n4.  **Scale Solution**: Calculate the scaling factor $\\lambda_i = K_i / \\widehat{S}_{i,M-1}$. Compute the final solution array $S_i = \\lambda_i \\widehat{S}_i$. This guarantees that $S_{i,0}=0$ and $S_{i,M-1} = K_i$.\n5.  **Interpolate**: For the given evaluation prices, use linear interpolation on the discrete points $(p_m, S_{i,m})$ to find the supply quantity $S_i(p)$ at each requested price. Standard numerical libraries provide efficient functions for this step.\n6.  **Output Results**: Collect the interpolated quantities for each test case and format them as specified.\nThis procedure will be implemented for each of the test cases provided.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for the supply function equilibrium quantities for a set of test cases.\n    \"\"\"\n    test_cases = [\n        {\n            \"N\": 3, \"c\": 20,\n            \"segments\": [(25, 60, 0.02), (60, 95, 0.04), (95, 120, 0.06)],\n            \"K_i\": 50, \"M\": 241,\n            \"eval_prices\": [40, 60, 80, 100, 120]\n        },\n        {\n            \"N\": 2, \"c\": 30,\n            \"segments\": [(35, 80, 0.03), (80, 110, 0.05)],\n            \"K_i\": 60, \"M\": 151,\n            \"eval_prices\": [35, 75, 95, 110]\n        },\n        {\n            \"N\": 4, \"c\": 10,\n            \"segments\": [(12, 40, 0.008), (40, 55, 0.015)],\n            \"K_i\": 20, \"M\": 173,\n            \"eval_prices\": [12, 30, 45, 55]\n        }\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        c = case[\"c\"]\n        segments = case[\"segments\"]\n        K_i = case[\"K_i\"]\n        M = case[\"M\"]\n        eval_prices = case[\"eval_prices\"]\n        \n        # 1. Define Grid\n        p_min = segments[0][0]\n        p_max = segments[-1][1]\n        p_grid = np.linspace(p_min, p_max, M)\n        delta_p = (p_max - p_min) / (M - 1)\n\n        # 2. Map Beta Parameter to the grid\n        beta_vals = np.zeros(M)\n        for p_lo, p_hi, beta in segments:\n            indices = np.where((p_grid >= p_lo)  (p_grid  p_hi))\n            beta_vals[indices] = beta\n        # The last point at p_max is included in the last segment\n        beta_vals[-1] = segments[-1][2]\n\n        # 3. Compute Tentative Solution (Shooting with lambda_i = 1)\n        S_hat = np.zeros(M)\n        S_hat[0] = 0.0\n        lambda_baseline = 1.0\n\n        for m in range(M - 1):\n            p_m = p_grid[m]\n            S_im = S_hat[m]\n            beta_k = beta_vals[m]\n            \n            # The problem guarantees p>c, so p_m - c > 0\n            if p_m - c = 0:\n                # This should not happen based on problem constraints c  p_min.\n                # If it did, the derivative would explode. We handle this defensively.\n                # A large step might be taken, but we cap it or handle as an error.\n                # For this problem, we rely on the guarantee.\n                pass\n\n            term1 = S_im * (1.0 - delta_p / (p_m - c))\n            term2 = (delta_p / (p_m - c)) * (lambda_baseline / beta_k)\n            S_hat[m + 1] = term1 + term2\n\n        # 4. Scale Solution\n        S_hat_max = S_hat[-1]\n        lambda_i = K_i / S_hat_max\n        S_final = lambda_i * S_hat\n\n        # 5. Interpolate to find values at evaluation prices\n        results_for_case = np.interp(eval_prices, p_grid, S_final)\n        all_results.append([float(f\"{val:.10f}\") for val in results_for_case])\n    \n    # Format the final output string\n    # e.g., [[val1,val2],[val3,val4]]\n    # Python's str() on a list of lists adds spaces, so we build it manually.\n    final_output_str = '[' + ','.join(\n        '[' + ','.join(map(str, sublist)) + ']' for sublist in all_results\n    ) + ']'\n    \n    print(final_output_str)\n\nsolve()\n```"
        }
    ]
}