{
    "hands_on_practices": [
        {
            "introduction": "本章的第一个练习是基础性的，它要求你从第一性原理出发，为 $N$ 个公司推导出对称的纳什-古诺均衡。这项练习构建了模拟寡头竞争所必需的核心分析工具。掌握这一推导过程可以确保你深刻理解公司的战略互动如何导向稳定的市场结果。",
            "id": "4106985",
            "problem": "考虑一个程式化的短期电力批发市场，其中有 $N$ 家对称的发电公司。每家公司 $i \\in \\{1,\\dots,N\\}$ 同时选择一个非负产量 $q_{i}$ 以实现利润最大化，并将所有其他公司的产量视为给定，这与纳什均衡的定义一致。总供给所面临的逆需求函数为 $P(Q)=a-bQ$，其中 $Q=\\sum_{j=1}^{N}q_{j}$ 是总产量，$a0$ 是逆需求的截距，$b0$ 是斜率系数。每家公司的边际成本为常数 $c$，总成本为 $C(q_{i})=cq_{i}$，其中 $0 \\leq c  a$，且没有产能约束。假设市场由一个中央系统运营商出清，公司以古诺模型的方式进行数量竞争，而不是像供给函数均衡 (SFE) 那样竞标供给函数。\n\n仅从利润最大化原则和数量上的纳什均衡（古诺）定义出发，不使用任何快捷公式，推导以下各项的闭式表达式：\n1. 作为 $a$、$b$、$c$ 和 $N$ 的函数的每家公司的对称纳什-古诺均衡产量 $q^{*}$。\n2. 由此产生的总均衡产量 $Q^{*}$。\n\n将您的最终答案以包含两个表达式 $q^{*}$ 和 $Q^{*}$ 的单行矩阵形式提供。不需要数值近似或四舍五入。最终答案中无需报告单位。",
            "solution": "该问题是有效的，因为它是微观经济理论中一个适定、有科学依据且客观的问题，具体涉及古诺竞争，这是能源系统分析中的一个标准模型。它提供了所有必要的信息，并且不包含任何矛盾或含糊之处。\n\n我们首先对任意公司 $i$ 的利润最大化问题进行形式化。公司 $i$ 的利润（记为 $\\pi_{i}$）是其总收益减去总成本。总收益是市场价格 $P(Q)$ 乘以公司自身的产量 $q_{i}$。总成本由 $C(q_{i}) = cq_{i}$ 给出。\n\n公司 $i$ 的利润函数是：\n$$ \\pi_{i}(q_{1}, q_{2}, \\dots, q_{N}) = P(Q)q_{i} - C(q_{i}) $$\n逆需求函数为 $P(Q) = a - bQ$，其中 $Q$ 是市场总产量，定义为 $Q = \\sum_{j=1}^{N} q_{j}$。我们可以将 $Q$ 表示为公司 $i$ 的产量与所有其他公司总产量之和，即 $Q_{-i} = \\sum_{j \\neq i} q_{j}$。因此，$Q = q_{i} + Q_{-i}$。\n\n将这些表达式代入利润函数，我们得到：\n$$ \\pi_{i}(q_{i}, Q_{-i}) = (a - b(q_{i} + Q_{-i}))q_{i} - cq_{i} $$\n展开此表达式可得：\n$$ \\pi_{i}(q_{i}, Q_{-i}) = aq_{i} - bq_{i}^{2} - bQ_{-i}q_{i} - cq_{i} $$\n\n在古诺模型中，每家公司选择其产量 $q_{i}$ 以最大化自身利润，同时将所有其他公司（$Q_{-i}$）的产量视为固定。为了找到公司 $i$ 的最优产量，我们将利润函数 $\\pi_{i}$ 对 $q_{i}$ 求偏导数并令其为零。这是一阶利润最大化条件。\n$$ \\frac{\\partial \\pi_{i}}{\\partial q_{i}} = \\frac{\\partial}{\\partial q_{i}} (aq_{i} - bq_{i}^{2} - bQ_{-i}q_{i} - cq_{i}) = 0 $$\n$$ a - 2bq_{i} - bQ_{-i} - c = 0 $$\n这个方程定义了公司 $i$ 对其竞争对手产量的最优反应。我们可以解出 $q_{i}$，将其表示为 $Q_{-i}$ 的函数：\n$$ 2bq_{i} = a - c - bQ_{-i} $$\n$$ q_{i}(Q_{-i}) = \\frac{a - c - bQ_{-i}}{2b} $$\n\n纳什均衡是所有公司同时采取其最优反应的一种状态。问题指定了一个所有公司都相同的对称市场结构。因此，我们寻求一个对称纳什均衡，其中每家公司都生产相同的产量，我们将其记为 $q^{*}$。在这样的均衡中，对于所有 $i \\in \\{1, \\dots, N\\}$，都有 $q_{i} = q^{*}$。\n\n对于任何给定的公司 $i$，所有其他公司的总产量 $Q_{-i}$ 将是其他 $N-1$ 家公司产量之和。在对称均衡中，即为：\n$$ Q_{-i} = \\sum_{j \\neq i} q^{*} = (N-1)q^{*} $$\n现在，我们将 $Q_{-i}$ 的这个表达式代回最优反应函数中。由于公司 $i$ 在均衡中也生产 $q^{*}$，我们有：\n$$ q^{*} = \\frac{a - c - b((N-1)q^{*})}{2b} $$\n我们现在解这个方程以求得均衡产量 $q^{*}$。\n$$ 2bq^{*} = a - c - b(N-1)q^{*} $$\n$$ 2bq^{*} = a - c - bNq^{*} + bq^{*} $$\n$$ 2bq^{*} + bNq^{*} - bq^{*} = a - c $$\n$$ bq^{*} + bNq^{*} = a - c $$\n$$ q^{*}(b + bN) = a - c $$\n$$ q^{*}b(N+1) = a - c $$\n解出 $q^{*}$，我们得到每家公司的对称纳什-古诺均衡产量：\n$$ q^{*} = \\frac{a - c}{b(N+1)} $$\n条件 $0 \\leq c  a$ 确保了 $q^{*} > 0$，这与问题中非负产量的约束是一致的。\n\n接下来，我们推导总均衡产量 $Q^{*}$。这是所有 $N$ 家公司生产的均衡产量之和。\n$$ Q^{*} = \\sum_{i=1}^{N} q^{*} = Nq^{*} $$\n代入 $q^{*}$ 的表达式：\n$$ Q^{*} = N \\left( \\frac{a - c}{b(N+1)} \\right) = \\frac{N(a - c)}{b(N+1)} $$\n\n所需的两个表达式是每家公司的均衡产量 $q^{*}$ 和总均衡产量 $Q^{*}$。",
            "answer": "$$ \\boxed{\\begin{pmatrix} \\frac{a - c}{b(N+1)}  \\frac{N(a - c)}{b(N+1)} \\end{pmatrix}} $$"
        },
        {
            "introduction": "在均衡概念的基础上，本练习将深入探讨其经济后果。你将计算消费者剩余、生产者剩余和总福利，并将其与完全竞争的理想情况进行比较。这项练习对于量化由市场势力造成的市场无效率至关重要，而这正是能源政策和监管中的一个核心问题。",
            "id": "4106970",
            "problem": "考虑一个没有网络约束且具有单一总需求的静态电力批发市场。反需求函数为 $P(Q) = \\alpha - \\beta Q$，其中 $P$ 是市场出清价格，$Q$ 是总消费量，$\\alpha > 0$ 是窒息价格，$\\beta > 0$ 是反需求曲线的斜率。市场中有 $N$ 个对称的发电厂商，它们以 Nash-Cournot 方式选择产量。每个厂商 $i \\in \\{1, \\dots, N\\}$ 的线性可变成本为 $C_i(q_i) = c\\, q_i$，其边际成本为常数 $c$，且满足 $0  c  \\alpha$。假设厂商没有容量约束，也没有固定成本。\n\n从 Nash-Cournot 均衡和剩余度量的基本定义出发，基于第一性原理推导：\n- 每个厂商的 Cournot 均衡产量、总产量及由此产生的价格，\n- Cournot 均衡下的消费者剩余、生产者剩余和总福利，\n- 价格接受者行为下的竞争基准结果，包括消费者剩余、生产者剩余和总福利。\n\n最后，报告 Cournot 与完全竞争的总福利之比 $R$，其定义为 Cournot 均衡下的总福利与完全竞争下的总福利之比。请以仅含 $N$ 的单个闭式解析表达式的形式给出 $R$。该比值为无量纲数；无需四舍五入。",
            "solution": "首先根据所需标准验证问题陈述。\n\n### 第 1 步：提取已知条件\n-   反需求函数：$P(Q) = \\alpha - \\beta Q$\n-   $P$：市场出清价格\n-   $Q$：总消费量\n-   $\\alpha > 0$：窒息价格\n-   $\\beta > 0$：反需求曲线的斜率\n-   $N$：对称发电厂商的数量\n-   市场结构：Nash-Cournot 竞争\n-   厂商 $i$ 的成本函数：$C_i(q_i) = c\\, q_i$\n-   $c$：恒定边际成本\n-   边际成本约束：$0  c  \\alpha$\n-   厂商没有容量约束和固定成本。\n-   要求输出：Cournot 均衡结果、福利度量、竞争基准结果，以及 Cournot 总福利与完全竞争总福利之比 ($R$) 作为 $N$ 的函数。\n\n### 第 2 步：使用提取的已知条件进行验证\n根据既定标准对问题进行评估：\n-   **科学依据**：该问题描述了具有线性需求和常数边际成本的经典 Nash-Cournot 寡头模型。这是微观经济学和产业组织学中一个基础且成熟的模型，经常应用于能源市场。该设定在科学上是合理的。\n-   **适定性**：该问题是适定的。线性需求、常数边际成本以及条件 $0  c  \\alpha$ 的假设确保了唯一且具有经济意义的纳什均衡的存在。所有必需的参数都已定义。\n-   **客观性**：该问题使用精确、客观和标准的经济学术语进行陈述，不含主观或模糊的语言。\n-   **完整性**：该问题是自洽的，提供了推导指定量所需的所有必要信息（需求函数、成本结构、厂商数量、市场行为）。\n-   **现实性**：虽然这是对真实电力市场的简化（例如，无网络约束、静态模型），但它是一种用于分析市场势力的标准且科学上有效的简化方法。在模型框架内，各参数在物理上和量纲上都是一致的。\n\n### 第 3 步：结论与行动\n该问题是**有效的**。这是一个来自微观经济学理论的标准、适定的理论问题。可以按要求从第一性原理推导出详细解法。\n\n### Cournot 均衡的推导\n\n每个厂商 $i$ 选择其产量 $q_i$ 以最大化其利润 $\\pi_i$，并将所有其他厂商的产量 $Q_{-i} = \\sum_{j \\neq i} q_j$ 视为给定。市场总产量为 $Q = q_i + Q_{-i}$。\n\n厂商 $i$ 的利润函数是其收益减去成本：\n$$ \\pi_i(q_i, Q_{-i}) = P(Q)q_i - C_i(q_i) = (\\alpha - \\beta(q_i + Q_{-i}))q_i - c q_i $$\n为了找到利润最大化的产量，我们对 $\\pi_i$ 关于 $q_i$ 求一阶导数，并令其为零（最大化的一阶条件）：\n$$ \\frac{\\partial \\pi_i}{\\partial q_i} = \\frac{\\partial}{\\partial q_i} [(\\alpha - c)q_i - \\beta q_i^2 - \\beta Q_{-i}q_i] = (\\alpha - c) - 2\\beta q_i - \\beta Q_{-i} = 0 $$\n该方程定义了厂商 $i$ 对其竞争对手产量的最佳响应。由于所有厂商都是对称的（它们具有相同的成本函数），我们寻求一个对称的纳什均衡，其中所有厂商生产相同的产量，即对所有 $i$ 都有 $q_i = q_C$。\n在这种对称情况下，$Q_{-i} = (N-1)q_C$。将其代入一阶条件：\n$$ (\\alpha - c) - 2\\beta q_C - \\beta (N-1)q_C = 0 $$\n$$ (\\alpha - c) - \\beta (2 + N - 1)q_C = 0 $$\n$$ (\\alpha - c) - \\beta (N+1)q_C = 0 $$\n求解每个厂商的 Cournot 均衡产量 $q_C$：\n$$ q_C = \\frac{\\alpha - c}{\\beta(N+1)} $$\n总 Cournot 均衡产量 $Q_C$ 是各个厂商产量之和：\n$$ Q_C = N q_C = \\frac{N(\\alpha - c)}{\\beta(N+1)} $$\n将 $Q_C$ 代入反需求函数，可得到 Cournot 均衡价格 $P_C$：\n$$ P_C = \\alpha - \\beta Q_C = \\alpha - \\beta \\left(\\frac{N(\\alpha - c)}{\\beta(N+1)}\\right) = \\alpha - \\frac{N(\\alpha - c)}{N+1} $$\n$$ P_C = \\frac{\\alpha(N+1) - N(\\alpha - c)}{N+1} = \\frac{\\alpha N + \\alpha - \\alpha N + Nc}{N+1} = \\frac{\\alpha + Nc}{N+1} $$\n条件 $0  c  \\alpha$ 确保了 $q_C > 0$ 和 $P_C > c$。\n\n### Cournot 均衡下的福利分析\n\n消费者剩余 (CS) 是需求曲线下方、市场价格 $P_C$ 上方的三角形面积。\n$$ CS_C = \\frac{1}{2}(\\text{base}) \\times (\\text{height}) = \\frac{1}{2} Q_C (\\alpha - P_C) $$\n代入 $Q_C$ 和 $P_C$ 的表达式：\n$$ \\alpha - P_C = \\alpha - \\frac{\\alpha + Nc}{N+1} = \\frac{\\alpha(N+1) - (\\alpha+Nc)}{N+1} = \\frac{N(\\alpha-c)}{N+1} $$\n$$ CS_C = \\frac{1}{2} \\left(\\frac{N(\\alpha - c)}{\\beta(N+1)}\\right) \\left(\\frac{N(\\alpha-c)}{N+1}\\right) = \\frac{1}{2\\beta} \\left(\\frac{N(\\alpha-c)}{N+1}\\right)^2 $$\n生产者剩余 (PS) 是所有厂商利润的总和。由于没有固定成本，它等于总收益减去总可变成本。\n$$ PS_C = (P_C - c)Q_C $$\n代入 $Q_C$ 和 $(P_C - c)$ 的表达式：\n$$ P_C - c = \\frac{\\alpha + Nc}{N+1} - c = \\frac{\\alpha + Nc - c(N+1)}{N+1} = \\frac{\\alpha - c}{N+1} $$\n$$ PS_C = \\left(\\frac{\\alpha - c}{N+1}\\right) \\left(\\frac{N(\\alpha - c)}{\\beta(N+1)}\\right) = \\frac{N}{\\beta} \\left(\\frac{\\alpha-c}{N+1}\\right)^2 $$\n总福利 (TW) 是消费者剩余和生产者剩余之和。\n$$ TW_C = CS_C + PS_C = \\frac{1}{2\\beta} \\frac{N^2(\\alpha-c)^2}{(N+1)^2} + \\frac{N}{\\beta} \\frac{(\\alpha-c)^2}{(N+1)^2} $$\n$$ TW_C = \\frac{(\\alpha-c)^2}{\\beta(N+1)^2} \\left(\\frac{N^2}{2} + N\\right) = \\frac{(\\alpha-c)^2}{\\beta(N+1)^2} \\frac{N^2 + 2N}{2} $$\n$$ TW_C = \\frac{N(N+2)}{2\\beta(N+1)^2}(\\alpha-c)^2 $$\n\n### 竞争基准\n\n在完全竞争市场中，厂商是价格接受者，市场价格被推低至生产的边际成本。\n$$ P_{pc} = c $$\n总产量 $Q_{pc}$ 由该价格下的需求决定：\n$$ P_{pc} = \\alpha - \\beta Q_{pc} \\implies c = \\alpha - \\beta Q_{pc} $$\n$$ Q_{pc} = \\frac{\\alpha - c}{\\beta} $$\n完全竞争下的消费者剩余为：\n$$ CS_{pc} = \\frac{1}{2} Q_{pc} (\\alpha - P_{pc}) = \\frac{1}{2} \\left(\\frac{\\alpha-c}{\\beta}\\right) (\\alpha - c) = \\frac{1}{2\\beta}(\\alpha-c)^2 $$\n完全竞争下的生产者剩余为零，因为价格等于边际成本，且没有固定成本。\n$$ PS_{pc} = (P_{pc} - c)Q_{pc} = (c-c)Q_{pc} = 0 $$\n完全竞争下的总福利是消费者剩余和生产者剩余之和：\n$$ TW_{pc} = CS_{pc} + PS_{pc} = \\frac{1}{2\\beta}(\\alpha-c)^2 $$\n\n### Cournot 与完全竞争的总福利之比\n\n比率 $R$ 定义为 Cournot 竞争下的总福利除以完全竞争下的总福利。\n$$ R = \\frac{TW_C}{TW_{pc}} = \\frac{\\frac{N(N+2)}{2\\beta(N+1)^2}(\\alpha-c)^2}{\\frac{1}{2\\beta}(\\alpha-c)^2} $$\n分子和分母中的项 $\\frac{(\\alpha-c)^2}{2\\beta}$相互抵消，剩下一个仅依赖于 $N$ 的表达式。\n$$ R = \\frac{N(N+2)}{(N+1)^2} $$\n这就是福利比率的最终闭式解析表达式。",
            "answer": "$$\\boxed{\\frac{N(N+2)}{(N+1)^2}}$$"
        },
        {
            "introduction": "最后的这个练习将超越古诺模型，进入更复杂的供给函数均衡 (Supply Function Equilibrium, SFE) 模型，在该模型中，公司通过提交供给曲线进行竞争。这个问题连接了理论与计算，要求你将一个微分方程离散化并实现一个数值求解器。它反映了现代能源系统分析中使用的那种实用建模技巧。",
            "id": "4106987",
            "problem": "考虑一个有 $N$ 个对称公司的场景，这些公司提交非递减、可微的供给函数 $S_i(p)$，该函数将市场价格 $p$ 映射到一个数量。此外，还有一个分段线性的反需求函数 $P(Q)$，其斜率在每个分段 $k$ 上为 $-\\beta_k$。每个公司 $i$ 都有一个相同的常数边际成本 $c_i = c$，且 $c$ 严格小于所考虑的最低价格。在对称的供给函数均衡中，供给函数 $S(p)$ 满足以下一阶常微分方程(ODE)：\n$$\nS'(p) = \\frac{S(p)}{(N - 1)(p - c)} - \\frac{1}{\\beta_k(N - 1)}\n$$\n该方程在反需求函数的每个线性分段 $k$ 内有效。\n\n你的任务是数值求解这个ODE，并考虑一个现实的容量约束。\n从基本定义开始：\n- 公司在最低价格 $p_{\\min}$ 时不供给，即初始条件为 $S(p_{\\min})=0$。\n- 公司不能供给超过其物理容量 $K_i$，因此其最终供给函数是 $S_{\\text{final}}(p) = \\min(S(p), K_i)$，其中 $S(p)$ 是无约束ODE的解。\n\n构建一个数值模拟，该模拟：\n1. 在一个覆盖所有分段的均匀价格网格 $\\{p_m\\}_{m=0}^{M-1}$（间距为 $\\Delta p = p_{m+1} - p_m$）上，使用前向有限差分格式离散化上述ODE。推导出递推关系 $S_{m+1} = f(S_m, p_m, \\Delta p, N, c, \\beta_k)$。\n2. 实现一个程序，从初始条件 $S_0=0$ 开始，应用此递推关系来计算无约束的供给曲线 $S(p)$。\n3. 对得到的解应用容量约束 $K_i$，得到最终的供给曲线 $S_{\\text{final}}(p)$。\n4. 对于指定的评估价格，通过对离散解 $S_{\\text{final}}(p)$ 进行线性插值，返回这些价格下的供给量。\n\n所有量均为纯数学量且无量纲；不需要物理单位。将数值答案表示为浮点数。\n\n测试套件：\n提供以下三个测试用例。每个测试用例指定 $(N, c, \\text{segments}, K_i, M, \\text{eval\\_prices})$，其中 segments 是一个具有连续覆盖范围的 $(p_{\\text{lo}}, p_{\\text{hi}}, \\beta)$ 元组列表。程序必须为一个具有容量 $K_i$ 和成本 $c$ 的代表性公司计算并返回指定评估价格下的 $S_i(p)$。\n\n- 用例 A (happy path, 三个分段):\n    - $N = 3$, $c = 20$,\n    - segments $= \\{(25, 60, 0.02), (60, 95, 0.04), (95, 120, 0.06)\\}$,\n    - $K_i = 50$, $M = 241$,\n    - eval\\_prices $= [40, 60, 80, 100, 120]$。\n\n- 用例 B (两个分段, 不同的斜率组合):\n    - $N = 2$, $c = 30$,\n    - segments $= \\{(35, 80, 0.03), (80, 110, 0.05)\\}$,\n    - $K_i = 60$, $M = 151$,\n    - eval\\_prices $= [35, 75, 95, 110]$。\n\n- 用例 C (边缘案例，一个相对平坦的分段和更窄的范围):\n    - $N = 4$, $c = 10$,\n    - segments $= \\{(12, 40, 0.008), (40, 55, 0.015)\\}$,\n    - $K_i = 20$, $M = 173$,\n    - eval\\_prices $= [12, 30, 45, 55]$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含结果，格式为一个逗号分隔的列表，并用方括号括起来，其中每个元素是对应于每个测试用例按顺序在评估价格下计算出的 $S_i(p)$ 的浮点值子列表，例如 $[[s_{A,1}, s_{A,2}, \\dots], [s_{B,1}, s_{B,2}, \\dots], [s_{C,1}, s_{C,2}, \\dots]]$。",
            "solution": "该问题被评估为有效。它提出了一个在计算经济学中定义明确的任务，即供给函数均衡模型的数值求解，该模型与文章的主要内容保持一致。控制方程、边界条件和数值格式的要求是明确的。所提供的参数是自洽的，并且足以推导出一个唯一解。\n\n解决方案分为三个主要阶段：\n1.  **离散化**：我们从给定的常微分方程（ODE）开始，通过应用前向有限差分格式推导出一个递推关系。\n2.  **数值实现**：我们概述了为给定测试用例计算供给函数的算法，包括网格生成、迭代求解、施加容量约束和插值。\n3.  **代码实现**：提供符合问题规范的完整 Python 代码。\n\n**1. 通过前向有限差分进行离散化**\n为了数值求解这个ODE，我们将连续的价格域离散化为一个由 $M$ 个点组成的均匀网格 $\\{p_m\\}_{m=0}^{M-1}$，其中 $p_0 = p_{\\min}$ 且 $p_{M-1} = p_{\\max}$。网格间距为 $\\Delta p = p_{m+1} - p_m = (p_{\\max} - p_{\\min}) / (M - 1)$。令 $S_m$ 表示 $S(p_m)$ 的数值近似。\n\n我们使用前向有限差分公式来近似网格点 $p_m$ 处的一阶导数 $\\frac{d S(p)}{dp}$：\n$$\n\\frac{d S(p)}{dp}\\Bigg|_{p=p_m} \\approx \\frac{S(p_{m+1}) - S(p_m)}{\\Delta p} = \\frac{S_{m+1} - S_m}{\\Delta p}\n$$\n将此近似代入控制ODE：\n$$\n\\frac{S_{m+1} - S_m}{\\Delta p} = \\frac{S_m}{(N - 1)(p_m - c)} - \\frac{1}{\\beta_{k(m)}(N - 1)}\n$$\n其中 $\\beta_{k(m)}$ 是包含价格 $p_m$ 的分段 $k$ 的 $\\beta_k$ 值。\n\n任务是找到关于 $S_m$ 的 $S_{m+1}$ 的递推关系。我们重排方程以分离出 $S_{m+1}$：\n$$\nS_{m+1} = S_m + \\Delta p \\left( \\frac{S_m}{(N - 1)(p_m - c)} - \\frac{1}{\\beta_{k(m)}(N - 1)} \\right)\n$$\n提出 $S_m$ 因子，我们得到所需的递推关系：\n$$\nS_{m+1} = S_m \\left( 1 + \\frac{\\Delta p}{(N - 1)(p_m - c)} \\right) - \\frac{\\Delta p}{\\beta_{k(m)}(N - 1)}\n$$\n这个关系允许我们从初始条件 $S_0 = S(p_{\\min}) = 0$ 开始，逐步计算整个无约束的离散供给函数。问题保证 $N>1$ 且 $p_m > c$，因此分母不会为零。\n\n**2. 数值算法**\n解决每个测试用例的完整算法如下：\n1.  **定义网格**：根据给定的分段，确定 $p_{\\min}$ 和 $p_{\\max}$。构建一个从 $p_{\\min}$ 到 $p_{\\max}$ 大小为 $M$ 的均匀价格网格 `p_grid`。计算步长 $\\Delta p$。\n2.  **映射 Beta 参数**：创建一个大小为 $M$ 的数组 `beta_vals`，其中 `beta_vals[m]` 包含对应于包含价格 `p_grid[m]` 的分段的 $\\beta_k$ 值。如果 $p_{\\text{lo}} \\le p  p_{\\text{hi}}$，则价格 $p$ 位于分段 $(p_{\\text{lo}}, p_{\\text{hi}}, \\beta)$ 中，最终点 $p_{\\max}$ 属于最后一个分段。\n3.  **计算无约束解**：初始化一个大小为 $M$ 的数组 `S_unconstrained`，其中 `S_unconstrained[0]=0`。从 $m=0$ 迭代到 $M-2$，应用上述递推关系来计算每一步的 `S_unconstrained[m+1]`。\n4.  **应用容量约束**：创建最终解数组 `S_final`，通过对 `S_unconstrained` 的每个元素应用 `min` 函数：`S_final[m] = min(S_unconstrained[m], K_i)`。\n5.  **插值**：对于给定的评估价格 `eval_prices`，使用对离散点 $(p_m, S_{\\text{final},m})$ 的线性插值来找到在每个要求价格下的供给数量 $S(p)$。标准的数值库为此步骤提供了高效的函数。\n6.  **输出结果**：收集每个测试用例的插值数量，并按规定格式化。\n\n**3. 代码实现**\n以下 Python 代码实现了上述算法。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for the supply function equilibrium quantities for a set of test cases\n    based on the Klemperer-Meyer ODE model.\n    \"\"\"\n    test_cases = [\n        {\n            \"N\": 3, \"c\": 20,\n            \"segments\": [(25, 60, 0.02), (60, 95, 0.04), (95, 120, 0.06)],\n            \"K_i\": 50, \"M\": 241,\n            \"eval_prices\": [40, 60, 80, 100, 120]\n        },\n        {\n            \"N\": 2, \"c\": 30,\n            \"segments\": [(35, 80, 0.03), (80, 110, 0.05)],\n            \"K_i\": 60, \"M\": 151,\n            \"eval_prices\": [35, 75, 95, 110]\n        },\n        {\n            \"N\": 4, \"c\": 10,\n            \"segments\": [(12, 40, 0.008), (40, 55, 0.015)],\n            \"K_i\": 20, \"M\": 173,\n            \"eval_prices\": [12, 30, 45, 55]\n        }\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        N = case[\"N\"]\n        c = case[\"c\"]\n        segments = case[\"segments\"]\n        K_i = case[\"K_i\"]\n        M = case[\"M\"]\n        eval_prices = case[\"eval_prices\"]\n        \n        # 1. Define Grid\n        p_min = segments[0][0]\n        p_max = segments[-1][1]\n        p_grid = np.linspace(p_min, p_max, M)\n        delta_p = (p_max - p_min) / (M - 1)\n\n        # 2. Map Beta Parameter to the grid\n        beta_vals = np.zeros(M)\n        for p_lo, p_hi, beta in segments:\n            # Create a boolean mask for the segment.\n            # Handle the last segment inclusively at p_hi.\n            if p_hi == p_max:\n                mask = (p_grid = p_lo)  (p_grid = p_hi)\n            else:\n                mask = (p_grid = p_lo)  (p_grid  p_hi)\n            beta_vals[mask] = beta\n\n        # 3. Compute unconstrained solution via forward iteration\n        S_unconstrained = np.zeros(M)\n        S_unconstrained[0] = 0.0\n\n        if N == 1:\n            # The ODE is not defined for N=1. Monopoly would be a corner solution.\n            # Test cases have N > 1.\n            pass\n        else:\n            for m in range(M - 1):\n                p_m = p_grid[m]\n                S_m = S_unconstrained[m]\n                beta_k_m = beta_vals[m]\n                \n                denominator_term = (N - 1) * (p_m - c)\n                \n                term1 = S_m * (1.0 + delta_p / denominator_term)\n                term2 = delta_p / (beta_k_m * (N - 1))\n                S_unconstrained[m + 1] = term1 - term2\n        \n        # 4. Apply capacity constraint\n        S_final = np.minimum(S_unconstrained, K_i)\n\n        # 5. Interpolate to find values at evaluation prices\n        results_for_case = np.interp(eval_prices, p_grid, S_final)\n        all_results.append([float(f\"{val:.10f}\") for val in results_for_case])\n\n    final_output_str = '[' + ','.join(\n        '[' + ','.join(f\"{v:.10f}\" for v in sublist) + ']' for sublist in all_results\n    ) + ']'\n    \n    print(final_output_str)\n\nsolve()\n```"
        }
    ]
}