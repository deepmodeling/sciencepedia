{
    "hands_on_practices": [
        {
            "introduction": "我们从一个基础但至关重要的问题开始，以巩固对纳什-古诺模型的理解。这个练习要求你从第一性原理出发，为一个有$N$个对称企业的市场推导出均衡产量。通过亲自推导这个经典结果 ()，你将不仅仅是记忆公式，而是能深刻理解企业在寡头垄断市场中如何进行战略决策以实现利润最大化。",
            "id": "4106985",
            "problem": "考虑一个程式化的短期电力批发市场，其中有$N$个对称的发电公司。每个公司$i \\in \\{1,\\dots,N\\}$同时选择一个非负产量$q_{i}$以实现利润最大化，同时将所有其他公司的产量视为给定，这与纳什均衡的定义一致。总供给面临的逆剩余需求函数为$P(Q)=a-bQ$，其中$Q=\\sum_{j=1}^{N}q_{j}$是总产量，$a>0$是逆需求函数的截距，$b>0$是斜率系数。每个公司的边际成本为常数$c$，总成本为$C(q_{i})=cq_{i}$，其中$0 \\leq c  a$，且没有产能限制。假设市场由一个中央系统运营商出清，各公司在库诺（Cournot）的意义上进行数量竞争，而不是像供给函数均衡（Supply Function Equilibrium, SFE）中那样竞标供给函数。\n\n仅从利润最大化原则和数量上的纳什均衡（库诺）定义出发，不使用任何快捷公式，推导以下各项的封闭解表达式：\n1. 每个公司的对称纳什-库诺均衡产量$q^{*}$，表示为$a$、$b$、$c$和$N$的函数。\n2. 由此产生的总均衡产量$Q^{*}$。\n\n将您的最终答案以包含$q^{*}$和$Q^{*}$两个表达式的单行矩阵形式提供。不需要数值近似或四舍五入。最终答案中无需报告单位。",
            "solution": "该问题是有效的，因为它是微观经济理论中一个适定、有科学依据且客观的问题，具体涉及库诺竞争，这是能源系统分析中的一个标准模型。问题提供了所有必要信息，不包含矛盾或歧义。\n\n我们首先将任意公司$i$的利润最大化问题形式化。公司$i$的利润（表示为$\\pi_{i}$）是其总收入减去总成本。总收入是市场价格$P(Q)$乘以公司自身的产量$q_{i}$。总成本由$C(q_{i}) = cq_{i}$给出。\n\n公司$i$的利润函数是：\n$$ \\pi_{i}(q_{1}, q_{2}, \\dots, q_{N}) = P(Q)q_{i} - C(q_{i}) $$\n逆需求函数为$P(Q) = a - bQ$，其中$Q$是市场总产量，定义为$Q = \\sum_{j=1}^{N} q_{j}$。我们可以将$Q$表示为公司$i$的产量与所有其他公司总产量之和，即$Q_{-i} = \\sum_{j \\neq i} q_{j}$。因此，$Q = q_{i} + Q_{-i}$。\n\n将这些表达式代入利润函数，我们得到：\n$$ \\pi_{i}(q_{i}, Q_{-i}) = (a - b(q_{i} + Q_{-i}))q_{i} - cq_{i} $$\n展开此表达式可得：\n$$ \\pi_{i}(q_{i}, Q_{-i}) = aq_{i} - bq_{i}^{2} - bQ_{-i}q_{i} - cq_{i} $$\n\n在库诺模型中，每个公司选择其产量$q_{i}$以最大化自身利润，同时将所有其他公司的产量（$Q_{-i}$）视为固定。为了找到公司$i$的最优产量，我们对利润函数$\\pi_{i}$关于$q_{i}$求偏导数，并令其为零。这是一阶利润最大化条件。\n$$ \\frac{\\partial \\pi_{i}}{\\partial q_{i}} = \\frac{\\partial}{\\partial q_{i}} (aq_{i} - bq_{i}^{2} - bQ_{-i}q_{i} - cq_{i}) = 0 $$\n$$ a - 2bq_{i} - bQ_{-i} - c = 0 $$\n这个方程定义了公司$i$对其竞争对手产量的最优反应。我们可以解出$q_{i}$，将其表示为$Q_{-i}$的函数：\n$$ 2bq_{i} = a - c - bQ_{-i} $$\n$$ q_{i}(Q_{-i}) = \\frac{a - c - bQ_{-i}}{2b} $$\n\n纳什均衡是指所有公司同时采取其最优反应的一种状态。该问题指定了一个对称的市场结构，其中所有公司都是相同的。因此，我们寻求一个对称的纳什均衡，其中每个公司生产相同的产量，我们将其表示为$q^{*}$。在这样的均衡中，对于所有$i \\in \\{1, \\dots, N\\}$，都有$q_{i} = q^{*}$。\n\n对于任意给定的公司$i$，所有其他公司的总产量$Q_{-i}$将是其他$N-1$个公司产量之和。在对称均衡中，这等于：\n$$ Q_{-i} = \\sum_{j \\neq i} q^{*} = (N-1)q^{*} $$\n现在，我们将这个$Q_{-i}$的表达式代入最优反应函数。由于在均衡中公司$i$也生产$q^{*}$，我们有：\n$$ q^{*} = \\frac{a - c - b((N-1)q^{*})}{2b} $$\n我们现在求解这个方程以得到均衡产量$q^{*}$。\n$$ 2bq^{*} = a - c - b(N-1)q^{*} $$\n$$ 2bq^{*} = a - c - bNq^{*} + bq^{*} $$\n$$ 2bq^{*} + bNq^{*} - bq^{*} = a - c $$\n$$ bq^{*} + bNq^{*} = a - c $$\n$$ q^{*}(b + bN) = a - c $$\n$$ q^{*}b(N+1) = a - c $$\n解出$q^{*}$，我们得到每个公司的对称纳什-库诺均衡产量：\n$$ q^{*} = \\frac{a - c}{b(N+1)} $$\n条件$0 \\leq c  a$确保了$q^{*} \\geq 0$，这与问题中非负产量的约束是一致的。\n\n接下来，我们推导总均衡产量$Q^{*}$。这是所有$N$个公司生产的均衡产量之和。\n$$ Q^{*} = \\sum_{i=1}^{N} q^{*} = Nq^{*} $$\n代入$q^{*}$的表达式：\n$$ Q^{*} = N \\left( \\frac{a - c}{b(N+1)} \\right) = \\frac{N(a - c)}{b(N+1)} $$\n\n所要求的两个表达式是每个公司的均衡产量$q^{*}$和总均衡产量$Q^{*}$。",
            "answer": "$$ \\boxed{\\begin{pmatrix} \\frac{a - c}{b(N+1)}  \\frac{N(a - c)}{b(N+1)} \\end{pmatrix}} $$"
        },
        {
            "introduction": "在确定了古诺均衡之后，下一步是评估其经济效率。这个练习将我们的分析从均衡求解扩展到福利经济学，要求你计算消费者剩余、生产者剩余和总福利 ()。通过将古诺结果与完全竞争基准进行比较，你将学会量化市场势力导致的效率损失，这是能源市场分析和政策评估中的一项核心能力。",
            "id": "4106970",
            "problem": "考虑一个没有网络约束且具有单一总需求的静态批发电力市场。反需求函数由$P(Q) = \\alpha - \\beta Q$给出，其中$P$是市场出清价格，$Q$是总消费量，$\\alpha > 0$是窒息价格，$\\beta > 0$是反需求的斜率。市场中有$N$个对称的发电厂商，它们以纳什-古诺方式选择产量。每个厂商$i \\in \\{1, \\dots, N\\}$的线性可变成本为$C_i(q_i) = c\\, q_i$，其固定边际成本$c$满足$0  c  \\alpha$。假设厂商没有产能限制，也没有固定成本。\n\n从纳什-古诺均衡和剩余度量的基本定义出发，根据第一性原理推导：\n- 古诺均衡下每个厂商的产量、总产量以及由此产生的价格，\n- 古诺均衡下的消费者剩余、生产者剩余和总福利，\n- 价格接受行为下的竞争基准结果，包括消费者剩余、生产者剩余和总福利。\n\n最后，报告古诺与完全竞争总福利之比$R$，定义为古诺竞争下的总福利与完全竞争下的总福利之比。请以仅含$N$的单一闭式解析表达式给出$R$。该比率是无单位的；无需四舍五入。",
            "solution": "首先根据所需标准对问题陈述进行验证。\n\n### 第1步：提取已知条件\n-   反需求函数：$P(Q) = \\alpha - \\beta Q$\n-   $P$：市场出清价格\n-   $Q$：总消费量\n-   $\\alpha > 0$：窒息价格\n-   $\\beta > 0$：反需求的斜率\n-   $N$：对称发电厂商的数量\n-   市场结构：纳什-古诺竞争\n-   厂商$i$的成本函数：$C_i(q_i) = c\\, q_i$\n-   $c$：固定边际成本\n-   边际成本约束：$0  c  \\alpha$\n-   厂商没有产能限制，也没有固定成本。\n-   要求输出：古诺均衡结果、福利度量、竞争基准结果，以及古诺竞争下的总福利与完全竞争下的总福利之比（$R$）作为$N$的函数。\n\n### 第2步：使用提取的已知条件进行验证\n根据既定标准对问题进行评估：\n-   **科学依据**：该问题描述了具有线性需求和固定边际成本的经典纳什-古诺寡头模型。这是微观经济学和产业组织中的一个基础且成熟的模型，经常应用于能源市场。其设定是科学合理的。\n-   **适定性**：该问题是适定的。线性需求、固定边际成本以及条件$0  c  \\alpha$的假设确保了唯一且具有经济意义的纳什均衡的存在。所有必需的参数都已定义。\n-   **客观性**：问题陈述使用了精确、客观和标准的经济学术语。没有主观或含糊不清的语言。\n-   **完整性**：问题是自洽的，提供了推导指定量所需的所有必要信息（需求函数、成本结构、厂商数量、市场行为）。\n-   **现实性**：虽然这是对真实电力市场的简化（例如，无网络约束、静态模型），但它是用于分析市场力量的一种标准且科学上有效的简化方法。在模型框架内，各参数在物理上和量纲上都是一致的。\n\n### 第3步：结论与行动\n该问题是**有效的**。这是一个来自微观经济理论的标准、适定的理论问题。可以按要求从第一性原理推导出详细解法。\n\n### 古诺均衡的推导\n\n每个厂商$i$选择其产量$q_i$以最大化其利润$\\pi_i$，并将所有其他厂商的产量$Q_{-i} = \\sum_{j \\neq i} q_j$视为给定。市场总产量为$Q = q_i + Q_{-i}$。\n\n厂商$i$的利润函数是其收入减去成本：\n$$ \\pi_i(q_i, Q_{-i}) = P(Q)q_i - C_i(q_i) = (\\alpha - \\beta(q_i + Q_{-i}))q_i - c q_i $$\n为了找到利润最大化的产量，我们对$\\pi_i$关于$q_i$求一阶导数并令其为零（最大化的一阶条件）：\n$$ \\frac{\\partial \\pi_i}{\\partial q_i} = \\frac{\\partial}{\\partial q_i} [(\\alpha - c)q_i - \\beta q_i^2 - \\beta Q_{-i}q_i] = (\\alpha - c) - 2\\beta q_i - \\beta Q_{-i} = 0 $$\n这个方程定义了厂商$i$对其竞争对手产量的最佳反应。由于所有厂商都是对称的（它们有相同的成本函数），我们寻找一个对称的纳什均衡，其中所有厂商生产相同的产量，即对所有$i$都有$q_i = q_C$。\n在这种对称情况下，$Q_{-i} = (N-1)q_C$。将其代入一阶条件：\n$$ (\\alpha - c) - 2\\beta q_C - \\beta (N-1)q_C = 0 $$\n$$ (\\alpha - c) - \\beta (2 + N - 1)q_C = 0 $$\n$$ (\\alpha - c) - \\beta (N+1)q_C = 0 $$\n求解古诺均衡下每个厂商的产量$q_C$：\n$$ q_C = \\frac{\\alpha - c}{\\beta(N+1)} $$\n古诺均衡总产量$Q_C$是各个厂商产量之和：\n$$ Q_C = N q_C = \\frac{N(\\alpha - c)}{\\beta(N+1)} $$\n将$Q_C$代入反需求函数，可得古诺均衡价格$P_C$：\n$$ P_C = \\alpha - \\beta Q_C = \\alpha - \\beta \\left(\\frac{N(\\alpha - c)}{\\beta(N+1)}\\right) = \\alpha - \\frac{N(\\alpha - c)}{N+1} $$\n$$ P_C = \\frac{\\alpha(N+1) - N(\\alpha - c)}{N+1} = \\frac{\\alpha N + \\alpha - \\alpha N + Nc}{N+1} = \\frac{\\alpha + Nc}{N+1} $$\n条件$0  c  \\alpha$确保了$q_C > 0$和$P_C > c$。\n\n### 古诺均衡下的福利分析\n\n消费者剩余（CS）是需求曲线下方和市场价格$P_C$上方三角形的面积。\n$$ CS_C = \\frac{1}{2}(\\text{base}) \\times (\\text{height}) = \\frac{1}{2} Q_C (\\alpha - P_C) $$\n代入$Q_C$和$P_C$的表达式：\n$$ \\alpha - P_C = \\alpha - \\frac{\\alpha + Nc}{N+1} = \\frac{\\alpha(N+1) - (\\alpha+Nc)}{N+1} = \\frac{N(\\alpha-c)}{N+1} $$\n$$ CS_C = \\frac{1}{2} \\left(\\frac{N(\\alpha - c)}{\\beta(N+1)}\\right) \\left(\\frac{N(\\alpha-c)}{N+1}\\right) = \\frac{1}{2\\beta} \\left(\\frac{N(\\alpha-c)}{N+1}\\right)^2 $$\n生产者剩余（PS）是所有厂商的利润之和。由于没有固定成本，它等于总收入减去总可变成本。\n$$ PS_C = (P_C - c)Q_C $$\n代入$Q_C$和$(P_C - c)$的表达式：\n$$ P_C - c = \\frac{\\alpha + Nc}{N+1} - c = \\frac{\\alpha + Nc - c(N+1)}{N+1} = \\frac{\\alpha - c}{N+1} $$\n$$ PS_C = \\left(\\frac{\\alpha - c}{N+1}\\right) \\left(\\frac{N(\\alpha - c)}{\\beta(N+1)}\\right) = \\frac{N}{\\beta} \\left(\\frac{\\alpha-c}{N+1}\\right)^2 $$\n总福利（TW）是消费者剩余和生产者剩余之和。\n$$ TW_C = CS_C + PS_C = \\frac{1}{2\\beta} \\frac{N^2(\\alpha-c)^2}{(N+1)^2} + \\frac{N}{\\beta} \\frac{(\\alpha-c)^2}{(N+1)^2} $$\n$$ TW_C = \\frac{(\\alpha-c)^2}{\\beta(N+1)^2} \\left(\\frac{N^2}{2} + N\\right) = \\frac{(\\alpha-c)^2}{\\beta(N+1)^2} \\frac{N^2 + 2N}{2} $$\n$$ TW_C = \\frac{N(N+2)}{2\\beta(N+1)^2}(\\alpha-c)^2 $$\n\n### 竞争基准\n\n在完全竞争市场中，厂商是价格接受者，市场价格被压低至生产的边际成本。\n$$ P_{pc} = c $$\n总产量$Q_{pc}$由该价格下的需求决定：\n$$ P_{pc} = \\alpha - \\beta Q_{pc} \\implies c = \\alpha - \\beta Q_{pc} $$\n$$ Q_{pc} = \\frac{\\alpha - c}{\\beta} $$\n完全竞争下的消费者剩余为：\n$$ CS_{pc} = \\frac{1}{2} Q_{pc} (\\alpha - P_{pc}) = \\frac{1}{2} \\left(\\frac{\\alpha-c}{\\beta}\\right) (\\alpha - c) = \\frac{1}{2\\beta}(\\alpha-c)^2 $$\n完全竞争下的生产者剩余为零，因为价格等于边际成本且没有固定成本。\n$$ PS_{pc} = (P_{pc} - c)Q_{pc} = (c-c)Q_{pc} = 0 $$\n完全竞争下的总福利是消费者剩余和生产者剩余之和：\n$$ TW_{pc} = CS_{pc} + PS_{pc} = \\frac{1}{2\\beta}(\\alpha-c)^2 $$\n\n### 古诺与完全竞争总福利之比\n\n比率$R$定义为古诺竞争下的总福利除以完全竞争下的总福利。\n$$ R = \\frac{TW_C}{TW_{pc}} = \\frac{\\frac{N(N+2)}{2\\beta(N+1)^2}(\\alpha-c)^2}{\\frac{1}{2\\beta}(\\alpha-c)^2} $$\n分子和分母中的项$\\frac{(\\alpha-c)^2}{2\\beta}$相互抵消，留下的表达式仅依赖于$N$。\n$$ R = \\frac{N(N+2)}{(N+1)^2} $$\n这就是福利比率的最终闭式解析表达式。",
            "answer": "$$\\boxed{\\frac{N(N+2)}{(N+1)^2}}$$"
        },
        {
            "introduction": "最后，我们从代数方法转向更高级的计算建模，探索在电力市场中更为现实的供给函数均衡 (SFE) 模型。该模型假设企业提交的是供给曲线而非单一产量，其均衡由一个微分方程刻画。此练习 () 要求你将此方程离散化并实施一个数值求解器，这让你能够体验从理论到实际编程的完整过程，掌握现代能源系统建模的核心计算技术。",
            "id": "4106987",
            "problem": "考虑一个有$N$家公司的设定，这些公司提交非递减、可微的供给函数$S_i(p)$，该函数将市场价格$p$映射到一个数量。同时，存在一个定义在数量$Q$上的分段线性反需求函数$P(Q)$，在其反需求为线性的每个连续数量区间内，$P(Q)$具有恒定的负斜率。等价地，在每个连续的价格区间上，反需求可以通过每个分段的恒定斜率参数来描述。每家公司$i$都有一个凸性、可微的成本函数$C_i(q)$，其边际成本为常数$C_i'(q) = c_i$，其中$c_i$严格小于所考虑的最低价格。在供给函数均衡中，公司选择函数$S_i(p)$以在不确定的需求截距产生的每个可能实现的价格$p$下最大化利润，同时满足市场出清的条件。\n\n从基本定义出发：\n- 公司$i$在实现价格$p$及其供给数量$q_i = S_i(p)$下的利润为$\\pi_i(p) = p \\, S_i(p) - C_i(S_i(p))$。\n- 市场出清要求在实现价格$p$时$\\sum_{j=1}^N S_j(p) = Q(p)$，其中$Q(p)$是由不确定需求截距引起的价格为$p$时的需求量。\n\n假设反需求是标准形式的分段线性函数$P(Q) = \\alpha_k - \\beta_k Q$，在每个分段$k$上$\\beta_k > 0$，因此在分段$k$内，数量对价格变化的敏感度是恒定的，由$\\frac{dQ}{dp} = -\\frac{1}{\\beta_k}$给出。进一步假设公司是同质的，具有相同的恒定边际成本$c_i = c$和内部活动（即在每个价格分段的内部没有约束性的角点解）。从基本原理出发，推导在此设定下供给函数均衡的必要局部最优性条件，该条件为每个公司$i$在需求分段$k$内，得出一个关于连续价格$p$的一阶线性微分方程，形式如下\n$$\n\\bigl(p - c\\bigr) \\, \\frac{d S_i(p)}{dp} + S_i(p) = \\frac{\\lambda_i}{\\beta_k},\n$$\n其中$\\lambda_i$是一个由均衡选择和边界条件决定的、与分段无关的常数。然后，在间距为$\\Delta p = p_{m+1} - p_m$的均匀价格网格$\\{p_m\\}_{m=0}^{M-1}$上，使用前向有限差分格式构建一个离散模拟，从而对分段$k$内的内部点，您将得到以下递推关系\n$$\nS_{i,m+1} = S_{i,m} \\left( 1 - \\frac{\\Delta p}{p_m - c} \\right) + \\frac{\\Delta p}{p_m - c} \\cdot \\frac{\\lambda_i}{\\beta_k},\n$$\n以及在最大价格下给定公司特定容量$K_i$的边界条件$S_i(p_{\\min}) = 0$和$S_i(p_{\\max}) = K_i$。使用打靶法论证，说明关于$\\lambda_i$的线性意味着只需用$\\lambda_i = 1$求解该格式一次，然后将得到的离散解乘以一个因子进行缩放，以精确满足$S_i(p_{\\max}) = K_i$。\n\n实现一个完整的程序，该程序：\n- 构建一个跨越所有分段并集的均匀价格网格。\n- 应用上述有限差分递推关系，以基准值$\\lambda_i = 1$获得离散解$\\widehat{S}_i(p_m)$。\n- 通过$\\lambda_i = K_i / \\widehat{S}_i(p_{\\max})$对解进行缩放，以强制满足$S_i(p_{\\max}) = K_i$。\n- 对于指定的评估价格，通过对离散解进行线性插值，返回这些价格下的$S_i(p)$。\n\n所有量都纯粹是数学上的且无量纲；不需要物理单位。不涉及角度。数值答案以浮点数表示。\n\n测试套件：\n提供以下三个测试用例。每个测试用例指定$(N, c, \\text{segments}, K_i, M, \\text{eval\\_prices})$，其中segments是一个具有连续覆盖范围的$(p_{\\text{lo}}, p_{\\text{hi}}, \\beta)$元组列表。程序必须为具有容量$K_i$和相同成本$c$的代表性公司$i$，计算并返回指定评估价格下的$S_i(p)$。\n\n- 用例 A（正常路径，三个分段）：\n    - $N = 3$, $c = 20$,\n    - segments $= \\{(25, 60, 0.02), (60, 95, 0.04), (95, 120, 0.06)\\}$,\n    - $K_i = 50$, $M = 241$,\n    - eval\\_prices $= [40, 60, 80, 100, 120]$。\n\n- 用例 B（两个分段，不同斜率组合）：\n    - $N = 2$, $c = 30$,\n    - segments $= \\{(35, 80, 0.03), (80, 110, 0.05)\\}$,\n    - $K_i = 60$, $M = 151$,\n    - eval\\_prices $= [35, 75, 95, 110]$。\n\n- 用例 C（边缘情况，包含一个相对平坦的分段和更窄的范围）：\n    - $N = 4$, $c = 10$,\n    - segments $= \\{(12, 40, 0.008), (40, 55, 0.015)\\}$,\n    - $K_i = 20$, $M = 173$,\n    - eval\\_prices $= [12, 30, 45, 55]$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，其中每个元素是对应于按顺序排列的每个测试用例在评估价格下计算出的$S_i(p)$的浮点值子列表，例如$[[s_{A,1}, s_{A,2}, \\dots], [s_{B,1}, s_{B,2}, \\dots], [s_{C,1}, s_{C,2}, \\dots]]$。",
            "solution": "该问题经评估为有效。它提出了一个在计算经济学中定义明确的任务，具体来说是供给函数均衡模型的数值求解。控制方程、边界条件和数值格式都得到了明确的指定。所提供的参数是自洽的，并且足以推导出唯一解。\n\n求解过程分为四个主要阶段：\n1.  **主导微分方程的陈述**：我们从给定的常微分方程（ODE）开始，该方程描述了在给定需求分段$k$内，公司的最优供给函数$S_i(p)$。\n2.  **离散化**：我们通过对常微分方程应用前向有限差分格式，推导出指定的递推关系。\n3.  **打靶法**：我们形式化用于满足边界条件的打靶法，利用系统的线性来确定未知常数$\\lambda_i$。\n4.  **数值实现**：我们概述了为给定测试用例计算供给函数的算法，包括网格生成、迭代求解、缩放和插值。\n\n**1. 主导微分方程**\n问题指出，根据供给函数均衡中利润最大化的基本原理，对于具有恒定边际成本$c$的公司$i$，其最优供给函数$S_i(p)$在分段线性反需求函数的分段$k$内的价格$p$处，必须满足以下一阶线性常微分方程：\n$$\n\\bigl(p - c\\bigr) \\, \\frac{d S_i(p)}{dp} + S_i(p) = \\frac{\\lambda_i}{\\beta_k}\n$$\n在此，$\\beta_k > 0$是分段$k$的反需求斜率的负数，而$\\lambda_i$是公司$i$的一个常数，由跨所有分段的均衡条件确定。该方程的左侧等价于乘积$(p-c)S_i(p)$的导数，该乘积代表公司的单位加价乘以其数量。\n\n**2. 通过前向有限差分的离散化**\n为了数值求解这个常微分方程，我们将连续价格域离散化为一个包含$M$个点的均匀网格$\\{p_m\\}_{m=0}^{M-1}$，其中$p_0 = p_{\\min}$且$p_{M-1} = p_{\\max}$。网格间距为$\\Delta p = p_{m+1} - p_m = (p_{\\max} - p_{\\min}) / (M - 1)$。令$S_{i,m}$表示$S_i(p_m)$的数值近似。\n\n我们使用前向有限差分公式来近似网格点$p_m$处的一阶导数$\\frac{d S_i(p)}{dp}$：\n$$\n\\frac{d S_i(p)}{dp}\\Bigg|_{p=p_m} \\approx \\frac{S_i(p_{m+1}) - S_i(p_m)}{\\Delta p} = \\frac{S_{i,m+1} - S_{i,m}}{\\Delta p}\n$$\n将此近似代入主导常微分方程，我们为每个内部网格点$m \\in \\{0, 1, \\dots, M-2\\}$得到一个代数方程：\n$$\n(p_m - c) \\left( \\frac{S_{i,m+1} - S_{i,m}}{\\Delta p} \\right) + S_{i,m} = \\frac{\\lambda_i}{\\beta_{k(m)}}\n$$\n其中$\\beta_{k(m)}$是包含价格$p_m$的分段$k$对应的$\\beta_k$值。\n\n任务是找到一个关于$S_{i,m}$的$S_{i,m+1}$的递推关系。我们重新整理方程以分离出$S_{i,m+1}$：\n$$\n(p_m - c) (S_{i,m+1} - S_{i,m}) = \\Delta p \\left( \\frac{\\lambda_i}{\\beta_{k(m)}} - S_{i,m} \\right)\n$$\n$$\nS_{i,m+1} - S_{i,m} = \\frac{\\Delta p}{p_m - c} \\left( \\frac{\\lambda_i}{\\beta_{k(m)}} - S_{i,m} \\right)\n$$\n$$\nS_{i,m+1} = S_{i,m} + \\frac{\\Delta p}{p_m - c} \\frac{\\lambda_i}{\\beta_{k(m)}} - \\frac{\\Delta p}{p_m - c} S_{i,m}\n$$\n提出因子$S_{i,m}$得到问题陈述中指定的最终递推关系：\n$$\nS_{i,m+1} = S_{i,m} \\left( 1 - \\frac{\\Delta p}{p_m - c} \\right) + \\frac{\\Delta p}{p_m - c} \\cdot \\frac{\\lambda_i}{\\beta_{k(m)}}\n$$\n这个递推关系使我们能够从一个初始条件开始，一步一步地计算出整个离散供给函数。\n\n**3. 打靶法**\n这个问题是一个带有末端边界条件的初值问题。我们有两个给定的边界条件：$S_i(p_{\\min}) = 0$和$S_i(p_{\\max}) = K_i$，其中$p_{\\min}$是域中的最低价格，$p_{\\max}$是最高价格，$K_i$是公司的容量。递推关系依赖于未知常数$\\lambda_i$。打靶法提供了一种找到正确的$\\lambda_i$值的方法，以确保最终的边界条件$S_i(p_{\\max}) = K_i$得以满足。\n\n关键的洞见在于递推关系相对于$\\lambda_i$是线性的。令$S_{i,m}(\\lambda_i)$表示在给定$\\lambda_i$时第$m$步的解。初始条件为$S_{i,0} = S_i(p_{\\min}) = 0$，这与$\\lambda_i$无关。如果我们假设$S_{i,m}$是$\\lambda_i$的线性函数，递推关系表明$S_{i,m+1}$也是$S_{i,m}$和一个关于$\\lambda_i$的线性项的线性组合，因此保持了线性。此外，由于$S_{i,0}=0$，解的齐次部分为零，这意味着$S_{i,m}(\\lambda_i)$不仅是线性的，而且与$\\lambda_i$成正比。令$\\widehat{S}_{i,m}$为设置$\\lambda_i = 1$时得到的解。那么对于任意$\\lambda_i$的通解就是$S_{i,m} = \\lambda_i \\widehat{S}_{i,m}$。\n\n因此，我们可以使用以下步骤：\n1.  设置一个基准值$\\lambda_i = 1$。\n2.  从$\\widehat{S}_{i,0} = 0$开始求解递推关系，以找到完整的试探解$\\widehat{S}_i = \\{\\widehat{S}_{i,m}\\}_{m=0}^{M-1}$。\n3.  在最终价格点$p_{M-1} = p_{\\max}$处评估此试探解，得到$\\widehat{S}_{i,M-1}$。\n4.  使用比例关系$S_{i,M-1} = \\lambda_i \\widehat{S}_{i,M-1}$和边界条件$S_{i,M-1} = K_i$来求解正确的$\\lambda_i$：\n    $$\n    K_i = \\lambda_i \\widehat{S}_{i,M-1} \\implies \\lambda_i = \\frac{K_i}{\\widehat{S}_{i,M-1}}\n    $$\n5.  最终的、正确的离散供给函数通过缩放试探解得到：$S_i = \\lambda_i \\widehat{S}_i$。\n\n**4. 数值算法与实现**\n解决每个测试用例的完整算法如下：\n1.  **定义网格**：根据给定的分段，确定$p_{\\min}$和$p_{\\max}$。构建一个从$p_{\\min}$到$p_{\\max}$、大小为$M$的均匀价格网格 `p_grid`。计算步长$\\Delta p$。\n2.  **映射 Beta 参数**：创建一个大小为$M$的数组 `beta_vals`，其中 `beta_vals[m]` 包含与价格 `p_grid[m]` 所在分段对应的$\\beta_k$值。如果$p_{\\text{lo}} \\le p  p_{\\text{hi}}$，则价格$p$属于分段$(p_{\\text{lo}}, p_{\\text{hi}}, \\beta)$，最终点$p_{\\max}$属于最后一个分段。\n3.  **计算试探解**：初始化一个大小为$M$的数组$\\widehat{S}_i$，其中$\\widehat{S}_{i,0}=0$。从$m=0$迭代到$M-2$，应用$\\lambda_i=1$的递推关系，在每一步计算$\\widehat{S}_{i,m+1}$。\n4.  **缩放解**：计算缩放因子$\\lambda_i = K_i / \\widehat{S}_{i,M-1}$。计算最终解数组$S_i = \\lambda_i \\widehat{S}_i$。这保证了$S_{i,0}=0$和$S_{i,M-1} = K_i$。\n5.  **插值**：对于给定的评估价格，在离散点$(p_m, S_{i,m})$上使用线性插值，以找到每个请求价格下的供给数量$S_i(p)$。标准数值库为此步骤提供了高效的函数。\n6.  **输出结果**：收集每个测试用例的插值数量，并按指定格式进行格式化。\n此过程将为所提供的每个测试用例实现。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for the supply function equilibrium quantities for a set of test cases.\n    \"\"\"\n    test_cases = [\n        {\n            \"N\": 3, \"c\": 20,\n            \"segments\": [(25, 60, 0.02), (60, 95, 0.04), (95, 120, 0.06)],\n            \"K_i\": 50, \"M\": 241,\n            \"eval_prices\": [40, 60, 80, 100, 120]\n        },\n        {\n            \"N\": 2, \"c\": 30,\n            \"segments\": [(35, 80, 0.03), (80, 110, 0.05)],\n            \"K_i\": 60, \"M\": 151,\n            \"eval_prices\": [35, 75, 95, 110]\n        },\n        {\n            \"N\": 4, \"c\": 10,\n            \"segments\": [(12, 40, 0.008), (40, 55, 0.015)],\n            \"K_i\": 20, \"M\": 173,\n            \"eval_prices\": [12, 30, 45, 55]\n        }\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        c = case[\"c\"]\n        segments = case[\"segments\"]\n        K_i = case[\"K_i\"]\n        M = case[\"M\"]\n        eval_prices = case[\"eval_prices\"]\n        \n        # 1. Define Grid\n        p_min = segments[0][0]\n        p_max = segments[-1][1]\n        p_grid = np.linspace(p_min, p_max, M)\n        delta_p = (p_max - p_min) / (M - 1)\n\n        # 2. Map Beta Parameter to the grid\n        beta_vals = np.zeros(M)\n        for p_lo, p_hi, beta in segments:\n            indices = np.where((p_grid = p_lo)  (p_grid  p_hi))\n            beta_vals[indices] = beta\n        # The last point at p_max is included in the last segment\n        beta_vals[-1] = segments[-1][2]\n\n        # 3. Compute Tentative Solution (Shooting with lambda_i = 1)\n        S_hat = np.zeros(M)\n        S_hat[0] = 0.0\n        lambda_baseline = 1.0\n\n        for m in range(M - 1):\n            p_m = p_grid[m]\n            S_im = S_hat[m]\n            beta_k = beta_vals[m]\n            \n            # The problem guarantees p>c, so p_m - c > 0\n            if p_m - c == 0:\n                # This should not happen based on problem constraints c  p_min.\n                # If it did, the derivative would explode. We handle this defensively.\n                # For this problem, we rely on the guarantee.\n                pass\n\n            term1 = S_im * (1.0 - delta_p / (p_m - c))\n            term2 = (delta_p / (p_m - c)) * (lambda_baseline / beta_k)\n            S_hat[m + 1] = term1 + term2\n\n        # 4. Scale Solution\n        S_hat_max = S_hat[-1]\n        lambda_i = K_i / S_hat_max if S_hat_max != 0 else 0\n        S_final = lambda_i * S_hat\n\n        # 5. Interpolate to find values at evaluation prices\n        results_for_case = np.interp(eval_prices, p_grid, S_final)\n        all_results.append([float(f\"{val:.10f}\") for val in results_for_case])\n    \n    # Format the final output string\n    # e.g., [[val1,val2],[val3,val4]]\n    # Python's str() on a list of lists adds spaces, so we build it manually.\n    final_output_str = '[' + ','.join(\n        '[' + ','.join(map(str, sublist)) + ']' for sublist in all_results\n    ) + ']'\n    \n    print(final_output_str)\n\nsolve()\n```"
        }
    ]
}