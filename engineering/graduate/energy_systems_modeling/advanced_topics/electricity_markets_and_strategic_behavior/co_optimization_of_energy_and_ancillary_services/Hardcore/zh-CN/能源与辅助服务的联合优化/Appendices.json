{
    "hands_on_practices": [
        {
            "introduction": "在理想化的电力市场模型中，调度决策仅基于边际成本。然而，现实世界中的发电机组受到最小稳定出力等非凸性约束，这使得联合优化变得复杂。本练习将通过一个经典案例，揭示辅助服务需求如何改变机组组合决策，并阐明为何在边际定价机制下必须引入增补支付（uplift payment）以确保系统可靠性。",
            "id": "4078317",
            "problem": "考虑一个电力系统中能量和旋转备用的单周期、单母线协同优化问题。系统运营商必须同时满足一个固定的能量需求和一个旋转备用要求。该系统包含两种资源：\n\n1. 一台风电机组，其可变能量成本为 $c_{W} = 0$ 美元/兆瓦时，最大可用功率为 $P_{W}^{\\max} = 100$ 兆瓦，且不具备提供旋转备用的能力。\n\n2. 一台火电机组，其可变能量成本为 $c_{T} = 40$ 美元/兆瓦时，最小稳定出力为 $P_{T}^{\\min} = 15$ 兆瓦，最大出力为 $P_{T}^{\\max} = 75$ 兆瓦，其向上旋转备用能力受限于 $R_{T} \\leq P_{T}^{\\max} - P_{T}$。该火电机组的空载成本为 $F = 600$ 美元/小时，启动成本为 $S = 900$ 美元/次。假设该火电机组从离线状态启动。\n\n设能量需求为 $D = 100$ 兆瓦，旋转备用要求为 $R^{\\mathrm{req}} = 30$ 兆瓦。假设除了出力空间限制所隐含的机会成本外，提供备用没有单独的边际成本。\n\n从最低成本调度和协同优化的第一性原理出发：将原始问题建模为在满足能量平衡、备用要求和机组能力约束（包括最小出力和备用能力）的条件下，最小化总生产成本，并将价格定义为在给定启停状态下凸松弛问题中相应约束的拉格朗日乘子。\n\n在标准边际定价下，系统按节点边际电价（LMP）支付能量费用，按旋转备用出清价格（SRCP）支付备用费用。将增补支付（uplift）定义为：当火电机组在边际价格下的市场收入（能量加备用）不足以覆盖其实际成本（可变能量成本、空载成本和启动成本）时，为确保其在结算周期内的净利润为零所需的最小非负支付。\n\n构建并分析协同优化调度，以展示一个案例，在该案例中，即使能量LMP低于其边际能量成本，旋转备用要求也驱动了火电机组的启机。分别从能量平衡和备用要求的拉格朗日对偶中推导LMP和SRCP，并计算火电机组在一小时结算周期内所需的增补支付。以美元表示最终的增补支付。无需四舍五入；提供精确值。",
            "solution": "在尝试求解之前，将根据指定标准对问题进行验证。\n\n### 第1步：提取已知条件\n-   风电机组可变成本：$c_{W} = 0$ 美元/兆瓦时\n-   风电机组最大功率：$P_{W}^{\\max} = 100$ 兆瓦\n-   风电机组备用能力：$0$\n-   火电机组可变成本：$c_{T} = 40$ 美元/兆瓦时\n-   火电机组最小稳定出力：$P_{T}^{\\min} = 15$ 兆瓦\n-   火电机组最大出力：$P_{T}^{\\max} = 75$ 兆瓦\n-   火电机组向上旋转备用能力：$R_{T} \\leq P_{T}^{\\max} - P_{T}$\n-   火电机组空载成本：$F = 600$ 美元/小时\n-   火电机组启动成本：$S = 900$ 美元/次（从离线状态）\n-   能量需求：$D = 100$ 兆瓦\n-   旋转备用要求：$R^{\\mathrm{req}} = 30$ 兆瓦\n-   结算周期：$1$ 小时\n\n### 第2步：使用提取的已知条件进行验证\n该问题具有科学依据，是适定且客观的。这是一个来自电力系统工程和电力市场设计领域的标准（尽管简化了）的机组组合和经济调度问题。参数是自洽和一致的，术语（LMP、SRCP、uplift）在该领域是标准的。该问题不违反任何科学原理，不是比喻性的，不是不完整或矛盾的，也不是微不足道的。它展示了一个经典的案例，说明了在具有非凸发电机约束的市场中需要增补支付。\n\n### 第3步：结论和行动\n问题有效。将提供解答。\n\n系统运营商旨在最小化的总系统成本是已启机组的成本之和。火电机组的成本包括启动成本、空载成本（如果启机）和可变能量成本。风电机组只有可变能量成本。设 $u_T \\in \\{0, 1\\}$ 为火电机组的二进制启停变量，其中 $u_T=1$ 表示机组在线，$u_T=0$ 表示机组离线。设 $P_W$ 和 $P_T$ 分别为风电和火电机组的能量调度量，设 $R_T$ 为火电机组提供的旋转备用。\n\n协同优化问题可以表述为混合整数线性规划：\n$$\n\\min_{u_T, P_W, P_T, R_T} \\quad C = c_W P_W + c_T P_T + u_T (F + S)\n$$\n约束条件：\n1.  能量平衡：$P_W + P_T = D$\n2.  备用要求：$R_T \\ge R^{\\mathrm{req}}$ (因为只有火电机组提供备用)\n3.  风电机组容量：$0 \\le P_W \\le P_W^{\\max}$\n4.  火电机组容量：$u_T P_T^{\\min} \\le P_T \\le u_T P_T^{\\max}$\n5.  火电机组备用出力空间：$P_T + R_T \\le u_T P_T^{\\max}$\n6.  备用非负性：$R_T \\ge 0$\n7.  二进制启停变量：$u_T \\in \\{0, 1\\}$\n\n代入给定值：\n$$\n\\min_{u_T, P_W, P_T, R_T} \\quad C = (0) P_W + 40 P_T + u_T (600 + 900) = 40 P_T + 1500 u_T\n$$\n约束条件：\n1.  $P_W + P_T = 100$\n2.  $R_T \\ge 30$\n3.  $0 \\le P_W \\le 100$\n4.  $15 u_T \\le P_T \\le 75 u_T$\n5.  $P_T + R_T \\le 75 u_T$\n\n我们通过考虑 $u_T$ 的两种可能情况来解决这个问题。\n\n情况1：火电机组离线 ($u_T = 0$)。\n约束变为：$P_T = 0$ 且 $R_T = 0$。\n备用要求 $R_T \\ge 30$ 变为 $0 \\ge 30$，这是不成立的。\n因此，这种情况不可行。必须启机火电机组以满足旋转备用要求。\n\n情况2：火电机组在线 ($u_T = 1$)。\n问题变为一个线性规划问题，以找到最优调度：\n$$\n\\min_{P_W, P_T, R_T} \\quad C = 40 P_T + 1500\n$$\n约束条件：\n1.  $P_W + P_T = 100$\n2.  $R_T \\ge 30$\n3.  $0 \\le P_W \\le 100$\n4.  $15 \\le P_T \\le 75$\n5.  $P_T + R_T \\le 75$\n\n为了最小化成本 $C$，我们必须最小化 $P_T$。\n根据能量平衡，$P_W = 100 - P_T$。将其代入风电容量约束，得到 $0 \\le 100 - P_T \\le 100$，这意味着 $0 \\le P_T \\le 100$。结合火电机组的容量约束 ($15 \\le P_T \\le 75$)， $P_T$ 的有效范围是 $[15, 75]$。\n目标函数在 $P_T$ 的最低可能值处最小化，即 $P_T^* = 15$ 兆瓦。\n让我们检查此调度是否满足备用约束。\n当 $P_T^* = 15$ 时，备用出力空间约束为 $15 + R_T \\le 75$，这意味着 $R_T \\le 60$。\n系统要求 $R_T \\ge 30$。\n由于 $R_T$ 的范围 $[30, 60]$ 是有效的，因此存在可行解。系统运营商将采购所需的最小量，所以 $R_T^* = 30$ 兆瓦。\n相应的风电调度为 $P_W^* = 100 - P_T^* = 100 - 15 = 85$ 兆瓦。这在风电机组的容量范围内。\n\n最优调度为：$P_T^* = 15$ 兆瓦, $P_W^* = 85$ 兆瓦, 且 $R_T^* = 30$ 兆瓦。\n该调度表明，尽管有足够便宜的风电容量来满足全部能量需求，但由于备用要求，火电机组被启机 ($u_T=1$)。\n总系统成本为 $C^* = 40(15) + 1500 = 600 + 1500 = 2100$ 美元。\n\n接下来，我们从松弛后的线性规划（其中 $u_T=1$）的对偶问题中推导市场出清价格LMP和SRCP。目标函数的可变成本部分是 $40 P_T$。\n设 $\\lambda$ 为能量平衡约束的拉格朗日乘子（LMP），$\\mu$ 为备用要求约束的乘子（SRCP）。\n\n可变成本最小化的拉格朗日函数是：\n$L = 40 P_T - \\lambda(P_W + P_T - 100) - \\mu(R_T - 30) - \\nu(75 - P_T - R_T) - \\alpha(P_T - 15) - ...$\n（包括所有约束的乘子）。\n最优性的Karush-Kuhn-Tucker（KKT）条件包括：\n$\\frac{\\partial L}{\\partial P_W} = -\\lambda - \\gamma_W = 0$，其中 $\\gamma_W$ 是风电容量的乘子，由于 $P_W^* = 85$ 未达到其边界，所以 $\\gamma_W$ 为 $0$。因此，$\\lambda=0$。\n$\\frac{\\partial L}{\\partial P_T} = 40 - \\lambda - \\alpha + \\nu = 0$，其中 $\\alpha$ 对应于 $P_T \\ge 15$ 而 $\\nu$ 对应于 $P_T+R_T \\le 75$。\n$\\frac{\\partial L}{\\partial R_T} = -\\mu + \\nu = 0 \\implies \\mu = \\nu$。\n\n在最优解（$P_T^*=15$, $R_T^*=30$）处：\n-   能量价格是LMP, $\\lambda$。由于能量的边际机组是风电（$c_W=0$）并且它有剩余容量（$P_W^*=85  P_W^{\\max}=100$），额外一兆瓦能量的成本为零。因此，LMP $=\\lambda=0\\ \\text{\\$/MWh}$。\n-   备用价格是SRCP, $\\mu$。在最优点，$P_T^* + R_T^* = 15 + 30 = 45  75$。火电机组有剩余容量提供更多备用而无需减少其能量输出。约束 $P_T+R_T \\le 75$ 不是紧约束，因此其对偶变量 $\\nu = 0$。由于 $\\mu=\\nu$，因此SRCP $=\\mu=0\\ \\text{\\$/MW-h}$。\n\nLMP $=0$ 和 SRCP $=0$ 这个结果是基于松弛凸问题定价的后果，其中非凸的最小出力约束是调度的主要驱动因素，但其成本未在边际价格中反映出来。\n\n最后，我们计算火电机组的增补支付。增补支付是弥补未通过能量和备用市场收回的成本所需的款项。\n火电机组的市场收入：\n$$\n\\text{Revenue} = (\\text{LMP} \\times P_T^*) + (\\text{SRCP} \\times R_T^*) = (0\\ \\text{\\$/MWh} \\times 15 \\text{ MW} \\times 1 \\text{ h}) + (0\\ \\text{\\$/MW-h} \\times 30 \\text{ MW}) = \\$0\n$$\n计算是针对 $1$ 小时周期的。\n火电机组的总成本：\n$$\n\\text{Cost} = (\\text{Variable Cost}) + (\\text{No-Load Cost}) + (\\text{Startup Cost})\n$$\n$$\n\\text{Cost} = (c_T \\times P_T^* \\times 1 \\text{ h}) + F + S = (40 \\$/\\text{MWh} \\times 15 \\text{ MW} \\times 1 \\text{ h}) + \\$600 + \\$900 = \\$600 + \\$600 + \\$900 = \\$2100\n$$\n机组从市场运营中的利润为 收入 - 成本 = $\\$0 - \\$2100 = -\\$2100$。\n增补支付必须使净利润为零。\n$$\n\\text{Uplift} = -(\\text{Profit}) = -(-\\$2100) = \\$2100\n$$",
            "answer": "$$\\boxed{2100}$$"
        },
        {
            "introduction": "随着储能系统在电网中扮演日益重要的角色，如何最大化其经济效益成为一个核心问题。本练习将指导您为一个电化学储能电池构建联合优化模型，使其能够同时提供调频和备用服务，从而实现收入叠加。您需要将电池的物理特性，如充放电效率和退化成本，精确地整合到您的优化模型中，以做出最优的容量分配决策。",
            "id": "4078365",
            "problem": "你需要形式化并解决一个协同优化问题，其中单个电化学电池在一个小时的时间间隔内同时提供应急备用和调频服务。决策变量是调频容量 $r$（单位为 $\\mathrm{MW}$）和应急备用容量 $c$（单位为 $\\mathrm{MW}$）。该电池的特性是具有最大充放电功率等级 $P_{\\max}$（单位为 $\\mathrm{MW}$）和可用于一小时内非计划性变动（相对于基线能量计划）的能量裕度 $S$（单位为 $\\mathrm{MWh}$）。电池的往返效率为 $\\eta \\in (0,1)$，并且会产生与绝对能量吞吐量成正比的退化成本。调频容量可获得容量费用 $\\pi^{\\mathrm{reg}}$（单位为货币/$\\mathrm{MW}$/小时），应急备用容量可获得容量费用 $\\pi^{\\mathrm{cont}}$（单位为货币/$\\mathrm{MW}$/小时）。退化成本参数 $c_{\\mathrm{deg}}$ 的单位为货币/$\\mathrm{MWh}$（绝对能量吞吐量）。\n\n基本原理和物理现实性：\n- 一小时内与任何服务相关的绝对能量吞吐量定义为，放电能量的大小与恢复到初始充电状态所需的再充电能量大小之和。根据能量守恒和往返效率的定义，如果电池放电 $x$（单位为 $\\mathrm{MWh}$）并且必须恢复到初始充电状态，则所需的再充电能量为 $x/\\eta$。因此，与该事件相关的绝对吞吐量为 $x + x/\\eta$。\n- 对于调频服务，令 $\\gamma$（单位为 $\\mathrm{MWh}$/$\\mathrm{MW}$/小时）表示每 $\\mathrm{MW}$ 调频容量在一小时内预期的放电侧能量变动；这个 $\\gamma$ 捕捉了放电侧的统计强度（有时称为里程）。对于应急备用，令 $p$ 为一小时内激活的概率， $d$ 为激活条件下预期的激活持续时间（单位为小时）；那么每 $\\mathrm{MW}$ 应急备用容量的预期放电侧能量为 $p \\cdot d$。使用上述能量守恒原则，将这些放电侧能量映射为每种产品的单位容量（$\\mathrm{MW}$）绝对吞吐量。\n- 能量裕度 $S$ 必须足以在所选容量下将电池状态维持在允许的充电状态限制内。为抽象化不同的运行策略，假设存在固定的能量裕度系数 $e^{\\mathrm{reg}}$（单位为 $\\mathrm{MWh}$/$\\mathrm{MW}$）和 $e^{\\mathrm{cont}}$（单位为 $\\mathrm{MWh}$/$\\mathrm{MW}$），使得 $e^{\\mathrm{reg}} \\cdot r + e^{\\mathrm{cont}} \\cdot c \\le S$ 能够确保在所选容量下能量限制的可行性。这是在规划层面用于保证充电状态可行性的一种标准线性鲁棒性替代方法。\n\n你的任务：\n- 将该协同优化问题形式化为一个关于 $r$ 和 $c$ 的每小时净利润最大化问题，并受物理约束限制。净利润目标是容量收入总和减去根据绝对吞吐量计算的退化成本。你必须仅使用上述基本定义来构建吞吐量和约束条件；除了这些基础知识外，不得假设任何外部的简化方法。\n- 可行集必须包括功率约束 $r + c \\le P_{\\max}$ 和能量裕度约束 $e^{\\mathrm{reg}} \\cdot r + e^{\\mathrm{cont}} \\cdot c \\le S$，以及非负约束 $r \\ge 0$ 和 $c \\ge 0$。\n- 对于每个测试案例，计算在给定参数下使净利润最大化的最优对 $(r^{\\star}, c^{\\star})$。\n\n单位和输出：\n- 以 $\\mathrm{MW}$ 为单位表示 $r^{\\star}$ 和 $c^{\\star}$，四舍五入到三位小数。\n- 你的程序应生成单行输出，包含所有测试案例的结果，形式为一个列表的列表，其中每个内部列表为 $[r^{\\star}, c^{\\star}]$。例如，格式必须严格如 $[[r_1,c_1],[r_2,c_2],\\dots]$，数字采用十进制形式。\n\n测试套件：\n使用以下四个测试案例来验证模型和算法。每个测试案例指定 $(P_{\\max}, S, \\eta, c_{\\mathrm{deg}}, \\pi^{\\mathrm{reg}}, \\pi^{\\mathrm{cont}}, \\gamma, p, d, e^{\\mathrm{reg}}, e^{\\mathrm{cont}})$ 及其单位。\n- 案例1（理想情况，功率受限于调频）：$P_{\\max} = 100\\,\\mathrm{MW}$，$S = 40\\,\\mathrm{MWh}$，$\\eta = 0.9$，$c_{\\mathrm{deg}} = 10$，$\\pi^{\\mathrm{reg}} = 30$，$\\pi^{\\mathrm{cont}} = 15$，$\\gamma = 0.5$，$p = 0.1$，$d = 0.25$，$e^{\\mathrm{reg}} = 0.2$，$e^{\\mathrm{cont}} = 0.25$。\n- 案例2（能量约束且调频边际收益为负，应急备用优先）：$P_{\\max} = 100\\,\\mathrm{MW}$，$S = 40\\,\\mathrm{MWh}$，$\\eta = 0.9$，$c_{\\mathrm{deg}} = 40$，$\\pi^{\\mathrm{reg}} = 30$，$\\pi^{\\mathrm{cont}} = 15$，$\\gamma = 0.5$，$p = 0.1$，$d = 0.25$，$e^{\\mathrm{reg}} = 0.2$，$e^{\\mathrm{cont}} = 0.5$。\n- 案例3（强能量约束，应急备用更有价值）：$P_{\\max} = 100\\,\\mathrm{MW}$，$S = 10\\,\\mathrm{MWh}$，$\\eta = 0.9$，$c_{\\mathrm{deg}} = 10$，$\\pi^{\\mathrm{reg}} = 20$，$\\pi^{\\mathrm{cont}} = 25$，$\\gamma = 0.5$，$p = 0.1$，$d = 0.25$，$e^{\\mathrm{reg}} = 0.25$，$e^{\\mathrm{cont}} = 0.3$。\n- 案例4（两者边际收益均为负，零解）：$P_{\\max} = 100\\,\\mathrm{MW}$，$S = 40\\,\\mathrm{MWh}$，$\\eta = 0.9$，$c_{\\mathrm{deg}} = 300$，$\\pi^{\\mathrm{reg}} = 20$，$\\pi^{\\mathrm{cont}} = 10$，$\\gamma = 0.5$，$p = 0.1$，$d = 0.25$，$e^{\\mathrm{reg}} = 0.2$，$e^{\\mathrm{cont}} = 0.25$。\n\n算法要求：\n实现一个算法，对于每个测试案例，仅使用上述能量守恒和往返效率定义计算调频和应急备用的单位容量（$\\mathrm{MW}$）绝对吞吐量，构建线性净利润目标函数，并在多面体可行域上找到最优的 $(r^{\\star}, c^{\\star})$。该算法必须在包括边界和边缘情况在内的上述所有案例中都正确无误。最终程序必须是独立的，并生成指定的单行输出，包含 $[[r_1,c_1],[r_2,c_2],[r_3,c_3],[r_4,c_4]]$，所有值以 $\\mathrm{MW}$ 为单位，并四舍五入到三位小数。",
            "solution": "该问题要求构建并求解一个线性优化问题，以最大化同时提供调频和应急备用服务的电池系统的净利润。求解过程首先从给定的基本原理出发，构建目标函数和约束条件。\n\n决策变量是调频容量 $r$（单位为 $\\mathrm{MW}$）和应急备用容量 $c$（单位为 $\\mathrm{MW}$）。目标是最大化每小时净利润 $Z$，即容量费用总收入减去总预期退化成本。\n\n$Z(r, c) = \\text{收入}(r, c) - \\text{成本}(r, c)$\n\n**1. 收入公式**\n\n收入是每项服务的容量费用之和。\n- 调频收入：$\\pi^{\\mathrm{reg}} \\cdot r$\n- 应急备用收入：$\\pi^{\\mathrm{cont}} \\cdot c$\n总收入 $= \\pi^{\\mathrm{reg}} r + \\pi^{\\mathrm{cont}} c$\n\n**2. 退化成本公式**\n\n退化成本与总预期绝对能量吞吐量成正比，成本参数为 $c_{\\mathrm{deg}}$。\n总成本 $= c_{\\mathrm{deg}} \\cdot (\\text{预期吞吐量}_{\\mathrm{reg}} + \\text{预期吞吐量}_{\\mathrm{cont}})$\n\n问题陈述指出，对于 $x$ $\\mathrm{MWh}$ 的放电，由于往返效率 $\\eta$，恢复到初始充电状态所需的再充电量为 $x/\\eta$ $\\mathrm{MWh}$。因此，此循环的绝对能量吞吐量为 $x + x/\\eta = x(1 + 1/\\eta)$。我们将此原则应用于两种服务。\n\n- **调频服务吞吐量**：\n  每 $\\mathrm{MW}$ 调频容量的预期放电侧能量给定为 $\\gamma$。对于承诺的 $r$ $\\mathrm{MW}$ 容量，总预期放电量为 $x_{\\mathrm{reg}} = \\gamma \\cdot r$。\n  调频的预期绝对吞吐量为 $x_{\\mathrm{reg}}(1 + 1/\\eta) = \\gamma r (1 + 1/\\eta)$。\n  令 $\\tau^{\\mathrm{reg}} = \\gamma (1 + 1/\\eta)$ 为调频的单位吞吐量（单位为 $\\mathrm{MWh/MW}$）。\n\n- **应急备用服务吞吐量**：\n  每 $\\mathrm{MW}$ 应急备用容量的预期放电侧能量是激活概率 $p$ 和预期持续时间 $d$ 的乘积，即 $p \\cdot d$。对于承诺的 $c$ $\\mathrm{MW}$ 容量，总预期放电量为 $x_{\\mathrm{cont}} = (p \\cdot d) \\cdot c$。\n  应急备用的预期绝对吞吐量为 $x_{\\mathrm{cont}}(1 + 1/\\eta) = (p \\cdot d) c (1 + 1/\\eta)$。\n  令 $\\tau^{\\mathrm{cont}} = p \\cdot d (1 + 1/\\eta)$ 为应急备用的单位吞吐量（单位为 $\\mathrm{MWh/MW}$）。\n\n总退化成本为 $c_{\\mathrm{deg}}(\\tau^{\\mathrm{reg}} r + \\tau^{\\mathrm{cont}} c)$。\n\n**3. 净利润目标函数**\n\n结合收入和成本，净利润函数为：\n$Z(r, c) = (\\pi^{\\mathrm{reg}} r + \\pi^{\\mathrm{cont}} c) - c_{\\mathrm{deg}}(\\tau^{\\mathrm{reg}} r + \\tau^{\\mathrm{cont}} c)$\n\n按决策变量 $r$ 和 $c$ 对各项进行分组：\n$Z(r, c) = (\\pi^{\\mathrm{reg}} - c_{\\mathrm{deg}} \\tau^{\\mathrm{reg}}) r + (\\pi^{\\mathrm{cont}} - c_{\\mathrm{deg}} \\tau^{\\mathrm{cont}}) c$\n\n我们定义每项服务的净边际利润：\n- $m^{\\mathrm{reg}} = \\pi^{\\mathrm{reg}} - c_{\\mathrm{deg}} \\tau^{\\mathrm{reg}} = \\pi^{\\mathrm{reg}} - c_{\\mathrm{deg}} \\gamma (1 + 1/\\eta)$\n- $m^{\\mathrm{cont}} = \\pi^{\\mathrm{cont}} - c_{\\mathrm{deg}} \\tau^{\\mathrm{cont}} = \\pi^{\\mathrm{cont}} - c_{\\mathrm{deg}} p d (1 + 1/\\eta)$\n\n目标函数简化为最大化 $Z(r, c) = m^{\\mathrm{reg}} r + m^{\\mathrm{cont}} c$。\n\n**4. 约束条件**\n\n该优化问题受物理和运行约束的限制：\n1.  **功率约束**：承诺的总容量不能超过电池的功率等级：$r + c \\le P_{\\max}$。\n2.  **能量裕度约束**：提供的容量必须有足够的能量裕度支持：$e^{\\mathrm{reg}} r + e^{\\mathrm{cont}} c \\le S$。\n3.  **非负性**：容量不能为负：$r \\ge 0$ 和 $c \\ge 0$。\n\n**5. 线性规划公式**\n\n完整的协同优化问题是一个线性规划（LP）问题：\n$$\n\\begin{align*}\n\\text{maximize}_{r, c} \\quad  m^{\\mathrm{reg}} r + m^{\\mathrm{cont}} c \\\\\n\\text{subject to} \\quad  r + c \\le P_{\\max} \\\\\n e^{\\mathrm{reg}} r + e^{\\mathrm{cont}} c \\le S \\\\\n r \\ge 0 \\\\\n c \\ge 0\n\\end{align*}\n$$\n\n**6. 求解方法**\n\n这是一个二维线性规划问题。由线性不等式定义的可行域是 $(r, c)$ 平面上的一个凸多边形。线性规划的一个基本定理指出，如果存在最优解，它必定出现在该可行域的一个顶点上。\n\n找到最优解 $(r^{\\star}, c^{\\star})$ 的算法如下：\n1.  对于每个测试案例，计算净边际利润 $m^{\\mathrm{reg}}$ 和 $m^{\\mathrm{cont}}$。\n2.  确定可行多边形的顶点。顶点是位于可行域内的约束边界线的交点。这些点是：\n    - 原点：$(0, 0)$。\n    - $r$ 轴截距，由 $(\\min(P_{\\max}, S/e^{\\mathrm{reg}}), 0)$ 给出。\n    - $c$ 轴截距，由 $(0, \\min(P_{\\max}, S/e^{\\mathrm{cont}}))$ 给出。\n    - 两条主要约束线 $r + c = P_{\\max}$ 和 $e^{\\mathrm{reg}} r + e^{\\mathrm{cont}} c = S$ 的交点。只有当该点的两个坐标都非负时，它才是一个顶点。\n3.  在每个顶点上评估目标函数 $Z(r, c)$ 的值。\n4.  最优解 $(r^{\\star}, c^{\\star})$ 是产生最大目标函数值的顶点。如果所有边际利润均为非正数，则最优解为 $(0, 0)$。所实现的算法会在所有顶点中找到最大值，这能正确处理所有情况。\n将此过程应用于每个测试案例，以确定其最优容量分配。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the battery co-optimization problem for a given set of test cases.\n    \"\"\"\n    # Test cases: (P_max, S, eta, c_deg, pi_reg, pi_cont, gamma, p, d, e_reg, e_cont)\n    test_cases = [\n        # Case 1: happy path, power-limited to regulation\n        (100.0, 40.0, 0.9, 10.0, 30.0, 15.0, 0.5, 0.1, 0.25, 0.2, 0.25),\n        # Case 2: energy binding with negative regulation margin, contingency preferred\n        (100.0, 40.0, 0.9, 40.0, 30.0, 15.0, 0.5, 0.1, 0.25, 0.2, 0.5),\n        # Case 3: strongly energy-limited, contingency more valuable\n        (100.0, 10.0, 0.9, 10.0, 20.0, 25.0, 0.5, 0.1, 0.25, 0.25, 0.3),\n        # Case 4: both margins negative, zero solution\n        (100.0, 40.0, 0.9, 300.0, 20.0, 10.0, 0.5, 0.1, 0.25, 0.2, 0.25),\n    ]\n\n    results = []\n    # Use a small tolerance for floating point comparisons\n    TOL = 1e-9\n\n    for case in test_cases:\n        P_max, S, eta, c_deg, pi_reg, pi_cont, gamma, p, d, e_reg, e_cont = case\n\n        # 1. Calculate net marginal profits (m_reg, m_cont)\n        # Throughput is proportional to x * (1 + 1/eta)\n        throughput_factor = 1.0 + 1.0 / eta\n        \n        # Specific throughput for regulation (MWh/MW)\n        tau_reg = gamma * throughput_factor\n        # Specific throughput for contingency (MWh/MW)\n        tau_cont = p * d * throughput_factor\n        \n        # Marginal profit for regulation ($/MW)\n        m_reg = pi_reg - c_deg * tau_reg\n        # Marginal profit for contingency ($/MW)\n        m_cont = pi_cont - c_deg * tau_cont\n\n        # 2. Identify the vertices of the feasible region polygon\n        vertices = [(0.0, 0.0)]\n        \n        # r-axis intercept\n        r_intercept = P_max\n        if e_reg > TOL:\n            r_intercept = min(r_intercept, S / e_reg)\n        vertices.append((r_intercept, 0.0))\n\n        # c-axis intercept\n        c_intercept = P_max\n        if e_cont > TOL:\n            c_intercept = min(c_intercept, S / e_cont)\n        vertices.append((0.0, c_intercept))\n\n        # Intersection of the two constraint lines:\n        # r + c = P_max\n        # e_reg * r + e_cont * c = S\n        if abs(e_cont - e_reg) > TOL:\n            # Solve for c: e_reg * (P_max - c) + e_cont * c = S\n            # c * (e_cont - e_reg) = S - e_reg * P_max\n            c_int = (S - e_reg * P_max) / (e_cont - e_reg)\n            r_int = P_max - c_int\n            \n            # The intersection is a valid vertex if it's in the first quadrant\n            if r_int >= -TOL and c_int >= -TOL:\n                # and it must satisfy the other constraints, which is guaranteed if r_int and c_int are on the boundary lines\n                # we just need to check if it's within the feasible region defined by ALL constraints\n                if (r_int + c_int = P_max + TOL) and (e_reg * r_int + e_cont * c_int = S + TOL):\n                    vertices.append((max(0, r_int), max(0, c_int)))\n\n        # 3. Evaluate objective function at each vertex to find the optimum\n        max_profit = -np.inf\n        optimal_rc = (0.0, 0.0)\n\n        # To handle redundancy and precision, create a set of unique vertices\n        unique_vertices = set()\n        for r_v, c_v in vertices:\n            unique_vertices.add((round(r_v, 9), round(c_v, 9)))\n        \n        for r_v, c_v in unique_vertices:\n            profit = m_reg * r_v + m_cont * c_v\n            if profit > max_profit:\n                max_profit = profit\n                optimal_rc = (r_v, c_v)\n\n        results.append(optimal_rc)\n\n    # 4. Format the final output string as specified\n    output_parts = []\n    for r_star, c_star in results:\n        # Round the final values to three decimal places\n        r_str = f\"{r_star:.3f}\"\n        c_str = f\"{c_star:.3f}\"\n        output_parts.append(f\"[{r_str},{c_str}]\")\n    \n    final_output_string = f\"[[{output_parts[0]}],[{output_parts[1]}],[{output_parts[2]}],[{output_parts[3]}]]\"\n    # A quick correction on the format specified: it's a list of lists, so must be [[...],[...],...]\n    final_output_string = f\"[{','.join(output_parts)}]\"\n    print(final_output_string)\n\nsolve()\n```"
        },
        {
            "introduction": "电力系统的运行本质上充满了不确定性，尤其是在可再生能源高比例渗透的背景下。本练习将引导您从确定性优化迈向随机优化，通过构建一个两阶段随机规划模型，来应对负荷预测的不确定性。您将学习如何通过日前（第一阶段）的能源和备用联合调度，来对实时（第二阶段）的多种可能情景进行经济上最优的对冲。",
            "id": "4078378",
            "problem": "考虑一个包含 $2$ 台常规发电机和 $2$ 个净负荷情景的小型系统，对其进行能量和辅助服务的单小时随机协同优化。调度周期为 $1$ 小时，因此在该小时内，以 $\\mathrm{MWh}$ 为单位的电能量在数值上等于以 $\\mathrm{MW}$ 为单位的功率量。目标是确定第一阶段的日前承诺和上调备用分配，以最小化包含实时补救措施在内的期望总成本。该模型必须满足功率平衡和物理可行性约束，并包含实时调整：上调、下调和非自愿甩负荷。\n\n使用以下基本依据：\n- 能量/功率平衡守恒：对于每个情景，总供给（实时调整后）加上甩负荷等于净负荷。\n- 期望值定义：期望总成本等于各情景概率乘以其对应成本后对所有情景求和。\n- 能量、备用容量和实时行为的线性边际成本表示。\n\n决策变量：\n- 每个发电机 $i \\in \\{1,2\\}$ 的第一阶段变量：计划能量 $e_i \\, (\\mathrm{MW})$ 和计划上调备用容量 $r_i \\, (\\mathrm{MW})$。\n- 每个情景 $s \\in \\{1,2\\}$ 和发电机 $i \\in \\{1,2\\}$ 的第二阶段补救变量：上调 $u_{i}^{(s)} \\, (\\mathrm{MW})$、下调 $d_{i}^{(s)} \\, (\\mathrm{MW})$ 和情景甩负荷 $\\ell^{(s)} \\, (\\mathrm{MW})$。\n\n参数（均为非负且科学上合理）：\n- 发电机容量 $G_i \\, (\\mathrm{MW})$。\n- 边际能量成本 $C_i \\, (\\$/\\mathrm{MWh})$。\n- 上调备用容量成本 $A_i \\, (\\$/\\mathrm{MW}\\text{-}\\mathrm{h})$。\n- 实时上调边际成本 $U_i \\, (\\$/\\mathrm{MWh})$。\n- 实时下调边际成本 $D_i \\, (\\$/\\mathrm{MWh})$。\n- 甩负荷惩罚 $S \\, (\\$/\\mathrm{MWh})$。\n- 情景负荷 $L^{(s)} \\, (\\mathrm{MW})$，其中 $s \\in \\{1,2\\}$。\n- 情景概率 $p^{(s)}$，满足 $p^{(1)} + p^{(2)} = 1$。\n\n将此协同优化问题建模为线性规划（LP）：\n- 目标：最小化期望总成本\n$$\n\\sum_{i=1}^{2} C_i \\, e_i \\;+\\; \\sum_{i=1}^{2} A_i \\, r_i \\;+\\; \\sum_{s=1}^{2} p^{(s)}\\left(\\sum_{i=1}^{2} U_i \\, u_{i}^{(s)} \\;+\\; \\sum_{i=1}^{2} D_i \\, d_{i}^{(s)} \\;+\\; S \\, \\ell^{(s)}\\right).\n$$\n- 物理可行性约束：\n  - 对于每个发电机 $i$：$0 \\le e_i \\le G_i$，$0 \\le r_i$，以及 $e_i + r_i \\le G_i$。\n  - 对于每个情景 $s$ 和发电机 $i$：$0 \\le u_{i}^{(s)} \\le r_i$ 以及 $0 \\le d_{i}^{(s)} \\le e_i$。\n  - 对于每个情景 $s$：功率平衡\n$$\n\\sum_{i=1}^{2} e_i \\;+\\; \\sum_{i=1}^{2} u_{i}^{(s)} \\;-\\; \\sum_{i=1}^{2} d_{i}^{(s)} \\;+\\; \\ell^{(s)} \\;=\\; L^{(s)},\n$$\n其中 $\\ell^{(s)} \\ge 0$。\n\n测试套件：\n提供 $3$ 组参数集以探究问题的不同方面。在每种情况下，报告以 $\\mathrm{MW}$ 为单位的最优第一阶段承诺和备用分配 $\\left[e_1,e_2,r_1,r_2\\right]$。\n\n- 情况 1（理想情况，容量充足，存在非平凡的备用权衡）：\n  - $G_1 = 80$，$G_2 = 70$。\n  - $C_1 = 10$，$C_2 = 25$。\n  - $A_1 = 2$，$A_2 = 4$。\n  - $U_1 = 15$，$U_2 = 35$。\n  - $D_1 = 1$，$D_2 = 1$。\n  - $S = 1000$。\n  - $L^{(1)} = 90$，$L^{(2)} = 130$。\n  - $p^{(1)} = 0.6$，$p^{(2)} = 0.4$。\n\n- 情况 2（边缘情况，总容量不足导致在高负荷情景下进行惩罚性甩负荷）：\n  - $G_1 = 60$，$G_2 = 60$。\n  - $C_1 = 12$，$C_2 = 24$。\n  - $A_1 = 1$，$A_2 = 2$。\n  - $U_1 = 18$，$U_2 = 30$。\n  - $D_1 = 0.5$，$D_2 = 0.5$。\n  - $S = 2000$。\n  - $L^{(1)} = 90$，$L^{(2)} = 130$。\n  - $p^{(1)} = 0.5$，$p^{(2)} = 0.5$。\n\n- 情况 3（边界权衡情况，高昂的备用容量成本鼓励将计划发电量安排在更接近高负荷的水平，并依赖下调）：\n  - $G_1 = 80$，$G_2 = 80$。\n  - $C_1 = 12$，$C_2 = 20$。\n  - $A_1 = 20$，$A_2 = 50$。\n  - $U_1 = 18$，$U_2 = 30$。\n  - $D_1 = 1$，$D_2 = 1$。\n  - $S = 1000$。\n  - $L^{(1)} = 95$，$L^{(2)} = 105$。\n  - $p^{(1)} = 0.5$，$p^{(2)} = 0.5$。\n\n要求输出：\n- 将 $e_1$、$e_2$、$r_1$ 和 $r_2$ 以 $\\mathrm{MW}$ 为单位，表示为四舍五入到三位小数的浮点数。\n- 您的程序应生成单行输出，其中包含三个情况的结果，格式为用方括号括起来的逗号分隔列表，每个情况本身也作为一个列表报告。例如，输出格式必须为\n$$\n\\left[\\left[e_1^{(1)},e_2^{(1)},r_1^{(1)},r_2^{(1)}\\right],\\left[e_1^{(2)},e_2^{(2)},r_1^{(2)},r_2^{(2)}\\right],\\left[e_1^{(3)},e_2^{(3)},r_1^{(3)},r_2^{(3)}\\right]\\right].\n$$",
            "solution": "用户在能源系统工程领域提供了一个定义明确的问题，具体是关于不确定性下的能量和辅助服务协同优化。该问题被构建为一个包含 $2$ 台发电机和 $2$ 个情景的系统的两阶段随机线性规划。\n\n### 问题验证\n\n**步骤 1：提取已知条件**\n\n- **决策变量（第一阶段）：**\n  - $e_i$：发电机 $i \\in \\{1,2\\}$ 的计划能量 $(\\mathrm{MW})$。\n  - $r_i$：发电机 $i \\in \\{1,2\\}$ 的计划上调备用容量 $(\\mathrm{MW})$。\n- **决策变量（第二阶段）：**\n  - $u_{i}^{(s)}$：情景 $s \\in \\{1,2\\}$ 中发电机 $i$ 的上调 $(\\mathrm{MW})$。\n  - $d_{i}^{(s)}$：情景 $s \\in \\{1,2\\}$ 中发电机 $i$ 的下调 $(\\mathrm{MW})$。\n  - $\\ell^{(s)}$：情景 $s \\in \\{1,2\\}$ 中的甩负荷 $(\\mathrm{MW})$。\n- **参数：**\n  - $G_i$：发电机 $i$ 的容量 $(\\mathrm{MW})$。\n  - $C_i$：发电机 $i$ 的边际能量成本 $(\\$/\\mathrm{MWh})$。\n  - $A_i$：发电机 $i$ 的上调备用容量成本 $(\\$/\\mathrm{MW}\\text{-}\\mathrm{h})$。\n  - $U_i$：发电机 $i$ 的上调边际成本 $(\\$/\\mathrm{MWh})$。\n  - $D_i$：发电机 $i$ 的下调边际成本 $(\\$/\\mathrm{MWh})$。\n  - $S$：甩负荷惩罚 $(\\$/\\mathrm{MWh})$。\n  - $L^{(s)}$：情景 $s$ 的净负荷 $(\\mathrm{MW})$。\n  - $p^{(s)}$：情景 $s$ 的概率，满足 $p^{(1)} + p^{(2)} = 1$。\n- **目标函数：** 最小化期望总成本：\n$$ \\sum_{i=1}^{2} C_i \\, e_i \\;+\\; \\sum_{i=1}^{2} A_i \\, r_i \\;+\\; \\sum_{s=1}^{2} p^{(s)}\\left(\\sum_{i=1}^{2} U_i \\, u_{i}^{(s)} \\;+\\; \\sum_{i=1}^{2} D_i \\, d_{i}^{(s)} \\;+\\; S \\, \\ell^{(s)}\\right) $$\n- **约束条件：**\n  - 对 $i \\in \\{1,2\\}$，$0 \\le e_i \\le G_i$。\n  - 对 $i \\in \\{1,2\\}$，$0 \\le r_i$。\n  - 对 $i \\in \\{1,2\\}$，$e_i + r_i \\le G_i$。\n  - 对 $s \\in \\{1,2\\}, i \\in \\{1,2\\}$，$0 \\le u_{i}^{(s)} \\le r_i$。\n  - 对 $s \\in \\{1,2\\}, i \\in \\{1,2\\}$，$0 \\le d_{i}^{(s)} \\le e_i$。\n  - 对 $s \\in \\{1,2\\}$，$\\ell^{(s)} \\ge 0$。\n  - 对 $s \\in \\{1,2\\}$，$\\sum_{i=1}^{2} e_i \\;+\\; \\sum_{i=1}^{2} u_{i}^{(s)} \\;-\\; \\sum_{i=1}^{2} d_{i}^{(s)} \\;+\\; \\ell^{(s)} \\;=\\; L^{(s)}$。\n- **测试用例：** 提供了三组不同的参数集。\n\n**步骤 2：使用提取的已知条件进行验证**\n\n- **科学依据：**该问题是一个标准的、尽管简化的两阶段随机机组组合问题的模型，这是现代电力系统运行与规划的基石。日前能量和备用调度、实时补救措施（调节）、甩负荷及其相关成本等概念都是基础性的，并得到了准确的表述。该模型正确地使用了期望值最小化和能量守恒（功率平衡）。\n- **良态问题：**该问题被构建为一个线性规划（LP）。给定一个非空、有界的可行域（由发电机容量约束保证）和一个线性目标函数，最优解保证存在。所有术语都定义清晰。\n- **客观性：**语言精确、数学化，没有主观或含糊不清的陈述。\n- **其他标准：**该问题是自洽的，为每个测试用例提供了所有必要的数据。参数在物理上是合理的，不包含内部矛盾。这是一个非平凡的优化问题，需要在不同时间阶段和情景之间平衡相互竞争的成本。\n\n**步骤 3：结论与行动**\n\n问题有效。这是一个良态的、科学上合理的、客观的优化任务。将提供完整的解决方案。\n\n### 解决方案\n\n该问题是一个两阶段随机线性规划。第一阶段决策（$e_1, e_2, r_1, r_2$）是在不确定净负荷实现之前的“事前”决策。第二阶段或补救决策（$u_i^{(s)}, d_i^{(s)}, \\ell^{(s)}$）是为每个情景 $s$ 做出的“事后”决策，以最优地纠正计划发电量与实际负荷之间的任何不平衡。解决此类问题的标准方法是构建其确定性等价形式，这是一个单一的大型线性规划，包含了所有情景下的所有变量和约束。这正是问题陈述中提供的模型。\n\n我们将使用标准的数值优化工具来求解这个LP。该模型被转换为通用LP求解器所需的典范形式：\n$$\n\\begin{aligned}\n\\text{minimize} \\quad  c^T x \\\\\n\\text{subject to} \\quad  A_{eq} x = b_{eq} \\\\\n A_{ub} x \\le b_{ub} \\\\\n l \\le x \\le u\n\\end{aligned}\n$$\n其中 $x$ 是所有决策变量的向量。\n\n**1. 决策变量向量**\n\n决策变量被排列成一个单一向量 $x \\in \\mathbb{R}^{14}$：\n$$\nx = [e_1, e_2, r_1, r_2, u_1^{(1)}, u_2^{(1)}, d_1^{(1)}, d_2^{(1)}, \\ell^{(1)}, u_1^{(2)}, u_2^{(2)}, d_1^{(2)}, d_2^{(2)}, \\ell^{(2)}]^T\n$$\n索引映射如下：$e_1 \\to 0$, $e_2 \\to 1$, $r_1 \\to 2$, $r_2 \\to 3$, $u_1^{(1)} \\to 4$, ..., $\\ell^{(2)} \\to 13$。\n\n**2. 目标函数（成本向量 $c$）**\n\n目标是最小化第一阶段成本与期望的第二阶段成本之和。成本向量 $c \\in \\mathbb{R}^{14}$ 直接由目标函数系数构建：\n$$\nc = [C_1, C_2, A_1, A_2, p^{(1)}U_1, p^{(1)}U_2, p^{(1)}D_1, p^{(1)}D_2, p^{(1)}S, p^{(2)}U_1, p^{(2)}U_2, p^{(2)}D_1, p^{(2)}D_2, p^{(2)}S]^T\n$$\n\n**3. 等式约束 ($A_{eq}, b_{eq}$)**\n\n等式约束强制执行 $2$ 个情景中每一个的功率平衡。这产生一个矩阵 $A_{eq} \\in \\mathbb{R}^{2 \\times 14}$ 和一个向量 $b_{eq} \\in \\mathbb{R}^{2}$。\n\n- **情景 1 平衡：** $\\sum_{i=1}^{2} e_i + \\sum_{i=1}^{2} u_{i}^{(1)} - \\sum_{i=1}^{2} d_{i}^{(1)} + \\ell^{(1)} = L^{(1)}$\n  这对应于 $A_{eq}$ 的第一行，其中 $e_1, e_2, u_1^{(1)}, u_2^{(1)}, \\ell^{(1)}$ 的系数为 $1$，$d_1^{(1)}, d_2^{(1)}$ 的系数为 $-1$。\n- **情景 2 平衡：** $\\sum_{i=1}^{2} e_i + \\sum_{i=1}^{2} u_{i}^{(2)} - \\sum_{i=1}^{2} d_{i}^{(2)} + \\ell^{(2)} = L^{(2)}$\n  这对应于 $A_{eq}$ 的第二行，其中 $e_1, e_2, u_1^{(2)}, u_2^{(2)}, \\ell^{(2)}$ 的系数为 $1$，$d_1^{(2)}, d_2^{(2)}$ 的系数为 $-1$。\n\n右侧项为 $b_{eq} = [L^{(1)}, L^{(2)}]^T$。\n\n**4. 不等式约束 ($A_{ub}, b_{ub}$)**\n\n不等式约束规定了发电机的物理极限以及第一阶段和第二阶段决策之间的耦合关系。共有 $10$ 个此类约束，形成一个矩阵 $A_{ub} \\in \\mathbb{R}^{10 \\times 14}$ 和一个向量 $b_{ub} \\in \\mathbb{R}^{10}$。\n\n- **发电机容量：** 对 $i \\in \\{1,2\\}$，$e_i + r_i \\le G_i$。（2 个约束）\n- **上调限制：** 对 $i \\in \\{1,2\\}, s \\in \\{1,2\\}$，$u_{i}^{(s)} \\le r_i \\implies u_{i}^{(s)} - r_i \\le 0$。（4 个约束）\n- **下调限制：** 对 $i \\in \\{1,2\\}, s \\in \\{1,2\\}$，$d_{i}^{(s)} \\le e_i \\implies d_{i}^{(s)} - e_i \\le 0$。（4 个约束）\n\n右侧项为 $b_{ub} = [G_1, G_2, 0, 0, 0, 0, 0, 0, 0, 0]^T$。\n\n**5. 变量界限 ($l, u$)**\n\n界限定义了每个独立变量的定义域。\n\n- 对 $i=1,2$，$0 \\le e_i \\le G_i$。\n- 所有其他变量均为非负：$r_i \\ge 0$，$u_{i}^{(s)} \\ge 0$，$d_{i}^{(s)} \\ge 0$，$\\ell^{(s)} \\ge 0$。\n\n这个完整的 LP 模型被构建并针对三个测试用例中的每一个进行求解。第一阶段变量（$e_1, e_2, r_1, r_2$）的最优值从解向量 $x$ 中提取。结果展示了系统如何根据日前调度、备用采购和实时调整的相对成本来最优地对冲负荷不确定性。\n\n- **情况 1** 容量充足。关键的权衡在于，是从更便宜的发电机（G1）采购备用（这需要减少其廉价的能量输出），还是使用更昂贵的发电机（G2）来提供备用。\n- **情况 2** 受系统总容量的限制，该容量低于高负荷需求。这迫使在高负荷情景下进行确定数量的甩负荷，从而简化了权衡。\n- **情况 3** 的特点是备用容量成本（$A_i$）非常高。这产生了一种经济激励，促使系统最小化采购的备用，可能的做法是将能量调度安排得更接近高负荷情景，并在低负荷情景中依赖更便宜的下调。\n\n该实现将为每种情况构建这些矩阵和向量，并使用 `scipy.optimize.linprog` 函数来找到最优解。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import linprog\n\ndef solve():\n    \"\"\"\n    Solves the stochastic co-optimization problem for three test cases.\n    \"\"\"\n\n    test_cases = [\n        # Case 1: Happy path\n        {\n            \"G\": np.array([80.0, 70.0]),\n            \"C\": np.array([10.0, 25.0]),\n            \"A\": np.array([2.0, 4.0]),\n            \"U\": np.array([15.0, 35.0]),\n            \"D\": np.array([1.0, 1.0]),\n            \"S\": 1000.0,\n            \"L\": np.array([90.0, 130.0]),\n            \"p\": np.array([0.6, 0.4]),\n        },\n        # Case 2: Insufficient capacity\n        {\n            \"G\": np.array([60.0, 60.0]),\n            \"C\": np.array([12.0, 24.0]),\n            \"A\": np.array([1.0, 2.0]),\n            \"U\": np.array([18.0, 30.0]),\n            \"D\": np.array([0.5, 0.5]),\n            \"S\": 2000.0,\n            \"L\": np.array([90.0, 130.0]),\n            \"p\": np.array([0.5, 0.5]),\n        },\n        # Case 3: Boundary trade-off\n        {\n            \"G\": np.array([80.0, 80.0]),\n            \"C\": np.array([12.0, 20.0]),\n            \"A\": np.array([20.0, 50.0]),\n            \"U\": np.array([18.0, 30.0]),\n            \"D\": np.array([1.0, 1.0]),\n            \"S\": 1000.0,\n            \"L\": np.array([95.0, 105.0]),\n            \"p\": np.array([0.5, 0.5]),\n        },\n    ]\n\n    all_results = []\n    \n    # Variable mapping to indices in the decision vector x:\n    # x = [e1, e2, r1, r2, u1_1, u2_1, d1_1, d2_1, l_1, u1_2, u2_2, d1_2, d2_2, l_2]\n    # Indices: 0, 1, 2,  3,  4,    5,    6,    7,    8,   9,    10,   11,   12,   13\n\n    for case_params in test_cases:\n        G, C, A, U, D, S, L, p = (\n            case_params[\"G\"],\n            case_params[\"C\"],\n            case_params[\"A\"],\n            case_params[\"U\"],\n            case_params[\"D\"],\n            case_params[\"S\"],\n            case_params[\"L\"],\n            case_params[\"p\"],\n        )\n        G1, G2 = G\n        L1, L2 = L\n        p1, p2 = p\n        C1, C2 = C\n        A1, A2 = A\n        U1, U2 = U\n        D1, D2 = D\n\n        # Objective function vector c (14 variables)\n        c = np.array([\n            C1, C2, A1, A2,          # First-stage costs\n            p1 * U1, p1 * U2, p1 * D1, p1 * D2, p1 * S, # Scenario 1 recourse costs\n            p2 * U1, p2 * U2, p2 * D1, p2 * D2, p2 * S, # Scenario 2 recourse costs\n        ])\n\n        # Equality constraints A_eq * x = b_eq (2 constraints for power balance)\n        A_eq = np.zeros((2, 14))\n        # Scenario 1: e1+e2 + u1_1+u2_1 - d1_1-d2_1 + l_1 = L1\n        A_eq[0, [0, 1, 4, 5, 8]] = 1\n        A_eq[0, [6, 7]] = -1\n        # Scenario 2: e1+e2 + u1_2+u2_2 - d1_2-d2_2 + l_2 = L2\n        A_eq[1, [0, 1, 9, 10, 13]] = 1\n        A_eq[1, [11, 12]] = -1\n        b_eq = np.array([L1, L2])\n\n        # Inequality constraints A_ub * x = b_ub (10 constraints)\n        A_ub = np.zeros((10, 14))\n        # e1 + r1 = G1\n        A_ub[0, [0, 2]] = 1\n        # e2 + r2 = G2\n        A_ub[1, [1, 3]] = 1\n        # u1_1 - r1 = 0\n        A_ub[2, [4, 2]] = [1, -1]\n        # u2_1 - r2 = 0\n        A_ub[3, [5, 3]] = [1, -1]\n        # u1_2 - r1 = 0\n        A_ub[4, [9, 2]] = [1, -1]\n        # u2_2 - r2 = 0\n        A_ub[5, [10, 3]] = [1, -1]\n        # d1_1 - e1 = 0\n        A_ub[6, [6, 0]] = [1, -1]\n        # d2_1 - e2 = 0\n        A_ub[7, [7, 1]] = [1, -1]\n        # d1_2 - e1 = 0\n        A_ub[8, [11, 0]] = [1, -1]\n        # d2_2 - e2 = 0\n        A_ub[9, [12, 1]] = [1, -1]\n        \n        b_ub = np.array([G1, G2, 0, 0, 0, 0, 0, 0, 0, 0])\n\n        # Bounds for each variable\n        bounds = [\n            (0, G1), (0, G2),      # e1, e2\n            (0, None), (0, None), # r1, r2\n            (0, None), (0, None), # u1_1, u2_1\n            (0, None), (0, None), # d1_1, d2_1\n            (0, None),            # l_1\n            (0, None), (0, None), # u1_2, u2_2\n            (0, None), (0, None), # d1_2, d2_2\n            (0, None),            # l_2\n        ]\n\n        # Solve the linear program\n        res = linprog(c, A_ub=A_ub, b_ub=b_ub, A_eq=A_eq, b_eq=b_eq, bounds=bounds, method='highs')\n\n        if res.success:\n            # Extract first-stage variables [e1, e2, r1, r2]\n            e1, e2, r1, r2 = res.x[0:4]\n            # Format to 3 decimal places\n            case_result = [float(f\"{val:.3f}\") for val in [e1, e2, r1, r2]]\n            all_results.append(case_result)\n        else:\n            # This should not happen for this well-posed problem\n            all_results.append(['error','error','error','error'])\n    \n    # Final print statement in the exact required format\n    # [[e1_1,e2_1,r1_1,r2_1],[e1_2,e2_2,r1_2,r2_2],[e1_3,e2_3,r1_3,r2_3]]\n    print(str(all_results).replace(\" \", \"\"))\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}