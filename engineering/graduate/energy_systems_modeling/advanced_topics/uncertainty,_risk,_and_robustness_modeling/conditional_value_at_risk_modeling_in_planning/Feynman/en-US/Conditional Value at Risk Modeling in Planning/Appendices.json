{
    "hands_on_practices": [
        {
            "introduction": "Before integrating Conditional Value at Risk (CVaR) into complex optimization models, it is essential to understand how it is calculated from a fundamental level. This first practice provides a direct, hands-on opportunity to compute the Sample Average Approximation (SAA) of CVaR from a discrete set of loss scenarios. By working through the minimization of the underlying convex function, you will gain a concrete understanding of the seminal Rockafellar-Uryasev formulation that makes CVaR a tractable risk measure in practice .",
            "id": "4080182",
            "problem": "A planner evaluating an energy system expansion studies the annual total cost under fuel-price and renewable-availability uncertainty. A historical Monte Carlo sample of $n=10$ scenario losses (annual total costs, treated as losses), in million dollars, is given as\n$$\nL_1=42.3,\\quad L_2=45.1,\\quad L_3=39.8,\\quad L_4=50.0,\\quad L_5=47.6,\\quad L_6=41.2,\\quad L_7=49.4,\\quad L_8=46.8,\\quad L_9=52.7,\\quad L_{10}=44.0.\n$$\nUsing the Sample Average Approximation (SAA) of Conditional Value at Risk (CVaR), compute the $\\alpha$-level CVaR at confidence level $\\alpha=0.95$ by selecting the slack variable $\\eta$ that minimizes the underlying piecewise-linear objective. Use the foundational definition of CVaR as the minimum of a convex functional based on the positive-part operator. Express the final CVaR value in million dollars. Round your answer to four significant figures.\n\nSpecifically, use the definition\n$$\n\\operatorname{CVaR}_{\\alpha}^{\\mathrm{SAA}}(L) \\;=\\; \\min_{\\eta \\in \\mathbb{R}} \\left[\\, \\eta \\;+\\; \\frac{1}{1-\\alpha}\\cdot \\frac{1}{n}\\sum_{i=1}^{n} (L_i - \\eta)^{+} \\,\\right],\n$$\nwhere $(x)^{+}=\\max\\{x,0\\}$.",
            "solution": "The problem is subjected to validation.\n\n### Step 1: Extract Givens\n- A sample of $n=10$ scenario losses, $L_i$, in million dollars: $L_1=42.3, L_2=45.1, L_3=39.8, L_4=50.0, L_5=47.6, L_6=41.2, L_7=49.4, L_8=46.8, L_9=52.7, L_{10}=44.0$.\n- The confidence level for CVaR is $\\alpha=0.95$.\n- The definition for the Sample Average Approximation (SAA) of Conditional Value at Risk (CVaR) is given by the minimization problem:\n$$\n\\operatorname{CVaR}_{\\alpha}^{\\mathrm{SAA}}(L) \\;=\\; \\min_{\\eta \\in \\mathbb{R}} F(\\eta)\n$$\nwhere the objective function is\n$$\nF(\\eta) \\;=\\; \\eta \\;+\\; \\frac{1}{(1-\\alpha)n}\\sum_{i=1}^{n} (L_i - \\eta)^{+}\n$$\nand $(x)^{+}$ is the positive-part operator, defined as $(x)^{+} = \\max\\{x,0\\}$.\n- The final answer is to be rounded to four significant figures.\n\n### Step 2: Validate Using Extracted Givens\n- **Scientifically Grounded**: The problem is valid. The provided formula for CVaR is a standard and well-established definition by Rockafellar and Uryasev (2000), which represents CVaR as the optimal value of a convex optimization problem. This formulation is widely used in finance, operations research, and energy systems for risk management.\n- **Well-Posed**: The problem is well-posed. The objective function $F(\\eta)$ is a sum of a linear function ($\\eta$) and a sum of convex, piecewise-linear functions ($\\frac{1}{(1-\\alpha)n}(L_i - \\eta)^{+}$). As the sum of convex functions is convex, $F(\\eta)$ is convex. A minimum for such a function over $\\mathbb{R}$ is guaranteed to exist.\n- **Objective and Complete**: The problem is objective, providing all necessary numerical data ($L_i, n, \\alpha$) and a precise mathematical definition. It is self-contained and free of ambiguity.\n\n### Step 3: Verdict and Action\nThe problem is deemed valid. A solution will be provided.\n\n### Solution\nThe problem requires the computation of the Conditional Value at Risk (CVaR) at a confidence level $\\alpha=0.95$ for a given sample of $n=10$ losses. We use the provided definition, which frames the CVaR as the solution to an optimization problem. The SAA-CVaR is the minimum value of the function:\n$$\nF(\\eta) \\;=\\; \\eta \\;+\\; \\frac{1}{(1-\\alpha)n}\\sum_{i=1}^{n} \\max\\{L_i - \\eta, 0\\}\n$$\nThe function $F(\\eta)$ is convex and piecewise-linear. The minimum of a convex function is found where its gradient (or subgradient, for non-differentiable points) is zero. The function $F(\\eta)$ is non-differentiable at points where $\\eta = L_i$.\n\nLet us find the subgradient of $F(\\eta)$. The subgradient of the positive-part function $(c-z)^+$ with respect to $z$ is $\\{-1\\}$ if $z < c$, $[ -1, 0 ]$ if $z = c$, and $\\{0\\}$ if $z > c$. Thus, the subgradient of $F(\\eta)$ with respect to $\\eta$ is:\n$$\n\\partial F(\\eta) \\;=\\; 1 \\;-\\; \\frac{1}{(1-\\alpha)n} \\sum_{i=1}^{n} \\mathbb{I}(L_i > \\eta) \\;-\\; \\frac{1}{(1-\\alpha)n} \\sum_{i=1}^{n, L_i=\\eta} [0, 1]\n$$\nwhere $\\mathbb{I}(\\cdot)$ is the indicator function. The minimizer $\\eta^*$ is a value of $\\eta$ for which $0 \\in \\partial F(\\eta^*)$.\n\nTo analyze this condition, we first sort the loss samples in non-decreasing order, denoted by $L_{(1)} \\le L_{(2)} \\le \\dots \\le L_{(n)}$. The given loss data is:\n$42.3, 45.1, 39.8, 50.0, 47.6, 41.2, 49.4, 46.8, 52.7, 44.0$.\nSorting these values yields:\n$L_{(1)} = 39.8$\n$L_{(2)} = 41.2$\n$L_{(3)} = 42.3$\n$L_{(4)} = 44.0$\n$L_{(5)} = 45.1$\n$L_{(6)} = 46.8$\n$L_{(7)} = 47.6$\n$L_{(8)} = 49.4$\n$L_{(9)} = 50.0$\n$L_{(10)} = 52.7$\n\nThe derivative of $F(\\eta)$ is constant between any two consecutive sorted losses. The optimal value $\\eta^*$ must be one of the order statistics $L_{(j)}$. The optimal $\\eta^*$ corresponds to the sample $\\alpha$-Value at Risk ($\\operatorname{VaR}_{\\alpha}$). A standard estimator for the sample VaR is the $j$-th order statistic $L_{(j)}$, where $j = \\lceil n\\alpha \\rceil$.\n\nFor this problem, we have $n=10$ and $\\alpha=0.95$. We calculate the index $j$:\n$$\nj = \\lceil n\\alpha \\rceil = \\lceil 10 \\times 0.95 \\rceil = \\lceil 9.5 \\rceil = 10\n$$\nThe optimal value for the slack variable $\\eta$ is therefore the $10$-th order statistic:\n$$\n\\eta^* = L_{(10)} = 52.7\n$$\nThis value, $\\eta^*=52.7$, is the sample $\\operatorname{VaR}_{0.95}$.\n\nNow, we compute the CVaR by substituting $\\eta^*$ back into the objective function $F(\\eta)$:\n$$\n\\operatorname{CVaR}_{\\alpha}^{\\mathrm{SAA}}(L) = F(\\eta^*) = \\eta^* + \\frac{1}{(1-\\alpha)n} \\sum_{i=1}^{n} (L_i - \\eta^*)^{+}\n$$\nPlugging in the values $\\eta^*=52.7$, $n=10$, and $\\alpha=0.95$:\n$$\n\\operatorname{CVaR}_{0.95}^{\\mathrm{SAA}}(L) = 52.7 + \\frac{1}{(1-0.95) \\times 10} \\sum_{i=1}^{10} (L_i - 52.7)^{+}\n$$\nThe summation term requires evaluating $(L_i - 52.7)^{+}$ for each loss $L_i$. The term $(x)^+ = \\max\\{x,0\\}$ is non-zero only if $x > 0$. In our case, this means we only need to consider losses $L_i$ such that $L_i > 52.7$.\nBy inspecting the sorted list of losses, the maximum loss is $L_{(10)} = 52.7$. There are no losses $L_i$ strictly greater than $52.7$. For every loss $L_i$ in the sample, the inequality $L_i \\le 52.7$ holds.\nTherefore, for all $i=1, \\dots, 10$, we have $L_i - 52.7 \\le 0$. This implies:\n$$\n(L_i - 52.7)^{+} = \\max\\{L_i - 52.7, 0\\} = 0 \\quad \\forall i \\in \\{1, \\dots, 10\\}\n$$\nConsequently, the sum is zero:\n$$\n\\sum_{i=1}^{10} (L_i - 52.7)^{+} = 0\n$$\nSubstituting this result back into the expression for CVaR:\n$$\n\\operatorname{CVaR}_{0.95}^{\\mathrm{SAA}}(L) = 52.7 + \\frac{1}{0.05 \\times 10} \\times 0 = 52.7 + \\frac{1}{0.5} \\times 0 = 52.7\n$$\nThe computed value for the CVaR is $52.7$ million dollars. The problem requires the answer to be rounded to four significant figures. This gives $52.70$.",
            "answer": "$$\\boxed{52.70}$$"
        },
        {
            "introduction": "While the normal distribution is a common starting point for modeling uncertainty, the financial risks associated with extreme events in energy systems are often better described by heavy-tailed distributions. This exercise moves from discrete data to a continuous probability model, asking you to derive the analytical form of CVaR for a loss variable following a Pareto distribution . This practice will deepen your theoretical understanding and reveal how the properties of tail risk, particularly for extreme events, are captured by CVaR and how sensitive the risk measure is to the chosen confidence level $\\alpha$.",
            "id": "4080154",
            "problem": "An energy system planner models tail risk of extreme operating costs in a microgrid with high renewable penetration. Historical analysis suggests that the loss $L$ (measured in monetary units) from extreme events follows a Pareto distribution with minimum scale $x_{m} > 0$ and tail index $\\beta > 1$, such that the cumulative distribution function is $F(l) = 1 - \\left(\\frac{x_{m}}{l}\\right)^{\\beta}$ for $l \\ge x_{m}$. The planner uses Conditional Value at Risk (CVaR) at confidence level $\\alpha \\in (0,1)$ to robustify capacity planning against tail losses.\n\nStarting from the core definitions of Value at Risk (VaR) and Conditional Value at Risk (CVaR) for continuous loss distributions—where VaR at level $\\alpha$ is the $\\alpha$-quantile of the loss distribution, and CVaR at level $\\alpha$ is the expected loss conditional on exceeding the VaR—derive a closed-form analytic expression for $\\mathrm{CVaR}_{\\alpha}(L)$ in terms of $\\alpha$, $\\beta$, and $x_{m}$. Then, analyze the sensitivity of $\\mathrm{CVaR}_{\\alpha}(L)$ to $\\alpha$ as $\\alpha \\to 1^{-}$, explaining the limiting behavior and the rate at which sensitivity changes.\n\nExpress the final answer as a single closed-form analytic expression for $\\mathrm{CVaR}_{\\alpha}(L)$ in terms of $\\alpha$, $\\beta$, and $x_{m}$. No numerical rounding is required, and no physical units should be included in the final expression.",
            "solution": "The problem statement is evaluated to be valid. It is scientifically grounded, well-posed, objective, and self-contained. The problem provides a clear definition of a loss variable $L$ following a Pareto distribution with specified parameters $x_{m} > 0$ and $\\beta > 1$, and its cumulative distribution function (CDF) $F(l) = 1 - (\\frac{x_{m}}{l})^{\\beta}$ for $l \\ge x_{m}$. It uses standard, formalizable definitions for Value at Risk ($\\mathrm{VaR}$) and Conditional Value at Risk ($\\mathrm{CVaR}$) at a confidence level $\\alpha \\in (0,1)$. The task to derive a closed-form expression for $\\mathrm{CVaR}_{\\alpha}(L)$ and analyze its sensitivity is a well-defined mathematical exercise with no apparent contradictions or ambiguities. The condition $\\beta > 1$ is crucial as it ensures the distribution has a finite first moment (mean), which is a necessary condition for $\\mathrm{CVaR}$ to be finite and well-defined.\n\nThe derivation proceeds in three steps: first, we determine the probability density function (PDF); second, we calculate the Value at Risk ($\\mathrm{VaR}_{\\alpha}(L)$); and third, we use these to compute the Conditional Value at Risk ($\\mathrm{CVaR}_{\\alpha}(L)$).\n\nFirst, we find the PDF, $f(l)$, by differentiating the CDF, $F(l)$, with respect to $l$ for $l \\ge x_{m}$:\n$$f(l) = \\frac{d}{dl} F(l) = \\frac{d}{dl} \\left( 1 - \\left(\\frac{x_{m}}{l}\\right)^{\\beta} \\right)$$\n$$f(l) = \\frac{d}{dl} \\left( 1 - x_{m}^{\\beta}l^{-\\beta} \\right) = -x_{m}^{\\beta}(-\\beta)l^{-\\beta-1} = \\frac{\\beta x_{m}^{\\beta}}{l^{\\beta+1}}$$\n\nSecond, we determine the Value at Risk, $\\mathrm{VaR}_{\\alpha}(L)$, which is the value $v$ such that the probability of the loss being less than or equal to $v$ is $\\alpha$. This is the $\\alpha$-quantile of the distribution, found by setting $F(v) = \\alpha$ and solving for $v$.\n$$F(v) = 1 - \\left(\\frac{x_{m}}{v}\\right)^{\\beta} = \\alpha$$\n$$\\left(\\frac{x_{m}}{v}\\right)^{\\beta} = 1 - \\alpha$$\n$$\\frac{x_{m}}{v} = (1 - \\alpha)^{\\frac{1}{\\beta}}$$\n$$v = \\frac{x_{m}}{(1 - \\alpha)^{\\frac{1}{\\beta}}} = x_{m} (1 - \\alpha)^{-\\frac{1}{\\beta}}$$\nThus, we have the expression for the Value at Risk:\n$$\\mathrm{VaR}_{\\alpha}(L) = x_{m} (1 - \\alpha)^{-\\frac{1}{\\beta}}$$\n\nThird, we derive the Conditional Value at Risk, $\\mathrm{CVaR}_{\\alpha}(L)$, which is defined as the expected loss, conditional on the loss exceeding the VaR. For a continuous distribution, this is given by:\n$$\\mathrm{CVaR}_{\\alpha}(L) = E[L | L > \\mathrm{VaR}_{\\alpha}(L)] = \\frac{1}{1-\\alpha} \\int_{\\mathrm{VaR}_{\\alpha}(L)}^{\\infty} l \\cdot f(l) \\, dl$$\nLet $v = \\mathrm{VaR}_{\\alpha}(L)$. We compute the integral part first:\n$$\\int_{v}^{\\infty} l \\cdot f(l) \\, dl = \\int_{v}^{\\infty} l \\cdot \\frac{\\beta x_{m}^{\\beta}}{l^{\\beta+1}} \\, dl = \\beta x_{m}^{\\beta} \\int_{v}^{\\infty} l^{-\\beta} \\, dl$$\nSince the problem states $\\beta > 1$, we can evaluate this improper integral:\n$$\\int_{v}^{\\infty} l^{-\\beta} \\, dl = \\left[ \\frac{l^{-\\beta+1}}{-\\beta+1} \\right]_{v}^{\\infty} = \\frac{1}{1-\\beta} \\left[ l^{1-\\beta} \\right]_{v}^{\\infty}$$\nBecause $\\beta > 1$, the exponent $1-\\beta$ is negative. Therefore, as $l \\to \\infty$, $l^{1-\\beta} \\to 0$. The integral evaluates to:\n$$\\frac{1}{1-\\beta} (0 - v^{1-\\beta}) = \\frac{-v^{1-\\beta}}{1-\\beta} = \\frac{v^{1-\\beta}}{\\beta-1}$$\nSubstituting this back into the expression for the integral of $l \\cdot f(l)$:\n$$\\int_{v}^{\\infty} l \\cdot f(l) \\, dl = \\beta x_{m}^{\\beta} \\left( \\frac{v^{1-\\beta}}{\\beta-1} \\right) = \\frac{\\beta x_{m}^{\\beta}}{\\beta-1} v^{1-\\beta}$$\nNow, we substitute the expression for $v = \\mathrm{VaR}_{\\alpha}(L) = x_{m} (1 - \\alpha)^{-\\frac{1}{\\beta}}$:\n$$\\frac{\\beta x_{m}^{\\beta}}{\\beta-1} \\left( x_{m} (1 - \\alpha)^{-\\frac{1}{\\beta}} \\right)^{1-\\beta} = \\frac{\\beta x_{m}^{\\beta}}{\\beta-1} x_{m}^{1-\\beta} (1 - \\alpha)^{\\left(-\\frac{1}{\\beta}\\right)(1-\\beta)}$$\n$$= \\frac{\\beta x_{m}^{\\beta+1-\\beta}}{\\beta-1} (1 - \\alpha)^{\\frac{\\beta-1}{\\beta}} = \\frac{\\beta x_{m}}{\\beta-1} (1 - \\alpha)^{\\frac{\\beta-1}{\\beta}}$$\nFinally, we substitute this result into the formula for $\\mathrm{CVaR}_{\\alpha}(L)$:\n$$\\mathrm{CVaR}_{\\alpha}(L) = \\frac{1}{1-\\alpha} \\left( \\frac{\\beta x_{m}}{\\beta-1} (1 - \\alpha)^{\\frac{\\beta-1}{\\beta}} \\right)$$\n$$\\mathrm{CVaR}_{\\alpha}(L) = \\frac{\\beta x_{m}}{\\beta-1} (1 - \\alpha)^{\\frac{\\beta-1}{\\beta} - 1} = \\frac{\\beta x_{m}}{\\beta-1} (1 - \\alpha)^{\\frac{\\beta-1-\\beta}{\\beta}}$$\nThis simplifies to the final closed-form expression for $\\mathrm{CVaR}_{\\alpha}(L)$:\n$$\\mathrm{CVaR}_{\\alpha}(L) = \\frac{\\beta x_{m}}{\\beta-1} (1 - \\alpha)^{-\\frac{1}{\\beta}}$$\nIt is noteworthy that we can express $\\mathrm{CVaR}_{\\alpha}(L)$ as a multiple of $\\mathrm{VaR}_{\\alpha}(L)$:\n$$\\mathrm{CVaR}_{\\alpha}(L) = \\frac{\\beta}{\\beta-1} \\left( x_{m} (1 - \\alpha)^{-\\frac{1}{\\beta}} \\right) = \\frac{\\beta}{\\beta-1} \\mathrm{VaR}_{\\alpha}(L)$$\nSince $\\beta > 1$, the factor $\\frac{\\beta}{\\beta-1}$ is always greater than $1$.\n\nFor the sensitivity analysis, we examine the behavior as $\\alpha \\to 1^{-}$. As $\\alpha$ approaches $1$, the term $(1-\\alpha)$ approaches $0$ from the positive side. Since the exponent $-\\frac{1}{\\beta}$ is negative, the term $(1-\\alpha)^{-\\frac{1}{\\beta}}$ grows without bound.\n$$\\lim_{\\alpha \\to 1^{-}} \\mathrm{CVaR}_{\\alpha}(L) = \\lim_{\\alpha \\to 1^{-}} \\frac{\\beta x_{m}}{\\beta-1} (1 - \\alpha)^{-\\frac{1}{\\beta}} = \\infty$$\nThis indicates that the expected loss in the extreme tail is unbounded, which is characteristic of heavy-tailed distributions like the Pareto.\nTo find the rate at which sensitivity changes, we compute the derivative of $\\mathrm{CVaR}_{\\alpha}(L)$ with respect to $\\alpha$:\n$$\\frac{d}{d\\alpha} \\mathrm{CVaR}_{\\alpha}(L) = \\frac{d}{d\\alpha} \\left[ \\frac{\\beta x_{m}}{\\beta-1} (1 - \\alpha)^{-\\frac{1}{\\beta}} \\right]$$\n$$= \\frac{\\beta x_{m}}{\\beta-1} \\left( -\\frac{1}{\\beta} \\right) (1 - \\alpha)^{-\\frac{1}{\\beta}-1} (-1)$$\n$$= \\frac{x_{m}}{\\beta-1} (1 - \\alpha)^{-\\frac{\\beta+1}{\\beta}}$$\nThe sensitivity itself also goes to infinity as $\\alpha \\to 1^{-}$. The rate of this divergence is a power law, $(1-\\alpha)^{-(1+1/\\beta)}$. As the tail of the distribution becomes heavier (i.e., as $\\beta$ decreases toward $1$), the magnitude of the exponent $-(1+\\frac{1}{\\beta})$ increases, causing the sensitivity of $\\mathrm{CVaR}$ to changes in $\\alpha$ to increase even more rapidly as one considers more extreme events ($\\alpha \\to 1^{-}$).",
            "answer": "$$\\boxed{\\frac{\\beta x_{m}}{\\beta - 1} (1 - \\alpha)^{-\\frac{1}{\\beta}}}$$"
        },
        {
            "introduction": "The ultimate purpose of quantifying risk is to make more robust and resilient decisions. This final practice bridges theory and application by embedding the CVaR framework directly into an energy capacity expansion problem. You will build and solve a linear program to determine the optimal investment mix of firm and renewable generation technologies that minimizes both investment costs and the CVaR of operational costs . By analyzing how the optimal capacity portfolio shifts with increasing risk aversion (i.e., a higher $\\alpha$), you will see firsthand how CVaR can be used to navigate the trade-offs between cost and risk in system planning.",
            "id": "4080122",
            "problem": "An energy capacity planning problem is posed under uncertainty with a risk-averse objective using Conditional Value at Risk (CVaR). A planner must choose nonnegative capacities $K_g$ and $K_r$ for a firm dispatchable technology (e.g., natural gas) and a variable renewable technology (e.g., wind), respectively, to minimize the sum of investment cost and a CVaR measure of operating costs over a finite set of equally likely scenarios. For each scenario $s$ in the set $\\{1,\\dots,S\\}$, the uncertain demand is $D_s$ and the renewable availability factor is $a_s$, so the maximum renewable generation in scenario $s$ is $a_s K_r$. Dispatch decisions per scenario are $g_s$ for firm generation, $r_s$ for renewable generation, and $u_s$ for unmet demand (load shedding). The per-unit investment costs are $c_g^I$ and $c_r^I$ (currency per $\\mathrm{MW}$), the firm operating (variable) cost is $c_g^O$ (currency per $\\mathrm{MWh}$), and the unmet demand penalty is $p$ (currency per $\\mathrm{MWh}$). Assume a single representative hour so energy and power units coincide over the horizon, and express all capacity results in $\\mathrm{MW}$.\n\nThe formulation uses the Rockafellar–Uryasev representation of Conditional Value at Risk (CVaR) at confidence level $ \\alpha \\in (0,1) $, introducing an auxiliary variable $\\eta \\ge 0$ and per-scenario nonnegative slack variables $\\xi_s \\ge 0$ satisfying $\\xi_s \\ge c_g^O g_s + p u_s - \\eta$. The objective is to minimize investment cost plus CVaR of operating cost under equal scenario probability $ 1/S $:\n$$\n\\min_{K_g, K_r, \\eta, \\{g_s,r_s,u_s,\\xi_s\\}_{s=1}^S} \\; c_g^I K_g + c_r^I K_r + \\eta + \\frac{1}{(1-\\alpha) S}\\sum_{s=1}^S \\xi_s,\n$$\nsubject to linear operational constraints in each scenario $ s $:\n- Renewable dispatch bounded by availability and capacity: $0 \\le r_s \\le a_s K_r$.\n- Firm dispatch bounded by capacity: $0 \\le g_s \\le K_g$.\n- No overgeneration relative to demand: $g_s + r_s \\le D_s$.\n- Demand balance allowing unmet demand: $g_s + r_s + u_s \\ge D_s$ with $u_s \\ge 0$.\n- CVaR slack constraints: $\\xi_s \\ge 0$ and $\\xi_s \\ge c_g^O g_s + p u_s - \\eta$.\n- Capacity and CVaR level nonnegativity: $K_g \\ge 0$, $K_r \\ge 0$, $\\eta \\ge 0$.\n\nThis yields a linear program that is solvable for any specified $ \\alpha $, parameter set, and scenario data.\n\nYour task is to implement a program that, for the three CVaR confidence levels $ \\alpha = 0.9 $, $ 0.95 $, and $ 0.99 $, computes optimal capacities $ K_g $ and $ K_r $ for each of the following parameter sets (each constitutes one test case):\n\n- Test Case $1$ (happy path, moderate penalty, variable renewables):\n  - $ S = 5 $ scenarios with demands $ D = [100, 110, 120, 130, 140] $ in $\\mathrm{MW}$.\n  - Renewable availability factors $ a = [0.6, 0.6, 0.4, 0.2, 0.1] $.\n  - Costs: $ c_g^I = 50 $, $ c_r^I = 70 $ in currency per $\\mathrm{MW}$; $ c_g^O = 40 $ and $ p = 200 $ in currency per $\\mathrm{MWh}$.\n\n- Test Case $2$ (boundary condition, very high penalty for unmet demand):\n  - $ S = 5 $ scenarios with demands $ D = [100, 150, 200, 250, 300] $ in $\\mathrm{MW}$.\n  - Renewable availability factors $ a = [0.8, 0.5, 0.4, 0.3, 0.1] $.\n  - Costs: $ c_g^I = 50 $, $ c_r^I = 60 $ in currency per $\\mathrm{MW}$; $ c_g^O = 30 $ and $ p = 1000 $ in currency per $\\mathrm{MWh}$.\n\n- Test Case $3$ (edge case, cheaper renewables, higher firm operating cost):\n  - $ S = 5 $ scenarios with demands $ D = [80, 90, 100, 110, 120] $ in $\\mathrm{MW}$.\n  - Renewable availability factors $ a = [0.9, 0.8, 0.7, 0.6, 0.5] $.\n  - Costs: $ c_g^I = 70 $, $ c_r^I = 40 $ in currency per $\\mathrm{MW}$; $ c_g^O = 50 $ and $ p = 400 $ in currency per $\\mathrm{MWh}$.\n\nFor each test case, solve the linear program separately at $ \\alpha = 0.9 $, $ 0.95 $, and $ 0.99 $, and record the optimal capacities $ K_g(\\alpha) $ and $ K_r(\\alpha) $ in $\\mathrm{MW}$. Then, quantify the risk-aversion shift by computing the changes $ \\Delta K_g = K_g(0.99) - K_g(0.9) $ and $ \\Delta K_r = K_r(0.99) - K_r(0.9) $ in $\\mathrm{MW}$.\n\nFinal Output Format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. For each test case, output the $8$ values in the following order, all expressed in $\\mathrm{MW}$ as real numbers (floats):\n  - $ K_g(0.9) $, $ K_r(0.9) $, $ K_g(0.95) $, $ K_r(0.95) $, $ K_g(0.99) $, $ K_r(0.99) $, $ \\Delta K_g $, $ \\Delta K_r $.\n- Concatenate these $8$ values for Test Case $1$, then Test Case $2$, then Test Case $3$, to form a single flat list of $24$ numbers.\n- Example formatting: $ [x_1,x_2,\\dots,x_{24}] $ where each $ x_i $ is a float in $\\mathrm{MW}$.\n\nNo angles are used in this problem. Percentages (such as risk levels) are to be handled as decimals (e.g., $ 0.9 $) rather than using the percent sign.",
            "solution": "The user has provided a well-defined energy capacity planning problem under uncertainty, formulated as a linear program (LP) using the Conditional Value at Risk (CVaR) as a risk-averse objective. The task is to solve this LP for several parameter sets and risk levels to determine the optimal investment in firm ($K_g$) and renewable ($K_r$) generation capacity.\n\n### Step 1: Extract Givens\n**Decision Variables:**\n- Nonnegative capacities for firm and renewable generation: $K_g \\ge 0$, $K_r \\ge 0$.\n- Per-scenario dispatch for firm generation ($g_s$), renewable generation ($r_s$), and unmet demand ($u_s$) for scenarios $s \\in \\{1, \\dots, S\\}$.\n- CVaR auxiliary variables: $\\eta \\ge 0$ and nonnegative slack variables $\\xi_s \\ge 0$ for each scenario $s$.\n\n**Parameters:**\n- Number of scenarios: $S$.\n- Scenario-dependent demand: $D_s$.\n- Scenario-dependent renewable availability factor: $a_s$.\n- Per-unit investment costs: $c_g^I$, $c_r^I$.\n- Firm generation operating cost: $c_g^O$.\n- Penalty for unmet demand: $p$.\n- CVaR confidence level: $\\alpha \\in (0,1)$.\n\n**Objective Function (to be minimized):**\n$$\nc_g^I K_g + c_r^I K_r + \\eta + \\frac{1}{(1-\\alpha) S}\\sum_{s=1}^S \\xi_s\n$$\n\n**Constraints (for each scenario $s \\in \\{1, \\dots, S\\}$):**\n1.  $0 \\le r_s \\le a_s K_r$\n2.  $0 \\le g_s \\le K_g$\n3.  $g_s + r_s \\le D_s$\n4.  $g_s + r_s + u_s \\ge D_s$\n5.  $u_s \\ge 0$\n6.  $\\xi_s \\ge 0$\n7.  $\\xi_s \\ge c_g^O g_s + p u_s - \\eta$\n8.  $K_g \\ge 0, K_r \\ge 0, \\eta \\ge 0$ (already stated with variables)\n\n**Test Cases & Tasks:**\n- Three test cases are provided with specific values for $S$, $D_s$, $a_s$, and costs.\n- For each test case, the model must be solved for $\\alpha = 0.9, 0.95, 0.99$.\n- The primary outputs are the optimal capacities $K_g(\\alpha)$ and $K_r(\\alpha)$.\n- The final requested values are the capacities for each $\\alpha$ and the differences $\\Delta K_g = K_g(0.99) - K_g(0.9)$ and $\\Delta K_r = K_r(0.99) - K_r(0.9)$.\n\n### Step 2: Validate Using Extracted Givens\n- **Scientifically Grounded:** The problem uses a standard and widely accepted methodology (CVaR optimization) for decision-making under uncertainty in energy systems planning. The model, though simplified (e.g., single hour), respects fundamental physical and economic principles (energy balance, dispatch limits, cost structure). The formulation is correct.\n- **Well-Posed:** The problem is a Linear Program (LP). The objective function is linear, and all constraints are linear inequalities. Given that all costs and variables are nonnegative, the objective function is bounded below by zero. A feasible solution always exists (e.g., set all capacities and dispatch to zero, resulting in a finite objective value from unmet demand penalties). Therefore, an optimal solution is guaranteed to exist.\n- **Objective:** The problem is stated using precise mathematical formalism and provides unambiguous numerical data. There are no subjective or opinion-based components.\n- **Completeness and Consistency:** All required parameters are provided for each test case. The units are consistent (power in $\\mathrm{MW}$, energy in $\\mathrm{MWh}$, costs in currency/$\\mathrm{MW}$ or currency/$\\mathrm{MWh}$), and the assumption of a single hour makes power and energy numerically equivalent, which is explicitly noted. The constraints are not contradictory.\n\n### Step 3: Verdict and Action\nThe problem is valid. It is a well-posed, scientifically sound, and fully specified linear programming task. A solution can be constructed and implemented.\n\n### Principle-Based Design and Solution\nThe core of this problem is to find an optimal investment strategy that balances upfront investment costs with future operational risks. The risk is captured by the CVaR of the operating costs.\n\n**1. CVaR and its Linear Formulation:**\nConditional Value at Risk (CVaR), also known as Expected Shortfall, quantifies the expected value of costs that exceed a certain threshold (the Value at Risk, VaR). For a given confidence level $\\alpha$, CVaR$_\\alpha$ represents the average of the worst $(1-\\alpha)\\%$ of outcomes. A higher $\\alpha$ signifies greater risk aversion, as the planner focuses on a smaller, more extreme tail of high-cost scenarios.\n\nThe problem uses the Rockafellar-Uryasev formulation, which enables the optimization of CVaR within a linear programming framework. The operating cost in a scenario $s$ is $C_s = c_g^O g_s + p u_s$. The CVaR of this cost is formulated as:\n$$\n\\text{CVaR}_\\alpha(\\{C_s\\}) = \\min_{\\eta} \\left( \\eta + \\frac{1}{(1-\\alpha) S} \\sum_{s=1}^S \\max(0, C_s - \\eta) \\right)\n$$\nBy introducing nonnegative slack variables $\\xi_s \\ge \\max(0, C_s - \\eta)$, this minimization can be integrated directly into the main problem. The constraints $\\xi_s \\ge 0$ and $\\xi_s \\ge C_s - \\eta$ linearize the $\\max$ operator, resulting in the LP structure provided in the problem statement. The variable $\\eta$ can be interpreted as the Value at Risk (VaR) at the optimal solution.\n\n**2. Structuring the Linear Program:**\nTo solve this problem using a standard LP solver like `scipy.optimize.linprog`, we must express it in the canonical form $\\min_{\\mathbf{x}} \\mathbf{c}^T \\mathbf{x}$ subject to $A_{ub} \\mathbf{x} \\le \\mathbf{b}_{ub}$ and variable bounds.\n\n**Decision Variable Vector ($\\mathbf{x}$):** The decision variables are arranged into a single vector. For $S$ scenarios, there are $3 + 4S$ variables. We define the vector $\\mathbf{x}$ as:\n$$\n\\mathbf{x} = [K_g, K_r, \\eta, g_0, \\dots, g_{S-1}, r_0, \\dots, r_{S-1}, u_0, \\dots, u_{S-1}, \\xi_0, \\dots, \\xi_{S-1}]^T\n$$\nNote the use of $0$-based indexing for scenarios ($s=0, \\dots, S-1$) to align with programming conventions.\n\n**Cost Vector ($\\mathbf{c}$):** The cost vector $\\mathbf{c}$ contains the coefficients of each variable in the objective function:\n$$\n\\mathbf{c}^T = [c_g^I, c_r^I, 1, \\underbrace{0, \\dots, 0}_{S \\text{ times}}, \\underbrace{0, \\dots, 0}_{S \\text{ times}}, \\underbrace{0, \\dots, 0}_{S \\text{ times}}, \\underbrace{\\frac{1}{(1-\\alpha)S}, \\dots, \\frac{1}{(1-\\alpha)S}}_{S \\text{ times}}]\n$$\n\n**Constraint Matrix ($A_{ub}$) and Vector ($\\mathbf{b}_{ub}$):**\nThe problem constraints are converted into a system of linear inequalities $A_{ub} \\mathbf{x} \\le \\mathbf{b}_{ub}$. There are $5S$ such constraints in total.\n\n- For each scenario $s \\in \\{0, \\dots, S-1\\}$:\n    1.  $r_s - a_s K_r \\le 0$\n    2.  $g_s - K_g \\le 0$\n    3.  $g_s + r_s \\le D_s$\n    4.  $-g_s - r_s - u_s \\le -D_s$\n    5.  $c_g^O g_s + p u_s - \\eta - \\xi_s \\le 0$\n\nThese inequalities are systematically encoded into the rows of matrix $A_{ub}$ and the vector $\\mathbf{b}_{ub}$. Non-negativity for all variables ($K_g, K_r, \\eta, g_s, r_s, u_s, \\xi_s \\ge 0$) is handled via the solver's `bounds` parameter.\n\n**3. Implementation and Analysis:**\nA Python function is implemented to programmatically construct these matrices and vectors for any given set of parameters and solve the resulting LP using `scipy.optimize.linprog`. This function is executed for each of the three test cases, and within each case, for the three specified $\\alpha$ levels ($0.9, 0.95, 0.99$).\n\nThe optimal values for $K_g$ and $K_r$ are extracted from the solver's solution vector. The change in these capacities between the least risk-averse ($\\alpha=0.9$) and most risk-averse ($\\alpha=0.99$) settings is then calculated. Increasing $\\alpha$ pressures the model to hedge against high-cost, low-probability events, which typically drives investment in more capacity to reduce reliance on expensive firm generation or catastrophic load-shedding. The sign and magnitude of $\\Delta K_g$ and $\\Delta K_r$ reveal how the optimal investment strategy shifts as risk aversion increases.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import linprog\n\ndef solve_cvar_lp(params, alpha):\n    \"\"\"\n    Sets up and solves the CVaR capacity expansion linear program.\n\n    Args:\n        params (tuple): A tuple containing the parameters for a test case.\n        alpha (float): The CVaR confidence level.\n\n    Returns:\n        tuple: A tuple containing the optimal capacities (K_g, K_r).\n    \"\"\"\n    S, D, a, c_g_I, c_r_I, c_g_O, p = params\n    \n    # --- Define dimensions of the LP ---\n    # Variables: K_g, K_r, eta, g_s[S], r_s[S], u_s[S], xi_s[S]\n    num_vars = 3 + 4 * S\n    \n    # Constraints: 5 types of constraints, each for S scenarios\n    num_cons = 5 * S\n\n    # --- Cost vector c ---\n    c = np.zeros(num_vars)\n    c[0] = c_g_I  # K_g\n    c[1] = c_r_I  # K_r\n    c[2] = 1      # eta\n    # g_s, r_s, u_s have zero cost in the objective\n    # Coefficients for xi_s\n    xi_coeff = 1 / ((1 - alpha) * S)\n    c[3 + 3 * S:] = xi_coeff\n    \n    # --- Constraint matrices A_ub and b_ub ---\n    A_ub = np.zeros((num_cons, num_vars))\n    b_ub = np.zeros(num_cons)\n    \n    row_idx = 0\n    for s in range(S):\n        # Constraint 1: r_s - a_s * K_r <= 0\n        A_ub[row_idx, 1] = -a[s]            # Coeff for K_r\n        A_ub[row_idx, 3 + S + s] = 1        # Coeff for r_s\n        b_ub[row_idx] = 0\n        row_idx += 1\n        \n        # Constraint 2: g_s - K_g <= 0\n        A_ub[row_idx, 0] = -1               # Coeff for K_g\n        A_ub[row_idx, 3 + s] = 1            # Coeff for g_s\n        b_ub[row_idx] = 0\n        row_idx += 1\n\n        # Constraint 3: g_s + r_s <= D_s\n        A_ub[row_idx, 3 + s] = 1            # Coeff for g_s\n        A_ub[row_idx, 3 + S + s] = 1        # Coeff for r_s\n        b_ub[row_idx] = D[s]\n        row_idx += 1\n        \n        # Constraint 4: g_s + r_s + u_s >= D_s  (or -g_s - r_s - u_s <= -D_s)\n        A_ub[row_idx, 3 + s] = -1           # Coeff for g_s\n        A_ub[row_idx, 3 + S + s] = -1       # Coeff for r_s\n        A_ub[row_idx, 3 + 2 * S + s] = -1   # Coeff for u_s\n        b_ub[row_idx] = -D[s]\n        row_idx += 1\n        \n        # Constraint 5: xi_s >= c_g_O*g_s + p*u_s - eta  (or c_g_O*g_s + p*u_s - eta - xi_s <= 0)\n        A_ub[row_idx, 2] = -1               # Coeff for eta\n        A_ub[row_idx, 3 + s] = c_g_O        # Coeff for g_s\n        A_ub[row_idx, 3 + 2 * S + s] = p    # Coeff for u_s\n        A_ub[row_idx, 3 + 3 * S + s] = -1   # Coeff for xi_s\n        b_ub[row_idx] = 0\n        row_idx += 1\n\n    # --- Bounds ---\n    # All variables are non-negative\n    bounds = (0, None)\n\n    # --- Solve the LP ---\n    res = linprog(c, A_ub=A_ub, b_ub=b_ub, bounds=bounds, method='highs')\n    \n    if not res.success:\n        raise RuntimeError(f\"LP solver failed for alpha={alpha} with message: {res.message}\")\n\n    K_g_opt = res.x[0]\n    K_r_opt = res.x[1]\n    \n    return K_g_opt, K_r_opt\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test Case 1: happy path, moderate penalty, variable renewables\n        (\n            5,                                     # S\n            np.array([100, 110, 120, 130, 140]),  # D\n            np.array([0.6, 0.6, 0.4, 0.2, 0.1]),  # a\n            50, 70, 40, 200                        # c_g_I, c_r_I, c_g_O, p\n        ),\n        # Test Case 2: boundary condition, very high penalty for unmet demand\n        (\n            5,                                     # S\n            np.array([100, 150, 200, 250, 300]),  # D\n            np.array([0.8, 0.5, 0.4, 0.3, 0.1]),  # a\n            50, 60, 30, 1000                       # c_g_I, c_r_I, c_g_O, p\n        ),\n        # Test Case 3: edge case, cheaper renewables, higher firm operating cost\n        (\n            5,                                     # S\n            np.array([80, 90, 100, 110, 120]),    # D\n            np.array([0.9, 0.8, 0.7, 0.6, 0.5]),  # a\n            70, 40, 50, 400                        # c_g_I, c_r_I, c_g_O, p\n        )\n    ]\n\n    alphas = [0.9, 0.95, 0.99]\n    final_results = []\n\n    for case in test_cases:\n        results_for_case = {}\n        for alpha in alphas:\n            K_g, K_r = solve_cvar_lp(case, alpha)\n            results_for_case[alpha] = (K_g, K_r)\n        \n        K_g_90, K_r_90 = results_for_case[0.90]\n        K_g_95, K_r_95 = results_for_case[0.95]\n        K_g_99, K_r_99 = results_for_case[0.99]\n\n        delta_K_g = K_g_99 - K_g_90\n        delta_K_r = K_r_99 - K_r_90\n        \n        case_output = [\n            K_g_90, K_r_90,\n            K_g_95, K_r_95,\n            K_g_99, K_r_99,\n            delta_K_g, delta_K_r\n        ]\n        final_results.extend(case_output)\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, final_results))}]\")\n\nsolve()\n```"
        }
    ]
}