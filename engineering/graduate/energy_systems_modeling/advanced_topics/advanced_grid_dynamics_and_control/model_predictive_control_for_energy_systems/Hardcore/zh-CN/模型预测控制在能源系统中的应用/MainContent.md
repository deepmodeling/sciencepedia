## 引言
面对日益增长的能源需求、可再生能源的波动性以及复杂的市场动态，传统控制方法往往难以高效、可靠地管理现代能源系统。如何在尊重多方面物理和经济约束的同时，系统性地做出具有预测性的最优决策，是当前存在的一个重要知识缺口。模型预测控制（MPC）正为此挑战提供了一个强大的解决方案。本文旨在为能源系统领域的学习者提供对MPC的全面、深入的探讨。
在接下来的章节中，您将踏上一段结构化的MPC学习之旅。第一章 **“原理与机制”** 将揭开MPC的核心面纱，详细解释其[滚动时域](@entry_id:181425)策略、底层优化问题的构建方式，以及它如何通过反馈实现鲁棒性。接着，**“应用与跨学科连接”** 将通过探索MPC在建筑能源管理、[储能优化](@entry_id:1124488)和大规模电网控制中的实际应用，展示其强大的通用性，同时揭示其与[计算神经科学](@entry_id:274500)等领域的深刻联系。最后，**“动手实践”** 部分将连接理论与实践，通过具体练习指导您构建系统模型、制定控制目标和设计[鲁棒控制](@entry_id:260994)器。这种结构化的方法将使您具备深刻而实用的理解，掌握如何应用MPC来解决复杂的能源挑战。

## 原理与机制

[模型预测控制](@entry_id:1128006)（Model Predictive Control, MPC）是一种先进的过程控制方法，它通过在每个时间步求解一个有限时域优化问题来确定控制动作。与传统的仅依赖于过去和当前误差的控制器（如[PID控制器](@entry_id:268708)）不同，MPC利用系统的动态模型来预测未来的行为，并在此基础上优化一系列控制输入。本章将深入探讨构成MPC框架的基本原理和核心机制，阐明其在复杂能源系统管理中的强大功能。

### [滚动时域](@entry_id:181425)原理：从开环问题中创造反馈

理解MPC的起点是**[滚动时域](@entry_id:181425)（receding horizon）**或**移动时域（moving horizon）**原理。为了领会其精髓，我们可以首先设想一种更简单的策略，即“一次性规划并执行”（plan-and-commit）的开环优化控制。在这种开环策略中，我们基于初始状态和对未来扰动（如负荷需求、电价）的预测，在初始时刻（例如 $k=0$）一次性地计算出覆盖整个规划周期（例如，从 $k=0$到 $k=N-1$）的最优控制序列。然后，将这个预先计算好的整个序列不加调整地应用到系统中。这种方法的显著缺点在于，它完全依赖于初始预测的准确性。一旦实际的扰动或系统行为偏离了预测模型，控制器将无法作出任何修正，导致性能下降甚至系统不稳定。

与此相反，模型预测控制通过一个巧妙的迭代循环，将开环优化问题转化为一种强大的闭环反馈策略。在每个控制周期（即每个离散时间步 $k$），MPC执行以下一系列操作：

1.  **测量与估计**：获取系统的当前状态 $x_k$。在许多实际能源系统中，并非所有状态都可以直接测量。因此，这一步通常涉及使用传感器测量值 $y_k$ 并通过一个**状态估计器**（如卡尔曼滤波器，后文将详述）来计算出当前状态的最佳估计值 $\hat{x}_k$。这一步构成了反馈回路的基础，因为它将系统的真实演化情况引入到决策过程中。

2.  **优化**：基于当前状态（或其估计值）$\hat{x}_k$ 作为初始条件，并利用对未来扰动（如未来 $N$ 个时间步的净负荷或电价预测）的最新预测信息，求解一个**有限时域最优控制问题**。该问题的解是一个覆盖未来[预测时域](@entry_id:261473)（从 $k$ 到 $k+N-1$）的完整的最优控制输入序列 $u_{k:k+N-1}^\star = \{u_k^\star, u_{k+1}^\star, \dots, u_{k+N-1}^\star\}$。

3.  **应用**：尽管我们计算出了一整个序列的未来控制动作，但MPC**仅将该序列的第一个元素 $u_k^\star$ 应用于实际系统**。序列中的其余部分 $\{u_{k+1}^\star, \dots, u_{k+N-1}^\star\}$ 则被舍弃。

4.  **时域前移**：随着时间推进到下一个时刻 $k+1$，整个预测和优化时域也向前“滚动”一步，变为从 $k+1$ 到 $k+N$。此时，系统回到步骤1，使用新的测量值来更新状态估计，并基于更新后的状态和最新的未来预测重新进行优化。

这个“测量-优化-应用-前移”的循环不断重复，构成了MPC的核心。通过在每个时间步都基于最新信息重新优化，MPC能够持续地修正其控制策略以应对未预料到的扰动和模型与现实之间的偏差。因此，[滚动时域](@entry_id:181425)原理的本质是**利用重复的开环优化来系统性地构建闭环反馈**。

### 有限时域最优控制问题

在MPC循环的核心，即“优化”步骤中，我们需要求解一个精确定义的数学问题。这个问题的形式通常是一个约束化的有限时域[最优控制](@entry_id:138479)问题。其目标是找到一个控制序列，使得一个预定义的性能指标（成本函数）在[预测时域](@entry_id:261473)内最小化，同时满足所有物理和操作上的约束。

对于一个在时间步 $k$ 初始化的MPC控制器，其优化问题的一般形式可以写为：

$$
\min_{\{u_{k+i|k}\}_{i=0}^{N-1}} J = \sum_{i=0}^{N-1} \ell(x_{k+i|k}, u_{k+i|k}, d_{k+i|k}) + V_{f}(x_{k+N|k})
$$

该优化问题受制于以下几类约束：

1.  **系统动态模型**：描述了系统状态如何随时间和控制输入演化。这是MPC进行“预测”的基础。
    $$
    x_{k+i+1|k} = f(x_{k+i|k}, u_{k+i|k}, d_{k+i|k}), \quad i = 0, 1, \dots, N-1
    $$
    其中，初始条件为当前测得的状态，$x_{k|k} = x_k$（或其估计值 $\hat{x}_k$）。符号 $v_{k+i|k}$ 表示在时间步 $k$ 预测的在未来时间步 $k+i$ 的变量 $v$ 的值。$d_{k+i|k}$ 代表对未来扰动的预测。

2.  **运行约束**：这些约束定义了系统安全、高效运行的边界。
    $$
    x_{k+i|k} \in \mathcal{X}, \quad u_{k+i|k} \in \mathcal{U}, \quad i = 0, 1, \dots, N-1
    $$
    例如，在建筑热管理应用中，状态约束 $x \in \mathcal{X}$ 可能代表室内温度必须维持在舒适区间内，而输入约束 $u \in \mathcal{U}$ 则可能代表暖通空调（HVAC）设备的最大和最小功率输出。

3.  **[终端约束](@entry_id:176488)**：为了保证[闭环系统](@entry_id:270770)的稳定性，通常需要在[预测时域](@entry_id:261473)的末端对状态施加一个约束。
    $$
    x_{k+N|k} \in \mathcal{X}_{f}
    $$
    其中 $\mathcal{X}_{f}$ 是一个经过特殊设计的**[终端集](@entry_id:163892)**。

优化问题的**目标函数** $J$ 由两部分构成：
- **阶段成本（Stage Cost）** $\ell(x, u, d)$：在[预测时域](@entry_id:261473)内的每个时间步累加。它量化了在某个特定时刻的运行成本。例如，对于一个楼宇的HVAC系统，阶段成本可能包括两项：一项是惩罚室内温度 $x_k$ 偏离设定值 $x^{\mathrm{ref}}$ 的二次项 $q(x_k - x^{\mathrm{ref}})^2$，代表对舒适度的要求；另一项是惩罚控制输入 $u_k$ （即HVAC能耗）的二次项 $r u_k^2$，代表对能源成本的要求。
- **终端成本（Terminal Cost）** $V_f(x_{k+N})$：仅在[预测时域](@entry_id:261473)的终点计算。它用于近似从时域末端 $k+N$ 开始直到无穷远的未来所产生的累积成本。正确地设计终端成本和[终端集](@entry_id:163892)对于保证MPC控制器的稳定性至关重要。

### MPC公式化的关键组成部分

上述优化问题框架中的各个组成部分——状态估计、扰动预测、约束处理、[预测时域](@entry_id:261473)和终端成本——都是设计一个成功的MPC控制器的关键。下面我们将逐一深入探讨。

#### 状态估计与卡尔曼滤波器

MPC的有效运行前提是能够准确获取每个时间步 $k$ 的当前系统状态 $x_k$。然而，在许[多能源系统](@entry_id:1128259)中，例如大型建筑或电网，状态变量（如各个区域的温度、储能单元的内部化学状态）可能无法被直接或精确地测量。我们能得到的通常是带有噪声的传感器读数 $y_k$。

为了从这些不完美的测量中重构系统状态，我们需要一个**[状态估计器](@entry_id:272846)**。对于[线性系统](@entry_id:147850)和服从高斯分布的噪声，**卡尔曼滤波器（Kalman Filter）**是理论上的最优[状态估计器](@entry_id:272846)。它以递归的方式，在“预测”和“更新”两个步骤之间交替，从而提供状态的最小[均方误差](@entry_id:175403)估计。

考虑一个受过程噪声 $w_k$（如模型不确定性）和[测量噪声](@entry_id:275238) $v_k$ 影响的线性系统：
$$
x_{k+1} = A x_k + B u_k + E w_k \\
y_k = C x_k + v_k
$$
卡尔曼滤波器的循环过程如下：
1.  **时间更新（预测）**：基于上一时刻的最终状态估计 $\hat{x}_{k-1|k-1}$ 和系统模型，预测当前时刻的状态 $\hat{x}_{k|k-1}$。这一步本质上是让模型在没有新测量的情况下“自由运行”一步。同时，它也会更新状态估计的不确定性（协方差矩阵 $P_{k|k-1}$）。
    $$
    \hat{x}_{k|k-1} = A \hat{x}_{k-1|k-1} + B u_{k-1} \\
    P_{k|k-1} = A P_{k-1|k-1} A^\top + E Q E^\top
    $$
    其中 $Q$ 是[过程噪声](@entry_id:270644) $w_k$ 的[协方差矩阵](@entry_id:139155)。

2.  **测量更新（校正）**：当新的测量值 $y_k$ 到达时，计算**新息（innovation）**，即实际测量值与预测测量值之差：$\nu_k = y_k - C \hat{x}_{k|k-1}$。新息的大小反映了模型预测与现实的偏差。然后，计算**[卡尔曼增益](@entry_id:145800)** $K_k$，它决定了我们应该在多大程度上相信这个新息。最终，用新息来校正先验状态估计，得到后验（最终）状态估计 $\hat{x}_{k|k}$：
    $$
    K_k = P_{k|k-1} C^\top (C P_{k|k-1} C^\top + R)^{-1} \\
    \hat{x}_{k|k} = \hat{x}_{k|k-1} + K_k \nu_k
    $$
    其中 $R$ 是测量噪声 $v_k$ 的协方差矩阵。

在MPC中，每个时间步 $k$ 得到的后验估计 $\hat{x}_{k|k}$ 就被用作该时刻优化问题的初始状态。对于许多系统，控制器的设计和[状态估计器](@entry_id:272846)的设计可以分开进行，这一性质被称为**[分离原理](@entry_id:176134)**。因此，我们可以独立设计一个卡尔曼滤波器，并将其提供的状态估计值“仿佛”是真实状态一样，输入到确定性的MPC优化器中。

#### 外部扰动预测的整合

能源系统的运行严重依赖于外部环境，如天气、[电力市场价格](@entry_id:1124244)和用户行为。在MPC框架中，这些因素被建模为**外生扰动** $d_k$。为了做出有远见的决策，MPC必须依赖对这些扰动在未来[预测时域](@entry_id:261473)内的演变预测，即序列 $\{d_{k+i|k}\}_{i=0}^{N-1}$。

这些预测值会直接影响MPC优化问题的三个方面：
- **动态模型**：如 $x_{k+i+1|k} = A x_{k+i|k} + B u_{k+i|k} + E d_{k+i|k}$，扰动直接驱动状态的演变。
- **成本函数**：如 $\ell(\dots, d_{k+i|k})$，扰动可能直接影响成本。例如，在经济调度中，电价 $d_k$ 会直接乘以购电量来计算成本。
- **约束**：如 $F_x x_{k+i|k} + F_u u_{k+i|k} \le f + F_d d_{k+i|k}$，约束的边界可能随扰动变化。例如，可用的太阳能发电量会影响电网交换功率的限制。

预测的质量直接决定了MPC的性能。一个拥有完美未来信息的“ clairvoyant ”（千里眼）控制器可以达到理论上的最优性能。实际的MPC控制器由于预测误差的存在，其性能会低于这个理论上限。两者之间的性能差距被称为**遗憾（regret）**。更准确的预测（即更低的预测[误差协方差](@entry_id:194780)）通常会带来更低的遗憾，使得MPC的决策更接近理论最优。

#### 系统的约束处理

对运行约束的显式处理能力是MPC相比于其他控制方法最显著的优势之一。在能源系统中，这些约束无处不在，例如电池的荷电状态（State of Charge, SoC）必须在 $0\%$ 到 $100\%$ 之间，[发电机](@entry_id:268282)的输出功率不能超过其额定容量。

MPC将这些约束直接作为优化问题的代数不等式。根据约束的性质，我们通常区分为两类：
- **硬约束（Hard Constraints）**：这些是必须在任何情况下都严格遵守的物理或安全限制。例如，储能系统的最大充放[电功率](@entry_id:273774)。在MPC的优化问题中，它们被表述为严格的不等式，如 $u_{\min} \le u_{k+i|k} \le u_{\max}$。如果优化器找不到满足所有硬约束的解，问题将变得不可行。

- **软约束（Soft Constraints）**：这些约束更多地代表性能目标或期望，偶尔的、微小的违反是可以接受的，但需要付出一定的“代价”。例如，楼宇的舒适温度范围。我们希望温度保持在 $[x_{\min}, x_{\max}]$ 内，但如果为了节省大量能源而导致温度暂时超出该范围一度，可能是值得的。为了在数学上实现这一点，我们引入非负的**[松弛变量](@entry_id:268374)（slack variables）** $s_{k+i}$，并将约束放宽为 $x_{\min} - s_{k+i}^- \le x_{k+i|k} \le x_{\max} + s_{k+i}^+$。同时，在目标函数中增加一个对[松弛变量](@entry_id:268374)的惩罚项，如 $\rho \sum (s_{k+i}^- + s_{k+i}^+)$，其中 $\rho$ 是一个大的惩罚权重。这样，优化器会尽可能地使[松弛变量](@entry_id:268374)为零（即遵守约束），但如果为了显著降低总体成本而必须违反约束时，它会选择一个最优的、最小化的违反量。

#### [预测时域](@entry_id:261473)与终端成本

**[预测时域](@entry_id:261473)的长度 $N$** 是MPC的一个关键调节参数，它体现了**性能与计算负担之间的根本权衡**。
- **性能**：更长的时域 $N$ 意味着控制器拥有更广阔的视野，能够预见到更远的未来事件（如电价的日夜周期、第二天的天气变化），从而做出更具战略性的规划。例如，一个拥有24小时[预测时域](@entry_id:261473)的楼宇控制器可以在凌晨电价便宜时预冷建筑，以应对下午的高温和高电价，从而显著降低总运行成本。一个短视的控制器（$N$ 较小）可能只会做出反应式的、局部最优的决策。
- **计算负担**：MPC需要在每个控制周期内（通常是几分钟到一小时）求解一个复杂的优化问题。优化问题的规模（变量和约束的数量）与 $N$ 正相关。对于[非线性](@entry_id:637147)或约束复杂的系统，计算时间会随着 $N$ 的增长而急剧增加。如果计算时间超过了控制周期，MPC将无法实时运行。

因此，选择 $N$ 的大小需要根据具体应用的动态特性（[系统响应](@entry_id:264152)速度）、扰动的时间尺度以及可用的计算资源来综合考虑。

**终端成本 $V_f(x_N)$** 的作用是为有限的[预测时域](@entry_id:261473)提供一个关于“未来”的总结。它弥补了时域在 $k+N$ 处被截断所带来的短视效应。一个精心设计的终端成本可以保证[闭环系统](@entry_id:270770)的稳定性，并使有限时域MPC的性能逼近理论上的无限时域最优控制。

对于线性系统和二次型成本（即[LQR问题](@entry_id:267315)），最优的终端成本 $V_f(x) = x^\top P x$ 可以通过求解**[离散代数Riccati方程](@entry_id:168652)（Discrete Algebraic Riccati Equation, DARE）**来确定。DARE源于无限时域最优控制的贝尔曼最优性原理，其解 $P$ 给出了无限时域问题的最优[价值函数](@entry_id:144750)。
$$
P = Q + A^\top P A - (A^\top P B)(R + B^\top P B)^{-1}(B^\top P A)
$$
对于一个标量系统 $x_{k+1} = ax_k + bu_k$ 和成本 $\ell(x,u)=qx^2+ru^2$，这个方程简化为一个关于 $P$ 的[二次方程](@entry_id:163234)：$b^2 P^2 + (r(1-a^2) - q b^2)P - qr = 0$。其正实数解 $P$ 即为所求。从经济学角度看，$V_f(x) = Px^2$ 代表了从状态偏差 $x$ 出发，将系统调节回原点所需的最小未来总成本。因此，它相当于对状态偏差 $x$ 的一个“影子价格”，惩罚那些长期来看“昂贵”的终端状态。

### 从名义控制到[鲁棒性能](@entry_id:274615)

到目前为止，我们讨论的MPC框架主要依赖于一个“名义上”准确的模型和预测。然而，现实世界充满了不确定性。MPC如何应对这些不确定性呢？

#### 通过反馈和追索实现的内在鲁棒性

MPC的[滚动时域](@entry_id:181425)特性为其提供了强大的**内在鲁棒性**。关键在于**追索（recourse）**的概念：在每个时间步，MPC都会根据最新的测量信息重新评估情况并制定全新的计划。

假设在时刻 $k$，MPC计算出了一个最优计划。当系统演化到 $k+1$ 时，一个未预料到的扰动（例如，光伏出力远低于预测值）发生了。由于MPC在 $k+1$ 时刻会重新测量系统状态并重新优化，它有机会对这个意外情况做出反应。新的优化问题会自然地将这个扰动的影响考虑在内，并制定出一个新的、适应当前情况的[最优控制](@entry_id:138479)计划。从价值函数的角度看，在 $k+1$ 时刻，先前在 $k$ 时刻制定的旧计划的剩余部分仍然是一个可行的（但可能非最优的）选项。因此，新优化问题的最优解所对应的成本，必然不会比继续执行旧计划的成本更差。这种在每个决策阶段都能调整未来策略以应对已发生事件的能力，就是追索。

我们可以通过一个简单的例子来精确地看到反馈是如何工作的。考虑一个同时包含预测模型和实际模型的系统。在 $k$ 时刻，由于测量更新，我们将预测模型的初始状态 $z_k$ 重置为实际测量的状态 $x_k$，即 $z_k = x_k$。此时，初始[预测误差](@entry_id:753692)为零。当系统演化一步到 $k+1$ 时，实际状态 $x_{k+1}$ 会受到实际扰动 $\ell_k$ 的影响，而预测状态 $z_{k+1}$ 则受到预测扰动 $\hat{\ell}_k$ 的影响。两者之间的差异，即一步[预测误差](@entry_id:753692) $x_{k+1} - z_{k+1}$，可以被精确推导为仅与当前的扰动预测误差 $\varepsilon_k = \ell_k - \hat{\ell}_k$ 成正比。过去的所有误差都被反馈校正环路（通过 $z_k=x_k$ 的重置）所消除。

#### 使用Tube-MPC保证[递归可行性](@entry_id:167169)

虽然内在反馈能应对扰动，但它并不总能保证在任何时候都满足所有硬约束。一个足够大的扰动可能将系统推向一个无法挽回的境地，使得在下一时刻的优化问题变得**不可行**。为了提供更强的保证，特别是在安全攸关的系统中，我们需要更高级的[鲁棒MPC](@entry_id:174393)技术，其中一种主流方法是**Tube-MPC**。

Tube-MPC的核心思想是，不再只规划一条单一的名义轨迹，而是规划一个环绕名义轨迹的“管道”（tube）。这个管道被设计得足够“粗”，以确保在所有预期的有界扰动作用下，系统的实际轨迹始终被包含在管道内部。

为了实现这一点，我们需要进行**约束紧缩（constraint tightening）**。假设我们能为一个描述实际状态与名义状态偏差的误差动态 $e_{k+1} = F e_k + w_k$ 找到一个**[鲁棒正不变集](@entry_id:1131086)（Robust Positive Invariant, RPI）** $\mathcal{S}$。RPI集 $\mathcal{S}$ 的特性是，一旦误差状态 $e_k$ 进入该集合，在所有有界扰动 $w_k \in \mathcal{W}$ 的作用下，未来的所有误差状态 $e_{k+i}$ 都将永远保持在 $\mathcal{S}$ 内部。

对于一个标量系统，如果误差动态是稳定的（即 $|F|1$），那么最小的RPI集是一个半径为 $s = \frac{\bar{w}}{1-|F|}$ 的对称区间 $[ -s, s ]$，其中 $\bar{w}$ 是扰动的最大幅值。有了这个[不变集](@entry_id:275226)，我们就可以收紧对名义轨迹的约束，以确保实际轨迹满足原始约束。例如，如果实际状态的约束是 $|x_k| \le r_x$，而我们知道误差 $|e_k|$ 始终小于等于 $s$，那么我们只需对名义状态施加更严格的约束 $|\bar{z}_k| \le r_x - s$。这个过程可以通过**庞特里亚金[差集](@entry_id:140904)（Pontryagin difference）** $\mathcal{X} \ominus \mathcal{S}$ 来形式化。

通过这种方式，只要在 $k$ 时刻存在一个满足紧缩后约束的可行计划，Tube-MPC就能保证在 $k+1$ 时刻，无论发生何种允许范围内的扰动，系统状态和控制输入都将满足原始的硬约束，并且新的优化问题仍然是可行的。这被称为**[递归可行性](@entry_id:167169)（recursive feasibility）**。

### 计算实现：从公式到实时求解

MPC的一个实际挑战是，它要求在每个控制周期内实时求解一个可能相当复杂的优化问题。对于线性系统模型、二次型成本函数和[线性约束](@entry_id:636966)的情况，这个优化问题是一个**二次规划（Quadratic Program, QP）**问题。幸运的是，Q[P问题](@entry_id:267898)是[凸优化](@entry_id:137441)中研究得最透彻的一类问题，存在高效的求解算法。

为了将MPC问题转化为标准QP形式 $\min_z \frac{1}{2} z^\top H z + f^\top z$ s.t. $Az \le b$，有两种主要方法：

1.  **稀疏（或结构化）公式化**：将[预测时域](@entry_id:261473)内所有的状态和控制输入都作为优化变量 $z = [u_0^\top, x_1^\top, u_1^\top, \dots, x_N^\top]^\top$。在这种公式化下，QP的Hessian矩阵 $H$ 是[块对角矩阵](@entry_id:145530)（因为阶段成本只关联当前的状态和输入），而描述系统动态的[等式约束](@entry_id:175290)矩阵则呈现出一种**块双对角**的稀疏带状结构。这种高度的稀疏性和结构性是关键。

2.  **稠密（或精简）公式化**：通过系统动态方程，将所有的未来状态 $x_{k+i}$ 表示为初始状态 $x_k$ 和控制序列 $\{u_{k+j}\}$ 的线性组合，从而将它们从优化变量中消除。这样，唯一的优化变量就是控制序列 $z = [u_0^\top, \dots, u_{N-1}^\top]^\top$。这种方法的优点是变量数量大大减少，但代价是QP的Hessian矩阵 $H$ 变成了一个**[稠密矩阵](@entry_id:174457)**，丧失了原有的[稀疏结构](@entry_id:755138)。

现代MPC求解器，特别是为快速实时应用设计的求解器，通常采用稀疏公式化。**[内点法](@entry_id:169727)（Interior-Point Methods, IPM）**和**积[极集](@entry_id:193237)法（Active-Set Methods, AS）**等先进算法能够利用Q[P问题](@entry_id:267898)的稀疏带状结构，通过[稀疏线性代数](@entry_id:755102)技术（如稀疏Cholesky或[LDL分解](@entry_id:751202)）来求解[KKT系统](@entry_id:751047)。其结果是，求解QP的计算复杂度可以近似地与[预测时域](@entry_id:261473) $N$ **线性相关**（即 $O(N)$），而不是与 $N$ 的三次方相关（如稠密公式化那样）。这种计算效率的提升使得MPC即便在需要长[预测时域](@entry_id:261473)和快速采样的情况下，也能够应用于实际的能源系统控制中。