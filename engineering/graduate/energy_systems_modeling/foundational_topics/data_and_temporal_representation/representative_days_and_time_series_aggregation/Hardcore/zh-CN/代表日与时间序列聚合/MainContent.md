## 引言
在能源系统分析领域，为了做出稳健的长期投资和短期运行决策，我们依赖于复杂的优化模型。然而，这些模型面临一个固有的挑战：现实世界的时间维度（如全年8760个小时）与计算资源有限性之间的矛盾。直接对全年所有时间点进行高分辨率建模，尤其是在包含[机组组合](@entry_id:1133606)或储能调度的模型中，往往会导致计算上难以处理的巨大问题。

为了解决这一难题，[时间序列聚合](@entry_id:1133181)应运而生。它是一套关键技术，旨在通过选择一小组“代表性”的时间段来压缩冗长的时间序列数据，从而在保持模型计算可行性的同时，最大限度地保留对决策至关重要的信息。然而，聚合并非没有代价，不当的简化会扭曲系统动态，导致规划结果出现严重偏差。因此，理解如何科学地进行聚合、评估其引入的误差并选择合适的方法，是所有[能源系统建模](@entry_id:1124496)者必须掌握的核心技能。

本文将系统性地引导您深入了解[时间序列聚合](@entry_id:1133181)的世界。在**“原理与机制”**一章中，我们将剖析聚合的基本原理，比较时间切片与代表性时段等核心策略，并探讨[质心与中心点](@entry_id:1122208)选择的优劣。随后的**“应用与跨学科联系”**一章将展示这些理论在[能源系统规划](@entry_id:1124498)、运行和经济分析中的实际应用，并揭示其与其他学科（如信号处理和流行病学）的深刻联系。最后，通过**“动手实践”**部分提供的一系列编程练习，您将有机会亲手量化和缓解聚合误差，将理论知识转化为解决实际问题的能力。

## 原理与机制

[能源系统规划](@entry_id:1124498)模型，尤其是那些包含[机组组合](@entry_id:1133606)和储能调度等复杂决策的模型，其[计算复杂性](@entry_id:204275)随[时间分辨率](@entry_id:194281)的增加而急剧增长。一个典型的例子是，一个以小时为步长的全年模型需要处理 $T=8760$ 个时间点。对于一个包含数十个[发电机](@entry_id:268282)的[混合整数线性规划](@entry_id:1127955)（MILP）模型而言，这意味着数十万甚至数百万的变量和约束，使得直接求解变得不切实际。因此，**[时间序列聚合](@entry_id:1133181)**（Temporal Aggregation）成为了一项至关重要的技术，它通过减少模型的时间维度来换取计算上的可行性。本章将深入探讨[时间序列聚合](@entry_id:1133181)的核心原理、关键机制及其对模型结果的影响。

### [时间序列聚合](@entry_id:1133181)的基本原理

从根本上说，[时间序列聚合](@entry_id:1133181)旨在将一个长的、详细的时间序列，如全年的逐时数据，压缩成一个规模小得多的、具有代表性的数据集。这种[降维](@entry_id:142982)操作的核心目标是在显著降低计算负担的同时，尽可能保留原始数据中对系统规划和运行至关重要的统计与时序特征。

考虑一个包含 $N=50$ 台火电机组的全年小时分辨率模型。该模型需要为每个机组在每个小时做出启停决策（二元变量）。因此，二元变量的总数将达到 $N \times T = 50 \times 8760 = 438,000$ 个。此外，诸如[爬坡约束](@entry_id:1130532)、储能状态转移等跨时间步的约束数量也与 $T$ 成正比。聚合的目标就是大幅削减这个数字。例如，我们可以用 $K=12$ 个代表性日来近似全年，每个代表性日包含 $H=24$ 小时。这样，模型中的总时间步数减少到 $K \times H = 288$ 个。二元变量的数量也相应减少到 $N \times K \times H = 50 \times 12 \times 24 = 14,400$ 个，降幅超过 $96\%$。这种变量和约束数量上的急剧减少，是聚合技术能够将原本无法求解的问题变得可行的根本原因 。

然而，这种计算上的收益并非没有代价。聚合过程必然会丢失信息，而信息丢失的方式则取决于所采用的具体聚合策略。一个拙劣的聚合方案可能会系统性地扭曲关键的系统动态，导致规划结果出现严重偏差，例如低估所需的备用容量或错误评估储能的价值。因此，理解不同聚合方法的内在属性和局限性至关重要。

### 聚合的基本方法

[时间序列聚合](@entry_id:1133181)主要有两种基本策略：**时间切片（Time Slicing）**和**代表性时段（Representative Periods）**。这两种方法在保留和丢弃何种时间信息上存在本质区别 。

#### 时间切片

时间切片方法依据负荷、可再生能源出力等多维属性的相似性，将全年所有的小时（共8760个）划分成若干个**切片（Slices）**。这个过程完全不考虑小时在日历上的原始顺序。例如，一个冬季的清晨和一个夏季的午后，如果它们的净负荷（负荷减去可再生能源出力）和能源价格等特征相似，就可能被归入同一个切片。模型最终求解的是这一组无序的、独立的运行状态，每个切片由其[质心](@entry_id:138352)（Centroid）——即该切片内所有小时的平均状态——和其权重（Weight）——即该切片包含的小时总数——来定义。

- **保留的信息**：时间切片保留了系统运行状态的**[边际分布](@entry_id:264862)**。换言之，它能很好地反映各类典型运行条件（如“高峰负荷、低风速”或“低负荷、高光照”）在一年中出现的频率。这对于评估系统的长期容量充裕性和总能量平衡非常有用。
- **丢弃的信息**：该方法完全破坏了时间的**[时序性](@entry_id:924959)（Chronology）**。由于切片之间没有先后顺序，模型无法表达任何跨小时的动态约束。例如，[发电机](@entry_id:268282)的[爬坡约束](@entry_id:1130532) $|g_{i,t} - g_{i,t-1}| \le R_i$ 或储能的状态[转移方程](@entry_id:160254) $s_{t+1} = s_t + \dots$ 都变得毫无意义，因为对于任何一个切片中的小时 $t$ 而言，其“前一个”小时 $t-1$ 是未定义的。

#### 代表性时段

与时间切片不同，代表性时段方法保留了时间序列的[局部时](@entry_id:194383)序结构。最常见的应用是**代表性日（Representative Days）**。该方法首先将全年（365天）分割成连续的日序列，然后通过聚类算法，从这365个日序列中挑选出 $K$ 个“原型”或“代表性”的日。每个代表性日都是一个完整的、长度为24小时的有序序列，并被赋予一个权重，表示它代表了多少个原始日。

- **保留的信息**：代表性时段方法保留了**时段内部的[时序性](@entry_id:924959)**。在每个24小时的代表性日内部，小时之间的先后顺序是明确的。这使得模型能够刻画日内的系统动态，如日内爬坡需求、储能的日内循环套利（在一天内充电和放电）以及机组在一天内的启停模式。
- **丢弃的信息**：该方法破坏了**时段之间的[时序性](@entry_id:924959)**。模型知道某种类型的代表性日（如“晴朗周末”）在一年中出现了多少次，但并不知道这些日子是以何种顺序出现的。因此，那些跨越数日的动态过程，如大型水库的季节性调节、火电机组的数日最小开关机时间限制，以及由连续数日的“静风无光”（Dunkelflaute）天气模式驱动的储能深度放电，都无法被直接捕捉。若要模拟这些长时程现象，必须在模型中引入额外的、复杂的**跨时段连接约束（Inter-period Linking Constraints）**。

### 代表性时段的选择：方法与原则

选择了代表性时段作为聚合策略后，下一个关键问题是如何生成这些代表。这通常被构建为一个**聚类（Clustering）**问题：将原始的 $D$ 个日序列（例如 $D=365$）划分到 $K$ 个簇中，并为每个簇确定一个代表。代表的选取主要有两种方式：**[质心](@entry_id:138352)（Centroids）**和**[中心点](@entry_id:636820)（Medoids）**。

#### [质心](@entry_id:138352)：综合性的平均图像

[质心](@entry_id:138352)是通过对一个簇内所有日序列进行分量上的算术平均而生成的**合成时段（Synthetic Period）** 。例如，一个代表性日的[质心](@entry_id:138352)，其上午9点的负荷值是该簇内所有原始日序列在上午9点负荷值的平均数。

- **优点**：[质心](@entry_id:138352)的一个关键优势在于它能够**精确地保持簇内的线性总量**。由于求和与平均运算的线性特性，使用[质心](@entry_id:138352)和相应的权重（簇内天数），可以精确地重构出原始数据中任何线性可加变量的年总量，例如年总用电量或年总发电量 。对于那些目标函数和约束主要是线性时间累加的规划模型，这一特性至关重要，它保证了模型在宏观能量平衡上的[无偏性](@entry_id:902438) 。

- **缺点**：[质心](@entry_id:138352)的主要缺点源于其平均过程。平均会**平滑掉极端事件**。一个簇的[质心](@entry_id:138352)曲线，其峰值通常会低于该簇内任何单个原始日的真实峰值，其斜率（爬坡率）也会比最陡峭的原始日曲线更平缓 。由于系统的容量充裕性恰恰是由这些极端负荷峰值和[净负荷](@entry_id:1128559)的剧烈波动所决定的，使用[质心](@entry_id:138352)会导致模型系统性地低估对调峰电源和灵活性资源的需求。此外，平均过程还可能破坏变量间的内在关联。例如，将一个“上午晴朗，下午多云”的日光照日和一个“上午多云，下午晴朗”的日平均后，可能会得到一个“全天持续阴天”的[质心](@entry_id:138352)，这种模式在现实中可能从未发生过 。

#### 中心点：真实的典型样本

中心点（或称“样本[中心点](@entry_id:636820)”）则是在一个簇内，找到那个与簇内所有其他成员的总体“距离”或“不相似度”最小的**真实存在的日序列** 。它不是一个合成的平均图像，而是一个实际发生过的典型样本。

- **优点**：[中心点](@entry_id:636820)的最大优势在于其**保真性**。因为它是一个真实的日序列，所以它完整地保留了该日内所有变量间的实际协同变化关系（如太阳能出力与空调负荷的关联）以及所有真实的时间动态（如傍晚时分[净负荷](@entry_id:1128559)的陡峭爬坡）。这对于那些依赖于多变量联合模式和时序动态的约束（如储能调度、机组爬坡）的精确建模至关重要 。在聚类算法的选择上，k-中心点（k-medoids）算法可以直接产出[中心点](@entry_id:636820)作为代表，相比之下，[k-均值](@entry_id:164073)（k-means）算法则产出[质心](@entry_id:138352) 。

- **缺点**：[中心点](@entry_id:636820)的缺点与[质心](@entry_id:138352)的优点恰好相对。由于中心点只是簇内的一个样本，它的日总量一般不等于簇内所有日的平均日总量。因此，使用中心点作为代表进行加权求和，通常**无法精确保持年总能量平衡**，会给线性总量带来一定的偏差 。

### 聚合误差的影响与度量

无论采用何种方法，聚合都不可避免地引入误差。理解这些误差的来源、如何度量它们以及它们如何影响最终的规划决策，是成功应用聚合技术的关键。

#### 误差的来源：时序特征的丢失

能源系统的可靠与经济运行不仅取决于负荷与可再生能源的平均水平，更深刻地取决于它们的**波动性、时序相关性和协同变化性**。这些特征可以通过时间序列的统计属性来刻画，而聚合过程往往会扭曲这些属性 。

- **季节性（Seasonality）**：指负荷与可再生能源随季节变化的宏观趋势，如冬季取暖高峰和夏季制冷高峰。一个可靠的规划模型必须捕捉到不同季节的系统压力，因此代表性日必须能够反映季节性特征。
- **[互相关性](@entry_id:188177)（Cross-correlation）**：指不同时间序列之间的关联。例如，太阳能出力与日照同步，与晚间用电高峰呈负相关。风速则可能与寒潮（高电热需求）相关。这些关系决定了[净负荷](@entry_id:1128559)的瞬时形态和峰值。
- **自相关性（Autocorrelation）**：指一个时间序列与其自身在不同时间延迟下的相关性，它描述了序列的“记忆性”。例如，持续数日的低风速或高负荷天气事件，在自相关函数上表现为在长延迟（如48、72小时）下仍有显著的正相关性。这种长时程的持续性是驱动系统对**长时储能**（如抽水蓄能、氢储能）需求的关键因素。简单的代表性日方法由于打破了日间时序，会完全破坏这种长时程[自相关](@entry_id:138991)信息，从而严重低估系统对长时储能的需求 。

#### 误差的度量：匹配目标的评价指标

为了量化聚合的好坏，我们需要定义合适的误差度量指标。给定原始时间序列 $x_t$ 和聚合后重构的序列 $\hat{x}_t$，常见的指标包括 ：

- **偏差（Bias）**: $b = \frac{\sum_t w_t (\hat{x}_t - x_t)}{\sum_t w_t}$，衡量系统性的高估或低估。
- **平均[绝对误差](@entry_id:139354)（MAE）**: $\mathrm{MAE} = \frac{\sum_t w_t |\hat{x}_t - x_t|}{\sum_t w_t}$，衡量平均误差的大小。
- **[均方根误差](@entry_id:170440)（RMSE）**: $\mathrm{RMSE} = \sqrt{\frac{\sum_t w_t (\hat{x}_t - x_t)^2}{\sum_t w_t}}$，该指标对大误差给予更重的惩罚。
- **[无穷范数](@entry_id:637586)误差（$L_\infty$-norm）**: $\|\hat{x} - x\|_\infty = \max_t |\hat{x}_t - x_t|$，衡量最差情况下的单点误差。
- **平均绝对百分比误差（MAPE）**：虽然常用，但当真实值 $x_t$ 接近零时（这在[净负荷](@entry_id:1128559)中很常见），该指标会变得不稳定或无定义，因此在能源系统建模中需谨慎使用。

选择哪个指标取决于我们的建模目标 ：

- **若目标是保证容量充裕性**：充裕性由系统的峰值负荷决定，即 $\max_t x_t$。对峰值的估计误差受最差单点误差的控制。因此，**[无穷范数](@entry_id:637586)误差 $L_\infty$** 是最直接相关的指标。**RMSE** 因为对大误差的敏感性，也是一个有用的辅助指标。
- **若目标是评估运行经济性**：在许多模型中，总运行成本是每小时成本的线性累加。这种情况下，总成本的误差与总能量的误差（即**偏差 Bias**）和每小时误差的平均大小（即**MAE**）密切相关。

#### 误差的后果：对可靠性评估的扭曲

聚合误差最终会传导到模型的输出，特别是对系统可靠性的评估上，如**缺电概率（Loss-of-Load Probability, LOLP）**和**期望缺电量（Expected Unserved Energy, EUE）**。

- **对[边际分布](@entry_id:264862)的扭曲**：如前所述，采用[质心](@entry_id:138352)等平均化方法会平滑掉数据，压缩分布的尾部。这意味着聚合后的[净负荷](@entry_id:1128559)分布 $\hat{F}(x)$ 的尾部会比真实分布 $F(x)$ 更“瘦”。如果一个规划模型的目标是满足某个LOLP标准（例如，$\mathbb{P}(X_t > C) \le \alpha$），它会基于这个过于乐观的分布 $\hat{F}(x)$ 来确定所需的容量 $C$。结果是，模型选择的容量 $C_{agg}$ 会偏低，当这个容量应用于真实的系统时，实际的LOLP将超出预设目标 $\alpha$，实际的EUE也会比模型预测的要高 , 。

- **对时序信息的破坏**：即使聚合方法能够完美地保留[边际分布](@entry_id:264862)（即 $\hat{F}(x) = F(x)$），由于日间时序的丢失，它仍然会错误地评估含储能系统的可靠性。模型中对每个代表性日强制施加的“储能循环约束”（即日末储能状态等于日初状态），使得模型无法看到储能在连续数日高负荷事件中的持续放电和枯竭过程。这导致模型系统性地高估储能对可靠性的贡献，从而低估EUE 。

### 缓解聚合误差的先进技术

认识到简单聚合方法的局限性后，研究者们发展了更为复杂的技术来缓解聚合误差，主要思路有两个方向：一是恢复部分时序信息，二是从根本上优化聚合过程本身。

#### 恢复时序：[状态转移矩阵](@entry_id:269075)

为了解决代表性日之间相互独立的问题，可以在模型中引入明确的连接约束，以近似地恢复日间的[时序性](@entry_id:924959) 。一种严谨且常用的方法是使用**[状态转移矩阵](@entry_id:269075)（Transition Matrix）** 。

首先，我们通过分析原始的 $D$ 天日历序列，统计从一种类型的代表性日转换到另一种类型的代表性日的次数。由此，我们构建一个 $N \times N$ 的转移计数矩阵 $T$，其中元素 $T_{ij}$ 表示在原始序列中，一个类型为 $i$ 的日子后面紧跟着一个类型为 $j$ 的日子的总次数。

这个矩阵具有明确的结构属性：其第 $i$ 行所有元素之和等于类型 $i$ 的总天数 $w_i$（因为每个 $i$ 型日后面都有一个后继日），其第 $j$ 列所有元素之和等于类型 $j$ 的总天数 $w_j$（因为每个 $j$ 型日前面都有一个前驱日）。

然后，我们可以利用这个矩阵来建立跨代表性日的储能状态守恒关系。令 $x_i^{\mathrm{end}}$ 为 $i$ 型代表性日结束时的储能状态， $x_j^{\mathrm{start}}$ 为 $j$ 型代表性日开始时的储能状态。能量守恒要求，流入所有 $j$ 型日的总能量，必须等于在所有 $j$ 型日开始时的总储能。数学上，这表示为：
$$ \sum_{i=1}^{N} T_{ij} \cdot x_i^{\mathrm{end}} = w_j \cdot x_j^{\mathrm{start}} \quad \forall j \in \{1, \dots, N\} $$
这个方程组确保了在聚合模型中，储能状态的流动在统计意义上与原始时间序列的日间转换模式相符，从而能够更好地模拟跨越多日的储能行为。

#### 优化聚合：双层规划框架

传统的聚合方法通常是两步走的启发式方法：首先，基于输入数据（如负荷、风光曲线）的某种[距离度量](@entry_id:636073)进行聚类；然后，将得到的代表性日输入能源系统模型进行求解。这种方法的缺点是，对输入数据的“良好”聚类，并不一定能保证最终模型输出（如总系统成本、投资决策）的误差最小。

为了直接优化最终的模型输出精度，可以构建一个**双层规划（Bilevel Formulation）**模型 。

- **上层问题（Upper Level）**：这是一个离散优化问题，其决策变量是聚类方案本身（即如何将原始日分配给代表性日）。其[目标函数](@entry_id:267263)是最小化**聚合模型得到的总成本**与**完整高分辨率模型得到的（预先计算好的）真实总成本**之间的误差。
- **下层问题（Lower Level）**：这就是我们熟悉的[能源系统规划](@entry_id:1124498)模型。它接收上层问题传递过来的代表性日数据，并求解出在该数据下的最优投资和运行策略，其最优目标函数值（即总成本）被返回给[上层](@entry_id:198114)问题作为其目标函数的一部分。

这种双层结构精确地表达了“寻找能使规划结果最准确的代表性日”这一目标。然而，这种方法的计算复杂度极高。由于上层是[整数规划](@entry_id:178386)，且其目标函数依赖于下层问题的解（该函数通常是非凸的），整个问题是一个混合整数[非线性规划](@entry_id:636219)问题，属于NP-hard难题。尽管求解困难，但双层规划为评估和设计高级聚合算法提供了一个理论上的“黄金标准”。