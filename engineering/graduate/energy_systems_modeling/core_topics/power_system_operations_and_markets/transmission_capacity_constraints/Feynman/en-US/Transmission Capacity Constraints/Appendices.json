{
    "hands_on_practices": [
        {
            "introduction": "This first exercise is a foundational drill in the mechanics of the DC power flow model. You will build the core mathematical tools from the ground up, starting with Kirchhoff's Current Law. This practice will solidify your understanding of how to construct a reduced nodal susceptance matrix and use it to calculate Power Transfer Distribution Factors (PTDFs), which are essential for quickly assessing how transactions impact line flows and network congestion .",
            "id": "4131826",
            "problem": "Consider a lossless $3$-bus transmission network with buses $\\{1,2,3\\}$ connected by three lines $(1,2)$, $(2,3)$, and $(1,3)$ in a triangle. Adopt the Direct Current (DC) power flow approximation with voltage magnitudes fixed at $1$ per unit and small angle differences, so that the active power flow on line $(i,j)$ is $f_{ij} = b_{ij}\\,(\\theta_i - \\theta_j)$, where $b_{ij} > 0$ is the series susceptance and $\\theta_i$ is the voltage angle at bus $i$ (in radians). Kirchhoff’s Current Law (KCL) holds at each non-slack bus: the net active power injection $P_i$ equals the sum of incident line flows. Let bus $2$ be the slack with $\\theta_2 = 0$. The given susceptances are $b_{12} = 8$ per unit, $b_{23} = 4$ per unit, and $b_{13} = 6$ per unit, all on a system base $S_{\\text{base}} = 100$ MW.\n\nA bilateral transfer is scheduled: an injection of size $T$ at bus $1$ and an equal withdrawal $-T$ at bus $3$, so that the total system net injection is zero. Define the Power Transfer Distribution Factor (PTDF) as the fraction of a $1$ MW transaction from bus $1$ to bus $3$ that appears as flow on a given line, with positive flow direction taken from the lower-numbered bus to the higher-numbered bus for each line.\n\nStarting only from KCL and the DC power flow relation $f_{ij} = b_{ij}(\\theta_i - \\theta_j)$, derive the reduced nodal susceptance matrix with slack bus $2$ removed, solve for the bus angles as functions of the transaction size $T$, and from this obtain the PTDFs on lines $(1,2)$, $(2,3)$, and $(1,3)$ for a $1$ MW transaction from bus $1$ to bus $3$. Then, for $T = 195$ MW, compute the resulting flow on line $(1,2)$ (express your answer in MW) and determine whether the thermal limit $\\bar{f}_{12} = 55$ MW is violated. The final reported answer must be the single numerical value of the flow on line $(1,2)$ in MW. Angles must be in radians.",
            "solution": "The problem is scientifically grounded, well-posed, and objective. It presents a standard analysis of a power transmission network using the DC power flow approximation, a fundamental tool in power systems engineering. All necessary parameters and conditions are provided, and no contradictions or ambiguities are present. Therefore, the problem is valid and a solution will be derived.\n\nThe analysis will be conducted in the per-unit (p.u.) system. The base power is given as $S_{\\text{base}} = 100$ MW. A power transfer of size $T$ in MW corresponds to a per-unit power of $P_{\\text{p.u.}} = T / S_{\\text{base}}$.\n\nFirst, we write Kirchhoff's Current Law (KCL) for the active power injections at the two non-slack buses, bus $1$ and bus $3$. Bus $2$ is the slack bus, so its voltage angle is the reference, $\\theta_2 = 0$ radians.\n\nThe net active power injection at bus $i$, denoted $P_i$, is the sum of all active power flows leaving the bus. The flow on a line $(i,j)$ is given by $f_{ij} = b_{ij}(\\theta_i - \\theta_j)$, where $b_{ij}$ is the line susceptance and $\\theta_i$ is the bus voltage angle.\n\nFor bus $1$:\n$$P_1 = f_{12} + f_{13} = b_{12}(\\theta_1 - \\theta_2) + b_{13}(\\theta_1 - \\theta_3)$$\nSubstituting the given values $b_{12} = 8$ p.u., $b_{13} = 6$ p.u., and the slack condition $\\theta_2 = 0$:\n$$P_1 = 8(\\theta_1 - 0) + 6(\\theta_1 - \\theta_3) = (8+6)\\theta_1 - 6\\theta_3 = 14\\theta_1 - 6\\theta_3$$\n\nFor bus $3$:\n$$P_3 = f_{31} + f_{32} = b_{13}(\\theta_3 - \\theta_1) + b_{23}(\\theta_3 - \\theta_2)$$\nSubstituting the given values $b_{13} = 6$ p.u., $b_{23} = 4$ p.u., and the slack condition $\\theta_2 = 0$:\n$$P_3 = 6(\\theta_3 - \\theta_1) + 4(\\theta_3 - 0) = -6\\theta_1 + (6+4)\\theta_3 = -6\\theta_1 + 10\\theta_3$$\n\nThese two linear equations can be written in matrix form, $\\mathbf{P'} = \\mathbf{B'} \\boldsymbol{\\theta'}$, where the primes indicate that the slack bus has been removed.\n$$\\begin{pmatrix} P_1 \\\\ P_3 \\end{pmatrix} = \\begin{pmatrix} 14  -6 \\\\ -6  10 \\end{pmatrix} \\begin{pmatrix} \\theta_1 \\\\ \\theta_3 \\end{pmatrix}$$\nThe matrix $\\mathbf{B'}$ is the reduced nodal susceptance matrix:\n$$\\mathbf{B'} = \\begin{pmatrix} 14  -6 \\\\ -6  10 \\end{pmatrix}$$\nThis is the first required derivation.\n\nNext, we solve for the bus angles as a function of the transaction size $T$. The transaction consists of an injection $P_1 = T/S_{\\text{base}}$ at bus $1$ and a withdrawal $P_3 = -T/S_{\\text{base}}$ at bus $3$. The vector of unknown angles is $\\boldsymbol{\\theta'} = (\\mathbf{B'})^{-1} \\mathbf{P'}$.\nFirst, we find the inverse of $\\mathbf{B'}$. The determinant is $\\det(\\mathbf{B'}) = (14)(10) - (-6)(-6) = 140 - 36 = 104$.\nThe inverse matrix, also known as the reduced nodal reactance matrix $\\mathbf{X'}$, is:\n$$(\\mathbf{B'})^{-1} = \\frac{1}{104} \\begin{pmatrix} 10  6 \\\\ 6  14 \\end{pmatrix}$$\nNow, we solve for the angles:\n$$\\begin{pmatrix} \\theta_1 \\\\ \\theta_3 \\end{pmatrix} = \\frac{1}{104} \\begin{pmatrix} 10  6 \\\\ 6  14 \\end{pmatrix} \\begin{pmatrix} P_1 \\\\ P_3 \\end{pmatrix} = \\frac{1}{104} \\begin{pmatrix} 10  6 \\\\ 6  14 \\end{pmatrix} \\begin{pmatrix} T/S_{\\text{base}} \\\\ -T/S_{\\text{base}} \\end{pmatrix}$$\n$$\\begin{pmatrix} \\theta_1 \\\\ \\theta_3 \\end{pmatrix} = \\frac{T}{104 \\cdot S_{\\text{base}}} \\begin{pmatrix} 10 \\cdot 1 + 6 \\cdot (-1) \\\\ 6 \\cdot 1 + 14 \\cdot (-1) \\end{pmatrix} = \\frac{T}{104 \\cdot S_{\\text{base}}} \\begin{pmatrix} 4 \\\\ -8 \\end{pmatrix}$$\nSubstituting $S_{\\text{base}} = 100$:\n$$\\theta_1 = \\frac{4T}{10400} = \\frac{T}{2600} \\quad \\text{rad}$$\n$$\\theta_3 = \\frac{-8T}{10400} = \\frac{-T}{1300} \\quad \\text{rad}$$\nThese are the bus angles as functions of the transaction size $T$ in MW, which is the second required derivation.\n\nThe Power Transfer Distribution Factor (PTDF) for a transaction from bus $k$ to bus $l$ on a line $(i,j)$, denoted $\\text{PTDF}_{ij,k-l}$, is the change in flow on line $(i,j)$ per unit of power transferred from $k$ to $l$. For a linear system, this is constant. We calculate it for a $1$ p.u. transaction from bus $1$ to bus $3$. The p.u. injection vector for this transaction is $\\Delta \\mathbf{P'} = \\begin{pmatrix} 1 \\\\ -1 \\end{pmatrix}$.\nThe corresponding change in angles is:\n$$\\Delta \\boldsymbol{\\theta'} = \\begin{pmatrix} \\Delta\\theta_1 \\\\ \\Delta\\theta_3 \\end{pmatrix} = (\\mathbf{B'})^{-1} \\Delta \\mathbf{P'} = \\frac{1}{104} \\begin{pmatrix} 10  6 \\\\ 6  14 \\end{pmatrix} \\begin{pmatrix} 1 \\\\ -1 \\end{pmatrix} = \\frac{1}{104} \\begin{pmatrix} 4 \\\\ -8 \\end{pmatrix} = \\begin{pmatrix} 1/26 \\\\ -1/13 \\end{pmatrix}$$\nThe PTDF for a line $(i,j)$ is then $\\text{PTDF}_{ij,1-3} = b_{ij}(\\Delta\\theta_i - \\Delta\\theta_j)$, respecting the specified flow direction from lower to higher bus number.\n- For line $(1,2)$: $\\text{PTDF}_{12,1-3} = b_{12}(\\Delta\\theta_1 - \\Delta\\theta_2) = 8(\\frac{1}{26} - 0) = \\frac{8}{26} = \\frac{4}{13}$.\n- For line $(2,3)$: $\\text{PTDF}_{23,1-3} = b_{23}(\\Delta\\theta_2 - \\Delta\\theta_3) = 4(0 - (-\\frac{1}{13})) = \\frac{4}{13}$.\n- For line $(1,3)$: $\\text{PTDF}_{13,1-3} = b_{13}(\\Delta\\theta_1 - \\Delta\\theta_3) = 6(\\frac{1}{26} - (-\\frac{1}{13})) = 6(\\frac{1}{26} + \\frac{2}{26}) = 6(\\frac{3}{26}) = \\frac{18}{26} = \\frac{9}{13}$.\nThe PTDFs for lines $(1,2)$, $(2,3)$, and $(1,3)$ are $\\frac{4}{13}$, $\\frac{4}{13}$, and $\\frac{9}{13}$, respectively. This is the third part of the derivation.\n\nFinally, we compute the flow on line $(1,2)$ for a transaction of $T = 195$ MW. The flow in MW is the product of the dimensionless PTDF and the transaction size in MW.\n$$f_{12, \\text{MW}} = \\text{PTDF}_{12,1-3} \\times T$$\n$$f_{12, \\text{MW}} = \\frac{4}{13} \\times 195$$\nSince $195 = 13 \\times 15$, we have:\n$$f_{12, \\text{MW}} = 4 \\times 15 = 60$$\nThe resulting flow on line $(1,2)$ is $60$ MW.\n\nThe problem also asks to check this flow against the thermal limit $\\bar{f}_{12} = 55$ MW. Since $60 \\text{ MW} > 55 \\text{ MW}$, the thermal limit on line $(1,2)$ is violated by this transaction. The final requested answer is the numerical value of the flow itself.\nThe flow on line $(1,2)$ is $60$ MW.",
            "answer": "$$\\boxed{60}$$"
        },
        {
            "introduction": "Moving beyond pure calculation, this practice challenges you to explore the physical principles that distinguish the DC power flow model from more abstract network flow problems. You will investigate why Kirchhoff's Voltage Law (KVL) creates nonseparable, network-wide constraints on power flows, a feature absent in simple max-flow models. By constructing a counterexample, you will gain a deeper appreciation for the physical realism embedded in the DC approximation and correctly determine the true maximum transfer capability of a network .",
            "id": "4131844",
            "problem": "Consider the Direct Current (DC) power flow approximation for transmission networks, in which phase angles are measured in radians. Kirchhoff’s Current Law (KCL) states that the algebraic sum of currents (here, power flows) into a node equals the net injection at that node. Kirchhoff’s Voltage Law (KVL) imposes that the sum of voltage drops (here, phase angle differences scaled by line susceptances) around any cycle is zero. In the DC model, the active power flow on line $\\{i,j\\}$ is given by $f_{ij} = b_{ij}(\\theta_{i} - \\theta_{j})$, where $b_{ij} > 0$ is the series susceptance and $\\theta_{k}$ is the voltage phase angle at bus $k$. Unlike max-flow models that impose only edge-wise capacities and node-wise conservation, the DC model couples flows globally through the phase angles, embedding nonseparable constraints.\n\nConstruct and analyze the following three-bus network to make this distinction precise and to quantify the impact of line constraints:\n\n- Buses are labeled $1$, $2$, and $3$. All lines are present: $\\{1,2\\}$, $\\{2,3\\}$, and $\\{1,3\\}$.\n- Susceptances are $b_{12} = b_{23} = b_{13} = 1$ (per unit on a consistent base).\n- Thermal capacities are $C_{12} = C_{23} = C_{13} = 100$ megawatts (MW).\n- Choose bus $3$ as the angle reference (slack), with $\\theta_{3} = 0$.\n- Net injections are $p_{1} = P$, $p_{2} = 0$, and $p_{3} = -P$, so total injection balances to zero.\n\nTasks:\n1. Using the definitions of Kirchhoff’s Current Law (KCL) and Kirchhoff’s Voltage Law (KVL), explain why the DC model imposes nonseparable constraints on the line flows through the existence of a single phase-angle vector $\\theta$ that must rationalize all $f_{ij}$.\n2. Provide a counterexample based on this network showing that a max-flow solution of value $200$ MW that routes $f_{12} = 100$, $f_{23} = 100$, and $f_{13} = 100$ violates DC power flow constraints, by demonstrating that no phase-angle vector $\\theta$ can produce those flows.\n3. Derive the DC-feasible line flows as functions of $P$ and determine the maximum transferable power $P_{\\max}$ such that all line flows satisfy $|f_{ij}| \\leq C_{ij}$ for each line $\\{i,j\\} \\in \\{\\{1,2\\}, \\{2,3\\}, \\{1,3\\}\\}$.\n\nExpress the final maximum transferable power in megawatts (MW). Round your answer to four significant figures.",
            "solution": "The problem statement is evaluated as valid. It is scientifically grounded in the principles of electrical circuit theory as applied to power systems (specifically, the DC power flow approximation), is well-posed with a complete and consistent set of data, and is expressed in objective, formal language. It presents a standard, non-trivial problem in power system analysis.\n\nThe solution proceeds by addressing the three tasks in order.\n\n### Task 1: Explanation of Nonseparable Constraints\n\nThe core of the Direct Current (DC) power flow model is the relationship between power flow $f_{ij}$ on a line connecting bus $i$ and bus $j$, the line's series susceptance $b_{ij}$, and the voltage phase angles $\\theta_i$ and $\\theta_j$ at the buses:\n$$f_{ij} = b_{ij}(\\theta_i - \\theta_j)$$\nKirchhoff’s Current Law (KCL) must be satisfied at each bus $k$. It states that the net power injection $p_k$ at the bus must equal the sum of all power flows leaving the bus:\n$$p_k = \\sum_{j \\sim k} f_{kj} = \\sum_{j \\sim k} b_{kj}(\\theta_k - \\theta_j)$$\nwhere the summation is over all buses $j$ adjacent to bus $k$.\n\nIn this problem, we have a network of $N=3$ buses. By designating one bus as the reference (slack bus), in this case bus $3$ with $\\theta_3 = 0$, we have $N-1=2$ unknown phase angles, $\\theta_1$ and $\\theta_2$. The KCL equations for the non-slack buses (bus $1$ and bus $2$) form a system of linear equations that determines these angles:\n$$p_1 = b_{12}(\\theta_1 - \\theta_2) + b_{13}(\\theta_1 - \\theta_3)$$\n$$p_2 = b_{21}(\\theta_2 - \\theta_1) + b_{23}(\\theta_2 - \\theta_3)$$\nOnce this system is solved for the phase angle vector $\\theta = (\\theta_1, \\theta_2, ..., \\theta_N)$, the flow on *every* line in the network is uniquely determined.\n\nThe constraints are \"nonseparable\" because the flow on any single line, say $f_{ab}$, cannot be chosen or constrained independently of the flow on another line, $f_{cd}$. Both flows are functions of the same global state variable, the phase angle vector $\\theta$. A change that affects $\\theta_i$ anywhere in the network can, in principle, alter the angle differences $(\\theta_k - \\theta_l)$ and thus the flows $f_{kl}$ across the entire network. This global coupling is a direct consequence of Kirchhoff’s Voltage Law (KVL), which is implicitly satisfied by defining flows via a potential function (the phase angles). KVL for any loop requires the sum of angle differences around that loop to be zero, e.g., $(\\theta_i - \\theta_j) + (\\theta_j - \\theta_k) + (\\theta_k - \\theta_i) = 0$. The existence of the single vector $\\theta$ that rationalizes all flows guarantees this condition holds for all loops. This is in stark contrast to simpler max-flow models where flows are only constrained locally by edge capacities and node conservation (KCL), allowing any set of flows that meets these local rules.\n\n### Task 2: Counterexample for a Max-Flow Solution\n\nThe problem proposes a set of flows consistent with a max-flow transfer of $200$ MW from bus $1$ to bus $3$: $f_{12} = 100$ MW, $f_{23} = 100$ MW, and $f_{13} = 100$ MW. These flows satisfy the capacity constraints ($|f_{ij}| \\leq 100$) and KCL for an injection pattern $p_1 = f_{12} + f_{13} = 100 + 100 = 200$ MW, $p_2 = f_{21} + f_{23} = -f_{12} + f_{23} = -100 + 100 = 0$ MW, and $p_3 = f_{31} + f_{32} = -f_{13} - f_{23} = -100 - 100 = -200$ MW. This corresponds to the problem's setup with $P = 200$.\n\nWe must now test if a phase angle vector $\\theta = (\\theta_1, \\theta_2, \\theta_3)$ exists that can produce these flows. We are given $b_{12}=b_{23}=b_{13}=1$ and the reference $\\theta_3=0$.\nFrom the definition $f_{ij} = b_{ij}(\\theta_i - \\theta_j)$, we attempt to solve for $\\theta_1$ and $\\theta_2$:\n1. $f_{13} = b_{13}(\\theta_1 - \\theta_3) \\implies 100 = 1(\\theta_1 - 0) \\implies \\theta_1 = 100$.\n2. $f_{23} = b_{23}(\\theta_2 - \\theta_3) \\implies 100 = 1(\\theta_2 - 0) \\implies \\theta_2 = 100$.\n\nNow, we use these derived angle values to check for consistency with the third flow, $f_{12}$:\n3. $f_{12} = b_{12}(\\theta_1 - \\theta_2) = 1(100 - 100) = 0$.\n\nHowever, the proposed flow scenario requires $f_{12} = 100$. The result from the DC power flow equations ($f_{12}=0$) contradicts the required flow ($f_{12}=100$). This contradiction proves that no single, consistent phase-angle vector $\\theta$ can produce the proposed set of flows. The proposed flow set violates the physical constraints of the network (specifically KVL). The implied sum of angle drops around the loop $1 \\to 2 \\to 3 \\to 1$ is $f_{12}/b_{12} + f_{23}/b_{23} + f_{31}/b_{31} = 100/1 + 100/1 + (-100)/1 = 100$, which is not zero as required by KVL.\n\n### Task 3: Derivation of DC-Feasible Flows and Maximum Power Transfer\n\nFirst, we establish the relationship between the injections and the phase angles for the given network. The KCL equations at the non-slack buses ($1$ and $2$) are:\nAt bus $1$: $p_1 = P = b_{12}(\\theta_1 - \\theta_2) + b_{13}(\\theta_1 - \\theta_3)$\nAt bus $2$: $p_2 = 0 = b_{21}(\\theta_2 - \\theta_1) + b_{23}(\\theta_2 - \\theta_3)$\n\nSubstituting the given values $b_{12} = b_{23} = b_{13} = 1$ and $\\theta_3 = 0$:\n1. $P = 1(\\theta_1 - \\theta_2) + 1(\\theta_1 - 0) \\implies P = 2\\theta_1 - \\theta_2$\n2. $0 = 1(\\theta_2 - \\theta_1) + 1(\\theta_2 - 0) \\implies 0 = -\\theta_1 + 2\\theta_2$\n\nThis is a system of two linear equations for $\\theta_1$ and $\\theta_2$. From the second equation, we find $\\theta_1 = 2\\theta_2$. Substituting this into the first equation:\n$P = 2(2\\theta_2) - \\theta_2 = 4\\theta_2 - \\theta_2 = 3\\theta_2$\nThis gives $\\theta_2 = \\frac{P}{3}$.\nConsequently, $\\theta_1 = 2\\theta_2 = 2\\left(\\frac{P}{3}\\right) = \\frac{2P}{3}$.\n\nThe phase angle vector is $\\theta = (\\frac{2P}{3}, \\frac{P}{3}, 0)$. Now we can express the line flows as functions of $P$:\n$f_{12} = b_{12}(\\theta_1 - \\theta_2) = 1\\left(\\frac{2P}{3} - \\frac{P}{3}\\right) = \\frac{P}{3}$\n$f_{23} = b_{23}(\\theta_2 - \\theta_3) = 1\\left(\\frac{P}{3} - 0\\right) = \\frac{P}{3}$\n$f_{13} = b_{13}(\\theta_1 - \\theta_3) = 1\\left(\\frac{2P}{3} - 0\\right) = \\frac{2P}{3}$\n\nFinally, we find the maximum transferable power, $P_{\\max}$, by enforcing the thermal capacity constraints, $|f_{ij}| \\leq C_{ij}$, where $C_{12} = C_{23} = C_{13} = 100$ MW. Assuming $P > 0$, all flows are positive, so the absolute value is redundant.\n1. $|f_{12}| \\leq C_{12} \\implies \\frac{P}{3} \\leq 100 \\implies P \\leq 300$\n2. $|f_{23}| \\leq C_{23} \\implies \\frac{P}{3} \\leq 100 \\implies P \\leq 300$\n3. $|f_{13}| \\leq C_{13} \\implies \\frac{2P}{3} \\leq 100 \\implies P \\leq \\frac{3 \\times 100}{2} \\implies P \\leq 150$\n\nTo satisfy all three constraints simultaneously, $P$ must be less than or equal to the minimum of the three upper bounds:\n$P_{\\max} = \\min(300, 300, 150) = 150$\n\nThe maximum transferable power is $150$ MW, limited by the capacity of line $\\{1,3\\}$.\nRounding to four significant figures gives $150.0$.",
            "answer": "$$\\boxed{150.0}$$"
        },
        {
            "introduction": "This final exercise integrates the concepts of DC power flow and sensitivity analysis into a practical, high-stakes application: security-constrained transmission expansion planning. You will derive and implement Line Outage Distribution Factors (LODFs) to efficiently model $N-1$ security criteria, which mandate that the grid remains stable even after the unexpected loss of a single component. This practice simulates a real-world engineering task, requiring you to make an optimal investment decision to ensure grid reliability under both normal and contingency conditions .",
            "id": "4131852",
            "problem": "Consider a Direct Current (DC) approximation of transmission network flows in energy systems modeling, governed by Kirchhoff’s Current Law (KCL) and the linearized relationship between net power injection and bus voltage phase angles. Let $N$ denote the number of buses, $L$ denote the number of transmission lines, and fix a single slack bus with phase angle set to zero to render the reduced nodal susceptance matrix invertible. A line connecting bus $i$ to bus $j$ has susceptance $b_{\\ell} = 1/x_{\\ell}$, where $x_{\\ell}$ is the series reactance. Under DC power flow, the bus injection vector $p \\in \\mathbb{R}^N$ satisfies $B_{\\text{red}} \\, \\theta_{\\text{red}} = p_{\\text{red}}$ after removing the slack bus row and column from the bus susceptance matrix $B$, and line flows are $f_{\\ell} = b_{\\ell} \\left(\\theta_i - \\theta_j\\right)$ for an orientation $i \\rightarrow j$. All flows and capacities must be treated in megawatts (MW).\n\nYour task is to incorporate $N\\!-\\!1$ security into a transmission expansion planning decision by enforcing post-contingency flow limits using Line Outage Distribution Factors (LODFs), derived from the DC linear model and the sensitivity of line flows to nodal transactions. Starting from the fundamental base of KCL and the DC power flow model, derive expressions to:\n- map a nodal transaction vector to line flows via a valid sensitivity construction (do not assume any shortcut or pre-given formula),\n- express the change in line flows caused by the outage of a single line using LODFs, and\n- state feasibility conditions that enforce both base-case line flow limits and all single-line post-contingency limits.\n\nThen, implement a program to select capacity upgrades on specific lines to achieve feasibility with minimum total upgrade cost. Upgrades are discrete: each eligible line either stays at its base capacity or receives a single prescribed upgrade increment.\n\nNetwork specification:\n- Number of buses: $N = 4$. Slack bus index: $0$.\n- Lines ($L = 5$), indexed $\\ell = 0,1,2,3,4$, with orientation $i \\rightarrow j$, series reactance $x_{\\ell}$, base capacity $C_{\\ell}^{\\text{base}}$, and upgrade option defined by increment $\\Delta C_{\\ell}$ and cost $c_{\\ell}$. If a line is not eligible for upgrade, its $\\Delta C_{\\ell} = 0$ and $c_{\\ell} = 0$.\n    1. $\\ell = 0$: $0 \\rightarrow 1$, $x_0 = 0.25$, $C_0^{\\text{base}} = 100$ MW, $\\Delta C_0 = 0$, $c_0 = 0$.\n    2. $\\ell = 1$: $1 \\rightarrow 2$, $x_1 = 0.30$, $C_1^{\\text{base}} = 90$ MW, $\\Delta C_1 = 30$ MW, $c_1 = 1.0$.\n    3. $\\ell = 2$: $2 \\rightarrow 3$, $x_2 = 0.20$, $C_2^{\\text{base}} = 100$ MW, $\\Delta C_2 = 25$ MW, $c_2 = 0.8$.\n    4. $\\ell = 3$: $3 \\rightarrow 0$, $x_3 = 0.25$, $C_3^{\\text{base}} = 100$ MW, $\\Delta C_3 = 0$, $c_3 = 0$.\n    5. $\\ell = 4$: $1 \\rightarrow 3$, $x_4 = 0.40$, $C_4^{\\text{base}} = 70$ MW, $\\Delta C_4 = 40$ MW, $c_4 = 1.5$.\n\nAll susceptances are $b_{\\ell} = 1/x_{\\ell}$ in per-unit consistent with DC modeling. The slack bus phase angle is set to zero.\n\nFeasibility requirements:\n- Base-case feasibility requires $\\left|f_{\\ell}\\right| \\leq C_{\\ell}$ for all lines $\\ell$, where $C_{\\ell} = C_{\\ell}^{\\text{base}} + u_{\\ell} \\Delta C_{\\ell}$ and $u_{\\ell} \\in \\{0,1\\}$ indicates whether line $\\ell$ is upgraded.\n- $N\\!-\\!1$ security feasibility requires that for each single line outage $k \\in \\{0,1,2,3,4\\}$, all remaining lines $\\ell \\neq k$ satisfy $\\left|f_{\\ell}^{\\text{post}}(k)\\right| \\leq C_{\\ell}$, where $f_{\\ell}^{\\text{post}}(k)$ represents the post-contingency flows computed via LODFs based on the base-case flows and the outage of line $k$.\n\nPlanning objective:\n- Among all upgrade vectors $u \\in \\{0,1\\}^L$ with upgrades allowed only on the eligible lines $\\ell \\in \\{1,2,4\\}$, choose the one that satisfies both base-case and $N\\!-\\!1$ feasibility with minimum total cost $\\sum_{\\ell} c_{\\ell} u_{\\ell}$.\n- If multiple upgrade sets have the same minimum total cost, select the one with the smallest total added capacity $\\sum_{\\ell} \\Delta C_{\\ell} u_{\\ell}$. If still tied, select the one whose sorted list of upgraded line indices is lexicographically smallest.\n\nUnits:\n- All flows and capacities must be evaluated and compared in megawatts (MW).\n\nTest suite:\n- Use the following four net injection vectors $p$ (MW), each of length $4$ ordered by bus index $[0,1,2,3]$. Each $p$ satisfies $\\sum_i p_i = 0$.\n    1. Case A (general feasibility challenge): $p = [180, 20, -120, -80]$ MW.\n    2. Case B (boundary check): $p = [150, 10, -100, -60]$ MW.\n    3. Case C (post-contingency stress): $p = [120, 100, -50, -170]$ MW.\n    4. Case D (potential infeasibility): $p = [240, 150, -180, -210]$ MW.\n\nImplementation requirements:\n- Derive and implement the DC flow mapping, the sensitivity construction that produces Power Transfer Distribution Factors (PTDFs) from nodal transactions across line endpoints, and then construct Line Outage Distribution Factors (LODFs) to compute post-contingency flows without re-solving the power flow for each outage.\n- Enforce both base-case and $N\\!-\\!1$ limits under the chosen upgrade set for each test case.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element corresponds to one test case and is itself a list of the upgraded line indices in ascending order. Use an empty list for a test case if no feasible upgrade set exists. For example, a valid output could look like \"[[1,4],[2],[],[1,2]]\". Your program must print exactly this single line, with no extra spaces beyond commas.",
            "solution": "The problem requires the derivation of a security-constrained transmission expansion planning model and its implementation to find a minimum-cost upgrade plan. The model is based on the Direct Current (DC) power flow approximation, incorporating N-1 security via Line Outage Distribution Factors (LODFs).\n\n### 1. The DC Power Flow Model\n\nThe DC power flow model provides a linearized relationship between bus power injections and bus voltage phase angles. It is derived from the AC power flow equations under the assumptions of a lossless network (all resistances are zero), a flat voltage profile (all bus voltage magnitudes are $1.0$ per unit), and small phase angle differences across lines ($\\sin(\\delta) \\approx \\delta$, $\\cos(\\delta) \\approx 1$).\n\n**1.1. Bus Susceptance Matrix ($B$)**\n\nThe network topology and line characteristics are captured by the bus susceptance matrix, $B$. For a network with $N$ buses, $B$ is an $N \\times N$ matrix. Each line $\\ell$ connecting bus $i$ and bus $j$ has a reactance $x_{\\ell}$ and its susceptance is defined as $b_{\\ell} = 1/x_{\\ell}$.\n\nThe elements of the $B$ matrix are constructed as follows:\n- The diagonal elements are the sum of the susceptances of all lines connected to the bus:\n  $$B_{ii} = \\sum_{j \\neq i, \\text{connected}} b_{ij}$$\n- The off-diagonal elements are the negative of the susceptance of the line connecting the two buses:\n  $$B_{ij} = -b_{ij} \\quad \\text{for } i \\neq j \\text{ and line } i-j \\text{ exists}$$\n  If no direct line connects bus $i$ and $j$, $B_{ij} = 0$.\n\n**1.2. Phase Angle and Line Flow Calculation**\n\nUnder the DC approximation, the relationship between the vector of net power injections at each bus, $p \\in \\mathbb{R}^N$, and the vector of bus voltage phase angles, $\\theta \\in \\mathbb{R}^N$, is linear:\n$$B \\theta = p$$\nThe matrix $B$ is singular because the system has a floating voltage angle reference (adding a constant to all angles does not change angle differences). To solve this, one bus is designated as the slack bus (or reference bus), and its phase angle is fixed to zero. Let bus $0$ be the slack bus, so $\\theta_0 = 0$.\n\nBy removing the row and column corresponding to the slack bus from the $B$ matrix and the corresponding entries from $p$ and $\\theta$, we obtain the reduced system:\n$$B_{\\text{red}} \\theta_{\\text{red}} = p_{\\text{red}}$$\nwhere $B_{\\text{red}}$ is the $(N-1) \\times (N-1)$ invertible reduced bus susceptance matrix, $\\theta_{\\text{red}}$ is the vector of phase angles for the non-slack buses, and $p_{\\text{red}}$ is the vector of power injections at the non-slack buses. The phase angles of the non-slack buses can then be found by:\n$$\\theta_{\\text{red}} = (B_{\\text{red}})^{-1} p_{\\text{red}} = X_{\\text{red}} p_{\\text{red}}$$\nwhere $X_{\\text{red}} = (B_{\\text{red}})^{-1}$ is the nodal impedance matrix of the reduced system.\n\nOnce all bus phase angles $\\theta = [0, \\theta_{\\text{red}}]^T$ are known, the base-case power flow $f_{\\ell}^{(0)}$ on a line $\\ell$ with orientation $i \\rightarrow j$ and susceptance $b_{\\ell}$ is given by:\n$$f_{\\ell}^{(0)} = b_{\\ell} (\\theta_i - \\theta_j)$$\nA positive flow indicates power transfer from bus $i$ to bus $j$.\n\n### 2. Sensitivity Factors for Security Analysis\n\nTo avoid re-solving the power flow for each contingency, we use sensitivity factors.\n\n**2.1. Power Transfer Distribution Factors (PTDFs)**\n\nA PTDF, denoted $\\psi_{\\ell,m}$, quantifies the change in power flow on line $\\ell$ resulting from a $1$ MW injection at a non-slack bus $m$ and a corresponding $1$ MW withdrawal at the slack bus. This corresponds to an injection vector $p'$ with $p'_m=1$, $p'_0=-1$, and all other entries zero.\n\nThe change in the reduced angle vector is $\\Delta \\theta_{\\text{red}} = X_{\\text{red}} p'_{\\text{red}}$, where $p'_{\\text{red}}$ is a vector of zeros with a $1$ at the position corresponding to bus $m$. Thus, $\\Delta \\theta_{\\text{red}}$ is the column of $X_{\\text{red}}$ corresponding to bus $m$. Let $\\hat{X}$ be the $N \\times (N-1)$ matrix formed by padding $X_{\\text{red}}$ with a top row of zeros. Then the full vector of angle changes for this transaction is the $m^{\\text{th}}$ column of $\\hat{X}$.\n\nThe change in flow on line $\\ell: i \\rightarrow j$ is:\n$$\\psi_{\\ell,m} = \\Delta f_{\\ell} = b_{\\ell} (\\Delta \\theta_i - \\Delta \\theta_j) = b_{\\ell} (\\hat{X}_{im'} - \\hat{X}_{jm'})$$\nwhere $m'$ is the index for bus $m$ in the reduced system (e.g., $m' = m-1$).\n\nMore generally, the PTDF for a transaction of $1$ MW from a source bus $s$ to a sink bus $t$, denoted $\\psi_{\\ell,st}$, is the superposition of two transactions with the slack bus: one from $s$ to slack, and one from slack to $t$.\n$$\\psi_{\\ell,st} = \\psi_{\\ell,s} - \\psi_{\\ell,t}$$\nBy convention, $\\psi_{\\ell, \\text{slack}} = 0$.\n\n**2.2. Line Outage Distribution Factors (LODFs)**\n\nAn LODF, denoted $d_{\\ell,k}$, measures the change in flow on a monitored line $\\ell$ as a fraction of the pre-contingency flow on an outaged line $k$. The outage of line $k$ (connecting buses $s$ and $t$) with pre-contingency flow $f_k^{(0)}$ means that this flow must be redistributed over the remaining network. This redistribution is equivalent to a transaction of size $f_k^{(0)}$ from bus $s$ to $t$.\n\nHowever, this transaction is routed through the original network, which includes line $k$ itself. The portion of the transaction flow that would appear on line $k$ is $\\psi_{k,st} f_k^{(0)}$. Since line $k$ is actually outaged, this portion must also be redistributed. This \"reflected\" flow is again redistributed, leading to a cascading effect. The total change in flow on line $\\ell$ is the sum of an infinite geometric series:\n$$\\Delta f_{\\ell} = \\psi_{\\ell,st} f_k^{(0)} + \\psi_{\\ell,st} (\\psi_{k,st} f_k^{(0)}) + \\psi_{\\ell,st} (\\psi_{k,st}^2 f_k^{(0)}) + \\dots$$\n$$\\Delta f_{\\ell} = \\psi_{\\ell,st} f_k^{(0)} \\sum_{n=0}^{\\infty} (\\psi_{k,st})^n = \\frac{\\psi_{\\ell,st}}{1 - \\psi_{k,st}} f_k^{(0)}$$\nThus, the LODF for the effect of an outage of line $k: s \\rightarrow t$ on line $\\ell$ is:\n$$d_{\\ell,k} = \\frac{\\psi_{\\ell,st}}{1 - \\psi_{k,st}}$$\nThe post-contingency flow on line $\\ell$ after the outage of line $k$ is then:\n$$f_{\\ell}^{\\text{post}}(k) = f_{\\ell}^{(0)} + \\Delta f_{\\ell} = f_{\\ell}^{(0)} + d_{\\ell,k} f_k^{(0)}$$\n\n### 3. Transmission Expansion Planning Formulation\n\nThe objective is to find the set of upgrades that ensures network feasibility under both base-case and all single-line contingency scenarios, at a minimum cost.\n\n**3.1. Decision Variables and Objective**\n\nThe decision variables are binary, $u_{\\ell} \\in \\{0, 1\\}$, for each line $\\ell$ eligible for upgrade. $u_{\\ell}=1$ if the upgrade is chosen, and $u_{\\ell}=0$ otherwise.\nThe total cost of the expansion plan is $C_{\\text{total}} = \\sum_{\\ell} c_{\\ell} u_{\\ell}$. The objective is to minimize this cost. Ties are broken first by choosing the plan with the smaller total added capacity, $\\sum_{\\ell} \\Delta C_{\\ell} u_{\\ell}$, and then by the one whose sorted list of upgraded line indices is lexicographically smallest.\n\n**3.2. Feasibility Conditions**\n\nFor a given set of upgrades defined by the vector $u$, the capacity of each line is $C_{\\ell} = C_{\\ell}^{\\text{base}} + u_{\\ell} \\Delta C_{\\ell}$. A plan is feasible if the following conditions hold for a given power injection vector $p$:\n\n- **Base-Case Feasibility**: The absolute flow on each line must not exceed its capacity.\n  $$|f_{\\ell}^{(0)}| \\leq C_{\\ell} \\quad \\text{for all lines } \\ell = 0, \\dots, L-1$$\n\n- **N-1 Security Feasibility**: For each possible single line outage $k \\in \\{0, \\dots, L-1\\}$, the absolute post-contingency flow on every other line $\\ell \\neq k$ must not exceed its capacity.\n  $$|f_{\\ell}^{\\text{post}}(k)| \\le C_{\\ell} \\quad \\text{for all } \\ell \\neq k \\text{ and for all contingencies } k=0, \\dots, L-1$$\n\nThe solution approach is to enumerate all possible upgrade combinations (a total of $2^3=8$ for this problem), and for each combination, check if both feasibility conditions are met. Among all feasible combinations, the optimal one is selected based on the specified criteria. If no combination is feasible, the problem has no solution for that test case.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# from scipy import ...\n\ndef solve():\n    # --- Problem Definition ---\n    N = 4  # Number of buses\n    L = 5  # Number of lines\n    SLACK_BUS = 0\n\n    # Line data: (from, to, reactance, base_capacity, upgrade_capacity, upgrade_cost)\n    # Note: Capacities and injections are in MW. Reactances are in a consistent\n    # per-unit system where the base power is 1 MW.\n    line_params = [\n        (0, 1, 0.25, 100.0, 0.0, 0.0),    # Line 0\n        (1, 2, 0.30, 90.0, 30.0, 1.0),    # Line 1\n        (2, 3, 0.20, 100.0, 25.0, 0.8),   # Line 2\n        (3, 0, 0.25, 100.0, 0.0, 0.0),    # Line 3\n        (1, 3, 0.40, 70.0, 40.0, 1.5),    # Line 4\n    ]\n    \n    upgradeable_lines_indices = [1, 2, 4]\n    \n    test_cases = [\n        np.array([180.0, 20.0, -120.0, -80.0]),   # Case A\n        np.array([150.0, 10.0, -100.0, -60.0]),   # Case B\n        np.array([120.0, 100.0, -50.0, -170.0]),  # Case C\n        np.array([240.0, 150.0, -180.0, -210.0]), # Case D\n    ]\n\n    # --- Pre-computation of Network Matrices ---\n\n    # Susceptances b_l = 1/x_l\n    b = np.array([1.0 / p[2] for p in line_params])\n\n    # Incidence Matrix A (L x N)\n    A = np.zeros((L, N))\n    for l_idx, params in enumerate(line_params):\n        i, j = params[0], params[1]\n        A[l_idx, i] = 1\n        A[l_idx, j] = -1\n\n    # Bus Susceptance Matrix B (N x N)\n    B = np.zeros((N, N))\n    for l_idx in range(L):\n        i, j = line_params[l_idx][0], line_params[l_idx][1]\n        B[i, i] += b[l_idx]\n        B[j, j] += b[l_idx]\n        B[i, j] -= b[l_idx]\n        B[j, i] -= b[l_idx]\n\n    # Reduced Bus Susceptance Matrix B_red\n    non_slack_buses = [i for i in range(N) if i != SLACK_BUS]\n    B_red = B[np.ix_(non_slack_buses, non_slack_buses)]\n    \n    # Check for invertibility\n    if np.linalg.det(B_red) == 0:\n        raise ValueError(\"Reduced bus susceptance matrix is singular.\")\n    \n    X_red = np.linalg.inv(B_red)\n\n    # Angle Sensitivity Matrix X_hat (N x (N-1))\n    X_hat = np.zeros((N, N - 1))\n    X_hat[np.ix_(non_slack_buses, range(N - 1))] = X_red\n\n    # PTDF Matrix H (L x (N-1))\n    # H[l, m_reduced] is sensitivity of line l to injection at bus m = m_reduced + 1\n    H = np.diag(b) @ A @ X_hat\n\n    # LODF Matrix D (L x L)\n    # D[l, k] is the LODF for line l during outage of line k\n    D = np.zeros((L, L))\n    for k in range(L): # Contingency line\n        s_k, t_k = line_params[k][0], line_params[k][1] # from/to buses of outaged line k\n\n        # PTDF for transaction s_k -> t_k\n        psi_k_st = 0\n        if s_k != SLACK_BUS: psi_k_st += H[k, s_k - 1]\n        if t_k != SLACK_BUS: psi_k_st -= H[k, t_k - 1]\n        \n        denominator = 1.0 - psi_k_st\n        if np.isclose(denominator, 0):\n            # This case implies network islanding or other issues, not expected here\n            # but good practice to handle. We set LODF to a large number to signal failure.\n            D[:, k] = np.inf\n            continue\n\n        for l in range(L): # Monitored line\n            if l == k: continue\n            \n            # PTDF for transaction s_k -> t_k on line l\n            psi_l_st = 0\n            if s_k != SLACK_BUS: psi_l_st += H[l, s_k - 1]\n            if t_k != SLACK_BUS: psi_l_st -= H[l, t_k - 1]\n            \n            D[l, k] = psi_l_st / denominator\n\n    # --- Main Calculation Loop ---\n    all_results = []\n\n    # Generate all 2^3 = 8 upgrade combinations\n    from itertools import product\n    upgrade_options = list(product([0, 1], repeat=len(upgradeable_lines_indices)))\n\n    for p_inj in test_cases:\n        p_red = p_inj[non_slack_buses]\n        \n        # Base-case phase angles\n        theta_red = X_red @ p_red\n        theta = np.zeros(N)\n        theta[non_slack_buses] = theta_red\n        \n        # Base-case flows\n        f_base = b * (A @ theta)\n        \n        feasible_solutions = []\n        \n        for option in upgrade_options:\n            u_vector = np.zeros(L)\n            for i, choice in enumerate(option):\n                if choice == 1:\n                    line_idx = upgradeable_lines_indices[i]\n                    u_vector[line_idx] = 1\n            \n            # Calculate capacities for this upgrade plan\n            capacities = np.array([p[3] + u_vector[i] * p[4] for i, p in enumerate(line_params)])\n            \n            is_feasible = True\n            \n            # 1. Check base-case feasibility\n            if np.any(np.abs(f_base) > capacities + 1e-9): # add tolerance\n                is_feasible = False\n            \n            # 2. Check N-1 contingency feasibility\n            if is_feasible:\n                for k in range(L): # Outage of line k\n                    f_post = f_base + D[:, k] * f_base[k]\n                    # The constraint applies to l != k.\n                    # We can create a mask to ignore the outaged line's own post_flow\n                    monitored_mask = np.ones(L, dtype=bool)\n                    monitored_mask[k] = False\n                    if np.any(np.abs(f_post[monitored_mask]) > capacities[monitored_mask] + 1e-9):\n                        is_feasible = False\n                        break\n            \n            if is_feasible:\n                cost = sum(u_vector[i] * line_params[i][5] for i in upgradeable_lines_indices)\n                added_capacity = sum(u_vector[i] * line_params[i][4] for i in upgradeable_lines_indices)\n                upgraded_indices = sorted([idx for idx, val in enumerate(u_vector) if val == 1])\n                feasible_solutions.append((cost, added_capacity, upgraded_indices))\n\n        if not feasible_solutions:\n            all_results.append([])\n        else:\n            # Sort by cost, then by added capacity, then by lexicographical order of indices\n            feasible_solutions.sort(key=lambda x: (x[0], x[1], x[2]))\n            best_solution = feasible_solutions[0][2]\n            all_results.append(best_solution)\n\n    # --- Format and Print Final Output ---\n    output_str = \"[\" + \",\".join([str(res) for res in all_results]) + \"]\"\n    output_str = output_str.replace(\" \", \"\")\n    print(output_str)\n\nsolve()\n```"
        }
    ]
}