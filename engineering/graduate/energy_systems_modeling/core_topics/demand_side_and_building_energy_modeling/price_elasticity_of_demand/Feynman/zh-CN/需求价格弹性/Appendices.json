{
    "hands_on_practices": [
        {
            "introduction": "估算需求弹性的一个直接方法是采用普通最小二乘法 (OLS) 回归。然而，当模型忽略了某个同时影响价格和需求的关键变量时，所得到的弹性估计可能会出现严重偏差，这就是所谓的“遗漏变量偏误”。本练习  将指导您通过生成合成数据，亲手量化当天气等混淆因素被忽略时，对跨期替代弹性 $\\gamma$ 的估计所造成的系统性影响，从而深刻理解模型设定的重要性。",
            "id": "4113552",
            "problem": "考虑一个由高级计量架构（AMI）智能电表生成的数据集，该电表记录了一天中两个时间窗口的用电量：一个非高峰时段窗口和一个高峰时段窗口。设 $i \\in \\{1,\\dots,N\\}$ 为家庭索引。定义消费变化的自然对数为 $y_i = \\ln\\left(\\frac{C^{\\text{peak}}_i}{C^{\\text{off}}_i}\\right)$，价格比的自然对数为 $x_i = \\ln\\left(\\frac{P^{\\text{peak}}_i}{P^{\\text{off}}_i}\\right)$，其中 $C^{\\text{peak}}_i$ 和 $C^{\\text{off}}_i$ 是以千瓦时（kWh）为单位的用电量，而 $P^{\\text{peak}}_i$ 和 $P^{\\text{off}}_i$ 是以美元/千瓦时（$\\$/\\text{kWh}$）为单位的价格。设 $w_i$ 表示高峰时段与非高峰时段之间的标量天气变化度量，例如以度-小时为单位的制冷度时（CDH），其构造方式使得较大的 $w_i$ 意味着高峰时段的热负荷更高。\n\n假设以下结构关系源于消费者在时变价格下的优化行为，与需求价格弹性的定义一致：\n$$\ny_i = \\alpha + \\gamma x_i + \\beta_w w_i + \\varepsilon_i,\n$$\n其中 $\\alpha$ 是一个常数，$\\gamma$ 是跨期替代弹性（无量纲），$\\beta_w$ 捕捉了天气敏感性（每单位天气变化的对数用电量变化），$\\varepsilon_i$ 是一个均值为零的扰动项，满足 $E[\\varepsilon_i \\mid x_i, w_i] = 0$。目标是使用普通最小二乘法（OLS）回归，从家庭的横截面数据中估计 $\\gamma$，包括不含天气控制变量和包含天气控制变量两种情况，并推断当 $x_i$ 和 $w_i$ 协变时的识别问题。\n\n你的任务是编写一个完整的程序，该程序：\n1. 根据上述模型和给定的参数集，生成 $(x_i,w_i,y_i)$ 的合成数据。\n2. 通过 OLS 在两种设定下估计 $\\gamma$：(i) 仅使用截距项将 $y_i$ 对 $x_i$ 进行回归，以及 (ii) 使用截距项将 $y_i$ 对 $x_i$ 和 $w_i$ 进行回归。\n3. 对于每个测试用例，返回两个浮点数：无天气控制变量时估计的 $\\gamma$ 和有天气控制变量时估计的 $\\gamma$。这些输出是无量纲的量，弹性估计值不适用任何物理单位。不要使用百分号；输出必须是小数。\n\n为确保科学真实性的数据生成细节：\n- 从均值为 $\\mu_X$、标准差为 $\\sigma_X$ 的正态分布中独立抽取 $x_i$，代表峰值与非峰值价格比的外生变化。\n- 构建 $w_i$ 使其与 $x_i$ 具有指定的相关性。为在有限样本中实现相关系数 $\\rho_{XW}$，首先在样本内将 $x_i$ 标准化为零均值和单位方差，形成 $x_i^{\\text{std}}$，然后独立于 $x_i$ 抽取 $z_i \\sim \\mathcal{N}(0,1)$，设置 $w_i^{\\text{std}} = \\rho_{XW} x_i^{\\text{std}} + \\sqrt{1-\\rho_{XW}^2}\\, z_i$，最后缩放 $w_i = \\sigma_W w_i^{\\text{std}}$。这将得到 $\\operatorname{Corr}(x_i^{\\text{std}}, w_i^{\\text{std}}) \\approx \\rho_{XW}$。\n- 从均值为 $0$、标准差为 $\\sigma_\\varepsilon$ 的正态分布中独立抽取 $\\varepsilon_i$。\n- 在所有测试用例中均使用 $\\alpha = 0$。\n\n对所有对数量均使用自然对数 $\\ln(\\cdot)$。价格必须解释为 $\\$/\\text{kWh}$，用电量必须解释为 $\\text{kWh}$，但程序将只处理无量纲的对数比率。\n\n通过求解每个设定下的最小二乘法正规方程来从头开始实现 OLS，以计算截距和系数，并使用适合高级编程任务的数值稳定方法。\n\n测试套件：\n对于每个测试用例，使用元组 $(N, \\gamma, \\beta_w, \\mu_X, \\sigma_X, \\rho_{XW}, \\sigma_W, \\sigma_\\varepsilon, \\text{seed})$，其值如下：\n- 测试用例 1（理想情况，外生价格变动）：$(1000, -0.3, 0.5, 0.2, 0.1, 0.0, 1.0, 0.05, 1)$。\n- 测试用例 2（天气与价格比正相关）：$(1000, -0.3, 0.5, 0.2, 0.1, 0.7, 1.0, 0.05, 2)$。\n- 测试用例 3（天气与价格比负相关）：$(1000, -0.3, 0.5, 0.2, 0.1, -0.7, 1.0, 0.05, 3)$。\n- 测试用例 4（边界情况：价格变动接近于零）：$(1000, -0.3, 0.5, 0.2, 0.01, 0.0, 1.0, 0.05, 4)$。\n- 测试用例 5（极端情况：与天气控制变量高度多重共线性）：$(1000, -0.3, 0.5, 0.2, 0.1, 0.95, 1.0, 0.05, 5)$。\n\n你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。输出应按顺序为每个测试用例列出无天气控制变量时估计的 $\\gamma$ 和有天气控制变量时估计的 $\\gamma$。例如，输出格式必须完全是\n$[\\text{tc1\\_no\\_w},\\text{tc1\\_with\\_w},\\text{tc2\\_no\\_w},\\dots,\\text{tc5\\_with\\_w}]$，\n其中每个条目都是一个浮点小数。",
            "solution": "用户提供的问题已经过验证，被确定为计量经济学中一个有效、适定且具有科学依据的练习。该问题不含说明中列出的任何使其无效的缺陷。该问题要求使用两种不同的模型设定，通过 OLS 回归从合成生成的数据中估计价格弹性参数 $\\gamma$。这是一个用来演示遗漏变量偏误概念的标准流程。\n\n数据生成的结构关系是：\n$$\ny_i = \\alpha + \\gamma x_i + \\beta_w w_i + \\varepsilon_i\n$$\n其中 $y_i$ 是对数消费比率，$x_i$ 是对数价格比率，$w_i$ 是一个与天气相关的变量，而 $\\varepsilon_i$ 是一个随机扰动项。假设 $E[\\varepsilon_i \\mid x_i, w_i] = 0$ 意味着如果我们在回归中同时包含 $x_i$ 和 $w_i$，则系数 $\\gamma$ 和 $\\beta_w$ 的 OLS 估计量将是无偏的。\n\n我们的任务是使用两种模型来估计 $\\gamma$：\n1.  一个省略了天气变量的“短”回归：$y_i$ 对 $x_i$ 和一个常数项进行回归。\n2.  一个包含了天气变量的“长”回归：$y_i$ 对 $x_i$、$w_i$ 和一个常数项进行回归。\n\n问题的核心在于实现 OLS 估计量并观察其行为。对于一个一般的线性模型 $\\mathbf{y} = \\mathbf{X}\\boldsymbol{\\beta} + \\boldsymbol{\\varepsilon}$，系数向量 $\\boldsymbol{\\beta}$ 的 OLS 估计量 $\\hat{\\boldsymbol{\\beta}}$ 是通过最小化残差平方和 $\\boldsymbol{\\varepsilon}^T\\boldsymbol{\\varepsilon} = (\\mathbf{y} - \\mathbf{X}\\boldsymbol{\\beta})^T(\\mathbf{y} - \\mathbf{X}\\boldsymbol{\\beta})$ 推导出来的。这个最小化问题产生了正规方程：\n$$\n(\\mathbf{X}^T\\mathbf{X})\\hat{\\boldsymbol{\\beta}} = \\mathbf{X}^T\\mathbf{y}\n$$\n因此，估计系数的解是：\n$$\n\\hat{\\boldsymbol{\\beta}} = (\\mathbf{X}^T\\mathbf{X})^{-1}\\mathbf{X}^T\\mathbf{y}\n$$\n对于这两种模型中的每一种，都将求解这个方程以得到 $\\hat{\\boldsymbol{\\beta}}$。在数值计算上，直接求解正规方程所代表的线性系统比显式计算矩阵的逆更稳定。\n\n数据生成过程如下：\n首先，从一个正态分布 $\\mathcal{N}(\\mu_X, \\sigma_X^2)$ 中抽取一个大小为 $N$ 的对数价格比率向量 $\\mathbf{x}$。\n其次，构建一个相关的天气向量 $\\mathbf{w}$。为了与 $\\mathbf{x}$ 达到目标相关性 $\\rho_{XW}$，首先在样本内将向量 $\\mathbf{x}$ 标准化为零均值和单位方差：$\\mathbf{x}^{\\text{std}} = (\\mathbf{x} - \\bar{x}) / s_x$，其中 $s_x$ 是样本标准差。然后，抽取一个独立于 $\\mathbf{x}$ 的标准正态随机变量向量 $\\mathbf{z}$。接着，构造一个标准化的天气向量 $\\mathbf{w}^{\\text{std}} = \\rho_{XW} \\mathbf{x}^{\\text{std}} + \\sqrt{1-\\rho_{XW}^2}\\, \\mathbf{z}$。最后，将此向量缩放以具有期望的标准差 $\\sigma_W$，得到 $\\mathbf{w} = \\sigma_W \\mathbf{w}^{\\text{std}}$。\n第三，从 $\\mathcal{N}(0, \\sigma_\\varepsilon^2)$ 中抽取一个扰动向量 $\\boldsymbol{\\varepsilon}$。\n最后，根据 $\\mathbf{y} = \\alpha + \\gamma \\mathbf{x} + \\beta_w \\mathbf{w} + \\boldsymbol{\\varepsilon}$ 计算因变量向量。根据问题要求，$\\alpha = 0$。\n\n对于模型 (i)，即“短”回归（$y_i$ 对 $x_i$），设计矩阵 $\\mathbf{X}_1$ 有两列：一列是用于截距的全1向量，另一列是向量 $\\mathbf{x}$。得到的系数向量是 $\\hat{\\boldsymbol{\\beta}}_1 = [\\hat{\\alpha}, \\hat{\\gamma}_{\\text{short}}]^T$。第二个元素 $\\hat{\\gamma}_{\\text{short}}$ 是我们感兴趣的估计值。如果被遗漏的变量 $w_i$ 与被包含的变量 $x_i$ 相关（即 $\\rho_{XW} \\neq 0$），并且其真实系数 $\\beta_w$ 非零，那么估计值 $\\hat{\\gamma}_{\\text{short}}$ 将是有偏的。该估计量的期望值为 $E[\\hat{\\gamma}_{\\text{short}}] = \\gamma + \\beta_w \\cdot \\delta$，其中 $\\delta$ 是将被遗漏的变量 $w_i$ 对被包含的变量 $x_i$ 进行回归得到的系数。\n\n对于模型 (ii)，即“长”回归（$y_i$ 对 $x_i$ 和 $w_i$），设计矩阵 $\\mathbf{X}_2$ 有三列：一列是全1向量、向量 $\\mathbf{x}$ 和向量 $\\mathbf{w}$。得到的系数向量是 $\\hat{\\boldsymbol{\\beta}}_2 = [\\hat{\\alpha}, \\hat{\\gamma}_{\\text{long}}, \\hat{\\beta}_w]^T$。因为这个模型与真实数据生成过程相匹配，并满足 OLS 假设 $E[\\varepsilon_i \\mid x_i, w_i] = 0$，所以估计值 $\\hat{\\gamma}_{\\text{long}}$（$\\hat{\\boldsymbol{\\beta}}_2$ 的第二个元素）将是真实参数 $\\gamma$ 的一个无偏且一致的估计量。\n\n程序将对每个测试用例执行此过程，生成数据，然后通过求解各自的正规方程来计算 $\\hat{\\gamma}_{\\text{short}}$ 和 $\\hat{\\gamma}_{\\text{long}}$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Generates synthetic data and performs OLS estimations for five test cases\n    to analyze omitted variable bias in elasticity estimation.\n    \"\"\"\n    \n    # Test Suite:\n    # (N, gamma_true, beta_w, mu_X, sigma_X, rho_XW, sigma_W, sigma_eps, seed)\n    test_cases = [\n        (1000, -0.3, 0.5, 0.2, 0.1, 0.0, 1.0, 0.05, 1),\n        (1000, -0.3, 0.5, 0.2, 0.1, 0.7, 1.0, 0.05, 2),\n        (1000, -0.3, 0.5, 0.2, 0.1, -0.7, 1.0, 0.05, 3),\n        (1000, -0.3, 0.5, 0.2, 0.01, 0.0, 1.0, 0.05, 4),\n        (1000, -0.3, 0.5, 0.2, 0.1, 0.95, 1.0, 0.05, 5),\n    ]\n\n    results = []\n\n    for case in test_cases:\n        N, gamma_true, beta_w, mu_X, sigma_X, rho_XW, sigma_W, sigma_eps, seed = case\n        \n        # Initialize a random number generator for reproducibility\n        rng = np.random.default_rng(seed)\n\n        # 1. Generate synthetic data\n        \n        # Draw x_i from a normal distribution\n        x = rng.normal(loc=mu_X, scale=sigma_X, size=N)\n        \n        # Construct w_i to have a specified correlation rho_XW with x_i\n        # Standardize x in the sample\n        # Using ddof=1 for sample standard deviation is standard practice\n        x_std = (x - np.mean(x)) / np.std(x, ddof=1)\n        \n        # Draw z_i from a standard normal distribution, independent of x_i\n        z = rng.normal(loc=0, scale=1, size=N)\n        \n        # Construct standardized weather variable w_std\n        # This construction ensures Corr(x_std, w_std) is approximately rho_XW\n        w_std = rho_XW * x_std + np.sqrt(1 - rho_XW**2) * z\n        \n        # Scale w to have the specified standard deviation sigma_W\n        w = sigma_W * w_std\n        \n        # Draw the error term epsilon_i\n        epsilon = rng.normal(loc=0, scale=sigma_eps, size=N)\n        \n        # Generate the dependent variable y_i using the structural equation\n        # alpha is given as 0\n        y = gamma_true * x + beta_w * w + epsilon\n\n        # 2. Estimate gamma using OLS from first principles\n\n        # Function to perform OLS estimation\n        def ols_estimate(X, y_vec):\n            \"\"\"\n            Solves the OLS normal equations: (X'X)b = X'y for b.\n            Returns the vector of estimated coefficients.\n            \"\"\"\n            # Using np.linalg.solve is more numerically stable than inverting X'X\n            try:\n                coeffs = np.linalg.solve(X.T @ X, X.T @ y_vec)\n                return coeffs\n            except np.linalg.LinAlgError:\n                # Handle cases of perfect multicollinearity, though not expected here\n                # Return NaNs if the matrix is singular\n                return np.full(X.shape[1], np.nan)\n\n        # Specification (i): OLS without weather control (y on x and intercept)\n        # Design matrix X1 = [1, x]\n        X1 = np.vstack([np.ones(N), x]).T\n        coeffs1 = ols_estimate(X1, y)\n        gamma_hat_no_w = coeffs1[1]\n        \n        # Specification (ii): OLS with weather control (y on x, w, and intercept)\n        # Design matrix X2 = [1, x, w]\n        X2 = np.vstack([np.ones(N), x, w]).T\n        coeffs2 = ols_estimate(X2, y)\n        gamma_hat_with_w = coeffs2[1]\n        \n        results.extend([gamma_hat_no_w, gamma_hat_with_w])\n\n    # Format the output as a comma-separated list of floats in brackets\n    print(f\"[{','.join(f'{r:.8f}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在许多实际市场中，价格并非完全外生，它可能与一些计量经济学家无法观测到的产品属性 $\\xi$（如服务质量）相关，从而引发内生性问题。直接使用 OLS 会导致对价格系数 $\\beta$ 的估计产生偏误。本练习  介绍了一种标准的解决方案——工具变量 (IV) 法，它利用一个与 $\\xi$ 无关但与价格 $p$ 相关的“工具”（如上游成本变动），来识别并获得对价格效应的无偏估计。",
            "id": "4113559",
            "problem": "考虑一个零售电力市场的消费者群体，他们在标记为选项 $j$ 的分时电价套餐和一个外部选项之间进行选择。选项 $j$ 的间接效用由 $U_{ij} = \\alpha - \\beta p + \\xi + \\varepsilon_{ij}$ 给出，其中 $p$ 是套餐的每千瓦时价格，$\\xi$ 是一个企业已知但计量经济学家未观测到的未观测质量部分，$\\varepsilon_{ij}$ 是一个独立同分布 (IID) 的I型极值误差。在这些假设下，选项 $j$ 的选择概率为 $P = \\frac{\\exp(\\alpha - \\beta p + \\xi)}{1 + \\exp(\\alpha - \\beta p + \\xi)}$。假设企业为应对局部需求冲击而设定价格，因此 $\\operatorname{Cov}(p,\\xi)  0$，从而引发内生性问题。\n\n我们考虑使用一个成本转移变量 $Z$ 作为工具变量 (IV) 策略，该变量影响 $p$，但对 $\\xi$ 和消费者偏好是外生的。简化式一阶段为 $p = \\pi_0 + \\pi_1 Z + \\eta$，其中 $\\pi_1  0$，$\\eta$ 是一个与 $Z$ 正交的误差项。\n\n您观察到 $Z$ 从 $Z_0$ 到 $Z_1$ 的外生增加，这使得套餐价格从每千瓦时 $p_0 = 0.12$ 美元上涨到每千瓦时 $p_1 = 0.13$ 美元。与此同时，选项 $j$ 的市场份额从 $P_0 = 0.30$ 下降到 $P_1 = 0.27$。假设该工具变量满足相关性和排他性约束：它改变了 $p$，但保持 $(\\alpha,\\xi)$ 不变。\n\n仅使用基本定义，即需求的价格弹性定义为 $\\epsilon = \\frac{\\partial Q}{\\partial p}\\frac{p}{Q}$，且对于离散选择模型 $Q = M P$ (其中 $M$ 为市场规模，因此 $\\epsilon = \\frac{\\partial P}{\\partial p}\\frac{p}{P}$)，以及由I型极值误差所蕴含的概率结构，判断以下哪个选项正确地指定了一个有效的IV策略，并正确地描述了IV引起的价格变动如何识别价格系数，以及如何影响基准点 $(p_0,P_0)$ 处的隐含自身价格弹性。\n\nA. 使用上游燃料价格 $Z$（例如，为电力公司供电的发电机所使用的区域性天然气枢纽价格）作为工具变量。$Z$ 进入一阶段方程 $p = \\pi_0 + \\pi_1 Z + \\eta$ 且 $\\pi_1  0$，并且被排除在效用函数之外，仅通过 $p$ 影响需求。利用 $(p_0,P_0)$ 和 $(p_1,P_1)$ 之间的排他性约束，对数优势比的变化可识别出 $\\hat{\\beta}_{IV} \\approx 14.70$，在 $(p_0,P_0)$ 处的隐含自身价格弹性约为 $\\epsilon \\approx -1.23$。因为 $\\operatorname{Cov}(p,\\xi)  0$，不使用工具变量而对价格进行普通最小二乘法 (OLS) 回归，会得到一个向零偏误的 $\\beta$ 估计值（负的绝对值更小），从而低估了弹性的绝对值。\n\nB. 使用电力公司服务区域内的平均家庭收入 $Z$ 作为工具变量。$Z$ 通过成本转嫁与 $p$ 相关，并因价格已概括了可负担性而被排除在效用函数之外。通过斜率 $\\frac{\\Delta P}{\\Delta p}$ 计算 $\\hat{\\beta}_{IV}$，然后设定 $\\epsilon = -\\hat{\\beta}_{IV} p_0$ 得到 $\\epsilon \\approx -0.36$。$\\beta$ 的OLS估计值会偏离零（负得更多），从而高估了弹性的绝对值。\n\nC. 使用同期的环境温度 $Z$ 作为工具变量，理由是温度只影响边际发电成本。根据观测到的 $(p_0,P_0)$ 和 $(p_1,P_1)$，对数优势比的变化意味着 $\\hat{\\beta}_{IV} \\approx -14.70$，在 $(p_0,P_0)$ 处的隐含弹性为 $\\epsilon \\approx +1.23$。OLS是无偏的，因为logit链接吸收了 $p$ 和 $\\xi$ 之间的任何相关性。\n\nD. 如选项A一样使用上游燃料价格 $Z$，但将弹性计算为 $\\epsilon = -\\hat{\\beta}_{IV}\\frac{p_0}{P_0}$，得到 $\\epsilon \\approx -5.88$。由于 $\\operatorname{Cov}(p,\\xi)  0$，OLS会夸大 $\\beta$ 的绝对值（负得更多），导致弹性估计值的绝对值过大。\n\n选择唯一的正确选项。",
            "solution": "问题陈述的严格评估如下。\n\n**步骤1：提取已知信息**\n-   消费者 $i$ 对选项 $j$ 的间接效用：$U_{ij} = \\alpha - \\beta p + \\xi + \\varepsilon_{ij}$。\n-   $p$：每千瓦时价格。\n-   $\\xi$：未观测到的质量部分；$\\operatorname{Cov}(p, \\xi)  0$。\n-   $\\varepsilon_{ij}$：独立同分布的I型极值误差。\n-   选项 $j$ 的选择概率：$P = \\frac{\\exp(\\alpha - \\beta p + \\xi)}{1 + \\exp(\\alpha - \\beta p + \\xi)}$。\n-   工具变量 (IV)：$Z$，一个成本转移变量。\n-   一阶段：$p = \\pi_0 + \\pi_1 Z + \\eta$，其中 $\\pi_1  0$ 且 $\\operatorname{Cov}(Z, \\eta) = 0$。\n-   工具变量外生性：$Z$ 对 $\\xi$ 和消费者偏好 ($\\alpha$, $\\beta$) 是外生的。\n-   观测数据点：\n    -   状态0：$Z = Z_0$，$p_0 = 0.12$ 美元/千瓦时，$P_0 = 0.30$。\n    -   状态1：$Z = Z_1$，$p_1 = 0.13$ 美元/千瓦时，$P_1 = 0.27$。\n-   假设：工具变量的变化在状态0和状态1之间不改变 $(\\alpha, \\xi)$。\n-   需求的价格弹性定义：$\\epsilon = \\frac{\\partial Q}{\\partial p}\\frac{p}{Q}$。当 $Q=MP$ 时，这变为 $\\epsilon = \\frac{\\partial P}{\\partial p}\\frac{p}{P}$。\n\n**步骤2：使用提取的信息进行验证**\n-   **科学依据：** 该问题描述了一个标准的离散选择logit模型，这是微观计量经济学和产业组织中的常用工具。由于价格与未观测质量相关（$\\operatorname{Cov}(p, \\xi)  0$）而产生的价格内生性问题是一个经典问题，所提出的工具变量（IV）策略是标准的教科书解决方案。其背景是能源市场，这是恰当的。\n-   **适定性：** 该问题提供了由一个工具变量的外生变化产生的两个不同数据点。如下所示，在给定假设下，这些信息足以识别价格系数 $\\beta$。存在一个关于 $\\beta$ 和后续弹性的唯一解。\n-   **客观性：** 该问题使用精确、客观的数学和计量经济学术语进行陈述。数据是数值性的。没有主观或基于观点的陈述。\n\n该问题没有违反任何无效性标准。它在科学上是合理的、适定的、客观的、完整的和现实的。\n\n**步骤3：结论和行动**\n问题陈述是**有效的**。开始求解。\n\n**求解推导**\n问题的核心是估计价格敏感度参数 $\\beta$，然后计算自身价格弹性。\n\n首先，我们对选择概率模型进行线性化。Logit概率由 $P = \\frac{\\exp(\\delta)}{1+\\exp(\\delta)}$ 给出，其中 $\\delta = \\alpha - \\beta p + \\xi$ 是平均效用。这可以被反转以得到对数优势比：\n$$ \\ln\\left(\\frac{P}{1-P}\\right) = \\delta = \\alpha - \\beta p + \\xi $$\n这个方程提供了转换后的概率（对数优势比）和价格 $p$ 之间的线性关系。未观测质量 $\\xi$ 作为加性误差项进入模型。\n\n问题陈述指出，企业为应对需求冲击而定价，使得 $\\operatorname{Cov}(p, \\xi)  0$。如果要对 $\\ln\\left(\\frac{P}{1-P}\\right)$ 关于 $p$ 进行普通最小二乘法 (OLS) 回归，误差项 $\\xi$ 将与回归量 $p$ 相关，导致系数 $-\\beta$ 的估计有偏。$-\\beta$ 的OLS估计量的偏差由 $\\frac{\\operatorname{Cov}(p, \\xi)}{\\operatorname{Var}(p)}$ 给出。由于 $\\operatorname{Cov}(p, \\xi)  0$，与真实的 $-\\beta$ 相比，OLS估计值 $\\hat{(-\\beta)}_{OLS}$ 向上偏误（即，负得更少）。这意味着 $\\hat{(-\\beta)}_{OLS}  -\\beta$，两边乘以-1会反转不等式：$\\hat{\\beta}_{OLS}  \\beta$。由于 $\\beta$ 代表价格敏感度并且预期为正，OLS估计值向零偏误，低估了消费者价格敏感度的绝对值。\n\nIV策略旨在纠正这种偏差。一个有效的工具变量 $Z$ 与 $p$ 相关，但与 $\\xi$ 不相关。问题提供了由工具变量 $Z$ 从 $Z_0$ 变为 $Z_1$ 产生的两个数据点 $(p_0, P_0)$ 和 $(p_1, P_1)$。IV假设是 $Z$ 的这种变化不影响 $\\alpha$ 或 $\\xi$。我们可以为每种状态写出对数优势比方程：\n状态0：$\\ln\\left(\\frac{P_0}{1-P_0}\\right) = \\alpha - \\beta p_0 + \\xi$\n状态1：$\\ln\\left(\\frac{P_1}{1-P_1}\\right) = \\alpha - \\beta p_1 + \\xi$\n\n用第二个方程减去第一个方程，可以消去常数项 $\\alpha$ 和 $\\xi$：\n$$ \\ln\\left(\\frac{P_1}{1-P_1}\\right) - \\ln\\left(\\frac{P_0}{1-P_0}\\right) = (\\alpha - \\beta p_1 + \\xi) - (\\alpha - \\beta p_0 + \\xi) = -\\beta(p_1 - p_0) $$\n这使我们能够求解 $\\beta$ 的一个估计值，即Wald估计量，它是IV估计量的一种简单形式：\n$$ \\hat{\\beta}_{IV} = \\frac{\\ln\\left(\\frac{P_0}{1-P_0}\\right) - \\ln\\left(\\frac{P_1}{1-P_1}\\right)}{p_1 - p_0} = -\\frac{\\Delta \\ln\\left(\\frac{P}{1-P}\\right)}{\\Delta p} $$\n使用给定数据：\n$p_0 = 0.12$, $P_0 = 0.30$\n$p_1 = 0.13$, $P_1 = 0.27$\n\n状态0的对数优势比：\n$\\ln\\left(\\frac{0.30}{1-0.30}\\right) = \\ln\\left(\\frac{0.3}{0.7}\\right) \\approx -0.847298$\n\n状态1的对数优势比：\n$\\ln\\left(\\frac{0.27}{1-0.27}\\right) = \\ln\\left(\\frac{0.27}{0.73}\\right) \\approx -0.994536$\n\n价格的变化是 $\\Delta p = p_1 - p_0 = 0.13 - 0.12 = 0.01$。\n对数优势比的变化是 $\\Delta \\ln\\left(\\frac{P}{1-P}\\right) = -0.994536 - (-0.847298) = -0.147238$。\n\n现在，我们计算 $\\hat{\\beta}_{IV}$：\n$$ \\hat{\\beta}_{IV} = -\\frac{-0.147238}{0.01} = 14.7238 $$\n\n接下来，我们确定自身价格弹性 $\\epsilon$ 的公式。\n$\\epsilon = \\frac{\\partial P}{\\partial p} \\frac{p}{P}$。\n我们必须求出logit模型的导数 $\\frac{\\partial P}{\\partial p}$：\n$$ \\frac{\\partial P}{\\partial p} = \\frac{\\partial}{\\partial p} \\left( \\frac{\\exp(\\alpha - \\beta p + \\xi)}{1 + \\exp(\\alpha - \\beta p + \\xi)} \\right) $$\n使用链式法则和商法则，logit模型的一个标准结果是：\n$$ \\frac{\\partial P}{\\partial p} = -\\beta \\cdot P \\cdot (1-P) $$\n将此代入弹性公式：\n$$ \\epsilon = (-\\beta P(1-P)) \\frac{p}{P} = -\\beta (1-P) p $$\n我们需要使用我们估计的 $\\hat{\\beta}_{IV}$ 来计算基准点 $(p_0, P_0) = (0.12, 0.30)$ 处的弹性。\n$$ \\epsilon_0 = -\\hat{\\beta}_{IV} (1-P_0) p_0 \\approx -14.7238 \\times (1-0.30) \\times 0.12 $$\n$$ \\epsilon_0 \\approx -14.7238 \\times 0.70 \\times 0.12 $$\n$$ \\epsilon_0 \\approx -14.7238 \\times 0.084 \\approx -1.2368 $$\n四舍五入到两位小数，$\\hat{\\beta}_{IV} \\approx 14.72$ 且 $\\epsilon \\approx -1.24$。使用选项A中给出的值 $\\hat{\\beta}_{IV} = 14.70$，弹性为 $\\epsilon = -14.70 \\times (1-0.30) \\times 0.12 = -14.70 \\times 0.7 \\times 0.12 = -1.2348$。\n\n**逐项分析**\n\n**A. 使用上游燃料价格 Z ... 利用排他性约束 ... 对数优势比的变化可识别出 $\\hat{\\beta}_{IV} \\approx 14.70$，在 $(p_0,P_0)$ 处的隐含自身价格弹性约为 $\\epsilon \\approx -1.23$。因为 $\\operatorname{Cov}(p,\\xi)  0$，普通最小二乘法 (OLS) ... 会得到一个向零偏误的 $\\beta$ 估计值 ... 从而低估了弹性的绝对值。**\n-   **工具变量选择：** 上游燃料价格是零售电价的标准有效工具变量，因为它充当成本转移变量，并且可以合理地认为是外生于未观测的零售套餐质量的。\n-   **$\\hat{\\beta}_{IV}$ 估计：** 基于“对数优势比变化”的计算是正确的IV程序，我们推导出的值 $\\hat{\\beta}_{IV} \\approx 14.72$ 与陈述的 $\\approx 14.70$ 一致。\n-   **弹性计算：** 推导出的弹性 $\\epsilon \\approx -1.23$ 与我们使用正确公式 $\\epsilon = -\\beta(1-P)p$ 和估计的 $\\beta$ 计算的结果一致。\n-   **OLS偏差：** 鉴于 $\\operatorname{Cov}(p, \\xi)  0$，关于 $\\beta$ 的OLS估计向零偏误，从而低估了弹性绝对值的说法是正确的。\n-   **结论：** 此选项完全符合计量经济学理论和所提供的数据。**正确**。\n\n**B. 使用平均家庭收入 Z ... 通过斜率 $\\frac{\\Delta P}{\\Delta p}$ 计算 $\\hat{\\beta}_{IV}$，然后设定 $\\epsilon = -\\hat{\\beta}_{IV} p_0$ 得到 $\\epsilon \\approx -0.36$。$\\beta$ 的OLS估计值会偏离零...**\n-   **工具变量选择：** 平均家庭收入不是一个有效的工具变量。它很可能违反了排他性约束，因为收入直接影响消费者效用和选择，并且可能与未观测质量 $\\xi$ 相关。\n-   **估计方法：** 从 $\\frac{\\Delta P}{\\Delta p}$ 计算参数是错误的。这对应于线性概率模型，而不是指定的logit模型。\n-   **弹性公式：** 公式 $\\epsilon = -\\hat{\\beta}_{IV} p_0$ 是错误的。它忽略了 $(1-P_0)$ 项。\n-   **OLS偏差：** 偏差偏离零的说法是错误的。偏差是朝向零的。\n-   **结论：** 此选项在每个点上都是错误的：工具变量的有效性、估计方法、弹性公式和OLS偏差的方向。**错误**。\n\n**C. 使用同期的环境温度 Z ... 对数优势比的变化意味着 $\\hat{\\beta}_{IV} \\approx -14.70$，在 $(p_0,P_0)$ 处的隐含弹性为 $\\epsilon \\approx +1.23$。OLS是无偏的，因为logit链接吸收了任何相关性...**\n-   **$\\hat{\\beta}_{IV}$ 估计：** 给定值约为 $\\approx -14.70$。负的 $\\beta$ 意味着效用随价格增加而增加，这在经济上是荒谬的。我们的计算得出了一个正值。\n-   **弹性计算：** 给定的弹性为 $\\epsilon \\approx +1.23$。电力的正价格弹性在理论上是难以置信的（它将是一种吉芬商品）。这是由 $\\beta$ 的错误符号引起的。\n-   **OLS偏差：** 声称由于“logit链接” OLS是无偏的说法是错误的。Logit变换虽然线性化了模型，但如果回归量与误差项相关，它并不能解决内生性问题。\n-   **结论：** 此选项在参数符号、弹性符号以及对OLS偏差的理解上存在根本性错误。**错误**。\n\n**D. 使用上游燃料价格 Z ... 将弹性计算为 $\\epsilon = -\\hat{\\beta}_{IV}\\frac{p_0}{P_0}$，得到 $\\epsilon \\approx -5.88$。由于 $\\operatorname{Cov}(p,\\xi)  0$，OLS会夸大 $\\beta$ 的绝对值...**\n-   **弹性公式：** 提议的公式 $\\epsilon = -\\hat{\\beta}_{IV}\\frac{p_0}{P_0}$ 是错误的。正确的公式是 $\\epsilon = -\\hat{\\beta}_{IV}(1-P_0)p_0$。计算出的 $\\epsilon \\approx -5.88$ 是基于这个错误的公式。\n-   **OLS偏差：** 声称OLS会“夸大 $\\beta$ 的绝对值”是错误的。如前所述，偏差是朝向零的，这意味着OLS低估了其绝对值。\n-   **结论：** 此选项使用了错误的弹性公式，并错误地描述了OLS偏差的方向。**错误**。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "现实世界中的消费者群体并非同质，其需求弹性 $\\beta_s$ 可能存在显著差异。为不同群体分别估计弹性虽然可行，但当某些群体数据稀疏时，估计结果会很不稳定。贝叶斯分层模型通过假设各群体的 $\\beta_s$ 来自一个共同的总体分布 $\\mathcal{N}(\\mu, \\tau^2)$，从而优雅地解决了这一挑战。本练习  将引导您实施此模型，通过在各群体间“借力”(borrowing strength) 来获得更稳健的群体弹性估计，并对总体平均弹性 $\\mu$ 进行精确的后验推断。",
            "id": "4113551",
            "problem": "考虑在能源系统建模背景下，使用贝叶斯分层模型估算多个消费群体的需求价格弹性。设需求价格弹性基本定义为 $E_p = \\frac{d \\ln Q}{d \\ln P}$，其中 $Q$ 表示以千瓦时（kWh）为单位的需求量，$P$ 表示以美元/千瓦时（USD/kWh）为单位的价格。假设每个群体 $s$ 在时间指数为 $t$ 时的对数线性需求模型由下式给出\n$$\ny_{s,t} = \\alpha_s + \\beta_s x_{s,t} + \\varepsilon_{s,t},\n$$\n其中 $y_{s,t} = \\ln Q_{s,t}$，$x_{s,t} = \\ln P_{s,t}$，$\\alpha_s$ 是特定于群体的截距，$\\beta_s$ 是特定于群体的弹性（注意 $E_{p,s} = \\beta_s$），$\\varepsilon_{s,t}$ 是独立的、服从 $\\varepsilon_{s,t} \\sim \\mathcal{N}(0,\\sigma_s^2)$ 的高斯误差，且 $\\sigma_s  0$ 是已知的。假设各群体间存在贝叶斯分层先验：\n$$\n\\beta_s \\mid \\mu, \\tau^2 \\sim \\mathcal{N}(\\mu, \\tau^2), \\quad \\mu \\sim \\mathcal{N}(m_0, V_0),\n$$\n其中超参数 $m_0 \\in \\mathbb{R}$，$V_0  0$ 和 $\\tau^2  0$ 是已知的。\n\n根据上述基本定义和模型结构，推导量化 $E_{p,s} = \\beta_s$ 和总体平均弹性 $\\mu$ 的不确定性所需的后验分布。您的推导必须从高斯误差下普通最小二乘（OLS）估计量的经典性质和 Bayes 定理开始。具体而言，利用已知高斯噪声下 OLS 斜率估计量的分布结果，将各群体的经验估计与分层结构联系起来，然后推导出无需数值采样即可精确计算的后验量。\n\n实现要求：\n- 所有涉及 $\\ln$ 的变换均使用自然对数。\n- 价格 $P$ 必须以 $\\text{USD}/\\text{kWh}$ 为单位，需求量 $Q$ 必须以 $\\text{kWh}$ 为单位。弹性是无量纲的，必须以小数表示（而非百分比）。\n- 对于每个测试用例，计算每个群体 $s$ 的 $E_{p,s}$ 的后验均值以及对称的 $95\\%$ 水平贝叶斯可信区间的端点。可信区间端点必须报告为 $(\\text{均值} \\pm 1.96 \\times \\text{后验标准差})$。\n- 同时计算总体平均弹性 $\\mu$ 的后验均值和后验方差。\n- 最终程序必须生成单行输出，包含一个用方括号括起来的逗号分隔列表形式的结果，其中每个测试用例的结果是一个嵌套列表，形式如下\n$$\n[\\mu \\text{ 的后验均值},\\ \\mu \\text{ 的后验方差},\\ [[\\text{群体 } 1\\ \\text{后验均值},\\ \\text{下界},\\ \\text{上界}],\\ldots,[\\text{群体 } S\\ \\text{后验均值},\\ \\text{下界},\\ \\text{上界}]]]\n$$\n所有值均以浮点数表示。\n\n测试套件：\n- 测试用例 1（各群体间均衡变化）：\n    - 超参数：$m_0 = -0.3$, $V_0 = 0.04$, $\\tau = 0.25$ (所以 $\\tau^2 = 0.0625$)。\n    - 群体 1：$\\sigma_1 = 0.06$, $P = [0.12,0.14,0.16,0.18,0.20,0.22]$, $Q = [430,410,395,382,370,360]$。\n    - 群体 2：$\\sigma_2 = 0.05$, $P = [0.10,0.105,0.11,0.115,0.12,0.125]$, $Q = [520,515,510,505,500,495]$。\n    - 群体 3：$\\sigma_3 = 0.04$, $P = [0.09,0.11,0.13,0.15,0.17]$, $Q = [2300,2200,2100,2000,1900]$。\n- 测试用例 2（一个群体中价格近似恒定的边缘情况，强池化）：\n    - 超参数：$m_0 = -0.25$, $V_0 = 0.01$, $\\tau = 0.08$ (所以 $\\tau^2 = 0.0064$)。\n    - 群体 1：$\\sigma_1 = 0.06$, $P = [0.11,0.13,0.15,0.17,0.19]$, $Q = [450,430,410,395,380]$。\n    - 群体 2：$\\sigma_2 = 0.05$, $P = [0.1500,0.1505,0.1495,0.1500,0.1502]$, $Q = [400,400,399,401,400]$。\n    - 群体 3：$\\sigma_3 = 0.04$, $P = [0.08,0.10,0.12,0.14]$, $Q = [2400,2300,2200,2100]$。\n- 测试用例 3（弱池化，高变化）：\n    - 超参数：$m_0 = -0.5$, $V_0 = 0.25$, $\\tau = 0.5$ (所以 $\\tau^2 = 0.25$)。\n    - 群体 1：$\\sigma_1 = 0.06$, $P = [0.09,0.13,0.17,0.21]$, $Q = [480,420,380,350]$。\n    - 群体 2：$\\sigma_2 = 0.05$, $P = [0.10,0.12,0.15,0.18]$, $Q = [510,490,470,455]$。\n    - 群体 3：$\\sigma_3 = 0.04$, $P = [0.07,0.11,0.15,0.19,0.23]$, $Q = [2600,2400,2200,2050,1950]$。\n\n算法任务：\n- 对于每个测试用例中的每个群体 $s$，通过带有截距的 $y_{s,t}$ 对 $x_{s,t}$ 的回归计算 OLS 斜率估计量 $b_s$，及其在已知 $\\sigma_s$ 下的抽样方差 $V_s$。\n- 利用分层结构和 Bayes 定理，推导并计算总体平均弹性 $\\mu$ 的后验均值和方差，然后推导并计算每个群体弹性 $\\beta_s$ 的后验均值和方差，最后计算每个 $\\beta_s$ 的对称 $95\\%$ 水平可信区间。\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每个元素对应一个测试用例并等于\n$$\n[\\mu_{\\text{mean}},\\ \\mu_{\\text{var}},\\ [[\\beta_{1,\\text{mean}},\\ \\beta_{1,\\text{lower}},\\ \\beta_{1,\\text{upper}}],\\ldots,[\\beta_{S,\\text{mean}},\\ \\beta_{S,\\text{lower}},\\ \\beta_{S,\\text{upper}}]]].\n$$\n所有与弹性相关的量都必须报告为无量纲的小数。",
            "solution": "目标是在贝叶斯分层模型中，为特定于群体的需求价格弹性 $\\beta_s$ 和总体平均弹性 $\\mu$ 推导后验分布。该解决方案完全是解析的，利用了正态分布的共轭性。\n\n模型规定如下：\n1.  **需求模型（似然第一层）**：对于每个群体 $s$ 和时间点 $t$，对数线性需求模型为 $y_{s,t} = \\alpha_s + \\beta_s x_{s,t} + \\varepsilon_{s,t}$，其中 $y_{s,t} = \\ln Q_{s,t}$ 且 $x_{s,t} = \\ln P_{s,t}$。误差是独立同分布的，即 $\\varepsilon_{s,t} \\sim \\mathcal{N}(0, \\sigma_s^2)$，其方差 $\\sigma_s^2$ 已知。我们关注的参数是弹性 $\\beta_s$。\n\n2.  **分层先验（似然第二层与先验）**：特定于群体的弹性 $\\beta_s$ 从一个共同的总体分布中抽取，即 $\\beta_s | \\mu, \\tau^2 \\sim \\mathcal{N}(\\mu, \\tau^2)$。超参数 $\\mu$ 本身有一个先验分布，即 $\\mu \\sim \\mathcal{N}(m_0, V_0)$。超参数 $m_0$，$V_0$ 和 $\\tau^2$ 是已知的。\n\n推导过程分为三个主要步骤：\n1.  使用普通最小二乘（OLS）估计量总结每个群体的数据。\n2.  推导总体平均弹性 $\\mu$ 的后验分布。\n3.  推导每个特定群体弹性 $\\beta_s$ 的后验分布。\n\n**步骤 1：通过 OLS 进行数据总结**\n\n对于拥有 $T_s$ 个观测值的每个群体 $s$，斜率 $\\beta_s$ 的 OLS 估计量记作 $b_s$。在一个已知误差方差 $\\sigma_s^2$ 的线性回归模型中，$b_s$ 的抽样分布是正态的。OLS 估计量计算如下：\n$$\nb_s = \\frac{\\sum_{t=1}^{T_s} (x_{s,t} - \\bar{x}_s)(y_{s,t} - \\bar{y}_s)}{\\sum_{t=1}^{T_s} (x_{s,t} - \\bar{x}_s)^2}\n$$\n其中 $\\bar{x}_s$ 和 $\\bar{y}_s$ 分别是 $x_{s,t}$ 和 $y_{s,t}$ 的样本均值。\n\n该估计量的抽样方差，我们记作 $V_s$，是：\n$$\nV_s = \\text{Var}(b_s) = \\frac{\\sigma_s^2}{\\sum_{t=1}^{T_s} (x_{s,t} - \\bar{x}_s)^2}\n$$\n因此，OLS 估计值 $b_s$ 为真实参数 $\\beta_s$ 提供了一个数据驱动的似然：\n$$\np(b_s | \\beta_s) = \\mathcal{N}(b_s; \\beta_s, V_s)\n$$\n这意味着，在真实弹性 $\\beta_s$ 的条件下，OLS 估计值 $b_s$ 服从均值为 $\\beta_s$、方差为 $V_s$ 的正态分布。\n\n**步骤 2：总体均值 $\\mu$ 的后验分布**\n\n为了求出 $\\mu$ 的后验分布 $p(\\mu | b_1, \\dots, b_S)$，我们使用 Bayes’ 定理：\n$$\np(\\mu | b_1, \\dots, b_S) \\propto p(b_1, \\dots, b_S | \\mu) \\, p(\\mu)\n$$\n先验分布给定为 $p(\\mu) = \\mathcal{N}(\\mu; m_0, V_0)$。似然项 $p(b_1, \\dots, b_S | \\mu)$ 通过首先注意到 $b_s$ 在给定 $\\mu$ 的条件下是条件独立的来求得，因此 $p(b_1, \\dots, b_S | \\mu) = \\prod_{s=1}^S p(b_s | \\mu)$。给定 $\\mu$ 时，单个群体估计值 $b_s$ 的边际似然通过对 $\\beta_s$ 积分得到：\n$$\np(b_s | \\mu) = \\int p(b_s | \\beta_s) p(\\beta_s | \\mu) d\\beta_s\n$$\n我们在两个正态分布的乘积上进行积分：$p(b_s | \\beta_s) = \\mathcal{N}(b_s; \\beta_s, V_s)$ 和 $p(\\beta_s | \\mu) = \\mathcal{N}(\\beta_s; \\mu, \\tau^2)$。这是两个正态分布的卷积，其结果是另一个正态分布，其均值是两个均值之和，方差是两个方差之和：\n$$\np(b_s | \\mu) = \\mathcal{N}(b_s; \\mu, V_s + \\tau^2)\n$$\n现在，$\\mu$ 的后验分布与正态密度函数的乘积成正比：\n$$\np(\\mu | b_1, \\dots, b_S) \\propto \\mathcal{N}(\\mu; m_0, V_0) \\prod_{s=1}^S \\mathcal{N}(b_s; \\mu, V_s + \\tau^2)\n$$\n正态密度函数的乘积（在 $\\mu$ 上）也是正态的。因此，后验分布 $p(\\mu | b_1, \\dots, b_S)$ 是 $\\mathcal{N}(\\mu_{\\text{post}}, V_{\\text{post}})$，其中后验精度是先验精度与数据精度之和，而后验均值是精度加权平均值。\n\n$\\mu$ 的后验方差，记作 $\\mu_{\\text{var}}$，是：\n$$\n\\mu_{\\text{var}} = V_{\\text{post}} = \\left( \\frac{1}{V_0} + \\sum_{s=1}^S \\frac{1}{V_s + \\tau^2} \\right)^{-1}\n$$\n$\\mu$ 的后验均值，记作 $\\mu_{\\text{mean}}$，是：\n$$\n\\mu_{\\text{mean}} = \\mu_{\\text{post}} = \\mu_{\\text{var}} \\left( \\frac{m_0}{V_0} + \\sum_{s=1}^S \\frac{b_s}{V_s + \\tau^2} \\right)\n$$\n\n**步骤 3：群体弹性 $\\beta_s$ 的后验分布**\n\n特定弹性 $\\beta_s$ 的后验分布以所有可用数据为条件，即 $p(\\beta_s | b_1, \\dots, b_S)$。我们可以通过先求出以 $\\mu$ 为条件的后验分布 $p(\\beta_s | \\mu, b_1, \\dots, b_S)$，然后使用 $\\mu$ 的后验分布 $p(\\mu | b_1, \\dots, b_S)$ 对其积分来消去 $\\mu$。由于模型结构中的条件独立性，$p(\\beta_s | \\mu, b_1, \\dots, b_S) = p(\\beta_s | \\mu, b_s)$。\n\n给定 $\\mu$ 和 $b_s$ 时 $\\beta_s$ 的后验分布来自一个简单的贝叶斯更新：\n$$\np(\\beta_s | \\mu, b_s) \\propto p(b_s | \\beta_s) p(\\beta_s | \\mu) = \\mathcal{N}(b_s; \\beta_s, V_s) \\mathcal{N}(\\beta_s; \\mu, \\tau^2)\n$$\n这是一个标准的正态-正态共轭模型。后验分布 $p(\\beta_s | \\mu, b_s)$ 是正态分布，其均值和方差为：\n$$\n\\text{E}[\\beta_s | \\mu, b_s] = \\frac{\\frac{1}{V_s}b_s + \\frac{1}{\\tau^2}\\mu}{\\frac{1}{V_s}+\\frac{1}{\\tau^2}} = \\frac{\\tau^2 b_s + V_s \\mu}{V_s + \\tau^2}\n$$\n$$\n\\text{Var}(\\beta_s | \\mu, b_s) = \\left( \\frac{1}{V_s} + \\frac{1}{\\tau^2} \\right)^{-1} = \\frac{V_s \\tau^2}{V_s + \\tau^2}\n$$\n$\\beta_s$ 的边际后验分布也是正态的，因为它是正态分布的混合。其均值和方差可以使用全期望定律和全方差定律找到：\n$$\n\\beta_{s,\\text{mean}} = \\text{E}[\\beta_s | b_1, \\dots, b_S] = \\text{E}_{\\mu | \\mathbf{b}} \\left[ \\text{E}[\\beta_s | \\mu, b_s] \\right]\n$$\n$$\n\\beta_{s,\\text{mean}} = \\text{E}_{\\mu | \\mathbf{b}} \\left[ \\frac{\\tau^2 b_s + V_s \\mu}{V_s + \\tau^2} \\right] = \\frac{\\tau^2 b_s + V_s \\text{E}[\\mu | \\mathbf{b}]}{V_s + \\tau^2} = \\frac{\\tau^2 b_s + V_s \\mu_{\\text{mean}}}{V_s + \\tau^2}\n$$\n这就是“收缩”估计量，其中特定于群体的估计值 $b_s$被拉向后验总体均值 $\\mu_{\\text{mean}}$。\n\n$$\n\\beta_{s,\\text{var}} = \\text{Var}(\\beta_s | b_1, \\dots, b_S) = \\text{E}_{\\mu | \\mathbf{b}}\\left[ \\text{Var}(\\beta_s | \\mu, b_s) \\right] + \\text{Var}_{\\mu | \\mathbf{b}}\\left[ \\text{E}[\\beta_s | \\mu, b_s] \\right]\n$$\n第一项是 $\\text{E}_{\\mu | \\mathbf{b}} \\left[ \\frac{V_s \\tau^2}{V_s + \\tau^2} \\right] = \\frac{V_s \\tau^2}{V_s + \\tau^2}$。\n第二项是 $\\text{Var}_{\\mu | \\mathbf{b}} \\left[ \\frac{\\tau^2 b_s + V_s \\mu}{V_s + \\tau^2} \\right] = \\left(\\frac{V_s}{V_s + \\tau^2}\\right)^2 \\text{Var}(\\mu | \\mathbf{b}) = \\left(\\frac{V_s}{V_s + \\tau^2}\\right)^2 \\mu_{\\text{var}}$。\n所以，$\\beta_s$ 的后验方差是：\n$$\n\\beta_{s,\\text{var}} = \\frac{V_s \\tau^2}{V_s + \\tau^2} + \\left( \\frac{V_s}{V_s + \\tau^2} \\right)^2 \\mu_{\\text{var}}\n$$\n\n最后，利用正态后验分布，使用后验均值和标准差（$\\beta_{s,\\text{sd}} = \\sqrt{\\beta_{s,\\text{var}}}$）构建 $\\beta_s$ 的对称 $95\\%$ 贝叶斯可信区间：\n$$\n[\\beta_{s,\\text{mean}} - 1.96 \\cdot \\beta_{s,\\text{sd}}, \\quad \\beta_{s,\\text{mean}} + 1.96 \\cdot \\beta_{s,\\text{sd}}]\n$$\n这些公式为该问题提供了一个完整的解析解。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the Bayesian hierarchical modeling problem for price elasticity of demand\n    across the specified test cases.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test Case 1\n        {\n            \"hyperparameters\": {\"m0\": -0.3, \"V0\": 0.04, \"tau\": 0.25},\n            \"segments\": [\n                {\"sigma\": 0.06, \"P\": [0.12, 0.14, 0.16, 0.18, 0.20, 0.22], \"Q\": [430, 410, 395, 382, 370, 360]},\n                {\"sigma\": 0.05, \"P\": [0.10, 0.105, 0.11, 0.115, 0.12, 0.125], \"Q\": [520, 515, 510, 505, 500, 495]},\n                {\"sigma\": 0.04, \"P\": [0.09, 0.11, 0.13, 0.15, 0.17], \"Q\": [2300, 2200, 2100, 2000, 1900]}\n            ]\n        },\n        # Test Case 2\n        {\n            \"hyperparameters\": {\"m0\": -0.25, \"V0\": 0.01, \"tau\": 0.08},\n            \"segments\": [\n                {\"sigma\": 0.06, \"P\": [0.11, 0.13, 0.15, 0.17, 0.19], \"Q\": [450, 430, 410, 395, 380]},\n                {\"sigma\": 0.05, \"P\": [0.1500, 0.1505, 0.1495, 0.1500, 0.1502], \"Q\": [400, 400, 399, 401, 400]},\n                {\"sigma\": 0.04, \"P\": [0.08, 0.10, 0.12, 0.14], \"Q\": [2400, 2300, 2200, 2100]}\n            ]\n        },\n        # Test Case 3\n        {\n            \"hyperparameters\": {\"m0\": -0.5, \"V0\": 0.25, \"tau\": 0.5},\n            \"segments\": [\n                {\"sigma\": 0.06, \"P\": [0.09, 0.13, 0.17, 0.21], \"Q\": [480, 420, 380, 350]},\n                {\"sigma\": 0.05, \"P\": [0.10, 0.12, 0.15, 0.18], \"Q\": [510, 490, 470, 455]},\n                {\"sigma\": 0.04, \"P\": [0.07, 0.11, 0.15, 0.19, 0.23], \"Q\": [2600, 2400, 2200, 2050, 1950]}\n            ]\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        # Unpack hyperparameters\n        m0 = case[\"hyperparameters\"][\"m0\"]\n        V0 = case[\"hyperparameters\"][\"V0\"]\n        tau_sq = case[\"hyperparameters\"][\"tau\"] ** 2\n\n        b_s_list = []\n        V_s_list = []\n\n        # Step 1: Compute OLS estimates and variances for each segment\n        for segment in case[\"segments\"]:\n            P = np.array(segment[\"P\"])\n            Q = np.array(segment[\"Q\"])\n            sigma_s = segment[\"sigma\"]\n\n            # Log-transform data\n            x = np.log(P)\n            y = np.log(Q)\n            \n            # OLS calculations\n            x_bar = np.mean(x)\n            y_bar = np.mean(y)\n            \n            ssx = np.sum((x - x_bar)**2)\n            spxy = np.sum((x - x_bar) * (y - y_bar))\n\n            b_s = spxy / ssx\n            V_s = sigma_s**2 / ssx\n\n            b_s_list.append(b_s)\n            V_s_list.append(V_s)\n            \n        # Step 2: Compute posterior for population mean mu\n        mu_var_precision = 1 / V0\n        mu_mean_numerator = m0 / V0\n        \n        for i in range(len(b_s_list)):\n            b_s = b_s_list[i]\n            V_s = V_s_list[i]\n            \n            common_denom = V_s + tau_sq\n            mu_var_precision += 1 / common_denom\n            mu_mean_numerator += b_s / common_denom\n\n        mu_var = 1 / mu_var_precision\n        mu_mean = mu_var * mu_mean_numerator\n\n        # Step 3: Compute posterior for each segment elasticity beta_s\n        segment_results = []\n        for i in range(len(b_s_list)):\n            b_s = b_s_list[i]\n            V_s = V_s_list[i]\n\n            # Posterior mean of beta_s\n            common_denom = V_s + tau_sq\n            beta_s_mean = (tau_sq * b_s + V_s * mu_mean) / common_denom\n\n            # Posterior variance of beta_s\n            term1 = (V_s * tau_sq) / common_denom\n            term2 = (V_s / common_denom)**2 * mu_var\n            beta_s_var = term1 + term2\n            beta_s_std = np.sqrt(beta_s_var)\n            \n            # 95% credible interval\n            z_score = 1.96\n            lower_bound = beta_s_mean - z_score * beta_s_std\n            upper_bound = beta_s_mean + z_score * beta_s_std\n            \n            segment_results.append([beta_s_mean, lower_bound, upper_bound])\n\n        case_result = [mu_mean, mu_var, segment_results]\n        results.append(case_result)\n\n    # Format and print the final output\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}