{
    "hands_on_practices": [
        {
            "introduction": "A cornerstone of effective energy modeling is ensuring that abstract models are grounded in physical reality. The ubiquitous first-order model for a Thermostatically Controlled Load (TCL) relies on two key parameters: thermal resistance ($R$) and thermal capacitance ($C$). This practice guides you through the process of deriving these parameters from first principles of heat transfer and the physical specifications of a building, such as its geometry and materials. By completing this exercise, you will gain a concrete understanding of how these abstract parameters directly relate to the tangible characteristics of a thermal system, a fundamental skill for any energy systems modeler .",
            "id": "4130995",
            "problem": "A single-zone building can be modeled as a Thermostatically Controlled Load (TCL), where the indoor air and interior mass are lumped into a single thermal capacitance and the envelope paths to the outdoor environment provide thermal resistances. Starting from Fourier’s law of heat conduction, Newton’s law of convective heat transfer, and the definition of heat capacity, derive how the overall thermal resistance and capacitance for the dwelling can be inferred from the envelope materials and geometry. Then compute an order-of-magnitude estimate of the thermal time constant for the following scientifically realistic small dwelling, treating the interior as well-mixed and linearized around a fixed thermostat setpoint, neglecting infiltration and internal gains.\n\nGeometry and envelope:\n- Rectangular plan of floor area $60$ m$^2$ with dimensions $10$ m by $6$ m and ceiling height $2.5$ m. The roof area equals the floor area $60$ m$^2$. The total wall area is the perimeter times height. The total window area is $8$ m$^2$; the remaining wall area is opaque.\n- Opaque wall assembly, from indoors to outdoors: interior gypsum board of thickness $0.0125$ m; insulated stud cavity of thickness $0.09$ m; oriented strand board (OSB) sheathing of thickness $0.012$ m; wood siding of thickness $0.010$ m. Use indoor and outdoor surface film convective coefficients $h_{\\text{in}}=8$ W m$^{-2}$ K$^{-1}$ and $h_{\\text{out}}=25$ W m$^{-2}$ K$^{-1}$ for all opaque assemblies.\n- Roof assembly, from indoors to outdoors: interior gypsum board of thickness $0.0125$ m; attic insulation layer of thickness $0.20$ m; OSB sheathing of thickness $0.012$ m. Use the same $h_{\\text{in}}$ and $h_{\\text{out}}$.\n- Windows: use an overall thermal transmittance $U_{\\text{win}}=1.8$ W m$^{-2}$ K$^{-1}$, assumed to include surface films.\n\nMaterial properties (use constant values):\n- Gypsum board thermal conductivity $k_{\\text{gyp}}=0.17$ W m$^{-1}$ K$^{-1}$, density $800$ kg m$^{-3}$, specific heat $c_{p,\\text{gyp}}=1090$ J kg$^{-1}$ K$^{-1}$.\n- Insulation thermal conductivity $k_{\\text{ins}}=0.035$ W m$^{-1}$ K$^{-1}$.\n- OSB thermal conductivity $k_{\\text{osb}}=0.12$ W m$^{-1}$ K$^{-1}$.\n- Wood siding thermal conductivity $k_{\\text{wood}}=0.14$ W m$^{-1}$ K$^{-1}$.\n- Interior air density $1.2$ kg m$^{-3}$ and specific heat $c_{p,\\text{air}}=1005$ J kg$^{-1}$ K$^{-1}$.\n- Concrete slab-on-grade floor (thermally well-coupled to the interior) of thickness $0.10$ m, density $2400$ kg m$^{-3}$, specific heat $c_{p,\\text{conc}}=880$ J kg$^{-1}$ K$^{-1}$, with area equal to the floor area.\n- Furnishings represented by a lumped mass $500$ kg with specific heat $c_{p,\\text{furn}}=1500$ J kg$^{-1}$ K$^{-1}$.\n\nAssume all opaque assemblies’ layers are in series through the thickness, and the roof, opaque walls, and windows exchange heat with the outdoors in parallel. Treat the indoor thermal capacitance as the sum of the interior air, the interior gypsum board on the opaque walls and ceiling, the concrete slab, and the furnishings. Compute the thermal time constant $\\tau$ defined as the product of the overall thermal resistance and the overall thermal capacitance. Express the final $\\tau$ in hours, and round your answer to three significant figures.",
            "solution": "The solution requires a two-part approach: a theoretical derivation of the model parameters, followed by a numerical calculation for the specific dwelling.\n\n**Part 1: Theoretical Derivation**\n\nThe overall thermal resistance, $R_{\\text{eq}}$, and thermal capacitance, $C_{\\text{eq}}$, of the building are derived from fundamental principles.\n\n**Thermal Resistance, $R$**\nThermal resistance is the opposition to heat flow. For a given heat transfer rate $\\dot{Q}$ driven by a temperature difference $\\Delta T$, the resistance is defined as $R = \\frac{\\Delta T}{\\dot{Q}}$.\n\n1.  **Conduction:** Fourier's law of heat conduction for one-dimensional steady-state heat flow through a planar material is given by $\\dot{Q} = -kA \\frac{dT}{dx}$, where $\\dot{Q}$ is the heat transfer rate, $k$ is the thermal conductivity, $A$ is the area normal to heat flow, and $\\frac{dT}{dx}$ is the temperature gradient. For a layer of thickness $L$ with a temperature difference $\\Delta T$ across it, this integrates to $\\dot{Q} = kA \\frac{\\Delta T}{L}$. The conductive thermal resistance is thus $R_{\\text{cond}} = \\frac{\\Delta T}{\\dot{Q}} = \\frac{L}{kA}$.\n\n2.  **Convection:** Newton's law of convective heat transfer from a surface of area $A$ to a fluid is $\\dot{Q} = hA \\Delta T$, where $h$ is the convective heat transfer coefficient and $\\Delta T$ is the temperature difference between the surface and the fluid. The convective thermal resistance is $R_{\\text{conv}} = \\frac{\\Delta T}{\\dot{Q}} = \\frac{1}{hA}$.\n\n3.  **Overall Resistance for an Assembly:** For a building envelope component like a wall, consisting of multiple layers in series, the total thermal resistance is the sum of the individual resistances: $R_{\\text{assembly}} = \\sum_{i} R_i$. It is common to work with resistance per unit area, $R' = R \\cdot A$. So, for a multi-layer wall, $R'_{\\text{assembly}} = \\frac{1}{h_{\\text{in}}} + \\sum_{j} \\frac{L_j}{k_j} + \\frac{1}{h_{\\text{out}}}$. The overall heat transfer coefficient, or U-value, is the reciprocal of the total resistance per unit area: $U = \\frac{1}{R'_{\\text{assembly}}}$. The heat transfer rate through the assembly is $\\dot{Q} = UA \\Delta T$.\n\n4.  **Equivalent Resistance of the Building:** The building envelope consists of several components (walls, roof, windows) that transfer heat to the outdoor environment in parallel. The total heat transfer rate is the sum of the rates through each component: $\\dot{Q}_{\\text{tot}} = \\sum_{j} \\dot{Q}_j = \\sum_{j} (UA)_j \\Delta T = (\\sum_{j} (UA)_j) \\Delta T$. The term $(UA)_{\\text{tot}} = \\sum_j (UA)_j$ represents the total heat loss rate per degree of temperature difference. The equivalent thermal resistance of the entire building envelope is the reciprocal of this value: $R_{\\text{eq}} = \\frac{1}{(UA)_{\\text{tot}}} = \\frac{1}{\\sum_{j} (UA)_j}$.\n\n**Thermal Capacitance, $C$**\nThermal capacitance is the ability of a body to store thermal energy. It is defined as the heat energy required to raise the temperature of the body by one degree. The heat energy $dQ$ required for a temperature change $dT$ is $dQ = C dT$. For a substance of mass $m$ and specific heat capacity $c_p$, the heat required for a finite temperature change $\\Delta T$ is $Q = mc_p \\Delta T$. The thermal capacitance is therefore $C = mc_p$. For a body with volume $V$ and density $\\rho$, the mass is $m=\\rho V$, so the capacitance is $C = \\rho V c_p$.\n\nFor the lumped-capacitance building model, the total thermal capacitance $C_{\\text{eq}}$ is the sum of the capacitances of all components assumed to be at the uniform indoor air temperature. This includes the interior air itself and the mass of interior-facing materials that are thermally well-coupled to the air.\n$C_{\\text{eq}} = \\sum_{i} C_i = \\sum_{i} m_i c_{p,i}$.\n\n**Part 2: Numerical Calculation**\n\n**Step A: Calculation of Overall Thermal Resistance ($R_{\\text{eq}}$)**\n\n1.  **Calculate Component Areas:**\n    - Floor/Roof Area: $A_{\\text{floor}} = A_{\\text{roof}} = 60$ m$^2$.\n    - Building Perimeter: $P = 2(10\\,\\text{m} + 6\\,\\text{m}) = 32$ m.\n    - Total Wall Area: $A_{\\text{wall,tot}} = P \\times H = 32\\,\\text{m} \\times 2.5\\,\\text{m} = 80$ m$^2$.\n    - Window Area: $A_{\\text{win}} = 8$ m$^2$.\n    - Opaque Wall Area: $A_{\\text{wall,op}} = A_{\\text{wall,tot}} - A_{\\text{win}} = 80\\,\\text{m}^2 - 8\\,\\text{m}^2 = 72$ m$^2$.\n\n2.  **Calculate U-value for Opaque Wall ($U_{\\text{wall}}$):**\n    The total resistance per unit area, $R'_{\\text{wall,op}}$, is the sum of series resistances:\n    $R'_{\\text{wall,op}} = \\frac{1}{h_{\\text{in}}} + \\frac{L_{\\text{gyp}}}{k_{\\text{gyp}}} + \\frac{L_{\\text{ins}}}{k_{\\text{ins}}} + \\frac{L_{\\text{osb}}}{k_{\\text{osb}}} + \\frac{L_{\\text{wood}}}{k_{\\text{wood}}} + \\frac{1}{h_{\\text{out}}}$\n    $R'_{\\text{wall,op}} = \\frac{1}{8} + \\frac{0.0125}{0.17} + \\frac{0.09}{0.035} + \\frac{0.012}{0.12} + \\frac{0.010}{0.14} + \\frac{1}{25}$ m$^2$ K W$^{-1}$\n    $R'_{\\text{wall,op}} = (0.125 + 0.073529... + 2.571428... + 0.1 + 0.071428... + 0.04)$ m$^2$ K W$^{-1} = 2.98138...$ m$^2$ K W$^{-1}$.\n    $U_{\\text{wall}} = \\frac{1}{R'_{\\text{wall,op}}} = \\frac{1}{2.98138...}$ W m$^{-2}$ K$^{-1} = 0.33541...$ W m$^{-2}$ K$^{-1}$.\n\n3.  **Calculate U-value for Roof ($U_{\\text{roof}}$):**\n    $R'_{\\text{roof}} = \\frac{1}{h_{\\text{in}}} + \\frac{L_{\\text{gyp}}}{k_{\\text{gyp}}} + \\frac{L_{\\text{attic_ins}}}{k_{\\text{ins}}} + \\frac{L_{\\text{osb}}}{k_{\\text{osb}}} + \\frac{1}{h_{\\text{out}}}$\n    $R'_{\\text{roof}} = \\frac{1}{8} + \\frac{0.0125}{0.17} + \\frac{0.20}{0.035} + \\frac{0.012}{0.12} + \\frac{1}{25}$ m$^2$ K W$^{-1}$\n    $R'_{\\text{roof}} = (0.125 + 0.073529... + 5.714285... + 0.1 + 0.04)$ m$^2$ K W$^{-1} = 6.05281...$ m$^2$ K W$^{-1}$.\n    $U_{\\text{roof}} = \\frac{1}{R'_{\\text{roof}}} = \\frac{1}{6.05281...}$ W m$^{-2}$ K$^{-1} = 0.16521...$ W m$^{-2}$ K$^{-1}$.\n\n4.  **Calculate Total UA product ($(UA)_{\\text{tot}}$):**\n    $(UA)_{\\text{tot}} = U_{\\text{wall}}A_{\\text{wall,op}} + U_{\\text{roof}}A_{\\text{roof}} + U_{\\text{win}}A_{\\text{win}}$\n    $(UA)_{\\text{tot}} = (0.33541... \\times 72) + (0.16521... \\times 60) + (1.8 \\times 8)$ W K$^{-1}$\n    $(UA)_{\\text{tot}} = (24.1498... + 9.9126... + 14.4)$ W K$^{-1} = 48.4625...$ W K$^{-1}$.\n\n5.  **Calculate Equivalent Resistance ($R_{\\text{eq}}$):**\n    $R_{\\text{eq}} = \\frac{1}{(UA)_{\\text{tot}}} = \\frac{1}{48.4625...}$ K W$^{-1} = 0.020634...$ K W$^{-1}$.\n\n**Step B: Calculation of Overall Thermal Capacitance ($C_{\\text{eq}}$)**\n\n$C_{\\text{eq}} = C_{\\text{air}} + C_{\\text{gyp}} + C_{\\text{conc}} + C_{\\text{furn}}$\n\n1.  **Air Capacitance ($C_{\\text{air}}$):**\n    $V_{\\text{air}} = A_{\\text{floor}} \\times H = 60\\,\\text{m}^2 \\times 2.5\\,\\text{m} = 150$ m$^3$.\n    $C_{\\text{air}} = \\rho_{\\text{air}} V_{\\text{air}} c_{p,\\text{air}} = 1.2 \\times 150 \\times 1005 = 180900$ J K$^{-1}$.\n\n2.  **Gypsum Board Capacitance ($C_{\\text{gyp}}$):**\n    The gypsum is on the interior of the opaque walls and the ceiling.\n    $A_{\\text{gyp}} = A_{\\text{wall,op}} + A_{\\text{roof}} = 72\\,\\text{m}^2 + 60\\,\\text{m}^2 = 132$ m$^2$.\n    $V_{\\text{gyp}} = A_{\\text{gyp}} \\times L_{\\text{gyp}} = 132 \\times 0.0125 = 1.65$ m$^3$.\n    $C_{\\text{gyp}} = \\rho_{\\text{gyp}} V_{\\text{gyp}} c_{p,\\text{gyp}} = 800 \\times 1.65 \\times 1090 = 1438800$ J K$^{-1}$.\n\n3.  **Concrete Slab Capacitance ($C_{\\text{conc}}$):**\n    $V_{\\text{conc}} = A_{\\text{floor}} \\times L_{\\text{conc}} = 60 \\times 0.10 = 6$ m$^3$.\n    $C_{\\text{conc}} = \\rho_{\\text{conc}} V_{\\text{conc}} c_{p,\\text{conc}} = 2400 \\times 6 \\times 880 = 12672000$ J K$^{-1}$.\n\n4.  **Furnishings Capacitance ($C_{\\text{furn}}$):**\n    $C_{\\text{furn}} = m_{\\text{furn}} c_{p,\\text{furn}} = 500 \\times 1500 = 750000$ J K$^{-1}$.\n\n5.  **Total Equivalent Capacitance ($C_{\\text{eq}}$):**\n    $C_{\\text{eq}} = 180900 + 1438800 + 12672000 + 750000 = 15041700$ J K$^{-1}$.\n\n**Step C: Calculation of Thermal Time Constant ($\\tau$)**\n\nThe thermal time constant $\\tau$ is the product of the equivalent resistance and capacitance.\n$\\tau = R_{\\text{eq}} C_{\\text{eq}} = 0.020634... \\text{ K W}^{-1} \\times 15041700 \\text{ J K}^{-1}$\nThe units are $(\\text{K}/\\text{W}) \\times (\\text{J}/\\text{K}) = \\text{J}/\\text{W} = \\text{J}/(\\text{J}/\\text{s}) = \\text{s}$.\n$\\tau = 310379...$ s.\n\nFinally, convert the time constant to hours and round to three significant figures.\n$\\tau_{\\text{hours}} = \\frac{\\tau}{3600\\,\\text{s/hr}} = \\frac{310379...}{3600} = 86.216...$ hr.\nRounding to three significant figures gives $86.2$ hr.",
            "answer": "$$\n\\boxed{86.2}\n$$"
        },
        {
            "introduction": "Once a model's physical parameters are established, the next task is to simulate its dynamic behavior over time. While fixed-time-step methods are common, they can be inefficient or inaccurate for systems with discrete events like a thermostat switching. This exercise introduces a more powerful and precise technique: event-driven simulation . You will leverage the analytical solution of the TCL's governing differential equation to calculate the exact moments of threshold crossings, allowing you to build a simulator that jumps from one critical event to the next. This approach is fundamental to accurately and efficiently modeling the hybrid continuous-discrete nature of TCLs.",
            "id": "4131004",
            "problem": "You are tasked with implementing an event-driven simulator for a Thermostatically Controlled Load (TCL) in the domain of energy systems modeling. The TCL is a single-zone cooling device that regulates indoor temperature based on hysteresis control under piecewise-constant ambient conditions. The objective is to compute the exact switching times when the thermostat changes state by analytically solving for threshold crossings of the temperature trajectory.\n\nBegin from the following modeling base:\n- The indoor temperature dynamics follow a first-order lumped thermal model derived from energy balance and Newton's law of cooling. The ordinary differential equation (ODE) is\n$$\n\\frac{dT(t)}{dt} \\;=\\; -k \\,\\big(T(t) - T_a(t)\\big) \\;-\\; u(t) \\, q,\n$$\nwhere $T(t)$ is indoor temperature in degrees Celsius, $T_a(t)$ is ambient temperature in degrees Celsius, $k  0$ is the thermal loss rate in inverse seconds, $u(t) \\in \\{0,1\\}$ is the actuator mode with $u(t)=1$ indicating the cooling device is ON and $u(t)=0$ indicating it is OFF, and $q  0$ is the effective cooling rate in degrees Celsius per second. The ambient temperature $T_a(t)$ is piecewise-constant over specified time segments. The parameters $k$ and $q$ are constant across the simulation. Units: temperatures in degrees Celsius and time in seconds.\n\n- The thermostat employs hysteresis with deadband around a setpoint, with lower threshold $T_{\\text{low}} = T_{\\text{set}} - \\Delta$ and upper threshold $T_{\\text{high}} = T_{\\text{set}} + \\Delta$, where $\\Delta  0$ is half the deadband width. The switching logic for a cooling device is: when $u(t)=0$ (device OFF), it switches ON at the first time $t$ such that $T(t) \\ge T_{\\text{high}}$; when $u(t)=1$ (device ON), it switches OFF at the first time $t$ such that $T(t) \\le T_{\\text{low}}$. Ties at thresholds are resolved by immediate switching at the current time, i.e., if at any decision instant $T(t)$ equals the active threshold, the corresponding switch occurs at that instant.\n\nYour task:\n- Implement an event-driven simulation algorithm that integrates $T(t)$ exactly and computes switching event times over a given schedule of ambient segments, by solving analytically for threshold crossing times within each segment. The ambient temperature $T_a(t)$ is piecewise-constant over segments $\\{(d_i, T_{a,i})\\}$, where $d_i$ is the duration in seconds and $T_{a,i}$ is ambient temperature in degrees Celsius for segment $i$. The device mode $u(t)$ is piecewise-constant between switching events. Within any segment with constant $T_{a}$ and constant $u$, $T(t)$ evolves according to the given ODE.\n\n- Your simulator must:\n  1. Accept the model parameters $(\\tau, q, T_{\\text{set}}, \\Delta, T_0, u_0, \\{(d_i, T_{a,i})\\})$, where $\\tau$ is the thermal time constant in seconds, $k = 1/\\tau$, $q$ is the cooling rate in degrees Celsius per second, $T_{\\text{set}}$ is the setpoint in degrees Celsius, $\\Delta$ is deadband half-width in degrees Celsius, $T_0$ is initial indoor temperature in degrees Celsius at time $t=0$, $u_0 \\in \\{0,1\\}$ is the initial mode (OFF is $0$, ON is $1$), and the ambient schedule is a list of pairs $(d_i, T_{a,i})$.\n  2. Compute the indoor temperature trajectory exactly within each ambient segment and determine the precise times at which the thermostat switches state. Propagations between events are done analytically using the ODE solution; numerical stepping is not allowed.\n  3. Enforce the hysteresis switching logic and tie-breaking at thresholds described above.\n  4. Return a list of event times in seconds from $t=0$ to the end of the ambient schedule.\n\nAnalytic integration specification:\n- Within any interval where $T_a(t) = \\text{constant}$ and $u(t) = \\text{constant}$, $T(t)$ must be integrated exactly. Event times are found by solving $T(t) = T_{\\text{thr}}$ for $t$, where $T_{\\text{thr}}$ is the active threshold ($T_{\\text{high}}$ when $u=0$, $T_{\\text{low}}$ when $u=1$). Crossing must only be computed when the trajectory is monotonic toward $T_{\\infty}$ and the threshold lies between the current temperature and $T_{\\infty}$ for that segment; otherwise, no crossing occurs in that segment.\n\nUnits:\n- Report all event times in seconds as floating-point values.\n\nTest suite:\nImplement your program to run the following five test cases, each defined by $(\\tau, q, T_{\\text{set}}, \\Delta, T_0, u_0, \\{(d_i, T_{a,i})\\})$:\n- Case $1$: $\\tau = 1200$, $q = 0.01$, $T_{\\text{set}} = 22$, $\\Delta = 1$, $T_0 = 22$, $u_0 = 0$, ambient segments $\\{(1800, 30), (1800, 26), (1800, 28)\\}$.\n- Case $2$: $\\tau = 900$, $q = \\frac{8}{900}$, $T_{\\text{set}} = 24$, $\\Delta = 0.5$, $T_0 = 24.5$, $u_0 = 0$, ambient segments $\\{(1200, 27)\\}$.\n- Case $3$: $\\tau = 1500$, $q = \\frac{10}{1500}$, $T_{\\text{set}} = 21$, $\\Delta = 0.7$, $T_0 = 21$, $u_0 = 0$, ambient segments $\\{(3600, 18)\\}$.\n- Case $4$: $\\tau = 300$, $q = \\frac{12}{300}$, $T_{\\text{set}} = 25$, $\\Delta = 1$, $T_0 = 26$, $u_0 = 0$, ambient segments $\\{(200, 32), (200, 34), (200, 30), (400, 29)\\}$.\n- Case $5$: $\\tau = 600$, $q = \\frac{15}{600}$, $T_{\\text{set}} = 22$, $\\Delta = 0.1$, $T_0 = 22$, $u_0 = 0$, ambient segments $\\{(300, 27), (300, 27)\\}$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each entry must be the list of event times (in seconds) for one test case, in order. For example, the output must look like\n$$\n[ [t_{1,1}, t_{1,2}, \\dots], [t_{2,1}, \\dots], [\\dots], [\\dots], [\\dots] ].\n$$\nIf a case has no events, output an empty list for that case, i.e., $[]$.",
            "solution": "The problem requires the implementation of an event-driven simulator for a Thermostatically Controlled Load (TCL) operating under hysteresis control. The simulation must be exact, using analytical solutions for the temperature dynamics between events.\n\nThe core of the simulation is based on the first-order ordinary differential equation (ODE) governing the indoor temperature $T(t)$:\n$$\n\\frac{dT(t)}{dt} = -k \\left(T(t) - T_a(t)\\right) - u(t) q\n$$\nHere, $k$ is the thermal loss rate ($k=1/\\tau$, where $\\tau$ is the thermal time constant), $T_a(t)$ is the ambient temperature, $u(t)$ is the actuator state ($1$ for ON, $0$ for OFF), and $q$ is the cooling rate.\n\nThe simulation proceeds by identifying and advancing to the next event in time. An event can be either a thermostat state switch (a state-dependent event) or a change in the ambient temperature (a time-dependent event).\n\nFirst, we solve the ODE analytically. Within any time interval where the actuator state $u(t)$ and the ambient temperature $T_a(t)$ are constant, let's denote them as $u_c$ and $T_{a,c}$ respectively. The ODE can be rewritten as a standard first-order linear ODE:\n$$\n\\frac{dT}{dt} + k T(t) = k T_{a,c} - u_c q\n$$\nThe right-hand side is constant. The solution to this ODE consists of a homogeneous part and a particular solution. The particular solution is the steady-state or asymptotic temperature, $T_{\\infty}$, which is found by setting $\\frac{dT}{dt}=0$:\n$$\n0 = -k (T_{\\infty} - T_{a,c}) - u_c q \\implies T_{\\infty} = T_{a,c} - \\frac{u_c q}{k} = T_{a,c} - u_c q \\tau\n$$\nThe general solution for the temperature $T(t)$ starting from an initial temperature $T_s$ at time $t_s$ is given by:\n$$\nT(t) = T_{\\infty} + (T_s - T_{\\infty}) e^{-k(t - t_s)}\n$$\nThis analytical solution allows us to calculate the temperature at any future time $t$ within the interval of constant parameters, without resorting to numerical integration.\n\nThe next step is to determine the time of a thermostat switch. A switch occurs when the temperature $T(t)$ reaches one of the hysteresis thresholds: $T_{\\text{high}} = T_{\\text{set}} + \\Delta$ or $T_{\\text{low}} = T_{\\text{set}} - \\Delta$. The active threshold, $T_{\\text{thr}}$, depends on the current actuator mode $u_c$:\n- If the device is OFF ($u_c=0$), it will switch ON upon reaching $T_{\\text{high}}$. Thus, $T_{\\text{thr}} = T_{\\text{high}}$.\n- If the device is ON ($u_c=1$), it will switch OFF upon reaching $T_{\\text{low}}$. Thus, $T_{\\text{thr}} = T_{\\text{low}}$.\n\nTo find the time-to-switch, $\\Delta t_{cross} = t_{cross} - t_s$, we solve the equation $T(t_{cross}) = T_{\\text{thr}}$ for $\\Delta t_{cross}$:\n$$\nT_{\\text{thr}} = T_{\\infty} + (T_s - T_{\\infty}) e^{-k \\Delta t_{cross}}\n$$\nRearranging and solving for $\\Delta t_{cross}$ yields:\n$$\n\\frac{T_{\\text{thr}} - T_{\\infty}}{T_s - T_{\\infty}} = e^{-k \\Delta t_{cross}}\n$$\n$$\n\\ln\\left(\\frac{T_{\\text{thr}} - T_{\\infty}}{T_s - T_{\\infty}}\\right) = -k \\Delta t_{cross}\n$$\n$$\n\\Delta t_{cross} = -\\frac{1}{k} \\ln\\left(\\frac{T_{\\text{thr}} - T_{\\infty}}{T_s - T_{\\infty}}\\right) = \\tau \\ln\\left(\\frac{T_s - T_{\\infty}}{T_{\\text{thr}} - T_{\\infty}}\\right)\n$$\nA physically meaningful (positive, finite) switching time $\\Delta t_{cross}$ exists only if the argument of the natural logarithm is greater than $1$. This corresponds to the condition that the threshold $T_{\\text{thr}}$ lies between the current temperature $T_s$ and the asymptotic temperature $T_{\\infty}$. Specifically:\n- For a switch-ON event ($u_c=0$): a crossing occurs if $T_s  T_{\\text{high}}$ and the system is heating towards an asymptote above the threshold, i.e., $T_{\\infty} > T_{\\text{high}}$.\n- For a switch-OFF event ($u_c=1$): a crossing occurs if $T_s > T_{\\text{low}}$ and the system is cooling towards an asymptote below the threshold, i.e., $T_{\\infty}  T_{\\text{low}}$.\nIf these conditions are not met, a switch event will not occur within the current interval of constant parameters. The tie-breaking rule states that if $T_s = T_{\\text{thr}}$ at a decision instant, the switch is immediate, so $\\Delta t_{cross}=0$.\n\nThe event-driven simulation algorithm is structured as follows:\n1. Initialize the simulation state: current time $t_{curr}=0$, temperature $T_{curr}=T_0$, actuator mode $u_{curr}=u_0$. Create a list to store event times.\n2. Check for an immediate switch at $t=0$ based on the initial conditions $T_0$, $u_0$ and the corresponding threshold. If a switch occurs, record the event time $t=0$ and update $u_{curr}$.\n3. Enter a loop that continues until $t_{curr}$ reaches the total simulation duration.\n4. Within the loop, for the current state $(t_{curr}, T_{curr}, u_{curr})$:\n   a. Identify the current ambient temperature $T_{a,c}$ and the time of the next scheduled ambient temperature change, $t_{amb}$.\n   b. Calculate the asymptotic temperature $T_{\\infty}$ based on $T_{a,c}$ and $u_{curr}$.\n   c. Determine the active threshold $T_{\\text{thr}}$ and check if a switch is possible.\n   d. If a switch is possible, calculate $\\Delta t_{cross}$. The potential switch time is $t_{switch} = t_{curr} + \\Delta t_{cross}$. Otherwise, set $t_{switch}$ to infinity.\n   e. The next event time is $t_{next} = \\min(t_{switch}, t_{amb})$.\n   f. If $t_{next}$ exceeds the simulation horizon, advance time to the end of the simulation and terminate.\n   g. Advance the simulation to $t_{next}$. Calculate the temperature at this time, $T_{next}$, using the analytical solution. Update $t_{curr} = t_{next}$ and $T_{curr} = T_{next}$.\n   h. If the event was a switch ($t_{next} = t_{switch}$), record $t_{next}$ in the event list, flip the actuator mode $u_{curr}$, and set $T_{curr}$ exactly to $T_{\\text{thr}}$.\n5. Once the loop terminates, return the list of recorded event times.\n\nThis procedure ensures that the temperature trajectory is evolved exactly between events and that switching times are computed with analytical precision, fulfilling the requirements of the problem.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n\n    test_cases = [\n        # Case 1: tau, q, T_set, Delta, T0, u0, ambient_segments\n        (1200.0, 0.01, 22.0, 1.0, 22.0, 0, [(1800.0, 30.0), (1800.0, 26.0), (1800.0, 28.0)]),\n        # Case 2\n        (900.0, 8.0/900.0, 24.0, 0.5, 24.5, 0, [(1200.0, 27.0)]),\n        # Case 3\n        (1500.0, 10.0/1500.0, 21.0, 0.7, 21.0, 0, [(3600.0, 18.0)]),\n        # Case 4\n        (300.0, 12.0/300.0, 25.0, 1.0, 26.0, 0, [(200.0, 32.0), (200.0, 34.0), (200.0, 30.0), (400.0, 29.0)]),\n        # Case 5\n        (600.0, 15.0/600.0, 22.0, 0.1, 22.0, 0, [(300.0, 27.0), (300.0, 27.0)])\n    ]\n    \n    all_results = []\n    for case in test_cases:\n        result = simulate_tcl(*case)\n        all_results.append(result)\n\n    # Format the final output string as specified\n    output_str = \"[\" + \",\".join([str(res) for res in all_results]) + \"]\"\n    print(output_str)\n\ndef simulate_tcl(tau, q, t_set, delta, t0, u0, ambient_segments):\n    \"\"\"\n    Simulates a single Thermostatically Controlled Load (TCL) case.\n\n    Args:\n        tau (float): Thermal time constant in seconds.\n        q (float): Cooling rate in degrees Celsius per second.\n        t_set (float): Temperature setpoint in degrees Celsius.\n        delta (float): Deadband half-width in degrees Celsius.\n        t0 (float): Initial indoor temperature in degrees Celsius.\n        u0 (int): Initial actuator mode (0 for OFF, 1 for ON).\n        ambient_segments (list): A list of tuples (duration, ambient_temp).\n\n    Returns:\n        list: A list of floating-point event times in seconds.\n    \"\"\"\n    k = 1.0 / tau\n    t_low = t_set - delta\n    t_high = t_set + delta\n\n    current_time = 0.0\n    current_temp = t0\n    current_mode = u0\n    \n    event_times = []\n\n    # Build ambient event schedule\n    ambient_events = []\n    _time = 0.0\n    total_duration = 0.0\n    for duration, temp in ambient_segments:\n        _time += duration\n        ambient_events.append((_time, temp))\n        total_duration = _time\n    \n    ambient_idx = 0\n\n    # Initial state check for immediate switch at t=0\n    # This loop handles the rare case of multiple immediate switches if T_low == T_high\n    while True:\n      initial_mode = current_mode\n      if current_mode == 0 and current_temp >= t_high:\n          event_times.append(current_time)\n          current_mode = 1\n          current_temp = t_high # Snap to threshold\n      elif current_mode == 1 and current_temp = t_low:\n          event_times.append(current_time)\n          current_mode = 0\n          current_temp = t_low # Snap to threshold\n          \n      if current_mode == initial_mode:\n        break\n\n\n    while current_time  total_duration:\n        # Determine current ambient conditions\n        while ambient_idx  len(ambient_events) and current_time >= ambient_events[ambient_idx][0]:\n            ambient_idx += 1\n\n        t_a = ambient_segments[ambient_idx][1]\n        next_ambient_time = ambient_events[ambient_idx][0]\n        \n        # Calculate asymptotic temperature\n        t_inf = t_a - current_mode * q * tau\n        \n        # Determine active threshold and calculate time to next switch\n        next_switch_time = float('inf')\n        \n        t_s = current_temp\n        \n        if current_mode == 0:  # OFF, heating up\n            t_thr = t_high\n            # Condition for crossing: T_s  T_thr and T_inf > T_thr\n            if t_s  t_thr and t_inf > t_thr:\n                # Handle division by zero if t_thr is close to t_inf\n                if not np.isclose(t_thr, t_inf):\n                    arg = (t_s - t_inf) / (t_thr - t_inf)\n                    if arg > 0: # It must be > 1, but >0 is a sanity check\n                        dt_cross = tau * np.log(arg)\n                        if dt_cross >= 0:\n                            next_switch_time = current_time + dt_cross\n        else:  # ON, cooling down\n            t_thr = t_low\n            # Condition for crossing: T_s > T_thr and T_inf  T_thr\n            if t_s > t_thr and t_inf  t_thr:\n                if not np.isclose(t_thr, t_inf):\n                    arg = (t_s - t_inf) / (t_thr - t_inf)\n                    if arg > 0:\n                        dt_cross = tau * np.log(arg)\n                        if dt_cross >= 0:\n                            next_switch_time = current_time + dt_cross\n                            \n        # Determine the next event\n        next_event_time = min(next_switch_time, next_ambient_time, total_duration)\n\n        if next_event_time = current_time and not np.isclose(next_event_time, current_time):\n            # This indicates no forward progress is possible, break to avoid infinite loop\n            break\n        \n        is_switch_event = np.isclose(next_event_time, next_switch_time)\n        \n        if np.isclose(current_time, total_duration):\n            break\n\n        # Propagate state to the next event time\n        dt = next_event_time - current_time\n        current_temp = t_inf + (t_s - t_inf) * np.exp(-k * dt)\n        current_time = next_event_time\n        \n        # Handle the event\n        if is_switch_event and current_time  total_duration:\n            event_times.append(current_time)\n            current_mode = 1 - current_mode\n            current_temp = t_thr # Snap temperature to threshold after switch\n\n    return event_times\n\nif __name__ == '__main__':\n    solve()\n```"
        },
        {
            "introduction": "The true power of TCLs in modern energy systems is unlocked when we aggregate and control large populations to provide grid services. This capstone practice scales up from a single device to a collective of thousands, demonstrating how their coordinated action can be used for demand response . You will derive a linearized mean-field model to represent the aggregate power response and then design a Proportional-Integral (PI) feedback controller to make this virtual power plant track a regulation signal. This exercise bridges the gap between single-device physics and system-level control, providing hands-on experience with a key technology for enabling a flexible and resilient power grid.",
            "id": "4131081",
            "problem": "Consider a large population of identical electric cooling Thermostatically Controlled Loads (TCLs). Each TCL is modeled by a lumped thermal resistance-capacitance element where the indoor air temperature evolves according to energy conservation: heat conduction from ambient plus heat removal when the compressor is on. Let the per-device thermal resistance be $R$ (in $\\mathrm{K/W}$), thermal capacitance be $C_{th}$ (in $\\mathrm{J/K}$), baseline thermostat setpoint be $T_{s,0}$ (in $\\mathrm{K}$), deadband width be $\\Delta$ (in $\\mathrm{K}$), and the ambient temperature be $T_a$ (in $\\mathrm{K}$). Each device consumes rated electrical power $P_{dev}$ (in $\\mathrm{W}$) when on and achieves a heat removal power of $\\eta P_{dev}$ (in $\\mathrm{W}$), where $\\eta$ is the coefficient mapping electrical power to heat removal (dimensionless). The population size is $N$ (integer). The aggregate power is $P_{agg}(t)$ (in $\\mathrm{W}$). A regulation signal $r(t)$ (in $\\mathrm{W}$) must be tracked by manipulating the common setpoint offset $\\delta T_s(t)$ (in $\\mathrm{K}$).\n\nStarting from first principles, use energy conservation for a single device and mean-field modeling assumptions appropriate for a large, desynchronized population with small perturbations $\\delta T_s(t)$ around $T_{s,0}$. Assume the linearization is valid for $\\lvert \\delta T_s(t) \\rvert \\ll \\Delta$. Proceed as follows:\n\n1) Derive a linear time-invariant scalar mean-field plant that maps the setpoint offset $\\delta T_s(t)$ to the aggregate power deviation $\\delta P_{agg}(t) = P_{agg}(t) - P_{agg}(0)$ under small-signal conditions. Your derivation must start from the per-device energy balance and express the plant’s static gain and dominant relaxation time in terms of $N$, $R$, $C_{th}$, and $\\eta$, making scientifically reasonable approximations consistent with a large, desynchronized population. Explicitly state which approximations relate the relaxation time to $R$ and $C_{th}$.\n\n2) Let the controller be Proportional-Integral (PI) with a specified control direction $\\sigma \\in \\{+1,-1\\}$, such that the setpoint offset is given by $\\delta T_s(t) = \\sigma \\left[ K_p e(t) + K_i \\int_0^t e(\\tau)\\,d\\tau \\right]$, where $e(t) = r(t) - P_{agg}(t)$ and the controller gains are $K_p$ (in $\\mathrm{K/W}$) and $K_i$ (in $\\mathrm{K/(W\\cdot s)}$). Derive the closed-loop characteristic equation of the linearized system in terms of the plant parameters and the controller parameters. Use the convention that cooling loads have $\\sigma = -1$.\n\n3) Implement a program that, for the test suite specified below, computes the following four quantities for each test case:\n   a) Closed-loop stability as a boolean, with output $1$ if all closed-loop poles have strictly negative real parts and $0$ otherwise.\n   b) The Integral of Squared Error (ISE) $\\int_0^{T_h} e(t)^2\\,dt$ over the finite horizon $[0,T_h]$, expressed in $\\mathrm{W^2 \\cdot s}$ as a floating-point number. The regulation signal is a step input of amplitude $A$ (in $\\mathrm{W}$), i.e., $r(t) = 0$ for $t  0$ and $r(t) = A$ for $t \\ge 0$.\n   c) The final tracking error $e(T_h)$ (in $\\mathrm{W}$) as a floating-point number.\n   d) The maximum absolute setpoint offset magnitude $\\max_{t \\in [0,T_h]} \\lvert \\delta T_s(t) \\rvert$ (in $\\mathrm{K}$) as a floating-point number.\n   Use a time step of $1$ second for numerical integration, and assume initial conditions $P_{agg}(0) = 0$ and $\\int_0^0 e(\\tau)\\,d\\tau = 0$.\n\n4) Express all results in the units specified above. Angles do not appear, so no angle unit is required. Percentages do not appear. The final output format must be a single line containing the results for all test cases as a comma-separated list enclosed in square brackets, where each test case is itself represented as a four-element comma-separated list enclosed in square brackets. For example, the output format should be like $[[b_1,ise_1,e_T^{(1)},u_{max}^{(1)}],[b_2,ise_2,e_T^{(2)},u_{max}^{(2)}],\\ldots]$ without additional text.\n\nUse the following test suite, chosen to probe typical, fast, and high-gain scenarios while remaining scientifically plausible. For all cases below, take the relaxation time equal to the thermal time constant $R C_{th}$:\n\n- Case 1 (typical cooling population):\n  $N = 10000$, $P_{dev} = 1000\\,\\mathrm{W}$, $R = 0.005\\,\\mathrm{K/W}$, $C_{th} = 1.2 \\times 10^6\\,\\mathrm{J/K}$, $\\eta = 3$, $\\Delta = 0.5\\,\\mathrm{K}$, $\\sigma = -1$, $K_p = 1\\times 10^{-5}\\,\\mathrm{K/W}$, $K_i = 1\\times 10^{-7}\\,\\mathrm{K/(W\\cdot s)}$, $A = 100000\\,\\mathrm{W}$, $T_h = 7200\\,\\mathrm{s}$.\n\n- Case 2 (smaller population, faster thermal dynamics):\n  $N = 2000$, $P_{dev} = 1500\\,\\mathrm{W}$, $R = 0.01\\,\\mathrm{K/W}$, $C_{th} = 2 \\times 10^5\\,\\mathrm{J/K}$, $\\eta = 2.5$, $\\Delta = 0.5\\,\\mathrm{K}$, $\\sigma = -1$, $K_p = 5\\times 10^{-6}\\,\\mathrm{K/W}$, $K_i = 2\\times 10^{-7}\\,\\mathrm{K/(W\\cdot s)}$, $A = 50000\\,\\mathrm{W}$, $T_h = 7200\\,\\mathrm{s}$.\n\n- Case 3 (moderate population, higher gains):\n  $N = 5000$, $P_{dev} = 800\\,\\mathrm{W}$, $R = 0.007\\,\\mathrm{K/W}$, $C_{th} = 8 \\times 10^5\\,\\mathrm{J/K}$, $\\eta = 3.5$, $\\Delta = 0.5\\,\\mathrm{K}$, $\\sigma = -1$, $K_p = 5\\times 10^{-5}\\,\\mathrm{K/W}$, $K_i = 8\\times 10^{-7}\\,\\mathrm{K/(W\\cdot s)}$, $A = 200000\\,\\mathrm{W}$, $T_h = 7200\\,\\mathrm{s}$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets and with no additional text, exactly in the format described in item $4$ above.",
            "solution": "The problem requires the derivation of a linearized mean-field model for a population of thermostatically controlled loads (TCLs), the analysis of its closed-loop control using a Proportional-Integral (PI) controller, and a numerical implementation to evaluate system performance under specific test scenarios.\n\n### Part 1: Mean-Field Plant Model Derivation\n\nWe begin with the energy balance for a single TCL, which is modeled as a lumped thermal resistance-capacitance element. The indoor temperature $T_i(t)$ of device $i$ evolves according to:\n$$ C_{th} \\frac{dT_i}{dt} = \\frac{T_a - T_i(t)}{R} - s_i(t) \\eta P_{dev} $$\nwhere $C_{th}$ is the thermal capacitance, $R$ is the thermal resistance, $T_a$ is the ambient temperature, $\\eta$ is the coefficient of performance, $P_{dev}$ is the device's electrical power consumption, and $s_i(t) \\in \\{0, 1\\}$ is the compressor state (ON/OFF).\n\nFor a large, desynchronized population of $N$ identical devices, we can use a mean-field approach. We are interested in the deviation of aggregate power, $\\delta P_{agg}(t)$, in response to a small, common setpoint offset, $\\delta T_s(t)$. Such systems can be effectively modeled as a first-order linear time-invariant (LTI) plant:\n$$ G_p(s) = \\frac{\\delta P_{agg}(s)}{\\delta T_s(s)} = \\frac{G}{1 + \\tau s} $$\nwhere $G$ is the static gain and $\\tau$ is the dominant relaxation time.\n\n**Static Gain $G$:**\nThe static gain represents the steady-state change in aggregate power due to a sustained change in the setpoint. In a mean-field equilibrium, the average indoor temperature of the population, $\\bar{T}$, tracks the setpoint $T_s$. The steady-state duty cycle $d_0$ (fraction of devices that are ON) must balance the average heat gain from the ambient:\n$$ \\frac{T_a - \\bar{T}}{R} - d_0 \\eta P_{dev} = 0 $$\nAssuming $\\bar{T} \\approx T_s = T_{s,0} + \\delta T_s$, the duty cycle is $d = \\frac{T_a - T_s}{R \\eta P_{dev}}$.\nThe aggregate power is $P_{agg} = N \\cdot d \\cdot P_{dev} = N P_{dev} \\frac{T_a - T_s}{R \\eta P_{dev}} = \\frac{N (T_a - T_s)}{R \\eta}$.\nFor a small perturbation $\\delta T_s$ around $T_{s,0}$, the resulting change in aggregate power is:\n$$ \\delta P_{agg} = P_{agg}(T_{s,0} + \\delta T_s) - P_{agg}(T_{s,0}) = \\frac{N (T_a - (T_{s,0} + \\delta T_s))}{R \\eta} - \\frac{N (T_a - T_{s,0})}{R \\eta} = -\\frac{N}{R \\eta} \\delta T_s $$\nThus, the static gain is:\n$$ G = \\frac{\\delta P_{agg}}{\\delta T_s} = -\\frac{N}{R \\eta} $$\nFor cooling loads, an increase in the setpoint (desiring a warmer temperature) correctly leads to a decrease in cooling power.\n\n**Relaxation Time $\\tau$:**\nThe problem specifies to take the relaxation time $\\tau$ as equal to the thermal time constant of a single device, $\\tau_{th} = R C_{th}$.\nThis is a key approximation. For a homogeneous population, the response can be complex and oscillatory. However, for a large population that is sufficiently \"desynchronized\" (i.e., the states of the devices are spread out over their operating cycles), the aggregate behavior tends to smooth out. This behavior resembles that of a heterogeneous population where device parameters are distributed. In such cases, the dominant time constant of the aggregate response is well-approximated by the average thermal time constant of the individual devices.\nTherefore, our approximation is $\\tau = R C_{th}$, based on the assumption that the large, desynchronized population's aggregate dynamics are governed by the intrinsic thermal inertia of the individual units.\n\n### Part 2: Closed-Loop System Analysis\n\nThe controller is a PI controller with control direction $\\sigma$. The setpoint offset is:\n$$ \\delta T_s(t) = \\sigma \\left[ K_p e(t) + K_i \\int_0^t e(\\tau)\\,d\\tau \\right] $$\nwhere the error signal is $e(t) = r(t) - P_{agg}(t)$. The problem states $P_{agg}(0)=0$, so $P_{agg}(t) = \\delta P_{agg}(t)$.\nIn the Laplace domain, the controller is $C(s) = K_p + \\frac{K_i}{s}$, and the control signal is $\\delta T_s(s) = \\sigma C(s) E(s)$.\n\nThe closed-loop system is formed by the negative feedback interconnection of the plant and controller. The error is $E(s) = R(s) - P_{agg}(s)$.\nThe power response is $P_{agg}(s) = G_p(s) \\delta T_s(s) = G_p(s) \\sigma C(s) E(s) = G_p(s) \\sigma C(s) [R(s) - P_{agg}(s)]$.\nSolving for $P_{agg}(s)$:\n$$ P_{agg}(s) [1 + \\sigma G_p(s) C(s)] = \\sigma G_p(s) C(s) R(s) $$\nThe closed-loop transfer function is $T(s) = \\frac{P_{agg}(s)}{R(s)} = \\frac{\\sigma G_p(s) C(s)}{1 + \\sigma G_p(s) C(s)}$.\n\nThe characteristic equation is given by the denominator of the closed-loop transfer function set to zero:\n$$ 1 + \\sigma G_p(s) C(s) = 0 $$\nSubstituting $G_p(s) = \\frac{G}{1 + \\tau s}$ and $C(s) = \\frac{K_p s + K_i}{s}$:\n$$ 1 + \\sigma \\left( \\frac{G}{1 + \\tau s} \\right) \\left( \\frac{K_p s + K_i}{s} \\right) = 0 $$\nTo clear the denominators, we multiply by $s(1 + \\tau s)$:\n$$ s(1 + \\tau s) + \\sigma G (K_p s + K_i) = 0 $$\nExpanding and collecting terms in powers of $s$ yields the second-order characteristic equation:\n$$ \\tau s^2 + (1 + \\sigma G K_p) s + \\sigma G K_i = 0 $$\n\n### Part 3: Computational Method\n\n**a) Stability Analysis**\nThe stability of the LTI system is determined by the locations of the poles of the closed-loop transfer function, which are the roots of the characteristic equation $as^2+bs+c=0$, where:\n- $a = \\tau = R C_{th}$\n- $b = 1 + \\sigma G K_p$\n- $c = \\sigma G K_i$\nFor cooling loads, $\\sigma = -1$. The gain $G = -N/(R\\eta)$ is negative.\nAll physical parameters ($N, R, C_{th}, \\eta$) and controller gains ($K_p, K_i$) are positive.\nConsequently, the coefficients are:\n- $a = R C_{th} > 0$\n- $b = 1 + (-1)(-\\frac{N}{R\\eta}) K_p = 1 + \\frac{N K_p}{R \\eta} > 0$\n- $c = (-1)(-\\frac{N}{R\\eta}) K_i = \\frac{N K_i}{R \\eta} > 0$\nAccording to the Routh-Hurwitz stability criterion for a second-order system, if all coefficients ($a, b, c$) have the same sign (here, positive), all roots have strictly negative real parts. Therefore, the closed-loop system is stable for all test cases. The stability output will be $1$.\n\n**b, c, d) Dynamic Simulation for Performance Metrics**\nTo compute the Integral of Squared Error (ISE), final error, and maximum control effort, we simulate the system's response to a step reference $r(t) = A$ for $t \\ge 0$. We formulate the system dynamics in state-space form. Let the state vector be $\\mathbf{x}(t) = [x_1(t), x_2(t)]^T$, where $x_1(t) = P_{agg}(t)$ and $x_2(t) = \\int_0^t e(\\tau)d\\tau$.\n\nThe state equations are derived as follows:\n$\\dot{x}_2(t) = e(t) = r(t) - x_1(t)$.\nThe plant equation $\\tau \\dot{x}_1(t) + x_1(t) = G \\delta T_s(t)$ and controller equation $\\delta T_s(t) = \\sigma(K_p e(t) + K_i x_2(t))$ combine to give:\n$\\tau \\dot{x}_1(t) = -x_1(t) + G \\sigma [K_p(r(t) - x_1(t)) + K_i x_2(t)]$\nThis yields the differential equation for $x_1(t)$:\n$\\dot{x}_1(t) = -\\frac{1+G\\sigma K_p}{\\tau} x_1(t) + \\frac{G\\sigma K_i}{\\tau} x_2(t) + \\frac{G\\sigma K_p}{\\tau} r(t)$\n\nWe solve this system of two first-order ODEs numerically using the Forward Euler method with a time step of $\\Delta t=1$ second, as specified. The initial conditions are $x_1(0) = P_{agg}(0) = 0$ and $x_2(0) = 0$.\n\nThe simulation proceeds iteratively for $k=0, 1, \\dots, T_h-1$:\n1.  Calculate error: $e[k] = A - x_1[k]$.\n2.  Calculate control signal: $\\delta T_s[k] = \\sigma (K_p e[k] + K_i x_2[k])$.\n3.  Update states for the next time step $k+1$:\n    $x_1[k+1] = x_1[k] + \\Delta t \\cdot \\left( \\frac{G \\delta T_s[k] - x_1[k]}{\\tau} \\right)$\n    $x_2[k+1] = x_2[k] + \\Delta t \\cdot e[k]$\n4.  During the simulation, we accumulate the ISE, $\\sum_{k=0}^{T_h-1} (e[k])^2 \\Delta t$, and track the maximum value of $|\\delta T_s[k]|$.\n\nAfter the simulation over the horizon $[0, T_h]$, the final error is $e(T_h) = A - x_1[T_h]$. The final results are assembled in the required format.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the TCL control problem for the specified test cases.\n\n    The solution involves:\n    1. Calculating the parameters of a first-order LTI plant model for a TCL population.\n    2. Simulating the closed-loop response of this plant with a PI controller.\n    3. Computing stability, Integrated Squared Error (ISE), final error, and maximum control signal magnitude.\n    \"\"\"\n    test_cases = [\n        {\n            \"N\": 10000, \"P_dev\": 1000, \"R\": 0.005, \"C_th\": 1.2e6, \"eta\": 3, \"Delta\": 0.5,\n            \"sigma\": -1, \"Kp\": 1e-5, \"Ki\": 1e-7, \"A\": 100000, \"T_h\": 7200\n        },\n        {\n            \"N\": 2000, \"P_dev\": 1500, \"R\": 0.01, \"C_th\": 2e5, \"eta\": 2.5, \"Delta\": 0.5,\n            \"sigma\": -1, \"Kp\": 5e-6, \"Ki\": 2e-7, \"A\": 50000, \"T_h\": 7200\n        },\n        {\n            \"N\": 5000, \"P_dev\": 800, \"R\": 0.007, \"C_th\": 8e5, \"eta\": 3.5, \"Delta\": 0.5,\n            \"sigma\": -1, \"Kp\": 5e-5, \"Ki\": 8e-7, \"A\": 200000, \"T_h\": 7200\n        }\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        # Extract parameters\n        N = case[\"N\"]\n        R = case[\"R\"]\n        C_th = case[\"C_th\"]\n        eta = case[\"eta\"]\n        sigma = case[\"sigma\"]\n        Kp = case[\"Kp\"]\n        Ki = case[\"Ki\"]\n        A = case[\"A\"]\n        T_h = case[\"T_h\"]\n\n        # 1. Calculate Plant Parameters\n        # Static Gain G (W/K)\n        G = -N / (R * eta)\n        # Relaxation Time tau (s)\n        tau = R * C_th\n        \n        # 2. Stability Analysis\n        # Characteristic equation: a*s^2 + b*s + c = 0\n        a = tau\n        b = 1 + sigma * G * Kp\n        c = sigma * G * Ki\n        \n        # System is stable if a, b, c have the same sign.\n        # Since tau > 0, we check if b > 0 and c > 0.\n        is_stable = 1 if b > 0 and c > 0 else 0\n\n        # 3. Numerical Simulation\n        dt = 1.0  # Time step in seconds\n        num_steps = int(T_h / dt)\n        \n        # State variables: x1 = P_agg, x2 = integral of error\n        x1 = 0.0\n        x2 = 0.0\n        \n        # Performance metrics\n        ise = 0.0\n        max_abs_dTs = 0.0\n        \n        for k in range(num_steps):\n            # Calculate error\n            e = A - x1\n            \n            # Calculate control signal (setpoint offset)\n            dTs = sigma * (Kp * e + Ki * x2)\n            \n            # Update performance metrics\n            ise += e**2 * dt\n            if abs(dTs) > max_abs_dTs:\n                max_abs_dTs = abs(dTs)\n\n            # Update states using Forward Euler method\n            x1_dot = (G * dTs - x1) / tau\n            x2_dot = e\n            \n            x1 += x1_dot * dt\n            x2 += x2_dot * dt\n            \n        # Final error at t = T_h\n        final_error = A - x1\n\n        # Collect results for the current case\n        case_results = [is_stable, ise, final_error, max_abs_dTs]\n        all_results.append(case_results)\n\n    # 4. Format Output\n    # Create the final string in the format [[r1_1,r1_2,...],[r2_1,r2_2,...],...]\n    output_str = \"[\" + \",\".join(\n        \"[\" + \",\".join(map(str, res)) + \"]\" for res in all_results\n    ) + \"]\"\n    \n    print(output_str)\n\nsolve()\n```"
        }
    ]
}