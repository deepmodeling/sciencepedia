{
    "hands_on_practices": [
        {
            "introduction": "Mastering building thermal dynamics begins with a solid understanding of steady-state heat transfer. However, simple one-dimensional models based solely on $U$-values are insufficient, as they neglect the significant heat loss that occurs at geometric and material discontinuities. This exercise  challenges you to apply the industry-standard methodology for calculating total facade heat loss by combining 1D planar heat flow with the 2D effects of thermal bridges, quantified by linear thermal transmittance, or $\\psi$-values.",
            "id": "4073015",
            "problem": "A rectangular building facade is composed of multiple planar elements and line junctions, all separating a uniformly conditioned interior from a uniform exterior. Under steady-state conditions, heat transfer through the facade can be modeled from first principles. Begin with Fourier’s law of heat conduction and the definition of overall heat transfer coefficient for a planar element, and the definition of linear thermal transmittance for a junction. Using these foundations, construct a method to combine area-related terms based on the overall heat transfer coefficient $U$ and linear junction terms based on the linear thermal transmittance $\\psi$ into a single total heat-loss rate for the facade. The interior-to-exterior temperature difference is uniform and equal to $\\Delta T$. The linear thermal transmittance $\\psi$ of a junction is defined as the excess steady heat flow per unit length arising from two-dimensional effects at the junction, relative to the baseline one-dimensional conduction of the adjacent planar elements at the same $\\Delta T$. Assume that point thermal bridges are negligible and that the provided lengths for junctions are measured so that no junction length is counted more than once. The facade has the following planar components and junction types:\n\n- Opaque wall type $A$ with area $A_A = 220 \\ \\mathrm{m^{2}}$ and overall heat transfer coefficient $U_A = 0.22 \\ \\mathrm{W \\, m^{-2} \\, K^{-1}}$.\n- Opaque wall type $B$ with area $A_B = 80 \\ \\mathrm{m^{2}}$ and overall heat transfer coefficient $U_B = 0.35 \\ \\mathrm{W \\, m^{-2} \\, K^{-1}}$.\n- Windows type $W$ with total glazed-and-frame area $A_W = 40 \\ \\mathrm{m^{2}}$ and overall heat transfer coefficient $U_W = 1.50 \\ \\mathrm{W \\, m^{-2} \\, K^{-1}}$.\n\nThe facade includes the following distinct linear junctions with lengths and $\\psi$ values measured in accordance with the above definition:\n\n- Window-to-wall junctions along wall $A$ perimeters with total length $L_{A\\!W} = 96 \\ \\mathrm{m}$ and $\\psi_{A\\!W} = 0.06 \\ \\mathrm{W \\, m^{-1} \\, K^{-1}}$.\n- Window-to-wall junctions along wall $B$ perimeters with total length $L_{B\\!W} = 24 \\ \\mathrm{m}$ and $\\psi_{B\\!W} = 0.08 \\ \\mathrm{W \\, m^{-1} \\, K^{-1}}$.\n- Floor slab edge junctions with wall $A$ having length $L_{sA} = 30 \\ \\mathrm{m}$ and $\\psi_{sA} = 0.35 \\ \\mathrm{W \\, m^{-1} \\, K^{-1}}$.\n- Floor slab edge junctions with wall $B$ having length $L_{sB} = 18 \\ \\mathrm{m}$ and $\\psi_{sB} = 0.42 \\ \\mathrm{W \\, m^{-1} \\, K^{-1}}$.\n- External corner junctions of the facade with total vertical corner length $L_{C} = 12 \\ \\mathrm{m}$ and $\\psi_{C} = 0.10 \\ \\mathrm{W \\, m^{-1} \\, K^{-1}}$.\n\nAssume a uniform interior-to-exterior temperature difference $\\Delta T = 22 \\ \\mathrm{K}$. Using first principles to justify your method, derive the general expression for the total steady heat-loss rate $Q_{\\text{tot}}$ through the facade that correctly combines the area-related $U$ terms and linear $\\psi$ terms without double counting, and then evaluate $Q_{\\text{tot}}$ numerically for the given data. Round your final numerical answer to four significant figures. Express the final heat-loss rate in watts ($\\mathrm{W}$).",
            "solution": "The problem is deemed valid as it is scientifically grounded in the principles of heat transfer, well-posed with all necessary data provided, and objective in its formulation. The provided physical quantities are realistic and dimensionally consistent.\n\nThe objective is to derive a comprehensive expression for the total steady-state heat-loss rate, $Q_{\\text{tot}}$, through a building facade, and then to calculate its numerical value. The facade consists of planar elements with one-dimensional ($1\\mathrm{D}$) heat transfer characteristics and linear junctions where two-dimensional ($2\\mathrm{D}$) heat transfer effects are significant.\n\nWe begin from first principles. The fundamental law governing heat conduction is Fourier's law, which in vector form is:\n$$\n\\vec{q} = -k \\nabla T\n$$\nwhere $\\vec{q}$ is the heat flux vector ($\\mathrm{W \\, m^{-2}}$), $k$ is the thermal conductivity ($\\mathrm{W \\, m^{-1} \\, K^{-1}}$), and $\\nabla T$ is the temperature gradient ($\\mathrm{K \\, m^{-1}}$).\n\nFor a simple planar element of area $A$ and thickness $d$, under steady-state conditions with a temperature difference $\\Delta T$ across it, Fourier's law simplifies to a one-dimensional heat flow rate $Q$:\n$$\nQ = \\frac{k A \\Delta T}{d}\n$$\nIn building physics, it is standard practice to characterize the thermal performance of a composite building element (like a wall or window assembly) using the overall heat transfer coefficient, $U$ (in $\\mathrm{W \\, m^{-2} \\, K^{-1}}$). The $U$-value encapsulates the conductive and convective resistances of all layers and surfaces. The heat flow rate, $Q_{\\text{1D},i}$, through a planar element $i$ of area $A_i$ and overall heat transfer coefficient $U_i$ is then given by:\n$$\nQ_{\\text{1D},i} = U_i A_i \\Delta T\n$$\nIf we were to naively model the entire facade as a collection of disjoint planar elements, the total heat loss would be the sum of these individual one-dimensional flows:\n$$\nQ_{\\text{planar}} = \\left( \\sum_{i} U_i A_i \\right) \\Delta T\n$$\nThis model, however, ignores the multidimensional heat flow that occurs at the junctions between elements (e.g., wall-window interfaces, corners, slab edges). At these \"thermal bridges,\" the heat flow is enhanced due to material and geometric discontinuities.\n\nTo account for this, the concept of linear thermal transmittance, $\\psi$ (in $\\mathrm{W \\, m^{-1} \\, K^{-1}}$), is introduced. As defined in the problem statement, $\\psi$ quantifies the *excess* heat flow per unit length of the junction, relative to the baseline one-dimensional flow of the adjacent planar elements. The total heat flow through a region containing a junction is the sum of the $1\\mathrm{D}$ component (already calculated by the $U A$ terms) and an additional term for the junction. The excess heat flow rate, $Q_{\\text{bridge}, j}$, for a linear junction $j$ of length $L_j$ with linear thermal transmittance $\\psi_j$ is:\n$$\nQ_{\\text{bridge}, j} = \\psi_j L_j \\Delta T\n$$\nBy defining $\\psi$ as an *excess* quantity, we can calculate the total heat loss of the facade, $Q_{\\text{tot}}$, by summing the baseline $1\\mathrm{D}$ heat loss through all planar areas and the additional, excess heat loss through all linear junctions. This methodology prevents the double-counting of heat flow. The total heat loss rate is therefore:\n$$\nQ_{\\text{tot}} = Q_{\\text{planar}} + Q_{\\text{bridges}} = \\left( \\sum_{i} U_i A_i \\right) \\Delta T + \\left( \\sum_{j} \\psi_j L_j \\right) \\Delta T\n$$\nFactoring out the uniform temperature difference $\\Delta T$, we arrive at the general expression for the total steady-state heat loss rate:\n$$\nQ_{\\text{tot}} = \\left( \\sum_{i} U_i A_i + \\sum_{j} \\psi_j L_j \\right) \\Delta T\n$$\nThis can also be expressed as $Q_{\\text{tot}} = H_T \\Delta T$, where $H_T$ is the total heat transfer coefficient of the facade, defined as $H_T = \\sum_{i} U_i A_i + \\sum_{j} \\psi_j L_j$.\n\nNow, we evaluate this expression using the data provided.\n\nFirst, we calculate the sum of the area-related heat transfer coefficients, $\\sum_{i} U_i A_i$:\nThe planar components are wall type $A$, wall type $B$, and windows type $W$.\n$$\n\\sum_{i} U_i A_i = U_A A_A + U_B A_B + U_W A_W\n$$\nSubstituting the given values:\n$$\n\\sum_i U_i A_i = (0.22 \\ \\mathrm{W \\, m^{-2} \\, K^{-1}}) (220 \\ \\mathrm{m^2}) + (0.35 \\ \\mathrm{W \\, m^{-2} \\, K^{-1}}) (80 \\ \\mathrm{m^2}) + (1.50 \\ \\mathrm{W \\, m^{-2} \\, K^{-1}}) (40 \\ \\mathrm{m^2})\n$$\n$$\n\\sum_i U_i A_i = 48.4 \\ \\mathrm{W \\, K^{-1}} + 28.0 \\ \\mathrm{W \\, K^{-1}} + 60.0 \\ \\mathrm{W \\, K^{-1}} = 136.4 \\ \\mathrm{W \\, K^{-1}}\n$$\nNext, we calculate the sum of the junction-related heat transfer coefficients, $\\sum_{j} \\psi_j L_j$:\nThe linear junctions are window-wall ($A$ and $B$), slab-wall ($A$ and $B$), and external corners.\n$$\n\\sum_{j} \\psi_j L_j = \\psi_{A\\!W} L_{A\\!W} + \\psi_{B\\!W} L_{B\\!W} + \\psi_{sA} L_{sA} + \\psi_{sB} L_{sB} + \\psi_{C} L_{C}\n$$\nSubstituting the given values:\n$$\n\\sum_j \\psi_j L_j = (0.06)(96) + (0.08)(24) + (0.35)(30) + (0.42)(18) + (0.10)(12) \\ \\mathrm{W \\, K^{-1}}\n$$\n$$\n\\sum_j \\psi_j L_j = 5.76 + 1.92 + 10.5 + 7.56 + 1.2 \\ \\mathrm{[W \\, K^{-1}]}\n$$\n$$\n\\sum_j \\psi_j L_j = 26.94 \\ \\mathrm{W \\, K^{-1}}\n$$\nNow, we calculate the total heat transfer coefficient $H_T$:\n$$\nH_T = \\sum_i U_i A_i + \\sum_j \\psi_j L_j = 136.4 \\ \\mathrm{W \\, K^{-1}} + 26.94 \\ \\mathrm{W \\, K^{-1}} = 163.34 \\ \\mathrm{W \\, K^{-1}}\n$$\nFinally, we calculate the total heat-loss rate $Q_{\\text{tot}}$ using the given temperature difference $\\Delta T = 22 \\ \\mathrm{K}$:\n$$\nQ_{\\text{tot}} = H_T \\Delta T = (163.34 \\ \\mathrm{W \\, K^{-1}}) (22 \\ \\mathrm{K})\n$$\n$$\nQ_{\\text{tot}} = 3593.48 \\ \\mathrm{W}\n$$\nThe problem requires the final answer to be rounded to four significant figures.\n$$\nQ_{\\text{tot}} \\approx 3593 \\ \\mathrm{W}\n$$\nThe derived expression correctly combines the one-dimensional area-based heat transfer and the two-dimensional excess heat transfer at junctions, providing a complete model for the facade's thermal performance under the specified conditions.",
            "answer": "$$\\boxed{3593}$$"
        },
        {
            "introduction": "Real-world buildings are constantly responding to dynamic conditions like changing outdoor temperatures and solar radiation. To capture this behavior, we must move beyond steady-state analysis and solve the transient heat equation. This hands-on practice  guides you through the fundamental process of developing a numerical simulation, requiring you to derive an explicit finite difference scheme from first principles and, critically, to determine the stability constraints that govern its use.",
            "id": "4073024",
            "problem": "A rectangular building wall is modeled as a one-dimensional slab of thickness $L$ with uniform material properties: thermal conductivity $k$ (in $\\mathrm{W}\\,\\mathrm{m}^{-1}\\,\\mathrm{K}^{-1}$), density $\\rho$ (in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$), and specific heat capacity $c$ (in $\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$). The thermal diffusivity is $\\alpha = \\frac{k}{\\rho c}$ (in $\\mathrm{m}^2\\,\\mathrm{s}^{-1}$). The spatial domain is discretized into $N$ nodes with uniform spacing $\\Delta x = \\frac{L}{N-1}$ (in $\\mathrm{m}$). The transient exterior air temperature at the outside surface $x=0$ is given by the function $T_{\\text{ext}}(t) = T_{\\text{mean}} + A \\sin\\!\\left(2\\pi t / 86400\\right)$ (in $\\mathrm{K}$), where the sine argument is in radians, $t$ is time in seconds, $T_{\\text{mean}}$ is a base temperature (in $\\mathrm{K}$), and $A$ is the amplitude (in $\\mathrm{K}$). The inside boundary at $x=L$ may be either a convective boundary with constant indoor air temperature $T_{\\text{int}}$ (in $\\mathrm{K}$) and convective heat transfer coefficient $h_{\\text{int}}$ (in $\\mathrm{W}\\,\\mathrm{m}^{-2}\\,\\mathrm{K}^{-1}$), or a fixed-temperature Dirichlet boundary set equal to $T_{\\text{int}}$.\n\nStarting from energy conservation in a control volume and Fourier’s law of heat conduction, derive a one-dimensional explicit finite difference scheme in time (Forward-Time) and space (Centered-Space) for the interior nodes. For the boundaries, derive consistent explicit updates using a first-principles balance of conduction and convection at $x=0$ with coefficient $h_{\\text{ext}}$ (in $\\mathrm{W}\\,\\mathrm{m}^{-2}\\,\\mathrm{K}^{-1}$) to $T_{\\text{ext}}(t)$, and at $x=L$ either convection with $h_{\\text{int}}$ to $T_{\\text{int}}$ or a fixed Dirichlet condition. Use only the stated physical laws and definitions; do not invoke unstated shortcut formulas. Determine the maximum stable time step $\\Delta t_{\\max}$ (in seconds) based on the Fourier number $Fo = \\frac{\\alpha \\Delta t}{\\Delta x^2}$ and appropriate stability reasoning for the explicit scheme, including interior-mode stability and boundary update constraints. Your derivation must clearly state the conditions under which the explicit updates remain stable.\n\nYour program must implement the derived logic to compute $\\Delta t_{\\max}$ for each of the following test cases. Express all outputs in seconds, rounded to six decimal places. The sine function in $T_{\\text{ext}}(t)$ uses radians.\n\nTest Suite:\n- Case $1$ (masonry wall, both boundaries convective):\n    - $L = 0.25$ $\\mathrm{m}$, $k = 1.2$ $\\mathrm{W}\\,\\mathrm{m}^{-1}\\,\\mathrm{K}^{-1}$, $\\rho = 2200$ $\\mathrm{kg}\\,\\mathrm{m}^{-3}$, $c = 880$ $\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$, $N = 21$.\n    - Exterior: $h_{\\text{ext}} = 25$ $\\mathrm{W}\\,\\mathrm{m}^{-2}\\,\\mathrm{K}^{-1}$, $T_{\\text{mean}} = 278.15$ $\\mathrm{K}$, $A = 5$ $\\mathrm{K}$.\n    - Interior: convective with $h_{\\text{int}} = 8$ $\\mathrm{W}\\,\\mathrm{m}^{-2}\\,\\mathrm{K}^{-1}$ and $T_{\\text{int}} = 294.15$ $\\mathrm{K}$.\n- Case $2$ (aluminum panel, both boundaries convective):\n    - $L = 0.005$ $\\mathrm{m}$, $k = 205$ $\\mathrm{W}\\,\\mathrm{m}^{-1}\\,\\mathrm{K}^{-1}$, $\\rho = 2700$ $\\mathrm{kg}\\,\\mathrm{m}^{-3}$, $c = 900$ $\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$, $N = 11$.\n    - Exterior: $h_{\\text{ext}} = 15$ $\\mathrm{W}\\,\\mathrm{m}^{-2}\\,\\mathrm{K}^{-1}$, $T_{\\text{mean}} = 280.15$ $\\mathrm{K}$, $A = 7$ $\\mathrm{K}$.\n    - Interior: convective with $h_{\\text{int}} = 7$ $\\mathrm{W}\\,\\mathrm{m}^{-2}\\,\\mathrm{K}^{-1}$ and $T_{\\text{int}} = 295.15$ $\\mathrm{K}$.\n- Case $3$ (insulation, exterior convective and interior Dirichlet):\n    - $L = 0.2$ $\\mathrm{m}$, $k = 0.035$ $\\mathrm{W}\\,\\mathrm{m}^{-1}\\,\\mathrm{K}^{-1}$, $\\rho = 30$ $\\mathrm{kg}\\,\\mathrm{m}^{-3}$, $c = 1400$ $\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$, $N = 41$.\n    - Exterior: $h_{\\text{ext}} = 20$ $\\mathrm{W}\\,\\mathrm{m}^{-2}\\,\\mathrm{K}^{-1}$, $T_{\\text{mean}} = 275.15$ $\\mathrm{K}$, $A = 8$ $\\mathrm{K}$.\n    - Interior: fixed Dirichlet boundary at $T_{\\text{int}} = 294.15$ $\\mathrm{K}$ (no convection coefficient).\n- Case $4$ (coarse discretization, strong exterior convection):\n    - $L = 0.1$ $\\mathrm{m}$, $k = 0.12$ $\\mathrm{W}\\,\\mathrm{m}^{-1}\\,\\mathrm{K}^{-1}$, $\\rho = 500$ $\\mathrm{kg}\\,\\mathrm{m}^{-3}$, $c = 1600$ $\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$, $N = 3$.\n    - Exterior: $h_{\\text{ext}} = 100$ $\\mathrm{W}\\,\\mathrm{m}^{-2}\\,\\mathrm{K}^{-1}$, $T_{\\text{mean}} = 276.15$ $\\mathrm{K}$, $A = 6$ $\\mathrm{K}$.\n    - Interior: convective with $h_{\\text{int}} = 10$ $\\mathrm{W}\\,\\mathrm{m}^{-2}\\,\\mathrm{K}^{-1}$ and $T_{\\text{int}} = 293.15$ $\\mathrm{K}$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example, $\\left[\\text{result}_1,\\text{result}_2,\\text{result}_3,\\text{result}_4\\right]$, where each $\\text{result}_i$ is the computed $\\Delta t_{\\max}$ for the corresponding case, in seconds rounded to six decimal places.",
            "solution": "The analysis of this problem begins with the fundamental principle of energy conservation applied to a one-dimensional heat conduction problem, governed by Fourier's law. We will derive the explicit finite difference equations for interior and boundary nodes and subsequently determine the stability constraints that dictate the maximum permissible time step, $\\Delta t_{\\max}$.\n\nThe governing physical principle is the first law of thermodynamics, which states that the rate of change of internal energy within a control volume equals the net rate of heat transfer into that volume. For an incompressible solid with constant properties, this is expressed as:\n$$ \\rho c \\frac{\\partial T}{\\partial t} = -\\nabla \\cdot \\vec{q}'' $$\nwhere $\\rho$ is the density, $c$ is the specific heat capacity, $T$ is the temperature, and $\\vec{q}''$ is the heat flux vector. In one dimension, and with Fourier's law of conduction ($q''_x = -k \\frac{\\partial T}{\\partial x}$), this simplifies to the heat equation:\n$$ \\rho c \\frac{\\partial T}{\\partial t} = \\frac{\\partial}{\\partial x} \\left( k \\frac{\\partial T}{\\partial x} \\right) $$\nGiven uniform thermal conductivity $k$, the equation becomes:\n$$ \\frac{\\partial T}{\\partial t} = \\alpha \\frac{\\partial^2 T}{\\partial x^2} $$\nwhere $\\alpha = \\frac{k}{\\rho c}$ is the thermal diffusivity.\n\nWe discretize the spatial domain $x \\in [0, L]$ into $N$ nodes, indexed $i=0, 1, \\dots, N-1$, with uniform spacing $\\Delta x = \\frac{L}{N-1}$. The temperature at node $i$ and time step $p$ is denoted $T_i^p$.\n\n**1. Finite Difference Equation for Interior Nodes ($i=1, \\dots, N-2$)**\n\nWe apply an energy balance to a control volume of width $\\Delta x$ centered at node $i$, extending from $x_i - \\frac{\\Delta x}{2}$ to $x_i + \\frac{\\Delta x}{2}$. Per unit area, the energy balance is:\n$$ \\text{Rate of Energy Storage} = \\text{Rate of Heat Conduction In} - \\text{Rate of Heat Conduction Out} $$\n$$ \\rho c \\Delta x \\frac{dT_i}{dt} = q''_{x, \\text{in}} - q''_{x, \\text{out}} $$\nThe heat fluxes are approximated using finite differences:\n- Heat flux in from node $i-1$: $q''_{x, \\text{in}} \\approx k \\frac{T_{i-1} - T_i}{\\Delta x}$\n- Heat flux out to node $i+1$: $q''_{x, \\text{out}} \\approx k \\frac{T_i - T_{i+1}}{\\Delta x}$\n\nSubstituting these into the energy balance:\n$$ \\rho c \\Delta x \\frac{dT_i}{dt} = k \\frac{T_{i-1} - T_i}{\\Delta x} - k \\frac{T_i - T_{i+1}}{\\Delta x} = \\frac{k}{\\Delta x} (T_{i-1} - 2T_i + T_{i+1}) $$\nDividing by $\\rho c \\Delta x$ yields the semi-discretized equation:\n$$ \\frac{dT_i}{dt} = \\frac{\\alpha}{\\Delta x^2} (T_{i-1} - 2T_i + T_{i+1}) $$\nApplying the Forward-Time (Explicit Euler) approximation for the time derivative, $\\frac{dT_i}{dt} \\approx \\frac{T_i^{p+1} - T_i^p}{\\Delta t}$, we get:\n$$ \\frac{T_i^{p+1} - T_i^p}{\\Delta t} = \\frac{\\alpha}{\\Delta x^2} (T_{i-1}^p - 2T_i^p + T_{i+1}^p) $$\nSolving for the future temperature $T_i^{p+1}$:\n$$ T_i^{p+1} = T_i^p + \\frac{\\alpha \\Delta t}{\\Delta x^2} (T_{i-1}^p - 2T_i^p + T_{i+1}^p) $$\nDefining the dimensionless Fourier number, $Fo = \\frac{\\alpha \\Delta t}{\\Delta x^2}$, the equation becomes:\n$$ T_i^{p+1} = Fo \\cdot T_{i-1}^p + (1 - 2Fo) T_i^p + Fo \\cdot T_{i+1}^p $$\nFor the scheme to be stable, the coefficients multiplying the temperatures at time step $p$ must be non-negative. This requires $1 - 2Fo \\ge 0$, which leads to the stability criterion for interior nodes:\n$$ Fo \\le \\frac{1}{2} \\implies \\Delta t \\le \\frac{\\Delta x^2}{2\\alpha} $$\n\n**2. Finite Difference Equation for Exterior Boundary Node ($x=0$, $i=0$)**\n\nFor the node at the exterior surface, we consider a control volume of half-width, from $x=0$ to $x=\\frac{\\Delta x}{2}$. The energy balance includes both convection from the exterior air and conduction from the adjacent interior node ($i=1$).\n$$ \\rho c \\frac{\\Delta x}{2} \\frac{dT_0}{dt} = q''_{\\text{conv}} + q''_{\\text{cond}} $$\n- Convective heat flux from exterior air: $q''_{\\text{conv}} = h_{\\text{ext}} (T_{\\text{ext}}(t) - T_0)$\n- Conductive heat flux from node $1$: $q''_{\\text{cond}} = k \\frac{T_1 - T_0}{\\Delta x}$\n\nThe energy balance is:\n$$ \\rho c \\frac{\\Delta x}{2} \\frac{dT_0}{dt} = h_{\\text{ext}} (T_{\\text{ext}}(t) - T_0) + k \\frac{T_1 - T_0}{\\Delta x} $$\nDiscretizing in time and solving for $T_0^{p+1}$:\n$$ \\rho c \\frac{\\Delta x}{2} \\frac{T_0^{p+1} - T_0^p}{\\Delta t} = h_{\\text{ext}} (T_{\\text{ext}}^p - T_0^p) + \\frac{k}{\\Delta x} (T_1^p - T_0^p) $$\n$$ T_0^{p+1} = T_0^p + \\frac{2\\Delta t}{\\rho c \\Delta x} \\left[ h_{\\text{ext}}(T_{\\text{ext}}^p - T_0^p) + \\frac{k}{\\Delta x}(T_1^p - T_0^p) \\right] $$\nRearranging and grouping terms by temperature at time $p$:\n$$ T_0^{p+1} = \\left( 1 - \\frac{2 h_{\\text{ext}} \\Delta t}{\\rho c \\Delta x} - \\frac{2 k \\Delta t}{\\rho c \\Delta x^2} \\right) T_0^p + \\left(\\frac{2 k \\Delta t}{\\rho c \\Delta x^2}\\right) T_1^p + \\left(\\frac{2 h_{\\text{ext}} \\Delta t}{\\rho c \\Delta x}\\right) T_{\\text{ext}}^p $$\nUsing the Fourier number $Fo = \\frac{\\alpha \\Delta t}{\\Delta x^2} = \\frac{k \\Delta t}{\\rho c \\Delta x^2}$ and defining the Biot number $Bi_{\\text{ext}} = \\frac{h_{\\text{ext}} \\Delta x}{k}$, we can simplify the coefficients:\n$$ \\frac{2 h_{\\text{ext}} \\Delta t}{\\rho c \\Delta x} = \\frac{2 h_{\\text{ext}} \\Delta x}{k} \\frac{k \\Delta t}{\\rho c \\Delta x^2} = 2 Bi_{\\text{ext}} Fo $$\nThe update equation becomes:\n$$ T_0^{p+1} = (1 - 2Fo - 2Bi_{\\text{ext}}Fo) T_0^p + 2Fo \\cdot T_1^p + 2Bi_{\\text{ext}}Fo \\cdot T_{\\text{ext}}^p $$\n$$ T_0^{p+1} = [1 - 2Fo(1 + Bi_{\\text{ext}})] T_0^p + 2Fo \\cdot T_1^p + 2Bi_{\\text{ext}}Fo \\cdot T_{\\text{ext}}^p $$\nThe stability condition requires the coefficient of $T_0^p$ to be non-negative:\n$$ 1 - 2Fo(1 + Bi_{\\text{ext}}) \\ge 0 \\implies Fo \\le \\frac{1}{2(1 + Bi_{\\text{ext}})} $$\n$$ \\Delta t \\le \\frac{\\Delta x^2}{2\\alpha(1 + \\frac{h_{\\text{ext}}\\Delta x}{k})} $$\nThis constraint is more restrictive than the interior node constraint, as $Bi_{\\text{ext}} > 0$.\n\n**3. Finite Difference Equation for Interior Boundary Node ($x=L$, $i=N-1$)**\n\n**A. Convective Boundary:**\nThe derivation is symmetrical to the exterior boundary case. The control volume is from $x=L-\\frac{\\Delta x}{2}$ to $x=L$. The energy balance is:\n$$ \\rho c \\frac{\\Delta x}{2} \\frac{dT_{N-1}}{dt} = q''_{\\text{cond}} + q''_{\\text{conv}} $$\n- Conductive heat flux from node $N-2$: $q''_{\\text{cond}} = k \\frac{T_{N-2} - T_{N-1}}{\\Delta x}$\n- Convective heat flux from interior air: $q''_{\\text{conv}} = h_{\\text{int}} (T_{\\text{int}} - T_{N-1})$\n\nFollowing the same procedure, we arrive at the update equation:\n$$ T_{N-1}^{p+1} = [1 - 2Fo(1 + Bi_{\\text{int}})] T_{N-1}^p + 2Fo \\cdot T_{N-2}^p + 2Bi_{\\text{int}}Fo \\cdot T_{\\text{int}} $$\nwhere $Bi_{\\text{int}} = \\frac{h_{\\text{int}} \\Delta x}{k}$. The stability criterion is:\n$$ \\Delta t \\le \\frac{\\Delta x^2}{2\\alpha(1 + \\frac{h_{\\text{int}}\\Delta x}{k})} $$\n\n**B. Dirichlet Boundary:**\nIf the boundary at $x=L$ is a fixed-temperature (Dirichlet) boundary, its temperature is prescribed for all time:\n$$ T_{N-1}^p = T_{\\text{int}} \\quad \\forall p $$\nNo energy balance or update equation is needed for this node. The fixed temperature $T_{N-1}$ is simply used in the update equation for its neighbor, node $N-2$. The Dirichlet boundary itself imposes no new stability constraint on $\\Delta t$.\n\n**4. Overall Stability and Maximum Time Step ($\\Delta t_{\\max}$)**\n\nFor an explicit finite difference scheme to remain numerically stable, the time step $\\Delta t$ must satisfy all derived stability conditions simultaneously. The overall maximum stable time step, $\\Delta t_{\\max}$, is therefore the minimum of the limits imposed by the interior nodes and any convective boundary nodes.\n\nLet $\\Delta t_{\\text{int\\_nodes}} = \\frac{\\Delta x^2}{2\\alpha}$.\nLet $\\Delta t_{\\text{ext\\_boundary}} = \\frac{\\Delta x^2}{2\\alpha(1 + \\frac{h_{\\text{ext}}\\Delta x}{k})}$.\nIf the interior boundary is convective, let $\\Delta t_{\\text{int\\_boundary}} = \\frac{\\Delta x^2}{2\\alpha(1 + \\frac{h_{\\text{int}}\\Delta x}{k})}$.\n\nThen, $\\Delta t_{\\max}$ is the minimum of all applicable constraints for a given case.\n- For two convective boundaries: $\\Delta t_{\\max} = \\min(\\Delta t_{\\text{int\\_nodes}}, \\Delta t_{\\text{ext\\_boundary}}, \\Delta t_{\\text{int\\_boundary}})$.\n- For one convective and one Dirichlet boundary: $\\Delta t_{\\max} = \\min(\\Delta t_{\\text{int\\_nodes}}, \\Delta t_{\\text{ext\\_boundary}})$.\n\nSince the Biot number is always non-negative ($h \\ge 0, k > 0, \\Delta x > 0$), the constraints from convective boundaries are always more or equally restrictive than the constraint from interior nodes. The calculation simplifies to finding the minimum $\\Delta t$ among the boundary conditions.\n\nThe program will implement these formulas to calculate $\\Delta t_{\\max}$ for each test case based on its specific boundary types and physical properties.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_dt_max(params):\n    \"\"\"\n    Calculates the maximum stable time step for a 1D transient heat conduction problem\n    using an explicit finite difference scheme.\n\n    The calculation is based on stability criteria for interior nodes and convective\n    boundary nodes.\n\n    Args:\n        params (dict): A dictionary containing all the physical and discretization\n                       parameters for a specific case.\n\n    Returns:\n        float: The maximum stable time step (dt_max) in seconds.\n    \"\"\"\n    # Extract parameters from the dictionary\n    L = params['L']\n    k = params['k']\n    rho = params['rho']\n    c = params['c']\n    N = params['N']\n    h_ext = params['h_ext']\n    \n    # Calculate derived simulation parameters\n    # Spatial step size\n    delta_x = L / (N - 1)\n    # Thermal diffusivity\n    alpha = k / (rho * c)\n    \n    # --- Stability Criteria Derivations ---\n\n    # 1. Interior nodes stability constraint: dt <= dx^2 / (2 * alpha)\n    # This is from the coefficient of T_i^p in the FTCS scheme: (1 - 2*Fo) >= 0\n    # where Fo = alpha * dt / dx^2.\n    dt_interior_constraint = (delta_x**2) / (2 * alpha)\n    \n    # 2. Exterior boundary (x=0) stability constraint (convective)\n    # This is from the coefficient of T_0^p in its energy balance update equation:\n    # (1 - 2*Fo*(1 + Bi_ext)) >= 0, where Bi_ext = h_ext * dx / k.\n    # This leads to: dt <= dx^2 / (2 * alpha * (1 + h_ext * dx / k))\n    dt_ext_boundary_constraint = (delta_x**2) / (2 * alpha * (1 + (h_ext * delta_x) / k))\n    \n    # Initialize a list of all applicable constraints\n    constraints = [dt_interior_constraint, dt_ext_boundary_constraint]\n    \n    # 3. Interior boundary (x=L) stability constraint\n    # This is only applicable if the boundary is convective.\n    # A Dirichlet boundary imposes no additional stability constraint.\n    if 'h_int' in params:\n        h_int = params['h_int']\n        # The derivation is symmetric to the exterior boundary case:\n        # dt <= dx^2 / (2 * alpha * (1 + h_int * dx / k))\n        dt_int_boundary_constraint = (delta_x**2) / (2 * alpha * (1 + (h_int * delta_x) / k))\n        constraints.append(dt_int_boundary_constraint)\n        \n    # The overall maximum stable time step is the minimum of all constraints\n    return min(constraints)\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: Masonry wall, both boundaries convective\n        {\n            'L': 0.25, 'k': 1.2, 'rho': 2200, 'c': 880, 'N': 21,\n            'h_ext': 25, 'h_int': 8\n        },\n        # Case 2: Aluminum panel, both boundaries convective\n        {\n            'L': 0.005, 'k': 205, 'rho': 2700, 'c': 900, 'N': 11,\n            'h_ext': 15, 'h_int': 7\n        },\n        # Case 3: Insulation, exterior convective and interior Dirichlet\n        {\n            'L': 0.2, 'k': 0.035, 'rho': 30, 'c': 1400, 'N': 41,\n            'h_ext': 20  # No h_int, indicating a Dirichlet boundary\n        },\n        # Case 4: Coarse discretization, strong exterior convection\n        {\n            'L': 0.1, 'k': 0.12, 'rho': 500, 'c': 1600, 'N': 3,\n            'h_ext': 100, 'h_int': 10\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        dt_max = calculate_dt_max(case)\n        # Format the result to six decimal places\n        results.append(f\"{dt_max:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\n# Execute the solver\nsolve()\n```"
        },
        {
            "introduction": "While the explicit method from the previous exercise provides valuable insight, its conditional stability often imposes impractically small time steps, especially for walls with diverse material layers. This advanced practice  introduces a more powerful and robust approach: the Crank-Nicolson implicit scheme. You will implement this unconditionally stable method to model a multilayer wall, learning to construct and solve the tridiagonal system of equations that is a hallmark of implicit finite difference and finite volume methods in engineering.",
            "id": "4073050",
            "problem": "Consider a one-dimensional multilayer wall with piecewise-constant material properties subjected to time-varying outdoor air temperature and indoor air held by convective boundary conditions. Starting from conservation of energy and Fourier heat conduction, derive a semidiscrete spatial model and implement a Crank–Nicolson time integration scheme. Construct the resulting tridiagonal linear system at each time step, and solve it to obtain the wall temperature field over time. Explicitly address numerical damping and accuracy characteristics of the Crank–Nicolson method in your derivation and algorithm design, but do not rely on any shortcut formulas beyond the fundamental base.\n\nFundamental base:\n- Conservation of energy in differential form: for temperature field $T(x,t)$ in a homogeneous medium, the one-dimensional transient heat equation is\n$$\n\\rho c \\,\\frac{\\partial T}{\\partial t} = \\frac{\\partial}{\\partial x} \\left( k \\,\\frac{\\partial T}{\\partial x} \\right),\n$$\nwhere $\\rho$ is mass density in $\\mathrm{kg/m^3}$, $c$ is specific heat capacity in $\\mathrm{J/(kg\\cdot K)}$, and $k$ is thermal conductivity in $\\mathrm{W/(m\\cdot K)}$.\n- Fourier’s law of heat conduction: heat flux $q$ satisfies $q = -k\\,\\partial T/\\partial x$.\n- Convective (Robin) boundary condition: at a surface in contact with air at temperature $T_{\\infty}(t)$, the heat flux satisfies $q = h\\,(T_{\\mathrm{surface}} - T_{\\infty}(t))$, where $h$ is the convective heat transfer coefficient in $\\mathrm{W/(m^2\\cdot K)}$.\n\nSpatial discretization requirements:\n- Discretize the wall along $x$ with a finite-volume approach: for control volume $i$ with thickness $\\Delta x_i$, center temperature $T_i(t)$, and material properties $\\rho_i$, $c_i$, $k_i$, write the energy balance over each control volume using conductive fluxes through the interfaces.\n- At an internal interface between control volumes $i$ and $i+1$, use the series thermal resistance over the two adjoining half-thicknesses to approximate the interface conductance. Let the interface conductance be\n$$\nG_{i+\\frac{1}{2}} = \\frac{1}{\\left(\\frac{\\Delta x_i}{2\\,k_i}\\right) + \\left(\\frac{\\Delta x_{i+1}}{2\\,k_{i+1}}\\right)}.\n$$\n- At the exterior boundary (index $1$) with outdoor air at temperature $T_{\\text{out}}(t)$ and convective coefficient $h_{\\text{out}}$, model the total series resistance from the cell center to ambient as\n$$\nR_{\\text{left}} = \\frac{\\Delta x_1}{2\\,k_1} + \\frac{1}{h_{\\text{out}}}, \\quad \\text{so that} \\quad q_{\\text{left}} = \\frac{T_{\\text{out}}(t) - T_1(t)}{R_{\\text{left}}}.\n$$\nSimilarly, at the interior boundary (index $N$) with room air at temperature $T_{\\text{room}}(t)$ and convective coefficient $h_{\\text{in}}$,\n$$\nR_{\\text{right}} = \\frac{\\Delta x_N}{2\\,k_N} + \\frac{1}{h_{\\text{in}}}, \\quad \\text{so that} \\quad q_{\\text{right}} = \\frac{T_{\\text{room}}(t) - T_N(t)}{R_{\\text{right}}}.\n$$\n\nTime discretization requirements:\n- Using the semidiscrete system from the above finite-volume spatial discretization, implement the Crank–Nicolson scheme. Construct the tridiagonal system for the temperatures at time level $t^{n+1}$ in terms of the temperatures at time level $t^{n}$.\n- The scheme must be implemented in a way that is consistent with the time variation of $T_{\\text{out}}(t)$ (use $T_{\\text{out}}(t^n)$ and $T_{\\text{out}}(t^{n+1})$ for the Crank–Nicolson average source term).\n\nSurface temperature reporting:\n- The inner surface temperature $T_{\\text{surf,in}}(t)$ at the room-side boundary must be reported using the series-resistor relation between the last cell center and the room air:\n$$\nT_{\\text{surf,in}}(t) = \\frac{R_{\\text{cond}}\\,T_{\\text{room}}(t) + R_{\\text{conv}}\\,T_N(t)}{R_{\\text{cond}} + R_{\\text{conv}}},\n$$\nwhere $R_{\\text{cond}} = \\frac{\\Delta x_N}{2\\,k_N}$ and $R_{\\text{conv}} = \\frac{1}{h_{\\text{in}}}$.\n\nUnits and angle conventions:\n- All geometric lengths must be in meters.\n- Conductivities in $\\mathrm{W/(m\\cdot K)}$, densities in $\\mathrm{kg/m^3}$, heat capacities in $\\mathrm{J/(kg\\cdot K)}$, and convective coefficients in $\\mathrm{W/(m^2\\cdot K)}$.\n- Time must be in seconds.\n- Temperature must be in degrees Celsius for reporting.\n- Any angles in trigonometric functions must be expressed in radians.\n\nTest suite specification:\nImplement the program to run the following three test cases and produce the required outputs. In all cases, initialize the wall with uniform temperature $T(x,0) = T_0$ and use the provided outdoor and indoor conditions. For sinusoidal forcing, define $T_{\\text{out}}(t) = T_{\\text{mean}} + A \\,\\sin\\left( 2\\pi\\,t/P \\right)$, where $P$ is the period and the angle is in radians.\n\n- Test case $1$ (multilayer wall, moderate time step; happy path):\n  - Layers (from outside to inside), each split into the given number of control volumes with uniform $\\Delta x$ per layer:\n    - Brick: thickness $0.15$ $\\mathrm{m}$, $k = 0.7$ $\\mathrm{W/(m\\cdot K)}$, $\\rho = 1800$ $\\mathrm{kg/m^3}$, $c = 840$ $\\mathrm{J/(kg\\cdot K)}$, $30$ cells.\n    - Insulation: thickness $0.10$ $\\mathrm{m}$, $k = 0.035$ $\\mathrm{W/(m\\cdot K)}$, $\\rho = 30$ $\\mathrm{kg/m^3}$, $c = 1400$ $\\mathrm{J/(kg\\cdot K)}$, $20$ cells.\n    - Gypsum: thickness $0.013$ $\\mathrm{m}$, $k = 0.25$ $\\mathrm{W/(m\\cdot K)}$, $\\rho = 950$ $\\mathrm{kg/m^3}$, $c = 1090$ $\\mathrm{J/(kg\\cdot K)}$, $5$ cells.\n  - Boundary convection: $h_{\\text{out}} = 25$ $\\mathrm{W/(m^2\\cdot K)}$, $h_{\\text{in}} = 7$ $\\mathrm{W/(m^2\\cdot K)}$.\n  - Outdoor temperature: $T_{\\text{out}}(t) = 10 + 5\\,\\sin\\!\\left( 2\\pi\\,t/86400 \\right)$ $\\mathrm{^\\circ C}$.\n  - Indoor air: $T_{\\text{room}}(t) = 20$ $\\mathrm{^\\circ C}$.\n  - Initial temperature: $T_0 = 20$ $\\mathrm{^\\circ C}$.\n  - Time integration: time step $\\Delta t = 300$ $\\mathrm{s}$, final time $t_{\\text{end}} = 21600$ $\\mathrm{s}$.\n  - Required output for this case: inner surface temperature at $t_{\\text{end}}$, in degrees Celsius, rounded to three decimals.\n\n- Test case $2$ (stiff layer included; edge case):\n  - Layers (from outside to inside):\n    - Brick: thickness $0.15$ $\\mathrm{m}$, $k = 0.7$ $\\mathrm{W/(m\\cdot K)}$, $\\rho = 1800$ $\\mathrm{kg/m^3}$, $c = 840$ $\\mathrm{J/(kg\\cdot K)}$, $30$ cells.\n    - Insulation: thickness $0.10$ $\\mathrm{m}$, $k = 0.035$ $\\mathrm{W/(m\\cdot K)}$, $\\rho = 30$ $\\mathrm{kg/m^3}$, $c = 1400$ $\\mathrm{J/(kg\\cdot K)}$, $20$ cells.\n    - Aluminum foil: thickness $0.001$ $\\mathrm{m}$, $k = 220$ $\\mathrm{W/(m\\cdot K)}$, $\\rho = 2700$ $\\mathrm{kg/m^3}$, $c = 900$ $\\mathrm{J/(kg\\cdot K)}$, $2$ cells.\n    - Gypsum: thickness $0.013$ $\\mathrm{m}$, $k = 0.25$ $\\mathrm{W/(m\\cdot K)}$, $\\rho = 950$ $\\mathrm{kg/m^3}$, $c = 1090$ $\\mathrm{J/(kg\\cdot K)}$, $5$ cells.\n  - Boundary convection: $h_{\\text{out}} = 25$ $\\mathrm{W/(m^2\\cdot K)}$, $h_{\\text{in}} = 7$ $\\mathrm{W/(m^2\\cdot K)}$.\n  - Outdoor temperature: $T_{\\text{out}}(t) = 10 + 5\\,\\sin\\!\\left( 2\\pi\\,t/86400 \\right)$ $\\mathrm{^\\circ C}$.\n  - Indoor air: $T_{\\text{room}}(t) = 20$ $\\mathrm{^\\circ C}$.\n  - Initial temperature: $T_0 = 20$ $\\mathrm{^\\circ C}$.\n  - Time integration: time step $\\Delta t = 600$ $\\mathrm{s}$, final time $t_{\\text{end}} = 21600$ $\\mathrm{s}$.\n  - Required output for this case: inner surface temperature at $t_{\\text{end}}$, in degrees Celsius, rounded to three decimals.\n\n- Test case $3$ (accuracy and numerical damping assessment via reference solution; boundary condition emphasis):\n  - Single homogeneous layer (from outside to inside):\n    - Concrete: thickness $0.20$ $\\mathrm{m}$, $k = 1.4$ $\\mathrm{W/(m\\cdot K)}$, $\\rho = 2200$ $\\mathrm{kg/m^3}$, $c = 880$ $\\mathrm{J/(kg\\cdot K)}$, $40$ cells.\n  - Boundary convection: $h_{\\text{out}} = 30$ $\\mathrm{W/(m^2\\cdot K)}$, $h_{\\text{in}} = 10$ $\\mathrm{W/(m^2\\cdot K)}$.\n  - Outdoor temperature: $T_{\\text{out}}(t) = 0 + 10\\,\\sin\\!\\left( 2\\pi\\,t/43200 \\right)$ $\\mathrm{^\\circ C}$ (period $P = 43200$ $\\mathrm{s}$).\n  - Indoor air: $T_{\\text{room}}(t) = 0$ $\\mathrm{^\\circ C}$.\n  - Initial temperature: $T_0 = 0$ $\\mathrm{^\\circ C}$.\n  - Time integration: coarse time step $\\Delta t_{\\text{coarse}} = 2400$ $\\mathrm{s}$, fine reference time step $\\Delta t_{\\text{fine}} = 200$ $\\mathrm{s}$, final time $t_{\\text{end}} = 21600$ $\\mathrm{s}$.\n  - Required output for this case: the absolute difference, in degrees Celsius, between the inner surface temperature computed with the coarse time step and the inner surface temperature computed with the fine time step at $t_{\\text{end}}$, rounded to three decimals.\n\nProgram output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of test cases $1$, $2$, $3$. For test cases $1$ and $2$, the entry must be the final inner surface temperature in degrees Celsius; for test case $3$, the entry must be the absolute difference in degrees Celsius between coarse and fine results. Each entry must be rounded to three decimals. For example, an acceptable output format is $[x_1,x_2,x_3]$ where each $x_i$ is a float with three decimals.",
            "solution": "The problem requires the derivation and implementation of a numerical model for one-dimensional transient heat conduction through a multilayer wall. The model is to be based on a finite-volume spatial discretization and a Crank-Nicolson time integration scheme.\n\n### 1. Spatial Discretization: The Semi-discrete System\n\nThe foundation of the model is the principle of energy conservation applied to a series of discrete control volumes (CVs) that represent the wall. We discretize the wall of total thickness $L$ into $N$ control volumes. For each control volume $i$, centered at position $x_i$ with thickness $\\Delta x_i$, its thermal properties are assumed to be piecewise-constant: density $\\rho_i$, specific heat capacity $c_i$, and thermal conductivity $k_i$.\n\nThe one-dimensional heat equation in integral form for a control volume $i$ (of unit area perpendicular to the heat flow) is:\n$$\n\\frac{d}{dt} \\int_{x_{i-1/2}}^{x_{i+1/2}} \\rho c T(x,t) dx = q(x_{i-1/2},t) - q(x_{i+1/2},t)\n$$\nwhere $q$ is the heat flux. Assuming the temperature $T_i(t)$ is uniform within the CV, this simplifies to:\n$$\n(\\rho_i c_i \\Delta x_i) \\frac{dT_i}{dt} = q_{i-1/2} - q_{i+1/2}\n$$\nLet $C_i = \\rho_i c_i \\Delta x_i$ be the thermal capacitance per unit area of control volume $i$. The equation is $C_i \\frac{dT_i}{dt} = q_{i-1/2} - q_{i+1/2}$.\n\nThe heat fluxes at the interfaces are modeled using a thermal resistance analogy.\n\n**Internal Control Volume ($1 < i < N$):**\nFor an internal node $i$, the heat flux entering from the left (from node $i-1$) and exiting to the right (to node $i+1$) are given by the temperature difference divided by the thermal resistance between the cell centers. The problem specifies the interface conductance $G_{i-1/2}$ and $G_{i+1/2}$.\nThe flux from node $i-1$ to $i$ is $q_{i-1/2} = G_{i-1/2}(T_{i-1} - T_i)$.\nThe flux from node $i$ to $i+1$ is $q_{i+1/2} = G_{i+1/2}(T_i - T_{i+1})$.\nSubstituting these into the energy balance gives:\n$$\nC_i \\frac{dT_i}{dt} = G_{i-1/2}(T_{i-1} - T_i) - G_{i+1/2}(T_i - T_{i+1})\n$$\n$$\nC_i \\frac{dT_i}{dt} = G_{i-1/2} T_{i-1} - (G_{i-1/2} + G_{i+1/2}) T_i + G_{i+1/2} T_{i+1}\n$$\n\n**Exterior Boundary Control Volume ($i=1$):**\nFor the first node, the heat flux from the left is due to convection from the outdoor air at $T_{\\text{out}}(t)$. As given, $q_{\\text{left}} = \\frac{T_{\\text{out}}(t) - T_1}{R_{\\text{left}}}$, which we identify as $q_{1/2}$. The flux to the right is $q_{1+1/2} = G_{1+1/2}(T_1 - T_2)$.\nThe energy balance is:\n$$\nC_1 \\frac{dT_1}{dt} = \\frac{T_{\\text{out}}(t) - T_1}{R_{\\text{left}}} - G_{1+1/2}(T_1 - T_2)\n$$\n$$\nC_1 \\frac{dT_1}{dt} = -\\left(\\frac{1}{R_{\\text{left}}} + G_{1+1/2}\\right)T_1 + G_{1+1/2}T_2 + \\frac{T_{\\text{out}}(t)}{R_{\\text{left}}}\n$$\n\n**Interior Boundary Control Volume ($i=N$):**\nFor the last node, the flux from the left is $q_{N-1/2} = G_{N-1/2}(T_{N-1} - T_N)$. The flux to the right is to the indoor air at $T_{\\text{room}}(t)$. The problem states $q_{\\text{right}} = \\frac{T_{\\text{room}}(t) - T_N(t)}{R_{\\text{right}}}$. This is the heat flux entering the node from the room. The energy balance is $C_N \\frac{dT_N}{dt} = q_{N-1/2} + q_{\\text{right}}$.\n$$\nC_N \\frac{dT_N}{dt} = G_{N-1/2}(T_{N-1} - T_N) + \\frac{T_{\\text{room}}(t) - T_N}{R_{\\text{right}}}\n$$\n$$\nC_N \\frac{dT_N}{dt} = G_{N-1/2}T_{N-1} - \\left(G_{N-1/2} + \\frac{1}{R_{\\text{right}}}\\right)T_N + \\frac{T_{\\text{room}}(t)}{R_{\\text{right}}}\n$$\n\n**Matrix Form:**\nThis system of $N$ ordinary differential equations can be written in matrix form:\n$$\n\\mathbf{C} \\frac{d\\mathbf{T}}{dt} = \\mathbf{K}\\mathbf{T} + \\mathbf{f}(t)\n$$\nwhere:\n- $\\mathbf{T} = [T_1, T_2, \\dots, T_N]^T$ is the vector of cell temperatures.\n- $\\mathbf{C}$ is a diagonal matrix of thermal capacitances: $C_{ii} = C_i = \\rho_i c_i \\Delta x_i$.\n- $\\mathbf{K}$ is a symmetric, tridiagonal matrix of conductances:\n  - $K_{i,i} = -(G_{i-1/2} + G_{i+1/2})$ for $1 < i < N$\n  - $K_{1,1} = -(\\frac{1}{R_{\\text{left}}} + G_{1+1/2})$\n  - $K_{N,N} = -(G_{N-1/2} + \\frac{1}{R_{\\text{right}}})$\n  - $K_{i,i+1} = K_{i+1,i} = G_{i+1/2}$ for $1 \\le i < N$\n- $\\mathbf{f}(t)$ is the source vector from boundary conditions:\n  - $f_1(t) = T_{\\text{out}}(t) / R_{\\text{left}}$\n  - $f_i(t) = 0$ for $1 < i < N$\n  - $f_N(t) = T_{\\text{room}}(t) / R_{\\text{right}}$\n\n### 2. Temporal Discretization: The Crank-Nicolson Scheme\n\nTo solve this system of ODEs over time, we use the Crank-Nicolson method. This scheme is an implicit method that evaluates the right-hand side as an average of its values at the current time step, $t^n$, and the next time step, $t^{n+1} = t^n + \\Delta t$. The time derivative is approximated by a central difference at the midpoint $t^{n+1/2}$:\n$$\n\\mathbf{C} \\left( \\frac{\\mathbf{T}^{n+1} - \\mathbf{T}^n}{\\Delta t} \\right) = \\frac{1}{2} \\left[ (\\mathbf{K}\\mathbf{T}^n + \\mathbf{f}(t^n)) + (\\mathbf{K}\\mathbf{T}^{n+1} + \\mathbf{f}(t^{n+1})) \\right]\n$$\nOur goal is to solve for the unknown temperature vector $\\mathbf{T}^{n+1}$. We rearrange the equation by moving all terms involving $\\mathbf{T}^{n+1}$ to the left-hand side (LHS) and all known terms (involving $\\mathbf{T}^n$) to the right-hand side (RHS).\n$$\n\\mathbf{C}(\\mathbf{T}^{n+1} - \\mathbf{T}^n) = \\frac{\\Delta t}{2} (\\mathbf{K}\\mathbf{T}^n + \\mathbf{K}\\mathbf{T}^{n+1} + \\mathbf{f}^n + \\mathbf{f}^{n+1})\n$$\n$$\n\\mathbf{C}\\mathbf{T}^{n+1} - \\frac{\\Delta t}{2}\\mathbf{K}\\mathbf{T}^{n+1} = \\mathbf{C}\\mathbf{T}^n + \\frac{\\Delta t}{2}\\mathbf{K}\\mathbf{T}^n + \\frac{\\Delta t}{2}(\\mathbf{f}^n + \\mathbf{f}^{n+1})\n$$\nFactoring out $\\mathbf{T}^{n+1}$ on the LHS and $\\mathbf{T}^n$ on the RHS yields the final linear system to be solved at each time step:\n$$\n\\left( \\mathbf{C} - \\frac{\\Delta t}{2}\\mathbf{K} \\right) \\mathbf{T}^{n+1} = \\left( \\mathbf{C} + \\frac{\\Delta t}{2}\\mathbf{K} \\right) \\mathbf{T}^n + \\frac{\\Delta t}{2} (\\mathbf{f}^n + \\mathbf{f}^{n+1})\n$$\nThis is a linear system of the form $\\mathbf{A} \\mathbf{x} = \\mathbf{b}$, where:\n- $\\mathbf{A} = \\mathbf{C} - \\frac{\\Delta t}{2}\\mathbf{K}$ is the LHS matrix. Since $\\mathbf{C}$ is diagonal and $\\mathbf{K}$ is tridiagonal, $\\mathbf{A}$ is also tridiagonal.\n- $\\mathbf{x} = \\mathbf{T}^{n+1}$ is the vector of unknown temperatures at the next time step.\n- $\\mathbf{b}$ is the RHS vector, constructed from known quantities.\n\n### 3. Numerical Characteristics and Implementation\n\nThe Crank-Nicolson scheme is chosen for its desirable numerical properties. It is second-order accurate in time, meaning the temporal discretization error decreases with $(\\Delta t)^2$, which is an improvement over first-order schemes like explicit or implicit Euler. Crucially, it is A-stable, meaning it is unconditionally stable for the linear heat equation, regardless of the size of the time step $\\Delta t$ relative to the spatial grid size $\\Delta x_i$. This is particularly important for problems with \"stiff\" spatial features, such as the thin, highly conductive aluminum layer in Test Case 2, which would impose prohibitively small time steps on a conditionally stable explicit method.\n\nHowever, while stable, the method is not perfectly L-stable. For large time steps, high-frequency components of the solution (often arising from sharp initial conditions or boundary forcing) are not strongly damped, which can lead to persistent, non-physical oscillations. The accuracy, while formally second-order, still depends on $\\Delta t$ being small enough to resolve the physical dynamics. Test Case 3 is designed to probe this, comparing a coarse time step against a fine one to quantify the temporal error.\n\nThe implementation algorithm is as follows:\n1.  **Setup:** Given the layered wall structure, construct the property arrays $(\\rho_i, c_i, k_i, \\Delta x_i)$ for all $N$ control volumes.\n2.  **Matrix Assembly:**\n    -   Calculate the interface conductances $G_{i+1/2}$ and boundary resistances $R_{\\text{left}}, R_{\\text{right}}$.\n    -   Construct the diagonals of the capacitance matrix $\\mathbf{C}$ and conductance matrix $\\mathbf{K}$.\n    -   Form the three diagonals of the LHS tridiagonal matrix $\\mathbf{A} = \\mathbf{C} - \\frac{\\Delta t}{2}\\mathbf{K}$.\n    -   Form the three diagonals of the RHS matrix multiplier $\\mathbf{B} = \\mathbf{C} + \\frac{\\Delta t}{2}\\mathbf{K}$.\n3.  **Time Integration:**\n    -   Initialize the temperature vector $\\mathbf{T}$ with the initial condition $T_0$.\n    -   Iterate from $t=0$ to $t_{\\text{end}}$:\n        a. Calculate the source vectors $\\mathbf{f}^n$ and $\\mathbf{f}^{n+1}$ using $T_{\\text{out}}(t^n)$ and $T_{\\text{out}}(t^{n+1})$.\n        b. Compute the RHS vector $\\mathbf{b} = \\mathbf{B} \\mathbf{T}^n + \\frac{\\Delta t}{2}(\\mathbf{f}^n + \\mathbf{f}^{n+1})$. The matrix-vector product $\\mathbf{B} \\mathbf{T}^n$ is performed efficiently using the stored diagonals of $\\mathbf{B}$.\n        c. Solve the tridiagonal linear system $\\mathbf{A} \\mathbf{T}^{n+1} = \\mathbf{b}$ for $\\mathbf{T}^{n+1}$. This is efficiently done using the Thomas algorithm (or a library equivalent like `scipy.linalg.solve_banded`).\n        d. Update $\\mathbf{T}^n \\leftarrow \\mathbf{T}^{n+1}$.\n4.  **Final Calculation:** After the final time step, use the last nodal temperature $T_N(t_{\\text{end}})$ to compute the inner surface temperature $T_{\\text{surf,in}}$ using the provided series-resistor formula.\n\nThis structured, principle-based approach ensures a correct and robust solution.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import solve_banded\n\ndef solve():\n    \"\"\"\n    Main function to define test cases and run the thermal simulation.\n    \"\"\"\n    \n    # Test Case 1: Multilayer wall, moderate time step\n    case1_params = {\n        \"layers\": [\n            {\"thick\": 0.15, \"k\": 0.7, \"rho\": 1800, \"c\": 840, \"cells\": 30},  # Brick\n            {\"thick\": 0.10, \"k\": 0.035, \"rho\": 30, \"c\": 1400, \"cells\": 20}, # Insulation\n            {\"thick\": 0.013, \"k\": 0.25, \"rho\": 950, \"c\": 1090, \"cells\": 5}   # Gypsum\n        ],\n        \"h_out\": 25.0,\n        \"h_in\": 7.0,\n        \"T_out_func\": lambda t: 10.0 + 5.0 * np.sin(2.0 * np.pi * t / 86400.0),\n        \"T_room\": 20.0,\n        \"T0\": 20.0,\n        \"dt\": 300.0,\n        \"t_end\": 21600.0\n    }\n\n    # Test Case 2: Stiff layer included\n    case2_params = {\n        \"layers\": [\n            {\"thick\": 0.15, \"k\": 0.7, \"rho\": 1800, \"c\": 840, \"cells\": 30},   # Brick\n            {\"thick\": 0.10, \"k\": 0.035, \"rho\": 30, \"c\": 1400, \"cells\": 20},  # Insulation\n            {\"thick\": 0.001, \"k\": 220, \"rho\": 2700, \"c\": 900, \"cells\": 2}, # Aluminum Foil\n            {\"thick\": 0.013, \"k\": 0.25, \"rho\": 950, \"c\": 1090, \"cells\": 5}    # Gypsum\n        ],\n        \"h_out\": 25.0,\n        \"h_in\": 7.0,\n        \"T_out_func\": lambda t: 10.0 + 5.0 * np.sin(2.0 * np.pi * t / 86400.0),\n        \"T_room\": 20.0,\n        \"T0\": 20.0,\n        \"dt\": 600.0,\n        \"t_end\": 21600.0\n    }\n\n    # Test Case 3: Accuracy assessment\n    case3_params = {\n        \"layers\": [\n            {\"thick\": 0.20, \"k\": 1.4, \"rho\": 2200, \"c\": 880, \"cells\": 40} # Concrete\n        ],\n        \"h_out\": 30.0,\n        \"h_in\": 10.0,\n        \"T_out_func\": lambda t: 0.0 + 10.0 * np.sin(2.0 * np.pi * t / 43200.0),\n        \"T_room\": 0.0,\n        \"T0\": 0.0,\n        \"dt_coarse\": 2400.0,\n        \"dt_fine\": 200.0,\n        \"t_end\": 21600.0\n    }\n\n    results = []\n\n    # Run Case 1\n    result1 = run_simulation(case1_params)\n    results.append(round(result1, 3))\n\n    # Run Case 2\n    result2 = run_simulation(case2_params)\n    results.append(round(result2, 3))\n    \n    # Run Case 3\n    params_coarse = case3_params.copy()\n    params_coarse[\"dt\"] = case3_params[\"dt_coarse\"]\n    result_coarse = run_simulation(params_coarse)\n\n    params_fine = case3_params.copy()\n    params_fine[\"dt\"] = case3_params[\"dt_fine\"]\n    result_fine = run_simulation(params_fine)\n    \n    result3 = abs(result_coarse - result_fine)\n    results.append(round(result3, 3))\n    \n    # Print final output in the required format\n    print(f\"[{results[0]:.3f},{results[1]:.3f},{results[2]:.3f}]\")\n\n\ndef run_simulation(params):\n    \"\"\"\n    Executes the Crank-Nicolson simulation for a given set of parameters.\n    \"\"\"\n    layers = params[\"layers\"]\n    h_out, h_in = params[\"h_out\"], params[\"h_in\"]\n    T_out_func, T_room = params[\"T_out_func\"], params[\"T_room\"]\n    T0, dt, t_end = params[\"T0\"], params[\"dt\"], params[\"t_end\"]\n\n    # 1. Spatial Discretization\n    N = sum(layer[\"cells\"] for layer in layers)\n    dx = np.zeros(N)\n    k = np.zeros(N)\n    rho_c = np.zeros(N)\n\n    cell_idx = 0\n    for layer in layers:\n        layer_dx = layer[\"thick\"] / layer[\"cells\"]\n        for i in range(layer[\"cells\"]):\n            dx[cell_idx] = layer_dx\n            k[cell_idx] = layer[\"k\"]\n            rho_c[cell_idx] = layer[\"rho\"] * layer[\"c\"]\n            cell_idx += 1\n\n    # 2. Matrix Assembly\n    # Thermal Capacitance Vector (Diagonal of C matrix)\n    C_diag = rho_c * dx\n\n    # Conductance Matrix K (as three diagonals)\n    K_main = np.zeros(N)\n    K_upper = np.zeros(N - 1)\n    K_lower = np.zeros(N - 1)\n\n    # Interface Conductances G\n    G = np.zeros(N - 1)\n    for i in range(N - 1):\n        R1 = dx[i] / (2 * k[i])\n        R2 = dx[i+1] / (2 * k[i+1])\n        G[i] = 1.0 / (R1 + R2)\n        \n    # Fill in diagonals of K\n    # Internal nodes\n    K_main[1:-1] = -(G[:-1] + G[1:])\n    K_upper[:] = G\n    K_lower[:] = G\n\n    # Boundary nodes\n    R_left = dx[0] / (2 * k[0]) + 1.0 / h_out\n    R_right = dx[N-1] / (2 * k[N-1]) + 1.0 / h_in\n    K_main[0] = -(1.0 / R_left + G[0])\n    K_main[N-1] = -(G[N-2] + 1.0 / R_right)\n\n    # Crank-Nicolson Matrices\n    # LHS Matrix: A = C - dt/2 * K\n    A_banded = np.zeros((3, N))\n    A_banded[0, 1:] = -0.5 * dt * K_upper\n    A_banded[1, :] = C_diag - 0.5 * dt * K_main\n    A_banded[2, :-1] = -0.5 * dt * K_lower\n\n    # RHS Matrix: B = C + dt/2 * K\n    B_main = C_diag + 0.5 * dt * K_main\n    B_upper = 0.5 * dt * K_upper\n    B_lower = 0.5 * dt * K_lower\n\n    # 3. Time Integration\n    T = np.full(N, T0)\n    num_steps = int(round(t_end / dt))\n    times = np.linspace(0, t_end, num_steps + 1)\n\n    for i in range(num_steps):\n        t_n, t_n1 = times[i], times[i+1]\n\n        # Source vectors f\n        f_n = np.zeros(N)\n        f_n[0] = T_out_func(t_n) / R_left\n        f_n[-1] = T_room / R_right\n        \n        f_n1 = np.zeros(N)\n        f_n1[0] = T_out_func(t_n1) / R_left\n        f_n1[-1] = T_room / R_right\n\n        # RHS vector: b = B*T_n + dt/2 * (f_n + f_n1)\n        # B*T_n product (tridiagonal)\n        b_mat_prod = np.zeros(N)\n        b_mat_prod[0] = B_main[0] * T[0] + B_upper[0] * T[1]\n        b_mat_prod[1:-1] = B_lower[:-1] * T[:-2] + B_main[1:-1] * T[1:-1] + B_upper[1:] * T[2:]\n        b_mat_prod[-1] = B_lower[-1] * T[-2] + B_main[-1] * T[-1]\n        \n        b = b_mat_prod + 0.5 * dt * (f_n + f_n1)\n\n        # Solve linear system A * T_n1 = b\n        T = solve_banded((1, 1), A_banded, b)\n\n    # 4. Final Calculation\n    T_N = T[-1]\n    R_cond_N = dx[N-1] / (2 * k[N-1])\n    R_conv_in = 1.0 / h_in\n    T_surf_in = (R_cond_N * T_room + R_conv_in * T_N) / (R_cond_N + R_conv_in)\n    \n    return T_surf_in\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}