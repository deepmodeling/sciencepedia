{
    "hands_on_practices": [
        {
            "introduction": "本实践是构建储能运行模型的基础。我们将从基本物理原理出发，推导储能系统的荷电状态（State of Charge, SoC）动态方程，并学习如何构建混合整数线性规划（Mixed-Integer Linear Programming, MILP）模型来求解最优调度策略。通过这个练习 ()，你将掌握在确定性环境下对储能进行精确建模和优化的核心技能。",
            "id": "4120232",
            "problem": "考虑一个单母线微电网，其中包含一台常规发电机、一个电化学储能设备以及外源性可变可再生能源。时间被离散为 $T$ 个时段，步长均匀，为 $\\Delta t = 1$ 小时。储能设备具有独立的充电和放电效率。目标是建立一个调度问题，在满足能量守恒、荷电状态 (SoC) 动态、运行限制以及防止同时充放电的排他性约束的条件下，最小化常规发电量。荷电状态 (State of Charge, SoC) 和混合整数线性规划 (Mixed-Integer Linear Programming, MILP) 在首次出现时必须写出全称。\n\n从能量守恒以及充电和放电效率的定义出发，推导在独立的充电和放电功率决策下，单个时间步长的线性SoC演化过程。然后，建立一个混合整数线性规划问题，其决策变量包括常规发电量、充电功率、放电功率、SoC和二进制排他性指标，通过线性约束强制在任何时段内充电和放电不能同时发生。\n\n最后，对于以下特定实例，计算在整个时间范围内的最小总常规发电能量：\n- 时段数 $T = 3$。\n- 需求曲线 $d_{1} = 10$，$d_{2} = 10$，$d_{3} = 10$（在 $1$ 小时区间内，单位均为 $\\mathrm{kWh}$）。\n- 可再生能源曲线 $r_{1} = 8$，$r_{2} = 12$，$r_{3} = 5$（在 $1$ 小时区间内，单位均为 $\\mathrm{kWh}$）。\n- 储能参数：能量容量 $E_{\\max} = 5$（单位 $\\mathrm{kWh}$），最大充电功率 $P_{\\max}^{c} = 5$（单位 $\\mathrm{kW}$），最大放电功率 $P_{\\max}^{d} = 5$（单位 $\\mathrm{kW}$）。\n- 效率：充电效率 $\\eta_{c} = 0.9$，放电效率 $\\eta_{d} = 0.9$。\n- 初始SoC $s_{0} = 0$（单位 $\\mathrm{kWh}$）以及终端SoC约束 $s_{T} = s_{0}$。\n- 常规发电机没有上限，且输出为非负值。\n- 使用二进制变量，通过大$M$约束强制实现 $p_{t}^{c} \\cdot p_{t}^{d} = 0$，其中 $M$ 从已知边界中选取。\n\n完整地建立问题模型，展示所有变量和约束，然后计算 $\\sum_{t=1}^{T} g_{t}$ 的最优值，其中 $g_{t}$ 是时段 $t$ 的常规发电量。最终能量以 $\\mathrm{kWh}$ 为单位表示。无需四舍五入；提供精确值。",
            "solution": "该问题被评估为有效的，因为它代表了一个适定的、有科学依据的、能源系统工程领域的标准最优调度问题。所有必要的数据和约束都已提供，不存在内部矛盾或模糊之处。\n\n按照要求，解答分为三个部分：首先，推导荷电状态 (SoC) 演化方程；其次，建立完整的混合整数线性规划 (MILP) 问题模型；第三，求解给定的具体实例。\n\n我们首先定义主要变量和参数。时间被离散为时段 $t \\in \\{1, 2, \\dots, T\\}$。每个时段的持续时间为 $\\Delta t = 1$ 小时。\n令 $s_t$ 为时段 $t$ 结束时存储的能量（荷电状态），单位为 kWh。\n令 $p_t^c$ 为时段 $t$ 内的充电功率（单位 kW），$p_t^d$ 为放电功率（单位 kW）。假设它们在整个时段内是恒定的。\n充电效率为 $\\eta_c$，放电效率为 $\\eta_d$。\n\n**第一部分：荷电状态 (SoC) 演化方程的推导**\n\n设备中存储能量在一段时间内的变化是能量流入和流出的净效应。\n当设备以功率 $p_t^c$ 充电时，存储能量的增加速率由充电效率 $\\eta_c$ 决定。实际存储的功率为 $\\eta_c p_t^c$。\n当设备放电时，它向电网注入功率 $p_t^d$。为了提供这个功率，由于损耗，必须从储能中抽取更多的能量。存储能量的减少速率为 $\\frac{p_t^d}{\\eta_d}$。\n\n存储能量 $s(t)$ 的动态演化可以用以下微分方程描述：\n$$\n\\frac{ds(t)}{dt} = \\eta_c p^c(t) - \\frac{p^d(t)}{\\eta_d}\n$$\n其中 $p^c(t)$ 和 $p^d(t)$ 是瞬时充电和放电功率。\n\n对于时间步长为 $\\Delta t$ 的离散时间模型，我们将此方程在时段 $t$（从时间 $(t-1)\\Delta t$到 $t\\Delta t$）上积分。假设功率水平 $p_t^c$ 和 $p_t^d$ 在整个时段 $t$ 内是恒定的：\n$$\n\\int_{t-1}^{t} \\frac{ds(t')}{dt'} dt' = \\int_{(t-1)\\Delta t}^{t\\Delta t} \\left( \\eta_c p_t^c - \\frac{p_t^d}{\\eta_d} \\right) dt'\n$$\n左侧计算结果为 $s_t - s_{t-1}$。右侧在功率恒定的情况下变为：\n$$\ns_t - s_{t-1} = \\left( \\eta_c p_t^c - \\frac{p_t^d}{\\eta_d} \\right) \\Delta t\n$$\n这是一般的线性SoC演化方程。鉴于问题指定 $\\Delta t = 1$ 小时，方程简化为：\n$$\ns_t = s_{t-1} + \\eta_c p_t^c - \\frac{p_t^d}{\\eta_d}\n$$\n在这种简化形式下，为了与问题中以 kWh 为单位给出的数据保持一致，$p_t^c$ 和 $p_t^d$ 在数值上等同于在 1 小时内充电和放电的能量（单位 kWh）。此后，变量 $g_t, p_t^c, p_t^d$ 将代表时段 $t$ 的能量值（单位 kWh）。\n\n**第二部分：混合整数线性规划 (MILP) 模型建立**\n\n我们现在建立完整的优化问题模型。一个混合整数线性规划 (MILP) 问题包含一个要最小化或最大化的目标函数，受一组线性约束的限制，其中一些决策变量被限制为整数。\n\n**决策变量：**\n对于每个时段 $t \\in \\{1, \\dots, T\\}$：\n- $g_t$: 常规发电能量 [kWh]。\n- $p_t^c$: 用于为储能充电的能量 [kWh]。\n- $p_t^d$: 通过储能放电提供的能量 [kWh]。\n- $s_t$: 时段结束时的荷电状态（储能中的能量）[kWh]。\n- $u_t$: 表示充电状态的二进制变量，$u_t \\in \\{0, 1\\}$。我们定义如果设备在充电，则 $u_t = 1$，否则 $u_t = 0$。\n\n**目标函数：**\n目标是在整个时间范围 $T$ 内最小化总常规发电能量。\n$$\n\\text{最小化} \\quad \\sum_{t=1}^{T} g_t\n$$\n\n**约束条件：**\n对于所有时段 $t \\in \\{1, \\dots, T\\}$：\n1.  **能量守恒（平衡）：** 总能量供给必须等于总能量消耗。令 $d_t$ 为时段 $t$ 的需求，$r_t$ 为可再生能源发电量。\n    $$\n    g_t + r_t + p_t^d = d_t + p_t^c\n    $$\n    通常将其写成净负荷 $l_t = d_t - r_t$ 在一边的形式：\n    $$\n    g_t + p_t^d - p_t^c = l_t\n    $$\n\n2.  **荷电状态 (SoC) 演化：**\n    $$\n    s_t = s_{t-1} + \\eta_c p_t^c - \\frac{p_t^d}{\\eta_d}\n    $$\n    其中 $s_0$ 是给定的初始SoC。\n\n3.  **储能运行限制：**\n    - SoC 必须在储能能量容量 $E_{\\max}$ 范围内：\n      $$\n      0 \\le s_t \\le E_{\\max}\n      $$\n    - 充电和放电必须在功率限制内。由于 $\\Delta t=1$，能量限制在数值上等于功率限制 $P_{\\max}^c$ 和 $P_{\\max}^d$：\n      $$\n      0 \\le p_t^c \\le P_{\\max}^c\n      $$\n      $$\n      0 \\le p_t^d \\le P_{\\max}^d\n      $$\n\n4.  **发电限制：**\n    - 常规发电机的输出不能为负：\n      $$\n      g_t \\ge 0\n      $$\n\n5.  **充/放电排他性：** 约束 $p_t^c \\cdot p_t^d = 0$ 是非线性的。它通过使用二进制变量 $u_t$ 和大M约束进行线性化。常数 $M$ 应该是一个足够大的数，理想情况下是它所乘变量的一个紧上界。在这里，我们可以使用最大功率额定值。\n    $$\n    p_t^c \\le u_t P_{\\max}^c\n    $$\n    $$\n    p_t^d \\le (1-u_t) P_{\\max}^d\n    $$\n    如果 $u_t=1$（充电），第二个约束强制 $p_t^d \\le 0$，结合 $p_t^d \\ge 0$ 可推断出 $p_t^d = 0$。如果 $u_t=0$（不充电），第一个约束强制 $p_t^c \\le 0$，可推断出 $p_t^c=0$。\n\n6.  **终端条件：** 最终的 SoC 被约束为等于初始 SoC。\n    $$\n    s_T = s_0\n    $$\n\n**第三部分：具体实例求解**\n\n我们现在对给定的参数求解该问题：\n- $T = 3$。\n- 需求: $d_1 = 10, d_2 = 10, d_3 = 10$ [kWh]。\n- 可再生能源: $r_1 = 8, r_2 = 12, r_3 = 5$ [kWh]。\n- 净负荷 $l_t = d_t - r_t$: $l_1 = 2$, $l_2 = -2$, $l_3 = 5$ [kWh]。\n- 储能: $E_{\\max} = 5$ kWh, $P_{\\max}^c = 5$ kW, $P_{\\max}^d = 5$ kW。因此能量限制为 $5$ kWh。\n- 效率: $\\eta_c = 0.9$, $\\eta_d = 0.9$。\n- SoC: $s_0 = 0$ kWh, $s_3 = s_0 = 0$ kWh。\n\n目标是最小化 $G = g_1 + g_2 + g_3$。\n条件 $s_3 = s_0 = 0$ 意味着储能经历了一个完整的循环。对 $t=1,2,3$ 的 SoC 演化方程求和：\n$s_3 - s_0 = \\sum_{t=1}^3 \\left( \\eta_c p_t^c - \\frac{p_t^d}{\\eta_d} \\right)$。\n$0 = \\eta_c \\sum p_t^c - \\frac{1}{\\eta_d} \\sum p_t^d \\implies \\sum p_t^d = \\eta_c \\eta_d \\sum p_t^c = 0.81 \\sum p_t^c$。\n\n总发电量 $G$ 可以与总净负荷和储能损耗联系起来：\n$G = \\sum g_t = \\sum (l_t - p_t^d + p_t^c) = \\sum l_t + \\sum p_t^c - \\sum p_t^d$。\n$G = (2 - 2 + 5) + \\sum p_t^c - 0.81 \\sum p_t^c = 5 + 0.19 \\sum p_t^c$。\n为了最小化 $G$，我们必须最小化充入储能的总能量 $\\sum p_t^c$。\n\n让我们按时间顺序分析问题，以找到所需的最小充电量：\n- **时段 1 ($t=1$):** 净负荷 $l_1 = 2$ kWh。\n能量平衡为 $g_1 + p_1^d - p_1^c = 2$。\n初始SoC为 $s_0=0$，因此无法放电：$p_1^d=0$。\n平衡方程变为 $g_1 - p_1^c = 2$，或 $g_1 = 2 + p_1^c$。为了最小化发电量，我们应避免充电。在负荷缺额时段充电只会增加即时所需的发电量。因此，最优选择是 $p_1^c=0$。\n这得到 $g_1=2$ kWh, $p_1^d=0$。\nSoC保持不变：$s_1 = s_0 + 0 - 0 = 0$ kWh。\n\n- **时段 2 ($t=2$):** 净负荷 $l_2 = -2$ kWh（有 $2$ kWh 的盈余）。\n能量平衡为 $g_2 + p_2^d - p_2^c = -2$。\n由于 $g_2 \\ge 0$，我们必须有 $p_2^c - p_2^d \\ge 2$。由于排他性，其中一项必须为零。如果 $p_2^c=0$，那么 $-p_2^d \\ge 2$，这是不可能的（因为 $p_2^d \\ge 0$）。因此，必须有 $p_2^d=0$ 并且 $p_2^c \\ge 2$。\n为了最小化总充电量 $\\sum p_t^c$，我们应该为 $p_2^c$ 选择可能的最小值，即 $p_2^c=2$ kWh。这个选择也使我们能够设置 $g_2=0$，这是最优的。\n当 $p_2^c=2$ kWh 且 $p_2^d=0$ 时，我们有 $g_2=0$。\nSoC 更新为：$s_2 = s_1 + \\eta_c p_2^c - p_2^d/\\eta_d = 0 + 0.9 \\times 2 - 0 = 1.8$ kWh。这在容量 $E_{\\max}=5$ kWh 范围内。\n\n- **时段 3 ($t=3$):** 净负荷 $l_3 = 5$ kWh。\n能量平衡为 $g_3 + p_3^d - p_3^c = 5$。\n为了最小化发电量，我们应该通过放电来使用存储的能量。因此，$p_3^c = 0$。\n平衡方程变为 $g_3 = 5 - p_3^d$。我们必须最大化 $p_3^d$。\n最大放电量受两个因素限制：\n1. 功率限制: $p_3^d \\le P_{\\max}^d = 5$ kWh。\n2. 可用能量: 从储能中提取的能量是 $p_3^d/\\eta_d$。这不能超过可用的SoC，即 $s_2$。\n   $p_3^d/\\eta_d \\le s_2 \\implies p_3^d/0.9 \\le 1.8 \\implies p_3^d \\le 1.8 \\times 0.9 = 1.62$ kWh。\n可用能量是限制因素。最大可能放电量为 $p_3^d = 1.62$ kWh。\n这得出 发电量 $g_3 = 5 - 1.62 = 3.38$ kWh。\n最终的SoC为 $s_3 = s_2 - p_3^d/\\eta_d = 1.8 - 1.62/0.9 = 1.8 - 1.8 = 0$ kWh。这满足了终端条件 $s_3=s_0=0$。\n\n该推理表明，任何其他策略（例如，在时段1充电，或在时段2充电超过盈余量）都将导致更大的 $\\sum p_t^c$ 值，从而导致更大的总发电量。$\\sum p_t^c$ 的最小可能值为 $2$ kWh。\n\n总常规发电量为：\n$$\n\\sum_{t=1}^{3} g_t = g_1 + g_2 + g_3 = 2 + 0 + 3.38 = 5.38 \\text{ kWh}\n$$\n或者，使用推导出的公式：\n$$\n\\sum g_t = 5 + 0.19 \\sum p_t^c = 5 + 0.19 \\times 2 = 5 + 0.38 = 5.38 \\text{ kWh}\n$$\n结果是一致的。",
            "answer": "$$\n\\boxed{5.38}\n$$"
        },
        {
            "introduction": "在掌握了确定性模型之后，我们面临一个关键的现实挑战：参数不确定性。本练习 () 探讨当效率参数并非精确值而是在一个区间内波动时，如何保证系统性能。通过求解一个两阶段鲁棒优化问题，你将推导出一个“最坏情况”下的往返效率保守表示，这是确保系统规划和运行可靠性的关键概念。",
            "id": "4120249",
            "problem": "考虑一个储能设备的单周期模型，该模型在两个决策时期内运行，包含一次充电行为和一次紧随其后的放电行为。设充电状态 (SoC) 用 $s$ 表示，$s_0$ 为充电前的初始 SoC，$s_1$ 为充电后的 SoC，$s_2$ 为放电后的 SoC。设 $u_c \\geq 0$ 表示从电网输入到设备的充电能量，设 $u_d \\geq 0$ 表示从设备输出到电网的放电能量。假设自放电为零，并且除了充放电效率损耗外，没有其他外生损耗。根据热力学第一定律，能量是守恒的，充放电效率定义如下：\n$$\ns_1 \\;=\\; s_0 \\;+\\; \\eta_c\\,u_c, \\qquad s_2 \\;=\\; s_1 \\;-\\; \\frac{u_d}{\\eta_d},\n$$\n其中 $\\eta_c \\in (0,1]$ 是充电效率，$\\eta_d \\in (0,1]$ 是放电效率。设在放电时期向电网输送的能量需求为 $E \\gt 0$。我们采用鲁棒优化的视角，其中效率是不确定的，但有界于紧集内：\n$$\n\\eta_c \\in \\mathcal{U}_c, \\qquad \\eta_d \\in \\mathcal{U}_d,\n$$\n其中 $\\mathcal{U}_c = [\\hat{\\eta}_c - \\delta_c,\\, \\hat{\\eta}_c + \\delta_c]$ 且 $\\mathcal{U}_d = [\\hat{\\eta}_d - \\delta_d,\\, \\hat{\\eta}_d + \\delta_d]$，并且 $0 \\lt \\hat{\\eta}_c - \\delta_c \\leq \\hat{\\eta}_c + \\delta_c \\leq 1$ 以及 $0 \\lt \\hat{\\eta}_d - \\delta_d \\leq \\hat{\\eta}_d + \\delta_d \\leq 1$。假设 $s_0=0$ 并施加放电后循环闭合条件 $s_2 \\geq 0$，允许终端 SoC 为非负值。决策分两个阶段进行：第一阶段（当下）决策选择 $u_c$，第二阶段（追索）决策在 $(\\eta_c,\\eta_d)$ 的值实现后选择 $u_d$，并遵循上述物理约束。\n\n请建立两阶段鲁棒优化问题的公式，该问题旨在最小化第一阶段的能量输入 $u_c$，同时保证对于所有 $(\\eta_c,\\eta_d) \\in \\mathcal{U}_c \\times \\mathcal{U}_d$，都存在一个可行的追索决策 $u_d$，该决策既满足 $u_d \\geq E$，又遵守能量守恒和终端 SoC 的非负性。从基本定义和热力学第一定律出发，推导由循环闭合和保证的输送能量需求所隐含的最坏情况追索调度规则 $u_d^{\\star}(\\eta_c,\\eta_d)$，并用它来获得单周期往返效率的隐含保守表示，其定义如下：\n$$\n\\eta_{RT} \\;=\\; \\frac{\\text{delivered energy}}{\\text{input charging energy}} \\;=\\; \\frac{u_d}{u_c}.\n$$\n\n您的最终答案必须是保守往返效率 $\\eta_{RT}$ 的一个单一闭式解析表达式，用 $\\hat{\\eta}_c$、$\\hat{\\eta}_d$、$\\delta_c$ 和 $\\delta_d$ 表示。无需进行数值计算。将最终的保守往返效率表示为一个无量纲量。不要包含任何单位符号。",
            "solution": "该问题要求在两阶段鲁棒优化框架内，推导储能设备往返效率 $\\eta_{RT}$ 的一个保守表示。我们首先正式陈述问题，然后进行逐步推导。\n\n问题在于最小化第一阶段（当下）的能量输入决策 $u_c$，同时确保对于不确定效率 $(\\eta_c, \\eta_d)$ 在其各自不确定性集合内的任何实现，都存在一个可行的第二阶段（追索）能量调度 $u_d$。一个可行的追索行动必须同时满足输送能量需求和系统的物理约束。\n\n这个两阶段鲁棒优化问题可以形式化为：\n$$\n\\min_{u_c \\geq 0} u_c\n$$\n约束条件为：\n$$\n\\forall (\\eta_c, \\eta_d) \\in \\mathcal{U}_c \\times \\mathcal{U}_d, \\quad \\exists u_d \\text{ such that }\n\\begin{cases}\nu_d \\geq E \\\\\nu_d \\geq 0 \\\\\ns_2 \\geq 0\n\\end{cases}\n$$\n\n放电后的充电状态 $s_2$ 由系统动力学决定。初始充电状态为 $s_0=0$ 时，充电后的状态为 $s_1 = s_0 + \\eta_c u_c = \\eta_c u_c$。放电后的状态为 $s_2 = s_1 - \\frac{u_d}{\\eta_d} = \\eta_c u_c - \\frac{u_d}{\\eta_d}$。\n\n因此，约束条件 $s_2 \\geq 0$ 转化为 $\\eta_c u_c - \\frac{u_d}{\\eta_d} \\geq 0$。整理该不等式可得到可调度能量 $u_d$ 的一个上界：\n$$\nu_d \\leq \\eta_c \\eta_d u_c\n$$\n\n对于给定的第一阶段决策 $u_c$ 和 $(\\eta_c, \\eta_d)$ 的一个实现，要存在一个可行的追索行动 $u_d$，就要求至少存在一个 $u_d$ 的值，既满足输送要求 $u_d \\geq E$，又满足物理限制 $u_d \\leq \\eta_c \\eta_d u_c$。换句话说，$u_d$ 的可行值区间 $[E, \\eta_c \\eta_d u_c]$ 必须非空。这当且仅当其下界小于或等于其上界时成立：\n$$\nE \\leq \\eta_c \\eta_d u_c\n$$\n这个条件必须鲁棒地成立，即对于不确定性集合 $\\mathcal{U}_c \\times \\mathcal{U}_d$ 中效率 $(\\eta_c, \\eta_d)$ 的所有可能实现都成立。因此，第一阶段决策 $u_c$ 必须满足：\n$$\nE \\leq \\min_{(\\eta_c, \\eta_d) \\in \\mathcal{U}_c \\times \\mathcal{U}_d} (\\eta_c \\eta_d u_c)\n$$\n由于 $u_c$ 是一个相对于不确定性实现的非负常数，我们可以将其从最小化运算中提出来：\n$$\nE \\leq u_c \\left( \\min_{(\\eta_c, \\eta_d) \\in \\mathcal{U}_c \\times \\mathcal{U}_d} (\\eta_c \\eta_d) \\right)\n$$\n假设 $u_c > 0$ (因为 $E>0$)，我们可以将其重写为 $u_c$ 的一个下界：\n$$\nu_c \\geq \\frac{E}{\\min_{(\\eta_c, \\eta_d) \\in \\mathcal{U}_c \\times \\mathcal{U}_d} (\\eta_c \\eta_d)}\n$$\n为了解决 $u_c$ 的最小化问题，我们必须找到乘积 $\\eta_c \\eta_d$ 的最小值。不确定性集合给出为 $\\mathcal{U}_c = [\\hat{\\eta}_c - \\delta_c, \\hat{\\eta}_c + \\delta_c]$ 和 $\\mathcal{U}_d = [\\hat{\\eta}_d - \\delta_d, \\hat{\\eta}_d + \\delta_d]$。由于效率是严格为正的 ($0 < \\eta_c \\leq 1$ 和 $0 < \\eta_d \\leq 1$)，它们乘积的最小值就是它们各自最小值的乘积。\n$$\n\\min_{\\eta_c \\in \\mathcal{U}_c} \\eta_c = \\hat{\\eta}_c - \\delta_c\n$$\n$$\n\\min_{\\eta_d \\in \\mathcal{U}_d} \\eta_d = \\hat{\\eta}_d - \\delta_d\n$$\n因此，该乘积的最小值为：\n$$\n\\min_{(\\eta_c, \\eta_d) \\in \\mathcal{U}_c \\times \\mathcal{U}_d} (\\eta_c \\eta_d) = (\\hat{\\eta}_c - \\delta_c)(\\hat{\\eta}_d - \\delta_d)\n$$\n目标是最小化 $u_c$。最优的第一阶段决策 $u_c^{\\star}$ 是满足鲁棒约束的 $u_c$ 的最小可能值。这可以通过将不等式设为等式来实现：\n$$\nu_c^{\\star} = \\frac{E}{(\\hat{\\eta}_c - \\delta_c)(\\hat{\\eta}_d - \\delta_d)}\n$$\n这是必须注入储能设备的最小能量，以保证无论效率在其不确定性集合内取何值，都能向电网输送 $E$ 的能量。\n\n问题要求的是往返效率 $\\eta_{RT}$ 的保守表示，其定义为 $\\frac{u_d}{u_c}$。在此鲁棒优化问题的背景下，整体策略效率的一个保守表示是保证输送的能量与所需能量输入之比。保证输送的能量是 $E$，而确保这一保证所需的输入是 $u_c^{\\star}$。\n$$\n\\eta_{RT} = \\frac{E}{u_c^{\\star}}\n$$\n代入 $u_c^{\\star}$ 的表达式：\n$$\n\\eta_{RT} = \\frac{E}{\\frac{E}{(\\hat{\\eta}_c - \\delta_c)(\\hat{\\eta}_d - \\delta_d)}}\n$$\n$$\n\\eta_{RT} = (\\hat{\\eta}_c - \\delta_c)(\\hat{\\eta}_d - \\delta_d)\n$$\n这个结果对应于最坏情况效率实现下的往返效率，正是这种情况决定了所需能量输入 $u_c^{\\star}$ 的大小。在这种最坏情况下，即 $\\eta_c = \\hat{\\eta}_c - \\delta_c$ 且 $\\eta_d = \\hat{\\eta}_d - \\delta_d$ 时，可调度能量的上界变为 $u_{d, \\text{max}} = (\\hat{\\eta}_c - \\delta_c)(\\hat{\\eta}_d - \\delta_d) u_c^{\\star} = E$。$u_d$ 的可行区间坍缩到一个点 $[E, E]$，迫使追索调度必须恰好为 $u_d=E$。这笔特定交易的效率是 $(\\hat{\\eta}_c - \\delta_c)(\\hat{\\eta}_d - \\delta_d)$，它代表了该鲁棒策略的保守效率。",
            "answer": "$$\n\\boxed{(\\hat{\\eta}_c - \\delta_c)(\\hat{\\eta}_d - \\delta_d)}\n$$"
        },
        {
            "introduction": "精确的效率建模为何如此重要？本实践将通过量化其经济影响来回答这一问题 ()。通过对比精确考虑效率损失的市场出清模型与忽略效率的简化模型，你将亲手计算因模型不准确而导致的“福利损失”。这个编码练习将具体而有力地证明，在能源系统分析中准确表示效率的巨大价值。",
            "id": "4120283",
            "problem": "考虑一个离散时间内的、带储能的程式化市场出清问题。目标是量化当市场出清优化忽略往返效率时产生的福利损失。从以下基本依据出发：每个时间段的能量守恒、物理量的非负性和容量限制，以及发电机组的线性成本最小化。定义往返（RT）效率为充电效率和放电效率的乘积。具体而言，充电效率是输入功率中增加储能荷电状态的部分，而放电效率是荷电状态减少量中转化为输出功率的部分。假设时间步长为 $1$ 小时。\n\n设有 $T$ 个时段，由 $t \\in \\{1,\\dots,T\\}$ 索引。设需求 $d_t$ 的单位为兆瓦（MW），在一小时内等同于兆瓦时（MWh）。设有两台常规发电机组：\n- 一台基础负载发电机组，其边际成本为 $c_b$ 美元/兆瓦时（$\\$/$MWh），容量为 $\\overline{G}_b$ 兆瓦（MW）。\n- 一台峰值负载发电机组，其边际成本为 $c_p$ 美元/兆瓦时（$\\$/$MWh），容量为 $\\overline{G}_p$ 兆瓦（MW）。\n\n设储能设备的最大能量容量为 $\\overline{E}$ 兆瓦时（MWh），最大充电功率为 $\\overline{U}$ 兆瓦（MW），最大放电功率为 $\\overline{V}$ 兆瓦（MW），初始荷电状态为 $E_0$ 兆瓦时（MWh）。设充电效率为 $\\eta_c \\in (0,1]$，放电效率为 $\\eta_d \\in (0,1]$，因此往返效率为 $\\eta_{RT} = \\eta_c \\eta_d$。最终荷电状态必须等于初始荷电状态，即存在循环运行约束。\n\n为每个时段 $t$ 定义决策变量：基础发电量 $g_{b,t} \\ge 0$，峰值发电量 $g_{p,t} \\ge 0$，储能充电功率 $u_t \\ge 0$，储能放电功率 $v_t \\ge 0$，以及荷电状态 $E_t \\in [0,\\overline{E}]$。在考虑储能充电和放电的情况下，每个时段的电力平衡必须使供应与需求相等。\n\n您的任务是：\n- 根据能量守恒以及充放电效率的定义，推导出荷电状态转移约束、各时段功率平衡约束以及循环运行约束。\n- 建立两个覆盖 $t=1,\\dots,T$ 的线性优化问题：一个包含充放电效率（“真实模型”），另一个通过将充放电视为无损耗来忽略效率（“忽略$\\eta_{RT}$模型”）。两个问题都必须在满足物理边界、推导出的平衡和转移约束的前提下，最小化总发电成本。\n- 对每个给定的测试用例求解这两个问题，并比较它们的最优调度方案和成本。\n\n将一个测试用例的福利损失定义为真实模型下的最小化总发电成本与忽略$\\eta_{RT}$模型下的最小化总发电成本之差。将一个测试用例的调度距离指标定义为真实模型与忽略$\\eta_{RT}$模型之间储能充放电量绝对差值在所有时段上的总和。具体而言，调度距离为 $\\sum_{t=1}^T \\left( \\left|u^{\\text{true}}_t - u^{\\text{ignore}}_t\\right| + \\left|v^{\\text{true}}_t - v^{\\text{ignore}}_t\\right| \\right)$，单位为兆瓦时（MWh）。\n\n所有物理量和参数必须按其给定单位处理；福利损失必须以美元表示（浮点数），调度距离必须以兆瓦时（MWh）表示（浮点数）。效率必须以小数形式处理（例如，90% 的效率写作 0.90）。\n\n测试套件：\n- 用例 1（“理想路径”）：$T=3$；需求 $d_1 = 50$, $d_2 = 65$, $d_3 = 55$ (MW)；基础负载发电机组容量 $\\overline{G}_b = 60$ (MW)，边际成本 $c_b = 40$ ($\\$/$MWh)；峰值负载发电机组容量 $\\overline{G}_p = 100$ (MW)，边际成本 $c_p = 80$ ($\\$/$MWh)；储能能量容量 $\\overline{E} = 40$ (MWh)；储能充电功率 $\\overline{U} = 30$ (MW)；储能放电功率 $\\overline{V} = 30$ (MW)；初始荷电状态 $E_0 = 20$ (MWh)；充电效率 $\\eta_c = 0.95$；放电效率 $\\eta_d = 0.90$。\n- 用例 2（“效率边界”）：与用例 1 相同，但充电效率 $\\eta_c = 1.00$，放电效率 $\\eta_d = 1.00$。\n- 用例 3（“不使用储能”）：$T=3$；需求 $d_1 = 50$, $d_2 = 60$, $d_3 = 55$ (MW)；发电机组与用例 1 相同；储能能量容量 $\\overline{E} = 0$ (MWh)；储能充电功率 $\\overline{U} = 0$ (MW)；储能放电功率 $\\overline{V} = 0$ (MW)；初始荷电状态 $E_0 = 0$ (MWh)；充电效率 $\\eta_c = 0.95$；放电效率 $\\eta_d = 0.90$。\n- 用例 4（“低效率，显著偏移”）：$T=3$；需求 $d_1 = 50$, $d_2 = 80$, $d_3 = 45$ (MW)；基础负载发电机组容量 $\\overline{G}_b = 60$ (MW)，边际成本 $c_b = 40$ ($\\$/$MWh)；峰值负载发电机组容量 $\\overline{G}_p = 100$ (MW)，边际成本 $c_p = 100$ ($\\$/$MWh)；储能能量容量 $\\overline{E} = 60$ (MWh)；储能充电功率 $\\overline{U} = 30$ (MW)；储能放电功率 $\\overline{V} = 30$ (MW)；初始荷电状态 $E_0 = 30$ (MWh)；充电效率 $\\eta_c = 0.85$；放电效率 $\\eta_d = 0.70$。\n\n您的程序应生成单行输出，其中包含一个由方括号括起来的逗号分隔列表。该列表必须按测试用例排序，每个测试用例依次提供两个浮点数：首先是福利损失（美元），然后是调度距离（兆瓦时，MWh）。例如，输出格式必须类似于 $\\left[\\text{wl}_1,\\text{dd}_1,\\text{wl}_2,\\text{dd}_2,\\text{wl}_3,\\text{dd}_3,\\text{wl}_4,\\text{dd}_4\\right]$。",
            "solution": "该问题要求建立并求解两个不同的市场出清优化问题，以量化忽略储能效率损失所带来的经济影响。我们将首先从基本原理出发，推导出控制该系统的物理和经济约束。然后，我们将建立两个线性规划（LP）模型：一个考虑了效率损失的“真实模型”，以及一个假设储能无损耗的简化“忽略$\\eta_{RT}$模型”。最后，我们将针对给定的测试用例求解这两个模型，并计算指定的指标：福利损失和调度距离。\n\n### 1. 模型约束的推导\n\n该系统在一个包含 $T$ 个时段的离散时间范围内建模，每个时段的持续时间为 $\\Delta t = 1$ 小时。每个时段 $t \\in \\{1,\\dots,T\\}$ 的决策变量是基础发电量 $g_{b,t}$、峰值发电量 $g_{p,t}$、储能充电功率 $u_t$、储能放电功率 $v_t$ 以及储能单元的荷电状态 $E_t$。\n\n**荷电状态（SOC）转移约束：**\n此约束源于应用于储能设备的能量守恒原理。\n- 充电时，储能设备从电网消耗功率 $u_t$（单位 MW）。在 $\\Delta t = 1$ 小时的时间段内，吸收的能量为 $u_t \\times \\Delta t = u_t$ MWh。充电效率 $\\eta_c$ 是这部分输入能量中增加荷电状态的比例。因此，储存的能量为 $\\eta_c u_t$。\n- 放电时，储能设备向电网输送功率 $v_t$（单位 MW）。在 $\\Delta t = 1$ 小时内，供应的能量为 $v_t \\times \\Delta t = v_t$ MWh。放电效率 $\\eta_d$ 是荷电状态减少量中转化为输送能量的比例。如果荷电状态减少了 $\\Delta E_{\\text{discharge}, t}$，则输送的能量为 $v_t = \\eta_d (\\Delta E_{\\text{discharge}, t} / \\Delta t)$。由于 $\\Delta t=1$，这得到 $\\Delta E_{\\text{discharge}, t} = v_t / \\eta_d$。\n\n综合这些影响，时段 $t$ 结束时的荷电状态（记为 $E_t$）与前一时段结束时的荷电状态 $E_{t-1}$ 通过以下转移方程关联：\n$$E_t = E_{t-1} + \\eta_c u_t \\Delta t - \\frac{v_t}{\\eta_d} \\Delta t$$\n由于 $\\Delta t = 1$ 小时，该方程简化为：\n$$E_t = E_{t-1} + \\eta_c u_t - \\frac{1}{\\eta_d} v_t \\quad \\forall t \\in \\{1, \\dots, T\\}$$\n其中 $E_0$ 是给定的初始荷电状态。\n\n**功率平衡约束：**\n在每个时段 $t$，供应到电网的总功率必须等于从电网消耗的总功率。\n- 供应方包括基础机组的发电量（$g_{b,t}$）、峰值机组的发电量（$g_{p,t}$）以及储能放电功率（$v_t$）。\n- 需求方包括外生负荷（$d_t$）和储能充电所消耗的功率（$u_t$）。\n因此，平衡方程为：\n$$g_{b,t} + g_{p,t} + v_t = d_t + u_t \\quad \\forall t \\in \\{1, \\dots, T\\}$$\n可以将其重排为线性规划的标准形式：\n$$g_{b,t} + g_{p,t} + v_t - u_t = d_t \\quad \\forall t \\in \\{1, \\dots, T\\}$$\n\n**循环运行约束：**\n问题规定储能必须循环运行，其最终荷电状态需等于初始荷电状态。\n$$E_T = E_0$$\n\n### 2. 线性规划模型\n\n在推导出约束条件后，我们现在可以建立这两个优化问题。两个问题都旨在最小化整个时间范围内的总发电成本。\n\n**目标函数：**\n总成本是所有时段内基础发电机组和峰值发电机组的成本之和。\n$$\\text{minimize} \\quad \\sum_{t=1}^T (c_b g_{b,t} + c_p g_{p,t})$$\n\n**决策变量：**\n两个问题的决策变量集合均为 $\\{g_{b,t}, g_{p,t}, u_t, v_t, E_t\\}_{t=1}^T$。\n\n**A. “真实模型”（包含效率）**\n\n此模型包含了所定义的效率 $\\eta_c$ 和 $\\eta_d$。\n\n**目标：**\n$$\\min_{g_b, g_p, u, v, E} \\sum_{t=1}^T (c_b g_{b,t} + c_p g_{p,t})$$\n\n**约束条件：**\n1.  功率平衡：$g_{b,t} + g_{p,t} + v_t - u_t = d_t$，对于 $t=1,\\dots,T$。\n2.  荷电状态转移：$E_t - E_{t-1} - \\eta_c u_t + \\frac{1}{\\eta_d} v_t = 0$，对于 $t=1,\\dots,T$（其中 $E_0$ 为参数）。\n3.  循环运行：$E_T = E_0$。\n4.  发电量限制：$0 \\le g_{b,t} \\le \\overline{G}_b$ 和 $0 \\le g_{p,t} \\le \\overline{G}_p$，对于 $t=1,\\dots,T$。\n5.  储能功率限制：$0 \\le u_t \\le \\overline{U}$ 和 $0 \\le v_t \\le \\overline{V}$，对于 $t=1,\\dots,T$。\n6.  储能能量限制：$0 \\le E_t \\le \\overline{E}$，对于 $t=1,\\dots,T$。\n\n**B. “忽略$\\eta_{RT}$模型”**\n\n此模型代表了一种简化的、理想化的观点，即储能是无损耗的。这通过在“真实模型”的公式中设置 $\\eta_c = 1$ 和 $\\eta_d = 1$ 来实现。\n\n**目标：**\n$$\\min_{g_b, g_p, u, v, E} \\sum_{t=1}^T (c_b g_{b,t} + c_p g_{p,t})$$\n\n**约束条件：**\n1.  功率平衡：$g_{b,t} + g_{p,t} + v_t - u_t = d_t$，对于 $t=1,\\dots,T$。\n2.  荷电状态转移（无损耗）：$E_t - E_{t-1} - u_t + v_t = 0$，对于 $t=1,\\dots,T$（其中 $E_0$ 为参数）。\n3.  循环运行：$E_T = E_0$。\n4.  发电量限制：$0 \\le g_{b,t} \\le \\overline{G}_b$ 和 $0 \\le g_{p,t} \\le \\overline{G}_p$，对于 $t=1,\\dots,T$。\n5.  储能功率限制：$0 \\le u_t \\le \\overline{U}$ 和 $0 \\le v_t \\le \\overline{V}$，对于 $t=1,\\dots,T$。\n6.  储能能量限制：$0 \\le E_t \\le \\overline{E}$，对于 $t=1,\\dots,T$。\n\n### 3. 求解方法与指标\n\n对于每个测试用例，我们求解这两个线性规划问题，以找到最优的发电和储能调度方案以及最小总成本。为此，我们使用 `scipy.optimize.linprog` 函数。\n\n计算以下指标以比较结果：\n- **福利损失**：定义为“真实模型”的最小化总成本（$C^*_{\\text{true}}$）与“忽略$\\eta_{RT}$模型”的最小化总成本（$C^*_{\\text{ignore}}$）之间的差值。\n  $$ \\text{福利损失} = C^*_{\\text{true}} - C^*_{\\text{ignore}} $$\n  这个量反映了由于储能中能量损失的物理现实而产生的额外系统成本，而理想化模型未能捕捉到这一点。\n\n- **调度距离**：定义为两个模型在储能调度行为（充电和放电）上绝对差值在所有时段的总和。设 $(u^{\\text{true}}, v^{\\text{true}})$ 和 $(u^{\\text{ignore}}, v^{\\text{ignore}})$ 分别是两个模型的最优储能调度方案。\n  $$ \\text{调度距离} = \\sum_{t=1}^T \\left( |u^{\\text{true}}_t - u^{\\text{ignore}}_t| + |v^{\\text{true}}_t - v^{\\text{ignore}}_t| \\right) $$\n  该指标量化了在考虑效率损失时，最优储能运行策略发生变化的程度。较大的距离表示运行行为上存在更显著的差异。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import linprog\n\ndef solve():\n    \"\"\"\n    Main function to solve the market clearing problem for all test cases.\n    \"\"\"\n    test_cases = [\n        # Case 1 (\"happy path\")\n        {\n            \"T\": 3, \"d\": [50, 65, 55], \"Gb_bar\": 60, \"cb\": 40, \"Gp_bar\": 100, \"cp\": 80,\n            \"E_bar\": 40, \"U_bar\": 30, \"V_bar\": 30, \"E0\": 20, \"eta_c\": 0.95, \"eta_d\": 0.90\n        },\n        # Case 2 (\"efficiency boundary\")\n        {\n            \"T\": 3, \"d\": [50, 65, 55], \"Gb_bar\": 60, \"cb\": 40, \"Gp_bar\": 100, \"cp\": 80,\n            \"E_bar\": 40, \"U_bar\": 30, \"V_bar\": 30, \"E0\": 20, \"eta_c\": 1.00, \"eta_d\": 1.00\n        },\n        # Case 3 (\"no storage use\")\n        {\n            \"T\": 3, \"d\": [50, 60, 55], \"Gb_bar\": 60, \"cb\": 40, \"Gp_bar\": 100, \"cp\": 80,\n            \"E_bar\": 0, \"U_bar\": 0, \"V_bar\": 0, \"E0\": 0, \"eta_c\": 0.95, \"eta_d\": 0.90\n        },\n        # Case 4 (\"low efficiency, pronounced shift\")\n        {\n            \"T\": 3, \"d\": [50, 80, 45], \"Gb_bar\": 60, \"cb\": 40, \"Gp_bar\": 100, \"cp\": 100,\n            \"E_bar\": 60, \"U_bar\": 30, \"V_bar\": 30, \"E0\": 30, \"eta_c\": 0.85, \"eta_d\": 0.70\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        # Solve the problem with true efficiencies\n        cost_true, u_true, v_true = run_optimization(case, use_efficiency=True)\n        \n        # Solve the problem ignoring efficiencies (eta_c=1, eta_d=1)\n        cost_ignore, u_ignore, v_ignore = run_optimization(case, use_efficiency=False)\n        \n        # Calculate welfare loss and dispatch distance\n        welfare_loss = cost_true - cost_ignore\n        dispatch_distance = np.sum(np.abs(u_true - u_ignore) + np.abs(v_true - v_ignore))\n        \n        results.extend([welfare_loss, dispatch_distance])\n    \n    # Format and print the final results\n    print(f\"[{','.join(map(str, [f'{r:.10f}'.rstrip('0').rstrip('.') for r in results]))}]\")\n\ndef run_optimization(case_params, use_efficiency):\n    \"\"\"\n    Formulates and solves the linear optimization problem.\n    \"\"\"\n    T = case_params[\"T\"]\n    d = np.array(case_params[\"d\"])\n    Gb_bar, cb = case_params[\"Gb_bar\"], case_params[\"cb\"]\n    Gp_bar, cp = case_params[\"Gp_bar\"], case_params[\"cp\"]\n    E_bar, U_bar, V_bar, E0 = case_params[\"E_bar\"], case_params[\"U_bar\"], case_params[\"V_bar\"], case_params[\"E0\"]\n    \n    if use_efficiency:\n        eta_c, eta_d = case_params[\"eta_c\"], case_params[\"eta_d\"]\n    else:\n        eta_c, eta_d = 1.0, 1.0\n\n    # Decision variables are ordered as: [g_b, g_p, u, v, E]\n    # Each block is a vector of length T. Total variables num_vars = 5 * T.\n    num_vars = 5 * T\n    \n    # --- Objective Function ---\n    # min sum(cb*g_b_t + cp*g_p_t)\n    c = np.zeros(num_vars)\n    c[0:T] = cb          # Costs for base generator\n    c[T:2*T] = cp        # Costs for peaking generator\n\n    # --- Equality Constraints (A_eq * x = b_eq) ---\n    num_eq_constraints = 2 * T + 1\n    A_eq = np.zeros((num_eq_constraints, num_vars))\n    b_eq = np.zeros(num_eq_constraints)\n    \n    # 1. Power balance constraints: g_b_t + g_p_t + v_t - u_t = d_t\n    for t in range(T):\n        A_eq[t, t] = 1        # g_b_t\n        A_eq[t, T + t] = 1    # g_p_t\n        A_eq[t, 2*T + t] = -1 # u_t\n        A_eq[t, 3*T + t] = 1  # v_t\n        b_eq[t] = d[t]\n        \n    # 2. SOC transition constraints: E_t - E_{t-1} - eta_c*u_t + (1/eta_d)*v_t = 0\n    for t in range(T):\n        row_idx = T + t\n        A_eq[row_idx, 4*T + t] = 1          # E_t\n        if t > 0:\n            A_eq[row_idx, 4*T + t - 1] = -1 # -E_{t-1}\n        \n        A_eq[row_idx, 2*T + t] = -eta_c      # -eta_c * u_t\n        if eta_d > 0:\n          A_eq[row_idx, 3*T + t] = 1/eta_d # (1/eta_d) * v_t\n        \n        if t == 0:\n            b_eq[row_idx] = E0 # E_1 - eta_c*u_1 + ... = E_0\n        # else, b_eq is already 0\n    \n    # 3. Cyclic operation: E_T = E_0\n    A_eq[2*T, 5*T - 1] = 1 # E_T\n    b_eq[2*T] = E0\n    \n    # --- Bounds ---\n    bounds = []\n    # g_b bounds\n    bounds.extend([(0, Gb_bar)] * T)\n    # g_p bounds\n    bounds.extend([(0, Gp_bar)] * T)\n    # u bounds\n    bounds.extend([(0, U_bar)] * T)\n    # v bounds\n    bounds.extend([(0, V_bar)] * T)\n    # E bounds\n    bounds.extend([(0, E_bar)] * T)\n\n    # --- Solve LP ---\n    res = linprog(c, A_eq=A_eq, b_eq=b_eq, bounds=bounds, method='highs')\n    \n    if not res.success:\n        raise ValueError(f\"Optimization failed: {res.message}\")\n    \n    optimal_cost = res.fun\n    x = res.x\n    \n    # Extract u and v from the solution vector\n    u_opt = x[2*T : 3*T]\n    v_opt = x[3*T : 4*T]\n    \n    # Handle near-zero values from solver\n    u_opt[np.isclose(u_opt, 0)] = 0\n    v_opt[np.isclose(v_opt, 0)] = 0\n\n    return optimal_cost, u_opt, v_opt\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}