{
    "hands_on_practices": [
        {
            "introduction": "Accurately modeling the behavior of an energy storage device is a cornerstone of energy systems analysis. This first exercise guides you through the process of translating the physical principles of charging and discharging losses into a precise mathematical model. You will derive the state-of-charge dynamics with separate efficiencies and then embed these into a Mixed-Integer Linear Programming (MILP) framework, a crucial tool for making optimal dispatch decisions under real-world operational constraints.",
            "id": "4120232",
            "problem": "Consider a single-bus microgrid with one conventional generator, one electrochemical energy storage device, and exogenous variable renewable energy. Time is discretized into $T$ periods with uniform step $\\Delta t$ where $\\Delta t = 1$ hour. The storage device has separate charging and discharging efficiencies. The objective is to formulate a dispatch problem that minimizes conventional generation subject to conservation of energy, State of Charge (SoC) dynamics, operational limits, and an exclusivity constraint that prevents simultaneous charging and discharging. State of Charge (SoC) and Mixed-Integer Linear Programming (MILP) must be spelled out in full on first appearance.\n\nStarting from the conservation of energy and the definitions of charging and discharging efficiency, derive the linear SoC evolution over a single time step for separate charging and discharging power decisions. Then formulate a Mixed-Integer Linear Programming problem with decision variables for conventional generation, charging power, discharging power, SoC, and binary exclusivity indicators, which enforces that charging and discharging do not occur simultaneously in any period via linear constraints.\n\nFinally, for the following specific instance, compute the minimum total conventional generation energy over the horizon:\n- Number of periods $T = 3$.\n- Demand profile $d_{1} = 10$, $d_{2} = 10$, $d_{3} = 10$ (each in $\\mathrm{kWh}$ for a $1$ hour interval).\n- Renewable energy profile $r_{1} = 8$, $r_{2} = 12$, $r_{3} = 5$ (each in $\\mathrm{kWh}$ for a $1$ hour interval).\n- Storage parameters: energy capacity $E_{\\max} = 5$ (in $\\mathrm{kWh}$), maximum charging power $P_{\\max}^{c} = 5$ (in $\\mathrm{kW}$), maximum discharging power $P_{\\max}^{d} = 5$ (in $\\mathrm{kW}$).\n- Efficiencies: charging efficiency $\\eta_{c} = 0.9$, discharging efficiency $\\eta_{d} = 0.9$.\n- Initial SoC $s_{0} = 0$ (in $\\mathrm{kWh}$) and terminal SoC constraint $s_{T} = s_{0}$.\n- Conventional generator has no upper bound and nonnegative output.\n- Use binary variables to enforce $p_{t}^{c} \\cdot p_{t}^{d} = 0$ via linear big-$M$ constraints with $M$ chosen from known bounds.\n\nFormulate the problem completely, showing all variables and constraints, then compute the optimal value of $\\sum_{t=1}^{T} g_{t}$, where $g_{t}$ is the conventional generation in period $t$. Express the final energy in $\\mathrm{kWh}$. No rounding is required; provide the exact value.",
            "solution": "The problem is assessed to be valid as it represents a well-posed, scientifically grounded, and standard optimal dispatch problem in energy systems engineering. All necessary data and constraints are provided, and there are no internal contradictions or ambiguities.\n\nThe solution is presented in three parts as requested: first, the derivation of the State of Charge (SoC) evolution equation; second, the formulation of the complete Mixed-Integer Linear Programming (MILP) problem; and third, the solution of the specific instance provided.\n\nWe begin by defining the primary variables and parameters. Time is discretized into periods $t \\in \\{1, 2, \\dots, T\\}$. The duration of each period is $\\Delta t = 1$ hour.\nLet $s_t$ be the energy stored (the State of Charge) in kWh at the end of period $t$.\nLet $p_t^c$ be the charging power in kW and $p_t^d$ be the discharging power in kW during period $t$. These are assumed to be constant throughout the period.\nThe charging efficiency is $\\eta_c$, and the discharging efficiency is $\\eta_d$.\n\n**Part 1: Derivation of the State of Charge (SoC) Evolution Equation**\n\nThe change in the energy stored in the device over a time interval is the net effect of energy flowing in and out.\nWhen the device is charging with power $p_t^c$, the rate of increase of stored energy is governed by the charging efficiency $\\eta_c$. The power actually being stored is $\\eta_c p_t^c$.\nWhen the device is discharging, it injects power $p_t^d$ into the grid. To provide this power, a greater amount must be drawn from the storage due to losses. The rate of decrease of stored energy is $\\frac{p_t^d}{\\eta_d}$.\n\nThe dynamic evolution of the stored energy $s(t)$ can be described by the differential equation:\n$$\n\\frac{ds(t)}{dt} = \\eta_c p^c(t) - \\frac{p^d(t)}{\\eta_d}\n$$\nwhere $p^c(t)$ and $p^d(t)$ are the instantaneous charging and discharging powers.\n\nFor a discrete-time model with time step $\\Delta t$, we integrate this equation over period $t$, which spans from time $(t-1)\\Delta t$ to $t\\Delta t$. Assuming the power levels $p_t^c$ and $p_t^d$ are constant throughout period $t$:\n$$\n\\int_{t-1}^{t} \\frac{ds(t')}{dt'} dt' = \\int_{(t-1)\\Delta t}^{t\\Delta t} \\left( \\eta_c p_t^c - \\frac{p_t^d}{\\eta_d} \\right) dt'\n$$\nThe left side evaluates to $s_t - s_{t-1}$. The right side, with constant power, becomes:\n$$\ns_t - s_{t-1} = \\left( \\eta_c p_t^c - \\frac{p_t^d}{\\eta_d} \\right) \\Delta t\n$$\nThis is the general linear SoC evolution equation. Given that the problem specifies $\\Delta t = 1$ hour, the equation simplifies to:\n$$\ns_t = s_{t-1} + \\eta_c p_t^c - \\frac{p_t^d}{\\eta_d}\n$$\nIn this simplified form, for uniformity with problem data given in kWh, $p_t^c$ and $p_t^d$ are numerically equivalent to the energy charged and discharged (in kWh) during the $1$-hour interval. Hereafter, variables $g_t, p_t^c, p_t^d$ will represent energy quantities in kWh for period $t$.\n\n**Part 2: Mixed-Integer Linear Programming (MILP) Formulation**\n\nWe now formulate the complete optimization problem. A Mixed-Integer Linear Programming (MILP) problem consists of an objective function to be minimized or maximized, subject to a set of linear constraints, where some decision variables are restricted to be integers.\n\n**Decision Variables:**\nFor each period $t \\in \\{1, \\dots, T\\}$:\n- $g_t$: Conventional generation energy [kWh].\n- $p_t^c$: Energy used for charging the storage [kWh].\n- $p_t^d$: Energy delivered by discharging the storage [kWh].\n- $s_t$: State of Charge (energy in storage) at the end of the period [kWh].\n- $u_t$: Binary variable indicating charging status, $u_t \\in \\{0, 1\\}$. We define $u_t = 1$ if the device is charging and $u_t = 0$ otherwise.\n\n**Objective Function:**\nThe objective is to minimize the total conventional generation energy over the time horizon $T$.\n$$\n\\text{Minimize} \\quad \\sum_{t=1}^{T} g_t\n$$\n\n**Constraints:**\nFor all periods $t \\in \\{1, \\dots, T\\}$:\n1.  **Energy Conservation (Balance):** The total energy supplied must equal the total energy consumed. Let $d_t$ be the demand and $r_t$ be the renewable generation in period $t$.\n    $$\n    g_t + r_t + p_t^d = d_t + p_t^c\n    $$\n    This is commonly written with the net demand $l_t = d_t - r_t$ on one side:\n    $$\n    g_t + p_t^d - p_t^c = l_t\n    $$\n\n2.  **State of Charge (SoC) Evolution:**\n    $$\n    s_t = s_{t-1} + \\eta_c p_t^c - \\frac{p_t^d}{\\eta_d}\n    $$\n    where $s_0$ is the given initial SoC.\n\n3.  **Storage Operational Limits:**\n    - SoC must be within the storage energy capacity $E_{\\max}$:\n      $$\n      0 \\le s_t \\le E_{\\max}\n      $$\n    - Charging and discharging must be within power limits. Since $\\Delta t=1$, the energy limits are numerically equal to the power limits $P_{\\max}^c$ and $P_{\\max}^d$:\n      $$\n      0 \\le p_t^c \\le P_{\\max}^c\n      $$\n      $$\n      0 \\le p_t^d \\le P_{\\max}^d\n      $$\n\n4.  **Generation Limits:**\n    - The conventional generator cannot have negative output:\n      $$\n      g_t \\ge 0\n      $$\n\n5.  **Charging/Discharging Exclusivity:** The constraint $p_t^c \\cdot p_t^d = 0$ is non-linear. It is linearized using the binary variable $u_t$ and big-$M$ constraints. The constant $M$ should be a sufficiently large number, ideally a tight upper bound on the variable it multiplies. Here, we can use the maximum power ratings.\n    $$\n    p_t^c \\le u_t P_{\\max}^c\n    $$\n    $$\n    p_t^d \\le (1-u_t) P_{\\max}^d\n    $$\n    If $u_t=1$ (charging), the second constraint forces $p_t^d \\le 0$, which combined with $p_t^d \\ge 0$ implies $p_t^d = 0$. If $u_t=0$ (not charging), the first constraint forces $p_t^c \\le 0$, implying $p_t^c=0$.\n\n6.  **Terminal Condition:** The final SoC is constrained to be equal to the initial SoC.\n    $$\n    s_T = s_0\n    $$\n\n**Part 3: Solution for the Specific Instance**\n\nWe now solve the problem for the given parameters:\n- $T = 3$.\n- Demand: $d_1 = 10, d_2 = 10, d_3 = 10$ [kWh].\n- Renewables: $r_1 = 8, r_2 = 12, r_3 = 5$ [kWh].\n- Net demand $l_t = d_t - r_t$: $l_1 = 2$, $l_2 = -2$, $l_3 = 5$ [kWh].\n- Storage: $E_{\\max} = 5$ kWh, $P_{\\max}^c = 5$ kW, $P_{\\max}^d = 5$ kW. The energy limits are thus $5$ kWh.\n- Efficiencies: $\\eta_c = 0.9$, $\\eta_d = 0.9$.\n- SoC: $s_0 = 0$ kWh, $s_3 = s_0 = 0$ kWh.\n\nThe objective is to minimize $G = g_1 + g_2 + g_3$.\nThe condition $s_3 = s_0 = 0$ implies a full cycle for the storage. Summing the SoC evolution equation over $t=1,2,3$:\n$s_3 - s_0 = \\sum_{t=1}^3 \\left( \\eta_c p_t^c - \\frac{p_t^d}{\\eta_d} \\right)$.\n$0 = \\eta_c \\sum p_t^c - \\frac{1}{\\eta_d} \\sum p_t^d \\implies \\sum p_t^d = \\eta_c \\eta_d \\sum p_t^c = 0.81 \\sum p_t^c$.\n\nThe total generation $G$ can be related to the total net demand and storage losses:\n$G = \\sum g_t = \\sum (l_t - p_t^d + p_t^c) = \\sum l_t + \\sum p_t^c - \\sum p_t^d$.\n$G = (2 - 2 + 5) + \\sum p_t^c - 0.81 \\sum p_t^c = 5 + 0.19 \\sum p_t^c$.\nTo minimize $G$, we must minimize the total energy charged into the storage, $\\sum p_t^c$.\n\nLet's analyze the problem chronologically to find the minimum required charging:\n- **Period 1 ($t=1$):** Net demand $l_1 = 2$ kWh.\nThe energy balance is $g_1 + p_1^d - p_1^c = 2$.\nThe initial SoC is $s_0=0$, so discharging is not possible: $p_1^d=0$.\nThe balance becomes $g_1 - p_1^c = 2$, or $g_1 = 2 + p_1^c$. To minimize generation, we should avoid charging. Charging during a deficit period only increases the immediate generation needed. Thus, the optimal choice is $p_1^c=0$.\nThis leads to $g_1=2$ kWh, $p_1^d=0$.\nThe SoC remains unchanged: $s_1 = s_0 + 0 - 0 = 0$ kWh.\n\n- **Period 2 ($t=2$):** Net demand $l_2 = -2$ kWh (a surplus of $2$ kWh).\nThe energy balance is $g_2 + p_2^d - p_2^c = -2$.\nSince $g_2 \\ge 0$, we must have $p_2^c - p_2^d \\ge 2$. Due to exclusivity, one term must be zero. If $p_2^c=0$, then $-p_2^d \\ge 2$, which is impossible ($p_2^d \\ge 0$). Therefore, we must have $p_2^d=0$ and $p_2^c \\ge 2$.\nTo minimize total charging $\\sum p_t^c$, we should choose the smallest possible value for $p_2^c$, which is $p_2^c=2$ kWh. This choice also allows us to set $g_2=0$, which is optimal.\nWith $p_2^c=2$ kWh and $p_2^d=0$, we have $g_2=0$.\nThe SoC updates to: $s_2 = s_1 + \\eta_c p_2^c - p_2^d/\\eta_d = 0 + 0.9 \\times 2 - 0 = 1.8$ kWh. This is within the capacity $E_{\\max}=5$ kWh.\n\n- **Period 3 ($t=3$):** Net demand $l_3 = 5$ kWh.\nThe energy balance is $g_3 + p_3^d - p_3^c = 5$.\nTo minimize generation, we should use the stored energy by discharging. Thus, $p_3^c = 0$.\nThe balance becomes $g_3 = 5 - p_3^d$. We must maximize $p_3^d$.\nThe maximum discharge is limited by two factors:\n1. Power limit: $p_3^d \\le P_{\\max}^d = 5$ kWh.\n2. Energy available: The energy drawn from storage is $p_3^d/\\eta_d$. This must not exceed the available SoC, $s_2$.\n   $p_3^d/\\eta_d \\le s_2 \\implies p_3^d/0.9 \\le 1.8 \\implies p_3^d \\le 1.8 \\times 0.9 = 1.62$ kWh.\nThe available energy is the limiting factor. The maximum possible discharge is $p_3^d = 1.62$ kWh.\nThis gives generation $g_3 = 5 - 1.62 = 3.38$ kWh.\nThe final SoC is $s_3 = s_2 - p_3^d/\\eta_d = 1.8 - 1.62/0.9 = 1.8 - 1.8 = 0$ kWh. This satisfies the terminal condition $s_3=s_0=0$.\n\nThe reasoning shows that any other strategy (e.g., charging in period 1, or charging more than the surplus in period 2) would result in a larger value for $\\sum p_t^c$ and hence a larger total generation. The minimum possible value for $\\sum p_t^c$ is $2$ kWh.\n\nThe total conventional generation is:\n$$\n\\sum_{t=1}^{3} g_t = g_1 + g_2 + g_3 = 2 + 0 + 3.38 = 5.38 \\text{ kWh}\n$$\nAlternatively, using the derived formula:\n$$\n\\sum g_t = 5 + 0.19 \\sum p_t^c = 5 + 0.19 \\times 2 = 5 + 0.38 = 5.38 \\text{ kWh}\n$$\nThe results are consistent.",
            "answer": "$$\n\\boxed{5.38}\n$$"
        },
        {
            "introduction": "Building on the foundational model of a single storage unit, this practice shifts the focus to system-level economic implications. Here, you will implement and solve a market-clearing problem to see how storage efficiency impacts the total cost of electricity supply. By comparing a dispatch that accounts for real-world losses against an idealized, lossless dispatch, you will quantify the \"welfare loss\"â€”a tangible measure of the economic error introduced by inaccurate modeling where round-trip efficiency $\\eta_{RT}$ is ignored.",
            "id": "4120283",
            "problem": "Consider a stylized market-clearing problem with energy storage in discrete time. The aim is to quantify the welfare loss that arises when a market-clearing optimization ignores round-trip efficiency. Start from the following foundational bases: conservation of energy over each time period, non-negativity and capacity bounds on physical quantities, and linear cost minimization for generators. Define Round-Trip (RT) efficiency as the product of charging efficiency and discharging efficiency. Explicitly, the charging efficiency is the fraction of input power that increases the storage state-of-charge, and the discharging efficiency is the fraction of state-of-charge decrease that becomes delivered power. Assume time step length of $1$ hour.\n\nLet there be $T$ periods, indexed by $t \\in \\{1,\\dots,T\\}$. Let demand $d_t$ be in megawatt (MW), which equals megawatt-hour (MWh) over one hour. Let there be two conventional generators:\n- A base generator with marginal cost $c_b$ in dollars per megawatt-hour ($\\$/$MWh) and capacity $\\overline{G}_b$ in megawatt (MW).\n- A peaking generator with marginal cost $c_p$ in dollars per megawatt-hour ($\\$/$MWh) and capacity $\\overline{G}_p$ in megawatt (MW).\n\nLet the storage device have maximum energy capacity $\\overline{E}$ in megawatt-hour (MWh), maximum charge power $\\overline{U}$ in megawatt (MW), maximum discharge power $\\overline{V}$ in megawatt (MW), and initial state-of-charge $E_0$ in megawatt-hour (MWh). Let charging efficiency be $\\eta_c \\in (0,1]$ and discharging efficiency be $\\eta_d \\in (0,1]$, so round-trip efficiency is $\\eta_{RT} = \\eta_c \\eta_d$. The final state-of-charge must be equal to the initial state-of-charge, i.e., a cyclic operation constraint.\n\nDefine decision variables for each period $t$: base generation $g_{b,t} \\ge 0$, peaking generation $g_{p,t} \\ge 0$, storage charge power $u_t \\ge 0$, storage discharge power $v_t \\ge 0$, and state-of-charge $E_t \\in [0,\\overline{E}]$. The power balance in each period must equate supply and demand when accounting for storage charging and discharging.\n\nYour task is to:\n- Derive from conservation of energy and the definitions of charging and discharging efficiencies the state-of-charge transition constraints, the per-period power balance constraints, and the cyclic operation constraint.\n- Formulate two linear optimization problems over $t=1,\\dots,T$: one that incorporates charging and discharging efficiencies (the \"true model\"), and one that ignores efficiencies by treating charging and discharging as lossless (the \"ignore-$\\eta_{RT}$ model\"). Both problems must minimize total generation cost subject to physical bounds and the derived balance and transition constraints.\n- Solve both problems for each provided test case, and compare their optimal dispatch schedules and costs.\n\nDefine welfare loss for a test case as the difference between the minimized total generation cost under the true model and the minimized total generation cost under the ignore-$\\eta_{RT}$ model. Define a dispatch distance metric for a test case as the sum over periods of the absolute differences in storage charging and discharging magnitudes between the true model and the ignore-$\\eta_{RT}$ model. Concretely, the dispatch distance is $\\sum_{t=1}^T \\left( \\left|u^{\\text{true}}_t - u^{\\text{ignore}}_t\\right| + \\left|v^{\\text{true}}_t - v^{\\text{ignore}}_t\\right| \\right)$, which is measured in megawatt-hour (MWh).\n\nAll physical quantities and parameters must be treated in their given units; the welfare loss must be expressed in dollars as a float, and the dispatch distance must be expressed in megawatt-hour (MWh) as a float. Efficiencies must be treated as decimals (for example, an efficiency of $90\\%$ is written as $0.90$).\n\nTest suite:\n- Case $1$ (\"happy path\"): $T=3$; demands $d_1 = 50$, $d_2 = 65$, $d_3 = 55$ (MW); base generator capacity $\\overline{G}_b = 60$ (MW) and marginal cost $c_b = 40$ ($\\$/$MWh); peaking generator capacity $\\overline{G}_p = 100$ (MW) and marginal cost $c_p = 80$ ($\\$/$MWh); storage energy capacity $\\overline{E} = 40$ (MWh); storage charge power $\\overline{U} = 30$ (MW); storage discharge power $\\overline{V} = 30$ (MW); initial state-of-charge $E_0 = 20$ (MWh); charging efficiency $\\eta_c = 0.95$; discharging efficiency $\\eta_d = 0.90$.\n- Case $2$ (\"efficiency boundary\"): same as Case $1$ but with charging efficiency $\\eta_c = 1.00$ and discharging efficiency $\\eta_d = 1.00$.\n- Case $3$ (\"no storage use\"): $T=3$; demands $d_1 = 50$, $d_2 = 60$, $d_3 = 55$ (MW); generators as in Case $1$; storage energy capacity $\\overline{E} = 0$ (MWh); storage charge power $\\overline{U} = 0$ (MW); storage discharge power $\\overline{V} = 0$ (MW); initial state-of-charge $E_0 = 0$ (MWh); charging efficiency $\\eta_c = 0.95$; discharging efficiency $\\eta_d = 0.90$.\n- Case $4$ (\"low efficiency, pronounced shift\"): $T=3$; demands $d_1 = 50$, $d_2 = 80$, $d_3 = 45$ (MW); base generator capacity $\\overline{G}_b = 60$ (MW) and marginal cost $c_b = 40$ ($\\$/$MWh); peaking generator capacity $\\overline{G}_p = 100$ (MW) and marginal cost $c_p = 100$ ($\\$/$MWh); storage energy capacity $\\overline{E} = 60$ (MWh); storage charge power $\\overline{U} = 30$ (MW); storage discharge power $\\overline{V} = 30$ (MW); initial state-of-charge $E_0 = 30$ (MWh); charging efficiency $\\eta_c = 0.85$; discharging efficiency $\\eta_d = 0.70$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. The list must be ordered by test case, where each test case contributes exactly two floats in sequence: first the welfare loss in dollars, then the dispatch distance in megawatt-hour (MWh). For example, the output format must be like $\\left[\\text{wl}_1,\\text{dd}_1,\\text{wl}_2,\\text{dd}_2,\\text{wl}_3,\\text{dd}_3,\\text{wl}_4,\\text{dd}_4\\right]$.",
            "solution": "The problem requires the formulation and solution of two distinct market-clearing optimization problems to quantify the economic impact of ignoring energy storage efficiency losses. We will first derive the governing physical and economic constraints from first principles. Then, we will formulate the two linear programming (LP) models: a \"true model\" that accounts for efficiency losses, and a simplified \"ignore-$\\eta_{RT}$ model\" that assumes lossless storage. Finally, we will solve both models for the given test cases and compute the specified metrics: welfare loss and dispatch distance.\n\n### 1. Derivation of Model Constraints\n\nThe system is modeled over a discrete time horizon of $T$ periods, each with a duration of $\\Delta t = 1$ hour. The decision variables for each period $t \\in \\{1,\\dots,T\\}$ are the base generation $g_{b,t}$, peaking generation $g_{p,t}$, storage charging power $u_t$, storage discharging power $v_t$, and the state-of-charge of the storage unit $E_t$.\n\n**State-of-Charge (SOC) Transition Constraint:**\nThis constraint is derived from the principle of conservation of energy applied to the storage device.\n- When charging, the storage device consumes power $u_t$ (in MW) from the grid. Over a period of $\\Delta t = 1$ hour, the energy drawn is $u_t \\times \\Delta t = u_t$ MWh. The charging efficiency $\\eta_c$ is the fraction of this input energy that increases the state-of-charge. Thus, the energy stored is $\\eta_c u_t$.\n- When discharging, the storage device delivers power $v_t$ (in MW) to the grid. Over $\\Delta t = 1$ hour, the energy supplied is $v_t \\times \\Delta t = v_t$ MWh. The discharging efficiency $\\eta_d$ is the fraction of the decrease in state-of-charge that becomes delivered energy. If the state-of-charge decreases by $\\Delta E_{\\text{discharge}, t}$, the delivered energy is $v_t = \\eta_d (\\Delta E_{\\text{discharge}, t} / \\Delta t)$. With $\\Delta t=1$, this gives $\\Delta E_{\\text{discharge}, t} = v_t / \\eta_d$.\n\nCombining these effects, the state-of-charge at the end of period $t$, denoted $E_t$, is related to the state-of-charge at the end of the previous period, $E_{t-1}$, by the following transition equation:\n$$E_t = E_{t-1} + \\eta_c u_t \\Delta t - \\frac{v_t}{\\eta_d} \\Delta t$$\nGiven $\\Delta t = 1$ hour, this simplifies to:\n$$E_t = E_{t-1} + \\eta_c u_t - \\frac{1}{\\eta_d} v_t \\quad \\forall t \\in \\{1, \\dots, T\\}$$\nwhere $E_0$ is the given initial state-of-charge.\n\n**Power Balance Constraint:**\nFor each period $t$, the total power supplied to the grid must equal the total power withdrawn from it.\n- Supply consists of generation from the base unit ($g_{b,t}$), the peaking unit ($g_{p,t}$), and power discharged from storage ($v_t$).\n- Demand consists of the exogenous load ($d_t$) and power consumed by storage for charging ($u_t$).\nThe balance equation is therefore:\n$$g_{b,t} + g_{p,t} + v_t = d_t + u_t \\quad \\forall t \\in \\{1, \\dots, T\\}$$\nThis can be rearranged into a standard form for linear programming:\n$$g_{b,t} + g_{p,t} + v_t - u_t = d_t \\quad \\forall t \\in \\{1, \\dots, T\\}$$\n\n**Cyclic Operation Constraint:**\nThe problem specifies that the storage must operate in a cycle, with its final state-of-charge equal to its initial state-of-charge.\n$$E_T = E_0$$\n\n### 2. Linear Programming Formulations\n\nWith the constraints derived, we can now formulate the two optimization problems. Both problems aim to minimize the total cost of generation over the time horizon.\n\n**Objective Function:**\nThe total cost is the sum of costs from the base and peaking generators over all periods.\n$$\\text{minimize} \\quad \\sum_{t=1}^T (c_b g_{b,t} + c_p g_{p,t})$$\n\n**Decision Variables:**\nThe set of decision variables for both problems is $\\{g_{b,t}, g_{p,t}, u_t, v_t, E_t\\}_{t=1}^T$.\n\n**A. The \"True Model\" (with efficiencies)**\n\nThis model incorporates the efficiencies $\\eta_c$ and $\\eta_d$ as defined.\n\n**Objective:**\n$$\\min_{g_b, g_p, u, v, E} \\sum_{t=1}^T (c_b g_{b,t} + c_p g_{p,t})$$\n\n**Subject to:**\n1.  Power Balance: $g_{b,t} + g_{p,t} + v_t - u_t = d_t$, for $t=1,\\dots,T$.\n2.  SOC Transition: $E_t - E_{t-1} - \\eta_c u_t + \\frac{1}{\\eta_d} v_t = 0$, for $t=1,\\dots,T$ (with $E_0$ as a parameter).\n3.  Cyclic Operation: $E_T = E_0$.\n4.  Generation Limits: $0 \\le g_{b,t} \\le \\overline{G}_b$ and $0 \\le g_{p,t} \\le \\overline{G}_p$, for $t=1,\\dots,T$.\n5.  Storage Power Limits: $0 \\le u_t \\le \\overline{U}$ and $0 \\le v_t \\le \\overline{V}$, for $t=1,\\dots,T$.\n6.  Storage Energy Limits: $0 \\le E_t \\le \\overline{E}$, for $t=1,\\dots,T$.\n\n**B. The \"Ignore-$\\eta_{RT}$ Model\"**\n\nThis model represents a simplified, idealized view where storage is lossless. This is achieved by setting $\\eta_c = 1$ and $\\eta_d = 1$ in the \"true model\" formulation.\n\n**Objective:**\n$$\\min_{g_b, g_p, u, v, E} \\sum_{t=1}^T (c_b g_{b,t} + c_p g_{p,t})$$\n\n**Subject to:**\n1.  Power Balance: $g_{b,t} + g_{p,t} + v_t - u_t = d_t$, for $t=1,\\dots,T$.\n2.  SOC Transition (Lossless): $E_t - E_{t-1} - u_t + v_t = 0$, for $t=1,\\dots,T$ (with $E_0$ as a parameter).\n3.  Cyclic Operation: $E_T = E_0$.\n4.  Generation Limits: $0 \\le g_{b,t} \\le \\overline{G}_b$ and $0 \\le g_{p,t} \\le \\overline{G}_p$, for $t=1,\\dots,T$.\n5.  Storage Power Limits: $0 \\le u_t \\le \\overline{U}$ and $0 \\le v_t \\le \\overline{V}$, for $t=1,\\dots,T$.\n6.  Storage Energy Limits: $0 \\le E_t \\le \\overline{E}$, for $t=1,\\dots,T$.\n\n### 3. Solution Methodology and Metrics\n\nFor each test case, we solve both linear programming problems to find the optimal generation and storage dispatch schedules and the minimum total cost. The `scipy.optimize.linprog` function is used for this purpose.\n\nThe following metrics are calculated to compare the outcomes:\n- **Welfare Loss**: Defined as the difference between the minimized total cost from the \"true model\" ($C^*_{\\text{true}}$) and the minimized total cost from the \"ignore-$\\eta_{RT}$ model\" ($C^*_{\\text{ignore}}$).\n  $$ \\text{Welfare Loss} = C^*_{\\text{true}} - C^*_{\\text{ignore}} $$\n  This quantity reflects the additional system cost incurred due to the physical reality of energy losses in storage, which the idealized model fails to capture.\n\n- **Dispatch Distance**: Defined as the sum of absolute differences in storage dispatch actions (charging and discharging) between the two models, summed over all periods. Let $(u^{\\text{true}}, v^{\\text{true}})$ and $(u^{\\text{ignore}}, v^{\\text{ignore}})$ be the optimal storage dispatches from the respective models.\n  $$ \\text{Dispatch Distance} = \\sum_{t=1}^T \\left( |u^{\\text{true}}_t - u^{\\text{ignore}}_t| + |v^{\\text{true}}_t - v^{\\text{ignore}}_t| \\right) $$\n  This metric quantifies how much the optimal storage operation strategy changes when efficiency losses are taken into account. A larger distance indicates a more significant divergence in operational behavior.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import linprog\n\ndef solve():\n    \"\"\"\n    Main function to solve the market clearing problem for all test cases.\n    \"\"\"\n    test_cases = [\n        # Case 1 (\"happy path\")\n        {\n            \"T\": 3, \"d\": [50, 65, 55], \"Gb_bar\": 60, \"cb\": 40, \"Gp_bar\": 100, \"cp\": 80,\n            \"E_bar\": 40, \"U_bar\": 30, \"V_bar\": 30, \"E0\": 20, \"eta_c\": 0.95, \"eta_d\": 0.90\n        },\n        # Case 2 (\"efficiency boundary\")\n        {\n            \"T\": 3, \"d\": [50, 65, 55], \"Gb_bar\": 60, \"cb\": 40, \"Gp_bar\": 100, \"cp\": 80,\n            \"E_bar\": 40, \"U_bar\": 30, \"V_bar\": 30, \"E0\": 20, \"eta_c\": 1.00, \"eta_d\": 1.00\n        },\n        # Case 3 (\"no storage use\")\n        {\n            \"T\": 3, \"d\": [50, 60, 55], \"Gb_bar\": 60, \"cb\": 40, \"Gp_bar\": 100, \"cp\": 80,\n            \"E_bar\": 0, \"U_bar\": 0, \"V_bar\": 0, \"E0\": 0, \"eta_c\": 0.95, \"eta_d\": 0.90\n        },\n        # Case 4 (\"low efficiency, pronounced shift\")\n        {\n            \"T\": 3, \"d\": [50, 80, 45], \"Gb_bar\": 60, \"cb\": 40, \"Gp_bar\": 100, \"cp\": 100,\n            \"E_bar\": 60, \"U_bar\": 30, \"V_bar\": 30, \"E0\": 30, \"eta_c\": 0.85, \"eta_d\": 0.70\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        # Solve the problem with true efficiencies\n        cost_true, u_true, v_true = run_optimization(case, use_efficiency=True)\n        \n        # Solve the problem ignoring efficiencies (eta_c=1, eta_d=1)\n        cost_ignore, u_ignore, v_ignore = run_optimization(case, use_efficiency=False)\n        \n        # Calculate welfare loss and dispatch distance\n        welfare_loss = cost_true - cost_ignore\n        dispatch_distance = np.sum(np.abs(u_true - u_ignore) + np.abs(v_true - v_ignore))\n        \n        results.extend([welfare_loss, dispatch_distance])\n    \n    # Format and print the final results\n    print(f\"[{','.join(map(str, [f'{r:.10f}'.rstrip('0').rstrip('.') for r in results]))}]\")\n\ndef run_optimization(case_params, use_efficiency):\n    \"\"\"\n    Formulates and solves the linear optimization problem.\n    \"\"\"\n    T = case_params[\"T\"]\n    d = np.array(case_params[\"d\"])\n    Gb_bar, cb = case_params[\"Gb_bar\"], case_params[\"cb\"]\n    Gp_bar, cp = case_params[\"Gp_bar\"], case_params[\"cp\"]\n    E_bar, U_bar, V_bar, E0 = case_params[\"E_bar\"], case_params[\"U_bar\"], case_params[\"V_bar\"], case_params[\"E0\"]\n    \n    if use_efficiency:\n        eta_c, eta_d = case_params[\"eta_c\"], case_params[\"eta_d\"]\n    else:\n        eta_c, eta_d = 1.0, 1.0\n\n    # Decision variables are ordered as: [g_b, g_p, u, v, E]\n    # Each block is a vector of length T. Total variables num_vars = 5 * T.\n    num_vars = 5 * T\n    \n    # --- Objective Function ---\n    # min sum(cb*g_b_t + cp*g_p_t)\n    c = np.zeros(num_vars)\n    c[0:T] = cb          # Costs for base generator\n    c[T:2*T] = cp        # Costs for peaking generator\n\n    # --- Equality Constraints (A_eq * x = b_eq) ---\n    num_eq_constraints = 2 * T + 1\n    A_eq = np.zeros((num_eq_constraints, num_vars))\n    b_eq = np.zeros(num_eq_constraints)\n    \n    # 1. Power balance constraints: g_b_t + g_p_t + v_t - u_t = d_t\n    for t in range(T):\n        A_eq[t, t] = 1        # g_b_t\n        A_eq[t, T + t] = 1    # g_p_t\n        A_eq[t, 2*T + t] = -1 # u_t\n        A_eq[t, 3*T + t] = 1  # v_t\n        b_eq[t] = d[t]\n        \n    # 2. SOC transition constraints: E_t - E_{t-1} - eta_c*u_t + (1/eta_d)*v_t = 0\n    for t in range(T):\n        row_idx = T + t\n        A_eq[row_idx, 4*T + t] = 1          # E_t\n        if t > 0:\n            A_eq[row_idx, 4*T + t - 1] = -1 # -E_{t-1}\n        \n        A_eq[row_idx, 2*T + t] = -eta_c      # -eta_c * u_t\n        if eta_d > 0:\n          A_eq[row_idx, 3*T + t] = 1/eta_d # (1/eta_d) * v_t\n        \n        if t == 0:\n            b_eq[row_idx] = E0 # E_1 - eta_c*u_1 + ... = E_0\n        # else, b_eq is already 0\n    \n    # 3. Cyclic operation: E_T = E_0\n    A_eq[2*T, 5*T - 1] = 1 # E_T\n    b_eq[2*T] = E0\n    \n    # --- Bounds ---\n    bounds = []\n    # g_b bounds\n    bounds.extend([(0, Gb_bar)] * T)\n    # g_p bounds\n    bounds.extend([(0, Gp_bar)] * T)\n    # u bounds\n    bounds.extend([(0, U_bar)] * T)\n    # v bounds\n    bounds.extend([(0, V_bar)] * T)\n    # E bounds\n    bounds.extend([(0, E_bar)] * T)\n\n    # --- Solve LP ---\n    res = linprog(c, A_eq=A_eq, b_eq=b_eq, bounds=bounds, method='highs')\n    \n    if not res.success:\n        raise ValueError(f\"Optimization failed: {res.message}\")\n    \n    optimal_cost = res.fun\n    x = res.x\n    \n    # Extract u and v from the solution vector\n    u_opt = x[2*T : 3*T]\n    v_opt = x[3*T : 4*T]\n    \n    # Handle near-zero values from solver\n    u_opt[np.isclose(u_opt, 0)] = 0\n    v_opt[np.isclose(v_opt, 0)] = 0\n\n    return optimal_cost, u_opt, v_opt\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "In real-world applications, model parameters like efficiency are rarely known with perfect certainty. This final practice introduces you to robust optimization, a powerful technique for making reliable decisions in the face of uncertainty. You will determine the optimal charging strategy that guarantees a required energy delivery even under the worst-case realization of charging efficiency $\\eta_c$ and discharging efficiency $\\eta_d$, thereby deriving a conservative and reliable representation of round-trip efficiency.",
            "id": "4120249",
            "problem": "Consider a single-cycle model of an energy storage device, with one charging action followed by one discharging action, operating over two decision epochs. Let the State of Charge (SoC) be denoted by $s$, with $s_0$ the initial SoC before charging, $s_1$ the SoC after charging, and $s_2$ the SoC after discharging. Let $u_c \\geq 0$ denote the charging energy input from the grid to the device, and let $u_d \\geq 0$ denote the discharging energy output from the device to the grid. Assume zero self-discharge and no exogenous losses other than charging and discharging inefficiencies. The First Law of Thermodynamics implies conservation of energy, and charging and discharging efficiencies are defined by\n$$\ns_1 \\;=\\; s_0 \\;+\\; \\eta_c\\,u_c, \\qquad s_2 \\;=\\; s_1 \\;-\\; \\frac{u_d}{\\eta_d},\n$$\nwhere $\\eta_c \\in (0,1]$ is the charging efficiency and $\\eta_d \\in (0,1]$ is the discharging efficiency. Let the delivered energy requirement be $E \\gt 0$ (to the grid) in the discharging epoch. We take the robust optimization perspective in which the efficiencies are uncertain but bounded in compact sets:\n$$\n\\eta_c \\in \\mathcal{U}_c, \\qquad \\eta_d \\in \\mathcal{U}_d,\n$$\nwith $\\mathcal{U}_c = [\\hat{\\eta}_c - \\delta_c,\\, \\hat{\\eta}_c + \\delta_c]$ and $\\mathcal{U}_d = [\\hat{\\eta}_d - \\delta_d,\\, \\hat{\\eta}_d + \\delta_d]$, where $0 \\lt \\hat{\\eta}_c - \\delta_c \\leq \\hat{\\eta}_c + \\delta_c \\leq 1$ and $0 \\lt \\hat{\\eta}_d - \\delta_d \\leq \\hat{\\eta}_d + \\delta_d \\leq 1$. Assume $s_0 = 0$ and impose cycle closure $s_2 \\geq 0$ after discharge, allowing a nonnegative terminal SoC. Decisions are taken in two stages: the first-stage (here-and-now) decision chooses $u_c$, and the second-stage (recourse) decision chooses $u_d$ after $(\\eta_c,\\eta_d)$ are realized, subject to the physical constraints above.\n\nFormulate the two-stage robust optimization problem that minimizes the first-stage energy input $u_c$ while guaranteeing that for all $(\\eta_c,\\eta_d) \\in \\mathcal{U}_c \\times \\mathcal{U}_d$, there exists a feasible recourse $u_d$ that both satisfies $u_d \\geq E$ and respects energy conservation and nonnegativity of the terminal SoC. Starting from fundamental definitions and the First Law of Thermodynamics, derive the worst-case recourse dispatch rule $u_d^{\\star}(\\eta_c,\\eta_d)$ implied by cycle closure and the guaranteed delivered energy requirement, and use it to obtain the implied conservative representation of the round-trip efficiency, defined for the single-cycle by\n$$\n\\eta_{RT} \\;=\\; \\frac{\\text{delivered energy}}{\\text{input charging energy}} \\;=\\; \\frac{u_d}{u_c}.\n$$\n\nYour final answer must be a single closed-form analytic expression for the conservative round-trip efficiency $\\eta_{RT}$ in terms of $\\hat{\\eta}_c$, $\\hat{\\eta}_d$, $\\delta_c$, and $\\delta_d$. No numerical evaluation is required. Express the final conservative round-trip efficiency as a dimensionless quantity. Do not include any unit symbols.",
            "solution": "The problem asks for the derivation of a conservative representation for the round-trip efficiency, $\\eta_{RT}$, of an energy storage device within a two-stage robust optimization framework. We begin by formally stating the problem and then proceed with a step-by-step derivation.\n\nThe problem is to minimize the first-stage (here-and-now) energy input decision, $u_c$, while ensuring that for any realization of the uncertain efficiencies $(\\eta_c, \\eta_d)$ within their respective uncertainty sets, a feasible second-stage (recourse) energy dispatch, $u_d$, exists. A feasible recourse action must satisfy both the delivered energy requirement and the physical constraints of the system.\n\nThe two-stage robust optimization problem can be formulated as:\n$$\n\\min_{u_c \\geq 0} u_c\n$$\nsubject to:\n$$\n\\forall (\\eta_c, \\eta_d) \\in \\mathcal{U}_c \\times \\mathcal{U}_d, \\quad \\exists u_d \\text{ such that }\n\\begin{cases}\nu_d \\geq E \\\\\nu_d \\geq 0 \\\\\ns_2 \\geq 0\n\\end{cases}\n$$\n\nThe state of charge, $s_2$, after discharging is governed by the system dynamics. With an initial state of charge $s_0=0$, the state after charging is $s_1 = s_0 + \\eta_c u_c = \\eta_c u_c$. The state after discharging is $s_2 = s_1 - \\frac{u_d}{\\eta_d} = \\eta_c u_c - \\frac{u_d}{\\eta_d}$.\n\nThe constraint $s_2 \\geq 0$ thus translates to $\\eta_c u_c - \\frac{u_d}{\\eta_d} \\geq 0$. Rearranging this inequality gives an upper bound on the dispatchable energy $u_d$:\n$$\nu_d \\leq \\eta_c \\eta_d u_c\n$$\n\nFor a given first-stage decision $u_c$ and a realization of $(\\eta_c, \\eta_d)$, the existence of a feasible recourse action $u_d$ requires that there is at least one value of $u_d$ that satisfies both the delivery requirement $u_d \\geq E$ and the physical limit $u_d \\leq \\eta_c \\eta_d u_c$. In other words, the interval of feasible $u_d$ values, $[E, \\eta_c \\eta_d u_c]$, must be non-empty. This is true if and only if the lower bound is less than or equal to the upper bound:\n$$\nE \\leq \\eta_c \\eta_d u_c\n$$\nThis condition must hold robustly, i.e., for all possible realizations of the efficiencies $(\\eta_c, \\eta_d)$ in the uncertainty set $\\mathcal{U}_c \\times \\mathcal{U}_d$. Therefore, the first-stage decision $u_c$ must satisfy:\n$$\nE \\leq \\min_{(\\eta_c, \\eta_d) \\in \\mathcal{U}_c \\times \\mathcal{U}_d} (\\eta_c \\eta_d u_c)\n$$\nSince $u_c$ is a non-negative constant with respect to the uncertainty realization, we can factor it out of the minimization:\n$$\nE \\leq u_c \\left( \\min_{(\\eta_c, \\eta_d) \\in \\mathcal{U}_c \\times \\mathcal{U}_d} (\\eta_c \\eta_d) \\right)\n$$\nAssuming $u_c > 0$ (since $E>0$), we can rewrite this as a lower bound on $u_c$:\n$$\nu_c \\geq \\frac{E}{\\min_{(\\eta_c, \\eta_d) \\in \\mathcal{U}_c \\times \\mathcal{U}_d} (\\eta_c \\eta_d)}\n$$\nTo solve the minimization problem for $u_c$, we must find the minimum value of the product $\\eta_c \\eta_d$. The uncertainty sets are given as $\\mathcal{U}_c = [\\hat{\\eta}_c - \\delta_c, \\hat{\\eta}_c + \\delta_c]$ and $\\mathcal{U}_d = [\\hat{\\eta}_d - \\delta_d, \\hat{\\eta}_d + \\delta_d]$. Since the efficiencies are strictly positive ($0 < \\eta_c \\leq 1$ and $0 < \\eta_d \\leq 1$), the minimum of their product is the product of their individual minima.\n$$\n\\min_{\\eta_c \\in \\mathcal{U}_c} \\eta_c = \\hat{\\eta}_c - \\delta_c\n$$\n$$\n\\min_{\\eta_d \\in \\mathcal{U}_d} \\eta_d = \\hat{\\eta}_d - \\delta_d\n$$\nTherefore, the minimum of the product is:\n$$\n\\min_{(\\eta_c, \\eta_d) \\in \\mathcal{U}_c \\times \\mathcal{U}_d} (\\eta_c \\eta_d) = (\\hat{\\eta}_c - \\delta_c)(\\hat{\\eta}_d - \\delta_d)\n$$\nThe objective is to minimize $u_c$. The optimal first-stage decision, $u_c^{\\star}$, is the smallest possible value of $u_c$ that satisfies the robust constraint. This is achieved by setting the inequality to an equality:\n$$\nu_c^{\\star} = \\frac{E}{(\\hat{\\eta}_c - \\delta_c)(\\hat{\\eta}_d - \\delta_d)}\n$$\nThis is the minimum energy that must be injected into the storage device to guarantee that an amount of energy $E$ can be delivered to the grid, regardless of where the efficiencies fall within their uncertainty sets.\n\nThe problem asks for the conservative representation of the round-trip efficiency, $\\eta_{RT}$, defined as $\\frac{u_d}{u_c}$. In the context of this robust optimization problem, a conservative representation of efficiency for the overall strategy is the ratio of the guaranteed energy delivered to the required energy input. The guaranteed delivered energy is $E$, and the required input to ensure this guarantee is $u_c^{\\star}$.\n$$\n\\eta_{RT} = \\frac{E}{u_c^{\\star}}\n$$\nSubstituting the expression for $u_c^{\\star}$:\n$$\n\\eta_{RT} = \\frac{E}{\\frac{E}{(\\hat{\\eta}_c - \\delta_c)(\\hat{\\eta}_d - \\delta_d)}}\n$$\n$$\n\\eta_{RT} = (\\hat{\\eta}_c - \\delta_c)(\\hat{\\eta}_d - \\delta_d)\n$$\nThis result corresponds to the round-trip efficiency under the worst-case realization of efficiencies, which is the scenario that dictates the required size of the energy input $u_c^{\\star}$. In this worst-case scenario, where $\\eta_c = \\hat{\\eta}_c - \\delta_c$ and $\\eta_d = \\hat{\\eta}_d - \\delta_d$, the upper bound on the dispatchable energy becomes $u_{d, \\text{max}} = (\\hat{\\eta}_c - \\delta_c)(\\hat{\\eta}_d - \\delta_d) u_c^{\\star} = E$. The feasible interval for $u_d$ collapses to a single point, $[E, E]$, forcing the recourse dispatch to be exactly $u_d=E$. The efficiency of this specific transaction is $(\\hat{\\eta}_c - \\delta_c)(\\hat{\\eta}_d - \\delta_d)$, which represents the conservative efficiency of the robust strategy.",
            "answer": "$$\n\\boxed{(\\hat{\\eta}_c - \\delta_c)(\\hat{\\eta}_d - \\delta_d)}\n$$"
        }
    ]
}