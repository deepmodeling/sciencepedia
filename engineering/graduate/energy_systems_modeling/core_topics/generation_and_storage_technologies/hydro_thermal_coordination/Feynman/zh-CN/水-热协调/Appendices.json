{
    "hands_on_practices": [
        {
            "introduction": "“水价值”的概念是优化水火协调系统的核心，它代表了水库中蓄水的边际经济价值。第一个练习提供了一个在简化的两阶段模型中对该价值进行具体、动手计算的机会。通过解决这个问题，您将对如何在水火协调中量化地平衡跨期权衡建立起基本的直觉。",
            "id": "4095243",
            "problem": "考虑一个两周期水火电协调（HTC）问题，该问题存在于一个含有一个水电机组和一个火电机组的能源系统中。周期由 $t \\in \\{1,2\\}$ 索引。目标是调度水电和火电发电，以满足各周期的需求，同时最小化火电发电成本。水力发电是无成本的，但受到可用水资源、转换效率和水轮机容量限制的约束。\n\n在周期 $t$ 中，火电机组产生 $g_t$ 的电量，其成本函数为凸函数 $C_t(g_t) = a_t g_t^2 + b_t g_t$，其中 $a_t > 0$ 且 $b_t \\geq 0$。在周期 $t$ 中，水电机组产生 $h_t$ 的电量，使用的水量为 $v_t$，它们之间的关系为 $h_t = k v_t$，其中 $k \\in (0,1]$ 是一个固定的转换效率。每个周期的需求平衡要求 $g_t + h_t = D_t$，其中给定的 $D_t > 0$。每个周期的水轮机容量限制为 $0 \\leq h_t \\leq H_t^{\\max}$。\n\n跨期水量平衡由初始蓄水量 $S_1$、在各周期调度前实现的外部入流量 $I_1$ 和 $I_2$ 以及在周期 2 结束时要求的期末蓄水量 $\\bar{S}$ 给出。假设没有弃水，两个周期内可用于发电的总水量为\n$$W = S_1 + I_1 + I_2 - \\bar{S},$$\n且总水力发电量满足\n$$\\frac{h_1}{k} + \\frac{h_2}{k} \\leq W.$$\n\n给定以下参数：\n- $D_1 = 90$, $D_2 = 110$,\n- $a_1 = 0.02$, $b_1 = 12$；$a_2 = 0.015$, $b_2 = 10$,\n- $k = 0.9$,\n- $S_1 = 50$, $I_1 = 20$, $I_2 = 10$, $\\bar{S} = 15$,\n- $H_1^{\\max} = 80$, $H_2^{\\max} = 80$.\n\n构建以总火电成本最小化为目标，并受限于各周期需求平衡和总水量约束的优化问题。然后，根据凸经济调度的基本最优性原理进行推理，计算在给定蓄水水平 $S_1$ 下的水的价值，该价值定义为总用水量约束上的拉格朗日乘子，以每单位水量的货币单位表示。\n\n将您的最终数值答案四舍五入到四位有效数字，并以每单位水量的货币单位表示。",
            "solution": "首先验证问题，以确保其科学上合理、适定且客观。\n\n**步骤1：提取已知条件**\n- **周期：** $t \\in \\{1, 2\\}$。\n- **火电发电量：** $g_t$ 在周期 $t$。\n- **火电成本：** $C_t(g_t) = a_t g_t^2 + b_t g_t$，其中 $a_t > 0$, $b_t \\geq 0$。\n- **水电发电量：** $h_t$ 在周期 $t$。\n- **水电效率：** $h_t = k v_t$，其中 $v_t$ 是水量，$k \\in (0,1]$ 是效率。\n- **需求平衡：** $g_t + h_t = D_t$，其中 $D_t > 0$。\n- **水电容量：** $0 \\leq h_t \\leq H_t^{\\max}$。\n- **水量平衡：** 可用于发电的总水量为 $W = S_1 + I_1 + I_2 - \\bar{S}$。\n- **总水量约束：** $\\frac{h_1}{k} + \\frac{h_2}{k} \\leq W$。\n- **参数：**\n  - $D_1 = 90$, $D_2 = 110$。\n  - $a_1 = 0.02$, $b_1 = 12$。\n  - $a_2 = 0.015$, $b_2 = 10$。\n  - $k = 0.9$。\n  - $S_1 = 50$, $I_1 = 20$, $I_2 = 10$, $\\bar{S} = 15$。\n  - $H_1^{\\max} = 80$, $H_2^{\\max} = 80$。\n- **目标：** 最小化总火电成本 $\\sum_{t=1}^2 C_t(g_t)$ 并求出水的价值，即总水量约束上的拉格朗日乘子。\n\n**步骤2：验证**\n该问题描述了一个经典的水火电协调（HTC）场景，这是能源系统工程中一个标准且被深入理解的课题。目标函数是凸二次函数，约束是线性的，构成一个适定且保证有唯一解的凸优化问题。所有参数都已提供，没有内部矛盾、科学不准确之处或模糊的陈述。因此，该问题被认为是**有效的**。\n\n**问题建模**\n目标是最小化两个周期内的总火电成本：\n$$ \\min_{g_1, g_2, h_1, h_2} \\sum_{t=1}^{2} C_t(g_t) = C_1(g_1) + C_2(g_2) $$\n使用需求平衡方程 $g_t = D_t - h_t$，我们可以将成本完全用 水电发电量 $h_t$ 来表示：\n$$ \\min_{h_1, h_2} \\sum_{t=1}^{2} C_t(D_t - h_t) = \\left(a_1(D_1 - h_1)^2 + b_1(D_1 - h_1)\\right) + \\left(a_2(D_2 - h_2)^2 + b_2(D_2 - h_2)\\right) $$\n此最小化问题受一组约束条件的限制。\n首先，用于发电的总水量不能超过可用的总水量。用水量为 $v_t = h_t/k$。因此，总水量约束为：\n$$ \\frac{h_1}{k} + \\frac{h_2}{k} \\leq W $$\n可用的总水量 $W$ 根据给定的蓄水量和入流量数据计算得出：\n$$ W = S_1 + I_1 + I_2 - \\bar{S} = 50 + 20 + 10 - 15 = 65 $$\n代入 $k=0.9$ 和 $W=65$，对总水电能量的约束变为：\n$$ h_1 + h_2 \\leq k W = 0.9 \\times 65 = 58.5 $$\n其次，每个周期的水力发电量受水轮机容量的限制，并且也不能超过需求（因为火电发电量 $g_t$ 必须为非负数，即 $g_t=D_t-h_t \\geq 0$）。\n对于周期 1：$0 \\leq h_1 \\leq \\min(D_1, H_1^{\\max}) = \\min(90, 80) = 80$。\n对于周期 2：$0 \\leq h_2 \\leq \\min(D_2, H_2^{\\max}) = \\min(110, 80) = 80$。\n\n完整的优化问题是：\n$$ \\min_{h_1, h_2} \\left[ a_1(D_1 - h_1)^2 + b_1(D_1 - h_1) + a_2(D_2 - h_2)^2 + b_2(D_2 - h_2) \\right] $$\n约束条件为：\n$$ h_1 + h_2 \\leq 58.5 \\quad (\\text{拉格朗日乘子为 } \\lambda_E) $$\n$$ 0 \\leq h_1 \\leq 80 $$\n$$ 0 \\leq h_2 \\leq 80 $$\n问题要求解“水的价值”，即水量约束 $\\frac{h_1+h_2}{k} \\leq W$ 上的拉格朗日乘子。我们称此乘子为 $\\lambda$。对水电能量的约束 $h_1+h_2 \\leq kW$ 会有一个乘子 $\\lambda_E$。这两个乘子之间的关系是 $\\lambda = k \\lambda_E$，因为一个边际单位的水量 $W$ 提供 $k$ 个边际单位的能量 $kW$。我们需要求解的是 $\\lambda$。\n\n**最优性条件**\n设 $J(h_1, h_2)$ 为目标函数。这是一个凸问题，因此 Karush-Kuhn-Tucker (KKT) 条件是最优性的充分必要条件。经济调度的核心原则是，资源的分配应使其在所有用途中的边际效益相等。在这里，“资源”是总水电能量，“用途”是周期 1 和周期 2 的发电。\n\n在周期 $t$ 使用水力发电的边际效益是所避免的火电发电的边际成本。火电发电的边际成本是 $C'_t(g_t) = 2a_t g_t + b_t$。因此，避免的成本，即水电的边际效益是：\n$$ \\beta_t(h_t) = -\\frac{\\partial J}{\\partial h_t} = - \\frac{d C_t(D_t - h_t)}{d h_t} = - [2a_t(D_t - h_t)(-1) + b_t(-1)] = 2a_t(D_t - h_t) + b_t $$\n使用水电能量的边际机会成本是其影子价格 $\\lambda_E = \\lambda/k$。在最优点，如果水电发电量 $h_1^*$ 和 $h_2^*$ 未达到其边界，则必须满足：\n$$ \\beta_1(h_1^*) = \\beta_2(h_2^*) = \\lambda_E = \\frac{\\lambda}{k} $$\n\n**求解最优调度**\n让我们用给定的参数计算边际效益函数：\n对于周期 1：\n$$ \\beta_1(h_1) = 2(0.02)(90 - h_1) + 12 = 0.04(90 - h_1) + 12 = 3.6 - 0.04h_1 + 12 = 15.6 - 0.04h_1 $$\n对于周期 2：\n$$ \\beta_2(h_2) = 2(0.015)(110 - h_2) + 10 = 0.03(110 - h_2) + 10 = 3.3 - 0.03h_2 + 10 = 13.3 - 0.03h_2 $$\n\n我们必须检查水量约束 $h_1 + h_2 \\leq 58.5$ 是否为紧约束。可能的最大水电发电量远大于可用水量（$80+80=160 > 58.5$）。此外，对于任何可行的 $h_t \\in [0, 80]$，边际效益 $\\beta_t(h_t)$ 均为正。例如，在周期 1 的最大水电用量时，$\\beta_1(80) = 15.6 - 0.04(80) = 12.4 > 0$。这意味着使用水电总是能节约成本。因此，所有可用的水都将被使用，水量约束是紧约束：\n$$ h_1 + h_2 = 58.5 $$\n在这种情况下，水力发电受限于可用水量，而不是水轮机容量。最优调度将满足以下两个方程组：\n1. $h_1 + h_2 = 58.5$\n2. $\\beta_1(h_1) = \\beta_2(h_2) \\implies 15.6 - 0.04h_1 = 13.3 - 0.03h_2$\n\n由方程(1)可得 $h_2 = 58.5 - h_1$。将其代入方程(2)：\n$$ 15.6 - 0.04h_1 = 13.3 - 0.03(58.5 - h_1) $$\n$$ 15.6 - 0.04h_1 = 13.3 - 1.755 + 0.03h_1 $$\n$$ 15.6 - 0.04h_1 = 11.545 + 0.03h_1 $$\n$$ 15.6 - 11.545 = 0.04h_1 + 0.03h_1 $$\n$$ 4.055 = 0.07h_1 $$\n$$ h_1 = \\frac{4.055}{0.07} \\approx 57.92857 $$\n然后，$h_2 = 58.5 - h_1 = 58.5 - 57.92857 \\approx 0.57143$。\n$h_1$ 和 $h_2$ 都在各自的边界 $[0, 80]$ 内，因此该解是可行的。\n\n**计算水的价值**\n水电能量的影子价格 $\\lambda_E$ 是最优调度时的共同边际效益：\n$$ \\lambda_E = \\beta_1(h_1) = 15.6 - 0.04 \\left(\\frac{4.055}{0.07}\\right) = 15.6 - \\frac{0.1622}{0.07} \\approx 15.6 - 2.31714 = 13.28286 $$\n我们可以用 $\\beta_2(h_2)$ 进行验证：\n$$ \\lambda_E = \\beta_2(h_2) = 13.3 - 0.03 (58.5 - \\frac{4.055}{0.07}) = 13.3 - 1.755 + 0.03 \\left(\\frac{4.055}{0.07}\\right) = 11.545 + \\frac{0.12165}{0.07} \\approx 11.545 + 1.73786 = 13.28286 $$\n数值匹配。$\\lambda_E$ 的单位是每单位能量的货币单位（例如，\\$/MWh）。\n问题要求解的是水的价值 $\\lambda$，即水量约束 $\\frac{h_1+h_2}{k} \\leq W$ 的拉格朗日乘子。它与 $\\lambda_E$ 的关系为 $\\lambda = k \\lambda_E$。\n$$ \\lambda = k \\times \\lambda_E = 0.9 \\times 13.28286 \\approx 11.954574 $$\n四舍五入到四位有效数字，我们得到：\n$$ \\lambda = 11.95 $$\n这个值代表了蓄存中额外一单位水量的边际价值，以货币单位表示。",
            "answer": "$$\\boxed{11.95}$$"
        },
        {
            "introduction": "虽然简单的模型假设水电生产是线性的，但现实世界中的水电出力是水流量和水头的非凸函数，这给优化带来了挑战。本练习将深入探讨一种强大的技术，即 McCormick 松弛，以创建这种非凸关系的易于处理的线性近似。掌握这种推导和应用是构建更现实、更可解的水火协调模型的关键。",
            "id": "4095183",
            "problem": "考虑双线性函数 $z = x y$，其中决策变量 $x$ 和 $y$ 的界限为 $x \\in [x_{\\min}, x_{\\max}]$ 和 $y \\in [y_{\\min}, y_{\\max}]$，且满足 $x_{\\min} \\le x_{\\max}$ 和 $y_{\\min} \\le y_{\\max}$。在能源系统的水火电协调模型中，短时间间隔内的水力发电可以建模为 $P_t = \\eta \\rho g Q_t H_t$，其中 $P_t$ 是功率，$\\eta$ 是水轮发电机效率，$\\rho$ 是水的密度， $g$ 是重力加速度，$Q_t$ 是涡轮机流量，$H_t$ 是净水头。由于乘积 $Q_t H_t$ 是双线性的，因而是非凸的，因此使用凸松弛将水力发电嵌入到易于求解的优化模型中。\n\n从凸性、线性的基本性质以及非负实数之积为非负这一事实出发，推导对于矩形区域 $[x_{\\min}, x_{\\max}] \\times [y_{\\min}, y_{\\max}]$ 内的所有 $(x,y)$ 都成立的 $z=xy$ 的最紧线性上估计和最紧线性下估计对。然后，通过令 $x = Q_t$、$y = H_t$ 和 $z = Q_t H_t$，并乘以正常数 $\\kappa = \\eta \\rho g$，将您的结果应用于水力发电函数。\n\n最后，考虑一个在时间 $t$ 的单一水力发电厂，其效率 $\\eta = 0.90$，水的密度 $\\rho = 1000 \\ \\mathrm{kg/m^3}$，重力加速度 $g = 9.81 \\ \\mathrm{m/s^2}$，流量界限 $Q_t \\in [120, 280] \\ \\mathrm{m^3/s}$，水头界限 $H_t \\in [70, 110] \\ \\mathrm{m}$，以及一个运行点 $(Q_t, H_t) = (200, 90)$。仅使用您推导出的线性上估计和 $\\kappa$ 的正性，计算在该运行点上水力发电功率 $P_t$ 的最紧的基于麦考密克（McCormick）方法的上限。以 $\\mathrm{MW}$ 为单位表示最终功率，并将您的答案四舍五入到 $4$ 位有效数字。",
            "solution": "该问题分三部分解决：首先，推导双线性项 $z=xy$ 的通用麦考密克包络；其次，将这些结果应用于水力发电函数；第三，针对给定的参数和运行点，进行最紧上限的数值计算。\n\n第1部分：麦考密克包络的推导\n设 $z=xy$ 是一个双线性函数，其中变量 $x$ 和 $y$ 定义在一个矩形域上，$x \\in [x_{\\min}, x_{\\max}]$ 和 $y \\in [y_{\\min}, y_{\\max}]$。最紧的线性估计构成了函数 $z$ 在此域上的凸包络和凹包络。这些被称为麦考密克包络。它们可以从一个基本性质推导出来，即两个非负数或两个非正数之积为非负。\n\n根据 $x$ 和 $y$ 的界限，我们可以构造以下差值，它们在整个域上具有确定的符号：\n$x - x_{\\min} \\ge 0$\n$x_{\\max} - x \\ge 0$\n$y - y_{\\min} \\ge 0$\n$y_{\\max} - y \\ge 0$\n\n我们可以用四种方式组合这些项以产生非负乘积。每种组合都产生四个线性边界不等式之一。\n\n下估计的推导（构成凸包络）：\n1.  考虑两个非负项的乘积：$(x - x_{\\min})(y - y_{\\min}) \\ge 0$。\n展开此不等式可得：\n$xy - x y_{\\min} - y x_{\\min} + x_{\\min}y_{\\min} \\ge 0$\n代入 $z=xy$ 并重新整理，我们得到第一个线性下估计：\n$$z \\ge x_{\\min}y + y_{\\min}x - x_{\\min}y_{\\min}$$\n\n2.  考虑另外两个非负项的乘积：$(x_{\\max} - x)(y_{\\max} - y) \\ge 0$。\n展开此不等式可得：\n$x_{\\max}y_{\\max} - x_{\\max}y - xy_{\\max} + xy \\ge 0$\n代入 $z=xy$ 并重新整理，我们得到第二个线性下估计：\n$$z \\ge x_{\\max}y + y_{\\max}x - x_{\\max}y_{\\max}$$\n\n上估计的推导（构成凹包络）：\n3.  考虑两个非负项的乘积：$(x_{\\max} - x)(y - y_{\\min}) \\ge 0$。\n展开此不等式可得：\n$x_{\\max}y - x_{\\max}y_{\\min} - xy + xy_{\\min} \\ge 0$\n代入 $z=xy$ 并重新整理，我们得到第一个线性上估计：\n$$z \\le x_{\\max}y + y_{\\min}x - x_{\\max}y_{\\min}$$\n\n4.  考虑另外两个非负项的乘积：$(x - x_{\\min})(y_{\\max} - y) \\ge 0$。\n展开此不等式可得：\n$xy_{\\max} - xy - x_{\\min}y_{\\max} + x_{\\min}y \\ge 0$\n代入 $z=xy$ 并重新整理，我们得到第二个线性上估计：\n$$z \\le x_{\\min}y + y_{\\max}x - x_{\\min}y_{\\max}$$\n\n这四个不等式构成了函数 $z=xy$ 在指定矩形域上的最紧线性的下估计和上估计。\n\n第2部分：应用于水力发电\n水力发电函数由 $P_t = \\eta \\rho g Q_t H_t$ 给出。设正常数 $\\kappa = \\eta \\rho g$。则函数为 $P_t = \\kappa Q_t H_t$。\n我们将变量关联如下：\n$x \\to Q_t$，界限为 $[Q_{\\min}, Q_{\\max}]$\n$y \\to H_t$，界限为 $[H_{\\min}, H_{\\max}]$\n$z \\to Q_t H_t$\n\n将这些代入四个推导出的不等式中，并乘以正常数 $\\kappa$（这会保持不等式的方向），我们得到水力发电功率 $P_t$ 的线性界限：\n$P_t$ 的下估计：\n$$P_t \\ge \\kappa (Q_{\\min}H_t + H_{\\min}Q_t - Q_{\\min}H_{\\min})$$\n$$P_t \\ge \\kappa (Q_{\\max}H_t + H_{\\max}Q_t - Q_{\\max}H_{\\max})$$\n$P_t$ 的上估计：\n$$P_t \\le \\kappa (Q_{\\max}H_t + H_{\\min}Q_t - Q_{\\max}H_{\\min})$$\n$$P_t \\le \\kappa (Q_{\\min}H_t + H_{\\max}Q_t - Q_{\\min}H_{\\max})$$\n\n第3部分：数值计算\n问题提供了以下数值：\n$\\eta = 0.90$\n$\\rho = 1000 \\, \\mathrm{kg/m^3}$\n$g = 9.81 \\, \\mathrm{m/s^2}$\n$Q_t$ 界限：$[Q_{\\min}, Q_{\\max}] = [120, 280] \\, \\mathrm{m^3/s}$\n$H_t$ 界限：$[H_{\\min}, H_{\\max}] = [70, 110] \\, \\mathrm{m}$\n运行点：$(Q_t, H_t) = (200, 90)$\n\n首先，我们计算常数 $\\kappa$：\n$\\kappa = \\eta \\rho g = 0.90 \\times 1000 \\times 9.81 = 8829 \\, \\mathrm{N/m^3}$。\n$\\kappa Q_t H_t$ 的单位是 $(\\mathrm{N/m^3}) \\times (\\mathrm{m^3/s}) \\times (\\mathrm{m}) = \\mathrm{N \\cdot m/s} = \\mathrm{J/s} = \\mathrm{W}$。\n\n我们需要计算在指定运行点上的最紧上限。这是两个上估计线性函数在该点产生的值的最小值。设这两个上估计为 $P_{t, \\text{upper1}}$ 和 $P_{t, \\text{upper2}}$。\n\n$P_{t, \\text{upper1}} = \\kappa (Q_{\\max}H_t + H_{\\min}Q_t - Q_{\\max}H_{\\min})$\n$P_{t, \\text{upper2}} = \\kappa (Q_{\\min}H_t + H_{\\max}Q_t - Q_{\\min}H_{\\max})$\n\n我们在 $(Q_t, H_t) = (200, 90)$ 处对它们进行求值：\n$Q_{\\min} = 120$, $Q_{\\max} = 280$, $H_{\\min} = 70$, $H_{\\max} = 110$。\n\n对于 $P_{t, \\text{upper1}}$：\n$P_{t, \\text{upper1}} = 8829 \\times (280 \\times 90 + 70 \\times 200 - 280 \\times 70)$\n$P_{t, \\text{upper1}} = 8829 \\times (25200 + 14000 - 19600)$\n$P_{t, \\text{upper1}} = 8829 \\times (19600)$\n$P_{t, \\text{upper1}} = 173048400 \\, \\mathrm{W}$\n\n对于 $P_{t, \\text{upper2}}$：\n$P_{t, \\text{upper2}} = 8829 \\times (120 \\times 90 + 110 \\times 200 - 120 \\times 110)$\n$P_{t, \\text{upper2}} = 8829 \\times (10800 + 22000 - 13200)$\n$P_{t, \\text{upper2}} = 8829 \\times (19600)$\n$P_{t, \\text{upper2}} = 173048400 \\, \\mathrm{W}$\n\n这两个上估计在该特定运行点产生相同的值。这意味着该点位于两个边界平面的交线上。因此，在该点的最紧的基于麦考密克的上限是 $173,048,400 \\, \\mathrm{W}$。\n\n最终答案必须以兆瓦（MW）为单位，其中 $1 \\, \\mathrm{MW} = 10^6 \\, \\mathrm{W}$。\n$P_{\\text{bound}} = \\frac{173048400}{10^6} \\, \\mathrm{MW} = 173.0484 \\, \\mathrm{MW}$。\n\n四舍五入到 $4$ 位有效数字，我们得到 $173.0 \\, \\mathrm{MW}$。",
            "answer": "$$\n\\boxed{173.0}\n$$"
        },
        {
            "introduction": "水火调度必须应对未来的不确定性，主要体现在来水和需求上。随机对偶动态规划（SDDP）是解决此任务的基准算法，它通过迭代构建水价值函数的近似值。最后一个练习将指导您编写一个基础的SDDP迭代过程，将水价值的理论概念与其在随机优化框架中的实际应用联系起来。",
            "id": "4095233",
            "problem": "考虑一个为随机对偶动态规划（SDDP）单次迭代而构建的两阶段水火电协调问题。每个阶段的决策变量为水电释放量 $r_t$、火电发电量 $g_t$、弃水量 $s_t$ 和蓄水量 $v_t$，这些变量均被约束为非负。水电转换通过一个恒定因子 $\\alpha$ 进行建模，因此水力发电量等于 $\\alpha r_t$。火电发电的成本是线性的 $c g_t$。水库动态遵循水量平衡，并且水库蓄水量有上限 $V_{\\max}$，水电释放量有上限 $R_{\\max}$。所有量均以无物理维度的归一化单位表示。不确定性在于阶段2的入流和需求，存在两种等概率（各为0.5）的情景。阶段1的入流和需求是确定性的。目标是执行单次SDDP迭代，该迭代包括一个前向传递，使用当前对阶段2的未来成本函数近似（初始化为零）来确定阶段1的决策；以及一个后向传递，为在前向传递中达到的蓄水量 $v_1$ 处的预期阶段2未来成本函数计算一个仿射下界（一个“割平面”）。\n\n基本原理：\n- 水库水量平衡：对于阶段 $t \\in \\{1,2\\}$，$v_t = v_{t-1} + I_t - r_t - s_t$，其中 $I_t$ 是入流量（在阶段2依赖于情景，在阶段1是确定性的）。\n- 需求平衡：$g_t + \\alpha r_t \\ge D_t$。\n- 边界条件：$0 \\le r_t \\le R_{\\max}$，$0 \\le v_t \\le V_{\\max}$，$s_t \\ge 0$，$g_t \\ge 0$。\n- Bellman 最优性原理：阶段1问题最小化即时火电成本加上当前预期的未来成本近似值；阶段2问题最小化即时火电成本（无终端价值）。\n- 凸性与对偶性：在存在线性约束和成本的情况下，作为 $v_1$ 函数的预期阶段2未来成本函数是凸且分段线性的。在 $v_1$ 处的一个仿射下界（“割平面”）由一个次梯度 $a$ 和一个截距 $b$ 定义，使得 $\\widehat{J}_2(v) \\ge a v + b$ 且 $\\widehat{J}_2(v_1) = a v_1 + b$，其中 $\\widehat{J}_2$ 是预期的最优阶段2成本。\n\n前向传递规范：\n- 使用当前的阶段2未来成本函数近似 $\\widehat{J}_2(v) \\equiv 0$。\n- 前向传递的阶段1问题在所述约束条件下最小化 $c g_1$。如果存在多个最小化解，选择水电释放量 $r_1$ 最小的那个解。\n\n后向传递规范：\n- 在访问到的蓄水量 $v_1$ 处，精确求解两个阶段2的情景子问题，以计算它们的最优成本，然后计算预期成本 $\\mathbb{E}[J_2(v_1)]$。\n- 通过对情景次梯度进行平均，计算在 $v_1$ 处的预期未来成本函数的一个有效次梯度 $a$。对于每个情景，当额外的蓄水能直接替代火电发电时（即当 $v_1 + I_2$ 严格低于约束阈值 $\\min(R_{\\max}, D_2/\\alpha)$ 时），关于 $v_1$ 的次梯度为 $-c \\alpha$，否则为 $0$。在严格相等的情况下，选择次梯度 $0$。\n- 设置割平面的截距 $b$，使割平面通过 $v_1$ 处的预期成本，即 $b = \\mathbb{E}[J_2(v_1)] - a v_1$。\n\n您的程序必须确定性地实现这次单次SDDP迭代，并为每个测试用例输出列表 $[C_1, r_1, g_1, v_1, a, b]$，其中 $C_1$ 是前向传递阶段1的即时成本 $c g_1$，$r_1$ 是前向水电释放量，$g_1$ 是前向火电发电量，$v_1$ 是阶段1后的蓄水量，$a$ 是后向割平面的斜率，$b$ 是后向割平面的截距。所有量都应使用给定的归一化单位进行精确计算。\n\n测试套件：\n- 案例1（在阶段2中使用火电的一般“理想”情况）：$\\alpha = 1.0$, $c = 10.0$, $V_{\\max} = 100$, $R_{\\max} = 40$, $v_0 = 30$, $I_1 = 20$, $D_1 = 50$, 情景 A：$I_2^{(A)} = 15$, $D_2^{(A)} = 40$, 情景 B：$I_2^{(B)} = 5$, $D_2^{(B)} = 40$。\n- 案例2（在阶段2水电完全足够）：$\\alpha = 1.0$, $c = 10.0$, $V_{\\max} = 200$, $R_{\\max} = 100$, $v_0 = 150$, $I_1 = 10$, $D_1 = 20$, 情景 A：$I_2^{(A)} = 20$, $D_2^{(A)} = 100$, 情景 B：$I_2^{(B)} = 70$, $D_2^{(B)} = 100$。\n- 案例3（不同情景下斜率混合）：$\\alpha = 1.0$, $c = 20.0$, $V_{\\max} = 120$, $R_{\\max} = 30$, $v_0 = 40$, $I_1 = 15$, $D_1 = 30$, 情景 A：$I_2^{(A)} = 4$, $D_2^{(A)} = 60$, 情景 B：$I_2^{(B)} = 10$, $D_2^{(B)} = 25$。\n- 案例4（阶段1弃水边界）：$\\alpha = 1.0$, $c = 5.0$, $V_{\\max} = 50$, $R_{\\max} = 10$, $v_0 = 45$, $I_1 = 20$, $D_1 = 5$, 情景 A：$I_2^{(A)} = 5$, $D_2^{(A)} = 40$, 情景 B：$I_2^{(B)} = 0$, $D_2^{(B)} = 8$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含四个案例结果的列表，每个结果本身是一个列表 $[C_1, r_1, g_1, v_1, a, b]$。输出必须格式化为用方括号括起来的逗号分隔列表，例如，$[[\\dots],[\\dots],[\\dots],[\\dots]]$。不应打印任何其他文本。",
            "solution": "该问题是一个在水火电系统调度背景下定义明确的两阶段随机优化问题。它要求执行一次随机对偶动态规划（SDDP）算法的迭代。该问题在科学上是合理的、自洽的，并提供了所有数据和约束。验证成功，我们可以继续进行求解。\n\n求解过程涉及两个主要步骤：一个用于确定第一阶段决策的前向传递，以及一个用于生成新的Benders割平面（预期未来成本函数的一个仿射下界）的后向传递。\n\n### 前向传递：阶段1\n\n第一阶段的目标是最小化即时运营成本加上预期未来成本。对于这次单次迭代，预期未来成本函数 $\\widehat{J}_2(v_1)$ 对所有最终蓄水量 $v_1$ 的值都近似为零。\n因此，阶段1的问题是：\n$$ \\min_{r_1, g_1, s_1, v_1} c g_1 $$\n受以下约束：\n1.  需求平衡：$g_1 + \\alpha r_1 \\ge D_1$\n2.  水库水量平衡：$v_1 = v_0 + I_1 - r_1 - s_1$\n3.  决策变量边界：$0 \\le r_1 \\le R_{\\max}$，$0 \\le v_1 \\le V_{\\max}$，$s_1 \\ge 0$，$g_1 \\ge 0$。\n\n由于火电成本系数 $c$ 是正数，最小化 $c g_1$ 等同于最小化火电发电量 $g_1$。根据需求平衡约束，$g_1 \\ge D_1 - \\alpha r_1$。由于 $g_1$ 必须为非负，这可以写成 $g_1 = \\max(0, D_1 - \\alpha r_1)$。为了最小化 $g_1$，我们必须最大化水电释放量 $r_1$。\n\n然而，问题规定了一个平局打破规则：如果多个解产生相同的最小成本，则必须选择水电释放量 $r_1$ 最小的那个解。这引出了确定最优阶段1释放量 $r_1$ 的以下逻辑：\n\n1.  **判断需求是否能仅由水电满足。**如果存在一个可行的释放量 $r_1$ 使得 $\\alpha r_1 \\ge D_1$（即 $r_1 \\ge D_1/\\alpha$），则这是可能的。一个释放量 $r_1$ 如果遵守系统的物理限制，就是可行的。最大可能释放量 $r_{1, \\text{max\\_feasible}}$ 受水轮机容量 $R_{\\max}$ 和水库中可用总水量 $v_0 + I_1$ 的约束。因此，$r_{1, \\text{max\\_feasible}} = \\min(R_{\\max}, v_0 + I_1)$。\n\n2.  **选择最优释放量 $r_1$**：\n    *   如果用水电满足需求是可行的（即 $D_1/\\alpha \\le r_{1, \\text{max\\_feasible}}$），任何在 $[D_1/\\alpha, r_{1, \\text{max\\_feasible}}]$ 区间内的释放量 $r_1$ 都会导致 $g_1 = 0$，这是可能的最小火电发电量。根据平局打破规则，我们必须选择其中最小的释放量，因此我们设定 $r_1 = D_1/\\alpha$。\n    *   如果需求不能完全由水电满足（$D_1/\\alpha > r_{1, \\text{max\\_feasible}}$），那么对于所有可行的 $r_1$，$g_1 = D_1 - \\alpha r_1 > 0$。为了最小化 $g_1$，我们必须最大化 $r_1$。唯一的最大化者是 $r_1 = r_{1, \\text{max\\_feasible}}$。\n\n3.  **确定其他阶段1变量**：\n    *   火电发电量为 $g_1 = \\max(0, D_1 - \\alpha r_1)$。即时成本为 $C_1 = c g_1$。\n    *   阶段末蓄水量 $v_1$ 和弃水量 $s_1$ 必须满足 $v_1 + s_1 = v_0 + I_1 - r_1$。由于未来成本函数为零，没有明确的蓄水动机。我们采用标准的运营实践，即最小化弃水，这等同于最大化阶段末蓄水量 $v_1$。潜在的蓄水量为 $v'_1 = v_0 + I_1 - r_1$。\n        *   如果 $v'_1 > V_{\\max}$，则水库已满。因此，$v_1 = V_{\\max}$，弃水量 $s_1 = v'_1 - V_{\\max}$。\n        *   如果 $0 \\le v'_1 \\le V_{\\max}$，我们可以储存所有剩余的水。因此，$v_1 = v'_1$ 且 $s_1 = 0$。\n\n此过程唯一地确定了所有阶段1的决策变量：$[C_1, r_1, g_1, v_1]$。\n\n### 后向传递：阶段2\n\n后向传递计算一个Benders割平面（一个仿射函数），该函数是真实预期未来成本函数 $\\mathbb{E}[J_2(v_1)]$ 的下界。该割平面的形式为 $\\mathbb{E}[J_2(v)] \\ge a v + b$，并被构造成在前向传递中访问的点 $v_1$ 处是精确的。\n\n对于每个阶段2的情景 $s \\in \\{A, B\\}$，我们必须求解以下确定性子问题以找到最优成本 $J_2(v_1, s)$:\n$$ J_2(v_1, s) = \\min_{r_2, g_2, s_2, v_2} c g_2^{(s)} $$\n在给定起始蓄水量 $v_1$ 的情况下，受阶段2约束条件的限制。\n\n1.  **求解情景子问题**：目标是最小化 $c g_2^{(s)}$，这同样意味着最大化水电释放量 $r_2^{(s)}$。最大可行释放量为 $r_{2, \\text{max\\_feasible}}^{(s)} = \\min(R_{\\max}, v_1 + I_2^{(s)})$。\n    *   最优释放量为 $r_2^{(s)} = r_{2, \\text{max\\_feasible}}^{(s)}$。\n    *   最优火电发电量为 $g_2^{(s)} = \\max(0, D_2^{(s)} - \\alpha r_2^{(s)})$。\n    *   情景 $s$ 的成本为 $J_2(v_1, s) = c g_2^{(s)}$。\n\n2.  **计算预期成本**：由于情景是等概率的（概率 $p=0.5$），预期成本为 $\\mathbb{E}[J_2(v_1)] = 0.5 \\cdot J_2(v_1, A) + 0.5 \\cdot J_2(v_1, B)$。\n\n3.  **计算割平面斜率（次梯度）**：割平面的斜率 $a$ 是情景次梯度的期望值。$J_2(v_1, s)$ 关于 $v_1$ 的次梯度 $a^{(s)}$ 代表了水的边际价值。如果可以用来替代火电发电，每增加一个单位的水将使成本降低 $c\\alpha$。这只有在系统同时具有剩余的水轮机容量和可由水电满足的未满足需求时才可能。\n    问题指定了以下公式：\n    $$ a^{(s)} = \\begin{cases} -c \\alpha & \\text{if } v_1 + I_2^{(s)}  \\min(R_{\\max}, D_2^{(s)}/\\alpha) \\\\ 0  \\text{otherwise} \\end{cases} $$\n    该条件检查可用总水量 $v_1 + I_2^{(s)}$ 是否小于能有效通过水轮机释放的水量。如果小于，则边际水的价值为 $c\\alpha$，次梯度为 $-c\\alpha$。否则，边际水对于当前阶段的价值为零，次梯度为 $0$。\n    总斜率是期望值：$a = 0.5 \\cdot a^{(A)} + 0.5 \\cdot a^{(B)}$。\n\n4.  **计算割平面截距**：选择截距 $b$ 以使仿射函数在 $v_1$ 处精确：$\\mathbb{E}[J_2(v_1)] = a v_1 + b$。这得出 $b = \\mathbb{E}[J_2(v_1)] - a v_1$。\n\n此过程确定了割平面参数 $[a, b]$，从而完成了单次SDDP迭代。该算法针对每个测试用例实现，以生成所需的输出。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the given hydro-thermal coordination problem for all test cases.\n    \"\"\"\n\n    test_cases = [\n        # Case 1: alpha, c, V_max, R_max, v0, I1, D1, I2A, D2A, I2B, D2B\n        (1.0, 10.0, 100.0, 40.0, 30.0, 20.0, 50.0, 15.0, 40.0, 5.0, 40.0),\n        # Case 2\n        (1.0, 10.0, 200.0, 100.0, 150.0, 10.0, 20.0, 20.0, 100.0, 70.0, 100.0),\n        # Case 3\n        (1.0, 20.0, 120.0, 30.0, 40.0, 15.0, 30.0, 4.0, 60.0, 10.0, 25.0),\n        # Case 4\n        (1.0, 5.0, 50.0, 10.0, 45.0, 20.0, 5.0, 5.0, 40.0, 0.0, 8.0),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = run_sddp_iteration(case)\n        results.append(result)\n\n    # Format the final output string exactly as required.\n    # e.g., \"[[C1,r1,...],[C1,r1,...]]\"\n    results_as_strings = [f\"[{','.join(map(str, res))}]\" for res in results]\n    final_output = f\"[{','.join(results_as_strings)}]\"\n    print(final_output)\n\ndef run_sddp_iteration(params):\n    \"\"\"\n    Performs a single SDDP iteration (forward and backward pass) for one test case.\n\n    Args:\n        params (tuple): A tuple containing all parameters for the test case.\n\n    Returns:\n        list: A list of the calculated values [C1, r1, g1, v1, a, b].\n    \"\"\"\n    alpha, c, V_max, R_max, v0, I1, D1, I2A, D2A, I2B, D2B = params\n\n    # FORWARD PASS (Stage 1)\n    \n    # Water available in stage 1\n    water_available_1 = v0 + I1\n    \n    # Release required to meet demand D1 with hydro only\n    r_target = D1 / alpha\n    \n    # Maximum feasible release in stage 1\n    r_max_feasible = min(R_max, water_available_1)\n\n    r1, g1 = 0.0, 0.0\n    if r_target = r_max_feasible:\n        # Minimum cost (g1=0) is achievable. By tie-breaking rule, use smallest r1.\n        r1 = r_target\n        g1 = 0.0\n    else:\n        # Minimum cost requires maximizing r1, as g1 > 0.\n        r1 = r_max_feasible\n        g1 = D1 - alpha * r1\n\n    C1 = c * g1\n\n    # Determine end-of-stage storage v1 by maximizing storage (minimizing spillage)\n    v_potential = v0 + I1 - r1\n    v1 = 0.0\n    if v_potential > V_max:\n        v1 = V_max\n    else:\n        v1 = v_potential\n\n    # BACKWARD PASS (Stage 2)\n    \n    # Scenario A\n    water_available_2A = v1 + I2A\n    r2_opt_A = min(R_max, water_available_2A)\n    g2_A = max(0.0, D2A - alpha * r2_opt_A)\n    cost_A = c * g2_A\n    \n    threshold_A = min(R_max, D2A / alpha)\n    slope_A = -c * alpha if (v1 + I2A)  threshold_A else 0.0\n\n    # Scenario B\n    water_available_2B = v1 + I2B\n    r2_opt_B = min(R_max, water_available_2B)\n    g2_B = max(0.0, D2B - alpha * r2_opt_B)\n    cost_B = c * g2_B\n\n    threshold_B = min(R_max, D2B / alpha)\n    slope_B = -c * alpha if (v1 + I2B)  threshold_B else 0.0\n\n    # Calculate the Benders cut parameters (a, b)\n    # The scenarios have equal probability of 0.5\n    expected_future_cost = 0.5 * cost_A + 0.5 * cost_B\n    a = 0.5 * slope_A + 0.5 * slope_B\n    b = expected_future_cost - a * v1\n    \n    return [C1, r1, g1, v1, a, b]\n\nsolve()\n```"
        }
    ]
}