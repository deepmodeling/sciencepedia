{
    "hands_on_practices": [
        {
            "introduction": "The validity of the shallow atmosphere approximation rests on the atmosphere's small aspect ratio, $\\epsilon = H/a$. This exercise provides a concrete, quantitative assessment of the errors introduced by this simplification at the most fundamental level. By applying a Taylor series expansion, you will quantify the leading-order fractional error in the geometric metric terms that appear throughout the primitive equations, developing an essential skill for analyzing approximations in geophysical fluid dynamics .",
            "id": "4103126",
            "problem": "In spherical-coordinate formulations of the atmospheric primitive equations used in numerical weather prediction and climate modeling, geometric metric factors depend on the radial coordinate $r$, where $r=a+z$, $a$ is the planetary mean radius, and $z$ is the geometric height above the surface. The shallow atmosphere approximation treats $r$ as effectively constant in these metric factors by setting $r \\approx a$, which introduces a systematic error that scales with a small nondimensional parameter. Let the characteristic atmospheric depth be $H$ with $0 \\le z \\le H$ and $H \\ll a$.\n\nStarting from the exact geometric relation $r=a+z$ and the binomial expansion for $(1+x)^{\\alpha}$ about $x=0$, consider generic metric prefactors of the form $r^{-n}$ that appear in geometry-induced terms (e.g., zonal metric coefficients proportional to $r^{-1}$ and curvature-related factors proportional to $r^{-2}$). Define the fractional error of the shallow atmosphere replacement $r \\mapsto a$ for such a prefactor as\n$$\n\\mathcal{E}_{n}(z) \\equiv \\frac{|a^{-n} - (a+z)^{-n}|}{|(a+z)^{-n}|}.\n$$\nUsing first principles and asymptotic expansion in the small ratio $z/a$, derive the leading-order scaling of $\\mathcal{E}_{n}(z)$ for $n=1$ and $n=2$, and evaluate the worst-case (over height) leading-order errors by setting $z=H$. Then, for Earth-like parameters $H=20$ km and $a=6371$ km, compute the nondimensional thinness parameter $\\epsilon \\equiv H/a$ and the corresponding worst-case leading-order fractional errors for $n=1$ and $n=2$.\n\nReport your final answer as a single row vector containing three entries $[\\epsilon, \\mathcal{E}_{1}(H), \\mathcal{E}_{2}(H)]$. All three entries must be expressed as dimensionless decimal fractions, rounded to four significant figures.",
            "solution": "The problem statement is evaluated and found to be valid. It is scientifically grounded in the principles of atmospheric modeling and mathematical physics, well-posed with all necessary information provided, and objective in its language. The numerical values are physically realistic and consistent. We may therefore proceed with the solution.\n\nThe problem asks for an analysis of the fractional error introduced by the shallow atmosphere approximation in geometric metric prefactors of the form $r^{-n}$. The radial coordinate is $r=a+z$, where $a$ is the planetary mean radius and $z$ is the height above the surface. The shallow atmosphere approximation replaces $r$ with $a$. The fractional error is defined as:\n$$\n\\mathcal{E}_{n}(z) \\equiv \\frac{|a^{-n} - (a+z)^{-n}|}{|(a+z)^{-n}|}\n$$\nThis expression can be simplified by distributing the denominator:\n$$\n\\mathcal{E}_{n}(z) = \\left| \\frac{a^{-n}}{(a+z)^{-n}} - 1 \\right| = \\left| \\left( \\frac{a+z}{a} \\right)^{n} - 1 \\right|\n$$\nFurther simplification yields:\n$$\n\\mathcal{E}_{n}(z) = \\left| \\left( 1 + \\frac{z}{a} \\right)^{n} - 1 \\right|\n$$\nThe problem specifies that the atmospheric depth $H$ is much smaller than the planetary radius $a$ ($H \\ll a$), and the height $z$ is bounded by $0 \\le z \\le H$. This implies that the ratio $z/a$ is a small, nondimensional parameter. We are instructed to use the binomial expansion for $(1+x)^{\\alpha}$ around $x=0$, which is given by:\n$$\n(1+x)^{\\alpha} = 1 + \\alpha x + \\frac{\\alpha(\\alpha-1)}{2!}x^2 + \\mathcal{O}(x^3)\n$$\nIn our case, $x = z/a$ and $\\alpha=n$. Substituting this expansion into the expression for $\\mathcal{E}_{n}(z)$:\n$$\n\\mathcal{E}_{n}(z) = \\left| \\left( 1 + n\\left(\\frac{z}{a}\\right) + \\frac{n(n-1)}{2}\\left(\\frac{z}{a}\\right)^2 + \\mathcal{O}\\left(\\left(\\frac{z}{a}\\right)^3\\right) \\right) - 1 \\right|\n$$\nSimplifying by canceling the $1$s:\n$$\n\\mathcal{E}_{n}(z) = \\left| n\\left(\\frac{z}{a}\\right) + \\frac{n(n-1)}{2}\\left(\\frac{z}{a}\\right)^2 + \\mathcal{O}\\left(\\left(\\frac{z}{a}\\right)^3\\right) \\right|\n$$\nFor a small ratio $z/a$, the leading-order term is the one with the lowest power of $z/a$. Thus, the leading-order scaling of the fractional error is:\n$$\n\\mathcal{E}_{n}(z) \\approx \\left| n \\frac{z}{a} \\right|\n$$\nSince $n$ (for the cases $n=1, 2$), $z$, and $a$ are all non-negative, the absolute value can be removed:\n$$\n\\mathcal{E}_{n}(z) \\approx n \\frac{z}{a}\n$$\nNow, we apply this general result to the specific cases $n=1$ and $n=2$.\nFor $n=1$:\n$$\n\\mathcal{E}_{1}(z) \\approx 1 \\cdot \\frac{z}{a} = \\frac{z}{a}\n$$\nFor $n=2$:\n$$\n\\mathcal{E}_{2}(z) \\approx 2 \\frac{z}{a}\n$$\nThe error $\\mathcal{E}_{n}(z)$ is directly proportional to the height $z$. Therefore, the worst-case error over the atmospheric depth ($0 \\le z \\le H$) occurs at the maximum height, $z=H$.\nThe worst-case leading-order errors are:\n$$\n\\mathcal{E}_{1}(H) \\approx \\frac{H}{a}\n$$\n$$\n\\mathcal{E}_{2}(H) \\approx 2 \\frac{H}{a}\n$$\nNext, we use the provided Earth-like parameters to compute the numerical values. The parameters are $H = 20$ km and $a = 6371$ km.\nThe nondimensional thinness parameter $\\epsilon$ is defined as $\\epsilon \\equiv H/a$.\n$$\n\\epsilon = \\frac{20\\ \\mathrm{km}}{6371\\ \\mathrm{km}} = \\frac{20}{6371} \\approx 0.0031392246...\n$$\nRounding to four significant figures, we get $\\epsilon \\approx 0.003139$.\n\nThe worst-case leading-order fractional error for $n=1$ at $z=H$ is:\n$$\n\\mathcal{E}_{1}(H) \\approx \\frac{H}{a} = \\epsilon \\approx 0.003139\n$$\nThe worst-case leading-order fractional error for $n=2$ at $z=H$ is:\n$$\n\\mathcal{E}_{2}(H) \\approx 2 \\frac{H}{a} = 2\\epsilon \\approx 2 \\times 0.0031392246... = 0.0062784492...\n$$\nRounding to four significant figures, we get $\\mathcal{E}_{2}(H) \\approx 0.006278$.\n\nThe final answer is to be reported as a single row vector containing the three calculated values $[\\epsilon, \\mathcal{E}_{1}(H), \\mathcal{E}_{2}(H)]$, rounded to four significant figures.\nThe values are $\\epsilon \\approx 0.003139$, $\\mathcal{E}_{1}(H) \\approx 0.003139$, and $\\mathcal{E}_{2}(H) \\approx 0.006278$.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 0.003139 & 0.003139 & 0.006278 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "An approximation's true test is its impact on the governing dynamics. This practice moves beyond pure geometry to explore how the shallow atmosphere approximation alters a key driver of atmospheric motion: the horizontal pressure gradient force. By integrating over a model column, you will derive the leading-order error in this crucial dynamical term, gaining insight into how local geometric errors can accumulate and affect larger-scale balances within a model .",
            "id": "4103107",
            "problem": "Consider a rotating, stratified atmosphere on a spherical planet of radius $a$ in which numerical weather prediction and climate modeling commonly invoke the shallow atmosphere approximation (SAA). In the SAA, the radial coordinate $r$ that appears in the horizontal geometric factors is replaced by the constant planetary radius $a$, even though the true local radius is $r(z) = a + z$ where $z$ is the geometric height above the surface. At a fixed latitude $\\phi$, define the horizontal pressure gradient force per unit mass using the standard spherical metric. Assume a horizontally uniform longitude $\\lambda$ coordinate and a column extending from $z = 0$ to $z = H$, where $H \\ll a$.\n\nTo isolate the effect of the neglected $r$ variation, assume that the horizontal pressure gradient of pressure $\\frac{\\partial p}{\\partial \\lambda}$ and the mass density $\\rho$ are both independent of $z$ over $0 \\le z \\le H$. Define the column-mean magnitude of the horizontal pressure gradient force per unit mass by averaging over $z \\in [0,H]$ at fixed $\\phi$. Starting from the geometric definition of arc length on a sphere and the corresponding expression for the horizontal gradient operator, derive the leading-order fractional error incurred in the column-mean horizontal pressure gradient force when $r(z)$ is replaced by $a$ (the shallow atmosphere approximation). Express your final result solely in terms of the nondimensional aspect ratio $\\epsilon = H/a$. Provide the final answer as a single closed-form analytic expression with no units.",
            "solution": "The task is to derive the leading-order fractional error in the column-mean horizontal pressure gradient force per unit mass when the shallow atmosphere approximation (SAA) is used. The SAA consists of replacing the true radial coordinate $r(z) = a + z$ with the constant planetary radius $a$.\n\nFirst, we establish the expression for the horizontal pressure gradient force. In spherical coordinates $(r, \\phi, \\lambda)$ representing radius, latitude, and longitude, the gradient of a scalar pressure field $p$ is given by:\n$$\n\\nabla p = \\frac{\\partial p}{\\partial r} \\mathbf{\\hat{r}} + \\frac{1}{r} \\frac{\\partial p}{\\partial \\phi} \\mathbf{\\hat{\\phi}} + \\frac{1}{r \\cos\\phi} \\frac{\\partial p}{\\partial \\lambda} \\mathbf{\\hat{\\lambda}}\n$$\nThe horizontal pressure gradient force per unit mass is $\\mathbf{F} = -\\frac{1}{\\rho} \\nabla_h p$, where $\\nabla_h p$ is the horizontal component of the gradient. The problem focuses on the longitudinal component of this force, which arises from the pressure gradient term $\\frac{\\partial p}{\\partial \\lambda}$. The magnitude of this component of the force at a given height $z$ is:\n$$\nf(z) = \\left| -\\frac{1}{\\rho} \\frac{1}{r(z) \\cos\\phi} \\frac{\\partial p}{\\partial \\lambda} \\right| = \\frac{1}{\\rho \\cos\\phi} \\frac{1}{r(z)} \\left| \\frac{\\partial p}{\\partial \\lambda} \\right|\n$$\nThe problem states that the mass density $\\rho$ and the pressure gradient term $\\frac{\\partial p}{\\partial \\lambda}$ are both independent of height $z$. The latitude $\\phi$ is also fixed. We can therefore combine all $z$-independent terms into a single constant $C$:\n$$\nC = \\frac{1}{\\rho \\cos\\phi} \\left| \\frac{\\partial p}{\\partial \\lambda} \\right|\n$$\nThe force magnitude at height $z$ is then simply $f(z) = \\frac{C}{r(z)}$.\n\nWe now calculate the \"true\" column-mean force, $\\langle f_{\\text{true}} \\rangle$, by using the exact radial coordinate $r(z) = a + z$ and averaging over the atmospheric column height from $z=0$ to $z=H$.\n$$\n\\langle f_{\\text{true}} \\rangle = \\frac{1}{H} \\int_{0}^{H} f_{\\text{true}}(z) \\,dz = \\frac{1}{H} \\int_{0}^{H} \\frac{C}{a+z} \\,dz\n$$\nSince $C$ is a constant, we can take it out of the integral:\n$$\n\\langle f_{\\text{true}} \\rangle = \\frac{C}{H} \\int_{0}^{H} \\frac{1}{a+z} \\,dz = \\frac{C}{H} \\left[ \\ln(a+z) \\right]_{0}^{H}\n$$\nEvaluating the integral gives:\n$$\n\\langle f_{\\text{true}} \\rangle = \\frac{C}{H} (\\ln(a+H) - \\ln(a)) = \\frac{C}{H} \\ln\\left(\\frac{a+H}{a}\\right) = \\frac{C}{H} \\ln\\left(1 + \\frac{H}{a}\\right)\n$$\n\nNext, we calculate the column-mean force under the shallow atmosphere approximation, $\\langle f_{\\text{approx}} \\rangle$. In this approximation, $r(z)$ is replaced by the constant $a$.\n$$\nf_{\\text{approx}}(z) = \\frac{C}{a}\n$$\nSince this expression is independent of $z$, its average over the column is the value itself:\n$$\n\\langle f_{\\text{approx}} \\rangle = \\frac{1}{H} \\int_{0}^{H} \\frac{C}{a} \\,dz = \\frac{C}{aH} \\int_{0}^{H} dz = \\frac{C}{aH} [z]_{0}^{H} = \\frac{C}{a}\n$$\n\nNow we can compute the fractional error, $\\mathcal{E}$. The standard definition for fractional error is the difference between the approximate and true values, divided by the true value.\n$$\n\\mathcal{E} = \\frac{\\langle f_{\\text{approx}} \\rangle - \\langle f_{\\text{true}} \\rangle}{\\langle f_{\\text{true}} \\rangle}\n$$\nSubstituting the expressions derived above:\n$$\n\\mathcal{E} = \\frac{\\frac{C}{a} - \\frac{C}{H} \\ln\\left(1 + \\frac{H}{a}\\right)}{\\frac{C}{H} \\ln\\left(1 + \\frac{H}{a}\\right)}\n$$\nThe constant $C$ cancels out. We can simplify the expression:\n$$\n\\mathcal{E} = \\frac{\\frac{1}{a}}{\\frac{1}{H} \\ln\\left(1 + \\frac{H}{a}\\right)} - 1 = \\frac{H}{a \\ln\\left(1 + \\frac{H}{a}\\right)} - 1\n$$\nThe problem defines the nondimensional aspect ratio $\\epsilon = H/a$. Substituting this into the error expression gives the exact fractional error:\n$$\n\\mathcal{E} = \\frac{\\epsilon}{\\ln(1+\\epsilon)} - 1\n$$\nThe problem asks for the *leading-order* fractional error, which requires a Taylor series expansion of this expression for small $\\epsilon$ (since $H \\ll a$). The Taylor series for $\\ln(1+\\epsilon)$ around $\\epsilon=0$ is:\n$$\n\\ln(1+\\epsilon) = \\epsilon - \\frac{\\epsilon^2}{2} + \\frac{\\epsilon^3}{3} - O(\\epsilon^4)\n$$\nSubstituting this into the denominator of our expression for $\\mathcal{E}$:\n$$\n\\mathcal{E} = \\frac{\\epsilon}{\\epsilon - \\frac{\\epsilon^2}{2} + O(\\epsilon^3)} - 1 = \\frac{1}{1 - \\frac{\\epsilon}{2} + O(\\epsilon^2)} - 1\n$$\nUsing the geometric series expansion $(1-u)^{-1} = 1 + u + u^2 + \\dots$ with $u = \\frac{\\epsilon}{2} - O(\\epsilon^2)$:\n$$\n\\mathcal{E} = \\left(1 + \\left(\\frac{\\epsilon}{2} - O(\\epsilon^2)\\right) + O(\\epsilon^2)\\right) - 1 = \\left(1 + \\frac{\\epsilon}{2} + O(\\epsilon^2)\\right) - 1\n$$\n$$\n\\mathcal{E} = \\frac{\\epsilon}{2} + O(\\epsilon^2)\n$$\nThe leading-order term is the first non-zero term in the expansion. Therefore, the leading-order fractional error is $\\frac{\\epsilon}{2}$.\nThis positive error indicates that the shallow atmosphere approximation, by using a smaller radius $a$ instead of $a+z$, overestimates the magnitude of the column-mean horizontal pressure gradient force.",
            "answer": "$$\\boxed{\\frac{\\epsilon}{2}}$$"
        },
        {
            "introduction": "While the shallow atmosphere approximation is highly effective for large-scale hydrostatic models, its limitations can become apparent when modeling nonhydrostatic phenomena with strong vertical motion. This advanced exercise examines the subtle but important consequences of neglecting geometric curvature terms on vertical acceleration. You will first derive the theoretical differences and then apply them in a computational setting to quantify their potential to generate spurious vertical motion, connecting analytical insight directly with practical, code-level implications .",
            "id": "4103082",
            "problem": "Consider a stably stratified atmosphere near the stratopause where vertical scales are small compared to the planetary radius. The deep-atmosphere formulation retains geometric curvature and radial variation of gravitational acceleration, while the shallow-atmosphere approximation treats the radius as constant and neglects certain metric terms. Your task is to start from fundamental laws and derive expressions that compare vertical motion between the deep and shallow formulations, then implement a program to quantify the resulting differences for specified cases.\n\nUse the following fundamental base:\n- Newtonâ€™s second law and the compressible Euler equations, specifically the mass continuity equation $\\partial \\rho / \\partial t + \\nabla \\cdot (\\rho \\boldsymbol{v}) = 0$ and the momentum equation $\\rho \\, D\\boldsymbol{v}/Dt = - \\nabla p - \\rho \\nabla \\Phi$, where $\\boldsymbol{v}$ is velocity, $p$ is pressure, $\\rho$ is density, and $\\Phi$ is geopotential.\n- A hydrostatic base state with $\\partial p/\\partial r = -\\rho g(r)$, where $r$ is the radial coordinate and $g(r)$ is gravitational acceleration as a function of $r$.\n- Spherical-coordinate kinematics with radial coordinate $r$ and horizontal velocities $(u, v)$ and vertical (radial) velocity $w$.\n\nTasks:\n1. From first principles, derive the leading-order difference in vertical acceleration between deep and shallow formulations that affects nonhydrostatic vertical motion. Assume a hydrostatic base state so that vertical variations of gravitational acceleration $g(r)$ are balanced hydrostatically in the mean, and isolate terms that persist in the nonhydrostatic vertical momentum equation. Represent the deep-minus-shallow vertical acceleration difference as an explicitly computable function of the local radius $r$ and horizontal wind speeds $(u, v)$.\n2. From first principles, derive the relationship between vertical velocity $w(r)$ in the deep formulation versus the shallow formulation using the mass continuity equation with horizontally nondivergent flow (i.e., zero horizontal divergence), and express the deep-to-shallow ratio $w_{\\mathrm{deep}}(r)/w_{\\mathrm{shallow}}(r)$ in terms of $r$ and a constant reference radius.\n3. Implement a complete, runnable program that, for each test case specified below, evaluates:\n   - The potential cumulative vertical velocity error over a finite time window due to the deep-minus-shallow vertical acceleration difference derived in Task 1, expressed in meters per second (m/s). Assume the acceleration difference is constant over the specified window and integrate it in time to obtain a vertical velocity difference.\n   - The deep-to-shallow vertical velocity ratio at the specified altitude derived in Task 2, dimensionless.\n   - A boolean flag that is true if the cumulative vertical velocity error magnitude exceeds a given threshold, and false otherwise.\n\nAssumptions for implementation:\n- Planetary radius is $a = 6,371,000$ m.\n- Gravitational acceleration at $r=a$ is $g_0 = 9.80665$ m/s$^2$, but its radial variation is hydrostatically balanced and therefore does not directly produce nonhydrostatic vertical acceleration error in this comparison.\n- Horizontal winds are specified by a zonal component $u(z) = u_0 + S z$ and a meridional component $v(z) = v_0$ evaluated at a given altitude $z$ with $r = a + z$. Treat $(u, v)$ as constant in time over each test window.\n- Angle units are not required for this problem since latitude does not explicitly enter the required calculations.\n\nTest suite:\nProvide results for the following three test cases, each a tuple $(z, u_0, S, v_0, T, w_{\\mathrm{th}})$ where $z$ is altitude in meters, $u_0$ is the zonal wind base in meters per second (m/s), $S$ is vertical shear in inverse seconds ($\\mathrm{s^{-1}}$) such that $u(z) = u_0 + S z$, $v_0$ is meridional wind in meters per second (m/s), $T$ is the duration in seconds (s) for accumulation, and $w_{\\mathrm{th}}$ is the vertical velocity error threshold in meters per second (m/s):\n- Case 1 (happy path): $(50,000, 30, 1.0 \\times 10^{-3}, 10, 600, 0.5)$\n- Case 2 (low shear boundary): $(48,000, 20, 0, 0, 600, 0.2)$\n- Case 3 (strong shear edge): $(55,000, 60, 8.0 \\times 10^{-4}, 40, 900, 1.0)$\n\nRequired outputs per test case:\n- A float for the cumulative vertical velocity error in $\\mathrm{m/s}$.\n- A float for the deep-to-shallow vertical velocity ratio (dimensionless).\n- A boolean indicating whether the error exceeds the threshold.\n\nFinal output format:\nYour program should produce a single line of output containing the results aggregated for the three test cases into one comma-separated list enclosed in square brackets, in the order:\n$[\\Delta w_1, \\mathcal{R}_1, \\mathrm{flag}_1, \\Delta w_2, \\mathcal{R}_2, \\mathrm{flag}_2, \\Delta w_3, \\mathcal{R}_3, \\mathrm{flag}_3]$,\nwhere $\\Delta w_i$ is the cumulative vertical velocity error in $\\mathrm{m/s}$, $\\mathcal{R}_i$ is the deep-to-shallow ratio, and $\\mathrm{flag}_i$ is the boolean for case $i$.",
            "solution": "The problem statement has been validated and is deemed valid. It is scientifically grounded in the principles of fluid dynamics applied to atmospheric science, is well-posed with sufficient information for a unique solution, and is formulated objectively.\n\nThe solution proceeds by first deriving the theoretical expressions required by the problem, followed by their numerical implementation.\n\n### Task 1: Derivation of the Vertical Acceleration Difference\n\nWe begin with the vertical (radial) component of the Euler momentum equation in spherical coordinates $(r, \\theta, \\phi)$. The velocity vector is $\\boldsymbol{v} = (w, v, u)$, corresponding to the radial, meridional, and zonal directions, respectively. The full material derivative of the velocity vector, $D\\boldsymbol{v}/Dt$, contains terms arising from the curvature of the coordinate system. The radial component of the momentum equation is:\n\n$$\n\\frac{Dw}{Dt} - \\frac{u^2+v^2}{r} = -\\frac{1}{\\rho}\\frac{\\partial p}{\\partial r} - g(r)\n$$\n\nwhere $w$ is the radial velocity, $u$ and $v$ are the horizontal velocities, $r$ is the radial distance, $p$ is pressure, $\\rho$ is density, and $g(r)$ is the gravitational acceleration. The term $\\frac{Dw}{Dt}$ represents the Lagrangian time derivative of the vertical velocity. The term $-\\frac{u^2+v^2}{r}$ is an apparent centrifugal acceleration arising from horizontal motion over the curved planetary surface.\n\nThe problem specifies a hydrostatic base state, where the mean pressure gradient balances gravity: $\\partial p_0 / \\partial r = -\\rho_0 g(r)$. We consider nonhydrostatic motions as perturbations from this base state. The vertical momentum equation for these perturbations is:\n\n$$\n\\frac{Dw}{Dt} = \\frac{u^2+v^2}{r} - \\frac{1}{\\rho}\\frac{\\partial p'}{\\partial r} - \\frac{\\rho'}{\\rho_0}g\n$$\n\nHere, $p'$ and $\\rho'$ are the pressure and density perturbations, respectively. The terms on the right-hand side are sources of vertical acceleration.\n\nThe distinction between the deep and shallow atmosphere formulations lies in the treatment of the geometric (metric) terms.\n-   The **deep-atmosphere formulation** retains the full geometric complexity. The vertical acceleration budget includes the centrifugal term:\n    $$\n    \\left(\\frac{Dw}{Dt}\\right)_{\\mathrm{deep}} = \\dots + \\frac{u^2+v^2}{r}\n    $$\n-   The **shallow-atmosphere approximation** simplifies or neglects these terms. A standard simplification is to treat the vertical coordinate as if it were in a Cartesian system, which amounts to neglecting the centrifugal term arising from horizontal motion. Thus:\n    $$\n    \\left(\\frac{Dw}{Dt}\\right)_{\\mathrm{shallow}} = \\dots + 0\n    $$\nThe nonhydrostatic pressure and buoyancy forces are assumed to be represented similarly in both formulations for this comparative analysis.\n\nThe difference in vertical acceleration, which we denote $\\Delta a_w$, is therefore the centrifugal term itself:\n\n$$\n\\Delta a_w(r, u, v) = \\left(\\frac{Dw}{Dt}\\right)_{\\mathrm{deep}} - \\left(\\frac{Dw}{Dt}\\right)_{\\mathrm{shallow}} = \\frac{u^2 + v^2}{r}\n$$\n\nThis expression represents the leading-order difference in the explicitly computed sources of nonhydrostatic vertical acceleration between the two formulations.\n\n### Task 2: Derivation of the Vertical Velocity Ratio\n\nWe start with the mass continuity equation in its conservative form:\n$$\n\\frac{\\partial \\rho}{\\partial t} + \\nabla \\cdot (\\rho \\boldsymbol{v}) = 0\n$$\nIn spherical coordinates, the divergence operator applied to the mass flux vector $\\rho \\boldsymbol{v}$ is:\n$$\n\\nabla \\cdot (\\rho \\boldsymbol{v}) = \\frac{1}{r^2} \\frac{\\partial (r^2 \\rho w)}{\\partial r} + \\nabla_h \\cdot (\\rho \\boldsymbol{v}_h)\n$$\nwhere $\\nabla_h \\cdot (\\rho \\boldsymbol{v}_h)$ represents the horizontal divergence of the mass flux.\n\nThe problem specifies \"horizontally nondivergent flow.\" We interpret this as the horizontal mass flux divergence being zero: $\\nabla_h \\cdot (\\rho \\boldsymbol{v}_h) = 0$. Furthermore, to derive a simple kinematic relationship independent of the time-varying density field, we assume a steady state, $\\partial \\rho / \\partial t = 0$.\n\nUnder these assumptions, the continuity equation for the **deep-atmosphere formulation** becomes:\n$$\n\\frac{1}{r^2} \\frac{\\partial (r^2 \\rho w_{\\mathrm{deep}})}{\\partial r} = 0\n$$\nIntegrating with respect to $r$ yields:\n$$\nr^2 \\rho w_{\\mathrm{deep}} = \\text{constant} = C_d\n$$\nThus, the deep-atmosphere vertical velocity is $w_{\\mathrm{deep}}(r) = \\frac{C_d}{\\rho(r) r^2}$.\n\nFor the **shallow-atmosphere approximation**, the divergence operator is simplified. The term $\\frac{1}{r^2} \\frac{\\partial (r^2 \\cdot)}{\\partial r}$ is replaced by a Cartesian equivalent $\\frac{\\partial (\\cdot)}{\\partial r}$. Applying the same assumptions (steady state and zero horizontal mass flux divergence):\n$$\n\\frac{\\partial (\\rho w_{\\mathrm{shallow}})}{\\partial r} = 0\n$$\nIntegrating with respect to $r$ gives:\n$$\n\\rho w_{\\mathrm{shallow}} = \\text{constant} = C_s\n$$\nThus, the shallow-atmosphere vertical velocity is $w_{\\mathrm{shallow}}(r) = \\frac{C_s}{\\rho(r)}$.\n\nTo find the ratio, we must relate the integration constants $C_d$ and $C_s$. These constants represent the vertical mass flux, which must be consistent between the models at a reference level. We set the mass fluxes equal at a reference radius $r=a$:\n$$\n(\\rho w)_{\\mathrm{deep}}(a) = \\frac{C_d}{a^2}\n$$\n$$\n(\\rho w)_{\\mathrm{shallow}}(a) = C_s\n$$\nEquating them gives $C_s = C_d / a^2$.\n\nNow we can compute the ratio of the vertical velocities at any radius $r$:\n$$\n\\mathcal{R}(r) = \\frac{w_{\\mathrm{deep}}(r)}{w_{\\mathrm{shallow}}(r)} = \\frac{C_d / (\\rho(r) r^2)}{C_s / \\rho(r)} = \\frac{C_d}{C_s r^2}\n$$\nSubstituting $C_s = C_d / a^2$:\n$$\n\\mathcal{R}(r) = \\frac{C_d}{(C_d/a^2) r^2} = \\frac{a^2}{r^2} = \\left(\\frac{a}{r}\\right)^2\n$$\n\nThis is the desired dimensionless ratio, expressed in terms of the local radius $r$ and the reference radius $a$.\n\n### Task 3: Implementation Strategy\n\nThe numerical implementation will use the derived formulas.\n1.  **Cumulative Vertical Velocity Error ($\\Delta w$)**: We calculate this by integrating the acceleration difference $\\Delta a_w$ over the time window $T$. Assuming $\\Delta a_w$ is constant:\n    $$\n    \\Delta w = \\Delta a_w \\times T = \\left( \\frac{u(z)^2 + v(z)^2}{r} \\right) T\n    $$\n    where $r = a+z$, $u(z) = u_0 + S z$, and $v(z)=v_0$. The parameters $z, u_0, S, v_0, T$ are provided for each test case, and the planetary radius $a$ is given as $6,371,000 \\, \\mathrm{m}$.\n\n2.  **Deep-to-Shallow Vertical Velocity Ratio ($\\mathcal{R}$)**: This is calculated directly from the derived formula:\n    $$\n    \\mathcal{R} = \\left(\\frac{a}{a+z}\\right)^2\n    $$\n\n3.  **Boolean Flag**: This is a direct comparison:\n    $$\n    \\mathrm{flag} = |\\Delta w| > w_{\\mathrm{th}}\n    $$\n    where $w_{\\mathrm{th}}$ is the provided threshold for each case.\n\nThese three quantities will be computed for each test case and formatted into the required output string.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Calculates differences in vertical motion between deep and shallow atmosphere\n    formulations for specified atmospheric conditions.\n    \"\"\"\n    # Define physical constants and test cases from the problem statement.\n    A = 6371000.0  # Planetary radius in meters\n\n    test_cases = [\n        # (z, u0, S, v0, T, w_th)\n        (50000.0, 30.0, 1.0e-3, 10.0, 600.0, 0.5),\n        (48000.0, 20.0, 0.0, 0.0, 600.0, 0.2),\n        (55000.0, 60.0, 8.0e-4, 40.0, 900.0, 1.0),\n    ]\n\n    results = []\n    for case in test_cases:\n        z, u0, S, v0, T, w_th = case\n\n        # Calculate local radius\n        r = A + z\n\n        # Calculate horizontal wind components at altitude z\n        u_z = u0 + S * z\n        v_z = v0\n\n        # --- Task 1 Calculation ---\n        # Calculate the potential cumulative vertical velocity error (Delta_w).\n        # This is derived from the difference in vertical acceleration (centrifugal term),\n        # integrated over time T.\n        # Delta_a_w = (u^2 + v^2) / r\n        # Delta_w = Delta_a_w * T\n        \n        horizontal_wind_speed_sq = u_z**2 + v_z**2\n        delta_a_w = horizontal_wind_speed_sq / r\n        delta_w = delta_a_w * T\n        \n        # --- Task 2 Calculation ---\n        # Calculate the deep-to-shallow vertical velocity ratio (R).\n        # This is derived from the mass continuity equation under simplifying assumptions.\n        # R = (a / r)^2\n        \n        ratio_R = (A / r)**2\n\n        # --- Task 3 Calculation ---\n        # Determine if the magnitude of the velocity error exceeds the threshold.\n        exceeds_threshold = abs(delta_w) > w_th\n\n        # Append the results for the current case to the list\n        results.extend([delta_w, ratio_R, exceeds_threshold])\n\n    # Final print statement in the exact required format.\n    # The format string ensures floats are represented correctly and booleans as True/False.\n    formatted_results = [f\"{x}\" for x in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}