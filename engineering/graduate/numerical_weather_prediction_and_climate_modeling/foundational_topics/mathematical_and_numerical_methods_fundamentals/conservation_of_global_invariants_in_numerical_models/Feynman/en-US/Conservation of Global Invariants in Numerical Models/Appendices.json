{
    "hands_on_practices": [
        {
            "introduction": "To build robust numerical models, we must first understand the theoretical underpinnings of conservation. This foundational exercise guides you through a proof that a properly formulated finite-volume scheme perfectly conserves a total quantity, like mass, on a periodic domain in the absence of sources or sinks . The key insight lies in how fluxes between adjacent cells cancel out in a telescoping sum, a core principle of conservative methods.",
            "id": "4025760",
            "problem": "Consider a passive tracer field $\\phi(\\mathbf{x},t)$ advected by a velocity field $\\mathbf{u}(\\mathbf{x},t)$ in a spatially periodic domain $\\Omega \\subset \\mathbb{R}^{d}$ with periodic boundary $\\partial\\Omega$. The tracer satisfies the conservation law $\\frac{\\partial \\phi}{\\partial t} + \\nabla \\cdot (\\phi \\mathbf{u}) = S$, where $S(\\mathbf{x},t)$ is a prescribed source per unit volume, and the velocity field is divergence-free, $\\nabla \\cdot \\mathbf{u} = 0$. Assume $\\phi$ has the physical unit $\\mathrm{kg}\\,\\mathrm{m}^{-3}$ and $\\mathbf{u}$ has the unit $\\mathrm{m}\\,\\mathrm{s}^{-1}$ so that the integral $\\int_{\\Omega} \\phi\\, dV$ has the unit $\\mathrm{kg}$ and its time derivative has the unit $\\mathrm{kg}\\,\\mathrm{s}^{-1}$.\n\nDiscretize $\\Omega$ with a fixed tessellation into $N$ non-overlapping control volumes $\\{C_{i}\\}_{i=1}^{N}$ of volumes $V_{i}$ and planar faces $\\{f\\}$ of areas $A_{f}$. For each interior face $f$ shared by cells $i$ and $j$, fix a single outward unit normal $\\mathbf{n}_{f}$ pointing from $C_{i}$ to $C_{j}$. Let $\\phi_{i}(t)$ denote the cell-average of $\\phi$ over $C_{i}$, and let $\\Phi_{f}$ denote the numerical face flux that consistently approximates $(\\phi \\mathbf{u}) \\cdot \\mathbf{n}_{f} A_{f}$ with a scheme of formal order $2$, constructed by a single-face, conservative, linear reconstruction from the appropriate upwind side on each face. The finite-volume update for each $i$ is\n$$\n\\frac{d}{dt}\\big(\\phi_{i} V_{i}\\big) = - \\sum_{f \\subset \\partial C_{i}} s_{i,f}\\,\\Phi_{f} + S_{i} V_{i},\n$$\nwhere $s_{i,f} \\in \\{-1,+1\\}$ is the sign indicating whether the fixed face normal $\\mathbf{n}_{f}$ points out of ($+1$) or into ($-1$) cell $C_{i}$, and $S_{i}$ is the cell-average of $S$ in $C_{i}$. On periodic boundaries, faces are paired with oppositely oriented counterparts so that the same convention applies.\n\nStarting solely from the continuous conservation law, the divergence-free property, the periodicity, and the stated conservative finite-volume form (including the single-face flux construction and sign convention), derive the exact expression for the global rate of change of the domain-integrated tracer,\n$$\n\\frac{d}{dt}\\int_{\\Omega} \\phi\\, dV,\n$$\nthat is implied by the described second-order finite-volume advection scheme. Then, for the special case $S \\equiv 0$, compute the value of $\\frac{d}{dt}\\int_{\\Omega}\\phi\\, dV$. Express your final answer in $\\mathrm{kg}\\,\\mathrm{s}^{-1}$, rounded only if required; do not include any unit symbols in your final boxed answer. No hint formulas are provided; you must reason from the conservation law, the face-flux anti-symmetry in a conservative finite-volume method, and periodic boundary conditions to reach your conclusion.",
            "solution": "The problem asks for the rate of change of the total amount of a passive tracer $\\phi$ within a periodic domain $\\Omega$, as implied by a specific finite-volume numerical scheme.\n\nLet the total amount of the tracer in the domain, as represented by the discrete model, be $M(t)$. This is the sum of the tracer mass in each control volume $C_i$:\n$$\nM(t) = \\sum_{i=1}^{N} \\phi_i(t) V_i\n$$\nHere, $\\phi_i(t)$ is the cell-average concentration in cell $C_i$ of volume $V_i$, and $N$ is the total number of cells. The problem is asking for the derivation of an expression for $\\frac{dM}{dt}$ based on the provided numerical scheme.\n\nThe time evolution of the tracer amount in a single cell $C_i$ is given by the finite-volume update equation:\n$$\n\\frac{d}{dt}\\big(\\phi_{i} V_{i}\\big) = - \\sum_{f \\subset \\partial C_{i}} s_{i,f}\\,\\Phi_{f} + S_{i} V_{i}\n$$\nwhere $\\Phi_f$ is the numerical flux across a face $f$, $s_{i,f}$ is a sign factor, and $S_i$ is the cell-averaged source term.\n\nTo find the rate of change of the total tracer amount $M(t)$, we sum the individual rates of change over all $N$ control volumes in the domain:\n$$\n\\frac{dM}{dt} = \\frac{d}{dt}\\left(\\sum_{i=1}^{N} \\phi_i V_i\\right) = \\sum_{i=1}^{N} \\frac{d}{dt}(\\phi_i V_i)\n$$\nSubstituting the given finite-volume equation into this sum yields:\n$$\n\\frac{dM}{dt} = \\sum_{i=1}^{N} \\left( - \\sum_{f \\subset \\partial C_{i}} s_{i,f}\\,\\Phi_{f} + S_{i} V_{i} \\right)\n$$\nWe can separate the terms into a flux summation and a source summation:\n$$\n\\frac{dM}{dt} = - \\left( \\sum_{i=1}^{N} \\sum_{f \\subset \\partial C_{i}} s_{i,f}\\,\\Phi_{f} \\right) + \\left( \\sum_{i=1}^{N} S_{i} V_{i} \\right)\n$$\nLet us analyze the flux summation term, $\\mathcal{F} = \\sum_{i=1}^{N} \\sum_{f \\subset \\partial C_{i}} s_{i,f}\\,\\Phi_{f}$. This represents the sum of all fluxes over all faces of all cells. We can analyze the contribution of each face to this global sum.\n\nA key feature of a conservative finite-volume scheme is that the numerical flux $\\Phi_f$ is uniquely defined for each face $f$. The problem states the scheme uses a \"single-face, conservative\" construction, which guarantees this property.\n\nConsider an interior face $f$ that is shared between two adjacent control volumes, $C_i$ and $C_j$. The problem defines a fixed unit normal $\\mathbf{n}_f$ for this face, pointing from $C_i$ to $C_j$.\nAccording to the sign convention:\n- For cell $C_i$, the normal $\\mathbf{n}_f$ points outward, so $s_{i,f} = +1$. The contribution of this face from cell $C_i$ to the sum $\\mathcal{F}$ is $(+1)\\Phi_f$.\n- For cell $C_j$, the same normal $\\mathbf{n}_f$ points inward, so $s_{j,f} = -1$. The contribution of this face from cell $C_j$ to the sum $\\mathcal{F}$ is $(-1)\\Phi_f$.\n\nWhen we sum over all cells, the total contribution from this interior face $f$ is the sum of the contributions from $C_i$ and $C_j$, which is $(+1)\\Phi_f + (-1)\\Phi_f = 0$. Therefore, all fluxes across interior faces cancel out in pairs.\n\nNow, consider the faces on the boundary $\\partial\\Omega$ of the domain. The problem states that the domain is periodic. In a periodic domain, each boundary face on one side of the domain is identified with a corresponding boundary face on the opposite side. This pairing effectively makes the domain topologically closed, with no external boundaries. The pair of periodic boundary faces acts as a single logical interior interface. The \"single-face, conservative\" flux construction and the sign convention apply to these logical interfaces just as they do to geometric interior faces. Consequently, the flux contributions from these periodic boundary faces also cancel out in pairs when summed over the entire domain.\n\nSince all interior face fluxes cancel and all periodic boundary face fluxes cancel, the total flux summation is identically zero:\n$$\n\\mathcal{F} = \\sum_{i=1}^{N} \\sum_{f \\subset \\partial C_{i}} s_{i,f}\\,\\Phi_{f} = 0\n$$\nThis result is a fundamental property of conservative finite-volume schemes on closed or periodic domains. The details about the scheme being second-order or the velocity field being divergence-free, while important for other properties of the scheme, are not required to prove this global conservation property.\n\nSubstituting this result back into the expression for $\\frac{dM}{dt}$, we find:\n$$\n\\frac{dM}{dt} = - (0) + \\sum_{i=1}^{N} S_{i} V_{i}\n$$\nThus, the exact expression for the global rate of change of the domain-integrated tracer, as implied by the described finite-volume scheme, is:\n$$\n\\frac{d}{dt}\\left(\\sum_{i=1}^{N} \\phi_i V_i\\right) = \\sum_{i=1}^{N} S_{i} V_{i}\n$$\nThis demonstrates that the scheme correctly ensures that the total tracer amount changes only due to the integrated effect of the source term $S$.\n\nThe second part of the problem asks to compute this value for the special case where the source term $S$ is identically zero, i.e., $S(\\mathbf{x},t) \\equiv 0$. If the function $S$ is zero everywhere, then its average over any control volume $C_i$ must also be zero:\n$$\nS_{i} = \\frac{1}{V_i} \\int_{C_i} S(\\mathbf{x},t) dV = \\frac{1}{V_i} \\int_{C_i} 0 \\, dV = 0 \\quad \\text{for all } i=1, \\dots, N\n$$\nSubstituting $S_i = 0$ into our derived expression for the rate of change gives:\n$$\n\\frac{dM}{dt} = \\sum_{i=1}^{N} (0) V_{i} = 0\n$$\nThe value of the global rate of change of the domain-integrated tracer, in the absence of sources, is $0$. The units, as specified by the problem, would be $\\mathrm{kg}\\,\\mathrm{s}^{-1}$.",
            "answer": "$$\n\\boxed{0}\n$$"
        },
        {
            "introduction": "Theoretical conservation is a crucial first step, but its principles must hold on the complex, non-trivial grids used in modern global models. This practice challenges you to implement the geometry of a cubed-sphere grid, a popular choice for global weather and climate simulations, and numerically verify that global mass conservation is achieved . Successfully completing this task demonstrates how the abstract concept of flux cancellation translates into a robust algorithm on a curved manifold.",
            "id": "4025781",
            "problem": "Consider a Conservative Finite Volume (FV) discretization on the Cubed-Sphere (CS) for a scalar tracer field on the two-dimensional surface of the unit sphere. The objective is to demonstrate that the discrete sum of area-weighted fluxes across all panel boundaries cancels to machine precision, thereby preserving Global Mass Conservation (GMC) globally.\n\nFundamental laws and core definitions to start from:\n- The surface continuity equation on a smooth two-dimensional manifold (the unit sphere) for a scalar field $q(\\mathbf{r},t)$ transported by a tangential velocity $\\mathbf{u}(\\mathbf{r},t)$ is\n$$\\frac{\\mathrm{d}}{\\mathrm{d}t}\\int_{\\Omega} q \\, \\mathrm{d}A = -\\oint_{\\partial \\Omega} q\\, \\mathbf{u}\\cdot \\mathbf{n}_s \\, \\mathrm{d}s,$$\nwhere $\\Omega$ is a surface control volume, $\\partial \\Omega$ its boundary curve, $\\mathbf{n}_s$ the outward unit normal within the tangent plane (perpendicular to the boundary tangent), and $\\mathrm{d}A$, $\\mathrm{d}s$ the area and arc-length elements respectively.\n- The finite-volume method approximates the boundary integral by a sum of edge fluxes,\n$$\\mathcal{F}_e \\approx q_e \\, (\\mathbf{u}_e \\cdot \\mathbf{n}_{s,e})\\, \\ell_e,$$\nwhere $q_e$ is the edge-centered tracer value, $\\mathbf{u}_e$ the edge-centered tangential velocity, $\\mathbf{n}_{s,e}$ the outward unit normal within the surface at the edge, and $\\ell_e$ the edge length.\n\nCubed-sphere equiangular gnomonic mapping:\n- For each CS panel, define panel-local coordinates $(\\alpha,\\beta)\\in[-\\pi/4,\\pi/4]\\times[-\\pi/4,\\pi/4]$ and the gnomonic coordinates $(\\xi,\\eta)=(\\tan\\alpha,\\tan\\beta)$.\n- The mapping from panel-local coordinates to the unit sphere $\\mathbf{r}(\\alpha,\\beta)$ is given by normalizing a face-dependent vector:\n  - Panel $+X$: $\\mathbf{r} = \\frac{1}{\\|\\mathbf{v}\\|}\\mathbf{v}$ with $\\mathbf{v}=(1,\\tan\\alpha,\\tan\\beta)$.\n  - Panel $-X$: $\\mathbf{v}=(-1,\\tan\\alpha,\\tan\\beta)$.\n  - Panel $+Y$: $\\mathbf{v}=(\\tan\\alpha,1,\\tan\\beta)$.\n  - Panel $-Y$: $\\mathbf{v}=(\\tan\\alpha,-1,\\tan\\beta)$.\n  - Panel $+Z$: $\\mathbf{v}=(\\tan\\alpha,\\tan\\beta,1)$.\n  - Panel $-Z$: $\\mathbf{v}=(\\tan\\alpha,\\tan\\beta,-1)$.\n- The unit sphere has radius $R=1$ and position vector $\\mathbf{r}=(x,y,z)$ satisfies $\\|\\mathbf{r}\\|=1$.\n\nVelocity fields on the sphere:\n- A tangential velocity can be constructed by projecting a constant vector $\\mathbf{a}$ onto the tangent plane:\n$$\\mathbf{u}(\\mathbf{r}) = \\mathbf{a} - (\\mathbf{a}\\cdot \\mathbf{r})\\, \\mathbf{r},$$\nwhich is everywhere tangent to the unit sphere.\n- A solid-body rotation with angular velocity $\\boldsymbol{\\omega}$ induces a tangential velocity\n$$\\mathbf{u}(\\mathbf{r}) = \\boldsymbol{\\omega}\\times \\mathbf{r}.$$\n\nEdge geometry on the CS:\n- An edge is defined by two neighboring boundary nodes $\\mathbf{r}_0$ and $\\mathbf{r}_1$. Its midpoint is $\\mathbf{r}_m=\\frac{\\mathbf{r}_0+\\mathbf{r}_1}{\\|\\mathbf{r}_0+\\mathbf{r}_1\\|}$.\n- The edge length is the great-circle distance\n$$\\ell_e = \\arccos\\big(\\mathbf{r}_0\\cdot\\mathbf{r}_1\\big).$$\n- The great-circle plane normal is $\\mathbf{n}_p=\\mathbf{r}_0\\times\\mathbf{r}_1$. A unit tangent along the edge at $\\mathbf{r}_m$ is\n$$\\mathbf{t}_e = \\frac{\\mathbf{n}_p\\times \\mathbf{r}_m}{\\|\\mathbf{n}_p\\times \\mathbf{r}_m\\|}.$$\n- A candidate outward unit normal within the surface is\n$$\\mathbf{n}_{s,e}^\\star = \\frac{\\mathbf{t}_e\\times \\mathbf{r}_m}{\\|\\mathbf{t}_e\\times \\mathbf{r}_m\\|}.$$\nThe sign of $\\mathbf{n}_{s,e}$ is chosen so that it points away from the panel interior, determined by the local interior direction inferred from panel-local coordinate increments. For example, at the left boundary $\\alpha=-\\pi/4$, the interior direction is along increasing $\\alpha$; at the right boundary $\\alpha=\\pi/4$, it is along decreasing $\\alpha$; similarly for the bottom and top boundaries with $\\beta$.\n\nDiscrete FV fluxes:\n- Use a line-integrated flux per boundary segment:\n$$\\mathcal{F}_e = q(\\mathbf{r}_m) \\, \\big(\\mathbf{u}(\\mathbf{r}_m)\\cdot \\mathbf{n}_{s,e}\\big)\\, \\ell_e,$$\nwhere $q(\\mathbf{r})$ is a prescribed smooth field evaluated at the edge midpoint (thus representing an area-weighted edge-centered value when used in cell updates).\n- The net outward flux from a panel is the sum of $\\mathcal{F}_e$ over its boundary segments with $\\mathbf{n}_{s,e}$ chosen outward relative to the panel interior.\n\nDemonstration aim:\n- Show numerically that when summing the net outward fluxes of all six panels, each shared boundary segment contributes twice with opposite sign (due to opposite outward normals), so the total sum cancels to machine precision.\n\nImplementation tasks:\n1. Construct the CS nodes for each panel by uniform sampling of $(\\alpha,\\beta)$ in radians on $[-\\pi/4,\\pi/4]$ with $N+1$ nodes per direction, resulting in $N$ segments along each side.\n2. For each panel, build its boundary segments (left, right, bottom, top), compute $\\mathbf{r}_0$, $\\mathbf{r}_1$, $\\mathbf{r}_m$, $\\ell_e$, $\\mathbf{t}_e$, and outward $\\mathbf{n}_{s,e}$ using the interior direction test via panel-local increments.\n3. Define smooth tracer and velocity fields:\n   - Tracer: $q(\\mathbf{r}) = \\sin(2\\lambda)\\cos\\varphi$, where $\\lambda=\\arctan2(y,x)$ is longitude (radians) and $\\varphi=\\arcsin(z)$ is latitude (radians).\n   - Velocity: either the projected constant vector or solid-body rotation as described above.\n4. Compute the net outward flux $\\mathcal{F}_{\\text{panel}}=\\sum_e \\mathcal{F}_e$ for each panel, then compute the sum over all six panels and report its absolute value.\n5. Test suite specifications:\n   - Use the following test cases, each specified by $(N,\\text{field type},\\text{parameters})$:\n     - Case 1: $(N=4,\\text{projected},\\mathbf{a}=(0.3,-0.5,0.7))$.\n     - Case 2: $(N=8,\\text{projected},\\mathbf{a}=(-0.1,0.2,0.3))$.\n     - Case 3: $(N=4,\\text{rotation},\\boldsymbol{\\omega}=(0,0,1))$.\n     - Case 4: $(N=1,\\text{projected},\\mathbf{a}=(0.9,-0.4,0.2))$ (edge case with minimal resolution).\n6. Unit specification: angles are in radians; the flux magnitude is dimensionless given the unit sphere radius $R=1$ and dimensionless tracer $q$ and velocity parameters. Report the final sum as a float.\n7. Final output specification: Your program should produce a single line of output containing the absolute values of the total flux sums for the four cases as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3,result4]\"), where each result is a float.\n\nYour code must implement the above steps exactly and produce the specified output format. No user input is required. Ensure numerical robustness by normalizing vectors, clipping arguments to inverse trigonometric functions to $[-1,1]$, and carefully choosing outward normal signs via the interior direction test.",
            "solution": "The problem statement is a valid and well-posed exercise in computational fluid dynamics, specifically concerning the verification of conservation properties in a numerical scheme. It is scientifically grounded in the principles of vector calculus on manifolds and finite volume methods. All required definitions, equations, and parameters are provided, and the objective is clear and numerically verifiable. We will therefore proceed with a full solution.\n\nThe core principle to be demonstrated is Global Mass Conservation (GMC) for a scalar tracer field $q$ transported on the surface of a unit sphere. In a continuous system without sources or sinks, the total mass, given by the integral of $q$ over the entire sphere surface $S^2$, must remain constant over time.\n$$ \\frac{\\mathrm{d}}{\\mathrm{d}t} \\int_{S^2} q \\, \\mathrm{d}A = 0 $$\nApplying the divergence theorem (or Stokes' theorem in this 2D manifold context) to the transport equation, this conservation law is equivalent to the statement that the integral of the flux divergence over the domain is zero. For a closed manifold like a sphere, which has no boundary, the net flux across any closed curve partitioning the domain must be zero when summed over the entire domain.\n\nIn a Finite Volume (FV) discretization, the domain is partitioned into a finite number of control volumes (cells). For the Cubed-Sphere (CS) grid, the sphere is partitioned into six panels, each corresponding to the face of a cube. Each panel is further subdivided into $N \\times N$ cells. The change of mass in a cell is determined by the sum of fluxes across its boundaries. Global conservation is achieved if, for any two adjacent cells, the flux leaving one cell across their shared boundary is identical to the flux entering the other cell. This requires that the flux calculation is conservative.\n\nThe problem asks to verify this property at the panel level. If we sum the net outward fluxes from all six panels, the contributions from all internal edges shared between panels must cancel out perfectly, leaving a sum that is zero to within machine precision. This confirms that the discrete flux formulation globally conserves the tracer quantity.\n\nThe step-by-step derivation and implementation plan is as follows:\n\n**1. Cubed-Sphere Grid Generation**\n\nThe cubed-sphere grid is generated by projecting the faces of a cube onto a concentric sphere. We use an equiangular gnomonic projection. For each of the six panels, we define a local coordinate system $(\\alpha, \\beta)$, where both $\\alpha$ and $\\beta$ range from $-\\pi/4$ to $+\\pi/4$. These angles are related to gnomonic coordinates $(\\xi, \\eta)$ by $\\xi = \\tan\\alpha$ and $\\eta=\\tan\\beta$.\n\nA point on a panel is mapped to a $3$D vector $\\mathbf{v}$ which is then normalized to obtain the position vector $\\mathbf{r}$ on the unit sphere ($\\|\\mathbf{r}\\|=1$). The specific mappings for each panel are given as:\n- Panel $+X$: $\\mathbf{v}=(1, \\tan\\alpha, \\tan\\beta)$\n- Panel $-X$: $\\mathbf{v}=(-1, \\tan\\alpha, \\tan\\beta)$\n- Panel $+Y$: $\\mathbf{v}=(\\tan\\alpha, 1, \\tan\\beta)$\n- Panel $-Y$: $\\mathbf{v}=(\\tan\\alpha, -1, \\tan\\beta)$\n- Panel $+Z$: $\\mathbf{v}=(\\tan\\alpha, \\tan\\beta, 1)$\n- Panel $-Z$: $\\mathbf{v}=(\\tan\\alpha, \\tan\\beta, -1)$\n\nFor a grid resolution of $N$ cells per direction, we need $N+1$ nodes. The panel-local coordinates $(\\alpha_i, \\beta_j)$ are discretized uniformly:\n$$ \\alpha_i = -\\frac{\\pi}{4} + i \\cdot \\Delta\\alpha, \\quad i \\in \\{0, 1, \\dots, N\\} $$\n$$ \\beta_j = -\\frac{\\pi}{4} + j \\cdot \\Delta\\beta, \\quad j \\in \\{0, 1, \\dots, N\\} $$\nwhere $\\Delta\\alpha = \\Delta\\beta = \\frac{\\pi/2}{N}$. These $(\\alpha_i, \\beta_j)$ pairs are used to generate the $3$D Cartesian coordinates of the grid nodes $\\mathbf{r}_{i,j}$ for each panel.\n\n**2. Boundary Edge Geometry and Flux Calculation**\n\nWe compute the net flux out of each panel by summing the fluxes over all segments of its four boundaries (left, right, bottom, top). For a single edge segment defined by two nodes $\\mathbf{r}_0$ and $\\mathbf{r}_1$, the discrete flux is:\n$$ \\mathcal{F}_e = q(\\mathbf{r}_m) \\, \\big(\\mathbf{u}(\\mathbf{r}_m)\\cdot \\mathbf{n}_{s,e}\\big)\\, \\ell_e $$\nThe geometric and physical components are calculated as follows:\n\n- **Edge Midpoint:** The midpoint $\\mathbf{r}_m$ is found by averaging the node vectors and re-projecting to the unit sphere:\n  $$ \\mathbf{r}_m = \\frac{\\mathbf{r}_0 + \\mathbf{r}_1}{\\|\\mathbf{r}_0 + \\mathbf{r}_1\\|} $$\n- **Edge Length:** The length $\\ell_e$ is the great-circle distance between $\\mathbf{r}_0$ and $\\mathbf{r}_1$. To ensure numerical stability, the argument of $\\arccos$ is clipped to $[-1, 1]$.\n  $$ \\ell_e = \\arccos(\\text{clip}(\\mathbf{r}_0\\cdot\\mathbf{r}_1, -1, 1)) $$\n- **Outward Normal Vector:** This is the most critical component for ensuring conservation. The process is:\n  a. Compute a candidate normal $\\mathbf{n}_{s,e}^\\star$ which is perpendicular to both the radial direction $\\mathbf{r}_m$ and the edge tangent $\\mathbf{t}_e$.\n     $$ \\mathbf{n}_p = \\mathbf{r}_0 \\times \\mathbf{r}_1 \\quad (\\text{Normal to the great-circle plane}) $$\n     $$ \\mathbf{t}_e = \\frac{\\mathbf{n}_p \\times \\mathbf{r}_m}{\\|\\mathbf{n}_p \\times \\mathbf{r}_m\\|} \\quad (\\text{Unit tangent along the edge at } \\mathbf{r}_m) $$\n     $$ \\mathbf{n}_{s,e}^\\star = \\frac{\\mathbf{t}_e \\times \\mathbf{r}_m}{\\|\\mathbf{t}_e \\times \\mathbf{r}_m\\|} \\quad (\\text{Candidate unit normal in the tangent plane}) $$\n  b. Determine the correct orientation (outward vs. inward). This is achieved by the \"interior direction test\". We construct a vector pointing from the edge into the panel's interior and ensure the normal $\\mathbf{n}_{s,e}$ points in the opposite direction. An interior-pointing vector $\\mathbf{v}_{\\text{int}}$ is found by taking a small step from the edge midpoint's $(\\alpha, \\beta)$ coordinates into the panel. For instance, on the left boundary ($\\alpha = -\\pi/4$), the interior is towards $\\alpha > -\\pi/4$. We can compute a point $\\mathbf{r}_{\\text{int}}$ at $(\\alpha+\\delta\\alpha, \\beta)$ for a small $\\delta\\alpha > 0$. The vector from $\\mathbf{r}_m$ to $\\mathbf{r}_{\\text{int}}$, projected onto the tangent plane at $\\mathbf{r}_m$, gives the interior direction. The sign of $\\mathbf{n}_{s,e}$ is chosen such that its dot product with this interior-pointing vector is negative. Let $\\mathbf{v}_{\\text{in,tan}}$ be the tangent-plane component of the interior-pointing vector.\n     $$ \\text{sign} = \\text{sgn}(\\mathbf{v}_{\\text{in,tan}} \\cdot \\mathbf{n}_{s,e}^\\star) $$\n     The outward normal is $\\mathbf{n}_{s,e} = -\\text{sign} \\cdot \\mathbf{n}_{s,e}^\\star$. This precise, consistent definition ensures that for any shared edge between two panels, their respective outward normals are equal and opposite: $\\mathbf{n}_{s,e}^{(\\text{panel 1})} = -\\mathbf{n}_{s,e}^{(\\text{panel 2})}$.\n\n**3. Physical Fields**\n\nThe problem specifies a smooth tracer field and two types of velocity fields, evaluated at edge midpoints $\\mathbf{r}_m = (x_m, y_m, z_m)$.\n- **Tracer Field:** $q(\\mathbf{r}) = \\sin(2\\lambda)\\cos\\varphi$, where longitude $\\lambda = \\arctan2(y_m, x_m)$ and latitude $\\varphi = \\arcsin(z_m)$.\n- **Projected Velocity Field:** A constant vector $\\mathbf{a}$ is projected onto the tangent plane at $\\mathbf{r}_m$:\n  $$ \\mathbf{u}(\\mathbf{r}_m) = \\mathbf{a} - (\\mathbf{a}\\cdot \\mathbf{r}_m)\\, \\mathbf{r}_m $$\n- **Solid-Body Rotation Velocity Field:** A velocity field induced by a solid-body rotation with angular velocity $\\boldsymbol{\\omega}$:\n  $$ \\mathbf{u}(\\mathbf{r}_m) = \\boldsymbol{\\omega}\\times \\mathbf{r}_m $$\n\n**4. Summation and Verification**\n\nFor each of the six panels, we compute the net outward flux $\\mathcal{F}_{\\text{panel}}$ by summing the fluxes $\\mathcal{F}_e$ over all $4N$ boundary edges.\n$$ \\mathcal{F}_{\\text{panel}} = \\sum_{e \\in \\partial(\\text{panel})} \\mathcal{F}_e $$\nThe total global flux is the sum of these panel fluxes:\n$$ \\mathcal{F}_{\\text{total}} = \\sum_{k=1}^{6} \\mathcal{F}_{\\text{panel}, k} $$\nBecause for every internal edge the geometric terms are identical and the outward normals are opposite, their flux contributions cancel, i.e., $\\mathcal{F}_e^{(1)} + \\mathcal{F}_e^{(2)} = 0$. Therefore, the total sum $\\mathcal{F}_{\\text{total}}$ should be zero. The implementation will calculate this sum and report its absolute value, which is expected to be on the order of machine precision due to floating-point arithmetic. This validates the conservative nature of the discrete flux formulation.\nThe test cases provided, with varying resolutions $N$ and velocity fields, will be used to demonstrate this property's robustness.",
            "answer": "```python\nimport numpy as np\n\ndef gnomonic_map(panel_idx, alpha, beta):\n    \"\"\"\n    Maps panel-local coordinates (alpha, beta) to 3D Cartesian coordinates\n    on the unit sphere for a given panel index.\n    \"\"\"\n    v = np.zeros(3)\n    tan_a, tan_b = np.tan(alpha), np.tan(beta)\n    \n    if panel_idx == 0:  # +X\n        v = np.array([1.0, tan_a, tan_b])\n    elif panel_idx == 1:  # -X\n        v = np.array([-1.0, tan_a, tan_b])\n    elif panel_idx == 2:  # +Y\n        v = np.array([tan_a, 1.0, tan_b])\n    elif panel_idx == 3:  # -Y\n        v = np.array([tan_a, -1.0, tan_b])\n    elif panel_idx == 4:  # +Z\n        v = np.array([tan_a, tan_b, 1.0])\n    elif panel_idx == 5:  # -Z\n        v = np.array([tan_a, tan_b, -1.0])\n    \n    norm_v = np.linalg.norm(v)\n    return v / norm_v if norm_v > 0 else v\n\ndef get_panel_nodes(panel_idx, N):\n    \"\"\"\n    Constructs the N+1 x N+1 node coordinates for a given panel.\n    \"\"\"\n    nodes = np.zeros((N + 1, N + 1, 3))\n    alpha_vals = np.linspace(-np.pi / 4, np.pi / 4, N + 1)\n    beta_vals = np.linspace(-np.pi / 4, np.pi / 4, N + 1)\n    \n    for i in range(N + 1):\n        for j in range(N + 1):\n            nodes[i, j, :] = gnomonic_map(panel_idx, alpha_vals[i], beta_vals[j])\n            \n    return nodes\n\ndef get_tracer_field(r):\n    \"\"\"\n    Computes the scalar tracer field q at position r = (x, y, z).\n    \"\"\"\n    x, y, z = r\n    # Clip z to avoid domain errors with arcsin\n    z_clipped = np.clip(z, -1.0, 1.0)\n    \n    lam = np.arctan2(y, x)  # longitude\n    phi = np.arcsin(z_clipped)  # latitude\n    \n    return np.sin(2 * lam) * np.cos(phi)\n\ndef get_velocity_field(r, vel_type, params):\n    \"\"\"\n    Computes the velocity vector u at position r for a given field type.\n    \"\"\"\n    if vel_type == 'projected':\n        a = np.array(params)\n        u = a - (np.dot(a, r)) * r\n    elif vel_type == 'rotation':\n        omega = np.array(params)\n        u = np.cross(omega, r)\n    else:\n        raise ValueError(\"Unknown velocity field type\")\n    return u\n\ndef calculate_total_flux(N, vel_type, params):\n    \"\"\"\n    Calculates the sum of net outward fluxes over all six panels of the cubed-sphere.\n    \"\"\"\n    total_global_flux = 0.0\n    \n    for panel_idx in range(6):\n        panel_flux = 0.0\n        nodes = get_panel_nodes(panel_idx, N)\n        \n        # Define boundaries: (start_idx, end_idx, fixed_coord, step_dir)\n        # fixed_coord: 0 for alpha, 1 for beta\n        # step_dir: 1 for increasing index, -1 for decreasing index\n        # The indices define the start and end of the loop over segments.\n        boundaries = {\n            'bottom': (nodes[:, 0], 0, -np.pi/4, 1), # beta = -pi/4, interior is +beta\n            'top': (nodes[:, -1], 0, np.pi/4, -1),   # beta = +pi/4, interior is -beta\n            'left': (nodes[0, :], 1, -np.pi/4, 1),  # alpha = -pi/4, interior is +alpha\n            'right': (nodes[-1, :], 1, np.pi/4, -1)  # alpha = +pi/4, interior is -alpha\n        }\n        \n        alpha_coords = np.linspace(-np.pi/4, np.pi/4, N + 1)\n        beta_coords = np.linspace(-np.pi/4, np.pi/4, N + 1)\n\n        for _, (boundary_nodes, maj_ax, coord_val, sign_dir) in boundaries.items():\n            for i in range(N):\n                r0 = boundary_nodes[i]\n                r1 = boundary_nodes[i+1]\n                \n                # Edge midpoint\n                r_m = (r0 + r1) / np.linalg.norm(r0 + r1)\n                \n                # Edge length\n                dot_prod = np.clip(np.dot(r0, r1), -1.0, 1.0)\n                l_e = np.arccos(dot_prod)\n\n                if l_e < 1e-15: continue\n\n                # Candidate outward normal\n                n_p = np.cross(r0, r1)\n                t_e_un = np.cross(n_p, r_m)\n                t_e = t_e_un / np.linalg.norm(t_e_un)\n                n_s_star_un = np.cross(t_e, r_m)\n                n_s_star = n_s_star_un / np.linalg.norm(n_s_star_un)\n\n                # Interior direction test for sign of normal\n                delta = 1e-8 # small step\n                if maj_ax == 0: # bottom or top, vary beta\n                    a_m = (alpha_coords[i] + alpha_coords[i+1]) / 2.0\n                    b_m_int = coord_val + sign_dir * delta\n                    r_int = gnomonic_map(panel_idx, a_m, b_m_int)\n                else: # left or right, vary alpha\n                    a_m_int = coord_val + sign_dir * delta\n                    b_m = (beta_coords[i] + beta_coords[i+1]) / 2.0\n                    r_int = gnomonic_map(panel_idx, a_m_int, b_m)\n\n                v_int = r_int - r_m\n                v_int_tan = v_int - np.dot(v_int, r_m) * r_m\n                \n                # The normal must point away from the interior\n                sign = np.sign(np.dot(v_int_tan, n_s_star))\n                n_s_e = sign * n_s_star\n\n                # Evaluate fields at midpoint\n                q_m = get_tracer_field(r_m)\n                u_m = get_velocity_field(r_m, vel_type, params)\n                \n                # Calculate flux for the edge\n                flux_e = q_m * np.dot(u_m, n_s_e) * l_e\n                panel_flux += flux_e\n\n        total_global_flux += panel_flux\n        \n    return abs(total_global_flux)\n\ndef solve():\n    \"\"\"\n    Main solver function to run all test cases and print results.\n    \"\"\"\n    \n    test_cases = [\n        {'N': 4, 'type': 'projected', 'params': (0.3, -0.5, 0.7)},\n        {'N': 8, 'type': 'projected', 'params': (-0.1, 0.2, 0.3)},\n        {'N': 4, 'type': 'rotation', 'params': (0.0, 0.0, 1.0)},\n        {'N': 1, 'type': 'projected', 'params': (0.9, -0.4, 0.2)},\n    ]\n\n    results = []\n    for case in test_cases:\n        total_flux = calculate_total_flux(case['N'], case['type'], case['params'])\n        results.append(total_flux)\n\n    # Format the final output exactly as specified\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == '__main__':\n    solve()\n\n```"
        },
        {
            "introduction": "While spatial discretization can ensure the conservation of linear invariants like mass, conserving non-linear invariants such as total energy presents a greater challenge, especially in fully discrete systems. This exercise delves into this issue by simulating the shallow-water equations, where you will observe energy drift even with a mass-conservative scheme . You will then implement a common and practical technique—an 'a posteriori' corrector—to enforce global energy conservation at each time step, a vital practice for maintaining long-term model stability.",
            "id": "4025765",
            "problem": "You are tasked with designing and implementing a self-contained numerical experiment that quantifies and corrects the drift of global invariants in a nonlinear hyperbolic system representative of large-scale geophysical flow. Use the one-dimensional inviscid shallow-water equations on a periodic domain as the prototype system, which are a standard reduced model in numerical weather prediction and climate modeling for assessing conservation of global invariants. Throughout, work in nondimensional units; no physical units are required.\n\nBase the derivation on the following fundamental laws and core definitions:\n- The one-dimensional inviscid shallow-water equations on a periodic domain of length $L$ are given by\n  - Continuity: $\\partial_t h + \\partial_x (h u) = 0$,\n  - Momentum: $\\partial_t (h u) + \\partial_x \\left(h u^2 + \\tfrac{1}{2} g h^2\\right) = 0$,\n  where $h(x,t)$ is the layer depth, $u(x,t)$ is the velocity, and $g$ is the gravitational acceleration parameter.\n- The global mass $M(t)$ and total energy $E(t)$ are\n  $$M(t) = \\int_{0}^{L} h(x,t)\\,dx,$$\n  $$E(t) = \\int_{0}^{L} \\left(\\tfrac{1}{2} g h(x,t)^2 + \\tfrac{1}{2} h(x,t) u(x,t)^2\\right)\\,dx.$$\n  On a periodic domain, the continuous equations imply $\\frac{dM}{dt} = 0$ and $\\frac{dE}{dt} = 0$.\n- An adaptive time stepping is determined by a Courant-Friedrichs-Lewy (CFL) condition, where the time step $\\Delta t$ at each step satisfies\n  $$\\Delta t = \\mathrm{CFL}\\, \\frac{\\Delta x}{\\max_i\\left(|u_i| + \\sqrt{g h_i}\\right)},$$\n  with $\\Delta x = L/N$ for $N$ uniform cells.\n\nYour tasks are:\n1) Discretize the system on a uniform periodic grid using any conservative method that computes the divergence of fluxes in a form that exactly conserves the discretized mass in the absence of sources and sinks, and integrate in time with an explicit method and adaptive time stepping based on the CFL condition. The discrete variables are the cell averages $h_i(t)$ and $m_i(t) = h_i(t) u_i(t)$.\n2) Using this discretization, simulate the system over a finite time interval $[0,T]$ with adaptive time stepping and quantify the cumulative drift of the global invariants, defined as the final absolute deviations\n   $$\\Delta M = |M(T) - M(0)|,\\quad \\Delta E = |E(T) - E(0)|.$$\n3) Propose and implement a global correction strategy that enforces at each full time step both the mass and the energy constraints in the discrete sense. Your correction must be limited to spatially uniform transformations that do not alter the discrete flux form of the update, specifically:\n   - Mass correction: shift the layer depth by a constant offset $\\delta$ so that the corrected discrete mass equals the initial mass, i.e., set $h_i \\leftarrow h_i + \\delta$ where $\\delta$ is chosen such that $\\sum_i h_i \\Delta x = M(0)$.\n   - Energy correction: rescale the velocity field uniformly by a factor $\\alpha$ (equivalently rescale the momentum $m_i = h_i u_i$ by $\\alpha$ while keeping $h_i$ unchanged) so that after mass correction the total energy equals its initial value. If the kinetic energy is zero or the desired kinetic energy implied by the fixed total energy and current potential energy is nonpositive, leave the velocity unchanged. Formally, with $P = \\tfrac{1}{2} g \\sum_i h_i^2 \\Delta x$ and $K = \\tfrac{1}{2} \\sum_i h_i u_i^2 \\Delta x$, choose $\\alpha = \\sqrt{\\max(E(0) - P, 0)/\\max(K, \\epsilon)}$ for a small numerical tolerance $\\epsilon$, and rescale $u_i \\leftarrow \\alpha u_i$ (equivalently $m_i \\leftarrow \\alpha m_i$).\n4) Evaluate the cumulative drifts $\\Delta M$ and $\\Delta E$ for two scenarios on identical configurations: (a) without correction and (b) with the mass-and-energy correction applied after each full time step. Report four quantities per configuration: the final absolute mass drift without correction, the final absolute energy drift without correction, the final absolute mass drift with correction, and the final absolute energy drift with correction.\n\nInitial and boundary-value setup:\n- Domain: $x \\in [0,L)$ with periodic boundary conditions and $L = 1$.\n- Grid: $N$ uniform cells, $\\Delta x = L/N$.\n- Initial condition: \n  $$h(x,0) = H_0 + a \\cos(2\\pi x),\\quad u(x,0) = U_0 + b \\sin(2\\pi x).$$\n- Parameters: $H_0 > 0$, small amplitudes $a$ and $b$, gravitational acceleration parameter $g > 0$, and final time $T > 0$.\n- Time integration: explicit, adaptive step size from the CFL condition above with the supplied $\\mathrm{CFL}$ number. Angles, if any appear in trigonometric functions, are to be interpreted in radians.\n\nTest suite:\nImplement and run your program on the following parameter sets, each specified as a tuple $(N, \\mathrm{CFL}, T, H_0, U_0, a, b, g)$:\n- Case 1 (general): $(128, 0.50, 1.0, 1.0, 0.0, 0.05, 0.10, 1.0)$.\n- Case 2 (near-CFL boundary): $(64, 0.90, 2.0, 1.0, 0.10, 0.02, 0.02, 1.0)$.\n- Case 3 (degenerate kinetic energy start): $(256, 0.30, 1.0, 1.0, 0.0, 0.05, 0.0, 1.0)$.\n\nProgram output specification:\n- For each test case, compute the four floats\n  - $\\Delta M$ without correction,\n  - $\\Delta E$ without correction,\n  - $\\Delta M$ with correction,\n  - $\\Delta E$ with correction.\n- Aggregate the results from all test cases into a single line of output containing a comma-separated list of $12$ floats enclosed in square brackets (for example, \"[r1,r2,...,r12]\"). Use decimal numbers. Do not print any other text.\n\nYour program must be a single, self-contained, runnable script that performs all computations and prints the results in the exact specified format. No user input or external files are permitted. The solution should be general and correct for the entire test suite as stated above.",
            "solution": "The problem requires the design and implementation of a numerical experiment to study the conservation of global invariants in a numerical model of the one-dimensional inviscid shallow-water equations. The tasks involve discretizing the system, simulating its evolution with and without a proposed correction scheme, and quantifying the drift in the global mass and total energy. The problem is well-posed, scientifically grounded, and provides all necessary parameters for a unique numerical solution.\n\nThe governing equations are the one-dimensional inviscid shallow-water equations, which express the conservation of mass and momentum. In vector form, these are given by a system of hyperbolic conservation laws:\n$$\n\\frac{\\partial \\mathbf{U}}{\\partial t} + \\frac{\\partial \\mathbf{F}(\\mathbf{U})}{\\partial x} = \\mathbf{0}\n$$\nwhere $\\mathbf{U}(x,t)$ is the state vector of conserved quantities and $\\mathbf{F}(\\mathbf{U})$ is the flux vector. For this system, the state and flux vectors are:\n$$\n\\mathbf{U} = \\begin{pmatrix} h \\\\ hu \\end{pmatrix} = \\begin{pmatrix} h \\\\ m \\end{pmatrix}, \\quad \\mathbf{F}(\\mathbf{U}) = \\begin{pmatrix} hu \\\\ hu^2 + \\frac{1}{2}gh^2 \\end{pmatrix} = \\begin{pmatrix} m \\\\ \\frac{m^2}{h} + \\frac{1}{2}gh^2 \\end{pmatrix}\n$$\nHere, $h(x,t)$ is the fluid depth, $u(x,t)$ is the fluid velocity, $m(x,t) = h(x,t)u(x,t)$ is the momentum density, and $g$ is the gravitational acceleration parameter. The problem is set on a periodic domain $x \\in [0, L)$.\n\nA conservative numerical method is required. We employ a finite volume method, which is conservative by construction. The domain $[0, L)$ is discretized into $N$ uniform cells $I_i = [x_{i-1/2}, x_{i+1/2}]$ of width $\\Delta x = L/N$. The discrete state variables $\\mathbf{U}_i(t)$ represent the cell averages of the conserved quantities. The semi-discrete form of the equations is:\n$$\n\\frac{d\\mathbf{U}_i}{dt} = -\\frac{1}{\\Delta x} \\left( \\mathbf{F}_{i+1/2} - \\mathbf{F}_{i-1/2} \\right)\n$$\nwhere $\\mathbf{F}_{i \\pm 1/2}$ are the numerical fluxes at the cell interfaces. Summing over all cells $i=0, \\dots, N-1$ with periodic boundaries results in a telescoping sum that cancels to zero, ensuring that the total mass $\\sum_i h_i \\Delta x$ is conserved up to machine precision.\n\nFor the numerical flux, we select the simple and robust Lax-Friedrichs flux. It is defined at the interface $x_{i+1/2}$ between cells $i$ and $i+1$ as:\n$$\n\\mathbf{F}_{i+1/2} = \\frac{1}{2} \\left[ \\mathbf{F}(\\mathbf{U}_i) + \\mathbf{F}(\\mathbf{U}_{i+1}) \\right] - \\frac{1}{2} C_{i+1/2} \\left( \\mathbf{U}_{i+1} - \\mathbf{U}_i \\right)\n$$\nThe dissipation coefficient $C_{i+1/2}$ must be at least the maximum local characteristic speed, ensuring numerical stability. The characteristic speeds (eigenvalues of the flux Jacobian) for the shallow-water system are $u \\pm \\sqrt{gh}$. Thus, a stable choice is:\n$$\nC_{i+1/2} = \\max\\left(|u_i| + \\sqrt{gh_i}, |u_{i+1}| + \\sqrt{gh_{i+1}}\\right)\n$$\n\nFor time integration, an explicit second-order Strong Stability Preserving Runge-Kutta method (SSP-RK2), also known as Heun's method, is used. Given the semi-discrete form $\\frac{d\\mathbf{U}}{dt} = \\mathcal{L}(\\mathbf{U})$, the update from time step $n$ to $n+1$ is performed in two stages:\n1. Intermediate step: $\\mathbf{U}^* = \\mathbf{U}^n + \\Delta t \\, \\mathcal{L}(\\mathbf{U}^n)$\n2. Final step: $\\mathbf{U}^{n+1} = \\frac{1}{2}\\mathbf{U}^n + \\frac{1}{2}\\left( \\mathbf{U}^* + \\Delta t \\, \\mathcal{L}(\\mathbf{U}^*) \\right)$\n\nThe time step $\\Delta t$ is adapted at each iteration based on the Courant-Friedrichs-Lewy (CFL) condition to maintain stability:\n$$\n\\Delta t = \\mathrm{CFL} \\frac{\\Delta x}{\\max_{i}\\left(|u_i| + \\sqrt{g h_i}\\right)}\n$$\nwhere $\\mathrm{CFL}$ is a chosen number less than or equal to $1$ for this scheme.\n\nThe discrete global invariants, mass $M$ and total energy $E$, are calculated by summing over all cells:\n$$\nM(t) = \\sum_{i=0}^{N-1} h_i(t) \\Delta x, \\quad E(t) = \\sum_{i=0}^{N-1} \\left( \\frac{1}{2} g h_i(t)^2 + \\frac{1}{2} h_i(t) u_i(t)^2 \\right) \\Delta x = \\sum_{i=0}^{N-1} \\left( \\frac{1}{2} g h_i(t)^2 + \\frac{1}{2} \\frac{m_i(t)^2}{h_i(t)} \\right) \\Delta x\n$$\nThe simulation is performed for two scenarios. The first scenario proceeds without any modification, and numerical drift is measured. The second scenario applies a correction scheme after each full time step to enforce conservation of initial mass $M_0$ and initial energy $E_0$.\n\nThe correction scheme consists of two steps:\n1.  **Mass Correction**: The fluid depth $h_i$ in each cell is adjusted by a uniform offset $\\delta$. Let $h'_i$ be the depth after a time step. The current mass is $M' = \\sum_i h'_i \\Delta x$. We enforce $\\sum_i (h'_i + \\delta) \\Delta x = M_0$. This gives $M' + \\delta (N \\Delta x) = M_0$, so $\\delta = (M_0 - M')/L$. The corrected depth is $h''_i = h'_i + \\delta$.\n\n2.  **Energy Correction**: After mass correction, the velocity field is rescaled by a uniform factor $\\alpha$ to restore the total energy to its initial value $E_0$. Let $h''_i$ be the mass-corrected depth and $m'_i$ be the momentum from the time step. The potential energy is $P'' = \\frac{1}{2}g \\sum_i (h''_i)^2 \\Delta x$. The kinetic energy, before scaling, is $K'' = \\frac{1}{2}\\sum_i (m'_i)^2/h''_i \\Delta x$. The new kinetic energy after scaling the momentum by $\\alpha$ ($m''_i = \\alpha m'_i$) will be $\\alpha^2 K''$. We require $P'' + \\alpha^2 K'' = E_0$. This leads to the scaling factor specified in the problem:\n$$\n\\alpha = \\sqrt{\\frac{\\max(E_0 - P'', 0)}{\\max(K'', \\epsilon)}}\n$$\nwhere $\\epsilon$ is a small tolerance to prevent division by zero. This formula correctly handles cases where the target kinetic energy $E_0 - P''$ is non-positive by setting $\\alpha=0$, thereby zeroing out the kinetic energy. If the initial kinetic energy is zero, $K''$ will be near zero and the formula handles this case as well.\n\nThe algorithm is implemented for each test case by running two simulations: one with `apply_correction=False` and one with `apply_correction=True`. The final absolute drifts $\\Delta M = |M(T) - M_0|$ and $\\Delta E = |E(T) - E_0|$ are computed and reported for both scenarios. The initial conditions are discretized by evaluating the given functions at the cell centers $x_i = (i+0.5)\\Delta x$.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the shallow-water equation problem for the given test cases.\n    \"\"\"\n    test_cases = [\n        (128, 0.50, 1.0, 1.0, 0.0, 0.05, 0.10, 1.0),\n        (64, 0.90, 2.0, 1.0, 0.10, 0.02, 0.02, 1.0),\n        (256, 0.30, 1.0, 1.0, 0.0, 0.05, 0.0, 1.0),\n    ]\n\n    results = []\n    for params in test_cases:\n        N, CFL, T, H0, U0, a, b, g = params\n        \n        # Run simulation without correction\n        delta_M_uncorr, delta_E_uncorr = run_simulation(N, CFL, T, H0, U0, a, b, g, apply_correction=False)\n        \n        # Run simulation with correction\n        delta_M_corr, delta_E_corr = run_simulation(N, CFL, T, H0, U0, a, b, g, apply_correction=True)\n        \n        results.extend([delta_M_uncorr, delta_E_uncorr, delta_M_corr, delta_E_corr])\n\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef compute_rhs(h, m, g, dx):\n    \"\"\"\n    Computes the right-hand side of the semi-discrete finite volume scheme\n    using the Lax-Friedrichs flux.\n    \"\"\"\n    # Guard against division by zero for h, though it shouldn't be an issue\n    # with the given initial conditions.\n    h_safe = np.maximum(h, 1e-12)\n    u = m / h_safe\n\n    # Flux vectors F(U)\n    Fh = m\n    Fm = m**2 / h_safe + 0.5 * g * h**2\n\n    # Lax-Friedrichs dissipation term\n    c_char = np.abs(u) + np.sqrt(g * h)\n    c_char_p = np.roll(c_char, -1)\n    C_half = np.maximum(c_char, c_char_p)\n\n    # Shifted states for computing flux at i+1/2\n    h_p = np.roll(h, -1)\n    m_p = np.roll(m, -1)\n    Fh_p = np.roll(Fh, -1)\n    Fm_p = np.roll(Fm, -1)\n    \n    # Lax-Friedrichs fluxes at interface i+1/2\n    Fh_lf_half = 0.5 * (Fh + Fh_p) - 0.5 * C_half * (h_p - h)\n    Fm_lf_half = 0.5 * (Fm + Fm_p) - 0.5 * C_half * (m_p - m)\n\n    # Flux divergence (F_{i+1/2} - F_{i-1/2}) / dx\n    # F_{i-1/2} is obtained by rolling F_{i+1/2}\n    Fh_lf_half_m = np.roll(Fh_lf_half, 1)\n    Fm_lf_half_m = np.roll(Fm_lf_half, 1)\n\n    rhs_h = -(Fh_lf_half - Fh_lf_half_m) / dx\n    rhs_m = -(Fm_lf_half - Fm_lf_half_m) / dx\n    \n    return rhs_h, rhs_m\n\ndef run_simulation(N, CFL, T, H0, U0, a, b, g, apply_correction):\n    \"\"\"\n    Runs a single simulation for a given parameter set and correction flag.\n    \"\"\"\n    L = 1.0\n    dx = L / N\n    x = (np.arange(N) + 0.5) * dx\n    epsilon = 1e-15\n\n    # Initial conditions\n    h = H0 + a * np.cos(2 * np.pi * x / L)\n    u = U0 + b * np.sin(2 * np.pi * x / L)\n    m = h * u\n\n    def get_invariants(h_loc, m_loc):\n        mass = np.sum(h_loc) * dx\n        h_loc_safe = np.maximum(h_loc, 1e-12)\n        u_loc = m_loc / h_loc_safe\n        potential_energy = 0.5 * g * np.sum(h_loc**2) * dx\n        kinetic_energy = 0.5 * np.sum(h_loc * u_loc**2) * dx\n        total_energy = potential_energy + kinetic_energy\n        return mass, total_energy\n\n    M0, E0 = get_invariants(h, m)\n\n    t = 0.0\n    while t < T:\n        # Adaptive time step from CFL condition\n        h_safe = np.maximum(h, 1e-12)\n        u = m / h_safe\n        max_wave_speed = np.max(np.abs(u) + np.sqrt(g * h))\n        dt = CFL * dx / max_wave_speed\n        if t + dt > T:\n            dt = T - t\n\n        # SSP-RK2 time integration\n        # Stage 1\n        rhs_h1, rhs_m1 = compute_rhs(h, m, g, dx)\n        h1 = h + dt * rhs_h1\n        m1 = m + dt * rhs_m1\n        # Stage 2\n        rhs_h2, rhs_m2 = compute_rhs(h1, m1, g, dx)\n        h_new = 0.5 * h + 0.5 * (h1 + dt * rhs_h2)\n        m_new = 0.5 * m + 0.5 * (m1 + dt * rhs_m2)\n\n        h, m = h_new, m_new\n\n        if apply_correction:\n            # Mass correction\n            M_current = np.sum(h) * dx\n            delta = (M0 - M_current) / L\n            h += delta\n\n            # Energy correction\n            P_current = 0.5 * g * np.sum(h**2) * dx\n            # Use mass-corrected h for kinetic energy\n            h_safe = np.maximum(h, 1e-12)\n            K_current = 0.5 * np.sum(m**2 / h_safe) * dx\n            \n            # Calculate scaling factor alpha\n            alpha_sq_num = np.maximum(E0 - P_current, 0)\n            alpha_sq_den = np.maximum(K_current, epsilon)\n            alpha = np.sqrt(alpha_sq_num / alpha_sq_den)\n            \n            m *= alpha\n\n        t += dt\n\n    M_final, E_final = get_invariants(h, m)\n    delta_M = np.abs(M_final - M0)\n    delta_E = np.abs(E_final - E0)\n    \n    return delta_M, delta_E\n\nsolve()\n```"
        }
    ]
}