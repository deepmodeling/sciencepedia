{
    "hands_on_practices": [
        {
            "introduction": "This problem goes to the heart of what makes a numerical scheme \"conservative.\" You will start from the semi-discrete finite-volume formulation for a passive tracer and demonstrate, through a rigorous derivation, how the total amount of the tracer in a closed or periodic domain is conserved. This exercise  is fundamental for understanding how the structure of a finite-volume method, specifically the cancellation of fluxes at cell interfaces, guarantees the conservation of linear invariants at the discrete level.",
            "id": "4025760",
            "problem": "Consider a passive tracer field $\\phi(\\mathbf{x},t)$ advected by a velocity field $\\mathbf{u}(\\mathbf{x},t)$ in a spatially periodic domain $\\Omega \\subset \\mathbb{R}^{d}$ with periodic boundary $\\partial\\Omega$. The tracer satisfies the conservation law $\\frac{\\partial \\phi}{\\partial t} + \\nabla \\cdot (\\phi \\mathbf{u}) = S$, where $S(\\mathbf{x},t)$ is a prescribed source per unit volume, and the velocity field is divergence-free, $\\nabla \\cdot \\mathbf{u} = 0$. Assume $\\phi$ has the physical unit $\\mathrm{kg}\\,\\mathrm{m}^{-3}$ and $\\mathbf{u}$ has the unit $\\mathrm{m}\\,\\mathrm{s}^{-1}$ so that the integral $\\int_{\\Omega} \\phi\\, dV$ has the unit $\\mathrm{kg}$ and its time derivative has the unit $\\mathrm{kg}\\,\\mathrm{s}^{-1}$.\n\nDiscretize $\\Omega$ with a fixed tessellation into $N$ non-overlapping control volumes $\\{C_{i}\\}_{i=1}^{N}$ of volumes $V_{i}$ and planar faces $\\{f\\}$ of areas $A_{f}$. For each interior face $f$ shared by cells $i$ and $j$, fix a single outward unit normal $\\mathbf{n}_{f}$ pointing from $C_{i}$ to $C_{j}$. Let $\\phi_{i}(t)$ denote the cell-average of $\\phi$ over $C_{i}$, and let $\\Phi_{f}$ denote the numerical face flux that consistently approximates $(\\phi \\mathbf{u}) \\cdot \\mathbf{n}_{f} A_{f}$ with a scheme of formal order $2$, constructed by a single-face, conservative, linear reconstruction from the appropriate upwind side on each face. The finite-volume update for each $i$ is\n$$\n\\frac{d}{dt}\\big(\\phi_{i} V_{i}\\big) = - \\sum_{f \\subset \\partial C_{i}} s_{i,f}\\,\\Phi_{f} + S_{i} V_{i},\n$$\nwhere $s_{i,f} \\in \\{-1,+1\\}$ is the sign indicating whether the fixed face normal $\\mathbf{n}_{f}$ points out of ($+1$) or into ($-1$) cell $C_{i}$, and $S_{i}$ is the cell-average of $S$ in $C_{i}$. On periodic boundaries, faces are paired with oppositely oriented counterparts so that the same convention applies.\n\nStarting solely from the continuous conservation law, the divergence-free property, the periodicity, and the stated conservative finite-volume form (including the single-face flux construction and sign convention), derive the exact expression for the global rate of change of the domain-integrated tracer,\n$$\n\\frac{d}{dt}\\int_{\\Omega} \\phi\\, dV,\n$$\nthat is implied by the described second-order finite-volume advection scheme. Then, for the special case $S \\equiv 0$, compute the value of $\\frac{d}{dt}\\int_{\\Omega}\\phi\\, dV$. Express your final answer in $\\mathrm{kg}\\,\\mathrm{s}^{-1}$, rounded only if required; do not include any unit symbols in your final boxed answer. No hint formulas are provided; you must reason from the conservation law, the face-flux anti-symmetry in a conservative finite-volume method, and periodic boundary conditions to reach your conclusion.",
            "solution": "The problem asks for the rate of change of the total amount of a passive tracer $\\phi$ within a periodic domain $\\Omega$, as implied by a specific finite-volume numerical scheme.\n\nLet the total amount of the tracer in the domain, as represented by the discrete model, be $M(t)$. This is the sum of the tracer mass in each control volume $C_i$:\n$$\nM(t) = \\sum_{i=1}^{N} \\phi_i(t) V_i\n$$\nHere, $\\phi_i(t)$ is the cell-average concentration in cell $C_i$ of volume $V_i$, and $N$ is the total number of cells. The problem is asking for the derivation of an expression for $\\frac{dM}{dt}$ based on the provided numerical scheme.\n\nThe time evolution of the tracer amount in a single cell $C_i$ is given by the finite-volume update equation:\n$$\n\\frac{d}{dt}\\big(\\phi_{i} V_{i}\\big) = - \\sum_{f \\subset \\partial C_{i}} s_{i,f}\\,\\Phi_{f} + S_{i} V_{i}\n$$\nwhere $\\Phi_f$ is the numerical flux across a face $f$, $s_{i,f}$ is a sign factor, and $S_i$ is the cell-averaged source term.\n\nTo find the rate of change of the total tracer amount $M(t)$, we sum the individual rates of change over all $N$ control volumes in the domain:\n$$\n\\frac{dM}{dt} = \\frac{d}{dt}\\left(\\sum_{i=1}^{N} \\phi_i V_i\\right) = \\sum_{i=1}^{N} \\frac{d}{dt}(\\phi_i V_i)\n$$\nSubstituting the given finite-volume equation into this sum yields:\n$$\n\\frac{dM}{dt} = \\sum_{i=1}^{N} \\left( - \\sum_{f \\subset \\partial C_{i}} s_{i,f}\\,\\Phi_{f} + S_{i} V_{i} \\right)\n$$\nWe can separate the terms into a flux summation and a source summation:\n$$\n\\frac{dM}{dt} = - \\left( \\sum_{i=1}^{N} \\sum_{f \\subset \\partial C_{i}} s_{i,f}\\,\\Phi_{f} \\right) + \\left( \\sum_{i=1}^{N} S_{i} V_{i} \\right)\n$$\nLet us analyze the flux summation term, $\\mathcal{F} = \\sum_{i=1}^{N} \\sum_{f \\subset \\partial C_{i}} s_{i,f}\\,\\Phi_{f}$. This represents the sum of all fluxes over all faces of all cells. We can analyze the contribution of each face to this global sum.\n\nA key feature of a conservative finite-volume scheme is that the numerical flux $\\Phi_f$ is uniquely defined for each face $f$. The problem states the scheme uses a \"single-face, conservative\" construction, which guarantees this property.\n\nConsider an interior face $f$ that is shared between two adjacent control volumes, $C_i$ and $C_j$. The problem defines a fixed unit normal $\\mathbf{n}_f$ for this face, pointing from $C_i$ to $C_j$.\nAccording to the sign convention:\n- For cell $C_i$, the normal $\\mathbf{n}_f$ points outward, so $s_{i,f} = +1$. The contribution of this face from cell $C_i$ to the sum $\\mathcal{F}$ is $(+1)\\Phi_f$.\n- For cell $C_j$, the same normal $\\mathbf{n}_f$ points inward, so $s_{j,f} = -1$. The contribution of this face from cell $C_j$ to the sum $\\mathcal{F}$ is $(-1)\\Phi_f$.\n\nWhen we sum over all cells, the total contribution from this interior face $f$ is the sum of the contributions from $C_i$ and $C_j$, which is $(+1)\\Phi_f + (-1)\\Phi_f = 0$. Therefore, all fluxes across interior faces cancel out in pairs.\n\nNow, consider the faces on the boundary $\\partial\\Omega$ of the domain. The problem states that the domain is periodic. In a periodic domain, each boundary face on one side of the domain is identified with a corresponding boundary face on the opposite side. This pairing effectively makes the domain topologically closed, with no external boundaries. The pair of periodic boundary faces acts as a single logical interior interface. The \"single-face, conservative\" flux construction and the sign convention apply to these logical interfaces just as they do to geometric interior faces. Consequently, the flux contributions from these periodic boundary faces also cancel out in pairs when summed over the entire domain.\n\nSince all interior face fluxes cancel and all periodic boundary face fluxes cancel, the total flux summation is identically zero:\n$$\n\\mathcal{F} = \\sum_{i=1}^{N} \\sum_{f \\subset \\partial C_{i}} s_{i,f}\\,\\Phi_{f} = 0\n$$\nThis result is a fundamental property of conservative finite-volume schemes on closed or periodic domains. The details about the scheme being second-order or the velocity field being divergence-free, while important for other properties of the scheme, are not required to prove this global conservation property.\n\nSubstituting this result back into the expression for $\\frac{dM}{dt}$, we find:\n$$\n\\frac{dM}{dt} = - (0) + \\sum_{i=1}^{N} S_{i} V_{i}\n$$\nThus, the exact expression for the global rate of change of the domain-integrated tracer, as implied by the described finite-volume scheme, is:\n$$\n\\frac{d}{dt}\\left(\\sum_{i=1}^{N} \\phi_i V_i\\right) = \\sum_{i=1}^{N} S_{i} V_{i}\n$$\nThis demonstrates that the scheme correctly ensures that the total tracer amount changes only due to the integrated effect of the source term $S$.\n\nThe second part of the problem asks to compute this value for the special case where the source term $S$ is identically zero, i.e., $S(\\mathbf{x},t) \\equiv 0$. If the function $S$ is zero everywhere, then its average over any control volume $C_i$ must also be zero:\n$$\nS_{i} = \\frac{1}{V_i} \\int_{C_i} S(\\mathbf{x},t) dV = \\frac{1}{V_i} \\int_{C_i} 0 \\, dV = 0 \\quad \\text{for all } i=1, \\dots, N\n$$\nSubstituting $S_i = 0$ into our derived expression for the rate of change gives:\n$$\n\\frac{dM}{dt} = \\sum_{i=1}^{N} (0) V_{i} = 0\n$$\nThe value of the global rate of change of the domain-integrated tracer, in the absence of sources, is $0$. The units, as specified by the problem, would be $\\mathrm{kg}\\,\\mathrm{s}^{-1}$.",
            "answer": "$$\n\\boxed{0}\n$$"
        },
        {
            "introduction": "While total mass is a linear invariant, many crucial physical quantities, like energy and enstrophy, are quadratic. This exercise  explores the more stringent conditions required to conserve these higher-order invariants. By deriving the time evolution of discrete potential enstrophy in the shallow-water system, you will discover how specific choices in the numerical flux formulation are essential for preventing the unphysical generation or dissipation of these key diagnostic quantities.",
            "id": "4025775",
            "problem": "Consider the two-dimensional rotating shallow-water equations on a fixed horizontal domain partitioned into $N$ non-overlapping finite-volume cells indexed by $i=1,\\dots,N$, each with constant area $\\Delta A_i$. Let $\\zeta_i$ denote the discrete vertical relative vorticity averaged over cell $i$, $f_i$ the Coriolis parameter over cell $i$ (time independent), $h_i$ the layer thickness, and $q_i$ the discrete potential vorticity (PV) defined by $q_i=(\\zeta_i+f_i)/h_i$. Define the cellwise absolute vorticity $a_i \\equiv q_i h_i = \\zeta_i + f_i$. In the inviscid semidiscrete finite-volume setting, $a_i$ satisfies a conservative advection law derived from the inviscid shallow-water mass and vorticity equations: for each cell $i$,\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d}t}\\left(a_i\\,\\Delta A_i\\right) + \\sum_{e\\in\\partial i} \\mathcal{F}_{i,e} = 0,\n$$\nwhere $\\partial i$ is the set of cell edges bounding cell $i$, and the oriented edge flux is $\\mathcal{F}_{i,e} \\equiv a_e\\,U_{i,e}\\, \\ell_e$. Here $a_e$ is the edge value of $a$ obtained by a linear centered average of the two adjacent cell values, $U_{i,e}$ is the outward normal edge transport associated with cell $i$ (so that for an interior edge $e$ shared by cells $i$ and $j$, $U_{j,e}=-U_{i,e}$), and $\\ell_e$ is the edge length. Assume either periodic lateral boundaries or impermeable solid walls with $U_{i,e}=0$ on boundary edges.\n\nConstruct the discrete potential enstrophy\n$$\nZ_p \\equiv \\frac{1}{2}\\sum_{i=1}^{N} \\left(q_i h_i\\right)^{2}\\,\\Delta A_i = \\frac{1}{2}\\sum_{i=1}^{N} a_i^{2}\\,\\Delta A_i,\n$$\nand, starting solely from the conservative semidiscrete advection law for $a_i$ above, the definition of $Z_p$, the property that $a_e$ is a centered average of adjacent cell values, and the discrete divergence-free condition\n$$\n\\sum_{e\\in\\partial i} U_{i,e}\\,\\ell_e = 0 \\quad \\text{for all cells } i,\n$$\nderive an exact expression for $\\frac{\\mathrm{d}Z_p}{\\mathrm{d}t}$ in terms of sums over interior-edge exchanges. Identify the precise algebraic conditions on the flux construction and the normal transports that guarantee $\\frac{\\mathrm{d}Z_p}{\\mathrm{d}t}=0$ in the inviscid semidiscrete limit. State the final value of $\\frac{\\mathrm{d}Z_p}{\\mathrm{d}t}$ under those conditions as a single number. No rounding is required, and since the requested final value is a pure number under the stated conditions, you should report it without units.",
            "solution": "The problem asks for the derivation of the rate of change of discrete potential enstrophy, $\\frac{\\mathrm{d}Z_p}{\\mathrm{d}t}$, and to identify the conditions that ensure its conservation.\n\nThe discrete potential enstrophy is defined as:\n$$\nZ_p = \\frac{1}{2}\\sum_{i=1}^{N} a_i^{2}\\,\\Delta A_i\n$$\nwhere $a_i$ is the discrete absolute vorticity and $\\Delta A_i$ is the area of cell $i$. To find its rate of change, we differentiate with respect to time. Since the cell areas $\\Delta A_i$ are constant, we have:\n$$\n\\frac{\\mathrm{d}Z_p}{\\mathrm{d}t} = \\frac{\\mathrm{d}}{\\mathrm{d}t} \\left(\\frac{1}{2}\\sum_{i=1}^{N} a_i^{2}\\,\\Delta A_i\\right) = \\sum_{i=1}^{N} a_i \\frac{\\mathrm{d}a_i}{\\mathrm{d}t} \\Delta A_i = \\sum_{i=1}^{N} a_i \\frac{\\mathrm{d}(a_i \\Delta A_i)}{\\mathrm{d}t}\n$$\nWe substitute the given semidiscrete conservation law for absolute vorticity, $\\frac{\\mathrm{d}}{\\mathrm{d}t}(a_i \\Delta A_i) = -\\sum_{e\\in\\partial i} \\mathcal{F}_{i,e}$, where $\\mathcal{F}_{i,e} = a_e U_{i,e} \\ell_e$:\n$$\n\\frac{\\mathrm{d}Z_p}{\\mathrm{d}t} = \\sum_{i=1}^{N} a_i \\left(-\\sum_{e\\in\\partial i} a_e U_{i,e} \\ell_e\\right) = -\\sum_{i=1}^{N} \\sum_{e\\in\\partial i} a_i a_e U_{i,e} \\ell_e\n$$\nThis is a sum over all cells and their respective edges. We can rearrange this into a sum over all interior edges, denoted $\\mathcal{E}_{int}$, since the fluxes on boundary edges are zero (either by impermeable walls or periodic cancellation). Each interior edge $e$ is shared by exactly two cells, $i$ and $j$. The sum becomes:\n$$\n\\frac{\\mathrm{d}Z_p}{\\mathrm{d}t} = -\\sum_{e \\in \\mathcal{E}_{int}} \\left( a_i a_e U_{i,e} \\ell_e + a_j a_e U_{j,e} \\ell_e \\right)\n$$\nUsing the property that the outward normal transport is anti-symmetric, $U_{j,e} = -U_{i,e}$, we get:\n$$\n\\frac{\\mathrm{d}Z_p}{\\mathrm{d}t} = -\\sum_{e \\in \\mathcal{E}_{int}} a_e (a_i - a_j) U_{i,e} \\ell_e\n$$\nNow, we substitute the definition of the edge value $a_e$ as the centered average of the adjacent cell values, $a_e = \\frac{1}{2}(a_i + a_j)$:\n$$\n\\frac{\\mathrm{d}Z_p}{\\mathrm{d}t} = -\\sum_{e \\in \\mathcal{E}_{int}} \\frac{1}{2}(a_i + a_j)(a_i - a_j) U_{i,e} \\ell_e\n$$\nThis simplifies to:\n$$\n\\frac{\\mathrm{d}Z_p}{\\mathrm{d}t} = -\\frac{1}{2} \\sum_{e \\in \\mathcal{E}_{int}} (a_i^2 - a_j^2) U_{i,e} \\ell_e\n$$\nThis expression can be rearranged back into a sum over cells:\n$$\n\\frac{\\mathrm{d}Z_p}{\\mathrm{d}t} = -\\frac{1}{2} \\sum_{i=1}^N \\sum_{e \\in \\partial i} a_i^2 U_{i,e} \\ell_e = -\\frac{1}{2} \\sum_{i=1}^N a_i^2 \\left( \\sum_{e \\in \\partial i} U_{i,e} \\ell_e \\right)\n$$\nFor $\\frac{\\mathrm{d}Z_p}{\\mathrm{d}t}$ to be zero, the term in the parenthesis must be zero for each cell $i$. This is exactly the given discrete divergence-free condition:\n$$\n\\sum_{e\\in\\partial i} U_{i,e}\\,\\ell_e = 0 \\quad \\text{for all cells } i.\n$$\nThus, the specific choice of a centered average for the edge value $a_e$ combined with the discrete divergence-free condition on the transport field guarantees that $\\frac{\\mathrm{d}Z_p}{\\mathrm{d}t}=0$.\n\nUnder these conditions, the final value of the rate of change of potential enstrophy is 0.",
            "answer": "$$\\boxed{0}$$"
        },
        {
            "introduction": "Theoretical conservation is a necessary but not sufficient condition for a stable long-term simulation; numerical errors can still lead to a gradual drift in global invariants. This hands-on coding practice  challenges you to build a simple shallow-water model, observe the drift in mass and energy that arises from discretization and time-stepping errors, and implement a practical correction scheme. This task provides valuable insight into the methods used in operational climate and weather models to enforce physical constraints and ensure long-term simulation stability.",
            "id": "4025765",
            "problem": "You are tasked with designing and implementing a self-contained numerical experiment that quantifies and corrects the drift of global invariants in a nonlinear hyperbolic system representative of large-scale geophysical flow. Use the one-dimensional inviscid shallow-water equations on a periodic domain as the prototype system, which are a standard reduced model in numerical weather prediction and climate modeling for assessing conservation of global invariants. Throughout, work in nondimensional units; no physical units are required.\n\nBase the derivation on the following fundamental laws and core definitions:\n- The one-dimensional inviscid shallow-water equations on a periodic domain of length $L$ are given by\n  - Continuity: $\\partial_t h + \\partial_x (h u) = 0$,\n  - Momentum: $\\partial_t (h u) + \\partial_x \\left(h u^2 + \\tfrac{1}{2} g h^2\\right) = 0$,\n  where $h(x,t)$ is the layer depth, $u(x,t)$ is the velocity, and $g$ is the gravitational acceleration parameter.\n- The global mass $M(t)$ and total energy $E(t)$ are\n  $$M(t) = \\int_{0}^{L} h(x,t)\\,dx,$$\n  $$E(t) = \\int_{0}^{L} \\left(\\tfrac{1}{2} g h(x,t)^2 + \\tfrac{1}{2} h(x,t) u(x,t)^2\\right)\\,dx.$$\n  On a periodic domain, the continuous equations imply $\\frac{dM}{dt} = 0$ and $\\frac{dE}{dt} = 0$.\n- An adaptive time stepping is determined by a Courant-Friedrichs-Lewy (CFL) condition, where the time step $\\Delta t$ at each step satisfies\n  $$\\Delta t = \\mathrm{CFL}\\, \\frac{\\Delta x}{\\max_i\\left(|u_i| + \\sqrt{g h_i}\\right)},$$\n  with $\\Delta x = L/N$ for $N$ uniform cells.\n\nYour tasks are:\n1) Discretize the system on a uniform periodic grid using any conservative method that computes the divergence of fluxes in a form that exactly conserves the discretized mass in the absence of sources and sinks, and integrate in time with an explicit method and adaptive time stepping based on the CFL condition. The discrete variables are the cell averages $h_i(t)$ and $m_i(t) = h_i(t) u_i(t)$.\n2) Using this discretization, simulate the system over a finite time interval $[0,T]$ with adaptive time stepping and quantify the cumulative drift of the global invariants, defined as the final absolute deviations\n   $$\\Delta M = |M(T) - M(0)|,\\quad \\Delta E = |E(T) - E(0)|.$$\n3) Propose and implement a global correction strategy that enforces at each full time step both the mass and the energy constraints in the discrete sense. Your correction must be limited to spatially uniform transformations that do not alter the discrete flux form of the update, specifically:\n   - Mass correction: shift the layer depth by a constant offset $\\delta$ so that the corrected discrete mass equals the initial mass, i.e., set $h_i \\leftarrow h_i + \\delta$ where $\\delta$ is chosen such that $\\sum_i h_i \\Delta x = M(0)$.\n   - Energy correction: rescale the velocity field uniformly by a factor $\\alpha$ (equivalently rescale the momentum $m_i = h_i u_i$ by $\\alpha$ while keeping $h_i$ unchanged) so that after mass correction the total energy equals its initial value. If the kinetic energy is zero or the desired kinetic energy implied by the fixed total energy and current potential energy is nonpositive, leave the velocity unchanged. Formally, with $P = \\tfrac{1}{2} g \\sum_i h_i^2 \\Delta x$ and $K = \\tfrac{1}{2} \\sum_i h_i u_i^2 \\Delta x$, choose $\\alpha = \\sqrt{\\max(E(0) - P, 0)/\\max(K, \\epsilon)}$ for a small numerical tolerance $\\epsilon$, and rescale $u_i \\leftarrow \\alpha u_i$ (equivalently $m_i \\leftarrow \\alpha m_i$).\n4) Evaluate the cumulative drifts $\\Delta M$ and $\\Delta E$ for two scenarios on identical configurations: (a) without correction and (b) with the mass-and-energy correction applied after each full time step. Report four quantities per configuration: the final absolute mass drift without correction, the final absolute energy drift without correction, the final absolute mass drift with correction, and the final absolute energy drift with correction.\n\nInitial and boundary-value setup:\n- Domain: $x \\in [0,L)$ with periodic boundary conditions and $L = 1$.\n- Grid: $N$ uniform cells, $\\Delta x = L/N$.\n- Initial condition: \n  $$h(x,0) = H_0 + a \\cos(2\\pi x),\\quad u(x,0) = U_0 + b \\sin(2\\pi x).$$\n- Parameters: $H_0 > 0$, small amplitudes $a$ and $b$, gravitational acceleration parameter $g > 0$, and final time $T > 0$.\n- Time integration: explicit, adaptive step size from the CFL condition above with the supplied $\\mathrm{CFL}$ number. Angles, if any appear in trigonometric functions, are to be interpreted in radians.\n\nTest suite:\nImplement and run your program on the following parameter sets, each specified as a tuple $(N, \\mathrm{CFL}, T, H_0, U_0, a, b, g)$:\n- Case 1 (general): $(128, 0.50, 1.0, 1.0, 0.0, 0.05, 0.10, 1.0)$.\n- Case 2 (near-CFL boundary): $(64, 0.90, 2.0, 1.0, 0.10, 0.02, 0.02, 1.0)$.\n- Case 3 (degenerate kinetic energy start): $(256, 0.30, 1.0, 1.0, 0.0, 0.05, 0.0, 1.0)$.\n\nProgram output specification:\n- For each test case, compute the four floats\n  - $\\Delta M$ without correction,\n  - $\\Delta E$ without correction,\n  - $\\Delta M$ with correction,\n  - $\\Delta E$ with correction.\n- Aggregate the results from all test cases into a single line of output containing a comma-separated list of $12$ floats enclosed in square brackets (for example, \"[r1,r2,...,r12]\"). Use decimal numbers. Do not print any other text.\n\nYour program must be a single, self-contained, runnable script that performs all computations and prints the results in the exact specified format. No user input or external files are permitted. The solution should be general and correct for the entire test suite as stated above.",
            "solution": "The problem requires the design and implementation of a numerical experiment to study the conservation of global invariants in a numerical model of the one-dimensional inviscid shallow-water equations. The tasks involve discretizing the system, simulating its evolution with and without a proposed correction scheme, and quantifying the drift in the global mass and total energy. The problem is well-posed, scientifically grounded, and provides all necessary parameters for a unique numerical solution.\n\nThe governing equations are the one-dimensional inviscid shallow-water equations, which express the conservation of mass and momentum. In vector form, these are given by a system of hyperbolic conservation laws:\n$$\n\\frac{\\partial \\mathbf{U}}{\\partial t} + \\frac{\\partial \\mathbf{F}(\\mathbf{U})}{\\partial x} = \\mathbf{0}\n$$\nwhere $\\mathbf{U}(x,t)$ is the state vector of conserved quantities and $\\mathbf{F}(\\mathbf{U})$ is the flux vector. For this system, the state and flux vectors are:\n$$\n\\mathbf{U} = \\begin{pmatrix} h \\\\ hu \\end{pmatrix} = \\begin{pmatrix} h \\\\ m \\end{pmatrix}, \\quad \\mathbf{F}(\\mathbf{U}) = \\begin{pmatrix} hu \\\\ hu^2 + \\frac{1}{2}gh^2 \\end{pmatrix} = \\begin{pmatrix} m \\\\ \\frac{m^2}{h} + \\frac{1}{2}gh^2 \\end{pmatrix}\n$$\nHere, $h(x,t)$ is the fluid depth, $u(x,t)$ is the fluid velocity, $m(x,t) = h(x,t)u(x,t)$ is the momentum density, and $g$ is the gravitational acceleration parameter. The problem is set on a periodic domain $x \\in [0, L)$.\n\nA conservative numerical method is required. We employ a finite volume method, which is conservative by construction. The domain $[0, L)$ is discretized into $N$ uniform cells $I_i = [x_{i-1/2}, x_{i+1/2}]$ of width $\\Delta x = L/N$. The discrete state variables $\\mathbf{U}_i(t)$ represent the cell averages of the conserved quantities. The semi-discrete form of the equations is:\n$$\n\\frac{d\\mathbf{U}_i}{dt} = -\\frac{1}{\\Delta x} \\left( \\mathbf{F}_{i+1/2} - \\mathbf{F}_{i-1/2} \\right)\n$$\nwhere $\\mathbf{F}_{i \\pm 1/2}$ are the numerical fluxes at the cell interfaces. Summing over all cells $i=0, \\dots, N-1$ with periodic boundaries results in a telescoping sum that cancels to zero, ensuring that the total mass $\\sum_i h_i \\Delta x$ is conserved up to machine precision.\n\nFor the numerical flux, we select the simple and robust Lax-Friedrichs flux. It is defined at the interface $x_{i+1/2}$ between cells $i$ and $i+1$ as:\n$$\n\\mathbf{F}_{i+1/2} = \\frac{1}{2} \\left[ \\mathbf{F}(\\mathbf{U}_i) + \\mathbf{F}(\\mathbf{U}_{i+1}) \\right] - \\frac{1}{2} C_{i+1/2} \\left( \\mathbf{U}_{i+1} - \\mathbf{U}_i \\right)\n$$\nThe dissipation coefficient $C_{i+1/2}$ must be at least the maximum local characteristic speed, ensuring numerical stability. The characteristic speeds (eigenvalues of the flux Jacobian) for the shallow-water system are $u \\pm \\sqrt{gh}$. Thus, a stable choice is:\n$$\nC_{i+1/2} = \\max\\left(|u_i| + \\sqrt{gh_i}, |u_{i+1}| + \\sqrt{gh_{i+1}}\\right)\n$$\n\nFor time integration, an explicit second-order Strong Stability Preserving Runge-Kutta method (SSP-RK2), also known as Heun's method, is used. Given the semi-discrete form $\\frac{d\\mathbf{U}}{dt} = \\mathcal{L}(\\mathbf{U})$, the update from time step $n$ to $n+1$ is performed in two stages:\n1. Intermediate step: $\\mathbf{U}^* = \\mathbf{U}^n + \\Delta t \\, \\mathcal{L}(\\mathbf{U}^n)$\n2. Final step: $\\mathbf{U}^{n+1} = \\frac{1}{2}\\mathbf{U}^n + \\frac{1}{2}\\left( \\mathbf{U}^* + \\Delta t \\, \\mathcal{L}(\\mathbf{U}^*) \\right)$\n\nThe time step $\\Delta t$ is adapted at each iteration based on the Courant-Friedrichs-Lewy (CFL) condition to maintain stability:\n$$\n\\Delta t = \\mathrm{CFL} \\frac{\\Delta x}{\\max_{i}\\left(|u_i| + \\sqrt{g h_i}\\right)}\n$$\nwhere $\\mathrm{CFL}$ is a chosen number less than or equal to $1$ for this scheme.\n\nThe discrete global invariants, mass $M$ and total energy $E$, are calculated by summing over all cells:\n$$\nM(t) = \\sum_{i=0}^{N-1} h_i(t) \\Delta x, \\quad E(t) = \\sum_{i=0}^{N-1} \\left( \\frac{1}{2} g h_i(t)^2 + \\frac{1}{2} h_i(t) u_i(t)^2 \\right) \\Delta x = \\sum_{i=0}^{N-1} \\left( \\frac{1}{2} g h_i(t)^2 + \\frac{1}{2} \\frac{m_i(t)^2}{h_i(t)} \\right) \\Delta x\n$$\nThe simulation is performed for two scenarios. The first scenario proceeds without any modification, and numerical drift is measured. The second scenario applies a correction scheme after each full time step to enforce conservation of initial mass $M_0$ and initial energy $E_0$.\n\nThe correction scheme consists of two steps:\n1.  **Mass Correction**: The fluid depth $h_i$ in each cell is adjusted by a uniform offset $\\delta$. Let $h'_i$ be the depth after a time step. The current mass is $M' = \\sum_i h'_i \\Delta x$. We enforce $\\sum_i (h'_i + \\delta) \\Delta x = M_0$. This gives $M' + \\delta (N \\Delta x) = M_0$, so $\\delta = (M_0 - M')/L$. The corrected depth is $h''_i = h'_i + \\delta$.\n\n2.  **Energy Correction**: After mass correction, the velocity field is rescaled by a uniform factor $\\alpha$ to restore the total energy to its initial value $E_0$. Let $h''_i$ be the mass-corrected depth and $m'_i$ be the momentum from the time step. The potential energy is $P'' = \\frac{1}{2}g \\sum_i (h''_i)^2 \\Delta x$. The kinetic energy, before scaling, is $K'' = \\frac{1}{2}\\sum_i (m'_i)^2/h''_i \\Delta x$. The new kinetic energy after scaling the momentum by $\\alpha$ ($m''_i = \\alpha m'_i$) will be $\\alpha^2 K''$. We require $P'' + \\alpha^2 K'' = E_0$. This leads to the scaling factor specified in the problem:\n$$\n\\alpha = \\sqrt{\\frac{\\max(E_0 - P'', 0)}{\\max(K'', \\epsilon)}}\n$$\nwhere $\\epsilon$ is a small tolerance to prevent division by zero. This formula correctly handles cases where the target kinetic energy $E_0 - P''$ is non-positive by setting $\\alpha=0$, thereby zeroing out the kinetic energy. If the initial kinetic energy is zero, $K''$ will be near zero and the formula handles this case as well.\n\nThe algorithm is implemented for each test case by running two simulations: one with `apply_correction=False` and one with `apply_correction=True`. The final absolute drifts $\\Delta M = |M(T) - M_0|$ and $\\Delta E = |E(T) - E_0|$ are computed and reported for both scenarios. The initial conditions are discretized by evaluating the given functions at the cell centers $x_i = (i+0.5)\\Delta x$.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the shallow-water equation problem for the given test cases.\n    \"\"\"\n    test_cases = [\n        (128, 0.50, 1.0, 1.0, 0.0, 0.05, 0.10, 1.0),\n        (64, 0.90, 2.0, 1.0, 0.10, 0.02, 0.02, 1.0),\n        (256, 0.30, 1.0, 1.0, 0.0, 0.05, 0.0, 1.0),\n    ]\n\n    results = []\n    for params in test_cases:\n        N, CFL, T, H0, U0, a, b, g = params\n        \n        # Run simulation without correction\n        delta_M_uncorr, delta_E_uncorr = run_simulation(N, CFL, T, H0, U0, a, b, g, apply_correction=False)\n        \n        # Run simulation with correction\n        delta_M_corr, delta_E_corr = run_simulation(N, CFL, T, H0, U0, a, b, g, apply_correction=True)\n        \n        results.extend([delta_M_uncorr, delta_E_uncorr, delta_M_corr, delta_E_corr])\n\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef compute_rhs(h, m, g, dx):\n    \"\"\"\n    Computes the right-hand side of the semi-discrete finite volume scheme\n    using the Lax-Friedrichs flux.\n    \"\"\"\n    # Guard against division by zero for h, though it shouldn't be an issue\n    # with the given initial conditions.\n    h_safe = np.maximum(h, 1e-12)\n    u = m / h_safe\n\n    # Flux vectors F(U)\n    Fh = m\n    Fm = m**2 / h_safe + 0.5 * g * h**2\n\n    # Lax-Friedrichs dissipation term\n    c_char = np.abs(u) + np.sqrt(g * h)\n    c_char_p = np.roll(c_char, -1)\n    C_half = np.maximum(c_char, c_char_p)\n\n    # Shifted states for computing flux at i+1/2\n    h_p = np.roll(h, -1)\n    m_p = np.roll(m, -1)\n    Fh_p = np.roll(Fh, -1)\n    Fm_p = np.roll(Fm, -1)\n    \n    # Lax-Friedrichs fluxes at interface i+1/2\n    Fh_lf_half = 0.5 * (Fh + Fh_p) - 0.5 * C_half * (h_p - h)\n    Fm_lf_half = 0.5 * (Fm + Fm_p) - 0.5 * C_half * (m_p - m)\n\n    # Flux divergence (F_{i+1/2} - F_{i-1/2}) / dx\n    # F_{i-1/2} is obtained by rolling F_{i+1/2}\n    Fh_lf_half_m = np.roll(Fh_lf_half, 1)\n    Fm_lf_half_m = np.roll(Fm_lf_half, 1)\n\n    rhs_h = -(Fh_lf_half - Fh_lf_half_m) / dx\n    rhs_m = -(Fm_lf_half - Fm_lf_half_m) / dx\n    \n    return rhs_h, rhs_m\n\ndef run_simulation(N, CFL, T, H0, U0, a, b, g, apply_correction):\n    \"\"\"\n    Runs a single simulation for a given parameter set and correction flag.\n    \"\"\"\n    L = 1.0\n    dx = L / N\n    x = (np.arange(N) + 0.5) * dx\n    epsilon = 1e-15\n\n    # Initial conditions\n    h = H0 + a * np.cos(2 * np.pi * x / L)\n    u = U0 + b * np.sin(2 * np.pi * x / L)\n    m = h * u\n\n    def get_invariants(h_loc, m_loc):\n        mass = np.sum(h_loc) * dx\n        h_loc_safe = np.maximum(h_loc, 1e-12)\n        u_loc = m_loc / h_loc_safe\n        potential_energy = 0.5 * g * np.sum(h_loc**2) * dx\n        kinetic_energy = 0.5 * np.sum(h_loc * u_loc**2) * dx\n        total_energy = potential_energy + kinetic_energy\n        return mass, total_energy\n\n    M0, E0 = get_invariants(h, m)\n\n    t = 0.0\n    while t  T:\n        # Adaptive time step from CFL condition\n        h_safe = np.maximum(h, 1e-12)\n        u = m / h_safe\n        max_wave_speed = np.max(np.abs(u) + np.sqrt(g * h))\n        dt = CFL * dx / max_wave_speed\n        if t + dt > T:\n            dt = T - t\n\n        # SSP-RK2 time integration\n        # Stage 1\n        rhs_h1, rhs_m1 = compute_rhs(h, m, g, dx)\n        h1 = h + dt * rhs_h1\n        m1 = m + dt * rhs_m1\n        # Stage 2\n        rhs_h2, rhs_m2 = compute_rhs(h1, m1, g, dx)\n        h_new = 0.5 * h + 0.5 * (h1 + dt * rhs_h2)\n        m_new = 0.5 * m + 0.5 * (m1 + dt * rhs_m2)\n\n        h, m = h_new, m_new\n\n        if apply_correction:\n            # Mass correction\n            M_current = np.sum(h) * dx\n            delta = (M0 - M_current) / L\n            h += delta\n\n            # Energy correction\n            P_current = 0.5 * g * np.sum(h**2) * dx\n            # Use mass-corrected h for kinetic energy\n            h_safe = np.maximum(h, 1e-12)\n            K_current = 0.5 * np.sum(m**2 / h_safe) * dx\n            \n            # Calculate scaling factor alpha\n            alpha_sq_num = np.maximum(E0 - P_current, 0)\n            alpha_sq_den = np.maximum(K_current, epsilon)\n            alpha = np.sqrt(alpha_sq_num / alpha_sq_den)\n            \n            m *= alpha\n\n        t += dt\n\n    M_final, E_final = get_invariants(h, m)\n    delta_M = np.abs(M_final - M0)\n    delta_E = np.abs(E_final - E0)\n    \n    return delta_M, delta_E\n\nsolve()\n```"
        }
    ]
}