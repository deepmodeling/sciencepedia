{
    "hands_on_practices": [
        {
            "introduction": "本练习回归到基本原理。我们将探讨常数 $\\epsilon$ 的来源，这个常数对于理解为何湿空气比干空气密度小至关重要。通过从干空气和水汽的分子量出发进行推导，学生将巩固对理想气体定律在空气混合物中应用的理解。",
            "id": "4110073",
            "problem": "在数值天气预报和气候模拟中，用于表示湿空气浮力的虚温涉及一个比较干空气和水汽热力学行为的无量綱常数。令 $\\epsilon$ 表示此常数。从每种组分的理想气体定律出发，结合比气体常数根据普适气体常数及其分子量的定义，推导出一个仅用干空气和水汽的分子量表示的 $\\epsilon$ 表达式。\n\n然后，使用普适气体常数 $R_{u} = 8.314\\,462\\,618$ J mol$^{-1}$ K$^{-1}$，干空气的标准平均分子量 $M_{d} = 28.9647 \\times 10^{-3}$ kg mol$^{-1}$，以及水汽的分子量 $M_{v} = 18.01528 \\times 10^{-3}$ kg mol$^{-1}$，计算 $\\epsilon$ 的数值。将你的答案四舍五入到三位有效数字。将最终结果表示为一个无量綱数（无单位）。",
            "solution": "该问题被认为是有效的，因为它科学地基于大气热力学的原理，是一个具有唯一且稳定解的适定问题，并且使用客观、精确的语言陈述。推导和计算所需的所有数据均已提供。\n\n该问题要求推导一个无量綱常数 $\\epsilon$，它在大气科学中用于虚温的计算。推导必须从基本原理开始，即理想气体定律和比气体常数的定义。\n\n对于特定气体，理想气体定律可以写成：\n$$p = \\rho R T$$\n其中 $p$ 是压力，$\\rho$ 是密度，$T$ 是绝对温度，$R$ 是该特定气体的比气体常数。\n\n比气体常数 $R$ 与普适气体常数 $R_u$ 以及气体的摩尔质量（或分子量）$M$ 通过以下方程相关联：\n$$R = \\frac{R_u}{M}$$\n\n我们将这些原理应用于问题中提到的湿空气的两个组分：干空气和水汽。\n\n对于干空气，其比气体常数 $R_d$ 由下式给出：\n$$R_d = \\frac{R_u}{M_d}$$\n其中 $M_d$ 是干空气的平均分子量。\n\n对于水汽，其比气体常数 $R_v$ 由下式给出：\n$$R_v = \\frac{R_u}{M_v}$$\n其中 $M_v$ 是水汽的分子量。\n\n在大气科学中，无量綱常数 $\\epsilon$ 定义为干空氣和水汽的比气体常数之比。这个比率是出现在虚温公式中的一个基本参数，它量化了湿空气和干空气之间的浮力差异。标准定义是：\n$$\\epsilon \\equiv \\frac{R_d}{R_v}$$\n\n为了推导一个仅用分子量表示的 $\\epsilon$ 表达式，我们将 $R_d$ 和 $R_v$ 的表达式代入此定义：\n$$\\epsilon = \\frac{\\left(\\frac{R_u}{M_d}\\right)}{\\left(\\frac{R_u}{M_v}\\right)}$$\n\n普适气体常数 $R_u$ 是一个常数，同时出现在分子和分母中，因此可以消去：\n$$\\epsilon = \\frac{R_u}{M_d} \\times \\frac{M_v}{R_u} = \\frac{M_v}{M_d}$$\n\n这就是所求的用干空气分子量（$M_d$）和水汽分子量（$M_v$）表示的 $\\epsilon$ 表达式。\n\n接下来，我们被要求使用所提供的数据计算 $\\epsilon$ 的数值。\n给定的值为：\n干空气的分子量，$M_d = 28.9647 \\times 10^{-3}$ kg mol$^{-1}$。\n水汽的分子量，$M_v = 18.01528 \\times 10^{-3}$ kg mol$^{-1}$。\n如推导所示，普适气体常数的值，$R_u = 8.314\\,462\\,618$ J mol$^{-1}$ K$^{-1}$，在最终计算中是不需要的。\n\n将分子量代入我们推导出的 $\\epsilon$ 表达式中：\n$$\\epsilon = \\frac{M_v}{M_d} = \\frac{18.01528 \\times 10^{-3}}{28.9647 \\times 10^{-3}}$$\n\n$10^{-3}$ 的因子被消去，计算简化为数值部分的比率：\n$$\\epsilon = \\frac{18.01528}{28.9647}$$\n\n进行除法运算得到：\n$$\\epsilon \\approx 0.6219803$$\n\n问题要求答案四舍五入到三位有效数字。前三位有效数字是 6、2 和 1。第四位有效数字是 9，大于或等于 5，所以我们将第三位数字向上进位。\n$$\\epsilon \\approx 0.622$$\n这个最终值是无量綱的，因为它是两个具有相同单位（分子量）的量的比率。",
            "answer": "$$ \\boxed{0.622} $$"
        },
        {
            "introduction": "在掌握了湿空气的基本属性之后，本练习将虚温、位温和虚位温等概念应用于一个真实的大气场景。计算这些温度值并解释它们在浮力方面的物理意义，是分析大气稳定性和运动的一项核心技能。",
            "id": "4039109",
            "problem": "一个与数值天气预报和气候模拟相关的均匀湿空气块，其特征为压强 $p=900\\,\\mathrm{hPa}$、热力学温度 $T=295\\,\\mathrm{K}$、水汽比湿 $q_{v}=0.015$（单位湿空气质量中的水汽质量）以及液态水比湿 $q_{l}=0$。从每种成分的理想气体定律、混合物密度组成关系以及理想气体的可逆绝热热力学出发，推导计算该空气块的虚温 $T_{v}$、（干）位温 $\\theta$ 和虚位温 $\\theta_{v}$ 所需的表达式。然后对这三个温度进行数值计算。\n\n假设干空气气体常数 $R_{d}=287.05\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$、水汽气体常数 $R_{v}=461.5\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$、干空气定压比热 $c_{pd}=1004.67\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$ 以及参考压强 $p_{0}=1000\\,\\mathrm{hPa}$。由于 $q_{l}=0$，忽略凝结水的体积贡献。将每个计算出的温度四舍五入至四位有效数字，并以 $\\mathrm{K}$ 为单位表示。\n\n最后，根据你的结果，解释其在浮力方面的影响，即比较在相同 $p$ 和 $T$ 条件下，该湿空气块的 $T_{v}$ 和 $\\theta_{v}$ 与一个除湿度外其他条件均相同的干空气块的 $T$ 和 $\\theta$ 有何不同。\n\n提供三个数值 $T_{v}$、$\\theta$ 和 $\\theta_{v}$ 作为你的最终答案。",
            "solution": "问题陈述已经过验证，被认为是可靠、完整且表述清晰的。它提出了一个大气热力学中的标准问题，具有物理上现实的参数和明确的目标。我们可以开始解题。\n\n任务是为一个湿空气块推导并计算三个量：虚温 $T_v$、位温 $\\theta$ 和虚位温 $\\theta_v$。我们还被要求解释其在浮力方面的影响。\n\n给定的参数是：\n- 压强：$p=900\\,\\mathrm{hPa} = 9 \\times 10^{4}\\,\\mathrm{Pa}$\n- 温度：$T=295\\,\\mathrm{K}$\n- 水汽比湿：$q_{v}=0.015$\n- 液态水比湿：$q_{l}=0$\n- 干空气气体常数：$R_{d}=287.05\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$\n- 水汽气体常数：$R_{v}=461.5\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$\n- 干空气定压比热：$c_{pd}=1004.67\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$\n- 参考压强：$p_{0}=1000\\,\\mathrm{hPa} = 1 \\times 10^{5}\\,\\mathrm{Pa}$\n\n首先，我们推导虚温 $T_v$ 的表达式。虚温是指一个假想的干空气块在与湿空气块具有相同压强时，若要使其密度与湿空气块相同所需具有的温度。\n湿空气的状态方程可以写为 $p = \\rho R_m T$，其中 $\\rho$ 是总密度，$R_m$ 是湿空气混合物的比气体常数。虚温 $T_v$ 的定义允许我们对湿空气混合物使用干空气气体常数 $R_d$：$p = \\rho R_d T_v$。\n令这两个表达式相等，得到 $\\rho R_m T = \\rho R_d T_v$，化简后为 $T_v = T \\frac{R_m}{R_d}$。\n\n混合物的比气体常数 $R_m$ 是干空气 ($R_d$) 和水汽 ($R_v$) 的比气体常数的质量加权平均值。干空气的质量分数为 $(1-q_v)$，水汽的质量分数为 $q_v$。因此，\n$$R_m = (1-q_v)R_d + q_v R_v$$\n将此代入 $T_v$ 的表达式中：\n$$T_v = T \\frac{(1-q_v)R_d + q_v R_v}{R_d} = T \\left(1-q_v + q_v \\frac{R_v}{R_d}\\right)$$\n这可以重写为：\n$$T_v = T \\left[1 + q_v\\left(\\frac{R_v}{R_d} - 1\\right)\\right]$$\n这就是所求的虚温表达式。\n\n接下来，我们推导位温 $\\theta$ 的表达式。位温定义为一个空气块从其初始状态 $(T, p)$ 经过绝热可逆过程到达标准参考压强 $p_0$ 时所具有的温度。问题中指定了“（干）位温”，这意味着我们在计算中要使用干空气的常数。\n对于理想气体的可逆绝热过程，热力学第一定律 $c_p dT - \\alpha dp = 0$（其中 $\\alpha=1/\\rho$ 是比容）可以与理想气体定律 $p\\alpha = RT$ 结合，得到 Poisson 方程。\n对于干空气，我们有 $c_{pd}dT = \\frac{R_d T}{p}dp$。整理并从 $(T, p)$ 积分到 $(\\theta, p_0)$：\n$$\\int_{T}^{\\theta} c_{pd} \\frac{dT'}{T'} = \\int_{p}^{p_0} R_d \\frac{dp'}{p'}$$\n$$c_{pd} \\ln\\left(\\frac{\\theta}{T}\\right) = R_d \\ln\\left(\\frac{p_0}{p}\\right)$$\n$$\\ln\\left(\\frac{\\theta}{T}\\right) = \\frac{R_d}{c_{pd}} \\ln\\left(\\frac{p_0}{p}\\right) = \\ln\\left[\\left(\\frac{p_0}{p}\\right)^{R_d/c_{pd}}\\right]$$\n对两边取指数，得到位温的表达式：\n$$\\theta = T \\left(\\frac{p_0}{p}\\right)^{\\kappa}$$\n其中指数 $\\kappa = R_d/c_{pd}$。\n\n最后，我们考虑虚位温 $\\theta_v$。对于一个未饱和的空气块，这个量最方便的定义是使用虚温 $T_v$ 而非热力学温度 $T$ 计算出的位温。这个定义很有用，因为对于一个比湿恒定的空气块，在干绝热过程中 $\\theta_v$ 是守恒的。\n使用 $\\theta$ 的定义并将 $T$ 替换为 $T_v$：\n$$\\theta_v = T_v \\left(\\frac{p_0}{p}\\right)^{\\kappa}$$\n我们也可以通过代入 $T_v$ 的表达式将其与 $\\theta$ 直接关联起来：\n$$\\theta_v = T \\left[1 + q_v\\left(\\frac{R_v}{R_d} - 1\\right)\\right] \\left(\\frac{p_0}{p}\\right)^{\\kappa} = \\theta \\left[1 + q_v\\left(\\frac{R_v}{R_d} - 1\\right)\\right]$$\n\n现在我们进行数值计算。\n首先，我们计算必要的参数比率：\n气体常数之比：$\\frac{R_v}{R_d} = \\frac{461.5}{287.05} \\approx 1.60773$\n虚温修正项：$\\frac{R_v}{R_d} - 1 \\approx 0.60773$\n位温的指数：$\\kappa = \\frac{R_d}{c_{pd}} = \\frac{287.05}{1004.67} \\approx 0.28574$\n压强比：$\\frac{p_0}{p} = \\frac{1000}{900} = \\frac{10}{9}$\n\n1.  计算虚温 $T_v$：\n    $$T_v = 295\\,\\mathrm{K} \\times \\left[1 + 0.015 \\times \\left(\\frac{461.5}{287.05} - 1\\right)\\right]$$\n    $$T_v = 295 \\times [1 + 0.015 \\times 0.60773...] = 295 \\times [1.009116...] = 297.6892... \\,\\mathrm{K}$$\n    四舍五入至四位有效数字， $T_v = 297.7\\,\\mathrm{K}$。\n\n2.  计算位温 $\\theta$：\n    $$\\theta = 295\\,\\mathrm{K} \\times \\left(\\frac{1000}{900}\\right)^{287.05/1004.67}$$\n    $$\\theta = 295 \\times \\left(\\frac{10}{9}\\right)^{0.28574...} = 295 \\times 1.030568... = 304.0175... \\,\\mathrm{K}$$\n    四舍五入至四位有效数字， $\\theta = 304.0\\,\\mathrm{K}$。\n\n3.  计算虚位温 $\\theta_v$：\n    $$\\theta_v = T_v \\left(\\frac{p_0}{p}\\right)^{\\kappa} = 297.6892... \\,\\mathrm{K} \\times \\left(\\frac{10}{9}\\right)^{0.28574...}$$\n    $$\\theta_v = 297.6892... \\times 1.030568... = 306.7909... \\,\\mathrm{K}$$\n    四舍五入至四位有效数字， $\\theta_v = 306.8\\,\\mathrm{K}$。\n\n浮力影响的解释：\n我们将给定的湿空气块与一个在相同压强 $p=900\\,\\mathrm{hPa}$ 和温度 $T=295\\,\\mathrm{K}$ 下、除湿度外其他条件均相同的干空气块进行比较。\n对于湿空气块，我们计算出 $T_v = 297.7\\,\\mathrm{K}$。对于干空气块，$q_v=0$，所以其虚温就是其热力学温度，$T_{v,\\mathrm{dry}} = T = 295\\,\\mathrm{K}$。\n根据用虚温表示的理想气体定律 $p = \\rho R_d T_v$，在恒定压强下，密度 $\\rho$ 与 $T_v$ 成反比。由于 $T_v > T_{v,\\mathrm{dry}}$，湿空气块的密度低于干空气块 ($\\rho  \\rho_{\\mathrm{dry}}$)。这意味着在相同的 $p$ 和 $T$ 条件下，湿空气块比干空气块更具浮力。其物理原因是水汽分子（$M_w \\approx 18.015\\,\\mathrm{g\\,mol^{-1}}$）比干空气中的平均分子（$M_d \\approx 28.97\\,\\mathrm{g\\,mol^{-1}}$）更轻。\n虚位温 $\\theta_v$ 是一个在未饱和空气块绝热垂直运动中守恒的量，并且是在比较不同气压层上的空气块时衡量浮力的决定性指标。对于湿空气块，我们计算出 $\\theta_v = 306.8\\,\\mathrm{K}$。对于等效的干空气块，其虚位温等于其位温，即 $\\theta_{v,\\mathrm{dry}} = \\theta = 304.0\\,\\mathrm{K}$。\n由于 $\\theta_v > \\theta_{v,\\mathrm{dry}}$，湿空气块具有更高的浮力潜能。如果湿空气块和干空气块都绝热地移动到任何其他气压层，湿空气块将始终比干空气块更暖、密度更小，因此相对于其周围环境会受到更大的向上浮力（或更小的向下作用力）。",
            "answer": "$$\\boxed{\\begin{pmatrix} 297.7  304.0  306.8 \\end{pmatrix}}$$"
        },
        {
            "introduction": "这项综合性实践将理论知识与实用的计算技能相结合，真实地反映了现代大气科学家的工作。你将为探空数据设计一个质量控制算法，这是数值天气预报中的一个关键步骤。该练习要求你运用温变率和虚位温等热力学原理来识别并标记错误的大气测量数据。",
            "id": "4110055",
            "problem": "设计并实现一个完整的、可运行的程序，该程序使用热力学约束来评估无线电探空剖面，以标记指示传感器湿润或冻结的不一致虚位温剖面。您的程序必须从适用于数值天气预报和气候模拟的基本定律和核心定义中推导并使用所需的物理量，并应用科学上合理的约束。\n\n从以下基础开始：\n- 对于湿空气混合物，以虚温表示的理想气体定律将压强 $p$、密度 $\\rho$ 和温度 $T$ 关联起来，即 $p=\\rho R_d T_v$，其中 $R_d$ 为干空气气体常数，$T_v$ 为虚温。\n- 适用于绝热过程的热力学第一定律和静力平衡将环境温度随高度的变化与经过充分检验的温度递减率联系起来。在没有相变的情况下，干绝热递减率为 $g/c_p$，其中 $g$ 是重力加速度，$c_p$ 是干空气的定压比热。在有潜热加热的饱和上升过程中，湿绝热递减率 $\\Gamma_m$ 可由相同原理结合克劳修斯–克拉佩龙方程得出。\n- 克劳修斯–克拉佩龙方程使用一个经过充分检验的指数依赖关系，将液态水上的饱和水汽压 $e_s(T)$ 与温度 $T$ 关联起来。\n\n基于这些，您必须推导出：\n- 从第一性原理出发，推导湿空气的虚温 $T_v$ 和位温 $\\theta$ 的表达式，然后将这些量组合得到虚位温 $\\theta_v$。\n- 从相对湿度和饱和水汽压推导混合比 $q$ 的表达式，以及饱和混合比 $q_s$ 的表达式。\n- 适用于环境温度随高度变化的干绝热递减率和湿绝热递减率 $\\Gamma_m$。\n\n需要实现的质量控制逻辑：\n- 对于相邻层级之间的每一层，通过将端点的相对湿度与饱和阈值进行比较，来确定该层是未饱和还是饱和。在未饱和层中（两个端点的相对湿度均小于 $0.95$），环境温度递减率 $\\Gamma$ 的大小不得超过干绝热递减率 $g/c_p$ 加上一个小的容差。在饱和层中（任一端点的相对湿度大于或等于 $0.95$），$\\Gamma$ 的大小不得超过湿绝热递减率 $\\Gamma_m$ 加上一个小的容差。\n- 应标记指示湿润的持续过饱和现象：如果连续两个或更多层级的相对湿度超过 $1.05$，则该剖面不一致。\n- 如果剖面中任何地方违反了这些约束中的任何一个，则该剖面被标记为不一致。\n\n所有物理变量必须采用以下单位和约定：\n- 压强 $p$ 单位为帕斯卡（$\\mathrm{Pa}$）。\n- 温度 $T$ 单位为开尔文（$\\mathrm{K}$）。\n- 高度 $z$ 单位为米（$\\mathrm{m}$）。\n- 相对湿度 $h$ 为 $0$ 到 $1$ 之间的小数，对于错误的测量可能超过 $1$（例如，$1.08$）。\n- 重力加速度 $g$ 单位为 $\\mathrm{m}\\,\\mathrm{s}^{-2}$，比热 $c_p$ 单位为 $\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$，气体常数 $R_d$ 和 $R_v$ 单位为 $\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$，汽化潜热 $L_v$ 单位为 $\\mathrm{J}\\,\\mathrm{kg}^{-1}$。\n\n容差和阈值：\n- 使用 $\\delta_\\Gamma = 0.001$（单位为 $\\mathrm{K}\\,\\mathrm{m}^{-1}$）的递减率容差。\n- 对相对湿度使用 $1.05$ 的过饱和阈值，如果它出现在至少连续 $2$ 个层级，则认为其是持续性的。\n- 对层分类使用 $0.95$ 的饱和判定阈值。\n\n测试套件：\n提供四个剖面，每个剖面都包含等长的 $z$、$p$、$T$ 和 $h$ 数组：\n- 剖面 $1$（一般的正常对流层剖面）：\n  - 高度 $z$：$\\{0,500,1000,1500,2000,2500,3000\\}$，单位 $\\mathrm{m}$。\n  - 压强 $p$：$\\{100000,93940,88250,82900,77880,73160,68730\\}$，单位 $\\mathrm{Pa}$。\n  - 温度 $T$：$\\{288,285,282,279,276,273,270\\}$，单位 $\\mathrm{K}$。\n  - 相对湿度 $h$：$\\{0.50,0.55,0.60,0.70,0.85,0.90,0.80\\}$，小数形式。\n- 剖面 $2$（传感器湿润，伴有过饱和和急剧降温）：\n  - 高度 $z$：$\\{0,500,1000,1500,2000,2500,3000\\}$，单位 $\\mathrm{m}$。\n  - 压强 $p$：$\\{100000,93940,88250,82900,77880,73160,68730\\}$，单位 $\\mathrm{Pa}$。\n  - 温度 $T$：$\\{288,285,281,276,273,270,268\\}$，单位 $\\mathrm{K}$。\n  - 相对湿度 $h$：$\\{0.60,0.70,1.10,1.08,0.95,0.90,0.85\\}$，小数形式。\n- 剖面 $3$（类似传感器冻结的未饱和急剧递减率）：\n  - 高度 $z$：$\\{0,500,1000,1500,2000,2500,3000\\}$，单位 $\\mathrm{m}$。\n  - 压强 $p$：$\\{100000,93940,88250,82900,77880,73160,68730\\}$，单位 $\\mathrm{Pa}$。\n  - 温度 $T$：$\\{290,284,277,269,260,252,245\\}$，单位 $\\mathrm{K}$。\n  - 相对湿度 $h$：$\\{0.40,0.35,0.30,0.25,0.20,0.20,0.20\\}$，小数形式。\n- 剖面 $4$（稳定逆温边界情况）：\n  - 高度 $z$：$\\{0,500,1000,1500,2000,2500,3000\\}$，单位 $\\mathrm{m}$。\n  - 压强 $p$：$\\{100000,93940,88250,82900,77880,73160,68730\\}$，单位 $\\mathrm{Pa}$。\n  - 温度 $T$：$\\{285,286,287,287,286,284,282\\}$，单位 $\\mathrm{K}$。\n  - 相对湿度 $h$：$\\{0.80,0.75,0.70,0.65,0.60,0.55,0.50\\}$，小数形式。\n\n您的程序必须：\n- 使用提供的 $p$、$T$ 和 $h$，通过克劳修斯–克拉佩龙方程和理想气体定律框架计算混合比 $q$ 和饱和混合比 $q_s$。\n- 通过组合虚温和位温，从其基本定义计算虚位温 $\\theta_v$。\n- 根据指定的容差，评估每一层是否满足干绝热和湿绝热约束，并标记持续的过饱和现象。\n- 生成一行输出，包含一个逗号分隔的布尔标志列表，每个剖面一个，并用方括号括起来（例如，$\\left[\\mathrm{True},\\mathrm{False},\\mathrm{True},\\mathrm{False}\\right]$）。布尔字面量的大小写必须完全一致。\n\n不允许用户输入。所有使用的常数必须在物理上是合理的。程序逻辑必须完全自包含，并适用于所提供的测试套件。最终答案是针对每个剖面的布尔值：如果剖面被约束标记为不一致，则为 $\\mathrm{True}$，否则为 $\\mathrm{False}$。",
            "solution": "我们通过推导必要的热力学量，然后将其转化为系统性执行约束的算法来呈现解决方案。\n\n首先，我们陈述所需的常数和定义。令 $g$ 表示重力加速度（单位 $\\mathrm{m}\\,\\mathrm{s}^{-2}$），$c_p$ 表示干空气的定压比热（单位 $\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$），$R_d$ 和 $R_v$ 分别表示干空气和水汽的气体常数（单位 $\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$），$L_v$ 表示汽化潜热（单位 $\\mathrm{J}\\,\\mathrm{kg}^{-1}$）。令 $\\varepsilon = R_d/R_v$，$p_0$ 为参考压强（单位 $\\mathrm{Pa}$）。\n\n我们从使用虚温写出的湿空气混合物的理想气体定律开始。如果用虚温代替温度，湿空气密度 $\\rho$ 通过干空气气体常数与压强 $p$ 和温度相关联：\n$$\np = \\rho R_d T_v.\n$$\n虚温 $T_v$ 的定义使得状态方程对于湿空气使用 $R_d$ 仍然成立；它修正了 $T$ 以计入水汽的浮力效应。使用水汽的质量混合比 $q$（水汽质量与湿空气质量之比），我们得到虚温因子的一阶标准表达式\n$$\nT_v = T \\left(1+\\left(\\frac{1}{\\varepsilon}-1\\right) q \\right),\n$$\n该式通过用 $q$ 表示混合物的总比气体常数并对 $q$ 进行一阶展开而得到（对于典型的大气值 $q \\ll 1$）。因子 $\\left(\\frac{1}{\\varepsilon}-1\\right)$ 约等于 $0.607$，因为 $\\varepsilon \\approx 0.622$。\n\n干空气的位温 $\\theta$ 是指一个气块被绝热可逆地带到参考压强 $p_0$ 时所具有的温度。从绝热和静力条件下的热力学第一定律出发，温度、压强和熵之间的关系导出了众所周知的关系式\n$$\n\\theta = T \\left(\\frac{p_0}{p}\\right)^{\\kappa},\n$$\n其中 $\\kappa = R_d/c_p$。该关系式可通过沿等熵路径积分 $c_p dT - \\frac{R_d T}{p} dp = 0$ 推导得出，得到 $T p^{-\\kappa} = \\text{常数}$，从而得到所述的 $\\theta$。\n\n虚位温 $\\theta_v$ 结合了这两者，作为湿空气基于状态方程的稳定度变量：\n$$\n\\theta_v = \\theta \\left(1+\\left(\\frac{1}{\\varepsilon}-1\\right) q \\right).\n$$\n这个定义是一致的，因为在虚温因子中用 $\\theta$ 代替 $T$ 可以得到在绝热映射到 $p_0$ 时的正确密度缩放。\n\n为了从相对湿度 $h$ 得到混合比 $q$，我们使用克劳修斯–克拉佩龙方程计算饱和水汽压 $e_s(T)$。对于液态水上的温度，一个常用且有物理基础的形式是\n$$\ne_s(T) = e_0 \\exp\\!\\left(\\frac{L_v}{R_v}\\left(\\frac{1}{T_0} - \\frac{1}{T}\\right)\\right),\n$$\n其中 $e_0$ 是参考温度 $T_0$ 下的饱和水汽压。给定相对湿度 $h$（小数形式），实际水汽压为 $e = h \\, e_s(T)$。然后，根据道尔顿分压定律和组分的理想气体定律，可得到水汽混合比 $q$：\n$$\nq = \\frac{\\varepsilon \\, e}{p - e}.\n$$\n类似地，通过用 $e_s(T)$ 代替 $e$，可得到饱和混合比 $q_s$：\n$$\nq_s = \\frac{\\varepsilon \\, e_s(T)}{p - e_s(T)}.\n$$\n\n接下来，我们考虑温度递减率。对于一个未饱和层（无凝结），干绝热递减率是热力学第一定律应用于绝热气块的直接结果：\n$$\n\\Gamma_d = \\frac{g}{c_p},\n$$\n其中 $\\Gamma_d$ 是环境温度随高度每单位增加而降低的量值，单位为 $\\mathrm{K}\\,\\mathrm{m}^{-1}$。\n\n对于一个饱和层，湿绝热递减率 $\\Gamma_m$ 是将绝热上升与根据热力学第一定律和克劳修斯–克拉佩龙方程的潜热释放耦合的结果。一个物理上标准的表达式是\n$$\n\\Gamma_m = \\frac{g \\left(1 + \\frac{L_v q_s}{R_d T}\\right)}{c_p + \\frac{L_v^2 q_s \\varepsilon}{R_d T^2}},\n$$\n该式考虑了由于凝结释放潜热而导致的冷却速率降低。此表达式的推导过程是：设置湿气块的熵变为零，并平衡感热变化 $c_p dT$ 与功项和潜热释放 $L_v dq_s$，其中 $dq_s$ 通过克劳修斯–克拉佩龙方程获得。\n\n我们将厚度为 $\\Delta z$ 的气层上的环境温度递减率定义为\n$$\n\\Gamma = \\frac{T(z) - T(z+\\Delta z)}{\\Delta z},\n$$\n因此 $\\Gamma > 0$ 对应于温度随高度降低。\n\n质量控制检查现规定如下：\n- 未饱和约束：如果一个气层的两个端点都满足 $h  0.95$，则要求 $\\Gamma \\le \\Gamma_d + \\delta_\\Gamma$，其中 $\\delta_\\Gamma$ 是一个容差（单位为 $\\mathrm{K}\\,\\mathrm{m}^{-1}$），以适应测量噪声和离散化。\n- 饱和约束：如果一个气层的任一端点满足 $h \\ge 0.95$，则要求 $\\Gamma \\le \\Gamma_m + \\delta_\\Gamma$，其中 $\\Gamma_m$ 是在该层的平均状态下计算的，使用该层的平均 $T$ 和 $p$ 以及该状态下的 $q_s$。\n- 过饱和持续性：如果在连续两个或更多层级上 $h > 1.05$，则标记该剖面。\n\n我们将常数和阈值赋予定于物理上合理的值：\n- $g = 9.81$ 单位 $\\mathrm{m}\\,\\mathrm{s}^{-2}$，\n- $c_p = 1004.0$ 单位 $\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$，\n- $R_d = 287.0$ 单位 $\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$，\n- $R_v = 461.5$ 单位 $\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$，\n- $\\varepsilon = R_d/R_v \\approx 0.622$，\n- $L_v = 2.5 \\times 10^6$ 单位 $\\mathrm{J}\\,\\mathrm{kg}^{-1}$，\n- $e_0 = 611.2$ 单位 $\\mathrm{Pa}$，在 $T_0 = 273.15$ 单位 $\\mathrm{K}$ 时，\n- $p_0 = 100000.0$ 单位 $\\mathrm{Pa}$，\n- $\\delta_\\Gamma = 0.001$ 单位 $\\mathrm{K}\\,\\mathrm{m}^{-1}$。\n\n每个剖面的算法步骤：\n1. 对于每个层级 $i$，通过克劳修斯–克拉佩龙方程计算 $e_s(T_i)$，然后计算 $e_i = h_i e_s(T_i)$ 和 $q_i = \\varepsilon e_i/(p_i - e_i)$。计算 $\\theta_i = T_i (p_0/p_i)^{R_d/c_p}$ 和 $T_{v,i} = T_i (1 + (1/\\varepsilon - 1) q_i)$，然后计算 $\\theta_{v,i} = \\theta_i (1 + (1/\\varepsilon - 1) q_i)$。\n2. 对于每对相邻层级 $(i,i+1)$，计算 $\\Delta z = z_{i+1} - z_i$ 和环境温度递减率 $\\Gamma_i = (T_i - T_{i+1})/\\Delta z$。\n3. 如果 $h_i  0.95$ 且 $h_{i+1}  0.95$，则将该层分类为未饱和层，否则为饱和层。对于未饱和层，检查 $\\Gamma_i \\le \\Gamma_d + \\delta_\\Gamma$。对于饱和层，计算层平均值 $T_m = (T_i + T_{i+1})/2$，$p_m = (p_i + p_{i+1})/2$，由 $T_m$ 和 $p_m$ 计算 $q_{s,m}$，并检查 $\\Gamma_i \\le \\Gamma_m(T_m,p_m,q_{s,m}) + \\delta_\\Gamma$。\n4. 扫描剖面以查找持续的过饱和：找到任何具有 $h > 1.05$ 的连续两个或更多层级。\n5. 如果任何检查失败，则将剖面标记为不一致（$\\mathrm{True}$）。否则，将其标记为一致（$\\mathrm{False}$）。\n\n应用于测试套件：\n- 剖面 $1$ 的特点是，在未饱和层中，递减率适中，远低于 $g/c_p$，且无过饱和；它不应被标记。\n- 剖面 $2$ 在连续层级上表现出 $h > 1.05$，并且在饱和层中的温度急剧下降超过了湿绝热界限；它应该被标记。\n- 剖面 $3$ 在多个未饱和层中表现出超过 $g/c_p$ 的递减率；它应该被标记。\n- 剖面 $4$ 表现出稳定的逆温，无过饱和，且递减率未违反界限；它不应被标记。\n\n程序输出一行，包含四个布尔结果，按剖面 $1$ 到 $4$ 的顺序排列，用方括号括起并用逗号分隔，例如 $[\\mathrm{False},\\mathrm{True},\\mathrm{True},\\mathrm{False}]$。",
            "answer": "```python\n# Python 3.12\n# Libraries: numpy 1.23.5 (used), scipy 1.11.4 (not used)\nimport numpy as np\n\n# Physical constants\ng = 9.81  # m s^-2\ncp = 1004.0  # J kg^-1 K^-1\nRd = 287.0  # J kg^-1 K^-1\nRv = 461.5  # J kg^-1 K^-1\nepsilon = Rd / Rv  # ~0.622\nLv = 2.5e6  # J kg^-1\ne0 = 611.2  # Pa\nT0 = 273.15  # K\np0 = 100000.0  # Pa\n\n# Thresholds\ndelta_gamma = 0.001  # K m^-1\nsat_layer_rh_threshold = 0.95\nsupersat_threshold = 1.05\nsupersat_consecutive_levels = 2  # consecutive levels required to flag\n\ndef saturation_vapor_pressure(T):\n    \"\"\"\n    Clausius-Clapeyron over liquid water:\n    e_s(T) = e0 * exp(Lv/Rv * (1/T0 - 1/T))\n    \"\"\"\n    return e0 * np.exp(Lv / Rv * (1.0 / T0 - 1.0 / T))\n\ndef mixing_ratio(p, T, rh):\n    \"\"\"\n    Mixing ratio q = epsilon * e / (p - e), where e = rh * e_s(T).\n    \"\"\"\n    es = saturation_vapor_pressure(T)\n    e = rh * es\n    # Prevent pathological division if e >= p by capping e just below p\n    e = np.minimum(e, 0.999 * p)\n    q = epsilon * e / (p - e)\n    return q\n\ndef saturation_mixing_ratio(p, T):\n    \"\"\"\n    Saturation mixing ratio q_s computed with e_s(T).\n    \"\"\"\n    es = saturation_vapor_pressure(T)\n    es = np.minimum(es, 0.999 * p)\n    qs = epsilon * es / (p - es)\n    return qs\n\ndef exner_function(p):\n    kappa = Rd / cp\n    return (p / p0) ** kappa\n\ndef potential_temperature(T, p):\n    kappa = Rd / cp\n    return T * (p0 / p) ** kappa\n\ndef virtual_temperature(T, q):\n    factor = (1.0 / epsilon) - 1.0\n    return T * (1.0 + factor * q)\n\ndef virtual_potential_temperature(T, p, q):\n    theta = potential_temperature(T, p)\n    factor = (1.0 / epsilon) - 1.0\n    return theta * (1.0 + factor * q)\n\ndef dry_adiabatic_lapse_rate():\n    return g / cp  # K/m\n\ndef moist_adiabatic_lapse_rate(T, p):\n    \"\"\"\n    Compute Gamma_m at given T (K) and p (Pa) using saturation mixing ratio qs(T,p):\n    Gamma_m = g * (1 + (Lv * qs)/(Rd * T)) / (cp + (Lv^2 * qs * epsilon)/(Rd * T^2))\n    \"\"\"\n    qs = saturation_mixing_ratio(p, T)\n    numerator = g * (1.0 + (Lv * qs) / (Rd * T))\n    denominator = cp + (Lv * Lv * qs * epsilon) / (Rd * T * T)\n    return numerator / denominator\n\ndef profile_flag(z, p, T, rh):\n    \"\"\"\n    Apply QC rules to a single profile.\n    Returns True if profile is inconsistent, False otherwise.\n    \"\"\"\n    n = len(z)\n    # Compute variables at levels\n    q = mixing_ratio(p, T, rh)\n    theta_v = virtual_potential_temperature(T, p, q)\n\n    # Supersaturation persistence check\n    supersat_mask = rh > supersat_threshold\n    # Count maximum run length of consecutive supersaturation\n    if n > 0:\n        # Using simple loop to detect at least 'supersat_consecutive_levels' consecutive True\n        consec = 0\n        persistent_supersat = False\n        for i in range(n):\n            if supersat_mask[i]:\n                consec += 1\n                if consec >= supersat_consecutive_levels:\n                    persistent_supersat = True\n                    break\n            else:\n                consec = 0\n        if persistent_supersat:\n            return True\n\n    # Layer checks\n    gamma_d = dry_adiabatic_lapse_rate()\n    for i in range(n - 1):\n        dz = z[i+1] - z[i]\n        if dz = 0:\n            # Non-increasing height is physically inconsistent; flag\n            return True\n        gamma_env = (T[i] - T[i+1]) / dz  # K/m\n        # Classify saturation for the layer\n        unsat_layer = (rh[i]  sat_layer_rh_threshold) and (rh[i+1]  sat_layer_rh_threshold)\n        if unsat_layer:\n            # Unsaturated constraint\n            if gamma_env > (gamma_d + delta_gamma):\n                return True\n        else:\n            # Saturated constraint: compute Gamma_m at layer-mean state\n            Tm = 0.5 * (T[i] + T[i+1])\n            pm = 0.5 * (p[i] + p[i+1])\n            gamma_m = moist_adiabatic_lapse_rate(Tm, pm)\n            if gamma_env > (gamma_m + delta_gamma):\n                return True\n\n    # If all checks pass, profile is consistent\n    return False\n\ndef solve():\n    # Define the test cases from the problem statement.\n\n    # Profile 1\n    z1 = np.array([0, 500, 1000, 1500, 2000, 2500, 3000], dtype=float)\n    p1 = np.array([100000, 93940, 88250, 82900, 77880, 73160, 68730], dtype=float)\n    T1 = np.array([288, 285, 282, 279, 276, 273, 270], dtype=float)\n    rh1 = np.array([0.50, 0.55, 0.60, 0.70, 0.85, 0.90, 0.80], dtype=float)\n\n    # Profile 2\n    z2 = np.array([0, 500, 1000, 1500, 2000, 2500, 3000], dtype=float)\n    p2 = np.array([100000, 93940, 88250, 82900, 77880, 73160, 68730], dtype=float)\n    T2 = np.array([288, 285, 281, 276, 273, 270, 268], dtype=float)\n    rh2 = np.array([0.60, 0.70, 1.10, 1.08, 0.95, 0.90, 0.85], dtype=float)\n\n    # Profile 3\n    z3 = np.array([0, 500, 1000, 1500, 2000, 2500, 3000], dtype=float)\n    p3 = np.array([100000, 93940, 88250, 82900, 77880, 73160, 68730], dtype=float)\n    T3 = np.array([290, 284, 277, 269, 260, 252, 245], dtype=float)\n    rh3 = np.array([0.40, 0.35, 0.30, 0.25, 0.20, 0.20, 0.20], dtype=float)\n\n    # Profile 4\n    z4 = np.array([0, 500, 1000, 1500, 2000, 2500, 3000], dtype=float)\n    p4 = np.array([100000, 93940, 88250, 82900, 77880, 73160, 68730], dtype=float)\n    T4 = np.array([285, 286, 287, 287, 286, 284, 282], dtype=float)\n    rh4 = np.array([0.80, 0.75, 0.70, 0.65, 0.60, 0.55, 0.50], dtype=float)\n\n    test_cases = [\n        (z1, p1, T1, rh1),\n        (z2, p2, T2, rh2),\n        (z3, p3, T3, rh3),\n        (z4, p4, T4, rh4),\n    ]\n\n    results = []\n    for z, p, T, rh in test_cases:\n        flag = profile_flag(z, p, T, rh)\n        results.append(flag)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}