{
    "hands_on_practices": [
        {
            "introduction": "In atmospheric science, humidity can be expressed using various quantities, each suited for different applications. While numerical models often use mass-based variables like specific humidity ($q$), modern spectroscopic instruments may measure mole-based quantities like the molar mixing ratio ($x_v$). This exercise provides practice in the essential skill of converting between these representations by deriving the relationship from first principles involving molecular mass .",
            "id": "4052433",
            "problem": "In a data assimilation system for numerical weather prediction, a near-surface humidity observation is provided as a molar mixing ratio of water vapor measured by Cavity Ring-Down Spectroscopy (CRDS). Let the measured molar mixing ratio be $x_v = 1.42 \\times 10^{-2}$. The specific humidity $q$ is defined as the ratio of the mass of water vapor to the total mass of moist air, and the molar mixing ratio $x_v$ is defined as the ratio of the number of moles of water vapor to the total number of moles of moist air. Starting from these definitions and the concept of molecular mass, derive an expression for $q$ in terms of $x_v$, the molecular mass of water vapor $M_v$, and the mean molecular mass of dry air $M_d$. Then, using scientifically typical values for atmospheric air $M_v = 18.01528\\,\\mathrm{g\\,mol^{-1}}$ and $M_d = 28.9647\\,\\mathrm{g\\,mol^{-1}}$, compute the numerical value of $q$ for the given $x_v$. Express the final result for $q$ as a dimensionless mass fraction in $\\mathrm{kg\\,kg^{-1}}$. Round your answer to four significant figures.",
            "solution": "The problem is valid as it is scientifically grounded, well-posed, objective, and contains all necessary information for a unique solution. The definitions and values provided are standard in atmospheric science.\n\nThe task is to first derive an expression for the specific humidity $q$ in terms of the molar mixing ratio $x_v$, the molecular mass of water vapor $M_v$, and the mean molecular mass of dry air $M_d$. Then, a numerical value for $q$ must be computed.\n\nBy definition, the specific humidity $q$ is the ratio of the mass of water vapor, $m_v$, to the total mass of the moist air parcel, $m_t$. The total mass is the sum of the mass of water vapor and the mass of dry air, $m_d$.\n$$q = \\frac{m_v}{m_t} = \\frac{m_v}{m_v + m_d}$$\nThe molar mixing ratio $x_v$ is defined as the ratio of the number of moles of water vapor, $n_v$, to the total number of moles in the moist air parcel, $n_t$. The total number of moles is the sum of the moles of water vapor and the moles of dry air, $n_d$.\n$$x_v = \\frac{n_v}{n_t} = \\frac{n_v}{n_v + n_d}$$\nThe mass of a substance is related to its number of moles and its molecular mass $M$ by the fundamental relation $m = n M$. Applying this to water vapor and dry air, we have:\n$$m_v = n_v M_v$$\n$$m_d = n_d M_d$$\nSubstituting these expressions for mass into the definition of specific humidity $q$:\n$$q = \\frac{n_v M_v}{n_v M_v + n_d M_d}$$\nTo express $q$ in terms of $x_v$, we can divide both the numerator and the denominator of the expression for $q$ by the total number of moles, $n_t = n_v + n_d$.\n$$q = \\frac{\\frac{n_v M_v}{n_t}}{\\frac{n_v M_v}{n_t} + \\frac{n_d M_d}{n_t}}$$\nThis can be rewritten as:\n$$q = \\frac{\\left(\\frac{n_v}{n_t}\\right) M_v}{\\left(\\frac{n_v}{n_t}\\right) M_v + \\left(\\frac{n_d}{n_t}\\right) M_d}$$\nBy definition, $\\frac{n_v}{n_t} = x_v$. The term $\\frac{n_d}{n_t}$ represents the mole fraction of dry air, let's call it $x_d$. Since moist air is treated as a two-component mixture of water vapor and dry air, the sum of their mole fractions must be unity:\n$$x_v + x_d = 1 \\implies x_d = 1 - x_v$$\nSubstituting $x_v$ and $x_d = 1 - x_v$ into the equation for $q$, we obtain the desired expression:\n$$q = \\frac{x_v M_v}{x_v M_v + (1 - x_v) M_d}$$\nThis expression relates the specific humidity $q$ to the molar mixing ratio $x_v$ and the molecular masses of water vapor $M_v$ and dry air $M_d$.\n\nNow, we compute the numerical value of $q$ using the provided data:\n- Molar mixing ratio: $x_v = 1.42 \\times 10^{-2}$ (dimensionless)\n- Molecular mass of water vapor: $M_v = 18.01528\\,\\mathrm{g\\,mol^{-1}}$\n- Mean molecular mass of dry air: $M_d = 28.9647\\,\\mathrm{g\\,mol^{-1}}$\n\nSubstituting these values into the derived formula:\n$$q = \\frac{(1.42 \\times 10^{-2}) \\times (18.01528)}{(1.42 \\times 10^{-2}) \\times (18.01528) + (1 - 1.42 \\times 10^{-2}) \\times (28.9647)}$$\nFirst, calculate the terms:\n$$1 - 1.42 \\times 10^{-2} = 1 - 0.0142 = 0.9858$$\nNumerator:\n$$1.42 \\times 10^{-2} \\times 18.01528 = 0.255816976$$\nDenominator:\n$$ (0.255816976) + (0.9858 \\times 28.9647) = 0.255816976 + 28.55243346 = 28.808250436 $$\nNow, compute the ratio:\n$$q = \\frac{0.255816976}{28.808250436} \\approx 0.0088800160$$\nThe molecular mass units ($\\mathrm{g\\,mol^{-1}}$) cancel, making $q$ a dimensionless mass fraction, as required. The problem asks for the result to be rounded to four significant figures. The first four significant figures are $8$, $8$, $8$, and $0$. The fifth significant figure is $0$, so we round down.\n$$q \\approx 0.008880$$\nThis value represents the specific humidity as a mass fraction in $\\mathrm{kg\\,kg^{-1}}$.",
            "answer": "$$\\boxed{0.008880}$$"
        },
        {
            "introduction": "The concept of saturation is fundamental to cloud formation and precipitation processes within weather and climate models. Saturation vapor pressure ($e_s$), a strong function of temperature, is often represented by computationally efficient empirical formulas. This practice delves into the crucial task of evaluating the accuracy of such parameterizations against a more rigorous baseline derived from the Clausius–Clapeyron relation, providing insight into the trade-offs between physical accuracy and computational cost in model development .",
            "id": "4052489",
            "problem": "You are to implement and evaluate empirical formulas for saturation vapor pressure as a function of temperature against a physically derived baseline obtained from the integrated Clausius–Clapeyron relation. The focus is on humidity variables and mixing ratios relevant to Numerical Weather Prediction (NWP). Your program must compute error metrics between the empirical formulas and the baseline and report the results in a rigorously specified format.\n\nStart from the following foundational base:\n\n1. The Clausius–Clapeyron (CC) differential form for saturation vapor pressure over liquid water is\n$$\\frac{d \\ln e_s}{dT} = \\frac{L_v(T)}{R_v T^2},$$\nwhere $e_s$ is saturation vapor pressure, $T$ is absolute temperature, $L_v(T)$ is the temperature-dependent latent heat of vaporization, and $R_v$ is the specific gas constant for water vapor.\n\n2. Use the linear-in-temperature approximation for latent heat,\n$$L_v(T) = L_{v,0} - \\lambda \\left(T - T_0\\right),$$\nwith $L_{v,0} = 2.501\\times 10^6\\,\\mathrm{J\\,kg^{-1}}$, $\\lambda = 2.37\\times 10^3\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$, and $T_0 = 273.15\\,\\mathrm{K}$.\n\n3. Use the reference saturation vapor pressure at $T_0$ over liquid water,\n$e_s(T_0) = 611.2\\,\\mathrm{Pa}$.\n\n4. The specific gas constant for water vapor is\n$R_v = 461.5\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$,\nand the ratio of the dry-air gas constant to the water-vapor gas constant is\n$$\\varepsilon = \\frac{R_d}{R_v} = \\frac{287.05}{461.5}.$$\n\nYour baseline $e_s(T)$ must be computed by integrating the Clausius–Clapeyron form stated above consistently with the given $L_v(T)$ and $e_s(T_0)$. You may perform the integration by any mathematically correct method that respects the stated base.\n\nImplement the following two empirical formulas for saturation vapor pressure over liquid water as functions of temperature in degrees Celsius:\n\n- Tetens (commonly used in meteorology):\n$$e_s^{\\mathrm{Tetens}}(T_C) = 6.1078 \\times \\exp\\left(\\frac{17.2694\\, T_C}{T_C + 237.3}\\right)\\ \\mathrm{hPa},$$\nto be converted to Pascals by multiplying by $100$.\n\n- Magnus (Alduchov and Eskridge constants for over water):\n$$e_s^{\\mathrm{Magnus}}(T_C) = 6.1094 \\times \\exp\\left(\\frac{17.625\\, T_C}{T_C + 243.04}\\right)\\ \\mathrm{hPa},$$\nto be converted to Pascals by multiplying by $100$.\n\nDefine the saturation mixing ratio over liquid water for a given total pressure $p$ as\n$$r_s(T, p) = \\varepsilon \\frac{e_s(T)}{p - e_s(T)},$$\nwhich is dimensionless in $\\mathrm{kg\\,kg^{-1}}$.\n\nFor each empirical formula, compute the following error metrics with respect to the baseline across a uniform grid of temperatures:\n\n- The root-mean-square relative error in saturation vapor pressure,\n$$\\mathrm{RMSE}_e = \\sqrt{\\frac{1}{N}\\sum_{i=1}^{N} \\left(\\frac{|e_s^{\\mathrm{emp}}(T_i) - e_s^{\\mathrm{base}}(T_i)|}{e_s^{\\mathrm{base}}(T_i)}\\right)^2},$$\nand the maximum relative error,\n$$\\mathrm{MAX}_e = \\max_{i=1,\\ldots,N}\\left(\\frac{|e_s^{\\mathrm{emp}}(T_i) - e_s^{\\mathrm{base}}(T_i)|}{e_s^{\\mathrm{base}}(T_i)}\\right).$$\n\n- The root-mean-square relative error in the saturation mixing ratio at the specified pressure $p$,\n$$\\mathrm{RMSE}_r = \\sqrt{\\frac{1}{N}\\sum_{i=1}^{N} \\left(\\frac{|r_s^{\\mathrm{emp}}(T_i, p) - r_s^{\\mathrm{base}}(T_i, p)|}{r_s^{\\mathrm{base}}(T_i, p)}\\right)^2},$$\nand the maximum relative error,\n$$\\mathrm{MAX}_r = \\max_{i=1,\\ldots,N}\\left(\\frac{|r_s^{\\mathrm{emp}}(T_i, p) - r_s^{\\mathrm{base}}(T_i, p)|}{r_s^{\\mathrm{base}}(T_i, p)}\\right).$$\n\nAll temperatures fed to the baseline must be in Kelvin, with conversion $T = T_C + 273.15$, and all pressures must be in Pascals. The saturation vapor pressure $e_s$ must be computed in Pascals. The saturation mixing ratio $r_s$ should be reported as a dimensionless quantity in $\\mathrm{kg\\,kg^{-1}}$. All angles are irrelevant to this problem.\n\nTest Suite:\nImplement the computations for the following four test cases. Each test case is a tuple $(T_C^{\\min}, T_C^{\\max}, N, p, \\mathrm{formula})$:\n\n1. Case $1$: $(-20.0, 35.0, 111, 100000.0, \\text{\"tetens\"})$.\n2. Case $2$: $(-40.0, 50.0, 181, 85000.0, \\text{\"magnus\"})$.\n3. Case $3$: $(-60.0, -20.0, 81, 50000.0, \\text{\"tetens\"})$.\n4. Case $4$: $(30.0, 60.0, 61, 70000.0, \\text{\"magnus\"})$.\n\nFor each case, construct a uniform grid of $N$ temperatures in degrees Celsius between $T_C^{\\min}$ and $T_C^{\\max}$ inclusive, convert to Kelvin for the baseline, and compute the four metrics specified above.\n\nFinal Output Format:\nYour program should produce a single line of output containing a list of four lists, one per test case, in the order listed above. Each inner list must contain the four floats $[\\mathrm{RMSE}_e, \\mathrm{MAX}_e, \\mathrm{RMSE}_r, \\mathrm{MAX}_r]$, each rounded to eight decimal places, and the whole output must be printed as a single Python list literal, for example,\n$$[\\,[x_1, x_2, x_3, x_4],\\,[y_1, y_2, y_3, y_4],\\,[z_1, z_2, z_3, z_4],\\,[w_1, w_2, w_3, w_4]\\,].$$\nAll computed quantities must be in $\\mathrm{Pa}$ for saturation vapor pressure $e_s$, in $\\mathrm{kg\\,kg^{-1}}$ for saturation mixing ratio $r_s$, and temperatures must be handled internally in $\\mathrm{K}$ for the baseline and in ${}^\\circ\\mathrm{C}$ where specified for the empirical formulas. Report the final floats as decimal numbers with eight digits after the decimal point.",
            "solution": "The problem is assessed as valid and will be solved as follows.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n- **Clausius-Clapeyron (CC) Relation**: $\\frac{d \\ln e_s}{dT} = \\frac{L_v(T)}{R_v T^2}$, for saturation vapor pressure $e_s$ over liquid water as a function of absolute temperature $T$.\n- **Latent Heat of Vaporization**: A linear-in-temperature approximation is given by $L_v(T) = L_{v,0} - \\lambda (T - T_0)$.\n- **Physical Constants**:\n    - $L_{v,0} = 2.501 \\times 10^6\\,\\mathrm{J\\,kg^{-1}}$\n    - $\\lambda = 2.37 \\times 10^3\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$\n    - $T_0 = 273.15\\,\\mathrm{K}$\n    - $e_s(T_0) = 611.2\\,\\mathrm{Pa}$ (reference saturation vapor pressure at $T_0$)\n    - $R_v = 461.5\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$ (specific gas constant for water vapor)\n    - $\\varepsilon = \\frac{R_d}{R_v} = \\frac{287.05}{461.5}$ (ratio of gas constants for dry air and water vapor)\n- **Empirical Formulas for $e_s$ (in hPa, for temperature $T_C$ in Celsius)**:\n    - **Tetens**: $e_s^{\\mathrm{Tetens}}(T_C) = 6.1078 \\times \\exp\\left(\\frac{17.2694\\, T_C}{T_C + 237.3}\\right)$\n    - **Magnus**: $e_s^{\\mathrm{Magnus}}(T_C) = 6.1094 \\times \\exp\\left(\\frac{17.625\\, T_C}{T_C + 243.04}\\right)$\n    - Note: Results to be converted to Pascals by multiplying by $100$.\n- **Saturation Mixing Ratio**: $r_s(T, p) = \\varepsilon \\frac{e_s(T)}{p - e_s(T)}$, for total pressure $p$.\n- **Error Metrics**:\n    - $\\mathrm{RMSE}_e = \\sqrt{\\frac{1}{N}\\sum_{i=1}^{N} \\left(\\frac{|e_s^{\\mathrm{emp}}(T_i) - e_s^{\\mathrm{base}}(T_i)|}{e_s^{\\mathrm{base}}(T_i)}\\right)^2}$\n    - $\\mathrm{MAX}_e = \\max_{i}\\left(\\frac{|e_s^{\\mathrm{emp}}(T_i) - e_s^{\\mathrm{base}}(T_i)|}{e_s^{\\mathrm{base}}(T_i)}\\right)$\n    - $\\mathrm{RMSE}_r = \\sqrt{\\frac{1}{N}\\sum_{i=1}^{N} \\left(\\frac{|r_s^{\\mathrm{emp}}(T_i, p) - r_s^{\\mathrm{base}}(T_i, p)|}{r_s^{\\mathrm{base}}(T_i, p)}\\right)^2}$\n    - $\\mathrm{MAX}_r = \\max_{i}\\left(\\frac{|r_s^{\\mathrm{emp}}(T_i, p) - r_s^{\\mathrm{base}}(T_i, p)|}{r_s^{\\mathrm{base}}(T_i, p)}\\right)$\n- **Test Suite**: Four cases, each defined by a tuple $(T_C^{\\min}, T_C^{\\max}, N, p, \\mathrm{formula})$.\n\n**Step 2: Validate Using Extracted Givens**\n- **Scientifically Grounded (Critical)**: The problem is fundamentally rooted in thermodynamics, using the Clausius-Clapeyron relation. The constants, empirical formulas (Tetens, Magnus), and derived quantities like saturation mixing ratio are all standard and widely used in atmospheric science and numerical weather prediction. The problem is scientifically sound and realistic.\n- **Well-Posed**: The problem is fully specified. It provides a differential equation, a boundary condition ($e_s(T_0)$), and all necessary constants to derive a unique baseline function $e_s(T)$. The empirical formulas and error metrics are explicitly defined. The test cases provide all necessary inputs.\n- **Objective (Critical)**: The problem statement is written in precise, quantitative terms. The task is a formal computational comparison, devoid of any subjectivity or ambiguity.\n\n**Step 3: Verdict and Action**\nThe problem is valid. A complete solution will be developed.\n\n### Solution Derivation and Algorithmic Design\n\nThe core of the problem is to establish a high-fidelity baseline for saturation vapor pressure, $e_s^{\\mathrm{base}}(T)$, by integrating the Clausius-Clapeyron equation, and then to compare it against two common empirical formulas.\n\n**1. Baseline Saturation Vapor Pressure, $e_s^{\\mathrm{base}}(T)$**\n\nWe start with the differential form:\n$$ \\frac{d \\ln e_s}{dT} = \\frac{L_v(T)}{R_v T^2} $$\nSubstitute the given linear approximation for $L_v(T) = L_{v,0} - \\lambda(T - T_0) = (L_{v,0} + \\lambda T_0) - \\lambda T$:\n$$ \\frac{d \\ln e_s}{dT} = \\frac{(L_{v,0} + \\lambda T_0) - \\lambda T}{R_v T^2} = \\frac{L_{v,0} + \\lambda T_0}{R_v} \\frac{1}{T^2} - \\frac{\\lambda}{R_v} \\frac{1}{T} $$\nWe integrate this expression from the reference state $(T_0, e_s(T_0))$ to an arbitrary state $(T, e_s(T))$:\n$$ \\int_{e_s(T_0)}^{e_s(T)} d\\ln e_s' = \\int_{T_0}^{T} \\left( \\frac{L_{v,0} + \\lambda T_0}{R_v} \\frac{1}{T'^2} - \\frac{\\lambda}{R_v} \\frac{1}{T'} \\right) dT' $$\nThe left side integrates to $\\ln e_s(T) - \\ln e_s(T_0) = \\ln\\left(\\frac{e_s(T)}{e_s(T_0)}\\right)$.\nThe right side integrates to:\n$$ \\left[ \\frac{L_{v,0} + \\lambda T_0}{R_v} \\left(-\\frac{1}{T'}\\right) - \\frac{\\lambda}{R_v} \\ln T' \\right]_{T_0}^{T} $$\n$$ = \\frac{L_{v,0} + \\lambda T_0}{R_v} \\left(\\frac{1}{T_0} - \\frac{1}{T}\\right) - \\frac{\\lambda}{R_v} \\left(\\ln T - \\ln T_0\\right) $$\nSetting the two sides equal and solving for $e_s(T)$ yields the baseline formula:\n$$ e_s^{\\mathrm{base}}(T) = e_s(T_0) \\exp\\left[ \\frac{L_{v,0} + \\lambda T_0}{R_v} \\left(\\frac{1}{T_0} - \\frac{1}{T}\\right) - \\frac{\\lambda}{R_v} \\ln\\left(\\frac{T}{T_0}\\right) \\right] $$\nThis equation will be implemented to calculate the baseline saturation vapor pressure for a given temperature $T$ in Kelvin.\n\n**2. Empirical Formulas and Mixing Ratio**\n\nThe two empirical formulas for $e_s(T_C)$ take temperature $T_C$ in Celsius and yield pressure in hectopascals (hPa). They must be converted to Pascals (Pa) for consistency.\n$$ T = T_C + 273.15 $$\n$$ e_s^{\\mathrm{emp, Pa}} = e_s^{\\mathrm{emp, hPa}} \\times 100 $$\nThe saturation mixing ratio, $r_s$, is calculated for both baseline and empirical $e_s$ values using the provided formula and total pressure $p$:\n$$ r_s(T, p) = \\varepsilon \\frac{e_s(T)}{p - e_s(T)} $$\n\n**3. Error Calculation**\n\nThe error metrics $\\mathrm{RMSE}_e$, $\\mathrm{MAX}_e$, $\\mathrm{RMSE}_r$, and $\\mathrm{MAX}_r$ are computed as specified in the problem statement. This involves calculating the relative error at each point on the temperature grid and then applying the root-mean-square and maximum operations.\n\n**4. Algorithmic Procedure**\n\nThe solution will be implemented in Python using the `numpy` library for efficient vectorized computations. The overall algorithm is as follows:\n\n1.  Define all physical constants given in the problem statement ($L_{v,0}$, $\\lambda$, $T_0$, $e_s(T_0)$, $R_v$, $\\varepsilon$).\n2.  Implement a function `e_s_baseline(T_K)` that computes the baseline saturation vapor pressure using the derived analytical formula for an array of temperatures in Kelvin.\n3.  Implement functions `e_s_tetens(T_C)` and `e_s_magnus(T_C)` for the empirical formulas, including the conversion from hPa to Pa, for an array of temperatures in Celsius.\n4.  Implement a function `r_s(e_s, p)` which calculates the saturation mixing ratio for given arrays of saturation vapor pressure and a scalar total pressure.\n5.  Iterate through the four test cases provided in the `Test Suite`. For each case $(T_C^{\\min}, T_C^{\\max}, N, p, \\mathrm{formula})$:\n    a. Generate a grid of $N$ temperatures $T_C$ from $T_C^{\\min}$ to $T_C^{\\max}$ inclusive.\n    b. Convert the $T_C$ grid to Kelvin, $T_K$.\n    c. Calculate the baseline values $e_s^{\\mathrm{base}}$ and $r_s^{\\mathrm{base}}$ over the grid.\n    d. Based on the `formula` string, select the appropriate empirical function and calculate the empirical values $e_s^{\\mathrm{emp}}$ and $r_s^{\\mathrm{emp}}$.\n    e. Compute the relative error arrays for $e_s$ and $r_s$: e.g., `rel_err_e = |e_s_emp - e_s_base| / e_s_base`.\n    f. Compute the four metrics: $\\mathrm{RMSE}_e$, $\\mathrm{MAX}_e$, $\\mathrm{RMSE}_r$, and $\\mathrm{MAX}_r$. For example, `RMSE_e = np.sqrt(np.mean(rel_err_e**2))`.\n    g. Store the four computed metrics as a list of floating-point numbers.\n6.  Collect the results from all four test cases into a master list.\n7.  Format the final list of lists into the required string format, ensuring each numerical result is represented with eight digits after the decimal point, and print to standard output.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes and compares saturation vapor pressure from a physically-derived baseline\n    and empirical formulas, reporting specified error metrics.\n    \"\"\"\n    # Define physical constants as per the problem statement\n    L_v0 = 2.501e6  # J/kg\n    LAMBDA_L = 2.37e3 # J/(kg*K)\n    T0 = 273.15     # K\n    E_S0 = 611.2    # Pa\n    RV = 461.5      # J/(kg*K)\n    EPSILON = 287.05 / 461.5 # Dimensionless ratio Rd/Rv\n\n    # Pre-compute constants for the baseline formula for efficiency\n    C1 = (L_v0 + LAMBDA_L * T0) / RV\n    C2 = LAMBDA_L / RV\n    \n    def e_s_baseline(T_K):\n        \"\"\"\n        Calculates baseline saturation vapor pressure over liquid water using the\n        integrated Clausius-Clapeyron relation with temperature-dependent L_v.\n        \n        Args:\n            T_K (np.ndarray): Temperature in Kelvin.\n        \n        Returns:\n            np.ndarray: Saturation vapor pressure in Pascals.\n        \"\"\"\n        # Avoid division by zero or log(0) if T_K contains 0.\n        # Problem constraints ensure T_K  0.\n        term1 = C1 * (1.0 / T0 - 1.0 / T_K)\n        term2 = C2 * np.log(T_K / T0)\n        return E_S0 * np.exp(term1 - term2)\n\n    def e_s_tetens(T_C):\n        \"\"\"\n        Calculates saturation vapor pressure using the Tetens formula.\n        \n        Args:\n            T_C (np.ndarray): Temperature in degrees Celsius.\n            \n        Returns:\n            np.ndarray: Saturation vapor pressure in Pascals.\n        \"\"\"\n        # Formula gives result in hPa, so multiply by 100 for Pa.\n        return 100.0 * 6.1078 * np.exp((17.2694 * T_C) / (T_C + 237.3))\n\n    def e_s_magnus(T_C):\n        \"\"\"\n        Calculates saturation vapor pressure using the Magnus formula.\n        \n        Args:\n            T_C (np.ndarray): Temperature in degrees Celsius.\n            \n        Returns:\n            np.ndarray: Saturation vapor pressure in Pascals.\n        \"\"\"\n        # Formula gives result in hPa, so multiply by 100 for Pa.\n        return 100.0 * 6.1094 * np.exp((17.625 * T_C) / (T_C + 243.04))\n\n    def saturation_mixing_ratio(e_s, p):\n        \"\"\"\n        Calculates saturation mixing ratio.\n        \n        Args:\n            e_s (np.ndarray): Saturation vapor pressure in Pascals.\n            p (float): Total pressure in Pascals.\n            \n        Returns:\n            np.ndarray: Saturation mixing ratio (kg/kg).\n        \"\"\"\n        # Using a small epsilon to avoid division by zero in the unlikely\n        # case that p is very close to e_s. Problem constraints make this safe.\n        return EPSILON * e_s / (p - e_s + 1e-12)\n\n    test_cases = [\n        (-20.0, 35.0, 111, 100000.0, \"tetens\"),\n        (-40.0, 50.0, 181, 85000.0, \"magnus\"),\n        (-60.0, -20.0, 81, 50000.0, \"tetens\"),\n        (30.0, 60.0, 61, 70000.0, \"magnus\"),\n    ]\n\n    all_results = []\n    \n    for T_C_min, T_C_max, N, p, formula_name in test_cases:\n        # 1. Create temperature grids\n        T_C_grid = np.linspace(T_C_min, T_C_max, N)\n        T_K_grid = T_C_grid + T0\n\n        # 2. Calculate baseline values\n        e_s_base = e_s_baseline(T_K_grid)\n        r_s_base = saturation_mixing_ratio(e_s_base, p)\n\n        # 3. Calculate empirical values\n        if formula_name == \"tetens\":\n            e_s_emp = e_s_tetens(T_C_grid)\n        elif formula_name == \"magnus\":\n            e_s_emp = e_s_magnus(T_C_grid)\n        else:\n            raise ValueError(f\"Unknown formula: {formula_name}\")\n        \n        r_s_emp = saturation_mixing_ratio(e_s_emp, p)\n\n        # 4. Calculate relative errors\n        rel_err_e = np.abs(e_s_emp - e_s_base) / e_s_base\n        # Handle cases where base mixing ratio is zero (at very low T)\n        # to avoid division by zero.\n        rel_err_r = np.divide(np.abs(r_s_emp - r_s_base), r_s_base, \n                              out=np.zeros_like(r_s_base), where=r_s_base!=0)\n\n        # 5. Compute error metrics\n        RMSE_e = np.sqrt(np.mean(rel_err_e**2))\n        MAX_e = np.max(rel_err_e)\n        RMSE_r = np.sqrt(np.mean(rel_err_r**2))\n        MAX_r = np.max(rel_err_r)\n        \n        case_results = [RMSE_e, MAX_e, RMSE_r, MAX_r]\n        all_results.append(case_results)\n\n    # 6. Format the final output string as specified\n    formatted_results = []\n    for res_list in all_results:\n        formatted_list_str = f\"[{','.join([f'{x:.8f}' for x in res_list])}]\"\n        formatted_results.append(formatted_list_str)\n    \n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Numerical schemes used to advect tracers in atmospheric models can sometimes produce unphysical results, such as negative values for water mixing ratios. Correcting these 'overshoots' requires more than simply setting negative values to zero; it demands a physically consistent approach that conserves fundamental quantities. This advanced practice guides you through the design of a correction algorithm that restores non-negativity while preserving both total water and moist enthalpy, a common challenge faced by model developers .",
            "id": "4052466",
            "problem": "Consider a single atmospheric grid cell with dry air and three water species: water vapor, cloud liquid water, and cloud ice. Let the water species be represented by mass mixing ratios relative to dry air, denoted by $r_v$, $r_l$, and $r_i$, respectively, with units $\\mathrm{kg}/\\mathrm{kg}_{\\text{dry}}$. Let the cell temperature be $T$ in $\\mathrm{K}$, the cell height be $z$ in $\\mathrm{m}$, and gravitational acceleration be $g$ in $\\mathrm{m} / \\mathrm{s}^2$. \n\nYou are asked to develop a diagnostic and correction algorithm that detects negative mixing ratios arising from numerical overshoot and produces corrected, nonnegative mixing ratios, while preserving the total water and the total moist enthalpy per unit dry air mass in the cell.\n\nFundamental base and definitions:\n- Define the total water mixing ratio as $r_t = r_v + r_l + r_i$, in $\\mathrm{kg}/\\mathrm{kg}_{\\text{dry}}$.\n- The specific heats at constant pressure are $c_{pd}$ for dry air, $c_{pv}$ for water vapor, $c_l$ for liquid water, and $c_i$ for ice, all in $\\mathrm{J} / (\\mathrm{kg}\\cdot\\mathrm{K})$.\n- The latent heats at a reference temperature (near $T_0 = 273.15\\,\\mathrm{K}$) are $L_{v0}$ for vaporization and $L_{s0}$ for sublimation, both in $\\mathrm{J} / \\mathrm{kg}$. Take these constants as temperature-independent for the purposes of this diagnostic.\n- The moist enthalpy per unit dry air mass is defined by linear superposition (component enthalpies weighted by mixing ratios relative to dry air):\n$$\nE_d = \\left(c_{pd} + r_v c_{pv} + r_l c_l + r_i c_i \\right) T + g z + L_{v0} r_v + L_{s0} r_i \\, .\n$$\n\nDiagnostic and correction objective:\n- Detect whether any of $r_v$, $r_l$, $r_i$ is negative.\n- If all $r_v$, $r_l$, $r_i$ are nonnegative, return them unchanged and ensure $E_d$ is unchanged.\n- If any species is negative, construct corrected mixing ratios $r_v'$, $r_l'$, $r_i'$ such that:\n  1. $r_v' \\ge 0$, $r_l' \\ge 0$, $r_i' \\ge 0$,\n  2. $r_v' + r_l' + r_i' = r_t$ (preserve total water mixing ratio),\n  3. The corrected temperature $T'$ (in $\\mathrm{K}$) is chosen so that the moist enthalpy per unit dry air mass is preserved, $E_d' = E_d$, where\n$$\nE_d' = \\left(c_{pd} + r_v' c_{pv} + r_l' c_l + r_i' c_i \\right) T' + g z + L_{v0} r_v' + L_{s0} r_i' \\, .\n$$\n\nYour algorithm must be derived from the above fundamental base, and must not rely on any ad hoc shortcut formulas not logically derived from these principles. The redistribution of water mass to remove negativity must be explicitly defined so that it provably maintains nonnegativity and $r_t$.\n\nUnits and constants to use in all computations:\n- $c_{pd} = 1004\\,\\mathrm{J}/(\\mathrm{kg}\\cdot\\mathrm{K})$,\n- $c_{pv} = 1850\\,\\mathrm{J}/(\\mathrm{kg}\\cdot\\mathrm{K})$,\n- $c_l = 4186\\,\\mathrm{J}/(\\mathrm{kg}\\cdot\\mathrm{K})$,\n- $c_i = 2106\\,\\mathrm{J}/(\\mathrm{kg}\\cdot\\mathrm{K})$,\n- $L_{v0} = 2.5 \\times 10^6\\,\\mathrm{J}/\\mathrm{kg}$,\n- $L_{s0} = 2.834 \\times 10^6\\,\\mathrm{J}/\\mathrm{kg}$,\n- $g = 9.81\\,\\mathrm{m}/\\mathrm{s}^2$.\n\nDesign the redistribution rule as follows:\n- Let deficits be $d_k = \\max(-r_k, 0)$ for $k \\in \\{v, l, i\\}$, and let $D = d_v + d_l + d_i$.\n- Let positive parts be $p_k = \\max(r_k, 0)$, and $S_{+} = p_v + p_l + p_i$.\n- Set negative $r_k$ to zero, and reduce the positive $p_k$ proportionally to their share so that the total reduction across positives equals $D$:\n$$\nr_k' = \\max\\!\\left(p_k - D \\frac{p_k}{S_{+}},\\,0\\right) \\quad \\text{for } k \\in \\{v, l, i\\} \\, .\n$$\nThis preserves $r_t$ and nonnegativity provided $S_{+} \\ge D$, which holds when $r_t \\ge 0$.\n\nOnce the corrected $r_v'$, $r_l'$, $r_i'$ are obtained, compute $T'$ that preserves $E_d$ by solving for $T'$ from $E_d' = E_d$:\n$$\nT' = \\frac{E_d - g z - L_{v0} r_v' - L_{s0} r_i'}{c_{pd} + r_v' c_{pv} + r_l' c_l + r_i' c_i} \\, .\n$$\n\nTest suite:\nUse the following three test cases (each as a tuple $(r_v, r_l, r_i, T, z)$). All mixing ratios are in $\\mathrm{kg}/\\mathrm{kg}_{\\text{dry}}$, $T$ is in $\\mathrm{K}$, and $z$ is in $\\mathrm{m}$.\n1. $(0.012, 0.0005, 0.0, 280.0, 100.0)$,\n2. $(0.010, -0.0003, 0.0008, 275.0, 500.0)$,\n3. $(-1.0\\times 10^{-5}, 8.0\\times 10^{-6}, 5.0\\times 10^{-6}, 260.0, 0.0)$.\n\nYour program must, for each test case, compute:\n- The corrected mixing ratios $r_v'$, $r_l'$, $r_i'$ in $\\mathrm{kg}/\\mathrm{kg}_{\\text{dry}}$,\n- The corrected temperature $T'$ in $\\mathrm{K}$,\n- A boolean indicating whether any negative mixing ratio was detected in the input,\n- The absolute energy conservation error $|E_d' - E_d|$ in $\\mathrm{J}/\\mathrm{kg\\_dry\\_air}$,\n- The absolute total water conservation error $|r_v' + r_l' + r_i' - r_t|$ in $\\mathrm{kg}/\\mathrm{kg}_{\\text{dry}}$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each test case result should itself be a list ordered as\n$[r_v', r_l', r_i', T', \\text{negative\\_detected}, |E_d' - E_d|, |(r_v' + r_l' + r_i') - r_t|]$.\nFor example, the overall output must look like\n$[[\\dots],[\\dots],[\\dots]]$,\nwith all floats expressed in SI units as specified above and booleans as literal true/false values.",
            "solution": "The user has presented a problem from the domain of computational atmospheric science, specifically focused on a diagnostic and corrective procedure for handling non-physical negative mass mixing ratios that can arise from numerical transport schemes in atmospheric models. The core task is to design an algorithm that restores non-negativity to the mixing ratios of water vapor ($r_v$), cloud liquid water ($r_l$), and cloud ice ($r_i$), while strictly conserving two fundamental physical quantities: the total water mass mixing ratio ($r_t = r_v + r_l + r_i$) and the total moist enthalpy per unit dry air mass ($E_d$).\n\nThe problem is scientifically well-grounded, using a standard, albeit simplified, definition of moist enthalpy. This quantity, sometimes referred to as moist static energy when the geopotential term ($gz$) is included, is a key conserved variable in adiabatic, moist atmospheric processes. The problem specifies a linear superposition model for enthalpy:\n$$\nE_d = \\left(c_{pd} + r_v c_{pv} + r_l c_l + r_i c_i \\right) T + g z + L_{v0} r_v + L_{s0} r_i\n$$\nwhere $c_{pd}$, $c_{pv}$, $c_l$, and $c_i$ are the specific heats at constant pressure for dry air, water vapor, liquid water, and ice, respectively; $L_{v0}$ and $L_{s0}$ are the latent heats of vaporization and sublimation at a reference temperature; $T$ is the temperature; $g$ is the gravitational acceleration; and $z$ is the height. The problem is well-posed, providing all necessary constants, definitions, and a deterministic algorithm for the correction.\n\nThe proposed algorithm consists of a detection step and, if necessary, a two-part correction procedure.\n\n1.  **Detection**: The algorithm first checks if any of the input mixing ratios ($r_v$, $r_l$, $r_i$) are negative. If all are non-negative, the state is considered physically valid, and no correction is applied. The output state ($r_v'$, $r_l'$, $r_i'$, $T'$) is identical to the input state ($r_v$, $r_l$, $r_i$, $T$). This trivially conserves both $r_t$ and $E_d$.\n\n2.  **Correction**: If one or more mixing ratios are negative, a correction is performed in two sequential steps: mass redistribution and temperature adjustment.\n\n    a.  **Water Mass Redistribution**: The goal is to obtain a new set of non-negative mixing ratios ($r_v'$, $r_l'$, $r_i'$) that preserve the total water mass. The problem specifies a proportional redistribution scheme. First, the total deficit ($D$) is calculated by summing the absolute values of all negative mixing ratios: $D = \\sum_k \\max(-r_k, 0)$ for $k \\in \\{v, l, i\\}$. This deficit must be \"borrowed\" from the species with positive mixing ratios. The sum of the positive mixing ratios, $S_{+} = \\sum_k \\max(r_k, 0)$, constitutes the source pool. The negative species are reset to zero. The positive species are reduced proportionally to their contribution to $S_{+}$. The updated value $r_k'$ for a species $k$ with an initial positive mixing ratio $p_k = \\max(r_k, 0)$ is given by $r_k' = p_k - D \\frac{p_k}{S_{+}} = p_k(1 - D/S_{+})$. The complete formula for all species is:\n    $$\n    r_k' = \\max\\left(p_k - D \\frac{p_k}{S_{+}},\\,0\\right)\n    $$\n    This rule guarantees non-negativity ($r_k' \\ge 0$). It also conserves total water. The initial total water is $r_t = \\sum r_k = \\sum (p_k - d_k) = S_{+} - D$. The final total water is $r_t' = \\sum r_k'$. Assuming total water is non-negative ($r_t \\ge 0$), we have $S_{+} \\ge D$, so the term $1 - D/S_{+}$ is non-negative and the $\\max(\\dots, 0)$ is redundant. Thus, $r_t' = \\sum p_k(1 - D/S_{+}) = (1 - D/S_{+}) \\sum p_k = (1 - D/S_{+}) S_{+} = S_{+} - D = r_t$. Total water conservation is therefore mathematically guaranteed by this method, provided $S_{+} \\neq 0$. The case $S_{+} = 0$ implies all initial mixing ratios are non-positive. If $r_t \\ge 0$, then all $r_k$ must be $0$, and the corrected values are also $0$.\n\n    b.  **Temperature Adjustment**: The redistribution of water mass among its phases (vapor, liquid, ice) alters the latent heat content and the total specific heat capacity of the air parcel. To conserve total enthalpy, the temperature must be adjusted. We enforce the conservation constraint $E_d' = E_d$, where $E_d'$ is the enthalpy of the corrected state:\n    $$\n    E_d' = \\left(c_{pd} + r_v' c_{pv} + r_l' c_l + r_i' c_i \\right) T' + g z + L_{v0} r_v' + L_{s0} r_i'\n    $$\n    We set $E_d' = E_d$, where $E_d$ is the enthalpy of the initial, uncorrected state, and solve for the new temperature $T'$. Rearranging the equation yields:\n    $$\n    T' = \\frac{E_d - (g z + L_{v0} r_v' + L_{s0} r_i')}{c_{pd} + r_v' c_{pv} + r_l' c_l + r_i' c_i}\n    $$\n    The denominator represents the effective specific heat of the corrected mixture. Since $c_{pd}  0$ and all other specific heats and corrected mixing ratios ($r_k'$) are non-negative, the denominator is always positive, guaranteeing a unique and physically meaningful solution for $T'$.\n\nBy construction, this two-step procedure produces a physically valid state ($r_k' \\ge 0$) that conserves both total water and moist enthalpy exactly, within the limits of machine precision. The algorithm will now be implemented and applied to the provided test cases.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the atmospheric mixing ratio correction problem.\n    \"\"\"\n    # Define physical constants as per the problem statement.\n    c_pd = 1004.0  # Specific heat of dry air, J/(kg.K)\n    c_pv = 1850.0  # Specific heat of water vapor, J/(kg.K)\n    c_l = 4186.0   # Specific heat of liquid water, J/(kg.K)\n    c_i = 2106.0   # Specific heat of ice, J/(kg.K)\n    L_v0 = 2.5e6   # Latent heat of vaporization, J/kg\n    L_s0 = 2.834e6 # Latent heat of sublimation, J/kg\n    g = 9.81       # Gravitational acceleration, m/s^2\n\n    # Pack constants into numpy arrays for vectorized operations.\n    c_water = np.array([c_pv, c_l, c_i])\n    L_vec = np.array([L_v0, 0.0, L_s0])\n\n    def calculate_enthalpy(r_vec, T, z):\n        \"\"\"\n        Calculates the moist enthalpy per unit dry air mass.\n        \n        Args:\n            r_vec (np.ndarray): Array of mixing ratios [r_v, r_l, r_i].\n            T (float): Temperature in Kelvin.\n            z (float): Height in meters.\n\n        Returns:\n            float: Moist enthalpy in J/kg_dry_air.\n        \"\"\"\n        c_total = c_pd + np.dot(r_vec, c_water)\n        latent_term = np.dot(r_vec, L_vec)\n        potential_term = g * z\n        return c_total * T + potential_term + latent_term\n\n    def process_case(r_v, r_l, r_i, T, z):\n        \"\"\"\n        Applies the diagnostic and correction algorithm to a single grid cell state.\n        \"\"\"\n        r_in = np.array([r_v, r_l, r_i])\n        \n        negative_detected = bool(np.any(r_in  0))\n\n        if not negative_detected:\n            # If all mixing ratios are non-negative, no correction is needed.\n            # Errors are zero by definition.\n            return [r_v, r_l, r_i, T, False, 0.0, 0.0]\n\n        # --- Correction is required ---\n        \n        # 1. Calculate conserved quantities from the initial state.\n        r_t_initial = np.sum(r_in)\n        E_d_initial = calculate_enthalpy(r_in, T, z)\n\n        # 2. Perform water mass redistribution.\n        deficits = np.maximum(-r_in, 0)\n        D_total = np.sum(deficits)\n        \n        positives = np.maximum(r_in, 0)\n        S_plus = np.sum(positives)\n\n        r_out = np.zeros(3)\n        if S_plus  1e-15: # Use a small tolerance to avoid division by zero\n            # This logic assumes r_t = 0, which implies S_plus = D_total\n            factor = 1.0 - D_total / S_plus\n            r_out = positives * factor\n        # If S_plus is zero (or close), all initial r_k = 0. If r_t = 0, then all r_k=0.\n        # r_out remains [0,0,0], which is correct.\n        \n        # 3. Adjust temperature to conserve moist enthalpy.\n        c_total_final = c_pd + np.dot(r_out, c_water)\n        \n        numerator = E_d_initial - (g * z + np.dot(r_out, L_vec))\n        T_final = numerator / c_total_final\n\n        # 4. Calculate final quantities and conservation errors for verification.\n        r_t_final = np.sum(r_out)\n        E_d_final = calculate_enthalpy(r_out, T_final, z)\n        \n        water_conservation_error = abs(r_t_final - r_t_initial)\n        energy_conservation_error = abs(E_d_final - E_d_initial)\n\n        # 5. Return the full set of results.\n        return [r_out[0], r_out[1], r_out[2], T_final, True, energy_conservation_error, water_conservation_error]\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (0.012, 0.0005, 0.0, 280.0, 100.0),\n        (0.010, -0.0003, 0.0008, 275.0, 500.0),\n        (-1.0e-5, 8.0e-6, 5.0e-6, 260.0, 0.0),\n    ]\n\n    # Process all test cases and collect results.\n    results_str_list = []\n    for case in test_cases:\n        result = process_case(*case)\n        # Format the result list as a string without spaces and with lowercase booleans.\n        res_str = (\n            f\"[{result[0]},{result[1]},{result[2]},{result[3]},\"\n            f\"{str(result[4]).lower()},{result[5]},{result[6]}]\"\n        )\n        results_str_list.append(res_str)\n\n    # Print the final output in the exact required format.\n    print(f\"[{','.join(results_str_list)}]\")\n\nsolve()\n```"
        }
    ]
}