{
    "hands_on_practices": [
        {
            "introduction": "This problem revisits the cornerstones of atmospheric thermodynamics for a dry atmosphere. By deriving the dry adiabatic lapse rate and the conservation of potential temperature ($\\theta$), you will solidify your understanding of how temperature changes in vertically moving air parcels. This exercise  is crucial for diagnosing atmospheric static stability, a fundamental concept that dictates the atmosphere's resistance to vertical motion and is the foundation upon which moist processes are built.",
            "id": "4040122",
            "problem": "Consider a hydrostatic, unsaturated (dry) atmosphere composed of an ideal gas representing dry air, as used in Numerical Weather Prediction (NWP) and climate models. Let $p$ denote pressure, $T$ temperature, $\\rho$ density, $z$ geometric height, $g$ gravitational acceleration, $R_d$ the specific gas constant for dry air, and $c_{p,d}$ the specific heat capacity at constant pressure for dry air. Assume a reversible adiabatic displacement of an air parcel (no diabatic heating and negligible viscous dissipation), and neglect kinetic energy changes relative to enthalpy and gravitational potential energy.\n\nStarting from the hydrostatic balance, the ideal gas law, and the first law of thermodynamics expressed in terms of entropy for an ideal gas, perform the following:\n\n1. Derive the vertical temperature gradient (lapse rate) of a dry air parcel undergoing a reversible adiabatic displacement, and express it in terms of $g$ and $c_{p,d}$.\n2. Using the definition of entropy for an ideal gas, derive the material conservation of potential temperature $\\theta$ for a dry adiabatic parcel and show how static stability relates to the sign of $\\partial \\theta / \\partial z$ by connecting the sign of $\\partial \\theta / \\partial z$ to the comparison between the environmental lapse rate and the dry adiabatic lapse rate.\n3. Interpret the dry adiabatic lapse rate in the framework of dry static energy $h_d = c_{p,d} T + g z$ and discuss its link to the moist static energy concept used in moist processes.\n4. Finally, estimate the numerical value of the dry adiabatic lapse rate using $c_{p,d} = 1004 \\, \\mathrm{J \\, kg^{-1} \\, K^{-1}}$ and $g = 9.81 \\, \\mathrm{m \\, s^{-2}}$. Express the final lapse rate in $\\mathrm{K \\, km^{-1}}$ and round your answer to four significant figures.",
            "solution": "The problem is evaluated as valid. It is a well-posed, scientifically grounded problem from classical atmospheric thermodynamics, with a clear, self-contained setup and no contradictions or ambiguities.\n\nThis problem requires the derivation and interpretation of fundamental atmospheric thermodynamic quantities. We begin from the specified first principles: the hydrostatic balance, the ideal gas law, and the first law of thermodynamics.\n\nThe hydrostatic balance equation relates the change in pressure $p$ with geometric height $z$:\n$$ \\frac{dp}{dz} = -\\rho g $$\nwhere $\\rho$ is the density and $g$ is the gravitational acceleration.\n\nThe ideal gas law for dry air is:\n$$ p = \\rho R_d T $$\nwhere $R_d$ is the specific gas constant for dry air and $T$ is the absolute temperature.\n\nThe first law of thermodynamics for a reversible process, expressed per unit mass in terms of specific enthalpy $h$, is:\n$$ T ds = dh - \\frac{1}{\\rho} dp $$\nwhere $s$ is the specific entropy. For an ideal gas, the change in specific enthalpy is $dh = c_{p,d} dT$, where $c_{p,d}$ is the specific heat capacity at constant pressure for dry air. Thus, the first law becomes:\n$$ T ds = c_{p,d} dT - \\frac{1}{\\rho} dp $$\n\nThe problem specifies a reversible adiabatic process for an air parcel. Adiabatic means there is no heat exchange with the surroundings, so $ds = 0$.\n\n1.  **Derivation of the Dry Adiabatic Lapse Rate ($\\Gamma_d$)**\n\nFor a reversible adiabatic process, $ds=0$, so the first law of thermodynamics simplifies to:\n$$ 0 = c_{p,d} dT - \\frac{1}{\\rho} dp $$\n$$ c_{p,d} dT = \\frac{1}{\\rho} dp $$\nThis equation describes the temperature change $dT$ of an air parcel undergoing a change in pressure $dp$. To find the temperature change with height, we use the hydrostatic equation, which relates the pressure change to a change in height for a parcel in hydrostatic equilibrium with its surroundings: $dp = -\\rho g dz$. Substituting this into the thermodynamic equation yields:\n$$ c_{p,d} dT = \\frac{1}{\\rho} (-\\rho g dz) $$\n$$ c_{p,d} dT = -g dz $$\nRearranging this equation gives the rate of change of temperature with height for the adiabatically displaced parcel:\n$$ \\frac{dT}{dz} = -\\frac{g}{c_{p,d}} $$\nThe lapse rate is defined as the rate of temperature *decrease* with height, so it is the negative of this gradient. The dry adiabatic lapse rate, denoted by $\\Gamma_d$, is therefore:\n$$ \\Gamma_d = -\\frac{dT}{dz} = \\frac{g}{c_{p,d}} $$\n\n2.  **Potential Temperature ($\\theta$) and Static Stability**\n\nPotential temperature $\\theta$ is defined as the temperature an air parcel would have if brought adiabatically from its current pressure $p$ and temperature $T$ to a standard reference pressure $p_0$ (usually $1000$ hPa).\n\nTo derive its expression, we return to the simplified first law for an adiabatic process, $c_{p,d} dT = \\frac{1}{\\rho} dp$. Using the ideal gas law to substitute for density, $\\rho = p / (R_d T)$, we get:\n$$ c_{p,d} dT = \\frac{R_d T}{p} dp $$\nSeparating variables gives:\n$$ \\frac{c_{p,d}}{T} dT = \\frac{R_d}{p} dp \\quad \\implies \\quad c_{p,d} d(\\ln T) = R_d d(\\ln p) $$\nFor an adiabatic process, this relationship holds. Integrating from the parcel's state ($p, T$) to the reference state ($p_0, \\theta$) gives:\n$$ \\int_{T}^{\\theta} c_{p,d} d(\\ln T') = \\int_{p}^{p_0} R_d d(\\ln p') $$\n$$ c_{p,d} (\\ln \\theta - \\ln T) = R_d (\\ln p_0 - \\ln p) $$\n$$ \\ln\\left(\\frac{\\theta}{T}\\right) = \\frac{R_d}{c_{p,d}} \\ln\\left(\\frac{p_0}{p}\\right) = \\ln\\left[ \\left(\\frac{p_0}{p}\\right)^{R_d/c_{p,d}} \\right] $$\nTaking the exponential of both sides yields the definition of potential temperature:\n$$ \\theta = T \\left(\\frac{p_0}{p}\\right)^{R_d/c_{p,d}} $$\nFrom the derivation, the quantity $c_{p,d} \\ln T - R_d \\ln p$ is constant during an adiabatic process. This is equivalent to saying that $\\theta$ is a conserved quantity for a dry adiabatic parcel, i.e., $\\frac{D\\theta}{Dt} = 0$, where $\\frac{D}{Dt}$ is the material derivative.\n\nNow, we relate the vertical gradient of potential temperature in the *environment*, $\\frac{\\partial \\theta}{\\partial z}$, to static stability. Stability is determined by comparing the environmental lapse rate, $\\Gamma = -\\frac{\\partial T_e}{\\partial z}$, with the dry adiabatic lapse rate, $\\Gamma_d$.\nLet's find the expression for $\\frac{\\partial \\theta}{\\partial z}$ by differentiating the definition of $\\theta$ with respect to $z$:\n$$ \\frac{\\partial \\theta}{\\partial z} = \\frac{\\partial}{\\partial z} \\left[ T \\left(\\frac{p_0}{p}\\right)^{\\kappa} \\right] \\quad \\text{where } \\kappa = \\frac{R_d}{c_{p,d}} $$\nUsing the product and chain rules:\n$$ \\frac{\\partial \\theta}{\\partial z} = \\frac{\\partial T}{\\partial z} \\left(\\frac{p_0}{p}\\right)^{\\kappa} + T \\cdot \\kappa \\left(\\frac{p_0}{p}\\right)^{\\kappa-1} \\left(-\\frac{p_0}{p^2}\\right) \\frac{\\partial p}{\\partial z} $$\n$$ \\frac{\\partial \\theta}{\\partial z} = \\frac{\\theta}{T} \\frac{\\partial T}{\\partial z} - \\frac{\\theta}{p} \\kappa \\frac{\\partial p}{\\partial z} $$\nSubstituting the environmental lapse rate definition ($\\frac{\\partial T}{\\partial z} = -\\Gamma$) and the hydrostatic equation ($\\frac{\\partial p}{\\partial z} = -\\rho g$):\n$$ \\frac{\\partial \\theta}{\\partial z} = \\frac{\\theta}{T} (-\\Gamma) - \\frac{\\theta}{p} \\kappa (-\\rho g) = \\frac{\\theta}{T} \\left( -\\Gamma + \\frac{T \\kappa \\rho g}{p} \\right) $$\nUsing the ideal gas law $p = \\rho R_d T$, we have $\\frac{T \\rho}{p} = \\frac{1}{R_d}$:\n$$ \\frac{\\partial \\theta}{\\partial z} = \\frac{\\theta}{T} \\left( -\\Gamma + \\frac{\\kappa g}{R_d} \\right) $$\nSubstituting back $\\kappa = \\frac{R_d}{c_{p,d}}$:\n$$ \\frac{\\partial \\theta}{\\partial z} = \\frac{\\theta}{T} \\left( -\\Gamma + \\frac{R_d}{c_{p,d}} \\frac{g}{R_d} \\right) = \\frac{\\theta}{T} \\left( -\\Gamma + \\frac{g}{c_{p,d}} \\right) $$\nRecognizing that $\\Gamma_d = \\frac{g}{c_{p,d}}$, we arrive at the final relationship:\n$$ \\frac{\\partial \\theta}{\\partial z} = \\frac{\\theta}{T} (\\Gamma_d - \\Gamma) $$\nSince $\\theta$ and $T$ are positive absolute temperatures, the sign of $\\frac{\\partial \\theta}{\\partial z}$ is determined by the sign of $(\\Gamma_d - \\Gamma)$.\n-   **Statically Stable:** An upwardly displaced parcel becomes colder and denser than its new surroundings and returns to its original level. This occurs when the environmental lapse rate is less than the adiabatic rate, $\\Gamma < \\Gamma_d$. In this case, $(\\Gamma_d - \\Gamma) > 0$, so $\\frac{\\partial \\theta}{\\partial z} > 0$. Potential temperature increases with height.\n-   **Statically Unstable:** An upwardly displaced parcel remains warmer and less dense than its new surroundings and continues to accelerate upward. This occurs when $\\Gamma > \\Gamma_d$. In this case, $(\\Gamma_d - \\Gamma) < 0$, so $\\frac{\\partial \\theta}{\\partial z} < 0$. Potential temperature decreases with height.\n-   **Statically Neutral:** A displaced parcel has the same temperature as its new surroundings and remains at its new level. This occurs when $\\Gamma = \\Gamma_d$, which implies $\\frac{\\partial \\theta}{\\partial z} = 0$. Potential temperature is constant with height.\n\n3.  **Dry Static Energy ($h_d$) and Moist Static Energy (MSE)**\n\nDry static energy per unit mass, $h_d$, is the sum of specific enthalpy ($c_{p,d} T$) and specific gravitational potential energy ($g z$):\n$$ h_d = c_{p,d} T + g z $$\nFor a parcel of air moving vertically, the rate of change of its dry static energy with height is:\n$$ \\frac{dh_d}{dz} = \\frac{d}{dz}(c_{p,d} T + g z) = c_{p,d} \\frac{dT}{dz} + g $$\nIf the parcel moves adiabatically, its temperature gradient is given by $\\frac{dT}{dz} = -\\Gamma_d = -\\frac{g}{c_{p,d}}$. Substituting this into the equation for the change in $h_d$:\n$$ \\frac{dh_d}{dz} = c_{p,d} \\left(-\\frac{g}{c_{p,d}}\\right) + g = -g + g = 0 $$\nThis shows that $h_d$ is conserved for a parcel undergoing dry adiabatic displacement. This provides a direct physical interpretation: as the parcel rises, its gravitational potential energy ($gz$) increases, and this increase is exactly balanced by a decrease in its enthalpy ($c_{p,d} T$), resulting in no net change in its total static energy.\n\nThis concept is extended to moist processes through moist static energy (MSE), $h_m$. MSE includes the latent heat of vaporization, $L_v$, associated with water vapor in the air, characterized by the specific humidity $q_v$:\n$$ h_m = c_{p,d} T + g z + L_v q_v \\approx h_d + L_v q_v $$\nFor a saturated parcel rising and condensing water vapor, the release of latent heat ($L_v$) warms the parcel, making its lapse rate (the saturated adiabatic lapse rate $\\Gamma_s$) smaller than $\\Gamma_d$. In a saturated adiabatic process, it is the moist static energy, $h_m$, that is approximately conserved. The term $h_d$ is no longer conserved because of the diabatic heating from condensation. The conservation of $h_m$ in moist convection is a cornerstone principle in tropical meteorology and climate studies, analogous to the conservation of $h_d$ in dry dynamics.\n\n4.  **Numerical Estimation of the Dry Adiabatic Lapse Rate**\n\nWe use the derived formula $\\Gamma_d = \\frac{g}{c_{p,d}}$ with the given values:\n-   $g = 9.81 \\, \\mathrm{m \\, s^{-2}}$\n-   $c_{p,d} = 1004 \\, \\mathrm{J \\, kg^{-1} \\, K^{-1}}$\n\nThe units of the calculation are $\\frac{\\mathrm{m \\, s^{-2}}}{\\mathrm{J \\, kg^{-1} \\, K^{-1}}}$. Since $1 \\, \\mathrm{J} = 1 \\, \\mathrm{kg \\, m^2 \\, s^{-2}}$, the denominator's units are $\\mathrm{kg \\, m^2 \\, s^{-2} \\, kg^{-1} \\, K^{-1}} = \\mathrm{m^2 \\, s^{-2} \\, K^{-1}}$. The resulting unit is $\\frac{\\mathrm{m \\, s^{-2}}}{\\mathrm{m^2 \\, s^{-2} \\, K^{-1}}} = \\mathrm{K \\, m^{-1}}$.\n\n$$ \\Gamma_d = \\frac{9.81}{1004} \\, \\mathrm{K \\, m^{-1}} \\approx 0.0097709 \\, \\mathrm{K \\, m^{-1}} $$\nThe problem asks for the result in units of $\\mathrm{K \\, km^{-1}}$. To convert, we multiply by $1000 \\, \\mathrm{m \\, km^{-1}}$:\n$$ \\Gamma_d \\approx 0.0097709 \\, \\frac{\\mathrm{K}}{\\mathrm{m}} \\times 1000 \\, \\frac{\\mathrm{m}}{\\mathrm{km}} = 9.7709 \\, \\mathrm{K \\, km^{-1}} $$\nRounding to four significant figures, we get:\n$$ \\Gamma_d \\approx 9.771 \\, \\mathrm{K \\, km^{-1}} $$\nThe numerical value required is therefore $9.771$.",
            "answer": "$$\\boxed{9.771}$$"
        },
        {
            "introduction": "Building upon the dry framework, we now introduce moisture and its profound impact on atmospheric energy. This practice explores how adding water vapor to an air parcel increases its equivalent potential temperature ($\\theta_e$), a key measure of its total energy content. By quantifying this change , you will gain a concrete understanding of how latent heat contributes to buoyancy and convective potential, a central mechanism in weather phenomena like thunderstorms.",
            "id": "4040114",
            "problem": "Consider an unsaturated, well-mixed atmospheric parcel characterized by temperature $T$, pressure $p$, and specific humidity $q$ (mass of water vapor per unit mass of moist air). Under the pseudoadiabatic assumption (all condensed water is immediately removed and latent heat release remains in the parcel), the Equivalent Potential Temperature $\\theta_e$ is defined as the dry-air potential temperature the parcel would have after hypothetically condensing all of its water vapor and then bringing the parcel dry-adiabatically to a standard reference pressure. The dry-air potential temperature $\\theta$ is given by $\\theta = T \\left(\\frac{p_{0}}{p}\\right)^{\\kappa}$, where $\\kappa = \\frac{R_d}{c_{p,d}}$, $R_d$ is the dry-air gas constant, and $c_{p,d}$ is the dry-air specific heat at constant pressure.\n\nStarting only from the First Law of Thermodynamics for a moist mixture and the definition of moist static energy, show that at fixed $T$ and $p$ the quantity $\\theta_e$ increases when water vapor is added (i.e., demonstrate $\\frac{\\partial \\theta_e}{\\partial q} > 0$ under pseudoadiabatic assumptions). Then, derive a closed-form expression for $\\frac{\\partial \\theta_e}{\\partial q}$ valid at fixed $T$ and $p$, and use it to quantify the increase $\\Delta \\theta_e$ for a small increment $\\Delta q = 2 \\, \\mathrm{g \\, kg^{-1}}$ of water vapor added to a parcel initially at $T=298 \\, \\mathrm{K}$ and $p=1000 \\, \\mathrm{hPa}$. Use $L_{v}(T=298 \\, \\mathrm{K}) = 2.5 \\times 10^{6} \\, \\mathrm{J \\, kg^{-1}}$, $c_{p,d} = 1004 \\, \\mathrm{J \\, kg^{-1} \\, K^{-1}}$, $R_d = 287 \\, \\mathrm{J \\, kg^{-1} \\, K^{-1}}$, and $p_{0} = 1000 \\, \\mathrm{hPa}$. Express your final numerical answer in $\\mathrm{K}$ and round your result to four significant figures.",
            "solution": "We begin with the First Law of Thermodynamics for a closed parcel of moist air written per unit mass of moist air. Neglecting kinetic energy changes and radiative effects, and taking a hydrostatic environment at fixed geopotential height (so that $z$ is constant), the moist static energy $h_m$ is given by\n$$\nh_m = c_{p,d} T + L_v q + g z,\n$$\nwhere $c_{p,d}$ is the dry-air specific heat at constant pressure, $L_v$ is the latent heat of vaporization, $q$ is the specific humidity, and $g$ is the gravitational acceleration. At fixed $z$, changes in $h_m$ arise only from the sensible and latent terms. Under saturated, pseudoadiabatic ascent and condensation, $h_m$ is approximately conserved while condensed water is removed; thus the latent energy $L_v q$ is converted into sensible heat $c_{p,d} T$ retained by the parcel.\n\nIf we hypothetically condense all water vapor present in the parcel at fixed pressure $p$ and remove the condensate (pseudoadiabatic assumption), conservation of moist static energy implies\n$$\nc_{p,d} T' + g z = \\left(c_{p,d} T + L_v q\\right) + g z,\n$$\nso\n$$\nT' = T + \\frac{L_v}{c_{p,d}} q,\n$$\nwhere $T'$ is the parcel temperature after complete condensation of water vapor. The Equivalent Potential Temperature $\\theta_e$ is the dry-air potential temperature the parcel would then have if brought dry-adiabatically to a reference pressure $p_0$. Using the dry-air potential temperature definition,\n$$\n\\theta_e = T' \\left(\\frac{p_0}{p}\\right)^{\\kappa} = \\left(T + \\frac{L_v}{c_{p,d}} q\\right) \\left(\\frac{p_0}{p}\\right)^{\\kappa},\n$$\nwith $\\kappa = \\frac{R_d}{c_{p,d}}$.\n\nAt fixed $T$ and $p$, differentiating $\\theta_e$ with respect to $q$ yields\n$$\n\\frac{\\partial \\theta_e}{\\partial q}\\bigg|_{T,p} = \\left(\\frac{p_0}{p}\\right)^{\\kappa} \\frac{L_v}{c_{p,d}}.\n$$\nBecause $L_v > 0$, $c_{p,d} > 0$, and $\\left(\\frac{p_0}{p}\\right)^{\\kappa} > 0$, it follows that\n$$\n\\frac{\\partial \\theta_e}{\\partial q}\\bigg|_{T,p} > 0,\n$$\nestablishing that $\\theta_e$ increases monotonically with added water vapor at fixed $T$ and $p$ under pseudoadiabatic assumptions.\n\nTo quantify the increase $\\Delta \\theta_e$ for a small increment $\\Delta q$, we use the linearization\n$$\n\\Delta \\theta_e \\approx \\frac{\\partial \\theta_e}{\\partial q}\\bigg|_{T,p} \\, \\Delta q = \\left(\\frac{p_0}{p}\\right)^{\\kappa} \\frac{L_v}{c_{p,d}} \\, \\Delta q.\n$$\nFor the specified state, $T=298 \\, \\mathrm{K}$ and $p=1000 \\, \\mathrm{hPa}$ with $p_0=1000 \\, \\mathrm{hPa}$, so $\\left(\\frac{p_0}{p}\\right)^{\\kappa} = 1$. With $\\Delta q = 2 \\, \\mathrm{g \\, kg^{-1}} = 0.002 \\, \\mathrm{kg \\, kg^{-1}}$, $L_v = 2.5 \\times 10^6 \\, \\mathrm{J \\, kg^{-1}}$, and $c_{p,d} = 1004 \\, \\mathrm{J \\, kg^{-1} \\, K^{-1}}$, we obtain\n$$\n\\Delta \\theta_e = \\frac{2.5 \\times 10^{6}}{1004} \\times 0.002 \\, \\mathrm{K}.\n$$\nCompute the factor:\n$$\n\\frac{2.5 \\times 10^{6}}{1004} = 2{,}490.03984\\ldots,\n$$\nso\n$$\n\\Delta \\theta_e = 2{,}490.03984\\ldots \\times 0.002 = 4.98007968\\ldots \\, \\mathrm{K}.\n$$\nRounded to four significant figures and expressed in $\\mathrm{K}$, the increase is\n$$\n\\Delta \\theta_e = 4.980 \\, \\mathrm{K}.\n$$",
            "answer": "$$\\boxed{4.980}$$"
        },
        {
            "introduction": "This advanced practice bridges theory and application by implementing moist static energy (MSE) as a prognostic variable within a numerical model. You will derive the MSE tendency equation from first principles and then construct a conservative numerical scheme to solve it, verifying that transport processes merely redistribute energy without artificially creating or destroying it. This exercise  is at the heart of modern numerical weather prediction, demonstrating how ensuring energy conservation is critical for the long-term stability and physical realism of climate and weather simulations.",
            "id": "4040089",
            "problem": "Consider a geophysical fluid modeled for Numerical Weather Prediction (NWP) and climate applications, where the thermodynamic state of a moist atmosphere is characterized by the moist static energy per unit mass. Define the moist static energy $m$ as $m = c_{p,d} T + g z + L_v q_v$, where $c_{p,d}$ is the specific heat at constant pressure for dry air, $T$ is temperature, $g$ is gravitational acceleration, $z$ is geometric height, $L_v$ is the latent heat of vaporization, and $q_v$ is the specific humidity of water vapor. Assume a compressible atmosphere but neglect kinetic energy and pressure-work terms in the internal energy budget, and treat turbulence as a Fickian diffusion process. Start from the conservation of energy and mass for moist air and water vapor, and fundamental thermodynamics, and derive a prognostic tendency equation for $m$ that includes advection, diffusion, radiative heating, and irreversible phase-change sinks associated with precipitation fallout. Your derivation must begin from the following fundamental bases without assuming any shortcut relationships:\n- The first law of thermodynamics for a moist atmosphere in terms of specific enthalpy, written materially as $D h / D t$ equals diabatic heating terms plus exchanges due to phase changes, with $h = c_{p,d} T + L_v q_v$ while ignoring kinetic and pressure-work contributions for this problemâ€™s scope.\n- The water vapor mass conservation $D q_v / D t$ equals sources minus sinks due to microphysics and transport.\n- The gravitational potential energy per unit mass $g z$ is transported by the flow, and its budget should be handled consistently with advection and boundary terms.\n- The divergence form of conservation laws in an Eulerian framework, where conservative transport is represented by flux divergence.\n\nAssume that reversible phase changes internal to the air parcel (e.g., condensation balanced by evaporation within the model control volume) convert water vapor to liquid and back without external energy exchange, and that their latent heating contribution cancels out when forming the budget for $m$. By contrast, precipitation fallout that irreversibly removes condensed water from the control volume represents an external sink of moist static energy associated with removal of latent energy $L_v$ tied to the water mass leaving.\n\nYou must then construct a one-dimensional, periodic, finite-volume discretization in the $x$-direction that is conservative by design. The discrete tendency at cell $i$ for $m$ must be assembled purely as flux divergences for advection and diffusion, plus volumetric source terms for radiation and precipitation sinks. Use an upwind scheme for advection and a centered difference for diffusion. The discrete formulation should ensure that, under periodic boundary conditions, the domain-mean tendency due to transport (advection and diffusion) is identically zero to within floating-point roundoff, so that the domain-mean tendency equals the domain-mean of the volumetric sources and sinks. Discuss the implications for conservation.\n\nImplement the discretization numerically on a uniform grid with periodic boundary conditions and evaluate the spatially averaged tendency for three test cases. For each test case, compute the result as the difference between the spatial average of the discrete tendency and the spatial average of the external source-sink terms (radiation plus precipitation sink), expressed in watts per kilogram. This residual quantifies conservation: a value near zero indicates that transport terms are conservative in the mean.\n\nUse the following constants and parameters, written in the specified units:\n- $c_{p,d} = 1004 \\, \\mathrm{J \\, kg^{-1} \\, K^{-1}}$, $L_v = 2.5\\times 10^6 \\, \\mathrm{J \\, kg^{-1}}$, $g = 9.81 \\, \\mathrm{m \\, s^{-2}}$.\n- Domain length $L = 1000 \\, \\mathrm{m}$, number of cells $N_x = 128$, grid spacing $\\Delta x = L / N_x$.\n- Base state $T_0 = 300 \\, \\mathrm{K}$, $q_0 = 0.01$ (dimensionless mass fraction), and a sinusoidal perturbation of amplitude $A = 1000 \\, \\mathrm{J \\, kg^{-1}}$ added to $m$: $m(x) = c_{p,d} T_0 + L_v q_0 + A \\sin\\left(2\\pi x/L\\right)$. Treat $g z$ as horizontally uniform and constant, such that its gradient is zero in the $x$-direction and its contribution to transport vanishes in this one-dimensional setting (no vertical motion).\n\nFor each test case below, assemble the discrete tendency as the sum of the negative divergence of the advective flux and the divergence of the diffusive flux, plus the source terms. Use constant velocity $u$ and diffusivity $K$ as specified.\n\nTest Suite (all results must be expressed as floats in $\\mathrm{W\\,kg^{-1}}$):\n1. Happy path transport-only case: $u = 10 \\, \\mathrm{m \\, s^{-1}}$, $K = 50 \\, \\mathrm{m^2 \\, s^{-1}}$, $Q_{\\mathrm{rad}} = 0 \\, \\mathrm{W \\, kg^{-1}}$, precipitation sink $P(x) = 0 \\, \\mathrm{s^{-1}}$. Compute the residual defined as $\\langle \\partial m / \\partial t \\rangle - \\langle Q_{\\mathrm{rad}} - L_v P \\rangle$, where the angle brackets denote the spatial average over $x$.\n2. Radiation-only case: $u = 0 \\, \\mathrm{m \\, s^{-1}}$, $K = 0 \\, \\mathrm{m^2 \\, s^{-1}}$, $Q_{\\mathrm{rad}} = 2\\times 10^{-3} \\, \\mathrm{W \\, kg^{-1}}$, $P(x) = 0 \\, \\mathrm{s^{-1}}$. Compute the same residual.\n3. Phase-change sink edge case: $u = 0 \\, \\mathrm{m \\, s^{-1}}$, $K = 0 \\, \\mathrm{m^2 \\, s^{-1}}$, $Q_{\\mathrm{rad}} = 0 \\, \\mathrm{W \\, kg^{-1}}$, and a localized precipitation sink $P(x)$ equal to $P_0 = 1\\times 10^{-7} \\, \\mathrm{s^{-1}}$ in the single central cell and zero elsewhere. Compute the same residual.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3]\"), where each result is the float residual in $\\mathrm{W\\,kg^{-1}}$ for the corresponding test case, in the order listed above. Angles are not used. No percentages are involved. All physical units in inputs and outputs must be respected as specified.",
            "solution": "The problem is valid as it is scientifically grounded in atmospheric thermodynamics, well-posed with all necessary parameters and conditions, and objectively stated. It presents a standard but rigorous task in computational fluid dynamics: deriving, discretizing, and testing a conservation law.\n\nThe solution proceeds in three stages: first, the derivation of the prognostic equation for moist static energy ($m$); second, the development of a conservative finite-volume discretization; and third, an explanation of the numerical implementation and the conservation principle being tested.\n\n**1. Derivation of the Prognostic Equation for Moist Static Energy**\n\nThe moist static energy per unit mass, $m$, is defined as:\n$$\nm = c_{p,d} T + g z + L_v q_v\n$$\nwhere $c_{p,d}$ is the specific heat of dry air at constant pressure, $T$ is temperature, $g$ is gravitational acceleration, $z$ is geometric height, $L_v$ is the latent heat of vaporization, and $q_v$ is the specific humidity. The term $c_{p,d} T + gz$ is the dry static energy, and $L_v q_v$ is the latent energy.\n\nThe problem asks for a prognostic tendency equation for $m$. We begin by considering the material derivative, $\\frac{D}{Dt} = \\frac{\\partial}{\\partial t} + \\mathbf{u} \\cdot \\nabla$, which describes the rate of change following an air parcel.\n$$\n\\frac{Dm}{Dt} = \\frac{D}{Dt}(c_{p,d} T) + \\frac{D}{Dt}(gz) + \\frac{D}{Dt}(L_v q_v)\n$$\nAssuming $c_{p,d}$ and $L_v$ are constants, this becomes:\n$$\n\\frac{Dm}{Dt} = c_{p,d} \\frac{DT}{Dt} + g \\frac{Dz}{Dt} + L_v \\frac{Dq_v}{Dt}\n$$\nWe analyze each term based on the fundamental principles provided:\n\n- **The first law of thermodynamics**: For a moist air parcel, ignoring pressure-work and kinetic energy as instructed, the first law governs the change in temperature. The heating sources are diabatic heating (e.g., radiation, denoted $Q_{\\mathrm{rad}}$) and latent heat release from phase changes internal to the parcel. Let $S_{iv}$ be the net rate of condensation (mass of vapor converted to liquid per unit mass of air per unit time). The first law is:\n$$\nc_{p,d} \\frac{DT}{Dt} = Q_{\\mathrm{rad}} + L_v S_{iv}\n$$\nThis equation states that temperature changes are driven by external heating and internal latent heat conversion. The problem statement defines a quantity $h = c_{p,d} T + L_v q_v$ and refers to its material derivative. Combining the first law with water vapor conservation below demonstrates the utility of this grouping.\n\n- **Water vapor conservation**: The specific humidity $q_v$ changes due to internal phase changes ($S_{iv}$) and irreversible removal of water mass through precipitation, denoted by the rate $P$.\n$$\n\\frac{Dq_v}{Dt} = -S_{iv} - P\n$$\n\n- **Potential energy**: The term $g \\frac{Dz}{Dt}$ represents the rate of work done by the parcel against gravity. Since $\\frac{Dz}{Dt} = w$ (vertical velocity), this term is $gw$. For the specified one-dimensional problem in the $x$-direction, there is no vertical motion, so $w=0$. Thus, $\\frac{D(gz)}{Dt} = 0$.\n\nCombining these components:\n$$\n\\frac{Dm}{Dt} = \\left( Q_{\\mathrm{rad}} + L_v S_{iv} \\right) + 0 + L_v \\left( -S_{iv} - P \\right)\n$$\n$$\n\\frac{Dm}{Dt} = Q_{\\mathrm{rad}} + L_v S_{iv} - L_v S_{iv} - L_v P = Q_{\\mathrm{rad}} - L_v P\n$$\nThis result is significant: the term $L_v S_{iv}$ associated with reversible internal phase changes cancels out. This means that $m$ is conserved under moist-adiabatic processes where there is no precipitation. The only source/sink terms for $m$ are external heating/cooling ($Q_{\\mathrm{rad}}$) and the irreversible loss of latent energy due to precipitation ($-L_v P$).\n\nTo obtain the full prognostic equation in an Eulerian framework, we must account for the transport of $m$ by advection and diffusion. The general conservation law for a scalar $\\phi$ in flux form is:\n$$\n\\frac{\\partial \\phi}{\\partial t} + \\nabla \\cdot \\mathbf{F} = S_{\\phi}\n$$\nwhere $\\mathbf{F}$ is the total flux and $S_{\\phi}$ is the net source. Here, the scalar is $m$. The transport flux $\\mathbf{F}$ consists of advection ($\\mathbf{u}m$) and Fickian diffusion ($-K \\nabla m$). The full equation is:\n$$\n\\frac{\\partial m}{\\partial t} + \\nabla \\cdot (\\mathbf{u} m) = \\nabla \\cdot (K \\nabla m) + Q_{\\mathrm{rad}} - L_v P\n$$\nRearranging to isolate the tendency term $\\frac{\\partial m}{\\partial t}$ and specializing to one dimension ($x$) with constant velocity $u$ and diffusivity $K$:\n$$\n\\frac{\\partial m}{\\partial t} = - \\frac{\\partial (u m)}{\\partial x} + \\frac{\\partial}{\\partial x} \\left(K \\frac{\\partial m}{\\partial x}\\right) + Q_{\\mathrm{rad}} - L_v P\n$$\nThis is the final prognostic equation to be discretized. It properly separates the transport processes (advection and diffusion), which are expressed as flux divergences, from the volumetric source/sink terms ($Q_{\\mathrm{rad}}$ and $-L_v P$).\n\n**2. Finite-Volume Discretization**\n\nWe discretize the equation on a uniform grid with $N_x$ cells of width $\\Delta x = L/N_x$. The cells are indexed by $i = 0, \\dots, N_x-1$, and the value $m_i$ represents the average of $m(x)$ over cell $i$. Integrating the prognostic equation over cell $i$ (from $x_{i-1/2}$ to $x_{i+1/2}$):\n$$\n\\int_{x_{i-1/2}}^{x_{i+1/2}} \\frac{\\partial m}{\\partial t} dx = \\int_{x_{i-1/2}}^{x_{i+1/2}} \\left[ -\\frac{\\partial(um)}{\\partial x} + \\frac{\\partial}{\\partial x}\\left(K\\frac{\\partial m}{\\partial x}\\right) \\right] dx + \\int_{x_{i-1/2}}^{x_{i+1/2}} (Q_{\\mathrm{rad}} - L_v P) dx\n$$\nApplying the fundamental theorem of calculus to the flux divergence terms:\n$$\n\\Delta x \\frac{d m_i}{dt} = - \\left[ (um)_{i+1/2} - (um)_{i-1/2} \\right] + \\left[ \\left(K \\frac{\\partial m}{\\partial x}\\right)_{i+1/2} - \\left(K \\frac{\\partial m}{\\partial x}\\right)_{i-1/2} \\right] + (Q_{\\mathrm{rad},i} - L_v P_i) \\Delta x\n$$\nDividing by $\\Delta x$:\n$$\n\\frac{d m_i}{dt} = - \\frac{F_{adv, i+1/2} - F_{adv, i-1/2}}{\\Delta x} + \\frac{F_{diff, i+1/2} - F_{diff, i-1/2}}{\\Delta x} + S_i\n$$\nwhere $F_{adv} = um$ is the advective flux, $F_{diff} = K \\frac{\\partial m}{\\partial x}$ is the diffusive flux (defined as per the equation's structure), and $S_i = Q_{\\mathrm{rad},i} - L_v P_i$ is the cell-averaged source/sink term.\n\n- **Advective Flux (Upwind Scheme)**: The flux at the interface $x_{i+1/2}$ is determined by the value in the \"upwind\" cell. For a constant velocity $u$:\n  - If $u > 0$ (flow is from left to right), $F_{adv, i+1/2} = u m_i$.\n  - If $u  0$ (flow is from right to left), $F_{adv, i+1/2} = u m_{i+1}$.\n  The advection term for $u > 0$ becomes $-u \\frac{m_i - m_{i-1}}{\\Delta x}$. For $u0$, it becomes $-u \\frac{m_{i+1} - m_i}{\\Delta x}$.\n\n- **Diffusive Flux (Centered Scheme)**: The gradient at the interface $x_{i+1/2}$ is approximated using a centered difference:\n  $$\n  F_{diff, i+1/2} = K \\frac{m_{i+1} - m_i}{\\Delta x}\n  $$\n  The diffusion term becomes $\\frac{1}{\\Delta x} \\left( K \\frac{m_{i+1} - m_i}{\\Delta x} - K \\frac{m_i - m_{i-1}}{\\Delta x} \\right) = K \\frac{m_{i+1} - 2m_i + m_{i-1}}{(\\Delta x)^2}$.\n\nThe complete discrete tendency for cell $i$ is the sum of these terms, with indices handled periodically (e.g., $m_{-1} \\equiv m_{N_x-1}$ and $m_{N_x} \\equiv m_0$).\n\n**3. Conservation and Numerical Verification**\n\nA key property of this finite-volume formulation is that the transport terms are discretely conservative. The spatial average of a discrete tendency component, such as advection, is $\\langle A \\rangle = \\frac{1}{N_x} \\sum_{i=0}^{N_x-1} A_i$.\n\nFor the advection term (assuming $u > 0$):\n$$\n\\sum_{i=0}^{N_x-1} A_i = \\sum_{i=0}^{N_x-1} \\left( -u \\frac{m_i - m_{i-1}}{\\Delta x} \\right) = -\\frac{u}{\\Delta x} \\sum_{i=0}^{N_x-1} (m_i - m_{i-1})\n$$\nThis is a telescoping sum. With periodic boundary conditions ($m_{-1} = m_{N_x-1}$), the sum is zero: $(m_0 - m_{N_x-1}) + (m_1 - m_0) + \\dots + (m_{N_x-1} - m_{N_x-2}) = 0$.\n\nFor the diffusion term:\n$$\n\\sum_{i=0}^{N_x-1} D_i = \\sum_{i=0}^{N_x-1} \\left( K \\frac{m_{i+1} - 2m_i + m_{i-1}}{(\\Delta x)^2} \\right) = \\frac{K}{(\\Delta x)^2} \\sum_{i=0}^{N_x-1} \\left[ (m_{i+1} - m_i) - (m_i - m_{i-1}) \\right]\n$$\nThis is also a telescoping sum of differences, which evaluates to zero on a periodic domain.\n\nTherefore, the spatial average of the transport tendencies is identically zero: $\\langle A+D \\rangle = 0$. This implies that the spatially averaged tendency of $m$ must equal the spatially averaged source/sink term:\n$$\n\\left\\langle \\frac{dm}{dt} \\right\\rangle = \\langle S \\rangle = \\langle Q_{\\mathrm{rad}} - L_v P \\rangle\n$$\nThe problem asks to compute the residual $\\left\\langle \\frac{dm}{dt} \\right\\rangle - \\langle Q_{\\mathrm{rad}} - L_v P \\rangle$. Based on this analysis, the residual should be zero to within floating-point precision. This is a powerful verification that the numerical scheme correctly conserves the quantity $m$ during transport, meaning that transport only redistributes $m$ within the domain and does not create or destroy it.\n\nThe numerical implementation will compute the discrete tendency $(\\frac{dm}{dt})_i$ for each cell $i$, average it over the domain to get $\\langle \\frac{dm}{dt} \\rangle$, compute the average source $\\langle S \\rangle$, and find their difference.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem of calculating the conservation residual for moist static energy\n    tendency in a 1D periodic finite-volume model.\n    \"\"\"\n\n    # --- Constants and Parameters ---\n    # Physical constants\n    cp = 1004.0  # J kg^-1 K^-1\n    Lv = 2.5e6   # J kg^-1\n    g = 9.81     # m s^-2 (note: gz term is constant and its gradient is zero)\n\n    # Domain and Grid\n    L = 1000.0   # m\n    Nx = 128     # number of cells\n    dx = L / Nx  # m\n\n    # Initial state parameters\n    T0 = 300.0   # K\n    q0 = 0.01    # dimensionless\n    A = 1000.0  # J kg^-1\n\n    # --- Test Cases ---\n    test_cases = [\n        # Case 1: Happy path transport-only\n        {'u': 10.0, 'K': 50.0, 'Q_rad_val': 0.0, 'P0': 0.0, 'P_loc': 'none'},\n        # Case 2: Radiation-only\n        {'u': 0.0, 'K': 0.0, 'Q_rad_val': 2.0e-3, 'P0': 0.0, 'P_loc': 'none'},\n        # Case 3: Phase-change sink edge case\n        {'u': 0.0, 'K': 0.0, 'Q_rad_val': 0.0, 'P0': 1.0e-7, 'P_loc': 'center'},\n    ]\n\n    # --- Grid and Initial Field Setup ---\n    # x-coordinates of cell centers\n    x = np.arange(Nx) * dx + dx / 2.0 \n    \n    # Initial moist static energy (m) field. The constant gz term has no gradient\n    # and does not affect transport, so it can be omitted without loss of generality\n    # for the tendency calculation. The base value is m_base = cp*T0 + Lv*q0.\n    m_base = cp * T0 + Lv * q0\n    m_initial = m_base + A * np.sin(2 * np.pi * x / L)\n\n    results = []\n\n    for case in test_cases:\n        u = case['u']\n        K = case['K']\n        Q_rad_val = case['Q_rad_val']\n        P0 = case['P0']\n        P_loc = case['P_loc']\n\n        m = np.copy(m_initial)\n\n        # --- Calculate Tendency Components ---\n\n        # 1. Advection Term (dmdt_adv)\n        dmdt_adv = np.zeros(Nx)\n        if u > 0:\n            # Upwind: value at i-1/2 is m[i-1], value at i+1/2 is m[i]\n            # Here, np.roll(m, 1) brings m[i-1] to index i.\n            m_minus_1 = np.roll(m, 1)\n            flux_divergence = (u * m - u * m_minus_1) / dx\n            dmdt_adv = -flux_divergence\n        elif u  0:\n            # Upwind: value at i-1/2 is m[i], value at i+1/2 is m[i+1]\n            # Here, np.roll(m, -1) brings m[i+1] to index i.\n            m_plus_1 = np.roll(m, -1)\n            flux_divergence = (u * m_plus_1 - u * m) / dx\n            dmdt_adv = -flux_divergence\n        \n        # 2. Diffusion Term (dmdt_diff)\n        dmdt_diff = np.zeros(Nx)\n        if K > 0:\n            # Centered difference for 2nd derivative\n            m_plus_1 = np.roll(m, -1)\n            m_minus_1 = np.roll(m, 1)\n            laplacian_m = (m_plus_1 - 2 * m + m_minus_1) / (dx**2)\n            dmdt_diff = K * laplacian_m\n\n        # 3. Source/Sink Terms (Q_rad_array, P_sink)\n        Q_rad_array = np.full(Nx, Q_rad_val)\n        \n        P_sink = np.zeros(Nx)\n        if P_loc == 'center':\n            center_idx = Nx // 2\n            P_sink[center_idx] = P0\n        \n        source_sink_term = Q_rad_array - Lv * P_sink\n\n        # --- Total Tendency and Residual Calculation ---\n        dmdt = dmdt_adv + dmdt_diff + source_sink_term\n\n        # Spatially averaged tendency\n        avg_dmdt = np.mean(dmdt)\n\n        # Spatially averaged source/sink term\n        avg_source_sink_term = np.mean(source_sink_term)\n\n        # Residual: This should be close to zero, representing conservation\n        residual = avg_dmdt - avg_source_sink_term\n        results.append(residual)\n\n    # --- Print Final Output ---\n    # The output format must be exactly \"[result1,result2,result3]\"\n    print(f\"[{','.join(f'{r:.18e}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}