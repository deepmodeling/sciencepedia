{
    "hands_on_practices": [
        {
            "introduction": "大气辐射模型的一个核心挑战是如何高效且准确地处理气体吸收光谱的复杂性。逐线积分（Line-by-Line, LBL）方法虽然精确，但其巨大的计算成本使其难以在气候和天气预报等大规模模型中应用。本练习将引导您从基本的光谱线参数出发，亲手实现 LBL 计算，并将其与广泛应用的快速参数化方案——相关 k 分布（correlated-k）方法进行比较，从而深入理解这两种方法在处理不同光学厚度大气时的性能权衡。",
            "id": "4008290",
            "problem": "考虑使用数值天气预报和气候模拟中常用的两种方法（逐线法和相关k分布法），计算大气柱中一个长波波段的光谱平均透过率。重点是分子谱线的吸收，在计算透过率时忽略发射和散射。光谱带定义为 $[\\nu_1,\\nu_2] = [650,800] \\,\\mathrm{cm}^{-1}$，并以 $\\Delta \\nu = 0.02 \\,\\mathrm{cm}^{-1}$ 的间距进行均匀离散化。吸收物为二氧化碳和水汽，由一小组物理上合理的洛伦兹线型表示，其半宽取决于压力和温度。对于每个大气层，吸收物由柱浓度指定，单位为分子/平方厘米。透过率是无量纲的。所有量必须按其规定的单位处理。\n\n物种和谱线参数：\n- 二氧化碳 (CO$_2$)：两条谱线，中心分别位于 $\\nu_{0,1} = 667 \\,\\mathrm{cm}^{-1}$ 和 $\\nu_{0,2} = 720 \\,\\mathrm{cm}^{-1}$，谱线强度为 $S_1 = 1.0 \\times 10^{-20} \\,\\mathrm{cm}^2$ 和 $S_2 = 3.0 \\times 10^{-21} \\,\\mathrm{cm}^2$。标准条件下的参考半峰半宽为 $\\gamma_{1,\\mathrm{ref}} = 0.08 \\,\\mathrm{cm}^{-1}$ 和 $\\gamma_{2,\\mathrm{ref}} = 0.06 \\,\\mathrm{cm}^{-1}$，温度指数为 $n_{T,1} = 0.75$ 和 $n_{T,2} = 0.75$。\n- 水汽 (H$_2$O)：三条谱线，中心分别位于 $\\nu_{0,3} = 730 \\,\\mathrm{cm}^{-1}$、$\\nu_{0,4} = 750 \\,\\mathrm{cm}^{-1}$ 和 $\\nu_{0,5} = 740 \\,\\mathrm{cm}^{-1}$，谱线强度为 $S_3 = 5.0 \\times 10^{-22} \\,\\mathrm{cm}^2$、$S_4 = 4.0 \\times 10^{-22} \\,\\mathrm{cm}^2$ 和 $S_5 = 1.0 \\times 10^{-22} \\,\\mathrm{cm}^2$。参考半宽为 $\\gamma_{3,\\mathrm{ref}} = 0.12 \\,\\mathrm{cm}^{-1}$、$\\gamma_{4,\\mathrm{ref}} = 0.10 \\,\\mathrm{cm}^{-1}$ 和 $\\gamma_{5,\\mathrm{ref}} = 5.0 \\,\\mathrm{cm}^{-1}$（后者代表一个粗略的类连续谱宽特征），温度指数为 $n_{T,3} = 0.80$、$n_{T,4} = 0.80$ 和 $n_{T,5} = 0.80$。\n\n用于半宽压力和温度缩放的参考条件是 $p_{\\mathrm{ref}} = 1000 \\,\\mathrm{hPa}$ 和 $T_{\\mathrm{ref}} = 296 \\,\\mathrm{K}$。对于压力为 $p$（单位 hPa）和温度为 $T$（单位 K）的给定层，每条谱线的半宽通过以下公式进行缩放：\n$$ \\gamma = \\gamma_{\\mathrm{ref}} \\left(\\frac{p}{p_{\\mathrm{ref}}}\\right) \\left(\\frac{T_{\\mathrm{ref}}}{T}\\right)^{n_T} $$\n使用半宽为 $\\gamma$ 的归一化洛伦兹线型：\n$$ g(\\nu;\\nu_0,\\gamma) = \\frac{1}{\\pi} \\frac{\\gamma}{(\\nu - \\nu_0)^2 + \\gamma^2} $$\n并假设每种物种的单色吸收截面是所有谱线的 $S \\, g(\\nu;\\nu_0,\\gamma)$ 之和。单色光学厚度是每层中各种物种的截面乘以其柱浓度（单位：分子/平方厘米）之和，再对所有层求和；透过率是负光学厚度的指数。波段内的光谱平均透过率是离散网格上的算术平均值。\n\n相关k分布（k-distribution）方法应在跨层完美相关假设下实现，通过根据跨层一致的公共排序对波段单色吸收进行排序，并使用等概率箱来近似波段积分。对累积坐标使用 $M = 16$ 个等权重箱，并假设权重相等，$w_j = 1/M$，其中 $j = 1,\\dots,M$。\n\n测试套件（每个测试用例是一个层的列表，每层由压力 $p$（hPa）、温度 $T$（K）以及柱浓度 $N_{\\mathrm{CO}_2}$ 和 $N_{\\mathrm{H}_2\\mathrm{O}}$（分子/平方厘米）给出）：\n- 用例1（光学薄，单层）：$[(p=200,\\, T=220,\\, N_{\\mathrm{CO}_2}=2.0 \\times 10^{19},\\, N_{\\mathrm{H}_2\\mathrm{O}}=1.0 \\times 10^{19})]$。\n- 用例2（中等光学厚度，单层）：$[(p=600,\\, T=260,\\, N_{\\mathrm{CO}_2}=5.0 \\times 10^{20},\\, N_{\\mathrm{H}_2\\mathrm{O}}=1.0 \\times 10^{20})]$。\n- 用例3（光学厚，单层）：$[(p=1000,\\, T=290,\\, N_{\\mathrm{CO}_2}=2.0 \\times 10^{21},\\, N_{\\mathrm{H}_2\\mathrm{O}}=5.0 \\times 10^{20})]$。\n- 用例4（两层，变化条件）：$[(p=800,\\, T=285,\\, N_{\\mathrm{CO}_2}=1.0 \\times 10^{21},\\, N_{\\mathrm{H}_2\\mathrm{O}}=3.0 \\times 10^{20}),\\, (p=400,\\, T=250,\\, N_{\\mathrm{CO}_2}=5.0 \\times 10^{20},\\, N_{\\mathrm{H}_2\\mathrm{O}}=5.0 \\times 10^{19})]$。\n- 用例5（三层，去相关压力测试）：$[(p=950,\\, T=295,\\, N_{\\mathrm{CO}_2}=1.5 \\times 10^{21},\\, N_{\\mathrm{H}_2\\mathrm{O}}=4.0 \\times 10^{20}),\\, (p=600,\\, T=270,\\, N_{\\mathrm{CO}_2}=7.0 \\times 10^{20},\\, N_{\\mathrm{H}_2\\mathrm{O}}=1.0 \\times 10^{20}),\\, (p=300,\\, T=230,\\, N_{\\mathrm{CO}_2}=3.0 \\times 10^{20},\\, N_{\\mathrm{H}_2\\mathrm{O}}=3.0 \\times 10^{19})]$。\n\n你的程序必须：\n- 在 $[650,800] \\,\\mathrm{cm}^{-1}$ 范围内构建波数网格，间距为 $\\Delta \\nu = 0.02 \\,\\mathrm{cm}^{-1}$。\n- 对于每个测试用例，使用逐线法和在完美相关假设下有 $M = 16$ 个箱的相关k方法计算波段平均透过率。\n- 对于每个测试用例，计算两种波段平均透过率之间的绝对差。\n- 将每个绝对差表示为四舍五入到六位小数的浮点数（无量纲）。\n- 生成单行输出，其中包含按用例1到5顺序排列的结果，形式为逗号分隔的列表并用方括号括起，例如 $[x_1,x_2,x_3,x_4,x_5]$，其中每个 $x_i$ 是用例 $i$ 的四舍五入浮点数。\n\n不允许外部输入；所有常数和参数均如上所述。本问题不涉及角度。物理单位如文中所述；透过率及其差异是无量纲的。",
            "solution": "该问题要求使用两种不同的方法计算和比较光谱平均长波透过率：逐线法（LBL），作为高保真基准；以及相关k（c-k）分布法，这是一种因其在 大气模型中的计算效率而广泛使用的近似方法。将对几种大气廓线进行比较，并报告两种方法结果的绝对差。\n\n首先，我们建立物理和数学框架。感兴趣的光谱带范围从 $\\nu_1 = 650 \\,\\mathrm{cm}^{-1}$ 到 $\\nu_2 = 800 \\,\\mathrm{cm}^{-1}$。该波段被离散化为一个均匀的波数网格 $\\nu_i$。点数 $N_\\nu$ 由 $(\\nu_2 - \\nu_1)/\\Delta\\nu + 1$ 给出，其中 $\\Delta\\nu = 0.02 \\,\\mathrm{cm}^{-1}$，从而得到 $N_\\nu = (800-650)/0.02 + 1 = 7501$ 个点。\n\n计算的核心是单色光学厚度 $\\tau(\\nu)$，它量化了在特定波数 $\\nu$ 处的吸收。对于由多个层组成的大气柱，总光学厚度是各层光学厚度的总和：\n$$\n\\tau(\\nu) = \\sum_l \\tau_l(\\nu)\n$$\n其中 $\\tau_l(\\nu)$ 是层 $l$ 的光学厚度。单层的光学厚度由存在的吸收物种决定。它是所有物种 $s$ 的单色吸收截面 $\\sigma_{s,l}(\\nu)$ 与其柱浓度 $N_{s,l}$ 乘积的总和：\n$$\n\\tau_l(\\nu) = \\sum_s \\sigma_{s,l}(\\nu) N_{s,l}\n$$\n给定物种的吸收截面是其所有单个吸收谱线贡献的总和。对于中心在 $\\nu_0$、强度为 $S$ 的单条谱线，其对截面的贡献由其强度与线型函数 $g(\\nu; \\nu_0, \\gamma)$ 的乘积给出。\n$$\n\\sigma_s(\\nu) = \\sum_{j \\in \\text{lines of } s} S_j g(\\nu; \\nu_{0,j}, \\gamma_j)\n$$\n问题指定了归一化的洛伦兹线型：\n$$\ng(\\nu; \\nu_0, \\gamma) = \\frac{1}{\\pi} \\frac{\\gamma}{(\\nu - \\nu_0)^2 + \\gamma^2}\n$$\n其中 $\\gamma$ 是半峰半宽。此半宽取决于大气层的压力 $p$ 和温度 $T$，并根据参考值（$\\gamma_{\\mathrm{ref}}$，$p_{\\mathrm{ref}} = 1000 \\,\\mathrm{hPa}$，$T_{\\mathrm{ref}} = 296 \\,\\mathrm{K}$）使用以下关系进行缩放：\n$$\n\\gamma = \\gamma_{\\mathrm{ref}} \\left(\\frac{p}{p_{\\mathrm{ref}}}\\right) \\left(\\frac{T_{\\mathrm{ref}}}{T}\\right)^{n_T}\n$$\n指数 $n_T$ 是一个谱线特定参数。\n\n在定义了单色光学厚度 $\\tau(\\nu)$ 之后，我们现在可以详细介绍计算波段平均透过率 $\\bar{\\mathcal{T}}$ 的两种方法。\n\n**1. 逐线法（LBL）**\n\n此方法是对光谱的直接、强力积分。对于我们高分辨率网格上的每个波数 $\\nu_i$，单色透过率 $\\mathcal{T}(\\nu_i)$ 使用比尔-朗伯定律计算，忽略散射和发射：\n$$\n\\mathcal{T}(\\nu_i) = e^{-\\tau(\\nu_i)}\n$$\n然后，波段平均透过率 $\\bar{\\mathcal{T}}_{\\mathrm{LBL}}$ 是这些单色值在整个光谱网格上的算术平均值：\n$$\n\\bar{\\mathcal{T}}_{\\mathrm{LBL}} = \\frac{1}{N_\\nu} \\sum_{i=1}^{N_\\nu} \\mathcal{T}(\\nu_i)\n$$\n\n**2. 相关k（c-k）分布法**\n\nc-k方法旨在通过重排光谱积分来降低计算成本。它不是对波数 $\\nu$ 进行积分，而是对吸收系数 $k$ 进行积分。该方法依赖于这样一个假设：不同大气层之间吸收系数的光谱变化是相关的。问题指定了“完美相关”假设，这意味着从最弱吸收到最强吸收的波数排序对所有层都是相同的。\n\n算法流程如下：\na. 首先，我们为所有 $N_\\nu$ 个网格点计算总柱光学厚度谱 $\\tau(\\nu_i) = \\sum_l \\tau_l(\\nu_i)$。\nb. 将 $\\tau(\\nu_i)$ 的值按升序排序。此排序定义了波数指数的一个排列，该排列作为所有层的公共排序，从而强制执行完美相关假设。\nc. 对于每一层 $l$，其单色光学厚度谱 $\\tau_l(\\nu_i)$ 按照此相同排列进行重排。\nd. 将排序后的光谱（现在代表一个有序的“g空间”）划分为 $M=16$ 个等大小的箱。由于离散化，每个箱将大约包含 $N_\\nu/M$ 个点。\ne. 对于每个箱 $j \\in \\{1, \\dots, M\\}$，我们通过取该箱内重排后的 $\\tau_l$ 值的算术平均值，来计算每层的平均光学厚度 $\\bar{\\tau}_{l,j}$。\nf. 箱 $j$ 的总平均光学厚度是各层之和：\n$$\n\\bar{\\tau}_j = \\sum_l \\bar{\\tau}_{l,j}\n$$\ng. 使用此平均光学厚度为每个箱计算一个单一的透过率值：\n$$\n\\mathcal{T}_j = e^{-\\bar{\\tau}_j}\n$$\nh. 最终的波段平均透过率 $\\bar{\\mathcal{T}}_{\\mathrm{c-k}}$ 是这些箱透过率的加权平均值。由于问题指定了权重为 $w_j=1/M$ 的等权重箱，这便是一个简单的算术平均值：\n$$\n\\bar{\\mathcal{T}}_{\\mathrm{c-k}} = \\frac{1}{M} \\sum_{j=1}^{M} \\mathcal{T}_j\n$$\n\n对于每个测试用例，我们将实现这两种方法，计算 $\\bar{\\mathcal{T}}_{\\mathrm{LBL}}$ 和 $\\bar{\\mathcal{T}}_{\\mathrm{c-k}}$，然后找出绝对差 $|\\bar{\\mathcal{T}}_{\\mathrm{LBL}} - \\bar{\\mathcal{T}}_{\\mathrm{c-k}}|$。这个差值量化了在给定条件下由c-k近似引入的误差。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# from scipy import ...\n\ndef solve():\n    \"\"\"\n    Computes and compares band-mean transmissivity using Line-by-Line (LBL)\n    and Correlated-k (c-k) methods for specified atmospheric cases.\n    \"\"\"\n\n    # --- Constants and Spectral Grid Definition ---\n    NU_1, NU_2 = 650.0, 800.0  # cm^-1\n    D_NU = 0.02  # cm^-1\n    NUM_POINTS = int((NU_2 - NU_1) / D_NU) + 1\n    nu_grid = np.linspace(NU_1, NU_2, NUM_POINTS)\n\n    P_REF = 1000.0  # hPa\n    T_REF = 296.0  # K\n\n    M_BINS = 16  # Number of bins for c-k method\n\n    # --- Species and Line Parameters ---\n    # (nu_0, S, gamma_ref, n_T)\n    line_params_co2 = [\n        (667.0, 1.0e-20, 0.08, 0.75),\n        (720.0, 3.0e-21, 0.06, 0.75),\n    ]\n    line_params_h2o = [\n        (730.0, 5.0e-22, 0.12, 0.80),\n        (750.0, 4.0e-22, 0.10, 0.80),\n        (740.0, 1.0e-22, 5.0, 0.80),\n    ]\n    \n    # --- Test Cases ---\n    # Each case is a list of layers. Each layer is (p, T, N_co2, N_h2o).\n    test_cases = [\n        [(200.0, 220.0, 2.0e19, 1.0e19)],  # Case 1\n        [(600.0, 260.0, 5.0e20, 1.0e20)],  # Case 2\n        [(1000.0, 290.0, 2.0e21, 5.0e20)], # Case 3\n        [\n            (800.0, 285.0, 1.0e21, 3.0e20), \n            (400.0, 250.0, 5.0e20, 5.0e19)\n        ], # Case 4\n        [\n            (950.0, 295.0, 1.5e21, 4.0e20),\n            (600.0, 270.0, 7.0e20, 1.0e20),\n            (300.0, 230.0, 3.0e20, 3.0e19)\n        ], # Case 5\n    ]\n\n    def lorentz_profile(nu, nu_0, gamma):\n        \"\"\"Calculates the normalized Lorentz line shape.\"\"\"\n        return (1.0 / np.pi) * (gamma / ((nu - nu_0)**2 + gamma**2))\n\n    def calculate_results_for_case(layers):\n        \"\"\"\n        Calculates LBL and c-k transmissivities for a given atmospheric case.\n        \"\"\"\n        num_layers = len(layers)\n        optical_depth_layers = np.zeros((num_layers, NUM_POINTS))\n\n        for i, layer in enumerate(layers):\n            p, T, N_co2, N_h2o = layer\n            \n            # --- Calculate CO2 cross-section for the layer ---\n            sigma_co2 = np.zeros(NUM_POINTS)\n            for nu_0, S, gamma_ref, n_T in line_params_co2:\n                gamma = gamma_ref * (p / P_REF) * (T_REF / T)**n_T\n                sigma_co2 += S * lorentz_profile(nu_grid, nu_0, gamma)\n            \n            # --- Calculate H2O cross-section for the layer ---\n            sigma_h2o = np.zeros(NUM_POINTS)\n            for nu_0, S, gamma_ref, n_T in line_params_h2o:\n                gamma = gamma_ref * (p / P_REF) * (T_REF / T)**n_T\n                sigma_h2o += S * lorentz_profile(nu_grid, nu_0, gamma)\n                \n            # --- Calculate layer optical depth ---\n            optical_depth_layers[i, :] = sigma_co2 * N_co2 + sigma_h2o * N_h2o\n\n        # Total column optical depth\n        optical_depth_total = np.sum(optical_depth_layers, axis=0)\n\n        # --- 1. Line-by-Line (LBL) Calculation ---\n        transmissivity_lbl_mono = np.exp(-optical_depth_total)\n        transmissivity_lbl_mean = np.mean(transmissivity_lbl_mono)\n\n        # --- 2. Correlated-k (c-k) Calculation ---\n        # Sort based on total optical depth to enforce perfect correlation\n        sort_indices = np.argsort(optical_depth_total)\n        \n        # Split sorted indices into M bins\n        binned_indices = np.array_split(sort_indices, M_BINS)\n        \n        transmissivity_bins = np.zeros(M_BINS)\n        for j, bin_idx in enumerate(binned_indices):\n            # For each layer, average its optical depth over the current bin\n            avg_od_bin_layers = np.mean(optical_depth_layers[:, bin_idx], axis=1)\n            \n            # Sum layer-averaged ODs to get total bin OD\n            total_avg_od_bin = np.sum(avg_od_bin_layers)\n            \n            # Calculate bin transmissivity\n            transmissivity_bins[j] = np.exp(-total_avg_od_bin)\n\n        # Final c-k transmissivity is the mean of bin transmissivities\n        transmissivity_ck_mean = np.mean(transmissivity_bins)\n        \n        return transmissivity_lbl_mean, transmissivity_ck_mean\n\n    # --- Main Loop for Test Cases ---\n    results = []\n    for case in test_cases:\n        lbl_trans, ck_trans = calculate_results_for_case(case)\n        # Calculate absolute difference and round\n        abs_diff = np.abs(lbl_trans - ck_trans)\n        results.append(round(abs_diff, 6))\n\n    # --- Final Output Formatting ---\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在处理了光谱积分的复杂性之后，下一个关键步骤是求解辐射传输方程（Radiative Transfer Equation, RTE）本身。直接对 RTE 进行离散化时，简单的数值方案在光学厚度较大的情况下可能会引入显著的误差（数值扩散）甚至变得不稳定。本练习旨在通过对比解析解与不同数值格式（如显式、隐式和通量限制格式）的结果，让您亲身体验数值求解器在辐射传输计算中的稳定性和准确性问题，并理解开发稳健算法的必要性。",
            "id": "4008315",
            "problem": "考虑一个总光学厚度为 $\\tau^{\\ast}$ 的平行平面、均匀、等温大气板层，其热源函数 $B$（单位为 $\\mathrm{W}\\,\\mathrm{m}^{-2}\\,\\mathrm{sr}^{-1}$）为常数。没有外部辐射从大气层顶入射（大气层顶的向下强度为零），且下垫面为黑体，其自身的源函数为 $B_{\\mathrm{sfc}}$（单位为 $\\mathrm{W}\\,\\mathrm{m}^{-2}\\,\\mathrm{sr}^{-1}$）。假设纯吸收和发射（无散射），并使用双流求积法和 Eddington 方向余弦 $\\mu_{0} = 1/\\sqrt{3}$ 来近似角度依赖性。\n\n基本原理：\n- 对于纯吸收和发射，沿与天顶方向余弦为 $\\mu$ 的方向的平行平面辐射传输方程为\n$$\n\\mu\\,\\frac{d I(\\tau,\\mu)}{d \\tau} = - I(\\tau,\\mu) + B\n$$\n其中 $I(\\tau,\\mu)$ 是辐射强度，$\\tau$ 是向下的光学深度。\n- 双流近似用在 $\\mu = \\pm \\mu_{0}$ 处的两个离散流和适当的求积权重来代替角度积分。\n\n在这些假设下：\n1. 令 $I^{\\downarrow}(\\tau)$ 表示 $\\mu = +\\mu_{0}$ 时的向下强度，$I^{\\uparrow}(\\tau)$ 表示 $\\mu = -\\mu_{0}$ 时的向上强度。使用辐射传输方程，在边界条件 $I^{\\downarrow}(0) = 0$ 下推导 $I^{\\downarrow}(\\tau)$ 的闭式表达式，并在边界条件 $I^{\\uparrow}(\\tau^{\\ast}) = B_{\\mathrm{sfc}}$ 下推导 $I^{\\uparrow}(\\tau)$ 的闭式表达式。根据这些强度，推导相应的通量\n$$\nF^{\\downarrow}(\\tau) = 2\\pi\\,\\mu_{0}\\,I^{\\downarrow}(\\tau), \\quad F^{\\uparrow}(\\tau) = 2\\pi\\,\\mu_{0}\\,I^{\\uparrow}(\\tau).\n$$\n报告 $F^{\\uparrow}(0)$ 和 $F^{\\downarrow}(\\tau^{\\ast})$ 的具体闭式表达式。\n\n2. 现在，考虑在由 $N$ 个等厚度层（$\\Delta \\tau = \\tau^{\\ast}/N$）组成的均匀网格上，对 $I^{\\downarrow}$ 和 $I^{\\uparrow}$ 的耦合一阶常微分方程组进行数值求解。构建以下三种离散求解器：\n   - 向下传播（从 $\\tau = 0$ 到 $\\tau = \\tau^{\\ast}$）和向上传播（从 $\\tau = \\tau^{\\ast}$ 到 $\\tau = 0$）的前向（显式）欧拉更新：\n     $$\n     I^{\\downarrow}_{n+1} = I^{\\downarrow}_{n} + r\\,\\big(B - I^{\\downarrow}_{n}\\big), \\quad\n     I^{\\uparrow}_{n-1} = I^{\\uparrow}_{n} + r\\,\\big(B - I^{\\uparrow}_{n}\\big),\n     $$\n     其中 $r = \\Delta \\tau / \\mu_{0}$，$n$ 是层指数。\n   - 后向（隐式）欧拉更新：\n     $$\n     I^{\\downarrow}_{n+1} = \\frac{I^{\\downarrow}_{n} + r\\,B}{1 + r}, \\quad\n     I^{\\uparrow}_{n-1} = \\frac{I^{\\uparrow}_{n} + r\\,B}{1 + r}.\n     $$\n   - 一种通量限制的显式更新，通过将 $r$ 限制在区间 $[0,1]$ 内来强制单调性并防止过冲：\n     $$\n     r_{\\mathrm{lim}} = \\min\\big(\\max(r,0),1\\big), \\quad\n     I^{\\downarrow}_{n+1} = I^{\\downarrow}_{n} + r_{\\mathrm{lim}}\\,\\big(B - I^{\\downarrow}_{n}\\big), \\quad\n     I^{\\uparrow}_{n-1} = I^{\\uparrow}_{n} + r_{\\mathrm{lim}}\\,\\big(B - I^{\\uparrow}_{n}\\big).\n     $$\n\n3. 将求解器的数值耗散或偏差定义为数值计算的通量与闭式解通量之间的相对误差（无量纲小数），分别在大气层顶的向上通量 $F^{\\uparrow}(0)$ 和地表的向下通量 $F^{\\downarrow}(\\tau^{\\ast})$ 处进行评估：\n$$\n\\epsilon^{\\uparrow} = \\frac{\\big|F^{\\uparrow}_{\\mathrm{num}}(0) - F^{\\uparrow}_{\\mathrm{exact}}(0)\\big|}{F^{\\uparrow}_{\\mathrm{exact}}(0)}, \\quad\n\\epsilon^{\\downarrow} = \\frac{\\big|F^{\\downarrow}_{\\mathrm{num}}(\\tau^{\\ast}) - F^{\\downarrow}_{\\mathrm{exact}}(\\tau^{\\ast})\\big|}{F^{\\downarrow}_{\\mathrm{exact}}(\\tau^{\\ast})}.\n$$\n将最终的数值耗散或偏差值表示为不带单位的小数。\n\n实现一个完整、可运行的程序，该程序：\n- 使用 $\\mu_{0} = 1/\\sqrt{3}$。\n- 对于下方的每个测试用例，计算并返回与显式欧拉、通量限制显式和后向欧拉求解器相对应的六个相对误差，顺序为先是 $F^{\\uparrow}(0)$ 的误差，然后是 $F^{\\downarrow}(\\tau^{\\ast})$ 的误差。\n\n测试套件：\n- 用例1（中等光学厚度，层源函数与地表源函数相同）：$\\tau^{\\ast} = 1.0$, $N = 2$, $B = 1.0$, $B_{\\mathrm{sfc}} = 1.0$。\n- 用例2（大光学厚度、粗分层，地表较冷）：$\\tau^{\\ast} = 10.0$, $N = 10$, $B = 1.0$, $B_{\\mathrm{sfc}} = 0.5$。\n- 用例3（极大光学厚度、粗分层，地表比层暖）：$\\tau^{\\ast} = 100.0$, $N = 20$, $B = 0.8$, $B_{\\mathrm{sfc}} = 2.0$。\n- 用例4（小光学厚度单层，层发射弱且地表暖）：$\\tau^{\\ast} = 0.5$, $N = 1$, $B = 0.2$, $B_{\\mathrm{sfc}} = 1.0$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含汇总到单个逗号分隔列表中的所有结果，并用方括号括起来。对于每个用例，按此确切顺序输出六个值：$\\epsilon^{\\uparrow}_{\\mathrm{explicit}}$、$\\epsilon^{\\uparrow}_{\\mathrm{limited}}$、$\\epsilon^{\\uparrow}_{\\mathrm{implicit}}$、$\\epsilon^{\\downarrow}_{\\mathrm{explicit}}$、$\\epsilon^{\\downarrow}_{\\mathrm{limited}}$、$\\epsilon^{\\downarrow}_{\\mathrm{implicit}}$。将四个用例的结果连接起来，形成一个扁平列表。例如，一个有效的输出格式为\n$$\n[\\epsilon^{\\uparrow}_{\\mathrm{explicit,1}},\\epsilon^{\\uparrow}_{\\mathrm{limited,1}},\\epsilon^{\\uparrow}_{\\mathrm{implicit,1}},\\epsilon^{\\downarrow}_{\\mathrm{explicit,1}},\\epsilon^{\\downarrow}_{\\mathrm{limited,1}},\\epsilon^{\\downarrow}_{\\mathrm{implicit,1}}, \\ldots].\n$$\n所有报告的值必须是不带单位的小数。",
            "solution": "该问题被评估为有效。它在科学上基于辐射传输原理，问题设定良好，有唯一的解析解可供比较，并且客观地陈述了所有必要的参数和定义。\n\n### 第1部分：解析解\n\n问题始于纯吸收和发射的平行平面辐射传输方程，源函数 $B$ 为常数，采用方向余弦为 $\\mu_0 = 1/\\sqrt{3}$ 的双流近似。光学深度 $\\tau$ 从大气层顶 $\\tau = 0$ 处向下测量。\n\n对于向下流，表示为 $I^{\\downarrow}(\\tau)$，传播方向余弦为 $\\mu = +\\mu_0$。其控制微分方程为：\n$$\n\\mu_0 \\frac{d I^{\\downarrow}(\\tau)}{d \\tau} = -I^{\\downarrow}(\\tau) + B\n$$\n这是一个一阶线性常微分方程，可以整理为：\n$$\n\\frac{d I^{\\downarrow}}{d \\tau} + \\frac{1}{\\mu_0} I^{\\downarrow} = \\frac{B}{\\mu_0}\n$$\n积分因子为 $e^{\\int (1/\\mu_0) d\\tau} = e^{\\tau/\\mu_0}$。方程两边乘以积分因子得到：\n$$\n\\frac{d}{d\\tau} \\left( I^{\\downarrow}(\\tau) e^{\\tau/\\mu_0} \\right) = \\frac{B}{\\mu_0} e^{\\tau/\\mu_0}\n$$\n对 $\\tau$ 积分得到：\n$$\nI^{\\downarrow}(\\tau) e^{\\tau/\\mu_0} = B e^{\\tau/\\mu_0} + C_1\n$$\n其中 $C_1$ 是积分常数。因此，$I^{\\downarrow}(\\tau)$ 的通解为：\n$$\nI^{\\downarrow}(\\tau) = B + C_1 e^{-\\tau/\\mu_0}\n$$\n大气层顶（$\\tau=0$）的边界条件是 $I^{\\downarrow}(0) = 0$。应用此条件：\n$$\n0 = B + C_1 e^{0} \\implies C_1 = -B\n$$\n向下强度的特解为：\n$$\nI^{\\downarrow}(\\tau) = B \\left( 1 - e^{-\\tau/\\mu_0} \\right)\n$$\n\n对于向上流，表示为 $I^{\\uparrow}(\\tau)$，传播方向余弦为 $\\mu = -\\mu_0$。其控制微分方程为：\n$$\n-\\mu_0 \\frac{d I^{\\uparrow}(\\tau)}{d \\tau} = -I^{\\uparrow}(\\tau) + B\n$$\n可以整理为：\n$$\n\\frac{d I^{\\uparrow}}{d \\tau} - \\frac{1}{\\mu_0} I^{\\uparrow} = -\\frac{B}{\\mu_0}\n$$\n积分因子为 $e^{\\int (-1/\\mu_0) d\\tau} = e^{-\\tau/\\mu_0}$。方程变为：\n$$\n\\frac{d}{d\\tau} \\left( I^{\\uparrow}(\\tau) e^{-\\tau/\\mu_0} \\right) = -\\frac{B}{\\mu_0} e^{-\\tau/\\mu_0}\n$$\n对 $\\tau$ 积分得到：\n$$\nI^{\\uparrow}(\\tau) e^{-\\tau/\\mu_0} = B e^{-\\tau/\\mu_0} + C_2\n$$\n$I^{\\uparrow}(\\tau)$ 的通解为：\n$$\nI^{\\uparrow}(\\tau) = B + C_2 e^{\\tau/\\mu_0}\n$$\n边界条件在地表（$\\tau=\\tau^{\\ast}$）处，向上强度由地表源函数给出，$I^{\\uparrow}(\\tau^{\\ast}) = B_{\\mathrm{sfc}}$。应用此条件：\n$$\nB_{\\mathrm{sfc}} = B + C_2 e^{\\tau^{\\ast}/\\mu_0} \\implies C_2 = (B_{\\mathrm{sfc}} - B) e^{-\\tau^{\\ast}/\\mu_0}\n$$\n将 $C_2$ 代回，得到向上强度的特解：\n$$\nI^{\\uparrow}(\\tau) = B + (B_{\\mathrm{sfc}} - B) e^{(\\tau - \\tau^{\\ast})/\\mu_0}\n$$\n\n根据这些强度，我们推导所需的通量 $F(\\tau) = 2\\pi\\mu_0 I(\\tau)$。\n大气层顶的向上通量 $F^{\\uparrow}(0)$，通过计算 $\\tau=0$ 时的 $I^{\\uparrow}(\\tau)$ 得到：\n$$\nI^{\\uparrow}(0) = B + (B_{\\mathrm{sfc}} - B) e^{-\\tau^{\\ast}/\\mu_0} = B(1 - e^{-\\tau^{\\ast}/\\mu_0}) + B_{\\mathrm{sfc}} e^{-\\tau^{\\ast}/\\mu_0}\n$$\n因此，精确的大气层顶向上通量为：\n$$\nF^{\\uparrow}_{\\mathrm{exact}}(0) = 2\\pi \\mu_0 \\left[ B(1 - e^{-\\tau^{\\ast}/\\mu_0}) + B_{\\mathrm{sfc}} e^{-\\tau^{\\ast}/\\mu_0} \\right]\n$$\n地表的向下通量 $F^{\\downarrow}(\\tau^{\\ast})$，通过计算 $\\tau=\\tau^{\\ast}$ 时的 $I^{\\downarrow}(\\tau)$ 得到：\n$$\nI^{\\downarrow}(\\tau^{\\ast}) = B(1 - e^{-\\tau^{\\ast}/\\mu_0})\n$$\n因此，精确的地表向下通量为：\n$$\nF^{\\downarrow}_{\\mathrm{exact}}(\\tau^{\\ast}) = 2\\pi \\mu_0 B(1 - e^{-\\tau^{\\ast}/\\mu_0})\n$$\n\n### 第2部分：数值求解器\n\n连续的光学深度域 $[0, \\tau^{\\ast}]$被离散化为 $N$ 个等厚度的层，每层厚度为 $\\Delta \\tau = \\tau^{\\ast}/N$。这定义了 $N+1$ 个层次，$\\tau_n = n \\Delta \\tau$，$n=0, 1, \\dots, N$。数值解在这些离散层次上提供强度 $I_n$。\n\n常微分方程被离散化。对于向下流，我们使用前向差分来表示导数：\n$$\n\\mu_0 \\frac{I^{\\downarrow}_{n+1} - I^{\\downarrow}_n}{\\Delta\\tau} \\approx -I^{\\downarrow} + B\n$$\n对于向上流，我们使用后向差分：\n$$\n\\mu_0 \\frac{I^{\\uparrow}_{n} - I^{\\uparrow}_{n-1}}{\\Delta\\tau} \\approx -(-I^{\\uparrow} + B) \\implies -\\mu_0 \\frac{I^{\\uparrow}_{n-1} - I^{\\uparrow}_{n}}{\\Delta\\tau} \\approx -I^{\\uparrow} + B\n$$\n这为推进过程提供了一个统一的形式。令 $r = \\Delta\\tau/\\mu_0$。从层 $n$ 到 $n+1$ 的向下更新和从层 $n$ 到 $n-1$ 的向上更新推导如下。\n\n- **前向（显式）欧拉法**：右侧在已知层（向下流为 $n$，向上流为 $n$）进行评估。\n$$\nI^{\\downarrow}_{n+1} - I^{\\downarrow}_n = r(-I^{\\downarrow}_n + B) \\implies I^{\\downarrow}_{n+1} = I^{\\downarrow}_n + r(B - I^{\\downarrow}_n)\n$$\n$$\nI^{\\uparrow}_{n-1} - I^{\\uparrow}_n = r(-I^{\\uparrow}_n + B) \\implies I^{\\uparrow}_{n-1} = I^{\\uparrow}_n + r(B - I^{\\uparrow}_n)\n$$\n该方案简单，但只是有条件稳定的，要求 $r \\le 1$ 才能获得单调解。当 $r > 1$ 时，会产生非物理振荡。\n\n- **后向（隐式）欧拉法**：右侧在未知层（向下流为 $n+1$，向上流为 $n-1$）进行评估。\n$$\nI^{\\downarrow}_{n+1} - I^{\\downarrow}_n = r(-I^{\\downarrow}_{n+1} + B) \\implies I^{\\downarrow}_{n+1}(1+r) = I^{\\downarrow}_n + rB \\implies I^{\\downarrow}_{n+1} = \\frac{I^{\\downarrow}_n + rB}{1+r}\n$$\n$$\nI^{\\uparrow}_{n-1} - I^{\\uparrow}_n = r(-I^{\\uparrow}_{n-1} + B) \\implies I^{\\uparrow}_{n-1}(1+r) = I^{\\uparrow}_n + rB \\implies I^{\\uparrow}_{n-1} = \\frac{I^{\\uparrow}_n + rB}{1+r}\n$$\n该方案对任何 $r > 0$ 都是无条件稳定的。\n\n- **通量限制显式欧拉法**：这是对显式方案的修改，通过限制有效步长来强制稳定性和单调性。\n$$\nr_{\\mathrm{lim}} = \\min(\\max(r, 0), 1)\n$$\n更新方程与显式方案相同，但用 $r_{\\mathrm{lim}}$ 代替 $r$：\n$$\nI^{\\downarrow}_{n+1} = I^{\\downarrow}_n + r_{\\mathrm{lim}}(B - I^{\\downarrow}_n)\n$$\n$$\nI^{\\uparrow}_{n-1} = I^{\\uparrow}_n + r_{\\mathrm{lim}}(B - I^{\\uparrow}_n)\n$$\n如果 $r \\le 1$，该方案与显式方案相同。如果 $r > 1$，它实际上使用 $r_{\\mathrm{lim}}=1$，防止了过冲和不稳定性，但引入了额外的数值耗散。\n\n数值计算步骤如下：\n1. 初始化 $I^{\\downarrow}_{0} = 0$ 和 $I^{\\uparrow}_{N} = B_{\\mathrm{sfc}}$。\n2. 对于向下流，从 $n=0$ 到 $N-1$ 推进，根据 $I^{\\downarrow}_{n}$ 计算 $I^{\\downarrow}_{n+1}$。\n3. 对于向上流，从 $n=N$ 到 $1$ 推进，根据 $I^{\\uparrow}_{n}$ 计算 $I^{\\uparrow}_{n-1}$。\n4. 最终的数值结果是 $I^{\\uparrow}_{\\mathrm{num}}(0) = I^{\\uparrow}_0$ 和 $I^{\\downarrow}_{\\mathrm{num}}(\\tau^{\\ast}) = I^{\\downarrow}_N$。这些用于计算数值通量。\n\n### 第3部分：误差计算与实现\n\n数值误差通过数值通量与精确通量之间的相对差异来量化：\n$$\n\\epsilon^{\\uparrow} = \\frac{\\left|F^{\\uparrow}_{\\mathrm{num}}(0) - F^{\\uparrow}_{\\mathrm{exact}}(0)\\right|}{F^{\\uparrow}_{\\mathrm{exact}}(0)}\n$$\n$$\n\\epsilon^{\\downarrow} = \\frac{\\left|F^{\\downarrow}_{\\mathrm{num}}(\\tau^{\\ast}) - F^{\\downarrow}_{\\mathrm{exact}}(\\tau^{\\ast})\\right|}{F^{\\downarrow}_{\\mathrm{exact}}(\\tau^{\\ast})}\n$$\n实现将遍历每个测试用例。对于每个用例，它将首先使用第1部分的解析公式计算精确通量。然后，对于三个数值求解器中的每一个，它将执行第2部分中描述的推进程序以找到数值通量。最后，它将为每个求解器计算两个相对误差 $\\epsilon^{\\uparrow}$ 和 $\\epsilon^{\\downarrow}$，并按规定将结果汇总到一个列表中。\n对于 $F^{\\uparrow}_{\\mathrm{exact}}(0) = 0$ 或 $F^{\\downarrow}_{\\mathrm{exact}}(\\tau^{\\ast}) = 0$ 的情况，需要对相对误差进行特殊处理，但根据测试数据和物理设置（非零源函数），这种退化情况不会发生。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the radiative transfer problem for a set of test cases,\n    calculating numerical diffusion for three different solvers.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (tau_star, N, B, B_sfc)\n        (1.0, 2, 1.0, 1.0),\n        (10.0, 10, 1.0, 0.5),\n        (100.0, 20, 0.8, 2.0),\n        (0.5, 1, 0.2, 1.0),\n    ]\n\n    all_results = []\n    mu0 = 1.0 / np.sqrt(3.0)\n\n    for tau_star, N, B, B_sfc in test_cases:\n        # 1. Calculate analytical (exact) solutions\n        # exp_term is e^(-tau_star / mu0)\n        exp_term = np.exp(-tau_star / mu0)\n        \n        # Exact intensity at TOA (tau=0) for upwelling flux\n        I_up_exact_0 = B * (1.0 - exp_term) + B_sfc * exp_term\n        # Exact intensity at surface (tau=tau_star) for downwelling flux\n        I_down_exact_tau_star = B * (1.0 - exp_term)\n\n        # Exact fluxes\n        F_up_exact_0 = 2.0 * np.pi * mu0 * I_up_exact_0\n        F_down_exact_tau_star = 2.0 * np.pi * mu0 * I_down_exact_tau_star\n\n        # 2. Setup for numerical solutions\n        delta_tau = tau_star / N\n        r = delta_tau / mu0\n\n        solvers = {\n            \"explicit\": \"explicit\",\n            \"limited\": \"limited\",\n            \"implicit\": \"implicit\"\n        }\n        \n        case_results = []\n\n        # Order of solvers in the output\n        solver_order = [\"explicit\", \"limited\", \"implicit\"]\n        \n        # Store errors for upwelling and downwelling for each solver\n        errors_up = {}\n        errors_down = {}\n\n        for solver_name, solver_type in solvers.items():\n            I_down_num = np.zeros(N + 1)\n            I_up_num = np.zeros(N + 1)\n\n            # Boundary conditions\n            I_down_num[0] = 0.0\n            I_up_num[N] = B_sfc\n\n            # --- Downwelling calculation (march from n=0 to N-1) ---\n            if solver_type == \"explicit\":\n                for n in range(N):\n                    I_down_num[n+1] = I_down_num[n] + r * (B - I_down_num[n])\n            elif solver_type == \"limited\":\n                r_lim = min(max(r, 0.0), 1.0)\n                for n in range(N):\n                    I_down_num[n+1] = I_down_num[n] + r_lim * (B - I_down_num[n])\n            elif solver_type == \"implicit\":\n                for n in range(N):\n                    I_down_num[n+1] = (I_down_num[n] + r * B) / (1.0 + r)\n\n            # --- Upwelling calculation (march from n=N to 1) ---\n            if solver_type == \"explicit\":\n                for n in range(N, 0, -1):\n                    I_up_num[n-1] = I_up_num[n] + r * (B - I_up_num[n])\n            elif solver_type == \"limited\":\n                r_lim = min(max(r, 0.0), 1.0)\n                for n in range(N, 0, -1):\n                    I_up_num[n-1] = I_up_num[n] + r_lim * (B - I_up_num[n])\n            elif solver_type == \"implicit\":\n                for n in range(N, 0, -1):\n                    I_up_num[n-1] = (I_up_num[n] + r * B) / (1.0 + r)\n            \n            # Numerical fluxes\n            F_up_num_0 = 2.0 * np.pi * mu0 * I_up_num[0]\n            F_down_num_tau_star = 2.0 * np.pi * mu0 * I_down_num[N]\n            \n            # 3. Calculate relative errors (numerical diffusion/bias)\n            if F_up_exact_0 != 0:\n                epsilon_up = abs(F_up_num_0 - F_up_exact_0) / F_up_exact_0\n            else:\n                epsilon_up = 0.0 if F_up_num_0 == 0.0 else float('inf')\n\n            if F_down_exact_tau_star != 0:\n                epsilon_down = abs(F_down_num_tau_star - F_down_exact_tau_star) / F_down_exact_tau_star\n            else:\n                epsilon_down = 0.0 if F_down_num_tau_star == 0.0 else float('inf')\n\n            errors_up[solver_name] = epsilon_up\n            errors_down[solver_name] = epsilon_down\n\n        # Assemble results for the case in the specified order\n        for name in solver_order:\n            case_results.append(errors_up[name])\n        for name in solver_order:\n            case_results.append(errors_down[name])\n        \n        all_results.extend(case_results)\n\n    # Final print statement in the exact required format.\n    formatted_results = [f\"{res:.15f}\".rstrip('0').rstrip('.') if '.' in f\"{res:.15f}\" else f\"{res:.0f}\" for res in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "除了吸收和发射，散射过程，特别是云和气溶胶粒子产生的强烈前向散射，对辐射能量收支有重要影响。在简化的辐射模型（如双流近似）中直接处理这种高度各向异性的散射是非常困难的。本练习将向您介绍一种巧妙且实用的解决方案——delta-Eddington 近似，它通过变换光学参数，将问题分解为一个更易于处理的“漫射”部分，从而让您掌握在辐射传输模型中有效处理前向散射峰值的关键技术。",
            "id": "4008326",
            "problem": "您的任务是实现一个用于数值天气预报和气候模拟中短波辐射传输的变换，该变换用于处理强前向散射。该变换称为 delta-Eddington 标度变换，它通过修改光学厚度、单次散射反照率和不对称因子，来移除一个理想化的前向散射峰，并对剩余的“漫射”散射进行重新归一化。您的程序必须为一组测试用例计算变换后的物理量，并按指定格式输出。\n\n首先，从平行平面、单色辐射传输（RT）方程开始，该方程描述了强度 $I$ 作为光学厚度 $\\tau$、方向余弦 $\\mu$ 和方位角积分散射的函数：\n$$\n\\frac{d I(\\mu)}{d \\tau} = - I(\\mu) + \\omega_0 \\int_{-1}^{1} P(\\mu, \\mu') I(\\mu') \\, \\frac{d \\mu'}{2} + S(\\mu)\n$$\n其中 $S(\\mu)$ 代表任何源项（例如，热辐射或直接太阳光束），$\\omega_0$ 是单次散射反照率，而 $P(\\mu, \\mu')$ 是散射相函数。单次散射反照率 $\\omega_0$ 和不对称因子 $g$ 由基本光学性质定义：\n- $\\omega_0 = \\sigma_s / (\\sigma_s + \\sigma_a)$，其中 $\\sigma_s$ 是散射系数，$\\sigma_a$ 是吸收系数。\n- $g = \\langle \\cos \\theta \\rangle$，即相函数的一阶矩，表示散射角 $\\theta$ 的平均余弦。\n- 光学厚度 $\\tau$ 定义为 $\\tau = \\int (\\sigma_s + \\sigma_a) \\, dz$，它是无量纲的。\n\n为了处理前向散射峰，delta-Eddington 方法在概念上将相函数分解为一个集中在前向的狄拉克 delta 峰和一个剩余的漫射部分，其中 delta 峰携带了散射概率的一部分，比例为 $f$。在双流意义下，该峰值对净角度重分布没有贡献；它的存在可以被吸收到控制漫射场的修正（标度变换后）参数中。变换后的参数 $(\\tau', \\omega_0', g')$ 必须保留散射概率和剩余相函数的一阶矩（不对称性），同时减少漫射辐射所经历的有效消光。\n\n您的任务：\n1. 基于上述原理，推导并实现 delta-Eddington 标度变换，通过移除散射中比例为 $f$ 的前向 delta 峰并对剩余部分进行重新归一化，将原始的 $(\\tau, \\omega_0, g)$ 映射到 $(\\tau', \\omega_0', g')$。仅当 $g  0$ 时才应用前向峰值校正；当 $g \\le 0$ 时则跳过（即 $(\\tau', \\omega_0', g') = (\\tau, \\omega_0, g)$），因为非前向不对称性不符合峰值移除模型的假设。所有变换后的量都是无量纲的，并且必须以四舍五入到六位小数的十进制浮点数形式输出。\n2. 实现程序，为下面的每个测试用例计算 $(\\tau', \\omega_0', g')$。物理量 $\\tau$、$\\omega_0$ 和 $g$ 均为无量纲，因此您必须将每个输出值表示为四舍五入到六位小数的浮点数。\n\n测试集：\n- 案例 $1$：$(\\tau, \\omega_0, g) = (2.0, 0.95, 0.85)$\n- 案例 $2$：$(\\tau, \\omega_0, g) = (10.0, 1.0, 0.85)$\n- 案例 $3$：$(\\tau, \\omega_0, g) = (1.0, 0.2, 0.7)$\n- 案例 $4$：$(\\tau, \\omega_0, g) = (0.8, 0.9, 0.0)$\n- 案例 $5$：$(\\tau, \\omega_0, g) = (0.5, 0.999, 0.999)$\n- 案例 $6$：$(\\tau, \\omega_0, g) = (3.0, 0.9, -0.2)$\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，每个测试用例的结果本身是一个包含三个浮点数 $[\\tau', \\omega_0', g']$ 的列表，每个浮点数四舍五入到六位小数。例如，最终打印的行应如下所示：\n$$\n\\text{[[\\tau'_1,\\omega'_1,g'_1],[\\tau'_2,\\omega'_2,g'_2],\\dots]}\n$$\n不应打印任何其他文本。",
            "solution": "根据指定标准检查问题陈述的有效性。\n\n**第 1 步：提取已知条件**\n- 辐射传输方程：$\\frac{d I(\\mu)}{d \\tau} = - I(\\mu) + \\omega_0 \\int_{-1}^{1} P(\\mu, \\mu') I(\\mu') \\, \\frac{d \\mu'}{2} + S(\\mu)$\n- 单次散射反照率：$\\omega_0 = \\sigma_s / (\\sigma_s + \\sigma_a)$\n- 不对称因子：$g = \\langle \\cos \\theta \\rangle$\n- 光学厚度：$\\tau = \\int (\\sigma_s + \\sigma_a) \\, dz$\n- 变换任务：将原始参数 $(\\tau, \\omega_0, g)$ 映射到一组变换后的参数 $(\\tau', \\omega_0', g')$。\n- 变换条件：仅当不对称因子 $g  0$ 时应用变换。如果 $g \\le 0$，则参数保持不变，即 $(\\tau', \\omega_0', g') = (\\tau, \\omega_0, g)$。\n- 测试用例：\n  - 案例 $1$：$(\\tau, \\omega_0, g) = (2.0, 0.95, 0.85)$\n  - 案例 $2$：$(\\tau, \\omega_0, g) = (10.0, 1.0, 0.85)$\n  - 案例 $3$：$(\\tau, \\omega_0, g) = (1.0, 0.2, 0.7)$\n  - 案例 $4$：$(\\tau, \\omega_0, g) = (0.8, 0.9, 0.0)$\n  - 案例 $5$：$(\\tau, \\omega_0, g) = (0.5, 0.999, 0.999)$\n  - 案例 $6$：$(\\tau, \\omega_0, g) = (3.0, 0.9, -0.2)$\n- 输出规范：单行文本，表示一个列表的列表，例如 $[[\\tau'_1, \\omega'_1, g'_1], [\\tau'_2, \\omega'_2, g'_2], \\dots]$，其中每个数值都表示为四舍五入到六位小数的浮点数。\n\n**第 2 步：使用提取的已知条件进行验证**\n- **科学性**：该问题基于 delta-Eddington 近似，这是一种成熟且物理上合理的方​​法，用于大气辐射传输中处理强前向散射相函数。其基本原理和方程是该领域的标准。\n- **适定性**：该问题是适定的。它要求实现一个特定的、已定义的变换。“delta-Eddington”这一名称，结合所提供的物理原理，唯一地确定了变换方程，从而为每组输入得出一个单一、稳定的解。\n- **客观性**：该问题以客观、正式的语言陈述，没有主观或模糊的术语。\n- **缺陷分析**：\n  1. **科学/事实不准确**：无。该问题在科学上和事实上都是正确的。\n  2. **不可形式化/不相关**：该问题与数值模拟中辐射传输的既定主题直接相关，并且在数学上是完全可以形式化的。\n  3. **不完整/矛盾的设置**：该问题是自洽的。将该方法确定为“delta-Eddington”足以让专家推断出变换的具体形式，这在文献中是标准的（Joseph, Wiscombe, and Weinman, 1976）。\n  4. **不切实际/不可行**：$\\tau$、$\\omega_0$ 和 $g$ 的输入值都在物理上现实的范围内。\n  5. **不适定/结构不良**：无。每个测试用例都存在唯一、有意义的解。\n  6. **伪深刻/琐碎**：该问题需要理解并应用一个不平凡的物理近似，使其成为一项实质性任务。\n  7. **超出科学可验证性**：计算是确定性的，可以独立验证。\n\n**第 3 步：结论与行动**\n该问题有效。将提供解决方案。\n\n**推导与算法**\ndelta-Eddington 近似简化了对强前向散射峰的处理。其核心思想是将散射相函数 $p(\\cos\\Theta)$ 近似为前向（$\\Theta=0$ 或 $\\cos\\Theta=1$）的狄拉克 delta 函数与一个各向异性较弱的截断勒让德多项式级数的和。\n\n相函数分解为：\n$$\np(\\cos\\Theta) = 2f \\delta(1-\\cos\\Theta) + (1-f)p'(\\cos\\Theta)\n$$\n这里，$f$ 是散射到前向峰的比例，$p'(\\cos\\Theta)$ 是剩余“漫射”散射的相函数。因子 $2$ 是为了在积分 $\\int_{-1}^{1} \\dots d(\\cos\\Theta)$ 上对 delta 函数进行归一化。$p$ 和 $p'$ 都被归一化，使得它们在 $4\\pi$ 立体角上的积分为 $1$。\n\n将此分解代入积分-微分辐射传输方程（为清晰起见，忽略源项）：\n$$\n\\frac{d I}{d \\tau} = -I + \\omega_0 \\int_{-1}^{1} \\left[ f \\delta(\\mu-\\mu') + \\frac{1-f}{2} p'(\\mu, \\mu') \\right] I(\\mu') d\\mu'\n$$\n对 delta 函数的积分只是提取出 $I(\\mu)$，因此我们得到：\n$$\n\\frac{d I}{d \\tau} = -I + \\omega_0 f I(\\mu) + \\omega_0 (1-f) \\int_{-1}^{1} p'(\\mu, \\mu') I(\\mu') \\frac{d\\mu'}{2}\n$$\n整理各项可得：\n$$\n\\frac{d I}{d \\tau} = -(1 - \\omega_0 f)I(\\mu) + \\omega_0(1-f) \\int_{-1}^{1} p'(\\mu, \\mu') I(\\mu') \\frac{d\\mu'}{2}\n$$\n为了恢复辐射传输方程的标准形式，我们定义一个标度变换后的光学厚度 $\\tau'$，使得 $d\\tau' = (1 - \\omega_0 f)d\\tau$。将方程两边除以 $(1 - \\omega_0 f)$ 得到：\n$$\n\\frac{d I}{d \\tau'} = -I(\\mu) + \\frac{\\omega_0(1-f)}{1 - \\omega_0 f} \\int_{-1}^{1} p'(\\mu, \\mu') I(\\mu') \\frac{d\\mu'}{2}\n$$\n该方程与原始方程形式相同，但使用了一组新的标度变换后的参数：\n1.  **标度变换后的光学厚度**：$\\tau' = (1 - \\omega_0 f)\\tau$\n2.  **标度变换后的单次散射反照率**：$\\omega_0' = \\frac{\\omega_0(1-f)}{1 - \\omega_0 f}$\n\n接下来，我们确定标度变换后的不对称因子 $g'$。不对称因子 $g$ 是相函数的一阶矩。将此定义应用于我们分解后的相函数：\n$$\ng = \\int_{-1}^{1} \\mu p(\\mu) \\frac{d\\mu}{2} = \\int_{-1}^{1} \\mu \\left[ 2f \\delta(1-\\mu) + (1-f)p'(\\mu) \\right] \\frac{d\\mu}{2}\n$$\n$$\ng = f \\cdot 1 + (1-f)g'\n$$\n其中 $g'$ 是标度变换后的相函数 $p'$ 的不对称因子。整理可得 $g'$：\n$$\ng' = \\frac{g - f}{1 - f}\n$$\n最后一步是选择比例 $f$。在标准的 delta-Eddington 近似中，$f$ 被选为 $g^2$。这个选择源自于匹配 Henyey-Greenstein 相函数的矩，其中第 $n$ 阶勒让德矩为 $g^n$，并且与 $M=1$ 时的 delta-M 方法一致。因此，我们设定 $f=g^2$。\n\n将 $f=g^2$ 代入标度变换方程，得到最终的变换关系式，这些关系式仅在 $g  0$ 时应用：\n1.  $\\tau' = (1 - \\omega_0 g^2)\\tau$\n2.  $\\omega_0' = \\frac{\\omega_0(1-g^2)}{1 - \\omega_0 g^2}$\n3.  $g' = \\frac{g - g^2}{1 - g^2} = \\frac{g(1-g)}{(1-g)(1+g)} = \\frac{g}{1+g}$\n\n对于 $g \\le 0$ 的情况，前向峰值假设不成立，不应用变换，因此 $(\\tau', \\omega_0', g') = (\\tau, \\omega_0, g)$。\n\n每个测试用例的算法如下：\n1.  接收输入三元组 $(\\tau, \\omega_0, g)$。\n2.  检查是否 $g  0$。\n3.  如果 $g  0$，使用上面推导的公式计算 $\\tau'$, $\\omega_0'$ 和 $g'$。\n4.  如果 $g \\le 0$，设置 $\\tau' = \\tau$, $\\omega_0' = \\omega_0$, $g' = g$。\n5.  返回结果三元组 $(\\tau', \\omega_0', g')$，每个分量都四舍五入到六位小数。\n最终输出将是这些结果的聚合，格式为指定的列表的列表。",
            "answer": "```python\nimport numpy as np\nfrom typing import List, Tuple\n\ndef delta_eddington_scaling(tau: float, omega0: float, g: float) - Tuple[float, float, float]:\n    \"\"\"\n    Computes the delta-Eddington scaled radiative properties.\n\n    The transformation is applied only if the asymmetry parameter g is positive,\n    as the method is designed to handle forward-peaked scattering.\n\n    Args:\n        tau (float): Original optical thickness (dimensionless).\n        omega0 (float): Original single-scattering albedo (dimensionless).\n        g (float): Original asymmetry parameter (dimensionless).\n\n    Returns:\n        A tuple (tau_prime, omega0_prime, g_prime) containing the\n        transformed, dimensionless optical properties.\n    \"\"\"\n    if g  0:\n        # The choice f = g^2 is standard for the delta-Eddington approximation.\n        g_squared = np.power(g, 2)\n        \n        # Denominator for tau' and omega0' scaling factors\n        # This term is (1 - omega0 * f)\n        scaling_denominator = 1.0 - omega0 * g_squared\n\n        # Handle the edge case where the denominator might be zero, which can occur\n        # if omega0=1 and g=1. Physically, this represents pure forward scattering.\n        if scaling_denominator == 0:\n            # In this limit, tau' - 0, omega0' - 1, g' - 0.5\n            # However, for numerical stability with floating point a small\n            # non-zero value is better than a direct check for 0.\n            # The test cases do not hit this exact singularity.\n            tau_prime = 0.0\n            omega0_prime = 1.0\n        else:\n            # Scaled optical thickness\n            tau_prime = tau * scaling_denominator\n            \n            # Scaled single-scattering albedo\n            omega0_prime = (omega0 * (1.0 - g_squared)) / scaling_denominator\n        \n        # Scaled asymmetry parameter\n        g_prime = g / (1.0 + g)\n        \n        return tau_prime, omega0_prime, g_prime\n    else:\n        # If g = 0, the transformation is not applied.\n        return tau, omega0, g\n\ndef solve():\n    \"\"\"\n    Processes the test suite for the delta-Eddington transformation and\n    prints the results in the specified format.\n    \"\"\"\n    # Test Suite from the problem statement\n    test_cases = [\n        # (tau, omega0, g)\n        (2.0, 0.95, 0.85),\n        (10.0, 1.0, 0.85),\n        (1.0, 0.2, 0.7),\n        (0.8, 0.9, 0.0),\n        (0.5, 0.999, 0.999),\n        (3.0, 0.9, -0.2),\n    ]\n\n    all_results_str: List[str] = []\n\n    for case in test_cases:\n        tau, omega0, g = case\n        \n        # Calculate the transformed parameters\n        tau_prime, omega0_prime, g_prime = delta_eddington_scaling(tau, omega0, g)\n\n        # Format each number to six decimal places\n        formatted_numbers = [\n            f\"{tau_prime:.6f}\",\n            f\"{omega0_prime:.6f}\",\n            f\"{g_prime:.6f}\"\n        ]\n        \n        # Create the string for the inner list, e.g., \"[0.123456,0.234567,0.345678]\"\n        inner_list_str = f\"[{','.join(formatted_numbers)}]\"\n        all_results_str.append(inner_list_str)\n\n    # Join the inner list strings and wrap with the outer list brackets\n    # Final format: \"[[...],[...],...]\"\n    final_output = f\"[{','.join(all_results_str)}]\"\n    \n    print(final_output)\n\nsolve()\n```"
        }
    ]
}