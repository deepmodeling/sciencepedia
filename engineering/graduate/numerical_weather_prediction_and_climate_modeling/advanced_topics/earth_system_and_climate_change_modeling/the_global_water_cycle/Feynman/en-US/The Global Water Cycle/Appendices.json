{
    "hands_on_practices": [
        {
            "introduction": "The principle of mass conservation provides a powerful framework for understanding the global water cycle. At the largest scale, under steady-state climate conditions, the total amount of water evaporating from the Earth's surface must equal the total amount returning as precipitation. This exercise  provides a foundational hands-on application of this principle, allowing you to perform a first-order estimate of oceanic evaporation—the primary driver of the global water cycle—and quantify the sensitivity of this estimate to assumptions about continental processes. This practice hones essential skills in applying conservation laws and evaluating the impact of simplifying assumptions in large-scale environmental modeling.",
            "id": "4100576",
            "problem": "In Numerical Weather Prediction (NWP) and climate modeling, closure of the global hydrological cycle follows from conservation of water substance in the atmosphere. Consider a statistically steady climate in which the long-term, vertically integrated atmospheric water storage tendency is negligible, so that the global, area-mean evaporation equals the global, area-mean precipitation. Let the Earth’s ocean area fraction be $f_{o}$ and the land area fraction be $f_{\\ell} = 1 - f_{o}$. Let the long-term, area-mean precipitation over the entire globe be $P$ (defined per unit area of the Earth’s surface). Let the long-term, area-mean evaporation over ocean and land (each defined per unit area of their respective surfaces) be $E_{o}$ and $E_{\\ell}$, respectively. The global, area-mean evaporation then satisfies $E = f_{o} E_{o} + f_{\\ell} E_{\\ell}$, and global water-mass conservation at steady state implies $E = P$.\n\nGiven observational estimates $P = 2.7$ mm day$^{-1}$ and $f_{o} = 0.71$, do the following:\n1) Using only the fundamental mass-conservation statement described above and area-weighting, derive and compute the implied $E_{o}$ under the assumption of negligible continental evaporation, $E_{\\ell} \\approx 0$.\n2) Quantify the absolute error in $E_{o}$ that arises if, in reality, the continental evaporation is $E_{\\ell} = 0.5$ mm day$^{-1}$.\n\nExpress both requested quantities in mm day$^{-1}$. Round your answer to four significant figures.",
            "solution": "The fundamental base is the conservation of water substance applied to the global atmosphere under steady-state conditions. The vertically integrated atmospheric water budget, averaged over a sufficiently long time, reduces to equality of global, area-mean evaporation and precipitation:\n$$\nE = P.\n$$\nHere $E$ denotes the global, area-mean evaporation (per unit area of the Earth’s surface) and $P$ is the global, area-mean precipitation (per unit area of the Earth’s surface). Because the surface is partitioned into ocean and land with respective area fractions $f_{o}$ and $f_{\\ell} = 1 - f_{o}$, the global mean of evaporation is the area-weighted mean of the component fluxes:\n$$\nE = f_{o} E_{o} + f_{\\ell} E_{\\ell}.\n$$\nCombining this with mass conservation gives\n$$\nP = f_{o} E_{o} + f_{\\ell} E_{\\ell}.\n$$\n\nPart 1: Negligible continental evaporation. If $E_{\\ell} \\approx 0$, then\n$$\nP = f_{o} E_{o} \\quad \\Rightarrow \\quad E_{o} = \\frac{P}{f_{o}}.\n$$\nWith $P = 2.7$ mm day$^{-1}$ and $f_{o} = 0.71$,\n$$\nE_{o}^{(0)} = \\frac{2.7}{0.71} \\ \\text{mm day}^{-1}.\n$$\n\nPart 2: Absolute error when $E_{\\ell} \\neq 0$. If the actual continental evaporation is $E_{\\ell} = 0.5$ mm day$^{-1}$, then the correct ocean evaporation that satisfies the budget is\n$$\nE_{o}^{(\\text{true})} = \\frac{P - f_{\\ell} E_{\\ell}}{f_{o}},\n$$\nobtained by solving $P = f_{o} E_{o} + f_{\\ell} E_{\\ell}$ for $E_{o}$. The absolute error from assuming $E_{\\ell} \\approx 0$ is\n$$\n\\Delta E_{o} = \\left| E_{o}^{(0)} - E_{o}^{(\\text{true})} \\right|\n= \\left| \\frac{P}{f_{o}} - \\frac{P - f_{\\ell} E_{\\ell}}{f_{o}} \\right|\n= \\frac{f_{\\ell} E_{\\ell}}{f_{o}}.\n$$\nUsing $f_{o} = 0.71$, $f_{\\ell} = 1 - 0.71 = 0.29$, and $E_{\\ell} = 0.5$ mm day$^{-1}$,\n$$\n\\Delta E_{o} = \\frac{0.29 \\times 0.5}{0.71} \\ \\text{mm day}^{-1}.\n$$\n\nNumerical evaluations:\n- Implied ocean evaporation with $E_{\\ell} \\approx 0$:\n$$\nE_{o}^{(0)} = \\frac{2.7}{0.71} \\approx 3.802816901\\ \\text{mm day}^{-1}.\n$$\n- Absolute error when $E_{\\ell} = 0.5$ mm day$^{-1}$:\n$$\n\\Delta E_{o} = \\frac{0.145}{0.71} = \\frac{29}{142} \\approx 0.204225352\\ \\text-mm day}^{-1}.\n$$\n\nRounding both quantities to four significant figures and expressing in mm day$^{-1}$ yields $E_{o}^{(0)} \\approx 3.803$ mm day$^{-1}$ and $\\Delta E_{o} \\approx 0.2042$ mm day$^{-1}$.",
            "answer": "$$\\boxed{\\begin{pmatrix}3.803 & 0.2042\\end{pmatrix}}$$"
        },
        {
            "introduction": "Having established the global balance, we now zoom in on a critical component: the evaporation flux, $E$. In numerical models, this flux isn't a simple number but is calculated from complex physical interactions at the land-atmosphere interface. This practice  guides you through the derivation of the celebrated Penman-Monteith equation, a cornerstone of hydrology and climate science that combines the principles of energy balance and aerodynamic transfer to model latent heat flux from vegetated surfaces. Mastering this derivation provides deep insight into how land surface models represent the crucial process of evapotranspiration, a key linkage in the global water and energy cycles.",
            "id": "4100548",
            "problem": "A well-watered vegetated canopy exchanges energy with the atmosphere via sensible heat flux and latent heat flux. Consider a horizontally homogeneous canopy layer for which the available energy is $A$, and assume steady state so that the canopy energy balance is $A = H + \\lambda E$, where $H$ is the sensible heat flux and $\\lambda E$ is the latent heat flux. The sensible heat flux can be represented by bulk transfer with an aerodynamic resistance $r_a$ as $H = \\rho c_p g_a (T_s - T_a)$, where $\\rho$ is air density, $c_p$ is the specific heat capacity of air at constant pressure, $g_a = 1/r_a$ is the aerodynamic conductance, $T_s$ is the canopy surface temperature, and $T_a$ is the air temperature. Let stomatal resistance $r_s$ limit only the water-vapor pathway, with stomatal conductance $g_s = 1/r_s$, and assume the aerodynamic resistance is the same for heat and water vapor. The vapor pressure at the canopy surface is approximated as the saturation vapor pressure at $T_s$, linearized about $T_a$ so that $e_s - e_a \\approx D + \\Delta (T_s - T_a)$, where $e_s$ is the saturation vapor pressure at the surface, $e_a$ is the ambient vapor pressure, $D$ is the ambient humidity deficit, and $\\Delta$ is the slope of the saturation vapor pressure curve with respect to temperature. Use the psychrometric constant $\\gamma$ to relate heat and mass transfer under constant pressure.\n\nStarting from these physical statements and definitions, derive an expression for the latent heat flux $\\lambda E$ in terms of $A$, $\\Delta$, $\\gamma$, $\\rho$, $c_p$, $g_a$, $g_s$, and $D$ without introducing any additional empirical formulas. Then evaluate $\\lambda E$ for a well-watered canopy with the following values: $A = 400$ W m$^{-2}$, $\\Delta = 0.2$ kPa K$^{-1}$, $\\gamma = 0.066$ kPa K$^{-1}$, $r_a = 50$ s m$^{-1}$, $r_s = 100$ s m$^{-1}$, $D = 1$ kPa, $\\rho = 1.2$ kg m$^{-3}$, and $c_p = 1005$ J kg$^{-1}$ K$^{-1}$. Express the final answer for $\\lambda E$ in W m$^{-2}$ and round your result to four significant figures.",
            "solution": "The problem requires the derivation of an expression for the latent heat flux, $\\lambda E$, and its subsequent numerical evaluation. The derivation is based on combining the energy balance equation with bulk transfer formulas for sensible and latent heat fluxes. This procedure results in the well-known Penman-Monteith equation.\n\nThe physical system is described by the following set of equations:\nThe energy balance at the canopy surface is given by:\n$$ A = H + \\lambda E \\quad (1) $$\nwhere $A$ is the available energy, $H$ is the sensible heat flux, and $\\lambda E$ is the latent heat flux.\n\nThe sensible heat flux is defined by the bulk aerodynamic formula:\n$$ H = \\rho c_p g_a (T_s - T_a) \\quad (2) $$\nwhere $\\rho$ is the air density, $c_p$ is the specific heat of air at constant pressure, $g_a = 1/r_a$ is the aerodynamic conductance, $T_s$ is the canopy surface temperature, and $T_a$ is the ambient air temperature.\n\nThe latent heat flux, representing the energy used for evapotranspiration, is described by a similar bulk transfer formula. The total resistance to water vapor transport is the sum of the aerodynamic resistance, $r_a$, and the surface (stomatal) resistance, $r_s$. Using the psychrometric constant, $\\gamma$, to relate the vapor pressure gradient to energy flux, the latent heat flux is given by:\n$$ \\lambda E = \\frac{\\rho c_p}{\\gamma} \\frac{1}{r_a + r_s} (e_s - e_a) \\quad (3) $$\nwhere $e_s$ is the vapor pressure at the surface and $e_a$ is the ambient vapor pressure.\n\nThe vapor pressure at the surface, $e_s$, is assumed to be the saturation vapor pressure at the surface temperature $T_s$. The relationship between the vapor pressure difference and the temperature difference is linearized as:\n$$ e_s - e_a = D + \\Delta (T_s - T_a) \\quad (4) $$\nwhere $D$ is the ambient vapor pressure deficit and $\\Delta$ is the slope of the saturation vapor pressure curve at the ambient temperature.\n\nThe derivation aims to find an expression for $\\lambda E$ that does not depend on the unknown surface temperature $T_s$. This is achieved by combining the equations above to eliminate $T_s$.\n\nFrom equation ($2$), we can express the surface-air temperature difference, $T_s - T_a$, as:\n$$ T_s - T_a = \\frac{H}{\\rho c_p g_a} = \\frac{r_a H}{\\rho c_p} \\quad (5) $$\n\nNext, we rearrange equation ($3$) and substitute equation ($4$) to find another expression for $T_s - T_a$:\n$$ \\lambda E = \\frac{\\rho c_p}{\\gamma (r_a + r_s)} [D + \\Delta (T_s - T_a)] $$\nSolving for $T_s - T_a$:\n$$ \\frac{\\gamma \\lambda E (r_a + r_s)}{\\rho c_p} = D + \\Delta (T_s - T_a) $$\n$$ \\Delta (T_s - T_a) = \\frac{\\gamma \\lambda E (r_a + r_s)}{\\rho c_p} - D $$\n$$ T_s - T_a = \\frac{\\gamma \\lambda E (r_a + r_s)}{\\Delta \\rho c_p} - \\frac{D}{\\Delta} \\quad (6) $$\n\nNow, we equate the two expressions for $T_s - T_a$ from equations ($5$) and ($6$):\n$$ \\frac{r_a H}{\\rho c_p} = \\frac{\\gamma \\lambda E (r_a + r_s)}{\\Delta \\rho c_p} - \\frac{D}{\\Delta} $$\nTo eliminate $\\rho c_p$ and $\\Delta$ from the denominators, we multiply the entire equation by $\\Delta \\rho c_p$:\n$$ \\Delta r_a H = \\gamma \\lambda E (r_a + r_s) - \\rho c_p D $$\n\nThe final step is to eliminate $H$ using the energy balance equation ($1$), $H = A - \\lambda E$:\n$$ \\Delta r_a (A - \\lambda E) = \\gamma \\lambda E (r_a + r_s) - \\rho c_p D $$\nExpanding the terms:\n$$ \\Delta r_a A - \\Delta r_a \\lambda E = \\gamma r_a \\lambda E + \\gamma r_s \\lambda E - \\rho c_p D $$\nNow, we group all terms containing $\\lambda E$ on one side of the equation:\n$$ \\Delta r_a A + \\rho c_p D = \\Delta r_a \\lambda E + \\gamma r_a \\lambda E + \\gamma r_s \\lambda E $$\n$$ \\Delta r_a A + \\rho c_p D = \\lambda E (\\Delta r_a + \\gamma r_a + \\gamma r_s) $$\n$$ \\Delta r_a A + \\rho c_p D = \\lambda E [\\Delta r_a + \\gamma (r_a + r_s)] $$\n\nFinally, solving for $\\lambda E$:\n$$ \\lambda E = \\frac{\\Delta r_a A + \\rho c_p D}{\\Delta r_a + \\gamma (r_a + r_s)} $$\nTo express this in terms of the conductances $g_a = 1/r_a$ and $g_s = 1/r_s$ as requested, we can divide the numerator and denominator by $r_a$:\n$$ \\lambda E = \\frac{\\Delta A + \\frac{\\rho c_p D}{r_a}}{\\Delta + \\gamma \\frac{r_a+r_s}{r_a}} $$\nSubstituting $1/r_a = g_a$ and $(r_a+r_s)/r_a = 1 + r_s/r_a = 1 + g_a/g_s$:\n$$ \\lambda E = \\frac{\\Delta A + \\rho c_p D g_a}{\\Delta + \\gamma (1 + g_a/g_s)} $$\nThis is the derived expression for the latent heat flux.\n\nNow, we evaluate this expression using the provided numerical values:\n-   Available energy, $A = 400 \\text{ W m}^{-2}$\n-   Slope of saturation vapor pressure curve, $\\Delta = 0.2 \\text{ kPa K}^{-1}$\n-   Psychrometric constant, $\\gamma = 0.066 \\text{ kPa K}^{-1}$\n-   Aerodynamic resistance, $r_a = 50 \\text{ s m}^{-1}$\n-   Stomatal resistance, $r_s = 100 \\text{ s m}^{-1}$\n-   Vapor pressure deficit, $D = 1 \\text{ kPa}$\n-   Air density, $\\rho = 1.2 \\text{ kg m}^{-3}$\n-   Specific heat of air, $c_p = 1005 \\text{ J kg}^{-1} \\text{ K}^{-1}$\n\nFirst, we calculate the conductances:\nAerodynamic conductance, $g_a = 1/r_a = 1/50 \\text{ m s}^{-1} = 0.02 \\text{ m s}^{-1}$.\nStomatal conductance, $g_s = 1/r_s = 1/100 \\text{ m s}^{-1} = 0.01 \\text{ m s}^{-1}$.\n\nNext, we compute the numerator and the denominator of the expression for $\\lambda E$.\n\nNumerator = $\\Delta A + \\rho c_p D g_a$\n$$ \\text{Numerator} = (0.2 \\text{ kPa K}^{-1})(400 \\text{ W m}^{-2}) + (1.2 \\text{ kg m}^{-3})(1005 \\text{ J kg}^{-1} \\text{ K}^{-1})(1 \\text{ kPa})(0.02 \\text{ m s}^{-1}) $$\n$$ \\text{Numerator} = 80 \\text{ W m}^{-2} \\text{kPa K}^{-1} + 24.12 \\text{ W m}^{-2} \\text{kPa K}^{-1} $$\nSince $1 \\text{ J s}^{-1} = 1 \\text{ W}$, the units are consistent.\n$$ \\text{Numerator} = 80 + 24.12 = 104.12 \\text{ W m}^{-2} \\text{kPa K}^{-1} $$\n\nDenominator = $\\Delta + \\gamma (1 + g_a/g_s)$\n$$ \\text{Denominator} = 0.2 \\text{ kPa K}^{-1} + (0.066 \\text{ kPa K}^{-1})(1 + \\frac{0.02 \\text{ m s}^{-1}}{0.01 \\text{ m s}^{-1}}) $$\n$$ \\text{Denominator} = 0.2 \\text{ kPa K}^{-1} + (0.066 \\text{ kPa K}^{-1})(1 + 2) $$\n$$ \\text{Denominator} = 0.2 + 3 \\times 0.066 = 0.2 + 0.198 = 0.398 \\text{ kPa K}^{-1} $$\n\nFinally, we calculate $\\lambda E$ by dividing the numerator by the denominator:\n$$ \\lambda E = \\frac{104.12 \\text{ W m}^{-2} \\text{kPa K}^{-1}}{0.398 \\text{ kPa K}^{-1}} $$\n$$ \\lambda E = 261.60804... \\text{ W m}^{-2} $$\n\nRounding the result to four significant figures as required:\n$$ \\lambda E \\approx 261.6 \\text{ W m}^{-2} $$\nThe final answer is $261.6$.",
            "answer": "$$\n\\boxed{261.6}\n$$"
        },
        {
            "introduction": "This final practice transitions from theoretical principles and specific flux calculations to a comprehensive, data-driven analysis at the regional scale. Closing the water budget for a river basin is a fundamental task for validating climate models and understanding regional hydrology. In this exercise , you will integrate multiple data streams—river discharge observations, terrestrial water storage changes, and atmospheric reanalysis products—to assess water budget closure. This task mirrors a common workflow in hydrological and climate research, developing your skills in data synthesis, budget analysis, and the quantitative evaluation of model performance against observations.",
            "id": "4100556",
            "problem": "You are tasked with developing a complete, runnable program that evaluates basin-scale water budget closure in the context of the Global Water Cycle (GWC) within Numerical Weather Prediction (NWP) and climate modeling. The governing physical principle is conservation of mass for a control volume: in a river basin, the net atmospheric input and surface losses must be consistent with the change in terrestrial water storage and the volumetric discharge leaving the basin through its outlet. Starting from conservation of mass for a fixed-area basin and using well-tested hydrological facts and definitions, your program must compute, for several test cases, the closure residual time series and summary statistics that quantify agreement between observed discharge-derived water budget and an atmospheric reanalysis estimate of precipitation minus evaporation. The atmospheric reanalysis (first defined here) is a data-assimilation product that reconstructs past atmospheric states, including precipitation and evaporation fields.\n\nDefinitions and conventions:\n- Let $A$ denote the basin area in $\\mathrm{m^2}$.\n- Let $Q(t)$ denote the observed river discharge at the basin outlet in $\\mathrm{m^3/s}$.\n- Let $P(t)$ denote precipitation in $\\mathrm{m/s}$.\n- Let $E(t)$ denote evaporation in $\\mathrm{m/s}$.\n- Let $S(t)$ denote vertically integrated terrestrial water storage (soil moisture, snow, groundwater, surface water) in $\\mathrm{m}$, so that $\\frac{dS}{dt}(t)$ is in $\\mathrm{m/s}$.\n- Let $(P - E)_{\\mathrm{rean}}(t)$ denote precipitation minus evaporation from an atmospheric reanalysis, in $\\mathrm{m/s}$.\n- Assume a single dominant outlet and negligible lateral groundwater exchange across basin boundaries, so that runoff integrated over the basin equals outlet discharge, and basin-average runoff $R(t)$ in $\\mathrm{m/s}$ satisfies $R(t) = \\frac{Q(t)}{A}$.\n\nYour task is to:\n1. Derive, from conservation of mass, the basin water budget relationship that links $P(t)$, $E(t)$, $R(t)$, and $\\frac{dS}{dt}(t)$, and use it to define a closure residual time series $\\varepsilon(t)$ that compares $(P - E)_{\\mathrm{rean}}(t)$ to the discharge-derived budget.\n2. Implement an algorithm to compute, for each test case time series:\n   - The closure residuals $\\varepsilon(t)$ in $\\mathrm{m/s}$ over all provided times.\n   - The mean bias $b = \\frac{1}{N}\\sum_{t=1}^N \\varepsilon(t)$ in $\\mathrm{m/s}$.\n   - The root-mean-square error $\\mathrm{RMSE} = \\sqrt{\\frac{1}{N}\\sum_{t=1}^N \\varepsilon(t)^2}$ in $\\mathrm{m/s}$.\n   - The Pearson correlation coefficient $\\rho$ between $(P - E)_{\\mathrm{rean}}(t)$ and $R(t) + \\frac{dS}{dt}(t)$ (unitless). If either series has zero variance, define $\\rho = 0$ by convention.\n   - A boolean flag indicating whether closure is satisfactory, defined as $\\mathrm{RMSE} \\le \\tau$, with threshold $\\tau = 1\\times 10^{-8}\\ \\mathrm{m/s}$.\n3. Express all physical quantities in SI units. Angles, where relevant to synthetic construction of time series, must be in radians. The output statistics $b$, $\\mathrm{RMSE}$, and $\\rho$ must be floats; the closure flag must be a boolean.\n\nTest suite specification:\nFor each case, you are given $A$, $Q(t)$, and $\\frac{dS}{dt}(t)$ as monthly time series of length $N = 12$. The $(P - E)_{\\mathrm{rean}}(t)$ series is to be constructed from these fields using a specified base and an additive harmonic noise term. For month index $t \\in \\{1,2,\\dots,12\\}$, define the noise as either $\\eta(t) = \\alpha \\cos\\!\\left(\\frac{2\\pi t}{12}\\right)$ or $\\eta(t) = \\alpha \\sin\\!\\left(\\frac{2\\pi t}{6}\\right)$, with amplitude $\\alpha$ given per case (angles in radians).\n\n- Case 1 (happy path, small mismatch):\n  - Basin area: $A = 1.2 \\times 10^{11}\\ \\mathrm{m^2}$.\n  - Discharge time series $Q(t)$ in $\\mathrm{m^3/s}$ for $t=1,\\dots,12$: $[14000, 13000, 12000, 11000, 10000, 9000, 8000, 7500, 8000, 9000, 10000, 12000]$.\n  - Storage-change time series $\\frac{dS}{dt}(t)$ in $\\mathrm{m/s}$: $[-2\\times 10^{-8}, -1.5\\times 10^{-8}, -1\\times 10^{-8}, -5\\times 10^{-9}, 1\\times 10^{-9}, 5\\times 10^{-9}, 1\\times 10^{-8}, 1.5\\times 10^{-8}, 1\\times 10^{-8}, 5\\times 10^{-9}, 0, -1\\times 10^{-8}]$.\n  - Construct $(P - E)_{\\mathrm{rean}}(t)$ as base $R(t) + \\frac{dS}{dt}(t)$ plus noise $\\eta(t) = \\alpha \\cos\\!\\left(\\frac{2\\pi t}{12}\\right)$ with $\\alpha = 5\\times 10^{-9}$.\n\n- Case 2 (boundary, zero storage change):\n  - Basin area: $A = 8.0 \\times 10^{10}\\ \\mathrm{m^2}$.\n  - Discharge $Q(t)$ in $\\mathrm{m^3/s}$: $[5000, 6000, 7000, 8000, 9000, 10000, 11000, 10000, 9000, 8000, 7000, 6000]$.\n  - Storage change $\\frac{dS}{dt}(t)$ in $\\mathrm{m/s}$: $[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]$.\n  - Construct $(P - E)_{\\mathrm{rean}}(t)$ as base $R(t)$ with zero noise $\\alpha = 0$.\n\n- Case 3 (edge, low discharge regime where atmospheric input is stored):\n  - Basin area: $A = 1.5 \\times 10^{11}\\ \\mathrm{m^2}$.\n  - Discharge $Q(t)$ in $\\mathrm{m^3/s}$: $[800, 700, 600, 500, 400, 300, 200, 300, 400, 500, 600, 700]$.\n  - Storage change $\\frac{dS}{dt}(t)$ in $\\mathrm{m/s}$: $[2\\times 10^{-8}, 1.5\\times 10^{-8}, 1\\times 10^{-8}, 5\\times 10^{-9}, 0, -5\\times 10^{-9}, -1\\times 10^{-8}, -1.5\\times 10^{-8}, -1\\times 10^{-8}, -5\\times 10^{-9}, 0, 5\\times 10^{-9}]$.\n  - Construct $(P - E)_{\\mathrm{rean}}(t)$ as base $\\frac{dS}{dt}(t)$ plus noise $\\eta(t) = \\alpha \\cos\\!\\left(\\frac{2\\pi t}{12}\\right)$ with $\\alpha = 1\\times 10^{-9}$.\n\n- Case 4 (edge, small basin with larger mismatch):\n  - Basin area: $A = 5.0 \\times 10^{9}\\ \\mathrm{m^2}$.\n  - Discharge $Q(t)$ in $\\mathrm{m^3/s}$: $[400, 500, 600, 700, 800, 900, 1000, 900, 800, 700, 600, 500]$.\n  - Storage change $\\frac{dS}{dt}(t)$ in $\\mathrm{m/s}$: $[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]$.\n  - Construct $(P - E)_{\\mathrm{rean}}(t)$ as base $R(t)$ plus noise $\\eta(t) = \\alpha \\sin\\!\\left(\\frac{2\\pi t}{6}\\right)$ with $\\alpha = 2\\times 10^{-8}$.\n\nAlgorithmic requirements:\n- For each case, compute $R(t) = \\frac{Q(t)}{A}$ in $\\mathrm{m/s}$.\n- Using the specified construction rules, generate $(P - E)_{\\mathrm{rean}}(t)$.\n- Define the closure residual $\\varepsilon(t)$ by comparing $(P - E)_{\\mathrm{rean}}(t)$ to the discharge-derived budget. Use this to compute $b$, $\\mathrm{RMSE}$, and $\\rho$.\n- Decide closure satisfactory if $\\mathrm{RMSE} \\le \\tau$ with $\\tau = 1\\times 10^{-8}\\ \\mathrm{m/s}$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each test case contributes a sublist in the form $[b,\\ \\mathrm{RMSE},\\ \\rho,\\ \\mathrm{pass}]$, where $b$, $\\mathrm{RMSE}$, and $\\rho$ are floats and $\\mathrm{pass}$ is a boolean. For example, the final line should look like $[[b_1,\\mathrm{RMSE}_1,\\rho_1,\\mathrm{pass}_1],[b_2,\\mathrm{RMSE}_2,\\rho_2,\\mathrm{pass}_2],[b_3,\\mathrm{RMSE}_3,\\rho_3,\\mathrm{pass}_3],[b_4,\\mathrm{RMSE}_4,\\rho_4,\\mathrm{pass}_4]]$.",
            "solution": "We anchor the derivation in conservation of mass for a control volume representing a fixed-area river basin. Let the control volume be the basin with spatial domain $\\Omega$ and area $A$. The vertically integrated water storage is $S(t)$ in $\\mathrm{m}$, representing total water per unit area. The conservation of mass (continuity) for the basin-average water content can be expressed as\n$$\n\\frac{dS}{dt}(t) = P(t) - E(t) - R(t),\n$$\nwhere $P(t)$ is precipitation input from the atmosphere in $\\mathrm{m/s}$, $E(t)$ is evaporation loss to the atmosphere in $\\mathrm{m/s}$, and $R(t)$ is the basin-average runoff in $\\mathrm{m/s}$ that leaves through the basin boundaries (primarily the river outlet). This statement relies on standard hydrological assumptions: negligible lateral groundwater exchange across boundaries relative to outlet discharge for the timescales of interest, and a single dominant outlet.\n\nFor a single-outlet basin, a well-tested hydrological identity equates the spatially integrated runoff to the outlet discharge. If $Q(t)$ is the volumetric discharge in $\\mathrm{m^3/s}$ at the outlet, then the basin-average runoff in $\\mathrm{m/s}$ is\n$$\nR(t) = \\frac{Q(t)}{A}.\n$$\nSubstituting into the continuity equation and rearranging yields a relationship between atmospheric fluxes and terrestrial terms:\n$$\nP(t) - E(t) = R(t) + \\frac{dS}{dt}(t) = \\frac{Q(t)}{A} + \\frac{dS}{dt}(t).\n$$\nThe atmospheric reanalysis provides $(P - E)_{\\mathrm{rean}}(t)$ in $\\mathrm{m/s}$, which ideally should satisfy the above relationship when averaged over the basin. Therefore, a closure residual that quantifies mismatch is defined as\n$$\n\\varepsilon(t) = (P - E)_{\\mathrm{rean}}(t) - \\left(\\frac{Q(t)}{A} + \\frac{dS}{dt}(t)\\right).\n$$\nIf the reanalysis and observations close the water budget, then $\\varepsilon(t)$ should be close to zero.\n\nTo summarize discrepancies over the time series $t=1,\\dots,N$ with $N=12$ months, compute:\n- The mean bias:\n$$\nb = \\frac{1}{N}\\sum_{t=1}^N \\varepsilon(t),\n$$\nin $\\mathrm{m/s}$.\n- The root-mean-square error:\n$$\n\\mathrm{RMSE} = \\sqrt{\\frac{1}{N}\\sum_{t=1}^N \\varepsilon(t)^2},\n$$\nin $\\mathrm{m/s}$.\n- The Pearson correlation coefficient between the reanalysis atmospheric input and the discharge-derived budget:\n$$\n\\rho = \\mathrm{corr}\\left((P - E)_{\\mathrm{rean}}(t),\\ \\frac{Q(t)}{A} + \\frac{dS}{dt}(t)\\right),\n$$\nwhich is unitless. If either series has zero variance, define $\\rho = 0$ by convention to avoid undefined behavior.\n\nFor closure evaluation, use a physically meaningful small threshold $\\tau$ in $\\mathrm{m/s}$ to decide whether the mismatch is acceptably small. We set\n$$\n\\tau = 1\\times 10^{-8}\\ \\mathrm{m/s},\n$$\nand define the boolean closure flag as $\\mathrm{pass} = \\left(\\mathrm{RMSE} \\le \\tau\\right)$.\n\nAlgorithmic implementation details:\n1. For each case, read $A$ in $\\mathrm{m^2}$, the list $Q(t)$ in $\\mathrm{m^3/s}$, and the list $\\frac{dS}{dt}(t)$ in $\\mathrm{m/s}$, each of length $N=12$ months.\n2. Compute $R(t) = \\frac{Q(t)}{A}$ elementwise to obtain a time series in $\\mathrm{m/s}$.\n3. Construct $(P - E)_{\\mathrm{rean}}(t)$ per case:\n   - Case $1$: base $R(t) + \\frac{dS}{dt}(t)$ plus harmonic noise $\\eta(t) = \\alpha \\cos\\!\\left(\\frac{2\\pi t}{12}\\right)$ with $\\alpha = 5\\times 10^{-9}$ and $t$ in radians.\n   - Case $2$: base $R(t)$ and $\\alpha = 0$.\n   - Case $3$: base $\\frac{dS}{dt}(t)$ plus noise $\\eta(t) = \\alpha \\cos\\!\\left(\\frac{2\\pi t}{12}\\right)$ with $\\alpha = 1\\times 10^{-9}$.\n   - Case $4$: base $R(t)$ plus noise $\\eta(t) = \\alpha \\sin\\!\\left(\\frac{2\\pi t}{6}\\right)$ with $\\alpha = 2\\times 10^{-8}$.\n4. Compute the closure residual $\\varepsilon(t)$ as above, then compute $b$, $\\mathrm{RMSE}$, and $\\rho$. Use a robust correlation computation that returns $\\rho = 0$ if either time series has zero variance.\n5. Compare $\\mathrm{RMSE}$ to $\\tau$ to set $\\mathrm{pass}$.\n6. Aggregate results into the required final output format: a single line string representing a list of four sublists, one per case, in the form $[b,\\ \\mathrm{RMSE},\\ \\rho,\\ \\mathrm{pass}]$.\n\nScientific realism and numerical soundness:\n- The magnitudes used are plausible for medium to large basins: for example, $Q$ on the order of $10^3$ to $10^4\\ \\mathrm{m^3/s}$ and $A$ on the order of $10^{10}$ to $10^{11}\\ \\mathrm{m^2}$ yield $R = \\frac{Q}{A}$ on the order of $10^{-8}$ to $10^{-7}\\ \\mathrm{m/s}$, consistent with typical basin-average fluxes ($\\mathrm{mm/day}$ scale).\n- The storage-change series $\\frac{dS}{dt}(t)$ are within $10^{-9}$ to $10^{-8}\\ \\mathrm{m/s}$, consistent with observed seasonal terrestrial water storage changes.\n- The harmonic noise terms represent spatiotemporal mismatches and model errors often present in reanalysis products.\n\nThe program will implement this logic and print the required single-line output with all four test-case results.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef safe_corr(x: np.ndarray, y: np.ndarray) -> float:\n    \"\"\"Compute Pearson correlation if both series have non-zero variance; else return 0.0.\"\"\"\n    x = np.asarray(x, dtype=float)\n    y = np.asarray(y, dtype=float)\n    sx = np.std(x)\n    sy = np.std(y)\n    if sx == 0.0 or sy == 0.0:\n        return 0.0\n    return float(np.corrcoef(x, y)[0, 1])\n\ndef compute_metrics(A, Q, dSdt, pe_mode):\n    \"\"\"\n    Compute closure residual metrics:\n    - A: basin area (m^2)\n    - Q: array of discharge (m^3/s)\n    - dSdt: array of storage change (m/s)\n    - pe_mode: dict controlling construction of reanalysis P-E\n        keys:\n          'base': 'R_plus_dSdt', 'R_only', or 'dSdt_only'\n          'noise_amp': float amplitude (m/s)\n          'noise_func': 'cos12' or 'sin6'\n    Returns: [mean_bias, rmse, corr, pass_bool]\n    \"\"\"\n    Q = np.asarray(Q, dtype=float)\n    dSdt = np.asarray(dSdt, dtype=float)\n    # Compute basin-mean runoff R = Q/A (m/s)\n    R = Q / float(A)\n\n    # Build base series for reanalysis P-E\n    base_choice = pe_mode.get('base', 'R_plus_dSdt')\n    if base_choice == 'R_plus_dSdt':\n        base = R + dSdt\n    elif base_choice == 'R_only':\n        base = R\n    elif base_choice == 'dSdt_only':\n        base = dSdt\n    else:\n        raise ValueError(\"Invalid base choice for P-E construction.\")\n\n    # Harmonic noise (angles in radians)\n    N = len(Q)\n    t = np.arange(1, N + 1, dtype=float)\n    amp = float(pe_mode.get('noise_amp', 0.0))\n    nf = pe_mode.get('noise_func', 'cos12')\n    if amp == 0.0:\n        noise = np.zeros_like(base)\n    else:\n        if nf == 'cos12':\n            noise = amp * np.cos(2.0 * np.pi * t / 12.0)\n        elif nf == 'sin6':\n            noise = amp * np.sin(2.0 * np.pi * t / 6.0)\n        else:\n            raise ValueError(\"Invalid noise function for P-E construction.\")\n\n    pe_rean = base + noise\n\n    # Closure residual: epsilon = (P-E)_rean - (R + dSdt)\n    epsilon = pe_rean - (R + dSdt)\n\n    # Metrics\n    mean_bias = float(np.mean(epsilon))\n    rmse = float(np.sqrt(np.mean(epsilon ** 2)))\n    corr = safe_corr(pe_rean, (R + dSdt))\n\n    # Closure pass criterion: RMSE <= tau\n    tau = 1e-8  # m/s\n    closure_pass = rmse <= tau\n\n    return [mean_bias, rmse, corr, closure_pass]\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"A\": 1.2e11,\n            \"Q\": [14000, 13000, 12000, 11000, 10000, 9000, 8000, 7500, 8000, 9000, 10000, 12000],\n            \"dSdt\": [-2e-8, -1.5e-8, -1e-8, -5e-9, 1e-9, 5e-9, 1e-8, 1.5e-8, 1e-8, 5e-9, 0.0, -1e-8],\n            \"pe_mode\": {\"base\": \"R_plus_dSdt\", \"noise_amp\": 5e-9, \"noise_func\": \"cos12\"},\n        },\n        {\n            \"A\": 8.0e10,\n            \"Q\": [5000, 6000, 7000, 8000, 9000, 10000, 11000, 10000, 9000, 8000, 7000, 6000],\n            \"dSdt\": [0.0] * 12,\n            \"pe_mode\": {\"base\": \"R_only\", \"noise_amp\": 0.0, \"noise_func\": \"cos12\"},\n        },\n        {\n            \"A\": 1.5e11,\n            \"Q\": [800, 700, 600, 500, 400, 300, 200, 300, 400, 500, 600, 700],\n            \"dSdt\": [2e-8, 1.5e-8, 1e-8, 5e-9, 0.0, -5e-9, -1e-8, -1.5e-8, -1e-8, -5e-9, 0.0, 5e-9],\n            \"pe_mode\": {\"base\": \"dSdt_only\", \"noise_amp\": 1e-9, \"noise_func\": \"cos12\"},\n        },\n        {\n            \"A\": 5.0e9,\n            \"Q\": [400, 500, 600, 700, 800, 900, 1000, 900, 800, 700, 600, 500],\n            \"dSdt\": [0.0] * 12,\n            \"pe_mode\": {\"base\": \"R_only\", \"noise_amp\": 2e-8, \"noise_func\": \"sin6\"},\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        res = compute_metrics(case[\"A\"], case[\"Q\"], case[\"dSdt\"], case[\"pe_mode\"])\n        results.append(res)\n\n    # Final print statement in the exact required format.\n    # Ensure single-line output with comma-separated list enclosed in square brackets.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}