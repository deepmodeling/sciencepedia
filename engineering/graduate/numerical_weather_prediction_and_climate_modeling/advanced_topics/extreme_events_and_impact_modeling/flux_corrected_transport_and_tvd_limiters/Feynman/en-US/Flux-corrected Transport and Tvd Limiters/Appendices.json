{
    "hands_on_practices": [
        {
            "introduction": "The stability of any explicit numerical scheme for advection is governed by the Courant-Friedrichs-Lewy (CFL) condition, which sets a \"speed limit\" on the simulation's time step. This principle ensures that information does not travel further than one grid cell per time step, a prerequisite for numerical stability and for the validity of TVD and FCT limiters. This first exercise  grounds your practice in this fundamental constraint, guiding you to derive and implement a robust time-stepping strategy for the variable velocity fields often encountered in real-world climate and weather models.",
            "id": "4043731",
            "problem": "Consider the one-dimensional scalar linear advection equation in conservative form, which is a foundational building block of transport in numerical weather prediction and climate modeling, given by $u_t + a(x) u_x = 0$ on a uniform grid with spacing $\\Delta x$ and explicit time stepping. You will construct a mathematically sound time step selection strategy that respects stability and monotonicity constraints when using flux-corrected transport and total variation diminishing limiters for a variable wind field $a(x)$.\n\nStarting from fundamental laws and core definitions only, derive the constraint on explicit time stepping for stability and monotonicity in the presence of a spatially varying advective velocity $a(x)$, using local Courant numbers $C_i = a_i \\Delta t / \\Delta x$. Explain how the constraint changes compared to the constant velocity case, and justify how the constraints from flux-corrected transport and total variation diminishing limiters influence the allowable explicit time step for the underlying low-order donor scheme and the high-order limited scheme.\n\nThen implement a program that, for each provided test case, computes a single globally stable time step $\\Delta t$ that satisfies the derived constraint across all grid points. The strategy must be uniform across the domain (a single $\\Delta t$) and must use a safety factor $s$ with $0 < s \\le 1$ to provide margin within the stability limit. Your program must:\n- Accept a specified uniform grid spacing $\\Delta x$ (in meters), a discrete wind field $a_i$ (in meters per second), and a safety factor $s$ (dimensionless) for each test case.\n- Compute the maximum allowable explicit time step under the derived constraint from the local Courant numbers and select $\\Delta t = s \\cdot \\min_i \\left( \\Delta x / |a_i| \\right)$, with the convention that if $|a_i| = 0$ for all $i$, then the advective constraint imposes no restriction and the selected $\\Delta t$ should be reported as $+\\infty$.\n- Express the final selected $\\Delta t$ in seconds, rounded to six decimal places.\n\nTest suite:\n- Case $1$: $\\Delta x = 1000 \\,\\mathrm{m}$, $a = [10, 10, 10, 10, 10] \\,\\mathrm{m/s}$, $s = 0.9$.\n- Case $2$: $\\Delta x = 2000 \\,\\mathrm{m}$, $a = [-5, 0, 12, -8] \\,\\mathrm{m/s}$, $s = 0.9$.\n- Case $3$: $\\Delta x = 500 \\,\\mathrm{m}$, $a = [40, 60, 25] \\,\\mathrm{m/s}$, $s = 0.9$.\n- Case $4$: $\\Delta x = 1000 \\,\\mathrm{m}$, $a = [0, 0, 0, 0] \\,\\mathrm{m/s}$, $s = 0.9$.\n- Case $5$: $\\Delta x = 100 \\,\\mathrm{m}$, $a = [100] \\,\\mathrm{m/s}$, $s = 1.0$.\n\nOutput specification:\n- Your program should produce a single line of output containing the selected time steps for the cases above, expressed in seconds, as a comma-separated list enclosed in square brackets, rounded to six decimal places (for example, $[90.000000,150.000000,7.500000,\\mathrm{inf},1.000000]$).",
            "solution": "The subject of this problem is the determination of a stable and monotonic time step for the numerical solution of the one-dimensional linear advection equation with a spatially varying velocity field. This is a canonical problem in the development of numerical methods for fluid dynamics, an essential component of numerical weather prediction and climate modeling.\n\nThe governing partial differential equation is the linear advection equation, given in conservative form as:\n$$\n\\frac{\\partial u}{\\partial t} + \\frac{\\partial (a(x) u)}{\\partial x} = 0\n$$\nwhere $u(x, t)$ is the conserved quantity (e.g., concentration of a tracer), $t$ is time, $x$ is the spatial coordinate, and $a(x)$ is the spatially varying advective velocity.\n\nWe discretize this equation on a uniform grid with spacing $\\Delta x$ and discrete points $x_i = i \\Delta x$. The solution at grid point $i$ and time step $n$ is denoted $u_i^n$. Using an explicit forward-in-time, centered-in-space discretization of the flux divergence leads to:\n$$\n\\frac{u_i^{n+1} - u_i^n}{\\Delta t} + \\frac{F_{i+1/2} - F_{i-1/2}}{\\Delta x} = 0\n$$\nwhere $\\Delta t$ is the time step and $F_{i \\pm 1/2}$ represents the numerical flux at the interface between cell $i$ and its neighbors. The core of the problem lies in defining these fluxes.\n\nThe derivation of the stability constraint, known as the Courant-Friedrichs-Lewy (CFL) condition, can be understood from the domain of dependence. The analytical solution at a point $(x_i, t^n + \\Delta t)$ depends on information at an earlier time $t^n$ from the point $x_p = x_i - a(x_i) \\Delta t$, which is the departure point on the characteristic curve passing through $(x_i, t^n + \\Delta t)$. For a numerical scheme to be stable, its numerical domain of dependence must contain the analytical domain of dependence.\n\nIn an explicit finite difference scheme, the value $u_i^{n+1}$ is computed using values from a finite stencil of grid points at time $t^n$, for instance, $\\{u_{i-1}^n, u_i^n, u_{i+1}^n\\}$. For the numerical scheme to capture the information propagating from the departure point $x_p$, this point must lie within the stencil used by the scheme.\n\nFor the first-order upwind (or donor-cell) scheme, which is the foundational low-order scheme for most FCT and TVD methods, the value $u_i^{n+1}$ is determined by interpolating from the grid points that bracket the departure point $x_p$.\n- If $a(x_i) > 0$, the information comes from upstream, i.e., from the left. The departure point is $x_p = x_i - a_i \\Delta t$. The numerical stencil involves $u_i^n$ and $u_{i-1}^n$. To ensure the interpolation is stable and confined to adjacent cells, the departure point must not be further upstream than the next grid point, $x_{i-1}$. Thus, we require $x_i - a_i \\Delta t \\ge x_{i-1}$, which is $x_i - a_i \\Delta t \\ge x_i - \\Delta x$. This simplifies to $a_i \\Delta t \\le \\Delta x$.\n- If $a(x_i)  0$, the information comes from the right. The departure point is $x_p = x_i - a_i \\Delta t = x_i + |a_i| \\Delta t$. The numerical stencil involves $u_i^n$ and $u_{i+1}^n$. Stability requires the departure point to be no further upstream than $x_{i+1}$, so $x_i + |a_i| \\Delta t \\le x_{i+1}$, which is $x_i + |a_i| \\Delta t \\le x_i + \\Delta x$. This simplifies to $|a_i| \\Delta t \\le \\Delta x$.\n\nCombining both cases, the condition that must hold at each grid point $i$ is:\n$$\n|a_i| \\frac{\\Delta t}{\\Delta x} \\le 1\n$$\nThe quantity $C_i = a_i \\Delta t / \\Delta x$ is the local Courant number. The stability condition is therefore $|C_i| \\le 1$ for all $i$. For the first-order upwind scheme, this condition is sufficient for both stability (von Neumann analysis) and for monotonicity (ensuring no new extrema are created).\n\nThis contrasts with the constant velocity case, where $a(x) = a_{const}$. There, a single global Courant number $C = a_{const} \\Delta t / \\Delta x$ exists, and the constraint is simply $|C| \\le 1$. When the velocity $a(x)$ is variable, the time step $\\Delta t$ must be chosen so that the condition $|C_i| \\le 1$ is satisfied simultaneously at *every* grid point $i$. Since $\\Delta t$ is uniform across the entire domain for an explicit scheme, it must be constrained by the \"worst-case\" scenario, which corresponds to the point with the maximum absolute velocity, $a_{max} = \\max_i |a_i|$.\nThe constraint for the entire grid becomes:\n$$\n\\left( \\max_i |a_i| \\right) \\frac{\\Delta t}{\\Delta x} \\le 1\n$$\nSolving for the maximum allowable time step, $\\Delta t_{max}$, gives:\n$$\n\\Delta t \\le \\frac{\\Delta x}{\\max_i |a_i|} \\equiv \\min_i \\left( \\frac{\\Delta x}{|a_i|} \\right)\n$$\nwhere the minimum is taken over all $i$ for which $|a_i| > 0$. If all $|a_i| = 0$, the advection equation simplifies to $u_t=0$, and there is no constraint on $\\Delta t$ from the advection process.\n\nFlux-Corrected Transport (FCT) and Total Variation Diminishing (TVD) schemes are higher-order methods designed to provide accurate solutions without the spurious oscillations common to linear high-order schemes. They achieve this by blending a high-order flux (e.g., from a Lax-Wendroff scheme) with a low-order, monotonic flux (from a donor-cell scheme) using a non-linear limiter. A crucial prerequisite for the mathematical construction and correctness of these limiters is that the underlying low-order scheme must be monotonic. As established, the monotonicity condition for the donor-cell scheme is $|C_i| \\le 1$. The stability condition for many high-order schemes used in these blends, such as the Lax-Wendroff scheme, is also $|C_i| \\le 1$. Therefore, the use of FCT or TVD methods does not relax the fundamental CFL constraint. The time step selection is still governed by the need to satisfy $|a_i| \\Delta t / \\Delta x \\le 1$ at all grid points.\n\nFor practical implementation, a safety factor $s$ where $0  s \\le 1$ is applied to ensure the solution remains robustly within the stability region and to account for any unmodeled physics or nonlinear effects. The final selected time step $\\Delta t$ is thus:\n$$\n\\Delta t = s \\cdot \\min_i \\left( \\frac{\\Delta x}{|a_i|} \\right)\n$$\nThis is the relation to be implemented.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes a globally stable time step for the 1D linear advection equation\n    with a variable velocity field, based on the CFL condition.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (delta_x, velocity_array, safety_factor)\n        (1000.0, np.array([10.0, 10.0, 10.0, 10.0, 10.0]), 0.9),\n        (2000.0, np.array([-5.0, 0.0, 12.0, -8.0]), 0.9),\n        (500.0, np.array([40.0, 60.0, 25.0]), 0.9),\n        (1000.0, np.array([0.0, 0.0, 0.0, 0.0]), 0.9),\n        (100.0, np.array([100.0]), 1.0),\n    ]\n\n    results = []\n    \n    for dx, a, s in test_cases:\n        # Calculate the absolute values of the velocities.\n        abs_a = np.abs(a)\n        \n        # Find the maximum absolute velocity in the domain.\n        a_max = np.max(abs_a)\n        \n        # Compute the time step based on the derived constraint.\n        if a_max == 0.0:\n            # If all velocities are zero, the advective constraint on dt is infinite.\n            # As per the problem specification, this is represented by a special value.\n            result_str = \"inf\"\n        else:\n            # The theoretical maximum time step is dx / a_max.\n            # This is equivalent to min(dx / |a_i|) for |a_i|  0.\n            dt_max = dx / a_max\n            \n            # Apply the safety factor to get the final time step.\n            dt = s * dt_max\n            \n            # Format the result to six decimal places.\n            result_str = f\"{dt:.6f}\"\n            \n        results.append(result_str)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "To overcome the excessive numerical diffusion of simple upwind schemes, higher-order methods reconstruct the solution profile within each grid cell. However, this reconstruction must be carefully constrained to prevent the creation of unphysical oscillations near sharp gradients. This exercise  focuses on this critical step, demonstrating how to use a slope limiter—in this case, the classic `minmod` limiter—to build non-oscillatory, high-resolution states at cell interfaces, which are the building blocks for calculating accurate TVD fluxes.",
            "id": "4043760",
            "problem": "Consider a one-dimensional passive tracer being advected by a constant zonal wind in a numerical weather prediction model, idealized by the linear advection equation $u_{t} + a\\,u_{x} = 0$ with constant speed $a > 0$ on a uniform grid with cell centers indexed by $i$. In the flux-corrected transport paradigm, a high-resolution reconstruction is made consistent with the Total Variation Diminishing (TVD) principle to prevent spurious oscillations near steep gradients. Assume a slope-limited linear reconstruction that enforces the TVD property using the minmod limiter. The minmod limiter is defined as $\\mathrm{minmod}(\\alpha,\\beta)$, which returns the argument with the smaller magnitude if $\\alpha$ and $\\beta$ have the same sign, and returns $0$ otherwise.\n\nYou are given the discrete profile at five consecutive cell centers: $u_{i-2} = 1.1$, $u_{i-1} = 1.6$, $u_{i} = 2.0$, $u_{i+1} = 3.0$, $u_{i+2} = 3.4$. The wind speed is $a = 15$ $\\mathrm{m}\\,\\mathrm{s}^{-1}$.\n\nStarting from the requirement that the reconstruction must be TVD and consistent with linear advection, derive the slope-limited interface reconstructions needed to compute the left state $u_{i+1/2}^{-}$ and right state $u_{i+1/2}^{+}$ at the interface between cells $i$ and $i+1$. Then, form the corresponding upwind numerical flux for $a > 0$ at that interface. Give exact values; do not round. Express the final numerical flux in meters per second ($\\mathrm{m}\\,\\mathrm{s}^{-1}$).",
            "solution": "The problem requires the calculation of a numerical flux at the interface $x_{i+1/2}$ between cells $i$ and $i+1$. This is a key step in a MUSCL-type finite volume method. The method involves a piecewise-linear reconstruction of the solution $u$ within each cell, constrained by a TVD limiter to avoid spurious oscillations.\n\nWithin a generic cell $j$, the solution is approximated by a linear function:\n$$\nu(x) = u_j + \\sigma_j \\frac{x - x_j}{\\Delta x}\n$$\nwhere $u_j$ is the cell-average value, $x_j$ is the coordinate of the cell center, $\\Delta x$ is the uniform cell width, and $\\sigma_j$ is the limited slope.\n\nThe values at the left ($x_{j-1/2}$) and right ($x_{j+1/2}$) interfaces of cell $j$ are given by extrapolating this linear profile to the cell edges:\n$$\nu_{j-1/2}^{+} = u_j - \\frac{1}{2}\\sigma_j\n$$\n$$\nu_{j+1/2}^{-} = u_j + \\frac{1}{2}\\sigma_j\n$$\n\nThe problem asks for the states at the specific interface $x_{i+1/2}$. The left state, $u_{i+1/2}^{-}$, is determined by the reconstruction in cell $i$. The right state, $u_{i+1/2}^{+}$, is determined by the reconstruction in cell $i+1$.\n$$\nu_{i+1/2}^{-} = u_i + \\frac{1}{2}\\sigma_i\n$$\n$$\nu_{i+1/2}^{+} = u_{i+1} - \\frac{1}{2}\\sigma_{i+1}\n$$\n\nTo compute these states, we must first determine the limited slopes $\\sigma_i$ and $\\sigma_{i+1}$. The `minmod` limiter is applied to slopes derived from neighboring cell averages. A standard way to define the limited slope in cell $j$ that enforces the TVD property is to apply the `minmod` function to the forward and backward differences:\n$$\n\\sigma_j = \\mathrm{minmod}(u_{j+1} - u_j, u_j - u_{j-1})\n$$\nThe `minmod` function is defined as:\n$$\n\\mathrm{minmod}(\\alpha, \\beta) = \\begin{cases} \\alpha  \\text{if } |\\alpha|  |\\beta| \\text{ and } \\alpha\\beta  0 \\\\ \\beta  \\text{if } |\\beta| \\le |\\alpha| \\text{ and } \\alpha\\beta  0 \\\\ 0  \\text{if } \\alpha\\beta \\le 0 \\end{cases}\n$$\n\nFirst, we calculate the slope $\\sigma_i$ for cell $i$ using the provided data: $u_{i-1} = 1.6$, $u_{i} = 2.0$, and $u_{i+1} = 3.0$. The relevant differences are:\n- Forward difference: $u_{i+1} - u_i = 3.0 - 2.0 = 1.0$\n- Backward difference: $u_i - u_{i-1} = 2.0 - 1.6 = 0.4$\n\nBoth differences are positive. We apply the `minmod` function:\n$$\n\\sigma_i = \\mathrm{minmod}(1.0, 0.4)\n$$\nSince both arguments have the same sign, the function returns the one with the smaller absolute value.\n$$\n\\sigma_i = 0.4\n$$\n\nNext, we calculate the slope $\\sigma_{i+1}$ for cell $i+1$ using the data: $u_{i} = 2.0$, $u_{i+1} = 3.0$, and $u_{i+2} = 3.4$. The relevant differences are:\n- Forward difference: $u_{i+2} - u_{i+1} = 3.4 - 3.0 = 0.4$\n- Backward difference: $u_{i+1} - u_i = 3.0 - 2.0 = 1.0$\n\nAgain, both differences are positive. We apply the `minmod` function:\n$$\n\\sigma_{i+1} = \\mathrm{minmod}(0.4, 1.0)\n$$\nThe function returns the argument with the smaller absolute value.\n$$\n\\sigma_{i+1} = 0.4\n$$\n\nNow we can compute the interface state $u_{i+1/2}^{-}$.\n$$\nu_{i+1/2}^{-} = u_i + \\frac{1}{2}\\sigma_i = 2.0 + \\frac{1}{2}(0.4) = 2.0 + 0.2 = 2.2\n$$\n(While not needed for the final flux calculation since $a>0$, the right state would be $u_{i+1/2}^{+} = u_{i+1} - \\frac{1}{2}\\sigma_{i+1} = 3.0 - \\frac{1}{2}(0.4) = 2.8$.)\n\nThe final step is to compute the numerical flux at the interface, $F_{i+1/2}$. For the linear advection equation $u_t + a u_x = 0$, the physical flux is $F(u) = au$. The numerical flux is determined by solving the Riemann problem at the interface with the reconstructed states $(u_L, u_R) = (u_{i+1/2}^{-}, u_{i+1/2}^{+})$.\n\nSince the advection speed $a = 15$ $\\mathrm{m}\\,\\mathrm{s}^{-1}$ is positive ($a > 0$), information propagates from left to right. The upwind scheme therefore selects the state from the left (upwind) side of the interface to compute the flux.\n$$\nF_{i+1/2} = F(u_{i+1/2}^{-}) = a \\cdot u_{i+1/2}^{-}\n$$\n\nSubstituting the known values:\n$$\nF_{i+1/2} = 15 \\cdot (2.2)\n$$\n$$\nF_{i+1/2} = 33\n$$\n\nAssuming the transported quantity $u$ is dimensionless (like a mixing ratio), the flux has units of velocity, $\\mathrm{m}\\,\\mathrm{s}^{-1}$, as requested.",
            "answer": "$$\n\\boxed{33}\n$$"
        },
        {
            "introduction": "With the foundational concepts of time-step constraints and limited reconstruction in place, you are now ready to implement a complete, state-of-the-art transport scheme. This capstone practice  walks you through the full implementation of the Flux-Corrected Transport (FCT) algorithm, a powerful method for solving advection problems with high fidelity. You will combine a diffusive low-order step with a limited high-order \"anti-diffusive\" correction, learning how to enforce strict physical bounds and monotonicity while minimizing numerical error.",
            "id": "4043809",
            "problem": "Consider the one-dimensional conservative advection of a moisture mixing ratio $q(x,t)$ governed by the linear transport equation\n$$\n\\partial_t q + a \\,\\partial_x q = 0,\n$$\nwhere $a$ is a constant advection velocity and $q$ is bounded by physical constraints $q \\in [0,1]$. The task is to implement a single flux-corrected transport (FCT) step that combines a low-order monotone flux with a high-order flux and applies limiting to the anti-diffusive flux to prevent overshoots beyond the bounds while minimizing numerical diffusion. The computation is on a uniform periodic grid in one spatial dimension.\n\nYou must start from the following base:\n- Conservation of mass in a finite-volume discretization implies that changes in the cell averages are determined solely by numerical flux differences at cell interfaces.\n- A low-order upwind flux is monotone and positivity-preserving for Courant number $C = |a| \\Delta t / \\Delta x \\leq 1$.\n- A high-order flux (e.g., a centered or second-order accurate flux) reduces numerical diffusion but can create overshoots and undershoots near sharp gradients.\n- Flux-corrected transport defines an anti-diffusive flux as the difference between a chosen high-order flux and a low-order monotone flux and then limits this anti-diffusive flux to enforce bounds and avoid new extrema.\n\nImplement the following requirements without using shortcut formulas provided in the problem text:\n- Use a uniform periodic grid of $N$ cells covering $[0,L)$ with cell width $\\Delta x = L/N$ and one explicit time step $\\Delta t$ determined by a prescribed Courant number $C$ using $\\Delta t = C \\Delta x / |a|$.\n- Construct a sharp moisture front initial condition $q(x,0)$ that is piecewise constant: $q(x,0) = 1$ in one or more specified intervals and $q(x,0) = 0$ elsewhere (periodic across $x=0$ and $x=L$).\n- Compute a low-order monotone numerical flux at cell interfaces, a high-order consistent numerical flux, and form the raw anti-diffusive flux as their difference. Then compute limited anti-diffusive fluxes that:\n  1) enforce $q \\in [0,1]$ after the correction step, and\n  2) avoid creation of new local extrema relative to the three-point stencil from the previous time level.\n- Perform one FCT update step that applies the limited anti-diffusive fluxes to the low-order solution, resulting in the final $q$ for that single time step.\n\nUnits:\n- Advection velocity $a$ must be specified in meters per second ($\\mathrm{m/s}$).\n- Spatial length $L$ must be specified in meters ($\\mathrm{m}$).\n- The time step $\\Delta t$ must be computed in seconds ($\\mathrm{s}$) using the Courant number $C$.\n\nYour program must compute, for each test case, the following three diagnostics after the FCT-limited update:\n- The overshoot magnitude above the upper bound: $\\max(\\max_i q_i - 1, 0)$ expressed as a decimal.\n- The undershoot magnitude below the lower bound: $\\max(0 - \\min_i q_i, 0)$ expressed as a decimal.\n- The total variation defined on the periodic grid: $\\sum_{i=0}^{N-1} |q_{i+1 \\bmod N} - q_i|$ expressed as a decimal.\n\nTest suite:\nUse the following four test cases, each specified by $(N,L,a,C,\\text{intervals})$ where the intervals are subranges of $[0,L)$ on which $q=1$ initially:\n- Test $1$: $N=200$, $L=1$, $a=1$, $C=0.5$, intervals $\\{[0.4L,0.6L]\\}$.\n- Test $2$: $N=200$, $L=1$, $a=1$, $C=0.5$, intervals that wrap across the boundary: $\\{[0.9L, L), [0, 0.1L]\\}$.\n- Test $3$: $N=200$, $L=1$, $a=1$, $C=0.95$, intervals $\\{[0.25L,0.35L]\\}$.\n- Test $4$: $N=200$, $L=1$, $a=-1$, $C=0.7$, intervals $\\{[0.5L,0.7L]\\}$.\n\nFinal output format:\nYour program should produce a single line of output containing the concatenated diagnostics for all four tests in order, as a comma-separated list enclosed in square brackets. Specifically:\n$[o_1,u_1,tv_1,o_2,u_2,tv_2,o_3,u_3,tv_3,o_4,u_4,tv_4]$\nwhere $o_k$ is the overshoot magnitude, $u_k$ is the undershoot magnitude, and $tv_k$ is the total variation for test $k$, each expressed as a decimal.",
            "solution": "The problem requires the implementation of a single time step for the one-dimensional linear advection equation,\n$$\n\\partial_t q + a \\, \\partial_x q = 0,\n$$\nwhere $q(x,t)$ is a moisture mixing ratio physically constrained to $q \\in [0,1]$, and $a$ is a constant advection velocity. The solution is to be computed on a uniform periodic grid of $N$ cells over a domain $[0, L)$. The core task is to implement a flux-corrected transport (FCT) update step.\n\nA finite-volume discretization of the equation over a grid cell $i$ (from $x_{i-1/2}$ to $x_{i+1/2}$) leads to an update formula for the cell-averaged quantity $q_i$:\n$$\nq_i^{n+1} = q_i^n - \\frac{\\Delta t}{\\Delta x} (F_{i+1/2} - F_{i-1/2}),\n$$\nwhere $q_i^n$ is the value at time level $n$, $\\Delta x = L/N$ is the cell width, $\\Delta t$ is the time step, and $F_{i+1/2}$ is the numerical flux at the interface between cells $i$ and $i+1$. The time step is determined by the Courant number $C$ as $\\Delta t = C \\Delta x / |a|$.\n\nThe FCT methodology combines a low-order, monotone scheme with a high-order, more accurate but potentially oscillatory scheme to achieve a solution that is both accurate and non-oscillatory. The process is executed in several stages.\n\n**1. Low-Order Solution (Transport and Diffusion)**\n\nFirst, a tentative solution $q^L$ is computed using a low-order, monotone flux $F^L$. A standard choice is the first-order upwind flux, which is diffusive but guarantees that for $q^n \\in [0,1]$ and Courant number $C \\le 1$, the solution $q^L$ will also remain in $[0,1]$ and will not create new extrema. The upwind flux is defined as:\n$$\nF^L_{i+1/2} = \\begin{cases} a q_i^n  \\text{if } a  0 \\\\ a q_{i+1}^n  \\text{if } a  0 \\end{cases}\n$$\nThe low-order, \"transported and diffused\" solution $q_i^L$ is then:\n$$\nq_i^L = q_i^n - \\frac{\\Delta t}{\\Delta x} (F^L_{i+1/2} - F^L_{i-1/2})\n$$\n\n**2. Anti-Diffusive Flux Calculation**\n\nNext, we define an anti-diffusive flux, which represents the difference between a high-order flux $F^H$ and the low-order flux $F^L$. This flux will be used to \"correct\" the overly-diffusive low-order solution. A suitable high-order choice is the second-order accurate Lax-Wendroff flux. The raw (unlimited) anti-diffusive flux $A_{i+1/2}$ is:\n$$\nA_{i+1/2} = F^H_{i+1/2} - F^L_{i+1/2}\n$$\nFor the linear advection equation, this difference can be shown to be equivalent to applying a numerical anti-diffusion. Using the Lax-Wendroff scheme as the high-order reference, the anti-diffusive flux simplifies to:\n$$\nA_{i+1/2} = \\frac{|a|}{2}(1-C)(q_{i+1}^n - q_i^n)\n$$\nwhere $C = |a| \\Delta t / \\Delta x$ is the Courant number. This flux is proportional to the local gradient and aims to sharpen the features diffused by the low-order step.\n\n**3. Flux Limiting (The \"Correction\" Step)**\n\nApplying the raw anti-diffusive fluxes directly could re-introduce the overshoots and undershoots of the high-order scheme. The central idea of FCT is to limit these fluxes to ensure that the final solution remains physically bounded and creates no new local extrema. The limited flux $A^c_{i+1/2}$ is a fraction of the raw flux: $A^c_{i+1/2} = \\alpha_{i+1/2} A_{i+1/2}$, where the correction factor $\\alpha_{i+1/2}$ is in $[0,1]$. We use the robust method of Zalesak (1979).\n\na. **Define Local Bounds**: For each cell $i$, we determine the maximum and minimum allowable values for the updated solution $q_i^{n+1}$. These are constrained by the physical bounds $[0,1]$ and the \"no new extrema\" condition relative to the solution at the previous time level, $q^n$. The bounds for cell $i$ are:\n$$\nQ_i^{\\max} = \\min(1, \\max(q_{i-1}^n, q_i^n, q_{i+1}^n))\n$$\n$$\nQ_i^{\\min} = \\max(0, \\min(q_{i-1}^n, q_i^n, q_{i+1}^n))\n$$\nIndices are handled periodically.\n\nb. **Calculate Cell Capacities**: The low-order solution $q_i^L$ serves as the base. The maximum possible increase in cell $i$ is $Q_i^{\\max} - q_i^L$ and the maximum possible decrease is $q_i^L - Q_i^{\\min}$. We compute the total \"room\" for incoming anti-diffusive mass, $M_i^+$, and the total available \"substance\" for outgoing anti-diffusive mass, $M_i^-$:\n$$\nM_i^+ = (Q_i^{\\max} - q_i^L) \\Delta x\n$$\n$$\nM_i^- = (q_i^L - Q_i^{\\min}) \\Delta x\n$$\n\nc. **Sum Raw Fluxes**: For each cell $i$, we calculate the total mass that would be added by incoming raw anti-diffusive fluxes, $P_i^+$, and the total mass that would be removed by outgoing raw anti-diffusive fluxes, $P_i^-$.\n$$\nP_i^+ = \\Delta t (\\max(0, A_{i-1/2}) - \\min(0, A_{i+1/2}))\n$$\n$$\nP_i^- = \\Delta t (\\max(0, A_{i+1/2}) - \\min(0, A_{i-1/2}))\n$$\n\nd. **Determine Correction Ratios**: We compute cell-wise correction ratios for incoming ($R_i^+$) and outgoing ($R_i^-$) fluxes. These ratios determine what fraction of the total incoming/outgoing flux can be accommodated without violating the bounds.\n$$\nR_i^+ = \\begin{cases} \\min(1, M_i^+ / P_i^+)  \\text{if } P_i^+  0 \\\\ 1  \\text{if } P_i^+ = 0 \\end{cases}\n$$\n$$\nR_i^- = \\begin{cases} \\min(1, M_i^- / P_i^-)  \\text{if } P_i^-  0 \\\\ 1  \\text{if } P_i^- = 0 \\end{cases}\n$$\n\ne. **Limit Each Flux**: Each flux $A_{i+1/2}$ is limited by the constraints of both its donor and receiver cells.\nIf $A_{i+1/2}  0$, it removes mass from cell $i$ (donor) and adds mass to cell $i+1$ (receiver). The correction factor is $\\alpha_{i+1/2} = \\min(R_i^-, R_{i+1}^+)$.\nIf $A_{i+1/2}  0$, it adds mass to cell $i$ (receiver) and removes mass from cell $i+1$ (donor). The correction factor is $\\alpha_{i+1/2} = \\min(R_i^+, R_{i+1}^-)$.\nIf $A_{i+1/2} = 0$, $\\alpha_{i+1/2}$ is undefined but the corrected flux is $0$.\nThe corrected flux is then $A^c_{i+1/2} = \\alpha_{i+1/2} A_{i+1/2}$.\n\n**4. Final Update (Anti-Diffusion)**\n\nFinally, the limited anti-diffusive fluxes are applied to the low-order solution to obtain the final, corrected solution for the time step:\n$$\nq_i^{n+1} = q_i^L - \\frac{\\Delta t}{\\Delta x}(A^c_{i+1/2} - A^c_{i-1/2})\n$$\nBy construction, $q_i^{n+1}$ will respect the physical bounds and will not contain any new, unphysical oscillations.\n\n**Diagnostics**\n\nThe performance of the scheme is evaluated using three diagnostics computed from the final state $q^{n+1}$:\n- Overshoot: $\\max(\\max_i q_i^{n+1} - 1, 0)$\n- Undershoot: $\\max(0 - \\min_i q_i^{n+1}, 0)$\n- Total Variation (TV): $\\sum_{i=0}^{N-1} |q_{(i+1) \\bmod N}^{n+1} - q_i^{n+1}|$. An ideal scheme for a square wave would keep the TV from increasing.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef run_fct_step(N, L, a, C, intervals):\n    \"\"\"\n    Performs a single Flux-Corrected Transport (FCT) step and computes diagnostics.\n    \n    Args:\n        N (int): Number of grid cells.\n        L (float): Length of the periodic domain.\n        a (float): Advection velocity.\n        C (float): Courant number.\n        intervals (list of tuples): List of [start, end) intervals where q=1.\n\n    Returns:\n        tuple: A tuple containing (overshoot, undershoot, total_variation).\n    \"\"\"\n\n    # 1. Grid and Parameters Setup\n    dx = L / N\n    dt = C * dx / abs(a)\n    nu = a * dt / dx  # Signed Courant number\n\n    # Cell centers\n    x = (np.arange(N) + 0.5) * dx\n    \n    # Initial condition q^n\n    q_n = np.zeros(N, dtype=np.float64)\n    for start, end in intervals:\n        # Indices for cells whose centers fall in [start, end)\n        # i_start = i = i_end\n        # start = (i + 0.5) * dx  end\n        # start/dx - 0.5 = i  end/dx - 0.5\n        i_start = int(np.ceil(start / dx - 0.5))\n        i_end = int(np.floor(end / dx - 0.5))\n        if i_start = i_end: # Handles standard interval\n            q_n[i_start : i_end + 1] = 1.0\n        else: # Handle wrap-around case e.g., i_start > i_end\n            q_n[i_start:] = 1.0\n            q_n[:i_end+1] = 1.0\n    \n    # Helper for periodic boundaries\n    def roll(arr, shift):\n        return np.roll(arr, shift)\n\n    # 2. Low-Order Solution (Transport and Diffusion)\n    # Using first-order upwind scheme\n    if a > 0:\n        # Flux F^L_{i+1/2} = a * q_i\n        # Flux F^L_{i-1/2} = a * q_{i-1} -> roll(q_n, 1)\n        flux_diff = a * (q_n - roll(q_n, 1))\n    else:  # a  0\n        # Flux F^L_{i+1/2} = a * q_{i+1} -> roll(q_n, -1)\n        # Flux F^L_{i-1/2} = a * q_i\n        flux_diff = a * (roll(q_n, -1) - q_n)\n    \n    q_L = q_n - (dt / dx) * flux_diff\n\n    # 3. Anti-Diffusive Flux Calculation\n    # A_{i+1/2} = |a|/2 * (1-C) * (q_{i+1} - q_i)\n    # A_{i+1/2} is defined at interfaces, so we calculate it for all N interfaces\n    q_ip1 = roll(q_n, -1)\n    A_ip12 = (abs(a) / 2.0) * (1.0 - C) * (q_ip1 - q_n)\n    \n    # 4. Flux Limiting (Zalesak, 1979)\n    \n    # a. Define Local Bounds\n    q_im1 = roll(q_n, 1) # q_{i-1} for all i\n    Q_max = np.minimum(1.0, np.maximum(np.maximum(q_im1, q_n), q_ip1))\n    Q_min = np.maximum(0.0, np.minimum(np.minimum(q_im1, q_n), q_ip1))\n    \n    # b. Calculate Cell Capacities (as mass)\n    M_plus = (Q_max - q_L) * dx\n    M_minus = (q_L - Q_min) * dx\n    \n    # c. Sum Raw Fluxes (as mass)\n    # Fluxes for cell i are A_{i-1/2} and A_{i+1/2}\n    # A_{i-1/2} for all i is roll(A_ip12, 1)\n    A_im12 = roll(A_ip12, 1)\n    \n    P_plus = dt * (np.maximum(0, A_im12) - np.minimum(0, A_ip12))\n    P_minus = dt * (np.maximum(0, A_ip12) - np.minimum(0, A_im12))\n\n    # d. Determine Correction Ratios\n    # Use np.divide to handle division by zero safely\n    R_plus = np.divide(M_plus, P_plus, out=np.ones_like(P_plus), where=P_plus > 1e-15)\n    R_plus = np.minimum(1.0, R_plus)\n\n    R_minus = np.divide(M_minus, P_minus, out=np.ones_like(P_minus), where=P_minus > 1e-15)\n    R_minus = np.minimum(1.0, R_minus)\n\n    # e. Limit Each Flux\n    # Flux A_{i+1/2} affects cells i and i+1\n    # R_plus for cell i+1 is roll(R_plus, -1)\n    # R_minus for cell i+1 is roll(R_minus, -1)\n    R_plus_ip1 = roll(R_plus, -1)\n    R_minus_ip1 = roll(R_minus, -1)\n    \n    # Correction factor alpha_{i+1/2}\n    alpha = np.ones_like(A_ip12)\n    # Case A_{i+1/2} > 0: donor is i, receiver is i+1\n    # alpha_{i+1/2} = min(R_i^-, R_{i+1}^+)\n    positive_flux_mask = A_ip12 > 0\n    alpha[positive_flux_mask] = np.minimum(R_minus[positive_flux_mask], R_plus_ip1[positive_flux_mask])\n    \n    # Case A_{i+1/2}  0: donor is i+1, receiver is i\n    # alpha_{i+1/2} = min(R_i^+, R_{i+1}^-)\n    negative_flux_mask = A_ip12  0\n    alpha[negative_flux_mask] = np.minimum(R_plus[negative_flux_mask], R_minus_ip1[negative_flux_mask])\n\n    A_c_ip12 = alpha * A_ip12\n    \n    # 5. Final Update (Anti-Diffusion)\n    # Corrected fluxes at i-1/2 interface\n    A_c_im12 = roll(A_c_ip12, 1)\n    q_new = q_L - (dt / dx) * (A_c_ip12 - A_c_im12)\n    \n    # 6. Diagnostics\n    overshoot = max(np.max(q_new) - 1.0, 0.0)\n    undershoot = max(0.0 - np.min(q_new), 0.0)\n    total_variation = np.sum(np.abs(roll(q_new, -1) - q_new))\n    \n    return overshoot, undershoot, total_variation\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (N, L, a, C, intervals)\n        (200, 1.0, 1.0, 0.5, [(0.4, 0.6)]),\n        (200, 1.0, 1.0, 0.5, [(0.9, 1.0), (0.0, 0.1)]),\n        (200, 1.0, 1.0, 0.95, [(0.25, 0.35)]),\n        (200, 1.0, -1.0, 0.7, [(0.5, 0.7)]),\n    ]\n\n    results = []\n    for case in test_cases:\n        N, L, a, C, raw_intervals = case\n        # Scale intervals by L\n        intervals = [(start * L, end * L) for start, end in raw_intervals]\n        \n        overshoot, undershoot, tv = run_fct_step(N, L, a, C, intervals)\n        results.extend([overshoot, undershoot, tv])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}