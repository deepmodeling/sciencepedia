{
    "hands_on_practices": [
        {
            "introduction": "我们从一个基础但至关重要的问题入手：理解数值格式的内在属性。一阶迎风格式是求解平流方程最简单、最稳健的方法之一。通过将此格式应用于一个初始的急剧阶跃函数，我们将亲手计算解如何在一个时间步内演变，并量化其总变差（Total Variation, TV）。这个练习  旨在揭示该格式固有的数值耗散特性，并为理解为何需要更高级的、能够保持解的尖锐特征的TVD或FCT方法奠定基础。",
            "id": "4043793",
            "problem": "考虑一维线性平流方程 $u_{t} + a\\,u_{x} = 0$，其中常数速度 $a0$，定义在均匀网格 $x_{i} = i\\,\\Delta x$上，其中 $i \\in \\mathbb{Z}$。令库朗数 $C = a\\,\\Delta t / \\Delta x = 0.7$。初始数据为离散 Heaviside 阶跃函数，由 $u_{i}^{0} = 0$（当 $i \\leq 0$）和 $u_{i}^{0} = 1$（当 $i \\geq 1$）给出。假设计算域足够大，并在这些恒定状态下进行初始化，使得在第一个时间步内边界效应无关紧要。\n\n使用与正平流速度 $a0$ 对应的保守一阶迎风格式，将解从 $t^{0}$ 向前推进一个时间步至 $t^{1} = t^{0} + \\Delta t$。然后，计算在 $t^{1}$ 时的离散全变分，其定义为\n$$\n\\mathrm{TV}\\!\\left(u^{1}\\right) = \\sum_{i=-\\infty}^{\\infty} \\left| u_{i+1}^{1} - u_{i}^{1} \\right|.\n$$\n从作为通量修正输运和全变分递减（TVD）方法论基础的守恒性和单调性基本原理出发，并以该一阶迎风格式为基准，回答以下问题：推导通量形式的单步更新公式，确定间断点附近的非平凡更新值，并计算离散全变分。将最终答案表示为等于 $\\mathrm{TV}\\!\\left(u^{1}\\right)$ 的单个实数，无需单位。无需四舍五入。",
            "solution": "该问题要求使用一阶迎风格式，计算一维线性平流方程的解在一个时间步后的离散全变分 $\\mathrm{TV}(u^1)$。\n\n控制偏微分方程是线性平流方程：\n$$\nu_{t} + a\\,u_{x} = 0\n$$\n其中平流速度 $a$ 是一个正常数（$a0$）。通过将通量函数定义为 $F(u) = a u$，该方程可以写成守恒形式 $u_t + F(u)_x = 0$。\n\n对于该方程，在间距为 $\\Delta x$ 的均匀网格和时间步长为 $\\Delta t$ 上的一个通用保守有限体积格式由下式给出：\n$$\nu_{i}^{n+1} = u_{i}^{n} - \\frac{\\Delta t}{\\Delta x} \\left( F_{i+1/2} - F_{i-1/2} \\right)\n$$\n此处，$u_i^n$ 是在网格点 $x_i = i\\,\\Delta x$ 和时间 $t^n = n\\,\\Delta t$ 处解的数值近似。项 $F_{i\\pm 1/2}$ 表示单元 $i$ 和单元 $i\\pm1$ 之间界面处的数值通量。\n\n问题指定使用一阶迎风格式。对于 $a0$，信息沿正 $x$ 方向传播（从左到右）。因此，界面 $x_{i+1/2}$（单元 $i$ 的右边界）处的“迎风”值是来自单元 $i$ 的值。因此数值通量定义为：\n$$\nF_{i+1/2} = F(u_i^n) = a u_i^n\n$$\n类似地，单元 $i$ 的左边界 $x_{i-1/2}$ 处的通量由迎风单元（即单元 $i-1$）确定：\n$$\nF_{i-1/2} = F(u_{i-1}^n) = a u_{i-1}^n\n$$\n将这些通量定义代入保守格式，得到通量形式的更新法则：\n$$\nu_{i}^{n+1} = u_{i}^{n} - \\frac{\\Delta t}{\\Delta x} \\left( a u_i^n - a u_{i-1}^n \\right)\n$$\n通过定义库朗数 $C = \\frac{a \\Delta t}{\\Delta x}$，该方程简化为：\n$$\nu_{i}^{n+1} = u_{i}^{n} - C \\left( u_{i}^{n} - u_{i-1}^{n} \\right)\n$$\n这是一阶迎风格式的单步更新公式。已知该格式在 $0 \\leq C \\leq 1$ 时是全变分递减（TVD）的。\n\n问题提供了以下数据：\n- 库朗数：$C = 0.7$。\n- 时间 $t=t^0$ 时的初始条件：$u_i^0$ 是一个离散 Heaviside 阶跃函数。\n$$\nu_{i}^{0} = \\begin{cases} 0  \\text{for } i \\leq 0 \\\\ 1  \\text{for } i \\geq 1 \\end{cases}\n$$\n我们应用 $n=0$ 时的更新公式来求解 $t^1 = t^0 + \\Delta t$ 时的解：\n$$\nu_{i}^{1} = u_{i}^{0} - 0.7 \\left( u_{i}^{0} - u_{i-1}^{0} \\right)\n$$\n仅在梯度 $u_{i}^{0} - u_{i-1}^{0}$ 非零的地方，$u_i^1$ 的值才会与 $u_i^0$ 不同。这种情况只发生在网格点 $i=1$ 处，因为 $u_1^0=1$ 且 $u_0^0=0$。\n\n让我们计算所有相关网格指数 $i$ 的更新值 $u_i^1$：\n1.  对于 $i \\leq 0$：\n    $u_{i}^{0}$ 和 $u_{i-1}^{0}$ 均等于 $0$。\n    $$\n    u_{i}^{1} = 0 - 0.7 \\left( 0 - 0 \\right) = 0\n    $$\n    因此，对于所有 $i \\leq 0$，$u_{i}^{1} = 0$。\n\n2.  对于 $i = 1$：\n    我们有 $u_{1}^{0}=1$ 和 $u_{0}^{0}=0$。\n    $$\n    u_{1}^{1} = u_{1}^{0} - 0.7 \\left( u_{1}^{0} - u_{0}^{0} \\right) = 1 - 0.7 \\left( 1 - 0 \\right) = 1 - 0.7 = 0.3\n    $$\n\n3.  对于 $i \\geq 2$：\n    $u_{i}^{0}$ 和 $u_{i-1}^{0}$ 均等于 $1$。\n    $$\n    u_{i}^{1} = 1 - 0.7 \\left( 1 - 1 \\right) = 1\n    $$\n    因此，对于所有 $i \\geq 2$，$u_{i}^{1} = 1$。\n\n因此，时间 $t^1$ 时的解剖面为：\n$$\nu_i^1 = \\begin{cases} 0  \\text{if } i \\le 0 \\\\ 0.3  \\text{if } i = 1 \\\\ 1  \\text{if } i \\ge 2 \\end{cases}\n$$\n初始的陡峭阶跃在单元 $i=0$ 和 $i=2$ 之间的界面上被抹平了，这是一阶迎风格式特有的数值耗散行为。\n\n现在，我们使用给定的定义计算这个新状态的离散全变分 $\\mathrm{TV}(u^1)$：\n$$\n\\mathrm{TV}\\!\\left(u^{1}\\right) = \\sum_{i=-\\infty}^{\\infty} \\left| u_{i+1}^{1} - u_{i}^{1} \\right|\n$$\n我们只需对差值非零的项求和。这些项出现在解值发生变化的界面处。\n-   对于 $i \\leq -1$：$|u_{i+1}^1 - u_i^1| = |0-0| = 0$。\n-   对于 $i = 0$：$|u_1^1 - u_0^1| = |0.3 - 0| = 0.3$。\n-   对于 $i = 1$：$|u_2^1 - u_1^1| = |1 - 0.3| = 0.7$。\n-   对于 $i \\geq 2$：$|u_{i+1}^1 - u_i^1| = |1-1| = 0$。\n\n全变分是这些跳跃的幅值之和：\n$$\n\\mathrm{TV}\\!\\left(u^{1}\\right) = 0.3 + 0.7 = 1\n$$\n作为参考，初始数据的全变分是 $\\mathrm{TV}(u^0) = |u_1^0 - u_0^0| = |1-0| = 1$。$\\mathrm{TV}(u^1) \\leq \\mathrm{TV}(u^0)$ 这一事实证实了该方法在这种情况下具有全变分递减（TVD）的性质。\n最终答案是 $\\mathrm{TV}(u^1)$ 的数值。",
            "answer": "$$\n\\boxed{1}\n$$"
        },
        {
            "introduction": "在认识到一阶格式的耗散问题后，我们转向更高阶的方法。为了在减少数值耗散的同时避免产生非物理的振荡，总变差递减（Total Variation Diminishing, TVD）限制器被引入。这个练习  将指导你应用一个包含minmod通量限制器的完整二阶TVD格式，来处理一个带有局部极值的剖面。通过这个计算，你将观察到限制器如何在关键区域（如极值点）被激活，以确保总变差不增加，从而维持解的单调性。",
            "id": "4043769",
            "problem": "考虑在数值天气预报和气候模拟中使用的线性平流方程 $u_{t} + a\\,u_{x} = 0$ 的守恒型有限体积离散化中，一个被动示踪剂的一维输运问题。设网格是均匀的，网格单元索引为 $i \\in \\{-2,-1,0,1,2\\}$，在时间层 $n$ 的网格单元平均值为 $u_{i}^{n}$。在局部极值点之外，背景态是分段常数。在时间层 $n$ 的离散廓线为\n$$\nu_{-2}^{n} = 1.0,\\quad u_{-1}^{n} = 1.5,\\quad u_{0}^{n} = 2.0,\\quad u_{1}^{n} = 1.5,\\quad u_{2}^{n} = 1.0.\n$$\n假设平流速度 $a0$ 为正，网格间距 $\\Delta x$ 均匀，时间步长为 $\\Delta t$，使得 Courant–Friedrichs–Lewy (CFL) 数 $C = a\\,\\Delta t / \\Delta x$ 等于 $C = 0.8$。在这单个时间步内，边界值 $u_{-2}^{n}$ 和 $u_{2}^{n}$ 保持不变，这与局部极值点外的恒定流入/流出相一致。\n\n使用一个由以下部分组成的通量修正输运 (FCT) 更新格式：\n- 一个低阶迎风步，以及\n- 一个由总变差递减 (TVD) 通量限制器限制的二阶反扩散修正。\n\n设受限的高分辨率更新由 minmod 通量限制器 $\\varphi(r) = \\max(0,\\min(1,r))$ 构造，其中在界面 $i+\\tfrac{1}{2}$ 处的光滑度指示器为\n$$\nr_{i+\\frac{1}{2}} = \\frac{u_{i}^{n} - u_{i-1}^{n}}{u_{i+1}^{n} - u_{i}^{n}},\n$$\n约定如果 $u_{i+1}^{n} - u_{i}^{n} = 0$，则 $r_{i+\\frac{1}{2}}$ 设为 $0$。对于内部网格单元 $i \\in \\{-1,0,1\\}$，守恒的二阶 TVD 通量限制器更新格式由下式给出\n$$\nu_{i}^{n+1} = u_{i}^{n} - C\\left(u_{i}^{n}-u_{i-1}^{n}\\right) - \\frac{1}{2}C(1-C)\\left[\\,\\varphi\\!\\left(r_{i+\\frac{1}{2}}\\right)\\left(u_{i+1}^{n}-u_{i}^{n}\\right) - \\varphi\\!\\left(r_{i-\\frac{1}{2}}\\right)\\left(u_{i}^{n}-u_{i-1}^{n}\\right)\\right],\n$$\n其中 $u_{-2}^{n+1}=u_{-2}^{n}$ 且 $u_{2}^{n+1}=u_{2}^{n}$。\n\n从 $u$ 的守恒性定义和 TVD 原则出发，从低阶迎风通量和受限的反扩散修正中推导出上述更新格式，然后计算：\n1. 时间 $n$ 的总变差，\n$$\n\\mathrm{TV}(u^{n}) = \\sum_{i=-2}^{1} \\left|u_{i+1}^{n} - u_{i}^{n}\\right|,\n$$\n2. 时间 $n+1$ 的总变差，\n$$\n\\mathrm{TV}(u^{n+1}) = \\sum_{i=-2}^{1} \\left|u_{i+1}^{n+1} - u_{i}^{n+1}\\right|,\n$$\n和\n3. 总变差的变化量 $\\Delta \\mathrm{TV} = \\mathrm{TV}(u^{n+1}) - \\mathrm{TV}(u^{n})$。\n\n将最终答案表示为单个实数 $\\Delta \\mathrm{TV}$。无需四舍五入，该量是无量纲的。并根据 $\\Delta \\mathrm{TV}$ 的符号，简要评估 minmod 限制器在应用于给定廓线的这一个时间步中是否保持了总变差递减 (TVD) 特性。",
            "solution": "### 更新格式的推导\n\n一维线性平流方程由下式给出\n$$ \\frac{\\partial u}{\\partial t} + a \\frac{\\partial u}{\\partial x} = 0 $$\n其中 $u$ 是一个守恒量，$a$ 是恒定的平流速度，假定为正 ($a0$)。\n在守恒型有限体积法中，网格单元平均值 $u_i^n$ 通过以下公式从时间层 $n$ 更新到 $n+1$\n$$ u_i^{n+1} = u_i^n - \\frac{\\Delta t}{\\Delta x} \\left( F_{i+\\frac{1}{2}} - F_{i-\\frac{1}{2}} \\right) $$\n其中 $F_{i+\\frac{1}{2}}$ 是网格单元 $i$ 和 $i+1$ 之间界面上的数值通量，$C = a \\Delta t / \\Delta x$ 是 Courant 数。\n\n通量修正输运 (FCT) 方法将一个低阶、单调的格式与一个高阶格式相结合，以在防止伪振荡的同时实现高精度。\n\n1.  **低阶格式**：对于 $a0$，一阶迎风格式是一个简单、稳健且单调（但有耗散）的选择。其通量定义为\n    $$ F_{i+\\frac{1}{2}}^{L} = a u_i^n $$\n    相应的更新为\n    $$ u_i^{n+1, L} = u_i^n - \\frac{\\Delta t}{\\Delta x} \\left( a u_i^n - a u_{i-1}^n \\right) = u_i^n - C \\left( u_i^n - u_{i-1}^n \\right) $$\n    这是问题描述中提供的更新公式的第一部分。\n\n2.  **高阶格式与反扩散通量**：高阶格式，例如二阶 Lax-Wendroff 格式，提供更好的精度，但可能引入非物理振荡。FCT 方法将“反扩散通量”$A_{i+\\frac{1}{2}}$ 定义为高阶通量 $F_{i+\\frac{1}{2}}^{H}$ 和低阶通量 $F_{i+\\frac{1}{2}}^{L}$ 之间的差。Lax-Wendroff 通量为\n    $$ F_{i+\\frac{1}{2}}^{H} = \\frac{a}{2} \\left( u_i^n + u_{i+1}^n \\right) - \\frac{a^2 \\Delta t}{2 \\Delta x} \\left( u_{i+1}^n - u_i^n \\right) = \\frac{a}{2} \\left( u_i^n + u_{i+1}^n \\right) - \\frac{a C}{2} \\left( u_{i+1}^n - u_i^n \\right) $$\n    那么反扩散通量为\n    $$ A_{i+\\frac{1}{2}} = F_{i+\\frac{1}{2}}^{H} - F_{i+\\frac{1}{2}}^{L} = \\left[ \\frac{a}{2} \\left( u_i^n + u_{i+1}^n \\right) - \\frac{a C}{2} \\left( u_{i+1}^n - u_i^n \\right) \\right] - a u_i^n $$\n    $$ A_{i+\\frac{1}{2}} = \\frac{a}{2} \\left( u_{i+1}^n - u_i^n \\right) - \\frac{a C}{2} \\left( u_{i+1}^n - u_i^n \\right) = \\frac{a}{2} (1-C) \\left( u_{i+1}^n - u_i^n \\right) $$\n\n3.  **受限的反扩散修正**：为确保总变差递减 (TVD) 特性，反扩散通量受到一个通量限制器函数 $\\varphi$ 的限制。受限的反扩散通量为 $A_{i+\\frac{1}{2}}^C = \\varphi\\left(r_{i+\\frac{1}{2}}\\right) A_{i+\\frac{1}{2}}$。最终的更新是通过将受限的反扩散修正加到低阶更新上构造的：\n    $$ u_i^{n+1} = u_i^{n+1, L} - \\frac{\\Delta t}{\\Delta x} \\left( A_{i+\\frac{1}{2}}^C - A_{i-\\frac{1}{2}}^C \\right) $$\n    代入 $u_i^{n+1, L}$ 和 $A_{i+\\frac{1}{2}}^C$ 的表达式：\n    $$ u_i^{n+1} = u_i^n - C \\left( u_i^n - u_{i-1}^n \\right) - \\frac{\\Delta t}{\\Delta x} \\left[ \\varphi\\left(r_{i+\\frac{1}{2}}\\right) \\frac{a}{2} (1-C) \\left( u_{i+1}^n - u_i^n \\right) - \\varphi\\left(r_{i-\\frac{1}{2}}\\right) \\frac{a}{2} (1-C) \\left( u_i^n - u_{i-1}^n \\right) \\right] $$\n    提出公因子并使用 $C = a \\Delta t / \\Delta x$：\n    $$ u_{i}^{n+1} = u_{i}^{n} - C\\left(u_{i}^{n}-u_{i-1}^{n}\\right) - \\frac{1}{2}C(1-C)\\left[\\,\\varphi\\!\\left(r_{i+\\frac{1}{2}}\\right)\\left(u_{i+1}^{n}-u_{i}^{n}\\right) - \\varphi\\!\\left(r_{i-\\frac{1}{2}}\\right)\\left(u_{i}^{n}-u_{i-1}^{n}\\right)\\right] $$\n    这就完成了推导，证实了给定的更新公式代表一个标准的守恒型通量限制器格式。\n\n### 计算\n\n我们现在将此公式应用于给定的数据。\n初始廓线为 $u_{-2}^{n} = 1.0$, $u_{-1}^{n} = 1.5$, $u_{0}^{n} = 2.0$, $u_{1}^{n} = 1.5$, $u_{2}^{n} = 1.0$。Courant 数为 $C=0.8$。边界单元 $i=-2$ 和 $i=2$ 保持不变。\n\n**1. 时间 $n$ 的总变差**\n总变差为 $\\mathrm{TV}(u^{n}) = \\sum_{i=-2}^{1} |u_{i+1}^{n} - u_{i}^{n}|$。差值为：\n$u_{-1}^{n} - u_{-2}^{n} = 1.5 - 1.0 = 0.5$\n$u_{0}^{n} - u_{-1}^{n} = 2.0 - 1.5 = 0.5$\n$u_{1}^{n} - u_{0}^{n} = 1.5 - 2.0 = -0.5$\n$u_{2}^{n} - u_{1}^{n} = 1.0 - 1.5 = -0.5$\n$$ \\mathrm{TV}(u^{n}) = |0.5| + |0.5| + |-0.5| + |-0.5| = 0.5 + 0.5 + 0.5 + 0.5 = 2.0 $$\n\n**2. 内部网格单元 $u_i^{n+1}$ 的计算**\n我们需要计算光滑度指示器 $r_{i\\pm 1/2}$ 和相应的限制器值 $\\varphi(r_{i\\pm 1/2})$。光滑度指示器为 $r_{i+1/2} = \\frac{u_{i}^{n} - u_{i-1}^{n}}{u_{i+1}^{n} - u_{i}^{n}}$。\n限制器为 $\\varphi(r) = \\max(0, \\min(1, r))$。\n\n更新 $u_{-1}, u_0, u_1$ 所需的光滑度指示器为：\n$r_{-3/2} = \\frac{u_{-2}^{n} - u_{-3}^{n}}{u_{-1}^{n} - u_{-2}^{n}}$。假设 $u_{-3}^n=u_{-2}^n=1.0$（分段常数背景），则分子为 $0$，所以 $r_{-3/2}=0$。\n$r_{-1/2} = \\frac{u_{-1}^{n} - u_{-2}^{n}}{u_{0}^{n} - u_{-1}^{n}} = \\frac{0.5}{0.5} = 1.0$。\n$r_{1/2} = \\frac{u_{0}^{n} - u_{-1}^{n}}{u_{1}^{n} - u_{0}^{n}} = \\frac{0.5}{-0.5} = -1.0$。\n$r_{3/2} = \\frac{u_{1}^{n} - u_{0}^{n}}{u_{2}^{n} - u_{1}^{n}} = \\frac{-0.5}{-0.5} = 1.0$。\n\n限制器的值为：\n$\\varphi(r_{-3/2}) = \\varphi(0) = 0$。\n$\\varphi(r_{-1/2}) = \\varphi(1.0) = 1.0$。\n$\\varphi(r_{1/2}) = \\varphi(-1.0) = \\max(0,\\min(1,-1)) = 0$。\n$\\varphi(r_{3/2}) = \\varphi(1.0) = 1.0$。\n\n修正项中的常数系数是 $\\frac{1}{2}C(1-C) = \\frac{1}{2}(0.8)(1-0.8) = \\frac{1}{2}(0.8)(0.2) = 0.08$。\n\n现在，我们计算 $i \\in \\{-1, 0, 1\\}$ 的更新值：\n- 对于 $i=-1$:\n$u_{-1}^{n+1} = u_{-1}^{n} - C(u_{-1}^{n}-u_{-2}^{n}) - 0.08[\\varphi(r_{-1/2})(u_{0}^{n}-u_{-1}^{n}) - \\varphi(r_{-3/2})(u_{-1}^{n}-u_{-2}^{n})]$\n$u_{-1}^{n+1} = 1.5 - 0.8(0.5) - 0.08[1.0(0.5) - 0(0.5)] = 1.5 - 0.4 - 0.08(0.5) = 1.1 - 0.04 = 1.06$。\n\n- 对于 $i=0$:\n$u_{0}^{n+1} = u_{0}^{n} - C(u_{0}^{n}-u_{-1}^{n}) - 0.08[\\varphi(r_{1/2})(u_{1}^{n}-u_{0}^{n}) - \\varphi(r_{-1/2})(u_{0}^{n}-u_{-1}^{n})]$\n$u_{0}^{n+1} = 2.0 - 0.8(0.5) - 0.08[0(-0.5) - 1.0(0.5)] = 2.0 - 0.4 - 0.08(-0.5) = 1.6 + 0.04 = 1.64$。\n\n- 对于 $i=1$:\n$u_{1}^{n+1} = u_{1}^{n} - C(u_{1}^{n}-u_{0}^{n}) - 0.08[\\varphi(r_{3/2})(u_{2}^{n}-u_{1}^{n}) - \\varphi(r_{1/2})(u_{1}^{n}-u_{0}^{n})]$\n$u_{1}^{n+1} = 1.5 - 0.8(-0.5) - 0.08[1.0(-0.5) - 0(-0.5)] = 1.5 + 0.4 - 0.08(-0.5) = 1.9 + 0.04 = 1.94$。\n\n新的廓线为 $u_{-2}^{n+1}=1.0$, $u_{-1}^{n+1}=1.06$, $u_{0}^{n+1}=1.64$, $u_{1}^{n+1}=1.94$, $u_{2}^{n+1}=1.0$。\n\n**3. 时间 $n+1$ 的总变差**\n$\\mathrm{TV}(u^{n+1}) = \\sum_{i=-2}^{1} |u_{i+1}^{n+1} - u_{i}^{n+1}|$。新的差值为：\n$u_{-1}^{n+1} - u_{-2}^{n+1} = 1.06 - 1.0 = 0.06$\n$u_{0}^{n+1} - u_{-1}^{n+1} = 1.64 - 1.06 = 0.58$\n$u_{1}^{n+1} - u_{0}^{n+1} = 1.94 - 1.64 = 0.30$\n$u_{2}^{n+1} - u_{1}^{n+1} = 1.0 - 1.94 = -0.94$\n$$ \\mathrm{TV}(u^{n+1}) = |0.06| + |0.58| + |0.30| + |-0.94| = 0.06 + 0.58 + 0.30 + 0.94 = 1.88 $$\n\n**4. 总变差的变化**\n总变差的变化是\n$$ \\Delta \\mathrm{TV} = \\mathrm{TV}(u^{n+1}) - \\mathrm{TV}(u^{n}) = 1.88 - 2.0 = -0.12 $$\n\n**TVD 特性的评估**\n如果 $\\mathrm{TV}(u^{n+1}) \\le \\mathrm{TV}(u^{n})$，则数值格式是总变差递减 (TVD) 的。这等价于 $\\Delta \\mathrm{TV} \\le 0$。在本例中，$\\Delta \\mathrm{TV} = -0.12$，为负值。因此，对于应用于给定廓线的这单个时间步，总变差已经减小，minmod 限制器格式表现出 TVD 行为，正如理论所预期的。非零耗散是 TVD 格式的特征，尤其是在限制器被激活的极值点附近。",
            "answer": "$$\n\\boxed{-0.12}\n$$"
        },
        {
            "introduction": "理论和手动计算是理解概念的第一步，但真正的掌握来自于将算法付诸实践。这个最终的实践练习  要求你编写一个完整的通量修正输送（Flux-Corrected Transport, FCT）方案，这是一种在现代气候和天气模型中广泛使用的强大技术。你将实现一个多步过程——包括低阶输送、反扩散以及最关键的通量限制步骤——来确保解在保持高精度的同时，严格遵守物理边界（如水汽含量非负）并且不产生新的伪振荡。",
            "id": "4043809",
            "problem": "考虑由线性输运方程控制的湿混合比 $q(x,t)$ 的一维守恒平流\n$$\n\\partial_t q + a \\,\\partial_x q = 0,\n$$\n其中 $a$ 是一个常数平流速度，$q$ 受物理约束限制为 $q \\in [0,1]$。任务是实现一个单一的通量修正输运 (FCT) 步骤，该步骤结合了低阶单调通量和高阶通量，并对反扩散通量应用限制，以防止超出边界的过冲，同时最小化数值扩散。计算在一个一维空间上的均匀周期性网格上进行。\n\n您必须从以下基础出发：\n- 在有限体积离散化中，质量守恒意味着网格单元平均值的变化完全由网格单元界面处的数值通量差异决定。\n- 对于库朗数 $C = |a| \\Delta t / \\Delta x \\leq 1$，低阶迎风格式通量是单调且保正的。\n- 高阶通量（例如，中心格式或二阶精度通量）可以减少数值扩散，但在陡峭梯度附近可能产生过冲和下冲。\n- 通量修正输运将反扩散通量定义为所选高阶通量与低阶单调通量之差，然后限制此反扩散通量，以强制执行边界并避免产生新的极值。\n\n实现以下要求，不要使用问题文本中提供的快捷公式：\n- 使用一个覆盖 $[0,L)$ 的包含 $N$ 个网格单元的均匀周期性网格，其网格宽度为 $\\Delta x = L/N$，并使用一个由给定的库朗数 $C$ 和公式 $\\Delta t = C \\Delta x / |a|$ 决定的显式时间步长 $\\Delta t$。\n- 构建一个分段常数的陡峭湿锋初始条件 $q(x,0)$：在一个或多个指定区间内 $q(x,0) = 1$，在其他地方 $q(x,0) = 0$（在 $x=0$ 和 $x=L$ 处具有周期性）。\n- 计算网格单元界面处的低阶单调数值通量、一个高阶相容数值通量，并将其差值构造成原始反扩散通量。然后计算受限的反扩散通量，使其满足：\n  1) 在修正步骤后强制 $q \\in [0,1]$，以及\n  2) 相对于前一时间层的三点模板，避免产生新的局部极值。\n- 执行一个 FCT 更新步骤，将受限的反扩散通量应用于低阶解，从而得到该单一时间步的最终 $q$。\n\n单位：\n- 平流速度 $a$ 必须以米/秒 ($\\mathrm{m/s}$) 为单位指定。\n- 空间长度 $L$ 必须以米 ($\\mathrm{m}$) 为单位指定。\n- 时间步长 $\\Delta t$ 必须使用库朗数 $C$ 以秒 ($\\mathrm{s}$) 为单位进行计算。\n\n您的程序必须在 FCT 受限更新后，为每个测试用例计算以下三个诊断量：\n- 超出上界的过冲幅度：$\\max(\\max_i q_i - 1, 0)$，以小数表示。\n- 低于下界的下冲幅度：$\\max(0 - \\min_i q_i, 0)$，以小数表示。\n- 在周期性网格上定义的总变差：$\\sum_{i=0}^{N-1} |q_{i+1 \\bmod N} - q_i|$，以小数表示。\n\n测试套件：\n使用以下四个测试用例，每个用例由 $(N,L,a,C,\\text{intervals})$ 指定，其中 `intervals` 是 $[0,L)$ 的子区间，在这些子区间上初始时 $q=1$：\n- 测试 1：$N=200$, $L=1$, $a=1$, $C=0.5$, 区间 $\\{[0.4L,0.6L]\\}$。\n- 测试 2：$N=200$, $L=1$, $a=1$, $C=0.5$, 跨越边界的区间：$\\{[0.9L, L), [0, 0.1L]\\}$。\n- 测试 3：$N=200$, $L=1$, $a=1$, $C=0.95$, 区间 $\\{[0.25L,0.35L]\\}$。\n- 测试 4：$N=200$, $L=1$, $a=-1$, $C=0.7$, 区间 $\\{[0.5L,0.7L]\\}$。\n\n最终输出格式：\n您的程序应生成一行输出，其中包含按顺序连接的所有四个测试的诊断结果，形式为用方括号括起来的逗号分隔列表。具体格式如下：\n$[o_1,u_1,tv_1,o_2,u_2,tv_2,o_3,u_3,tv_3,o_4,u_4,tv_4]$\n其中 $o_k$ 是过冲幅度，$u_k$ 是下冲幅度，而 $tv_k$ 是测试 $k$ 的总变差，每个都以小数表示。",
            "solution": "该问题要求为一维线性平流方程实现一个单时间步，\n$$\n\\partial_t q + a \\, \\partial_x q = 0,\n$$\n其中 $q(x,t)$ 是一个物理上被限制在 $q \\in [0,1]$ 内的湿混合比，而 $a$ 是一个常数平流速度。解将在覆盖域 $[0, L)$ 上的一个包含 $N$ 个单元的均匀周期性网格上计算。核心任务是实现一个通量修正输运 (FCT) 更新步骤。\n\n方程在网格单元 $i$（从 $x_{i-1/2}$ 到 $x_{i+1/2}$）上的有限体积离散化，得到了单元平均量 $q_i$ 的更新公式：\n$$\nq_i^{n+1} = q_i^n - \\frac{\\Delta t}{\\Delta x} (F_{i+1/2} - F_{i-1/2}),\n$$\n其中 $q_i^n$ 是时间层 $n$ 处的值，$\\Delta x = L/N$ 是单元宽度，$\\Delta t$ 是时间步长，而 $F_{i+1/2}$ 是单元 $i$ 和 $i+1$ 之间界面上的数值通量。时间步长由库朗数 $C$ 决定，即 $\\Delta t = C \\Delta x / |a|$。\n\nFCT 方法结合了一个低阶、单调的格式和一个高阶、更精确但可能产生振荡的格式，以获得既精确又无振荡的解。该过程分几个阶段执行。\n\n**1. 低阶解（输运和扩散）**\n\n首先，使用一个低阶、单调通量 $F^L$ 计算一个试验解 $q^L$。一个标准的选择是一阶迎风格式通量，它是扩散性的，但能保证对于 $q^n \\in [0,1]$ 和库朗数 $C \\le 1$，解 $q^L$ 也会保持在 $[0,1]$ 内，并且不会产生新的极值。迎风格式通量定义为：\n$$\nF^L_{i+1/2} = \\begin{cases} a q_i^n  \\text{若 } a  0 \\\\ a q_{i+1}^n  \\text{若 } a  0 \\end{cases}\n$$\n低阶的“输运和扩散”解 $q_i^L$ 则是：\n$$\nq_i^L = q_i^n - \\frac{\\Delta t}{\\Delta x} (F^L_{i+1/2} - F^L_{i-1/2})\n$$\n\n**2. 反扩散通量计算**\n\n接下来，我们定义一个反扩散通量，它代表高阶通量 $F^H$ 和低阶通量 $F^L$ 之间的差值。这个通量将用于“修正”过于扩散的低阶解。一个合适的高阶选择是二阶精度的 Lax-Wendroff 通量。原始（无限制）的反扩散通量 $A_{i+1/2}$ 是：\n$$\nA_{i+1/2} = F^H_{i+1/2} - F^L_{i+1/2}\n$$\n对于线性平流方程，可以证明这个差值等效于施加一个数值反扩散。使用 Lax-Wendroff 格式作为高阶参考，反扩散通量简化为：\n$$\nA_{i+1/2} = \\frac{|a|}{2}(1-C)(q_{i+1}^n - q_i^n)\n$$\n其中 $C = |a| \\Delta t / \\Delta x$ 是库朗数。该通量与局部梯度成正比，旨在锐化被低阶步骤扩散的特征。\n\n**3. 通量限制（“修正”步骤）**\n\n直接应用原始反扩散通量可能会重新引入高阶格式的过冲和下冲。FCT 的核心思想是限制这些通量，以确保最终解保持在物理边界内并且不产生新的局部极值。受限通量 $A^c_{i+1/2}$ 是原始通量的一部分：$A^c_{i+1/2} = \\alpha_{i+1/2} A_{i+1/2}$，其中修正因子 $\\alpha_{i+1/2}$ 在 $[0,1]$ 范围内。我们使用 Zalesak (1979) 的稳健方法。\n\na. **定义局部边界**：对于每个单元 $i$，我们确定更新后解 $q_i^{n+1}$ 的最大和最小允许值。这些值受到物理边界 $[0,1]$ 以及相对于前一时间层的解 $q^n$ 的“无新极值”条件的约束。单元 $i$ 的边界是：\n$$\nQ_i^{\\max} = \\min(1, \\max(q_{i-1}^n, q_i^n, q_{i+1}^n))\n$$\n$$\nQ_i^{\\min} = \\max(0, \\min(q_{i-1}^n, q_i^n, q_{i+1}^n))\n$$\n索引按周期性处理。\n\nb. **计算单元容量**：低阶解 $q_i^L$ 作为基础。单元 $i$ 中可能的最大增量是 $Q_i^{\\max} - q_i^L$，而可能的最大减量是 $q_i^L - Q_i^{\\min}$。我们计算用于传入反扩散质量的总“空间” $M_i^+$，以及用于传出反扩散质量的总可用“物质” $M_i^-$：\n$$\nM_i^+ = (Q_i^{\\max} - q_i^L) \\Delta x\n$$\n$$\nM_i^- = (q_i^L - Q_i^{\\min}) \\Delta x\n$$\n\nc. **对原始通量求和**：对于每个单元 $i$，我们计算由传入的原始反扩散通量增加的总质量 $P_i^+$，以及由传出的原始反扩散通量减少的总质量 $P_i^-$：\n$$\nP_i^+ = \\Delta t (\\max(0, A_{i-1/2}) - \\min(0, A_{i+1/2}))\n$$\n$$\nP_i^- = \\Delta t (\\max(0, A_{i+1/2}) - \\min(0, A_{i-1/2}))\n$$\n\nd. **确定修正比率**：我们计算单元级别的修正比率，分别用于传入 ($R_i^+$) 和传出 ($R_i^-$) 通量。这些比率决定了在不违反边界条件的情况下，可以容纳的总传入/传出通量的比例。\n$$\nR_i^+ = \\begin{cases} \\min(1, M_i^+ / P_i^+)  \\text{若 } P_i^+  0 \\\\ 1  \\text{若 } P_i^+ = 0 \\end{cases}\n$$\n$$\nR_i^- = \\begin{cases} \\min(1, M_i^- / P_i^-)  \\text{若 } P_i^-  0 \\\\ 1  \\text{若 } P_i^- = 0 \\end{cases}\n$$\n\ne. **限制每个通量**：每个通量 $A_{i+1/2}$ 都受到其给予单元和接收单元两者的约束。\n如果 $A_{i+1/2}  0$，它从单元 $i$（给予单元）移出质量，并向单元 $i+1$（接收单元）加入质量。修正因子为 $\\alpha_{i+1/2} = \\min(R_i^-, R_{i+1}^+)$。\n如果 $A_{i+1/2}  0$，它向单元 $i$（接收单元）加入质量，并从单元 $i+1$（给予单元）移出质量。修正因子为 $\\alpha_{i+1/2} = \\min(R_i^+, R_{i+1}^-)$。\n如果 $A_{i+1/2} = 0$，$\\alpha_{i+1/2}$ 未定义，但修正后的通量为 $0$。\n修正后的通量则为 $A^c_{i+1/2} = \\alpha_{i+1/2} A_{i+1/2}$。\n\n**4. 最终更新（反扩散）**\n\n最后，将受限的反扩散通量应用于低阶解，以获得该时间步的最终修正解：\n$$\nq_i^{n+1} = q_i^L - \\frac{\\Delta t}{\\Delta x}(A^c_{i+1/2} - A^c_{i-1/2})\n$$\n根据构造，$q_i^{n+1}$ 将遵守物理边界，并且不会包含任何新的、非物理的振荡。\n\n**诊断量**\n\n格式的性能通过从最终状态 $q^{n+1}$ 计算的三个诊断量来评估：\n- 过冲：$\\max(\\max_i q_i^{n+1} - 1, 0)$\n- 下冲：$\\max(0 - \\min_i q_i^{n+1}, 0)$\n- 总变差 (TV)：$\\sum_{i=0}^{N-1} |q_{(i+1) \\bmod N}^{n+1} - q_i^{n+1}|$。对于方波，一个理想的格式会防止总变差增加。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef run_fct_step(N, L, a, C, intervals):\n    \"\"\"\n    Performs a single Flux-Corrected Transport (FCT) step and computes diagnostics.\n    \n    Args:\n        N (int): Number of grid cells.\n        L (float): Length of the periodic domain.\n        a (float): Advection velocity.\n        C (float): Courant number.\n        intervals (list of tuples): List of [start, end) intervals where q=1.\n\n    Returns:\n        tuple: A tuple containing (overshoot, undershoot, total_variation).\n    \"\"\"\n\n    # 1. Grid and Parameters Setup\n    dx = L / N\n    dt = C * dx / abs(a)\n    \n    # Cell centers\n    x = (np.arange(N) + 0.5) * dx\n    \n    # Initial condition q^n\n    q_n = np.zeros(N, dtype=np.float64)\n    for start, end in intervals:\n        i_start = int(np.ceil(start / dx - 0.5))\n        i_end = int(np.floor(end / dx - 0.5))\n        if i_start = i_end: # Handles standard interval\n            q_n[i_start : i_end + 1] = 1.0\n        else: # Handle wrap-around case e.g., i_start  i_end\n            q_n[i_start:] = 1.0\n            q_n[:i_end+1] = 1.0\n    \n    # Helper for periodic boundaries\n    def roll(arr, shift):\n        return np.roll(arr, shift)\n\n    # 2. Low-Order Solution (Transport and Diffusion)\n    # Using first-order upwind scheme\n    if a  0:\n        # Flux F^L_{i+1/2} = a * q_i\n        # Flux F^L_{i-1/2} = a * q_{i-1} - roll(q_n, 1)\n        flux_diff = a * (q_n - roll(q_n, 1))\n    else:  # a  0\n        # Flux F^L_{i+1/2} = a * q_{i+1} - roll(q_n, -1)\n        # Flux F^L_{i-1/2} = a * q_i\n        flux_diff = a * (roll(q_n, -1) - q_n)\n    \n    q_L = q_n - (dt / dx) * flux_diff\n\n    # 3. Anti-Diffusive Flux Calculation\n    # A_{i+1/2} = |a|/2 * (1-C) * (q_{i+1} - q_i)\n    # A_{i+1/2} is defined at interfaces, so we calculate it for all N interfaces\n    q_ip1 = roll(q_n, -1)\n    A_ip12 = (abs(a) / 2.0) * (1.0 - C) * (q_ip1 - q_n)\n    \n    # 4. Flux Limiting (Zalesak, 1979)\n    \n    # a. Define Local Bounds\n    q_im1 = roll(q_n, 1) # q_{i-1} for all i\n    Q_max = np.minimum(1.0, np.maximum(np.maximum(q_im1, q_n), q_ip1))\n    Q_min = np.maximum(0.0, np.minimum(np.minimum(q_im1, q_n), q_ip1))\n    \n    # b. Calculate Cell Capacities (as mass)\n    M_plus = (Q_max - q_L) * dx\n    M_minus = (q_L - Q_min) * dx\n    \n    # c. Sum Raw Fluxes (as mass)\n    # Fluxes for cell i are A_{i-1/2} and A_{i+1/2}\n    # A_{i-1/2} for all i is roll(A_ip12, 1)\n    A_im12 = roll(A_ip12, 1)\n    \n    P_plus = dt * (np.maximum(0, A_im12) - np.minimum(0, A_ip12))\n    P_minus = dt * (np.maximum(0, A_ip12) - np.minimum(0, A_im12))\n\n    # d. Determine Correction Ratios\n    # Use np.divide to handle division by zero safely\n    R_plus = np.divide(M_plus, P_plus, out=np.ones_like(P_plus), where=P_plus  1e-15)\n    R_plus = np.minimum(1.0, R_plus)\n\n    R_minus = np.divide(M_minus, P_minus, out=np.ones_like(P_minus), where=P_minus  1e-15)\n    R_minus = np.minimum(1.0, R_minus)\n\n    # e. Limit Each Flux\n    # Flux A_{i+1/2} affects cells i and i+1\n    # R_plus for cell i+1 is roll(R_plus, -1)\n    # R_minus for cell i+1 is roll(R_minus, -1)\n    R_plus_ip1 = roll(R_plus, -1)\n    R_minus_ip1 = roll(R_minus, -1)\n    \n    # Correction factor alpha_{i+1/2}\n    alpha = np.ones_like(A_ip12)\n    # Case A_{i+1/2}  0: donor is i, receiver is i+1\n    # alpha_{i+1/2} = min(R_i^-, R_{i+1}^+)\n    positive_flux_mask = A_ip12  0\n    alpha[positive_flux_mask] = np.minimum(R_minus[positive_flux_mask], R_plus_ip1[positive_flux_mask])\n    \n    # Case A_{i+1/2}  0: donor is i+1, receiver is i\n    # alpha_{i+1/2} = min(R_i^+, R_{i+1}^-)\n    negative_flux_mask = A_ip12  0\n    alpha[negative_flux_mask] = np.minimum(R_plus[negative_flux_mask], R_minus_ip1[negative_flux_mask])\n\n    A_c_ip12 = alpha * A_ip12\n    \n    # 5. Final Update (Anti-Diffusion)\n    # Corrected fluxes at i-1/2 interface\n    A_c_im12 = roll(A_c_ip12, 1)\n    q_new = q_L - (dt / dx) * (A_c_ip12 - A_c_im12)\n    \n    # 6. Diagnostics\n    overshoot = max(np.max(q_new) - 1.0, 0.0)\n    undershoot = max(0.0 - np.min(q_new), 0.0)\n    total_variation = np.sum(np.abs(roll(q_new, -1) - q_new))\n    \n    return overshoot, undershoot, total_variation\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (N, L, a, C, intervals)\n        (200, 1.0, 1.0, 0.5, [(0.4, 0.6)]),\n        (200, 1.0, 1.0, 0.5, [(0.9, 1.0), (0.0, 0.1)]),\n        (200, 1.0, 1.0, 0.95, [(0.25, 0.35)]),\n        (200, 1.0, -1.0, 0.7, [(0.5, 0.7)]),\n    ]\n\n    results = []\n    for case in test_cases:\n        N, L, a, C, raw_intervals = case\n        # Scale intervals by L\n        intervals = [(start * L, end * L) for start, end in raw_intervals]\n        \n        overshoot, undershoot, tv = run_fct_step(N, L, a, C, intervals)\n        results.extend([overshoot, undershoot, tv])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}