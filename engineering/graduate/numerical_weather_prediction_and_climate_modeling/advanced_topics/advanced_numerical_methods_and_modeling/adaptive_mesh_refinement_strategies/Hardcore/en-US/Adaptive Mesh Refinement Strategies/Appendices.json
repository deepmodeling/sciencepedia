{
    "hands_on_practices": [
        {
            "introduction": "Before implementing an adaptive mesh, a fundamental design question is how much refinement is necessary to capture the dynamics of interest. This practice connects the abstract parameters of an AMR system—the base grid spacing $\\Delta x_0$, refinement ratio $r$, and number of levels $L$—to a concrete physical requirement in atmospheric modeling: resolving the Rossby deformation radius. By working through this derivation, you will develop a quantitative tool for determining the minimum AMR hierarchy depth needed to ensure that essential balanced dynamics are adequately represented in a simulation.",
            "id": "4009014",
            "problem": "In a horizontally adaptive mesh refinement strategy for a primitive-equation atmosphere model used in numerical weather prediction and climate modeling, the base horizontal grid spacing is $\\Delta x_0$. Each refinement level is applied isotropically with a constant refinement ratio $r$, where $r1$ is a fixed number that reduces the grid spacing by a factor of $r$ at each level. The finest-grid spacing after $L$ refinement levels is therefore denoted $\\Delta x_{\\min}$.\n\nTo adequately represent balanced mesoscale dynamics, the mesh must resolve the Rossby deformation radius, which for a continuously stratified fluid is approximated here as $L_d = N H / f$, where $N0$ is the buoyancy frequency, $H0$ is a representative vertical scale of stratification, and $f0$ is the Coriolis parameter. The resolution criterion is that the deformation radius be resolved by at least $n$ points on the finest mesh, with $n \\ge 1$, meaning that $L_d / \\Delta x_{\\min} \\ge n$.\n\nAssuming $\\Delta x_00$, $r1$, $N0$, $H0$, $f0$, and $n \\ge 1$, and that the number of refinement levels $L$ must be a nonnegative integer, derive from first principles the minimum number of refinement levels required to satisfy the resolution criterion. Express your final answer as a single closed-form analytical expression in terms of $N$, $H$, $f$, $\\Delta x_0$, $r$, and $n$. Do not include units in your final expression. If your result involves any rounding to an integer number of levels, express this using an appropriate mathematical function rather than specifying a numerical rounding rule.",
            "solution": "We begin from the definition of the Rossby deformation radius for a continuously stratified fluid, approximated as $L_d = N H / f$, where $N0$ is the buoyancy frequency, $H0$ is a vertical scale, and $f0$ is the Coriolis parameter. The adaptive mesh refinement strategy with a geometric refinement ratio $r1$ implies that after $L$ levels of refinement, the finest-grid spacing is\n$$\n\\Delta x_{\\min} = \\frac{\\Delta x_0}{r^{L}}.\n$$\nThe resolution requirement that the deformation radius be resolved by at least $n$ grid intervals on the finest mesh is\n$$\n\\frac{L_d}{\\Delta x_{\\min}} \\ge n.\n$$\nSubstituting $\\Delta x_{\\min} = \\Delta x_0 / r^{L}$ gives\n$$\n\\frac{L_d}{\\Delta x_0 / r^{L}} \\ge n \\quad \\Longrightarrow \\quad \\frac{L_d r^{L}}{\\Delta x_0} \\ge n.\n$$\nRearranging,\n$$\nr^{L} \\ge \\frac{n \\,\\Delta x_0}{L_d}.\n$$\nBecause $r1$, the function $L \\mapsto r^{L}$ is strictly increasing. Taking the natural logarithm on both sides preserves the inequality direction and yields\n$$\nL \\,\\ln(r) \\ge \\ln\\!\\left(\\frac{n \\,\\Delta x_0}{L_d}\\right).\n$$\nDividing by $\\ln(r)0$ gives\n$$\nL \\ge \\frac{\\ln\\!\\left(\\frac{n \\,\\Delta x_0}{L_d}\\right)}{\\ln(r)}.\n$$\nUsing $L_d = N H / f$, we obtain\n$$\n\\frac{n \\,\\Delta x_0}{L_d} = \\frac{n \\,\\Delta x_0}{N H / f} = \\frac{n \\, f \\,\\Delta x_0}{N H},\n$$\nso the inequality becomes\n$$\nL \\ge \\frac{\\ln\\!\\left(\\frac{n \\, f \\,\\Delta x_0}{N H}\\right)}{\\ln(r)}.\n$$\nSince $L$ must be a nonnegative integer number of refinement levels, the minimal $L$ that satisfies the inequality is the least integer greater than or equal to the right-hand side, but not less than $0$. This is expressed using the ceiling function $\\lceil \\cdot \\rceil$ and the maximum with $0$:\n$$\nL_{\\min} = \\max\\!\\left(0, \\left\\lceil \\frac{\\ln\\!\\left(\\frac{n \\, f \\,\\Delta x_0}{N H}\\right)}{\\ln(r)} \\right\\rceil \\right).\n$$\nThis expression ensures that if the base mesh already satisfies the criterion, i.e., if $n \\, f \\,\\Delta x_0 /(N H) \\le 1$, then $L_{\\min}=0$; otherwise, it returns the smallest integer number of refinement levels required.",
            "answer": "$$\\boxed{\\max\\!\\left(0,\\left\\lceil \\dfrac{\\ln\\!\\left(\\dfrac{n f \\Delta x_{0}}{N H}\\right)}{\\ln(r)} \\right\\rceil\\right)}$$"
        },
        {
            "introduction": "A critical requirement for long-term climate and weather simulations is the conservation of scalar quantities like mass and tracer concentrations. This exercise explores the numerical consequences of failing to ensure flux consistency at the interface between coarse and fine grids, a common challenge in AMR methods. By quantifying the cumulative error that arises when fluxes are not perfectly matched, this analysis provides a rigorous justification for the \"refluxing\" step, which is a cornerstone of all modern conservative AMR algorithms.",
            "id": "4008986",
            "problem": "Consider a one-dimensional two-level Adaptive Mesh Refinement (AMR) hierarchy with a single coarse–fine interface of face area $A$ and impermeable outer boundaries. Let $q(x,t)$ be a conserved scalar density satisfying the conservation law $\\partial q / \\partial t + \\partial F(q) / \\partial x = 0$. The hierarchy is advanced in time using the Finite Volume Method (FVM). The coarse level uses a time step $\\Delta t_{c}$, and the fine level subcycles with $r$ fine steps per coarse step, $\\Delta t_{f} = \\Delta t_{c} / r$. Denote by $F_{c}$ the coarse-level numerical flux through the coarse–fine interface over one coarse step, and by $\\bar{F}_{f}$ the fine-level numerical flux averaged over the same coarse time interval, defined by $\\bar{F}_{f} = \\frac{1}{\\Delta t_{c}} \\sum_{k=1}^{r} F_{f}^{(k)} \\Delta t_{f}$, where $F_{f}^{(k)}$ is the fine flux on substep $k$. In this test, suppose the coarse flux differs from the fine-level average by a constant offset per coarse step,\n$$\nF_{c} = \\bar{F}_{f} + \\delta,\n$$\nwhere $\\delta$ is independent of time step index. Assume no refluxing is applied; that is, the coarse update is not corrected by fine fluxes.\n\nLet $M_{0}$ denote the initial total mass summed over all cells at all levels, and let $M(n)$ denote the total mass after $n$ coarse steps of AMR advance without refluxing. Define the dimensionless cumulative mass error after $n$ coarse steps by\n$$\n\\epsilon(n) = \\frac{M(n) - M_{0}}{M_{0}}.\n$$\n\nStarting from conservation and the FVM flux-balance principle, derive an exact closed-form expression for $\\epsilon(n)$ in terms of $n$, $\\delta$, $A$, $\\Delta t_{c}$, and $M_{0}$ under the assumptions above. Your final answer must be a single analytic expression. Do not substitute numerical values. Do not include units in your final boxed expression. If you introduce any angles, express them in radians. Since the answer is purely symbolic, no rounding is required.",
            "solution": "According to the Finite Volume Method, the change in total mass $M$ within the domain over one coarse time step $\\Delta t_c$ is equal to the net mass that crosses the domain boundaries. Since the outer boundaries are impermeable, the only source of mass change is the inconsistent accounting of flux at the single coarse-fine interface.\n\nLet's define the flux direction as positive from the coarse region to the fine region. The total mass that leaves the coarse domain at the interface, as computed by the coarse solver over $\\Delta t_c$, is:\n$$ \\Delta M_{\\text{out}} = F_c A \\Delta t_c $$\nThe total mass that enters the fine domain at the interface over the same period is the sum of mass transfers over the $r$ subcycled fine steps:\n$$ \\Delta M_{\\text{in}} = \\sum_{k=1}^{r} \\left( F_f^{(k)} A \\Delta t_f \\right) = A \\sum_{k=1}^{r} F_f^{(k)} \\Delta t_f $$\nThe net change in total system mass over one coarse step, $\\Delta M_{\\text{step}}$, is the difference between what entered the fine domain and what left the coarse domain:\n$$ \\Delta M_{\\text{step}} = \\Delta M_{\\text{in}} - \\Delta M_{\\text{out}} = A \\sum_{k=1}^{r} F_f^{(k)} \\Delta t_f - F_c A \\Delta t_c $$\nUsing the problem's definition of the time-averaged fine flux, $\\bar{F}_{f} = \\frac{1}{\\Delta t_{c}} \\sum_{k=1}^{r} F_{f}^{(k)} \\Delta t_{f}$, we can rewrite the sum as $\\sum_{k=1}^{r} F_f^{(k)} \\Delta t_f = \\bar{F}_f \\Delta t_c$. Substituting this gives:\n$$ \\Delta M_{\\text{step}} = A (\\bar{F}_f \\Delta t_c) - F_c A \\Delta t_c = (\\bar{F}_f - F_c) A \\Delta t_c $$\nThe problem states that the flux mismatch is $F_c = \\bar{F}_f + \\delta$, which implies $\\bar{F}_f - F_c = -\\delta$. Therefore, the mass error generated in a single coarse step is:\n$$ \\Delta M_{\\text{step}} = -\\delta A \\Delta t_c $$\nSince $\\delta$ is constant, this error accumulates linearly. After $n$ coarse steps, the total change in mass is:\n$$ M(n) - M_0 = n \\cdot \\Delta M_{\\text{step}} = -n \\delta A \\Delta t_c $$\nFinally, the dimensionless cumulative mass error $\\epsilon(n)$ is defined as $\\frac{M(n) - M_0}{M_0}$. Substituting our result for the total mass change gives the final expression:\n$$ \\epsilon(n) = \\frac{-n \\delta A \\Delta t_c}{M_0} $$",
            "answer": "$$\\boxed{-\\frac{n \\delta A \\Delta t_{c}}{M_{0}}}$$"
        },
        {
            "introduction": "When a new fine grid is created during a simulation, it must be initialized with data that is both accurate and consistent with its parent coarse grid. This practice guides you through the derivation of a second-order, conservative prolongation (or interpolation) operator, a fundamental component of the AMR toolkit. You will see how combining a local polynomial reconstruction of the coarse-grid data with a careful cell-averaging procedure ensures that the total amount of a conserved quantity is preserved during the transition from coarse to fine resolution.",
            "id": "4009052",
            "problem": "Adaptive Mesh Refinement (AMR) in Numerical Weather Prediction (NWP) and climate modeling requires prolongation operators that are both conservative and at least second-order accurate to prevent spurious creation or loss of scalar quantities such as tracer mass. Consider a finite-volume coarse cell centered at the origin, with uniform spacings $\\Delta x_c$ and $\\Delta y_c$ in the $x$- and $y$-directions, respectively. Let a dimensionless conserved scalar field be represented on the coarse level by the coarse cell average $\\bar{q}_c$. Assume a bilinear reconstruction within the coarse cell of the form\n$$\np(x,y) \\equiv \\bar{q}_c + S_x\\,x + S_y\\,y + S_{xy}\\,x\\,y,\n$$\nwhere $S_x$, $S_y$, and $S_{xy}$ are second-order accurate, coarse-level estimates of the local first derivatives and the mixed term coefficient, and $(x,y)$ are local coordinates measured from the coarse cell center with $x \\in [-\\Delta x_c/2,\\,\\Delta x_c/2]$ and $y \\in [-\\Delta y_c/2,\\,\\Delta y_c/2]$. The fine level is a factor-of-$2$ refinement in each spatial direction, producing four fine subcells by splitting at $x=0$ and $y=0$: the northeast (NE) subcell with $x \\in [0,\\,\\Delta x_c/2]$, $y \\in [0,\\,\\Delta y_c/2]$; the northwest (NW) subcell with $x \\in [-\\Delta x_c/2,\\,0]$, $y \\in [0,\\,\\Delta y_c/2]$; the southwest (SW) subcell with $x \\in [-\\Delta x_c/2,\\,0]$, $y \\in [-\\Delta y_c/2,\\,0]$; and the southeast (SE) subcell with $x \\in [0,\\,\\Delta x_c/2]$, $y \\in [-\\Delta y_c/2,\\,0]$.\n\nUsing only the finite-volume definition of a cell average and conservation principles, derive the second-order conservative prolongation stencil that maps the coarse cell average and bilinear coefficients to the four fine cell averages, defined as\n$$\n\\bar{q}_{R} \\equiv \\frac{1}{A_R} \\int_{R} p(x,y)\\, \\mathrm{d}A,\n$$\nfor each region $R \\in \\{\\mathrm{NE},\\mathrm{NW},\\mathrm{SW},\\mathrm{SE}\\}$ with area $A_R = (\\Delta x_c/2)(\\Delta y_c/2)$, and $\\mathrm{d}A = \\mathrm{d}x\\,\\mathrm{d}y$. Your final answers must be explicit analytic expressions for $\\bar{q}_{\\mathrm{NE}}$, $\\bar{q}_{\\mathrm{NW}}$, $\\bar{q}_{\\mathrm{SW}}$, and $\\bar{q}_{\\mathrm{SE}}$ in terms of $\\bar{q}_c$, $\\Delta x_c$, $\\Delta y_c$, $S_x$, $S_y$, and $S_{xy}$. Present your final answer as a single row matrix in the order $(\\bar{q}_{\\mathrm{NE}}, \\bar{q}_{\\mathrm{NW}}, \\bar{q}_{\\mathrm{SW}}, \\bar{q}_{\\mathrm{SE}})$. Express your answer exactly; no rounding or units are required.",
            "solution": "The fine cell averages are obtained by integrating the given bilinear reconstruction polynomial $p(x,y)$ over each of the four fine subcells and dividing by the subcell area, $A_R = (\\Delta x_c/2)(\\Delta y_c/2)$. For a generic subcell region $R$, the average $\\bar{q}_R$ is:\n$$\n\\bar{q}_{R} = \\frac{1}{A_R} \\int_{R} (\\bar{q}_c + S_x\\,x + S_y\\,y + S_{xy}\\,x\\,y)\\, \\mathrm{d}A\n$$\nBy linearity of integration, this becomes:\n$$\n\\bar{q}_{R} = \\bar{q}_c + \\frac{S_x}{A_R} \\int_{R} x\\, \\mathrm{d}A + \\frac{S_y}{A_R} \\int_{R} y\\, \\mathrm{d}A + \\frac{S_{xy}}{A_R} \\int_{R} xy\\, \\mathrm{d}A\n$$\nThe integral terms can be simplified. For any rectangular region $R$, the integral $\\int_R x \\, \\mathrm{d}A$ is equal to $A_R \\bar{x}_R$, where $\\bar{x}_R$ is the x-coordinate of the region's centroid. Similarly, $\\int_R y \\, \\mathrm{d}A = A_R \\bar{y}_R$ and $\\int_R xy \\, \\mathrm{d}A = A_R \\bar{x}_R \\bar{y}_R$. This simplifies the expression for the average to:\n$$\n\\bar{q}_R = \\bar{q}_c + S_x \\bar{x}_R + S_y \\bar{y}_R + S_{xy} \\bar{x}_R \\bar{y}_R\n$$\nWe now apply this general formula by calculating the centroid coordinates for each of the four fine subcells.\n\n1.  **Northeast (NE) subcell**: Domain is $x \\in [0, \\Delta x_c/2]$, $y \\in [0, \\Delta y_c/2]$. The centroid is $(\\bar{x}_{\\mathrm{NE}}, \\bar{y}_{\\mathrm{NE}}) = (\\frac{\\Delta x_c}{4}, \\frac{\\Delta y_c}{4})$.\n    $$\n    \\bar{q}_{\\mathrm{NE}} = \\bar{q}_c + S_x\\left(\\frac{\\Delta x_c}{4}\\right) + S_y\\left(\\frac{\\Delta y_c}{4}\\right) + S_{xy}\\left(\\frac{\\Delta x_c}{4}\\right)\\left(\\frac{\\Delta y_c}{4}\\right) = \\bar{q}_c + \\frac{S_x \\Delta x_c}{4} + \\frac{S_y \\Delta y_c}{4} + \\frac{S_{xy} \\Delta x_c \\Delta y_c}{16}\n    $$\n\n2.  **Northwest (NW) subcell**: Domain is $x \\in [-\\Delta x_c/2, 0]$, $y \\in [0, \\Delta y_c/2]$. The centroid is $(\\bar{x}_{\\mathrm{NW}}, \\bar{y}_{\\mathrm{NW}}) = (-\\frac{\\Delta x_c}{4}, \\frac{\\Delta y_c}{4})$.\n    $$\n    \\bar{q}_{\\mathrm{NW}} = \\bar{q}_c + S_x\\left(-\\frac{\\Delta x_c}{4}\\right) + S_y\\left(\\frac{\\Delta y_c}{4}\\right) + S_{xy}\\left(-\\frac{\\Delta x_c}{4}\\right)\\left(\\frac{\\Delta y_c}{4}\\right) = \\bar{q}_c - \\frac{S_x \\Delta x_c}{4} + \\frac{S_y \\Delta y_c}{4} - \\frac{S_{xy} \\Delta x_c \\Delta y_c}{16}\n    $$\n\n3.  **Southwest (SW) subcell**: Domain is $x \\in [-\\Delta x_c/2, 0]$, $y \\in [-\\Delta y_c/2, 0]$. The centroid is $(\\bar{x}_{\\mathrm{SW}}, \\bar{y}_{\\mathrm{SW}}) = (-\\frac{\\Delta x_c}{4}, -\\frac{\\Delta y_c}{4})$.\n    $$\n    \\bar{q}_{\\mathrm{SW}} = \\bar{q}_c + S_x\\left(-\\frac{\\Delta x_c}{4}\\right) + S_y\\left(-\\frac{\\Delta y_c}{4}\\right) + S_{xy}\\left(-\\frac{\\Delta x_c}{4}\\right)\\left(-\\frac{\\Delta y_c}{4}\\right) = \\bar{q}_c - \\frac{S_x \\Delta x_c}{4} - \\frac{S_y \\Delta y_c}{4} + \\frac{S_{xy} \\Delta x_c \\Delta y_c}{16}\n    $$\n\n4.  **Southeast (SE) subcell**: Domain is $x \\in [0, \\Delta x_c/2]$, $y \\in [-\\Delta y_c/2, 0]$. The centroid is $(\\bar{x}_{\\mathrm{SE}}, \\bar{y}_{\\mathrm{SE}}) = (\\frac{\\Delta x_c}{4}, -\\frac{\\Delta y_c}{4})$.\n    $$\n    \\bar{q}_{\\mathrm{SE}} = \\bar{q}_c + S_x\\left(\\frac{\\Delta x_c}{4}\\right) + S_y\\left(-\\frac{\\Delta y_c}{4}\\right) + S_{xy}\\left(\\frac{\\Delta x_c}{4}\\right)\\left(-\\frac{\\Delta y_c}{4}\\right) = \\bar{q}_c + \\frac{S_x \\Delta x_c}{4} - \\frac{S_y \\Delta y_c}{4} - \\frac{S_{xy} \\Delta x_c \\Delta y_c}{16}\n    $$\n\nThis set of equations forms the prolongation stencil. To confirm that it is conservative, we can check that the average of the four fine-cell averages equals the original coarse-cell average:\n$$ \\frac{1}{4}(\\bar{q}_{\\mathrm{NE}} + \\bar{q}_{\\mathrm{NW}} + \\bar{q}_{\\mathrm{SW}} + \\bar{q}_{\\mathrm{SE}}) = \\bar{q}_c $$\nThe terms involving $S_x$, $S_y$, and $S_{xy}$ cancel out in the summation, confirming the conservation property.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\bar{q}_c + \\frac{S_x \\Delta x_c}{4} + \\frac{S_y \\Delta y_c}{4} + \\frac{S_{xy} \\Delta x_c \\Delta y_c}{16}  \\bar{q}_c - \\frac{S_x \\Delta x_c}{4} + \\frac{S_y \\Delta y_c}{4} - \\frac{S_{xy} \\Delta x_c \\Delta y_c}{16}  \\bar{q}_c - \\frac{S_x \\Delta x_c}{4} - \\frac{S_y \\Delta y_c}{4} + \\frac{S_{xy} \\Delta x_c \\Delta y_c}{16}  \\bar{q}_c + \\frac{S_x \\Delta x_c}{4} - \\frac{S_y \\Delta y_c}{4} - \\frac{S_{xy} \\Delta x_c \\Delta y_c}{16}\n\\end{pmatrix}\n}\n$$"
        }
    ]
}