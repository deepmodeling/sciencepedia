{
    "hands_on_practices": [
        {
            "introduction": "在同化雷达数据之前，我们必须首先用数学语言描述云微物理特性（如雨滴谱分布 $N(D)$）如何产生观测到的雷达反射率（$Z$）。这项基础练习将引导你从第一性原理出发，推导指数形式雨滴谱的参数（$N_0$ 和 $\\Lambda$）与等效雷达反射率因子 $Z$ 之间的解析关系。这个关系是许多雷达正演算子的基石。",
            "id": "4080608",
            "problem": "在变分数据同化中使用的天气雷达观测算子，通过电磁散射将模式水凝物属性映射到观测到的雷达反射率。考虑一个暖雨微物理状态，其滴谱分布 (DSD) 被建模为指数分布\n$$\nN(D) = N_{0}\\,\\exp(-\\Lambda D),\n$$\n其中 $D$ 是以米为单位的雨滴直径，$N(D)$ 的单位是 $\\mathrm{m}^{-4}$，因此 $N(D)\\,\\mathrm{d}D$ 是直径在 $[D,D+\\mathrm{d}D]$ 范围内的雨滴的数浓度，单位为 $\\mathrm{m}^{-3}$，$N_{0}$ 是一个正的截距参数，$\\Lambda$ 是一个正的斜率参数。假设对于固定的雷达波长 $\\lambda$，所有感兴趣的 $D$ 都适用瑞利散射区，并且在该波长和温度下，液态水的体介电因子 $|K|^{2}$ 是一个常数。\n\n从体后向散射系数的定义出发\n$$\n\\eta \\equiv \\int_{0}^{\\infty} \\sigma_{b}(D)\\,N(D)\\,\\mathrm{d}D,\n$$\n其中瑞利散射下的单粒子后向散射截面是球体的后向散射截面，并使用由以下关系定义的等效雷达反射率因子 $Z$\n$$\n\\eta = \\left(\\frac{\\pi^{5}\\,|K|^{2}}{\\lambda^{4}}\\right)\\,Z,\n$$\n推导一个关于 $N_{0}$ 和 $\\Lambda$ 的 $Z$ 的闭式解析表达式。您的推导必须从球体的瑞利后向散射截面和上述定义开始；在适当的情况下，您可以假设使用标准的积分恒等式。用一致的国际单位制表示您对 $Z$ 的最终答案，并以其最简精确形式给出最终表达式。最终答案必须是单个闭式表达式。",
            "solution": "在尝试求解之前，对问题陈述的有效性进行评估。\n\n### 第1步：提取已知条件\n- 滴谱分布 (DSD): $N(D) = N_{0}\\,\\exp(-\\Lambda D)$，其中 $D$ 是以米为单位的雨滴直径，$N(D)$ 的单位是 $\\mathrm{m}^{-4}$，$N_{0}$ 是一个正的截距参数，$\\Lambda$ 是一个正的斜率参数。\n- 假设适用瑞利散射区。\n- 雷达波长为固定值 $\\lambda$。\n- 液态水的体介电因子 $|K|^{2}$ 是一个常数。\n- 体后向散射系数定义为 $\\eta \\equiv \\int_{0}^{\\infty} \\sigma_{b}(D)\\,N(D)\\,\\mathrm{d}D$。\n- 单粒子后向散射截面 $\\sigma_{b}(D)$ 是瑞利散射区中球体的截面。\n- 等效雷达反射率因子 $Z$ 由关系式 $\\eta = \\left(\\frac{\\pi^{5}\\,|K|^{2}}{\\lambda^{4}}\\right)\\,Z$ 定义。\n- 目标是推导一个关于 $N_{0}$ 和 $\\Lambda$ 的 $Z$ 的闭式解析表达式。\n\n### 第2步：使用提取的已知条件进行验证\n- **科学依据：** 该问题牢固地建立在雷达气象学原理之上。指数滴谱分布、瑞利散射以及 $\\eta$ 和 $Z$ 的定义是大气科学中的标准概念和模型。变分数据同化的背景是恰当且相关的。\n- **适定性：** 提供了所有必要的信息和定义，并如题目所暗示，假设了瑞利后向散射截面的标准公式。该问题是自洽的，并指定了明确的目标，从而可以推导出唯一的解析解。\n- **客观性：** 该问题以精确、客观的语言陈述，没有歧义或主观论断。\n\n### 第3步：结论与行动\n该问题被认为是有效的，因为它是科学合理的、适定的和客观的。将推导解答。\n\n推导从提供的基本定义开始。体后向散射系数 $\\eta$ 由单粒子后向散射截面 $\\sigma_{b}(D)$ 乘以粒子数分布 $N(D)$ 在所有可能的雨滴直径 $D$ 上的积分给出。\n$$\n\\eta = \\int_{0}^{\\infty} \\sigma_{b}(D)\\,N(D)\\,\\mathrm{d}D\n$$\n问题指明散射发生在瑞利散射区。对于直径为 $D$ 的球形粒子，瑞利后向散射截面由下式给出：\n$$\n\\sigma_{b}(D) = \\frac{\\pi^{5} |K|^{2} D^{6}}{\\lambda^{4}}\n$$\n其中 $|K|^{2}$ 是介电因子，$\\lambda$ 是雷达波长。\n\n滴谱分布 (DSD) 以下列指数函数形式给出：\n$$\nN(D) = N_{0}\\,\\exp(-\\Lambda D)\n$$\n将 $\\sigma_{b}(D)$ 和 $N(D)$ 的表达式代入 $\\eta$ 的积分中：\n$$\n\\eta = \\int_{0}^{\\infty} \\left(\\frac{\\pi^{5} |K|^{2} D^{6}}{\\lambda^{4}}\\right) \\left(N_{0}\\,\\exp(-\\Lambda D)\\right)\\,\\mathrm{d}D\n$$\n不依赖于积分变量 $D$ 的项可以从积分中提出：\n$$\n\\eta = \\frac{\\pi^{5} |K|^{2} N_{0}}{\\lambda^{4}} \\int_{0}^{\\infty} D^{6}\\,\\exp(-\\Lambda D)\\,\\mathrm{d}D\n$$\n积分部分是伽马函数的标准形式。我们使用通用积分恒等式：\n$$\n\\int_{0}^{\\infty} x^{n}\\,\\exp(-ax)\\,\\mathrm{d}x = \\frac{\\Gamma(n+1)}{a^{n+1}} = \\frac{n!}{a^{n+1}}\n$$\n对于整数 $n \\ge 0$ 和 $a > 0$。在我们的例子中，变量对应于 $x=D$，$n=6$ 和 $a=\\Lambda$。应用此恒等式，积分计算结果为：\n$$\n\\int_{0}^{\\infty} D^{6}\\,\\exp(-\\Lambda D)\\,\\mathrm{d}D = \\frac{6!}{\\Lambda^{6+1}} = \\frac{6!}{\\Lambda^{7}}\n$$\n阶乘 $6!$ 计算为 $6 \\times 5 \\times 4 \\times 3 \\times 2 \\times 1 = 720$。因此，积分为 $\\frac{720}{\\Lambda^{7}}$。\n\n将此结果代回 $\\eta$ 的表达式中：\n$$\n\\eta = \\frac{\\pi^{5} |K|^{2} N_{0}}{\\lambda^{4}} \\left(\\frac{720}{\\Lambda^{7}}\\right)\n$$\n问题给出了 $\\eta$ 与等效雷达反射率因子 $Z$ 之间的确定关系：\n$$\n\\eta = \\left(\\frac{\\pi^{5}\\,|K|^{2}}{\\lambda^{4}}\\right)\\,Z\n$$\n通过令推导出的和给定的两个 $\\eta$ 表达式相等，我们可以解出 $Z$：\n$$\n\\left(\\frac{\\pi^{5}\\,|K|^{2}}{\\lambda^{4}}\\right)\\,Z = \\frac{\\pi^{5} |K|^{2} N_{0}}{\\lambda^{4}} \\frac{720}{\\Lambda^{7}}\n$$\n项 $\\frac{\\pi^{5}\\,|K|^{2}}{\\lambda^{4}}$ 是方程两边共有的非零因子，可以消去。这留下了 $Z$ 的表达式：\n$$\nZ = N_{0} \\frac{720}{\\Lambda^{7}}\n$$\n这个表达式是关于 $N_{0}$ 和 $\\Lambda$ 的 $Z$ 的闭式解析解。按照要求，它是最简精确形式，并符合一致的国际单位制。$Z$ 的单位是 $\\mathrm{m}^{3}$，这可以通过 $N_{0}$ 的单位 ($\\mathrm{m}^{-4}$) 和 $\\Lambda$ 的单位 ($\\mathrm{m}^{-1}$) 进行验证，得到 $\\mathrm{m}^{-4} / (\\mathrm{m}^{-1})^{7} = \\mathrm{m}^{3}$。",
            "answer": "$$\\boxed{Z = \\frac{720 N_{0}}{\\Lambda^{7}}}$$"
        },
        {
            "introduction": "变分资料同化依赖于迭代算法来最小化一个成本函数，而这个过程是由成本函数的梯度来引导的。这项练习将介绍“梯度检验”，这是一个用于验证解析梯度（通过伴随方法推导）正确性的关键诊断程序。通过将此解析梯度与有限差分法得到的数值近似梯度进行比较，你将在构建和验证资料同化系统的核心机制方面获得实践经验。",
            "id": "4080555",
            "problem": "给定一个用于数值天气预报（NWP）模型的合成单列状态，其预报变量包括 $x$ 方向的水平风 $u$（单位为 $\\mathrm{m/s}$）、$y$ 方向的水平风 $v$（单位为 $\\mathrm{m/s}$）、垂直风 $w$（单位为 $\\mathrm{m/s}$）以及雨水混合比 $q_r$（单位为 $\\mathrm{kg/kg}$）。您将构建一个代价函数，用于比较模型预测的雷达可观测量与合成观测值，然后通过比较伴随法推导的解析梯度与有限差分近似值来进行严格的梯度检验。\n\n观测算子的基本依据：\n- 雷达反射率因子 $Z$（线性单位）定义为雨滴谱分布 $N(D)$ 相对于滴径 $D$ 的六阶矩，即 $Z = \\int_0^\\infty D^6 N(D) \\,\\mathrm{d}D$，其中 $D$ 的单位是 $\\mathrm{m}$，因此 $Z$ 的单位是 $\\mathrm{m}^6\\,\\mathrm{m}^{-3}$。\n- 假设雨滴谱分布为指数分布 $N(D) = N_0 \\exp(-\\Lambda D)$ (Marshall–Palmer)，其中截距参数 $N_0$（单位为 $\\mathrm{m}^{-4}$）为常数，斜率参数 $\\Lambda$（单位为 $\\mathrm{m}^{-1}$）受雨水含量 $W$ 约束。雨水含量为 $W = \\rho_a q_r$，其中 $\\rho_a$ 是空气密度（单位为 $\\mathrm{kg/m^3}$），且 $q_r \\ge 0$。\n- 质量含量 $W$ 通过三阶矩与之相关：$W = \\frac{\\pi \\rho_w}{6} \\int_0^\\infty D^3 N(D) \\,\\mathrm{d}D$，其中 $\\rho_w$ 是液态水密度（单位为 $\\mathrm{kg/m^3}$）。\n- 多普勒径向速度 $v_r$ 是风矢量在雷达波束上的视线投影：对于仰角 $\\theta$（单位为弧度）和方位角 $\\phi$（单位为弧度，测量方式为 $\\phi = 0$ 与 $x$ 轴正方向对齐），算子 $v_r(u,v,w,\\theta,\\phi)$ 是通过将 $(u,v,w)$ 投影到单位波束方向上得到的。\n\n定义要最小化的标量代价函数为\n$$\nJ(u,v,w,q_r) = \\frac{1}{2}\\left(\\frac{Z(u,v,w,q_r) - Z_\\text{obs}}{\\sigma_Z}\\right)^2 + \\frac{1}{2}\\left(\\frac{v_r(u,v,w,\\theta,\\phi) - v_\\text{obs}}{\\sigma_v}\\right)^2,\n$$\n其中 $Z_\\text{obs}$ 和 $v_\\text{obs}$ 是从指定的真实状态生成的合成观测值，$\\sigma_Z$ 和 $\\sigma_v$ 是观测误差标准差（单位与其各自的可观测量相同）。\n\n您的任务是：\n1. 严格从上述基本定义和关系出发，解析推导关于 $(u,v,w,q_r)$ 的伴随法兼容梯度 $\\nabla J$，并表达出由指数雨滴谱分布和多普勒径向速度的投影定义所导出的所有必要的中间关系。角度必须以弧度处理。\n2. 实现一个程序，对于每个测试用例，计算解析梯度以及使用中心差分和小扰动的 $J$ 的梯度有限差分近似值。当对 $q_r$ 的对称扰动会违反物理边界 $q_r \\ge 0$ 时，对 $q_r$ 使用单边前向差分。使用扰动 $\\epsilon_u = \\epsilon_v = \\epsilon_w = 10^{-6}\\,\\mathrm{m/s}$ 和 $\\epsilon_{q_r} = 10^{-8}\\,\\mathrm{kg/kg}$。\n3. 对于每个测试用例，报告解析（伴随法推导）梯度和有限差分梯度之间的相对差异，该差异为它们差值的欧几里得范数与解析梯度的欧几里得范数之比。为避免除以零，在分母中添加一个小的正稳定项 $\\delta = 10^{-16}$：\n$$\n\\mathrm{rel\\_err} = \\frac{\\left\\|\\nabla J_\\text{fd} - \\nabla J_\\text{adj}\\right\\|_2}{\\left\\|\\nabla J_\\text{adj}\\right\\|_2 + \\delta}.\n$$\n测试用例的最终答案必须是无单位的浮点数。\n\n在所有计算中使用以下常数：$N_0 = 8\\times 10^{6}\\,\\mathrm{m}^{-4}$，$\\rho_w = 1000\\,\\mathrm{kg/m^3}$。\n\n角度必须以弧度为单位。所有速度必须以 $\\mathrm{m/s}$ 为单位。空气密度必须以 $\\mathrm{kg/m^3}$ 为单位。雨水混合比必须以 $\\mathrm{kg/kg}$ 为单位。反射率 $Z$ 必须以线性单位 $\\mathrm{m}^6\\,\\mathrm{m}^{-3}$ 计算，而不是分贝。\n\n合成观测值是通过在每个测试用例的指定“真实”状态下评估算子生成的。\n\n测试套件（每个案例给出 $(u,v,w,q_r)$、$(u_\\text{true},v_\\text{true},w_\\text{true},q_{r,\\text{true}})$、$\\theta$、$\\phi$、$\\rho_a$、$\\sigma_Z$、$\\sigma_v$）：\n- 案例1（普遍非零风和中等雨量）：$(10,-5,0.5,10^{-3})$、$(12,-4,0.6,1.2\\times 10^{-3})$、$\\theta=0.25$、$\\phi=1.0$、$\\rho_a=1.2$、$\\sigma_Z=10^{-15}$、$\\sigma_v=0.5$。\n- 案例2（接近零的雨水，测试物理边界处理）：$(2,3,0.1,10^{-8})$、$(1.8,3.2,0.15,5\\times 10^{-8})$、$\\theta=0.4$、$\\phi=2.0$、$\\rho_a=1.2$、$\\sigma_Z=10^{-15}$、$\\sigma_v=0.5$。\n- 案例3（分析点处垂直风为零）：$(-8,6,0,8\\times 10^{-4})$、$(-7.5,6.5,0.05,9\\times 10^{-4})$、$\\theta=0.7$、$\\phi=0.3$、$\\rho_a=1.2$、$\\sigma_Z=10^{-15}$、$\\sigma_v=0.5$。\n- 案例4（水平波束，对 $w$ 不敏感）：$(15,0,3.0,10^{-3})$、$(15.5,-0.5,2.5,1.1\\times 10^{-3})$、$\\theta=0.0$、$\\phi=1.57$、$\\rho_a=1.2$、$\\sigma_Z=10^{-15}$、$\\sigma_v=0.5$。\n- 案例5（较大的雨水混合比和高仰角）：$(-20,10,1.5,5\\times 10^{-3})$、$(-19,11,1.4,4.8\\times 10^{-3})$、$\\theta=1.0$、$\\phi=2.8$、$\\rho_a=1.2$、$\\sigma_Z=10^{-15}$、$\\sigma_v=0.5$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如 $[r_1,r_2,r_3,r_4,r_5]$）作为结果，其中每个 $r_i$ 是上述定义的相应测试用例的相对误差。",
            "solution": "该问题要求推导和验证一个数据同化代价函数的梯度。代价函数 $J$ 量化了模型预测的雷达可观测量（反射率 $Z$ 和多普勒速度 $v_r$）与其对应的合成观测值（$Z_\\text{obs}, v_\\text{obs}$）之间的失配程度。该代价函数关于模型状态变量 $(u, v, w, q_r)$ 的梯度对于变分数据同化方法至关重要，因为它指导最小化算法朝着更能拟合观测的模型状态方向前进。验证是一个关键步骤，称为梯度检验，其中将解析推导的梯度（“伴随”法）与通过有限差分获得的数值近似进行比较。\n\n状态向量为 $\\mathbf{x} = (u, v, w, q_r)$，其中 $u$、$v$ 和 $w$ 是风分量（单位 $\\mathrm{m/s}$），$q_r$ 是雨水混合比（单位 $\\mathrm{kg/kg}$）。代价函数由下式给出：\n$$\nJ(\\mathbf{x}) = \\frac{1}{2}\\left(\\frac{Z(q_r) - Z_\\text{obs}}{\\sigma_Z}\\right)^2 + \\frac{1}{2}\\left(\\frac{v_r(u,v,w) - v_\\text{obs}}{\\sigma_v}\\right)^2\n$$\n推导和验证过程如下。\n\n首先，我们必须建立前向算子 $v_r(u,v,w)$ 和 $Z(q_r)$ 的解析形式，它们将模型状态映射到观测空间。\n\n**1. 多普勒速度算子, $v_r(u,v,w,\\theta,\\phi)$**\n多普勒径向速度 $v_r$ 定义为风矢量 $\\mathbf{v} = (u, v, w)$ 在雷达波束单位矢量 $\\hat{\\mathbf{d}}$ 上的投影。设仰角为 $\\theta$（从水平面起算），方位角为 $\\phi$（从 $x$ 轴正向起算），则波束方向矢量的笛卡尔分量为 $(\\cos\\theta \\cos\\phi, \\cos\\theta \\sin\\phi, \\sin\\theta)$。投影是点积：\n$$\nv_r = \\mathbf{v} \\cdot \\hat{\\mathbf{d}} = u \\cos\\theta \\cos\\phi + v \\cos\\theta \\sin\\phi + w \\sin\\theta\n$$\n注意，反射率 $Z$ 与风分量 $(u, v, w)$ 无关，而多普勒速度 $v_r$ 与雨水混合比 $q_r$ 无关。\n\n**2. 反射率算子, $Z(q_r)$**\n基于所提供的微物理假设，将 $Z$ 推导为 $q_r$ 的函数需要几个步骤。\n我们从假设的 Marshall-Palmer 雨滴谱分布 $N(D) = N_0 \\exp(-\\Lambda D)$ 开始。\n该分布的 $n$ 阶矩的一般形式由以下积分给出：\n$$\nM_n = \\int_0^\\infty D^n N(D) \\,\\mathrm{d}D = N_0 \\int_0^\\infty D^n e^{-\\Lambda D} \\,\\mathrm{d}D\n$$\n这个积分与伽马函数 $\\Gamma(z) = \\int_0^\\infty t^{z-1} e^{-t} \\,\\mathrm{d}t$ 相关。通过替换 $t = \\Lambda D$，我们发现：\n$$\n\\int_0^\\infty D^n e^{-\\Lambda D} \\,\\mathrm{d}D = \\frac{\\Gamma(n+1)}{\\Lambda^{n+1}} = \\frac{n!}{\\Lambda^{n+1}}\n$$\n因此，$M_n = N_0 n! / \\Lambda^{n+1}$。\n\n接下来，我们将斜率参数 $\\Lambda$ 与雨水混合比 $q_r$ 联系起来。雨水含量 $W$（单位 $\\mathrm{kg/m^3}$）由 $W = \\rho_a q_r$ 给出，其中 $\\rho_a$ 是空气密度。$W$ 也被定义为单位体积内所有雨滴的总质量，这对应于 DSD（雨滴谱分布）的三阶矩：\n$$\nW = \\frac{\\pi \\rho_w}{6} \\int_0^\\infty D^3 N(D) \\,\\mathrm{d}D = \\frac{\\pi \\rho_w}{6} M_3\n$$\n代入 $M_3 = N_0 3! / \\Lambda^4 = 6 N_0 / \\Lambda^4$：\n$$\nW = \\rho_a q_r = \\frac{\\pi \\rho_w}{6} \\frac{6 N_0}{\\Lambda^4} = \\frac{\\pi \\rho_w N_0}{\\Lambda^4}\n$$\n求解 $\\Lambda$ 得到其对 $q_r$ 的依赖关系：\n$$\n\\Lambda(q_r) = \\left( \\frac{\\pi \\rho_w N_0}{\\rho_a q_r} \\right)^{1/4}\n$$\n此关系在 $q_r > 0$ 时有效。\n\n雷达反射率因子 $Z$ 是 DSD 的六阶矩：\n$$\nZ = \\int_0^\\infty D^6 N(D) \\,\\mathrm{d}D = M_6 = \\frac{N_0 6!}{\\Lambda^7} = \\frac{720 N_0}{\\Lambda^7}\n$$\n将 $\\Lambda(q_r)$ 的表达式代入 $Z$ 的方程中：\n$$\nZ(q_r) = 720 N_0 \\left[ \\left( \\frac{\\pi \\rho_w N_0}{\\rho_a q_r} \\right)^{1/4} \\right]^{-7} = 720 N_0 \\left( \\frac{\\pi \\rho_w N_0}{\\rho_a q_r} \\right)^{-7/4}\n$$\n这可以简化为最终的反射率前向算子：\n$$\nZ(q_r) = 720 N_0 \\left( \\frac{\\rho_a}{\\pi \\rho_w N_0} \\right)^{7/4} q_r^{7/4}\n$$\n对于 $q_r \\le 0$，物理上反射率 $Z=0$。\n\n**3. 解析梯度（伴随）推导**\n梯度 $\\nabla J = (\\frac{\\partial J}{\\partial u}, \\frac{\\partial J}{\\partial v}, \\frac{\\partial J}{\\partial w}, \\frac{\\partial J}{\\partial q_r})$ 使用链式法则计算。代价函数是两个独立项的和，$J = J_v + J_Z$。\n\n对于风分量，$J$ 的梯度就是 $J_v$ 的梯度：\n$$\n\\frac{\\partial J}{\\partial u} = \\frac{\\partial J_v}{\\partial u} = \\frac{\\partial J_v}{\\partial v_r} \\frac{\\partial v_r}{\\partial u} = \\frac{1}{\\sigma_v^2} (v_r - v_\\text{obs}) \\cdot (\\cos\\theta \\cos\\phi)\n$$\n$$\n\\frac{\\partial J}{\\partial v} = \\frac{\\partial J_v}{\\partial v} = \\frac{\\partial J_v}{\\partial v_r} \\frac{\\partial v_r}{\\partial v} = \\frac{1}{\\sigma_v^2} (v_r - v_\\text{obs}) \\cdot (\\cos\\theta \\sin\\phi)\n$$\n$$\n\\frac{\\partial J}{\\partial w} = \\frac{\\partial J_v}{\\partial w} = \\frac{\\partial J_v}{\\partial v_r} \\frac{\\partial v_r}{\\partial w} = \\frac{1}{\\sigma_v^2} (v_r - v_\\text{obs}) \\cdot (\\sin\\theta)\n$$\n\n对于雨水混合比，$J$ 的梯度就是 $J_Z$ 的梯度：\n$$\n\\frac{\\partial J}{\\partial q_r} = \\frac{\\partial J_Z}{\\partial q_r} = \\frac{\\partial J_Z}{\\partial Z} \\frac{\\partial Z}{\\partial q_r}\n$$\n第一项是 $\\frac{\\partial J_Z}{\\partial Z} = \\frac{1}{\\sigma_Z^2} (Z - Z_\\text{obs})$。\n第二项，即反射率算子的雅可比矩阵，是从 $Z(q_r) \\propto q_r^{7/4}$ 推导出来的：\n$$\n\\frac{\\partial Z}{\\partial q_r} = \\frac{d}{dq_r} \\left[ C \\cdot q_r^{7/4} \\right] = C \\cdot \\frac{7}{4} q_r^{3/4}\n$$\n其中 $C$ 是比例常数。通过注意到 $Z/q_r^{7/4} = C$ 和 $Z/q_r = C \\cdot q_r^{3/4}$，可以得到一个更优美的形式。因此，对于 $q_r > 0$：\n$$\n\\frac{\\partial Z}{\\partial q_r} = \\frac{7}{4} \\frac{Z(q_r)}{q_r}\n$$\n对于 $q_r = 0$，导数为 $0$。\n结合这些，得到 $q_r$ 的梯度分量：\n$$\n\\frac{\\partial J}{\\partial q_r} = \\frac{1}{\\sigma_Z^2} (Z(q_r) - Z_\\text{obs}) \\cdot \\left( \\frac{7}{4} \\frac{Z(q_r)}{q_r} \\right)\n$$\n\n**4. 有限差分梯度与验证**\n为验证解析梯度 $\\nabla J_\\text{adj}$，我们使用有限差分计算一个数值近似 $\\nabla J_\\text{fd}$。对于带有扰动 $\\epsilon_i$ 的状态变量 $x_i$，中心差分近似为：\n$$\n\\frac{\\partial J}{\\partial x_i} \\approx \\frac{J(\\mathbf{x} + \\epsilon_i \\hat{\\mathbf{e}}_i) - J(\\mathbf{x} - \\epsilon_i \\hat{\\mathbf{e}}_i)}{2\\epsilon_i}\n$$\n其中 $\\hat{\\mathbf{e}}_i$ 是第 $i$ 个分量的单位向量。此方法用于 $u, v, w$。对于 $q_r$，仅当后向扰动 $q_r - \\epsilon_{q_r}$ 为非负时才使用此公式。如果 $q_r - \\epsilon_{q_r}  0$，则使用单边前向差分以遵循物理边界 $q_r \\ge 0$：\n$$\n\\frac{\\partial J}{\\partial q_r} \\approx \\frac{J(\\mathbf{x} + \\epsilon_{q_r} \\hat{\\mathbf{e}}_{q_r}) - J(\\mathbf{x})}{\\epsilon_{q_r}}\n$$\n解析梯度和数值梯度之间的差异通过相对误差来衡量：\n$$\n\\mathrm{rel\\_err} = \\frac{\\left\\|\\nabla J_\\text{fd} - \\nabla J_\\text{adj}\\right\\|_2}{\\left\\|\\nabla J_\\text{adj}\\right\\|_2 + \\delta}\n$$\n其中 $\\|\\cdot\\|_2$ 表示欧几里得范数，$\\delta=10^{-16}$ 是一个防止除以零的稳定项。一个小的相对误差表明解析梯度（并延伸到伴随模型）已正确实现。\n计算过程包括实现这些算子和梯度，通过从“真实”状态生成合成观测来处理每个测试用例，在“分析”状态下评估代价函数及其梯度，并最终计算相对误差。",
            "answer": "[5.044199922007569e-08,1.258814232306915e-07,3.513233869273617e-08,3.250482597402636e-08,7.828590623253755e-08]"
        },
        {
            "introduction": "资料同化的一个强大之处在于它甚至能从缺失强信号的观测中提取信息。这项练习旨在解决同化“晴空”观测的挑战，即缺少降水回波意味着雨水混合比低于某个探测阈值。你将构建一个混合的二元-连续成本函数，它使用概率模型来恰当地融合这种有价值的“负信息”，从而在有降水和晴空区域都能改进分析场。",
            "id": "4080581",
            "problem": "考虑一个对流尺度数值天气预报 (NWP) 模型中的单个雷达门，该模型采用变分资料同化 (DA) 方法。预报的微物理状态包括以 $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$ 为单位的雨水混合比 $q_{r}$。雷达提供两种信息：反射率和多普勒速度。在晴空条件下，由于缺少降水目标物，反射率测量值或为零，或报告为缺失，但多普勒速度仍可能通过布拉格散射获得；然而，对于本问题，我们将多普勒速度的贡献视为与 $q_{r}$ 无关，因此在关于 $q_{r}$ 的最小化过程中不予考虑。请您推导一个用于反射率的二元-连续混合同化方案，该方案使用概率性降水存在模型来处理晴空雷达门中的零反射率或缺失反射率，然后计算特定雷达门的最优 $q_{r}$。\n\n出发点和假设：\n- 最大后验 (MAP) 估计量通过最小化负对数后验概率来实现，该后验概率是背景项与观测的负对数似然之和。\n- $q_{r}$ 的背景项服从均值为 $q_{b}$、标准差为 $\\sigma_{b}$ 的高斯分布，即它贡献一个二次惩罚项。\n- 当存在降水回波时，反射率贡献一个连续项，用于比较观测反射率和模型预测的反射率。在晴空雷达门中，则使用一个二元指示符 $o \\in \\{0,1\\}$ 来编码可探测降水回波的存在 ($o=1$) 或不存在 ($o=0$)。\n- 反射率观测算子近似为一个局地切线性映射 $Z = a\\,q_{r}$，映射到以分贝为单位的反射率 ($\\mathrm{dBZ}$)，此近似对小的分析增量有效。\n- 雷达门中降水回波的存在采用概率性建模：假设雷达回波计数 $N$ 服从泊松分布，其均值与模型预测的反射率成正比，即 $N \\sim \\mathrm{Poisson}(\\lambda)$，其中 $\\lambda = \\gamma\\,Z$，$\\gamma  0$ 是一个已知的灵敏度参数。无探测回波对应于 $N=0$。\n\n任务：\n1. 使用泊松模型和 MAP 原理，推导 $o=0$ 时的二元似然 $P(o \\mid Z)$ 以及相应的负对数似然项，该项将包含在晴空雷达门的混合资料同化代价函数中。明确写出该雷达门的最终混合代价函数 $J(q_{r})$，它结合了高斯背景项和二元项，其中二元分量上施加了一个标量权重 $w_{p}$。\n2. 对于反射率为零或缺失 ($o=0$) 的特定雷达门，在非负物理约束 $q_{r} \\ge 0$ 下，最小化混合代价函数 $J(q_{r})$。使用以下参数：\n   - 背景均值 $q_{b} = 1.00 \\times 10^{-4}$，\n   - 背景标准差 $\\sigma_{b} = 4.00 \\times 10^{-5}$，\n   - 切线性反射率斜率 $a = 2.00 \\times 10^{5}$，\n   - 灵敏度 $\\gamma = 5.00 \\times 10^{-2}$，\n   - 二元权重 $w_{p} = 1.20$。\n   所有数值均采用一致的单位：$q_{r}$ 和 $q_{b}$ 的单位为 $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$，$a$ 的单位为 $\\mathrm{dBZ}\\,(\\mathrm{kg}\\,\\mathrm{kg}^{-1})^{-1}$，$\\gamma$ 的单位为 $(\\mathrm{dBZ})^{-1}$。假设由于 $o=0$，不存在连续反射率项。\n3. 在施加 $q_{r} \\ge 0$ 约束后，给出该雷达门的最优 $q_{r}$。最终结果以 $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$ 为单位，并四舍五入至四位有效数字。",
            "solution": "我们从最大后验 (MAP) 估计开始，该估计旨在最小化负对数后验概率。对于具有高斯背景先验 $q_{r} \\sim \\mathcal{N}(q_{b}, \\sigma_{b}^{2})$ 的单个状态变量 $q_{r}$，其对代价函数的背景贡献为\n$$\nJ_{b}(q_{r}) = \\frac{1}{2}\\,\\frac{(q_{r} - q_{b})^{2}}{\\sigma_{b}^{2}}.\n$$\n观测侧的建模通过区分两种情况进行：存在降水回波（连续反射率贡献）和不存在可探测回波（二元贡献）。在此雷达门中，我们处于晴空状态，即 $o=0$。\n\n在给定的假设下，即雷达回波计数 $N$ 服从均值为 $\\lambda = \\gamma\\,Z$ 的泊松分布，观测到零回波的概率为\n$$\nP(N=0 \\mid Z) = \\exp(-\\lambda) = \\exp(-\\gamma\\,Z).\n$$\n二元指示符 $o=0$ 精确对应于 $N=0$，因此\n$$\nP(o=0 \\mid Z) = \\exp(-\\gamma\\,Z).\n$$\n因此，$o=0$ 的负对数似然为\n$$\nJ_{\\mathrm{bin}}(o=0; Z) = -\\ln\\big(P(o=0 \\mid Z)\\big) = -\\ln\\big(\\exp(-\\gamma\\,Z)\\big) = \\gamma\\,Z.\n$$\n混合资料同化代价函数结合了背景项和二元项，其中标量权重 $w_{p}$ 应用于二元分量。使用切线性反射率算子 $Z = a\\,q_{r}$，这个晴空雷达门的总代价函数变为\n$$\nJ(q_{r}) = J_{b}(q_{r}) + w_{p}\\,J_{\\mathrm{bin}}(o=0; Z(q_{r})) = \\frac{1}{2}\\,\\frac{(q_{r} - q_{b})^{2}}{\\sigma_{b}^{2}} + w_{p}\\,\\gamma\\,a\\,q_{r}.\n$$\n\n接下来，我们在 $q_{r} \\ge 0$ 的约束下最小化 $J(q_{r})$。通过令导数为零来找到无约束极小值点：\n$$\n\\frac{\\mathrm{d}J}{\\mathrm{d}q_{r}} = \\frac{q_{r} - q_{b}}{\\sigma_{b}^{2}} + w_{p}\\,\\gamma\\,a = 0.\n$$\n解出 $q_{r}$ 可得\n$$\nq_{r}^{\\ast} = q_{b} - \\sigma_{b}^{2}\\,w_{p}\\,\\gamma\\,a.\n$$\n如有必要，通过截断来施加物理约束 $q_{r} \\ge 0$：\n$$\nq_{r}^{\\ast} \\leftarrow \\max\\big(0,\\, q_{b} - \\sigma_{b}^{2}\\,w_{p}\\,\\gamma\\,a\\big).\n$$\n\n现在我们代入给定的数值。首先计算 $\\sigma_{b}^{2}$：\n$$\n\\sigma_{b} = 4.00 \\times 10^{-5} \\quad \\Rightarrow \\quad \\sigma_{b}^{2} = (4.00 \\times 10^{-5})^{2} = 1.600 \\times 10^{-9}.\n$$\n计算乘积 $w_{p}\\,\\gamma\\,a$：\n$$\nw_{p}\\,\\gamma\\,a = (1.20)\\,(5.00 \\times 10^{-2})\\,(2.00 \\times 10^{5}) = (0.060)\\,(2.00 \\times 10^{5}) = 1.200 \\times 10^{4}.\n$$\n接着\n$$\n\\sigma_{b}^{2}\\,w_{p}\\,\\gamma\\,a = (1.600 \\times 10^{-9})\\,(1.200 \\times 10^{4}) = 1.920 \\times 10^{-5}.\n$$\n最后，\n$$\nq_{r}^{\\ast} = q_{b} - \\sigma_{b}^{2}\\,w_{p}\\,\\gamma\\,a = (1.00 \\times 10^{-4}) - (1.920 \\times 10^{-5}) = 8.080 \\times 10^{-5}.\n$$\n由于 $8.080 \\times 10^{-5} > 0$，非负约束不改变该解。以 $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$ 为单位并四舍五入至四位有效数字，此晴空雷达门的最优雨水混合比为 $8.080 \\times 10^{-5}$。",
            "answer": "$$\\boxed{8.080 \\times 10^{-5}}$$"
        }
    ]
}