{
    "hands_on_practices": [
        {
            "introduction": "数据同化的第一步是建立一个“正向算子”，它能将模式中的物理量（如云和降水）转换为雷达等仪器能够直接观测的量。本练习将引导你从最基本的微物理假设出发，即指数形式的雨滴谱分布，推导出雷达反射率因子 $Z$ 的解析表达式。通过这个推导 ，你将深入理解模式中的微物理参数（如 $N_0$ 和 $\\Lambda$）是如何与雷达观测值直接关联的，这是构建和理解观测算子的基础。",
            "id": "4080608",
            "problem": "在变分资料同化中使用的天气雷达观测算子，通过电磁散射将模式中的水凝物属性映射到观测的雷达反射率。考虑一个暖雨微物理状态，其滴谱分布 (DSD) 被建模为指数分布\n$$\nN(D) = N_{0}\\,\\exp(-\\Lambda D),\n$$\n其中 $D$ 是雨滴直径，单位为米，$N(D)$ 的单位是 $\\mathrm{m}^{-4}$，因此 $N(D)\\,\\mathrm{d}D$ 是直径在 $[D,D+\\mathrm{d}D]$ 区间内雨滴的数浓度，单位为 $\\mathrm{m}^{-3}$，$N_{0}$ 是一个正的截距参数，而 $\\Lambda$ 是一个正的斜率参数。假设对于固定的雷达波长 $\\lambda$，Rayleigh 散射机制适用于所有感兴趣的直径 $D$，并且在该波长和温度下，液态水的体介电因子 $|K|^{2}$ 是一个常数。\n\n从体后向散射系数的定义出发\n$$\n\\eta \\equiv \\int_{0}^{\\infty} \\sigma_{b}(D)\\,N(D)\\,\\mathrm{d}D,\n$$\n其中 Rayleigh 散射下单粒子的后向散射截面 $\\sigma_{b}(D)$ 是球体的截面，并使用等效雷达反射率因子 $Z$ 的定义关系式\n$$\n\\eta = \\left(\\frac{\\pi^{5}\\,|K|^{2}}{\\lambda^{4}}\\right)\\,Z,\n$$\n推导出一个用 $N_{0}$ 和 $\\Lambda$ 表示的 $Z$ 的闭式解析表达式。你的推导必须从球体的 Rayleigh 后向散射截面和上述定义开始；在适当的情况下，你可以使用标准的积分恒等式。请用国际单位制中的相干单位表示你最终的 $Z$ 答案，并给出其最简精确形式的最终表达式。最终答案必须是单个闭式表达式。",
            "solution": "在尝试求解之前，对问题陈述的有效性进行评估。\n\n### 第 1 步：提取已知条件\n- 滴谱分布 (DSD)：$N(D) = N_{0}\\,\\exp(-\\Lambda D)$，其中 $D$ 是雨滴直径，单位为米，$N(D)$ 的单位是 $\\mathrm{m}^{-4}$，$N_{0}$ 是一个正的截距参数，而 $\\Lambda$ 是一个正的斜率参数。\n- 假设适用 Rayleigh 散射机制。\n- 雷达波长是一个固定值 $\\lambda$。\n- 液态水的体介电因子 $|K|^{2}$ 是一个常数。\n- 体后向散射系数定义为 $\\eta \\equiv \\int_{0}^{\\infty} \\sigma_{b}(D)\\,N(D)\\,\\mathrm{d}D$。\n- 单粒子后向散射截面 $\\sigma_{b}(D)$ 是 Rayleigh 机制下球体的截面。\n- 等效雷达反射率因子 $Z$ 由关系式 $\\eta = \\left(\\frac{\\pi^{5}\\,|K|^{2}}{\\lambda^{4}}\\right)\\,Z$ 定义。\n- 目标是推导出一个用 $N_{0}$ 和 $\\Lambda$ 表示的 $Z$ 的闭式解析表达式。\n\n### 第 2 步：使用提取的已知条件进行验证\n- **科学依据：** 该问题坚实地基于雷达气象学原理。指数滴谱分布、Rayleigh 散射以及 $\\eta$ 和 $Z$ 的定义是大气科学中的标准概念和模型。变分资料同化的背景是恰当且相关的。\n- **适定性：** 提供了所有必要的信息和定义，并如题目所暗示，假定了 Rayleigh 后向散射截面的标准公式。问题是自洽的，并指定了明确的目标，从而可以推导出唯一的解析解。\n- **客观性：** 问题以精确、客观的语言陈述，没有歧义或主观论断。\n\n### 第 3 步：结论与行动\n问题被认为是有效的，因为它是科学合理的、适定的和客观的。将推导解答。\n\n推导从提供的基本定义开始。体后向散射系数 $\\eta$ 由单粒子后向散射截面 $\\sigma_{b}(D)$ 乘以粒子数分布 $N(D)$ 后，对所有可能的雨滴直径 $D$ 进行积分得到。\n$$\n\\eta = \\int_{0}^{\\infty} \\sigma_{b}(D)\\,N(D)\\,\\mathrm{d}D\n$$\n问题指明散射发生在 Rayleigh 机制下。对于直径为 $D$ 的球形粒子，其 Rayleigh 后向散射截面由下式给出：\n$$\n\\sigma_{b}(D) = \\frac{\\pi^{5} |K|^{2} D^{6}}{\\lambda^{4}}\n$$\n其中 $|K|^{2}$ 是介电因子，$\\lambda$ 是雷达波长。\n\n滴谱分布 (DSD) 以下列指数函数形式给出：\n$$\nN(D) = N_{0}\\,\\exp(-\\Lambda D)\n$$\n将 $\\sigma_{b}(D)$ 和 $N(D)$ 的表达式代入 $\\eta$ 的积分中：\n$$\n\\eta = \\int_{0}^{\\infty} \\left(\\frac{\\pi^{5} |K|^{2} D^{6}}{\\lambda^{4}}\\right) \\left(N_{0}\\,\\exp(-\\Lambda D)\\right)\\,\\mathrm{d}D\n$$\n不依赖于积分变量 $D$ 的项可以从积分中提出：\n$$\n\\eta = \\frac{\\pi^{5} |K|^{2} N_{0}}{\\lambda^{4}} \\int_{0}^{\\infty} D^{6}\\,\\exp(-\\Lambda D)\\,\\mathrm{d}D\n$$\n积分部分是 Gamma 函数的标准形式。我们使用以下通用积分恒等式：\n$$\n\\int_{0}^{\\infty} x^{n}\\,\\exp(-ax)\\,\\mathrm{d}x = \\frac{\\Gamma(n+1)}{a^{n+1}} = \\frac{n!}{a^{n+1}}\n$$\n对于整数 $n \\ge 0$ 和 $a  0$。在我们的例子中，变量对应为 $x=D$，$n=6$，以及 $a=\\Lambda$。应用此恒等式，积分计算结果为：\n$$\n\\int_{0}^{\\infty} D^{6}\\,\\exp(-\\Lambda D)\\,\\mathrm{d}D = \\frac{6!}{\\Lambda^{6+1}} = \\frac{6!}{\\Lambda^{7}}\n$$\n阶乘 $6!$ 的计算结果为 $6 \\times 5 \\times 4 \\times 3 \\times 2 \\times 1 = 720$。因此，积分为 $\\frac{720}{\\Lambda^{7}}$。\n\n将此结果代回 $\\eta$ 的表达式中：\n$$\n\\eta = \\frac{\\pi^{5} |K|^{2} N_{0}}{\\lambda^{4}} \\left(\\frac{720}{\\Lambda^{7}}\\right)\n$$\n问题给出了 $\\eta$ 与等效雷达反射率因子 $Z$ 之间的确定关系：\n$$\n\\eta = \\left(\\frac{\\pi^{5}\\,|K|^{2}}{\\lambda^{4}}\\right)\\,Z\n$$\n通过令两个推导出的和给定的 $\\eta$ 表达式相等，我们可以解出 $Z$：\n$$\n\\left(\\frac{\\pi^{5}\\,|K|^{2}}{\\lambda^{4}}\\right)\\,Z = \\frac{\\pi^{5} |K|^{2} N_{0}}{\\lambda^{4}} \\frac{720}{\\Lambda^{7}}\n$$\n项 $\\frac{\\pi^{5}\\,|K|^{2}}{\\lambda^{4}}$ 是等式两边共有的一个非零因子，可以消去。这留下了 $Z$ 的表达式：\n$$\nZ = N_{0} \\frac{720}{\\Lambda^{7}}\n$$\n该表达式是用 $N_{0}$ 和 $\\Lambda$ 表示的 $Z$ 的闭式解析解。按照要求，它处于最简精确形式，并符合国际单位制中的相干单位。$Z$ 的单位是 $\\mathrm{m}^{3}$，这可以通过 $N_{0}$ 的单位（$\\mathrm{m}^{-4}$）和 $\\Lambda$ 的单位（$\\mathrm{m}^{-1}$）来验证，得到 $\\mathrm{m}^{-4} / (\\mathrm{m}^{-1})^{7} = \\mathrm{m}^{3}$。",
            "answer": "$$\\boxed{\\frac{720 N_{0}}{\\Lambda^{7}}}$$"
        },
        {
            "introduction": "在变分数据同化中，我们通过最小化一个成本函数来寻找最优的模式状态，而这个最小化过程依赖于成本函数梯度的精确计算。本练习  模拟了资料同化系统开发中的一个核心环节：梯度检验。你将需要首先推导成本函数的解析梯度（即伴随方法），然后通过有限差分法进行数值近似，并比较两者的一致性，这是确保复杂的伴随模式代码正确无误的黄金标准。",
            "id": "4080555",
            "problem": "给定一个数值天气预报（NWP）模式的合成单柱状态，其预报变量为$x$方向的水平风$u$（单位：$\\mathrm{m/s}$）、$y$方向的水平风$v$（单位：$\\mathrm{m/s}$）、垂直风$w$（单位：$\\mathrm{m/s}$）以及雨水混合比$q_r$（单位：$\\mathrm{kg/kg}$）。您将构建一个代价函数，用于比较模式预测的雷达可观测量与合成观测，然后通过比较伴随法推导的解析梯度和有限差分近似来进行严格的梯度检验。\n\n观测算子的基本基础：\n- 雷达反射率因子 $Z$（线性单位）定义为雨滴谱分布 $N(D)$ 相对于雨滴直径 $D$ 的六阶矩，即 $Z = \\int_0^\\infty D^6 N(D) \\,\\mathrm{d}D$，其中 $D$ 的单位是 $\\mathrm{m}$，因此 $Z$ 的单位是 $\\mathrm{m}^6\\,\\mathrm{m}^{-3}$。\n- 假设雨滴谱分布为指数型 $N(D) = N_0 \\exp(-\\Lambda D)$（Marshall–Palmer 分布），其中截距参数 $N_0$（单位：$\\mathrm{m}^{-4}$）为常数，斜率参数 $\\Lambda$（单位：$\\mathrm{m}^{-1}$）受雨水含量 $W$ 的约束。雨水含量为 $W = \\rho_a q_r$，其中 $\\rho_a$ 是空气密度（单位：$\\mathrm{kg/m^3}$），且 $q_r \\ge 0$。\n- 质量含量 $W$ 通过三阶矩与以下关系式相关联：$W = \\frac{\\pi \\rho_w}{6} \\int_0^\\infty D^3 N(D) \\,\\mathrm{d}D$，其中 $\\rho_w$ 是液态水密度（单位：$\\mathrm{kg/m^3}$）。\n- 多普勒径向速度 $v_r$ 是风矢量在雷达波束上的视线投影：对于仰角 $\\theta$（单位：弧度）和方位角 $\\phi$（单位：弧度，测量方式为 $\\phi = 0$ 与 $x$ 轴正方向对齐），算子为 $v_r(u,v,w,\\theta,\\phi)$，通过将 $(u,v,w)$ 投影到单位波束方向上得到。\n\n定义待最小化的标量代价函数为\n$$\nJ(u,v,w,q_r) = \\frac{1}{2}\\left(\\frac{Z(u,v,w,q_r) - Z_\\text{obs}}{\\sigma_Z}\\right)^2 + \\frac{1}{2}\\left(\\frac{v_r(u,v,w,\\theta,\\phi) - v_\\text{obs}}{\\sigma_v}\\right)^2,\n$$\n其中 $Z_\\text{obs}$ 和 $v_\\text{obs}$ 是从指定的真实状态生成的合成观测，$\\sigma_Z$ 和 $\\sigma_v$ 是观测误差标准差（单位与其各自的可观测量相同）。\n\n您的任务是：\n1. 严格从上述基本定义和关系出发，解析推导伴随法兼容的梯度 $\\nabla J$ 关于 $(u,v,w,q_r)$ 的表达式，并写出由指数型雨滴谱分布和多普勒径向速度的投影定义所导出的所有必需的中间关系。角度必须以弧度处理。\n2. 实现一个程序，为每个测试案例计算解析梯度以及使用中心差分和小扰动对 $J$ 的梯度进行有限差分近似。当对 $q_r$ 进行对称扰动会违反物理边界 $q_r \\ge 0$ 时，对 $q_r$ 使用单边前向差分。使用扰动 $\\epsilon_u = \\epsilon_v = \\epsilon_w = 10^{-6}\\,\\mathrm{m/s}$ 和 $\\epsilon_{q_r} = 10^{-8}\\,\\mathrm{kg/kg}$。\n3. 对每个测试案例，报告解析（伴随法推导）梯度与有限差分梯度之间的相对差异，该差异定义为它们差值的欧几里得范数与解析梯度的欧几里得范数之比。为避免除以零，在分母中加入一个小的正常数稳定项 $\\delta = 10^{-16}$：\n$$\n\\mathrm{rel\\_err} = \\frac{\\left\\|\\nabla J_\\text{fd} - \\nabla J_\\text{adj}\\right\\|_2}{\\left\\|\\nabla J_\\text{adj}\\right\\|_2 + \\delta}.\n$$\n测试案例的最终答案必须是无单位的浮点数。\n\n在所有计算中使用以下常量：$N_0 = 8\\times 10^{6}\\,\\mathrm{m}^{-4}$，$\\rho_w = 1000\\,\\mathrm{kg/m^3}$。\n\n角度单位必须是弧度。所有速度单位必须是 $\\mathrm{m/s}$。空气密度单位必须是 $\\mathrm{kg/m^3}$。雨水混合比单位必须是 $\\mathrm{kg/kg}$。反射率 $Z$ 必须以线性单位 $\\mathrm{m}^6\\,\\mathrm{m}^{-3}$ 计算，而不是分贝。\n\n合成观测是通过在每个测试案例指定的“真实”状态下评估算子来生成的。\n\n测试套件（每个案例给出 $(u,v,w,q_r)$、$(u_\\text{true},v_\\text{true},w_\\text{true},q_{r,\\text{true}})$、$\\theta$、$\\phi$、$\\rho_a$、$\\sigma_Z$、$\\sigma_v$）：\n- 案例 1（普遍非零风和中等雨量）：$(10,-5,0.5,10^{-3})$、$(12,-4,0.6,1.2\\times 10^{-3})$、$\\theta=0.25$、$\\phi=1.0$、$\\rho_a=1.2$、$\\sigma_Z=10^{-15}$、$\\sigma_v=0.5$。\n- 案例 2（接近零的雨水，测试物理边界处理）：$(2,3,0.1,10^{-8})$、$(1.8,3.2,0.15,5\\times 10^{-8})$、$\\theta=0.4$、$\\phi=2.0$、$\\rho_a=1.2$、$\\sigma_Z=10^{-15}$、$\\sigma_v=0.5$。\n- 案例 3（分析点垂直风为零）：$(-8,6,0,8\\times 10^{-4})$、$(-7.5,6.5,0.05,9\\times 10^{-4})$、$\\theta=0.7$、$\\phi=0.3$、$\\rho_a=1.2$、$\\sigma_Z=10^{-15}$、$\\sigma_v=0.5$。\n- 案例 4（水平波束，对 $w$ 不敏感）：$(15,0,3.0,10^{-3})$、$(15.5,-0.5,2.5,1.1\\times 10^{-3})$、$\\theta=0.0$、$\\phi=1.57$、$\\rho_a=1.2$、$\\sigma_Z=10^{-15}$、$\\sigma_v=0.5$。\n- 案例 5（较大的雨水混合比和高仰角）：$(-20,10,1.5,5\\times 10^{-3})$、$(-19,11,1.4,4.8\\times 10^{-3})$、$\\theta=1.0$、$\\phi=2.8$、$\\rho_a=1.2$、$\\sigma_Z=10^{-15}$、$\\sigma_v=0.5$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如 $[r_1,r_2,r_3,r_4,r_5]$）作为结果，其中每个 $r_i$ 是上述定义的相应测试案例的相对误差。",
            "solution": "该问题要求推导和验证一个数据同化代价函数的梯度。代价函数 $J$ 量化了模式预测的雷达可观测量（反射率 $Z$ 和多普勒速度 $v_r$）与其对应的合成观测（$Z_\\text{obs}, v_\\text{obs}$）之间的差异。该代价函数相对于模式状态变量 $(u, v, w, q_r)$ 的梯度对于变分数据同化方法至关重要，因为它指导最小化算法朝向一个能更好拟合观测的模式状态。验证是一个关键步骤，称为梯度检验，其中将解析推导的梯度（“伴随”法）与通过有限差分获得的数值近似进行比较。\n\n状态向量为 $\\mathbf{x} = (u, v, w, q_r)$，其中 $u$、$v$ 和 $w$ 是以 $\\mathrm{m/s}$ 为单位的风分量，$q_r$ 是以 $\\mathrm{kg/kg}$ 为单位的雨水混合比。代价函数由下式给出：\n$$\nJ(\\mathbf{x}) = \\frac{1}{2}\\left(\\frac{Z(q_r) - Z_\\text{obs}}{\\sigma_Z}\\right)^2 + \\frac{1}{2}\\left(\\frac{v_r(u,v,w) - v_\\text{obs}}{\\sigma_v}\\right)^2\n$$\n推导和验证过程如下。\n\n首先，我们必须建立前向算子 $v_r(u,v,w)$ 和 $Z(q_r)$ 的解析形式，它们将模式状态映射到观测空间。\n\n**1. 多普勒速度算子，$v_r(u,v,w,\\theta,\\phi)$**\n多普勒径向速度 $v_r$ 定义为风矢量 $\\mathbf{v} = (u, v, w)$ 在雷达波束方向单位矢量 $\\hat{\\mathbf{d}}$ 上的投影。设仰角为 $\\theta$（从水平面起算），方位角为 $\\phi$（从 $x$ 轴正向起算），波束方向矢量的笛卡尔分量为 $(\\cos\\theta \\cos\\phi, \\cos\\theta \\sin\\phi, \\sin\\theta)$。投影即为点积：\n$$\nv_r = \\mathbf{v} \\cdot \\hat{\\mathbf{d}} = u \\cos\\theta \\cos\\phi + v \\cos\\theta \\sin\\phi + w \\sin\\theta\n$$\n请注意，反射率 $Z$ 与风分量 $(u, v, w)$ 无关，而多普勒速度 $v_r$ 与雨水混合比 $q_r$ 无关。\n\n**2. 反射率算子，$Z(q_r)$**\n基于所提供的微物理假设，将 $Z$ 推导为 $q_r$ 的函数需要几个步骤。\n我们从假设的 Marshall-Palmer 雨滴谱分布 $N(D) = N_0 \\exp(-\\Lambda D)$ 开始。\n该分布的 $n$ 阶矩的一般形式由以下积分给出：\n$$\nM_n = \\int_0^\\infty D^n N(D) \\,\\mathrm{d}D = N_0 \\int_0^\\infty D^n e^{-\\Lambda D} \\,\\mathrm{d}D\n$$\n该积分与伽马函数 $\\Gamma(z) = \\int_0^\\infty t^{z-1} e^{-t} \\,\\mathrm{d}t$ 相关。通过替换 $t = \\Lambda D$，我们得到：\n$$\n\\int_0^\\infty D^n e^{-\\Lambda D} \\,\\mathrm{d}D = \\frac{\\Gamma(n+1)}{\\Lambda^{n+1}} = \\frac{n!}{\\Lambda^{n+1}}\n$$\n因此，$M_n = N_0 n! / \\Lambda^{n+1}$。\n\n接下来，我们将斜率参数 $\\Lambda$ 与雨水混合比 $q_r$ 联系起来。雨水含量 $W$（单位：$\\mathrm{kg/m^3}$）由 $W = \\rho_a q_r$ 给出，其中 $\\rho_a$ 是空气密度。$W$ 也定义为单位体积内所有雨滴的质量，这对应于 DSD（雨滴谱分布）的三阶矩：\n$$\nW = \\frac{\\pi \\rho_w}{6} \\int_0^\\infty D^3 N(D) \\,\\mathrm{d}D = \\frac{\\pi \\rho_w}{6} M_3\n$$\n代入 $M_3 = N_0 3! / \\Lambda^4 = 6 N_0 / \\Lambda^4$：\n$$\nW = \\rho_a q_r = \\frac{\\pi \\rho_w}{6} \\frac{6 N_0}{\\Lambda^4} = \\frac{\\pi \\rho_w N_0}{\\Lambda^4}\n$$\n求解 $\\Lambda$ 得到其对 $q_r$ 的依赖关系：\n$$\n\\Lambda(q_r) = \\left( \\frac{\\pi \\rho_w N_0}{\\rho_a q_r} \\right)^{1/4}\n$$\n该关系在 $q_r > 0$ 时有效。\n\n雷达反射率因子 $Z$ 是 DSD 的六阶矩：\n$$\nZ = \\int_0^\\infty D^6 N(D) \\,\\mathrm{d}D = M_6 = \\frac{N_0 6!}{\\Lambda^7} = \\frac{720 N_0}{\\Lambda^7}\n$$\n将 $\\Lambda(q_r)$ 的表达式代入 $Z$ 的方程中：\n$$\nZ(q_r) = 720 N_0 \\left[ \\left( \\frac{\\pi \\rho_w N_0}{\\rho_a q_r} \\right)^{1/4} \\right]^{-7} = 720 N_0 \\left( \\frac{\\pi \\rho_w N_0}{\\rho_a q_r} \\right)^{-7/4}\n$$\n这可以简化为最终的反射率前向算子：\n$$\nZ(q_r) = 720 N_0 \\left( \\frac{\\rho_a}{\\pi \\rho_w N_0} \\right)^{7/4} q_r^{7/4}\n$$\n对于 $q_r \\le 0$，物理上反射率 $Z=0$。\n\n**3. 解析梯度（伴随）推导**\n梯度 $\\nabla J = (\\frac{\\partial J}{\\partial u}, \\frac{\\partial J}{\\partial v}, \\frac{\\partial J}{\\partial w}, \\frac{\\partial J}{\\partial q_r})$ 使用链式法则计算。代价函数是两个独立项的和，$J = J_v + J_Z$。\n\n对于风分量，$J$ 的梯度就是 $J_v$ 的梯度：\n$$\n\\frac{\\partial J}{\\partial u} = \\frac{\\partial J_v}{\\partial u} = \\frac{\\partial J_v}{\\partial v_r} \\frac{\\partial v_r}{\\partial u} = \\frac{1}{\\sigma_v^2} (v_r - v_\\text{obs}) \\cdot (\\cos\\theta \\cos\\phi)\n$$\n$$\n\\frac{\\partial J}{\\partial v} = \\frac{\\partial J_v}{\\partial v} = \\frac{\\partial J_v}{\\partial v_r} \\frac{\\partial v_r}{\\partial v} = \\frac{1}{\\sigma_v^2} (v_r - v_\\text{obs}) \\cdot (\\cos\\theta \\sin\\phi)\n$$\n$$\n\\frac{\\partial J}{\\partial w} = \\frac{\\partial J_v}{\\partial w} = \\frac{\\partial J_v}{\\partial v_r} \\frac{\\partial v_r}{\\partial w} = \\frac{1}{\\sigma_v^2} (v_r - v_\\text{obs}) \\cdot (\\sin\\theta)\n$$\n\n对于雨水混合比，$J$ 的梯度是 $J_Z$ 的梯度：\n$$\n\\frac{\\partial J}{\\partial q_r} = \\frac{\\partial J_Z}{\\partial q_r} = \\frac{\\partial J_Z}{\\partial Z} \\frac{\\partial Z}{\\partial q_r}\n$$\n第一项是 $\\frac{\\partial J_Z}{\\partial Z} = \\frac{1}{\\sigma_Z^2} (Z - Z_\\text{obs})$。\n第二项，即反射率算子的雅可比矩阵，从 $Z(q_r) \\propto q_r^{7/4}$ 推导得出：\n$$\n\\frac{\\partial Z}{\\partial q_r} = \\frac{d}{dq_r} \\left[ C \\cdot q_r^{7/4} \\right] = C \\cdot \\frac{7}{4} q_r^{3/4}\n$$\n其中 $C$ 是比例常数。通过注意到 $Z/q_r = C \\cdot q_r^{3/4}$ 可以得到一个更优雅的形式。因此，对于 $q_r  0$：\n$$\n\\frac{\\partial Z}{\\partial q_r} = \\frac{7}{4} \\frac{Z(q_r)}{q_r}\n$$\n对于 $q_r = 0$，导数为 $0$。\n将这些结合起来，得到 $q_r$ 的梯度分量：\n$$\n\\frac{\\partial J}{\\partial q_r} = \\frac{1}{\\sigma_Z^2} (Z(q_r) - Z_\\text{obs}) \\cdot \\left( \\frac{7}{4} \\frac{Z(q_r)}{q_r} \\right)\n$$\n\n**4. 有限差分梯度与验证**\n为了验证解析梯度 $\\nabla J_\\text{adj}$，我们使用有限差分计算一个数值近似 $\\nabla J_\\text{fd}$。对于状态变量 $x_i$ 及其扰动 $\\epsilon_i$，中心差分近似为：\n$$\n\\frac{\\partial J}{\\partial x_i} \\approx \\frac{J(\\mathbf{x} + \\epsilon_i \\hat{\\mathbf{e}}_i) - J(\\mathbf{x} - \\epsilon_i \\hat{\\mathbf{e}}_i)}{2\\epsilon_i}\n$$\n其中 $\\hat{\\mathbf{e}}_i$ 是第 $i$ 个分量的单位向量。该方法用于 $u, v, w$。对于 $q_r$，只有当反向扰动 $q_r - \\epsilon_{q_r}$ 为非负时才使用此公式。如果 $q_r - \\epsilon_{q_r}  0$，则使用单边前向差分以遵守物理边界 $q_r \\ge 0$：\n$$\n\\frac{\\partial J}{\\partial q_r} \\approx \\frac{J(\\mathbf{x} + \\epsilon_{q_r} \\hat{\\mathbf{e}}_{q_r}) - J(\\mathbf{x})}{\\epsilon_{q_r}}\n$$\n解析梯度与数值梯度之间的差异通过相对误差来衡量：\n$$\n\\mathrm{rel\\_err} = \\frac{\\left\\|\\nabla J_\\text{fd} - \\nabla J_\\text{adj}\\right\\|_2}{\\left\\|\\nabla J_\\text{adj}\\right\\|_2 + \\delta}\n$$\n其中 $\\|\\cdot\\|_2$ 表示欧几里得范数，$\\delta=10^{-16}$ 是一个稳定项，用于防止除以零。一个小的相对误差表明解析梯度（并延伸到伴随模式）已正确实现。\n计算流程包括实现这些算子和梯度，通过从“真实”状态生成合成观测来处理每个测试案例，在“分析”状态下评估代价函数及其梯度，并最终计算相对误差。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to perform gradient checks for the radar data assimilation problem.\n    \"\"\"\n    # Define physical and numerical constants\n    N0 = 8.0e6  # Marshall-Palmer intercept parameter (m^-4)\n    RHO_W = 1000.0  # Density of liquid water (kg/m^3)\n    PI = np.pi\n    DELTA_STABILIZER = 1.0e-16\n\n    # Perturbations for finite-difference calculations\n    PERTURBATIONS = {\n        'u': 1.0e-6,\n        'v': 1.0e-6,\n        'w': 1.0e-6,\n        'qr': 1.0e-8,\n    }\n\n    # Test cases as provided in the problem statement\n    # Each tuple contains:\n    # (analysis_state, true_state, radar_params, atmosphere_params, error_std_devs)\n    # state = (u, v, w, qr)\n    # radar_params = (theta, phi)\n    # atmosphere_params = (rho_a,)\n    # error_std_devs = (sigma_Z, sigma_v)\n    test_cases = [\n        # Case 1\n        ((10.0, -5.0, 0.5, 1.0e-3), (12.0, -4.0, 0.6, 1.2e-3),\n         (0.25, 1.0), (1.2,), (1.0e-15, 0.5)),\n        # Case 2\n        ((2.0, 3.0, 0.1, 1.0e-8), (1.8, 3.2, 0.15, 5.0e-8),\n         (0.4, 2.0), (1.2,), (1.0e-15, 0.5)),\n        # Case 3\n        ((-8.0, 6.0, 0.0, 8.0e-4), (-7.5, 6.5, 0.05, 9.0e-4),\n         (0.7, 0.3), (1.2,), (1.0e-15, 0.5)),\n        # Case 4\n        ((15.0, 0.0, 3.0, 1.0e-3), (15.5, -0.5, 2.5, 1.1e-3),\n         (0.0, 1.57), (1.2,), (1.0e-15, 0.5)),\n        # Case 5\n        ((-20.0, 10.0, 1.5, 5.0e-3), (-19.0, 11.0, 1.4, 4.8e-3),\n         (1.0, 2.8), (1.2,), (1.0e-15, 0.5)),\n    ]\n\n    # --- Forward Operators ---\n    def calculate_Z(qr, rho_a):\n        \"\"\"Computes radar reflectivity Z from rainwater mixing ratio qr.\"\"\"\n        if qr = 0.0:\n            return 0.0\n        # Z = 720 * N0 * (rho_a * qr / (pi * rho_w * N0))**(7/4)\n        factor = (rho_a / (PI * RHO_W * N0))\n        return 720.0 * N0 * (factor**1.75) * (qr**1.75)\n\n    def calculate_vr(u, v, w, theta, phi):\n        \"\"\"Computes Doppler radial velocity vr from wind components.\"\"\"\n        return (u * np.cos(theta) * np.cos(phi) +\n                v * np.cos(theta) * np.sin(phi) +\n                w * np.sin(theta))\n\n    # --- Cost Function ---\n    def cost_function(state, Z_obs, v_obs, params):\n        \"\"\"Computes the scalar cost function J.\"\"\"\n        u, v, w, qr = state\n        theta, phi, rho_a, sigma_Z, sigma_v = params\n        \n        Z_model = calculate_Z(qr, rho_a)\n        vr_model = calculate_vr(u, v, w, theta, phi)\n        \n        J_Z = 0.5 * ((Z_model - Z_obs) / sigma_Z)**2\n        J_v = 0.5 * ((vr_model - v_obs) / sigma_v)**2\n        \n        return J_Z + J_v\n\n    # --- Gradient Calculations ---\n    def analytical_gradient(state, Z_obs, v_obs, params):\n        \"\"\"Computes the analytical gradient of J (adjoint method).\"\"\"\n        u, v, w, qr = state\n        theta, phi, rho_a, sigma_Z, sigma_v = params\n        \n        Z_model = calculate_Z(qr, rho_a)\n        vr_model = calculate_vr(u, v, w, theta, phi)\n        \n        # Innovation terms scaled by observation error variance\n        innov_Z = (Z_model - Z_obs) / (sigma_Z**2)\n        innov_v = (vr_model - v_obs) / (sigma_v**2)\n\n        # Gradient w.r.t. wind components\n        grad_u = innov_v * np.cos(theta) * np.cos(phi)\n        grad_v = innov_v * np.cos(theta) * np.sin(phi)\n        grad_w = innov_v * np.sin(theta)\n\n        # Gradient w.r.t. rainwater mixing ratio\n        if qr > 0.0:\n            dZ_dqr = (7.0 / 4.0) * Z_model / qr\n            grad_qr = innov_Z * dZ_dqr\n        else:\n            grad_qr = 0.0\n            \n        return np.array([grad_u, grad_v, grad_w, grad_qr])\n\n    def finite_difference_gradient(state, Z_obs, v_obs, params):\n        \"\"\"Computes the numerical gradient of J using finite differences.\"\"\"\n        grad = np.zeros(4)\n        state_vars = list(state)\n        pert_keys = ['u', 'v', 'w', 'qr']\n\n        for i in range(4):\n            x_i = state_vars[i]\n            eps_i = PERTURBATIONS[pert_keys[i]]\n            \n            # Forward perturbation\n            state_p = state_vars[:]\n            state_p[i] += eps_i\n            J_p = cost_function(tuple(state_p), Z_obs, v_obs, params)\n\n            # Special handling for qr to respect physical bound\n            if i == 3 and (x_i - eps_i  0): # One-sided forward difference for qr\n                J_base = cost_function(tuple(state_vars), Z_obs, v_obs, params)\n                grad[i] = (J_p - J_base) / eps_i\n            else: # Centered difference\n                state_m = state_vars[:]\n                state_m[i] -= eps_i\n                J_m = cost_function(tuple(state_m), Z_obs, v_obs, params)\n                grad[i] = (J_p - J_m) / (2 * eps_i)\n        \n        return grad\n\n    # --- Main processing loop ---\n    results = []\n    for case in test_cases:\n        analysis_state, true_state, radar_params, atmos_params, err_stds = case\n\n        u_true, v_true, w_true, qr_true = true_state\n        theta, phi = radar_params\n        rho_a, = atmos_params\n        sigma_Z, sigma_v = err_stds\n\n        # Generate synthetic observations from the \"true\" state\n        Z_obs = calculate_Z(qr_true, rho_a)\n        v_obs = calculate_vr(u_true, v_true, w_true, theta, phi)\n        \n        # Combine all parameters for function calls\n        all_params = (theta, phi, rho_a, sigma_Z, sigma_v)\n\n        # Calculate analytical and finite-difference gradients at the \"analysis\" state\n        grad_adj = analytical_gradient(analysis_state, Z_obs, v_obs, all_params)\n        grad_fd = finite_difference_gradient(analysis_state, Z_obs, v_obs, all_params)\n\n        # Calculate the relative error\n        norm_diff = np.linalg.norm(grad_fd - grad_adj)\n        norm_adj = np.linalg.norm(grad_adj)\n        \n        rel_err = norm_diff / (norm_adj + DELTA_STABILIZER)\n        results.append(rel_err)\n\n    # Print results in the required format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "标准的无约束最优化算法有时会产生违背物理定律的结果，例如在分析场中出现负的降水混合比。本练习  旨在解决这一关键的实际问题，引导你应用约束最优化理论（如Karush-Kuhn-Tucker条件）来确保分析结果的物理合理性。掌握这些技巧对于开发稳健且可靠的业务化数据同化系统至关重要，它能确保同化过程在尊重观测信息的同时，也严格遵守物理规律。",
            "id": "4080660",
            "problem": "在数值天气预报和气候模拟的背景下，考虑一个关于雨水混合比的单柱、单层变分资料同化问题，其中使用了天气雷达反射率和多普勒速度。我们关注的水凝物变量是雨水混合比 $q_{r}$，基于物理原因，该值必须为非负。您将推导并计算约束变分估计，通过将非负性视为不等式约束来避免不符合物理实际的负值。作为一种替代方法，您将简要论证一种通过构造来强制实现正值的变量变换，但您不会使用该变换进行计算。\n\n从高斯误差假设下的贝叶斯估计框架开始：负对数后验是误差方差倒数加权的偏差平方和。设单点的三维变分 (3D-Var) 代价函数为\n$$\nJ(q_{r}) \\equiv \\frac{1}{2}\\frac{(q_{r}-q_{b})^{2}}{\\sigma_{b}^{2}} + \\frac{1}{2}\\frac{\\big(h_{Z}(q_{r}) - z\\big)^{2}}{\\sigma_{Z}^{2}} + \\frac{1}{2}\\frac{\\big(h_{V}(q_{r}) - v_{\\text{obs}}\\big)^{2}}{\\sigma_{V}^{2}},\n$$\n其中 $q_{b}$ 是背景场雨水混合比，$\\sigma_{b}$ 是背景场标准差， $z$ 是与雷达反射率相关的观测值，$\\sigma_{Z}$ 是其标准差， $v_{\\text{obs}}$ 是多普勒径向速度观测值，而 $\\sigma_{V}$ 是其标准差。假设雷达正演算子是围绕背景态的一阶线性化：\n$$\nh_{Z}(q_{r}) \\approx c\\,q_{r}, \\quad h_{V}(q_{r}) \\approx v_{b} + k\\,q_{r},\n$$\n其中 $c0$ 表示基于反射率的量对 $q_{r}$ 的有效线性敏感度，$v_{b}$ 是不包括水凝物终端下落速度的背景径向速度，而 $k0$ 是通过水凝物终端下落速度的贡献，多普勒径向速度对 $q_{r}$ 的有效线性敏感度。强制施加物理约束 $q_{r} \\ge 0$。\n\n您将推导不等式约束最小化问题的 Karush-Kuhn-Tucker (KKT) 最优性条件；使用它们来确定约束是否起作用。然后计算约束最小化子。使用以下物理上合理的数值：\n- $q_{b} = 0.2$ (g/kg), $\\sigma_{b} = 0.3$ (g/kg),\n- $c = 5$ (任意线性化反射率单位每 g/kg), $z = 0.1$ (相同单位), $\\sigma_{Z} = 0.7$,\n- $v_{b} = 10$ (m/s), $k = 4$ (m s$^{-1}$ 每 g/kg), $v_{\\text{obs}} = 4$ (m/s), $\\sigma_{V} = 2$ (m/s)。\n\n为避免水凝物混合比为负，您必须考虑不等式约束 $q_{r} \\ge 0$ 并通过约束优化进行处理。作为一种替代方法，论证为何使用一个对数变量变换 $s \\equiv \\ln(q_{r}+q_{0})$（其中 $q_{0}$ 是一个小的正常数）可以通过构造强制实现正值，并从高层次上解释代价函数将如何用 $s$ 来重新表达。\n\n计算约束最小化子 $q_{r}^{\\ast}$ 并以 g/kg 为单位给出您的最终答案。如果使用了任何数值近似，请尽可能提供精确的算术表达式；除了以封闭形式传达精确值所必需的之外，不需要指定舍入要求。",
            "solution": "该问题要求通过最小化变分代价函数 $J(q_r)$ 来找到雨水混合比 $q_r$ 的最优估计，同时受制于物理非负性约束 $q_r \\ge 0$。分析将分两部分进行：首先，使用 Karush-Kuhn-Tucker (KKT) 条件解决约束优化问题；其次，论证使用变量变换的替代方法的合理性。\n\n首先，我们验证问题陈述。\n**第1步：提取已知条件**\n- 代价函数：$J(q_{r}) \\equiv \\frac{1}{2}\\frac{(q_{r}-q_{b})^{2}}{\\sigma_{b}^{2}} + \\frac{1}{2}\\frac{\\big(h_{Z}(q_{r}) - z\\big)^{2}}{\\sigma_{Z}^{2}} + \\frac{1}{2}\\frac{\\big(h_{V}(q_{r}) - v_{\\text{obs}}\\big)^{2}}{\\sigma_{V}^{2}}$\n- 线性化正演算子：$h_{Z}(q_{r}) \\approx c\\,q_{r}$ 和 $h_{V}(q_{r}) \\approx v_{b} + k\\,q_{r}$\n- 约束条件：$q_r \\ge 0$\n- 数值：\n  - $q_{b} = 0.2$ g/kg\n  - $\\sigma_{b} = 0.3$ g/kg\n  - $c = 5$ (任意单位每 g/kg)\n  - $z = 0.1$ (任意单位)\n  - $\\sigma_{Z} = 0.7$ (任意单位)\n  - $v_{b} = 10$ m/s\n  - $k = 4$ m s$^{-1}$ 每 g/kg\n  - $v_{\\text{obs}} = 4$ m/s\n  - $\\sigma_{V} = 2$ m/s\n- 替代方法：变量变换 $s \\equiv \\ln(q_r + q_0)$。\n\n**第2步：使用提取的已知条件进行验证**\n该问题在数值天气预报领域，特别是变分资料同化方面，具有科学依据。代价函数是高斯误差假设下的标准贝叶斯负对数后验。正演算子被线性化，这是一种常见且有效的简化方法。对混合比施加非负性约束在物理上是正确的。所提出的使用 KKT 条件的优化方法是解决此类问题的标准且严谨的数学技术。替代的对数变换也是强制正性的标准方法。问题是适定的、自洽的，并提供了所有必要的信息。数值在物理上是合理的。未发现任何缺陷。\n\n**第3步：结论与行动**\n问题是有效的。将提供完整解答。\n\n**第1部分：使用 KKT 条件的约束最小化**\n\n我们将线性化正演算子代入代价函数：\n$$\nJ(q_{r}) = \\frac{1}{2\\sigma_{b}^{2}}(q_{r}-q_{b})^{2} + \\frac{1}{2\\sigma_{Z}^{2}}(c q_{r} - z)^{2} + \\frac{1}{2\\sigma_{V}^{2}}(v_{b} + k q_{r} - v_{\\text{obs}})^{2}\n$$\n这是关于 $q_r$ 的二次函数。优化问题是找到最小化 $J(q_r)$ 的 $q_r^*$，并满足不等式约束 $g(q_r) = -q_r \\le 0$。\n\n我们使用不等式约束的拉格朗日乘子法。拉格朗日函数为：\n$$\n\\mathcal{L}(q_r, \\lambda) = J(q_r) - \\lambda q_r\n$$\n其中 $\\lambda$ 是 Karush-Kuhn-Tucker (KKT) 乘子。最优性的 KKT 条件是：\n1.  **平稳性 (Stationarity):** $\\frac{\\partial \\mathcal{L}}{\\partial q_r} = \\frac{dJ}{dq_r} - \\lambda = 0$\n2.  **原始可行性 (Primal Feasibility):** $q_r \\ge 0$\n3.  **对偶可行性 (Dual Feasibility):** $\\lambda \\ge 0$\n4.  **互补松弛性 (Complementary Slackness):** $\\lambda q_r = 0$\n\n根据互补松弛性条件，有两种可能性：\n- 情况 A：约束不活动，所以 $q_r  0$。这意味着 $\\lambda=0$。\n- 情况 B：约束活动，所以 $q_r = 0$。这意味着 $\\lambda \\ge 0$。\n\n我们首先研究情况 A，通过找到无约束最小化子，记为 $q_{r, \\text{unc}}$，这对应于设置 $\\lambda=0$。根据平稳性条件，我们有 $\\frac{dJ}{dq_r} = 0$。代价函数的导数是：\n$$\n\\frac{dJ}{dq_r} = \\frac{q_r - q_b}{\\sigma_b^2} + \\frac{c(c q_r - z)}{\\sigma_Z^2} + \\frac{k(v_b + k q_r - v_{\\text{obs}})}{\\sigma_V^2}\n$$\n设 $\\frac{dJ}{dq_r} = 0$ 并求解 $q_r$：\n$$\nq_r \\left( \\frac{1}{\\sigma_b^2} + \\frac{c^2}{\\sigma_Z^2} + \\frac{k^2}{\\sigma_V^2} \\right) = \\frac{q_b}{\\sigma_b^2} + \\frac{cz}{\\sigma_Z^2} - \\frac{k(v_b - v_{\\text{obs}})}{\\sigma_V^2}\n$$\n无约束最小化子是：\n$$\nq_{r, \\text{unc}} = \\frac{\\frac{q_b}{\\sigma_b^2} + \\frac{cz}{\\sigma_Z^2} - \\frac{k(v_b - v_{\\text{obs}})}{\\sigma_V^2}}{\\frac{1}{\\sigma_b^2} + \\frac{c^2}{\\sigma_Z^2} + \\frac{k^2}{\\sigma_V^2}}\n$$\n现在，我们代入给定的数值：\n- $q_b = 0.2$, $\\sigma_b = 0.3 \\implies \\sigma_b^2 = 0.09$\n- $c = 5$, $z = 0.1$, $\\sigma_Z = 0.7 \\implies \\sigma_Z^2 = 0.49$\n- $k = 4$, $v_b = 10$, $v_{\\text{obs}} = 4$, $\\sigma_V = 2 \\implies \\sigma_V^2 = 4$\n\n分子项是：\n$$\n\\frac{0.2}{0.09} + \\frac{5 \\cdot 0.1}{0.49} - \\frac{4(10 - 4)}{4} = \\frac{20}{9} + \\frac{50}{49} - 6 = \\frac{20 \\cdot 49 + 50 \\cdot 9 - 6 \\cdot 441}{441} = \\frac{980 + 450 - 2646}{441} = \\frac{1430 - 2646}{441} = -\\frac{1216}{441}\n$$\n分母项是：\n$$\n\\frac{1}{0.09} + \\frac{5^2}{0.49} + \\frac{4^2}{4} = \\frac{100}{9} + \\frac{2500}{49} + 4 = \\frac{100 \\cdot 49 + 2500 \\cdot 9 + 4 \\cdot 441}{441} = \\frac{4900 + 22500 + 1764}{441} = \\frac{29164}{441}\n$$\n因此，无约束最小化子是：\n$$\nq_{r, \\text{unc}} = \\frac{-1216/441}{29164/441} = -\\frac{1216}{29164} = -\\frac{304}{7291}\n$$\n由于 $q_{r, \\text{unc}} = -304/7291  0$，无约束解违反了原始可行性条件 $q_r \\ge 0$。因此，情况 A 无效，约束必须是活动的。这引导我们到情况 B。\n\n在情况 B 中，约束是活动的，意味着解位于可行域的边界上。因此，约束最小化子是 $q_r^* = 0$。\n为了确认这是正确的 KKT 点，我们必须验证存在一个对应的 $\\lambda \\ge 0$。根据平稳性条件，$\\lambda = \\frac{dJ}{dq_r}$ 在建议解 $q_r^* = 0$ 处的值。\n$$\n\\lambda = \\frac{dJ}{dq_r}\\bigg|_{q_r=0} = -\\frac{q_b}{\\sigma_b^2} - \\frac{cz}{\\sigma_Z^2} + \\frac{k(v_b - v_{\\text{obs}})}{\\sigma_V^2} = -\\left(\\frac{q_b}{\\sigma_b^2} + \\frac{cz}{\\sigma_Z^2} - \\frac{k(v_b-v_{\\text{obs}})}{\\sigma_V^2}\\right)\n$$\n这个表达式恰好是无约束解分子项的负值。\n$$\n\\lambda = -\\left(-\\frac{1216}{441}\\right) = \\frac{1216}{441}\n$$\n所以我们有候选解 $(q_r^*, \\lambda) = (0, 1216/441)$。让我们检查所有 KKT 条件：\n1.  平稳性：$\\frac{dJ}{dq_r}|_{q_r=0} - \\lambda = \\frac{1216}{441} - \\frac{1216}{441} = 0$。（成立）\n2.  原始可行性：$q_r^* = 0 \\ge 0$。（成立）\n3.  对偶可行性：$\\lambda = \\frac{1216}{441}  0$。（成立）\n4.  互补松弛性：$\\lambda q_r^* = \\frac{1216}{441} \\cdot 0 = 0$。（成立）\n所有条件均满足。因此，约束最小化子是 $q_r^* = 0$。\n\n**第2部分：对数变量变换的合理性论证**\n\n强制正性的另一种方法是通过变量变换。考虑变换 $s = \\ln(q_r + q_0)$，其中 $q_0$ 是一个小的正常数，用以处理 $q_r$ 可能为零的情况。逆变换是 $q_r(s) = \\exp(s) - q_0$。\n\n新的控制变量是 $s$，它是无约束的，可以在实数线 $(-\\infty, \\infty)$ 上取任何值。对于任何实数 $s$，指数函数 $\\exp(s)$ 都是严格为正的。因此，物理变量 $q_r = \\exp(s) - q_0$ 被保证大于 $-q_0$。通过选择一个小的 $q_0$，我们实际上确保了 $q_r$ 在实际应用中保持非负。因此，优化问题从 $q_r$ 的约束问题转化为 $s$ 的无约束问题。\n\n代价函数将被重写为 $s$ 的函数：\n$$\nJ(s) = J(q_r(s)) = \\frac{1}{2\\sigma_{b}^{2}}\\big((\\exp(s) - q_0) - q_{b}\\big)^{2} + \\frac{1}{2\\sigma_{Z}^{2}}\\big(c(\\exp(s)-q_0) - z\\big)^{2} + \\frac{1}{2\\sigma_{V}^{2}}\\big(v_{b} + k(\\exp(s)-q_0) - v_{\\text{obs}}\\big)^{2}\n$$\n这个新的代价函数 $J(s)$ 不再是控制变量 $s$ 的二次函数。其最小化将需要一个迭代数值算法，例如拟牛顿法。这种方法以处理约束的复杂性换取了解决非线性无约束优化问题的复杂性。\n\n计算出的约束最小化子是 $q_r^*=0$ g/kg。",
            "answer": "$$\n\\boxed{0}\n$$"
        }
    ]
}