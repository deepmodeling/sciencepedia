## 引言
在现代数值天气预报和气候模拟等[地球科学](@entry_id:749876)领域，准确估计系统的初始状态是提升预报精度的关键。[数据同化技术](@entry_id:637566)为此而生，旨在将零散、非均匀的观测数据与动力学模型相结合，以获得对地球系统状态的最佳估计。然而，随着[模型分辨率](@entry_id:752082)的提高，状态向量的维度急剧膨胀至数亿甚至更高，这给传统[数据同化方法](@entry_id:748186)带来了所谓的“维度灾难”。

经典卡尔曼滤波器虽能提供理论上的最优解并捕捉随天气形势动态演变的“流依赖”误差结构，但其对完整[协方差矩阵](@entry_id:139155)的计算和存储需求使其在高维系统中不切实际。集合卡尔曼滤波器（EnKF）通过使用有限的模式集合来近似协方差，解决了这一难题，但又引入了由有限样本导致的“伪相关”和“集合崩溃”等新挑战。局部[集合变换卡尔曼滤波](@entry_id:749007)器（Local Ensemble Transform Kalman Filter, [LETKF](@entry_id:751245)）正是为应对这些挑战而设计的先进数据同化方案。

本文将系统地引导您深入理解[LETKF](@entry_id:751245)。在“原理与机制”一章中，我们将从卡尔曼滤波器的基本方程出发，剖析[LETKF](@entry_id:751245)如何通过局地化和在集合空间中进行变换来高效、稳健地进行分析更新。接着，在“应用与跨学科连接”一章中，我们将探讨[LETKF](@entry_id:751245)在真实全[球模型](@entry_id:161388)中的实现细节，包括[并行计算](@entry_id:139241)策略、关键参数调优，以及如何扩展至处理[非线性](@entry_id:637147)和进行参数估计等高级课题。最后，“动手实践”部分将提供具体的计算练习，帮助您将理论知识转化为实践技能。

## 原理与机制

本章在前一章介绍的基础上，深入探讨局部[集合变换卡尔曼滤波](@entry_id:749007)器（Local Ensemble Transform Kalman Filter, [LETKF](@entry_id:751245)）的核心科学原理与算法机制。我们将从数据同化的基本目标出发，系统地阐述为何需要流依赖的背景误差协方差，[集合预报](@entry_id:1124525)如何提供这种协方差，以及在实际应用中遇到的挑战。最后，我们将详细剖析[LETKF](@entry_id:751245)如何通过局地化和集合空间变换来应对这些挑战，并介绍其在实践中的重要考量和向四维时空场的扩展。

### 基础：卡尔曼滤波器与流依赖协方差

数据同化的核心目标，是利用[观测信息](@entry_id:165764)来修正模式的预报状态，从而得到对大气或海洋等地球物理系统当前状态的最佳估计。在经典的线性高斯框架下，**卡尔曼滤波器（Kalman Filter, KF）** 为这一问题提供了最优的循序解。理解KF的结构是理解所有[集合卡尔曼滤波](@entry_id:166109)器的基础。

一个标准的KF循环包含两个步骤：**预报（forecast）** 和 **分析（analysis）**。假设在 $k-1$ 时刻，我们已经有了一个分析状态，其均值为 $\bar{\mathbf{x}}_{k-1}^{a}$，协方差为 $\mathbf{P}_{k-1}^{a}$。

1.  **预报步骤**：利用[线性动力学](@entry_id:177848)模式算子 $\mathbf{M}_k$ 将状态从 $k-1$ 时刻推进到 $k$ 时刻。这个过程同时也会传播不确定性。预报均值 $\bar{\mathbf{x}}_k^f$ 和[预报误差协方差](@entry_id:1125226) $\mathbf{P}_k^f$（也称为**[背景误差协方差](@entry_id:1121308)**）由以下方程给出：
    $$ \bar{\mathbf{x}}_k^f = \mathbf{M}_k \bar{\mathbf{x}}_{k-1}^a $$
    $$ \mathbf{P}_k^f = \mathbf{M}_k \mathbf{P}_{k-1}^a \mathbf{M}_k^T + \mathbf{Q}_k $$
    其中 $\mathbf{Q}_k$ 是模式[误差协方差矩阵](@entry_id:749077)，代表了动力学模式自身的不完美性。

2.  **分析步骤**：在 $k$ 时刻，我们获得新的观测 $\mathbf{y}_k$。通过线性观测算子 $\mathbf{H}_k$，模式状态可以映射到观测空间。分析步骤的目标是融合预报信息（$\bar{\mathbf{x}}_k^f, \mathbf{P}_k^f$）和[观测信息](@entry_id:165764)（$\mathbf{y}_k, \mathbf{R}_k$，其中 $\mathbf{R}_k$ 是[观测误差协方差](@entry_id:752872)），得到更新后的分析均值 $\bar{\mathbf{x}}_k^a$ 和分析误差协方差 $\mathbf{P}_k^a$。其[更新方程](@entry_id:264802)为：
    $$ \bar{\mathbf{x}}_k^a = \bar{\mathbf{x}}_k^f + \mathbf{K}_k (\mathbf{y}_k - \mathbf{H}_k \bar{\mathbf{x}}_k^f) $$
    $$ \mathbf{P}_k^a = (\mathbf{I} - \mathbf{K}_k \mathbf{H}_k) \mathbf{P}_k^f $$
    这里的 $\mathbf{K}_k$ 是**[卡尔曼增益](@entry_id:145800)矩阵**，它决定了观测新息（observation innovation） $(\mathbf{y}_k - \mathbf{H}_k \bar{\mathbf{x}}_k^f)$ 在多大程度上被用来修正预报状态。$\mathbf{K}_k$ 的计算公式为：
    $$ \mathbf{K}_k = \mathbf{P}_k^f \mathbf{H}_k^T (\mathbf{H}_k \mathbf{P}_k^f \mathbf{H}_k^T + \mathbf{R}_k)^{-1} $$

在这些方程中，背景误差协方差 $\mathbf{P}_k^f$ 扮演着至关重要的角色。它不仅描述了预报状态的不确定性大小，其非对角元素还刻画了不同状态变量之间误差的相关性结构。卡尔曼增益 $\mathbf{K}_k$ 直接依赖于 $\mathbf{P}_k^f$，这意味着预报误差的结构决定了[观测信息](@entry_id:165764)如何影响状态的更新。

KF的一个核心特征是 $\mathbf{P}_k^f$ 是通过动力学模式 $\mathbf{M}_k$ 动态演化而来的。这意味着协方差结构是**流依赖的（flow-dependent）**，能够捕捉到特定天气形势下（例如，锋面、气旋）误差的增长模式和相关结构。这与早期的[变分方法](@entry_id:163656)（如[三维变分](@entry_id:746164)，3D-Var）形成了鲜明对比，后者通常使用一个静态的、基于气候平均统计得到的背景误差协方差矩阵 $\mathbf{B}$。静态协方差无法反映特定时刻的误差特征，这是一个根本性的局限。

然而，对于现代数值天气预报（NWP）等高维系统（[状态向量](@entry_id:154607)维度 $n$ 可达 $10^8$ 或更高），直接计算和存储 $n \times n$ 的[协方差矩阵](@entry_id:139155) $\mathbf{P}_k^f$ 在计算上是不可行的。**[集合卡尔曼滤波](@entry_id:166109)器（Ensemble Kalman Filter, EnKF）** 应运而生，它通过一个有限大小的模式[预报集合](@entry_id:749510)来近似表示和传播背景误差协方差，从而使流依赖协方差的应用成为可能。

### 用[集合表示](@entry_id:636781)协方差

EnKF的核心思想是用一个包含 $m$ 个成员的集合 $\{ \mathbf{x}_i \}_{i=1}^m$ 来代表预报状态的概率分布。这个集合的样本均值 $\bar{\mathbf{x}}$ 和样本协方差 $\mathbf{P}^f$ 分别近似于真实的预报均值和协方差。

具体来说，给定一个[预报集合](@entry_id:749510) $\{ \mathbf{x}_i^f \}_{i=1}^m$，其集合均值为 $\bar{\mathbf{x}}^f = \frac{1}{m} \sum_{i=1}^m \mathbf{x}_i^f$。我们可以定义一个**集合异常矩阵**（ensemble anomaly matrix）$\mathbf{X}' \in \mathbb{R}^{n \times m}$，其列向量是每个集合成员相对于集合均值的偏差：
$$ \mathbf{X}' = [\mathbf{x}_1^f - \bar{\mathbf{x}}^f, \dots, \mathbf{x}_m^f - \bar{\mathbf{x}}^f] $$
有时，为了方便后续推导，我们会引入一个缩放因子，例如 $\frac{1}{\sqrt{m-1}}$。如果这样定义 $\mathbf{X}'_{scaled} = \frac{1}{\sqrt{m-1}}\mathbf{X}'$，那么[背景误差协方差](@entry_id:1121308)矩阵 $\mathbf{P}^f$ 可以通过一个简单的矩阵乘法来近似：
$$ \mathbf{P}^f \approx \mathbf{X}'_{scaled} (\mathbf{X}'_{scaled})^T = \frac{1}{m-1} \sum_{i=1}^m (\mathbf{x}_i^f - \bar{\mathbf{x}}^f)(\mathbf{x}_i^f - \bar{\mathbf{x}}^f)^T $$
这个表达式正是集合的无偏样本协方差。它是一个 $n \times n$ 的矩阵，由 $m$ 个秩为1的[外积](@entry_id:147029)矩阵之和构成。 这种表示方式是EnKF的基石，它避免了对完整 $\mathbf{P}^f$ 矩阵的存储和传播，转而只需存储和演化 $m$ 个状态向量。

当进行分析更新时，我们还需要将模式状态的误差信息映射到观测空间。这是通过**[观测算子](@entry_id:752875)** $\mathcal{H}$ 实现的。EnKF的一个巨大优势在于它能自然地处理**[非线性](@entry_id:637147)[观测算子](@entry_id:752875)**。我们无需像扩展卡尔曼滤波器（EKF）那样对 $\mathcal{H}$进行线性化（即计算其[雅可比矩阵](@entry_id:178326) $\nabla\mathcal{H}$）。取而代之，我们可以将完整的非[线性算子](@entry_id:149003) $\mathcal{H}$ 应用于每个集合成员：
$$ \mathbf{y}_i^f = \mathcal{H}(\mathbf{x}_i^f) $$
由此得到一个观测空间中的集合 $\{\mathbf{y}_i^f\}_{i=1}^m$。其集合均值为 $\bar{\mathbf{y}}^f = \frac{1}{m}\sum \mathbf{y}_i^f$，观测空间中的异常矩阵则为 $\mathbf{Y}' = [\mathbf{y}_1^f - \bar{\mathbf{y}}^f, \dots, \mathbf{y}_m^f - \bar{\mathbf{y}}^f]$。这种做法完全避免了[雅可比矩阵](@entry_id:178326)的计算和存储，极大地简化了算法实现。 只有当 $\mathcal{H}$ 是[线性算子](@entry_id:149003)（可用矩阵 $\mathbf{H}$ 表示）时，我们才有 $\bar{\mathbf{y}}^f = \mathbf{H}\bar{\mathbf{x}}^f$ 和 $\mathbf{Y}' = \mathbf{H}\mathbf{X}'$ 的精确关系。

### [有限集](@entry_id:145527)合的挑战：[秩亏](@entry_id:754065)损和虚假相关

虽然集合方法巧妙地解决了存储和传播协方差矩阵的难题，但它也引入了新的、严峻的挑战，这些挑战都源于一个事实：在实际应用中，集合成员数 $m$（通常为几十到一百）远小于模式[状态空间](@entry_id:160914)的维度 $n$（可达数亿）。

第一个挑战是**[秩亏](@entry_id:754065)损（rank deficiency）**。由 $m$ 个异常向量构成的矩阵 $\mathbf{X}'$ 的秩至多为 $m-1$（因为其列向量之和为零，是线性相关的）。根据线性代数的基本定理，由它生成的样本协方差 $\mathbf{P}^f \propto \mathbf{X}'(\mathbf{X}')^T$ 的秩也至多为 $m-1$。 这意味着 $\mathbf{P}^f$ 是一个严重的秩[亏损矩阵](@entry_id:184234)。其后果是，分析增量 $\Delta\bar{\mathbf{x}}^a = \mathbf{K}_k (\mathbf{y}_k - \mathbf{H}_k \bar{\mathbf{x}}_k^f)$ 被严格限制在由集合异常张成的低维**集[合子](@entry_id:146894)空间**（ensemble subspace）中。换言之，滤波器对于正交于该子空间的任何方向上的误差都是“盲目”的，无法利用[观测信息](@entry_id:165764)对这些方向上的误差进行修正。当观测信息量超过集[合子](@entry_id:146894)空间的维度时（例如，局部区域内的独立观测数量大于 $m-1$），滤波器无法充分利用所有信息。

第二个、也是更具破坏性的挑战是**采样误差（sampling error）**。用一个小的样本（小 $m$）来估计一个高维分布的协方差是极不准确的。这种不准确性表现为**[虚假相关](@entry_id:755254)（spurious correlations）**。即使两个物理上相距很远、真实误差不相关的变量，由于[有限集](@entry_id:145527)合的随机采样效应，其样本协方差也几乎不为零。

我们可以通过一个简单的思想实验来量化这个问题。考虑一个一维高斯场，其真实协方差随距离 $h$ 指数衰减：$C(h) = \sigma^2 \exp(-|h|/L)$，其中 $L$ 是 decorrelation 长度尺度。当我们用一个大小为 $m$ 的集合估计两个相距很远（$h \gg L$）的、真实协方差 $C(h) \approx 0$ 的点之间的协方差时，样本协方差的估计值 $\widehat{C}(h)$ 会在一个零均值附近波动。其波动的幅度（标准差）可以被证明约为 $\sigma^2 / \sqrt{m-1}$。这个值代表了[采样误差](@entry_id:182646)造成的“噪声水平”。当真实协方差信号 $C(h)$ 的强度衰减到低于这个噪声水平时，我们计算出的样本协方差就完全被噪声主导，不再具有物理意义。这个临界距离大约在 $|h| \approx L \ln(\sqrt{m-1})$。 在分析更新中，这些虚假的远[距离协方差](@entry_id:748580)会导致一个地方的观测错误地影响到遥远地方的[状态变量](@entry_id:138790)，从而污染分析场。

### 解决方案：局地化

为了克服[秩亏](@entry_id:754065)损和虚假相关这两个根本性问题，**局地化（localization）** 技术应运而生。它是所有成功集合滤波方案的必要组成部分。局地化的核心思想是基于一个物理假设：在地球物理系统中，相距较远的两点之间的相关性很小。因此，我们应该强制切断或减弱样本协方差矩阵中远距离元素的影响。

目前主要有两种实现局地化的策略：

1.  **[协方差局地化](@entry_id:164747)（Covariance Localization）**：这种方法直接修改[背景误差协方差](@entry_id:1121308)矩阵 $\mathbf{P}^f$。它构造一个与 $\mathbf{P}^f$ 同维度的[相关矩阵](@entry_id:262631) $\boldsymbol{\rho}$，其元素 $\rho_{ij}$ 是物理位置 $i$ 和 $j$ 之间距离的函数，通常在距离为零时为1，并随距离增加而平滑地衰减至零（例如，在某个局地化半径之外为零）。然后，通过**[舒尔积](@entry_id:198876)（Schur product）**（即逐元素相乘）将这个局地化矩阵应用到样本协方差上：
    $$ \mathbf{P}^f_{\text{loc}} = \boldsymbol{\rho} \circ \mathbf{P}^f $$
    根据[舒尔积定理](@entry_id:202887)，如果 $\boldsymbol{\rho}$ 和 $\mathbf{P}^f$ 都是[半正定矩阵](@entry_id:155134)，那么它们的[舒尔积](@entry_id:198876) $\mathbf{P}^f_{\text{loc}}$ 也是半正定的，从而保证了其作为协方差矩阵的数学有效性。  这种方法通过平滑地削弱远距离相关性来抑制虚假相关，并且由于 $\boldsymbol{\rho}$ 通常是满秩的，得到的 $\mathbf{P}^f_{\text{loc}}$ 也可以是满秩的，从而缓解了[秩亏](@entry_id:754065)损问题。分析更新仍然是一个全局过程，但使用了经过局地化修正的协方差。

2.  **区域局地化（Domain Localization）**：这是[LETKF](@entry_id:751245)采用的方法，也被称为**局地分析（local analysis）**。它不直接修改全局的 $\mathbf{P}^f$ 矩阵，而是将全局的同化问题分解为大量独立的局地同化问题。对模式格点域中的每一个格点，算法只选用其物理邻域内（由局地化半径定义）的观测来进行一次独立的分析更新。因为每个局地分析只处理少量观测，避免了[观测信息](@entry_id:165764)量远超集合维度的问题。由于每个格点的分析计算是完全独立的，该算法具有**“易于并行”（embarrassingly parallel）** 的特性，极大地提高了计算效率。 

### [LETKF](@entry_id:751245)算法：集合空间中的局地分析

[LETKF](@entry_id:751245)是区域局地化思想的一个高效实现。其名称中的“变换”（Transform）指的是它在低维的**集合权重空间**（ensemble-weight space）中执行分析更新，而不是在巨大的模式[状态空间](@entry_id:160914)中。下面我们详细阐述[LETKF](@entry_id:751245)在一个局地分析域（以格点 $g$ 为中心）的计算步骤。

**步骤 1：收集局地信息**
对于中心格点 $g$，首先确定其局地分析域。然后，收集与该分析域相关的所有信息：
-   局地状态：背景集合均值 $\bar{\mathbf{x}}_g^f$ 和背景集合异常矩阵 $\mathbf{X}'^f_g$（仅包含局地状态变量的行）。
-   局地观测：位于局地化半径内的观测向量 $\mathbf{y}_g$。
-   局地[观测算子](@entry_id:752875)和误差：与 $\mathbf{y}_g$ 对应的[观测算子](@entry_id:752875) $\mathbf{H}_g$ 和观测误差协方差矩阵 $\mathbf{R}_g$。

**步骤 2：投影到观测空间**
将局地集合投影到局地观测空间，得到观测空间中的集合均值和异常：
-   $\bar{\mathbf{y}}_g^f = \mathcal{H}_g(\bar{\mathbf{x}}_g^f)$ （对于非[线性算子](@entry_id:149003)，使用集合均值 $\overline{\mathcal{H}_g(\mathbf{x}_g^f)}$）
-   $\mathbf{Y}'^f_g = \mathbf{H}_g \mathbf{X}'^f_g$ （对于线性化算子）

**步骤 3：在集合空间中求解分析**
这是[LETKF](@entry_id:751245)的核心。分析状态 $\mathbf{x}_g^a$ 被表示为背景均值和背景异常的线性组合：$\mathbf{x}_g^a = \bar{\mathbf{x}}_g^f + \mathbf{X}'^f_g \mathbf{w}^a$。我们的目标是求解最优的权重向量 $\mathbf{w}^a \in \mathbb{R}^k$。通过贝叶斯推断，可以得到一个关于 $\mathbf{w}$ 的代价函数，其最小化解即为 $\mathbf{w}^a$。在标准[LETKF](@entry_id:751245)中，求解过程如下：
-   计算局地分析[协方差矩阵](@entry_id:139155)在**集合空间**的表示 $\tilde{\mathbf{P}}_g^a \in \mathbb{R}^{k \times k}$：
    $$ \tilde{\mathbf{P}}_g^a = \left[ (k-1)\mathbf{I}_k + (\mathbf{Y}'^f_g)^T \mathbf{R}_g^{-1} \mathbf{Y}'^f_g \right]^{-1} $$
    这里的 $(k-1)$ 来源于对集合异常的特定缩放定义，$\mathbf{I}_k$ 是 $k \times k$ 的单位矩阵。
-   计算**分析权重向量** $\mathbf{w}_g^a \in \mathbb{R}^k$：
    $$ \mathbf{w}_g^a = \tilde{\mathbf{P}}_g^a (\mathbf{Y}'^f_g)^T \mathbf{R}_g^{-1} (\mathbf{y}_g - \bar{\mathbf{y}}_g^f) $$
注意，这里的核心计算是求一个 $k \times k$ [矩阵的逆](@entry_id:140380)，其计算量远小于在[状态空间](@entry_id:160914)中求解。

**步骤 4：映射回[状态空间](@entry_id:160914)**
得到集合空间中的分析解后，将其映射回模式[状态空间](@entry_id:160914)，以更新局地状态的均值和异常：
-   分析均值：$\bar{\mathbf{x}}_g^a = \bar{\mathbf{x}}_g^f + \mathbf{X}'^f_g \mathbf{w}_g^a$
-   分析异常：$\mathbf{X}'^a_g = \mathbf{X}'^f_g \mathbf{T}_g$，其中 $\mathbf{T}_g$ 是一个 $k \times k$ 的[变换矩阵](@entry_id:151616)，满足 $\mathbf{T}_g \mathbf{T}_g^T = (k-1)\tilde{\mathbf{P}}_g^a$。通常选择 $\mathbf{T}_g$ 为该矩阵的[对称平方](@entry_id:137676)根。

**步骤 5：组装[全局分析](@entry_id:188294)场**
对模式的每个格点重复上述1-4步，得到每个格点的分析均值和分析异常。最后将这些局地分析结果组装起来，形成完整的[全局分析](@entry_id:188294)场。需要注意的是，这种“拼接”过程可能会破坏背景场中存在的一些动力学或物理平衡（如地转平衡），因为相邻格点的分析更新使用了不同的[观测信息](@entry_id:165764)和权重。

### 实践考量与扩展

#### 观测误差协方差（R）

在上述算法中，观测误差协方差矩阵 $\mathbf{R}$ 的设定至关重要。一个常见的误解是认为 $\mathbf{R}$ 只包含**仪器误差（instrument error）**。实际上，它还必须包含**代表性误差（representativeness error）**。

-   **仪器误差** $\sigma_{\text{inst}}^2$ 来自传感器本身的不精确性、[数据传输](@entry_id:276754)和处理过程中的噪声。
-   **代表性误差** $\sigma_{\text{rep}}^2$ 源于模式状态和真实观测之间的[尺度不匹配](@entry_id:1131268)。例如，一个模式格点可能代表了几十公里见方的平均温度，而一个地面气象站的观测是该格点内一个点的温度。这种点与面的差异，以及模式无法解析的次网格尺度变化，构成了代表性误差。

因此，总的[观测误差](@entry_id:752871)方差应为 $R = \sigma_{\text{inst}}^2 + \sigma_{\text{rep}}^2$（假设两者不相关）。这意味着，即使我们有完美的仪器（$\sigma_{\text{inst}}^2 = 0$），只要模式分辨率有限，$\mathbf{R}$ 就不为零。反之，如果提高模式分辨率，使得模式格点能更好地代表观测点，$\sigma_{\text{rep}}^2$ 就会减小，从而导致总的 $R$ 减小。根据[卡尔曼增益](@entry_id:145800)公式，较小的 $R$ 会使观测在分析中获得更大的权重。 我们可以利用**新息统计**（如[Desroziers诊断](@entry_id:748329)）来估计这些误差分量。理论上，新息方差应等于背景误差在观测空间的投影方差与[观测误差](@entry_id:752871)方差之和，即 $\text{Var}(d) \approx H P^f H^T + R$。如果已知其中两项，就可以估计第三项。例如，在一个案例中，若新息方差为 $2.5$（单位平方），背景集合在观测空间的方差为 $1.1$，仪器误差方差为 $0.4$，则可以推断出[代表性误差](@entry_id:754253)方差为 $2.5 - 1.1 - 0.4 = 1.0$。

#### 扩展至四维：4D-[LETKF](@entry_id:751245)

标准的[LETKF](@entry_id:751245)是一个三维（3D）同化系统，它在某个特定时刻，利用该时刻的观测来更新模式状态。然而，许多观测（如卫星数据）是异步的，分布在一个时间窗口内。**四维局部[集合变换卡尔曼滤波](@entry_id:749007)器（4D-[LETKF](@entry_id:751245)）** 将[LETKF](@entry_id:751245)框架扩展到时间维度，以同时同化一个时间窗口内的所有观测。

4D-[LETKF](@entry_id:751245)的基本思想是，寻找在**时间窗口开始时刻**的一个最优分析增量，使得经过模式向前积分后，得到的模式轨迹在整个时间窗口内与所有观测最为吻合。其实现方式在形式上与3D-[LETKF](@entry_id:751245)惊人地相似，只是将所有量都“堆叠”了起来：

1.  **定义时间窗口** $[t_0, t_L]$，并收集此窗口内的所有（局地）观测。将它们堆叠成一个大的观测向量 $\mathbf{y} = [y_{t_0}^T, y_{t_1}^T, \dots, y_{t_L}^T]^T$。对应的[观测误差协方差](@entry_id:752872)矩阵 $\mathbf{R}$ 变为一个[块对角矩阵](@entry_id:145530)。

2.  将位于 $t_0$ 时刻的背景集合 $\{ \mathbf{x}_i^f(t_0) \}_{i=1}^k$ 中的每个成员用完整的[非线性](@entry_id:637147)模式 $\mathcal{M}$ 积分到窗口内的每个观测时刻 $t_i$，得到一系列集合轨迹 $\{ \mathbf{x}_i^f(t_i) \}$。

3.  在每个观测时刻 $t_i$，将集合轨迹投影到观测空间，得到观测空间中的异常 $Y'_{t_i}$。然后将这些异常矩阵垂直堆叠起来，形成一个大的观测空间异常矩阵 $\mathbf{Y}' = [ (Y'_{t_0})^T, (Y'_{t_1})^T, \dots, (Y'_{t_L})^T ]^T$。

4.  之后，求解分析权重 $\mathbf{w}^a$ 的过程与3D-[LETKF](@entry_id:751245)完全相同，只是用堆叠后的 $\mathbf{y}$, $\bar{\mathbf{y}}^f$, $\mathbf{Y}'$, 和 $\mathbf{R}$ 代替原来的单时刻量。代价函数变为：
    $$ J(\mathbf{w}) = ( \mathbf{y} - \bar{\mathbf{y}}^f - \mathbf{Y}' \mathbf{w} )^{\top} \mathbf{R}^{-1} ( \mathbf{y} - \bar{\mathbf{y}}^f - \mathbf{Y}' \mathbf{w} ) + (k-1)\mathbf{w}^{\top} \mathbf{w} $$
    最小化这个代价函数即可得到分析权重 $\mathbf{w}^a$。

5.  最后，用得到的 $\mathbf{w}^a$ 更新**窗口开始时刻 $t_0$** 的状态均值和异常。

通过这种方式，4D-[LETKF](@entry_id:751245)利用了观测的时间信息和模式的动力学演化信息，实现了[四维数据同化](@entry_id:746173)。它与3D-[LETKF](@entry_id:751245)的区别本质上在于是否利用了模式的短期预报来建立跨时间的协方差。