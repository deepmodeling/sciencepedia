{
    "hands_on_practices": [
        {
            "introduction": "The atmospheric refractivity measured by GPS RO is sensitive to both temperature and water vapor. In regions where moisture is negligible, like the upper troposphere and stratosphere, a simplified \"dry\" retrieval can provide accurate temperature information. This exercise  explores the consequences of applying this simplification in the moist lower troposphere, allowing you to quantify the significant temperature bias introduced by neglecting the wet term. Understanding this bias is crucial for correctly interpreting RO data and appreciating the need for a complete physical observation operator.",
            "id": "4050120",
            "problem": "Consider Global Positioning System (GPS) Radio Occultation (RO) assimilation in Numerical Weather Prediction (NWP). The forward operator for refractivity uses the well-tested Smith–Weintraub formula, which relates the refractivity $N$ to thermodynamic state variables by\n$$\nN \\;=\\; k_{1}\\,\\frac{p}{T} \\;+\\; k_{2}\\,\\frac{e}{T^{2}},\n$$\nwhere $p$ is the total pressure, $T$ is the temperature, $e$ is the water vapor partial pressure, $k_{1} = 77.6\\,\\mathrm{K/hPa}$, and $k_{2} = 3.73\\times 10^{5}\\,\\mathrm{K^{2}/hPa}$. In a naive “dry” retrieval, the wet term $k_{2}\\,e/T^{2}$ is neglected, and temperature is inferred from refractivity via $N \\approx k_{1}\\,p/T$.\n\nAssume a moist layer representative of the lower troposphere with $p = 850\\,\\mathrm{hPa}$, $T = 295\\,\\mathrm{K}$, and $e = 20\\,\\mathrm{hPa}$. A GPS RO observation provides $N$ consistent with the full Smith–Weintraub relation above evaluated at this true state. A data assimilation system that neglects the wet term uses the measured $N$ and the known pressure $p$ to invert the dry relation and retrieve a “dry” temperature $T_{d}$.\n\nStarting from the Smith–Weintraub formula and using only well-tested physical relations, do the following:\n- Derive the expression for the dry-retrieved temperature $T_{d}$ when the observed refractivity $N$ is computed from the full moist relation.\n- From first principles, derive the exact bias $\\Delta T \\equiv T_{d} - T$ introduced by neglecting the wet term, expressed in closed form in terms of $\\{k_{1},k_{2},p,T,e\\}$.\n- Evaluate $\\Delta T$ numerically for the given moist-layer state and provide the final numerical value.\n\nExpress the final numerical bias in Kelvin. Round your answer to four significant figures. Use only the specified constants and the provided state values; do not introduce any additional approximations beyond those explicitly stated.",
            "solution": "The analysis begins with the validation of the problem statement.\n\n### Step 1: Extract Givens\n-   The Smith–Weintraub formula for refractivity $N$: $N = k_{1}\\,\\frac{p}{T} + k_{2}\\,\\frac{e}{T^{2}}$.\n-   Dry retrieval approximation: $N \\approx k_{1}\\,\\frac{p}{T}$.\n-   Constant $k_{1}$: $77.6\\,\\mathrm{K/hPa}$.\n-   Constant $k_{2}$: $3.73 \\times 10^{5}\\,\\mathrm{K^{2}/hPa}$.\n-   True total pressure: $p = 850\\,\\mathrm{hPa}$.\n-   True temperature: $T = 295\\,\\mathrm{K}$.\n-   True water vapor partial pressure: $e = 20\\,\\mathrm{hPa}$.\n-   Definition of observed refractivity $N$: It is computed from the full moist relation at the true state.\n-   Definition of dry-retrieved temperature $T_d$: It is inverted from the dry relation $N = k_{1}\\,\\frac{p}{T_d}$ using the observed $N$ and known $p$.\n-   Definition of bias: $\\Delta T \\equiv T_{d} - T$.\n-   Task 1: Derive the expression for $T_d$ in terms of $\\{k_{1},k_{2},p,T,e\\}$.\n-   Task 2: Derive the exact bias $\\Delta T$ in closed form in terms of $\\{k_{1},k_{2},p,T,e\\}$.\n-   Task 3: Evaluate $\\Delta T$ numerically for the given state, rounded to four significant figures.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, as it is based on the standard Smith–Weintraub formula used in atmospheric remote sensing. The physical values for pressure, temperature, and water vapor are realistic for the lower troposphere. The problem is well-posed, with all necessary information provided and a clear set of objectives that lead to a unique solution. The language is objective and precise. The problem is a standard exercise in analyzing retrieval errors in data assimilation and is fully valid.\n\n### Step 3: Derivation and Solution\n\nThe problem requires a systematic derivation of the temperature bias resulting from neglecting the water vapor contribution to atmospheric refractivity.\n\nFirst, we establish the value of the observed refractivity, $N$. This value is determined by the true atmospheric state $\\{p, T, e\\}$ using the full Smith–Weintraub formula:\n$$\nN = k_{1}\\,\\frac{p}{T} + k_{2}\\,\\frac{e}{T^{2}}\n$$\nThis value of $N$ is what a GPS RO instrument would measure in this atmospheric layer.\n\nNext, a data assimilation system using a naive \"dry\" forward operator attempts to retrieve the temperature. It assumes the refractivity is related to a retrieved temperature, $T_d$, and the known pressure, $p$, by the simplified dry formula:\n$$\nN = k_{1}\\,\\frac{p}{T_{d}}\n$$\nThe system solves for $T_d$ using the observed $N$.\n\nTo derive the expression for $T_d$, we equate the two expressions for $N$:\n$$\nk_{1}\\,\\frac{p}{T_{d}} = k_{1}\\,\\frac{p}{T} + k_{2}\\,\\frac{e}{T^{2}}\n$$\nWe now solve this equation for $T_d$. First, we can take the reciprocal of both sides:\n$$\n\\frac{T_{d}}{k_{1}p} = \\frac{1}{k_{1}\\,\\frac{p}{T} + k_{2}\\,\\frac{e}{T^{2}}}\n$$\nMultiplying by $k_1 p$ gives the expression for the dry-retrieved temperature $T_d$:\n$$\nT_d = \\frac{k_{1}p}{k_{1}\\,\\frac{p}{T} + k_{2}\\,\\frac{e}{T^{2}}}\n$$\nTo obtain a more convenient form, we can multiply the numerator and the denominator by $T^2$:\n$$\nT_d = \\frac{k_{1}pT^{2}}{T^2 \\left(k_{1}\\,\\frac{p}{T} + k_{2}\\,\\frac{e}{T^{2}}\\right)} = \\frac{k_{1}pT^{2}}{k_{1}pT + k_{2}e}\n$$\nThis is the required expression for $T_d$ in terms of the true state variables and physical constants.\n\nNow, we derive the expression for the bias, $\\Delta T = T_d - T$. We substitute the expression for $T_d$ into this definition:\n$$\n\\Delta T = \\frac{k_{1}pT^{2}}{k_{1}pT + k_{2}e} - T\n$$\nTo simplify, we find a common denominator:\n$$\n\\Delta T = \\frac{k_{1}pT^{2} - T(k_{1}pT + k_{2}e)}{k_{1}pT + k_{2}e}\n$$\nExpanding the term in the numerator gives:\n$$\n\\Delta T = \\frac{k_{1}pT^{2} - k_{1}pT^{2} - k_{2}eT}{k_{1}pT + k_{2}e}\n$$\nThe first two terms in the numerator cancel, leaving the final closed-form expression for the bias:\n$$\n\\Delta T = \\frac{-k_{2}eT}{k_{1}pT + k_{2}e}\n$$\nThis expression demonstrates that the bias is always negative for positive physical quantities, meaning the dry retrieval always underestimates the true temperature in a moist atmosphere.\n\nFinally, we evaluate this bias numerically using the provided values:\n- $k_{1} = 77.6\\,\\mathrm{K/hPa}$\n- $k_{2} = 3.73 \\times 10^{5}\\,\\mathrm{K^{2}/hPa}$\n- $p = 850\\,\\mathrm{hPa}$\n- $T = 295\\,\\mathrm{K}$\n- $e = 20\\,\\mathrm{hPa}$\n\nWe calculate the numerator and the denominator of the expression for $\\Delta T$.\nNumerator:\n$$\n-k_{2}eT = -(3.73 \\times 10^{5}\\,\\mathrm{K^{2}/hPa}) \\times (20\\,\\mathrm{hPa}) \\times (295\\,\\mathrm{K}) = -2200700000\\,\\mathrm{K^{3}}\n$$\nDenominator:\n$$\nk_{1}pT + k_{2}e = (77.6\\,\\mathrm{K/hPa} \\times 850\\,\\mathrm{hPa} \\times 295\\,\\mathrm{K}) + (3.73 \\times 10^{5}\\,\\mathrm{K^{2}/hPa} \\times 20\\,\\mathrm{hPa})\n$$\n$$\nk_{1}pT + k_{2}e = (19458200\\,\\mathrm{K^{2}}) + (7460000\\,\\mathrm{K^{2}}) = 26918200\\,\\mathrm{K^{2}}\n$$\nNow, we compute the ratio:\n$$\n\\Delta T = \\frac{-2200700000\\,\\mathrm{K^{3}}}{26918200\\,\\mathrm{K^{2}}} \\approx -81.75549\\,\\mathrm{K}\n$$\nThe problem requires the final numerical value to be rounded to four significant figures.\n$$\n\\Delta T \\approx -81.76\\,\\mathrm{K}\n$$\nThis substantial negative bias highlights the critical importance of accounting for the moisture term in refractivity calculations, especially in the lower troposphere where water vapor is abundant.",
            "answer": "$$\n\\boxed{-81.76}\n$$"
        },
        {
            "introduction": "A robust data assimilation system relies not only on accurate forward models but also on rigorous quality control to filter out problematic observations. Certain atmospheric conditions, like strong temperature inversions or moisture gradients, can lead to super-refraction or even ducting, where the GPS signal is trapped. This hands-on practice  challenges you to move from theory to application by designing an automated QC test. You will derive the critical refractivity gradient for ducting from first principles and implement a decision-making algorithm to protect the analysis from these potentially corrupting observations.",
            "id": "4050111",
            "problem": "Design and implement a quality-control test for Global Positioning System (GPS) Radio Occultation (RO) observations used in Numerical Weather Prediction (NWP), to automatically detect super-refraction and ducting conditions using vertical gradients of refractivity. The goal is to decide whether an RO observation at a given tangent height should be accepted, downweighted, or rejected based on background fields. The test must be derived from first principles of geometric optics in a spherically stratified atmosphere and Earth curvature, starting from fundamental definitions of refractivity. The final program must produce one line of output aggregating the classification results for a provided test suite.\n\nDefinitions and requirements:\n- Refractivity is defined as $N = \\left(n - 1\\right)\\times 10^{6}$, where $n$ is the refractive index of air, and $N$ is dimensionless (commonly referred to as “N-units”).\n- The atmosphere is assumed horizontally stratified, and ray paths follow geometric optics governed by gradients of refractive index. Earth curvature must be accounted for via an appropriate transformation of refractivity.\n- You must derive a threshold, expressed in “N-units per kilometer,” for the vertical gradient of refractivity $dN/dz$ that corresponds to the onset of ducting. You must also propose and justify a secondary, less stringent threshold for aggressive downweighting when super-refraction is present but ducting is not, ensuring practical robustness in an assimilation system. All reasoning must be physically sound.\n- The decision rule must classify each observation at its tangent height $z_t$ into exactly one of the following integer categories:\n  - $0$: accept (no downweighting),\n  - $1$: downweight (super-refraction risk but not ducting),\n  - $2$: reject (ducting),\n  - $3$: indeterminate (insufficient valid background data near $z_t$ to estimate the gradient).\n- The algorithm must estimate the local vertical gradient $dN/dz$ at $z_t$ from background refractivity profiles $N(z)$ using a local linear fit in a symmetric window of half-width $W$ around $z_t$. The window half-width must be $W = 200$ meters. Use a robust method that requires at least $3$ valid points within the window; otherwise, return category $3$.\n- Units:\n  - Heights $z$ must be in meters.\n  - Vertical gradients $dN/dz$ must be computed in “N-units per kilometer” for threshold comparison.\n- Output format: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., “[result1,result2,result3]”), where each result is one of the integers $0$, $1$, $2$, or $3$ defined above.\n\nTest suite:\nImplement your solution for the following five test cases. In each case the background provides discrete vertical levels $z$ and corresponding refractivity values $N(z)$, along with the tangent height $z_t$. The background $N(z)$ arrays are provided directly (i.e., do not compute $N$ from pressure and temperature), and values are scientifically plausible.\n\n- Case $1$ (typical stratification, accept):\n  - $z$: from $0$ m to $2000$ m in steps of $100$ m.\n  - $N(z) = 300 - 40 \\times \\left(z / 1000\\right)$ (approximately linear decrease of $40$ N-units per kilometer).\n  - $z_t = 1000$ m.\n\n- Case $2$ (strong super-refraction, downweight):\n  - $z$: from $0$ m to $2000$ m in steps of $100$ m.\n  - $N(z) = 320 - 130 \\times \\left(z / 1000\\right)$ (approximately linear decrease of $130$ N-units per kilometer).\n  - $z_t = 800$ m.\n\n- Case $3$ (ducting, reject):\n  - $z$: from $0$ m to $2000$ m in steps of $100$ m.\n  - $N(z) = 340 - 170 \\times \\left(z / 1000\\right)$ (approximately linear decrease of $170$ N-units per kilometer).\n  - $z_t = 500$ m.\n\n- Case $4$ (near critical, boundary condition):\n  - $z$: from $0$ m to $2000$ m in steps of $50$ m.\n  - $N(z) = 330 - 157 \\times \\left(z / 1000\\right)$ (approximately linear decrease of $157$ N-units per kilometer).\n  - $z_t = 600$ m.\n\n- Case $5$ (insufficient valid data near $z_t$, indeterminate):\n  - $z$: from $0$ m to $2000$ m in steps of $100$ m.\n  - $N(z) = 310 - 80 \\times \\left(z / 1000\\right)$, except set $N(z)$ to missing (not-a-number) for all $z$ with $|z - 1200| \\le 200$ m.\n  - $z_t = 1200$ m.\n\nYour program must:\n- Estimate $dN/dz$ at $z_t$ using a least-squares linear fit within $|z - z_t| \\le W$.\n- Convert the fitted slope to “N-units per kilometer.”\n- Apply your derived ducting threshold and your justified downweight threshold to produce the classification for each case.\n- Print a single line exactly in the required format, aggregating the five integer results in case order.",
            "solution": "The problem statement is evaluated to be scientifically sound, well-posed, objective, and self-contained. It is grounded in the established principles of atmospheric physics and geometric optics related to radio wave propagation. The request to derive physical thresholds from first principles and then implement them in a quality-control algorithm is a standard and valid task in Numerical Weather Prediction (NWP) and data assimilation. The provided test cases are well-defined and use scientifically plausible values. A standard, widely accepted value for the Earth's mean radius will be assumed, which is a common and legitimate practice for problems of this nature. Therefore, we proceed with a full solution.\n\nThe primary task is to develop a quality-control test for GPS Radio Occultation (RO) refractivity profiles. This involves deriving thresholds for the vertical gradient of refractivity, $dN/dz$, to detect conditions of super-refraction and ducting. These conditions can cause large errors in the observation operator used in data assimilation, necessitating the rejection or downweighting of the affected data.\n\nThe derivation begins from the principles of geometric optics for ray propagation in a spherically stratified atmosphere.\n\n**1. Derivation of the Ducting Threshold**\n\nThe curvature of a ray path, $\\kappa$, in a medium with a spatially varying refractive index, $n$, is given by:\n$$\n\\kappa = \\frac{1}{\\rho_{\\text{ray}}} = \\frac{1}{n} |\\nabla_{\\perp} n|\n$$\nwhere $\\rho_{\\text{ray}}$ is the radius of curvature of the ray, and $\\nabla_{\\perp} n$ is the component of the gradient of $n$ perpendicular to the ray's direction.\n\nFor a nearly horizontal ray in a spherically stratified atmosphere (where $n$ varies only with altitude $z$), the gradient is vertical, so $\\nabla n \\approx \\frac{dn}{dz}\\mathbf{\\hat{k}}$. The component perpendicular to the ray is approximately $\\frac{dn}{dz}$. The ray bends towards higher refractive index, so for a standard atmosphere where $n$ decreases with height, $\\frac{dn}{dz}$ is negative and the ray bends downwards. The curvature is $\\kappa = -\\frac{1}{n}\\frac{dn}{dz}$.\n\nDucting, or trapping, of a radio wave occurs when its downward curvature is greater than or equal to the curvature of the Earth's surface. This condition traps the ray in a layer near the surface. The Earth's curvature is $\\kappa_E = 1/R_E$, where $R_E$ is the mean radius of the Earth.\n\nThe condition for ducting is therefore:\n$$\n\\kappa \\ge \\kappa_E \\implies -\\frac{1}{n}\\frac{dn}{dz} \\ge \\frac{1}{R_E}\n$$\nRearranging for the gradient gives the critical condition for the onset of ducting:\n$$\n\\frac{dn}{dz} \\le -\\frac{n}{R_E}\n$$\n\nIt is more convenient to work with refractivity, $N$, defined as $N = (n-1) \\times 10^6$. From this, we have $n = 1 + N \\times 10^{-6}$. Differentiating with respect to altitude $z$ yields:\n$$\n\\frac{dn}{dz} = 10^{-6} \\frac{dN}{dz}\n$$\nSubstituting this into the ducting condition:\n$$\n10^{-6} \\frac{dN}{dz} \\le -\\frac{n}{R_E}\n$$\n$$\n\\frac{dN}{dz} \\le -\\frac{n \\times 10^6}{R_E}\n$$\nIn the Earth's atmosphere, the refractive index $n$ is very close to $1$ (typically $n \\approx 1.0003$ at the surface). We can therefore make the excellent approximation $n \\approx 1$. The ducting threshold becomes:\n$$\n\\frac{dN}{dz} \\le -\\frac{10^6}{R_E}\n$$\nTo calculate a numerical value, we use the standard mean Earth radius, $R_E \\approx 6371$ km. The problem requires the gradient in N-units per kilometer. If $z$ is in kilometers, the threshold is:\n$$\n\\frac{dN}{dz_{\\text{km}}} \\le -\\frac{10^6}{6371 \\text{ km}} \\approx -156.96 \\text{ N-units/km}\n$$\nFor practical application in NWP quality control, this value is typically rounded. We will set the ducting threshold, $T_{\\text{duct}}$, to a standard, physically-derived value.\n$$\nT_{\\text{duct}} = -157 \\text{ N-units/km}\n$$\nAny observation where the estimated local gradient $dN/dz$ is less than or equals this threshold will be classified as Category $2$ (Reject).\n\n**2. Justification of the Super-refraction Downweighting Threshold**\n\nSuper-refraction refers to any condition where the refractivity gradient is more negative than that of a standard atmosphere, but not necessarily strong enough to cause ducting. The gradient for a U.S. Standard Atmosphere is approximately $-39$ N-units/km. Very strong negative gradients are typically caused by sharp vertical decreases in humidity, such as at the top of the marine boundary layer.\n\nThese sharp gradients pose a challenge for NWP models, which may not have the vertical resolution to represent them accurately. The RO forward models often assume spherical symmetry, an assumption that is violated in situations with sharp horizontal variations that often accompany such vertical gradients. This can lead to larger-than-expected observation errors.\n\nTherefore, it is prudent to downweight observations in the presence of strong super-refraction, even if ducting evidence is not present. A secondary threshold, $T_{\\text{super}}$, is established for this purpose. The choice of $T_{\\text{super}}$ is a heuristic balance between retaining as much data as possible and avoiding the assimilation of potentially erroneous observations.\n\nA reasonable and robust choice is a value that flags gradients that are significantly more negative than a typical atmosphere but are still a safe margin away from the critical ducting limit. A value of $80\\%$ of the ducting threshold is a common practice.\n$$\nT_{\\text{super}} = 0.8 \\times T_{\\text{duct}} = 0.8 \\times (-157 \\text{ N-units/km}) \\approx -125.6 \\text{ N-units/km}\n$$\nWe will round this to a whole number for clarity and practical implementation:\n$$\nT_{\\text{super}} = -125 \\text{ N-units/km}\n$$\nThis threshold effectively flags conditions of strong atmospheric stratification that warrant caution in a data assimilation system.\n\n**3. Algorithm Design and Classification Logic**\n\nThe quality control algorithm processes each RO observation at its tangent height $z_t$ using a background refractivity profile $N(z)$.\n\n1.  **Data Windowing**: For a given tangent height $z_t$, select all background data points $(z_i, N_i)$ that fall within a symmetric vertical window of half-width $W=200$ m. That is, select points where $|z_i - z_t| \\le 200$ m.\n\n2.  **Data Validity Check**: From the windowed data, discard any points with invalid or missing $N$ values (e.g., NaN). Count the number of remaining, valid data points, $N_{\\text{valid}}$.\n\n3.  **Gradient Estimation**:\n    *   If $N_{\\text{valid}} < 3$, the data is insufficient for a reliable linear fit. The observation is classified as Category $3$ (Indeterminate).\n    *   If $N_{\\text{valid}} \\ge 3$, perform a linear least-squares fit on the valid data points to find the slope $a$ that minimizes $\\sum_i ((a z_i + b) - N_i)^2$. This slope, $a = dN/dz$, is in N-units per meter.\n\n4.  **Unit Conversion**: Convert the slope to the required units of N-units per kilometer:\n    $$\n    g = \\frac{dN}{dz} [\\text{N-units/km}] = a [\\text{N-units/m}] \\times 1000 [\\text{m/km}]\n    $$\n\n5.  **Classification**: Apply the derived thresholds to the calculated gradient $g$:\n    *   **Category 2 (Reject)**: If $g \\le T_{\\text{duct}}$ (i.e., $g \\le -157$).\n    *   **Category 1 (Downweight)**: If $T_{\\text{duct}} < g \\le T_{\\text{super}}$ (i.e., $-157 < g \\le -125$).\n    *   **Category 0 (Accept)**: If $g > T_{\\text{super}}$ (i.e., $g > -125$).\n\nThis structured approach provides a-priori, physically-based quality control for RO observations, enhancing the robustness of their assimilation into NWP models. The algorithm will now be implemented and applied to the provided test suite.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef quality_control(z_profile: np.ndarray, n_profile: np.ndarray, z_t: float, window_half_width: float) -> int:\n    \"\"\"\n    Performs quality control on a GPS RO observation based on background refractivity gradients.\n\n    Args:\n        z_profile: Array of background altitude levels in meters.\n        n_profile: Array of background refractivity values (N-units).\n        z_t: Tangent height of the observation in meters.\n        window_half_width: Half-width of the fitting window in meters.\n\n    Returns:\n        An integer classification: 0 (accept), 1 (downweight), 2 (reject), 3 (indeterminate).\n    \"\"\"\n    # Derived thresholds from first principles\n    T_DUCT = -157.0  # Ducting threshold in N-units/km\n    T_SUPER = -125.0  # Super-refraction (downweighting) threshold in N-units/km\n    MIN_POINTS_FOR_FIT = 3\n\n    # 1. Data Windowing\n    window_mask = np.abs(z_profile - z_t) = window_half_width\n    z_window = z_profile[window_mask]\n    n_window = n_profile[window_mask]\n\n    # 2. Data Validity Check\n    valid_mask = ~np.isnan(n_window)\n    z_fit = z_window[valid_mask]\n    n_fit = n_window[valid_mask]\n    num_valid_points = len(z_fit)\n\n    # 3. Gradient Estimation\n    if num_valid_points  MIN_POINTS_FOR_FIT:\n        return 3  # Indeterminate\n\n    # Perform a linear least-squares fit (degree 1 polynomial)\n    # The slope is in N-units per meter\n    try:\n        slope_m, _ = np.polyfit(z_fit, n_fit, 1)\n    except (np.linalg.LinAlgError, ValueError):\n        # This can happen if, e.g., all z_fit values are identical,\n        # which is unlikely in this context but good to be robust.\n        return 3\n\n    # 4. Unit Conversion\n    # Convert from N-units/meter to N-units/kilometer\n    gradient_km = slope_m * 1000.0\n\n    # 5. Classification\n    if gradient_km = T_DUCT:\n        return 2  # Reject (ducting)\n    elif gradient_km = T_SUPER:\n        return 1  # Downweight (super-refraction)\n    else:\n        return 0  # Accept\n\ndef solve():\n    \"\"\"\n    Main function to define test cases, run a quality control algorithm, and print results.\n    \"\"\"\n    # Window half-width in meters, as specified in the problem.\n    W = 200.0\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: Typical stratification, accept\n        {\n            \"z_range\": (0, 2001, 100),\n            \"n_func\": lambda z: 300.0 - 40.0 * (z / 1000.0),\n            \"z_t\": 1000.0,\n            \"nan_z_range\": None\n        },\n        # Case 2: Strong super-refraction, downweight\n        {\n            \"z_range\": (0, 2001, 100),\n            \"n_func\": lambda z: 320.0 - 130.0 * (z / 1000.0),\n            \"z_t\": 800.0,\n            \"nan_z_range\": None\n        },\n        # Case 3: Ducting, reject\n        {\n            \"z_range\": (0, 2001, 100),\n            \"n_func\": lambda z: 340.0 - 170.0 * (z / 1000.0),\n            \"z_t\": 500.0,\n            \"nan_z_range\": None\n        },\n        # Case 4: Near critical, boundary condition\n        {\n            \"z_range\": (0, 2001, 50),\n            \"n_func\": lambda z: 330.0 - 157.0 * (z / 1000.0),\n            \"z_t\": 600.0,\n            \"nan_z_range\": None\n        },\n        # Case 5: Insufficient valid data, indeterminate\n        {\n            \"z_range\": (0, 2001, 100),\n            \"n_func\": lambda z: 310.0 - 80.0 * (z / 1000.0),\n            \"z_t\": 1200.0,\n            \"nan_z_range\": (1200.0, 200.0) # center, half-width\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        # Generate the background profile\n        z_profile = np.arange(*case[\"z_range\"])\n        n_profile = case[\"n_func\"](z_profile)\n\n        # Introduce missing data for Case 5\n        if case[\"nan_z_range\"] is not None:\n            center, half_width = case[\"nan_z_range\"]\n            nan_mask = np.abs(z_profile - center) = half_width\n            n_profile[nan_mask] = np.nan\n        \n        # Run the quality control\n        result = quality_control(z_profile, n_profile, case[\"z_t\"], W)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Variational data assimilation systems, such as 4D-Var, work by iteratively adjusting the model state to minimize the mismatch between forecasts and observations. This minimization process requires the gradient of the cost function, which in turn depends on the sensitivity of each observation to changes in the model's state variables. This exercise  focuses on this core mathematical step, asking you to derive the partial derivatives of refractivity with respect to temperature and water vapor pressure. Calculating this Jacobian for the observation operator is a fundamental skill for understanding and developing advanced assimilation systems.",
            "id": "4050127",
            "problem": "Consider the assimilation of Global Positioning System (GPS) radio occultation observations into a variational numerical weather prediction (NWP) system. The forward observation operator maps the model state to refractivity, which is defined by $N = 10^{6} (n - 1)$, where $n$ is the refractive index of moist air. A well-tested formula relating refractivity to thermodynamic state is the Smith–Weintraub relation, which can be written in terms of total pressure $P$, temperature $T$, and water vapor partial pressure $e$ as\n$$\nN(T,e,P) = k_{1} \\,\\frac{P}{T} + k_{2} \\,\\frac{e}{T^{2}},\n$$\nwhere $k_{1}$ and $k_{2}$ are positive constants determined from laboratory measurements and electromagnetic theory.\n\nIn variational data assimilation, the linearized observation operator requires sensitivity of $N$ with respect to the control variables. Assuming $P$ is held constant for the purpose of computing partial derivatives with respect to $T$ and $e$ (i.e., $\\partial P/\\partial T = 0$ and $\\partial P/\\partial e = 0$), derive the analytic expressions for the sensitivities $\\frac{\\partial N}{\\partial T}$ and $\\frac{\\partial N}{\\partial e}$ implied by the Smith–Weintraub relation. Express your final answer as closed-form analytic expressions in terms of $k_{1}$, $k_{2}$, $P$, $T$, and $e$. No numerical evaluation is required.",
            "solution": "The problem is valid. It is a well-posed mathematical exercise grounded in the fundamental principles of atmospheric physics and numerical weather prediction. The Smith–Weintraub relation is a cornerstone in the interpretation of radio occultation data, and the calculation of its partial derivatives (the Jacobian) is a critical step in variational data assimilation schemes. All terms are clearly defined, and the necessary assumptions are explicitly stated.\n\nThe problem requires the derivation of the partial derivatives of the refractivity $N$ with respect to temperature $T$ and water vapor partial pressure $e$. The given expression for refractivity is the Smith–Weintraub relation:\n$$\nN(T,e,P) = k_{1} \\frac{P}{T} + k_{2} \\frac{e}{T^{2}}\n$$\nwhere $k_{1}$ and $k_{2}$ are constants, $P$ is the total pressure, $T$ is the temperature, and $e$ is the water vapor partial pressure.\n\nThe problem states that for the purpose of this calculation, $P$ is to be treated as a constant with respect to both $T$ and $e$. This means we are to compute the partial derivatives treating $T$, $e$, and $P$ as independent variables.\n\nFirst, we calculate the sensitivity of $N$ with respect to temperature, $\\frac{\\partial N}{\\partial T}$. This involves differentiating the expression for $N$ with respect to $T$ while holding $P$ and $e$ constant. We can differentiate term by term:\n$$\n\\frac{\\partial N}{\\partial T} = \\frac{\\partial}{\\partial T} \\left( k_{1} \\frac{P}{T} + k_{2} \\frac{e}{T^{2}} \\right) = \\frac{\\partial}{\\partial T} \\left( k_{1} P T^{-1} \\right) + \\frac{\\partial}{\\partial T} \\left( k_{2} e T^{-2} \\right)\n$$\nUsing the power rule for differentiation, $\\frac{d}{dx}(ax^n) = anx^{n-1}$, we find the derivative of each term.\n\nFor the first term, with respect to $T$:\n$$\n\\frac{\\partial}{\\partial T} \\left( k_{1} P T^{-1} \\right) = k_{1} P \\frac{\\partial}{\\partial T} \\left( T^{-1} \\right) = k_{1} P (-1)T^{-1-1} = -k_{1} P T^{-2} = -k_{1} \\frac{P}{T^{2}}\n$$\n\nFor the second term, with respect to $T$:\n$$\n\\frac{\\partial}{\\partial T} \\left( k_{2} e T^{-2} \\right) = k_{2} e \\frac{\\partial}{\\partial T} \\left( T^{-2} \\right) = k_{2} e (-2)T^{-2-1} = -2k_{2} e T^{-3} = -2k_{2} \\frac{e}{T^{3}}\n$$\nCombining these two results, we obtain the expression for the sensitivity with respect to temperature:\n$$\n\\frac{\\partial N}{\\partial T} = -k_{1} \\frac{P}{T^{2}} - 2k_{2} \\frac{e}{T^{3}}\n$$\n\nNext, we calculate the sensitivity of $N$ with respect to the water vapor partial pressure, $\\frac{\\partial N}{\\partial e}$. This involves differentiating the expression for $N$ with respect to $e$ while holding $P$ and $T$ constant. Again, we differentiate term by term:\n$$\n\\frac{\\partial N}{\\partial e} = \\frac{\\partial}{\\partial e} \\left( k_{1} \\frac{P}{T} + k_{2} \\frac{e}{T^{2}} \\right) = \\frac{\\partial}{\\partial e} \\left( k_{1} \\frac{P}{T} \\right) + \\frac{\\partial}{\\partial e} \\left( k_{2} \\frac{e}{T^{2}} \\right)\n$$\nFor the first term, the variables $k_{1}$, $P$, and $T$ are all treated as constants with respect to $e$. Therefore, the derivative of this term is zero:\n$$\n\\frac{\\partial}{\\partial e} \\left( k_{1} \\frac{P}{T} \\right) = 0\n$$\nFor the second term, we differentiate with respect to $e$:\n$$\n\\frac{\\partial}{\\partial e} \\left( k_{2} \\frac{e}{T^{2}} \\right) = \\frac{k_{2}}{T^{2}} \\frac{\\partial}{\\partial e} (e) = \\frac{k_{2}}{T^{2}} (1) = \\frac{k_{2}}{T^{2}}\n$$\nCombining these results gives the expression for the sensitivity with respect to water vapor partial pressure:\n$$\n\\frac{\\partial N}{\\partial e} = \\frac{k_{2}}{T^{2}}\n$$\nThus, the required analytic expressions for the sensitivities are $-k_{1} \\frac{P}{T^{2}} - 2k_{2} \\frac{e}{T^{3}}$ for $\\frac{\\partial N}{\\partial T}$ and $\\frac{k_{2}}{T^{2}}$ for $\\frac{\\partial N}{\\partial e}$.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} -k_{1} \\frac{P}{T^{2}} - 2k_{2} \\frac{e}{T^{3}}  \\frac{k_{2}}{T^{2}} \\end{pmatrix}}\n$$"
        }
    ]
}