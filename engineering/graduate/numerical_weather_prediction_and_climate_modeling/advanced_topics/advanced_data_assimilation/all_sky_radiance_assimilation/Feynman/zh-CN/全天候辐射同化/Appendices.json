{
    "hands_on_practices": [
        {
            "introduction": "在同化全天候辐射资料之前，理解云与卫星测量辐射之间的物理联系至关重要。本练习提供了一个具体的第一性原理计算，旨在量化冰云如何通过散射过程影响微波亮温。通过解决这个问题 ()，你将对同化系统所要利用的云信号的量级有一个切实的体会。",
            "id": "4011516",
            "problem": "一个位于 $183 \\ \\mathrm{GHz}$ 水汽吸收特征附近的卫星微波湿度探测仪通道，在全天候辐射框架下被同化用于数值天气预报。考虑一个均匀的冰云层，其几何厚度为 $H = 2.0 \\times 10^{3} \\ \\mathrm{m}$，冰水含量（IWC）为 $1.0 \\times 10^{-4} \\ \\mathrm{kg} \\ \\mathrm{m}^{-3}$，粒子有效半径为 $r_{e} = 1.0 \\times 10^{-4} \\ \\mathrm{m}$。假设冰粒子是均匀球体，在 $183 \\ \\mathrm{GHz}$ 的复折射率为 $m = 1.78 + i \\, 0.002$，冰的密度为 $\\rho_{i} = 917 \\ \\mathrm{kg} \\ \\mathrm{m}^{-3}$。仪器以 $\\theta = 53^{\\circ}$ 的天顶角观测该场景，沿此视线的晴空大气层顶亮温为 $T_{b}^{\\mathrm{clear}} = 245 \\ \\mathrm{K}$。忽略冰的发射和多次散射，并将散射处理为从仪器狭窄视线中移除辐射（即散射仅对消光有贡献）。假设其余大气不因云的存在而改变。使用 Rayleigh–Jeans 近似来关联辐射率和亮温。\n\n从受消光影响的光束的标量辐射传输方程出发，并使用针对小球体的 Rayleigh 散射结果，其中散射效率因子为\n$$\nQ_{\\mathrm{sca}} = \\frac{8}{3} \\, x^{4} \\left| \\frac{m^{2} - 1}{m^{2} + 2} \\right|^{2},\n$$\n其中尺寸参数为 $x = \\frac{2 \\pi r_{e}}{\\lambda}$，波长 $\\lambda = \\frac{c}{f}$（$c$ 为光速，$f$ 为频率），推导一个仅由冰云散射引起的大气层顶亮温降低 $\\Delta T_{b}$ 的表达式。然后，对于 $f = 183 \\times 10^{9} \\ \\mathrm{Hz}$ 和 $c = 2.99792458 \\times 10^{8} \\ \\mathrm{m} \\ \\mathrm{s}^{-1}$，数值计算 $\\Delta T_{b}$。\n\n以开尔文为单位，将你的最终答案表示为单个数字，并将结果四舍五入到三位有效数字。在你的推理过程中清楚地说明任何中间假设。",
            "solution": "### 步骤 1：提取已知条件\n- 仪器：微波湿度探测仪\n- 频率：$f = 183 \\times 10^{9} \\ \\mathrm{Hz}$\n- 云：均匀冰云层\n- 几何厚度：$H = 2.0 \\times 10^{3} \\ \\mathrm{m}$\n- 冰水含量：$\\mathrm{IWC} = 1.0 \\times 10^{-4} \\ \\mathrm{kg} \\ \\mathrm{m}^{-3}$\n- 粒子有效半径：$r_{e} = 1.0 \\times 10^{-4} \\ \\mathrm{m}$\n- 冰粒子形状：均匀球体\n- 冰的复折射率：$m = 1.78 + i \\, 0.002$\n- 冰的密度：$\\rho_{i} = 917 \\ \\mathrm{kg} \\ \\mathrm{m}^{-3}$\n- 仪器天顶角：$\\theta = 53^{\\circ}$\n- 晴空大气层顶亮温：$T_{b}^{\\mathrm{clear}} = 245 \\ \\mathrm{K}$\n- 光速：$c = 2.99792458 \\times 10^{8} \\ \\mathrm{m} \\ \\mathrm{s}^{-1}$\n- 散射效率因子 (Rayleigh)：$Q_{\\mathrm{sca}} = \\frac{8}{3} \\, x^{4} \\left| \\frac{m^{2} - 1}{m^{2} + 2} \\right|^{2}$\n- 尺寸参数：$x = \\frac{2 \\pi r_{e}}{\\lambda}$\n- 波长：$\\lambda = \\frac{c}{f}$\n- 假设/简化：\n    1.  忽略冰的发射。\n    2.  忽略多次散射。\n    3.  散射仅对消光有贡献。\n    4.  云外大气保持不变。\n    5.  使用 Rayleigh–Jeans 近似。\n\n### 步骤 2：解题推导\n\n问题要求计算由冰云散射引起的大气层顶亮温降低 $\\Delta T_{b}$。我们从仅受消光影响的、沿路径 $s$ 传播的辐射率 $I$ 光束的标量辐射传输方程 (RTE) 开始。\n$$\n\\frac{dI}{ds} = -k_{\\mathrm{ext}} I\n$$\n其中 $k_{\\mathrm{ext}}$ 是体消光系数。问题说明忽略冰的发射和多次散射。根据 Kirchhoff 热辐射定律，不发射的介质也不吸收。因此，消光完全是由光束外的散射引起的，所以 $k_{\\mathrm{ext}} = k_{\\mathrm{sca}}$，其中 $k_{\\mathrm{sca}}$ 是体散射系数。\n\n对于均匀云，$k_{\\mathrm{sca}}$ 是恒定的。沿穿过云的斜程路径 $s$ 积分 RTE 可得：\n$$\nI(s) = I(0) \\exp(-k_{\\mathrm{sca}} s)\n$$\n此处，$I(0)$ 是入射到云底的上行辐射率，$I(s)$ 是从云顶射出的辐射率。穿过云的斜程路径长度为 $s = H / \\cos(\\theta)$，其中 $H$ 是几何厚度，$\\theta$ 是天顶角。乘积 $k_{\\mathrm{sca}} s$ 是沿斜程路径的云光学厚度，$\\tau_{\\mathrm{cld}}$。\n$$\n\\tau_{\\mathrm{cld}} = \\frac{k_{\\mathrm{sca}} H}{\\cos(\\theta)}\n$$\n问题说明使用 Rayleigh-Jeans 近似，其中辐射率 $I$ 与亮温 $T_{b}$ 成正比。这使我们能够用 $T_{b}$ 来表示 RTE：\n$$\nT_{b}^{\\mathrm{cloudy}} = T_{b}^{\\mathrm{clear}} \\exp(-\\tau_{\\mathrm{cld}})\n$$\n此处，$T_{b}^{\\mathrm{clear}}$ 是没有云时会观测到的亮温，代表来自下方的辐射源；而 $T_{b}^{\\mathrm{cloudy}}$ 是在有云存在时观测到的衰减后的亮温。\n\n亮温降低 $\\Delta T_{b}$ 是晴空和有云天空亮温之间的差值：\n$$\n\\Delta T_{b} = T_{b}^{\\mathrm{clear}} - T_{b}^{\\mathrm{cloudy}} = T_{b}^{\\mathrm{clear}} - T_{b}^{\\mathrm{clear}} \\exp(-\\tau_{\\mathrm{cld}})\n$$\n$$\n\\Delta T_{b} = T_{b}^{\\mathrm{clear}} \\left(1 - \\exp(-\\tau_{\\mathrm{cld}})\\right)\n$$\n为了计算这个值，我们必须首先确定 $\\tau_{\\mathrm{cld}}$。这需要计算 $k_{\\mathrm{sca}}$。体散射系数是散射体数密度 $N$ 与单个粒子散射截面 $\\sigma_{\\mathrm{sca}}$ 的乘积：\n$$\nk_{\\mathrm{sca}} = N \\sigma_{\\mathrm{sca}}\n$$\n数密度 $N$ 可以从冰水含量 (IWC) 中求出，IWC 是单位体积内冰的总质量。对于半径为 $r_e$、密度为 $\\rho_i$ 的球形粒子，单个粒子的质量为 $M_{p} = \\rho_i V_{p} = \\rho_{i} \\frac{4}{3} \\pi r_{e}^{3}$。那么，$\\mathrm{IWC} = N M_p$。\n$$\nN = \\frac{\\mathrm{IWC}}{M_{p}} = \\frac{\\mathrm{IWC}}{\\rho_{i} \\frac{4}{3} \\pi r_{e}^{3}} = \\frac{3 \\, \\mathrm{IWC}}{4 \\pi \\rho_{i} r_{e}^{3}}\n$$\n散射截面 $\\sigma_{\\mathrm{sca}}$ 是粒子几何截面 $A_{p} = \\pi r_{e}^{2}$ 与散射效率 $Q_{\\mathrm{sca}}$ 的乘积。\n$$\n\\sigma_{\\mathrm{sca}} = A_{p} Q_{\\mathrm{sca}} = \\pi r_{e}^{2} Q_{\\mathrm{sca}}\n$$\n将这些结合起来，得到 $k_{\\mathrm{sca}}$ 的表达式：\n$$\nk_{\\mathrm{sca}} = \\left( \\frac{3 \\, \\mathrm{IWC}}{4 \\pi \\rho_{i} r_{e}^{3}} \\right) (\\pi r_{e}^{2} Q_{\\mathrm{sca}}) = \\frac{3 \\, \\mathrm{IWC} \\, Q_{\\mathrm{sca}}}{4 \\, \\rho_{i} \\, r_{e}}\n$$\n现在，我们必须使用给定的公式来计算 $Q_{\\mathrm{sca}}$：\n$$\nQ_{\\mathrm{sca}} = \\frac{8}{3} \\, x^{4} \\left| \\frac{m^{2} - 1}{m^{2} + 2} \\right|^{2}\n$$\n首先，我们计算波长 $\\lambda$ 和尺寸参数 $x$：\n$$\n\\lambda = \\frac{c}{f} = \\frac{2.99792458 \\times 10^{8} \\, \\mathrm{m \\, s^{-1}}}{183 \\times 10^{9} \\, \\mathrm{Hz}} \\approx 1.63821 \\times 10^{-3} \\, \\mathrm{m}\n$$\n$$\nx = \\frac{2 \\pi r_{e}}{\\lambda} = \\frac{2 \\pi (1.0 \\times 10^{-4} \\, \\mathrm{m})}{1.63821 \\times 10^{-3} \\, \\mathrm{m}} \\approx 0.38356\n$$\n接下来，我们使用 $m = 1.78 + i \\, 0.002$ 计算复数项：\n$$\nm^{2} = (1.78 + i \\, 0.002)^{2} = 1.78^{2} + 2(1.78)(i \\, 0.002) + (i \\, 0.002)^{2} = 3.1684 + i \\, 0.00712 - 0.000004 = 3.168396 + i \\, 0.00712\n$$\n项 $\\left| \\frac{m^{2} - 1}{m^{2} + 2} \\right|^{2}$ 是一个复数比的模的平方，可以计算为分子模的平方与分母模的平方之比：\n$$\n\\left| \\frac{m^{2} - 1}{m^{2} + 2} \\right|^{2} = \\frac{|(3.168396 - 1) + i \\, 0.00712|^{2}}{|(3.168396 + 2) + i \\, 0.00712|^{2}} = \\frac{|2.168396 + i \\, 0.00712|^{2}}{|5.168396 + i \\, 0.00712|^{2}}\n$$\n$$\n= \\frac{2.168396^{2} + 0.00712^{2}}{5.168396^{2} + 0.00712^{2}} = \\frac{4.70198 + 5.06944 \\times 10^{-5}}{26.71235 + 5.06944 \\times 10^{-5}} \\approx \\frac{4.70203}{26.71240} \\approx 0.17602\n$$\n现在我们可以计算 $Q_{\\mathrm{sca}}$：\n$$\nQ_{\\mathrm{sca}} \\approx \\frac{8}{3} (0.38356)^{4} (0.17602) \\approx \\frac{8}{3} (0.021642) (0.17602) \\approx 0.010134\n$$\n有了 $Q_{\\mathrm{sca}}$，我们就可以求出 $k_{\\mathrm{sca}}$：\n$$\nk_{\\mathrm{sca}} = \\frac{3 \\cdot (1.0 \\times 10^{-4} \\, \\mathrm{kg \\, m^{-3}}) \\cdot (0.010134)}{4 \\cdot (917 \\, \\mathrm{kg \\, m^{-3}}) \\cdot (1.0 \\times 10^{-4} \\, \\mathrm{m})} = \\frac{3.0402 \\times 10^{-6} \\, \\mathrm{kg \\, m^{-3}}}{0.3668 \\, \\mathrm{kg \\, m^{-3}}} \\approx 8.2887 \\times 10^{-6} \\, \\mathrm{m^{-1}}\n$$\n接下来，我们计算云光学厚度 $\\tau_{\\mathrm{cld}}$：\n$$\n\\cos(53^{\\circ}) \\approx 0.601815\n$$\n$$\n\\tau_{\\mathrm{cld}} = \\frac{k_{\\mathrm{sca}} H}{\\cos(\\theta)} \\approx \\frac{(8.2887 \\times 10^{-6} \\, \\mathrm{m^{-1}}) (2.0 \\times 10^{3} \\, \\mathrm{m})}{0.601815} \\approx \\frac{0.0165774}{0.601815} \\approx 0.027546\n$$\n最后，我们计算亮温降低 $\\Delta T_{b}$：\n$$\n\\Delta T_{b} = T_{b}^{\\mathrm{clear}} \\left(1 - \\exp(-\\tau_{\\mathrm{cld}})\\right) \\approx 245 \\, \\mathrm{K} \\left(1 - \\exp(-0.027546)\\right)\n$$\n$$\n\\Delta T_{b} \\approx 245 \\, (1 - 0.972828) = 245 \\, (0.027172) \\approx 6.65714 \\, \\mathrm{K}\n$$\n将结果四舍五入到三位有效数字，得到 $6.66 \\, \\mathrm{K}$。",
            "answer": "$$\\boxed{6.66}$$"
        },
        {
            "introduction": "资料同化系统依赖于了解观测对大气状态变化的敏感程度，而这种敏感性在数学上由观测算子的雅可比矩阵来描述。本练习将指导你推导并实现一个简化的正演模型及其雅可比矩阵 ()。这将使你能够直接计算和比较不同微波通道对各种水凝物的响应，这是通道选择和理解观测信息含量的关键一步。",
            "id": "4011543",
            "problem": "您的任务是构建并分析一个简化的、物理上一致的正向模型，该模型与数值天气预报和气候模拟中的微波成像仪全天辐射率同化相关。目标是计算大气层顶亮度温度相对于水凝物混合比的逐通道雅可比矩阵，并根据通道对云冰的敏感度进行排序。\n\n基本和建模假设：从微波（MW）波段下、满足局部热力学平衡（LTE）且无散射的一维平面平行热辐射传输方程出发。其控制方程是针对上行辐射的 Schwarzschild 方程。将大气表示为一个温度和消光恒定的均质平板层，由一个天底轨道成像仪观测。大气层顶（TOA）亮度温度在瑞利-金斯（Rayleigh-Jeans）极限下考虑，并包含一个具有特定发射率的非黑体表面。\n\n使用的定义和变量：\n- 亮温和热力学温度均用 $T$ 表示，单位必须是开尔文 ($\\mathrm{K}$)。\n- 地表温度 $T_s$（单位 $\\mathrm{K}$），层温度 $T_\\ell$（单位 $\\mathrm{K}$），以及地表发射率 $\\varepsilon$（无量纲）。\n- 观测天顶角 $\\theta$（单位度），路径因子 $\\mu = \\cos(\\theta \\times \\pi / 180)$（无量纲）。\n- 平板层的柱质量路径 $M$（单位 $\\mathrm{kg}\\,\\mathrm{m}^{-2}$）。\n- 每个通道频率 $\\nu$ 的单位质量路径气体质量消光系数 $\\,\\kappa_g(\\nu)$（单位 $\\mathrm{m}^2\\,\\mathrm{kg}^{-1}$）。\n- 四种水凝物种类的混合比 $q_i$（无量纲，单位 $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$）：云冰（$q_{\\mathrm{ice}}$）、云液（$q_{\\mathrm{liq}}$）、雨（$q_{\\mathrm{rain}}$）和雪（$q_{\\mathrm{snow}}$）。\n- 水凝物质量消光系数 $\\,\\alpha_i(\\nu)$（与种类和频率相关，单位 $\\mathrm{m}^2\\,\\mathrm{kg}^{-1}$）。\n- 通道对应三个频率：$23.8$、$36.5$ 和 $89.0$ 吉赫兹（GHz）。\n\n要实现的正向模型规范：\n- 在均质平板层中使用 Schwarzschild 方程，其源函数等于瑞利-金斯极限下的普朗克函数，并使用入射地表亮温 $T_b^{\\mathrm{surf}} = \\varepsilon T_s$。\n- 给定通道的单位质量路径总质量消光为 $K(\\nu) = \\kappa_g(\\nu) + \\sum_{i} \\alpha_i(\\nu) \\, q_i$，其中求和遍历四种水凝物种类。\n- 沿视线方向的平板层光学厚度为 $\\tau_{\\mathrm{opt}}(\\nu) = \\dfrac{M}{\\mu} \\, K(\\nu)$。\n- 每个通道的 TOA 亮温是 Schwarzschild 方程沿视线方向在指定地表边界条件下的均质平板层解。\n\n您的程序必须为每个测试用例和每个通道计算：\n1. 雅可比矩阵 $\\dfrac{\\partial T_b}{\\partial q_i}$，即相对于每种水凝物混合比 $q_i$ 的偏导数，其中 $i \\in \\{\\mathrm{ice}, \\mathrm{liq}, \\mathrm{rain}, \\mathrm{snow}\\}$；单位必须以 每 $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$ 的 $\\mathrm{K}$ 报告。\n2. 按对云冰的绝对敏感度对通道进行排序，即按 $\\left|\\dfrac{\\partial T_b}{\\partial q_{\\mathrm{ice}}}\\right|$ 的降序对通道排序，并使用从0开始的索引报告通道索引，对应关系为 $[23.8\\,\\mathrm{GHz} \\rightarrow 0,\\; 36.5\\,\\mathrm{GHz} \\rightarrow 1,\\; 89.0\\,\\mathrm{GHz} \\rightarrow 2]$。\n\n对三个通道使用以下科学上合理的系数：\n- 气体质量消光系数（每单位质量路径）：对于 $\\nu = [23.8, 36.5, 89.0]\\ \\mathrm{GHz}$，$\\kappa_g(\\nu)$ 分别为 $[0.015,\\ 0.012,\\ 0.025]\\ \\mathrm{m}^2\\,\\mathrm{kg}^{-1}$。\n- 水凝物质量消光系数：\n  - 云冰：$\\alpha_{\\mathrm{ice}}(\\nu) = [0.020,\\ 0.050,\\ 0.250]\\ \\mathrm{m}^2\\,\\mathrm{kg}^{-1}$。\n  - 云液：$\\alpha_{\\mathrm{liq}}(\\nu) = [0.150,\\ 0.200,\\ 0.300]\\ \\mathrm{m}^2\\,\\mathrm{kg}^{-1}$。\n  - 雨：$\\alpha_{\\mathrm{rain}}(\\nu) = [0.600,\\ 0.800,\\ 1.100]\\ \\mathrm{m}^2\\,\\mathrm{kg}^{-1}$。\n  - 雪：$\\alpha_{\\mathrm{snow}}(\\nu) = [0.300,\\ 0.400,\\ 0.800]\\ \\mathrm{m}^2\\,\\mathrm{kg}^{-1}$。\n\n测试套件：实现以下四个测试用例。角度必须解释为度，温度为开尔文，$M$ 的单位为 $\\mathrm{kg}\\,\\mathrm{m}^{-2}$，混合比的单位为 $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$。\n- 案例1（正常路径，斜视，中等云量）：$T_s = 290$, $T_\\ell = 260$, $\\varepsilon = 0.95$, $\\theta = 53$, $M = 2.0$, $q_{\\mathrm{ice}} = 5\\times 10^{-4}$, $q_{\\mathrm{liq}} = 1\\times 10^{-3}$, $q_{\\mathrm{rain}} = 1\\times 10^{-4}$, $q_{\\mathrm{snow}} = 2\\times 10^{-4}$。\n- 案例2（边界，晴空水凝物，天底）：$T_s = 288$, $T_\\ell = 270$, $\\varepsilon = 0.90$, $\\theta = 0$, $M = 2.0$, $q_{\\mathrm{ice}} = 0$, $q_{\\mathrm{liq}} = 0$, $q_{\\mathrm{rain}} = 0$, $q_{\\mathrm{snow}} = 0$。\n- 案例3（边缘，掠射路径，低发射率，冷云）：$T_s = 300$, $T_\\ell = 240$, $\\varepsilon = 0.60$, $\\theta = 60$, $M = 5.0$, $q_{\\mathrm{ice}} = 1\\times 10^{-3}$, $q_{\\mathrm{liq}} = 5\\times 10^{-4}$, $q_{\\mathrm{rain}} = 2\\times 10^{-4}$, $q_{\\mathrm{snow}} = 1\\times 10^{-3}$。\n- 案例4（边缘，较厚板层，较强气体消光）：$T_s = 285$, $T_\\ell = 255$, $\\varepsilon = 0.97$, $\\theta = 45$, $M = 8.0$, $q_{\\mathrm{ice}} = 8\\times 10^{-4}$, $q_{\\mathrm{liq}} = 2\\times 10^{-3}$, $q_{\\mathrm{rain}} = 5\\times 10^{-4}$, $q_{\\mathrm{snow}} = 3\\times 10^{-4}$。\n\n最终输出格式：您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果。此外部列表的每个元素对应一个测试用例，并且其本身是一个包含两个元素的列表：第一个元素是一个 $3 \\times 4$ 的浮点数嵌套列表，给出每个通道的雅可比矩阵 $\\left[\\dfrac{\\partial T_b}{\\partial q_{\\mathrm{ice}}}, \\dfrac{\\partial T_b}{\\partial q_{\\mathrm{liq}}}, \\dfrac{\\partial T_b}{\\partial q_{\\mathrm{rain}}}, \\dfrac{\\partial T_b}{\\partial q_{\\mathrm{snow}}}\\right]$；第二个元素是按对云冰的绝对敏感度排序的通道索引列表。具体而言，输出必须具有以下形式\n$\\left[ \\left[ J^{(1)}, R^{(1)} \\right], \\left[ J^{(2)}, R^{(2)} \\right], \\left[ J^{(3)}, R^{(3)} \\right], \\left[ J^{(4)}, R^{(4)} \\right] \\right]$,\n其中 $J^{(k)}$ 是案例 $k$ 的 $3 \\times 4$ 雅可比矩阵列表，而 $R^{(k)}$ 是案例 $k$ 的排序列表。打印的行不得包含任何多余的空格。",
            "solution": "### 1. 正向模型推导\n\n问题指定了一个一维平面平行大气，模型为一个单一的均质平板层。我们从局部热力学平衡（LTE）下非散射介质中的辐射传输 Schwarzschild 方程开始。在瑞利-金斯（Rayleigh-Jeans）极限下，辐射率与亮温成线性关系，该方程可写为：\n$$\n\\frac{d T_b}{d \\tau'} = T(s) - T_b\n$$\n其中 $T_b$ 是辐射的亮温，$T(s)$ 是路径上位置 $s$ 处介质的局部热力学温度，$d \\tau'$ 是沿路径的光学厚度微分。问题要求的是上行辐射的解。我们将沿视线（LOS）穿过平板层的总光学厚度定义为 $\\tau_{\\mathrm{opt}}$。将 Schwarzschild 方程从地表（出射亮温为 $T_b^{\\mathrm{surf}}$）积分到大气层顶（TOA，我们想要求解 $T_b$ 的地方），得到形式解：\n$$\nT_b(\\text{TOA}) = T_b^{\\mathrm{surf}} e^{-\\tau_{\\mathrm{opt}}} + \\int_{0}^{\\tau_{\\mathrm{opt}}} T(s(\\tau')) e^{-\\tau'} d\\tau'\n$$\n问题指出该平板层是均质的，具有恒定的层温度 $T_\\ell$。因此，$T(s(\\tau')) = T_\\ell$ 是一个常数。现在可以求解该积分：\n$$\n\\int_{0}^{\\tau_{\\mathrm{opt}}} T_\\ell e^{-\\tau'} d\\tau' = T_\\ell \\left[ -e^{-\\tau'} \\right]_{0}^{\\tau_{\\mathrm{opt}}} = T_\\ell \\left( -e^{-\\tau_{\\mathrm{opt}}} - (-e^{-0}) \\right) = T_\\ell(1 - e^{-\\tau_{\\mathrm{opt}}})\n$$\n地表亮温由 $T_b^{\\mathrm{surf}} = \\varepsilon T_s$ 给出，其中 $\\varepsilon$ 是地表发射率，$T_s$ 是地表热力学温度。将这些结果代入形式解，得到 TOA 亮温的正向模型，我们将其简记为 $T_b$：\n$$\nT_b(\\nu) = (\\varepsilon T_s) e^{-\\tau_{\\mathrm{opt}}(\\nu)} + T_\\ell(1 - e^{-\\tau_{\\mathrm{opt}}(\\nu)})\n$$\n为了计算方便，可以重新排列为：\n$$\nT_b(\\nu) = T_\\ell + (\\varepsilon T_s - T_\\ell) e^{-\\tau_{\\mathrm{opt}}(\\nu)}\n$$\n\n### 2. 光学厚度与消光\n\n沿视线的总光学厚度 $\\tau_{\\mathrm{opt}}(\\nu)$ 由以下公式给出：\n$$\n\\tau_{\\mathrm{opt}}(\\nu) = \\frac{M}{\\mu} K(\\nu)\n$$\n其中 $M$ 是平板层的柱质量路径，$\\mu = \\cos(\\theta \\times \\pi / 180)$ 是观测天顶角 $\\theta$ 的路径因子，$K(\\nu)$ 是单位质量路径的总质量消光系数。$K(\\nu)$ 是气体和水凝物贡献的总和：\n$$\nK(\\nu) = \\kappa_g(\\nu) + \\sum_{i} \\alpha_i(\\nu) q_i\n$$\n求和遍历四种水凝物：云冰（$i=\\mathrm{ice}$）、云液（$i=\\mathrm{liq}$）、雨（$i=\\mathrm{rain}$）和雪（$i=\\mathrm{snow}$）。这里，$\\kappa_g(\\nu)$ 是气体质量消光系数，$\\alpha_i(\\nu)$ 是种类 $i$ 的质量消光系数，$q_i$ 是种类 $i$ 的混合比。\n\n### 3. 雅可比矩阵推导\n\n主要任务是计算雅可比矩阵，即 TOA 亮温对每种水凝物混合比的偏导数 $\\dfrac{\\partial T_b}{\\partial q_i}$。我们使用链式法则：\n$$\n\\frac{\\partial T_b}{\\partial q_i} = \\frac{\\partial T_b}{\\partial \\tau_{\\mathrm{opt}}} \\frac{\\partial \\tau_{\\mathrm{opt}}}{\\partial q_i}\n$$\n首先，我们计算 $T_b$ 相对于 $\\tau_{\\mathrm{opt}}$ 的导数：\n$$\n\\frac{\\partial T_b}{\\partial \\tau_{\\mathrm{opt}}} = \\frac{\\partial}{\\partial \\tau_{\\mathrm{opt}}} \\left[ T_\\ell + (\\varepsilon T_s - T_\\ell) e^{-\\tau_{\\mathrm{opt}}} \\right] = (\\varepsilon T_s - T_\\ell) (-e^{-\\tau_{\\mathrm{opt}}}) = (T_\\ell - \\varepsilon T_s) e^{-\\tau_{\\mathrm{opt}}}\n$$\n接下来，我们计算 $\\tau_{\\mathrm{opt}}$ 相对于特定混合比 $q_i$ 的导数：\n$$\n\\frac{\\partial \\tau_{\\mathrm{opt}}}{\\partial q_i} = \\frac{\\partial}{\\partial q_i} \\left[ \\frac{M}{\\mu} \\left( \\kappa_g(\\nu) + \\sum_{j} \\alpha_j(\\nu) q_j \\right) \\right]\n$$\n由于混合比 $q_j$ 是自变量，因此仅当 $j=i$ 时导数非零：\n$$\n\\frac{\\partial \\tau_{\\mathrm{opt}}}{\\partial q_i} = \\frac{M}{\\mu} \\alpha_i(\\nu)\n$$\n将这两部分结合起来，得到雅可比矩阵的最终表达式：\n$$\n\\frac{\\partial T_b(\\nu)}{\\partial q_i} = (T_\\ell - \\varepsilon T_s) e^{-\\tau_{\\mathrm{opt}}(\\nu)} \\frac{M}{\\mu} \\alpha_i(\\nu)\n$$\n该表达式表明，亮温对水凝物量变化的敏感度取决于大气层温度 $T_\\ell$ 与地表亮温 $\\varepsilon T_s$ 之间的对比度、总大气不透明度（通过 $e^{-\\tau_{\\mathrm{opt}}}$ 项）、路径中的质量量（$M/\\mu$）以及该水凝物种类的特定消光特性（$\\alpha_i(\\nu)$）。\n\n### 4. 算法步骤\n\n对于每个测试用例和三个频率通道中的每一个，执行以下步骤：\n1.  计算路径因子 $\\mu = \\cos(\\theta \\times \\pi / 180)$。\n2.  使用给定的气体和水凝物系数以及混合比，计算每个通道的总质量消光系数 $K(\\nu)$。\n3.  计算每个通道的视线光学厚度 $\\tau_{\\mathrm{opt}}(\\nu) = (M/\\mu) K(\\nu)$。\n4.  使用推导出的雅可比公式计算 $3 \\times 4$ 的敏感度矩阵 $\\dfrac{\\partial T_b(\\nu)}{\\partial q_i}$，其中行对应三个通道（索引为 $0, 1, 2$），列对应四种水凝物（$q_{\\mathrm{ice}}, q_{\\mathrm{liq}}, q_{\\mathrm{rain}}, q_{\\mathrm{snow}}$）。\n5.  提取与云冰对应的雅可比矩阵列 $\\left|\\dfrac{\\partial T_b(\\nu)}{\\partial q_{\\mathrm{ice}}}\\right|$，适用于所有三个通道。\n6.  根据这些冰敏感度值的大小，按降序对通道索引（$0, 1, 2$）进行排序，以获得通道排名。\n7.  每个测试用例的结果，包括雅可比矩阵和排序后的通道索引，被收集并格式化为指定的字符串输出。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes channel-wise Jacobians of TOA brightness temperature with respect\n    to hydrometeor mixing ratios and ranks channels by sensitivity to cloud ice.\n    \"\"\"\n\n    # --- Define Constants ---\n    # Frequencies: [23.8, 36.5, 89.0] GHz\n    # Channel indices: 0, 1, 2\n\n    # Gas mass-extinction coefficients (m^2/kg)\n    K_G = np.array([0.015, 0.012, 0.025])\n\n    # Hydrometeor mass-extinction coefficients (m^2/kg)\n    # Rows: ice, liq, rain, snow\n    # Columns: 23.8 GHz, 36.5 GHz, 89.0 GHz\n    A_HYDROMETEORS = np.array([\n        [0.020, 0.050, 0.250],  # cloud ice\n        [0.150, 0.200, 0.300],  # cloud liquid\n        [0.600, 0.800, 1.100],  # rain\n        [0.300, 0.400, 0.800]   # snow\n    ])\n\n    # --- Test Cases ---\n    # (T_s, T_l, epsilon, theta_deg, M, q_ice, q_liq, q_rain, q_snow)\n    test_cases = [\n        (290.0, 260.0, 0.95, 53.0, 2.0, 5e-4, 1e-3, 1e-4, 2e-4),\n        (288.0, 270.0, 0.90, 0.0, 2.0, 0.0, 0.0, 0.0, 0.0),\n        (300.0, 240.0, 0.60, 60.0, 5.0, 1e-3, 5e-4, 2e-4, 1e-3),\n        (285.0, 255.0, 0.97, 45.0, 8.0, 8e-4, 2e-3, 5e-4, 3e-4),\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        T_s, T_l, epsilon, theta_deg, M, q_ice, q_liq, q_rain, q_snow = case\n        \n        q = np.array([q_ice, q_liq, q_rain, q_snow])\n\n        # --- Calculations ---\n        # 1. Path factor mu = cos(theta)\n        mu = np.cos(theta_deg * np.pi / 180.0) if theta_deg != 90.0 else 1e-9 # handle theta=90 case\n\n        # 2. Total mass-extinction coefficient K(nu) for each channel\n        # K = k_g + sum(alpha_i * q_i)\n        hydrometeor_extinction = np.sum(A_HYDROMETEORS * q[:, np.newaxis], axis=0)\n        K = K_G + hydrometeor_extinction\n\n        # 3. Optical depth tau_opt(nu) for each channel\n        tau_opt = (M / mu) * K\n\n        # 4. Calculate Jacobians: d(Tb)/d(qi) = (T_l - eps*T_s) * exp(-tau_opt) * (M/mu) * alpha_i\n        \n        # This is the common part of the Jacobian for all hydrometeor species, per channel\n        # The result is a 3-element array.\n        common_factor_per_channel = (T_l - epsilon * T_s) * np.exp(-tau_opt) * (M / mu)\n        \n        # Calculate the full Jacobian matrix.\n        # This broadcasts the (3,) common_factor array across the columns of the (4, 3) A_HYDROMETEORS array.\n        # The result is a (4, 3) matrix: rows are species, columns are channels.\n        jacobian_matrix = A_HYDROMETEORS * common_factor_per_channel\n\n        # The required output format is 3x4 (channels x species).\n        jacobian_output = jacobian_matrix.T.tolist()\n\n        # 5. Rank channels by absolute sensitivity to cloud ice\n        # Jacobians for ice are in the first row of the (4, 3) jacobian_matrix\n        ice_sensitivities = np.abs(jacobian_matrix[0, :])\n        \n        # argsort sorts in ascending order. We sort the negative to get descending order.\n        ranked_channel_indices = np.argsort(-ice_sensitivities).tolist()\n\n        all_results.append([jacobian_output, ranked_channel_indices])\n\n    # Final print statement in the exact required format.\n    # str() creates the nested list representation, and .replace(' ', '') removes all spaces.\n    print(str(all_results).replace(' ', ''))\n\nsolve()\n```"
        },
        {
            "introduction": "变分资料同化的最终目标是找到与观测最匹配的大气状态。这一目标通过最小化一个代价函数来实现，而这个过程需要计算代价函数相对于数百万个模式变量的梯度。本练习介绍强大的伴随方法，它是现代数值天气预报中高效计算梯度的基石 ()。通过实现一个简化的伴随模型，你将了解如何有效地确定积雪廓线的变化对代价函数的影响，这是整个同化过程的核心环节。",
            "id": "4011494",
            "problem": "在数值天气预报（NWP）的全天候辐射率同化设置中，给定一个针对单个微波通道、包含 $N$ 层的一维平面平行大气柱。观测算子通过一个简化的、离散的辐射传输模型，将大气状态映射为大气层顶的上行亮温。从单个通道的变分资料同化（VDA）代价函数的标量观测部分出发，\n$$\nJ_{\\text{obs}} = \\tfrac{1}{2}\\left(\\frac{I_\\nu(\\mathbf{x}) - y_\\nu}{\\sigma_\\nu}\\right)^2,\n$$\n其中 $I_\\nu(\\mathbf{x})$ 是频率为 $\\nu$ 的大气层顶亮温，$y_\\nu$ 是观测亮温，$\\sigma_\\nu$ 是观测标准差。请推导并实现给定的雪混合比增量对 $J_{\\text{obs}}$ 梯度的伴随贡献。\n\n假设采用平面平行、离散分层公式，并使用以下经过充分检验的正向辐射传输表达式来表示大气层顶的上行亮温：\n$$\nI_\\nu = \\sum_{i=1}^{N} S_i \\left(1 - e^{-\\Delta \\tau_i}\\right) \\exp\\!\\Big(-\\sum_{k=i+1}^{N} \\Delta \\tau_k\\Big),\n$$\n其中 $S_i$ 是第 $i$ 层的源函数，此处取为瑞利-金斯亮温 $S_i = T_i$，其中 $T_i$ 是以开尔文为单位的物理温度，而 $\\Delta \\tau_i$ 是有效层光学厚度：\n$$\n\\Delta \\tau_i = \\left(k_{g,i} + (1 - \\omega_\\nu)\\,\\beta_\\nu\\,\\rho_i\\,q_{s,i}\\right)\\,\\Delta z_i.\n$$\n在此模型中，$k_{g,i}$ 是气体吸收系数，单位为 $\\mathrm{m}^{-1}$；$\\omega_\\nu$ 是通道的单次散射反照率（无量纲）；$\\beta_\\nu$ 是质量比消光截面，单位为 $\\mathrm{m}^2\\,\\mathrm{kg}^{-1}$；$\\rho_i$ 是空气密度，单位为 $\\mathrm{kg}\\,\\mathrm{m}^{-3}$；$q_{s,i}$ 是雪混合比，单位为 $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$；$\\Delta z_i$ 是层的几何厚度，单位为 $\\mathrm{m}$。从第 $i$ 层顶部到空间的透射率为 $T_{i+1} = \\exp\\!\\left(-\\sum_{k=i+1}^{N} \\Delta \\tau_k\\right)$，其中 $T_{N+1} = 1$。\n\n从辐射传输方程 $dI/d\\tau = I - S$ 和应用于 $J_{\\text{obs}}$ 的链式法则出发，推导计算雪混合比增量 $\\delta \\mathbf{q}_s$ 的基于伴随的梯度贡献所需的表达式。您的程序必须为下方的每个测试用例计算由指定增量引起的 $J_{\\text{obs}}$ 的一阶变化，\n$$\n\\delta J_{\\text{obs}} \\approx \\sum_{j=1}^{N} \\left(\\frac{\\partial J_{\\text{obs}}}{\\partial q_{s,j}}\\right) \\delta q_{s,j},\n$$\n结果表示为一个无单位的浮点数（因为 $q_{s,j}$ 的单位是 $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$，是无量纲的）。\n\n按如下方式实现计算：\n- 使用以开尔文为单位的 $S_i = T_i$。\n- 使用上述离散层公式计算 $I_\\nu$。\n- 计算标量伴随因子 $\\lambda = (I_\\nu - y_\\nu)/\\sigma_\\nu^2$。\n- 通过 $I_\\nu$ 对 $\\Delta \\tau_j$ 的敏感度以及 $\\Delta \\tau_j$ 对 $q_{s,j}$ 的敏感度来计算 $\\partial I_\\nu / \\partial q_{s,j}$。\n- 将梯度与增量向量 $\\delta \\mathbf{q}_s$ 的内积聚合为 $\\delta J_{\\text{obs}}$。\n\n程序中使用的物理单位如下：\n- $T_i$ 单位为开尔文，\n- $\\rho_i$ 单位为 $\\mathrm{kg}\\,\\mathrm{m}^{-3}$，\n- $\\Delta z_i$ 单位为 $\\mathrm{m}$，\n- $k_{g,i}$ 单位为 $\\mathrm{m}^{-1}$，\n- $\\beta_\\nu$ 单位为 $\\mathrm{m}^2\\,\\mathrm{kg}^{-1}$，\n- $q_{s,i}$ 单位为 $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$，\n- $y_\\nu$ 和 $I_\\nu$ 单位为开尔文，\n- $\\sigma_\\nu$ 单位为开尔文。\n\n角度单位不适用。百分比不适用。\n\n测试套件：\n对于每个测试用例，计算并返回如上定义的 $\\delta J_{\\text{obs}}$。\n\n案例1（理想情况，中等雪量和气体）：\n- $N = 4$,\n- $T = [273, 268, 260, 250]$,\n- $\\rho = [1.2, 1.0, 0.9, 0.8]$,\n- $\\Delta z = [500, 500, 500, 500]$,\n- $k_g = [10^{-4}, 8\\times 10^{-5}, 6\\times 10^{-5}, 5\\times 10^{-5}]$,\n- $q_s = [10^{-4}, 2\\times 10^{-4}, 3\\times 10^{-4}, 10^{-4}]$,\n- $y_\\nu = 255$,\n- $\\sigma_\\nu = 2$,\n- $\\delta q_s = [10^{-5}, -5\\times 10^{-6}, 2\\times 10^{-5}, 0]$,\n- 通道： $\\omega_\\nu = 0.95$, $\\beta_\\nu = 0.12$。\n\n案例2（晴空基线，非零增量）：\n- $N = 3$,\n- $T = [290, 280, 270]$,\n- $\\rho = [1.1, 0.95, 0.8]$,\n- $\\Delta z = [1000, 1000, 1000]$,\n- $k_g = [2\\times 10^{-4}, 1.5\\times 10^{-4}, 10^{-4}]$,\n- $q_s = [0, 0, 0]$,\n- $y_\\nu = 275$,\n- $\\sigma_\\nu = 1.5$,\n- $\\delta q_s = [2\\times 10^{-5}, 2\\times 10^{-5}, 2\\times 10^{-5}]$,\n- 通道： $\\omega_\\nu = 0.93$, $\\beta_\\nu = 0.10$。\n\n案例3（光学厚雪，强散射）：\n- $N = 5$,\n- $T = [273, 270, 265, 260, 255]$,\n- $\\rho = [1.2, 1.1, 1.0, 0.9, 0.8]$,\n- $\\Delta z = [400, 400, 400, 400, 400]$,\n- $k_g = [1.5\\times 10^{-4}, 1.2\\times 10^{-4}, 10^{-4}, 8\\times 10^{-5}, 6\\times 10^{-5}]$,\n- $q_s = [5\\times 10^{-4}, 7\\times 10^{-4}, 10^{-3}, 8\\times 10^{-4}, 6\\times 10^{-4}]$,\n- $y_\\nu = 235$,\n- $\\sigma_\\nu = 3.0$,\n- $\\delta q_s = [-10^{-5}, -1.5\\times 10^{-5}, -2\\times 10^{-5}, -10^{-5}, -5\\times 10^{-6}]$,\n- 通道： $\\omega_\\nu = 0.96$, $\\beta_\\nu = 0.15$。\n\n案例4（单层边界情况）：\n- $N = 1$,\n- $T = [260]$,\n- $\\rho = [0.9]$,\n- $\\Delta z = [2000]$,\n- $k_g = [10^{-4}]$,\n- $q_s = [2\\times 10^{-4}]$,\n- $y_\\nu = 255$,\n- $\\sigma_\\nu = 1.0$,\n- $\\delta q_s = [10^{-5}]$,\n- 通道： $\\omega_\\nu = 0.95$, $\\beta_\\nu = 0.12$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含以上四个案例的结果，结果为逗号分隔的列表，用方括号括起来，顺序为 $[\\delta J_{\\text{obs}}^{(1)}, \\delta J_{\\text{obs}}^{(2)}, \\delta J_{\\text{obs}}^{(3)}, \\delta J_{\\text{obs}}^{(4)}]$。每个条目都必须是一个浮点数。",
            "solution": "目标是计算由雪混合比廓线 $\\delta \\mathbf{q}_s = \\{\\delta q_{s,j}\\}_{j=1}^N$ 的一个小扰动引起的观测代价函数的一阶变化 $\\delta J_{\\text{obs}}$。这由以下线性近似给出：\n$$\n\\delta J_{\\text{obs}} \\approx \\sum_{j=1}^{N} \\left(\\frac{\\partial J_{\\text{obs}}}{\\partial q_{s,j}}\\right) \\delta q_{s,j} = (\\nabla_{\\mathbf{q}_s} J_{\\text{obs}}) \\cdot \\delta \\mathbf{q}_s\n$$\n问题的核心是推导代价函数关于雪混合比的梯度 $\\nabla_{\\mathbf{q}_s} J_{\\text{obs}}$。该梯度的第 $j$ 个分量是 $\\frac{\\partial J_{\\text{obs}}}{\\partial q_{s,j}}$。\n\n代价函数由下式给出：\n$$\nJ_{\\text{obs}} = \\tfrac{1}{2}\\left(\\frac{I_\\nu(\\mathbf{x}) - y_\\nu}{\\sigma_\\nu}\\right)^2\n$$\n其中 $I_\\nu$ 是模拟的大气层顶亮温，它依赖于大气状态向量 $\\mathbf{x}$，而该向量包含雪混合比廓线 $\\mathbf{q}_s$。\n\n**步骤1：应用链式法则**\n\n我们应用链式法则来求 $J_{\\text{obs}}$ 对第 $j$ 层雪混合比 $q_{s,j}$ 的导数：\n$$\n\\frac{\\partial J_{\\text{obs}}}{\\partial q_{s,j}} = \\frac{\\partial J_{\\text{obs}}}{\\partial I_\\nu} \\frac{\\partial I_\\nu}{\\partial q_{s,j}}\n$$\n第一项 $\\frac{\\partial J_{\\text{obs}}}{\\partial I_\\nu}$ 是伴随变量或强迫项。其推导过程很简单：\n$$\n\\frac{\\partial J_{\\text{obs}}}{\\partial I_\\nu} = \\frac{1}{2} \\cdot 2 \\cdot \\left(\\frac{I_\\nu - y_\\nu}{\\sigma_\\nu}\\right) \\cdot \\frac{1}{\\sigma_\\nu} = \\frac{I_\\nu - y_\\nu}{\\sigma_\\nu^2}\n$$\n让我们将这个标量因子表示为 $\\lambda = \\frac{I_\\nu - y_\\nu}{\\sigma_\\nu^2}$。\n\n第二项 $\\frac{\\partial I_\\nu}{\\partial q_{s,j}}$ 代表模拟亮温对第 $j$ 层雪混合比变化的敏感度。为了计算它，我们再次应用链式法则，并认识到 $q_{s,j}$ 是通过影响层光学厚度 $\\Delta \\tau_j$ 来影响 $I_\\nu$ 的。$I_\\nu$ 的模型依赖于所有层的光学厚度 $\\{\\Delta \\tau_i\\}_{i=1}^N$。\n$$\n\\frac{\\partial I_\\nu}{\\partial q_{s,j}} = \\sum_{l=1}^{N} \\frac{\\partial I_\\nu}{\\partial (\\Delta \\tau_l)} \\frac{\\partial (\\Delta \\tau_l)}{\\partial q_{s,j}}\n$$\n\n**步骤2：光学厚度对雪混合比的雅可比**\n\n首先，我们计算 $\\frac{\\partial (\\Delta \\tau_l)}{\\partial q_{s,j}}$。层的光学厚度为：\n$$\n\\Delta \\tau_l = \\left(k_{g,l} + (1 - \\omega_\\nu)\\,\\beta_\\nu\\,\\rho_l\\,q_{s,l}\\right)\\,\\Delta z_l\n$$\n对 $q_{s,j}$ 的导数仅在 $l=j$ 时非零，因为一层光学厚度 $\\Delta \\tau_l$ 仅依赖于该层自身的混合比 $q_{s,l}$。使用克罗内克δ函数 $\\delta_{lj}$：\n$$\n\\frac{\\partial (\\Delta \\tau_l)}{\\partial q_{s,j}} = \\frac{\\partial}{\\partial q_{s,j}} \\left[ \\left(k_{g,l} + (1 - \\omega_\\nu)\\,\\beta_\\nu\\,\\rho_l\\,q_{s,l}\\right)\\,\\Delta z_l \\right] = \\delta_{lj} \\cdot (1 - \\omega_\\nu)\\,\\beta_\\nu\\,\\rho_j\\,\\Delta z_j\n$$\n将此代入 $\\frac{\\partial I_\\nu}{\\partial q_{s,j}}$ 的求和式中，会使求和式坍缩为 $l=j$ 的单项：\n$$\n\\frac{\\partial I_\\nu}{\\partial q_{s,j}} = \\frac{\\partial I_\\nu}{\\partial (\\Delta \\tau_j)} \\cdot (1 - \\omega_\\nu)\\,\\beta_\\nu\\,\\rho_j\\,\\Delta z_j\n$$\n\n**步骤3：辐射率对层光学厚度的雅可比**\n\n剩下的任务是推导亮温对第 $j$ 层光学厚度 $\\Delta \\tau_j$ 的雅可比 $\\frac{\\partial I_\\nu}{\\partial (\\Delta \\tau_j)}$。正向模型为：\n$$\nI_\\nu = \\sum_{i=1}^{N} T_i \\left(1 - e^{-\\Delta \\tau_i}\\right) \\exp\\left(-\\sum_{k=i+1}^{N} \\Delta \\tau_k\\right)\n$$\n我们对该表达式关于 $\\Delta \\tau_j$ 求导。变量 $\\Delta \\tau_j$ 出现在两个地方：\n1. 在第 $j$ 层自身的发射项中（当 $i=j$ 时）：$T_j (1 - e^{-\\Delta \\tau_j})$。\n2. 在所有位于第 $j$ 层下方的层 $i$ （即 $i  j$）的透射项中：$\\exp\\left(-\\sum_{k=i+1}^{N} \\Delta \\tau_k\\right)$，其中 $\\Delta \\tau_j$ 是指数中求和的一部分。\n\n让我们将 $I_\\nu$ 的求和分为三部分并求导：\n$$\nI_\\nu = \\left( \\sum_{i=1}^{j-1} \\dots \\right) + \\left( \\text{term for } i=j \\right) + \\left( \\sum_{i=j+1}^{N} \\dots \\right)\n$$\n- 对于 $i  j$ 的项，其导数为零，因为它们不依赖于 $\\Delta \\tau_j$。\n- 对于 $i=j$ 的项的导数：\n$$\n\\frac{\\partial}{\\partial (\\Delta \\tau_j)} \\left[ T_j(1 - e^{-\\Delta \\tau_j}) \\exp\\left(-\\sum_{k=j+1}^{N} \\Delta \\tau_k\\right) \\right] = T_j e^{-\\Delta \\tau_j} \\exp\\left(-\\sum_{k=j+1}^{N} \\Delta \\tau_k\\right)\n$$\n- 对于 $i  j$ 的求和项的导数：\n$$\n\\frac{\\partial}{\\partial (\\Delta \\tau_j)} \\left[ \\sum_{i=1}^{j-1} T_i(1 - e^{-\\Delta \\tau_i}) \\exp\\left(-\\sum_{k=i+1}^{N} \\Delta \\tau_k\\right) \\right] = \\sum_{i=1}^{j-1} T_i(1 - e^{-\\Delta \\tau_i}) \\frac{\\partial}{\\partial (\\Delta \\tau_j)} \\exp\\left(-\\sum_{k=i+1}^{N} \\Delta \\tau_k\\right)\n$$\n对于任何 $i  j$，指数中的求和包含 $\\Delta \\tau_j$，所以导数为：\n$$\n\\frac{\\partial}{\\partial (\\Delta \\tau_j)} \\exp\\left(-\\sum_{k=i+1}^{N} \\Delta \\tau_k\\right) = \\exp\\left(-\\sum_{k=i+1}^{N} \\Delta \\tau_k\\right) \\cdot (-1)\n$$\n因此，该求和项的导数变为：\n$$\n- \\sum_{i=1}^{j-1} T_i(1 - e^{-\\Delta \\tau_i}) \\exp\\left(-\\sum_{k=i+1}^{N} \\Delta \\tau_k\\right)\n$$\n该项表示所有位于第 $j$ 层下方的层对大气层顶辐射率总贡献的负值。\n\n综合各部分，完整的导数为：\n$$\n\\frac{\\partial I_\\nu}{\\partial (\\Delta \\tau_j)} = T_j e^{-\\Delta \\tau_j} \\exp\\left(-\\sum_{k=j+1}^{N} \\Delta \\tau_k\\right) - \\sum_{i=1}^{j-1} T_i(1 - e^{-\\Delta \\tau_i}) \\exp\\left(-\\sum_{k=i+1}^{N} \\Delta \\tau_k\\right)\n$$\n\n**步骤4：组装梯度和最终结果**\n\n我们现在组装梯度分量的完整表达式：\n$$\n\\frac{\\partial J_{\\text{obs}}}{\\partial q_{s,j}} = \\lambda \\cdot \\frac{\\partial I_\\nu}{\\partial (\\Delta \\tau_j)} \\cdot (1 - \\omega_\\nu)\\,\\beta_\\nu\\,\\rho_j\\,\\Delta z_j\n$$\n其中 $\\lambda$ 和 $\\frac{\\partial I_\\nu}{\\partial (\\Delta \\tau_j)}$ 如上所述推导。\n\n总的一阶变化 $\\delta J_{\\text{obs}}$ 是通过计算梯度向量 $\\nabla_{\\mathbf{q}_s} J_{\\text{obs}} = \\left[ \\frac{\\partial J_{\\text{obs}}}{\\partial q_{s,1}}, \\dots, \\frac{\\partial J_{\\text{obs}}}{\\partial q_{s,N}} \\right]^T$ 与扰动向量 $\\delta \\mathbf{q}_s$ 的点积得到的：\n$$\n\\delta J_{\\text{obs}} = \\sum_{j=1}^{N} \\left[ \\lambda \\cdot \\frac{\\partial I_\\nu}{\\partial (\\Delta \\tau_j)} \\cdot (1 - \\omega_\\nu)\\,\\beta_\\nu\\,\\rho_j\\,\\Delta z_j \\right] \\delta q_{s,j}\n$$\n这为所需的计算提供了一个完整的算法。实现将首先计算正向模型量（$I_\\nu$ 和中间透射率），然后是伴随强迫项 $\\lambda$，接着是雅可比矩阵，最后是结果 $\\delta J_{\\text{obs}}$。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function that processes all test cases.\n    \"\"\"\n    test_cases = [\n        # Case 1 (happy path, moderate snow and gas)\n        {\n            \"N\": 4, \"T\": [273, 268, 260, 250], \"rho\": [1.2, 1.0, 0.9, 0.8],\n            \"delta_z\": [500, 500, 500, 500], \"k_g\": [1e-4, 8e-5, 6e-5, 5e-5],\n            \"q_s\": [1e-4, 2e-4, 3e-4, 1e-4], \"y_nu\": 255.0, \"sigma_nu\": 2.0,\n            \"delta_qs\": [1e-5, -5e-6, 2e-5, 0.0], \"omega_nu\": 0.95, \"beta_nu\": 0.12\n        },\n        # Case 2 (clear-sky baseline with nonzero increment)\n        {\n            \"N\": 3, \"T\": [290, 280, 270], \"rho\": [1.1, 0.95, 0.8],\n            \"delta_z\": [1000, 1000, 1000], \"k_g\": [2e-4, 1.5e-4, 1e-4],\n            \"q_s\": [0.0, 0.0, 0.0], \"y_nu\": 275.0, \"sigma_nu\": 1.5,\n            \"delta_qs\": [2e-5, 2e-5, 2e-5], \"omega_nu\": 0.93, \"beta_nu\": 0.10\n        },\n        # Case 3 (optically thick snow, strong scattering)\n        {\n            \"N\": 5, \"T\": [273, 270, 265, 260, 255], \"rho\": [1.2, 1.1, 1.0, 0.9, 0.8],\n            \"delta_z\": [400, 400, 400, 400, 400], \"k_g\": [1.5e-4, 1.2e-4, 1e-4, 8e-5, 6e-5],\n            \"q_s\": [5e-4, 7e-4, 1e-3, 8e-4, 6e-4], \"y_nu\": 235.0, \"sigma_nu\": 3.0,\n            \"delta_qs\": [-1e-5, -1.5e-5, -2e-5, -1e-5, -5e-6], \"omega_nu\": 0.96, \"beta_nu\": 0.15\n        },\n        # Case 4 (single-layer edge case)\n        {\n            \"N\": 1, \"T\": [260], \"rho\": [0.9], \"delta_z\": [2000],\n            \"k_g\": [1e-4], \"q_s\": [2e-4], \"y_nu\": 255.0, \"sigma_nu\": 1.0,\n            \"delta_qs\": [1e-5], \"omega_nu\": 0.95, \"beta_nu\": 0.12\n        }\n    ]\n\n    results = [compute_delta_J_obs(case) for case in test_cases]\n    print(f\"[{','.join(f'{r:.8f}' for r in results)}]\")\n\ndef compute_delta_J_obs(case):\n    \"\"\"\n    Computes delta_J_obs for a single test case.\n    The implementation uses 0-based indexing for arrays.\n    Problem statement uses 1-based indexing for math.\n    Here, N is number of layers, so indices go from 0 to N-1.\n    \"\"\"\n    # Unpack parameters and convert to numpy arrays\n    N = case[\"N\"]\n    T = np.array(case[\"T\"])\n    rho = np.array(case[\"rho\"])\n    delta_z = np.array(case[\"delta_z\"])\n    k_g = np.array(case[\"k_g\"])\n    q_s = np.array(case[\"q_s\"])\n    y_nu = case[\"y_nu\"]\n    sigma_nu = case[\"sigma_nu\"]\n    delta_qs = np.array(case[\"delta_qs\"])\n    omega_nu = case[\"omega_nu\"]\n    beta_nu = case[\"beta_nu\"]\n\n    # --- Step A: Forward Model Calculation ---\n\n    # A1. Compute layer optical depths\n    delta_tau = (k_g + (1 - omega_nu) * beta_nu * rho * q_s) * delta_z\n    \n    # A2. Compute layer-to-space transmittances\n    # trans_to_toa[i] = exp(-sum_{k=i+1}^{N-1} delta_tau_k)\n    tau_above = np.zeros(N)\n    for i in range(N - 2, -1, -1):\n        tau_above[i] = tau_above[i+1] + delta_tau[i+1]\n    trans_to_toa = np.exp(-tau_above)\n\n    # A3. Compute top-of-atmosphere brightness temperature I_nu\n    # The contribution of each layer i to the TOA radiance\n    layer_contrib = T * (1 - np.exp(-delta_tau)) * trans_to_toa\n    I_nu = np.sum(layer_contrib)\n    \n    # --- Step B: Adjoint and Gradient Calculation ---\n\n    # B1. Compute the scalar adjoint factor lambda\n    lambda_val = (I_nu - y_nu) / (sigma_nu**2)\n    \n    # B2. Compute Jacobian of radiance wrt optical depth (dI/d(tau))\n    # dI/d(tau_j) = T_j * exp(-tau_j) * trans_j_toa - sum_{i=0}^{j-1} layer_contrib_i\n    \n    # Contribution to TOA radiance from all layers below layer j\n    # upwelling_at_toa_from_below[j] = sum_{i=0}^{j-1} layer_contrib[i]\n    if N > 0:\n        upwelling_at_toa_from_below = np.concatenate(([0], np.cumsum(layer_contrib)[:-1]))\n    else:\n        upwelling_at_toa_from_below = np.array([])\n        \n    dI_dtau = T * np.exp(-delta_tau) * trans_to_toa - upwelling_at_toa_from_below\n\n    # B3. Compute Jacobian of optical depth wrt snow mixing ratio (d(tau)/d(q_s))\n    dtau_dqs = (1 - omega_nu) * beta_nu * rho * delta_z\n    \n    # B4. Compute Jacobian of radiance wrt snow mixing ratio (dI/d(q_s))\n    dI_dqs = dI_dtau * dtau_dqs\n    \n    # B5. Compute full gradient of the cost function wrt snow mixing ratio\n    grad_J_qs = lambda_val * dI_dqs\n    \n    # --- Step C: Final Calculation ---\n\n    # C1. Compute delta_J_obs as the dot product of the gradient and the perturbation\n    delta_J_obs = np.dot(grad_J_qs, delta_qs)\n    \n    return delta_J_obs\n\nsolve()\n```"
        }
    ]
}