{
    "hands_on_practices": [
        {
            "introduction": "伴随模型是一个强大的工具，但其推导和实现过程极易出错。“点积测试”是验证切线性模型与其对应的伴随模型是否相互一致的黄金标准。本练习 () 将提供一个简化但现实的物理模型——辐射传输模型，让您亲手实践这一至关重要的验证步骤，从而建立对资料同化核心工具的信心。",
            "id": "4103767",
            "problem": "构建一个独立程序，为基于比尔-朗伯定律的简化$2$层、平面平行、非散射、上行辐射传输算子派生出的离散切线性（TL）和伴随（ADJ）对执行点积测试。在欧几里得内积下进行运算，并验证离散伴随一致性。该程序必须从第一性原理出发实现以下内容。\n\n基本基态和正向算子：使用比尔-朗伯定律计算透射率，并对层辐射进行线性叠加。考虑堆叠在一个辐射表面之上的$2$个均匀层。设状态向量为 $x = [\\tau_1,\\tau_2,S_1,S_2]^\\top$，其中 $\\tau_1$ 和 $\\tau_2$ 分别是下层和上层的非负光学深度，$S_1$ 和 $S_2$ 是它们对应的层源项（辐射亮度）。设 $E$ 表示表面辐射（辐射亮度）。对于一组由 $k$ 索引的视角方向余弦 $\\mu_k \\in (0,1]$，定义透射率 $T_{1,k} = \\exp(-\\tau_1/\\mu_k)$ 和 $T_{2,k} = \\exp(-\\tau_2/\\mu_k)$。正向算子 $F: \\mathbb{R}^4 \\to \\mathbb{R}^K$ 将状态映射到大气层顶上行辐射亮度向量 $L \\in \\mathbb{R}^K$，其分量为\n$$\nL_k(x) = T_{1,k} T_{2,k} E + T_{1,k} \\left(1 - T_{2,k}\\right) S_2 + \\left(1 - T_{1,k}\\right) S_1,\\quad k=1,\\dots,K.\n$$\n\n切线性（TL）和伴随（ADJ）：在基态 $x_0$ 处的切线性算子是对于扰动 $\\delta x \\in \\mathbb{R}^4$ 的雅可比作用 $J(x_0)\\,\\delta x$。伴随算子是在欧几里得内积下对于 $y \\in \\mathbb{R}^K$ 的转置作用 $J(x_0)^\\top\\,y$。离散伴随一致性要求\n$$\n\\langle J(x_0)\\,\\delta x,\\; y \\rangle = \\langle \\delta x,\\; J(x_0)^\\top\\,y \\rangle\n$$\n对于所有 $\\delta x \\in \\mathbb{R}^4$ 和 $y \\in \\mathbb{R}^K$ 成立，其中 $\\langle \\cdot,\\cdot\\rangle$ 表示标准的欧几里得内积。您必须从上面定义的正向算子推导并实现解析的 TL 和 ADJ 对。\n\n数值点积测试：对于每个测试用例，计算标量值\n$$\n\\text{lhs} = \\langle J(x_0)\\,\\delta x,\\; y \\rangle,\\quad\n\\text{rhs} = \\langle \\delta x,\\; J(x_0)^\\top\\,y \\rangle,\n$$\n然后报告相对差异\n$$\n\\varepsilon = \\frac{\\left|\\text{lhs} - \\text{rhs}\\right|}{\\max\\left(1,\\left|\\text{lhs}\\right|,\\left|\\text{rhs}\\right|\\right)}.\n$$\n每个报告的 $\\varepsilon$ 是无单位的，并且必须表示为浮点值。\n\n角度和单位约定：直接使用方向余弦 $\\mu_k$（未提供角度，因此不需要角度单位规范）。辐射亮度 $\\left(S_1,S_2,E\\right)$ 和正向算子输出 $L_k$ 具有一致的辐射亮度单位，但只需输出无单位的相对差异 $\\varepsilon$。\n\n测试套件：为以下参数集实现点积测试，每个参数集定义了基态 $x_0$、表面辐射 $E$、视角方向余弦 $\\{\\mu_k\\}_{k=1}^K$、一个扰动 $\\delta x$ 和一个观测空间中的权重向量 $y$。\n\n- 情况 $1$ (理想情况)：\n  - $x_0 = [\\tau_1,\\tau_2,S_1,S_2] = [0.7, 1.3, 260.0, 280.0]$\n  - $E = 300.0$\n  - $\\mu = [1.0, 0.8, 0.5]$\n  - $\\delta x = [0.01, -0.02, 1.5, -0.5]$\n  - $y = [0.7, -1.2, 0.3]$\n- 情况 $2$ (近乎透明的层):\n  - $x_0 = [1\\times 10^{-4}, 2\\times 10^{-4}, 250.0, 250.0]$\n  - $E = 250.0$\n  - $\\mu = [1.0]$\n  - $\\delta x = [1\\times 10^{-6}, -2\\times 10^{-6}, 0.1, -0.1]$\n  - $y = [2.0]$\n- 情况 $3$ (不透明层和斜视路径):\n  - $x_0 = [10.0, 12.0, 280.0, 290.0]$\n  - $E = 300.0$\n  - $\\mu = [0.2, 0.1]$\n  - $\\delta x = [-0.05, 0.04, -1.0, 2.0]$\n  - $y = [1.0, -0.5]$\n- 情况 $4$ (零扰动边界情况):\n  - $x_0 = [0.7, 1.3, 260.0, 280.0]$\n  - $E = 290.0$\n  - $\\mu = [0.3, 0.6, 1.0]$\n  - $\\delta x = [0.0, 0.0, 0.0, 0.0]$\n  - $y = [0.3, 0.4, -0.1]$\n- 情况 $5$ (零观测权重边界情况):\n  - $x_0 = [0.9, 0.4, 265.0, 275.0]$\n  - $E = 285.0$\n  - $\\mu = [0.9, 0.7, 0.4, 0.2]$\n  - $\\delta x = [0.03, 0.02, -3.0, 1.0]$\n  - $y = [0.0, 0.0, 0.0, 0.0]$\n\n程序要求和输出规范：\n- 在每个测试用例的基态 $x_0$ 处，从正向算子解析地实现 TL 和 ADJ 算子。\n- 对每个情况，计算并收集上面定义的无单位相对差异 $\\varepsilon$ 作为浮点值。\n- 您的程序应生成单行输出，其中包含一个逗号分隔的列表，用方括号括起来，例如 $[r_1,r_2,r_3,r_4,r_5]$，其中 $r_i$ 对应于按所列顺序的第 $i$ 个情况。\n- 程序必须是独立的，不需要输入，并严格按照上面指定的值进行确定性计算。",
            "solution": "我们从比尔-朗伯定律和线性辐射叠加出发，推导给定的$2$层上行辐射传输算子的切线性（TL）和伴随（ADJ）算子。设状态为 $x = [\\tau_1,\\tau_2,S_1,S_2]^\\top$，表面辐射为 $E$，视角方向余弦为 $\\{\\mu_k\\}_{k=1}^K$ 且 $\\mu_k \\in (0,1]$。定义透射率 $T_{1,k} = \\exp(-\\tau_1/\\mu_k)$ 和 $T_{2,k} = \\exp(-\\tau_2/\\mu_k)$。正向映射 $F:\\mathbb{R}^4 \\to \\mathbb{R}^K$ 的分量形式为\n$$\nL_k(x) = T_{1,k} T_{2,k} E + T_{1,k} \\left(1 - T_{2,k}\\right) S_2 + \\left(1 - T_{1,k}\\right) S_1.\n$$\n此构造使用了比尔-朗伯定律，该定律指出沿方向余弦为 $\\mu_k$ 的路径，通过光学深度为 $\\tau$ 的层的透射率为 $\\exp(-\\tau/\\mu_k)$，并假定各向同性辐射的线性叠加，且该辐射被上覆层的透射率所衰减。\n\n为构造切线性算子，我们在基态 $x_0$ 计算雅可比矩阵 $\\partial L_k/\\partial x_j$。令 $a_k \\equiv 1/\\mu_k$，并将在 $x_0$ 处计算的 $T_{1,k} \\equiv \\exp(-\\tau_1 a_k)$ 和 $T_{2,k} \\equiv \\exp(-\\tau_2 a_k)$ 简写。$L_k$ 对状态分量的偏导数为\n$$\n\\frac{\\partial L_k}{\\partial S_1} = 1 - T_{1,k},\n\\quad\n\\frac{\\partial L_k}{\\partial S_2} = T_{1,k}\\left(1 - T_{2,k}\\right),\n$$\n并使用 $\\frac{\\partial T_{1,k}}{\\partial \\tau_1} = -a_k T_{1,k}$ 和 $\\frac{\\partial T_{2,k}}{\\partial \\tau_2} = -a_k T_{2,k}$，\n$$\n\\frac{\\partial L_k}{\\partial \\tau_1}\n= \\frac{\\partial T_{1,k}}{\\partial \\tau_1}\\,T_{2,k} E + \\frac{\\partial T_{1,k}}{\\partial \\tau_1}\\,\\left(1 - T_{2,k}\\right) S_2 - \\frac{\\partial T_{1,k}}{\\partial \\tau_1}\\,S_1\n= -a_k T_{1,k} T_{2,k} E - a_k T_{1,k}\\left(1 - T_{2,k}\\right) S_2 + a_k T_{1,k} S_1,\n$$\n$$\n\\frac{\\partial L_k}{\\partial \\tau_2}\n= T_{1,k}\\frac{\\partial T_{2,k}}{\\partial \\tau_2} E + T_{1,k}\\left(-\\frac{\\partial T_{2,k}}{\\partial \\tau_2}\\right) S_2\n= -a_k T_{1,k} T_{2,k} E + a_k T_{1,k} T_{2,k} S_2\n= a_k T_{1,k} T_{2,k}\\left(-E + S_2\\right).\n$$\n将这些收集到雅可比矩阵 $J \\in \\mathbb{R}^{K \\times 4}$ 中，其列对应于 $[\\tau_1,\\tau_2,S_1,S_2]$。对于一个扰动 $\\delta x = [\\delta \\tau_1,\\delta \\tau_2,\\delta S_1,\\delta S_2]^\\top$，TL 作用是矩阵-向量乘积\n$$\n\\left(J\\,\\delta x\\right)_k\n= \\frac{\\partial L_k}{\\partial \\tau_1}\\,\\delta \\tau_1\n+ \\frac{\\partial L_k}{\\partial \\tau_2}\\,\\delta \\tau_2\n+ \\frac{\\partial L_k}{\\partial S_1}\\,\\delta S_1\n+ \\frac{\\partial L_k}{\\partial S_2}\\,\\delta S_2.\n$$\n\n在欧几里得内积 $\\langle u,v\\rangle = \\sum_{i} u_i v_i$ 下，伴随算子是转置 $J^\\top$。对于任何 $y \\in \\mathbb{R}^K$，\n$$\n\\left(J^\\top y\\right)_1 = \\sum_{k=1}^K y_k \\frac{\\partial L_k}{\\partial \\tau_1},\\quad\n\\left(J^\\top y\\right)_2 = \\sum_{k=1}^K y_k \\frac{\\partial L_k}{\\partial \\tau_2},\\quad\n\\left(J^\\top y\\right)_3 = \\sum_{k=1}^K y_k \\frac{\\partial L_k}{\\partial S_1},\\quad\n\\left(J^\\top y\\right)_4 = \\sum_{k=1}^K y_k \\frac{\\partial L_k}{\\partial S_2}.\n$$\n根据欧几里得内积下矩阵转置的构造，我们有离散伴随恒等式\n$$\n\\langle J\\,\\delta x,\\; y\\rangle = \\langle \\delta x,\\; J^\\top y\\rangle\n$$\n对所有 $\\delta x$ 和 $y$ 成立。我们的数值点积测试通过计算\n$$\n\\text{lhs} = \\sum_{k=1}^K \\left(J\\,\\delta x\\right)_k\\, y_k,\\quad\n\\text{rhs} = \\sum_{j=1}^4 \\delta x_j \\left(J^\\top y\\right)_j,\n$$\n来验证此恒等式，并计算无单位相对差异\n$$\n\\varepsilon = \\frac{\\left|\\text{lhs} - \\text{rhs}\\right|}{\\max\\left(1,\\left|\\text{lhs}\\right|,\\left|\\text{rhs}\\right|\\right)}.\n$$\n\n算法设计：\n- 对于每个测试用例，在 $x_0$ 处计算 $T_{1,k}$ 和 $T_{2,k}$，并如上计算偏导数 $\\partial L_k/\\partial x_j$（$j \\in \\{1,2,3,4\\}$）。\n- 使用 $\\delta x$ 的分量作为权重，通过对列的加权求和来计算 TL 作用 $J\\,\\delta x$。\n- 通过每个导数列与 $y$ 的内积来计算 ADJ 作用 $J^\\top y$。\n- 使用欧几里得内积形成 $\\text{lhs}$ 和 $\\text{rhs}$，并使用所提供的归一化方法报告 $\\varepsilon$，以在不同尺度下保持稳健，包括任一向量为零向量的边界情况。\n- 对所有指定的情况重复此过程，并在单行上输出列表 $[\\varepsilon_1,\\varepsilon_2,\\varepsilon_3,\\varepsilon_4,\\varepsilon_5]$。\n\n由于 TL 和 ADJ 是从一个光滑有限维算子的精确解析导数在双精度算术中实现的，差异 $\\varepsilon$ 应该在浮点舍入误差的量级（通常接近 $10^{-15}$ 到 $10^{-16}$），对于扰动或观测权重是零向量的退化情况，根据归一化的构造，$\\varepsilon$ 将精确为零。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef tl_action_and_adjoint_rel_error(tau1, tau2, S1, S2, E, mu, dx, y):\n    \"\"\"\n    Compute the relative discrepancy epsilon between"
        },
        {
            "introduction": "为了高效地最小化变分代价函数，我们不仅需要梯度信息，还需要关于代价函数曲率的信息，这些信息包含在Hessian矩阵中。本练习 () 将指导您推导并计算Hessian矩阵的高斯-牛顿近似，这是资料同化中一种实用且广泛应用的方法。通过一个具体的例子，您将清楚地看到切线性算子及其伴随是如何用于构建这一关键的二阶信息。",
            "id": "4103712",
            "problem": "考虑在数值天气预报(NWP)和气候模拟中使用的标准四维变分(4D-Var)资料同化问题中的代价函数，该函数定义在一个状态向量 $\\mathbf{x} \\in \\mathbb{R}^{n}$ 和一个观测向量 $\\mathbf{y} \\in \\mathbb{R}^{m}$ 上，其中 $\\mathbf{B} \\in \\mathbb{R}^{n \\times n}$ 是正定背景误差协方差矩阵，$\\mathbf{R} \\in \\mathbb{R}^{m \\times m}$ 是正定观测误差协方差矩阵，$\\mathbf{H} : \\mathbb{R}^{n} \\to \\mathbb{R}^{m}$ 是一个可微观测算子。设迭代点为 $\\mathbf{x}^{k}$。在 $\\mathbf{x}^{k}$ 处的切线性算子是雅可比矩阵 $\\mathbf{H}'(\\mathbf{x}^{k})$，其伴随算子是 $\\mathbf{H}'(\\mathbf{x}^{k})^{T}$。\n\n从上述定义和基本的多变量微积分（泰勒展开和链式法则）出发，推导在 $\\mathbf{x}^{k}$ 处求值的代价函数的海森矩阵的高斯-牛顿近似，并用背景项和涉及切线性算子及其伴随算子的观测项来表示它。\n\n然后，对以下具体的、量纲一致的情况计算该表达式：\n- 状态维数 $n=2$，观测维数 $m=2$。\n- 背景误差协方差为 $\\mathbf{B} = \\mathrm{diag}(2,\\,1)$。\n- 观测误差协方差为 $\\mathbf{R} = \\mathrm{diag}\\!\\left(\\frac{1}{4},\\,1\\right)$。\n- 观测算子为 $\\mathbf{H}(\\mathbf{x}) = \\begin{pmatrix} x_{1}^{2} + x_{2} \\\\ \\sin(x_{1}) + x_{2} \\end{pmatrix}$。\n- 迭代点为 $\\mathbf{x}^{k} = \\begin{pmatrix} 1 \\\\ 2 \\end{pmatrix}$。\n\n计算此情况下在 $\\mathbf{x}^{k}$ 处的海森矩阵的高斯-牛顿近似，并提供显式矩阵。如果出现三角函数项，请保留其精确形式。无需四舍五入。将最终答案表示为不带单位的矩阵。",
            "solution": "四维变分(4D-Var)代价函数定义为\n$$\nJ(\\mathbf{x}) = \\frac{1}{2}\\,(\\mathbf{x} - \\mathbf{x}_{b})^{T}\\,\\mathbf{B}^{-1}\\,(\\mathbf{x} - \\mathbf{x}_{b}) + \\frac{1}{2}\\,\\big(\\mathbf{H}(\\mathbf{x}) - \\mathbf{y}\\big)^{T}\\,\\mathbf{R}^{-1}\\,\\big(\\mathbf{H}(\\mathbf{x}) - \\mathbf{y}\\big),\n$$\n其中 $\\mathbf{x}_{b}$ 是背景（先验）状态。\n\n根据多变量微积分， $J$ 关于 $\\mathbf{x}$ 的梯度可以通过对每一项求导得到。背景项是二次的，因此其贡献为\n$$\n\\nabla_{\\mathbf{x}} \\left[ \\frac{1}{2}\\,(\\mathbf{x} - \\mathbf{x}_{b})^{T}\\,\\mathbf{B}^{-1}\\,(\\mathbf{x} - \\mathbf{x}_{b}) \\right] = \\mathbf{B}^{-1}\\,(\\mathbf{x} - \\mathbf{x}_{b}).\n$$\n对于观测项，应用链式法则。令 $\\mathbf{d}(\\mathbf{x}) \\equiv \\mathbf{H}(\\mathbf{x}) - \\mathbf{y}$。则\n$$\n\\nabla_{\\mathbf{x}} \\left[ \\frac{1}{2}\\,\\mathbf{d}(\\mathbf{x})^{T}\\,\\mathbf{R}^{-1}\\,\\mathbf{d}(\\mathbf{x}) \\right] = \\mathbf{H}'(\\mathbf{x})^{T}\\,\\mathbf{R}^{-1}\\,\\mathbf{d}(\\mathbf{x}),\n$$\n其中 $\\mathbf{H}'(\\mathbf{x})$ 是在 $\\mathbf{x}$ 处求值的 $\\mathbf{H}$ 的雅可比矩阵（切线性算子），$\\mathbf{H}'(\\mathbf{x})^{T}$ 是其伴随算子。\n\n因此，梯度为\n$$\n\\nabla J(\\mathbf{x}) = \\mathbf{B}^{-1}\\,(\\mathbf{x} - \\mathbf{x}_{b}) + \\mathbf{H}'(\\mathbf{x})^{T}\\,\\mathbf{R}^{-1}\\,\\big(\\mathbf{H}(\\mathbf{x}) - \\mathbf{y}\\big).\n$$\n\n为求海森矩阵，对梯度关于 $\\mathbf{x}$ 求导。背景项的海森矩阵即为\n$$\n\\nabla^{2}\\left[ \\frac{1}{2}\\,(\\mathbf{x} - \\mathbf{x}_{b})^{T}\\,\\mathbf{B}^{-1}\\,(\\mathbf{x} - \\mathbf{x}_{b}) \\right] = \\mathbf{B}^{-1}.\n$$\n对于观测项，对 $\\mathbf{H}'(\\mathbf{x})^{T}\\,\\mathbf{R}^{-1}\\,\\big(\\mathbf{H}(\\mathbf{x}) - \\mathbf{y}\\big)$ 求导。使用雅可比矩阵的乘法法则和链式法则，\n$$\n\\nabla_{\\mathbf{x}}\\left[ \\mathbf{H}'(\\mathbf{x})^{T}\\,\\mathbf{R}^{-1}\\,\\big(\\mathbf{H}(\\mathbf{x}) - \\mathbf{y}\\big) \\right]\n= \\mathbf{H}'(\\mathbf{x})^{T}\\,\\mathbf{R}^{-1}\\,\\mathbf{H}'(\\mathbf{x}) + \\sum_{i=1}^{m} \\left[ \\nabla^{2} H_{i}(\\mathbf{x}) \\right]\\,\\big(\\mathbf{R}^{-1}\\,\\mathbf{d}(\\mathbf{x})\\big)_{i},\n$$\n其中 $\\nabla^{2} H_{i}(\\mathbf{x})$ 表示标量函数 $H_{i}(\\mathbf{x})$ 的海森矩阵，$(\\cdot)_{i}$ 表示第 $i$ 个分量。第一项，\n$$\n\\mathbf{H}'(\\mathbf{x})^{T}\\,\\mathbf{R}^{-1}\\,\\mathbf{H}'(\\mathbf{x}),\n$$\n来自于对残差内的 $\\mathbf{H}(\\mathbf{x})$ 求导，而第二项汇集了 $\\mathbf{H}$ 的二阶导数，并由残差和 $\\mathbf{R}^{-1}$ 加权。\n\n海森矩阵的高斯-牛顿近似忽略了涉及 $\\nabla^{2} H_{i}(\\mathbf{x})$ 和残差的二阶项。这在解附近是合理的，因为此时残差很小，并且这是非线性最小二乘法和变分资料同化中的标准近似。因此，在 $\\mathbf{x}^{k}$ 处，高斯-牛顿海森矩阵为\n$$\n\\mathbf{G}(\\mathbf{x}^{k}) \\approx \\mathbf{B}^{-1} + \\mathbf{H}'(\\mathbf{x}^{k})^{T}\\,\\mathbf{R}^{-1}\\,\\mathbf{H}'(\\mathbf{x}^{k}).\n$$\n\n现在我们针对指定情况计算该表达式。给定的矩阵是\n$$\n\\mathbf{B} = \\begin{pmatrix} 2  0 \\\\ 0  1 \\end{pmatrix}, \\quad \\mathbf{R} = \\begin{pmatrix} \\frac{1}{4}  0 \\\\ 0  1 \\end{pmatrix}.\n$$\n因此，\n$$\n\\mathbf{B}^{-1} = \\begin{pmatrix} \\frac{1}{2}  0 \\\\ 0  1 \\end{pmatrix}, \\quad \\mathbf{R}^{-1} = \\begin{pmatrix} 4  0 \\\\ 0  1 \\end{pmatrix}.\n$$\n\n观测算子是\n$$\n\\mathbf{H}(\\mathbf{x}) = \\begin{pmatrix} H_{1}(\\mathbf{x}) \\\\ H_{2}(\\mathbf{x}) \\end{pmatrix} = \\begin{pmatrix} x_{1}^{2} + x_{2} \\\\ \\sin(x_{1}) + x_{2} \\end{pmatrix}.\n$$\n其雅可比矩阵（切线性算子）是\n$$\n\\mathbf{H}'(\\mathbf{x}) = \\begin{pmatrix}\n\\frac{\\partial H_{1}}{\\partial x_{1}}  \\frac{\\partial H_{1}}{\\partial x_{2}} \\\\\n\\frac{\\partial H_{2}}{\\partial x_{1}}  \\frac{\\partial H_{2}}{\\partial x_{2}}\n\\end{pmatrix}\n= \\begin{pmatrix}\n2 x_{1}  1 \\\\\n\\cos(x_{1})  1\n\\end{pmatrix}.\n$$\n在迭代点 $\\mathbf{x}^{k} = \\begin{pmatrix} 1 \\\\ 2 \\end{pmatrix}$ 处，这变为\n$$\n\\mathbf{H}'(\\mathbf{x}^{k}) = \\begin{pmatrix} 2  1 \\\\ \\cos(1)  1 \\end{pmatrix}.\n$$\n\n计算 $\\mathbf{R}^{-1}\\,\\mathbf{H}'(\\mathbf{x}^{k})$:\n$$\n\\mathbf{R}^{-1}\\,\\mathbf{H}'(\\mathbf{x}^{k}) = \n\\begin{pmatrix} 4  0 \\\\ 0  1 \\end{pmatrix}\n\\begin{pmatrix} 2  1 \\\\ \\cos(1)  1 \\end{pmatrix}\n=\n\\begin{pmatrix} 8  4 \\\\ \\cos(1)  1 \\end{pmatrix}.\n$$\n然后\n$$\n\\mathbf{H}'(\\mathbf{x}^{k})^{T}\\,\\big(\\mathbf{R}^{-1}\\,\\mathbf{H}'(\\mathbf{x}^{k})\\big) =\n\\begin{pmatrix} 2  \\cos(1) \\\\ 1  1 \\end{pmatrix}\n\\begin{pmatrix} 8  4 \\\\ \\cos(1)  1 \\end{pmatrix}\n=\n\\begin{pmatrix}\n16 + \\cos^{2}(1)  8 + \\cos(1) \\\\\n8 + \\cos(1)  5\n\\end{pmatrix}.\n$$\n\n最后，加上 $\\mathbf{B}^{-1}$：\n$$\n\\mathbf{G}(\\mathbf{x}^{k}) \\approx \\mathbf{B}^{-1} + \\mathbf{H}'(\\mathbf{x}^{k})^{T}\\,\\mathbf{R}^{-1}\\,\\mathbf{H}'(\\mathbf{x}^{k})\n=\n\\begin{pmatrix} \\frac{1}{2}  0 \\\\ 0  1 \\end{pmatrix}\n+\n\\begin{pmatrix}\n16 + \\cos^{2}(1)  8 + \\cos(1) \\\\\n8 + \\cos(1)  5\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n\\frac{33}{2} + \\cos^{2}(1)  8 + \\cos(1) \\\\\n8 + \\cos(1)  6\n\\end{pmatrix}.\n$$\n\n该矩阵即为给定迭代点处变分代价函数海森矩阵的高斯-牛顿近似，并明确展示了其分解为背景项 $\\mathbf{B}^{-1}$ 和涉及切线性算子及其伴随算子的观测项 $\\mathbf{H}'(\\mathbf{x}^{k})^{T}\\,\\mathbf{R}^{-1}\\,\\mathbf{H}'(\\mathbf{x}^{k})$。",
            "answer": "$$\\boxed{\\begin{pmatrix}\\frac{33}{2}+\\cos^{2}(1)  8+\\cos(1) \\\\ 8+\\cos(1)  6\\end{pmatrix}}$$"
        },
        {
            "introduction": "切线性模型和伴随模型的用途远不止于寻找代价函数的最小值，它们还是敏感性分析和不确定性量化的关键工具。本练习 () 演示了如何利用切线性模型计算Fisher信息矩阵。该矩阵揭示了我们的观测资料中包含了多少关于底层模型参数的信息，并允许我们计算最终估计值的不确定性。",
            "id": "4103682",
            "problem": "给定一个适用于数值天气预报和气候模拟的线性化数据同化设置，其中使用变分框架从带噪声的观测中推断未知的模型参数。设参数向量为 $\\boldsymbol{\\theta} \\in \\mathbb{R}^n$，观测算子为 $\\boldsymbol{h}(\\cdot)$（将模型状态映射到观测空间），可用观测为 $\\boldsymbol{y} \\in \\mathbb{R}^m$，观测误差协方差为 $\\boldsymbol{R} \\in \\mathbb{R}^{m \\times m}$，背景（先验）均值为 $\\boldsymbol{\\theta}_b \\in \\mathbb{R}^n$，先验协方差为 $\\boldsymbol{B} \\in \\mathbb{R}^{n \\times n}$。标准变分代价函数为\n$$\nJ(\\boldsymbol{\\theta}) = \\frac{1}{2}\\left(\\boldsymbol{h}(\\boldsymbol{s}(\\boldsymbol{\\theta})) - \\boldsymbol{y}\\right)^\\top \\boldsymbol{R}^{-1} \\left(\\boldsymbol{h}(\\boldsymbol{s}(\\boldsymbol{\\theta})) - \\boldsymbol{y}\\right) + \\frac{1}{2}\\left(\\boldsymbol{\\theta} - \\boldsymbol{\\theta}_b\\right)^\\top \\boldsymbol{B}^{-1}\\left(\\boldsymbol{\\theta} - \\boldsymbol{\\theta}_b\\right),\n$$\n其中 $\\boldsymbol{s}(\\boldsymbol{\\theta})$ 表示由 $\\boldsymbol{\\theta}$ 引导的模型状态。在线性化点 $\\boldsymbol{\\theta}_0$ 附近，映射 $\\boldsymbol{\\theta} \\mapsto \\boldsymbol{h}(\\boldsymbol{s}(\\boldsymbol{\\theta}))$ 的切线性（TL）算子是满足以下条件的矩阵 $\\boldsymbol{G} \\in \\mathbb{R}^{m \\times n}$\n$$\n\\delta \\boldsymbol{y} \\approx \\boldsymbol{G}\\,\\delta \\boldsymbol{\\theta},\n$$\n其中 $\\delta \\boldsymbol{\\theta}$ 和 $\\delta \\boldsymbol{y}$ 是小扰动。伴随算子 $\\boldsymbol{G}^\\star$ 是根据欧几里得内积由以下性质定义的\n$$\n\\langle \\boldsymbol{G}\\,\\delta \\boldsymbol{\\theta},\\,\\delta \\boldsymbol{y} \\rangle = \\langle \\delta \\boldsymbol{\\theta},\\, \\boldsymbol{G}^\\star\\,\\delta \\boldsymbol{y} \\rangle\n$$\n对所有的 $\\delta \\boldsymbol{\\theta} \\in \\mathbb{R}^n$ 和 $\\delta \\boldsymbol{y} \\in \\mathbb{R}^m$ 均成立。\n\n从上述定义出发，利用线性化和伴随关系，推导一个算法以实现以下目标：\n- 通过内积恒等式验证所提供的切线性（TL）和伴随输出的伴随一致性；\n- 从切线性/伴随输出和观测误差协方差计算参数的费雪信息矩阵；\n- 通过费雪信息矩阵的秩相对于参数维数来评估参数的可辨识性；\n- 通过从先验和费雪信息中获得的后验协方差的对角线来量化参数不确定性。\n\n本问题不涉及物理单位；所有量均为无量纲。所有角度均不相关。您应将所有浮点数结果表示为四舍五入到六位小数的值。程序必须仅产生布尔值、整数和浮点数输出。\n\n为以下测试用例集实现您的算法。在每个用例中，您会获得切线性矩阵 $\\boldsymbol{G}^{(k)}$、伴随矩阵 $(\\boldsymbol{G}^{(k)})^\\star$（在欧几里得内积下，它与转置矩阵一致）、观测误差协方差对角线元素（因此 $\\boldsymbol{R}^{(k)} = \\mathrm{diag}(\\cdot)$）以及先验协方差对角线元素（因此 $\\boldsymbol{B}^{(k)} = \\mathrm{diag}(\\cdot)$）。对伴随一致性测试使用指定的随机种子。\n\n用例 $1$：\n- $\\boldsymbol{G}^{(1)} = \\begin{bmatrix} 1  0 \\\\ 0  1 \\\\ 1  1 \\end{bmatrix}$，\n- $(\\boldsymbol{G}^{(1)})^\\star = \\left(\\boldsymbol{G}^{(1)}\\right)^\\top$，\n- $\\boldsymbol{R}^{(1)} = \\mathrm{diag}(0.25, 0.25, 1.0)$，\n- $\\boldsymbol{B}^{(1)} = \\mathrm{diag}(1.0, 1.0)$，\n- 随机种子 $0$。\n\n用例 $2$：\n- $\\boldsymbol{G}^{(2)} = \\begin{bmatrix} 1  1  0 \\\\ 0  1  1 \\end{bmatrix}$，\n- $(\\boldsymbol{G}^{(2)})^\\star = \\left(\\boldsymbol{G}^{(2)}\\right)^\\top$，\n- $\\boldsymbol{R}^{(2)} = \\mathrm{diag}(1.0, 1.0)$，\n- $\\boldsymbol{B}^{(2)} = \\mathrm{diag}(100.0, 100.0, 100.0)$，\n- 随机种子 $1$。\n\n用例 $3$：\n- $\\boldsymbol{G}^{(3)} = \\begin{bmatrix} 1.0  0.999  0.001 \\\\ 0.999  0.998  0.002 \\\\ 0.001  0.002  0.999 \\end{bmatrix}$，\n- $(\\boldsymbol{G}^{(3)})^\\star = \\left(\\boldsymbol{G}^{(3)}\\right)^\\top$，\n- $\\boldsymbol{R}^{(3)} = \\mathrm{diag}(0.1, 0.1, 10.0)$，\n- $\\boldsymbol{B}^{(3)} = \\mathrm{diag}(1.0, 1.0, 1.0)$，\n- 随机种子 $2$。\n\n对每个用例 $k \\in \\{1,2,3\\}$，执行以下计算：\n- 通过检查\n$$\n\\left|\\langle \\boldsymbol{G}^{(k)}\\,\\delta \\boldsymbol{\\theta},\\,\\delta \\boldsymbol{y} \\rangle - \\langle \\delta \\boldsymbol{\\theta},\\,(\\boldsymbol{G}^{(k)})^\\star\\,\\delta \\boldsymbol{y} \\rangle\\right| \\le \\varepsilon\n$$\n是否在容差 $\\varepsilon = 10^{-10}$ 内成立来验证伴随恒等式，其中随机向量 $\\delta \\boldsymbol{\\theta}$ 和 $\\delta \\boldsymbol{y}$ 是使用指定的种子从标准正态分布生成的。报告一个布尔值表示通过或失败。\n- 从切线性/伴随输出和 $\\boldsymbol{R}^{(k)}$ 计算费雪信息矩阵，然后计算其矩阵的秩以及相应的可辨识性布尔值，该布尔值指示是否所有参数都可辨识（即秩等于 $n$）。\n- 计算费雪信息矩阵的谱条件数（在 $2$-范数下）；如果矩阵是奇异的，则报告一个无穷大值。\n- 计算通过结合先验和费雪信息形成的后验协方差 $\\boldsymbol{\\Sigma}_{\\text{post}}^{(k)}$，并返回 $\\boldsymbol{\\Sigma}_{\\text{post}}^{(k)}$ 的对角线元素。\n\n您的程序应产生单行输出，其中包含一个方括号内的逗号分隔列表形式的结果，每个用例的条目本身都是一个形式为\n$$\n[\\text{adjoint\\_ok},\\ \\text{rank},\\ \\text{cond},\\ [\\text{var}_1,\\ \\ldots,\\ \\text{var}_n]],\n$$\n的列表，所有浮点值都四舍五入到六位小数（对于无穷大值，使用语言默认的浮点无穷大值）。例如，输出应如下所示\n$$\n[[\\text{True},\\ 2,\\ 1.500000,\\ [0.187500,\\ 0.187500]],\\ \\ldots].\n$$",
            "solution": "用户提供了一个有科学依据、适定、客观且自洽的问题陈述。它根植于变分数据同化、贝叶斯推断和线性代数的既定原则，这些都是数值天气预报和地球物理建模的基础。所有的定义、数据和任务都清晰、精确且内部一致。没有违反科学原则、逻辑矛盾或含糊不清之处。因此，该问题被判定为**有效**。\n\n任务是为三个不同的数据同化场景执行一系列分析。这包括验证伴随关系，通过费雪信息矩阵（FIM）评估参数的可辨识性和数值条件，以及使用后验协方差量化参数的不确定性。算法的逻辑流程如下：\n\n_步骤1：伴随一致性验证_\n伴随算子 $\\boldsymbol{G}^\\star$ 关于欧几里得内积的定义由关系式 $\\langle \\boldsymbol{G}\\,\\delta \\boldsymbol{\\theta},\\,\\delta \\boldsymbol{y} \\rangle = \\langle \\delta \\boldsymbol{\\theta},\\, \\boldsymbol{G}^\\star\\,\\delta \\boldsymbol{y} \\rangle$ 给出。对于实值向量和矩阵，欧几里得内积是点积，$\\langle \\boldsymbol{a}, \\boldsymbol{b} \\rangle = \\boldsymbol{a}^\\top \\boldsymbol{b}$。这意味着伴随算子 $\\boldsymbol{G}^\\star$ 必须是转置 $\\boldsymbol{G}^\\top$。该恒等式可以写为 $(\\boldsymbol{G}\\,\\delta \\boldsymbol{\\theta})^\\top \\delta \\boldsymbol{y} = (\\delta \\boldsymbol{\\theta})^\\top (\\boldsymbol{G}^\\top\\,\\delta \\boldsymbol{y})$。根据矩阵转置的性质 $(AB)^\\top = B^\\top A^\\top$，左侧为 $(\\delta\\boldsymbol{\\theta})^\\top \\boldsymbol{G}^\\top \\delta \\boldsymbol{y}$，与右侧完全相同。这是矩阵代数的一个基本性质。因此，数值测试可作为对矩阵-向量乘积实现的“合理性检查”。我们通过计算两个内积的绝对差来测试该关系，其中扰动向量 $\\delta \\boldsymbol{\\theta} \\in \\mathbb{R}^n$ 和 $\\delta \\boldsymbol{y} \\in \\mathbb{R}^m$ 是随机生成的，并检查其是否低于一个小容差 $\\varepsilon = 10^{-10}$：\n$$\n\\left|\\langle \\boldsymbol{G}\\,\\delta \\boldsymbol{\\theta},\\,\\delta \\boldsymbol{y} \\rangle - \\langle \\delta \\boldsymbol{\\theta},\\, \\boldsymbol{G}^\\star\\,\\delta \\boldsymbol{y} \\rangle\\right| \\le \\varepsilon\n$$\n问题指明 $\\boldsymbol{G}^\\star$ 确实是 $\\boldsymbol{G}^\\top$，因此该检查预期会通过，从而证实操作的数值完整性。\n\n_步骤2：费雪信息矩阵（FIM）_\n费雪信息矩阵 $\\mathcal{I}$ 量化了观测值 $\\boldsymbol{y}$ 包含的关于参数 $\\boldsymbol{\\theta}$ 的信息量。它由代价函数的观测项 $J_o(\\boldsymbol{\\theta}) = \\frac{1}{2}\\left(\\boldsymbol{h}(\\boldsymbol{s}(\\boldsymbol{\\theta})) - \\boldsymbol{y}\\right)^\\top \\boldsymbol{R}^{-1} \\left(\\boldsymbol{h}(\\boldsymbol{s}(\\boldsymbol{\\theta})) - \\boldsymbol{y}\\right)$ 推导而来。在线性化设置中，模型响应近似为 $\\boldsymbol{h}(\\boldsymbol{s}(\\boldsymbol{\\theta})) \\approx \\boldsymbol{h}(\\boldsymbol{s}(\\boldsymbol{\\theta}_0)) + \\boldsymbol{G}(\\boldsymbol{\\theta} - \\boldsymbol{\\theta}_0)$，$J_o$ 关于 $\\boldsymbol{\\theta}$ 的海森矩阵是恒定的，并由下式给出：\n$$\n\\mathcal{I} = \\nabla^2_{\\boldsymbol{\\theta}} J_o = \\boldsymbol{G}^\\top \\boldsymbol{R}^{-1} \\boldsymbol{G}\n$$\n这个 $n \\times n$ 的对称半正定矩阵就是FIM。对于每个用例，我们计算 $\\mathcal{I}^{(k)} = (\\boldsymbol{G}^{(k)})^\\top (\\boldsymbol{R}^{(k)})^{-1} \\boldsymbol{G}^{(k)}$。由于 $\\boldsymbol{R}^{(k)}$ 是对角矩阵，其逆矩阵 $(\\boldsymbol{R}^{(k)})^{-1}$ 可以通过取每个对角元素的倒数轻易求得。\n\n_步骤3：参数可辨识性与条件数_\n如果FIM是满秩的，即 $\\mathrm{rank}(\\mathcal{I}) = n$（其中 $n$ 是参数数量），则参数 $\\boldsymbol{\\theta}$ 从观测中是局部可辨识的。秩亏的FIM表示某些参数或参数组合对观测没有影响，因此无法从观测中确定。我们为每个用例计算 $\\mathcal{I}$ 的秩。通过将此秩与 $n$ 比较来确定可辨识性。\n\nFIM的谱条件数 $\\kappa_2(\\mathcal{I})$ 是其最大特征值与最小特征值的比值，即 $\\kappa_2(\\mathcal{I}) = \\lambda_{\\max} / \\lambda_{\\min}$。它衡量了参数估计问题对数据中微小变化的敏感度。大的条件数表示一个病态问题，其中小的观测误差可能导致估计参数的巨大误差。如果FIM是奇异的（秩亏的），则 $\\lambda_{\\min} = 0$，条件数为无穷大，这证实了不可辨识性。\n\n_步骤4：后验协方差与不确定性_\n完整变分代价函数 $J(\\boldsymbol{\\theta})$ 结合了观测项 $J_o(\\boldsymbol{\\theta})$ 和一个背景（先验）项 $J_b(\\boldsymbol{\\theta}) = \\frac{1}{2}\\left(\\boldsymbol{\\theta} - \\boldsymbol{\\theta}_b\\right)^\\top \\boldsymbol{B}^{-1}\\left(\\boldsymbol{\\theta} - \\boldsymbol{\\theta}_b\\right)$。在贝叶斯框架下，假设误差服从高斯分布，最小化 $J(\\boldsymbol{\\theta})$ 等价于寻找最大后验（MAP）估计。$\\boldsymbol{\\theta}$ 的后验概率分布与 $\\exp(-J(\\boldsymbol{\\theta}))$ 成正比。后验协方差矩阵的逆 $\\boldsymbol{\\Sigma}_{\\text{post}}^{-1}$ 是完整代价函数的海森矩阵：\n$$\n\\boldsymbol{\\Sigma}_{\\text{post}}^{-1} = \\nabla^2_{\\boldsymbol{\\theta}} J(\\boldsymbol{\\theta}) = \\nabla^2_{\\boldsymbol{\\theta}} J_o(\\boldsymbol{\\theta}) + \\nabla^2_{\\boldsymbol{\\theta}} J_b(\\boldsymbol{\\theta}) = \\boldsymbol{G}^\\top \\boldsymbol{R}^{-1} \\boldsymbol{G} + \\boldsymbol{B}^{-1} = \\mathcal{I} + \\boldsymbol{B}^{-1}\n$$\n因此，后验协方差矩阵由这个“后验精度”矩阵的逆给出：\n$$\n\\boldsymbol{\\Sigma}_{\\text{post}} = (\\mathcal{I} + \\boldsymbol{B}^{-1})^{-1}\n$$\n$\\boldsymbol{\\Sigma}_{\\text{post}}$ 的对角线元素是每个参数的后验方差 $(\\sigma_i)^2$。这些值量化了在结合先验信息（来自 $\\boldsymbol{B}$）和来自观测的信息（来自 $\\mathcal{I}$）后，估计参数中的不确定性。我们为每个测试用例计算这些对角线元素。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the data assimilation problem for all test cases.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"G\": np.array([[1, 0], [0, 1], [1, 1]]),\n            \"R_diag\": np.array([0.25, 0.25, 1.0]),\n            \"B_diag\": np.array([1.0, 1.0]),\n            \"seed\": 0\n        },\n        {\n            \"G\": np.array([[1, 1, 0], [0, 1, 1]]),\n            \"R_diag\": np.array([1.0, 1.0]),\n            \"B_diag\": np.array([100.0, 100.0, 100.0]),\n            \"seed\": 1\n        },\n        {\n            \"G\": np.array([[1.0, 0.999, 0.001], [0.999, 0.998, 0.002], [0.001, 0.002, 0.999]]),\n            \"R_diag\": np.array([0.1, 0.1, 10.0]),\n            \"B_diag\": np.array([1.0, 1.0, 1.0]),\n            \"seed\": 2\n        }\n    ]\n\n    results_as_strings = []\n    for case in test_cases:\n        G = case[\"G\"]\n        R_diag = case[\"R_diag\"]\n        B_diag = case[\"B_diag\"]\n        seed = case[\"seed\"]\n\n        m, n = G.shape\n        G_star = G.T\n        \n        # Invert diagonal matrices\n        R_inv = np.diag(1.0 / R_diag)\n        B_inv = np.diag(1.0 / B_diag)\n\n        # Step 1: Adjoint consistency validation\n        rng = np.random.RandomState(seed)\n        d_theta = rng.randn(n)\n        d_y = rng.randn(m)\n\n        lhs = (G @ d_theta).T @ d_y\n        rhs = d_theta.T @ (G_star @ d_y)\n        \n        # The problem statement requires boolean output, so we explicitly cast.\n        adjoint_ok = bool(np.isclose(lhs, rhs, atol=1e-10, rtol=0))\n\n        # Step 2: Fisher Information Matrix (FIM)\n        fim = G.T @ R_inv @ G\n\n        # Step 3: Parameter identifiability and conditioning\n        rank = np.linalg.matrix_rank(fim)\n        # Note: p=2 is the default for np.linalg.cond but we specify for clarity\n        cond = np.linalg.cond(fim, p=2) \n        \n        # Step 4: Posterior Covariance and Uncertainty\n        posterior_precision = fim + B_inv\n        posterior_cov = np.linalg.inv(posterior_precision)\n        variances = np.diag(posterior_cov)\n\n        # Format results for this case\n        cond_str = f\"{cond:.6f}\" if np.isfinite(cond) else 'inf'\n        vars_list_str = ', '.join([f'{v:.6f}' for v in variances])\n        vars_str = f\"[{vars_list_str}]\"\n        \n        case_result_str = f\"[{str(adjoint_ok)}, {rank}, {cond_str}, {vars_str}]\"\n        results_as_strings.append(case_result_str)\n\n    # Final print statement in the exact required format.\n    print(f\"[{', '.join(results_as_strings)}]\")\n\nsolve()\n```"
        }
    ]
}