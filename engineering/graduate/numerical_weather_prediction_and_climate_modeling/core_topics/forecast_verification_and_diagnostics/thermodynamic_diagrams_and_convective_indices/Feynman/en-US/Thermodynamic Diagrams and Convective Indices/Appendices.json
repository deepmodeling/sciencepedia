{
    "hands_on_practices": [
        {
            "introduction": "The geometry of isopleths on thermodynamic diagrams, such as the saturation mixing ratio lines, is dictated by fundamental physical laws. This exercise will strengthen your understanding of this connection by guiding you through the derivation of the temperature sensitivity of the saturation mixing ratio, $w_s$, starting from the Clausius-Clapeyron relation and the Ideal Gas Law. Completing this practice  clarifies how first principles of phase equilibrium directly inform the graphical tools used to analyze atmospheric moisture and stability.",
            "id": "4104671",
            "problem": "Consider a saturated atmospheric parcel described within the framework of Numerical Weather Prediction (NWP) and thermodynamic diagram analysis. The saturation mixing ratio $w_s$ is defined as the ratio of the mass of water vapor to the mass of dry air in the parcel under saturation, and is a key quantity shaping the geometry of isopleths on thermodynamic diagrams and the sensitivity of convective indices. Starting from the Clausius–Clapeyron relation for phase equilibrium and the Ideal Gas Law (IGL), derive an analytic expression for the constant-pressure temperature sensitivity of the saturation mixing ratio in logarithmic form, $S(T,p) = \\left( \\partial \\ln w_s / \\partial T \\right)_p$, expressed only in terms of $T$, $p$, and fundamental constants. Assume the following scientifically standard idealizations: water vapor and dry air behave as ideal gases, the specific latent heat of vaporization $L_v$ is temperature-independent over the range of interest, the specific volume of liquid water is negligible compared to that of the vapor, and the dry-air and vapor gas constants are $R_d$ and $R_v$, respectively. Use the reference saturation vapor pressure over a plane liquid surface at the water triple point, $e_{s,0} = 611.65\\,\\mathrm{Pa}$ at $T_0 = 273.15\\,\\mathrm{K}$. Then evaluate the sensitivity at $T = 300\\,\\mathrm{K}$ and $p = 9.0 \\times 10^{4}\\,\\mathrm{Pa}$, using $L_v = 2.5 \\times 10^{6}\\,\\mathrm{J\\,kg^{-1}}$, $R_v = 461.5\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$, and $R_d = 287.06\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$. Round your final answer to four significant figures. Express the final sensitivity in per kelvin.",
            "solution": "The problem requires the derivation and evaluation of the constant-pressure temperature sensitivity of the saturation mixing ratio in logarithmic form, defined as $S(T,p) = \\left( \\partial \\ln w_s / \\partial T \\right)_p$. The derivation must commence from first principles, namely the Ideal Gas Law (IGL) and the Clausius-Clapeyron relation, under a specified set of standard idealizations.\n\nFirst, we establish the expression for the saturation mixing ratio, $w_s$. By definition, $w_s$ is the ratio of the mass of water vapor, $m_v$, to the mass of dry air, $m_d$, within a given parcel of volume $V$.\n$$w_s = \\frac{m_v}{m_d}$$\nApplying the IGL to each component, where $p_d$ is the partial pressure of dry air and $e_s$ is the saturation vapor pressure, we have:\n$$p_d V = m_d R_d T$$\n$$e_s V = m_v R_v T$$\nHere, $R_d$ and $R_v$ are the specific gas constants for dry air and water vapor, respectively, and $T$ is the temperature. The total pressure $p$ is the sum of the partial pressures, $p = p_d + e_s$.\nBy taking the ratio of these two IGL equations, we can express $w_s$ in terms of pressures:\n$$\\frac{m_v}{m_d} = \\frac{e_s V / (R_v T)}{p_d V / (R_d T)} = \\frac{R_d}{R_v} \\frac{e_s}{p_d}$$\nLet $\\epsilon = R_d / R_v$ be the ratio of the gas constants. Substituting $p_d = p - e_s$, we obtain the standard expression for the saturation mixing ratio:\n$$w_s = \\epsilon \\frac{e_s}{p - e_s}$$\nNote that $e_s$ is a function of temperature $T$ only, while $p$ is an independent state variable.\n\nNext, we address the temperature dependence of $e_s$ using the Clausius-Clapeyron relation. For the phase transition between liquid water and water vapor, under the assumptions that the specific volume of the liquid is negligible compared to the vapor ($\\nu_v \\gg \\nu_l$) and the vapor behaves as an ideal gas ($\\nu_v = R_v T / e_s$), the relation takes the form:\n$$\\frac{de_s}{dT} = \\frac{L_v}{T(\\nu_v - \\nu_l)} \\approx \\frac{L_v}{T\\nu_v} = \\frac{L_v e_s}{R_v T^2}$$\nwhere $L_v$ is the specific latent heat of vaporization, assumed to be constant. Rearranging this gives a key differential relationship:\n$$\\frac{1}{e_s} \\frac{de_s}{dT} = \\frac{L_v}{R_v T^2}$$\nThis equation can be integrated from a reference state $(T_0, e_{s,0})$ to a state $(T, e_s)$ to find the explicit functional form of $e_s(T)$:\n$$e_s(T) = e_{s,0} \\exp\\left[ \\frac{L_v}{R_v} \\left( \\frac{1}{T_0} - \\frac{1}{T} \\right) \\right]$$\n\nNow we can derive the expression for the sensitivity $S(T,p)$. We start by taking the natural logarithm of the expression for $w_s$:\n$$\\ln w_s = \\ln\\left(\\epsilon \\frac{e_s}{p - e_s}\\right) = \\ln(\\epsilon) + \\ln(e_s) - \\ln(p - e_s)$$\nWe then differentiate this expression with respect to $T$ while holding $p$ constant:\n$$S(T,p) = \\left( \\frac{\\partial \\ln w_s}{\\partial T} \\right)_p = \\frac{\\partial}{\\partial T} \\left[ \\ln(\\epsilon) + \\ln(e_s) - \\ln(p - e_s) \\right]_p$$\nSince $\\epsilon$ is a constant, its derivative is zero. Using the chain rule for the other terms, we get:\n$$S(T,p) = \\frac{1}{e_s}\\frac{de_s}{dT} - \\frac{1}{p - e_s} \\frac{\\partial}{\\partial T}(p - e_s)_p$$\nBecause $p$ is held constant, its partial derivative with respect to $T$ is zero. The derivative of $e_s(T)$ is a total derivative.\n$$S(T,p) = \\frac{1}{e_s}\\frac{de_s}{dT} - \\frac{1}{p - e_s} \\left(-\\frac{de_s}{dT}\\right) = \\left( \\frac{1}{e_s} + \\frac{1}{p-e_s} \\right) \\frac{de_s}{dT}$$\nCombining the terms in the parenthesis gives:\n$$S(T,p) = \\left( \\frac{p-e_s+e_s}{e_s(p-e_s)} \\right) \\frac{de_s}{dT} = \\frac{p}{e_s(p-e_s)}\\frac{de_s}{dT}$$\nWe now substitute the derivative $\\frac{de_s}{dT}$ from the Clausius-Clapeyron relation, $\\frac{de_s}{dT} = e_s \\frac{L_v}{R_v T^2}$:\n$$S(T,p) = \\frac{p}{e_s(p-e_s)} \\left( e_s \\frac{L_v}{R_v T^2} \\right)$$\nThe term $e_s$ cancels, leading to the simplified analytical expression for the sensitivity:\n$$S(T,p) = \\frac{p}{p - e_s(T)} \\frac{L_v}{R_v T^2}$$\nThis expression depends on $T$, $p$, and the saturation vapor pressure $e_s(T)$, which itself is a function of $T$ and fundamental constants as derived earlier.\n\nThe second part of the problem is to evaluate this sensitivity for the given parameters: $T = 300\\,\\mathrm{K}$, $p = 9.0 \\times 10^{4}\\,\\mathrm{Pa}$, $L_v = 2.5 \\times 10^{6}\\,\\mathrm{J\\,kg^{-1}}$, $R_v = 461.5\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$, $e_{s,0} = 611.65\\,\\mathrm{Pa}$, and $T_0 = 273.15\\,\\mathrm{K}$.\n\nFirst, we must calculate the saturation vapor pressure $e_s$ at $T = 300\\,\\mathrm{K}$:\n$$e_s(300\\,\\mathrm{K}) = e_{s,0} \\exp\\left[ \\frac{L_v}{R_v} \\left( \\frac{1}{T_0} - \\frac{1}{300\\,\\mathrm{K}} \\right) \\right]$$\n$$e_s(300\\,\\mathrm{K}) = 611.65\\,\\mathrm{Pa} \\times \\exp\\left[ \\frac{2.5 \\times 10^6\\,\\mathrm{J\\,kg^{-1}}}{461.5\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}} \\left( \\frac{1}{273.15\\,\\mathrm{K}} - \\frac{1}{300\\,\\mathrm{K}} \\right) \\right]$$\n$$e_s(300\\,\\mathrm{K}) \\approx 611.65\\,\\mathrm{Pa} \\times \\exp\\left[ 5417.118\\,\\mathrm{K} \\left( 0.00366094\\,\\mathrm{K^{-1}} - 0.00333333\\,\\mathrm{K^{-1}} \\right) \\right]$$\n$$e_s(300\\,\\mathrm{K}) \\approx 611.65\\,\\mathrm{Pa} \\times \\exp(1.77496) \\approx 3608.55\\,\\mathrm{Pa}$$\n\nNow, substitute this value for $e_s$ and the other given parameters into the expression for $S(T,p)$:\n$$S(300\\,\\mathrm{K}, 9.0 \\times 10^4\\,\\mathrm{Pa}) = \\frac{9.0 \\times 10^4\\,\\mathrm{Pa}}{9.0 \\times 10^4\\,\\mathrm{Pa} - 3608.55\\,\\mathrm{Pa}} \\times \\frac{2.5 \\times 10^6\\,\\mathrm{J\\,kg^{-1}}}{461.5\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}} \\times (300\\,\\mathrm{K})^2}$$\n$$S = \\frac{90000}{86391.45} \\times \\frac{2.5 \\times 10^6}{461.5 \\times 90000\\,\\mathrm{K}}$$\n$$S \\approx (1.04177) \\times (0.0601902\\,\\mathrm{K^{-1}})$$\n$$S \\approx 0.06270316\\,\\mathrm{K^{-1}}$$\nRounding the result to four significant figures, we get $S \\approx 0.06270\\,\\mathrm{K^{-1}}$.",
            "answer": "$$\\boxed{0.06270}$$"
        },
        {
            "introduction": "Buoyancy is the central driver of convection, but its precise calculation must account for both the reduced density from water vapor and the increased density from the weight of liquid and ice condensates. This exercise challenges you to derive the exact expressions for the virtual temperature, $T_v$, and the density temperature, $T_{\\rho}$, which respectively account for vapor and total water content. Understanding the distinction between these two quantities  is critical for accurately diagnosing stability and convective potential within the cloudy regions simulated by numerical weather prediction models.",
            "id": "4104684",
            "problem": "Consider a moist air parcel containing dry air, water vapor, liquid water, and ice. Let $p$ be the parcel pressure in $\\mathrm{Pa}$, $T$ the parcel temperature in $\\mathrm{K}$, $r_v$ the water vapor mixing ratio (mass of water vapor per unit mass of dry air, in $\\mathrm{kg/kg}$), $r_l$ the liquid water mixing ratio (in $\\mathrm{kg/kg}$), and $r_i$ the ice mixing ratio (in $\\mathrm{kg/kg}$). Let $R_d$ be the specific gas constant of dry air (in $\\mathrm{J\\,kg^{-1}\\,K^{-1}}$) and $R_v$ be the specific gas constant of water vapor (in $\\mathrm{J\\,kg^{-1}\\,K^{-1}}$). Define $\\varepsilon = R_d / R_v$. Take gravitational acceleration $g$ in $\\mathrm{m\\,s^{-2}}$.\n\nFundamental base:\n- The Ideal Gas Law (IGL) for a gas component is $p_x = \\rho_x R_x T$, where $p_x$ is partial pressure, $\\rho_x$ is density, and $R_x$ is the specific gas constant of the component $x$.\n- Dalton’s Law of partial pressures states $p = p_d + p_v$, where subscripts $d$ and $v$ denote dry air and water vapor, respectively.\n- The definition of mixing ratio $r_x = m_x / m_d$, where $m_x$ is the mass of component $x$ and $m_d$ is the mass of dry air in the parcel.\n- The virtual temperature is the temperature of dry air that yields the same gas-phase density as the moist gas mixture at the same pressure.\n- The density temperature is the temperature of dry air that yields the same total density (including condensate loading by liquid water and ice) as the real parcel at the same pressure.\n\nTask:\n1. Starting only from the fundamental base listed, derive the exact expressions for the parcel’s virtual temperature $T_v$ and density temperature $T_{\\rho}$ in terms of $T$, $r_v$, $r_l$, $r_i$, and $\\varepsilon$. Your derivation must be principled and must not invoke any shortcut formulas.\n2. Using a first-order Taylor expansion about $r_v = 0$, $r_l = 0$, and $r_i = 0$, obtain the linearized approximation of $T_{\\rho}$ to leading order in the mixing ratios.\n3. For an environment state characterized by pressure $p$ (the same as the parcel), temperature $T_{\\mathrm{env}}$ in $\\mathrm{K}$, and water vapor mixing ratio $r_{v,\\mathrm{env}}$ in $\\mathrm{kg/kg}$, compute the environment virtual temperature $T_{v,\\mathrm{env}}$ using the same physical principles. Assume the environment has negligible condensate, i.e., $r_{l,\\mathrm{env}} = r_{i,\\mathrm{env}} = 0$.\n4. Compute the buoyancy acceleration $B$ of the parcel using the density temperature approximation, defined by\n$$\nB = g \\frac{T_{\\rho} - T_{v,\\mathrm{env}}}{T_{v,\\mathrm{env}}},\n$$\nexpressed in $\\mathrm{m\\,s^{-2}}$.\n5. For each test case specified below, compute:\n   - The exact virtual temperature $T_v$ in $\\mathrm{K}$.\n   - The exact density temperature $T_{\\rho}$ in $\\mathrm{K}$.\n   - The absolute difference, in $\\mathrm{K}$, between the exact $T_{\\rho}$ and its first-order linearized approximation from step 2.\n   - The buoyancy acceleration $B$ in $\\mathrm{m\\,s^{-2}}$.\n   Express all four outputs rounded to six decimal places.\n\nConstants to use:\n- $R_d = 287.05\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$,\n- $R_v = 461.5\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$,\n- $g = 9.80665\\,\\mathrm{m\\,s^{-2}}$.\n\nTest suite (each parameter set is $(p, T, r_v, r_l, r_i, T_{\\mathrm{env}}, r_{v,\\mathrm{env}})$):\n- Case 1 (general moist, light cloud): $(100000, 300, 0.015, 0.001, 0.000, 300, 0.010)$.\n- Case 2 (dry boundary): $(85000, 290, 0.000, 0.000, 0.000, 290, 0.000)$.\n- Case 3 (humid with mixed-phase cloud): $(95000, 303, 0.025, 0.002, 0.001, 300, 0.020)$.\n- Case 4 (heavy condensate, cool parcel): $(90000, 275, 0.010, 0.012, 0.005, 278, 0.008)$.\n- Case 5 (warm parcel, humid environment): $(100000, 310, 0.008, 0.000, 0.000, 305, 0.020)$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each test case’s result should be a list of four floats in the order $[T_v, T_{\\rho}, \\Delta, B]$, where $\\Delta$ is the absolute difference between the exact $T_{\\rho}$ and its linearized approximation. For example, the overall format must be\n$$\n\\big[ [T_{v,1}, T_{\\rho,1}, \\Delta_1, B_1], [T_{v,2}, T_{\\rho,2}, \\Delta_2, B_2], \\dots \\big].\n$$\nAll temperatures must be in $\\mathrm{K}$ and $B$ must be in $\\mathrm{m\\,s^{-2}}$, each rounded to six decimal places.",
            "solution": "The problem requires the derivation of expressions for virtual temperature and density temperature of a moist air parcel, the linearization of the density temperature, and the calculation of buoyancy. These quantities must then be computed for a series of test cases. The derivations will proceed from the fundamental principles provided.\n\nLet the total parcel pressure be $p$, temperature be $T$, water vapor mixing ratio be $r_v$, liquid water mixing ratio be $r_l$, and ice mixing ratio be $r_i$. The specific gas constants for dry air and water vapor are $R_d$ and $R_v$, respectively, with $\\varepsilon = R_d/R_v$. The gravitational acceleration is $g$.\n\n**1. Derivation of Virtual Temperature ($T_v$)**\n\nThe virtual temperature, $T_v$, is defined as the temperature a parcel of pure dry air would need to have to equal the density of the moist air's gaseous phase at the same pressure $p$.\n\nThe density of the gaseous phase of the moist parcel, $\\rho_{\\text{gas}}$, is the sum of the dry air density $\\rho_d$ and water vapor density $\\rho_v$:\n$$\n\\rho_{\\text{gas}} = \\rho_d + \\rho_v\n$$\nBy definition of the mixing ratio, $r_v = m_v/m_d$, where $m_v$ and $m_d$ are the masses of water vapor and dry air in a given volume $V$. Thus, $\\rho_v = m_v/V$ and $\\rho_d = m_d/V$, which implies $r_v = \\rho_v/\\rho_d$. Therefore, $\\rho_{\\text{gas}} = \\rho_d(1+r_v)$.\n\nAccording to Dalton's Law, the total pressure $p$ is the sum of the partial pressures of dry air ($p_d$) and water vapor ($p_v$): $p = p_d + p_v$.\nUsing the Ideal Gas Law (IGL), $p_d = \\rho_d R_d T$ and $p_v = \\rho_v R_v T$.\nWe can express the mixing ratio in terms of partial pressures:\n$$\nr_v = \\frac{\\rho_v}{\\rho_d} = \\frac{p_v / (R_v T)}{p_d / (R_d T)} = \\frac{p_v}{p_d} \\frac{R_d}{R_v} = \\varepsilon \\frac{p_v}{p_d}\n$$\nFrom this, $p_v = p_d \\frac{r_v}{\\varepsilon}$. Substituting this into Dalton's Law:\n$$\np = p_d + p_d \\frac{r_v}{\\varepsilon} = p_d \\left(1 + \\frac{r_v}{\\varepsilon}\\right)\n$$\nThis allows us to express $p_d$ in terms of the total pressure $p$:\n$$\np_d = \\frac{p}{1 + r_v/\\varepsilon}\n$$\nNow, we express $\\rho_d$ using the IGL and the above relation for $p_d$:\n$$\n\\rho_d = \\frac{p_d}{R_d T} = \\frac{p}{R_d T (1 + r_v/\\varepsilon)}\n$$\nThe total gas density is then:\n$$\n\\rho_{\\text{gas}} = \\rho_d(1+r_v) = \\frac{p(1+r_v)}{R_d T (1 + r_v/\\varepsilon)}\n$$\nBy definition, a parcel of dry air at temperature $T_v$ and pressure $p$ has a density $\\rho_{\\text{dry}} = p / (R_d T_v)$. Equating this with $\\rho_{\\text{gas}}$:\n$$\n\\frac{p}{R_d T_v} = \\frac{p(1+r_v)}{R_d T (1 + r_v/\\varepsilon)}\n$$\nSolving for $T_v$ yields the exact expression for virtual temperature:\n$$\nT_v = T \\frac{1 + r_v/\\varepsilon}{1 + r_v}\n$$\n\n**2. Derivation of Density Temperature ($T_{\\rho}$)**\n\nThe density temperature, $T_{\\rho}$, is the temperature a parcel of pure dry air would need to have to equal the total density of the real parcel (including gaseous and condensed phases) at the same pressure $p$.\n\nThe total mass in the parcel is $m_{\\text{total}} = m_d + m_v + m_l + m_i$. The volume of the parcel $V$ is determined by its gaseous constituents, as the volume of condensed water is negligible. The total density is:\n$$\n\\rho_{\\text{total}} = \\frac{m_{\\text{total}}}{V} = \\frac{m_d(1 + r_v + r_l + r_i)}{V}\n$$\nUsing the IGL for dry air, $V = m_d R_d T / p_d$. Substituting this into the density expression:\n$$\n\\rho_{\\text{total}} = \\frac{m_d(1 + r_v + r_l + r_i)}{m_d R_d T / p_d} = \\frac{p_d (1 + r_v + r_l + r_i)}{R_d T}\n$$\nUsing our expression for $p_d = p / (1 + r_v/\\varepsilon)$:\n$$\n\\rho_{\\text{total}} = \\frac{p}{1 + r_v/\\varepsilon} \\frac{1 + r_v + r_l + r_i}{R_d T} = \\frac{p}{R_d T} \\frac{1 + r_v + r_l + r_i}{1 + r_v/\\varepsilon}\n$$\nBy definition, a parcel of dry air at $T_{\\rho}$ and $p$ has density $\\rho_{\\text{dry}} = p / (R_d T_{\\rho})$. Equating this with $\\rho_{\\text{total}}$:\n$$\n\\frac{p}{R_d T_{\\rho}} = \\frac{p}{R_d T} \\frac{1 + r_v + r_l + r_i}{1 + r_v/\\varepsilon}\n$$\nSolving for $T_{\\rho}$ gives the exact expression for density temperature:\n$$\nT_{\\rho} = T \\frac{1 + r_v/\\varepsilon}{1 + r_v + r_l + r_i}\n$$\n\n**3. Linearized Approximation of Density Temperature**\n\nWe perform a first-order multivariate Taylor expansion of $T_{\\rho}(r_v, r_l, r_i)$ around the point $(r_v, r_l, r_i) = (0, 0, 0)$.\n$$\nT_{\\rho, \\text{linear}} \\approx T_{\\rho}(0,0,0) + r_v \\frac{\\partial T_{\\rho}}{\\partial r_v}\\bigg|_{(0,0,0)} + r_l \\frac{\\partial T_{\\rho}}{\\partial r_l}\\bigg|_{(0,0,0)} + r_i \\frac{\\partial T_{\\rho}}{\\partial r_i}\\bigg|_{(0,0,0)}\n$$\nFirst, evaluate $T_{\\rho}$ at $(0,0,0)$:\n$$\nT_{\\rho}(0,0,0) = T \\frac{1 + 0/\\varepsilon}{1 + 0 + 0 + 0} = T\n$$\nNext, compute the partial derivatives:\n$$\n\\frac{\\partial T_{\\rho}}{\\partial r_v} = T \\frac{\\partial}{\\partial r_v} \\left( \\frac{1+r_v/\\varepsilon}{1 + r_v + r_l + r_i} \\right) = T \\frac{(1/\\varepsilon)(1 + r_v + r_l + r_i) - (1+r_v/\\varepsilon)(1)}{(1 + r_v + r_l + r_i)^2}\n$$\nEvaluating at $(0,0,0)$: $\\frac{\\partial T_{\\rho}}{\\partial r_v}\\bigg|_{(0,0,0)} = T \\frac{1/\\varepsilon - 1}{1^2} = T(1/\\varepsilon - 1)$.\n$$\n\\frac{\\partial T_{\\rho}}{\\partial r_l} = T (1+r_v/\\varepsilon) \\frac{\\partial}{\\partial r_l} \\left( (1 + r_v + r_l + r_i)^{-1} \\right) = T (1+r_v/\\varepsilon) \\frac{-1}{(1 + r_v + r_l + r_i)^2}\n$$\nEvaluating at $(0,0,0)$: $\\frac{\\partial T_{\\rho}}{\\partial r_l}\\bigg|_{(0,0,0)} = T(1) \\frac{-1}{1^2} = -T$.\nBy symmetry, $\\frac{\\partial T_{\\rho}}{\\partial r_i}\\bigg|_{(0,0,0)} = -T$.\n\nCombining these terms, the linearized approximation is:\n$$\nT_{\\rho, \\text{linear}} = T + r_v T(1/\\varepsilon - 1) - r_l T - r_i T = T(1 + r_v(1/\\varepsilon - 1) - r_l - r_i)\n$$\n\n**4. Environment Virtual Temperature ($T_{v,\\mathrm{env}}$) and Buoyancy ($B$)**\n\nThe environment virtual temperature, $T_{v,\\mathrm{env}}$, is calculated using the same formula as for the parcel's $T_v$, but with a different state: temperature $T_{\\mathrm{env}}$, water vapor mixing ratio $r_{v,\\mathrm{env}}$, and negligible condensate ($r_{l,\\mathrm{env}}=0, r_{i,\\mathrm{env}}=0$).\n$$\nT_{v,\\mathrm{env}} = T_{\\mathrm{env}} \\frac{1 + r_{v,\\mathrm{env}}/\\varepsilon}{1 + r_{v,\\mathrm{env}}}\n$$\nThe buoyancy acceleration, $B$, is given by the formula:\n$$\nB = g \\frac{T_{\\rho} - T_{v,\\mathrm{env}}}{T_{v,\\mathrm{env}}}\n$$\nHere, we use the exact density temperature $T_{\\rho}$ of the parcel.\n\n**Summary of Calculations**\nFor each test case, the following four quantities will be computed and reported to six decimal places:\n1.  Exact parcel virtual temperature: $T_v = T \\frac{1 + r_v/\\varepsilon}{1 + r_v}$\n2.  Exact parcel density temperature: $T_{\\rho} = T \\frac{1 + r_v/\\varepsilon}{1 + r_v + r_l + r_i}$\n3.  Absolute difference with linearized approximation: $\\Delta = |T_{\\rho} - T(1 + r_v(1/\\varepsilon - 1) - r_l - r_i)|$\n4.  Buoyancy acceleration: $B = g \\frac{T_{\\rho} - T_{v,\\mathrm{env}}}{T_{v,\\mathrm{env}}}$, where $T_{v,\\mathrm{env}} = T_{\\mathrm{env}} \\frac{1 + r_{v,\\mathrm{env}}/\\varepsilon}{1 + r_{v,\\mathrm{env}}}$.\n\nThe constants are $R_d = 287.05\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$, $R_v = 461.5\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$, and $g = 9.80665\\,\\mathrm{m\\,s^{-2}}$. From this, $\\varepsilon = R_d / R_v \\approx 0.62200433$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the atmospheric thermodynamics problem for a series of test cases.\n    It calculates parcel virtual and density temperatures, compares the exact\n    density temperature to its linearized approximation, and computes the\n    parcel's buoyancy acceleration.\n    \"\"\"\n    \n    # Define constants\n    R_d = 287.05  # J kg^-1 K^-1\n    R_v = 461.5   # J kg^-1 K^-1\n    g = 9.80665   # m s^-2\n    \n    # Epsilon, the ratio of gas constants\n    epsilon = R_d / R_v\n\n    # Define the test cases from the problem statement.\n    # Each case is a tuple: (p, T, r_v, r_l, r_i, T_env, r_v_env)\n    test_cases = [\n        (100000, 300, 0.015, 0.001, 0.000, 300, 0.010),\n        (85000, 290, 0.000, 0.000, 0.000, 290, 0.000),\n        (95000, 303, 0.025, 0.002, 0.001, 300, 0.020),\n        (90000, 275, 0.010, 0.012, 0.005, 278, 0.008),\n        (100000, 310, 0.008, 0.000, 0.000, 305, 0.020),\n    ]\n\n    # This function encapsulates the physics calculations for a single case.\n    def calculate_properties(case, epsilon_val, g_val):\n        \"\"\"\n        Computes the required thermodynamic properties for a single parcel and environment state.\n        \n        Args:\n            case (tuple): A tuple containing the state variables \n                          (p, T, r_v, r_l, r_i, T_env, r_v_env).\n            epsilon_val (float): The ratio R_d / R_v.\n            g_val (float): Gravitational acceleration.\n\n        Returns:\n            tuple: A tuple of four floats (T_v_exact, T_rho_exact, delta, B).\n        \"\"\"\n        # Unpack the case tuple\n        p, T, r_v, r_l, r_i, T_env, r_v_env = case\n        \n        # 1. Exact virtual temperature (Tv)\n        T_v_exact = T * (1.0 + r_v / epsilon_val) / (1.0 + r_v)\n        \n        # 2. Exact density temperature (T_rho)\n        total_mixing_ratio_parcel = r_v + r_l + r_i\n        T_rho_exact = T * (1.0 + r_v / epsilon_val) / (1.0 + total_mixing_ratio_parcel)\n        \n        # 3. Linearized T_rho and the absolute difference (delta)\n        T_rho_linear = T * (1.0 + r_v * (1.0 / epsilon_val - 1.0) - r_l - r_i)\n        delta = abs(T_rho_exact - T_rho_linear)\n        \n        # 4. Buoyancy acceleration (B)\n        # First, compute environment virtual temperature\n        T_v_env = T_env * (1.0 + r_v_env / epsilon_val) / (1.0 + r_v_env)\n        # Then, compute buoyancy\n        B = g_val * (T_rho_exact - T_v_env) / T_v_env\n        \n        return T_v_exact, T_rho_exact, delta, B\n\n    results_as_strings = []\n    for case in test_cases:\n        # Perform calculations for the current case\n        calcs = calculate_properties(case, epsilon, g)\n        \n        # Format the results to 6 decimal places and create a string sublist\n        # e.g., \"[302.694248,302.395760,0.038901,0.019238]\"\n        formatted_sublist = (\n            f\"[{calcs[0]:.6f},\"\n            f\"{calcs[1]:.6f},\"\n            f\"{calcs[2]:.6f},\"\n            f\"{calcs[3]:.6f}]\"\n        )\n        results_as_strings.append(formatted_sublist)\n\n    # Final print statement in the exact required format: [[...],[...],...]\n    print(f\"[{','.join(results_as_strings)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Analyzing an atmospheric sounding for convective stability is a core task in meteorology, whether performed graphically on a thermodynamic diagram or numerically within a model. This computational practice bridges theory and application by having you implement the hypsometric equation to determine atmospheric layer thickness and then calculate the Brunt-Väisälä frequency, $N^2$, a robust measure of static stability. By writing code to process atmospheric profile data , you will gain direct experience with the algorithms that underpin stability diagnostics in modern forecasting systems.",
            "id": "4104675",
            "problem": "You will derive and implement a program that uses the hydrostatic and hypsometric relations to compute geometric height and a convective stability diagnostic for a discrete atmospheric column, linking the formulation to convective indices through the Brunt–Väisälä frequency. The derivation must start from fundamental laws and well-tested formulas, and the implementation must be consistent with these principles.\n\nYou are given a set of test cases, each consisting of a vertical profile of pressure, temperature, and water-vapor mixing ratio. Your tasks are to:\n\n- Derive from first principles the expression used to compute geometric layer thickness from pressure and virtual temperature without using any pre-supplied \"shortcut\" formulas.\n- Derive the definition and discrete approximation of the Brunt–Väisälä frequency squared as a measure of convective stability, using the hydrostatic relation to convert from pressure to height.\n- Implement a program to compute, for each test case, the following quantities:\n  1. The total geometric thickness between the first and last pressure levels, in meters.\n  2. The column-average virtual temperature, in kelvins, obtained by algebraically inverting the hypsometric relation over the full column.\n  3. The count of layers that are convectively unstable, defined by negative squared Brunt–Väisälä frequency.\n\nUse the following physically based constants in SI units: dry-gas specific constant $R_d = 287\\ \\mathrm{J\\,kg^{-1}\\,K^{-1}}$, specific heat at constant pressure $c_p = 1004\\ \\mathrm{J\\,kg^{-1}\\,K^{-1}}$, gravitational acceleration $g = 9.80665\\ \\mathrm{m\\,s^{-2}}$, and reference pressure $p_{\\mathrm{ref}} = 100000\\ \\mathrm{Pa}$. Use the approximation for virtual temperature, $T_v = T(1 + 0.61r)$, where $T$ is temperature in kelvins and $r$ is the water-vapor mixing ratio in $\\mathrm{kg\\,kg^{-1}}$. Define potential temperature by $\\theta = T(p_{\\mathrm{ref}}/p)^{\\kappa}$ with $\\kappa = R_d/c_p$.\n\nFor each test case, you will receive arrays of pressure $p_i$ in pascals, temperature $T_i$ in kelvins, and mixing ratio $r_i$ in $\\mathrm{kg\\,kg^{-1}}$, ordered from the surface to the upper level with strictly decreasing pressure. You must:\n\n- Set the geometric height at the first (surface) level to $z_0 = 0\\ \\mathrm{m}$.\n- Compute layer thicknesses using the hypsometric integral evaluated with a layer-mean virtual temperature. Accumulate to get heights $z_i$ at all levels.\n- Compute the potential temperature at each level.\n- Compute the squared Brunt–Väisälä frequency for each layer using a consistent discrete approximation based on layer differences.\n- Count layers with negative squared Brunt–Väisälä frequency as convectively unstable.\n\nExpress the final geometric thickness in $\\mathrm{m}$ and the column-average virtual temperature in $\\mathrm{K}$. Angles do not appear. If you compute percentages internally, you must output them as decimals or fractions, but no percentages are requested here.\n\nProvide the following four test cases:\n\n- Test case A (typical mid-latitude tropospheric segment):\n  - Pressure levels $[\\,100000,\\ 90000,\\ 80000,\\ 70000,\\ 60000,\\ 50000\\,]$ in $\\mathrm{Pa}$.\n  - Temperature profile $[\\,290,\\ 284,\\ 278,\\ 272,\\ 266,\\ 260\\,]$ in $\\mathrm{K}$.\n  - Mixing ratio profile $[\\,0.012,\\ 0.010,\\ 0.008,\\ 0.006,\\ 0.004,\\ 0.002\\,]$ in $\\mathrm{kg\\,kg^{-1}}$.\n\n- Test case B (isothermal, weakly moist column):\n  - Pressure levels $[\\,100000,\\ 90000,\\ 80000,\\ 70000,\\ 60000,\\ 50000\\,]$ in $\\mathrm{Pa}$.\n  - Temperature profile $[\\,280,\\ 280,\\ 280,\\ 280,\\ 280,\\ 280\\,]$ in $\\mathrm{K}$.\n  - Mixing ratio profile $[\\,0.004,\\ 0.004,\\ 0.004,\\ 0.004,\\ 0.004,\\ 0.004\\,]$ in $\\mathrm{kg\\,kg^{-1}}$.\n\n- Test case C (dry-adiabatic column with constant potential temperature):\n  - Pressure levels $[\\,100000,\\ 90000,\\ 80000,\\ 70000,\\ 60000,\\ 50000\\,]$ in $\\mathrm{Pa}$.\n  - Potential temperature is constant at $[\\,300,\\ 300,\\ 300,\\ 300,\\ 300,\\ 300\\,]$ in $\\mathrm{K}$; compute the corresponding temperature profile using $\\theta = T(p_{\\mathrm{ref}}/p)^{\\kappa}$ with $\\kappa = R_d/c_p$, and take $r = 0$ at all levels.\n\n- Test case D (low-level superadiabatic layer indicating convective instability):\n  - Pressure levels $[\\,100000,\\ 90000,\\ 80000,\\ 70000,\\ 60000,\\ 50000\\,]$ in $\\mathrm{Pa}$.\n  - Temperature profile $[\\,305,\\ 294,\\ 286,\\ 278,\\ 270,\\ 262\\,]$ in $\\mathrm{K}$.\n  - Mixing ratio profile $[\\,0.014,\\ 0.012,\\ 0.010,\\ 0.006,\\ 0.003,\\ 0.001\\,]$ in $\\mathrm{kg\\,kg^{-1}}$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with each test case’s result reported as a three-element list $[\\,\\Delta z,\\ T_{v,\\mathrm{avg}},\\ n_{\\mathrm{unstable}}\\,]$, where $\\Delta z$ is the total geometric thickness in $\\mathrm{m}$, $T_{v,\\mathrm{avg}}$ is the column-average virtual temperature in $\\mathrm{K}$, and $n_{\\mathrm{unstable}}$ is the integer count of unstable layers. For example, the overall output should look like $[[\\ldots],[\\ldots],[\\ldots],[\\ldots]]$ with no spaces inside lists.\n\nYour implementation must be a complete, runnable program, as specified in the final answer section.",
            "solution": "The problem is valid as it is scientifically grounded in established principles of atmospheric thermodynamics, is well-posed with sufficient data and clear objectives, and is expressed in precise, objective language. All constants and governing equations are standard in the field. The provided test cases are physically plausible and serve to test the derived algorithms under different conditions. The problem is formalizable and requires non-trivial derivation and implementation, making it a substantive task.\n\nThe solution proceeds in two parts: first, the derivation of the necessary physical and mathematical relations from first principles, and second, the description of the algorithm to implement these relations numerically.\n\n### Derivation of Physical Relations\n\n**1. Geometric Layer Thickness (Hypsometric Equation)**\n\nThe relationship between pressure and height in an atmosphere is governed by the hydrostatic equation, which balances the vertical pressure gradient force and the gravitational force on a fluid parcel at rest:\n$$\n\\frac{dp}{dz} = -\\rho g\n$$\nwhere $p$ is pressure, $z$ is geometric height, $\\rho$ is the density of air, and $g$ is the acceleration due to gravity.\n\nThe density of moist air can be expressed using the ideal gas law, modified with the virtual temperature $T_v$ to account for the lower mean molecular weight of moist air compared to dry air:\n$$\np = \\rho R_d T_v\n$$\nwhere $R_d$ is the specific gas constant for dry air. The problem provides the approximation for virtual temperature as $T_v = T(1 + 0.61r)$, where $T$ is the air temperature and $r$ is the water vapor mixing ratio.\n\nSolving for density $\\rho = p / (R_d T_v)$ and substituting into the hydrostatic equation gives:\n$$\n\\frac{dp}{dz} = -\\frac{p g}{R_d T_v}\n$$\nThis is a differential equation relating pressure and height. To find the thickness of a layer, we can separate variables and integrate:\n$$\ndz = -\\frac{R_d T_v}{g} \\frac{dp}{p}\n$$\nIntegrating this equation between two pressure levels $p_1$ (lower) and $p_2$ (upper), corresponding to heights $z_1$ and $z_2$, yields the layer thickness $\\Delta z = z_2 - z_1$:\n$$\n\\int_{z_1}^{z_2} dz = \\Delta z = -\\frac{R_d}{g} \\int_{p_1}^{p_2} \\frac{T_v}{p} dp = \\frac{R_d}{g} \\int_{p_2}^{p_1} \\frac{T_v}{p} dp\n$$\nTo evaluate this integral, we assume that the virtual temperature varies linearly with $\\ln(p)$ within the layer, which allows us to replace $T_v$ with its layer-mean value, $\\bar{T}_v$. The problem specifies using the arithmetic mean of the virtual temperatures at the layer boundaries:\n$$\n\\bar{T}_v = \\frac{T_{v,1} + T_{v,2}}{2}\n$$\nWith this approximation, the integral becomes:\n$$\n\\Delta z = \\frac{R_d \\bar{T}_v}{g} \\int_{p_2}^{p_1} \\frac{dp}{p} = \\frac{R_d \\bar{T}_v}{g} [\\ln(p)]_{p_2}^{p_1}\n$$\nThis results in the hypsometric equation for the layer thickness:\n$$\n\\Delta z = \\frac{R_d \\bar{T}_v}{g} \\ln\\left(\\frac{p_1}{p_2}\\right)\n$$\nThis equation will be used to compute the thickness of each discrete layer in the atmospheric profile. The total geometric thickness is the sum of these individual layer thicknesses.\n\n**2. Column-Average Virtual Temperature**\n\nThe hypsometric equation can be applied to the entire atmospheric column from the surface (level $0$) to the top (level $N-1$). The total geometric thickness $\\Delta z_{\\text{total}} = z_{N-1} - z_0$ is related to a single column-average virtual temperature, $T_{v,\\text{avg}}$, by:\n$$\n\\Delta z_{\\text{total}} = \\frac{R_d T_{v,\\text{avg}}}{g} \\ln\\left(\\frac{p_0}{p_{N-1}}\\right)\n$$\nThe problem requires computing this $T_{v,\\text{avg}}$ by algebraically inverting this relation. Solving for $T_{v,\\text{avg}}$ gives:\n$$\nT_{v,\\text{avg}} = \\frac{g \\, \\Delta z_{\\text{total}}}{R_d \\ln(p_0/p_{N-1})}\n$$\nwhere $\\Delta z_{\\text{total}}$ is first computed by summing the individual layer thicknesses calculated using the method from the previous section.\n\n**3. Brunt–Väisälä Frequency and Convective Stability**\n\nThe Brunt–Väisälä frequency, $N$, quantifies the static stability of a fluid column. Its square, $N^2$, represents the restoring acceleration per unit displacement for a vertically displaced fluid parcel. Consider a parcel displaced adiabatically (i.e., its potential temperature remains constant) upward by a small distance $\\delta z$. The net buoyancy force per unit mass on the parcel is approximately $g(\\rho_e - \\rho_p)/\\rho_p$, where subscripts $e$ and $p$ denote the environment and the parcel, respectively. This can be expressed in terms of virtual potential temperature, $\\theta_v$, defined as the potential temperature that dry air would have to attain to have the same density as moist air at the same pressure. For an adiabatic displacement, the parcel's $\\theta_v$ is conserved. The environmental $\\theta_v$ at height $z + \\delta z$ is approximately $\\theta_{v,e}(z) + (d\\theta_{v,e}/dz) \\delta z$. The buoyancy force leads to the equation of motion for the parcel's vertical displacement:\n$$\n\\frac{d^2(\\delta z)}{dt^2} = -\\left(\\frac{g}{\\theta_{v,e}} \\frac{d\\theta_{v,e}}{dz}\\right) \\delta z\n$$\nThis is the equation for simple harmonic motion, where the squared angular frequency is the term in the parentheses. We thus define the squared Brunt–Väisälä frequency as:\n$$\nN^2 = \\frac{g}{\\theta_v} \\frac{d\\theta_v}{dz}\n$$\nThe virtual potential temperature, $\\theta_v$, is given by $\\theta_v = T_v (p_{\\text{ref}}/p)^{\\kappa} = \\theta(1+0.61r)$, where $\\theta = T(p_{\\text{ref}}/p)^{\\kappa}$ is the potential temperature and $\\kappa = R_d/c_p$.\n- If $N^2 > 0$, $(d\\theta_v/dz > 0)$, a displaced parcel experiences a restoring force, leading to oscillation. The atmosphere is statically stable.\n- If $N^2 = 0$, $(d\\theta_v/dz = 0)$, a displaced parcel experiences no net force. The atmosphere is neutrally stable.\n- If $N^2  0$, $(d\\theta_v/dz  0)$, a displaced parcel experiences a force that accelerates it further from its original position. The atmosphere is convectively unstable.\n\nFor a discrete atmospheric profile, we approximate $N^2$ for a layer between levels $i$ (lower) and $i+1$ (upper) using finite differences. The derivative $d\\theta_v/dz$ is approximated as $\\Delta\\theta_v/\\Delta z = (\\theta_{v,i+1} - \\theta_{v,i})/(z_{i+1} - z_i)$, and $\\theta_v$ is approximated by the layer-mean value $\\bar{\\theta}_v = (\\theta_{v,i} + \\theta_{v,i+1})/2$.\n$$\nN^2_i \\approx \\frac{g}{\\bar{\\theta}_{v,i}} \\frac{\\Delta\\theta_{v,i}}{\\Delta z_i} = \\frac{2g}{\\theta_{v,i} + \\theta_{v,i+1}} \\frac{\\theta_{v,i+1} - \\theta_{v,i}}{z_{i+1} - z_i}\n$$\nSince $g$, $\\bar{\\theta}_v$ (in Kelvin), and $\\Delta z$ are always positive, the sign of $N^2_i$ is determined solely by the sign of $\\theta_{v,i+1} - \\theta_{v,i}$. Therefore, a layer is convectively unstable if and only if its virtual potential temperature decreases with height:\n$$\n\\text{Unstable layer condition: } \\theta_{v,i+1}  \\theta_{v,i}\n$$\n\n### Numerical Implementation Algorithm\n\nThe overall algorithm for each test case is as follows:\n1.  Define the physical constants: $R_d = 287$, $c_p = 1004$, $g = 9.80665$, $p_{\\text{ref}} = 100000$. Calculate $\\kappa = R_d/c_p$.\n2.  For each test case, obtain the input arrays for pressure $p_i$, temperature $T_i$, and mixing ratio $r_i$. For Case C, first compute the temperature profile from the given constant potential temperature using $T_i = \\theta_i (p_i/p_{\\text{ref}})^{\\kappa}$.\n3.  Calculate the virtual temperature $T_{v,i} = T_i(1 + 0.61r_i)$ at each level $i$.\n4.  Initialize an array of heights with $z_0 = 0$.\n5.  Iterate through the atmospheric layers from $i = 0$ to the second-to-last level:\n    a. Compute the layer-mean virtual temperature $\\bar{T}_{v,i} = (T_{v,i} + T_{v,i+1})/2$.\n    b. Compute the layer thickness $\\Delta z_i = \\frac{R_d \\bar{T}_{v,i}}{g} \\ln(p_i/p_{i+1})$.\n    c. Compute the height of the next level $z_{i+1} = z_i + \\Delta z_i$ and store it.\n6.  The total geometric thickness $\\Delta z_{\\text{total}}$ is the final computed height, $z_{N-1}$.\n7.  Compute the column-average virtual temperature $T_{v,\\text{avg}} = \\frac{g \\, \\Delta z_{\\text{total}}}{R_d \\ln(p_0/p_{N-1})}$.\n8.  Calculate the potential temperature $\\theta_i = T_i (p_{\\text{ref}}/p_i)^{\\kappa}$ and then the virtual potential temperature $\\theta_{v,i} = \\theta_i(1+0.61r_i)$ for all levels.\n9.  Initialize a counter for unstable layers, $n_{\\text{unstable}} = 0$.\n10. Iterate through the layers again. For each layer $i$, check if $\\theta_{v,i+1}  \\theta_{v,i}$. If true, increment $n_{\\text{unstable}}$.\n11. Assemble the three computed values $[\\Delta z_{\\text{total}}, T_{v,\\text{avg}}, n_{\\text{unstable}}]$ as the result for the test case.\n12. After processing all test cases, format the collected results into the specified string format.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and implements methods to compute atmospheric column diagnostics.\n    \"\"\"\n    # Physical Constants in SI units\n    R_d = 287.0  # J kg^-1 K^-1\n    c_p = 1004.0 # J kg^-1 K^-1\n    g = 9.80665 # m s^-2\n    p_ref = 100000.0 # Pa\n    kappa = R_d / c_p\n\n    # Test cases data\n    test_cases_data = [\n        {\n            \"id\": \"A\",\n            \"p\": np.array([100000, 90000, 80000, 70000, 60000, 50000]), # Pa\n            \"T\": np.array([290, 284, 278, 272, 266, 260]), # K\n            \"r\": np.array([0.012, 0.010, 0.008, 0.006, 0.004, 0.002]) # kg/kg\n        },\n        {\n            \"id\": \"B\",\n            \"p\": np.array([100000, 90000, 80000, 70000, 60000, 50000]), # Pa\n            \"T\": np.array([280, 280, 280, 280, 280, 280]), # K\n            \"r\": np.array([0.004, 0.004, 0.004, 0.004, 0.004, 0.004]) # kg/kg\n        },\n        {\n            \"id\": \"C\",\n            \"p\": np.array([100000, 90000, 80000, 70000, 60000, 50000]), # Pa\n            \"theta_const\": 300.0, # K\n            \"r\": np.zeros(6) # kg/kg\n        },\n        {\n            \"id\": \"D\",\n            \"p\": np.array([100000, 90000, 80000, 70000, 60000, 50000]), # Pa\n            \"T\": np.array([305, 294, 286, 278, 270, 262]), # K\n            \"r\": np.array([0.014, 0.012, 0.010, 0.006, 0.003, 0.001]) # kg/kg\n        }\n    ]\n\n    def calculate_profile_diagnostics(p, T, r):\n        \"\"\"\n        Computes total thickness, average virtual temperature, and unstable layer count.\n        \n        Args:\n            p (np.array): Pressure levels [Pa].\n            T (np.array): Temperature levels [K].\n            r (np.array): Mixing ratio levels [kg/kg].\n\n        Returns:\n            tuple: (total_thickness, avg_virtual_temp, unstable_layers_count)\n        \"\"\"\n        # 1. Calculate virtual temperature at each level\n        Tv = T * (1 + 0.61 * r)\n        \n        # 2. Compute geometric heights and total thickness\n        heights = np.zeros_like(p, dtype=float)\n        heights[0] = 0.0\n        \n        for i in range(len(p) - 1):\n            p_i, p_i_plus_1 = p[i], p[i+1]\n            Tv_i, Tv_i_plus_1 = Tv[i], Tv[i+1]\n            \n            # Layer-mean virtual temperature\n            Tv_bar = (Tv_i + Tv_i_plus_1) / 2.0\n            \n            # Hypsometric equation for layer thickness\n            delta_z = (R_d * Tv_bar / g) * np.log(p_i / p_i_plus_1)\n            \n            heights[i+1] = heights[i] + delta_z\n            \n        total_thickness = heights[-1]\n        \n        # 3. Compute column-average virtual temperature\n        p0, p_final = p[0], p[-1]\n        avg_virtual_temp = (g * total_thickness) / (R_d * np.log(p0 / p_final))\n        \n        # 4. Compute virtual potential temperature and count unstable layers\n        theta = T * (p_ref / p)**kappa\n        theta_v = theta * (1 + 0.61 * r)\n        \n        unstable_layers_count = 0\n        for i in range(len(p) - 1):\n            if theta_v[i+1]  theta_v[i]:\n                unstable_layers_count += 1\n        \n        return total_thickness, avg_virtual_temp, unstable_layers_count\n\n    results = []\n    for case in test_cases_data:\n        p = case[\"p\"]\n        r = case[\"r\"]\n        \n        if \"theta_const\" in case:\n            # For Case C, calculate T from constant theta\n            T = case[\"theta_const\"] * (p / p_ref)**kappa\n        else:\n            T = case[\"T\"]\n            \n        dz, Tv_avg, n_unstable = calculate_profile_diagnostics(p, T, r)\n        results.append([dz, Tv_avg, n_unstable])\n\n    # Format the final output string exactly as required\n    output_parts = [f\"[{res[0]},{res[1]},{res[2]}]\" for res in results]\n    final_string = f\"[{','.join(output_parts)}]\"\n    print(final_string)\n\nsolve()\n```"
        }
    ]
}