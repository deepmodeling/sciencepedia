{
    "hands_on_practices": [
        {
            "introduction": "要理解对流，我们首先必须理解浮力，而浮力的本质是密度差异。在实践中，我们可以使用虚温（$T_v$）这一关键工具来量化水汽如何使空气密度降低，从而比周围的干空气更轻。本练习将通过从第一性原理（理想气体定律和道尔顿分压定律）推导虚温，并将其应用于实际计算中，来巩固您对这一核心概念的理解 。",
            "id": "4104672",
            "problem": "一个近地表的大气模式网格单元从热力学图解中诊断出其气压 $p = 9.0 \\times 10^{4}\\,\\mathrm{Pa}$，温度 $T = 2.9815 \\times 10^{2}\\,\\mathrm{K}$，相对于液态水的相对湿度 (RH) 为 $\\mathrm{RH} = 0.65$。假设没有凝结水（云液态水和冰可忽略不计），混合物遵循道尔顿分压定律，且各组分遵循理想气体定律，液态水上的饱和水汽压满足克劳修斯–克拉佩龙关系，且汽化潜热与温度无关。湿空气的虚温 $T_{v}$ 定义为在相同气压下，与湿空气混合物具有相同密度的干空气的温度。\n\n仅使用基本定律和核心定义（道尔顿定律、理想气体定律和克劳修斯–克拉佩龙关系），推导一个用 $p$、$T$ 和水汽压 $e$ 表示 $T_{v}$ 的表达式，并计算在给定条件下的 $T_{v}$ 值。对于克劳修斯–克拉佩龙关系，使用其积分形式，其中参考饱和水汽压为 $e_{0} = 6.11 \\times 10^{2}\\,\\mathrm{Pa}$（在 $T_{0} = 2.7315 \\times 10^{2}\\,\\mathrm{K}$ 时），汽化潜热为 $L_{v} = 2.50 \\times 10^{6}\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}$。取干空气和水蒸气的比气体常数分别为 $R_{d} = 2.8704 \\times 10^{2}\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$ 和 $R_{v} = 4.615 \\times 10^{2}\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$。\n\n将您的最终数值答案四舍五入至四位有效数字。以 $\\mathrm{K}$ 为单位表示最终温度。",
            "solution": "1.  **问题验证部分**。\n    *   列出给定条件。\n    *   根据标准说明问题是有效的。\n2.  **求解部分**。\n    *   **第1部分：$T_v$ 表达式的推导**。\n        *   从包含密度的 $T_v$ 定义开始。\n        *   $\\rho_{\\text{moist}} = \\rho_{\\text{dry}}'$，其中 $\\rho_{\\text{dry}}'$ 是在温度 $T_v$ 下的密度。\n        *   使用道尔顿定律和各组分（干空气和水蒸气）的理想气体定律表示 $\\rho_{\\text{moist}}$。\n        *   $\\rho_{\\text{moist}} = \\rho_d + \\rho_v = \\frac{p_d}{R_d T} + \\frac{e}{R_v T}$。\n        *   使用 $p_d = p - e$。\n        *   $\\rho_{\\text{moist}} = \\frac{p-e}{R_d T} + \\frac{e}{R_v T}$。\n        *   使用理想气体定律表示 $\\rho_{\\text{dry}}'$：$\\rho_{\\text{dry}}' = \\frac{p}{R_d T_v}$。\n        *   将两者相等并求解 $T_v$。\n        *   $T_v = T \\left(1 - \\frac{e}{p}\\left(1 - \\frac{R_d}{R_v}\\right)\\right)^{-1}$。说明此为推导出的表达式。\n    *   **第2部分：$T_v$ 数值的计算**。\n        *   步骤 A：使用积分形式的克劳修斯–克拉佩龙方程计算饱和水汽压 $e_s(T)$。\n            *   写下方程：$e_s(T) = e_0 \\exp\\left[ \\frac{L_v}{R_v} \\left( \\frac{1}{T_0} - \\frac{1}{T} \\right) \\right]$。\n            *   代入 $e_0, L_v, R_v, T_0, T$ 的值并计算 $e_s(T)$。\n        *   步骤 B：计算实际水汽压 $e$。\n            *   使用相对湿度的定义：$e = \\mathrm{RH} \\times e_s(T)$。\n            *   代入 $\\mathrm{RH}$ 和计算出的 $e_s(T)$ 的值。\n        *   步骤 C：计算虚温 $T_v$。\n            *   使用推导出的 $T_v$ 表达式。\n            *   代入 $T, p, e, R_d, R_v$ 的值。\n            *   执行最终计算并将结果四舍五入至四位有效数字。",
            "answer": "$$\\boxed{300.8}$$"
        },
        {
            "introduction": "一旦我们理解了某一点的空气密度，我们就可以构建整个大气柱的模型，并分析其稳定性。本练习通过斜高方程将热力学与大气的垂直结构联系起来，该方程是大气建模的基石 。此外，本练习还引入了布伦特-维萨拉频率（Brunt–Väisälä frequency）作为衡量大气静态稳定性的严谨指标，将静态属性与动态趋势联系起来。通过这个编码练习，您将获得建立和分析一维大气模型的实践经验。",
            "id": "4104675",
            "problem": "您将推导并实现一个程序，该程序使用静力平衡关系和测高关系来计算离散大气柱的几何高度和对流稳定性诊断，并通过 Brunt–Väisälä 频率将公式与对流指数联系起来。推导必须从基本定律和经过充分检验的公式开始，并且实现必须与这些原理保持一致。\n\n给定一组测试用例，每个用例包含压力、温度和水汽混合比的垂直廓线。您的任务是：\n\n- 从第一性原理推导用于从压力和虚温计算几何层厚度的表达式，不使用任何预先提供的“快捷”公式。\n- 推导作为对流稳定性度量的 Brunt–Väisälä 频率平方的定义和离散近似，使用静力平衡关系将压力转换为高度。\n- 实现一个程序，为每个测试用例计算以下量：\n  1. 第一个和最后一个压力层之间的总几何厚度，单位为米。\n  2. 通过对整个气柱的测高关系式进行代数反演得到的整层平均虚温，单位为开尔文。\n  3. 对流不稳定层的数量，定义为 Brunt–Väisälä 频率平方为负的层。\n\n在国际单位制（SI）下，使用以下基于物理的常数：干空气比气体常数 $R_d = 287\\ \\mathrm{J\\,kg^{-1}\\,K^{-1}}$，定压比热 $c_p = 1004\\ \\mathrm{J\\,kg^{-1}\\,K^{-1}}$，重力加速度 $g = 9.80665\\ \\mathrm{m\\,s^{-2}}$，以及参考压力 $p_{\\mathrm{ref}} = 100000\\ \\mathrm{Pa}$。使用虚温的近似公式 $T_v = T\\,(1 + 0.61\\,r)$，其中 $T$ 是以开尔文为单位的温度，$r$ 是以 $\\mathrm{kg\\,kg^{-1}}$ 为单位的水汽混合比。用 $\\theta = T\\,(p_{\\mathrm{ref}}/p)^{\\kappa}$ 定义位温，其中 $\\kappa = R_d/c_p$。\n\n对于每个测试用例，您将收到以帕斯卡为单位的压力数组 $p_i$、以开尔文为单位的温度数组 $T_i$ 和以 $\\mathrm{kg\\,kg^{-1}}$ 为单位的混合比数组 $r_i$，这些数组从地表到高层排序，压力严格递减。您必须：\n\n- 将第一个（地表）层级的几何高度设置为 $z_0 = 0\\ \\mathrm{m}$。\n- 使用以层平均虚温计算的测高积分来计算层厚度。累加得到所有层级的高度 $z_i$。\n- 计算每个层级的位温。\n- 使用基于层差的一致离散近似计算每层的 Brunt–Väisälä 频率平方。\n- 将 Brunt–Väisälä 频率平方为负的层计数为对流不稳定层。\n\n以 $\\mathrm{m}$ 表示最终的几何厚度，以 $\\mathrm{K}$ 表示整层平均虚温。题目不涉及角度。如果您在内部计算百分比，必须以小数或分数形式输出，但此处未要求输出百分比。\n\n提供以下四个测试用例：\n\n- 测试用例 A（典型的中纬度对流层片段）：\n  - 压力层级 $[\\,100000,\\ 90000,\\ 80000,\\ 70000,\\ 60000,\\ 50000\\,]$，单位为 $\\mathrm{Pa}$。\n  - 温度廓线 $[\\,290,\\ 284,\\ 278,\\ 272,\\ 266,\\ 260\\,]$，单位为 $\\mathrm{K}$。\n  - 混合比廓线 $[\\,0.012,\\ 0.010,\\ 0.008,\\ 0.006,\\ 0.004,\\ 0.002\\,]$，单位为 $\\mathrm{kg\\,kg^{-1}}$。\n\n- 测试用例 B（等温、弱湿润气柱）：\n  - 压力层级 $[\\,100000,\\ 90000,\\ 80000,\\ 70000,\\ 60000,\\ 50000\\,]$，单位为 $\\mathrm{Pa}$。\n  - 温度廓线 $[\\,280,\\ 280,\\ 280,\\ 280,\\ 280,\\ 280\\,]$，单位为 $\\mathrm{K}$。\n  - 混合比廓线 $[\\,0.004,\\ 0.004,\\ 0.004,\\ 0.004,\\ 0.004,\\ 0.004\\,]$，单位为 $\\mathrm{kg\\,kg^{-1}}$。\n\n- 测试用例 C（位温恒定的干绝热气柱）：\n  - 压力层级 $[\\,100000,\\ 90000,\\ 80000,\\ 70000,\\ 60000,\\ 50000\\,]$，单位为 $\\mathrm{Pa}$。\n  - 位温恒定为 $[\\,300,\\ 300,\\ 300,\\ 300,\\ 300,\\ 300\\,]$，单位为 $\\mathrm{K}$；使用 $\\theta = T\\,(p_{\\mathrm{ref}}/p)^{\\kappa}$（其中 $\\kappa = R_d/c_p$）计算相应的温度廓线，并在所有层级取 $r = 0$。\n\n- 测试用例 D（指示对流不稳定性的低层超绝热层）：\n  - 压力层级 $[\\,100000,\\ 90000,\\ 80000,\\ 70000,\\ 60000,\\ 50000\\,]$，单位为 $\\mathrm{Pa}$。\n  - 温度廓线 $[\\,305,\\ 294,\\ 286,\\ 278,\\ 270,\\ 262\\,]$，单位为 $\\mathrm{K}$。\n  - 混合比廓线 $[\\,0.014,\\ 0.012,\\ 0.010,\\ 0.006,\\ 0.003,\\ 0.001\\,]$，单位为 $\\mathrm{kg\\,kg^{-1}}$。\n\n您的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每个测试用例的结果报告为一个三元列表 $[\\,\\Delta z,\\ T_{v,\\mathrm{avg}},\\ n_{\\mathrm{unstable}}\\,]$，其中 $\\Delta z$ 是总几何厚度（单位为 $\\mathrm{m}$），$T_{v,\\mathrm{avg}}$ 是整层平均虚温（单位为 $\\mathrm{K}$），$n_{\\mathrm{unstable}}$ 是不稳定层的整数计数。例如，总输出应类似于 $[[\\ldots],[\\ldots],[\\ldots],[\\ldots]]$，列表内没有空格。\n\n您的实现必须是一个完整的、可运行的程序，如最终答案部分所述。",
            "solution": "该问题是有效的，因为它科学上基于大气热力学的既定原理，提法明确，数据充分，目标清晰，并以精确、客观的语言表述。所有常数和控制方程都是该领域的标准。提供的测试用例在物理上是合理的，用于在不同条件下测试推导出的算法。该问题可以形式化，并且需要进行不平凡的推导和实现，使其成为一项实质性的任务。\n\n解决方案分为两部分：首先，从第一性原理推导必要的物理和数学关系；其次，描述用于数值实现这些关系的算法。\n\n### 物理关系的推导\n\n**1. 几何层厚度（测高公式）**\n\n大气中压力和高度之间的关系由静力平衡方程决定，该方程平衡了静止流体微团上的垂直气压梯度力和重力：\n$$\n\\frac{dp}{dz} = -\\rho g\n$$\n其中 $p$ 是压力，$z$ 是几何高度，$\\rho$ 是空气密度，$g$ 是重力加速度。\n\n湿空气的密度可以使用理想气体定律表示，并通过虚温 $T_v$ 进行修正，以考虑湿空气相对于干空气平均分子量较低的情况：\n$$\np = \\rho R_d T_v\n$$\n其中 $R_d$ 是干空气的比气体常数。问题提供了虚温的近似公式 $T_v = T(1 + 0.61r)$，其中 $T$ 是空气温度，$r$ 是水汽混合比。\n\n求解密度 $\\rho = p / (R_d T_v)$ 并代入静力平衡方程，得到：\n$$\n\\frac{dp}{dz} = -\\frac{p g}{R_d T_v}\n$$\n这是一个关联压力和高度的微分方程。为了求出一层的厚度，我们可以分离变量并积分：\n$$\ndz = -\\frac{R_d T_v}{g} \\frac{dp}{p}\n$$\n将此方程在两个压力层 $p_1$（较低）和 $p_2$（较高）之间积分，对应高度为 $z_1$ 和 $z_2$，得出层厚度 $\\Delta z = z_2 - z_1$：\n$$\n\\int_{z_1}^{z_2} dz = \\Delta z = -\\frac{R_d}{g} \\int_{p_1}^{p_2} \\frac{T_v}{p} dp = \\frac{R_d}{g} \\int_{p_2}^{p_1} \\frac{T_v}{p} dp\n$$\n为了计算这个积分，我们假设虚温在层内随 $\\ln(p)$ 线性变化，这允许我们用其层平均值 $\\bar{T}_v$ 来代替 $T_v$。问题指定使用层边界处虚温的算术平均值：\n$$\n\\bar{T}_v = \\frac{T_{v,1} + T_{v,2}}{2}\n$$\n通过这个近似，积分变为：\n$$\n\\Delta z = \\frac{R_d \\bar{T}_v}{g} \\int_{p_2}^{p_1} \\frac{dp}{p} = \\frac{R_d \\bar{T}_v}{g} [\\ln(p)]_{p_2}^{p_1}\n$$\n这就得到了用于计算层厚的测高公式：\n$$\n\\Delta z = \\frac{R_d \\bar{T}_v}{g} \\ln\\left(\\frac{p_1}{p_2}\\right)\n$$\n该方程将用于计算大气廓线中每个离散层的厚度。总几何厚度是这些单个层厚度的总和。\n\n**2. 整层平均虚温**\n\n测高公式可以应用于从地表（层级 0）到顶部（层级 N-1）的整个大气柱。总几何厚度 $\\Delta z_{\\text{total}} = z_{N-1} - z_0$ 与单个整层平均虚温 $T_{v,\\text{avg}}$ 的关系为：\n$$\n\\Delta z_{\\text{total}} = \\frac{R_d T_{v,\\text{avg}}}{g} \\ln\\left(\\frac{p_0}{p_{N-1}}\\right)\n$$\n问题要求通过对该关系式进行代数反演来计算 $T_{v,\\text{avg}}$。求解 $T_{v,\\text{avg}}$ 得：\n$$\nT_{v,\\text{avg}} = \\frac{g \\, \\Delta z_{\\text{total}}}{R_d \\ln(p_0/p_{N-1})}\n$$\n其中 $\\Delta z_{\\text{total}}$ 首先通过对使用上一节方法计算的各层厚度求和得到。\n\n**3. Brunt–Väisälä 频率与对流稳定性**\n\nBrunt–Väisälä 频率 $N$ 量化了流体柱的静力稳定性。其平方 $N^2$ 表示垂直位移的流体微团单位位移所受的恢复加速度。考虑一个气块向上绝热位移（即其位温保持不变）一小段距离 $\\delta z$。作用在气块上单位质量的净浮力近似为 $g(\\rho_e - \\rho_p)/\\rho_p$，其中下标 $e$ 和 $p$ 分别表示环境和气块。这可以用虚位温 $\\theta_v$ 来表示，虚位温是如果一个气块中所有的水分都凝结并移除，潜热加热气块后它所具有的位温。对于绝热位移，气块的 $\\theta_v$ 是守恒的。在高度 $z + \\delta z$ 处的环境 $\\theta_v$ 近似为 $\\theta_{v,e}(z) + (d\\theta_{v,e}/dz) \\delta z$。浮力导致气块垂直位移的运动方程为：\n$$\n\\frac{d^2(\\delta z)}{dt^2} = -\\left(\\frac{g}{\\theta_{v,e}} \\frac{d\\theta_{v,e}}{dz}\\right) \\delta z\n$$\n这是一个简谐运动方程，其中角频率的平方是括号中的项。因此，我们将 Brunt–Väisälä 频率的平方定义为：\n$$\nN^2 = \\frac{g}{\\theta_v} \\frac{d\\theta_v}{dz}\n$$\n虚位温 $\\theta_v$ 由 $\\theta_v = T_v (p_{\\text{ref}}/p)^{\\kappa} = \\theta(1+0.61r)$ 给出，其中 $\\theta = T(p_{\\text{ref}}/p)^{\\kappa}$ 是位温，$\\kappa = R_d/c_p$。\n- 如果 $N^2 > 0$，即 $(d\\theta_v/dz > 0)$，一个位移的气块会受到一个恢复力，导致振荡。大气是静力稳定的。\n- 如果 $N^2 = 0$，即 $(d\\theta_v/dz = 0)$，一个位移的气块不受净力作用。大气是中性稳定的。\n- 如果 $N^2  0$，即 $(d\\theta_v/dz  0)$，一个位移的气块会受到一个使其进一步偏离原始位置的力。大气是对流不稳定的。\n\n对于离散的大气廓线，我们使用有限差分来近似计算层级 $i$（较低）和 $i+1$（较高）之间的层的 $N^2$。导数 $d\\theta_v/dz$ 近似为 $\\Delta\\theta_v/\\Delta z = (\\theta_{v,i+1} - \\theta_{v,i})/(z_{i+1} - z_i)$，而 $\\theta_v$ 则用层平均值 $\\bar{\\theta}_v = (\\theta_{v,i} + \\theta_{v,i+1})/2$ 来近似。\n$$\nN^2_i \\approx \\frac{g}{\\bar{\\theta}_{v,i}} \\frac{\\Delta\\theta_{v,i}}{\\Delta z_i} = \\frac{2g}{\\theta_{v,i} + \\theta_{v,i+1}} \\frac{\\theta_{v,i+1} - \\theta_{v,i}}{z_{i+1} - z_i}\n$$\n由于 $g$、$\\bar{\\theta}_v$（单位为开尔文）和 $\\Delta z$ 始终为正，因此 $N^2_i$ 的符号仅由 $\\theta_{v,i+1} - \\theta_{v,i}$ 的符号决定。因此，当且仅当一个层的虚位温随高度减小时，该层是对流不稳定的：\n$$\n\\text{不稳定层条件: } \\theta_{v,i+1}  \\theta_{v,i}\n$$\n\n### 数值实现算法\n\n每个测试用例的总体算法如下：\n1.  定义物理常数：$R_d = 287$，$c_p = 1004$，$g = 9.80665$，$p_{\\text{ref}} = 100000$。计算 $\\kappa = R_d/c_p$。\n2.  对于每个测试用例，获取压力 $p_i$、温度 $T_i$ 和混合比 $r_i$ 的输入数组。对于用例 C，首先根据给定的恒定位温，使用 $T_i = \\theta_i (p_i/p_{\\text{ref}})^{\\kappa}$ 计算温度廓线。\n3.  计算每个层级 $i$ 的虚温 $T_{v,i} = T_i(1 + 0.61r_i)$。\n4.  初始化一个高度数组，令 $z_0 = 0$。\n5.  从 $i = 0$ 到倒数第二个层级遍历大气层：\n    a. 计算层平均虚温 $\\bar{T}_{v,i} = (T_{v,i} + T_{v,i+1})/2$。\n    b. 计算层厚度 $\\Delta z_i = \\frac{R_d \\bar{T}_{v,i}}{g} \\ln(p_i/p_{i+1})$。\n    c. 计算下一层级的高度 $z_{i+1} = z_i + \\Delta z_i$ 并存储。\n6.  总几何厚度 $\\Delta z_{\\text{total}}$ 是最终计算出的高度 $z_{N-1}$。\n7.  计算整层平均虚温 $T_{v,\\text{avg}} = \\frac{g \\, \\Delta z_{\\text{total}}}{R_d \\ln(p_0/p_{N-1})}$。\n8.  计算所有层级的位温 $\\theta_i = T_i (p_{\\text{ref}}/p_i)^{\\kappa}$，然后计算虚位温 $\\theta_{v,i} = \\theta_i(1+0.61r_i)$。\n9.  初始化不稳定层计数器 $n_{\\text{unstable}} = 0$。\n10. 再次遍历各层。对于每层 $i$，检查是否 $\\theta_{v,i+1}  \\theta_{v,i}$。如果为真，则将 $n_{\\text{unstable}}$ 加一。\n11. 将计算出的三个值 $[\\Delta z_{\\text{total}}, T_{v,\\text{avg}}, n_{\\text{unstable}}]$ 组合为该测试用例的结果。\n12. 处理完所有测试用例后，将收集到的结果格式化为指定的字符串格式。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and implements methods to compute atmospheric column diagnostics.\n    \"\"\"\n    # Physical Constants in SI units\n    R_d = 287.0  # J kg^-1 K^-1\n    c_p = 1004.0 # J kg^-1 K^-1\n    g = 9.80665 # m s^-2\n    p_ref = 100000.0 # Pa\n    kappa = R_d / c_p\n\n    # Test cases data\n    test_cases_data = [\n        {\n            \"id\": \"A\",\n            \"p\": np.array([100000, 90000, 80000, 70000, 60000, 50000]), # Pa\n            \"T\": np.array([290, 284, 278, 272, 266, 260]), # K\n            \"r\": np.array([0.012, 0.010, 0.008, 0.006, 0.004, 0.002]) # kg/kg\n        },\n        {\n            \"id\": \"B\",\n            \"p\": np.array([100000, 90000, 80000, 70000, 60000, 50000]), # Pa\n            \"T\": np.array([280, 280, 280, 280, 280, 280]), # K\n            \"r\": np.array([0.004, 0.004, 0.004, 0.004, 0.004, 0.004]) # kg/kg\n        },\n        {\n            \"id\": \"C\",\n            \"p\": np.array([100000, 90000, 80000, 70000, 60000, 50000]), # Pa\n            \"theta_const\": 300.0, # K\n            \"r\": np.zeros(6) # kg/kg\n        },\n        {\n            \"id\": \"D\",\n            \"p\": np.array([100000, 90000, 80000, 70000, 60000, 50000]), # Pa\n            \"T\": np.array([305, 294, 286, 278, 270, 262]), # K\n            \"r\": np.array([0.014, 0.012, 0.010, 0.006, 0.003, 0.001]) # kg/kg\n        }\n    ]\n\n    def calculate_profile_diagnostics(p, T, r):\n        \"\"\"\n        Computes total thickness, average virtual temperature, and unstable layer count.\n        \n        Args:\n            p (np.array): Pressure levels [Pa].\n            T (np.array): Temperature levels [K].\n            r (np.array): Mixing ratio levels [kg/kg].\n\n        Returns:\n            tuple: (total_thickness, avg_virtual_temp, unstable_layers_count)\n        \"\"\"\n        # 1. Calculate virtual temperature at each level\n        Tv = T * (1 + 0.61 * r)\n        \n        # 2. Compute geometric heights and total thickness\n        heights = np.zeros_like(p, dtype=float)\n        heights[0] = 0.0\n        \n        for i in range(len(p) - 1):\n            p_i, p_i_plus_1 = p[i], p[i+1]\n            Tv_i, Tv_i_plus_1 = Tv[i], Tv[i+1]\n            \n            # Layer-mean virtual temperature\n            Tv_bar = (Tv_i + Tv_i_plus_1) / 2.0\n            \n            # Hypsometric equation for layer thickness\n            delta_z = (R_d * Tv_bar / g) * np.log(p_i / p_i_plus_1)\n            \n            heights[i+1] = heights[i] + delta_z\n            \n        total_thickness = heights[-1]\n        \n        # 3. Compute column-average virtual temperature\n        p0, p_final = p[0], p[-1]\n        avg_virtual_temp = (g * total_thickness) / (R_d * np.log(p0 / p_final))\n        \n        # 4. Compute virtual potential temperature and count unstable layers\n        theta = T * (p_ref / p)**kappa\n        theta_v = theta * (1 + 0.61 * r)\n        \n        unstable_layers_count = 0\n        for i in range(len(p) - 1):\n            if theta_v[i+1]  theta_v[i]:\n                unstable_layers_count += 1\n        \n        return total_thickness, avg_virtual_temp, unstable_layers_count\n\n    results = []\n    for case in test_cases_data:\n        p = case[\"p\"]\n        r = case[\"r\"]\n        \n        if \"theta_const\" in case:\n            # For Case C, calculate T from constant theta\n            T = case[\"theta_const\"] * (p / p_ref)**kappa\n        else:\n            T = case[\"T\"]\n            \n        dz, Tv_avg, n_unstable = calculate_profile_diagnostics(p, T, r)\n        results.append([dz, Tv_avg, n_unstable])\n\n    # Format the final output string exactly as required\n    output_parts = [f\"[{res[0]},{res[1]},{res[2]}]\" for res in results]\n    final_string = f\"[{','.join(output_parts)}]\"\n    print(final_string)\n\nsolve()\n```"
        },
        {
            "introduction": "真实世界中的对流通常伴随着云的形成，其中液态水和冰的重量（即凝结物负荷）对空气的有效密度有显著影响。本练习从虚温的概念出发，进一步介绍更普适的密度温度（$T_{\\rho}$），它将凝结物负荷考虑在内。通过推导密度温度并计算真实的浮力加速度，您将接触到现代天气和气候模型中用于预测对流上升气流强度的核心物理过程 。",
            "id": "4104684",
            "problem": "考虑一个包含干空气、水汽、液态水和冰的湿空气块。设 $p$ 为气块压力（单位为 $\\mathrm{Pa}$），$T$ 为气块温度（单位为 $\\mathrm{K}$），$r_v$ 为水汽混合比（水汽质量与干空气质量之比，单位为 $\\mathrm{kg/kg}$），$r_l$ 为液态水混合比（单位为 $\\mathrm{kg/kg}$），$r_i$ 为冰混合比（单位为 $\\mathrm{kg/kg}$）。设 $R_d$ 为干空气的比气体常数（单位为 $\\mathrm{J\\,kg^{-1}\\,K^{-1}}$），$R_v$ 为水汽的比气体常数（单位为 $\\mathrm{J\\,kg^{-1}\\,K^{-1}}$）。定义 $\\varepsilon = R_d / R_v$。取重力加速度 $g$（单位为 $\\mathrm{m\\,s^{-2}}$）。\n\n基本原理：\n- 气体组分的理想气体定律（IGL）为 $p_x = \\rho_x R_x T$，其中 $p_x$ 是分压，$\\rho_x$ 是密度，$R_x$ 是组分 $x$ 的比气体常数。\n- 道尔顿分压定律指出 $p = p_d + p_v$，其中下标 $d$ 和 $v$ 分别表示干空气和水汽。\n- 混合比的定义为 $r_x = m_x / m_d$，其中 $m_x$ 是组分 $x$ 的质量，$m_d$ 是气块中干空气的质量。\n- 虚温是指在相同压力下，要达到与湿润气体混合物相同的气相密度，干空气所需具有的温度。\n- 密度温度是指在相同压力下，要达到与真实气块相同的总密度（包括液态水和冰的凝结物负载），干空气所需具有的温度。\n\n任务：\n1. 仅从列出的基本原理出发，推导气块虚温 $T_v$ 和密度温度 $T_{\\rho}$ 的精确表达式，用 $T$、$r_v$、$r_l$、$r_i$ 和 $\\varepsilon$ 表示。您的推导必须基于基本原理，不得引用任何简化公式。\n2. 使用关于 $r_v = 0$，$r_l = 0$ 和 $r_i = 0$ 的一阶泰勒展开，得到 $T_{\\rho}$ 在混合比主导阶下的线性近似。\n3. 对于一个以压力 $p$（与气块相同）、温度 $T_{\\mathrm{env}}$（单位为 $\\mathrm{K}$）和水汽混合比 $r_{v,\\mathrm{env}}$（单位为 $\\mathrm{kg/kg}$）为特征的环境状态，使用相同的物理原理计算环境虚温 $T_{v,\\mathrm{env}}$。假设环境中的凝结物可忽略不计，即 $r_{l,\\mathrm{env}} = r_{i,\\mathrm{env}} = 0$。\n4. 使用密度温度近似计算气块的浮力加速度 $B$，其定义为\n$$\nB = g \\frac{T_{\\rho} - T_{v,\\mathrm{env}}}{T_{v,\\mathrm{env}}},\n$$\n以 $\\mathrm{m\\,s^{-2}}$ 为单位表示。\n5. 对于下面指定的每个测试用例，计算：\n   - 精确的虚温 $T_v$，单位为 $\\mathrm{K}$。\n   - 精确的密度温度 $T_{\\rho}$，单位为 $\\mathrm{K}$。\n   - 精确的 $T_{\\rho}$ 与其在第2步中得到的一阶线性近似之间的绝对差，单位为 $\\mathrm{K}$。\n   - 浮力加速度 $B$，单位为 $\\mathrm{m\\,s^{-2}}$。\n   将所有四个输出结果四舍五入到六位小数。\n\n使用的常量：\n- $R_d = 287.05\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$，\n- $R_v = 461.5\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$，\n- $g = 9.80665\\,\\mathrm{m\\,s^{-2}}$。\n\n测试套件（每组参数集为 $(p, T, r_v, r_l, r_i, T_{\\mathrm{env}}, r_{v,\\mathrm{env}})$）：\n- 用例1（一般湿润，轻云）：$(100000, 300, 0.015, 0.001, 0.000, 300, 0.010)$。\n- 用例2（干燥边界）：$(85000, 290, 0.000, 0.000, 0.000, 290, 0.000)$。\n- 用例3（湿润含混合相云）：$(95000, 303, 0.025, 0.002, 0.001, 300, 0.020)$。\n- 用例4（重凝结物，冷气块）：$(90000, 275, 0.010, 0.012, 0.005, 278, 0.008)$。\n- 用例5（暖气块，湿润环境）：$(100000, 310, 0.008, 0.000, 0.000, 305, 0.020)$。\n\n您的程序应生成单行输出，包含一个逗号分隔的列表，列表用方括号括起来。每个测试用例的结果应是一个包含四个浮点数的列表，顺序为 $[T_v, T_{\\rho}, \\Delta, B]$，其中 $\\Delta$ 是精确的 $T_{\\rho}$ 与其线性近似之间的绝对差。例如，整体格式必须是\n$$\n\\big[ [T_{v,1}, T_{\\rho,1}, \\Delta_1, B_1], [T_{v,2}, T_{\\rho,2}, \\Delta_2, B_2], \\dots \\big].\n$$\n所有温度必须以 $\\mathrm{K}$ 为单位，$B$ 必须以 $\\mathrm{m\\,s^{-2}}$ 为单位，每个值都四舍五入到六位小数。",
            "solution": "该问题要求推导湿空气块的虚温和密度温度的表达式，对密度温度进行线性化，并计算浮力。然后必须为一系列测试用例计算这些量。推导将从所提供的基本原理出发。\n\n设气块总压力为 $p$，温度为 $T$，水汽混合比为 $r_v$，液态水混合比为 $r_l$，冰混合比为 $r_i$。干空气和水汽的比气体常数分别为 $R_d$ 和 $R_v$，其中 $\\varepsilon = R_d/R_v$。重力加速度为 $g$。\n\n**1. 虚温 ($T_v$) 的推导**\n\n虚温 $T_v$ 定义为：在相同压力 $p$ 下，一个纯干空气块要达到与湿空气气相部分相同的密度时所需具有的温度。\n\n湿空气块气相的密度 $\\rho_{\\text{gas}}$ 是干空气密度 $\\rho_d$ 和水汽密度 $\\rho_v$ 的和：\n$$\n\\rho_{\\text{gas}} = \\rho_d + \\rho_v\n$$\n根据混合比的定义，$r_v = m_v/m_d$，其中 $m_v$ 和 $m_d$ 是给定体积 $V$ 中水汽和干空气的质量。因此，$\\rho_v = m_v/V$ 且 $\\rho_d = m_d/V$，这意味着 $r_v = \\rho_v/\\rho_d$。因此，$\\rho_{\\text{gas}} = \\rho_d(1+r_v)$。\n\n根据道尔顿定律，总压力 $p$ 是干空气分压 ($p_d$) 和水汽分压 ($p_v$) 的和：$p = p_d + p_v$。\n使用理想气体定律（IGL），$p_d = \\rho_d R_d T$ 且 $p_v = \\rho_v R_v T$。\n我们可以用分压来表示混合比：\n$$\nr_v = \\frac{\\rho_v}{\\rho_d} = \\frac{p_v / (R_v T)}{p_d / (R_d T)} = \\frac{p_v}{p_d} \\frac{R_d}{R_v} = \\varepsilon \\frac{p_v}{p_d}\n$$\n由此，$p_v = p_d \\frac{r_v}{\\varepsilon}$。将其代入道尔顿定律：\n$$\np = p_d + p_d \\frac{r_v}{\\varepsilon} = p_d \\left(1 + \\frac{r_v}{\\varepsilon}\\right)\n$$\n这使我们能够用总压力 $p$ 来表示 $p_d$：\n$$\np_d = \\frac{p}{1 + r_v/\\varepsilon}\n$$\n现在，我们使用IGL和上述 $p_d$ 的关系式来表示 $\\rho_d$：\n$$\n\\rho_d = \\frac{p_d}{R_d T} = \\frac{p}{R_d T (1 + r_v/\\varepsilon)}\n$$\n总的气体密度为：\n$$\n\\rho_{\\text{gas}} = \\rho_d(1+r_v) = \\frac{p(1+r_v)}{R_d T (1 + r_v/\\varepsilon)}\n$$\n根据定义，一个温度为 $T_v$、压力为 $p$ 的干空气块的密度为 $\\rho_{\\text{dry}} = p / (R_d T_v)$。将此与 $\\rho_{\\text{gas}}$ 相等：\n$$\n\\frac{p}{R_d T_v} = \\frac{p(1+r_v)}{R_d T (1 + r_v/\\varepsilon)}\n$$\n求解 $T_v$ 得到虚温的精确表达式：\n$$\nT_v = T \\frac{1 + r_v/\\varepsilon}{1 + r_v}\n$$\n\n**2. 密度温度 ($T_{\\rho}$) 的推导**\n\n密度温度 $T_{\\rho}$ 是指在相同压力 $p$ 下，一个纯干空气块要达到与真实气块（包括气相和凝结相）总密度相同时所需具有的温度。\n\n气块中的总质量是 $m_{\\text{total}} = m_d + m_v + m_l + m_i$。气块的体积 $V$ 由其气体成分决定，因为凝结水的体积可以忽略不计。总密度是：\n$$\n\\rho_{\\text{total}} = \\frac{m_{\\text{total}}}{V} = \\frac{m_d(1 + r_v + r_l + r_i)}{V}\n$$\n使用干空气的理想气体定律，$V = m_d R_d T / p_d$。将此代入密度表达式：\n$$\n\\rho_{\\text{total}} = \\frac{m_d(1 + r_v + r_l + r_i)}{m_d R_d T / p_d} = \\frac{p_d (1 + r_v + r_l + r_i)}{R_d T}\n$$\n使用我们的表达式 $p_d = p / (1 + r_v/\\varepsilon)$：\n$$\n\\rho_{\\text{total}} = \\frac{p}{1 + r_v/\\varepsilon} \\frac{1 + r_v + r_l + r_i}{R_d T} = \\frac{p}{R_d T} \\frac{1 + r_v + r_l + r_i}{1 + r_v/\\varepsilon}\n$$\n根据定义，一个温度为 $T_{\\rho}$、压力为 $p$ 的干空气块的密度为 $\\rho_{\\text{dry}} = p / (R_d T_{\\rho})$。将此与 $\\rho_{\\text{total}}$ 相等：\n$$\n\\frac{p}{R_d T_{\\rho}} = \\frac{p}{R_d T} \\frac{1 + r_v + r_l + r_i}{1 + r_v/\\varepsilon}\n$$\n求解 $T_{\\rho}$ 得到密度温度的精确表达式：\n$$\nT_{\\rho} = T \\frac{1 + r_v/\\varepsilon}{1 + r_v + r_l + r_i}\n$$\n\n**3. 密度温度的线性近似**\n\n我们对 $T_{\\rho}(r_v, r_l, r_i)$ 在点 $(r_v, r_l, r_i) = (0, 0, 0)$ 附近进行一阶多元泰勒展开。\n$$\nT_{\\rho, \\text{linear}} \\approx T_{\\rho}(0,0,0) + r_v \\frac{\\partial T_{\\rho}}{\\partial r_v}\\bigg|_{(0,0,0)} + r_l \\frac{\\partial T_{\\rho}}{\\partial r_l}\\bigg|_{(0,0,0)} + r_i \\frac{\\partial T_{\\rho}}{\\partial r_i}\\bigg|_{(0,0,0)}\n$$\n首先，计算 $T_{\\rho}$ 在 $(0,0,0)$ 处的值：\n$$\nT_{\\rho}(0,0,0) = T \\frac{1 + 0/\\varepsilon}{1 + 0 + 0 + 0} = T\n$$\n接下来，计算偏导数：\n$$\n\\frac{\\partial T_{\\rho}}{\\partial r_v} = T \\frac{\\partial}{\\partial r_v} \\left( \\frac{1+r_v/\\varepsilon}{1 + r_v + r_l + r_i} \\right) = T \\frac{(1/\\varepsilon)(1 + r_v + r_l + r_i) - (1+r_v/\\varepsilon)(1)}{(1 + r_v + r_l + r_i)^2}\n$$\n在 $(0,0,0)$ 处求值：$\\frac{\\partial T_{\\rho}}{\\partial r_v}\\bigg|_{(0,0,0)} = T \\frac{1/\\varepsilon - 1}{1^2} = T(1/\\varepsilon - 1)$。\n$$\n\\frac{\\partial T_{\\rho}}{\\partial r_l} = T (1+r_v/\\varepsilon) \\frac{\\partial}{\\partial r_l} \\left( (1 + r_v + r_l + r_i)^{-1} \\right) = T (1+r_v/\\varepsilon) \\frac{-1}{(1 + r_v + r_l + r_i)^2}\n$$\n在 $(0,0,0)$ 处求值：$\\frac{\\partial T_{\\rho}}{\\partial r_l}\\bigg|_{(0,0,0)} = T(1) \\frac{-1}{1^2} = -T$。\n根据对称性，$\\frac{\\partial T_{\\rho}}{\\partial r_i}\\bigg|_{(0,0,0)} = -T$。\n\n结合这些项，线性近似为：\n$$\nT_{\\rho, \\text{linear}} = T + r_v T(1/\\varepsilon - 1) - r_l T - r_i T = T(1 + r_v(1/\\varepsilon - 1) - r_l - r_i)\n$$\n\n**4. 环境虚温 ($T_{v,\\mathrm{env}}$) 和浮力 ($B$)**\n\n环境虚温 $T_{v,\\mathrm{env}}$ 使用与气块 $T_v$ 相同的公式计算，但使用不同的状态：温度 $T_{\\mathrm{env}}$，水汽混合比 $r_{v,\\mathrm{env}}$，以及可忽略的凝结物 ($r_{l,\\mathrm{env}}=0, r_{i,\\mathrm{env}}=0$)。\n$$\nT_{v,\\mathrm{env}} = T_{\\mathrm{env}} \\frac{1 + r_{v,\\mathrm{env}}/\\varepsilon}{1 + r_{v,\\mathrm{env}}}\n$$\n浮力加速度 $B$ 由以下公式给出：\n$$\nB = g \\frac{T_{\\rho} - T_{v,\\mathrm{env}}}{T_{v,\\mathrm{env}}}\n$$\n在这里，我们使用气块的精确密度温度 $T_{\\rho}$。\n\n**计算总结**\n对于每个测试用例，将计算并报告以下四个量，保留六位小数：\n1.  精确的气块虚温：$T_v = T \\frac{1 + r_v/\\varepsilon}{1 + r_v}$\n2.  精确的气块密度温度：$T_{\\rho} = T \\frac{1 + r_v/\\varepsilon}{1 + r_v + r_l + r_i}$\n3.  与线性近似的绝对差：$\\Delta = |T_{\\rho} - T(1 + r_v(1/\\varepsilon - 1) - r_l - r_i)|$\n4.  浮力加速度：$B = g \\frac{T_{\\rho} - T_{v,\\mathrm{env}}}{T_{v,\\mathrm{env}}}$，其中 $T_{v,\\mathrm{env}} = T_{\\mathrm{env}} \\frac{1 + r_{v,\\mathrm{env}}/\\varepsilon}{1 + r_{v,\\mathrm{env}}}$。\n\n常量为 $R_d = 287.05\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$，$R_v = 461.5\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$，以及 $g = 9.80665\\,\\mathrm{m\\,s^{-2}}$。由此，$\\varepsilon = R_d / R_v \\approx 0.62200433$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the atmospheric thermodynamics problem for a series of test cases.\n    It calculates parcel virtual and density temperatures, compares the exact\n    density temperature to its linearized approximation, and computes the\n    parcel's buoyancy acceleration.\n    \"\"\"\n    \n    # Define constants\n    R_d = 287.05  # J kg^-1 K^-1\n    R_v = 461.5   # J kg^-1 K^-1\n    g = 9.80665   # m s^-2\n    \n    # Epsilon, the ratio of gas constants\n    epsilon = R_d / R_v\n\n    # Define the test cases from the problem statement.\n    # Each case is a tuple: (p, T, r_v, r_l, r_i, T_env, r_v_env)\n    test_cases = [\n        (100000, 300, 0.015, 0.001, 0.000, 300, 0.010),\n        (85000, 290, 0.000, 0.000, 0.000, 290, 0.000),\n        (95000, 303, 0.025, 0.002, 0.001, 300, 0.020),\n        (90000, 275, 0.010, 0.012, 0.005, 278, 0.008),\n        (100000, 310, 0.008, 0.000, 0.000, 305, 0.020),\n    ]\n\n    # This function encapsulates the physics calculations for a single case.\n    def calculate_properties(case, epsilon_val, g_val):\n        \"\"\"\n        Computes the required thermodynamic properties for a single parcel and environment state.\n        \n        Args:\n            case (tuple): A tuple containing the state variables \n                          (p, T, r_v, r_l, r_i, T_env, r_v_env).\n            epsilon_val (float): The ratio R_d / R_v.\n            g_val (float): Gravitational acceleration.\n\n        Returns:\n            tuple: A tuple of four floats (T_v_exact, T_rho_exact, delta, B).\n        \"\"\"\n        # Unpack the case tuple\n        p, T, r_v, r_l, r_i, T_env, r_v_env = case\n        \n        # 1. Exact virtual temperature (Tv)\n        T_v_exact = T * (1.0 + r_v / epsilon_val) / (1.0 + r_v)\n        \n        # 2. Exact density temperature (T_rho)\n        total_mixing_ratio_parcel = r_v + r_l + r_i\n        T_rho_exact = T * (1.0 + r_v / epsilon_val) / (1.0 + total_mixing_ratio_parcel)\n        \n        # 3. Linearized T_rho and the absolute difference (delta)\n        T_rho_linear = T * (1.0 + r_v * (1.0 / epsilon_val - 1.0) - r_l - r_i)\n        delta = abs(T_rho_exact - T_rho_linear)\n        \n        # 4. Buoyancy acceleration (B)\n        # First, compute environment virtual temperature\n        T_v_env = T_env * (1.0 + r_v_env / epsilon_val) / (1.0 + r_v_env)\n        # Then, compute buoyancy\n        B = g_val * (T_rho_exact - T_v_env) / T_v_env\n        \n        return T_v_exact, T_rho_exact, delta, B\n\n    results_as_strings = []\n    for case in test_cases:\n        # Perform calculations for the current case\n        calcs = calculate_properties(case, epsilon, g)\n        \n        # Format the results to 6 decimal places and create a string sublist\n        # e.g., \"[302.694248,302.395760,0.038901,0.019238]\"\n        formatted_sublist = (\n            f\"[{calcs[0]:.6f},\"\n            f\"{calcs[1]:.6f},\"\n            f\"{calcs[2]:.6f},\"\n            f\"{calcs[3]:.6f}]\"\n        )\n        results_as_strings.append(formatted_sublist)\n\n    # Final print statement in the exact required format: [[...],[...],...]\n    print(f\"[{','.join(results_as_strings)}]\")\n\nsolve()\n```"
        }
    ]
}