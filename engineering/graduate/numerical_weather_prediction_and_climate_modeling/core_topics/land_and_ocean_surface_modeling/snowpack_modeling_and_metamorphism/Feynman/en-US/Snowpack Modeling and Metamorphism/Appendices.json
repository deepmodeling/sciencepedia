{
    "hands_on_practices": [
        {
            "introduction": "Understanding the thermal state of a snowpack is fundamental to predicting its evolution. The 'cold content' represents the energy deficit of the snowpack relative to the melting point, acting as a crucial thermal buffer. This practice  guides you through a first-principles calculation of this quantity by integrating simplified, yet illustrative, profiles of snow density and temperature. By determining the maximum amount of meltwater that can refreeze within this cold snow layer, you will gain a quantitative understanding of how the snowpack's internal energy state can delay runoff and influence the surface energy balance.",
            "id": "4089665",
            "problem": "A one-dimensional, stratified snow layer in a numerical weather prediction and climate modeling framework has thickness $H$, density varying linearly with depth $z$ (measured downward from the snow surface), and a linear temperature profile strictly below the melting point. Specifically, for $0 \\leq z \\leq H$, the density is $\\rho(z) = \\rho_{0} + \\gamma z$ and the temperature is $T(z) = T_{0} + \\beta z$, where $T(z)$ is measured in degrees Celsius and $z$ in meters. Assume the density and temperature profiles are given by $\\rho_{0} = 250\\,\\mathrm{kg\\,m^{-3}}$, $\\gamma = 300\\,\\mathrm{kg\\,m^{-4}}$, $T_{0} = -10\\,^{\\circ}\\mathrm{C}$, $\\beta = 12\\,^{\\circ}\\mathrm{C\\,m^{-1}}$, and $H = 0.5\\,\\mathrm{m}$. A pulse of meltwater at $0\\,^{\\circ}\\mathrm{C}$ with total mass per unit area $M_{\\mathrm{in}} = 9.0\\,\\mathrm{kg\\,m^{-2}}$ percolates into the snow. Assume the specific heat capacity of ice is constant, $c_{i} = 2.10 \\times 10^{3}\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$, and the latent heat of fusion of water is $L_{f} = 3.34 \\times 10^{5}\\,\\mathrm{J\\,kg^{-1}}$. Neglect all energy exchanges except the sensible warming of the snow layer and the latent heat release due to refreezing of the meltwater; assume no work is performed and no vapor fluxes, radiation, or conductive exchanges with the atmosphere or ground.\n\nStarting from the First Law of Thermodynamics and core definitions of sensible and latent heat, derive an expression for the cold content $Q_{\\mathrm{cc}}$ (energy per unit area required to raise the entire snow layer to $0\\,^{\\circ}\\mathrm{C}$). Then, under the stated melt input, determine the maximum mass per unit area of meltwater that can refreeze before the snow layer temperature reaches $0\\,^{\\circ}\\mathrm{C}$. Express your final numerical answer for the refrozen meltwater mass per unit area in $\\mathrm{kg\\,m^{-2}}$, and round to four significant figures.",
            "solution": "The appropriate fundamental base is the First Law of Thermodynamics, which states that for a closed system with negligible mechanical work, the change in internal energy is equal to the net heat added. For a snow layer initially below $0\\,^{\\circ}\\mathrm{C}$, the energy required to warm it to the melting point is the integral of sensible heat over the volume:\n$$\nQ_{\\mathrm{cc}} = \\int_{V} \\rho(\\mathbf{x})\\, c_{i}\\, \\Delta T(\\mathbf{x})\\, dV,\n$$\nwhere $\\Delta T(\\mathbf{x})$ is the temperature increase to $0\\,^{\\circ}\\mathrm{C}$, $\\rho$ is density, $c_{i}$ is the specific heat capacity of ice, and the integral is over the snow volume. In a one-dimensional column of unit horizontal area, $dV = dz$, and with $z$ measured from the surface downward to $H$, we have\n$$\nQ_{\\mathrm{cc}} = \\int_{0}^{H} \\rho(z)\\, c_{i}\\, \\left(0 - T(z)\\right)\\, dz.\n$$\nWe express $\\rho(z)$ and $T(z)$ as given:\n$$\n\\rho(z) = \\rho_{0} + \\gamma z, \\quad T(z) = T_{0} + \\beta z.\n$$\nThe temperature deficit is $-T(z)$, and since $T(z)  0$ throughout the layer, $-T(z)  0$:\n$$\n-T(z) = -\\left(T_{0} + \\beta z\\right) = -T_{0} - \\beta z.\n$$\nBecause $T_{0} = -10\\,^{\\circ}\\mathrm{C}$ and $\\beta = 12\\,^{\\circ}\\mathrm{C\\,m^{-1}}$, we have\n$$\n-T(z) = 10 - 12 z.\n$$\nSubstituting into the integral for $Q_{\\mathrm{cc}}$ gives\n$$\nQ_{\\mathrm{cc}} = c_{i} \\int_{0}^{H} \\left(\\rho_{0} + \\gamma z\\right)\\left(10 - 12 z\\right)\\, dz.\n$$\nWe expand the integrand:\n$$\n\\left(\\rho_{0} + \\gamma z\\right)\\left(10 - 12 z\\right) = \\rho_{0}\\cdot 10 + \\rho_{0}\\cdot(-12z) + \\gamma z \\cdot 10 + \\gamma z \\cdot (-12 z)\n= 10\\rho_{0} + (-12\\rho_{0} + 10\\gamma) z - 12\\gamma z^{2}.\n$$\nWith the provided parameters $\\rho_{0} = 250$ and $\\gamma = 300$, we compute\n$$\n10\\rho_{0} = 2500, \\quad -12\\rho_{0} + 10\\gamma = -3000 + 3000 = 0, \\quad -12\\gamma = -3600.\n$$\nThus the integrand simplifies to\n$$\n2500 - 3600 z^{2}.\n$$\nTherefore,\n$$\n\\int_{0}^{H} \\left(\\rho_{0} + \\gamma z\\right)\\left(10 - 12 z\\right)\\, dz = \\int_{0}^{0.5} \\left(2500 - 3600 z^{2}\\right)\\, dz\n= \\left[2500 z - 1200 z^{3}\\right]_{0}^{0.5} = 2500\\cdot 0.5 - 1200\\cdot (0.5)^{3}.\n$$\nEvaluating,\n$$\n2500\\cdot 0.5 = 1250, \\quad (0.5)^{3} = 0.125, \\quad 1200\\cdot 0.125 = 150,\n$$\nso the integral equals\n$$\n1250 - 150 = 1100.\n$$\nThis has units of $\\mathrm{kg\\,m^{-2}\\,K}$ because it is $\\int \\rho(-T)\\, dz$ over depth. Multiplying by $c_{i}$ yields the cold content (energy per unit area):\n$$\nQ_{\\mathrm{cc}} = c_{i} \\times 1100.\n$$\nKeeping $c_{i}$ symbolic,\n$$\nQ_{\\mathrm{cc}} = 1100\\, c_{i}.\n$$\nSubstituting $c_{i} = 2.10 \\times 10^{3}\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$,\n$$\nQ_{\\mathrm{cc}} = 1100 \\times 2.10 \\times 10^{3} = 2.31 \\times 10^{6}\\,\\mathrm{J\\,m^{-2}}.\n$$\nRefreezing meltwater at $0\\,^{\\circ}\\mathrm{C}$ releases latent heat $L_{f}$ per unit mass. The maximum mass per unit area of meltwater that can refreeze before the snow layer warms to $0\\,^{\\circ}\\mathrm{C}$ is obtained by equating latent heat release to the cold content:\n$$\nm_{\\mathrm{ref,max}} = \\frac{Q_{\\mathrm{cc}}}{L_{f}}.\n$$\nSubstituting $Q_{\\mathrm{cc}} = 2.31 \\times 10^{6}\\,\\mathrm{J\\,m^{-2}}$ and $L_{f} = 3.34 \\times 10^{5}\\,\\mathrm{J\\,kg^{-1}}$,\n$$\nm_{\\mathrm{ref,max}} = \\frac{2.31 \\times 10^{6}}{3.34 \\times 10^{5}} = \\frac{2310}{334} \\approx 6.916167\\ldots\\,\\mathrm{kg\\,m^{-2}}.\n$$\nUnder the stated melt input $M_{\\mathrm{in}} = 9.0\\,\\mathrm{kg\\,m^{-2}}$, the actual mass that refreezes before the snow reaches $0\\,^{\\circ}\\mathrm{C}$ is\n$$\nm_{\\mathrm{ref}} = \\min\\left(M_{\\mathrm{in}},\\, m_{\\mathrm{ref,max}}\\right) = \\min\\left(9.0,\\, 6.916167\\ldots\\right) = 6.916167\\ldots\\,\\mathrm{kg\\,m^{-2}}.\n$$\nRounded to four significant figures and expressed in $\\mathrm{kg\\,m^{-2}}$, the result is\n$$\n6.916\\,\\mathrm{kg\\,m^{-2}}.\n$$",
            "answer": "$$\\boxed{6.916}$$"
        },
        {
            "introduction": "Translating physical laws into numerical models requires careful consideration of the discretization process. While the heat equation governs thermal conduction in the snowpack, its numerical solution using explicit time-stepping schemes is constrained by a strict stability criterion. This exercise  delves into this core challenge of computational science by having you derive the stability limit for an explicit solver using von Neumann analysis. Calculating the maximum permissible time step for a given snowpack highlights the practical trade-off between computational cost and numerical stability.",
            "id": "4089704",
            "problem": "In the context of Numerical Weather Prediction (NWP) and climate modeling, the thermodynamic evolution of a stratified snowpack undergoing temperature-gradient metamorphism is often approximated, at the layer scale, by one-dimensional vertical heat conduction. Starting from conservation of energy and Fourier’s law of heat conduction, assume a homogeneous, dry snow layer with constant thermal conductivity $k$, density $\\rho$, and specific heat capacity $c$, and neglect sources and sinks (e.g., latent heat due to phase change). Under these assumptions, the snow heat equation reduces to a linear diffusion equation for temperature $T(z,t)$,\n$$\n\\frac{\\partial T}{\\partial t} = \\kappa \\frac{\\partial^{2} T}{\\partial z^{2}},\n$$\nwhere the thermal diffusivity is $\\kappa = \\frac{k}{\\rho c}$. Consider an explicit forward-Euler time-stepping scheme with a uniform vertical grid spacing $\\Delta z$ and time step $\\Delta t$, and central differences for the second derivative.\n\nDerive, from first principles using von Neumann (Fourier) stability analysis, the stability condition governing $\\Delta t$ in terms of $\\Delta z$ and $\\kappa$. Then, using the derived condition, compute the maximum permissible time step $\\Delta t_{\\text{max}}$ in seconds for a dry snowpack with properties $k = 0.2$ $\\text{W}\\,\\text{m}^{-1}\\,\\text{K}^{-1}$, $\\rho = 300$ $\\text{kg}\\,\\text{m}^{-3}$, and $c = 2100$ $\\text{J}\\,\\text{kg}^{-1}\\,\\text{K}^{-1}$, on a uniform vertical grid with spacing $\\Delta z = 0.01$ $\\text{m}$. Round your final numerical answer to three significant figures and express it in seconds.",
            "solution": "### Solution Derivation\n\nThe problem requires the derivation of the stability condition for the numerical solution of the one-dimensional heat equation using a specific finite difference scheme. The governing equation is:\n$$\n\\frac{\\partial T}{\\partial t} = \\kappa \\frac{\\partial^{2} T}{\\partial z^{2}}\n$$\nWe discretize this equation on a grid with spatial step $\\Delta z$ and time step $\\Delta t$. Let $T_j^n$ represent the temperature at spatial node $j$ and time step $n$, i.e., $T_j^n \\approx T(j\\Delta z, n\\Delta t)$.\n\nThe explicit forward-Euler scheme approximates the time derivative:\n$$\n\\frac{\\partial T}{\\partial t} \\bigg|_{j,n} \\approx \\frac{T_j^{n+1} - T_j^n}{\\Delta t}\n$$\nThe central difference approximation for the second spatial derivative is:\n$$\n\\frac{\\partial^{2} T}{\\partial z^{2}} \\bigg|_{j,n} \\approx \\frac{T_{j+1}^n - 2T_j^n + T_{j-1}^n}{(\\Delta z)^2}\n$$\nSubstituting these approximations into the heat equation yields the finite difference equation:\n$$\n\\frac{T_j^{n+1} - T_j^n}{\\Delta t} = \\kappa \\frac{T_{j+1}^n - 2T_j^n + T_{j-1}^n}{(\\Delta z)^2}\n$$\nSolving for $T_j^{n+1}$, we get the update rule for the scheme:\n$$\nT_j^{n+1} = T_j^n + \\frac{\\kappa \\Delta t}{(\\Delta z)^2} (T_{j+1}^n - 2T_j^n + T_{j-1}^n)\n$$\nLet's define the dimensionless diffusion number, $s$, as:\n$$\ns = \\frac{\\kappa \\Delta t}{(\\Delta z)^2}\n$$\nThe update rule simplifies to:\n$$\nT_j^{n+1} = T_j^n + s(T_{j+1}^n - 2T_j^n + T_{j-1}^n) = sT_{j+1}^n + (1-2s)T_j^n + sT_{j-1}^n\n$$\nTo perform the von Neumann stability analysis, we consider the propagation of a single Fourier mode of the numerical solution (or error). We assume a solution of the form:\n$$\nT_j^n = G^n e^{i k_w j \\Delta z}\n$$\nwhere $k_w$ is the wavenumber and $G^n$ is the amplitude of the mode at time step $n$. For the scheme to be stable, the amplitude of any mode must not grow in time. This requires the amplification factor, $g = \\frac{G^{n+1}}{G^n}$, to satisfy $|g| \\le 1$ for all possible wavenumbers $k_w$.\n\nSubstituting the Fourier mode into the finite difference equation:\n$$\nG^{n+1} e^{i k_w j \\Delta z} = s G^n e^{i k_w (j+1) \\Delta z} + (1-2s) G^n e^{i k_w j \\Delta z} + s G^n e^{i k_w (j-1) \\Delta z}\n$$\nDividing by $G^n e^{i k_w j \\Delta z}$ gives the expression for the amplification factor $g$:\n$$\ng = \\frac{G^{n+1}}{G^n} = s e^{i k_w \\Delta z} + (1-2s) + s e^{-i k_w \\Delta z}\n$$\nUsing Euler's formula, $e^{i\\theta} + e^{-i\\theta} = 2\\cos(\\theta)$, we can simplify this expression:\n$$\ng = 1 - 2s + s(e^{i k_w \\Delta z} + e^{-i k_w \\Delta z}) = 1 - 2s + 2s\\cos(k_w \\Delta z) = 1 - 2s(1 - \\cos(k_w \\Delta z))\n$$\nUsing the trigonometric half-angle identity $1 - \\cos(\\theta) = 2\\sin^2(\\frac{\\theta}{2})$:\n$$\ng = 1 - 4s \\sin^2\\left(\\frac{k_w \\Delta z}{2}\\right)\n$$\nThe stability condition is $|g| \\le 1$, which translates to:\n$$\n-1 \\le 1 - 4s \\sin^2\\left(\\frac{k_w \\Delta z}{2}\\right) \\le 1\n$$\nWe analyze the two inequalities separately. First, the right-hand inequality:\n$$\n1 - 4s \\sin^2\\left(\\frac{k_w \\Delta z}{2}\\right) \\le 1 \\implies -4s \\sin^2\\left(\\frac{k_w \\Delta z}{2}\\right) \\le 0\n$$\nSince $s = \\frac{\\kappa \\Delta t}{(\\Delta z)^2}$ is non-negative (as $\\kappa, \\Delta t, (\\Delta z)^2$ are all non-negative) and $\\sin^2(\\cdot)$ is always non-negative, this inequality is always satisfied.\n\nNext, the left-hand inequality:\n$$\n-1 \\le 1 - 4s \\sin^2\\left(\\frac{k_w \\Delta z}{2}\\right) \\implies -2 \\le -4s \\sin^2\\left(\\frac{k_w \\Delta z}{2}\\right) \\implies 2 \\ge 4s \\sin^2\\left(\\frac{k_w \\Delta z}{2}\\right)\n$$\n$$\n\\frac{1}{2} \\ge s \\sin^2\\left(\\frac{k_w \\Delta z}{2}\\right)\n$$\nThis condition must hold for all possible wavenumbers $k_w$. The most restrictive condition (the \"worst case\") occurs when the term $\\sin^2\\left(\\frac{k_w \\Delta z}{2}\\right)$ is at its maximum value, which is $1$. This corresponds to the highest frequency mode the grid can resolve, where $k_w \\Delta z = \\pi$.\nSetting $\\sin^2\\left(\\frac{k_w \\Delta z}{2}\\right) = 1$, we obtain the stability condition for $s$:\n$$\ns \\le \\frac{1}{2}\n$$\nSubstituting the definition of $s$ back, we arrive at the stability condition relating $\\Delta t$, $\\Delta z$, and $\\kappa$:\n$$\n\\frac{\\kappa \\Delta t}{(\\Delta z)^2} \\le \\frac{1}{2}\n$$\nThis is the desired stability condition derived from first principles.\n\n### Calculation of Maximum Time Step\nThe problem requires calculating the maximum permissible time step, $\\Delta t_{\\text{max}}$. This occurs when the stability condition reaches its limit:\n$$\n\\frac{\\kappa \\Delta t_{\\text{max}}}{(\\Delta z)^2} = \\frac{1}{2}\n$$\nSolving for $\\Delta t_{\\text{max}}$:\n$$\n\\Delta t_{\\text{max}} = \\frac{(\\Delta z)^2}{2\\kappa}\n$$\nFirst, we must calculate the thermal diffusivity $\\kappa$ from the given properties: $k = 0.2$ $\\text{W}\\,\\text{m}^{-1}\\,\\text{K}^{-1}$, $\\rho = 300$ $\\text{kg}\\,\\text{m}^{-3}$, and $c = 2100$ $\\text{J}\\,\\text{kg}^{-1}\\,\\text{K}^{-1}$.\n$$\n\\kappa = \\frac{k}{\\rho c} = \\frac{0.2~\\text{W}\\,\\text{m}^{-1}\\,\\text{K}^{-1}}{(300~\\text{kg}\\,\\text{m}^{-3}) (2100~\\text{J}\\,\\text{kg}^{-1}\\,\\text{K}^{-1})} = \\frac{0.2}{630000}~\\text{m}^2\\,\\text{s}^{-1} = \\frac{1}{3150000}~\\text{m}^2\\,\\text{s}^{-1}\n$$\nNow, we substitute the values of $\\kappa$ and $\\Delta z = 0.01$ $\\text{m}$ into the expression for $\\Delta t_{\\text{max}}$:\n$$\n\\Delta t_{\\text{max}} = \\frac{(0.01~\\text{m})^2}{2 \\left(\\frac{1}{3150000}~\\text{m}^2\\,\\text{s}^{-1}\\right)} = \\frac{0.0001}{2} \\times 3150000~\\text{s}\n$$\n$$\n\\Delta t_{\\text{max}} = \\frac{315}{2}~\\text{s} = 157.5~\\text{s}\n$$\nThe problem requires rounding the final answer to three significant figures. The number $157.5$ has four significant figures. Rounding to three significant figures gives:\n$$\n\\Delta t_{\\text{max}} \\approx 158~\\text{s}\n$$",
            "answer": "$$\n\\boxed{158}\n$$"
        },
        {
            "introduction": "The process of melting and refreezing introduces a significant challenge in numerical modeling known as 'stiffness', where the apparent heat capacity changes dramatically near $0^{\\circ}\\mathrm{C}$. Explicit schemes, as explored previously, become impractically slow under these conditions, necessitating more robust implicit methods. This advanced practice  explores the professional-grade solution: an enthalpy-based formulation with a fully implicit solver. You will derive and implement a Newton-Raphson method to solve the resulting nonlinear equation, providing direct experience with the techniques used in operational weather and climate models to handle phase transitions efficiently and accurately.",
            "id": "4089698",
            "problem": "A single control volume within a one-dimensional snow column is updated in time under thermal diffusion and phase change. The snow is treated as a porous medium with an ice matrix and a potentially small liquid water fraction due to melting. The energy conservation law and Fourier’s law of heat conduction are the starting points. Assume the control volume has temperature $T$, density $\\rho$, constant ice specific heat $c_i$, thermal conductivity $k$, and is coupled to a boundary at temperature $T_b$ through a characteristic length scale $h$. The melting point is $T_m$, and the latent heat of fusion is $L$. A smooth liquid fraction $\\phi(T)$ regularizes the phase transition near $T_m$ over a narrow thermal width $\\delta$, such that $\\phi(T)$ transitions from $0$ (fully frozen) to $1$ (fully melted) as $T$ increases past $T_m$. An external volumetric heat source $Q_{\\mathrm{ext}}$ may be present. The enthalpy per unit volume is $E(T) = \\rho\\,c_i\\,T + \\rho\\,L\\,\\phi(T)$.\n\nStarting from the energy conservation statement, the time evolution follows\n$$\n\\frac{\\partial E(T)}{\\partial t} = \\nabla\\cdot\\left(k\\,\\nabla T\\right) + Q_\\mathrm{ext}.\n$$\nFor a single control volume with a single neighbor or boundary at $T_b$, approximate the conduction term by a linear exchange using a second-order centered difference magnitude $k\\,(T_b - T)/h^2$ to yield a volumetric source. Consider a fully implicit time discretization over a timestep $\\Delta t$, updating from known $T^n$ to unknown $T^{n+1}$.\n\nTasks:\n1. Using the enthalpy formulation and the fully implicit time discretization, derive the nonlinear scalar equation that $T^{n+1}$ must satisfy. Do not use ad hoc shortcut formulas; derive from the given conservation law and constitutive relations.\n2. Provide a rationale for using a fully implicit scheme to handle the stiff latent heating near the melting point $T_m$. Base your explanation on a scale analysis using the apparent heat capacity created by the phase transition regularization and explain how stiffness arises and why implicit updates are advantageous in stability and allowable timestep.\n3. Define a smooth regularization for the liquid fraction as a function of temperature,\n$$\n\\phi(T) = \\tfrac{1}{2}\\left(1 + \\tanh\\left(\\frac{T - T_m}{\\delta}\\right)\\right),\n$$\nand derive the Newton iteration needed to solve the nonlinear equation for $T^{n+1}$, including the residual $F(T^{n+1})$ and its derivative $F'(T^{n+1})$. State the stopping criteria in terms of temperature and residual tolerances, propose an initial guess based on an explicit step that ignores latent effects, and describe a damping strategy to ensure robust convergence.\n4. Implement a program that computes $T^{n+1}$ for given parameters by solving the derived nonlinear equation using Newton’s method with line-search damping. Angles are not used. Express the final temperatures in degrees Celsius, rounded to four decimal places. Use the following constants unless explicitly overridden in a test case: $\\rho = 300\\,\\mathrm{kg/m^3}$, $c_i = 2100\\,\\mathrm{J/(kg\\cdot K)}$, $k = 0.2\\,\\mathrm{W/(m\\cdot K)}$, $h = 0.1\\,\\mathrm{m}$, $T_m = 0.0\\,^{\\circ}\\mathrm{C}$, and $L = 334000\\,\\mathrm{J/kg}$. The function $\\phi(T)$ must use the specified $\\tanh$ regularization with width $\\delta$ in kelvins (equivalently degrees Celsius differences).\n5. Design and run the following test suite. For each case, compute $T^{n+1}$ from $T^n$ given $\\Delta t$, $T_b$, $\\delta$, and $Q_\\mathrm{ext}$. When a parameter is omitted, use the default constant above. All temperatures are in degrees Celsius, time in seconds, heat source in $\\mathrm{W/m^3}$.\n   - Case A (happy path, near-melting stiffness): $\\Delta t = 3600$, $T^n = -2.0$, $T_b = +1.0$, $\\delta = 0.2$, $Q_\\mathrm{ext} = 0$.\n   - Case B (strong stiffness, very narrow transition): $\\Delta t = 600$, $T^n = -0.01$, $T_b = +2.0$, $\\delta = 0.05$, $Q_\\mathrm{ext} = 0$.\n   - Case C (crossing the melting point due to external heating against a cold boundary): $\\Delta t = 3600$, $T^n = -1.0$, $T_b = -5.0$, $\\delta = 0.2$, $Q_\\mathrm{ext} = 300$.\n   - Case D (non-stiff, far below melting): $\\Delta t = 1800$, $T^n = -10.0$, $T_b = -5.0$, $\\delta = 0.2$, $Q_\\mathrm{ext} = 0$.\n   - Case E (no latent heat, linear response): $\\Delta t = 3600$, $T^n = -0.5$, $T_b = +0.5$, $\\delta = 0.2$, $Q_\\mathrm{ext} = 0$, override $L = 0$.\n6. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the same order as the test suite: for example, \"[resultA,resultB,resultC,resultD,resultE]\". Each result must be a float giving $T^{n+1}$ in degrees Celsius, rounded to four decimal places.\n\nAnswer in degrees Celsius.",
            "solution": "The solution to this problem involves deriving and numerically solving a nonlinear equation for the temperature evolution in a single snow control volume. The derivation starts from the principle of energy conservation and employs a fully implicit time discretization to handle the stiffness associated with the latent heat of phase change.\n\n### Task 1: Derivation of the Nonlinear Equation for $T^{n+1}$\n\nThe governing partial differential equation for energy conservation is given as:\n$$\n\\frac{\\partial E(T)}{\\partial t} = \\nabla\\cdot(k\\,\\nabla T) + Q_{\\mathrm{ext}}\n$$\nwhere the volumetric enthalpy is $E(T) = \\rho\\,c_i\\,T + \\rho\\,L\\,\\phi(T)$.\n\nWe discretize this equation in time and space. For time, a fully implicit (first-order backward difference) scheme is used, evaluating all terms at the new time step $n+1$:\n$$\n\\frac{\\partial E(T)}{\\partial t} \\approx \\frac{E(T^{n+1}) - E(T^n)}{\\Delta t}\n$$\nFor the spatial derivatives in the single control volume, the divergence of the heat flux (conduction) is approximated by a linear exchange with the boundary at temperature $T_b$:\n$$\n\\nabla\\cdot(k\\,\\nabla T) \\approx \\frac{k(T_b - T^{n+1})}{h^2}\n$$\nSubstituting these discrete approximations into the conservation law yields the algebraic equation for the unknown temperature $T^{n+1}$:\n$$\n\\frac{E(T^{n+1}) - E(T^n)}{\\Delta t} = \\frac{k(T_b - T^{n+1})}{h^2} + Q_{\\mathrm{ext}}\n$$\nTo simplify notation, let $T = T^{n+1}$ be the unknown we are solving for. We rearrange the equation to the standard root-finding form $F(T) = 0$:\n$$\nE(T) - E(T^n) - \\Delta t \\left( \\frac{k(T_b - T)}{h^2} + Q_{\\mathrm{ext}} \\right) = 0\n$$\nNow, substitute the definition of enthalpy, $E(T) = \\rho\\,c_i\\,T + \\rho\\,L\\,\\phi(T)$, and expand:\n$$\n(\\rho\\,c_i\\,T + \\rho\\,L\\,\\phi(T)) - (\\rho\\,c_i\\,T^n + \\rho\\,L\\,\\phi(T^n)) - \\frac{\\Delta t\\,k}{h^2}(T_b - T) - \\Delta t\\,Q_{\\mathrm{ext}} = 0\n$$\nThis is the required nonlinear scalar equation for $T = T^{n+1}$. For implementation, it is useful to group terms involving the unknown $T$:\n$$\nF(T) = \\left(\\rho\\,c_i + \\frac{\\Delta t\\,k}{h^2}\\right)T + \\rho\\,L\\,\\phi(T) - \\left[ E(T^n) + \\frac{\\Delta t\\,k\\,T_b}{h^2} + \\Delta t\\,Q_{\\mathrm{ext}} \\right] = 0\n$$\n\n### Task 2: Rationale for a Fully Implicit Scheme\n\nThe rationale for using a fully implicit scheme is to overcome the numerical stiffness introduced by the phase transition. Stiffness arises when a system has processes occurring on vastly different time scales.\n\nThe *apparent heat capacity*, $C_{\\mathrm{app}}(T) = dE/dT$, quantifies the energy required to change the temperature. From the enthalpy definition, we have:\n$$\nC_{\\mathrm{app}}(T) = \\frac{d}{dT} \\left( \\rho\\,c_i\\,T + \\rho\\,L\\,\\phi(T) \\right) = \\rho\\,c_i + \\rho\\,L\\,\\phi'(T)\n$$\nThe derivative of the given regularization function $\\phi(T) = \\frac{1}{2}\\left(1 + \\tanh\\left(\\frac{T - T_m}{\\delta}\\right)\\right)$ is:\n$$\n\\phi'(T) = \\frac{1}{2\\delta} \\mathrm{sech}^2\\left(\\frac{T - T_m}{\\delta}\\right)\n$$\nThe hyperbolic secant squared function, $\\mathrm{sech}^2(x)$, has a sharp peak of height $1$ at $x=0$. Therefore, near the melting point $T_m$, $\\phi'(T)$ becomes very large, especially for small $\\delta$. This results in a peak apparent heat capacity of $C_{\\mathrm{app}}(T_m) = \\rho\\,c_i + \\rho\\,L/(2\\delta)$, which can be orders of magnitude larger than the sensible heat capacity $\\rho\\,c_i$.\n\nThe characteristic time scale of thermal diffusion is approximately $\\tau \\sim C_{\\mathrm{app}} h^2 / k$. During phase change, the large $C_{\\mathrm{app}}$ leads to a very small time scale $\\tau$. Explicit time integration schemes (e.g., Forward Euler) are only stable if the time step $\\Delta t$ is smaller than this fastest time scale, i.e., $\\Delta t  \\mathcal{O}(\\tau)$. This would force impractically small time steps, making simulations computationally prohibitive.\n\nA fully implicit scheme is numerically stable for much larger timesteps, often limited by accuracy rather than stability. By evaluating all terms at the future time $T^{n+1}$, it correctly handles the strong feedback between temperature and enthalpy, even for large $\\Delta t$. The trade-off is the need to solve a nonlinear algebraic equation at each step, but this is far more efficient than taking millions of tiny explicit steps for a stiff system like this.\n\n### Task 3: Newton's Method Formulation\n\nTo solve the nonlinear equation $F(T)=0$, we use Newton's method, which requires the function $F(T)$ and its derivative $F'(T)$.\n\n**Residual and Derivative:**\nThe residual function is:\n$$\nF(T) = \\left(\\rho\\,c_i + \\frac{\\Delta t\\,k}{h^2}\\right)T + \\rho\\,L\\,\\phi(T) - \\text{Constant}\n$$\nwhere the constant term contains all values from the previous time step and boundary conditions. The derivative with respect to $T$ is:\n$$\nF'(T) = \\frac{dF}{dT} = \\left(\\rho\\,c_i + \\frac{\\Delta t\\,k}{h^2}\\right) + \\rho\\,L\\,\\phi'(T)\n$$\nSubstituting the expression for $\\phi'(T)$:\n$$\nF'(T) = \\left(\\rho\\,c_i + \\frac{\\Delta t\\,k}{h^2}\\right) + \\frac{\\rho\\,L}{2\\delta} \\mathrm{sech}^2\\left(\\frac{T - T_m}{\\delta}\\right)\n$$\nThe Newton iteration proceeds by updating a guess $T_k$ to $T_{k+1}$:\n$$\nT_{k+1} = T_k - \\frac{F(T_k)}{F'(T_k)}\n$$\n\n**Initial Guess:**\nAn appropriate initial guess is based on an explicit step that neglects latent heat effects (i.e., treating the problem as simple heat diffusion). This is derived from $\\rho\\,c_i \\frac{T_0 - T^n}{\\Delta t} = \\frac{k(T_b - T^n)}{h^2} + Q_{\\mathrm{ext}}$, which gives:\n$$\nT_0 = T^n + \\frac{\\Delta t}{\\rho\\,c_i} \\left( \\frac{k(T_b - T^n)}{h^2} + Q_{\\mathrm{ext}} \\right)\n$$\n\n**Damping Strategy:**\nTo improve robustness, especially for poor initial guesses or near the highly nonlinear region of phase change, the Newton step is damped using a backtracking line search. The update formula becomes $T_{k+1} = T_k + \\alpha \\Delta T_k$, where $\\Delta T_k = -F(T_k)/F'(T_k)$ and $\\alpha \\in (0, 1]$. We start with $\\alpha = 1$. If the residual at the new point is not smaller in magnitude than the current residual (i.e., $|F(T_k + \\alpha \\Delta T_k)| \\ge |F(T_k)|$), $\\alpha$ is repeatedly halved until a sufficient decrease is achieved or $\\alpha$ reaches a minimum threshold.\n\n**Stopping Criteria:**\nThe iteration is halted when the solution has converged, which is determined by two conditions:\n1.  The update step becomes negligible: $|T_{k+1} - T_k|  \\tau_T$\n2.  The residual is sufficiently close to zero: $|F(T_{k+1})|  \\tau_F$\nwhere $\\tau_T$ and $\\tau_F$ are small tolerance values (e.g., $10^{-8}$). A maximum number of iterations is also imposed to prevent infinite loops.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite for the snowpack metamorphism problem.\n    It computes the temperature T^{n+1} for a series of test cases using\n    an implicit solver with Newton's method.\n    \"\"\"\n\n    # Default physical constants\n    DEFAULT_RHO = 300.0  # kg/m^3\n    DEFAULT_C_I = 2100.0  # J/(kg.K)\n    DEFAULT_K = 0.2  # W/(m.K)\n    DEFAULT_H = 0.1  # m\n    DEFAULT_T_M = 0.0  # degrees C\n    DEFAULT_L = 334000.0  # J/kg\n\n    # Newton's method solver parameters\n    MAX_ITER = 50\n    TOL_T = 1e-8  # Tolerance for temperature change\n    TOL_F = 1e-8  # Tolerance for residual magnitude\n    MIN_ALPHA = 1e-8 # Minimum damping factor for line search\n\n    def solve_for_t_next(\n        dt, tn, tb, delta, q_ext,\n        rho=DEFAULT_RHO, c_i=DEFAULT_C_I, k=DEFAULT_K, h=DEFAULT_H,\n        tm=DEFAULT_T_M, l=DEFAULT_L\n    ):\n        \"\"\"\n        Solves for the temperature T^{n+1} of a snow control volume using\n        a fully implicit scheme and Newton's method with line-search damping.\n        All temperatures are in degrees Celsius.\n        \"\"\"\n\n        # --- Define helper functions based on current case parameters ---\n        def phi(T):\n            \"\"\"Smooth liquid fraction function phi(T).\"\"\"\n            if l == 0:\n                return 0.0\n            # Avoid overflow in tanh for large arguments by clamping\n            arg = (T - tm) / delta\n            if arg  30: return 1.0\n            if arg  -30: return 0.0\n            return 0.5 * (1.0 + np.tanh(arg))\n\n        def phi_prime(T):\n            \"\"\"Derivative of the liquid fraction function, phi'(T).\"\"\"\n            if l == 0:\n                return 0.0\n            arg = (T - tm) / delta\n            # sech(x) = 1/cosh(x)\n            cosh_arg = np.cosh(arg)\n            # Avoid overflow if cosh is very large (sech^2 will be ~0)\n            if cosh_arg  1e15:\n                return 0.0\n            sech_sq = 1.0 / (cosh_arg**2)\n            return 0.5 / delta * sech_sq\n\n        # --- Pre-compute constant terms for the iteration ---\n        E_n = rho * c_i * tn + rho * l * phi(tn)\n        k_term = k / (h**2)\n        \n        # Constant part 'C' of the residual function F(T) = ... - C\n        C = E_n + dt * (k_term * tb + q_ext)\n\n        # --- Define Residual F(T) and its Derivative F'(T) ---\n        def F(T):\n            \"\"\"Residual function F(T) = 0.\"\"\"\n            return (rho * c_i + dt * k_term) * T + rho * l * phi(T) - C\n\n        def F_prime(T):\n            \"\"\"Derivative F'(T).\"\"\"\n            return (rho * c_i + dt * k_term) + rho * l * phi_prime(T)\n\n        # --- Newton-Raphson Iteration ---\n        # Initial guess based on an explicit step ignoring latent heat\n        t_k = tn + (dt / (rho * c_i)) * (k_term * (tb - tn) + q_ext)\n\n        for _ in range(MAX_ITER):\n            f_val = F(t_k)\n            \n            # Check for convergence on residual\n            if abs(f_val)  TOL_F:\n                return t_k\n\n            f_prime_val = F_prime(t_k)\n\n            if abs(f_prime_val)  1e-12:\n                # Derivative is zero, Newton step is not possible.\n                # This is unlikely with the given problem formulation but is a safe check.\n                break\n\n            delta_t = -f_val / f_prime_val\n\n            # Backtracking line search for damping\n            alpha = 1.0\n            while alpha  MIN_ALPHA:\n                t_new_trial = t_k + alpha * delta_t\n                f_new_val = F(t_new_trial)\n                if abs(f_new_val)  abs(f_val):\n                    # Step accepted\n                    break\n                alpha /= 2.0\n            \n            t_new = t_k + alpha * delta_t\n            \n            # Check for convergence on temperature step size\n            if abs(t_new - t_k)  TOL_T:\n                return t_new\n\n            t_k = t_new\n\n        return t_k # Return best guess if max iterations reached without converging\n\n    # Definition of the test suite from the problem statement.\n    test_cases = [\n        # Case A (happy path, near-melting stiffness)\n        {'dt': 3600, 'tn': -2.0, 'tb': 1.0, 'delta': 0.2, 'q_ext': 0},\n        # Case B (strong stiffness, very narrow transition)\n        {'dt': 600, 'tn': -0.01, 'tb': 2.0, 'delta': 0.05, 'q_ext': 0},\n        # Case C (crossing the melting point due to external heating against a cold boundary)\n        {'dt': 3600, 'tn': -1.0, 'tb': -5.0, 'delta': 0.2, 'q_ext': 300},\n        # Case D (non-stiff, far below melting)\n        {'dt': 1800, 'tn': -10.0, 'tb': -5.0, 'delta': 0.2, 'q_ext': 0},\n        # Case E (no latent heat, linear response)\n        {'dt': 3600, 'tn': -0.5, 'tb': 0.5, 'delta': 0.2, 'q_ext': 0, 'l': 0.0},\n    ]\n\n    results = []\n    for case_params in test_cases:\n        # The 'l' parameter is handled by .get(), which uses the default if not present.\n        t_next = solve_for_t_next(\n            dt=case_params['dt'], tn=case_params['tn'], tb=case_params['tb'], \n            delta=case_params['delta'], q_ext=case_params['q_ext'],\n            l=case_params.get('l', DEFAULT_L)\n        )\n        results.append(t_next)\n\n    # Final print statement in the exact required format.\n    formatted_results = [f\"{res:.4f}\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}