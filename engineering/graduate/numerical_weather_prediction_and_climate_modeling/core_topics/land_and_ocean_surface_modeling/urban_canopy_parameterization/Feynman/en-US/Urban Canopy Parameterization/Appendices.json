{
    "hands_on_practices": [
        {
            "introduction": "Before we can model urban weather and climate, we must first translate the complex, real-world city into a set of simplified, quantitative parameters. This exercise guides you through the foundational process of deriving key morphological parameters, such as the plan area fraction ($\\lambda_p$) and the frontal area index ($\\lambda_f$), directly from building data. Mastering this crucial data-to-model workflow will equip you with the practical skills to handle realistic, often incomplete, geospatial datasets to generate the geometric inputs required by any Urban Canopy Parameterization (UCP) .",
            "id": "4107937",
            "problem": "You are tasked with deriving, implementing, and testing an algorithm to compute the plan area fraction $\\lambda_p$, the frontal area index $\\lambda_f$ (for a specified wind direction), and the plan-area-weighted mean building height $H$ for an Urban Canopy Parameterization (UCP) grid cell. The algorithm must start from fundamental geometric and physical definitions and must specify robust procedures to handle incomplete building attribute data and mixed land-use within a grid cell. All angles must be expressed in radians. All length-like quantities must be expressed in meters, and all areas must be expressed in square meters. The final results for each test case must be floats. The program must output a single line containing the computed quantities for the provided test suite, formatted exactly as a list of lists with each inner list holding $[\\lambda_p,\\lambda_f,H]$ for a test case. Each float must be rounded to six decimal places.\n\nFundamental base definitions:\n- The plan area fraction $\\lambda_p$ is defined as the ratio of the total building plan area to the total grid-cell land area: $$\\lambda_p = \\frac{\\sum_{i=1}^{N} A_i}{A_{\\text{cell}}},$$ where $A_i$ is the building footprint area and $A_{\\text{cell}}$ is the total land area of the grid cell. Units: $\\lambda_p$ is dimensionless.\n- The frontal area index $\\lambda_f$ for wind direction $\\phi$ is defined as the ratio of the sum of building frontal areas perpendicular to the wind vector to the total grid-cell land area: $$\\lambda_f(\\phi) = \\frac{\\sum_{i=1}^{N} F_i(\\phi)}{A_{\\text{cell}}},$$ where $F_i(\\phi)$ is the frontal area of building $i$ projected onto the plane normal to the wind vector. Units: $\\lambda_f$ is dimensionless.\n- The plan-area-weighted mean building height is defined as $$H = \\frac{\\sum_{i=1}^{N} h_i A_i}{\\sum_{i=1}^{N} A_i},$$ where $h_i$ is the building height. Units: $H$ in meters. If $\\sum_{i} A_i = 0$, define $H = 0$.\n\nGeometric foundations used in the algorithm:\n- Each building footprint is approximated by a rectangle characterized by width $w_i$, length $l_i$, and an orientation angle $\\alpha_i$ measured clockwise from the $x$-axis. The grid-cell wind direction angle is $\\phi$ measured clockwise from the $x$-axis. All angles are in radians.\n- For a rectangular footprint, the building frontal width projected perpendicular to the wind direction is computed as $$b_i(\\phi) = \\left|w_i \\cos(\\alpha_i - \\phi)\\right| + \\left|l_i \\sin(\\alpha_i - \\phi)\\right|.$$ The frontal area is then $$F_i(\\phi) = h_i\\, b_i(\\phi).$$\n- If the building orientation $\\alpha_i$ is unavailable, use the Cauchy projection result for the average projected width of a convex shape over all directions. For a rectangle, the angle-averaged projected width is $$\\overline{b_i} = \\frac{2\\,(w_i + l_i)}{\\pi},$$ which is independent of $\\phi$ and provides a conservative estimate when $\\alpha_i$ is unknown.\n\nImputation rules for incomplete data and mixed land-use:\n- Land-use classes $c_i$ may be one of residential, commercial, or industrial, denoted by the set $\\{\\text{residential}, \\text{commercial}, \\text{industrial}\\}$. The algorithm must handle mixed land-use in a grid cell by applying class-specific defaults when attributes are missing and by aggregating all buildings across classes in the definitions for $\\lambda_p$, $\\lambda_f$, and $H$.\n- Missing building height $h_i$:\n  1. Compute the within-grid-cell, within-class median of available heights for class $c_i$. If at least one height in class $c_i$ is known in the current grid cell, use this median as the imputed $h_i$.\n  2. If no heights in class $c_i$ are known in the current grid cell, use the class-typical height $h^{\\text{typ}}_{c}$:\n     - Residential: $h^{\\text{typ}}_{\\text{residential}} = 9$ meters.\n     - Commercial: $h^{\\text{typ}}_{\\text{commercial}} = 18$ meters.\n     - Industrial: $h^{\\text{typ}}_{\\text{industrial}} = 12$ meters.\n- Missing footprint side lengths $w_i$ and $l_i$ but known footprint area $A_i$:\n  1. Reconstruct $w_i$ and $l_i$ using a class-specific typical aspect ratio $r_c = \\frac{w}{l}$:\n     - Residential: $r_{\\text{residential}} = 0.5$.\n     - Commercial: $r_{\\text{commercial}} = 1.0$.\n     - Industrial: $r_{\\text{industrial}} = 0.25$.\n  2. Using $A_i = w_i\\, l_i$ and $r_c = \\frac{w_i}{l_i}$, derive $$w_i = \\sqrt{A_i\\, r_c}, \\quad l_i = \\sqrt{\\frac{A_i}{r_c}}.$$\n- Missing orientation $\\alpha_i$:\n  - Use the angle-averaged projected width $\\overline{b_i} = \\frac{2\\,(w_i + l_i)}{\\pi}$ and set $F_i(\\phi) = h_i\\, \\overline{b_i}$.\n- When any attribute is missing, apply the above imputation rules in the following order: reconstruct $w_i$ and $l_i$ if needed, impute $h_i$, then compute $b_i(\\phi)$ using either the known $\\alpha_i$ or the angle-averaged $\\overline{b_i}$. If a building footprint area $A_i$ is missing or nonpositive, the building should be excluded from all sums.\n\nNumerical and physical units:\n- Input and output heights $h_i$ and $H$ must be in meters.\n- Input widths $w_i$ and lengths $l_i$ must be in meters.\n- Footprint areas $A_i$ and grid-cell area $A_{\\text{cell}}$ must be in square meters.\n- Angles $\\alpha_i$ and $\\phi$ must be in radians.\n- The plan area fraction $\\lambda_p$ and the frontal area index $\\lambda_f$ are dimensionless.\n\nTest suite (five grid cells):\nFor each grid cell $j$, you are given $A_{\\text{cell}}$, $\\phi$, and a list of buildings with attributes $(A_i, w_i, l_i, \\alpha_i, h_i, c_i)$; missing values are indicated and must be imputed as above.\n\n- Test case $1$ (general case with complete data):\n  - $A_{\\text{cell}} = 250000$.\n  - $\\phi = \\frac{\\pi}{6}$.\n  - Buildings:\n    1. $(A_1 = 1200,\\; w_1 = 30,\\; l_1 = 40,\\; \\alpha_1 = \\frac{\\pi}{4},\\; h_1 = 20,\\; c_1 = \\text{commercial})$.\n    2. $(A_2 = 800,\\; w_2 = 20,\\; l_2 = 40,\\; \\alpha_2 = \\frac{\\pi}{3},\\; h_2 = 12,\\; c_2 = \\text{residential})$.\n- Test case $2$ (missing height imputed by within-class median):\n  - $A_{\\text{cell}} = 250000$.\n  - $\\phi = \\frac{\\pi}{3}$.\n  - Buildings:\n    1. $(A_1 = 600,\\; w_1 = 15,\\; l_1 = 40,\\; \\alpha_1 = \\frac{\\pi}{8},\\; h_1 = \\text{missing},\\; c_1 = \\text{residential})$.\n    2. $(A_2 = 500,\\; w_2 = 10,\\; l_2 = 50,\\; \\alpha_2 = \\frac{\\pi}{5},\\; h_2 = 10,\\; c_2 = \\text{residential})$.\n    3. $(A_3 = 900,\\; w_3 = 30,\\; l_3 = 30,\\; \\alpha_3 = \\frac{\\pi}{6},\\; h_3 = 18,\\; c_3 = \\text{commercial})$.\n- Test case $3$ (missing orientations and missing height imputed by class-typical):\n  - $A_{\\text{cell}} = 250000$.\n  - $\\phi = \\frac{\\pi}{2}$.\n  - Buildings:\n    1. $(A_1 = 2000,\\; w_1 = 25,\\; l_1 = 80,\\; \\alpha_1 = \\text{missing},\\; h_1 = 15,\\; c_1 = \\text{industrial})$.\n    2. $(A_2 = 600,\\; w_2 = 12,\\; l_2 = 50,\\; \\alpha_2 = \\text{missing},\\; h_2 = \\text{missing},\\; c_2 = \\text{residential})$.\n- Test case $4$ (missing widths and lengths reconstructed from area and class aspect ratio, mixed orientation availability, missing height imputed by class-typical):\n  - $A_{\\text{cell}} = 250000$.\n  - $\\phi = 0$.\n  - Buildings:\n    1. $(A_1 = 1000,\\; w_1 = \\text{missing},\\; l_1 = \\text{missing},\\; \\alpha_1 = \\frac{\\pi}{4},\\; h_1 = 20,\\; c_1 = \\text{commercial})$.\n    2. $(A_2 = 1500,\\; w_2 = \\text{missing},\\; l_2 = \\text{missing},\\; \\alpha_2 = \\text{missing},\\; h_2 = \\text{missing},\\; c_2 = \\text{industrial})$.\n- Test case $5$ (edge case: no buildings in the grid cell):\n  - $A_{\\text{cell}} = 250000$.\n  - $\\phi = \\frac{\\pi}{2}$.\n  - Buildings: none.\n\nOutput specification:\n- Your program should produce a single line of output containing the results as a list of lists, each inner list being $[\\lambda_p,\\lambda_f,H]$ for the corresponding test case, with each float rounded to six decimal places. For example: $$[[x_{11},x_{12},x_{13}],[x_{21},x_{22},x_{23}],\\dots],$$ where $x_{j1}=\\lambda_p$, $x_{j2}=\\lambda_f$, and $x_{j3}=H$ for test case $j$.",
            "solution": "We begin from the Urban Canopy Parameterization (UCP) fundamental definitions of plan area fraction, frontal area index, and mean building height. The plan area fraction $\\lambda_p$ is defined as the ratio $\\lambda_p = \\frac{\\sum_{i=1}^{N} A_i}{A_{\\text{cell}}}$, which aggregates all footprint areas $A_i$ within the grid cell and normalizes by the grid-cell area $A_{\\text{cell}}$. It is dimensionless and measures areal building coverage.\n\nThe frontal area index $\\lambda_f(\\phi)$ measures the total building frontal area projected perpendicular to the wind direction $\\phi$, normalized by the grid-cell area. For a building represented as a rectangle with width $w_i$, length $l_i$, orientation $\\alpha_i$, and height $h_i$, the projected width perpendicular to wind is derived from the geometric projection of the rectangle onto a line normal to the wind vector. If the rectangle edges are aligned with $\\alpha_i$, and $\\phi$ is the wind direction, the projection width can be written as $b_i(\\phi) = \\left|w_i \\cos(\\alpha_i - \\phi)\\right| + \\left|l_i \\sin(\\alpha_i - \\phi)\\right|$. This follows from decomposing the projection of the rectangle's extents onto the axis perpendicular to the wind: the contribution along the rectangle's width is modulated by $\\cos(\\alpha_i - \\phi)$, while the contribution along the rectangle's length is modulated by $\\sin(\\alpha_i - \\phi)$, and absolute values ensure non-negativity because widths are geometric measures. The building frontal area is then $F_i(\\phi) = h_i\\, b_i(\\phi)$, yielding $\\lambda_f(\\phi) = \\frac{\\sum_i F_i(\\phi)}{A_{\\text{cell}}}$, which is dimensionless.\n\nWhen the orientation $\\alpha_i$ is missing, we cannot compute $b_i(\\phi)$ directly. A robust replacement uses the Cauchy projection theorem for convex shapes, which states that the average length of the orthogonal projection of a convex curve onto a line, averaged over all angles, equals the perimeter divided by $\\pi$. For a rectangle of width $w_i$ and length $l_i$, perimeter is $2(w_i + l_i)$, hence the angle-averaged projected width is $\\overline{b_i} = \\frac{2(w_i + l_i)}{\\pi}$. This estimate is independent of $\\phi$ and provides a conservative, physically consistent proxy when $\\alpha_i$ is unknown. We then take $F_i(\\phi) = h_i\\, \\overline{b_i}$.\n\nThe mean building height $H$ is computed in a plan-area-weighted fashion: $H = \\frac{\\sum_i h_i A_i}{\\sum_i A_i}$. This weighting is common in urban parameterizations to reflect the contribution of larger buildings to urban canopy properties. If there are no buildings (i.e., $\\sum_i A_i = 0$), we define $H = 0$ to avoid division by zero and to represent the absence of a canopy.\n\nHandling incomplete data proceeds via the following imputation logic:\n- Missing heights $h_i$ are imputed by first attempting a within-class median computed from known heights in the current grid cell. Medians are robust and avoid outlier bias. If the class has no known heights in the grid cell, we use class-typical heights informed by typical urban morphology: residential $h^{\\text{typ}}_{\\text{residential}} = 9$ meters (approximately three stories), commercial $h^{\\text{typ}}_{\\text{commercial}} = 18$ meters (mid-rise offices), and industrial $h^{\\text{typ}}_{\\text{industrial}} = 12$ meters (warehouse-type structures). These values are plausible and consistent with urban climatology settings.\n- Missing widths and lengths but known footprint area $A_i$ are reconstructed using $r_c = \\frac{w}{l}$ for the class. With $A_i = w_i l_i$ and $r_c = \\frac{w_i}{l_i}$, we solve for $w_i = \\sqrt{A_i r_c}$ and $l_i = \\sqrt{\\frac{A_i}{r_c}}$. Typical aspect ratios reflect footprint elongation by class: residential $r_{\\text{residential}} = 0.5$ (elongated row-house or apartment blocks), commercial $r_{\\text{commercial}} = 1.0$ (roughly square footprints), and industrial $r_{\\text{industrial}} = 0.25$ (elongated sheds).\n- Missing orientations $\\alpha_i$ invoke the angle-averaged projected width $\\overline{b_i} = \\frac{2(w_i + l_i)}{\\pi}$, which is grounded in the Cauchy projection theorem.\n\nAlgorithmic steps for one grid cell:\n1. Validate $A_{\\text{cell}} > 0$.\n2. Filter out any building with missing or nonpositive $A_i$. Compute $\\sum_i A_i$ for included buildings.\n3. Compute $\\lambda_p = \\frac{\\sum_i A_i}{A_{\\text{cell}}}$.\n4. For each building:\n   a. If $w_i$ and $l_i$ are both missing, reconstruct them using the class aspect ratio $r_c$ and building area $A_i$ via $w_i = \\sqrt{A_i r_c}$ and $l_i = \\sqrt{\\frac{A_i}{r_c}}$.\n   b. If $h_i$ is missing, impute using the within-class median over known $h_i$ in the current grid cell; if none exist, use $h^{\\text{typ}}_{c_i}$.\n   c. Compute the projected width: if $\\alpha_i$ is known, $b_i(\\phi) = \\left|w_i \\cos(\\alpha_i - \\phi)\\right| + \\left|l_i \\sin(\\alpha_i - \\phi)\\right|$; otherwise, use $\\overline{b_i} = \\frac{2(w_i + l_i)}{\\pi}$.\n   d. Compute $F_i(\\phi) = h_i\\, b_i(\\phi)$.\n5. Compute $\\lambda_f(\\phi) = \\frac{\\sum_i F_i(\\phi)}{A_{\\text{cell}}}$.\n6. Compute $H = \\frac{\\sum_i h_i A_i}{\\sum_i A_i}$ if $\\sum_i A_i > 0$; else set $H = 0$.\n7. Round $\\lambda_p$, $\\lambda_f$, and $H$ to six decimal places for output.\n\nThe test suite includes five cases designed to exercise the algorithm:\n- A complete-data case to verify the baseline computations.\n- A case with missing heights imputed by within-class median.\n- A case with missing orientations relying on the angle-averaged projection and a missing height imputed by class-typical value.\n- A case with missing widths and lengths reconstructed from footprint area and class aspect ratios, along with mixed missing orientation and height.\n- An edge case with no buildings to validate handling of zero sums and baseline outputs.\n\nThe program will implement these steps for each test case and produce a single line containing a list of lists, each inner list holding $[\\lambda_p,\\lambda_f,H]$ in that order, rounded to six decimal places, ensuring strict adherence to the specified format and units.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef reconstruct_dimensions(area, aspect_ratio):\n    \"\"\"\n    Reconstruct width and length from area and class-specific aspect ratio r = w / l.\n    Returns (w, l).\n    \"\"\"\n    w = np.sqrt(area * aspect_ratio)\n    l = np.sqrt(area / aspect_ratio)\n    return w, l\n\ndef mean_projected_width(w, l):\n    \"\"\"\n    Angle-averaged projected width (Cauchy projection): perimeter/pi for rectangles.\n    For a rectangle, perimeter = 2*(w + l), so mean width = 2*(w + l)/pi.\n    \"\"\"\n    return 2.0 * (w + l) / np.pi\n\ndef projected_width(w, l, alpha, phi):\n    \"\"\"\n    Projected width perpendicular to wind direction for a rectangle with orientation alpha.\n    b = |w * cos(alpha - phi)| + |l * sin(alpha - phi)|.\n    \"\"\"\n    d = alpha - phi\n    return abs(w * np.cos(d)) + abs(l * np.sin(d))\n\ndef impute_height(h, cls, class_heights_in_cell, typical_heights):\n    \"\"\"\n    Impute missing height:\n    - If h is not None, return h.\n    - Else, if there are known heights in this class in the grid, return their median.\n    - Else, return the class-typical height.\n    \"\"\"\n    if h is not None:\n        return h\n    known = class_heights_in_cell.get(cls, [])\n    if len(known) > 0:\n        return float(np.median(known))\n    return typical_heights[cls]\n\ndef compute_metrics_for_cell(cell):\n    \"\"\"\n    Compute lambda_p, lambda_f, H for a single grid cell.\n    cell: dict with keys:\n        - 'A_cell': float (grid cell area, m^2)\n        - 'phi': float (wind direction, radians)\n        - 'buildings': list of building dicts with keys:\n            'A', 'w', 'l', 'alpha', 'h', 'cls'\n    Returns (lambda_p, lambda_f, H).\n    \"\"\"\n    A_cell = cell['A_cell']\n    phi = cell['phi']\n    buildings = cell['buildings']\n\n    # Class-specific typical heights (m) and aspect ratios r = w/l\n    typical_heights = {\n        'residential': 9.0,\n        'commercial': 18.0,\n        'industrial': 12.0,\n    }\n    class_aspect_ratio = {\n        'residential': 0.5,\n        'commercial': 1.0,\n        'industrial': 0.25,\n    }\n\n    # Filter buildings with valid area\n    valid_buildings = []\n    for b in buildings:\n        A_i = b['A']\n        if A_i is None or A_i <= 0.0:\n            continue\n        valid_buildings.append(b)\n\n    # Pre-collect known heights by class for within-cell median imputation\n    class_heights_in_cell = {'residential': [], 'commercial': [], 'industrial': []}\n    for b in valid_buildings:\n        if b['h'] is not None:\n            class_heights_in_cell[b['cls']].append(b['h'])\n\n    # Sum of plan areas\n    sum_Ai = sum(b['A'] for b in valid_buildings)\n    lambda_p = (sum_Ai / A_cell) if A_cell > 0.0 else 0.0\n\n    # Compute frontal areas and weighted height sum\n    sum_F = 0.0\n    sum_hA = 0.0\n\n    for b in valid_buildings:\n        A_i = b['A']\n        w_i = b['w']\n        l_i = b['l']\n        alpha_i = b['alpha']\n        h_i = b['h']\n        cls = b['cls']\n\n        # Reconstruct dimensions if missing\n        if (w_i is None or l_i is None) and A_i is not None:\n            r_c = class_aspect_ratio[cls]\n            w_i, l_i = reconstruct_dimensions(A_i, r_c)\n\n        # Impute height if missing\n        h_i = impute_height(h_i, cls, class_heights_in_cell, typical_heights)\n\n        # Compute projected width\n        if alpha_i is None:\n            b_width = mean_projected_width(w_i, l_i)\n        else:\n            b_width = projected_width(w_i, l_i, alpha_i, phi)\n\n        F_i = h_i * b_width\n        sum_F += F_i\n        sum_hA += h_i * A_i\n\n    lambda_f = (sum_F / A_cell) if A_cell > 0.0 else 0.0\n    H = (sum_hA / sum_Ai) if sum_Ai > 0.0 else 0.0\n\n    return lambda_p, lambda_f, H\n\ndef format_triplet(triplet):\n    return \"[\" + \",\".join(f\"{x:.6f}\" for x in triplet) + \"]\"\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test case 1\n        {\n            'A_cell': 250000.0,\n            'phi': np.pi / 6.0,\n            'buildings': [\n                {'A': 1200.0, 'w': 30.0, 'l': 40.0, 'alpha': np.pi / 4.0, 'h': 20.0, 'cls': 'commercial'},\n                {'A': 800.0,  'w': 20.0, 'l': 40.0, 'alpha': np.pi / 3.0, 'h': 12.0, 'cls': 'residential'},\n            ],\n        },\n        # Test case 2\n        {\n            'A_cell': 250000.0,\n            'phi': np.pi / 3.0,\n            'buildings': [\n                {'A': 600.0, 'w': 15.0, 'l': 40.0, 'alpha': np.pi / 8.0, 'h': None, 'cls': 'residential'},\n                {'A': 500.0, 'w': 10.0, 'l': 50.0, 'alpha': np.pi / 5.0, 'h': 10.0, 'cls': 'residential'},\n                {'A': 900.0, 'w': 30.0, 'l': 30.0, 'alpha': np.pi / 6.0, 'h': 18.0, 'cls': 'commercial'},\n            ],\n        },\n        # Test case 3\n        {\n            'A_cell': 250000.0,\n            'phi': np.pi / 2.0,\n            'buildings': [\n                {'A': 2000.0, 'w': 25.0, 'l': 80.0, 'alpha': None, 'h': 15.0, 'cls': 'industrial'},\n                {'A': 600.0,  'w': 12.0, 'l': 50.0, 'alpha': None, 'h': None, 'cls': 'residential'},\n            ],\n        },\n        # Test case 4\n        {\n            'A_cell': 250000.0,\n            'phi': 0.0,\n            'buildings': [\n                {'A': 1000.0, 'w': None, 'l': None, 'alpha': np.pi / 4.0, 'h': 20.0, 'cls': 'commercial'},\n                {'A': 1500.0, 'w': None, 'l': None, 'alpha': None, 'h': None, 'cls': 'industrial'},\n            ],\n        },\n        # Test case 5\n        {\n            'A_cell': 250000.0,\n            'phi': np.pi / 2.0,\n            'buildings': [\n                # No buildings\n            ],\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        lp, lf, H = compute_metrics_for_cell(case)\n        results.append([lp, lf, H])\n\n    # Final print statement in the exact required format.\n    formatted = \"[\" + \",\".join(format_triplet(r) for r in results) + \"]\"\n    print(formatted)\n\nsolve()\n```"
        },
        {
            "introduction": "With the urban form numerically defined, the next critical step is to model its interaction with solar radiation, the primary energy source driving urban climate phenomena. This practice uses a physically-based analogy to Beer-Lambert's law to simulate how the urban canopy attenuates shortwave radiation and investigates the significant errors that can arise from sub-grid scale heterogeneity . By implementing this model, you will gain a quantitative understanding of a fundamental modeling challenge—why using averaged input parameters in non-linear systems often yields biased results, a concept explained by Jensen's inequality.",
            "id": "4107953",
            "problem": "Consider an urban grid cell in a Numerical Weather Prediction (NWP) model featuring a heterogeneous set of urban canyons characterized by the Frontal Area Index (FAI), denoted by $\\lambda_f$. The Frontal Area Index $\\lambda_f$ is defined as the total vertical frontal area of obstacles per unit horizontal ground area. In many Urban Canopy Parameterizations (UCP), radiative transfer of direct shortwave radiation is treated analogously to canopy radiative transfer, where attenuation of a collimated beam through a medium is governed by Beer–Lambert’s law. Let the downwelling direct shortwave irradiance at the top of the canopy be $S_{\\mathrm{in}}$ (in $\\mathrm{W\\,m^{-2}}$), with Solar Zenith Angle (SZA) $\\theta_0$ in degrees. Define $\\mu_0 = \\cos(\\theta_0)$, where $\\theta_0$ must be converted to radians before evaluating the cosine. Let $k_{\\mathrm{ext}}$ be an extinction coefficient that scales optical depth with $\\lambda_f$, and let $\\alpha_{\\mathrm{eff}}$ be an effective shortwave absorptivity of urban surfaces (dimensionless, between $0$ and $1$).\n\nFundamental base:\n- Beer–Lambert law for a collimated beam states that the transmitted irradiance $I$ after traversing optical depth $\\tau$ is $I = I_0 \\exp(-\\tau)$, where $I_0$ is the incident irradiance.\n- In a vertically oriented obstacle field, the projected path length through obstacles increases as the solar beam becomes more oblique, such that optical depth scales inversely with $\\mu_0$. In a parameterized urban canopy, it is common to relate optical depth to the Frontal Area Index via proportionality to $\\lambda_f$.\n\nTask:\n1. Starting from Beer–Lambert’s law and the proportionality between optical depth and $\\lambda_f$ with geometric scaling by $\\mu_0$, derive an expression for the canyon-level absorbed shortwave flux $A(\\lambda_f)$ (in $\\mathrm{W\\,m^{-2}}$) in terms of $S_{\\mathrm{in}}$, $\\alpha_{\\mathrm{eff}}$, $k_{\\mathrm{ext}}$, $\\mu_0$, and $\\lambda_f$. Assume first-order absorption without multiple reflections and treat $\\alpha_{\\mathrm{eff}}$ as the fraction of the beam removed by obstacles that is absorbed.\n2. For a subgrid distribution $\\{\\lambda_{f,i}, w_i\\}_{i=1}^N$ with weights $w_i$ that sum to $1$, define the mean Frontal Area Index $\\overline{\\lambda_f} = \\sum_{i=1}^N w_i \\lambda_{f,i}$ and the mean absorbed flux $\\overline{A} = \\sum_{i=1}^N w_i A(\\lambda_{f,i})$. Let $A_{\\mathrm{mean}} = A(\\overline{\\lambda_f})$. The bias induced by using the grid-mean $\\lambda_f$ instead of the distribution is $\\Delta = A_{\\mathrm{mean}} - \\overline{A}$.\n3. Implement a program that, for the test suite below, computes $\\Delta$ in $\\mathrm{W\\,m^{-2}}$ for each test case. Angles must be interpreted in degrees, but convert to radians before evaluating $\\cos(\\theta_0)$ to obtain $\\mu_0$. If $\\mu_0$ is extremely small, use a small positive floor to avoid division by zero. Express each bias in $\\mathrm{W\\,m^{-2}}$ as a decimal rounded to three decimal places.\n\nTest suite (each case specifies $S_{\\mathrm{in}}$ in $\\mathrm{W\\,m^{-2}}$, $\\alpha_{\\mathrm{eff}}$, $k_{\\mathrm{ext}}$, $\\theta_0$ in degrees, the list of $\\lambda_{f,i}$ values, and the corresponding weights $w_i$):\n- Case $1$: $S_{\\mathrm{in}} = 850$, $\\alpha_{\\mathrm{eff}} = 0.7$, $k_{\\mathrm{ext}} = 1.0$, $\\theta_0 = 40$, $\\lambda_{f}$ values $[0.3, 0.6, 1.0]$, weights $[0.5, 0.3, 0.2]$.\n- Case $2$: $S_{\\mathrm{in}} = 1000$, $\\alpha_{\\mathrm{eff}} = 0.8$, $k_{\\mathrm{ext}} = 1.2$, $\\theta_0 = 0$, $\\lambda_{f}$ values $[0.0, 1.5]$, weights $[0.5, 0.5]$.\n- Case $3$: $S_{\\mathrm{in}} = 600$, $\\alpha_{\\mathrm{eff}} = 0.7$, $k_{\\mathrm{ext}} = 1.0$, $\\theta_0 = 80$, $\\lambda_{f}$ values $[0.2, 0.8, 1.6, 2.4]$, weights $[0.4, 0.3, 0.2, 0.1]$.\n- Case $4$: $S_{\\mathrm{in}} = 900$, $\\alpha_{\\mathrm{eff}} = 0.75$, $k_{\\mathrm{ext}} = 0.9$, $\\theta_0 = 30$, $\\lambda_{f}$ values $[0.7, 0.7, 0.7]$, weights $[0.2, 0.3, 0.5]$.\n- Case $5$: $S_{\\mathrm{in}} = 750$, $\\alpha_{\\mathrm{eff}} = 0.65$, $k_{\\mathrm{ext}} = 1.4$, $\\theta_0 = 60$, $\\lambda_{f}$ values $[0.1, 0.5, 1.0, 1.8]$, weights $[0.25, 0.25, 0.25, 0.25]$.\n\nFinal output format:\nYour program should produce a single line of output containing the biases for all five test cases as a comma-separated list enclosed in square brackets (for example, $[b_1,b_2,b_3,b_4,b_5]$), where each $b_i$ is the bias $\\Delta$ for the corresponding case expressed in $\\mathrm{W\\,m^{-2}}$ rounded to three decimal places.",
            "solution": "The problem requires the derivation of an expression for absorbed shortwave radiation in an urban canopy and its use to compute the bias arising from using a grid-mean parameter instead of a sub-grid distribution.\n\n### Part 1: Derivation of the Absorbed Shortwave Flux $A(\\lambda_f)$\n\nThe derivation proceeds from the fundamental principles provided.\n\n1.  **Beer–Lambert Law**: The transmission of a collimated beam of radiation through a medium is described by the Beer–Lambert law. The irradiance transmitted, $S_{\\mathrm{trans}}$, through the urban canopy is given by:\n    $$S_{\\mathrm{trans}} = S_{\\mathrm{in}} \\exp(-\\tau)$$\n    where $S_{\\mathrm{in}}$ is the incident direct shortwave irradiance at the top of the canopy and $\\tau$ is the optical depth of the canopy.\n\n2.  **Optical Depth ($\\tau$) Formulation**: The problem states that the optical depth, $\\tau$, is proportional to the Frontal Area Index, $\\lambda_f$, with a proportionality constant $k_{\\mathrm{ext}}$ (the extinction coefficient). It also incorporates a geometric scaling factor that accounts for the path length of the solar beam through the vertically-oriented obstacles. This path length is inversely proportional to $\\mu_0 = \\cos(\\theta_0)$, where $\\theta_0$ is the solar zenith angle. A smaller $\\mu_0$ (sun lower in the sky) corresponds to a longer path through the obstacles, and thus a larger optical depth. Combining these effects, the optical depth is expressed as:\n    $$\\tau(\\lambda_f, \\mu_0) = \\frac{k_{\\mathrm{ext}} \\lambda_f}{\\mu_0}$$\n\n3.  **Attenuated (Removed) Flux**: The portion of the incident flux that is attenuated (i.e., intercepted by the obstacles) is the difference between the incident and transmitted flux:\n    $$S_{\\mathrm{removed}} = S_{\\mathrm{in}} - S_{\\mathrm{trans}} = S_{\\mathrm{in}} - S_{\\mathrm{in}} \\exp(-\\tau) = S_{\\mathrm{in}} (1 - \\exp(-\\tau))$$\n\n4.  **Absorbed Flux**: The problem specifies that the effective absorptivity, $\\alpha_{\\mathrm{eff}}$, is the fraction of the *removed* beam that is absorbed. Therefore, the total absorbed flux, $A$, is $\\alpha_{\\mathrm{eff}}$ multiplied by the removed flux, $S_{\\mathrm{removed}}$. This models a first-order absorption process, neglecting multiple reflections between surfaces.\n    $$A(\\lambda_f) = \\alpha_{\\mathrm{eff}} \\cdot S_{\\mathrm{removed}} = \\alpha_{\\mathrm{eff}} S_{\\mathrm{in}} (1 - \\exp(-\\tau))$$\n    Substituting the expression for $\\tau$, we arrive at the final expression for the canyon-level absorbed shortwave flux as a function of $\\lambda_f$ and the other parameters:\n    $$A(\\lambda_f) = \\alpha_{\\mathrm{eff}} S_{\\mathrm{in}} \\left( 1 - \\exp\\left(-\\frac{k_{\\mathrm{ext}} \\lambda_f}{\\mu_0}\\right) \\right)$$\n\n### Part 2: Calculation of the Bias $\\Delta$\n\nThe bias, $\\Delta$, arises from the nonlinearity of the function $A(\\lambda_f)$. The function $A(\\lambda_f)$ is a concave function of $\\lambda_f$, which can be verified by examining its second derivative with respect to $\\lambda_f$:\n$$\\frac{\\partial A}{\\partial \\lambda_f} = \\alpha_{\\mathrm{eff}} S_{\\mathrm{in}} \\left(\\frac{k_{\\mathrm{ext}}}{\\mu_0}\\right) \\exp\\left(-\\frac{k_{\\mathrm{ext}} \\lambda_f}{\\mu_0}\\right)$$\n$$\\frac{\\partial^2 A}{\\partial \\lambda_f^2} = -\\alpha_{\\mathrm{eff}} S_{\\mathrm{in}} \\left(\\frac{k_{\\mathrm{ext}}}{\\mu_0}\\right)^2 \\exp\\left(-\\frac{k_{\\mathrm{ext}} \\lambda_f}{\\mu_0}\\right)$$\nSince all parameters ($S_{\\mathrm{in}}$, $\\alpha_{\\mathrm{eff}}$, $k_{\\mathrm{ext}}$) are positive and $\\mu_0$ is positive for $\\theta_0 \\in [0, 90^\\circ)$, the second derivative is strictly negative. This confirms that $A(\\lambda_f)$ is a concave function.\n\nFor any concave function $f(x)$, Jensen's inequality states that $E[f(x)] \\le f(E[x])$, where $E[\\cdot]$ denotes the expected value. In our context, this translates to:\n$$ \\sum_{i=1}^N w_i A(\\lambda_{f,i}) \\le A\\left(\\sum_{i=1}^N w_i \\lambda_{f,i}\\right) $$\nThe term on the left is defined as the true mean absorbed flux, $\\overline{A}$, and the term on the right is the absorbed flux calculated from the mean Frontal Area Index, $A_{\\mathrm{mean}} = A(\\overline{\\lambda_f})$.\n$$\\overline{A} \\le A_{\\mathrm{mean}}$$\nThe bias $\\Delta$ is defined as $\\Delta = A_{\\mathrm{mean}} - \\overline{A}$. Due to the concavity of the function $A(\\lambda_f)$, this bias will always be non-negative, $\\Delta \\ge 0$. It is zero only if the distribution of $\\lambda_f$ has zero variance (i.e., all $\\lambda_{f,i}$ are identical) or if the function $A(\\lambda_f)$ were linear over the range of $\\lambda_{f,i}$ values, which is not the case here.\n\nThe calculation steps for each test case are as follows:\n1.  Calculate $\\mu_0 = \\cos(\\theta_0)$, ensuring $\\theta_0$ is converted from degrees to radians. A floor value is used for $\\mu_0$ to prevent division by zero for near-grazing angles, although it is not strictly necessary for the given test cases.\n2.  Calculate the mean Frontal Area Index, $\\overline{\\lambda_f} = \\sum_{i=1}^N w_i \\lambda_{f,i}$.\n3.  Calculate $A_{\\mathrm{mean}}$ by applying the derived function $A$ to the mean FAI: $A_{\\mathrm{mean}} = A(\\overline{\\lambda_f})$.\n4.  Calculate the true mean absorbed flux, $\\overline{A}$, by computing $A(\\lambda_{f,i})$ for each element of the subgrid distribution, weighting it by $w_i$, and summing the results: $\\overline{A} = \\sum_{i=1}^N w_i A(\\lambda_{f,i})$.\n5.  Compute the bias: $\\Delta = A_{\\mathrm{mean}} - \\overline{A}$.\n6.  Round the final result to three decimal places.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the bias in absorbed shortwave flux due to averaging the Frontal Area Index.\n    \"\"\"\n    test_cases = [\n        {'S_in': 850, 'alpha_eff': 0.7, 'k_ext': 1.0, 'theta_0': 40, 'lambda_f': [0.3, 0.6, 1.0], 'weights': [0.5, 0.3, 0.2]},\n        {'S_in': 1000, 'alpha_eff': 0.8, 'k_ext': 1.2, 'theta_0': 0, 'lambda_f': [0.0, 1.5], 'weights': [0.5, 0.5]},\n        {'S_in': 600, 'alpha_eff': 0.7, 'k_ext': 1.0, 'theta_0': 80, 'lambda_f': [0.2, 0.8, 1.6, 2.4], 'weights': [0.4, 0.3, 0.2, 0.1]},\n        {'S_in': 900, 'alpha_eff': 0.75, 'k_ext': 0.9, 'theta_0': 30, 'lambda_f': [0.7, 0.7, 0.7], 'weights': [0.2, 0.3, 0.5]},\n        {'S_in': 750, 'alpha_eff': 0.65, 'k_ext': 1.4, 'theta_0': 60, 'lambda_f': [0.1, 0.5, 1.0, 1.8], 'weights': [0.25, 0.25, 0.25, 0.25]},\n    ]\n\n    results = []\n\n    def calculate_absorbed_flux(lambda_f, S_in, alpha_eff, k_ext, mu_0):\n        \"\"\"\n        Calculates the canyon-level absorbed shortwave flux A(lambda_f).\n        \n        Args:\n            lambda_f (float or np.ndarray): Frontal Area Index.\n            S_in (float): Incoming shortwave radiation.\n            alpha_eff (float): Effective absorptivity.\n            k_ext (float): Extinction coefficient.\n            mu_0 (float): Cosine of the solar zenith angle.\n        \n        Returns:\n            float or np.ndarray: Absorbed shortwave flux.\n        \"\"\"\n        exponent = -k_ext * lambda_f / mu_0\n        return alpha_eff * S_in * (1.0 - np.exp(exponent))\n\n    for case in test_cases:\n        S_in = case['S_in']\n        alpha_eff = case['alpha_eff']\n        k_ext = case['k_ext']\n        theta_0 = case['theta_0']\n        lambda_f_values = np.array(case['lambda_f'])\n        weights = np.array(case['weights'])\n\n        # Calculate mu_0 = cos(theta_0), with floor for stability\n        mu_0 = np.cos(np.deg2rad(theta_0))\n        mu_0 = np.maximum(mu_0, 1e-6) # Use a small positive floor as per problem description\n\n        # Calculate the mean Frontal Area Index\n        lambda_f_bar = np.dot(lambda_f_values, weights)\n        \n        # Calculate A_mean = A(lambda_f_bar)\n        A_mean = calculate_absorbed_flux(lambda_f_bar, S_in, alpha_eff, k_ext, mu_0)\n        \n        # Calculate A_bar = sum(w_i * A(lambda_f_i))\n        A_values = calculate_absorbed_flux(lambda_f_values, S_in, alpha_eff, k_ext, mu_0)\n        A_bar = np.dot(A_values, weights)\n        \n        # Calculate the bias\n        bias = A_mean - A_bar\n        \n        results.append(round(bias, 3))\n\n    # Format and print the final output\n    formatted_results = [f\"{r:.3f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "After energy is absorbed by urban surfaces, the exchange of heat and mass between the street canyon and the overlying atmosphere becomes paramount in determining air temperature and pollutant concentrations. This final practice focuses on the dynamics of canyon ventilation, guiding you to derive a bulk parameterization from the first principles of turbulent shear-layer entrainment . Through this exercise, you will learn how complex fluid dynamics are distilled into practical metrics like exchange velocity ($U_e$) and timescale ($\\tau$), which are essential for assessing a canyon's ability to dissipate thermal energy and pollutants.",
            "id": "4107945",
            "problem": "An urban street canyon of width $W$ and building height $H$ is ventilated by turbulent exchange across the roof-level shear layer driven by a free-stream wind speed above roof level $U_{\\mathrm{top}}$. In the skimming-flow regime, the canyon interior is largely decoupled from the overlying flow, and the roof-level shear layer entrains canyon air at a rate that can be represented by a bulk exchange velocity $U_e$ normal to the roof-level interface. Starting from conservation of mass applied to a two-compartment canyon–atmosphere system and the concept of turbulent shear-layer entrainment, derive a bulk parameterization for $U_e$ in terms of $U_{\\mathrm{top}}$, $H$, $W$, and a dimensionless entrainment coefficient $E_0$ characteristic of turbulent mixing layers. Assume that the scalar exchange is controlled by the shear layer over a single street of unit length, that the interface area per unit street length equals $W$, that the canyon volume per unit street length equals $H W$, and that the mean velocity difference across the shear layer satisfies $\\Delta U \\approx U_{\\mathrm{top}}$ in skimming flow. For deep canyons, justify a geometry dependence of the entrainment coefficient that scales as $E \\sim E_0 \\, (W/H)$, where $E_0$ is a constant of order $10^{-1}$ reflecting the canonical turbulent mixing-layer entrainment rate.\n\nUsing the derived parameterization with $E_0 = 0.08$, compute the numerical value of the bulk exchange velocity for $U_{\\mathrm{top}} = 6\\,\\mathrm{m\\,s^{-1}}$ and aspect ratio $H/W = 2.5$. Then, for a representative street width $W = 20\\,\\mathrm{m}$, estimate the exchange timescale $\\tau = H/U_e$ for heat and moisture ventilation. Express $U_e$ in $\\mathrm{m\\,s^{-1}}$ and $\\tau$ in $\\mathrm{s}$. Round both numerical answers to three significant figures.",
            "solution": "The problem is first validated to ensure it is scientifically grounded, well-posed, and all necessary information is provided.\n\n**Step 1: Extract Givens**\n-   Canyon width: $W$\n-   Building height: $H$\n-   Free-stream wind speed above roof level: $U_{\\mathrm{top}}$\n-   Flow regime: Skimming-flow\n-   Bulk exchange velocity: $U_e$\n-   Interface area per unit street length: $A = W$\n-   Canyon volume per unit street length: $V = HW$\n-   Mean velocity difference across the shear layer: $\\Delta U \\approx U_{\\mathrm{top}}$\n-   Dimensionless entrainment coefficient for a canonical mixing layer: $E_0$ (of order $10^{-1}$)\n-   Geometry dependence for the effective entrainment coefficient in deep canyons: $E \\sim E_0 \\, (W/H)$\n-   Numerical value for the coefficient: $E_0 = 0.08$\n-   Numerical value for the wind speed: $U_{\\mathrm{top}} = 6\\,\\mathrm{m\\,s^{-1}}$\n-   Numerical value for the aspect ratio: $H/W = 2.5$\n-   Definition of exchange timescale: $\\tau = H/U_e$\n-   Numerical value for street width for timescale calculation: $W = 20\\,\\mathrm{m}$\n-   Required precision: Round final numerical answers to three significant figures.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded in the principles of fluid dynamics, specifically turbulent shear-layer entrainment, and its application to urban micrometeorology. These are standard and well-established concepts in atmospheric science and environmental engineering. The problem is well-posed, providing a clear path from a theoretical derivation to a numerical calculation with all necessary data and definitions. The language is objective and technical. The provided numerical values are physically realistic for an urban environment. The scaling relationship for the entrainment coefficient is a common hypothesis in single-layer urban canopy models for deep canyons. Therefore, the problem is deemed valid.\n\n**Step 3: Verdict and Action**\nThe problem is valid. A complete solution will be provided.\n\n**Derivation of the Bulk Parameterization**\nWe begin by considering the conservation of mass for a passive scalar with mean concentration $C_c$ within the street canyon. The total mass of the scalar per unit length of the street is $M = C_c V$, where $V = HW$ is the canyon volume per unit length. The rate of change of this mass is determined by the net flux across the roof-level interface of area $A = W$ per unit length.\n$$\n\\frac{d(C_c V)}{dt} = -F_{\\mathrm{net}}\n$$\nAssuming $V$ is constant, this becomes:\n$$\nV \\frac{dC_c}{dt} = -F_{\\mathrm{net}}\n$$\nThe net flux, $F_{\\mathrm{net}}$, is due to the turbulent exchange of air between the canyon and the atmosphere above. This exchange can be parameterized by a volumetric flow rate, $Q$, exchanging canyon air (concentration $C_c$) with atmospheric air (concentration $C_a$).\n$$\nF_{\\mathrm{net}} = Q(C_c - C_a)\n$$\nThe volumetric flow rate $Q$ is defined in terms of a bulk exchange velocity, $U_e$, and the interface area $A$:\n$$\nQ = U_e A\n$$\nThe physical mechanism driving this exchange is the entrainment of canyon air into the turbulent shear layer at the roof level. The volumetric entrainment rate, $Q_{\\mathrm{entrain}}$, is known from fluid dynamics principles to be proportional to the velocity difference across the shear layer, $\\Delta U$, and the area of the layer, $A$. The constant of proportionality is the dimensionless entrainment coefficient, $E$.\n$$\nQ_{\\mathrm{entrain}} = E \\, \\Delta U \\, A\n$$\nBy identifying the parameterized exchange rate $Q$ with the physical entrainment rate $Q_{\\mathrm{entrain}}$, we have:\n$$\nU_e A = E \\, \\Delta U \\, A\n$$\nThis simplifies to a direct relationship for the bulk exchange velocity:\n$$\nU_e = E \\, \\Delta U\n$$\nThe problem specifies that for the skimming-flow regime, the velocity difference across the layer can be approximated by the free-stream wind speed above the canyon, $\\Delta U \\approx U_{\\mathrm{top}}$.\n$$\nU_e = E \\, U_{\\mathrm{top}}\n$$\nNext, we incorporate the geometry dependence for deep canyons. The problem states that the effective entrainment coefficient $E$ for the entire canyon scales with the canonical mixing-layer coefficient $E_0$ and the canyon aspect ratio. The justification for the given scaling, $E \\sim E_0 (W/H)$, is that while the fundamental entrainment process (characterized by $E_0$) occurs at the roof-level shear layer, its ability to ventilate the *entire* canyon volume $V=HW$ is diminished in deep, narrow canyons. The efficiency of the exchange is thus inversely proportional to the aspect ratio $H/W$.\nSubstituting this geometric scaling, $E = E_0 \\left(\\frac{W}{H}\\right)$, into our expression for $U_e$ yields the final derived parameterization:\n$$\nU_e = E_0 \\left(\\frac{W}{H}\\right) U_{\\mathrm{top}}\n$$\n**Numerical Calculation**\nWe are asked to compute the numerical value of $U_e$ and the exchange timescale $\\tau$.\n\nFirst, we calculate $U_e$. The given parameters are:\n-   $E_0 = 0.08$\n-   $U_{\\mathrm{top}} = 6\\,\\mathrm{m\\,s^{-1}}$\n-   Aspect ratio $H/W = 2.5$. This implies the inverse ratio is $W/H = \\frac{1}{2.5} = 0.4$.\n\nSubstituting these values into the derived parameterization:\n$$\nU_e = (0.08) \\times (0.4) \\times (6\\,\\mathrm{m\\,s^{-1}})\n$$\n$$\nU_e = 0.032 \\times 6\\,\\mathrm{m\\,s^{-1}} = 0.192\\,\\mathrm{m\\,s^{-1}}\n$$\nThis value is already at three significant figures.\n\nNext, we calculate the exchange timescale $\\tau = H/U_e$. For this calculation, we are given a representative street width $W = 20\\,\\mathrm{m}$. Using the aspect ratio $H/W = 2.5$, we find the building height:\n$$\nH = 2.5 \\times W = 2.5 \\times 20\\,\\mathrm{m} = 50\\,\\mathrm{m}\n$$\nNow, we can compute $\\tau$ using the calculated value of $U_e$:\n$$\n\\tau = \\frac{H}{U_e} = \\frac{50\\,\\mathrm{m}}{0.192\\,\\mathrm{m\\,s^{-1}}} \\approx 260.4166\\ldots\\,\\mathrm{s}\n$$\nRounding this result to three significant figures gives:\n$$\n\\tau \\approx 260\\,\\mathrm{s}\n$$\nThe final numerical answers are $U_e = 0.192\\,\\mathrm{m\\,s^{-1}}$ and $\\tau = 260\\,\\mathrm{s}$.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 0.192 & 260 \\end{pmatrix}}\n$$"
        }
    ]
}