{
    "hands_on_practices": [
        {
            "introduction": "The stability of a numerical scheme is paramount for obtaining physically meaningful solutions. This first practice establishes a foundational skill by tasking you with deriving the famous Courant-Friedrichs-Lewy (CFL) condition for a simple advection equation. By performing a Von Neumann stability analysis on the leapfrog scheme, you will determine the maximum allowable time step, a critical constraint that governs the design of all explicit time-stepping models. ",
            "id": "4019533",
            "problem": "Consider tracer advection in the Bryan–Cox–Semtner ocean model architecture along a one-dimensional, uniformly spaced zonal transect with periodic boundaries. The tracer concentration $q(x,t)$ satisfies the linear advection equation $\\partial q / \\partial t + U \\, \\partial q / \\partial x = 0$ with constant zonal velocity $U$. The model employs a leapfrog time-stepping scheme on a uniform grid of spacing $\\Delta x$ and time step $\\Delta t$, with centered spatial differencing for the advective flux. Using a Von Neumann Fourier stability analysis and starting from the partial differential equation and its leapfrog, centered-in-space discretization, derive the maximum allowable time step $\\Delta t_{\\max}$ such that the scheme remains stable for all resolvable wavenumbers on the grid. Express your final answer as a single closed-form analytic expression in seconds, without using an inequality or an equation.",
            "solution": "The problem requires the derivation of the maximum stable time step, $\\Delta t_{\\max}$, for the one-dimensional linear advection equation using a leapfrog time-stepping scheme and a centered spatial differencing scheme. The analysis will be performed using the Von Neumann Fourier stability method.\n\nThe governing partial differential equation (PDE) for the tracer concentration $q(x,t)$ is the linear advection equation:\n$$\n\\frac{\\partial q}{\\partial t} + U \\frac{\\partial q}{\\partial x} = 0\n$$\nwhere $U$ is a constant velocity.\n\nWe discretize this equation on a uniform grid with spatial step $\\Delta x$ and time step $\\Delta t$. Let $q_j^n$ represent the numerical approximation of $q(j\\Delta x, n\\Delta t)$.\n\nThe leapfrog scheme is used for the time derivative, which is a centered difference approximation around time level $n$:\n$$\n\\frac{\\partial q}{\\partial t} \\approx \\frac{q_j^{n+1} - q_j^{n-1}}{2\\Delta t}\n$$\nThe centered spatial differencing scheme is used for the advection term at time level $n$:\n$$\n\\frac{\\partial q}{\\partial x} \\approx \\frac{q_{j+1}^n - q_{j-1}^n}{2\\Delta x}\n$$\nSubstituting these approximations into the PDE gives the finite difference equation:\n$$\n\\frac{q_j^{n+1} - q_j^{n-1}}{2\\Delta t} + U \\frac{q_{j+1}^n - q_{j-1}^n}{2\\Delta x} = 0\n$$\nWe can rearrange this to solve for $q_j^{n+1}$:\n$$\nq_j^{n+1} = q_j^{n-1} - \\frac{U \\Delta t}{\\Delta x} (q_{j+1}^n - q_{j-1}^n)\n$$\n\nFor the Von Neumann stability analysis, we consider a single Fourier mode as a solution to the finite difference equation:\n$$\nq_j^n = G^n \\exp(i k j \\Delta x)\n$$\nHere, $k$ is the wavenumber, $i$ is the imaginary unit, and $G$ is the amplification factor per time step. For the scheme to be stable, the magnitude of the amplification factor must satisfy $|G| \\le 1$ for all resolvable wavenumbers $k$. For a multi-level scheme like leapfrog, if any root has magnitude $1$, it must be a simple root.\n\nSubstituting the Fourier mode solution into the finite difference equation:\n$$\n\\frac{G^{n+1}\\exp(ikj\\Delta x) - G^{n-1}\\exp(ikj\\Delta x)}{2\\Delta t} + U \\frac{G^n\\exp(ik(j+1)\\Delta x) - G^n\\exp(ik(j-1)\\Delta x)}{2\\Delta x} = 0\n$$\nWe can factor out the common term $G^{n-1} \\exp(ikj\\Delta x)$:\n$$\n\\frac{G^2 - 1}{2\\Delta t} + U \\frac{G\\exp(ik\\Delta x) - G\\exp(-ik\\Delta x)}{2\\Delta x} = 0\n$$\nUsing Euler's formula, $\\exp(i\\theta) - \\exp(-i\\theta) = 2i\\sin(\\theta)$, the spatial difference term becomes:\n$$\n\\exp(ik\\Delta x) - \\exp(-ik\\Delta x) = 2i\\sin(k\\Delta x)\n$$\nSubstituting this back into the equation yields:\n$$\n\\frac{G^2 - 1}{2\\Delta t} + U \\frac{G(2i\\sin(k\\Delta x))}{2\\Delta x} = 0\n$$\nMultiplying by $2\\Delta t$ and rearranging gives:\n$$\nG^2 - 1 + 2iG \\left( \\frac{U \\Delta t}{\\Delta x} \\sin(k\\Delta x) \\right) = 0\n$$\nLet's define the Courant number, $C$, as $C = \\frac{U \\Delta t}{\\Delta x}$. The equation for the amplification factor $G$ becomes a quadratic equation:\n$$\nG^2 + 2i(C\\sin(k\\Delta x))G - 1 = 0\n$$\nThe roots of this quadratic equation $aG^2+bG+c=0$ are given by $G = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}$. Here, $a=1$, $b=2iC\\sin(k\\Delta x)$, and $c=-1$.\n$$\nG = \\frac{-2iC\\sin(k\\Delta x) \\pm \\sqrt{(2iC\\sin(k\\Delta x))^2 - 4(1)(-1)}}{2}\n$$\n$$\nG = -iC\\sin(k\\Delta x) \\pm \\sqrt{-4C^2\\sin^2(k\\Delta x) + 4}/2\n$$\n$$\nG = -iC\\sin(k\\Delta x) \\pm \\sqrt{1 - C^2\\sin^2(k\\Delta x)}\n$$\nThe stability of the scheme depends on the term inside the square root.\n\nCase 1: $1 - C^2\\sin^2(k\\Delta x) \\ge 0$.\nIn this case, the square root is real. Let $\\alpha = C\\sin(k\\Delta x)$ and $\\beta = \\sqrt{1-\\alpha^2}$. The roots are $G = -i\\alpha \\pm \\beta$. The magnitude of the roots is:\n$$\n|G|^2 = (-\\alpha)^2 + (\\pm \\beta)^2 = \\alpha^2 + \\beta^2 = C^2\\sin^2(k\\Delta x) + (1 - C^2\\sin^2(k\\Delta x)) = 1\n$$\nSo, $|G| = 1$. The roots lie on the unit circle, meaning the scheme is neutrally stable and does not amplify errors. This is the condition for stability. This condition must hold for all possible wavenumbers.\n\nCase 2: $1 - C^2\\sin^2(k\\Delta x)  0$.\nIn this case, the square root is imaginary. Let the roots be:\n$$\nG = -iC\\sin(k\\Delta x) \\pm i\\sqrt{C^2\\sin^2(k\\Delta x) - 1}\n$$\nThe two roots are purely imaginary: $G_{\\pm} = -i \\left( C\\sin(k\\Delta x) \\mp \\sqrt{C^2\\sin^2(k\\Delta x) - 1} \\right)$.\nThe product of the roots is $G_+ G_- = (-1)(-i)^2(\\dots) = -1$. Thus, $|G_+||G_-|=1$.\nIf $|C\\sin(k\\Delta x)|  1$, then $\\sqrt{C^2\\sin^2(k\\Delta x) - 1}$ is a positive real number. One of the roots will have a magnitude greater than $1$. For example, if $C\\sin(k\\Delta x)  1$, then $|G_-|  1$. This leads to exponential growth of the solution, so the scheme is unstable.\n\nTherefore, for the scheme to be stable, we must satisfy the condition from Case 1 for all resolvable wavenumbers $k$:\n$$\nC^2\\sin^2(k\\Delta x) \\le 1\n$$\nTaking the square root gives:\n$$\n|C\\sin(k\\Delta x)| \\le 1\n$$\nThis inequality must hold for the worst-case scenario, which is the wavenumber $k$ that maximizes the term $|\\sin(k\\Delta x)|$. The range of resolvable waves on the grid corresponds to a phase angle $k\\Delta x$ in the interval $[-\\pi, \\pi]$. The maximum value of $|\\sin(k\\Delta x)|$ over this interval is $1$, which occurs at $k\\Delta x = \\pm \\frac{\\pi}{2}$.\n\nSubstituting this maximum value into the stability criterion gives the most restrictive condition:\n$$\n|C| \\cdot 1 \\le 1 \\implies |C| \\le 1\n$$\nSubstituting back the definition of the Courant number, $C = \\frac{U\\Delta t}{\\Delta x}$:\n$$\n\\left| \\frac{U\\Delta t}{\\Delta x} \\right| \\le 1\n$$\nSince $\\Delta x$ and $\\Delta t$ are positive physical quantities, this simplifies to:\n$$\n\\frac{|U|\\Delta t}{\\Delta x} \\le 1\n$$\nSolving for $\\Delta t$ gives the stability limit:\n$$\n\\Delta t \\le \\frac{\\Delta x}{|U|}\n$$\nThe maximum allowable time step, $\\Delta t_{\\max}$, is the upper bound of this inequality.\n$$\n\\Delta t_{\\max} = \\frac{\\Delta x}{|U|}\n$$\nThis is the Courant-Friedrichs-Lewy (CFL) condition for the one-dimensional linear advection equation with a leapfrog time scheme and centered spatial differences. The expression has units of length divided by speed, resulting in units of time, as requested.",
            "answer": "$$\\boxed{\\frac{\\Delta x}{|U|}}$$"
        },
        {
            "introduction": "Having explored the basic CFL condition, we now apply this analysis to a process that fundamentally shapes the Bryan-Cox-Semtner architecture. The extremely high speed of external (barotropic) gravity waves would impose a prohibitively small time step on a fully explicit ocean model. This exercise demonstrates why, by guiding you to derive the stringent stability limit for these waves, revealing the crucial motivation for the 'mode-splitting' technique where the barotropic mode is treated separately and implicitly. ",
            "id": "4019553",
            "problem": "Consider the linearized one-dimensional barotropic subsystem of the Bryan–Cox–Semtner (BCS) ocean model architecture with constant depth $H$, gravity $g$, and uniform grid spacing $\\Delta x$ on an Arakawa C-grid. The prognostic variables are the along-channel velocity $u(x,t)$ staggered at cell faces and the free-surface displacement $\\eta(x,t)$ staggered at cell centers. Neglect planetary rotation, bottom friction, and any forcing, and assume periodic boundary conditions. The continuous governing equations are the linear shallow-water equations\n$$\n\\frac{\\partial u}{\\partial t} = - g \\frac{\\partial \\eta}{\\partial x}, \\qquad \\frac{\\partial \\eta}{\\partial t} = - H \\frac{\\partial u}{\\partial x}.\n$$\nThe barotropic mode in many BCS implementations is advanced explicitly with a forward–backward time-differencing scheme and centered spatial differences on the C-grid:\n$$\nu^{n+\\frac{1}{2}}_{j+\\frac{1}{2}} = u^{n-\\frac{1}{2}}_{j+\\frac{1}{2}} - g \\,\\Delta t \\,\\frac{\\eta^{n}_{j+1} - \\eta^{n}_{j}}{\\Delta x},\n$$\n$$\n\\eta^{n+1}_{j} = \\eta^{n}_{j} - H \\,\\Delta t \\,\\frac{u^{n+\\frac{1}{2}}_{j+\\frac{1}{2}} - u^{n+\\frac{1}{2}}_{j-\\frac{1}{2}}}{\\Delta x},\n$$\nwhere $j$ indexes grid cells, $n$ indexes integer time levels for $\\eta$, and $n \\pm \\tfrac{1}{2}$ index half time levels for $u$. Using a von Neumann normal mode analysis with trial solutions $u^{n+\\frac{1}{2}}_{j+\\frac{1}{2}} = \\hat{u}^{n+\\frac{1}{2}} \\exp\\!\\big(i k (j+\\tfrac{1}{2}) \\Delta x\\big)$ and $\\eta^{n}_{j} = \\hat{\\eta}^{n} \\exp\\!\\big(i k j \\Delta x\\big)$, determine the closed-form stability limit for the explicit barotropic time step $\\Delta t_{\\max}$ as a function of $H$, $\\Delta x$, and $g$. Express the final time-step limit in seconds. Do not approximate your final expression.\n\nFinally, briefly explain, based on your derived condition, how the implicit or elliptic treatment of the barotropic mode in the Bryan–Cox–Semtner (BCS) ocean model circumvents this explicit stability constraint without altering the physical wave speed.\n\nYour final answer must be a single analytical expression. No rounding is required.",
            "solution": "The starting point is the linear shallow-water system,\n$$\n\\frac{\\partial u}{\\partial t} = - g \\frac{\\partial \\eta}{\\partial x}, \\qquad \\frac{\\partial \\eta}{\\partial t} = - H \\frac{\\partial u}{\\partial x},\n$$\nwhich supports non-dispersive barotropic gravity waves with phase speed $c = \\sqrt{g H}$. On an Arakawa C-grid, we discretize with the forward–backward time-stepping scheme and centered spatial differences:\n$$\nu^{n+\\frac{1}{2}}_{j+\\frac{1}{2}} = u^{n-\\frac{1}{2}}_{j+\\frac{1}{2}} - g \\,\\Delta t \\,\\frac{\\eta^{n}_{j+1} - \\eta^{n}_{j}}{\\Delta x},\n$$\n$$\n\\eta^{n+1}_{j} = \\eta^{n}_{j} - H \\,\\Delta t \\,\\frac{u^{n+\\frac{1}{2}}_{j+\\frac{1}{2}} - u^{n+\\frac{1}{2}}_{j-\\frac{1}{2}}}{\\Delta x}.\n$$\nWe perform a von Neumann (Fourier) stability analysis by substituting normal modes:\n$$\n\\eta^{n}_{j} = A^{n} \\exp\\!\\big(i k j \\Delta x\\big), \\qquad u^{n+\\frac{1}{2}}_{j+\\frac{1}{2}} = B^{n+\\frac{1}{2}} \\exp\\!\\big(i k (j+\\tfrac{1}{2}) \\Delta x\\big).\n$$\nDefine $\\kappa \\equiv \\frac{k \\Delta x}{2}$ and $s \\equiv \\sin(\\kappa)$. The discrete staggered gradient and divergence operators acting on these modes yield the common factor\n$$\n\\frac{\\eta^{n}_{j+1} - \\eta^{n}_{j}}{\\Delta x} = \\frac{2 i s}{\\Delta x}\\,A^{n} \\exp\\!\\big(i k (j+\\tfrac{1}{2}) \\Delta x\\big),\n$$\n$$\n\\frac{u^{n+\\frac{1}{2}}_{j+\\frac{1}{2}} - u^{n+\\frac{1}{2}}_{j-\\frac{1}{2}}}{\\Delta x} = \\frac{2 i s}{\\Delta x}\\,B^{n+\\frac{1}{2}} \\exp\\!\\big(i k j \\Delta x\\big).\n$$\nHence the modal amplitude recurrences become\n$$\nB^{n+\\frac{1}{2}} = B^{n-\\frac{1}{2}} - g \\,\\Delta t \\,\\alpha \\,A^{n}, \\qquad \\alpha \\equiv \\frac{2 i s}{\\Delta x},\n$$\n$$\nA^{n+1} = A^{n} - H \\,\\Delta t \\,\\alpha \\,B^{n+\\frac{1}{2}}.\n$$\nTo eliminate $B$, we use the continuity update at consecutive times $n$ and $n+1$. From the continuity equation at time $n$,\n$$\nA^{n} = A^{n-1} - H \\,\\Delta t \\,\\alpha \\,B^{n-\\frac{1}{2}}.\n$$\nSubtracting the two continuity equations gives\n$$\nA^{n+1} - A^{n} = \\left(A^{n} - A^{n-1}\\right) - H \\,\\Delta t \\,\\alpha \\left( B^{n+\\frac{1}{2}} - B^{n-\\frac{1}{2}} \\right).\n$$\nUsing the momentum update,\n$$\nB^{n+\\frac{1}{2}} - B^{n-\\frac{1}{2}} = - g \\,\\Delta t \\,\\alpha \\,A^{n},\n$$\nwe obtain the second-order scalar recurrence for $A^{n}$:\n$$\nA^{n+1} - 2 A^{n} + A^{n-1} = g H \\,(\\Delta t)^{2} \\,\\alpha^{2} \\,A^{n}.\n$$\nSince $\\alpha = \\frac{2 i s}{\\Delta x}$, we have $\\alpha^{2} = - \\frac{4 s^{2}}{\\Delta x^{2}}$. Introducing the external gravity wave speed $c \\equiv \\sqrt{g H}$ and the Courant number\n$$\nC \\equiv \\frac{c \\,\\Delta t}{\\Delta x},\n$$\nthe recurrence becomes\n$$\nA^{n+1} - 2 A^{n} + A^{n-1} = - 4 C^{2} s^{2} \\,A^{n}.\n$$\nSeek solutions of the form $A^{n} = A^{0} \\,\\zeta^{n}$. Substitution yields\n$$\n\\zeta + \\zeta^{-1} - 2 = - 4 C^{2} s^{2}.\n$$\nLet $\\zeta = \\exp(i \\theta)$, corresponding to neutral oscillations; then\n$$\n\\zeta + \\zeta^{-1} = 2 \\cos\\theta \\quad \\Rightarrow \\quad 2 \\cos\\theta = 2 - 4 C^{2} s^{2},\n$$\nso\n$$\n\\cos\\theta = 1 - 2 C^{2} s^{2}.\n$$\nFor stability in the von Neumann sense, we require that $\\theta$ be real for all resolved wavenumbers, which demands\n$$\n-1 \\le 1 - 2 C^{2} s^{2} \\le 1.\n$$\nThe upper bound is automatically satisfied; the lower bound gives\n$$\n1 - 2 C^{2} s^{2} \\ge -1 \\quad \\Rightarrow \\quad 2 C^{2} s^{2} \\le 2 \\quad \\Rightarrow \\quad C^{2} s^{2} \\le 1.\n$$\nBecause $s^{2} = \\sin^{2}(\\kappa) \\le 1$ for all $\\kappa$, the most restrictive condition occurs at the shortest resolved scale where $\\sin^{2}(\\kappa) \\to 1$. Therefore,\n$$\nC \\le 1 \\quad \\Rightarrow \\quad \\Delta t \\le \\frac{\\Delta x}{c} = \\frac{\\Delta x}{\\sqrt{g H}}.\n$$\nHence, the explicit stability limit for the barotropic time step on this C-grid forward–backward scheme is\n$$\n\\Delta t_{\\max} = \\frac{\\Delta x}{\\sqrt{g H}}.\n$$\nThis expression is the required closed form in terms of $H$, $\\Delta x$, and $g$. Since the requested unit is seconds, the expression represents seconds when $\\Delta x$ is in meters, $g$ in meters per second squared, and $H$ in meters.\n\nRelation to the implicit or elliptic treatment in the Bryan–Cox–Semtner (BCS) ocean model: The BCS architecture often advances the barotropic mode implicitly by solving an elliptic (Helmholtz-type) equation for the free-surface or barotropic streamfunction at each baroclinic step, which removes the explicit Courant–Friedrichs–Lewy constraint $\\Delta t \\le \\Delta x/\\sqrt{g H}$ derived above; the physical gravity wave speed $c = \\sqrt{g H}$ is preserved, but the numerical stability is decoupled from $c$ because the implicit solve enforces the wave dynamics without requiring the explicit time step to resolve the fastest external mode.",
            "answer": "$$\\boxed{\\frac{\\Delta x}{\\sqrt{g H}}}$$"
        },
        {
            "introduction": "Theoretical analysis is essential, but verifying a model's performance in practice is the ultimate test of its integrity. For long-term climate simulations, the conservation of quantities like mass, heat, and salt is non-negotiable. In this final hands-on exercise, you will move from analysis to implementation by writing code to verify that a finite-volume scheme for tracer diffusion perfectly upholds the law of conservation, a hallmark of the BCS architecture and a critical skill in computational model development. ",
            "id": "4019583",
            "problem": "You are asked to design and implement a discrete tracer conservation verification, aligned with the Bryan–Cox–Semtner (BCS) ocean model architecture. In the BCS architecture, scalar tracers reside at cell centers on a uniform horizontal grid in a level (constant thickness) layer, and conservation is enforced through a flux-form finite-volume update. Your program must implement a two-dimensional, depth-integrated, passive tracer undergoing horizontal diffusion in a rectangular domain with uniform layer thickness. Velocities are zero, so there is no advection. The only source of tracer mass is a specified diffusive boundary flux on the western boundary; all other boundaries are impermeable to diffusion. The test is to verify that the domain-integrated tracer mass changes only due to this prescribed boundary flux over a long integration.\n\nFundamental base to use:\n- Conservation of mass and the divergence theorem: if the depth-integrated diffusive flux vector is denoted by $\\mathbf{F} = - K H \\nabla C$, where $K$ is the constant horizontal diffusivity, $H$ is the constant layer thickness, and $C$ is the tracer concentration, then for any control volume $V$,\n$$\n\\frac{d}{dt} \\int_V H C \\, dA \\;=\\; - \\int_{\\partial V} \\mathbf{F} \\cdot \\mathbf{n} \\, d\\ell,\n$$\nwith $\\mathbf{n}$ the outward unit normal and $d\\ell$ the boundary line element. This is the foundation for a flux-form, finite-volume discretization. You must not use any unstated formulas beyond this base; derive any discrete updates you need from this principle.\n\nDiscrete computational setting and constraints:\n- Geometry: a rectangular domain discretized into $N_x \\times N_y$ uniform cells, with grid spacings $\\Delta x$ and $\\Delta y$ (in meters), and a constant layer thickness $H$ (in meters).\n- Tracer: the prognostic variable is the depth-averaged concentration $C$ with units $\\mathrm{kg}\\,\\mathrm{m}^{-3}$; the cell mass is $M = H \\, C \\, \\Delta x \\, \\Delta y$ in $\\mathrm{kg}$.\n- Physics: no advection; pure horizontal diffusion with constant diffusivity $K$ (in $\\mathrm{m}^2\\,\\mathrm{s}^{-1}$). The depth-integrated diffusive flux per unit boundary length is $\\mathbf{F} = - K H \\nabla C$ with units $\\mathrm{kg}\\,\\mathrm{m}^{-1}\\,\\mathrm{s}^{-1}$.\n- Boundary conditions:\n  - West boundary ($x = 0$): impose a specified depth-integrated diffusive flux per unit length $f_W(t)$ (in $\\mathrm{kg}\\,\\mathrm{m}^{-1}\\,\\mathrm{s}^{-1}$) into the domain. This is a Neumann condition implemented through the normal gradient consistent with Fick’s law. The total imposed influx across the west boundary at time $t$ is $B(t) = f_W(t) \\, L_y$, where $L_y = N_y \\, \\Delta y$ is the meridional boundary length.\n  - East, South, North boundaries: no diffusive flux, that is, zero normal gradient of $C$.\n- Time stepping: explicit forward time-stepping with step $\\Delta t$ (in seconds), observing the stability constraint for horizontal diffusion on a uniform grid. You must discretize the divergence of fluxes in a way consistent with finite volumes, so that the discrete global mass budget is the sum of boundary fluxes.\n\nDiagnostic and verification requirement:\n- At each time step, compute the domain-integrated tracer mass $M_{\\mathrm{tot}}(t)$ and the cumulative time integral of the net boundary influx $I_B(t) = \\int_0^t B(\\tau)\\, d\\tau$, where $B(t)$ is the sum of diffusive boundary influxes into the domain at time $t$ across all four sides. Because only the west boundary has a specified influx, but the other boundaries enforce zero diffusive flux, $B(t)$ reduces to the west boundary contribution up to numerical round-off. After integrating to the final time $T$, report the conservation residual defined as the absolute relative error\n$$\n\\mathcal{R} \\;=\\; \\frac{\\left| \\left(M_{\\mathrm{tot}}(T) - M_{\\mathrm{tot}}(0)\\right) - I_B(T) \\right|}{\\max\\left( \\left| M_{\\mathrm{tot}}(0) \\right|, \\left| I_B(T) \\right|, 1 \\right)}.\n$$\nThis is a dimensionless quantity. The numerator has units of $\\mathrm{kg}$, and the denominator balances the scaling to avoid division by $0$ when both initial mass and total boundary input are small.\n\nImplementation details to respect the Bryan–Cox–Semtner ocean model architecture:\n- Use a flux-form finite-volume discretization with tracer values located at cell centers. Compute face-normal diffusive fluxes from cell-center gradients using one ghost-cell layer to enforce the Neumann boundary conditions, including the specified western boundary flux. Update cell masses by summing fluxes times the corresponding face lengths. Then update concentrations from the updated masses by dividing by $H \\, \\Delta x \\, \\Delta y$.\n- Use explicit time stepping. You must ensure the choice of $\\Delta t$ in the provided tests is numerically stable for diffusion on a uniform grid.\n\nTest suite you must implement:\nFor each test, initialize $C(\\mathbf{x}, 0)$ and integrate to final time $T$ using the given parameters. Angles are not involved. Always use the units specified above; in particular, lengths in meters and times in seconds. The program must compute and return the dimensionless residual $\\mathcal{R}$ for each test.\n\n- Test 1 (closed domain, no mass change expected):\n  - $N_x = 24$, $N_y = 16$, $\\Delta x = 10^5\\,\\mathrm{m}$, $\\Delta y = 10^5\\,\\mathrm{m}$, $H = 100\\,\\mathrm{m}$, $K = 200\\,\\mathrm{m}^2\\,\\mathrm{s}^{-1}$, $\\Delta t = 1800\\,\\mathrm{s}$, $T = 15 \\times 86400\\,\\mathrm{s}$.\n  - Initial concentration $C(\\mathbf{x}, 0) = 10^{-6}\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$ everywhere.\n  - Western boundary flux $f_W(t) = 0$ for all $t$.\n  - Expected: $\\mathcal{R}$ should be small because $M_{\\mathrm{tot}}(T) \\approx M_{\\mathrm{tot}}(0)$ and $I_B(T) = 0$.\n\n- Test 2 (constant specified western influx):\n  - $N_x = 30$, $N_y = 18$, $\\Delta x = 5 \\times 10^4\\,\\mathrm{m}$, $\\Delta y = 5 \\times 10^4\\,\\mathrm{m}$, $H = 200\\,\\mathrm{m}$, $K = 50\\,\\mathrm{m}^2\\,\\mathrm{s}^{-1}$, $\\Delta t = 1200\\,\\mathrm{s}$, $T = 10 \\times 86400\\,\\mathrm{s}$.\n  - Initial concentration $C(\\mathbf{x}, 0) = 0\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$ everywhere.\n  - Western boundary flux $f_W(t) = 2 \\times 10^{-5}\\,\\mathrm{kg}\\,\\mathrm{m}^{-1}\\,\\mathrm{s}^{-1}$ for all $t$.\n  - Expected: $M_{\\mathrm{tot}}(T) - M_{\\mathrm{tot}}(0)$ matches $I_B(T) \\approx f_W \\, L_y \\, T$, hence small $\\mathcal{R}$.\n\n- Test 3 (edge case with $N_x = 1$ and time-varying flux):\n  - $N_x = 1$, $N_y = 7$, $\\Delta x = 5 \\times 10^4\\,\\mathrm{m}$, $\\Delta y = 5 \\times 10^4\\,\\mathrm{m}$, $H = 400\\,\\mathrm{m}$, $K = 500\\,\\mathrm{m}^2\\,\\mathrm{s}^{-1}$, $\\Delta t = 600\\,\\mathrm{s}$, $T = 36000\\,\\mathrm{s}$.\n  - Initial concentration $C(\\mathbf{x}, 0) = 0\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$ everywhere.\n  - Western boundary flux ramp $f_W(t) = a \\, t$ with $a = 10^{-9}\\,\\mathrm{kg}\\,\\mathrm{m}^{-1}\\,\\mathrm{s}^{-2}$ for $t \\in [0, T]$.\n  - Expected: $I_B(T) \\approx \\int_0^T a t \\, dt \\times L_y = \\frac{1}{2} a T^2 L_y$, and $\\mathcal{R}$ is small.\n\nRequired program output:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of the tests above. Each entry must be the scalar floating-point value of $\\mathcal{R}$ for that test, for example, \"[0.0,0.0,0.0]\". The numbers are dimensionless.\n\nYour implementation must be fully self-contained, require no input, and must adhere to the constraints stated here. The numerical scheme must be derived from the stated conservation law and must be demonstrably conservative in the sense specified by the diagnostic.",
            "solution": "The problem presented is a well-posed initial-boundary value problem for the two-dimensional diffusion equation, to be solved on a rectangular domain using a finite-volume method. All necessary parameters, physical laws, and boundary conditions are provided, and they are scientifically and internally consistent. The parameters for the numerical scheme are chosen such that the stability criterion for explicit time-stepping is satisfied. The problem is therefore deemed valid.\n\nThe solution is derived from the fundamental principle of mass conservation for a passive tracer and implemented using a flux-form finite-volume method, consistent with the Bryan–Cox–Semtner (BCS) ocean model architecture.\n\nThe governing principle is the conservation of a tracer with concentration $C$ in a layer of constant thickness $H$. The rate of change of total tracer mass, $\\int_V H C \\, dA$, within a control volume $V$ is equal to the net flux of the tracer across its boundary $\\partial V$. For a purely diffusive process, this is expressed by the divergence theorem:\n$$\n\\frac{d}{dt} \\int_V H C \\, dA \\;=\\; - \\int_{\\partial V} \\mathbf{F} \\cdot \\mathbf{n} \\, d\\ell\n$$\nwhere $\\mathbf{F} = - K H \\nabla C$ is the depth-integrated diffusive flux vector, $K$ is the constant horizontal diffusivity, and $\\mathbf{n}$ is the outward unit normal vector.\n\nWe discretize the domain into a uniform grid of $N_x \\times N_y$ cells, each of size $\\Delta x \\times \\Delta y$. The tracer concentration $C_{i,j}$ is defined at the center of each cell $(i, j)$, for $i \\in [1, N_x]$ and $j \\in [1, N_y]$. The mass in cell $(i,j)$ is $M_{i,j} = H C_{i,j} \\Delta x \\Delta y$.\n\nApplying the conservation law to a single grid cell $(i,j)$, the rate of change of mass is the sum of fluxes across its four faces:\n$$\n\\frac{dM_{i,j}}{dt} = \\mathcal{F}^x_{i-1/2, j} - \\mathcal{F}^x_{i+1/2, j} + \\mathcal{F}^y_{i, j-1/2} - \\mathcal{F}^y_{i, j+1/2}\n$$\nHere, $\\mathcal{F}^x_{i+1/2, j}$ is the total mass flux rate (in $\\mathrm{kg}\\,\\mathrm{s}^{-1}$) across the eastern face of cell $(i,j)$ (at $x=x_{i+1/2}$), and $\\mathcal{F}^y_{i, j+1/2}$ is the flux rate across the northern face.\n\nThese fluxes are approximated using centered finite differences. The flux across the face between cell $(i,j)$ and $(i+1,j)$ is:\n$$\n\\mathcal{F}^x_{i+1/2, j} = \\left. \\left( -K H \\frac{\\partial C}{\\partial x} \\right) \\right|_{i+1/2,j} \\Delta y \\approx -K H \\frac{C_{i+1,j} - C_{i,j}}{\\Delta x} \\Delta y\n$$\nSimilarly, the flux across the face between cell $(i,j)$ and $(i,j+1)$ is:\n$$\n\\mathcal{F}^y_{i, j+1/2} = \\left. \\left( -K H \\frac{\\partial C}{\\partial y} \\right) \\right|_{i,j+1/2} \\Delta x \\approx -K H \\frac{C_{i,j+1} - C_{i,j}}{\\Delta y} \\Delta x\n$$\nThe problem specifies an explicit forward time-stepping scheme. The mass in each cell is updated from time $t_n$ to $t_{n+1} = t_n + \\Delta t$ as follows:\n$$\nM_{i,j}^{n+1} = M_{i,j}^{n} + \\Delta t \\left( \\mathcal{F}^x_{i-1/2, j} - \\mathcal{F}^x_{i+1/2, j} + \\mathcal{F}^y_{i, j-1/2} - \\mathcal{F}^y_{i, j+1/2} \\right)^n\n$$\nwhere the fluxes are computed using concentrations at time $t_n$. After updating the mass, the new concentration is found via $C_{i,j}^{n+1} = M_{i,j}^{n+1} / (H \\Delta x \\Delta y)$.\n\nThe Neumann boundary conditions are implemented using a layer of ghost cells around the perimeter of the computational domain.\n- For the East, North, and South boundaries, the no-flux condition ($\\nabla C \\cdot \\mathbf{n} = 0$) is enforced. For the eastern boundary at $i=N_x$, this means $\\mathcal{F}^x_{N_x+1/2, j} = 0$. This condition is satisfied by setting the concentration in the eastern ghost cell $C_{N_x+1, j}$ equal to the concentration in the adjacent interior cell, $C_{N_x, j}$. Similar logic applies to the north and south boundaries, i.e., $C_{i, N_y+1} = C_{i, N_y}$ and $C_{i, 0} = C_{i, 1}$.\n\n- For the West boundary at $i=1$, a specified depth-integrated influx per unit length, $f_W(t)$, is imposed. This means the flux across the western face of cell $(1,j)$ is $\\mathcal{F}^x_{1/2, j} = f_W(t_n) \\Delta y$. Equating this to the discretized flux expression yields a condition on the western ghost cell $C_{0,j}$:\n$$\nf_W(t_n) \\Delta y = -K H \\frac{C_{1,j}^n - C_{0,j}^n}{\\Delta x} \\Delta y \\implies C_{0,j}^n = C_{1,j}^n + \\frac{f_W(t_n) \\Delta x}{K H}\n$$\n\nThe verification test relies on the perfect conservation property of this finite-volume scheme. When the mass update equation is summed over all interior cells, all internal fluxes cancel out in a telescoping sum. The rate of change of the total domain-integrated mass, $M_{\\mathrm{tot}} = \\sum_{i,j} M_{i,j}$, is exactly equal to the sum of the fluxes across the domain's outer boundaries, $B(t)$:\n$$\n\\frac{dM_{\\mathrm{tot}}}{dt} = B(t) = \\sum_{j=1}^{N_y} \\mathcal{F}^x_{1/2,j} - \\sum_{j=1}^{N_y} \\mathcal{F}^x_{N_x+1/2,j} + \\sum_{i=1}^{N_x} \\mathcal{F}^y_ {i,1/2} - \\sum_{i=1}^{N_x} \\mathcal{F}^y_{i,N_y+1/2}\n$$\nWith our boundary conditions, this simplifies to $B(t) = \\sum_{j=1}^{N_y} f_W(t) \\Delta y = f_W(t) L_y$.\n Integrating from $t=0$ to $t=T$ gives the analytical identity $M_{\\mathrm{tot}}(T) - M_{\\mathrm{tot}}(0) = \\int_0^T B(\\tau) d\\tau$.\nIn our discrete simulation, we compute the change in total mass, $\\Delta M = M_{\\mathrm{tot}}(T) - M_{\\mathrm{tot}}(0)$, by summing the final cell masses. We also compute the total mass that entered through the boundaries, $I_B(T)$, by accumulating the boundary flux at each time step: $I_B(T) = \\sum_{n=0}^{N_{steps}-1} B(t_n) \\Delta t$.\nThe numerical scheme is conservative, so we expect $\\Delta M \\approx I_B(T)$, with any difference arising from floating-point round-off error. The conservation residual $\\mathcal{R}$ quantifies this difference:\n$$\n\\mathcal{R} \\;=\\; \\frac{\\left| \\left(M_{\\mathrm{tot}}(T) - M_{\\mathrm{tot}}(0)\\right) - I_B(T) \\right|}{\\max\\left( \\left| M_{\\mathrm{tot}}(0) \\right|, \\left| I_B(T) \\right|, 1 \\right)}\n$$\nA small value of $\\mathcal{R}$ verifies that the implementation conserves the tracer mass as intended.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef run_simulation(Nx, Ny, dx, dy, H, K, dt, T, C0_val, fW_func):\n    \"\"\"\n    Implements a 2D finite-volume model for tracer diffusion and\n    verifies mass conservation.\n\n    Args:\n        Nx (int): Number of cells in x-direction.\n        Ny (int): Number of cells in y-direction.\n        dx (float): Grid spacing in x (meters).\n        dy (float): Grid spacing in y (meters).\n        H (float): Layer thickness (meters).\n        K (float): Diffusivity (m^2/s).\n        dt (float): Time step (seconds).\n        T (float): Total integration time (seconds).\n        C0_val (float): Initial tracer concentration (kg/m^3).\n        fW_func (callable): Function f(t) for western boundary flux (kg/m/s).\n\n    Returns:\n        float: The dimensionless conservation residual R.\n    \"\"\"\n    # 1. Initialization\n    # Use a padded grid for ghost cells. C[1:-1, 1:-1] is the interior.\n    # Using float64 for better precision is crucial for this test.\n    C = np.zeros((Nx + 2, Ny + 2), dtype=np.float64)\n    if C0_val != 0:\n        C[1:-1, 1:-1] = C0_val\n\n    cell_volume = H * dx * dy\n    M_tot_0 = np.sum(C[1:-1, 1:-1]) * cell_volume\n\n    I_B = 0.0\n    Ly = Ny * dy\n    num_steps = int(round(T / dt))\n\n    # Pre-calculate factors for efficiency inside the loop\n    if K > 0 and H > 0:\n        ghost_cell_factor = dx / (K * H)\n    else:\n        ghost_cell_factor = 0 # No flux if K or H is zero\n\n    # 2. Main Time-Stepping Loop\n    for n in range(num_steps):\n        current_t = n * dt\n\n        # a. Set Ghost Cell values to enforce boundary conditions\n        # North/South: No flux (dC/dy = 0)\n        C[:, 0] = C[:, 1]\n        C[:, -1] = C[:, -2]\n        \n        # East: No flux (dC/dx = 0)\n        C[-1, :] = C[-2, :]\n        \n        # West: Specified flux\n        fW_t = fW_func(current_t)\n        C[0, 1:-1] = C[1, 1:-1] + fW_t * ghost_cell_factor\n        \n        # Corner ghost cells are not strictly needed for this 5-point stencil's\n        # interior update but are set for completeness.\n        C[0, 0] = C[1, 1]\n        C[0, -1] = C[1, -2]\n        C[-1, 0] = C[-2, 1]\n        C[-1, -1] = C[-2, -2]\n\n        # b. Calculate mass fluxes across cell faces (in kg/s)\n        # flux_x[i, j] is flux across face between cell (i, j) and (i+1, j)\n        # of the interior grid. Array shape is (Nx+1, Ny).\n        flux_x = -K * H * (C[1:, 1:-1] - C[:-1, 1:-1]) / dx * dy\n\n        # flux_y[i, j] is flux across face between cell (i, j) and (i, j+1).\n        # Array shape is (Nx, Ny+1).\n        flux_y = -K * H * (C[1:-1, 1:] - C[1:-1, :-1]) / dy * dx\n\n        # c. Calculate rate of mass change for interior cells\n        # dM_dt has shape (Nx, Ny)\n        dM_dt = (flux_x[:-1, :] - flux_x[1:, :]) + \\\n                (flux_y[:, :-1] - flux_y[:, 1:])\n\n        # d. Update mass and then concentration\n        M_interior = C[1:-1, 1:-1] * cell_volume\n        M_interior += dM_dt * dt\n        C[1:-1, 1:-1] = M_interior / cell_volume\n\n        # e. Update diagnostics for conservation check\n        # Total boundary influx B(t) is computed by summing the boundary fluxes.\n        # Due to the no-flux BCs, only the western boundary contributes.\n        # The flux into the westernmost cells is flux_x[0, :].\n        B_t = np.sum(flux_x[0, :])\n        I_B += B_t * dt\n\n    # 3. Final Calculation\n    M_tot_T = np.sum(C[1:-1, 1:-1]) * cell_volume\n    \n    change_in_mass = M_tot_T - M_tot_0\n    \n    numerator = abs(change_in_mass - I_B)\n    denominator = max(abs(M_tot_0), abs(I_B), 1.0)\n    \n    residual = numerator / denominator\n    \n    return residual\n\ndef solve():\n    \"\"\"\n    Defines and runs the test suite for the tracer conservation verification.\n    \"\"\"\n    test_cases = [\n        # Test 1: Closed domain\n        {\n            \"Nx\": 24, \"Ny\": 16, \"dx\": 1e5, \"dy\": 1e5, \"H\": 100.0, \"K\": 200.0,\n            \"dt\": 1800.0, \"T\": 15 * 86400.0, \"C0_val\": 1e-6,\n            \"fW_func\": lambda t: 0.0\n        },\n        # Test 2: Constant western influx\n        {\n            \"Nx\": 30, \"Ny\": 18, \"dx\": 5e4, \"dy\": 5e4, \"H\": 200.0, \"K\": 50.0,\n            \"dt\": 1200.0, \"T\": 10 * 86400.0, \"C0_val\": 0.0,\n            \"fW_func\": lambda t: 2e-5\n        },\n        # Test 3: Edge case with Nx=1 and time-varying flux\n        {\n            \"Nx\": 1, \"Ny\": 7, \"dx\": 5e4, \"dy\": 5e4, \"H\": 400.0, \"K\": 500.0,\n            \"dt\": 600.0, \"T\": 36000.0, \"C0_val\": 0.0,\n            \"fW_func\": lambda t, a=1e-9: a * t\n        }\n    ]\n\n    results = []\n    for params in test_cases:\n        residual = run_simulation(**params)\n        results.append(residual)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}