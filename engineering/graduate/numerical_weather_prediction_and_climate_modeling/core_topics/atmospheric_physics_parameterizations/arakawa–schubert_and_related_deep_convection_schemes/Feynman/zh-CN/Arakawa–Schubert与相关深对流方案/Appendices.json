{
    "hands_on_practices": [
        {
            "introduction": "本章的实践练习首先从一个基本问题开始：对流质量通量是如何随高度变化的。通过应用质量守恒原理，您将推导出一个简化的卷吸羽流的质量通量方程。这个练习旨在阐明卷吸过程（即环境空气混入云中的过程）如何导致上升气流的质量通量随高度增加，这是所有质量通量对流参数化方案的基石。",
            "id": "4012284",
            "problem": "在用于数值天气预报 (NWP) 和气候模型的 Arakawa–Schubert 深对流参数化方案族中，一个整体上升气流系综的特征是对流质量通量 $M(z) \\equiv \\rho(z)\\,a(z)\\,w(z)$，其中 $\\rho(z)$ 是环境密度， $a(z)$ 是上升气流占据的面积分数，而 $w(z)$ 是它们的平均垂直速度。考虑一个水平均匀的气柱以及位于高度 $z$ 和 $z+\\mathrm{d}z$ 之间的一个无限薄的水平薄层。假设与环境的侧向混合通过单位高度的夹卷率 $\\epsilon(z)$ 和单位高度的卷出率 $\\delta(z)$ 进行参数化，两者都乘以局地质量通量 $M(z)$，分别得出侧向流入和流出趋势。\n\n从应用于上升气流系综薄层的质量守恒和所述的夹卷-卷出参数化出发，推导 $M(z)$ 的控制常微分方程，并在以下假设条件下对其进行积分：\n- 夹卷与高度无关，$\\epsilon(z)=\\epsilon_{0}$ 对于 $z \\in [z_{b},z_{t}]$，其中 $z_{b}$ 是云底高度， $z_{t}$ 是指定的对流顶高度。\n- 在对流顶以下没有卷出，$\\delta(z)=0$ 对于 $z \\in [z_{b},z_{t})$。\n- 云底质量通量是给定的，$M(z_{b})=M_{b}$，且 $M_{b}>0$。\n\n求出在 $z \\in [z_{b},z_{t}]$ 区间内 $M(z)$ 的闭式表达式，以及相应的 $M(z_{t})$ 值，用 $M_{b}$、$\\epsilon_{0}$、$z_{b}$、$z_{t}$ 和 $z$ 来表示。将最终答案表示为符号表达式。最终答案中不要包含单位。",
            "solution": "问题陈述经评估有效。它在科学上基于应用于大气对流的流体动力学原理，作为一个一阶常微分方程的初值问题是适定的，并且用客观、精确的语言表达。唯一解所需的所有必要条件和参数都已提供。\n\n第一步是根据质量守恒原理推导对流质量通量 $M(z)$ 的控制微分方程。我们考虑在高度 $z$ 和 $z+\\mathrm{d}z$ 之间大气柱的一个薄水平层。此薄层内的上升气流系综是我们的控制体积。在稳态下，总质量流入必须等于总质量流出。\n\n进出该薄层的质量通量为：\n1. 底面 ($z$) 的垂直流入：$M(z)$\n2. 顶面 ($z+\\mathrm{d}z$) 的垂直流出：$M(z+\\mathrm{d}z)$\n3. 因从环境中夹卷而产生的侧向流入：单位高度的夹卷率为 $\\epsilon(z)$，因此对于厚度为 $\\mathrm{d}z$ 的薄层，夹卷的质量为 $\\epsilon(z)M(z)\\mathrm{d}z$。\n4. 因向环境中卷出而产生的侧向流出：单位高度的卷出率为 $\\delta(z)$，因此对于厚度为 $\\mathrm{d}z$ 的薄层，卷出的质量为 $\\delta(z)M(z)\\mathrm{d}z$。\n\n因此，质量平衡方程为：\n$$\n\\text{流入} = \\text{流出}\n$$\n$$\nM(z) + \\epsilon(z)M(z)\\mathrm{d}z = M(z+\\mathrm{d}z) + \\delta(z)M(z)\\mathrm{d}z\n$$\n重新排列各项以将微分项组合在一起：\n$$\nM(z+\\mathrm{d}z) - M(z) = \\epsilon(z)M(z)\\mathrm{d}z - \\delta(z)M(z)\\mathrm{d}z\n$$\n两边除以薄层厚度 $\\mathrm{d}z$：\n$$\n\\frac{M(z+\\mathrm{d}z) - M(z)}{\\mathrm{d}z} = (\\epsilon(z) - \\delta(z))M(z)\n$$\n取 $\\mathrm{d}z \\to 0$ 的极限，得到导数的定义：\n$$\n\\frac{\\mathrm{d}M}{\\mathrm{d}z} = (\\epsilon(z) - \\delta(z))M(z)\n$$\n这就是控制上升气流质量通量 $M(z)$ 的通用常微分方程 (ODE)。\n\n下一步是在问题给出的特定假设下，针对高度范围 $z \\in [z_{b}, z_{t}]$ 求解此 ODE。这些假设是：\n1. 恒定的夹卷率：$\\epsilon(z) = \\epsilon_{0}$，对于 $z \\in [z_{b}, z_{t}]$。\n2. 对流顶以下无卷出：$\\delta(z) = 0$，对于 $z \\in [z_{b}, z_{t})$。\n\n应用这些假设，对于区间 $z \\in [z_b, z_t)$，ODE 简化为：\n$$\n\\frac{\\mathrm{d}M}{\\mathrm{d}z} = \\epsilon_{0} M(z)\n$$\n这是一个系数恒定的一阶线性齐次 ODE，它是可分离的。我们可以将其重新排列为：\n$$\n\\frac{1}{M(z)}\\mathrm{d}M = \\epsilon_{0}\\mathrm{d}z\n$$\n为了找到特解，我们将此方程从云底 $z_{b}$ 积分到有效域内的任意高度 $z$。相应的质量通量为 $M(z_b)$ 和 $M(z)$。\n$$\n\\int_{M(z_{b})}^{M(z)} \\frac{1}{M'} \\mathrm{d}M' = \\int_{z_{b}}^{z} \\epsilon_{0} \\mathrm{d}z'\n$$\n这里，$M'$ 和 $z'$ 是积分的哑变量。计算积分得出：\n$$\n\\left[ \\ln|M'| \\right]_{M(z_{b})}^{M(z)} = \\left[ \\epsilon_{0}z' \\right]_{z_{b}}^{z}\n$$\n由于质量通量 $M(z)$ 代表一个必须为正的物理量（给定 $M_b > 0$，并且夹卷会增加质量），我们可以去掉绝对值符号。\n$$\n\\ln(M(z)) - \\ln(M(z_b)) = \\epsilon_{0}(z-z_b)\n$$\n现在我们应用边界条件 $M(z_b) = M_b$：\n$$\n\\ln(M(z)) - \\ln(M_b) = \\epsilon_{0}(z-z_b)\n$$\n利用对数的性质 $\\ln(a) - \\ln(b) = \\ln(a/b)$：\n$$\n\\ln\\left(\\frac{M(z)}{M_b}\\right) = \\epsilon_{0}(z-z_b)\n$$\n最后，我们通过对两边取指数来求解 $M(z)$：\n$$\n\\frac{M(z)}{M_b} = \\exp(\\epsilon_{0}(z-z_b))\n$$\n$$\nM(z) = M_b \\exp(\\epsilon_{0}(z-z_b))\n$$\n该表达式是为 $z \\in [z_b, z_t)$ 推导的。由于函数是连续的，这个闭式表达式在端点 $z=z_t$ 也有效，因此其有效性扩展到整个区间 $z \\in [z_b, z_t]$。这提供了所需答案的第一部分。\n\n答案的第二部分是在对流顶高度的质量通量具体值 $M(z_t)$。这可以通过将 $z=z_t$ 代入推导出的 $M(z)$ 表达式来找到：\n$$\nM(z_t) = M_b \\exp(\\epsilon_{0}(z_t-z_b))\n$$\n推导完成。所需的两个表达式是 $M(z)$ 的 $M_b \\exp(\\epsilon_{0}(z-z_b))$ 和 $M(z_t)$ 的 $M_b \\exp(\\epsilon_{0}(z_t-z_b))$。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} M_b \\exp(\\epsilon_{0}(z-z_b))  M_b \\exp(\\epsilon_{0}(z_t-z_b)) \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "在推导出卷吸羽流的基本方程后，我们将从解析推导转向数值实现。在这个实践中，您将编写一个一维云模式的代码，以计算对流羽流在给定大气环境中上升时的热力学特性。这项练习对于理解动力学（卷吸）和热力学（潜热释放、饱和调节）之间复杂的相互作用至关重要，这些相互作用共同决定了云的浮力和最终发展高度。",
            "id": "4012214",
            "problem": "考虑在数值天气预报和气候模拟中 Arakawa–Schubert (AS) 框架所使用的深对流的一维、稳态、卷挟、饱和羽流表示。环境由离散的层级指定，各层级具有以米为单位的高度 $z$、以帕斯卡为单位的气压 $p$、以开尔文为单位的环境绝对温度 $T_e$ 以及以千克/千克为单位的环境水汽混合比 $q_{v,e}$。每种云类型由一个以米⁻¹为单位的恒定分数卷挟率 $\\lambda$ 和一个以米为单位的卷出高度 $z_d$ 定义，初始云底位于 $z_b$ 米。羽流在云底以上被模拟为饱和状态，云中液态水发生可逆的凝结和蒸发，从而维持饱和。云内总水混合比 $q_{t,c}$（水汽加液态水）和云内湿静力能 $h_c$ 通过卷挟环境空气而演变。假设环境气压场满足静力平衡，干空气和水汽遵循理想气体行为，并使用标准常数：$g$（重力加速度）、$c_p$（湿空气的定压比热，近似取干空气的值）、$R_d$（干空气气体常数）、$R_v$（水汽气体常数）、$L_v$（蒸发潜热）以及 $\\epsilon = R_d / R_v$。\n\n从基本的热力学和质量守恒定律出发：\n- 湿静力能为 $h = c_p T + g z + L_v q_v$。\n- 对于饱和卷挟羽流，可逆假设意味着在 $z_b$ 以上的所有高度都达到饱和，$q_v = q_{sat}(T,p)$。\n- 羽流根据由 $\\lambda$ 决定的一个一阶混合率与环境交换属性。\n- 浮力使用虚温计算，$T_v = T (1 + 0.61 q_v - q_l)$，其中 $q_l$ 是云内液态水混合比，环境虚温为 $T_{v,e} = T_e (1 + 0.61 q_{v,e})$。\n- 对流有效位能 (CAPE) 是从云底到卷出高度的正浮力路径积分，定义为 $\\text{CAPE} = \\int_{z_b}^{z_d} \\max(B(z), 0) \\, dz$，其中 $B(z) = g \\, (T_{v,c}(z) - T_{v,e}(z)) / T_{v,e}(z)$。\n\n您必须：\n1. 根据上述原理，推导算法更新规则，以便为每种云类型计算从云底 $z_b$ 到卷出高度 $z_d$ 的云内湿静力能 $h_c(z)$ 和总水混合比 $q_{t,c}(z)$ 的廓线，其中给定云的恒定 $\\lambda$ 以及环境廓线 $(z, p, T_e, q_{v,e})$。\n2. 通过在每个高度求解非线性约束方程 $h_c(z) = c_p T_c(z) + g z + L_v q_{sat}(T_c(z), p(z))$ 来强制羽流达到饱和，从而得到云内温度 $T_c(z)$。其中 $q_{sat}(T,p)$ 通过克劳修斯-克拉佩龙方程获得，$e_s(T) = e_0 \\exp\\!\\left(\\frac{L_v}{R_v}\\left(\\frac{1}{T_0} - \\frac{1}{T}\\right)\\right)$ 且 $q_{sat}(T,p) = \\epsilon \\, e_s(T) / (p - e_s(T))$。取 $e_0$ 的单位为帕斯卡，$T_0$ 的单位为开尔文，以使该表达式对于液态水饱和在物理上是一致的。\n3. 计算云内水汽 $q_{v,c}(z) = q_{sat}(T_c(z), p(z))$ 和液态水 $q_{l,c}(z) = \\max(q_{t,c}(z) - q_{v,c}(z), 0)$，然后计算浮力 $B(z)$ 和以上定义的对流有效位能 (CAPE) 的积分，单位为焦耳/千克。\n\n使用以下环境探空数据和常数：\n- 常数：$g = 9.81$ m s$^{-2}$，$c_p = 1004$ J kg$^{-1}$ K$^{-1}$，$R_d = 287.04$ J kg$^{-1}$ K$^{-1}$，$R_v = 461.5$ J kg$^{-1}$ K$^{-1}$，$\\epsilon = R_d / R_v$，$L_v = 2.5 \\times 10^6$ J kg$^{-1}$，$p_0 = 101325$ Pa，$H = 8000$ m，$e_0 = 611.2$ Pa，$T_0 = 273.15$ K。\n- 环境网格：高度 $z_i$ 从 $0$ 米到 $10000$ 米，均匀间距 $\\Delta z = 500$ 米；气压 $p_i = p_0 \\exp(-z_i / H)$；温度 $T_{e,i} = 300 - 6.5 \\times (z_i / 1000)$ K；水汽 $q_{v,e,i} = 0.018 \\exp(-z_i / 2000)$ kg/kg。\n\n定义四种云类型（测试套件），每种类型具有恒定的 $\\lambda$ 和指定的卷出及云底高度层级，使用给定网格上的层级索引：\n- 测试案例 1：$\\lambda = 1.0 \\times 10^{-4}$ m$^{-1}$，云底索引 $i_b = 2$（即 $z_b = 1000$ 米），卷出索引 $i_d = 16$（即 $z_d = 8000$ 米）。\n- 测试案例 2：$\\lambda = 3.0 \\times 10^{-4}$ m$^{-1}$，云底索引 $i_b = 2$，卷出索引 $i_d = 12$（即 $z_d = 6000$ 米）。\n- 测试案例 3：$\\lambda = 8.0 \\times 10^{-4}$ m$^{-1}$，云底索引 $i_b = 2$，卷出索引 $i_d = 8$（即 $z_d = 4000$ 米）。\n- 测试案例 4（边缘案例）：$\\lambda = 1.0 \\times 10^{-3}$ m$^{-1}$，云底索引 $i_b = 2$，卷出索引 $i_d = 4$（即 $z_d = 2000$ 米）。\n\n羽流在云底的初始条件取自 $i_b$ 处的环境值，用于湿静力能和总水量，即 $h_c(z_b) = c_p T_e(z_b) + g z_b + L_v q_{v,e}(z_b)$ 且 $q_{t,c}(z_b) = q_{v,e}(z_b)$。\n\n您的程序必须：\n- 使用上面提供的环境探空数据，实现一个具有物理依据的算法，以恒定的 $\\Delta z = 500$ 米步长，将羽流从 $z_b$ 推进到 $z_d$。在每一步中，使用卷挟率 $\\lambda$ 更新 $h_c$ 和 $q_{t,c}$，强制饱和以获得 $T_c$，并计算 $q_{v,c}$、$q_{l,c}$ 和瞬时浮力 $B$。\n- 仅使用正浮力贡献累积对流有效位能 (CAPE)：$\\text{CAPE} = \\sum \\max(B_i, 0) \\, \\Delta z$，累加范围为索引 $i_b$ 和 $i_d$ 之间的步进路径。\n\n答案单位：以焦耳/千克 (J/kg) 表示 CAPE。对于每个测试案例，报告四舍五入到三位小数的 CAPE 值。\n\n最终输出格式：您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，按四个测试案例的顺序排列结果，例如“[cape1,cape2,cape3,cape4]”。方括号内的项目必须是四舍五入到三位小数的数值，不得包含任何额外文本。",
            "solution": "用户提供了一个在大气热力学和对流建模领域定义明确的问题。我将首先验证问题陈述，然后提供完整的解决方案。\n\n### 步骤 1：提取给定信息\n\n**常数：**\n- 重力加速度：$g = 9.81 \\, \\text{m s}^{-2}$\n- 定压下湿空气比热（近似为干空气）：$c_p = 1004 \\, \\text{J kg}^{-1} \\text{K}^{-1}$\n- 干空气气体常数：$R_d = 287.04 \\, \\text{J kg}^{-1} \\text{K}^{-1}$\n- 水汽气体常数：$R_v = 461.5 \\, \\text{J kg}^{-1} \\text{K}^{-1}$\n- 气体常数之比：$\\epsilon = R_d / R_v$\n- 蒸发潜热：$L_v = 2.5 \\times 10^6 \\, \\text{J kg}^{-1}$\n- 参考气压：$p_0 = 101325 \\, \\text{Pa}$\n- 气压标高：$H = 8000 \\, \\text{m}$\n- 参考饱和水汽压：$e_0 = 611.2 \\, \\text{Pa}$\n- 饱和水汽压参考温度：$T_0 = 273.15 \\, \\text{K}$\n\n**环境廓线：**\n- 垂直网格：高度 $z_i$ 从 $0 \\, \\text{m}$ 到 $10000 \\, \\text{m}$，均匀间距 $\\Delta z = 500 \\, \\text{m}$。\n- 气压：$p_i = p_0 \\exp(-z_i / H)$\n- 温度：$T_{e,i} = 300 - 6.5 \\times (z_i / 1000) \\, \\text{K}$\n- 水汽混合比：$q_{v,e,i} = 0.018 \\exp(-z_i / 2000) \\, \\text{kg/kg}$\n\n**物理定义和约束：**\n- 湿静力能：$h = c_p T + g z + L_v q_v$\n- 饱和水汽压（克劳修斯-克拉佩龙方程）：$e_s(T) = e_0 \\exp\\left(\\frac{L_v}{R_v}\\left(\\frac{1}{T_0} - \\frac{1}{T}\\right)\\right)$\n- 饱和混合比：$q_{sat}(T,p) = \\epsilon \\, e_s(T) / (p - e_s(T))$\n- 虚温（羽流）：$T_{v,c} = T_c (1 + 0.61 q_{v,c} - q_{l,c})$\n- 虚温（环境）：$T_{v,e} = T_e (1 + 0.61 q_{v,e})$\n- 浮力：$B(z) = g \\, (T_{v,c}(z) - T_{v,e}(z)) / T_{v,e}(z)$\n- 对流有效位能 (CAPE)：$\\text{CAPE} = \\int_{z_b}^{z_d} \\max(B(z), 0) \\, dz$，计算方式为 $\\sum \\max(B_i, 0) \\, \\Delta z$。\n\n**羽流模型：**\n- 一维、稳态、饱和、卷挟羽流。\n- 每种云类型具有恒定的分数卷挟率 $\\lambda$。\n- 云底 $z_b$ 处的初始条件：$h_c(z_b) = h_e(z_b)$ 且 $q_{t,c}(z_b) = q_{v,e}(z_b)$。\n\n**测试案例（云类型）：**\n1. $\\lambda = 1.0 \\times 10^{-4} \\, \\text{m}^{-1}$，$i_b=2$（$z_b=1000$ m），$i_d=16$（$z_d=8000$ m）。\n2. $\\lambda = 3.0 \\times 10^{-4} \\, \\text{m}^{-1}$，$i_b=2$（$z_b=1000$ m），$i_d=12$（$z_d=6000$ m）。\n3. $\\lambda = 8.0 \\times 10^{-4} \\, \\text{m}^{-1}$，$i_b=2$（$z_b=1000$ m），$i_d=8$（$z_d=4000$ m）。\n4. $\\lambda = 1.0 \\times 10^{-3} \\, \\text{m}^{-1}$，$i_b=2$（$z_b=1000$ m），$i_d=4$（$z_d=2000$ m）。\n\n### 步骤 2：使用提取的给定信息进行验证\n\n根据验证标准对问题进行评估：\n- **科学依据**：问题牢固地植根于大气热力学和流体动力学原理，特别是积云参数化方案（如 Arakawa-Schubert 方案）背后的理论。所有方程和概念都是该领域的标准内容。\n- **良态问题**：该问题是良态的。它提供了所有必要的控制方程、常数、边界条件（在云底）和环境数据，以便为每个测试案例计算出唯一解。\n- **客观性**：语言精确、技术性强，不含任何主观或基于意见的陈述。\n- **完整性**：设置是自洽的。不需要外部信息。\n- **一致性**：所提供的信息中没有明显的科学或逻辑矛盾。参数对于地球大气是物理上合理的。\n- **相关性**：该问题直接关乎 *Arakawa–Schubert 及相关深对流方案* 的主题。\n\n### 步骤 3：结论与行动\n\n问题陈述是**有效的**。这是一个严谨、自洽且科学上合理的问题，需要基于第一性原理实现一个数值模型。我现在将着手提供一个完整的、有理有据的解决方案。\n\n### 算法推导与求解\n\n问题的核心是模拟一个饱和气块（羽流）的上升过程，该气块在上升过程中不断与周围环境混合。羽流的状态由其守恒的热力学变量描述，这些变量随高度演变。\n\n**1. 卷挟羽流的控制方程**\n对于稳态羽流，任何守恒变量 $\\psi$ 随高度 $z$ 的变化由环境空气的卷挟决定。对于任何守恒变量 $\\psi$（如湿静力能 $h$ 或总水混合比 $q_t$），其控制常微分方程 (ODE) 为：\n$$\n\\frac{d\\psi_c}{dz} = \\lambda (\\psi_e - \\psi_c)\n$$\n其中 $\\lambda$ 是分数卷挟率，单位为 $\\text{m}^{-1}$，$\\psi_e$ 是该属性在环境中的值。我们将其应用于云内湿静力能 $h_c$ 和总水混合比 $q_{t,c}$。假设环境中不含液态水，因此其总水混合比就是其水汽混合比，$q_{t,e} = q_{v,e}$。\n\n两个控制常微分方程是：\n$$\n\\frac{dh_c}{dz} = \\lambda (h_e(z) - h_c(z))\n$$\n$$\n\\frac{dq_{t,c}}{dz} = \\lambda (q_{v,e}(z) - q_{t,c}(z))\n$$\n其中环境湿静力能为 $h_e(z) = c_p T_e(z) + g z + L_v q_{v,e}(z)$。\n\n**2. 数值离散化和更新规则**\n为了数值求解这些常微分方程，我们在间距为 $\\Delta z$ 的指定垂直网格上对其进行离散化。使用一阶精度的前向欧拉法，我们将导数 $\\frac{d\\psi_c}{dz}$ 近似为 $\\frac{\\psi_{c,i+1} - \\psi_{c,i}}{\\Delta z}$。这得出了以下更新规则，用于将羽流属性从高度 $z_i$ 推进到 $z_{i+1}$：\n$$\nh_{c,i+1} = h_{c,i} + \\lambda (h_{e,i} - h_{c,i}) \\Delta z\n$$\n$$\nq_{t,c,i+1} = q_{t,c,i} + \\lambda (q_{v,e,i} - q_{t,c,i}) \\Delta z\n$$\n这里，下标 $i$ 表示在高度 $z_i$ 处的值。该方案使用垂直步长开始时的环境和羽流属性来计算该步长内的变化。\n\n**3. 强制饱和（饱和度调整）**\n在每个高度 $z_i$，确定羽流的守恒属性 $h_{c,i}$ 和 $q_{t,c,i}$ 后，我们必须找到相应的云内温度 $T_{c,i}$ 以及总水在水汽（$q_{v,c,i}$）和液态水（$q_{l,c,i}$）之间的分配。假设羽流是饱和的，这对温度施加了一个非线性约束。湿静力能的定义变为：\n$$\nh_{c,i} = c_p T_{c,i} + g z_i + L_v q_{v,c,i}\n$$\n由于羽流是饱和的，水汽混合比等于饱和混合比，$q_{v,c,i} = q_{sat}(T_{c,i}, p_i)$。将其代入湿静力能方程，得到：\n$$\nh_{c,i} = c_p T_{c,i} + g z_i + L_v q_{sat}(T_{c,i}, p_i)\n$$\n其中 $q_{sat}$ 是 $T_c$ 和 $p$ 的函数：\n$$\nq_{sat}(T_c, p_i) = \\frac{\\epsilon \\, e_s(T_c)}{p_i - e_s(T_c)} \\quad \\text{其中} \\quad e_s(T_c) = e_0 \\exp\\left(\\frac{L_v}{R_v}\\left(\\frac{1}{T_0} - \\frac{1}{T_c}\\right)\\right)\n$$\n对于已知的 $h_{c,i}$、$z_i$ 和 $p_i$，我们必须求解这个关于 $T_{c,i}$ 的超越方程。这是一个求根问题。我们可以定义一个函数 $F(T_c) = c_p T_c + g z_i + L_v q_{sat}(T_c, p_i) - h_{c,i}$，并找到使 $F(T_{c,i})=0$ 的根 $T_{c,i}$。这可以使用像二分法或布伦特方法这样的数值方法高效完成。\n\n**4. 羽流和浮力廓线的计算**\n对于给定的云类型（$\\lambda, z_b, z_d$），总体算法如下：\n- **初始化（在云底 $z_b$，索引 $i_b$）：**\n    1.  从环境中设置初始守恒属性：$h_{c,i_b} = c_p T_{e,i_b} + g z_{i_b} + L_v q_{v,e,i_b}$ 且 $q_{t,c,i_b} = q_{v,e,i_b}$。\n    2.  通过求解 $h_{c,i_b}$ 来进行饱和度调整以找到 $T_{c,i_b}$。\n    3.  计算初始水汽 $q_{v,c,i_b} = q_{sat}(T_{c,i_b}, p_{i_b})$ 和液态水 $q_{l,c,i_b} = \\max(0, q_{t,c,i_b} - q_{v,c,i_b})$。\n    4.  使用虚温 $T_{v,c,i_b}$ 和 $T_{v,e,i_b}$ 计算初始浮力 $B_{i_b}$。\n- **上升循环（从 $i=i_b$ 到 $i_d-1$）：**\n    1.  应用离散化的卷挟方程更新 $h_{c,i}$ 和 $q_{t,c,i}$ 得到 $h_{c,i+1}$ 和 $q_{t,c,i+1}$。\n    2.  在高度 $z_{i+1}$，进行饱和度调整，从 $h_{c,i+1}$ 和 $p_{i+1}$ 中找到 $T_{c,i+1}$。\n    3.  计算 $q_{v,c,i+1}$ 和 $q_{l,c,i+1}$。\n    4.  计算虚温：\n        $T_{v,c,i+1} = T_{c,i+1}(1 + 0.61 q_{v,c,i+1} - q_{l,c,i+1})$\n        $T_{v,e,i+1} = T_{e,i+1}(1 + 0.61 q_{v,e,i+1})$\n    5.  计算浮力 $B_{i+1} = g \\, (T_{v,c,i+1} - T_{v,e,i+1}) / T_{v,e,i+1}$。\n- **CAPE 计算：**\n    在计算出从 $i_b$ 到 $i_d$ 的浮力廓线 $B_i$ 后，通过数值积分计算 CAPE。问题指定了一个等同于左黎曼和的求和方式：\n    $$\n    \\text{CAPE} = \\sum_{i=i_b}^{i_d-1} \\max(B_i, 0) \\, \\Delta z\n    $$\n    此和将从云底 $z_b$ 到云顶 $z_d$ 的正浮力进行积分。\n\n这个全面的算法使得可以为每种定义的云类型计算 CAPE。",
            "answer": "```python\nimport numpy as np\nfrom scipy.optimize import root_scalar\n\ndef solve():\n    # --- Constants ---\n    G = 9.81           # m/s^2\n    CP = 1004.0        # J/kg/K\n    RD = 287.04        # J/kg/K\n    RV = 461.5         # J/kg/K\n    EPSILON = RD / RV\n    LV = 2.5e6         # J/kg\n    P0 = 101325.0      # Pa\n    H = 8000.0         # m\n    E0 = 611.2         # Pa\n    T0 = 273.15        # K\n    VIRTUAL_TEMP_COEFF = 0.61 # Approximation for 1/EPSILON - 1\n\n    # --- Environmental Sounding Generation ---\n    dz = 500.0\n    z = np.arange(0.0, 10001.0, dz)\n    p = P0 * np.exp(-z / H)\n    Te = 300.0 - 6.5 * (z / 1000.0)\n    qve = 0.018 * np.exp(-z / 2000.0)\n    \n    # --- Test Cases ---\n    test_cases = [\n        # (lambda, cloud base index, detrainment index)\n        (1.0e-4, 2, 16),\n        (3.0e-4, 2, 12),\n        (8.0e-4, 2, 8),\n        (1.0e-3, 2, 4),\n    ]\n\n    # --- Helper Functions ---\n    def saturation_vapor_pressure(T):\n        \"\"\"Computes saturation vapor pressure using Clausius-Clapeyron equation.\"\"\"\n        return E0 * np.exp((LV / RV) * (1 / T0 - 1 / T))\n\n    def saturation_mixing_ratio(T, press):\n        \"\"\"Computes saturation mixing ratio.\"\"\"\n        es = saturation_vapor_pressure(T)\n        # Avoid p = es, which is unphysical.\n        # It can happen during root finding if the guess is too high.\n        # Clamp es to be slightly less than p.\n        if es >= press:\n            es = press - 1e-3 # ensure denominator is positive\n        return (EPSILON * es) / (press - es)\n\n    def saturation_adjustment_root_func(Tc, p_level, z_level, hc_target):\n        \"\"\"\n        Function whose root is the saturated cloud temperature Tc.\n        F(Tc) = hc_saturated(Tc) - hc_target = 0\n        \"\"\"\n        q_sat = saturation_mixing_ratio(Tc, p_level)\n        hc_saturated = CP * Tc + G * z_level + LV * q_sat\n        return hc_saturated - hc_target\n\n    def compute_cape_for_case(lambda_c, ib, id, z_env, p_env, Te_env, qve_env, dz):\n        \"\"\"\n        Computes CAPE for a single cloud type.\n        \"\"\"\n        num_levels = len(z_env)\n        # Allocate arrays to store plume properties\n        hc_plume = np.full(num_levels, np.nan)\n        qtc_plume = np.full(num_levels, np.nan)\n        Tc_plume = np.full(num_levels, np.nan)\n        B_plume = np.full(num_levels, np.nan)\n\n        # --- Initialization at Cloud Base (ib) ---\n        # 1. Set conserved variables from environment\n        hc_plume[ib] = CP * Te_env[ib] + G * z_env[ib] + LV * qve_env[ib]\n        qtc_plume[ib] = qve_env[ib]\n\n        # 2. Saturation Adjustment to find initial Tc and buoyancy\n        # A reasonable bracket for tropospheric temperatures\n        temp_bracket = [200.0, 350.0]\n        try:\n             sol = root_scalar(\n                saturation_adjustment_root_func,\n                args=(p_env[ib], z_env[ib], hc_plume[ib]),\n                bracket=temp_bracket,\n                method='brentq'\n            )\n             Tc_plume[ib] = sol.root\n        except ValueError:\n            # Bracket might not contain a root if conditions are extreme\n            return 0.0\n\n        qvc_plume_ib = saturation_mixing_ratio(Tc_plume[ib], p_env[ib])\n        qlc_plume_ib = max(0.0, qtc_plume[ib] - qvc_plume_ib)\n        \n        Tvc_plume_ib = Tc_plume[ib] * (1.0 + VIRTUAL_TEMP_COEFF * qvc_plume_ib - qlc_plume_ib)\n        Tve_env_ib = Te_env[ib] * (1.0 + VIRTUAL_TEMP_COEFF * qve_env[ib])\n        B_plume[ib] = G * (Tvc_plume_ib - Tve_env_ib) / Tve_env_ib\n\n        # --- Plume Ascent Loop ---\n        for i in range(ib, id):\n            # Environmental properties at the start of the step\n            he_env_i = CP * Te_env[i] + G * z_env[i] + LV * qve_env[i]\n            \n            # 1. Update conserved variables using Forward Euler step\n            hc_plume[i+1] = hc_plume[i] + lambda_c * (he_env_i - hc_plume[i]) * dz\n            qtc_plume[i+1] = qtc_plume[i] + lambda_c * (qve_env[i] - qtc_plume[i]) * dz\n\n            # 2. Saturation Adjustment at level i+1\n            try:\n                sol = root_scalar(\n                    saturation_adjustment_root_func,\n                    args=(p_env[i+1], z_env[i+1], hc_plume[i+1]),\n                    bracket=temp_bracket,\n                    method='brentq'\n                )\n                Tc_plume[i+1] = sol.root\n            except ValueError:\n                # If no root is found, stop ascent\n                B_plume[i+1:] = -np.inf\n                break\n\n            # 3. Calculate derived properties\n            qvc_plume_ip1 = saturation_mixing_ratio(Tc_plume[i+1], p_env[i+1])\n            qlc_plume_ip1 = max(0.0, qtc_plume[i+1] - qvc_plume_ip1)\n            \n            Tvc_plume_ip1 = Tc_plume[i+1] * (1.0 + VIRTUAL_TEMP_COEFF * qvc_plume_ip1 - qlc_plume_ip1)\n            Tve_env_ip1 = Te_env[i+1] * (1.0 + VIRTUAL_TEMP_COEFF * qve_env[i+1])\n            \n            B_plume[i+1] = G * (Tvc_plume_ip1 - Tve_env_ip1) / Tve_env_ip1\n\n        # --- CAPE Calculation (Left-hand Riemann sum from ib to id-1) ---\n        buoyancy_path = B_plume[ib:id]\n        positive_buoyancy = np.maximum(buoyancy_path, 0)\n        cape = np.sum(positive_buoyancy) * dz\n        \n        return cape\n\n    # Main loop to process test cases\n    results = []\n    for case in test_cases:\n        lambda_c, ib, id = case\n        cape_value = compute_cape_for_case(lambda_c, ib, id, z, p, Te, qve, dz)\n        results.append(cape_value)\n    \n    # Final formatted output\n    print(f\"[{','.join([f'{r:.3f}' for r in results])}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在模拟了单个对流羽流的行为之后，我们现在将探讨对流作为一个整体如何改变大尺度环境。这个动手练习将引导您计算“视热源” ($Q_1$) 和“视水汽汇” ($Q_2$)，它们代表了对流对大气柱温度和湿度廓线的净影响。通过验证湿静力能量收支，您将把参数化方案与基本守恒定律联系起来，从而突出该方案在整个模式能量平衡中的关键作用。",
            "id": "4012253",
            "problem": "考虑一个使用 Arakawa–Schubert 深对流质量通量框架的数值天气预报模式中的一维垂直气柱。令 $z$ 表示高度（单位：米）。令 $M(z)$ 为对流上升气流质量通量（单位：$\\mathrm{kg\\,m^{-2}\\,s^{-1}}$）。令 $\\theta_c(z)$ 和 $\\theta_e(z)$ 分别为云核和环境的位温（单位：$\\mathrm{K}$）。令 $q_{v,c}(z)$ 和 $q_{v,e}(z)$ 分别为云核和环境的比湿（单位：$\\mathrm{kg\\,kg^{-1}}$）。假设存在以下经过充分检验的关系和核心定义：\n\n- 湿静力能 $h$ 定义为 $h = c_p T + g z + L q_v$，其中 $c_p$ 是定压比热（单位：$\\mathrm{J\\,kg^{-1}\\,K^{-1}}$），$T$ 是温度（单位：$\\mathrm{K}$），$g$ 是重力加速度（单位：$\\mathrm{m\\,s^{-2}}$），$L$ 是蒸发潜热（单位：$\\mathrm{J\\,kg^{-1}}$），$q_v$ 是比湿（单位：$\\mathrm{kg\\,kg^{-1}}$）。\n- 在给定气压 $p(z)$ 下，从位温到温度的转换为 $T(z) = \\theta(z) \\pi(z)$，其中 $\\pi(z) = \\left(\\frac{p(z)}{p_0}\\right)^{\\kappa}$，$\\kappa = \\frac{R_d}{c_p}$，$R_d$ 是干空气气体常数（单位：$\\mathrm{J\\,kg^{-1}\\,K^{-1}}$），$p_0$ 是参考气压（单位：$\\mathrm{Pa}$）。\n- 在高度 $z$ 处，云与环境的湿静力能之差为\n$$\nh_c(z) - h_e(z) = c_p\\,\\pi(z)\\,\\big(\\theta_c(z)-\\theta_e(z)\\big) + L\\,\\big(q_{v,c}(z)-q_{v,e}(z)\\big),\n$$\n因为在同一高度，云核和环境之间的 $g z$ 项相互抵消。\n\n在质量通量参数化中，标量 $\\chi(z)$ 的对流输送产生单位面积的上升对流通量 $F_\\chi(z) = M(z)\\big(\\chi_c(z)-\\chi_e(z)\\big)$，其单位为 $\\mathrm{(kg\\,m^{-2}\\,s^{-1})\\times(\\chi\\ 的单位)}$。单位体积的对流趋势项由该通量的负垂直导数给出，即 $-\\frac{\\partial F_\\chi}{\\partial z}$，单位为 $\\mathrm{每单位体积}$。\n\n将单位体积的视热源 $Q1(z)$（单位：$\\mathrm{W\\,m^{-3}}$）定义为湿静力能的对流趋势项加上给定的辐射加热率 $Q_R(z)$（单位：$\\mathrm{W\\,m^{-3}}$）：\n$$\nQ1(z) = -\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[h_c(z)-h_e(z)\\big]\\Big) + Q_R(z)\\,.\n$$\n将单位体积的视水汽汇 $Q2(z)$（单位：$\\mathrm{W\\,m^{-3}}$）定义为\n$$\nQ2(z) = -L\\,\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[q_{v,c}(z)-q_{v,e}(z)\\big]\\Big)\\,.\n$$\n\n对于一个由 $z=0$ 和 $z=H$ 为界的气柱，其整层积分的湿静力能守恒（包含辐射加热）可以表示为干静力能边界通量异常 $B$：\n$$\nE \\equiv \\int_{0}^{H}\\Big(Q1(z) - Q_R(z) - Q2(z)\\Big)\\,dz = B\\,,\n$$\n其中\n$$\nB = -\\Big[M(H)\\,c_p\\,\\pi(H)\\,\\big(\\theta_c(H)-\\theta_e(H)\\big)\\Big] + \\Big[M(0)\\,c_p\\,\\pi(0)\\,\\big(\\theta_c(0)-\\theta_e(0)\\big)\\Big]\\,.\n$$\n如果 $M(0)=M(H)=0$，则 $B=0$，并且整层积分的湿静力能是守恒的，即对流湿静力能源（不包括辐射）等于视水汽汇。\n\n你的任务是为几个测试用例计算 $Q1(z)$ 和 $Q2(z)$，并通过计算 $E$ 并将其与 $B$ 比较来验证整层积分的湿静力能守恒。使用常数 $c_p=1004\\ \\mathrm{J\\,kg^{-1}\\,K^{-1}}$、$L=2.5\\times 10^6\\ \\mathrm{J\\,kg^{-1}}$、$g=9.81\\ \\mathrm{m\\,s^{-2}}$、$R_d=287\\ \\mathrm{J\\,kg^{-1}\\,K^{-1}}$、$p_0=10^5\\ \\mathrm{Pa}$。将 $Q1(z)$ 和 $Q2(z)$ 以 $\\mathrm{W\\,m^{-3}}$ 为单位表示，并将整层积分量 $E$ 和边界项 $B$ 以 $\\mathrm{W\\,m^{-2}}$ 为单位表示。所有用到的角度量（若有）必须以弧度为单位。最终的数值比较应在 $10^{-3}\\ \\mathrm{W\\,m^{-2}}$ 的绝对容差内进行。\n\n使用中心有限差分近似法计算 $\\frac{\\partial}{\\partial z}$，并使用梯形法则进行垂直积分，在离散网格上实现该计算。\n\n使用以下测试套件。每个测试用例定义了 $H$、$N$、网格 $z_i$、气压 $p(z)$、$M(z)$、$(\\theta_c-\\theta_e)(z)$、$(q_{v,c}-q_{v,e})(z)$ 和 $Q_R(z)$。\n\n- 测试用例 1（理想情况，闭合气柱）：\n    - $H=15000\\ \\mathrm{m}$，$N=301$，$z_i$ 在 $0$ 到 $H$ 之间线性分布。\n    - $p(z) = p_0 \\exp\\!\\left(-\\frac{z}{H_s}\\right)$，其中 $H_s=8000\\ \\mathrm{m}$。\n    - $M(z) = M_0 \\exp\\!\\left(-\\frac{(z - z_0)^2}{2\\sigma^2}\\right)$，其中 $M_0=0.10\\ \\mathrm{kg\\,m^{-2}\\,s^{-1}}$，$z_0=6000\\ \\mathrm{m}$，$\\sigma=2000\\ \\mathrm{m}$，并显式设置 $M(0)=0$ 和 $M(H)=0$。\n    - $(\\theta_c-\\theta_e)(z) = 2.0\\,\\exp\\!\\left(-\\frac{z}{7000}\\right)\\ \\mathrm{K}$。\n    - $(q_{v,c}-q_{v,e})(z) = 0.002\\,\\exp\\!\\left(-\\frac{z}{2000}\\right)\\ \\mathrm{kg\\,kg^{-1}}$。\n    - $Q_R(z) = Q_0 \\cos\\!\\left(\\pi \\frac{z}{H}\\right)$，其中 $Q_0=5.0\\times 10^{-3}\\ \\mathrm{W\\,m^{-3}}$。\n\n- 测试用例 2（顶部开放边界，非零 $M(H)$）：\n    - 与测试用例 1 相同，但设置 $M(H)=0.05\\ \\mathrm{kg\\,m^{-2}\\,s^{-1}}$（仅在顶部边界点）。\n\n- 测试用例 3（恒定质量通量和异常）：\n    - $H=15000\\ \\mathrm{m}$，$N=301$，$z_i$ 在 $0$ 到 $H$ 之间线性分布。\n    - $p(z)$ 与测试用例 1 中相同。\n    - $M(z) = 0.05\\ \\mathrm{kg\\,m^{-2}\\,s^{-1}}$（恒定）。\n    - $(\\theta_c-\\theta_e)(z) = 1.5\\ \\mathrm{K}$（恒定）。\n    - $(q_{v,c}-q_{v,e})(z) = 0.001\\ \\mathrm{kg\\,kg^{-1}}$（恒定）。\n    - $Q_R(z) = 4.0\\times 10^{-3} + 1.0\\times 10^{-3}\\,\\frac{z}{H}\\ \\mathrm{W\\,m^{-3}}$。\n\n- 测试用例 4（无对流，仅辐射）：\n    - $H=15000\\ \\mathrm{m}$，$N=301$，$z_i$ 在 $0$ 到 $H$ 之间线性分布。\n    - $p(z)$ 与测试用例 1 中相同。\n    - 对所有 $z$，$M(z) = 0$。\n    - $(\\theta_c-\\theta_e)(z) = 1.0\\,\\exp\\!\\left(-\\frac{z}{10000}\\right)\\ \\mathrm{K}$。\n    - $(q_{v,c}-q_{v,e})(z) = 0.001\\,\\exp\\!\\left(-\\frac{z}{5000}\\right)\\ \\mathrm{kg\\,kg^{-1}}$。\n    - $Q_R(z) = 3.0\\times 10^{-3}\\,\\sin\\!\\left(\\pi \\frac{z}{H}\\right)\\ \\mathrm{W\\,m^{-3}}$。\n\n你的程序必须：\n- 对每个测试用例，按定义计算 $Q1(z)$ 和 $Q2(z)$。\n- 使用梯形法则计算整层积分 $E = \\int_0^H \\big(Q1(z) - Q_R(z) - Q2(z)\\big)\\,dz$（单位：$\\mathrm{W\\,m^{-2}}$）。\n- 计算边界项 $B$（单位：$\\mathrm{W\\,m^{-2}}$）。\n- 对每个测试用例，如果 $\\big|E - B\\big| \\le 10^{-3}\\ \\mathrm{W\\,m^{-2}}$ 则返回布尔值 true，否则返回 false。\n\n最终输出格式：\n你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，“[result1,result2,result3,result4]”），其中每个结果是按测试用例 1、测试用例 2、测试用例 3、测试用例 4 的顺序对应的布尔值。",
            "solution": "用户提供的问题已经过严格验证，被认为是科学上合理、适定且内部一致的。这是一个定义明确的计算问题，基于大气热力学和对流参数化方案（特别是 Arakawa–Schubert 框架）的基本原理。所有必要的数据、常数和函数形式均已提供。核心任务是数值上验证垂直大气柱中湿静力能的守恒定律，这在数值天气预报领域是一个标准且有意义的练习。\n\n该问题围绕湿静力能的整层积分收支。待验证的恒等式是 $E = B$，其中\n$$\nE \\equiv \\int_{0}^{H}\\Big(Q1(z) - Q_R(z) - Q2(z)\\Big)\\,dz\n$$\n和\n$$\nB = -\\Big[M(H)\\,c_p\\,\\pi(H)\\,\\big(\\theta_c(H)-\\theta_e(H)\\big)\\Big] + \\Big[M(0)\\,c_p\\,\\pi(0)\\,\\big(\\theta_c(0)-\\theta_e(0)\\big)\\Big]\\,.\n$$\n该恒等式可以在进行数值验证之前通过解析方法确认。让我们代入视热源 $Q1(z)$ 和视水汽汇 $Q2(z)$ 的定义：\n$$\nQ1(z) = -\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[h_c(z)-h_e(z)\\big]\\Big) + Q_R(z)\n$$\n$$\nQ2(z) = -L\\,\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[q_{v,c}(z)-q_{v,e}(z)\\big]\\Big)\n$$\n$E$ 的被积函数是 $Q1(z) - Q_R(z) - Q2(z)$。代入定义：\n$$\nQ1(z) - Q_R(z) - Q2(z) = \\left[-\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[h_c(z)-h_e(z)\\big]\\Big) + Q_R(z)\\right] - Q_R(z) - \\left[-L\\,\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[q_{v,c}(z)-q_{v,e}(z)\\big]\\Big)\\right]\n$$\n$$\n= -\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[h_c(z)-h_e(z)\\big]\\Big) + L\\,\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[q_{v,c}(z)-q_{v,e}(z)\\big]\\Big)\n$$\n使用湿静力能之差的定义 $h_c(z) - h_e(z) = c_p\\,\\pi(z)\\,\\big(\\theta_c(z)-\\theta_e(z)\\big) + L\\,\\big(q_{v,c}(z)-q_{v,e}(z)\\big)$，并定义干静力能之差为 $s_c(z)-s_e(z) = c_p\\,\\pi(z)\\,(\\theta_c(z)-\\theta_e(z))$，我们得到 $h_c(z)-h_e(z) = s_c(z)-s_e(z) + L\\,(q_{v,c}(z)-q_{v,e}(z))$。将此代入表达式：\n$$\n\\text{被积函数} = -\\frac{\\partial}{\\partial z}\\Big(M(z)\\left[s_c(z)-s_e(z) + L\\,(q_{v,c}(z)-q_{v,e}(z))\\right]\\Big) + L\\,\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[q_{v,c}(z)-q_{v,e}(z)\\big]\\Big)\n$$\n根据导数的线性性质，上式简化为：\n$$\n\\text{被积函数} = -\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[s_c(z)-s_e(z)\\big]\\Big) = -\\frac{\\partial}{\\partial z}\\Big(M(z)\\,c_p\\,\\pi(z)\\,\\big(\\theta_c(z)-\\theta_e(z)\\big)\\Big)\n$$\n现在，我们将此表达式从 $z=0$ 到 $z=H$ 积分：\n$$\nE = \\int_{0}^{H} -\\frac{\\partial}{\\partial z}\\Big(M(z)\\,c_p\\,\\pi(z)\\,\\big(\\theta_c(z)-\\theta_e(z)\\big)\\Big)\\,dz\n$$\n根据微积分基本定理，导数的积分等于函数在边界处的值之差：\n$$\nE = -\\Big[M(z)\\,c_p\\,\\pi(z)\\,\\big(\\theta_c(z)-\\theta_e(z)\\big)\\Big]_{0}^{H} = -\\Big[M(H)\\,c_p\\,\\pi(H)\\,\\big(\\theta_c(H)-\\theta_e(H)\\big)\\Big] + \\Big[M(0)\\,c_p\\,\\pi(0)\\,\\big(\\theta_c(0)-\\theta_e(0)\\big)\\Big]\n$$\n这恰好是边界项 $B$ 的定义。因此，恒等式 $E=B$ 在解析上是正确的。该问题要求对此恒等式进行数值验证，以测试所选的微分和积分数值方法在多大程度上保持了这种守恒属性。\n\n每个测试用例的数值实现过程如下：\n1.  **离散化和廓线**：建立一个从 $z=0$ 到 $H$ 包含 $N$ 个点的均匀垂直网格 $z_i$。所有给定的连续函数——气压 $p(z)$、质量通量 $M(z)$、位温差 $(\\theta_c-\\theta_e)(z)$、比湿差 $(q_{v,c}-q_{v,e})(z)$ 和辐射加热率 $Q_R(z)$——都在这些离散网格点上进行求值，以形成数组。\n2.  **通量计算**：计算对流通量。首先计算无量纲 Exner 函数 $\\pi(z) = \\left(\\frac{p(z)}{p_0}\\right)^{\\kappa}$。然后，在每个网格点上计算湿静力能通量异常 $F_h(z) = M(z)\\,[h_c(z)-h_e(z)]$ 和水汽通量异常 $F_q(z) = M(z)\\,[(q_{v,c}(z)-q_{v,e}(z))]$。\n3.  **数值微分**：使用相应通量的负垂直导数来计算垂直趋势项 $Q1(z)$ 和 $Q2(z)$。导数 $\\frac{\\partial}{\\partial z}$ 使用二阶中心有限差分格式（用于内部点）和二阶单边格式（用于边界）进行近似，正如在 `numpy.gradient` 中所实现的。\n    -   计算湿静力能通量异常的梯度 $\\frac{\\partial F_h}{\\partial z}$。然后 $Q1(z) = -\\frac{\\partial F_h}{\\partial z} + Q_R(z)$。\n    -   计算水汽通量异常的梯度 $\\frac{\\partial F_q}{\\partial z}$。然后 $Q2(z) = -L\\,\\frac{\\partial F_q}{\\partial z}$。\n4.  **数值积分**：通过对被积函数 $I(z_i) = Q1(z_i) - Q_R(z_i) - Q2(z_i)$ 在网格 $z_i$ 上应用梯形法则（正如在 `numpy.trapz` 中所实现的），计算整层积分量 $E$。\n5.  **边界项计算**：直接使用干静力能通量异常 $F_s(z) = M(z)\\,c_p\\,\\pi(z)\\,(\\theta_c(z)-\\theta_e(z))$ 在网格边界（$z_i=0$ 和 $z_i=H$）处的值来计算边界项 $B$：$B = -F_s(H) + F_s(0)$。\n6.  **验证**：最后，将数值计算出的 $E$ 和 $B$ 之间的绝对差与指定的容差 $10^{-3}\\ \\mathrm{W\\,m^{-2}}$ 进行比较。返回一个布尔值结果，指示是否满足 $|\\,E - B\\,| \\le 10^{-3}$。任何非零差异都可归因于数值微分和积分方案的截断误差。\n\n此过程应用于四个测试用例中的每一个，这些用例探究了不同的物理情景（例如，闭合与开放边界，存在/不存在对流），从而为数值实现提供稳健的验证。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the Arakawa-Schubert convection problem for four test cases.\n    For each case, it computes Q1, Q2, E, and B, and verifies the conservation\n    law |E - B| = 1e-3.\n    \"\"\"\n\n    # Define physical constants\n    C_P = 1004.0        # J kg^-1 K^-1\n    L_V = 2.5e6         # J kg^-1\n    R_D = 287.0         # J kg^-1 K^-1\n    P0 = 1e5            # Pa\n    KAPPA = R_D / C_P\n\n    def process_case(case_params):\n        \"\"\"\n        Processes a single test case to verify moist static energy conservation.\n        \"\"\"\n        H, N, p_func, M_func, dtheta_func, dq_func, Qr_func, M_specials = case_params\n\n        # 1. Set up grid\n        z = np.linspace(0, H, N)\n\n        # 2. Evaluate profiles on the grid\n        p = p_func(z)\n        M = M_func(z)\n        \n        # Apply special boundary conditions for M(z)\n        if M_specials.get('M0_is_zero', False):\n            M[0] = 0.0\n        if M_specials.get('MH_is_zero', False):\n            M[-1] = 0.0\n        if 'MH_override' in M_specials:\n            M[-1] = M_specials['MH_override']\n\n        dtheta = dtheta_func(z)\n        dq = dq_func(z)\n        Qr = Qr_func(z)\n\n        # 3. Calculate intermediate quantities\n        # Exner function\n        pi_z = (p / P0)**KAPPA\n        \n        # Convective flux of moist static energy anomaly\n        # h_c - h_e = c_p*pi*(theta_c - theta_e) + L*(q_vc - q_ve)\n        F_h = M * (C_P * pi_z * dtheta + L_V * dq)\n        \n        # Convective flux of moisture anomaly\n        F_q = M * dq\n\n        # 4. Compute Q1 and Q2 using numerical differentiation\n        # Derivative of moist static energy flux\n        dFh_dz = np.gradient(F_h, z)\n        Q1 = -dFh_dz + Qr\n\n        # Derivative of moisture flux\n        dFq_dz = np.gradient(F_q, z)\n        Q2 = -L_V * dFq_dz\n\n        # 5. Compute column-integrated E using numerical integration\n        integrand_E = Q1 - Qr - Q2\n        E = np.trapz(integrand_E, z)\n        \n        # 6. Compute boundary term B\n        # Dry static energy flux anomaly\n        F_s = M * C_P * pi_z * dtheta\n        B = -F_s[-1] + F_s[0]\n\n        # 7. Verify conservation\n        return abs(E - B) = 1e-3\n\n    # --- Define Test Cases ---\n\n    # Case 1: Happy path, closed column\n    case1 = (\n        15000.0, 301,\n        lambda z: 1e5 * np.exp(-z / 8000.0),\n        lambda z: 0.10 * np.exp(-(z - 6000.0)**2 / (2 * 2000.0**2)),\n        lambda z: 2.0 * np.exp(-z / 7000.0),\n        lambda z: 0.002 * np.exp(-z / 2000.0),\n        lambda z: 5.0e-3 * np.cos(np.pi * z / 15000.0),\n        {'M0_is_zero': True, 'MH_is_zero': True}\n    )\n\n    # Case 2: Open top boundary\n    case2 = (\n        15000.0, 301,\n        lambda z: 1e5 * np.exp(-z / 8000.0),\n        lambda z: 0.10 * np.exp(-(z - 6000.0)**2 / (2 * 2000.0**2)),\n        lambda z: 2.0 * np.exp(-z / 7000.0),\n        lambda z: 0.002 * np.exp(-z / 2000.0),\n        lambda z: 5.0e-3 * np.cos(np.pi * z / 15000.0),\n        {'M0_is_zero': True, 'MH_override': 0.05}\n    )\n    \n    # Case 3: Constant mass flux and anomalies\n    case3 = (\n        15000.0, 301,\n        lambda z: 1e5 * np.exp(-z / 8000.0),\n        lambda z: np.full_like(z, 0.05),\n        lambda z: np.full_like(z, 1.5),\n        lambda z: np.full_like(z, 0.001),\n        lambda z: 4.0e-3 + 1.0e-3 * z / 15000.0,\n        {} # No special M handling needed\n    )\n\n    # Case 4: No convection, radiation only\n    case4 = (\n        15000.0, 301,\n        lambda z: 1e5 * np.exp(-z / 8000.0),\n        lambda z: np.zeros_like(z),\n        lambda z: 1.0 * np.exp(-z / 10000.0),\n        lambda z: 0.001 * np.exp(-z / 5000.0),\n        lambda z: 3.0e-3 * np.sin(np.pi * z / 15000.0),\n        {} # M is already zero everywhere\n    )\n\n    test_cases = [case1, case2, case3, case4]\n\n    results = [process_case(case) for case in test_cases]\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(str(r).lower() for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}