{
    "hands_on_practices": [
        {
            "introduction": "We begin with the fundamental building block of the AS scheme: the entraining plume. This exercise asks you to derive the vertical profile of convective mass flux, $M(z)$, under idealized conditions. By solving the mass conservation equation analytically, you will discover the characteristic exponential growth of the plume's mass flux due to entrainment, a core concept that underpins the entire mass-flux framework .",
            "id": "4012284",
            "problem": "In the Arakawa-Schubert family of deep convection parameterizations for Numerical Weather Prediction (NWP) and climate models, a bulk updraft ensemble is characterized by a convective mass flux $M(z) \\equiv \\rho(z)\\,a(z)\\,w(z)$, where $\\rho(z)$ is the environmental density, $a(z)$ is the fractional area occupied by the updrafts, and $w(z)$ is their mean vertical velocity. Consider a horizontally homogeneous column and an infinitesimally thin horizontal slab between heights $z$ and $z+\\mathrm{d}z$. Assume that lateral mixing with the environment is parameterized by an entrainment rate per unit height $\\epsilon(z)$ and a detrainment rate per unit height $\\delta(z)$, both multiplying the local mass flux $M(z)$ to give lateral inflow and outflow tendencies, respectively.\n\nStarting from mass conservation applied to the slab for the updraft ensemble and the stated entrainment–detrainment parameterization, derive the governing ordinary differential equation for $M(z)$ and integrate it subject to the following assumptions:\n- The entrainment is height-independent, $\\epsilon(z)=\\epsilon_{0}$ for $z \\in [z_{b},z_{t}]$, where $z_{b}$ is the cloud-base height and $z_{t}$ is the prescribed convective-top height.\n- There is no detrainment below the top, $\\delta(z)=0$ for $z \\in [z_{b},z_{t})$.\n- The cloud-base mass flux is specified, $M(z_{b})=M_{b}$, with $M_{b}>0$.\n\nObtain a closed-form expression for $M(z)$ for $z \\in [z_{b},z_{t}]$ and the corresponding value $M(z_{t})$ expressed in terms of $M_{b}$, $\\epsilon_{0}$, $z_{b}$, $z_{t}$, and $z$. Express your final answer as symbolic expressions. Do not include units in your final answer.",
            "solution": "The problem statement is evaluated and deemed valid. It is scientifically grounded in the principles of fluid dynamics as applied to atmospheric convection, is well-posed as an initial value problem for a first-order ordinary differential equation, and is expressed in objective, precise language. All necessary conditions and parameters for a unique solution are provided.\n\nThe first step is to derive the governing differential equation for the convective mass flux $M(z)$ from the principle of mass conservation. We consider a thin horizontal slab of the atmospheric column between heights $z$ and $z+\\mathrm{d}z$. The updraft ensemble within this slab is our control volume. In a steady state, the total mass inflow must equal the total mass outflow.\n\nThe mass fluxes into and out of the slab are:\n1. Vertical inflow at the bottom face ($z$): $M(z)$\n2. Vertical outflow at the top face ($z+\\mathrm{d}z$): $M(z+\\mathrm{d}z)$\n3. Lateral inflow due to entrainment from the environment: The entrainment rate per unit height is $\\epsilon(z)$, so for a slab of thickness $\\mathrm{d}z$, the mass entrained is $\\epsilon(z)M(z)\\mathrm{d}z$.\n4. Lateral outflow due to detrainment into the environment: The detrainment rate per unit height is $\\delta(z)$, so for a slab of thickness $\\mathrm{d}z$, the mass detrained is $\\delta(z)M(z)\\mathrm{d}z$.\n\nThe mass balance equation is thus:\n$$\n\\text{Inflow} = \\text{Outflow}\n$$\n$$\nM(z) + \\epsilon(z)M(z)\\mathrm{d}z = M(z+\\mathrm{d}z) + \\delta(z)M(z)\\mathrm{d}z\n$$\nRearranging the terms to group the differentials:\n$$\nM(z+\\mathrm{d}z) - M(z) = \\epsilon(z)M(z)\\mathrm{d}z - \\delta(z)M(z)\\mathrm{d}z\n$$\nDividing by the slab thickness $\\mathrm{d}z$:\n$$\n\\frac{M(z+\\mathrm{d}z) - M(z)}{\\mathrm{d}z} = (\\epsilon(z) - \\delta(z))M(z)\n$$\nTaking the limit as $\\mathrm{d}z \\to 0$ gives the definition of the derivative:\n$$\n\\frac{\\mathrm{d}M}{\\mathrm{d}z} = (\\epsilon(z) - \\delta(z))M(z)\n$$\nThis is the general ordinary differential equation (ODE) governing the updraft mass flux $M(z)$.\n\nThe next step is to solve this ODE subject to the specific assumptions provided in the problem for the height range $z \\in [z_{b}, z_{t}]$. The assumptions are:\n1. Constant entrainment rate: $\\epsilon(z) = \\epsilon_{0}$ for $z \\in [z_{b}, z_{t}]$.\n2. No detrainment below the top: $\\delta(z) = 0$ for $z \\in [z_{b}, z_{t})$.\n\nApplying these assumptions, the ODE for the interval $z \\in [z_b, z_t)$ simplifies to:\n$$\n\\frac{\\mathrm{d}M}{\\mathrm{d}z} = \\epsilon_{0} M(z)\n$$\nThis is a first-order linear homogeneous ODE with a constant coefficient, which is separable. We can rearrange it as:\n$$\n\\frac{1}{M(z)}\\mathrm{d}M = \\epsilon_{0}\\mathrm{d}z\n$$\nTo find the specific solution, we integrate this equation from the cloud base $z_{b}$ to an arbitrary height $z$ within the valid domain. The corresponding mass fluxes are $M(z_b)$ and $M(z)$.\n$$\n\\int_{M(z_{b})}^{M(z)} \\frac{1}{M'} \\mathrm{d}M' = \\int_{z_{b}}^{z} \\epsilon_{0} \\mathrm{d}z'\n$$\nHere, $M'$ and $z'$ are dummy variables of integration. Evaluating the integrals yields:\n$$\n\\left[ \\ln|M'| \\right]_{M(z_{b})}^{M(z)} = \\left[ \\epsilon_{0}z' \\right]_{z_{b}}^{z}\n$$\nSince mass flux $M(z)$ represents a physical quantity that must be positive ($M_b > 0$ is given, and entrainment adds mass), we can drop the absolute value signs.\n$$\n\\ln(M(z)) - \\ln(M(z_b)) = \\epsilon_{0}(z-z_b)\n$$\nWe now apply the boundary condition $M(z_b) = M_b$:\n$$\n\\ln(M(z)) - \\ln(M_b) = \\epsilon_{0}(z-z_b)\n$$\nUsing the property of logarithms, $\\ln(a) - \\ln(b) = \\ln(a/b)$:\n$$\n\\ln\\left(\\frac{M(z)}{M_b}\\right) = \\epsilon_{0}(z-z_b)\n$$\nFinally, we solve for $M(z)$ by exponentiating both sides:\n$$\n\\frac{M(z)}{M_b} = \\exp(\\epsilon_{0}(z-z_b))\n$$\n$$\nM(z) = M_b \\exp(\\epsilon_{0}(z-z_b))\n$$\nThis expression is derived for $z \\in [z_b, z_t)$. Since the function is continuous, this closed-form expression is also valid at the endpoint $z=z_t$, thus extending its validity to the full interval $z \\in [z_b, z_t]$. This provides the first part of the required answer.\n\nThe second part of the answer is the specific value of the mass flux at the convective-top height, $M(z_t)$. This is found by substituting $z=z_t$ into the derived expression for $M(z)$:\n$$\nM(z_t) = M_b \\exp(\\epsilon_{0}(z_t-z_b))\n$$\nThis completes the derivation. The two required expressions are $M_b \\exp(\\epsilon_{0}(z-z_b))$ for $M(z)$ and $M_b \\exp(\\epsilon_{0}(z_t-z_b))$ for $M(z_t)$.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} M_b \\exp(\\epsilon_{0}(z-z_b)) & M_b \\exp(\\epsilon_{0}(z_t-z_b)) \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "A parameterization must respond intelligently to the evolving large-scale environment. This practice explores the 'brain' of the AS scheme—the quasi-equilibrium (QE) closure principle—which dictates the overall strength of the convective response. You will calculate the total convective mass flux required to counteract a given large-scale destabilizing tendency, providing a concrete example of how the scheme maintains the atmosphere in a state of statistical equilibrium .",
            "id": "4012265",
            "problem": "Consider an Arakawa-Schubert (AS) deep convection framework within Numerical Weather Prediction (NWP), in which the cloud work function $A$ is defined as the vertical integral of the buoyancy of a reference entraining plume, $A = \\int_{z_b}^{z_t} B_c(z) \\,\\mathrm{d}z$, where $B_c(z)$ is the cloud buoyancy and $z_b$ and $z_t$ are the cloud base and cloud top, respectively. The large-scale environment imposes a height-dependent destabilizing tendency that increases $A$ at a local rate $F_A(z)$, so that the large-scale contribution to the tendency is $\\int_{z_b}^{z_t} F_A(z)\\,\\mathrm{d}z$. In a single-cloud-type quasi-equilibrium framework, convection responds to this forcing through an updraft mass flux $M(z)$ that mixes cloud and environmental properties, thereby reducing $A$. Assume the following fundamental bases:\n\n- The updraft mass flux is defined as $M(z) = \\rho(z)\\,\\sigma(z)\\,w(z)$, where $\\rho$ is the air density, $\\sigma$ is the fractional cloud area, and $w$ is the mean updraft velocity.\n- The convective mass-flux formulation for an environmental scalar $\\chi$ (e.g., moist static energy or total water) gives the convective tendency as $\\partial \\chi_e/\\partial t\\big|_{\\text{conv}} = -\\partial/\\partial z\\big(M(z)\\,[\\chi_c(z)-\\chi_e(z)]\\big)$, where subscripts $c$ and $e$ denote cloud and environment, respectively.\n- The cloud work function $A$ responds to environmental changes through the buoyancy sensitivity to environmental thermodynamic variables, and the convective contribution to $\\mathrm{d}A/\\mathrm{d}t$ can be represented, under a single-cloud-type approximation, as a height integral of $M(z)$ multiplied by a stabilization efficiency kernel $S(z)$ determined by the reference plume’s thermodynamic sensitivity.\n\nYou are given the large-scale forcing profile\n$$\nF_A(z) = F_0\\,\\exp\\!\\left(-\\frac{z-z_b}{H_f}\\right), \\quad z \\in [z_b, z_t],\n$$\nwith $F_0 = 3.00 \\times 10^{-4}\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{s}^{-1}\\,\\mathrm{m}^{-1}$, $z_b = 1.5\\,\\mathrm{km}$, $z_t = 12\\,\\mathrm{km}$, and $H_f = 3.0\\,\\mathrm{km}$. In the single-cloud-type approximation, assume $S(z)$ is height-independent and equal to a constant $S_0 = 2.00 \\times 10^{-3}\\,\\mathrm{J}\\,\\mathrm{kg}^{-2}\\,\\mathrm{m}$.\n\nStarting from the above foundations, derive the expression for the convective contribution to $\\mathrm{d}A/\\mathrm{d}t$ in terms of $M(z)$, and use the quasi-equilibrium condition $\\mathrm{d}A/\\mathrm{d}t = 0$ to compute the vertically integrated mass flux\n$$\nI_M \\equiv \\int_{z_b}^{z_t} M(z)\\,\\mathrm{d}z\n$$\nrequired to offset the large-scale growth of $A$. Evaluate $I_M$ numerically for the given parameters. Express your final answer in $\\mathrm{kg}\\,\\mathrm{m}^{-1}\\,\\mathrm{s}^{-1}$ and round your answer to four significant figures.",
            "solution": "The Arakawa-Schubert (AS) deep convection framework defines the cloud work function $A$ as\n$$\nA = \\int_{z_b}^{z_t} B_c(z)\\,\\mathrm{d}z,\n$$\nwhere $B_c(z)$ is the buoyancy of a reference entraining cloud plume. The tendency of $A$ can be written by differentiating under the integral sign:\n$$\n\\frac{\\mathrm{d}A}{\\mathrm{d}t} = \\int_{z_b}^{z_t} \\frac{\\partial B_c(z)}{\\partial t}\\,\\mathrm{d}z.\n$$\nThis tendency receives contributions from large-scale processes (e.g., radiative heating, synoptic advection, and moistening) and from convection. By hypothesis, the large-scale processes increase $A$ at a local rate $F_A(z)$, so their vertically integrated contribution is\n$$\n\\left.\\frac{\\mathrm{d}A}{\\mathrm{d}t}\\right|_{\\text{LS}} = \\int_{z_b}^{z_t} F_A(z)\\,\\mathrm{d}z.\n$$\n\nTo relate the convective contribution to the mass flux $M(z)$, we start from the mass-flux representation of environmental scalar tendencies. For an environmental scalar $\\chi_e(z)$ (e.g., moist static energy $h_e$ or total water $q_e$), the convective tendency due to an updraft mass flux $M(z)$ is\n$$\n\\left.\\frac{\\partial \\chi_e}{\\partial t}\\right|_{\\text{conv}} = -\\frac{\\partial}{\\partial z}\\Big(M(z)\\,[\\chi_c(z)-\\chi_e(z)]\\Big).\n$$\nThe cloud buoyancy $B_c(z)$ depends on environmental thermodynamic variables, and thus its convective tendency can be expressed by a chain rule:\n$$\n\\left.\\frac{\\partial B_c}{\\partial t}\\right|_{\\text{conv}} = \\frac{\\partial B_c}{\\partial h_e}\\left.\\frac{\\partial h_e}{\\partial t}\\right|_{\\text{conv}} + \\frac{\\partial B_c}{\\partial q_e}\\left.\\frac{\\partial q_e}{\\partial t}\\right|_{\\text{conv}} + \\cdots,\n$$\nwhere the ellipsis represents possible additional scalar dependencies (e.g., condensate loading) that, for this derivation, are grouped into the same structure. Substituting the mass-flux tendencies,\n$$\n\\left.\\frac{\\partial B_c}{\\partial t}\\right|_{\\text{conv}} = -\\frac{\\partial B_c}{\\partial h_e}\\,\\frac{\\partial}{\\partial z}\\Big(M(z)\\,[h_c(z)-h_e(z)]\\Big) - \\frac{\\partial B_c}{\\partial q_e}\\,\\frac{\\partial}{\\partial z}\\Big(M(z)\\,[q_c(z)-q_e(z)]\\Big) + \\cdots.\n$$\nIntegrating over height to obtain the convective contribution to $\\mathrm{d}A/\\mathrm{d}t$,\n$$\n\\left.\\frac{\\mathrm{d}A}{\\mathrm{d}t}\\right|_{\\text{conv}} = \\int_{z_b}^{z_t} \\left.\\frac{\\partial B_c}{\\partial t}\\right|_{\\text{conv}} \\mathrm{d}z,\n$$\nand integrating by parts (assuming that the boundary terms vanish because either $M(z)$ or the cloud–environment differences $h_c-h_e$ and $q_c-q_e$ vanish at $z_b$ and $z_t$ due to the standard AS cloud-base and cloud-top conditions), we obtain\n$$\n\\left.\\frac{\\mathrm{d}A}{\\mathrm{d}t}\\right|_{\\text{conv}} = \\int_{z_b}^{z_t} \\left[ \\frac{\\partial}{\\partial z}\\left(\\frac{\\partial B_c}{\\partial h_e}\\right)\\,[h_c(z)-h_e(z)] + \\frac{\\partial}{\\partial z}\\left(\\frac{\\partial B_c}{\\partial q_e}\\right)\\,[q_c(z)-q_e(z)] + \\cdots \\right] M(z)\\,\\mathrm{d}z.\n$$\nDefine the stabilization efficiency kernel $S(z)$ by grouping the sensitivity-weighted cloud–environment differences (including any additional scalars in the ellipsis) into\n$$\nS(z) \\equiv \\frac{\\partial}{\\partial z}\\left(\\frac{\\partial B_c}{\\partial h_e}\\right)\\,[h_c(z)-h_e(z)] + \\frac{\\partial}{\\partial z}\\left(\\frac{\\partial B_c}{\\partial q_e}\\right)\\,[q_c(z)-q_e(z)] + \\cdots.\n$$\nThen the convective contribution simplifies to\n$$\n\\left.\\frac{\\mathrm{d}A}{\\mathrm{d}t}\\right|_{\\text{conv}} = \\int_{z_b}^{z_t} S(z)\\,M(z)\\,\\mathrm{d}z.\n$$\nIn the single-cloud-type approximation under consideration, we assume $S(z)$ is height-independent and equal to a constant $S_0$, yielding\n$$\n\\left.\\frac{\\mathrm{d}A}{\\mathrm{d}t}\\right|_{\\text{conv}} = S_0 \\int_{z_b}^{z_t} M(z)\\,\\mathrm{d}z = S_0\\,I_M.\n$$\nBecause convection stabilizes the environment, this contribution is negative relative to the large-scale destabilization; we therefore write the net tendency as\n$$\n\\frac{\\mathrm{d}A}{\\mathrm{d}t} = \\underbrace{\\int_{z_b}^{z_t} F_A(z)\\,\\mathrm{d}z}_{\\text{large-scale production}} - \\underbrace{S_0\\,I_M}_{\\text{convective removal}}.\n$$\nThe quasi-equilibrium closure imposes $\\mathrm{d}A/\\mathrm{d}t = 0$, which gives\n$$\nI_M = \\frac{\\int_{z_b}^{z_t} F_A(z)\\,\\mathrm{d}z}{S_0}.\n$$\n\nWe now evaluate the integral $\\int_{z_b}^{z_t} F_A(z)\\,\\mathrm{d}z$ for the given exponential profile. With\n$$\nF_A(z) = F_0\\,\\exp\\!\\left(-\\frac{z-z_b}{H_f}\\right), \\quad z \\in [z_b,z_t],\n$$\nthe integral is\n$$\n\\int_{z_b}^{z_t} F_A(z)\\,\\mathrm{d}z = \\int_{z_b}^{z_t} F_0\\,\\exp\\!\\left(-\\frac{z-z_b}{H_f}\\right)\\mathrm{d}z.\n$$\nLet $y = (z-z_b)/H_f$, so $\\mathrm{d}z = H_f\\,\\mathrm{d}y$ and the limits are $y=0$ at $z=z_b$ and $y=(z_t-z_b)/H_f$ at $z=z_t$. Then\n$$\n\\int_{z_b}^{z_t} F_A(z)\\,\\mathrm{d}z = F_0\\,H_f \\int_{0}^{(z_t-z_b)/H_f} \\exp(-y)\\,\\mathrm{d}y = F_0\\,H_f \\left[1 - \\exp\\!\\left(-\\frac{z_t - z_b}{H_f}\\right)\\right].\n$$\nTherefore,\n$$\nI_M = \\frac{F_0\\,H_f \\left[1 - \\exp\\!\\left(-\\frac{z_t - z_b}{H_f}\\right)\\right]}{S_0}.\n$$\n\nInsert the given numerical values (keeping symbols until the final numerical evaluation): $F_0 = 3.00 \\times 10^{-4}\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{s}^{-1}\\,\\mathrm{m}^{-1}$, $H_f = 3.0\\,\\mathrm{km} = 3.0 \\times 10^{3}\\,\\mathrm{m}$, $z_b = 1.5\\,\\mathrm{km} = 1.5 \\times 10^{3}\\,\\mathrm{m}$, $z_t = 12\\,\\mathrm{km} = 1.2 \\times 10^{4}\\,\\mathrm{m}$, and $S_0 = 2.00 \\times 10^{-3}\\,\\mathrm{J}\\,\\mathrm{kg}^{-2}\\,\\mathrm{m}$. Compute the depth ratio:\n$$\n\\frac{z_t - z_b}{H_f} = \\frac{1.2 \\times 10^{4} - 1.5 \\times 10^{3}}{3.0 \\times 10^{3}} = \\frac{1.05 \\times 10^{4}}{3.0 \\times 10^{3}} = 3.5,\n$$\nand\n$$\n1 - \\exp(-3.5) \\approx 1 - 0.03019738342 \\approx 0.96980261658.\n$$\nCompute $F_0 H_f$:\n$$\nF_0 H_f = (3.00 \\times 10^{-4}) \\times (3.0 \\times 10^{3}) = 0.9 \\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{s}^{-1}.\n$$\nThus,\n$$\n\\int_{z_b}^{z_t} F_A(z)\\,\\mathrm{d}z \\approx 0.9 \\times 0.96980261658 \\approx 0.87282235492 \\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{s}^{-1}.\n$$\nFinally,\n$$\nI_M = \\frac{0.87282235492}{2.00 \\times 10^{-3}} \\approx 436.41117746 \\,\\mathrm{kg}\\,\\mathrm{m}^{-1}\\,\\mathrm{s}^{-1}.\n$$\nRounded to four significant figures, the required vertically integrated mass flux is\n$$\nI_M \\approx 436.4 \\,\\mathrm{kg}\\,\\mathrm{m}^{-1}\\,\\mathrm{s}^{-1}.\n$$\nThis value represents the total column-integrated updraft mass flux needed for the single-cloud-type convective response to exactly offset the specified large-scale production of cloud work function, satisfying the quasi-equilibrium closure $\\mathrm{d}A/\\mathrm{d}t = 0$.",
            "answer": "$$\\boxed{436.4}$$"
        },
        {
            "introduction": "The final step in a convection parameterization is to translate the sub-grid scale processes into tendencies for the large-scale model grid. This computational exercise focuses on calculating the apparent heat source ($Q1$) and moisture sink ($Q2$) from a given mass-flux profile. By numerically verifying a column-integrated moist static energy conservation law, you will gain insight into the crucial energy budget of the coupled convection-environment system and the integrity of the mass-flux formulation .",
            "id": "4012253",
            "problem": "Consider a one-dimensional vertical column in a numerical weather prediction model using the Arakawa-Schubert deep convection mass-flux framework. Let $z$ denote height in meters. Let $M(z)$ be the convective updraft mass flux in $\\mathrm{kg\\,m^{-2}\\,s^{-1}}$. Let $\\theta_c(z)$ and $\\theta_e(z)$ be the potential temperature of cloud core and environment, respectively, each in $\\mathrm{K}$. Let $q_{v,c}(z)$ and $q_{v,e}(z)$ be the specific humidity of cloud core and environment, respectively, each in $\\mathrm{kg\\,kg^{-1}}$. Assume the following well-tested relations and core definitions:\n\n- The moist static energy $h$ is defined by $h = c_p T + g z + L q_v$, where $c_p$ is the specific heat at constant pressure in $\\mathrm{J\\,kg^{-1}\\,K^{-1}}$, $T$ is temperature in $\\mathrm{K}$, $g$ is gravitational acceleration in $\\mathrm{m\\,s^{-2}}$, $L$ is the latent heat of vaporization in $\\mathrm{J\\,kg^{-1}}$, and $q_v$ is specific humidity in $\\mathrm{kg\\,kg^{-1}}$.\n- At a given pressure $p(z)$, the conversion from potential temperature to temperature is $T(z) = \\theta(z) \\pi(z)$ with $\\pi(z) = \\left(\\frac{p(z)}{p_0}\\right)^{\\kappa}$, where $\\kappa = \\frac{R_d}{c_p}$, $R_d$ is the gas constant for dry air in $\\mathrm{J\\,kg^{-1}\\,K^{-1}}$, and $p_0$ is a reference pressure in $\\mathrm{Pa}$.\n- The cloud–environment difference in moist static energy at height $z$ is\n$$\nh_c(z) - h_e(z) = c_p\\,\\pi(z)\\,\\big(\\theta_c(z)-\\theta_e(z)\\big) + L\\,\\big(q_{v,c}(z)-q_{v,e}(z)\\big),\n$$\nbecause the $g z$ term cancels between cloud core and environment at the same height.\n\nIn a mass-flux parameterization, the convective transport of a scalar $\\chi(z)$ produces an updraft convective flux per unit area $F_\\chi(z) = M(z)\\big(\\chi_c(z)-\\chi_e(z)\\big)$ with units $\\mathrm{(kg\\,m^{-2}\\,s^{-1})\\times(\\chi\\ units)}$. The convective tendency per unit volume is given by the negative vertical derivative of this flux, i.e., $-\\frac{\\partial F_\\chi}{\\partial z}$, with units $\\mathrm{per\\ unit\\ volume}$.\n\nDefine the apparent heat source per unit volume $Q1(z)$ in $\\mathrm{W\\,m^{-3}}$ to include the convective tendency of moist static energy plus a prescribed radiative heating rate $Q_R(z)$ in $\\mathrm{W\\,m^{-3}}$:\n$$\nQ1(z) = -\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[h_c(z)-h_e(z)\\big]\\Big) + Q_R(z)\\,.\n$$\nDefine the apparent moisture sink per unit volume $Q2(z)$ in $\\mathrm{W\\,m^{-3}}$ as\n$$\nQ2(z) = -L\\,\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[q_{v,c}(z)-q_{v,e}(z)\\big]\\Big)\\,.\n$$\n\nFor a column bounded by $z=0$ and $z=H$, the column-integrated moist static energy conservation (with radiative heating included) can be written in terms of the dry static energy boundary flux anomaly $B$:\n$$\nE \\equiv \\int_{0}^{H}\\Big(Q1(z) - Q_R(z) - Q2(z)\\Big)\\,dz = B\\,,\n$$\nwhere\n$$\nB = -\\Big[M(H)\\,c_p\\,\\pi(H)\\,\\big(\\theta_c(H)-\\theta_e(H)\\big)\\Big] + \\Big[M(0)\\,c_p\\,\\pi(0)\\,\\big(\\theta_c(0)-\\theta_e(0)\\big)\\Big]\\,.\n$$\nIf $M(0)=M(H)=0$, then $B=0$ and the column-integrated moist static energy is conservative in the sense that the convective moist static energy source (excluding radiation) equals the apparent moisture sink.\n\nYour task is to compute $Q1(z)$ and $Q2(z)$ for several test cases and verify the column-integrated moist static energy conservation by evaluating $E$ and comparing it to $B$. Use the constants $c_p=1004\\ \\mathrm{J\\,kg^{-1}\\,K^{-1}}$, $L=2.5\\times 10^6\\ \\mathrm{J\\,kg^{-1}}$, $g=9.81\\ \\mathrm{m\\,s^{-2}}$, $R_d=287\\ \\mathrm{J\\,kg^{-1}\\,K^{-1}}$, $p_0=10^5\\ \\mathrm{Pa}$. Express $Q1(z)$ and $Q2(z)$ in $\\mathrm{W\\,m^{-3}}$, and express the column-integrated quantity $E$ and boundary term $B$ in $\\mathrm{W\\,m^{-2}}$. All angle quantities, if any are used, must be in radians. The final numerical comparison should be made with an absolute tolerance of $10^{-3}\\ \\mathrm{W\\,m^{-2}}$.\n\nImplement the computation on a discrete grid using a central finite-difference approximation for $\\frac{\\partial}{\\partial z}$ and the trapezoidal rule for vertical integrals.\n\nUse the following test suite. Each test case defines $H$, $N$, grid $z_i$, pressure $p(z)$, $M(z)$, $(\\theta_c-\\theta_e)(z)$, $(q_{v,c}-q_{v,e})(z)$, and $Q_R(z)$.\n\n- Test Case 1 (happy path, closed column):\n    - $H=15000\\ \\mathrm{m}$, $N=301$, $z_i$ linearly spaced from $0$ to $H$.\n    - $p(z) = p_0 \\exp\\!\\left(-\\frac{z}{H_s}\\right)$ with $H_s=8000\\ \\mathrm{m}$.\n    - $M(z) = M_0 \\exp\\!\\left(-\\frac{(z - z_0)^2}{2\\sigma^2}\\right)$ with $M_0=0.10\\ \\mathrm{kg\\,m^{-2}\\,s^{-1}}$, $z_0=6000\\ \\mathrm{m}$, $\\sigma=2000\\ \\mathrm{m}$, and explicitly set $M(0)=0$ and $M(H)=0$.\n    - $(\\theta_c-\\theta_e)(z) = 2.0\\,\\exp\\!\\left(-\\frac{z}{7000}\\right)\\ \\mathrm{K}$.\n    - $(q_{v,c}-q_{v,e})(z) = 0.002\\,\\exp\\!\\left(-\\frac{z}{2000}\\right)\\ \\mathrm{kg\\,kg^{-1}}$.\n    - $Q_R(z) = Q_0 \\cos\\!\\left(\\pi \\frac{z}{H}\\right)$ with $Q_0=5.0\\times 10^{-3}\\ \\mathrm{W\\,m^{-3}}$.\n\n- Test Case 2 (open top boundary, non-zero $M(H)$):\n    - Same as Test Case 1 except set $M(H)=0.05\\ \\mathrm{kg\\,m^{-2}\\,s^{-1}}$ (only at the top boundary point).\n\n- Test Case 3 (constant mass flux and anomalies):\n    - $H=15000\\ \\mathrm{m}$, $N=301$, $z_i$ linearly spaced from $0$ to $H$.\n    - $p(z)$ as in Test Case 1.\n    - $M(z) = 0.05\\ \\mathrm{kg\\,m^{-2}\\,s^{-1}}$ (constant).\n    - $(\\theta_c-\\theta_e)(z) = 1.5\\ \\mathrm{K}$ (constant).\n    - $(q_{v,c}-q_{v,e})(z) = 0.001\\ \\mathrm{kg\\,kg^{-1}}$ (constant).\n    - $Q_R(z) = 4.0\\times 10^{-3} + 1.0\\times 10^{-3}\\,\\frac{z}{H}\\ \\mathrm{W\\,m^{-3}}$.\n\n- Test Case 4 (no convection, radiation only):\n    - $H=15000\\ \\mathrm{m}$, $N=301$, $z_i$ linearly spaced from $0$ to $H$.\n    - $p(z)$ as in Test Case 1.\n    - $M(z) = 0$ for all $z$.\n    - $(\\theta_c-\\theta_e)(z) = 1.0\\,\\exp\\!\\left(-\\frac{z}{10000}\\right)\\ \\mathrm{K}$.\n    - $(q_{v,c}-q_{v,e})(z) = 0.001\\,\\exp\\!\\left(-\\frac{z}{5000}\\right)\\ \\mathrm{kg\\,kg^{-1}}$.\n    - $Q_R(z) = 3.0\\times 10^{-3}\\,\\sin\\!\\left(\\pi \\frac{z}{H}\\right)\\ \\mathrm{W\\,m^{-3}}$.\n\nYour program must:\n- For each test case, compute $Q1(z)$ and $Q2(z)$ as defined.\n- Compute the column-integrated $E = \\int_0^H \\big(Q1(z) - Q_R(z) - Q2(z)\\big)\\,dz$ in $\\mathrm{W\\,m^{-2}}$ using the trapezoidal rule.\n- Compute the boundary term $B$ in $\\mathrm{W\\,m^{-2}}$.\n- For each test case, return a boolean that is true if $\\big|E - B\\big| \\le 10^{-3}\\ \\mathrm{W\\,m^{-2}}$ and false otherwise.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3,result4]\"), where each result is the boolean for the corresponding test case in the order Test Case 1, Test Case 2, Test Case 3, Test Case 4.",
            "solution": "The user-provided problem has been rigorously validated and found to be scientifically sound, well-posed, and internally consistent. It is a well-defined computational problem based on fundamental principles of atmospheric thermodynamics and convective parameterization schemes, specifically the Arakawa-Schubert framework. All necessary data, constants, and functional forms are provided. The core task is to numerically verify a conservation law for moist static energy in a vertical atmospheric column, which is a standard and meaningful exercise in the context of numerical weather prediction.\n\nThe problem centers on the column-integrated budget of moist static energy. The identity to be verified is $E = B$, where\n$$\nE \\equiv \\int_{0}^{H}\\Big(Q1(z) - Q_R(z) - Q2(z)\\Big)\\,dz\n$$\nand\n$$\nB = -\\Big[M(H)\\,c_p\\,\\pi(H)\\,\\big(\\theta_c(H)-\\theta_e(H)\\big)\\Big] + \\Big[M(0)\\,c_p\\,\\pi(0)\\,\\big(\\theta_c(0)-\\theta_e(0)\\big)\\Big]\\,.\n$$\nThis identity can be confirmed analytically before its numerical verification. Let us substitute the definitions for the apparent heat source $Q1(z)$ and the apparent moisture sink $Q2(z)$:\n$$\nQ1(z) = -\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[h_c(z)-h_e(z)\\big]\\Big) + Q_R(z)\n$$\n$$\nQ2(z) = -L\\,\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[q_{v,c}(z)-q_{v,e}(z)\\big]\\Big)\n$$\nThe integrand for $E$ is $Q1(z) - Q_R(z) - Q2(z)$. Substituting the definitions:\n$$\nQ1(z) - Q_R(z) - Q2(z) = \\left[-\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[h_c(z)-h_e(z)\\big]\\Big) + Q_R(z)\\right] - Q_R(z) - \\left[-L\\,\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[q_{v,c}(z)-q_{v,e}(z)\\big]\\Big)\\right]\n$$\n$$\n= -\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[h_c(z)-h_e(z)\\big]\\Big) + L\\,\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[q_{v,c}(z)-q_{v,e}(z)\\big]\\Big)\n$$\nUsing the definition of the moist static energy difference, $h_c(z) - h_e(z) = c_p\\,\\pi(z)\\,\\big(\\theta_c(z)-\\theta_e(z)\\big) + L\\,\\big(q_{v,c}(z)-q_{v,e}(z)\\big)$, and defining the dry static energy difference as $s_c(z)-s_e(z) = c_p\\,\\pi(z)\\,(\\theta_c(z)-\\theta_e(z))$, we have $h_c(z)-h_e(z) = s_c(z)-s_e(z) + L\\,(q_{v,c}(z)-q_{v,e}(z))$. Substituting this into the expression:\n$$\n\\text{Integrand} = -\\frac{\\partial}{\\partial z}\\Big(M(z)\\left[s_c(z)-s_e(z) + L\\,(q_{v,c}(z)-q_{v,e}(z))\\right]\\Big) + L\\,\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[q_{v,c}(z)-q_{v,e}(z)\\big]\\Big)\n$$\nBy linearity of the derivative, this simplifies to:\n$$\n\\text{Integrand} = -\\frac{\\partial}{\\partial z}\\Big(M(z)\\,\\big[s_c(z)-s_e(z)\\big]\\Big) = -\\frac{\\partial}{\\partial z}\\Big(M(z)\\,c_p\\,\\pi(z)\\,\\big(\\theta_c(z)-\\theta_e(z)\\big)\\Big)\n$$\nNow, we integrate this expression from $z=0$ to $z=H$:\n$$\nE = \\int_{0}^{H} -\\frac{\\partial}{\\partial z}\\Big(M(z)\\,c_p\\,\\pi(z)\\,\\big(\\theta_c(z)-\\theta_e(z)\\big)\\Big)\\,dz\n$$\nBy the Fundamental Theorem of Calculus, the integral of a derivative is the difference of the function evaluated at the boundaries:\n$$\nE = -\\Big[M(z)\\,c_p\\,\\pi(z)\\,\\big(\\theta_c(z)-\\theta_e(z)\\big)\\Big]_{0}^{H} = -\\Big[M(H)\\,c_p\\,\\pi(H)\\,\\big(\\theta_c(H)-\\theta_e(H)\\big)\\Big] + \\Big[M(0)\\,c_p\\,\\pi(0)\\,\\big(\\theta_c(0)-\\theta_e(0)\\big)\\Big]\n$$\nThis is precisely the definition of the boundary term $B$. Thus, the identity $E=B$ is analytically correct. The problem requires a numerical verification of this identity, which tests the extent to which the chosen numerical methods for differentiation and integration preserve this conservation property.\n\nThe numerical implementation proceeds as follows for each test case:\n1.  **Discretization and Profiles**: A uniform vertical grid, $z_i$, is established with $N$ points from $z=0$ to $z=H$. All given continuous functions—pressure $p(z)$, mass flux $M(z)$, potential temperature difference $(\\theta_c-\\theta_e)(z)$, specific humidity difference $(q_{v,c}-q_{v,e})(z)$, and radiative heating rate $Q_R(z)$—are evaluated at these discrete grid points to form arrays.\n2.  **Flux Calculation**: The convective fluxes are computed. The non-dimensional Exner function $\\pi(z) = \\left(\\frac{p(z)}{p_0}\\right)^{\\kappa}$ is calculated first, with $\\kappa = \\frac{R_d}{c_p}$. Then, the moist static energy flux anomaly, $F_h(z) = M(z)\\,[h_c(z)-h_e(z)]$, and the moisture flux anomaly, $F_q(z) = M(z)\\,[(q_{v,c}(z)-q_{v,e}(z))]$, are computed at each grid point.\n3.  **Numerical Differentiation**: The vertical tendencies $Q1(z)$ and $Q2(z)$ are computed using the negative vertical derivative of the corresponding fluxes. The derivative $\\frac{\\partial}{\\partial z}$ is approximated using a second-order central finite-difference scheme for interior points and second-order one-sided schemes for the boundaries, as implemented in `numpy.gradient`.\n    -   The gradient of the moist static energy flux anomaly, $\\frac{\\partial F_h}{\\partial z}$, is computed. Then $Q1(z) = -\\frac{\\partial F_h}{\\partial z} + Q_R(z)$.\n    -   The gradient of the moisture flux anomaly, $\\frac{\\partial F_q}{\\partial z}$, is computed. Then $Q2(z) = -L\\,\\frac{\\partial F_q}{\\partial z}$.\n4.  **Numerical Integration**: The column-integrated quantity $E$ is computed by applying the trapezoidal rule, as implemented in `numpy.trapz`, to the integrand $I(z_i) = Q1(z_i) - Q_R(z_i) - Q2(z_i)$ over the grid $z_i$.\n5.  **Boundary Term Calculation**: The boundary term $B$ is calculated directly using the values of the dry static energy flux anomaly, $F_s(z) = M(z)\\,c_p\\,\\pi(z)\\,(\\theta_c(z)-\\theta_e(z))$, at the grid boundaries ($z_i=0$ and $z_i=H$): $B = -F_s(H) + F_s(0)$.\n6.  **Verification**: Finally, the absolute difference between the numerically computed $E$ and $B$ is compared against the specified tolerance of $10^{-3}\\ \\mathrm{W\\,m^{-2}}$. A boolean result is returned indicating whether $|\\,E - B\\,| \\le 10^{-3}$. Any non-zero difference is attributable to the truncation errors of the numerical differentiation and integration schemes.\n\nThis procedure is applied to each of the four test cases, which probe different physical scenarios (e.g., closed vs. open boundaries, presence/absence of convection), to provide a robust verification of the numerical implementation.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the Arakawa-Schubert convection problem for four test cases.\n    For each case, it computes Q1, Q2, E, and B, and verifies the conservation\n    law |E - B| <= 1e-3.\n    \"\"\"\n\n    # Define physical constants\n    C_P = 1004.0        # J kg^-1 K^-1\n    L_V = 2.5e6         # J kg^-1\n    R_D = 287.0         # J kg^-1 K^-1\n    P0 = 1e5            # Pa\n    KAPPA = R_D / C_P\n\n    def process_case(case_params):\n        \"\"\"\n        Processes a single test case to verify moist static energy conservation.\n        \"\"\"\n        H, N, p_func, M_func, dtheta_func, dq_func, Qr_func, M_specials = case_params\n\n        # 1. Set up grid\n        z = np.linspace(0, H, N)\n\n        # 2. Evaluate profiles on the grid\n        p = p_func(z)\n        M = M_func(z)\n        \n        # Apply special boundary conditions for M(z)\n        if M_specials.get('M0_is_zero', False):\n            M[0] = 0.0\n        if M_specials.get('MH_is_zero', False):\n            M[-1] = 0.0\n        if 'MH_override' in M_specials:\n            M[-1] = M_specials['MH_override']\n\n        dtheta = dtheta_func(z)\n        dq = dq_func(z)\n        Qr = Qr_func(z)\n\n        # 3. Calculate intermediate quantities\n        # Exner function\n        pi_z = (p / P0)**KAPPA\n        \n        # Convective flux of moist static energy anomaly\n        # h_c - h_e = c_p*pi*(theta_c - theta_e) + L*(q_vc - q_ve)\n        F_h = M * (C_P * pi_z * dtheta + L_V * dq)\n        \n        # Convective flux of moisture anomaly\n        F_q = M * dq\n\n        # 4. Compute Q1 and Q2 using numerical differentiation\n        # Derivative of moist static energy flux\n        dFh_dz = np.gradient(F_h, z)\n        Q1 = -dFh_dz + Qr\n\n        # Derivative of moisture flux\n        dFq_dz = np.gradient(F_q, z)\n        Q2 = -L_V * dFq_dz\n\n        # 5. Compute column-integrated E using numerical integration\n        integrand_E = Q1 - Qr - Q2\n        E = np.trapz(integrand_E, z)\n        \n        # 6. Compute boundary term B\n        # Dry static energy flux anomaly\n        F_s = M * C_P * pi_z * dtheta\n        B = -F_s[-1] + F_s[0]\n\n        # 7. Verify conservation\n        return abs(E - B) <= 1e-3\n\n    # --- Define Test Cases ---\n\n    # Case 1: Happy path, closed column\n    case1 = (\n        15000.0, 301,\n        lambda z: 1e5 * np.exp(-z / 8000.0),\n        lambda z: 0.10 * np.exp(-(z - 6000.0)**2 / (2 * 2000.0**2)),\n        lambda z: 2.0 * np.exp(-z / 7000.0),\n        lambda z: 0.002 * np.exp(-z / 2000.0),\n        lambda z: 5.0e-3 * np.cos(np.pi * z / 15000.0),\n        {'M0_is_zero': True, 'MH_is_zero': True}\n    )\n\n    # Case 2: Open top boundary\n    case2 = (\n        15000.0, 301,\n        lambda z: 1e5 * np.exp(-z / 8000.0),\n        lambda z: 0.10 * np.exp(-(z - 6000.0)**2 / (2 * 2000.0**2)),\n        lambda z: 2.0 * np.exp(-z / 7000.0),\n        lambda z: 0.002 * np.exp(-z / 2000.0),\n        lambda z: 5.0e-3 * np.cos(np.pi * z / 15000.0),\n        {'M0_is_zero': True, 'MH_override': 0.05}\n    )\n    \n    # Case 3: Constant mass flux and anomalies\n    case3 = (\n        15000.0, 301,\n        lambda z: 1e5 * np.exp(-z / 8000.0),\n        lambda z: np.full_like(z, 0.05),\n        lambda z: np.full_like(z, 1.5),\n        lambda z: np.full_like(z, 0.001),\n        lambda z: 4.0e-3 + 1.0e-3 * z / 15000.0,\n        {} # No special M handling needed\n    )\n\n    # Case 4: No convection, radiation only\n    case4 = (\n        15000.0, 301,\n        lambda z: 1e5 * np.exp(-z / 8000.0),\n        lambda z: np.zeros_like(z),\n        lambda z: 1.0 * np.exp(-z / 10000.0),\n        lambda z: 0.001 * np.exp(-z / 5000.0),\n        lambda z: 3.0e-3 * np.sin(np.pi * z / 15000.0),\n        {} # M is already zero everywhere\n    )\n\n    test_cases = [case1, case2, case3, case4]\n\n    results = [process_case(case) for case in test_cases]\n    \n    # Final print statement in the exact required format.\n    # Python's str(True) is 'True', which is a valid representation of a boolean.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}