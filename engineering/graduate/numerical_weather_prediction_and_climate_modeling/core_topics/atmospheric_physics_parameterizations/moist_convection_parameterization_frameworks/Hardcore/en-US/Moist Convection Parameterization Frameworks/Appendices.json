{
    "hands_on_practices": [
        {
            "introduction": "A core task of any convective parameterization is to determine the intensity of sub-grid scale convection based on the grid-resolved atmospheric state. This exercise explores the widely used \"CAPE-relaxation\" closure, which links the large-scale convective available potential energy ($CAPE$) to the cloud-base mass flux ($M_b$) that drives the parameterized convection. By calculating the mass flux required to consume a certain amount of $CAPE$ over a model time step, you will gain a concrete understanding of how these schemes translate atmospheric instability into a quantifiable convective response .",
            "id": "4066653",
            "problem": "Consider a single-column convective parameterization in a Numerical Weather Prediction (NWP) model employing a moist convection mass-flux framework. The column instability is measured by the Convective Available Potential Energy (CAPE), defined as the vertically integrated buoyancy between the level of free convection and the equilibrium level, \n$$\nC \\equiv \\int_{z_b}^{z_t} g \\,\\frac{\\theta_{v}'(z)}{\\theta_{v}(z)}\\,dz,\n$$\nwhere $g$ is gravitational acceleration, $\\theta_{v}'$ is the parcel virtual potential temperature perturbation relative to the environment, and $\\theta_{v}$ is the environmental virtual potential temperature. In a CAPE-relaxation closure of quasi-equilibrium type, the convective tendency is constrained to reduce CAPE toward an equilibrium value on a specified timescale $\\tau$, so that the modeled CAPE tendency reflects a relaxation of the column’s buoyancy reservoir. \n\nAssume that the convective heating associated with an entraining plume can be represented in bulk form by a cloud-base mass flux $M_b$ (units $\\mathrm{kg\\,m^{-2}\\,s^{-1}}$), and that the column-integrated efficiency by which this mass flux reduces CAPE over a time interval is captured by a heating efficiency parameter $\\epsilon$ (units $\\mathrm{J\\,kg^{-1}}$ per $\\mathrm{kg\\,m^{-2}}$), which quantifies the CAPE reduction per unit cloud-base mass flux per unit duration. For this problem, take $\\epsilon = 50\\,\\mathrm{J\\,kg^{-1}}$ per $\\mathrm{kg\\,m^{-2}}$. The CAPE-relaxation closure timescale is $\\tau = 1\\,\\mathrm{h}$.\n\nStarting from an initial CAPE $C_0 = 2000\\,\\mathrm{J\\,kg^{-1}}$, determine the constant cloud-base mass flux $M_b$ required to reduce CAPE to $C_1 = 1000\\,\\mathrm{J\\,kg^{-1}}$ over a model time step $\\Delta t = 600\\,\\mathrm{s}$, under the assumption that the CAPE reduction during the step is produced solely by convective heating associated with $M_b$ and that other processes (e.g., large-scale advection, radiation, microphysics) are negligible during $\\Delta t$.\n\nYour answer must show a principled derivation from the definitions above, justifying the relationship between $M_b$, $\\epsilon$, and the CAPE tendency that effects the desired finite CAPE change. Round your final numerical value to four significant figures. Express the final $M_b$ in $\\mathrm{kg\\,m^{-2}\\,s^{-1}}$.",
            "solution": "The Convective Available Potential Energy (CAPE) is defined by\n$$\nC \\equiv \\int_{z_b}^{z_t} g \\,\\frac{\\theta_{v}'(z)}{\\theta_{v}(z)}\\,dz,\n$$\nand its time tendency due to convective heating can be related to the tendency of buoyancy within the integral. To first order, a temperature tendency $\\partial T/\\partial t$ in the cloud-bearing layer alters buoyancy $B \\equiv g\\,\\theta_{v}'/\\theta_{v}$ approximately proportionally to the fractional change in virtual potential temperature. This motivates writing the CAPE tendency as a vertical integral of the heating-induced buoyancy tendency,\n$$\n\\frac{dC}{dt} \\approx \\int_{z_b}^{z_t} g\\,\\frac{1}{\\theta_{v}(z)}\\,\\frac{\\partial \\theta_{v}'(z)}{\\partial t}\\,dz,\n$$\nwith $\\partial \\theta_{v}'/\\partial t$ arising from convective heating and moistening.\n\nIn bulk mass-flux parameterizations, the column-integrated impact of convective heating on CAPE can be summarized by a heating efficiency $\\epsilon$ that maps a cloud-base mass flux $M_b$ to a CAPE tendency magnitude. Specifically, we assume a proportionality of the form\n$$\n\\left|\\frac{dC}{dt}\\right| \\approx \\epsilon\\,M_b,\n$$\nwhere $\\epsilon$ has units $\\mathrm{J\\,kg^{-1}}$ per $\\mathrm{kg\\,m^{-2}}$, ensuring dimensional consistency: $\\epsilon\\,M_b$ has units $\\mathrm{J\\,kg^{-1}\\,s^{-1}}$, matching $dC/dt$. This proportionality aggregates the vertical structure of convective heating and entrainment into a single effective parameter.\n\nUnder the stated assumption that the CAPE reduction over the time step $\\Delta t$ is produced solely by the convective heating associated with a constant cloud-base mass flux $M_b$, the finite change in CAPE over $\\Delta t$ is the time-integrated tendency:\n$$\n\\Delta C \\equiv C_1 - C_0 \\approx \\left(\\frac{dC}{dt}\\right)\\,\\Delta t \\approx -\\,\\epsilon\\,M_b\\,\\Delta t,\n$$\nwhere the negative sign indicates a reduction in CAPE. Solving for $M_b$ gives\n$$\nM_b \\approx \\frac{C_0 - C_1}{\\epsilon\\,\\Delta t}.\n$$\nThis relation provides the required constant cloud-base mass flux that, via its associated convective heating, produces the desired finite CAPE reduction $C_0 \\to C_1$ in duration $\\Delta t$.\n\nWe now substitute the given numerical values. The CAPE change magnitude is\n$$\nC_0 - C_1 = 2000\\,\\mathrm{J\\,kg^{-1}} - 1000\\,\\mathrm{J\\,kg^{-1}} = 1000\\,\\mathrm{J\\,kg^{-1}}.\n$$\nThe heating efficiency is $\\epsilon = 50\\,\\mathrm{J\\,kg^{-1}}$ per $\\mathrm{kg\\,m^{-2}}$, and the time step is $\\Delta t = 600\\,\\mathrm{s}$. Therefore,\n$$\nM_b = \\frac{1000}{50 \\times 600} = \\frac{1000}{30000} = \\frac{1}{30}.\n$$\nNumerically,\n$$\nM_b = 0.033333\\ldots\\,\\mathrm{kg\\,m^{-2}\\,s^{-1}}.\n$$\nRounded to four significant figures, this is\n$$\nM_b = 0.03333\\,\\mathrm{kg\\,m^{-2}\\,s^{-1}}.\n$$\n\nFor context, we can compare this required mass flux to the quasi-equilibrium CAPE-relaxation closure tendency at the start of the step. The closure prescribes an instantaneous tendency of magnitude $|dC/dt|_{\\tau} = C/\\tau$, yielding initially\n$$\n\\left|\\frac{dC}{dt}\\right|_{\\tau} = \\frac{2000\\,\\mathrm{J\\,kg^{-1}}}{3600\\,\\mathrm{s}} \\approx 0.5556\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}}.\n$$\nThe tendency required to achieve the specified reduction is\n$$\n\\left|\\frac{dC}{dt}\\right|_{\\mathrm{req}} = \\frac{C_0 - C_1}{\\Delta t} = \\frac{1000}{600} \\approx 1.6667\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}},\n$$\nwhich is exactly three times larger than the closure tendency at $C_0$. Consistently, since $\\epsilon$ is fixed, the required mass flux is three times the closure-implied mass flux $M_b^{(\\tau)} = (C/\\tau)/\\epsilon$. Nonetheless, the requested final answer is the value of $M_b$ needed to produce the specified finite reduction over $\\Delta t$ with the given $\\epsilon$, as derived above.",
            "answer": "$$\\boxed{0.03333}$$"
        },
        {
            "introduction": "Once the overall strength of convection is determined by a closure, the mass-flux framework must describe how properties are transported vertically within convective updrafts. This process is governed by budget equations that account for the entrainment of environmental air into the plume and the detrainment of plume air back into the environment. This coding exercise provides hands-on practice in numerically solving the core equations for an updraft, allowing you to compute the vertical profile of a transported scalar and its impact on the grid-mean state .",
            "id": "4066603",
            "problem": "Consider a one-plume mass-flux moist convection parameterization framework used in Numerical Weather Prediction (NWP) and climate modeling. An updraft transports a conserved scalar mixing ratio $\\phi$ (for example, water vapor mixing ratio) from cloud base upward. The environment has a known vertical profile $\\phi_e(z)$ of the same scalar. The updraft mass flux $M(z)$ (units $\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$) exchanges mass with the environment through entrainment $\\epsilon(z)$ (units $\\mathrm{m}^{-1}$) and detrainment $\\delta(z)$ (units $\\mathrm{m}^{-1}$). The air density profile $\\rho(z)$ (units $\\mathrm{kg}\\,\\mathrm{m}^{-3}$) is also specified.\n\nThe governing fundamental relations are:\n- Updraft mass continuity: $$\\frac{d M}{d z} = \\left(\\epsilon(z) - \\delta(z)\\right) M(z).$$\n- Updraft scalar budget for a conserved mixing ratio: $$\\frac{d}{d z}\\left(M(z)\\,\\phi_u(z)\\right) = \\epsilon(z)\\,M(z)\\,\\phi_e(z) - \\delta(z)\\,M(z)\\,\\phi_u(z),$$ where $\\phi_u(z)$ is the updraft scalar profile (units $\\mathrm{kg}/\\mathrm{kg}$).\n- Grid-mean convective tendency of the scalar due to the updraft flux divergence: $$\\frac{\\partial \\bar{\\phi}}{\\partial t}(z) = -\\frac{1}{\\rho(z)}\\,\\frac{d}{d z}\\left(M(z)\\,\\left[\\phi_u(z) - \\phi_e(z)\\right]\\right),$$ which has units $\\mathrm{s}^{-1}$.\n\nAssume a discretized vertical grid with levels $z_i$ ($i = 0,\\dots,N-1$) with monotonically increasing altitude in meters. The boundary condition at cloud base is $\\phi_u(z_0) = \\phi_e(z_0) + \\Delta\\phi_0$, where $\\Delta\\phi_0$ is a specified initial updraft excess in $\\mathrm{kg}/\\mathrm{kg}$. Use a numerically consistent first-order accurate finite-difference integration in the vertical to compute $\\phi_u(z)$ from cloud base to top, and then compute the grid-mean convective tendency profile $\\partial \\bar{\\phi}/\\partial t$ using a consistent discrete vertical derivative of the convective flux $M(z)\\,(\\phi_u(z)-\\phi_e(z))$. When evaluating discrete derivatives, use one-sided differences at the boundaries and centered differences in the interior.\n\nAnswer requirements:\n- Express all $\\phi_u(z)$ values in $\\mathrm{kg}/\\mathrm{kg}$, rounded to six decimal places.\n- Express all grid-mean tendency values $\\partial \\bar{\\phi}/\\partial t$ in $\\mathrm{s}^{-1}$, rounded to six decimal places.\n- Angles are not involved, so no angle unit is required.\n- Percentages are not involved.\n\nYour program must implement the calculations for the following test suite of three cases. In all cases, the air density is specified by the hydrostatic exponential form $\\rho(z) = \\rho_0 \\exp\\left(-\\frac{z}{H}\\right)$ with $\\rho_0 = 1.2\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$ and scale height $H = 8000\\,\\mathrm{m}$.\n\nCase A (general happy path):\n- Levels: $z = [0, 1000, 2000, 3000, 4000, 5000]\\,\\mathrm{m}$.\n- Updraft mass flux: $M(z) = [0.060, 0.080, 0.100, 0.080, 0.050, 0.020]\\,\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$.\n- Entrainment: $\\epsilon(z) = [1.0\\times 10^{-4}, 1.5\\times 10^{-4}, 2.0\\times 10^{-4}, 2.0\\times 10^{-4}, 1.5\\times 10^{-4}, 1.0\\times 10^{-4}]\\,\\mathrm{m}^{-1}$.\n- Detrainment: $\\delta(z) = [2.0\\times 10^{-4}, 2.5\\times 10^{-4}, 3.0\\times 10^{-4}, 3.0\\times 10^{-4}, 2.5\\times 10^{-4}, 2.0\\times 10^{-4}]\\,\\mathrm{m}^{-1}$.\n- Environmental scalar: $\\phi_e(z) = [0.018, 0.016, 0.013, 0.010, 0.007, 0.005]\\,\\mathrm{kg}/\\mathrm{kg}$.\n- Cloud-base excess: $\\Delta\\phi_0 = 0.004\\,\\mathrm{kg}/\\mathrm{kg}$, so $\\phi_u(z_0) = 0.022\\,\\mathrm{kg}/\\mathrm{kg}$.\n\nCase B (boundary condition: zero entrainment):\n- Levels: $z = [0, 1500, 3000, 4500]\\,\\mathrm{m}$.\n- Updraft mass flux: $M(z) = [0.050, 0.060, 0.040, 0.010]\\,\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$.\n- Entrainment: $\\epsilon(z) = [0.0, 0.0, 0.0, 0.0]\\,\\mathrm{m}^{-1}$.\n- Detrainment: $\\delta(z) = [1.0\\times 10^{-4}, 2.0\\times 10^{-4}, 3.0\\times 10^{-4}, 4.0\\times 10^{-4}]\\,\\mathrm{m}^{-1}$.\n- Environmental scalar: $\\phi_e(z) = [0.020, 0.015, 0.010, 0.006]\\,\\mathrm{kg}/\\mathrm{kg}$.\n- Cloud-base excess: $\\Delta\\phi_0 = 0.000\\,\\mathrm{kg}/\\mathrm{kg}$, so $\\phi_u(z_0) = 0.020\\,\\mathrm{kg}/\\mathrm{kg}$.\n\nCase C (edge case: strong entrainment with decaying mass flux aloft):\n- Levels: $z = [0, 800, 1600, 2400, 3200, 4000]\\,\\mathrm{m}$.\n- Updraft mass flux: $M(z) = [0.070, 0.090, 0.070, 0.050, 0.030, 0.010]\\,\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$.\n- Entrainment: $\\epsilon(z) = [2.0\\times 10^{-4}, 3.0\\times 10^{-4}, 4.0\\times 10^{-4}, 5.0\\times 10^{-4}, 6.0\\times 10^{-4}, 7.0\\times 10^{-4}]\\,\\mathrm{m}^{-1}$.\n- Detrainment: $\\delta(z) = [1.5\\times 10^{-4}, 2.5\\times 10^{-4}, 3.5\\times 10^{-4}, 4.5\\times 10^{-4}, 5.5\\times 10^{-4}, 6.5\\times 10^{-4}]\\,\\mathrm{m}^{-1}$.\n- Environmental scalar: $\\phi_e(z) = [0.019, 0.017, 0.014, 0.012, 0.010, 0.009]\\,\\mathrm{kg}/\\mathrm{kg}$.\n- Cloud-base excess: $\\Delta\\phi_0 = 0.003\\,\\mathrm{kg}/\\mathrm{kg}$, so $\\phi_u(z_0) = 0.022\\,\\mathrm{kg}/\\mathrm{kg}$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. For each test case, output a two-element list: the first element is the list of $\\phi_u(z)$ values in $\\mathrm{kg}/\\mathrm{kg}$ (rounded to six decimals) at all provided $z$ levels, and the second element is the list of $\\partial \\bar{\\phi}/\\partial t$ values in $\\mathrm{s}^{-1}$ (rounded to six decimals) at all provided $z$ levels. The overall output must therefore look like\n$$[\\,[\\,[\\phi_{u,0},\\dots,\\phi_{u,N-1}],\\,[T_0,\\dots,T_{N-1}]\\,],\\,\\text{case 2 result},\\,\\text{case 3 result}\\,],$$\nwith no additional text. The numerical values must correspond exactly to the computations described above using the specified inputs.",
            "solution": "The problem statement has been critically validated and is deemed to be self-contained, scientifically grounded, well-posed, and objective. It presents a standard, simplified problem in atmospheric convection parameterization, providing all necessary governing equations, boundary conditions, and data for a unique solution. The numerical methods are clearly specified. Therefore, a solution will be provided.\n\nThe objective is to compute the vertical profile of an updraft scalar mixing ratio, $\\phi_u(z)$, and the resulting grid-mean tendency of that scalar, $\\frac{\\partial \\bar{\\phi}}{\\partial t}(z)$, for a one-plume mass-flux convective scheme. The solution involves discretizing and solving the governing differential equations.\n\nFirst, we simplify the updraft scalar budget equation. The given equations are:\n1. Updraft mass continuity:\n$$ \\frac{d M}{d z} = \\left(\\epsilon(z) - \\delta(z)\\right) M(z) $$\n2. Updraft scalar budget:\n$$ \\frac{d}{d z}\\left(M(z)\\,\\phi_u(z)\\right) = \\epsilon(z)\\,M(z)\\,\\phi_e(z) - \\delta(z)\\,M(z)\\,\\phi_u(z) $$\n\nApplying the product rule for differentiation to the left-hand side of the scalar budget equation yields:\n$$ M(z)\\,\\frac{d\\phi_u}{dz} + \\phi_u(z)\\,\\frac{dM}{dz} = \\epsilon(z)\\,M(z)\\,\\phi_e(z) - \\delta(z)\\,M(z)\\,\\phi_u(z) $$\n\nSubstituting the mass continuity equation for $\\frac{dM}{dz}$:\n$$ M(z)\\,\\frac{d\\phi_u}{dz} + \\phi_u(z)\\,\\left[\\left(\\epsilon(z) - \\delta(z)\\right) M(z)\\right] = \\epsilon(z)\\,M(z)\\,\\phi_e(z) - \\delta(z)\\,M(z)\\,\\phi_u(z) $$\n\nExpanding the terms on the left-hand side:\n$$ M(z)\\,\\frac{d\\phi_u}{dz} + \\epsilon(z)\\,M(z)\\,\\phi_u(z) - \\delta(z)\\,M(z)\\,\\phi_u(z) = \\epsilon(z)\\,M(z)\\,\\phi_e(z) - \\delta(z)\\,M(z)\\,\\phi_u(z) $$\n\nThe term $-\\delta(z)\\,M(z)\\,\\phi_u(z)$ appears on both sides and cancels out. Assuming the updraft mass flux $M(z)$ is non-zero, we can divide the entire equation by $M(z)$:\n$$ \\frac{d\\phi_u}{dz} + \\epsilon(z)\\,\\phi_u(z) = \\epsilon(z)\\,\\phi_e(z) $$\n\nThis simplifies to a first-order linear ordinary differential equation for $\\phi_u(z)$:\n$$ \\frac{d\\phi_u}{dz} = \\epsilon(z)\\,\\left(\\phi_e(z) - \\phi_u(z)\\right) $$\n\nThis equation describes how the updraft scalar value changes with height due to entrainment of environmental air. It must be integrated vertically from the cloud base, $z_0$. The problem specifies a first-order accurate finite-difference integration. We use the forward Euler method. Given a discrete vertical grid $z_i$ ($i = 0,\\dots,N-1$), we can approximate the derivative as $\\frac{d\\phi_u}{dz} \\approx \\frac{\\phi_{u,i+1} - \\phi_{u,i}}{z_{i+1} - z_i}$. The discretized equation becomes:\n$$ \\frac{\\phi_{u,i+1} - \\phi_{u,i}}{z_{i+1} - z_i} = \\epsilon_i (\\phi_{e,i} - \\phi_{u,i}) $$\n\nSolving for $\\phi_{u,i+1}$, we obtain the iterative formula to compute the updraft scalar profile:\n$$ \\phi_{u,i+1} = \\phi_{u,i} + (z_{i+1} - z_i)\\,\\epsilon_i\\,(\\phi_{e,i} - \\phi_{u,i}) $$\n\nStarting with the given boundary condition $\\phi_{u,0} = \\phi_{e,0} + \\Delta\\phi_0$, this formula is applied iteratively for $i = 0, 1, \\dots, N-2$ to find the complete profile $\\phi_u(z_i)$.\n\nNext, we compute the grid-mean convective tendency, $\\frac{\\partial \\bar{\\phi}}{\\partial t}(z)$. The governing equation is:\n$$ \\frac{\\partial \\bar{\\phi}}{\\partial t}(z) = -\\frac{1}{\\rho(z)}\\,\\frac{d}{d z}\\left(M(z)\\,\\left[\\phi_u(z) - \\phi_e(z)\\right]\\right) $$\nLet the convective scalar flux be $F(z) = M(z)\\,(\\phi_u(z) - \\phi_e(z))$. The tendency is then $\\frac{\\partial \\bar{\\phi}}{\\partial t}(z) = -\\frac{1}{\\rho(z)}\\,\\frac{dF}{dz}$.\n\nFirst, we compute the flux profile $F_i = M_i\\,(\\phi_{u,i} - \\phi_{e,i})$ at each grid level $i$. Then, we compute the discrete vertical derivative of the flux, $(\\frac{dF}{dz})_i$, using the specified finite-difference stencils:\n- At the lower boundary ($i=0$): a first-order forward difference.\n$$ \\left(\\frac{dF}{dz}\\right)_0 = \\frac{F_1 - F_0}{z_1 - z_0} $$\n- In the interior ($0  i  N-1$): a second-order centered difference.\n$$ \\left(\\frac{dF}{dz}\\right)_i = \\frac{F_{i+1} - F_{i-1}}{z_{i+1} - z_{i-1}} $$\n- At the upper boundary ($i=N-1$): a first-order backward difference.\n$$ \\left(\\frac{dF}{dz}\\right)_{N-1} = \\frac{F_{N-1} - F_{N-2}}{z_{N-1} - z_{N-2}} $$\n\nFinally, the tendency at each level $i$ is calculated as:\n$$ \\left(\\frac{\\partial \\bar{\\phi}}{\\partial t}\\right)_i = -\\frac{1}{\\rho_i}\\,\\left(\\frac{dF}{dz}\\right)_i $$\nwhere the air density $\\rho_i$ is given by the hydrostatic profile $\\rho_i = \\rho_0 \\exp\\left(-\\frac{z_i}{H}\\right)$, with $\\rho_0 = 1.2\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$ and $H = 8000\\,\\mathrm{m}$.\n\nThe final results for $\\phi_u$ and $\\frac{\\partial \\bar{\\phi}}{\\partial t}$ are rounded to six decimal places as required. This algorithm will be applied to each of the three test cases.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the moist convection parameterization problem\n    for the given test suite.\n    \"\"\"\n\n    # Constants\n    RHO_0 = 1.2  # kg/m^3\n    H_SCALE = 8000.0  # m\n\n    def calculate_profiles(z, M, epsilon, delta, phi_e, delta_phi_0):\n        \"\"\"\n        Calculates the updraft scalar profile phi_u and the grid-mean\n        convective tendency for a single case.\n\n        Args:\n            z (np.ndarray): Vertical levels in meters.\n            M (np.ndarray): Updraft mass flux profile.\n            epsilon (np.ndarray): Entrainment rate profile.\n            delta (np.ndarray): Detrainment rate profile.\n            phi_e (np.ndarray): Environmental scalar profile.\n            delta_phi_0 (float): Cloud-base updraft scalar excess.\n\n        Returns:\n            tuple: A tuple containing two lists:\n                   - The rounded phi_u profile.\n                   - The rounded tendency profile.\n        \"\"\"\n        N = len(z)\n        \n        # 1. Compute updraft scalar profile phi_u\n        phi_u = np.zeros(N)\n        phi_u[0] = phi_e[0] + delta_phi_0\n        \n        for i in range(N - 1):\n            dz = z[i+1] - z[i]\n            # First-order forward Euler integration\n            phi_u[i+1] = phi_u[i] + dz * epsilon[i] * (phi_e[i] - phi_u[i])\n\n        # 2. Compute air density profile rho\n        rho = RHO_0 * np.exp(-z / H_SCALE)\n\n        # 3. Compute convective scalar flux F\n        F = M * (phi_u - phi_e)\n\n        # 4. Compute vertical derivative of the flux, dF/dz\n        dFdz = np.zeros(N)\n        \n        # Lower boundary: forward difference\n        dFdz[0] = (F[1] - F[0]) / (z[1] - z[0])\n        \n        # Interior: centered difference\n        for i in range(1, N - 1):\n            dFdz[i] = (F[i+1] - F[i-1]) / (z[i+1] - z[i-1])\n            \n        # Upper boundary: backward difference\n        dFdz[N-1] = (F[N-1] - F[N-2]) / (z[N-1] - z[N-2])\n\n        # 5. Compute grid-mean tendency\n        tendency = -1.0 / rho * dFdz\n\n        # 6. Round results to 6 decimal places\n        phi_u_rounded = np.round(phi_u, 6).tolist()\n        tendency_rounded = np.round(tendency, 6).tolist()\n\n        return phi_u_rounded, tendency_rounded\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case A\n        {\n            \"z\": np.array([0, 1000, 2000, 3000, 4000, 5000], dtype=float),\n            \"M\": np.array([0.060, 0.080, 0.100, 0.080, 0.050, 0.020], dtype=float),\n            \"epsilon\": np.array([1.0e-4, 1.5e-4, 2.0e-4, 2.0e-4, 1.5e-4, 1.0e-4], dtype=float),\n            \"delta\": np.array([2.0e-4, 2.5e-4, 3.0e-4, 3.0e-4, 2.5e-4, 2.0e-4], dtype=float),\n            \"phi_e\": np.array([0.018, 0.016, 0.013, 0.010, 0.007, 0.005], dtype=float),\n            \"delta_phi_0\": 0.004\n        },\n        # Case B\n        {\n            \"z\": np.array([0, 1500, 3000, 4500], dtype=float),\n            \"M\": np.array([0.050, 0.060, 0.040, 0.010], dtype=float),\n            \"epsilon\": np.array([0.0, 0.0, 0.0, 0.0], dtype=float),\n            \"delta\": np.array([1.0e-4, 2.0e-4, 3.0e-4, 4.0e-4], dtype=float),\n            \"phi_e\": np.array([0.020, 0.015, 0.010, 0.006], dtype=float),\n            \"delta_phi_0\": 0.000\n        },\n        # Case C\n        {\n            \"z\": np.array([0, 800, 1600, 2400, 3200, 4000], dtype=float),\n            \"M\": np.array([0.070, 0.090, 0.070, 0.050, 0.030, 0.010], dtype=float),\n            \"epsilon\": np.array([2.0e-4, 3.0e-4, 4.0e-4, 5.0e-4, 6.0e-4, 7.0e-4], dtype=float),\n            \"delta\": np.array([1.5e-4, 2.5e-4, 3.5e-4, 4.5e-4, 5.5e-4, 6.5e-4], dtype=float),\n            \"phi_e\": np.array([0.019, 0.017, 0.014, 0.012, 0.010, 0.009], dtype=float),\n            \"delta_phi_0\": 0.003\n        }\n    ]\n\n    all_results_str = []\n    for case in test_cases:\n        phi_u, tendency = calculate_profiles(\n            case[\"z\"], case[\"M\"], case[\"epsilon\"], case[\"delta\"], case[\"phi_e\"], case[\"delta_phi_0\"]\n        )\n        \n        phi_u_str = f\"[{','.join(map(str, phi_u))}]\"\n        tendency_str = f\"[{','.join(map(str, tendency))}]\"\n        \n        case_result_str = f\"[{phi_u_str},{tendency_str}]\"\n        all_results_str.append(case_result_str)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(all_results_str)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "A critical step in developing and evaluating any parameterization is to ensure it respects the fundamental conservation laws of physics, namely the conservation of total water and energy. Discretization errors, inconsistent assumptions between different model components, or simplified physics can lead to artificial sources or sinks in the column budgets. This diagnostic exercise guides you through the process of computing column budget residuals for water and energy, a vital skill for identifying model errors and ensuring the physical integrity of a simulation .",
            "id": "4066636",
            "problem": "Consider a single atmospheric column used in Numerical Weather Prediction (NWP) and climate modeling, with moist convection parameterization acting alongside large-scale dynamics and radiation. The column water budget and column energy budget are governed by conservation laws. In pressure coordinates, the hydrostatic balance implies that a layer-mass weighting of any prognostic tendency reduces to a pressure-thickness scaling. The goal is to compute residuals in the column-integrated water and energy budgets given diagnosed convective tendencies and large-scale forcing, and to attribute budget errors to specific parameterization components.\n\nFundamental base:\n- Conservation of total water mass: the column-integrated tendency of total water mixing ratio $q_t$ equals the sum of resolved-scale sources, parameterized convective sources, and surface evaporation minus surface precipitation.\n- Conservation of moist static energy: the column-integrated tendency of moist static energy equals the sum of resolved-scale heating, parameterized convective heating and moist processes, radiative heating, and the net surface energy input from sensible heat and evaporation.\n\nDefinitions:\n- Let $p$ be pressure and $g$ the gravitational acceleration. For layer $i$ with pressure thickness $\\Delta p_i$, the mass-weighted integral of any tendency $S_i$ per unit mass (units of $\\mathrm{s}^{-1}$ for mixing ratio or $\\mathrm{K}\\,\\mathrm{s}^{-1}$ for temperature) is discretized as $\\sum_i (\\Delta p_i / g) S_i$.\n- Let $q_v$ denote water vapor mixing ratio and assume $q_t = q_v$ (no cloud condensate retained in the column for this exercise). Let $T$ denote temperature and $z$ denote geometric height of the layer midpoint. Let $c_p$ be specific heat at constant pressure and $L_v$ be latent heat of vaporization.\n- Column water content $W$ per unit area is $W = \\int_0^{p_s} q_t \\,\\mathrm{d}p / g \\approx \\sum_i (\\Delta p_i / g) q_{t,i}$, with time tendency $\\mathrm{d}W/\\mathrm{d}t$ having units $\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$.\n- Column moist static energy $H$ per unit area is $H = \\int_0^{p_s} \\left( c_p T + g z + L_v q_v \\right) \\mathrm{d}p / g \\approx \\sum_i (\\Delta p_i / g) \\left( c_p T_i + g z_i + L_v q_{v,i} \\right)$, with time tendency $\\mathrm{d}H/\\mathrm{d}t$ having units $\\mathrm{W}\\,\\mathrm{m}^{-2}$.\n- The water budget source terms are large-scale water tendency $S_{q}^{\\mathrm{LS}}$, convective components $S_{q}^{\\mathrm{MF}}$, $S_{q}^{\\mathrm{DET}}$, $S_{q}^{\\mathrm{MIC}}$ (mass flux transport, detrainment, microphysical phase change removing vapor), evaporation $E$ at the surface (units $\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$), and precipitation $P$ at the surface (units $\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$). The column water budget residual is\n$$\nR_W = \\frac{W^{(t+\\Delta t)} - W^{(t)}}{\\Delta t} - \\sum_i \\frac{\\Delta p_i}{g} \\left( S_{q,i}^{\\mathrm{LS}} + S_{q,i}^{\\mathrm{MF}} + S_{q,i}^{\\mathrm{DET}} + S_{q,i}^{\\mathrm{MIC}} \\right) - \\left( E - P \\right).\n$$\nExpress $R_W$ in $\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$.\n\n- The energy budget source terms are large-scale temperature tendency $S_{T}^{\\mathrm{LS}}$, convective temperature components $S_{T}^{\\mathrm{MF}}$, $S_{T}^{\\mathrm{DET}}$, $S_{T}^{\\mathrm{MIC}}$, radiative temperature tendency $S_{T}^{\\mathrm{RAD}}$, large-scale and convective vapor tendencies $S_{q}^{\\mathrm{LS}}$, $S_{q}^{\\mathrm{MF}}$, $S_{q}^{\\mathrm{DET}}$, $S_{q}^{\\mathrm{MIC}}$, and surface sensible and latent fluxes $H_{\\mathrm{sfc}}$ and $L_v E$. The column energy budget residual is\n$$\nR_H = \\frac{H^{(t+\\Delta t)} - H^{(t)}}{\\Delta t} - \\sum_i \\frac{\\Delta p_i}{g} \\left[ c_p \\left( S_{T,i}^{\\mathrm{LS}} + S_{T,i}^{\\mathrm{MF}} + S_{T,i}^{\\mathrm{DET}} + S_{T,i}^{\\mathrm{MIC}} + S_{T,i}^{\\mathrm{RAD}} \\right) + L_v \\left( S_{q,i}^{\\mathrm{LS}} + S_{q,i}^{\\mathrm{MF}} + S_{q,i}^{\\mathrm{DET}} + S_{q,i}^{\\mathrm{MIC}} \\right) \\right] - \\left( H_{\\mathrm{sfc}} + L_v E \\right).\n$$\nExpress $R_H$ in $\\mathrm{W}\\,\\mathrm{m}^{-2}$.\n\nError attribution:\n- For the water budget, attribute $R_W$ to convective components by allocating component errors proportionally to their column contributions $C_q^{\\mathrm{MF}} = \\sum_i (\\Delta p_i/g) S_{q,i}^{\\mathrm{MF}}$, $C_q^{\\mathrm{DET}} = \\sum_i (\\Delta p_i/g) S_{q,i}^{\\mathrm{DET}}$, $C_q^{\\mathrm{MIC}} = \\sum_i (\\Delta p_i/g) S_{q,i}^{\\mathrm{MIC}}$. Define\n$$\ne_W^{(k)} = R_W \\, \\frac{\\left| C_q^{(k)} \\right|}{\\left| C_q^{\\mathrm{MF}} \\right| + \\left| C_q^{\\mathrm{DET}} \\right| + \\left| C_q^{\\mathrm{MIC}} \\right| + \\varepsilon},\n$$\nfor $k \\in \\left\\{ \\mathrm{MF}, \\mathrm{DET}, \\mathrm{MIC} \\right\\}$ and a small $\\varepsilon$ to avoid division by zero. Express $e_W^{(k)}$ in $\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$.\n\n- For the energy budget, attribute $R_H$ to convective components using their energy contributions $C_H^{\\mathrm{MF}} = \\sum_i (\\Delta p_i/g) \\left( c_p S_{T,i}^{\\mathrm{MF}} + L_v S_{q,i}^{\\mathrm{MF}} \\right)$, $C_H^{\\mathrm{DET}} = \\sum_i (\\Delta p_i/g) \\left( c_p S_{T,i}^{\\mathrm{DET}} + L_v S_{q,i}^{\\mathrm{DET}} \\right)$, $C_H^{\\mathrm{MIC}} = \\sum_i (\\Delta p_i/g) \\left( c_p S_{T,i}^{\\mathrm{MIC}} + L_v S_{q,i}^{\\mathrm{MIC}} \\right)$. Define\n$$\ne_H^{(k)} = R_H \\, \\frac{\\left| C_H^{(k)} \\right|}{\\left| C_H^{\\mathrm{MF}} \\right| + \\left| C_H^{\\mathrm{DET}} \\right| + \\left| C_H^{\\mathrm{MIC}} \\right| + \\varepsilon},\n$$\nfor $k \\in \\left\\{ \\mathrm{MF}, \\mathrm{DET}, \\mathrm{MIC} \\right\\}$. Express $e_H^{(k)}$ in $\\mathrm{W}\\,\\mathrm{m}^{-2}$.\n\nDiscretization and physical constants:\n- Use $g = 9.81\\,\\mathrm{m}\\,\\mathrm{s}^{-2}$, $c_p = 1004\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$, $L_v = 2.5\\times 10^6\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}$, and a time step $\\Delta t = 600\\,\\mathrm{s}$.\n- The column has $4$ layers with pressure thicknesses $\\Delta p = [12000, 12000, 12000, 12000]\\,\\mathrm{Pa}$ and heights $z = [500, 1500, 2500, 3500]\\,\\mathrm{m}$.\n- For all cases, assume $q_t = q_v$.\n\nTest suite:\nProvide the following three parameter sets. In each case, all arrays are length $4$ ordered from bottom to top. Temperatures are in $\\mathrm{K}$ and mixing ratios are in $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$. Tendency arrays for temperature are in $\\mathrm{K}\\,\\mathrm{s}^{-1}$ and for moisture in $\\mathrm{kg}\\,\\mathrm{kg}^{-1}\\,\\mathrm{s}^{-1}$. Surface fluxes $E$ (evaporation), $P$ (precipitation), and $H_{\\mathrm{sfc}}$ (sensible heat) are given in their respective units.\n\n- Case $1$ (general happy path):\nInitial temperature $T^{(t)} = [290.0, 285.0, 275.0, 265.0]$, final temperature $T^{(t+\\Delta t)} = T^{(t)} + \\Delta t \\left( S_T^{\\mathrm{LS}} + S_T^{\\mathrm{MF}} + S_T^{\\mathrm{DET}} + S_T^{\\mathrm{MIC}} + S_T^{\\mathrm{RAD}} \\right) + [0.02, -0.01, 0.0, 0.0]$.\nInitial vapor $q^{(t)} = [0.012, 0.009, 0.004, 0.001]$, final vapor $q^{(t+\\Delta t)} = q^{(t)} + \\Delta t \\left( S_q^{\\mathrm{LS}} + S_q^{\\mathrm{MF}} + S_q^{\\mathrm{DET}} + S_q^{\\mathrm{MIC}} \\right)$.\nTendencies: $S_T^{\\mathrm{LS}} = [5\\times 10^{-5}, 4\\times 10^{-5}, 3\\times 10^{-5}, 2\\times 10^{-5}]$, $S_T^{\\mathrm{MF}} = [1\\times 10^{-4}, 8\\times 10^{-5}, 6\\times 10^{-5}, 4\\times 10^{-5}]$, $S_T^{\\mathrm{DET}} = [2\\times 10^{-5}, 0.0, -1\\times 10^{-5}, -2\\times 10^{-5}]$, $S_T^{\\mathrm{MIC}} = [3\\times 10^{-5}, 2\\times 10^{-5}, 1\\times 10^{-5}, 0.0]$, $S_T^{\\mathrm{RAD}} = [-3\\times 10^{-5}, -2\\times 10^{-5}, -1\\times 10^{-5}, 0.0]$.\nMoisture tendencies: $S_q^{\\mathrm{LS}} = [1\\times 10^{-8}, -2\\times 10^{-8}, -3\\times 10^{-8}, -1\\times 10^{-8}]$, $S_q^{\\mathrm{MF}} = [-2\\times 10^{-7}, -1.5\\times 10^{-7}, -1\\times 10^{-7}, -0.5\\times 10^{-7}]$, $S_q^{\\mathrm{DET}} = [5\\times 10^{-8}, 4\\times 10^{-8}, 3\\times 10^{-8}, 2\\times 10^{-8}]$, $S_q^{\\mathrm{MIC}} = [-3\\times 10^{-8}, -2\\times 10^{-8}, -1\\times 10^{-8}, 0.0]$.\nSurface fluxes: $E = 1.0\\times 10^{-4}\\,\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$, $P = 8.0\\times 10^{-5}\\,\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$, $H_{\\mathrm{sfc}} = 50.0\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$.\n\n- Case $2$ (boundary case with zero convective tendencies and $E = P$):\nInitial temperature $T^{(t)} = [289.0, 284.0, 274.0, 264.0]$, final temperature $T^{(t+\\Delta t)} = T^{(t)} + \\Delta t \\left( S_T^{\\mathrm{LS}} + S_T^{\\mathrm{RAD}} \\right)$.\nInitial vapor $q^{(t)} = [0.011, 0.0085, 0.0038, 0.0009]$, final vapor $q^{(t+\\Delta t)} = q^{(t)} + \\Delta t \\left( S_q^{\\mathrm{LS}} \\right)$.\nTendencies: $S_T^{\\mathrm{LS}} = [3\\times 10^{-5}, 2\\times 10^{-5}, 1\\times 10^{-5}, 0.0]$, $S_T^{\\mathrm{MF}} = [0.0, 0.0, 0.0, 0.0]$, $S_T^{\\mathrm{DET}} = [0.0, 0.0, 0.0, 0.0]$, $S_T^{\\mathrm{MIC}} = [0.0, 0.0, 0.0, 0.0]$, $S_T^{\\mathrm{RAD}} = [-2\\times 10^{-5}, -1\\times 10^{-5}, 0.0, -1\\times 10^{-5}]$.\nMoisture tendencies: $S_q^{\\mathrm{LS}} = [2\\times 10^{-8}, -2\\times 10^{-8}, 0.0, 0.0]$, $S_q^{\\mathrm{MF}} = [0.0, 0.0, 0.0, 0.0]$, $S_q^{\\mathrm{DET}} = [0.0, 0.0, 0.0, 0.0]$, $S_q^{\\mathrm{MIC}} = [0.0, 0.0, 0.0, 0.0]$.\nSurface fluxes: $E = 5.0\\times 10^{-5}\\,\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$, $P = 5.0\\times 10^{-5}\\,\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$, $H_{\\mathrm{sfc}} = 30.0\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$.\n\n- Case $3$ (edge case with weak convective effects and $P  E$):\nInitial temperature $T^{(t)} = [291.0, 286.0, 276.0, 266.0]$, final temperature $T^{(t+\\Delta t)} = T^{(t)} + \\Delta t \\left( S_T^{\\mathrm{LS}} + S_T^{\\mathrm{MF}} + S_T^{\\mathrm{DET}} + S_T^{\\mathrm{MIC}} + S_T^{\\mathrm{RAD}} \\right) + [-0.01, 0.01, 0.0, 0.0]$.\nInitial vapor $q^{(t)} = [0.0125, 0.0092, 0.0042, 0.0011]$, final vapor $q^{(t+\\Delta t)} = q^{(t)} + \\Delta t \\left( S_q^{\\mathrm{LS}} + S_q^{\\mathrm{MF}} + S_q^{\\mathrm{DET}} + S_q^{\\mathrm{MIC}} \\right)$.\nTendencies: $S_T^{\\mathrm{LS}} = [1\\times 10^{-5}, -1\\times 10^{-5}, 0.0, 2\\times 10^{-5}]$, $S_T^{\\mathrm{MF}} = [2\\times 10^{-5}, 0.0, 1\\times 10^{-5}, -1\\times 10^{-5}]$, $S_T^{\\mathrm{DET}} = [-1\\times 10^{-5}, 1\\times 10^{-5}, 0.0, 0.0]$, $S_T^{\\mathrm{MIC}} = [0.0, 0.0, 2\\times 10^{-5}, -1\\times 10^{-5}]$, $S_T^{\\mathrm{RAD}} = [-1\\times 10^{-5}, -1\\times 10^{-5}, -1\\times 10^{-5}, -1\\times 10^{-5}]$.\nMoisture tendencies: $S_q^{\\mathrm{LS}} = [-1\\times 10^{-8}, -1\\times 10^{-8}, -1\\times 10^{-8}, -1\\times 10^{-8}]$, $S_q^{\\mathrm{MF}} = [1\\times 10^{-8}, 0.5\\times 10^{-8}, -0.5\\times 10^{-8}, -1\\times 10^{-8}]$, $S_q^{\\mathrm{DET}} = [0.0, 0.5\\times 10^{-8}, 0.5\\times 10^{-8}, 0.0]$, $S_q^{\\mathrm{MIC}} = [-0.5\\times 10^{-8}, -0.5\\times 10^{-8}, 0.0, 0.0]$.\nSurface fluxes: $E = 1.0\\times 10^{-5}\\,\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$, $P = 3.0\\times 10^{-5}\\,\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$, $H_{\\mathrm{sfc}} = 20.0\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$.\n\nYour task:\n- Implement a program that, for each case, computes $R_W$, $R_H$, the triplet $\\left[ e_W^{\\mathrm{MF}}, e_W^{\\mathrm{DET}}, e_W^{\\mathrm{MIC}} \\right]$, and the triplet $\\left[ e_H^{\\mathrm{MF}}, e_H^{\\mathrm{DET}}, e_H^{\\mathrm{MIC}} \\right]$.\n- Use the discretization rule $\\sum_i (\\Delta p_i/g)\\,(\\cdot)$ with the provided $\\Delta p_i$ and $g$.\n- Express $R_W$ in $\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$ and $R_H$ and the $e_H^{(k)}$ in $\\mathrm{W}\\,\\mathrm{m}^{-2}$, while $e_W^{(k)}$ in $\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each case’s result is itself a list in the form $\\left[ R_W, R_H, [ e_W^{\\mathrm{MF}}, e_W^{\\mathrm{DET}}, e_W^{\\mathrm{MIC}} ], [ e_H^{\\mathrm{MF}}, e_H^{\\mathrm{DET}}, e_H^{\\mathrm{MIC}} ] \\right]$.\n\nFinal output format example (do not reuse these numbers): $[[0.001,300.0,[0.0003,0.0002,0.0005],[120.0,80.0,100.0]],[\\ldots], [\\ldots]]$.",
            "solution": "The problem statement has been critically examined and is determined to be valid. It is scientifically grounded in atmospheric physics, well-posed with all necessary information provided, and objective in its formulation. The problem requires the implementation of budget residual calculations for a single atmospheric column, a standard diagnostic procedure in numerical weather prediction and climate modeling. All physical constants, state variables, and tendency terms are provided with consistent units and plausible magnitudes. The definition of the final states $T^{(t+\\Delta t)}$ and $q^{(t+\\Delta t)}$ includes specific formulations that lead to non-zero residuals, which is the point of the exercise: to diagnose these imbalances. The procedure for attributing the residuals to specific convective parameterization components is mathematically well-defined. A very small ambiguity exists in the value of the regularization parameter $\\varepsilon$; as is standard practice, a small machine-precision value, $\\varepsilon = 10^{-20}$, will be utilized to prevent division by zero without meaningfully impacting the result.\n\nThe solution proceeds by first defining the physical and discretization constants. Then, for each test case, we will execute a sequence of calculations as described below.\n\n**1. Physical Constants and Discretization Parameters**\n\nThe following constants and parameters are defined as per the problem statement:\n- Gravitational acceleration: $g = 9.81\\,\\mathrm{m}\\,\\mathrm{s}^{-2}$\n- Specific heat of dry air at constant pressure: $c_p = 1004\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$\n- Latent heat of vaporization of water: $L_v = 2.5 \\times 10^6\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}$\n- Time step: $\\Delta t = 600\\,\\mathrm{s}$\n- Layer pressure thicknesses: $\\Delta p_i = 12000\\,\\mathrm{Pa}$ for all $4$ layers.\n- Layer midpoint geometric heights: $z = [500, 1500, 2500, 3500]\\,\\mathrm{m}$.\n\nFrom these, the mass of air per unit area in each layer, $\\Delta m_i$, is calculated as $\\Delta m_i = \\Delta p_i / g$. The column-integrated value of a quantity $X$ per unit mass is then the sum over all layers, $\\sum_i (\\Delta p_i / g) X_i$.\n\n**2. Calculation of Final States and Column-Integrated Quantities**\n\nFor each test case, we are given the initial temperature $T^{(t)}$ and water vapor mixing ratio $q^{(t)}$. The final states $T^{(t+\\Delta t)}$ and $q^{(t+\\Delta t)}$ are defined by forward integration over the time step $\\Delta t$ using the provided tendency terms.\n\nThe final water vapor $q^{(t+\\Delta t)}$ is:\n$$\nq_i^{(t+\\Delta t)} = q_i^{(t)} + \\Delta t \\left( S_{q,i}^{\\mathrm{LS}} + S_{q,i}^{\\mathrm{MF}} + S_{q,i}^{\\mathrm{DET}} + S_{q,i}^{\\mathrm{MIC}} \\right)\n$$\nThe final temperature $T^{(t+\\Delta t)}$ includes an additional explicit perturbation term, $\\delta T_i$, which represents an unaccounted-for source or sink of heat in the budget:\n$$\nT_i^{(t+\\Delta t)} = T_i^{(t)} + \\Delta t \\left( S_{T,i}^{\\mathrm{LS}} + S_{T,i}^{\\mathrm{MF}} + S_{T,i}^{\\mathrm{DET}} + S_{T,i}^{\\mathrm{MIC}} + S_{T,i}^{\\mathrm{RAD}} \\right) + \\delta T_i\n$$\nUsing these initial and final states, we compute the column-integrated water content $W$ and moist static energy $H$ at times $t$ and $t+\\Delta t$:\n$$\nW = \\sum_i \\frac{\\Delta p_i}{g} q_{i}\n$$\n$$\nH = \\sum_i \\frac{\\Delta p_i}{g} \\left( c_p T_i + g z_i + L_v q_{i} \\right)\n$$\nThe assumption $q_t = q_v$ is used throughout, so $q$ refers to the water vapor mixing ratio.\n\n**3. Budget Residual Calculation ($R_W$, $R_H$)**\n\nThe residuals are defined as the difference between the diagnosed column storage change and the sum of all known source/sink terms.\n\nThe water budget residual $R_W$ is:\n$$\nR_W = \\frac{W^{(t+\\Delta t)} - W^{(t)}}{\\Delta t} - \\left[ \\sum_i \\frac{\\Delta p_i}{g} \\left( S_{q,i}^{\\mathrm{LS}} + S_{q,i}^{\\mathrm{MF}} + S_{q,i}^{\\mathrm{DET}} + S_{q,i}^{\\mathrm{MIC}} \\right) + \\left( E - P \\right) \\right]\n$$\nThe first term is the diagnosed change in water storage. The term in brackets is the total known water source from column processes and surface fluxes.\n\nThe energy budget residual $R_H$ is:\n$$\nR_H = \\frac{H^{(t+\\Delta t)} - H^{(t)}}{\\Delta t} - \\left[ \\sum_i \\frac{\\Delta p_i}{g} \\left( c_p \\sum S_{T,i} + L_v \\sum S_{q,i} \\right) + \\left( H_{\\mathrm{sfc}} + L_v E \\right) \\right]\n$$\nwhere $\\sum S_{T,i} = S_{T,i}^{\\mathrm{LS}} + S_{T,i}^{\\mathrm{MF}} + S_{T,i}^{\\mathrm{DET}} + S_{T,i}^{\\mathrm{MIC}} + S_{T,i}^{\\mathrm{RAD}}$ and $\\sum S_{q,i} = S_{q,i}^{\\mathrm{LS}} + S_{q,i}^{\\mathrm{MF}} + S_{q,i}^{\\mathrm{DET}} + S_{q,i}^{\\mathrm{MIC}}$. The first term is the diagnosed change in energy storage. The term in brackets is the total known energy source from column processes (thermal and latent) and surface fluxes (sensible and latent).\n\n**4. Error Attribution**\n\nThe calculated residuals $R_W$ and $R_H$ are attributed to the convective components (mass flux `MF`, detrainment `DET`, microphysics `MIC`) proportionally to the absolute magnitude of their column-integrated contributions.\n\nFirst, we compute the column-integrated contribution of each convective component to the water budget:\n$$\nC_q^{(k)} = \\sum_i \\frac{\\Delta p_i}{g} S_{q,i}^{(k)} \\quad \\text{for } k \\in \\left\\{ \\mathrm{MF}, \\mathrm{DET}, \\mathrm{MIC} \\right\\}\n$$\nThe attributed water budget errors $e_W^{(k)}$ are then:\n$$\ne_W^{(k)} = R_W \\, \\frac{\\left| C_q^{(k)} \\right|}{\\left| C_q^{\\mathrm{MF}} \\right| + \\left| C_q^{\\mathrm{DET}} \\right| + \\left| C_q^{\\mathrm{MIC}} \\right| + \\varepsilon}\n$$\nSimilarly, we compute the column-integrated energy contribution of each convective component:\n$$\nC_H^{(k)} = \\sum_i \\frac{\\Delta p_i}{g} \\left( c_p S_{T,i}^{(k)} + L_v S_{q,i}^{(k)} \\right) \\quad \\text{for } k \\in \\left\\{ \\mathrm{MF}, \\mathrm{DET}, \\mathrm{MIC} \\right\\}\n$$\nThe attributed energy budget errors $e_H^{(k)}$ are:\n$$\ne_H^{(k)} = R_H \\, \\frac{\\left| C_H^{(k)} \\right|}{\\left| C_H^{\\mathrm{MF}} \\right| + \\left| C_H^{\\mathrm{DET}} \\right| + \\left| C_H^{\\mathrm{MIC}} \\right| + \\varepsilon}\n$$\nThis comprehensive procedure is applied to each of the three test cases specified in the problem.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes and attributes budget residuals for an atmospheric column model.\n    \"\"\"\n    # Physical constants\n    g = 9.81  # m/s^2\n    c_p = 1004  # J/kg/K\n    L_v = 2.5e6  # J/kg\n    delta_t = 600  # s\n    epsilon = 1e-20  # Small number to prevent division by zero\n\n    # Discretization\n    delta_p = np.array([12000, 12000, 12000, 12000])  # Pa\n    z = np.array([500, 1500, 2500, 3500])  # m\n    mass_weight = delta_p / g # kg/m^2\n\n    test_cases = [\n        # Case 1: general happy path\n        {\n            \"T_t\": np.array([290.0, 285.0, 275.0, 265.0]),\n            \"q_t\": np.array([0.012, 0.009, 0.004, 0.001]),\n            \"S_T_LS\": np.array([5e-5, 4e-5, 3e-5, 2e-5]),\n            \"S_T_MF\": np.array([1e-4, 8e-5, 6e-5, 4e-5]),\n            \"S_T_DET\": np.array([2e-5, 0.0, -1e-5, -2e-5]),\n            \"S_T_MIC\": np.array([3e-5, 2e-5, 1e-5, 0.0]),\n            \"S_T_RAD\": np.array([-3e-5, -2e-5, -1e-5, 0.0]),\n            \"delta_T_extra\": np.array([0.02, -0.01, 0.0, 0.0]),\n            \"S_q_LS\": np.array([1e-8, -2e-8, -3e-8, -1e-8]),\n            \"S_q_MF\": np.array([-2e-7, -1.5e-7, -1e-7, -0.5e-7]),\n            \"S_q_DET\": np.array([5e-8, 4e-8, 3e-8, 2e-8]),\n            \"S_q_MIC\": np.array([-3e-8, -2e-8, -1e-8, 0.0]),\n            \"E\": 1.0e-4, \"P\": 8.0e-5, \"H_sfc\": 50.0,\n        },\n        # Case 2: boundary case with zero convective tendencies\n        {\n            \"T_t\": np.array([289.0, 284.0, 274.0, 264.0]),\n            \"q_t\": np.array([0.011, 0.0085, 0.0038, 0.0009]),\n            \"S_T_LS\": np.array([3e-5, 2e-5, 1e-5, 0.0]),\n            \"S_T_MF\": np.array([0.0, 0.0, 0.0, 0.0]),\n            \"S_T_DET\": np.array([0.0, 0.0, 0.0, 0.0]),\n            \"S_T_MIC\": np.array([0.0, 0.0, 0.0, 0.0]),\n            \"S_T_RAD\": np.array([-2e-5, -1e-5, 0.0, -1e-5]),\n            \"delta_T_extra\": np.array([0.0, 0.0, 0.0, 0.0]),\n            \"S_q_LS\": np.array([2e-8, -2e-8, 0.0, 0.0]),\n            \"S_q_MF\": np.array([0.0, 0.0, 0.0, 0.0]),\n            \"S_q_DET\": np.array([0.0, 0.0, 0.0, 0.0]),\n            \"S_q_MIC\": np.array([0.0, 0.0, 0.0, 0.0]),\n            \"E\": 5.0e-5, \"P\": 5.0e-5, \"H_sfc\": 30.0,\n        },\n        # Case 3: edge case with weak convective effects\n        {\n            \"T_t\": np.array([291.0, 286.0, 276.0, 266.0]),\n            \"q_t\": np.array([0.0125, 0.0092, 0.0042, 0.0011]),\n            \"S_T_LS\": np.array([1e-5, -1e-5, 0.0, 2e-5]),\n            \"S_T_MF\": np.array([2e-5, 0.0, 1e-5, -1e-5]),\n            \"S_T_DET\": np.array([-1e-5, 1e-5, 0.0, 0.0]),\n            \"S_T_MIC\": np.array([0.0, 0.0, 2e-5, -1e-5]),\n            \"S_T_RAD\": np.array([-1e-5, -1e-5, -1e-5, -1e-5]),\n            \"delta_T_extra\": np.array([-0.01, 0.01, 0.0, 0.0]),\n            \"S_q_LS\": np.array([-1e-8, -1e-8, -1e-8, -1e-8]),\n            \"S_q_MF\": np.array([1e-8, 0.5e-8, -0.5e-8, -1e-8]),\n            \"S_q_DET\": np.array([0.0, 0.5e-8, 0.5e-8, 0.0]),\n            \"S_q_MIC\": np.array([-0.5e-8, -0.5e-8, 0.0, 0.0]),\n            \"E\": 1.0e-5, \"P\": 3.0e-5, \"H_sfc\": 20.0,\n        }\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        # Sum of all known tendencies\n        S_q_all = case[\"S_q_LS\"] + case[\"S_q_MF\"] + case[\"S_q_DET\"] + case[\"S_q_MIC\"]\n        S_T_all = case[\"S_T_LS\"] + case[\"S_T_MF\"] + case[\"S_T_DET\"] + case[\"S_T_MIC\"] + case[\"S_T_RAD\"]\n\n        # Final states\n        q_t_dt = case[\"q_t\"] + delta_t * S_q_all\n        T_t_dt = case[\"T_t\"] + delta_t * S_T_all + case[\"delta_T_extra\"]\n\n        # Water budget residual R_W\n        W_t = np.sum(mass_weight * case[\"q_t\"])\n        W_t_dt = np.sum(mass_weight * q_t_dt)\n        dW_dt = (W_t_dt - W_t) / delta_t\n        col_sources_W = np.sum(mass_weight * S_q_all)\n        sfc_sources_W = case[\"E\"] - case[\"P\"]\n        R_W = dW_dt - col_sources_W - sfc_sources_W\n\n        # Energy budget residual R_H\n        H_t_profile = c_p * case[\"T_t\"] + g * z + L_v * case[\"q_t\"]\n        H_t = np.sum(mass_weight * H_t_profile)\n        H_t_dt_profile = c_p * T_t_dt + g * z + L_v * q_t_dt\n        H_t_dt = np.sum(mass_weight * H_t_dt_profile)\n        dH_dt = (H_t_dt - H_t) / delta_t\n        col_sources_H = np.sum(mass_weight * (c_p * S_T_all + L_v * S_q_all))\n        sfc_sources_H = case[\"H_sfc\"] + L_v * case[\"E\"]\n        R_H = dH_dt - col_sources_H - sfc_sources_H\n\n        # Water error attribution\n        C_q_MF = np.sum(mass_weight * case[\"S_q_MF\"])\n        C_q_DET = np.sum(mass_weight * case[\"S_q_DET\"])\n        C_q_MIC = np.sum(mass_weight * case[\"S_q_MIC\"])\n        denom_W = np.abs(C_q_MF) + np.abs(C_q_DET) + np.abs(C_q_MIC) + epsilon\n        e_W_MF = R_W * np.abs(C_q_MF) / denom_W\n        e_W_DET = R_W * np.abs(C_q_DET) / denom_W\n        e_W_MIC = R_W * np.abs(C_q_MIC) / denom_W\n        e_W_list = [e_W_MF, e_W_DET, e_W_MIC]\n\n        # Energy error attribution\n        C_H_MF = np.sum(mass_weight * (c_p * case[\"S_T_MF\"] + L_v * case[\"S_q_MF\"]))\n        C_H_DET = np.sum(mass_weight * (c_p * case[\"S_T_DET\"] + L_v * case[\"S_q_DET\"]))\n        C_H_MIC = np.sum(mass_weight * (c_p * case[\"S_T_MIC\"] + L_v * case[\"S_q_MIC\"]))\n        denom_H = np.abs(C_H_MF) + np.abs(C_H_DET) + np.abs(C_H_MIC) + epsilon\n        e_H_MF = R_H * np.abs(C_H_MF) / denom_H\n        e_H_DET = R_H * np.abs(C_H_DET) / denom_H\n        e_H_MIC = R_H * np.abs(C_H_MIC) / denom_H\n        e_H_list = [e_H_MF, e_H_DET, e_H_MIC]\n        \n        all_results.append([R_W, R_H, e_W_list, e_H_list])\n\n    # Format the final output string manually to match the required format\n    result_strings = []\n    for res in all_results:\n        r_w_str = f\"{res[0]}\"\n        r_h_str = f\"{res[1]}\"\n        e_w_str = f\"[{','.join(f'{x}' for x in res[2])}]\"\n        e_h_str = f\"[{','.join(f'{x}' for x in res[3])}]\"\n        case_str = f\"[{r_w_str},{r_h_str},{e_w_str},{e_h_str}]\"\n        result_strings.append(case_str)\n    \n    print(f\"[{','.join(result_strings)}]\")\n\nsolve()\n```"
        }
    ]
}