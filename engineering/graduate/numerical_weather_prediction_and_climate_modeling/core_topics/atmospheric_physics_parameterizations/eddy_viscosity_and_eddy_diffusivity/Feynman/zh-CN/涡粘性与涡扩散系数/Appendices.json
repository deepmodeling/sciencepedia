{
    "hands_on_practices": [
        {
            "introduction": "本练习将理论与应用联系起来，演示如何从更基本的湍流特征，如湍流脉动动能（$k$）和混合长度（$l$），来估算涡粘性（$K_m$）。这项实践对于理解抽象的湍流闭合方案如何与可测量或可模拟的物理量建立联系至关重要，是应用湍流模型的基础步骤。",
            "id": "4034408",
            "problem": "在数值天气预报和气候模拟中，次网格尺度湍流动量输送的参数化通常基于梯度扩散假说（也称为 Boussinesq 近似）。该假说通过涡黏度将雷诺切应力与平均速度梯度联系起来。从雷诺平均纳维-斯托克斯 (RANS) 方程出发，垂直方向的湍流切应力表示为运动应力，定义为 $-\\overline{u^{\\prime} w^{\\prime}}$，其中 $\\overline{u^{\\prime} w^{\\prime}}$ 是水平和垂直速度脉动的协方差。在梯度扩散假说下，运动应力被建模为 $-\\overline{u^{\\prime} w^{\\prime}} = K_{m} \\, \\partial_{z} \\bar{u}$，其中 $K_{m}$ 是涡黏度，$\\partial_{z} \\bar{u}$ 是平均水平风的垂直梯度。\n\n利用量纲分析和 Prandtl 的混合长度理论，可以将涡黏度 $K_{m}$ 与混合长度 $l$ 和一个由湍流动能 $k$ 推导出的湍流速度尺度联系起来，其中无量纲闭合系数 $c_{\\mu}$ 用于解释模型不确定性和各向异性。请推导一个用 $k$、$l$ 和 $c_{\\mu}$ 表示 $K_{m}$ 的表达式，然后用它计算在中性大气边界层情况下的涡黏度和相应的运动湍流切应力，已知以下量：\n- 湍流动能 $k = 0.5 \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-2}$，\n- 混合长度 $l = 30 \\,\\mathrm{m}$，\n- 闭合系数 $c_{\\mu} = 0.1$，\n- 平均垂直切变 $\\partial_{z} \\bar{u} = 0.02 \\,\\mathrm{s}^{-1}$。\n\n将涡黏度 $K_{m}$ 的单位表示为 $\\mathrm{m}^{2}\\,\\mathrm{s}^{-1}$，运动湍流切应力 $-\\overline{u^{\\prime} w^{\\prime}}$ 的单位表示为 $\\mathrm{m}^{2}\\,\\mathrm{s}^{-2}$。将您的数值答案四舍五入到四位有效数字。将您的最终答案以一个二元行向量 $\\big[K_{m},\\; -\\overline{u^{\\prime} w^{\\prime}}\\big]$ 的形式报告。",
            "solution": "首先对问题进行验证，以确保其具有科学依据、适定且客观。\n\n### 步骤 1：提取已知条件\n给出了以下量和定义：\n- 垂直方向的运动湍流切应力定义为 $-\\overline{u^{\\prime} w^{\\prime}}$。\n- 梯度扩散假说将切应力与平均速度梯度联系起来：$-\\overline{u^{\\prime} w^{\\prime}} = K_{m} \\, \\partial_{z} \\bar{u}$。\n- $K_{m}$ 是涡黏度。\n- $\\partial_{z} \\bar{u}$ 是平均水平风的垂直梯度。\n- 涡黏度 $K_{m}$ 需要用湍流动能 $k$、混合长度 $l$ 和闭合系数 $c_{\\mu}$ 来表示。\n- 湍流动能：$k = 0.5 \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-2}$。\n- 混合长度：$l = 30 \\,\\mathrm{m}$。\n- 闭合系数：$c_{\\mu} = 0.1$。\n- 平均垂直切变：$\\partial_{z} \\bar{u} = 0.02 \\,\\mathrm{s}^{-1}$。\n\n### 步骤 2：使用提取的已知条件进行验证\n对问题进行严格验证。\n- **科学依据**：该问题建立在雷诺平均纳维-斯托克斯 (RANS) 方程和湍流应力的 Boussinesq 近似之上，这些是流体动力学和大气科学中湍流建模的基石概念。使用 Prandtl 的混合长度理论和基于湍流动能 (TKE) 的速度尺度是参数化涡黏度的标准且成熟的方法。所提供的数值对于中性大气边界层是物理上现实的。\n- **适定性**：该问题明确要求推导一个表达式并随后计算两个物理量。所有必要的数据和关系都已提供，确保可以确定唯一且稳定的解。\n- **客观性**：该问题使用精确的技术术语表述，没有任何主观或模糊的语言。\n\n### 步骤 3：结论与行动\n该问题被判定为**有效**。它在科学上是合理的、自洽的且适定的。可以继续求解过程。\n\n### 推导与计算\n第一步是按照指示，基于量纲分析推导涡黏度 $K_{m}$ 的表达式。根据定义，涡黏度的单位是运动黏度，即长度的平方除以时间，$[\\mathrm{L}]^{2} [\\mathrm{T}]^{-1}$。我们需要用湍流动能 $k$、混合长度 $l$ 和无量纲系数 $c_{\\mu}$ 来构建这个量。\n\n给定量的量纲是：\n- 湍流动能，$k$：$[k] = [\\mathrm{L}]^{2} [\\mathrm{T}]^{-2}$ (单位质量的能量，或速度的平方)。\n- 混合长度，$l$：$[l] = [\\mathrm{L}]$。\n- 闭合系数，$c_{\\mu}$：无量纲，$[c_{\\mu}] = 1$。\n\n在 Prandtl 的混合长度理论中，涡黏度被参数化为特征湍流速度尺度 $v_{turb}$ 与湍流涡旋的特征长度尺度（即混合长度 $l$）的乘积。\n$$\nK_{m} \\propto v_{turb} \\cdot l\n$$\n问题指明湍流速度尺度应由湍流动能 $k$ 推导得出。TKE $k$ 定义为雷诺应力张量迹的一半，表示单位质量的湍流速度脉动的平均动能。它的量纲是速度的平方。因此，湍流速度尺度的自然选择是 $k$ 的平方根：\n$$\nv_{turb} \\propto \\sqrt{k}\n$$\n$\\sqrt{k}$ 的量纲是 $(\\sqrt{[\\mathrm{L}]^{2} [\\mathrm{T}]^{-2}}) = [\\mathrm{L}] [\\mathrm{T}]^{-1}$，这确实是速度的量纲。\n\n结合这些元素，涡黏度 $K_{m}$ 可以表示为：\n$$\nK_{m} = c_{\\mu} \\cdot v_{turb} \\cdot l = c_{\\mu} l \\sqrt{k}\n$$\n其中 $c_{\\mu}$ 是作为比例常数的无量纲闭合系数。这个表达式在量纲上是一致的：\n$$\n[K_{m}] = [c_{\\mu}] [l] [\\sqrt{k}] = (1) \\cdot ([\\mathrm{L}]) \\cdot ([\\mathrm{L}][\\mathrm{T}]^{-1}) = [\\mathrm{L}]^{2}[\\mathrm{T}]^{-1}\n$$\n这与涡黏度所需的量纲相符。\n\n现在，我们可以用给定的数据计算 $K_{m}$ 的数值：\n$k = 0.5 \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-2}$\n$l = 30 \\,\\mathrm{m}$\n$c_{\\mu} = 0.1$\n\n将这些值代入推导出的 $K_{m}$ 表达式中：\n$$\nK_{m} = (0.1) \\cdot (30 \\,\\mathrm{m}) \\cdot \\sqrt{0.5 \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-2}}\n$$\n$$\nK_{m} = 3 \\,\\mathrm{m} \\cdot \\sqrt{0.5} \\,\\mathrm{m}\\,\\mathrm{s}^{-1} = 3 \\sqrt{0.5} \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-1}\n$$\n$$\nK_{m} = \\frac{3}{\\sqrt{2}} \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-1} \\approx 2.12132034... \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-1}\n$$\n四舍五入到四位有效数字，我们得到：\n$$\nK_{m} \\approx 2.121 \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-1}\n$$\n\n接下来，我们使用梯度扩散假说计算运动湍流切应力 $-\\overline{u^{\\prime} w^{\\prime}}$：\n$$\n-\\overline{u^{\\prime} w^{\\prime}} = K_{m} \\, \\partial_{z} \\bar{u}\n$$\n为保持精度，我们在此计算中使用 $K_{m}$ 的未舍入值。给定的平均垂直切变为 $\\partial_{z} \\bar{u} = 0.02 \\,\\mathrm{s}^{-1}$。\n$$\n-\\overline{u^{\\prime} w^{\\prime}} = (2.12132034... \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-1}) \\cdot (0.02 \\,\\mathrm{s}^{-1})\n$$\n$$\n-\\overline{u^{\\prime} w^{\\prime}} = 0.042426406... \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-2}\n$$\n单位是 $(\\mathrm{m}^{2}\\,\\mathrm{s}^{-1}) \\cdot (\\mathrm{s}^{-1}) = \\mathrm{m}^{2}\\,\\mathrm{s}^{-2}$，这是运动应力（速度的平方）的正确单位。\n\n将此结果四舍五入到四位有效数字：\n$$\n-\\overline{u^{\\prime} w^{\\prime}} \\approx 0.04243 \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-2}\n$$\n\n最终答案由计算出的两个量 $K_{m}$ 和 $-\\overline{u^{\\prime} w^{\\prime}}$ 组成，以行向量的形式呈现。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 2.121  0.04243 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "大气中的物质输送通常是不同过程相互竞争的结果，例如平流和湍流扩散。本练习运用涡扩散系数的概念进行时间尺度分析，这是一个强大的诊断工具，有助于我们判断在特定条件下哪个过程占主导地位。理解这些相互竞争的时间尺度对于解释模型行为和设计参数化方案至关重要。",
            "id": "4034415",
            "problem": "在一个深度为 $H$ 的水平均匀大气边界层中，考虑一个无源标量浓度 $c(x,z,t)$ 的演变，该标量被一个恒定的平均风速 $U$ 水平平流，并被一个恒定的湍流涡动扩散系数 $K_h$ 垂直混合。从平流-扩散偏微分方程 (PDE)\n$$\n\\frac{\\partial c}{\\partial t} + U \\frac{\\partial c}{\\partial x} = \\frac{\\partial}{\\partial z}\\!\\left(K_h \\frac{\\partial c}{\\partial z}\\right),\n$$\n出发，并利用量纲分析，确定在等于边界层深度的代表性长度尺度上的输送的特征平流时间尺度和扩散时间尺度。用 $U$、$H$ 和 $K_h$ 推导出这些时间尺度的表达式，然后计算当 $H = 1.0\\,\\mathrm{km}$，$K_h = 5\\,\\mathrm{m}^2\\,\\mathrm{s}^{-1}$ 和 $U = 5\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$ 时，扩散时间尺度与平流时间尺度的比值，结果为一个无量纲数。假设 $U$ 和 $K_h$ 在空间和时间上是恒定的，并视 $H$ 为此次比较的相关垂直和水平长度尺度。将该比值报告为一个无单位的纯数，并将最终数值四舍五入到 $3$ 位有效数字。",
            "solution": "该问题要求从给定的平流-扩散偏微分方程 (PDE) 推导出平流和扩散的特征时间尺度，并随后计算它们的比值。\n\n无源标量浓度 $c(x,z,t)$ 的控制偏微分方程为：\n$$\n\\frac{\\partial c}{\\partial t} + U \\frac{\\partial c}{\\partial x} = \\frac{\\partial}{\\partial z}\\!\\left(K_h \\frac{\\partial c}{\\partial z}\\right)\n$$\n其中 $U$ 是恒定的平均风速，$K_h$ 是恒定的湍流涡动扩散系数。由于 $K_h$ 是常数，方程简化为：\n$$\n\\frac{\\partial c}{\\partial t} + U \\frac{\\partial c}{\\partial x} = K_h \\frac{\\partial^2 c}{\\partial z^2}\n$$\n该方程包含三项：局地变化率（非定常项）、水平平流项和垂直扩散项。\n\n为了进行量纲分析，我们估算每一项的尺度。令 $\\Delta C$ 表示浓度的特征变化量。问题指明，边界层深度 $H$ 应作为水平 ($x$) 和垂直 ($z$) 输送的代表性长度尺度。令 $\\tau$ 表示特征时间尺度。PDE 中的各项可以按如下方式进行尺度分析：\n\n非定常项：\n$$\n\\frac{\\partial c}{\\partial t} \\sim \\frac{\\Delta C}{\\tau}\n$$\n水平平流项：\n$$\nU \\frac{\\partial c}{\\partial x} \\sim U \\frac{\\Delta C}{H}\n$$\n垂直扩散项：\n$$\nK_h \\frac{\\partial^2 c}{\\partial z^2} \\sim K_h \\frac{\\Delta C}{H^2}\n$$\n一个过程的特征时间尺度是该过程引起目标物理量发生显著变化（与物理量本身同量级）所需的时间。这可以通过平衡非定常项与代表该过程的项来找到。\n\n特征平流时间尺度 $\\tau_{adv}$ 通过平衡非定常项与平流项得到：\n$$\n\\frac{\\Delta C}{\\tau_{adv}} \\sim U \\frac{\\Delta C}{H}\n$$\n解出 $\\tau_{adv}$ 得：\n$$\n\\tau_{adv} = \\frac{H}{U}\n$$\n这表示一个流体质点以速度 $U$ 平流过距离 $H$ 所需的时间。\n\n特征扩散时间尺度 $\\tau_{diff}$ 通过平衡非定常项与扩散项得到：\n$$\n\\frac{\\Delta C}{\\tau_{diff}} \\sim K_h \\frac{\\Delta C}{H^2}\n$$\n解出 $\\tau_{diff}$ 得：\n$$\n\\tau_{diff} = \\frac{H^2}{K_h}\n$$\n这表示标量属性在垂直距离 $H$ 上扩散的特征时间。\n\n问题要求计算扩散时间尺度与平流时间尺度的比值。设此比值为 $R$。\n$$\nR = \\frac{\\tau_{diff}}{\\tau_{adv}} = \\frac{H^2 / K_h}{H / U}\n$$\n化简此表达式得：\n$$\nR = \\frac{H^2}{K_h} \\cdot \\frac{U}{H} = \\frac{HU}{K_h}\n$$\n这个无量纲比值是佩克莱特数的一种形式，它比较了平流输送与扩散输送的相对重要性。一个大的 $R$ 值表明，在给定的尺度上，平流作用主导于扩散作用。\n\n现在，我们使用给定的数值来评估这个比值。首先，我们必须确保单位一致。边界层深度 $H$ 以千米为单位给出，必须转换为米。\n给定值为：\n$H = 1.0\\,\\mathrm{km} = 1000\\,\\mathrm{m}$\n$U = 5\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$\n$K_h = 5\\,\\mathrm{m}^2\\,\\mathrm{s}^{-1}$\n\n将这些值代入比值 $R$ 的表达式中：\n$$\nR = \\frac{(1000\\,\\mathrm{m}) \\times (5\\,\\mathrm{m}\\,\\mathrm{s}^{-1})}{5\\,\\mathrm{m}^2\\,\\mathrm{s}^{-1}}\n$$\n$$\nR = \\frac{5000\\,\\mathrm{m}^2 \\cdot \\mathrm{s}^{-1}}{5\\,\\mathrm{m}^2 \\cdot \\mathrm{s}^{-1}} = 1000\n$$\n结果是一个纯粹的无量纲数，正如预期。问题要求答案报告为 $3$ 位有效数字。为了将 $1000$ 表示为 $3$ 位有效数字，我们用科学记数法写成 $1.00 \\times 10^3$。",
            "answer": "$$\\boxed{1.00 \\times 10^3}$$"
        },
        {
            "introduction": "涡扩散的物理概念最终需要在天气和气候模型的代码中以离散算法的形式实现。这项高级实践将指导您从第一性原理出发，开发一个用于垂直扩散的有限体积数值方案，并着重处理可变扩散系数和通量守恒等关键细节。通过这项练习，您将深入理解连续的物理定律如何被转化为确保模型物理量守恒的稳健算法。",
            "id": "4034469",
            "problem": "考虑一个一维垂直列，它被离散化为 $N$ 个有限体积单元，单元厚度为 $\\Delta z_i$，其中 $i \\in \\{1,\\dots,N\\}$。令 $z$ 表示垂直坐标，单位为米。一个被动标量 $q(z,t)$（例如，单位为开尔文的位温）在垂直湍流扩散作用下演化，该扩散由一个可变的涡扩散系数 $K(z)$（单位为米平方/秒）表征。从标量守恒和 Fick 扩散定律出发，其控制方程为抛物线型偏微分方程\n$$\n\\frac{\\partial q}{\\partial t} = \\frac{\\partial}{\\partial z}\\left( K(z) \\frac{\\partial q}{\\partial z} \\right).\n$$\n假设每个单元的 $K$ 是分段常数，顶部和底部边界采用零通量（Neumann）边界条件，并使用后向欧拉时间离散化。您的任务是，从第一性原理出发，且不使用任何预先提供的快捷公式，推导一个在非均匀网格上的守恒有限体积隐式格式，该格式需要：\n- 在单元交界面上强制执行离散通量连续性，从而使穿过每个内部面的扩散通量被唯一地定义且连续。\n- 针对新时间层 $t^{n+1}$ 的未知单元中心值 $q_i^{n+1}$，根据时间 $t^n$ 的已知值 $q_i^n$，组装一个三对角线性系统。\n- 使用原地托马斯算法（三对角矩阵算法）求解该三对角系统。\n\n推导必须从控制体积上的守恒声明和 Fick 定律开始。离散交界面的处理必须遵循匹配每个内部面左右两侧通量的原则，从而得到一个与相邻单元内分段常数 $K$ 一致的唯界面通量表达式。推导完格式后，将其实现为一个完整、可运行的程序，该程序构建三对角矩阵系数并求解 $q^{n+1}$。\n\n为验证正确性和守恒性，对每个给定的测试用例，计算：\n- 旧时间层和新时间层之间列积分标量的相对变化，定义为\n$$\nR = \\frac{\\sum_{i=1}^{N} q_i^{n+1} \\Delta z_i - \\sum_{i=1}^{N} q_i^n \\Delta z_i}{\\sum_{i=1}^{N} q_i^n \\Delta z_i},\n$$\n该值为无量纲，且必须以小数形式报告。\n- 在新时间层，所有内部面上的最大绝对离散通量连续性残差，定义为\n$$\n\\max_{i \\in \\{1,\\dots,N-1\\}} \\left| F_{i+\\frac{1}{2}, \\text{left}}^{n+1} - F_{i+\\frac{1}{2}, \\text{right}}^{n+1} \\right|,\n$$\n其中每个面通量通过在交界面上强制连续性，由相邻的单元中心值计算得出。如果 $q$ 的单位是开尔文，此残差的单位必须是开尔文·米/秒，并以此单位报告。在所有测试中，您必须在顶部和底部使用零通量（Neumann）边界条件。\n\n您的程序必须实现该求解器，并为每个测试用例输出一个包含 $[R, \\text{max\\_residual}]$ 的双元素列表，并将所有测试用例的结果汇总到单行中。\n\n测试套件：\n使用以下科学上真实且自洽的参数集。在所有情况下，$z$ 的单位是米，$K$ 的单位是米平方/秒，$\\Delta t$ 的单位是秒。标量 $q$ 的单位是开尔文。不涉及角度单位。\n\n- 测试用例 1（理想情况，非均匀网格和强变化的涡扩散系数）：\n    - $N = 6$\n    - $\\Delta z = [20, 30, 50, 100, 200, 300]\\,\\mathrm{m}$\n    - $K = [0.1, 0.5, 2.0, 0.8, 0.2, 0.1]\\,\\mathrm{m}^2/\\mathrm{s}$\n    - $\\Delta t = 600\\,\\mathrm{s}$\n    - $q^n = [10, 8, 6, 5, 4, 3]\\,\\mathrm{K}$\n\n- 测试用例 2（均匀网格和弱扩散系数，小时间步长）：\n    - $N = 10$\n    - $\\Delta z = [100, 100, 100, 100, 100, 100, 100, 100, 100, 100]\\,\\mathrm{m}$\n    - $K = [0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01]\\,\\mathrm{m}^2/\\mathrm{s}$\n    - $\\Delta t = 1\\,\\mathrm{s}$\n    - $q^n = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\\,\\mathrm{K}$\n\n- 测试用例 3（边缘情况，末端单元非常薄且边界处涡扩散系数为零）：\n    - $N = 4$\n    - $\\Delta z = [1, 1000, 1000, 1]\\,\\mathrm{m}$\n    - $K = [0.0, 1.0, 0.1, 0.0]\\,\\mathrm{m}^2/\\mathrm{s}$\n    - $\\Delta t = 100\\,\\mathrm{s}$\n    - $q^n = [0, 10, 0, 10]\\,\\mathrm{K}$\n\n- 测试用例 4（交替的高低涡扩散系数以测试交界面处理的鲁棒性）：\n    - $N = 5$\n    - $\\Delta z = [50, 50, 50, 50, 50]\\,\\mathrm{m}$\n    - $K = [0.01, 10.0, 0.01, 10.0, 0.01]\\,\\mathrm{m}^2/\\mathrm{s}$\n    - $\\Delta t = 300\\,\\mathrm{s}$\n    - $q^n = [1, 0, 1, 0, 1]\\,\\mathrm{K}$\n\n最终输出格式：\n您的程序应生成单行输出，其中包含四个测试用例的结果，形式为逗号分隔的每个案例的双元素列表，不含空格，并用方括号括起来。例如，输出必须如下所示：\n$$\n\\texttt{[[R_1,\\text{max\\_residual}_1],[R_2,\\text{max\\_residual}_2],[R_3,\\text{max\\_residual}_3],[R_4,\\text{max\\_residual}_4]]}\n$$\n其中每个 $R_i$ 是无量纲的小数相对变化，每个 $\\text{max\\_residual}_i$ 是最大绝对通量连续性残差，单位为开尔文·米/秒。",
            "solution": "我们从标量 $q$ 在一个有限体积控制体上的守恒开始。将控制方程\n$$\n\\frac{\\partial q}{\\partial t} = \\frac{\\partial}{\\partial z}\\left( K(z) \\frac{\\partial q}{\\partial z} \\right)\n$$\n在一个由 $z_{i-\\frac{1}{2}}$ 和 $z_{i+\\frac{1}{2}}$ 界定的单元 $i$ 上积分，其厚度为 $\\Delta z_i = z_{i+\\frac{1}{2}} - z_{i-\\frac{1}{2}}$，并应用散度定理，得到\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d}t} \\left( q_i \\Delta z_i \\right) = F_{i-\\frac{1}{2}} - F_{i+\\frac{1}{2}},\n$$\n其中 $q_i$ 表示单元平均值，$F_{i\\pm\\frac{1}{2}}$ 是通过相应面的扩散通量。在时间步长为 $\\Delta t$ 的后向欧拉时间离散化下（从 $t^n$ 到 $t^{n+1}$），该方程变为\n$$\n\\frac{q_i^{n+1} - q_i^n}{\\Delta t} = \\frac{F_{i-\\frac{1}{2}}^{n+1} - F_{i+\\frac{1}{2}}^{n+1}}{\\Delta z_i}.\n$$\nFick 定律给出了在面上的瞬时扩散通量\n$$\nF = -K \\frac{\\partial q}{\\partial z}.\n$$\n在一个非均匀网格上，每个单元的涡扩散系数是分段常数，内部面上的梯度必须以一种强制通量跨界面连续的方式来近似，这与守恒性是一致的。考虑单元 $i$ 和 $i+1$ 之间的交界面。令 $d_\\text{R} = \\frac{\\Delta z_i}{2}$ 表示从单元 $i$ 中心到交界面的距离，令 $d_\\text{L} = \\frac{\\Delta z_{i+1}}{2}$ 表示从单元 $i+1$ 中心到交界面的距离。令 $q_f$ 表示在时间 $t^{n+1}$ 时，位于 $z_{i+\\frac{1}{2}}$ 的交界面上的 $q$ 值。左侧和右侧的通量表达式为\n$$\nF_{i+\\frac{1}{2}, \\text{left}}^{n+1} = -K_i \\frac{q_f - q_i^{n+1}}{d_\\text{R}}, \\quad\nF_{i+\\frac{1}{2}, \\text{right}}^{n+1} = -K_{i+1} \\frac{q_{i+1}^{n+1} - q_f}{d_\\text{L}}.\n$$\n交界面上的通量连续性要求\n$$\nF_{i+\\frac{1}{2}, \\text{left}}^{n+1} = F_{i+\\frac{1}{2}, \\text{right}}^{n+1}.\n$$\n解出交界面值 $q_f$ 得\n$$\nq_f = \\frac{\\left( \\frac{K_i}{d_\\text{R}} \\right) q_i^{n+1} + \\left( \\frac{K_{i+1}}{d_\\text{L}} \\right) q_{i+1}^{n+1}}{\\left( \\frac{K_i}{d_\\text{R}} \\right) + \\left( \\frac{K_{i+1}}{d_\\text{L}} \\right)}.\n$$\n将此 $q_f$ 代入任一通量表达式，即可得到一个唯一的、连续的交界面通量。通过使用串联电阻概念的代数操作，可以将同一通量等效地表示为\n$$\nF_{i+\\frac{1}{2}}^{n+1} = -K_{i+\\frac{1}{2}} \\frac{q_{i+1}^{n+1} - q_i^{n+1}}{d_\\text{R} + d_\\text{L}},\n$$\n其中有效面涡扩散系数 $K_{i+\\frac{1}{2}}$ 由加权调和平均给出\n$$\nK_{i+\\frac{1}{2}} = \\frac{d_\\text{R} + d_\\text{L}}{\\frac{d_\\text{R}}{K_i} + \\frac{d_\\text{L}}{K_{i+1}}}.\n$$\n如果 $K_i$ 或 $K_{i+1}$ 为零（或极小），分母会变得很大（或无限大），有效的 $K_{i+\\frac{1}{2}}$ 趋于零，从而正确地减少了交界面通量。\n\n将面通量代入单元 $i$ 的后向欧拉守恒方程，得到\n$$\n\\frac{q_i^{n+1} - q_i^n}{\\Delta t} = \\frac{-K_{i-\\frac{1}{2}} \\frac{q_i^{n+1} - q_{i-1}^{n+1}}{d_\\text{L}^{(i)} + d_\\text{R}^{(i-1)}} + K_{i+\\frac{1}{2}} \\frac{q_{i+1}^{n+1} - q_i^{n+1}}{d_\\text{R}^{(i)} + d_\\text{L}^{(i+1)}}}{\\Delta z_i},\n$$\n其中 $d_\\text{L}^{(i)} = \\frac{\\Delta z_i}{2}$ 和 $d_\\text{R}^{(i)} = \\frac{\\Delta z_i}{2}$ 表示单元 $i$ 的左半厚度和右半厚度。整理各项，我们得到形式为\n$$\na_i q_{i-1}^{n+1} + b_i q_i^{n+1} + c_i q_{i+1}^{n+1} = q_i^n,\n$$\n的三对角系统，其系数为\n$$\na_i = -\\frac{\\Delta t}{\\Delta z_i} \\frac{K_{i-\\frac{1}{2}}}{\\frac{\\Delta z_i}{2} + \\frac{\\Delta z_{i-1}}{2}}, \\quad\nc_i = -\\frac{\\Delta t}{\\Delta z_i} \\frac{K_{i+\\frac{1}{2}}}{\\frac{\\Delta z_i}{2} + \\frac{\\Delta z_{i+1}}{2}},\n$$\n$$\nb_i = 1 - a_i - c_i = 1 + \\frac{\\Delta t}{\\Delta z_i}\\left( \\frac{K_{i-\\frac{1}{2}}}{\\frac{\\Delta z_i}{2} + \\frac{\\Delta z_{i-1}}{2}} + \\frac{K_{i+\\frac{1}{2}}}{\\frac{\\Delta z_i}{2} + \\frac{\\Delta z_{i+1}}{2}} \\right).\n$$\n底部和顶部的零通量边界意味着 $F_{1-\\frac{1}{2}}^{n+1} = 0$ 和 $F_{N+\\frac{1}{2}}^{n+1} = 0$，这消除了与虚拟单元的耦合，并将第一行和最后一行简化为\n$$\nb_1 q_1^{n+1} + c_1 q_2^{n+1} = q_1^n, \\quad\na_N q_{N-1}^{n+1} + b_N q_N^{n+1} = q_N^n,\n$$\n其中 $a_1 = 0$ 和 $c_N = 0$。对于非负的 $K$ 和 $\\Delta t > 0$，组装的矩阵是严格对角占优的，保证了唯一解的存在。得到的线性系统是三对角的，可以使用托马斯算法高效求解：\n- 前向消元：修改上对角线和右端项以消除下对角线。\n- 回代：恢复解向量 $q^{n+1}$。\n\n守恒性源于通量差分的伸缩求和性质：将离散守恒方程对所有单元求和，得到\n$$\n\\sum_{i=1}^{N} \\frac{q_i^{n+1} - q_i^n}{\\Delta t} \\Delta z_i = \\sum_{i=1}^{N} \\left(F_{i-\\frac{1}{2}}^{n+1} - F_{i+\\frac{1}{2}}^{n+1}\\right) = F_{1-\\frac{1}{2}}^{n+1} - F_{N+\\frac{1}{2}}^{n+1} = 0,\n$$\n这是因为零通量边界条件。因此，列积分标量是守恒的，相对变化 $R$ 应该接近于零，直到数值舍入误差的量级。\n\n为了在求解后量化交界面通量连续性，对每个内部面 $i+\\frac{1}{2}$，使用以下公式计算交界面值 $q_f$：\n$$\nq_f = \\frac{\\left( \\frac{K_i}{\\frac{\\Delta z_i}{2}} \\right) q_i^{n+1} + \\left( \\frac{K_{i+1}}{\\frac{\\Delta z_{i+1}}{2}} \\right) q_{i+1}^{n+1}}{\\left( \\frac{K_i}{\\frac{\\Delta z_i}{2}} \\right) + \\left( \\frac{K_{i+1}}{\\frac{\\Delta z_{i+1}}{2}} \\right)},\n$$\n然后评估\n$$\nF_{i+\\frac{1}{2}, \\text{left}}^{n+1} = -K_i \\frac{q_f - q_i^{n+1}}{\\frac{\\Delta z_i}{2}}, \\quad\nF_{i+\\frac{1}{2}, \\text{right}}^{n+1} = -K_{i+1} \\frac{q_{i+1}^{n+1} - q_f}{\\frac{\\Delta z_{i+1}}{2}}.\n$$\n根据构造，在精确算术中这些通量完全匹配；因此，所有内部面上的最大绝对残差，\n$$\n\\max_{i \\in \\{1,\\dots,N-1\\}} \\left| F_{i+\\frac{1}{2}, \\text{left}}^{n+1} - F_{i+\\frac{1}{2}, \\text{right}}^{n+1} \\right|,\n$$\n应该接近机器精度（实际上为零），单位为开尔文·米/秒，并需特殊处理当任一相邻的 $K$ 等于零时的情况，此时残差定义为零。\n\n实现的算法步骤：\n- 对每个内部交界面，通过使用半单元距离的加权调和平均计算 $K_{i+\\frac{1}{2}}$。\n- 根据带有零通量边界的隐式有限体积离散化，组装 $a_i$、$b_i$ 和 $c_i$。\n- 使用托马斯算法求解三对角系统以获得 $q^{n+1}$。\n- 使用 $t^n$ 和 $t^{n+1}$ 时的列积分计算 $R$。\n- 使用交界面 $q_f$ 重构计算最大通量连续性残差。\n- 以指定的单行输出格式，报告每个测试用例的结果为 $[R, \\text{max\\_residual}]$。\n\n此设计将基本物理原理（守恒和 Fick 定律）与一个鲁棒的数值离散化方案相结合，通过通量连续性确保了守恒性并尊重了交界面物理。",
            "answer": "```python\nimport numpy as np\n\ndef harmonic_face_diffusivity(K_left, K_right, dz_left, dz_right):\n    \"\"\"\n    Compute effective face diffusivity using weighted harmonic average.\n    If either K_left or K_right is zero (or nonpositive), return zero.\n    \"\"\"\n    d_left = dz_left / 2.0\n    d_right = dz_right / 2.0\n    # Handle zero/nonpositive diffusivity: resistance becomes infinite = K_face = 0\n    r_left = (d_left / K_left) if K_left > 0.0 else np.inf\n    r_right = (d_right / K_right) if K_right > 0.0 else np.inf\n    denom = r_left + r_right\n    if not np.isfinite(denom) or denom == 0.0:\n        return 0.0\n    return (d_left + d_right) / denom\n\ndef assemble_tridiagonal(dz, K, dt):\n    \"\"\"\n    Assemble tridiagonal coefficients (a, b, c) for implicit diffusion\n    with variable K on a nonuniform grid, zero-flux (Neumann) boundaries.\n    \"\"\"\n    N = len(dz)\n    a = np.zeros(N, dtype=float)  # lower diagonal (a_i multiplies q_{i-1})\n    b = np.ones(N, dtype=float)   # main diagonal\n    c = np.zeros(N, dtype=float)  # upper diagonal (c_i multiplies q_{i+1})\n\n    half = dz / 2.0\n\n    for i in range(N):\n        # Left face contribution\n        if i > 0:\n            delta_imh = half[i] + half[i-1]  # d_R(i-1/2)+d_L(i-1/2)\n            K_face_left = harmonic_face_diffusivity(K[i-1], K[i], dz[i-1], dz[i])\n            a[i] = - (dt / dz[i]) * (K_face_left / delta_imh)\n            b[i] += (dt / dz[i]) * (K_face_left / delta_imh)\n        # Right face contribution\n        if i  N - 1:\n            delta_iph = half[i] + half[i+1]\n            K_face_right = harmonic_face_diffusivity(K[i], K[i+1], dz[i], dz[i+1])\n            c[i] = - (dt / dz[i]) * (K_face_right / delta_iph)\n            b[i] += (dt / dz[i]) * (K_face_right / delta_iph)\n\n    # Enforce zero-flux boundaries implicitly via coefficients (a[0]=0, c[-1]=0 already)\n    return a, b, c\n\ndef thomas_solver(a, b, c, d):\n    \"\"\"\n    Solve tridiagonal system with lower diag a, main diag b, upper diag c:\n    a_i * x_{i-1} + b_i * x_i + c_i * x_{i+1} = d_i\n    \"\"\"\n    n = len(b)\n    cp = np.zeros(n-1, dtype=float)\n    dp = np.zeros(n, dtype=float)\n    bp = b.astype(float).copy()\n\n    # Forward sweep\n    if n == 1:\n        return np.array([d[0] / bp[0]], dtype=float)\n\n    cp[0] = c[0] / bp[0]\n    dp[0] = d[0] / bp[0]\n    for i in range(1, n-1):\n        denom = bp[i] - a[i] * cp[i-1]\n        bp[i] = denom\n        cp[i] = c[i] / bp[i] if bp[i] != 0.0 else 0.0\n        dp[i] = (d[i] - a[i] * dp[i-1]) / bp[i] if bp[i] != 0.0 else 0.0\n    denom = bp[n-1] - a[n-1] * cp[n-2]\n    bp[n-1] = denom\n    dp[n-1] = (d[n-1] - a[n-1] * dp[n-2]) / bp[n-1] if bp[n-1] != 0.0 else 0.0\n\n    # Back substitution\n    x = np.zeros(n, dtype=float)\n    x[n-1] = dp[n-1]\n    for i in range(n-2, -1, -1):\n        x[i] = dp[i] - cp[i] * x[i+1]\n    return x\n\ndef compute_flux_continuity_residual(q, dz, K):\n    \"\"\"\n    Compute maximum absolute residual |F_left - F_right| across interior faces\n    using interface value q_f that enforces flux continuity by construction.\n    Units: K (m^2/s), q (Kelvin), dz (m) = flux units Kelvin·m/s.\n    \"\"\"\n    N = len(dz)\n    half = dz / 2.0\n    max_resid = 0.0\n    for i in range(N - 1):\n        di = half[i]\n        dj = half[i+1]\n        Ki = K[i]\n        Kj = K[i+1]\n        # If both diffusivities are zero/nonpositive, define residual = 0\n        w_left = (Ki / di) if Ki > 0.0 else 0.0\n        w_right = (Kj / dj) if Kj > 0.0 else 0.0\n        denom = w_left + w_right\n        if denom == 0.0:\n            resid = 0.0\n        else:\n            qf = (w_left * q[i] + w_right * q[i+1]) / denom\n            F_left = -Ki * (qf - q[i]) / di if Ki > 0.0 else 0.0\n            F_right = -Kj * (q[i+1] - qf) / dj if Kj > 0.0 else 0.0\n            resid = abs(F_left - F_right)\n        if resid > max_resid:\n            max_resid = resid\n    return max_resid\n\ndef implicit_diffusion_step(dz, K, dt, q0):\n    \"\"\"\n    Perform one backward Euler implicit diffusion step with variable K on a nonuniform grid.\n    \"\"\"\n    a, b, c = assemble_tridiagonal(np.array(dz, dtype=float), np.array(K, dtype=float), float(dt))\n    q1 = thomas_solver(a, b, c, np.array(q0, dtype=float))\n    return q1\n\ndef solve():\n    # Define test cases as tuples: (dz array, K array, dt, q0 array)\n    test_cases = [\n        (\n            [20.0, 30.0, 50.0, 100.0, 200.0, 300.0],\n            [0.1, 0.5, 2.0, 0.8, 0.2, 0.1],\n            600.0,\n            [10.0, 8.0, 6.0, 5.0, 4.0, 3.0]\n        ),\n        (\n            [100.0]*10,\n            [0.01]*10,\n            1.0,\n            [1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0,10.0]\n        ),\n        (\n            [1.0, 1000.0, 1000.0, 1.0],\n            [0.0, 1.0, 0.1, 0.0],\n            100.0,\n            [0.0, 10.0, 0.0, 10.0]\n        ),\n        (\n            [50.0, 50.0, 50.0, 50.0, 50.0],\n            [0.01, 10.0, 0.01, 10.0, 0.01],\n            300.0,\n            [1.0, 0.0, 1.0, 0.0, 1.0]\n        ),\n    ]\n\n    results = []\n    for dz, K, dt, q0 in test_cases:\n        dz_arr = np.array(dz, dtype=float)\n        K_arr = np.array(K, dtype=float)\n        q0_arr = np.array(q0, dtype=float)\n        # Perform implicit step\n        q1_arr = implicit_diffusion_step(dz_arr, K_arr, dt, q0_arr)\n        # Relative column integral change R (dimensionless decimal)\n        M0 = float(np.dot(q0_arr, dz_arr))\n        M1 = float(np.dot(q1_arr, dz_arr))\n        R = (M1 - M0) / M0 if M0 != 0.0 else 0.0\n        # Max flux continuity residual (Kelvin·m/s)\n        max_res = compute_flux_continuity_residual(q1_arr, dz_arr, K_arr)\n        results.append((R, max_res))\n\n    # Format output: [[R1,max_res1],[R2,max_res2],...], no spaces\n    formatted = \"[\" + \",\".join([f\"[{r:.12e},{m:.12e}]\" for r, m in results]) + \"]\"\n    print(formatted)\n\nsolve()\n```"
        }
    ]
}