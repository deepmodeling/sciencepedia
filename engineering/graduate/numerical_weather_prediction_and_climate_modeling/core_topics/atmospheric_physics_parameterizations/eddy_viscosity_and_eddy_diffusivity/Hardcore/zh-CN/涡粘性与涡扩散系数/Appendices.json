{
    "hands_on_practices": [
        {
            "introduction": "本练习旨在建立基本湍流特征（如湍动能 $k$ 和混合长 $l$）与最终的涡黏性系数 $K_m$ 之间的直接联系。它展示了 Boussinesq 假说在实际计算中的应用，即如何利用平均流梯度来计算湍流应力，这是许多湍流参数化方案的基石。",
            "id": "4034408",
            "problem": "在数值天气预报和气候模拟中，次网格尺度湍流动量输送的参数化通常基于梯度扩散假说（也称为Boussinesq近似），该假说通过涡黏度将雷诺切应力与平均速度梯度联系起来。从雷诺平均纳维-斯托克斯（RANS）方程出发，垂直方向的湍流切应力被写为运动应力，定义为 $-\\overline{u^{\\prime} w^{\\prime}}$，其中 $\\overline{u^{\\prime} w^{\\prime}}$ 是水平和垂直速度脉动的协方差。根据梯度扩散假说，运动应力被模拟为 $-\\overline{u^{\\prime} w^{\\prime}} = K_{m} \\, \\partial_{z} \\bar{u}$，其中 $K_{m}$ 是涡黏度，$\\partial_{z} \\bar{u}$ 是平均水平风的垂直梯度。\n\n使用量纲分析和Prandtl的混合长度理论，可以将涡黏度 $K_{m}$ 与混合长度 $l$ 和一个从湍流动能 $k$ 推导出的湍流速度尺度联系起来，其中无量纲闭合系数 $c_{\\mu}$ 用于解释模型不确定性和各向异性。推导出一个用 $k$、$l$ 和 $c_{\\mu}$ 表示 $K_{m}$ 的表达式，然后用它计算在中性大气边界层情况下的涡黏度和相应的运动湍流切应力，已知以下量值：\n- 湍流动能 $k = 0.5 \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-2}$，\n- 混合长度 $l = 30 \\,\\mathrm{m}$，\n- 闭合系数 $c_{\\mu} = 0.1$，\n- 平均垂直切变 $\\partial_{z} \\bar{u} = 0.02 \\,\\mathrm{s}^{-1}$。\n\n将涡黏度 $K_{m}$ 以 $\\mathrm{m}^{2}\\,\\mathrm{s}^{-1}$ 为单位表示，运动湍流切应力 $-\\overline{u^{\\prime} w^{\\prime}}$ 以 $\\mathrm{m}^{2}\\,\\mathrm{s}^{-2}$ 为单位表示。将您的数值答案四舍五入到四位有效数字。以双元素行向量 $\\big[K_{m},\\; -\\overline{u^{\\prime} w^{\\prime}}\\big]$ 的形式报告您的最终答案。",
            "solution": "首先对问题进行验证，以确保其具有科学依据、适定且客观。\n\n### 第1步：提取已知条件\n提供了以下量值和定义：\n- 垂直方向的运动湍流切应力定义为 $-\\overline{u^{\\prime} w^{\\prime}}$。\n- 梯度扩散假说将切应力与平均速度梯度联系起来：$-\\overline{u^{\\prime} w^{\\prime}} = K_{m} \\, \\partial_{z} \\bar{u}$。\n- $K_{m}$ 是涡黏度。\n- $\\partial_{z} \\bar{u}$ 是平均水平风的垂直梯度。\n- 涡黏度 $K_{m}$ 需要用湍流动能 $k$、混合长度 $l$ 和闭合系数 $c_{\\mu}$ 来表示。\n- 湍流动能：$k = 0.5 \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-2}$。\n- 混合长度：$l = 30 \\,\\mathrm{m}$。\n- 闭合系数：$c_{\\mu} = 0.1$。\n- 平均垂直切变：$\\partial_{z} \\bar{u} = 0.02 \\,\\mathrm{s}^{-1}$。\n\n### 第2步：使用提取的已知条件进行验证\n对问题进行严格验证。\n- **科学依据**：该问题建立在雷诺平均纳维-斯托克斯（RANS）方程和用于湍流应力的Boussinesq近似之上，这些都是流体动力学和大气科学中湍流模拟的基石概念。使用Prandtl的混合长度理论和基于湍流动能（TKE）的速度尺度是参数化涡黏度的标准且成熟的方法。所提供的数值对于中性大气边界层是物理上现实的。\n- **适定性**：该问题明确要求推导一个表达式并随后计算两个物理量。所有必要的数据和关系都已提供，确保可以确定一个唯一且稳定的解。\n- **客观性**：该问题使用精确的技术术语阐述，没有任何主观或模糊的语言。\n\n### 第3步：结论与行动\n该问题被判定为**有效**。它在科学上是合理的，自洽的，并且是适定的。可以继续求解过程。\n\n### 推导与计算\n第一步是按照指示，基于量纲分析推导涡黏度 $K_{m}$ 的表达式。根据定义，涡黏度的单位与运动黏度的单位相同，即长度的平方除以时间，$[\\mathrm{L}]^{2} [\\mathrm{T}]^{-1}$。我们需要用湍流动能 $k$、混合长度 $l$ 和无量纲系数 $c_{\\mu}$ 来构建这个量。\n\n已知量的量纲为：\n- 湍流动能, $k$: $[k] = [\\mathrm{L}]^{2} [\\mathrm{T}]^{-2}$ (能量/单位质量，或速度的平方)。\n- 混合长度, $l$: $[l] = [\\mathrm{L}]$。\n- 闭合系数, $c_{\\mu}$: 无量纲, $[c_{\\mu}] = 1$。\n\n在Prandtl的混合长度理论中，涡黏度被参数化为特征湍流速度尺度 $v_{turb}$ 和湍涡的特征长度尺度（即混合长度 $l$）的乘积。\n$$\nK_{m} \\propto v_{turb} \\cdot l\n$$\n问题指定湍流速度尺度应从湍流动能 $k$ 推导得出。TKE, $k$，定义为雷诺应力张量迹的一半，代表单位质量湍流速度脉动的平均动能。它的量纲是速度的平方。因此，一个自然的选择是将 $k$ 的平方根作为湍流速度尺度：\n$$\nv_{turb} \\propto \\sqrt{k}\n$$\n$\\sqrt{k}$ 的量纲是 $(\\sqrt{[\\mathrm{L}]^{2} [\\mathrm{T}]^{-2}}) = [\\mathrm{L}] [\\mathrm{T}]^{-1}$，这确实是速度的量纲。\n\n结合这些元素，涡黏度 $K_{m}$ 可以表示为：\n$$\nK_{m} = c_{\\mu} \\cdot v_{turb} \\cdot l = c_{\\mu} l \\sqrt{k}\n$$\n其中 $c_{\\mu}$ 是作为比例常数的无量纲闭合系数。这个表达式在量纲上是一致的：\n$$\n[K_{m}] = [c_{\\mu}] [l] [\\sqrt{k}] = (1) \\cdot ([\\mathrm{L}]) \\cdot ([\\mathrm{L}][\\mathrm{T}]^{-1}) = [\\mathrm{L}]^{2}[\\mathrm{T}]^{-1}\n$$\n这与涡黏度所需的量纲相匹配。\n\n现在，我们可以使用所提供的数据计算 $K_{m}$ 的数值：\n$k = 0.5 \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-2}$\n$l = 30 \\,\\mathrm{m}$\n$c_{\\mu} = 0.1$\n\n将这些值代入推导出的 $K_{m}$ 表达式中：\n$$\nK_{m} = (0.1) \\cdot (30 \\,\\mathrm{m}) \\cdot \\sqrt{0.5 \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-2}}\n$$\n$$\nK_{m} = 3 \\,\\mathrm{m} \\cdot \\sqrt{0.5} \\,\\mathrm{m}\\,\\mathrm{s}^{-1} = 3 \\sqrt{0.5} \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-1}\n$$\n$$\nK_{m} = \\frac{3}{\\sqrt{2}} \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-1} \\approx 2.12132034... \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-1}\n$$\n四舍五入到四位有效数字，我们得到：\n$$\nK_{m} \\approx 2.121 \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-1}\n$$\n\n接下来，我们使用梯度扩散假说计算运动湍流切应力 $-\\overline{u^{\\prime} w^{\\prime}}$：\n$$\n-\\overline{u^{\\prime} w^{\\prime}} = K_{m} \\, \\partial_{z} \\bar{u}\n$$\n为了保持精度，我们在此计算中使用 $K_{m}$ 的未舍入值。给定的平均垂直切变为 $\\partial_{z} \\bar{u} = 0.02 \\,\\mathrm{s}^{-1}$。\n$$\n-\\overline{u^{\\prime} w^{\\prime}} = (2.12132034... \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-1}) \\cdot (0.02 \\,\\mathrm{s}^{-1})\n$$\n$$\n-\\overline{u^{\\prime} w^{\\prime}} = 0.042426406... \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-2}\n$$\n单位是 $(\\mathrm{m}^{2}\\,\\mathrm{s}^{-1}) \\cdot (\\mathrm{s}^{-1}) = \\mathrm{m}^{2}\\,\\mathrm{s}^{-2}$，这是运动应力（速度的平方）的正确单位。\n\n将此结果四舍五入到四位有效数字：\n$$\n-\\overline{u^{\\prime} w^{\\prime}} \\approx 0.04243 \\,\\mathrm{m}^{2}\\,\\mathrm{s}^{-2}\n$$\n\n最终答案由计算出的两个量 $K_{m}$ 和 $-\\overline{u^{\\prime} w^{\\prime}}$ 组成，以行向量的形式呈现。",
            "answer": "$$\n\\boxed{\\begin{bmatrix} 2.121  0.04243 \\end{bmatrix}}\n$$"
        },
        {
            "introduction": "在涡扩散系数概念的基础上，本练习将引导您从第一性原理出发，推导一维平均输送方程。通过求解简化条件下的稳态廓线，您将看到湍流混合如何导致被动示踪剂在两个固定边界之间形成线性分布，这个基本解是更复杂模型的基准。",
            "id": "4034446",
            "problem": "考虑一个在数值天气预报和气候模拟背景下代表大气边界层的一维垂直气柱，其高度坐标为 $z \\in [0,H]$，且具有水平均匀性。一个瞬时浓度为 $c(\\mathbf{x},z,t)$ 的被動示踪物，在 Boussinesq 近似下，被不可压缩流 $\\mathbf{u}(\\mathbf{x},z,t)$ 输送。假设：\n- 示踪物无内部源或汇，因此源项 $S=0$。\n- 与解析尺度上的湍流输送相比，分子扩散率可以忽略不计。\n- 平均垂直速度为零，$\\overline{w}=0$，且根据水平均匀性，平均量的水平梯度为零。\n- Reynolds 分解 $c=\\overline{c}+c'$, $w=\\overline{w}+w'$ 适用，其中上划线表示水平（Reynolds）平均，撇号表示脉动。\n- 湍流垂直通量由梯度扩散（涡动扩散）闭合 $\\overline{w'c'}=-K_c(z,t)\\,\\partial_z \\overline{c}$ 表示，其中 $K_c(z,t)\\ge 0$ 是示踪物的涡动扩散系数。\n\n从瞬时被动标量守恒定律和上述假设出发，推导控制 $\\overline{c}(z,t)$ 的一维平均输送方程。然后，在稳态条件 $\\partial_t \\overline{c}=0$ 和常数涡动扩散系数 $K_c=\\text{const}$ 下，求解有限气柱 $z\\in[0,H]$ 内受 Dirichlet 边界条件 $\\overline{c}(0)=c_0$ 和 $\\overline{c}(H)=c_H$ 约束的平均稳态廓线 $\\overline{c}(z)$，其中 $c_0$ 和 $c_H$ 是给定的常数。请将最终答案表示为关于 $z$、$H$、$c_0$ 和 $c_H$ 的 $\\overline{c}(z)$ 的单个闭式解析表达式。最终表达式中不要包含单位。",
            "solution": "用户要求我解答这个问题陈述。\n\n### 第一步：问题验证\n\n我将首先根据指定标准验证问题陈述。\n\n#### 已知条件提取\n- **系统**：一维垂直气柱，高度坐标 $z \\in [0,H]$。假设水平均匀。\n- **示踪物**：被动，瞬时浓度为 $c(\\mathbf{x},z,t)$。\n- **流体**：不可压缩流，$\\mathbf{u}(\\mathbf{x},z,t)$，在 Boussinesq 近似下。\n- **源/汇**：内部源项 $S=0$。\n- **扩散率**：分子扩散率可忽略不计。\n- **平均流**：平均垂直速度 $\\overline{w}=0$。平均量的水平梯度为零。\n- **分解**：Reynolds 分解适用：$c=\\overline{c}+c'$ 和 $w=\\overline{w}+w'$，其中上划线表示水平（Reynolds）平均，撇号表示脉动。\n- **湍流闭合**：湍流垂直通量由涡动扩散闭合 $\\overline{w'c'}=-K_c(z,t)\\,\\partial_z \\overline{c}$ 给出，其中 $K_c(z,t)\\ge 0$ 是涡动扩散系数。\n- **稳态条件**：对于问题的第二部分，必须假设稳态条件 $\\partial_t \\overline{c}=0$ 和常数涡动扩散系数 $K_c=\\text{const}$。\n- **边界条件**：在区域 $z\\in[0,H]$ 上施加 Dirichlet 边界条件 $\\overline{c}(0)=c_0$ 和 $\\overline{c}(H)=c_H$。\n- **目标**：推导 $\\overline{c}(z,t)$ 的一维平均输送方程，然后求解稳態廓线 $\\overline{c}(z)$。\n\n#### 验证评估\n- **科学依据**：该问题很好地基于地球物理流体动力学的原理，特别是大气边界层中的湍流模拟。Reynolds 平均、Boussinesq 近似和梯度扩散（K-理论）闭合是该领域的标准技术。\n- **适定性**：该问题是适定的。第一部分是基于基本原理的推导。第二部分需要求解一个带有两个指定 Dirichlet 边界条件的二阶线性常微分方程，这构成了一个具有唯一解的适定边值问题。\n- **客观性**：该问题以精确、客观、形式化的数学语言陈述。所有术语均为该学科内的标准术语，所有假设都已明确列出。\n- **一致性与完整性**：该问题自成体系且内部一致。为得出所需解，已提供了所有必要的物理假设、数学关系和边界条件。\n\n#### 结论\n该问题是**有效的**。这是一个大气物理学中标准的、科学上合理的问题，没有违反任何指定的无效标准。我现在开始求解。\n\n### 第二步：推导与求解\n\n#### 第一部分：平均输送方程的推导\n\n在速度场为 $\\mathbf{u}$ 的不可压缩流中，浓度为 $c$ 的被动示踪物的守恒定律由平流-扩散方程给出。其通量形式为：\n$$\n\\frac{\\partial c}{\\partial t} + \\nabla \\cdot (\\mathbf{u}c) = S + \\mathcal{D}_{mol}\n$$\n其中 $S$ 是源/汇项，$\\mathcal{D}_{mol}$ 表示分子扩散。\n\n根据问题陈述，我们应用以下假设：\n1.  无内部源或汇：$S=0$。\n2.  与湍流输送相比，分子扩散率可以忽略不计：$\\mathcal{D}_{mol} \\approx 0$。\n\n方程简化为：\n$$\n\\frac{\\partial c}{\\partial t} + \\nabla \\cdot (\\mathbf{u}c) = 0\n$$\n在笛卡尔坐标系 $(x,y,z)$ 中，速度分量为 $(u,v,w)$，该方程为：\n$$\n\\frac{\\partial c}{\\partial t} + \\frac{\\partial(uc)}{\\partial x} + \\frac{\\partial(vc)}{\\partial y} + \\frac{\\partial(wc)}{\\partial z} = 0\n$$\n我们现在对每一项应用水平 Reynolds 平均（用上划线表示）。平均算子与偏导数可交换顺序：\n$$\n\\overline{\\frac{\\partial c}{\\partial t}} + \\overline{\\frac{\\partial(uc)}{\\partial x}} + \\overline{\\frac{\\partial(vc)}{\\partial y}} + \\overline{\\frac{\\partial(wc)}{\\partial z}} = 0\n$$\n$$\n\\frac{\\partial \\overline{c}}{\\partial t} + \\frac{\\partial \\overline{uc}}{\\partial x} + \\frac{\\partial \\overline{vc}}{\\partial y} + \\frac{\\partial \\overline{wc}}{\\partial z} = 0\n$$\n问题陈述了水平均匀性，这意味着任何量的平均值在水平方向（$x$ 和 $y$）上不发生变化。因此，水平通量散度项为零：\n$$\n\\frac{\\partial \\overline{uc}}{\\partial x} = 0 \\quad \\text{和} \\quad \\frac{\\partial \\overline{vc}}{\\partial y} = 0\n$$\n平均后的方程简化为关于垂直坐标 $z$ 的一维形式：\n$$\n\\frac{\\partial \\overline{c}}{\\partial t} + \\frac{\\partial \\overline{wc}}{\\partial z} = 0\n$$\n接下来，我们将 Reynolds 分解应用于量 $w$ 和 $c$：$w = \\overline{w} + w'$ 和 $c = \\overline{c} + c'$。项 $\\overline{wc}$ 变为：\n$$\n\\overline{wc} = \\overline{(\\overline{w} + w')(\\overline{c} + c')} = \\overline{\\overline{w}\\overline{c} + \\overline{w}c' + w'\\overline{c} + w'c'}\n$$\n利用 Reynolds 平均的性质（例如 $\\overline{A'} = 0$ 和 $\\overline{\\overline{A}B} = \\overline{A}\\overline{B}$），我们得到：\n$$\n\\overline{wc} = \\overline{w}\\overline{c} + \\overline{\\overline{w}c'} + \\overline{w'\\overline{c}} + \\overline{w'c'} = \\overline{w}\\overline{c} + \\overline{w}\\overline{c'} + \\overline{c}\\overline{w'} + \\overline{w'c'} = \\overline{w}\\overline{c} + \\overline{w'c'}\n$$\n现在的平均输送方程为：\n$$\n\\frac{\\partial \\overline{c}}{\\partial t} + \\frac{\\partial}{\\partial z}(\\overline{w}\\overline{c} + \\overline{w'c'}) = 0\n$$\n已知平均垂直速度为零，$\\overline{w}=0$。这进一步简化了方程：\n$$\n\\frac{\\partial \\overline{c}}{\\partial t} + \\frac{\\partial (\\overline{w'c'})}{\\partial z} = 0\n$$\n该方程表明，平均浓度的时间变化率与湍流示踪物通量 $\\overline{w'c'}$ 的垂直散度相平衡。为使系统閉合，我们使用给定的涡动扩散（K-理论）闭合方案：\n$$\n\\overline{w'c'} = -K_c(z,t) \\frac{\\partial \\overline{c}}{\\partial z}\n$$\n将此闭合方案代入平均输送方程，得到最终的 $\\overline{c}(z,t)$ 的一维方程：\n$$\n\\frac{\\partial \\overline{c}}{\\partial t} - \\frac{\\partial}{\\partial z}\\left(K_c(z,t) \\frac{\\partial \\overline{c}}{\\partial z}\\right) = 0\n$$\n这是一个一维的、扩散型的抛物线型偏微分方程。\n\n#### 第二部分：稳态廓线的求解\n\n我们需要在两个附加条件下求解平均稳態廓线 $\\overline{c}(z)$：\n1.  稳态条件：$\\partial_t \\overline{c} = 0$。\n2.  常数涡动扩散系数：$K_c=\\text{const}$。\n\n在稳态条件下，平均输送方程变为：\n$$\n-\\frac{d}{dz}\\left(K_c \\frac{d \\overline{c}}{dz}\\right) = 0\n$$\n注意，由于 $\\overline{c}$ 现在仅依赖于 $z$，我们使用了常微分符号。因为 $K_c$ 是一个非零常数，我们可以用它来除方程，得到：\n$$\n\\frac{d}{dz}\\left(\\frac{d \\overline{c}}{dz}\\right) = 0 \\quad \\implies \\quad \\frac{d^2\\overline{c}}{dz^2} = 0\n$$\n这是一个简单的二阶常微分方程。我们通过对 $z$ 积分两次来找到其通解：\n第一次积分：\n$$\n\\frac{d\\overline{c}}{dz} = C_1\n$$\n第二次积分：\n$$\n\\overline{c}(z) = C_1 z + C_2\n$$\n其中 $C_1$ 和 $C_2$ 是由边界条件决定的积分常数。给定的边界条件是：\n- 在 $z=0$ 处：$\\overline{c}(0) = c_0$\n- 在 $z=H$ 处：$\\overline{c}(H) = c_H$\n\n应用 $z=0$ 处的第一个边界条件：\n$$\n\\overline{c}(0) = C_1(0) + C_2 = c_0 \\quad \\implies \\quad C_2 = c_0\n$$\n应用 $z=H$ 处的第二个边界条件：\n$$\n\\overline{c}(H) = C_1 H + C_2 = c_H\n$$\n将 $C_2=c_0$ 的值代入此方程：\n$$\nC_1 H + c_0 = c_H\n$$\n求解 $C_1$：\n$$\nC_1 = \\frac{c_H - c_0}{H}\n$$\n最后，我们将常数 $C_1$ 和 $C_2$ 的表达式代回通解 $\\overline{c}(z) = C_1 z + C_2$：\n$$\n\\overline{c}(z) = \\left(\\frac{c_H - c_0}{H}\\right)z + c_0\n$$\n这个表达式代表了平均示踪物浓度随高度的线性廓线。我们可以将其重新排列成一种形式，清晰地显示边界值的加权平均：\n$$\n\\overline{c}(z) = c_0 + (c_H - c_0)\\frac{z}{H} = c_0\\left(1 - \\frac{z}{H}\\right) + c_H\\frac{z}{H}\n$$\n这就是稳态平均浓度廓线的最终解析表达式。",
            "answer": "$$\n\\boxed{c_0\\left(1 - \\frac{z}{H}\\right) + c_H\\frac{z}{H}}\n$$"
        },
        {
            "introduction": "这项高级练习旨在连接理论与计算模型。您将开发一个有限体积数值方案，用于求解具有可变涡扩散系数的时间相关扩散方程，这在实际大气模型中非常常见。通过关注通量连续性和守恒性，本练习将加深您对数值模拟必须遵循的物理原则的理解。",
            "id": "4034469",
            "problem": "考虑一个一维垂直柱，其被离散为 $N$ 个有限体积单元，单元厚度为 $\\Delta z_i$，$i \\in \\{1,\\dots,N\\}$。设 $z$ 表示垂直坐标，单位为米。一个被动标量 $q(z,t)$（例如，单位为开尔文的位温）在垂直湍流扩散作用下演变，其特征是可变的涡动扩散系数 $K(z)$，单位为平方米/秒。从标量守恒和 Fick 扩散定律出发，其控制方程为抛物线型偏微分方程\n$$\n\\frac{\\partial q}{\\partial t} = \\frac{\\partial}{\\partial z}\\left( K(z) \\frac{\\partial q}{\\partial z} \\right).\n$$\n假设每个单元内的 $K$ 值为分段常数，顶部和底部边界采用零通量（Neumann）边界条件，并使用后向欧拉时间离散格式。您的任务是，从第一性原理出发，不使用任何预先提供的快捷公式，推导一个在非均匀网格上的守恒有限体积隐式格式，该格式需满足：\n- 在单元界面上强制实现离散通量连续性，使得穿过每个内部界面的扩散通量是唯一定义且连续的。\n- 针对新时间层 $t^{n+1}$ 的未知单元中心值 $q_i^{n+1}$，根据时间层 $t^n$ 的已知值 $q_i^n$，组建一个三对角线性系统。\n- 使用原位 Thomas 算法（三对角矩阵算法）求解该三对角系统。\n\n推导必须从控制体上的守恒声明和 Fick 定律开始。离散界面的处理必须遵循匹配每个内部界面左右两侧通量的原则，从而导出一个与相邻单元中分段常数 $K$ 一致的唯一界面通量表达式。推导完格式后，将其实现为一个完整、可运行的程序，该程序能够构建三对角矩阵系数并求解 $q^{n+1}$。\n\n为了验证正确性和守恒性，对于每个给定的测试用例，计算：\n- 新旧时间层之间气柱积分标量的相对变化，定义为\n$$\nR = \\frac{\\sum_{i=1}^{N} q_i^{n+1} \\Delta z_i - \\sum_{i=1}^{N} q_i^n \\Delta z_i}{\\sum_{i=1}^{N} q_i^n \\Delta z_i},\n$$\n该值是无量纲的，必须以小数形式报告。\n- 在新时间层，所有内部界面上的最大绝对离散通量连续性残差，定义为\n$$\n\\max_{i \\in \\{1,\\dots,N-1\\}} \\left| F_{i+\\frac{1}{2}, \\text{left}}^{n+1} - F_{i+\\frac{1}{2}, \\text{right}}^{n+1} \\right|,\n$$\n其中每个界面通量是通过在界面上强制连续性，由相邻的单元中心值计算得出。如果 $q$ 的单位是开尔文，则该残差必须以开尔文·米/秒表示，并以这些单位报告。在所有测试中，您必须在顶部和底部使用零通量（Neumann）边界条件。\n\n您的程序必须实现求解器，并为每个测试用例输出一个包含 $[R, \\text{max\\_residual}]$ 的双元素列表，并将所有测试用例的结果汇总到单行中。\n\n测试套件：\n使用以下科学上真实且自洽的参数集。在所有情况下，$z$ 的单位是米，$K$ 的单位是平方米/秒，$\\Delta t$ 的单位是秒。标量 $q$ 的单位是开尔文。不涉及角度单位。\n\n- 测试用例 1（理想情况，非均匀网格和强变化的涡动扩散系数）：\n    - $N = 6$\n    - $\\Delta z = [20, 30, 50, 100, 200, 300]\\,\\mathrm{m}$\n    - $K = [0.1, 0.5, 2.0, 0.8, 0.2, 0.1]\\,\\mathrm{m}^2/\\mathrm{s}$\n    - $\\Delta t = 600\\,\\mathrm{s}$\n    - $q^n = [10, 8, 6, 5, 4, 3]\\,\\mathrm{K}$\n\n- 测试用例 2（均匀网格和弱扩散系数，配合小时间步长）：\n    - $N = 10$\n    - $\\Delta z = [100, 100, 100, 100, 100, 100, 100, 100, 100, 100]\\,\\mathrm{m}$\n    - $K = [0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01]\\,\\mathrm{m}^2/\\mathrm{s}$\n    - $\\Delta t = 1\\,\\mathrm{s}$\n    - $q^n = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\\,\\mathrm{K}$\n\n- 测试用例 3（极端情况，边界单元非常薄且涡动扩散系数为零）：\n    - $N = 4$\n    - $\\Delta z = [1, 1000, 1000, 1]\\,\\mathrm{m}$\n    - $K = [0.0, 1.0, 0.1, 0.0]\\,\\mathrm{m}^2/\\mathrm{s}$\n    - $\\Delta t = 100\\,\\mathrm{s}$\n    - $q^n = [0, 10, 0, 10]\\,\\mathrm{K}$\n\n- 测试用例 4（高低交替的涡动扩散系数，以测试界面处理的鲁棒性）：\n    - $N = 5$\n    - $\\Delta z = [50, 50, 50, 50, 50]\\,\\mathrm{m}$\n    - $K = [0.01, 10.0, 0.01, 10.0, 0.01]\\,\\mathrm{m}^2/\\mathrm{s}$\n    - $\\Delta t = 300\\,\\mathrm{s}$\n    - $q^n = [1, 0, 1, 0, 1]\\,\\mathrm{K}$\n\n最终输出格式：\n您的程序应生成单行输出，其中包含四个测试用例的结果，形式为逗号分隔的、每个案例一个双元素列表的列表，不含空格，并用方括号括起来。例如，输出必须如下所示：\n$$\n\\texttt{[[R_1,\\text{max\\_residual}_1],[R_2,\\text{max\\_residual}_2],[R_3,\\text{max\\_residual}_3],[R_4,\\text{max\\_residual}_4]]}\n$$\n其中每个 $R_i$ 是无量纲的小数形式相对变化，每个 $\\text{max\\_residual}_i$ 是最大绝对通量连续性残差，单位为开尔文·米/秒。",
            "solution": "我们从有限体积控制体内标量 $q$ 的守恒开始。将控制方程\n$$\n\\frac{\\partial q}{\\partial t} = \\frac{\\partial}{\\partial z}\\left( K(z) \\frac{\\partial q}{\\partial z} \\right)\n$$\n在一个由界面 $z_{i-\\frac{1}{2}}$ 和 $z_{i+\\frac{1}{2}}$ 界定的单元 $i$ 上积分，其厚度为 $\\Delta z_i = z_{i+\\frac{1}{2}} - z_{i-\\frac{1}{2}}$，并应用散度定理可得\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d}t} \\left( q_i \\Delta z_i \\right) = F_{i-\\frac{1}{2}} - F_{i+\\frac{1}{2}},\n$$\n其中 $q_i$ 表示单元平均值，$F_{i\\pm\\frac{1}{2}}$ 是通过相应界面的扩散通量。在时间步长为 $\\Delta t$ 的后向欧拉时间离散格式下，从 $t^n$ 到 $t^{n+1}$，该方程变为\n$$\n\\frac{q_i^{n+1} - q_i^n}{\\Delta t} = \\frac{F_{i-\\frac{1}{2}}^{n+1} - F_{i+\\frac{1}{2}}^{n+1}}{\\Delta z_i}.\n$$\nFick 定律给出了界面上的瞬时扩散通量\n$$\nF = -K \\frac{\\partial q}{\\partial z}.\n$$\n在具有分段常数涡动扩散系数的非均匀网格上，内部界面处的梯度必须以保证界面通量连续性的方式来近似，以符合守恒性。考虑单元 $i$ 和 $i+1$ 之间的界面。设 $d_\\text{R} = \\frac{\\Delta z_i}{2}$ 表示从单元 $i$ 中心到界面的距离，设 $d_\\text{L} = \\frac{\\Delta z_{i+1}}{2}$ 表示从单元 $i+1$ 中心到界面的距离。设 $q_f$ 表示在时间 $t^{n+1}$、位置 $z_{i+\\frac{1}{2}}$ 处 $q$ 的界面值。左、右通量表达式为\n$$\nF_{i+\\frac{1}{2}, \\text{left}}^{n+1} = -K_i \\frac{q_f - q_i^{n+1}}{d_\\text{R}}, \\quad\nF_{i+\\frac{1}{2}, \\text{right}}^{n+1} = -K_{i+1} \\frac{q_{i+1}^{n+1} - q_f}{d_\\text{L}}.\n$$\n界面上的通量连续性要求\n$$\nF_{i+\\frac{1}{2}, \\text{left}}^{n+1} = F_{i+\\frac{1}{2}, \\text{right}}^{n+1}.\n$$\n求解界面值 $q_f$ 可得\n$$\nq_f = \\frac{\\left( \\frac{K_i}{d_\\text{R}} \\right) q_i^{n+1} + \\left( \\frac{K_{i+1}}{d_\\text{L}} \\right) q_{i+1}^{n+1}}{\\left( \\frac{K_i}{d_\\text{R}} \\right) + \\left( \\frac{K_{i+1}}{d_\\text{L}} \\right)}.\n$$\n将此 $q_f$ 代入任一通量表达式，即可得到一个唯一且连续的界面通量。通过使用串联电阻概念的代数操作，可将同一通量等效地表示为\n$$\nF_{i+\\frac{1}{2}}^{n+1} = -K_{i+\\frac{1}{2}} \\frac{q_{i+1}^{n+1} - q_i^{n+1}}{d_\\text{R} + d_\\text{L}},\n$$\n其中有效界面涡动扩散系数 $K_{i+\\frac{1}{2}}$ 由加权调和平均给出\n$$\nK_{i+\\frac{1}{2}} = \\frac{d_\\text{R} + d_\\text{L}}{\\frac{d_\\text{R}}{K_i} + \\frac{d_\\text{L}}{K_{i+1}}}.\n$$\n如果 $K_i$ 或 $K_{i+1}$ 中任一值为零（或极小），分母将变得很大（或无穷大），有效 $K_{i+\\frac{1}{2}}$ 趋于零，从而正确地减小了界面通量。\n\n将界面通量代入单元 $i$ 的后向欧拉守恒方程，得到\n$$\n\\frac{q_i^{n+1} - q_i^n}{\\Delta t} = \\frac{-K_{i-\\frac{1}{2}} \\frac{q_i^{n+1} - q_{i-1}^{n+1}}{d_\\text{L}^{(i)} + d_\\text{R}^{(i-1)}} + K_{i+\\frac{1}{2}} \\frac{q_{i+1}^{n+1} - q_i^{n+1}}{d_\\text{R}^{(i)} + d_\\text{L}^{(i+1)}}}{\\Delta z_i},\n$$\n其中 $d_\\text{L}^{(i)} = \\frac{\\Delta z_i}{2}$ 和 $d_\\text{R}^{(i)} = \\frac{\\Delta z_i}{2}$ 分别表示单元 $i$ 的左、右半厚度。重新整理各项，我们得到形式为\n$$\na_i q_{i-1}^{n+1} + b_i q_i^{n+1} + c_i q_{i+1}^{n+1} = q_i^n,\n$$\n的三对角系统，其系数为\n$$\na_i = -\\frac{\\Delta t}{\\Delta z_i} \\frac{K_{i-\\frac{1}{2}}}{\\frac{\\Delta z_i}{2} + \\frac{\\Delta z_{i-1}}{2}}, \\quad\nc_i = -\\frac{\\Delta t}{\\Delta z_i} \\frac{K_{i+\\frac{1}{2}}}{\\frac{\\Delta z_i}{2} + \\frac{\\Delta z_{i+1}}{2}},\n$$\n$$\nb_i = 1 - a_i - c_i = 1 + \\frac{\\Delta t}{\\Delta z_i}\\left( \\frac{K_{i-\\frac{1}{2}}}{\\frac{\\Delta z_i}{2} + \\frac{\\Delta z_{i-1}}{2}} + \\frac{K_{i+\\frac{1}{2}}}{\\frac{\\Delta z_i}{2} + \\frac{\\Delta z_{i+1}}{2}} \\right).\n$$\n底部和顶部的零通量边界意味着 $F_{1-\\frac{1}{2}}^{n+1} = 0$ 和 $F_{N+\\frac{1}{2}}^{n+1} = 0$，这消除了与虚拟单元的耦合，并将第一行和最后一行简化为\n$$\nb_1 q_1^{n+1} + c_1 q_2^{n+1} = q_1^n, \\quad\na_N q_{N-1}^{n+1} + b_N q_N^{n+1} = q_N^n,\n$$\n其中 $a_1 = 0$ 且 $c_N = 0$。对于非负的 $K$ 和 $\\Delta t > 0$，组装的矩阵是严格对角占优的，这保证了解的唯一性。得到的线性系统是三对角的，可以使用 Thomas 算法高效求解：\n- 前向消元：修改上对角线和右端项以消去下对角线。\n- 回代：求出解向量 $q^{n+1}$。\n\n守恒性源于通量差值的伸缩求和性质：将所有单元的离散守恒方程相加可得\n$$\n\\sum_{i=1}^{N} \\frac{q_i^{n+1} - q_i^n}{\\Delta t} \\Delta z_i = \\sum_{i=1}^{N} \\left(F_{i-\\frac{1}{2}}^{n+1} - F_{i+\\frac{1}{2}}^{n+1}\\right) = F_{1-\\frac{1}{2}}^{n+1} - F_{N+\\frac{1}{2}}^{n+1} = 0,\n$$\n这是因为零通量边界条件。因此，气柱积分标量是守恒的，相对变化 $R$ 应在数值舍入误差范围内接近于零。\n\n为量化求解后的界面通量连续性，对每个内部界面 $i+\\frac{1}{2}$，使用以下公式计算界面值 $q_f$\n$$\nq_f = \\frac{\\left( \\frac{K_i}{\\frac{\\Delta z_i}{2}} \\right) q_i^{n+1} + \\left( \\frac{K_{i+1}}{\\frac{\\Delta z_{i+1}}{2}} \\right) q_{i+1}^{n+1}}{\\left( \\frac{K_i}{\\frac{\\Delta z_i}{2}} \\right) + \\left( \\frac{K_{i+1}}{\\frac{\\Delta z_{i+1}}{2}} \\right)},\n$$\n然后计算\n$$\nF_{i+\\frac{1}{2}, \\text{left}}^{n+1} = -K_i \\frac{q_f - q_i^{n+1}}{\\frac{\\Delta z_i}{2}}, \\quad\nF_{i+\\frac{1}{2}, \\text{right}}^{n+1} = -K_{i+1} \\frac{q_{i+1}^{n+1} - q_f}{\\frac{\\Delta z_{i+1}}{2}}.\n$$\n根据构造，这些通量在精确算术中完全匹配；因此，所有内部界面上的最大绝对残差\n$$\n\\max_{i \\in \\{1,\\dots,N-1\\}} \\left| F_{i+\\frac{1}{2}, \\text{left}}^{n+1} - F_{i+\\frac{1}{2}, \\text{right}}^{n+1} \\right|,\n$$\n应接近机器精度（实际上为零），单位为开尔文·米/秒。当任一相邻的 $K$ 等于零时需特殊处理，此时残差定义为零。\n\n实现的算法步骤：\n- 对于每个内部界面，使用半单元距离，通过加权调和平均计算 $K_{i+\\frac{1}{2}}$。\n- 根据具有零通量边界的隐式有限体积离散格式，组装 $a_i$, $b_i$ 和 $c_i$。\n- 使用 Thomas 算法求解三对角系统以获得 $q^{n+1}$。\n- 使用 $t^n$ 和 $t^{n+1}$ 时的气柱积分计算 $R$。\n- 使用界面 $q_f$ 重构计算最大通量连续性残差。\n- 以指定的单行输出格式，将每个测试用例的结果报告为 $[R, \\text{max\\_residual}]$。\n\n该设计将基本物理原理（守恒定律和 Fick 定律）与一个鲁棒的数值离散格式相结合，该格式通过通量连续性确保了守恒性并尊重了界面物理。",
            "answer": "```python\nimport numpy as np\n\ndef harmonic_face_diffusivity(K_left, K_right, dz_left, dz_right):\n    \"\"\"\n    Compute effective face diffusivity using weighted harmonic average.\n    If either K_left or K_right is zero (or nonpositive), return zero.\n    \"\"\"\n    d_left = dz_left / 2.0\n    d_right = dz_right / 2.0\n    # Handle zero/nonpositive diffusivity: resistance becomes infinite = K_face = 0\n    r_left = (d_left / K_left) if K_left > 0.0 else np.inf\n    r_right = (d_right / K_right) if K_right > 0.0 else np.inf\n    denom = r_left + r_right\n    if not np.isfinite(denom) or denom == 0.0:\n        return 0.0\n    return (d_left + d_right) / denom\n\ndef assemble_tridiagonal(dz, K, dt):\n    \"\"\"\n    Assemble tridiagonal coefficients (a, b, c) for implicit diffusion\n    with variable K on a nonuniform grid, zero-flux (Neumann) boundaries.\n    \"\"\"\n    N = len(dz)\n    a = np.zeros(N, dtype=float)  # lower diagonal (a_i multiplies q_{i-1})\n    b = np.ones(N, dtype=float)   # main diagonal\n    c = np.zeros(N, dtype=float)  # upper diagonal (c_i multiplies q_{i+1})\n\n    half = dz / 2.0\n\n    for i in range(N):\n        # Left face contribution\n        if i > 0:\n            delta_imh = half[i] + half[i-1]  # d_R(i-1/2)+d_L(i-1/2)\n            K_face_left = harmonic_face_diffusivity(K[i-1], K[i], dz[i-1], dz[i])\n            a[i] = - (dt / dz[i]) * (K_face_left / delta_imh)\n            b[i] += (dt / dz[i]) * (K_face_left / delta_imh)\n        # Right face contribution\n        if i  N - 1:\n            delta_iph = half[i] + half[i+1]\n            K_face_right = harmonic_face_diffusivity(K[i], K[i+1], dz[i], dz[i+1])\n            c[i] = - (dt / dz[i]) * (K_face_right / delta_iph)\n            b[i] += (dt / dz[i]) * (K_face_right / delta_iph)\n\n    # Enforce zero-flux boundaries implicitly via coefficients (a[0]=0, c[-1]=0 already)\n    return a, b, c\n\ndef thomas_solver(a, b, c, d):\n    \"\"\"\n    Solve tridiagonal system with lower diag a, main diag b, upper diag c:\n    a_i * x_{i-1} + b_i * x_i + c_i * x_{i+1} = d_i\n    \"\"\"\n    n = len(b)\n    cp = np.zeros(n-1, dtype=float)\n    dp = np.zeros(n, dtype=float)\n    bp = b.astype(float).copy()\n\n    # Forward sweep\n    if n == 1:\n        return np.array([d[0] / bp[0]], dtype=float)\n\n    cp[0] = c[0] / bp[0]\n    dp[0] = d[0] / bp[0]\n    for i in range(1, n-1):\n        denom = bp[i] - a[i] * cp[i-1]\n        bp[i] = denom\n        cp[i] = c[i] / bp[i] if bp[i] != 0.0 else 0.0\n        dp[i] = (d[i] - a[i] * dp[i-1]) / bp[i] if bp[i] != 0.0 else 0.0\n    denom = bp[n-1] - a[n-1] * cp[n-2]\n    bp[n-1] = denom\n    dp[n-1] = (d[n-1] - a[n-1] * dp[n-2]) / bp[n-1] if bp[n-1] != 0.0 else 0.0\n\n    # Back substitution\n    x = np.zeros(n, dtype=float)\n    x[n-1] = dp[n-1]\n    for i in range(n-2, -1, -1):\n        x[i] = dp[i] - cp[i] * x[i+1]\n    return x\n\ndef compute_flux_continuity_residual(q, dz, K):\n    \"\"\"\n    Compute maximum absolute residual |F_left - F_right| across interior faces\n    using interface value q_f that enforces flux continuity by construction.\n    Units: K (m^2/s), q (Kelvin), dz (m) = flux units Kelvin·m/s.\n    \"\"\"\n    N = len(dz)\n    half = dz / 2.0\n    max_resid = 0.0\n    for i in range(N - 1):\n        di = half[i]\n        dj = half[i+1]\n        Ki = K[i]\n        Kj = K[i+1]\n        # If both diffusivities are zero/nonpositive, define residual = 0\n        w_left = (Ki / di) if Ki > 0.0 else 0.0\n        w_right = (Kj / dj) if Kj > 0.0 else 0.0\n        denom = w_left + w_right\n        if denom == 0.0:\n            resid = 0.0\n        else:\n            qf = (w_left * q[i] + w_right * q[i+1]) / denom\n            F_left = -Ki * (qf - q[i]) / di if Ki > 0.0 else 0.0\n            F_right = -Kj * (q[i+1] - qf) / dj if Kj > 0.0 else 0.0\n            resid = abs(F_left - F_right)\n        if resid > max_resid:\n            max_resid = resid\n    return max_resid\n\ndef implicit_diffusion_step(dz, K, dt, q0):\n    \"\"\"\n    Perform one backward Euler implicit diffusion step with variable K on a nonuniform grid.\n    \"\"\"\n    a, b, c = assemble_tridiagonal(np.array(dz, dtype=float), np.array(K, dtype=float), float(dt))\n    q1 = thomas_solver(a, b, c, np.array(q0, dtype=float))\n    return q1\n\ndef solve():\n    # Define test cases as tuples: (dz array, K array, dt, q0 array)\n    test_cases = [\n        (\n            [20.0, 30.0, 50.0, 100.0, 200.0, 300.0],\n            [0.1, 0.5, 2.0, 0.8, 0.2, 0.1],\n            600.0,\n            [10.0, 8.0, 6.0, 5.0, 4.0, 3.0]\n        ),\n        (\n            [100.0]*10,\n            [0.01]*10,\n            1.0,\n            [1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0,10.0]\n        ),\n        (\n            [1.0, 1000.0, 1000.0, 1.0],\n            [0.0, 1.0, 0.1, 0.0],\n            100.0,\n            [0.0, 10.0, 0.0, 10.0]\n        ),\n        (\n            [50.0, 50.0, 50.0, 50.0, 50.0],\n            [0.01, 10.0, 0.01, 10.0, 0.01],\n            300.0,\n            [1.0, 0.0, 1.0, 0.0, 1.0]\n        ),\n    ]\n\n    results = []\n    for dz, K, dt, q0 in test_cases:\n        dz_arr = np.array(dz, dtype=float)\n        K_arr = np.array(K, dtype=float)\n        q0_arr = np.array(q0, dtype=float)\n        # Perform implicit step\n        q1_arr = implicit_diffusion_step(dz_arr, K_arr, dt, q0_arr)\n        # Relative column integral change R (dimensionless decimal)\n        M0 = float(np.dot(q0_arr, dz_arr))\n        M1 = float(np.dot(q1_arr, dz_arr))\n        R = (M1 - M0) / M0 if M0 != 0.0 else 0.0\n        # Max flux continuity residual (Kelvin·m/s)\n        max_res = compute_flux_continuity_residual(q1_arr, dz_arr, K_arr)\n        results.append((R, max_res))\n\n    # Format output: [[R1,max_res1],[R2,max_res2],...], no spaces\n    formatted = \"[\" + \",\".join([f\"[{r:.12e},{m:.12e}]\" for r, m in results]) + \"]\"\n    print(formatted)\n\nsolve()\n```"
        }
    ]
}