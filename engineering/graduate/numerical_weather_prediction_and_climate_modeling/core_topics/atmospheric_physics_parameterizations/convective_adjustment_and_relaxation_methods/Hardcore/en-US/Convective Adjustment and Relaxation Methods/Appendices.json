{
    "hands_on_practices": [
        {
            "introduction": "A cornerstone of convective parameterization is the principle of energy conservation. This first practice provides a hands-on implementation of a classic convective adjustment scheme, where you will adjust a temperature profile to a stable state while ensuring that the total moist static energy of the atmospheric column is perfectly conserved. This exercise  builds a foundational understanding of how models represent the rapid vertical redistribution of energy during convection.",
            "id": "4026282",
            "problem": "Consider a single vertical atmospheric column discretized into $N$ layers with known geometric heights $z_i$ (in $\\mathrm{m}$), temperatures $T_i$ (in $\\mathrm{K}$), specific humidities $q_i$ (in $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$), and pressures $p_i$ (in $\\mathrm{Pa}$) at layer midpoints, for $i=1,\\dots,N$. In Numerical Weather Prediction (NWP), a common approach to represent fast convective processes is convective adjustment that relaxes the column temperature profile toward a prescribed neutral lapse rate $\\Gamma$ (in $\\mathrm{K}\\,\\mathrm{m}^{-1}$), expressed as $T_{\\mathrm{adj}}(z) = T_0 - \\Gamma z$, while conserving column-integrated Moist Static Energy (MSE). Moist Static Energy (MSE) per unit mass is defined as $h = c_p T + g z + L_v q$, where $c_p$ is the specific heat capacity of air at constant pressure, $g$ is gravitational acceleration, and $L_v$ is the latent heat of vaporization, and $q$ is specific humidity. The column-integrated MSE per unit horizontal area is $H = \\sum_{i=1}^{N} m_i h_i$, where $m_i$ is the mass per unit horizontal area of layer $i$, and $h_i$ is the layer MSE per unit mass.\n\nYour task is to implement a convective adjustment that enforces a temperature profile with a prescribed neutral lapse rate $\\Gamma$ (in $\\mathrm{K}\\,\\mathrm{m}^{-1}$), expressed as $T_{\\mathrm{adj}}(z) = T_0 - \\Gamma z$, while conserving the column-integrated MSE $H$. Assume the following:\n- The layer masses $m_i$ are computed from the initial state and are held fixed during adjustment.\n- The geometric heights $z_i$ and specific humidities $q_i$ are held fixed during adjustment.\n- The virtual temperature $T_{v,i}$ is approximated as $T_{v,i} = T_i (1 + \\epsilon q_i)$ with $\\epsilon = 0.61$, and the layer mass per unit area is $m_i = \\rho_i \\Delta z_i$, where $\\rho_i = \\dfrac{p_i}{R_d T_{v,i}}$ from the ideal gas law, $R_d$ is the specific gas constant for dry air, and $\\Delta z_i$ is the layer thickness computed from the $z_i$ grid by a consistent finite-volume approximation.\n\nStarting from the fundamental definition of $h$ and the requirement of energy conservation, derive the necessary expression to determine the intercept $T_0$ that ensures $H$ is conserved under the adjusted profile $T_{\\mathrm{adj}}(z)$, and implement an algorithm to:\n1. Compute the layer masses $m_i$ from the given $z_i$, $p_i$, $T_i$, and $q_i$ using the ideal gas law and a finite-volume estimate of $\\Delta z_i$.\n2. Compute the initial column-integrated MSE $H$.\n3. Determine $T_0$ such that the adjusted profile $T_{\\mathrm{adj}}(z) = T_0 - \\Gamma z$ conserves $H$.\n4. Compute the adjusted temperatures $T_{\\mathrm{adj},i} = T_0 - \\Gamma z_i$.\n5. Compute two diagnostics for each test case:\n   - The absolute energy conservation error $E = \\left| H_{\\mathrm{adj}} - H \\right|$ in $\\mathrm{J}\\,\\mathrm{m}^{-2}$, where $H_{\\mathrm{adj}}$ is the column-integrated MSE after adjustment.\n   - The maximum absolute deviation of the discrete lapse rate from the prescribed neutral lapse rate, defined as $\\Lambda = \\max_{i=1,\\dots,N-1} \\left| \\dfrac{T_{\\mathrm{adj},i+1} - T_{\\mathrm{adj},i}}{z_{i+1} - z_i} + \\Gamma \\right|$ in $\\mathrm{K}\\,\\mathrm{m}^{-1}$.\n\nUse the following physical constants:\n- $c_p = 1004\\ \\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$,\n- $g = 9.81\\ \\mathrm{m}\\,\\mathrm{s}^{-2}$,\n- $L_v = 2.5 \\times 10^{6}\\ \\mathrm{J}\\,\\mathrm{kg}^{-1}$,\n- $R_d = 287\\ \\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$,\n- $\\epsilon = 0.61$.\n\nFinite-volume layer thicknesses $\\Delta z_i$ must be computed as follows:\n- For $i=1$, $\\Delta z_1 = z_2 - z_1$,\n- For $1  i  N$, $\\Delta z_i = \\dfrac{z_{i+1} - z_{i-1}}{2}$,\n- For $i=N$, $\\Delta z_N = z_N - z_{N-1}$.\n\nImplement your solution as a complete, runnable program that processes the following test suite of four cases. Each test case provides arrays $z$, $T$, $q$, $p$, and a prescribed $\\Gamma$. All arrays are given at layer midpoints and must be used as provided.\n\nTest Suite:\n- Case $1$ (happy path, superadiabatic initial profile):\n  - $z = [\\,0,\\ 500,\\ 1000,\\ 1500,\\ 2000,\\ 2500\\,]\\ \\mathrm{m}$,\n  - $T = [\\,300,\\ 296,\\ 291,\\ 285,\\ 278,\\ 270\\,]\\ \\mathrm{K}$,\n  - $q = [\\,0.01,\\ 0.01,\\ 0.01,\\ 0.01,\\ 0.01,\\ 0.01\\,]\\ \\mathrm{kg}\\,\\mathrm{kg}^{-1}$,\n  - $p = [\\,100000,\\ 93941.306,\\ 88249.690,\\ 82902.912,\\ 77880.078,\\ 73161.563\\,]\\ \\mathrm{Pa}$ (computed via $p(z) = 100000 \\exp(-z/8000)$),\n  - $\\Gamma = 0.006\\ \\mathrm{K}\\,\\mathrm{m}^{-1}$.\n- Case $2$ (already neutral profile with varying humidity):\n  - $z = [\\,0,\\ 500,\\ 1000,\\ 1500,\\ 2000,\\ 2500\\,]\\ \\mathrm{m}$,\n  - $T = [\\,300,\\ 297,\\ 294,\\ 291,\\ 288,\\ 285\\,]\\ \\mathrm{K}$,\n  - $q = [\\,0.008,\\ 0.009,\\ 0.010,\\ 0.011,\\ 0.012,\\ 0.013\\,]\\ \\mathrm{kg}\\,\\mathrm{kg}^{-1}$,\n  - $p = [\\,100000,\\ 93941.306,\\ 88249.690,\\ 82902.912,\\ 77880.078,\\ 73161.563\\,]\\ \\mathrm{Pa}$,\n  - $\\Gamma = 0.006\\ \\mathrm{K}\\,\\mathrm{m}^{-1}$.\n- Case $3$ (two-layer thin column, strong instability):\n  - $z = [\\,0,\\ 100\\,]\\ \\mathrm{m}$,\n  - $T = [\\,300,\\ 295\\,]\\ \\mathrm{K}$,\n  - $q = [\\,0.02,\\ 0.02\\,]\\ \\mathrm{kg}\\,\\mathrm{kg}^{-1}$,\n  - $p = [\\,100000,\\ 98757.859\\,]\\ \\mathrm{Pa}$ (from $p(z) = 100000 \\exp(-z/8000)$),\n  - $\\Gamma = 0.0098\\ \\mathrm{K}\\,\\mathrm{m}^{-1}$.\n- Case $4$ (nonuniform spacing, dry column):\n  - $z = [\\,0,\\ 200,\\ 700,\\ 900,\\ 1400\\,]\\ \\mathrm{m}$,\n  - $T = [\\,300,\\ 288,\\ 280,\\ 276,\\ 270\\,]\\ \\mathrm{K}$,\n  - $q = [\\,0,\\ 0,\\ 0,\\ 0,\\ 0\\,]\\ \\mathrm{kg}\\,\\mathrm{kg}^{-1}$,\n  - $p = [\\,100000,\\ 97531.476,\\ 91664.418,\\ 89240.064,\\ 83852.982\\,]\\ \\mathrm{Pa}$ (from $p(z) = 100000 \\exp(-z/8000)$),\n  - $\\Gamma = 0.0065\\ \\mathrm{K}\\,\\mathrm{m}^{-1}$.\n\nFinal Output Format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets.\n- Each test caseâ€™s result must be a two-element list $[E,\\ \\Lambda]$, where $E$ is the energy conservation error in $\\mathrm{J}\\,\\mathrm{m}^{-2}$ and $\\Lambda$ is the maximum lapse deviation in $\\mathrm{K}\\,\\mathrm{m}^{-1}$.\n- All numeric outputs must be rounded to $10^{-6}$ (six digits after the decimal point).\n- For example, an output with two cases should look like $[[0.000001,0.000000],[0.123456,0.000001]]$.\n\nDeliver a complete, runnable program that implements this convective adjustment and produces the required output line for the provided test suite. No user input is permitted. Express all outputs in the specified units and rounding format. The algorithm must adhere to the conservation of column-integrated MSE as described above, and must use the stated physical constants.",
            "solution": "We begin from the definition of Moist Static Energy (MSE) per unit mass for a layer, which is given by $h = c_p T + g z + L_v q$, where $c_p$ is the specific heat at constant pressure for air, $T$ is temperature, $g$ is gravitational acceleration, $z$ is geometric height, $L_v$ is latent heat of vaporization, and $q$ is specific humidity. The column-integrated MSE per unit horizontal area is $H = \\sum_{i=1}^{N} m_i h_i$, where the summation is over layers, $m_i$ is the mass per unit area of the $i$-th layer, and $h_i$ is the MSE per unit mass in that layer.\n\nWe will perform a convective adjustment to enforce a prescribed neutral lapse rate $\\Gamma$ across the column such that the adjusted temperature profile is $T_{\\mathrm{adj}}(z) = T_0 - \\Gamma z$, where $T_0$ is the intercept at $z=0$ to be determined. The adjustment must conserve the column-integrated MSE $H$. We assume that the layer masses $m_i$ are computed from the initial state and held fixed during the adjustment, and that $z_i$ and $q_i$ are held fixed.\n\nTo determine $m_i$, we invoke the ideal gas law and a finite-volume approximation for the layer thickness. The virtual temperature $T_{v,i}$ is approximated as $T_{v,i} = T_i (1 + \\epsilon q_i)$ with $\\epsilon = 0.61$, which accounts for the effect of water vapor on density. The density at the layer midpoint is given by $\\rho_i = \\dfrac{p_i}{R_d T_{v,i}}$, where $R_d$ is the specific gas constant for dry air. The layer thickness $\\Delta z_i$ is computed from the height grid using a finite-volume scheme:\n- For the bottom layer ($i=1$), $\\Delta z_1 = z_2 - z_1$,\n- For interior layers ($1  i  N$), $\\Delta z_i = \\dfrac{z_{i+1} - z_{i-1}}{2}$,\n- For the top layer ($i=N$), $\\Delta z_N = z_N - z_{N-1}$.\nThen the mass per unit area for each layer is $m_i = \\rho_i \\Delta z_i$.\n\nThe initial column-integrated MSE is\n$$\nH = \\sum_{i=1}^{N} m_i \\left( c_p T_i + g z_i + L_v q_i \\right).\n$$\nUnder the adjusted temperature profile $T_{\\mathrm{adj}}(z_i) = T_0 - \\Gamma z_i$ and with $q_i$ and $z_i$ fixed, the adjusted column-integrated MSE is\n$$\nH_{\\mathrm{adj}} = \\sum_{i=1}^{N} m_i \\left( c_p (T_0 - \\Gamma z_i) + g z_i + L_v q_i \\right)\n= c_p T_0 \\sum_{i=1}^{N} m_i - c_p \\Gamma \\sum_{i=1}^{N} m_i z_i + g \\sum_{i=1}^{N} m_i z_i + L_v \\sum_{i=1}^{N} m_i q_i.\n$$\nImposing energy conservation $H_{\\mathrm{adj}} = H$ and solving for $T_0$, we obtain\n$$\nc_p T_0 \\sum_{i=1}^{N} m_i = H - g \\sum_{i=1}^{N} m_i z_i - L_v \\sum_{i=1}^{N} m_i q_i + c_p \\Gamma \\sum_{i=1}^{N} m_i z_i,\n$$\nwhich yields\n$$\nT_0 = \\frac{H - g \\sum_{i=1}^{N} m_i z_i - L_v \\sum_{i=1}^{N} m_i q_i + c_p \\Gamma \\sum_{i=1}^{N} m_i z_i}{c_p \\sum_{i=1}^{N} m_i}.\n$$\nThis expression ensures that, once $T_0$ is computed, the adjusted temperature profile $T_{\\mathrm{adj},i} = T_0 - \\Gamma z_i$ conserves the column-integrated MSE $H$.\n\nWe then compute diagnostics:\n- The energy conservation error\n$$\nE = \\left| H_{\\mathrm{adj}} - H \\right|,\n$$\nwhich should be close to $0$ (up to numerical floating-point rounding).\n- The maximum lapse deviation $\\Lambda$ defined by discrete differences across adjacent layers\n$$\n\\Lambda = \\max_{i=1,\\dots,N-1} \\left| \\frac{T_{\\mathrm{adj},i+1} - T_{\\mathrm{adj},i}}{z_{i+1} - z_i} + \\Gamma \\right|,\n$$\nsince the exact adjusted linear profile satisfies $\\dfrac{\\mathrm{d}T}{\\mathrm{d}z} = -\\Gamma$, thus the discrete slopes should equal $-\\Gamma$ and deviations arise only from numerical rounding.\n\nAlgorithmic steps:\n1. For each test case, read arrays $z_i$, $T_i$, $q_i$, $p_i$ and prescribed $\\Gamma$.\n2. Compute $T_{v,i} = T_i (1 + \\epsilon q_i)$, densities $\\rho_i = \\dfrac{p_i}{R_d T_{v,i}}$, and layer thicknesses $\\Delta z_i$ using the finite-volume scheme, then compute $m_i = \\rho_i \\Delta z_i$.\n3. Form $H = \\sum_i m_i (c_p T_i + g z_i + L_v q_i)$, $S_m = \\sum_i m_i$, $S_{mz} = \\sum_i m_i z_i$, and $S_{mq} = \\sum_i m_i q_i$.\n4. Compute $T_0$ via\n$$\nT_0 = \\frac{H - g S_{mz} - L_v S_{mq} + c_p \\Gamma S_{mz}}{c_p S_m}.\n$$\n5. Compute $T_{\\mathrm{adj},i} = T_0 - \\Gamma z_i$, then compute $H_{\\mathrm{adj}}$ by substituting $T_{\\mathrm{adj},i}$ into the MSE expression and using the fixed $m_i$, $z_i$, and $q_i$.\n6. Compute $E = |H_{\\mathrm{adj}} - H|$ and $\\Lambda$ from discrete slopes.\n7. Round outputs to $10^{-6}$ and return per test case as $[E,\\ \\Lambda]$.\n\nThis procedure is scientifically grounded in the conservation of MSE for convective adjustment schemes and uses the ideal gas law for mass weighting. The prescribed neutral lapse rate $\\Gamma$ is enforced deterministically by construction of the adjusted linear temperature profile, while the intercept $T_0$ is chosen to exactly conserve the column-integrated MSE given fixed layer masses and moisture.\n\nThe program implements these steps for the provided four test cases and prints a single line containing a list of two-element lists $[E,\\ \\Lambda]$ for each case, rounded to six decimal places, in the exact format specified.",
            "answer": "```python\n# Python 3.12 program implementing column convective adjustment with MSE conservation\n# Allowed libraries: numpy (1.23.5), scipy (1.11.4) [scipy not used]\nimport numpy as np\n\n# Physical constants\nCP = 1004.0           # J/(kg K)\nG = 9.81              # m/s^2\nLV = 2.5e6            # J/kg\nRD = 287.0            # J/(kg K)\nEPS = 0.61            # dimensionless\n\ndef layer_thicknesses(z):\n    \"\"\"\n    Compute finite-volume layer thicknesses for midpoint heights z.\n    z: array of shape (N,)\n    Returns dz: array of shape (N,)\n    \"\"\"\n    z = np.asarray(z, dtype=float)\n    N = z.size\n    dz = np.empty(N, dtype=float)\n    if N == 1:\n        dz[0] = 0.0\n        return dz\n    dz[0] = z[1] - z[0]\n    for i in range(1, N-1):\n        dz[i] = 0.5 * (z[i+1] - z[i-1])\n    dz[-1] = z[-1] - z[-2]\n    return dz\n\ndef compute_masses(z, T, q, p):\n    \"\"\"\n    Compute layer masses per unit area m_i = rho_i * dz_i\n    using rho_i = p_i / (RD * T_v_i), T_v_i = T_i * (1 + EPS * q_i).\n    \"\"\"\n    z = np.asarray(z, dtype=float)\n    T = np.asarray(T, dtype=float)\n    q = np.asarray(q, dtype=float)\n    p = np.asarray(p, dtype=float)\n    Tv = T * (1.0 + EPS * q)\n    rho = p / (RD * Tv)\n    dz = layer_thicknesses(z)\n    m = rho * dz\n    return m, dz\n\ndef convective_adjustment_mse(z, T, q, p, Gamma):\n    \"\"\"\n    Perform convective adjustment to neutral lapse rate Gamma\n    while conserving column-integrated MSE.\n    Returns adjusted temperatures, T0, energy error E, max lapse deviation Lambda.\n    \"\"\"\n    z = np.asarray(z, dtype=float)\n    T = np.asarray(T, dtype=float)\n    q = np.asarray(q, dtype=float)\n    p = np.asarray(p, dtype=float)\n    # Masses based on initial state\n    m, dz = compute_masses(z, T, q, p)\n\n    # Compute initial column-integrated MSE\n    h_initial = CP * T + G * z + LV * q\n    H = np.sum(m * h_initial)\n\n    # Sums needed for T0\n    S_m = np.sum(m)\n    S_mz = np.sum(m * z)\n    S_mq = np.sum(m * q)\n\n    # Compute T0 from MSE conservation\n    T0 = (H - G * S_mz - LV * S_mq + CP * Gamma * S_mz) / (CP * S_m)\n\n    # Adjusted temperatures\n    T_adj = T0 - Gamma * z\n\n    # Compute adjusted column-integrated MSE to verify conservation\n    h_adj = CP * T_adj + G * z + LV * q\n    H_adj = np.sum(m * h_adj)\n\n    # Energy conservation error\n    E = abs(H_adj - H)\n\n    # Discrete lapse deviations\n    if z.size = 2:\n        slopes = (T_adj[1:] - T_adj[:-1]) / (z[1:] - z[:-1])\n        # Target slope is -Gamma; deviation is slopes + Gamma\n        deviations = np.abs(slopes + Gamma)\n        Lambda = float(np.max(deviations))\n    else:\n        Lambda = 0.0\n\n    return T_adj, T0, E, Lambda\n\ndef format_results(results):\n    \"\"\"\n    Format results as a single-line string:\n    [[E1,Lambda1],[E2,Lambda2],...]\n    with each float rounded to 6 decimal places.\n    \"\"\"\n    def fmt_float(x):\n        return f\"{x:.6f}\"\n    inner = []\n    for (E, Lambda) in results:\n        inner.append(f\"[{fmt_float(E)},{fmt_float(Lambda)}]\")\n    return f\"[{','.join(inner)}]\"\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1\n        {\n            \"z\": [0.0, 500.0, 1000.0, 1500.0, 2000.0, 2500.0],\n            \"T\": [300.0, 296.0, 291.0, 285.0, 278.0, 270.0],\n            \"q\": [0.01, 0.01, 0.01, 0.01, 0.01, 0.01],\n            \"p\": [100000.0, 93941.306, 88249.690, 82902.912, 77880.078, 73161.563],\n            \"Gamma\": 0.006\n        },\n        # Case 2\n        {\n            \"z\": [0.0, 500.0, 1000.0, 1500.0, 2000.0, 2500.0],\n            \"T\": [300.0, 297.0, 294.0, 291.0, 288.0, 285.0],\n            \"q\": [0.008, 0.009, 0.010, 0.011, 0.012, 0.013],\n            \"p\": [100000.0, 93941.306, 88249.690, 82902.912, 77880.078, 73161.563],\n            \"Gamma\": 0.006\n        },\n        # Case 3\n        {\n            \"z\": [0.0, 100.0],\n            \"T\": [300.0, 295.0],\n            \"q\": [0.02, 0.02],\n            \"p\": [100000.0, 98757.859],\n            \"Gamma\": 0.0098\n        },\n        # Case 4\n        {\n            \"z\": [0.0, 200.0, 700.0, 900.0, 1400.0],\n            \"T\": [300.0, 288.0, 280.0, 276.0, 270.0],\n            \"q\": [0.0, 0.0, 0.0, 0.0, 0.0],\n            \"p\": [100000.0, 97531.476, 91664.418, 89240.064, 83852.982],\n            \"Gamma\": 0.0065\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        z = case[\"z\"]\n        T = case[\"T\"]\n        q = case[\"q\"]\n        p = case[\"p\"]\n        Gamma = case[\"Gamma\"]\n        T_adj, T0, E, Lambda = convective_adjustment_mse(z, T, q, p, Gamma)\n        results.append((E, Lambda))\n\n    # Final print statement in the exact required format.\n    print(format_results(results))\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "Real-world convection is not a monolithic process; it involves distinct dynamics within the boundary layer and interactions with the free troposphere above. This practice moves beyond a simple column-wide adjustment to a more sophisticated two-layer model that simulates a saturated, well-mixed boundary layer and accounts for the drying effect of entrainment above. By solving this problem , you will gain insight into how parameterizations are structured to represent different physical regimes within a single atmospheric column.",
            "id": "4026291",
            "problem": "You are given one-dimensional atmospheric columns with discrete levels characterized by pressure, height, temperature, and water vapor mixing ratio. Consider a moist convective adjustment within a specified mixed layer, and an entrainment-limited relaxation for moisture above the mixed layer. Your task is to compute the adjusted dew point temperature profile after the adjustment and relaxation.\n\nUse the following fundamental bases and definitions:\n\n- The specific heat capacity at constant pressure is $c_p = 1004 \\ \\mathrm{J \\ kg^{-1} \\ K^{-1}}$.\n- The latent heat of vaporization is $L_v = 2.5 \\times 10^6 \\ \\mathrm{J \\ kg^{-1}}$.\n- The gravitational acceleration is $g = 9.81 \\ \\mathrm{m \\ s^{-2}}$.\n- The ratio of the gas constants of dry air to water vapor is $\\epsilon = 0.622$.\n- The saturation vapor pressure over liquid water as a function of absolute temperature $T$ (in $\\mathrm{K}$) is given by the Bolton form of the Magnus formula\n  $$ e_s(T) = 611.2 \\exp\\left( \\frac{17.67 \\, T_c}{T_c + 243.5} \\right), \\quad T_c = T - 273.15, $$\n  where $e_s$ is in $\\mathrm{Pa}$.\n- The saturation mixing ratio is\n  $$ q^{\\mathrm{sat}}(T,p) = \\frac{\\epsilon \\, e_s(T)}{p - e_s(T)}, $$\n  where $p$ is pressure in $\\mathrm{Pa}$.\n- Define moist static energy\n  $$ h = c_p T + L_v q_v + g z, $$\n  where $q_v$ is the water vapor mixing ratio and $z$ is height.\n\nConvective adjustment in the mixed layer:\n- Let the mixed layer span discrete indices $i = 0,1,\\dots,k_{\\mathrm{ml}}$. Compute the mixed-layer mean moist static energy\n  $$ h_{\\mathrm{ML}} = \\frac{1}{k_{\\mathrm{ml}}+1} \\sum_{i=0}^{k_{\\mathrm{ml}}} \\left( c_p T_i + L_v q_{v,i} + g z_i \\right). $$\n- For each level $i$ in the mixed layer, determine the adjusted temperature $T_i^{\\ast}$ by solving\n  $$ c_p T_i^{\\ast} + L_v q^{\\mathrm{sat}}(T_i^{\\ast}, p_i) + g z_i = h_{\\mathrm{ML}}. $$\n  Set the adjusted water vapor mixing ratio in the mixed layer to saturation,\n  $$ q_{v,i}^{\\ast} = q^{\\mathrm{sat}}(T_i^{\\ast}, p_i). $$\n  The dew point in the mixed layer after adjustment equals the adjusted temperature,\n  $$ T_{d,i}^{\\ast} = T_i^{\\ast}. $$\n\nRelaxation above the mixed layer with entrainment:\n- For $i = k_{\\mathrm{ml}}+1, \\dots, N-1$, parameterize the moisture tendency by\n  $$ \\frac{d q_{v,i}}{d t} = \\frac{q^{\\mathrm{sat}}(T_i, p_i) - q_{v,i}}{\\tau_c} - \\frac{q_{v,i} - q_{ft,i}}{\\tau_e}, $$\n  where $\\tau_c$ is a convective moisture relaxation time scale, $\\tau_e$ is an entrainment time scale, and $q_{ft,i}$ represents a free-tropospheric background mixing ratio at level $i$.\n- Assume a steady-state above the mixed layer and compute the equilibrium mixing ratio $q_{v,i}^{\\ast}$ that satisfies\n  $$ 0 = \\frac{q^{\\mathrm{sat}}(T_i, p_i) - q_{v,i}^{\\ast}}{\\tau_c} - \\frac{q_{v,i}^{\\ast} - q_{ft,i}}{\\tau_e}. $$\n- The dew point $T_{d,i}^{\\ast}$ above the mixed layer is the solution to\n  $$ q_{v,i}^{\\ast} = q^{\\mathrm{sat}}(T_{d,i}^{\\ast}, p_i). $$\n\nDew point definition:\n- For any level, the dew point temperature $T_d$ is defined implicitly by $q_v = q^{\\mathrm{sat}}(T_d,p)$. Express all dew point temperatures in $\\mathrm{K}$.\n\nNumerical requirements:\n- Solve for $T_i^{\\ast}$ in the mixed layer using a robust one-dimensional root-finding method (for example, bisection) on the function\n  $$ f_i(T) = c_p T + L_v q^{\\mathrm{sat}}(T,p_i) + g z_i - h_{\\mathrm{ML}}. $$\n- Solve the dew point inversion above the mixed layer by numerically inverting $q^{\\mathrm{sat}}(T_d,p)$ or by algebraic inversion via the saturation vapor pressure relationship. Express the final dew point temperatures in $\\mathrm{K}$, rounded to three decimal places.\n\nTest suite:\n- Implement your program for the following three test cases. Each test case is specified by\n  - pressures $\\{p_i\\}$ in $\\mathrm{Pa}$,\n  - heights $\\{z_i\\}$ in $\\mathrm{m}$,\n  - temperatures $\\{T_i\\}$ in $\\mathrm{K}$,\n  - water vapor mixing ratios $\\{q_{v,i}\\}$ in $\\mathrm{kg \\ kg^{-1}}$,\n  - mixed-layer top index $k_{\\mathrm{ml}}$ (inclusive),\n  - convective relaxation time scale $\\tau_c$ in $\\mathrm{s}$,\n  - entrainment time scale $\\tau_e$ in $\\mathrm{s}$,\n  - free-troposphere humidity factor $\\alpha$ such that $q_{ft,i} = \\alpha \\, q^{\\mathrm{sat}}(T_i,p_i)$ for $i  k_{\\mathrm{ml}}$.\n\nCase 1 (happy path):\n- $p = [101000, 98500, 96000, 93500, 90000, 85000] \\ \\mathrm{Pa}$\n- $z = [0, 200, 400, 700, 1000, 1500] \\ \\mathrm{m}$\n- $T = [298.0, 296.0, 294.0, 291.0, 286.0, 280.0] \\ \\mathrm{K}$\n- $q_v = [0.016, 0.015, 0.014, 0.012, 0.008, 0.004] \\ \\mathrm{kg \\ kg^{-1}}$\n- $k_{\\mathrm{ml}} = 3$, $\\tau_c = 1800.0 \\ \\mathrm{s}$, $\\tau_e = 3600.0 \\ \\mathrm{s}$, $\\alpha = 0.2$\n\nCase 2 (strong entrainment, boundary condition):\n- $p = [101000, 98500, 96000, 93500, 90000, 85000] \\ \\mathrm{Pa}$\n- $z = [0, 250, 500, 800, 1100, 1600] \\ \\mathrm{m}$\n- $T = [300.0, 298.0, 296.0, 293.0, 288.0, 282.0] \\ \\mathrm{K}$\n- $q_v = [0.018, 0.017, 0.016, 0.015, 0.010, 0.005] \\ \\mathrm{kg \\ kg^{-1}}$\n- $k_{\\mathrm{ml}} = 3$, $\\tau_c = 1800.0 \\ \\mathrm{s}$, $\\tau_e = 600.0 \\ \\mathrm{s}$, $\\alpha = 0.1$\n\nCase 3 (moist free troposphere, edge case):\n- $p = [101000, 99000, 97000, 95000, 93000, 90000] \\ \\mathrm{Pa}$\n- $z = [0, 250, 500, 750, 1000, 1500] \\ \\mathrm{m}$\n- $T = [297.0, 295.0, 293.0, 290.0, 287.0, 283.0] \\ \\mathrm{K}$\n- $q_v = [0.017, 0.016, 0.015, 0.013, 0.012, 0.010] \\ \\mathrm{kg \\ kg^{-1}}$\n- $k_{\\mathrm{ml}} = 4$, $\\tau_c = 1800.0 \\ \\mathrm{s}$, $\\tau_e = 3600.0 \\ \\mathrm{s}$, $\\alpha = 0.8$\n\nOutput requirements:\n- For each test case, compute the adjusted dew point temperature profile $\\{ T_{d,i}^{\\ast} \\}$ in $\\mathrm{K}$ for all levels $i$, rounding each value to three decimal places.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each entry is the list of dew points for a test case (for example, \"[[...],[...],[...]]\" but without any extra text).",
            "solution": "The user-provided problem is a well-defined computational task in atmospheric science, specifically concerning the parameterization of sub-grid scale moist convection. The problem is scientifically grounded, internally consistent, and contains all necessary information to proceed with a solution. It is therefore deemed valid.\n\nThe core of the problem is to compute an adjusted dew point temperature profile for a one-dimensional atmospheric column, subject to two different physical parameterizations: one for a well-mixed boundary layer and another for the free troposphere above it.\n\nFirst, we establish the fundamental physical constants and thermodynamic relations provided.\n**Constants**:\n- Specific heat capacity at constant pressure: $c_p = 1004 \\ \\mathrm{J \\ kg^{-1} \\ K^{-1}}$\n- Latent heat of vaporization: $L_v = 2.5 \\times 10^6 \\ \\mathrm{J \\ kg^{-1}}$\n- Gravitational acceleration: $g = 9.81 \\ \\mathrm{m \\ s^{-2}}$\n- Ratio of the gas constants of dry air to water vapor: $\\epsilon = 0.622$\n\n**Thermodynamic Definitions**:\n- **Saturation Vapor Pressure, $e_s(T)$**: The pressure exerted by water vapor in equilibrium with liquid water at a given temperature $T$. The problem specifies the Bolton (1980) empirical formula:\n$$ e_s(T) = 611.2 \\exp\\left( \\frac{17.67 \\, T_c}{T_c + 243.5} \\right) $$\nwhere $T$ is in Kelvin, $T_c = T - 273.15$ is temperature in Celsius, and the resulting $e_s$ is in Pascals.\n\n- **Saturation Mixing Ratio, $q^{\\mathrm{sat}}(T,p)$**: The mass of water vapor per unit mass of dry air in a saturated air parcel at temperature $T$ and pressure $p$. It is given by:\n$$ q^{\\mathrm{sat}}(T,p) = \\frac{\\epsilon \\, e_s(T)}{p - e_s(T)} $$\n\n- **Moist Static Energy (MSE), $h$**: A thermodynamic quantity that is approximately conserved during moist adiabatic processes. It is the sum of sensible heat, latent heat, and geopotential energy:\n$$ h = c_p T + L_v q_v + g z $$\nwhere $T$ is temperature, $q_v$ is the water vapor mixing ratio, and $z$ is the height.\n\nThe calculation is divided into two distinct regions of the atmospheric column.\n\n**Part 1: Convective Adjustment in the Mixed Layer ($i = 0, \\dots, k_{\\mathrm{ml}}$)**\n\nThis parameterization simulates the effect of vigorous, well-mixed convection within the boundary layer. The core assumption is that such mixing homogenizes the moist static energy ($h$) throughout the layer, bringing the layer to a saturated, moist-adiabatic state.\n\n1.  **Compute Mean Moist Static Energy**: We first calculate the initial MSE at each level $i$ within the mixed layer (from $i=0$ to $k_{\\mathrm{ml}}$) using the given initial profiles of $T_i$, $q_{v,i}$, and $z_i$. The total energy is then averaged over these levels to find the target mixed-layer mean MSE, $h_{\\mathrm{ML}}$:\n    $$ h_{\\mathrm{ML}} = \\frac{1}{k_{\\mathrm{ml}}+1} \\sum_{i=0}^{k_{\\mathrm{ml}}} h_i = \\frac{1}{k_{\\mathrm{ml}}+1} \\sum_{i=0}^{k_{\\mathrm{ml}}} \\left( c_p T_i + L_v q_{v,i} + g z_i \\right) $$\n\n2.  **Determine Adjusted Temperature Profile**: After adjustment, each level $i$ in the mixed layer must have an MSE equal to $h_{\\mathrm{ML}}$. The layer is also assumed to be saturated, meaning its mixing ratio is $q_{v,i}^{\\ast} = q^{\\mathrm{sat}}(T_i^{\\ast}, p_i)$. This leads to a non-linear equation for the adjusted temperature $T_i^{\\ast}$ at each level:\n    $$ h_{\\mathrm{ML}} = c_p T_i^{\\ast} + L_v q^{\\mathrm{sat}}(T_i^{\\ast}, p_i) + g z_i $$\n    To solve for $T_i^{\\ast}$, we find the root of the function $f_i(T) = c_p T + L_v q^{\\mathrm{sat}}(T,p_i) + g z_i - h_{\\mathrm{ML}}$. Since both $T$ and $q^{\\mathrm{sat}}(T, p_i)$ are monotonically increasing with $T$, the function $f_i(T)$ is also monotonic. This guarantees a unique solution, which can be found efficiently using a numerical root-finding algorithm like the bisection method.\n\n3.  **Determine Adjusted Dew Point**: The convective adjustment process results in a saturated mixed layer. By definition, in a saturated air parcel, the dew point temperature is equal to the air temperature. Therefore, the adjusted dew point temperature is simply the adjusted temperature we just found:\n    $$ T_{d,i}^{\\ast} = T_i^{\\ast} $$\n\n**Part 2: Relaxation and Entrainment Above the Mixed Layer ($i  k_{\\mathrm{ml}}$)**\n\nAbove the mixed layer, a different parameterization is applied. It models the moisture budget as a balance between moistening from convective detrainment and drying from the entrainment of drier free-tropospheric air. The temperature profile in this region is assumed to remain unchanged.\n\n1.  **Solve for Equilibrium Mixing Ratio**: The problem provides a tendency equation for moisture, which we set to zero to find the steady-state (equilibrium) mixing ratio $q_{v,i}^{\\ast}$:\n    $$ \\frac{d q_{v,i}}{d t} = 0 = \\frac{q^{\\mathrm{sat}}(T_i, p_i) - q_{v,i}^{\\ast}}{\\tau_c} - \\frac{q_{v,i}^{\\ast} - q_{ft,i}}{\\tau_e} $$\n    Here, $T_i$ and $p_i$ are the initial, unadjusted values for the level. The background free-tropospheric mixing ratio is given by $q_{ft,i} = \\alpha \\, q^{\\mathrm{sat}}(T_i,p_i)$. Solving the steady-state equation for $q_{v,i}^{\\ast}$ yields:\n    $$ q_{v,i}^{\\ast} = \\frac{\\tau_e q^{\\mathrm{sat}}(T_i, p_i) + \\tau_c q_{ft,i}}{\\tau_c + \\tau_e} $$\n    Substituting the expression for $q_{ft,i}$ gives the final computable form for the adjusted mixing ratio.\n\n2.  **Determine Adjusted Dew Point**: The dew point temperature $T_d$ is defined implicitly by the relationship $q_v = q^{\\mathrm{sat}}(T_d, p)$. To find the adjusted dew point $T_{d,i}^{\\ast}$, we must invert this relationship for the calculated equilibrium mixing ratio $q_{v,i}^{\\ast}$ at pressure $p_i$. This inversion can be performed analytically.\n    First, we solve for the saturation vapor pressure $e_s$ corresponding to $q_{v,i}^{\\ast}$:\n    $$ q_{v,i}^{\\ast} = \\frac{\\epsilon \\, e_s}{p_i - e_s} \\implies e_s(T_{d,i}^{\\ast}) = \\frac{q_{v,i}^{\\ast} p_i}{\\epsilon + q_{v,i}^{\\ast}} $$\n    Next, we invert the Bolton formula for $e_s(T_c)$. Let $C = \\ln(e_s / 611.2)$. The formula for temperature in Celsius is:\n    $$ T_{d,c} = \\frac{243.5 C}{17.67 - C} $$\n    Finally, we convert back to Kelvin:\n    $$ T_{d,i}^{\\ast} = T_{d,c} + 273.15 $$\n    This provides the adjusted dew point temperature for all levels above the mixed layer. The final profile is constructed by combining the results from both parts.",
            "answer": "```python\nimport numpy as np\nfrom scipy.optimize import bisect\n\ndef solve():\n    \"\"\"\n    Main function to solve the convective adjustment and relaxation problem\n    for the provided test cases.\n    \"\"\"\n\n    # Physical constants\n    C_P = 1004.0  # J kg^-1 K^-1\n    L_V = 2.5e6   # J kg^-1\n    G = 9.81      # m s^-2\n    EPSILON = 0.622\n\n    # --- Thermodynamic Helper Functions ---\n\n    def e_s(T_k):\n        \"\"\"Saturation vapor pressure (Pa) from temperature (K) using Bolton's formula.\"\"\"\n        T_c = T_k - 273.15\n        return 611.2 * np.exp(17.67 * T_c / (T_c + 243.5))\n\n    def q_sat(T_k, p):\n        \"\"\"Saturation mixing ratio (kg/kg) from temperature (K) and pressure (Pa).\"\"\"\n        es_val = e_s(T_k)\n        # Prevent division by zero or negative values if p = es_val\n        if p = es_val:\n            return np.inf\n        return (EPSILON * es_val) / (p - es_val)\n\n    def inverse_q_sat(q_v, p):\n        \"\"\"\n        Calculate dew point temperature (K) from mixing ratio (kg/kg) and pressure (Pa).\n        This function inverts the q_sat relationship.\n        \"\"\"\n        # Invert q_sat to get saturation vapor pressure\n        # q_v = (epsilon * e_s) / (p - e_s) - e_s = (q_v * p) / (epsilon + q_v)\n        es_val = (q_v * p) / (EPSILON + q_v)\n\n        if es_val = 0:\n            # Physically unrealistic, indicates extremely dry air\n            return 0.0 \n\n        # Invert Bolton's formula to get temperature\n        # C = ln(e_s / 611.2)\n        # T_c = 243.5 * C / (17.67 - C)\n        C = np.log(es_val / 611.2)\n        if 17.67 - C = 0: # Avoid division by zero or negative, indicates extremely high T\n            return np.inf\n        \n        T_c = (243.5 * C) / (17.67 - C)\n        return T_c + 273.15\n\n    # --- Test Cases ---\n    \n    test_cases = [\n        {\n            \"p\": np.array([101000, 98500, 96000, 93500, 90000, 85000]),\n            \"z\": np.array([0, 200, 400, 700, 1000, 1500]),\n            \"T\": np.array([298.0, 296.0, 294.0, 291.0, 286.0, 280.0]),\n            \"q_v\": np.array([0.016, 0.015, 0.014, 0.012, 0.008, 0.004]),\n            \"k_ml\": 3,\n            \"tau_c\": 1800.0,\n            \"tau_e\": 3600.0,\n            \"alpha\": 0.2\n        },\n        {\n            \"p\": np.array([101000, 98500, 96000, 93500, 90000, 85000]),\n            \"z\": np.array([0, 250, 500, 800, 1100, 1600]),\n            \"T\": np.array([300.0, 298.0, 296.0, 293.0, 288.0, 282.0]),\n            \"q_v\": np.array([0.018, 0.017, 0.016, 0.015, 0.010, 0.005]),\n            \"k_ml\": 3,\n            \"tau_c\": 1800.0,\n            \"tau_e\": 600.0,\n            \"alpha\": 0.1\n        },\n        {\n            \"p\": np.array([101000, 99000, 97000, 95000, 93000, 90000]),\n            \"z\": np.array([0, 250, 500, 750, 1000, 1500]),\n            \"T\": np.array([297.0, 295.0, 293.0, 290.0, 287.0, 283.0]),\n            \"q_v\": np.array([0.017, 0.016, 0.015, 0.013, 0.012, 0.010]),\n            \"k_ml\": 4,\n            \"tau_c\": 1800.0,\n            \"tau_e\": 3600.0,\n            \"alpha\": 0.8\n        }\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        p, z, T, q_v = case['p'], case['z'], case['T'], case['q_v']\n        k_ml = case['k_ml']\n        tau_c, tau_e, alpha = case['tau_c'], case['tau_e'], case['alpha']\n        \n        N = len(p)\n        T_d_star_profile = np.zeros(N)\n\n        # Part 1: Convective Adjustment in the Mixed Layer (indices 0 to k_ml)\n        ml_indices = slice(0, k_ml + 1)\n        h_initial = C_P * T[ml_indices] + L_V * q_v[ml_indices] + G * z[ml_indices]\n        h_ml = np.mean(h_initial)\n\n        for i in range(k_ml + 1):\n            \n            def objective_func(T_adj):\n                \"\"\"f(T) = c_p*T + L_v*q_sat(T,p) + g*z - h_ml\"\"\"\n                return C_P * T_adj + L_V * q_sat(T_adj, p[i]) + G * z[i] - h_ml\n\n            # Find adjusted temperature T_star using bisection.\n            # A temperature range of [200K, 350K] is safe for typical atmospheric conditions.\n            T_star_i = bisect(objective_func, 200.0, 350.0)\n            \n            # In the adjusted saturated mixed layer, T_dewpoint = T_air\n            T_d_star_profile[i] = T_star_i\n\n        # Part 2: Relaxation Above the Mixed Layer (indices k_ml + 1 to N-1)\n        for i in range(k_ml + 1, N):\n            # Calculate equilibrium mixing ratio based on steady-state balance\n            q_sat_i = q_sat(T[i], p[i])\n            q_ft_i = alpha * q_sat_i\n\n            q_v_star_i = (tau_e * q_sat_i + tau_c * q_ft_i) / (tau_c + tau_e)\n\n            # Invert to find the corresponding dew point temperature\n            T_d_star_profile[i] = inverse_q_sat(q_v_star_i, p[i])\n\n        all_results.append(T_d_star_profile)\n\n    # --- Format and print the final output ---\n    formatted_results = []\n    for res_list in all_results:\n        # Round to three decimal places during formatting\n        string_list = [f\"{val:.3f}\" for val in res_list]\n        formatted_results.append(f\"[{','.join(string_list)}]\")\n    \n    print(f\"[{','.join(formatted_results)}]\")\n\n\nsolve()\n```"
        },
        {
            "introduction": "A physically-based model must never produce physically impossible results, such as negative humidity or a more unstable temperature profile resulting from an adjustment scheme. This final practice shifts focus from implementing the physics to ensuring the numerical integrity of your algorithm . Through analytical derivation, you will determine the precise constraints on a model's parameters to guarantee that fundamental properties like positivity and monotonicity are preserved, a critical skill for developing robust numerical weather and climate models.",
            "id": "4026288",
            "problem": "Consider a single-column convective adjustment step in a numerical weather prediction and climate modeling context, with $K=4$ equally spaced vertical levels. Two prognostic scalars are advanced: potential temperature $\\theta$ and specific humidity $q$. Let the pre-adjustment profiles be given by\n$$\n\\theta^{n} = \\begin{pmatrix} 300 \\\\ 298 \\\\ 297 \\\\ 301 \\end{pmatrix} \\ \\text{K}, \\qquad\nq^{n} = \\begin{pmatrix} 0.012 \\\\ 0.010 \\\\ 0.002 \\\\ 0.001 \\end{pmatrix} \\ \\text{kg}\\,\\text{kg}^{-1}.\n$$\nA single implicit-adjustment time step is modeled as a convex relaxation with parameter $\\lambda \\in [0,1]$ toward linear targets, possibly accompanied by a parameterized sink representing precipitation formation during convection. Specifically, the updates are\n$$\n\\theta^{n+1} = (1-\\lambda)\\,\\theta^{n} + \\lambda\\,B\\,\\theta^{n},\n$$\n$$\nq^{n+1} = (1-\\lambda)\\,q^{n} + \\lambda\\,(C\\,q^{n} - \\varepsilon\\,r),\n$$\nwhere $B$ is a linear operator that homogenizes the lowest three levels while leaving the top level unchanged, $C$ is the identity operator, $r$ is a nonnegative sink profile, and $\\varepsilon \\in [0,1]$ scales the sink to preserve nonnegativity. Concretely, $B$ is defined by\n$$\n(B\\,\\theta)_{i} = m \\ \\text{for} \\ i=1,2,3, \\quad (B\\,\\theta)_{4} = \\theta_{4}, \\quad m \\equiv \\frac{\\theta_{1} + \\theta_{2} + \\theta_{3}}{3},\n$$\nand $C$ is the identity, while\n$$\nr = \\begin{pmatrix} 0 \\\\ 0 \\\\ 0.003 \\\\ 0 \\end{pmatrix} \\ \\text{kg}\\,\\text{kg}^{-1}.\n$$\nDefine the discrete monotonicity diagnostic for $\\theta^{n+1}$ as the set of three inequalities\n$$\n\\theta^{n+1}_{i+1} - \\theta^{n+1}_{i} \\ge 0, \\quad i=1,2,3,\n$$\nand the positivity diagnostic for $q^{n+1}$ as the componentwise inequalities\n$$\nq^{n+1}_{i} \\ge 0, \\quad i=1,2,3,4.\n$$\nStarting from these definitions and the given updates, derive the constraints on $\\lambda$ imposed by the monotonicity diagnostic for $\\theta^{n+1}$ and determine the choice $\\lambda_{\\text{mon}}$ that enforces discrete monotonicity. Then, at $\\lambda=\\lambda_{\\text{mon}}$, determine the minimal sink scaling $\\varepsilon^{\\star} \\in [0,1]$ that guarantees the positivity diagnostic for $q^{n+1}$ holds componentwise. State clearly the final value of $\\varepsilon^{\\star}$. Express the final answer as an exact fraction. No rounding is required. The final answer must be a single number without units.",
            "solution": "The problem is first validated against the specified criteria.\n\n### Step 1: Extract Givens\n- Number of vertical levels: $K=4$.\n- Prognostic scalars: potential temperature $\\theta$ and specific humidity $q$.\n- Pre-adjustment profiles:\n$$\n\\theta^{n} = \\begin{pmatrix} 300 \\\\ 298 \\\\ 297 \\\\ 301 \\end{pmatrix} \\ \\text{K}, \\qquad\nq^{n} = \\begin{pmatrix} 0.012 \\\\ 0.010 \\\\ 0.002 \\\\ 0.001 \\end{pmatrix} \\ \\text{kg}\\,\\text{kg}^{-1}.\n$$\n- Update equations for a single implicit-adjustment time step:\n$$\n\\theta^{n+1} = (1-\\lambda)\\,\\theta^{n} + \\lambda\\,B\\,\\theta^{n} \\\\\nq^{n+1} = (1-\\lambda)\\,q^{n} + \\lambda\\,(C\\,q^{n} - \\varepsilon\\,r)\n$$\n- Relaxation parameter: $\\lambda \\in [0,1]$.\n- Operator $B$: $(B\\,\\theta)_{i} = m$ for $i=1,2,3$, $(B\\,\\theta)_{4} = \\theta_{4}$, where $m \\equiv \\frac{\\theta_{1} + \\theta_{2} + \\theta_{3}}{3}$.\n- Operator $C$: the identity operator.\n- Sink profile: $r = \\begin{pmatrix} 0 \\\\ 0 \\\\ 0.003 \\\\ 0 \\end{pmatrix} \\ \\text{kg}\\,\\text{kg}^{-1}$.\n- Sink scaling parameter: $\\varepsilon \\in [0,1]$.\n- Monotonicity diagnostic for $\\theta^{n+1}$: $\\theta^{n+1}_{i+1} - \\theta^{n+1}_{i} \\ge 0$ for $i=1,2,3$.\n- Positivity diagnostic for $q^{n+1}$: $q^{n+1}_{i} \\ge 0$ for $i=1,2,3,4$.\n- Objectives: Derive constraints on $\\lambda$ and find $\\lambda_{\\text{mon}}$. Then, at $\\lambda=\\lambda_{\\text{mon}}$, find the minimal sink scaling $\\varepsilon^{\\star}$ that ensures positivity for $q^{n+1}$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, well-posed, and objective. It describes a simplified, but standard, convective adjustment scheme used in atmospheric modeling. All parameters and operators are clearly defined, and the objectives are specific and quantifiable. The data values are physically reasonable. The problem is a formal exercise in applying defined constraints to a numerical algorithm, which is a common task in the specified field. No flaws are identified.\n\n### Step 3: Verdict and Action\nThe problem is valid. A solution will be provided.\n\n### Solution Derivation\n\nThe solution process is divided into two main parts: first, determining the monotonicity-enforcing relaxation parameter $\\lambda_{\\text{mon}}$, and second, determining the positivity-preserving sink scaling parameter $\\varepsilon^{\\star}$ at that value of $\\lambda$.\n\n**Part 1: Determination of $\\lambda_{\\text{mon}}$**\n\nThe update equation for the potential temperature $\\theta$ is given by\n$$\n\\theta^{n+1} = (1-\\lambda)\\,\\theta^{n} + \\lambda\\,B\\,\\theta^{n}\n$$\nFirst, we compute the target profile $B\\,\\theta^{n}$ using the given initial profile $\\theta^{n}$.\nThe components of $\\theta^{n}$ are $\\theta^{n}_{1} = 300$, $\\theta^{n}_{2} = 298$, $\\theta^{n}_{3} = 297$, and $\\theta^{n}_{4} = 301$.\nThe mean value $m$ for the lowest three levels is:\n$$\nm = \\frac{\\theta^{n}_{1} + \\theta^{n}_{2} + \\theta^{n}_{3}}{3} = \\frac{300 + 298 + 297}{3} = \\frac{895}{3}\n$$\nThe operator $B$ homogenizes these three levels to $m$ and leaves the top level unchanged. Thus,\n$$\nB\\,\\theta^{n} = \\begin{pmatrix} 895/3 \\\\ 895/3 \\\\ 895/3 \\\\ 301 \\end{pmatrix}\n$$\nNow we can write the components of the updated profile $\\theta^{n+1}$ in terms of $\\lambda$:\n$$\n\\theta^{n+1}_{1} = (1-\\lambda)\\theta^{n}_{1} + \\lambda m = (1-\\lambda)(300) + \\lambda\\frac{895}{3} = 300 - 300\\lambda + \\frac{895}{3}\\lambda = 300 + \\frac{895-900}{3}\\lambda = 300 - \\frac{5}{3}\\lambda\n$$\n$$\n\\theta^{n+1}_{2} = (1-\\lambda)\\theta^{n}_{2} + \\lambda m = (1-\\lambda)(298) + \\lambda\\frac{895}{3} = 298 - 298\\lambda + \\frac{895}{3}\\lambda = 298 + \\frac{895-894}{3}\\lambda = 298 + \\frac{1}{3}\\lambda\n$$\n$$\n\\theta^{n+1}_{3} = (1-\\lambda)\\theta^{n}_{3} + \\lambda m = (1-\\lambda)(297) + \\lambda\\frac{895}{3} = 297 - 297\\lambda + \\frac{895}{3}\\lambda = 297 + \\frac{895-891}{3}\\lambda = 297 + \\frac{4}{3}\\lambda\n$$\n$$\n\\theta^{n+1}_{4} = (1-\\lambda)\\theta^{n}_{4} + \\lambda \\theta^{n}_{4} = \\theta^{n}_{4} = 301\n$$\nNext, we apply the discrete monotonicity diagnostic, which requires $\\theta^{n+1}_{i+1} - \\theta^{n+1}_{i} \\ge 0$ for $i=1,2,3$.\n\nFor $i=1$:\n$$\n\\theta^{n+1}_{2} - \\theta^{n+1}_{1} \\ge 0 \\\\\n\\left(298 + \\frac{1}{3}\\lambda\\right) - \\left(300 - \\frac{5}{3}\\lambda\\right) \\ge 0 \\\\\n-2 + \\frac{6}{3}\\lambda \\ge 0 \\\\\n-2 + 2\\lambda \\ge 0 \\implies \\lambda \\ge 1\n$$\nFor $i=2$:\n$$\n\\theta^{n+1}_{3} - \\theta^{n+1}_{2} \\ge 0 \\\\\n\\left(297 + \\frac{4}{3}\\lambda\\right) - \\left(298 + \\frac{1}{3}\\lambda\\right) \\ge 0 \\\\\n-1 + \\frac{3}{3}\\lambda \\ge 0 \\\\\n-1 + \\lambda \\ge 0 \\implies \\lambda \\ge 1\n$$\nFor $i=3$:\n$$\n\\theta^{n+1}_{4} - \\theta^{n+1}_{3} \\ge 0 \\\\\n301 - \\left(297 + \\frac{4}{3}\\lambda\\right) \\ge 0 \\\\\n4 - \\frac{4}{3}\\lambda \\ge 0 \\implies 4 \\ge \\frac{4}{3}\\lambda \\implies 3 \\ge \\lambda \\implies \\lambda \\le 3\n$$\nTo satisfy all three monotonicity conditions, $\\lambda$ must be in the interval $[1, 3]$. However, the problem statement constrains the relaxation parameter to $\\lambda \\in [0,1]$. The intersection of these two constraints, $[1,3] \\cap [0,1]$, contains only a single point: $\\lambda=1$. Therefore, the only choice of $\\lambda$ in the allowed range that enforces discrete monotonicity is $\\lambda_{\\text{mon}} = 1$.\n\n**Part 2: Determination of $\\varepsilon^{\\star}$**\n\nThe update equation for the specific humidity $q$ is\n$$\nq^{n+1} = (1-\\lambda)\\,q^{n} + \\lambda\\,(C\\,q^{n} - \\varepsilon\\,r)\n$$\nSince $C$ is the identity operator, this simplifies to:\n$$\nq^{n+1} = (1-\\lambda)\\,q^{n} + \\lambda\\,(q^{n} - \\varepsilon\\,r) = (1-\\lambda+\\lambda)q^n - \\lambda\\varepsilon r = q^n - \\lambda\\varepsilon r\n$$\nWe must now evaluate this equation at $\\lambda = \\lambda_{\\text{mon}} = 1$:\n$$\nq^{n+1} = q^n - \\varepsilon r\n$$\n substituting the given vectors for $q^n$ and $r$:\n$$\nq^{n+1} = \\begin{pmatrix} 0.012 \\\\ 0.010 \\\\ 0.002 \\\\ 0.001 \\end{pmatrix} - \\varepsilon \\begin{pmatrix} 0 \\\\ 0 \\\\ 0.003 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} 0.012 \\\\ 0.010 \\\\ 0.002 - 0.003\\varepsilon \\\\ 0.001 \\end{pmatrix}\n$$\nThe positivity diagnostic requires $q^{n+1}_{i} \\ge 0$ for all components $i=1,2,3,4$.\nFor $i=1$: $q^{n+1}_{1} = 0.012 \\ge 0$, which is always satisfied.\nFor $i=2$: $q^{n+1}_{2} = 0.010 \\ge 0$, which is always satisfied.\nFor $i=4$: $q^{n+1}_{4} = 0.001 \\ge 0$, which is always satisfied.\nFor $i=3$, the condition is non-trivial:\n$$\nq^{n+1}_{3} = 0.002 - 0.003\\varepsilon \\ge 0\n$$\nSolving for $\\varepsilon$:\n$$\n0.002 \\ge 0.003\\varepsilon \\implies \\varepsilon \\le \\frac{0.002}{0.003} = \\frac{2}{3}\n$$\nWe are also given that $\\varepsilon \\in [0,1]$. Combining these constraints, the range of values for $\\varepsilon$ that guarantees positivity is $0 \\le \\varepsilon \\le \\frac{2}{3}$.\n\nThe problem asks for the \"minimal sink scaling $\\varepsilon^{\\star}$\". This phrasing can be interpreted in two ways. A literal interpretation would imply the minimum value in the valid range $[0, 2/3]$, which is $\\varepsilon^{\\star}=0$. However, in the context of numerical modeling and parameterization, the sink term represents a physical process (precipitation). The parameter $\\varepsilon$ is introduced as a \"limiter\" to prevent the model from producing unphysical negative values of moisture. The unconstrained physical model would correspond to $\\varepsilon=1$. The goal of a limiter is typically to make the minimal necessary adjustment to the unconstrained model to satisfy the physical constraint. This implies that one should choose the value of $\\varepsilon$ that is closest to $1$ while still satisfying the positivity constraint. This value is the maximum allowed value in the derived range.\n\nTherefore, the physically and algorithmically meaningful interpretation is to select the largest possible value of $\\varepsilon$ that preserves positivity, as this represents applying the precipitation physics as strongly as possible within the given constraints.\nThis value is $\\varepsilon^{\\star} = \\frac{2}{3}$. This represents the minimal *reduction* of the sink term needed to maintain positivity.\n\nThus, the minimal sink scaling, interpreted in the context of numerical limiters, is $\\varepsilon^{\\star} = \\frac{2}{3}$.",
            "answer": "$$\\boxed{\\frac{2}{3}}$$"
        }
    ]
}