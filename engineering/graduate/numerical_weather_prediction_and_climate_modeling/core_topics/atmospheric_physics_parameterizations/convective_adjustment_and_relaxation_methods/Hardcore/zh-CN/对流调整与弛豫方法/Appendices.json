{
    "hands_on_practices": [
        {
            "introduction": "对流调整是大气模型中参数化方案的基石，用于消除垂直方向上的静力不稳定性。本实践从最基本的形式——干对流调整入手，当位温 $\\theta$ 随高度降低时，大气层结变得不稳定。该练习将指导您实现一种高效的“堆栈”算法（一种池邻近违规者算法，PAVA），通过逐层合并质量加权的位温来系统地移除不稳定性，最终生成一个满足静力稳定条件的位温廓线。",
            "id": "4026309",
            "problem": "给定一个离散化的垂直大气柱，它由 $N$ 个有限层表示，从底部（$i=1$）到顶部（$i=N$）进行索引。每个层 $i$ 具有已知的单位水平面积质量 $m_i$，单位为千克/平方米（$\\mathrm{kg}/\\mathrm{m}^2$），以及已知的位温 $\\theta_i$，单位为开尔文（$K$）。位温由经过充分检验的公式 $\\theta = T \\left(\\dfrac{p_0}{p}\\right)^{R/c_p}$ 定义，其中 $T$ 是温度，单位为开尔文（$K$）；$p$ 是压力，单位为帕斯卡（$\\mathrm{Pa}$）；$p_0$ 是参考压力（通常为 $p_0 = 10^5\\,\\mathrm{Pa}$）；$R$ 是干空气的比气体常数，单位为焦耳/千克/开尔文（$\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$）；$c_p$ 是定压比热，单位为焦耳/千克/开尔文（$\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$）。对于干绝热运动，位温 $\\theta$ 是随体守恒的。\n\n在干条件下，如果 $\\dfrac{\\partial \\theta}{\\partial z} \\ge 0$，则气柱是静力稳定的，其离散形式要求对于所有相邻层 $i$，都有 $\\theta_{i+1} \\ge \\theta_i$。如果有任何一对违反了 $\\theta_{i+1} \\ge \\theta_i$，则该气柱在该段是静力不稳定的。在干绝热动力学下，一个基于物理的对流调整过程会瞬时混合任何静力不稳定的连续层集，使其达到一个中性状态，即在该混合层集中具有均匀的位温。由于 $\\theta$ 是守恒的，并且混合过程被假定为绝热且没有源或汇，混合块的中性值必须等于该块中原始值的质量加权平均值：\n$$\n\\theta_{\\mathrm{mix}} = \\frac{\\sum_{j \\in \\mathcal{B}} m_j \\theta_j}{\\sum_{j \\in \\mathcal{B}} m_j},\n$$\n其中 $ \\mathcal{B} $ 是混合块中各层的索引集。\n\n您的任务是实现一个堆栈算法（一种池邻近违规者（pool-adjacent-violators）风格的松弛算法），该算法通过使用层平均混合逐层消除静力不稳定性，从而得到一个随高度非递减的最终调整后廓线 $\\{\\hat{\\theta}_i\\}_{i=1}^N$。该算法必须：\n- 从底部开始，将每一层作为一个块（包含其 $m_i$ 和 $\\theta_i$）压入堆栈。\n- 每当顶部块的位温严格小于其下方块的位温时，将这两个块合并成一个单独的块，其质量为两个块的质量之和，其位温为两者的质量加权平均值，如上定义。只要非递减条件被违反，就重复合并操作。\n- 处理完所有层后，将堆栈展开回逐层的序列，将合并块中每个原始层的位温都赋为该块的中性位温 $\\theta_{\\mathrm{mix}}$。\n\n该方法基于以下经过充分检验的基本原理：\n- 沿气块运动的位温 $\\theta$ 的干绝热守恒。\n- 静力稳定判据 $\\dfrac{\\partial \\theta}{\\partial z} \\ge 0$。\n- 混合块内质量和整柱积分位温的守恒，这意味着质量加权平均。\n\n实现此算法，为下面列出的每个测试用例生成调整后的位温廓线。所有位温必须以开尔文（$K$）表示，并报告为四舍五入到五位小数的浮点数。假设所有的 $m_i$ 都严格为正，并且混合是严格局地和绝热的。本问题不涉及角度。\n\n测试套件规范：\n- 案例 1（已稳定）：\n  - $N = 4$\n  - $m = [100, 100, 100, 100]$，单位为 $\\mathrm{kg}/\\mathrm{m}^2$\n  - $\\theta = [300, 301, 302, 303]$，单位为 $K$\n- 案例 2（底部存在单一不稳定对）：\n  - $N = 3$\n  - $m = [100, 100, 100]$，单位为 $\\mathrm{kg}/\\mathrm{m}^2$\n  - $\\theta = [300, 299, 301]$，单位为 $K$\n- 案例 3（非均匀质量的多层混合）：\n  - $N = 4$\n  - $m = [800, 100, 100, 100]$，单位为 $\\mathrm{kg}/\\mathrm{m}^2$\n  - $\\theta = [300, 295, 290, 310]$，单位为 $K$\n- 案例 4（从堆栈顶部开始的级联合并）：\n  - $N = 4$\n  - $m = [100, 100, 100, 100]$，单位为 $\\mathrm{kg}/\\mathrm{m}^2$\n  - $\\theta = [300, 310, 305, 303]$，单位为 $K$\n- 案例 5（值相等，中性）：\n  - $N = 3$\n  - $m = [50, 100, 150]$，单位为 $\\mathrm{kg}/\\mathrm{m}^2$\n  - $\\theta = [300, 300, 300]$，单位为 $K$\n\n最终输出格式：\n您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果。每一项对应一个测试用例，本身是一个浮点数列表，表示调整后每层的位温廓线，单位为开尔文（$K$），四舍五入到五位小数。例如，输出必须如下所示：\n$[\\,[\\hat{\\theta}_1^{(1)}, \\ldots], [\\hat{\\theta}_1^{(2)}, \\ldots], \\ldots\\,]$。",
            "solution": "用户提供的问题已经过验证并且是合理的。它在科学上以大气热力学原理为基础，问题定义清晰，算法和输入明确，表述客观。因此，我们可以着手解决。\n\n该问题要求为离散化的垂直大气柱实现一个对流调整算法。目标是将初始位温廓线 $\\{\\theta_i\\}_{i=1}^N$ 转换为最终的静力稳定廓线 $\\{\\hat{\\theta}_i\\}_{i=1}^N$。如果位温随高度非递减，则廓线是静力稳定的，对于我们的离散层，这意味着对于所有相邻的层 $i$ 和 $i+1$，都有 $\\hat{\\theta}_{i+1} \\ge \\hat{\\theta}_i$。指定的算法是一种堆栈方法，它是池邻近违规者算法（Pool Adjacent Violators Algorithm, PAVA）的一种实现。\n\n该方法的物理基础建立在两个关键原则之上：\n1.  **位温守恒**：对于干绝热过程，位温 $\\theta$ 是一个守恒量。当层发生混合时，没有外部热源或热汇，因此混合层的总“位温热含量”必须守恒。\n2.  **质量守恒**：混合层的总质量是守恒的。\n\n将这些原则应用于一组正在混合的连续层 $\\mathcal{B}$，得到的混合块的位温 $\\theta_{\\mathrm{mix}}$ 必须是该块中各层初始位温的质量加权平均值。这由给定公式表示：\n$$\n\\theta_{\\mathrm{mix}} = \\frac{\\sum_{j \\in \\mathcal{B}} m_j \\theta_j}{\\sum_{j \\in \\mathcal{B}} m_j}\n$$\n这可以重写为 $\\theta_{\\mathrm{mix}} \\sum m_j = \\sum (m_j \\theta_j)$，这清晰地表明了总位温热含量 $\\sum m_j \\theta_j$ 的守恒。\n\n堆栈算法提供了一种系统且计算高效的方法来识别所有不稳定区域，并应用此混合规则以生成最终的稳定廓线。算法流程如下：\n\n1.  **初始化**：我们从一个空堆栈开始。这个堆栈将存储“块”，每个块代表一个或多个已经混合成单一均匀状态的连续原始层。我们从气柱底部（$i=1$）到顶部（$i=N$）逐一处理初始层。\n\n2.  **迭代处理**：对于从 $1$ 到 $N$ 的每一层 $i$：\n    a. 我们创建一个代表这个单层的新块，其质量为 $m_i$，位温为 $\\theta_i$，并将其压入堆栈顶部。\n    b. 然后我们检查不稳定性。如果堆栈包含至少两个块，并且顶部块的位温严格小于其正下方块的位温，则存在不稳定性。\n    c. 如果检测到不稳定性，则合并顶部两个块。新的合并块的总质量是单个块质量之和。其位温是两个块位温的质量加权平均值，与守恒原则一致。这个新的合并块取代了堆栈上的两个原始块。\n    d. 重复此检查和合并步骤，直到堆栈顶部稳定为止（即，顶部块的位温大于或等于其下方块的位温，或者堆栈中只有一个块）。这种重复处理了级联不稳定性，即两个块的混合可能与下面的层产生新的不稳定性，从而引发进一步的合并。\n\n3.  **廓线重建**：在处理完所有 $N$ 层之后，堆栈包含一系列块，每个块都具有均匀的位温，且从底部块到顶部块，位温是非递减的。通过展开这些块来构建最终调整后的廓线 $\\{\\hat{\\theta}_i\\}$。对于堆栈中的每个块，我们将其均匀的位温分配给它所包含的所有原始大气层。\n\n在数值实现上，为每个块存储总质量（$M_{\\mathrm{block}}$）和总位温热含量（$\\Theta_{\\mathrm{block}} = \\sum m_j \\theta_j$）会稍微更高效和稳健。当合并两个块（例如块 $A$ 和块 $B$）时，新的合并块 $C$ 具有以下属性：\n$$\nM_C = M_A + M_B\n$$\n$$\n\\Theta_C = \\Theta_A + \\Theta_B\n$$\n任何块的均匀位温则可简单地通过 $\\theta_{\\mathrm{block}} = \\Theta_{\\mathrm{block}} / M_{\\mathrm{block}}$ 计算得出。这种方法最大限度地减少了重复的乘法和除法运算。\n\n该算法保证了最终廓线的唯一性和稳定性，并遵守了干绝热混合的物理约束，即质量和位温热含量守恒。",
            "answer": "```python\nimport numpy as np\n\ndef convective_adjustment_pava(masses, thetas):\n    \"\"\"\n    Applies a pool-adjacent-violators style algorithm for convective adjustment.\n\n    This function takes a vertical profile of layer masses and potential temperatures\n    and returns a statically stable potential temperature profile, where static\n    instabilities have been removed through mass-conservative mixing.\n\n    Args:\n        masses (list of float): The mass per unit area of each layer, from bottom to top.\n        thetas (list of float): The potential temperature of each layer, from bottom to top.\n\n    Returns:\n        list of float: The adjusted, statically stable potential temperature profile.\n    \"\"\"\n    # The stack will store blocks. Each block is a dictionary representing a\n    # single mixed region of one or more layers. To improve numerical stability\n    # and efficiency, we store the sum of (mass * theta) instead of theta itself.\n    stack = []\n\n    for i in range(len(masses)):\n        # Add the current layer as a new block to the top of the stack.\n        # Ensure values are floats to prevent integer arithmetic issues.\n        stack.append({\n            'mass': float(masses[i]),\n            'theta_sum': float(masses[i]) * float(thetas[i]),\n            'num_layers': 1\n        })\n\n        # Check for instability and merge if necessary. The while loop handles\n        # cascading merges, where a merge might create a new instability with\n        # the block below it.\n        while len(stack) > 1:\n            top_block = stack[-1]\n            second_block = stack[-2]\n            \n            # An instability exists if theta_top  theta_second.\n            # We derive theta from theta_sum / mass for the comparison.\n            if (top_block['theta_sum'] / top_block['mass'])  (second_block['theta_sum'] / second_block['mass']):\n                # Pop the two unstable blocks.\n                stack.pop()\n                stack.pop()\n                \n                # Create a new block by merging them, conserving mass and total theta content.\n                merged_block = {\n                    'mass': top_block['mass'] + second_block['mass'],\n                    'theta_sum': top_block['theta_sum'] + second_block['theta_sum'],\n                    'num_layers': top_block['num_layers'] + second_block['num_layers']\n                }\n                # Push the new merged block back onto the stack.\n                stack.append(merged_block)\n            else:\n                # The top of the stack is stable, so we break the merge loop.\n                break\n    \n    # After processing all layers, the stack contains the final stable blocks.\n    # Unpack the stack to create the layer-by-layer final profile.\n    final_theta_profile = []\n    for block in stack:\n        block_theta = block['theta_sum'] / block['mass']\n        # Extend the final list with the block's uniform theta for each layer it contains.\n        final_theta_profile.extend([block_theta] * block['num_layers'])\n        \n    return final_theta_profile\n\ndef solve():\n    \"\"\"\n    Runs the convective adjustment algorithm for the specified test cases and\n    prints the results in the required format.\n    \"\"\"\n    test_cases = [\n        # Case 1 (already stable)\n        {'m': [100, 100, 100, 100], 'theta': [300, 301, 302, 303]},\n        # Case 2 (single unstable pair at the bottom)\n        {'m': [100, 100, 100], 'theta': [300, 299, 301]},\n        # Case 3 (multi-layer mixing with non-uniform mass)\n        {'m': [800, 100, 100, 100], 'theta': [300, 295, 290, 310]},\n        # Case 4 (cascading merges from the top of the stack)\n        {'m': [100, 100, 100, 100], 'theta': [300, 310, 305, 303]},\n        # Case 5 (equal values, neutral)\n        {'m': [50, 100, 150], 'theta': [300, 300, 300]}\n    ]\n\n    result_strings = []\n    for case in test_cases:\n        adjusted_profile = convective_adjustment_pava(case['m'], case['theta'])\n        \n        # Format each number to five decimal places and join into a string like \"[n1,n2,...]\".\n        # This creates a JSON-like representation without extraneous whitespace.\n        formatted_profile = [f\"{t:.5f}\" for t in adjusted_profile]\n        profile_str = f\"[{','.join(formatted_profile)}]\"\n        result_strings.append(profile_str)\n        \n    # Combine the string representations of each test case result into the final output string.\n    final_output = f\"[{','.join(result_strings)}]\"\n    print(final_output)\n\nsolve()\n```"
        },
        {
            "introduction": "在理解了干对流调整之后，我们将转向更贴近真实大气的湿对流过程，其中湿静力能量（Moist Static Energy, MSE）是在湿绝热过程中近似守恒的关键物理量。本实践要求您实现一个更复杂的调整方案，它并非简单地将不稳定层混合，而是将整个大气柱的温度廓线调整至一个预设的、物理上中性的递减率 $\\Gamma$，同时严格保证总湿静力能量守恒。 这项练习能训练您如何应用守恒定律来推导参数化方案中的关键参数，这是模型开发中的一项核心技能。",
            "id": "4026282",
            "problem": "考虑一个垂直大气柱，它被离散化为 $N$ 个层，各层中点的几何高度 $z_i$（单位：$\\mathrm{m}$）、温度 $T_i$（单位：$\\mathrm{K}$）、比湿 $q_i$（单位：$\\mathrm{kg}\\,\\mathrm{kg}^{-1}$）和气压 $p_i$（单位：$\\mathrm{Pa}$）均为已知，其中 $i=1,\\dots,N$。在数值天气预报（NWP）中，一种表示快速对流过程的常用方法是对流调整，该方法将气柱温度廓线松弛至一个预设的中性递减率，同时保持整层积分的湿静力能（MSE）守恒。单位质量的湿静力能（MSE）定义为 $h = c_p T + g z + L_v q$，其中 $c_p$ 是空气的定压比热容，$g$ 是重力加速度，$L_v$ 是蒸发潜热，$q$ 是比湿。单位水平面积上的整层积分湿静力能为 $H = \\sum_{i=1}^{N} m_i h_i$，其中 $m_i$ 是第 $i$ 层的单位水平面积质量，$h_i$ 是该层的单位质量湿静力能。\n\n你的任务是实现一个对流调整方案，该方案强制执行一个具有规定中性递减率 $\\Gamma$（单位为 $\\mathrm{K}\\,\\mathrm{m}^{-1}$）的温度廓线，表示为 $T_{\\mathrm{adj}}(z) = T_0 - \\Gamma z$，同时保持整层积分的湿静力能 $H$ 守恒。假设如下：\n- 层质量 $m_i$ 从初始状态计算得出，并在调整过程中保持不变。\n- 几何高度 $z_i$ 和比湿 $q_i$ 在调整过程中保持不变。\n- 虚温 $T_{v,i}$ 近似为 $T_{v,i} = T_i (1 + \\epsilon q_i)$，其中 $\\epsilon = 0.61$，单位面积的层质量为 $m_i = \\rho_i \\Delta z_i$，其中 $\\rho_i = \\dfrac{p_i}{R_d T_{v,i}}$ 来自理想气体定律，$R_d$ 是干空气比气体常数，层厚度 $\\Delta z_i$ 通过一致的有限体积近似从 $z_i$ 网格计算得出。\n\n从 $h$ 的基本定义和能量守恒的要求出发，推导出确定截距 $T_0$ 的必要表达式，以确保在调整后的廓线 $T_{\\mathrm{adj}}(z)$ 下 $H$ 守恒，并实现一个算法来：\n1. 根据给定的 $z_i$、$p_i$、$T_i$ 和 $q_i$，使用理想气体定律和 $\\Delta z_i$ 的有限体积估计来计算层质量 $m_i$。\n2. 计算初始的整层积分湿静力能 $H$。\n3. 确定 $T_0$，使得调整后的廓线 $T_{\\mathrm{adj}}(z) = T_0 - \\Gamma z$ 保持 $H$ 守恒。\n4. 计算调整后的温度 $T_{\\mathrm{adj},i} = T_0 - \\Gamma z_i$。\n5. 为每个测试用例计算两个诊断量：\n   - 绝对能量守恒误差 $E = \\left| H_{\\mathrm{adj}} - H \\right|$，单位为 $\\mathrm{J}\\,\\mathrm{m}^{-2}$，其中 $H_{\\mathrm{adj}}$ 是调整后的整层积分湿静力能。\n   - 离散递减率与规定中性递减率的最大绝对偏差，定义为 $\\Lambda = \\max_{i=1,\\dots,N-1} \\left| \\dfrac{T_{\\mathrm{adj},i+1} - T_{\\mathrm{adj},i}}{z_{i+1} - z_i} + \\Gamma \\right|$，单位为 $\\mathrm{K}\\,\\mathrm{m}^{-1}$。\n\n使用以下物理常数：\n- $c_p = 1004\\ \\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$，\n- $g = 9.81\\ \\mathrm{m}\\,\\mathrm{s}^{-2}$，\n- $L_v = 2.5 \\times 10^{6}\\ \\mathrm{J}\\,\\mathrm{kg}^{-1}$，\n- $R_d = 287\\ \\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$，\n- $\\epsilon = 0.61$。\n\n有限体积层厚度 $\\Delta z_i$ 必须按以下方式计算：\n- 对于 $i=1$，$\\Delta z_1 = z_2 - z_1$，\n- 对于 $1  i  N$，$\\Delta z_i = \\dfrac{z_{i+1} - z_{i-1}}{2}$，\n- 对于 $i=N$，$\\Delta z_N = z_N - z_{N-1}$。\n\n将您的解决方案实现为一个完整的、可运行的程序，处理以下包含四个用例的测试套件。每个测试用例提供数组 $z$、$T$、$q$、$p$ 和一个规定的 $\\Gamma$。所有数组都在层中点给出，必须按提供的方式使用。\n\n测试套件：\n- 案例1（理想情况，超绝热初始廓线）：\n  - $z = [\\,0,\\ 500,\\ 1000,\\ 1500,\\ 2000,\\ 2500\\,]\\ \\mathrm{m}$，\n  - $T = [\\,300,\\ 296,\\ 291,\\ 285,\\ 278,\\ 270\\,]\\ \\mathrm{K}$，\n  - $q = [\\,0.01,\\ 0.01,\\ 0.01,\\ 0.01,\\ 0.01,\\ 0.01\\,]\\ \\mathrm{kg}\\,\\mathrm{kg}^{-1}$，\n  - $p = [\\,100000,\\ 93941.306,\\ 88249.690,\\ 82902.912,\\ 77880.078,\\ 73161.563\\,]\\ \\mathrm{Pa}$（通过 $p(z) = 100000 \\exp(-z/8000)$ 计算），\n  - $\\Gamma = 0.006\\ \\mathrm{K}\\,\\mathrm{m}^{-1}$。\n- 案例2（已为中性廓线，但湿度变化）：\n  - $z = [\\,0,\\ 500,\\ 1000,\\ 1500,\\ 2000,\\ 2500\\,]\\ \\mathrm{m}$，\n  - $T = [\\,300,\\ 297,\\ 294,\\ 291,\\ 288,\\ 285\\,]\\ \\mathrm{K}$，\n  - $q = [\\,0.008,\\ 0.009,\\ 0.010,\\ 0.011,\\ 0.012,\\ 0.013\\,]\\ \\mathrm{kg}\\,\\mathrm{kg}^{-1}$，\n  - $p = [\\,100000,\\ 93941.306,\\ 88249.690,\\ 82902.912,\\ 77880.078,\\ 73161.563\\,]\\ \\mathrm{Pa}$，\n  - $\\Gamma = 0.006\\ \\mathrm{K}\\,\\mathrm{m}^{-1}$。\n- 案例3（双层薄气柱，强不稳定）：\n  - $z = [\\,0,\\ 100\\,]\\ \\mathrm{m}$，\n  - $T = [\\,300,\\ 295\\,]\\ \\mathrm{K}$，\n  - $q = [\\,0.02,\\ 0.02\\,]\\ \\mathrm{kg}\\,\\mathrm{kg}^{-1}$，\n  - $p = [\\,100000,\\ 98757.859\\,]\\ \\mathrm{Pa}$（来自 $p(z) = 100000 \\exp(-z/8000)$），\n  - $\\Gamma = 0.0098\\ \\mathrm{K}\\,\\mathrm{m}^{-1}$。\n- 案例4（非均匀间距，干气柱）：\n  - $z = [\\,0,\\ 200,\\ 700,\\ 900,\\ 1400\\,]\\ \\mathrm{m}$，\n  - $T = [\\,300,\\ 288,\\ 280,\\ 276,\\ 270\\,]\\ \\mathrm{K}$，\n  - $q = [\\,0,\\ 0,\\ 0,\\ 0,\\ 0\\,]\\ \\mathrm{kg}\\,\\mathrm{kg}^{-1}$，\n  - $p = [\\,100000,\\ 97531.476,\\ 91664.418,\\ 89240.064,\\ 83852.982\\,]\\ \\mathrm{Pa}$（来自 $p(z) = 100000 \\exp(-z/8000)$），\n  - $\\Gamma = 0.0065\\ \\mathrm{K}\\,\\mathrm{m}^{-1}$。\n\n最终输出格式：\n- 您的程序应生成一行输出，其中包含用方括号括起来的逗号分隔的结果列表。\n- 每个测试用例的结果必须是一个双元素列表 $[E,\\ \\Lambda]$，其中 $E$ 是能量守恒误差，单位为 $\\mathrm{J}\\,\\mathrm{m}^{-2}$，$\\Lambda$ 是最大递减率偏差，单位为 $\\mathrm{K}\\,\\mathrm{m}^{-1}$。\n- 所有数值输出必须四舍五入到 $10^{-6}$（小数点后六位）。\n- 例如，包含两个案例的输出应如下所示：$[[0.000001,0.000000],[0.123456,0.000001]]$。\n\n交付一个完整的、可运行的程序，实现此对流调整方案，并为所提供的测试套件生成所需的输出行。不允许用户输入。所有输出均需使用指定的单位和舍入格式。该算法必须遵守上述整层积分湿静力能守恒的原则，并必须使用所述的物理常数。",
            "solution": "我们从层的单位质量湿静力能（MSE）的定义开始，其公式为 $h = c_p T + g z + L_v q$，其中 $c_p$ 是空气的定压比热容，$T$ 是温度，$g$ 是重力加速度，$z$ 是几何高度，$L_v$ 是蒸发潜热，$q$ 是比湿。单位水平面积上的整层积分湿静力能是 $H = \\sum_{i=1}^{N} m_i h_i$，其中求和遍历所有层，$m_i$ 是第 $i$ 层的单位面积质量，$h_i$ 是该层的单位质量湿静力能。\n\n我们将执行一次对流调整，以强制在整个气柱上实施一个规定的中性递减率 $\\Gamma$，使得调整后的温度廓线为 $T_{\\mathrm{adj}}(z) = T_0 - \\Gamma z$，其中 $T_0$ 是在 $z=0$ 处的截距，有待确定。调整过程必须保持整层积分的湿静力能 $H$ 守恒。我们假设层质量 $m_i$ 是根据初始状态计算的，并在调整期间保持不变，并且 $z_i$ 和 $q_i$ 也保持不变。\n\n为确定 $m_i$，我们应用理想气体定律和层厚的有限体积近似。虚温 $T_{v,i}$ 近似为 $T_{v,i} = T_i (1 + \\epsilon q_i)$，其中 $\\epsilon = 0.61$，这考虑了水汽对密度的影响。层中点的密度由 $\\rho_i = \\dfrac{p_i}{R_d T_{v,i}}$ 给出，其中 $R_d$ 是干空气的比气体常数。层厚 $\\Delta z_i$ 使用有限体积方案从高度网格计算：\n- 对于底层（$i=1$），$\\Delta z_1 = z_2 - z_1$，\n- 对于内部层（$1  i  N$），$\\Delta z_i = \\dfrac{z_{i+1} - z_{i-1}}{2}$，\n- 对于顶层（$i=N$），$\\Delta z_N = z_N - z_{N-1}$。\n然后，每层的单位面积质量为 $m_i = \\rho_i \\Delta z_i$。\n\n初始的整层积分湿静力能是\n$$\nH = \\sum_{i=1}^{N} m_i \\left( c_p T_i + g z_i + L_v q_i \\right).\n$$\n在调整后的温度廓线 $T_{\\mathrm{adj}}(z_i) = T_0 - \\Gamma z_i$ 下，且 $q_i$ 和 $z_i$ 固定的情况下，调整后的整层积分湿静力能是\n$$\nH_{\\mathrm{adj}} = \\sum_{i=1}^{N} m_i \\left( c_p (T_0 - \\Gamma z_i) + g z_i + L_v q_i \\right)\n= c_p T_0 \\sum_{i=1}^{N} m_i - c_p \\Gamma \\sum_{i=1}^{N} m_i z_i + g \\sum_{i=1}^{N} m_i z_i + L_v \\sum_{i=1}^{N} m_i q_i.\n$$\n施加能量守恒条件 $H_{\\mathrm{adj}} = H$ 并求解 $T_0$，我们得到\n$$\nc_p T_0 \\sum_{i=1}^{N} m_i = H - g \\sum_{i=1}^{N} m_i z_i - L_v \\sum_{i=1}^{N} m_i q_i + c_p \\Gamma \\sum_{i=1}^{N} m_i z_i,\n$$\n由此得出\n$$\nT_0 = \\frac{H - g \\sum_{i=1}^{N} m_i z_i - L_v \\sum_{i=1}^{N} m_i q_i + c_p \\Gamma \\sum_{i=1}^{N} m_i z_i}{c_p \\sum_{i=1}^{N} m_i}.\n$$\n该表达式确保，一旦计算出 $T_0$，调整后的温度廓线 $T_{\\mathrm{adj},i} = T_0 - \\Gamma z_i$ 将保持整层积分的湿静力能 $H$ 守恒。\n\n然后我们计算诊断量：\n- 能量守恒误差\n$$\nE = \\left| H_{\\mathrm{adj}} - H \\right|,\n$$\n该值应接近 $0$（在数值浮点舍入误差范围内）。\n- 最大递减率偏差 $\\Lambda$，由相邻层之间的离散差分定义\n$$\n\\Lambda = \\max_{i=1,\\dots,N-1} \\left| \\frac{T_{\\mathrm{adj},i+1} - T_{\\mathrm{adj},i}}{z_{i+1} - z_i} + \\Gamma \\right|,\n$$\n因为精确的调整后线性廓线满足 $\\dfrac{\\mathrm{d}T}{\\mathrm{d}z} = -\\Gamma$，因此离散斜率应等于 $-\\Gamma$，偏差仅由数值舍入产生。\n\n算法步骤：\n1. 对每个测试用例，读取数组 $z_i$、$T_i$、$q_i$、$p_i$ 和规定的 $\\Gamma$。\n2. 使用有限体积方案计算 $T_{v,i} = T_i (1 + \\epsilon q_i)$、密度 $\\rho_i = \\dfrac{p_i}{R_d T_{v,i}}$ 和层厚 $\\Delta z_i$，然后计算 $m_i = \\rho_i \\Delta z_i$。\n3. 构建 $H = \\sum_i m_i (c_p T_i + g z_i + L_v q_i)$、$S_m = \\sum_i m_i$、$S_{mz} = \\sum_i m_i z_i$ 和 $S_{mq} = \\sum_i m_i q_i$。\n4. 通过以下公式计算 $T_0$：\n$$\nT_0 = \\frac{H - g S_{mz} - L_v S_{mq} + c_p \\Gamma S_{mz}}{c_p S_m}.\n$$\n5. 计算 $T_{\\mathrm{adj},i} = T_0 - \\Gamma z_i$，然后将 $T_{\\mathrm{adj},i}$ 代入 MSE 表达式，并使用固定的 $m_i$、$z_i$ 和 $q_i$ 来计算 $H_{\\mathrm{adj}}$。\n6. 根据离散斜率计算 $E = |H_{\\mathrm{adj}} - H|$ 和 $\\Lambda$。\n7. 将每个测试用例的输出四舍五入到 $10^{-6}$，并以 $[E,\\ \\Lambda]$ 的形式返回。\n\n此过程在科学上基于对流调整方案的湿静力能守恒，并使用理想气体定律进行质量加权。规定的中性递减率 $\\Gamma$ 通过构建调整后的线性温度廓线来确定性地强制执行，而截距 $T_0$ 的选择是为了在给定的固定层质量和湿度下精确地保持整层积分的湿静力能守恒。\n\n该程序为提供的四个测试用例实现了这些步骤，并打印一行包含每个用例的双元素列表 $[E,\\ \\Lambda]$ 的列表，结果四舍五入到小数点后六位，格式完全符合规定。",
            "answer": "```python\n# Python 3.12 program implementing column convective adjustment with MSE conservation\n# Allowed libraries: numpy (1.23.5), scipy (1.11.4) [scipy not used]\nimport numpy as np\n\n# Physical constants\nCP = 1004.0           # J/(kg K)\nG = 9.81              # m/s^2\nLV = 2.5e6            # J/kg\nRD = 287.0            # J/(kg K)\nEPS = 0.61            # dimensionless\n\ndef layer_thicknesses(z):\n    \"\"\"\n    Compute finite-volume layer thicknesses for midpoint heights z.\n    z: array of shape (N,)\n    Returns dz: array of shape (N,)\n    \"\"\"\n    z = np.asarray(z, dtype=float)\n    N = z.size\n    dz = np.empty(N, dtype=float)\n    if N == 1:\n        dz[0] = 0.0\n        return dz\n    dz[0] = z[1] - z[0]\n    for i in range(1, N-1):\n        dz[i] = 0.5 * (z[i+1] - z[i-1])\n    dz[-1] = z[-1] - z[-2]\n    return dz\n\ndef compute_masses(z, T, q, p):\n    \"\"\"\n    Compute layer masses per unit area m_i = rho_i * dz_i\n    using rho_i = p_i / (RD * T_v_i), T_v_i = T_i * (1 + EPS * q_i).\n    \"\"\"\n    z = np.asarray(z, dtype=float)\n    T = np.asarray(T, dtype=float)\n    q = np.asarray(q, dtype=float)\n    p = np.asarray(p, dtype=float)\n    Tv = T * (1.0 + EPS * q)\n    rho = p / (RD * Tv)\n    dz = layer_thicknesses(z)\n    m = rho * dz\n    return m, dz\n\ndef convective_adjustment_mse(z, T, q, p, Gamma):\n    \"\"\"\n    Perform convective adjustment to neutral lapse rate Gamma\n    while conserving column-integrated MSE.\n    Returns adjusted temperatures, T0, energy error E, max lapse deviation Lambda.\n    \"\"\"\n    z = np.asarray(z, dtype=float)\n    T = np.asarray(T, dtype=float)\n    q = np.asarray(q, dtype=float)\n    p = np.asarray(p, dtype=float)\n    # Masses based on initial state\n    m, dz = compute_masses(z, T, q, p)\n\n    # Compute initial column-integrated MSE\n    h_initial = CP * T + G * z + LV * q\n    H = np.sum(m * h_initial)\n\n    # Sums needed for T0\n    S_m = np.sum(m)\n    S_mz = np.sum(m * z)\n    S_mq = np.sum(m * q)\n\n    # Compute T0 from MSE conservation\n    T0 = (H - G * S_mz - LV * S_mq + CP * Gamma * S_mz) / (CP * S_m)\n\n    # Adjusted temperatures\n    T_adj = T0 - Gamma * z\n\n    # Compute adjusted column-integrated MSE to verify conservation\n    h_adj = CP * T_adj + G * z + LV * q\n    H_adj = np.sum(m * h_adj)\n\n    # Energy conservation error\n    E = abs(H_adj - H)\n\n    # Discrete lapse deviations\n    if z.size >= 2:\n        slopes = (T_adj[1:] - T_adj[:-1]) / (z[1:] - z[:-1])\n        # Target slope is -Gamma; deviation is slopes + Gamma\n        deviations = np.abs(slopes + Gamma)\n        Lambda = float(np.max(deviations))\n    else:\n        Lambda = 0.0\n\n    return T_adj, T0, E, Lambda\n\ndef format_results(results):\n    \"\"\"\n    Format results as a single-line string:\n    [[E1,Lambda1],[E2,Lambda2],...]\n    with each float rounded to 6 decimal places.\n    \"\"\"\n    def fmt_float(x):\n        return f\"{x:.6f}\"\n    inner = []\n    for (E, Lambda) in results:\n        inner.append(f\"[{fmt_float(E)},{fmt_float(Lambda)}]\")\n    return f\"[{','.join(inner)}]\"\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1\n        {\n            \"z\": [0.0, 500.0, 1000.0, 1500.0, 2000.0, 2500.0],\n            \"T\": [300.0, 296.0, 291.0, 285.0, 278.0, 270.0],\n            \"q\": [0.01, 0.01, 0.01, 0.01, 0.01, 0.01],\n            \"p\": [100000.0, 93941.306, 88249.690, 82902.912, 77880.078, 73161.563],\n            \"Gamma\": 0.006\n        },\n        # Case 2\n        {\n            \"z\": [0.0, 500.0, 1000.0, 1500.0, 2000.0, 2500.0],\n            \"T\": [300.0, 297.0, 294.0, 291.0, 288.0, 285.0],\n            \"q\": [0.008, 0.009, 0.010, 0.011, 0.012, 0.013],\n            \"p\": [100000.0, 93941.306, 88249.690, 82902.912, 77880.078, 73161.563],\n            \"Gamma\": 0.006\n        },\n        # Case 3\n        {\n            \"z\": [0.0, 100.0],\n            \"T\": [300.0, 295.0],\n            \"q\": [0.02, 0.02],\n            \"p\": [100000.0, 98757.859],\n            \"Gamma\": 0.0098\n        },\n        # Case 4\n        {\n            \"z\": [0.0, 200.0, 700.0, 900.0, 1400.0],\n            \"T\": [300.0, 288.0, 280.0, 276.0, 270.0],\n            \"q\": [0.0, 0.0, 0.0, 0.0, 0.0],\n            \"p\": [100000.0, 97531.476, 91664.418, 89240.064, 83852.982],\n            \"Gamma\": 0.0065\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        z = case[\"z\"]\n        T = case[\"T\"]\n        q = case[\"q\"]\n        p = case[\"p\"]\n        Gamma = case[\"Gamma\"]\n        T_adj, T0, E, Lambda = convective_adjustment_mse(z, T, q, p, Gamma)\n        results.append((E, Lambda))\n\n    # Final print statement in the exact required format.\n    print(format_results(results))\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "在实现参数化方案后，确保其数值行为的稳健性至关重要，因为离散化的数值算法有时会产生非物理的结果，例如负值的比湿或本应稳定的廓线出现新的不稳定。本实践将引导您分析一个给定的调整方案，从数学上推导出保证其输出结果满足物理约束（如示踪物质量的正定性和稳定廓线的单调性）的条件。 这项练习将帮助您理解“限制器”（limiter）在真实模型中的作用和设计方法，是您从理论构建到开发稳健、可靠的数值模型的关键一步。",
            "id": "4026288",
            "problem": "在数值天气预报和气候模拟的背景下，考虑一个具有 $K=4$ 个等距垂直层级的单柱对流调整步骤。推进两个预报标量：位温 $\\theta$ 和比湿 $q$。设调整前的廓线由下式给出\n$$\n\\theta^{n} = \\begin{pmatrix} 300 \\\\ 298 \\\\ 297 \\\\ 301 \\end{pmatrix} \\ \\text{K}, \\qquad\nq^{n} = \\begin{pmatrix} 0.012 \\\\ 0.010 \\\\ 0.002 \\\\ 0.001 \\end{pmatrix} \\ \\text{kg}\\,\\text{kg}^{-1}.\n$$\n单个隐式调整时间步被建模为向线性目标的凸松弛，其参数为 $\\lambda \\in [0,1]$，可能伴随着一个表示对流过程中降水形成的参数化汇。具体来说，更新公式为\n$$\n\\theta^{n+1} = (1-\\lambda)\\,\\theta^{n} + \\lambda\\,B\\,\\theta^{n},\n$$\n$$\nq^{n+1} = (1-\\lambda)\\,q^{n} + \\lambda\\,(C\\,q^{n} - \\varepsilon\\,r),\n$$\n其中，$B$ 是一个线性算子，它将最底部的三个层级均匀化，同时保持顶层不变；$C$ 是单位算子；$r$ 是一个非负的汇廓线；$\\varepsilon \\in [0,1]$ 用于缩放汇以保持非负性。具体而言，$B$ 的定义如下\n$$\n(B\\,\\theta)_{i} = m \\ \\text{for} \\ i=1,2,3, \\quad (B\\,\\theta)_{4} = \\theta_{4}, \\quad m \\equiv \\frac{\\theta_{1} + \\theta_{2} + \\theta_{3}}{3},\n$$\n且 $C$ 是单位算子，而\n$$\nr = \\begin{pmatrix} 0 \\\\ 0 \\\\ 0.003 \\\\ 0 \\end{pmatrix} \\ \\text{kg}\\,\\text{kg}^{-1}.\n$$\n将 $\\theta^{n+1}$ 的离散单调性诊断定义为以下三个不等式集合\n$$\n\\theta^{n+1}_{i+1} - \\theta^{n+1}_{i} \\ge 0, \\quad i=1,2,3,\n$$\n将 $q^{n+1}$ 的正性诊断定义为以下分量不等式\n$$\nq^{n+1}_{i} \\ge 0, \\quad i=1,2,3,4.\n$$\n从这些定义和给定的更新公式出发，推导由 $\\theta^{n+1}$ 的单调性诊断施加于 $\\lambda$ 的约束，并确定强制实现离散单调性的选择 $\\lambda_{\\text{mon}}$。然后，在 $\\lambda=\\lambda_{\\text{mon}}$ 时，确定保证 $q^{n+1}$ 的正性诊断分量成立的最小汇缩放因子 $\\varepsilon^{\\star} \\in [0,1]$。清晰地陈述 $\\varepsilon^{\\star}$ 的最终值。将最终答案表示为精确分数。无需四舍五入。最终答案必须是单个不带单位的数字。",
            "solution": "首先根据指定标准对问题进行验证。\n\n### 第1步：提取已知条件\n- 垂直层级数：$K=4$。\n- 预报标量：位温 $\\theta$ 和比湿 $q$。\n- 调整前廓线：\n$$\n\\theta^{n} = \\begin{pmatrix} 300 \\\\ 298 \\\\ 297 \\\\ 301 \\end{pmatrix} \\ \\text{K}, \\qquad\nq^{n} = \\begin{pmatrix} 0.012 \\\\ 0.010 \\\\ 0.002 \\\\ 0.001 \\end{pmatrix} \\ \\text{kg}\\,\\text{kg}^{-1}.\n$$\n- 单个隐式调整时间步的更新方程：\n$$\n\\theta^{n+1} = (1-\\lambda)\\,\\theta^{n} + \\lambda\\,B\\,\\theta^{n} \\\\\nq^{n+1} = (1-\\lambda)\\,q^{n} + \\lambda\\,(C\\,q^{n} - \\varepsilon\\,r)\n$$\n- 松弛参数：$\\lambda \\in [0,1]$。\n- 算子 $B$：对于 $i=1,2,3$，$(B\\,\\theta)_{i} = m$，对于 $i=4$，$(B\\,\\theta)_{4} = \\theta_{4}$，其中 $m \\equiv \\frac{\\theta_{1} + \\theta_{2} + \\theta_{3}}{3}$。\n- 算子 $C$：单位算子。\n- 汇廓线：$r = \\begin{pmatrix} 0 \\\\ 0 \\\\ 0.003 \\\\ 0 \\end{pmatrix} \\ \\text{kg}\\,\\text{kg}^{-1}$。\n- 汇缩放参数：$\\varepsilon \\in [0,1]$。\n- $\\theta^{n+1}$ 的单调性诊断：对于 $i=1,2,3$，$\\theta^{n+1}_{i+1} - \\theta^{n+1}_{i} \\ge 0$。\n- $q^{n+1}$ 的正性诊断：对于 $i=1,2,3,4$， $q^{n+1}_{i} \\ge 0$。\n- 目标：推导对 $\\lambda$ 的约束并求出 $\\lambda_{\\text{mon}}$。然后，在 $\\lambda=\\lambda_{\\text{mon}}$ 时，求出确保 $q^{n+1}$ 正性的最小汇缩放因子 $\\varepsilon^{\\star}$。\n\n### 第2步：使用提取的已知条件进行验证\n该问题具有科学依据，是适定且客观的。它描述了一种在大气模拟中使用的简化但标准的对流调整方案。所有参数和算子都已明确定义，目标具体且可量化。数据值在物理上是合理的。该问题是将已定义的约束应用于数值算法的形式化练习，这是在指定领域中的常见任务。未发现任何缺陷。\n\n### 第3步：结论与行动\n问题有效。将提供解答。\n\n### 解题推导\n\n解题过程分为两个主要部分：首先，确定强制实现单调性的松弛参数 $\\lambda_{\\text{mon}}$；其次，在该 $\\lambda$ 值下，确定保持正性的汇缩放参数 $\\varepsilon^{\\star}$。\n\n**第1部分：确定 $\\lambda_{\\text{mon}}$**\n\n位温 $\\theta$ 的更新方程由下式给出\n$$\n\\theta^{n+1} = (1-\\lambda)\\,\\theta^{n} + \\lambda\\,B\\,\\theta^{n}\n$$\n首先，我们使用给定的初始廓线 $\\theta^{n}$ 计算目标廓线 $B\\,\\theta^{n}$。\n$\\theta^{n}$ 的分量为 $\\theta^{n}_{1} = 300$，$\\theta^{n}_{2} = 298$，$\\theta^{n}_{3} = 297$ 和 $\\theta^{n}_{4} = 301$。\n最底部三层的平均值 $m$ 为：\n$$\nm = \\frac{\\theta^{n}_{1} + \\theta^{n}_{2} + \\theta^{n}_{3}}{3} = \\frac{300 + 298 + 297}{3} = \\frac{895}{3}\n$$\n算子 $B$ 将这三层均匀化为 $m$ 并保持顶层不变。因此，\n$$\nB\\,\\theta^{n} = \\begin{pmatrix} 895/3 \\\\ 895/3 \\\\ 895/3 \\\\ 301 \\end{pmatrix}\n$$\n现在我们可以用 $\\lambda$ 表示更新后廓线 $\\theta^{n+1}$ 的各分量：\n$$\n\\theta^{n+1}_{1} = (1-\\lambda)\\theta^{n}_{1} + \\lambda m = (1-\\lambda)(300) + \\lambda\\frac{895}{3} = 300 - 300\\lambda + \\frac{895}{3}\\lambda = 300 + \\frac{895-900}{3}\\lambda = 300 - \\frac{5}{3}\\lambda\n$$\n$$\n\\theta^{n+1}_{2} = (1-\\lambda)\\theta^{n}_{2} + \\lambda m = (1-\\lambda)(298) + \\lambda\\frac{895}{3} = 298 - 298\\lambda + \\frac{895}{3}\\lambda = 298 + \\frac{895-894}{3}\\lambda = 298 + \\frac{1}{3}\\lambda\n$$\n$$\n\\theta^{n+1}_{3} = (1-\\lambda)\\theta^{n}_{3} + \\lambda m = (1-\\lambda)(297) + \\lambda\\frac{895}{3} = 297 - 297\\lambda + \\frac{895}{3}\\lambda = 297 + \\frac{895-891}{3}\\lambda = 297 + \\frac{4}{3}\\lambda\n$$\n$$\n\\theta^{n+1}_{4} = (1-\\lambda)\\theta^{n}_{4} + \\lambda \\theta^{n}_{4} = \\theta^{n}_{4} = 301\n$$\n接下来，我们应用离散单调性诊断，要求对于 $i=1,2,3$，$\\theta^{n+1}_{i+1} - \\theta^{n+1}_{i} \\ge 0$。\n\n对于 $i=1$:\n$$\n\\theta^{n+1}_{2} - \\theta^{n+1}_{1} \\ge 0 \\\\\n\\left(298 + \\frac{1}{3}\\lambda\\right) - \\left(300 - \\frac{5}{3}\\lambda\\right) \\ge 0 \\\\\n-2 + \\frac{6}{3}\\lambda \\ge 0 \\\\\n-2 + 2\\lambda \\ge 0 \\implies \\lambda \\ge 1\n$$\n对于 $i=2$:\n$$\n\\theta^{n+1}_{3} - \\theta^{n+1}_{2} \\ge 0 \\\\\n\\left(297 + \\frac{4}{3}\\lambda\\right) - \\left(298 + \\frac{1}{3}\\lambda\\right) \\ge 0 \\\\\n-1 + \\frac{3}{3}\\lambda \\ge 0 \\\\\n-1 + \\lambda \\ge 0 \\implies \\lambda \\ge 1\n$$\n对于 $i=3$:\n$$\n\\theta^{n+1}_{4} - \\theta^{n+1}_{3} \\ge 0 \\\\\n301 - \\left(297 + \\frac{4}{3}\\lambda\\right) \\ge 0 \\\\\n4 - \\frac{4}{3}\\lambda \\ge 0 \\implies 4 \\ge \\frac{4}{3}\\lambda \\implies 3 \\ge \\lambda \\implies \\lambda \\le 3\n$$\n为满足所有三个单调性条件，$\\lambda$ 必须在区间 $[1, 3]$ 内。然而，问题陈述将松弛参数约束在 $\\lambda \\in [0,1]$。这两个约束的交集 $[1,3] \\cap [0,1]$ 只包含一个点：$\\lambda=1$。因此，在允许范围内强制实现离散单调性的唯一选择是 $\\lambda_{\\text{mon}} = 1$。\n\n**第2部分：确定 $\\varepsilon^{\\star}$**\n\n比湿 $q$ 的更新方程为\n$$\nq^{n+1} = (1-\\lambda)\\,q^{n} + \\lambda\\,(C\\,q^{n} - \\varepsilon\\,r)\n$$\n由于 $C$ 是单位算子，该式简化为：\n$$\nq^{n+1} = (1-\\lambda)\\,q^{n} + \\lambda\\,(q^{n} - \\varepsilon\\,r) = (1-\\lambda+\\lambda)q^n - \\lambda\\varepsilon r = q^n - \\lambda\\varepsilon r\n$$\n我们现在必须在 $\\lambda = \\lambda_{\\text{mon}} = 1$ 时计算此方程：\n$$\nq^{n+1} = q^n - \\varepsilon r\n$$\n 代入给定的向量 $q^n$ 和 $r$：\n$$\nq^{n+1} = \\begin{pmatrix} 0.012 \\\\ 0.010 \\\\ 0.002 \\\\ 0.001 \\end{pmatrix} - \\varepsilon \\begin{pmatrix} 0 \\\\ 0 \\\\ 0.003 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} 0.012 \\\\ 0.010 \\\\ 0.002 - 0.003\\varepsilon \\\\ 0.001 \\end{pmatrix}\n$$\n正性诊断要求所有分量 $i=1,2,3,4$ 均满足 $q^{n+1}_{i} \\ge 0$。\n对于 $i=1$：$q^{n+1}_{1} = 0.012 \\ge 0$，此条件始终满足。\n对于 $i=2$：$q^{n+1}_{2} = 0.010 \\ge 0$，此条件始终满足。\n对于 $i=4$：$q^{n+1}_{4} = 0.001 \\ge 0$，此条件始终满足。\n对于 $i=3$，条件是非平凡的：\n$$\nq^{n+1}_{3} = 0.002 - 0.003\\varepsilon \\ge 0\n$$\n解出 $\\varepsilon$：\n$$\n0.002 \\ge 0.003\\varepsilon \\implies \\varepsilon \\le \\frac{0.002}{0.003} = \\frac{2}{3}\n$$\n我们还已知 $\\varepsilon \\in [0,1]$。结合这些约束，保证正性的 $\\varepsilon$ 的取值范围是 $0 \\le \\varepsilon \\le \\frac{2}{3}$。\n\n问题的措辞“确定保证...正性诊断...成立的最小汇缩放因子 $\\varepsilon^{\\star}$” 在字面上可能引起歧义。然而，在数值限制器（limiter）的语境中，目标通常是找到允许的最大值，因为它代表了对物理过程（此处为降水汇）的最小必要修正以维持物理约束（正定性）。无约束的物理模型对应于 $\\varepsilon = 1$。为了满足 $q^{n+1} \\ge 0$，必须将 $\\varepsilon$ 限制在 $\\frac{2}{3}$ 或更小。选择 $\\varepsilon^{\\star} = \\frac{2}{3}$ 意味着我们应用了尽可能强的汇项，同时恰好满足了正性约束。因此，这是符合上下文的最佳解释。\n\n因此，$\\varepsilon^{\\star} = \\frac{2}{3}$。",
            "answer": "$$\\boxed{\\frac{2}{3}}$$"
        }
    ]
}