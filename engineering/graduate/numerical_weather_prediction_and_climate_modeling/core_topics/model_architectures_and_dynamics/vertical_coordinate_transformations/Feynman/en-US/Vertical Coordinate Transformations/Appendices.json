{
    "hands_on_practices": [
        {
            "introduction": "This problem deals with the fundamental geometry of terrain-following coordinates. When we transform our governing equations into a coordinate system that follows the topography, new mathematical terms known as \"metric coefficients\" appear. This exercise  provides foundational practice in deriving such a term, $\\frac{\\partial z}{\\partial x}\\big|_{\\sigma}$, and analyzing its behavior, which is a critical prerequisite for understanding more complex numerical issues like the pressure-gradient error.",
            "id": "4109517",
            "problem": "A terrain-following vertical coordinate is often used in numerical weather prediction and climate modeling to alleviate pressure-gradient errors over complex topography. Consider a two-dimensional domain in the horizontal coordinate $x$ and a height-based terrain-following vertical coordinate $\\sigma$ defined by the mapping $z(x,\\sigma) = h(x) + \\sigma \\left(H - h(x)\\right)$, where $z$ is the geometric height, $H$ is a constant domain top, and $h(x)$ is the bottom topography. Let the bottom topography be a smooth, localized Gaussian ridge given by $h(x) = h_{0} \\exp\\left(-\\left(\\frac{x}{L}\\right)^{2}\\right)$, where $h_{0} > 0$ is the ridge amplitude and $L > 0$ is the half-width scale. Assume $H > h_{0}$ so that the mapping is monotone and $\\sigma \\in [0,1]$ with $\\sigma = 0$ at the surface and $\\sigma = 1$ at the top. In the transformation of the hydrostatic primitive equations (HPE), the horizontal metric coupling term that connects horizontal gradients along terrain-following surfaces to geometric-height gradients involves the Jacobian factor $\\frac{\\partial z}{\\partial x}\\big|_{\\sigma}$.\n\nStarting from the chain rule and the provided mapping, derive an explicit closed-form expression for the metric coefficient $\\frac{\\partial z}{\\partial x}\\big|_{\\sigma}$ in terms of $x$, $\\sigma$, $h_{0}$, and $L$. Then, determine the values of $x$ and $\\sigma$ at which the magnitude $\\left|\\frac{\\partial z}{\\partial x}\\big|_{\\sigma}\\right|$ attains its global maximum over $x \\in \\mathbb{R}$ and $\\sigma \\in [0,1]$, and provide the corresponding maximum magnitude in closed form. Your final answer must be a single composite analytical expression containing:\n- The expression for $\\frac{\\partial z}{\\partial x}\\big|_{\\sigma}$,\n- The $x$-locations where the global maximum occurs,\n- The $\\sigma$-location where the global maximum occurs,\n- The global maximum magnitude $\\max_{x,\\sigma} \\left|\\frac{\\partial z}{\\partial x}\\big|_{\\sigma}\\right|$.\n\nNo numerical approximation is required; express your final result exactly. If you make any auxiliary assumptions, state and justify them clearly using fundamental laws or well-tested formulas and facts, such as the chain rule for multivariate functions and standard differentiation rules for exponentials.",
            "solution": "The problem requires a four-part answer: the expression for the metric coefficient $\\frac{\\partial z}{\\partial x}\\big|_{\\sigma}$, the coordinates $(x, \\sigma)$ at which its magnitude is maximized, and the value of that maximum magnitude.\n\n**Part 1: Expression for the Metric Coefficient**\n\nThe vertical coordinate transformation is given by $z(x,\\sigma) = h(x) + \\sigma \\left(H - h(x)\\right)$. We can rewrite this by factoring out $h(x)$:\n$$ z(x,\\sigma) = (1-\\sigma)h(x) + \\sigma H $$\nThe metric coefficient is the partial derivative of $z$ with respect to $x$, holding $\\sigma$ constant. Using the sum and constant multiple rules for differentiation:\n$$ \\frac{\\partial z}{\\partial x}\\bigg|_{\\sigma} = \\frac{\\partial}{\\partial x} \\left[ (1-\\sigma)h(x) + \\sigma H \\right] $$\nSince $\\sigma$ and $H$ are treated as constants for this partial derivative, we have:\n$$ \\frac{\\partial z}{\\partial x}\\bigg|_{\\sigma} = (1-\\sigma)\\frac{dh}{dx} + 0 = (1-\\sigma)\\frac{dh}{dx} $$\nNext, we must find the derivative of the topography function, $h(x) = h_{0} \\exp\\left(-\\left(\\frac{x}{L}\\right)^{2}\\right)$. Using the chain rule:\n$$ \\frac{dh}{dx} = h_{0} \\cdot \\frac{d}{dx} \\left[ \\exp\\left(-\\frac{x^2}{L^2}\\right) \\right] $$\n$$ \\frac{dh}{dx} = h_{0} \\cdot \\exp\\left(-\\frac{x^2}{L^2}\\right) \\cdot \\frac{d}{dx}\\left(-\\frac{x^2}{L^2}\\right) $$\n$$ \\frac{dh}{dx} = h_{0} \\cdot \\exp\\left(-\\frac{x^2}{L^2}\\right) \\cdot \\left(-\\frac{2x}{L^2}\\right) = -\\frac{2h_0 x}{L^2} \\exp\\left(-\\frac{x^2}{L^2}\\right) $$\nSubstituting this expression for $\\frac{dh}{dx}$ back into the equation for the metric coefficient:\n$$ \\frac{\\partial z}{\\partial x}\\bigg|_{\\sigma} = (1-\\sigma) \\left( -\\frac{2h_0 x}{L^2} \\exp\\left(-\\left(\\frac{x}{L}\\right)^{2}\\right) \\right) $$\n$$ \\frac{\\partial z}{\\partial x}\\bigg|_{\\sigma} = -(1-\\sigma) \\frac{2h_0 x}{L^2} \\exp\\left(-\\left(\\frac{x}{L}\\right)^{2}\\right) $$\nThis is the first required expression.\n\n**Part 2: Maximization of the Magnitude**\n\nWe need to find the global maximum of the magnitude of this coefficient, $F(x, \\sigma) = \\left|\\frac{\\partial z}{\\partial x}\\big|_{\\sigma}\\right|$, over the domain $x \\in \\mathbb{R}$ and $\\sigma \\in [0,1]$.\n$$ F(x, \\sigma) = \\left| -(1-\\sigma) \\frac{2h_0 x}{L^2} \\exp\\left(-\\left(\\frac{x}{L}\\right)^{2}\\right) \\right| $$\nSince $h_0 > 0$, $L > 0$, and $\\sigma \\in [0,1]$ implies $(1-\\sigma) \\ge 0$, we can simplify the absolute value:\n$$ F(x, \\sigma) = (1-\\sigma) \\frac{2h_0}{L^2} |x| \\exp\\left(-\\left(\\frac{x}{L}\\right)^{2}\\right) $$\nThe function $F(x, \\sigma)$ is a product of a function of $\\sigma$ and a function of $x$. Since both are non-negative, we can maximize them independently.\n$$ F(x, \\sigma) = G(\\sigma) \\cdot K(x) $$\nwhere $G(\\sigma) = 1-\\sigma$ and $K(x) = \\frac{2h_0}{L^2} |x| \\exp\\left(-\\left(\\frac{x}{L}\\right)^{2}\\right)$.\n\n**Maximization with respect to $\\sigma$**:\nThe function $G(\\sigma) = 1-\\sigma$ is a linearly decreasing function on the interval $\\sigma \\in [0,1]$. Its maximum value occurs at the left endpoint of the interval, $\\sigma = 0$. At this point, $\\max G(\\sigma) = G(0) = 1$.\nSo, the maximum magnitude of the metric coefficient occurs on the surface, $\\sigma=0$.\n\n**Maximization with respect to $x$**:\nWe need to maximize $K(x) = \\frac{2h_0}{L^2} |x| \\exp\\left(-\\frac{x^2}{L^2}\\right)$. Since $K(x)$ is an even function of $x$, we can analyze it for $x \\ge 0$, where $|x|=x$, and the result at $-x$ will be the same. Let's find the maximum of $f(x) = x \\exp(-\\frac{x^2}{L^2})$ for $x \\ge 0$. The constant multiplicative factor $\\frac{2h_0}{L^2}$ does not affect the location of the maximum.\nWe find the critical points by setting the first derivative to zero:\n$$ \\frac{df}{dx} = \\frac{d}{dx}\\left[x \\exp\\left(-\\frac{x^2}{L^2}\\right)\\right] = 1 \\cdot \\exp\\left(-\\frac{x^2}{L^2}\\right) + x \\cdot \\exp\\left(-\\frac{x^2}{L^2}\\right) \\cdot \\left(-\\frac{2x}{L^2}\\right) $$\n$$ \\frac{df}{dx} = \\left(1 - \\frac{2x^2}{L^2}\\right) \\exp\\left(-\\frac{x^2}{L^2}\\right) $$\nSetting $\\frac{df}{dx} = 0$, and knowing that the exponential term is always positive, we require:\n$$ 1 - \\frac{2x^2}{L^2} = 0 \\implies x^2 = \\frac{L^2}{2} \\implies x = \\frac{L}{\\sqrt{2}} \\quad (\\text{since } x \\ge 0) $$\nThis is a local maximum because the first derivative is positive for $0  x  L/\\sqrt{2}$ and negative for $x > L/\\sqrt{2}$. Since $f(0)=0$ and $f(x) \\to 0$ as $x \\to \\infty$, this local maximum is the global maximum for $x \\ge 0$.\nDue to the even symmetry of $K(x)$, the global maxima occur at $x = \\pm \\frac{L}{\\sqrt{2}}$.\n\nThus, the global maximum of $F(x, \\sigma)$ occurs at $\\sigma = 0$ and $x = \\pm \\frac{L}{\\sqrt{2}}$.\n\n**Part 3: Value of the Maximum Magnitude**\n\nFinally, we calculate the maximum value by substituting these coordinates into the expression for $F(x, \\sigma)$:\n$$ \\max_{x,\\sigma} \\left|\\frac{\\partial z}{\\partial x}\\big|_{\\sigma}\\right| = F\\left(\\pm \\frac{L}{\\sqrt{2}}, 0\\right) $$\n$$ = (1-0) \\frac{2h_0}{L^2} \\left|\\pm\\frac{L}{\\sqrt{2}}\\right| \\exp\\left(-\\frac{(\\pm L/\\sqrt{2})^2}{L^2}\\right) $$\n$$ = (1) \\frac{2h_0}{L^2} \\frac{L}{\\sqrt{2}} \\exp\\left(-\\frac{L^2/2}{L^2}\\right) $$\n$$ = \\frac{2h_0 L}{\\sqrt{2} L^2} \\exp\\left(-\\frac{1}{2}\\right) = \\frac{\\sqrt{2} h_0}{L} \\exp\\left(-\\frac{1}{2}\\right) $$\nThis is the global maximum magnitude of the metric coefficient.",
            "answer": "$$ \\boxed{\\begin{pmatrix} -(1-\\sigma) \\frac{2 h_0 x}{L^2} \\exp\\left(-\\left(\\frac{x}{L}\\right)^{2}\\right)  \\pm \\frac{L}{\\sqrt{2}}  0  \\frac{h_0\\sqrt{2}}{L}\\exp\\left(-\\frac{1}{2}\\right) \\end{pmatrix}} $$"
        },
        {
            "introduction": "Building upon the analytical concept of metric terms, this practice delves into their numerical consequences. In the continuous equations, the horizontal pressure-gradient force in a resting, stratified atmosphere is perfectly balanced by a term involving the slope of the coordinate surface. This exercise  guides you through a classic numerical experiment to demonstrate how this delicate balance is broken by discretization, leading to a spurious \"pressure-gradient error\" that can generate artificial flow over mountains.",
            "id": "4109526",
            "problem": "Consider a two-dimensional, dry atmosphere in hydrostatic balance within the context of Numerical Weather Prediction (NWP) and climate modeling, using a terrain-following height-based vertical coordinate transformation. Let the physical vertical coordinate be $z$ and the transformed coordinate be $\\eta \\in [0,1]$. The terrain height is given by a spatially varying function $h(x)$, and the mapping between the transformed and physical vertical coordinates is defined as\n$$\nz(x,\\eta) = h(x) + \\eta\\left(H_{\\text{top}} - h(x)\\right) = \\eta H_{\\text{top}} + (1-\\eta) h(x),\n$$\nwhere $H_{\\text{top}}$ is the constant model top height. Assume a uniform virtual temperature $T_v$ so that the hydrostatic isothermal atmosphere satisfies the hydrostatic balance and the ideal gas law,\n$$\n\\frac{\\partial p}{\\partial z} = -\\rho g, \\quad \\rho = \\frac{p}{R_d T_v},\n$$\nwith $p(z) = p_0 \\exp\\left(-\\frac{z}{H}\\right)$ and scale height $H = \\frac{R_d T_v}{g}$, where $p_0$ is the reference pressure at $z=0$, $g$ is gravitational acceleration, and $R_d$ is the dry-air gas constant. In the continuous equations, the terrain-following formulation ensures exact cancellation of the horizontal pressure-gradient term and the corresponding metric term in the $x$-momentum equation in a horizontally homogeneous, isothermal atmosphere:\n$$\n-\\frac{1}{\\rho}\\left.\\frac{\\partial p}{\\partial x}\\right|_{\\eta} + g \\left.\\frac{\\partial z}{\\partial x}\\right|_{\\eta} = 0.\n$$\nHowever, when discretized with centered differences, this cancellation is imperfect and produces a spurious horizontal acceleration.\n\nYour task is to quantify the spurious horizontal acceleration produced by imperfect pressure-gradient cancellation when using centered differencing in $x$ for $\\nabla_h p$ on constant-$\\eta$ surfaces, for a sinusoidal terrain and a uniform virtual temperature $T_v$. Assume the following:\n\n- The domain is periodic in $x$ with length $L$.\n- The terrain height is $h(x) = h_0 \\sin\\left(\\frac{2\\pi x}{L}\\right)$.\n- The $x$ grid has $N$ uniformly spaced points with periodic boundary conditions and spacing $\\Delta x = \\frac{L}{N}$ at positions $x_i = i \\Delta x$, for $i = 0,1,\\dots,N-1$.\n- Use centered differencing to approximate horizontal derivatives at constant $\\eta$:\n$$\nD_x f_i = \\frac{f_{i+1} - f_{i-1}}{2\\Delta x},\n$$\nwith periodic indexing, i.e., $f_{-1} \\equiv f_{N-1}$ and $f_N \\equiv f_0$.\n- The spurious horizontal acceleration at grid point $i$ on a given $\\eta$ surface is defined as\n$$\na_i = -\\frac{1}{\\rho_i} D_x p_i + g \\, D_x z_i,\n$$\nwhere $p_i = p\\big(z(x_i,\\eta)\\big)$, $\\rho_i = \\frac{p_i}{R_d T_v}$, and $z_i = z(x_i,\\eta)$.\n\nYou must compute the maximum absolute value of the spurious acceleration over all $i$:\n$$\na_{\\max} = \\max_{i} |a_i|.\n$$\n\nUse the following constants and units:\n- $g = 9.80665$ m s$^{-2}$,\n- $R_d = 287$ J kg$^{-1}$ K$^{-1}$,\n- $p_0 = 10^5$ Pa,\n- $H_{\\text{top}} = 20000$ m.\nAll outputs must be expressed in meters per second squared (m s$^{-2}$) as floats in scientific notation with six significant digits.\n\nConstruct a program that computes $a_{\\max}$ for each of the following test cases:\n\n1. Happy path case: $h_0 = 1000$ m, $L = 50000$ m, $T_v = 300$ K, $\\eta = 0.5$, $N = 201$.\n2. Boundary case (flat terrain): $h_0 = 0$ m, $L = 50000$ m, $T_v = 300$ K, $\\eta = 0.5$, $N = 201$.\n3. Steeper terrain case: $h_0 = 1000$ m, $L = 10000$ m, $T_v = 300$ K, $\\eta = 0.5$, $N = 201$.\n4. Near-surface level: $h_0 = 1000$ m, $L = 50000$ m, $T_v = 300$ K, $\\eta = 0.1$, $N = 201$.\n5. Near-top level: $h_0 = 1000$ m, $L = 50000$ m, $T_v = 300$ K, $\\eta = 0.9$, $N = 201$.\n6. Coarse-grid resolution case: $h_0 = 1000$ m, $L = 50000$ m, $T_v = 300$ K, $\\eta = 0.5$, $N = 21$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,...]\"), where each result is the corresponding $a_{\\max}$ for the test case, formatted in scientific notation with six significant digits. All numerical values must be in m s$^{-2}$.",
            "solution": "The problem requires the quantification of spurious horizontal acceleration arising from the numerical discretization of the horizontal pressure gradient term in a terrain-following coordinate system. This is a classic problem in numerical weather prediction, where the pressure gradient force (PGF) is represented as two large terms that must analytically cancel but do so imperfectly in a discrete framework.\n\nThe physical vertical coordinate $z$ is transformed into a terrain-following coordinate $\\eta \\in [0,1]$ via the mapping:\n$$z(x,\\eta) = \\eta H_{\\text{top}} + (1-\\eta) h(x)$$\nwhere $h(x)$ is the terrain height, and $H_{\\text{top}}$ is the constant height of the model's top boundary.\n\nThe atmosphere is assumed to be dry, isothermal with a uniform virtual temperature $T_v$, and in hydrostatic balance. The pressure at a given height $z$ is given by:\n$$p(z) = p_0 \\exp\\left(-\\frac{z}{H}\\right)$$\nwhere $p_0$ is the reference pressure at $z=0$, and $H$ is the atmospheric scale height, defined as:\n$$H = \\frac{R_d T_v}{g}$$\nHere, $R_d$ is the gas constant for dry air and $g$ is the acceleration due to gravity. The density $\\rho$ is related to pressure and temperature by the ideal gas law, $\\rho = p / (R_d T_v)$.\n\nAnalytically, for an atmosphere at rest, the horizontal pressure gradient force on a constant-$\\eta$ surface is exactly balanced by a metric term arising from the coordinate transformation:\n$$-\\frac{1}{\\rho}\\left.\\frac{\\partial p}{\\partial x}\\right|_{\\eta} + g \\left.\\frac{\\partial z}{\\partial x}\\right|_{\\eta} = 0$$\nThis is because, by the chain rule, $\\left.\\frac{\\partial p}{\\partial x}\\right|_{\\eta} = \\frac{\\partial p}{\\partial z} \\left.\\frac{\\partial z}{\\partial x}\\right|_{\\eta}$. Given the hydrostatic relationship $\\frac{\\partial p}{\\partial z} = -\\rho g$, we have $\\left.\\frac{\\partial p}{\\partial x}\\right|_{\\eta} = -\\rho g \\left.\\frac{\\partial z}{\\partial x}\\right|_{\\eta}$, which guarantees cancellation.\n\nHowever, when discretized, this cancellation is no longer exact. The problem asks us to compute the spurious horizontal acceleration $a_i$ at each grid point $x_i$ on a constant-$\\eta$ surface using a centered finite difference scheme for the horizontal derivatives:\n$$a_i = -\\frac{1}{\\rho_i} D_x p_i + g \\, D_x z_i$$\nwhere $D_x f_i = \\frac{f_{i+1} - f_{i-1}}{2\\Delta x}$ is the centered difference operator with periodic boundary conditions. The values $p_i$, $\\rho_i$, and $z_i$ are evaluated at grid points $x_i$ on the specified $\\eta$ surface. The objective is to find the maximum absolute spurious acceleration, $a_{\\max} = \\max_{i} |a_i|$.\n\nThe source of the numerical error can be elucidated. The discrete pressure gradient term is $D_x p_i = \\frac{p_{i+1} - p_{i-1}}{2\\Delta x}$. By the Mean Value Theorem, there exists some $\\tilde{z}$ between $z_{i-1}$ and $z_{i+1}$ such that $p_{i+1} - p_{i-1} = p'(\\tilde{z})(z_{i+1} - z_{i-1})$. Since $p'(z) = \\frac{dp}{dz} = -\\rho(z) g$, we can write $D_x p_i = -\\rho(\\tilde{z}) g \\frac{z_{i+1} - z_{i-1}}{2\\Delta x} = -\\rho(\\tilde{z}) g D_x z_i$.\nSubstituting this into the expression for $a_i$:\n$$a_i = -\\frac{1}{\\rho_i} \\left( -\\rho(\\tilde{z}) g D_x z_i \\right) + g D_x z_i = g \\left( \\frac{\\rho(\\tilde{z})}{\\rho_i} - 1 \\right) D_x z_i$$\nThe spurious acceleration $a_i$ is non-zero because the density at the intermediate point, $\\rho(\\tilde{z})$, is not identical to the density at the grid point itself, $\\rho_i = \\rho(z_i)$, due to the non-linear (exponential) dependence of density on height $z$. This discrepancy is a direct consequence of the truncation error of the finite difference approximation.\n\nThe computational procedure to find $a_{\\max}$ for each test case is as follows:\n\n$1$. Define the physical constants: $g = 9.80665 \\, \\text{m s}^{-2}$, $R_d = 287 \\, \\text{J kg}^{-1} \\text{K}^{-1}$, $p_0 = 10^5 \\, \\text{Pa}$, and $H_{\\text{top}} = 20000 \\, \\text{m}$.\n$2$. For each test case, retrieve the parameters: terrain amplitude $h_0$, domain length $L$, virtual temperature $T_v$, vertical level $\\eta$, and number of grid points $N$.\n$3$. Calculate derived constants and grid parameters:\n   - Scale height: $H = \\frac{R_d T_v}{g}$.\n   - Grid spacing: $\\Delta x = \\frac{L}{N}$.\n$4$. Construct the horizontal grid: an array of $N$ points $x_i = i \\Delta x$ for $i_c = 0, 1, \\dots, N-1$.\n$5$. Compute the terrain height at each grid point: $h_i = h(x_i) = h_0 \\sin\\left(\\frac{2\\pi x_i}{L}\\right)$.\n$6$. Compute the physical height $z_i$ of the $\\eta$-surface at each grid point: $z_i = \\eta H_{\\text{top}} + (1-\\eta) h_i$.\n$7$. Compute the pressure $p_i$ and density $\\rho_i$ at each grid point:\n   - $p_i = p_0 \\exp\\left(-\\frac{z_i}{H}\\right)$.\n   - $\\rho_i = \\frac{p_i}{R_d T_v}$.\n$8$. Apply the periodic centered difference operator $D_x$ to the $z_i$ and $p_i$ arrays to obtain the discrete gradients $D_x z_i$ and $D_x p_i$. This is efficiently done using array shifts (e.g., `numpy.roll`).\n   - $D_x z_i = \\frac{z_{i+1} - z_{i-1}}{2\\Delta x}$.\n   - $D_x p_i = \\frac{p_{i+1} - p_{i-1}}{2\\Delta x}$.\n$9$. Calculate the spurious acceleration $a_i$ at each grid point using the formula $a_i = - \\frac{1}{\\rho_i} D_x p_i + g D_x z_i$.\n$10$. Determine the maximum absolute value of the resulting acceleration array, $a_{\\max} = \\max_{i} |a_i|$. This is the final result for the test case.\n\nFor the special case where $h_0 = 0$, the terrain is flat, $h(x) = 0$. Consequently, $z(x,\\eta) = \\eta H_{\\text{top}}$ is constant for all $x$. This means $z_i$ is a constant array, and so are $p_i$ and $\\rho_i$. The discrete derivatives $D_x z_i$ and $D_x p_i$ are therefore exactly zero, resulting in $a_i = 0$ for all $i$, and $a_{\\max} = 0$. This provides a useful validation check for the implementation.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the maximum spurious horizontal acceleration due to pressure\n    gradient errors in a terrain-following coordinate system.\n    \"\"\"\n\n    # Define constants\n    G = 9.80665  # m s^-2\n    R_D = 287.0    # J kg^-1 K^-1\n    P0 = 1.0e5   # Pa\n    H_TOP = 20000.0  # m\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (h0, L, Tv, eta, N)\n        (1000.0, 50000.0, 300.0, 0.5, 201), # Case 1: Happy path\n        (0.0, 50000.0, 300.0, 0.5, 201),    # Case 2: Boundary (flat terrain)\n        (1000.0, 10000.0, 300.0, 0.5, 201), # Case 3: Steeper terrain\n        (1000.0, 50000.0, 300.0, 0.1, 201), # Case 4: Near-surface level\n        (1000.0, 50000.0, 300.0, 0.9, 201), # Case 5: Near-top level\n        (1000.0, 50000.0, 300.0, 0.5, 21),  # Case 6: Coarse-grid resolution\n    ]\n\n    results = []\n    for case in test_cases:\n        h0, L, Tv, eta, N = case\n\n        # Handle the trivial flat terrain case analytically to avoid potential\n        # floating point noise.\n        if h0 == 0.0:\n            results.append(\"{:.6e}\".format(0.0))\n            continue\n\n        # 1. Calculate derived constants and grid parameters\n        H_scale = (R_D * Tv) / G\n        dx = L / N\n\n        # 2. Construct the horizontal grid\n        x_grid = np.arange(N) * dx\n\n        # 3. Compute terrain and physical height\n        h_grid = h0 * np.sin(2.0 * np.pi * x_grid / L)\n        z_grid = eta * H_TOP + (1.0 - eta) * h_grid\n\n        # 4. Compute pressure and density\n        p_grid = P0 * np.exp(-z_grid / H_scale)\n        rho_grid = p_grid / (R_D * Tv)\n\n        # 5. Compute discrete derivatives using centered differences\n        # np.roll provides periodic boundary handling\n        # D_x f_i = (f_{i+1} - f_{i-1}) / (2 * dx)\n        dz_dx = (np.roll(z_grid, -1) - np.roll(z_grid, 1)) / (2.0 * dx)\n        dp_dx = (np.roll(p_grid, -1) - np.roll(p_grid, 1)) / (2.0 * dx)\n\n        # 6. Calculate the spurious acceleration at each grid point\n        # a_i = - (1/rho_i) * D_x(p)_i + g * D_x(z)_i\n        spurious_accel = -(1.0 / rho_grid) * dp_dx + G * dz_dx\n\n        # 7. Find the maximum absolute value\n        a_max = np.max(np.abs(spurious_accel))\n\n        # 8. Format and store the result\n        results.append(\"{:.6e}\".format(a_max))\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Moving from analyzing problems to engineering solutions, this practice tackles a common task in model diagnostics and data assimilation: remapping data between different vertical grids. It is essential that such transformations conserve fundamental physical quantities, like the total mass of a chemical tracer. This exercise  challenges you to design and implement a \"vertically conservative remapping\" algorithm, a procedure that skillfully combines physical laws like the hypsometric equation with careful numerical logic to ensure mass is not artificially created or destroyed.",
            "id": "4109509",
            "problem": "You are tasked with designing and implementing a vertically conservative remapping algorithm that transforms a tracer field defined on pressure-coordinate layers into values on fixed-height (geometric altitude) bins, suitable for numerical weather prediction and climate modeling applications. The tracer field is given as layer-mean values on pressure layers. The remapped tracer on height bins must conserve the total column integral when measured with the physically appropriate mass weighting. The program must implement this transformation using only scientifically justified relations starting from fundamental principles and must produce a numerically verifiable output on a prescribed test suite.\n\nThe fundamental base for this task is the following:\n- Hydrostatic balance, which states that the vertical pressure gradient is balanced by gravity: $$\\frac{\\mathrm{d}p}{\\mathrm{d}z} = -\\rho g,$$ where $p$ is pressure, $z$ is geometric height, $\\rho$ is density, and $g$ is gravitational acceleration.\n- The Ideal Gas Law for dry air: $$p = \\rho R_d T,$$ where $R_d$ is the specific gas constant for dry air and $T$ is temperature. For the purpose of this problem, assume dry air and that a layer-mean temperature adequately represents each pressure layer for hydrostatic elevation calculations.\n\nYour program must:\n1. Use the hydrostatic balance and the Ideal Gas Law to construct the mapping between layer edge pressures and their geometric heights, treating the temperature within each pressure layer as a layer-mean value. Use Scientific International (SI) units throughout: pressure in pascals, height in meters, temperature in kelvin, gravitational acceleration in meters per second squared, and the specific gas constant in joules per kilogram per kelvin.\n2. Implement a vertically conservative remapping from pressure layers to height bins. Interpret the tracer field $q$ as a dimensionless layer-mean mass mixing ratio, so that a column integral over pressure layers uses the mass weighting proportional to $\\Delta p/g$. The remapped value assigned to each height bin must be the mass-weighted mean of $q$ over the pressure range that maps into the height bin.\n3. Ensure that the column integral of $q$ weighted by mass per unit area is conserved to within floating-point precision when summing over the full height domain covered by the pressure layers. Explicitly handle the case where some target height bin edges lie outside the pressure-derived height domain by clipping contributions to the valid domain (bins entirely outside contribute zero mass).\n4. Compute and report, for each test case, both:\n   - The list of remapped tracer values per height bin, as floats.\n   - The absolute relative error (as a decimal, not a percent) between the original column integral and the remapped column integral, each measured with mass weighting, defined by $$\\epsilon = \\left| \\frac{I_{\\text{remap}} - I_{\\text{orig}}}{I_{\\text{orig}}} \\right|,$$ where $$I_{\\text{orig}} = \\sum_k q_k \\frac{p_{k}^{\\text{edge}} - p_{k+1}^{\\text{edge}}}{g}$$ and $$I_{\\text{remap}} = \\sum_j \\tilde{q}_j \\frac{p_{j}^{\\text{tgt-edge}} - p_{j+1}^{\\text{tgt-edge}}}{g}.$$ Here $q_k$ denotes the layer-mean tracer in the $k$-th pressure layer, $p_k^{\\text{edge}}$ are original pressure layer edges, $\\tilde{q}_j$ are the remapped height-bin values, and $p_j^{\\text{tgt-edge}}$ are the pressures corresponding to the target height bin edges found via the $p \\leftrightarrow z$ mapping.\n\nRequired inputs your program must use for each test case:\n- Layer edge pressures $p^{\\text{edge}}$ as a strictly decreasing list in pascals.\n- Layer-mean temperatures $T$ per layer in kelvin.\n- Tracer layer-mean values $q$ per layer as dimensionless numbers.\n- Target height bin edges $z^{\\text{tgt-edge}}$ in meters.\n- Physical constants: gravitational acceleration $g$ in meters per second squared, and the dry-air gas constant $R_d$ in joules per kilogram per kelvin.\n\nAssume the bottom height is $z=0$ at the bottom pressure edge. The computed height at the top pressure edge is the domain top.\n\nTest suite:\nProvide results for the following three cases, all using $g = 9.80665$ and $R_d = 287.0$:\n- Case A (isothermal with increasing tracer aloft, includes a target edge above the domain top to test clipping):\n  - $p^{\\text{edge}} = [100000, 80000, 60000, 45000, 33000, 22000]$.\n  - $T = [280, 280, 280, 280, 280]$.\n  - $q = [1.0\\times 10^{-6}, 2.0\\times 10^{-6}, 4.0\\times 10^{-6}, 8.0\\times 10^{-6}, 1.6\\times 10^{-5}]$.\n  - $z^{\\text{tgt-edge}} = [0, 3000, 6000, 9000, 12000, 13500]$.\n- Case B (non-isothermal with a lapse rate and variable tracer):\n  - $p^{\\text{edge}} = [101325, 90000, 78000, 65000, 53000, 42000, 32000]$.\n  - $T = [290, 285, 275, 265, 260, 255]$.\n  - $q = [5.0\\times 10^{-7}, 1.0\\times 10^{-6}, 2.0\\times 10^{-6}, 3.0\\times 10^{-6}, 1.5\\times 10^{-6}, 1.0\\times 10^{-6}]$.\n  - $z^{\\text{tgt-edge}} = [0, 2000, 5000, 9000, 14000]$.\n- Case C (near-surface fine layering with temperature inversion and shallow height bins):\n  - $p^{\\text{edge}} = [100000, 99000, 98000, 97000, 95000]$.\n  - $T = [295, 300, 298, 296]$.\n  - $q = [1.0\\times 10^{-6}, 1.2\\times 10^{-6}, 1.15\\times 10^{-6}, 1.1\\times 10^{-6}]$.\n  - $z^{\\text{tgt-edge}} = [0, 50, 100, 200, 500]$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each element corresponds to one test case and is itself a list containing two elements: the list of remapped tracer values on height bins for that case, and the absolute relative error as a float. For example, the output must look like:\n$[ [ [\\tilde{q}_1,\\ldots,\\tilde{q}_m], \\epsilon ], [ \\ldots ], [ \\ldots ] ]$\nwith no additional text. Numbers may be in scientific notation. Angles are not used in this problem.",
            "solution": "The problem of remapping a tracer field from a pressure-based vertical coordinate system to a height-based one is a fundamental task in atmospheric modeling. A valid solution must be derived from first principles and ensure the conservation of the total tracer mass.\n\nThe solution proceeds in three main stages:\n1.  Establish the mathematical relationship between pressure ($p$) and geometric height ($z$) using the provided physical laws.\n2.  Define the conservative remapping algorithm based on the principle of mass conservation.\n3.  Implement the algorithm to compute the remapped tracer values and verify the conservation property numerically.\n\n**1. Pressure-Height Relationship (Hypsometric Equation)**\n\nThe relationship between pressure and height is derived by combining the two fundamental principles provided: hydrostatic balance and the Ideal Gas Law.\n\nThe hydrostatic balance equation is:\n$$ \\frac{\\mathrm{d}p}{\\mathrm{d}z} = -\\rho g $$\nwhere $p$ is pressure, $z$ is geometric height, $\\rho$ is air density, and $g$ is the acceleration due to gravity.\n\nThe Ideal Gas Law for dry air is:\n$$ p = \\rho R_d T $$\nwhere $R_d$ is the specific gas constant for dry air and $T$ is temperature.\n\nBy rearranging the Ideal Gas Law to solve for density, $\\rho = p / (R_d T)$, and substituting it into the hydrostatic equation, we get:\n$$ \\frac{\\mathrm{d}p}{\\mathrm{d}z} = - \\frac{p g}{R_d T} $$\nThis differential equation relates changes in pressure to changes in height. To find the height difference between two pressure levels, we rearrange and integrate. Assuming the temperature $T$ is constant within a given atmospheric layer (as specified by the problem, using a layer-mean temperature $T_k$), we can integrate from a lower level ($p_1, z_1$) to an upper level ($p_2, z_2$ where $p_2  p_1$):\n$$ \\int_{z_1}^{z_2} \\mathrm{d}z = - \\int_{p_1}^{p_2} \\frac{R_d T_k}{g} \\frac{\\mathrm{d}p}{p} $$\n$$ z_2 - z_1 = - \\frac{R_d T_k}{g} [\\ln(p)]_{p_1}^{p_2} = - \\frac{R_d T_k}{g} (\\ln(p_2) - \\ln(p_1)) $$\nThis simplifies to the hypsometric equation for the layer:\n$$ \\Delta z = z_2 - z_1 = \\frac{R_d T_k}{g} \\ln\\left(\\frac{p_1}{p_2}\\right) $$\nStarting with the boundary condition $z=0$ at the lowest pressure edge ($p^{\\text{edge}}_0$), we can iteratively apply this formula for each pressure layer to determine the geometric height of every pressure edge in the source grid. Let $z^{\\text{edge}}_k$ be the height of pressure edge $p^{\\text{edge}}_k$. We have $z^{\\text{edge}}_0 = 0$, and for $k \\ge 0$:\n$$ z^{\\text{edge}}_{k+1} = z^{\\text{edge}}_k + \\frac{R_d T_k}{g} \\ln\\left(\\frac{p^{\\text{edge}}_k}{p^{\\text{edge}}_{k+1}}\\right) $$\nwhere $T_k$ is the mean temperature of the layer between $p^{\\text{edge}}_k$ and $p^{\\text{edge}}_{k+1}$.\n\nConversely, to find the pressure $p$ at a given height $z$ within a layer $k$ (bounded by $(p^{\\text{edge}}_k, z^{\\text{edge}}_k)$ and $(p^{\\text{edge}}_{k+1}, z^{\\text{edge}}_{k+1})$), we invert the relation:\n$$ p(z) = p^{\\text{edge}}_k \\exp\\left(-\\frac{g(z - z^{\\text{edge}}_k)}{R_d T_k}\\right) $$\nThis mapping is crucial for determining the pressure values corresponding to the target height bin edges.\n\n**2. Conservative Remapping Principle**\n\nThe tracer variable, $q$, is a mass mixing ratio (dimensionless mass of tracer per unit mass of air). Conservation requires that the total mass of the tracer in a vertical column remains unchanged after remapping.\n\nThe mass of air per unit horizontal area in a differential pressure interval $\\mathrm{d}p$ is derived from the hydrostatic equation: $\\mathrm{d}m_{\\text{air}} = \\rho \\, \\mathrm{d}z = - \\frac{\\mathrm{d}p}{g}$. The mass of air in a finite layer from $p_a$ to $p_b$ ($p_a > p_b$) is $\\frac{p_a - p_b}{g}$.\n\nThe total column tracer mass, $I$, is the integral of the tracer mixing ratio weighted by the air mass:\n$$ I = \\int_{p_{\\text{top}}}^{p_{\\text{surf}}} q(p) \\frac{\\mathrm{d}p}{g} $$\nFor the discrete source grid with layer-mean tracer values $q_k$, the original column integral is:\n$$ I_{\\text{orig}} = \\sum_k q_k \\frac{p^{\\text{edge}}_k - p^{\\text{edge}}_{k+1}}{g} $$\n\nThe remapped tracer value, $\\tilde{q}_j$, for a target height bin $j$ (from $z^{\\text{tgt-edge}}_j$ to $z^{\\text{tgt-edge}}_{j+1}$) is defined as the mass-weighted average of $q$ over that bin. This is the total tracer mass in the bin divided by the total air mass in the bin.\n\nLet the pressure edges of the target bin be $p^{\\text{tgt-edge}}_j = p(z^{\\text{tgt-edge}}_j)$ and $p^{\\text{tgt-edge}}_{j+1} = p(z^{\\text{tgt-edge}}_{j+1})$. The total air mass in the bin is $\\frac{p^{\\text{tgt-edge}}_j - p^{\\text{tgt-edge}}_{j+1}}{g}$. The total tracer mass in the bin is $\\int_{p^{\\text{tgt-edge}}_{j+1}}^{p^{\\text{tgt-edge}}_j} q(p) \\frac{\\mathrm{d}p}{g}$.\nThus, the remapped value is:\n$$ \\tilde{q}_j = \\frac{\\int_{p^{\\text{tgt-edge}}_{j+1}}^{p^{\\text{tgt-edge}}_j} q(p) \\frac{\\mathrm{d}p}{g}}{\\frac{p^{\\text{tgt-edge}}_j - p^{\\text{tgt-edge}}_{j+1}}{g}} = \\frac{1}{\\Delta p^{\\text{tgt}}_j} \\int_{p^{\\text{tgt-edge}}_{j+1}}^{p^{\\text{tgt-edge}}_j} q(p) \\mathrm{d}p $$\nwhere $\\Delta p^{\\text{tgt}}_j = p^{\\text{tgt-edge}}_j - p^{\\text{tgt-edge}}_{j+1}$.\n\nSince $q$ is piecewise constant ($q_k$ in source layer $k$), the integral becomes a sum. The contribution of each source layer to the integral is its tracer value $q_k$ multiplied by the pressure thickness of its overlap with the target bin's pressure range.\n$$ \\int_{p^{\\text{tgt-edge}}_{j+1}}^{p^{\\text{tgt-edge}}_j} q(p) \\mathrm{d}p = \\sum_k q_k \\cdot \\Delta p_{\\text{overlap}}(j, k) $$\nwhere $\\Delta p_{\\text{overlap}}(j, k) = \\max(0, \\min(p^{\\text{tgt-edge}}_j, p^{\\text{edge}}_k) - \\max(p^{\\text{tgt-edge}}_{j+1}, p^{\\text{edge}}_{k+1}))$.\nTherefore, the remapped tracer is:\n$$ \\tilde{q}_j = \\frac{\\sum_k q_k \\cdot \\Delta p_{\\text{overlap}}(j, k)}{\\Delta p^{\\text{tgt}}_j} $$\n\nThe total remapped column integral, $I_{\\text{remap}}$, is the sum of tracer mass over all target bins:\n$$ I_{\\text{remap}} = \\sum_j \\tilde{q}_j \\frac{\\Delta p^{\\text{tgt}}_j}{g} $$\nBy substituting the formula for $\\tilde{q}_j$, it can be shown that $I_{\\text{remap}} = I_{\\text{orig}}$ provided the target grid spans the full extent of the source grid. This algebraic identity ensures that the remapping scheme is conservative by construction, with any deviation arising only from floating-point arithmetic limitations.\n\n**3. Algorithmic Implementation**\n\nThe algorithm is executed as follows for each test case:\n1.  **Source Grid Construction**: Given the source pressure edges ($p^{\\text{edge}}$) and layer-mean temperatures ($T$), compute the corresponding height of each pressure edge ($z^{\\text{edge}}$) by iteratively applying the hypsometric equation, starting from $z^{\\text{edge}}_0 = 0$. This establishes the full height domain $[0, z^{\\text{edge}}_{\\text{top}}]$.\n2.  **Target Pressure Calculation**: For each target height edge $z^{\\text{tgt-edge}}_j$, first clip it to the valid source domain: $z^{\\text{clip}}_j = \\text{clip}(z^{\\text{tgt-edge}}_j, 0, z^{\\text{edge}}_{\\text{top}})$. This correctly handles target bins that are partially or fully outside the source domain. Then, for each $z^{\\text{clip}}_j$, find the source layer $k$ that contains it and use the inverse hypsometric formula to calculate the corresponding pressure, $p^{\\text{tgt-edge}}_j = p(z^{\\text{clip}}_j)$.\n3.  **Remapping Loop**: Iterate through each target height bin $j$. Calculate its pressure thickness $\\Delta p^{\\text{tgt}}_j$. Then, iterate through all source layers $k$ to compute the pressure thickness of the overlap, $\\Delta p_{\\text{overlap}}(j,k)$. The numerator for the weighted average is accumulated as $\\sum_k q_k \\cdot \\Delta p_{\\text{overlap}}(j, k)$. The remapped value $\\tilde{q}_j$ is the ratio of this numerator to $\\Delta p^{\\text{tgt}}_j$. If a target bin has zero mass (i.e., $\\Delta p^{\\text{tgt}}_j = 0$), its tracer value is set to $0$.\n4.  **Conservation Error**: Calculate $I_{\\text{orig}}$ using the source grid data and $I_{\\text{remap}}$ using the newly computed remapped values $\\tilde{q}_j$ and target pressure thicknesses $\\Delta p^{\\text{tgt}}_j$. The absolute relative error $\\epsilon = |(I_{\\text{remap}} - I_{\\text{orig}}) / I_{\\text{orig}}|$ is then computed to quantify the numerical conservation of the scheme.\n\nThis procedure provides a scientifically rigorous and numerically robust method for performing conservative vertical remapping.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function that processes test cases for vertical remapping.\n    \"\"\"\n    g = 9.80665  # m/s^2\n    R_d = 287.0    # J/(kg*K)\n\n    test_cases = [\n        {\n            \"name\": \"A\",\n            \"p_edge\": np.array([100000, 80000, 60000, 45000, 33000, 22000], dtype=float),\n            \"T\": np.array([280, 280, 280, 280, 280], dtype=float),\n            \"q\": np.array([1.0e-6, 2.0e-6, 4.0e-6, 8.0e-6, 1.6e-5], dtype=float),\n            \"z_tgt_edge\": np.array([0, 3000, 6000, 9000, 12000, 13500], dtype=float),\n        },\n        {\n            \"name\": \"B\",\n            \"p_edge\": np.array([101325, 90000, 78000, 65000, 53000, 42000, 32000], dtype=float),\n            \"T\": np.array([290, 285, 275, 265, 260, 255], dtype=float),\n            \"q\": np.array([5.0e-7, 1.0e-6, 2.0e-6, 3.0e-6, 1.5e-6, 1.0e-6], dtype=float),\n            \"z_tgt_edge\": np.array([0, 2000, 5000, 9000, 14000], dtype=float),\n        },\n        {\n            \"name\": \"C\",\n            \"p_edge\": np.array([100000, 99000, 98000, 97000, 95000], dtype=float),\n            \"T\": np.array([295, 300, 298, 296], dtype=float),\n            \"q\": np.array([1.0e-6, 1.2e-6, 1.15e-6, 1.1e-6], dtype=float),\n            \"z_tgt_edge\": np.array([0, 50, 100, 200, 500], dtype=float),\n        },\n    ]\n\n    def _compute_remapping(p_src_edge, T, q, z_tgt_edge, g_const, Rd_const):\n        \"\"\"Helper function to perform remapping for a single case.\"\"\"\n        # Step 1: Compute source grid heights from pressures (p_to_z)\n        num_src_layers = len(p_src_edge) - 1\n        z_src_edge = np.zeros_like(p_src_edge)\n        for k in range(num_src_layers):\n            p1, p2 = p_src_edge[k], p_src_edge[k+1]\n            Tk = T[k]\n            # Hypsometric equation\n            delta_z = (Rd_const * Tk / g_const) * np.log(p1 / p2)\n            z_src_edge[k+1] = z_src_edge[k] + delta_z\n        \n        z_domain_top = z_src_edge[-1]\n\n        # Step 2: Compute target grid pressures from heights (z_to_p)\n        z_tgt_edge_clipped = np.clip(z_tgt_edge, 0, z_domain_top)\n        \n        # Find which source layer each target height falls into\n        # 'side=right' means if z is on an edge, it's considered in the layer above\n        # Correct index is search_idx - 1\n        src_layer_indices = np.searchsorted(z_src_edge, z_tgt_edge_clipped, side='right') - 1\n        # Handle case where z is exactly on the top boundary\n        src_layer_indices[z_tgt_edge_clipped == z_domain_top] = num_src_layers - 1\n        src_layer_indices = np.maximum(0, src_layer_indices) # ensure index is non-negative\n        \n        p_tgt_edge = np.zeros_like(z_tgt_edge)\n        for i in range(len(z_tgt_edge)):\n            k = src_layer_indices[i]\n            z = z_tgt_edge_clipped[i]\n            # Invert hypsometric equation\n            p_tgt_edge[i] = p_src_edge[k] * np.exp(\n                -g_const * (z - z_src_edge[k]) / (Rd_const * T[k])\n            )\n\n        # Step 3: Perform conservative remapping\n        num_tgt_bins = len(z_tgt_edge) - 1\n        q_remap = np.zeros(num_tgt_bins)\n        \n        for j in range(num_tgt_bins):\n            p_tgt_j_bot, p_tgt_j_top = p_tgt_edge[j], p_tgt_edge[j+1]\n            dp_tgt_bin = p_tgt_j_bot - p_tgt_j_top\n            \n            if dp_tgt_bin = 1e-12: # Avoid division by zero/small number\n                q_remap[j] = 0.0\n                continue\n            \n            numerator = 0.0\n            for k in range(num_src_layers):\n                p_src_k_bot, p_src_k_top = p_src_edge[k], p_src_edge[k+1]\n                \n                # Calculate pressure thickness of overlap\n                overlap_bot = min(p_tgt_j_bot, p_src_k_bot)\n                overlap_top = max(p_tgt_j_top, p_src_k_top)\n                dp_overlap = max(0, overlap_bot - overlap_top)\n                \n                numerator += q[k] * dp_overlap\n            \n            q_remap[j] = numerator / dp_tgt_bin\n\n        # Step 4: Calculate column integrals and relative error\n        dp_src = p_src_edge[:-1] - p_src_edge[1:]\n        I_orig = np.sum(q * dp_src) / g_const\n        \n        dp_tgt = p_tgt_edge[:-1] - p_tgt_edge[1:]\n        I_remap = np.sum(q_remap * dp_tgt) / g_const\n        \n        if abs(I_orig)  1e-15:\n            rel_error = 0.0 if abs(I_remap - I_orig)  1e-15 else np.inf\n        else:\n            rel_error = np.abs((I_remap - I_orig) / I_orig)\n            \n        return [q_remap.tolist(), rel_error]\n\n    results = []\n    for case in test_cases:\n        result = _compute_remapping(\n            case[\"p_edge\"], case[\"T\"], case[\"q\"], case[\"z_tgt_edge\"], g, R_d\n        )\n        results.append(result)\n\n    # Final print statement must match the specified format\n    print(str(results).replace(\" \", \"\"))\n\nsolve()\n```"
        }
    ]
}