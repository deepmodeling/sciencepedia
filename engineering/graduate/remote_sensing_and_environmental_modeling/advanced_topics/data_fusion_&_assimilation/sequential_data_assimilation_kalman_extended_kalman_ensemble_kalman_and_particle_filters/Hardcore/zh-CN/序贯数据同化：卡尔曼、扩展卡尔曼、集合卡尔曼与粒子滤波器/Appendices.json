{
    "hands_on_practices": [
        {
            "introduction": "在应用数据同化滤波器之前，必须回答一个基本问题：我们能否仅从可用的观测序列中完全确定系统的状态？这个属性被称为“可观测性”，是成功进行状态估计的关键先决条件。这个练习  将指导您构建可观测性矩阵，并利用其秩来评估一个简化的生态水文模型是否适合进行数据同化。",
            "id": "3846223",
            "problem": "用于生态水文预测的遥感数据同化系统，通过一个离散时间、线性时不变状态空间表示进行建模。状态向量为 $\\mathbf{x}_{k} \\in \\mathbb{R}^{3}$，表示土壤湿度、植被生物量和地表温度的异常，测量值 $y_{k} \\in \\mathbb{R}$ 是一个卫星衍生的亮度温度代理。动态和观测算子由下式给出\n$$\n\\mathbf{x}_{k+1} = F \\mathbf{x}_{k}, \\quad y_{k} = H \\mathbf{x}_{k},\n$$\n其中\n$$\nF = \\begin{bmatrix}\n0.9  0.1  0.0 \\\\\n0.0  0.95  0.05 \\\\\n0.2  0.0  0.85\n\\end{bmatrix}, \\quad\nH = \\begin{bmatrix}\n0.6  0.0  0.4\n\\end{bmatrix}.\n$$\n从离散时间线性系统的定义和可观测性的概念出发，构建 $3 \\times 3$ 的可观测性矩阵\n$$\nO = \\begin{bmatrix}\nH \\\\\nH F \\\\\nH F^{2}\n\\end{bmatrix},\n$$\n并确定其秩。陈述可观测性的秩条件，并基于此条件，解释在使用卡尔曼滤波器 (KF) 的线性高斯假设下，可观测性如何影响精确序贯数据同化的可行性，以及在实际遥感应用中对扩展卡尔曼滤波器 (EKF)、集合卡尔曼滤波器 (EnKF) 和粒子滤波器 (PF) 的影响。将 $O$ 的秩作为你的最终数值答案。无需四舍五入，答案不附带任何物理单位。",
            "solution": "问题要求对一个给定的离散时间、线性时不变 (LTI) 系统进行可观测性分析，该系统模拟了一个遥感数据同化过程。状态向量 $\\mathbf{x}_{k} \\in \\mathbb{R}^{n}$ (其中 $n=3$) 根据 $\\mathbf{x}_{k+1} = F \\mathbf{x}_{k}$ 演化，标量观测由 $y_{k} = H \\mathbf{x}_{k}$ 给出。系统矩阵如下：\n$$\nF = \\begin{bmatrix}\n0.9  0.1  0.0 \\\\\n0.0  0.95  0.05 \\\\\n0.2  0.0  0.85\n\\end{bmatrix}, \\quad\nH = \\begin{bmatrix}\n0.6  0.0  0.4\n\\end{bmatrix}\n$$\n如果初始状态 $\\mathbf{x}_{0}$ 可以由一个观测序列 $y_{0}, y_{1}, \\dots, y_{n-1}$ 唯一确定，则称系统是可观测的。对于 LTI 系统，这一性质通过检验可观测性矩阵 $O$ 的秩来评估。对于一个具有 $n$ 维状态空间的系统，可观测性矩阵构建如下：\n$$\nO = \\begin{bmatrix}\nH \\\\\nH F \\\\\n\\vdots \\\\\nH F^{n-1}\n\\end{bmatrix}\n$$\n在本例中，状态维度为 $n=3$，因此可观测性矩阵为：\n$$\nO = \\begin{bmatrix}\nH \\\\\nH F \\\\\nH F^{2}\n\\end{bmatrix}\n$$\n第一步是计算矩阵乘积 $H F$ 和 $H F^2$。\n\n$H F$的计算：\n$$\nH F = \\begin{bmatrix}\n0.6  0.0  0.4\n\\end{bmatrix}\n\\begin{bmatrix}\n0.9  0.1  0.0 \\\\\n0.0  0.95  0.05 \\\\\n0.2  0.0  0.85\n\\end{bmatrix}\n$$\n$$\nH F = \\begin{bmatrix}\n(0.6)(0.9) + (0.0)(0.0) + (0.4)(0.2)  (0.6)(0.1) + (0.0)(0.95) + (0.4)(0.0)  (0.6)(0.0) + (0.0)(0.05) + (0.4)(0.85)\n\\end{bmatrix}\n$$\n$$\nH F = \\begin{bmatrix}\n0.54 + 0.08  0.06  0.34\n\\end{bmatrix}\n= \\begin{bmatrix}\n0.62  0.06  0.34\n\\end{bmatrix}\n$$\n\n$H F^2$的计算：\n首先，我们计算矩阵 $F^2 = F \\times F$。\n$$\nF^2 = \\begin{bmatrix}\n0.9  0.1  0.0 \\\\\n0.0  0.95  0.05 \\\\\n0.2  0.0  0.85\n\\end{bmatrix}\n\\begin{bmatrix}\n0.9  0.1  0.0 \\\\\n0.0  0.95  0.05 \\\\\n0.2  0.0  0.85\n\\end{bmatrix}\n$$\n$$\nF^2 = \\begin{bmatrix}\n(0.9)(0.9) + (0.1)(0.0) + (0.0)(0.2)  (0.9)(0.1) + (0.1)(0.95) + (0.0)(0.0)  (0.9)(0.0) + (0.1)(0.05) + (0.0)(0.85) \\\\\n(0.0)(0.9) + (0.95)(0.0) + (0.05)(0.2)  (0.0)(0.1) + (0.95)(0.95) + (0.05)(0.0)  (0.0)(0.0) + (0.95)(0.05) + (0.05)(0.85) \\\\\n(0.2)(0.9) + (0.0)(0.0) + (0.85)(0.2)  (0.2)(0.1) + (0.0)(0.95) + (0.85)(0.0)  (0.2)(0.0) + (0.0)(0.05) + (0.85)(0.85)\n\\end{bmatrix}\n$$\n$$\nF^2 = \\begin{bmatrix}\n0.81  0.185  0.005 \\\\\n0.01  0.9025  0.09 \\\\\n0.35  0.02  0.7225\n\\end{bmatrix}\n$$\n现在，我们可以计算 $H F^2 = (H) (F^2)$。\n$$\nH F^2 = \\begin{bmatrix}\n0.6  0.0  0.4\n\\end{bmatrix}\n\\begin{bmatrix}\n0.81  0.185  0.005 \\\\\n0.01  0.9025  0.09 \\\\\n0.35  0.02  0.7225\n\\end{bmatrix}\n$$\n$$\nH F^2 = \\begin{bmatrix}\n(0.6)(0.81) + (0.4)(0.35)  (0.6)(0.185) + (0.4)(0.02)  (0.6)(0.005) + (0.4)(0.7225)\n\\end{bmatrix}\n$$\n$$\nH F^2 = \\begin{bmatrix}\n0.486 + 0.140  0.111 + 0.008  0.003 + 0.289\n\\end{bmatrix}\n= \\begin{bmatrix}\n0.626  0.119  0.292\n\\end{bmatrix}\n$$\n在计算出各行分量后，可观测性矩阵 $O$ 组装如下：\n$$\nO = \\begin{bmatrix}\nH \\\\\nH F \\\\\nH F^{2}\n\\end{bmatrix} = \\begin{bmatrix}\n0.6  0.0  0.4 \\\\\n0.62  0.06  0.34 \\\\\n0.626  0.119  0.292\n\\end{bmatrix}\n$$\n可观测性的秩条件指出，系统是可观测的当且仅当可观测性矩阵 $O$ 是满秩的。对此系统而言，满秩意味着 $\\text{rank}(O) = n = 3$。一个方阵是满秩的当且仅当其行列式非零。我们计算 $O$ 的行列式：\n$$\n\\det(O) = 0.6 \\begin{vmatrix} 0.06  0.34 \\\\ 0.119  0.292 \\end{vmatrix} - 0.0 \\begin{vmatrix} 0.62  0.34 \\\\ 0.626  0.292 \\end{vmatrix} + 0.4 \\begin{vmatrix} 0.62  0.06 \\\\ 0.626  0.119 \\end{vmatrix}\n$$\n$$\n\\det(O) = 0.6((0.06)(0.292) - (0.34)(0.119)) + 0.4((0.62)(0.119) - (0.06)(0.626))\n$$\n$$\n\\det(O) = 0.6(0.01752 - 0.04046) + 0.4(0.07378 - 0.03756)\n$$\n$$\n\\det(O) = 0.6(-0.02294) + 0.4(0.03622)\n$$\n$$\n\\det(O) = -0.013764 + 0.014488 = 0.000724\n$$\n由于 $\\det(O) = 0.000724 \\neq 0$，矩阵 $O$ 是可逆的且具有满秩。因此，$\\text{rank}(O) = 3$。根据秩条件，该系统是可观测的。\n\n系统的可观测性对序贯数据同化的可行性具有深远的影响。\n对于卡尔曼滤波器 (KF)，它是带有高斯噪声的线性系统的最优线性无偏估计器，可观测性是估计误差协方差矩阵收敛到一个唯一的、正定的稳态解的充要条件。这确保了滤波器的状态估计将随时间收敛到真实状态，并且估计的不确定性将是有界的。如果系统是不可观测的，某些状态或状态的线性组合将无法从测量中推断出来，并且与这些不可观测方向相关的误差协方差分量也不会因数据同化而减小。\n\n对于在实际遥感应用中常见的非线性系统，会使用像扩展卡尔曼滤波器 (EKF)、集合卡尔曼滤波器 (EnKF) 和粒子滤波器 (PF) 这样的滤波器。可观测性的概念仍然至关重要。\nEKF 将系统动态在当前估计值附近进行线性化。然后针对这个时变线性化系统评估可观测性。如果系统持续“不可观测”或“弱可观测”，EKF 可能会变得数值不稳定并最终发散。\nEnKF 和 PF 不需要显式线性化，但它们仍然从根本上受限于可观测性。如果某个状态分量是不可观测的，测量值就无法提供任何信息来更新它。在 EnKF 中，这意味着该分量的集合离散度不会通过分析步骤减小，并且伪相关可能会降低其他状态的估计精度。在 PF 中，粒子的权重不受不可观测状态分量的影响，这可能导致粒子退化和随之而来的滤波器失效，因为重采样将无法校正不可观测状态的分布。\n总之，这个特定的生态水文模型的可观测性（由其可观测性矩阵的满秩所证明）是成功应用任何这些数据同化滤波器来精确估计系统状态的先决条件。\n可观测性矩阵 $O$ 的秩为 $3$。",
            "answer": "$$\\boxed{3}$$"
        },
        {
            "introduction": "卡尔曼增益矩阵 $K$ 是数据同化更新步骤的核心，它决定了观测值如何校正模型预报。虽然它的公式看似抽象，但它具有一个强大的物理解释。本练习  将揭示，卡尔曼增益精确地量化了最终分析状态对每个观测值的敏感度，从而让您对信息如何从测量传递到状态估计有一个直观的理解。",
            "id": "3846262",
            "problem": "一个陆面环境模型估算三个相邻网格单元上的三维土壤湿度状态向量 $\\mathbf{x} \\in \\mathbb{R}^{3}$。一个卫星辐射计提供两个反射率观测值 $\\mathbf{y} \\in \\mathbb{R}^{2}$，这些观测值通过一个已知的观测算子与状态向量呈线性关系。假设以下基于广泛接受的基础的线性高斯数据同化设置：状态的高斯先验（预报）、线性观测算子和加性高斯观测噪声。给定了先验（预报）均值 $\\mathbf{m}_{f}$ 和先验协方差 $\\mathbf{P}_{f}$，观测模型为 $\\mathbf{y} = \\mathbf{H}\\mathbf{x} + \\boldsymbol{\\varepsilon}$，其中 $\\boldsymbol{\\varepsilon}$ 是均值为零、协方差为 $\\mathbf{R}$ 的高斯噪声。\n\n使用线性高斯估计的基本原理，推导出作为 $\\mathbf{y}$ 函数的分析均值 $\\mathbf{m}_{a}$，并求得 $\\mathbf{m}_{a}$ 相对于单个观测值 $y_{1}$ 扰动的敏感性，即梯度向量 $\\frac{\\partial \\mathbf{m}_{a}}{\\partial y_{1}}$。然后，对下列科学上合理的矩阵计算该敏感性：\n$$\n\\mathbf{P}_{f} = \\begin{pmatrix}\n0.4  0.2  0.0 \\\\\n0.2  0.5  0.1 \\\\\n0.0  0.1  0.3\n\\end{pmatrix}, \\quad\n\\mathbf{H} = \\begin{pmatrix}\n1  0.5  0 \\\\\n0  0.3  1\n\\end{pmatrix}, \\quad\n\\mathbf{R} = \\begin{pmatrix}\n0.09  0.01 \\\\\n0.01  0.04\n\\end{pmatrix}.\n$$\n此计算无需物理单位。将敏感性向量的每个分量四舍五入到四位有效数字。将最终答案表示为单个行向量。\n\n此外，简要解释在应用协方差局地化时，该敏感性如何在集合卡尔曼滤波（EnKF; Ensemble Kalman Filter）中推广，阐明样本协方差和局地化操作的作用，但此部分无需进行任何额外计算。",
            "solution": "用户提供了一个线性高斯数据同化领域的问题。我将首先验证问题陈述，然后进行完整的推导和求解。\n\n### 第1步：提取已知条件\n-   **状态向量**: $\\mathbf{x} \\in \\mathbb{R}^{3}$ (三个网格单元的土壤湿度)。\n-   **观测向量**: $\\mathbf{y} \\in \\mathbb{R}^{2}$ (反射率观测值)。\n-   **状态的先验分布**: $p(\\mathbf{x}) \\sim \\mathcal{N}(\\mathbf{x} | \\mathbf{m}_{f}, \\mathbf{P}_{f})$。\n-   **观测模型**: $\\mathbf{y} = \\mathbf{H}\\mathbf{x} + \\boldsymbol{\\varepsilon}$。\n-   **观测噪声分布**: $\\boldsymbol{\\varepsilon} \\sim \\mathcal{N}(\\boldsymbol{\\varepsilon} | \\mathbf{0}, \\mathbf{R})$。\n-   **先验协方差矩阵**:\n    $$\n    \\mathbf{P}_{f} = \\begin{pmatrix}\n    0.4  0.2  0.0 \\\\\n    0.2  0.5  0.1 \\\\\n    0.0  0.1  0.3\n    \\end{pmatrix}\n    $$\n-   **观测算子**:\n    $$\n    \\mathbf{H} = \\begin{pmatrix}\n    1  0.5  0 \\\\\n    0  0.3  1\n    \\end{pmatrix}\n    $$\n-   **观测误差协方差矩阵**:\n    $$\n    \\mathbf{R} = \\begin{pmatrix}\n    0.09  0.01 \\\\\n    0.01  0.04\n    \\end{pmatrix}\n    $$\n\n### 第2步：使用提取的已知条件进行验证\n1.  **科学依据**：该问题是卡尔曼滤波的标准应用，而卡尔曼滤波是遥感和环境建模中数据同化的基本工具。其设置（线性动力学、高斯误差）是一个经典且被广泛接受的框架。该问题在科学上是合理的。\n2.  **适定性**：该问题要求推导分析均值及其敏感性，这些都是估计理论中的标准量。所提供的矩阵在维度上是一致的：$\\mathbf{x}$ 是 $3 \\times 1$，$\\mathbf{y}$ 是 $2 \\times 1$，因此 $\\mathbf{H}$ 必须是 $2 \\times 3$，事实也的确如此。$\\mathbf{P}_{f}$ 是 $3 \\times 3$，$\\mathbf{R}$ 是 $2 \\times 2$，符合要求。$\\mathbf{P}_{f}$ 和 $\\mathbf{R}$ 都是对称的，并且可以验证它们是正定的，从而确保其逆矩阵存在，问题是适定的。\n3.  **客观性**：问题陈述使用了精确的数学和科学术语，没有任何主观性或歧义。\n\n### 第3步：结论与行动\n该问题是有效的。我现在开始求解。\n\n该问题要求两大部分：首先，推导和计算一个敏感性向量；其次，关于集合卡尔曼滤波（EnKF）的概念性解释。\n\n**第1部分：敏感性的推导与计算**\n\n分析（或后验）分布 $p(\\mathbf{x}|\\mathbf{y})$ 与似然 $p(\\mathbf{y}|\\mathbf{x})$ 和先验 $p(\\mathbf{x})$ 的乘积成正比。在高斯假设下，后验分布也是高斯分布，$p(\\mathbf{x}|\\mathbf{y}) \\sim \\mathcal{N}(\\mathbf{x} | \\mathbf{m}_{a}, \\mathbf{P}_{a})$。分析均值 $\\mathbf{m}_{a}$ 使该后验概率最大化，这等价于最小化负对数后验，通常表示为代价函数 $J(\\mathbf{x})$：\n$$\nJ(\\mathbf{x}) = (\\mathbf{y} - \\mathbf{H}\\mathbf{x})^{T}\\mathbf{R}^{-1}(\\mathbf{y} - \\mathbf{H}\\mathbf{x}) + (\\mathbf{x} - \\mathbf{m}_{f})^{T}\\mathbf{P}_{f}^{-1}(\\mathbf{x} - \\mathbf{m}_{f})\n$$\n为了找到最小值，我们求 $J(\\mathbf{x})$ 关于 $\\mathbf{x}$ 的梯度并令其为零。\n$$\n\\nabla_{\\mathbf{x}} J(\\mathbf{x}) = -2\\mathbf{H}^{T}\\mathbf{R}^{-1}(\\mathbf{y} - \\mathbf{H}\\mathbf{x}) + 2\\mathbf{P}_{f}^{-1}(\\mathbf{x} - \\mathbf{m}_{f}) = \\mathbf{0}\n$$\n重新整理各项以求解 $\\mathbf{x}$（即 $\\mathbf{m}_{a}$）：\n$$\n(\\mathbf{H}^{T}\\mathbf{R}^{-1}\\mathbf{H} + \\mathbf{P}_{f}^{-1})\\mathbf{m}_{a} = \\mathbf{H}^{T}\\mathbf{R}^{-1}\\mathbf{y} + \\mathbf{P}_{f}^{-1}\\mathbf{m}_{f}\n$$\n使用 Woodbury 矩阵恒等式可以变换此方程，从而得到我们所熟悉的均值卡尔曼更新方程形式：\n$$\n\\mathbf{m}_{a} = \\mathbf{m}_{f} + \\mathbf{K}(\\mathbf{y} - \\mathbf{H}\\mathbf{m}_{f})\n$$\n其中 $\\mathbf{K}$ 是卡尔曼增益矩阵，定义为：\n$$\n\\mathbf{K} = \\mathbf{P}_{f}\\mathbf{H}^{T}(\\mathbf{H}\\mathbf{P}_{f}\\mathbf{H}^{T} + \\mathbf{R})^{-1}\n$$\n问题要求分析均值 $\\mathbf{m}_{a}$ 相对于第一个观测值 $y_{1}$ 扰动的敏感性。这就是偏导数向量 $\\frac{\\partial \\mathbf{m}_{a}}{\\partial y_{1}}$。\n观测向量为 $\\mathbf{y} = \\begin{pmatrix} y_{1} \\\\ y_{2} \\end{pmatrix}$。我们可以计算 $\\mathbf{m}_{a}$ 关于整个观测向量 $\\mathbf{y}$ 的梯度。由于 $\\mathbf{m}_{f}$、$\\mathbf{H}$ 和 $\\mathbf{K}$ 不依赖于 $\\mathbf{y}$ 的具体实现，求导过程非常直接：\n$$\n\\frac{\\partial \\mathbf{m}_{a}}{\\partial \\mathbf{y}^{T}} = \\frac{\\partial}{\\partial \\mathbf{y}^{T}}[\\mathbf{m}_{f} + \\mathbf{K}\\mathbf{y} - \\mathbf{K}\\mathbf{H}\\mathbf{m}_{f}] = \\mathbf{K}\n$$\n相对于单个观测分量 $y_{j}$ 的敏感性是卡尔曼增益矩阵 $\\mathbf{K}$ 的第 $j$ 列。因此，为了求得 $\\frac{\\partial \\mathbf{m}_{a}}{\\partial y_{1}}$，我们必须计算 $\\mathbf{K}$ 的第一列。\n\n现在我们将给定的矩阵代入 $\\mathbf{K}$ 的公式中。\n\n1.  计算矩阵乘积 $\\mathbf{P}_{f}\\mathbf{H}^{T}$：\n    $$\n    \\mathbf{P}_{f}\\mathbf{H}^{T} = \\begin{pmatrix} 0.4  0.2  0.0 \\\\ 0.2  0.5  0.1 \\\\ 0.0  0.1  0.3 \\end{pmatrix} \\begin{pmatrix} 1  0 \\\\ 0.5  0.3 \\\\ 0  1 \\end{pmatrix} = \\begin{pmatrix} 0.5  0.06 \\\\ 0.45  0.25 \\\\ 0.05  0.33 \\end{pmatrix}\n    $$\n2.  计算新息协方差矩阵 $\\mathbf{H}\\mathbf{P}_{f}\\mathbf{H}^{T} + \\mathbf{R}$：\n    首先，$\\mathbf{H}\\mathbf{P}_{f}\\mathbf{H}^{T} = \\mathbf{H}(\\mathbf{P}_{f}\\mathbf{H}^{T})$：\n    $$\n    \\mathbf{H}(\\mathbf{P}_{f}\\mathbf{H}^{T}) = \\begin{pmatrix} 1  0.5  0 \\\\ 0  0.3  1 \\end{pmatrix} \\begin{pmatrix} 0.5  0.06 \\\\ 0.45  0.25 \\\\ 0.05  0.33 \\end{pmatrix} = \\begin{pmatrix} 0.725  0.185 \\\\ 0.185  0.405 \\end{pmatrix}\n    $$\n    现在，加上 $\\mathbf{R}$：\n    $$\n    \\mathbf{H}\\mathbf{P}_{f}\\mathbf{H}^{T} + \\mathbf{R} = \\begin{pmatrix} 0.725  0.185 \\\\ 0.185  0.405 \\end{pmatrix} + \\begin{pmatrix} 0.09  0.01 \\\\ 0.01  0.04 \\end{pmatrix} = \\begin{pmatrix} 0.815  0.195 \\\\ 0.195  0.445 \\end{pmatrix}\n    $$\n3.  对新息协方差矩阵求逆：\n    令 $\\mathbf{S}_{inv} = \\mathbf{H}\\mathbf{P}_{f}\\mathbf{H}^{T} + \\mathbf{R}$。其行列式为：\n    $$\n    \\det(\\mathbf{S}_{inv}) = (0.815)(0.445) - (0.195)(0.195) = 0.362675 - 0.038025 = 0.32465\n    $$\n    其逆矩阵为：\n    $$\n    \\mathbf{S}_{inv}^{-1} = \\frac{1}{0.32465} \\begin{pmatrix} 0.445  -0.195 \\\\ -0.195  0.815 \\end{pmatrix}\n    $$\n4.  计算卡尔曼增益 $\\mathbf{K} = (\\mathbf{P}_{f}\\mathbf{H}^{T})\\mathbf{S}_{inv}^{-1}$：\n    $$\n    \\mathbf{K} = \\begin{pmatrix} 0.5  0.06 \\\\ 0.45  0.25 \\\\ 0.05  0.33 \\end{pmatrix} \\frac{1}{0.32465} \\begin{pmatrix} 0.445  -0.195 \\\\ -0.195  0.815 \\end{pmatrix}\n    $$\n    敏感性向量 $\\frac{\\partial \\mathbf{m}_{a}}{\\partial y_{1}}$ 是 $\\mathbf{K}$ 的第一列。我们只需要计算这一列。\n    $$\n    \\frac{\\partial \\mathbf{m}_{a}}{\\partial y_{1}} = \\frac{1}{0.32465} \\begin{pmatrix} 0.5  0.06 \\\\ 0.45  0.25 \\\\ 0.05  0.33 \\end{pmatrix} \\begin{pmatrix} 0.445 \\\\ -0.195 \\end{pmatrix}\n    $$\n    $$\n    \\frac{\\partial \\mathbf{m}_{a}}{\\partial y_{1}} = \\frac{1}{0.32465} \\begin{pmatrix} (0.5)(0.445) + (0.06)(-0.195) \\\\ (0.45)(0.445) + (0.25)(-0.195) \\\\ (0.05)(0.445) + (0.33)(-0.195) \\end{pmatrix} = \\frac{1}{0.32465} \\begin{pmatrix} 0.2225 - 0.0117 \\\\ 0.20025 - 0.04875 \\\\ 0.02225 - 0.06435 \\end{pmatrix}\n    $$\n    $$\n    \\frac{\\partial \\mathbf{m}_{a}}{\\partial y_{1}} = \\frac{1}{0.32465} \\begin{pmatrix} 0.2108 \\\\ 0.1515 \\\\ -0.0421 \\end{pmatrix} \\approx \\begin{pmatrix} 0.6493146 \\\\ 0.4666563 \\\\ -0.1296842 \\end{pmatrix}\n    $$\n    将每个分量四舍五入到四位有效数字：\n    $$\n    \\frac{\\partial \\mathbf{m}_{a}}{\\partial y_{1}} \\approx \\begin{pmatrix} 0.6493 \\\\ 0.4667 \\\\ -0.1297 \\end{pmatrix}\n    $$\n\n**第2部分：推广到应用协方差局地化的EnKF**\n\n在集合卡尔曼滤波（EnKF）中，先验协方差矩阵不是解析已知的，而是通过 $N$ 个预报状态的集合 $\\{\\mathbf{x}_{i}^{f}\\}_{i=1}^{N}$ 来估计。卡尔曼增益 $\\mathbf{K}^{e}$ 使用样本协方差计算。具体来说，$\\mathbf{P}_{f}$ 被样本预报误差协方差 $\\mathbf{P}_{f}^{e}$ 替代，$\\mathbf{P}_{f}\\mathbf{H}^{T}$ 被状态和观测之间的样本互协方差 $\\mathbf{P}_{f}^{e}\\mathbf{H}^{T}$ 替代。\n\n集合分析均值 $\\bar{\\mathbf{m}}_{a}$ 对观测值 $y_{j}$ 的敏感性仍然由计算出的卡尔曼增益 $\\mathbf{K}^{e}$ 的第 $j$ 列给出。\n\n引入协方差局地化是为了减轻 $\\mathbf{P}_{f}^{e}$ 中由有限集合大小导致的采样误差的影响，这种误差通常会产生虚假的远程相关。这是通过将样本协方差矩阵与一个预定义的相关矩阵 $\\boldsymbol{\\rho}$ 进行 Schur（逐元素）积来实现的。\n\n这个局地化矩阵 $\\boldsymbol{\\rho}$ 的元素取决于状态变量之间（以及状态变量和观测之间）的物理距离。$\\boldsymbol{\\rho}$ 的元素通常在距离为零时为 $1$，并随着距离增加到某个半径之外时平滑衰减到 $0$。\n\n然后，使用这些局地化的协方差计算局地化卡尔曼增益 $\\mathbf{K}^{loc}$。一种常见的公式是：\n$$\n\\mathbf{K}^{loc} = (\\boldsymbol{\\rho} \\circ \\mathbf{P}_{f}^{e})\\mathbf{H}^{T} \\left( \\mathbf{H}(\\boldsymbol{\\rho} \\circ \\mathbf{P}_{f}^{e})\\mathbf{H}^{T} + \\mathbf{R} \\right)^{-1}\n$$\n与 $\\boldsymbol{\\rho}$ 进行 Schur 积 `$\\circ$' 的作用是削弱样本协方差矩阵的元素。因此，得到的卡尔曼增益 $\\mathbf{K}^{loc}$ 的元素也被削弱。特定位置的状态变量对一个观测的敏感性是 $\\mathbf{K}^{loc}$ 的一个分量，因此如果该状态变量在物理上远离该观测，其敏感性将被强制趋近于零。通过这种方式，局地化确保了一个观测只影响附近状态变量的分析，从而滤除由虚假样本相关可能引起的非物理性远程影响。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 0.6493  0.4667  -0.1297 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "当将数据同化应用于大规模、高维度的环境模型时，集合卡尔曼滤波器 (EnKF) 是一个常用的选择，但它也因采样误差而带来了独特的挑战。这个动手实践  旨在解决其中一个最关键的问题：伪长程相关。您将亲手实现协方差局地化这一基本技术，它能够抑制不符合物理规律的伪相关，确保观测值仅对其邻近区域的模型状态施加合理的影响。",
            "id": "3846198",
            "problem": "考虑一个一维网格化环境模型，用于遥感中的序贯数据同化，该模型表示沿一个断面的土壤湿度状态。状态向量表示为 $\\mathbf{x} \\in \\mathbb{R}^{n}$，其中包含 $n$ 个网格点，并有 $m$ 个源自卫星足迹的观测值。观测算子 $\\mathbf{H} \\in \\mathbb{R}^{m \\times n}$ 通过在每个足迹内进行线性平均，将状态映射到观测空间。假定观测误差是无偏的，与 $\\mathbf{x}$ 无关，并且服从协方差为 $\\mathbf{R} \\in \\mathbb{R}^{m \\times m}$ 的高斯分布。\n\n其基本依据是贝叶斯线性高斯更新和最小二乘最优性，这两者共同意味着 Kalman 滤波器 (KF) 增益由先验协方差和线性观测模型导出。集合 Kalman 滤波器 (EnKF) 使用有限大小的集合来构建样本协方差，这可能会受虚假的远程相关影响。协方差局地化通过一个紧支集相关函数来缓解此问题。给定一个 Gaspari–Cohn 局地化函数 $\\rho(r)$，其局地化半径为 $L>0$，用于通过 $\\mathbf{L}_{ij} = \\rho(r_{ij})$ 构建一个局地化矩阵 $\\mathbf{L} \\in \\mathbb{R}^{n \\times n}$，其中 $r_{ij}$ 是网格点 $i$ 和 $j$ 之间的物理距离。局地化通过与先验协方差进行逐元素（Hadamard）积来应用。\n\n你的任务是编写一个完整的程序，该程序能够：\n- 构建网格和观测算子。\n- 从一个具有指定物理上合理的协方差函数的零均值高斯场中生成先验集合，并计算样本先验协方差 $\\mathbf{P}_{xx} \\in \\mathbb{R}^{n \\times n}$。\n- 根据 $\\rho(r)$ 和 $L$ 为网格构建局地化矩阵 $\\mathbf{L}$。\n- 使用源自贝叶斯线性高斯框架和最小二乘最优性的标准 KF 定义计算未局地化的 Kalman 增益，并通过将局地化应用于先验协方差来计算局地化的 Kalman 增益。\n- 为每个测试案例返回局地化增益和未局地化增益之间的定量比较度量。\n\n构建中的所有距离必须以公里为单位处理，且不涉及角度。最终的度量必须是无量纲的（没有物理单位）。结果必须是浮点数。\n\n网格和观测设置：\n- 令 $n = 20$ 个网格点沿一个从 $0$ 公里到 $190$ 公里的断面均匀分布，间距为 $\\Delta x = 10$ 公里。\n- 令 $m = 3$ 个观测值的足迹中心位于 $50$ 公里、$100$ 公里和 $150$ 公里处。每个观测值使用均匀权重对足迹半径 $r_{\\mathrm{fp}} = 15$ 公里内的所有网格点进行平均，对于 $\\mathbf{H}$ 的每个观测行，贡献的网格点上的权重之和为 $1$。\n- 观测误差协方差为 $\\mathbf{R} = \\operatorname{diag}(s^2, s^2, s^2)$，其中 $s^2 = 0.01$。\n\n先验集合：\n- 构建一个大小为 $M = 100$ 的集合，其均值为零，并具有平方指数协方差 $C_{ij} = \\sigma^2 \\exp\\!\\left(-\\frac{r_{ij}^2}{2 \\ell^2}\\right)$，其中 $\\sigma^2 = 0.04$，相关长度 $\\ell = 40$ 公里。使用此 $\\mathbf{C}$ 采样 $M$ 个实现，并计算样本协方差 $\\mathbf{P}_{xx}$。\n\n局地化和增益计算：\n- 使用 $\\rho(r)$ 和半径 $L$ 构建 $\\mathbf{L}$，公式为 $\\mathbf{L}_{ij} = \\rho(r_{ij})$，其中 $r_{ij}$ 是网格点 $i$ 和 $j$ 之间的物理距离。\n- 使用源自贝叶斯线性高斯基础的标准 KF 逻辑计算未局地化的 Kalman 增益。\n- 通过将 $\\mathbf{P}_{xx}$ 替换为局地化协方差 $\\mathbf{P}^{\\mathrm{loc}}_{xx} = \\mathbf{P}_{xx} \\circ \\mathbf{L}$ 来计算局地化的 Kalman 增益，其中 $\\circ$ 是 Hadamard 积。\n- 对于每个测试案例，计算局地化增益与未局地化增益之差的 Frobenius 范数，即 $\\left\\|\\mathbf{K}_{\\mathrm{loc}} - \\mathbf{K}\\right\\|_{F}$，结果为一个浮点数。\n\n测试套件：\n- 案例 1：$L = 5$ 公里。\n- 案例 2：$L = 30$ 公里。\n- 案例 3：$L = 1000$ 公里。\n\n你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，$\\texttt{[result1,result2,result3]}$）。这三个浮点数必须是按上述顺序列出的三个案例的 Frobenius 范数。不应打印任何额外文本。必须通过固定一个可复现的种子来控制随机性，以确保跨次运行的输出是确定性的。",
            "solution": "该问题是有效的，因为它构成了一个在序贯数据同化领域的适定、有科学依据且客观的练习，而序贯数据同化是遥感和环境建模的核心课题。它要求构建和比较标准及局地化的 Kalman 增益，这些是集合 Kalman 滤波 (EnKF) 中的基本概念。所有参数都已明确定义，且任务在计算上是可行的。我们开始提供解答。\n\n此问题的核心在于计算 Kalman 增益，它是一个将先验状态信息与新观测值进行最优结合的矩阵。其最优性源于在线性高斯假设下最小化分析误差协方差，这等价于对状态估计进行贝叶斯更新。标准的 Kalman 增益 $\\mathbf{K}$ 由下式给出：\n$$\n\\mathbf{K} = \\mathbf{P}_{xx} \\mathbf{H}^T (\\mathbf{H} \\mathbf{P}_{xx} \\mathbf{H}^T + \\mathbf{R})^{-1}\n$$\n其中 $\\mathbf{P}_{xx}$ 是先验状态误差协方差，$\\mathbf{H}$ 是观测算子，$\\mathbf{R}$ 是观测误差协方差。在 EnKF 的背景下，$\\mathbf{P}_{xx}$ 是从一个集合中估计出的样本协方差，由于集合大小有限，它可能包含虚假的远程相关。协方差局地化是一种通过对样本协方差进行滤波来缓解此问题的技术。\n\n解决方案通过以下步骤构建：\n1.  定义模型网格并构建线性观测算子 $\\mathbf{H}$。\n2.  从指定的真实协方差函数 $\\mathbf{C}$ 生成先验集合，并计算样本先验协方差 $\\mathbf{P}_{xx}$。\n3.  基于 Gaspari-Cohn 函数为每个指定的局地化半径构建局地化矩阵 $\\mathbf{L}$。\n4.  计算未局地化的 Kalman 增益 $\\mathbf{K}$ 和局地化的增益 $\\mathbf{K}_{\\mathrm{loc}}$。\n5.  为每个测试案例计算差值的 Frobenius 范数 $\\|\\mathbf{K}_{\\mathrm{loc}} - \\mathbf{K}\\|_{F}$。\n\n**1. 网格和观测算子 $\\mathbf{H}$**\n\n状态向量 $\\mathbf{x} \\in \\mathbb{R}^{n}$ 表示一个包含 $n=20$ 个点的一维网格上的土壤湿度。网格点以 $\\Delta x = 10 \\text{ km}$ 的间距均匀分布，位置为 $x_i = i \\cdot \\Delta x$，其中 $i = 0, 1, \\dots, 19$。物理域范围从 $0 \\text{ km}$ 到 $190 \\text{ km}$。\n\n观测算子 $\\mathbf{H} \\in \\mathbb{R}^{m \\times n}$（其中 $m=3, n=20$）将状态空间映射到观测空间。$m=3$ 个观测值中的每一个都代表了特定足迹上状态值的平均值。足迹中心位于 $c_1=50 \\text{ km}$，$c_2=100 \\text{ km}$ 和 $c_3=150 \\text{ km}$。每个足迹的半径为 $r_{\\mathrm{fp}} = 15 \\text{ km}$。\n\n如果网格点 $i$（位于 $x_i$ 位置）落在观测 $j$（中心在 $c_j$）的足迹内，即 $|x_i - c_j| \\le r_{\\mathrm{fp}}$，则观测算子的元素 $H_{ji}$ 非零。权重是均匀的，因此对于每个观测 $j$，如果其足迹内的网格点数量为 $N_j$，那么对于这些点 $H_{ji} = 1/N_j$，否则 $H_{ji} = 0$。\n\n-   **观测 1 ($c_1=50 \\text{ km}$):** 足迹覆盖 $[35, 65] \\text{ km}$ 范围。此范围内的网格点为 $x_4=40 \\text{ km}$，$x_5=50 \\text{ km}$ 和 $x_6=60 \\text{ km}$。因此，$N_1=3$，$\\mathbf{H}$ 的第一行条目为 $H_{1,4}=H_{1,5}=H_{1,6}=1/3$。\n-   **观测 2 ($c_2=100 \\text{ km}$):** 足迹覆盖 $[85, 115] \\text{ km}$ 范围。网格点为 $x_9=90 \\text{ km}$，$x_{10}=100 \\text{ km}$ 和 $x_{11}=110 \\text{ km}$。因此，$N_2=3$，第二行的条目为 $H_{2,9}=H_{2,10}=H_{2,11}=1/3$。\n-   **观测 3 ($c_3=150 \\text{ km}$):** 足迹覆盖 $[135, 165] \\text{ km}$ 范围。网格点为 $x_{14}=140 \\text{ km}$，$x_{15}=150 \\text{ km}$ 和 $x_{16}=160 \\text{ km}$。因此，$N_3=3$，第三行的条目为 $H_{3,14}=H_{3,15}=H_{3,16}=1/3$。\n\n$\\mathbf{H}$ 的所有其他元素均为零。观测误差协方差给定为 $\\mathbf{R} = s^2 \\mathbf{I}_3$，其中 $s^2=0.01$，$\\mathbf{I}_3$ 是 $3 \\times 3$ 的单位矩阵。\n\n**2. 先验集合和样本协方差 $\\mathbf{P}_{xx}$**\n\n关于状态的先验信念被建模为一个零均值高斯随机场。任意两个网格点 $i$ 和 $j$ 之间的真实协方差由平方指数函数给出：\n$$\nC_{ij} = \\sigma^2 \\exp\\left(-\\frac{r_{ij}^2}{2 \\ell^2}\\right)\n$$\n其中方差 $\\sigma^2 = 0.04$，相关长度 $\\ell = 40 \\text{ km}$，而 $r_{ij} = |x_i - x_j| = |i-j| \\Delta x$ 是点之间的物理距离。\n\n从多元正态分布 $\\mathcal{N}(\\mathbf{0}, \\mathbf{C})$ 中抽取一个由 $M=100$ 个状态向量组成的集合 $\\{\\mathbf{x}^{(k)}\\}_{k=1}^{M}$。固定的随机种子确保了可复现性。从这个集合中，样本协方差矩阵 $\\mathbf{P}_{xx} \\in \\mathbb{R}^{n \\times n}$ 按如下方式计算：\n$$\n\\mathbf{P}_{xx} = \\frac{1}{M-1} \\sum_{k=1}^{M} (\\mathbf{x}^{(k)} - \\bar{\\mathbf{x}})(\\mathbf{x}^{(k)} - \\bar{\\mathbf{x}})^T\n$$\n其中 $\\bar{\\mathbf{x}}$ 是集合的样本均值。\n\n**3. 协方差局地化和矩阵 $\\mathbf{L}$**\n\n为了抵消 $\\mathbf{P}_{xx}$ 中的虚假远程相关，通过与一个局地化矩阵 $\\mathbf{L}$ 进行逐元素积来应用局地化。$\\mathbf{L}$ 的元素由 Gaspari-Cohn 5阶紧支集相关函数 $\\rho(r)$ 定义为 $L_{ij} = \\rho(r_{ij})$。此函数依赖于物理距离 $r_{ij}$ 和一个指定的局地化半径 $L$。我们将 $L$ 解释为该函数的特征尺度参数，使其支集延伸到 $2L$ 的距离。多项式的自变量是 $z = r/L$。\n\nGaspari-Cohn 函数分段定义如下：\n$$\n\\rho(z) =\n\\begin{cases}\n-\\frac{1}{4}z^5 + \\frac{1}{2}z^4 + \\frac{5}{8}z^3 - \\frac{5}{3}z^2 + 1  \\text{if } 0 \\le z \\le 1 \\\\\n\\frac{1}{12}z^5 - \\frac{1}{2}z^4 + \\frac{5}{8}z^3 + \\frac{5}{3}z^2 - 5z + 4 - \\frac{2}{3z}  \\text{if } 1  z \\le 2 \\\\\n0  \\text{if } z > 2\n\\end{cases}\n$$\n对于每个测试案例（$L=5, 30, 1000 \\text{ km}$），通过对所有网格点对 $(i, j)$ 计算 $\\rho(r_{ij}/L)$ 来构建相应的矩阵 $\\mathbf{L}$。\n\n**4. Kalman 增益计算**\n\n未局地化的 Kalman 增益 $\\mathbf{K}$ 使用样本协方差 $\\mathbf{P}_{xx}$ 和标准公式计算。首先计算局地化的协方差：\n$$\n\\mathbf{P}^{\\mathrm{loc}}_{xx} = \\mathbf{P}_{xx} \\circ \\mathbf{L}\n$$\n其中 $\\circ$ 表示 Hadamard（逐元素）积。然后使用此局地化协方差计算局地化的 Kalman 增益 $\\mathbf{K}_{\\mathrm{loc}}$：\n$$\n\\mathbf{K}_{\\mathrm{loc}} = \\mathbf{P}^{\\mathrm{loc}}_{xx} \\mathbf{H}^T (\\mathbf{H} \\mathbf{P}^{\\mathrm{loc}}_{xx} \\mathbf{H}^T + \\mathbf{R})^{-1}\n$$\n\n**5. 比较度量**\n\n最后，对于每个测试案例，两个增益之间的定量差异通过它们差矩阵的 Frobenius 范数来衡量：\n$$\n\\text{metric} = \\left\\|\\mathbf{K}_{\\mathrm{loc}} - \\mathbf{K}\\right\\|_{F} = \\sqrt{\\sum_{i=1}^{n} \\sum_{j=1}^{m} |(K_{\\mathrm{loc}})_{ij} - K_{ij}|^2}\n$$\n然后收集三个测试案例的结果。\n\n-   对于 $L=5 \\text{ km}$，该值小于 $10 \\text{ km}$ 的网格间距，因此对于所有 $i \\neq j$ 都有 $r_{ij}/L \\ge 2$。因此 $\\mathbf{L}$ 成为单位矩阵，局地化效应最强，差异预计会很大。\n-   对于 $L=1000 \\text{ km}$，该值远大于 $190 \\text{ km}$ 的区域大小，$r_{ij}/L$ 对于所有点对都非常小。因此 $\\rho(r_{ij}/L) \\approx 1$，使得 $\\mathbf{L}$ 成为一个全一矩阵。局地化效果微乎其微，差异预计会非常小。\n-   对于 $L=30 \\text{ km}$，局地化效果是中等的，产生的度量值介于其他两种情况之间。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes an EnKF-related metric for three test cases.\n    \"\"\"\n    # Fix seed for reproducibility\n    seed = 42\n    rng = np.random.default_rng(seed)\n\n    # 1. Grid and Observation Setup\n    n = 20  # Number of grid points\n    dx = 10.0  # Grid spacing in km\n    grid_points = np.arange(n) * dx\n\n    m = 3  # Number of observations\n    obs_centers = np.array([50.0, 100.0, 150.0])\n    r_fp = 15.0  # Footprint radius in km\n    s2 = 0.01  # Observation error variance\n\n    # Construct observation operator H\n    H = np.zeros((m, n))\n    for j in range(m):\n        center = obs_centers[j]\n        # Find grid points within the footprint\n        indices = np.where(np.abs(grid_points - center) = r_fp)[0]\n        if indices.size > 0:\n            H[j, indices] = 1.0 / indices.size\n\n    # Construct observation error covariance matrix R\n    R = np.diag(np.full(m, s2))\n\n    # 2. Prior Ensemble Generation\n    M = 100  # Ensemble size\n    sigma2 = 0.04  # Prior variance\n    ell = 40.0  # Correlation length in km\n\n    # Construct true prior covariance matrix C\n    dist_matrix = np.abs(np.subtract.outer(grid_points, grid_points))\n    C = sigma2 * np.exp(-dist_matrix**2 / (2 * ell**2))\n\n    # Generate ensemble\n    # multivariate_normal returns (size, dim), we want (dim, size) for our convention\n    mean_vec = np.zeros(n)\n    ensemble = rng.multivariate_normal(mean_vec, C, size=M).T\n\n    # Compute sample prior covariance P_xx\n    # np.cov expects (features, samples), which matches our (n, M) shape\n    P_xx = np.cov(ensemble, rowvar=True)\n    \n    # Define the Gaspari-Cohn localization function\n    def gaspari_cohn(r, L):\n        \"\"\"\n        Computes the Gaspari-Cohn 5th-order correlation function.\n        r: distance array\n        L: localization radius parameter\n        \"\"\"\n        # Suppress divide-by-zero warnings for r=0, which is handled\n        with np.errstate(divide='ignore', invalid='ignore'):\n            z = np.abs(r) / L\n        \n        rho = np.zeros_like(z)\n        \n        # Case 1: 0 = z = 1\n        mask1 = z = 1\n        z1 = z[mask1]\n        rho[mask1] = ((-1/4 * z1**5) + (1/2 * z1**4) + (5/8 * z1**3) - \n                      (5/3 * z1**2) + 1)\n        \n        # Case 2: 1  z = 2\n        mask2 = (z > 1)  (z = 2)\n        z2 = z[mask2]\n        # Check for z2 being zero to avoid division by zero, although z > 1\n        # should prevent this. It is good practice.\n        non_zero_z2 = z2 != 0\n        rho_z2 = np.zeros_like(z2)\n        if np.any(non_zero_z2):\n             rho_z2[non_zero_z2] = ((1/12 * z2[non_zero_z2]**5) - \\\n               (1/2 * z2[non_zero_z2]**4) + (5/8 * z2[non_zero_z2]**3) + \\\n               (5/3 * z2[non_zero_z2]**2) - (5 * z2[non_zero_z2]) + 4 - \\\n               (2/3 / z2[non_zero_z2]))\n        rho[mask2] = rho_z2\n        \n        return rho\n\n    # 3. Compute unlocalized Kalman Gain\n    # K = P_xx H^T (H P_xx H^T + R)^-1\n    H_Pxx_HT = H @ P_xx @ H.T\n    inv_term_unloc = np.linalg.inv(H_Pxx_HT + R)\n    K_unloc = P_xx @ H.T @ inv_term_unloc\n\n    # Test suite\n    test_cases = [5.0, 30.0, 1000.0]  # Localization radii L in km\n    results = []\n\n    for L in test_cases:\n        # a. Construct localization matrix L\n        loc_matrix = gaspari_cohn(dist_matrix, L)\n        \n        # b. Compute localized covariance and gain\n        P_loc = P_xx * loc_matrix  # Hadamard product\n        \n        H_Ploc_HT = H @ P_loc @ H.T\n        inv_term_loc = np.linalg.inv(H_Ploc_HT + R)\n        K_loc = P_loc @ H.T @ inv_term_loc\n        \n        # c. Compute the Frobenius norm of the difference\n        diff_norm = np.linalg.norm(K_loc - K_unloc, 'fro')\n        results.append(diff_norm)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.8f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}