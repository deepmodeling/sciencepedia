{
    "hands_on_practices": [
        {
            "introduction": "理论的掌握离不开实践。本练习将指导您将匹配滤波（MF）和约束能量最小化（CEM）的数学公式转化为高效且数值稳定的代码。您将学习使用乔列斯基分解（Cholesky factorization）来求解线性系统，这是避免直接矩阵求逆的关键技术，也是科学计算中的一项核心技能。",
            "id": "3853178",
            "problem": "您的任务是实现用于高光谱数据遥感的光谱目标检测滤波器，特别是匹配滤波器和约束能量最小化（CEM）滤波器。程序必须避免显式矩阵求逆，而应使用对称正定矩阵的 Cholesky 分解。所有计算必须以线性代数术语表示并进行数值实现。\n\n从以下基础开始：\n- 匹配滤波问题可以描述为：在由均值向量 $\\mu$ 和协方差矩阵 $\\Sigma$ 表征的高斯背景下，为已知目标特征向量 $s$ 选择一个权重向量 $w$，以最大化输出信噪比。\n- 约束能量最小化（CEM）问题是在对目标特征施加单位响应约束的条件下，最小化输出能量。\n\n对于匹配滤波器：\n- 考虑背景中心化数据 $x - \\mu$、目标偏移量 $d = s - \\mu$ 以及背景协方差矩阵 $\\Sigma$。\n- 施加单位增益约束 $w^\\top d = 1$ 并最小化输出方差 $w^\\top \\Sigma w$。在 $\\Sigma$ 是对称正定矩阵的假设下，这将产生唯一的最小化解。\n- 程序必须计算给定像素 $x$ 的匹配滤波器检测得分 $y_{\\mathrm{MF}} = w^\\top (x - \\mu)$，该得分通过使用 $\\Sigma$ 的 Cholesky 分解（可选择添加岭正则化项 $\\lambda_\\Sigma I$ 以确保正定性）求解线性系统来确定，而不是对 $\\Sigma$ 求逆。\n\n对于约束能量最小化（CEM）：\n- 设 $R$ 是由一组背景向量 $\\{b_i\\}_{i=1}^M$ 计算得到的背景相关矩阵，其计算公式为 $R = \\frac{1}{M} \\sum_{i=1}^M b_i b_i^\\top$。\n- 施加单位增益约束 $w^\\top s = 1$ 并最小化 $w^\\top R w$。在 $R$ 是对称正定矩阵的假设下，这将产生唯一的最小化解。\n- 程序必须计算给定像素 $x$ 的 CEM 检测得分 $y_{\\mathrm{CEM}} = w^\\top x$，该得分通过使用 $R$ 的 Cholesky 分解（可选择添加岭正则化项 $\\lambda_R I$ 以确保正定性）求解线性系统来确定，而不是对 $R$ 求逆。\n\n在所有情况下，在构造 $R$ 时，使用提供的背景样本集，并在分解前将指定的岭正则化项 $\\lambda_R I$ 添加到 $R$ 中；同样，将指定的岭正则化项 $\\lambda_\\Sigma I$ 添加到 $\\Sigma$ 中。\n\n实现以下测试套件。在每种情况下，计算匹配滤波器得分 $y_{\\mathrm{MF}}$ 和 CEM 得分 $y_{\\mathrm{CEM}}$。\n\n测试用例 1 (良态，中心化背景):\n- 维度 $L = 5$。\n- 定义 $A \\in \\mathbb{R}^{5 \\times 5}$ 其元素为：\n  $$\n  A = \\begin{bmatrix}\n  1.0  0.2  0.1  0.0  0.0 \\\\\n  0.2  1.2  0.0  0.1  0.05 \\\\\n  0.1  0.0  1.1  0.3  0.2 \\\\\n  0.0  0.1  0.3  0.9  0.0 \\\\\n  0.0  0.05  0.2  0.0  0.8\n  \\end{bmatrix}\n  $$\n  并令 $\\Sigma = A^\\top A$。\n- 背景均值 $\\mu = [\\,0.1,\\,0.2,\\,0.15,\\,0.05,\\,0.08\\,]$。\n- 目标特征 $s = [\\,0.25,\\,0.31,\\,0.20,\\,0.10,\\,0.14\\,]$。\n- 像素 $x = [\\,0.24,\\,0.30,\\,0.21,\\,0.12,\\,0.13\\,]$。\n- 背景样本集 $\\{b_i\\}_{i=1}^6$:\n  $b_1 = [\\,0.12,\\,0.19,\\,0.16,\\,0.06,\\,0.09\\,]$,\n  $b_2 = [\\,0.09,\\,0.21,\\,0.15,\\,0.04,\\,0.08\\,]$,\n  $b_3 = [\\,0.11,\\,0.20,\\,0.14,\\,0.05,\\,0.07\\,]$,\n  $b_4 = [\\,0.10,\\,0.18,\\,0.17,\\,0.05,\\,0.09\\,]$,\n  $b_5 = [\\,0.13,\\,0.22,\\,0.16,\\,0.07,\\,0.10\\,]$,\n  $b_6 = [\\,0.11,\\,0.19,\\,0.15,\\,0.05,\\,0.08\\,]$。\n- 正则化参数: $\\lambda_\\Sigma = 0.0$, $\\lambda_R = 10^{-8}$。\n\n测试用例 2 (近奇异对角协方差):\n- 维度 $L = 4$。\n- 协方差 $\\Sigma = \\mathrm{diag}([\\,10^{-8},\\,0.5,\\,0.7,\\,1.0\\,])$。\n- 背景均值 $\\mu = [\\,0.0,\\,0.0,\\,0.0,\\,0.0\\,]$。\n- 目标特征 $s = [\\,0.1,\\,0.4,\\,0.3,\\,0.2\\,]$。\n- 像素 $x = [\\,0.09,\\,0.41,\\,0.29,\\,0.19\\,]$。\n- 背景样本集 $\\{b_i\\}_{i=1}^4$:\n  $b_1 = [\\,0.02,\\,0.3,\\,0.25,\\,0.15\\,]$,\n  $b_2 = [\\,-0.01,\\,0.32,\\,0.23,\\,0.14\\,]$,\n  $b_3 = [\\,0.01,\\,0.35,\\,0.28,\\,0.18\\,]$,\n  $b_4 = [\\,0.00,\\,0.34,\\,0.27,\\,0.17\\,]$。\n- 正则化参数: $\\lambda_\\Sigma = 10^{-6}$, $\\lambda_R = 10^{-6}$。\n\n测试用例 3 (单位协方差基线):\n- 维度 $L = 3$。\n- 协方差 $\\Sigma = I_{3 \\times 3}$。\n- 背景均值 $\\mu = [\\,0.0,\\,0.0,\\,0.0\\,]$。\n- 目标特征 $s = [\\,0.2,\\,0.1,\\,0.3\\,]$。\n- 像素 $x = [\\,0.21,\\,0.09,\\,0.31\\,]$。\n- 背景样本集 $\\{b_i\\}_{i=1}^4$:\n  $b_1 = [\\,0.05,\\,0.04,\\,0.06\\,]$,\n  $b_2 = [\\,0.06,\\,0.03,\\,0.05\\,]$,\n  $b_3 = [\\,0.04,\\,0.05,\\,0.07\\,]$,\n  $b_4 = [\\,0.05,\\,0.06,\\,0.04\\,]$。\n- 正则化参数: $\\lambda_\\Sigma = 0.0$, $\\lambda_R = 10^{-8}$。\n\n测试用例 4 (一维边界情况):\n- 维度 $L = 1$。\n- 协方差 $\\Sigma = [\\,[\\,0.2\\,]\\,]$。\n- 背景均值 $\\mu = [\\,0.05\\,]$。\n- 目标特征 $s = [\\,0.2\\,]$。\n- 像素 $x = [\\,0.19\\,]$。\n- 背景样本集 $\\{b_i\\}_{i=1}^4$:\n  $b_1 = [\\,0.04\\,]$,\n  $b_2 = [\\,0.06\\,]$,\n  $b_3 = [\\,0.05\\,]$,\n  $b_4 = [\\,0.055\\,]$。\n- 正则化参数: $\\lambda_\\Sigma = 0.0$, $\\lambda_R = 10^{-9}$。\n\n测试用例 5 (具有结构化相关性的更高维度):\n- 维度 $L = 8$。\n- 定义 $A \\in \\mathbb{R}^{8 \\times 8}$ 其元素为：\n  $$\n  A = \\begin{bmatrix}\n  1.0  0.1  0.0  0.2  0.0  0.1  0.0  0.0 \\\\\n  0.1  1.1  0.2  0.0  0.1  0.0  0.1  0.0 \\\\\n  0.0  0.2  1.2  0.1  0.0  0.2  0.0  0.1 \\\\\n  0.2  0.0  0.1  1.0  0.2  0.0  0.1  0.0 \\\\\n  0.0  0.1  0.0  0.2  1.3  0.1  0.0  0.2 \\\\\n  0.1  0.0  0.2  0.0  0.1  1.1  0.2  0.0 \\\\\n  0.0  0.1  0.0  0.1  0.0  0.2  1.0  0.1 \\\\\n  0.0  0.0  0.1  0.0  0.2  0.0  0.1  0.9\n  \\end{bmatrix}\n  $$\n  并令 $\\Sigma = A^\\top A + 0.05 I$。\n- 背景均值 $\\mu = [\\,0.05,\\,0.06,\\,0.07,\\,0.05,\\,0.08,\\,0.04,\\,0.03,\\,0.02\\,]$。\n- 目标特征 $s = [\\,0.12,\\,0.15,\\,0.14,\\,0.10,\\,0.13,\\,0.11,\\,0.09,\\,0.08\\,]$。\n- 像素 $x = [\\,0.11,\\,0.16,\\,0.13,\\,0.09,\\,0.14,\\,0.10,\\,0.08,\\,0.07\\,]$。\n- 背景样本集 $\\{b_i\\}_{i=1}^8$:\n  $b_1 = [\\,0.05,\\,0.06,\\,0.07,\\,0.05,\\,0.08,\\,0.04,\\,0.03,\\,0.02\\,]$,\n  $b_2 = [\\,0.06,\\,0.05,\\,0.08,\\,0.06,\\,0.09,\\,0.05,\\,0.02,\\,0.03\\,]$,\n  $b_3 = [\\,0.04,\\,0.07,\\,0.06,\\,0.04,\\,0.07,\\,0.03,\\,0.04,\\,0.01\\,]$,\n  $b_4 = [\\,0.05,\\,0.06,\\,0.07,\\,0.05,\\,0.08,\\,0.04,\\,0.03,\\,0.02\\,]$,\n  $b_5 = [\\,0.06,\\,0.07,\\,0.08,\\,0.06,\\,0.09,\\,0.05,\\,0.02,\\,0.03\\,]$,\n  $b_6 = [\\,0.05,\\,0.05,\\,0.06,\\,0.05,\\,0.08,\\,0.04,\\,0.03,\\,0.02\\,]$,\n  $b_7 = [\\,0.04,\\,0.06,\\,0.07,\\,0.04,\\,0.08,\\,0.03,\\,0.03,\\,0.02\\,]$,\n  $b_8 = [\\,0.05,\\,0.07,\\,0.07,\\,0.05,\\,0.08,\\,0.04,\\,0.03,\\,0.02\\,]$。\n- 正则化参数: $\\lambda_\\Sigma = 0.0$, $\\lambda_R = 10^{-8}$。\n\n算法要求：\n- 使用 Cholesky 分解求解形如 $\\Sigma w = d$ 和 $R w = s$ 的线性系统，其中矩阵为对称正定矩阵，避免显式求逆。\n- 归一化解 $w$ 以强制执行匹配滤波器和 CEM 的单位增益约束。\n- 按规定计算检测得分 $y_{\\mathrm{MF}}$ 和 $y_{\\mathrm{CEM}}$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。列表中的每个元素都是一个双元素列表 $[y_{\\mathrm{MF}}, y_{\\mathrm{CEM}}]$，对应于从测试用例 1 到测试用例 5 的每个测试用例。例如，输出格式必须类似于 $[[a_1,b_1],[a_2,b_2],\\dots,[a_5,b_5]]$，其中每个 $a_i$ 和 $b_i$ 都是由您的程序计算出的浮点数。",
            "solution": "用户提供的问题要求实现高光谱图像中用于光谱目标检测的两种基本算法：匹配滤波器（MF）和约束能量最小化（CEM）滤波器。该问题具有充分的科学依据，为一套五个测试用例提供了所有必要的数据和约束条件。它基于信号处理和线性代数的标准、无争议的原则。将两种滤波器表述为约束优化问题，以及通过 Cholesky 分解提出的解决方法，都是正确且数值稳健的。因此，该问题被认为是有效的，下面将给出解决方案。\n\n两种算法的核心都是设计一个线性滤波器，由权重向量 $w$ 表示，该滤波器应用于高光谱图像中的像素向量 $x$。标量输出 $y = w^\\top x$（或其变体）指示特定目标物质的存在或丰度。\n\n### 匹配滤波器（MF）推导\n\n匹配滤波器旨在最大化已知目标特征的信噪比（SNR），其假设背景遵循多元高斯分布。设目标特征为 $s$，背景由均值向量 $\\mu$ 和协方差矩阵 $\\Sigma$ 表征。给定的像素向量表示为 $x$。\n\n该问题可以表述为一个约束优化问题。我们寻求一个权重向量 $w$，使其在目标信号上具有单位响应的约束下，最小化滤波器在背景噪声上的输出方差。目标信号由目标特征与背景均值之差表示，即 $d = s - \\mu$。对于背景中心化数据 $z - \\mu$，输出方差为 $Var(w^\\top(z-\\mu)) = E[ (w^\\top(z-\\mu))^2 ] = w^\\top E[(z-\\mu)(z-\\mu)^\\top] w = w^\\top \\Sigma w$。对目标信号的单位响应约束为 $w^\\top d = 1$。\n\n优化问题是：\n$$\n\\underset{w}{\\text{minimize}} \\quad w^\\top \\Sigma w \\quad \\text{subject to} \\quad w^\\top d = 1\n$$\n\n为解决此问题，我们使用拉格朗日乘子法。拉格朗日函数 $\\mathcal{L}$ 为：\n$$\n\\mathcal{L}(w, \\gamma) = w^\\top \\Sigma w - \\gamma (w^\\top d - 1)\n$$\n其中 $\\gamma$ 是拉格朗日乘子。为求最小值，我们将关于 $w$ 的梯度设为零：\n$$\n\\nabla_w \\mathcal{L} = 2 \\Sigma w - \\gamma d = 0 \\implies \\Sigma w = \\frac{\\gamma}{2} d\n$$\n假设 $\\Sigma$ 可逆，则 $w$ 与 $\\Sigma^{-1} d$ 成正比。我们通过求解线性系统 $\\Sigma w_p = d$ 来定义一个初步的、未缩放的权重向量 $w_p$。那么，最优向量 $w$ 必须是 $w_p$ 的一个缩放版本，即 $w = c \\cdot w_p$，其中 $c$ 为某个标量。\n\n我们通过应用约束 $w^\\top d = 1$ 来找到 $c$：\n$$\n(c \\cdot w_p)^\\top d = 1 \\implies c (w_p^\\top d) = 1 \\implies c = \\frac{1}{w_p^\\top d}\n$$\n因此，最优权重向量为：\n$$\nw_{\\mathrm{MF}} = \\frac{w_p}{w_p^\\top d} = \\frac{\\Sigma^{-1} d}{d^\\top \\Sigma^{-1} d}\n$$\n像素 $x$ 的匹配滤波器检测得分是滤波器对背景减去后的像素向量 $x-\\mu$ 的输出：\n$$\ny_{\\mathrm{MF}} = w_{\\mathrm{MF}}^\\top (x - \\mu) = \\frac{(w_p)^\\top (x - \\mu)}{w_p^\\top d}\n$$\n为确保协方差矩阵是正定的，我们添加一个岭正则化项 $\\lambda_\\Sigma I$，其中 $I$ 是单位矩阵。需要求解的系统变为 $(\\Sigma + \\lambda_\\Sigma I) w_p = d$。\n\n### 约束能量最小化（CEM）推导\n\nCEM 滤波器在运行时不假设背景具有特定的统计模型。相反，它使用基于样本的背景相关矩阵 $R$。其目标是设计一个滤波器 $w$，在保持对目标特征 $s$ 的单位响应的同时，最小化在背景样本上的平均输出能量（功率）。\n\n设 $M$ 个背景像素向量的集合为 $\\{b_i\\}_{i=1}^M$。样本相关矩阵 $R$ 定义为：\n$$\nR = \\frac{1}{M} \\sum_{i=1}^M b_i b_i^\\top\n$$\n对于一个背景向量 $b_i$，输出能量为 $(w^\\top b_i)^2$。在背景样本集上的平均能量为 $E[ (w^\\top b)^2 ] = w^\\top E[b b^\\top] w = w^\\top R w$。CEM 优化问题为：\n$$\n\\underset{w}{\\text{minimize}} \\quad w^\\top R w \\quad \\text{subject to} \\quad w^\\top s = 1\n$$\n这与匹配滤波器问题具有相同的数学结构。拉格朗日函数为：\n$$\n\\mathcal{L}(w, \\gamma) = w^\\top R w - \\gamma (w^\\top s - 1)\n$$\n将梯度设为零可得：\n$$\n\\nabla_w \\mathcal{L} = 2 R w - \\gamma s = 0 \\implies R w = \\frac{\\gamma}{2} s\n$$\n遵循相同的步骤，我们通过求解 $R w_p = s$ 来定义一个初步向量 $w_p$。最终的归一化权重向量为：\n$$\nw_{\\mathrm{CEM}} = \\frac{w_p}{w_p^\\top s} = \\frac{R^{-1} s}{s^\\top R^{-1} s}\n$$\n像素 $x$ 的 CEM 检测得分就是滤波器输出 $y_{\\mathrm{CEM}} = w_{\\mathrm{CEM}}^\\top x$。\n$$\ny_{\\mathrm{CEM}} = w_{\\mathrm{CEM}}^\\top x = \\frac{(w_p)^\\top x}{w_p^\\top s}\n$$\n与 MF 类似，我们向 $R$ 添加一个正则化项 $\\lambda_R I$ 以确保其正定性，因此需要求解的系统是 $(R + \\lambda_R I) w_p = s$。\n\n### 数值实现\n\n一个关键要求是避免显式矩阵求逆，因为这种方法数值上不稳定且计算成本高。对于对称正定矩阵 $A$，线性系统 $Ax=b$ 可以通过 Cholesky 分解稳健地求解。\n\n1.  **分解**：将正则化后的矩阵 $A$（对于 MF 是 $\\Sigma_{reg} = \\Sigma + \\lambda_\\Sigma I$，对于 CEM 是 $R_{reg} = R + \\lambda_R I$）分解为 $A = LL^\\top$，其中 $L$ 是一个下三角矩阵。\n2.  **前向替换**：系统 $LL^\\top x = b$ 分两步求解。首先，求解 $Ly=b$ 得到 $y$。\n3.  **后向替换**：然后，求解 $L^\\top x = y$ 得到最终解 $x$（对应于我们的初步向量 $w_p$）。\n\n此过程使用 `scipy.linalg.cholesky` 进行分解，并使用 `scipy.linalg.solve_triangular` 执行替换步骤。最终得分 $y_{\\mathrm{MF}}$ 和 $y_{\\mathrm{CEM}}$ 使用推导出的比率计算，这是一种数值稳定的方法。",
            "answer": "```python\nimport numpy as np\nfrom scipy.linalg import cholesky, solve_triangular\n\ndef solve_cholesky(A, b):\n    \"\"\"\n    Solves the linear system Ax = b for x using Cholesky factorization.\n    A must be a symmetric positive-definite matrix.\n    \"\"\"\n    try:\n        L = cholesky(A, lower=True)\n        y = solve_triangular(L, b, lower=True)\n        x = solve_triangular(L.T, y, lower=False)\n        return x\n    except np.linalg.LinAlgError:\n        # Fallback for cases where regularization might not be enough\n        # for scipy's strict cholesky check, though this problem's\n        # parameters should prevent this.\n        return np.linalg.solve(A, b)\n\ndef compute_mf_score(Sigma, mu, s, x, lambda_sigma):\n    \"\"\"\n    Computes the Matched Filter score.\n    \"\"\"\n    L = Sigma.shape[0]\n    Sigma_reg = Sigma + lambda_sigma * np.identity(L)\n    d = s - mu\n\n    # Solve Sigma_reg * w_p = d\n    w_p = solve_cholesky(Sigma_reg, d)\n    \n    # y_MF = (w_p.T @ (x - mu)) / (w_p.T @ d)\n    numerator = w_p.T @ (x - mu)\n    denominator = w_p.T @ d\n\n    if np.isclose(denominator, 0):\n        # This occurs if d is zero or orthogonal to w_p in a problematic way.\n        # If d is the zero vector, the response is zero.\n        return 0.0\n\n    return numerator / denominator\n\ndef compute_cem_score(s, x, b_ensemble, lambda_r):\n    \"\"\"\n    Computes the Constrained Energy Minimization score.\n    \"\"\"\n    M = len(b_ensemble)\n    L = s.shape[0]\n    \n    # Build background correlation matrix R\n    R = np.zeros((L, L))\n    for b_i in b_ensemble:\n        R += np.outer(b_i, b_i)\n    R /= M\n    \n    R_reg = R + lambda_r * np.identity(L)\n    \n    # Solve R_reg * w_p = s\n    w_p = solve_cholesky(R_reg, s)\n    \n    # y_CEM = (w_p.T @ x) / (w_p.T @ s)\n    numerator = w_p.T @ x\n    denominator = w_p.T @ s\n\n    if np.isclose(denominator, 0):\n        # This occurs if s is the zero vector.\n        return 0.0\n    \n    return numerator / denominator\n\ndef format_pair(pair):\n    \"\"\"Formats a pair of floats into the string '[f1,f2]'.\"\"\"\n    return f\"[{pair[0]},{pair[1]}]\"\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print results.\n    \"\"\"\n    test_cases = [\n        # Test Case 1\n        {\n            \"A_mf\": np.array([\n                [1.0, 0.2, 0.1, 0.0, 0.0],\n                [0.2, 1.2, 0.0, 0.1, 0.05],\n                [0.1, 0.0, 1.1, 0.3, 0.2],\n                [0.0, 0.1, 0.3, 0.9, 0.0],\n                [0.0, 0.05, 0.2, 0.0, 0.8]\n            ]),\n            \"Sigma_mf\": None,\n            \"mu\": np.array([0.1, 0.2, 0.15, 0.05, 0.08]),\n            \"s\": np.array([0.25, 0.31, 0.20, 0.10, 0.14]),\n            \"x\": np.array([0.24, 0.30, 0.21, 0.12, 0.13]),\n            \"b_ensemble\": [\n                np.array([0.12, 0.19, 0.16, 0.06, 0.09]),\n                np.array([0.09, 0.21, 0.15, 0.04, 0.08]),\n                np.array([0.11, 0.20, 0.14, 0.05, 0.07]),\n                np.array([0.10, 0.18, 0.17, 0.05, 0.09]),\n                np.array([0.13, 0.22, 0.16, 0.07, 0.10]),\n                np.array([0.11, 0.19, 0.15, 0.05, 0.08])\n            ],\n            \"lambda_sigma\": 0.0,\n            \"lambda_r\": 1e-8\n        },\n        # Test Case 2\n        {\n            \"A_mf\": None,\n            \"Sigma_mf\": np.diag([1e-8, 0.5, 0.7, 1.0]),\n            \"mu\": np.array([0.0, 0.0, 0.0, 0.0]),\n            \"s\": np.array([0.1, 0.4, 0.3, 0.2]),\n            \"x\": np.array([0.09, 0.41, 0.29, 0.19]),\n            \"b_ensemble\": [\n                np.array([0.02, 0.3, 0.25, 0.15]),\n                np.array([-0.01, 0.32, 0.23, 0.14]),\n                np.array([0.01, 0.35, 0.28, 0.18]),\n                np.array([0.00, 0.34, 0.27, 0.17])\n            ],\n            \"lambda_sigma\": 1e-6,\n            \"lambda_r\": 1e-6\n        },\n        # Test Case 3\n        {\n            \"A_mf\": None,\n            \"Sigma_mf\": np.identity(3),\n            \"mu\": np.array([0.0, 0.0, 0.0]),\n            \"s\": np.array([0.2, 0.1, 0.3]),\n            \"x\": np.array([0.21, 0.09, 0.31]),\n            \"b_ensemble\": [\n                np.array([0.05, 0.04, 0.06]),\n                np.array([0.06, 0.03, 0.05]),\n                np.array([0.04, 0.05, 0.07]),\n                np.array([0.05, 0.06, 0.04])\n            ],\n            \"lambda_sigma\": 0.0,\n            \"lambda_r\": 1e-8\n        },\n        # Test Case 4\n        {\n            \"A_mf\": None,\n            \"Sigma_mf\": np.array([[0.2]]),\n            \"mu\": np.array([0.05]),\n            \"s\": np.array([0.2]),\n            \"x\": np.array([0.19]),\n            \"b_ensemble\": [\n                np.array([0.04]),\n                np.array([0.06]),\n                np.array([0.05]),\n                np.array([0.055])\n            ],\n            \"lambda_sigma\": 0.0,\n            \"lambda_r\": 1e-9\n        },\n        # Test Case 5\n        {\n            \"A_mf\": np.array([\n                [1.0, 0.1, 0.0, 0.2, 0.0, 0.1, 0.0, 0.0],\n                [0.1, 1.1, 0.2, 0.0, 0.1, 0.0, 0.1, 0.0],\n                [0.0, 0.2, 1.2, 0.1, 0.0, 0.2, 0.0, 0.1],\n                [0.2, 0.0, 0.1, 1.0, 0.2, 0.0, 0.1, 0.0],\n                [0.0, 0.1, 0.0, 0.2, 1.3, 0.1, 0.0, 0.2],\n                [0.1, 0.0, 0.2, 0.0, 0.1, 1.1, 0.2, 0.0],\n                [0.0, 0.1, 0.0, 0.1, 0.0, 0.2, 1.0, 0.1],\n                [0.0, 0.0, 0.1, 0.0, 0.2, 0.0, 0.1, 0.9]\n            ]),\n            \"Sigma_mf_offset\": 0.05,\n            \"mu\": np.array([0.05, 0.06, 0.07, 0.05, 0.08, 0.04, 0.03, 0.02]),\n            \"s\": np.array([0.12, 0.15, 0.14, 0.10, 0.13, 0.11, 0.09, 0.08]),\n            \"x\": np.array([0.11, 0.16, 0.13, 0.09, 0.14, 0.10, 0.08, 0.07]),\n            \"b_ensemble\": [\n                np.array([0.05, 0.06, 0.07, 0.05, 0.08, 0.04, 0.03, 0.02]),\n                np.array([0.06, 0.05, 0.08, 0.06, 0.09, 0.05, 0.02, 0.03]),\n                np.array([0.04, 0.07, 0.06, 0.04, 0.07, 0.03, 0.04, 0.01]),\n                np.array([0.05, 0.06, 0.07, 0.05, 0.08, 0.04, 0.03, 0.02]),\n                np.array([0.06, 0.07, 0.08, 0.06, 0.09, 0.05, 0.02, 0.03]),\n                np.array([0.05, 0.05, 0.06, 0.05, 0.08, 0.04, 0.03, 0.02]),\n                np.array([0.04, 0.06, 0.07, 0.04, 0.08, 0.03, 0.03, 0.02]),\n                np.array([0.05, 0.07, 0.07, 0.05, 0.08, 0.04, 0.03, 0.02])\n            ],\n            \"lambda_sigma\": 0.0,\n            \"lambda_r\": 1e-8\n        }\n    ]\n\n    results = []\n    for i, case in enumerate(test_cases):\n        if i == 0 or i == 4: # Cases 1 and 5\n            A = case['A_mf']\n            Sigma = A.T @ A\n            if i == 4: # Case 5 has an additional offset\n                Sigma += case['Sigma_mf_offset'] * np.identity(Sigma.shape[0])\n        else:\n            Sigma = case['Sigma_mf']\n\n        y_mf = compute_mf_score(Sigma, case['mu'], case['s'], case['x'], case['lambda_sigma'])\n        y_cem = compute_cem_score(case['s'], case['x'], case['b_ensemble'], case['lambda_r'])\n        results.append([y_mf, y_cem])\n        \n    print(f\"[{','.join(map(format_pair, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在实践中，您会发现上一节中实现的算法在处理真实世界数据时可能会变得不稳定，这通常是由于背景协方差矩阵的病态（ill-conditioned）特性。本练习  旨在揭示这一问题的根源：一个巨大的条件数会如何放大目标信号中微小的、不确定的分量，从而破坏检测结果。通过分析和计算，您将理解正则化（regularization）为何是解决这一问题的有效方法。",
            "id": "3853110",
            "problem": "一名分析师正在构建用于高光谱成像（HSI）背景抑制的线性目标检测器，该检测器是环境建模遥感工作流程的一部分。背景像素向量被建模为一个随机向量 $x \\in \\mathbb{R}^{p}$，其均值为 $\\mu$，协方差矩阵为 $\\Sigma = \\mathbb{E}\\left[(x - \\mu)(x - \\mu)^{\\top}\\right]$。许多线性检测算法，包括匹配滤波器（MF）和约束能量最小化（CEM），都需要计算依赖于 $\\Sigma^{-1}$ 的量。而光谱角匹配器（SAM）仅使用光谱之间的夹角，不使用 $\\Sigma$。\n\n经过降维后，在一个 $p = 3$ 的波段子空间中，从 $N$ 个背景像素估计出样本协方差 $\\widehat{\\Sigma}$。$\\widehat{\\Sigma}$ 的特征分解为 $\\widehat{\\Sigma} = \\sum_{i=1}^{3} \\widehat{\\lambda}_{i} u_{i} u_{i}^{\\top}$，其中 $\\{u_{i}\\}_{i=1}^{3}$ 是标准正交特征向量，特征值为 $\\{\\widehat{\\lambda}_{i}\\}_{i=1}^{3} = \\{5, 0.3, 10^{-4}\\}$，所有单位均为适当的辐射率单位。目标信号 $s \\in \\mathbb{R}^{3}$ 具有单位范数，并且在 $u_{3}$ 方向上的分量很小，具体来说 $|u_{3}^{\\top} s| = 0.05$。背景均值近似为零，因此 $\\mu \\approx 0$。\n\n假设以下基本事实：\n- 理论上，光谱协方差 $\\Sigma$ 是对称正定的，但其有限样本估计 $\\widehat{\\Sigma}$ 可能条件很差（病态）。\n- 对称正定矩阵的 $2$-范数条件数满足 $\\kappa_{2}(\\Sigma) = \\dfrac{\\lambda_{\\max}(\\Sigma)}{\\lambda_{\\min}(\\Sigma)}$。\n- $\\Sigma$ 中的小扰动 $\\delta \\Sigma$ 会在其逆矩阵中引起一阶扰动，遵循 $\\delta(\\Sigma^{-1}) \\approx -\\Sigma^{-1} (\\delta \\Sigma) \\Sigma^{-1}$。\n\n为稳定计算，分析师考虑采用 Tikhonov 型正则化，并使用 $\\Sigma_{\\lambda} = \\widehat{\\Sigma} + \\lambda I$，其中某个 $\\lambda > 0$。\n\n任务：\n- 仅使用上述基本事实，论证当 $N$ 不远大于 $p$ 时，$\\widehat{\\Sigma}$ 的小特征值如何影响依赖于 $\\widehat{\\Sigma}^{-1}$ 的检测器的稳定性，以及 $\\Sigma_{\\lambda}$ 如何缓解这些影响。特别是，描述当 $\\lambda$ 从 $0$ 增加到一个小的正值时，$\\widehat{\\Sigma}^{-1}$ 的条件数和灵敏度如何变化。\n- 对于 $\\lambda = 10^{-3}$，根据给定的特征值计算条件数 $\\kappa_{2}(\\widehat{\\Sigma})$ 和 $\\kappa_{2}(\\Sigma_{\\lambda})$。\n\n下列哪个陈述是正确的？\n\nA. 由于 $\\widehat{\\lambda}_{3} = 10^{-4}$，匹配滤波器和约束能量最小化都可能变得数值不稳定，因为 $s$ 沿 $u_{3}$ 的任何分量都会被大约 $\\widehat{\\lambda}_{3}^{-1}$ 的因子放大，因此 $\\widehat{\\Sigma}$ 或 $s$ 中的微小估计误差会导致检测器权重和输出的巨大变化；用 $\\Sigma_{\\lambda}$ 替换 $\\widehat{\\Sigma}$ 会将最小特征值增加到 $\\widehat{\\lambda}_{3} + \\lambda$ 并减小条件数，从而直接限制这种放大效应。\n\nB. 因为匹配滤波器是通过最大化信噪比推导出来的，所以它对 $\\widehat{\\Sigma}$ 的病态条件具有内在的鲁棒性；添加 $\\lambda I$ 只会均匀地缩小所有权重，不能减少输出方差或误报。\n\nC. 约束能量最小化在背景白化的前提下解决一个单位增益问题，并依赖于 $\\widehat{\\Sigma}^{-1}$；当 $\\widehat{\\Sigma}$ 条件很差时，其解倾向于在低方差方向（如 $u_{3}$）上施加过大的权重，这在模型失配的情况下会夸大输出方差；添加 $\\lambda I$ 是以增益约束中的一个小的偏差为代价，换取估计器方差的大幅减小。\n\nD. 光谱角匹配器不使用 $\\widehat{\\Sigma}$，因此不受病态条件的影响；因此，当一个低特征值方向由大气残留物主导时，SAM 在检测概率上总是优于基于协方差的检测器。\n\nE. 在一阶近似下，逆矩阵的扰动遵循 $\\|\\delta(\\widehat{\\Sigma}^{-1})\\| \\le \\|\\widehat{\\Sigma}^{-1}\\|^{2} \\,\\|\\delta \\Sigma\\| + \\mathcal{O}(\\|\\delta \\Sigma\\|^{2})$；由于对于 $2$-范数，$\\|\\widehat{\\Sigma}^{-1}\\| = 1/\\lambda_{\\min}(\\widehat{\\Sigma})$，增加 $\\lambda$ 会将 $\\|\\Sigma_{\\lambda}^{-1}\\|$ 减小到 $1/(\\lambda_{\\min}(\\widehat{\\Sigma}) + \\lambda)$，从而即使在 $\\widehat{\\Sigma}$ 非奇异时也能降低灵敏度。\n\n选择所有适用项。",
            "solution": "问题陈述已经过验证，被认为是有效的。它具有科学依据，问题设定良好且客观，为进行严格分析提供了所有必要信息。\n\n**问题设置分析**\n\n该问题讨论了当样本协方差矩阵 $\\widehat{\\Sigma}$ 条件恶劣（病态）时，高光谱成像中线性检测器的数值不稳定性问题。这种情况通常发生在训练样本数 $N$ 不远大于光谱带数 $p$ 时。这里，我们给定一个 $p=3$ 维的例子，样本协方差矩阵 $\\widehat{\\Sigma}$ 的特征值为 $\\{\\widehat{\\lambda}_{1}, \\widehat{\\lambda}_{2}, \\widehat{\\lambda}_{3}\\} = \\{5, 0.3, 10^{-4}\\}$。设其对应的标准正交特征向量为 $\\{u_1, u_2, u_3\\}$。\n\n对称正定矩阵的条件由其 $2$-范数条件数 $\\kappa_{2}(\\widehat{\\Sigma})$ 来量化，定义为其最大特征值与最小特征值之比。\n$$ \\kappa_{2}(\\widehat{\\Sigma}) = \\frac{\\lambda_{\\max}(\\widehat{\\Sigma})}{\\lambda_{\\min}(\\widehat{\\Sigma})} $$\n对于给定的特征值，我们有 $\\widehat{\\lambda}_{\\max} = 5$ 和 $\\widehat{\\lambda}_{\\min} = 10^{-4}$。\n$$ \\kappa_{2}(\\widehat{\\Sigma}) = \\frac{5}{10^{-4}} = 5 \\times 10^4 = 50000 $$\n大的条件数表明该矩阵接近奇异，并且其逆矩阵对扰动高度敏感。\n\n像匹配滤波器（MF）和约束能量最小化（CEM）这样的检测器依赖于计算 $\\widehat{\\Sigma}^{-1}s$，其中 $s$ 是目标信号。$\\widehat{\\Sigma}$ 的逆可以通过其特征分解表示：\n$$ \\widehat{\\Sigma}^{-1} = \\left(\\sum_{i=1}^{3} \\widehat{\\lambda}_{i} u_{i} u_{i}^{\\top}\\right)^{-1} = \\sum_{i=1}^{3} \\frac{1}{\\widehat{\\lambda}_{i}} u_{i} u_{i}^{\\top} $$\n将此逆矩阵应用于目标信号 $s$，我们得到：\n$$ \\widehat{\\Sigma}^{-1}s = \\sum_{i=1}^{3} \\frac{1}{\\widehat{\\lambda}_{i}} u_{i} (u_{i}^{\\top}s) = \\sum_{i=1}^{3} \\frac{c_i}{\\widehat{\\lambda}_{i}} u_{i} $$\n其中 $c_i = u_i^\\top s$ 是 $s$ 沿着特征向量 $u_i$ 的分量。$1/\\widehat{\\lambda}_i$ 项充当一个放大因子。对于最小的特征值 $\\widehat{\\lambda}_{3} = 10^{-4}$，这个因子是 $1/10^{-4} = 10000$。这意味着即使目标信号在 $u_3$ 方向上的分量非常小，即 $|c_3|=|u_3^\\top s| = 0.05$，在计算检测器权重时也会被极大地放大。这导致检测器对低方差方向 $u_3$ 过度敏感，而这个方向通常代表噪声或次要的、估计不佳的背景特征。\n\n为了缓解这个问题，提出了 Tikhonov 型正则化，用 $\\Sigma_{\\lambda} = \\widehat{\\Sigma} + \\lambda I$ 替换 $\\widehat{\\Sigma}$，其中 $\\lambda > 0$。$\\Sigma_{\\lambda}$ 的特征向量与 $\\widehat{\\Sigma}$ 的相同。$\\Sigma_{\\lambda}$ 的特征值为 $\\widehat{\\lambda}_i + \\lambda$。现在最小的特征值是 $\\widehat{\\lambda}_{\\min} + \\lambda$。\n\n让我们计算正则化矩阵 $\\Sigma_{\\lambda}$ 在 $\\lambda = 10^{-3}$ 时的条件数：\n新的特征值为：\n$$ \\lambda_{1,\\lambda} = 5 + 10^{-3} = 5.001 $$\n$$ \\lambda_{2,\\lambda} = 0.3 + 10^{-3} = 0.301 $$\n$$ \\lambda_{3,\\lambda} = 10^{-4} + 10^{-3} = 0.0001 + 0.001 = 0.0011 $$\n新的条件数是：\n$$ \\kappa_{2}(\\Sigma_{\\lambda}) = \\frac{\\lambda_{\\max}(\\Sigma_{\\lambda})}{\\lambda_{\\min}(\\Sigma_{\\lambda})} = \\frac{5.001}{0.0011} \\approx 4546.36 $$\n正则化已将条件数从 $50000$ 降低到约 $4546$，这是矩阵条件的一个显著改善。$u_3$ 方向的放大因子现在是 $1/(\\widehat{\\lambda}_3+\\lambda)=1/0.0011 \\approx 909$，远小于原来的因子 $10000$。\n\n**选项评估**\n\n**A. 由于 $\\widehat{\\lambda}_{3} = 10^{-4}$，匹配滤波器和约束能量最小化都可能变得数值不稳定，因为 $s$ 沿 $u_{3}$ 的任何分量都会被大约 $\\widehat{\\lambda}_{3}^{-1}$ 的因子放大，因此 $\\widehat{\\Sigma}$ 或 $s$ 中的微小估计误差会导致检测器权重和输出的巨大变化；用 $\\Sigma_{\\lambda}$ 替换 $\\widehat{\\Sigma}$ 会将最小特征值增加到 $\\widehat{\\lambda}_{3} + \\lambda$ 并减小条件数，从而直接限制这种放大效应。**\n这个陈述是对情况的完整而准确的总结。MF 和 CEM 都依赖于 $\\widehat{\\Sigma}^{-1}$，这使得它们容易受到病态条件的影响。$u_3$ 方向的放大因子的确是 $1/\\widehat{\\lambda}_3$。如此极端的放大会使得到的检测器对输入（$\\widehat{\\Sigma}$ 和 $s$）中的微小误差变得不稳定。正则化方案 $\\Sigma_{\\lambda} = \\widehat{\\Sigma} + \\lambda I$ 正确地将最小特征值增加到 $\\widehat{\\lambda}_3 + \\lambda$，对于任何 $\\lambda>0$，这都会减小条件数并限制放大因子。\n**结论：正确。**\n\n**B. 因为匹配滤波器是通过最大化信噪比推导出来的，所以它对 $\\widehat{\\Sigma}$ 的病态条件具有内在的鲁棒性；添加 $\\lambda I$ 只会均匀地缩小所有权重，不能减少输出方差或误报。**\n这个陈述在多个方面都是不正确的。首先，MF 推导的最优性假设了真实的协方差 $\\Sigma$ 是已知的且表现良好。当使用条件恶劣的样本估计 $\\widehat{\\Sigma}$ 时，它不提供任何内在的鲁棒性。其次，添加 $\\lambda I$ 并不会均匀地缩小权重。正则化后的权重与 $(\\widehat{\\Sigma} + \\lambda I)^{-1}s = \\sum_i \\frac{u_i^\\top s}{\\widehat{\\lambda}_i + \\lambda} u_i$ 成正比。其效果是高度不均匀的：与小特征值对应的分量比与大特征值对应的分量被修改得更显著。最后，正则化的全部目的就是稳定解，以防止对训练数据噪声的过拟合，这反过来又会减少在新数据上的输出方差并减轻误报。\n**结论：不正确。**\n\n**C. 约束能量最小化在背景白化的前提下解决一个单位增益问题，并依赖于 $\\widehat{\\Sigma}^{-1}$；当 $\\widehat{\\Sigma}$ 条件很差时，其解倾向于在低方差方向（如 $u_{3}$）上施加过大的权重，这在模型失配的情况下会夸大输出方差；添加 $\\lambda I$ 是以增益约束中的一个小的偏差为代价，换取估计器方差的大幅减小。**\n这个陈述准确地描述了 CEM 检测器和正则化的效果。CEM 在单位增益约束（$w^\\top s = 1$）下最小化背景能量（$w^\\top \\widehat{\\Sigma} w$）。一个条件很差的 $\\widehat{\\Sigma}$ 会导致解 $w_{CEM} \\propto \\widehat{\\Sigma}^{-1}s$ 在低方差方向（例如 $u_3$）上施加巨大的权重。虽然这在训练数据上最小化了能量，但对于与训练模型有轻微偏差的新数据（模型失配），可能会导致大的输出，从而夸大输出方差和误报。正则化为滤波器权重的估计器引入了偏差（正则化估计不再是“真实”最优滤波器的无偏估计），但为了大幅减小估计器的方差，使其更稳定和具有泛化能力，这是可以接受的。这是一个经典的偏差-方差权衡。\n**结论：正确。**\n\n**D. 光谱角匹配器不使用 $\\widehat{\\Sigma}$，因此不受病态条件的影响；因此，当一个低特征值方向由大气残留物主导时，SAM 在检测概率上总是优于基于协方差的检测器。**\n陈述的第一部分是正确的：SAM 定义为 $\\theta = \\arccos(\\frac{s^\\top x}{\\|s\\| \\|x\\|})$，不使用 $\\widehat{\\Sigma}$。然而，其结论“因此... SAM 总是优于”是一个无效的泛化。虽然 SAM 避免了病态条件的特定问题，但它也完全忽略了背景统计信息。像 MF 和 CEM 这样的检测器旨在抑制结构化背景。一个经过适当正则化的 MF 或 CEM 可以通过利用背景协方差结构的知识来将目标与光谱上相似的背景杂波分离开来，从而显著优于 SAM。“总是”这个词使这个主张绝对是错误的。性能是依赖于具体情况的。\n**结论：不正确。**\n\n**E. 在一阶近似下，逆矩阵的扰动遵循 $\\|\\delta(\\widehat{\\Sigma}^{-1})\\| \\le \\|\\widehat{\\Sigma}^{-1}\\|^{2} \\,\\|\\delta \\Sigma\\| + \\mathcal{O}(\\|\\delta \\Sigma\\|^{2})$；由于对于 $2$-范数，$\\|\\widehat{\\Sigma}^{-1}\\| = 1/\\lambda_{\\min}(\\widehat{\\Sigma})$，增加 $\\lambda$ 会将 $\\|\\Sigma_{\\lambda}^{-1}\\|$ 减小到 $1/(\\lambda_{\\min}(\\widehat{\\Sigma}) + \\lambda)$，从而即使在 $\\widehat{\\Sigma}$ 非奇异时也能降低灵敏度。**\n这个陈述为正则化在提高稳定性方面的作用提供了形式化的数学论证。一阶扰动界 $\\|\\delta(\\widehat{\\Sigma}^{-1})\\| \\le \\|\\widehat{\\Sigma}^{-1}\\|_2^2 \\|\\delta \\widehat{\\Sigma}\\|_2$（使用诱导 $2$-范数）表明，灵敏度与逆矩阵范数的平方成正比。对于一个对称正定矩阵，$\\|\\widehat{\\Sigma}^{-1}\\|_2 = 1/\\lambda_{\\min}(\\widehat{\\Sigma})$。正则化用 $\\Sigma_\\lambda$ 替换 $\\widehat{\\Sigma}$，其逆的范数为 $\\|\\Sigma_{\\lambda}^{-1}\\|_2 = 1/\\lambda_{\\min}(\\Sigma_{\\lambda}) = 1/(\\lambda_{\\min}(\\widehat{\\Sigma}) + \\lambda)$。因为 $\\lambda > 0$，我们有 $\\|\\Sigma_{\\lambda}^{-1}\\|_2  \\|\\widehat{\\Sigma}^{-1}\\|_2$。这直接减小了灵敏度因子 $\\|\\cdot^{-1}\\|_2^2$。即使对于非奇异（但病态）的矩阵，这样做也是有益的，这一点至关重要且是正确的。整个陈述在逻辑上和数学上都是合理的。\n**结论：正确。**",
            "answer": "$$\\boxed{ACE}$$"
        },
        {
            "introduction": "病态条件的概念与有限精度计算的现实密切相关。即使是理论上完美的算法，在计算机上执行时也可能因为数值误差而失败。本练习  深入探讨了这些数值陷阱，解释了巨大条件数与机器精度（machine epsilon）的相互作用如何导致计算结果完全失效。掌握这些知识并采取如数据标准化、适当正则化等预防措施，对于获得可靠的检测结果至关重要。",
            "id": "3853111",
            "problem": "一台高光谱机载成像仪在植被覆盖区域上空采集了辐射亮度向量 $x \\in \\mathbb{R}^d$，其中波段数 $d = 200$。利用 $n = 5000$ 个像素构建了一个背景模型，估计出背景均值 $\\mu$ 和协方差 $\\Sigma$。一位分析师打算计算线性光谱探测器，这些探测器依赖于诸如中心化 ($x - \\mu$)、$\\mathbb{R}^d$ 中的内积、通过 $\\ell_2$ 范数进行能量归一化以及求解涉及 $\\Sigma$ 的线性系统（例如，通过因式分解隐式地应用 $\\Sigma^{-1}$）等运算。考虑使用自适应相干估计 (Adaptive Coherence Estimator, ACE)、匹配滤波器 (Matched Filter, MF) 和光谱角匹配 (Spectral Angle Mapper, SAM) 进行探测。\n\n存在以下现实条件：\n- 由于大气吸收和传感器响应的异质性，辐射亮度值在不同波段间跨越约 $4$ 个数量级，有些波段接近饱和，而另一些则非常暗。\n- 样本协方差矩阵 $\\Sigma$ 是对称半正定的，其特征值范围从约 $10^{-4}$ 到 $10^{2}$，导致良态子空间的谱条件数 $\\kappa(\\Sigma) \\approx 10^{6}$。由于采样噪声，少数特征值聚集在 $10^{-8}$ 附近。\n- 计算可以在 IEEE $754$ 单精度（机器ε $\\epsilon_{\\mathrm{mach}} \\approx 1.19 \\times 10^{-7}$）或双精度（$\\epsilon_{\\mathrm{mach}} \\approx 2.22 \\times 10^{-16}$）下进行。\n- 感兴趣的目标光谱特征 $s \\in \\mathbb{R}^d$ 与背景子空间中度相关，因此在 $\\Sigma$ 的某些小方差方向上的投影会影响探测器的得分。\n\n基于浮点运算的基本原理（舍入模型 $\\,\\mathrm{fl}(a \\,\\mathrm{op}\\, b) = (a \\,\\mathrm{op}\\, b)(1 + \\delta)$，其中 $|\\delta| \\le \\epsilon_{\\mathrm{mach}}$）、线性代数条件（相对误差被条件数放大，例如，在后向稳定算法中，求解 $\\Sigma y = v$ 的前向误差界与 $\\kappa(\\Sigma)\\,\\epsilon_{\\mathrm{mach}}$ 成正比），以及光谱角的几何定义（在正标量缩放下的角度不变性），选择所有正确描述在有限精度下计算 ACE 或 MF 时的数值陷阱以及应对这些陷阱的有效保障措施的陈述。\n\nA. 未对数据进行均值中心化（使用 $x$ 而非 $x - \\mu$）会在线性探测器中引入一个大的偏差项，该偏差项会淹没微小的目标投影并加剧有效位损失；在双精度下使用补偿求和计算 $\\mu$ 并从每个 $x$ 中减去它可以提高数值稳定性。\n\nB. 当 $\\Sigma$ 是病态的时，使用奇异值分解得到的完全伪逆（无奇异值截断）来计算 ACE 或 MF 是数值上安全的，因为奇异值分解是后向稳定的，因此能产生一个可信的精确逆。\n\nC. 在估计协方差之前，将每个波段缩放至单位方差（按波段标准化）可以减小动态范围，并通常能降低探测器所面临的有效条件数，从而提高 ACE 和 MF 的数值稳定性。\n\nD. 光谱角匹配需要对 $\\Sigma$ 求逆，因此比匹配滤波器对病态条件更敏感。\n\nE. 用通过 Cholesky 分解（带正定性检查）求解线性系统来代替对 $\\Sigma$ 的显式求逆，并在需要时添加一个小的岭项 $\\lambda I$，可以减轻 ACE 和 MF 计算中的数值爆炸问题。\n\nF. 在单精度下，如果探测器所用子空间上的 $\\kappa(\\Sigma) \\approx 10^{8}$，则求解 $\\Sigma y = v$ 的相对前向误差可能在 $\\kappa(\\Sigma)\\,\\epsilon_{\\mathrm{mach}} \\approx 10$ 的量级，这使得 ACE 或 MF 的得分被数值噪声主导；建议使用双精度和正则化。\n\nG. 在计算 ACE 或 MF 之前将 $x$ 和 $s$ 归一化到单位 $\\ell_2$ 范数不会改变探测器得分，因此作为一种数值保障措施是不必要的。\n\n选择所有适用项。",
            "solution": "用户希望对一个关于高光谱探测算法中数值稳定性的问题陈述进行批判性评估，如果问题被认定为有效，则提供详细的解答。\n\n### 步骤1：提取已知条件\n- 数据向量：$x \\in \\mathbb{R}^d$\n- 光谱波段数：$d = 200$\n- 用于训练的背景像素数：$n = 5000$\n- 背景模型参数：均值 $\\mu$ 和协方差 $\\Sigma$\n- 考虑的算法：自适应相干估计 (ACE)、匹配滤波器 (MF)、光谱角匹配 (SAM)\n- 涉及的运算：中心化 ($x - \\mu$)、内积、$\\ell_2$ 范数、求解涉及 $\\Sigma$ 的线性系统（例如，应用 $\\Sigma^{-1}$）\n- 数据特征：辐射亮度值跨越约 $4$ 个数量级。\n- 协方差矩阵属性：$\\Sigma$ 是对称半正定的；在良态子空间中，特征值范围从约 $10^{-4}$ 到约 $10^{2}$；少数特征值聚集在 $10^{-8}$ 附近；良态子空间的谱条件数 $\\kappa(\\Sigma) \\approx 10^{6}$。\n- 计算精度：IEEE $754$ 单精度（$\\epsilon_{\\mathrm{mach}} \\approx 1.19 \\times 10^{-7}$）或双精度（$\\epsilon_{\\mathrm{mach}} \\approx 2.22 \\times 10^{-16}$）。\n- 目标属性：目标光谱特征 $s$ 与背景子空间中度相关。\n\n### 步骤2：使用提取的已知条件进行验证\n1.  **科学或事实上的不健全性**：问题在科学上是合理的。它位于遥感和信号处理这一成熟领域。所提及的算法（ACE, MF, SAM）是标准算法。所描述的数值挑战，如高光谱数据样本协方差矩阵的病态问题以及有限精度计算的影响，是科学计算中被充分证明且现实存在的现象。条件数、机器ε和前向误差之间的关系（$\\|\\delta y\\|/\\|y\\| \\lesssim \\kappa(\\Sigma)\\epsilon_{\\mathrm{mach}}$）是数值线性代数的基本原理。\n2.  **不可形式化或不相关**：问题与指定主题高度相关，并且可以使用线性代数和数值分析的原理进行形式化。\n3.  **不完整或矛盾的设置**：设置是完整且内部一致的。所提供的参数（$d=200$, $n=5000$）对于构建样本协方差矩阵是现实的。条件 $n  d$ 理论上允许样本协方差矩阵是满秩的，但关于高动态范围、波段相关性和非常小的特征值的描述准确地反映了实际情况，即这类矩阵通常是严重病态或数值秩亏的。\n4.  **不切实际或不可行**：条件是现实的。高光谱传感器产生的数据通常具有宽动态范围，由此产生的协方差矩阵是出了名的病态，条件数达到 $10^6$ 或更高是很常见的。\n5.  **不适定或结构不良**：问题是适定的。它要求根据一套清晰的原则和一个详细、一致的背景来评估具体的陈述。\n6.  **伪深刻、琐碎或同义反复**：问题是实质性的。它要求对理论算法在真实世界数据和有限精度计算的约束下的行为有细致入微的理解。\n7.  **超出科学可验证性范围**：所有主张都可以使用已建立的数学和数值原理进行验证。\n\n### 步骤3：结论与行动\n该问题陈述是有效的。它为分析高光谱探测中的数值问题提供了一个现实且定义明确的场景。我将继续进行解答。\n\n### 推导与选项分析\n\n问题的核心涉及依赖于背景协方差矩阵逆 $\\Sigma^{-1}$ 的探测器。这被称为白化变换。令中心化后的数据和目标向量分别为 $\\tilde{x} = x - \\mu$ 和 $\\tilde{s} = s - \\mu$。\n\n未归一化的**匹配滤波器 (MF)** 定义为：\n$$ T_{\\text{MF}}(\\tilde{x}) = \\tilde{s}^T \\Sigma^{-1} \\tilde{x} $$\n**自适应相干估计 (ACE)** 定义为：\n$$ T_{\\text{ACE}}(\\tilde{x}) = \\frac{(\\tilde{s}^T \\Sigma^{-1} \\tilde{x})^2}{(\\tilde{s}^T \\Sigma^{-1} \\tilde{s})(\\tilde{x}^T \\Sigma^{-1} \\tilde{x})} = \\frac{T_{\\text{MF}}(\\tilde{x})^2}{(\\tilde{s}^T \\Sigma^{-1} \\tilde{s})(\\tilde{x}^T \\Sigma^{-1} \\tilde{x})} $$\n关键的数值挑战在于计算像 $\\Sigma^{-1}v$ 这样的项，其中 $\\Sigma$ 是病态的。病态性，即 $\\kappa(\\Sigma) \\approx 10^{6}$ 或更高，意味着输入数据或矩阵中的微小相对误差在输出中可能被放大 $10^6$ 倍。\n\n**A. 未对数据进行均值中心化（使用 $x$ 而非 $x - \\mu$）会在线性探测器中引入一个大的偏差项，该偏差项会淹没微小的目标投影并加剧有效位损失；在双精度下使用补偿求和计算 $\\mu$ 并从每个 $x$ 中减去它可以提高数值稳定性。**\nACE 和 MF 均基于马氏距离，该距离测量的是与分布均值的距离。相应的线性变换是针对零均值数据定义的。使用未中心化的数据 $x$ 和 $s$ 而非 $\\tilde{x}$ 和 $\\tilde{s}$ 会改变基本的统计假设。巨大的、共享的均值向量 $\\mu$ 会贡献一个信号分量 $\\mu^T \\Sigma^{-1} \\mu$ 和一些交叉项，这些项可能主导目标差异的微弱特征。这是一个会带来严重数值后果的建模错误。此外，从 $n=5000$ 个向量计算均值 $\\mu = \\frac{1}{n} \\sum_{i=1}^n x_i$ 可能会累积显著的舍入误差。补偿求和（例如Kahan求和）是精确计算浮点数之和的标准算法。使用双精度进一步提高了此求和的准确性。一个准确的均值对于中心化步骤 $x-\\mu$至关重要，如果 $x$ 接近 $\\mu$，这一步本身就可能遭受灾难性抵消，而如果 $\\mu$ 不准确，问题会更严重。因此，该陈述准确地指出了一个建模陷阱和正确的数值卫生措施。\n**结论：正确。**\n\n**B. 当 $\\Sigma$ 是病态的时，使用奇异值分解得到的完全伪逆（无奇异值截断）来计算 ACE 或 MF 是数值上安全的，因为奇异值分解是后向稳定的，因此能产生一个可信的精确逆。**\n这个陈述包含一个对数值稳定性的关键误解。虽然SVD的算法确实是后向稳定的（意味着计算出的SVD是某个微扰矩阵 $\\Sigma + \\Delta\\Sigma$ 的精确SVD），但这并不能保证得到的伪逆是准确的，或者说使用它是“安全的”。对于一个病态矩阵，求逆问题本身对扰动是内在地敏感的。使用*完全*伪逆涉及对所有非零奇异值求倒数。问题陈述指出一些特征值（以及对应的奇异值）接近 $10^{-8}$。对这些微小且易受噪声影响的值求逆，会导致计算出的伪逆中出现巨大的条目，从而极大地放大任何噪声或误差。标准的、数值稳定的方法是使用*截断*SVD，即舍弃低于某个阈值的奇异值。这是一种正则化形式。因此，使用完全伪逆在数值上是不安全的。\n**结论：不正确。**\n\n**C. 在估计协方差之前，将每个波段缩放至单位方差（按波段标准化）可以减小动态范围，并通常能降低探测器所面临的有效条件数，从而提高 ACE 和 MF 的数值稳定性。**\n按波段标准化将协方差矩阵 $\\Sigma$ 转换为相关矩阵 $R$。$\\Sigma$ 的对角线元素是每个波段的方差，可能跨越几个数量级，这是导致病态的原因之一。标准化迫使 $R$ 的所有对角线元素都为 $1$。这个过程，被称为矩阵均衡化，是一种非常强大的预处理技术，通常能降低矩阵的条件数。虽然不是绝对保证，但这是提高后续运算（如求解涉及该矩阵的线性系统）数值稳定性的非常有效和标准的做法。然后，ACE 和 MF 探测器可以基于这个条件更好的相关矩阵进行计算，从而得到更稳健的结果。\n**结论：正确。**\n\n**D. 光谱角匹配需要对 $\\Sigma$ 求逆，因此比匹配滤波器对病态条件更敏感。**\n光谱角匹配 (SAM) 的公式通常表示为两个向量（例如目标 $s$ 和像素 $x$）之间夹角的余弦：\n$$ T_{\\text{SAM}}(x, s) = \\arccos\\left(\\frac{x^T s}{\\|x\\|_2 \\|s\\|_2}\\right) $$\n或者就是余弦值本身。这个计算只涉及点积和向量范数。它不以任何方式涉及协方差矩阵 $\\Sigma$ 或其逆。因此，SAM 对 $\\Sigma$ 的条件完全不敏感。相比之下，匹配滤波器由 $\\Sigma^{-1}$ 定义，对其条件高度敏感。该陈述的前提在事实上是错误的。\n**结论：不正确。**\n\n**E. 用通过 Cholesky 分解（带正定性检查）求解线性系统来代替对 $\\Sigma$ 的显式求逆，并在需要时添加一个小的岭项 $\\lambda I$，可以减轻 ACE 和 MF 计算中的数值爆炸问题。**\n这个陈述描述了数值线性代数中的几个最佳实践。首先，几乎永远不应该计算显式的矩阵逆 $\\Sigma^{-1}$；求解线性系统 $\\Sigma y = v$ 来得到 $y = \\Sigma^{-1}v$ 更稳定、更高效。对于对称正定 (SPD) 矩阵，Cholesky分解 ($\\Sigma = LL^T$) 是首选的求解方法。由于样本协方差 $\\Sigma$ 可能只是半正定的或病态的，使用一个能检查正定性的稳健Cholesky算法是合适的。其次，添加一个小的岭项 $\\lambda I$（其中 $\\lambda0$）是一种标准的正则化技术（Tikhonov正则化）。得到的矩阵 $\\Sigma' = \\Sigma + \\lambda I$ 保证是严格正定的，并且通常具有比 $\\Sigma$ 小得多的条件数。这种正则化直接解决了病态问题，防止了与对接近零的特征值求逆相关的数值爆炸。\n**结论：正确。**\n\n**F. 在单精度下，如果探测器所用子空间上的 $\\kappa(\\Sigma) \\approx 10^{8}$，则求解 $\\Sigma y = v$ 的相对前向误差可能在 $\\kappa(\\Sigma)\\,\\epsilon_{\\mathrm{mach}} \\approx 10$ 的量级，这使得 ACE 或 MF 的得分被数值噪声主导；建议使用双精度和正则化。**\n这个陈述提供了一个定量的数值误差分析。求解线性系统 $\\Sigma y = v$ 的相对前向误差的界与 $\\kappa(\\Sigma)\\epsilon_{\\mathrm{mach}}$ 成正比。假设在有效条件数 $\\kappa(\\Sigma) \\approx 10^8$ 的情况下（鉴于特征值接近 $10^{-8}$ 的描述，这是合理的），并使用单精度 $\\epsilon_{\\mathrm{mach}} \\approx 1.19 \\times 10^{-7}$，误差放大因子约为 $10^8 \\times 1.19 \\times 10^{-7} = 11.9$。如此量级（10的量级）的相对误差意味着计算出的解完全不可靠，没有任何正确的有效数字。依赖于此解的 ACE 和 MF 得分将毫无意义。提出的补救措施是恰当的：切换到双精度将 $\\epsilon_{\\mathrm{mach}}$ 减小到 $\\approx 2.22 \\times 10^{-16}$，使得误差乘积约为 $\\approx 2.22 \\times 10^{-8}$，这非常好。如E中所述，正则化会降低 $\\kappa(\\Sigma)$，同样能控制误差。该陈述在数值上和概念上都是合理的。\n**结论：正确。**\n\n**G. 在计算 ACE 或 MF 之前将 $x$ 和 $s$ 归一化到单位 $\\ell_2$ 范数不会改变探测器得分，因此作为一种数值保障措施是不必要的。**\n这个陈述不正确，主要有两个原因。首先，它并非对所有探测器都成立。虽然 ACE 对其输入向量的正向缩放是不变的（缩放因子在比率中抵消了），但匹配滤波器 $T_{\\text{MF}}(\\tilde{x}) = \\tilde{s}^T \\Sigma^{-1} \\tilde{x}$ 的得分会随着 $\\tilde{s}$ 和 $\\tilde{x}$ 的幅值（或对于归一化MF变体，仅随 $\\tilde{x}$）线性变化。将 $x$ 归一化到单位范数绝对会改变MF的得分。其次，即使对于得分理论上不变的ACE，归一化也可以作为一种关键的数值保障措施。鉴于辐射亮度跨越4个数量级，范数 $\\|x\\|$ 可能非常大或非常小。不进行归一化，像 $\\tilde{x}^T \\Sigma^{-1} \\tilde{x}$ 这样的表达式中的中间乘积可能导致浮点上溢或下溢，从而破坏结果。将向量归一化到单位范数有助于将所有值保持在可管理的数值范围内。因此，这不是一个不必要的步骤。\n**结论：不正确。**",
            "answer": "$$\\boxed{ACEF}$$"
        }
    ]
}