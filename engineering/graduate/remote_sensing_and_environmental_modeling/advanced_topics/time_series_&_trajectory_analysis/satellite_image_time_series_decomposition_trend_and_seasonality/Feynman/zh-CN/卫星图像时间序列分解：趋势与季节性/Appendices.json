{
    "hands_on_practices": [
        {
            "introduction": "在时间序列分解中，对季节性分量进行建模是核心步骤之一。基于傅里叶级数的谐波回归为此提供了一种强大而灵活的方法。本练习将带您回归第一性原理，利用最小二乘法推导谐波回归系数的方程，并将这些系数与更直观的振幅和相位概念联系起来。通过完成这项推导 ，您将巩固对如何捕捉数据中周期性模式的理论理解，并学会如何解释模型输出。",
            "id": "3843828",
            "problem": "从Sentinel-2地表反射率数据中提取的归一化植被指数（NDVI；Normalized Difference Vegetation Index）单像元时间序列，以每日为固定间隔，进行了为期多年的观测。假设一个加性分解模型，形式为 $Y_t = \\mu(t) + S(t) + \\varepsilon_t$，其中 $Y_t$ 是在第 $t$ 天观测到的NDVI值，$\\mu(t)$ 是一个平滑趋势项，$S(t)$ 是一个以基本周期 $P$ 严格重复的季节性分量，$\\varepsilon_t$ 是一个均值为零、方差有限且在时间上不相关的噪声项。假设季节性分量 $S(t)$ 可以由基本频率的有限组谐波很好地近似。\n\n从周期函数的定义和三角函数在基本周期整数倍上的正交性出发，并在独立同分布高斯误差的假设下使用最小二乘法原理，推导出一个基于基本周期有限数量 $K$ 个谐波的 $S(t)$ 的谐波回归表达式。然后，说明如何用通过最小二乘法获得的回归系数来表示每个谐波的振幅和相位。\n\n完成推导后，使用以下针对 $K = 3$ 个谐波的值（这些值是通过先对 $Y_t$ 去趋势，然后在跨越整数年、周期 $P = 365$ 天的 $N$ 个日样本上使用最小二乘法来估计 $S(t)$ 得到的）：\n- 对于 $k = 1$：$a_1 = 0.12$， $b_1 = -0.05$。\n- 对于 $k = 2$：$a_2 = 0.08$， $b_2 = 0.02$。\n- 对于 $k = 3$：$a_3 = 0.03$， $b_3 = -0.01$。\n\n按 $k = 1, 2, 3$ 的顺序计算每个谐波的振幅和相位。振幅以反射率（无单位）表示，相位以弧度表示。通过适当的映射将相位约束在区间 $[0, 2\\pi)$ 内。将最终数值结果四舍五入到四位有效数字。\n\n你的最终答案必须是一个单行矩阵，按顺序包含六个值 $(A_1, \\phi_1, A_2, \\phi_2, A_3, \\phi_3)$，其中 $A_k$ 表示第 $k$ 个谐波的振幅，$\\phi_k$ 表示相位。",
            "solution": "问题陈述已经过评估并被确定为有效。它具有科学依据，问题设定良好、客观，并包含得出完整解所需的所有必要信息。它描述了谐波分析在遥感时间序列数据中的一个标准应用，这是一种成熟的科学方法。\n\n该问题要求两项主要内容：首先，从第一性原理出发，推导周期性季节分量的谐波回归模型；其次，根据给定的回归系数，进行振幅和相位的数值计算。\n\n**第一部分：谐波回归及振幅-相位表示的推导**\n\n我们从时间序列 $Y_t$ 的加性分解模型开始：\n$$ Y_t = \\mu(t) + S(t) + \\varepsilon_t $$\n其中 $t$ 代表时间，$\\mu(t)$ 是趋势项，$S(t)$ 是季节性分量，$\\varepsilon_t$ 是随机误差项。问题陈述 $S(t)$ 是以基本周期 $P$ 严格重复的周期函数。任何此类良态周期函数都可以用傅里叶级数表示。基本角频率为 $\\omega = \\frac{2\\pi}{P}$。季节性分量 $S(t)$ 由 $K$ 个谐波的有限和来近似：\n$$ S(t) \\approx \\sum_{k=1}^{K} \\left( a_k \\cos(k \\omega t) + b_k \\sin(k \\omega t) \\right) $$\n问题陈述时间序列 $Y_t$ 已经过去趋势化以得到季节性分量的估计值。我们将这些去趋势后的观测值表示为 $s_t = Y_t - \\hat{\\mu}(t)$。我们的目标是找到系数 $a_k$ 和 $b_k$ 以使模型最佳拟合这些观测值。在独立同分布高斯误差的假设下，最小二乘法原理等价于最大似然估计。观测值 $s_t$ 与模型之间的残差平方和（$SSR$）为：\n$$ SSR(a_1, ..., a_K, b_1, ..., b_K) = \\sum_{t=1}^{N} \\left( s_t - \\sum_{k=1}^{K} \\left[ a_k \\cos\\left(\\frac{2\\pi k t}{P}\\right) + b_k \\sin\\left(\\frac{2\\pi k t}{P}\\right) \\right] \\right)^2 $$\n为使 $SSR$ 最小化，我们对每个系数求偏导数并令其为零。对于任意系数 $a_j$（其中 $j \\in \\{1, ..., K\\}$）：\n$$ \\frac{\\partial SSR}{\\partial a_j} = \\sum_{t=1}^{N} 2 \\left( s_t - \\sum_{k=1}^{K} [...] \\right) \\left( - \\cos\\left(\\frac{2\\pi j t}{P}\\right) \\right) = 0 $$\n$$ \\sum_{t=1}^{N} s_t \\cos\\left(\\frac{2\\pi j t}{P}\\right) = \\sum_{t=1}^{N} \\cos\\left(\\frac{2\\pi j t}{P}\\right) \\sum_{k=1}^{K} \\left[ a_k \\cos\\left(\\frac{2\\pi k t}{P}\\right) + b_k \\sin\\left(\\frac{2\\pi k t}{P}\\right) \\right] $$\n问题指明数据跨越整数年，即 $N = mP$（$m$ 为某个整数）。在这种情况下，离散三角函数在区间 $t \\in \\{1, ..., N\\}$上表现出正交性。相关的恒等式是：\n$$ \\sum_{t=1}^{N} \\cos\\left(\\frac{2\\pi k t}{P}\\right) \\sin\\left(\\frac{2\\pi j t}{P}\\right) = 0 \\quad \\text{for all } k, j $$\n$$ \\sum_{t=1}^{N} \\cos\\left(\\frac{2\\pi k t}{P}\\right) \\cos\\left(\\frac{2\\pi j t}{P}\\right) = \\begin{cases} \\frac{N}{2}  \\text{if } k=j \\neq 0, P/2 \\\\ 0  \\text{if } k \\neq j \\end{cases} $$\n$$ \\sum_{t=1}^{N} \\sin\\left(\\frac{2\\pi k t}{P}\\right) \\sin\\left(\\frac{2\\pi j t}{P}\\right) = \\begin{cases} \\frac{N}{2}  \\text{if } k=j \\neq 0, P/2 \\\\ 0  \\text{if } k \\neq j \\end{cases} $$\n将这些正交关系应用于 $\\frac{\\partial SSR}{\\partial a_j}$ 的展开和，所有 $k \\neq j$ 的项都变为零。我们剩下：\n$$ \\sum_{t=1}^{N} s_t \\cos\\left(\\frac{2\\pi j t}{P}\\right) = \\sum_{t=1}^{N} a_j \\cos^2\\left(\\frac{2\\pi j t}{P}\\right) = a_j \\frac{N}{2} $$\n求解 $a_j$ 得到最小二乘估计：\n$$ a_j = \\frac{2}{N} \\sum_{t=1}^{N} s_t \\cos\\left(\\frac{2\\pi j t}{P}\\right) $$\n类似地，对 $b_j$ 求导：\n$$ \\frac{\\partial SSR}{\\partial b_j} = \\sum_{t=1}^{N} 2 \\left( s_t - \\sum_{k=1}^{K} [...] \\right) \\left( - \\sin\\left(\\frac{2\\pi j t}{P}\\right) \\right) = 0 $$\n应用正交性得出：\n$$ \\sum_{t=1}^{N} s_t \\sin\\left(\\frac{2\\pi j t}{P}\\right) = \\sum_{t=1}^{N} b_j \\sin^2\\left(\\frac{2\\pi j t}{P}\\right) = b_j \\frac{N}{2} $$\n$$ b_j = \\frac{2}{N} \\sum_{t=1}^{N} s_t \\sin\\left(\\frac{2\\pi j t}{P}\\right) $$\n这就完成了谐波回归系数的推导。\n\n接下来，我们将第 $k$ 个谐波 $S_k(t) = a_k \\cos(k \\omega t) + b_k \\sin(k \\omega t)$ 转换为振幅-相位形式 $S_k(t) = A_k \\cos(k \\omega t - \\phi_k)$。\n使用三角恒等式 $\\cos(X - Y) = \\cos(X)\\cos(Y) + \\sin(X)\\sin(Y)$，我们展开振幅-相位形式：\n$$ A_k \\cos(k \\omega t - \\phi_k) = A_k (\\cos(k \\omega t)\\cos(\\phi_k) + \\sin(k \\omega t)\\sin(\\phi_k)) $$\n$$ S_k(t) = (A_k \\cos(\\phi_k)) \\cos(k \\omega t) + (A_k \\sin(\\phi_k)) \\sin(k \\omega t) $$\n通过比较 $\\cos(k \\omega t)$ 和 $\\sin(k \\omega t)$ 的系数与原始形式，我们建立以下关系：\n$$ a_k = A_k \\cos(\\phi_k) $$\n$$ b_k = A_k \\sin(\\phi_k) $$\n为了求得振幅 $A_k$，我们将这两个方程平方后相加：\n$$ a_k^2 + b_k^2 = A_k^2 \\cos^2(\\phi_k) + A_k^2 \\sin^2(\\phi_k) = A_k^2 (\\cos^2(\\phi_k) + \\sin^2(\\phi_k)) = A_k^2 $$\n由于振幅是非负量，我们有：\n$$ A_k = \\sqrt{a_k^2 + b_k^2} $$\n为了求得相位 $\\phi_k$，我们将第二个方程除以第一个方程：\n$$ \\frac{b_k}{a_k} = \\frac{A_k \\sin(\\phi_k)}{A_k \\cos(\\phi_k)} = \\tan(\\phi_k) $$\n相位角 $\\phi_k$ 必须通过考虑 $a_k$（余弦系数，类似于x坐标）和 $b_k$（正弦系数，类似于y坐标）的符号来确定，以将角度置于正确的象限。这可以通过使用双参数反正切函数（通常记为 $\\text{atan2}(y, x)$）来实现。因此，$\\phi_k' = \\text{atan2}(b_k, a_k)$，其返回值通常在 $(-\\pi, \\pi]$ 区间内。\n问题要求相位在区间 $[0, 2\\pi)$ 内。我们通过以下映射实现这一点：\n$$ \\phi_k = \\begin{cases} \\phi_k'  \\text{if } \\phi_k' \\ge 0 \\\\ \\phi_k' + 2\\pi  \\text{if } \\phi_k'  0 \\end{cases} $$\n\n**第二部分：数值计算**\n\n给定 $K=3$ 个谐波和 $P=365$ 的系数。我们计算每个谐波的振幅 $A_k$ 和相位 $\\phi_k$，并四舍五入到四位有效数字。\n\n对于 $k=1$：$a_1 = 0.12$，$b_1 = -0.05$。\n$$ A_1 = \\sqrt{(0.12)^2 + (-0.05)^2} = \\sqrt{0.0144 + 0.0025} = \\sqrt{0.0169} = 0.13 $$\n保留四位有效数字，$A_1 = 0.1300$。\n相位由 $\\phi_1' = \\text{atan2}(-0.05, 0.12)$ 给出。由于 $a_1 > 0$ 且 $b_1  0$，角度在第四象限。\n$$ \\phi_1' \\approx -0.39479 \\text{ 弧度} $$\n映射到 $[0, 2\\pi)$：\n$$ \\phi_1 = -0.39479 + 2\\pi \\approx 5.88839... $$\n保留四位有效数字，$\\phi_1 = 5.888$。\n\n对于 $k=2$：$a_2 = 0.08$，$b_2 = 0.02$。\n$$ A_2 = \\sqrt{(0.08)^2 + (0.02)^2} = \\sqrt{0.0064 + 0.0004} = \\sqrt{0.0068} \\approx 0.082462... $$\n保留四位有效数字，$A_2 = 0.08246$。\n相位由 $\\phi_2' = \\text{atan2}(0.02, 0.08)$ 给出。由于 $a_2 > 0$ 且 $b_2 > 0$，角度在第一象限。\n$$ \\phi_2' = \\arctan(0.25) \\approx 0.244978... \\text{ 弧度} $$\n该值已在 $[0, 2\\pi)$ 范围内，因此无需映射。\n保留四位有效数字，$\\phi_2 = 0.2450$。\n\n对于 $k=3$：$a_3 = 0.03$，$b_3 = -0.01$。\n$$ A_3 = \\sqrt{(0.03)^2 + (-0.01)^2} = \\sqrt{0.0009 + 0.0001} = \\sqrt{0.0010} \\approx 0.031622... $$\n保留四位有效数字，$A_3 = 0.03162$。\n相位由 $\\phi_3' = \\text{atan2}(-0.01, 0.03)$ 给出。由于 $a_3 > 0$ 且 $b_3  0$，角度在第四象限。\n$$ \\phi_3' \\approx -0.32175... \\text{ 弧度} $$\n映射到 $[0, 2\\pi)$：\n$$ \\phi_3 = -0.32175 + 2\\pi \\approx 5.96143... $$\n保留四位有效数字，$\\phi_3 = 5.961$。\n\n最终结果 $(A_1, \\phi_1, A_2, \\phi_2, A_3, \\phi_3)$ 为 $(0.1300, 5.888, 0.08246, 0.2450, 0.03162, 5.961)$。",
            "answer": "$$ \\boxed{ \\begin{pmatrix} 0.1300  5.888  0.08246  0.2450  0.03162  5.961 \\end{pmatrix} } $$"
        },
        {
            "introduction": "卫星时间序列数据很少是完美的，常常包含由未被掩膜的云或其他传感器伪影引起的异常值。这些异常值会严重扭曲使用普通最小二乘法 (Ordinary Least Squares, OLS) 等标准方法估算出的趋势。本练习介绍了一种使用Huber损失函数的稳健回归技术来估算趋势，该方法通过降低大误差（异常值）的权重来提供更可靠的趋势估计。这项编码练习  将让您亲手实践并对比稳健与非稳健方法的效果，展示更准确的趋势估算如何帮助我们更精确地分离和分析季节性分量。",
            "id": "3843866",
            "problem": "一个地表反射率（无单位小数）的卫星图像时间序列被建模为一个加法分解，包含一个缓慢变化的趋势和一个周期性的季节性分量。设时间索引 $t \\in \\{0,1,\\dots,N-1\\}$ 处的观测值为 $y_t$，并假设\n$$\ny_t = \\tau(t) + s(t) + \\varepsilon_t + o_t,\n$$\n其中 $\\tau(t)$ 是趋势项，$s(t)$ 是季节性分量，$\\varepsilon_t$ 是零均值噪声，$o_t$ 代表偶尔出现的离群值，例如，由未完全校正的残留云或双向反射效应引起的。假设季节性分量具有已知周期 $P$（以样本数为单位），并且可以用单个谐波表示，\n$$\ns(t) = a \\cos\\left(\\frac{2\\pi t}{P}\\right) + b \\sin\\left(\\frac{2\\pi t}{P}\\right),\n$$\n其振幅为 $A = \\sqrt{a^2 + b^2}$，角度以弧度为单位。\n\n为了减少离群值对趋势估计的影响，您需要使用 Huber 损失函数为 $\\tau(t)$ 构建一个稳健的估计器。具体来说，用一阶多项式 $\\tau(t) = \\beta_0 + \\beta_1 t$ 表示趋势，并通过最小化 Huber 目标函数来估计参数 $\\beta_0, \\beta_1$\n$$\nJ(\\beta_0,\\beta_1) = \\sum_{t=0}^{N-1} \\rho_\\delta\\!\\left(y_t - \\beta_0 - \\beta_1 t\\right),\n$$\n其中 $\\rho_\\delta(r)$ 是阈值为 $\\delta  0$ 的 Huber 损失函数，\n$$\n\\rho_\\delta(r) = \n\\begin{cases}\n\\frac{1}{2} r^2,  \\text{如果 } |r| \\le \\delta, \\\\\n\\delta \\left(|r| - \\frac{1}{2}\\delta\\right),  \\text{如果 } |r|  \\delta.\n\\end{cases}\n$$\n在估计出趋势后，通过对序列进行去趋势化，并对 $\\cos\\left(\\frac{2\\pi t}{P}\\right)$ 和 $\\sin\\left(\\frac{2\\pi t}{P}\\right)$ 进行最小二乘谐波回归，来获得季节性振幅 $A$。使用非稳健的普通最小二乘趋势估计重复振幅估计过程，以进行比较。任务是实现迭代重加权最小二乘法（IRLS）来解决稳健的 Huber 趋势估计问题，然后量化稳健趋势相对于最小二乘趋势对估计的季节性振幅的影响。\n\n您的程序必须：\n- 为每个测试用例，根据指定的加法模型生成合成时间序列 $y_t$，包含以下分量：\n  - 趋势 $\\tau(t) = \\beta_0 + \\beta_1 t$。\n  - 季节性分量 $s(t) = A_{\\text{true}} \\cos\\left(\\frac{2\\pi t}{P}\\right)$（数据生成时使用零相位）。\n  - 标准差为 $\\sigma$ 的高斯噪声 $\\varepsilon_t \\sim \\mathcal{N}(0,\\sigma^2)$。\n  - 以指定的索引比例，均匀随机地注入离群值 $o_t$，其大小由独立随机的符号乘以指定的离群值幅度得出。\n- 使用以下方法估计趋势系数 $(\\beta_0,\\beta_1)$：\n  - 对 $\\{(t,y_t)\\}$ 使用普通最小二乘法（非稳健）。\n  - 对 $\\{(t,y_t)\\}$ 使用迭代重加权最小二乘法进行稳健的 Huber 回归，阈值为 $\\delta$。\n- 对于两种趋势估计，使用已知的周期 $P$，通过对去趋势化序列进行最小二乘谐波回归来计算季节性振幅 $A$。\n- 对于每个测试用例，返回一个浮点数，其值为 $A_{\\text{Huber}} - A_{\\text{OLS}}$，以反射率单位表示，形式为小数（非百分比）。\n\n使用以下参数值测试套件，这些参数值旨在覆盖卫星图像时间序列分解中的典型和边缘情况。对于每个元组，参数为 $(N, P, \\beta_0, \\beta_1, A_{\\text{true}}, \\sigma, f_{\\text{out}}, M_{\\text{out}}, \\delta)$：\n1. $(N,P,\\beta_0,\\beta_1,A_{\\text{true}},\\sigma,f_{\\text{out}},M_{\\text{out}},\\delta) = (60, 12, 0.4, 0.0015, 0.15, 0.02, 0.10, 0.35, 0.05)$。\n2. $(N,P,\\beta_0,\\beta_1,A_{\\text{true}},\\sigma,f_{\\text{out}},M_{\\text{out}},\\delta) = (60, 12, 0.5, 0.0000, 0.12, 0.01, 0.00, 0.00, 0.05)$。\n3. $(N,P,\\beta_0,\\beta_1,A_{\\text{true}},\\sigma,f_{\\text{out}},M_{\\text{out}},\\delta) = (48, 12, 0.3, 0.0020, 0.08, 0.03, 0.25, 0.50, 0.03)$。\n4. $(N,P,\\beta_0,\\beta_1,A_{\\text{true}},\\sigma,f_{\\text{out}},M_{\\text{out}},\\delta) = (36, 12, 0.6, -0.0010, 0.10, 0.015, 0.15, 0.40, 0.005)$。\n5. $(N,P,\\beta_0,\\beta_1,A_{\\text{true}},\\sigma,f_{\\text{out}},M_{\\text{out}},\\delta) = (24, 12, 0.45, 0.0010, 0.00, 0.02, 0.20, 0.30, 0.05)$。\n\n所有振幅和差异都必须以反射率单位（无单位小数）表示。角度以弧度为单位。您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，例如 $[r_1,r_2,r_3,r_4,r_5]$，其中 $r_i$ 是测试用例 $i$ 的振幅差 $A_{\\text{Huber}} - A_{\\text{OLS}}$。",
            "solution": "所提出的问题是有效的，因为它在科学上基于统计信号处理，问题设定良好，目标明确，并提供了构建唯一、可验证解决方案所需的所有必要信息。其基础方法——加法时间序列分解、普通最小二乘法（OLS）、Huber 回归和迭代重加权最小二乘法（IRLS）——都是标准且在数学上是合理的。我们继续进行详细的解答。\n\n问题的核心是比较非稳健与稳健趋势估计对后续季节性信号振幅估计的影响。时间序列被建模为：\n$$\ny_t = \\tau(t) + s(t) + \\varepsilon_t + o_t\n$$\n其中 $y_t$ 是时间 $t$ 的观测值，$\\tau(t)$ 是线性趋势， $s(t)$ 是正弦季节性分量，$\\varepsilon_t$ 是高斯噪声，$o_t$ 代表零星的离群值。\n\n**第 1 步：合成数据生成**\n对于每个测试用例，我们合成一个长度为 $N$ 的时间序列。时间向量为 $\\mathbf{t} = [0, 1, \\dots, N-1]^T$。\n1.  **趋势分量**：线性趋势由 $\\tau(t) = \\beta_0 + \\beta_1 t$ 给出。\n2.  **季节性分量**：问题指定了一个季节性信号，其周期为已知的 $P$，数据生成时使用零相位，$s(t) = A_{\\text{true}} \\cos(2\\pi t/P)$。\n3.  **噪声分量**：独立同分布（I.i.d.）的高斯噪声样本 $\\varepsilon_t$ 从 $\\mathcal{N}(0, \\sigma^2)$ 中抽取。\n4.  **离群值分量**：将离群值添加到比例为 $f_{\\text{out}}$ 的数据点上。我们计算离群值的数量 $N_{\\text{out}} = \\text{round}(N \\cdot f_{\\text{out}})$，随机选择 $N_{\\text{out}}$ 个唯一的时间索引，并在这些索引处设置 $o_t = \\pm M_{\\text{out}}$，符号随机选择。对于所有其他索引，$o_t = 0$。\n\n最终观测到的时间序列是这四个分量的总和：$\\mathbf{y} = \\boldsymbol{\\tau} + \\mathbf{s} + \\boldsymbol{\\varepsilon} + \\mathbf{o}$。所有随机数生成都使用固定的种子，以确保解决方案是可复现的。\n\n**第 2 步：趋势估计**\n趋势被建模为线性函数 $\\tau(t) = \\beta_0 + \\beta_1 t$。以矩阵形式，我们寻求在模型 $\\mathbf{y} \\approx \\mathbf{X}\\boldsymbol{\\beta}$ 中找到参数向量 $\\boldsymbol{\\beta} = [\\beta_0, \\beta_1]^T$，其中 $\\mathbf{X}$ 是一个 $N \\times 2$ 的设计矩阵，其列分别代表截距项和线性项：\n$$\n\\mathbf{X} = \\begin{pmatrix} 1  0 \\\\ 1  1 \\\\ \\vdots  \\vdots \\\\ 1  N-1 \\end{pmatrix}\n$$\n\n**A. 普通最小二乘法（OLS）趋势估计**\nOLS 方法寻找参数 $\\boldsymbol{\\beta}$ 以最小化残差平方和 $||\\mathbf{y} - \\mathbf{X}\\boldsymbol{\\beta}||_2^2$。这是一个标准的线性回归问题，其解由正规方程给出：\n$$\n\\hat{\\boldsymbol{\\beta}}_{\\text{OLS}} = (\\mathbf{X}^T\\mathbf{X})^{-1}\\mathbf{X}^T\\mathbf{y}\n$$\n该解对离群值很敏感，因为大的残差会被平方，从而对拟合产生过大的影响。估计的趋势为 $\\hat{\\boldsymbol{\\tau}}_{\\text{OLS}} = \\mathbf{X}\\hat{\\boldsymbol{\\beta}}_{\\text{OLS}}$。\n\n**B. 通过迭代重加权最小二乘法（IRLS）进行稳健的 Huber 趋势估计**\nHuber M-估计器最小化一个不同的目标函数，$J(\\boldsymbol{\\beta}) = \\sum_{t=0}^{N-1} \\rho_\\delta(y_t - (\\mathbf{X}\\boldsymbol{\\beta})_t)$，使用的是 Huber 损失函数 $\\rho_\\delta(r)$。对于小残差（$|r| \\le \\delta$），该损失函数的行为与 OLS 类似，呈二次方增长；但对于大残差（$|r|  \\delta$），它呈线性增长，这减少了离群值的影响。\n\n这个优化问题使用 IRLS 解决。该算法迭代地解决一个加权最小二乘问题，其中权重根据前一次迭代的残差进行调整。参数的更新步骤如下：\n$$\n\\hat{\\boldsymbol{\\beta}}^{(k+1)} = (\\mathbf{X}^T\\mathbf{W}^{(k)}\\mathbf{X})^{-1}\\mathbf{X}^T\\mathbf{W}^{(k)}\\mathbf{y}\n$$\n矩阵 $\\mathbf{W}^{(k)}$ 是在第 $k$ 次迭代时的权重 $w_t^{(k)}$ 构成的对角矩阵。每个权重是相应残差 $r_t^{(k)} = y_t - (\\mathbf{X}\\hat{\\boldsymbol{\\beta}}^{(k)})_t$ 的函数：\n$$\nw_t^{(k)} = \\begin{cases} 1,  \\text{如果 } |r_t^{(k)}| \\le \\delta \\\\ \\delta/|r_t^{(k)}|,  \\text{如果 } |r_t^{(k)}|  \\delta \\end{cases}\n$$\n算法流程如下：\n1.  初始化参数 $\\hat{\\boldsymbol{\\beta}}^{(0)}$，通常使用 OLS 解 $\\hat{\\boldsymbol{\\beta}}_{\\text{OLS}}$。\n2.  迭代计算残差，更新权重，并解决加权最小二乘问题。为了数值稳定性，更新不是通过矩阵求逆执行的，而是通过解决一个等价的标准最小二乘问题。\n3.  迭代持续进行，直到连续迭代之间的参数向量 $\\hat{\\boldsymbol{\\beta}}$ 的变化量低于指定的容差，或者达到最大迭代次数。\n收敛的解 $\\hat{\\boldsymbol{\\beta}}_{\\text{Huber}}$ 给出了稳健估计的趋势 $\\hat{\\boldsymbol{\\tau}}_{\\text{Huber}} = \\mathbf{X}\\hat{\\boldsymbol{\\beta}}_{\\text{Huber}}$。\n\n**第 3 步：季节性振幅估计**\n从原始数据中减去估计的趋势以获得去趋势化序列。对两种趋势估计都执行此操作：\n$$\n\\mathbf{d}_{\\text{OLS}} = \\mathbf{y} - \\hat{\\boldsymbol{\\tau}}_{\\text{OLS}} \\quad \\text{和} \\quad \\mathbf{d}_{\\text{Huber}} = \\mathbf{y} - \\hat{\\boldsymbol{\\tau}}_{\\text{Huber}}\n$$\n然后我们对每个去趋势化序列拟合一个谐波模型。模型为 $d(t) \\approx a \\cos(2\\pi t/P) + b \\sin(2\\pi t/P)$。系数 $\\boldsymbol{\\gamma} = [a, b]^T$ 通过最小二乘法求得。此回归的设计矩阵为：\n$$\n\\mathbf{S} = \\begin{pmatrix}\n\\cos(\\frac{2\\pi \\cdot 0}{P})  \\sin(\\frac{2\\pi \\cdot 0}{P}) \\\\\n\\vdots  \\vdots \\\\\n\\cos(\\frac{2\\pi \\cdot (N-1)}{P})  \\sin(\\frac{2\\pi \\cdot (N-1)}{P})\n\\end{pmatrix}\n$$\n系数的解为 $\\hat{\\boldsymbol{\\gamma}} = (\\mathbf{S}^T\\mathbf{S})^{-1}\\mathbf{S}^T\\mathbf{d}$。这会产生系数向量 $\\hat{\\boldsymbol{\\gamma}}_{\\text{OLS}}$ 和 $\\hat{\\boldsymbol{\\gamma}}_{\\text{Huber}}$。相应的振幅是这些向量的欧几里得范数：\n$$\nA_{\\text{OLS}} = ||\\hat{\\boldsymbol{\\gamma}}_{\\text{OLS}}||_2 \\quad \\text{和} \\quad A_{\\text{Huber}} = ||\\hat{\\boldsymbol{\\gamma}}_{\\text{Huber}}||_2\n$$\n\n**第 4 步：最终比较**\n每个测试用例的最终度量标准是两个估计振幅之间的差异，它量化了稳健趋势估计的效果：\n$$\n\\Delta A = A_{\\text{Huber}} - A_{\\text{OLS}}\n$$\n非零值表示去趋势化方法的选择会影响季节性分析。在存在离群值的情况下，OLS 趋势可能会有显著偏差，导致去趋势化序列受到污染，振幅估计不准确。而 Huber 回归是稳健的，应该能产生更准确的趋势，从而得到更可靠的季节性振幅。",
            "answer": "```python\nimport numpy as np\nfrom scipy.linalg import lstsq\n\ndef generate_time_series(N, P, beta0, beta1, A_true, sigma, f_out, M_out, rng):\n    \"\"\"Generates a synthetic time series based on the additive model.\"\"\"\n    t = np.arange(N)\n    \n    # 1. Trend component\n    trend = beta0 + beta1 * t\n    \n    # 2. Seasonal component\n    seasonal = A_true * np.cos(2 * np.pi * t / P)\n    \n    # 3. Noise component\n    noise = rng.normal(0, sigma, N)\n    \n    # 4. Outlier component\n    outliers = np.zeros(N)\n    n_outliers = int(round(f_out * N))\n    if n_outliers  0:\n        outlier_indices = rng.choice(N, size=n_outliers, replace=False)\n        outlier_signs = rng.choice([-1, 1], size=n_outliers)\n        outliers[outlier_indices] = outlier_signs * M_out\n        \n    y = trend + seasonal + noise + outliers\n    return t, y\n\ndef estimate_trend_ols(t, y):\n    \"\"\"Estimates trend coefficients using Ordinary Least Squares.\"\"\"\n    X = np.stack([np.ones_like(t), t], axis=1)\n    beta_ols, _, _, _ = lstsq(X, y)\n    return beta_ols\n\ndef estimate_trend_huber_irls(t, y, delta, max_iter=100, tol=1e-6):\n    \"\"\"Estimates trend coefficients using Huber regression via IRLS.\"\"\"\n    X = np.stack([np.ones_like(t), t], axis=1)\n    \n    # Initialize with OLS solution\n    beta = estimate_trend_ols(t, y)\n    \n    for _ in range(max_iter):\n        residuals = y - X @ beta\n        abs_residuals = np.abs(residuals)\n        \n        # Calculate weights based on Huber's psi-function/residual\n        # w(r) = min(1, delta/|r|)\n        # Add a small epsilon to avoid division by zero, although not strictly necessary\n        # as |r|  delta for the second case.\n        weights = np.minimum(1.0, delta / (abs_residuals + 1e-8))\n        \n        # Perform weighted least squares\n        # This is equivalent to solving lstsq for L*y and L*X where L = sqrt(W)\n        L = np.sqrt(weights)\n        X_w = X * L[:, np.newaxis]\n        y_w = y * L\n        \n        beta_new, _, _, _ = lstsq(X_w, y_w)\n        \n        if np.linalg.norm(beta_new - beta)  tol:\n            break\n        beta = beta_new\n        \n    return beta\n\ndef estimate_seasonal_amplitude(t, detrended_y, P):\n    \"\"\"Estimates seasonal amplitude from a detrended series.\"\"\"\n    S = np.stack([\n        np.cos(2 * np.pi * t / P),\n        np.sin(2 * np.pi * t / P)\n    ], axis=1)\n    \n    gamma, _, _, _ = lstsq(S, detrended_y)\n    amplitude = np.linalg.norm(gamma)\n    return amplitude\n\ndef solve():\n    \"\"\"\n    Main function to run the time series decomposition for all test cases.\n    \"\"\"\n    test_cases = [\n        # (N, P, beta0, beta1, A_true, sigma, f_out, M_out, delta)\n        (60, 12, 0.4, 0.0015, 0.15, 0.02, 0.10, 0.35, 0.05),\n        (60, 12, 0.5, 0.0000, 0.12, 0.01, 0.00, 0.00, 0.05),\n        (48, 12, 0.3, 0.0020, 0.08, 0.03, 0.25, 0.50, 0.03),\n        (36, 12, 0.6, -0.0010, 0.10, 0.015, 0.15, 0.40, 0.005),\n        (24, 12, 0.45, 0.0010, 0.00, 0.02, 0.20, 0.30, 0.05),\n    ]\n\n    results = []\n    # Use a fixed seed for reproducibility of random components.\n    seed = 42\n    rng = np.random.default_rng(seed)\n\n    for params in test_cases:\n        N, P, beta0, beta1, A_true, sigma, f_out, M_out, delta = params\n        \n        # 1. Generate synthetic time series data\n        t, y = generate_time_series(N, P, beta0, beta1, A_true, sigma, f_out, M_out, rng)\n        \n        # 2. Estimate trend using OLS\n        beta_ols = estimate_trend_ols(t, y)\n        tau_ols = beta_ols[0] + beta_ols[1] * t\n        d_ols = y - tau_ols\n        A_ols = estimate_seasonal_amplitude(t, d_ols, P)\n\n        # 3. Estimate trend using Huber regression (IRLS)\n        beta_huber = estimate_trend_huber_irls(t, y, delta)\n        tau_huber = beta_huber[0] + beta_huber[1] * t\n        d_huber = y - tau_huber\n        A_huber = estimate_seasonal_amplitude(t, d_huber, P)\n\n        # 4. Calculate and store the difference\n        results.append(A_huber - A_ols)\n\n    # Print results in the specified format\n    print(f\"[{','.join(f'{r:.8f}' for r in results)}]\")\n\nsolve()\n\n```"
        },
        {
            "introduction": "在分解时间序列并拟合季节性模型后，一个至关重要的步骤是评估模型的充分性，即检查我们的模型是否成功捕捉了所有的系统性模式。本练习探讨了如何使用残差诊断，特别是自相关函数 (Autocorrelation Function, ACF)，来完成这项任务。残差的ACF结构可以揭示季节性分量是被欠拟合还是过拟合。通过从理论上推导模型设定不当情况下的残差ACF形态 ，您将掌握一种强大的诊断技术，这对于构建可信的时间序列模型和避免错误结论至关重要。",
            "id": "3843881",
            "problem": "一个植被区域的月度归一化植被指数（NDVI）时间序列 $\\{X_t\\}_{t=1}^{n}$ 被加性建模为 $X_t = T_t + S_t + \\varepsilon_t$，其中 $T_t$ 是平滑趋势，$S_t$ 是周期为 $s=12$ 的季节性分量，$\\varepsilon_t$ 是均值为零、独立同分布、方差为 $\\sigma^{2}$ 的高斯白噪声。季节性分量由谐波展开式 $S_t = \\sum_{k=1}^{K^{\\star}} A_k \\cos\\!\\left(2\\pi \\frac{k}{12} t + \\phi_k\\right)$ 生成，其中 $K^{\\star} \\in \\mathbb{N}$ 是谐波的真实数量，$A_k0$ 是振幅，$\\phi_k \\in \\mathbb{R}$ 是相位。考虑通过谐波回归进行季节性调整，该调整移除了 $K$ 个谐波。\n\n你的任务是构建残差诊断来评估季节性调整的充分性，并推导在模型欠拟合与过拟合情况下残差自相关函数（ACF）的期望模式。仅使用以下基本原理：(弱)平稳过程的自协方差和自相关的定义、具有不同谐波频率的正弦函数在整数个周期上的正交性，以及高斯白噪声的性质。\n\n在大样本情况下进行分析，即 $n$ 很大，并且任何被正确包含的谐波的拟合季节性系数都收敛到其真实值，因此被正确包含的谐波会以概率形式从残差中完全移除。设季节性调整后的残差为 $r_t = X_t - \\widehat{T}_t - \\widehat{S}_t$。\n\n任务：\n1. 从第一性原理（自协方差的定义及上述性质）出发，推导在季节模型欠拟合的情况下，大样本期望残差自相关在滞后 $h$ 处的表达式，记为 $\\rho(h)$。该情况指模型遗漏了一个频率为 $f=\\frac{k}{12}$、振幅为 $A_k$ 的真实谐波，同时正确移除了所有其他真实谐波和趋势。你的表达式必须仅依赖于 $A_k$、$\\sigma^{2}$、$h$ 和 $f$。\n2. 使用你推导的表达式，将其应用于月度情况，其中遗漏的谐波为 $k=2$，因此 $f=\\frac{1}{6}$，振幅为 $A_2=0.15$，噪声方差为 $\\sigma^{2}=0.01$。计算滞后 $h=6$ 处的期望残差自相关。\n3. 简要说明，在不计算任何额外数值的情况下，如果季节模型因包含一个真实振幅为零的额外谐波而过拟合，那么在任意滞后处的大样本期望残差ACF是什么（假设所有真实谐波都已被正确包含和移除，且噪声是高斯白噪声）。\n\n将你的最终答案表示为任务2中欠拟合情况下滞后 $h=6$ 时的期望残差自相关的单一数值。将答案四舍五入到四位有效数字。提供一个无量纲的数字（无单位）。",
            "solution": "问题陈述已经过验证，被认为是有效的。它在时间序列分析方面有科学依据，问题提出得当，客观，并包含足够的信息来推导出唯一解。\n\n该问题要求分析在不同模型设定情景下，对时间序列模型进行季节性调整后产生的残差自相关函数（ACF）。时间序列由加性模型 $X_t = T_t + S_t + \\varepsilon_t$ 给出，其中 $T_t$ 是趋势，$S_t$ 是周期为 $s=12$ 的季节性分量，$\\varepsilon_t$ 是均值为 $0$、方差为 $\\sigma^2$ 的高斯白噪声。季节性分量是 $K^\\star$ 个谐波的总和：$S_t = \\sum_{k=1}^{K^{\\star}} A_k \\cos(2\\pi \\frac{k}{12} t + \\phi_k)$。\n\n### 任务1：模型欠拟合下的残差ACF\n\n在这种情况下，季节性调整是欠拟合的，意味着它未能移除一个真实的谐波分量。问题指明，趋势 $T_t$ 和所有真实的谐波都被移除，除了一个频率为 $f = \\frac{k}{12}$、振幅为 $A_k$ 的谐波。在这种不完美的调整之后，残差 $r_t = X_t - \\widehat{T}_t - \\widehat{S}_t$ 由拟合分量收敛到其真实值的大样本极限给出。\n$$r_t = (T_t + S_t + \\varepsilon_t) - T_t - \\left(S_t - A_k \\cos\\left(2\\pi f t + \\phi_k\\right)\\right)$$\n$$r_t = A_k \\cos\\left(2\\pi f t + \\phi_k\\right) + \\varepsilon_t$$\n让我们将未建模的季节性分量表示为 $S_{k,t} = A_k \\cos(2\\pi f t + \\phi_k)$。残差序列是 $r_t = S_{k,t} + \\varepsilon_t$。\n\n为了找到自相关函数 $\\rho(h)$，我们首先推导自协方差函数 $\\gamma(h)$。我们将残差序列 $r_t$ 视为一个弱平稳过程的实现。这可以通过假设相位 $\\phi_k$ 是一个服从 Uniform($[0, 2\\pi]$) 分布的随机变量来概念化，这使得过程 $S_{k,t}$（以及 $r_t$）成为一个均值为零的弱平稳过程。\n滞后 $h$ 处的自协方差定义为 $\\gamma(h) = E[r_t r_{t+h}]$。\n$$\\gamma(h) = E[(S_{k,t} + \\varepsilon_t)(S_{k,t+h} + \\varepsilon_{t+h})]$$\n展开此表达式得到：\n$$\\gamma(h) = E[S_{k,t}S_{k,t+h}] + E[S_{k,t}\\varepsilon_{t+h}] + E[\\varepsilon_t S_{k,t+h}] + E[\\varepsilon_t \\varepsilon_{t+h}]$$\n由于噪声过程 $\\varepsilon_t$ 独立于季节性分量 $S_{k,t}$，交叉项为零：$E[S_{k,t}\\varepsilon_{t+h}] = E[S_{k,t}]E[\\varepsilon_{t+h}] = 0 \\cdot 0 = 0$。\n自协方差分解为信号和噪声的自协方差之和：\n$$\\gamma(h) = \\gamma_S(h) + \\gamma_\\varepsilon(h)$$\n根据定义，白噪声过程 $\\varepsilon_t$ 的自协方差为：\n$$\\gamma_\\varepsilon(h) = E[\\varepsilon_t \\varepsilon_{t+h}] = \\begin{cases} \\sigma^2  \\text{if } h=0 \\\\ 0  \\text{if } h \\neq 0 \\end{cases} \\quad = \\sigma^2 \\delta_{h,0}$$\n其中 $\\delta_{h,0}$ 是克罗内克（Kronecker）δ函数。\n\n未建模谐波 $S_{k,t}$ 的自协方差为：\n$$\\gamma_S(h) = E[A_k \\cos(2\\pi f t + \\phi_k) \\cdot A_k \\cos(2\\pi f (t+h) + \\phi_k)]$$\n使用三角恒等式 $\\cos(A)\\cos(B) = \\frac{1}{2}[\\cos(A-B) + \\cos(A+B)]$：\n$$\\gamma_S(h) = A_k^2 E\\left[\\frac{1}{2}\\left(\\cos(-2\\pi f h) + \\cos(2\\pi f(2t+h) + 2\\phi_k)\\right)\\right]$$\n$$\\gamma_S(h) = \\frac{A_k^2}{2} \\left(\\cos(2\\pi f h) + E[\\cos(4\\pi f t + 2\\pi f h + 2\\phi_k)]\\right)$$\n第二个余弦项在随机相位 $\\phi_k$ 上的期望为零。从大样本极限的时间平均角度来看，也能得到这个结果，因为一个正弦函数在多个周期上的平均值趋近于零。因此：\n$$\\gamma_S(h) = \\frac{A_k^2}{2} \\cos(2\\pi f h)$$\n残差序列 $r_t$ 的总自协方差为：\n$$\\gamma_r(h) = \\frac{A_k^2}{2} \\cos(2\\pi f h) + \\sigma^2 \\delta_{h,0}$$\n序列的方差是滞后 $h=0$ 处的自协方差：\n$$\\gamma_r(0) = \\frac{A_k^2}{2} \\cos(0) + \\sigma^2 = \\frac{A_k^2}{2} + \\sigma^2$$\n自相关函数为 $\\rho(h) = \\frac{\\gamma_r(h)}{\\gamma_r(0)}$。\n$$\\rho(h) = \\frac{\\frac{A_k^2}{2} \\cos(2\\pi f h) + \\sigma^2 \\delta_{h,0}}{\\frac{A_k^2}{2} + \\sigma^2}$$\n对于任意非零滞后 $h \\neq 0$，克罗内克δ函数为零，表达式简化为：\n$$\\rho(h) = \\frac{\\frac{A_k^2}{2} \\cos(2\\pi f h)}{\\frac{A_k^2}{2} + \\sigma^2}, \\quad h \\neq 0$$\n这就是所要求的表达式。它揭示了残差ACF本身将是周期性的，描绘出一个频率为 $f$（遗漏谐波的频率）的余弦波，其振幅被噪声方差所衰减。\n\n### 任务2：特定案例的数值计算\n\n我们被要求计算在特定情况下滞后 $h=6$ 处的期望残差自相关：\n- 遗漏谐波：$k=2$\n- 频率：$f = \\frac{k}{12} = \\frac{2}{12} = \\frac{1}{6}$\n- 振幅：$A_2 = 0.15$\n- 噪声方差：$\\sigma^2 = 0.01$\n- 滞后：$h=6$\n\n使用推导出的 $h \\neq 0$ 时的 $\\rho(h)$ 公式：\n$$\\rho(6) = \\frac{\\frac{A_2^2}{2} \\cos(2\\pi f h)}{\\frac{A_2^2}{2} + \\sigma^2}$$\n代入给定值：\n$$\\rho(6) = \\frac{\\frac{(0.15)^2}{2} \\cos\\left(2\\pi \\cdot \\frac{1}{6} \\cdot 6\\right)}{\\frac{(0.15)^2}{2} + 0.01}$$\n余弦函数的参数是 $2\\pi \\cdot \\frac{1}{6} \\cdot 6 = 2\\pi$。由于 $\\cos(2\\pi)=1$：\n$$\\rho(6) = \\frac{\\frac{0.0225}{2}}{\\frac{0.0225}{2} + 0.01} = \\frac{0.01125}{0.01125 + 0.01}$$\n$$\\rho(6) = \\frac{0.01125}{0.02125}$$\n这个分数可以简化为 $\\frac{1125}{2125} = \\frac{9 \\times 125}{17 \\times 125} = \\frac{9}{17}$。\n表示为小数，即：\n$$\\rho(6) = \\frac{9}{17} \\approx 0.52941176...$$\n四舍五入到四位有效数字，我们得到 $0.5294$。这个高的正相关是预料之中的，因为滞后 $h=6$ 与遗漏谐波的周期（$1/f = 6$ 个月）相匹配，所以残差在经过一个未建模动态的完整周期后与自身强相关。\n\n### 任务3：模型过拟合下的残差ACF\n\n在过拟合的情况下，模型包含一个真实振幅为零的额外谐波项。所有真实的谐波都已正确包含。在大样本情况下，像谐波回归（一种普通最小二乘法）这样的一致性估计方法将产生收敛到其真实值的系数估计。\n真实模型是 $X_t = T_t + S_t + \\varepsilon_t$。拟合模型包含 $T_t$ 和 $S_t$ 的所有分量，外加一个不存在的额外谐波。当 $n \\to \\infty$ 时，这个额外谐波的估计系数（振幅）将收敛到其真实值零。因此，拟合的趋势和季节性 $\\widehat{T}_t + \\widehat{S}_t$ 会依概率收敛到真实的趋势和季节性 $T_t + S_t$。\n因此，残差为：\n$$r_t = X_t - (\\widehat{T}_t + \\widehat{S}_t) \\xrightarrow{n \\to \\infty} (T_t + S_t + \\varepsilon_t) - (T_t + S_t) = \\varepsilon_t$$\n在大样本极限下，残差序列 $r_t$ 收敛到白噪声过程 $\\varepsilon_t$。根据定义，白噪声过程的自相关函数在滞后 $h=0$ 时为 $1$，在所有非零滞后 $h \\neq 0$ 时为 $0$。\n因此，在过拟合情况下，大样本期望残差ACF在所有 $h \\neq 0$ 时为 $\\rho(h) = 0$。",
            "answer": "$$\\boxed{0.5294}$$"
        }
    ]
}