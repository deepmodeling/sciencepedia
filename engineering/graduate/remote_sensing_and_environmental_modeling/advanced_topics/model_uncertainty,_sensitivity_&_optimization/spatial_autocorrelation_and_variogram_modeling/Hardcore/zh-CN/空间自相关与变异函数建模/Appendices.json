{
    "hands_on_practices": [
        {
            "introduction": "像莫兰指数（Moran's $I$）这样的全局统计量可以提供空间自相关的单一概括，但有时可能会产生误导。这个思想实验 () 要求你构建一个场景，其中全局指数显示不存在空间依赖性，而变异函数却清晰地揭示了复杂且依赖于尺度的结构。通过这个练习，你将更深刻地体会到变异函数在诊断全局指标所忽略的模式方面的强大能力，并理解空间分辨率如何改变我们的结论。",
            "id": "3850269",
            "problem": "一个大小为 $N \\times N$（其中 $N$ 为偶数）的方形栅格代表了从卫星传感器反演出的生物物理变量，例如归一化植被指数（NDVI）。考虑在节点 $\\{(i,j): i,j \\in \\{1,\\dots,N\\}\\}$ 上的一个平稳信号加格局模型，该模型采用周期性边界条件以抑制边缘效应。令 $Z_{ij} = U_{ij} + V_{ij}$，其中 $U$ 是一个零均值、各向同性的高斯随机场，其方差为 $\\sigma_U^2$，协方差函数为 $C_U(h) = \\sigma_U^2 \\exp(-h/\\phi)$（指数模型；$h$ 以像素为单位度量），而 $V$ 是一个确定性的棋盘格格局 $V_{ij} = a \\, (-1)^{i+j}$。假设 $\\sigma_U^2 = 1$ 且 $\\phi = 2$。全局莫兰指数 $I$（Global Moran’s $I$）在原始 $N \\times N$ 网格上使用车邻接权重进行计算。一位分析师还在同一网格上计算各向同性经验半变异函数，并检查滞后距 $h$ 等于 $1$ 和 $2$ 个像素间距的情况。最后，该分析师通过不重叠的 $2 \\times 2$ 块平均对栅格进行粗化（即，每个粗单元是其对应的 $2 \\times 2$ 细单元的算术平均值），重新计算全局莫兰指数 $I$（在粗网格上使用车邻接权重），并重新计算半变异函数。\n\n哪个选项最好地描述了对 $a$ 的一个具体选择，该选择使得精细网格上的全局莫兰指数 $I$ 表明没有自相关，而半变异函数仍然揭示了尺度依赖结构，并正确描述了 $2 \\times 2$ 聚合的预期效果？\n\nA. 选择 $a$ 使得 $a^2 \\approx C_U(1)$；那么精细网格上的预期全局莫兰指数 $I$ 近似为 $0$，因为来自 $U$ 和 $V$ 的最近邻协方差相互抵消，但由于交替棋盘格在奇数滞后距上的贡献，半变异函数表现出 $\\gamma(1) > \\gamma(2)$。经过 $2 \\times 2$ 块平均后，棋盘格分量被消除，因此全局莫兰指数 $I$ 变为正值，并且半变异函数在 $h=1$ 和 $h=2$ 之间的交替现象消失。\n\nB. 选择 $a$ 使得 $a^2 \\approx C_U(1)$；那么精细网格上的预期全局莫兰指数 $I$ 是强负相关的，并且半变异函数是平坦的（没有尺度依赖性）。经过 $2 \\times 2$ 块平均后，莫兰指数 $I$ 和半变异函数都没有发生有意义的变化。\n\nC. 选择 $a$ 使得 $a^2 \\approx C_U(1)$；那么精细网格上的预期全局莫兰指数 $I$ 近似为 $0$，并且半变异函数随 $h$ 单调增加而没有交替。经过 $2 \\times 2$ 块平均后，负自相关增强，并且半变异函数的交替现象出现在粗尺度上。\n\nD. 这样的构造是不可能的：如果全局莫兰指数 $I$ 接近 $0$，那么半变异函数就不能揭示任何尺度依赖的结构，并且 $2 \\times 2$ 聚合在期望上也不能改变这个结论。",
            "solution": "### 求解推导\n\n本题的分析分为两部分：首先是在精细的 $N \\times N$ 网格上，其次是在通过 $2 \\times 2$ 块平均得到的粗网格上。\n\n#### 第1部分：精细网格上的分析\n\n模型为 $Z_{ij} = U_{ij} + V_{ij}$。随机分量 $U$ 是一个零均值随机场，其协方差函数为 $C_U(h) = \\exp(-h/2)$（因为 $\\sigma_U^2=1, \\phi=2$）。确定性分量是棋盘格格局 $V_{ij} = a \\, (-1)^{i+j}$。\n\n**1. 精细网格上的全局莫兰指数 $I$**\n全局莫兰指数 $I$ 的期望值近似正比于相邻单元之间的平均协方差。我们使用车邻接（rook contiguity），因此邻居间的距离为 $h=1$。由于 $U$ 和 $V$ 的均值都为零，相邻单元的期望乘积为：\n$$ E[Z_{ij} Z_{i+1,j}] = E[(U_{ij}+V_{ij})(U_{i+1,j}+V_{i+1,j})] = E[U_{ij} U_{i+1,j}] + V_{ij}V_{i+1,j} $$\n这等于 $C_U(1) + V_{ij}V_{i+1,j}$。对于棋盘格格局 $V$，任何一对车邻居的乘积都是负的：\n$$ V_{ij}V_{i+1,j} = \\left( a(-1)^{i+j} \\right) \\left( a(-1)^{i+1+j} \\right) = a^2 (-1)^{2i+2j+1} = -a^2 $$\n因此，相邻单元的平均协方差为 $C_U(1) - a^2$。要使全局莫兰指数 $I$ 的期望值近似为零，这个协方差需要为零。这给出了条件：\n$$ C_U(1) - a^2 \\approx 0 \\implies a^2 \\approx C_U(1) = \\exp(-1/2) $$\n这个条件意味着，在滞后距为1时，来自随机场 $U$ 的正空间自相关恰好被来自棋盘格格局 $V$ 的负空间自相关所抵消。\n\n**2. 精细网格上的半变异函数**\n半变异函数 $\\gamma_Z(h)$ 是各分量半变异函数之和：$\\gamma_Z(h) = \\gamma_U(h) + \\gamma_V(h)$。\n-   对于随机场 $U$，$\\gamma_U(h) = C_U(0) - C_U(h) = 1 - \\exp(-h/2)$。\n-   对于棋盘格 $V$，半变异函数是根据其确定性结构计算的：\n    -   滞后距 $h=1$：相邻点的值相反（如 $a$ 和 $-a$），差的平方为 $(2a)^2 = 4a^2$。因此 $\\gamma_V(1) = \\frac{1}{2}(4a^2) = 2a^2$。\n    -   滞后距 $h=2$：相距为2的点值相同（如 $a$ 和 $a$），差的平方为 $0$。因此 $\\gamma_V(2) = 0$。\n\n将两者结合，得到 $Z$ 的半变异函数：\n-   $\\gamma_Z(1) = \\gamma_U(1) + \\gamma_V(1) = (1 - e^{-1/2}) + 2a^2$\n-   $\\gamma_Z(2) = \\gamma_U(2) + \\gamma_V(2) = (1 - e^{-2/2}) + 0 = 1 - e^{-1}$\n\n现在代入从莫兰指数 $I$ 推导出的条件 $a^2 \\approx e^{-1/2}$：\n-   $\\gamma_Z(1) \\approx (1 - e^{-1/2}) + 2 e^{-1/2} = 1 + e^{-1/2} \\approx 1.607$\n-   $\\gamma_Z(2) = 1 - e^{-1} \\approx 0.632$\n\n我们清楚地看到 $\\gamma_Z(1) > \\gamma_Z(2)$。这种半变异值从滞后距1到2减小的非单调行为，是半变异图中的一个“交替”特征，它揭示了被全局莫兰指数 $I$ 所忽略的潜在周期性结构。\n\n#### 第2部分：粗网格上的分析（$2 \\times 2$ 块平均）\n\n当对栅格进行 $2 \\times 2$ 块平均时，任何一个 $2 \\times 2$ 的精细单元块都包含两个值为 $a$ 的单元和两个值为 $-a$ 的单元。因此，棋盘格分量 $V$ 在每个块内的平均值为零。这意味着在粗化后的网格上，确定性格局被完全消除了。\n$$ V'_{\\text{block}} = \\frac{1}{4}(a - a - a + a) = 0 $$\n因此，粗网格 $Z'$ 只剩下平均后的随机场分量：$Z' = U'$。\n\n由于原始随机场 $U$ 在所有尺度上都具有正自相关性（指数协方差函数），对其进行平滑（平均）会保留这种正自相关性。因此，在粗网格上计算的莫兰指数 $I$ 将是正的。同时，由于棋盘格分量已被移除，导致精细网格上半变异函数出现交替现象的根源也消失了。粗网格的半变异函数 $\\gamma_{Z'}(h')$ 将反映平滑场 $U'$ 的结构，它将是一个随滞后距单调递增的函数。\n\n#### 结论\n\n选项A完美地描述了这一系列现象：(1) 在 $a^2 \\approx C_U(1)$ 的条件下，精细网格上的莫兰指数 $I \\approx 0$；(2) 半变异函数因棋盘格的存在而显示出 $\\gamma(1) > \\gamma(2)$ 的交替行为；(3) $2 \\times 2$ 聚合消除了棋盘格格局，导致粗网格上的莫兰指数 $I$ 变为正值，并且半变异函数的交替现象消失。其他选项都与此分析相悖。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "任何变异函数模型的质量都从根本上受限于其所依据的数据。这个实践问题 () 将你从理论带入地质统计学实地设计的实践艺术中，要求你在固定的预算下选择最优的采样策略。评估这些选项将锻炼你在设计数据采集方案方面的能力，以有效地捕获不同空间尺度上的信息，从而确保对基台效应、台基值、变程和各向异性的稳健估计。",
            "id": "3850190",
            "problem": "我们正在研究一个面积为 $20\\,\\text{km} \\times 20\\,\\text{km}$ 的流域，以模拟近地表土壤电导率 $Z(\\mathbf{s})$ 的空间自相关性，用于卫星衍生的陆地表面盐度指数 (LSSI) 的协变量校准。初步遥感分析表明，空间依赖性在整个区域内近似为二阶平稳，并表现出几何各向异性，其椭圆相关结构的主轴沿东北-西南方向排列，各向异性比（主轴:次轴）约为 $2{:}1$，主方向上的实际相关程在 $4\\,\\text{km}$ 到 $6\\,\\text{km}$ 之间。现场测量的支撑尺寸小于 $0.05\\,\\text{km}$，微尺度变异性与仪器噪声共同表明存在不可忽略的块金值，这要求经验变异函数分组的滞后距低于 $0.3\\,\\text{km}$。目标是估计全向和方向经验变异函数，以拟合一个能够可靠识别块金值、基台值和变程的各向异性模型。\n\n您必须在 $N=120$ 个点测量的预算限制下选择一种抽样方案，该方案通过以下方式优化经验变异函数估计：(i) 确保有足够的短滞后距对来解析块金值（即，大量间距 $h \\lesssim 0.3\\,\\text{km}$ 的数据对），(ii) 确保有足够的长滞后距对，能够跨越并超过主方向和次方向上的预期变程（即，$h$ 至少达到 $10\\,\\text{km}$），以及 (iii) 通过在以主轴和次轴为中心的角度扇区内有足够的数据对来支持方向变异函数，以诊断各向异性。使用（半）变异函数的基本定义 $\\gamma(\\mathbf{h}) = \\tfrac{1}{2}\\,\\mathrm{Var}\\big(Z(\\mathbf{s}) - Z(\\mathbf{s}+\\mathbf{h})\\big)$，以及经验变异函数估计量的不确定性随每个滞后距分组中的数据对数量 $N(\\mathbf{h})$ 的增加而减小这一事实，并考虑抽样布局所带来的几何约束。\n\n考虑以下候选设计方案：\n\nA. 一个覆盖整个区域的 $12 \\times 10$ 规则矩形格网，东西方向的等间距约为 $1.818\\,\\text{km}$，南北方向的等间距约为 $2.222\\,\\text{km}$。点位于格网交点处；没有局部加密。\n\nB. 一种分层抑制性随机（均匀）抽样，在 $4$ 个等面积分层中，最小点间距为 $0.5\\,\\text{km}$，每层分配 $30$ 个点，没有有意的聚类或方向性排列。\n\nC. 一种多尺度、感知各向异性的嵌套聚类设计：沿东北-西南轴线，以大约 $4\\,\\text{km}$ 到 $5\\,\\text{km}$ 的均匀间距在整个区域内放置 $8$ 个锚定聚类。在每个聚类内部，以放射状嵌套模式抽取 $12$ 个点：$5$ 个点在半径 $0.25\\,\\text{km}$ 以内（角度相隔 $72^\\circ$），另外 $4$ 个点在 $0.25\\,\\text{km}$ 和 $0.8\\,\\text{km}$ 之间（在不同的方位角），以及 $3$ 个点在 $0.8\\,\\text{km}$ 和 $1.5\\,\\text{km}$ 之间。调整聚类射线方向以包含主轴和次轴。剩余的预算（如有）用于放置 $24$ 个桥接点，沿主轴连接聚类中心，以确保在 $5\\,\\text{km}$ 到 $10\\,\\text{km}$ 附近有数据对。\n\nD. 两条长样带：一条沿东北-西南轴线，另一条沿西北-东南轴线。在每条样带上，前 $2\\,\\text{km}$ 的间距为 $0.33\\,\\text{km}$，之后为 $1\\,\\text{km}$ 的间距，放置 $60$ 个点，从而覆盖每个轴向上的区域长度。\n\n在给定的约束条件下，哪种设计最能满足对块金值、基台值、变程和各向异性进行稳健经验变异函数估计的准则？\n\n选择一个选项：\n\nA. 规则格网。\n\nB. 分层抑制性随机抽样。\n\nC. 带聚类间桥接点的多尺度、感知各向异性的嵌套聚类。\n\nD. 沿疑似主轴和次轴的两条长样带。",
            "solution": "### 抽样方案分析\n\n我们的目标是选择一个能够在预算内最好地满足三个关键准则的抽样设计，这三个准则分别是：解析块金效应（需要短滞后距对），确定变程和基台值（需要长滞后距对），以及诊断各向异性（需要在多个方向上有足够的数据对）。\n\n**A. 规则矩形格网 ($12 \\times 10$)**\n- **块金值解析 ($h \\lesssim 0.3\\,\\text{km}$):** 此设计的最小采样间距约为 $1.818\\,\\text{km}$。它完全无法生成解析块金效应所需的短于 $0.3\\,\\text{km}$ 的数据对。因此，该设计存在根本性缺陷。\n- **结论：** 不合适。\n\n**B. 分层抑制性随机抽样**\n- **块金值解析 ($h \\lesssim 0.3\\,\\text{km}$):** 该设计强制要求点间最小距离为 $0.5\\,\\text{km}$。因此，它也无法生成估计块金效应所需的短于 $0.3\\,\\text{km}$ 的数据对。\n- **结论：** 不合适。\n\n**D. 两条长样带**\n- **块金值解析 ($h \\lesssim 0.3\\,\\text{km}$):** 该设计包含了 $0.33\\,\\text{km}$ 的间距，接近所需的目标，但略高。它仅在非常特定的方向上提供信息。\n- **各向异性诊断：** 这是该设计的主要弱点。所有的数据对都严格地沿两条正交的轴线分布。它完全没有提供任何非轴向方向（如东西向或南北向）的信息。这使得验证各向异性模型（例如，确认其是椭圆形的）变得不可能，因为我们无法检查模型在其他方向上的表现。这种设计对先验信息的假设过强，缺乏稳健性。\n- **结论：** 不合适。\n\n**C. 多尺度、感知各向异性的嵌套聚类**\n该设计是一种分层方法，专门为了高效地估计变异函数而定制。\n- **块金值解析 ($h \\lesssim 0.3\\,\\text{km}$):** 每个聚类内部都有一个半径为 $0.25\\,\\text{km}$ 的密集子样本。这个设计专门用于生成大量的小于 $0.3\\,\\text{km}$ 的短滞后距对，非常适合精确地解析变异函数在原点附近的行为和估计块金效应。\n- **变程和基台值解析 ($h \\ge 10\\,\\text{km}$):** 聚类本身分布在整个研究区域，确保了中长距离的数据对覆盖。最远的聚类之间相距超过 $25\\,\\text{km}$。此外，专门加入的“桥接点”确保了在预期变程（$4-6\\,\\text{km}$）附近和之外（直至 $10\\,\\text{km}$）有良好的数据对覆盖，这对于精确确定变程和基台值至关重要。\n- **各向异性诊断：** 该设计明确地考虑了各向异性。聚类沿主轴（NE-SW）排列，确保了在该方向上有大量数据对。聚类内部的放射状设计以及聚类间的组合，能够在所有方向上都生成数据对，从而可以计算可靠的全向和方向变异函数，稳健地拟合二维各向异性模型。\n\n**最终结论**\n选项C，即多尺度嵌套聚类设计，是唯一一个系统性地、同时满足所有三个关键标准的方案。它通过在不同空间尺度和方向上策略性地分配采样点，实现了对变异函数所有关键特征（块金、变程、基台和各向异性）的最优估计。这代表了地统计学采样设计中的一种最佳实践方法。",
            "answer": "$$\\boxed{C}$$"
        },
        {
            "introduction": "在地质统计学建模中，验证平稳性假设是至关重要的一步。这个综合性的编程练习 () 将指导你完成一个完整的工作流程，从移除合成空间数据中的确定性趋势，到计算残差的经验变异函数。你将实施一系列定量检查，以严格评估最终的残差场是否满足内在平稳性的标准，从而将关键的理论概念整合到实际且可重复的分析中。",
            "id": "3850245",
            "problem": "给定一个合成的遥感场景，其中在一个二维区域上测量了以摄氏度表示的午间陆地表面温度（LST）。测量的场被建模为一个确定性漂移和一个零均值平稳随机分量的和。您的任务是构建一个完整的工作流，识别并移除数据中的确定性漂移，然后通过经验变异图属性验证残差的内蕴平稳性。\n\n用于推导的基本原理和定义：\n- 令 $Z(\\mathbf{s})$ 表示空间位置 $\\mathbf{s} \\in \\mathbb{R}^2$ 处的观测场。假设 $Z(\\mathbf{s}) = m(\\mathbf{s}) + Y(\\mathbf{s})$，其中 $m(\\mathbf{s})$ 是一个确定性漂移，$Y(\\mathbf{s})$ 是一个零均值平稳高斯随机场，其协方差仅通过其欧几里得范数 $h = \\|\\mathbf{h}\\|$ 依赖于分离向量 $\\mathbf{h} = \\mathbf{s}_i - \\mathbf{s}_j$。\n- 平稳性的特征是 $Y(\\mathbf{s})$ 具有恒定的均值 $0$ 和仅依赖于 $h$ 的协方差 $C(h)$。内蕴平稳性假设增量的均值为 $0$，且增量的方差仅依赖于 $h$，这使得变异图有良好定义。\n- 经验变异图通过 Matheron 估计量定义。对于距离的分箱划分，滞后距分箱 $k$ 处的经验半方差为\n$$\n\\hat{\\gamma}(h_k) = \\frac{1}{2 N(h_k)} \\sum_{(i,j) \\in B_k} \\left(Z(\\mathbf{s}_i) - Z(\\mathbf{s}_j)\\right)^2,\n$$\n其中 $B_k$ 索引所有其分离距离落入分箱 $k$ 的点对，$N(h_k)$ 是此类点对的数量。\n- 对 $Y(\\mathbf{s})$ 使用各向同性指数协方差：\n$$\nC(h) = \\sigma^2 \\exp\\left( -\\frac{h}{\\phi} \\right),\n$$\n并在对角线上加入独立的测量噪声（块金效应），其方差为 $\\tau^2$。\n\n工作流要求：\n1. 确定性漂移去除：\n   - 使用普通最小二乘法对 $Z(\\mathbf{s})$ 拟合一个阶数 $p \\in \\{0,1,2\\}$ 的多项式趋势。对于 $p=0$，只使用截距；对于 $p=1$，包括截距、$x$ 和 $y$；对于 $p=2$，包括截距、$x$、$y$、$x^2$、$y^2$ 和 $xy$。这里 $\\mathbf{s}=(x,y)$ 的单位是公里。\n   - 从 $Z(\\mathbf{s})$ 中减去拟合的趋势 $\\hat{m}(\\mathbf{s})$ 以获得残差 $R(\\mathbf{s}) = Z(\\mathbf{s}) - \\hat{m}(\\mathbf{s})$。\n\n2. 经验变异图计算：\n   - 使用 $K$ 个等宽距离分箱（从 $0$ 到最大成对距离）计算 $R(\\mathbf{s})$ 的各向同性经验变异图。使用 $K=12$ 个分箱。距离单位为公里；半方差单位为平方摄氏度。\n   - 为保证数值稳定性，如果任何分箱的 $N(h_k) = 0$，则将其半方差视为未定义，并从下述检查中排除。\n\n3. 残差的内蕴平稳性验证：\n   - 均值稳定性：要求 $R(\\mathbf{s})$ 的绝对均值相对于其标准差要小：\n     $$\n     \\left| \\overline{R} \\right| \\leq \\alpha \\cdot s_R,\n     $$\n     其中 $\\alpha = 0.1$，$s_R$ 是 $R(\\mathbf{s})$ 的标准差。\n   - 变异图单调性：计算满足以下条件的相邻有效变异图分箱 $\\hat{\\gamma}(h_{k+1})$ 和 $\\hat{\\gamma}(h_k)$ 的比例 $M$：\n     $$\n     \\hat{\\gamma}(h_{k+1}) \\geq \\hat{\\gamma}(h_k) - \\epsilon,\n     $$\n     其中 $\\epsilon$ 是一个与估计的基台值成比例的容差（取 $\\epsilon = 0.05 \\cdot \\max_k \\hat{\\gamma}(h_k)$）。要求 $M \\geq 0.8$。\n   - 短滞后距斜率非负性：对前 $L$ 个有效的变异图点（最小滞后距）拟合一个线性模型，其中 $L = 4$ 或在有效分箱数少于4个时取所有有效分箱数，并要求估计的斜率 $\\beta$ 满足\n     $$\n     \\beta \\geq 0.\n     $$\n   - 空间均值一致性：通过 $x$ 和 $y$ 坐标的中位数分割，将区域划分为四个象限。令 $\\overline{R}_q$ 为象限 $q$ 内的平均残差。要求\n     $$\n     \\max_{q,q'} \\left| \\overline{R}_q - \\overline{R}_{q'} \\right| \\leq \\gamma \\cdot s_R,\n     $$\n     其中 $\\gamma = 0.2$。\n\n如果所有四个条件都满足，则宣布残差场是内蕴平稳的；否则，宣布其为非平稳的。\n\n物理单位和数值精度：\n- 坐标 $x$ 和 $y$ 的单位是公里。\n- 温度值的单位是摄氏度。\n- 变异图中的距离单位是公里；半方差单位是平方摄氏度。\n- 每个测试案例的最终输出是布尔值；输出不需要单位转换。\n\n测试套件和参数规范：\n您必须为以下 $4$ 个测试案例实现该工作流。在每个案例中，在指定的点集上生成合成数据，构建漂移，生成平稳高斯分量，添加块金噪声，使用指定的多项式阶数进行去趋势，计算经验变异图，并验证内蕴平稳性。\n\n对于每个测试案例，参数如下：\n- 网格规范：$x$ 和 $y$ 方向上的点数，间距 $s$（公里），或特定的采样配置。\n- 真实漂移阶数 $p_{\\text{true}} \\in \\{0,1,2\\}$ 和系数（单位为摄氏度每相应公里的幂次方）。\n- 用于去趋势的拟合多项式阶数 $p_{\\text{fit}} \\in \\{0,1,2\\}$。\n- 协方差参数 $\\sigma^2$、$\\phi$（公里）和块金方差 $\\tau^2$（平方摄氏度）。\n- 用于可复现性的随机种子。\n\n定义四个测试案例如下：\n- 案例 1（理想情况，线性漂移被正确移除）：\n  - 网格：$16 \\times 16$ 常规网格，间距 $s = 5$ 公里。\n  - 真实漂移：$p_{\\text{true}} = 1$，系数为 $c = 20$，$a_x = 0.02$ 摄氏度/公里，$a_y = -0.01$ 摄氏度/公里。\n  - 拟合：$p_{\\text{fit}} = 1$。\n  - 协方差：$\\sigma^2 = 2.0$，$\\phi = 20$ 公里，$\\tau^2 = 0.25$。\n  - 种子：$42$。\n- 案例 2（二次漂移被正确移除）：\n  - 网格：$15 \\times 15$ 常规网格，间距 $s = 5$ 公里。\n  - 真实漂移：$p_{\\text{true}} = 2$，系数为 $c = 18$，$a_x = 0.01$，$a_y = 0.005$ 摄氏度/公里，$b_{xx} = 0.0002$，$b_{yy} = -0.0001$，$b_{xy} = 0.00015$ 摄氏度/平方公里。\n  - 拟合：$p_{\\text{fit}} = 2$。\n  - 协方差：$\\sigma^2 = 2.5$，$\\phi = 15$ 公里，$\\tau^2 = 0.3$。\n  - 种子：$123$。\n- 案例 3（无漂移，进行了不必要的线性去趋势）：\n  - 网格：$16 \\times 16$ 常规网格，间距 $s = 5$ 公里。\n  - 真实漂移：$p_{\\text{true}} = 0$，系数为 $c = 22$ 摄氏度。\n  - 拟合：$p_{\\text{fit}} = 1$。\n  - 协方差：$\\sigma^2 = 1.5$，$\\phi = 25$ 公里，$\\tau^2 = 0.2$。\n  - 种子：$7$。\n- 案例 4（边缘案例，漂移阶数指定错误导致失败）：\n  - 网格：$14 \\times 14$ 常规网格，间距 $s = 5$ 公里。\n  - 真实漂移：$p_{\\text{true}} = 2$，系数为 $c = 19$，$a_x = 0.015$，$a_y = -0.008$ 摄氏度/公里，$b_{xx} = 0.0010$，$b_{yy} = -0.0008$，$b_{xy} = 0.0006$ 摄氏度/平方公里。\n  - 拟合：$p_{\\text{fit}} = 1$。\n  - 协方差：$\\sigma^2 = 0.3$，$\\phi = 15$ 公里，$\\tau^2 = 0.1$。\n  - 种子：$999$。\n\n数值实现细节：\n- 使用普通最小二乘法进行漂移拟合。\n- 经验变异图使用 $K = 12$ 个各向同性距离分箱。\n- 对于短滞后距斜率计算，使用前 $L = 4$ 个有效分箱。如果有效分箱少于 $4$ 个，则使用所有可用的有效分箱。为纳入斜率拟合，使用每分箱点对数最小阈值为 $30$；点对数少于 $30$ 的分箱应从斜率拟合中排除。\n\n要求的最终输出格式：\n您的程序应生成一行输出，其中包含用方括号括起来的逗号分隔的结果列表（例如，“[result1,result2,result3,result4]”），其中每个结果是一个布尔值，表示相应测试案例是否在上述四个标准下验证为内蕴平稳。布尔值必须按测试案例 1 到 4 的顺序出现。",
            "solution": "该问题要求开发并实现一个地统计工作流，以评估残差空间场的内蕴平稳性。该场是在从类似于遥感陆地表面温度（LST）的合成数据集中移除确定性多项式趋势后获得的。验证基于对残差及其经验变异图执行的一组定量检查。整个过程将对四个不同的测试案例执行，每个案例都有用于数据生成和趋势移除的指定参数。\n\n观测空间场 $Z(\\mathbf{s})$ 在位置 $\\mathbf{s} \\in \\mathbb{R}^2$ 的基础模型由以下分解给出：\n$$\nZ(\\mathbf{s}) = m(\\mathbf{s}) + Y(\\mathbf{s})\n$$\n这里，$m(\\mathbf{s})$ 代表一个确定性的大尺度变异或漂移，而 $Y(\\mathbf{s})$ 是一个零均值、二阶平稳的随机过程，用于模拟空间相关的随机波动。$Y(\\mathbf{s})$ 的平稳性由一个各向同性指数协方差函数来表征：\n$$\nC(h) = \\sigma^2 \\exp\\left( -\\frac{h}{\\phi} \\right)\n$$\n其中 $h = \\|\\mathbf{s}_i - \\mathbf{s}_j\\|$ 是两个位置之间的欧几里得距离，$\\sigma^2$ 是偏基台值（相关分量的方差），$\\phi$ 是有效程长参数。此外，独立的测量噪声，称为块金效应，在零分离距离处贡献了方差 $\\tau^2$。因此，一组点 $\\{\\mathbf{s}_i\\}_{i=1}^N$ 的总协方差由一个矩阵 $K$ 描述，其元素为 $K_{ij} = C(\\|\\mathbf{s}_i - \\mathbf{s}_j\\|)$（对于 $i \\neq j$），对角线元素为 $K_{ii} = \\sigma^2 + \\tau^2$。\n\n该工作流按以下四个阶段进行：\n\n**1. 合成数据生成**\n对于每个测试案例，都会生成一个合成数据集。首先，根据指定的网格配置建立一组空间坐标。然后，使用真实的多项式阶数 $p_{\\text{true}}$ 及其系数，在每个位置计算确定性漂移分量 $m(\\mathbf{s})$。通过从一个多元正态分布 $\\mathcal{N}(\\mathbf{0}, K)$ 中抽取样本，生成平稳随机场 $Y(\\mathbf{s})$ 的一个实现，其中 $K$ 是由给定参数 $\\sigma^2$、$\\phi$ 和 $\\tau^2$ 构建的协方差矩阵。最终的观测场是总和 $Z(\\mathbf{s}) = m(\\mathbf{s}) + Y(\\mathbf{s})$。\n\n**2. 确定性漂移去除**\n使用普通最小二乘法（OLS）将一个指定阶数 $p_{\\text{fit}} \\in \\{0, 1, 2\\}$ 的多项式趋势面 $\\hat{m}(\\mathbf{s})$ 拟合到观测数据 $Z(\\mathbf{s})$。OLS 回归的设计矩阵 $X$ 是根据坐标 $\\mathbf{s}=(x,y)$ 和选择的多项式阶数构建的。例如，对于 $p_{\\text{fit}}=2$，$X$ 的列对应于基函数 $\\{1, x, y, x^2, y^2, xy\\}$。多项式系数的 OLS 估计量 $\\hat{\\beta}$ 通过求解正规方程组找到，通常通过 $\\hat{\\beta} = (X^T X)^{-1}X^T Z$ 计算。拟合的趋势是 $\\hat{m}(\\mathbf{s}) = X\\hat{\\beta}$，残差计算为 $R(\\mathbf{s}) = Z(\\mathbf{s}) - \\hat{m}(\\mathbf{s})$。这些残差代表了需要测试其平稳性的去趋势场。\n\n**3. 经验变异图计算**\n通过使用 Matheron 估计量计算各向同性经验半变异图来分析残差 $R(\\mathbf{s})$ 的空间结构。所有数据点之间的成对距离范围被划分为 $K=12$ 个等宽的分箱。对于每个分箱 $k$，半方差 $\\hat{\\gamma}(h_k)$ 计算如下：\n$$\n\\hat{\\gamma}(h_k) = \\frac{1}{2 N(h_k)} \\sum_{(i,j) \\in B_k} \\left(R(\\mathbf{s}_i) - R(\\mathbf{s}_j)\\right)^2\n$$\n其中 $B_k$ 是所有其分离距离落入分箱 $k$ 的点对集合，$N(h_k)$ 是此类点对的数量。$N(h_k) = 0$ 的分箱被视为无效。\n\n**4. 内蕴平稳性验证**\n只有当残差场 $R(\\mathbf{s})$ 满足四个不同的标准时，才被宣布为内蕴平稳：\n\n*   **均值稳定性：** 残差的绝对均值 $|\\overline{R}|$ 必须相对于其标准差 $s_R$ 较小。形式化检查为 $|\\overline{R}| \\leq \\alpha \\cdot s_R$，容差因子 $\\alpha = 0.1$。这确保了去趋势过程成功地产生了一个均值近似为零的场。\n\n*   **变异图单调性：** 理论变异图必须是滞后距离 $h$ 的单调非递减函数。我们在经验变异图上测试此属性。满足 $\\hat{\\gamma}(h_{k+1}) \\geq \\hat{\\gamma}(h_k) - \\epsilon$ 的相邻有效分箱 $(\\hat{\\gamma}(h_k), \\hat{\\gamma}(h_{k+1}))$ 的比例 $M$ 必须至少为 $0.8$。容差 $\\epsilon = 0.05 \\cdot \\max_k \\hat{\\gamma}(h_k)$ 允许微小的随机波动。若此项检查失败，则表明存在显著的残留趋势。\n\n*   **短滞后距斜率非负性：** 变异图在原点附近的行为至关重要。我们对前 $L=4$ 个有效变异图点（或在可用点数较少时取所有点）进行线性模型拟合，这些点必须具有足够数量的点对（$N(h_k) \\ge 30$）。这条线的估计斜率 $\\beta$ 必须为非负（$\\beta \\geq 0$）。在原点附近的负斜率与标准空间相关模型不一致。\n\n*   **空间均值一致性：** 为了检测大尺度的残留趋势，使用坐标的中位数分割将区域划分为四个象限。计算每个象限内的残差均值 $\\overline{R}_q$。任意两个象限均值之间的最大绝对差必须小于总体残差标准差的一定比例：$\\max_{q,q'} |\\overline{R}_q - \\overline{R}_{q'}| \\leq \\gamma \\cdot s_R$，其中 $\\gamma = 0.2$。\n\n只有当所有这四个条件都满足时，一个测试案例才被视为通过，表明残差可接受地是平稳的。该实现将系统地将这整个工作流应用于四个指定的测试案例中的每一个。",
            "answer": "```python\nimport numpy as np\n\ndef run_case(grid_spec, p_true, drift_coeffs, p_fit, cov_params, seed):\n    \"\"\"\n    Executes the entire workflow for a single test case.\n    \"\"\"\n    # 1. Generate spatial coordinates\n    rng = np.random.default_rng(seed)\n    nx, ny, s = grid_spec\n    x = np.arange(nx) * s\n    y = np.arange(ny) * s\n    xx, yy = np.meshgrid(x, y)\n    coords = np.vstack([xx.ravel(), yy.ravel()]).T\n    n_points = nx * ny\n    x_coords, y_coords = coords[:, 0], coords[:, 1]\n\n    # 2. Generate true deterministic drift m(s)\n    if p_true == 0:\n        m_true = np.full(n_points, drift_coeffs['c'])\n    elif p_true == 1:\n        m_true = (drift_coeffs['c'] + \n                  drift_coeffs['ax'] * x_coords + \n                  drift_coeffs['ay'] * y_coords)\n    elif p_true == 2:\n        m_true = (drift_coeffs['c'] + \n                  drift_coeffs['ax'] * x_coords + \n                  drift_coeffs['ay'] * y_coords +\n                  drift_coeffs['bxx'] * x_coords**2 + \n                  drift_coeffs['byy'] * y_coords**2 + \n                  drift_coeffs['bxy'] * x_coords * y_coords)\n\n    # 3. Generate stationary random component Y(s)\n    sigma2 = cov_params['sigma2']\n    phi = cov_params['phi']\n    tau2 = cov_params['tau2']\n    \n    dist_matrix = np.sqrt(((coords[:, np.newaxis, :] - coords[np.newaxis, :, :])**2).sum(axis=-1))\n    \n    cov_matrix = sigma2 * np.exp(-dist_matrix / phi)\n    np.fill_diagonal(cov_matrix, sigma2 + tau2)\n    \n    Y = rng.multivariate_normal(np.zeros(n_points), cov_matrix, method='eigh')\n\n    # 4. Form observed field Z(s)\n    Z = m_true + Y\n\n    # 5. Detrending using Ordinary Least Squares (OLS)\n    if p_fit == 0:\n        X = np.ones((n_points, 1))\n    elif p_fit == 1:\n        X = np.vstack([np.ones(n_points), x_coords, y_coords]).T\n    elif p_fit == 2:\n        X = np.vstack([np.ones(n_points), x_coords, y_coords, \n                       x_coords**2, y_coords**2, x_coords * y_coords]).T\n    \n    beta_hat = np.linalg.lstsq(X, Z, rcond=None)[0]\n    m_hat = X @ beta_hat\n    R = Z - m_hat\n\n    # 6. Empirical variogram computation\n    indices_upper = np.triu_indices(n_points, k=1)\n    dist_upper = dist_matrix[indices_upper]\n    \n    sq_diff_matrix = (R[:, np.newaxis] - R[np.newaxis, :])**2\n    sq_diff_upper = sq_diff_matrix[indices_upper]\n\n    K = 12\n    max_dist = dist_upper.max() if len(dist_upper) > 0 else 1.0\n    \n    counts, bin_edges = np.histogram(dist_upper, bins=K, range=(0, max_dist))\n    sum_sq_diff, _ = np.histogram(dist_upper, bins=K, range=(0, max_dist), weights=sq_diff_upper)\n\n    gamma_vals = np.full(K, np.nan)\n    valid_mask = counts > 0\n    gamma_vals[valid_mask] = sum_sq_diff[valid_mask] / (2 * counts[valid_mask])\n    \n    h_bins = (bin_edges[:-1] + bin_edges[1:]) / 2\n\n    # 7. Intrinsic stationarity validation\n    R_std = np.std(R)\n\n    # Check 1: Mean stability\n    check1 = (np.abs(np.mean(R)) = 0.1 * R_std) if R_std > 1e-9 else (np.abs(np.mean(R))  1e-9)\n\n    # Check 2: Variogram monotonicity\n    valid_gamma_indices = np.where(np.isfinite(gamma_vals))[0]\n    check2 = True\n    if len(valid_gamma_indices) > 1:\n        gamma_subset = gamma_vals[valid_gamma_indices]\n        epsilon = 0.05 * np.nanmax(gamma_vals)\n        monotonic_pairs = 0\n        total_pairs = len(gamma_subset) - 1\n        for i in range(total_pairs):\n            if gamma_subset[i+1] >= gamma_subset[i] - epsilon:\n                monotonic_pairs += 1\n        \n        check2 = (monotonic_pairs / total_pairs) >= 0.8\n    \n    # Check 3: Short-lag slope non-negativity\n    slope_valid_mask = (counts >= 30)  np.isfinite(gamma_vals)\n    slope_indices = np.where(slope_valid_mask)[0]\n    check3 = True\n    if len(slope_indices) > 0:\n        first_L_indices = slope_indices[:4]\n        if len(first_L_indices) >= 2:\n            h_slope = h_bins[first_L_indices]\n            gamma_slope = gamma_vals[first_L_indices]\n            \n            X_slope = np.vstack([h_slope, np.ones(len(h_slope))]).T\n            slope, _ = np.linalg.lstsq(X_slope, gamma_slope, rcond=None)[0]\n            check3 = slope >= 0\n\n    # Check 4: Spatial mean consistency\n    median_x = np.median(x_coords)\n    median_y = np.median(y_coords)\n    \n    q1_mask = (x_coords = median_x)  (y_coords = median_y)\n    q2_mask = (x_coords > median_x)  (y_coords = median_y)\n    q3_mask = (x_coords = median_x)  (y_coords > median_y)\n    q4_mask = (x_coords > median_x)  (y_coords > median_y)\n    \n    q_means = []\n    masks = [q1_mask, q2_mask, q3_mask, q4_mask]\n    for mask in masks:\n        if np.any(mask):\n            q_means.append(np.mean(R[mask]))\n    \n    check4 = True\n    if len(q_means) > 1 and R_std > 1e-9:\n        max_diff = np.max(q_means) - np.min(q_means)\n        check4 = max_diff = 0.2 * R_std\n\n    return all([check1, check2, check3, check4])\n\n\ndef solve():\n    \"\"\"\n    Defines test cases and runs the validation workflow for each.\n    \"\"\"\n    test_cases = [\n        # Case 1: Happy path, linear drift correctly removed\n        {'grid_spec': (16, 16, 5), 'p_true': 1, \n         'drift_coeffs': {'c': 20, 'ax': 0.02, 'ay': -0.01}, 'p_fit': 1, \n         'cov_params': {'sigma2': 2.0, 'phi': 20, 'tau2': 0.25}, 'seed': 42},\n        \n        # Case 2: Quadratic drift correctly removed\n        {'grid_spec': (15, 15, 5), 'p_true': 2, \n         'drift_coeffs': {'c': 18, 'ax': 0.01, 'ay': 0.005, 'bxx': 0.0002, 'byy': -0.0001, 'bxy': 0.00015}, 'p_fit': 2, \n         'cov_params': {'sigma2': 2.5, 'phi': 15, 'tau2': 0.3}, 'seed': 123},\n        \n        # Case 3: No drift, unnecessary linear detrend\n        {'grid_spec': (16, 16, 5), 'p_true': 0, \n         'drift_coeffs': {'c': 22}, 'p_fit': 1, \n         'cov_params': {'sigma2': 1.5, 'phi': 25, 'tau2': 0.2}, 'seed': 7},\n        \n        # Case 4: Mis-specified drift order causing failure\n        {'grid_spec': (14, 14, 5), 'p_true': 2, \n         'drift_coeffs': {'c': 19, 'ax': 0.015, 'ay': -0.008, 'bxx': 0.0010, 'byy': -0.0008, 'bxy': 0.0006}, 'p_fit': 1,\n         'cov_params': {'sigma2': 0.3, 'phi': 15, 'tau2': 0.1}, 'seed': 999},\n    ]\n\n    results = []\n    for params in test_cases:\n        result = run_case(**params)\n        results.append(result)\n\n    # Format the final output as a string list of booleans\n    print(f\"[{','.join(str(r).lower() for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}