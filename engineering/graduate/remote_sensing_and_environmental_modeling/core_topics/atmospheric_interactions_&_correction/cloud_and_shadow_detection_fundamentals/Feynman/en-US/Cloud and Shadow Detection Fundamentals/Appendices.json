{
    "hands_on_practices": [
        {
            "introduction": "Understanding shadow detection begins with the fundamental physics of illumination. A shadowed area is not devoid of light; it is primarily illuminated by diffuse skylight, which is enriched in blue wavelengths due to Rayleigh scattering. This practice challenges you to build a quantitative model from first principles, using the distinct spectral ratio of skylight versus direct sunlight to compute a shadow-likelihood score for a vegetated pixel . This exercise solidifies the connection between atmospheric physics and practical remote sensing algorithms.",
            "id": "3801373",
            "problem": "A multispectral satellite pixel over a homogeneous vegetated canopy has been atmospherically corrected to surface reflectance, yielding measured blue-channel reflectance $\\rho_{\\mathrm{blue}} = 0.12$ and red-channel reflectance $\\rho_{\\mathrm{red}} = 0.06$. The pixel lies within a spatial context suspected to be in cast shadow, and the goal is to quantify a shadow-likelihood score from first principles using the blue-to-red reflectance ratio.\n\nAssume the following physical model and conditions:\n- The canopy behaves approximately as a Lambertian surface, so the top-of-canopy radiance $L_{\\lambda}$ relates to surface reflectance $\\rho_{\\lambda}$ and band-averaged downwelling irradiance $E_{\\lambda}$ via $L_{\\lambda} \\propto \\rho_{\\lambda} E_{\\lambda}$, with proportionality constants cancelling in channel ratios under equal geometry.\n- The measured reflectance ratio $r \\equiv \\rho_{\\mathrm{blue}} / \\rho_{\\mathrm{red}}$ is controlled by the product of the canopy’s intrinsic spectral reflectance ratio and the illumination’s spectral ratio, i.e., $r \\approx \\left(\\rho_{\\mathrm{blue}}^{\\mathrm{intr}} / \\rho_{\\mathrm{red}}^{\\mathrm{intr}}\\right)\\left(E_{\\mathrm{blue}} / E_{\\mathrm{red}}\\right)$, under negligible adjacency effects and equal bidirectional geometry.\n- For typical green vegetation in the visible bands, take the intrinsic reflectance ratio $\\gamma \\equiv \\rho_{\\mathrm{blue}}^{\\mathrm{intr}} / \\rho_{\\mathrm{red}}^{\\mathrm{intr}} = 1.3$, reflecting the similar chlorophyll absorption in blue and red with slightly higher blue reflectance.\n- Under direct-sun dominated illumination, use a representative band-averaged irradiance spectral ratio $\\alpha_{\\mathrm{sun}} \\equiv E_{\\mathrm{blue}} / E_{\\mathrm{red}} = 0.95$, consistent with a redder solar spectrum at the surface due to atmospheric scattering and absorption.\n- Under skylight-dominated shadow illumination on a clear-sky day, use $\\alpha_{\\mathrm{shad}} \\equiv E_{\\mathrm{blue}} / E_{\\mathrm{red}} = 1.8$, reflecting the blue-enriched diffuse sky.\n\nUsing these physically motivated quantities, define the expected blue-to-red reflectance ratios for sunlit vegetation as $r_{\\mathrm{sun}} \\equiv \\gamma \\alpha_{\\mathrm{sun}}$ and for shadowed vegetation as $r_{\\mathrm{shad}} \\equiv \\gamma \\alpha_{\\mathrm{shad}}$. Construct a shadow-likelihood score $S(r)$ that assigns $S=0$ to $r=r_{\\mathrm{sun}}$ and $S=1$ to $r=r_{\\mathrm{shad}}$, assuming a linear mapping in $r$ consistent with the above Lambertian and spectral-mixture assumptions. Then, for the given measurements, compute the score $S$ using the measured ratio $r = \\rho_{\\mathrm{blue}} / \\rho_{\\mathrm{red}}$.\n\nReport the final score as a dimensionless decimal rounded to four significant figures.",
            "solution": "The problem statement has been validated and is deemed sound. It is scientifically grounded in the principles of radiative transfer and remote sensing, well-posed with all necessary information provided, and objective in its formulation. We will proceed with the solution.\n\nThe objective is to compute a shadow-likelihood score, $S$, for a vegetated pixel based on its measured blue and red channel surface reflectances. The score is to be derived from a linear model defined by theoretical sunlit and shadowed conditions.\n\nFirst, we calculate the measured blue-to-red reflectance ratio, $r$, from the given data:\nMeasured blue-channel reflectance, $\\rho_{\\mathrm{blue}} = 0.12$.\nMeasured red-channel reflectance, $\\rho_{\\mathrm{red}} = 0.06$.\n\nThe measured ratio $r$ is defined as:\n$$r = \\frac{\\rho_{\\mathrm{blue}}}{\\rho_{\\mathrm{red}}}$$\nSubstituting the given values:\n$$r = \\frac{0.12}{0.06} = 2.0$$\n\nNext, we calculate the theoretical reference ratios for a fully sunlit pixel, $r_{\\mathrm{sun}}$, and a fully shadowed pixel, $r_{\\mathrm{shad}}$. These are based on the provided physical models.\nThe expected ratio for sunlit vegetation is given by $r_{\\mathrm{sun}} = \\gamma \\alpha_{\\mathrm{sun}}$, where $\\gamma$ is the intrinsic reflectance ratio of the vegetation and $\\alpha_{\\mathrm{sun}}$ is the irradiance spectral ratio under direct sun.\nWe are given:\nIntrinsic reflectance ratio, $\\gamma = 1.3$.\nSunlit irradiance ratio, $\\alpha_{\\mathrm{sun}} = 0.95$.\nThus, the sunlit reference ratio is:\n$$r_{\\mathrm{sun}} = 1.3 \\times 0.95 = 1.235$$\n\nThe expected ratio for shadowed vegetation is given by $r_{\\mathrm{shad}} = \\gamma \\alpha_{\\mathrm{shad}}$, where $\\alpha_{\\mathrm{shad}}$ is the irradiance spectral ratio under skylight-dominated shadow.\nWe are given:\nShadowed irradiance ratio, $\\alpha_{\\mathrm{shad}} = 1.8$.\nThus, the shadowed reference ratio is:\n$$r_{\\mathrm{shad}} = 1.3 \\times 1.8 = 2.34$$\n\nThe shadow-likelihood score, $S(r)$, is defined as a linear function of $r$ that maps the sunlit condition to a score of $0$ and the shadowed condition to a score of $1$. That is, $S(r_{\\mathrm{sun}}) = 0$ and $S(r_{\\mathrm{shad}}) = 1$.\nLet the linear function be $S(r) = m \\cdot r + c$. We can determine the slope $m$ and intercept $c$ using the two conditions.\nThe slope $m$ is:\n$$m = \\frac{S(r_{\\mathrm{shad}}) - S(r_{\\mathrm{sun}})}{r_{\\mathrm{shad}} - r_{\\mathrm{sun}}} = \\frac{1 - 0}{r_{\\mathrm{shad}} - r_{\\mathrm{sun}}} = \\frac{1}{r_{\\mathrm{shad}} - r_{\\mathrm{sun}}}$$\nUsing the point-slope form with the point $(r_{\\mathrm{sun}}, 0)$:\n$$S(r) - S(r_{\\mathrm{sun}}) = m (r - r_{\\mathrm{sun}})$$\n$$S(r) - 0 = \\left(\\frac{1}{r_{\\mathrm{shad}} - r_{\\mathrm{sun}}}\\right) (r - r_{\\mathrm{sun}})$$\nThis gives the general formula for the score:\n$$S(r) = \\frac{r - r_{\\mathrm{sun}}}{r_{\\mathrm{shad}} - r_{\\mathrm{sun}}}$$\nThis equation represents a linear normalization of the measured ratio $r$ to the range $[0, 1]$ defined by the reference ratios $r_{\\mathrm{sun}}$ and $r_{\\mathrm{shad}}$.\n\nFinally, we substitute the calculated values of $r$, $r_{\\mathrm{sun}}$, and $r_{\\mathrm{shad}}$ into this expression to compute the score for the given pixel.\n$$S = \\frac{2.0 - 1.235}{2.34 - 1.235}$$\n$$S = \\frac{0.765}{1.105}$$\n$$S \\approx 0.6923076923...$$\n\nThe problem requires the result to be rounded to four significant figures.\n$$S \\approx 0.6923$$\nThis score indicates that the pixel's spectral signature is significantly closer to the pure shadow case ($S=1$) than the pure sunlit case ($S=0$), which is consistent with the initial suspicion that it lies in a cast shadow.",
            "answer": "$$\\boxed{0.6923}$$"
        },
        {
            "introduction": "Satellite sensor pixels rarely contain a single, pure surface type, a challenge known as the mixed pixel problem. This practice addresses this by applying a linear mixing model to estimate the fraction of a pixel covered by cloud, a critical step for data quality assessment. You will then go a step further by performing an uncertainty analysis, propagating the variability in cloud optical thickness, $\\tau$, to the final cloud fraction estimate, $f$, a core skill in quantitative remote sensing .",
            "id": "3801428",
            "problem": "A nadir-viewing multispectral satellite observes a partly cloudy pixel in a visible band where anisotropy is weak enough to treat both the cloud field and the clear surface-atmosphere system as Lambertian. Let the Top-of-Atmosphere (TOA) reflectance, defined as $\\rho_{\\mathrm{TOA}} = \\pi L / (E_{0} \\cos \\theta_{0})$, be measured as $\\rho_{\\mathrm{TOA}} = 0.4$, where $L$ is radiance at the sensor, $E_{0}$ is extraterrestrial irradiance, and $\\theta_{0}$ is solar zenith angle. The scene is modeled as a subpixel mixture of a cloudy portion with reflectance $\\rho_{\\mathrm{cloud}}$ and a clear-sky portion with reflectance $\\rho_{\\mathrm{clear}}$, with cloud fraction $f$ and clear fraction $1-f$. The clear-sky TOA reflectance is independently characterized as $\\rho_{\\mathrm{clear}} = 0.1$, and the cloudy portion’s TOA reflectance under the present conditions is $\\rho_{\\mathrm{cloud}} = 0.8$. Using the physically standard assumption that radiances add linearly over area for independent components and that the mapping to reflectance is linear under fixed illumination, determine the subpixel cloud fraction $f$.\n\nNext, assess the uncertainty in $f$ arising from variability in cloud optical thickness $\\tau$ under a physically motivated parameterization of cloudy reflectance. Assume the cloudy reflectance is governed by a semi-infinite approach parameterization,\n$$\n\\rho_{\\mathrm{cloud}}(\\tau) = \\rho_{\\infty}\\left(1 - \\exp(-\\beta \\tau)\\right),\n$$\nwith $\\rho_{\\infty} = 0.9$ and $\\beta = 0.6$. Let $\\tau_{0}$ be the optical thickness at which $\\rho_{\\mathrm{cloud}}(\\tau_{0}) = 0.8$, and suppose the retrieved optical thickness has a standard uncertainty $\\sigma_{\\tau} = 0.2$. Using first-order (linear) uncertainty propagation with all other quantities treated as fixed, compute the standard uncertainty $\\sigma_{f}$ in the cloud fraction $f$.\n\nExpress both $f$ and $\\sigma_{f}$ as dimensionless numbers and round both to four significant figures. The final answer must contain both values together.",
            "solution": "The problem statement has been critically evaluated and is determined to be valid. It is scientifically grounded in the principles of radiative transfer and remote sensing, well-posed with sufficient information for a unique solution, and formulated using objective and precise terminology. All provided numerical values are physically realistic. The problem is a standard application of linear mixture modeling and uncertainty analysis. Therefore, a solution will be formulated.\n\nThe problem is addressed in two parts: first, the determination of the subpixel cloud fraction $f$, and second, the estimation of the uncertainty in this fraction, $\\sigma_f$.\n\nPart 1: Calculation of the subpixel cloud fraction $f$.\n\nThe core physical model provided is the linear mixing model for the Top-of-Atmosphere (TOA) reflectance, $\\rho_{\\mathrm{TOA}}$. This model assumes that the total reflectance measured from a pixel is the area-weighted average of the reflectances of its constituent components. In this case, the components are a cloudy portion with fraction $f$ and reflectance $\\rho_{\\mathrm{cloud}}$, and a clear-sky portion with fraction $1-f$ and reflectance $\\rho_{\\mathrm{clear}}$. The assumption that radiances add linearly and that the mapping to reflectance is linear under fixed illumination leads to the following equation:\n$$\n\\rho_{\\mathrm{TOA}} = f \\rho_{\\mathrm{cloud}} + (1-f) \\rho_{\\mathrm{clear}}\n$$\nOur goal is to solve for the cloud fraction, $f$. We rearrange the equation algebraically:\n$$\n\\rho_{\\mathrm{TOA}} = f \\rho_{\\mathrm{cloud}} + \\rho_{\\mathrm{clear}} - f \\rho_{\\mathrm{clear}}\n$$\n$$\n\\rho_{\\mathrm{TOA}} - \\rho_{\\mathrm{clear}} = f (\\rho_{\\mathrm{cloud}} - \\rho_{\\mathrm{clear}})\n$$\nIsolating $f$ yields the expression for the cloud fraction in terms of the component reflectances:\n$$\nf = \\frac{\\rho_{\\mathrm{TOA}} - \\rho_{\\mathrm{clear}}}{\\rho_{\\mathrm{cloud}} - \\rho_{\\mathrm{clear}}}\n$$\nThe problem provides the following values for this part: $\\rho_{\\mathrm{TOA}} = 0.4$, $\\rho_{\\mathrm{clear}} = 0.1$, and $\\rho_{\\mathrm{cloud}} = 0.8$. Substituting these values into the expression for $f$:\n$$\nf = \\frac{0.4 - 0.1}{0.8 - 0.1} = \\frac{0.3}{0.7} = \\frac{3}{7}\n$$\nAs a decimal, this is $f \\approx 0.4285714$. Rounding to four significant figures as required, we get:\n$$\nf = 0.4286\n$$\n\nPart 2: Calculation of the uncertainty in the cloud fraction, $\\sigma_f$.\n\nThe uncertainty in $f$ arises from the uncertainty in the cloud optical thickness, $\\tau$. The problem specifies that the cloudy reflectance, $\\rho_{\\mathrm{cloud}}$, is a function of $\\tau$ given by the parameterization:\n$$\n\\rho_{\\mathrm{cloud}}(\\tau) = \\rho_{\\infty}\\left(1 - \\exp(-\\beta \\tau)\\right)\n$$\nwith constants $\\rho_{\\infty} = 0.9$ and $\\beta = 0.6$.\n\nThe cloud fraction $f$ is therefore also a function of $\\tau$:\n$$\nf(\\tau) = \\frac{\\rho_{\\mathrm{TOA}} - \\rho_{\\mathrm{clear}}}{\\rho_{\\mathrm{cloud}}(\\tau) - \\rho_{\\mathrm{clear}}}\n$$\nWe are asked to use first-order uncertainty propagation. For a function $f(\\tau)$, the standard uncertainty $\\sigma_f$ related to the standard uncertainty $\\sigma_\\tau$ is given by:\n$$\n\\sigma_f = \\left| \\frac{df}{d\\tau} \\right| \\sigma_\\tau\n$$\nThis derivative must be evaluated at the operating point, which is specified by $\\rho_{\\mathrm{cloud}}(\\tau_0) = 0.8$.\n\nFirst, we must compute the derivative $\\frac{df}{d\\tau}$. Using the chain rule:\n$$\n\\frac{df}{d\\tau} = \\frac{d}{d\\tau} \\left[ (\\rho_{\\mathrm{TOA}} - \\rho_{\\mathrm{clear}}) \\left( \\rho_{\\mathrm{cloud}}(\\tau) - \\rho_{\\mathrm{clear}} \\right)^{-1} \\right]\n$$\n$$\n\\frac{df}{d\\tau} = -(\\rho_{\\mathrm{TOA}} - \\rho_{\\mathrm{clear}}) \\left( \\rho_{\\mathrm{cloud}}(\\tau) - \\rho_{\\mathrm{clear}} \\right)^{-2} \\frac{d\\rho_{\\mathrm{cloud}}}{d\\tau}\n$$\nNext, we compute the derivative of $\\rho_{\\mathrm{cloud}}(\\tau)$:\n$$\n\\frac{d\\rho_{\\mathrm{cloud}}}{d\\tau} = \\frac{d}{d\\tau} \\left[ \\rho_{\\infty}\\left(1 - \\exp(-\\beta \\tau)\\right) \\right] = \\rho_{\\infty} \\left( - \\exp(-\\beta \\tau) \\cdot (-\\beta) \\right) = \\rho_{\\infty} \\beta \\exp(-\\beta \\tau)\n$$\nWe need to evaluate this derivative at $\\tau_0$, where $\\rho_{\\mathrm{cloud}}(\\tau_0) = 0.8$. We can express $\\exp(-\\beta \\tau_0)$ in terms of known quantities. From the cloud reflectance model:\n$$\n\\rho_{\\mathrm{cloud}}(\\tau_0) = \\rho_{\\infty}\\left(1 - \\exp(-\\beta \\tau_0)\\right)\n$$\n$$\n\\frac{\\rho_{\\mathrm{cloud}}(\\tau_0)}{\\rho_{\\infty}} = 1 - \\exp(-\\beta \\tau_0)\n$$\n$$\n\\exp(-\\beta \\tau_0) = 1 - \\frac{\\rho_{\\mathrm{cloud}}(\\tau_0)}{\\rho_{\\infty}}\n$$\nSubstituting this back into the expression for $\\frac{d\\rho_{\\mathrm{cloud}}}{d\\tau}$ at $\\tau_0$:\n$$\n\\left. \\frac{d\\rho_{\\mathrm{cloud}}}{d\\tau} \\right|_{\\tau=\\tau_0} = \\rho_{\\infty} \\beta \\left( 1 - \\frac{\\rho_{\\mathrm{cloud}}(\\tau_0)}{\\rho_{\\infty}} \\right) = \\beta (\\rho_{\\infty} - \\rho_{\\mathrm{cloud}}(\\tau_0))\n$$\nNow, we can assemble the full expression for $\\frac{df}{d\\tau}$ evaluated at $\\tau_0$:\n$$\n\\left. \\frac{df}{d\\tau} \\right|_{\\tau=\\tau_0} = - \\frac{\\rho_{\\mathrm{TOA}} - \\rho_{\\mathrm{clear}}}{(\\rho_{\\mathrm{cloud}}(\\tau_0) - \\rho_{\\mathrm{clear}})^2} \\cdot \\beta (\\rho_{\\infty} - \\rho_{\\mathrm{cloud}}(\\tau_0))\n$$\nWe substitute the given numerical values: $\\rho_{\\mathrm{TOA}} = 0.4$, $\\rho_{\\mathrm{clear}} = 0.1$, $\\rho_{\\mathrm{cloud}}(\\tau_0) = 0.8$, $\\rho_{\\infty} = 0.9$, and $\\beta = 0.6$:\n$$\n\\left. \\frac{df}{d\\tau} \\right|_{\\tau=\\tau_0} = - \\frac{0.4 - 0.1}{(0.8 - 0.1)^2} \\cdot 0.6 \\cdot (0.9 - 0.8)\n$$\n$$\n\\left. \\frac{df}{d\\tau} \\right|_{\\tau=\\tau_0} = - \\frac{0.3}{(0.7)^2} \\cdot 0.6 \\cdot (0.1) = - \\frac{0.3}{0.49} \\cdot 0.06 = - \\frac{0.018}{0.49}\n$$\nThis evaluates to approximately $-0.03673469$. The negative sign indicates, as expected, that for a fixed mixed-pixel reflectance $\\rho_{\\mathrm{TOA}}$, a higher cloud reflectance (from a higher $\\tau$) implies a smaller required cloud fraction $f$.\n\nFinally, we calculate the uncertainty $\\sigma_f$ using the provided standard uncertainty in optical thickness, $\\sigma_\\tau = 0.2$:\n$$\n\\sigma_f = \\left| \\left. \\frac{df}{d\\tau} \\right|_{\\tau=\\tau_0} \\right| \\sigma_\\tau = \\left| - \\frac{0.018}{0.49} \\right| \\cdot 0.2 \\approx 0.03673469 \\cdot 0.2 \\approx 0.007346938\n$$\nRounding to four significant figures, we get:\n$$\n\\sigma_f = 0.007347\n$$\nThe final results for the cloud fraction and its standard uncertainty are $f=0.4286$ and $\\sigma_f=0.007347$.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n0.4286 & 0.007347\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "While spectral information is powerful, the spatial context within an image provides crucial evidence for cloud detection. Clouds often exhibit a distinct spatial texture that distinguishes them from smooth surfaces like water or uniform land cover. In this exercise, you will implement an algorithm that leverages local spatial variance as a texture feature to identify clouds, and then use morphological closing to refine and stabilize the initial detections into a coherent mask .",
            "id": "3801425",
            "problem": "Consider a multispectral visible-band scene represented by three two-dimensional arrays of reflectance, one for each of the blue, green, and red bands. Reflectance is defined as the ratio of upwelling radiance to downwelling irradiance and is dimensionless. For Top-Of-Atmosphere (TOA) reflectance, the usual radiometric conversion is from spectral radiance to reflectance via the solar irradiance and solar zenith angle, but in this exercise the inputs are already TOA reflectance values. Visible (VIS) bands are the portion of the spectrum that includes blue, green, and red wavelengths. Clouds in visible imagery typically exhibit high reflectance and spatial texture due to microphysical heterogeneity and shadowing by cloud elements, which can be captured by local spatial statistics such as variance. Morphological closing is a standard operation in mathematical morphology that stabilizes fragmented detections by performing a dilation followed by an erosion with a chosen structuring element.\n\nStarting from the following fundamental bases:\n- Spatial statistics for images: for a scalar field $I(x,y)$, the local mean over a finite neighborhood $K$ of size $w \\times w$ centered at $(x,y)$ is $$\\mu(x,y) = \\frac{1}{|K|} \\sum_{(i,j)\\in K} I(x+i,y+j),$$ and the local second moment is $$m_2(x,y) = \\frac{1}{|K|} \\sum_{(i,j)\\in K} I(x+i,y+j)^2.$$ The local variance is $$\\sigma^2(x,y) = m_2(x,y) - \\mu(x,y)^2.$$\n- Mathematical morphology: for a binary image $D(x,y)\\in\\{0,1\\}$ and a binary structuring element $S$, dilation expands $D$ by $S$ and erosion shrinks $D$ by $S$; closing is defined as $$\\text{close}(D,S) = \\text{erode}(\\text{dilate}(D,S),S).$$\n\nYour task is to derive a neighborhood-based cloud score using local variance in the visible bands and to stabilize fragmented detections with morphological closing, then implement the resulting method and apply it to the provided test suite.\n\nDerive, from the above bases and without assuming any shortcut formulas, a scalar cloud score $s(x,y)$ for each pixel that aggregates local variance from the blue, green, and red reflectance bands. The derivation should use a square neighborhood of width $w$, compute the local variance in each band, aggregate them into a single scalar, and normalize the result into the range $[0,1]$ using a fixed scale $T>0$. Define a binary detection map $d(x,y)$ by thresholding $s(x,y)$ at a fixed level $\\tau \\in (0,1)$, and then obtain a stabilized detection $\\hat{d}(x,y)$ by applying morphological closing with a $3 \\times 3$ square structuring element.\n\nImplementation requirements for your program:\n- Use a square neighborhood width $w = 3$ pixels for local statistics and handle edges by symmetric reflection.\n- Aggregate the bandwise local variances by their arithmetic mean to form a single scalar field before normalization.\n- Normalize the aggregated local variance using a fixed positive scale $T = 0.005$ to obtain a dimensionless score $s(x,y)$ clipped to $[0,1]$.\n- Use a detection threshold $\\tau = 0.6$ to form $d(x,y)$.\n- Apply morphological closing with a $3 \\times 3$ square structuring element to obtain $\\hat{d}(x,y)$.\n\nTest suite:\nYou are given four synthetic multispectral scenes, each represented by three $6 \\times 6$ arrays corresponding to blue, green, and red TOA reflectances. All reflectances are dimensionless.\n\n- Test case $1$ (mixture with textured cloud core):\n  - Blue band $R^{(B)}$: base value $0.15$ everywhere except the central $3 \\times 3$ block, where values are\n    $$\\begin{bmatrix}\n    0.45 & 0.50 & 0.47 \\\\\n    0.48 & 0.55 & 0.49 \\\\\n    0.46 & 0.52 & 0.48\n    \\end{bmatrix}.$$\n  - Green band $R^{(G)}$: base value $0.18$ except the central $3 \\times 3$ block,\n    $$\\begin{bmatrix}\n    0.52 & 0.58 & 0.54 \\\\\n    0.55 & 0.62 & 0.56 \\\\\n    0.53 & 0.59 & 0.55\n    \\end{bmatrix}.$$\n  - Red band $R^{(R)}$: base value $0.14$ except the central $3 \\times 3$ block,\n    $$\\begin{bmatrix}\n    0.43 & 0.48 & 0.45 \\\\\n    0.46 & 0.51 & 0.47 \\\\\n    0.44 & 0.49 & 0.46\n    \\end{bmatrix}.$$\n\n- Test case $2$ (uniform clear sky):\n  - Blue, green, red bands are all constant at $0.12$ across the $6 \\times 6$ grid.\n\n- Test case $3$ (uniform bright surface such as snow, but spatially homogeneous):\n  - Blue, green, red bands are all constant at $0.65$ across the $6 \\times 6$ grid.\n\n- Test case $4$ (fragmented bright patches near the edge with a small hole):\n  - Blue band $R^{(B)}$: base $0.20$ everywhere except a $3 \\times 3$ block in the upper-left corner (rows $0$–$2$, columns $0$–$2$) set to\n    $$\\begin{bmatrix}\n    0.50 & 0.52 & 0.51 \\\\\n    0.53 & 0.20 & 0.54 \\\\\n    0.51 & 0.55 & 0.52\n    \\end{bmatrix},$$\n    where the center element $0.20$ creates a hole.\n  - Green band $R^{(G)}$: base $0.22$ with the same $3 \\times 3$ block set to\n    $$\\begin{bmatrix}\n    0.56 & 0.57 & 0.55 \\\\\n    0.58 & 0.22 & 0.59 \\\\\n    0.56 & 0.60 & 0.57\n    \\end{bmatrix}.$$\n  - Red band $R^{(R)}$: base $0.19$ with the same $3 \\times 3$ block set to\n    $$\\begin{bmatrix}\n    0.48 & 0.50 & 0.49 \\\\\n    0.51 & 0.19 & 0.52 \\\\\n    0.49 & 0.53 & 0.50\n    \\end{bmatrix}.$$\n\nFor each test case, compute:\n- The total number of cloud pixels (integer) in the stabilized detection $\\hat{d}(x,y)$.\n- The mean cloud score (float) over the pixels where $\\hat{d}(x,y) = 1$, expressed as a dimensionless decimal rounded to $5$ decimal places; if there are no cloud pixels, define the mean cloud score as $0$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each test case contributes a two-element list of the form $[\\text{count}, \\text{mean}]$. For example, the output should look like $[[c_1,m_1],[c_2,m_2],[c_3,m_3],[c_4,m_4]]$ with $c_i$ integers and $m_i$ decimals rounded to five places. No other text should be printed.",
            "solution": "The problem statement is scientifically grounded, well-posed, and objective. It is based on established principles of remote sensing and image processing, provides all necessary data and parameters, and is free of ambiguity or contradiction. Therefore, we may proceed with a solution.\n\nThe objective is to formulate and implement a cloud detection algorithm based on local spatial texture, and then to apply it to a series of test cases. The derivation and implementation proceed in five principal steps: (1) calculation of local variance for each spectral band, (2) aggregation and normalization of variances to produce a cloud score, (3) thresholding the score to create an initial binary detection, (4) stabilization of the detection using morphological closing, and (5) calculation of summary statistics from the final result.\n\n### Step 1: Local Variance Calculation\n\nThe physical premise is that clouds, due to their microphysical heterogeneity and three-dimensional structure, exhibit greater spatial texture than clear-sky surfaces. This texture can be quantified by a measure of local statistical dispersion, such as variance. We are given three input bands of Top-of-Atmosphere (TOA) reflectance, $R^{(c)}(x,y)$, where $c \\in \\{B, G, R\\}$ for Blue, Green, and Red bands, respectively.\n\nFor each band $c$, we compute a local variance map, $\\sigma_c^2(x,y)$. The problem specifies using the fundamental definition of variance. For a given pixel at coordinates $(x,y)$, we consider a square neighborhood $K$ of width $w=3$ centered at this pixel. The number of pixels in this neighborhood is $|K| = w^2 = 9$.\n\nThe local mean reflectance, $\\mu_c(x,y)$, is the arithmetic average of reflectance values within the neighborhood $K$:\n$$ \\mu_c(x,y) = \\frac{1}{|K|} \\sum_{(i,j)\\in K'} R^{(c)}(x+i, y+j) $$\nwhere $K'$ represents the set of relative offsets from the center, here from $(-1,-1)$ to $(1,1)$.\n\nThe local second moment, $m_{2,c}(x,y)$, is the average of the squared reflectance values in the same neighborhood:\n$$ m_{2,c}(x,y) = \\frac{1}{|K|} \\sum_{(i,j)\\in K'} [R^{(c)}(x+i, y+j)]^2 $$\n\nThe local variance is then given by the relation:\n$$ \\sigma_c^2(x,y) = m_{2,c}(x,y) - [\\mu_c(x,y)]^2 $$\nThis calculation is performed for every pixel $(x,y)$ in each of the three bands, yielding three variance maps: $\\sigma_B^2(x,y)$, $\\sigma_G^2(x,y)$, and $\\sigma_R^2(x,y)$.\n\nFor pixels near the image boundaries, the $w \\times w$ neighborhood extends beyond the image domain. The problem specifies handling these edges using \"symmetric reflection\". This corresponds to a padding mode where the image is extended by mirroring it at the boundary. Computationally, this is achieved by applying a sliding window operator (e.g., a uniform filter) with the appropriate boundary-handling mode, such as `mode='mirror'` in the `scipy.ndimage` library, which reflects about the center of the last pixel.\n\n### Step 2: Aggregation and Normalization\n\nTo obtain a single, comprehensive cloud indicator, the band-specific variances are aggregated. The problem mandates using their arithmetic mean. Let $V(x,y)$ be the aggregated variance:\n$$ V(x,y) = \\frac{1}{3} \\left( \\sigma_B^2(x,y) + \\sigma_G^2(x,y) + \\sigma_R^2(x,y) \\right) $$\n\nThis aggregated variance $V(x,y)$ serves as a raw texture score. To transform it into a normalized, dimensionless cloud score $s(x,y)$ in the range $[0, 1]$, we scale it by a fixed positive constant $T = 0.005$. The score is then clipped to the valid range.\n$$ s(x,y) = \\text{clip} \\left( \\frac{V(x,y)}{T}, 0, 1 \\right) $$\nSince variance $V(x,y)$ is non-negative, this simplifies to:\n$$ s(x,y) = \\min \\left( \\frac{V(x,y)}{T}, 1 \\right) $$\n\n### Step 3: Thresholding\n\nA binary cloud detection map, $d(x,y)$, is generated by applying a fixed threshold $\\tau = 0.6$ to the cloud score map $s(x,y)$. Pixels with a score greater than or equal to the threshold are classified as cloud ($1$), and others as non-cloud ($0$).\n$$ d(x,y) = \\begin{cases} 1 & \\text{if } s(x,y) \\ge \\tau \\\\ 0 & \\text{if } s(x,y) < \\tau \\end{cases} $$\nThis initial map may contain spurious detections or be fragmented, especially in regions of complex texture.\n\n### Step 4: Morphological Closing\n\nTo improve the spatial coherence of the detection map, we apply morphological closing. Closing is a standard image processing operation that tends to fill small holes and connect nearby objects. It is defined as a dilation operation followed by an erosion operation, using a specified structuring element $S$.\n$$ \\hat{d}(x,y) = \\text{close}(d(x,y), S) = \\text{erode}(\\text{dilate}(d(x,y), S), S) $$\nHere, $S$ is a $3 \\times 3$ square structuring element, a matrix of all ones. The dilation operation expands the regions of detected cloud pixels, filling in small gaps. The subsequent erosion shrinks the expanded regions, but the newly filled gaps typically remain filled. The result is a \"stabilized\" detection map $\\hat{d}(x,y)$.\n\n### Step 5: Final Metrics Calculation\n\nFinally, for each test case, we compute two metrics from the stabilized detection map $\\hat{d}(x,y)$ and the cloud score map $s(x,y)$:\n1.  The total count of cloud pixels, $c$, is the sum of all pixel values in the final binary map:\n    $$ c = \\sum_{x,y} \\hat{d}(x,y) $$\n2.  The mean cloud score, $m$, is calculated over the pixels identified as cloud in the final map. It is the sum of scores in the cloud-covered pixels divided by the total count of cloud pixels. If no cloud pixels are detected ($c=0$), the mean score is defined as $0$.\n    $$ m = \\begin{cases} \\frac{1}{c} \\sum_{x,y} s(x,y) \\cdot \\hat{d}(x,y) & \\text{if } c > 0 \\\\ 0 & \\text{if } c = 0 \\end{cases} $$\nThese steps are implemented for each provided test case to produce the final results.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.ndimage import uniform_filter, binary_closing\n\ndef solve():\n    \"\"\"\n    Main function to execute the cloud detection algorithm on the test suite.\n    \"\"\"\n    \n    # Define constants from the problem statement.\n    w = 3         # Neighborhood width for local statistics\n    T = 0.005     # Normalization scale for cloud score\n    tau = 0.6     # Detection threshold for cloud score\n\n    # Test cases from the problem statement.\n    test_cases = [\n        # Test case 1: Mixture with textured cloud core\n        {\n            \"name\": \"case 1\",\n            \"R_b\": np.full((6, 6), 0.15, dtype=float),\n            \"R_g\": np.full((6, 6), 0.18, dtype=float),\n            \"R_r\": np.full((6, 6), 0.14, dtype=float),\n        },\n        # Test case 2: Uniform clear sky\n        {\n            \"name\": \"case 2\",\n            \"R_b\": np.full((6, 6), 0.12, dtype=float),\n            \"R_g\": np.full((6, 6), 0.12, dtype=float),\n            \"R_r\": np.full((6, 6), 0.12, dtype=float),\n        },\n        # Test case 3: Uniform bright surface (snow)\n        {\n            \"name\": \"case 3\",\n            \"R_b\": np.full((6, 6), 0.65, dtype=float),\n            \"R_g\": np.full((6, 6), 0.65, dtype=float),\n            \"R_r\": np.full((6, 6), 0.65, dtype=float),\n        },\n        # Test case 4: Fragmented bright patches with a small hole\n        {\n            \"name\": \"case 4\",\n            \"R_b\": np.full((6, 6), 0.20, dtype=float),\n            \"R_g\": np.full((6, 6), 0.22, dtype=float),\n            \"R_r\": np.full((6, 6), 0.19, dtype=float),\n        },\n    ]\n\n    # Populate special values for test cases\n    # Case 1\n    test_cases[0][\"R_b\"][2:5, 2:5] = np.array([[0.45, 0.50, 0.47], [0.48, 0.55, 0.49], [0.46, 0.52, 0.48]])\n    test_cases[0][\"R_g\"][2:5, 2:5] = np.array([[0.52, 0.58, 0.54], [0.55, 0.62, 0.56], [0.53, 0.59, 0.55]])\n    test_cases[0][\"R_r\"][2:5, 2:5] = np.array([[0.43, 0.48, 0.45], [0.46, 0.51, 0.47], [0.44, 0.49, 0.46]])\n\n    # Case 4\n    test_cases[3][\"R_b\"][0:3, 0:3] = np.array([[0.50, 0.52, 0.51], [0.53, 0.20, 0.54], [0.51, 0.55, 0.52]])\n    test_cases[3][\"R_g\"][0:3, 0:3] = np.array([[0.56, 0.57, 0.55], [0.58, 0.22, 0.59], [0.56, 0.60, 0.57]])\n    test_cases[3][\"R_r\"][0:3, 0:3] = np.array([[0.48, 0.50, 0.49], [0.51, 0.19, 0.52], [0.49, 0.53, 0.50]])\n    \n    results = []\n    \n    for case in test_cases:\n        # Assemble bands for processing\n        reflectance_bands = [case[\"R_b\"], case[\"R_g\"], case[\"R_r\"]]\n        \n        # Step 1: Local Variance Calculation for each band\n        all_band_variances = []\n        for band_data in reflectance_bands:\n            # The 'mirror' mode in scipy.ndimage corresponds to symmetric reflection\n            # by mirroring about the center of boundary pixels.\n            local_mean = uniform_filter(band_data, size=w, mode='mirror')\n            local_second_moment = uniform_filter(np.square(band_data), size=w, mode='mirror')\n            \n            variance = local_second_moment - np.square(local_mean)\n            # Correct for potential floating point inaccuracies\n            variance[variance < 0] = 0\n            all_band_variances.append(variance)\n            \n        # Step 2: Aggregation and Normalization\n        aggregated_variance = np.mean(np.array(all_band_variances), axis=0)\n        cloud_score = aggregated_variance / T\n        cloud_score = np.clip(cloud_score, 0, 1)\n        \n        # Step 3: Thresholding\n        detection_map = cloud_score >= tau\n        \n        # Step 4: Morphological Closing\n        structuring_element = np.ones((3, 3), dtype=bool)\n        stabilized_detection = binary_closing(detection_map, structure=structuring_element)\n        \n        # Step 5: Final Metrics Calculation\n        cloud_pixels_mask = stabilized_detection == 1\n        count = np.sum(cloud_pixels_mask)\n        \n        if count == 0:\n            mean_score = 0.0\n        else:\n            mean_score = np.mean(cloud_score[cloud_pixels_mask])\n            \n        results.append([int(count), f\"{mean_score:.5f}\"])\n\n    # Final print statement in the exact required format.\n    results_str = [f\"[{c},{m}]\" for c, m in results]\n    print(f\"[{','.join(results_str)}]\")\n\nsolve()\n```"
        }
    ]
}