{
    "hands_on_practices": [
        {
            "introduction": "几何配准误差是变化检测中产生虚假变化信号的一个主要来源，尤其是在地表异质性高的区域。本练习将运用微积分和统计学知识，对亚像元级别配准误差造成的影响进行数学建模和量化，将一个定性的担忧转变为可预测的误差源。通过推导，您将亲身体会到图像梯度与配准精度如何直接影响变化检测结果的可靠性 。",
            "id": "3820730",
            "problem": "一对经过大气校正的同一场景的地表反射率图像 $I_1(\\mathbf{x})$ 和 $I_2(\\mathbf{x})$ 通过图像差分法用于变化检测，其中差分图像定义为 $D(\\mathbf{x}) = I_2(\\mathbf{x}) - I_1(\\mathbf{x})$。假设在两次采集时间之间没有真实的物理变化，但第二幅图像存在亚像素配准误差，因此 $I_2$ 中的采样点位于位置 $\\mathbf{x} + \\delta \\mathbf{x}$，其中 $\\delta \\mathbf{x}$ 代表配准误差向量。在空间异质的地景中，$I_1(\\mathbf{x})$ 中的边缘和梯度不为零。\n\n从 $I_1(\\mathbf{x})$ 的可微性以及平移配准误差会使采样位置发生偏移这一物理释义出发，在一个固定像素点 $\\mathbf{x}_0$ 上完成以下任务：\n\n- 使用基于标准多元微积分的一阶展开，表示出在没有真实变化的情况下，仅由 $\\delta \\mathbf{x}$ 引起的对 $D(\\mathbf{x}_0)$ 的主阶贡献。\n\n- 设 $\\delta \\mathbf{x}$ 被建模为一个零均值的二元高斯随机向量，其协方差矩阵为 $\\boldsymbol{\\Sigma}$。利用高斯随机变量线性变换的性质，推导虚假变化的期望幅度 $\\mathbb{E}\\left[|D(\\mathbf{x}_0)|\\right]$ 的解析表达式，该表达式应以 $\\nabla I_1(\\mathbf{x}_0)$ 和 $\\boldsymbol{\\Sigma}$ 表示。\n\n- 对于一个位于水陆边界上的像素，其局部空间梯度测量值为 $\\nabla I_1(\\mathbf{x}_0) = \\begin{pmatrix} 0.022 \\\\ -0.015 \\end{pmatrix}$（单位：反射率/米），配准误差的协方差为 $\\boldsymbol{\\Sigma} = \\begin{pmatrix} 0.36  0.06 \\\\ 0.06  0.16 \\end{pmatrix}$（单位：$\\mathrm{m}^2$）。对推导出的表达式进行数值计算，以小数形式的反射率（无量纲）表示最终的虚假变化的期望幅度 $\\mathbb{E}\\left[|D(\\mathbf{x}_0)|\\right]$，并将答案四舍五入至 $4$ 位有效数字。",
            "solution": "该问题经验证具有科学依据、提法恰当且客观。这是将多元微积分和统计学应用于遥感变化检测中一个实际问题的标准案例。所有必要信息都已提供，问题没有矛盾或含糊之处。\n\n该问题要求完成一个三部分的推导和计算，内容涉及由亚像素配准误差引起的图像差分中的虚假变化信号。\n\n首先，我们来推导在像素点 $\\mathbf{x}_0$ 处对差分图像 $D(\\mathbf{x}_0)$ 的主阶贡献。差分图像定义为 $D(\\mathbf{x}) = I_2(\\mathbf{x}) - I_1(\\mathbf{x})$。问题陈述，场景中没有真实的物理变化，因此底层的反射率场在两个时间点均由 $I_1(\\mathbf{x})$ 描述。第二幅图像 $I_2$ 是第一幅图像的配准误差版本，意味着其采样点位于偏移后的位置。这可以正式表示为 $I_2(\\mathbf{x}) = I_1(\\mathbf{x} + \\delta\\mathbf{x})$，其中 $\\delta\\mathbf{x}$ 是亚像素配准误差向量。\n\n将此表达式代入特定像素点 $\\mathbf{x}_0$ 处的差分图像定义中，我们得到：\n$$D(\\mathbf{x}_0) = I_1(\\mathbf{x}_0 + \\delta\\mathbf{x}) - I_1(\\mathbf{x}_0)$$\n问题假设图像函数 $I_1(\\mathbf{x})$ 是可微的。因此我们可以对 $I_1$ 在点 $\\mathbf{x}_0$ 附近使用一阶多元泰勒展开：\n$$I_1(\\mathbf{x}_0 + \\delta\\mathbf{x}) \\approx I_1(\\mathbf{x}_0) + \\nabla I_1(\\mathbf{x}_0) \\cdot \\delta\\mathbf{x}$$\n此处，$\\nabla I_1(\\mathbf{x}_0)$ 是图像强度在 $\\mathbf{x}_0$ 处的梯度，它是一个列向量，而乘积是点积。这也可以写作 $\\nabla I_1(\\mathbf{x}_0)^T \\delta\\mathbf{x}$。将此展开式代回 $D(\\mathbf{x}_0)$ 的表达式中：\n$$D(\\mathbf{x}_0) \\approx \\left( I_1(\\mathbf{x}_0) + \\nabla I_1(\\mathbf{x}_0)^T \\delta\\mathbf{x} \\right) - I_1(\\mathbf{x}_0)$$\n这可以简化为对虚假变化信号的主阶贡献：\n$$D(\\mathbf{x}_0) \\approx \\nabla I_1(\\mathbf{x}_0)^T \\delta\\mathbf{x}$$\n\n第二，我们推导这个虚假变化的期望幅度 $\\mathbb{E}\\left[|D(\\mathbf{x}_0)|\\right]$ 的解析表达式。我们将虚假变化建模为标量随机变量 $D_0 = \\mathbf{g}^T \\delta\\mathbf{x}$，其中我们定义常数向量 $\\mathbf{g} = \\nabla I_1(\\mathbf{x}_0)$。配准误差向量 $\\delta\\mathbf{x}$ 被建模为零均值的二元高斯随机向量，即 $\\delta\\mathbf{x} \\sim \\mathcal{N}(\\mathbf{0}, \\boldsymbol{\\Sigma})$，其中 $\\mathbf{0}$ 是零向量，$\\boldsymbol{\\Sigma}$ 是协方差矩阵。\n\n多元高斯分布的一个基本性质是，高斯随机向量的任何线性变换的结果仍然是高斯随机变量（或向量）。由于 $D_0$ 是 $\\delta\\mathbf{x}$ 的一个标量线性变换，因此 $D_0$ 是一个一元高斯随机变量。我们来确定它的均值和方差。\n$D_0$ 的均值为：\n$$\\mathbb{E}[D_0] = \\mathbb{E}[\\mathbf{g}^T \\delta\\mathbf{x}] = \\mathbf{g}^T \\mathbb{E}[\\delta\\mathbf{x}] = \\mathbf{g}^T \\mathbf{0} = 0$$\n$D_0$ 的方差由随机向量线性变换的方差通用公式 $\\mathrm{Var}(\\mathbf{A}\\mathbf{y}) = \\mathbf{A}\\mathrm{Var}(\\mathbf{y})\\mathbf{A}^T$ 给出。在我们的标量情况（$D_0 = \\mathbf{g}^T \\delta\\mathbf{x}$）下：\n$$\\sigma_{D_0}^2 = \\mathrm{Var}(D_0) = \\mathrm{Var}(\\mathbf{g}^T \\delta\\mathbf{x}) = \\mathbf{g}^T \\mathrm{Var}(\\delta\\mathbf{x}) \\mathbf{g} = \\mathbf{g}^T \\boldsymbol{\\Sigma} \\mathbf{g}$$\n因此，$D_0$ 服从零均值正态分布，即 $D_0 \\sim \\mathcal{N}(0, \\sigma_{D_0}^2)$，其概率密度函数为 $f(d) = \\frac{1}{\\sqrt{2\\pi}\\sigma_{D_0}} \\exp\\left(-\\frac{d^2}{2\\sigma_{D_0}^2}\\right)$。\n\n我们需要计算 $D_0$ 的绝对值的期望：\n$$\\mathbb{E}[|D_0|] = \\int_{-\\infty}^{\\infty} |d| f(d) \\, \\mathrm{d}d = \\int_{-\\infty}^{\\infty} |d| \\frac{1}{\\sqrt{2\\pi}\\sigma_{D_0}} \\exp\\left(-\\frac{d^2}{2\\sigma_{D_0}^2}\\right) \\, \\mathrm{d}d$$\n由于被积函数是偶函数，我们可以将其简化为：\n$$\\mathbb{E}[|D_0|] = 2 \\int_{0}^{\\infty} d \\frac{1}{\\sqrt{2\\pi}\\sigma_{D_0}} \\exp\\left(-\\frac{d^2}{2\\sigma_{D_0}^2}\\right) \\, \\mathrm{d}d$$\n这个积分是一个标准结果，对应于半正态分布的均值。其计算结果为：\n$$\\mathbb{E}[|D_0|] = \\sigma_{D_0} \\sqrt{\\frac{2}{\\pi}}$$\n代入 $\\sigma_{D_0}$ 的表达式：\n$$\\mathbb{E}\\left[|D(\\mathbf{x}_0)|\\right] = \\sqrt{\\frac{2}{\\pi}} \\sqrt{\\mathbf{g}^T \\boldsymbol{\\Sigma} \\mathbf{g}} = \\sqrt{\\frac{2}{\\pi} \\left( \\nabla I_1(\\mathbf{x}_0)^T \\boldsymbol{\\Sigma} \\nabla I_1(\\mathbf{x}_0) \\right)}$$\n\n第三，我们对这个表达式进行数值计算。给定的值为：\n$$\\nabla I_1(\\mathbf{x}_0) = \\begin{pmatrix} 0.022 \\\\ -0.015 \\end{pmatrix} \\quad \\text{和} \\quad \\boldsymbol{\\Sigma} = \\begin{pmatrix} 0.36  0.06 \\\\ 0.06  0.16 \\end{pmatrix}$$\n令 $\\mathbf{g} = \\nabla I_1(\\mathbf{x}_0)$。我们首先计算方差 $\\sigma_{D_0}^2 = \\mathbf{g}^T \\boldsymbol{\\Sigma} \\mathbf{g}$：\n$$\\sigma_{D_0}^2 = \\begin{pmatrix} 0.022  -0.015 \\end{pmatrix} \\begin{pmatrix} 0.36  0.06 \\\\ 0.06  0.16 \\end{pmatrix} \\begin{pmatrix} 0.022 \\\\ -0.015 \\end{pmatrix}$$\n首先，我们计算 $\\mathbf{g}^T \\boldsymbol{\\Sigma}$：\n$$\\begin{pmatrix} 0.022  -0.015 \\end{pmatrix} \\begin{pmatrix} 0.36  0.06 \\\\ 0.06  0.16 \\end{pmatrix} = \\begin{pmatrix} (0.022)(0.36) + (-0.015)(0.06)  (0.022)(0.06) + (-0.015)(0.16) \\end{pmatrix}$$\n$$= \\begin{pmatrix} 0.00792 - 0.0009  0.00132 - 0.0024 \\end{pmatrix} = \\begin{pmatrix} 0.00702  -0.00108 \\end{pmatrix}$$\n接下来，我们将此结果乘以 $\\mathbf{g}$：\n$$\\sigma_{D_0}^2 = \\begin{pmatrix} 0.00702  -0.00108 \\end{pmatrix} \\begin{pmatrix} 0.022 \\\\ -0.015 \\end{pmatrix} = (0.00702)(0.022) + (-0.00108)(-0.015)$$\n$$\\sigma_{D_0}^2 = 0.00015444 + 0.0000162 = 0.00017064$$\n标准差 $\\sigma_{D_0}$ 为：\n$$\\sigma_{D_0} = \\sqrt{0.00017064} \\approx 0.01306292$$\n最后，我们计算期望幅度：\n$$\\mathbb{E}\\left[|D(\\mathbf{x}_0)|\\right] = \\sigma_{D_0} \\sqrt{\\frac{2}{\\pi}} \\approx (0.01306292) \\times \\sqrt{\\frac{2}{\\pi}} \\approx (0.01306292) \\times (0.79788456)$$\n$$\\mathbb{E}\\left[|D(\\mathbf{x}_0)|\\right] \\approx 0.01042299$$\n四舍五入到 $4$ 位有效数字，虚假变化的期望幅度为 $0.01042$。该值的单位是反射率，是无量纲的。",
            "answer": "$$\\boxed{0.01042}$$"
        },
        {
            "introduction": "图像比值法是消除光照差异、凸显地物变化的有效手段，但其计算结果并非确定值，而是伴随着来自原始图像的测量不确定性。本练习将应用泰勒展开（“德尔塔方法”）来传播这种不确定性，为您提供计算比值结果置信区间的能力，从而能够对比值变化做出有统计学依据的判断 。这使您从简单地计算变化，提升到评估变化的显著性。",
            "id": "3820727",
            "problem": "一种基于比率的变化检测方案使用在同一位置 $\\mathbf{x}$ 的两个采集日期的大气校正后地表反射率之间的比率图像 $R(\\mathbf{x}) = \\dfrac{X_{2}(\\mathbf{x})}{X_{1}(\\mathbf{x})}$。考虑单个像素，并将反射率建模为随机变量 $X_{1}$ 和 $X_{2}$，其均值有限，分别为 $\\mu_{1} = \\mathbb{E}[X_{1}]$、$\\mu_{2} = \\mathbb{E}[X_{2}]$，方差分别为 $\\sigma_{1}^{2} = \\mathrm{Var}(X_{1})$、$\\sigma_{2}^{2} = \\mathrm{Var}(X_{2})$，这些不确定性源于传感器和残余校正噪声。假设测量误差在不同日期之间是无偏且独立的，因此 $\\mathrm{Cov}(X_{1}, X_{2}) = 0$，并且每个日期内的真实反射率是恒定的，因此不确定性主要由测量噪声决定。令 $g(x_{1}, x_{2}) = x_{2}/x_{1}$。\n\n仅从函数 $g$ 在 $(\\mu_{1}, \\mu_{2})$ 点的一阶多元泰勒展开以及不确定性传播的标准法则（也称为delta方法）出发，完成以下任务：\n\n1. 在所述的独立性假设下，用 $\\mu_{1}$、$\\mu_{2}$、$\\sigma_{1}^{2}$ 和 $\\sigma_{2}^{2}$ 推导 $\\mathbb{E}[R]$ 和 $\\mathrm{Var}(R)$ 的一阶近似。\n2. 基于你的方差表达式，使用对 $R$ 的正态近似，提出一个 $R$ 的双边 $(1-\\alpha)$ 置信区间（CI），其中 $\\alpha = 0.05$。\n3. 对于一个近红外像素，其参数为 $\\mu_{1} = 0.24$、$\\mu_{2} = 0.264$、$\\sigma_{1} = 0.01$ 和 $\\sigma_{2} = 0.012$，计算由你的推导得出的 $R$ 的双边 $95\\%$ 置信区间的上端点。将你的答案四舍五入到四位有效数字。结果表示为无量纲数（无单位）。",
            "solution": "我们从测量模型开始，其中 $X_{1}$ 和 $X_{2}$ 是代表两个日期的反射率的随机变量，其均值为 $\\mu_{1}$ 和 $\\mu_{2}$，方差为 $\\sigma_{1}^{2}$ 和 $\\sigma_{2}^{2}$，且 $\\mathrm{Cov}(X_{1}, X_{2}) = 0$。变化度量是 $R = g(X_{1}, X_{2})$，其中 $g(x_{1}, x_{2}) = x_{2}/x_{1}$。\n\n一阶多元泰勒展开（delta方法）：对于一个可微函数 $g$ 和一个随机向量 $\\mathbf{X} = (X_{1}, X_{2})^{\\top}$（其均值为 $\\boldsymbol{\\mu} = (\\mu_{1}, \\mu_{2})^{\\top}$，协方差矩阵为 $\\boldsymbol{\\Sigma}$），一阶展开为\n$$\ng(\\mathbf{X}) \\approx g(\\boldsymbol{\\mu}) + \\nabla g(\\boldsymbol{\\mu})^{\\top}(\\mathbf{X} - \\boldsymbol{\\mu}),\n$$\n传播后的均值和方差为\n$$\n\\mathbb{E}[g(\\mathbf{X})] \\approx g(\\boldsymbol{\\mu}), \\quad \\mathrm{Var}(g(\\mathbf{X})) \\approx \\nabla g(\\boldsymbol{\\mu})^{\\top} \\boldsymbol{\\Sigma}\\, \\nabla g(\\boldsymbol{\\mu}).\n$$\n\n计算 $g$ 的梯度：\n- 关于 $x_{1}$ 的偏导数是\n$$\n\\frac{\\partial g}{\\partial x_{1}}(x_{1}, x_{2}) = -\\frac{x_{2}}{x_{1}^{2}}.\n$$\n- 关于 $x_{2}$ 的偏导数是\n$$\n\\frac{\\partial g}{\\partial x_{2}}(x_{1}, x_{2}) = \\frac{1}{x_{1}}.\n$$\n因此，\n$$\n\\nabla g(\\boldsymbol{\\mu}) =\n\\begin{pmatrix}\n-\\dfrac{\\mu_{2}}{\\mu_{1}^{2}} \\\\\n\\dfrac{1}{\\mu_{1}}\n\\end{pmatrix}.\n$$\n\n在独立性假设下，协方差矩阵是\n$$\n\\boldsymbol{\\Sigma} =\n\\begin{pmatrix}\n\\sigma_{1}^{2}  0 \\\\\n0  \\sigma_{2}^{2}\n\\end{pmatrix}.\n$$\n\n因此，一阶传播的均值和方差为：\n- 均值：\n$$\n\\mathbb{E}[R] \\approx g(\\boldsymbol{\\mu}) = \\frac{\\mu_{2}}{\\mu_{1}}.\n$$\n- 方差：\n$$\n\\mathrm{Var}(R) \\approx\n\\begin{pmatrix}\n-\\dfrac{\\mu_{2}}{\\mu_{1}^{2}}  \\dfrac{1}{\\mu_{1}}\n\\end{pmatrix}\n\\begin{pmatrix}\n\\sigma_{1}^{2}  0 \\\\\n0  \\sigma_{2}^{2}\n\\end{pmatrix}\n\\begin{pmatrix}\n-\\dfrac{\\mu_{2}}{\\mu_{1}^{2}} \\\\\n\\dfrac{1}{\\mu_{1}}\n\\end{pmatrix}\n=\n\\left(\\frac{\\mu_{2}}{\\mu_{1}^{2}}\\right)^{2}\\sigma_{1}^{2} + \\left(\\frac{1}{\\mu_{1}}\\right)^{2}\\sigma_{2}^{2}.\n$$\n即，\n$$\n\\mathrm{Var}(R) \\approx \\frac{\\mu_{2}^{2}\\,\\sigma_{1}^{2}}{\\mu_{1}^{4}} + \\frac{\\sigma_{2}^{2}}{\\mu_{1}^{2}}.\n$$\n\n为了提出 $R$ 的一个双边 $(1-\\alpha)$ 置信区间，我们使用delta方法所蕴含的正态近似：\n$$\nR \\approx \\mathcal{N}\\!\\left(\\frac{\\mu_{2}}{\\mu_{1}},\\, \\frac{\\mu_{2}^{2}\\,\\sigma_{1}^{2}}{\\mu_{1}^{4}} + \\frac{\\sigma_{2}^{2}}{\\mu_{1}^{2}}\\right).\n$$\n令 $z_{1-\\alpha/2}$ 表示标准正态分布的上 $(1-\\alpha/2)$ 分位数。那么一个双边 $(1-\\alpha)$ 置信区间（CI）是\n$$\n\\left[\\frac{\\mu_{2}}{\\mu_{1}} - z_{1-\\alpha/2}\\,\\sqrt{\\frac{\\mu_{2}^{2}\\,\\sigma_{1}^{2}}{\\mu_{1}^{4}} + \\frac{\\sigma_{2}^{2}}{\\mu_{1}^{2}}}\\,,\\;\\;\n\\frac{\\mu_{2}}{\\mu_{1}} + z_{1-\\alpha/2}\\,\\sqrt{\\frac{\\mu_{2}^{2}\\,\\sigma_{1}^{2}}{\\mu_{1}^{4}} + \\frac{\\sigma_{2}^{2}}{\\mu_{1}^{2}}}\\right].\n$$\n\n应用于数值 $\\mu_{1} = 0.24$、$\\mu_{2} = 0.264$、$\\sigma_{1} = 0.01$、$\\sigma_{2} = 0.012$，其中 $\\alpha = 0.05$，因此 $z_{1-\\alpha/2} \\approx 1.96$。\n\n1. 点估计：\n$$\n\\widehat{R} \\approx \\frac{\\mu_{2}}{\\mu_{1}} = \\frac{0.264}{0.24} = 1.1.\n$$\n\n2. 方差分量：\n$$\n\\frac{\\sigma_{2}^{2}}{\\mu_{1}^{2}} = \\frac{0.012^{2}}{0.24^{2}} = \\frac{0.000144}{0.0576} = 0.0025,\n$$\n$$\n\\frac{\\mu_{2}^{2}\\,\\sigma_{1}^{2}}{\\mu_{1}^{4}} = \\frac{0.264^{2}\\cdot 0.01^{2}}{0.24^{4}} = \\frac{0.069696\\cdot 0.0001}{0.00331776} = \\frac{0.0000069696}{0.00331776} = 0.002100694444\\ldots\n$$\n因此，\n$$\n\\mathrm{Var}(R) \\approx 0.0025 + 0.002100694444\\ldots = 0.004600694444\\ldots\n$$\n且\n$$\n\\mathrm{SD}(R) \\approx \\sqrt{0.004600694444\\ldots} = 0.067828\\ldots\n$$\n\n3. 双边 $95\\%$ 置信区间的上端点：\n$$\n\\text{Upper} = \\widehat{R} + z_{0.975}\\,\\mathrm{SD}(R) \\approx 1.1 + 1.96 \\times 0.067828\\ldots \\approx 1.1 + 0.132944\\ldots = 1.232944\\ldots\n$$\n\n四舍五入到四位有效数字，上端点是 $1.233$（无量纲）。",
            "answer": "$$\\boxed{1.233}$$"
        },
        {
            "introduction": "本练习将拓展“差分”这一概念的内涵，从简单的“影像-影像”对比，转向“观测-模型”对比。我们将学习如何为反映季节性变化的时间序列数据拟合一个谐波模型，以代表地物的“正常”行为模式。通过计算观测值与模型预测值之间的残差（即异常差分），我们可以有效地检测出那些偏离了预期周期性规律的突变事件 。",
            "id": "3820694",
            "problem": "您正在为遥感中的单个图像像素的地表反射率建立单变量时间序列模型。反射率是闭区间 $\\left[0,1\\right]$ 内的无量纲量，并由于物候和光照几何的原因随时间周期性变化。假设索引为 $x$ 的像素的期望反射率可以表示为已知周期 $T$ 上的截断傅里叶级数的一阶谐波，并且与期望的偏差是加性的且均值为零。您的任务是，从第一性原理出发，为任意时间的期望反射率推导一个有原则的估计器，然后为一个留出的观测值计算基于异常的差分，该差分可作为变化检测指标。\n\n从以下基本依据开始：\n- 周期为 $T$ 的周期信号可以展开为傅里叶级数。在标准内积下，三角函数系 $\\left\\{1,\\cos\\left(2\\pi t/T\\right),\\sin\\left(2\\pi t/T\\right)\\right\\}$ 在一个周期上构成正交基。\n- Ordinary Least Squares (OLS) 方法是加性零均值噪声下线性模型残差平方和的最小化方法，并能得到数据在回归变量生成空间上的正交投影。\n- 余弦和正弦函数接受弧度制参数；因此，角度必须以弧度计算。\n\n仅使用这些依据，推导一个形式如下的线性模型\n$$\nI_t(x) \\approx a_0(x) + a_1(x)\\cos\\left(\\frac{2\\pi t}{T}\\right) + a_2(x)\\sin\\left(\\frac{2\\pi t}{T}\\right),\n$$\n并说明如何使用 Ordinary Least Squares (OLS) 从一组训练观测值 $\\left\\{(t_i, I_{t_i}(x))\\right\\}_{i=1}^n$ 中估计系数 $a_0(x)$、$a_1(x)$ 和 $a_2(x)$，其中不包括留出的目标时间。然后，定义并计算基于异常的差分\n$$\nD_a(x) = I_{t^\\star}(x) - \\widehat{I}_{t^\\star}(x),\n$$\n其中 $t^\\star$ 是一个留出时间，$I_{t^\\star}(x)$ 是在 $t^\\star$ 时的观测反射率，$\\widehat{I}_{t^\\star}(x)$ 是由拟合的谐波模型在 $t^\\star$ 时通过 OLS 预测的期望反射率。所有余弦和正弦参数都必须是弧度。反射率是无量纲的。\n\n实现要求：\n- 对于每个测试用例，仅使用其训练集 $\\left\\{(t_i, I_{t_i}(x))\\right\\}_{i=1}^n$ 和给定的周期 $T$ 来拟合谐波模型，然后在指定的留出时间 $t^\\star$ 使用给定的观测反射率 $I_{t^\\star}(x)$ 计算 $D_a(x)$。\n- 使用 Ordinary Least Squares (OLS) 估计系数。如果求解正规方程，请确保数值稳定性；使用一个数值上稳健的最小二乘解算器是可接受的。\n- 将每个测试用例的 $D_a(x)$ 报告为一个四舍五入到 $6$ 位小数的浮点数。\n\n角度单位规范：\n- 所有三角函数求值都必须使用弧度。\n\n单位：\n- 反射率是无量纲的。当周期 $T$ 以天为单位指定时，时间也以天为单位；否则，时间使用任意时间单位。只要 $t$ 和 $T$ 使用相同的单位，单位的选择是无关紧要的。\n\n测试套件：\n将以下 $4$ 个测试用例作为常量提供给您的程序。对于每个用例，$T$ 是周期，$t_{\\text{train}}$ 是训练时间列表，$I_{\\text{train}}$ 是对应的训练反射率列表，$t^\\star$ 是用于评估的留出时间，$I_{t^\\star}$ 是留出反射率。除了时间和周期，以下所有数字都是无量纲的。确保三角函数参数使用从这些时间和周期计算出的弧度值。\n\n- 用例 $1$ (一般季节性信号，多个样本):\n  - $T = 365.0$\n  - $t_{\\text{train}} = [15.0, 80.0, 170.0, 260.0, 330.0]$\n  - $I_{\\text{train}} = [0.34, 0.31, 0.22, 0.20, 0.28]$\n  - $t^\\star = 200.0$\n  - $I_{t^\\star} = 0.27$\n- 用例 $2$ (边界情况：恒定反射率，模型应退化为常数):\n  - $T = 360.0$\n  - $t_{\\text{train}} = [0.0, 90.0, 180.0, 270.0]$\n  - $I_{\\text{train}} = [0.4, 0.4, 0.4, 0.4]$\n  - $t^\\star = 45.0$\n  - $I_{t^\\star} = 0.41$\n- 用例 $3$ (边界情况：恰好三个训练点，若独立则唯一确定系数):\n  - $T = 100.0$\n  - $t_{\\text{train}} = [0.0, 25.0, 50.0]$\n  - $I_{\\text{train}} = [0.35, 0.32, 0.25]$\n  - $t^\\star = 75.0$\n  - $I_{t^\\star} = 0.26$\n- 用例 $4$ (理想情况：不规则采样和无噪声谐波一致性):\n  - $T = 10.0$\n  - $t_{\\text{train}} = [1.0, 2.0, 3.0, 5.0, 7.0, 9.0]$\n  - $I_{\\text{train}} = [0.7176, 0.7902, 0.7902, 0.6, 0.4098, 0.4824]$\n  - $t^\\star = 4.0$\n  - $I_{t^\\star} = 0.6676$\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，$[r_1,r_2,r_3,r_4]$），其中 $r_i$ 是用例 $i$ 的 $D_a(x)$ 值，每个值都四舍五入到 $6$ 位小数。不要打印任何其他文本。",
            "solution": "该问题要求推导并应用一个 Ordinary Least Squares (OLS) 估计器，用于表示地表反射率时间序列数据的一阶谐波模型的系数。随后，该模型被用于为一个留出的观测值计算基于异常的差分。\n\n对于像素 $x$，在时间 $t$ 的期望反射率 $I_t(x)$ 的模型由一个周期为 $T$ 的截断傅里叶级数给出：\n$$\nI_t(x) \\approx \\widehat{I}_t(x) = a_0(x) + a_1(x)\\cos\\left(\\frac{2\\pi t}{T}\\right) + a_2(x)\\sin\\left(\\frac{2\\pi t}{T}\\right)\n$$\n为简化符号，像素索引 $x$ 将被省略，因为分析仅针对单个像素位置。角频率定义为 $\\omega = \\frac{2\\pi}{T}$。因此，模型为：\n$$\nI_t \\approx \\widehat{I}_t = a_0 + a_1\\cos(\\omega t) + a_2\\sin(\\omega t)\n$$\n该模型对于系数 $a_0$、$a_1$ 和 $a_2$ 是线性的。给定一组 $n$ 个训练观测值 $\\{(t_i, I_{t_i})\\}_{i=1}^n$，我们可以用一个线性方程组来表示整个训练集的关系。令 $\\mathbf{y}$ 为观测反射率向量，$\\mathbf{\\beta}$ 为系数向量：\n$$\n\\mathbf{y} = \\begin{pmatrix} I_{t_1} \\\\ I_{t_2} \\\\ \\vdots \\\\ I_{t_n} \\end{pmatrix}, \\quad \\mathbf{\\beta} = \\begin{pmatrix} a_0 \\\\ a_1 \\\\ a_2 \\end{pmatrix}\n$$\n该方程组可以写成矩阵形式 $\\mathbf{y} \\approx \\mathbf{X}\\mathbf{\\beta}$，其中 $\\mathbf{X}$ 是一个 $n \\times 3$ 的设计矩阵，其行由在每个时间 $t_i$ 求值的基函数构成：\n$$\n\\mathbf{X} = \\begin{pmatrix}\n1  \\cos(\\omega t_1)  \\sin(\\omega t_1) \\\\\n1  \\cos(\\omega t_2)  \\sin(\\omega t_2) \\\\\n\\vdots  \\vdots  \\vdots \\\\\n1  \\cos(\\omega t_n)  \\sin(\\omega t_n)\n\\end{pmatrix}\n$$\nOrdinary Least Squares (OLS) 方法旨在找到最小化残差平方和 (SSR) 的系数向量 $\\hat{\\mathbf{\\beta}}$，SSR 是残差向量 $\\mathbf{e} = \\mathbf{y} - \\mathbf{X}\\mathbf{\\beta}$ 的欧几里得范数的平方：\n$$\n\\text{SSR}(\\mathbf{\\beta}) = \\sum_{i=1}^n (I_{t_i} - \\widehat{I}_{t_i})^2 = \\|\\mathbf{y} - \\mathbf{X}\\mathbf{\\beta}\\|^2\n$$\n最小化此量的向量 $\\hat{\\mathbf{\\beta}}$ 即为 OLS 估计值。根据前述原理，OLS 得到数据向量 $\\mathbf{y}$ 在设计矩阵 $\\mathbf{X}$ 列空间上的正交投影。其解通过正规方程找到：\n$$\n(\\mathbf{X}^T \\mathbf{X}) \\hat{\\mathbf{\\beta}} = \\mathbf{X}^T \\mathbf{y}\n$$\n如果矩阵 $\\mathbf{X}^T \\mathbf{X}$ 可逆（这要求 $\\mathbf{X}$ 的列是线性无关的，当 $n \\ge 3$ 且观测时间 $t_i$ 足够分散时，此条件满足），则估计系数的唯一解为：\n$$\n\\hat{\\mathbf{\\beta}} = \\begin{pmatrix} \\hat{a}_0 \\\\ \\hat{a}_1 \\\\ \\hat{a}_2 \\end{pmatrix} = (\\mathbf{X}^T \\mathbf{X})^{-1} \\mathbf{X}^T \\mathbf{y}\n$$\n虽然此方程提供了解析解，但在实现时，为了避免直接对 $\\mathbf{X}^T \\mathbf{X}$ 求逆可能带来的不稳定性，更倾向于使用数值上稳健的算法，例如基于 QR 分解的算法。\n\n一旦从训练数据中估计出系数 $\\hat{\\mathbf{\\beta}} = [\\hat{a}_0, \\hat{a}_1, \\hat{a}_2]^T$，我们就可以预测在留出时间 $t^\\star$ 的期望反射率 $\\widehat{I}_{t^\\star}$。这是通过应用拟合后的模型来完成的：\n$$\n\\widehat{I}_{t^\\star} = \\hat{a}_0 + \\hat{a}_1\\cos(\\omega t^\\star) + \\hat{a}_2\\sin(\\omega t^\\star)\n$$\n该预测可以表示为回归量向量 $\\mathbf{x}_{t^\\star}^T$ 和估计的系数向量 $\\hat{\\mathbf{\\beta}}$ 的点积：\n$$\n\\mathbf{x}_{t^\\star} = \\begin{pmatrix} 1 \\\\ \\cos(\\omega t^\\star) \\\\ \\sin(\\omega t^\\star) \\end{pmatrix}, \\quad \\widehat{I}_{t^\\star} = \\mathbf{x}_{t^\\star}^T \\hat{\\mathbf{\\beta}}\n$$\n最后，基于异常的差分 $D_a$ 被计算为在留出时间的观测反射率 $I_{t^\\star}$ 与预测反射率 $\\widehat{I}_{t^\\star}$ 之间的残差：\n$$\nD_a = I_{t^\\star} - \\widehat{I}_{t^\\star}\n$$\n这个量 $D_a$ 可作为变化检测指标。一个绝对值较大的 $D_a$ 值表明，在时间 $t^\\star$ 的观测值显著偏离了从训练数据中学到的既定周期性模式。$D_a$ 的符号表示偏差的方向。\n\n实现将对提供的每个测试用例遵循此程序，使用数值稳定的最小二乘解算器找到 $\\hat{\\mathbf{\\beta}}$，然后计算 $D_a$。所有三角函数的参数都按规定以弧度计算。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the harmonic model fitting and anomaly detection problem for all test cases.\n    \"\"\"\n    # Define the 4 test cases from the problem statement.\n    test_cases = [\n        # Case 1 (general seasonal signal, multiple samples)\n        {\n            \"T\": 365.0,\n            \"t_train\": [15.0, 80.0, 170.0, 260.0, 330.0],\n            \"I_train\": [0.34, 0.31, 0.22, 0.20, 0.28],\n            \"t_star\": 200.0,\n            \"I_t_star\": 0.27\n        },\n        # Case 2 (boundary: constant reflectance)\n        {\n            \"T\": 360.0,\n            \"t_train\": [0.0, 90.0, 180.0, 270.0],\n            \"I_train\": [0.4, 0.4, 0.4, 0.4],\n            \"t_star\": 45.0,\n            \"I_t_star\": 0.41\n        },\n        # Case 3 (boundary: exactly three training points)\n        {\n            \"T\": 100.0,\n            \"t_train\": [0.0, 25.0, 50.0],\n            \"I_train\": [0.35, 0.32, 0.25],\n            \"t_star\": 75.0,\n            \"I_t_star\": 0.26\n        },\n        # Case 4 (happy path with irregular sampling)\n        {\n            \"T\": 10.0,\n            \"t_train\": [1.0, 2.0, 3.0, 5.0, 7.0, 9.0],\n            \"I_train\": [0.7176, 0.7902, 0.7902, 0.6, 0.4098, 0.4824],\n            \"t_star\": 4.0,\n            \"I_t_star\": 0.6676\n        }\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        # Extract data for the current case\n        T = case[\"T\"]\n        t_train = np.array(case[\"t_train\"])\n        I_train = np.array(case[\"I_train\"])\n        t_star = case[\"t_star\"]\n        I_t_star = case[\"I_t_star\"]\n        \n        # Calculate angular frequency omega\n        omega = (2 * np.pi) / T\n        \n        # Construct the design matrix X for the training data\n        # The columns are 1, cos(omega*t), sin(omega*t)\n        n = len(t_train)\n        X = np.zeros((n, 3))\n        X[:, 0] = 1.0\n        X[:, 1] = np.cos(omega * t_train)\n        X[:, 2] = np.sin(omega * t_train)\n        \n        # Use Ordinary Least Squares (OLS) to estimate the coefficients beta_hat = [a0, a1, a2]\n        # np.linalg.lstsq is a numerically stable way to solve the normal equations.\n        beta_hat, _, _, _ = np.linalg.lstsq(X, I_train, rcond=None)\n        \n        # Construct the regressor vector for the held-out time t_star\n        x_star = np.array([1.0, np.cos(omega * t_star), np.sin(omega * t_star)])\n\n        # Predict the reflectance at t_star using the fitted model\n        I_hat_t_star = x_star @ beta_hat\n        \n        # Compute the anomaly-based difference Da\n        Da = I_t_star - I_hat_t_star\n        \n        # Append the rounded result to the list of results\n        results.append(round(Da, 6))\n\n    # Format the final output as a comma-separated list in brackets\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}