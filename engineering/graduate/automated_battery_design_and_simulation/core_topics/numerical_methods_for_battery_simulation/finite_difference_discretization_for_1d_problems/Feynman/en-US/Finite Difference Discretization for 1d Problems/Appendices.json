{
    "hands_on_practices": [
        {
            "introduction": "When modeling multi-component systems like batteries, we often encounter sharp interfaces between materials with different properties, such as conductivity. A naive discretization can violate fundamental physical laws like flux conservation across these interfaces. This practice  demonstrates how to construct a physically consistent finite volume scheme that correctly handles a discontinuous coefficient by deriving the harmonic mean for the interface conductivity, a result directly rooted in the principle of series resistances.",
            "id": "3914376",
            "problem": "Consider the steady one-dimensional conservation of charge in a heterogeneous battery electrolyte along a normalized spatial coordinate $x \\in [0,1]$. In the absence of volumetric sources or sinks, the conservation law states that the divergence of the ionic current density (flux) is zero. Under Ohm's law in electrolytes, the flux is given by the product of the effective ionic conductivity and the negative gradient of the electrolyte potential. Combining these yields a second-order differential equation for the potential. Let the potential be $u(x)$ and the effective conductivity be $a(x)$. The governing equation and boundary conditions are:\n- $-(a(x) \\, u_x)_x = 0$ for $x \\in (0,1)$,\n- $u(0) = 0$ (volts),\n- $u(1) = 1$ (volts).\n\nModel a sharp material interface at $x = 0.5$ by defining $a(x)$ as a piecewise constant:\n- $a(x) = 1$ for $x < 0.5$,\n- $a(x) = 100$ for $x > 0.5$.\nYou may assume that the cross-sectional area is unity. The jump in $a(x)$ represents a strong conductivity contrast, common in layered battery structures (e.g., transitions between separator and electrode). At the physical interface, the flux is continuous and the potential is continuous.\n\nTask: Derive from first principles a finite-difference or finite-volume discretization on a uniform grid of $N+1$ nodes over $[0,1]$ with spacing $h = 1/N$ that enforces discrete conservation of flux. The derivation must start from the conservation statement and Ohm's law, then cast the flux balance over each control volume into a discrete linear system for the nodal potential unknowns. When the discontinuity at $x=0.5$ lies between two adjacent nodes, the face that straddles the interface represents two materials in series over that segment; therefore, derive the appropriate effective face conductivity by reasoning from series resistances. Also construct a second, intentionally naive discretization that uses the arithmetic mean of neighboring conductivities at each face, to serve as a comparator. Solve the resulting linear systems for the discrete potentials under the stated Dirichlet boundary conditions.\n\nDefine the discrete face flux between nodes $i$ and $i+1$ as $J_{i+1/2} = - a_{i+1/2} \\, (u_{i+1}-u_i)/h$, where $a_{i+1/2}$ is the face conductivity obtained by your derivation. Use the discrete solution to assess continuity of flux across the material interface at $x=0.5$. To quantify the assessment, compute the following for each case:\n- The flux continuity metric $M$, defined as $M = \\frac{|J_\\text{right} - J_\\text{left}|}{\\max(|J_\\text{right}|,|J_\\text{left}|)}$, where $J_\\text{left}$ and $J_\\text{right}$ are the discrete face fluxes immediately to the left and right of $x=0.5$ (choose the pair of faces adjacent to $x=0.5$ according to whether $x=0.5$ equals a node or lies between two nodes).\n- The maximum nodal error $E_\\infty$ relative to the exact piecewise-linear solution implied by constant flux in each material layer and continuity at $x=0.5$. Express $E_\\infty$ as a dimensionless float computed over all nodes $x_i$.\n\nYour program must implement both face conductivity constructions:\n- The physically consistent series-based harmonic construction obtained from your derivation that properly accounts for sub-segment lengths when the interface lies within a face.\n- The naive arithmetic mean construction that simply averages neighboring pointwise conductivities.\n\nTest Suite:\nProvide results for the following four parameter sets $(N,\\text{method})$, where `method` is either \"harmonic\" for the series-based construction or \"arithmetic\" for the naive construction.\n1. (N=101, method=\"harmonic\")\n2. (N=100, method=\"harmonic\")\n3. (N=100, method=\"arithmetic\")\n4. (N=3, method=\"harmonic\")\n\nOutput Specification:\n- For each test case in the order listed, compute and collect the pair $[M,E_\\infty]$.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element is the two-element list for a test case, i.e., the final output must be of the form $[[M_1,E_{\\infty,1}],[M_2,E_{\\infty,2}],[M_3,E_{\\infty,3}],[M_4,E_{\\infty,4}]]$.\n- All outputs are dimensionless floats. The boundary conditions are in volts, so the discrete potentials used to compute errors must be in volts, but the reported metrics are unitless.\n\nNo additional text must be printed besides this single required output line.",
            "solution": "The user wants me to solve a 1D steady-state charge conservation problem using the finite difference method.\n\nHere's a plan:\n1.  **Validate the problem statement**:\n    *   Extract all the givens.\n    *   Check for scientific soundness, well-posedness, and objectivity.\n    *   The problem describes a standard 1D diffusion-type equation, which is a cornerstone of physics and engineering. The setup seems perfectly valid.\n\n2.  **Derive the solution**:\n    *   **Analytical Solution**: First, I'll find the exact analytical solution. This is needed to calculate the error later.\n        *   The governing equation is $-(a(x) u_x)_x = 0$.\n        *   Integrating once gives $-a(x) u_x = J$, where $J$ is a constant flux.\n        *   So, $u_x = -J/a(x)$.\n        *   Integrating again gives $u(x) = u(0) - J \\int_0^x \\frac{d\\xi}{a(\\xi)}$.\n        *   We have $u(0) = 0$. So, $u(x) = -J \\int_0^x \\frac{d\\xi}{a(\\xi)}$.\n        *   Using the boundary condition at $x=1$, $u(1) = 1 = -J \\int_0^1 \\frac{d\\xi}{a(\\xi)}$.\n        *   This allows us to find the constant flux $J$.\n        *   The integral is $\\int_0^1 \\frac{d\\xi}{a(\\xi)} = \\int_0^{0.5} \\frac{d\\xi}{1} + \\int_{0.5}^1 \\frac{d\\xi}{100} = 0.5 + \\frac{0.5}{100} = 0.5 + 0.005 = 0.505$.\n        *   So, $1 = -J (0.505)$, which means $J = -1/0.505$.\n        *   Now I can write the exact solution $u(x)$:\n            *   For $x \\in [0, 0.5]$: $u(x) = -J \\int_0^x \\frac{d\\xi}{1} = -J x = \\frac{x}{0.505}$.\n            *   For $x \\in (0.5, 1]$: We need continuity of potential at $x=0.5$.\n                *   $u(0.5) = \\frac{0.5}{0.505}$.\n                *   $u(x) = u(0.5) - J \\int_{0.5}^x \\frac{d\\xi}{100} = \\frac{0.5}{0.505} - J \\frac{x-0.5}{100} = \\frac{0.5}{0.505} + \\frac{1}{0.505} \\frac{x-0.5}{100}$.\n                *   $u(x) = \\frac{1}{0.505} \\left( 0.5 + \\frac{x-0.5}{100} \\right)$.\n        *   Let's check the boundary condition at $x=1$:\n            *   $u(1) = \\frac{1}{0.505} \\left( 0.5 + \\frac{1-0.5}{100} \\right) = \\frac{1}{0.505} \\left( 0.5 + \\frac{0.5}{100} \\right) = \\frac{1}{0.505} (0.505) = 1$. It works.\n        *   So the analytical solution is:\n            $$\n            u(x) = \\begin{cases}\n                \\frac{x}{0.505} & \\text{for } 0 \\le x \\le 0.5 \\\\\n                \\frac{1}{0.505} \\left( 0.5 + \\frac{x-0.5}{100} \\right) & \\text{for } 0.5 < x \\le 1\n            \\end{cases}\n            $$\n\n    *   **Discretization**:\n        *   The problem asks for a finite-difference or finite-volume discretization based on flux conservation. This naturally leads to a finite-volume approach.\n        *   Grid: $x_i = i \\cdot h$ for $i = 0, 1, ..., N$, with $h=1/N$.\n        *   Control volumes (CVs): For an interior node $i$ (from $i=1$ to $N-1$), the CV is $[x_{i-1/2}, x_{i+1/2}]$, where $x_{i+1/2} = (x_i + x_{i+1})/2$ is the face between nodes $i$ and $i+1$.\n        *   Conservation law integrated over the CV for node $i$:\n            $$ \\int_{x_{i-1/2}}^{x_{i+1/2}} -(a(x) u_x)_x \\, dx = 0 $$\n        *   Using the fundamental theorem of calculus:\n            $$ -(a(x) u_x)|_{x_{i+1/2}} - \\left( -(a(x) u_x)|_{x_{i-1/2}} \\right) = 0 $$\n        *   Let $J(x) = -a(x) u_x$ be the flux. Then $J(x_{i+1/2}) - J(x_{i-1/2}) = 0$. This expresses discrete flux conservation.\n        *   Now, we need to approximate the flux at the faces. The face flux at $x_{i+1/2}$ is $J_{i+1/2}$. We approximate the derivative $u_x$ at the face using a centered difference of the nodal values:\n            $$ J_{i+1/2} \\approx - a_{i+1/2} \\frac{u_{i+1} - u_i}{x_{i+1} - x_i} = - a_{i+1/2} \\frac{u_{i+1} - u_i}{h} $$\n            where $u_i = u(x_i)$.\n        *   The discrete conservation equation for interior node $i$ becomes:\n            $$ -a_{i+1/2} \\frac{u_{i+1} - u_i}{h} - \\left( -a_{i-1/2} \\frac{u_i - u_{i-1}}{h} \\right) = 0 $$\n            $$ -a_{i-1/2} u_{i-1} + (a_{i-1/2} + a_{i+1/2}) u_i - a_{i+1/2} u_{i+1} = 0 $$\n            This holds for $i = 1, 2, ..., N-1$.\n        *   The boundary conditions are $u_0 = u(0) = 0$ and $u_N = u(1) = 1$.\n        *   This gives a tridiagonal linear system $A \\cdot \\vec{u} = \\vec{b}$ for the unknown potentials $u_1, ..., u_{N-1}$.\n        *   The equation for $i=1$: $-a_{1/2} u_0 + (a_{1/2} + a_{3/2}) u_1 - a_{3/2} u_2 = 0$. Since $u_0=0$, this becomes $(a_{1/2} + a_{3/2}) u_1 - a_{3/2} u_2 = 0$.\n        *   The equation for $i=N-1$: $-a_{N-3/2} u_{N-2} + (a_{N-3/2} + a_{N-1/2}) u_{N-1} - a_{N-1/2} u_N = 0$. Since $u_N=1$, this becomes $-a_{N-3/2} u_{N-2} + (a_{N-3/2} + a_{N-1/2}) u_{N-1} = a_{N-1/2}$.\n\n    *   **Deriving Face Conductivity $a_{i+1/2}$**: This is the core of the problem.\n        *   The flux is $J = -a(x) u_x$. So, $u_x = -J/a(x)$.\n        *   Integrating from $x_i$ to $x_{i+1}$: $u_{i+1} - u_i = \\int_{x_i}^{x_{i+1}} u_x dx = - \\int_{x_i}^{x_{i+1}} \\frac{J(x)}{a(x)} dx$.\n        *   In our steady state 1D case, flux $J$ is constant between nodes. Let's assume it's constant over the cell face interval $[x_i, x_{i+1}]$, so $J(x) \\approx J_{i+1/2}$.\n        *   Then $u_{i+1} - u_i \\approx - J_{i+1/2} \\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)}$.\n        *   Rearranging, $J_{i+1/2} \\approx - \\frac{u_{i+1} - u_i}{\\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)}}$.\n        *   Comparing this to our finite difference form $J_{i+1/2} = - a_{i+1/2} \\frac{u_{i+1} - u_i}{h}$, we get:\n            $$ \\frac{a_{i+1/2}}{h} = \\frac{1}{\\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)}} $$\n            $$ a_{i+1/2} = \\frac{h}{\\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)}} $$\n        *   This is the harmonic average of $a(x)$ over the interval $[x_i, x_{i+1}]$. This is the physically consistent \"series resistance\" model. The integral of $1/a(x)$ is the total resistance over the segment. The flux is potential difference divided by total resistance.\n        *   Now, let's evaluate this integral for our piecewise constant $a(x)$.\n        *   The interface is at $x_c = 0.5$.\n        *   Case 1: The interval $[x_i, x_{i+1}]$ does not contain the interface $x_c$.\n            *   Then $a(x)$ is constant on the interval, either $1$ or $100$.\n            *   $\\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)} = \\frac{h}{a(\\text{value on interval})}$.\n            *   $a_{i+1/2} = \\frac{h}{h/a(\\text{value})} = a(\\text{value})$. This is just the material's conductivity.\n        *   Case 2: The interval $[x_i, x_{i+1}]$ contains the interface $x_c$. This happens when $x_i < x_c < x_{i+1}$.\n            *   The integral is: $\\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)} = \\int_{x_i}^{x_c} \\frac{dx}{a_{left}} + \\int_{x_c}^{x_{i+1}} \\frac{dx}{a_{right}} = \\frac{x_c - x_i}{a_{left}} + \\frac{x_{i+1} - x_c}{a_{right}}$.\n            *   Here $a_{left}=1$ and $a_{right}=100$.\n            *   The lengths of the sub-segments are $L_1 = x_c - x_i$ and $L_2 = x_{i+1} - x_c$. Note that $L_1+L_2 = h$.\n            *   $a_{i+1/2} = \\frac{h}{\\frac{L_1}{a_{left}} + \\frac{L_2}{a_{right}}} = \\frac{L_1+L_2}{\\frac{L_1}{a_{left}} + \\frac{L_2}{a_{right}}}$. This is the weighted harmonic mean. This is exactly what reasoning from series resistances would give: total resistance is $R_1+R_2$, where $R_k \\propto L_k/a_k$.\n        *   This provides the \"harmonic\" method for $a_{i+1/2}$.\n\n    *   **Naive Arithmetic Mean Construction**:\n        *   This method is given as $a_{i+1/2} = \\frac{a(x_i) + a(x_{i+1})}{2}$.\n        *   We need to evaluate $a(x)$ at the nodes. The problem defines $a(x)$ with a jump at $x=0.5$. What is $a(0.5)$? The problem says \"$a(x)=1$ for $x<0.5$ and $a(x)=100$ for $x>0.5$.\" The value at $x=0.5$ is not explicitly defined.\n        *   When a node $x_k$ falls exactly on $0.5$ (i.e., $k/N = 0.5$), what value should $a(x_k)$ take? The most common convention is to take an average, or a one-sided limit. Let's look at the cases.\n        *   Let's define $a(x)$ at nodes $x_i$ as: $a_i = a(x_i)$.\n            *   If $x_i < 0.5$, $a_i = 1$.\n            *   If $x_i > 0.5$, $a_i = 100$.\n            *   If $x_i = 0.5$, let's consider the physics. The pointwise value is not physically as meaningful as the average over a control volume. Let's use the definition given: $a(x)=1$ for $x<0.5$ and $a(x)=100$ for $x>0.5$. A reasonable convention for machine implementation is to use $a(x)=1$ for $x \\le 0.5$ and $a(x)=100$ for $x > 0.5$. Or the other way around. Or an average. Let's see if the choice matters for the arithmetic mean.\n            *   If a node $x_k = 0.5$, the face conductivity $a_{k-1/2}$ would involve $a(x_{k-1})$ and $a(x_k)$, and $a_{k+1/2}$ would involve $a(x_k)$ and $a(x_{k+1})$.\n            *   $a_{k-1/2} = (a(x_{k-1}) + a(x_k))/2 = (1 + a(0.5))/2$.\n            *   $a_{k+1/2} = (a(x_k) + a(x_{k+1}))/2 = (a(0.5) + 100)/2$.\n            *   The choice of $a(0.5)$ affects *two* face conductivities. A common choice is the arithmetic average: $a(0.5) = (1+100)/2 = 50.5$.\n            *   If I use the convention $a(x)=1$ for $x \\le 0.5$, then $a(0.5)=1$. So $a_{k-1/2} = (1+1)/2 = 1$ and $a_{k+1/2} = (1+100)/2 = 50.5$.\n            *   If I use the convention $a(x)=100$ for $x \\ge 0.5$, then $a(0.5)=100$. So $a_{k-1/2} = (1+100)/2 = 50.5$ and $a_{k+1/2} = (100+100)/2 = 100$.\n            *   The problem is to be \"meticulous and exacting\". The statement \"$a(x) = 1$ for $x < 0.5$, $a(x) = 100$ for $x > 0.5$\" leaves $a(0.5)$ undefined. This is a potential point of invalidity. However, the spirit of the problem is to compare a \"correct\" and a \"naive\" method. The naive arithmetic mean is already non-physical, so the specific choice at the discontinuity might not be the central point. I will adopt a reasonable convention: $a(x) = 1$ for $x \\le 0.5$ and $a(x) = 100$ for $x > 0.5$. This is just for evaluating the nodal conductivities $a_i$ used in the arithmetic mean. So $a(x_i) = 1$ if $x_i \\le 0.5$ and $a(x_i) = 100$ if $x_i > 0.5$. This seems like a reasonable, implementable interpretation. I will proceed under this assumption. Let's re-read the problem very carefully.\n            > \"...that simply averages neighboring pointwise conductivities.\"\n            This means $a_{i+1/2} = (a_i + a_{i+1})/2$ where $a_i = a(x_i)$. This confirms my interpretation. The ambiguity of $a(0.5)$ is still there. My choice seems defensible. I will proceed.\n\n3.  **Implementation Details**:\n    *   **Main function `solve()`**: Will iterate through the 4 test cases.\n    *   **Helper function for each case**: `compute_solution(N, method)`\n        *   **Grid Setup**: $h = 1/N$, $x = \\text{np.linspace}(0, 1, N+1)$.\n        *   **Conductivity setup**:\n            *   Create an array `a_nodes` for $a(x_i)$. My convention: `a_nodes = np.ones(N+1); a_nodes[x > 0.5] = 100`. Let's be careful with floating point comparisons. `x > 0.5 + epsilon`. A better way for grid $x_i = i/N$:\n                *   `i > 0.5 * N` means `a_i = 100`.\n                *   `i <= 0.5 * N` means `a_i = 1`.\n                *   This handles the case where $0.5N$ is an integer (node on interface) and when it's not.\n            *   Create an array `a_faces` of size $N$ for $a_{i+1/2}$. This will be populated based on `method`.\n        *   **Face Conductivity Calculation**:\n            *   `method == \"harmonic\"`:\n                *   Loop `i` from $0$ to $N-1$.\n                *   Check if the interface $x_c=0.5$ is in $[x_i, x_{i+1}]$.\n                *   This is true if $x_i \\le 0.5$ and $x_{i+1} > 0.5$.\n                *   If it is, calculate $L_1 = 0.5 - x_i$, $L_2 = x_{i+1} - 0.5$. $a_{face} = h / (L_1/1 + L_2/100)$.\n                *   If not, $a_{face}$ is just $1$ or $100$ depending on which side of $0.5$ the interval lies.\n            *   `method == \"arithmetic\"`:\n                *   Loop `i` from $0$ to $N-1$.\n                *   $a_{face} = (a_{nodes}[i] + a_{nodes}[i+1]) / 2$.\n        *   **Matrix Assembly**:\n            *   We need to solve for $u_1, ..., u_{N-1}$. This is a system of size $(N-1) \\times (N-1)$.\n            *   The equation for node $i$ (index $j=i-1$ in the matrix) is:\n                *   $-a_{i-1/2} u_{i-1} + (a_{i-1/2} + a_{i+1/2}) u_i - a_{i+1/2} u_{i+1} = 0$.\n            *   Create a matrix `A` (size `N-1` x `N-1`) and a vector `b` (size `N-1`).\n            *   `A` is tridiagonal.\n                *   Diagonal entries `A[j, j]`: $a_{i-1/2} + a_{i+1/2} = a_{faces}[i-1] + a_{faces}[i]$.\n                *   Super-diagonal `A[j, j+1]`: $-a_{i+1/2} = -a_{faces}[i]$.\n                *   Sub-diagonal `A[j, j-1]`: $-a_{i-1/2} = -a_{faces}[i-1]$.\n            *   Fill the `b` vector. It's mostly zeros.\n            *   The first equation ($i=1$, $j=0$) is affected by $u_0=0$: $(a_{1/2} + a_{3/2}) u_1 - a_{3/2} u_2 = 0$. This fits the general form since no term moves to RHS. `b[0]` is not affected unless I write it differently.\n                * Let's rewrite the system:\n                  $A_{jj} = a_{j+1/2} + a_{j+3/2}$ for my matrix index $j=0..N-2$. No, my face indices are $i+1/2$. Let's use grid indices $i$.\n                  The unknowns are $u_1, \\dots, u_{N-1}$. Let's call this vector `u_internal`.\n                  Equation for $u_i$: $-a_{i-1/2} u_{i-1} + (a_{i-1/2} + a_{i+1/2}) u_i - a_{i+1/2} u_{i+1} = 0$.\n                  For $i=1$: $-a_{1/2} u_0 + (a_{1/2} + a_{3/2}) u_1 - a_{3/2} u_2 = 0$. Since $u_0=0$, this is $(a_{1/2} + a_{3/2}) u_1 - a_{3/2} u_2 = 0$.\n                  For $i=N-1$: $-a_{N-3/2} u_{N-2} + (a_{N-3/2} + a_{N-1/2}) u_{N-1} - a_{N-1/2} u_N = 0$. Since $u_N=1$, this is $-a_{N-3/2} u_{N-2} + (a_{N-3/2} + a_{N-1/2}) u_{N-1} = a_{N-1/2}$. So, $b[N-2] = a_{N-1/2}$.\n            *   So, `A` is an $(N-1) \\times (N-1)$ matrix. `b` is an $(N-1)$ vector, all zeros except the last element.\n            *   Let's construct `A` using `np.diag`.\n                *   `main_diag = a_faces[0:N-1] + a_faces[1:N]`\n                *   `upper_diag = -a_faces[1:N-1]`\n                *   `lower_diag = -a_faces[1:N-1]`\n                *   `A = np.diag(main_diag) + np.diag(upper_diag, k=1) + np.diag(lower_diag, k=-1)`\n            *   Let's check the indices for `a_faces`. `a_faces` has length `N`. `a_faces[i]` is $a_{i+1/2}$.\n            *   Equation for $u_i$: coefficients for $u_{i-1}, u_i, u_{i+1}$ are $-a_{i-1/2}, (a_{i-1/2} + a_{i+1/2}), -a_{i+1/2}$.\n            *   Mapping to matrix index $j=i-1$. Unknowns are $u_1, \\dots, u_{N-1}$. The vector of unknowns is $\\mathbf{u} = [u_1, u_2, \\dots, u_{N-1}]^T$.\n            *   Row $j$ of matrix (for unknown $u_{j+1}$):\n                coeffs for $u_j, u_{j+1}, u_{j+2}$ are $-a_{j+1/2}, (a_{j+1/2} + a_{j+3/2}), -a_{j+3/2}$.\n            *   Matrix main diagonal (coeff of $u_{j+1}$): $a_{j+1/2} + a_{j+3/2} \\implies$ `a_faces[j] + a_faces[j+1]` for $j=0, \\dots, N-2$.\n            *   Matrix upper diagonal (coeff of $u_{j+2}$): $-a_{j+3/2} \\implies$ `-a_faces[j+1]` for $j=0, \\dots, N-3$.\n            *   Matrix lower diagonal (coeff of $u_j$): $-a_{j+1/2} \\implies$ `-a_faces[j]` for $j=1, \\dots, N-2$.\n            *   `main_diag = a_faces[0:N-1] + a_faces[1:N]`\n            *   `upper_diag = -a_faces[1:N-1]`\n            *   `lower_diag = -a_faces[0:N-2]` oops... let me re-check indices.\n            *   Equation for $u_i$: $-a_{i-1/2} u_{i-1} + (a_{i-1/2} + a_{i+1/2}) u_i - a_{i+1/2} u_{i+1}$.\n            *   Let matrix be $A_{jk}$ such that $\\sum_k A_{jk} u_k = b_j$. $j,k = 1, \\dots, N-1$.\n            *   For row $i$: $A_{i,i-1} = -a_{i-1/2}$, $A_{i,i} = a_{i-1/2} + a_{i+1/2}$, $A_{i,i+1} = -a_{i+1/2}$.\n            *   The matrix of the linear system for unknowns $u_1, ..., u_{N-1}$ is indexed from 1 to N-1. In python, from 0 to N-2.\n            *   Let python index be $j = i-1$. So $i=j+1$.\n            *   Main diagonal `diag_main[j] = A[j,j]` for $u_{j+1}$: $a_{j+1/2} + a_{j+3/2} \\equiv a_{faces}[j] + a_faces[j+1]$. This is for $j=0...N-2$, i.e. length $N-1$.\n            *   Upper diagonal `diag_upper[j] = A[j,j+1]` for $u_{j+2}$: $-a_{j+3/2} \\equiv -a_{faces}[j+1]$. This is for $j=0...N-3$, length $N-2$.\n            *   Lower diagonal `diag_lower[j] = A[j+1,j]` for $u_{j+1}$: $-a_{j+1/2} \\equiv -a_{faces}[j]$. This is for $j=0...N-3$, length $N-2$.\n            *   This seems right.\n            *   RHS vector `b`: All zeros, except for $i=N-1$ (python index $j=N-2$), where $b_{N-2} = a_{N-1/2} u_N = a_{N-1/2} \\cdot 1$. So `b[N-2] = a_faces[N-1]`.\n        *   **Solve System**: `u_internal = np.linalg.solve(A, b)`.\n        *   **Full Solution**: `u = np.concatenate(([0], u_internal, [1]))`.\n\n    *   **Post-processing**:\n        *   **Flux Continuity Metric $M$**:\n            *   Definition: $M = \\frac{|J_\\text{right} - J_\\text{left}|}{\\max(|J_\\text{right}|,|J_\\text{left}|)}$\n            *   $J_{i+1/2} = - a_{i+1/2} (u_{i+1} - u_i) / h$.\n            *   We need to find the faces immediately to the left and right of $x=0.5$.\n            *   Find index `k` such that $x_k \\le 0.5 < x_{k+1}$.\n                *   `k = floor(0.5 / h) = floor(0.5 * N)`.\n                *   If $0.5N$ is an integer (i.e., $N$ is even), then $x_k=0.5$ is a node. The problem says \"choose the pair of faces adjacent to $x=0.5$ according to whether $x=0.5$ equals a node or lies between two nodes\".\n                *   Case A: $N$ is odd. e.g., $N=101$. $0.5N = 50.5$. $k=50$. The interface $x=0.5$ lies in the interval $[x_{50}, x_{51}]$. The interface is on face $50+1/2$. The problem says \"immediately to the left and right of $x=0.5$\". This implies we want to compare flux across two different faces.\n                    * Let's take the face to the left of the interval containing the interface and the face to the right. So we compare $J_{k-1/2}$ and $J_{k+1/2}$? Or $J_{k+1/2}$ and $J_{k+3/2}$?\n                    * The question says \"the discrete face fluxes immediately to the left and right of $x=0.5$\".\n                    * If $x_k < 0.5 < x_{k+1}$, the face $k+1/2$ is the one straddling the interface. Let's call this face $F_{int}$. The face to its left is $F_{left} = k-1/2$, and to its right is $F_{right} = k+1/2$. Oh, wait. The faces are indexed $i+1/2$.\n                    * If $x_k < 0.5 < x_{k+1}$, the faces are indexed ... $k-1/2$, $k+1/2$, $k+3/2$, ...\n                    * The grid points are $x_0, x_1, \\dots, x_k, x_{k+1}, \\dots, x_N$.\n                    * The faces are $x_{1/2}, x_{3/2}, \\dots, x_{k-1/2}, x_{k+1/2}, x_{k+3/2}, \\dots$.\n                    * $J_{left}$ should be the flux on face $x_{k-1/2}$ and $J_{right}$ should be on face $x_{k+1/2}$? No, that doesn't make sense. The flux should be constant. The numerical scheme is designed to make $J_{i-1/2} = J_{i+1/2}$. The metric $M$ must be non-zero for the *incorrect* method.\n                    * Let's re-read: \"use the discrete solution to assess continuity of flux across the material interface at x=0.5\". For the *exact* solution, $J(x)$ is constant everywhere. So $J(0.5^-) = J(0.5^+)$. My computed discrete fluxes $J_{i+1/2}$ should be constant for the harmonic method. Let's check numerical precision.\n                    * Let's compute all face fluxes: `J_faces = -a_faces * np.diff(u) / h`. For the harmonic method, these should be nearly constant. For the arithmetic method, they will not be. `J_faces` has length `N`. `J_faces[i]` is $J_{i+1/2}$.\n                    * Now, which are $J_{left}$ and $J_{right}$?\n                    * Case A ($N$ is odd, e.g., $N=101$): $h=1/101$. $x_c=0.5$. `k = floor(0.5*101) = 50`. Interface is between $x_{50}$ and $x_{51}$. The faces are indexed from $1/2$ to $N-1/2$. The face indices are $i+1/2$, corresponding to `J_faces[i]`.\n                        * Face $49+1/2 = 49.5$ is between $x_{49}$ and $x_{50}$. $x_{50} = 50/101 \\approx 0.495 < 0.5$.\n                        * Face $50+1/2 = 50.5$ is between $x_{50}$ and $x_{51}$. $x_{51} = 51/101 \\approx 0.505 > 0.5$.\n                        * So the interface $x=0.5$ is between $x_{50}$ and $x_{51}$. This is the \"interface\" face. It corresponds to index $i=50$.\n                        * \"Fluxes immediately to the left and right of $x=0.5$\". This should be the flux in the material just left of $0.5$ and the flux in the material just right of $0.5$. The natural candidates are the fluxes on the faces just before and just after the interface.\n                        * So, $J_{left} = J_{49+1/2} = J_{faces}[49]$.\n                        * And $J_{right} = J_{50+1/2} = J_{faces}[50]$ (this is the value at the face crossing the interface) or $J_{51+1/2} = J_{faces}[51]$ (the value at the next face)?\n                        * The discrete conservation says $J_{i-1/2} = J_{i+1/2}$. So for the harmonic method, all $J_{i+1/2}$ will be identical (up to solver precision). Then $M=0$. This is the expected result.\n                        * For the arithmetic method, they won't be identical. The largest jump will be around the interface.\n                        * Let's pick $J_{left}$ to be the flux on the last face fully in material 1, and $J_{right}$ to be the flux on the first face fully in material 2.\n                        * With $k = \\lfloor 0.5 N \\rfloor$, the interface is between $x_k$ and $x_{k+1}$.\n                        * Face $k-1/2$, between $x_{k-1}$ and $x_k$, is entirely in region 1. $J_{left} = J_{k-1/2} = J_{faces}[k-1]$.\n                        * Face $k+1/2$, between $x_k$ and $x_{k+1}$, straddles the interface.\n                        * Face $k+3/2$, between $x_{k+1}$ and $x_{k+2}$, is entirely in region 2. $J_{right} = J_{k+3/2} = J_{faces}[k+2]$? No. Should be $J_{k+1/2}$.\n                        * The description says: \"immediately to the left and right of $x=0.5$\".\n                        * Let's say $k=\\lfloor 0.5N \\rfloor$. Interface is in cell $[x_k, x_{k+1}]$.\n                        * $J_{left}$ can be taken as $J_{k+1/2}$ and $J_{right}$ can also be taken as $J_{k+1/2}$. No, that gives $M=0$ always.\n                        * Let's take flux on face $k-1/2$ and $k+1/2$. No still doesn't feel right.\n                        * How about $J_{left}$ is the flux on the face left of the node $x_k$ (where $k \\approx 0.5N$) and $J_{right}$ is the flux on the face right of it? So we compare $J_{k-1/2}$ and $J_{k+1/2}$.\n                        * That seems plausible. The conservation law at node $k$ is $J_{k+1/2} - J_{k-1/2}=0$. The solver should satisfy this to machine precision. So $M$ would be 0 then. This metric must be for something else.\n                        * Let's re-read again. \"use the discrete solution to assess continuity of flux across the material interface at x=0.5\".\n                        * Okay, perhaps my interpretation of flux conservation $J_{i+1/2} - J_{i-1/2}=0$ is too literal. The *numerical* solution will satisfy this. But the quantity $J(x) = -a(x) u_x$ should be constant. The numerical approximation to this might not be.\n                        * Discrete flux is $J_{i+1/2} = - a_{i+1/2} (u_{i+1} - u_i) / h$. Let's calculate this vector for the solution.\n                        * Let's reconsider which fluxes to compare.\n                        * For $N=100$ (even), node $x_{50}$ is at $0.5$.\n                            * The region $x<0.5$ ends at face $49.5$. The region $x>0.5$ starts at face $50.5$.\n                            * So $J_{left} = J_{49.5}$, flux on face between $x_{49}, x_{50}$. This is `J_faces[49]`.\n                            * $J_{right} = J_{50.5}$, flux on face between $x_{50}, x_{51}$. This is `J_faces[50]`.\n                            * In this case, the logic seems clear. We are comparing fluxes on faces adjacent to the interface node.\n                        * For $N=101$ (odd), node $x_{50}$ is at $50/101 < 0.5$, node $x_{51}$ is at $51/101 > 0.5$.\n                            * The interface is between $x_{50}$ and $x_{51}$.\n                            * The face that straddles the interface is face $50.5$. The flux there is $J_{50.5}$.\n                            * \"fluxes immediately to the left and right\". It must mean the flux in the material to the left and right.\n                            * The flux expression is $J = -a u_x$.\n                            * In material 1 ($x<0.5$), the flux is $J_1 = -a_1 u_x = -1 \\cdot u_x$.\n                            * In material 2 ($x>0.5$), the flux is $J_2 = -a_2 u_x = -100 \\cdot u_x$.\n                            * The physical condition is $J_1 = J_2$.\n                            * The discrete flux $J_{i+1/2} = -a_{i+1/2} (u_{i+1}-u_i)/h$ is an approximation of the physical flux at the face center $x_{i+1/2}$.\n                            * For the harmonic method, the whole point is that these discrete fluxes are conserved, i.e., $J_{i+1/2}$ is constant for all $i$. So $J_{left} = J_{right}$ and $M=0$.\n                            * For the arithmetic method, they will not be constant. So we take two representative values near the interface.\n                            * Let's take the face immediately to the left of the interface-straddling-cell and the one immediately to its right.\n                            * If $k = \\lfloor 0.5 N \\rfloor$, the interface is between $x_k$ and $x_{k+1}$.\n                            * Face left: $x_{k-1/2}$, between $x_{k-1}$ and $x_k$. Index $k-1$. $J_{left} = J_{faces}[k-1]$.\n                            * Face right: $x_{k+3/2}$, between $x_{k+1}$ and $x_{k+2}$. Index $k+1$. $J_{right} = J_{faces}[k+1]$? NO. It's face with index `k+1`.\n                            * Face `i` is between `x_i` and `x_{i+1}`.\n                            * Let's trace:\n                                - Nodes: $x_0, x_1, ..., x_k, x_{k+1}, x_{k+2}, ...$\n                                - Interface is in $[x_k, x_{k+1}]$.\n                                - Face `k-1` is between $x_{k-1}, x_k$. It is entirely in medium 1.\n                                - Face `k` is between $x_k, x_{k+1}$. It straddles the interface.\n                                - Face `k+1` is between $x_{k+1}, x_{k+2}$. It is entirely in medium 2.\n                            * My previous logic: `J_left = J_faces[k-1], J_right = J_faces[k+1]`. This seems correct.\n                            * This requires $k-1 \\ge 0$ and $k+1 \\le N-1$.\n                            * $k-1 \\ge 0 \\implies k \\ge 1$. $k = \\text{searchsorted}-1$. $k \\ge 1$ requires there to be at least one node besides $x_0$ that is $\\le 0.5$. This is true for $N \\ge 2$.\n                            * $k+1 \\le N-1 \\implies k \\le N-2$. $k = \\text{searchsorted}-1 \\approx 0.5N$. So we need $0.5N \\le N-2 \\implies 2 \\le 0.5N \\implies N \\ge 4$.\n                            * So, this logic fails for $N=3$.\n                            * Let's re-run for $N=3$. $x = [0, 1/3, 2/3, 1]$. $x_{interface}=0.5$.\n                            * $k = \\text{searchsorted}(x, 0.5, 'right') - 1 = 2 - 1 = 1$. So `k=1`. $x_1 = 1/3 \\le 0.5$. `k` is correct.\n                            * The indices for fluxes are $J_{left}=J_{faces}[k-1] = J_{faces}[0]$ and $J_{right}=J_{faces}[k+1] = J_{faces}[2]$.\n                            * $J_{faces}$ has length $N=3$. Indices $0,1,2$.\n                            * So $J_{left}=J_{faces}[0]$ and $J_{right}=J_{faces}[2]$. This is valid for $N=3$.\n                            * The condition $N \\ge 3$ seems enough.\n                            * Okay, my initial worry was wrong.\n                            * This interpretation of using the computed `J_faces` for the metric M seems problematic as it always yields M=0 for any method.\n\nThe problem states to assess continuity of flux. The physical flux is $J(x) = -a(x) u_x$. A numerical solution $u_i$ allows us to approximate this physical flux.\n\nFor an interval $[x_i, x_{i+1}]$ located entirely in a region where $a(x)$ is constant (let's say $a_{mat}$), the physical flux in that region can be approximated by $-a_{mat} (u_{i+1}-u_i)/h$. This is different from the discrete flux $J_{i+1/2} = -a_{i+1/2} (u_{i+1}-u_i)/h$, especially for the arithmetic mean method where $a_{i+1/2}$ may not equal $a_{mat}$.\n\nThis distinction resolves the paradox. The finite difference system enforces the conservation of the *discrete* flux $J_{i+1/2}$ across nodes, i.e., $J_{i+1/2} = J_{i-1/2}$. The metric $M$, however, must assess the conservation of the *physical* flux, which is approximated using the material's actual conductivity.\n\n**Finalized Logic for Metric M:**\n1.  Find the index $k$ of the last grid node $x_k$ such that $x_k \\le 0.5$.\n2.  Select an interval entirely in the left material (conductivity $a_1=1$), e.g., $[x_{k-1}, x_k]$. The physical flux approximation here is $J_{left} = -a_1 \\frac{u_k - u_{k-1}}{h}$.\n3.  Select an interval entirely in the right material (conductivity $a_2=100$), e.g., $[x_{k+1}, x_{k+2}]$. The physical flux approximation here is $J_{right} = -a_2 \\frac{u_{k+2} - u_{k+1}}{h}$.\n4.  These intervals are guaranteed to exist for $N \\ge 3$.\n5.  Compute $M$ using these values of $J_{left}$ and $J_{right}$.\n\nThis approach correctly tests if the obtained potential profile $u_i$ is consistent with the physical law of constant flux across different materials. For the harmonic method, which produces the exact nodal potentials, $J_{left}$ and $J_{right}$ will be equal (to machine precision), yielding $M \\approx 0$. For the non-physical arithmetic method, they will differ, yielding a non-zero $M$. This is a consistent and rigorous interpretation.\n\nThe problem is **valid**. The minor ambiguity in defining $a(0.5)$ does not fundamentally undermine the problem, as it is only relevant to the \"naive\" method, and a standard convention can be applied. The core of the problem lies in deriving and comparing the physically consistent and naive methods.\n\n### Derivation and Solution Methodology\n\nThe governing equation for the steady-state potential $u(x)$ with heterogeneous conductivity $a(x)$ is derived from the conservation of charge, which states that the divergence of the current density (flux) $J$ is zero, $\\nabla \\cdot J = 0$. In one dimension, this is $J_x = 0$, implying $J(x)$ is constant. According to Ohm's law, the flux is proportional to the negative gradient of the potential, $J(x) = -a(x) u_x$, where $u_x = du/dx$. Combining these gives the differential equation:\n$$ -(a(x) u_x)_x = 0, \\quad x \\in (0,1) $$\nwith boundary conditions $u(0)=0$ and $u(1)=1$.\n\nWe will use a finite volume method, which is equivalent to a specific finite difference scheme for this problem and naturally enforces conservation. We discretize the domain $[0,1]$ into $N$ control volumes using $N+1$ nodes $x_i = i \\cdot h$ for $i=0, 1, \\dots, N$, where $h=1/N$ is the uniform grid spacing. For each interior node $x_i$, we define a control volume that extends from face $x_{i-1/2}$ to face $x_{i+1/2}$, where $x_{i \\pm 1/2} = (x_i + x_{i \\pm 1})/2$.\n\nIntegrating the governing equation over the control volume for node $i$:\n$$ \\int_{x_{i-1/2}}^{x_{i+1/2}} -(a(x) u_x)_x \\, dx = 0 $$\nBy the fundamental theorem of calculus, this becomes:\n$$ \\left[ -a(x) u_x \\right]_{x_{i-1/2}}^{x_{i+1/2}} = 0 \\implies J(x_{i+1/2}) - J(x_{i-1/2}) = 0 $$\nThis equation states that the flux entering the control volume at face $x_{i-1/2}$ must equal the flux leaving at face $x_{i+1/2}$. Let $J_{i+1/2}$ be the numerical approximation of the flux at face $x_{i+1/2}$. The discrete conservation law is $J_{i+1/2} = J_{i-1/2}$.\n\nTo obtain a physically consistent discretization, we must carefully define the face flux $J_{i+1/2}$. Integrating $u_x = -J(x)/a(x)$ from node $x_i$ to $x_{i+1}$:\n$$ u_{i+1} - u_i = \\int_{x_i}^{x_{i+1}} u_x \\, dx = -\\int_{x_i}^{x_{i+1}} \\frac{J(x)}{a(x)} \\, dx $$\nAssuming the flux $J(x)$ is approximately constant over the small interval $[x_i, x_{i+1}]$ and equal to the face flux $J_{i+1/2}$, we have:\n$$ u_{i+1} - u_i \\approx -J_{i+1/2} \\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)} \\implies J_{i+1/2} \\approx -\\frac{u_{i+1} - u_i}{\\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)}} $$\nWe also define the numerical flux using a finite difference approximation:\n$$ J_{i+1/2} = -a_{i+1/2} \\frac{u_{i+1} - u_i}{h} $$\nComparing the two expressions for $J_{i+1/2}$ yields the effective face conductivity $a_{i+1/2}$:\n$$ a_{i+1/2} = \\frac{h}{\\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)}} $$\nThis is the harmonic average of $a(x)$ over $[x_i, x_{i+1}]$. This approach is equivalent to modeling the segment as two resistors in series. The total resistance of the segment is the sum of the resistances of its sub-segments, which is precisely what the integral $\\int dx/a(x)$ represents.\n\nFor the piecewise constant conductivity $a(x) = a_1=1$ for $x<0.5$ and $a(x) = a_2=100$ for $x>0.5$, we evaluate $a_{i+1/2}$:\n1.  If the interval $[x_i, x_{i+1}]$ is entirely within one material, $a(x)$ is constant, and the integral gives $h/a_{mat}$, so $a_{i+1/2} = a_{mat}$.\n2.  If the interval $[x_i, x_{i+1}]$ straddles the interface at $x_c=0.5$, the integral becomes the sum of two parts:\n    $$ \\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)} = \\frac{x_c-x_i}{a_1} + \\frac{x_{i+1}-x_c}{a_2} $$\n    The effective conductivity is then $a_{i+1/2} = \\frac{h}{(x_c-x_i)/a_1 + (x_{i+1}-x_c)/a_2}$. This is the \"harmonic\" construction.\n\nThe \"arithmetic\" construction is a naive average of the nodal conductivity values: $a_{i+1/2} = (a(x_i) + a(x_{i+1}))/2$. For this, we adopt the convention that $a(x_i)=1$ if $x_i \\le 0.5$ and $a(x_i)=100$ if $x_i > 0.5$.\n\nWith the face conductivities defined, we assemble a linear system for the unknown interior potentials $u_1, \\dots, u_{N-1}$. The equation for each interior node $i \\in [1, N-1]$ is derived from $J_{i+1/2} - J_{i-1/2} = 0$:\n$$ -a_{i+1/2} \\frac{u_{i+1} - u_i}{h} - \\left(-a_{i-1/2} \\frac{u_i - u_{i-1}}{h}\\right) = 0 $$\n$$ -a_{i-1/2} u_{i-1} + (a_{i-1/2} + a_{i+1/2}) u_i - a_{i+1/2} u_{i+1} = 0 $$\nThe boundary conditions $u_0=0$ and $u_N=1$ modify the equations for $i=1$ and $i=N-1$. For $i=1$, the term with $u_0$ vanishes. For $i=N-1$, the term $-a_{N-1/2} u_N$ becomes a known value $-a_{N-1/2}$ which is moved to the right-hand side of the linear system. This forms a tridiagonal system $A \\mathbf{u} = \\mathbf{b}$, which can be solved for the vector of interior potentials $\\mathbf{u} = [u_1, \\dots, u_{N-1}]^T$.\n\nFinally, we compute the required metrics:\n1.  **Maximum Nodal Error $E_\\infty$**: The exact solution is piecewise linear: $u_{exact}(x) = (x/0.505)$ for $x \\le 0.5$ and $u_{exact}(x) = (0.5 + (x-0.5)/100)/0.505$ for $x > 0.5$. We compute $E_\\infty = \\max_i |u_{exact}(x_i) - u_{i}|$.\n2.  **Flux Continuity Metric $M$**: This metric assesses how well the numerical solution conserves the *physical* flux $J(x)=-a(x) u_x$ across the material interface. We approximate the physical flux in the material to the left of the interface, $J_{left}$, and to the right, $J_{right}$. We identify the last node $x_k$ before or at the interface ($x_k \\le 0.5$). We use the interval $[x_{k-1}, x_k]$ to compute $J_{left} = -a_1 (u_k-u_{k-1})/h$. We use the interval $[x_{k+1}, x_{k+2}]$ (the first full interval in the second material) to compute $J_{right} = -a_2 (u_{k+2}-u_{k+1})/h$. The metric is then $M = \\frac{|J_{right} - J_{left}|}{\\max(|J_{right}|, |J_{left}|)}$. For the physically consistent harmonic method, $M$ should be near zero, while for the naive arithmetic method, it will be significant.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function that runs test cases and prints the results.\n    \"\"\"\n\n    def get_analytical_solution(x_nodes):\n        \"\"\"\n        Computes the exact piecewise-linear solution at the given node locations.\n        \"\"\"\n        u_exact = np.zeros_like(x_nodes, dtype=float)\n        a1, a2 = 1.0, 100.0\n        x_interface = 0.5\n        \n        # Total equivalent resistance is the integral of 1/a(x) from 0 to 1.\n        # For a unit potential drop, the constant flux J = -1 / R_total.\n        R_total = (x_interface / a1) + ((1.0 - x_interface) / a2)\n        J = -1.0 / R_total\n        \n        # u(x) = u(0) - J * integral(1/a from 0 to x). Since u(0)=0.\n        # For x <= 0.5\n        mask_left = x_nodes <= x_interface\n        resistance_left = x_nodes[mask_left] / a1\n        u_exact[mask_left] = -J * resistance_left\n        \n        # For x > 0.5\n        mask_right = x_nodes > x_interface\n        resistance_right = (x_interface / a1) + (x_nodes[mask_right] - x_interface) / a2\n        u_exact[mask_right] = -J * resistance_right\n        \n        return u_exact\n\n    def compute_solution_metrics(N, method):\n        \"\"\"\n        Computes the numerical solution and associated metrics for a given N and method.\n        \"\"\"\n        h = 1.0 / N\n        x_nodes = np.linspace(0.0, 1.0, N + 1)\n        a1, a2 = 1.0, 100.0\n        x_interface = 0.5\n\n        # --- Step 1: Calculate face conductivities a_{i+1/2} ---\n        a_faces = np.zeros(N)\n        if method == \"harmonic\":\n            for i in range(N):\n                x_left, x_right = x_nodes[i], x_nodes[i+1]\n                # Check if face interval straddles the material interface\n                if x_left < x_interface and x_right > x_interface:\n                    l1 = x_interface - x_left\n                    l2 = x_right - x_interface\n                    # Weighted harmonic mean for series resistances\n                    a_faces[i] = h / (l1 / a1 + l2 / a2)\n                elif x_right <= x_interface:\n                    a_faces[i] = a1\n                else:  # x_left >= x_interface\n                    a_faces[i] = a2\n        elif method == \"arithmetic\":\n            a_nodes = np.full(N + 1, a1)\n            a_nodes[x_nodes > x_interface] = a2\n            for i in range(N):\n                a_faces[i] = (a_nodes[i] + a_nodes[i+1]) / 2.0\n        \n        # --- Step 2: Assemble and solve the linear system Au=b ---\n        num_unknowns = N - 1\n        if num_unknowns <= 0: # a trivial case like N=1\n             u_numerical = np.array([0.0, 1.0])\n        else:\n            # Diagonals for the tridiagonal matrix A\n            diag_main = a_faces[:-1] + a_faces[1:]\n            diag_upper = -a_faces[1:-1]\n            diag_lower = -a_faces[1:-1]\n            A = np.diag(diag_main) + np.diag(diag_upper, k=1) + np.diag(diag_lower, k=-1)\n            \n            # Right-hand side vector b\n            b = np.zeros(num_unknowns)\n            b[-1] = a_faces[-1] * 1.0 # Contribution from boundary condition u_N = 1\n            \n            # Solve for interior node potentials\n            u_internal = np.linalg.solve(A, b)\n            u_numerical = np.concatenate(([0.0], u_internal, [1.0]))\n\n        # --- Step 3: Calculate metrics M and E_infty ---\n        # Metric M: Flux continuity\n        # Find index k of the last node in the first material (x_k <= x_interface)\n        k = np.searchsorted(x_nodes, x_interface, side='right') - 1\n        \n        # J_left: physical flux in interval [x_{k-1}, x_k] (entirely in material 1)\n        grad_left = (u_numerical[k] - u_numerical[k-1]) / h\n        J_left = -a1 * grad_left\n        \n        # J_right: physical flux in interval [x_{k+1}, x_{k+2}] (entirely in material 2)\n        grad_right = (u_numerical[k+2] - u_numerical[k+1]) / h\n        J_right = -a2 * grad_right\n\n        denom = max(abs(J_left), abs(J_right))\n        M = 0.0 if denom < 1e-15 else abs(J_right - J_left) / denom\n        \n        # Metric E_infty: Maximum nodal error\n        u_exact = get_analytical_solution(x_nodes)\n        E_inf = np.max(np.abs(u_numerical - u_exact))\n\n        return [M, E_inf]\n\n    test_cases = [\n        (101, \"harmonic\"),\n        (100, \"harmonic\"),\n        (100, \"arithmetic\"),\n        (3, \"harmonic\")\n    ]\n\n    results = []\n    for N, method in test_cases:\n        metrics = compute_solution_metrics(N, method)\n        results.append(metrics)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Discretizing steady-state or implicit time-dependent problems in one dimension typically results in a structured system of linear equations that is tridiagonal. While a generic linear solver can be used, it is highly inefficient. This exercise  focuses on the derivation and implementation of the Thomas algorithm, a specialized and exceptionally efficient $O(N)$ method for solving tridiagonal systems, which is an essential tool for any computational scientist working with finite difference or finite element methods.",
            "id": "3914374",
            "problem": "Consider steady-state lithium-ion transport in the electrolyte phase across a one-dimensional separator of thickness $L$ in an automated battery design simulation. Under constant diffusivity $D$ and no volumetric consumption inside the separator, the steady lithium-ion concentration $c(x)$ satisfies the conservation law and Fickâ€™s first law: $\\frac{d}{dx}\\left( -D \\frac{dc}{dx} \\right) = 0$ and $j = -D \\frac{dc}{dx}$, where $j$ is the constant molar flux at the right boundary $x=L$. Discretize the domain $[0,L]$ with a uniform grid of $N$ interior nodes and spacing $h = \\frac{L}{N+1}$, placing the left Dirichlet boundary at $x=0$ with $c(0)=c_{0}$ and imposing a right Neumann boundary $-D \\frac{dc}{dx}\\big|_{x=L} = j$. Use a second-order central difference for interior nodes and a one-sided finite difference consistent with the Neumann boundary via a ghost node at $x=L+h$.\n\n1. Starting from the finite difference equations obtained from the above laws and discretization, write the resulting tridiagonal linear system for the unknowns $c_{1}, c_{2}, \\dots, c_{N}$ in the standard form $a_{i} c_{i-1} + b_{i} c_{i} + \\gamma_{i} c_{i+1} = d_{i}$, with the conventions $a_{1}=0$ and $\\gamma_{N}=0$ after eliminating the ghost node by the Neumann boundary condition. Then, derive from first principles (by specializing Gaussian elimination to tridiagonal matrices) the Thomas algorithm and present its forward elimination and back substitution steps in closed form for a general tridiagonal system of this type.\n\n2. Apply your derived Thomas algorithm to the specific separator case with $N=5$, $L=25 \\times 10^{-6}\\,\\text{m}$, $D=2.0 \\times 10^{-10}\\,\\text{m}^{2}\\,\\text{s}^{-1}$, $c_{0}=1000\\,\\text{mol}\\,\\text{m}^{-3}$, and $j=1.0 \\times 10^{-4}\\,\\text{mol}\\,\\text{m}^{-2}\\,\\text{s}^{-1}$. Compute the concentration at the third interior node $c_{3}$.\n\nRound your final numerical answer to four significant figures. Express the concentration in $\\text{mol}\\,\\text{m}^{-3}$.",
            "solution": "The problem statement is evaluated for validity before proceeding to a solution.\n\n### Step 1: Extract Givens\n- **Governing Equation**: $\\frac{d}{dx}\\left( -D \\frac{dc}{dx} \\right) = 0$, where diffusivity $D$ is constant.\n- **Flux Definition**: $j = -D \\frac{dc}{dx}$, where $j$ is the constant molar flux at $x=L$.\n- **Domain**: One-dimensional separator of thickness $L$, domain $[0,L]$.\n- **Grid**: Uniform grid with $N$ interior nodes. Grid spacing $h = \\frac{L}{N+1}$.\n- **Boundary Conditions**:\n    - Left ($x=0$): Dirichlet, $c(0)=c_{0}$.\n    - Right ($x=L$): Neumann, $-D \\frac{dc}{dx}\\big|_{x=L} = j$.\n- **Discretization Method**:\n    - Interior nodes: Second-order central difference.\n    - Right boundary: One-sided finite difference consistent with the Neumann boundary condition, using a ghost node at $x=L+h$.\n- **Linear System Form**: Tridiagonal system $a_{i} c_{i-1} + b_{i} c_{i} + c_{i} c_{i+1} = d_{i}$, with conventions $a_{1}=0$ and $c_{N}=0$.\n- **Task 1**: Derive the finite difference equations for the unknowns $c_{1}, \\dots, c_{N}$ and present the resulting linear system. Derive the Thomas algorithm from first principles for this system type.\n- **Task 2**: Apply the algorithm with parameters $N=5$, $L=25 \\times 10^{-6}\\,\\text{m}$, $D=2.0 \\times 10^{-10}\\,\\text{m}^{2}\\,\\text{s}^{-1}$, $c_{0}=1000\\,\\text{mol}\\,\\text{m}^{-3}$, and $j=1.0 \\times 10^{-4}\\,\\text{mol}\\,\\text{m}^{-2}\\,\\text{s}^{-1}$ to compute the concentration $c_{3}$.\n- **Output Format**: Final numerical answer rounded to four significant figures.\n\n### Step 2: Validate Using Extracted Givens\n- **Scientific Grounding**: The problem is scientifically grounded. It describes steady-state diffusion according to Fick's laws, a fundamental principle in transport phenomena, applied to a relevant context of lithium-ion battery simulation.\n- **Well-Posedness**: The one-dimensional second-order ordinary differential equation with one Dirichlet and one Neumann boundary condition is a well-posed problem, guaranteeing a unique and stable solution.\n- **Objectivity**: The problem is stated objectively. However, it contains a significant typo in the requested linear system form: \"$a_{i} c_{i-1} + b_{i} c_{i} + c_{i} c_{i+1} = d_{i}$\". The term \"$c_{i} c_{i+1}$\" would make the system nonlinear, which contradicts the description \"tridiagonal linear system\" and the linear nature of the governing PDE and discretization schemes. Furthermore, the problem later refers to \"$c_N=0$\", where $c_N$ must be a coefficient, not the unknown concentration. The clear intent is a standard linear tridiagonal form, which I will write as $a_{i} c_{i-1} + b_{i} c_{i} + \\gamma_{i} c_{i+1} = d_{i}$, where $\\gamma_i$ is the coefficient of $c_{i+1}$. The condition $c_N=0$ is interpreted as $\\gamma_N=0$.\n\n### Step 3: Verdict and Action\nThe problem is **valid**, contingent on the reasonable interpretation of a clear typo. The scientific and mathematical structure is sound. I will proceed with the solution.\n\n### Part 1: Derivation of the Linear System and Thomas Algorithm\n\nThe governing equation, with constant diffusivity $D$, simplifies to the Laplace equation in one dimension:\n$$ \\frac{d^2c}{dx^2} = 0 $$\nThe domain $[0, L]$ is discretized with nodes $x_i = i h$ for $i=0, 1, \\dots, N, N+1$, where $h = \\frac{L}{N+1}$, $x_0=0$, and $x_{N+1}=L$. The unknowns are the concentrations at the interior nodes, $c_i = c(x_i)$ for $i=1, 2, \\dots, N$. The value $c_0 = c(0)$ is given by the Dirichlet boundary condition.\n\n**Discretization at Interior Nodes ($i=1, \\dots, N-1$)**\nUsing a second-order central difference approximation for the second derivative at an interior node $x_i$:\n$$ \\frac{d^2c}{dx^2}\\bigg|_{x_i} \\approx \\frac{c_{i-1} - 2c_i + c_{i+1}}{h^2} $$\nSubstituting this into the governing equation gives:\n$$ \\frac{c_{i-1} - 2c_i + c_{i+1}}{h^2} = 0 \\implies c_{i-1} - 2c_i + c_{i+1} = 0 $$\nFor $i=1$, we use the known boundary value $c_0$:\n$$ c_0 - 2c_1 + c_2 = 0 \\implies -2c_1 + c_2 = -c_0 $$\n\n**Discretization at the Right Boundary (Node $N$)**\nFor node $i=N$, the central difference stencil involves $c_{N+1} = c(L)$, which is unknown. We must use the Neumann boundary condition, $-D \\frac{dc}{dx}\\big|_{x=L} = j$, via a ghost node at $x_{N+2} = L+h = x_{N+1}+h$.\nA second-order central difference for the derivative at the boundary node $x_{N+1} = L$ is:\n$$ \\frac{dc}{dx}\\bigg|_{x_{N+1}} \\approx \\frac{c_{N+2} - c_N}{2h} $$\nApplying the Neumann condition:\n$$ -D \\frac{c_{N+2} - c_N}{2h} = j \\implies c_{N+2} = c_N - \\frac{2hj}{D} $$\nTo eliminate the ghost node value $c_{N+2}$, we assume the governing PDE also holds at the boundary node $x_{N+1}$:\n$$ \\frac{d^2c}{dx^2}\\bigg|_{x_{N+1}} \\approx \\frac{c_N - 2c_{N+1} + c_{N+2}}{h^2} = 0 \\implies c_N - 2c_{N+1} + c_{N+2} = 0 $$\nSubstituting the expression for $c_{N+2}$:\n$$ c_N - 2c_{N+1} + \\left(c_N - \\frac{2hj}{D}\\right) = 0 \\implies 2c_N - 2c_{N+1} = \\frac{2hj}{D} \\implies c_{N+1} = c_N - \\frac{hj}{D} $$\nNow, we substitute this expression for $c_{N+1}$ into the discretized PDE at node $i=N$:\n$$ c_{N-1} - 2c_N + c_{N+1} = 0 \\implies c_{N-1} - 2c_N + \\left(c_N - \\frac{hj}{D}\\right) = 0 $$\n$$ c_{N-1} - c_N = \\frac{hj}{D} $$\n\n**The Tridiagonal Linear System**\nThe system of $N$ linear equations for the unknowns $c_1, \\dots, c_N$ is:\n$$ -2c_1 + c_2 = -c_0 \\quad (i=1) $$\n$$ c_{i-1} - 2c_i + c_{i+1} = 0 \\quad (i=2, \\dots, N-1) $$\n$$ c_{N-1} - c_N = \\frac{hj}{D} \\quad (i=N) $$\nThis system can be written in the form $a_{i} c_{i-1} + b_{i} c_{i} + \\gamma_{i} c_{i+1} = d_{i}$, where I use $\\gamma_i$ for the coefficient of $c_{i+1}$ to resolve the typo in the problem statement. The coefficients are:\n- For $i=1$: $a_1 = 0$, $b_1 = -2$, $\\gamma_1 = 1$, $d_1 = -c_0$.\n- For $i=2, \\dots, N-1$: $a_i = 1$, $b_i = -2$, $\\gamma_i = 1$, $d_i = 0$.\n- For $i=N$: $a_N = 1$, $b_N = -1$, $\\gamma_N = 0$, $d_N = \\frac{hj}{D}$.\nThe conditions $a_1=0$ and $\\gamma_N=0$ are met.\n\n**Derivation of the Thomas Algorithm**\nThe Thomas algorithm is a specialized form of Gaussian elimination for a general tridiagonal system $a_{i} c_{i-1} + b_{i} c_{i} + \\gamma_{i} c_{i+1} = d_{i}$ for $i=1, \\dots, N$, with $a_1=0$ and $\\gamma_N=0$.\n\n**Forward Elimination:** The goal is to transform the system into an upper bidiagonal form by eliminating the subdiagonal elements $a_i$. We seek a transformed system of the form $c_i + \\gamma'_i c_{i+1} = d'_i$.\nFor $i=1$, the equation is $b_1 c_1 + \\gamma_1 c_2 = d_1$. Dividing by $b_1$ gives:\n$c_1 + \\frac{\\gamma_1}{b_1} c_2 = \\frac{d_1}{b_1}$.\nThus, we define $\\gamma'_1 = \\frac{\\gamma_1}{b_1}$ and $d'_1 = \\frac{d_1}{b_1}$.\n\nFor $i > 1$, assume we have the transformed equation from the previous step: $c_{i-1} + \\gamma'_{i-1} c_i = d'_{i-1}$, which can be rewritten as $c_{i-1} = d'_{i-1} - \\gamma'_{i-1} c_i$.\nThe original equation for row $i$ is $a_i c_{i-1} + b_i c_i + \\gamma_i c_{i+1} = d_i$.\nSubstitute the expression for $c_{i-1}$:\n$a_i (d'_{i-1} - \\gamma'_{i-1} c_i) + b_i c_i + \\gamma_i c_{i+1} = d_i$\nRearranging terms with $c_i$:\n$(b_i - a_i \\gamma'_{i-1}) c_i + \\gamma_i c_{i+1} = d_i - a_i d'_{i-1}$\nDividing by the new coefficient of $c_i$:\n$c_i + \\frac{\\gamma_i}{b_i - a_i \\gamma'_{i-1}} c_{i+1} = \\frac{d_i - a_i d'_{i-1}}{b_i - a_i \\gamma'_{i-1}}$\nThis gives the recurrence relations for the modified coefficients:\n$\\gamma'_i = \\frac{\\gamma_i}{b_i - a_i \\gamma'_{i-1}}$ and $d'_i = \\frac{d_i - a_i d'_{i-1}}{b_i - a_i \\gamma'_{i-1}}$ for $i > 1$.\n\nThe forward elimination process is:\n1. $\\gamma'_1 = \\frac{\\gamma_1}{b_1}$; $d'_1 = \\frac{d_1}{b_1}$.\n2. For $i=2, \\dots, N-1$:\n   $\\gamma'_i = \\frac{\\gamma_i}{b_i - a_i \\gamma'_{i-1}}$\n   $d'_i = \\frac{d_i - a_i d'_{i-1}}{b_i - a_i \\gamma'_{i-1}}$\n\n**Back Substitution:** After forward elimination, the last equation involves only $c_N$. At $i=N$, $\\gamma_N=0$, so $\\gamma'_N=0$. The transformed equation is $c_N = d'_N$. The original equation for $i=N$ is $a_N c_{N-1} + b_N c_N = d_N$. Using the expression for $c_{N-1} = d'_{N-1} - \\gamma'_{N-1} c_N$:\n$a_N (d'_{N-1} - \\gamma'_{N-1} c_N) + b_N c_N = d_N$\n$(b_N - a_N \\gamma'_{N-1}) c_N = d_N - a_N d'_{N-1}$\n$c_N = \\frac{d_N - a_N d'_{N-1}}{b_N - a_N \\gamma'_{N-1}}$.\nOnce $c_N$ is known, we can find the other variables by substituting backwards into the transformed equations $c_i = d'_i - \\gamma'_i c_{i+1}$.\n\nThe back substitution process is:\n1. $c_N = \\frac{d_N - a_N d'_{N-1}}{b_N - a_N \\gamma'_{N-1}}$.\n2. For $i = N-1, N-2, \\dots, 1$:\n   $c_i = d'_i - \\gamma'_i c_{i+1}$.\n\n### Part 2: Application of the Thomas Algorithm\n\nWe apply the derived algorithm for the given parameters: $N=5$, $L=25 \\times 10^{-6}\\,\\text{m}$, $D=2.0 \\times 10^{-10}\\,\\text{m}^{2}\\,\\text{s}^{-1}$, $c_{0}=1000\\,\\text{mol}\\,\\text{m}^{-3}$, and $j=1.0 \\times 10^{-4}\\,\\text{mol}\\,\\text{m}^{-2}\\,\\text{s}^{-1}$.\n\nFirst, calculate the grid spacing $h$:\n$$ h = \\frac{L}{N+1} = \\frac{25 \\times 10^{-6}}{5+1} = \\frac{25}{6} \\times 10^{-6}\\,\\text{m} $$\nThe coefficients of the $5 \\times 5$ linear system are:\n- $i=1$: $a_1=0, b_1=-2, \\gamma_1=1, d_1=-c_0 = -1000$.\n- $i=2,3,4$: $a_i=1, b_i=-2, \\gamma_i=1, d_i=0$.\n- $i=5$: $a_5=1, b_5=-1, \\gamma_5=0, d_5=\\frac{hj}{D} = \\frac{(\\frac{25}{6} \\times 10^{-6})(1.0 \\times 10^{-4})}{2.0 \\times 10^{-10}} = \\frac{25 \\times 10^{-10}}{12 \\times 10^{-10}} = \\frac{25}{12}$.\n\n**Forward Elimination:**\n- $i=1$:\n   $\\gamma'_1 = \\frac{\\gamma_1}{b_1} = \\frac{1}{-2} = -0.5$\n   $d'_1 = \\frac{d_1}{b_1} = \\frac{-1000}{-2} = 500$\n- $i=2$:\n   $\\gamma'_2 = \\frac{\\gamma_2}{b_2 - a_2 \\gamma'_1} = \\frac{1}{-2 - 1(-0.5)} = \\frac{1}{-1.5} = -\\frac{2}{3}$\n   $d'_2 = \\frac{d_2 - a_2 d'_1}{b_2 - a_2 \\gamma'_1} = \\frac{0 - 1(500)}{-1.5} = \\frac{1000}{3}$\n- $i=3$:\n   $\\gamma'_3 = \\frac{\\gamma_3}{b_3 - a_3 \\gamma'_2} = \\frac{1}{-2 - 1(-\\frac{2}{3})} = \\frac{1}{-\\frac{4}{3}} = -\\frac{3}{4}$\n   $d'_3 = \\frac{d_3 - a_3 d'_2}{b_3 - a_3 \\gamma'_2} = \\frac{0 - 1(\\frac{1000}{3})}{-\\frac{4}{3}} = \\frac{1000}{4} = 250$\n- $i=4$:\n   $\\gamma'_4 = \\frac{\\gamma_4}{b_4 - a_4 \\gamma'_3} = \\frac{1}{-2 - 1(-\\frac{3}{4})} = \\frac{1}{-\\frac{5}{4}} = -\\frac{4}{5}$\n   $d'_4 = \\frac{d_4 - a_4 d'_3}{b_4 - a_4 \\gamma'_3} = \\frac{0 - 1(250)}{-\\frac{5}{4}} = \\frac{1000}{5} = 200$\n\n**Back Substitution:**\nFirst, compute $c_5$:\n$$ c_5 = \\frac{d_5 - a_5 d'_4}{b_5 - a_5 \\gamma'_4} = \\frac{\\frac{25}{12} - 1(200)}{-1 - 1(-\\frac{4}{5})} = \\frac{\\frac{25-2400}{12}}{-\\frac{1}{5}} = \\frac{-\\frac{2375}{12}}{-\\frac{1}{5}} = \\frac{2375 \\times 5}{12} = \\frac{11875}{12} $$\nNext, compute $c_4$ to find $c_3$:\n$$ c_4 = d'_4 - \\gamma'_4 c_5 = 200 - (-\\frac{4}{5})\\left(\\frac{11875}{12}\\right) = 200 + \\frac{4 \\times 11875}{5 \\times 12} = 200 + \\frac{11875}{15} = 200 + \\frac{2375}{3} = \\frac{600+2375}{3} = \\frac{2975}{3} $$\nFinally, compute $c_3$:\n$$ c_3 = d'_3 - \\gamma'_3 c_4 = 250 - (-\\frac{3}{4})\\left(\\frac{2975}{3}\\right) = 250 + \\frac{3 \\times 2975}{4 \\times 3} = 250 + \\frac{2975}{4} = \\frac{1000+2975}{4} = \\frac{3975}{4} = 993.75 $$\nThe problem asks for the answer to be rounded to four significant figures.\n$$ c_3 = 993.75 \\approx 993.8 $$\nThe unit for concentration is $\\text{mol}\\,\\text{m}^{-3}$.\nThe analytical solution for this problem is $c(x) = c_0 - \\frac{j}{D}x$. The numerical method is exact for this linear profile, and the computed value of $c_3 = c(3h) = 1000 - \\frac{10^{-4}}{2 \\times 10^{-10}} \\times 3 \\times \\frac{25 \\times 10^{-6}}{6} = 1000 - 6.25 = 993.75$ confirms the correctness of the result.",
            "answer": "$$\\boxed{993.8}$$"
        },
        {
            "introduction": "After implementing a numerical scheme, how can you be confident that your code is correct? This practice  introduces the Method of Manufactured Solutions (MMS), a rigorous technique for code verification. You will implement the Crank-Nicolson scheme and use a pre-defined \"manufactured\" solution to confirm that your code achieves its theoretical second-order accuracy, providing a powerful methodology for debugging and validating scientific software.",
            "id": "3914357",
            "problem": "Consider one-dimensional diffusion of Lithium-ion concentration in an electrolyte slab, a standard simplification used in automated battery design and simulation. The governing Partial Differential Equation (PDE) is Fickâ€™s second law in one spatial dimension, given by $u_t = \\alpha u_{xx}$ on the spatial domain $x \\in [0,L]$ and time interval $t \\in [0,T]$, where $u(x,t)$ is concentration, $\\alpha$ is the diffusion coefficient, $L$ is the slab thickness, and $T$ is the final time. In this problem, use a Manufactured Solution (MS) to validate the temporal accuracy of the Crankâ€“Nicolson (CN) scheme, which is a second-order implicit time-stepping method.\n\nYou must construct the test so that spatial discretization error is negligible compared to temporal error. To achieve this, use a sufficiently fine spatial grid. Define the Manufactured Solution\n$$\nu(x,t) = \\cos\\!\\left(\\frac{2\\pi x}{L}\\right)\\exp(-\\gamma t),\n$$\nwith\n$$\n\\gamma = \\alpha\\left(\\frac{2\\pi}{L}\\right)^2.\n$$\nThis choice ensures $u_t = \\alpha u_{xx}$ holds exactly, so no source term is needed. Impose Dirichlet boundary conditions consistent with the Manufactured Solution, namely $u(0,t) = \\exp(-\\gamma t)$ and $u(L,t) = \\exp(-\\gamma t)$, and the initial condition $u(x,0) = \\cos\\!\\left(\\frac{2\\pi x}{L}\\right)$.\n\nDiscretize space with a uniform grid using second-order central differences for $u_{xx}$, and discretize time with the Crankâ€“Nicolson method. For interior grid indices $j$ and time steps $n$, the CN update is\n$$\n\\frac{u_j^{n+1} - u_j^n}{\\Delta t} = \\alpha\\frac{1}{2}\\left[\\frac{u_{j+1}^{n+1} - 2u_j^{n+1} + u_{j-1}^{n+1}}{\\Delta x^2} + \\frac{u_{j+1}^{n} - 2u_j^{n} + u_{j-1}^{n}}{\\Delta x^2}\\right],\n$$\nwhere $\\Delta x$ and $\\Delta t$ are the spatial and temporal step sizes, respectively. Use the exact boundary values at each time level for $j=0$ and $j=J$ (with $J$ the index of the right boundary), so boundary contributions are treated as known values during assembly of the linear system at each CN step.\n\nTo assess temporal accuracy, compute the discrete $\\mathrm{L}^2$ error at final time $t = T$ over the interior nodes,\n$$\nE(\\Delta t) = \\sqrt{\\Delta x\\sum_{j=1}^{J-1}\\left(u_j^{\\text{num}}(T) - u(x_j,T)\\right)^2},\n$$\nwhere $u_j^{\\text{num}}(T)$ is the numerical solution at the interior grid points, and $u(x_j,T)$ is the exact Manufactured Solution evaluated at those points. Estimate the observed order of accuracy $p$ in time by performing a least-squares fit to the model $\\log E(\\Delta t) = p \\log \\Delta t + C$, for some constant $C$, using several refinements of $\\Delta t$ while keeping $\\Delta x$ fixed and sufficiently small to render spatial error negligible.\n\nYour program must implement the above and compute $p$ for each test case defined below. The spatial and temporal discretizations are dimensioned with physical units to reflect a battery-relevant regime; however, the final reported observed orders $p$ are dimensionless. All quantities that carry physical units must be used consistently as specified, but the final outputs should be unitless floating-point numbers.\n\nUse the following test suite, which is designed to cover typical behavior, a stiffer regime, and a coarser spatial grid edge case:\n- Test case $1$ (baseline): $L = 1\\times 10^{-4}\\,\\text{m}$, $\\alpha = 1\\times 10^{-10}\\,\\text{m}^2/\\text{s}$, $T = 1\\times 10^{-1}\\,\\text{s}$, number of spatial grid points $N_x = 401$ (including boundaries), and the temporal refinements $\\Delta t \\in \\{1.25\\times 10^{-2}, 6.25\\times 10^{-3}, 3.125\\times 10^{-3}, 1.5625\\times 10^{-3}\\}\\,\\text{s}$.\n- Test case $2$ (stiffer diffusion): $L = 1\\times 10^{-4}\\,\\text{m}$, $\\alpha = 5\\times 10^{-10}\\,\\text{m}^2/\\text{s}$, $T = 1\\times 10^{-1}\\,\\text{s}$, $N_x = 401$, and the same temporal refinements as test case $1$.\n- Test case $3$ (coarser spatial grid edge case): $L = 1\\times 10^{-4}\\,\\text{m}$, $\\alpha = 1\\times 10^{-10}\\,\\text{m}^2/\\text{s}$, $T = 1\\times 10^{-1}\\,\\text{s}$, $N_x = 101$, and the same temporal refinements as test case $1$.\n\nFor each test case, compute the observed order $p$ as a single float using the linear regression on $(\\log \\Delta t, \\log E(\\Delta t))$ across all specified $\\Delta t$ values. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of test cases $1$, $2$, and $3$ (e.g., $[p_1,p_2,p_3]$). The outputs $p_1$, $p_2$, and $p_3$ must be floating-point numbers with no units. The angle unit is not relevant to this problem. Percentages are not applicable; report only floating-point values.",
            "solution": "The objective of this problem is to numerically verify the temporal order of accuracy for the Crank-Nicolson (CN) scheme applied to the one-dimensional diffusion equation. This is achieved using the Method of Manufactured Solutions (MMS), a rigorous technique in code verification. The governing partial differential equation (PDE) for the concentration $u(x,t)$ is Fick's second law:\n$$\n\\frac{\\partial u}{\\partial t} = \\alpha \\frac{\\partial^2 u}{\\partial x^2}\n$$\nThis equation is defined on the spatial domain $x \\in [0, L]$ and for time $t \\in [0, T]$. The parameter $\\alpha$ is the diffusion coefficient.\n\nThe Crank-Nicolson scheme is a finite difference method that is second-order accurate in both time and space. It is derived by averaging the spatial derivative term at the current time level $n$ and the future time level $n+1$. For a uniform spatial grid with spacing $\\Delta x$ and a uniform temporal grid with step size $\\Delta t$, the discretization of the PDE at interior spatial node $j$ is given by:\n$$\n\\frac{u_j^{n+1} - u_j^n}{\\Delta t} = \\frac{\\alpha}{2} \\left( \\frac{u_{j+1}^{n+1} - 2u_j^{n+1} + u_{j-1}^{n+1}}{\\Delta x^2} + \\frac{u_{j+1}^{n} - 2u_j^{n} + u_{j-1}^{n}}{\\Delta x^2} \\right)\n$$\nwhere $u_j^n \\approx u(x_j, t_n)$. To simplify this expression, we introduce the non-dimensional diffusion number $\\lambda = \\frac{\\alpha \\Delta t}{2 \\Delta x^2}$. We then rearrange the equation to group all unknown terms (at time level $n+1$) on the left-hand side (LHS) and all known terms (at time level $n$) on the right-hand side (RHS):\n$$\n-\\lambda u_{j-1}^{n+1} + (1+2\\lambda) u_j^{n+1} - \\lambda u_{j+1}^{n+1} = \\lambda u_{j-1}^{n} + (1-2\\lambda) u_j^n + \\lambda u_{j+1}^{n}\n$$\nThis equation is formulated for all interior grid points, i.e., for $j = 1, 2, \\dots, J-1$, where $J$ is the index of the right-most grid point $x_J = L$. This constitutes a system of $J-1$ linear equations for the $J-1$ unknown interior concentrations at time $t_{n+1}$.\n\nThe system of equations can be written in matrix form as $A \\mathbf{u}_{\\text{int}}^{n+1} = \\mathbf{b}^n$, where $\\mathbf{u}_{\\text{int}}^{n+1}$ is the vector of unknown concentrations at ahe interior nodes, $[u_1^{n+1}, u_2^{n+1}, \\dots, u_{J-1}^{n+1}]^T$. The matrix $A$ is a tridiagonal matrix with $(1+2\\lambda)$ on the main diagonal and $-\\lambda$ on the sub- and super-diagonals.\nThe problem specifies Dirichlet boundary conditions, $u(0,t)$ and $u(L,t)$, which are known functions of time. At each time step, the boundary values $u_0^{n+1}$ and $u_J^{n+1}$ are known. These terms from the LHS of the equations for $j=1$ and $j=J-1$ are moved to the RHS. The resulting RHS vector $\\mathbf{b}^n$ is constructed from the solution at the previous time step, $\\mathbf{u}^n$, and the known boundary values at $t_n$ and $t_{n+1}$. As the matrix $A$ is constant throughout the simulation, it is constructed once. At each time step, the RHS vector $\\mathbf{b}^n$ is computed, and the tridiagonal system is solved efficiently to find the solution at the next time step.\n\nTo verify the temporal accuracy, we employ the Manufactured Solution (MS):\n$$\nu(x,t) = \\cos\\left(\\frac{2\\pi x}{L}\\right)\\exp(-\\gamma t) \\quad \\text{with} \\quad \\gamma = \\alpha\\left(\\frac{2\\pi}{L}\\right)^2\n$$\nThis function is constructed to be an exact solution to the PDE, $u_t = \\alpha u_{xx}$. This MS is used to derive consistent initial and boundary conditions for the numerical simulation:\n- Initial Condition: $u(x,0) = \\cos\\left(\\frac{2\\pi x}{L}\\right)$\n- Boundary Conditions: $u(0,t) = u(L,t) = \\exp(-\\gamma t)$\n\nThe numerical simulation is run from $t=0$ to a final time $T$. The resulting numerical solution, $u_j^{\\text{num}}(T)$, is then compared to the exact manufactured solution, $u(x_j,T)$. The error is quantified using the discrete $L^2$ norm over the interior nodes:\n$$\nE(\\Delta t) = \\sqrt{\\Delta x \\sum_{j=1}^{J-1} \\left(u_j^{\\text{num}}(T) - u(x_j,T)\\right)^2}\n$$\nFor a method with a temporal order of accuracy $p$, the error is expected to behave as $E(\\Delta t) \\approx C(\\Delta t)^p$ for some constant $C$, provided that spatial error is negligible. By taking the logarithm of this relationship, we obtain a linear equation:\n$$\n\\log E(\\Delta t) \\approx \\log C + p \\log \\Delta t\n$$\nThe observed order of accuracy $p$ can be determined as the slope of a line fitted to data points of $(\\log \\Delta t, \\log E)$ for a sequence of simulations with decreasing time step sizes $\\Delta t$.\n\nThe overall algorithm proceeds as follows for each test case:\n$1$. Initialize physical and numerical parameters ($L$, $\\alpha$, $T$, $N_x$, and a set of $\\Delta t$ values). The spatial grid is fixed.\n$2$. For each $\\Delta t$ in the set:\n    a. Set the initial condition using the MS at $t=0$.\n    b. Construct the constant tridiagonal LHS matrix $A$.\n    c. Time-step from $t=0$ to $t=T$. In each step, compute the RHS vector $\\mathbf{b}^n$ and solve the linear system for the solution at the next time step.\n    d. At $t=T$, compute the discrete $L^2$ error $E(\\Delta t)$ by comparing the numerical solution to the MS.\n$3$. Collect the pairs $(\\log \\Delta t, \\log E(\\Delta t))$ for all simulations.\n$4$. Perform a linear least-squares regression on these data points to find the slope, which is the observed order of accuracy $p$.\nThis procedure is repeated for each of the three specified test cases, which explore different diffusion regimes and grid resolutions. The problem is designed such that the spatial grid is fine enough in the first two cases for a clean measurement of the temporal order, which is theoretically $p=2$ for the Crank-Nicolson scheme. The third case uses a coarser grid to investigate the potential for spatial error to contaminate the measurement.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import solve_banded\n\ndef compute_order_p(L, alpha, T, Nx, dt_values):\n    \"\"\"\n    Computes the observed temporal order of accuracy for the Crank-Nicolson scheme.\n\n    Args:\n        L (float): Length of the spatial domain.\n        alpha (float): Diffusion coefficient.\n        T (float): Final time.\n        Nx (int): Number of spatial grid points.\n        dt_values (list): List of time step sizes for convergence study.\n\n    Returns:\n        float: The observed order of accuracy, p.\n    \"\"\"\n    # 1. Derived constants and spatial grid setup\n    gamma = alpha * (2 * np.pi / L)**2\n    \n    J = Nx - 1\n    dx = L / J\n    x_coords = np.linspace(0, L, Nx)\n    num_interior_points = Nx - 2\n    \n    log_errors = []\n    log_dts = np.log(np.array(dt_values))\n\n    # Define the Manufactured Solution (MS)\n    def u_exact(x, t):\n        return np.cos(2 * np.pi * x / L) * np.exp(-gamma * t)\n\n    # 2. Loop through each time step size to collect error data\n    for dt in dt_values:\n        # Simulation parameters for the current refinement\n        Nt = int(round(T / dt))\n        lam = alpha * dt / (2 * dx**2)  # Crank-Nicolson parameter\n        \n        # Initial condition from MS at t=0\n        t_current = 0.0\n        u_current = u_exact(x_coords, t_current)\n        \n        # LHS matrix A, in banded format for scipy.linalg.solve_banded\n        # It is constant for all time steps.\n        A_banded = np.zeros((3, num_interior_points))\n        A_banded[0, 1:] = -lam      # Upper diagonal (u_{j+1})\n        A_banded[1, :] = 1 + 2 * lam # Main diagonal (u_j)\n        A_banded[2, :-1] = -lam     # Lower diagonal (u_{j-1})\n        \n        # 3. Time-stepping loop\n        for n in range(Nt):\n            t_next = (n + 1) * dt\n            \n            # Known boundary values at the next time step from MS\n            u0_next = np.exp(-gamma * t_next) # u at x=0\n            uL_next = np.exp(-gamma * t_next) # u at x=L\n\n            # Construct the RHS vector b\n            # Start with the known stencil application on u_current\n            b = lam * u_current[0:-2] + \\\n                (1 - 2 * lam) * u_current[1:-1] + \\\n                lam * u_current[2:]\n            \n            # Add boundary contributions from the implicit part (LHS)\n            b[0] += lam * u0_next\n            b[-1] += lam * uL_next\n            \n            # Solve the tridiagonal system for interior points at t_next\n            u_interior_next = solve_banded((1, 1), A_banded, b)\n            \n            # Update the full solution vector for the next iteration\n            u_current[1:-1] = u_interior_next\n            u_current[0] = u0_next\n            u_current[-1] = uL_next\n            \n        # 4. At final time T, compute the L2 error\n        u_numerical_T = u_current\n        u_exact_T = u_exact(x_coords, T)\n        \n        # Error is computed over interior nodes only\n        diff_interior = u_numerical_T[1:-1] - u_exact_T[1:-1]\n        error = np.sqrt(dx * np.sum(diff_interior**2))\n        log_errors.append(np.log(error))\n\n    # 5. Perform linear regression on (log(dt), log(E)) to find the slope p\n    # np.polyfit with deg=1 returns [slope, intercept]\n    p, _ = np.polyfit(log_dts, log_errors, 1)\n    \n    return p\n\ndef solve():\n    \"\"\"\n    Main function to run the test cases and print the results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    dt_refinements = [1.25e-2, 6.25e-3, 3.125e-3, 1.5625e-3]\n    \n    test_cases = [\n        # (L, alpha, T, Nx, dt_values)\n        (1e-4, 1e-10, 1e-1, 401, dt_refinements),  # Case 1: Baseline\n        (1e-4, 5e-10, 1e-1, 401, dt_refinements),  # Case 2: Stiffer diffusion\n        (1e-4, 1e-10, 1e-1, 101, dt_refinements),  # Case 3: Coarser spatial grid\n    ]\n\n    results = []\n    for case_params in test_cases:\n        p = compute_order_p(*case_params)\n        results.append(p)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.10f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}