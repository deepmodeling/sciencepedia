{
    "hands_on_practices": [
        {
            "introduction": "现实世界中的系统（如电池）由不同材料组成。正确模拟其界面处的物理现象至关重要，因为在这些界面上，电导率 $a(x)$ 等材料属性会发生急剧变化。本练习将指导您离散化稳态方程 $-(a(x) u_x)_x = 0$，通过这个练习，您将理解为何基于物理原理的方法（调和平均）远优于朴素的算术平均，并是确保通量守恒的关键。",
            "id": "3914376",
            "problem": "考虑非均质电池电解质中沿归一化空间坐标 $x \\in [0,1]$ 的稳态一维电荷守恒问题。在没有体源或体汇的情况下，守恒定律指出离子电流密度（通量）的散度为零。根据电解质中的欧姆定律，通量由有效离子电导率与电解质电势的负梯度之积给出。将这些结合起来，得到一个关于电势的二阶微分方程。设电势为 $u(x)$，有效电导率为 $a(x)$。控制方程和边界条件如下：\n- $-(a(x) \\, u_x)_x = 0$，对于 $x \\in (0,1)$，\n- $u(0) = 0$ （伏特），\n- $u(1) = 1$ （伏特）。\n\n通过将 $a(x)$ 定义为分段常数，在 $x = 0.5$ 处建立一个尖锐的材料界面模型：\n- $a(x) = 1$，对于 $x \\le 0.5$，\n- $a(x) = 100$，对于 $x > 0.5$。\n您可以假设横截面积为单位1。$a(x)$ 的跳跃代表了强烈的电导率对比，这在层状电池结构（例如，隔膜和电极之间的过渡）中很常见。在物理界面处，通量和电势都是连续的。\n\n任务：从第一性原理出发，在 $[0,1]$ 上一个包含 $N+1$ 个节点、间距为 $h = 1/N$ 的均匀网格上，推导一个强制执行离散通量守恒的有限差分或有限体积离散化方法。推导必须从守恒声明和欧姆定律开始，然后将每个控制体积上的通量平衡转化为一个关于节点电势未知数的离散线性系统。当 $x=0.5$ 处的不连续点位于两个相邻节点之间时，横跨界面的面代表该段上两种串联的材料；因此，需根据串联电阻的原理推导出合适的等效面电导率。同时，构建第二种刻意构造的朴素离散化方法，该方法在每个面上使用相邻电导率的算术平均值，以作为对比。在给定的狄利克雷边界条件下，求解得到的线性系统以获得离散电势。\n\n将节点 $i$ 和 $i+1$ 之间的离散面通量定义为 $J_{i+1/2} = - a_{i+1/2} \\, (u_{i+1}-u_i)/h$，其中 $a_{i+1/2}$ 是您推导出的面电导率。使用离散解来评估在 $x=0.5$ 的材料界面上通量的连续性。为量化评估，请为每种情况计算以下内容：\n- 通量连续性度量 $M$，定义为 $M = \\frac{|J_\\text{right} - J_\\text{left}|}{\\max(|J_\\text{right}|,|J_\\text{left}|)}$，其中 $J_\\text{left}$ 和 $J_\\text{right}$ 是紧邻 $x=0.5$ 左右两侧的离散面通量（根据 $x=0.5$ 是恰好为一个节点还是位于两节点之间，来选择邻近于 $x=0.5$ 的一对面）。\n- 最大节点误差 $E_\\infty$，相对于由每个材料层中通量恒定和在 $x=0.5$ 处连续性所蕴含的精确分段线性解。将 $E_\\infty$ 表示为在所有节点 $x_i$ 上计算得到的无量纲浮点数。\n\n您的程序必须实现两种面电导率的构造方法：\n- 从您的推导中获得的、物理上一致的、基于串联的调和构造方法，当界面位于一个面内时，该方法能恰当考虑子段的长度。\n- 简单地对相邻逐点电导率进行平均的朴素算术平均构造方法。\n\n测试套件：\n提供以下四个参数集 $(N,\\text{method})$ 的结果，其中 $\\text{method}$ 对于基于串联的构造是 \"harmonic\"，对于朴素构造是 \"arithmetic\"。\n1. $(N=101,\\text{method}=\\text{\"harmonic\"})$。\n2. $(N=100,\\text{method}=\\text{\"harmonic\"})$。\n3. $(N=100,\\text{method}=\\text{\"arithmetic\"})$。\n4. $(N=3,\\text{method}=\\text{\"harmonic\"})$。\n\n输出规格：\n- 对于列表中的每个测试用例，按顺序计算并收集数对 $[M,E_\\infty]$。\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，其中每个元素是对应一个测试用例的二元列表，即，最终输出必须为 $[[M_1,E_{\\infty,1}],[M_2,E_{\\infty,2}],[M_3,E_{\\infty,3}],[M_4,E_{\\infty,4}]]$ 的形式。\n- 所有输出均为无量纲浮点数。边界条件以伏特为单位，因此用于计算误差的离散电势也必须以伏特为单位，但报告的度量是无单位的。\n\n除了这唯一要求的输出行外，不得打印任何其他文本。",
            "solution": "用户希望我使用有限差分法解决一个一维稳态电荷守恒问题。\n\n计划如下：\n1.  **验证问题陈述**：\n    *   提取所有给定条件。\n    *   检查科学合理性、适定性和客观性。\n    *   该问题描述了一个标准的一维扩散型方程，这是物理学和工程学的基石。该设置看起来完全有效。\n\n2.  **推导解法**：\n    *   **解析解**：首先，我将找到精确的解析解。这对于之后计算误差是必需的。\n        *   控制方程是 $-(a(x) u_x)_x = 0$。\n        *   积分一次得到 $-a(x) u_x = J$，其中 $J$ 是一个恒定通量。\n        *   所以，$u_x = -J/a(x)$。\n        *   再次积分得到 $u(x) = u(0) - J \\int_0^x \\frac{d\\xi}{a(\\xi)}$。\n        *   我们有 $u(0) = 0$。所以，$u(x) = -J \\int_0^x \\frac{d\\xi}{a(\\xi)}$。\n        *   使用 $x=1$ 处的边界条件，$u(1) = 1 = -J \\int_0^1 \\frac{d\\xi}{a(\\xi)}$。\n        *   这使我们能够求出恒定通量 $J$。\n        *   积分是 $\\int_0^1 \\frac{d\\xi}{a(\\xi)} = \\int_0^{0.5} \\frac{d\\xi}{1} + \\int_{0.5}^1 \\frac{d\\xi}{100} = 0.5 + \\frac{0.5}{100} = 0.5 + 0.005 = 0.505$。\n        *   所以，$1 = -J (0.505)$，这意味着 $J = -1/0.505$。\n        *   现在我可以写出精确解 $u(x)$：\n            *   对于 $x \\in [0, 0.5]$：$u(x) = -J \\int_0^x \\frac{d\\xi}{1} = -J x = \\frac{x}{0.505}$。\n            *   对于 $x \\in (0.5, 1]$：我们需要电势在 $x=0.5$ 处连续。\n                *   $u(0.5) = \\frac{0.5}{0.505}$。\n                *   $u(x) = u(0.5) - J \\int_{0.5}^x \\frac{d\\xi}{100} = \\frac{0.5}{0.505} - J \\frac{x-0.5}{100} = \\frac{0.5}{0.505} + \\frac{1}{0.505} \\frac{x-0.5}{100}$。\n                *   $u(x) = \\frac{1}{0.505} \\left( 0.5 + \\frac{x-0.5}{100} \\right)$。\n        *   让我们检查 $x=1$ 处的边界条件：\n            *   $u(1) = \\frac{1}{0.505} \\left( 0.5 + \\frac{1-0.5}{100} \\right) = \\frac{1}{0.505} \\left( 0.5 + \\frac{0.5}{100} \\right) = \\frac{1}{0.505} (0.505) = 1$。它成立。\n        *   所以解析解是：\n            $$\n            u(x) = \\begin{cases}\n                \\frac{x}{0.505}  \\text{对于 } 0 \\le x \\le 0.5 \\\\\n                \\frac{1}{0.505} \\left( 0.5 + \\frac{x-0.5}{100} \\right)  \\text{对于 } 0.5  x \\le 1\n            \\end{cases}\n            $$\n\n    *   **离散化**：\n        *   问题要求基于通量守恒进行有限差分或有限体积离散化。这自然地引出了有限体积法。\n        *   网格：$x_i = i \\cdot h$ 对于 $i = 0, 1, ..., N$，其中 $h=1/N$。\n        *   控制体积(CVs)：对于一个内部节点 $i$（从 $i=1$ 到 $N-1$），控制体积是 $[x_{i-1/2}, x_{i+1/2}]$，其中 $x_{i+1/2} = (x_i + x_{i+1})/2$ 是节点 $i$ 和 $i+1$ 之间的面。\n        *   在节点 $i$ 的控制体积上积分守恒定律：\n            $$ \\int_{x_{i-1/2}}^{x_{i+1/2}} -(a(x) u_x)_x \\, dx = 0 $$\n        *   使用微积分基本定理：\n            $$ -(a(x) u_x)|_{x_{i+1/2}} - \\left( -(a(x) u_x)|_{x_{i-1/2}} \\right) = 0 $$\n        *   设 $J(x) = -a(x) u_x$ 为通量。那么 $J(x_{i+1/2}) - J(x_{i-1/2}) = 0$。这表示离散通量守恒。\n        *   现在，我们需要在面上近似通量。在 $x_{i+1/2}$ 处的面通量是 $J_{i+1/2}$。我们使用节点值的中心差分来近似面上的导数 $u_x$：\n            $$ J_{i+1/2} \\approx - a_{i+1/2} \\frac{u_{i+1} - u_i}{x_{i+1} - x_i} = - a_{i+1/2} \\frac{u_{i+1} - u_i}{h} $$\n            其中 $u_i = u(x_i)$。\n        *   内部节点 $i$ 的离散守恒方程变为：\n            $$ -a_{i+1/2} \\frac{u_{i+1} - u_i}{h} - \\left( -a_{i-1/2} \\frac{u_i - u_{i-1}}{h} \\right) = 0 $$\n            $$ -a_{i-1/2} u_{i-1} + (a_{i-1/2} + a_{i+1/2}) u_i - a_{i+1/2} u_{i+1} = 0 $$\n            这对 $i = 1, 2, ..., N-1$ 成立。\n        *   边界条件是 $u_0 = u(0) = 0$ 和 $u_N = u(1) = 1$。\n        *   这为未知电势 $u_1, ..., u_{N-1}$ 给出了一个三对角线性系统 $A \\cdot \\vec{u} = \\vec{b}$。\n        *   $i=1$ 的方程：$-a_{1/2} u_0 + (a_{1/2} + a_{3/2}) u_1 - a_{3/2} u_2 = 0$。因为 $u_0=0$，这变成 $(a_{1/2} + a_{3/2}) u_1 - a_{3/2} u_2 = 0$。\n        *   $i=N-1$ 的方程：$-a_{N-3/2} u_{N-2} + (a_{N-3/2} + a_{N-1/2}) u_{N-1} - a_{N-1/2} u_N = 0$。因为 $u_N=1$，这变成 $-a_{N-3/2} u_{N-2} + (a_{N-3/2} + a_{N-1/2}) u_{N-1} = a_{N-1/2}$。\n\n    *   **推导面电导率 $a_{i+1/2}$**：这是问题的核心。\n        *   通量是 $J = -a(x) u_x$。所以，$u_x = -J/a(x)$。\n        *   从 $x_i$ 积分到 $x_{i+1}$：$u_{i+1} - u_i = \\int_{x_i}^{x_{i+1}} u_x dx = - \\int_{x_i}^{x_{i+1}} \\frac{J(x)}{a(x)} dx$。\n        *   在我们的稳态一维情况下，通量 $J$ 在节点之间是恒定的。我们假设它在单元面区间 $[x_i, x_{i+1}]$ 上是恒定的，所以 $J(x) \\approx J_{i+1/2}$。\n        *   那么 $u_{i+1} - u_i \\approx - J_{i+1/2} \\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)}$。\n        *   重新排列，$J_{i+1/2} \\approx - \\frac{u_{i+1} - u_i}{\\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)}}$。\n        *   将此与我们的有限差分形式 $J_{i+1/2} = - a_{i+1/2} \\frac{u_{i+1} - u_i}{h}$ 进行比较，我们得到：\n            $$ \\frac{a_{i+1/2}}{h} = \\frac{1}{\\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)}} $$\n            $$ a_{i+1/2} = \\frac{h}{\\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)}} $$\n        *   这是 $a(x)$ 在区间 $[x_i, x_{i+1}]$ 上的调和平均。这是物理上一致的“串联电阻”模型。$1/a(x)$ 的积分是该段上的总电阻。通量是电势差除以总电阻。\n        *   现在，让我们为我们的分段常数 $a(x)$ 计算这个积分。\n        *   界面在 $x_c = 0.5$。\n        *   情况1：区间 $[x_i, x_{i+1}]$ 不包含界面 $x_c$。\n            *   那么 $a(x)$ 在该区间上是常数，为1或100。\n            *   $\\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)} = \\frac{h}{a(\\text{区间上的值})}$。\n            *   $a_{i+1/2} = \\frac{h}{h/a(\\text{值})} = a(\\text{值})$。这就是材料的电导率。\n        *   情况2：区间 $[x_i, x_{i+1}]$ 包含界面 $x_c$。当 $x_i  x_c  x_{i+1}$ 时发生这种情况。\n            *   积分为：$\\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)} = \\int_{x_i}^{x_c} \\frac{dx}{a_{left}} + \\int_{x_c}^{x_{i+1}} \\frac{dx}{a_{right}} = \\frac{x_c - x_i}{a_{left}} + \\frac{x_{i+1} - x_c}{a_{right}}$。\n            *   这里 $a_{left}=1$ 和 $a_{right}=100$。\n            *   子段的长度是 $L_1 = x_c - x_i$ 和 $L_2 = x_{i+1} - x_c$。注意 $L_1+L_2 = h$。\n            *   $a_{i+1/2} = \\frac{h}{\\frac{L_1}{a_{left}} + \\frac{L_2}{a_{right}}} = \\frac{L_1+L_2}{\\frac{L_1}{a_{left}} + \\frac{L_2}{a_{right}}}$。这是加权调和平均值。这正是从串联电阻推导所得到的结果：总电阻是 $R_1+R_2$，其中 $R_k \\propto L_k/a_k$。\n        *   这为 $a_{i+1/2}$ 提供了“调和”方法。\n\n    *   **朴素算术平均构造**：\n        *   这个方法被给出为 $a_{i+1/2} = \\frac{a(x_i) + a(x_{i+1})}{2}$。\n        *   我们需要在节点上评估 $a(x)$。问题定义了 $a(x)$ 在 $x=0.5$ 处有一个跳跃。$a(0.5)$ 是什么？问题说 “$a(x)=1$ 对于 $x \\le 0.5$ 并且 $a(x)=100$ 对于 $x0.5$。” $a(0.5)$ 的值现在是明确的。\n        *   我们将采用一个合理的约定：如果 $x_i \\le 0.5$ 则 $a(x_i) = 1$，如果 $x_i  0.5$ 则 $a(x_i) = 100$。这是一个合理的、可实现的解释。\n\n3.  **实现细节**：\n    *   **主函数 `solve()`**：将遍历4个测试用例。\n    *   **每个案例的辅助函数 `compute_solution(N, method)`**\n        *   **网格设置**：$h = 1/N$，$x = \\text{np.linspace}(0, 1, N+1)$。\n        *   **电导率设置**：\n            *   为 $a(x_i)$ 创建一个数组 `a_nodes`。我的约定是：`a_nodes = np.ones(N+1); a_nodes[x  0.5] = 100`。\n            *   创建一个大小为 $N$ 的数组 `a_faces` 用于 $a_{i+1/2}$。这将根据 `method` 填充。\n        *   **面电导率计算**：\n            *   `method == \"harmonic\"`：\n                *   从 $i=0$ 到 $N-1$ 循环。\n                *   检查界面 $x_c=0.5$ 是否在 $[x_i, x_{i+1}]$ 内。\n                *   如果是，则计算 $L_1 = 0.5 - x_i$，$L_2 = x_{i+1} - 0.5$。$a_{face} = h / (L_1/1 + L_2/100)$。\n                *   如果不是，$a_{face}$ 就是 $1$ 或 $100$，取决于区间位于 $0.5$ 的哪一侧。\n            *   `method == \"arithmetic\"`：\n                *   从 $i=0$ 到 $N-1$ 循环。\n                *   $a_{face} = (a_{nodes}[i] + a_{nodes}[i+1]) / 2$。\n        *   **矩阵组装**：\n            *   我们需要求解 $u_1, ..., u_{N-1}$。这是一个大小为 $(N-1) \\times (N-1)$ 的系统。\n            *   节点 $i$ 的方程是：$-a_{i-1/2} u_{i-1} + (a_{i-1/2} + a_{i+1/2}) u_i - a_{i+1/2} u_{i+1} = 0$。\n            *   创建一个矩阵 `A`（大小为 `N-1` x `N-1`）和一个向量 `b`（大小为 `N-1`）。\n            *   `A` 是三对角的。\n            *   `b` 向量大部分是零，除了最后一个元素 $b[N-2] = a_{N-1/2}$，它来自于 $u_N=1$ 的边界条件。\n        *   **求解系统**：`u_internal = np.linalg.solve(A, b)`。\n        *   **完整解**：`u = np.concatenate(([0], u_internal, [1]))`。\n\n    *   **后处理**：\n        *   **通量连续性度量 $M$**：\n            *   这个区别解决了这个悖论。有限差分系统强制执行离散通量 $J_{i+1/2}$ 的守恒，即 $J_{i+1/2} = J_{i-1/2}$。然而，度量M必须评估物理通量 $J(x)=-a(x) u_x$ 的守恒，它是使用材料的实际电导率来近似的。\n            *   **度量M的最终逻辑**：\n                1. 找到最后一个节点 $x_k$ 的索引 $k$，使得 $x_k \\le 0.5$。\n                2. 选择一个完全在左侧材料（电导率 $a_1=1$）中的区间，例如 $[x_{k-1}, x_k]$。此处的物理通量近似为 $J_{left} = -a_1 \\frac{u_k - u_{k-1}}{h}$。\n                3. 选择一个完全在右侧材料（电导率 $a_2=100$）中的区间，例如 $[x_{k+1}, x_{k+2}]$。此处的物理通量近似为 $J_{right} = -a_2 \\frac{u_{k+2} - u_{k+1}}{h}$。\n                4. 使用这些 $J_{left}$ 和 $J_{right}$ 的值计算 $M$。\n            *   这种方法正确地测试了获得的电势分布是否与跨不同材料的恒定通量物理定律一致。对于调和方法，$M$ 将接近于零。对于算术方法，$M$ 将不为零。这是一个一致且严谨的解释。\n        *   **最大节点误差 $E_\\infty$**：\n            *   计算 $E_\\infty = \\max_i |u_{exact}(x_i) - u_{i}|$，其中 $u_{exact}$ 是之前推导出的解析解。\n\n问题是有效的。在定义 $a(0.5)$ 方面的微小模糊性并没有从根本上破坏问题，因为它只与“朴素”方法有关，并且可以应用一个标准约定。问题的核心在于推导和比较物理上一致的方法和朴素方法。\n\n### 推导和求解方法论\n\n稳态电势 $u(x)$ 在非均质电导率 $a(x)$ 下的控制方程由电荷守恒推导而来，即电流密度（通量）$J$ 的散度为零，$\\nabla \\cdot J = 0$。在一维中，这是 $J_x = 0$，意味着 $J(x)$ 是恒定的。根据欧姆定律，通量与电势的负梯度成正比，$J(x) = -a(x) u_x$，其中 $u_x = du/dx$。将这些结合起来，得到微分方程：\n$$ -(a(x) u_x)_x = 0, \\quad x \\in (0,1) $$\n边界条件为 $u(0)=0$ 和 $u(1)=1$。\n\n我们将使用有限体积法，该方法对于此问题等效于特定的有限差分格式，并能自然地强制执行守恒。我们将域 $[0,1]$ 离散化为 $N$ 个控制体积，使用 $N+1$ 个节点 $x_i = i \\cdot h$（$i=0, 1, \\dots, N$），其中 $h=1/N$ 是均匀网格间距。对于每个内部节点 $x_i$，我们定义一个从面 $x_{i-1/2}$ 延伸到面 $x_{i+1/2}$ 的控制体积，其中 $x_{i \\pm 1/2} = (x_i + x_{i \\pm 1})/2$。\n\n在节点 $i$ 的控制体积上积分控制方程：\n$$ \\int_{x_{i-1/2}}^{x_{i+1/2}} -(a(x) u_x)_x \\, dx = 0 $$\n根据微积分基本定理，这变为：\n$$ \\left[ -a(x) u_x \\right]_{x_{i-1/2}}^{x_{i+1/2}} = 0 \\implies J(x_{i+1/2}) - J(x_{i-1/2}) = 0 $$\n该方程表明，流入控制体积的面 $x_{i-1/2}$ 处的通量必须等于流出面 $x_{i+1/2}$ 处的通量。设 $J_{i+1/2}$ 是面 $x_{i+1/2}$ 处通量的数值近似。离散守恒定律为 $J_{i+1/2} = J_{i-1/2}$。\n\n为了获得物理上一致的离散化，我们必须仔细定义面通量 $J_{i+1/2}$。从节点 $x_i$ 到 $x_{i+1}$ 积分 $u_x = -J(x)/a(x)$：\n$$ u_{i+1} - u_i = \\int_{x_i}^{x_{i+1}} u_x \\, dx = -\\int_{x_i}^{x_{i+1}} \\frac{J(x)}{a(x)} \\, dx $$\n假设通量 $J(x)$ 在小区间 $[x_i, x_{i+1}]$ 上近似恒定并等于面通量 $J_{i+1/2}$，我们有：\n$$ u_{i+1} - u_i \\approx -J_{i+1/2} \\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)} \\implies J_{i+1/2} \\approx -\\frac{u_{i+1} - u_i}{\\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)}} $$\n我们还使用有限差分近似来定义数值通量：\n$$ J_{i+1/2} = -a_{i+1/2} \\frac{u_{i+1} - u_i}{h} $$\n比较 $J_{i+1/2}$ 的两个表达式，得到等效面电导率 $a_{i+1/2}$：\n$$ a_{i+1/2} = \\frac{h}{\\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)}} $$\n这是 $a(x)$ 在 $[x_i, x_{i+1}]$ 上的调和平均。这种方法等效于将该段建模为两个串联电阻。该段的总电阻是其子段电阻之和，这正是积分 $\\int dx/a(x)$ 所代表的。\n\n对于分段常数电导率 $a(x) = a_1=1$（$x \\le 0.5$）和 $a(x) = a_2=100$（$x0.5$），我们计算 $a_{i+1/2}$：\n1.  如果区间 $[x_i, x_{i+1}]$ 完全在一种材料内，$a(x)$ 是常数，积分得到 $h/a_{mat}$，所以 $a_{i+1/2} = a_{mat}$。\n2.  如果区间 $[x_i, x_{i+1}]$ 横跨界面 $x_c=0.5$，积分变为两部分之和：\n    $$ \\int_{x_i}^{x_{i+1}} \\frac{dx}{a(x)} = \\frac{x_c-x_i}{a_1} + \\frac{x_{i+1}-x_c}{a_2} $$\n    等效电导率则为 $a_{i+1/2} = \\frac{h}{(x_c-x_i)/a_1 + (x_{i+1}-x_c)/a_2}$。这是“调和”构造。\n\n“算术”构造是节点电导率值的朴素平均：$a_{i+1/2} = (a(x_i) + a(x_{i+1}))/2$。为此，我们采用约定：如果 $x_i \\le 0.5$ 则 $a(x_i)=1$，如果 $x_i  0.5$ 则 $a(x_i)=100$。\n\n定义了面电导率后，我们为未知的内部电势 $u_1, \\dots, u_{N-1}$ 组装一个线性系统。每个内部节点 $i \\in [1, N-1]$ 的方程源于 $J_{i+1/2} - J_{i-1/2} = 0$：\n$$ -a_{i+1/2} \\frac{u_{i+1} - u_i}{h} - \\left(-a_{i-1/2} \\frac{u_i - u_{i-1}}{h}\\right) = 0 $$\n$$ -a_{i-1/2} u_{i-1} + (a_{i-1/2} + a_{i+1/2}) u_i - a_{i+1/2} u_{i+1} = 0 $$\n边界条件 $u_0=0$ 和 $u_N=1$ 修改了 $i=1$ 和 $i=N-1$ 的方程。对于 $i=1$，含 $u_0$ 的项消失。对于 $i=N-1$，项 $-a_{N-1/2} u_N$ 变为已知值 $-a_{N-1/2}$，移至线性系统的右侧。这就形成了一个三对角系统 $A \\mathbf{u} = \\mathbf{b}$，可以求解内部电势向量 $\\mathbf{u} = [u_1, \\dots, u_{N-1}]^T$。\n\n最后，我们计算所需的度量：\n1.  **最大节点误差 $E_\\infty$**：精确解是分段线性的：$u_{exact}(x) = (x/0.505)$ 对于 $x \\le 0.5$，$u_{exact}(x) = (0.5 + (x-0.5)/100)/0.505$ 对于 $x  0.5$。我们计算 $E_\\infty = \\max_i |u_{exact}(x_i) - u_{i}|$。\n2.  **通量连续性度量 $M$**：该度量评估数值解在材料界面上对物理通量 $J(x)=-a(x) u_x$ 的守恒程度。我们近似界面左侧材料中的物理通量 $J_{left}$ 和右侧的 $J_{right}$。我们确定界面前或界面上的最后一个节点 $x_k$（$x_k \\le 0.5$）。我们使用区间 $[x_{k-1}, x_k]$ 来计算 $J_{left} = -a_1 (u_k-u_{k-1})/h$。我们使用区间 $[x_{k+1}, x_{k+2}]$（第二种材料中的第一个完整区间）来计算 $J_{right} = -a_2 (u_{k+2}-u_{k+1})/h$。然后度量为 $M = \\frac{|J_{right} - J_{left}|}{\\max(|J_{right}|, |J_{left}|)}$。对于物理上一致的调和方法，$M$ 应接近于零，而对于朴素的算术方法，它将很显著。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function that runs test cases and prints the results.\n    \"\"\"\n\n    def get_analytical_solution(x_nodes):\n        \"\"\"\n        Computes the exact piecewise-linear solution at the given node locations.\n        \"\"\"\n        u_exact = np.zeros_like(x_nodes, dtype=float)\n        a1, a2 = 1.0, 100.0\n        x_interface = 0.5\n        \n        # Total equivalent resistance is the integral of 1/a(x) from 0 to 1.\n        # For a unit potential drop, the constant flux J = -1 / R_total.\n        R_total = (x_interface / a1) + ((1.0 - x_interface) / a2)\n        J = -1.0 / R_total\n        \n        # u(x) = u(0) - J * integral(1/a from 0 to x). Since u(0)=0.\n        # For x = 0.5\n        mask_left = x_nodes = x_interface\n        resistance_left = x_nodes[mask_left] / a1\n        u_exact[mask_left] = -J * resistance_left\n        \n        # For x > 0.5\n        mask_right = x_nodes > x_interface\n        resistance_right = (x_interface / a1) + (x_nodes[mask_right] - x_interface) / a2\n        u_exact[mask_right] = -J * resistance_right\n        \n        return u_exact\n\n    def compute_solution_metrics(N, method):\n        \"\"\"\n        Computes the numerical solution and associated metrics for a given N and method.\n        \"\"\"\n        h = 1.0 / N\n        x_nodes = np.linspace(0.0, 1.0, N + 1)\n        a1, a2 = 1.0, 100.0\n        x_interface = 0.5\n\n        # --- Step 1: Calculate face conductivities a_{i+1/2} ---\n        a_faces = np.zeros(N)\n        if method == \"harmonic\":\n            for i in range(N):\n                x_left, x_right = x_nodes[i], x_nodes[i+1]\n                # Check if face interval straddles the material interface\n                if x_left  x_interface  x_right:\n                    l1 = x_interface - x_left\n                    l2 = x_right - x_interface\n                    # Weighted harmonic mean for series resistances\n                    a_faces[i] = h / (l1 / a1 + l2 / a2)\n                elif x_right = x_interface:\n                    a_faces[i] = a1\n                else:  # x_left >= x_interface\n                    a_faces[i] = a2\n        elif method == \"arithmetic\":\n            a_nodes = np.full(N + 1, a1)\n            a_nodes[x_nodes > x_interface] = a2\n            for i in range(N):\n                a_faces[i] = (a_nodes[i] + a_nodes[i+1]) / 2.0\n        \n        # --- Step 2: Assemble and solve the linear system Au=b ---\n        num_unknowns = N - 1\n        if num_unknowns = 0: # a trivial case like N=1\n             u_numerical = np.array([0.0, 1.0])\n        else:\n            # Diagonals for the tridiagonal matrix A\n            diag_main = a_faces[:-1] + a_faces[1:]\n            diag_off = -a_faces[1:-1]\n            A = np.diag(diag_main) + np.diag(diag_off, k=1) + np.diag(diag_off, k=-1)\n            \n            # Right-hand side vector b\n            b = np.zeros(num_unknowns)\n            b[-1] = a_faces[-1] * 1.0 # Contribution from boundary condition u_N = 1\n            \n            # Solve for interior node potentials\n            u_internal = np.linalg.solve(A, b)\n            u_numerical = np.concatenate(([0.0], u_internal, [1.0]))\n\n        # --- Step 3: Calculate metrics M and E_infty ---\n        # Metric M: Flux continuity\n        # Find index k of the last node in the first material (x_k = x_interface)\n        k = np.searchsorted(x_nodes, x_interface, side='right') - 1\n        \n        # J_left: physical flux in interval [x_{k-1}, x_k] (entirely in material 1)\n        grad_left = (u_numerical[k] - u_numerical[k-1]) / h\n        J_left = -a1 * grad_left\n        \n        # J_right: physical flux in interval [x_{k+1}, x_{k+2}] (entirely in material 2)\n        grad_right = (u_numerical[k+2] - u_numerical[k+1]) / h\n        J_right = -a2 * grad_right\n\n        denom = max(abs(J_left), abs(J_right))\n        M = 0.0 if denom  1e-15 else abs(J_right - J_left) / denom\n        \n        # Metric E_infty: Maximum nodal error\n        u_exact = get_analytical_solution(x_nodes)\n        E_inf = np.max(np.abs(u_numerical - u_exact))\n\n        return [M, E_inf]\n\n    test_cases = [\n        (101, \"harmonic\"),\n        (100, \"harmonic\"),\n        (100, \"arithmetic\"),\n        (3, \"harmonic\")\n    ]\n\n    results = []\n    for N, method in test_cases:\n        metrics = compute_solution_metrics(N, method)\n        results.append(metrics)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "有限差分法将微分方程转化为线性代数方程组。对于一维问题，这些系统通常呈现出三对角结构，从而可以使用高效的求解方法。本练习将让您推导并应用托马斯算法（Thomas algorithm），这是一种专门求解此类系统的求解器，从而在数学公式和计算执行之间架起一座桥梁。",
            "id": "3914374",
            "problem": "在一个自动化电池设计模拟中，考虑锂离子在厚度为 $L$ 的一维隔膜中电解质相内的稳态输运。在扩散系数 $D$ 恒定且隔膜内部没有体积消耗的情况下，稳态锂离子浓度 $c(x)$ 满足守恒定律和菲克第一定律：$\\frac{d}{dx}\\left( -D \\frac{dc}{dx} \\right) = 0$ 和 $j = -D \\frac{dc}{dx}$，其中 $j$ 是右边界 $x=L$ 处的恒定摩尔通量。将域 $[0,L]$ 用一个包含 $N$ 个内部节点的均匀网格离散化，网格间距为 $h = \\frac{L}{N+1}$，将左狄利克雷边界设置在 $x=0$ 处，其中 $c(0)=c_{0}$，并在右侧施加诺伊曼边界 $-D \\frac{dc}{dx}\\big|_{x=L} = j$。对内部节点使用二阶中心差分，并通过在 $x=L+h$ 处的虚拟节点使用与诺伊曼边界一致的单边有限差分。\n\n1. 从上述定律和离散化得到的有限差分方程出发，写出关于未知数 $c_{1}, c_{2}, \\dots, c_{N}$ 的三对角线性系统，其标准形式为 $a_{i} c_{i-1} + b_{i} c_{i} + \\gamma_{i} c_{i+1} = d_{i}$，并约定在通过诺伊曼边界条件消除虚拟节点后，$a_{1}=0$ 和 $\\gamma_{N}=0$。然后，从第一性原理出发（通过将高斯消元法特化应用于三对角矩阵），推导 Thomas 算法，并以闭式形式给出这类一般三对角系统的前向消元和回代步骤。\n\n2. 将你推导的 Thomas 算法应用于具体的隔膜案例，参数为 $N=5$，$L=25 \\times 10^{-6}\\,\\text{m}$，$D=2.0 \\times 10^{-10}\\,\\text{m}^{2}\\,\\text{s}^{-1}$，$c_{0}=1000\\,\\text{mol}\\,\\text{m}^{-3}$，以及 $j=1.0 \\times 10^{-4}\\,\\text{mol}\\,\\text{m}^{-2}\\,\\text{s}^{-1}$。计算第三个内部节点 $c_{3}$ 处的浓度。\n\n将你的最终数值答案四舍五入到四位有效数字。浓度以 $\\text{mol}\\,\\text{m}^{-3}$ 为单位表示。",
            "solution": "在进行求解之前，对问题陈述的有效性进行评估。\n\n### 步骤1：提取已知条件\n- **控制方程**：$\\frac{d}{dx}\\left( -D \\frac{dc}{dx} \\right) = 0$，其中扩散系数 $D$ 为常数。\n- **通量定义**：$j = -D \\frac{dc}{dx}$，其中 $j$ 是 $x=L$ 处的恒定摩尔通量。\n- **区域**：厚度为 $L$ 的一维隔膜，区域为 $[0,L]$。\n- **网格**：具有 $N$ 个内部节点的均匀网格。网格间距 $h = \\frac{L}{N+1}$。\n- **边界条件**：\n    - 左侧 ($x=0$)：狄利克雷边界，$c(0)=c_{0}$。\n    - 右侧 ($x=L$)：诺伊曼边界，$-D \\frac{dc}{dx}\\big|_{x=L} = j$。\n- **离散化方法**：\n    - 内部节点：二阶中心差分。\n    - 右边界：与诺伊曼边界条件一致的单边有限差分，使用位于 $x=L+h$ 的虚拟节点。\n- **线性系统形式**：三对角系统 $a_{i} c_{i-1} + b_{i} c_{i} + \\gamma_{i} c_{i+1} = d_{i}$，约定 $a_{1}=0$ 和 $\\gamma_{N}=0$。\n- **任务1**：推导未知数 $c_{1}, \\dots, c_{N}$ 的有限差分方程，并给出最终的线性系统。从此类系统的第一性原理推导 Thomas 算法。\n- **任务2**：使用参数 $N=5$，$L=25 \\times 10^{-6}\\,\\text{m}$，$D=2.0 \\times 10^{-10}\\,\\text{m}^{2}\\,\\text{s}^{-1}$，$c_{0}=1000\\,\\text{mol}\\,\\text{m}^{-3}$，以及 $j=1.0 \\times 10^{-4}\\,\\text{mol}\\,\\text{m}^{-2}\\,\\text{s}^{-1}$ 应用该算法，计算浓度 $c_{3}$。\n- **输出格式**：最终数值答案四舍五入至四位有效数字。\n\n### 步骤2：使用提取的已知条件进行验证\n- **科学依据**：该问题具有科学依据。它描述了基于菲克定律的稳态扩散，这是输运现象中的一个基本原理，并应用于锂离子电池模拟这一相关背景。\n- **适定性**：带有一个狄利克雷和一个诺伊曼边界条件的一维二阶常微分方程是一个适定问题，保证了解的唯一性和稳定性。\n- **客观性**：该问题陈述客观。然而，它在所要求的线性系统形式中包含一个明显的笔误：“$a_{i} c_{i-1} + b_{i} c_{i} + c_{i} c_{i+1} = d_{i}$”。“$c_{i} c_{i+1}$”项会使系统变为非线性，这与“三对角线性系统”的描述以及控制偏微分方程和离散格式的线性性质相矛盾。此外，问题后面提到“$c_N=0$”，其中 $c_N$ 必须是系数，而不是未知浓度。其明确意图是标准的线性三对角形式，我将其写作 $a_{i} c_{i-1} + b_{i} c_{i} + \\gamma_{i} c_{i+1} = d_{i}$，其中 $\\gamma_i$ 是 $c_{i+1}$ 的系数。$c_N=0$ 的条件被解释为 $\\gamma_N=0$。\n\n### 步骤3：结论与行动\n该问题是**有效的**，但这取决于对一个明显笔误的合理解释。其科学和数学结构是合理的。我将继续进行求解。\n\n### 第1部分：线性系统和 Thomas 算法的推导\n\n在扩散系数 $D$ 恒定的情况下，控制方程简化为一维拉普拉斯方程：\n$$ \\frac{d^2c}{dx^2} = 0 $$\n区域 $[0, L]$ 用节点 $x_i = i h$（$i=0, 1, \\dots, N, N+1$）进行离散化，其中 $h = \\frac{L}{N+1}$，$x_0=0$，$x_{N+1}=L$。未知数是内部节点的浓度 $c_i = c(x_i)$（$i=1, 2, \\dots, N$）。$c_0 = c(0)$ 的值由狄利克雷边界条件给出。\n\n**内部节点的离散化 ($i=1, \\dots, N-1$)**\n对内部节点 $x_i$ 处的二阶导数使用二阶中心差分近似：\n$$ \\frac{d^2c}{dx^2}\\bigg|_{x_i} \\approx \\frac{c_{i-1} - 2c_i + c_{i+1}}{h^2} $$\n将此代入控制方程可得：\n$$ \\frac{c_{i-1} - 2c_i + c_{i+1}}{h^2} = 0 \\implies c_{i-1} - 2c_i + c_{i+1} = 0 $$\n对于 $i=1$，我们使用已知的边界值 $c_0$：\n$$ c_0 - 2c_1 + c_2 = 0 \\implies -2c_1 + c_2 = -c_0 $$\n\n**右边界（节点 $N$）的离散化**\n对于节点 $i=N$，中心差分格式涉及到 $c_{N+1} = c(L)$，其是未知的。我们必须通过位于 $x_{N+2} = L+h = x_{N+1}+h$ 的虚拟节点来使用诺伊曼边界条件 $-D \\frac{dc}{dx}\\big|_{x=L} = j$。\n在边界节点 $x_{N+1} = L$ 处导数的二阶中心差分是：\n$$ \\frac{dc}{dx}\\bigg|_{x_{N+1}} \\approx \\frac{c_{N+2} - c_N}{2h} $$\n应用诺伊曼条件：\n$$ -D \\frac{c_{N+2} - c_N}{2h} = j \\implies c_{N+2} = c_N - \\frac{2hj}{D} $$\n为了消除虚拟节点值 $c_{N+2}$，我们假设控制偏微分方程在边界节点 $x_{N+1}$ 处也成立：\n$$ \\frac{d^2c}{dx^2}\\bigg|_{x_{N+1}} \\approx \\frac{c_N - 2c_{N+1} + c_{N+2}}{h^2} = 0 \\implies c_N - 2c_{N+1} + c_{N+2} = 0 $$\n代入 $c_{N+2}$ 的表达式：\n$$ c_N - 2c_{N+1} + \\left(c_N - \\frac{2hj}{D}\\right) = 0 \\implies 2c_N - 2c_{N+1} = \\frac{2hj}{D} \\implies c_{N+1} = c_N - \\frac{hj}{D} $$\n现在，我们将 $c_{N+1}$ 的这个表达式代入节点 $i=N$ 处的离散化偏微分方程中：\n$$ c_{N-1} - 2c_N + c_{N+1} = 0 \\implies c_{N-1} - 2c_N + \\left(c_N - \\frac{hj}{D}\\right) = 0 $$\n$$ c_{N-1} - c_N = \\frac{hj}{D} $$\n\n**三对角线性系统**\n关于未知数 $c_1, \\dots, c_N$ 的 $N$ 个线性方程组是：\n$$ -2c_1 + c_2 = -c_0 \\quad (i=1) $$\n$$ c_{i-1} - 2c_i + c_{i+1} = 0 \\quad (i=2, \\dots, N-1) $$\n$$ c_{N-1} - c_N = \\frac{hj}{D} \\quad (i=N) $$\n该系统可以写成 $a_{i} c_{i-1} + b_{i} c_{i} + \\gamma_{i} c_{i+1} = d_{i}$ 的形式，其中我使用 $\\gamma_i$ 表示 $c_{i+1}$ 的系数，以修正问题陈述中的笔误。系数如下：\n- 对于 $i=1$：$a_1 = 0$, $b_1 = -2$, $\\gamma_1 = 1$, $d_1 = -c_0$。\n- 对于 $i=2, \\dots, N-1$：$a_i = 1$, $b_i = -2$, $\\gamma_i = 1$, $d_i = 0$。\n- 对于 $i=N$：$a_N = 1$, $b_N = -1$, $\\gamma_N = 0$, $d_N = \\frac{hj}{D}$。\n条件 $a_1=0$ 和 $\\gamma_N=0$ 得到满足。\n\n**Thomas 算法的推导**\nThomas 算法是用于求解一般三对角系统 $a_{i} c_{i-1} + b_{i} c_{i} + \\gamma_{i} c_{i+1} = d_{i}$（$i=1, \\dots, N$，且 $a_1=0$ 和 $\\gamma_N=0$）的高斯消元法的一种特化形式。\n\n**前向消元：** 目标是通过消去次对角线元素 $a_i$ 将系统转化为上双对角形式。我们寻求 $c_i + \\gamma'_i c_{i+1} = d'_i$ 形式的变换后系统。\n对于 $i=1$，方程为 $b_1 c_1 + \\gamma_1 c_2 = d_1$。除以 $b_1$ 可得：\n$c_1 + \\frac{\\gamma_1}{b_1} c_2 = \\frac{d_1}{b_1}$。\n因此，我们定义 $\\gamma'_1 = \\frac{\\gamma_1}{b_1}$ 和 $d'_1 = \\frac{d_1}{b_1}$。\n\n对于 $i  1$，假设我们有上一步得到的变换后方程：$c_{i-1} + \\gamma'_{i-1} c_i = d'_{i-1}$，可改写为 $c_{i-1} = d'_{i-1} - \\gamma'_{i-1} c_i$。\n第 $i$ 行的原始方程是 $a_i c_{i-1} + b_i c_i + \\gamma_i c_{i+1} = d_i$。\n代入 $c_{i-1}$ 的表达式：\n$a_i (d'_{i-1} - \\gamma'_{i-1} c_i) + b_i c_i + \\gamma_i c_{i+1} = d_i$\n重新整理关于 $c_i$ 的项：\n$(b_i - a_i \\gamma'_{i-1}) c_i + \\gamma_i c_{i+1} = d_i - a_i d'_{i-1}$\n除以 $c_i$ 的新系数：\n$c_i + \\frac{\\gamma_i}{b_i - a_i \\gamma'_{i-1}} c_{i+1} = \\frac{d_i - a_i d'_{i-1}}{b_i - a_i \\gamma'_{i-1}}$\n这给出了修正系数的递推关系：\n$\\gamma'_i = \\frac{\\gamma_i}{b_i - a_i \\gamma'_{i-1}}$ 和 $d'_i = \\frac{d_i - a_i d'_{i-1}}{b_i - a_i \\gamma'_{i-1}}$，对于 $i  1$。\n\n前向消元过程如下：\n1. $\\gamma'_1 = \\frac{\\gamma_1}{b_1}$；$d'_1 = \\frac{d_1}{b_1}$。\n2. 对于 $i=2, \\dots, N-1$：\n   $\\gamma'_i = \\frac{\\gamma_i}{b_i - a_i \\gamma'_{i-1}}$\n   $d'_i = \\frac{d_i - a_i d'_{i-1}}{b_i - a_i \\gamma'_{i-1}}$\n\n**回代：** 前向消元后，最后一个方程只包含 $c_N$。在 $i=N$ 处，$\\gamma_N=0$，所以 $\\gamma'_N=0$。变换后的方程是 $c_N = d'_N$。$i=N$ 的原始方程是 $a_N c_{N-1} + b_N c_N = d_N$。使用 $c_{N-1} = d'_{N-1} - \\gamma'_{N-1} c_N$ 的表达式：\n$a_N (d'_{N-1} - \\gamma'_{N-1} c_N) + b_N c_N = d_N$\n$(b_N - a_N \\gamma'_{N-1}) c_N = d_N - a_N d'_{N-1}$\n$c_N = \\frac{d_N - a_N d'_{N-1}}{b_N - a_N \\gamma'_{N-1}}$。\n一旦 $c_N$ 已知，我们就可以通过回代到变换后的方程 $c_i = d'_i - \\gamma'_i c_{i+1}$ 中来找到其他变量。\n\n回代过程如下：\n1. $c_N = \\frac{d_N - a_N d'_{N-1}}{b_N - a_N \\gamma'_{N-1}}$。\n2. 对于 $i = N-1, N-2, \\dots, 1$：\n   $c_i = d'_i - \\gamma'_i c_{i+1}$。\n\n### 第2部分：Thomas 算法的应用\n\n我们将推导出的算法应用于给定的参数：$N=5$，$L=25 \\times 10^{-6}\\,\\text{m}$，$D=2.0 \\times 10^{-10}\\,\\text{m}^{2}\\,\\text{s}^{-1}$，$c_{0}=1000\\,\\text{mol}\\,\\text{m}^{-3}$，以及 $j=1.0 \\times 10^{-4}\\,\\text{mol}\\,\\text{m}^{-2}\\,\\text{s}^{-1}$。\n\n首先，计算网格间距 $h$：\n$$ h = \\frac{L}{N+1} = \\frac{25 \\times 10^{-6}}{5+1} = \\frac{25}{6} \\times 10^{-6}\\,\\text{m} $$\n$5 \\times 5$ 线性系统的系数是：\n- $i=1$：$a_1=0, b_1=-2, \\gamma_1=1, d_1=-c_0 = -1000$。\n- $i=2,3,4$：$a_i=1, b_i=-2, \\gamma_i=1, d_i=0$。\n- $i=5$：$a_5=1, b_5=-1, \\gamma_5=0, d_5=\\frac{hj}{D} = \\frac{(\\frac{25}{6} \\times 10^{-6})(1.0 \\times 10^{-4})}{2.0 \\times 10^{-10}} = \\frac{25 \\times 10^{-10}}{12 \\times 10^{-10}} = \\frac{25}{12}$。\n\n**前向消元：**\n- $i=1$：\n   $\\gamma'_1 = \\frac{\\gamma_1}{b_1} = \\frac{1}{-2} = -0.5$\n   $d'_1 = \\frac{d_1}{b_1} = \\frac{-1000}{-2} = 500$\n- $i=2$：\n   $\\gamma'_2 = \\frac{\\gamma_2}{b_2 - a_2 \\gamma'_1} = \\frac{1}{-2 - 1(-0.5)} = \\frac{1}{-1.5} = -\\frac{2}{3}$\n   $d'_2 = \\frac{d_2 - a_2 d'_1}{b_2 - a_2 \\gamma'_1} = \\frac{0 - 1(500)}{-1.5} = \\frac{1000}{3}$\n- $i=3$：\n   $\\gamma'_3 = \\frac{\\gamma_3}{b_3 - a_3 \\gamma'_2} = \\frac{1}{-2 - 1(-\\frac{2}{3})} = \\frac{1}{-\\frac{4}{3}} = -\\frac{3}{4}$\n   $d'_3 = \\frac{d_3 - a_3 d'_2}{b_3 - a_3 \\gamma'_2} = \\frac{0 - 1(\\frac{1000}{3})}{-\\frac{4}{3}} = \\frac{1000}{4} = 250$\n- $i=4$：\n   $\\gamma'_4 = \\frac{\\gamma_4}{b_4 - a_4 \\gamma'_3} = \\frac{1}{-2 - 1(-\\frac{3}{4})} = \\frac{1}{-\\frac{5}{4}} = -\\frac{4}{5}$\n   $d'_4 = \\frac{d_4 - a_4 d'_3}{b_4 - a_4 \\gamma'_3} = \\frac{0 - 1(250)}{-\\frac{5}{4}} = \\frac{1000}{5} = 200$\n\n**回代：**\n首先，计算 $c_5$：\n$$ c_5 = \\frac{d_5 - a_5 d'_4}{b_5 - a_5 \\gamma'_4} = \\frac{\\frac{25}{12} - 1(200)}{-1 - 1(-\\frac{4}{5})} = \\frac{\\frac{25-2400}{12}}{-\\frac{1}{5}} = \\frac{-\\frac{2375}{12}}{-\\frac{1}{5}} = \\frac{2375 \\times 5}{12} = \\frac{11875}{12} $$\n接着，计算 $c_4$ 以求出 $c_3$：\n$$ c_4 = d'_4 - \\gamma'_4 c_5 = 200 - (-\\frac{4}{5})\\left(\\frac{11875}{12}\\right) = 200 + \\frac{4 \\times 11875}{5 \\times 12} = 200 + \\frac{11875}{15} = 200 + \\frac{2375}{3} = \\frac{600+2375}{3} = \\frac{2975}{3} $$\n最后，计算 $c_3$：\n$$ c_3 = d'_3 - \\gamma'_3 c_4 = 250 - (-\\frac{3}{4})\\left(\\frac{2975}{3}\\right) = 250 + \\frac{3 \\times 2975}{4 \\times 3} = 250 + \\frac{2975}{4} = \\frac{1000+2975}{4} = \\frac{3975}{4} = 993.75 $$\n问题要求将答案四舍五入到四位有效数字。\n$$ c_3 = 993.75 \\approx 993.8 $$\n浓度的单位是 $\\text{mol}\\,\\text{m}^{-3}$。\n该问题的解析解是 $c(x) = c_0 - \\frac{j}{D}x$。对于此线性分布，该数值方法是精确的，$c_3 = c(3h) = 1000 - \\frac{10^{-4}}{2 \\times 10^{-10}} \\times 3 \\times \\frac{25 \\times 10^{-6}}{6} = 1000 - 6.25 = 993.75$ 的计算值证实了结果的正确性。",
            "answer": "$$\\boxed{993.8}$$"
        },
        {
            "introduction": "我们如何确定我们的代码正确地求解了目标偏微分方程，例如瞬态扩散方程 $u_t = \\alpha u_{xx}$？本练习介绍了“制造解方法”（Method of Manufactured Solutions, MMS），这是一种强大的代码验证技术。您将实现稳健的克兰克-尼科尔森（Crank-Nicolson）格式，并使用MMS严格地验证您的实现是否在时间上达到了其理论上的二阶精度。",
            "id": "3914357",
            "problem": "考虑电解质板中锂离子浓度的一维扩散，这是自动化电池设计和仿真中使用的标准简化方法。其控制偏微分方程 (PDE) 是一维空间中的 Fick 第二定律，形式为 $u_t = \\alpha u_{xx}$，定义在空间域 $x \\in [0,L]$ 和时间区间 $t \\in [0,T]$ 上，其中 $u(x,t)$ 是浓度，$\\alpha$ 是扩散系数，$L$ 是板的厚度，$T$ 是最终时间。在本问题中，使用制造解 (Manufactured Solution, MS) 方法来验证 Crank–Nicolson (CN) 格式的时间精度。Crank–Nicolson 格式是一种二阶隐式时间步进方法。\n\n您必须构建测试，以使空间离散误差相对于时间误差可以忽略不计。为实现此目的，请使用足够精细的空间网格。定义制造解\n$$\nu(x,t) = \\cos\\!\\left(\\frac{2\\pi x}{L}\\right)\\exp(-\\gamma t),\n$$\n其中\n$$\n\\gamma = \\alpha\\left(\\frac{2\\pi}{L}\\right)^2.\n$$\n这一选择确保了 $u_t = \\alpha u_{xx}$ 精确成立，因此不需要源项。施加与制造解一致的 Dirichlet 边界条件，即 $u(0,t) = \\exp(-\\gamma t)$ 和 $u(L,t) = \\exp(-\\gamma t)$，以及初始条件 $u(x,0) = \\cos\\!\\left(\\frac{2\\pi x}{L}\\right)$。\n\n使用均匀网格对空间进行离散，并采用二阶中心差分格式近似 $u_{xx}$；使用 Crank–Nicolson 方法对时间进行离散。对于内部网格索引 $j$ 和时间步 $n$，CN 更新格式为\n$$\n\\frac{u_j^{n+1} - u_j^n}{\\Delta t} = \\alpha\\frac{1}{2}\\left[\\frac{u_{j+1}^{n+1} - 2u_j^{n+1} + u_{j-1}^{n+1}}{\\Delta x^2} + \\frac{u_{j+1}^{n} - 2u_j^{n} + u_{j-1}^{n}}{\\Delta x^2}\\right],\n$$\n其中 $\\Delta x$ 和 $\\Delta t$ 分别是空间和时间步长。在每个时间层级，对 $j=0$ 和 $j=J$（其中 $J$ 是右边界的索引）使用精确的边界值，因此在每个 CN 步组装线性系统时，边界的贡献被视为已知值。\n\n为评估时间精度，计算最终时间 $t = T$ 时内部节点上的离散 $\\mathrm{L}^2$ 误差，\n$$\nE(\\Delta t) = \\sqrt{\\Delta x\\sum_{j=1}^{J-1}\\left(u_j^{\\text{num}}(T) - u(x_j,T)\\right)^2},\n$$\n其中 $u_j^{\\text{num}}(T)$ 是内部网格点上的数值解，$u(x_j,T)$ 是在这些点上计算的精确制造解。通过对模型 $\\log E(\\Delta t) = p \\log \\Delta t + C$（其中 $C$ 为某个常数）进行最小二乘拟合，来估计观测到的时间精度阶数 $p$。此过程使用多个加密的 $\\Delta t$ 值，同时保持 $\\Delta x$ 固定且足够小，以使空间误差可以忽略。\n\n您的程序必须实现上述方法，并为下面定义的每个测试用例计算 $p$。空间和时间离散化带有物理单位，以反映与电池相关的工况；然而，最终报告的观测精度阶数 $p$ 是无量纲的。所有带有物理单位的量必须按规定一致使用，但最终输出应为无单位的浮点数。\n\n使用以下测试套件，其设计旨在覆盖典型行为、一个更刚性的工况以及一个较粗空间网格的边界情况：\n- 测试用例 1（基准）：$L = 1\\times 10^{-4}\\,\\text{m}$，$\\alpha = 1\\times 10^{-10}\\,\\text{m}^2/\\text{s}$，$T = 1\\times 10^{-1}\\,\\text{s}$，空间网格点数 $N_x = 401$（包括边界），以及时间步长加密 $\\Delta t \\in \\{1.25\\times 10^{-2}, 6.25\\times 10^{-3}, 3.125\\times 10^{-3}, 1.5625\\times 10^{-3}\\}\\,\\text{s}$。\n- 测试用例 2（更刚性的扩散）：$L = 1\\times 10^{-4}\\,\\text{m}$，$\\alpha = 5\\times 10^{-10}\\,\\text{m}^2/\\text{s}$，$T = 1\\times 10^{-1}\\,\\text{s}$，$N_x = 401$，以及与测试用例 1 相同的时间步长加密。\n- 测试用例 3（较粗空间网格的边界情况）：$L = 1\\times 10^{-4}\\,\\text{m}$，$\\alpha = 1\\times 10^{-10}\\,\\text{m}^2/\\text{s}$，$T = 1\\times 10^{-1}\\,\\text{s}$，$N_x = 101$，以及与测试用例 1 相同的时间步长加密。\n\n对于每个测试用例，通过对所有指定的 $\\Delta t$ 值的 $(\\log \\Delta t, \\log E(\\Delta t))$ 数据进行线性回归，将观测到的阶数 $p$ 计算为单个浮点数。您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果，结果顺序为测试用例 1、2 和 3（例如，$[p_1,p_2,p_3]$）。输出 $p_1$、$p_2$ 和 $p_3$ 必须是无单位的浮点数。角度单位与本问题无关。百分比不适用；仅报告浮点数值。",
            "solution": "本问题的目标是数值验证应用于一维扩散方程的 Crank-Nicolson (CN) 格式的时间精度阶数。这是通过使用制造解方法 (Method of Manufactured Solutions, MMS) 来实现的，这是一种在代码验证中使用的严谨技术。浓度 $u(x,t)$ 的控制偏微分方程 (PDE) 是 Fick 第二定律：\n$$\n\\frac{\\partial u}{\\partial t} = \\alpha \\frac{\\partial^2 u}{\\partial x^2}\n$$\n该方程定义在空间域 $x \\in [0, L]$ 和时间 $t \\in [0, T]$ 上。参数 $\\alpha$ 是扩散系数。\n\nCrank-Nicolson 格式是一种在时间和空间上均为二阶精度的有限差分方法。它是通过对当前时间层 $n$ 和未来时间层 $n+1$ 的空间导数项进行平均而推导出来的。对于间距为 $\\Delta x$ 的均匀空间网格和步长为 $\\Delta t$ 的均匀时间网格，PDE 在内部空间节点 $j$ 处的离散化由以下公式给出：\n$$\n\\frac{u_j^{n+1} - u_j^n}{\\Delta t} = \\frac{\\alpha}{2} \\left( \\frac{u_{j+1}^{n+1} - 2u_j^{n+1} + u_{j-1}^{n+1}}{\\Delta x^2} + \\frac{u_{j+1}^{n} - 2u_j^{n} + u_{j-1}^{n}}{\\Delta x^2} \\right)\n$$\n其中 $u_j^n \\approx u(x_j, t_n)$。为了简化此表达式，我们引入无量纲扩散数 $\\lambda = \\frac{\\alpha \\Delta t}{2 \\Delta x^2}$。然后我们重新整理方程，将所有未知项（在时间层 $n+1$）归到左侧 (LHS)，所有已知项（在时间层 $n$）归到右侧 (RHS)：\n$$\n-\\lambda u_{j-1}^{n+1} + (1+2\\lambda) u_j^{n+1} - \\lambda u_{j+1}^{n+1} = \\lambda u_{j-1}^{n} + (1-2\\lambda) u_j^n + \\lambda u_{j+1}^{n}\n$$\n该方程适用于所有内部网格点，即 $j = 1, 2, \\dots, J-1$，其中 $J$ 是最右侧网格点 $x_J = L$ 的索引。这构成了关于时间 $t_{n+1}$ 时 $J-1$ 个未知内部浓度的 $J-1$ 个线性方程组。\n\n该方程组可以写成矩阵形式 $A \\mathbf{u}_{\\text{int}}^{n+1} = \\mathbf{b}^n$，其中 $\\mathbf{u}_{\\text{int}}^{n+1}$ 是内部节点处的未知浓度向量，即 $[u_1^{n+1}, u_2^{n+1}, \\dots, u_{J-1}^{n+1}]^T$。矩阵 $A$ 是一个三对角矩阵，主对角线上的元素为 $(1+2\\lambda)$，次对角线和超对角线上的元素为 $-\\lambda$。\n问题指定了 Dirichlet 边界条件 $u(0,t)$ 和 $u(L,t)$，它们是时间的已知函数。在每个时间步，边界值 $u_0^{n+1}$ 和 $u_J^{n+1}$ 是已知的。来自 $j=1$ 和 $j=J-1$ 方程左侧的这些项被移到右侧。由此产生的右侧向量 $\\mathbf{b}^n$ 由前一时间步的解 $\\mathbf{u}^n$ 以及在 $t_n$ 和 $t_{n+1}$ 处的已知边界值构成。由于矩阵 $A$ 在整个仿真过程中是恒定的，因此它只构建一次。在每个时间步，计算右侧向量 $\\mathbf{b}^n$，并高效地求解三对角系统以找到下一时间步的解。\n\n为了验证时间精度，我们采用制造解 (MS)：\n$$\nu(x,t) = \\cos\\left(\\frac{2\\pi x}{L}\\right)\\exp(-\\gamma t) \\quad \\text{with} \\quad \\gamma = \\alpha\\left(\\frac{2\\pi}{L}\\right)^2\n$$\n该函数被构造为偏微分方程 $u_t = \\alpha u_{xx}$ 的精确解。此制造解用于为数值模拟推导一致的初始和边界条件：\n- 初始条件：$u(x,0) = \\cos\\left(\\frac{2\\pi x}{L}\\right)$\n- 边界条件：$u(0,t) = u(L,t) = \\exp(-\\gamma t)$\n\n数值模拟从 $t=0$ 运行到最终时间 $T$。然后将得到的数值解 $u_j^{\\text{num}}(T)$ 与精确的制造解 $u(x_j,T)$ 进行比较。误差通过内部节点上的离散 $L^2$ 范数进行量化：\n$$\nE(\\Delta t) = \\sqrt{\\Delta x \\sum_{j=1}^{J-1} \\left(u_j^{\\text{num}}(T) - u(x_j,T)\\right)^2}\n$$\n对于一个时间精度阶数为 $p$ 的方法，在空间误差可以忽略的情况下，误差预计表现为 $E(\\Delta t) \\approx C(\\Delta t)^p$，其中 $C$ 是某个常数。通过对该关系式取对数，我们得到一个线性方程：\n$$\n\\log E(\\Delta t) \\approx \\log C + p \\log \\Delta t\n$$\n通过对一系列使用递减时间步长 $\\Delta t$ 的模拟所获得的数据点 $(\\log \\Delta t, \\log E)$ 进行线性拟合，其斜率即为观测到的精度阶数 $p$。\n\n每个测试用例的总体算法流程如下：\n1. 初始化物理和数值参数（$L$、$\\alpha$、$T$、$N_x$ 以及一组 $\\Delta t$ 值）。空间网格是固定的。\n2. 对于集合中的每个 $\\Delta t$：\n    a. 使用 $t=0$ 时的制造解设置初始条件。\n    b. 构建恒定的三对角左侧矩阵 $A$。\n    c. 从 $t=0$ 到 $t=T$ 进行时间步进。在每一步中，计算右侧向量 $\\mathbf{b}^n$ 并求解线性系统以获得下一时间步的解。\n    d. 在 $t=T$ 时，通过将数值解与制造解进行比较，计算离散 $L^2$ 误差 $E(\\Delta t)$。\n3. 收集所有模拟的配对数据 $(\\log \\Delta t, \\log E(\\Delta t))$。\n4. 对这些数据点进行线性最小二乘回归，以找到斜率，即观测到的精度阶数 $p$。\n对三个指定的测试用例重复此过程，这些用例旨在探究不同的扩散工况和网格分辨率。该问题的设计使得前两个用例中的空间网格足够精细，以便清晰地测量时间阶数，对于 Crank-Nicolson 格式，理论上的时间阶数是 $p=2$。第三个用例使用较粗的网格，以研究空间误差污染测量结果的可能性。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import solve_banded\n\ndef compute_order_p(L, alpha, T, Nx, dt_values):\n    \"\"\"\n    Computes the observed temporal order of accuracy for the Crank-Nicolson scheme.\n\n    Args:\n        L (float): Length of the spatial domain.\n        alpha (float): Diffusion coefficient.\n        T (float): Final time.\n        Nx (int): Number of spatial grid points.\n        dt_values (list): List of time step sizes for convergence study.\n\n    Returns:\n        float: The observed order of accuracy, p.\n    \"\"\"\n    # 1. Derived constants and spatial grid setup\n    gamma = alpha * (2 * np.pi / L)**2\n    \n    J = Nx - 1\n    dx = L / J\n    x_coords = np.linspace(0, L, Nx)\n    num_interior_points = Nx - 2\n    \n    log_errors = []\n    log_dts = np.log(np.array(dt_values))\n\n    # Define the Manufactured Solution (MS)\n    def u_exact(x, t):\n        return np.cos(2 * np.pi * x / L) * np.exp(-gamma * t)\n\n    # 2. Loop through each time step size to collect error data\n    for dt in dt_values:\n        # Simulation parameters for the current refinement\n        Nt = int(round(T / dt))\n        lam = alpha * dt / (2 * dx**2)  # Crank-Nicolson parameter\n        \n        # Initial condition from MS at t=0\n        t_current = 0.0\n        u_current = u_exact(x_coords, t_current)\n        \n        # LHS matrix A, in banded format for scipy.linalg.solve_banded\n        # It is constant for all time steps.\n        A_banded = np.zeros((3, num_interior_points))\n        A_banded[0, 1:] = -lam      # Upper diagonal (u_{j+1})\n        A_banded[1, :] = 1 + 2 * lam # Main diagonal (u_j)\n        A_banded[2, :-1] = -lam     # Lower diagonal (u_{j-1})\n        \n        # 3. Time-stepping loop\n        for n in range(Nt):\n            t_next = (n + 1) * dt\n            \n            # Known boundary values at the next time step from MS\n            u0_next = np.exp(-gamma * t_next) # u at x=0\n            uL_next = np.exp(-gamma * t_next) # u at x=L\n\n            # Construct the RHS vector b\n            # Start with the known stencil application on u_current\n            b = lam * u_current[0:-2] + \\\n                (1 - 2 * lam) * u_current[1:-1] + \\\n                lam * u_current[2:]\n            \n            # Add boundary contributions from the implicit part (LHS)\n            b[0] += lam * u0_next\n            b[-1] += lam * uL_next\n            \n            # Solve the tridiagonal system for interior points at t_next\n            u_interior_next = solve_banded((1, 1), A_banded, b)\n            \n            # Update the full solution vector for the next iteration\n            u_current[1:-1] = u_interior_next\n            u_current[0] = u0_next\n            u_current[-1] = uL_next\n            \n        # 4. At final time T, compute the L2 error\n        u_numerical_T = u_current\n        u_exact_T = u_exact(x_coords, T)\n        \n        # Error is computed over interior nodes only\n        diff_interior = u_numerical_T[1:-1] - u_exact_T[1:-1]\n        error = np.sqrt(dx * np.sum(diff_interior**2))\n        log_errors.append(np.log(error))\n\n    # 5. Perform linear regression on (log(dt), log(E)) to find the slope p\n    # np.polyfit with deg=1 returns [slope, intercept]\n    p, _ = np.polyfit(log_dts, log_errors, 1)\n    \n    return p\n\ndef solve():\n    \"\"\"\n    Main function to run the test cases and print the results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    dt_refinements = [1.25e-2, 6.25e-3, 3.125e-3, 1.5625e-3]\n    \n    test_cases = [\n        # (L, alpha, T, Nx, dt_values)\n        (1e-4, 1e-10, 1e-1, 401, dt_refinements),  # Case 1: Baseline\n        (1e-4, 5e-10, 1e-1, 401, dt_refinements),  # Case 2: Stiffer diffusion\n        (1e-4, 1e-10, 1e-1, 101, dt_refinements),  # Case 3: Coarser spatial grid\n    ]\n\n    results = []\n    for case_params in test_cases:\n        p = compute_order_p(*case_params)\n        results.append(p)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.10f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}