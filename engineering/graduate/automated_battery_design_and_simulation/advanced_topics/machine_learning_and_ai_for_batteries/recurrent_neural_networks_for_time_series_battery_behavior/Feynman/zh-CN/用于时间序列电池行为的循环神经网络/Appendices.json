{
    "hands_on_practices": [
        {
            "introduction": "掌握循环神经网络（RNN）的第一步是理解其内部结构。通过从基本原理出发推导模型参数的数量，您可以具体了解输入、隐藏和输出维度如何共同决定模型的规模和计算成本。这个练习将帮助您建立评估模型复杂度的数学基础，这对于为大型电池组等实际应用设计高效的网络至关重要 。",
            "id": "3945270",
            "problem": "您正在设计一个单层循环神经网络 (RNN) 模块，用于在自动化电池设计和仿真流程中对时间序列行为进行建模。该模块接收一个时间索引的输入向量 $x_t \\in \\mathbb{R}^{d}$，该向量聚合了传感器和控制特征；维护一个隐藏状态 $h_t \\in \\mathbb{R}^{m}$，表示学习到的电池动态；并输出 $y_t \\in \\mathbb{R}^{p}$，用于下游目标，如电压、温度和老化代理指标。该 RNN 使用标准的循环结构，其中包含一个静态非线性函数 $\\phi$。此函数由线性映射和偏置移位的复合给出，并在每个时间步应用：\n$$\nh_t = \\phi\\!\\left(W_{xh}\\,x_t + W_{hh}\\,h_{t-1} + b_h\\right), \\quad y_t = W_{hy}\\,h_t + b_y.\n$$\n在这里，$W_{xh}$、$W_{hh}$、$W_{hy}$ 是实值权重矩阵，$b_h$、$b_y$ 是实值偏置向量。假设这些仿射分量中的每一个都是独立参数化的，并且 $\\phi$ 没有可训练的参数。仅从线性映射、仿射变换以及矩阵-向量乘积中的维度一致性的定义出发，推导该单层 RNN 中可训练标量参数总数的封闭形式表达式（用 $d$、$m$ 和 $p$ 表示）。\n\n然后，考虑一个科学上真实的多输入多输出 (MIMO) 电池建模场景：在每个时间步，输入由每个电芯的特征和电池包级别的特征拼接而成。假设有 $n_c$ 个电芯，每个电芯提供 $f$ 个特征（例如，电流、电压、温度、阻抗估计值），并且有 $g$ 个电池包级别的特征（例如，环境条件、电池包电流设定点、监控控制标志），因此输入维度满足 $d = n_c f + g$。假设输出包括每个电芯的 $r$ 个量（例如，预测的下一步电压和温度）和 $q$ 个电池包级别的输出（例如，电池包电压和热裕度），因此输出维度满足 $p = n_c r + q$。使用这些关系，讨论总参数数量如何随 $n_c$、$f$、$g$、$r$、$q$ 和 $m$ 变化，并确定在 $n_c$ 很大且 $m$ 被视为固定或与 $n_c$ 成比例的情况下，起主导作用的项。\n\n以 $d$、$m$ 和 $p$ 表示的总可训练参数数量的单个封闭形式符号表达式的形式提供最终答案。不需要进行数值评估，并且由于该量为参数计数，因此不适用任何物理单位。不要四舍五入。",
            "solution": "问题陈述已经过验证，被认为是合理的。它具有科学依据，问题定义明确，客观且内部一致。它基于单层循环神经网络 (RNN) 的标准定义提出了一个可形式化的问题，并要求推导其参数数量，这是机器学习中的一个标准且可验证的过程。\n\n神经网络中可训练标量参数的总数是其每个独立、可训练组件中参数数量的总和。问题陈述指出，权重矩阵 $W_{xh}$、$W_{hh}$、$W_{hy}$ 和偏置向量 $b_h$、$b_y$ 是可训练的组件。非线性函数 $\\phi$ 被指定为没有可训练的参数。我们根据一致的矩阵-向量运算所需的维度来推导每个组件的参数数量。\n\n状态更新方程由下式给出：\n$$h_t = \\phi\\!\\left(W_{xh}\\,x_t + W_{hh}\\,h_{t-1} + b_h\\right)$$\n输出方程为：\n$$y_t = W_{hy}\\,h_t + b_y$$\n\n让我们分析每个组件的维度。\n输入向量为 $x_t \\in \\mathbb{R}^{d}$，可以表示为维度为 $d \\times 1$ 的列向量。\n隐藏状态向量为 $h_t \\in \\mathbb{R}^{m}$（以及 $h_{t-1} \\in \\mathbb{R}^{m}$），表示为维度为 $m \\times 1$ 的列向量。\n输出向量为 $y_t \\in \\mathbb{R}^{p}$，表示为维度为 $p \\times 1$ 的列向量。\n\n$1$. 输入到隐藏层转换的参数：项 $W_{xh}\\,x_t$ 涉及矩阵 $W_{xh}$ 和向量 $x_t$ 的乘积。为了使该乘积是 $\\mathbb{R}^{m}$ 中的一个向量（这样它才能与 $\\phi$ 括号内的其他项相加），并且给定 $x_t$ 的维度为 $d \\times 1$，矩阵 $W_{xh}$ 的维度必须是 $m \\times d$。因此，$W_{xh}$ 中的标量参数数量为 $m \\times d$。\n\n$2$. 隐藏层到隐藏层转换的参数：项 $W_{hh}\\,h_{t-1}$ 涉及矩阵 $W_{hh}$ 和向量 $h_{t-1}$ 的乘积。为了使该乘积是 $\\mathbb{R}^{m}$ 中的一个向量，并且给定 $h_{t-1}$ 的维度为 $m \\times 1$，矩阵 $W_{hh}$ 必须是维度为 $m \\times m$ 的方阵。因此，$W_{hh}$ 中的标量参数数量为 $m \\times m = m^2$。\n\n$3$. 隐藏状态偏置的参数：偏置向量 $b_h$ 被加到和 $W_{xh}\\,x_t + W_{hh}\\,h_{t-1}$ 上。这个和是 $\\mathbb{R}^{m}$ 中的一个向量。因此，$b_h$ 也必须是 $\\mathbb{R}^{m}$ 中的一个向量，维度为 $m \\times 1$。$b_h$ 中的标量参数数量为 $m$。\n\n$4$. 隐藏层到输出层转换的参数：项 $W_{hy}\\,h_t$ 涉及矩阵 $W_{hy}$ 和向量 $h_t$ 的乘积。这个乘积构成最终输出 $y_t \\in \\mathbb{R}^{p}$ 的一部分。给定 $h_t$ 的维度为 $m \\times 1$，为了使乘积成为 $\\mathbb{R}^p$ 中的一个向量，矩阵 $W_{hy}$ 的维度必须是 $p \\times m$。因此，$W_{hy}$ 中的标量参数数量为 $p \\times m$。\n\n$5$. 输出偏置的参数：偏置向量 $b_y$ 被加到项 $W_{hy}\\,h_t$ 上以产生最终输出 $y_t \\in \\mathbb{R}^{p}$。因此，$b_y$ 也必须是 $\\mathbb{R}^{p}$ 中的一个向量，维度为 $p \\times 1$。$b_y$ 中的标量参数数量为 $p$。\n\n可训练参数的总数，记为 $N_{\\text{params}}$，是这五个组件参数的总和：\n$$N_{\\text{params}} = (W_{xh} \\text{中的参数}) + (W_{hh} \\text{中的参数}) + (b_h \\text{中的参数}) + (W_{hy} \\text{中的参数}) + (b_y \\text{中的参数})$$\n$$N_{\\text{params}} = (md) + (m^2) + (m) + (pm) + (p)$$\n这个表达式可以重新排列以更好地对各项进行分组。隐藏状态更新涉及的参数是 $m^2 + md + m$。输出生成涉及的参数是 $mp + p$。将这些相加得到总数。一个方便的因式分解是：\n$$N_{\\text{params}} = m(m+d+1) + p(m+1)$$\n\n接下来，我们讨论电池建模场景的规模缩放分析。输入维度 $d$ 和输出维度 $p$ 由下式给出：\n$$d = n_c f + g$$\n$$p = n_c r + q$$\n其中 $n_c$ 是电芯的数量，$f, g, r, q$ 是表示特征数量的常数。\n\n我们将这些代入 $N_{\\text{params}}$ 的表达式中：\n$$N_{\\text{params}} = m^2 + m(n_c f + g) + m(n_c r + q) + m + (n_c r + q)$$\n展开并按 $n_c$ 的幂次对项进行分组，我们得到：\n$$N_{\\text{params}} = m f n_c + m g + m r n_c + m q + m^2 + m + r n_c + q$$\n$$N_{\\text{params}} = (mf + mr + r)n_c + (m^2 + mg + mq + m + q)$$\n\n我们现在分析隐藏维度 $m$ 在两种情况下的规模缩放行为。\n\n情况 1：$m$ 是一个固定的常数。\n在这种情况下，$m, f, g, r, q$ 都被认为是常数。$N_{\\text{params}}$ 的表达式是 $n_c$ 的线性函数。对于大的 $n_c$，主导项是与 $n_c$ 呈线性的项。总参数数量的规模缩放如下：\n$$N_{\\text{params}} \\sim (mf + mr + r)n_c$$\n因此，参数数量与电芯数量呈线性关系，即 $N_{\\text{params}} = \\mathcal{O}(n_c)$。\n\n情况 2：$m$ 与 $n_c$ 成正比。\n令 $m = k n_c$，其中 $k$ 是某个正常数比例因子。我们将 $m=kn_c$ 代入按组件分组的 $N_{\\text{params}}$ 表达式中：\n$$N_{\\text{params}} = m^2 + m d + m p + m + p$$\n$$N_{\\text{params}} = (k n_c)^2 + (k n_c)(n_c f + g) + (k n_c)(n_c r + q) + (k n_c) + (n_c r + q)$$\n展开乘积：\n$$N_{\\text{params}} = k^2 n_c^2 + (k f n_c^2 + k g n_c) + (k r n_c^2 + k q n_c) + k n_c + r n_c + q$$\n按 $n_c$ 的幂次对项进行分组：\n$$N_{\\text{params}} = (k^2 + kf + kr)n_c^2 + (kg + kq + k + r)n_c + q$$\n这是 $n_c$ 的二次函数。对于大的 $n_c$，主导项是含有 $n_c^2$ 的项。总参数数量的规模缩放如下：\n$$N_{\\text{params}} \\sim (k^2 + kf + kr)n_c^2$$\n因此，参数数量与电芯数量呈二次关系，即 $N_{\\text{params}} = \\mathcal{O}(n_c^2)$。二次规模缩放源于循环权重矩阵 $W_{hh}$（贡献 $m^2 \\rightarrow k^2 n_c^2$）以及输入/输出权重矩阵 $W_{xh}$ 和 $W_{hy}$（贡献 $md \\rightarrow kfn_c^2$ 和 $mp \\rightarrow krn_c^2$）。\n\n所要求的最终答案是关于通用维度 $d$、$m$ 和 $p$ 的总参数数量的封闭形式表达式。",
            "answer": "$$\n\\boxed{m(d+m+1) + p(m+1)}\n$$"
        },
        {
            "introduction": "在定义了模型架构之后，我们必须严格评估其预测能力。这个过程对于像电池循环这样的时间序列数据提出了独特的挑战，因为标准交叉验证方法可能会无意中“泄露”来自未来的信息，从而导致过于乐观的性能评估。本练习旨在阐述并实施一种正确的时间序列验证方案，通过建立严格的时间顺序来防止数据泄露，从而确保对模型泛化能力的评估是可靠且有意义的 。",
            "id": "3945230",
            "problem": "您正在开发一个循环神经网络 (RNN)，作为自动化电池设计和仿真流水线的一部分，用于预测锂离子电池在不同占空比下的每周期容量衰减。对于电池索引 $i \\in \\{1,\\dots,N\\}$ 和周期索引 $t \\in \\{1,\\dots,T_i\\}$，设周期内时间序列为 $(I_{i,t,k}, V_{i,t,k}, \\Theta_{i,t,k})$，其中样本索引 $k \\in \\{1,\\dots,K_{i,t}\\}$，分别表示电流、电压和核心温度。定义目标为下一周期的容量衰减 $\\Delta C_{i,t+1} = C_{i,t} - C_{i,t+1}$，模型为一个映射 $f_{\\theta}$，它接收截至周期 $t$ 的每周期特征的窗口化序列，以生成 $\\hat{\\Delta C}_{i,t+1}$。设信息流 $(\\mathcal{F}_{i,t})_{t \\ge 0}$ 表示由电池 $i$ 截至并包括周期 $t$ 的所有观测变量生成的 $\\sigma$-代数，即 $\\mathcal{F}_{i,t} = \\sigma\\left(\\{(I_{i,s,\\cdot}, V_{i,s,\\cdot}, \\Theta_{i,s,\\cdot}, C_{i,s}): 1 \\le s \\le t\\}\\right)$。一个用于 $\\Delta C_{i,t+1}$ 的无泄漏预测器必须满足相对于 $\\mathcal{F}_{i,t}$ 的可测性，并且任何旨在估计对未来周期的泛化能力的训练-测试集划分，在周期 $t$ 进行验证时，都必须确保训练折不包含相对于 $\\mathcal{F}_{i,t+1}$ 或更高阶信息流可测的信息。\n\n从统计学习的角度来看，在验证折上估计的经验风险 $\\hat{R}(\\theta)$ 旨在近似因果数据生成过程下的风险 $R(\\theta) = \\mathbb{E}[\\ell(\\Delta C_{i,t+1}, \\hat{\\Delta C}_{i,t+1})]$，其中 $\\Delta C_{i,t+1}$ 通过电池退化动力学条件依赖于 $\\mathcal{F}_{i,t}$。在周期 $t$ 进行验证时，如果在训练或预处理期间包含任何在 $\\mathcal{F}_{i,t}$ 下不可测的变量，都将构成标签泄漏，并导致 $\\hat{R}(\\theta)$ 相对于 $R(\\theta)$ 产生向下偏差。\n\n考虑以下四种用于跨电池和周期构建训练和验证折的交叉验证和预处理协议，其中窗口长度为 $w \\in \\mathbb{N}$，并应用逐特征标准化。请选择一个选项，该选项指定了一种按时间顺序的划分协议，该协议可以防止未来周期的信息泄漏到训练折中，并确保在任何验证索引下，周期 $t$ 使用的每个特征都相对于 $\\mathcal{F}_{i,t}$ 可测。\n\nA. 随机打乱所有 $(i,t)$ 对。将 $80\\%$ 的周期划分为训练集， $20\\%$ 划分为验证集，不考虑时间。在整个数据集上拟合一个全局标准化器 $g$ (z-score 缩放)，并向 RNN 馈送包含截至并包括 $t+1$ 的每周期特征的窗口化序列 $\\{x_{i,s}\\}_{s=t-w+1}^{t+1}$，以预测 $\\Delta C_{i,t+1}$。\n\nB. 对每个电池进行分组滚动原点交叉验证。对于每个折索引 $\\ell \\in \\{1,\\dots,L\\}$，选择一个每个电池的截止点 $T_i^{(\\ell)}$，满足 $1 \\le T_i^{(\\ell)}  T_i$。定义训练索引 $I_{\\text{train}}^{(\\ell)} = \\{(i,t): 1 \\le t \\le T_i^{(\\ell)}\\}$ 和验证索引 $I_{\\text{val}}^{(\\ell)} = \\{(i,t): T_i^{(\\ell)}  t \\le \\min(T_i, T_i^{(\\ell)} + \\Delta)\\}$，其中预测范围为 $\\Delta \\in \\mathbb{N}$。仅使用 $\\{x_{i,s}: (i,s) \\in I_{\\text{train}}^{(\\ell)}\\}$ 拟合逐特征标准化器 $g^{(\\ell)}$，并用 $g^{(\\ell)}$ 转换训练集和验证集。在验证周期 $t$ 将输入严格构造为 $\\{x_{i,s}\\}_{s=t-w+1}^{t}$，以便每个 $x_{i,s}$ 都是 $\\mathcal{F}_{i,s}$-可测的，并仅在 $I_{\\text{train}}^{(\\ell)}$ 上训练 $f_{\\theta}$。对于折 $\\ell$，来自周期 $t' > T_i^{(\\ell)}$ 的数据不进入任何训练操作。\n\nC. 在每个电池内进行“留一周期”交叉验证。对于电池 $i$ 的一个验证周期 $t$，使用训练集 $\\{(i,t'): t' \\in \\{1,\\dots,T_i\\} \\setminus \\{t\\}\\}$ 以及其他所有电池的全部周期。在训练集上拟合标准化器，并为验证构建输入 $\\{x_{i,s}\\}_{s=t-w+1}^{t}$。对所有周期重复此过程。将得到的平均验证误差视为交叉验证的估计值。\n\nD. 跨电池进行分组K折交叉验证。将电池集合划分为 $K$ 个不相交的子集，在 $K-1$ 个子集的周期上进行训练，并在保留子集的所有周期上进行验证。在训练电池上拟合一个全局标准化器 $g$，并为保留电池的验证周期构建输入 $\\{x_{i,s}\\}_{s=t-w+1}^{t}$。对每个子集重复此过程并平均验证误差。\n\n哪个选项是正确的？",
            "solution": "问题要求我们为电池退化数据的时间序列预测任务确定正确的交叉验证和预处理协议。核心约束是防止数据泄漏，特别是要确保对未来状态的任何预测都仅基于过去可用的信息。这一点通过以下要求得以形式化：容量衰减 $\\Delta C_{i,t+1}$ 的预测器必须相对于信息流 $\\mathcal{F}_{i,t}$ 可测，该信息流代表了电池 $i$ 截至并包括周期 $t$ 的所有信息。任何有效的协议都必须在数据划分为训练集和验证集以及特征标准化等任何预处理步骤中遵守此时间顺序约束。\n\n让我们根据这个原则分析每个选项。\n\n**A. 随机打乱所有 $(i,t)$ 对。将 $80\\%$ 的周期划分为训练集， $20\\%$ 划分为验证集，不考虑时间。在整个数据集上拟合一个全局标准化器 $g$ (z-score 缩放)，并向 RNN 馈送包含截至并包括 $t+1$ 的每周期特征的窗口化序列 $\\{x_{i,s}\\}_{s=t-w+1}^{t+1}$，以预测 $\\Delta C_{i,t+1}$。**\n\n该协议因三个明显的原因无效：\n1.  **非时间顺序划分：** 随机打乱数据点 $(i,t)$ 破坏了数据的时间结构。对于一个验证数据点 $(i,t)$，训练集将包含数据点 $(i, s)$，其中 $s > t$。这意味着模型在相对于验证点而言的未来数据上进行了训练，这是一种严重的数据泄漏形式。目标是“估计对未来周期的泛化能力”，这在随机划分的情况下是不可能实现的。\n2.  **泄漏的预处理：** 在整个数据集（训练集和验证集结合）上拟合标准化器 $g$ 意味着来自验证集的统计信息（例如，均值和标准差）被用于转换训练集。这是一种众所周知的数据泄漏形式，会导致过于乐观的性能估计。\n3.  **泄漏的特征：** 输入序列被指定为 $\\{x_{i,s}\\}_{s=t-w+1}^{t+1}$ 以预测 $\\Delta C_{i,t+1}$。目标 $\\Delta C_{i,t+1}$ 是周期 $t$ 和 $t+1$ 处量的函数。用于此目标的预测器，在周期 $t$ 结束时使用，必须是 $\\mathcal{F}_{i,t}$-可测的。然而，输入包含了来自周期 $t+1$ 的特征，即 $x_{i,t+1}$。由于 $x_{i,t+1}$ 是 $\\mathcal{F}_{i,t+1}$-可测的但不是 $\\mathcal{F}_{i,t}$-可测的，将其用作输入构成了使用在预测时本不可用的未来信息。这直接违反了问题的核心前提。\n\n因此，该选项是 **错误的**。\n\n**B. 对每个电池进行分组滚动原点交叉验证。对于每个折索引 $\\ell \\in \\{1,\\dots,L\\}$，选择一个每个电池的截止点 $T_i^{(\\ell)}$，满足 $1 \\le T_i^{(\\ell)}  T_i$。定义训练索引 $I_{\\text{train}}^{(\\ell)} = \\{(i,t): 1 \\le t \\le T_i^{(\\ell)}\\}$ 和验证索引 $I_{\\text{val}}^{(\\ell)} = \\{(i,t): T_i^{(\\ell)}  t \\le \\min(T_i, T_i^{(\\ell)} + \\Delta)\\}$，其中预测范围为 $\\Delta \\in \\mathbb{N}$。仅使用 $\\{x_{i,s}: (i,s) \\in I_{\\text{train}}^{(\\ell)}\\}$ 拟合逐特征标准化器 $g^{(\\ell)}$，并用 $g^{(\\ell)}$ 转换训练集和验证集。在验证周期 $t$ 将输入严格构造为 $\\{x_{i,s}\\}_{s=t-w+1}^{t}$，以便每个 $x_{i,s}$ 都是 $\\mathcal{F}_{i,s}$-可测的，并仅在 $I_{\\text{train}}^{(\\ell)}$ 上训练 $f_{\\theta}$。对于折 $\\ell$，来自周期 $t' > T_i^{(\\ell)}$ 的数据不进入任何训练操作。**\n\n该协议正确地实现了时间序列交叉验证的原则：\n1.  **时间顺序划分：** 使用带有截止点 $T_i^{(\\ell)}$ 的“滚动原点”或“前向滚动”划分，确保对于每个电池，训练集在时间上总是先于验证集。这精确地模拟了在真实世界中，模型在过去的数据上训练以预测未来结果的情景。陈述“对于折 $\\ell$，来自周期 $t' > T_i^{(\\ell)}$ 的数据不进入任何训练操作”明确地证实了这一点。\n2.  **正确的预处理：** 每个折的标准化器 $g^{(\\ell)}$ 仅在相应的训练数据 $I_{\\text{train}}^{(\\ell)}$ 上进行拟合。这可以防止任何来自验证集的信息泄漏到训练过程中，从而提供对泛化性能的无偏估计。\n3.  **因果有效的特征：** 用于在周期 $t$ 进行预测的输入被构造为 $\\{x_{i,s}\\}_{s=t-w+1}^{t}$。由于所有特征 $x_{i,s}$ 的周期索引都满足 $s \\le t$，它们可以从截至周期 $t$ 可用的信息中计算得出。因此，整个输入窗口是 $\\mathcal{F}_{i,t}$-可测的，满足了问题的因果性要求。\n\n该协议是评估时间序列模型的标准最佳实践方法。因此，该选项是 **正确的**。\n\n**C. 在每个电池内进行“留一周期”交叉验证。对于电池 $i$ 的一个验证周期 $t$，使用训练集 $\\{(i,t'): t' \\in \\{1,\\dots,T_i\\} \\setminus \\{t\\}\\}$ 以及其他所有电池的全部周期。在训练集上拟合标准化器，并为验证构建输入 $\\{x_{i,s}\\}_{s=t-w+1}^{t}$。对所有周期重复此过程。将得到的平均验证误差视为交叉验证的估计值。**\n\n此协议因违反时间约束而无效。在对电池 $i$ 的周期 $t$ 进行验证时，训练集包括了来自该电池的所有其他周期，包括 $\\{t+1, t+2, \\dots, T_i\\}$。这意味着模型在相对于验证点而言的未来数据上进行了训练。这种前视偏差使得模型能够学习到电池 $i$ 在周期 $t$ 之后的特定退化轨迹，从而导致人为压低的验证误差。估计的风险 $\\hat{R}(\\theta)$ 将无法反映模型在未见过的未来数据上的真实性能。\n\n因此，该选项是 **错误的**。\n\n**D. 跨电池进行分组K折交叉验证。将电池集合划分为 $K$ 个不相交的子集，在 $K-1$ 个子集的周期上进行训练，并在保留子集的所有周期上进行验证。在训练电池上拟合一个全局标准化器 $g$，并为保留电池的验证周期构建输入 $\\{x_{i,s}\\}_{s=t-w+1}^{t}$。对每个子集重复此过程并平均验证误差。**\n\n这个被称为分组K折交叉验证的协议，对于另一个目的是一种有效的技术：估计模型泛化到新的、未见过的*电池*（或组）的能力。然而，问题陈述明确要求一个协议来“估计对*未来周期*的泛化能力”。这需要一个时间验证方案。分组K折方法没有在数据内部强制执行时间顺序划分。一个在保留电池的周期 $t=5$ 上验证的模型，可能已经在来自训练电池的截至周期 $t=200$ 的数据上训练过。如果所有电池都存在任何系统性的随时间变化的效应（例如，测试设备老化、环境条件缓慢变化），这种验证方案将无法捕捉模型外推到未来的能力。主要目标是时间预测，为此时间顺序划分至关重要。此方法测试的是跨实体的泛化能力，而不是跨时间的。\n\n因此，该选项是 **错误的**。\n\n总而言之，只有选项B正确地结合了时间顺序的数据划分、无泄漏的预处理和因果有效的特征构建，使其成为估计模型对未来周期的泛化性能的唯一合适协议。",
            "answer": "$$\\boxed{B}$$"
        },
        {
            "introduction": "本综合练习将理论知识与实际应用相结合，是您学习过程中的一个重要环节。您不仅将构建一个功能性的RNN来预测电池电压降，还将应用一种先进的可解释性技术——积分梯度（Integrated Gradients）——来揭示输入电流曲线的哪些部分对模型的预测影响最大。这项实践旨在将RNN从一个“黑箱”模型转变为一个能够为电池行为提供深刻物理见解的强大工程工具 。",
            "id": "3945227",
            "problem": "考虑一个用于模拟单体锂离子电池放电的离散时间序列，其中时间索引 $t$ 的输入是施加的电流 $x_t$（单位为安培），采样间隔为 $\\Delta t = 1$ 秒。目标是使用单层循环神经网络（RNN）预测最终时间步 $T$ 的电压降，并计算整个输入序列相对于基线输入序列的积分梯度归因。基线代表没有施加电流，定义为对于所有 $t$，$x^{\\text{base}}_t = 0$ 安培。预测目标是时间 $T$ 的标量电压降，以伏特表示。\n\n科学基础：从欧姆定律出发，瞬时电阻压降由线性项 $k \\cdot x_T$ 建模，其中 $k$ 是内部电阻参数，单位为伏特/安培。为了捕捉动态极化和扩散效应，循环神经网络（RNN）将记忆编码在隐藏状态 $h_t$ 中。RNN 使用双曲正切非线性函数 $\\tanh$ 来强制实现有界的潜在动态。设隐藏维度为 $H=3$。RNN 的更新从 $t=0$ 到 $t=T-1$ 进行，如下所示：初始化 $h_0 = \\mathbf{0}$，然后在每个时间步通过对前一个状态和当前输入进行固定的、时不变的线性变换，然后应用 $\\tanh$ 来计算 $h_t$。最终的输出电压降 $y_T$ 是最后一个输入的线性电阻项与最终隐藏状态 $h_T$ 的线性读出之和。所有矩阵和向量均为下面提供的常数，必须完全按照规定使用。\n\n使用的模型参数：\n- 隐藏层大小 $H = 3$。\n- 状态转移矩阵 $W_h \\in \\mathbb{R}^{3 \\times 3}$:\n$$\nW_h = \\begin{bmatrix}\n0.70  0.05  0.00 \\\\\n0.00  0.65  0.04 \\\\\n0.03  0.00  0.60\n\\end{bmatrix}.\n$$\n- 输入权重向量 $W_x \\in \\mathbb{R}^{3 \\times 1}$:\n$$\nW_x = \\begin{bmatrix}\n0.40 \\\\\n-0.20 \\\\\n0.10\n\\end{bmatrix}.\n$$\n- 偏置向量 $b \\in \\mathbb{R}^{3 \\times 1}$:\n$$\nb = \\begin{bmatrix}\n0.00 \\\\\n0.00 \\\\\n0.00\n\\end{bmatrix}.\n$$\n- 输出读出向量 $c_{\\text{out}} \\in \\mathbb{R}^{3 \\times 1}$:\n$$\nc_{\\text{out}} = \\begin{bmatrix}\n0.30 \\\\\n0.50 \\\\\n-0.20\n\\end{bmatrix}.\n$$\n- 电阻系数 $k = 0.02$ 伏特/安培。\n- 输出偏置 $d = 0.00$ 伏特。\n\n需精确实现的 RNN 计算：\n- 隐藏动态：对于 $t = 1,2,\\dots,T$，且 $h_0 = \\mathbf{0}$，令预激活为 $z_t = W_h h_{t-1} + W_x x_t + b$，隐藏状态为 $h_t = \\tanh(z_t)$。\n- 最终步骤的输出电压降：$y_T = k \\cdot x_T + c_{\\text{out}}^\\top h_T + d$。\n\n任务要求：\n1. 实现上述前向计算，以评估在给定任意输入序列 $\\{x_t\\}_{t=1}^T$ 时的 $y_T$。最终电压降 $y_T$ 以伏特为单位表示，并四舍五入到小数点后四位。\n2. 使用随时间反向传播算法计算标量输出 $y_T$ 相对于整个输入序列 $\\{x_t\\}_{t=1}^T$ 的梯度。该梯度向量必须为每个时间索引 $t$ 包含一个条目。\n3. 使用从基线到输入的直线路径，计算输入序列相对于基线序列 $\\{x_t^{\\text{base}}\\}_{t=1}^T$ 的积分梯度归因。沿路径使用包含 $M = 100$ 个步骤的均匀划分。除了通过数值近似实现定义外，不要使用任何解析捷径。\n4. 通过识别具有最大绝对归因值的单个时间索引 $t^\\star \\in \\{1,\\dots,T\\}$ 来解释归因，该索引代表对预测的最终电压降影响最大的一个一秒钟片段。使用相对于程序内部数组表示的从零开始的索引报告 $t^\\star$。同时，通过检查所有归因的总和是否约等于输入和基线的预测 $y_T$ 之差，来数值验证完整性属性。报告一个布尔值，指示此检查是否在 $10^{-2}$ 伏特的绝对容差内成立。\n\n测试套件：\n使用以下四个以安培为单位的电流输入序列，每个序列均以 $\\Delta t = 1$ 秒进行采样。对于每种情况，基线是相同长度的零序列。每个测试用例的输出必须包括三个项目：索引 $t^\\star$（整数）、预测的最终电压降 $y_T$（以伏特为单位，四舍五入到小数点后四位，浮点数）和完整性检查结果（布尔值）。所有电压量必须以伏特为单位。\n- 案例 1（脉冲放电，“理想路径”）：$T=30$，$\\{x_t\\}$ 在 $t=1$ 到 $t=10$ 为 $0$，在 $t=11$ 到 $t=20$ 为 $10$，在 $t=21$ 到 $t=30$ 为 $0$。\n- 案例 2（边界情况，无负载）：$T=20$，$\\{x_t\\}$ 对所有 $t=1$ 到 $t=20$ 均为 $0$。\n- 案例 3（充电，负电流）：$T=15_$，$\\{x_t\\}$ 对所有 $t=1$ 到 $t=15$ 均为 $-5$。\n- 案例 4（高负载，接近饱和）：$T=25$，$\\{x_t\\}$ 对所有 $t=1$ 到 $t=25$ 均为 $50$。\n\n最终输出规范：\n您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果，每个测试用例的结果本身是一个包含三个元素的括号分隔列表 $[t^\\star, y_T, \\text{boolean}]$。例如，结构必须类似于 $[[\\dots],[\\dots],[\\dots],[\\dots]]$，每个内部列表对应一个测试用例。",
            "solution": "问题陈述经评估有效。它提出了一个有科学依据、定义明确且客观的计算任务。该模型是使用标准循环神经网络（RNN）对电池电压动态进行的简化但合理的表示。所有参数、方程、初始条件和测试用例都已明确定义，构成了一个自洽且逻辑一致的问题。任务——实现前向传播、随时间反向传播和积分梯度——是机器学习和计算科学中的标准技术，并且具有一定难度。\n\n解决方案首先实现 RNN 的前向动态，然后推导并实现通过随时间反向传播（BPTT）进行的梯度计算，最后使用这些组件来计算积分梯度归因。\n\n**1. RNN 前向计算**\n\n模型的核心是一个离散时间 RNN。隐藏状态 $h_t \\in \\mathbb{R}^3$ 随时间步 $t=1, 2, \\dots, T$ 演化，受输入电流 $x_t$ 和前一个隐藏状态 $h_{t-1}$ 的控制。\n\n初始状态给定为零向量：\n$$\nh_0 = \\mathbf{0}\n$$\n\n对于每个后续时间步 $t \\in \\{1, 2, \\dots, T\\}$，预激活 $z_t \\in \\mathbb{R}^3$ 作为前一状态 $h_{t-1}$ 和当前输入 $x_t$ 的线性组合来计算：\n$$\nz_t = W_h h_{t-1} + W_x x_t + b\n$$\n其中 $W_h \\in \\mathbb{R}^{3 \\times 3}$ 是状态转移矩阵，$W_x \\in \\mathbb{R}^{3 \\times 1}$ 是输入权重向量，$b \\in \\mathbb{R}^{3 \\times 1}$ 是偏置向量。注意 $x_t$ 是一个标量，所以 $W_x x_t$ 是标量-向量乘法。\n\n然后通过对预激活 $z_t$ 逐元素应用双曲正切激活函数 $\\tanh$ 来获得新的隐藏状态 $h_t$：\n$$\nh_t = \\tanh(z_t)\n$$\n这个过程迭代重复，直到计算出最终的隐藏状态 $h_T$。\n\n最终输出，即预测的电压降 $y_T$（单位为伏特），是根据最终输入 $x_T$ 和最终隐藏状态 $h_T$ 计算出的一个标量值：\n$$\ny_T = k \\cdot x_T + c_{\\text{out}}^\\top h_T + d\n$$\n其中 $k$ 是电阻系数，$c_{\\text{out}} \\in \\mathbb{R}^{3 \\times 1}$ 是输出读出向量，$d$ 是输出偏置。\n\n**2. 通过随时间反向传播（BPTT）计算梯度**\n\n为了计算积分梯度，我们首先需要输出 $y_T$ 相对于序列中每个输入的梯度，即 $\\frac{\\partial y_T}{\\partial x_t}$，其中 $t=1, \\dots, T$。这是通过在 RNN 展开的计算图中向后应用链式法则来实现的。\n\n设目标函数为 $\\mathcal{L} = y_T$。梯度计算过程如下：\n- $\\mathcal{L}$ 相对于最终隐藏状态 $h_T$ 的梯度由输出方程导出：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial h_T} = \\frac{\\partial y_T}{\\partial h_T} = c_{\\text{out}}\n$$\n- 相对于最终输入 $x_T$ 的梯度有两个部分：一部分来自直接的电阻项 $k \\cdot x_T$，另一部分来自通过 $h_T$ 的 RNN 路径：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial x_T} = \\frac{\\partial y_T}{\\partial x_T} = k + \\left(\\frac{\\partial h_T}{\\partial x_T}\\right)^\\top \\frac{\\partial \\mathcal{L}}{\\partial h_T}\n$$\n- 对于任何时间步 $t \\in \\{1, \\dots, T\\}$，梯度都会向后传播。相对于隐藏状态 $h_{t-1}$ 的梯度由相对于后续状态 $h_t$ 的梯度得出：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial h_{t-1}} = \\left(\\frac{\\partial h_t}{\\partial h_{t-1}}\\right)^\\top \\frac{\\partial \\mathcal{L}}{\\partial h_t} = \\left(\\frac{\\partial z_t}{\\partial h_{t-1}}\\right)^\\top \\left(\\frac{\\partial h_t}{\\partial z_t}\\right)^\\top \\frac{\\partial \\mathcal{L}}{\\partial h_t}\n$$\n所需的雅可比矩阵是：\n$$\n\\frac{\\partial z_t}{\\partial h_{t-1}} = W_h \\quad \\text{和} \\quad \\frac{\\partial h_t}{\\partial z_t} = \\text{diag}(1 - \\tanh^2(z_t)) = \\text{diag}(1 - h_t^2)\n$$\n其中平方是逐元素的。\n相对于输入 $x_t$ 的梯度也类似地找到：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial x_t} = \\left(\\frac{\\partial h_t}{\\partial x_t}\\right)^\\top \\frac{\\partial \\mathcal{L}}{\\partial h_t} = \\left(\\frac{\\partial z_t}{\\partial x_t}\\right)^\\top \\left(\\frac{\\partial h_t}{\\partial z_t}\\right)^\\top \\frac{\\partial \\mathcal{L}}{\\partial h_t}\n$$\n其中 $\\frac{\\partial z_t}{\\partial x_t} = W_x$。\n\nBPTT 算法从 $\\frac{\\partial \\mathcal{L}}{\\partial h_T} = c_{\\text{out}}$ 开始，迭代计算 $\\frac{\\partial \\mathcal{L}}{\\partial x_t}$ 和 $\\frac{\\partial \\mathcal{L}}{\\partial h_{t-1}}$，其中 $t=T, T-1, \\dots, 1$。项 $k$ 在最后被加到计算出的梯度 $\\frac{\\partial \\mathcal{L}}{\\partial x_T}$ 中。\n\n**3. 积分梯度归因**\n\n积分梯度（Integrated Gradients, IG）是一种将重要性分数分配给输入特征的归因方法。对于输入特征 $i$（这里是特定时间 $t$ 的电流 $x_t$）的归因是通过沿从基线输入 $x'$到实际输入 $x$ 的路径对输出相对于该特征的梯度进行积分来定义的。\n\n时间 $t$ 的输入的归因是：\n$$\n\\text{Attribution}_t(x) = (x_t - x'_t) \\int_{\\alpha=0}^{1} \\frac{\\partial y_T(x' + \\alpha(x - x'))}{\\partial x_t} d\\alpha\n$$\n其中 $x$ 是输入序列 $\\{x_t\\}_{t=1}^T$，$x'$ 是基线序列 $\\{x^{\\text{base}}_t\\}_{t=1}^T$。在这个问题中，对所有 $t$ 都有 $x^{\\text{base}}_t = 0$。\n\n该积分使用包含 $M=100$ 个步骤的黎曼和进行数值近似：\n$$\n\\text{Attribution}_t(x) \\approx (x_t - x^{\\text{base}}_t) \\cdot \\frac{1}{M} \\sum_{j=1}^{M} \\left. \\frac{\\partial y_T}{\\partial x_t} \\right|_{x = x^{\\text{path}}_j}\n$$\n其中 $x^{\\text{path}}_j = x^{\\text{base}} + \\frac{j}{M} (x - x^{\\text{base}})$。对于路径上的 $M$ 个插值输入序列中的每一个，都使用上述 BPTT 算法计算梯度向量。将结果平均，并按输入与基线之差 $(x - x^{\\text{base}})$进行缩放。\n\nIG 的一个关键属性，称为完整性，是所有输入特征的归因总和等于模型在输入和基线之间输出的差值。这需要进行数值验证：\n$$\n\\sum_{t=1}^T \\text{Attribution}_t(x) \\approx y_T(x) - y_T(x^{\\text{base}})\n$$\n我们在给定的 $10^{-2}$ 容差内检查此属性。具有最高绝对归因值的时间索引 $t^\\star$ 被识别为后验影响最大的索引。",
            "answer": "[[19,0.2227,True],[0,0.0,True],[14,-0.4991,True],[24,1.4005,True]]"
        }
    ]
}