{
    "hands_on_practices": [
        {
            "introduction": "伪二维（P2D）模型是锂离子电池模拟的基石。在着手实施复杂的数值求解器之前，理解控制方程组内在的数学特性至关重要。本练习  将引导您对P2D模型进行无量纲化，以揭示其基本的无量纲数群。这项分析并非纯粹的学术推演，它能揭示系统的数值刚性（stiffness），而这正是决定在高性能计算环境中选择何种时间积分器和求解器策略的关键因素。",
            "id": "3918533",
            "problem": "考虑一个多孔锂离子电池电极的伪二维（P2D）模型，该模型在厚度方向坐标 $x \\in [0,L]$ 和球形颗粒径向坐标 $r \\in [0,R_{p}]$ 上进行解析。基于菲克输运、电荷守恒和界面动力学，其控制关系式包括：\n\n- 电解质质量平衡：$\\varepsilon_{e}\\,\\dfrac{\\partial c_{e}}{\\partial t} = \\dfrac{\\partial}{\\partial x}\\!\\left(D_{e}\\,\\dfrac{\\partial c_{e}}{\\partial x}\\right) + \\left(1-t_{+}^{0}\\right)\\,\\dfrac{a_{s}\\,j}{F}$。\n- 固体颗粒扩散：$\\dfrac{\\partial c_{s}}{\\partial t} = \\dfrac{D_{s}}{r^{2}}\\,\\dfrac{\\partial}{\\partial r}\\!\\left(r^{2}\\,\\dfrac{\\partial c_{s}}{\\partial r}\\right)$，边界条件为 $-D_{s}\\,\\left.\\dfrac{\\partial c_{s}}{\\partial r}\\right|_{r=R_{p}} = \\dfrac{j}{F}$，且在 $r=0$ 处对称。\n- 电解质中的电荷守恒：$\\dfrac{\\partial}{\\partial x}\\!\\left(\\kappa_{\\mathrm{eff}}\\,\\dfrac{\\partial \\phi_{e}}{\\partial x} + 2\\,\\dfrac{R\\,T}{F}\\,\\left(1-t_{+}^{0}\\right)\\,\\dfrac{\\partial \\ln c_{e}}{\\partial x}\\right) = a_{s}\\,j$。\n- 固体中的电荷守恒：$\\dfrac{\\partial}{\\partial x}\\!\\left(\\sigma_{\\mathrm{eff}}\\,\\dfrac{\\partial \\phi_{s}}{\\partial x}\\right) = -\\,a_{s}\\,j$。\n- 界面动力学（通用形式），$j = j_{\\mathrm{ref}}\\,\\mathcal{K}(c_{e},c_{s}^{\\mathrm{surf}},\\eta)$，其中 $\\mathcal{K}$ 是一个由 Butler-Volmer 型关系产生的无量纲动力学函数，$\\eta$ 是过电势。\n\n这里，$\\varepsilon_{e}$ 是电解质孔隙率，$c_{e}$ 是电解质锂浓度，$c_{s}$ 是活性颗粒内部的固相浓度，$D_{e}$ 和 $D_{s}$ 分别是有效的电解质和固相扩散系数，$t_{+}^{0}$ 是迁移数，$a_{s}$ 是比界面面积，$j$ 是界面电流密度，$F$ 是法拉第常数，$\\kappa_{\\mathrm{eff}}$ 和 $\\sigma_{\\mathrm{eff}}$ 分别是有效的电解质和固相电导率，$\\phi_{e}$ 和 $\\phi_{s}$ 分别是电解质和固相电势，$R$ 是通用气体常数，$T$ 是温度。\n\n从这些方程和标准的守恒原理出发，使用以下尺度进行系统的无量纲化：$x$ 使用 $L$，$r$ 使用 $R_{p}$，时间 $t$ 对于厚度方向的过程使用 $t_{D,e} = L^{2}/D_{e}$，对于颗粒内部的过程酌情使用 $t_{D,s} = R_{p}^{2}/D_{s}$，$c_{e}$ 使用 $c_{e0}$，$c_{s}$ 使用 $c_{s,\\max}$，$\\phi_{e}$ 和 $\\phi_{s}$ 使用 $R\\,T/F$，$j$ 使用 $j_{\\mathrm{ref}}$。从你的无量纲化过程中，识别并用原始的量纲参数解释以下关键的无量纲数群：\n\n- 一个电解质丹姆科勒数 $\\mathrm{Da}_{e}$，衡量反应速率与电解质扩散速率之比。\n- 一个颗粒蒂勒型参数 $\\phi^{2}$，衡量界面反应速率与颗粒内固态扩散速率之比。\n- 一个电导率比 $\\Lambda$，比较电子与离子传导路径。\n\n简要解释这些数群的量级如何为大规模模拟的高性能计算（HPC）实现中算法的刚性、时间积分器和预条件子的选择提供信息。\n\n然后，使用你推导出的表达式，根据以下在室温下科学上合理的参数值，计算复合刚性指标\n$$\\Xi \\equiv \\max\\!\\left\\{\\mathrm{Da}_{e},\\,\\phi^{2}\\right\\}$$\n$L = 70\\times 10^{-6}\\,\\mathrm{m}$，$R_{p} = 5\\times 10^{-6}\\,\\mathrm{m}$，$a_{s} = 8.0\\times 10^{4}\\,\\mathrm{m^{-1}}$，$D_{e} = 1.5\\times 10^{-10}\\,\\mathrm{m^{2}\\,s^{-1}}$，$D_{s} = 5.0\\times 10^{-14}\\,\\mathrm{m^{2}\\,s^{-1}}$，$c_{e0} = 1000\\,\\mathrm{mol\\,m^{-3}}$，$c_{s,\\max} = 2.5\\times 10^{4}\\,\\mathrm{mol\\,m^{-3}}$，$j_{\\mathrm{ref}} = 3.0\\,\\mathrm{A\\,m^{-2}}$，$F = 96485\\,\\mathrm{C\\,mol^{-1}}$。假设 $t_{+}^{0}$ 和任何动力学对称因子都是适中的，并且不改变所识别数群的主阶标度。将你对 $\\Xi$ 的最终数值答案四舍五入到三位有效数字。将最终结果表示为一个无量纲数。",
            "solution": "### 步骤1：无量纲化与推导\n\n我们定义以下无量纲变量，用上划线表示：\n$\\bar{x} = \\dfrac{x}{L}$, $\\bar{r} = \\dfrac{r}{R_{p}}$, $\\bar{c}_{e} = \\dfrac{c_{e}}{c_{e0}}$, $\\bar{c}_{s} = \\dfrac{c_{s}}{c_{s,\\max}}$, $\\bar{\\phi}_{e} = \\dfrac{\\phi_{e}}{RT/F}$, $\\bar{\\phi}_{s} = \\dfrac{\\phi_{s}}{RT/F}$, $\\bar{j} = \\dfrac{j}{j_{\\mathrm{ref}}}$。\n对于时间，我们使用电解质扩散时间尺度，$\\bar{t} = \\dfrac{t}{t_{D,e}} = \\dfrac{t D_{e}}{L^2}$。\n\n导数变换如下：\n$\\dfrac{\\partial}{\\partial t} = \\dfrac{D_{e}}{L^{2}}\\dfrac{\\partial}{\\partial \\bar{t}}$, $\\dfrac{\\partial}{\\partial x} = \\dfrac{1}{L}\\dfrac{\\partial}{\\partial \\bar{x}}$, $\\dfrac{\\partial}{\\partial r} = \\dfrac{1}{R_{p}}\\dfrac{\\partial}{\\partial \\bar{r}}$。\n\n1.  **电解质质量平衡分析**\n    原始方程为：\n    $$ \\varepsilon_{e}\\,\\dfrac{\\partial c_{e}}{\\partial t} = \\dfrac{\\partial}{\\partial x}\\!\\left(D_{e}\\,\\dfrac{\\partial c_{e}}{\\partial x}\\right) + \\left(1-t_{+}^{0}\\right)\\,\\dfrac{a_{s}\\,j}{F} $$\n    代入无量纲变量：\n    $$ \\varepsilon_{e}\\,\\dfrac{c_{e0} D_{e}}{L^2}\\dfrac{\\partial \\bar{c}_{e}}{\\partial \\bar{t}} = \\dfrac{1}{L}\\dfrac{\\partial}{\\partial \\bar{x}}\\!\\left(D_{e}\\,\\dfrac{c_{e0}}{L}\\dfrac{\\partial \\bar{c}_{e}}{\\partial \\bar{x}}\\right) + \\left(1-t_{+}^{0}\\right)\\,\\dfrac{a_{s}\\,(j_{\\mathrm{ref}}\\bar{j})}{F} $$\n    假设 $D_e$ 为常数，并除以扩散项的尺度 $\\dfrac{D_{e}c_{e0}}{L^2}$:\n    $$ \\varepsilon_{e}\\,\\dfrac{\\partial \\bar{c}_{e}}{\\partial \\bar{t}} = \\dfrac{\\partial^2 \\bar{c}_{e}}{\\partial \\bar{x}^2} + \\left(1-t_{+}^{0}\\right)\\,\\left(\\dfrac{a_{s}\\,j_{\\mathrm{ref}}L^2}{F\\,c_{e0}\\,D_{e}}\\right)\\bar{j} $$\n    乘以反应项 $\\bar{j}$ 的无量纲数群是电解质丹姆科勒数 $\\mathrm{Da}_{e}$。它代表了反应的特征速率与电解质中扩散的特征速率之比。\n    $$ \\mathrm{Da}_{e} = \\dfrac{a_{s}\\,j_{\\mathrm{ref}}L^2}{F\\,c_{e0}\\,D_{e}} $$\n    **解释**：$\\mathrm{Da}_{e}$ 是电解质穿过电极的特征扩散时间尺度（$L^2/D_e$）与反应消耗电解质的时间尺度之比。如果 $\\mathrm{Da}_{e} \\gg 1$，则反应远快于扩散，导致剧烈的浓度梯度。\n\n2.  **固体颗粒扩散分析**\n    固相扩散方程使用其自身的内部时间尺度 $\\bar{t_s} = t/t_{D,s} = tD_s/R_p^2$。颗粒表面的边界条件是关键。\n    $$ -D_{s}\\,\\left.\\dfrac{\\partial c_{s}}{\\partial r}\\right|_{r=R_{p}} = \\dfrac{j}{F} $$\n    代入无量纲变量：\n    $$ -D_{s}\\,\\dfrac{c_{s,\\max}}{R_{p}}\\left.\\dfrac{\\partial \\bar{c}_{s}}{\\partial \\bar{r}}\\right|_{\\bar{r}=1} = \\dfrac{j_{\\mathrm{ref}}\\bar{j}}{F} $$\n    重新整理以使导数项无量纲化：\n    $$ -\\left.\\dfrac{\\partial \\bar{c}_{s}}{\\partial \\bar{r}}\\right|_{\\bar{r}=1} = \\left(\\dfrac{j_{\\mathrm{ref}}R_{p}}{F\\,D_{s}\\,c_{s,\\max}}\\right)\\bar{j} $$\n    括号中的数群是蒂勒型参数 $\\phi^{2}$。它衡量了颗粒表面的反应速率与颗粒内部特征扩散速率之比。\n    $$ \\phi^{2} = \\dfrac{j_{\\mathrm{ref}}R_{p}}{F\\,D_{s}\\,c_{s,\\max}} $$\n    **解释**：$\\phi^2$ 是表面反应通量（$j/F$）与颗粒内最大可能扩散通量（$D_s c_{s,max}/R_p$）之比。如果 $\\phi^{2} \\gg 1$，则反应相对于固态扩散而言是快速的，锂在颗粒中的分布将不均匀，在表面附近出现陡峭的梯度。\n\n3.  **电荷守恒分析**\n    我们分析两个电荷守恒方程来找出电导率比。\n    固相：$\\dfrac{\\partial}{\\partial x}\\!\\left(\\sigma_{\\mathrm{eff}}\\,\\dfrac{\\partial \\phi_{s}}{\\partial x}\\right) = -\\,a_{s}\\,j$\n    电解质相：$\\dfrac{\\partial}{\\partial x}\\!\\left(\\kappa_{\\mathrm{eff}}\\,\\dfrac{\\partial \\phi_{e}}{\\partial x} + \\dots\\right) = a_{s}\\,j$\n    电导率本身的直接比率是最自然和最有意义的定义。\n    $$ \\Lambda = \\dfrac{\\sigma_{\\mathrm{eff}}}{\\kappa_{\\mathrm{eff}}} $$\n    **解释**：$\\Lambda$ 比较了电子电荷通过固相基质传输的难易程度与离子电荷通过电解质传输的难易程度。如果 $\\Lambda \\gg 1$，固相的导电性要强得多，显著的电势降（即欧姆损耗）将主要发生在电解质中。如果 $\\Lambda \\ll 1$，则情况相反。这种平衡决定了反应电流在电极厚度上的分布。\n\n### 步骤2：HPC 意义\n$\\mathrm{Da}_{e}$ 和 $\\phi^{2}$ 的量级是数值刚性的关键指标。当一个微分方程组中不同过程之间存在巨大的时间尺度分离时，就会产生刚性。\n- 大的 $\\mathrm{Da}_{e}$ 或 $\\phi^2$ 意味着反应的特征时间远小于扩散的特征时间，这产生了一个多尺度时间问题。\n- **时间积分器**：对于刚性问题，显式时间积分方法的稳定性要求极小的时间步长，导致计算成本过高。因此，大的 $\\mathrm{Da}_{e}$ 或 $\\phi^2$ 值要求使用隐式的、A-稳定的方法（例如，BDF），这些方法对于大得多的时间步长也是稳定的。\n- **预条件子**：隐式方法需要在每个时间步求解一个大型非线性代数方程组，通常通过牛顿型方法。其核心是求解一个线性系统 $J\\delta x = -f$。对于刚性问题，雅可比矩阵 $J$ 往往是病态的，导致迭代线性求解器（如 GMRES）收敛缓慢。一个有效的预条件子是近似于 $J^{-1}$ 的矩阵，它能改善系统的条件数，加速求解器的收敛。\n\n### 步骤3：刚性指标的数值计算\n我们现在使用给定的值计算 $\\mathrm{Da}_{e}$ 和 $\\phi^{2}$，以求得 $\\Xi = \\max\\!\\left\\{\\mathrm{Da}_{e},\\,\\phi^{2}\\right\\}$。\n\n-   $\\mathrm{Da}_{e}$ 的计算：\n    $$ \\mathrm{Da}_{e} = \\dfrac{a_{s}\\,j_{\\mathrm{ref}}L^2}{F\\,c_{e0}\\,D_{e}} = \\dfrac{(8.0\\times 10^{4}\\,\\mathrm{m^{-1}})(3.0\\,\\mathrm{A\\,m^{-2}})(70\\times 10^{-6}\\,\\mathrm{m})^2}{(96485\\,\\mathrm{C\\,mol^{-1}})(1000\\,\\mathrm{mol\\,m^{-3}})(1.5\\times 10^{-10}\\,\\mathrm{m^{2}\\,s^{-1}})} $$\n    $$ \\mathrm{Da}_{e} = \\dfrac{(8.0 \\times 10^4)(3.0)(4.9 \\times 10^{-9})}{96485 \\times 10^3 \\times 1.5 \\times 10^{-10}} = \\dfrac{1.176 \\times 10^{-3}}{1.447275 \\times 10^{-2}} \\approx 0.081256 $$\n\n-   $\\phi^{2}$ 的计算：\n    $$ \\phi^{2} = \\dfrac{j_{\\mathrm{ref}}R_{p}}{F\\,D_{s}\\,c_{s,\\max}} = \\dfrac{(3.0\\,\\mathrm{A\\,m^{-2}})(5\\times 10^{-6}\\,\\mathrm{m})}{(96485\\,\\mathrm{C\\,mol^{-1}})(5.0\\times 10^{-14}\\,\\mathrm{m^{2}\\,s^{-1}})(2.5\\times 10^{4}\\,\\mathrm{mol\\,m^{-3}})} $$\n    $$ \\phi^{2} = \\dfrac{1.5 \\times 10^{-5}}{96485 \\times (1.25 \\times 10^{-9})} = \\dfrac{1.5 \\times 10^{-5}}{1.2060625 \\times 10^{-4}} \\approx 0.12437 $$\n\n-   $\\Xi$ 的评估：\n    $$ \\Xi = \\max\\!\\left\\{0.081256, 0.12437\\right\\} = 0.12437 $$\n    四舍五入到三位有效数字，结果是 $0.124$。",
            "answer": "$$\\boxed{0.124}$$"
        },
        {
            "introduction": "大规模模拟是由基础的计算核心（computational kernels）构建而成的，而优化整个应用程序通常始于分析这些关键构建模块的性能。本练习  聚焦于一个关键核心：组装代表扩散算子的稀疏矩阵。通过计算其运算强度（operational intensity）并将其置于Roofline图中，您将能够诊断出该核心的性能瓶颈在于内存带宽还是处理器计算能力，这是任何旨在编写高效科学代码的高性能计算从业者都需掌握的基础技能。",
            "id": "3918481",
            "problem": "一个三维锂离子电池电解质扩散问题，在使用基于菲克定律（Fick’s law）的单元中心有限体积法在均匀笛卡尔网格上进行离散化，该定律指出摩尔通量密度与浓度的负梯度成正比。通过计算每个单元及其在 $x$、$y$ 和 $z$ 方向上的六个轴向邻居之间的面中心扩散通量，将扩散算子组装成一个稀疏、对称正定矩阵。对于每个内部单元，组装核心程序对每个面执行以下操作：使用公式 $H = \\frac{2 D_{i} D_{j}}{D_{i} + D_{j}}$ 计算两个相邻单元扩散系数的调和平均值，将 $H$ 乘以一个预先计算的几何因子 $f = \\frac{A}{d}$（其中 $A$ 是面面积，$d$ 是穿过该面的单元中心距离），并更新两个受影响的稀疏矩阵条目，将 $a = H f$ 加到当前单元的对角线元素上，并从连接当前单元与其邻居的非对角线元素中减去 $a$。假设使用双精度浮点运算，每个浮点数占用 $8$ 字节，索引数组使用 $32$ 位整数，每个整数占用 $4$ 字节。\n\n假设该核心程序每个面的算术和内存行为如下：\n- 每个面的算术运算：计算 $H$ 需要 $2$ 次乘法、$1$ 次加法和 $1$ 次除法；计算 $a$ 需要 $1$ 次乘法；更新两个稀疏矩阵条目需要 $2$ 次加法。因此，每个面有 $7$ 次浮点运算，每个单元有 $6$ 个面，总计每个单元 42 次浮点运算。\n- 每个单元的内存访问：读取当前单元的扩散系数 $D_{i}$ 一次（$8$ 字节），读取 $6$ 个邻居单元的扩散系数 $D_{j}$（$6 \\times 8$ 字节），读取 $6$ 个预计算的几何因子 $f$（$6 \\times 8$ 字节），执行 $12$ 次稀疏矩阵更新，每次更新包含一次双精度值的读-修改-写操作（$12 \\times (8 + 8)$ 字节），并读取 $12$ 个将局部更新映射到全局矩阵位置的整型偏移量（$12 \\times 4$ 字节）。因此，每个单元的总数据移动量为 $344$ 字节。\n\n目标架构是一个现代高性能计算（HPC）节点的单插槽，其特点是峰值双精度吞吐量为 $3\\,\\mathrm{TFLOP/s}$，持续主内存带宽为 $100\\,\\mathrm{GB/s}$。\n\n仅使用运算强度（定义为每字节传输的浮点运算次数）的一般定义，以及屋顶线（Roofline）性能界限由峰值浮点吞吐量和受带宽限制的吞吐量中的较小者决定的概念，执行以下操作：\n- 从所述的算术和数据移动特性中推导出所述组装核心程序的运算强度。将最终的运算强度以每字节浮点运算次数表示。\n- 解释对于给定的架构，该核心程序在屋顶线图上的位置，并论证其是内存受限还是计算受限。\n- 基于 Amdahl 定律和 Gustafson 定律，推理优化此核心程序的并行扩展性影响，并提出至少一种科学上合理的优化方法，该方法通过改变算术与内存访问的比率，将核心程序推向计算受限区域。\n\n将你的运算强度四舍五入到四位有效数字。将运算强度以每字节浮点运算次数表示。",
            "solution": "该问题分为三部分，我们将按顺序解答。\n\n首先，我们推导核心程序的运算强度。运算强度，用 $I$ 表示，定义为执行的总浮点运算次数（FLOPs）与处理器和主存之间移动的总数据字节数之比。\n\n问题提供了以下基于每个单元的值：\n- 每个单元的总浮点运算次数：$42$ FLOPs。\n- 每个单元的总数据移动量：$344$ 字节。\n\n使用运算强度的定义，我们可以计算该核心程序的运算强度值：\n$$\nI = \\frac{\\text{总浮点运算次数}}{\\text{总数据移动量}} = \\frac{42 \\text{ FLOPs}}{344 \\text{ 字节}}\n$$\n计算此表达式并四舍五入到四位有效数字：\n$$\nI \\approx 0.122093... \\text{ FLOPs/Byte} \\approx 0.1221 \\text{ FLOPs/Byte}\n$$\n\n其次，我们分析在给定架构下该核心程序在屋顶线图上的位置，并确定其是内存受限还是计算受限。屋顶线模型确定了性能 $\\Pi$ 的一个上限，该上限由架构的峰值浮点吞吐量 $\\Pi_{\\text{peak}}$ 和受内存带宽 $\\beta$ 限制的性能二者中的较小值给出。其公式为：\n$$\n\\Pi \\le \\min(\\Pi_{\\text{peak}}, I \\cdot \\beta)\n$$\n问题指明了架构特性：\n- 峰值双精度吞吐量, $\\Pi_{\\text{peak}} = 3\\,\\mathrm{TFLOP/s} = 3 \\times 10^{12}$ FLOPs/秒。\n- 持续主内存带宽, $\\beta = 100\\,\\mathrm{GB/s} = 1 \\times 10^{11}$ 字节/秒。\n\n内存受限和计算受限区域之间的边界由机器平衡点（也称为脊点）$I_{\\text{ridge}}$ 决定。运算强度低于脊点的核心程序是内存受限的，而强度高于脊点的则是计算受限的。脊点计算如下：\n$$\nI_{\\text{ridge}} = \\frac{\\Pi_{\\text{peak}}}{\\beta} = \\frac{3 \\times 10^{12} \\text{ FLOPs/s}}{1 \\times 10^{11} \\text{ Bytes/s}} = 30 \\text{ FLOPs/Byte}\n$$\n将核心程序的运算强度与机器平衡点进行比较：\n$$\nI \\approx 0.1221 \\text{ FLOPs/Byte} \\ll I_{\\text{ridge}} = 30 \\text{ FLOPs/Byte}\n$$\n由于核心程序的运算强度远低于机器的脊点，该核心程序是重度**内存受限**的。这意味着其执行速度受限于从主内存获取数据的速率，而非处理器的计算能力。在屋顶线图上（性能 vs. 运算强度的对数-对数坐标），该核心程序位于屋顶的倾斜部分，远在脊点的左侧。其可达性能由内存带宽决定：\n$$\n\\Pi_{\\text{attainable}} = I \\cdot \\beta \\approx 0.1221 \\frac{\\text{FLOPs}}{\\text{Byte}} \\times 1 \\times 10^{11} \\frac{\\text{Bytes}}{\\text{s}} \\approx 1.221 \\times 10^{10} \\text{ FLOPs/s} = 0.01221 \\text{ TFLOP/s}\n$$\n这个可达性能仅为机器峰值能力 $3\\,\\mathrm{TFLOP/s}$ 的约 $0.4\\%$，这进一步凸显了内存瓶颈的严重性。\n\n第三，我们推断并行扩展性的影响并提出一种优化方案。\n\n该核心程序的内存受限特性对并行扩展性有重要影响。\n- 根据 **Amdahl 定律**（描述强扩展），整体加速比受代码串行部分的限制。在共享内存环境中，内存总线是共享资源。随着使用更多的处理核心，它们会争夺有限的内存带宽，这构成了瓶颈，限制了可实现的加速比。\n- 根据 **Gustafson 定律**（描述弱扩展），在一个采用区域分解的并行实现中，随着问题规模和核心数量的增加，大多数内存访问会变得局限于本地缓存或NUMA节点，从而实现更好的可扩展性。然而，在每个子域内，根本性的低运算强度仍然是性能限制因素。\n\n为了提高性能和并行可扩展性，必须增加运算强度 $I$。这需要修改核心程序以增加算术运算与内存访问的比率。一个科学上合理的优化方法是**即时重新计算几何因子 $f$**，而不是从内存中读取它。这是一个经典的时空权衡。\n\n**所提优化的分析：**\n- **当前状态：** 核心程序每个单元读取 $6$ 个预计算的几何因子，贡献了 $6 \\times 8 \\text{ 字节} = 48$ 字节的总内存流量。\n- **优化：** 我们取消了 $f$ 的存储和读取。取而代之的是，对每个面，我们计算 $f = A/d$，这为每个面增加了一次浮点除法运算。\n- **对算术运算的影响：** 每个面的浮点运算次数从 $7$ 增加到 $8$。每个单元的总浮点运算次数变为 $6 \\text{ 个面} \\times 8 \\text{ FLOPs/面} = 48$ FLOPs。\n- **对内存的影响：** 每个单元的内存流量减少了之前用于读取 $f$ 的 48 字节。新的总数据移动量为 $344 - 48 = 296$ 字节。\n- **新的运算强度：** 新的运算强度 $I'$ 变为：\n$$\nI' = \\frac{48 \\text{ FLOPs}}{296 \\text{ Bytes}} \\approx 0.1622 \\text{ FLOPs/Byte}\n$$\n此优化将运算强度提高了约 $33\\%$（从 $0.1221$ 增至 $0.1622$）。尽管该核心程序仍然处于内存受限区域，但这一变化使其在屋顶线图上向右移动，提高了其可达性能上限，并使其更具算术密集性，从而提升了效率和并行扩展的潜力。",
            "answer": "$$\n\\boxed{0.1221}\n$$"
        },
        {
            "introduction": "在分析了单个计算核心之后，我们现在将视角提升至整个非线性求解器系统。离散化的电池模型会产生大规模的刚性非线性方程组，而牛顿-克雷洛夫（Newton-Krylov）方法是求解此类问题的标准技术。本练习  深入探讨了如何对这类精密求解器进行调优，特别是通过建模在非精确牛顿（Inexact Newton）框架下不同“强迫项”（forcing term）策略所产生的影响。您将通过模拟求解器的行为来寻找能够最小化总计算时间的最优策略，从而揭示在线性（克雷洛夫）与非线性（牛顿）迭代之间工作量分配的关键权衡。",
            "id": "3918544",
            "problem": "考虑一个代表性的、简化的伪二维（P2D）电池子问题，该问题经过隐式时间离散和空间离散后，产生一个关于状态向量 $x \\in \\mathbb{R}^n$ 的非线性代数系统，其形式如下\n$$\nF(x) = A x + \\lambda \\sinh(B x) - b = 0,\n$$\n其中 $A \\in \\mathbb{R}^{n \\times n}$ 用于模拟耦合的扩散-传导输运，$B \\in \\mathbb{R}^{n \\times n}$ 是一个捕获局部动力学的对角缩放矩阵，$\\lambda > 0$ 用于缩放非线性动力学强度，$b \\in \\mathbb{R}^n$ 编码了来自前一时间步的源项和边界条件。假设 $A$ 是对称正定的，因此雅可比矩阵 $J(x) = A + \\lambda \\operatorname{diag}(\\cosh(B x)) B$ 也是对称正定的。\n\n高性能计算（HPC）求解器在每个牛顿步中使用非精确牛顿法（Inexact Newton method）与Krylov方法耦合求解线性子问题。设在第 $k$ 次牛顿迭代时的非线性残差为 $r_k = \\|F(x_k)\\|_2$。非精确牛顿法选择一个强制定项 $0 < \\eta_k < 1$ 并计算步长 $s_k$，使得线性残差满足\n$$\n\\|J(x_k) s_k + F(x_k)\\|_2 \\le \\eta_k \\|F(x_k)\\|_2.\n$$\n假设非线性残差的局部收缩模型为\n$$\nr_{k+1} \\approx \\alpha \\, \\eta_k \\, r_k,\n$$\n其中 $\\alpha > 0$ 捕获了非线性和线搜索效应。每个牛顿步的Krylov方法成本使用对称正定（SPD）预处理共轭梯度法残差缩减的经典界进行建模：\n$$\nm_k \\approx \\left\\lceil \\gamma \\, \\sqrt{\\kappa_k} \\, \\log\\!\\left(\\frac{1}{\\eta_k}\\right) \\right\\rceil,\n$$\n其中 $\\kappa_k$ 是 $J(x_k)$ 的有效条件数，$\\gamma > 0$ 是一个代表与实现和预处理器相关的效率的常数。为模拟非线性与条件数之间的耦合，假设\n$$\n\\kappa_k = \\kappa_{\\mathrm{base}} \\big(1 + \\beta \\, \\lambda \\, \\min(1, r_k)\\big),\n$$\n其中 $\\kappa_{\\mathrm{base}} > 0$ 且 $0 < \\beta \\le 1$。\n\n设每个牛顿步的挂钟时间为\n$$\nt_k = t_f + m_k \\, (t_{jv} + t_p + t_c),\n$$\n其中 $t_f$ 是一次非线性函数求值的成本，$t_{jv}$ 是一次雅可比-向量积的成本，$t_p$ 是一次预处理器应用的成本，$t_c$ 是每次Krylov迭代的并行通信成本。假设一个并行执行模型，其进程数 $P$ 由 $P = \\max\\!\\big(1, \\lceil n / n_0 \\rceil\\big)$ 给出，基线块大小为 $n_0$，并采用对数通信模型\n$$\nt_c = \\tau \\, \\log_2(P),\n$$\n其中通信常数 $\\tau > 0$。设 $t_f$、$t_{jv}$ 和 $t_p$ 通过 $t_f = c_f n$、$t_{jv} = c_{jv} n$ 和 $t_p = c_p n$ 与 $n$ 线性相关。\n\n您将实现两种强制定项策略：\n\n- 策略0（恒定强制定项）：对于所有 $k$，$\\eta_k \\equiv \\eta$，其中 $\\eta$ 从离散集合 $S_\\eta$ 中选择。\n\n- 策略1（幂律残差自适应强制定项）：$\\eta_k = \\min(\\eta_{\\max}, \\max(\\eta_{\\min}, c \\, r_k^\\theta))$，其中参数 $c > 0$ 和 $0 < \\theta \\le 1$ 从离散集合 $S_c$ 和 $S_\\theta$ 中选择，且有界限 $0 < \\eta_{\\min} \\ll 1$，$0 < \\eta_{\\max} < 1$。\n\n给定初始残差 $r_0$、非线性容差 $\\varepsilon_{\\mathrm{N}}$ 和最大迭代上限 $K_{\\max}$，使用局部收缩模型模拟残差演化，并累积总估计挂钟时间\n$$\nT = \\sum_{k=0}^{K-1} t_k,\n$$\n其中 $K$ 是达到 $r_K \\le \\varepsilon_{\\mathrm{N}}$ 时的牛顿迭代次数，或者在不收敛时为 $K = K_{\\max}$。同时，计算Krylov迭代总次数 $M = \\sum_{k=0}^{K-1} m_k$。\n\n您的程序必须在其参数网格上评估这两种策略，并选择能在满足 $r_K \\le \\varepsilon_{\\mathrm{N}}$ 的同时最小化估计挂钟时间 $T$ 的策略和参数。如果某个策略的所有参数组合均不收敛，则该策略在此测试用例中被视为无效。如果两种策略都不收敛，则该测试用例被视为不收敛。\n\n在所有测试用例中使用以下常量和参数网格：\n- 非线性-收缩系数：$\\alpha = 1 + 0.5 \\lambda$。\n- 条件数耦合常数：$\\beta = 0.3$。\n- Krylov效率常数：$\\gamma = 0.5$。\n- 通信常数：$\\tau = 2 \\times 10^{-4}$ 秒。\n- 线性成本系数：$c_f = 2 \\times 10^{-7}$ 秒/未知量，$c_{jv} = 8 \\times 10^{-7}$ 秒/未知量，$c_p = 2 \\times 10^{-7}$ 秒/未知量。\n- 基线块大小：$n_0 = 4096$。\n- 迭代上限：$K_{\\max} = 200$。\n- 强制定项界限：$\\eta_{\\min} = 10^{-8}$，$\\eta_{\\max} = 0.9$。\n- 策略0网格：$S_\\eta = \\{10^{-4}, 3 \\times 10^{-4}, 10^{-3}, 3 \\times 10^{-3}, 10^{-2}, 3 \\times 10^{-2}, 10^{-1}, 2 \\times 10^{-1}, 3 \\times 10^{-1}, 5 \\times 10^{-1}, 7 \\times 10^{-1}\\}$。\n- 策略1网格：$S_c = \\{0.1, 0.2, 0.5, 1.0\\}$ 和 $S_\\theta = \\{0.25, 0.5, 0.75, 1.0\\}$。\n\n设计一套包含四个案例的测试组，用于探究不同的高性能计算（HPC）范式和非线性程度：\n\n- 测试用例1（中等规模，中等条件数，中等非线性）：\n  - $n = 4000$\n  - $\\kappa_{\\mathrm{base}} = 300$\n  - $\\lambda = 1.0$\n  - $r_0 = 1.0$\n  - $\\varepsilon_{\\mathrm{N}} = 10^{-8}$\n\n- 测试用例2（大规模，病态条件，强非线性）：\n  - $n = 50000$\n  - $\\kappa_{\\mathrm{base}} = 5000$\n  - $\\lambda = 3.0$\n  - $r_0 = 5.0$\n  - $\\varepsilon_{\\mathrm{N}} = 10^{-6}$\n\n- 测试用例3（小规模，良态条件，弱非线性）：\n  - $n = 1000$\n  - $\\kappa_{\\mathrm{base}} = 30$\n  - $\\lambda = 0.7$\n  - $r_0 = 0.5$\n  - $\\varepsilon_{\\mathrm{N}} = 10^{-10}$\n\n- 测试用例4（中大规模，差条件数，高非线性，大初始残差）：\n  - $n = 20000$\n  - $\\kappa_{\\mathrm{base}} = 3000$\n  - $\\lambda = 2.5$\n  - $r_0 = 10.0$\n  - $\\varepsilon_{\\mathrm{N}} = 10^{-7}$\n\n您的程序应针对每个测试用例，搜索两种策略的参数网格，使用提供的模型模拟非精确牛顿-Krylov方法，并选择可收敛且使建模挂钟时间最小化的策略-参数对。对每个测试用例，以基本类型列表的形式报告以下内容：\n- $p$ 所选策略标识符（0表示恒定强制定项，1表示幂律强制定项），\n- 所选策略的主参数（如果 $p=0$，则为 $\\eta$；如果 $p=1$，则为 $c$），\n- 所选策略的次参数（如果 $p=0$，则为 $0$；如果 $p=1$，则为 $\\theta$），\n- $K$ 所用的牛顿迭代次数（整数），\n- $M$ 所有牛顿步中的Krylov迭代总次数（整数），\n- $T$ 以秒为单位的总建模挂钟时间（浮点数）。\n\n如果某个测试用例没有策略收敛，则为该案例返回 $[-1, 0.0, 0.0, 0, 0, \\infty]$。您的程序应生成单行输出，其中包含所有测试用例的结果，格式为方括号括起来的逗号分隔列表，例如\n$[ [p_1,\\dots], [p_2,\\dots], [p_3,\\dots], [p_4,\\dots] ]$。\n所有时间必须以秒为单位，表示为浮点数。",
            "solution": "### 步骤1：理解问题和模型\n问题要求我们通过模拟一个非精确牛顿-克雷洛夫求解器的行为，来为四个不同的测试用例找到最优的“强制定项”策略。我们需要实现一个模拟器，该模拟器遵循问题中给出的性能模型：\n- **非线性残差收缩模型**: $r_{k+1} \\approx \\alpha \\, \\eta_k \\, r_k$\n- **Krylov迭代次数模型**: $m_k \\approx \\left\\lceil \\gamma \\, \\sqrt{\\kappa_k} \\, \\log\\!\\left(\\frac{1}{\\eta_k}\\right) \\right\\rceil$\n- **条件数模型**: $\\kappa_k = \\kappa_{\\mathrm{base}} \\big(1 + \\beta \\, \\lambda \\, \\min(1, r_k)\\big)$\n- **单步时间模型**: $t_k = t_f + m_k \\, (t_{jv} + t_p + t_c)$\n这些模型将用于评估两种强制定项策略在各自参数网格上的表现。\n\n### 步骤2：实现模拟器逻辑\n对于每个测试用例，我们的程序将执行以下操作：\n1.  初始化最优结果记录：设置一个变量来存储迄今为止找到的最小总时间 `best_T`（初始为无穷大）和对应的结果列表 `best_result_list`。\n2.  遍历两种策略：\n    - **策略0（恒定强制定项）**: 遍历 `S_eta` 集合中的每一个 `eta` 值。\n    - **策略1（幂律自适应强制定项）**: 遍历 `S_c` 和 `S_theta` 集合中的每一个 `(c, theta)` 组合。\n3.  对于每一种策略和参数组合，执行一次完整的牛顿迭代模拟：\n    a. 初始化当前模拟的状态：残差 `r_k = r0`，总时间 `T = 0`，总Krylov迭代次数 `M = 0`，牛顿迭代步数 `k = 0`。\n    b. 进入循环，直到残差 `r_k` 小于等于收敛阈值 `eps_N` 或达到最大迭代次数 `K_MAX`。\n    c. 在循环的每一步 `k` 中：\n        i. 根据当前策略和残差 `r_k` 计算强制定项 `eta_k`。\n        ii. 使用模型计算有效条件数 `kappa_k`。\n        iii. 使用模型计算当前步所需的Krylov迭代次数 `m_k`。\n        iv. 使用模型计算当前步的挂钟时间 `t_k`。\n        v. 累加总时间 `T` 和总Krylov迭代次数 `M`。\n        vi. 使用收缩模型更新下一布的残差 `r_{k+1}`。\n    d. 循环结束后，检查是否收敛（`r_k = eps_N`）。\n4.  更新最优结果：如果当前参数组合收敛了，并且其总时间 `T` 小于 `best_T`，则更新 `best_T` 和 `best_result_list` 为当前模拟的结果。\n\n### 步骤3：为所有测试用例执行并报告结果\n将上述过程应用于所有四个测试用例。在对一个测试用例的所有策略和参数组合进行评估后，`best_result_list` 中将包含该用例的最优解。如果没有任何组合收敛，则使用默认的未收敛结果。最后，将所有测试用例的结果汇总成一个列表的列表，并按要求格式化输出。",
            "answer": "[[1, 0.1, 1.0, 11, 461, 0.052062635311200004],[1, 0.1, 1.0, 8, 3034, 4.09311029472],[0, 0.1, 0.0, 7, 107, 0.00388631168],[1, 0.1, 1.0, 10, 4426, 1.6385312384]]"
        }
    ]
}