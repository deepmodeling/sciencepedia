{
    "hands_on_practices": [
        {
            "introduction": "移动水平估计（MHE）等先进估计算法的成功应用，始于对物理系统的精确数学建模。本练习旨在帮助您将物理原理转化为非线性测量模型，并推导其雅可比矩阵，这是所有基于梯度的估计算法（包括MHE和扩展卡尔曼滤波器）的核心要素。通过这个实践，您将掌握从第一性原理构建模型并进行必要微积分推导的关键技能。",
            "id": "4231913",
            "problem": "一个信息物理移动机器人在其数字孪生中由状态向量 $x_{k} \\in \\mathbb{R}^{2}$ 表示，该向量包含平面位置 $x_{k} = \\begin{pmatrix} p_{x,k} \\\\ p_{y,k} \\end{pmatrix}$。该机器人携带一个飞行时间声学传感器，用于测量到位于已知位置 $s = \\begin{pmatrix} s_{x} \\\\ s_{y} \\end{pmatrix}$ 的固定信标的距离。传感器由一个控制输入 $u_{k} \\in \\mathbb{R}$ 加热，该输入根据 $c(u_{k}) = c_{0}\\sqrt{1 + \\beta u_{k}}$ 来改变局部声速，其中 $c_{0} > 0$ 和 $\\beta > 0$ 是通过校准确定的已知常数。电子设备对原始飞行时间应用对数放大器，产生一个由非线性函数 $y_{k} = h(x_{k}, u_{k})$ 定义的无量纲测量输出 $y_{k}$，其中 $h$ 必须根据以下基于物理的关系构建：\n- 机器人与信标之间的几何距离为 $d(x_{k}) = \\| x_{k} - s \\|_{2}$。\n- 飞行时间为 $t(x_{k}, u_{k}) = \\dfrac{d(x_{k})}{c(u_{k})}$。\n- 放大器输出为 $y_{k} = \\ln\\!\\big(1 + \\alpha\\, t(x_{k}, u_{k})\\big)$，其中 $\\alpha > 0$ 是一个已知的无量纲增益因子。\n从这些基本原理出发，构建显式测量模型 $y_{k} = h(x_{k}, u_{k})$，并推导移动时域估计 (MHE) 所需的关于状态和输入的雅可比矩阵。具体来说，使用第一性原理和链式法则计算 $\\dfrac{\\partial h}{\\partial x_{k}}$ 和 $\\dfrac{\\partial h}{\\partial u_{k}}$，然后在给定的工作点 $s = \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix}$、$x_{k} = \\begin{pmatrix} 3 \\\\ 4 \\end{pmatrix}$、$u_{k} = 1$、$\\alpha = 3$、$c_{0} = 1$（数字孪生的归一化内部单位）和 $\\beta = 3$ 处对它们进行求值。\n以精确分数形式，将最终结果表示为单行向量 $\\begin{pmatrix} \\dfrac{\\partial h}{\\partial p_{x,k}}  \\dfrac{\\partial h}{\\partial p_{y,k}}  \\dfrac{\\partial h}{\\partial u_{k}} \\end{pmatrix}$。为便于解释，状态雅可比项的单位应理解为米的倒数，输入雅可比项的单位应理解为控制单位的倒数；最终的方框答案中不应包含单位。",
            "solution": "该问题要求推导和评估一个信息物理系统的非线性测量函数 $h(x_{k}, u_{k})$ 的雅可比矩阵，这在移动时域估计 (MHE) 或扩展卡尔曼滤波器 (EKF) 等估计算法中很常见。雅可比矩阵是测量函数关于状态向量 $x_k$ 和控制输入 $u_k$ 的一阶偏导数矩阵。\n\n首先，我们必须构建测量函数 $y_{k} = h(x_{k}, u_{k})$ 的显式形式。问题提供了以下关系：\n状态向量为 $x_{k} = \\begin{pmatrix} p_{x,k} \\\\ p_{y,k} \\end{pmatrix}$。\n信标位于已知位置 $s = \\begin{pmatrix} s_{x} \\\\ s_{y} \\end{pmatrix}$。\n几何距离为 $d(x_{k}) = \\| x_{k} - s \\|_{2} = \\sqrt{(p_{x,k} - s_{x})^{2} + (p_{y,k} - s_{y})^{2}}$。\n声速依赖于控制输入 $u_k$，其关系为 $c(u_{k}) = c_{0}\\sqrt{1 + \\beta u_{k}}$。\n飞行时间为 $t(x_{k}, u_{k}) = \\dfrac{d(x_{k})}{c(u_{k})}$。\n最终测量值为 $y_{k} = \\ln\\!\\big(1 + \\alpha\\, t(x_{k}, u_{k})\\big)$。\n\n将这些表达式相互代入，我们得到完整的测量模型：\n$$h(x_{k}, u_{k}) = \\ln\\left(1 + \\alpha \\frac{\\sqrt{(p_{x,k} - s_{x})^{2} + (p_{y,k} - s_{y})^{2}}}{c_{0}\\sqrt{1 + \\beta u_{k}}}\\right)$$\n\n我们的任务是计算 $h$ 关于状态 $x_k$ 的每个分量（即 $p_{x,k}$ 和 $p_{y,k}$）以及控制输入 $u_k$ 的偏导数。我们将使用链式法则进行微分。\n\n我们来计算状态雅可比矩阵，$\\dfrac{\\partial h}{\\partial x_{k}} = \\begin{pmatrix} \\dfrac{\\partial h}{\\partial p_{x,k}}  \\dfrac{\\partial h}{\\partial p_{y,k}} \\end{pmatrix}$。\n令 $g(d, c) = \\ln(1 + \\alpha \\frac{d}{c})$。那么 $h(x_k, u_k) = g(d(x_k), c(u_k))$。\n关于中间变量（例如 $z$）的导数为 $\\dfrac{\\partial h}{\\partial z} = \\dfrac{\\partial g}{\\partial d}\\dfrac{\\partial d}{\\partial z} + \\dfrac{\\partial g}{\\partial c}\\dfrac{\\partial c}{\\partial z}$。\n对于状态变量 $p_{x,k}$ 和 $p_{y,k}$，声速 $c$ 是常数，因此 $\\dfrac{\\partial c}{\\partial p_{x,k}} = 0$ 且 $\\dfrac{\\partial c}{\\partial p_{y,k}} = 0$。\n因此，导数简化为：\n$\\dfrac{\\partial h}{\\partial p_{x,k}} = \\dfrac{\\partial g}{\\partial d}\\dfrac{\\partial d}{\\partial p_{x,k}}$ 和 $\\dfrac{\\partial h}{\\partial p_{y,k}} = \\dfrac{\\partial g}{\\partial d}\\dfrac{\\partial d}{\\partial p_{y,k}}$。\n\n首先，我们计算 $\\dfrac{\\partial g}{\\partial d}$：\n$$\\frac{\\partial g}{\\partial d} = \\frac{1}{1 + \\alpha \\frac{d}{c}} \\cdot \\frac{\\alpha}{c} = \\frac{\\alpha}{c + \\alpha d}$$\n接下来，我们计算距离函数 $d(x_k) = \\sqrt{(p_{x,k} - s_{x})^{2} + (p_{y,k} - s_{y})^{2}}$ 的导数：\n$$\\frac{\\partial d}{\\partial p_{x,k}} = \\frac{1}{2d} \\cdot 2(p_{x,k} - s_{x}) = \\frac{p_{x,k} - s_{x}}{d}$$\n$$\\frac{\\partial d}{\\partial p_{y,k}} = \\frac{1}{2d} \\cdot 2(p_{y,k} - s_{y}) = \\frac{p_{y,k} - s_{y}}{d}$$\n结合这些结果，我们得到状态雅可比矩阵的分量：\n$$\\frac{\\partial h}{\\partial p_{x,k}} = \\frac{\\alpha}{c + \\alpha d} \\cdot \\frac{p_{x,k} - s_{x}}{d} = \\frac{\\alpha (p_{x,k} - s_{x})}{d(c + \\alpha d)}$$\n$$\\frac{\\partial h}{\\partial p_{y,k}} = \\frac{\\alpha}{c + \\alpha d} \\cdot \\frac{p_{y,k} - s_{y}}{d} = \\frac{\\alpha (p_{y,k} - s_{y})}{d(c + \\alpha d)}$$\n状态雅可比行向量为 $\\dfrac{\\partial h}{\\partial x_{k}} = \\dfrac{\\alpha (x_k - s)^T}{d(c+\\alpha d)}$。\n\n现在，我们计算输入雅可比 $\\dfrac{\\partial h}{\\partial u_{k}}$。\n对于输入 $u_k$，距离 $d$ 是常数，因此 $\\dfrac{\\partial d}{\\partial u_k} = 0$。导数简化为：\n$\\dfrac{\\partial h}{\\partial u_{k}} = \\dfrac{\\partial g}{\\partial c}\\dfrac{\\partial c}{\\partial u_{k}}$。\n首先，我们计算 $\\dfrac{\\partial g}{\\partial c}$：\n$$\\frac{\\partial g}{\\partial c} = \\frac{1}{1 + \\alpha \\frac{d}{c}} \\cdot \\left(-\\frac{\\alpha d}{c^2}\\right) = \\frac{c}{c + \\alpha d} \\cdot \\left(-\\frac{\\alpha d}{c^2}\\right) = -\\frac{\\alpha d}{c(c + \\alpha d)}$$\n接下来，我们计算声速函数 $c(u_k) = c_{0}(1 + \\beta u_{k})^{1/2}$ 的导数：\n$$\\frac{\\partial c}{\\partial u_{k}} = c_{0} \\cdot \\frac{1}{2}(1 + \\beta u_{k})^{-1/2} \\cdot \\beta = \\frac{c_{0}\\beta}{2\\sqrt{1 + \\beta u_{k}}}$$\n我们可以用 $c$ 本身来表示这个结果：由于 $c = c_{0}\\sqrt{1 + \\beta u_{k}}$，我们有 $\\sqrt{1 + \\beta u_{k}} = c/c_0$。\n$$\\frac{\\partial c}{\\partial u_{k}} = \\frac{c_{0}\\beta}{2(c/c_0)} = \\frac{c_{0}^{2}\\beta}{2c}$$\n结合这些结果，得到输入雅可比：\n$$\\frac{\\partial h}{\\partial u_{k}} = \\left(-\\frac{\\alpha d}{c(c + \\alpha d)}\\right) \\cdot \\left(\\frac{c_{0}^{2}\\beta}{2c}\\right) = -\\frac{\\alpha d c_{0}^{2}\\beta}{2c^{2}(c + \\alpha d)}$$\n\n最后一步是在给定的工作点评估这些雅可比表达式：\n$s = \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix}$、$x_{k} = \\begin{pmatrix} 3 \\\\ 4 \\end{pmatrix}$、$u_{k} = 1$、$\\alpha = 3$、$c_{0} = 1$、$\\beta = 3$。\n\n我们首先计算在该点的中间值：\n状态分量为 $p_{x,k} = 3$ 和 $p_{y,k} = 4$。\n距离为 $d = \\sqrt{(3-0)^2 + (4-0)^2} = \\sqrt{9+16} = \\sqrt{25} = 5$。\n声速为 $c = c_{0}\\sqrt{1 + \\beta u_{k}} = 1\\sqrt{1 + 3 \\cdot 1} = \\sqrt{4} = 2$。\n一个有用的分母项是 $c + \\alpha d = 2 + 3 \\cdot 5 = 2 + 15 = 17$。\n\n现在，我们将这些值代入雅可比表达式中。\n对于状态雅可比：\n$$\\frac{\\partial h}{\\partial p_{x,k}} = \\frac{\\alpha (p_{x,k} - s_{x})}{d(c + \\alpha d)} = \\frac{3(3 - 0)}{5(17)} = \\frac{9}{85}$$\n$$\\frac{\\partial h}{\\partial p_{y,k}} = \\frac{\\alpha (p_{y,k} - s_{y})}{d(c + \\alpha d)} = \\frac{3(4 - 0)}{5(17)} = \\frac{12}{85}$$\n对于输入雅可比：\n$$\\frac{\\partial h}{\\partial u_{k}} = -\\frac{\\alpha d c_{0}^{2}\\beta}{2c^{2}(c + \\alpha d)} = -\\frac{3 \\cdot 5 \\cdot 1^2 \\cdot 3}{2 \\cdot 2^2 \\cdot (17)} = -\\frac{45}{2 \\cdot 4 \\cdot 17} = -\\frac{45}{136}$$\n最终的雅可比行向量为 $\\begin{pmatrix} \\dfrac{9}{85}  \\dfrac{12}{85}  -\\dfrac{45}{136} \\end{pmatrix}$。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{9}{85}  \\frac{12}{85}  -\\frac{45}{136} \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "现实世界中的信息物理系统（CPS）通常表现出混合动态特性，即连续状态与离散事件（如开关切换）并存。本练习将指导您为一个具有混合开关模式的电网逆变器实施一个移动水平估计器，这是一个典型的CPS应用。您将学习如何通过枚举离散模式序列，并为每种序列求解一个连续状态的最小二乘问题，从而联合估计系统的离散模式和连续状态。",
            "id": "4232050",
            "problem": "在更广泛的信息物理系统（CPS）背景下，考虑一个单相并网逆变器的数字孪生（DT）。该DT必须执行移动时域估计（MHE）来估计电感电流状态，同时要考虑到混合开关引起的模式相关测量行为。逆变器输出级被建模为一个由直流（DC）电压源驱动的$L$-$R$滤波器，并连接到一个交流（AC）电网，该电网在短时域内可以很好地近似为一个戴维南源。\n\n从基本电气定律出发。电感遵循 $v_L = L \\, \\frac{di}{dt}$，根据基尔霍夫电压定律（Kirchhoff's Voltage Law），有 $u - R \\, i - v_g - v_L = 0$，其中 $u$ 是逆变器侧施加的电压，$R$ 是串联电阻，$L$ 是电感，$i$ 是电感电流，$v_g$ 是电网电压。假设脉冲宽度调制（pulse-width modulation）产生的平均施加电压为 $u = s \\, V_{\\mathrm{dc}}$，其中 $s \\in \\{-1, 0, +1\\}$ 是离散开关模式，$V_{\\mathrm{dc}}$ 是直流母线电压。使用步长为 $dt$ 的前向欧拉法对电流动态进行离散化，以获得适用于 MHE 的离散时间模型。\n\n令离散时间 $k$ 的状态为 $x_k = i_k$。假设DT接收的测量值 $y_k$ 通过模式相关的传感器缩放和偏置依赖于开关模式，因此有 $y_k = h_{s_k} \\, x_k + c_{s_k} + v_k$，其中 $h_{s_k}$ 和 $c_{s_k}$ 是由当前模式 $s_k$ 决定的测量尺度和偏置，$v_k$ 是加性测量噪声。\n\n假设动态方程中的加性过程噪声 $w_k$ 和加性测量噪声 $v_k$ 是独立的、零均值的高斯噪声，且方差已知。MHE 必须在长度为 $N$ 的时域上运行，并使用到达先验 $x_0 \\sim \\mathcal{N}(\\bar{x}_0, \\sigma_P^2)$ 来正则化初始状态。目标是通过最小化高斯假设所隐含的负对数似然，联合估计状态轨迹 $x_0, x_1, \\dots, x_N$ 和离散模式序列 $s_0, s_1, \\dots, s_{N-1}$，同时满足离散化后的动态模型和测量模型约束。\n\n形式上，从上述定律推导出离散动态方程，并从第一性原理构建 MHE 成本函数，然后实现一个算法，该算法能够：\n- 枚举时域内所有候选的混合模式序列 $\\{s_k\\}_{k=0}^{N-1}$，其中 $s_k \\in \\{-1, 0, +1\\}$。\n- 对于每个候选模式序列，求解连续变量 $\\{x_k\\}_{k=0}^{N}$ 上的加权最小二乘问题，该问题平衡了：\n  - 使用先验在 $k=0$ 处的到达正则化项。\n  - 由离散化动态定义的过程序列残差。\n  - 由模式相关的测量模型定义的测量残差。\n- 选择使总成本最小化的模式序列和状态轨迹。\n\n您的程序必须通过模拟指定真实模式序列下的真实动态并添加测量噪声，为每个测试用例生成合成数据。您可以假设在短时域的数据生成过程中，过程噪声可以忽略不计，但必须在估计器中包含过程残差的权重。一致地使用单位：\n- 电感 $L$ 单位为亨利（H），电阻 $R$ 单位为欧姆（$\\Omega$），电压 $V_{\\mathrm{dc}}$ 和 $v_g$ 单位为伏特（V），时间步长 $dt$ 单位为秒（s），电流 $i$ 单位为安培（A）。\n- 最终电流估计误差以安培（A）表示。不需要角度量。\n- 所有误差输出必须是浮点数；模式错分类数必须是整数。\n\n需要在估计器中推导和使用的离散时间模型：\n- 从 $L \\, \\frac{di}{dt} = u - R \\, i - v_g$ 开始，其中 $u = s \\, V_{\\mathrm{dc}}$。\n- 使用步长为 $dt$ 的前向欧拉法，得到用 $x_k$, $s_k$, $V_{\\mathrm{dc}}$, $v_{g,k}$, $R$ 和 $L$ 表示的 $x_{k+1}$。\n\n需要在估计器中使用的测量模型：\n- $y_k = h_{s_k} \\, x_k + c_{s_k} + v_k$，对于每个 $s \\in \\{-1, 0, +1\\}$，$h_{s}$ 和 $c_s$ 均已知。\n\n估计器的噪声假设：\n- $w_k \\sim \\mathcal{N}(0, \\sigma_Q^2)$ 且 $v_k \\sim \\mathcal{N}(0, \\sigma_R^2)$，在最小二乘成本中的权重分别与 $1/\\sigma_Q^2$ 和 $1/\\sigma_R^2$ 成正比。\n- 到达先验 $x_0 \\sim \\mathcal{N}(\\bar{x}_0, \\sigma_P^2)$ 贡献一个与 $1/\\sigma_P^2$ 成正比的权重。\n\n测试套件：\n实现 MHE 并在以下三个测试用例上进行评估。对于每个用例，使用真实的模式序列生成合成测量值 $y_k$，使用没有过程噪声的离散化动态方程模拟真实电流，并添加具有指定标准差的独立高斯测量噪声。\n\n- 案例1（正常路径）：\n  - $L = 3 \\times 10^{-3}$ H, $R = 0.4$ $\\Omega$, $V_{\\mathrm{dc}} = 400$ V, $dt = 1 \\times 10^{-4}$ s, $N = 5$。\n  - 所有 $k$ 的电网电压 $v_{g,k} = 170$ V。\n  - 真实初始状态 $x_0^{\\mathrm{true}} = 5$ A；到达先验均值 $\\bar{x}_0 = 0$ A；到达标准差 $\\sigma_P = 3$ A。\n  - 真实模式序列 $(s_k)_{k=0}^{4} = [ +1, -1, +1, -1, +1 ]$。\n  - 测量参数：$h_{+1} = 1.0$, $h_{0} = 0.7$, $h_{-1} = 0.9$；$c_{+1} = 0.02$ A, $c_{0} = 0.0$ A, $c_{-1} = -0.02$ A。\n  - 估计器权重：$\\sigma_Q = 0.5$ A, $\\sigma_R = 0.05$ A, $\\sigma_P = 3$ A。\n  - 测量噪声标准差 $\\sigma_{\\mathrm{meas}} = 0.05$ A。\n\n- 案例2（包含零导通模式和轻度噪声）：\n  - $L = 2 \\times 10^{-3}$ H, $R = 0.3$ $\\Omega$, $V_{\\mathrm{dc}} = 350$ V, $dt = 1 \\times 10^{-4}$ s, $N = 5$。\n  - 所有 $k$ 的电网电压 $v_{g,k} = 170$ V。\n  - 真实初始状态 $x_0^{\\mathrm{true}} = 4$ A；到达先验均值 $\\bar{x}_0 = 6$ A；到达标准差 $\\sigma_P = 2$ A。\n  - 真实模式序列 $(s_k)_{k=0}^{4} = [ +1, 0, 0, -1, +1 ]$。\n  - 测量参数：$h_{+1} = 1.0$, $h_{0} = 0.7$, $h_{-1} = 0.9$；$c_{+1} = 0.02$ A, $c_{0} = 0.0$ A, $c_{-1} = -0.02$ A。\n  - 估计器权重：$\\sigma_Q = 0.5$ A, $\\sigma_R = 0.02$ A, $\\sigma_P = 2$ A。\n  - 测量噪声标准差 $\\sigma_{\\mathrm{meas}} = 0.02$ A。\n\n- 案例3（不良先验和低噪声）：\n  - $L = 4 \\times 10^{-3}$ H, $R = 0.5$ $\\Omega$, $V_{\\mathrm{dc}} = 450$ V, $dt = 2 \\times 10^{-4}$ s, $N = 5$。\n  - 所有 $k$ 的电网电压 $v_{g,k} = 170$ V。\n  - 真实初始状态 $x_0^{\\mathrm{true}} = 2$ A；到达先验均值 $\\bar{x}_0 = 8$ A；到达标准差 $\\sigma_P = 4$ A。\n  - 真实模式序列 $(s_k)_{k=0}^{4} = [ -1, -1, +1, +1, -1 ]$。\n  - 测量参数：$h_{+1} = 1.0$, $h_{0} = 0.7$, $h_{-1} = 0.9$；$c_{+1} = 0.02$ A, $c_{0} = 0.0$ A, $c_{-1} = -0.02$ A。\n  - 估计器权重：$\\sigma_Q = 0.5$ A, $\\sigma_R = 0.01$ A, $\\sigma_P = 4$ A。\n  - 测量噪声标准差 $\\sigma_{\\mathrm{meas}} = 0.01$ A。\n\n您的程序必须：\n- 按照描述实现估计器，并选择在时域内使成本最小化的模式序列和状态轨迹。\n- 对每个案例，计算并返回两个量：\n  1. 在整个时域（包括 $k=0$ 到 $k=N$）上的均方根（RMS）电流估计误差，单位为安培（A），作为浮点数返回。\n  2. 在时域内模式错分类的总数，通过将估计的离散模式序列与真实序列进行比较得出，作为整数返回。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔的结果列表（例如，“[result1,result2,result3]”）。\n- 按顺序汇总三个案例的结果，并将其平铺为“[\\mathrm{err}_1,\\mathrm{mis}_1,\\mathrm{err}_2,\\mathrm{mis}_2,\\mathrm{err}_3,\\mathrm{mis}_3]”格式。",
            "solution": "所提出的问题是有效的，因为它在电气工程和控制理论方面有科学依据，问题定义良好、客观，并包含唯一解所需的所有必要信息。我们的任务是为混合系统（具体来说是并网逆变器）设计一个移动时域估计器（MHE），以联合估计连续的电感电流状态和离散的开关模式。\n\n### 1. 离散时间系统动力学推导\n\n$L$-$R$滤波器中电感电流 $i(t)$ 的连续时间模型由基尔霍夫电压定律推导得出：\n$$L \\frac{di}{dt} = u - R i - v_g$$\n逆变器的输出电压 $u$ 由开关模式 $s \\in \\{-1, 0, +1\\}$ 和直流母线电压 $V_{\\mathrm{dc}}$ 决定，即 $u = s V_{\\mathrm{dc}}$。将其代入动态方程可得：\n$$ \\frac{di}{dt} = -\\frac{R}{L}i + \\frac{sV_{\\mathrm{dc}} - v_g}{L} $$\n为了构建一个适用于离散时间估计器的模型，我们使用步长为 $dt$ 的前向欧拉法对此微分方程进行离散化。令离散时间 $k$ 的状态为 $x_k = i(k \\cdot dt)$。导数近似为 $\\frac{di}{dt} \\approx \\frac{x_{k+1} - x_k}{dt}$。\n$$ \\frac{x_{k+1} - x_k}{dt} = -\\frac{R}{L}x_k + \\frac{s_k V_{\\mathrm{dc}} - v_{g,k}}{L} $$\n重新整理以求解 $x_{k+1}$，得到离散时间状态空间模型：\n$$ x_{k+1} = \\left(1 - \\frac{R \\cdot dt}{L}\\right) x_k + \\frac{dt}{L} (s_k V_{\\mathrm{dc}} - v_{g,k}) $$\n该方程的形式为 $x_{k+1} = f(x_k, s_k)$，其中 $s_k$ 是在时间间隔 $[k \\cdot dt, (k+1) \\cdot dt)$ 内施加的控制输入（模式）。估计器必须考虑过程噪声 $w_k \\sim \\mathcal{N}(0, \\sigma_Q^2)$，从而得到随机模型：\n$$ x_{k+1} = f(x_k, s_k) + w_k $$\n\n### 2. MHE 成本函数构建\n\n目标是找到状态轨迹 $X = \\{x_0, x_1, \\dots, x_N\\}$ 和模式序列 $S = \\{s_0, s_1, \\dots, s_{N-1}\\}$，以最好地解释在长度为 $N$ 的时域内的可用测量值。在独立、零均值高斯噪声的假设下，通过最小化加权残差平方和来找到最大似然估计，这等效于最小化负对数似然。总成本函数 $J(X, S)$ 由三部分组成：\n\n1.  **到达成本 ($J_P$)**：该项包含了关于初始状态 $x_0 \\sim \\mathcal{N}(\\bar{x}_0, \\sigma_P^2)$ 的先验知识。它惩罚估计的初始状态 $x_0$ 与其先验均值 $\\bar{x}_0$ 之间的偏差。\n    $$ J_P(x_0) = \\frac{(x_0 - \\bar{x}_0)^2}{\\sigma_P^2} $$\n\n2.  **过程成本 ($J_Q$)**：该项惩罚过程残差，过程残差表示估计的状态轨迹与模型预测的动态之间的差异。在步骤 $k$ 的过程残差为 $w_k = x_{k+1} - f(x_k, s_k)$。\n    $$ J_Q(X, S) = \\sum_{k=0}^{N-1} \\frac{w_k^2}{\\sigma_Q^2} = \\sum_{k=0}^{N-1} \\frac{\\left(x_{k+1} - f(x_k, s_k)\\right)^2}{\\sigma_Q^2} $$\n\n3.  **测量成本 ($J_R$)**：该项惩罚测量残差，即实际测量值 $y_k$ 与测量模型预测值之间的差异，其中 $y_k = h_{s_k} x_k + c_{s_k} + v_k$，且 $v_k \\sim \\mathcal{N}(0, \\sigma_R^2)$。我们假设在 $k=0, \\dots, N-1$ 时测量值 $y_k$ 是可用的。\n    $$ J_R(X, S) = \\sum_{k=0}^{N-1} \\frac{(y_k - (h_{s_k} x_k + c_{s_k}))^2}{\\sigma_R^2} $$\n\n需要最小化的总 MHE 成本是这些分量的总和：\n$$ \\min_{X, S} J(X, S) = \\min_{X, S} \\left( J_P(x_0) + J_Q(X, S) + J_R(X, S) \\right) $$\n\n### 3. 求解算法\n\n由于存在连续状态 $X$ 和离散模式 $S$，这是一个混合整数优化问题。由于时域 $N$ 很小（$N=5$），我们可以通过枚举所有可能的模式序列来解决此问题。对于 $s_k \\in \\{-1, 0, +1\\}$，存在 $3^N$ 个候选序列。\n\n对于每个固定的候选模式序列 $S$，成本函数 $J(X | S)$ 是状态向量 $X = [x_0, x_1, \\dots, x_N]^T$ 的二次函数。最小化这个二次成本是一个线性最小二乘问题。我们可以将其构造为标准形式 $\\min_X \\| \\mathbf{M}X - \\mathbf{d} \\|_2^2$。\n\n变量向量为 $X \\in \\mathbb{R}^{N+1}$。该系统由以下残差构建：\n-   **先验残差**：$\\sqrt{W_P}(x_0 - \\bar{x}_0)$，其中 $W_P = 1/\\sigma_P^2$。\n-   **测量残差 ($k=0..N-1$)**：$\\sqrt{W_R}(y_k - (h_{s_k} x_k + c_{s_k}))$，其中 $W_R = 1/\\sigma_R^2$。这可以重写为 $\\sqrt{W_R}(h_{s_k} x_k - (y_k - c_{s_k}))$。\n-   **过程残差 ($k=0..N-1$)**：$\\sqrt{W_Q}(x_{k+1} - f(x_k, s_k))$，其中 $W_Q = 1/\\sigma_Q^2$。令 $f(x_k, s_k)=A x_k + B_k$，其中 $A = (1 - \\frac{R \\cdot dt}{L})$ 且 $B_k = \\frac{dt}{L}(s_k V_{\\mathrm{dc}} - v_{g,k})$。残差为 $\\sqrt{W_Q}(x_{k+1} - A x_k - B_k)$。\n\n将这 $1+N+N=2N+1$ 个残差堆叠起来，形成线性系统 $\\mathbf{M}X \\approx \\mathbf{d}$，其中 $\\mathbf{M}$ 是一个 $(2N+1) \\times (N+1)$ 矩阵，$\\mathbf{d}$ 是一个 $(2N+1)$ 维向量。使用标准的最小二乘求解器求解该系统以得到 $X$。序列 $S$ 的最小成本是最终的残差平方和。\n\n总体算法如下：\n1.  初始化 $\\text{min\\_cost} = \\infty$。\n2.  生成所有 $3^N$ 个候选模式序列 $S$。\n3.  对于每个序列 $S$：\n    a.  构建与 $S$ 对应的矩阵 $\\mathbf{M}$ 和向量 $\\mathbf{d}$。\n    b.  求解最优状态轨迹 $X_S = \\arg\\min_X \\| \\mathbf{M}X - \\mathbf{d} \\|_2^2$。\n    c.  计算成本 $J_S = \\| \\mathbf{M}X_S - \\mathbf{d} \\|_2^2$。\n    d.  如果 $J_S < \\text{min\\_cost}$，则更新 $\\text{min\\_cost} = J_S$，并将 $S$ 和 $X_S$ 存储为当前最优解。\n4.  最终估计是实现全局最小成本的状态和模式对 $(X_S, S)$。\n\n### 4. 数据合成与评估\n\n对于每个测试用例，都会生成合成数据。通过使用给定的真实模式序列模拟确定性离散时间模型，创建真实的状态轨迹 $\\{x_k^{\\mathrm{true}}\\}_{k=0}^{N}$。然后，通过将模式相关的测量模型应用于真实状态，并添加具有指定标准差 $\\sigma_{\\mathrm{meas}}$ 的独立高斯噪声，生成测量数据 $\\{y_k\\}_{k=0}^{N-1}$。估计器的性能通过在整个时域 $[0, N]$ 上的均方根（RMS）电流估计误差和在 $[0, N-1]$ 上的模式错分类总数来量化。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nimport itertools\n\ndef solve():\n    \"\"\"\n    Main function to define test cases, run MHE for each, and print results.\n    \"\"\"\n    # Set a fixed random seed for reproducibility of noise generation.\n    np.random.seed(42)\n\n    # Define the three test cases as specified in the problem.\n    test_cases = [\n        {\n            \"name\": \"Case 1 (happy path)\",\n            \"L\": 3e-3, \"R\": 0.4, \"Vdc\": 400.0, \"dt\": 1e-4, \"N\": 5,\n            \"vg\": 170.0,\n            \"x0_true\": 5.0, \"x0_prior_mean\": 0.0,\n            \"s_true\": [+1, -1, +1, -1, +1],\n            \"h_map\": {+1: 1.0, 0: 0.7, -1: 0.9},\n            \"c_map\": {+1: 0.02, 0: 0.0, -1: -0.02},\n            \"sigma_P\": 3.0, \"sigma_Q\": 0.5, \"sigma_R\": 0.05,\n            \"sigma_meas\": 0.05,\n        },\n        {\n            \"name\": \"Case 2 (includes zero-conduction mode)\",\n            \"L\": 2e-3, \"R\": 0.3, \"Vdc\": 350.0, \"dt\": 1e-4, \"N\": 5,\n            \"vg\": 170.0,\n            \"x0_true\": 4.0, \"x0_prior_mean\": 6.0,\n            \"s_true\": [+1, 0, 0, -1, +1],\n            \"h_map\": {+1: 1.0, 0: 0.7, -1: 0.9},\n            \"c_map\": {+1: 0.02, 0: 0.0, -1: -0.02},\n            \"sigma_P\": 2.0, \"sigma_Q\": 0.5, \"sigma_R\": 0.02,\n            \"sigma_meas\": 0.02,\n        },\n        {\n            \"name\": \"Case 3 (poor prior and low noise)\",\n            \"L\": 4e-3, \"R\": 0.5, \"Vdc\": 450.0, \"dt\": 2e-4, \"N\": 5,\n            \"vg\": 170.0,\n            \"x0_true\": 2.0, \"x0_prior_mean\": 8.0,\n            \"s_true\": [-1, -1, +1, +1, -1],\n            \"h_map\": {+1: 1.0, 0: 0.7, -1: 0.9},\n            \"c_map\": {+1: 0.02, 0: 0.0, -1: -0.02},\n            \"sigma_P\": 4.0, \"sigma_Q\": 0.5, \"sigma_R\": 0.01,\n            \"sigma_meas\": 0.01,\n        }\n    ]\n\n    results = []\n    for params in test_cases:\n        rms_error, misclassifications = run_mhe_for_case(params)\n        results.extend([rms_error, misclassifications])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef run_mhe_for_case(params):\n    \"\"\"\n    Solves the MHE problem for a single test case.\n    \n    Args:\n        params (dict): A dictionary containing all parameters for the case.\n        \n    Returns:\n        tuple: A tuple containing (rms_error, misclassifications).\n    \"\"\"\n    # Unpack parameters\n    L, R, Vdc, dt, N = params['L'], params['R'], params['Vdc'], params['dt'], params['N']\n    vg = params['vg']\n    x0_true = params['x0_true']\n    x0_prior_mean = params['x0_prior_mean']\n    sigma_P, sigma_Q, sigma_R = params['sigma_P'], params['sigma_Q'], params['sigma_R']\n    s_true = params['s_true']\n    h_map, c_map = params['h_map'], params['c_map']\n    sigma_meas = params['sigma_meas']\n\n    # --- 1. Generate True Data and Synthetic Measurements ---\n    \n    # Dynamics matrix A and constant for discretization\n    A_dyn = 1.0 - (R * dt) / L\n    \n    # Generate true state trajectory (without process noise)\n    x_true = np.zeros(N + 1)\n    x_true[0] = x0_true\n    for k in range(N):\n        s_k = s_true[k]\n        B_dyn_k = (dt / L) * (s_k * Vdc - vg)\n        x_true[k + 1] = A_dyn * x_true[k] + B_dyn_k\n\n    # Generate synthetic measurements y_0, ..., y_{N-1}\n    y_meas = np.zeros(N)\n    for k in range(N):\n        s_k = s_true[k]\n        noise = np.random.normal(0, sigma_meas)\n        y_meas[k] = h_map[s_k] * x_true[k] + c_map[s_k] + noise\n\n    # --- 2. MHE Implementation ---\n    \n    modes = [-1, 0, 1]\n    mode_sequences = list(itertools.product(modes, repeat=N))\n\n    min_cost = float('inf')\n    best_x_est, best_s_est = None, None\n\n    # Pre-calculate weights for the cost function\n    W_P = 1.0 / (sigma_P**2)\n    W_Q = 1.0 / (sigma_Q**2)\n    W_R = 1.0 / (sigma_R**2)\n\n    # Least squares matrix dimensions\n    num_states = N + 1\n    num_residuals = 1 + N + N  # 1 prior, N dynamics, N measurements\n    \n    for s_candidate in mode_sequences:\n        # Construct the least-squares problem M*x = d for the current s_candidate\n        M = np.zeros((num_residuals, num_states))\n        d = np.zeros(num_residuals)\n        \n        row = 0\n\n        # Row for arrival cost (prior)\n        M[row, 0] = np.sqrt(W_P)\n        d[row] = np.sqrt(W_P) * x0_prior_mean\n        row += 1\n\n        # Rows for measurement cost\n        for k in range(N):\n            s_k = s_candidate[k]\n            h_k, c_k = h_map[s_k], c_map[s_k]\n            M[row, k] = np.sqrt(W_R) * h_k\n            d[row] = np.sqrt(W_R) * (y_meas[k] - c_k)\n            row += 1\n\n        # Rows for process cost (dynamics)\n        for k in range(N):\n            s_k = s_candidate[k]\n            B_dyn_k = (dt / L) * (s_k * Vdc - vg)\n            M[row, k] = -np.sqrt(W_Q) * A_dyn\n            M[row, k + 1] = np.sqrt(W_Q)\n            d[row] = np.sqrt(W_Q) * B_dyn_k\n            row += 1\n\n        # Solve the linear least squares problem\n        x_est, residuals, _, _ = np.linalg.lstsq(M, d, rcond=None)\n        \n        cost = residuals[0] if residuals.size > 0 else np.sum((M @ x_est - d)**2)\n\n        if cost  min_cost:\n            min_cost = cost\n            best_x_est = x_est\n            best_s_est = s_candidate\n    \n    # --- 3. Compute Output Metrics ---\n    \n    # Root-mean-square (RMS) current estimation error\n    rms_error = np.sqrt(np.mean((best_x_est - x_true)**2))\n    \n    # Total number of mode misclassifications\n    misclassifications = np.sum(np.array(best_s_est) != np.array(s_true))\n    \n    return rms_error, int(misclassifications)\n\nsolve()\n```"
        },
        {
            "introduction": "在其核心，移动水平估计是一个约束优化问题，尤其是在处理物理或操作限制时。本练习将揭示MHE的底层数学结构，指导您将其表述为一个标准的凸二次规划（QP）问题。通过推导其Karush-Kuhn-Tucker（KKT）条件，您将深入理解最优解的性质以及对偶变量（即“影子价格”）在解释约束影响方面的经济学意义。",
            "id": "4231989",
            "problem": "考虑一个针对线性时不变信息物理系统的数字孪生移动时域估计 (MHE) 子问题，其时域长度为两步。该对象根据离散时间随机模型演化\n- 状态动力学：$x_{k+1} = A x_{k} + B u_{k} + w_{k}$，\n- 输出方程：$y_{k} = C x_{k} + v_{k}$，\n其中 $x_{k} \\in \\mathbb{R}^{n}$，$u_{k} \\in \\mathbb{R}^{m}$ 是已知输入，$y_{k} \\in \\mathbb{R}^{p}$ 是测量输出，$w_{k} \\in \\mathbb{R}^{n}$，$v_{k} \\in \\mathbb{R}^{p}$ 是过程和测量扰动。MHE 成本函数通过逆协方差加权来惩罚初始状态的到达偏差以及过程和测量残差：\n- 到达项：$(x_{0} - \\bar{x}_{0})^{\\top} P^{-1} (x_{0} - \\bar{x}_{0})$，\n- 过程项：$w_{0}^{\\top} Q^{-1} w_{0}$ 和 $w_{1}^{\\top} Q^{-1} w_{1}$，\n- 测量项：$r_{1}^{\\top} R^{-1} r_{1}$ 和 $r_{2}^{\\top} R^{-1} r_{2}$，\n其中 $\\bar{x}_{0} \\in \\mathbb{R}^{n}$ 是先验状态估计，而 $P \\in \\mathbb{S}_{++}^{n}$、$Q \\in \\mathbb{S}_{++}^{n}$、$R \\in \\mathbb{S}_{++}^{p}$ 是对称正定矩阵。\n\n通过堆叠定义决策向量\n$$\nz \\;\\triangleq\\; \\begin{pmatrix} x_{0} \\\\ x_{1} \\\\ x_{2} \\\\ w_{0} \\\\ w_{1} \\\\ r_{1} \\\\ r_{2} \\end{pmatrix} \\in \\mathbb{R}^{3n + 2n + 2p} \\;=\\; \\mathbb{R}^{5n + 2p},\n$$\n并定义用于强制执行动力学和残差定义的线性等式约束：\n- $x_{1} - A x_{0} - B u_{0} - w_{0} = 0$,\n- $x_{2} - A x_{1} - B u_{1} - w_{1} = 0$,\n- $r_{1} - (y_{1} - C x_{1}) = 0$,\n- $r_{2} - (y_{2} - C x_{2}) = 0$,\n给定数据 $u_{0}, u_{1} \\in \\mathbb{R}^{m}$ 和 $y_{1}, y_{2} \\in \\mathbb{R}^{p}$。在 $k=1,2$ 处施加凸状态箱式约束：\n- $\\ell \\le x_{k} \\le u$ 对于 $k \\in \\{1,2\\}$，\n其中 $\\ell, u \\in \\mathbb{R}^{n}$ 逐分量满足 $\\ell \\le u$。\n\n使用线性选择矩阵 $S_{x0}, S_{x1}, S_{x2}, S_{w0}, S_{w1}, S_{r1}, S_{r2}$，使得 $S_{x0} z = x_{0}$，$S_{x1} z = x_{1}$，$S_{x2} z = x_{2}$，$S_{w0} z = w_{0}$，$S_{w1} z = w_{1}$，$S_{r1} z = r_{1}$，$S_{r2} z = r_{2}$。将 MHE 子问题表述为标准形式的凸二次规划 (QP)\n$$\n\\min_{z} \\;\\; \\tfrac{1}{2} z^{\\top} H z + g^{\\top} z \\quad \\text{subject to} \\quad A z = b, \\;\\; G z \\le h,\n$$\n通过用给定数据指定 $H$、$g$、$A$、$b$、$G$ 和 $h$。\n\n从拉格朗日函数的定义和凸规划的最优性条件出发，推导此 QP 最优性的充要 Karush–Kuhn–Tucker (KKT) 条件。明确地用矩阵 $H$、$g$、$A$、$b$、$G$、$h$ 和原始-对偶变量 $(z, \\lambda, \\mu)$ 来识别驻点条件、原始可行性、对偶可行性和互补松弛性条件，其中 $\\lambda$ 和 $\\mu$ 分别是等式和不等式约束的对偶变量。\n\n然后，将对偶变量解释为约束的影子价格，并根据最优值相对于右端项 $b$ 和 $h$ 扰动的敏感性，仔细论证所使用的符号约定。\n\n答案规格：\n- 您的最终方框答案必须是单个闭式解析表达式：将同时编码驻点条件和原始可行性的紧凑分块鞍点 KKT 线性系统写成一个关于变量 $(z, \\lambda, \\mu)$ 的单一矩阵方程，仅使用上面定义的符号。\n- 不要在最终方框答案中包含不等式或互补性条件；这些应在您的推导过程中建立。",
            "solution": "该问题是一个有效且良定的优化问题。它要求将一个标准的移动时域估计 (MHE) 问题表述为一个凸二次规划 (QP)，推导其 Karush-Kuhn-Tucker (KKT) 最优性条件，并解释对偶变量。我们将首先构造 QP 的各组成部分，然后推导 KKT 条件，最后在给出最终的 KKT 线性系统之前，对对偶变量进行解释。\n\n### 1. 表述为凸二次规划 (QP)\n\n问题在于通过最小化一个受系统动力学和约束条件限制的成本函数，来找到最优的状态和扰动轨迹。QP 的标准形式是：\n$$\n\\min_{z} \\;\\; \\tfrac{1}{2} z^{\\top} H z + g^{\\top} z \\quad \\text{subject to} \\quad A z = b, \\;\\; G z \\le h\n$$\n我们需要指定矩阵 $H, G, A$ 和向量 $g, h, b$。\n\n**目标函数**\n\nMHE 成本函数由下式给出：\n$$\nJ_{\\text{MHE}} = (x_{0} - \\bar{x}_{0})^{\\top} P^{-1} (x_{0} - \\bar{x}_{0}) + w_{0}^{\\top} Q^{-1} w_{0} + w_{1}^{\\top} Q^{-1} w_{1} + r_{1}^{\\top} R^{-1} r_{1} + r_{2}^{\\top} R^{-1} r_{2}\n$$\n为了匹配包含因子 $\\frac{1}{2}$ 的 QP 标准形式，我们将最小化一个等价的目标 $J(z) = \\frac{1}{2} J_{\\text{MHE}}$。这是优化中的一个标准惯例，它不会改变最小化器 $z$。\n$$\nJ(z) = \\frac{1}{2}(x_{0} - \\bar{x}_{0})^{\\top} P^{-1} (x_{0} - \\bar{x}_{0}) + \\frac{1}{2}w_{0}^{\\top} Q^{-1} w_{0} + \\frac{1}{2}w_{1}^{\\top} Q^{-1} w_{1} + \\frac{1}{2}r_{1}^{\\top} R^{-1} r_{1} + \\frac{1}{2}r_{2}^{\\top} R^{-1} r_{2}\n$$\n展开第一项得到：\n$$\nJ(z) = \\frac{1}{2} (x_{0}^{\\top} P^{-1} x_{0} - 2\\bar{x}_{0}^{\\top} P^{-1} x_{0} + \\bar{x}_{0}^{\\top} P^{-1} \\bar{x}_{0}) + \\dots\n$$\n舍去常数项 $\\frac{1}{2}\\bar{x}_{0}^{\\top} P^{-1} \\bar{x}_{0}$，并使用选择矩阵将变量用决策向量 $z$ 表示（例如，$x_{0} = S_{x0}z$），目标函数变为：\n$$\nJ(z) = \\frac{1}{2} z^{\\top} (S_{x0}^{\\top} P^{-1} S_{x0} + S_{w0}^{\\top} Q^{-1} S_{w0} + S_{w1}^{\\top} Q^{-1} S_{w1} + S_{r1}^{\\top} R^{-1} S_{r1} + S_{r2}^{\\top} R^{-1} S_{r2}) z - (P^{-1}\\bar{x}_{0})^{\\top} S_{x0} z\n$$\n由此，我们确定 Hessian 矩阵 $H$ 和线性项向量 $g$：\n$$\nH = S_{x0}^{\\top} P^{-1} S_{x0} + S_{w0}^{\\top} Q^{-1} S_{w0} + S_{w1}^{\\top} Q^{-1} S_{w1} + S_{r1}^{\\top} R^{-1} S_{r1} + S_{r2}^{\\top} R^{-1} S_{r2}\n$$\n这是一个块对角矩阵：\n$$\nH = \\text{diag}(P^{-1}, 0_{n \\times n}, 0_{n \\times n}, Q^{-1}, Q^{-1}, R^{-1}, R^{-1})\n$$\n线性项向量是：\n$$\ng = -S_{x0}^{\\top} P^{-1} \\bar{x}_{0}\n$$\n该向量只有一个非零块：$g = \\begin{pmatrix} -P^{-1}\\bar{x}_0 \\\\ 0 \\\\ \\vdots \\\\ 0 \\end{pmatrix}$。由于 $P, Q, R$ 是正定的，它们的逆矩阵也是正定的。因此，$H$ 是半正定的，目标函数是凸的。\n\n**约束条件**\n\n问题陈述中符号 $A$ 同时用于状态动力学矩阵和 QP 等式约束矩阵。为避免歧义，我们用 $A_{sys}$ 表示模型 $x_{k+1} = A_{sys} x_k + \\dots$ 中的状态动力学矩阵。\n\n**等式约束 $A z = b$**：\n等式约束由系统动力学和残差定义给出：\n$x_{1} - A_{sys} x_{0} - w_{0} = B u_{0}$\n$x_{2} - A_{sys} x_{1} - w_{1} = B u_{1}$\n$C x_{1} + r_{1} = y_{1}$\n$C x_{2} + r_{2} = y_{2}$\n\n我们将这些约束组合成矩阵形式 $Az=b$，其中 $A$ 是 QP 等式约束矩阵：\n$$\nA = \\begin{pmatrix}\n-A_{sys}   I_n   0   -I_n   0   0   0 \\\\\n0   -A_{sys}   I_n   0   -I_n   0   0 \\\\\n0   C   0   0   0   I_p   0 \\\\\n0   0   C   0   0   0   I_p\n\\end{pmatrix}\n$$\n右端向量 $b$ 由已知的输入和测量组成：\n$$\nb = \\begin{pmatrix} B u_0 \\\\ B u_1 \\\\ y_1 \\\\ y_2 \\end{pmatrix}\n$$\n\n**不等式约束 $G z \\le h$**：\n$k \\in \\{1,2\\}$ 时的状态箱式约束为 $\\ell \\le x_{k} \\le u$，这等价于一对线性不等式 $x_k \\le u$ 和 $-x_k \\le -\\ell$。使用选择矩阵，我们有：\n$S_{x1} z \\le u$\n$-S_{x1} z \\le -\\ell$\n$S_{x2} z \\le u$\n$-S_{x2} z \\le -\\ell$\n\n将这些不等式堆叠起来，得到矩阵 $G$ 和向量 $h$：\n$$\nG = \\begin{pmatrix} S_{x1} \\\\ -S_{x1} \\\\ S_{x2} \\\\ -S_{x2} \\end{pmatrix} = \\begin{pmatrix}\n0   I_n   0   0   \\dots   0 \\\\\n0   -I_n   0   0   \\dots   0 \\\\\n0   0   I_n   0   \\dots   0 \\\\\n0   0   -I_n   0   \\dots   0 \\\\\n\\end{pmatrix}\n\\qquad\nh = \\begin{pmatrix} u \\\\ -\\ell \\\\ u \\\\ -\\ell \\end{pmatrix}\n$$\n\n### 2. Karush-Kuhn-Tucker (KKT) 条件\n\n通过将对偶变量（拉格朗日乘子）$\\lambda$ 与等式约束相关联，$\\mu$ 与不等式约束相关联，来构造凸 QP 的拉格朗日函数。\n$$\n\\mathcal{L}(z, \\lambda, \\mu) = \\frac{1}{2} z^{\\top} H z + g^{\\top} z + \\lambda^{\\top} (A z - b) + \\mu^{\\top} (G z - h)\n$$\n一个点 $z^*$ 是最优解的充要条件是 KKT 条件，因为该问题是凸的。设 $(z^*, \\lambda^*, \\mu^*)$ 是一个最优的原始-对偶三元组。\n\n1.  **驻点条件**：拉格朗日函数相对于原始变量 $z$ 的梯度在最优点必须为零。\n    $$\n    \\nabla_z \\mathcal{L}(z^*, \\lambda^*, \\mu^*) = H z^* + g + A^{\\top} \\lambda^* + G^{\\top} \\mu^* = 0\n    $$\n\n2.  **原始可行性**：解 $z^*$ 必须满足所有原始约束。\n    $$\n    A z^* = b\n    $$\n    $$\n    G z^* \\le h\n    $$\n\n3.  **对偶可行性**：对应于不等式约束的对偶变量必须为非负。\n    $$\n    \\mu^* \\ge 0\n    $$\n\n4.  **互补松弛性**：对于每个不等式约束，要么该约束是激活的（即等式成立），要么其对应的对偶变量为零。\n    $$\n    \\mu_i^* (G_i z^* - h_i) = 0 \\quad \\text{for all } i\n    $$\n    其中 $G_i$ 是 $G$ 的第 $i$ 行，$h_i$ 是 $h$ 的第 $i$ 个分量。\n\n### 3. 对偶变量的解释\n\n对偶变量 $\\lambda$ 和 $\\mu$ 具有作为影子价格的经济学解释，量化了最优成本对约束中扰动的敏感性。设 $p^*(b,h)$ 是 QP 的最优值，作为约束右端项的函数。凸优化的标准敏感性分析结果表明，对于小扰动，最优值的变化由下式给出：\n$$\ndp^* = -(\\lambda^*)^{\\top} db - (\\mu^*)^{\\top} dh\n$$\n这意味着 $\\nabla_b p^*(b,h) = -\\lambda^*$ 和 $\\nabla_h p^*(b,h) = -\\mu^*$。此符号约定是定义拉格朗日函数为 $f + \\text{乘子}^{\\top} \\times \\text{约束}$ 的直接结果。\n\n-   **$\\lambda$ 的解释**：与第 $j$ 个等式约束 $(Az-b)_j = 0$ 相关联的对偶变量 $\\lambda_j^*$ 表示当 $b_j$ 发生无穷小变化时，最优成本的边际变化。具体来说，将 $b_j$ 增加一个小的量 $\\epsilon  0$ 将使最优成本近似改变 $-\\lambda_j^* \\epsilon$。因此，$-\\lambda_j^*$ 是由 $b_j$ 所代表的资源的影子价格。$-\\lambda_j^*$ 的正值表示增加 $b_j$ 将导致最终成本增加。\n\n-   **$\\mu$ 的解释**：与第 $i$ 个不等式约束 $(Gz-h)_i \\le 0$ 相关联的对偶变量 $\\mu_i^*$ 表示当 $h_i$ 发生变化时，最优成本的边际变化。将 $h_i$ 增加一个小的量 $\\epsilon  0$ 意味着放松该约束（例如，增加上界 $u$）。这将使最优成本近似改变 $-\\mu_i^* \\epsilon$。由于 $\\mu_i^* \\ge 0$，放松一个约束只能使最优成本降低或保持不变。如果一个约束是未激活的（$(G_i z^* - h_i)  0$），其影子价格 $\\mu_i^*$ 为零，意味着对 $h_i$ 的小改变对最优成本没有影响。如果一个约束是激活的且 $\\mu_i^*  0$，放松它（增加 $h_i$）将严格降低最优成本。因此，$\\mu_i^*$ 代表了第 $i$ 个不等式约束的“紧致性成本”。\n\n### 最终 KKT 系统\n\n问题要求用一个单一的矩阵方程来表示驻点条件和原始可行性（等式）条件。这两个条件构成了关于变量 $(z, \\lambda, \\mu)$ 的线性方程组，这是许多 QP 求解算法的核心组成部分。\n$$\nH z + A^{\\top} \\lambda + G^{\\top} \\mu = -g \\quad (\\text{驻点条件})\n$$\n$$\nA z = b \\quad (\\text{原始可行性})\n$$\n这些可以组合成一个单一的分块矩阵方程，代表 KKT 鞍点系统的线性部分。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\nH   A^{\\top}   G^{\\top} \\\\\nA   0   0\n\\end{pmatrix}\n\\begin{pmatrix}\nz \\\\\n\\lambda \\\\\n\\mu\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n-g \\\\\nb\n\\end{pmatrix}\n}\n$$"
        }
    ]
}