{
    "hands_on_practices": [
        {
            "introduction": "在进行大规模数值模拟之前，评估所需的计算资源至关重要。网格单元的总数是决定内存消耗和计算时间的主要因素。本练习  旨在探索物理域尺寸 $D$、所需最精细分辨率 $h$ 与平衡四叉树/八叉树中叶节点单元总数 $N$ 之间的基本关系。通过推导 $N$ 的一个上界，您将具体理解网格参数如何控制计算问题的规模，这是规划和执行CFD模拟的一项基本技能。",
            "id": "3988182",
            "problem": "在航空航天计算流体动力学（CFD）的自适应网格加密中，使用四叉树（在 $d=2$ 时）和八叉树（在 $d=3$ 时）网格以不同分辨率对域进行离散化，同时为保证数值稳定性和高效计算而强制施加平衡约束。考虑一个在 $d \\in \\{2,3\\}$ 维空间中边长为 $D$ 的轴对齐正方形或立方体边界框。在此边界框内构建一个四叉树或八叉树，其最小允许叶单元边长为 $h$，且该树被强制为 $2{:}1$ 平衡，即任何两个面相邻的叶单元的边长差异最多为2倍。叶单元是二进单元；也就是说，每个叶单元的边长为 $h 2^{\\ell}$，其中 $\\ell \\ge 0$ 为某个整数。\n\n仅使用上述定义、通过体积/面积填充法对叶单元进行计数以及天花板函数的基本性质，推导出一个显式的上界常数 $C(d)$，使得叶单元数量 $N$ 对 $d=2$ 或 $d=3$ 均满足 $N \\le C(d) \\left(\\frac{D}{h}\\right)^{d}$。将您的最终结果表示为关于 $D$、$h$ 和 $d$ 的单个闭式解析表达式。无需进行四舍五入，最终表达式中不应包含任何物理单位。",
            "solution": "在进行求解之前，首先评估问题陈述的有效性。\n\n**步骤 1：提取已知条件**\n- 域：一个轴对齐的正方形或立方体（一个 $d$ 维超立方体）。\n- 维度：$d \\in \\{2, 3\\}$。\n- 边界框边长：$D$。\n- 网格类型：$d=2$ 时为四叉树，$d=3$ 时为八叉树。\n- 最小叶单元边长：$h$。\n- 平衡约束：任何两个面相邻的叶单元的边长差异最多为2倍（一个 $2:1$ 平衡约束）。\n- 单元尺寸定义：叶单元是二进的，边长为 $h 2^{\\ell}$，其中 $\\ell \\ge 0$ 为某个整数。\n- 目标：推导叶单元数量 $N$ 的一个显式上界，形式为 $N \\le C(d) \\left(\\frac{D}{h}\\right)^{d}$。推导过程必须仅使用所提供的定义、体积/面积填充论证以及天花板函数的性质。最终答案应为该上界关于 $D$、$h$ 和 $d$ 的闭式表达式。\n\n**步骤 2：使用提取的已知条件进行验证**\n该问题具有科学依据、是良定的且客观的。它描述了数值模拟中自适应网格加密（AMR）的一个标准场景。基于八叉树的网格划分、二进单元、最小单元尺寸和平衡约束等概念是该领域的基础。要求找出一个量（单元数量）的上界是一个明确定义的数学问题。所使用的语言精确且专业，没有主观或模糊的元素。该问题不违反任何无效性标准。\n\n**结论与行动**\n问题有效。将进行严谨的求解。\n\n**上界的推导**\n\n问题要求在一个维度为 $d$、边长为 $D$ 的域中，当最小允许单元边长为 $h$ 时，叶单元数量 $N$ 的一个上界。\n\n策略是确定在满足所有既定约束的情况下，使总单元数 $N$ 最大化的叶单元配置。我们可以通过体积填充论证来建立这种最坏情况。域的总体积（或当 $d=2$ 时的面积）为 $D^d$。设网格由 $N$ 个叶单元组成，其中第 $i$ 个单元的边长为 $s_i$，体积为 $s_i^d$。所有叶单元的体积之和必须等于域的体积：\n$$\n\\sum_{i=1}^{N} s_i^d = D^d\n$$\n根据定义，每个叶单元的边长为 $s_i = h 2^{\\ell_i}$，其中 $\\ell_i \\ge 0$ 为某个整数。最小边长为 $h$（当 $\\ell_i=0$ 时）。\n\n为了最大化单元数 $N$，我们必须使用尽可能小的单元。考虑一个边长为 $s_i = h 2^{\\ell}$（其中 $\\ell > 0$）的较大单元。该单元占据的体积为 $(h 2^{\\ell})^d$。同样大小的体积可以由若干个最小可能单元（边长为 $h$）来填充。这样的小单元数量为：\n$$\n\\frac{(h 2^{\\ell})^d}{h^d} = (2^{\\ell})^d\n$$\n由于 $\\ell > 0$ 且 $d \\ge 2$，我们有 $(2^{\\ell})^d > 1$。这意味着用一个由尺寸为 $h$ 的单元组成的相应网格来替换任何尺寸大于 $h$ 的单个单元，都将增加总单元数 $N$。因此，当整个域被一个由具有最小允许边长 $h$ 的单元组成的均匀网格所密铺时，叶单元的数量达到最大可能值。\n\n我们必须验证此配置是否符合问题的约束。主要约束是 $2:1$ 平衡规则。在一个所有单元边长均为 $h$ 的均匀网格中，任何两个面相邻的单元的边长分别为 $h_1 = h$ 和 $h_2 = h$。其比值为 $h_1/h_2 = 1$，满足边长差异最多为2倍的条件。因此，一个由尺寸为 $h$ 的单元组成的均匀网格是有效的网格。\n\n现在，我们计算在这种最坏情况配置下的单元数量。该域是一个边长为 $D$ 的超立方体。要用边长为 $h$ 的单元铺满该域的一个维度，所需的单元数量为 $\\lceil D/h \\rceil$。这是“填充”原理和天花板函数的直接应用，因为单元数量不可能是非整数。\n\n要铺满整个 $d$ 维域，我们需要在 $d$ 个轴的每个轴向上都有 $\\lceil D/h \\rceil$ 个单元。总单元数是这些数量的乘积，这就提供了 $N$ 的上界：\n$$\nN \\le \\left\\lceil \\frac{D}{h} \\right\\rceil^d\n$$\n问题要求将此界表示为 $C(d) \\left(\\frac{D}{h}\\right)^{d}$ 的形式。为实现这一点，我们必须找到一个常数 $C(d)$，它能将 $\\lceil x \\rceil^d$ 与 $x^d$ 联系起来，其中 $x = D/h$。对于一个非平凡的网格，域尺寸 $D$ 必须至少与最小单元尺寸 $h$ 一样大，因此 $D \\ge h$，这意味着 $x \\ge 1$。\n\n对于任何实数 $x$，天花板函数由不等式 $x \\le \\lceil x \\rceil  x+1$ 定义。我们可以使用此不等式的右侧来建立 $\\lceil x \\rceil$ 的一个上界：\n$$\n\\lceil x \\rceil  x+1\n$$\n因为我们已经确定 $x \\ge 1$，所以可以表述为 $1 \\le x$。在此不等式两边同时加上 $x$ 得到 $x+1 \\le x+x = 2x$。结合这两个结果，对于 $x \\ge 1$ 我们有：\n$$\n\\lceil x \\rceil  x+1 \\le 2x\n$$\n这意味着 $\\lceil x \\rceil \\le 2x$。将两边都提高到 $d$ 次幂（一个正指数），不等式关系保持不变：\n$$\n\\left\\lceil x \\right\\rceil^d \\le (2x)^d = 2^d x^d\n$$\n将 $x=D/h$ 代回此表达式，我们得到：\n$$\nN \\le \\left\\lceil \\frac{D}{h} \\right\\rceil^d \\le 2^d \\left(\\frac{D}{h}\\right)^d\n$$\n这就提供了所求的上界。常数为 $C(d) = 2^d$。问题要求将最终结果表示为关于 $D$、$h$ 和 $d$ 的、关于 $N$ 的上界的单个闭式解析表达式。\n\n因此，叶单元数量 $N$ 的上界是 $2^d \\left(\\frac{D}{h}\\right)^d$。",
            "answer": "$$\n\\boxed{2^d \\left(\\frac{D}{h}\\right)^d}\n$$"
        },
        {
            "introduction": "在了解了如何估算网格规模后，我们转向在网格上执行的数值运算。自适应网格加密（AMR）中的一个核心挑战是，在网格尺寸突变的粗细网格交界面上，如何确保物理守恒律（如质量、动量和能量守恒）得到严格维持。本练习  专注于设计一种守恒的通量重分配方案，这项技术通常被称为“refluxing”或通量修正。您的任务是根据与一个粗网格面相邻的多个细网格面的通量，构造出一个等效的、统一的粗网格面通量，从而在保证计算精度的同时，严格满足通量的守恒性。",
            "id": "3988152",
            "problem": "考虑一个计算流体动力学（CFD）中的二维标量平流方程，\n$$\n\\frac{\\partial u}{\\partial t} + \\nabla \\cdot (\\mathbf{a}\\, u) = 0,\n$$\n其中平流速度 $\\mathbf{a} \\in \\mathbb{R}^{2}$ 为常数，且该方程定义在一个有限体积四叉树网格上。假设一个在 $\\ell$ 层级的粗控制体有一个总长度为 $L$ 的直面，该面通过一个加密边界与 $\\ell+1$ 层级的 $m$ 个更精细的邻居单元相邻，因此该粗网格面被精确地划分为 $m$ 个长度为 $\\{l_i\\}_{i=1}^{m}$ 的不相交子面，且满足 $\\sum_{i=1}^{m} l_i = L$。用 $\\mathbf{n}$ 表示粗单元在该面上的外向单位法向量，并定义法向平流通量密度\n$$\n\\varphi(s) \\equiv (\\mathbf{a} \\cdot \\mathbf{n})\\, u(s),\n$$\n其中 $s$ 表示沿该面的弧长坐标，其原点设在粗网格面质心以确保对称性。\n\n假设在精细层级上使用二阶精确的面心重构，在子面的几何中点 $\\{s_i\\}_{i=1}^{m}$ 处提供了 $m$ 个数值通量密度值 $\\{\\phi_i\\}_{i=1}^{m}$，每个值都与 $\\varphi(s)$ 相容，即 $\\phi_i = \\varphi(s_i) + \\mathcal{O}(h_i^{2})$，其中 $h_i$ 是局部精细层级上垂直于面的特征尺寸。为了缓解 Courant–Friedrichs–Lewy (CFL) 条件对精细单元施加的小单元限制，您的任务是为一个合并控制体更新构造一个守恒的粗网格面通量，该更新允许使用粗层级时间步长，同时在光滑区域保持总质量守恒和二阶精度。\n\n从积分形式的有限体积更新和散度定理出发，并仅使用经过充分检验的数值积分性质，推导一个跨加密界面的守恒通量重分配方案，其中粗单元使用一个由 $\\{l_i\\}$ 和 $\\{\\phi_i\\}$ 计算得出的单一合并面通量密度 $\\Phi_{\\mathrm{C}}$。施加以下两个要求：\n\n- 守恒性：对于任何 $m$，积分的粗网格面通量等于跨界面所有积分的精细子面通量之和，\n$$\n\\text{积分的粗网格面通量} = \\sum_{i=1}^{m} \\text{积分的精细面通量}_i.\n$$\n\n- 在光滑区域的二阶精度：对于足够光滑的 $u(s)$，合并的粗网格面通量密度 $\\Phi_{\\mathrm{C}}$ 必须相对于面长度 $L$ 是二阶精确的，并且与 $\\{l_i\\}$ 的分布无关，前提是精细面上的局部重构是二阶精确的。\n\n请提供合并的守恒粗网格面通量密度 $\\Phi_{\\mathrm{C}}$ 的最终闭式解析表达式，用 $\\{l_i\\}$、$\\{\\phi_i\\}$ 和 $L$ 表示。您的答案必须是单个表达式。无需四舍五入，最终表达式中不应包含单位。",
            "solution": "任务是推导一个用于四叉树网格上有限体积格式的合并粗网格面通量密度（记为 $\\Phi_{\\mathrm{C}}$）的闭式解析表达式。推导过程必须满足两个特定要求：跨加密界面的通量守恒和空间上的二阶精度。\n\n设粗网格面表示为 $\\mathcal{F}$，其 $m$ 个相邻的精细层级子面表示为 $\\{\\mathcal{F}_i\\}_{i=1}^{m}$。粗网格面的长度为 $L$，子面的长度为 $\\{l_i\\}_{i=1}^{m}$，使得 $\\sum_{i=1}^{m} l_i = L$。问题给出了在精细子面几何中点处的数值通量密度值 $\\{\\phi_i\\}_{i=1}^{m}$。\n\n第一个要求是**守恒性**。这一原则是有限体积方法的基础，它要求通过粗网格面 $\\mathcal{F}$ 的总通量必须等于通过其构成的子面 $\\{\\mathcal{F}_i\\}$ 的通量之和。在有限体积的背景下，一个面上通量密度的积分近似为代表性通量密度与该面的测度（在此二维情况下为长度）的乘积。\n\n跨越粗网格面 $\\mathcal{F}$ 的积分通量由 $\\Phi_{\\mathrm{C}} L$ 给出。\n跨越第 $i$ 个精细子面 $\\mathcal{F}_i$ 的积分通量由 $\\phi_i l_i$ 给出。\n\n守恒性要求在数学上表述为：\n$$\n\\text{积分的粗网格面通量} = \\sum_{i=1}^{m} \\text{积分的精细面通量}_i\n$$\n$$\n\\Phi_{\\mathrm{C}} L = \\sum_{i=1}^{m} \\phi_i l_i\n$$\n这个方程为 $\\Phi_{\\mathrm{C}}$ 提供了一个在构造上就是守恒的唯一表达式。求解 $\\Phi_{\\mathrm{C}}$，我们得到合并的粗网格面通量密度的候选表达式：\n$$\n\\Phi_{\\mathrm{C}} = \\frac{1}{L} \\sum_{i=1}^{m} \\phi_i l_i\n$$\n该表达式代表精细面通量密度的长度加权平均值。\n\n第二个要求是**二阶精度**。我们必须验证所推导的 $\\Phi_{\\mathrm{C}}$ 表达式是否为粗网格面质心 $s=0$ 处精确通量密度 $\\varphi(s)$ 的一个二阶精确近似。也就是说，我们必须证明 $\\Phi_{\\mathrm{C}} = \\varphi(0) + \\mathcal{O}(L^2)$。\n\n我们已知精细面通量密度本身是二阶精确的：\n$$\n\\phi_i = \\varphi(s_i) + \\mathcal{O}(h_i^2)\n$$\n其中 $s_i$ 是子面 $\\mathcal{F}_i$ 的中点，$h_i$ 是局部特征单元尺寸。对于四叉树网格，$h_i$ 与面长 $l_i$ 成正比，因此我们可以将其写为 $\\phi_i = \\varphi(s_i) + \\mathcal{O}(l_i^2)$。\n\n将此代入我们关于 $\\Phi_{\\mathrm{C}}$ 的表达式中：\n$$\n\\Phi_{\\mathrm{C}} = \\frac{1}{L} \\sum_{i=1}^{m} l_i \\left( \\varphi(s_i) + \\mathcal{O}(l_i^2) \\right) = \\left( \\frac{1}{L} \\sum_{i=1}^{m} l_i \\varphi(s_i) \\right) + \\left( \\frac{1}{L} \\sum_{i=1}^{m} \\mathcal{O}(l_i^3) \\right)\n$$\n让我们分析右侧的两项。第二项是来自精细面重构的累积误差。由于 $\\sum_{i=1}^{m}l_i = L$ 且 $l_i \\le L$，我们有 $\\sum_{i=1}^{m}l_i^3 \\le \\max(l_i^2) \\sum_{i=1}^{m}l_i \\le L^2 \\cdot L = L^3$。因此，第二项的阶为 $\\frac{1}{L}\\mathcal{O}(L^3) = \\mathcal{O}(L^2)$，这与整体二阶精度的要求一致。\n\n现在我们关注第一项。为了分析其精度，我们对精确通量密度 $\\varphi(s)$ 在粗网格面质心 $s=0$ 附近进行泰勒级数展开：\n$$\n\\varphi(s) = \\varphi(0) + s \\frac{d\\varphi}{ds}\\bigg|_{s=0} + \\frac{s^2}{2} \\frac{d^2\\varphi}{ds^2}\\bigg|_{s=0} + \\mathcal{O}(s^3)\n$$\n为简化符号，令 $\\varphi'(0) = \\frac{d\\varphi}{ds}\\big|_{s=0}$ 和 $\\varphi''(0) = \\frac{d^2\\varphi}{ds^2}\\big|_{s=0}$。\n那么，$\\varphi(s_i) = \\varphi(0) + s_i \\varphi'(0) + \\frac{s_i^2}{2} \\varphi''(0) + \\mathcal{O}(s_i^3)$。\n\n我们的 $\\Phi_{\\mathrm{C}}$ 表达式的第一项变为：\n$$\n\\frac{1}{L} \\sum_{i=1}^{m} l_i \\varphi(s_i) = \\frac{1}{L} \\sum_{i=1}^{m} l_i \\left( \\varphi(0) + s_i \\varphi'(0) + \\frac{s_i^2}{2} \\varphi''(0) + \\mathcal{O}(s_i^3) \\right)\n$$\n$$\n= \\varphi(0) \\left( \\frac{1}{L} \\sum_{i=1}^{m} l_i \\right) + \\varphi'(0) \\left( \\frac{1}{L} \\sum_{i=1}^{m} l_i s_i \\right) + \\frac{\\varphi''(0)}{2} \\left( \\frac{1}{L} \\sum_{i=1}^{m} l_i s_i^2 \\right) + \\mathcal{O}(L^2)\n$$\n我们分析每个系数：\n1.  由于 $\\sum_{i=1}^{m} l_i = L$，$\\varphi(0)$ 的系数为 1。主导项正确地为 $\\varphi(0)$。\n2.  $\\varphi'(0)$ 的系数涉及求和 $\\sum_{i=1}^{m} l_i s_i$。这是对积分 $\\int_{-L/2}^{L/2} s \\, ds$ 的复合中点法则求积。中点法则的一个众所周知的性质是它对 1 次多项式是精确的。因此：\n    $$\n    \\sum_{i=1}^{m} l_i s_i = \\sum_{i=1}^{m} \\int_{\\mathcal{F}_i} s \\, ds = \\int_{-L/2}^{L/2} s \\, ds = \\left[ \\frac{s^2}{2} \\right]_{-L/2}^{L/2} = 0\n    $$\n    与 $\\varphi'(0)$ 成正比的项消失了，这意味着该格式至少是一阶精确的。\n3.  $\\varphi''(0)$ 的系数涉及求和 $\\sum_{i=1}^{m} l_i s_i^2$，它近似于 $\\int_{-L/2}^{L/2} s^2 \\, ds = \\frac{L^3}{12}$。这个和代表了求积的主阶截断误差。对于被积函数 $f(s)$，中点法则在长度为 $l$ 的区间上的误差为 $\\frac{l^3}{24} f''(\\xi)$。这里，$f(s) = s^2$，所以 $f''(s) = 2$。\n    在子面 $\\mathcal{F}_i$ 上的误差为 $\\int_{\\mathcal{F}_i} s^2 ds - l_i s_i^2 = \\frac{l_i^3}{12}$。\n    对误差求和：$\\int_{-L/2}^{L/2} s^2 ds - \\sum_{i=1}^{m} l_i s_i^2 = \\sum_{i=1}^{m} \\frac{l_i^3}{12}$。\n    所以，$\\sum_{i=1}^{m} l_i s_i^2 = \\frac{L^3}{12} - \\frac{1}{12}\\sum_{i=1}^{m} l_i^3$。\n    展开式中的第三项是 $\\frac{\\varphi''(0)}{2L} \\left(\\frac{L^3}{12} - \\frac{1}{12}\\sum_{i=1}^{m} l_i^3 \\right) = \\frac{\\varphi''(0)}{24} \\left( L^2 - \\frac{1}{L}\\sum_{i=1}^{m} l_i^3 \\right)$。这整个项的阶为 $\\mathcal{O}(L^2)$。\n\n综合所有结果，$\\Phi_{\\mathrm{C}}$ 的完整表达式为：\n$$\n\\Phi_{\\mathrm{C}} = \\varphi(0) + \\frac{\\varphi''(0)}{24} \\left( L^2 - \\frac{1}{L}\\sum_{i=1}^{m} l_i^3 \\right) + \\mathcal{O}(L^2) + \\mathcal{O}(L^3)\n$$\n总误差由 $\\mathcal{O}(L^2)$ 阶的项主导。因此，$\\Phi_{\\mathrm{C}} = \\varphi(0) + \\mathcal{O}(L^2)$，二阶精度要求得到满足。\n\n因此，所推导的表达式既是守恒的又是二阶精确的，并且它仅依赖于给定的量 $\\{l_i\\}$、$\\{\\phi_i\\}$ 和 $L$。",
            "answer": "$$\n\\boxed{\\frac{1}{L} \\sum_{i=1}^{m} \\phi_i l_i}\n$$"
        },
        {
            "introduction": "一个数值正确的求解器是必要的，但还不够；对于实际应用，它还必须具备高计算效率。在现代并行处理器（如GPU）上，从内存中移动数据的成本可能远超算术运算的成本，使访存成为关键的性能瓶颈。本练习  介绍了一种称为“核函数融合”（kernel fusion）的强大优化策略，它将多个计算步骤合并到单次处理中以最大限度地减少数据移动。您将使用高性能计算领域的标准工具——Roofline性能模型，来分析并量化由此带来的性能提升。通过解决这个问题，您将把数值算法设计与硬件性能特性联系起来，为理解和优化CFD求解器在现代计算架构上的性能提供一个量化框架。",
            "id": "3988141",
            "problem": "考虑一个求解可压缩欧拉方程的三维八叉树自适应网格加密（AMR）有限体积求解器，其中每个单元有 $n_v = 5$ 个守恒变量。在粗细网格界面处，一个粗网格面与 $4$ 个细网格面重合。在一个时间步长 $\\Delta t$ 内，对体积为 $V$ 的单元进行的离散有限体积更新使用通过面积为 $A$ 的面的通量 $\\mathbf{F}$，通过更新式 $\\mathbf{Q}^{n+1} = \\mathbf{Q}^{n} - (\\Delta t\\,A/V)\\,\\mathbf{F}$ 逐分量地应用于守恒变量向量。粗细网格通量修正通过将粗网格面通量替换为其 $4$ 个细网格面通量之和来强制守恒。\n\n要求您设计一个融合核函数（fused kernel），该核函数在单次处理中同时执行粗细网格通量修正和相应的状态更新，而无需将任何修正后的通量写回全局内存。基线实现使用两个核函数：用于粗细网格通量修正的核函数 $\\mathcal{C}$，它读取通量并写入修正后的粗网格通量；以及用于状态更新的核函数 $\\mathcal{U}$，它读取通量和状态并写入更新后的状态。假设使用单精度存储（每个标量 $s = 4\\,\\mathrm{B}$），并且只考虑与单个粗细网格面片（patch）相关的工作，该面片由一个粗网格面及其对应的 $4$ 个细网格面组成；忽略所涉及单元的所有其他面。\n\n对于此面片，对每个变量的工作量做出以下科学上现实的假设：\n- 通量修正计算修正后的粗网格通量，即 $4$ 个细网格通量之和（逐分量），并与原始粗网格通量求差，每个变量耗费 $4$ 个浮点运算（flops）（三次加法用于求和 $4$ 个细网格值，一次减法用于与原始粗网格通量求差）。\n- 状态更新对粗网格单元使用修正后的粗网格通量，对 $4$ 个细网格单元使用预先计算的细网格通量。对于每个单元-面贡献，每次变量更新需要 $2$ 个浮点运算（一次乘以 $(\\Delta t\\,A/V)$ 和一次加/减法）。计算一次粗网格单元和 $4$ 个细网格单元，这为界面贡献提供了每个变量 $10$ 个浮点运算。\n\n在这些假设下：\n- 基线内存流量 $B_0$（读取加写入），对于核函数 $\\mathcal{C}$ 和 $\\mathcal{U}$ 合计，每个面片由以下部分组成：\n  • 核函数 $\\mathcal{C}$：读取一个粗网格面通量和 $4$ 个细网格面通量，并写入一个修正后的粗网格面通量。\n  • 核函数 $\\mathcal{U}$：读取粗网格单元状态和修正后的粗网格面通量，写入更新后的粗网格单元状态；同样地，对所有 $4$ 个细网格单元，分别读取其单元状态和细网格面通量，并写入更新后的细网格单元状态。\n- 融合内存流量 $B_1$ 一次性读取粗/细网格面通量和粗/细网格单元状态，且只写入更新后的粗/细网格单元状态，不写入通量。\n\n令 $W$ 为每个面片的总浮点运算数，$P_{\\text{peak}}$ 为设备峰值浮点运算速率，$B_W$ 为持续内存带宽。使用 Roofline 性能模型，其中对于给定的内存流量 $B$，每个面片的运行时间为 $T = \\max\\!\\big(W/P_{\\text{peak}},\\,B/B_W\\big)$。\n\n任务：\n1. 在上述假设下，推导 $B_0$ 和 $B_1$（以字节为单位）作为 $n_v$ 和 $s$ 的函数。\n2. 推导每个面片的浮点运算数 $W$ 作为 $n_v$ 的函数。\n3. 使用 Roofline 模型，推导加速比 $S = T_0/T_1$ 的封闭形式表达式，用 $W$、$B_0$、$B_1$、$P_{\\text{peak}}$ 和 $B_W$ 表示，其中 $T_0$ 和 $T_1$ 分别是基线和融合实现的每个面片的运行时间。\n4. 对于 $n_v = 5$，$s = 4\\,\\mathrm{B}$，$P_{\\text{peak}} = 10 \\times 10^{12}\\,\\mathrm{flop/s}$ 和 $B_W = 9.0 \\times 10^{11}\\,\\mathrm{B/s}$，数值计算 $S$。将最终加速比表示为一个无量纲数。\n5. 量化加速比的渐近极限：当 $W/P_{\\text{peak}} \\ll B/B_W$ 时的内存受限极限 $S_{\\text{mem}}$ 和当 $W/P_{\\text{peak}} \\gg B/B_W$ 时的计算受限极限 $S_{\\text{comp}}$。\n\n将您的最终答案以单行矩阵 $\\big(S,\\;S_{\\text{mem}},\\;S_{\\text{comp}}\\big)$ 的形式返回，并将所有报告的数字四舍五入到四位有效数字。最终的方框答案中不应包含任何单位。",
            "solution": "在进行求解之前，根据指定标准对问题进行验证。\n\n### 第 1 步：提取给定条件\n- 求解器类型：用于可压缩欧拉方程的三维八叉树自适应网格加密（AMR）有限体积求解器。\n- 每个单元的守恒变量数：$n_v = 5$。\n- 粗细网格界面几何：一个粗网格面与 $4$ 个细网格面重合。\n- 有限体积更新公式：$\\mathbf{Q}^{n+1} = \\mathbf{Q}^{n} - (\\Delta t\\,A/V)\\,\\mathbf{F}$。\n- 通量修正规则：粗网格面通量被其 $4$ 个细网格面通量之和替换。\n- 融合核函数目标：在单次处理中执行通量修正和状态更新，而不将修正后的通量写回全局内存。\n- 基线实现：两个核函数，$\\mathcal{C}$（通量修正）和 $\\mathcal{U}$（状态更新）。\n- 存储大小：单精度，每个标量 $s = 4\\,\\mathrm{B}$。\n- 计算范围：一个由一个粗网格面和 $4$ 个相应细网格面组成的单一面片。\n- 通量修正的浮点运算数：每个变量 $4$ flops。\n- 状态更新的浮点运算数：每个单元-面贡献每个变量 $2$ flops，整个面片总计每个变量 $10$ flops。\n- 基线内存流量 $B_0$：\n  - 核函数 $\\mathcal{C}$：读取 $1$ 个粗网格通量，$4$ 个细网格通量；写入 $1$ 个修正后的粗网格通量。\n  - 核函数 $\\mathcal{U}$：读取粗网格状态、修正后的粗网格通量，写入更新后的粗网格状态；读取 $4$ 个细网格状态中的每一个、其细网格通量，写入更新后的细网格状态。\n- 融合内存流量 $B_1$：一次性读取粗/细网格通量和粗/细网格状态；写入更新后的粗/细网格状态。\n- 性能模型：Roofline 模型，$T = \\max(W/P_{\\text{peak}}, B/B_W)$。\n- $P_{\\text{peak}} = 10 \\times 10^{12}\\,\\mathrm{flop/s}$。\n- $B_W = 9.0 \\times 10^{11}\\,\\mathrm{B/s}$。\n- 任务：\n  1. 推导 $B_0$ 和 $B_1$ 作为 $n_v$ 和 $s$ 的函数。\n  2. 推导 $W$ 作为 $n_v$ 的函数。\n  3. 推导加速比 $S = T_0/T_1$。\n  4. 对给定参数计算 $S$。\n  5. 找到渐近极限 $S_{\\text{mem}}$ 和 $S_{\\text{comp}}$。\n\n### 第 2 步：使用提取的给定条件进行验证\n根据验证标准对问题进行评估。\n- **科学基础**：AMR 在 CFD 中的应用、有限体积法、粗细网格界面处的通量修正、作为优化策略的核函数融合以及 Roofline 性能模型，这些都是计算科学和高性能计算中标准且成熟的概念。所陈述的假设是现实的，并与该领域的实践相符。\n- **适定性**：问题定义清晰，提供了所有必要的参数、定义和假设。任务具体，能导出一个唯一且有意义的解。\n- **客观性**：语言技术性强、精确，没有主观或含糊的陈述。\n\n该问题是一致的、自洽的，并牢固地植根于有效的科学和计算原理。它没有违反任何无效性标准。\n\n### 第 3 步：结论和行动\n问题被判定为**有效**。将构建一个解决方案。\n\n### 任务 1：推导内存流量 $B_0$ 和 $B_1$\n\n首先，我们计算基线内存流量 $B_0$，它是核函数 $\\mathcal{C}$ 和核函数 $\\mathcal{U}$ 流量的总和。一个面通量或一个单元状态是包含 $n_v$ 个变量的向量，因此其大小（以字节为单位）是 $n_v s$。\n\n对于核函数 $\\mathcal{C}$（通量修正）：\n- 读取：$1$ 个粗网格面通量和 $4$ 个细网格面通量。总读取量：$(1+4) n_v s = 5 n_v s$。\n- 写入：$1$ 个修正后的粗网格面通量。总写入量：$1 \\cdot n_v s = n_v s$。\n核函数 $\\mathcal{C}$ 的流量为 $B_{\\mathcal{C}} = 5 n_v s + n_v s = 6 n_v s$。\n\n对于核函数 $\\mathcal{U}$（状态更新）：\n- 粗网格单元更新：读取 $1$ 个粗网格单元状态（$n_v s$）和 $1$ 个修正后的粗网格面通量（$n_v s$）。写入 $1$ 个更新后的粗网格单元状态（$n_v s$）。流量：$n_v s + n_v s + n_v s = 3 n_v s$。\n- 细网格单元更新：对于 $4$ 个细网格单元中的每一个，它读取 $1$ 个细网格单元状态（$n_v s$）及其 $1$ 个细网格面通量（$n_v s$），并写入 $1$ 个更新后的细网格单元状态（$n_v s$）。每个细网格单元的流量是 $3 n_v s$。$4$ 个细网格单元的总流量：$4 \\times (3 n_v s) = 12 n_v s$。\n核函数 $\\mathcal{U}$ 的总流量为 $B_{\\mathcal{U}} = 3 n_v s + 12 n_v s = 15 n_v s$。\n\n基线总内存流量为 $B_0 = B_{\\mathcal{C}} + B_{\\mathcal{U}} = 6 n_v s + 15 n_v s = 21 n_v s$。\n\n接下来，我们计算融合内存流量 $B_1$。融合核函数一次性读取所有输入，并且只写入最终更新的状态。\n- 读取：$1$ 个粗网格通量，$4$ 个细网格通量，$1$ 个粗网格状态和 $4$ 个细网格状态。读取的总对象数：$1+4+1+4=10$。总读取量：$10 n_v s$。\n- 写入：$1$ 个更新后的粗网格状态和 $4$ 个更新后的细网格状态。写入的总对象数：$1+4=5$。总写入量：$5 n_v s$。\n融合总内存流量为 $B_1 = 10 n_v s + 5 n_v s = 15 n_v s$。\n\n因此，$B_0 = 21 n_v s$ 且 $B_1 = 15 n_v s$。\n\n### 任务 2：推导总浮点运算数 $W$\n\n总浮点运算数 $W$ 是通量修正和状态更新的计算工作量之和。对于基线和融合实现，这个值保持不变，因为融合只是重新排列操作以改善数据局部性并减少内存流量，而不改变算术运算。\n\n- 通量修正工作量：问题陈述这需要每个变量 $4$ 个浮点运算。对于 $n_v$ 个变量，这是 $W_{\\text{corr}} = 4 n_v$。\n- 状态更新工作量：问题陈述这需要整个面片每个变量 $10$ 个浮点运算。对于 $n_v$ 个变量，这是 $W_{\\text{update}} = 10 n_v$。\n\n每个面片的总浮点运算数为 $W = W_{\\text{corr}} + W_{\\text{update}} = 4 n_v + 10 n_v = 14 n_v$。\n\n### 任务 3：推导加速比 $S$\n\nRoofline 性能模型给出了具有内存流量 $B$ 和浮点运算数 $W$ 的核函数的运行时间 $T$ 为：\n$$T = \\max\\left(\\frac{W}{P_{\\text{peak}}}, \\frac{B}{B_W}\\right)$$\n这里，$W/P_{\\text{peak}}$ 是计算受限时间，$B/B_W$ 是内存受限时间。\n\n基线实现的运行时间为 $T_0$：\n$$T_0 = \\max\\left(\\frac{W}{P_{\\text{peak}}}, \\frac{B_0}{B_W}\\right)$$\n融合实现的运行时间为 $T_1$：\n$$T_1 = \\max\\left(\\frac{W}{P_{\\text{peak}}}, \\frac{B_1}{B_W}\\right)$$\n加速比 $S$ 是运行时间的比率，$S = T_0 / T_1$。\n$$S = \\frac{\\max\\left(\\frac{W}{P_{\\text{peak}}}, \\frac{B_0}{B_W}\\right)}{\\max\\left(\\frac{W}{P_{\\text{peak}}}, \\frac{B_1}{B_W}\\right)}$$\n\n### 任务 4：$S$ 的数值计算\n\n我们给定的参数是 $n_v = 5$，$s = 4\\,\\mathrm{B}$，$P_{\\text{peak}} = 10 \\times 10^{12}\\,\\mathrm{flop/s}$ 和 $B_W = 9.0 \\times 10^{11}\\,\\mathrm{B/s}$。\n\n首先，我们用给定的 $n_v$ 和 $s$ 计算 $W$、$B_0$ 和 $B_1$：\n- $W = 14 n_v = 14 \\times 5 = 70\\,\\text{flops}$。\n- $B_0 = 21 n_v s = 21 \\times 5 \\times 4 = 420\\,\\mathrm{B}$。\n- $B_1 = 15 n_v s = 15 \\times 5 \\times 4 = 300\\,\\mathrm{B}$。\n\n接下来，我们计算计算时间和内存时间：\n- 计算时间：$T_{\\text{comp}} = \\frac{W}{P_{\\text{peak}}} = \\frac{70}{10 \\times 10^{12}} = 7.0 \\times 10^{-12}\\,\\mathrm{s}$。\n- 基线内存时间：$T_{\\text{mem},0} = \\frac{B_0}{B_W} = \\frac{420}{9.0 \\times 10^{11}} \\approx 4.6667 \\times 10^{-10}\\,\\mathrm{s}$。\n- 融合内存时间：$T_{\\text{mem},1} = \\frac{B_1}{B_W} = \\frac{300}{9.0 \\times 10^{11}} \\approx 3.3333 \\times 10^{-10}\\,\\mathrm{s}$。\n\n现在我们确定运行时间 $T_0$ 和 $T_1$。我们比较 $T_{\\text{comp}}$ 与 $T_{\\text{mem},0}$ 和 $T_{\\text{mem},1}$。\n- $T_0 = \\max(7.0 \\times 10^{-12}\\,\\mathrm{s}, 4.6667 \\times 10^{-10}\\,\\mathrm{s}) = 4.6667 \\times 10^{-10}\\,\\mathrm{s}$。\n- $T_1 = \\max(7.0 \\times 10^{-12}\\,\\mathrm{s}, 3.3333 \\times 10^{-10}\\,\\mathrm{s}) = 3.3333 \\times 10^{-10}\\,\\mathrm{s}$。\n由于在这两种情况下，内存时间远大于计算时间，因此两个核函数都是内存受限的。\n\n加速比 $S$ 是：\n$$S = \\frac{T_0}{T_1} = \\frac{4.6667 \\times 10^{-10}}{3.3333 \\times 10^{-10}} = \\frac{B_0/B_W}{B_1/B_W} = \\frac{B_0}{B_1} = \\frac{420}{300} = \\frac{42}{30} = \\frac{7}{5} = 1.4$$\n四舍五入到四位有效数字，$S = 1.400$。\n\n### 任务 5：加速比的渐近极限\n\n我们在两个渐近状态下分析加速比 $S$。\n\n**内存受限极限** $S_{\\text{mem}}$ 发生在核函数受内存带宽限制时，即 $W/P_{\\text{peak}} \\ll B/B_W$。在此极限下，$\\max$ 函数对 $T_0$ 和 $T_1$ 都返回内存时间分量：\n$$T_0 \\to \\frac{B_0}{B_W} \\quad \\text{和} \\quad T_1 \\to \\frac{B_1}{B_W}$$\n加速比变为：\n$$S_{\\text{mem}} = \\frac{B_0/B_W}{B_1/B_W} = \\frac{B_0}{B_1} = \\frac{21 n_v s}{15 n_v s} = \\frac{21}{15} = \\frac{7}{5} = 1.4$$\n四舍五入到四位有效数字，$S_{\\text{mem}} = 1.400$。\n\n**计算受限极限** $S_{\\text{comp}}$ 发生在核函数受处理器浮点性能限制时，即 $W/P_{\\text{peak}} \\gg B/B_W$。在此极限下，$\\max$ 函数对 $T_0$ 和 $T_1$ 都返回计算时间分量：\n$$T_0 \\to \\frac{W}{P_{\\text{peak}}} \\quad \\text{和} \\quad T_1 \\to \\frac{W}{P_{\\text{peak}}}$$\n加速比变为：\n$$S_{\\text{comp}} = \\frac{W/P_{\\text{peak}}}{W/P_{\\text{peak}}} = 1$$\n这个结果是合乎逻辑的：如果性能完全由浮点运算的数量决定，而核函数融合不改变这个数量，那么就没有加速。四舍五入到四位有效数字，$S_{\\text{comp}} = 1.000$。\n\n最终答案是行矩阵 $(S, S_{\\text{mem}}, S_{\\text{comp}})$，其值四舍五入到四位有效数字。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 1.400  1.400  1.000 \\end{pmatrix}}\n$$"
        }
    ]
}