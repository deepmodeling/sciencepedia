{
    "hands_on_practices": [
        {
            "introduction": "我们从最直观的验证工具——有限差分法开始。虽然概念简单，但其精度对所选步长 $h$ 的大小高度敏感。本练习将引导你通过理论分析，深入理解截断误差与舍入误差之间的权衡，并最终推导出给定问题的最佳步长。这项实践将为你构建梯度验证中数值挑战的坚实基础。",
            "id": "3942381",
            "problem": "考虑一个由离散残差方程 $\\mathbf{R}(\\mathbf{u},p)=\\mathbf{0}$ 控制的稳态、无粘性空气动力学分析，其中 $\\mathbf{u}$ 是收敛的流场状态，而 $p$ 是一个代表攻角（以弧度为单位）的标量设计参数。目标函数是阻力系数 $J(\\mathbf{u}(p),p)$，其在基准 $p_0$ 处的全导数 $\\mathrm{d}J/\\mathrm{d}p$ 可通过伴随计算得到。为使用有限差分梯度检验来验证伴随方法，您需要构建一个中心差分估计量，并确定一个能平衡截断误差和浮点舍入误差的最优扰动大小。\n\n假设如下：\n\n- 每个收敛的目标函数求值 $J(p)$ 满足标准浮点模型 $\\mathrm{fl}(J(p))=J(p)(1+\\delta)$，其中 $|\\delta|\\le u$，$u$ 是双精度算术的单位舍入，$u=2.22\\times 10^{-16}$。\n- 函数 $J(p)$ 在 $p_0$ 附近足够光滑，因此关于 $p_0$ 的泰勒展开是有效的。\n- 基准参数为 $p_0=2\\pi/180$ 弧度。\n- 您已执行五次高保真度收敛流场求解，在 $p_0$ 附近得到以下目标函数值（角度以弧度为单位）：\n  - $J(p_0)=0.015000000000000$，\n  - $J(p_0+h_1)=0.015003450000000$，\n  - $J(p_0-h_1)=0.014997350000000$，\n  - $J(p_0+2h_1)=0.015008000000000$，\n  - $J(p_0-2h_1)=0.014995200000000$，\n  其中 $h_1=1.0\\times 10^{-3}$。\n\n任务：\n\n1) 从 $J(p_0\\pm h)$ 关于 $p_0$ 的泰勒展开式和中心差分的定义出发，为 $p_0$ 处的 $\\mathrm{d}J/\\mathrm{d}p$ 构建一个中心差分梯度检验 $\\tilde{g}(h)$，并识别出以 $h$ 的幂表示的主阶截断误差项。\n\n2) 使用 $J$ 求值的浮点模型以及和与差的标准误差传播法则，推导 $\\tilde{g}(h)$ 中由舍入误差贡献的主阶误差界，该界用 $u$、$|J(p_0)|$ 和 $h$ 表示。\n\n3) 将您的截断误差模型和舍入误差模型组合成一个单一的主阶误差模型 $E(h)$，并通过最小化 $E(h)$（相对于 $h$）来推导最优步长 $h_\\star$ 的闭式表达式，该表达式用 $u$、对 $|J^{(3)}(p_0)|$ 的局部估计和 $|J(p_0)|$ 表示。\n\n4) 使用提供的目标函数值来获得：\n   - 中心差分估计值 $\\tilde{g}(h_1)$ 和 $\\tilde{g}(2h_1)$，\n   - 基于这两个中心差分估计值之差的 $|J^{(3)}(p_0)|$ 的局部光滑性估计，\n   - 然后计算 $h_\\star$ 的数值（以弧度为单位）。\n\n将您的 $h_\\star$ 最终数值答案以弧度表示，并四舍五入到三位有效数字。最终答案必须是一个单一的数字。",
            "solution": "我们从第一性原理开始：通过在 $p_0$ 周围的对称扰动点上对 $J$ 进行求值来构建中心差分梯度检验。令 $\\Delta p=h$。$J$ 关于 $p_0$ 的泰勒展开式为\n$$\nJ(p_0+h)=J(p_0)+J'(p_0)h+\\frac{J''(p_0)}{2}h^2+\\frac{J^{(3)}(p_0)}{6}h^3+\\mathcal{O}(h^4),\n$$\n$$\nJ(p_0-h)=J(p_0)-J'(p_0)h+\\frac{J''(p_0)}{2}h^2-\\frac{J^{(3)}(p_0)}{6}h^3+\\mathcal{O}(h^4).\n$$\n将这两个表达式相减得到\n$$\nJ(p_0+h)-J(p_0-h)=2J'(p_0)h+\\frac{J^{(3)}(p_0)}{3}h^3+\\mathcal{O}(h^5).\n$$\n两边同除以 $2h$ 得到中心差分估计量\n$$\n\\tilde{g}(h)\\equiv \\frac{J(p_0+h)-J(p_0-h)}{2h}=J'(p_0)+\\frac{J^{(3)}(p_0)}{6}h^2+\\mathcal{O}(h^4).\n$$\n因此，主阶截断误差为 $\\frac{J^{(3)}(p_0)}{6}h^2$。\n\n接下来，我们对舍入误差进行建模。每个目标函数值以浮点数形式返回，即 $\\mathrm{fl}(J(p))=J(p)(1+\\delta)$，其中 $|\\delta|\\le u$。在浮点运算中计算的中心差分分子为\n$$\n\\mathrm{fl}(J(p_0+h))-\\mathrm{fl}(J(p_0-h))=[J(p_0+h)-J(p_0-h)]+[J(p_0+h)\\delta_1-J(p_0-h)\\delta_2],\n$$\n其中 $|\\delta_1|,|\\delta_2|\\le u$。由舍入误差引起的分子的最坏情况绝对扰动由以下公式界定\n$$\n|J(p_0+h)\\delta_1-J(p_0-h)\\delta_2|\\le u\\left(|J(p_0+h)|+|J(p_0-h)|\\right).\n$$\n对于足够小的 $h$，有 $|J(p_0\\pm h)|\\approx |J(p_0)|$，因此\n$$\n|J(p_0+h)\\delta_1-J(p_0-h)\\delta_2|\\lesssim 2u|J(p_0)|.\n$$\n除以精确分母 $2h$ 以评估对 $\\tilde{g}(h)$ 的影响，得到主阶舍入误差界\n$$\nE_{\\mathrm{ro}}(h)\\lesssim \\frac{u|J(p_0)|}{h}.\n$$\n\n结合截断误差和舍入误差的贡献，中心差分估计量的主阶误差模型为\n$$\nE(h)\\approx \\frac{|J^{(3)}(p_0)|}{6}h^2+\\frac{u|J(p_0)|}{h}.\n$$\n为求最优的 $h_\\star$，我们在 $h>0$ 上最小化 $E(h)$。对 $h$ 求导并令其为零，\n$$\n\\frac{\\mathrm{d}E}{\\mathrm{d}h}=\\frac{|J^{(3)}(p_0)|}{3}h-\\frac{u|J(p_0)|}{h^2}=0\n\\quad\\Longrightarrow\\quad\n\\frac{|J^{(3)}(p_0)|}{3}h^3=u|J(p_0)|.\n$$\n解出 $h$ 得到闭式最优步长\n$$\nh_\\star=\\left(\\frac{3u|J(p_0)|}{|J^{(3)}(p_0)|}\\right)^{1/3}.\n$$\n\n现在我们从提供的数据中估计所需的局部量。首先计算在 $h_1$ 和 $2h_1$ 处的中心差分估计值：\n$$\n\\tilde{g}(h_1)=\\frac{J(p_0+h_1)-J(p_0-h_1)}{2h_1}\n=\\frac{0.015003450000000-0.014997350000000}{2\\times 10^{-3}}\n=\\frac{6.10\\times 10^{-6}}{2\\times 10^{-3}}=0.00305,\n$$\n$$\n\\tilde{g}(2h_1)=\\frac{J(p_0+2h_1)-J(p_0-2h_1)}{2(2h_1)}\n=\\frac{0.015008000000000-0.014995200000000}{4\\times 10^{-3}}\n=\\frac{1.28\\times 10^{-5}}{4\\times 10^{-3}}=0.0032.\n$$\n对于中心差分估计量，主阶截断误差满足\n$$\n\\tilde{g}(h)=J'(p_0)+\\frac{J^{(3)}(p_0)}{6}h^2+\\mathcal{O}(h^4),\\qquad\n\\tilde{g}(2h)=J'(p_0)+\\frac{J^{(3)}(p_0)}{6}(2h)^2+\\mathcal{O}(h^4).\n$$\n将这两个表达式相减可以消去 $J'(p_0)$ 并得到\n$$\n\\tilde{g}(2h)-\\tilde{g}(h)\\approx \\frac{J^{(3)}(p_0)}{6}\\left(4h^2-h^2\\right)=\\frac{J^{(3)}(p_0)}{2}h^2,\n$$\n因此，局部光滑性的估计值为\n$$\nJ^{(3)}(p_0)\\approx \\frac{2\\left(\\tilde{g}(2h)-\\tilde{g}(h)\\right)}{h^2}.\n$$\n使用 $h=h_1=10^{-3}$ 和上述值，\n$$\nJ^{(3)}(p_0)\\approx \\frac{2\\left(0.0032-0.00305\\right)}{\\left(10^{-3}\\right)^2}\n=\\frac{2\\cdot 1.5\\times 10^{-4}}{10^{-6}}=300.\n$$\n我们还有 $|J(p_0)|=0.015000000000000\\approx 0.015$。\n\n最后，将 $u=2.22\\times 10^{-16}$、 $|J(p_0)|=0.015$ 和 $|J^{(3)}(p_0)|=300$ 代入 $h_\\star$ 的表达式中：\n$$\nh_\\star=\\left(\\frac{3\\cdot 2.22\\times 10^{-16}\\cdot 0.015}{300}\\right)^{1/3}\n=\\left(\\frac{9.99\\times 10^{-18}}{300}\\right)^{1/3}\n=\\left(3.33\\times 10^{-20}\\right)^{1/3}.\n$$\n计算立方根：\n$$\n\\left(3.33\\times 10^{-20}\\right)^{1/3}=\\left(33.3\\times 10^{-21}\\right)^{1/3} = (33.3)^{1/3} \\times 10^{-7} \\approx 3.22 \\times 10^{-7}.\n$$\n四舍五入到三位有效数字并以弧度表示，最优步长为 $3.22\\times 10^{-7}$。",
            "answer": "$$\\boxed{3.22\\times 10^{-7}}$$"
        },
        {
            "introduction": "为了克服有限差分法的局限性，我们现在转向一种更强大、更精确的技术：复步法。本练习涉及一个具体的编程实现，你将计算一个基于伴随方法的梯度，并使用复步近似对其进行验证，后者因其能避免灾难性的相减抵消误差而闻名。通过完成此练习，你将获得对最先进验证方法的实践经验，并能体会其近乎机器精度的准确性。",
            "id": "3942369",
            "problem": "给定一个代表计算流体力学（CFD）残差的离散稳态模型，以及一个依赖于状态和标量设计参数的目标泛函。设 $p \\in \\mathbb{R}$ 为标量参数， $u(p) \\in \\mathbb{R}^N$ 为状态向量，由以下离散残差方程隐式定义\n$$\nR(u,p) = A(p) u - b = 0,\n$$\n其中 $A(p) \\in \\mathbb{R}^{N \\times N}$ 是一个参数依赖矩阵，$b \\in \\mathbb{R}^N$ 是一个固定的右端向量，$N$ 是区间 $[0,1]$ 上一维网格的内部节点数。设离散拉普拉斯矩阵 $L \\in \\mathbb{R}^{N \\times N}$ 为标准的二阶中心差分三对角算子，并按网格间距进行缩放。定义\n$$\nA(p) = I + p L,\n$$\n其中 $I \\in \\mathbb{R}^{N \\times N}$ 是单位矩阵。设右端项是 $b(x) = \\sin(\\pi x)$ 在内部网格点上的离散化。定义目标泛函为\n$$\nJ(u,p) = \\frac{1}{2} u^\\top W u + \\gamma p^2,\n$$\n其中 $W \\in \\mathbb{R}^{N \\times N}$ 是一个对角矩阵，其元素为 $w_i = 1 + \\cos(2 \\pi x_i)$，$x_i$ 是 $[0,1]$ 上的内部网格点，$\\gamma > 0$ 是一个给定的常数。\n\n从约束优化中针对残差方程的拉格朗日乘子（伴随）方法的基本原理以及复解析函数的泰勒级数展开出发，推导一个计算方案，该方案能够：\n\n1. 通过强制执行 $R(u,p)=0$ 来求解 $u(p)$。\n2. 通过求解伴随系统并评估从残差和目标泛函定义中推导出的相应敏感性表达式，来计算基于伴随的梯度 $g_{\\mathrm{adj}}(p) = \\frac{\\partial J}{\\partial p}$。\n3. 通过在 $p + i h$ 处（其中 $h>0$ 是一个纯虚数扰动的大小）评估 $J$，并提取经 $h$ 缩放后的虚部，来实现复步法以计算 $g_{\\mathrm{cs}}(p)$。\n4. 为一组参数值的测试套件生成绝对误差 $\\left|g_{\\mathrm{adj}}(p) - g_{\\mathrm{cs}}(p)\\right|$。\n\n您的实现必须遵循以下规范：\n\n- 使用 $N = 50$，在 $(0,1)$ 上的均匀内部网格点 $x_i$，网格间距为 $h_x = \\frac{1}{N+1}$。\n- 将 $L$ 构建为标准的二阶中心差分矩阵，其元素为 $L_{ii} = -\\frac{2}{h_x^2}$，$L_{i,i+1} = L_{i+1,i} = \\frac{1}{h_x^2}$，其余位置为零。\n- 将 $W$ 构建为对角矩阵，其对角元素为 $W_{ii} = 1 + \\cos(2 \\pi x_i)$。\n- 使用 $\\gamma = 0.7$。\n- 使用 $b_i = \\sin(\\pi x_i)$。\n- 对于伴随方法，使用拉格朗日框架：求解伴随方程 $A(p)^\\top \\lambda = \\frac{\\partial J}{\\partial u}$，然后使用从 $R(u,p)=0$ 推导出的敏感性恒等式来评估梯度。\n- 对于复步法，使用 $h = 10^{-30}$ 来评估 $J(u(p + i h), p + i h)$，并将 $\\frac{\\partial J}{\\partial p}$ 近似为 $\\operatorname{Im}(J(p + i h))/h$。确保实现过程以全纯方式处理所有代数运算（在目标函数计算中不要使用复共轭）。\n- 您的程序应计算以下参数值测试套件（以实数表示）的绝对误差 $\\left|g_{\\mathrm{adj}}(p) - g_{\\mathrm{cs}}(p)\\right|$：$p \\in \\{0.0, 10^{-8}, 0.1, 1.0, 10.0\\}$。\n- 最终输出格式必须是单行，包含一个方括号内的逗号分隔列表，其中每个条目是按给定顺序对应的测试用例的绝对误差（例如，$[e_1,e_2,e_3,e_4,e_5]$）。\n- 本问题不涉及任何物理单位、角度单位或百分比；所有数值结果均为无量纲实数。\n\n目标是使用复步法验证基于伴随的敏感性，并从第一性原理出发，解释为什么复步法可以避免相消误差，以及 $\\operatorname{Im}(J(p + i h))/h$ 作为 $\\frac{dJ}{dp}$ 的近似，其预期的精度界限是什么。",
            "solution": "该问题要求推导并实现一个计算方案，用于求解目标泛函关于设计参数的梯度，其中系统状态由一个线性方程组隐式定义。该梯度需要使用两种不同的方法计算：伴随方法和复步法。然后对结果进行比较，以验证伴随方法的实现。\n\n首先，我们规范化全导数和伴随方法的推导。目标泛函为 $J(u,p)$，其中状态向量 $u$ 是参数 $p$ 的隐函数，由残差方程 $R(u(p), p) = 0$ 定义。$J$ 关于 $p$ 的全导数由链式法则给出：\n$$\n\\frac{dJ}{dp} = \\frac{\\partial J}{\\partial u} \\frac{du}{dp} + \\frac{\\partial J}{\\partial p}\n$$\n此表达式需要状态向量的敏感性 $\\frac{du}{dp}$。为了求得此项，我们对状态方程 $R(u(p), p) = 0$ 关于 $p$ 求导：\n$$\n\\frac{dR}{dp} = \\frac{\\partial R}{\\partial u} \\frac{du}{dp} + \\frac{\\partial R}{\\partial p} = 0\n$$\n假设残差关于状态的雅可比矩阵 $\\frac{\\partial R}{\\partial u}$ 是可逆的，我们可以解出状态敏感性：\n$$\n\\frac{du}{dp} = - \\left(\\frac{\\partial R}{\\partial u}\\right)^{-1} \\frac{\\partial R}{\\partial p}\n$$\n将此结果代入 $\\frac{dJ}{dp}$ 的表达式，得到直接敏感性公式：\n$$\n\\frac{dJ}{dp} = -\\frac{\\partial J}{\\partial u} \\left(\\frac{\\partial R}{\\partial u}\\right)^{-1} \\frac{\\partial R}{\\partial p} + \\frac{\\partial J}{\\partial p}\n$$\n如果参数众多，这种方法的计算成本会很高，因为它需要为每个参数的敏感性求解一个线性系统。\n\n伴随方法提供了一种更高效的替代方案。我们通过一组拉格朗日乘子 $\\lambda \\in \\mathbb{R}^N$（也称为伴随变量），将约束 $R=0$ 增广到目标 $J$ 中，从而引入一个拉格朗日泛函 $\\mathcal{L}$：\n$$\n\\mathcal{L}(u, p, \\lambda) = J(u, p) - \\lambda^\\top R(u, p)\n$$\n由于 $R(u(p), p) = 0$，对于任意选择的 $\\lambda$，我们都有 $J(u(p), p) = \\mathcal{L}(u(p), p, \\lambda(p))$。因此全导数为 $\\frac{dJ}{dp} = \\frac{d\\mathcal{L}}{dp}$。对 $\\mathcal{L}$ 应用链式法则：\n$$\n\\frac{d\\mathcal{L}}{dp} = \\frac{\\partial \\mathcal{L}}{\\partial u} \\frac{du}{dp} + \\frac{\\partial \\mathcal{L}}{\\partial p} + \\frac{\\partial \\mathcal{L}}{\\partial \\lambda}^\\top \\frac{d\\lambda}{dp}\n$$\n根据状态方程的定义，$\\frac{\\partial \\mathcal{L}}{\\partial \\lambda} = -R(u,p)$ 项为零。伴随方法的关键思想是，通过选择合适的 $\\lambda$ 来消除包含高计算成本的状态敏感性 $\\frac{du}{dp}$ 的项。我们通过将其系数设为零来实现这一点：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial u} = \\frac{\\partial J}{\\partial u} - \\lambda^\\top \\frac{\\partial R}{\\partial u} = 0\n$$\n整理后得到伴随方程：\n$$\n\\left(\\frac{\\partial R}{\\partial u}\\right)^\\top \\lambda = \\left(\\frac{\\partial J}{\\partial u}\\right)^\\top\n$$\n通过求解这个单一的线性系统得到 $\\lambda$，我们就可以计算全导数，而无需构造 $\\frac{du}{dp}$。在选择了这样的 $\\lambda$ 后，导数简化为：\n$$\n\\frac{dJ}{dp} = \\frac{\\partial \\mathcal{L}}{\\partial p} = \\frac{\\partial J}{\\partial p} - \\lambda^\\top \\frac{\\partial R}{\\partial p}\n$$\n一旦状态 $u$ 和伴随变量 $\\lambda$ 已知，这个表达式的计算成本就很低。\n\n现在，我们将此框架应用于具体问题。已知条件如下：\n-   状态方程残差：$R(u,p) = A(p) u - b = (I + p L) u - b = 0$。\n-   目标泛函：$J(u,p) = \\frac{1}{2} u^\\top W u + \\gamma p^2$。\n\n我们计算所需的偏导数：\n-   $\\frac{\\partial J}{\\partial u} = u^\\top W$（作为行向量），或 $\\left(\\frac{\\partial J}{\\partial u}\\right)^\\top = W u$（作为列向量）。\n-   $\\frac{\\partial J}{\\partial p} = 2 \\gamma p$。\n-   $\\frac{\\partial R}{\\partial u} = A(p) = I + p L$。\n-   $\\frac{\\partial R}{\\partial p} = L u$。\n\n伴随梯度 $g_{\\mathrm{adj}}(p) = \\frac{dJ}{dp}$ 的计算方案如下：\n1.  求解状态方程以获得 $u$：$(I + p L) u = b$。\n2.  求解伴随方程以获得 $\\lambda$：$(I + p L)^\\top \\lambda = W u$。由于矩阵 $I$ 和 $L$ 是对称的，所以 $(I + p L)^\\top = I + p L$。因此，我们求解 $(I + p L) \\lambda = W u$。\n3.  计算梯度：$g_{\\mathrm{adj}}(p) = 2 \\gamma p - \\lambda^\\top (L u)$。\n\n接下来，我们描述复步法。该方法为导数提供了一个高精度的数值近似，可作为一种验证工具。它源于一个全纯函数 $f(z)$ 在实点 $x$ 附近，沿纯虚数步长 $ih$ 的泰勒级数展开：\n$$\nf(x+ih) = f(x) + f'(x)(ih) + \\frac{f''(x)}{2!}(ih)^2 + \\frac{f'''(x)}{3!}(ih)^3 + \\mathcal{O}(h^4)\n$$\n$$\nf(x+ih) = f(x) + ih f'(x) - \\frac{h^2}{2} f''(x) - i\\frac{h^3}{6} f'''(x) + \\mathcal{O}(h^4)\n$$\n取等式两边的虚部，我们得到：\n$$\n\\operatorname{Im}[f(x+ih)] = h f'(x) - \\frac{h^3}{6} f'''(x) + \\mathcal{O}(h^5)\n$$\n两边同除以 $h$ 得到导数的近似值：\n$$\n\\frac{\\operatorname{Im}[f(x+ih)]}{h} = f'(x) - \\frac{h^2}{6} f'''(x) + \\mathcal{O}(h^4)\n$$\n因此，$\\frac{\\operatorname{Im}[f(x+ih)]}{h} = f'(x) + \\mathcal{O}(h^2)$。近似误差是关于 $h$ 的二阶误差。\n\n复步法避免了有限差分法中固有的相消误差。前向差分公式 $\\frac{f(x+h) - f(x)}{h}$ 在 $h$ 很小时，涉及两个几乎相等的数 $f(x+h)$ 和 $f(x)$ 的相减。这会导致相对精度的损失。而复步法公式计算 $\\operatorname{Im}[f(x+ih)]$，对于小的 $h$ 该值与 $h$ 成正比。项 $f(x)$ 是纯实数，不干扰虚部。因此，不存在大的、几乎相等的量相减的情况，并且 $h$ 可以选择得非常小（例如，$h = 10^{-30}$），使得截断误差 $\\mathcal{O}(h^2)$ 可以忽略不计。其精度仅受限于机器精度。\n\n复步梯度 $g_{\\mathrm{cs}}(p)$ 的计算方案如下：\n1.  定义一个复数参数 $\\tilde{p} = p + ih$，其中 $h > 0$ 是一个很小的实数。\n2.  构建复数状态矩阵 $A(\\tilde{p}) = I + \\tilde{p} L$。\n3.  求解复线性系统以获得复状态向量 $\\tilde{u}$：$A(\\tilde{p}) \\tilde{u} = b$。向量 $b$ 保持为实数。\n4.  使用复数算术评估目标泛函，确保不使用共轭运算：$\\tilde{J} = J(\\tilde{u}, \\tilde{p}) = \\frac{1}{2} \\tilde{u}^\\top W \\tilde{u} + \\gamma \\tilde{p}^2$。\n5.  计算梯度近似值：$g_{\\mathrm{cs}}(p) = \\frac{\\operatorname{Im}[\\tilde{J}]}{h}$。\n\n最后的任务是针对给定的参数（$N=50$，$\\gamma=0.7$ 等）实现这两种方案，并为指定的 $p$ 值测试套件计算绝对误差 $|g_{\\mathrm{adj}}(p) - g_{\\mathrm{cs}}(p)|$。预计该误差将接近机器精度，从而证实伴随法推导和实现的正确性。",
            "answer": "[1.110223124625157e-16,0.000000000000000e+00,4.440892098500626e-16,4.440892098500626e-16,0.000000000000000e+00]"
        },
        {
            "introduction": "对于具有成百上千个设计参数的实际问题，逐一验证梯度的每个分量是不可行的。本练习探讨了一种可扩展且在统计上稳健的解决方案：随机方向导数 (RDD) 测试。你将学习如何正确地设计这一验证流程，从采样随机方向到选择合适的误差度量和接受标准，从而确保你所计算的高维伴随梯度是准确可靠的。",
            "id": "3942407",
            "problem": "考虑航空航天计算流体力学 (CFD) 中的一个稳态可压缩流模拟，该模拟由离散残差方程 $R(U,p) = 0$ 建模，其中 $U \\in \\mathbb{R}^{m}$ 为状态向量，$p \\in \\mathbb{R}^{n}$ 为一组设计或运行参数。设目标为一个标量泛函 $J(U,p)$，例如阻力、升力或流场变量的加权积分。假设对于每个 $p$，都能获得一个满足 $R(U(p),p) = 0$ 的收敛解 $U(p)$，并且隐函数定理所要求的可微性条件在标称参数 $p$ 的一个邻域内成立。\n\n你已经实现了一个伴随求解器，通过与 $R(U,p) = 0$ 相关的离散伴随方程来计算梯度 $g_{\\mathrm{adj}} = \\frac{dJ}{dp} \\in \\mathbb{R}^{n}$，并且你希望使用随机方向导数 (RDD) 测试来验证 $g_{\\mathrm{adj}}$。其思想是，在多个随机方向 $v \\in \\mathbb{R}^{n}$ 上，将伴随方向导数 $v^{T} g_{\\mathrm{adj}}$ 与复合映射 $\\alpha \\mapsto J(U(p+\\alpha v), p+\\alpha v)$ 在 $\\alpha = 0$ 处的真实方向导数的有限差分近似值进行比较。\n\n哪个选项正确地提出了一个科学上合理的 RDD 测试方案和一个可以从第一性原理证明其合理性的接受标准，内容包括如何选择随机方向、如何构造有限差分近似、如何确保状态求解的一致性，以及如何定义一个鲁棒的通过/失败条件？\n\nA. 通过从标准正态分布中采样每个分量并归一化为单位长度，使得 $\\|v_{i}\\|_{2} = 1$，来抽取 $N$ 个独立的随机方向 $v_{i} \\in \\mathbb{R}^{n}$。这会在 $\\mathbb{R}^{n}$ 的单位球面上产生一个均匀分布。对于每个 $i \\in \\{1,\\dots,N\\}$，计算伴随方向导数 $d_{\\mathrm{adj},i} = v_{i}^{T} g_{\\mathrm{adj}}$。然后，选择一个小的步长 $\\varepsilon > 0$，使得截断误差为 $\\mathcal{O}(\\varepsilon^{2})$ 且舍入/求解器噪声可以忽略不计（例如，通过将 $\\varepsilon$ 缩放到 $p$ 的量级和机器精度），构造中心有限差分近似\n$$\nd_{\\mathrm{fd},i} = \\frac{J\\big(U(p+\\varepsilon v_{i}),\\, p+\\varepsilon v_{i}\\big) - J\\big(U(p-\\varepsilon v_{i}),\\, p-\\varepsilon v_{i}\\big)}{2\\,\\varepsilon},\n$$\n确保每个微扰状态 $U(p\\pm \\varepsilon v_{i})$ 都收敛到与 $U(p)$ 相同的残差容差。定义对称相对误差\n$$\n\\delta_{i} = \\frac{\\big|d_{\\mathrm{adj},i} - d_{\\mathrm{fd},i}\\big|}{\\big|d_{\\mathrm{adj},i}\\big| + \\big|d_{\\mathrm{fd},i}\\big|}。\n$$\n如果 $\\max_{1\\le i \\le N} \\delta_{i} \\le \\tau$，则接受伴随梯度，其中 $\\tau$ 是一个选择的容差，其值要大于有限差分截断误差和求解器/舍入误差的综合影响，并且可以选择性地用样本均值或中位数 $\\le \\tau$ 来佐证。\n\nB. 抽取 $N$ 个独立的随机方向 $v_{i}$，其分量从 $[-1,1]$ 均匀采样，且不进行归一化。对于每个 $i$，计算 $d_{\\mathrm{adj},i} = v_{i}^{T} g_{\\mathrm{adj}}$。构造一个前向有限差分\n$$\nd_{\\mathrm{fd},i} = \\frac{J\\big(U(p),\\, p\\big) - J\\big(U(p+\\varepsilon v_{i}),\\, p+\\varepsilon v_{i}\\big)}{\\varepsilon},\n$$\n使用先前已收敛的状态 $U(p)$，并跳过对微扰状态的重新求解以节省成本。如果平均绝对误差 $\\frac{1}{N}\\sum_{i=1}^{N} \\big|d_{\\mathrm{adj},i} - d_{\\mathrm{fd},i}\\big|$ 小于容差 $\\tau$，则接受伴随梯度。\n\nC. 抽取 $N$ 个随机 Rademacher 方向 $v_{i}$，其每个分量 $v_{i,j} \\in \\{-1,+1\\}$，且不进行归一化。对于每个 $i$，计算 $d_{\\mathrm{adj},i} = v_{i}^{T} g_{\\mathrm{adj}}$。通过以下公式近似有限差分方向导数\n$$\nd_{\\mathrm{fd},i} = \\frac{J\\big(U(p+\\varepsilon v_{i}),\\, p+\\varepsilon v_{i}\\big) - J\\big(U(p-\\varepsilon v_{i}),\\, p-\\varepsilon v_{i}\\big)}{2\\,\\varepsilon\\, \\|v_{i}\\|_{2}^{2}},\n$$\n如果集合 $\\{d_{\\mathrm{adj},i}\\}$ 和 $\\{d_{\\mathrm{fd},i}\\}$ 之间的皮尔逊相关系数超过 0.9，则接受。\n\nD. 仅测试轴对齐方向，通过为 $i = 1,\\dots,n$ 设置 $v_{i} = e_{i}$，即 $\\mathbb{R}^{n}$ 中的第 $i$ 个坐标向量。对于每个 $i$，计算 $d_{\\mathrm{adj},i} = e_{i}^{T} g_{\\mathrm{adj}}$ 和前向有限差分 $d_{\\mathrm{fd},i} = \\frac{J\\big(U(p+\\varepsilon e_{i}),\\, p+\\varepsilon e_{i}\\big) - J\\big(U(p),\\, p\\big)}{\\varepsilon}$。如果 $\\max_{1\\le i \\le n} \\big|d_{\\mathrm{adj},i} - d_{\\mathrm{fd},i}\\big| \\le \\tau$，则接受；随机化是不必要的，因为坐标方向就足够了。",
            "solution": "问题陈述是有效的。它涉及计算流体力学 (CFD) 中离散伴随梯度的验证，这是在采用大规模模拟和优化的学科中一个标准且关键的程序。这个问题是适定的，其科学基础是数值分析和最优化理论，并使用了清晰、客观的术语。我现在将推导梯度验证的原理并评估每个选项。\n\n### 梯度验证的理论基础\n\n目标是验证计算出的伴随梯度 $g_{\\mathrm{adj}} = \\frac{dJ}{dp}$，其中 $J$ 是参数 $p \\in \\mathbb{R}^{n}$ 和状态 $U \\in \\mathbb{R}^{m}$ 的标量函数，而状态 $U$ 通过状态方程 $R(U(p), p) = 0$ 隐式地依赖于 $p$。全导数 $\\frac{dJ}{dp}$ 提供了复合函数 $\\mathcal{J}(p) = J(U(p), p)$ 对 $p$ 的微扰的线性灵敏度。\n\n验证的核心原理依赖于 $\\mathcal{J}(p)$ 在点 $p$ 沿方向 $v \\in \\mathbb{R}^{n}$ 的泰勒展开。令 $f(\\alpha) = \\mathcal{J}(p + \\alpha v) = J(U(p+\\alpha v), p+\\alpha v)$。$f(\\alpha)$ 在 $\\alpha=0$ 附近的泰勒展开为：\n$$ f(\\alpha) = f(0) + \\alpha f'(0) + \\frac{\\alpha^2}{2}f''(0) + \\mathcal{O}(\\alpha^3) $$\n根据定义，$\\mathcal{J}$ 在 $p$ 点沿方向 $v$ 的方向导数是 $f'(0)$。根据链式法则，这等于：\n$$ f'(0) = \\left. \\frac{d\\mathcal{J}}{d\\alpha} \\right|_{\\alpha=0} = \\left( \\frac{dJ}{dp} \\right)^T v = g^T v $$\n其中 $g = \\frac{dJ}{dp}$ 是我们旨在验证的梯度向量。伴随方法提供了一种计算 $g_{\\mathrm{adj}}$ 的方式，它应等于真实梯度 $g$。因此，对于任何方向 $v$，我们必须有等式 $g_{\\mathrm{adj}}^T v = f'(0)$。\n\n诸如随机方向导数 (RDD) 测试之类的验证测试，会将解析计算出的方向导数 $d_{\\mathrm{adj}} = g_{\\mathrm{adj}}^T v$ 与通过有限差分获得的 $f'(0)$ 的数值近似值进行比较。\n\n一种高质量的有限差分近似是二阶精度的中心差分：\n$$ f'(0) \\approx \\frac{f(\\varepsilon) - f(-\\varepsilon)}{2\\varepsilon} = \\frac{J(U(p+\\varepsilon v), p+\\varepsilon v) - J(U(p-\\varepsilon v), p-\\varepsilon v)}{2\\varepsilon} $$\n这种近似的截断误差为 $\\mathcal{O}(\\varepsilon^2)$。为了计算它，必须首先求解微扰参数下的状态方程，即找到满足 $R(U, p+\\varepsilon v)=0$ 的 $U(p+\\varepsilon v)$ 和满足 $R(U, p-\\varepsilon v)=0$ 的 $U(p-\\varepsilon v)$。这些求解过程的收敛容差必须与用于基线状态 $U(p)$ 的容差保持一致，以避免在比较中引入显著的“求解器噪声”。\n\n一个鲁棒的 RDD 测试应包含：\n1.  一种采样方向 $v$ 的方法，该方法能对梯度向量进行全面测试。随机方向优于轴对齐方向，因为它们可以揭示轴对齐测试可能遗漏的非对角线灵敏度中的错误。\n2.  一种高精度的有限差分格式，如中心差分。\n3.  通过重新求解控制方程来正确计算微扰状态。\n4.  一种鲁棒的、尺度不变且表现良好的误差度量，以防止假阳性或假阴性。\n5.  一种严格的统计接受标准。\n\n基于这些原则，我现在将评估每个选项。\n\n### 选项分析\n\n**选项 A**\n\n此选项提出了以下程序：\n1.  **方向：** 通过从标准正态分布中采样并归一化为单位长度 $\\|v_i\\|_2 = 1$，来抽取 $N$ 个随机方向 $v_i$。这是一种标准且合理的方法，用于生成在 $\\mathbb{R}^n$ 单位球面上均匀分布的方向，确保了测试的无偏性和彻底性。\n2.  **有限差分：** 使用中心差分公式 $d_{\\mathrm{fd},i} = \\frac{J(U(p+\\varepsilon v_{i}), p+\\varepsilon v_{i}) - J(U(p-\\varepsilon v_{i}), p-\\varepsilon v_{i})}{2\\varepsilon}$。这是首选的二阶精度方法，对于给定的步长 $\\varepsilon$，它可以最小化截断误差。\n3.  **状态求解：** 明确要求每个微扰状态 $U(p\\pm \\varepsilon v_{i})$ 都收敛到与 $U(p)$ 相同的残差容差。这是为了获得精确有限差分近似而正确指出的一个关键要求。\n4.  **误差度量：** 采用对称相对误差 $\\delta_{i} = \\frac{|d_{\\mathrm{adj},i} - d_{\\mathrm{fd},i}|}{|d_{\\mathrm{adj},i}| + |d_{\\mathrm{fd},i}|}$。该度量是鲁棒的；它避免了除以零，具有尺度不变性，值域有界于 $[0, 1]$，并且对称地处理 $d_{\\mathrm{adj},i}$ 和 $d_{\\mathrm{fd},i}$。\n5.  **接受标准：** 如果所有样本中的最大误差低于容差 $\\tau$，即 $\\max_{i} \\delta_i \\le \\tau$，则宣布通过。这是一个严格的测试，因为单个大的偏差就会导致失败。用均值或中位数的检查来补充，是获得统计置信度的好做法。\n\n此选项的每个方面都完全符合数值梯度验证的最佳实践。\n\n**结论：** **正确**。\n\n**选项 B**\n\n此选项提出：\n1.  **方向：** 从 $[-1,1]$ 均匀采样分量，不进行归一化。这是一种有效但不太理想的采样方法。$v_i$ 的范数不恒定，意味着微扰的大小随方向而变化。\n2.  **有限差分：** 使用前向差分，$d_{\\mathrm{fd},i} = \\frac{J(U(p), p) - J(U(p+\\varepsilon v_{i}), p+\\varepsilon v_{i})}{\\varepsilon}$。除了一个可能的符号错误（应该是 $J(p+\\dots) - J(p)$），这是一个一阶精度格式 ($\\mathcal{O}(\\varepsilon)$)，使其精度低于中心差分。\n3.  **状态求解：** 声称“跳过对微扰状态的重新求解以节省成本”。这是一个**致命的科学缺陷**。为了评估 $J(U(p+\\varepsilon v_{i}), p+\\varepsilon v_{i})$，*必须* 计算满足 $R(U, p+\\varepsilon v_{i})=0$ 的状态 $U(p+\\varepsilon v_{i})$。跳过这次重新求解意味着计算的值不是真实的微扰泛函值，从而使整个有限差分近似无效。\n4.  **误差度量：** 使用平均绝对误差。这种度量不是尺度不变的，并且可能具有误导性。平均值也可能掩盖个别的大误差。\n\n跳过流场重新求解的提议在根本上是错误的，并且违反了被近似导数的数学定义。\n\n**结论：** **不正确**。\n\n**选项 C**\n\n此选项提出：\n1.  **方向：** 使用 Rademacher 方向，其分量为 $-1$ 或 $+1$。这是一种测试超立方体顶点的特定采样类型。它是一种有效但较专门的采样策略。\n2.  **有限差分：** 给出的公式为 $d_{\\mathrm{fd},i} = \\frac{J(...) - J(...)}{2\\varepsilon \\|v_{i}\\|_{2}^{2}}$。这是**科学上不正确的**。方向导数 $g^T v_i$ 的中心差分近似的分母是 $2\\varepsilon$。包含 $\\|v_{i}\\|_{2}^{2}$ 这一项没有道理，会导致错误的值。对于 Rademacher 方向，$\\|v_i\\|_2^2 = n$，所以这将错误地把结果除以参数数量 $n$。\n3.  **接受标准：** 使用皮尔逊相关系数... 对于梯度验证来说，这是一个**极其不充分的标准**。相关性只衡量线性关系的强度，而非一致性。例如，如果对于所有 $i$ 都有 $d_{\\mathrm{adj},i} = (2 \\cdot d_{\\mathrm{fd},i}) + 5$，相关性将为 1，但梯度将错了一个因子 2 和一个偏移量。梯度检查必须确认 $d_{\\mathrm{adj},i} \\approx d_{\\mathrm{fd},i}$。\n\n有限差分公式和接受标准都存在根本性缺陷。\n\n**结论：** **不正确**。\n\n**选项 D**\n\n此选项提出：\n1.  **方向：** 仅使用轴对齐方向，$v_i = e_i$。这不是一个随机化测试，不满足问题的一个关键要求。虽然沿坐标轴进行测试是一个有用的第一步，但它不如随机测试鲁棒，因为它可能无法检测到交叉灵敏度（即输出如何受多个参数变化的耦合影响）计算中的错误。\n2.  **有限差分：** 使用一阶精度的前向差分格式，其精度低于中心差分。\n3.  **误差度量：** 使用最大绝对误差，$\\max_i |d_{\\mathrm{adj},i} - d_{\\mathrm{fd},i}|$。如前所述，绝对误差度量不是尺度不变的，其鲁棒性低于相对误差度量。例如，梯度中一个量级非常大的分量可能有一个很大的绝对误差，但相对误差却很小，反之亦然。\n\n此选项描述了一种简化的、鲁棒性较差的非随机化检查，其效果劣于选项 A 中的程序。\n\n**结论：** **不正确**。\n\n### 结论\n\n选项 A 描述了一个完整、严谨且科学合理的随机方向导数测试程序。它正确地指定了无偏的方向采样策略、高阶有限差分格式、重新求解状态方程的关键需求、鲁棒的误差度量以及严格的接受标准。其他选项则包含根本性的科学错误，或提出的方法在鲁棒性和准确性上明显较差。",
            "answer": "$$\\boxed{A}$$"
        }
    ]
}