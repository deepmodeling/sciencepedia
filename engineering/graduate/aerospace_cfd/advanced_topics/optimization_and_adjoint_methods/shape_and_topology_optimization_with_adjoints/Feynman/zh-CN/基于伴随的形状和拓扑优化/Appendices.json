{
    "hands_on_practices": [
        {
            "introduction": "伴随方法的核心在于其高效计算复杂系统目标函数相对于大量设计变量的梯度的能力。本练习将引导您完成离散伴随方程的推导，这是“先离散后微分”方法的基石。通过从拉格朗日量的定义出发，您将亲手揭示伴随变量如何巧妙地消除了对状态变量敏感度的直接依赖，从而为大规模优化问题奠定理论基础 。",
            "id": "3993444",
            "problem": "对围绕翼型的粘性可压缩流进行的稳态计算流体动力学(CFD)模拟被离散化，以产生一个在每个控制体上强制执行质量、动量和能量守恒的代数方程组。令 $U \\in \\mathbb{R}^{n}$ 表示离散流动未知量（包括任何湍流模型变量）的向量，令 $\\alpha \\in \\mathbb{R}^{p}$ 表示一组设计参数，这些参数通过例如 Brinkman 惩罚格式中的孔隙度分布来控制翼型形状或拓扑场。离散残差为 $R(U,\\alpha) \\in \\mathbb{R}^{n}$，稳态CFD解满足 $R(U,\\alpha)=0$。气动目标是一个可微泛函 $J(U,\\alpha) \\in \\mathbb{R}$（例如，由表面应力计算出的阻力泛函或体积功率耗散）。\n\n假设 $R$ 和 $J$ 关于其参数是二阶连续可微的，并且雅可比矩阵 $R_{U} := \\partial R/\\partial U \\in \\mathbb{R}^{n \\times n}$ 在解处是非奇异的，因此 $U(\\alpha)$ 局部上是 $\\alpha$ 的一个可微函数。考虑降阶目标 $\\widehat{J}(\\alpha) := J(U(\\alpha),\\alpha)$。\n\n任务：\n1) 从链式法则和约束 $R(U(\\alpha),\\alpha)=0$ 出发，推导全导数 $dJ/d\\alpha$ 的表达式，用 $J_{U}$、$J_{\\alpha}$、$R_{U}$、$R_{\\alpha}$ 和 $dU/d\\alpha$ 表示。\n2) 引入一个拉格朗日乘子（伴随）向量 $\\lambda \\in \\mathbb{R}^{n}$，并构造一个拉格朗日量 $\\mathcal{L}(U,\\alpha,\\lambda)$ 来强制执行残差约束。通过对 $\\mathcal{L}$ 关于 $U$ 施加平稳性条件，推导出 $\\lambda$ 必须满足的线性系统。不要假设 $R_{U}$ 具有任何对称性。\n3) 使用第2部分的结果，从全导数中消去 $dU/d\\alpha$，并将降阶梯度 $dJ/d\\alpha$ 仅用偏导数和伴随向量表示。\n4) 最后，消去伴随向量，以获得一个仅取决于 $J_{U}$、$J_{\\alpha}$、$R_{U}$ 和 $R_{\\alpha}$ 的单一显式降阶梯度表达式，其中不出现 $U(\\alpha)$、$dU/d\\alpha$ 或 $\\lambda$。\n\n将您的最终答案以第4部分要求的显式符号表达式的形式提供。无需进行数值计算。您的最终答案必须是单一的闭式解析表达式，且不包含单位。",
            "solution": "该问题被验证为具有科学依据、适定且客观。它代表了在连续优化背景下，用于灵敏度分析的伴随方法的标准推导，这是现代计算工程的基石。\n\n解答是通过遵循四个指定的任务推导出来的。给定状态方程 $R(U,\\alpha)=0$，其中 $U \\in \\mathbb{R}^{n}$ 是状态向量，$\\alpha \\in \\mathbb{R}^{p}$ 是设计向量。目标函数是 $J(U,\\alpha) \\in \\mathbb{R}$。相应的降阶目标函数是 $\\widehat{J}(\\alpha) = J(U(\\alpha),\\alpha)$。我们采用这样的记法：标量函数关于向量的梯度是一个行向量。例如，$J_{U} = \\frac{\\partial J}{\\partial U} \\in \\mathbb{R}^{1 \\times n}$ 和 $\\frac{dJ}{d\\alpha} \\in \\mathbb{R}^{1 \\times p}$。\n\n**1) 全导数的推导**\n\n降阶目标函数 $\\widehat{J}(\\alpha)$ 关于设计向量 $\\alpha$ 的全导数可以使用多元链式法则求得：\n$$\n\\frac{d\\widehat{J}}{d\\alpha} = \\frac{\\partial J}{\\partial U} \\frac{dU}{d\\alpha} + \\frac{\\partial J}{\\partial \\alpha}\n$$\n使用指定的记法，这可以写成：\n$$\n\\frac{dJ}{d\\alpha} = J_{U} \\frac{dU}{d\\alpha} + J_{\\alpha}\n$$\n这个表达式给出了全导数，但它依赖于灵敏度矩阵 $\\frac{dU}{d\\alpha} \\in \\mathbb{R}^{n \\times p}$，该矩阵量化了状态向量 $U$ 如何随设计参数 $\\alpha$ 变化。直接确定此项的计算成本通常很高。\n\n**2) 拉格朗日量与伴随方程**\n\n为了推导伴随方法，我们引入一个拉格朗日量 $\\mathcal{L}$，将状态方程 $R(U,\\alpha)=0$ 作为目标函数 $J(U,\\alpha)$ 的一个约束。我们引入一个拉格朗日乘子向量 $\\lambda \\in \\mathbb{R}^{n}$，也称为伴随变量。拉格朗日量定义为：\n$$\n\\mathcal{L}(U,\\alpha,\\lambda) = J(U,\\alpha) + \\lambda^T R(U,\\alpha)\n$$\n伴随方法寻求 $\\lambda$ 的一个特定值，以简化梯度计算。我们通过施加拉格朗日量关于状态向量 $U$ 的平稳性条件，即 $\\frac{\\partial \\mathcal{L}}{\\partial U} = 0$，来找到这个值。\n$\\mathcal{L}$ 关于 $U$ 的偏导数为：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial U} = \\frac{\\partial J}{\\partial U} + \\lambda^T \\frac{\\partial R}{\\partial U} = J_{U} + \\lambda^T R_{U}\n$$\n将其设为零可得到条件：\n$$\nJ_{U} + \\lambda^T R_{U} = 0\n$$\n由于这是一个关于未知数 $\\lambda$ 的线性系统，通常将其写成 $Ax=b$ 的形式。重新整理方程得到 $\\lambda^T R_{U} = -J_{U}$。对两边取转置，我们得到 $\\lambda$ 必须满足的线性系统，这被称为离散伴随方程：\n$$\nR_{U}^T \\lambda = -J_{U}^T\n$$\n注意，我们没有假设雅可比矩阵 $R_U$ 的对称性，其转置 $R_U^T$ 自然地出现在伴随方程中。\n\n**3) 消去状态灵敏度项**\n\n我们现在使用伴随方程来重新表述第1部分中的全导数表达式。目标是消去状态灵敏度项 $\\frac{dU}{d\\alpha}$。\n从第2部分的伴随方程，我们有 $J_U$ 的表达式：\n$$\nJ_U = -\\lambda^T R_U\n$$\n将此代入第1部分的全导数表达式中：\n$$\n\\frac{dJ}{d\\alpha} = (-\\lambda^T R_{U}) \\frac{dU}{d\\alpha} + J_{\\alpha} = -\\lambda^T \\left( R_{U} \\frac{dU}{d\\alpha} \\right) + J_{\\alpha}\n$$\n为了继续推导，我们需要括号中项的表达式。这可以通过对状态方程 $R(U(\\alpha), \\alpha) = 0$ 关于 $\\alpha$ 求导得到：\n$$\n\\frac{d R}{d\\alpha} = \\frac{\\partial R}{\\partial U} \\frac{dU}{d\\alpha} + \\frac{\\partial R}{\\partial \\alpha} = R_{U} \\frac{dU}{d\\alpha} + R_{\\alpha} = 0\n$$\n这给了我们所谓的灵敏度方程：$R_{U} \\frac{dU}{d\\alpha} = -R_{\\alpha}$。\n将此代入我们的全导数表达式中：\n$$\n\\frac{dJ}{d\\alpha} = -\\lambda^T (-R_{\\alpha}) + J_{\\alpha}\n$$\n这简化为基于伴随的降阶梯度表达式：\n$$\n\\frac{dJ}{d\\alpha} = J_{\\alpha} + \\lambda^T R_{\\alpha}\n$$\n该表达式提供了目标函数的全导数，而无需计算状态灵敏度矩阵 $\\frac{dU}{d\\alpha}$。相反，人们必须求解单个线性伴随系统以得到 $\\lambda$。\n\n**4) 最终的显式降阶梯度表达式**\n\n最后的任务是获得一个不依赖于 $\\lambda$ 或 $\\frac{dU}{d\\alpha}$ 的单一显式降阶梯度表达式。我们可以通过形式上求解 $\\lambda$ 并将其代回到第3部分的结果中来实现这一点。\n\n从第2部分推导出的伴随方程 $R_{U}^T \\lambda = -J_{U}^T$，我们可以求解 $\\lambda$。由于给定 $R_U$ 是非奇异的，其转置 $R_U^T$ 也是非奇异的。因此，我们可以写出：\n$$\n\\lambda = -(R_{U}^T)^{-1} J_{U}^T\n$$\n现在，我们需要 $\\lambda$ 的转置来代入第3部分的表达式中：\n$$\n\\lambda^T = \\left( -(R_{U}^T)^{-1} J_{U}^T \\right)^T = -(J_U^T)^T ((R_U^T)^{-1})^T\n$$\n使用恒等式 $(A^{-1})^T = (A^T)^{-1}$，我们有 $((R_{U}^T)^{-1})^T = ((R_{U}^T)^T)^{-1} = (R_{U})^{-1}$。同时，$(J_U^T)^T = J_U$。因此，我们得到：\n$$\n\\lambda^T = -J_{U} R_{U}^{-1}\n$$\n最后，将这个 $\\lambda^T$ 的表达式代入第3部分的梯度公式中：\n$$\n\\frac{dJ}{d\\alpha} = J_{\\alpha} + \\lambda^T R_{\\alpha} = J_{\\alpha} + (-J_{U} R_{U}^{-1}) R_{\\alpha}\n$$\n这给出了最终的显式降阶梯度表达式：\n$$\n\\frac{dJ}{d\\alpha} = J_{\\alpha} - J_{U} R_{U}^{-1} R_{\\alpha}\n$$\n此表达式仅取决于目标函数 ($J_U, J_\\alpha$) 和残差 ($R_U, R_\\alpha$) 的偏导数，以及残差雅可比矩阵 $R_U$ 的逆。这是支撑直接法和伴随法灵敏度分析的正式结果，其区别在于运算顺序，这对计算成本具有深远的影响。",
            "answer": "$$\n\\boxed{J_{\\alpha} - J_{U} R_{U}^{-1} R_{\\alpha}}\n$$"
        },
        {
            "introduction": "在推导出伴随方程的理论形式后，确保其在代码中正确实现是至关重要的一步。本练习介绍了一种标准的伴随实现验证技术，即梯度检验。通过将伴随方法预测的目标函数变化与通过有限差分计算的“实测”变化进行比较，您可以系统地验证梯度计算的准确性，这是开发可靠优化工具的必备技能 。",
            "id": "3993440",
            "problem": "考虑一个计算流体力学(CFD)中的稳态气动外形与拓扑设计问题，该问题被离散化后，产生一个有限维状态向量 $u \\in \\mathbb{R}^{m}$ 和一个设计向量 $\\alpha \\in \\mathbb{R}^{n}$。离散控制方程写为残差形式 $R(u,\\alpha)=0$，标量目标函数为 $J(u,\\alpha)$。在当前的设计迭代点，您希望通过执行一项消除了对状态扰动依赖性的残差恒等式检验，来验证一个离散伴随的实现。\n\n仅从离散残差 $R(u,\\alpha)=0$、目标函数 $J(u,\\alpha)$ 和拉格朗日量 $\\mathcal{L}(u,\\alpha,\\lambda) = J(u,\\alpha) + \\lambda^{T} R(u,\\alpha)$ 的定义出发，完成以下任务：\n\n1) 使用一阶变分和强制拉格朗日量相对于 $u$ 驻定性的伴随方程，推导一个由设计扰动 $\\delta \\alpha$ 引起的目标函数一阶变化的表达式，该表达式消除了状态扰动 $\\delta u$。将结果表示为以下形式的内积\n$$\n\\delta J \\;=\\; s^{T}\\,\\delta \\alpha,\n$$\n并用可用的离散导数和乘子来确定 $s$。\n\n2) 将推导出的恒等式应用于当前设计迭代点的以下离散数据。状态的维度为 $m=2$，设计的维度为 $n=3$。给定：\n- 目标函数相对于设计的偏导数，\n$$\nJ_{\\alpha} \\;=\\; \\begin{pmatrix} 0.8 \\\\ -1.2 \\\\ 0.5 \\end{pmatrix}.\n$$\n- 残差相对于设计的混合雅可比矩阵（将 $\\delta \\alpha$ 映射到残差扰动），\n$$\nR_{\\alpha} \\;=\\; \\begin{pmatrix}\n1.0  -2.0  0.0 \\\\\n0.5  1.0  -1.5\n\\end{pmatrix}.\n$$\n- 伴随向量，\n$$\n\\lambda \\;=\\; \\begin{pmatrix} 0.3 \\\\ -0.4 \\end{pmatrix}.\n$$\n\n根据第(1)部分的结果构造 $s$，然后，对于以下每个独立的随机设计扰动 $\\delta \\alpha_{k}$，计算伴随预测的一阶变化 $\\delta J_{\\mathrm{adj},k} = s^{T}\\delta \\alpha_{k}$，并与相应的有限差分测量值 $\\delta J_{\\mathrm{fd},k}$ 进行比较：\n- $k=1$: $\\delta \\alpha_{1} = \\begin{pmatrix} 0.02 \\\\ -0.01 \\\\ 0.03 \\end{pmatrix}$，其中 $\\delta J_{\\mathrm{fd},1} = 0.073000073$。\n- $k=2$: $\\delta \\alpha_{2} = \\begin{pmatrix} -0.03 \\\\ 0.04 \\\\ -0.02 \\end{pmatrix}$，其中 $\\delta J_{\\mathrm{fd},2} = -0.137000137$。\n- $k=3$: $\\delta \\alpha_{3} = \\begin{pmatrix} 0.05 \\\\ 0.01 \\\\ -0.04 \\end{pmatrix}$，其中 $\\delta J_{\\mathrm{fd},3} = -0.020999979$。\n\n将每种情况下的相对失配定义为\n$$\ne_{k} \\;=\\; \\frac{\\left|\\delta J_{\\mathrm{fd},k} - \\delta J_{\\mathrm{adj},k}\\right|}{\\left|\\delta J_{\\mathrm{adj},k}\\right|}.\n$$\n\n计算最大相对失配\n$$\nE_{\\max} \\;=\\; \\max\\{e_{1},\\,e_{2},\\,e_{3}\\},\n$$\n并确定它是否低于验证容差 $\\varepsilon_{\\mathrm{tol}} = 2.0 \\times 10^{-6}$。\n\n仅报告 $E_{\\max}$ 的值作为最终答案。将此最大相对失配表示为一个无量纲十进制数，并将答案四舍五入到三位有效数字。",
            "solution": "该问题被验证为科学上合理、良定、客观和完整。它提出了在计算优化背景下离散伴随实现的一个标准验证流程。我将继续进行解答，解答包括两部分：理论推导和数值应用。\n\n第1部分：基于伴随的灵敏度推导\n\n给定离散控制方程 $R(u, \\alpha) = 0$ 和标量目标函数 $J(u, \\alpha)$，其中 $u \\in \\mathbb{R}^{m}$ 是状态向量，$\\alpha \\in \\mathbb{R}^{n}$ 是设计向量。状态 $u$ 是设计变化的隐函数，即 $u = u(\\alpha)$。\n\n由于设计扰动 $\\delta \\alpha$ 引起的目标函数 $J$ 的一阶变分由全导数给出：\n$$\n\\delta J = \\left(\\frac{\\partial J}{\\partial u}\\right)^T \\delta u + \\left(\\frac{\\partial J}{\\partial \\alpha}\\right)^T \\delta \\alpha\n$$\n这个表达式依赖于我们希望消除的状态扰动 $\\delta u$。$\\delta u$ 和 $\\delta \\alpha$ 之间的关系可以通过对控制方程 $R(u, \\alpha) = 0$ 进行一阶变分得到：\n$$\n\\delta R = \\frac{\\partial R}{\\partial u} \\delta u + \\frac{\\partial R}{\\partial \\alpha} \\delta \\alpha = 0\n$$\n其中 $\\frac{\\partial R}{\\partial u}$ 是 $m \\times m$ 的状态雅可比矩阵，而 $\\frac{\\partial R}{\\partial \\alpha}$ 是 $m \\times n$ 的设计雅可比矩阵。\n\n问题引入了拉格朗日量 $\\mathcal{L}(u, \\alpha, \\lambda) = J(u, \\alpha) + \\lambda^T R(u, \\alpha)$，其中 $\\lambda \\in \\mathbb{R}^{m}$ 是伴随变量（或拉格朗日乘子）向量。伴随方程由 $\\mathcal{L}$ 相对于状态 $u$ 的驻定性定义：\n$$\n\\left(\\frac{\\partial \\mathcal{L}}{\\partial u}\\right)^T = \\frac{\\partial J}{\\partial u} + \\left(\\frac{\\partial R}{\\partial u}\\right)^T \\lambda = 0\n$$\n注意，我们使用列向量约定来表示梯度，因此 $\\frac{\\partial J}{\\partial u}$ 是一个 $m \\times 1$ 的列向量，$\\frac{\\partial R}{\\partial u}$ 是一个 $m \\times m$ 的矩阵。这个伴随方程允许我们用伴随向量来表示 $J$ 相对于 $u$ 的灵敏度：\n$$\n\\left(\\frac{\\partial J}{\\partial u}\\right)^T = -\\lambda^T \\frac{\\partial R}{\\partial u}\n$$\n我们将此代入 $\\delta J$ 的表达式中：\n$$\n\\delta J = \\left(-\\lambda^T \\frac{\\partial R}{\\partial u}\\right) \\delta u + \\left(\\frac{\\partial J}{\\partial \\alpha}\\right)^T \\delta \\alpha = -\\lambda^T \\left(\\frac{\\partial R}{\\partial u} \\delta u\\right) + \\left(\\frac{\\partial J}{\\partial \\alpha}\\right)^T \\delta \\alpha\n$$\n从残差的变分中，我们得到关系式 $\\frac{\\partial R}{\\partial u} \\delta u = - \\frac{\\partial R}{\\partial \\alpha} \\delta \\alpha$。将此代入 $\\delta J$ 的方程中，可以消除项 $\\frac{\\partial R}{\\partial u} \\delta u$：\n$$\n\\delta J = -\\lambda^T \\left(- \\frac{\\partial R}{\\partial \\alpha} \\delta \\alpha\\right) + \\left(\\frac{\\partial J}{\\partial \\alpha}\\right)^T \\delta \\alpha\n$$\n$$\n\\delta J = \\lambda^T \\frac{\\partial R}{\\partial \\alpha} \\delta \\alpha + \\left(\\frac{\\partial J}{\\partial \\alpha}\\right)^T \\delta \\alpha\n$$\n将设计扰动 $\\delta \\alpha$ 因子提出：\n$$\n\\delta J = \\left( \\left(\\frac{\\partial J}{\\partial \\alpha}\\right)^T + \\lambda^T \\frac{\\partial R}{\\partial \\alpha} \\right) \\delta \\alpha\n$$\n这就是 $\\delta J = s^T \\delta \\alpha$ 的形式，其中 $s$ 是所需的灵敏度列向量。通过识别各项，我们找到行向量 $s^T$：\n$$\ns^T = \\left(\\frac{\\partial J}{\\partial \\alpha}\\right)^T + \\lambda^T \\frac{\\partial R}{\\partial \\alpha}\n$$\n对这个表达式取转置，得到列向量 $s$：\n$$\ns = \\left(s^T\\right)^T = \\left(\\left(\\frac{\\partial J}{\\partial \\alpha}\\right)^T\\right)^T + \\left(\\lambda^T \\frac{\\partial R}{\\partial \\alpha}\\right)^T = \\frac{\\partial J}{\\partial \\alpha} + \\left(\\frac{\\partial R}{\\partial \\alpha}\\right)^T \\lambda\n$$\n使用问题陈述中的符号，其中 $J_\\alpha$ 是列向量 $\\frac{\\partial J}{\\partial \\alpha}$，$R_\\alpha$ 是矩阵 $\\frac{\\partial R}{\\partial \\alpha}$，则灵敏度向量为：\n$$\ns = J_\\alpha + R_\\alpha^T \\lambda\n$$\n该表达式给出了目标函数的一阶变化，而无需计算状态扰动 $\\delta u$。\n\n第2部分：数值计算与验证\n\n我们将推导出的恒等式应用于提供的离散数据。维度为 $m=2$ 和 $n=3$。\n给定的数据是：\n- 目标函数相对于设计的偏导数：$J_{\\alpha} = \\begin{pmatrix} 0.8 \\\\ -1.2 \\\\ 0.5 \\end{pmatrix}$\n- 残差相对于设计的混合雅可比矩阵：$R_{\\alpha} = \\begin{pmatrix} 1.0  -2.0  0.0 \\\\ 0.5  1.0  -1.5 \\end{pmatrix}$\n- 伴随向量：$\\lambda = \\begin{pmatrix} 0.3 \\\\ -0.4 \\end{pmatrix}$\n\n首先，我们计算灵敏度向量 $s$。这需要 $R_\\alpha$ 的转置：\n$$\nR_{\\alpha}^T = \\begin{pmatrix} 1.0  0.5 \\\\ -2.0  1.0 \\\\ 0.0  -1.5 \\end{pmatrix}\n$$\n接下来，我们计算乘积 $R_\\alpha^T \\lambda$：\n$$\nR_\\alpha^T \\lambda = \\begin{pmatrix} 1.0  0.5 \\\\ -2.0  1.0 \\\\ 0.0  -1.5 \\end{pmatrix} \\begin{pmatrix} 0.3 \\\\ -0.4 \\end{pmatrix} = \\begin{pmatrix} (1.0)(0.3) + (0.5)(-0.4) \\\\ (-2.0)(0.3) + (1.0)(-0.4) \\\\ (0.0)(0.3) + (-1.5)(-0.4) \\end{pmatrix} = \\begin{pmatrix} 0.3 - 0.2 \\\\ -0.6 - 0.4 \\\\ 0.0 + 0.6 \\end{pmatrix} = \\begin{pmatrix} 0.1 \\\\ -1.0 \\\\ 0.6 \\end{pmatrix}\n$$\n现在，我们计算 $s$：\n$$\ns = J_\\alpha + R_\\alpha^T \\lambda = \\begin{pmatrix} 0.8 \\\\ -1.2 \\\\ 0.5 \\end{pmatrix} + \\begin{pmatrix} 0.1 \\\\ -1.0 \\\\ 0.6 \\end{pmatrix} = \\begin{pmatrix} 0.9 \\\\ -2.2 \\\\ 1.1 \\end{pmatrix}\n$$\n灵敏度行向量为 $s^T = \\begin{pmatrix} 0.9  -2.2  1.1 \\end{pmatrix}$。\n\n我们现在为三种情况中的每一种计算伴随预测的变化 $\\delta J_{\\mathrm{adj},k} = s^T \\delta \\alpha_k$ 和相应的相对失配 $e_k$。\n\n情况 $k=1$：\n$\\delta \\alpha_1 = \\begin{pmatrix} 0.02 \\\\ -0.01 \\\\ 0.03 \\end{pmatrix}$。\n$\\delta J_{\\mathrm{adj},1} = (0.9)(0.02) + (-2.2)(-0.01) + (1.1)(0.03) = 0.018 + 0.022 + 0.033 = 0.073$。\n给定 $\\delta J_{\\mathrm{fd},1} = 0.073000073$。\n相对失配为：\n$$\ne_1 = \\frac{|\\delta J_{\\mathrm{fd},1} - \\delta J_{\\mathrm{adj},1}|}{|\\delta J_{\\mathrm{adj},1}|} = \\frac{|0.073000073 - 0.073|}{|0.073|} = \\frac{0.000000073}{0.073} = 1.0 \\times 10^{-6}\n$$\n\n情况 $k=2$：\n$\\delta \\alpha_2 = \\begin{pmatrix} -0.03 \\\\ 0.04 \\\\ -0.02 \\end{pmatrix}$。\n$\\delta J_{\\mathrm{adj},2} = (0.9)(-0.03) + (-2.2)(0.04) + (1.1)(-0.02) = -0.027 - 0.088 - 0.022 = -0.137$。\n给定 $\\delta J_{\\mathrm{fd},2} = -0.137000137$。\n相对失配为：\n$$\ne_2 = \\frac{|\\delta J_{\\mathrm{fd},2} - \\delta J_{\\mathrm{adj},2}|}{|\\delta J_{\\mathrm{adj},2}|} = \\frac{|-0.137000137 - (-0.137)|}{|-0.137|} = \\frac{|-0.000000137|}{0.137} = 1.0 \\times 10^{-6}\n$$\n\n情况 $k=3$：\n$\\delta \\alpha_3 = \\begin{pmatrix} 0.05 \\\\ 0.01 \\\\ -0.04 \\end{pmatrix}$。\n$\\delta J_{\\mathrm{adj},3} = (0.9)(0.05) + (-2.2)(0.01) + (1.1)(-0.04) = 0.045 - 0.022 - 0.044 = -0.021$。\n给定 $\\delta J_{\\mathrm{fd},3} = -0.020999979$。\n相对失配为：\n$$\ne_3 = \\frac{|\\delta J_{\\mathrm{fd},3} - \\delta J_{\\mathrm{adj},3}|}{|\\delta J_{\\mathrm{adj},3}|} = \\frac{|-0.020999979 - (-0.021)|}{|-0.021|} = \\frac{|0.000000021|}{0.021} = 1.0 \\times 10^{-6}\n$$\n\n最后，我们求最大相对失配 $E_{\\max}$：\n$$\nE_{\\max} = \\max\\{e_1, e_2, e_3\\} = \\max\\{1.0 \\times 10^{-6}, 1.0 \\times 10^{-6}, 1.0 \\times 10^{-6}\\} = 1.0 \\times 10^{-6}\n$$\n验证容差为 $\\varepsilon_{\\mathrm{tol}} = 2.0 \\times 10^{-6}$。由于 $E_{\\max}  \\varepsilon_{\\mathrm{tol}}$，伴随实现通过了此验证测试。问题要求将 $E_{\\max}$ 的值四舍五入到三位有效数字。\n$$\nE_{\\max} = 1.00 \\times 10^{-6}\n$$",
            "answer": "$$\n\\boxed{1.00 \\times 10^{-6}}\n$$"
        },
        {
            "introduction": "伴随方法主要有两种实现途径：“先离散后微分”（离散伴随）和“先微分后离散”（连续伴随）。本练习通过一个经典的NACA翼型气动优化问题，对这两种方法进行了直接比较。通过计算并对比两种方法所得的梯度，并观察随着离散化精度提高，离散伴随解如何收敛于连续伴随解，您将深刻理解这两种方法的内在联系、差异以及伴随一致性的重要概念 。",
            "id": "3993452",
            "problem": "你必须在一个薄翼假设下，使用连续和离散伴随公式，对一个 National Advisory Committee for Aeronautics (NACA) 四位数翼型的升力系数相对于弯度幅值设计变量的梯度进行数值比较实现。控制流体模型是二维、定常、不可压缩、无粘的势流，并假设攻角很小。薄翼模型在后缘强制施加 Kutta 条件，并沿弦向角变量将边界条件展开为余弦级数。最终程序必须计算连续伴随梯度和离散伴随梯度之间的相对误差，并针对一组测试用例，以单行格式报告这些误差。\n\n基本原理如下：\n- 稳定的二维、不可压缩、无粘势流服从速度势的拉普拉斯方程，这意味着除了在翼型表面由涡片代表环量的位置外，流动是无旋的。Kutta–Joukowski 定理指出，单位翼展的升力取决于环量：$L' = \\rho U_{\\infty} \\Gamma$。在薄翼理论中，无量纲升力系数为 $C_L = 2 \\pi \\left( A_0 \\right)$，其中 $A_0$ 是弯度线边界条件的余弦级数表示中的常数项。\n- 薄翼边界条件在翼型弯度线上表示，使用角变量 $\\theta \\in (0, \\pi)$ 通过 $x = \\frac{1 - \\cos \\theta}{2}$ 映射到弦向位置 $x$。该边界条件写作 $f(\\theta) = \\alpha - \\frac{dz_c}{dx}\\left(x(\\theta)\\right)$，其中 $\\alpha$ 是以弧度为单位的攻角，$\\frac{dz_c}{dx}$ 是弯度线对 $x$ 的导数。函数 $f(\\theta)$ 展开为余弦级数：\n$$\nf(\\theta) = A_0 + \\sum_{n=1}^{\\infty} A_n \\cos(n \\theta).\n$$\n根据余弦级数的正交性，常数项系数为\n$$\nA_0 = \\frac{1}{\\pi} \\int_{0}^{\\pi} f(\\theta)\\, d\\theta,\n$$\n由此得到标准的薄翼升力系数 $C_L = 2 \\pi A_0$。\n\nNACA 四位数翼型的弯度线 $z_c(x)$ 由参数 $m$（最大弯度，为弦长的分数）和 $p$（最大弯度的位置，为弦长的分数）定义。厚度参数不出现在薄翼无粘升力计算中，因此在此忽略。弯度线及其斜率的分段定义如下：\n- 对于 $0 \\le x \\le p$：\n$$\nz_c(x) = \\frac{m}{p^2} (2 p x - x^2), \\quad \\frac{dz_c}{dx}(x) = \\frac{2 m}{p^2} (p - x).\n$$\n- 对于 $p \\le x \\le 1$：\n$$\nz_c(x) = \\frac{m}{(1 - p)^2} \\left( (1 - 2p) + 2 p x - x^2 \\right), \\quad \\frac{dz_c}{dx}(x) = \\frac{2 m}{(1 - p)^2} (p - x).\n$$\n\n将 $C_L$ 相对于弯度幅值 $m$ 的连续伴随梯度定义为通过对 $A_0$ 的积分表达式求导得到的连续形状导数：\n$$\n\\frac{d C_L}{d m} = 2 \\pi \\frac{d A_0}{d m} = 2 \\pi \\frac{1}{\\pi} \\int_{0}^{\\pi} \\left( - \\frac{\\partial}{\\partial m} \\frac{dz_c}{dx}(x(\\theta)) \\right) d\\theta = - 2 \\int_{0}^{\\pi} \\frac{\\partial}{\\partial m} \\frac{dz_c}{dx}(x(\\theta)) \\, d\\theta.\n$$\n使用 $x(\\theta) = \\frac{1 - \\cos \\theta}{2}$ 和 $\\theta_p = \\arccos(1 - 2 p)$，导数 $\\frac{\\partial}{\\partial m}\\frac{dz_c}{dx}$ 是分段常数乘以 $(p - x)$：\n- 对于 $0 \\le \\theta \\le \\theta_p$（即 $x \\le p$）：\n$$\n\\frac{\\partial}{\\partial m} \\frac{dz_c}{dx} = \\frac{2}{p^2} (p - x(\\theta)).\n$$\n- 对于 $\\theta_p \\le \\theta \\le \\pi$（即 $x \\ge p$）：\n$$\n\\frac{\\partial}{\\partial m} \\frac{dz_c}{dx} = \\frac{2}{(1 - p)^2} (p - x(\\theta)).\n$$\n由于 $p - x(\\theta) = p - \\frac{1}{2} + \\frac{1}{2} \\cos \\theta = \\frac{2p - 1}{2} + \\frac{1}{2} \\cos \\theta$，连续梯度计算为\n$$\n\\frac{d C_L}{d m} = - 2 \\left[ \\frac{2}{p^2} \\left( \\frac{2p - 1}{2} \\theta_p + \\frac{1}{2} \\sin \\theta_p \\right) + \\frac{2}{(1 - p)^2} \\left( \\frac{2p - 1}{2} (\\pi - \\theta_p) - \\frac{1}{2} \\sin \\theta_p \\right) \\right].\n$$\n\n对于离散伴随梯度，我们在 $N+1$ 个点 $\\theta_i = \\frac{i \\pi}{N+1}$（其中 $i = 1, 2, \\dots, N+1$）上配置边界条件。我们将余弦级数截断为 $N$ 个模态并包括常数项，从而得到一个关于系数向量 $\\mathbf{a} = [A_0, A_1, \\dots, A_N]^T$ 的方阵线性系统：\n$$\n\\mathbf{M} \\mathbf{a} = \\mathbf{r}, \\quad \\text{其中} \\quad M_{i,0} = 1, \\quad M_{i,n} = \\cos(n \\theta_i) \\; \\text{for} \\; n = 1, \\dots, N, \\quad r_i = \\alpha - \\frac{dz_c}{dx}(x(\\theta_i)).\n$$\n目标函数为 $f(\\mathbf{a}) = C_L = 2 \\pi A_0$，因此 $\\frac{\\partial f}{\\partial \\mathbf{a}} = 2 \\pi \\mathbf{e}_0$，其中 $\\mathbf{e}_0$ 是选择第一个分量的单位向量。离散伴随向量 $\\boldsymbol{\\lambda}$ 求解以下方程：\n$$\n\\mathbf{M}^T \\boldsymbol{\\lambda} = \\frac{\\partial f}{\\partial \\mathbf{a}} = 2 \\pi \\mathbf{e}_0.\n$$\n由于 $\\mathbf{M}$ 不依赖于 $m$（配置点和余弦基底与几何参数无关），离散伴随梯度为\n$$\n\\frac{d C_L}{d m}\\biggr|_{\\text{disc}} = \\boldsymbol{\\lambda}^T \\frac{\\partial \\mathbf{r}}{\\partial m} = - \\sum_{i=1}^{N+1} \\lambda_i \\, \\frac{\\partial}{\\partial m} \\frac{dz_c}{dx}(x(\\theta_i)).\n$$\n\n对于给定的一组参数 $(\\alpha, m, p, N)$，将相对误差度量定义为\n$$\nE = \\frac{\\left| \\frac{d C_L}{d m}\\big|_{\\text{disc}} - \\frac{d C_L}{d m}\\big|_{\\text{cont}} \\right|}{\\max \\left( \\left| \\frac{d C_L}{d m}\\big|_{\\text{cont}} \\right|, \\varepsilon \\right)},\n$$\n其中 $\\varepsilon = 10^{-12}$。\n\n攻角必须以弧度为单位指定。升力系数 $C_L$ 及其梯度是无量纲的。\n\n实现一个 Python 程序，该程序：\n- 使用上述解析公式计算 $\\frac{d C_L}{d m}\\big|_{\\text{cont}}$。\n- 对每个 $(\\alpha, m, p, N)$，构建并求解关于 $\\boldsymbol{\\lambda}$ 的离散伴随系统，并计算 $\\frac{d C_L}{d m}\\big|_{\\text{disc}}$。\n- 报告所提供测试套件的相对误差 $E$。\n\n测试套件参数：\n- Case $1$: $(\\alpha, m, p, N) = \\left( \\frac{3 \\pi}{180}, 0.02, 0.4, 4 \\right)$.\n- Case $2$: $(\\alpha, m, p, N) = \\left( \\frac{3 \\pi}{180}, 0.02, 0.4, 8 \\right)$.\n- Case $3$: $(\\alpha, m, p, N) = \\left( \\frac{3 \\pi}{180}, 0.02, 0.4, 16 \\right)$.\n- Case $4$: $(\\alpha, m, p, N) = \\left( \\frac{3 \\pi}{180}, 0.02, 0.4, 32 \\right)$.\n- Case $5$: $(\\alpha, m, p, N) = \\left( \\frac{3 \\pi}{180}, 0.02, 0.1, 16 \\right)$.\n- Case $6$: $(\\alpha, m, p, N) = \\left( \\frac{3 \\pi}{180}, 0.02, 0.5, 32 \\right)$.\n\n你的程序应该生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，“[result1,result2,...]”）。每个结果必须是一个浮点数，代表相应测试用例的相对误差 $E$，并严格按照上面列出的顺序。",
            "solution": "经评估，该问题陈述在科学上是合理的、适定的和自洽的。它提出了一个计算空气动力学和基于伴随的灵敏度分析中的标准（尽管简化了）问题。所有提供的公式和定义都与薄翼理论和伴随方法的既定原则一致。因此，该问题被认为是有效的，并在下面提供了一个解决方案。\n\n目标是计算 NACA 四位数翼型的升力系数 $C_L$ 相对于最大弯度参数 $m$ 的梯度。我们将比较使用连续伴随公式计算的梯度与使用离散伴随公式计算的梯度，并量化相对误差。\n\n### 连续伴随公式\n\n在薄翼理论下，升力系数是攻角 $\\alpha$ 和翼型弯度线形状 $z_c(x)$ 的函数。该理论将流动相切边界条件线性化，并将其应用于弦线 $x \\in [0, 1]$ 上。使用角坐标变换 $x(\\theta) = (1 - \\cos \\theta) / 2$，边界条件表示为函数 $f(\\theta)$，然后将其展开为余弦级数：\n$$\nf(\\theta) = \\alpha - \\frac{dz_c}{dx}(x(\\theta)) = A_0 + \\sum_{n=1}^{\\infty} A_n \\cos(n \\theta)\n$$\n升力系数与常数项 $A_0$ 成正比：\n$$\nJ = C_L = 2 \\pi A_0\n$$\n可以使用余弦函数的正交性来分离出系数 $A_0$：\n$$\nA_0 = \\frac{1}{\\pi} \\int_{0}^{\\pi} f(\\theta) d\\theta = \\frac{1}{\\pi} \\int_{0}^{\\pi} \\left( \\alpha - \\frac{dz_c}{dx}(x(\\theta)) \\right) d\\theta\n$$\n设计参数是最大弯度 $m$。目标函数 $J$ 相对于 $m$ 的梯度可以通过对 $C_L$ 的表达式求导找到。这就是连续梯度，因为它是在对控制方程进行任何数值离散化之前推导出来的。\n$$\n\\frac{d C_L}{d m}\\biggr|_{\\text{cont}} = \\frac{d}{dm} \\left( 2 \\pi \\frac{1}{\\pi} \\int_{0}^{\\pi} \\left( \\alpha - \\frac{dz_c}{dx} \\right) d\\theta \\right) = -2 \\int_{0}^{\\pi} \\frac{\\partial}{\\partial m}\\left(\\frac{dz_c}{dx}(x(\\theta))\\right) d\\theta\n$$\n弯度斜率的导数 $\\frac{\\partial}{\\partial m}(\\frac{dz_c}{dx})$ 是从 NACA 四位数翼型弯度线的分段定义中推导出来的：\n$$\n\\frac{\\partial}{\\partial m} \\frac{dz_c}{dx}(x) =\n\\begin{cases}\n    \\frac{2}{p^2} (p - x)        \\text{for } 0 \\le x \\le p \\\\\n    \\frac{2}{(1 - p)^2} (p - x)  \\text{for } p \\le x \\le 1\n\\end{cases}\n$$\n代入 $x(\\theta) = (1 - \\cos \\theta) / 2$ 并在由 $\\theta_p = \\arccos(1 - 2p)$ 分隔的两个段上积分，得到所提供的连续梯度解析公式，我们已经验证了该公式：\n$$\n\\frac{d C_L}{d m}\\biggr|_{\\text{cont}} = -2 \\left[ \\frac{2}{p^2} \\left( \\frac{2p - 1}{2} \\theta_p + \\frac{1}{2} \\sin \\theta_p \\right) + \\frac{2}{(1 - p)^2} \\left( \\frac{2p - 1}{2} (\\pi - \\theta_p) - \\frac{1}{2} \\sin \\theta_p \\right) \\right]\n$$\n此公式仅取决于参数 $p$，即最大弯度的位置。\n\n### 离散伴随公式\n\n在离散方法中，我们首先离散化控制方程，然后进行灵敏度分析。边界条件在一组有限的 $N+1$ 个配置点 $\\theta_i = \\frac{i \\pi}{N+1}$（其中 $i = 1, 2, \\dots, N+1$）上强制执行。余弦级数被截断为 $N+1$ 项，$[A_0, A_1, \\dots, A_N]^T = \\mathbf{a}$。这产生一个线性方程组（原始或状态系统）：\n$$\n\\mathbf{R}(\\mathbf{a}, m) = \\mathbf{M} \\mathbf{a} - \\mathbf{r}(m) = \\mathbf{0}\n$$\n其中矩阵 $\\mathbf{M}$ 和向量 $\\mathbf{r}$ 由下式给出：\n$$\nM_{ij} = \\cos(j \\theta_i) \\quad \\text{for } i \\in \\{1, \\dots, N+1\\}, j \\in \\{0, \\dots, N\\}\n$$\n$$\nr_i(m) = \\alpha - \\frac{dz_c}{dx}(x(\\theta_i); m)\n$$\n离散目标函数为 $f(\\mathbf{a}) = 2 \\pi A_0 = 2 \\pi \\mathbf{e}_0^T \\mathbf{a}$，其中 $\\mathbf{e}_0 = [1, 0, \\dots, 0]^T$。\n\n为了找到梯度 $\\frac{df}{dm}$，我们使用伴随方法来避免计算成本高昂的 $\\frac{d\\mathbf{a}}{dm}$。全导数为：\n$$\n\\frac{df}{dm} = \\frac{\\partial f}{\\partial \\mathbf{a}}^T \\frac{d\\mathbf{a}}{dm} + \\frac{\\partial f}{\\partial m}\n$$\n由于 $f$ 不显式依赖于 $m$，因此 $\\frac{\\partial f}{\\partial m} = 0$。对状态方程 $\\mathbf{R}=\\mathbf{0}$ 求导得出 $\\frac{d\\mathbf{R}}{dm} = \\frac{\\partial \\mathbf{R}}{\\partial \\mathbf{a}} \\frac{d\\mathbf{a}}{dm} + \\frac{\\partial \\mathbf{R}}{\\partial m} = \\mathbf{0}$，这给出 $\\mathbf{M} \\frac{d\\mathbf{a}}{dm} - \\frac{\\partial \\mathbf{r}}{\\partial m} = \\mathbf{0}$。求解 $\\frac{d\\mathbf{a}}{dm}$ 得到 $\\frac{d\\mathbf{a}}{dm} = \\mathbf{M}^{-1} \\frac{\\partial \\mathbf{r}}{\\partial m}$。\n将此代入梯度表达式：\n$$\n\\frac{df}{dm} = \\left(\\frac{\\partial f}{\\partial \\mathbf{a}}\\right)^T \\mathbf{M}^{-1} \\frac{\\partial \\mathbf{r}}{\\partial m}\n$$\n我们将伴随向量 $\\boldsymbol{\\lambda}$ 定义为伴随方程的解：\n$$\n\\mathbf{M}^T \\boldsymbol{\\lambda} = \\left(\\frac{\\partial f}{\\partial \\mathbf{a}}\\right) = 2 \\pi \\mathbf{e}_0\n$$\n通过对该方程进行转置，我们看到 $\\boldsymbol{\\lambda}^T = (2 \\pi \\mathbf{e}_0)^T (\\mathbf{M}^T)^{-1} = (2 \\pi \\mathbf{e}_0)^T (\\mathbf{M}^{-1})^T$。问题陈述在向量表示法上有一个小错误。假设 $\\frac{\\partial f}{\\partial \\mathbf{a}}$ 是一个列向量，则正确的伴随求解是 $\\mathbf{M}^T \\boldsymbol{\\lambda} = (\\frac{\\partial f}{\\partial \\mathbf{a}})^T$。等等，不对，根据微积分的惯例，$\\frac{\\partial f}{\\partial \\mathbf{a}}$ 是一个行向量，但通常表示为列向量（梯度）。让我们遵循问题陈述：$\\mathbf{M}^T \\boldsymbol{\\lambda} = (\\frac{\\partial f}{\\partial \\mathbf{a}})$。这给出 $\\boldsymbol{\\lambda} = (\\mathbf{M}^T)^{-1} (\\frac{\\partial f}{\\partial \\mathbf{a}})$。然后 $\\boldsymbol{\\lambda}^T = ((\\frac{\\partial f}{\\partial \\mathbf{a}})^T (\\mathbf{M}^T)^{-1})^T = (\\mathbf{M}^{-1}) (\\frac{\\partial f}{\\partial \\mathbf{a}})$。这似乎行不通。\n\n让我们仔细地重新开始推导。\n$df/dm = \\nabla_{\\mathbf{a}} f \\cdot d\\mathbf{a}/dm$。\n$d\\mathbf{R}/dm = \\nabla_{\\mathbf{a}} \\mathbf{R} \\cdot d\\mathbf{a}/dm + \\partial \\mathbf{R} / \\partial m = 0$。\n这里 $\\nabla_{\\mathbf{a}} f = 2 \\pi \\mathbf{e}_0^T$（一个行向量）。$\\nabla_{\\mathbf{a}} \\mathbf{R} = \\mathbf{M}$。\n所以 $\\mathbf{M} (d\\mathbf{a}/dm) = -\\partial \\mathbf{R} / \\partial m = \\partial \\mathbf{r} / \\partial m$。\n$d\\mathbf{a}/dm = \\mathbf{M}^{-1} (\\partial \\mathbf{r} / \\partial m)$。\n$df/dm = (2 \\pi \\mathbf{e}_0^T) \\mathbf{M}^{-1} (\\partial \\mathbf{r} / \\partial m)$。\n让我们定义伴随向量 $\\boldsymbol{\\lambda}$（作为一个列向量），使得 $\\mathbf{M}^T \\boldsymbol{\\lambda} = (2 \\pi \\mathbf{e}_0^T)^T = 2 \\pi \\mathbf{e}_0$。\n那么 $\\boldsymbol{\\lambda}^T = (2 \\pi \\mathbf{e}_0)^T (\\mathbf{M}^T)^{-1}$。\n所以 $df/dm = \\boldsymbol{\\lambda}^T (\\partial \\mathbf{r} / \\partial m)$。这与问题陈述一致。\n\n因此，离散梯度是：\n$$\n\\frac{d C_L}{d m}\\biggr|_{\\text{disc}} = \\boldsymbol{\\lambda}^T \\frac{\\partial \\mathbf{r}}{\\partial m}\n$$\n其中 $\\frac{\\partial \\mathbf{r}}{\\partial m}$ 是一个向量，其分量为 $(\\frac{\\partial r}{\\partial m})_i = -\\frac{\\partial}{\\partial m} \\frac{dz_c}{dx}(x(\\theta_i))$。我们求解一个关于 $\\boldsymbol{\\lambda}$ 的线性系统，然后通过向量点积计算梯度。对于这个线性问题，参数 $\\alpha$ 和 $m$ 在此梯度计算中不是必需的，因为 $\\boldsymbol{\\lambda}$ 和 $\\frac{\\partial \\mathbf{r}}{\\partial m}$ 都与它们无关。\n\n### 误差计算\n\n离散梯度和连续梯度之间的相对误差计算如下：\n$$\nE = \\frac{\\left| \\frac{d C_L}{d m}\\big|_{\\text{disc}} - \\frac{d C_L}{d m}\\big|_{\\text{cont}} \\right|}{\\max \\left( \\left| \\frac{d C_L}{d m}\\big|_{\\text{cont}} \\right|, \\varepsilon \\right)}\n$$\n使用一个小的正则化参数 $\\varepsilon = 10^{-12}$ 以防止除以零。数值实现将为每个测试用例计算此误差。随着配置点数 $N+1$ 的增加，离散梯度预计会收敛到连续梯度，从而导致误差 $E$ 减小。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes and compares continuous and discrete adjoint gradients for a NACA 4-digit airfoil.\n    \"\"\"\n\n    test_cases = [\n        (3 * np.pi / 180, 0.02, 0.4, 4),\n        (3 * np.pi / 180, 0.02, 0.4, 8),\n        (3 * np.pi / 180, 0.02, 0.4, 16),\n        (3 * np.pi / 180, 0.02, 0.4, 32),\n        (3 * np.pi / 180, 0.02, 0.1, 16),\n        (3 * np.pi / 180, 0.02, 0.5, 32),\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        alpha, m, p, N = case\n        \n        # 1. Compute the continuous adjoint gradient\n        # The formula is invalid for p=0 or p=1, but test cases are safe.\n        if p == 0.0 or p == 1.0:\n            # For p=0.5, the gradient is 0. This is a special case of the formula.\n            if p == 0.5:\n                grad_cont = 0.0\n            else:\n                 # In practice, handle these edge cases if they can occur.\n                 # For the given test suite, this branch is not taken.\n                 grad_cont = np.nan\n        else:\n            theta_p = np.arccos(1 - 2 * p)\n            \n            term1 = (2 / p**2) * ( (2*p - 1)/2 * theta_p + 0.5 * np.sin(theta_p) )\n            \n            term2 = (2 / (1 - p)**2) * ( (2*p - 1)/2 * (np.pi - theta_p) - 0.5 * np.sin(theta_p) )\n            \n            grad_cont = -2 * (term1 + term2)\n\n        # 2. Compute the discrete adjoint gradient\n        \n        # Number of collocation points and modes\n        num_points = N + 1\n        \n        # Collocation points theta_i = i*pi/(N+1) for i = 1, ..., N+1\n        i_vals = np.arange(1, num_points + 1)\n        theta_vec = i_vals * np.pi / num_points\n        \n        # Matrix M where M_ij = cos(j * theta_i) for i rows, j columns\n        # Column index j corresponds to A_j, j from 0 to N\n        # Row index i corresponds to theta_i, i from 1 to N+1\n        j_vals = np.arange(num_points) # 0 to N\n        M = np.cos(np.outer(theta_vec, j_vals))\n        \n        # Solve the adjoint system: M^T * lambda = dJ/da\n        # dJ/da = [2*pi, 0, ..., 0]^T\n        dJ_da = np.zeros(num_points)\n        dJ_da[0] = 2 * np.pi\n        \n        lambda_vec = np.linalg.solve(M.T, dJ_da)\n        \n        # Compute dr/dm = -d/dm(dzc/dx) at collocation points\n        x_vec = (1 - np.cos(theta_vec)) / 2\n        \n        dr_dm = np.zeros(num_points)\n        for i, x_i in enumerate(x_vec):\n            if x_i = p:\n                if p == 0:\n                    deriv = np.inf # Avoid division by zero\n                else:\n                    deriv = (2 / p**2) * (p - x_i)\n            else: # x_i > p\n                if p == 1:\n                    deriv = np.inf # Avoid division by zero\n                else:\n                    deriv = (2 / (1 - p)**2) * (p - x_i)\n            dr_dm[i] = -deriv\n            \n        grad_disc = np.dot(lambda_vec, dr_dm)\n\n        # 3. Compute relative error\n        epsilon = 1e-12\n        denominator = max(abs(grad_cont), epsilon)\n        error = abs(grad_disc - grad_cont) / denominator\n        \n        results.append(error)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.15f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}