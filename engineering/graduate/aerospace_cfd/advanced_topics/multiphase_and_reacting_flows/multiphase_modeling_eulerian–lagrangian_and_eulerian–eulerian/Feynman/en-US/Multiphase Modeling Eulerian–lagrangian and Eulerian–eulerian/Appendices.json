{
    "hands_on_practices": [
        {
            "introduction": "Modeling spray combustion in aerospace engines requires accurately quantifying the heat transfer from hot gas to liquid fuel droplets, a process governing droplet temperature rise and subsequent vaporization. This exercise provides hands-on practice with the fundamental engineering correlations used in Eulerian–Lagrangian models. By calculating the heat transfer coefficient from dimensionless parameters like the Reynolds number ($Re_p$) and Prandtl number ($Pr$), you will solidify your understanding of how micro-scale convective physics are implemented in CFD simulations .",
            "id": "3978234",
            "problem": "In an Eulerian–Lagrangian multiphase model within computational fluid dynamics (CFD), a dilute, monodisperse kerosene spray is injected into a hot air crossflow in an aerospace combustor. Each droplet is tracked in the Lagrangian frame, while the gas phase is resolved in the Eulerian frame. Under dilute conditions with negligible interfacial mass transfer (no significant Stefan flow) and negligible thermal radiation, convective heat transfer from the gas to a spherical droplet is modeled using the well-tested Ranz–Marshall correlation. Starting from the fundamental definitions of the Reynolds number, the Prandtl number, and the Nusselt number for a spherical particle, and adopting the Ranz–Marshall correlation for forced convection around a sphere, express the Nusselt number and compute the heat transfer coefficient for the droplets.\n\nAt a particular location, the gas properties and droplet kinematics are:\n- Gas density: $\\rho_{g} = 0.38 \\ \\mathrm{kg/m^{3}}$.\n- Gas dynamic viscosity: $\\mu_{g} = 5.0 \\times 10^{-5} \\ \\mathrm{Pa \\cdot s}$.\n- Gas thermal conductivity: $k_{g} = 0.070 \\ \\mathrm{W/(m \\cdot K)}$.\n- Gas isobaric specific heat: $c_{p,g} = 1150 \\ \\mathrm{J/(kg \\cdot K)}$.\n- Monodisperse droplet diameter: $d_{p} = 50 \\ \\mathrm{\\mu m}$.\n- Relative slip speed between gas and droplets: $U_{\\mathrm{rel}} = 30 \\ \\mathrm{m/s}$.\n\nUse the dimensionless groups defined by\n$$Re_{p} = \\frac{\\rho_{g} U_{\\mathrm{rel}} d_{p}}{\\mu_{g}}, \\qquad Pr = \\frac{c_{p,g} \\mu_{g}}{k_{g}},$$\nand adopt the Ranz–Marshall correlation\n$$Nu = 2 + 0.6 \\, Re_{p}^{1/2} \\, Pr^{1/3}.$$\nUsing the Nusselt number definition for a sphere, determine the heat transfer coefficient $h$ at this location.\n\nRound your final numerical answer for $h$ to three significant figures and express it in $\\mathrm{W/(m^{2} \\cdot K)}$.",
            "solution": "The problem is deemed valid as it is scientifically grounded, well-posed, and objective. It provides a complete and consistent set of data and established physical correlations for determining the heat transfer coefficient for a droplet in a crossflow, which is a standard problem in multiphase computational fluid dynamics.\n\nThe objective is to compute the convective heat transfer coefficient, $h$, for a spherical droplet. The solution will proceed methodically by first calculating the relevant dimensionless parameters from the given gas properties and kinematic data. These parameters are the particle Reynolds number, $Re_{p}$, and the Prandtl number, $Pr$. Subsequently, these values will be used in the provided Ranz–Marshall correlation to determine the Nusselt number, $Nu$. Finally, the definition of the Nusselt number for a sphere will be rearranged to solve for the heat transfer coefficient, $h$.\n\nThe given parameters are:\n- Gas density: $\\rho_{g} = 0.38 \\ \\mathrm{kg/m^{3}}$\n- Gas dynamic viscosity: $\\mu_{g} = 5.0 \\times 10^{-5} \\ \\mathrm{Pa \\cdot s}$\n- Gas thermal conductivity: $k_{g} = 0.070 \\ \\mathrm{W/(m \\cdot K)}$\n- Gas isobaric specific heat: $c_{p,g} = 1150 \\ \\mathrm{J/(kg \\cdot K)}$\n- Droplet diameter: $d_{p} = 50 \\ \\mathrm{\\mu m} = 50 \\times 10^{-6} \\ \\mathrm{m} = 5.0 \\times 10^{-5} \\ \\mathrm{m}$\n- Relative slip speed: $U_{\\mathrm{rel}} = 30 \\ \\mathrm{m/s}$\n\nStep 1: Calculation of the particle Reynolds number ($Re_{p}$).\nThe particle Reynolds number is defined as:\n$$Re_{p} = \\frac{\\rho_{g} U_{\\mathrm{rel}} d_{p}}{\\mu_{g}}$$\nSubstituting the provided numerical values into this expression:\n$$Re_{p} = \\frac{(0.38) (30) (5.0 \\times 10^{-5})}{5.0 \\times 10^{-5}}$$\nThe term $5.0 \\times 10^{-5}$ in the numerator and denominator cancels, simplifying the calculation:\n$$Re_{p} = 0.38 \\times 30 = 11.4$$\n\nStep 2: Calculation of the Prandtl number ($Pr$).\nThe Prandtl number is defined as the ratio of momentum diffusivity to thermal diffusivity:\n$$Pr = \\frac{c_{p,g} \\mu_{g}}{k_{g}}$$\nSubstituting the given gas properties:\n$$Pr = \\frac{(1150) (5.0 \\times 10^{-5})}{0.070}$$\n$$Pr = \\frac{0.0575}{0.070} = \\frac{575}{700} = \\frac{23}{28}$$\nThe exact fractional value is $\\frac{23}{28}$, which is approximately $0.8214$.\n\nStep 3: Calculation of the Nusselt number ($Nu$).\nThe Nusselt number is calculated using the Ranz–Marshall correlation:\n$$Nu = 2 + 0.6 \\, Re_{p}^{1/2} \\, Pr^{1/3}$$\nUsing the determined values for $Re_{p}$ and $Pr$:\n$$Nu = 2 + 0.6 \\cdot (11.4)^{1/2} \\cdot \\left(\\frac{23}{28}\\right)^{1/3}$$\nWe evaluate the terms with fractional exponents:\n$$(11.4)^{1/2} \\approx 3.376388$$\n$$\\left(\\frac{23}{28}\\right)^{1/3} \\approx (0.821428...)^{1/3} \\approx 0.936550$$\nSubstituting these results into the correlation:\n$$Nu \\approx 2 + 0.6 \\times 3.376388 \\times 0.936550$$\n$$Nu \\approx 2 + 1.89650$$\n$$Nu \\approx 3.89650$$\n\nStep 4: Determination of the heat transfer coefficient ($h$).\nThe Nusselt number for external flow over a sphere is defined as:\n$$Nu = \\frac{h d_{p}}{k_{g}}$$\nThis definition relates the dimensionless heat transfer ($Nu$) to the dimensional heat transfer coefficient ($h$). We can rearrange this equation to solve for $h$:\n$$h = \\frac{Nu \\cdot k_{g}}{d_{p}}$$\nSubstituting the calculated value for $Nu$ and the given values for $k_{g}$ and $d_{p}$:\n$$h \\approx \\frac{(3.89650) \\cdot (0.070 \\ \\mathrm{W/(m \\cdot K)})}{5.0 \\times 10^{-5} \\ \\mathrm{m}}$$\n$$h \\approx \\frac{0.272755}{5.0 \\times 10^{-5}} \\ \\mathrm{W/(m^{2} \\cdot K)}$$\n$$h \\approx 5455.1 \\ \\mathrm{W/(m^{2} \\cdot K)}$$\n\nThe problem requires the final answer to be rounded to three significant figures.\n$$h \\approx 5460 \\ \\mathrm{W/(m^{2} \\cdot K)}$$\nExpressed in standard scientific notation, this is $5.46 \\times 10^3 \\ \\mathrm{W/(m^{2} \\cdot K)}$.",
            "answer": "$$\\boxed{5.46 \\times 10^{3}}$$"
        },
        {
            "introduction": "While the Lagrangian framework tracks individual particles, the Eulerian–Eulerian approach treats the dispersed phase as a continuum. This exercise guides you through the critical derivation that bridges these two views, showing how to formulate a volumetric interfacial heat transfer source term from single-particle physics for use in the averaged two-fluid equations .",
            "id": "3978150",
            "problem": "Aerospace Computational Fluid Dynamics (CFD) models of liquid-fueled combustors often represent spray–gas thermal coupling either by tracking individual spherical droplets (Eulerian–Lagrangian) or by solving for dispersed and continuous phases simultaneously (Eulerian–Eulerian). Consider a monodisperse ensemble of spherical liquid droplets of diameter $d_p$ dispersed in a gaseous continuous phase (phase $1$) with thermal conductivity $k_1$. The droplet (phase $2$) has a uniform surface temperature $T_2$, and the gas far from the droplet has a uniform temperature $T_1$. Assume negligible phase change, negligible internal droplet temperature gradients, and a thin, steady thermal boundary layer in the gas surrounding each droplet, such that the interfacial heat flux is governed locally by Fourier’s law. Let $Q_{12}$ denote the rate of heat transfer from phase $1$ to phase $2$ per unit mixture volume, and let $a_i$ denote the interfacial area density (interfacial area per unit mixture volume).\n\nStarting from a control-volume energy balance over a spherical shell that encloses a single droplet and invoking Fourier’s law at the interface, derive the general form of the mixture-level interfacial heat transfer $Q_{12}$ in terms of an interfacial heat transfer coefficient $h_i$ and the interfacial area density $a_i$. Use the definition of the Nusselt number $Nu$ for external flow over a sphere to relate the dimensional heat transfer coefficient at the interface to $k_1$, $d_p$, and $Nu$, and hence define $h_i$ in terms of $k_1$, $d_p$, and $Nu$.\n\nYour final answer must be a single closed-form analytic expression for $h_i$ written only in terms of $k_1$, $d_p$, and $Nu$. No numerical evaluation is required. Express the final answer without units.",
            "solution": "The problem requires the derivation of the general form for the mixture-level interfacial heat transfer, $Q_{12}$, and subsequently an expression for the interfacial heat transfer coefficient, $h_i$.\n\nFirst, we consider the heat transfer from the continuous gas phase (phase $1$) to a single spherical droplet (phase $2$). The rate of heat transfer to a single particle, denoted as $\\dot{q}_p$, is described by Newton's law of cooling. This law relates the heat transfer rate to the temperature difference between the surrounding fluid and the body's surface via a convective heat transfer coefficient. The problem designates this coefficient as the interfacial heat transfer coefficient, $h_i$. For a single spherical droplet of diameter $d_p$, the surface area is $A_p = \\pi d_p^2$. The far-field gas temperature is $T_1$ and the droplet surface temperature is $T_2$. The heat transfer from the gas to the single droplet is therefore:\n$$\n\\dot{q}_p = h_i A_p (T_1 - T_2)\n$$\nwhere the temperature difference $(T_1 - T_2)$ ensures that the heat transfer rate $\\dot{q}_p$ is positive for heat flow from phase $1$ to phase $2$.\n\nThe quantity $Q_{12}$ is defined as the rate of heat transfer from phase $1$ to phase $2$ per unit mixture volume. To obtain this volumetric rate, we multiply the heat transfer rate for a single particle, $\\dot{q}_p$, by the number of particles per unit mixture volume, which we denote as $n_p$.\n$$\nQ_{12} = n_p \\dot{q}_p = n_p h_i A_p (T_1 - T_2)\n$$\n\nThe problem introduces the interfacial area density, $a_i$, defined as the total interfacial area per unit mixture volume. For a monodisperse system of spherical particles, this is the surface area of one particle, $A_p$, multiplied by the number of particles per unit volume, $n_p$.\n$$\na_i = n_p A_p\n$$\n\nSubstituting this definition into the expression for $Q_{12}$ yields the general form of the mixture-level interfacial heat transfer, which is a key source term in Eulerian–Eulerian multiphase models:\n$$\nQ_{12} = h_i a_i (T_1 - T_2)\n$$\nThis completes the first part of the derivation.\n\nNext, we must define the interfacial heat transfer coefficient, $h_i$, in terms of the given physical properties. The problem directs us to use the definition of the Nusselt number, $Nu$. The Nusselt number is a dimensionless quantity that represents the ratio of convective to conductive heat transfer across a boundary. For external flow over a body, it is defined as:\n$$\nNu = \\frac{h L_c}{k_f}\n$$\nwhere $h$ is the convective heat transfer coefficient, $L_c$ is the characteristic length of the body, and $k_f$ is the thermal conductivity of the surrounding fluid.\n\nIn the context of this specific problem:\n- The convective heat transfer coefficient is the interfacial coefficient, so $h = h_i$.\n- The characteristic length for a spherical particle is its diameter, so $L_c = d_p$.\n- The surrounding fluid is the continuous gas phase (phase $1$), so its thermal conductivity is $k_f = k_1$.\n\nSubstituting these specific terms into the general definition of the Nusselt number provides the relationship for this system:\n$$\nNu = \\frac{h_i d_p}{k_1}\n$$\n\nThe problem asks for a closed-form analytic expression for $h_i$. We can obtain this by algebraically rearranging the definition of the Nusselt number:\n$$\nh_i = Nu \\frac{k_1}{d_p}\n$$\nThis expression defines the interfacial heat transfer coefficient in terms of the dimensionless Nusselt number (which itself is typically found from empirical correlations involving the Reynolds and Prandtl numbers), the thermal conductivity of the continuous phase, and the diameter of the dispersed phase particles. This result is central to closing the heat transfer source term in multiphase CFD models.",
            "answer": "$$\\boxed{Nu \\frac{k_1}{d_p}}$$"
        },
        {
            "introduction": "Many multiphase flows, such as soot formation or spray atomization, involve particles whose sizes change due to processes like coagulation and breakage. The population balance equation (PBE) is the governing framework for these phenomena, but its numerical solution requires careful formulation to ensure physical laws like mass conservation are obeyed. By tackling the discretization of coagulation and breakage source terms within a sectional method, this advanced practice will give you deep insight into the computational modeling of evolving particle size distributions .",
            "id": "3978163",
            "problem": "Consider the Eulerian–Eulerian description of a dispersed phase where the particle internal coordinate is the particle volume $v$ and the state variable is the number density function $n(v,t)$ measured per unit physical volume per unit particle-volume. The governing population balance for coagulation and breakage can be written as a conservation law over the internal coordinate $v$, driven by physically measurable kernels and rates. The fundamental laws to employ are: conservation of mass, conservation of counts under removal or addition mechanisms, and the Smoluchowski coagulation equation for binary aggregation under well-mixed conditions. Your task is to construct a mass-conserving sectional (fixed-pivot) discretization over the size space and implement the corresponding birth–death source terms.\n\nLet the particle volume domain be discretized into $N$ bins with fixed pivots $\\{v_i\\}_{i=1}^N$, where $v_i>0$ denotes the representative particle volume for bin $i$. Let $n_i(t)$ denote the number density in bin $i$ (per unit physical volume), and let the birth–death source term for bin $i$ be $S_i(t)$ with units $\\text{s}^{-1} \\cdot \\text{m}^{-3}$, so that the semi-discrete evolution of $n_i$ is $\\mathrm{d}n_i/\\mathrm{d}t = S_i$.\n\nYou must derive expressions for the discrete birth and death terms for:\n1. Binary coagulation governed by a collision kernel $K(u,v)$ that has units $\\text{m}^3/\\text{s}$ (volume per time) and satisfies the symmetry $K(u,v)=K(v,u)$.\n2. Binary breakage governed by a breakage rate $a(v)$ with units $\\text{s}^{-1}$ and a binary equal-fragment distribution that splits a parent particle of volume $v'$ into two fragments each of volume $v'/2$.\n\nUse only the following foundational bases:\n- The continuous Smoluchowski coagulation equation for number density $n(v,t)$,\n- The continuous breakage equation with a fragment number distribution,\n- Conservation of total mass in the dispersed phase, i.e., $\\sum_{i=1}^N v_i S_i = 0$ when only coagulation or only breakage acts.\n\nYour derivation must construct a fixed-pivot sectional method: when a new particle with volume $v_p$ is produced (either by coagulation or as a fragment from breakage), it must be apportioned between the two nearest pivots surrounding $v_p$ using linear weights to ensure that the total produced mass is preserved. If $v_p$ lies below $v_1$, assign all produced mass to $v_1$; if $v_p$ lies above $v_N$, assign all produced mass to $v_N$. The interpolation weights must be defined to conserve mass exactly at the semi-discrete level.\n\nFrom first principles, derive explicit formulas for the discrete coagulation birth and death terms $B_i^{\\mathrm{coag}}$ and $D_i^{\\mathrm{coag}}$ and the breakage birth and death terms $B_i^{\\mathrm{brk}}$ and $D_i^{\\mathrm{brk}}$. The total source term is then $S_i = \\left(B_i^{\\mathrm{coag}} - D_i^{\\mathrm{coag}}\\right) + \\left(B_i^{\\mathrm{brk}} - D_i^{\\mathrm{brk}}\\right)$.\n\nImplementation requirements:\n- Using the derived formulas, implement a program that computes $S_i$ for given inputs $\\{v_i\\}$, $\\{n_i\\}$, $K(u,v)$, and $a(v)$, and verifies mass conservation by computing the scalar residual $R = \\sum_{i=1}^N v_i S_i$. Report $R$ as a floating-point number in units $\\text{s}^{-1}$.\n- For coagulation, use the symmetry-correct double sum over bin pairs $(i,j)$ with a factor of $\\tfrac{1}{2}$ for identical-bin collisions to avoid double counting. The produced particle volume is $v_p = v_i + v_j$.\n- For breakage, use binary equal fragment breakage, so that all produced mass $v'$ per breaking parent of volume $v'$ is apportioned as fragments of size $v'/2$.\n\nYour program must evaluate the following test suite and produce a single line of output containing the residuals for each case as a comma-separated list enclosed in square brackets, formatted as raw Python floats (no units string):\n\nTest Suite (all volumes expressed in $\\text{m}^3$, time in $\\text{s}$):\n- Case 1 (coagulation only, monodisperse, constant kernel):\n  - $N=5$, pivots $v = [1\\times 10^{-21}, 2\\times 10^{-21}, 4\\times 10^{-21}, 8\\times 10^{-21}, 1.6\\times 10^{-20}]$,\n  - $n = [0, 1\\times 10^{12}, 0, 0, 0]$,\n  - $K(u,v) = 1\\times 10^{-16}$.\n  - Breakage disabled: $a(v) = 0$ for all $v$.\n- Case 2 (coagulation only, polydisperse, size-dependent kernel):\n  - Same $v$ as Case 1,\n  - $n = [1\\times 10^{10}, 5\\times 10^{10}, 2\\times 10^{10}, 1\\times 10^{9}, 1\\times 10^{8}]$,\n  - $K(u,v) = K_0\\left(u^{1/3} + v^{1/3}\\right)$ with $K_0 = 1\\times 10^{-12}$.\n  - Breakage disabled: $a(v) = 0$ for all $v$.\n- Case 3 (breakage only, binary equal split, constant rate):\n  - Same $v$ as Case 1,\n  - $n = [0, 0, 1\\times 10^{12}, 0, 0]$,\n  - Breakage rate $a(v) = 0.1$,\n  - Coagulation disabled: $K(u,v) = 0$.\n- Case 4 (combined coagulation and breakage):\n  - Same $v$ as Case 1,\n  - $n = [2\\times 10^{10}, 3\\times 10^{10}, 1\\times 10^{10}, 5\\times 10^{9}, 1\\times 10^{9}]$,\n  - $K(u,v) = 5\\times 10^{-17}$,\n  - $a(v) = 0.05$.\n- Case 5 (coagulation only, edge case with product volume above maximum pivot):\n  - Same $v$ as Case 1,\n  - $n = [0, 0, 0, 0, 1\\times 10^{12}]$,\n  - $K(u,v) = 1\\times 10^{-18}$,\n  - Breakage disabled: $a(v) = 0$ for all $v$.\n\nFor each case, compute the residual $R = \\sum_{i=1}^N v_i S_i$ in $\\text{s}^{-1}$ and output a single line containing the list of the five residuals in the format \"[R1,R2,R3,R4,R5]\". The outputs must be floats. The derived method and the implementation must ensure that $R$ is zero to within floating-point rounding error for each case due to mass conservation by construction.",
            "solution": "The problem requires the derivation and implementation of a mass-conserving fixed-pivot sectional method for the population balance equation (PBE) governing particle coagulation and breakage. We will first derive the semi-discrete source terms from first principles and then implement the resulting formulas to verify mass conservation for a given set of test cases.\n\nLet $n(v,t)$ be the continuous number density function of particles of volume $v$ at time $t$. The PBE can be written as:\n$$\n\\frac{\\partial n(v,t)}{\\partial t} = S(v,t) = \\left( B^{\\mathrm{coag}}(v,t) - D^{\\mathrm{coag}}(v,t) \\right) + \\left( B^{\\mathrm{brk}}(v,t) - D^{\\mathrm{brk}}(v,t) \\right)\n$$\nwhere $B$ and $D$ represent the birth and death rates due to coagulation (coag) and breakage (brk), respectively.\n\nThe continuous Smoluchowski coagulation equation defines the birth and death terms as:\n$$\nB^{\\mathrm{coag}}(v,t) = \\frac{1}{2} \\int_0^v K(u, v-u) n(u,t) n(v-u,t) \\,du\n$$\n$$\nD^{\\mathrm{coag}}(v,t) = n(v,t) \\int_0^\\infty K(v,u) n(u,t) \\,du\n$$\nFor binary breakage of a particle of volume $v'$ into two fragments of volume $v'/2$, with a breakage rate $a(v')$, the continuous terms are:\n$$\nB^{\\mathrm{brk}}(v,t) = \\int_v^\\infty 2 \\cdot a(v') \\cdot_b(v|v') n(v',t) \\,dv' = 2 \\cdot a(2v) n(2v, t)\n$$\nwhere the fragment distribution function $_b(v|v')$ for binary equal splitting is $_b(v|v') = \\delta(v - v'/2)$, and the factor of $2$ accounts for the number of fragments.\n$$\nD^{\\mathrm{brk}}(v,t) = a(v) n(v,t)\n$$\n\nWe now discretize the volume domain into $N$ sections, or bins, with representative fixed-pivot volumes $\\{v_i\\}_{i=1}^N$. The discrete state variable for bin $i$ is $n_i(t)$, the number density. The semi-discrete evolution equation is $\\mathrm{d}n_i/\\mathrm{d}t = S_i$, where $S_i = S_i^{\\mathrm{coag}} + S_i^{\\mathrm{brk}}$.\n\n### Derivation of Coagulation Source Term ($S_i^{\\mathrm{coag}}$)\n\nThe coagulation source term for bin $i$ is $S_i^{\\mathrm{coag}} = B_i^{\\mathrm{coag}} - D_i^{\\mathrm{coag}}$.\n\n**1. Death Term ($D_i^{\\mathrm{coag}}$)**\nParticles of volume $v_i$ are lost when they coagulate with any other particle. The rate of loss from bin $i$ is obtained by discretizing the continuous death integral. A particle in bin $i$ collides with a particle in bin $j$ with a rate proportional to $K(v_i, v_j)n_i n_j$. Summing over all possible collision partners $j$:\n$$\nD_i^{\\mathrm{coag}} = n_i \\sum_{j=1}^N K(v_i, v_j) n_j\n$$\n\n**2. Birth Term ($B_i^{\\mathrm{coag}}$)**\nParticles are formed by the coagulation of two smaller particles. A collision between particles from bins $j$ and $k$ produces a new particle of volume $v_p = v_j + v_k$. The rate of these collision events per unit physical volume is $(1-\\frac{1}{2}\\delta_{jk}) K(v_j, v_k) n_j n_k$, where the term $(1-\\frac{1}{2}\\delta_{jk})$ correctly handles collisions of particles from the same bin ($j=k$) to avoid double-counting.\n\nThe newly formed particle of volume $v_p$ must be apportioned to the discrete pivots. Let $\\chi_i(v_p)$ be the number of particles assigned to bin $i$ for each particle of volume $v_p$ created. This apportionment function must conserve the mass of the new particle, such that $\\sum_{i=1}^N v_i \\chi_i(v_p) = v_p$. Following the problem specification:\n- If $v_p$ falls between two pivots, $v_l \\le v_p < v_{l+1}$, we use linear weighting that conserves both number and mass. This is achieved by representing the single particle of mass $v_p$ as a combination of $w_l$ particles of mass $v_l$ and $w_{l+1}$ particles of mass $v_{l+1}$, where $w_l+w_{l+1}=1$ (number conservation) and $w_l v_l + w_{l+1} v_{l+1} = v_p$ (mass conservation). Solving this system yields the number weights:\n  $w_l = \\frac{v_{l+1}-v_p}{v_{l+1}-v_l}$ and $w_{l+1} = \\frac{v_p-v_l}{v_{l+1}-v_l}$.\n- If $v_p < v_1$, all mass is assigned to $v_1$. To conserve mass $v_p$, the number of particles added to bin $1$ must be $v_p/v_1$.\n- If $v_p \\ge v_N$, all mass is assigned to $v_N$. The number of particles added to bin $N$ must be $v_p/v_N$.\n\nCombining these, the apportionment function $\\chi_i(v_p)$ is:\n$$\n\\chi_i(v_p) =\n\\begin{cases}\n\\delta_{i1} \\frac{v_p}{v_1} & \\text{if } v_p < v_1 \\\\\n\\delta_{i,l} \\frac{v_{l+1}-v_p}{v_{l+1}-v_l} + \\delta_{i,l+1} \\frac{v_p-v_l}{v_{l+1}-v_l} & \\text{if } v_l \\le v_p < v_{l+1} \\\\\n\\delta_{iN} \\frac{v_p}{v_N} & \\text{if } v_p \\ge v_N\n\\end{cases}\n$$\nIt can be verified that for any $v_p$, $\\sum_{i=1}^N v_i \\chi_i(v_p) = v_p$, ensuring mass conservation for the birth step.\n\nThe total birth rate into bin $i$ is the sum of contributions from all coagulating pairs $(j,k)$:\n$$\nB_i^{\\mathrm{coag}} = \\sum_{j=1}^N \\sum_{k=1}^j (1-\\tfrac{1}{2}\\delta_{jk}) K(v_j, v_k) n_j n_k \\, \\chi_i(v_j+v_k)\n$$\nThe total rate of mass change due to coagulation is $\\sum_{i=1}^N v_i S_i^{\\mathrm{coag}} = \\sum_i v_i B_i^{\\mathrm{coag}} - \\sum_i v_i D_i^{\\mathrm{coag}}$.\nThe birth mass rate is $\\sum_i v_i B_i^{\\mathrm{coag}} = \\sum_{j,k, \\text{symm}} K_{jk}n_j n_k \\sum_i v_i \\chi_i(v_j+v_k) = \\sum_{j,k, \\text{symm}} K_{jk}n_j n_k (v_j+v_k)$.\nThe death mass rate is $\\sum_i v_i D_i^{\\mathrm{coag}} = \\sum_i v_i n_i \\sum_j K_{ij} n_j = \\sum_{i,j} v_i K_{ij} n_i n_j$. Symmetrizing this gives $\\frac{1}{2}\\sum_{i,j}(v_i+v_j)K_{ij}n_i n_j$, which is identical to the birth mass rate. Thus, $\\sum_{i=1}^N v_i S_i^{\\mathrm{coag}} = 0$, and the scheme is mass-conservative.\n\n### Derivation of Breakage Source Term ($S_i^{\\mathrm{brk}}$)\n\nThe breakage source term is $S_i^{\\mathrm{brk}} = B_i^{\\mathrm{brk}} - D_i^{\\mathrm{brk}}$.\n\n**1. Death Term ($D_i^{\\mathrm{brk}}$)**\nParticles in bin $i$ are lost due to breakage at a rate $a(v_i)$.\n$$\nD_i^{\\mathrm{brk}} = a(v_i) n_i\n$$\n\n**2. Birth Term ($B_i^{\\mathrm{brk}}$)**\nA particle of volume $v_j$ from bin $j$ breaks, producing two fragments, each of volume $v_p = v_j/2$. The number of breakage events in bin $j$ per unit time is $a(v_j)n_j$. Since each event produces two fragments, the total rate of fragment production from bin $j$ is $2 a(v_j)n_j$. These fragments, each of volume $v_p=v_j/2$, are then apportioned to the grid using the same mass-conserving function $\\chi_i(v_p)$.\nThe birth rate into bin $i$ from the breakage of all particles in bin $j$ is $2 a(v_j) n_j \\chi_i(v_j/2)$. Summing over all parent bins $j$:\n$$\nB_i^{\\mathrm{brk}} = \\sum_{j=1}^N 2 \\cdot a(v_j) n_j \\, \\chi_i(v_j/2)\n$$\nThe total rate of mass change is $\\sum_{i=1}^N v_i S_i^{\\mathrm{brk}} = \\sum_i v_i B_i^{\\mathrm{brk}} - \\sum_i v_i D_i^{\\mathrm{brk}}$.\nThe birth mass rate is $\\sum_i v_i B_i^{\\mathrm{brk}} = \\sum_j 2 a_j n_j \\sum_i v_i \\chi_i(v_j/2) = \\sum_j 2 a_j n_j (v_j/2) = \\sum_j a_j n_j v_j$.\nThe death mass rate is $\\sum_i v_i D_i^{\\mathrm{brk}} = \\sum_i v_i a_i n_i$. These are identical, so $\\sum_{i=1}^N v_i S_i^{\\mathrm{brk}} = 0$. This scheme is also mass-conservative.\n\n### Summary of Final Equations\n\nThe total source term for bin $i$ is given by $S_i = (B_i^{\\mathrm{coag}} - D_i^{\\mathrm{coag}}) + (B_i^{\\mathrm{brk}} - D_i^{\\mathrm{brk}})$, with the components defined as:\n$$\nD_i^{\\mathrm{coag}} = n_i \\sum_{j=1}^N K(v_i, v_j) n_j\n$$\n$$\nB_i^{\\mathrm{coag}} = \\sum_{j=1}^N \\sum_{k=1}^j (1-\\tfrac{1}{2}\\delta_{jk}) K(v_j, v_k) n_j n_k \\, \\chi_i(v_j+v_k)\n$$\n$$\nD_i^{\\mathrm{brk}} = a(v_i) n_i\n$$\n$$\nB_i^{\\mathrm{brk}} = \\sum_{j=1}^N 2 \\cdot a(v_j) n_j \\, \\chi_i(v_j/2)\n$$\nThe mass conservation check is performed by calculating the residual $R = \\sum_{i=1}^N v_i S_i$, which is expected to be zero within floating-point precision.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_residual(v, n, K_func, a_func):\n    \"\"\"\n    Calculates the source terms for coagulation and breakage using a fixed-pivot\n    sectional method and returns the total mass residual.\n\n    Args:\n        v (np.ndarray): Array of N pivot volumes [m^3].\n        n (np.ndarray): Array of N number densities [m^-3].\n        K_func (callable): Coagulation kernel function K(u, v) [m^3/s].\n        a_func (callable): Breakage rate function a(v) [s^-1].\n\n    Returns:\n        float: The mass conservation residual R = sum(v_i * S_i) [s^-1].\n    \"\"\"\n    N = len(v)\n    v_min = v[0]\n    v_max = v[-1]\n\n    # --- Coagulation ---\n    B_coag = np.zeros(N)\n    D_coag = np.zeros(N)\n\n    # Coagulation Death Term\n    for i in range(N):\n        if n[i] == 0:\n            continue\n        loss_rate = 0.0\n        for j in range(N):\n            if n[j] > 0:\n                loss_rate += K_func(v[i], v[j]) * n[j]\n        D_coag[i] = n[i] * loss_rate\n\n    # Coagulation Birth Term\n    for j in range(N):\n        if n[j] == 0:\n            continue\n        for k in range(j + 1):\n            if n[k] == 0:\n                continue\n\n            rate_of_events = K_func(v[j], v[k]) * n[j] * n[k]\n            if j == k:\n                rate_of_events *= 0.5\n\n            if rate_of_events == 0:\n                continue\n\n            v_p = v[j] + v[k]\n\n            # Apportionment logic for coagulation product\n            if v_p  v_min:\n                # Assign all mass to the first bin\n                num_particles = v_p / v_min\n                B_coag[0] += rate_of_events * num_particles\n            elif v_p >= v_max:\n                # Assign all mass to the last bin\n                num_particles = v_p / v_max\n                B_coag[-1] += rate_of_events * num_particles\n            else:\n                # Find adjacent pivots using binary search\n                # l is the index such that v[l] = v_p  v[l+1]\n                l = np.searchsorted(v, v_p, side='right') - 1\n                \n                # Check for numerical precision issues at boundaries\n                if l  0: # Should not happen due to initial check, but for safety\n                    num_particles = v_p / v_min\n                    B_coag[0] += rate_of_events * num_particles\n                    continue\n                if l >= N - 1: # Should not happen due to initial check\n                    num_particles = v_p / v_max\n                    B_coag[-1] += rate_of_events * num_particles\n                    continue\n\n                if v[l] == v_p: # Product volume matches a pivot exactly\n                     B_coag[l] += rate_of_events\n                     continue\n\n                # Linear interpolation for number conservation\n                w_l_plus_1 = (v_p - v[l]) / (v[l+1] - v[l])\n                w_l = 1.0 - w_l_plus_1\n                B_coag[l] += rate_of_events * w_l\n                B_coag[l+1] += rate_of_events * w_l_plus_1\n\n    S_coag = B_coag - D_coag\n\n    # --- Breakage ---\n    B_brk = np.zeros(N)\n    D_brk = np.zeros(N)\n    \n    # Breakage Death Term\n    for i in range(N):\n        D_brk[i] = a_func(v[i]) * n[i]\n        \n    # Breakage Birth Term\n    for j in range(N):\n        rate_of_events = a_func(v[j]) * n[j]\n        if rate_of_events == 0:\n            continue\n        \n        # Each event produces 2 fragments\n        num_fragments_rate = 2.0 * rate_of_events\n        v_p = v[j] / 2.0\n\n        # Apportionment logic for breakage fragments\n        if v_p  v_min:\n            num_particles = v_p / v_min\n            B_brk[0] += num_fragments_rate * num_particles\n        elif v_p >= v_max:\n            num_particles = v_p / v_max\n            B_brk[-1] += num_fragments_rate * num_particles\n        else:\n            l = np.searchsorted(v, v_p, side='right') - 1\n            if l  0:\n                num_particles = v_p / v_min\n                B_brk[0] += num_fragments_rate * num_particles\n                continue\n\n            if v[l] == v_p:\n                 B_brk[l] += num_fragments_rate\n                 continue\n            \n            w_l_plus_1 = (v_p - v[l]) / (v[l+1] - v[l])\n            w_l = 1.0 - w_l_plus_1\n            B_brk[l] += num_fragments_rate * w_l\n            B_brk[l+1] += num_fragments_rate * w_l_plus_1\n\n    S_brk = B_brk - D_brk\n\n    # --- Total Source and Residual ---\n    S_total = S_coag + S_brk\n    \n    # Mass of the particles is rho_p * v_i. The source terms are for number density.\n    # The rate of change of mass density in bin i is rho_p * v_i * S_i.\n    # The residual R required is sum(v_i * S_i), scaled by rho_p, but rho_p is constant.\n    # The units of R = sum(v_i * S_i) are m^3 * (s^-1 m^-3) = s^-1.\n    residual = np.sum(S_total * v)\n\n    return residual\n\ndef solve():\n    # Define the test cases from the problem statement.\n    v_pivots = np.array([1e-21, 2e-21, 4e-21, 8e-21, 1.6e-20])\n\n    test_cases = [\n        # Case 1 (coagulation only, monodisperse, constant kernel)\n        {\n            \"n\": np.array([0, 1e12, 0, 0, 0]),\n            \"K_func\": lambda u, v: 1e-16,\n            \"a_func\": lambda v_i: 0.0,\n        },\n        # Case 2 (coagulation only, polydisperse, size-dependent kernel)\n        {\n            \"n\": np.array([1e10, 5e10, 2e10, 1e9, 1e8]),\n            \"K_func\": lambda u, v: 1e-12 * (u**(1/3) + v**(1/3)),\n            \"a_func\": lambda v_i: 0.0,\n        },\n        # Case 3 (breakage only, binary equal split, constant rate)\n        {\n            \"n\": np.array([0, 0, 1e12, 0, 0]),\n            \"K_func\": lambda u, v: 0.0,\n            \"a_func\": lambda v_i: 0.1,\n        },\n        # Case 4 (combined coagulation and breakage)\n        {\n            \"n\": np.array([2e10, 3e10, 1e10, 5e9, 1e9]),\n            \"K_func\": lambda u, v: 5e-17,\n            \"a_func\": lambda v_i: 0.05,\n        },\n        # Case 5 (coagulation only, edge case with product volume above maximum pivot)\n        {\n            \"n\": np.array([0, 0, 0, 0, 1e12]),\n            \"K_func\": lambda u, v: 1e-18,\n            \"a_func\": lambda v_i: 0.0,\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        residual = calculate_residual(v_pivots, case[\"n\"], case[\"K_func\"], case[\"a_func\"])\n        results.append(residual)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}