{
    "hands_on_practices": [
        {
            "introduction": "Understanding the energy budget of an atmospheric column is fundamental to climate science and the development of general circulation models. This exercise  challenges you to apply the first law of thermodynamics to a fixed control volume by integrating various energy fluxes over a daily cycle. By calculating the expected change in total energy and comparing it to a given value, you will practice the crucial skill of assessing energy budget closure, a key diagnostic for the physical integrity of atmospheric models.",
            "id": "3869764",
            "problem": "Consider an idealized atmospheric column of horizontal area $A$ that is laterally homogeneous and vertically bounded by the Earth's surface at $z=0$ and the top of the column at $z=H$. Treat the column as a fixed control volume. The column-integrated total energy per unit horizontal area, $E(t)$, is defined as the vertical integral of the sum of internal, gravitational potential, and kinetic energies. Assume there are no lateral advective fluxes of total energy across the sides of the column. Let positive fluxes add energy to the column.\n\nYou are given the following prescribed, time-dependent boundary and source terms over one day ($t \\in [0,\\,86400]$ seconds), all expressed per unit horizontal area:\n- A net surface enthalpy flux (sensible plus latent) into the atmosphere, $F_{\\mathrm{sfc}}(t)$, with\n$$F_{\\mathrm{sfc}}(t) = 30 + 90 \\cos\\!\\left( \\frac{2\\pi}{86400}\\,(t - 43200) \\right)\\ \\mathrm{W\\,m^{-2}}.$$\n- A column radiative flux convergence (net radiative heating of the air column), $Q_{\\mathrm{rad}}(t)$, with\n$$Q_{\\mathrm{rad}}(t) = 15 + 25 \\sin\\!\\left( \\frac{2\\pi}{86400}\\,t \\right)\\ \\mathrm{W\\,m^{-2}}.$$\n- A net mechanical work rate on the column (pressure work plus viscous/turbulent stress work), $W_{\\mathrm{mech}}(t)$, with\n$$W_{\\mathrm{mech}}(t) = 5 + 2 \\cos\\!\\left( \\frac{2\\pi}{43200}\\,t \\right)\\ \\mathrm{W\\,m^{-2}}.$$\n\nA diagnostic based on independent analysis of the column state (integrated moist static plus kinetic energy) yields an actual change in total energy over the same day of\n$$\\Delta E_{\\mathrm{actual}} = 4.295\\ \\mathrm{MJ\\,m^{-2}}.$$\n\nStarting from the first law of thermodynamics for a fixed control volume and the definition of $E(t)$, derive the column-integrated energy budget and compute the budget-implied change in total energy over the day,\n$$\\Delta E_{\\mathrm{budget}} = \\int_{0}^{86400} \\big(F_{\\mathrm{sfc}}(t) + Q_{\\mathrm{rad}}(t) + W_{\\mathrm{mech}}(t)\\big)\\,dt,$$\nthen assess closure of the budget by computing the residual\n$$R = \\Delta E_{\\mathrm{budget}} - \\Delta E_{\\mathrm{actual}}.$$\n\nExpress $R$ in $\\mathrm{MJ\\,m^{-2}}$ and round your final numerical answer to four significant figures.",
            "solution": "The problem requires the calculation of an atmospheric energy budget residual. This is achieved by first computing the total change in energy as predicted by the sum of time-integrated energy fluxes and work rates, and then comparing this value to a given, independently derived change in energy.\n\nThe fundamental principle governing the energy of the atmospheric column, treated as a fixed control volume, is the first law of thermodynamics. For a system with no lateral advection of energy, the time rate of change of the column-integrated total energy per unit horizontal area, $E(t)$, is equal to the sum of all net vertical fluxes and source/sink terms. The problem provides these terms as the net surface enthalpy flux ($F_{\\mathrm{sfc}}(t)$), the column radiative flux convergence ($Q_{\\mathrm{rad}}(t)$), and the net mechanical work rate ($W_{\\mathrm{mech}}(t)$). The governing differential equation is therefore:\n$$ \\frac{dE(t)}{dt} = F_{\\mathrm{sfc}}(t) + Q_{\\mathrm{rad}}(t) + W_{\\mathrm{mech}}(t) $$\nThe total change in energy over a time interval from $t=0$ to a final time $T$ is found by integrating this equation over that interval. This gives the budget-implied change in total energy, $\\Delta E_{\\mathrm{budget}}$:\n$$ \\Delta E_{\\mathrm{budget}} = E(T) - E(0) = \\int_{0}^{T} \\frac{dE(t)}{dt} dt = \\int_{0}^{T} \\big(F_{\\mathrm{sfc}}(t) + Q_{\\mathrm{rad}}(t) + W_{\\mathrm{mech}}(t)\\big)\\,dt $$\nThe problem specifies a time period of one day, so $T = 86400 \\ \\mathrm{s}$. We can compute the integral of each term separately.\n\n1.  **Integral of the surface enthalpy flux, $F_{\\mathrm{sfc}}(t)$**:\n    The contribution from the surface flux is the integral of $F_{\\mathrm{sfc}}(t) = 30 + 90 \\cos\\left( \\frac{2\\pi}{86400}\\,(t - 43200) \\right)$.\n    Let $T_0 = 86400$. The expression is $F_{\\mathrm{sfc}}(t) = 30 + 90 \\cos\\left( \\frac{2\\pi}{T_0}\\,(t - T_0/2) \\right)$.\n    $$ \\int_{0}^{T_0} F_{\\mathrm{sfc}}(t)\\,dt = \\int_{0}^{T_0} \\left[ 30 + 90 \\cos\\left( \\frac{2\\pi}{T_0}\\,(t - \\frac{T_0}{2}) \\right) \\right] dt $$\n    $$ = \\int_{0}^{T_0} 30\\,dt + 90 \\int_{0}^{T_0} \\cos\\left( \\frac{2\\pi}{T_0}t - \\pi \\right) dt $$\n    The integral of the constant term is $[30t]_{0}^{T_0} = 30T_0$. The second term is an integral of a cosine function over one full period ($2\\pi$ phase change), which evaluates to zero.\n    $$ \\int_{0}^{T_0} \\cos\\left( \\frac{2\\pi}{T_0}t - \\pi \\right) dt = \\left[ \\frac{T_0}{2\\pi} \\sin\\left( \\frac{2\\pi}{T_0}t - \\pi \\right) \\right]_{0}^{T_0} = \\frac{T_0}{2\\pi} (\\sin(\\pi) - \\sin(-\\pi)) = 0 $$\n    Thus, the total contribution is $30 \\times 86400 \\ \\mathrm{J\\,m^{-2}} = 2,592,000 \\ \\mathrm{J\\,m^{-2}}$.\n\n2.  **Integral of the radiative flux convergence, $Q_{\\mathrm{rad}}(t)$**:\n    The contribution from radiation is the integral of $Q_{\\mathrm{rad}}(t) = 15 + 25 \\sin\\left( \\frac{2\\pi}{86400}\\,t \\right)$. Again, let $T_0 = 86400$.\n    $$ \\int_{0}^{T_0} Q_{\\mathrm{rad}}(t)\\,dt = \\int_{0}^{T_0} \\left[ 15 + 25 \\sin\\left( \\frac{2\\pi}{T_0}\\,t \\right) \\right] dt $$\n    $$ = \\int_{0}^{T_0} 15\\,dt + 25 \\int_{0}^{T_0} \\sin\\left( \\frac{2\\pi}{T_0}\\,t \\right) dt $$\n    The integral of the constant term is $[15t]_{0}^{T_0} = 15T_0$. The second term is an integral of a sine function over one full period, which also evaluates to zero.\n    $$ \\int_{0}^{T_0} \\sin\\left( \\frac{2\\pi}{T_0}\\,t \\right) dt = \\left[ -\\frac{T_0}{2\\pi} \\cos\\left( \\frac{2\\pi}{T_0}\\,t \\right) \\right]_{0}^{T_0} = -\\frac{T_0}{2\\pi} (\\cos(2\\pi) - \\cos(0)) = 0 $$\n    Thus, the total contribution is $15 \\times 86400 \\ \\mathrm{J\\,m^{-2}} = 1,296,000 \\ \\mathrm{J\\,m^{-2}}$.\n\n3.  **Integral of the net mechanical work rate, $W_{\\mathrm{mech}}(t)$**:\n    The contribution from mechanical work is the integral of $W_{\\mathrm{mech}}(t) = 5 + 2 \\cos\\left( \\frac{2\\pi}{43200}\\,t \\right)$. Let $T_0 = 86400$. The period of the cosine term is $T_0/2 = 43200$.\n    $$ \\int_{0}^{T_0} W_{\\mathrm{mech}}(t)\\,dt = \\int_{0}^{T_0} \\left[ 5 + 2 \\cos\\left( \\frac{4\\pi}{T_0}\\,t \\right) \\right] dt $$\n    $$ = \\int_{0}^{T_0} 5\\,dt + 2 \\int_{0}^{T_0} \\cos\\left( \\frac{4\\pi}{T_0}\\,t \\right) dt $$\n    The integral of the constant term is $[5t]_{0}^{T_0} = 5T_0$. The second term is an integral of a cosine function over two full periods within the interval $[0, T_0]$, which evaluates to zero.\n    $$ \\int_{0}^{T_0} \\cos\\left( \\frac{4\\pi}{T_0}\\,t \\right) dt = \\left[ \\frac{T_0}{4\\pi} \\sin\\left( \\frac{4\\pi}{T_0}\\,t \\right) \\right]_{0}^{T_0} = \\frac{T_0}{4\\pi} (\\sin(4\\pi) - \\sin(0)) = 0 $$\n    Thus, the total contribution is $5 \\times 86400 \\ \\mathrm{J\\,m^{-2}} = 432,000 \\ \\mathrm{J\\,m^{-2}}$.\n\nNow, we sum these contributions to find $\\Delta E_{\\mathrm{budget}}$:\n$$ \\Delta E_{\\mathrm{budget}} = (2,592,000 + 1,296,000 + 432,000) \\ \\mathrm{J\\,m^{-2}} = 4,320,000 \\ \\mathrm{J\\,m^{-2}} $$\nTo express this in $\\mathrm{MJ\\,m^{-2}}$, we divide by $10^6$:\n$$ \\Delta E_{\\mathrm{budget}} = 4.320 \\ \\mathrm{MJ\\,m^{-2}} $$\n\nFinally, we compute the budget residual, $R$, defined as the difference between the budget-implied change and the actual change, $R = \\Delta E_{\\mathrm{budget}} - \\Delta E_{\\mathrm{actual}}$.\nGiven $\\Delta E_{\\mathrm{actual}} = 4.295\\ \\mathrm{MJ\\,m^{-2}}$:\n$$ R = 4.320 \\ \\mathrm{MJ\\,m^{-2}} - 4.295 \\ \\mathrm{MJ\\,m^{-2}} = 0.025 \\ \\mathrm{MJ\\,m^{-2}} $$\nThe problem requires the final answer to be rounded to four significant figures. The number $0.025$ has two significant figures. To express it with four significant figures, we write it as $0.02500$. In standard scientific notation, this is $2.500 \\times 10^{-2}$.",
            "answer": "$$\\boxed{2.500 \\times 10^{-2}}$$"
        },
        {
            "introduction": "The exchange of energy at the Earth's surface is a critical process that governs the exchange of heat and moisture between the land and the atmosphere. In this practice , you will act as a micrometeorologist, using realistic data from a field experiment to compute the surface energy balance. This exercise provides a hands-on look at partitioning available net radiation into turbulent fluxes, ground heat, and various storage terms, confronting the common real-world problem of observational energy non-closure.",
            "id": "3869719",
            "problem": "A mixed deciduous forest site is instrumented during a midday period of length $\\Delta t = 1800 \\, \\text{s}$ (half-hour). A four-component net radiometer reports a half-hour mean net radiation $R_{n} = 540 \\, \\text{W m}^{-2}$. An eddy covariance (EC) system reports half-hour mean turbulent sensible heat flux $H = 170 \\, \\text{W m}^{-2}$ and latent heat flux $\\text{LE} = 320 \\, \\text{W m}^{-2}$. Two soil heat flux plates at depth $z = 0.05 \\, \\text{m}$ report a plate-average ground heat flux $G_{\\text{plate}} = 15 \\, \\text{W m}^{-2}$. The canopy air column extends to the EC measurement height $h = 30 \\, \\text{m}$ and warms over the half-hour by $\\Delta T_{\\text{air}} = 0.15 \\, \\text{K}$. The near-surface soil layer above the plates warms by $\\Delta T_{\\text{soil}} = 0.20 \\, \\text{K}$. The aboveground biomass warms by $\\Delta T_{b} = 0.10 \\, \\text{K}$. The following material properties are known: air density $\\rho = 1.2 \\, \\text{kg m}^{-3}$, dry-air specific heat at constant pressure $c_{p} = 1005 \\, \\text{J kg}^{-1} \\text{K}^{-1}$, soil volumetric heat capacity $C_{s} = 2.5 \\times 10^{6} \\, \\text{J m}^{-3} \\text{K}^{-1}$, aboveground biomass areal mass $m_{b} = 12 \\, \\text{kg m}^{-2}$, biomass specific heat $c_{b} = 2500 \\, \\text{J kg}^{-1} \\text{K}^{-1}$. Net Ecosystem Exchange (NEE) of carbon dioxide is reported as $\\text{NEE} = -8 \\, \\mu\\text{mol}\\,\\text{CO}_2\\,\\text{m}^{-2}\\,\\text{s}^{-1}$ (negative for net uptake), and the Gibbs free energy change per mole of carbon dioxide fixed in photosynthesis is $\\Delta G_{\\text{ph}} = 4.70 \\times 10^{5} \\, \\text{J mol}^{-1}$.\n\nStarting from conservation of energy for the landâ€“atmosphere control volume, compute the half-hour energy balance closure ratio $C$, defined as the ratio of the sum of measured and diagnostically estimated non-radiative energy exchange pathways to the measured net radiative input. The non-radiative pathways to include are the turbulent fluxes ($H$ and $\\text{LE}$), the corrected surface ground heat flux (plate flux plus storage in the soil layer above the plates), the canopy air heat storage, the biomass heat storage, and the chemical energy storage associated with net carbon uptake. Express the final closure ratio as a dimensionless decimal value and round your answer to four significant figures.\n\nAdditionally, use physically grounded arguments to assess plausible reasons for any remaining nonclosure in the observations, discussing at least two mechanisms and their potential order-of-magnitude impact on the energy balance during this half-hour period. (This assessment does not affect the required numerical answer but must be grounded in fundamental principles and well-tested facts.)",
            "solution": "The fundamental principle governing this problem is the conservation of energy for a control volume encompassing the forest ecosystem from a depth $z$ in the soil to the eddy covariance measurement height $h$ in the atmosphere. The surface energy balance equation states that the net radiative energy input, $R_n$, is balanced by the sum of turbulent fluxes of sensible heat ($H$) and latent heat ($\\text{LE}$), the ground heat flux at the surface ($G$), and the rate of energy storage within the control volume. The storage terms include heat storage in the canopy air column ($S_a$), in the aboveground biomass ($S_b$), and the energy converted to chemical potential energy via photosynthesis ($S_{ph}$).\n\nThe governing equation can be written as:\n$$R_n = H + \\text{LE} + G + S_a + S_b + S_{ph}$$\nAll terms are expressed as energy flux densities in units of $\\text{W m}^{-2}$. The problem requires the calculation of the energy balance closure ratio, $C$, defined as:\n$$C = \\frac{H + \\text{LE} + G + S_a + S_b + S_{ph}}{R_n}$$\nWe will calculate each of the non-radiative terms based on the provided data. The turbulent fluxes are given directly:\n$H = 170 \\, \\text{W m}^{-2}$\n$\\text{LE} = 320 \\, \\text{W m}^{-2}$\n\nThe surface ground heat flux, $G$, is the sum of the flux measured by the plate at depth $z$, $G_{\\text{plate}}$, and the rate of heat storage in the soil layer above the plate, $S_s$.\n$$G = G_{\\text{plate}} + S_s$$\nThe storage rate $S_s$ is calculated from the change in heat content of the soil layer over the time interval $\\Delta t$:\n$$S_s = \\frac{C_s \\cdot z \\cdot \\Delta T_{\\text{soil}}}{\\Delta t}$$\nSubstituting the given values:\n$$S_s = \\frac{(2.5 \\times 10^{6} \\, \\text{J m}^{-3} \\text{K}^{-1}) \\cdot (0.05 \\, \\text{m}) \\cdot (0.20 \\, \\text{K})}{1800 \\, \\text{s}} = \\frac{25000 \\, \\text{J m}^{-2}}{1800 \\, \\text{s}} = \\frac{125}{9} \\, \\text{W m}^{-2}$$\nThus, the total ground heat flux at the surface is:\n$$G = 15 \\, \\text{W m}^{-2} + \\frac{125}{9} \\, \\text{W m}^{-2} = \\frac{135}{9} \\, \\text{W m}^{-2} + \\frac{125}{9} \\, \\text{W m}^{-2} = \\frac{260}{9} \\, \\text{W m}^{-2}$$\n\nThe rate of heat storage in the canopy air column, $S_a$, is calculated from the energy required to warm the air column of height $h$:\n$$S_a = \\frac{\\rho \\cdot c_p \\cdot h \\cdot \\Delta T_{\\text{air}}}{\\Delta t}$$\nSubstituting the given values:\n$$S_a = \\frac{(1.2 \\, \\text{kg m}^{-3}) \\cdot (1005 \\, \\text{J kg}^{-1} \\text{K}^{-1}) \\cdot (30 \\, \\text{m}) \\cdot (0.15 \\, \\text{K})}{1800 \\, \\text{s}} = \\frac{5427 \\, \\text{J m}^{-2}}{1800 \\, \\text{s}} = 3.015 \\, \\text{W m}^{-2}$$\n\nThe rate of heat storage in the aboveground biomass, $S_b$, is calculated from the energy required to warm the biomass:\n$$S_b = \\frac{m_b \\cdot c_b \\cdot \\Delta T_b}{\\Delta t}$$\nSubstituting the given values:\n$$S_b = \\frac{(12 \\, \\text{kg m}^{-2}) \\cdot (2500 \\, \\text{J kg}^{-1} \\text{K}^{-1}) \\cdot (0.10 \\, \\text{K})}{1800 \\, \\text{s}} = \\frac{3000 \\, \\text{J m}^{-2}}{1800 \\, \\text{s}} = \\frac{5}{3} \\, \\text{W m}^{-2}$$\n\nThe rate of energy storage via photosynthesis, $S_{ph}$, is the product of the magnitude of the net ecosystem exchange of $\\text{CO}_2$ and the Gibbs free energy change per mole of $\\text{CO}_2$ fixed. The given $\\text{NEE}$ is negative, signifying uptake by the ecosystem, which represents a conversion of radiative energy to chemical energy.\nFirst, we convert $\\text{NEE}$ to standard units:\n$$\\text{NEE} = -8 \\, \\mu\\text{mol m}^{-2} \\text{s}^{-1} = -8 \\times 10^{-6} \\, \\text{mol m}^{-2} \\text{s}^{-1}$$\nThe rate of energy storage is then:\n$$S_{ph} = |\\text{NEE}| \\cdot \\Delta G_{\\text{ph}} = (8 \\times 10^{-6} \\, \\text{mol m}^{-2} \\text{s}^{-1}) \\cdot (4.70 \\times 10^{5} \\, \\text{J mol}^{-1}) = 3.76 \\, \\text{W m}^{-2}$$\n\nNow, we sum all the non-radiative energy flux terms:\n$$\\text{Sum} = H + \\text{LE} + G + S_a + S_b + S_{ph}$$\n$$\\text{Sum} = 170 + 320 + \\frac{260}{9} + 3.015 + \\frac{5}{3} + 3.76 \\, \\text{W m}^{-2}$$\nTo compute this precisely, we use fractions where appropriate: $\\frac{5}{3} = \\frac{15}{9}$.\n$$\\text{Sum} = 490 + \\frac{260}{9} + 3.015 + \\frac{15}{9} + 3.76 = 490 + \\frac{275}{9} + 6.775$$\n$$\\text{Sum} = 496.775 + \\frac{275}{9} \\approx 496.775 + 30.555... = 527.330555... \\, \\text{W m}^{-2}$$\n\nFinally, we compute the closure ratio, $C$, using the given net radiation $R_n = 540 \\, \\text{W m}^{-2}$:\n$$C = \\frac{\\text{Sum}}{R_n} = \\frac{527.330555... \\, \\text{W m}^{-2}}{540 \\, \\text{W m}^{-2}} \\approx 0.976538...$$\nRounding to four significant figures, the closure ratio is $0.9765$.\n\nThe energy imbalance, or non-closure, is $R_n - \\text{Sum} = 540 - 527.33 \\approx 12.67 \\, \\text{W m}^{-2}$. This remaining gap of approximately $2.3\\%$ of the available energy is a common feature in micrometeorological studies. Plausible reasons for this remaining non-closure include:\n\n1.  **Systematic Underestimation by Eddy Covariance (EC)**: The EC technique relies on capturing the covariance between vertical wind speed fluctuations and fluctuations in scalar quantities (like temperature for $H$ and water vapor for $\\text{LE}$). It is well-documented that standard EC processing, particularly with a $30$-minute averaging time, can fail to capture the full spectrum of turbulent transport. Low-frequency, large-scale eddies (secondary circulations) can contribute significantly to vertical transport but may be filtered out as \"mean flow\" over the averaging period. This leads to a systematic underestimation of $H$ and $\\text{LE}$. An underestimation of the true turbulent fluxes by just $(12.67 / 490) \\times 100\\% \\approx 2.6\\%$ would be sufficient to close the observed gap. Such an error is well within the typical range of $10-30\\%$ underestimation reported in the literature, making this the most likely contributor to the energy balance gap.\n\n2.  **Neglected Energy Storage Terms**: Our calculation included the primary storage terms, but other, smaller terms are often neglected. A significant one is the change in latent heat stored in the canopy air volume. As the air warms, its capacity to hold water vapor increases. If relative humidity remains roughly constant, the specific humidity $q$ will rise. The rate of latent heat storage, $S_q$, is given by $S_q = \\rho L_v h (\\Delta q / \\Delta t)$, where $L_v$ is the latent heat of vaporization ($\\approx 2.5 \\times 10^6 \\text{ J kg}^{-1}$). For the given conditions (e.g., at $T=25^\\circ\\text{C}$), a temperature rise of $\\Delta T_{\\text{air}} = 0.15 \\text{ K}$ could lead to an increase in specific humidity of approximately $\\Delta q \\approx 0.2 \\text{ g kg}^{-1}$ over the half hour. The corresponding storage term would be on the order of $S_q \\approx (1.2 \\cdot 2.5 \\times 10^6 \\cdot 30 \\cdot 0.0002) / 1800 \\approx 10 \\, \\text{W m}^{-2}$. This magnitude is comparable to the observed imbalance of $12.67 \\, \\text{W m}^{-2}$, demonstrating that neglecting this term can be a significant source of error and could account for a large portion of the residual.",
            "answer": "$$\\boxed{0.9765}$$"
        },
        {
            "introduction": "For an Earth system model to be physically realistic, its underlying numerical algorithms must strictly enforce fundamental conservation laws over long integration times. This coding challenge  guides you through the implementation of a conservative numerical scheme for energy transport using the Finite Volume Method on a staggered grid. You will demonstrate that by carefully constructing the discrete flux divergence, total energy in a periodic domain is conserved to machine precision, a property essential for the long-term stability and accuracy of climate simulations.",
            "id": "3869737",
            "problem": "Consider a two-dimensional periodic domain used in environmental and earth system modeling of a horizontally homogeneous layer, discretized into $N_x \\times N_y$ control volumes (cells). Let the cell-centered total energy be $E_{i,j}$ in joules ($\\mathrm{J}$), and the discrete energy flux field be defined on a staggered grid such that the $x$-component of flux at vertical faces is $F_x$ with entries $F_x\\left(i+\\tfrac{1}{2},j\\right)$ and the $y$-component of flux at horizontal faces is $F_y$ with entries $F_y\\left(i,j+\\tfrac{1}{2}\\right)$, each in joules per second ($\\mathrm{J}/\\mathrm{s}$). Assume strictly periodic boundary conditions in both directions, meaning $F_x\\left(N_x+\\tfrac{1}{2},j\\right)=F_x\\left(\\tfrac{1}{2},j\\right)$ and $F_y\\left(i,N_y+\\tfrac{1}{2}\\right)=F_y\\left(i,\\tfrac{1}{2}\\right)$ for all valid $i$ and $j$. The fundamental base for this problem is the local conservation of energy expressed by the conservation law $\\partial_t E + \\nabla \\cdot \\mathbf{F} = 0$, where $\\mathbf{F} = (F_x, F_y)$ is the energy flux vector.\n\nYour task is to:\n- Derive from the conservation law and the divergence theorem, using the Finite Volume Method (FVM), a discrete expression for the divergence of the flux that updates the cell-centered total energy $E_{i,j}$ over one explicit Euler time step of size $\\Delta t$ in seconds ($\\mathrm{s}$). Do not assume any source or sink terms inside the cell.\n- Implement this discrete update on a staggered grid so that the update is conservative under periodic boundaries to machine precision; that is, the domain-integrated energy $\\sum_{i=0}^{N_x-1}\\sum_{j=0}^{N_y-1} E_{i,j}$ remains invariant up to floating-point round-off.\n\nProgram requirements:\n- For each test case, initialize $E_{i,j}$ with strictly positive values in joules ($\\mathrm{J}$). Initialize a periodic staggered flux field $(F_x,F_y)$ either as a random periodic field or a smooth periodic field, explicitly enforcing the periodic wrap conditions $F_x\\left(N_x+\\tfrac{1}{2},j\\right)=F_x\\left(\\tfrac{1}{2},j\\right)$ and $F_y\\left(i,N_y+\\tfrac{1}{2}\\right)=F_y\\left(i,\\tfrac{1}{2}\\right)$.\n- Update $E_{i,j}$ over one explicit Euler step using the discrete divergence you derive.\n- Compute the relative change in domain-integrated energy, defined as the float\n$$r = \\frac{\\left|\\sum_{i,j} E_{i,j}^{\\,\\text{new}} - \\sum_{i,j} E_{i,j}^{\\,\\text{old}}\\right|}{\\left|\\sum_{i,j} E_{i,j}^{\\,\\text{old}}\\right|},$$\nwhich is unitless. This $r$ quantifies conservation to machine precision.\n\nAngle units are not applicable. All physical quantities should be in the specified units: energy in joules ($\\mathrm{J}$) and flux in joules per second ($\\mathrm{J}/\\mathrm{s}$). Time step $\\Delta t$ must be in seconds ($\\mathrm{s}$). The final outputs should be floats (decimals) as defined above.\n\nTest Suite:\n- Case $1$ (general case): $N_x=10$, $N_y=8$, $\\Delta t=0.5$ with a random periodic flux field constructed from a uniform distribution; use random seed $0$ and flux amplitude $A=10.0$.\n- Case $2$ (degenerate minimal grid): $N_x=1$, $N_y=1$, $\\Delta t=1.0$ with a random periodic flux field; use random seed $42$ and flux amplitude $A=100.0$.\n- Case $3$ (smooth periodic flux, anisotropic size): $N_x=64$, $N_y=16$, $\\Delta t=0.001$ with a smooth periodic flux field\n$$F_x\\left(i+\\tfrac{1}{2},j\\right) = A \\sin\\!\\left(2\\pi \\frac{i}{N_x}\\right)\\cos\\!\\left(2\\pi \\frac{j}{N_y}\\right), \\quad\nF_y\\left(i,j+\\tfrac{1}{2}\\right) = A \\cos\\!\\left(2\\pi \\frac{i}{N_x}\\right)\\sin\\!\\left(2\\pi \\frac{j}{N_y}\\right),$$\nusing amplitude $A=5.0$, explicitly enforcing periodic wraps $F_x\\left(N_x+\\tfrac{1}{2},j\\right)=F_x\\left(\\tfrac{1}{2},j\\right)$ and $F_y\\left(i,N_y+\\tfrac{1}{2}\\right)=F_y\\left(i,\\tfrac{1}{2}\\right)$.\n- Case $4$ (large time step stress test): $N_x=20$, $N_y=20$, $\\Delta t=10000.0$ with a random periodic flux field; use random seed $12345$ and flux amplitude $A=1000.0$.\n\nFinal Output Format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of the test cases $[r_1,r_2,r_3,r_4]$, where each $r_k$ is the float defined above for test case $k$.",
            "solution": "The problem requires the derivation and implementation of a conservative numerical scheme for the two-dimensional energy conservation law using the Finite Volume Method (FVM) on a periodic domain.\n\n### 1. Derivation of the Discrete Update Equation\n\nThe starting point is the differential form of the energy conservation law, which states that the time rate of change of energy density plus the divergence of the energy flux is zero:\n$$\n\\partial_t \\mathcal{E} + \\nabla \\cdot \\mathbf{F} = 0\n$$\nHere, $\\mathcal{E}$ is the energy per unit area (in $\\mathrm{J}/\\mathrm{m}^2$) and $\\mathbf{F} = (F_{\\text{density}, x}, F_{\\text{density}, y})$ is the energy flux vector (in $\\mathrm{W}/\\mathrm{m}$ or $\\mathrm{J}/\\mathrm{s} \\cdot \\mathrm{m}$).\n\nThe Finite Volume Method involves integrating this conservation law over a control volume, which in this case is a single grid cell indexed by $(i,j)$ with area $A_{i,j}$.\n$$\n\\int_{A_{i,j}} \\partial_t \\mathcal{E} \\,dA + \\int_{A_{i,j}} \\nabla \\cdot \\mathbf{F} \\,dA = 0\n$$\nLet $E_{i,j} = \\int_{A_{i,j}} \\mathcal{E} \\,dA$ be the total energy in the cell $(i,j)$, given in units of joules ($\\mathrm{J}$). The first term becomes the time derivative of the cell's total energy, $\\frac{dE_{i,j}}{dt}$.\n\nFor the second term, we apply the Divergence Theorem, which converts the area integral of the divergence into a line integral of the flux over the boundary of the cell, $\\partial A_{i,j}$:\n$$\n\\int_{A_{i,j}} \\nabla \\cdot \\mathbf{F} \\,dA = \\oint_{\\partial A_{i,j}} \\mathbf{F} \\cdot \\mathbf{n} \\,ds\n$$\nwhere $\\mathbf{n}$ is the outward-pointing normal vector. The line integral is the sum of the fluxes across the four faces of the cell (east, west, north, south).\n\nThe problem defines the discrete fluxes $F_x$ and $F_y$ as the total power passing through a cell face, in units of $\\mathrm{J}/\\mathrm{s}$. This means they are already integrated over the face lengths. Let's adopt the staggered grid notation where $F_x(i+\\tfrac{1}{2}, j)$ is the flux at the face between cells $(i,j)$ and $(i+1,j)$, and $F_y(i, j+\\tfrac{1}{2})$ is the flux at the face between cells $(i,j)$ and $(i,j+1)$. The outward flux from cell $(i,j)$ is then:\n$$\n\\oint_{\\partial A_{i,j}} \\mathbf{F} \\cdot \\mathbf{n} \\,ds = F_x(i+\\tfrac{1}{2}, j) - F_x(i-\\tfrac{1}{2}, j) + F_y(i, j+\\tfrac{1}{2}) - F_y(i, j-\\tfrac{1}{2})\n$$\nwhere positive values correspond to flux in the positive coordinate directions. $F_x(i+\\tfrac{1}{2}, j)$ is the flux out of the east face, and $-F_x(i-\\tfrac{1}{2}, j)$ is the flux out of the west face (which is an influx of $F_x(i-\\tfrac{1}{2}, j)$).\n\nSubstituting these terms back into the integrated conservation law gives the semi-discrete equation for the energy in cell $(i,j)$:\n$$\n\\frac{dE_{i,j}}{dt} + \\left[ \\left( F_x(i+\\tfrac{1}{2}, j) - F_x(i-\\tfrac{1}{2}, j) \\right) + \\left( F_y(i, j+\\tfrac{1}{2}) - F_y(i, j-\\tfrac{1}{2}) \\right) \\right] = 0\n$$\nThe term in the square brackets represents the discrete divergence of the flux out of cell $(i,j)$.\n\nTo obtain a fully discrete scheme, we discretize the time derivative using an explicit Euler forward step of size $\\Delta t$:\n$$\n\\frac{E_{i,j}^{\\text{new}} - E_{i,j}^{\\text{old}}}{\\Delta t} = - \\left[ \\left( F_x(i+\\tfrac{1}{2}, j) - F_x(i-\\tfrac{1}{2}, j) \\right) + \\left( F_y(i, j+\\tfrac{1}{2}) - F_y(i, j-\\tfrac{1}{2}) \\right) \\right]\n$$\nRearranging for the updated energy $E_{i,j}^{\\text{new}}$, we get the final update equation:\n$$\nE_{i,j}^{\\text{new}} = E_{i,j}^{\\text{old}} - \\Delta t \\left[ \\left( F_x(i+\\tfrac{1}{2}, j) - F_x(i-\\tfrac{1}{2}, j) \\right) + \\left( F_y(i, j+\\tfrac{1}{2}) - F_y(i, j-\\tfrac{1}{2}) \\right) \\right]\n$$\n\n### 2. Proof of Conservation on a Periodic Domain\n\nThe scheme is conservative if the total energy integrated over the entire domain, $\\sum_{j=0}^{N_y-1} \\sum_{i=0}^{N_x-1} E_{i,j}$, remains constant over time. Let's sum the update equation over all cells:\n$$\n\\sum_{j=0}^{N_y-1} \\sum_{i=0}^{N_x-1} E_{i,j}^{\\text{new}} = \\sum_{j=0}^{N_y-1} \\sum_{i=0}^{N_x-1} E_{i,j}^{\\text{old}} - \\Delta t \\sum_{j=0}^{N_y-1} \\sum_{i=0}^{N_x-1} \\left[ \\left( F_x(i+\\tfrac{1}{2}, j) - F_x(i-\\tfrac{1}{2}, j) \\right) + \\left( F_y(i, j+\\tfrac{1}{2}) - F_y(i, j-\\tfrac{1}{2}) \\right) \\right]\n$$\nTo prove conservation, we must show that the final term, the sum of all discrete divergences, is zero. Let's analyze the sum of the $x$-flux differences first:\n$$\n\\sum_{j=0}^{N_y-1} \\sum_{i=0}^{N_x-1} \\left( F_x(i+\\tfrac{1}{2}, j) - F_x(i-\\tfrac{1}{2}, j) \\right)\n$$\nFor each row $j$, the inner sum over $i$ is a telescoping series:\n$$\n\\sum_{i=0}^{N_x-1} \\left( F_x(i+\\tfrac{1}{2}, j) - F_x(i-\\tfrac{1}{2}, j) \\right) = \\left( F_x(\\tfrac{3}{2},j) - F_x(\\tfrac{1}{2},j) \\right) + \\dots + \\left( F_x(N_x+\\tfrac{1}{2},j) - F_x(N_x-\\tfrac{1}{2},j) \\right)\n$$\nThis sum simplifies to $F_x(N_x+\\tfrac{1}{2}, j) - F_x(\\tfrac{1}{2}, j)$. The problem specifies periodic boundary conditions, $F_x(N_x+\\tfrac{1}{2}, j) = F_x(\\tfrac{1}{2}, j)$. Thus, for each $j$, the sum is zero. The total sum over all $j$ is therefore also zero.\n\nSimilarly, for the $y$-flux differences:\n$$\n\\sum_{i=0}^{N_x-1} \\sum_{j=0}^{N_y-1} \\left( F_y(i, j+\\tfrac{1}{2}) - F_y(i, j-\\tfrac{1}{2}) \\right)\n$$\nFor each column $i$, the inner sum over $j$ is a telescoping series that simplifies to $F_y(i, N_y+\\tfrac{1}{2}) - F_y(i, \\tfrac{1}{2})$. The periodic boundary condition $F_y(i, N_y+\\tfrac{1}{2}) = F_y(i, \\tfrac{1}{2})$ makes this sum zero for each $i$. The total sum over all $i$ is therefore zero.\n\nSince both sums of flux differences are zero, the total change in domain-integrated energy is zero:\n$$\n\\sum_{i,j} E_{i,j}^{\\text{new}} = \\sum_{i,j} E_{i,j}^{\\text{old}} - \\Delta t \\cdot (0 + 0) = \\sum_{i,j} E_{i,j}^{\\text{old}}\n$$\nThis proves that the numerical scheme is exactly conservative. In a floating-point implementation, the conservation will hold up to machine precision.\n\n### 3. Implementation Strategy\n\nWe will use `numpy` for efficient array operations.\n- The cell-centered energy $E_{i,j}$ will be stored in a `numpy` array `E` of shape `(Ny, Nx)`.\n- The staggered fluxes $F_x(i+\\tfrac{1}{2}, j)$ and $F_y(i, j+\\tfrac{1}{2})$ will be stored in arrays `Fx` and `Fy`, both of shape `(Ny, Nx)`. Here, `Fx[j, i]` corresponds to $F_x(i+\\tfrac{1}{2}, j)$ (flux on the right face of cell $(i,j)$), and `Fy[j, i]` corresponds to $F_y(i, j+\\tfrac{1}{2})$ (flux on the top face of cell $(i,j)$).\n- The flux difference terms, like $F_x(i+\\tfrac{1}{2}, j) - F_x(i-\\tfrac{1}{2}, j)$, can be computed for all cells simultaneously using vectorization. The flux on the left face of cell $(i,j)$, $F_x(i-\\tfrac{1}{2}, j)$, is the same as the flux on the right face of cell $(i-1,j)$. Due to periodicity, for cell $(0,j)$, the left face flux is the right face flux of cell $(N_x-1, j)$. This operation corresponds to a circular shift.\n- The `numpy.roll()` function is ideal for this. The term $F_x(i-\\tfrac{1}{2}, j)$ for all `i` is represented by `np.roll(Fx, 1, axis=1)`. Similarly, $F_y(i, j-\\tfrac{1}{2})$ is represented by `np.roll(Fy, 1, axis=0)`.\n- The discrete divergence for all cells can thus be computed in a single vectorized expression: `div_F = (Fx - np.roll(Fx, 1, axis=1)) + (Fy - np.roll(Fy, 1, axis=0))`.\n- The energy update for all cells is then `E_new = E_old - dt * div_F`.\nThe relative change in total energy, $r$, is calculated to verify numerical conservation.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n    \n    test_cases = [\n        # Case 1: General case\n        {'Nx': 10, 'Ny': 8, 'dt': 0.5, 'flux_type': 'random', 'A': 10.0, 'seed': 0},\n        # Case 2: Degenerate minimal grid\n        {'Nx': 1, 'Ny': 1, 'dt': 1.0, 'flux_type': 'random', 'A': 100.0, 'seed': 42},\n        # Case 3: Smooth periodic flux, anisotropic size\n        {'Nx': 64, 'Ny': 16, 'dt': 0.001, 'flux_type': 'smooth', 'A': 5.0, 'seed': None},\n        # Case 4: Large time step stress test\n        {'Nx': 20, 'Ny': 20, 'dt': 10000.0, 'flux_type': 'random', 'A': 1000.0, 'seed': 12345},\n    ]\n\n    results = []\n    for case in test_cases:\n        r = compute_conservation_error(**case)\n        results.append(r)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef compute_conservation_error(Nx, Ny, dt, flux_type, A, seed):\n    \"\"\"\n    Computes the relative change in domain-integrated energy for one test case.\n\n    Args:\n        Nx (int): Number of cells in the x-direction.\n        Ny (int): Number of cells in the y-direction.\n        dt (float): Time step size in seconds.\n        flux_type (str): Type of flux field ('random' or 'smooth').\n        A (float): Amplitude of the flux field.\n        seed (int or None): Seed for the random number generator.\n\n    Returns:\n        float: The relative change in domain-integrated energy, r.\n    \"\"\"\n    \n    # Initialize cell-centered energy E with strictly positive values.\n    # Using np.ones is simple and sufficient.\n    E_old = np.ones((Ny, Nx), dtype=np.float64)\n    \n    # Generate the periodic staggered flux fields Fx and Fy.\n    # Fx[j, i] corresponds to F_x(i+1/2, j)\n    # Fy[j, i] corresponds to F_y(i, j+1/2)\n    if flux_type == 'random':\n        rng = np.random.default_rng(seed)\n        # Uniform distribution in [-A, A]\n        Fx = A * (2 * rng.random((Ny, Nx), dtype=np.float64) - 1)\n        Fy = A * (2 * rng.random((Ny, Nx), dtype=np.float64) - 1)\n    elif flux_type == 'smooth':\n        i = np.arange(Nx, dtype=np.float64)\n        j = np.arange(Ny, dtype=np.float64)\n        ii, jj = np.meshgrid(i, j)\n        \n        Fx = A * np.sin(2 * np.pi * ii / Nx) * np.cos(2 * np.pi * jj / Ny)\n        Fy = A * np.cos(2 * np.pi * ii / Nx) * np.sin(2 * np.pi * jj / Ny)\n        \n    else:\n        raise ValueError(f\"Unknown flux_type: {flux_type}\")\n\n    # Calculate the discrete divergence of the flux field.\n    # The term Fx(i-1/2, j) for cell (i,j) corresponds to the flux at the\n    # right face of cell (i-1,j), which is Fx[j, i-1] in our array.\n    # np.roll handles the periodicity correctly.\n    Fx_left = np.roll(Fx, 1, axis=1)\n    Fy_bottom = np.roll(Fy, 1, axis=0)\n    \n    div_F = (Fx - Fx_left) + (Fy - Fy_bottom)\n    \n    # Update the energy field using one explicit Euler step.\n    E_new = E_old - dt * div_F\n    \n    # Compute the total domain-integrated energy before and after the update.\n    E_total_old = np.sum(E_old)\n    E_total_new = np.sum(E_new)\n    \n    # Calculate the relative change in total energy.\n    # The denominator should be non-zero as E is initialized with positive values.\n    if E_total_old == 0:\n        if E_total_new == 0:\n            return 0.0\n        else:\n            return np.inf\n\n    r = np.abs(E_total_new - E_total_old) / np.abs(E_total_old)\n    \n    return r\n\nsolve()\n```"
        }
    ]
}