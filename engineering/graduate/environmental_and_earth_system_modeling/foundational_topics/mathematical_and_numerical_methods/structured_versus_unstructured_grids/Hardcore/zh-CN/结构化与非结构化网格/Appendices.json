{
    "hands_on_practices": [
        {
            "introduction": "数值模型的精度在很大程度上取决于其计算网格的质量。对于非结构网格，其几何灵活性是巨大优势，但也可能引入计算误差。本练习将引导你完成一个基础推导，以理解非结构网格中的非正交性（即偏斜）如何为扩散通量的计算引入误差 ()。这个练习有助于建立对几何灵活性与数值精度之间权衡的核心理解。",
            "id": "3918644",
            "problem": "考虑一个用于环境和地球系统建模的二维非结构化有限体积离散化。单个平面多边形单元由 $m \\geq 3$ 个顶点 $\\mathbf{x}_0, \\mathbf{x}_1, \\dots, \\mathbf{x}_{m-1} \\in \\mathbb{R}^2$ 定义，这些顶点围绕单元按逆时针顺序排列。对于连接连续顶点 $\\mathbf{x}_i$ 到 $\\mathbf{x}_{i+1}$（索引算术以 $m$ 为模）的每个面 $f_i$，定义边向量 $\\mathbf{e}_i = \\mathbf{x}_{i+1} - \\mathbf{x}_i$，面长度 $s_i = \\|\\mathbf{e}_i\\|$，单位切向量 $\\mathbf{t}_i = \\mathbf{e}_i / \\|\\mathbf{e}_i\\|$，以及外向单位法向量 $\\mathbf{n}_i = R_{\\mathrm{cw}} \\mathbf{t}_i$，其中 $R_{\\mathrm{cw}} = \\begin{pmatrix}0  1 \\\\ -1  0\\end{pmatrix}$ 表示顺时针旋转 $90^{\\circ}$。\n\n一个标量场 $\\phi(x,y)$ 由稳态扩散控制，其各向同性扩散系数 $K > 0$ 为常数且无源项。扩散通量密度由菲克定律定义为 $-K \\nabla \\phi$，当 $\\nabla \\phi$ 为常数时，穿过长度为 $s_f$、单位法向量为 $\\mathbf{n}_f$ 的平直面 $f$ 的精确积分扩散通量为 $F_{\\mathrm{exact}} = -K\\, s_f\\, \\nabla \\phi \\cdot \\mathbf{n}_f$。\n\n在两个质心分别为 $\\mathbf{x}_P$ 和 $\\mathbf{x}_N$ 的相邻多边形单元之间，考虑一个共享面 $f$，其单位法向量 $\\mathbf{n}_f$ 从单元 $P$ 指向单元 $N$，单位切向量 $\\mathbf{t}_f$ 与单元 $P$ 的逆时针排序一致。定义中心到中心的向量 $\\mathbf{r} = \\mathbf{x}_N - \\mathbf{x}_P$，以及 $\\mathbf{r}$ 与 $\\mathbf{n}_f$ 之间的有符号偏斜角 $\\theta$，由 $\\cos(\\theta) = \\dfrac{\\mathbf{r} \\cdot \\mathbf{n}_f}{\\|\\mathbf{r}\\|}$，$\\sin(\\theta) = \\dfrac{\\mathbf{r} \\cdot \\mathbf{t}_f}{\\|\\mathbf{r}\\|}$ 定义，其中 $\\theta = 0$ 对应于正交结构化配置。\n\n在两点通量近似 (TPFA) 中，穿过 $f$ 的扩散通量近似为\n$$\nF_{\\mathrm{TPFA}} = -K\\, s_f\\, \\frac{\\phi_N - \\phi_P}{\\mathbf{r} \\cdot \\mathbf{n}_f},\n$$\n其中 $\\phi_P = \\phi(\\mathbf{x}_P)$ 且 $\\phi_N = \\phi(\\mathbf{x}_N)$。假设 $\\nabla \\phi$ 是常数且面是平面的，因此上述精确通量表达式适用，并且多边形的顶点满足所述的定向。\n\n任务：\n- 仅使用顶点坐标 $\\{\\mathbf{x}_i\\}_{i=0}^{m-1}$，为每个面 $f_i$ 表达 $s_i$、$\\mathbf{t}_i$ 和 $\\mathbf{n}_i$。此外，用 $\\{\\mathbf{x}_i\\}$ 表示单元面积 $A$。\n- 从提供的基本定义出发，推导由偏斜引起的通量误差 $E = F_{\\mathrm{TPFA}} - F_{\\mathrm{exact}}$ 的表达式，用 $K$、 $s_f$、$\\theta$ 以及 $\\nabla \\phi$ 在 $\\mathbf{n}_f$ 和 $\\mathbf{t}_f$ 上的投影表示。将表达式简化为一个能够分离出对偏斜角 $\\theta$ 依赖性的封闭形式。\n- 以 $K$、 $s_f$、$\\theta$ 和 $\\nabla \\phi$ 沿 $\\mathbf{t}_f$ 的切向分量为变量，用单个封闭形式的解析表达式陈述由偏斜引起的误差大小 $|E|$。\n\n你的最终答案必须是 $|E|$ 的单一解析表达式。不需要进行数值四舍五入，最终的方框表达式中也不应包含任何单位。推导过程必须仅依赖于上述核心定义和经过验证的公式，并且对于一般的多边形非结构化网格在科学上是现实的。不要提供超出规定范围的快捷公式。",
            "solution": "问题陈述已经过分析，并被确定为有效。它在科学上基于输运现象数值方法（特别是有限体积法）的原理。该问题是适定的，所有必要的定义、变量和约束都已提供，足以推导出所要求的量。术语精确客观，其设置在分析数值离散误差的背景下是内部一致且物理上现实的。\n\n我们按要求进行推导。\n\n该问题分为三个任务。我们将按顺序解决它们。\n\n任务1：用顶点坐标表示几何量。\n设多边形单元的顶点由其坐标向量 $\\mathbf{x}_i = (x_i, y_i)$ 给出，其中 $i=0, 1, \\dots, m-1$。索引按模 $m$ 计算。\n\n连接顶点 $\\mathbf{x}_i$ 到 $\\mathbf{x}_{i+1}$ 的面 $f_i$ 的边向量定义为：\n$$\n\\mathbf{e}_i = \\mathbf{x}_{i+1} - \\mathbf{x}_i = (x_{i+1} - x_i)\\mathbf{\\hat{i}} + (y_{i+1} - y_i)\\mathbf{\\hat{j}}\n$$\n\n面 $f_i$ 的长度，记为 $s_i$，是边向量 $\\mathbf{e}_i$ 的欧几里得范数：\n$$\ns_i = \\|\\mathbf{e}_i\\| = \\sqrt{(x_{i+1} - x_i)^2 + (y_{i+1} - y_i)^2}\n$$\n\n单位切向量 $\\mathbf{t}_i$ 是由其长度归一化的边向量：\n$$\n\\mathbf{t}_i = \\frac{\\mathbf{e}_i}{\\|\\mathbf{e}_i\\|} = \\frac{1}{s_i} ((x_{i+1} - x_i)\\mathbf{\\hat{i}} + (y_{i+1} - y_i)\\mathbf{\\hat{j}})\n$$\n\n外向单位法向量 $\\mathbf{n}_i$ 是通过将单位切向量 $\\mathbf{t}_i$ 顺时针旋转 $90^{\\circ}$ 得到的。旋转矩阵给出为 $R_{\\mathrm{cw}} = \\begin{pmatrix}0  1 \\\\ -1  0\\end{pmatrix}$。将此应用于 $\\mathbf{t}_i = (t_{ix}, t_{iy})$ 的分量，得到 $\\mathbf{n}_i = (t_{iy}, -t_{ix})$。代入 $\\mathbf{t}_i$ 的分量：\n$$\n\\mathbf{n}_i = \\frac{1}{s_i} ((y_{i+1} - y_i)\\mathbf{\\hat{i}} - (x_{i+1} - x_i)\\mathbf{\\hat{j}})\n$$\n这个方向确实是向外的，因为顶点是按逆时针顺序排列的。\n\n平面多边形的面积 $A$ 可以使用鞋带公式（也称为测量师公式）计算，该公式源于格林定理。由于顶点是逆时针排序的，有符号面积为正：\n$$\nA = \\frac{1}{2} \\sum_{i=0}^{m-1} (x_i y_{i+1} - x_{i+1} y_i)\n$$\n\n任务2：推导由偏斜引起的通量误差 $E = F_{\\mathrm{TPFA}} - F_{\\mathrm{exact}}$。\n我们已知两点通量近似和精确通量的表达式：\n$$\nF_{\\mathrm{TPFA}} = -K\\, s_f\\, \\frac{\\phi_N - \\phi_P}{\\mathbf{r} \\cdot \\mathbf{n}_f}\n$$\n$$\nF_{\\mathrm{exact}} = -K\\, s_f\\, (\\nabla \\phi \\cdot \\mathbf{n}_f)\n$$\n问题陈述指出标量场的梯度 $\\nabla \\phi$ 是恒定的。这使我们能够使用一阶泰勒展开精确地关联点 $\\mathbf{x}_P$ 和 $\\mathbf{x}_N$ 处的 $\\phi$ 值：\n$$\n\\phi(\\mathbf{x}_N) = \\phi(\\mathbf{x}_P) + \\nabla \\phi \\cdot (\\mathbf{x}_N - \\mathbf{x}_P)\n$$\n记 $\\phi_N = \\phi(\\mathbf{x}_N)$，$\\phi_P = \\phi(\\mathbf{x}_P)$，以及 $\\mathbf{r} = \\mathbf{x}_N - \\mathbf{x}_P$，我们有：\n$$\n\\phi_N - \\phi_P = \\nabla \\phi \\cdot \\mathbf{r}\n$$\n将此精确关系代入 $F_{\\mathrm{TPFA}}$ 的表达式中：\n$$\nF_{\\mathrm{TPFA}} = -K\\, s_f\\, \\frac{\\nabla \\phi \\cdot \\mathbf{r}}{\\mathbf{r} \\cdot \\mathbf{n}_f}\n$$\n现在我们通过减去精确通量来计算误差 $E$：\n$$\nE = F_{\\mathrm{TPFA}} - F_{\\mathrm{exact}} = \\left(-K\\, s_f\\, \\frac{\\nabla \\phi \\cdot \\mathbf{r}}{\\mathbf{r} \\cdot \\mathbf{n}_f}\\right) - \\left(-K\\, s_f\\, (\\nabla \\phi \\cdot \\mathbf{n}_f)\\right)\n$$\n提出公因式 $-K s_f$：\n$$\nE = -K\\, s_f \\left( \\frac{\\nabla \\phi \\cdot \\mathbf{r}}{\\mathbf{r} \\cdot \\mathbf{n}_f} - \\nabla \\phi \\cdot \\mathbf{n}_f \\right)\n$$\n为了简化，我们将两项置于一个共同的分母上：\n$$\nE = -K\\, s_f \\left( \\frac{(\\nabla \\phi \\cdot \\mathbf{r}) - (\\nabla \\phi \\cdot \\mathbf{n}_f)(\\mathbf{r} \\cdot \\mathbf{n}_f)}{\\mathbf{r} \\cdot \\mathbf{n}_f} \\right)\n$$\n为了分析分子，我们在由面法向量 $\\mathbf{n}_f$ 和面切向量 $\\mathbf{t}_f$ 定义的正交基中分解向量 $\\mathbf{r}$ 和 $\\nabla \\phi$。\n向量 $\\nabla \\phi$ 分解为：\n$$\n\\nabla \\phi = (\\nabla \\phi \\cdot \\mathbf{n}_f) \\mathbf{n}_f + (\\nabla \\phi \\cdot \\mathbf{t}_f) \\mathbf{t}_f\n$$\n向量 $\\mathbf{r}$ 使用给定的偏斜角 $\\theta$ 定义进行分解：\n$$\n\\cos(\\theta) = \\frac{\\mathbf{r} \\cdot \\mathbf{n}_f}{\\|\\mathbf{r}\\|} \\quad \\text{和} \\quad \\sin(\\theta) = \\frac{\\mathbf{r} \\cdot \\mathbf{t}_f}{\\|\\mathbf{r}\\|}\n$$\n这意味着 $\\mathbf{r} \\cdot \\mathbf{n}_f = \\|\\mathbf{r}\\| \\cos(\\theta)$ 且 $\\mathbf{r} \\cdot \\mathbf{t}_f = \\|\\mathbf{r}\\| \\sin(\\theta)$。因此，$\\mathbf{r}$ 的分解是：\n$$\n\\mathbf{r} = (\\mathbf{r} \\cdot \\mathbf{n}_f) \\mathbf{n}_f + (\\mathbf{r} \\cdot \\mathbf{t}_f) \\mathbf{t}_f = \\|\\mathbf{r}\\| \\cos(\\theta) \\mathbf{n}_f + \\|\\mathbf{r}\\| \\sin(\\theta) \\mathbf{t}_f\n$$\n现在我们使用这些分解来计算点积 $\\nabla \\phi \\cdot \\mathbf{r}$：\n$$\n\\nabla \\phi \\cdot \\mathbf{r} = \\left( (\\nabla \\phi \\cdot \\mathbf{n}_f) \\mathbf{n}_f + (\\nabla \\phi \\cdot \\mathbf{t}_f) \\mathbf{t}_f \\right) \\cdot \\left( \\|\\mathbf{r}\\| \\cos(\\theta) \\mathbf{n}_f + \\|\\mathbf{r}\\| \\sin(\\theta) \\mathbf{t}_f \\right)\n$$\n利用基的正交性（$\\mathbf{n}_f \\cdot \\mathbf{n}_f = 1$，$\\mathbf{t}_f \\cdot \\mathbf{t}_f = 1$，$\\mathbf{n}_f \\cdot \\mathbf{t}_f = 0$）：\n$$\n\\nabla \\phi \\cdot \\mathbf{r} = (\\nabla \\phi \\cdot \\mathbf{n}_f) (\\|\\mathbf{r}\\| \\cos(\\theta)) + (\\nabla \\phi \\cdot \\mathbf{t}_f) (\\|\\mathbf{r}\\| \\sin(\\theta))\n$$\n将此代入 $E$ 表达式的分子中：\n$$\n\\text{分子} = [(\\nabla \\phi \\cdot \\mathbf{n}_f) (\\|\\mathbf{r}\\| \\cos(\\theta)) + (\\nabla \\phi \\cdot \\mathbf{t}_f) (\\|\\mathbf{r}\\| \\sin(\\theta))] - (\\nabla \\phi \\cdot \\mathbf{n}_f)(\\|\\mathbf{r}\\| \\cos(\\theta))\n$$\n第一项和最后一项相消，剩下：\n$$\n\\text{分子} = (\\nabla \\phi \\cdot \\mathbf{t}_f) (\\|\\mathbf{r}\\| \\sin(\\theta))\n$$\n$E$ 表达式的分母是 $\\mathbf{r} \\cdot \\mathbf{n}_f = \\|\\mathbf{r}\\| \\cos(\\theta)$。\n将简化的分子和分母代回 $E$ 的表达式中：\n$$\nE = -K\\, s_f \\left( \\frac{(\\nabla \\phi \\cdot \\mathbf{t}_f) (\\|\\mathbf{r}\\| \\sin(\\theta))}{\\|\\mathbf{r}\\| \\cos(\\theta)} \\right)\n$$\n假设 $\\theta \\neq \\pm \\frac{\\pi}{2}$ (即 $\\cos(\\theta) \\neq 0$)，$\\|\\mathbf{r}\\|$ 项相消，我们可以用正切函数替换正弦和余弦的比值：\n$$\nE = -K\\, s_f (\\nabla \\phi \\cdot \\mathbf{t}_f) \\tan(\\theta)\n$$\n这个表达式在 $\\tan(\\theta)$ 项中分离出了对偏斜角 $\\theta$ 的依赖性。如果网格是正交的 ($\\theta=0$) 或者梯度垂直于面 ($\\nabla \\phi \\cdot \\mathbf{t}_f=0$)，则误差为零。\n\n任务3：陈述由偏斜引起的误差的大小 $|E|$。\n误差的大小是为 $E$ 推导出的表达式的绝对值：\n$$\n|E| = |-K\\, s_f (\\nabla \\phi \\cdot \\mathbf{t}_f) \\tan(\\theta)|\n$$\n由于 $K > 0$ 且面长度 $s_f$ 是一个正量，我们可以将它们从绝对值中取出：\n$$\n|E| = K\\, s_f |(\\nabla \\phi \\cdot \\mathbf{t}_f) \\tan(\\theta)|\n$$\n这里，$(\\nabla \\phi \\cdot \\mathbf{t}_f)$ 是 $\\nabla \\phi$ 沿单位向量 $\\mathbf{t}_f$ 的切向分量的标量值。该表达式是所要求的单一封闭形式的解析表达式。",
            "answer": "$$\n\\boxed{K s_f |(\\nabla \\phi \\cdot \\mathbf{t}_f) \\tan(\\theta)|}\n$$"
        },
        {
            "introduction": "在通量计算的基础上，本练习将构建一个完整的离散算子——散度算子。我们将基于高斯散度定理，实现一个关键的验证测试，以确保我们构造的算子在结构化和非结构化网格上对于常数场都是“精确的” ()。这个动手编程练习展示了任何有效的有限体积方法都必须满足的基本几何守恒律。",
            "id": "3918705",
            "problem": "您的任务是设计并实现一个基于第一性原理的验证测试，以确认在环境与地球系统建模中常用的结构化和非结构化网格上，常数无散速度场在离散散度算子下能够被精确保持。设计必须从散度定理出发，推导出一个与有限体积法 (FVM) 一致的、基于控制体的离散散度。您的程序必须计算量化偏离零散度的残差，并对多个测试案例的这些残差进行汇总。\n\n基本原理：\n- 散度定理（高斯定理）指出，对于一个足够光滑的向量场 $\\mathbf{u}(\\mathbf{x})$ 和一个封闭的控制体 $V$（其边界为 $\\partial V$，外向单位法向量为 $\\mathbf{n}$），\n$$\n\\int_V \\nabla \\cdot \\mathbf{u} \\, dV = \\int_{\\partial V} \\mathbf{u} \\cdot \\mathbf{n} \\, dS.\n$$\n- 有限体积法 (FVM) 通过将边界积分近似为面通量的总和来离散化散度。对于体积为 $|V_c|$、面由索引 $f$ 标记、面积为 $|S_f|$ 的单个控制体（单元）$c$，离散散度由通量平衡导出：\n$$\n\\left(\\nabla \\cdot \\mathbf{u}\\right)_c \\approx \\frac{1}{|V_c|} \\sum_{f \\in \\partial c} \\left( \\mathbf{u}_f \\cdot \\mathbf{n}_f \\right) |S_f|.\n$$\n- 一个常数速度场 $\\mathbf{u}(\\mathbf{x}) = \\mathbf{u}_0$ 在连续设定下有 $\\nabla \\cdot \\mathbf{u} = 0$，并且通过任何封闭曲面的精确通量必须为零，因为封闭曲面上的外向面积向量之和（或二维中封闭多边形上的外向法向长度向量之和）为零。\n\n您的任务：\n1. 对于二维结构化笛卡尔网格，定义宽度为 $dx$、高度为 $dy$ 的单元，其面与坐标轴对齐。使用 FVM 控制体通量平衡和面的精确几何形状，为常数速度 $\\mathbf{u}_0 = (u_x, u_y)$ 计算每个单元的离散散度，并在每个面上使用外向法线方向。计算定义为所有单元上离散散度绝对值的最大值的残差。当速度单位为 $\\mathrm{m/s}$、长度单位为 $\\mathrm{m}$ 时，散度的单位为 $\\mathrm{s}^{-1}$。以 $\\mathrm{s}^{-1}$ 为单位报告残差。\n2. 对于二维非结构化多边形网格，通过其顶点 $(x_i, y_i)$（单位为 $\\mathrm{m}$）将每个单元定义为一个简单多边形，顶点按顺序形成一个闭环（如果需要，您的程序必须确保逆时针排序）。使用鞋带公式计算多边形面积 $|V_c|$，并通过将边向量旋转 $-90^\\circ$ 来计算沿每条边的外向单位法向量 $\\mathbf{n}_f$，以获得逆时针方向的外向法线。使用 FVM 通量平衡计算常数速度 $\\mathbf{u}_0 = (u_x, u_y)$ 的离散散度，并像结构化情况一样计算相应的残差。以 $\\mathrm{s}^{-1}$ 为单位报告残差。\n\n约束与期望：\n- 仅使用面和单元体积的精确几何量；由于 $\\mathbf{u}$ 是常数，不要对面上的通量引入数值积分。\n- 计算必须是每个单元局部的，不得依赖于边界条件或虚拟单元，因为通量平衡是在封闭控制体上计算的。\n- 残差应极度接近于零，任何非零值仅可归因于浮点舍入。\n\n测试套件：\n提供并计算以下五个测试案例的残差。所有距离单位为 $\\mathrm{m}$，速度单位为 $\\mathrm{m/s}$，残差以 $\\mathrm{s}^{-1}$ 报告。\n\n- 测试案例 1 (结构化，一般情况)：\n  - 网格：$N_x = 10$，$N_y = 8$，$dx = 3700$，$dy = 2100$。\n  - 恒定速度：$\\mathbf{u}_0 = (3.2, -5.4)$。\n- 测试案例 2 (结构化，边界大小的单单元)：\n  - 网格：$N_x = 1$，$N_y = 1$，$dx = 0.001$，$dy = 0.001$。\n  - 恒定速度：$\\mathbf{u}_0 = (123.456, -654.321)$。\n- 测试案例 3 (结构化，具有类无理数分量的各向异性单元尺寸)：\n  - 网格：$N_x = 45$，$N_y = 60$，$dx = 1.0$，$dy = 1000.0$。\n  - 恒定速度：$\\mathbf{u}_0 = (1.41421356237, 3.14159265359)$。\n- 测试案例 4 (非结构化，三角形)：\n  - 多边形 (每个单元是一个三角形，顶点以逆时针顺序指定，单位为 $\\mathrm{m}$):\n    - 三角形 1: $(0, 0)$，$(2, 0)$，$(0, 1)$。\n    - 三角形 2: $(1, 1)$，$(3, 1)$，$(2, 3)$。\n    - 三角形 3: $(5, 0)$，$(6, 2)$，$(4, 2)$。\n  - 恒定速度：$\\mathbf{u}_0 = (1.41421356237, 3.14159265359)$。\n- 测试案例 5 (非结构化，高度倾斜的四边形以探测数值稳健性)：\n  - 多边形 (每个单元是一个四边形，顶点单位为 $\\mathrm{m}$):\n    - 四边形 1: $(0, 0)$，$(10, 0.1)$，$(10.2, 50)$，$(0, 49.9)$。\n    - 四边形 2: $(20, 0)$，$(30, 0.05)$，$(30.05, 100)$，$(20, 99.95)$。\n  - 恒定速度：$\\mathbf{u}_0 = (3.2, -5.4)$。\n\n最终输出格式：\n您的程序应生成一行输出，其中包含五个测试案例的残差，按顺序排列，以逗号分隔的列表形式封装在方括号中，例如 $[r_1,r_2,r_3,r_4,r_5]$，其中每个 $r_i$ 是一个浮点数，单位为 $\\mathrm{s}^{-1}$，表示该测试案例中所有单元上最大绝对离散散度。不应打印任何额外文本。",
            "solution": "该问题是有效的。它提出了一个来自计算流体力学领域的、有良好科学依据的验证练习，特别关注结构化和非结构化网格上离散算子的性质。所有必要的数据和定义都已提供，问题内部逻辑一致。\n\n这个问题的核心在于验证有限体积法 (FVM) 离散化的一个基本性质：精确保持一个恒定的、无散的速度场。对于任何旨在求解守恒律的数值格式来说，这是一个至关重要的测试，因为它表明离散算子在最简单的非平凡情况下能正确模拟其连续对应物的性质。\n\n其指导原则是散度定理，它将向量场 $\\mathbf{u}$ 的散度的体积分与该场通过该体积封闭边界 $\\partial V$ 的通量联系起来：\n$$\n\\int_V \\nabla \\cdot \\mathbf{u} \\, dV = \\oint_{\\partial V} \\mathbf{u} \\cdot \\mathbf{n} \\, dS\n$$\n这里，$\\mathbf{n}$ 是边界曲面元 $dS$ 的外向单位法向量。\n\n在 FVM 中，我们考虑单个控制体（一个单元 $c$），并近似该单元上的平均散度。积分形式除以单元体积 $|V_c|$：\n$$\n\\frac{1}{|V_c|} \\int_{V_c} \\nabla \\cdot \\mathbf{u} \\, dV = \\frac{1}{|V_c|} \\oint_{\\partial V_c} \\mathbf{u} \\cdot \\mathbf{n} \\, dS\n$$\n左侧代表单元平均散度 $(\\nabla \\cdot \\mathbf{u})_c$。右侧的积分被离散化为单元各面 $f$ 上通量的总和：\n$$\n(\\nabla \\cdot \\mathbf{u})_c \\approx \\frac{1}{|V_c|} \\sum_{f \\in \\partial c} \\left( \\mathbf{u}_f \\cdot \\mathbf{n}_f \\right) |S_f|\n$$\n其中 $\\mathbf{u}_f$ 是面上的速度，$\\mathbf{n}_f$ 是面的外向单位法向量，而 $|S_f|$ 是面的面积（在二维中为长度）。\n\n问题指定了一个恒定速度场 $\\mathbf{u}(\\mathbf{x}) = \\mathbf{u}_0$。对于这样的场，连续散度恒为零：$\\nabla \\cdot \\mathbf{u}_0 = 0$。由于速度是恒定的，任何面上的速度 $\\mathbf{u}_f$ 都只是 $\\mathbf{u}_0$。离散散度公式变为：\n$$\n(\\nabla \\cdot \\mathbf{u})_c \\approx \\frac{1}{|V_c|} \\sum_{f \\in \\partial c} \\left( \\mathbf{u}_0 \\cdot \\mathbf{n}_f \\right) |S_f| = \\frac{1}{|V_c|} \\mathbf{u}_0 \\cdot \\left( \\sum_{f \\in \\partial c} \\mathbf{n}_f |S_f| \\right)\n$$\n这个方程揭示了，一个常数场的离散散度为零，当且仅当所有外向法向量乘以其面面积后的总和为零向量。这是一个纯粹的几何性质，被称为几何守恒律：对于任何封闭体积，其所有外向面法向面积向量的总和必须为零。一个有效的 FVM 离散化必须精确满足这个条件。\n$$\n\\sum_{f \\in \\partial c} \\mathbf{n}_f |S_f| = \\mathbf{0}\n$$\n我们的任务是在数值上验证结构化和非结构化网格的这一性质。计算出的残差将是所有单元上离散散度的最大绝对值，理想情况下应为零，任何非零值都可归因于浮点运算误差。\n\n**1. 结构化笛卡尔网格 (2D)**\n\n对于二维结构化网格，一个单元是一个宽为 $dx$、高为 $dy$ 的矩形。其面积为 $|V_c| = dx \\cdot dy$。单元有四个面（东、北、西、南）。我们定义外向法向长度向量，即 $\\mathbf{n}_f |S_f|$ 的乘积：\n- 东面：法向量 $\\mathbf{n}_e=(1, 0)$，长度 $|S_e|=dy$。向量：$(dy, 0)$。\n- 北面：法向量 $\\mathbf{n}_n=(0, 1)$，长度 $|S_n|=dx$。向量：$(0, dx)$。\n- 西面：法向量 $\\mathbf{n}_w=(-1, 0)$，长度 $|S_w|=dy$。向量：$(-dy, 0)$。\n- 南面：法向量 $\\mathbf{n}_s=(0, -1)$，长度 $|S_s|=dx$。向量：$(0, -dx)$。\n\n这些向量的总和是：\n$$\n\\sum_{f \\in \\partial c} \\mathbf{n}_f |S_f| = (dy, 0) + (0, dx) + (-dy, 0) + (0, -dx) = (dy - dy, dx - dx) = (0, 0)\n$$\n几何守恒律得以满足。总通量通过将恒定速度 $\\mathbf{u}_0 = (u_x, u_y)$ 与每个法向长度向量的点积相加来计算：\n$$\n\\text{Flux}_{total} = u_x \\cdot dy + u_y \\cdot dx + u_x \\cdot (-dy) + u_y \\cdot (-dx) = (u_x dy - u_x dy) + (u_y dx - u_y dx) = 0\n$$\n离散散度为 $\\frac{\\text{Flux}_{total}}{|V_c|} = \\frac{0}{dx \\cdot dy} = 0$。这对于网格中的每个单元都成立。\n\n**2. 非结构化多边形网格 (2D)**\n\n对于二维非结构化网格，一个单元是由一系列 $N$ 个顶点 $(x_i, y_i)$（$i=0, \\dots, N-1$）定义的简单多边形，顶点按逆时针 (CCW) 顺序排列。\n单元面积 $|V_c|$ 使用鞋带公式计算：\n$$\n|V_c| = \\frac{1}{2} \\sum_{i=0}^{N-1} (x_i y_{i+1} - x_{i+1} y_i)\n$$\n其中顶点索引 $N$ 等价于 $0$。正值结果确认了逆时针排序。\n\n面 $f_i$ 是连接顶点 $i$ 和顶点 $i+1$ 的边。边向量为 $\\Delta\\mathbf{s}_i = (x_{i+1} - x_i, y_{i+1} - y_i) = (\\Delta x_i, \\Delta y_i)$。对于逆时针排序的多边形，外向法向长度向量通过将边向量旋转 $-90^\\circ$ 得到：\n$$\n\\mathbf{n}_{f_i} |S_{f_i}| = (\\Delta y_i, -\\Delta x_i)\n$$\n这些向量在封闭多边形所有面上的总和是：\n$$\n\\sum_{i=0}^{N-1} (\\Delta y_i, -\\Delta x_i) = \\left( \\sum_{i=0}^{N-1} (y_{i+1} - y_i), -\\sum_{i=0}^{N-1} (x_{i+1} - x_i) \\right)\n$$\n这些是伸缩求和。对于一个封闭多边形，其中 $(x_N, y_N) = (x_0, y_0)$:\n$$\n\\sum_{i=0}^{N-1} (y_{i+1} - y_i) = y_N - y_0 = 0 \\quad \\text{以及} \\quad \\sum_{i=0}^{N-1} (x_{i+1} - x_i) = x_N - x_0 = 0\n$$\n因此，法向长度向量的总和是 $(0, 0)$，再次满足几何守恒律。总通量通过对点积 $\\mathbf{u}_0 \\cdot (\\mathbf{n}_{f_i} |S_{f_i}|)$ 求和来计算：\n$$\n\\text{Flux}_{total} = \\sum_{i=0}^{N-1} \\mathbf{u}_0 \\cdot (\\Delta y_i, -\\Delta x_i) = \\sum_{i=0}^{N-1} (u_x \\Delta y_i - u_y \\Delta x_i) = u_x \\sum \\Delta y_i - u_y \\sum \\Delta x_i = u_x \\cdot 0 - u_y \\cdot 0 = 0\n$$\n每个多边形单元的离散散度为 $\\frac{\\text{Flux}_{total}}{|V_c|} = 0$。实现将为每个指定的单元计算此值，并报告最大绝对值作为残差。",
            "answer": "[0.0,0.0,0.0,5.551115123125783e-16,1.4210854715202004e-14]"
        },
        {
            "introduction": "最后的练习将这些概念应用于一个完整的瞬态模拟。我们将在两种类型的网格上使用一个简单但广泛应用的数值格式来求解线性平流方程，然后使用严格的数学范数来量化误差 ()。这个练习提供了一种实用的方法，用于比较结构化和非结构化网格的性能，并理解数值误差如何在模拟中累积。",
            "id": "3918663",
            "problem": "考虑一维线性平流偏微分方程 (PDE) $u_t + a u_x = 0$，定义在周期性域 $x \\in [0,1)$ 上，其中 $a \\in \\mathbb{R}$ 是一个常数平流速度。设初始条件为 $u(x,0) = u_0(x)$，其中\n$$\nu_0(x) = \\sin(2\\pi x) + 0.25 \\exp\\left(-100 (x-0.5)^2 \\right).\n$$\n在时间 $t$ 的解析解为 $u(x,t) = u_0\\big((x - a t) \\bmod 1\\big)$。\n\n您将通过在两种网格类型上计算验证指标来评估网格依赖性性能：\n- 结构化网格：$N$ 个均匀控制体，其边位于 $x_j = j/N$，其中 $j=0,\\dots,N$。\n- 非结构化网格：$N$ 个非均匀控制体，其长度 $\\Delta x_i$ 由正权重 $w_i = 1 + \\eta \\xi_i$ 构建，其中 $\\xi_i \\sim \\mathcal{U}[-1,1]$ 是使用指定的伪随机种子生成的独立同分布随机变量。单元长度为 $\\Delta x_i = w_i / \\sum_{k=1}^{N} w_k$，周期性边为 $x_0 = 0$，$x_i = \\sum_{k=1}^{i} \\Delta x_k$ (对于 $i=1,\\dots,N$)，且 $x_N = 1$。\n\n在每个网格上使用一阶有限体积迎风法对 PDE 进行离散化。用 $U_i^n \\approx \\frac{1}{\\Delta x_i} \\int_{x_{i-1}}^{x_i} u(x,t^n)\\,dx$ 表示单元平均值。对于从 $t^n$ 到 $t^{n+1} = t^n + \\Delta t$ 的一个显式时间步，有限体积更新为\n$$\nU_i^{n+1} = U_i^n - \\frac{\\Delta t}{\\Delta x_i} \\left( F_{i+1/2} - F_{i-1/2} \\right),\n$$\n其中面 $i+1/2$ 处的数值通量由常数速度 $a$ 的迎风选择给出：\n$$\nF_{i+1/2} =\n\\begin{cases}\na \\, U_i^n, & a \\ge 0, \\\\\na \\, U_{i+1}^n, & a  0,\n\\end{cases}\n$$\n在一个周期性网格上，索引对 $N$ 取模。对于 $a \\ne 0$，通过 Courant 数 $C \\in (0,1]$ 选择时间步长 $\\Delta t$ 如下：\n$$\n\\Delta t = C \\, \\frac{\\min_i \\Delta x_i}{|a|},\n$$\n\n为了将一个迎风时间步后的离散解与平流后的解析场进行比较，请使用通过高阶求积计算的单元平均值。具体来说，对于长度为 $\\Delta x_i$ 的单元区间 $[x_{i-1}, x_i]$，使用至少八点的 Gauss–Legendre 法则来近似函数 $f(x)$ 的单元平均值：\n$$\n\\frac{1}{\\Delta x_i} \\int_{x_{i-1}}^{x_i} f(x) \\, dx \\approx \\frac{1}{2} \\sum_{q=1}^{m} w_q \\, f\\!\\left( \\frac{x_i - x_{i-1}}{2} \\, \\xi_q + \\frac{x_i + x_{i-1}}{2} \\right),\n$$\n其中 $m \\ge 8$，$\\{(\\xi_q, w_q)\\}_{q=1}^{m}$ 是 $[-1,1]$ 上的 Gauss–Legendre 节点和权重。此法则既用于计算 $u_0(x)$ 的初始单元平均值 $U_i^0$，也用于计算时间 $\\Delta t$ 时平流场 $u_0\\big((x - a \\Delta t) \\bmod 1\\big)$ 的精确单元平均值。\n\n对于每个网格，在一个时间步后，定义离散误差 $e_i = U_i^{1} - \\bar{u}_i^{\\mathrm{exact}}$，其中 $\\bar{u}_i^{\\mathrm{exact}}$ 是在时间 $\\Delta t$ 时通过求积近似的精确单元平均值。计算以下验证指标：\n- $L^1$ 范数，\n$$\n\\|e\\|_{L^1} \\approx \\sum_{i=1}^{N} |e_i| \\, \\Delta x_i.\n$$\n- $L^2$ 范数，\n$$\n\\|e\\|_{L^2} \\approx \\left( \\sum_{i=1}^{N} e_i^2 \\, \\Delta x_i \\right)^{1/2}.\n$$\n- $L^{\\infty}$ 范数，\n$$\n\\|e\\|_{L^{\\infty}} = \\max_{1 \\le i \\le N} |e_i|.\n$$\n- 由集总质量矩阵（单元体积）导出的能量范数，\n$$\n\\|e\\|_{E} = \\left( e^{\\top} M e \\right)^{1/2}, \\quad M = \\mathrm{diag}(\\Delta x_1,\\dots,\\Delta x_N).\n$$\n\n在下面的每个测试用例中，为结构化和非结构化网格实现上述内容，使用 $m = 8$ 个 Gauss–Legendre 点进行求积。对于非结构化网格，使用指定的伪随机种子生成 $\\xi_i$，并使用 $\\eta$ 作为不规则性振幅。\n\n测试套件（每个参数元组为 $(N, a, C, \\eta, \\text{seed})$）：\n1. $(100, 1.0, 0.5, 0.3, 42)$\n2. $(20, 1.0, 0.9, 0.5, 123)$\n3. $(8, -1.0, 0.4, 0.8, 7)$\n\n您的程序必须：\n- 为每个测试用例构建定义的结构化和非结构化网格。\n- 在每个网格上计算从 $t=0$ 到 $t=\\Delta t$ 的一个迎风有限体积时间步。\n- 使用求积定义的单元平均值计算每个网格上的四个误差指标。\n- 对于每个测试用例，按顺序输出一个包含八个浮点数的列表\n$$\n[\\|e\\|_{L^1}^{\\mathrm{struct}}, \\|e\\|_{L^2}^{\\mathrm{struct}}, \\|e\\|_{L^{\\infty}}^{\\mathrm{struct}}, \\|e\\|_{E}^{\\mathrm{struct}}, \\|e\\|_{L^1}^{\\mathrm{unstruct}}, \\|e\\|_{L^2}^{\\mathrm{unstruct}}, \\|e\\|_{L^{\\infty}}^{\\mathrm{unstruct}}, \\|e\\|_{E}^{\\mathrm{unstruct}} ].\n$$\n- 将所有测试用例的结果汇总到一个外部列表中。\n\n最终输出格式：您的程序应生成单行输出，其中包含一个逗号分隔的 Python 风格的列表的列表，每个浮点数四舍五入到八位小数，且无额外文本。例如：“[[0.12345678,0.23456789,0.34567890,0.45678901,0.11111111,0.22222222,0.33333333,0.44444444],[...],[...]]”。本问题不需要角度和物理单位；所有量均为无量纲。输出必须恰好为一行，没有前导或尾随空格，也没有单位。",
            "solution": "用户提供的问题是偏微分方程 (PDE) 数值分析领域中一个定义明确的任务。在进行求解之前，我将首先验证其有效性。\n\n### 第 1 步：提取已知信息\n\n- **PDE**：一维线性平流方程，$u_t + a u_x = 0$，定义在周期性域 $x \\in [0,1)$ 上，其中 $a \\in \\mathbb{R}$ 是一个常数速度。\n- **初始条件**：$u(x,0) = u_0(x) = \\sin(2\\pi x) + 0.25 \\exp\\left(-100 (x-0.5)^2 \\right)$。\n- **解析解**：$u(x,t) = u_0\\big((x - a t) \\bmod 1\\big)$。\n- **网格**：定义了两种具有 $N$ 个单元的网格类型：\n    1.  **结构化网格**：均匀单元，其边位于 $x_j = j/N$ (其中 $j=0, \\dots, N$) 。单元长度为 $\\Delta x_j = 1/N$。\n    2.  **非结构化网格**：非均匀单元。由权重 $w_i = 1 + \\eta \\xi_i$ 生成，其中 $\\xi_i$ 是使用给定种子从 $\\mathcal{U}[-1,1]$ 中抽取的独立同分布样本。单元长度为 $\\Delta x_i = w_i / \\sum_{k=1}^{N} w_k$。边为 $x_0 = 0$，$x_i = \\sum_{k=1}^{i} \\Delta x_k$。\n- **数值离散化**：一阶有限体积迎风法。\n    - **更新规则**：$U_i^{n+1} = U_i^n - \\frac{\\Delta t}{\\Delta x_i} \\left( F_{i+1/2} - F_{i-1/2} \\right)$。\n    - **数值通量**：如果 $a \\ge 0$，则 $F_{i+1/2} = a U_i^n$；如果 $a  0$，则 $F_{i+1/2} = a U_{i+1}^n$。索引是周期性的（对 $N$ 取模）。\n- **时间步长**：$\\Delta t = C \\frac{\\min_i \\Delta x_i}{|a|}$，对于 Courant 数 $C \\in (0,1]$。\n- **单元平均值**：在 $[x_{i-1}, x_i]$ 上的任意函数 $f(x)$ 的单元平均值将通过一个 $m \\ge 8$ 的 $m$ 点 Gauss-Legendre 求积法则来近似。公式为 $\\frac{1}{2} \\sum_{q=1}^{m} w_q f(\\dots)$。这用于初始条件和时间 $\\Delta t$ 时的精确解。\n- **误差指标**：\n    - $L^1$ 范数：$\\|e\\|_{L^1} \\approx \\sum_{i=1}^{N} |e_i| \\, \\Delta x_i$。\n    - $L^2$ 范数：$\\|e\\|_{L^2} \\approx \\left( \\sum_{i=1}^{N} e_i^2 \\, \\Delta x_i \\right)^{1/2}$。\n    - $L^{\\infty}$ 范数：$\\|e\\|_{L^{\\infty}} = \\max_{1 \\le i \\le N} |e_i|$。\n    - 能量范数：$\\|e\\|_{E} = \\left( e^{\\top} M e \\right)^{1/2}$，其中 $M = \\mathrm{diag}(\\Delta x_1, \\dots, \\Delta x_N)$。\n- **任务**：对于每个测试用例，计算一个时间步，并为结构化和非结构化网格评估四个误差指标。\n- **测试套件**：$(N, a, C, \\eta, \\text{seed})$ 元组：\n    1.  $(100, 1.0, 0.5, 0.3, 42)$\n    2.  $(20, 1.0, 0.9, 0.5, 123)$\n    3.  $(8, -1.0, 0.4, 0.8, 7)$\n- **输出格式**：一个列表的列表，每个内部列表包含八个四舍五入到八位小数的浮点数，分别对应结构化网格的四个范数和非结构化网格的四个范数。\n\n### 第 2 步：使用提取的已知信息进行验证\n\n- **科学依据**：该问题基于基本的一维线性平流方程，这是流体动力学和输运现象的基石。数值方法（一阶迎风法）、稳定性条件 (CFL)、网格生成程序和误差分析都是数值分析中的标准且正确的概念。所有前提都具有科学合理性。\n- **适定性**：该问题是适定的。具有给定光滑初始条件和周期性边界条件的 PDE 存在唯一、稳定的解析解。数值问题也是适定的；离散化是标准的，时间步长的选择确保了稳定性。该过程是确定性的（给定随机数生成器的种子），并将产生唯一的结果。\n- **客观性**：该问题以精确、客观的数学语言陈述。所有术语都已定义，任务明确无误。\n- **完整性与一致性**：为每个测试用例提供了所有必要的参数（$N, a, C, \\eta, \\text{seed}$）、函数（$u_0(x)$）和程序。没有矛盾之处。能量范数的定义 $\\|e\\|_{E} = (\\sum e_i^2 \\Delta x_i)^{1/2}$ 与所提供的离散 $L^2$ 范数相同。这是一种冗余，而非矛盾。它仅表示两个计算出的值将是相同的。\n- **现实性与可行性**：该问题是数值方法中的一个标准学术练习。所有参数都在合理范围内，计算完全可行。\n- **结构性与非平凡性**：该问题结构良好且不平凡。它要求正确实现网格生成、数值积分、PDE 求解器和误差分析，从而测试对这些相互关联概念的理解。\n\n### 第 3 步：结论与行动\n\n问题陈述是**有效的**。这是一个清晰、独立且科学上合理的计算科学练习。我现在将开始进行求解。\n\n### 求解原则与设计\n\n该解法将使用 Python 实现，利用 `numpy` 库进行高效的数组操作，并使用 `scipy` 库提供专门的科学函数。实现将遵循模块化设计，将问题分解为不同且易于管理的部分。\n\n1.  **网格生成**：将创建两个函数：一个用于结构化网格，它仅计算均匀间距；另一个用于非结构化网格，它使用随机数生成器（为保证可复现性而设定种子）按规定创建非均匀的单元宽度。\n\n2.  **函数定义**：初始条件 $u_0(x)$ 和解析解 $u(x,t)$ 将被定义为可对 `numpy` 数组进行操作的 Python 函数，从而实现矢量化评估。\n\n3.  **高阶求积**：一个核心效用函数将计算给定函数在指定网格上的单元平均值。此函数将使用 $8$ 点 Gauss-Legendre 求积法则。节点和权重将使用 `scipy.special.roots_legendre` 预先计算。该函数会将这些节点映射到每个单元区间，并应用求积公式来近似积分，然后除以单元宽度以获得平均值。\n\n4.  **数值时间步**：一个函数将实现一阶迎风有限体积方法的单个时间步。为提高效率，此实现将被矢量化。它将根据平流速度 $a$ 的符号有条件地处理通量计算。对于 $a \\ge 0$，通量取决于当前单元和左侧单元（`i` 和 `i-1`）的状态；对于 $a  0$，通量取决于当前单元和右侧单元（`i` 和 `i+1`）的状态。周期性边界条件将通过使用 `numpy.roll` 来循环单元平均值数组的元素来处理。\n\n5.  **误差计算**：一个函数将接收单元误差向量和相应的单元宽度，以计算四个所需的范数：$L^1$、$L^2$、$L^{\\infty}$ 和能量范数 $E$。如前所述，$L^2$ 和 $E$ 范数在数学上是等价的，并将使用相同的公式计算。\n\n6.  **主循环**：主函数将协调整个过程。它将遍历所提供的测试用例。对于每个用例，它将：\n    a.  对结构化网格执行比较：生成网格，确定 $\\Delta t$，计算初始单元平均值 `U0_s`，执行迎风步以获得 `U1_s`，计算在 $t=\\Delta t$ 时的精确单元平均值 `U_exact_s`，计算误差 `e_s = U1_s - U_exact_s`，并计算四个误差指标。\n    b.  对非结构化网格重复此过程，使用其特定的几何形状和因此而不同的 $\\Delta t$。\n    c.  按指定顺序收集八个产生的误差指标。\n\n7.  **输出格式化**：最后，将所有测试用例的收集结果格式化为单个字符串——一个由浮点数列表组成的列表，每个数字四舍五入到八位小数——并打印到标准输出。",
            "answer": "[[0.01257467,0.01831818,0.15582236,0.01831818,0.01255869,0.01833189,0.15876008,0.01833189],[0.04618774,0.06201389,0.25877443,0.06201389,0.04709192,0.06322971,0.26188612,0.06322971],[0.08882064,0.11717316,0.31682343,0.11717316,0.08657668,0.11470404,0.31623192,0.11470404]]"
        }
    ]
}