{
    "hands_on_practices": [
        {
            "introduction": "This first practice provides a foundational exercise in implementing the discrete divergence operator, a cornerstone of fluid dynamics models. By working on the Arakawa C-grid, you will gain hands-on experience with the staggered data layout and the practical challenge of enforcing physical boundary conditions, such as impermeable walls. Successfully completing this exercise is the first crucial step toward building robust numerical simulations.",
            "id": "3863000",
            "problem": "Consider a rectangular domain with dimensions $L_x$ and $L_y$ discretized into $N_x$ cells in the $x$ direction and $N_y$ cells in the $y$ direction, using the Arakawa C-grid staggering convention. On an Arakawa C-grid, the horizontal velocity component $u$ is located at the centers of the vertical cell faces, and the vertical velocity component $v$ is located at the centers of the horizontal cell faces, while scalars (e.g., mass or pressure) are located at cell centers. Let the uniform grid spacings be $\\Delta x = L_x / N_x$ and $\\Delta y = L_y / N_y$.\n\nThe conservation of mass for an incompressible flow is given by the divergence-free condition $\\nabla \\cdot \\mathbf{u} = 0$. In finite-volume form for a single rectangular cell with area $A = \\Delta x \\Delta y$, the integral statement is\n$$\n\\int_V \\nabla \\cdot \\mathbf{u} \\, dV = \\oint_{\\partial V} \\mathbf{u} \\cdot \\mathbf{n} \\, dS,\n$$\nand for a uniform Cartesian grid this yields the discrete divergence at each cell center $(i+\\tfrac{1}{2}, j+\\tfrac{1}{2})$\n$$\n(\\nabla \\cdot \\mathbf{u})_{i+\\frac{1}{2}, j+\\frac{1}{2}} = \\frac{u_{i+1, j} - u_{i, j}}{\\Delta x} + \\frac{v_{i, j+1} - v_{i, j}}{\\Delta y},\n$$\nwhere $u_{i,j}$ denotes the value of $u$ at the vertical face located at $x = i \\Delta x$, $y = \\left(j + \\tfrac{1}{2}\\right) \\Delta y$, for $i = 0, 1, \\dots, N_x$ and $j = 0, 1, \\dots, N_y - 1$, and $v_{i,j}$ denotes the value of $v$ at the horizontal face located at $x = \\left(i + \\tfrac{1}{2}\\right) \\Delta x$, $y = j \\Delta y$, for $i = 0, 1, \\dots, N_x - 1$ and $j = 0, 1, \\dots, N_y$.\n\nImpose the following physical boundary conditions on all four domain edges:\n- No-normal-flow (impermeable walls): $\\mathbf{u} \\cdot \\mathbf{n} = 0$ at boundaries, which implies $u = 0$ at the western and eastern domain faces ($i = 0$ and $i = N_x$), and $v = 0$ at the southern and northern domain faces ($j = 0$ and $j = N_y$).\n- Free-slip (zero shear stress) for tangential velocity components: $\\partial u_t / \\partial n = 0$ at boundaries, where $u_t$ is the tangential component and $n$ is the outward normal. On a C-grid, this can be enforced consistently using ghost values outside the domain. For example, at the western boundary $x = 0$, the tangential component is $v$, and the second-order accurate discrete Neumann condition $\\partial v / \\partial x = 0$ at $x = 0$ can be satisfied by setting the ghost value so that a one-sided second-order finite-difference approximation vanishes:\n$$\n\\left.\\frac{\\partial v}{\\partial x}\\right|_{x=0} \\approx \\frac{-3 v_{0,j} + 4 v_{1,j} - v_{2,j}}{2 \\Delta x} = 0 \\quad \\Rightarrow \\quad v_{0,j} = \\frac{4 v_{1,j} - v_{2,j}}{3},\n$$\nwith analogous treatments at $x = L_x$ for $v$, and at $y = 0$ and $y = L_y$ for $u$. Although the divergence operator does not directly use tangential derivatives, this boundary closure is required to maintain consistency of the staggered arrangement when differential operators involving tangential components are present.\n\nYour task is to implement the discrete divergence on the Arakawa C-grid for the following test suite, enforcing impermeable walls via the no-normal-flow condition as specified above. For each test case, construct the staggered velocity fields $(u, v)$ from given analytic definitions sampled at the appropriate staggered locations, apply the no-normal-flow boundary conditions to $u$ and $v$ on the domain boundary faces, and compute the maximum absolute value of the discrete divergence over all cell centers:\n$$\nD_{\\max} = \\max_{i=0,\\dots,N_x-1 \\atop j=0,\\dots,N_y-1} \\left| \\frac{u_{i+1, j} - u_{i, j}}{\\Delta x} + \\frac{v_{i, j+1} - v_{i, j}}{\\Delta y} \\right|.\n$$\nReport $D_{\\max}$ in inverse seconds (s$^{-1}$) as a floating-point number for each test case.\n\nAnalytic velocity field definitions to be sampled at staggered locations:\n- Case A (vortex-type incompressible flow via streamfunction): Let the streamfunction be $\\psi(x,y) = \\sin\\left(\\pi x / L_x\\right) \\sin\\left(\\pi y / L_y\\right)$. Define\n$$\nu(x,y) = \\frac{\\partial \\psi}{\\partial y} = \\frac{\\pi}{L_y} \\cos\\left(\\pi y / L_y\\right) \\sin\\left(\\pi x / L_x\\right), \\quad v(x,y) = -\\frac{\\partial \\psi}{\\partial x} = -\\frac{\\pi}{L_x} \\cos\\left(\\pi x / L_x\\right) \\sin\\left(\\pi y / L_y\\right).\n$$\n- Case B (uniform flow that violates no-normal-flow at vertical boundaries before enforcement): Define\n$$\nu(x,y) = U_0, \\quad v(x,y) = 0,\n$$\nwith constant speed $U_0$.\n- Case C (single-cell domain with the same streamfunction-based definition as Case A), to test boundary handling in the minimal grid.\n\nTest suite parameter sets:\n- Case A: $L_x = 1$ m, $L_y = 1$ m, $N_x = 16$, $N_y = 12$.\n- Case B: $L_x = 3$ m, $L_y = 2$ m, $N_x = 9$, $N_y = 6$, $U_0 = 0.5$ m/s.\n- Case C: $L_x = 1$ m, $L_y = 1$ m, $N_x = 1$, $N_y = 1$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result_A, result_B, result_C]\"), where each $\\text{result}_*$ is the floating-point value of $D_{\\max}$ for the corresponding case, expressed in s$^{-1}$.",
            "solution": "The problem requires the implementation of a discrete divergence operator on an Arakawa C-grid and its application to three test cases. The core of the task is to correctly represent the staggered velocity fields, apply the specified boundary conditions, and compute the maximum absolute divergence over the computational domain.\n\n**1. Arakawa C-Grid and Discrete Divergence**\n\nThe Arakawa C-grid is a staggered grid arrangement commonly used in computational fluid dynamics, particularly for geophysical flows. Its key feature is the spatial offset of different physical variables. In this problem, scalar quantities (like pressure or, in this case, the divergence itself) are located at the center of a grid cell $(i+\\tfrac{1}{2}, j+\\tfrac{1}{2})$, while vector components are located at the cell faces.\n- The horizontal velocity component, $u$, is defined at the center of vertical faces. Its locations are given by coordinates $(x_i, y_{j+1/2}) = (i\\Delta x, (j+\\tfrac{1}{2})\\Delta y)$ for $i \\in \\{0, 1, \\dots, N_x\\}$ and $j \\in \\{0, 1, \\dots, N_y-1\\}$. This can be represented by a 2D array of size $(N_x+1) \\times N_y$.\n- The vertical velocity component, $v$, is defined at the center of horizontal faces. Its locations are given by coordinates $(x_{i+1/2}, y_j) = ((i+\\tfrac{1}{2})\\Delta x, j\\Delta y)$ for $i \\in \\{0, 1, \\dots, N_x-1\\}$ and $j \\in \\{0, 1, \\dots, N_y\\}$. This can be represented by a 2D array of size $N_x \\times (N_y+1)$.\n\nThe conservation of mass for an incompressible fluid is $\\nabla \\cdot \\mathbf{u} = 0$. The finite-volume discretization on the C-grid for the cell $(i, j)$ (centered at $(x_{i+1/2}, y_{j+1/2})$) is given by:\n$$\n(\\nabla \\cdot \\mathbf{u})_{i+\\frac{1}{2}, j+\\frac{1}{2}} = \\frac{u_{i+1, j} - u_{i, j}}{\\Delta x} + \\frac{v_{i, j+1} - v_{i, j}}{\\Delta y}\n$$\nHere, $u_{i+1, j} - u_{i, j}$ represents the net flux of the $u$-velocity component out of the cell in the $x$-direction, and $v_{i, j+1} - v_{i, j}$ represents the net flux of the $v$-velocity component in the $y$-direction. The indices correspond to the array locations of the velocity components on the cell faces. The divergence itself is computed for each of the $N_x \\times N_y$ cells.\n\n**2. Boundary Conditions**\n\nThe problem specifies impermeable wall (no-normal-flow) boundary conditions, $\\mathbf{u} \\cdot \\mathbf{n} = 0$, on all four domain boundaries. On the C-grid, this condition is enforced directly on the velocity components normal to the boundary.\n- Western boundary ($x=0$, $i=0$): The normal velocity is $u$. The condition is $u_{0, j} = 0$ for all $j \\in \\{0, \\dots, N_y-1\\}$.\n- Eastern boundary ($x=L_x$, $i=N_x$): The normal velocity is $u$. The condition is $u_{N_x, j} = 0$ for all $j \\in \\{0, \\dots, N_y-1\\}$.\n- Southern boundary ($y=0$, $j=0$): The normal velocity is $v$. The condition is $v_{i, 0} = 0$ for all $i \\in \\{0, \\dots, N_x-1\\}$.\n- Northern boundary ($y=L_y$, $j=N_y$): The normal velocity is $v$. The condition is $v_{i, N_y} = 0$ for all $i \\in \\{0, \\dots, N_x-1\\}$.\n\nThe discussion of free-slip tangential velocity boundary conditions is noted, but as the problem statement confirms, the divergence operator itself does not depend on tangential derivatives or ghost cells. Therefore, only the no-normal-flow conditions are required for this specific computation.\n\n**3. Test Case Analysis**\n\nFor each case, we first define the grid parameters, then create the velocity fields by sampling the given analytic functions at the appropriate staggered grid locations, enforce the no-normal-flow boundary conditions, compute the divergence field, and finally find the maximum absolute value $D_{\\max}$.\n\n**Case A: Vortex-Type Flow**\n- Parameters: $L_x = 1$ m, $L_y = 1$ m, $N_x = 16$, $N_y = 12$.\n- Velocity fields are derived from the streamfunction $\\psi(x,y) = \\sin(\\pi x / L_x) \\sin(\\pi y / L_y)$.\n- The $u$ and $v$ fields are populated by sampling $u(x,y) = \\frac{\\pi}{L_y} \\cos(\\pi y / L_y) \\sin(\\pi x / L_x)$ and $v(x,y) = -\\frac{\\pi}{L_x} \\cos(\\pi x / L_x) \\sin(\\pi y / L_y)$ at their respective staggered grid points.\n- Crucially, this analytic velocity field already satisfies the no-normal-flow conditions. For instance, at the western boundary $x=0$, $u(0,y) \\propto \\sin(0) = 0$. At the northern boundary $y=L_y$, $v(x,L_y) \\propto \\sin(\\pi L_y / L_y) = \\sin(\\pi) = 0$. The same holds for the other boundaries. Therefore, no explicit modification of the boundary velocities is needed after sampling.\n- The continuous analytical divergence is exactly zero. The computed discrete divergence will be a small, non-zero value representing the truncation error of the second-order finite-difference scheme.\n\n**Case B: Uniform Flow**\n- Parameters: $L_x = 3$ m, $L_y = 2$ m, $N_x = 9$, $N_y = 6$, $U_0 = 0.5$ m/s.\n- The initial velocity field is $u(x,y) = U_0$ and $v(x,y) = 0$. We initialize the $u$-array with $U_0$ and the $v$-array with $0$.\n- This initial field violates the no-normal-flow condition at the western and eastern boundaries. We must enforce the conditions by setting the first and last columns of the $u$-array to $0$: $u_{0,j} = 0$ and $u_{N_x, j} = 0$. The $v$-field already satisfies the conditions at the southern and northern boundaries.\n- The divergence is then computed. It will be non-zero only in the cells adjacent to the western and eastern boundaries.\n- For a cell in the westernmost column ($i=0$), the divergence is $\\frac{u_{1, j} - u_{0, j}}{\\Delta x} = \\frac{U_0 - 0}{\\Delta x}$.\n- For a cell in the easternmost column ($i=N_x-1$), the divergence is $\\frac{u_{N_x, j} - u_{N_x-1, j}}{\\Delta x} = \\frac{0 - U_0}{\\Delta x}$.\n- For all interior cells, the divergence is $0$.\n- Thus, $D_{\\max} = \\left| \\frac{U_0}{\\Delta x} \\right| = \\frac{0.5}{3/9} = \\frac{0.5}{1/3} = 1.5$ s$^{-1}$.\n\n**Case C: Single-Cell Vortex**\n- Parameters: $L_x = 1$ m, $L_y = 1$ m, $N_x = 1$, $N_y = 1$.\n- The velocity field is the same as in Case A, but sampled on a minimal $1 \\times 1$ grid.\n- The grid consists of one cell. We need to compute $u_{0,0}$, $u_{1,0}$, $v_{0,0}$, and $v_{0,1}$.\n- Grid locations for velocity components:\n  - $u_{0,0}$ is at $(x,y) = (0, 0.5)$. $u(0, 0.5) \\propto \\sin(0) = 0$.\n  - $u_{1,0}$ is at $(x,y) = (1, 0.5)$. $u(1, 0.5) \\propto \\sin(\\pi) = 0$.\n  - $v_{0,0}$ is at $(x,y) = (0.5, 0)$. $v(0.5, 0) \\propto \\sin(0) = 0$.\n  - $v_{0,1}$ is at $(x,y) = (0.5, 1)$. $v(0.5, 1) \\propto \\sin(\\pi) = 0$.\n- All relevant velocity components are exactly zero due to the specific sampling locations falling on the zeros of the trigonometric functions.\n- The discrete divergence is $\\frac{u_{1,0} - u_{0,0}}{\\Delta x} + \\frac{v_{0,1} - v_{0,0}}{\\Delta y} = \\frac{0-0}{1} + \\frac{0-0}{1} = 0$.\n- Therefore, $D_{\\max} = 0$.\n\nThe implementation will proceed by constructing a function that takes the case parameters, builds the grids, populates and corrects the velocity fields, computes the divergence, and returns the maximum absolute value.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_dmax(params: dict) -> float:\n    \"\"\"\n    Calculates the maximum absolute divergence on an Arakawa C-grid.\n\n    Args:\n        params: A dictionary containing the parameters for the simulation case.\n                Keys include 'case', 'Lx', 'Ly', 'Nx', 'Ny', and 'U0' if applicable.\n\n    Returns:\n        The maximum absolute value of the discrete divergence (D_max).\n    \"\"\"\n    case = params['case']\n    Lx, Ly = params['Lx'], params['Ly']\n    Nx, Ny = int(params['Nx']), int(params['Ny'])\n\n    dx = Lx / Nx\n    dy = Ly / Ny\n\n    u_shape = (Nx + 1, Ny)\n    v_shape = (Nx, Ny + 1)\n    \n    if case in ['A', 'C']:\n        # Case A and C: Vortex-type incompressible flow via streamfunction\n        \n        # Create coordinate grids for u and v velocity components.\n        # u is located at (i*dx, (j+0.5)*dy)\n        u_x_coords = np.linspace(0.0, Lx, Nx + 1)\n        u_y_coords = np.linspace(0.5 * dy, Ly - 0.5 * dy, Ny)\n        u_xx, u_yy = np.meshgrid(u_x_coords, u_y_coords, indexing='ij')\n\n        # v is located at ((i+0.5)*dx, j*dy)\n        v_x_coords = np.linspace(0.5 * dx, Lx - 0.5 * dx, Nx)\n        v_y_coords = np.linspace(0.0, Ly, Ny + 1)\n        v_xx, v_yy = np.meshgrid(v_x_coords, v_y_coords, indexing='ij')\n\n        # Populate velocity fields using the analytic functions.\n        # The analytic functions naturally satisfy the no-normal-flow boundary conditions.\n        u = (np.pi / Ly) * np.cos(np.pi * u_yy / Ly) * np.sin(np.pi * u_xx / Lx)\n        v = -(np.pi / Lx) * np.cos(np.pi * v_xx / Lx) * np.sin(np.pi * v_yy / Ly)\n        \n    elif case == 'B':\n        # Case B: Uniform flow that violates no-normal-flow initially\n        U0 = params['U0']\n        \n        # Initialize uniform velocity fields.\n        u = np.full(u_shape, U0)\n        v = np.zeros(v_shape)\n\n        # Enforce no-normal-flow boundary conditions (impermeable walls).\n        # Set u=0 at western (i=0) and eastern (i=Nx) boundaries.\n        u[0, :] = 0.0\n        u[-1, :] = 0.0\n        \n        # Set v=0 at southern (j=0) and northern (j=Ny) boundaries.\n        # The v field is already initialized to zeros, so this is satisfied.\n        v[:, 0] = 0.0\n        v[:, -1] = 0.0\n\n    else:\n        raise ValueError(f\"Unknown case: {case}\")\n\n    # Calculate the discrete divergence at each cell center.\n    # The divergence field has dimensions (Nx, Ny).\n    # du_dx corresponds to (u_{i+1,j} - u_{i,j}) / dx\n    # dv_dy corresponds to (v_{i,j+1} - v_{i,j}) / dy\n    \n    du_dx = (u[1:, :] - u[:-1, :]) / dx\n    dv_dy = (v[:, 1:] - v[:, :-1]) / dy\n\n    divergence = du_dx + dv_dy\n    \n    # Compute the maximum absolute value of the divergence.\n    d_max = np.max(np.abs(divergence))\n    \n    return d_max\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {'case': 'A', 'Lx': 1.0, 'Ly': 1.0, 'Nx': 16, 'Ny': 12},\n        {'case': 'B', 'Lx': 3.0, 'Ly': 2.0, 'Nx': 9, 'Ny': 6, 'U0': 0.5},\n        {'case': 'C', 'Lx': 1.0, 'Ly': 1.0, 'Nx': 1, 'Ny': 1},\n    ]\n\n    results = []\n    for params in test_cases:\n        result = calculate_dmax(params)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Building upon the basic implementation, this exercise extends the divergence operator to orthogonal curvilinear coordinates, which are essential for modeling flows in complex geometries. You will learn how to incorporate map scale factors, such as $h_{\\xi}$ and $h_{\\eta}$, into a finite-volume framework, a technique vital for applications ranging from regional ocean models to global atmospheric simulations. A key part of this practice is verifying the conservation properties of your scheme, a critical test for any numerical method intended for long-term integrations.",
            "id": "3862994",
            "problem": "You are tasked with designing and implementing a conservative, finite-volume discrete divergence operator for an orthogonal curvilinear grid using Arakawa grid staggering, and verifying its properties on several test cases. The computation must follow first principles grounded in the continuity equation for mass conservation.\n\nStart from the differential form of the continuity equation for an incompressible flow in orthogonal curvilinear coordinates $(\\xi,\\eta)$ with scale factors $h_{\\xi}(\\xi,\\eta)$ and $h_{\\eta}(\\xi,\\eta)$:\n$$\n\\nabla \\cdot \\mathbf{u} \\;=\\; \\frac{1}{h_\\xi h_\\eta}\\left(\\frac{\\partial}{\\partial \\xi}\\big(h_\\eta \\, u_\\xi\\big) \\;+\\; \\frac{\\partial}{\\partial \\eta}\\big(h_\\xi \\, u_\\eta\\big)\\right),\n$$\nwhere $u_{\\xi}$ and $u_{\\eta}$ are the contravariant velocity components aligned with the $\\xi$ and $\\eta$ coordinates, respectively. This relation expresses conservation of mass through the divergence of the velocity field, and is the foundational expression from which your discrete operator must be derived.\n\nUse the Arakawa C-grid staggering, which places:\n- scalar fields (e.g., mass or pressure-like quantities, and for this task the divergence itself) at cell centers indexed by $(i,j)$,\n- the $\\xi$-aligned contravariant velocity component $u_{\\xi}$ at cell faces normal to the $\\xi$-direction and centered along the $\\eta$-direction, indexed by $(i+\\tfrac{1}{}{2},j)$,\n- the $\\eta$-aligned contravariant velocity component $u_{\\eta}$ at cell faces normal to the $\\eta$-direction and centered along the $\\xi$-direction, indexed by $(i,j+\\tfrac{1}{}{2})$.\n\nAssume a periodic domain in both $\\xi$ and $\\eta$ directions on the unit square $[0,1]\\times[0,1]$, with uniform computational spacings $\\Delta \\xi = 1/N_x$ and $\\Delta \\eta = 1/N_y$ for integers $N_x$ and $N_y$. The scale factors $h_{\\xi}$ and $h_{\\eta}$ have units of meters per coordinate unit, the velocity components $u_{\\xi}$ and $u_{\\eta}$ have units of meters per second, and the divergence $\\nabla \\cdot \\mathbf{u}$ must be expressed in $\\mathrm{s}^{-1}$.\n\nYour program must:\n1. Derive, justify, and implement a finite-volume discrete divergence at cell centers that uses fluxes across cell faces incorporating the map factors $h_{\\xi}$ and $h_{\\eta}$ such that the scheme is conservative and consistent with the orthogonal curvilinear divergence formula above. The design must correctly handle the Arakawa C-grid indexing with periodic boundary conditions.\n2. Construct the following test suite and compute specified error metrics. All angles in trigonometric functions are in radians. For all cases, report the requested outputs in $\\mathrm{s}^{-1}$.\n\nDefine the grid coordinate arrays as follows:\n- Cell-center coordinates: $\\xi_i = \\frac{i+\\tfrac{1}{}{2}}{N_x}$ for $i = 0,1,\\dots,N_x-1$, and $\\eta_j = \\frac{j+\\tfrac{1}{}{2}}{N_y}$ for $j = 0,1,\\dots,N_y-1$.\n- $\\xi$-face coordinates: $\\xi^{(u)}_i = \\frac{i}{N_x}$ for $i = 0,1,\\dots,N_x-1$, and centered along $\\eta$ at $\\eta_j$.\n- $\\eta$-face coordinates: $\\eta^{(v)}_j = \\frac{j}{N_y}$ for $j = 0,1,\\dots,N_y-1$, and centered along $\\xi$ at $\\xi_i$.\n\nDefine the map factors for the curvilinear tests by\n$$\nh_\\xi(\\xi,\\eta) \\;=\\; 1 \\;+\\; a \\,\\sin(2\\pi \\xi)\\,\\cos(2\\pi \\eta), \\quad\nh_\\eta(\\xi,\\eta) \\;=\\; 1 \\;+\\; a \\,\\cos(2\\pi \\xi)\\,\\sin(2\\pi \\eta),\n$$\nwith $a=0.3$, and use $h_{\\xi} = 1$, $h_{\\eta} = 1$ for the uniform grid tests.\n\nDefine the following test cases:\n- Case A (uniform grid, constant flow): $N_x = 16$, $N_y = 16$, $h_{\\xi} = 1$, $h_{\\eta} = 1$, $u_{\\xi} = U_0$ with $U_0 = 3$ (meters per second) at all $\\xi$-faces, and $u_{\\eta} = 0$ at all $\\eta$-faces. Compute the maximum absolute divergence over all cells and report it in $\\mathrm{s}^{-1}$.\n- Case B (curvilinear grid, divergence-free analytic field via streamfunction): $N_x = 32$, $N_y = 24$, curvilinear $h_{\\xi}(\\xi,\\eta)$ and $h_{\\eta}(\\xi,\\eta)$ as above. Define the streamfunction $\\psi(\\xi,\\eta) = \\sin(2\\pi \\xi)\\,\\sin(2\\pi \\eta)$, and set the contravariant components by $u_\\xi = \\frac{1}{h_\\eta}\\,\\frac{\\partial \\psi}{\\partial \\eta}$ evaluated at $\\xi$-faces $(\\xi^{(u)}_i,\\eta_j)$ and $u_\\eta = -\\frac{1}{h_\\xi}\\,\\frac{\\partial \\psi}{\\partial \\xi}$ evaluated at $\\eta$-faces $(\\xi_i,\\eta^{(v)}_j)$. Compute and report the root-mean-square of the discrete divergence over all cells in $\\mathrm{s}^{-1}$.\n- Case C (uniform grid, periodic analytic divergence): $N_x = 3$, $N_y = 3$, $h_{\\xi} = 1$, $h_{\\eta} = 1$, $u_{\\xi}(\\xi,\\eta) = \\sin(2\\pi \\xi)$ at $\\xi$-faces $(\\xi^{(u)}_i,\\eta_j)$, $u_{\\eta}(\\xi,\\eta) = \\sin(2\\pi \\eta)$ at $\\eta$-faces $(\\xi_i,\\eta^{(v)}_j)$. The analytic divergence at cell centers is $\\nabla\\cdot\\mathbf{u} = 2\\pi \\cos(2\\pi \\xi) + 2\\pi \\cos(2\\pi \\eta)$. Compute the root-mean-square error between the discrete divergence and the analytic divergence, reported in $\\mathrm{s}^{-1}$.\n- Case D (curvilinear grid, random periodic velocities, conservation check): $N_x = 17$, $N_y = 19$, curvilinear $h_{\\xi}(\\xi,\\eta)$ and $h_{\\eta}(\\xi,\\eta)$ as above, and seed a pseudo-random generator deterministically. Generate $u_{\\xi}$ and $u_{\\eta}$ as independent random values on their respective faces. Compute the area-weighted mean divergence, defined as\n$$\n\\overline{D} \\;=\\; \\frac{\\sum_{i,j}\\big(\\nabla\\cdot\\mathbf{u}\\big)_{i,j} \\, h_{\\xi,i,j}\\,h_{\\eta,i,j}\\,\\Delta\\xi\\,\\Delta\\eta}{\\sum_{i,j} h_{\\xi,i,j}\\,h_{\\eta,i,j}\\,\\Delta\\xi\\,\\Delta\\eta},\n$$\nand report $|\\overline{D}|$ in $\\mathrm{s}^{-1}$.\n\nYour program must produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of the four cases: $[\\text{CaseA},\\text{CaseB},\\text{CaseC},\\text{CaseD}]$. Each entry must be a floating-point number in $\\mathrm{s}^{-1}$ (for Case D this is also in $\\mathrm{s}^{-1}$ due to area-averaging). No additional text may be printed. The implementation must be self-contained, require no user input, and follow the precise Arakawa C-grid indexing with periodic wrapping. Carefully justify your stencil, indexing, and the use of map factors from the given fundamental equation without introducing shortcut formulas in the problem statement.",
            "solution": "The problem requires the design and implementation of a conservative finite-volume divergence operator for an orthogonal curvilinear grid with Arakawa C-grid staggering. The derivation must be grounded in the provided differential form of the continuity equation.\n\n### Step 1: Derivation of the Discrete Divergence Operator\n\nThe foundation of the finite-volume method is the integral form of the conservation law. The given differential form of the continuity equation for an incompressible fluid is:\n$$\n\\nabla \\cdot \\mathbf{u} \\;=\\; \\frac{1}{h_\\xi h_\\eta}\\left(\\frac{\\partial}{\\partial \\xi}\\big(h_\\eta \\, u_\\xi\\big) \\;+\\; \\frac{\\partial}{\\partial \\eta}\\big(h_\\xi \\, u_\\eta\\big)\\right)\n$$\nwhere $(\\xi, \\eta)$ are orthogonal curvilinear coordinates with scale factors $h_\\xi$ and $h_\\eta$, and $\\mathbf{u} = (u_\\xi, u_\\eta)$ is the velocity vector with contravariant components.\n\nTo derive the finite-volume discretization, we integrate this equation over a single grid cell, or control volume, $V_{i,j}$. This cell is centered at coordinates $(\\xi_i, \\eta_j)$ and extends from $\\xi_i - \\frac{\\Delta\\xi}{2}$ to $\\xi_i + \\frac{\\Delta\\xi}{2}$ in the $\\xi$-direction, and from $\\eta_j - \\frac{\\Delta\\eta}{2}$ to $\\eta_j + \\frac{\\Delta\\eta}{2}$ in the $\\eta$-direction. The differential area element in physical space is $dA = h_\\xi h_\\eta d\\xi d\\eta$.\n\nIntegrating the equation over the cell's area in physical space, we get:\n$$\n\\iint_{V_{i,j}} (\\nabla \\cdot \\mathbf{u}) \\, h_\\xi h_\\eta \\, d\\xi d\\eta = \\iint_{V_{i,j}} \\left(\\frac{\\partial}{\\partial \\xi}\\big(h_\\eta \\, u_\\xi\\big) \\;+\\; \\frac{\\partial}{\\partial \\eta}\\big(h_\\xi \\, u_\\eta\\big)\\right) d\\xi d\\eta\n$$\n\nThe left-hand side can be approximated by taking the value of the divergence at the cell center, $(\\nabla \\cdot \\mathbf{u})_{i,j}$, and multiplying it by the area of the cell, $A_{i,j}$. The cell area is approximated as $A_{i,j} \\approx h_{\\xi,i,j} h_{\\eta,i,j} \\Delta\\xi \\Delta\\eta$, where $h_{\\xi,i,j}$ and $h_{\\eta,i,j}$ are the scale factors evaluated at the cell center $(\\xi_i, \\eta_j)$.\n$$\n(\\nabla \\cdot \\mathbf{u})_{i,j} \\, A_{i,j} \\approx \\iint_{V_{i,j}} (\\nabla \\cdot \\mathbf{u}) \\, h_\\xi h_\\eta \\, d\\xi d\\eta\n$$\n\nFor the right-hand side, we apply the divergence theorem (or fundamental theorem of calculus in each direction):\n$$\n\\text{RHS} = \\int_{\\eta_j - \\Delta\\eta/2}^{\\eta_j + \\Delta\\eta/2} \\left[ (h_\\eta u_\\xi)\\big|_{\\xi_i+\\frac{\\Delta\\xi}{2}} - (h_\\eta u_\\xi)\\big|_{\\xi_i-\\frac{\\Delta\\xi}{2}} \\right] d\\eta + \\int_{\\xi_i - \\Delta\\xi/2}^{\\xi_i + \\Delta\\xi/2} \\left[ (h_\\xi u_\\eta)\\big|_{\\eta_j+\\frac{\\Delta\\eta}{2}} - (h_\\xi u_\\eta)\\big|_{\\eta_j-\\frac{\\Delta\\eta}{2}} \\right] d\\xi\n$$\n\nThis expression represents the net flux out of the control volume. Now, we discretize this integral. The Arakawa C-grid staggering places the velocity components on the faces of the control volume:\n- $u_\\xi$ is located at the faces normal to the $\\xi$-direction, which we denote by indices $(i\\pm\\frac{1}{2}, j)$.\n- $u_\\eta$ is located at the faces normal to the $\\eta$-direction, which we denote by indices $(i, j\\pm\\frac{1}{2})$.\n\nApproximating the integrals with a midpoint rule, the RHS becomes:\n$$\n\\text{RHS} \\approx \\left[ (h_\\eta u_\\xi)_{i+1/2, j} - (h_\\eta u_\\xi)_{i-1/2, j} \\right] \\Delta\\eta + \\left[ (h_\\xi u_\\eta)_{i, j+1/2} - (h_\\xi u_\\eta)_{i, j-1/2} \\right] \\Delta\\xi\n$$\nHere, the flux term $(h_\\eta u_\\xi)_{i+1/2, j}$ is evaluated at the \"right\" face of the cell $(i,j)$, and $(h_\\xi u_\\eta)_{i, j+1/2}$ is evaluated at the \"top\" face. The velocity components $u_\\xi$ and $u_\\eta$ are already defined at these locations. The scale factors $h_\\xi$ and $h_\\eta$ are given as continuous functions and must be evaluated at the corresponding face locations to maintain consistency.\n\nEquating the two sides and solving for the discrete divergence $(\\nabla \\cdot \\mathbf{u})_{i,j}$:\n$$\n(\\nabla \\cdot \\mathbf{u})_{i,j} \\approx \\frac{1}{A_{i,j}} \\left( \\left[ (h_\\eta u_\\xi)_{i+1/2, j} - (h_\\eta u_\\xi)_{i-1/2, j} \\right] \\Delta\\eta + \\left[ (h_\\xi u_\\eta)_{i, j+1/2} - (h_\\xi u_\\eta)_{i, j-1/2} \\right] \\Delta\\xi \\right)\n$$\nSubstituting $A_{i,j} \\approx h_{\\xi,i,j} h_{\\eta,i,j} \\Delta\\xi \\Delta\\eta$ and simplifying, we arrive at the final discrete formula:\n$$\n(\\nabla \\cdot \\mathbf{u})_{i,j} = \\frac{1}{h_{\\xi,i,j} h_{\\eta,i,j}} \\left( \\frac{(h_\\eta u_\\xi)_{i+1/2, j} - (h_\\eta u_\\xi)_{i-1/2, j}}{\\Delta\\xi} + \\frac{(h_\\xi u_\\eta)_{i, j+1/2} - (h_\\xi u_\\eta)_{i, j-1/2}}{\\Delta\\eta} \\right)\n$$\nThis formula is a second-order accurate, centered finite-difference approximation of the original differential operator, derived from conservative finite-volume principles.\n\n### Step 2: Implementation and Conservation\nFor implementation, we use zero-based array indexing. Let `u[i, j]` correspond to $u_{\\xi}$ at $(\\xi^{(u)}_i, \\eta_j)$ and `v[i, j]` to $u_{\\eta}$ at $(\\xi_i, \\eta^{(v)}_j)$. The face at $i+1/2$ for cell `(i,j)` corresponds to index $i+1$, and the face at $j+1/2$ corresponds to index $j+1$. With periodic boundary conditions, these indices are wrapped around using the modulo operator. For a `numpy` implementation, `np.roll` is the natural choice for this operation.\n\nThe flux in the $\\xi$-direction at the left face of cell `(i,j)` is $F_{\\xi,i,j} = (h_\\eta u_\\xi)|_{(\\xi^{(u)}_i, \\eta_j)}$. The flux at the right face is $F_{\\xi,i+1,j}$.\nThe discrete divergence for cell `(i,j)` is then:\n$$\nD_{i,j} = \\frac{1}{h_{\\xi,i,j} h_{\\eta,i,j}} \\left( \\frac{F_{\\xi,i+1,j} - F_{\\xi,i,j}}{\\Delta\\xi} + \\frac{F_{\\eta,i,j+1} - F_{\\eta,i,j}}{\\Delta\\eta} \\right)\n$$\n(using wrapped indices for $i+1$ and $j+1$).\n\nA key property of this scheme is its conservation. For a periodic domain, the global integral of the divergence must be zero. We can verify this for our discrete operator by computing the area-weighted sum of the divergence over all cells:\n$$\n\\sum_{i,j} D_{i,j} A_{i,j} = \\sum_{i,j} \\left( \\left[ F_{\\xi, i+1/2, j} - F_{\\xi, i-1/2, j} \\right] \\Delta\\eta + \\left[ F_{\\eta, i, j+1/2} - F_{\\eta, i, j-1/2} \\right] \\Delta\\xi \\right)\n$$\nThe sum $\\sum_i (F_{\\xi, i+1/2, j} - F_{\\xi, i-1/2, j})$ for a fixed $j$ is a telescoping series. Due to periodicity, the flux leaving the last cell in the row re-enters the first cell, causing the sum to be exactly zero. The same logic applies to the sum over $j$. Therefore, the total area-weighted sum is zero, confirming the conservative nature of the scheme. This is tested in Case D, where we expect the result to be zero up to machine precision.\n\nThe implementation will proceed by defining the grids, evaluating the scale factors and velocity fields at the required staggered locations, computing the fluxes, and then applying the final divergence formula.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the Arakawa C-grid divergence problem for four test cases.\n    \"\"\"\n\n    def divergence_op(u, v, h_eta_u, h_xi_v, h_xi_c, h_eta_c, dxi, dyi):\n        \"\"\"\n        Computes the discrete divergence on an Arakawa C-grid.\n        \n        Args:\n            u (np.ndarray): u-velocity component at xi-faces.\n            v (np.ndarray): v-velocity component at eta-faces.\n            h_eta_u (np.ndarray): arakawa grid scale factor h_eta at u-points.\n            h_xi_v (np.ndarray): scale factor h_xi at v-points.\n            h_xi_c (np.ndarray): scale factor h_xi at cell centers.\n            h_eta_c (np.ndarray): scale factor h_eta at cell centers.\n            dxi (float): Grid spacing in xi.\n            dyi (float): Grid spacing in eta.\n            \n        Returns:\n            np.ndarray: Discrete divergence at cell centers.\n        \"\"\"\n        # Fluxes are F_xi = h_eta * u, F_eta = h_xi * v\n        flux_xi = h_eta_u * u\n        flux_eta = h_xi_v * v\n\n        # Difference of fluxes across cell boundaries using periodic wrapping\n        # np.roll(A, -1, axis=0) gets the (i+1) element for each i\n        flux_xi_diff = (np.roll(flux_xi, -1, axis=0) - flux_xi) / dxi\n        # np.roll(A, -1, axis=1) gets the (j+1) element for each j\n        flux_eta_diff = (np.roll(flux_eta, -1, axis=1) - flux_eta) / dyi\n\n        # Combine terms and divide by cell area factor\n        divergence = (1.0 / (h_xi_c * h_eta_c)) * (flux_xi_diff + flux_eta_diff)\n        \n        return divergence\n\n    results = []\n    \n    # --- Case A: Uniform grid, constant flow ---\n    Nx, Ny = 16, 16\n    U0 = 3.0\n    dxi, dyi = 1.0/Nx, 1.0/Ny\n    \n    u = np.full((Nx, Ny), U0)\n    v = np.zeros((Nx, Ny))\n    \n    h_xi = np.ones((Nx, Ny))\n    h_eta = np.ones((Nx, Ny))\n    \n    # In uniform grid, all h factors are 1\n    div_A = divergence_op(u, v, h_eta, h_xi, h_xi, h_eta, dxi, dyi)\n    results.append(np.max(np.abs(div_A)))\n\n    # --- Case B: Curvilinear grid, divergence-free field ---\n    Nx, Ny = 32, 24\n    a = 0.3\n    dxi, dyi = 1.0/Nx, 1.0/Ny\n\n    # Grid coordinates\n    xi_c = (np.arange(Nx) + 0.5) / Nx\n    eta_c = (np.arange(Ny) + 0.5) / Ny\n    XI_c, ETA_c = np.meshgrid(xi_c, eta_c, indexing='ij')\n\n    xi_u = np.arange(Nx) / Nx\n    XI_u, ETA_u = np.meshgrid(xi_u, eta_c, indexing='ij')\n\n    eta_v = np.arange(Ny) / Ny\n    XI_v, ETA_v = np.meshgrid(xi_c, eta_v, indexing='ij')\n\n    # Scale factor functions\n    h_xi_fn = lambda xi, eta: 1.0 + a * np.sin(2 * np.pi * xi) * np.cos(2 * np.pi * eta)\n    h_eta_fn = lambda xi, eta: 1.0 + a * np.cos(2 * np.pi * xi) * np.sin(2 * np.pi * eta)\n\n    # Scale factors on staggered grids\n    h_xi_c = h_xi_fn(XI_c, ETA_c)\n    h_eta_c = h_eta_fn(XI_c, ETA_c)\n    h_eta_u = h_eta_fn(XI_u, ETA_u)\n    h_xi_v = h_xi_fn(XI_v, ETA_v)\n\n    # Velocity components from streamfunction psi = sin(2*pi*xi)*sin(2*pi*eta)\n    # u_xi = (1/h_eta) * d(psi)/d(eta)\n    u = (1.0 / h_eta_u) * (2 * np.pi * np.sin(2 * np.pi * XI_u) * np.cos(2 * np.pi * ETA_u))\n    # u_eta = -(1/h_xi) * d(psi)/d(xi)\n    v = -(1.0 / h_xi_v) * (2 * np.pi * np.cos(2 * np.pi * XI_v) * np.sin(2 * np.pi * ETA_v))\n\n    div_B = divergence_op(u, v, h_eta_u, h_xi_v, h_xi_c, h_eta_c, dxi, dyi)\n    results.append(np.sqrt(np.mean(div_B**2)))\n\n\n    # --- Case C: Uniform grid, analytic divergence ---\n    Nx, Ny = 3, 3\n    dxi, dyi = 1.0 / Nx, 1.0 / Ny\n\n    # Grid coordinates\n    xi_c = (np.arange(Nx) + 0.5) / Nx\n    eta_c = (np.arange(Ny) + 0.5) / Ny\n    XI_c, ETA_c = np.meshgrid(xi_c, eta_c, indexing='ij')\n\n    xi_u = np.arange(Nx) / Nx\n    XI_u, ETA_u_dummy = np.meshgrid(xi_u, eta_c, indexing='ij') # eta is dummy here\n\n    eta_v = np.arange(Ny) / Ny\n    XI_v_dummy, ETA_v = np.meshgrid(xi_c, eta_v, indexing='ij') # xi is dummy here\n    \n    # Velocity fields\n    u = np.sin(2 * np.pi * XI_u)\n    v = np.sin(2 * np.pi * ETA_v)\n    \n    # Scale factors are all 1\n    h_xi_c_C = np.ones((Nx, Ny))\n    h_eta_c_C = np.ones((Nx, Ny))\n    h_eta_u_C = np.ones((Nx, Ny))\n    h_xi_v_C = np.ones((Nx, Ny))\n\n    # Discrete divergence\n    div_C_discrete = divergence_op(u, v, h_eta_u_C, h_xi_v_C, h_xi_c_C, h_eta_c_C, dxi, dyi)\n\n    # Analytic divergence: 2*pi*cos(2*pi*xi) + 2*pi*cos(2*pi*eta)\n    div_C_analytic = 2 * np.pi * np.cos(2 * np.pi * XI_c) + 2 * np.pi * np.cos(2 * np.pi * ETA_c)\n    \n    rms_error = np.sqrt(np.mean((div_C_discrete - div_C_analytic)**2))\n    results.append(rms_error)\n    \n    # --- Case D: Curvilinear grid, conservation check ---\n    Nx, Ny = 17, 19\n    a = 0.3\n    dxi, dyi = 1.0/Nx, 1.0/Ny\n    \n    # Deterministic seed for reproducibility\n    np.random.seed(0)\n\n    # Grid coordinates\n    xi_c = (np.arange(Nx) + 0.5) / Nx\n    eta_c = (np.arange(Ny) + 0.5) / Ny\n    XI_c, ETA_c = np.meshgrid(xi_c, eta_c, indexing='ij')\n\n    xi_u = np.arange(Nx) / Nx\n    XI_u, ETA_u = np.meshgrid(xi_u, eta_c, indexing='ij')\n\n    eta_v = np.arange(Ny) / Ny\n    XI_v, ETA_v = np.meshgrid(xi_c, eta_v, indexing='ij')\n    \n    # Scale factors on staggered grids\n    h_xi_c = h_xi_fn(XI_c, ETA_c)\n    h_eta_c = h_eta_fn(XI_c, ETA_c)\n    h_eta_u = h_eta_fn(XI_u, ETA_u)\n    h_xi_v = h_xi_fn(XI_v, ETA_v)\n    \n    # Random velocity fields\n    u = np.random.rand(Nx, Ny)\n    v = np.random.rand(Nx, Ny)\n    \n    div_D = divergence_op(u, v, h_eta_u, h_xi_v, h_xi_c, h_eta_c, dxi, dyi)\n    \n    # Area-weighted mean divergence\n    cell_area = h_xi_c * h_eta_c * dxi * dyi\n    total_area = np.sum(cell_area)\n    \n    # Numerator is the sum of (divergence * cell_area) over the domain\n    # This should be zero to machine precision due to conservation\n    integrated_div = np.sum(div_D * cell_area)\n    \n    mean_div = integrated_div / total_area\n    results.append(np.abs(mean_div))\n\n    # Format output as requested\n    print(f\"[{','.join(f'{r:.18e}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Our final practice delves into the 'why' behind grid staggering by applying it to the projection method, a fundamental algorithm for incompressible flows. By implementing the method on both a non-staggered A-grid and a staggered C-grid, you will directly observe the benefits of staggering in preventing numerical instabilities and ensuring a tight coupling between pressure and velocity. This comparative analysis is key to understanding the design choices behind many state-of-the-art environmental models.",
            "id": "3862986",
            "problem": "Consider the incompressible momentum equations under the Boussinesq approximation with constant density, where the velocity field is constrained by the divergence-free condition. The core constraint is that the velocity field $\\mathbf{u} = (u, v)$ must satisfy $\\nabla \\cdot \\mathbf{u} = 0$. In projection methods for incompressible flow, one computes an intermediate velocity $\\mathbf{u}^{\\ast}$ that does not necessarily satisfy the divergence-free constraint, and then projects it onto the space of divergence-free fields using a scalar pressure field $p$ such that the corrected velocity $\\mathbf{u}^{n+1}$ is divergence-free. The projection step enforces $\\mathbf{u}^{n+1} = \\mathbf{u}^{\\ast} - \\Delta t \\nabla p$ together with $\\nabla \\cdot \\mathbf{u}^{n+1} = 0$, implying the discrete Poisson equation for the pressure,\n$$\n\\nabla^2 p = \\frac{1}{\\Delta t} \\nabla \\cdot \\mathbf{u}^{\\ast},\n$$\nwith periodic boundary conditions. In Arakawa grid staggering, there are two canonical layouts: the Arakawa A-grid (all prognostic variables at cell centers) and the Arakawa C-grid (pressure at cell centers, the $u$-velocity at vertical cell faces, and the $v$-velocity at horizontal cell faces). For a uniform, two-dimensional, periodic rectangular domain with $N_x \\times N_y$ cells, spacings $\\Delta x$ and $\\Delta y$, and time step $\\Delta t$, implement the projection method on both the Arakawa A-grid and the Arakawa C-grid using discrete operators that respect the layout of each grid:\n- On the Arakawa C-grid, define the discrete divergence at cell centers as differences of face-normal fluxes, and define the discrete gradient as face-normal differences of cell-centered pressure consistent with the divergence operator.\n- On the Arakawa A-grid, define the discrete divergence and gradient at cell centers using second-order central differences consistent with periodic boundary conditions.\n\nUse a periodic discrete Poisson solver to obtain the pressure $p$ at cell centers. The solver must handle the discrete Poisson equation under periodic boundary conditions, including the null space associated with constant modes. Your program must compute, for each test case, the ratio\n$$\nR = \\frac{\\|\\nabla \\cdot \\mathbf{u}^{n+1}\\|_2}{\\|\\nabla \\cdot \\mathbf{u}^{\\ast}\\|_2},\n$$\nwhere $\\|\\cdot\\|_2$ denotes the discrete $\\ell^2$ norm over the set of cell centers. If the denominator is zero, define $R = 0$.\n\nConstruct the intermediate velocities $\\mathbf{u}^{\\ast}$ deterministically and in a way that respects periodicity based on the grid type. For each test, use the following manufactured fields:\n- Arakawa C-grid: $u^{\\ast}$ defined on vertical faces indexed by $(i,j)$ with $i = 0, \\ldots, N_x$ and $j = 0, \\ldots, N_y-1$, and $v^{\\ast}$ defined on horizontal faces indexed by $(i,j)$ with $i = 0, \\ldots, N_x-1$ and $j = 0, \\ldots, N_y$, as\n$$\nu^{\\ast}_{i,j} = \\sin\\left( \\frac{2\\pi i}{N_x} \\right) + 0.3 \\cos\\left( \\frac{2\\pi j}{N_y} \\right), \\quad v^{\\ast}_{i,j} = 0.7 \\cos\\left( \\frac{2\\pi i}{N_x} \\right) - \\sin\\left( \\frac{2\\pi j}{N_y} \\right).\n$$\n- Arakawa A-grid: $u^{\\ast}$ and $v^{\\ast}$ defined at cell centers indexed by $(i,j)$ with $i = 0, \\ldots, N_x-1$ and $j = 0, \\ldots, N_y-1$, as\n$$\nu^{\\ast}_{i,j} = \\sin\\left( \\frac{2\\pi i}{N_x} \\right) + 0.3 \\cos\\left( \\frac{2\\pi j}{N_y} \\right), \\quad v^{\\ast}_{i,j} = 0.7 \\cos\\left( \\frac{2\\pi i}{N_x} \\right) - \\sin\\left( \\frac{2\\pi j}{N_y} \\right).\n$$\nThese definitions ensure periodicity. The discrete operators and the projection step must be formulated in a manner that they are adjoint-consistent on the chosen grid, so that $\\nabla^2$ is the divergence of the gradient.\n\nImplement a periodic discrete Poisson solver for cell-centered $p$ using the Fast Fourier Transform (FFT) approach. The solver must explicitly handle the zero wavenumber by choosing the pressure mean to be zero.\n\nTest Suite:\nProvide results for the following four parameter sets. Each test case is a tuple $(\\text{grid\\_type}, N_x, N_y, \\Delta x, \\Delta y, \\Delta t)$ where $\\text{grid\\_type} \\in \\{\\text{\"C\"}, \\text{\"A\"}\\}$:\n1. $(\\text{\"C\"}, 16, 12, 1.0, 2.0, 0.2)$\n2. $(\\text{\"A\"}, 16, 12, 1.0, 2.0, 0.15)$\n3. $(\\text{\"C\"}, 3, 3, 1.3, 0.9, 0.25)$\n4. $(\\text{\"A\"}, 8, 2, 0.8, 1.2, 0.05)$\n\nFinal Output Format:\nYour program should produce a single line of output containing the values of $R$ for the four test cases, as a comma-separated list enclosed in square brackets (e.g., \"[r1,r2,r3,r4]\"). No physical units are required; all quantities are dimensionless. All angles, where present in trigonometric functions, are in radians by construction of the discrete operators. The output values must be floating-point numbers.",
            "solution": "The problem requires the implementation of a projection method to enforce the incompressibility constraint on a velocity field in a two-dimensional, periodic domain. This is a fundamental technique in computational fluid dynamics for simulating incompressible flows. The method's efficacy is to be evaluated on two different grid staggering arrangements: the Arakawa A-grid (collocated) and the Arakawa C-grid (staggered). The performance metric is the ratio $R$ of the $\\ell^2$ norm of the velocity divergence after the projection to its norm before the projection.\n\nThe projection method is a fractional step algorithm. Given an intermediate velocity field $\\mathbf{u}^{\\ast} = (u^{\\ast}, v^{\\ast})$ at a time step, which is not necessarily divergence-free, the goal is to find a correction involving a scalar pressure field $p$ such that the final velocity field $\\mathbf{u}^{n+1}$ is divergence-free. This is achieved by projecting $\\mathbf{u}^{\\ast}$ onto the space of divergence-free vector fields. The projection is defined by two conditions:\n$1$. The velocity is updated via a pressure gradient:\n$$ \\mathbf{u}^{n+1} = \\mathbf{u}^{\\ast} - \\Delta t \\nabla p $$\nwhere $\\Delta t$ is the time step.\n$2$. The final velocity field must be divergence-free:\n$$ \\nabla \\cdot \\mathbf{u}^{n+1} = 0 $$\nTaking the divergence of the first equation and substituting the second gives:\n$$ \\nabla \\cdot (\\mathbf{u}^{\\ast} - \\Delta t \\nabla p) = 0 $$\n$$ \\nabla \\cdot \\mathbf{u}^{\\ast} - \\Delta t \\nabla^2 p = 0 $$\nThis yields a Poisson equation for the pressure field $p$:\n$$ \\nabla^2 p = \\frac{1}{\\Delta t} \\nabla \\cdot \\mathbf{u}^{\\ast} $$\nThe solution of this equation provides the pressure required to project the velocity field onto the divergence-free subspace. The problem specifies periodic boundary conditions for a rectangular domain of size $N_x \\times N_y$ cells with grid spacings $\\Delta x$ and $\\Delta y$.\n\nThe discretization of the divergence ($\\nabla \\cdot$), gradient ($\\nabla$), and Laplacian ($\\nabla^2$) operators depends on the grid layout.\n\nOn the Arakawa A-grid, all variables ($u, v, p$) are collocated at the cell centers, indexed by $(i,j)$ for $i=0, \\dots, N_x-1$ and $j=0, \\dots, N_y-1$. We use second-order central finite differences for the operators:\nThe divergence of a velocity field $\\mathbf{u}=(u,v)$ at cell $(i,j)$ is:\n$$ (\\nabla \\cdot \\mathbf{u})_{i,j} = \\frac{u_{i+1,j} - u_{i-1,j}}{2 \\Delta x} + \\frac{v_{i,j+1} - v_{i,j-1}}{2 \\Delta y} $$\nThe gradient of a scalar pressure field $p$ at cell $(i,j)$ is:\n$$ (\\nabla p)_{x, i,j} = \\frac{p_{i+1,j} - p_{i-1,j}}{2 \\Delta x}, \\quad (\\nabla p)_{y, i,j} = \\frac{p_{i,j+1} - p_{i,j-1}}{2 \\Delta y} $$\nAll indices are handled periodically (e.g., $u_{N_x, j} = u_{0, j}$, $u_{-1, j} = u_{N_x-1, j}$).\n\nOn the Arakawa C-grid, variables are staggered. Pressure $p$ is at cell centers $(i,j)$. The horizontal velocity component $u$ is on vertical cell faces, indexed here such that $u_{i,j}$ is at the face between cells $(i-1,j)$ and $(i,j)$. The vertical velocity component $v$ is on horizontal cell faces, where $v_{i,j}$ is at the face between cells $(i,j-1)$ and $(i,j)$.\nThe discrete divergence at cell center $(i,j)$ is defined as the net flux from the cell:\n$$ (\\nabla \\cdot \\mathbf{u})_{i,j} = \\frac{u_{i+1,j} - u_{i,j}}{\\Delta x} + \\frac{v_{i,j+1} - v_{i,j}}{\\Delta y} $$\nThe discrete gradient of the cell-centered pressure $p$ produces components on the cell faces, consistent with the velocity locations:\n$$ (\\nabla p)_{x, i,j} = \\frac{p_{i,j} - p_{i-1,j}}{\\Delta x}, \\quad (\\nabla p)_{y, i,j} = \\frac{p_{i,j} - p_{i,j-1}}{\\Delta y} $$\nAn important property of the C-grid staggering is that the discrete Laplacian, formed by composing the divergence and gradient operators ($\\nabla^2 = \\nabla \\cdot \\nabla$), results in the standard five-point stencil, identical to the A-grid's second-order centered Laplacian:\n$$ (\\nabla^2 p)_{i,j} = \\frac{p_{i+1,j} - 2 p_{i,j} + p_{i-1,j}}{(\\Delta x)^2} + \\frac{p_{i,j+1} - 2 p_{i,j} + p_{i,j-1}}{(\\Delta y)^2} $$\nThis adjoint consistency is a key advantage of the C-grid.\n\nFor both grids, the intermediate velocity field $\\mathbf{u}^{\\ast}$ is given by a manufactured solution. The locations for these fields are specified by the problem:\nFor the A-grid, $u^{\\ast}$ and $v^{\\ast}$ are defined at cell centers $(i,j)$:\n$$ u^{\\ast}_{i,j} = \\sin\\left( \\frac{2\\pi i}{N_x} \\right) + 0.3 \\cos\\left( \\frac{2\\pi j}{N_y} \\right), \\quad v^{\\ast}_{i,j} = 0.7 \\cos\\left( \\frac{2\\pi i}{N_x} \\right) - \\sin\\left( \\frac{2\\pi j}{N_y} \\right) $$\nFor the C-grid, $u^{\\ast}$ is defined on vertical faces and $v^{\\ast}$ on horizontal faces, using the same functional forms but on their respective staggered grid coordinates.\n\nThe discrete Poisson equation, $\\hat{L}p = f$ where $\\hat{L}$ is the discrete Laplacian and $f = \\frac{1}{\\Delta t} \\nabla \\cdot \\mathbf{u}^{\\ast}$, is solved efficiently using the Fast Fourier Transform (FFT). Applying a 2D discrete Fourier transform to the equation converts the spatial convolution of the Laplacian into a simple multiplication in Fourier space:\n$$ \\tilde{L}_{m,n} \\tilde{p}_{m,n} = \\tilde{f}_{m,n} $$\nwhere $\\tilde_.$ denotes the Fourier transform and $(m, n)$ are the integer wavenumber indices. The Fourier symbol $\\tilde{L}_{m,n}$ of the five-point Laplacian is:\n$$ \\tilde{L}_{m,n} = -\\frac{4}{(\\Delta x)^2} \\sin^2\\left(\\frac{\\pi m}{N_x}\\right) - \\frac{4}{(\\Delta y)^2} \\sin^2\\left(\\frac{\\pi n}{N_y}\\right) $$\nFor the zero-wavenumber mode $(m,n)=(0,0)$, $\\tilde{L}_{0,0} = 0$. This reflects the fact that the pressure solution is unique only up to an arbitrary constant. The problem specifies resolving this ambiguity by enforcing a zero-mean pressure, which corresponds to setting the zero-wavenumber component of its Fourier transform to zero: $\\tilde{p}_{0,0} = 0$. For all other modes $(m,n) \\neq (0,0)$, the pressure in Fourier space is $\\tilde{p}_{m,n} = \\tilde{f}_{m,n} / \\tilde{L}_{m,n}$. The pressure field $p$ is then recovered by applying an inverse 2D FFT.\n\nThe overall algorithm for each test case is as follows:\n$1$. Construct the intermediate velocity fields $u^{\\ast}$ and $v^{\\ast}$ on the appropriate grid (A or C).\n$2$. Compute the initial divergence field $D^{\\ast} = \\nabla \\cdot \\mathbf{u}^{\\ast}$ using the grid-appropriate discrete divergence operator.\n$3$. Calculate the denominator of the ratio: $\\|\\nabla \\cdot \\mathbf{u}^{\\ast}\\|_2 = \\|D^{\\ast}\\|_2$. If this norm is zero, $R=0$.\n$4$. Solve the discrete Poisson equation $\\nabla^2 p = \\frac{1}{\\Delta t} D^{\\ast}$ for $p$ using the FFT-based solver.\n$5$. Compute the pressure gradient $\\nabla p$ using the grid-appropriate discrete gradient operator.\n$6$. Calculate the projected velocity field: $\\mathbf{u}^{n+1} = \\mathbf{u}^{\\ast} - \\Delta t \\nabla p$.\n$7$. Compute the final divergence field $D^{n+1} = \\nabla \\cdot \\mathbf{u}^{n+1}$.\n$8$. Calculate the numerator of the ratio: $\\|\\nabla \\cdot \\mathbf{u}^{n+1}\\|_2 = \\|D^{n+1}\\|_2$.\n$9$. Compute the final ratio $R = \\|\\nabla \\cdot \\mathbf{u}^{n+1}\\|_2 / \\|\\nabla \\cdot \\mathbf{u}^{\\ast}\\|_2$. This ratio should be close to floating-point zero, indicating a successful projection.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function that iterates through test cases and prints the results.\n    \"\"\"\n    test_cases = [\n        (\"C\", 16, 12, 1.0, 2.0, 0.2),\n        (\"A\", 16, 12, 1.0, 2.0, 0.15),\n        (\"C\", 3, 3, 1.3, 0.9, 0.25),\n        (\"A\", 8, 2, 0.8, 1.2, 0.05),\n    ]\n\n    results = []\n    for case in test_cases:\n        grid_type, Nx, Ny, dx, dy, dt = case\n        \n        # --- 1. Construct intermediate velocity fields u* ---\n        if grid_type == \"A\":\n            # Collocated grid: u*, v*, p are at cell centers (Nx, Ny)\n            i_coords, j_coords = np.mgrid[0:Nx, 0:Ny]\n            u_star = np.sin(2 * np.pi * i_coords / Nx) + 0.3 * np.cos(2 * np.pi * j_coords / Ny)\n            v_star = 0.7 * np.cos(2 * np.pi * i_coords / Nx) - np.sin(2 * np.pi * j_coords / Ny)\n        elif grid_type == \"C\":\n            # Staggered grid: p at centers, u on vertical faces, v on horizontal faces\n            # u* on vertical faces: (Nx+1, Ny) with u[0,:]=u[Nx,:]\n            i_u, j_u = np.mgrid[0:Nx + 1, 0:Ny]\n            u_star = np.sin(2 * np.pi * i_u / Nx) + 0.3 * np.cos(2 * np.pi * j_u / Ny)\n            # v* on horizontal faces: (Nx, Ny+1) with v[:,0]=v[:,Ny]\n            i_v, j_v = np.mgrid[0:Nx, 0:Ny + 1]\n            v_star = 0.7 * np.cos(2 * np.pi * i_v / Nx) - np.sin(2 * np.pi * j_v / Ny)\n\n        # --- 2. Compute initial divergence div(u*) ---\n        if grid_type == \"A\":\n            du_dx = (np.roll(u_star, -1, axis=0) - np.roll(u_star, 1, axis=0)) / (2 * dx)\n            dv_dy = (np.roll(v_star, -1, axis=1) - np.roll(v_star, 1, axis=1)) / (2 * dy)\n            div_u_star = du_dx + dv_dy\n        elif grid_type == \"C\":\n            du_dx = (u_star[1:, :] - u_star[:-1, :]) / dx\n            dv_dy = (v_star[:, 1:] - v_star[:, :-1]) / dy\n            div_u_star = du_dx + dv_dy\n\n        # --- 3. Compute L2 norm of initial divergence ---\n        norm_div_u_star = np.linalg.norm(div_u_star)\n        if norm_div_u_star == 0.0:\n            results.append(0.0)\n            continue\n            \n        # --- 4. Solve Poisson equation for pressure p ---\n        # Right-hand side of the Poisson equation\n        rhs = div_u_star / dt\n        \n        # FFT of the RHS\n        rhs_tilde = np.fft.fft2(rhs)\n        \n        # Wavenumbers for the FFT\n        m = np.fft.fftfreq(Nx) * Nx\n        n = np.fft.fftfreq(Ny) * Ny\n        mm, nn = np.meshgrid(m, n, indexing='ij')\n\n        # Fourier symbol of the Laplacian operator\n        laplacian_tilde = (-4 / (dx**2)) * np.sin(np.pi * mm / Nx)**2 \\\n                        + (-4 / (dy**2)) * np.sin(np.pi * nn / Ny)**2\n        \n        # Avoid division by zero for the zero-wavenumber mode\n        laplacian_tilde[0, 0] = 1.0\n        \n        # Solve for p in Fourier space\n        p_tilde = rhs_tilde / laplacian_tilde\n        \n        # Enforce zero mean pressure\n        p_tilde[0, 0] = 0.0\n        \n        # Inverse FFT to get pressure in physical space\n        p = np.fft.ifft2(p_tilde).real\n\n        # --- 5. Compute pressure gradient grad(p) ---\n        if grid_type == \"A\":\n            grad_p_x = (np.roll(p, -1, axis=0) - np.roll(p, 1, axis=0)) / (2 * dx)\n            grad_p_y = (np.roll(p, -1, axis=1) - np.roll(p, 1, axis=1)) / (2 * dy)\n        elif grid_type == \"C\":\n            # Gradient on x-faces\n            grad_p_x = (p - np.roll(p, 1, axis=0)) / dx\n            # Extend to be periodic with shape (Nx+1, Ny)\n            grad_p_x = np.concatenate((grad_p_x, grad_p_x[0:1, :]), axis=0)\n\n            # Gradient on y-faces\n            grad_p_y = (p - np.roll(p, 1, axis=1)) / dy\n            # Extend to be periodic with shape (Nx, Ny+1)\n            grad_p_y = np.concatenate((grad_p_y, grad_p_y[:, 0:1]), axis=1)\n\n        # --- 6. Update velocity to be u_new = u_star - dt*grad(p) ---\n        u_new = u_star - dt * grad_p_x\n        v_new = v_star - dt * grad_p_y\n\n        # --- 7. Compute final divergence div(u_new) ---\n        if grid_type == \"A\":\n            du_dx_new = (np.roll(u_new, -1, axis=0) - np.roll(u_new, 1, axis=0)) / (2 * dx)\n            dv_dy_new = (np.roll(v_new, -1, axis=1) - np.roll(v_new, 1, axis=1)) / (2 * dy)\n            div_u_new = du_dx_new + dv_dy_new\n        elif grid_type == \"C\":\n            du_dx_new = (u_new[1:, :] - u_new[:-1, :]) / dx\n            dv_dy_new = (v_new[:, 1:] - v_new[:, :-1]) / dy\n            div_u_new = du_dx_new + dv_dy_new\n\n        # --- 8. Compute L2 norm of final divergence ---\n        norm_div_u_new = np.linalg.norm(div_u_new)\n\n        # --- 9. Compute the ratio R ---\n        ratio = norm_div_u_new / norm_div_u_star\n        results.append(ratio)\n        \n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}