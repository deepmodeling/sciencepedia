{
    "hands_on_practices": [
        {
            "introduction": "在编写代码之前，理解我们打算使用的离散算子的数学特性至关重要。本练习将通过傅里叶分析，深入探讨 Arakawa C-网格上的离散拉普拉斯算子。这一分析有助于我们理解网格如何表示不同尺度的波，并且是分析数值稳定性和求解器性能的基础。",
            "id": "4052174",
            "problem": "考虑一个水平双周期域，其长度分别为 $L_{x}$ 和 $L_{y}$，由一个具有 $N_{x}$ 和 $N_{y}$ 个点的均匀直线网格离散化，因此网格间距为 $h_{x} = L_{x}/N_{x}$ 和 $h_{y} = L_{y}/N_{y}$。在 Arakawa C-网格交错布局中，标量场 $p$（例如，压力）存储在网格单元中心 $(i,j)$，速度的 $x$ 分量 $u$ 存储在东西向的面上中心 $(i+\\tfrac{1}{2},j)$，速度的 $y$ 分量 $v$ 存储在南北向的面上中心 $(i,j+\\tfrac{1}{2})$，其中整数索引 $i \\in \\{0,\\dots,N_{x}-1\\}$ 且 $j \\in \\{0,\\dots,N_{y}-1\\}$。定义标准的二阶中心离散梯度，它将网格中心上的 $p$ 映射到面中心上的分量，如下所示：\n$$\nG_{x} p\\big|_{i+\\tfrac{1}{2},j} = \\frac{p_{i+1,j} - p_{i,j}}{h_{x}}, \\qquad\nG_{y} p\\big|_{i,j+\\tfrac{1}{2}} = \\frac{p_{i,j+1} - p_{i,j}}{h_{y}},\n$$\n以及标准的二阶中心离散散度，它将面中心上的 $(u,v)$ 映射到网格中心上，如下所示：\n$$\nD_{x} u\\big|_{i,j} = \\frac{u_{i+\\tfrac{1}{2},j} - u_{i-\\tfrac{1}{2},j}}{h_{x}}, \\qquad\nD_{y} v\\big|_{i,j} = \\frac{v_{i,j+\\tfrac{1}{2}} - v_{i,j-\\tfrac{1}{2}}}{h_{y}}.\n$$\n作用于 $p$ 的 C-网格离散拉普拉斯算子定义为散度与梯度的复合：\n$$\n\\Delta_{C} p\\big|_{i,j} = D_{x}\\!\\left(G_{x} p\\right)\\big|_{i,j} + D_{y}\\!\\left(G_{y} p\\right)\\big|_{i,j},\n$$\n相关的、作用于 $p$ 的离散亥姆霍兹算子为：\n$$\nH p\\big|_{i,j} = p_{i,j} - \\lambda\\, \\Delta_{C} p\\big|_{i,j},\n$$\n其中 $\\lambda > 0$ 是一个常数参数。假设在两个方向上都采用周期性边界条件，并考虑离散傅里叶模态：\n$$\np_{i,j} = \\exp\\!\\big( \\mathrm{i} (k_{x}\\, i\\, h_{x} + k_{y}\\, j\\, h_{y}) \\big),\n$$\n其波数 $k_{x}$ 和 $k_{y}$ 取自与周期性一致的离散集合。仅使用离散位移算子的基本基底和离散傅里叶分析，推导出 $\\Delta_{C}$ 的离散傅里叶符号，并由此推导出 $H$ 的离散傅里叶符号，并确定 $H$ 的条件数（定义为网格所允许的所有离散波数上的最大特征值与最小特征值之比）。\n\n以 $\\lambda$、$h_{x}$ 和 $h_{y}$ 的单个闭式解析表达式形式给出最终的条件数。无需进行数值计算。该域适用于数值天气预报（NWP）和气候建模；确保所有步骤在科学上与上述 C-网格交错布局一致。最终答案必须是单个表达式，且不得包含任何单位。",
            "solution": "经评估，问题陈述有效。它在地球物理流体动力学的数值方法领域具有科学依据，问题适定、客观且内部一致。我们可以开始求解。\n\n任务的核心是通过傅里叶分析确定离散亥姆霍兹算子 $H$ 的特征值，然后求出最大特征值与最小特征值之比。\n\n首先，我们写出作用于定义在网格中心 $(i,j)$ 的标量场 $p$ 上的 Arakawa C-网格离散拉普拉斯算子 $\\Delta_C$ 的显式形式。该算子定义为离散散度 $D = (D_x, D_y)$ 和离散梯度 $G = (G_x, G_y)$ 的复合：\n$$\n\\Delta_{C} p\\big|_{i,j} = D_{x}\\!\\left(G_{x} p\\right)\\big|_{i,j} + D_{y}\\!\\left(G_{y} p\\right)\\big|_{i,j}\n$$\n我们使用给定的定义展开每一项。$x$ 分量是：\n$$\nD_{x}\\!\\left(G_{x} p\\right)\\big|_{i,j} = \\frac{(G_x p)\\big|_{i+\\tfrac{1}{2},j} - (G_x p)\\big|_{i-\\tfrac{1}{2},j}}{h_{x}}\n$$\n代入离散梯度 $G_x$ 的定义：\n$$\n(G_x p)\\big|_{i+\\tfrac{1}{2},j} = \\frac{p_{i+1,j} - p_{i,j}}{h_{x}} \\quad \\text{和} \\quad (G_x p)\\big|_{i-\\tfrac{1}{2},j} = \\frac{p_{i,j} - p_{i-1,j}}{h_{x}}\n$$\n将这些合并得到：\n$$\nD_{x}\\!\\left(G_{x} p\\right)\\big|_{i,j} = \\frac{1}{h_{x}} \\left( \\frac{p_{i+1,j} - p_{i,j}}{h_{x}} - \\frac{p_{i,j} - p_{i-1,j}}{h_{x}} \\right) = \\frac{p_{i+1,j} - 2p_{i,j} + p_{i-1,j}}{h_{x}^2}\n$$\n通过完全相同的推导，得到 $y$ 分量：\n$$\nD_{y}\\!\\left(G_{y} p\\right)\\big|_{i,j} = \\frac{p_{i,j+1} - 2p_{i,j} + p_{i,j-1}}{h_{y}^2}\n$$\n因此，离散拉普拉斯算子由标准的五点模板给出：\n$$\n\\Delta_{C} p\\big|_{i,j} = \\frac{p_{i+1,j} - 2p_{i,j} + p_{i-1,j}}{h_{x}^2} + \\frac{p_{i,j+1} - 2p_{i,j} + p_{i,j-1}}{h_{y}^2}\n$$\n\n接下来，我们通过将此算子应用于单个傅里叶模态 $p_{i,j} = \\exp\\!\\big( \\mathrm{i} (k_{x}\\, i\\, h_{x} + k_{y}\\, j\\, h_{y}) \\big)$ 来进行离散傅里叶分析。网格位移算子对该模态的作用是乘法性的：\n$$\np_{i\\pm 1, j} = \\exp(\\pm \\mathrm{i} k_x h_x) p_{i,j}\n$$\n$$\np_{i, j\\pm 1} = \\exp(\\pm \\mathrm{i} k_y h_y) p_{i,j}\n$$\n将这些代入 $\\Delta_C p_{i,j}$ 的表达式中：\n$$\n\\Delta_C p_{i,j} = \\left( \\frac{\\exp(\\mathrm{i} k_x h_x) - 2 + \\exp(-\\mathrm{i} k_x h_x)}{h_x^2} + \\frac{\\exp(\\mathrm{i} k_y h_y) - 2 + \\exp(-\\mathrm{i} k_y h_y)}{h_y^2} \\right) p_{i,j}\n$$\n使用恒等式 $2\\cos(\\theta) = \\exp(\\mathrm{i}\\theta) + \\exp(-\\mathrm{i}\\theta)$，括号中的表达式简化为：\n$$\n\\frac{2\\cos(k_x h_x) - 2}{h_x^2} + \\frac{2\\cos(k_y h_y) - 2}{h_y^2}\n$$\n使用半角恒等式 $1 - \\cos(\\theta) = 2\\sin^2(\\theta/2)$，这变为：\n$$\n-\\frac{4\\sin^2(k_x h_x/2)}{h_x^2} - \\frac{4\\sin^2(k_y h_y/2)}{h_y^2}\n$$\n这个表达式是算子 $\\Delta_C$ 的离散傅里叶符号，我们记为 $\\widehat{\\Delta_C}(k_x, k_y)$。它是对应于本征模态 $(k_x, k_y)$ 的特征值。\n$$\n\\widehat{\\Delta_C}(k_x, k_y) = -\\frac{4}{h_x^2}\\sin^2\\left(\\frac{k_x h_x}{2}\\right) - \\frac{4}{h_y^2}\\sin^2\\left(\\frac{k_y h_y}{2}\\right)\n$$\n离散亥姆霍兹算子为 $H = I - \\lambda \\Delta_C$，其中 $I$ 是单位算子。它对傅里叶模态 $p_{i,j}$ 的作用产生：\n$$\nH p_{i,j} = (I - \\lambda \\Delta_C) p_{i,j} = p_{i,j} - \\lambda \\widehat{\\Delta_C}(k_x, k_y) p_{i,j} = \\left(1 - \\lambda \\widehat{\\Delta_C}(k_x, k_y)\\right) p_{i,j}\n$$\n因此，$H$ 的特征值 $\\mu(k_x, k_y)$ 由其傅里叶符号 $\\widehat{H}(k_x, k_y)$ 给出：\n$$\n\\mu(k_x, k_y) = 1 - \\lambda \\widehat{\\Delta_C}(k_x, k_y) = 1 + \\frac{4\\lambda}{h_x^2}\\sin^2\\left(\\frac{k_x h_x}{2}\\right) + \\frac{4\\lambda}{h_y^2}\\sin^2\\left(\\frac{k_y h_y}{2}\\right)\n$$\n该算子（或其矩阵表示）的条件数 $\\kappa(H)$ 是其在所有允许波数上的最大特征值与最小特征值之比：\n$$\n\\kappa(H) = \\frac{\\mu_{max}}{\\mu_{min}}\n$$\n周期性网格上允许的波数是 $k_x = 2\\pi m/L_x = 2\\pi m/(N_x h_x)$ 和 $k_y = 2\\pi n/L_y = 2\\pi n/(N_y h_y)$，其中 $m, n$ 为整数。\n\n为了找到最小特征值 $\\mu_{min}$，我们必须最小化 $\\mu(k_x, k_y)$。由于 $\\lambda>0$，当两个 $\\sin^2$ 项都为零时，达到最小值。这发生在零波数模态 $(k_x, k_y) = (0,0)$ 时，它对应于 $(m,n)=(0,0)$，并且始终是一个允许的模态。\n$$\n\\mu_{min} = \\mu(0,0) = 1 + \\frac{4\\lambda}{h_x^2}\\sin^2(0) + \\frac{4\\lambda}{h_y^2}\\sin^2(0) = 1\n$$\n为了找到最大特征值 $\\mu_{max}$，我们必须最大化 $\\mu(k_x, k_y)$。当 $\\sin^2$ 项最大化时，就会出现这种情况。正弦函数的自变量是 $\\frac{k_x h_x}{2} = \\frac{\\pi m}{N_x}$ 和 $\\frac{k_y h_y}{2} = \\frac{\\pi n}{N_y}$。$\\sin^2(\\theta)$ 的最大值是 $1$，在 $\\theta=\\pi/2$ 时达到。这对应于奈奎斯特频率，此时波长是网格间距的两倍。虽然离散网格上的确切最大值取决于 $N_x$ 和 $N_y$ 的奇偶性，但问题要求只用 $\\lambda, h_x, h_y$ 表示的表达式。这意味着我们应该在网格可以解析的连续波数范围（即 $k_x \\in [-\\pi/h_x, \\pi/h_x]$ 和 $k_y \\in [-\\pi/h_y, \\pi/h_y]$）上找到特征值表达式的上确界。在此范围内 $\\sin^2(k_x h_x/2)$ 的上确界是 $1$，在 $k_x = \\pm \\pi/h_x$ 时达到。类似地，$y$ 项的上确界是 $1$。\n$$\n\\mu_{max} = \\sup_{k_x, k_y} \\mu(k_x, k_y) = 1 + \\frac{4\\lambda}{h_x^2}\\sup\\left[\\sin^2\\left(\\frac{k_x h_x}{2}\\right)\\right] + \\frac{4\\lambda}{h_y^2}\\sup\\left[\\sin^2\\left(\\frac{k_y h_y}{2}\\right)\\right]\n$$\n$$\n\\mu_{max} = 1 + \\frac{4\\lambda}{h_x^2}(1) + \\frac{4\\lambda}{h_y^2}(1) = 1 + \\frac{4\\lambda}{h_x^2} + \\frac{4\\lambda}{h_y^2}\n$$\n条件数就是这个比率：\n$$\n\\kappa(H) = \\frac{\\mu_{max}}{\\mu_{min}} = \\frac{1 + \\frac{4\\lambda}{h_x^2} + \\frac{4\\lambda}{h_y^2}}{1} = 1 + 4\\lambda\\left(\\frac{1}{h_x^2} + \\frac{1}{h_y^2}\\right)\n$$\n该表达式给出了用所需参数表示的条件数。",
            "answer": "$$\\boxed{1 + 4\\lambda\\left(\\frac{1}{h_x^2} + \\frac{1}{h_y^2}\\right)}$$"
        },
        {
            "introduction": "现在，我们从理论转向实践。本练习将指导你从质量守恒这一基本物理原理出发，在 C-网格上实现一个关键的算子——散度。该问题进一步将此概念扩展到现代模型中常见的正交曲线坐标系，并包含一个验证其关键守恒性质的测试。",
            "id": "3862994",
            "problem": "您的任务是设计并实现一个用于正交曲线网格的保守有限体积离散散度算子，该算子使用 Arakawa 网格交错，并在几个测试案例上验证其性质。计算必须遵循基于质量守恒的连续性方程的第一性原理。\n\n从不可压缩流在正交曲线坐标 $(\\xi,\\eta)$ 中的连续性方程的微分形式开始，其尺度因子为 $h_\\xi(\\xi,\\eta)$ 和 $h_\\eta(\\xi,\\eta)$：\n$$\n\\nabla \\cdot \\mathbf{u} \\;=\\; \\frac{1}{h_\\xi h_\\eta}\\left(\\frac{\\partial}{\\partial \\xi}\\big(h_\\eta \\, u_\\xi\\big) \\;+\\; \\frac{\\partial}{\\partial \\eta}\\big(h_\\xi \\, u_\\eta\\big)\\right),\n$$\n其中 $u_\\xi$ 和 $u_\\eta$ 分别是与 $\\xi$ 和 $\\eta$ 坐标对齐的逆变速度分量。该关系通过速度场的散度表达了质量守恒，并且是您推导离散算子所必须依据的基础表达式。\n\n使用 Arakawa C-网格交错，其将：\n- 标量场（例如，质量或类压力量，以及本任务中的散度本身）放置在由 $(i,j)$ 索引的网格中心，\n- 与 $\\xi$ 对齐的逆变速度分量 $u_\\xi$ 放置在垂直于 $\\xi$ 方向并沿 $\\eta$ 方向居中的网格面上，由 $(i+\\tfrac{1}{2},j)$ 索引，\n- 与 $\\eta$ 对齐的逆变速度分量 $u_\\eta$ 放置在垂直于 $\\eta$ 方向并沿 $\\xi$ 方向居中的网格面上，由 $(i,j+\\tfrac{1}{2})$ 索引。\n\n假设在单位正方形 $[0,1]\\times[0,1]$ 上，$\\xi$ 和 $\\eta$ 方向均为周期性域，对于整数 $N_x$ 和 $N_y$，其均匀计算间距为 $\\Delta \\xi = 1/N_x$ 和 $\\Delta \\eta = 1/N_y$。尺度因子 $h_\\xi$ 和 $h_\\eta$ 的单位是米/坐标单位，速度分量 $u_\\xi$ 和 $u_\\eta$ 的单位是米/秒，散度 $\\nabla \\cdot \\mathbf{u}$ 必须以 $\\mathrm{s}^{-1}$ 表示。\n\n您的程序必须：\n1. 推导、论证并实现在网格中心处的有限体积离散散度，该散度使用跨网格面的通量，并包含地图因子 $h_\\xi$ 和 $h_\\eta$，以使格式是保守的，且与上述正交曲线散度公式一致。设计必须正确处理带有周期性边界条件的 Arakawa C-网格索引。\n2. 构建以下测试套件并计算指定的误差度量。三角函数中的所有角度均以弧度为单位。对于所有情况，以 $\\mathrm{s}^{-1}$ 为单位报告所要求的输出。\n\n定义网格坐标数组如下：\n- 网格中心坐标：$\\xi_i = \\frac{i+\\tfrac{1}{2}}{N_x}$ for $i = 0,1,\\dots,N_x-1$，和 $\\eta_j = \\frac{j+\\tfrac{1}{2}}{N_y}$ for $j = 0,1,\\dots,N_y-1$。\n- $\\xi$-面坐标：$\\xi^{(u)}_i = \\frac{i}{N_x}$ for $i = 0,1,\\dots,N_x-1$，并沿 $\\eta$ 在 $\\eta_j$ 处居中。\n- $\\eta$-面坐标：$\\eta^{(v)}_j = \\frac{j}{N_y}$ for $j = 0,1,\\dots,N_y-1$，并沿 $\\xi$ 在 $\\xi_i$ 处居中。\n\n通过以下公式定义曲线网格测试的地图因子\n$$\nh_\\xi(\\xi,\\eta) \\;=\\; 1 \\;+\\; a \\,\\sin(2\\pi \\xi)\\,\\cos(2\\pi \\eta), \\quad\nh_\\eta(\\xi,\\eta) \\;=\\; 1 \\;+\\; a \\,\\cos(2\\pi \\xi)\\,\\sin(2\\pi \\eta),\n$$\n其中 $a=0.3$，并对均匀网格测试使用 $h_\\xi = 1$，$h_\\eta = 1$。\n\n定义以下测试案例：\n- 案例 A (均匀网格，恒定流)：$N_x = 16$, $N_y = 16$, $h_\\xi = 1$, $h_\\eta = 1$，在所有 $\\xi$-面上 $u_\\xi = U_0$ 且 $U_0 = 3$ (米/秒)，在所有 $\\eta$-面上 $u_\\eta = 0$。计算所有网格上的最大绝对散度，并以 $\\mathrm{s}^{-1}$ 为单位报告。\n- 案例 B (曲线网格，通过流函数得到的无散度解析场)：$N_x = 32$, $N_y = 24$，使用如上所述的曲线网格 $h_\\xi(\\xi,\\eta)$ 和 $h_\\eta(\\xi,\\eta)$。定义流函数 $\\psi(\\xi,\\eta) = \\sin(2\\pi \\xi)\\,\\sin(2\\pi \\eta)$，并通过 $u_\\xi = \\frac{1}{h_\\eta}\\,\\frac{\\partial \\psi}{\\partial \\eta}$ (在 $\\xi$-面 $(\\xi^{(u)}_i,\\eta_j)$ 求值) 和 $u_\\eta = -\\frac{1}{h_\\xi}\\,\\frac{\\partial \\psi}{\\partial \\xi}$ (在 $\\eta$-面 $(\\xi_i,\\eta^{(v)}_j)$ 求值) 设置逆变分量。计算并报告所有网格上离散散度的均方根，单位为 $\\mathrm{s}^{-1}$。\n- 案例 C (均匀网格，周期性解析散度)：$N_x = 3$, $N_y = 3$, $h_\\xi = 1$, $h_\\eta = 1$，在 $\\xi$-面 $(\\xi^{(u)}_i,\\eta_j)$ 上 $u_\\xi(\\xi,\\eta) = \\sin(2\\pi \\xi)$，在 $\\eta$-面 $(\\xi_i,\\eta^{(v)}_j)$ 上 $u_\\eta(\\xi,\\eta) = \\sin(2\\pi \\eta)$。网格中心处的解析散度为 $\\nabla\\cdot\\mathbf{u} = 2\\pi \\cos(2\\pi \\xi) + 2\\pi \\cos(2\\pi \\eta)$。计算离散散度与解析散度之间的均方根误差，并以 $\\mathrm{s}^{-1}$ 为单位报告。\n- 案例 D (曲线网格，随机周期性速度，守恒性检查)：$N_x = 17$, $N_y = 19$，使用如上所述的曲线网格 $h_\\xi(\\xi,\\eta)$ 和 $h_\\eta(\\xi,\\eta)$，并确定性地为伪随机生成器设定种子。将 $u_\\xi$ 和 $u_\\eta$ 在它们各自的面上生成为独立的随机值。计算面积加权平均散度，定义为\n$$\n\\overline{D} \\;=\\; \\frac{\\sum_{i,j}\\big(\\nabla\\cdot\\mathbf{u}\\big)_{i,j} \\, h_{\\xi,i,j}\\,h_{\\eta,i,j}\\,\\Delta\\xi\\,\\Delta\\eta}{\\sum_{i,j} h_{\\xi,i,j}\\,h_{\\eta,i,j}\\,\\Delta\\xi\\,\\Delta\\eta},\n$$\n并以 $\\mathrm{s}^{-1}$ 为单位报告 $|\\overline{D}|$。\n\n您的程序必须生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，按四个案例的顺序排列：$[\\text{案例A},\\text{案例B},\\text{案例C},\\text{案例D}]$。每个条目都必须是一个以 $\\mathrm{s}^{-1}$ 为单位的浮点数（对于案例 D，由于面积平均，单位也是 $\\mathrm{s}^{-1}$）。不得打印任何其他文本。实现必须是自包含的，不需要用户输入，并遵循精确的带有周期性环绕的 Arakawa C-网格索引。请仔细论证您的计算模板、索引以及如何从给定的基本方程中使用地图因子，而不要在问题陈述中引入快捷公式。",
            "solution": "该问题要求设计和实现一个用于正交曲线网格的保守有限体积散度算子，该算子采用 Arakawa C-网格交错。推导必须基于所提供的连续性方程的微分形式。\n\n### 步骤 1：离散散度算子的推导\n\n有限体积法的基础是守恒定律的积分形式。给定的不可压缩流体连续性方程的微分形式是：\n$$\n\\nabla \\cdot \\mathbf{u} \\;=\\; \\frac{1}{h_\\xi h_\\eta}\\left(\\frac{\\partial}{\\partial \\xi}\\big(h_\\eta \\, u_\\xi\\big) \\;+\\; \\frac{\\partial}{\\partial \\eta}\\big(h_\\xi \\, u_\\eta\\big)\\right)\n$$\n其中 $(\\xi, \\eta)$ 是带有尺度因子 $h_\\xi$ 和 $h_\\eta$ 的正交曲线坐标，而 $\\mathbf{u} = (u_\\xi, u_\\eta)$ 是具有逆变分量的速度矢量。\n\n为了推导有限体积离散化，我们在单个网格单元或控制体积 $V_{i,j}$ 上对该方程进行积分。该单元以坐标 $(\\xi_i, \\eta_j)$ 为中心，在 $\\xi$ 方向上从 $\\xi_i - \\frac{\\Delta\\xi}{2}$ 延伸到 $\\xi_i + \\frac{\\Delta\\xi}{2}$，在 $\\eta$ 方向上从 $\\eta_j - \\frac{\\Delta\\eta}{2}$ 延伸到 $\\eta_j + \\frac{\\Delta\\eta}{2}$。物理空间中的微分面积元为 $dA = h_\\xi h_\\eta d\\xi d\\eta$。\n\n在物理空间中对该方程在一个单元的面积上进行积分，我们得到：\n$$\n\\iint_{V_{i,j}} (\\nabla \\cdot \\mathbf{u}) \\, h_\\xi h_\\eta \\, d\\xi d\\eta = \\iint_{V_{i,j}} \\left(\\frac{\\partial}{\\partial \\xi}\\big(h_\\eta \\, u_\\xi\\big) \\;+\\; \\frac{\\partial}{\\partial \\eta}\\big(h_\\xi \\, u_\\eta\\big)\\right) d\\xi d\\eta\n$$\n\n方程左侧可以通过取网格中心的散度值 $(\\nabla \\cdot \\mathbf{u})_{i,j}$，并将其乘以单元面积 $A_{i,j}$ 来近似。单元面积近似为 $A_{i,j} \\approx h_{\\xi,i,j} h_{\\eta,i,j} \\Delta\\xi \\Delta\\eta$，其中 $h_{\\xi,i,j}$ 和 $h_{\\eta,i,j}$ 是在网格中心 $(\\xi_i, \\eta_j)$ 处求值的尺度因子。\n$$\n(\\nabla \\cdot \\mathbf{u})_{i,j} \\, A_{i,j} \\approx \\iint_{V_{i,j}} (\\nabla \\cdot \\mathbf{u}) \\, h_\\xi h_\\eta \\, d\\xi d\\eta\n$$\n\n对于方程右侧，我们应用散度定理（或在每个方向上的微积分基本定理）：\n$$\n\\text{RHS} = \\int_{\\eta_j - \\Delta\\eta/2}^{\\eta_j + \\Delta\\eta/2} \\left[ (h_\\eta u_\\xi)\\big|_{\\xi_i+\\frac{\\Delta\\xi}{2}} - (h_\\eta u_\\xi)\\big|_{\\xi_i-\\frac{\\Delta\\xi}{2}} \\right] d\\eta + \\int_{\\xi_i - \\Delta\\xi/2}^{\\xi_i + \\Delta\\xi/2} \\left[ (h_\\xi u_\\eta)\\big|_{\\eta_j+\\frac{\\Delta\\eta}{2}} - (h_\\xi u_\\eta)\\big|_{\\eta_j-\\frac{\\Delta\\eta}{2}} \\right] d\\xi\n$$\n\n这个表达式代表了流出控制体积的净通量。现在，我们对此积分进行离散化。Arakawa C-网格交错将速度分量放置在控制体积的面上：\n- $u_\\xi$ 位于垂直于 $\\xi$ 方向的面上，我们用索引 $(i\\pm\\frac{1}{2}, j)$ 表示。\n- $u_\\eta$ 位于垂直于 $\\eta$ 方向的面上，我们用索引 $(i, j\\pm\\frac{1}{2})$ 表示。\n\n使用中点法则近似积分，右侧变为：\n$$\n\\text{RHS} \\approx \\left[ (h_\\eta u_\\xi)_{i+1/2, j} - (h_\\eta u_\\xi)_{i-1/2, j} \\right] \\Delta\\eta + \\left[ (h_\\xi u_\\eta)_{i, j+1/2} - (h_\\xi u_\\eta)_{i, j-1/2} \\right] \\Delta\\xi\n$$\n此处，通量项 $(h_\\eta u_\\xi)_{i+1/2, j}$ 在单元 $(i,j)$ 的“右”面上求值，而 $(h_\\xi u_\\eta)_{i, j+1/2}$ 在“顶”面上求值。速度分量 $u_\\xi$ 和 $u_\\eta$ 已经在这些位置上定义。尺度因子 $h_\\xi$ 和 $h_\\eta$ 作为连续函数给出，必须在相应的面位置进行求值以保持一致性。\n\n令两侧相等并求解离散散度 $(\\nabla \\cdot \\mathbf{u})_{i,j}$：\n$$\n(\\nabla \\cdot \\mathbf{u})_{i,j} \\approx \\frac{1}{A_{i,j}} \\left( \\left[ (h_\\eta u_\\xi)_{i+1/2, j} - (h_\\eta u_\\xi)_{i-1/2, j} \\right] \\Delta\\eta + \\left[ (h_\\xi u_\\eta)_{i, j+1/2} - (h_\\xi u_\\eta)_{i, j-1/2} \\right] \\Delta\\xi \\right)\n$$\n代入 $A_{i,j} \\approx h_{\\xi,i,j} h_{\\eta,i,j} \\Delta\\xi \\Delta\\eta$ 并化简，我们得到最终的离散公式：\n$$\n(\\nabla \\cdot \\mathbf{u})_{i,j} = \\frac{1}{h_{\\xi,i,j} h_{\\eta,i,j}} \\left( \\frac{(h_\\eta u_\\xi)_{i+1/2, j} - (h_\\eta u_\\xi)_{i-1/2, j}}{\\Delta\\xi} + \\frac{(h_\\xi u_\\eta)_{i, j+1/2} - (h_\\xi u_\\eta)_{i, j-1/2}}{\\Delta\\eta} \\right)\n$$\n这个公式是原始微分算子的二阶精确中心有限差分近似，它源于保守有限体积原理。\n\n### 步骤 2：实现与守恒性\n为了实现，我们使用从零开始的数组索引。令 `u[i, j]` 对应于 $(\\xi^{(u)}_i, \\eta_j)$ 处的 $u_{\\xi}$，`v[i, j]` 对应于 $(\\xi_i, \\eta^{(v)}_j)$ 处的 $u_{\\eta}$。对于单元 $(i,j)$，$i+1/2$ 处的面对应索引 $i+1$，$j+1/2$ 处的面对应索引 $j+1$。对于周期性边界条件，这些索引使用模运算符进行环绕处理。对于 `numpy` 实现，`np.roll` 是执行此操作的自然选择。\n\n在单元 `(i,j)` 左侧面上 $\\xi$ 方向的通量是 $F_{\\xi,i,j} = (h_\\eta u_\\xi)|_{(\\xi^{(u)}_i, \\eta_j)}$。右侧面上的通量是 $F_{\\xi,i+1,j}$。\n单元 `(i,j)` 的离散散度则为：\n$$\nD_{i,j} = \\frac{1}{h_{\\xi,i,j} h_{\\eta,i,j}} \\left( \\frac{F_{\\xi,i+1,j} - F_{\\xi,i,j}}{\\Delta\\xi} + \\frac{F_{\\eta,i,j+1} - F_{\\eta,i,j}}{\\Delta\\eta} \\right)\n$$\n（对 $i+1$ 和 $j+1$ 使用环绕索引）。\n\n此格式的一个关键性质是其守恒性。对于一个周期性域，散度的全局积分必须为零。我们可以通过计算所有单元上散度的面积加权和来验证我们的离散算子是否满足此性质：\n$$\n\\sum_{i,j} D_{i,j} A_{i,j} = \\sum_{i,j} \\left( \\left[ F_{\\xi, i+1/2, j} - F_{\\xi, i-1/2, j} \\right] \\Delta\\eta + \\left[ F_{\\eta, i, j+1/2} - F_{\\eta, i, j-1/2} \\right] \\Delta\\xi \\right)\n$$\n对于固定的 $j$，求和 $\\sum_i (F_{\\xi, i+1/2, j} - F_{\\xi, i-1/2, j})$ 是一个伸缩级数。由于周期性，离开行中最后一个单元的通量会重新进入第一个单元，导致总和恰好为零。同样的逻辑也适用于对 $j$ 的求和。因此，总的面积加权和为零，这证实了该格式的保守性。这在案例 D 中进行了测试，我们期望结果在机器精度范围内为零。\n\n实现将按以下步骤进行：定义网格，在所需的交错位置上评估尺度因子和速度场，计算通量，然后应用最终的散度公式。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the Arakawa C-grid divergence problem for four test cases.\n    \"\"\"\n\n    def divergence_op(u, v, h_eta_u, h_xi_v, h_xi_c, h_eta_c, dxi, dyi):\n        \"\"\"\n        Computes the discrete divergence on an Arakawa C-grid.\n        \n        Args:\n            u (np.ndarray): u-velocity component at xi-faces.\n            v (np.ndarray): v-velocity component at eta-faces.\n            h_eta_u (np.ndarray): arakawa grid scale factor h_eta at u-points.\n            h_xi_v (np.ndarray): scale factor h_xi at v-points.\n            h_xi_c (np.ndarray): scale factor h_xi at cell centers.\n            h_eta_c (np.ndarray): scale factor h_eta at cell centers.\n            dxi (float): Grid spacing in xi.\n            dyi (float): Grid spacing in eta.\n            \n        Returns:\n            np.ndarray: Discrete divergence at cell centers.\n        \"\"\"\n        # Fluxes are F_xi = h_eta * u, F_eta = h_xi * v\n        flux_xi = h_eta_u * u\n        flux_eta = h_xi_v * v\n\n        # Difference of fluxes across cell boundaries using periodic wrapping\n        # np.roll(A, -1, axis=0) gets the (i+1) element for each i\n        flux_xi_diff = (np.roll(flux_xi, -1, axis=0) - flux_xi) / dxi\n        # np.roll(A, -1, axis=1) gets the (j+1) element for each j\n        flux_eta_diff = (np.roll(flux_eta, -1, axis=1) - flux_eta) / dyi\n\n        # Combine terms and divide by cell area factor\n        divergence = (1.0 / (h_xi_c * h_eta_c)) * (flux_xi_diff + flux_eta_diff)\n        \n        return divergence\n\n    results = []\n    \n    # --- Case A: Uniform grid, constant flow ---\n    Nx, Ny = 16, 16\n    U0 = 3.0\n    dxi, dyi = 1.0/Nx, 1.0/Ny\n    \n    u = np.full((Nx, Ny), U0)\n    v = np.zeros((Nx, Ny))\n    \n    h_xi = np.ones((Nx, Ny))\n    h_eta = np.ones((Nx, Ny))\n    \n    # In uniform grid, all h factors are 1\n    div_A = divergence_op(u, v, h_eta, h_xi, h_xi, h_eta, dxi, dyi)\n    results.append(np.max(np.abs(div_A)))\n\n    # --- Case B: Curvilinear grid, divergence-free field ---\n    Nx, Ny = 32, 24\n    a = 0.3\n    dxi, dyi = 1.0/Nx, 1.0/Ny\n\n    # Grid coordinates\n    xi_c = (np.arange(Nx) + 0.5) / Nx\n    eta_c = (np.arange(Ny) + 0.5) / Ny\n    XI_c, ETA_c = np.meshgrid(xi_c, eta_c, indexing='ij')\n\n    xi_u = np.arange(Nx) / Nx\n    XI_u, ETA_u = np.meshgrid(xi_u, eta_c, indexing='ij')\n\n    eta_v = np.arange(Ny) / Ny\n    XI_v, ETA_v = np.meshgrid(xi_c, eta_v, indexing='ij')\n\n    # Scale factor functions\n    h_xi_fn = lambda xi, eta: 1.0 + a * np.sin(2 * np.pi * xi) * np.cos(2 * np.pi * eta)\n    h_eta_fn = lambda xi, eta: 1.0 + a * np.cos(2 * np.pi * xi) * np.sin(2 * np.pi * eta)\n\n    # Scale factors on staggered grids\n    h_xi_c = h_xi_fn(XI_c, ETA_c)\n    h_eta_c = h_eta_fn(XI_c, ETA_c)\n    h_eta_u = h_eta_fn(XI_u, ETA_u)\n    h_xi_v = h_xi_fn(XI_v, ETA_v)\n\n    # Velocity components from streamfunction psi = sin(2*pi*xi)*sin(2*pi*eta)\n    # u_xi = (1/h_eta) * d(psi)/d(eta)\n    u = (1.0 / h_eta_u) * (2 * np.pi * np.sin(2 * np.pi * XI_u) * np.cos(2 * np.pi * ETA_u))\n    # u_eta = -(1/h_xi) * d(psi)/d(xi)\n    v = -(1.0 / h_xi_v) * (2 * np.pi * np.cos(2 * np.pi * XI_v) * np.sin(2 * np.pi * ETA_v))\n\n    div_B = divergence_op(u, v, h_eta_u, h_xi_v, h_xi_c, h_eta_c, dxi, dyi)\n    results.append(np.sqrt(np.mean(div_B**2)))\n\n\n    # --- Case C: Uniform grid, analytic divergence ---\n    Nx, Ny = 3, 3\n    dxi, dyi = 1.0 / Nx, 1.0 / Ny\n\n    # Grid coordinates\n    xi_c = (np.arange(Nx) + 0.5) / Nx\n    eta_c = (np.arange(Ny) + 0.5) / Ny\n    XI_c, ETA_c = np.meshgrid(xi_c, eta_c, indexing='ij')\n\n    xi_u = np.arange(Nx) / Nx\n    XI_u, ETA_u_dummy = np.meshgrid(xi_u, eta_c, indexing='ij') # eta is dummy here\n\n    eta_v = np.arange(Ny) / Ny\n    XI_v_dummy, ETA_v = np.meshgrid(xi_c, eta_v, indexing='ij') # xi is dummy here\n    \n    # Velocity fields\n    u = np.sin(2 * np.pi * XI_u)\n    v = np.sin(2 * np.pi * ETA_v)\n    \n    # Scale factors are all 1\n    h_xi_c_C = np.ones((Nx, Ny))\n    h_eta_c_C = np.ones((Nx, Ny))\n    h_eta_u_C = np.ones((Nx, Ny))\n    h_xi_v_C = np.ones((Nx, Ny))\n\n    # Discrete divergence\n    div_C_discrete = divergence_op(u, v, h_eta_u_C, h_xi_v_C, h_xi_c_C, h_eta_c_C, dxi, dyi)\n\n    # Analytic divergence: 2*pi*cos(2*pi*xi) + 2*pi*cos(2*pi*eta)\n    div_C_analytic = 2 * np.pi * np.cos(2 * np.pi * XI_c) + 2 * np.pi * np.cos(2 * np.pi * ETA_c)\n    \n    rms_error = np.sqrt(np.mean((div_C_discrete - div_C_analytic)**2))\n    results.append(rms_error)\n    \n    # --- Case D: Curvilinear grid, conservation check ---\n    Nx, Ny = 17, 19\n    a = 0.3\n    dxi, dyi = 1.0/Nx, 1.0/Ny\n    \n    # Deterministic seed for reproducibility\n    np.random.seed(0)\n\n    # Grid coordinates\n    xi_c = (np.arange(Nx) + 0.5) / Nx\n    eta_c = (np.arange(Ny) + 0.5) / Ny\n    XI_c, ETA_c = np.meshgrid(xi_c, eta_c, indexing='ij')\n\n    xi_u = np.arange(Nx) / Nx\n    XI_u, ETA_u = np.meshgrid(xi_u, eta_c, indexing='ij')\n\n    eta_v = np.arange(Ny) / Ny\n    XI_v, ETA_v = np.meshgrid(xi_c, eta_v, indexing='ij')\n    \n    # Scale factors on staggered grids\n    h_xi_c = h_xi_fn(XI_c, ETA_c)\n    h_eta_c = h_eta_fn(XI_c, ETA_c)\n    h_eta_u = h_eta_fn(XI_u, ETA_u)\n    h_xi_v = h_xi_fn(XI_v, ETA_v)\n    \n    # Random velocity fields\n    u = np.random.rand(Nx, Ny)\n    v = np.random.rand(Nx, Ny)\n    \n    div_D = divergence_op(u, v, h_eta_u, h_xi_v, h_xi_c, h_eta_c, dxi, dyi)\n    \n    # Area-weighted mean divergence\n    cell_area = h_xi_c * h_eta_c * dxi * dyi\n    total_area = np.sum(cell_area)\n    \n    # Numerator is the sum of (divergence * cell_area) over the domain\n    # This should be zero to machine precision due to conservation\n    integrated_div = np.sum(div_D * cell_area)\n    \n    mean_div = integrated_div / total_area\n    results.append(np.abs(mean_div))\n\n    # Format output as requested\n    print(f\"[{','.join(f'{r:.18e}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "最后一个练习将前面所学的概念集成到一个完整而强大的算法中。投影法是模拟不可压缩流的核心技术。本练习要求实现该方法，更重要的是，将 C-网格与并置的 A-网格的性能进行比较，从而生动地展示 C-网格在避免数值伪振荡方面的优势。",
            "id": "3862986",
            "problem": "考虑在 Boussinesq 近似下密度恒定的不可压缩动量方程，其中速度场受无散条件的约束。核心约束是速度场 $\\mathbf{u} = (u, v)$ 必须满足 $\\nabla \\cdot \\mathbf{u} = 0$。在不可压缩流的投影法中，首先计算一个不一定满足无散约束的中间速度 $\\mathbf{u}^{\\ast}$，然后使用一个标量压力场 $p$ 将其投影到无散场空间上，使得校正后的速度 $\\mathbf{u}^{n+1}$ 是无散的。投影步强制满足 $\\mathbf{u}^{n+1} = \\mathbf{u}^{\\ast} - \\Delta t \\nabla p$ 和 $\\nabla \\cdot \\mathbf{u}^{n+1} = 0$，这导出了关于压力的离散泊松方程，\n$$\n\\nabla^2 p = \\frac{1}{\\Delta t} \\nabla \\cdot \\mathbf{u}^{\\ast},\n$$\n并采用周期性边界条件。在 Arakawa 网格交错中，有两种典型的布局：Arakawa A-网格（所有预报变量位于网格中心）和 Arakawa C-网格（压力位于网格中心，$u$-速度位于垂直网格面，$v$-速度位于水平网格面）。对于一个包含 $N_x \\times N_y$ 个网格、间距为 $\\Delta x$ 和 $\\Delta y$、时间步长为 $\\Delta t$ 的均匀二维周期性矩形区域，请在 Arakawa A-网格和 Arakawa C-网格上实现投影法，并使用遵循各自网格布局的离散算子：\n- 在 Arakawa C-网格上，将网格中心的离散散度定义为面法向通量的差值，并将离散梯度定义为与散度算子相一致的网格中心压力的面法向差值。\n- 在 Arakawa A-网格上，使用与周期性边界条件相一致的二阶中心差分来定义网格中心的离散散度和梯度。\n\n使用一个周期性离散泊松求解器来获取网格中心的压力 $p$。该求解器必须能处理周期性边界条件下的离散泊松方程，包括与常数模态相关的零空间。您的程序必须为每个测试用例计算比率\n$$\nR = \\frac{\\|\\nabla \\cdot \\mathbf{u}^{n+1}\\|_2}{\\|\\nabla \\cdot \\mathbf{u}^{\\ast}\\|_2},\n$$\n其中 $\\|\\cdot\\|_2$ 表示网格中心集合上的离散 $\\ell^2$ 范数。如果分母为零，则定义 $R = 0$。\n\n根据网格类型，以确定性且遵循周期性的方式构造中间速度 $\\mathbf{u}^{\\ast}$。对于每个测试，使用以下构造场：\n- Arakawa C-网格：$u^{\\ast}$ 定义在索引为 $(i,j)$（其中 $i = 0, \\ldots, N_x$ 且 $j = 0, \\ldots, N_y-1$）的垂直面上，$v^{\\ast}$ 定义在索引为 $(i,j)$（其中 $i = 0, \\ldots, N_x-1$ 且 $j = 0, \\ldots, N_y$）的水平面上，如下所示\n$$\nu^{\\ast}_{i,j} = \\sin\\left( \\frac{2\\pi i}{N_x} \\right) + 0.3 \\cos\\left( \\frac{2\\pi j}{N_y} \\right), \\quad v^{\\ast}_{i,j} = 0.7 \\cos\\left( \\frac{2\\pi i}{N_x} \\right) - \\sin\\left( \\frac{2\\pi j}{N_y} \\right).\n$$\n- Arakawa A-网格：$u^{\\ast}$ 和 $v^{\\ast}$ 定义在索引为 $(i,j)$（其中 $i = 0, \\ldots, N_x-1$ 且 $j = 0, \\ldots, N_y-1$）的网格中心，如下所示\n$$\nu^{\\ast}_{i,j} = \\sin\\left( \\frac{2\\pi i}{N_x} \\right) + 0.3 \\cos\\left( \\frac{2\\pi j}{N_y} \\right), \\quad v^{\\ast}_{i,j} = 0.7 \\cos\\left( \\frac{2\\pi i}{N_x} \\right) - \\sin\\left( \\frac{2\\pi j}{N_y} \\right).\n$$\n这些定义确保了周期性。离散算子和投影步的构建方式必须在所选网格上是伴随一致的，以使 $\\nabla^2$ 是梯度的散度。\n\n使用快速傅里叶变换 (FFT) 方法实现一个用于求解网格中心压力 $p$ 的周期性离散泊松求解器。该求解器必须通过将压力平均值设为零来显式处理零波数的情况。\n\n测试套件：\n提供以下四个参数集的结果。每个测试用例是一个元组 $(\\text{grid\\_type}, N_x, N_y, \\Delta x, \\Delta y, \\Delta t)$，其中 $\\text{grid\\_type} \\in \\{\\text{\"C\"}, \\text{\"A\"}\\}$：\n1. $(\\text{\"C\"}, 16, 12, 1.0, 2.0, 0.2)$\n2. $(\\text{\"A\"}, 16, 12, 1.0, 2.0, 0.15)$\n3. $(\\text{\"C\"}, 3, 3, 1.3, 0.9, 0.25)$\n4. $(\\text{\"A\"}, 8, 2, 0.8, 1.2, 0.05)$\n\n最终输出格式：\n您的程序应生成单行输出，其中包含四个测试用例的 $R$ 值，格式为一个用方括号括起来的逗号分隔列表（例如，“[r1,r2,r3,r4]”）。不需要物理单位；所有量都是无量纲的。三角函数中出现的所有角度，根据离散算子的构造，均以弧度为单位。输出值必须是浮点数。",
            "solution": "该问题要求实现一种投影法，在二维周期性区域中对速度场强制施加不可压缩性约束。这是计算流体动力学中模拟不可压缩流的一项基本技术。该方法的有效性将在两种不同的网格交错配置上进行评估：Arakawa A-网格（同位网格）和 Arakawa C-网格（交错网格）。性能指标是投影后速度散度的 $\\ell^2$ 范数与投影前速度散度的 $\\ell^2$ 范数之比 $R$。\n\n投影法是一种分步算法。给定一个时间步长上不一定无散的中间速度场 $\\mathbf{u}^{\\ast} = (u^{\\ast}, v^{\\ast})$，目标是找到一个涉及标量压力场 $p$ 的修正项，使得最终的速度场 $\\mathbf{u}^{n+1}$ 是无散的。这通过将 $\\mathbf{u}^{\\ast}$ 投影到无散向量场空间来实现。该投影由两个条件定义：\n1. 速度通过压力梯度进行更新：\n$$ \\mathbf{u}^{n+1} = \\mathbf{u}^{\\ast} - \\Delta t \\nabla p $$\n其中 $\\Delta t$ 是时间步长。\n2. 最终速度场必须是无散的：\n$$ \\nabla \\cdot \\mathbf{u}^{n+1} = 0 $$\n对第一个方程取散度并代入第二个方程可得：\n$$ \\nabla \\cdot (\\mathbf{u}^{\\ast} - \\Delta t \\nabla p) = 0 $$\n$$ \\nabla \\cdot \\mathbf{u}^{\\ast} - \\Delta t \\nabla^2 p = 0 $$\n这就得到了关于压力场 $p$ 的泊松方程：\n$$ \\nabla^2 p = \\frac{1}{\\Delta t} \\nabla \\cdot \\mathbf{u}^{\\ast} $$\n该方程的解提供了将速度场投影到无散子空间所需的压力。问题指定了在一个尺寸为 $N_x \\times N_y$ 个网格、网格间距为 $\\Delta x$ 和 $\\Delta y$ 的矩形区域上的周期性边界条件。\n\n散度（$\\nabla \\cdot$）、梯度（$\\nabla$）和拉普拉斯（$\\nabla^2$）算子的离散化取决于网格布局。\n\n在 Arakawa A-网格上，所有变量（$u, v, p$）都同位放置在网格中心，索引为 $(i,j)$，其中 $i=0, \\dots, N_x-1$，$j=0, \\dots, N_y-1$。我们对算子使用二阶中心有限差分：\n在网格 $(i,j)$ 处速度场 $\\mathbf{u}=(u,v)$ 的散度为：\n$$ (\\nabla \\cdot \\mathbf{u})_{i,j} = \\frac{u_{i+1,j} - u_{i-1,j}}{2 \\Delta x} + \\frac{v_{i,j+1} - v_{i,j-1}}{2 \\Delta y} $$\n在网格 $(i,j)$ 处标量压力场 $p$ 的梯度为：\n$$ (\\nabla p)_{x, i,j} = \\frac{p_{i+1,j} - p_{i-1,j}}{2 \\Delta x}, \\quad (\\nabla p)_{y, i,j} = \\frac{p_{i,j+1} - p_{i,j-1}}{2 \\Delta y} $$\n所有索引都进行周期性处理（例如，$u_{N_x, j} = u_{0, j}$，$u_{-1, j} = u_{N_x-1, j}$）。\n\n在 Arakawa C-网格上，变量是交错的。压力 $p$ 位于网格中心 $(i,j)$。水平速度分量 $u$ 位于垂直网格面上，这里的索引方式使得 $u_{i,j}$ 位于网格 $(i-1,j)$ 和 $(i,j)$ 之间的面上。垂直速度分量 $v$ 位于水平网格面上，其中 $v_{i,j}$ 位于网格 $(i,j-1)$ 和 $(i,j)$ 之间的面上。\n在网格中心 $(i,j)$ 处的离散散度定义为从该网格流出的净通量：\n$$ (\\nabla \\cdot \\mathbf{u})_{i,j} = \\frac{u_{i+1,j} - u_{i,j}}{\\Delta x} + \\frac{v_{i,j+1} - v_{i,j}}{\\Delta y} $$\n网格中心压力 $p$ 的离散梯度在网格面上产生分量，与速度位置一致：\n$$ (\\nabla p)_{x, i,j} = \\frac{p_{i,j} - p_{i-1,j}}{\\Delta x}, \\quad (\\nabla p)_{y, i,j} = \\frac{p_{i,j} - p_{i,j-1}}{\\Delta y} $$\nC-网格交错的一个重要特性是，通过组合散度和梯度算子（$\\nabla^2 = \\nabla \\cdot \\nabla$）构成的离散拉普拉斯算子，会得到标准的五点模板，这与 A-网格的二阶中心拉普拉斯算子相同：\n$$ (\\nabla^2 p)_{i,j} = \\frac{p_{i+1,j} - 2 p_{i,j} + p_{i-1,j}}{(\\Delta x)^2} + \\frac{p_{i,j+1} - 2 p_{i,j} + p_{i,j-1}}{(\\Delta y)^2} $$\n这种伴随一致性是 C-网格的一个关键优势。\n\n对于两种网格，中间速度场 $\\mathbf{u}^{\\ast}$ 均由一个构造解给出。这些场的位置由问题指定：\n对于 A-网格，$u^{\\ast}$ 和 $v^{\\ast}$ 定义在网格中心 $(i,j)$：\n$$ u^{\\ast}_{i,j} = \\sin\\left( \\frac{2\\pi i}{N_x} \\right) + 0.3 \\cos\\left( \\frac{2\\pi j}{N_y} \\right), \\quad v^{\\ast}_{i,j} = 0.7 \\cos\\left( \\frac{2\\pi i}{N_x} \\right) - \\sin\\left( \\frac{2\\pi j}{N_y} \\right) $$\n对于 C-网格，$u^{\\ast}$ 定义在垂直面上，$v^{\\ast}$ 定义在水平面上，使用相同的函数形式，但在各自的交错网格坐标上。\n\n离散泊松方程 $\\hat{L}p = f$（其中 $\\hat{L}$ 是离散拉普拉斯算子，而 $f = \\frac{1}{\\Delta t} \\nabla \\cdot \\mathbf{u}^{\\ast}$）可以使用快速傅里叶变换 (FFT) 高效求解。对该方程应用二维离散傅里叶变换，将拉普拉斯算子的空间卷积转换为傅里叶空间中的简单乘法：\n$$ \\tilde{L}_{m,n} \\tilde{p}_{m,n} = \\tilde{f}_{m,n} $$\n其中 $\\tilde_.$ 表示傅里叶变换，$(m, n)$ 是整数波数指数。五点拉普拉斯算子的傅里叶符号 $\\tilde{L}_{m,n}$ 为：\n$$ \\tilde{L}_{m,n} = -\\frac{4}{(\\Delta x)^2} \\sin^2\\left(\\frac{\\pi m}{N_x}\\right) - \\frac{4}{(\\Delta y)^2} \\sin^2\\left(\\frac{\\pi n}{N_y}\\right) $$\n对于零波数模态 $(m,n)=(0,0)$，$\\tilde{L}_{0,0} = 0$。这反映了压力解在相差一个任意常数的意义下是唯一的。问题指定通过强制压力平均值为零来解决这个歧义，这对应于将其傅里叶变换的零波数分量设为零：$\\tilde{p}_{0,0} = 0$。对于所有其他模态 $(m,n) \\neq (0,0)$，傅里叶空间中的压力为 $\\tilde{p}_{m,n} = \\tilde{f}_{m,n} / \\tilde{L}_{m,n}$。然后通过应用二维逆傅里叶变换恢复压力场 $p$。\n\n每个测试用例的总体算法如下：\n1. 在适当的网格（A 或 C）上构造中间速度场 $u^{\\ast}$ 和 $v^{\\ast}$。\n2. 使用适合该网格的离散散度算子计算初始散度场 $D^{\\ast} = \\nabla \\cdot \\mathbf{u}^{\\ast}$。\n3. 计算比率的分母：$\\|\\nabla \\cdot \\mathbf{u}^{\\ast}\\|_2 = \\|D^{\\ast}\\|_2$。如果此范数为零，则 $R=0$。\n4. 使用基于 FFT 的求解器求解离散泊松方程 $\\nabla^2 p = \\frac{1}{\\Delta t} D^{\\ast}$ 以得到 $p$。\n5. 使用适合该网格的离散梯度算子计算压力梯度 $\\nabla p$。\n6. 计算投影后的速度场：$\\mathbf{u}^{n+1} = \\mathbf{u}^{\\ast} - \\Delta t \\nabla p$。\n7. 计算最终散度场 $D^{n+1} = \\nabla \\cdot \\mathbf{u}^{n+1}$。\n8. 计算比率的分子：$\\|\\nabla \\cdot \\mathbf{u}^{n+1}\\|_2 = \\|D^{n+1}\\|_2$。\n9. 计算最终比率 $R = \\|\\nabla \\cdot \\mathbf{u}^{n+1}\\|_2 / \\|\\nabla \\cdot \\mathbf{u}^{\\ast}\\|_2$。这个比率应接近浮点零，表示投影成功。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function that iterates through test cases and prints the results.\n    \"\"\"\n    test_cases = [\n        (\"C\", 16, 12, 1.0, 2.0, 0.2),\n        (\"A\", 16, 12, 1.0, 2.0, 0.15),\n        (\"C\", 3, 3, 1.3, 0.9, 0.25),\n        (\"A\", 8, 2, 0.8, 1.2, 0.05),\n    ]\n\n    results = []\n    for case in test_cases:\n        grid_type, Nx, Ny, dx, dy, dt = case\n        \n        # --- 1. Construct intermediate velocity fields u* ---\n        if grid_type == \"A\":\n            # Collocated grid: u*, v*, p are at cell centers (Nx, Ny)\n            i_coords, j_coords = np.mgrid[0:Nx, 0:Ny]\n            u_star = np.sin(2 * np.pi * i_coords / Nx) + 0.3 * np.cos(2 * np.pi * j_coords / Ny)\n            v_star = 0.7 * np.cos(2 * np.pi * i_coords / Nx) - np.sin(2 * np.pi * j_coords / Ny)\n        elif grid_type == \"C\":\n            # Staggered grid: p at centers, u on vertical faces, v on horizontal faces\n            # u* on vertical faces: (Nx+1, Ny) with u[0,:]=u[Nx,:]\n            i_u, j_u = np.mgrid[0:Nx + 1, 0:Ny]\n            u_star = np.sin(2 * np.pi * i_u / Nx) + 0.3 * np.cos(2 * np.pi * j_u / Ny)\n            # v* on horizontal faces: (Nx, Ny+1) with v[:,0]=v[:,Ny]\n            i_v, j_v = np.mgrid[0:Nx, 0:Ny + 1]\n            v_star = 0.7 * np.cos(2 * np.pi * i_v / Nx) - np.sin(2 * np.pi * j_v / Ny)\n\n        # --- 2. Compute initial divergence div(u*) ---\n        if grid_type == \"A\":\n            du_dx = (np.roll(u_star, -1, axis=0) - np.roll(u_star, 1, axis=0)) / (2 * dx)\n            dv_dy = (np.roll(v_star, -1, axis=1) - np.roll(v_star, 1, axis=1)) / (2 * dy)\n            div_u_star = du_dx + dv_dy\n        elif grid_type == \"C\":\n            du_dx = (u_star[1:, :] - u_star[:-1, :]) / dx\n            dv_dy = (v_star[:, 1:] - v_star[:, :-1]) / dy\n            div_u_star = du_dx + dv_dy\n\n        # --- 3. Compute L2 norm of initial divergence ---\n        norm_div_u_star = np.linalg.norm(div_u_star)\n        if norm_div_u_star == 0.0:\n            results.append(0.0)\n            continue\n            \n        # --- 4. Solve Poisson equation for pressure p ---\n        # Right-hand side of the Poisson equation\n        rhs = div_u_star / dt\n        \n        # FFT of the RHS\n        rhs_tilde = np.fft.fft2(rhs)\n        \n        # Wavenumbers for the FFT\n        m = np.fft.fftfreq(Nx) * Nx\n        n = np.fft.fftfreq(Ny) * Ny\n        mm, nn = np.meshgrid(m, n, indexing='ij')\n\n        # Fourier symbol of the Laplacian operator\n        laplacian_tilde = (-4 / (dx**2)) * np.sin(np.pi * mm / Nx)**2 \\\n                        + (-4 / (dy**2)) * np.sin(np.pi * nn / Ny)**2\n        \n        # Avoid division by zero for the zero-wavenumber mode\n        laplacian_tilde[0, 0] = 1.0\n        \n        # Solve for p in Fourier space\n        p_tilde = rhs_tilde / laplacian_tilde\n        \n        # Enforce zero mean pressure\n        p_tilde[0, 0] = 0.0\n        \n        # Inverse FFT to get pressure in physical space\n        p = np.fft.ifft2(p_tilde).real\n\n        # --- 5. Compute pressure gradient grad(p) ---\n        if grid_type == \"A\":\n            grad_p_x = (np.roll(p, -1, axis=0) - np.roll(p, 1, axis=0)) / (2 * dx)\n            grad_p_y = (np.roll(p, -1, axis=1) - np.roll(p, 1, axis=1)) / (2 * dy)\n        elif grid_type == \"C\":\n            # Gradient on x-faces\n            grad_p_x = (p - np.roll(p, 1, axis=0)) / dx\n            # Extend to be periodic with shape (Nx+1, Ny)\n            grad_p_x = np.concatenate((grad_p_x, grad_p_x[0:1, :]), axis=0)\n\n            # Gradient on y-faces\n            grad_p_y = (p - np.roll(p, 1, axis=1)) / dy\n            # Extend to be periodic with shape (Nx, Ny+1)\n            grad_p_y = np.concatenate((grad_p_y, grad_p_y[:, 0:1]), axis=1)\n\n        # --- 6. Update velocity to be u_new = u_star - dt*grad(p) ---\n        u_new = u_star - dt * grad_p_x\n        v_new = v_star - dt * grad_p_y\n\n        # --- 7. Compute final divergence div(u_new) ---\n        if grid_type == \"A\":\n            du_dx_new = (np.roll(u_new, -1, axis=0) - np.roll(u_new, 1, axis=0)) / (2 * dx)\n            dv_dy_new = (np.roll(v_new, -1, axis=1) - np.roll(v_new, 1, axis=1)) / (2 * dy)\n            div_u_new = du_dx_new + dv_dy_new\n        elif grid_type == \"C\":\n            du_dx_new = (u_new[1:, :] - u_new[:-1, :]) / dx\n            dv_dy_new = (v_new[:, 1:] - v_new[:, :-1]) / dy\n            div_u_new = du_dx_new + dv_dy_new\n\n        # --- 8. Compute L2 norm of final divergence ---\n        norm_div_u_new = np.linalg.norm(div_u_new)\n\n        # --- 9. Compute the ratio R ---\n        ratio = norm_div_u_new / norm_div_u_star\n        results.append(ratio)\n        \n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}