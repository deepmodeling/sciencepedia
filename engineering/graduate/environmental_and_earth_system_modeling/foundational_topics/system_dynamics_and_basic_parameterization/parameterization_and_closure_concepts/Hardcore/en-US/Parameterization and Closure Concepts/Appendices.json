{
    "hands_on_practices": [
        {
            "introduction": "The fundamental closure problem in fluid dynamics modeling arises from the need to represent the effects of unresolved turbulent eddies on the resolved mean flow. A foundational approach to this challenge is the gradient-diffusion hypothesis, or K-theory, which parameterizes the turbulent flux of a quantity as being proportional to the gradient of its mean value. This exercise provides a direct and practical application of this concept by guiding you through the calculation of the sensible heat flux in the atmospheric boundary layer, a critical component of surface-atmosphere energy exchange .",
            "id": "3905149",
            "problem": "Consider a horizontally homogeneous, stationary segment of the Atmospheric Boundary Layer (ABL), in which the mean vertical motion is negligible and the air behaves as a Boussinesq fluid. The prognostic equation for a scalar such as the potential temperature $T$ can be Reynolds-decomposed, yielding a mean equation in which the unresolved turbulent transport appears as a covariance term. In first-order closure, this unresolved transport is parameterized by a gradient-diffusion hypothesis with an eddy diffusivity for heat $K_{\\theta}$. Starting from conservation of scalar quantity (potential temperature) under Reynolds decomposition, and invoking the first-order closure concept for the turbulent heat flux, derive an expression for the sensible heat flux $H$ in terms of $K_{\\theta}$, the mean temperature gradient $\\partial \\overline{T}/\\partial z$, the air density $\\rho$, and the specific heat at constant pressure $c_{p}$. Then, for the case $K_{\\theta} = 1$ $\\text{m}^2 \\text{s}^{-1}$ and a vertically uniform mean temperature gradient $\\partial \\overline{T}/\\partial z = -0.01$ $\\text{K m}^{-1}$ representative of unstable stratification, evaluate $H$ using $\\rho = 1.2$ $\\text{kg m}^{-3}$ and $c_{p} = 1004$ $\\text{J kg}^{-1} \\text{K}^{-1}$. Adopt the sign convention in which upward vertical velocity is positive and upward sensible heat flux is positive. Explain the sign of the computed flux under unstable stratification in this convention, and briefly state how the sign would appear under the alternative land-surface energy budget convention in which downward flux into the surface is taken as positive. Round your numerical answer to four significant figures and express the sensible heat flux in $\\text{W m}^{-2}$.",
            "solution": "The problem is first validated against the specified criteria.\n\n### Step 1: Extract Givens\n- System: Horizontally homogeneous, stationary segment of the Atmospheric Boundary Layer (ABL).\n- Mean vertical motion is negligible.\n- Fluid property: The air a behaves as a Boussinesq fluid.\n- Scalar: Potential temperature, denoted by $T$.\n- Modeling approach: The prognostic equation for $T$ is Reynolds-decomposed. First-order closure is applied, using a gradient-diffusion hypothesis with an eddy diffusivity for heat, $K_{\\theta}$.\n- Derivation task: Derive an expression for the sensible heat flux $H$ in terms of $K_{\\theta}$, the mean temperature gradient $\\partial \\overline{T}/\\partial z$, the air density $\\rho$, and the specific heat at constant pressure $c_{p}$.\n- Evaluation task: For the case where $K_{\\theta} = 1 \\text{ m}^{2} \\text{ s}^{-1}$ and $\\partial \\overline{T}/\\partial z = -0.01 \\text{ K m}^{-1}$, evaluate $H$ using $\\rho = 1.2 \\text{ kg m}^{-3}$ and $c_{p} = 1004 \\text{ J kg}^{-1} \\text{ K}^{-1}$.\n- Sign convention: Upward vertical velocity is positive; upward sensible heat flux is positive.\n- Explanation task 1: Explain the sign of the computed flux under unstable stratification.\n- Explanation task 2: State the sign under the alternative land-surface energy budget convention where downward flux is positive.\n- Formatting: Round the numerical answer to four significant figures and express in units of W m$^{-2}$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, well-posed, and objective. It is a standard problem in atmospheric boundary layer physics and micrometeorology, directly addressing the topic of parameterization and closure. The concepts of Reynolds decomposition, first-order closure, and sensible heat flux are fundamental to the discipline. All necessary parameters and conditions for both the derivation and the numerical calculation are provided, and the values are physically realistic for the described scenario (unstable ABL). The problem contains no contradictions, ambiguities, or factual inaccuracies.\n\n### Step 3: Verdict and Action\nThe problem is valid. A full solution will be provided.\n\nThe conservation equation for a scalar quantity like potential temperature $T$ in a fluid, neglecting molecular diffusion and sources/sinks, is given by:\n$$\n\\frac{\\partial T}{\\partial t} + \\mathbf{u} \\cdot \\nabla T = 0\n$$\nwhere $\\mathbf{u} = (u, v, w)$ is the velocity vector. In Cartesian coordinates, this is:\n$$\n\\frac{\\partial T}{\\partial t} + u \\frac{\\partial T}{\\partial x} + v \\frac{\\partial T}{\\partial y} + w \\frac{\\partial T}{\\partial z} = 0\n$$\nWe apply Reynolds decomposition, where each variable is split into a mean component (denoted by an overbar) and a turbulent fluctuation (denoted by a prime): $T = \\overline{T} + T'$, $u = \\overline{u} + u'$, $v = \\overline{v} + v'$, and $w = \\overline{w} + w'$. Substituting these into the conservation equation and taking the ensemble average (Reynolds averaging) of the entire equation yields:\n$$\n\\frac{\\partial \\overline{T}}{\\partial t} + \\overline{u} \\frac{\\partial \\overline{T}}{\\partial x} + \\overline{v} \\frac{\\partial \\overline{T}}{\\partial y} + \\overline{w} \\frac{\\partial \\overline{T}}{\\partial z} + \\frac{\\partial \\overline{u'T'}}{\\partial x} + \\frac{\\partial \\overline{v'T'}}{\\partial y} + \\frac{\\partial \\overline{w'T'}}{\\partial z} = 0\n$$\nThe problem specifies several conditions for this ABL segment:\n1.  **Stationary**: $\\frac{\\partial}{\\partial t} = 0$. The first term vanishes.\n2.  **Horizontally homogeneous**: $\\frac{\\partial}{\\partial x} = 0$ and $\\frac{\\partial}{\\partial y} = 0$ for mean quantities. The second, third, fifth, and sixth terms vanish.\n3.  **Negligible mean vertical motion**: $\\overline{w} = 0$. The fourth term vanishes.\n\nApplying these conditions simplifies the mean potential temperature budget equation to:\n$$\n\\frac{\\partial \\overline{w'T'}}{\\partial z} = 0\n$$\nThis equation states that the vertical gradient of the turbulent kinematic heat flux, $\\overline{w'T'}$, is zero. This implies that $\\overline{w'T'}$ is constant with height in the absence of other effects like radiative flux divergence.\n\nThe sensible heat flux, $H$, is the vertical transport of heat due to turbulent fluid motions, defined as:\n$$\nH = \\rho c_{p} \\overline{w'T'}\n$$\nwhere $\\rho$ is the air density and $c_{p}$ is the specific heat capacity at constant pressure.\n\nThe problem next requires invoking a first-order closure scheme, specifically the gradient-diffusion hypothesis (also known as K-theory). This approach parameterizes the unresolved turbulent flux in terms of the gradient of the mean quantity. For the vertical flux of potential temperature, the relationship is:\n$$\n\\overline{w'T'} = -K_{\\theta} \\frac{\\partial \\overline{T}}{\\partial z}\n$$\nHere, $K_{\\theta}$ is the eddy diffusivity for heat, a parameter representing the efficiency of turbulent mixing. The negative sign is crucial: it ensures that the flux is in the direction of decreasing potential temperature, i.e., a positive (upward) flux occurs when potential temperature decreases with height (a negative gradient).\n\nSubstituting this parameterization into the definition of sensible heat flux $H$ yields the desired expression:\n$$\nH = \\rho c_{p} \\left(-K_{\\theta} \\frac{\\partial \\overline{T}}{\\partial z}\\right) = -\\rho c_{p} K_{\\theta} \\frac{\\partial \\overline{T}}{\\partial z}\n$$\nThis is the derived expression for the sensible heat flux $H$.\n\nNext, we evaluate $H$ using the provided numerical values:\n- $\\rho = 1.2 \\text{ kg m}^{-3}$\n- $c_{p} = 1004 \\text{ J kg}^{-1} \\text{ K}^{-1}$\n- $K_{\\theta} = 1 \\text{ m}^{2} \\text{ s}^{-1}$\n- $\\frac{\\partial \\overline{T}}{\\partial z} = -0.01 \\text{ K m}^{-1}$\n\nSubstituting these values into the derived formula:\n$$\nH = -(1.2 \\text{ kg m}^{-3}) (1004 \\text{ J kg}^{-1} \\text{ K}^{-1}) (1 \\text{ m}^{2} \\text{ s}^{-1}) (-0.01 \\text{ K m}^{-1})\n$$\n$$\nH = (-1.2 \\times 1004 \\times 1 \\times -0.01) \\frac{\\text{kg} \\cdot \\text{J} \\cdot \\text{m}^2 \\cdot \\text{K}}{\\text{m}^3 \\cdot \\text{kg} \\cdot \\text{K} \\cdot \\text{s} \\cdot \\text{m}}\n$$\nThe units simplify to $\\text{J m}^{-2} \\text{ s}^{-1}$, which is equivalent to Watts per square meter, $\\text{W m}^{-2}$.\nCalculating the numerical value:\n$$\nH = (1.2)(1004)(0.01) = 12.048 \\text{ W m}^{-2}\n$$\nRounding to four significant figures as requested gives:\n$$\nH = 12.05 \\text{ W m}^{-2}\n$$\n\nThe sign of the computed flux is positive. This is physically consistent with the conditions. The given gradient $\\frac{\\partial \\overline{T}}{\\partial z} = -0.01 \\text{ K m}^{-1}$ is negative, meaning potential temperature decreases with height. This condition defines a statically unstable atmosphere. In such an atmosphere, a parcel of air displaced upward is warmer (and thus less dense) than its new surroundings, causing it to continue rising. This buoyancy-driven motion leads to vigorous vertical mixing, transporting warmer air from near the surface upward and cooler air from aloft downward. The net result is an upward transport of heat. Given the sign convention that upward flux is positive, the sensible heat flux $H$ must be positive, which is consistent with our calculated result $H > 0$.\n\nFinally, considering the alternative land-surface energy budget convention where downward fluxes into the surface are taken as positive. Our calculated flux is an upward flux away from the surface. In the land-surface convention, this upward flux would be represented by a negative sign. Therefore, under that convention, the flux would be $H = -12.05 \\text{ W m}^{-2}$.",
            "answer": "$$\\boxed{12.05}$$"
        },
        {
            "introduction": "Moving beyond simple K-theory, more sophisticated turbulence closures link the mixing efficiency to the state of the turbulence itself. A common approach involves the Turbulent Kinetic Energy (TKE), a measure of the intensity of turbulent motions. In this practice, you will build a \"1.5-order\" closure scheme where the TKE is diagnostically solved from a balance between its production by wind shear and its dissipation, and then used to compute a physically-based eddy viscosity. This hands-on coding exercise  mirrors the development of single-column models and illustrates how parameterizations can be integrated into a more complex and interactive system that responds to atmospheric stability.",
            "id": "3905106",
            "problem": "A steady-state, horizontally homogeneous atmospheric boundary layer is modeled using a turbulent kinetic energy balance and a first-order closure with a stability-dependent mixing length. The objective is to derive and compute the vertical profile of turbulent kinetic energy per unit mass $e(z)$ from fundamental principles, given a shear profile $S(z)$ and stability-dependent mixing length $\\ell(z)$, and then to summarize the results over specified test cases.\n\nStart from the following fundamental base:\n\n- The turbulent kinetic energy (TKE) balance under steady-state, horizontally homogeneous conditions neglecting turbulent transport is\n$$\nP(z) + B(z) - \\varepsilon(z) = 0,\n$$\nwhere $P(z)$ is shear production, $B(z)$ is buoyancy production (positive for convective instability and negative for stable stratification), and $\\varepsilon(z)$ is dissipation. In the simplified closure used here, stability effects are embedded in the mixing length $\\ell(z)$ and are not introduced explicitly via $B(z)$; thus we use the reduced balance $P(z) = \\varepsilon(z)$.\n\n- The eddy viscosity closure is\n$$\n\\nu_t(z) = c_m\\, \\ell(z)\\, \\sqrt{e(z)},\n$$\nwhere $c_m$ is a dimensionless calibration constant, $\\nu_t(z)$ is the turbulent (eddy) viscosity, $\\ell(z)$ is the mixing length, and $e(z)$ is the turbulent kinetic energy per unit mass.\n\n- The shear production is\n$$\nP(z) = \\nu_t(z)\\, S(z)^2,\n$$\nwhere $S(z)$ is the magnitude of the mean shear rate (units of $\\mathrm{s}^{-1}$), defined as the norm of the vertical gradient of the horizontal wind.\n\n- The dissipation rate closure is\n$$\n\\varepsilon(z) = c_{\\varepsilon}\\, \\frac{e(z)^{3/2}}{\\ell(z)},\n$$\nwhere $c_{\\varepsilon}$ is a positive dimensionless constant.\n\n- The mixing length is limited by surface-layer scaling and an outer-layer asymptote using the Blackadar form and stability taken from Monin–Obukhov Similarity Theory (MOST):\n$$\n\\ell(z) = \\frac{\\kappa z}{1 + \\frac{\\kappa z}{\\ell_{\\infty}}}\\, \\frac{1}{\\Phi_m(\\zeta)},\n$$\nwhere $\\kappa$ is the von Kármán constant, $\\ell_{\\infty}$ is an outer-layer limiting length scale, $\\zeta = z/L$ is the stability parameter with $L$ the Obukhov length, and $\\Phi_m(\\zeta)$ is the MOST stability function given by the Businger–Dyer forms:\n$$\n\\Phi_m(\\zeta) =\n\\begin{cases}\n1 + 5\\zeta,  \\zeta \\ge 0 \\quad \\text{(stable)},\\\\\n\\left(1 - 16\\zeta\\right)^{-1/4},  \\zeta  0 \\quad \\text{(unstable)}.\n\\end{cases}\n$$\nThese relations are well-tested in boundary-layer meteorology.\n\nTask:\n1. Using the above foundations and closures, derive an explicit algebraic expression for $e(z)$ in terms of $\\ell(z)$, $S(z)$, $c_m$, and $c_{\\varepsilon}$ under the reduced steady-state balance.\n2. Implement a program that evaluates $e(z)$ on a specified vertical grid for each test case defined below. For each case, report the maximum value of $e(z)$ over the given layer height range as a floating-point value in $\\mathrm{m}^2\\,\\mathrm{s}^{-2}$, rounded to six decimal places.\n\nConstants to use:\n- $\\kappa = 0.4$.\n- $c_m = 0.01$.\n- $c_{\\varepsilon} = 1.0$.\n\nDefinitions for the test suite:\nFor each case define $z \\in [0, z_{\\max}]$ with $\\Delta z = 1\\,\\mathrm{m}$, the shear profile $S(z)$, the Obukhov length $L$, and the limiting mixing length $\\ell_{\\infty}$.\n\n- Case A (general unstable, \"happy path\"):\n  - $z_{\\max} = 600\\,\\mathrm{m}$.\n  - $S(z) = S_0 \\exp(-z/z_s)$ with $S_0 = 0.3\\,\\mathrm{s}^{-1}$ and $z_s = 200\\,\\mathrm{m}$.\n  - $L = -50\\,\\mathrm{m}$.\n  - $\\ell_{\\infty} = 150\\,\\mathrm{m}$.\n\n- Case B (moderately stable):\n  - $z_{\\max} = 300\\,\\mathrm{m}$.\n  - $S(z) = \\dfrac{S_0}{1 + z/z_s}$ with $S_0 = 0.25\\,\\mathrm{s}^{-1}$ and $z_s = 100\\,\\mathrm{m}$.\n  - $L = 100\\,\\mathrm{m}$.\n  - $\\ell_{\\infty} = 120\\,\\mathrm{m}$.\n\n- Case C (neutral-like with very large Obukhov length):\n  - $z_{\\max} = 400\\,\\mathrm{m}$.\n  - $S(z) = S_0$ constant with $S_0 = 0.2\\,\\mathrm{s}^{-1}$.\n  - $L = 10^9\\,\\mathrm{m}$ (effectively neutral).\n  - $\\ell_{\\infty} = 200\\,\\mathrm{m}$.\n\n- Case D (edge case with zero shear):\n  - $z_{\\max} = 500\\,\\mathrm{m}$.\n  - $S(z) = 0$ for all $z$.\n  - $L = -30\\,\\mathrm{m}$.\n  - $\\ell_{\\infty} = 150\\,\\mathrm{m}$.\n\nUnits:\n- Report $e(z)$ in $\\mathrm{m}^2\\,\\mathrm{s}^{-2}$.\n- The final program output must be the maximum value of $e(z)$ for each case in the order A, B, C, D, rounded to six decimal places.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[result_A,result_B,result_C,result_D]$), where each entry is a floating-point value rounded to six decimal places in $\\mathrm{m}^2\\,\\mathrm{s}^{-2}$.\n- Your program must be self-contained, must not require any user input, and must compute the results for the specified test suite exactly as described.",
            "solution": "The problem requires the derivation and computation of the vertical profile of turbulent kinetic energy per unit mass, $e(z)$, within a simplified atmospheric boundary layer model. The solution is presented in two parts: first, the algebraic derivation of $e(z)$, and second, the computational implementation to solve the specified test cases.\n\n**1. Derivation of the Turbulent Kinetic Energy Expression**\n\nThe starting point is the provided steady-state, horizontally homogeneous turbulent kinetic energy (TKE) budget, which under the stated simplification reduces to a balance between shear production, $P(z)$, and dissipation, $\\varepsilon(z)$:\n$$\nP(z) = \\varepsilon(z)\n$$\nThis equation posits that the rate at which TKE is generated by the interaction of turbulent eddies with the mean vertical wind shear is exactly balanced by the rate at which TKE is converted into internal energy by viscous forces at the smallest scales of motion.\n\nNext, we introduce the closure assumptions provided for the production and dissipation terms. The shear production term is defined as:\n$$\nP(z) = \\nu_t(z)\\, S(z)^2\n$$\nwhere $S(z)$ is the magnitude of the mean shear rate and $\\nu_t(z)$ is the eddy viscosity. The eddy viscosity itself is parameterized using a first-order closure based on the local TKE, $e(z)$, and a turbulent mixing length, $\\ell(z)$:\n$$\n\\nu_t(z) = c_m\\, \\ell(z)\\, \\sqrt{e(z)}\n$$\nHere, $c_m$ is a dimensionless constant, given as $0.01$. Substituting this expression for $\\nu_t(z)$ into the equation for $P(z)$ yields:\n$$\nP(z) = \\left( c_m\\, \\ell(z)\\, \\sqrt{e(z)} \\right) S(z)^2 = c_m\\, \\ell(z)\\, e(z)^{1/2}\\, S(z)^2\n$$\nThe dissipation rate, $\\varepsilon(z)$, is parameterized as a function of $e(z)$ and $\\ell(z)$:\n$$\n\\varepsilon(z) = c_{\\varepsilon}\\, \\frac{e(z)^{3/2}}{\\ell(z)}\n$$\nwhere $c_{\\varepsilon}$ is another dimensionless constant, given as $1.0$.\n\nNow, we substitute these expressions for $P(z)$ and $\\varepsilon(z)$ back into the simplified TKE balance equation, $P(z) = \\varepsilon(z)$:\n$$\nc_m\\, \\ell(z)\\, e(z)^{1/2}\\, S(z)^2 = c_{\\varepsilon}\\, \\frac{e(z)^{3/2}}{\\ell(z)}\n$$\nTo find an explicit expression for $e(z)$, we rearrange this equation to isolate $e(z)$. We can group the terms involving $e(z)$ on one side. Assuming $e(z)  0$ (which is physically required for turbulence to exist), we can divide both sides by $e(z)^{1/2}$:\n$$\nc_m\\, \\ell(z)\\, S(z)^2 = c_{\\varepsilon}\\, \\frac{e(z)^{3/2 - 1/2}}{\\ell(z)} = c_{\\varepsilon}\\, \\frac{e(z)}{\\ell(z)}\n$$\nSolving for $e(z)$ is now straightforward. We multiply both sides by $\\ell(z)$ and divide by $c_{\\varepsilon}$:\n$$\ne(z) = \\frac{c_m}{c_{\\varepsilon}} \\left( \\ell(z) S(z) \\right)^2\n$$\nThis is the final algebraic expression for the turbulent kinetic energy per unit mass, $e(z)$, as a function of the local mixing length, $\\ell(z)$, the mean shear rate, $S(z)$, and the closure constants $c_m$ and $c_{\\varepsilon}$. It demonstrates that under this closure framework, TKE is directly proportional to the square of the shear rate and the square of the mixing length. If the shear $S(z)$ is zero, then $e(z)$ is also zero, which is a physically consistent result as there is no production mechanism.\n\n**2. Computational Implementation**\n\nThe derived expression for $e(z)$ is evaluated numerically for each of the four specified test cases. The procedure is as follows:\n\nFirst, for each case, a discrete vertical grid is defined from the surface ($z=0$) up to the specified maximum height, $z_{\\max}$, with a grid spacing of $\\Delta z = 1\\,\\mathrm{m}$.\n\nSecond, at each grid point $z$, the necessary physical quantities are computed:\n1.  The shear profile $S(z)$ is calculated according to the function provided for the specific case.\n2.  The stability parameter $\\zeta = z/L$ is computed, using the given Obukhov length $L$.\n3.  The Monin-Obukhov stability function $\\Phi_m(\\zeta)$ is determined using the appropriate Businger-Dyer form based on the sign of $\\zeta$:\n    $$\n    \\Phi_m(\\zeta) =\n    \\begin{cases}\n    1 + 5\\zeta,  \\text{for } \\zeta \\ge 0 \\\\\n    \\left(1 - 16\\zeta\\right)^{-1/4},  \\text{for } \\zeta  0\n    \\end{cases}\n    $$\n4.  The stability-dependent mixing length $\\ell(z)$ is then computed using the Blackadar formula:\n    $$\n    \\ell(z) = \\frac{\\kappa z}{1 + \\frac{\\kappa z}{\\ell_{\\infty}}}\\, \\frac{1}{\\Phi_m(\\zeta)}\n    $$\n    where $\\kappa = 0.4$ and $\\ell_{\\infty}$ is the case-specific limiting length scale. At the surface, $z=0$, this formulation correctly yields $\\ell(0) = 0$.\n\nThird, with arrays representing the profiles of $S(z)$ and $\\ell(z)$, the profile of turbulent kinetic energy $e(z)$ is calculated using the derived formula:\n$$\ne(z) = \\left(\\frac{c_m}{c_{\\varepsilon}}\\right) \\ell(z)^2 S(z)^2 = \\left(\\frac{0.01}{1.0}\\right) \\ell(z)^2 S(z)^2 = 0.01\\, \\ell(z)^2 S(z)^2\n$$\n\nFinally, for each case, the maximum value of $e(z)$ across the entire vertical profile is identified. This maximum value is then rounded to six decimal places to produce the required output. This process is repeated for all four test cases (A, B, C, and D), and the results are aggregated into a single formatted list. For Case D, since $S(z)=0$ everywhere, the resulting $e(z)$ profile is uniformly zero, and its maximum is thus $0.0$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and computes the vertical profile of turbulent kinetic energy e(z)\n    for several atmospheric boundary layer scenarios.\n    \"\"\"\n    \n    # Define constants\n    KAPPA = 0.4  # von Kármán constant\n    C_M = 0.01   # Eddy viscosity constant\n    C_EPS = 1.0  # Dissipation constant\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"name\": \"A\",\n            \"z_max\": 600,\n            \"S_func\": lambda z: 0.3 * np.exp(-z / 200.0),\n            \"L\": -50.0,\n            \"l_inf\": 150.0,\n        },\n        {\n            \"name\": \"B\",\n            \"z_max\": 300,\n            \"S_func\": lambda z: 0.25 / (1.0 + z / 100.0),\n            \"L\": 100.0,\n            \"l_inf\": 120.0,\n        },\n        {\n            \"name\": \"C\",\n            \"z_max\": 400,\n            \"S_func\": lambda z: 0.2 * np.ones_like(z),\n            \"L\": 1e9,\n            \"l_inf\": 200.0,\n        },\n        {\n            \"name\": \"D\",\n            \"z_max\": 500,\n            \"S_func\": lambda z: np.zeros_like(z),\n            \"L\": -30.0,\n            \"l_inf\": 150.0,\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        z_max = case[\"z_max\"]\n        S_func = case[\"S_func\"]\n        L = case[\"L\"]\n        l_inf = case[\"l_inf\"]\n\n        # Create the vertical grid (z in meters)\n        # z in [0, z_max] with Delta_z = 1m\n        z = np.arange(0, z_max + 1, 1.0)\n\n        # 1. Calculate the shear profile S(z)\n        S_profile = S_func(z)\n\n        # 2. Calculate the stability parameter zeta(z)\n        # Handle z=0 separately to avoid 0/0 if L were 0, though not in these cases.\n        # np.divide handles division by a large L value correctly.\n        zeta = np.divide(z, L, out=np.zeros_like(z, dtype=float), where=(L!=0))\n\n        # 3. Calculate the MOST stability function Phi_m(z)\n        phi_m = np.where(zeta >= 0, \n                         1.0 + 5.0 * zeta,\n                         (1.0 - 16.0 * zeta)**(-0.25))\n\n        # 4. Calculate the mixing length profile l(z)\n        # The formula for l(z) has z in the numerator, so l(0) = 0 naturally.\n        # This prevents division-by-zero for phi_m at z=0.\n        l_profile = np.zeros_like(z, dtype=float)\n        # Avoid division by zero in phi_m term if z=0, though phi_m(0)=1\n        non_zero_z_indices = z > 0\n        \n        # Blackadar formula for mixing length\n        l_inv = 1.0 / ( (KAPPA * z[non_zero_z_indices]) / (1.0 + (KAPPA * z[non_zero_z_indices] / l_inf)) )\n        l_profile[non_zero_z_indices] = (1.0 / l_inv) * (1.0 / phi_m[non_zero_z_indices])\n        \n        # A more direct implementation, which also works correctly for z=0:\n        # denominator_l = 1.0 + (KAPPA * z / l_inf)\n        # l_z_neutral = (KAPPA * z) / denominator_l\n        # l_profile_v2 = np.divide(l_z_neutral, phi_m, out=np.zeros_like(l_z_neutral), where=phi_m!=0)\n        \n        # 5. Calculate the TKE profile e(z)\n        e_profile = (C_M / C_EPS) * (l_profile**2) * (S_profile**2)\n\n        # 6. Find the maximum value and round it.\n        max_e = np.max(e_profile)\n        results.append(max_e)\n\n    # Final print statement in the exact required format.\n    # Format each result to ensure six decimal places.\n    formatted_results = [f'{r:.6f}' for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "The closure problem is a general challenge in Earth system modeling that extends far beyond turbulence. This final practice explores a classic closure issue in atmospheric radiation: parameterizing the subgrid-scale vertical structure of clouds. Since large-scale models cannot resolve the detailed geometry of cloud layers, assumptions must be made about how they overlap vertically. By deriving and comparing the top-of-atmosphere albedo under two extreme assumptions—maximum and random overlap—this exercise  powerfully demonstrates how different closure choices for a geometric property can lead to significant differences in critical climate-relevant predictions.",
            "id": "3905165",
            "problem": "You are modeling shortwave radiative effects of clouds at the top of the atmosphere under different vertical overlap closure assumptions. The task is to derive, implement, and compare two extreme overlap closures—maximum overlap and random overlap—using a physically consistent, plane-parallel, two-stream adding framework.\n\nAssumptions and fundamental base:\n- Radiative transfer energy conservation in a plane-parallel slab implies that for a scattering layer with reflectance and transmittance, energy is conserved across reflections and transmissions.\n- The Independent Column Approximation (ICA) asserts that the top-of-atmosphere albedo can be computed as an area-weighted average over subcolumns that represent realizations of cloud presence or absence across layers.\n- Vertical overlap closures parameterize how subgrid cloud presence correlates between layers. Maximum overlap closure corresponds to perfect vertical coherence between cloudy regions, and random overlap closure corresponds to statistical independence of cloud occurrence between layers.\n\nPhysical quantities and definitions:\n- A cloud fraction profile consists of a set of layer fractions $\\{c_i\\}_{i=1}^N$, where each $c_i \\in [0,1]$ is the probability (or fractional area) that layer $i$ is cloudy.\n- Each cloudy layer $i$ has an associated, broadband shortwave optical depth $\\tau_i \\ge 0$ (dimensionless).\n- The clear-sky top-of-atmosphere albedo is denoted by $\\alpha_{\\mathrm{clr}} \\in [0,1]$ (dimensionless).\n- For an individual cloudy slab with optical depth $\\tau$, approximate its broadband shortwave reflectance $r(\\tau)$ by a well-tested empirical function $r(\\tau)$ that is monotonic in $\\tau$ and satisfies $r(0)=0$ and $r(\\tau)\\to 1$ as $\\tau\\to\\infty$. For implementation, use a rational function calibrated to observations with a positive constant parameter $\\gamma$, and define the corresponding transmittance as $t(\\tau)=1-r(\\tau)$ under the assumption of negligible absorption in the cloud.\n- When a cloudy slab with reflectance $r(\\tau)$ and transmittance $t(\\tau)$ overlays a system with effective reflectance $\\alpha$ beneath it, the two-stream adding principle implies that the net top-of-atmosphere reflectance $R(\\tau,\\alpha)$ is uniquely determined by repeated multiple reflections between the slab and the underlying reflector, conserving energy.\n\nOverlap closures to compare:\n- Maximum overlap closure: All cloudy layers align in the same subcolumn where clouds occur. The total cloudy area is the maximum layer fraction $C_{\\mathrm{max}}=\\max_i c_i$, and the cloud optical depths add in the aligned cloudy subcolumn yielding a combined optical depth $\\tau_{\\mathrm{sum}}=\\sum_{i=1}^N \\tau_i$.\n- Random overlap closure: Cloud presence in each layer is independent across layers. The column is represented by all $2^N$ subcolumns corresponding to subsets of layers that are cloudy, with probabilities given by the product of per-layer presence or absence probabilities.\n\nTasks:\n1. Starting from energy conservation and the Independent Column Approximation, derive from first principles an expression for $R(\\tau,\\alpha)$, the top-of-atmosphere reflectance of a cloudy slab of optical depth $\\tau$ over an underlying reflector with reflectance $\\alpha$. Show that the series of multiple reflections between the slab and the underlying reflector converges and yields a closed-form expression consistent with energy conservation for $r(\\tau)1$ and $\\alpha1$.\n2. Using the derived $R(\\tau,\\alpha)$, formulate the top-of-atmosphere albedo (dimensionless) under:\n   - Maximum overlap closure: $A_{\\mathrm{max}}$ defined by the area-weighted mixture of the aligned cloudy subcolumn with optical depth $\\tau_{\\mathrm{sum}}$ and the clear-sky region with reflectance $\\alpha_{\\mathrm{clr}}$.\n   - Random overlap closure: $A_{\\mathrm{rnd}}$ defined by the ICA area-weighted average over all $2^N$ subcolumns, each subcolumn’s optical depth being the sum of $\\tau_i$ for layers present.\n3. Compute the difference $\\Delta A = A_{\\mathrm{max}} - A_{\\mathrm{rnd}}$ (dimensionless) for each test case below. Provide results rounded to six decimal places.\n\nNumerical closure details for implementation:\n- Use $r(\\tau)=\\dfrac{\\tau}{\\tau+\\gamma}$ with a positive constant $\\gamma$ representing an empirical broadband scaling parameter, and $t(\\tau)=1-r(\\tau)$.\n- Use the two-stream adding relationship $R(\\tau,\\alpha)$ implied by multiple reflections between the slab and the underlying reflector.\n\nTest suite:\nEach test case is a tuple of the form $(\\{c_i\\}, \\{\\tau_i\\}, \\alpha_{\\mathrm{clr}}, \\gamma)$, with the following values:\n\n- Case 1 (general multi-layer): $\\{c_i\\}=[0.2,0.5,0.1]$, $\\{\\tau_i\\}=[5.0,10.0,0.5]$, $\\alpha_{\\mathrm{clr}}=0.08$, $\\gamma=7.7$.\n- Case 2 (no clouds, boundary): $\\{c_i\\}=[0.0,0.0]$, $\\{\\tau_i\\}=[1.0,20.0]$, $\\alpha_{\\mathrm{clr}}=0.10$, $\\gamma=7.7$.\n- Case 3 (fully cloudy, boundary): $\\{c_i\\}=[1.0,1.0]$, $\\{\\tau_i\\}=[3.0,3.0]$, $\\alpha_{\\mathrm{clr}}=0.06$, $\\gamma=7.7$.\n- Case 4 (thin over thick): $\\{c_i\\}=[0.5,0.5]$, $\\{\\tau_i\\}=[0.2,15.0]$, $\\alpha_{\\mathrm{clr}}=0.10$, $\\gamma=7.7$.\n- Case 5 (alternating high-low fractions): $\\{c_i\\}=[0.9,0.1,0.9,0.1]$, $\\{\\tau_i\\}=[20.0,1.0,15.0,1.0]$, $\\alpha_{\\mathrm{clr}}=0.12$, $\\gamma=7.7$.\n\nOutput:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of the cases above, with each $\\Delta A$ rounded to six decimal places (e.g., \"[0.012345,-0.000001,0.100000,0.000000,0.023456]\").\n\nAll quantities are dimensionless; optical depth, albedo, reflectance, and transmittance are unitless decimals. Angles are not involved in this problem.",
            "solution": "The problem requires the derivation and comparison of two cloud vertical overlap closure schemes—maximum and random overlap—within a simplified radiative transfer framework. A critical validation confirms the problem is scientifically sound, well-posed, and based on established principles of atmospheric radiative transfer. We can therefore proceed with the solution.\n\nThe solution is presented in three parts:\n1.  Derivation of the top-of-atmosphere (TOA) reflectance for a scattering layer over a reflective surface.\n2.  Formulation of the total atmospheric albedo under maximum and random overlap closures.\n3.  Application of these formulations to the provided test cases.\n\n### 1. Derivation of TOA Reflectance $R(\\tau, \\alpha)$\n\nWe are tasked to derive the expression for the TOA reflectance, $R(\\tau,\\alpha)$, of a single, non-absorbing scattering layer with optical depth $\\tau$ overlying a surface with albedo $\\alpha$. The layer is characterized by its reflectance $r(\\tau)$ and transmittance $t(\\tau)$. Due to the assumption of no absorption, energy conservation for the layer implies $r(\\tau) + t(\\tau) = 1$.\n\nWe model the multiple reflections between the layer and the underlying surface. Consider a unit of incident solar flux at the top of the layer.\n\nThe total reflected flux $R(\\tau,\\alpha)$ is the sum of an infinite series of flux contributions escaping to space:\n1.  The initial direct reflection from the top of the layer: $r(\\tau)$.\n2.  The flux that is transmitted down through the layer ($t(\\tau)$), reflects off the surface ($\\alpha$), and is transmitted back up through thelayer ($t(\\tau)$). This first-order contribution is $t(\\tau) \\cdot \\alpha \\cdot t(\\tau) = \\alpha t(\\tau)^2$.\n3.  The flux that is transmitted down, reflects up from the surface, reflects back down from the layer's base ($r(\\tau)$), reflects again from the surface ($\\alpha$), and is finally transmitted up through the layer ($t(\\tau)$). This second-order contribution is $t(\\tau) \\cdot \\alpha \\cdot r(\\tau) \\cdot \\alpha \\cdot t(\\tau) = \\alpha^2 r(\\tau) t(\\tau)^2$.\n4.  Each subsequent term represents an additional internal reflection within the layer-surface system. The $k$-th term (for $k \\ge 1$) corresponds to $k-1$ internal reflections and is given by $\\alpha^k r(\\tau)^{k-1} t(\\tau)^2$.\n\nSumming all contributions gives the total reflectance:\n$$\nR(\\tau, \\alpha) = r(\\tau) + \\alpha t(\\tau)^2 + \\alpha^2 r(\\tau) t(\\tau)^2 + \\alpha^3 r(\\tau)^2 t(\\tau)^2 + \\dots\n$$\nThe terms from the second onward form a geometric series. We can factor out $\\alpha t(\\tau)^2$:\n$$\nR(\\tau, \\alpha) = r(\\tau) + \\alpha t(\\tau)^2 \\left(1 + \\alpha r(\\tau) + (\\alpha r(\\tau))^2 + \\dots \\right)\n$$\nThe series in the parentheses is $\\sum_{k=0}^{\\infty} (\\alpha r(\\tau))^k$. For convergence, the common ratio must have a magnitude less than $1$. Since $r(\\tau) \\in [0, 1)$ and $\\alpha \\in [0, 1)$, the condition $|\\alpha r(\\tau)|  1$ is satisfied. The sum of the geometric series is $\\frac{1}{1 - \\alpha r(\\tau)}$.\n\nSubstituting the sum back, we get:\n$$\nR(\\tau, \\alpha) = r(\\tau) + \\frac{\\alpha t(\\tau)^2}{1 - \\alpha r(\\tau)}\n$$\nUsing the non-absorbing assumption $t(\\tau) = 1 - r(\\tau)$, we have:\n$$\nR(\\tau, \\alpha) = r(\\tau) + \\frac{\\alpha (1 - r(\\tau))^2}{1 - \\alpha r(\\tau)}\n$$\nThis is the closed-form expression for the TOA reflectance of the system. For the special case of a clear-sky column where $\\tau=0$, the reflectance function definition gives $r(0)=0$. Substituting this into the formula yields $R(0, \\alpha) = 0 + \\frac{\\alpha(1-0)^2}{1-0} = \\alpha$, which correctly recovers the underlying albedo, as expected.\n\nFor implementation, the problem specifies the reflectance function as $r(\\tau) = \\dfrac{\\tau}{\\tau+\\gamma}$ for a given positive constant $\\gamma$.\n\n### 2. Formulation of Albedo for Overlap Closures\n\nThe Independent Column Approximation (ICA) states that the domain-averaged TOA albedo is the sum of the albedos of independent subcolumns, weighted by their fractional areas.\n\n#### A. Maximum Overlap Closure\n\nIn the maximum overlap closure, all cloudy portions of the layers are assumed to be vertically aligned. This partitions the domain into two subcolumns: one fully cloudy and one fully clear.\n\n-   **Cloudy Subcolumn**: The fractional area of this subcolumn is determined by the maximum cloud fraction in any layer, $C_{\\mathrm{max}} = \\max(\\{c_i\\}_{i=1}^N)$. The clouds in all layers are stacked, so their optical depths add up, yielding a total optical depth of $\\tau_{\\mathrm{sum}} = \\sum_{i=1}^N \\tau_i$. The albedo of this column is $A_{\\mathrm{cld}} = R(\\tau_{\\mathrm{sum}}, \\alpha_{\\mathrm{clr}})$, where $\\alpha_{\\mathrm{clr}}$ is the clear-sky albedo.\n-   **Clear Subcolumn**: The remaining fraction of the domain, $1 - C_{\\mathrm{max}}$, is completely clear. The albedo of this subcolumn is simply $\\alpha_{\\mathrm{clr}}$.\n\nThe total domain-averaged albedo, $A_{\\mathrm{max}}$, is the area-weighted average:\n$$\nA_{\\mathrm{max}} = C_{\\mathrm{max}} \\cdot R(\\tau_{\\mathrm{sum}}, \\alpha_{\\mathrm{clr}}) + (1 - C_{\\mathrm{max}}) \\cdot \\alpha_{\\mathrm{clr}}\n$$\n\n#### B. Random Overlap Closure\n\nIn the random overlap closure, the presence of cloud in each layer is statistically independent. For a system with $N$ layers, this creates $2^N$ unique atmospheric subcolumns, corresponding to every possible combination of cloudy and clear layers.\n\nEach subcolumn can be indexed by a binary vector $S = (s_1, s_2, \\dots, s_N)$, where $s_i=1$ if layer $i$ is cloudy and $s_i=0$ if it is clear.\n\n-   **Subcolumn Area Fraction**: Due to the independence assumption, the probability (fractional area) of a subcolumn $S$ is the product of the individual layer probabilities:\n    $$\n    P(S) = \\prod_{i=1}^N \\left( (c_i)^{s_i} (1-c_i)^{1-s_i} \\right)\n    $$\n-   **Subcolumn Optical Depth**: The total optical depth of a subcolumn $S$ is the sum of the optical depths of its cloudy layers:\n    $$\n    \\tau_S = \\sum_{i=1}^N s_i \\tau_i\n    $$\n-   **Subcolumn Albedo**: The albedo of subcolumn $S$ is given by $A_S = R(\\tau_S, \\alpha_{\\mathrm{clr}})$.\n\nThe total domain-averaged albedo, $A_{\\mathrm{rnd}}$, is the sum of all subcolumn albedos weighted by their area fractions:\n$$\nA_{\\mathrm{rnd}} = \\sum_{S \\in \\{0,1\\}^N} P(S) \\cdot A_S = \\sum_{S \\in \\{0,1\\}^N} \\left[ \\left( \\prod_{i=1}^N (c_i)^{s_i} (1-c_i)^{1-s_i} \\right) \\cdot R\\left( \\sum_{i=1}^N s_i \\tau_i, \\alpha_{\\mathrm{clr}} \\right) \\right]\n$$\n\n### 3. Computation of $\\Delta A = A_{\\mathrm{max}} - A_{\\mathrm{rnd}}$\n\nThe final step is to implement the derived formulas for $A_{\\mathrm{max}}$ and $A_{\\mathrm{rnd}}$ for each of the provided test cases. The difference $\\Delta A$ will then be calculated and reported. The implementation will proceed by first defining the functions for $r(\\tau)$ and $R(\\tau, \\alpha)$, and then building functions to calculate $A_{\\mathrm{max}}$ and $A_{\\mathrm{rnd}}$ based on the logic described above. The random overlap calculation involves iterating through all $2^N$ possible cloud configurations.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# No other libraries outside the standard library or specified versions are permitted.\n\ndef solve():\n    \"\"\"\n    Computes and prints the difference in top-of-atmosphere albedo between\n    maximum and random overlap cloud closure assumptions for a set of test cases.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: General multi-layer\n        ({'cs': [0.2, 0.5, 0.1], 'taus': [5.0, 10.0, 0.5], 'alpha_clr': 0.08, 'gamma': 7.7}),\n        # Case 2: No clouds, boundary\n        ({'cs': [0.0, 0.0], 'taus': [1.0, 20.0], 'alpha_clr': 0.10, 'gamma': 7.7}),\n        # Case 3: Fully cloudy, boundary\n        ({'cs': [1.0, 1.0], 'taus': [3.0, 3.0], 'alpha_clr': 0.06, 'gamma': 7.7}),\n        # Case 4: Thin over thick\n        ({'cs': [0.5, 0.5], 'taus': [0.2, 15.0], 'alpha_clr': 0.10, 'gamma': 7.7}),\n        # Case 5: Alternating high-low fractions\n        ({'cs': [0.9, 0.1, 0.9, 0.1], 'taus': [20.0, 1.0, 15.0, 1.0], 'alpha_clr': 0.12, 'gamma': 7.7})\n    ]\n\n    results = []\n    \n    # Define physical functions based on the problem derivation\n    def r_func(tau, gamma):\n        \"\"\"Calculates cloudy slab reflectance.\"\"\"\n        if tau == 0:\n            return 0.0\n        return tau / (tau + gamma)\n\n    def R_func(tau, alpha_clr, gamma):\n        \"\"\"\n        Calculates top-of-atmosphere reflectance for a cloudy slab over a reflector\n        using the two-stream adding formula.\n        \"\"\"\n        if tau == 0:\n            return alpha_clr\n        \n        reflectance = r_func(tau, gamma)\n        # Assuming no absorption, transmittance t = 1 - r\n        transmittance = 1.0 - reflectance\n        \n        # Derived formula: R = r + (alpha * t^2) / (1 - alpha * r)\n        denominator = 1.0 - alpha_clr * reflectance\n        if denominator == 0:\n            # Physically unrealistic case, but for robustness\n            return 1.0 \n        \n        total_reflectance = reflectance + (alpha_clr * transmittance**2) / denominator\n        return total_reflectance\n\n    for case in test_cases:\n        cs = case['cs']\n        taus = case['taus']\n        alpha_clr = case['alpha_clr']\n        gamma = case['gamma']\n        \n        N = len(cs)\n\n        # --- Calculate A_max (Maximum Overlap) ---\n        if not cs:\n            C_max = 0.0\n        else:\n            C_max = max(cs)\n        \n        tau_sum = sum(taus)\n        \n        # Albedo of the single cloudy column\n        A_cld_max = R_func(tau_sum, alpha_clr, gamma)\n        \n        # Area-weighted total albedo\n        A_max = C_max * A_cld_max + (1.0 - C_max) * alpha_clr\n\n        # --- Calculate A_rnd (Random Overlap) ---\n        A_rnd = 0.0\n        if N > 0:\n            # Iterate through all 2^N possible subcolumns\n            for k in range(2**N):\n                prob_k = 1.0\n                tau_k = 0.0\n                for i in range(N):\n                    # Check if the i-th layer is cloudy in this subcolumn\n                    if (k >> i)  1:\n                        # Layer i is cloudy\n                        prob_k *= cs[i]\n                        tau_k += taus[i]\n                    else:\n                        # Layer i is clear\n                        prob_k *= (1.0 - cs[i])\n                \n                # If probability of a column is zero, it doesn't contribute\n                if prob_k > 0:\n                    A_k = R_func(tau_k, alpha_clr, gamma)\n                    A_rnd += prob_k * A_k\n        else: # No layers\n            A_rnd = alpha_clr\n\n        # Calculate the difference and store result\n        delta_A = A_max - A_rnd\n        results.append(delta_A)\n\n    # Format output as a string with results rounded to six decimal places.\n    # Using f-string formatting to ensure trailing zeros.\n    output_str = f\"[{','.join([f'{r:.6f}' for r in results])}]\"\n    print(output_str)\n\nsolve()\n\n```"
        }
    ]
}