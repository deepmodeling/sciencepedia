{
    "hands_on_practices": [
        {
            "introduction": "事件归因的核心任务是比较“事实”世界（包含人为影响）与“反事实”世界（不包含人为影响）中极端事件发生的频率。风险比（$RR$）是用于此比较的主要度量。本练习将重点关注如何根据模型输出的事件计数值来计算$RR$，并且至关重要的是，量化此估计的统计不确定性，这是做出可信归因声明的基础。",
            "id": "4041785",
            "problem": "一个全球耦合大气环流模型 (GCM) 被用于对一个热浪事件进行大样本事件归因分析。该热浪事件的阈值定义为日最高气温超过一个高分位数，该分位数通过一个长期的控制模拟校准得到。生成了两组仅使用大气的模拟，它们具有不同的外部强迫，但模型物理过程相同，样本量也相当：一组是包含现今强迫的“事实”世界，另一组是近似于工业化前强迫的“反事实”世界。设 $N_1$ 和 $N_0$ 分别表示在事实和反事实情景下，从所有集合成员及相关季节中汇集得到的独立日样本总数。设 $n_1$ 和 $n_0$ 为相应情景下超过阈值的次数。假设在每个世界内部，超阈值事件的发生是概率恒定的独立伯努利试验。\n\n在一次具体的分析中，模型在事实世界中生成了 $N_1 = 50{,}000$ 个日样本，其中有 $n_1 = 2{,}100$ 次超阈值事件；在反事实世界中生成了 $N_0 = 50{,}000$ 个日样本，其中有 $n_0 = 200$ 次超阈值事件。\n\n仅使用核心定义和二项抽样的大样本性质，完成以下任务：\n\n- 将事件的风险比 (RR) 定义为事实世界中的超阈值概率与反事实世界中的超阈值概率之比，并根据给定的计数计算其最大似然估计量。\n- 从二项模型和样本比例的大样本高斯近似出发，推导估计的风险比的自然对数的渐近标准误，然后使用给定的计数进行数值计算。\n\n将估计的风险比和其自然对数的渐近标准误均四舍五入至四位有效数字。报告无量纲量（不要将任何结果表示为百分比）。",
            "solution": "该问题具有科学依据，是良定的，并包含了唯一解所需的所有信息。我们可以开始分析。\n\n设 $p_1$ 为事实世界中日最高气温超阈值的真实概率，设 $p_0$ 为反事实世界中超阈值的真实概率。问题指出，在每个世界内部，超阈值事件的发生被建模为独立的伯努利试验。\n因此，事实世界中总共 $N_1$ 个样本里的超阈值次数 $n_1$ 是一个服从二项分布的随机变量的实现，即 $n_1 \\sim \\text{Bin}(N_1, p_1)$。\n同样，反事实世界中的超阈值次数 $n_0$ 服从 $n_0 \\sim \\text{Bin}(N_0, p_0)$。\n\n二项分布的概率参数 $p$ 的最大似然估计量 (MLE) 是样本比例 $\\hat{p} = \\frac{n}{N}$。\n因此，$p_1$ 和 $p_0$ 的最大似然估计量为：\n$$ \\hat{p}_1 = \\frac{n_1}{N_1} $$\n$$ \\hat{p}_0 = \\frac{n_0}{N_0} $$\n\n第一个任务是定义风险比 ($RR$) 并计算其最大似然估计量。\n$RR$ 定义为事实世界中的超阈值概率与反事实世界中的超阈值概率之比：\n$$ RR = \\frac{p_1}{p_0} $$\n\n根据最大似然估计量的不变性，参数函数的最大似然估计量等于将该函数应用于参数的最大似然估计量。因此，风险比的最大似然估计量（记为 $\\widehat{RR}$）为：\n$$ \\widehat{RR} = \\frac{\\hat{p}_1}{\\hat{p}_0} = \\frac{n_1/N_1}{n_0/N_0} $$\n\n使用给定的数据，$N_1 = 50,000$, $n_1 = 2,100$, $N_0 = 50,000$, 以及 $n_0 = 200$：\n$$ \\hat{p}_1 = \\frac{2,100}{50,000} = 0.042 $$\n$$ \\hat{p}_0 = \\frac{200}{50,000} = 0.004 $$\n$$ \\widehat{RR} = \\frac{0.042}{0.004} = 10.5 $$\n四舍五入到四位有效数字，我们得到 $\\widehat{RR} = 10.50$。\n\n第二个任务是推导估计的风险比的自然对数的渐近标准误，即 $\\text{SE}(\\ln(\\widehat{RR}))$。\n设 $g(p_1, p_0) = \\ln(RR) = \\ln(\\frac{p_1}{p_0}) = \\ln(p_1) - \\ln(p_0)$。我们感兴趣的是 $g(\\hat{p}_1, \\hat{p}_0) = \\ln(\\widehat{RR})$ 的标准误。\n\n根据中心极限定理，对于大样本，样本比例 $\\hat{p}_1$ 和 $\\hat{p}_0$ 的分布近似为高斯分布：\n$$ \\hat{p}_1 \\approx \\mathcal{N}\\left(p_1, \\frac{p_1(1-p_1)}{N_1}\\right) $$\n$$ \\hat{p}_0 \\approx \\mathcal{N}\\left(p_0, \\frac{p_0(1-p_0)}{N_0}\\right) $$\n其方差为 $\\text{Var}(\\hat{p}_1) = \\frac{p_1(1-p_1)}{N_1}$ 和 $\\text{Var}(\\hat{p}_0) = \\frac{p_0(1-p_0)}{N_0}$。由于事实和反事实模拟是独立的，所以 $\\text{Cov}(\\hat{p}_1, \\hat{p}_0) = 0$。\n\n我们使用多元Delta方法来求 $\\ln(\\widehat{RR})$ 的渐近方差。对于两个独立估计量 $\\hat{\\theta}_1, \\hat{\\theta}_2$ 的函数 $g(\\hat{\\theta}_1, \\hat{\\theta}_2)$，其方差近似为：\n$$ \\text{Var}(g(\\hat{\\theta}_1, \\hat{\\theta}_2)) \\approx \\left(\\frac{\\partial g}{\\partial \\theta_1}\\right)^2 \\text{Var}(\\hat{\\theta}_1) + \\left(\\frac{\\partial g}{\\partial \\theta_2}\\right)^2 \\text{Var}(\\hat{\\theta}_2) $$\n其中偏导数在真实参数值 $(\\theta_1, \\theta_2)$ 处计算。\n\n在我们的例子中，$\\theta_1 = p_1$, $\\theta_2 = p_0$, 并且 $g(p_1, p_0) = \\ln(p_1) - \\ln(p_0)$。其偏导数为：\n$$ \\frac{\\partial g}{\\partial p_1} = \\frac{1}{p_1} $$\n$$ \\frac{\\partial g}{\\partial p_0} = -\\frac{1}{p_0} $$\n\n将这些代入Delta方法的公式中：\n$$ \\text{Var}(\\ln(\\widehat{RR})) \\approx \\left(\\frac{1}{p_1}\\right)^2 \\text{Var}(\\hat{p}_1) + \\left(-\\frac{1}{p_0}\\right)^2 \\text{Var}(\\hat{p}_0) $$\n$$ \\text{Var}(\\ln(\\widehat{RR})) \\approx \\frac{1}{p_1^2} \\left( \\frac{p_1(1-p_1)}{N_1} \\right) + \\frac{1}{p_0^2} \\left( \\frac{p_0(1-p_0)}{N_0} \\right) $$\n$$ \\text{Var}(\\ln(\\widehat{RR})) \\approx \\frac{1-p_1}{p_1 N_1} + \\frac{1-p_0}{p_0 N_0} $$\n这是渐近方差。为了得到估计方差，我们将真实参数 $p_1$ 和 $p_0$ 替换为它们的最大似然估计量 $\\hat{p}_1$ 和 $\\hat{p}_0$：\n$$ \\widehat{\\text{Var}}(\\ln(\\widehat{RR})) = \\frac{1-\\hat{p}_1}{\\hat{p}_1 N_1} + \\frac{1-\\hat{p}_0}{\\hat{p}_0 N_0} $$\n代入 $\\hat{p}_1 = n_1/N_1$ 和 $\\hat{p}_0 = n_0/N_0$：\n$$ \\widehat{\\text{Var}}(\\ln(\\widehat{RR})) = \\frac{1 - n_1/N_1}{ (n_1/N_1) N_1} + \\frac{1 - n_0/N_0}{ (n_0/N_0) N_0} = \\frac{(N_1 - n_1)/N_1}{n_1} + \\frac{(N_0 - n_0)/N_0}{n_0} $$\n$$ \\widehat{\\text{Var}}(\\ln(\\widehat{RR})) = \\frac{N_1 - n_1}{n_1 N_1} + \\frac{N_0 - n_0}{n_0 N_0} $$\n这个表达式可以改写为：\n$$ \\widehat{\\text{Var}}(\\ln(\\widehat{RR})) = \\left(\\frac{1}{n_1} - \\frac{1}{N_1}\\right) + \\left(\\frac{1}{n_0} - \\frac{1}{N_0}\\right) $$\n渐近标准误是这个估计方差的平方根：\n$$ \\text{SE}(\\ln(\\widehat{RR})) = \\sqrt{\\frac{1}{n_1} - \\frac{1}{N_1} + \\frac{1}{n_0} - \\frac{1}{N_0}} $$\n\n现在，我们用给定的计数来数值计算这个值：\n$$ \\text{SE}(\\ln(\\widehat{RR})) = \\sqrt{\\frac{1}{2,100} - \\frac{1}{50,000} + \\frac{1}{200} - \\frac{1}{50,000}} $$\n$$ \\text{SE}(\\ln(\\widehat{RR})) = \\sqrt{\\frac{1}{2,100} + \\frac{1}{200} - \\frac{2}{50,000}} $$\n$$ \\text{SE}(\\ln(\\widehat{RR})) = \\sqrt{0.000476190... + 0.005 - 0.00004} $$\n$$ \\text{SE}(\\ln(\\widehat{RR})) = \\sqrt{0.005436190...} \\approx 0.07373052... $$\n四舍五入到四位有效数字，我们得到 $\\text{SE}(\\ln(\\widehat{RR})) = 0.07373$。\n\n所求的两个量是估计的风险比 $\\widehat{RR}$，和其对数的渐近标准误 $\\text{SE}(\\ln(\\widehat{RR}))$。\n- 估计的风险比：$10.50$\n- 对数风险比的渐近标准误：$0.07373$",
            "answer": "$$\\boxed{\\begin{pmatrix} 10.50  0.07373 \\end{pmatrix}}$$"
        },
        {
            "introduction": "在第一个练习的基础上，我们从单一的计算转向一个完整的计算工作流程。本练习涉及编写代码，以自动从集合数据中计算$RR$。它还引入了阈值敏感性这一关键概念，因为“极端事件”的定义可能带有主观性，而归因结果可能依赖于此定义。我们还将探讨如何处理那些在反事实集合中因极其罕见而未发生的事件。",
            "id": "3864390",
            "problem": "一项区域尺度的事件归因研究将超过固定日阈值的强降水作为关注事件。给定两个有限的日降水量模拟集合，单位为毫米/天 (mm/day)：一个代表包含所有观测强迫的“事实”气候 ($F$)，另一个代表移除了人为强迫的“反事实”气候 ($C$)。目标是计算在一系列阈值下的风险比，并检验其对阈值选择的敏感性。\n\n从概率作为指示函数期望的基本定义出发，在气候状态 $S \\in \\{F, C\\}$ 下，事件 $E$ 的概率可以定义为 $P_S(E) = \\mathbb{E}_S[\\mathbb{I}(X \\in E)]$，其中 $X$ 是一个日降水量随机变量，$\\mathbb{I}(\\cdot)$ 是指示函数。对于一个阈值 $\\tau$ (单位为 mm/day)，定义强降水事件 $E_{\\tau} = \\{x \\in \\mathbb{R} : x \\ge \\tau\\}$。给定一个有限集合 $x_{1:S}, x_{2:S}, \\ldots, x_{n_S:S}$，经验超越概率是指示函数值的样本均值。风险比则是同一阈值下，事实超越概率与反事实超越概率之比，通过遍历多个阈值来评估敏感性。\n\n您必须实现一个程序，对每个提供的测试用例执行以下步骤：\n- 计算在事实集合 $F$ 下，每个阈值 $\\tau$ 的经验超越概率，即大于或等于 $\\tau$ 的条目所占的比例。\n- 计算在反事实集合 $C$ 下，每个阈值 $\\tau$ 的经验超越概率，即大于或等于 $\\tau$ 的条目所占的比例。\n- 计算风险比 $RR(\\tau)$，即事实超越概率除以同一阈值下的反事实超越概率。\n- 边界情况处理必须遵循以下规则：\n  - 如果反事实超越概率为零，而事实超越概率严格为正，则 $RR(\\tau)$ 返回 $+\\infty$。\n  - 如果事实和反事实超越概率均为零，则 $RR(\\tau)$ 返回非数字（$\\mathrm{NaN}$）。\n  - 如果事实超越概率为零，而反事实超越概率严格为正，则 $RR(\\tau)$ 返回 $0$。\n\n所有阈值都必须视为 mm/day。风险比是无量纲的，应以浮点数形式返回。\n\n您的程序应生成单行输出，其中包含一个由方括号括起来的逗号分隔列表形式的结果，其中每个测试用例在不同阈值下的风险比，都以其自己的方括号括起来并以逗号分隔，所有这些都连接成最终的顶层列表。例如，输出格式必须类似于 $[[r_{1,1}, r_{1,2}], [r_{2,1}, r_{2,2}]]$，但使用实际计算出的值。\n\n使用以下测试套件，它涵盖了一般情况、概率相等的情况以及包括零超越概率在内的边界情况。所有降水值的单位均为 mm/day，所有阈值的单位也为 mm/day：\n\n- 测试用例 $1$（一般情况，事实集合中存在更高的极端值）：\n  - 事实集合 $F_1$: $[0, 5, 12, 35, 60, 85, 110, 20, 0, 40, 95, 10]$\n  - 反事实集合 $C_1$: $[0, 3, 8, 25, 40, 55, 70, 15, 0, 30, 60, 8]$\n  - 阈值扫描 $\\Tau_1$: $[20, 50, 80, 100]$\n\n- 测试用例 $2$（两种气候下情况近似相等）：\n  - 事实集合 $F_2$: $[2, 7, 15, 18, 22, 30, 45, 50, 5, 12]$\n  - 反事实集合 $C_2$: $[3, 6, 16, 17, 21, 28, 47, 52, 4, 13]$\n  - 阈值扫描 $\\Tau_2$: $[5, 25, 60]$\n\n- 测试用例 $3$（事实集合呈现更重的尾部，导致在更高阈值下出现无限大的风险比）：\n  - 事实集合 $F_3$: $[0, 20, 45, 70, 95, 130, 5, 35]$\n  - 反事实集合 $C_3$: $[0, 10, 25, 40, 55, 70, 5, 20]$\n  - 阈值扫描 $\\Tau_3$: $[40, 90, 130]$\n\n- 测试用例 $4$（两种气候都大体干燥，出现两种概率均为零的边界情况）：\n  - 事实集合 $F_4$: $[0, 0, 0, 1, 2]$\n  - 反事实集合 $C_4$: $[0, 0, 0, 1, 2]$\n  - 阈值扫描 $\\Tau_4$: $[1, 5]$\n\n您的程序应生成单行输出，其中包含一个由方括号括起来的逗号分隔列表形式的结果，其中每个内部列表包含其测试用例的风险比，顺序与阈值顺序相同。最终所需的输出格式为 $[[r_{1,1}, r_{1,2}, r_{1,3}, r_{1,4}], [r_{2,1}, r_{2,2}, r_{2,3}], [r_{3,1}, r_{3,2}, r_{3,3}], [r_{4,1}, r_{4,2}]]$，其中 $r_{i,j}$ 为浮点数（在适用时可能包括 $+\\infty$ 和 $\\mathrm{NaN}$）。",
            "solution": "该问题是有效的。它在科学上基于气候科学和统计学的原理，特别是在极端事件归因领域。该问题定义明确，提供了所有必要的数据、清晰的定义和明确的计算过程，包括对边界情况的处理。经验概率和风险比的定义在该领域是标准化的。\n\n目标是计算一系列阈值 $\\tau$ 下强降水事件的风险比 $RR(\\tau)$。该比率量化了在事实气候（有人为强迫）和反事实气候（无人为强迫）之间，极端事件发生概率的变化。\n\n在气候状态 $S$ 下，事件 $E$ 的基本概率定义由指示函数的期望给出：$P_S(E) = \\mathbb{E}_S[\\mathbb{I}(X \\in E)]$，其中 $X$ 是我们关注的随机变量（日降水量），$\\mathbb{I}(\\cdot)$ 是指示函数，当其参数为真时值为 $1$，否则为 $0$。我们关注的事件是日降水量超过阈值 $\\tau$，表示为 $E_{\\tau} = \\{x \\in \\mathbb{R} : x \\ge \\tau\\}$。\n\n给定来自气候状态 $S$ 的一个包含 $n_S$ 个模拟结果的有限集合 $\\{x_{1,S}, x_{2,S}, \\ldots, x_{n_S,S}\\}$，其期望通过样本均值来估计。因此，经验超越概率是集合成员中达到或超过阈值的比例：\n$$\nP_S(X \\ge \\tau) = \\frac{1}{n_S} \\sum_{i=1}^{n_S} \\mathbb{I}(x_{i,S} \\ge \\tau) = \\frac{\\text{count of } x_i \\text{ such that } x_i \\ge \\tau}{n_S}\n$$\n设 $P_F(\\tau)$ 为事实集合 $F$ 的超越概率，$P_C(\\tau)$ 为反事实集合 $C$ 的超越概率。在阈值 $\\tau$ 处的风险比定义为：\n$$\nRR(\\tau) = \\frac{P_F(\\tau)}{P_C(\\tau)}\n$$\n对于一个给定的测试用例，它包含一个事实集合 $F$、一个反事实集合 $C$ 和一组阈值 $\\Tau$，其计算过程如下。对每个阈值 $\\tau \\in \\Tau$：\n$1$. 计算 $F$ 中大于或等于 $\\tau$ 的值的数量，记为 $N_F(\\tau)$。\n$2$. 计算事实概率 $P_F(\\tau) = \\frac{N_F(\\tau)}{n_F}$，其中 $n_F$ 是集合 $F$ 的成员总数。\n$3$. 计算 $C$ 中大于或等于 $\\tau$ 的值的数量，记为 $N_C(\\tau)$。\n$4$. 计算反事实概率 $P_C(\\tau) = \\frac{N_C(\\tau)}{n_C}$，其中 $n_C$ 是集合 $C$ 的成员总数。\n$5$. 基于 $P_F(\\tau)$ 和 $P_C(\\tau)$ 的值，并应用指定的除法和边界情况规则来计算风险比 $RR(\\tau)$：\n    - 如果 $P_C(\\tau)  0$，则 $RR(\\tau) = \\frac{P_F(\\tau)}{P_C(\\tau)}$。这种情况既包括 $P_F(\\tau)  0$ 的情况，也包括 $P_F(\\tau) = 0$ 的情况（此时 $RR(\\tau)=0$）。\n    - 如果 $P_C(\\tau) = 0$ 且 $P_F(\\tau)  0$，则该事件在反事实气候中不可能发生，但在事实气候中可能发生。这意味着风险无限增大，因此 $RR(\\tau) = +\\infty$。\n    - 如果 $P_C(\\tau) = 0$ 且 $P_F(\\tau) = 0$，则在两个有限集合中均未观测到该事件。比率 $\\frac{0}{0}$ 是不确定的，表示没有足够的数据来量化风险的变化。因此，$RR(\\tau) = \\mathrm{NaN}$（非数字）。\n\n让我们以测试用例1为例进行演算：\n- 事实集合 $F_1 = [0, 5, 12, 35, 60, 85, 110, 20, 0, 40, 95, 10]$。其大小为 $n_F = 12$。\n- 反事实集合 $C_1 = [0, 3, 8, 25, 40, 55, 70, 15, 0, 30, 60, 8]$。其大小为 $n_C = 12$。\n- 阈值 $\\Tau_1 = [20, 50, 80, 100]$。\n\n对于 $\\tau = 20$：\n- $F_1$ 中的超越值：$\\{35, 60, 85, 110, 20, 40, 95\\}$。计数 $N_F(20) = 7$。$P_F(20) = \\frac{7}{12}$。\n- $C_1$ 中的超越值：$\\{25, 40, 55, 70, 30, 60\\}$。计数 $N_C(20) = 6$。$P_C(20) = \\frac{6}{12}$。\n- $RR(20) = \\frac{7/12}{6/12} = \\frac{7}{6} \\approx 1.167$。\n\n对于 $\\tau = 50$：\n- $F_1$ 中的超越值：$\\{60, 85, 110, 95\\}$。计数 $N_F(50) = 4$。$P_F(50) = \\frac{4}{12}$。\n- $C_1$ 中的超越值：$\\{55, 70, 60\\}$。计数 $N_C(50) = 3$。$P_C(50) = \\frac{3}{12}$。\n- $RR(50) = \\frac{4/12}{3/12} = \\frac{4}{3} \\approx 1.333$。\n\n对于 $\\tau = 80$：\n- $F_1$ 中的超越值：$\\{85, 110, 95\\}$。计数 $N_F(80) = 3$。$P_F(80) = \\frac{3}{12}$。\n- $C_1$ 中的超越值：无。计数 $N_C(80) = 0$。$P_C(80) = \\frac{0}{12} = 0$。\n- 由于 $P_F(80)  0$ 且 $P_C(80) = 0$，因此 $RR(80) = +\\infty$。\n\n对于 $\\tau = 100$：\n- $F_1$ 中的超越值：$\\{110\\}$。计数 $N_F(100) = 1$。$P_F(100) = \\frac{1}{12}$。\n- $C_1$ 中的超越值：无。计数 $N_C(100) = 0$。$P_C(100) = \\frac{0}{12} = 0$。\n- 由于 $P_F(100)  0$ 且 $P_C(100) = 0$，因此 $RR(100) = +\\infty$。\n\n测试用例1的最终风险比列表为 $[\\frac{7}{6}, \\frac{4}{3}, +\\infty, +\\infty]$。实现中将对这些值使用浮点数表示。同样的过程也适用于所有其他测试用例。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the risk ratio for heavy precipitation events across multiple thresholds\n    for a series of test cases, each with a factual and a counterfactual climate ensemble.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    # Each test case is a tuple: (Factual_Ensemble, Counterfactual_Ensemble, Threshold_Sweep)\n    test_cases = [\n        # Test Case 1 (general case with higher factual extremes)\n        ([0, 5, 12, 35, 60, 85, 110, 20, 0, 40, 95, 10],\n         [0, 3, 8, 25, 40, 55, 70, 15, 0, 30, 60, 8],\n         [20, 50, 80, 100]),\n        \n        # Test Case 2 (near equality across climates)\n        ([2, 7, 15, 18, 22, 30, 45, 50, 5, 12],\n         [3, 6, 16, 17, 21, 28, 47, 52, 4, 13],\n         [5, 25, 60]),\n         \n        # Test Case 3 (factual exhibits heavier tail leading to infinite ratios)\n        ([0, 20, 45, 70, 95, 130, 5, 35],\n         [0, 10, 25, 40, 55, 70, 5, 20],\n         [40, 90, 130]),\n         \n        # Test Case 4 (both climates largely dry, edge-case with both probabilities zero)\n        ([0, 0, 0, 1, 2],\n         [0, 0, 0, 1, 2],\n         [1, 5])\n    ]\n\n    all_results = []\n    for f_ensemble, c_ensemble, thresholds in test_cases:\n        # Convert lists to NumPy arrays for efficient vectorized operations\n        f_array = np.array(f_ensemble, dtype=float)\n        c_array = np.array(c_ensemble, dtype=float)\n        \n        n_f = len(f_array)\n        n_c = len(c_array)\n        \n        case_results = []\n        for tau in thresholds:\n            # Compute the number of exceedances for the factual ensemble\n            n_exceed_f = np.sum(f_array = tau)\n            # Compute the empirical exceedance probability for the factual ensemble\n            p_f = n_exceed_f / n_f\n            \n            # Compute the number of exceedances for the counterfactual ensemble\n            n_exceed_c = np.sum(c_array = tau)\n            # Compute the empirical exceedance probability for the counterfactual ensemble\n            p_c = n_exceed_c / n_c\n            \n            # Compute the risk ratio (RR) with specified edge-case handling\n            if p_c == 0.0:\n                if p_f  0.0:\n                    # Counterfactual prob = 0, Factual prob  0 - infinite risk\n                    rr = np.inf\n                else: # p_f is also 0.0\n                    # Both probabilities are 0 - Indeterminate (0/0)\n                    rr = np.nan\n            else:\n                # Standard case, including when p_f is 0 and p_c  0 (results in 0.0)\n                rr = p_f / p_c\n                \n            case_results.append(rr)\n        \n        all_results.append(case_results)\n\n    # Format the final output string as a list of lists.\n    # This involves creating a string representation for each inner list\n    # and then joining them together.\n    inner_list_strings = []\n    for result_list in all_results:\n        # Convert each number (including inf/nan) to its string representation\n        str_results = [str(r) for r in result_list]\n        # Join them with commas and enclose in brackets\n        inner_list_strings.append(f\"[{','.join(str_results)}]\")\n    \n    # Join the inner list strings with commas and enclose in top-level brackets\n    final_output_string = f\"[{','.join(inner_list_strings)}]\"\n    \n    print(final_output_string)\n\nsolve()\n```"
        },
        {
            "introduction": "本练习将超越简单的事件计数，采用一种更强大的、基于统计建模的“故事情节”方法。它演示了如何将极端事件概率的变化直接与气候驱动因子（如温度异常）联系起来。我们将构建一个模型，其中气候指数（本例中为干旱指数SPEI）的分布参数依赖于温度，从而量化全球变暖如何改变干旱风险。",
            "id": "3864314",
            "problem": "您的任务是使用一个依赖协变量的统计模型，来形式化并计算在变暖情景下多月干旱概率的变化。该模型针对的是标准化降水蒸散指数 (SPEI)。标准化降水蒸散指数 (SPEI) 被建模为一个月度随机变量，其条件取决于代表月平均温度异常的外部协变量。风险比 (RR) 量化了在反事实与事实协变量状态下，事件概率的分数变化。累积分布函数 (CDF) 用于将标准化异常值映射到概率。\n\n从以下基本依据出发：\n\n- 干旱事件的定义是随机变量超出（在此情景下为低尾事件）一个固定阈值。\n- 概率论性质：独立同分布的正态随机变量的平均值本身也是正态的，其均值相同，方差除以平均因子。\n- 事实：正态分布的累积分布函数 (CDF) 将标准化值映射到概率。\n- 要求：标准差必须为严格正值，这通过对依赖协变量的标准差使用指数链接来强制实现。\n\n按如下方式对月度 SPEI 进行建模。设月度 SPEI 由随机变量 $S \\mid x$ 表示，其中 $x$ 是一个标量协变量，等于月平均温度异常（单位一致即可；输出是无单位的概率）。假设\n$$\nS \\mid x \\sim \\mathcal{N}\\!\\left(\\mu(x), \\sigma(x)^{2}\\right),\n$$\n其依赖协变量的参数为\n$$\n\\mu(x) = \\beta_0 + \\beta_1 x, \\quad \\sigma(x) = \\exp\\!\\left(\\alpha_0 + \\alpha_1 x\\right).\n$$\n定义 $M$ 个月聚合 SPEI 为算术平均值\n$$\n\\overline{S}_M = \\frac{1}{M}\\sum_{i=1}^{M} S_i,\n$$\n其中，在固定的协变量状态 $x$ 条件下，$S_i$ 是 $S \\mid x$ 的独立同分布副本。干旱事件定义为 $\\overline{S}_M \\le \\tau$，其中 $\\tau$ 是一个固定阈值。在两种协变量状态下，一个基线（反事实）$x_0$ 和一个变暖（事实）$x_1$，定义\n$$\np_0 = \\mathbb{P}\\!\\left(\\overline{S}_M \\le \\tau \\mid x_0\\right), \\quad p_1 = \\mathbb{P}\\!\\left(\\overline{S}_M \\le \\tau \\mid x_1\\right),\n$$\n概率变化为\n$$\n\\Delta p = p_1 - p_0,\n$$\n风险比为\n$$\nRR = \\frac{p_1}{p_0}.\n$$\n\n您的程序必须对下面的每个测试用例，通过从模型假设和上述基本性质推导出事件 $\\overline{S}_M \\le \\tau$ 的概率，来计算 $\\Delta p$ 和 $RR$。在协变量状态 $x$ 的条件下，将各月份视为独立的。实现数值稳健的概率评估；如果某个概率在数值上计算为 $0$ 或 $1$，您必须将其裁剪到开区间 $\\left(10^{-300}, 1-10^{-300}\\right)$ 内，以避免在计算 $RR$ 时出现除以零的情况。\n\n测试套件参数化。对于每个用例，您将获得元组 $(M, \\tau, x_0, x_1, \\beta_0, \\beta_1, \\alpha_0, \\alpha_1)$:\n\n- 用例 A (正常路径): $(M=\\;3,\\; \\tau=\\;-1.0,\\; x_0=\\;0.0,\\; x_1=\\;2.0,\\; \\beta_0=\\;0.0,\\; \\beta_1=\\;-0.3,\\; \\alpha_0=\\;0.0,\\; \\alpha_1=\\;0.05)$。\n- 用例 B (无变化对照): $(M=\\;3,\\; \\tau=\\;-1.0,\\; x_0=\\;0.0,\\; x_1=\\;0.0,\\; \\beta_0=\\;0.0,\\; \\beta_1=\\;-0.3,\\; \\alpha_0=\\;0.0,\\; \\alpha_1=\\;0.05)$。\n- 用例 C (更长平均周期下的增强): $(M=\\;6,\\; \\tau=\\;-1.5,\\; x_0=\\;0.0,\\; x_1=\\;2.0,\\; \\beta_0=\\;0.2,\\; \\beta_1=\\;-0.5,\\; \\alpha_0=\\;0.0,\\; \\alpha_1=\\;0.1)$。\n- 用例 D (变暖情景下的方差收缩): $(M=\\;12,\\; \\tau=\\;-0.5,\\; x_0=\\;0.0,\\; x_1=\\;2.0,\\; \\beta_0=\\;0.0,\\; \\beta_1=\\;-0.05,\\; \\alpha_0=\\;\\ln(1.2),\\; \\alpha_1=\\;-0.15)$。\n- 用例 E (罕见事件基线): $(M=\\;3,\\; \\tau=\\;-2.5,\\; x_0=\\;0.0,\\; x_1=\\;2.0,\\; \\beta_0=\\;0.0,\\; \\beta_1=\\;-0.8,\\; \\alpha_0=\\;0.0,\\; \\alpha_1=\\;0.0)$。\n\n所有输出均为概率或比率，因此无单位。不涉及角度。\n\n最终输出格式要求：您的程序应生成单行输出，包含一个类似 JSON 的列表，其中包含多个双元素列表，按 A 到 E 的顺序对应每个测试用例。每个内部双元素列表必须是 $[\\Delta p, RR]$，且不含任何空格。例如，一个有效的输出形状是\n$$\n[[\\Delta p_A, RR_A],[\\Delta p_B, RR_B],[\\Delta p_C, RR_C],[\\Delta p_D, RR_D],[\\Delta p_E, RR_E]].\n$$",
            "solution": "目标是计算在变暖情景下，多月干旱事件的概率变化 $\\Delta p$ 和风险比 $RR$。这需要确定聚合标准化降水蒸散指数 (SPEI) 的概率分布。\n\n月度 SPEI，由随机变量 $S$ 表示，以温度异常协变量 $x$ 为条件，被建模为正态分布：\n$$\nS \\mid x \\sim \\mathcal{N}\\!\\left(\\mu(x), \\sigma(x)^{2}\\right)\n$$\n其中均值 $\\mu(x)$ 和标准差 $\\sigma(x)$ 由以下公式给出：\n$$\n\\mu(x) = \\beta_0 + \\beta_1 x\n$$\n$$\n\\sigma(x) = \\exp\\!\\left(\\alpha_0 + \\alpha_1 x\\right)\n$$\n问题将 $M$ 个月的聚合 SPEI $\\overline{S}_M$ 定义为 $M$ 个月度值的算术平均值：\n$$\n\\overline{S}_M = \\frac{1}{M}\\sum_{i=1}^{M} S_i\n$$\n在固定协变量状态 $x$ 的条件下，假定单个的月度 SPEI 值 $S_i$ 是独立同分布 (i.i.d.) 的，每个都遵循 $S \\mid x$ 的分布。\n\n正态分布的一个基本性质指出，独立正态随机变量的线性组合也服从正态分布。我们首先找到和 $T = \\sum_{i=1}^{M} S_i$ 的分布。和的期望与方差为：\n$$\n\\mathbb{E}[T \\mid x] = \\sum_{i=1}^{M} \\mathbb{E}[S_i \\mid x] = \\sum_{i=1}^{M} \\mu(x) = M \\mu(x)\n$$\n$$\n\\text{Var}(T \\mid x) = \\sum_{i=1}^{M} \\text{Var}(S_i \\mid x) = \\sum_{i=1}^{M} \\sigma(x)^2 = M \\sigma(x)^2\n$$\n第二个关于方差的等式成立是由于 $S_i$ 变量的独立性。因此，$T \\mid x \\sim \\mathcal{N}\\!\\left(M \\mu(x), M \\sigma(x)^2\\right)$。\n\n接下来，我们推导平均值 $\\overline{S}_M = \\frac{1}{M} T$ 的分布。使用期望和方差的缩放性质：\n$$\n\\mathbb{E}[\\overline{S}_M \\mid x] = \\mathbb{E}\\left[\\frac{1}{M} T \\mid x\\right] = \\frac{1}{M} \\mathbb{E}[T \\mid x] = \\frac{1}{M} (M \\mu(x)) = \\mu(x)\n$$\n$$\n\\text{Var}(\\overline{S}_M \\mid x) = \\text{Var}\\left(\\frac{1}{M} T \\mid x\\right) = \\left(\\frac{1}{M}\\right)^2 \\text{Var}(T \\mid x) = \\frac{1}{M^2} (M \\sigma(x)^2) = \\frac{\\sigma(x)^2}{M}\n$$\n因此，$M$ 个月聚合 SPEI 的分布也是正态的，其参数为：\n$$\n\\overline{S}_M \\mid x \\sim \\mathcal{N}\\!\\left(\\mu_{\\overline{S}_M}(x), \\sigma_{\\overline{S}_M}(x)^2\\right)\n$$\n其中均值为 $\\mu_{\\overline{S}_M}(x) = \\mu(x) = \\beta_0 + \\beta_1 x$，方差为 $\\sigma_{\\overline{S}_M}(x)^2 = \\frac{\\sigma(x)^2}{M}$。标准差为 $\\sigma_{\\overline{S}_M}(x) = \\frac{\\sigma(x)}{\\sqrt{M}} = \\frac{\\exp(\\alpha_0 + \\alpha_1 x)}{\\sqrt{M}}$。\n\n干旱事件定义为 $\\overline{S}_M \\le \\tau$。在给定 $x$ 的条件下，该事件的概率由推导出的 $\\overline{S}_M$ 正态分布的累积分布函数 (CDF) 给出。设 $\\Phi(z)$ 表示标准正态分布 $\\mathcal{N}(0, 1)$ 的 CDF。概率 $p(x) = \\mathbb{P}(\\overline{S}_M \\le \\tau \\mid x)$ 通过标准化变量计算得出：\n$$\np(x) = \\Phi\\left(\\frac{\\tau - \\mu_{\\overline{S}_M}(x)}{\\sigma_{\\overline{S}_M}(x)}\\right)\n$$\n代入均值和标准差的表达式：\n$$\np(x) = \\Phi\\left(\\frac{\\tau - (\\beta_0 + \\beta_1 x)}{\\exp(\\alpha_0 + \\alpha_1 x) / \\sqrt{M}}\\right) = \\Phi\\left(\\sqrt{M} \\cdot \\frac{\\tau - \\beta_0 - \\beta_1 x}{\\exp(\\alpha_0 + \\alpha_1 x)}\\right)\n$$\n基线 ($x_0$) 和变暖 ($x_1$) 情景下的概率分别为：\n$$\np_0 = p(x_0) = \\Phi\\left(\\sqrt{M} \\cdot \\frac{\\tau - \\beta_0 - \\beta_1 x_0}{\\exp(\\alpha_0 + \\alpha_1 x_0)}\\right)\n$$\n$$\np_1 = p(x_1) = \\Phi\\left(\\sqrt{M} \\cdot \\frac{\\tau - \\beta_0 - \\beta_1 x_1}{\\exp(\\alpha_0 + \\alpha_1 x_1)}\\right)\n$$\n根据这些概率，计算所需的指标：\n$$\n\\Delta p = p_1 - p_0\n$$\n$$\nRR = \\frac{p_1}{p_0}\n$$\n为了数值稳定性，如果任何计算出的概率 $p$ 在数值上为 $0$ 或 $1$，它将被裁剪到区间 $(10^{-300}, 1-10^{-300})$ 内。这可以防止在计算 $RR$ 时出现除以零的错误，并处理浮点数的限制。每个测试用例的计算过程就是将给定的参数代入这些推导出的公式中。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm\n\n#\n# solver_agent\n# A solver agent that generates a solution and final answer for a given problem.\n#\n\ndef solve():\n    \"\"\"\n    Computes the change in probability (Delta p) and risk ratio (RR) for drought events\n    under different climate scenarios based on a covariate-dependent statistical model for SPEI.\n    \"\"\"\n\n    # Test suite parameterization: (M, tau, x0, x1, beta0, beta1, alpha0, alpha1)\n    test_cases = [\n        # Case A (happy path)\n        (3, -1.0, 0.0, 2.0, 0.0, -0.3, 0.0, 0.05),\n        # Case B (no change control)\n        (3, -1.0, 0.0, 0.0, 0.0, -0.3, 0.0, 0.05),\n        # Case C (intensification with longer averaging)\n        (6, -1.5, 0.0, 2.0, 0.2, -0.5, 0.0, 0.1),\n        # Case D (variance contraction under warming)\n        (12, -0.5, 0.0, 2.0, 0.0, -0.05, np.log(1.2), -0.15),\n        # Case E (rare-event baseline)\n        (3, -2.5, 0.0, 2.0, 0.0, -0.8, 0.0, 0.0),\n    ]\n\n    # Constants for numerical stability\n    PROB_MIN = 1e-300\n    PROB_MAX = 1.0 - 1e-300\n\n    def calculate_probability(M, tau, x, beta0, beta1, alpha0, alpha1):\n        \"\"\"\n        Calculates the probability of an M-month drought event P(S_M_bar = tau | x).\n\n        Args:\n            M (int): Number of months for aggregation.\n            tau (float): Drought threshold.\n            x (float): Covariate value (temperature anomaly).\n            beta0 (float): Intercept for the mean model.\n            beta1 (float): Slope for the mean model.\n            alpha0 (float): Intercept for the log-std.dev. model.\n            alpha1 (float): Slope for the log-std.dev. model.\n\n        Returns:\n            float: The calculated probability, clipped for numerical stability.\n        \"\"\"\n        # Calculate the argument of the standard normal CDF\n        # z = sqrt(M) * (tau - mu(x)) / sigma(x)\n        mu_x = beta0 + beta1 * x\n        sigma_x = np.exp(alpha0 + alpha1 * x)\n        \n        # Denominator sigma_x must be positive, which np.exp ensures.\n        # Handle cases where sigma_x might be extremely small or large, though unlikely with given params.\n        z_score = np.sqrt(M) * (tau - mu_x) / sigma_x\n        \n        # Calculate probability using the standard normal CDF\n        p = norm.cdf(z_score)\n        \n        # Clip the probability for numerical robustness\n        p_clipped = max(PROB_MIN, min(p, PROB_MAX))\n        \n        return p_clipped\n\n    results = []\n    for case in test_cases:\n        M, tau, x0, x1, beta0, beta1, alpha0, alpha1 = case\n        \n        # Calculate probability for baseline (counterfactual) scenario\n        p0 = calculate_probability(M, tau, x0, beta0, beta1, alpha0, alpha1)\n        \n        # Calculate probability for warmed (factual) scenario\n        p1 = calculate_probability(M, tau, x1, beta0, beta1, alpha0, alpha1)\n        \n        # Compute the change in probability and the risk ratio\n        delta_p = p1 - p0\n        # p0 is guaranteed to be non-zero due to clipping\n        risk_ratio = p1 / p0\n        \n        results.append([delta_p, risk_ratio])\n\n    # Format the final output string as specified: [[dp_A,RR_A],[dp_B,RR_B],...]\n    inner_parts = [f\"[{dp},{rr}]\" for dp, rr in results]\n    final_output = f\"[{','.join(inner_parts)}]\"\n    \n    print(final_output)\n\nsolve()\n```"
        }
    ]
}