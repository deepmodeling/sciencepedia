{
    "hands_on_practices": [
        {
            "introduction": "任何复杂的物理参数化方案都始于对其基本组成部分的理解。本练习 () 旨在通过量纲分析，验证Gent-McWilliams (GM)参数化方案中关键参数的物理单位。通过推导涡旋传输系数 $A_{GM}$ 和伪速度 $\\mathbf{u}^*$ 的量纲，你将能更深刻地理解它们在海洋模型中的物理意义和作用。",
            "id": "3892955",
            "problem": "考虑一个由大尺度、厚度加权示踪物动力学描述的静力、Boussinesq近似的海洋，其中中尺度涡效应由 Gent–McWilliams (GM) 参数化方案表示。设浮力场由 $b(x,y,z,t)$ 表示，其物理量纲为加速度，并定义水平梯度算子 $\\nabla_{h}$ 和垂直导数算子 $\\partial_{z}$。等密面斜率矢量定义为\n$$\n\\mathbf{s} \\equiv -\\frac{\\nabla_{h} b}{\\partial_{z} b},\n$$\nGM 参数化方案引入了一个侧向涡输运系数 $A_{GM}$ 和一个无辐散的团块（涡致）速度 $\\mathbf{u}^{*}$，后者是根据 $A_{GM}$ 和无量纲斜率场 $\\mathbf{s}$ 的空间梯度通过基于流函数的构造得到的。你可以无需证明地使用以下基本事实：\n- 一个标量 $q$ 的菲克扩散通量形式为 $\\mathbf{F}_{\\text{diff}}=-K\\,\\nabla q$，其中 $K$ 是扩散系数。\n- 对于不可压缩水平流，流函数 $\\psi$ 满足 $u=\\partial_{y}\\psi$ 和 $v=-\\partial_{x}\\psi$，等价于 $\\mathbf{u}=\\hat{\\mathbf{k}}\\times\\nabla\\psi$，其中 $\\hat{\\mathbf{k}}$ 是垂直方向的单位矢量。\n\n仅使用基于这些基础事实和上述 $\\mathbf{s}$ 定义的量纲分析：\n1. 确定指数 $a_{L}$ 和 $a_{T}$，使得 GM 系数量纲为 $[A_{GM}]=L^{a_{L}}T^{a_{T}}$。\n2. 证明通过基于流函数的构造，由 $A_{GM}$ 和斜率梯度构造的团块速度 $\\mathbf{u}^{*}$ 具有速度的量纲，并确定指数 $b_{L}$ 和 $b_{T}$，使得 $[\\mathbf{u}^{*}]=L^{b_{L}}T^{b_{T}}$。\n\n将你的最终答案表示为一个单行矩阵，其中包含按 $a_{L}$、$a_{T}$、$b_{L}$、$b_{T}$ 顺序排列的四个指数。最终表达式中不包含单位。无需四舍五入。",
            "solution": "我们从题中所述的定义和基本量纲事实出发。首先，我们分析等密面斜率矢量 $\\mathbf{s}$。浮力 $b$ 的量纲为加速度，我们记作 $[b]=LT^{-2}$。水平梯度算子 $\\nabla_{h}$ 贡献一个因子 $L^{-1}$，垂直导数算子 $\\partial_{z}$ 也贡献一个因子 $L^{-1}$。因此，\n$$\n[\\nabla_{h} b]=L^{-1}\\,[b]=L^{-1}\\,(LT^{-2})=T^{-2},\\qquad [\\partial_{z} b]=L^{-1}\\,[b]=L^{-1}\\,(LT^{-2})=T^{-2}.\n$$\n因此斜率矢量，\n$$\n\\mathbf{s}=-\\frac{\\nabla_{h} b}{\\partial_{z} b},\n$$\n是两个量纲均为 $T^{-2}$ 的物理量的比值，所以它是无量纲的：\n$$\n[\\mathbf{s}]=1.\n$$\n\n接下来，我们确定 Gent–McWilliams 涡输运系数 $A_{GM}$ 的量纲。关于标量 $q$ 的菲克扩散通量的基本事实是 $\\mathbf{F}_{\\text{diff}}=-K\\,\\nabla q$，其中 $K$ 是一个扩散系数。该表达式的量纲一致性要求\n$$\n[\\mathbf{F}_{\\text{diff}}]=[q]\\,[\\mathbf{u}]\\quad\\text{and}\\quad [\\nabla q]=[q]\\,L^{-1}.\n$$\n因此，$K$ 必须满足\n$$\n[K]\\,[q]\\,L^{-1} = [q]\\,[\\mathbf{u}] = [q]\\,LT^{-1},\n$$\n这意味着\n$$\n[K]=L^{2}T^{-1}.\n$$\nGM 系数 $A_{GM}$ 是一种作用于示踪物等密面梯度的涡输运（类扩散）系数；根据与 $K$ 相同的量纲逻辑，其量纲为面积除以时间。因此，\n$$\n[A_{GM}]=L^{2}T^{-1}.\n$$\n由此我们读出 $a_{L}=2$ 和 $a_{T}=-1$。\n\n最后，我们证明由 $A_{GM}$ 和斜率梯度构造的团块速度 $\\mathbf{u}^{*}$ 具有速度的量纲，并确定其指数。题目陈述 $\\mathbf{u}^{*}$ 是通过基于流函数的构造，由 $A_{GM}$ 和无量纲斜率场 $\\mathbf{s}$ 的空间梯度构造出来的。有两条等价的量纲路径可以得出这个结论：\n\n1. 流函数路径。对于不可压缩水平流，流函数 $\\psi$ 满足 $\\mathbf{u}=\\hat{\\mathbf{k}}\\times\\nabla\\psi$，其中 $\\nabla$ 贡献一个因子 $L^{-1}$。在 GM 构造中，流函数是通过 $A_{GM}$ 和无量纲斜率场 $\\mathbf{s}$ 相乘得到的，可能还包括本身是无量纲的空间平均或平滑截断函数。因此，\n$$\n[\\psi]\\sim [A_{GM}]\\,[\\mathbf{s}]=L^{2}T^{-1}\\times 1=L^{2}T^{-1}.\n$$\n应用梯度得到速度，\n$$\n[\\mathbf{u}^{*}]=[\\nabla\\psi]=L^{-1}\\,[\\psi]=L^{-1}\\,(L^{2}T^{-1})=LT^{-1}.\n$$\n\n2. 斜率梯度路径。或者，如果直接通过 $A_{GM}$ 乘以无量纲斜率场的空间梯度来构造 $\\mathbf{u}^{*}$（例如，示意性地写作 $\\mathbf{u}^{*}\\sim A_{GM}\\,\\nabla\\mathbf{s}$），那么\n$$\n[\\nabla\\mathbf{s}]=L^{-1}\\,[\\mathbf{s}]=L^{-1}\\times 1=L^{-1},\n$$\n于是\n$$\n[\\mathbf{u}^{*}]\\sim [A_{GM}]\\,[\\nabla\\mathbf{s}]=\\left(L^{2}T^{-1}\\right)\\left(L^{-1}\\right)=LT^{-1}.\n$$\n\n两条路径都得到 $[\\mathbf{u}^{*}]=LT^{-1}$，即速度的量纲。因此指数为 $b_{L}=1$ 和 $b_{T}=-1$。\n\n按要求将指数按 $a_{L}$、$a_{T}$、$b_{L}$、$b_{T}$ 的顺序汇总，我们有：\n$$\na_{L}=2,\\quad a_{T}=-1,\\quad b_{L}=1,\\quad b_{T}=-1.\n$$",
            "answer": "$$\\boxed{\\begin{pmatrix}2  -1  1  -1\\end{pmatrix}}$$"
        },
        {
            "introduction": "在掌握了基本参数的物理意义之后，我们来探讨GM方案的核心概念：等密度面斜率。本练习 () 将引导你计算在给定的海洋层结廓线下，该斜率如何随深度变化，并找出它在何处变得不切实际地陡峭，从而理解为何在模型中必须引入“斜率限制”。这个实践将理论与数值模拟中的实际问题联系起来，展示了物理理论如何在模型中被实际应用和修正。",
            "id": "3892999",
            "problem": "考虑一个由原始方程在与 Gent–McWilliams (GM) 参数化相关的小坡度极限下支配的稳定层结、静力平衡的 Boussinesq 海洋。设浮力定义为 $b = -g(\\rho - \\rho_{0})/\\rho_{0}$，层结由 Brunt–Väisälä 频率 $N^{2}(z) = \\partial b/\\partial z$ 衡量，其中 $z \\ge 0$ 表示正下方向的垂直坐标，且 $z=0$ 位于海洋表面。在 GM 框架中，等密面坡度矢量 $\\mathbf{s}$ 表征了等浮力面的方向，并进入涡致输运闭合项。\n\n假设存在一个水平均匀、不随深度变化的水平浮力梯度，其大小为 $|\\nabla_{h} b| = G$，以及一个随深度变化的单调层结剖面 $N^{2}(z)$，由下式给出：\n$$\nN^{2}(z) = N_{0}^{2} \\exp\\!\\left(-\\frac{z}{H}\\right) + N_{d}^{2}, \\quad z \\ge 0,\n$$\n其中 $N_{0}^{2} = 1.5 \\times 10^{-4}\\ \\mathrm{s}^{-2}$，$H = 1000\\ \\mathrm{m}$，$N_{d}^{2} = 1.0 \\times 10^{-6}\\ \\mathrm{s}^{-2}$，以及 $G = 2.0 \\times 10^{-8}\\ \\mathrm{s}^{-2}$。GM 方案通常会施加一个坡度限制以强制执行小角度假设，此处取为 $s_{\\mathrm{lim}} = 3.0 \\times 10^{-3}$。\n\n从上述定义和等浮力面的基本运动学关系出发，推导出等密面坡度的大小 $||\\mathbf{s}(z)||$（用 $G$ 和 $N^{2}(z)$ 表示），并确定临界深度 $z_{c}$，在该深度处 $||\\mathbf{s}(z_{c})|| = s_{\\mathrm{lim}}$。从物理上解释相对于 $z_{c}$ 何时需要进行坡度限制。以米为单位表示临界深度 $z_{c}$ 的最终答案，并将结果四舍五入至三位有效数字。在推导过程中出现的任何角度量均隐式使用弧度，不要以度为单位报告角度。",
            "solution": "首先，我们推导等密面（等浮力面）坡度大小的表达式。根据定义，等浮力面是指 $b(x, y, z) = \\text{常数}$ 的曲面。沿着该曲面，浮力的全微分为零：\n$$\ndb = \\frac{\\partial b}{\\partial x} dx + \\frac{\\partial b}{\\partial y} dy + \\frac{\\partial b}{\\partial z} dz = 0\n$$\n这可以写作矢量形式 $\\nabla_h b \\cdot d\\mathbf{r}_h + \\frac{\\partial b}{\\partial z} dz = 0$，其中 $\\nabla_h b = (\\partial b/\\partial x, \\partial b/\\partial y)$ 是水平浮力梯度，$d\\mathbf{r}_h = (dx, dy)$ 是水平位移。\n\n等密面坡度矢量 $\\mathbf{s}$ 定义为等密面深度 $z_b$ 的水平梯度，即 $\\mathbf{s} = \\nabla_h z_b$。从全微分表达式中，我们可以得到：\n$$\ndz = -\\frac{\\nabla_h b}{\\partial b/\\partial z} \\cdot d\\mathbf{r}_h\n$$\n根据 $z_b(x, y)$ 的定义，我们也有 $dz = (\\nabla_h z_b) \\cdot d\\mathbf{r}_h$。比较这两个表达式，可得：\n$$\n\\mathbf{s} = \\nabla_h z_b = -\\frac{\\nabla_h b}{\\partial b/\\partial z}\n$$\n坡度的大小为：\n$$\n||\\mathbf{s}(z)|| = \\frac{|\\nabla_h b|}{|\\partial b/\\partial z|}\n$$\n根据问题所给的定义，$|\\nabla_h b| = G$ 且 $\\partial b/\\partial z = N^2(z)$。因此，坡度大小的表达式为：\n$$\n||\\mathbf{s}(z)|| = \\frac{G}{N^2(z)}\n$$\n接下来，我们确定临界深度 $z_c$，在该深度处坡度达到极限值 $s_{\\mathrm{lim}}$：\n$$\n||\\mathbf{s}(z_c)|| = \\frac{G}{N^2(z_c)} = s_{\\mathrm{lim}}\n$$\n由此解出临界层结值：\n$$\nN^2(z_c) = \\frac{G}{s_{\\mathrm{lim}}}\n$$\n将给定的层结剖面表达式代入上式：\n$$\nN_{0}^{2} \\exp\\left(-\\frac{z_c}{H}\\right) + N_{d}^{2} = \\frac{G}{s_{\\mathrm{lim}}}\n$$\n现在，我们求解 $z_c$：\n$$\n\\exp\\left(-\\frac{z_c}{H}\\right) = \\frac{1}{N_0^2} \\left( \\frac{G}{s_{\\mathrm{lim}}} - N_{d}^{2} \\right)\n$$\n$$\n-\\frac{z_c}{H} = \\ln\\left[ \\frac{1}{N_0^2} \\left( \\frac{G}{s_{\\mathrm{lim}}} - N_{d}^{2} \\right) \\right]\n$$\n$$\nz_c = -H \\ln\\left[ \\frac{1}{N_0^2} \\left( \\frac{G}{s_{\\mathrm{lim}}} - N_{d}^{2} \\right) \\right] = H \\ln\\left[ \\frac{N_0^2}{\\frac{G}{s_{\\mathrm{lim}}} - N_{d}^{2}} \\right]\n$$\n现在代入数值进行计算：\n$$\n\\frac{G}{s_{\\mathrm{lim}}} = \\frac{2.0 \\times 10^{-8}\\ \\mathrm{s}^{-2}}{3.0 \\times 10^{-3}} = \\frac{2}{3} \\times 10^{-5}\\ \\mathrm{s}^{-2} \\approx 6.67 \\times 10^{-6}\\ \\mathrm{s}^{-2}\n$$\n$$\n\\frac{G}{s_{\\mathrm{lim}}} - N_d^2 = \\left(\\frac{2}{3} \\times 10^{-5}\\right) - (1.0 \\times 10^{-6}) = \\left(\\frac{20}{3} - 1\\right) \\times 10^{-6} = \\frac{17}{3} \\times 10^{-6}\\ \\mathrm{s}^{-2}\n$$\n$$\nz_c = 1000\\ \\mathrm{m} \\times \\ln\\left( \\frac{1.5 \\times 10^{-4}\\ \\mathrm{s}^{-2}}{\\frac{17}{3} \\times 10^{-6}\\ \\mathrm{s}^{-2}} \\right) = 1000 \\times \\ln\\left( \\frac{1.5 \\times 3 \\times 10^2}{17} \\right) = 1000 \\times \\ln\\left( \\frac{450}{17} \\right)\n$$\n$$\nz_c \\approx 1000 \\times \\ln(26.4705...) \\approx 1000 \\times 3.27601 \\approx 3276.01\\ \\mathrm{m}\n$$\n将结果四舍五入至三位有效数字，我们得到 $z_c \\approx 3280 \\ \\mathrm{m}$，或 $3.28 \\times 10^3 \\ \\mathrm{m}$。\n\n物理上，层结 $N^2(z)$ 随深度 $z$ 的增加而减弱。由于坡度 $||\\mathbf{s}(z)|| = G/N^2(z)$，这意味着坡度会随深度的增加而变大。因此，在深度小于 $z_c$ 的区域，层结较强，坡度小于 $s_{\\mathrm{lim}}$，无需限制。在深度大于 $z_c$ 的区域，层结变得很弱，计算出的坡度会超过 $s_{\\mathrm{lim}}$，变得不切实际地陡峭。在这些区域，必须强制施加坡度限制，以保证 GM 参数化方案的物理合理性和数值稳定性。",
            "answer": "$$\n\\boxed{3.28 \\times 10^{3}}\n$$"
        },
        {
            "introduction": "最后的练习是一个综合性的编程任务，将理论知识转化为实际代码 ()。你将从第一性原理出发，为一个由GM伪速度驱动的示踪剂平流过程，设计并实现一个有限体积数值格式。通过构建一个离散守恒的格式，这个练习将让你深入了解在模型中忠实地再现物理守恒律所需的数值结构，这是连接理论与地球系统模型实践的关键一步。",
            "id": "3892956",
            "problem": "设计并实现一个在二维均匀网格上对被动示踪剂进行 Gent and McWilliams (GM) 中尺度涡平流的通量形式离散化方案，并证明该方案在周期性边界条件下能保证示踪剂质量的离散守恒。\n\n推导和实现必须从流场中被动标量的基本守恒律出发：即标量守恒方程、通量形式平流的定义，以及通过涡致流函数从反对称输运张量推导出的 GM 巨砾速度的有效表示。您不得假定任何预先给定的离散公式；所有公式都必须从第一性原理推导得出。\n\n推导的基础是：\n- 通量形式的示踪剂守恒律：$$\\frac{\\partial c}{\\partial t} + \\nabla \\cdot \\boldsymbol{F} = 0,$$ 其中 $c$ 是示踪剂浓度，$\\boldsymbol{F}$ 是示踪剂通量。\n- 由速度场引起的通量形式平流：$$\\boldsymbol{F}_{\\text{adv}} = \\boldsymbol{u} \\, c,$$ 其中 $\\boldsymbol{u}$ 是一个以 $\\mathrm{m/s}$ 为单位的速度场。\n- Gent and McWilliams (GM) 中尺度涡参数化方案，由一个反对称输运张量 $\\boldsymbol{K}_{s}$ 表示，它产生一个有效的巨砾速度 $$\\boldsymbol{u}^{\\star} = \\nabla \\cdot \\boldsymbol{K}_{s},$$ 使得由 GM 涡引起的示踪剂趋势可以写成守恒的通量形式 $$\\frac{\\partial c}{\\partial t} + \\nabla \\cdot \\left( \\boldsymbol{u}^{\\star} c \\right) = 0.$$ 在二维情况下，您可以用一个标量涡致流函数 $\\psi$ 来表示 $\\boldsymbol{K}_{s}$，其方式在数学上与反对称张量一致。您的推导必须确保在所选网格上，通过构造离散地满足 $\\nabla \\cdot \\boldsymbol{u}^{\\star} = 0$。\n\n您必须：\n1. 在一个具有周期性、均匀的 $N_x \\times N_y$ 单元的笛卡尔网格上推导出一个离散的、有限体积的通量形式平流方案，该网格的间距为 $\\Delta x$ 和 $\\Delta y$（单位为 $\\mathrm{m}$）。其中，面法向速度由定义在网格角点上的离散涡致流函数 $\\psi$（单位为 $\\mathrm{m^2/s}$）获得。证明您从 $\\psi$ 推导出的离散面法向速度能保证 $\\boldsymbol{u}^{\\star}$ 的离散无辐散性，并且通量形式的更新能够精确地（在浮点舍入误差范围内）守恒全域积分的示踪剂质量。\n2. 在显式向前欧拉时间步进格式中，为了数值稳定性，在面上使用迎风通量。使用面法向速度定义并应用 Courant–Friedrichs–Lewy (CFL) 时间步长限制，使得 $$\\Delta t = \\frac{\\mathrm{CFL}}{\\frac{u_{\\max}}{\\Delta x} + \\frac{v_{\\max}}{\\Delta y}},$$ 其中 $u_{\\max}$ 和 $v_{\\max}$ 是面法向速度在 $\\mathrm{m/s}$ 单位下的最大绝对值，$\\Delta t$ 的单位是 $\\mathrm{s}$。如果所有速度均为零，您必须选择一个以秒为单位的有限 $\\Delta t$。\n3. 通过计算总示踪剂质量 $M(t)$（单位为 $\\mathrm{m^2}$，因为 $c$ 是无量纲的）$$M(t) = \\sum_{i,j} c_{i,j}(t) \\, \\Delta x \\, \\Delta y,$$ 来证明离散示踪剂质量守恒，并报告每个测试案例的绝对质量误差 $|M(T_{\\text{end}}) - M(0)|$（单位为 $\\mathrm{m^2}$）。\n4. 在 $x$ 和 $y$ 两个方向上都使用周期性边界条件。\n\n物理和数值单位：\n- 示踪剂浓度 $c$ 是无量纲的。\n- 流函数 $\\psi$ 的单位是 $\\mathrm{m^2/s}$。\n- 速度 $u^{\\star}$ 和 $v^{\\star}$ 的单位是 $\\mathrm{m/s}$。\n- 时间步长 $\\Delta t$ 的单位是 $\\mathrm{s}$。\n- 总示踪剂质量以 $\\mathrm{m^2}$ 报告。\n\n测试套件：\n在一个具有周期性边界的均匀域上实现四个测试案例。使用 $L_x = L_y = 10^6 \\, \\mathrm{m}$，$N_x = N_y = 64$，因此 $\\Delta x = L_x/N_x$ 且 $\\Delta y = L_y/N_y$。\n\n对于每个案例，在网格角点坐标 $(x_{i+\\frac{1}{2}}, y_{j+\\frac{1}{2}})$ 处定义 $\\psi(x,y)$，并在单元中心 $(x_i, y_j)$ 处定义初始示踪剂场 $c(x,y)$，具体如下：\n\n- 案例 A (平滑流场与示踪剂，中等 CFL):\n  - $\\psi(x,y) = \\psi_0 \\sin\\left(\\frac{2\\pi x}{L_x}\\right) \\sin\\left(\\frac{2\\pi y}{L_y}\\right)$，其中 $\\psi_0 = 10^5 \\, \\mathrm{m^2/s}$。\n  - $c(x,y) = 1 + 0.5 \\cos\\left(\\frac{2\\pi x}{L_x}\\right) \\cos\\left(\\frac{2\\pi y}{L_y}\\right)$。\n  - $\\mathrm{CFL} = 0.4$，时间步数 $N_{\\text{steps}} = 200$。\n\n- 案例 B (零流场基准):\n  - $\\psi(x,y) \\equiv 0$。\n  - $c(x,y) = 1 + 0.5 \\cos\\left(\\frac{2\\pi x}{L_x}\\right) \\cos\\left(\\frac{2\\pi y}{L_y}\\right)$。\n  - 选择任意以秒为单位的有限 $\\Delta t$；设置 $\\mathrm{CFL} = 0.4$ 和 $N_{\\text{steps}} = 200$。\n\n- 案例 C (更强流场，接近 CFL 极限):\n  - $\\psi(x,y) = \\psi_0 \\sin\\left(\\frac{2\\pi x}{L_x}\\right) \\sin\\left(\\frac{2\\pi y}{L_y}\\right)$，其中 $\\psi_0 = 2.5 \\times 10^5 \\, \\mathrm{m^2/s}$。\n  - $c(x,y) = 1 + 0.5 \\cos\\left(\\frac{2\\pi x}{L_x}\\right) \\cos\\left(\\frac{2\\pi y}{L_y}\\right)$。\n  - $\\mathrm{CFL} = 0.95$，时间步数 $N_{\\text{steps}} = 100$。\n\n- 案例 D (更丰富的流函数结构；不连续示踪剂挑战):\n  - $\\psi(x,y) = \\psi_0 \\left[\\sin\\left(\\frac{2\\pi x}{L_x}\\right) \\sin\\left(\\frac{4\\pi y}{L_y}\\right) + \\frac{1}{2}\\sin\\left(\\frac{3\\pi x}{L_x}\\right)\\sin\\left(\\frac{3\\pi y}{L_y}\\right)\\right]$，其中 $\\psi_0 = 10^5 \\, \\mathrm{m^2/s}$。\n  - $c(x,y) = \\frac{1}{2}\\left[1 + \\operatorname{sign}\\left(\\sin\\left(\\frac{8\\pi x}{L_x}\\right)\\sin\\left(\\frac{8\\pi y}{L_y}\\right)\\right)\\right]$，其中 $\\operatorname{sign}(z) \\in \\{-1,0,1\\}$。\n  - $\\mathrm{CFL} = 0.6$，时间步数 $N_{\\text{steps}} = 150$。\n\n算法要求：\n- 在网格角点上定义涡致流函数 $\\psi$，并使用与定义 $\\boldsymbol{u}^{\\star} = \\nabla \\times (\\psi \\, \\hat{\\boldsymbol{k}})$ 一致的离散偏导数来推导面法向速度，使得：\n  - $$u^{\\star}_{i+\\frac{1}{2},j} = \\frac{\\psi_{i+\\frac{1}{2},j+\\frac{1}{2}} - \\psi_{i+\\frac{1}{2},j-\\frac{1}{2}}}{\\Delta y}, \\quad v^{\\star}_{i,j+\\frac{1}{2}} = -\\frac{\\psi_{i+\\frac{1}{2},j+\\frac{1}{2}} - \\psi_{i-\\frac{1}{2},j+\\frac{1}{2}}}{\\Delta x}。$$\n- 在构造面通量 $F = u^{\\star} c$ 或 $F = v^{\\star} c$ 时，使用与面法向速度符号一致的迎风面示踪剂状态。\n- 通过有限体积通量散度更新 $c$：$$c_{i,j}^{n+1} = c_{i,j}^{n} - \\Delta t \\left[\\frac{F^{x}_{i+\\frac{1}{2},j} - F^{x}_{i-\\frac{1}{2},j}}{\\Delta x} + \\frac{F^{y}_{i,j+\\frac{1}{2}} - F^{y}_{i,j-\\frac{1}{2}}}{\\Delta y}\\right],$$ 使用周期性索引。\n\n答案规格：\n- 对于每个测试案例，计算绝对质量误差 $|M(T_{\\text{end}}) - M(0)|$（单位为 $\\mathrm{m^2}$），以及一个布尔值，该布尔值指示相对质量误差 $$\\frac{|M(T_{\\text{end}}) - M(0)|}{M(0)}$$ 是否小于 $10^{-12}$。\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。该列表必须按 A 到 D 的顺序包含每个案例的质量误差（浮点数，单位为 $\\mathrm{m^2}$）和随后的布尔值，总共八个条目，例如：$$[e_A, b_A, e_B, b_B, e_C, b_C, e_D, b_D].$$",
            "solution": "目标是设计并实现一个在二维周期性网格上，用于被动示踪剂被 Gent-McWilliams (GM) 巨砾速度场平流的通量形式有限体积方案。该方案守恒总示踪剂质量的能力必须通过其推导在理论上得到证明，并通过数值模拟在经验上得到验证。\n\n### 1. 控制方程与 GM 参数化\n\n问题从标量守恒的基本原理出发，对于被动示踪剂浓度 $c$ 以通量形式表示为：\n$$\n\\frac{\\partial c}{\\partial t} + \\nabla \\cdot \\boldsymbol{F} = 0\n$$\n其中 $\\boldsymbol{F}$ 是示踪剂通量矢量。对于由速度场 $\\boldsymbol{u}$ 引起的平流，通量为 $\\boldsymbol{F} = \\boldsymbol{u}c$。Gent-McWilliams (GM) 参数化通过一个有效的、无辐散的“巨砾”速度 $\\boldsymbol{u}^{\\star}$ 来描述亚网格尺度中尺度涡的影响。因此，在 GM 涡平流作用下的示踪剂守恒方程为：\n$$\n\\frac{\\partial c}{\\partial t} + \\nabla \\cdot (\\boldsymbol{u}^{\\star} c) = 0\n$$\nGM 参数化的一个关键特性是巨砾速度是无辐散的，即 $\\nabla \\cdot \\boldsymbol{u}^{\\star} = 0$。此特性对于方案能够守恒诸如体积平均浓度等示踪剂属性至关重要。在二维空间中，一个无辐散的矢量场可以从一个标量流函数 $\\psi$（单位为 $\\mathrm{m^2/s}$）导出，作为指向平面外的矢量势（$\\psi \\hat{\\boldsymbol{k}}$）的旋度：\n$$\n\\boldsymbol{u}^{\\star} = \\nabla \\times (\\psi \\hat{\\boldsymbol{k}}) = \\left( \\frac{\\partial \\psi}{\\partial y}, -\\frac{\\partial \\psi}{\\partial x} \\right)\n$$\n其中 $\\boldsymbol{u}^{\\star} = (u^{\\star}, v^{\\star})$。根据这个定义，很明显 $\\nabla \\cdot \\boldsymbol{u}^{\\star} = \\frac{\\partial u^{\\star}}{\\partial x} + \\frac{\\partial v^{\\star}}{\\partial y} = \\frac{\\partial^2 \\psi}{\\partial x \\partial y} - \\frac{\\partial^2 \\psi}{\\partial y \\partial x} = 0$，前提是 $\\psi$ 具有连续的二阶导数。\n\n### 2. 在交错网格上的有限体积离散化\n\n我们将区域离散化为一个由 $N_x \\times N_y$ 个单元组成的均匀笛卡尔网格。单元 $(i,j)$（其中 $i \\in \\{0, \\dots, N_x-1\\}$ 且 $j \\in \\{0, \\dots, N_y-1\\}$）的尺寸为 $\\Delta x \\times \\Delta y$。我们对变量使用交错网格布局（Arakawa C-grid）：\n- 示踪剂浓度 $c_{i,j}$ 定义在单元 $(i,j)$ 的中心。\n- 涡致流函数 $\\psi_{i+\\frac{1}{2}, j+\\frac{1}{2}}$ 定义在单元的角点上。\n- x方向速度分量 $u^{\\star}_{i+\\frac{1}{2},j}$ 定义在单元的垂直面中心。\n- y方向速度分量 $v^{\\star}_{i,j+\\frac{1}{2}}$ 定义在单元的水平面中心。\n\n为了从角点交错的流函数中获得面法向速度，我们应用中心有限差分，具体如下：\n$$\nu^{\\star}_{i+\\frac{1}{2},j} = \\frac{\\psi_{i+\\frac{1}{2},j+\\frac{1}{2}} - \\psi_{i+\\frac{1}{2},j-\\frac{1}{2}}}{\\Delta y}\n$$\n$$\nv^{\\star}_{i,j+\\frac{1}{2}} = -\\frac{\\psi_{i+\\frac{1}{2},j+\\frac{1}{2}} - \\psi_{i-\\frac{1}{2},j+\\frac{1}{2}}}{\\Delta x}\n$$\n这种速度的离散公式保证了场是离散无辐散的。在单元 $(i,j)$ 中心的离散散度是：\n$$\n(\\nabla \\cdot \\boldsymbol{u}^{\\star})_{i,j} = \\frac{u^{\\star}_{i+\\frac{1}{2},j} - u^{\\star}_{i-\\frac{1}{2},j}}{\\Delta x} + \\frac{v^{\\star}_{i,j+\\frac{1}{2}} - v^{\\star}_{i,j-\\frac{1}{2}}}{\\Delta y}\n$$\n代入速度的定义（将索引映射到数组），离散散度在每个单元内精确为零，因为各项会完全抵消。\n\n### 3. 通量形式更新与质量守恒\n\n我们将守恒律在单个网格单元的面积 $A_{i,j} = \\Delta x \\Delta y$ 上积分：\n$$\n\\int_{A_{i,j}} \\frac{\\partial c}{\\partial t} \\,dA + \\int_{A_{i,j}} \\nabla \\cdot (\\boldsymbol{u}^{\\star} c) \\,dA = 0\n$$\n对第二项应用散度定理，将散度的面积分转换为沿单元边界 $\\partial A_{i,j}$ 的通量线积分：\n$$\n\\frac{d c_{i,j}}{dt} \\Delta x \\Delta y + \\oint_{\\partial A_{i,j}} (\\boldsymbol{u}^{\\star} c) \\cdot \\hat{\\boldsymbol{n}} \\,dl = 0\n$$\n通过单元四个面上的通量之和来近似线积分，得到半离散的有限体积公式：\n$$\n\\frac{d c_{i,j}}{dt} = -\\left[\\frac{F^{x}_{i+\\frac{1}{2},j} - F^{x}_{i-\\frac{1}{2},j}}{\\Delta x} + \\frac{F^{y}_{i,j+\\frac{1}{2}} - F^{y}_{i,j-\\frac{1}{2}}}{\\Delta y}\\right]\n$$\n其中 $F^{x}$ 和 $F^{y}$ 是单位长度上的通量。为了数值稳定性，我们使用迎风格式，其中面上的示踪剂浓度 $c$ 取自流的上游单元。例如，对于东侧面，其法向速度为 $u^{\\star}_{i+\\frac{1}{2},j}$：\n$$\nF^{x}_{i+\\frac{1}{2},j} = u^{\\star}_{i+\\frac{1}{2},j} \\times \\begin{cases} c_{i,j}  & \\text{if } u^{\\star}_{i+\\frac{1}{2},j} \\geq 0 \\\\ c_{i+1,j} & \\text{if } u^{\\star}_{i+\\frac{1}{2},j}  0 \\end{cases}\n$$\n对于单元 $(i,j)$，使用向前欧拉时间步长 $\\Delta t$ 的完整更新方程由上式给出。\n\n为了证明质量守恒，我们考虑域内的总示踪剂质量 $M = \\sum_{i,j} c_{i,j} \\Delta x \\Delta y$。总质量的变化率为：\n$$\n\\frac{dM}{dt} = \\sum_{i,j} \\frac{dc_{i,j}}{dt} \\Delta x \\Delta y = - \\sum_{i,j} \\left[ (F^{x}_{i+\\frac{1}{2},j} - F^{x}_{i-\\frac{1}{2},j}) + \\frac{\\Delta x}{\\Delta y}(F^{y}_{i,j+\\frac{1}{2}} - F^{y}_{i,j-\\frac{1}{2}}) \\right]\n$$\n对所有网格单元求和是一个伸缩求和。对于 $x$ 方向的通量，离开单元 $(i,j)$ 的通量 $F^{x}_{i+\\frac{1}{2},j}$ 恰好是进入单元 $(i+1,j)$ 的通量。由于周期性边界条件，整个域的总和为零。$y$ 方向的通量同理。因此：\n$$\n\\frac{dM}{dt} = 0\n$$\n这证明了该离散方案在构造上是完全守恒的。在数值模拟过程中，总质量的任何变化都将仅由浮点表示误差引起。\n\n### 4. 时间步长限制\n\n显式向前欧拉格式受到由 Courant-Friedrichs-Lewy (CFL) 条件给出的稳定性约束。时间步长 $\\Delta t$ 必须足够小，以确保信息在每个步骤中传播不超过一个网格单元。对于二维平流问题，这是：\n$$\n\\Delta t \\le \\frac{1}{\\frac{|u^{\\star}|_{\\max}}{\\Delta x} + \\frac{|v^{\\star}|_{\\max}}{\\Delta y}}\n$$\n我们使用一个安全系数，即 $\\mathrm{CFL}$ 数，使得：\n$$\n\\Delta t = \\frac{\\mathrm{CFL}}{\\frac{u_{\\max}}{\\Delta x} + \\frac{v_{\\max}}{\\Delta y}}\n$$\n其中 $u_{\\max}$ 和 $v_{\\max}$ 是整个网格上面法向速度的最大绝对值。如果所有速度都为零，则选择一个有限的 $\\Delta t$ 以允许模拟进行。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the Gent-McWilliams tracer advection problem for four test cases\n    and demonstrates discrete mass conservation using a C-grid finite volume scheme.\n    \"\"\"\n    \n    # Domain and Grid Parameters\n    Lx, Ly = 1e6, 1e6  # m\n    Nx, Ny = 64, 64\n    dx, dy = Lx / Nx, Ly / Ny\n    \n    # Cell-centered coordinates (for c)\n    x_c = (np.arange(Nx) + 0.5) * dx\n    y_c = (np.arange(Ny) + 0.5) * dy\n    XX_c, YY_c = np.meshgrid(x_c, y_c, indexing='ij')\n\n    # Corner coordinates (for psi)\n    x_v = np.arange(Nx + 1) * dx\n    y_v = np.arange(Ny + 1) * dy\n    XX_v, YY_v = np.meshgrid(x_v, y_v, indexing='ij')\n\n    test_cases = [\n        {\"name\": \"A\", \"psi0\": 1e5, \"psi_func\": lambda x, y, p0: p0 * np.sin(2*np.pi*x/Lx) * np.sin(2*np.pi*y/Ly), \"c_func\": lambda x, y: 1 + 0.5 * np.cos(2*np.pi*x/Lx) * np.cos(2*np.pi*y/Ly), \"CFL\": 0.4, \"N_steps\": 200},\n        {\"name\": \"B\", \"psi0\": 0.0, \"psi_func\": lambda x, y, p0: np.zeros_like(x), \"c_func\": lambda x, y: 1 + 0.5 * np.cos(2*np.pi*x/Lx) * np.cos(2*np.pi*y/Ly), \"CFL\": 0.4, \"N_steps\": 200},\n        {\"name\": \"C\", \"psi0\": 2.5e5, \"psi_func\": lambda x, y, p0: p0 * np.sin(2*np.pi*x/Lx) * np.sin(2*np.pi*y/Ly), \"c_func\": lambda x, y: 1 + 0.5 * np.cos(2*np.pi*x/Lx) * np.cos(2*np.pi*y/Ly), \"CFL\": 0.95, \"N_steps\": 100},\n        {\"name\": \"D\", \"psi0\": 1e5, \"psi_func\": lambda x, y, p0: p0 * (np.sin(2*np.pi*x/Lx)*np.sin(4*np.pi*y/Ly) + 0.5*np.sin(3*np.pi*x/Lx)*np.sin(3*np.pi*y/Ly)), \"c_func\": lambda x, y: 0.5 * (1 + np.sign(np.sin(8*np.pi*x/Lx)*np.sin(8*np.pi*y/Ly))), \"CFL\": 0.6, \"N_steps\": 150},\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        # --- 1. Initialization ---\n        psi = case[\"psi_func\"](XX_v, YY_v, case[\"psi0\"])\n        c = case[\"c_func\"](XX_c, YY_c).T  # Transpose to match (Ny, Nx) convention\n\n        # --- 2. Calculate Bolus Velocities on C-grid faces ---\n        # u_star on vertical faces (j, i+1/2), shape (Ny, Nx+1)\n        u_star = (psi[1:, :] - psi[:-1, :]).T / dy\n        # v_star on horizontal faces (j+1/2, i), shape (Ny+1, Nx)\n        v_star = -(psi[:, 1:] - psi[:, :-1]) / dx\n        \n        # --- 3. Calculate Time Step (dt) ---\n        u_max = np.max(np.abs(u_star))\n        v_max = np.max(np.abs(v_star))\n        \n        cfl_denominator = (u_max / dx) + (v_max / dy)\n        if cfl_denominator == 0:\n            dt = 1.0 \n        else:\n            dt = case[\"CFL\"] / cfl_denominator\n\n        # --- 4. Main Time-Stepping Loop ---\n        cell_area = dx * dy\n        initial_mass = np.sum(c) * cell_area\n\n        for _ in range(case[\"N_steps\"]):\n            # Calculate fluxes on all cell faces\n            # Fx: flux across vertical faces (shape Ny, Nx+1)\n            c_left = np.roll(c, 1, axis=1) # c value to the left of the face\n            Fx = np.where(u_star >= 0, u_star * c_left, u_star * c)\n            \n            # Fy: flux across horizontal faces (shape Ny+1, Nx)\n            c_down = np.roll(c, 1, axis=0) # c value below the face\n            Fy = np.where(v_star >= 0, v_star * c_down, v_star * c)\n\n            # Calculate flux divergence for each cell\n            # For cell (j,i), div = (Fx_{i+1/2} - Fx_{i-1/2})/dx + (Fy_{j+1/2} - Fy_{j-1/2})/dy\n            # In numpy, this corresponds to Fx[:,i+1]-Fx[:,i] and Fy[j+1,:]-Fy[j,:]\n            div_Fx = (Fx[:, 1:] - Fx[:, :-1]) / dx\n            div_Fy = (Fy[1:, :] - Fy[:-1, :]) / dy\n            \n            c -= dt * (div_Fx + div_Fy)\n\n        # --- 5. Calculate Mass Conservation Error ---\n        final_mass = np.sum(c) * cell_area\n        abs_mass_error = abs(final_mass - initial_mass)\n        \n        if initial_mass == 0:\n            rel_mass_error_check = (abs_mass_error == 0)\n        else:\n            rel_mass_error_check = (abs_mass_error / abs(initial_mass))  1e-12\n        \n        results.extend([abs_mass_error, rel_mass_error_check])\n\n    output_str = [f\"{err:.15e}\" if isinstance(err, float) else str(val).lower() for val in results]\n    print(f\"[{','.join(output_str)}]\")\n\nsolve()\n```"
        }
    ]
}