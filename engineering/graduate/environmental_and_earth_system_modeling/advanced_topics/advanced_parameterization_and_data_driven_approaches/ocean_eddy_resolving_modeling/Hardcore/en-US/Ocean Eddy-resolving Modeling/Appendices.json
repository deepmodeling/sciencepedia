{
    "hands_on_practices": [
        {
            "introduction": "Before designing an eddy-resolving model, we must first answer a fundamental question: how large are the eddies we need to resolve? The first baroclinic Rossby radius of deformation, $R_1$, provides the characteristic horizontal length scale for mesoscale eddies. This exercise will guide you through the derivation and calculation of $R_1$, demonstrating how this crucial parameter, which dictates the necessary model grid resolution, depends on key physical properties like stratification and latitude .",
            "id": "3900933",
            "problem": "Consider a midlatitude, two-layer ocean that is to be simulated with an eddy-resolving model. The upper layer has depth $h_1$ and the lower layer has depth $h_2$. The density contrast across the interface is small, so the Boussinesq and hydrostatic approximations apply, and the stratification can be represented by a reduced gravity $g'$ acting on the internal interface displacement. The model domain is on a rotating Earth, approximated locally as an $f$-plane with constant Coriolis parameter $f$ at latitude $\\phi$, where $f = 2 \\Omega \\sin(\\phi)$ and $\\Omega$ is Earth’s angular velocity. Assume horizontally unbounded, inviscid, layer-averaged dynamics, and small-amplitude motions so that linearization is valid.\n\nStarting from the layer-averaged, linearized shallow-water equations for two layers and fundamental balances, derive the first baroclinic internal gravity wave phase speed $c$ for the two-layer system, and then obtain the first baroclinic Rossby radius of deformation $R_1$ as the horizontal scale at which rotational effects and internal gravity wave restoring forces are of comparable importance. Use this to compute $R_1$ for the following physically plausible parameters:\n- $h_1 = 200\\,\\mathrm{m}$,\n- $h_2 = 3800\\,\\mathrm{m}$,\n- $g' = 0.02\\,\\mathrm{m}\\,\\mathrm{s}^{-2}$,\n- $\\phi = 45^\\circ$ (angles are given in degrees),\n- $\\Omega = 7.2921 \\times 10^{-5}\\,\\mathrm{s}^{-1}$.\n\nExpress your final $R_1$ in $\\mathrm{km}$ and round your answer to three significant figures. In addition, in your reasoning, interpret the sensitivity of $R_1$ to changes in $g'$ and latitude $\\phi$ based on first principles, but provide only the requested numerical value for $R_1$ as your final answer.",
            "solution": "The problem is valid as it is scientifically grounded in the well-established principles of geophysical fluid dynamics, is well-posed with a complete and consistent set of parameters, and is expressed in objective, formal language. We proceed with the solution.\n\nThe problem requires the derivation of the first baroclinic Rossby radius of deformation, $R_1$, for a two-layer ocean. This quantity is defined as the ratio of the first baroclinic internal gravity wave phase speed, $c_1$, to the Coriolis parameter, $f$.\n\nFirst, we must derive the phase speed $c_1$. We start from the linearized shallow-water equations for two immiscible, homogeneous fluid layers on a rotating $f$-plane. Let the subscripts $1$ and $2$ denote the upper and lower layers, respectively. Let $\\boldsymbol{u}_1 = (u_1, v_1)$ and $\\boldsymbol{u}_2 = (u_2, v_2)$ be the layer-averaged horizontal velocity vectors, $h_1$ and $h_2$ be the quiescent layer depths, and $\\eta_1$ and $\\eta_2$ be the small-amplitude displacements of the sea surface and the internal interface from their equilibrium positions. The governing momentum and continuity equations are:\n\nLayer 1 Momentum:\n$$ \\frac{\\partial \\boldsymbol{u}_1}{\\partial t} + f \\hat{\\boldsymbol{k}} \\times \\boldsymbol{u}_1 = -g \\nabla \\eta_1 $$\nLayer 2 Momentum:\n$$ \\frac{\\partial \\boldsymbol{u}_2}{\\partial t} + f \\hat{\\boldsymbol{k}} \\times \\boldsymbol{u}_2 = -g \\nabla \\eta_1 - g' \\nabla \\eta_2 $$\nLayer 1 Continuity:\n$$ \\frac{\\partial (\\eta_1 - \\eta_2)}{\\partial t} + h_1 \\nabla \\cdot \\boldsymbol{u}_1 = 0 $$\nLayer 2 Continuity:\n$$ \\frac{\\partial \\eta_2}{\\partial t} + h_2 \\nabla \\cdot \\boldsymbol{u}_2 = 0 $$\nHere, $f$ is the Coriolis parameter, $\\hat{\\boldsymbol{k}}$ is the vertical unit vector, $g$ is the acceleration due to gravity, $g'$ is the reduced gravity, and $\\nabla$ is the horizontal gradient operator.\n\nTo find the phase speed of internal gravity waves, we neglect rotation ($f=0$) and seek plane wave solutions of the form $A(\\mathbf{x}, t) = \\hat{A} \\exp[i(k x - \\omega t)]$, where for simplicity we consider propagation only in the $x$-direction. The spatial and temporal derivatives become $\\nabla \\rightarrow ik$ and $\\frac{\\partial}{\\partial t} \\rightarrow -i\\omega$. The equations simplify to an algebraic system for the amplitudes $(\\hat{u}_1, \\hat{u}_2, \\hat{\\eta}_1, \\hat{\\eta}_2)$:\n\nMomentum:\n$$ -i\\omega \\hat{u}_1 = -gik \\hat{\\eta}_1 \\implies \\hat{u}_1 = \\frac{gk}{\\omega} \\hat{\\eta}_1 $$\n$$ -i\\omega \\hat{u}_2 = -gik \\hat{\\eta}_1 - g'ik \\hat{\\eta}_2 \\implies \\hat{u}_2 = \\frac{k}{\\omega}(g\\hat{\\eta}_1 + g'\\hat{\\eta}_2) $$\nContinuity:\n$$ -i\\omega(\\hat{\\eta}_1 - \\hat{\\eta}_2) + h_1 ik \\hat{u}_1 = 0 \\implies \\omega(\\hat{\\eta}_1 - \\hat{\\eta}_2) = h_1 k \\hat{u}_1 $$\n$$ -i\\omega \\hat{\\eta}_2 + h_2 ik \\hat{u}_2 = 0 \\implies \\omega \\hat{\\eta}_2 = h_2 k \\hat{u}_2 $$\n\nSubstituting the expressions for $\\hat{u}_1$ and $\\hat{u}_2$ into the continuity equations yields:\n$$ \\omega(\\hat{\\eta}_1 - \\hat{\\eta}_2) = h_1 k \\left(\\frac{gk}{\\omega}\\hat{\\eta}_1\\right) \\implies \\omega^2(\\hat{\\eta}_1 - \\hat{\\eta}_2) = gh_1 k^2 \\hat{\\eta}_1 $$\n$$ \\omega \\hat{\\eta}_2 = h_2 k \\left(\\frac{k}{\\omega}(g\\hat{\\eta}_1 + g'\\hat{\\eta}_2)\\right) \\implies \\omega^2 \\hat{\\eta}_2 = k^2 h_2 (g\\hat{\\eta}_1 + g'\\hat{\\eta}_2) $$\n\nDefining the phase speed $c = \\omega/k$, we can rewrite this as a linear system for $\\hat{\\eta}_1$ and $\\hat{\\eta}_2$:\n$$ (c^2 - gh_1)\\hat{\\eta}_1 - c^2\\hat{\\eta}_2 = 0 $$\n$$ -gh_2\\hat{\\eta}_1 + (c^2 - g'h_2)\\hat{\\eta}_2 = 0 $$\n\nFor non-trivial solutions to exist, the determinant of the coefficient matrix must be zero:\n$$ \\det \\begin{pmatrix} c^2 - gh_1  -c^2 \\\\ -gh_2  c^2 - g'h_2 \\end{pmatrix} = 0 $$\n$$ (c^2 - gh_1)(c^2 - g'h_2) - c^2gh_2 = 0 $$\n$$ c^4 - c^2(g'h_2) - c^2(gh_1) + gg'h_1h_2 - c^2gh_2 = 0 $$\n$$ c^4 - c^2(g(h_1+h_2) + g'h_2) + gg'h_1h_2 = 0 $$\n\nThis is a quadratic equation for $c^2$. The two roots correspond to the external (barotropic) and internal (baroclinic) modes. The barotropic mode has a phase speed $c_0 \\approx \\sqrt{g(h_1+h_2)}$. The baroclinic mode phase speed is much smaller. Given that $g' \\ll g$ and $h_1 \\ll h_2$ in many oceanic settings, we can approximate the smaller root. Let $H = h_1 + h_2$. The sum of the roots is $c_0^2 + c_1^2 = gH + g'h_2$ and the product is $c_0^2 c_1^2 = gg'h_1h_2$.\nUsing the approximation $c_0^2 \\approx gH$, we find the first baroclinic wave speed squared, $c_1^2$:\n$$ c_1^2 = \\frac{gg'h_1h_2}{c_0^2} \\approx \\frac{gg'h_1h_2}{gH} = g' \\frac{h_1h_2}{h_1+h_2} $$\nThe first baroclinic internal gravity wave phase speed is thus:\n$$ c_1 = \\sqrt{g' \\frac{h_1 h_2}{h_1 + h_2}} $$\n\nThe Rossby radius of deformation, $R$, is the length scale at which the Coriolis force becomes comparable to the pressure gradient (or buoyancy restoring) force. It is defined as $R = c/|f|$, where $c$ is the relevant wave speed and $f$ is the Coriolis parameter. For the first baroclinic mode, this gives the first baroclinic Rossby radius, $R_1$:\n$$ R_1 = \\frac{c_1}{|f|} = \\frac{1}{|f|} \\sqrt{g' \\frac{h_1 h_2}{h_1 + h_2}} $$\nThe Coriolis parameter is $f = 2\\Omega\\sin(\\phi)$, where $\\Omega$ is Earth's angular velocity and $\\phi$ is the latitude. Since $\\phi=45^\\circ$, $f$ is positive.\n$$ R_1 = \\frac{1}{2\\Omega\\sin(\\phi)} \\sqrt{g' \\frac{h_1 h_2}{h_1 + h_2}} $$\n\nFrom this expression, we can interpret the sensitivity of $R_1$.\n1.  Sensitivity to $g'$: $R_1 \\propto \\sqrt{g'}$. Stronger stratification (larger $g'$) provides a stronger restoring force for the interface, leading to faster internal gravity waves (larger $c_1$) and thus a larger radius of deformation.\n2.  Sensitivity to $\\phi$: $R_1 \\propto 1/|\\sin(\\phi)|$ (away from the equator). The Coriolis effect strengthens with increasing latitude. A stronger rotational influence `traps` geostrophic adjustments to a smaller horizontal scale, resulting in a smaller Rossby radius at higher latitudes.\n\nNow, we compute the numerical value of $R_1$ using the provided parameters:\n$h_1 = 200\\,\\mathrm{m}$\n$h_2 = 3800\\,\\mathrm{m}$\n$g' = 0.02\\,\\mathrm{m}\\,\\mathrm{s}^{-2}$\n$\\phi = 45^\\circ$\n$\\Omega = 7.2921 \\times 10^{-5}\\,\\mathrm{s}^{-1}$\n\nFirst, calculate the Coriolis parameter $f$:\n$$ f = 2 \\Omega \\sin(\\phi) = 2 \\times (7.2921 \\times 10^{-5}\\,\\mathrm{s}^{-1}) \\times \\sin(45^\\circ) = (1.45842 \\times 10^{-4}\\,\\mathrm{s}^{-1}) \\times \\frac{\\sqrt{2}}{2} \\approx 1.03126 \\times 10^{-4}\\,\\mathrm{s}^{-1} $$\nNext, calculate the term combining the layer depths, which is often called the equivalent depth $H_{eq}$:\n$$ \\frac{h_1 h_2}{h_1 + h_2} = \\frac{(200\\,\\mathrm{m}) \\times (3800\\,\\mathrm{m})}{200\\,\\mathrm{m} + 3800\\,\\mathrm{m}} = \\frac{760000\\,\\mathrm{m}^2}{4000\\,\\mathrm{m}} = 190\\,\\mathrm{m} $$\nNow, calculate the first baroclinic wave speed $c_1$:\n$$ c_1 = \\sqrt{g' \\frac{h_1 h_2}{h_1 + h_2}} = \\sqrt{(0.02\\,\\mathrm{m}\\,\\mathrm{s}^{-2}) \\times (190\\,\\mathrm{m})} = \\sqrt{3.8}\\,\\mathrm{m}\\,\\mathrm{s}^{-1} \\approx 1.94936\\,\\mathrm{m}\\,\\mathrm{s}^{-1} $$\nFinally, compute the first baroclinic Rossby radius $R_1$:\n$$ R_1 = \\frac{c_1}{f} = \\frac{1.94936\\,\\mathrm{m}\\,\\mathrm{s}^{-1}}{1.03126 \\times 10^{-4}\\,\\mathrm{s}^{-1}} \\approx 18902.5\\,\\mathrm{m} $$\nThe problem asks for the answer in kilometers, rounded to three significant figures.\n$$ R_1 \\approx 18.9025\\,\\mathrm{km} $$\nRounding to three significant figures gives $18.9\\,\\mathrm{km}$.\nThis length scale, approximately $19\\,\\mathrm{km}$, is the characteristic horizontal scale of mesoscale eddies in the mid-latitude ocean. An eddy-resolving model must have a grid resolution significantly finer than this scale to properly simulate the dynamics of these features.",
            "answer": "$$\n\\boxed{18.9}\n$$"
        },
        {
            "introduction": "Once a model's spatial resolution, $\\Delta x$, is chosen to be fine enough to capture eddies, the next practical challenge is selecting a stable time step, $\\Delta t$. The Courant-Friedrichs-Lewy (CFL) condition provides the fundamental constraint for explicit numerical schemes, ensuring that information does not propagate faster than the model can compute it. This practice challenges you to apply the CFL condition to a system with multiple wave types, a critical skill for configuring any time-stepping numerical model .",
            "id": "3900926",
            "problem": "Consider a one-dimensional zonal strip of an eddy-resolving ocean model integrated with an explicit, conservative, first-order upwind scheme for the hyperbolic subsystem governing fast dynamics. The prognostic state includes a barotropic (external) gravity-wave mode and a first baroclinic (internal) gravity-wave mode, both linearized about a uniform background state. Assume a uniform mean zonal flow of magnitude $U$ advects all signals, and neglect rotation at the fast time scales relevant to the gravity waves. The computational grid has uniform spacing $\\Delta x$. Let the barotropic phase speed relative to a resting ocean be $c_b$ and the internal mode phase speed be $c_i$. The Courant–Friedrichs–Lewy (CFL) condition (Courant–Friedrichs–Lewy, CFL) for the explicit upwind scheme requires that no characteristic of the hyperbolic system traverse more than one grid cell per time step.\n\nStarting from the linearized conservation of mass and momentum for shallow-water dynamics and for the internal mode treated as a linear long-wave, derive the characteristic speeds in the presence of mean advection and obtain the stability constraint on the maximum allowable time step $\\Delta t_{\\max}$ in terms of $\\Delta x$, $U$, $c_b$, and $c_i$. Using the provided numerical values\n$U = 0.80\\,\\mathrm{m\\,s^{-1}}$, $\\Delta x = 4.2 \\times 10^{3}\\,\\mathrm{m}$, $c_b = 2.20 \\times 10^{2}\\,\\mathrm{m\\,s^{-1}}$, and $c_i = 2.40\\,\\mathrm{m\\,s^{-1}}$, compute the maximum allowable time step and then propose a safe operational time step defined as $\\Delta t_{\\text{safe}} = S \\,\\Delta t_{\\max}$ with a safety factor $S = 0.80$ to account for nonlinearities and model overhead. Express your final answer as the safe operational time step in seconds, and round your answer to four significant figures.",
            "solution": "The problem requires the determination of a safe operational time step for a numerical ocean model based on the Courant–Friedrichs–Lewy (CFL) stability condition. The model includes both barotropic and baroclinic gravity wave dynamics advected by a mean flow. The validation of the problem statement finds it to be scientifically grounded, well-posed, objective, and internally consistent, containing all necessary data for a unique solution. The provided physical parameters are realistic for an oceanographic context.\n\nThe first step is to determine the characteristic speeds of the system. The problem describes linearized dynamics for fast gravity waves, which can be modeled by the shallow-water equations. For a one-dimensional system with a uniform background zonal flow of magnitude $U$, the linearized conservation of mass and momentum equations are:\n$$\n\\frac{\\partial \\eta'}{\\partial t} + U \\frac{\\partial \\eta'}{\\partial x} + H \\frac{\\partial u'}{\\partial x} = 0\n$$\n$$\n\\frac{\\partial u'}{\\partial t} + U \\frac{\\partial u'}{\\partial x} + g \\frac{\\partial \\eta'}{\\partial x} = 0\n$$\nHere, $u'(x,t)$ is the velocity perturbation, $\\eta'(x,t)$ is the sea-surface height perturbation, $g$ is the acceleration due to gravity, and $H$ is the mean fluid depth. This system can be written in vector form $\\frac{\\partial \\mathbf{q}}{\\partial t} + \\mathbf{A} \\frac{\\partial \\mathbf{q}}{\\partial x} = \\mathbf{0}$, where $\\mathbf{q} = [\\eta', u']^T$ and the matrix $\\mathbf{A}$ is:\n$$\n\\mathbf{A} = \\begin{pmatrix} U  H \\\\ g  U \\end{pmatrix}\n$$\nThe characteristic speeds, $\\lambda$, of this hyperbolic system are the eigenvalues of the matrix $\\mathbf{A}$. They are found by solving the characteristic equation $\\det(\\mathbf{A} - \\lambda\\mathbf{I}) = 0$.\n$$\n\\det \\begin{pmatrix} U - \\lambda  H \\\\ g  U - \\lambda \\end{pmatrix} = (U - \\lambda)^2 - gH = 0\n$$\nThis gives $(U - \\lambda) = \\pm\\sqrt{gH}$. The term $c = \\sqrt{gH}$ is the phase speed of the gravity wave in a resting fluid ($U=0$). Therefore, the characteristic speeds are:\n$$\n\\lambda = U \\pm c\n$$\nThis result shows that in the presence of a mean flow $U$, the waves are advected, and their speeds in the fixed reference frame of the computational grid are the sum or difference of the mean flow and the intrinsic wave phase speed.\n\nThe problem specifies two types of waves, each treated as a linear long-wave mode:\n$1$. A barotropic mode with intrinsic phase speed $c_b$.\n$2$. A first baroclinic mode with intrinsic phase speed $c_i$.\n\nIn this linearized system, the modes are decoupled. The set of all characteristic speeds in the model is the union of the speeds for each mode:\n- For the barotropic mode: $\\lambda_{b, \\pm} = U \\pm c_b$\n- For the baroclinic mode: $\\lambda_{i, \\pm} = U \\pm c_i$\nThe complete set of characteristic speeds is $\\{U+c_b, U-c_b, U+c_i, U-c_i\\}$.\n\nThe Courant–Friedrichs–Lewy (CFL) condition for a one-dimensional explicit scheme states that the numerical domain of dependence must contain the physical domain of dependence. For a first-order upwind scheme on a grid with uniform spacing $\\Delta x$, this condition is:\n$$\n|\\lambda_{\\max}| \\frac{\\Delta t}{\\Delta x} \\le 1\n$$\nwhere $|\\lambda_{\\max}|$ is the magnitude of the fastest characteristic speed in the system, and $\\Delta t$ is the time step. The stability of the scheme is limited by the fastest possible signal propagation. The maximum allowable time step, $\\Delta t_{\\max}$, is thus:\n$$\n\\Delta t_{\\max} = \\frac{\\Delta x}{|\\lambda_{\\max}|}\n$$\nTo find $|\\lambda_{\\max}|$, we must determine the maximum absolute value among all characteristic speeds:\n$$\n|\\lambda_{\\max}| = \\max\\left(|U + c_b|, |U - c_b|, |U + c_i|, |U - c_i|\\right)\n$$\nGiven that wave phase speeds are positive definite, $c_b  0$ and $c_i  0$. The maximum absolute value of a sum/difference of the form $|U \\pm c|$ is $|U| + c$. Since the given value for the barotropic phase speed $c_b$ is much larger than the baroclinic phase speed $c_i$ ($c_b = 2.20 \\times 10^2\\,\\mathrm{m\\,s^{-1}}$ versus $c_i = 2.40\\,\\mathrm{m\\,s^{-1}}$), the fastest signal will be associated with the barotropic mode.\n$$\n|\\lambda_{\\max}| = \\max(|U| + c_b, |U| + c_i) = |U| + c_b\n$$\nSubstituting this into the expression for $\\Delta t_{\\max}$:\n$$\n\\Delta t_{\\max} = \\frac{\\Delta x}{|U| + c_b}\n$$\nWe now substitute the provided numerical values:\n$U = 0.80\\,\\mathrm{m\\,s^{-1}}$\n$\\Delta x = 4.2 \\times 10^{3}\\,\\mathrm{m}$\n$c_b = 2.20 \\times 10^{2}\\,\\mathrm{m\\,s^{-1}} = 220\\,\\mathrm{m\\,s^{-1}}$\n$c_i = 2.40\\,\\mathrm{m\\,s^{-1}}$\n\nThe magnitude of the fastest characteristic speed is:\n$$\n|\\lambda_{\\max}| = |0.80\\,\\mathrm{m\\,s^{-1}}| + 220\\,\\mathrm{m\\,s^{-1}} = 0.80\\,\\mathrm{m\\,s^{-1}} + 220\\,\\mathrm{m\\,s^{-1}} = 220.8\\,\\mathrm{m\\,s^{-1}}\n$$\nThe maximum allowable time step is:\n$$\n\\Delta t_{\\max} = \\frac{4.2 \\times 10^{3}\\,\\mathrm{m}}{220.8\\,\\mathrm{m\\,s^{-1}}} \\approx 19.02173913\\,\\mathrm{s}\n$$\nThe problem asks for a safe operational time step, $\\Delta t_{\\text{safe}}$, defined with a safety factor $S = 0.80$:\n$$\n\\Delta t_{\\text{safe}} = S \\cdot \\Delta t_{\\max}\n$$\n$$\n\\Delta t_{\\text{safe}} = 0.80 \\times \\frac{4.2 \\times 10^{3}}{220.8}\\,\\mathrm{s} \\approx 0.80 \\times 19.02173913\\,\\mathrm{s} \\approx 15.2173913\\,\\mathrm{s}\n$$\nThe final step is to round this result to four significant figures.\n$$\n\\Delta t_{\\text{safe}} \\approx 15.22\\,\\mathrm{s}\n$$\nThis is the proposed safe operational time step that ensures numerical stability for the fastest waves in the system while providing a margin for nonlinear effects not captured in this linearized analysis.",
            "answer": "$$\n\\boxed{15.22}\n$$"
        },
        {
            "introduction": "A primary goal of ocean modeling is to simulate the velocity field, but direct measurement of large-scale currents is difficult. Instead, we often infer circulation from more easily measured tracer fields like temperature and salinity, which determine density. This practice puts a cornerstone of dynamical oceanography, the thermal wind balance, into action by guiding you through the implementation of a numerical algorithm to compute geostrophic currents from a given density field, a common task in the analysis of both model output and observational data .",
            "id": "3900895",
            "problem": "You are given a gridded density field $\\,\\rho(x,y,z)\\,$ on a rectilinear grid with coordinates $\\,x\\,$, $\\,y\\,$, and $\\,z\\,$, a constant reference density $\\,\\rho_0\\,$, gravitational acceleration $\\,g\\,$, and a constant Coriolis parameter $\\,f\\,$. Starting from the geostrophic balance and hydrostatic balance under the Boussinesq approximation, derive the vertical shear of the geostrophic velocity $\\,\\boldsymbol{u}_g(x,y,z)\\,$ as a function of horizontal density gradients. Then, implement a numerical algorithm that:\n- computes horizontal density gradients $\\,\\partial \\rho/\\partial x\\,$ and $\\,\\partial \\rho/\\partial y\\,$ on the given grid using second-order accurate finite differences,\n- assembles the vertical shear components $\\,\\partial u_g/\\partial z\\,$ and $\\,\\partial v_g/\\partial z\\,$,\n- integrates the shear vertically using a trapezoidal rule to obtain $\\,u_g(x,y,z)\\,$ and $\\,v_g(x,y,z)\\,$ subject to a reference level of no motion at the deepest level $\\,z_{\\mathrm{ref}} = \\min(z)\\,$, i.e., $\\,u_g(x,y,z_{\\mathrm{ref}})=0\\,$ and $\\,v_g(x,y,z_{\\mathrm{ref}})=0\\,$.\n\nYour program must compute the speed magnitude $\\,\\|\\boldsymbol{u}_g\\| = \\sqrt{u_g^2 + v_g^2}\\,$ at the central horizontal grid point and a specified target depth $\\,z_{\\mathrm{target}}\\,$ for each test case defined below. Express all final results in meters per second (m/s), rounded to six decimal places.\n\nUse the following fundamental base:\n- Geostrophic balance: $$f\\,\\hat{\\boldsymbol{k}}\\times \\boldsymbol{u}_g = -\\frac{1}{\\rho_0}\\,\\nabla_h p,$$\n- Hydrostatic balance: $$\\frac{\\partial p}{\\partial z} = -\\,g\\,\\rho,$$\nwhere $\\,\\hat{\\boldsymbol{k}}\\,$ is the upward unit vector and $\\,\\nabla_h\\,$ is the horizontal gradient operator in $\\,x\\,$ and $\\,y\\,$.\n\nGrid, constants, and test suite:\n- For every test case, use a uniform grid with $\\,N_x = 11\\,$, $\\,N_y = 11\\,$, $\\,N_z = 41\\,$, $\\,x \\in [0,\\,150000]\\,\\mathrm{m}\\,$, $\\,y \\in [0,\\,150000]\\,\\mathrm{m}\\,$, and $\\,z \\in [-4000,\\,0]\\,\\mathrm{m}\\,$. The grid spacings are $\\,\\Delta x = 15000\\,\\mathrm{m}\\,$, $\\,\\Delta y = 15000\\,\\mathrm{m}\\,$, and uniform $\\,\\Delta z\\,$ implied by $\\,N_z\\,$.\n- Use $\\,\\rho_0 = 1027\\,\\mathrm{kg\\,m^{-3}}\\,$ and $\\,g = 9.81\\,\\mathrm{m\\,s^{-2}}\\,$ for all test cases.\n- The central horizontal grid point is defined by indices $\\,i = \\lfloor N_x/2 \\rfloor\\,$ and $\\,j = \\lfloor N_y/2 \\rfloor\\,$. The target depth index is the grid level $\\,k\\,$ whose $\\,z_k\\,$ is closest to $\\,z_{\\mathrm{target}}\\,$.\n\nDefine four scientifically plausible test cases:\n1. Happy path (meridional gradient, Northern Hemisphere):\n   - $\\,f = 1.1\\times 10^{-4}\\,\\mathrm{s^{-1}}\\,$,\n   - Density field $\\,\\rho(x,y,z) = \\rho_0 + \\alpha\\,y\\,$ with $\\,\\alpha = 1.0\\times 10^{-7}\\,\\mathrm{kg\\,m^{-4}}\\,$,\n   - $\\,z_{\\mathrm{target}} = -1000\\,\\mathrm{m}\\,$.\n2. Hemisphere sign change (zonal gradient, Southern Hemisphere):\n   - $\\,f = -8.0\\times 10^{-5}\\,\\mathrm{s^{-1}}\\,$,\n   - Density field $\\,\\rho(x,y,z) = \\rho_0 + \\beta\\,x\\,$ with $\\,\\beta = 1.0\\times 10^{-7}\\,\\mathrm{kg\\,m^{-4}}\\,$,\n   - $\\,z_{\\mathrm{target}} = -2000\\,\\mathrm{m}\\,$.\n3. Depth-dependent gradient (thermal wind varying with depth):\n   - $\\,f = 1.0\\times 10^{-4}\\,\\mathrm{s^{-1}}\\,$,\n   - Density field $\\,\\rho(x,y,z) = \\rho_0 + \\alpha_0\\,y\\left(1 + \\frac{z}{H}\\right)\\,$ with $\\,\\alpha_0 = 2.0\\times 10^{-7}\\,\\mathrm{kg\\,m^{-4}}\\,$ and $\\,H = 4000\\,\\mathrm{m}\\,$,\n   - $\\,z_{\\mathrm{target}} = -1000\\,\\mathrm{m}\\,$.\n4. Edge case (no horizontal gradient):\n   - $\\,f = 1.0\\times 10^{-4}\\,\\mathrm{s^{-1}}\\,$,\n   - Density field $\\,\\rho(x,y,z) = \\rho_0 + \\Delta \\rho \\,\\frac{z - z_{\\mathrm{ref}}}{4000}\\,$ with $\\,\\Delta \\rho = 2.0\\,\\mathrm{kg\\,m^{-3}}\\,$ and $\\,z_{\\mathrm{ref}} = -4000\\,\\mathrm{m}\\,$,\n   - $\\,z_{\\mathrm{target}} = -2500\\,\\mathrm{m}\\,$.\n\nImplementation requirements:\n- Use second-order accurate finite differences for $\\,\\partial \\rho/\\partial x\\,$ and $\\,\\partial \\rho/\\partial y\\,$ with one-sided differences at boundaries.\n- Use the trapezoidal rule in $\\,z\\,$ to integrate $\\,\\partial u_g/\\partial z\\,$ and $\\,\\partial v_g/\\partial z\\,$ from $\\,z_{\\mathrm{ref}}\\,$ upward, enforcing the reference level of no motion.\n- Compute the speed magnitude at the central horizontal grid point and at $\\,z_{\\mathrm{target}}\\,$ for each case.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with each entry a float in m/s rounded to six decimal places (e.g., $\\,\\left[0.012345,0.067890,0.000001,0.100000\\right]\\,$).",
            "solution": "The problem statement is scientifically sound, well-posed, and provides all necessary information to derive and implement a numerical solution for calculating geostrophic ocean currents from a given density field. The problem is therefore deemed valid.\n\nThe solution involves two parts: first, the derivation of the governing equations for the vertical shear of the geostrophic velocity, known as the thermal wind equations; second, the development of a numerical algorithm to solve these equations on a discrete grid.\n\n**1. Theoretical Derivation: The Thermal Wind Equations**\n\nThe derivation begins with the provided fundamental equations for geostrophic and hydrostatic balance under the Boussinesq approximation.\n\nThe geostrophic balance is given by:\n$$f\\,\\hat{\\boldsymbol{k}}\\times \\boldsymbol{u}_g = -\\frac{1}{\\rho_0}\\,\\nabla_h p$$\nwhere $\\boldsymbol{u}_g = (u_g, v_g, 0)$ is the geostrophic velocity vector with horizontal components $u_g$ (zonal) and $v_g$ (meridional), $p$ is the pressure, $\\rho_0$ is a constant reference density, $f$ is the Coriolis parameter, and $\\hat{\\boldsymbol{k}}$ is the upward unit vector. $\\nabla_h = \\boldsymbol{i} \\frac{\\partial}{\\partial x} + \\boldsymbol{j} \\frac{\\partial}{\\partial y}$ is the horizontal gradient operator.\n\nExpanding the cross product $\\hat{\\boldsymbol{k}} \\times \\boldsymbol{u}_g = \\hat{\\boldsymbol{k}} \\times (u_g\\boldsymbol{i} + v_g\\boldsymbol{j}) = u_g(\\hat{\\boldsymbol{k}}\\times\\boldsymbol{i}) + v_g(\\hat{\\boldsymbol{k}}\\times\\boldsymbol{j}) = u_g\\boldsymbol{j} - v_g\\boldsymbol{i}$.\nSubstituting this into the geostrophic balance equation and equating components yields the scalar equations for geostrophic velocity:\n$$f u_g = -\\frac{1}{\\rho_0} \\frac{\\partial p}{\\partial y}$$\n$$-f v_g = -\\frac{1}{\\rho_0} \\frac{\\partial p}{\\partial x} \\implies v_g = \\frac{1}{f \\rho_0} \\frac{\\partial p}{\\partial x}$$\n\nThe hydrostatic balance is given by:\n$$\\frac{\\partial p}{\\partial z} = -g\\rho$$\nwhere $g$ is the gravitational acceleration and $\\rho(x,y,z)$ is the water density.\n\nTo find the vertical shear of the geostrophic velocity, we differentiate the geostrophic velocity components with respect to the vertical coordinate $z$:\n$$\\frac{\\partial u_g}{\\partial z} = \\frac{\\partial}{\\partial z} \\left( -\\frac{1}{f \\rho_0} \\frac{\\partial p}{\\partial y} \\right) = -\\frac{1}{f \\rho_0} \\frac{\\partial}{\\partial y} \\left( \\frac{\\partial p}{\\partial z} \\right)$$\n$$\\frac{\\partial v_g}{\\partial z} = \\frac{\\partial}{\\partial z} \\left( \\frac{1}{f \\rho_0} \\frac{\\partial p}{\\partial x} \\right) = \\frac{1}{f \\rho_0} \\frac{\\partial}{\\partial x} \\left( \\frac{\\partial p}{\\partial z} \\right)$$\nIn these steps, we assume that the pressure field is sufficiently smooth, allowing the order of partial differentiation to be exchanged (Clairaut's theorem).\n\nNow, we substitute the hydrostatic balance equation for $\\frac{\\partial p}{\\partial z}$:\n$$\\frac{\\partial u_g}{\\partial z} = -\\frac{1}{f \\rho_0} \\frac{\\partial}{\\partial y} (-g\\rho) = \\frac{g}{f \\rho_0} \\frac{\\partial \\rho}{\\partial y}$$\n$$\\frac{\\partial v_g}{\\partial z} = \\frac{1}{f \\rho_0} \\frac{\\partial}{\\partial x} (-g\\rho) = -\\frac{g}{f \\rho_0} \\frac{\\partial \\rho}{\\partial x}$$\n\nThese two final equations are the thermal wind equations. They relate the vertical shear of the geostrophic current to the horizontal gradients of the density field. This relationship is fundamental to oceanography, as it allows for the inference of large-scale ocean circulation from temperature and salinity (and thus density) measurements.\n\n**2. Numerical Algorithm**\n\nThe numerical implementation proceeds as follows, based on a discrete representation of the fluid domain on a rectilinear grid.\n\n**Grid Discretization:** The domain is discretized into a 3D grid with coordinates $(x_i, y_j, z_k)$ for indices $i \\in [0, N_x-1]$, $j \\in [0, N_y-1]$, and $k \\in [0, N_z-1]$. The vertical coordinate $z_k$ is ordered from the deepest level ($z_0 = z_{\\mathrm{ref}}$) to the sea surface. The density field $\\rho(x,y,z)$ is represented as a 3D array $\\rho_{ijk} = \\rho(x_i, y_j, z_k)$.\n\n**Gradient Computation:** The horizontal density gradients, $\\frac{\\partial \\rho}{\\partial x}$ and $\\frac{\\partial \\rho}{\\partial y}$, are computed at each grid point. As required, this is done using second-order accurate finite differences. For interior points, a central difference scheme is used, while at the boundaries, second-order accurate one-sided (forward or backward) difference schemes are employed. This can be readily implemented using standard numerical libraries, such as `numpy.gradient`.\n\n**Vertical Shear Calculation:** With the density gradients computed, the vertical shear components $(\\frac{\\partial u_g}{\\partial z})_{ijk}$ and $(\\frac{\\partial v_g}{\\partial z})_{ijk}$ are calculated at every grid point by applying the discrete form of the thermal wind equations:\n$$\\left(\\frac{\\partial u_g}{\\partial z}\\right)_{ijk} = \\frac{g}{f \\rho_0} \\left(\\frac{\\partial \\rho}{\\partial y}\\right)_{ijk}$$\n$$\\left(\\frac{\\partial v_g}{\\partial z}\\right)_{ijk} = -\\frac{g}{f \\rho_0} \\left(\\frac{\\partial \\rho}{\\partial x}\\right)_{ijk}$$\n\n**Vertical Integration:** The geostrophic velocity components $u_g$ and $v_g$ are obtained by integrating their respective vertical shears from the reference level of no motion, $z_{\\mathrm{ref}} = z_0$, upwards. The velocity at any level $z_k$ is given by:\n$$u_g(z_k) = u_g(z_0) + \\int_{z_0}^{z_k} \\frac{\\partial u_g}{\\partial z} dz'$$\nGiven the boundary condition $u_g(z_0) = 0$, this simplifies to a cumulative integral. The integration is performed numerically using the trapezoidal rule. For each horizontal location $(i,j)$, the velocity at level $k$ is approximated by summing the contributions from all layers below it:\n$$u_{g, ijk} \\approx \\sum_{l=0}^{k-1} \\frac{1}{2} \\left[ \\left(\\frac{\\partial u_g}{\\partial z}\\right)_{ij,l+1} + \\left(\\frac{\\partial u_g}{\\partial z}\\right)_{ij,l} \\right] (z_{l+1} - z_l)$$\nThis cumulative integration is performed efficiently for the entire 3D field using a function like `scipy.integrate.cumulative_trapezoid`. The same procedure is applied to compute $v_g$.\n\n**Result Extraction:** After computing the full 3D velocity fields $u_g(x,y,z)$ and $v_g(x,y,z)$, the specific values at the target location are extracted. This involves finding the grid indices for the central horizontal point $(i_{mid}, j_{mid}) = (\\lfloor N_x/2 \\rfloor, \\lfloor N_y/2 \\rfloor)$ and the vertical level $k_{target}$ closest to the specified $z_{\\mathrm{target}}$. Finally, the speed magnitude is calculated as $\\|\\boldsymbol{u}_g\\| = \\sqrt{u_{g,target}^2 + v_{g,target}^2}$. This process is repeated for each test case.",
            "answer": "[0.258284,0.306562,0.144415,0.000000]"
        }
    ]
}