{
    "hands_on_practices": [
        {
            "introduction": "我们的实践始于对流的基本单元：一个上升的空气块。这个练习将引导您模拟一个正在上升并与周围较冷、较干的空气混合的理想化对流云羽。您将通过数值积分一个描述云羽虚位温随高度演变的常微分方程，来探索夹卷过程如何影响其浮力。这个练习的核心是计算对流抑制能（$CIN$），这是一个关键参数，它量化了启动深对流所需克服的能量障碍 。通过这个实践，您将对夹卷抑制对流的物理机制有一个具体而定量的理解，这在天气和气候模型中至关重要。",
            "id": "3896701",
            "problem": "考虑一个用于在环境和地球系统建模中近似对流气块上升的一维卷夹羽流模型。令 $z$ 表示高度（单位：米），其中 $z = 0$ 位于地表且 $z \\ge 0$ 指向高处。将环境虚位温廓线定义为高度的线性函数，\n$$\\theta_{v,e}(z) = \\theta_{v,0} + \\gamma_e z,$$\n其中 $\\theta_{v,0}$ 是地表环境虚位温（单位：开尔文），$\\gamma_e$ 是一个恒定的环境梯度（单位：开尔文/米）。一个上升的气块以速率 $\\epsilon$ （单位：1/米）经历分数卷夹，该过程被建模为气块属性与环境的一阶混合。忽略去夹效应对气块属性的影响。在抬升凝结高度（LCL）之上，潜热加热被参数化为一个恒定的源项，该源项以速率 $h_m$ （单位：开尔文/米）增加气块的虚位温。气块的虚位温 $\\theta_{v,p}(z)$ 遵循以下常微分方程演化\n$$\\frac{d\\theta_{v,p}}{dz} = \\epsilon\\left(\\theta_{v,e}(z) - \\theta_{v,p}(z)\\right) + H(z),$$\n其中\n$$H(z) = \\begin{cases}\n0, & 0 \\le z  z_{\\mathrm{LCL}},\\\\\nh_m,  z \\ge z_{\\mathrm{LCL}}.\n\\end{cases}$$\n气块相对于环境的浮力由下式给出\n$$B(z) = g \\frac{\\theta_{v,p}(z) - \\theta_{v,e}(z)}{\\theta_{v,e}(z)},$$\n其中 $g$ 是重力加速度（单位：米/秒^2）。对流抑制（CIN）是将气块从地表抬升到其自由对流高度（LFC）所需的最小单位质量机械功，在自由对流高度，浮力首次变为非负。形式上，定义 $z_{\\mathrm{LFC}}$ 为 $B(z) \\ge 0$ 的最小高度，则 CIN 为\n$$\\mathrm{CIN}(\\epsilon) = - \\int_0^{z_{\\mathrm{LFC}}} \\min\\left(B(z), 0\\right) \\, dz.$$\n如果在固定的域顶 $z_{\\mathrm{top}}$ 以下不存在这样的 $z_{\\mathrm{LFC}}$，则定义\n$$\\mathrm{CIN}(\\epsilon) = - \\int_0^{z_{\\mathrm{top}}} \\min\\left(B(z), 0\\right) \\, dz.$$\n假设所有测试用例均采用以下物理上合理的常数：\n- $g = 9.81$ 米/秒^2，\n- $\\theta_{v,0} = 300$ 开尔文，\n- $\\gamma_e = 0.003$ 开尔文/米，\n- $z_{\\mathrm{LCL}} = 800$ 米，\n- $h_m = 0.005$ 开尔文/米，\n- $z_{\\mathrm{top}} = 3000$ 米，\n- 数值积分步长 $\\Delta z = 10$ 米。\n\n您必须离散化高度并对气块演化方程和浮力廓线进行积分，以计算每个参数集的 $\\mathrm{CIN}(\\epsilon)$。使用一种稳定的方法来检测 $z_{\\mathrm{LFC}}$，即 $B(z)$ 首次变为非负值的高度；如果浮力在地表即为非负，则对流抑制为零。\n\n以焦耳/千克为单位表示每个最终的 $\\mathrm{CIN}$，四舍五入到一位小数。问题不涉及角度，因此无需指定角度单位。最终输出必须是单行文本，其中结果聚合为用方括号括起来的逗号分隔列表。\n\n测试套件：\n为以下四种情况计算 $\\mathrm{CIN}(\\epsilon)$，每种情况由分数卷夹率 $\\epsilon$（单位：1/米）和初始气块虚位温 $\\theta_{v,p}(0)$（单位：开尔文）定义：\n1. $(\\epsilon, \\theta_{v,p}(0)) = (0.0, 300.0)$,\n2. $(\\epsilon, \\theta_{v,p}(0)) = (2\\times 10^{-4}, 299.5)$,\n3. $(\\epsilon, \\theta_{v,p}(0)) = (10^{-3}, 299.0)$,\n4. $(\\epsilon, \\theta_{v,p}(0)) = (5\\times 10^{-4}, 301.0)$.\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，\"[result1,result2,result3,result4]\"），每个结果是对应测试用例计算出的 $\\mathrm{CIN}$ 值（单位：焦耳/千克），并四舍五入到一位小数。",
            "solution": "问题陈述已经过分析，并被认为是有效的。其科学基础是大气热力学和对流原理，采用了一个标准的一维卷夹羽流模型。该问题是适定的，提供了一个具有明确定义初始条件和所有必要参数的一阶常微分方程。语言客观，要求清晰明确。\n\n解决此问题涉及对气块虚位温廓线进行数值积分，随后计算其浮力廓线，最后对对流抑制（CIN）积分进行数值计算。对每个指定的测试用例执行此过程。\n\n算法步骤如下：\n\n1.  **域离散化**：将连续的垂直域 $z \\in [0, z_{\\mathrm{top}}]$ 离散为有限数量的点。我们定义一个均匀网格 $z_i = i \\cdot \\Delta z$，对于 $i = 0, 1, 2, \\dots, N$，其中 $N = z_{\\mathrm{top}} / \\Delta z$。给定参数为 $z_{\\mathrm{top}} = 3000$ 米和 $\\Delta z = 10$ 米，这导致 $N=300$ 个区间和 $301$ 个网格点。\n\n2.  **环境廓线**：环境虚位温 $\\theta_{v,e}(z)$ 是高度的线性函数。其在每个离散网格点 $z_i$ 处的值计算如下：\n    $$ \\theta_{v,e}(z_i) = \\theta_{v,0} + \\gamma_e z_i $$\n    其中 $\\theta_{v,0} = 300$ K 且 $\\gamma_e = 0.003$ K/m。\n\n3.  **气块虚位温廓线**：气块虚位温 $\\theta_{v,p}(z)$ 的演化由以下常微分方程（ODE）控制：\n    $$ \\frac{d\\theta_{v,p}}{dz} = \\epsilon\\left(\\theta_{v,e}(z) - \\theta_{v,p}(z)\\right) + H(z) $$\n    这是一个初值问题，每个测试用例都提供了 $\\theta_{v,p}(0)$。我们数值求解这个ODE。一阶前向欧拉法对于此问题结构是充分且适用的。从 $z_i$ 处的值求得 $z_{i+1}$ 处 $\\theta_{v,p}$ 的迭代格式是：\n    $$ \\theta_{v,p}(z_{i+1}) = \\theta_{v,p}(z_i) + \\Delta z \\left[ \\epsilon\\left(\\theta_{v,e}(z_i) - \\theta_{v,p}(z_i)\\right) + H(z_i) \\right] $$\n    加热项 $H(z_i)$ 由相对于抬升凝结高度 $z_{\\mathrm{LCL}} = 800$ 米的高度决定，其中 $h_m = 0.005$ K/m：\n    $$ H(z_i) = \\begin{cases} 0,  z_i  z_{\\mathrm{LCL}} \\\\ h_m,  z_i \\ge z_{\\mathrm{LCL}} \\end{cases} $$\n    该积分从 $z_0 = 0$ 到 $z_N = z_{\\mathrm{top}}$ 迭代执行。\n\n4.  **浮力廓线**：一旦所有网格点的气块和环境温度廓线 $\\theta_{v,p}(z_i)$ 和 $\\theta_{v,e}(z_i)$ 已知，浮力廓线 $B(z_i)$ 使用其定义计算：\n    $$ B(z_i) = g \\frac{\\theta_{v,p}(z_i) - \\theta_{v,e}(z_i)}{\\theta_{v,e}(z_i)} $$\n    其中 $g = 9.81$ m/s²。\n\n5.  **自由对流高度 (LFC)**：LFC, $z_{\\mathrm{LFC}}$，是气块浮力首次变为非负的最低高度。\n    *   首先，我们检查地表浮力 $B(0)$。如果 $B(0) \\ge 0$，则气块初始时是正浮力或中性浮力。在这种情况下，$z_{\\mathrm{LFC}} = 0$ 且 $\\mathrm{CIN} = 0$。\n    *   如果 $B(0)  0$，我们在离散浮力廓线 $B(z_i)$ 中搜索第一个索引 $i_{\\mathrm{LFC}}$，使得 $B(z_{i_{\\mathrm{LFC}}}) \\ge 0$。对应的高度是 $z_{\\mathrm{LFC}} = z_{i_{\\mathrm{LFC}}}$。\n    *   如果在域内不存在这样的高度（即，对于所有 $z_i \\le z_{\\mathrm{top}}$，都有 $B(z_i)  0$），则CIN积分的上限变为 $z_{\\mathrm{top}}$。\n\n6.  **对流抑制 (CIN) 计算**：CIN通过从地表到LFC对负浮力进行数值积分来计算。其定义为：\n    $$ \\mathrm{CIN}(\\epsilon) = - \\int_0^{z_{\\mathrm{limit}}} \\min\\left(B(z), 0\\right) \\, dz $$\n    其中 $z_{\\mathrm{limit}}$ 是 LFC，如果未达到LFC，则为 $z_{\\mathrm{top}}$。我们采用梯形法则进行此数值积分，它近似了从 $z_0$ 到 $z_{\\mathrm{limit}} = z_{i_{\\mathrm{limit}}}$ 的离散网格上的积分。被积函数为 $f(z_i) = \\min(B(z_i), 0)$。\n    $$ \\int_0^{z_{\\mathrm{limit}}} f(z) \\, dz \\approx \\sum_{j=0}^{i_{\\mathrm{limit}}-1} \\frac{f(z_j) + f(z_{j+1})}{2} \\Delta z $$\n    最终的CIN是该值的负数。\n\n对四个测试用例中的每一个都执行此完整算法，并将得到的CIN值按要求四舍五入到一位小数。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the convective inhibition problem for all test cases.\n    \"\"\"\n\n    # Define the physical constants provided in the problem statement.\n    constants = {\n        'g': 9.81,          # Gravitational acceleration (m/s^2)\n        'theta_v0': 300.0,    # Surface environmental virtual potential temperature (K)\n        'gamma_e': 0.003,     # Environmental gradient (K/m)\n        'z_lcl': 800.0,       # Lifting Condensation Level (m)\n        'h_m': 0.005,         # Latent heating rate (K/m)\n        'z_top': 3000.0,      # Domain top (m)\n        'dz': 10.0,           # Numerical integration step (m)\n    }\n\n    # Define the test cases from the problem statement.\n    # Each case is a tuple: (epsilon, theta_p_initial)\n    test_cases = [\n        (0.0, 300.0),\n        (2e-4, 299.5),\n        (1e-3, 299.0),\n        (5e-4, 301.0),\n    ]\n\n    results = []\n    for epsilon, theta_p_initial in test_cases:\n        # Calculate CIN for a single case.\n        result = calculate_cin_for_case(epsilon, theta_p_initial, constants)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef calculate_cin_for_case(epsilon, theta_p_initial, constants):\n    \"\"\"\n    Calculates CIN for a single set of parameters.\n    \n    Args:\n        epsilon (float): Fractional entrainment rate (1/m).\n        theta_p_initial (float): Initial parcel virtual potential temperature (K).\n        constants (dict): Dictionary of physical constants.\n        \n    Returns:\n        float: The calculated CIN in J/kg, rounded to one decimal place.\n    \"\"\"\n    g = constants['g']\n    theta_v0 = constants['theta_v0']\n    gamma_e = constants['gamma_e']\n    z_lcl = constants['z_lcl']\n    h_m = constants['h_m']\n    z_top = constants['z_top']\n    dz = constants['dz']\n\n    # Step 1: Discretize the vertical domain.\n    z_grid = np.arange(0, z_top + dz, dz)\n    n_levels = len(z_grid)\n\n    # Step 2: Calculate the environmental virtual potential temperature profile.\n    theta_e_profile = theta_v0 + gamma_e * z_grid\n\n    # Check for initial buoyancy. If non-negative, CIN is zero.\n    initial_buoyancy = g * (theta_p_initial - theta_e_profile[0]) / theta_e_profile[0]\n    if initial_buoyancy = 0:\n        return 0.0\n\n    # Step 3: Integrate the parcel's virtual potential temperature profile.\n    theta_p_profile = np.zeros(n_levels)\n    theta_p_profile[0] = theta_p_initial\n\n    for i in range(n_levels - 1):\n        z_i = z_grid[i]\n        theta_p_i = theta_p_profile[i]\n        theta_e_i = theta_e_profile[i]\n\n        # Determine the heating term H(z)\n        H_i = h_m if z_i = z_lcl else 0.0\n\n        # Calculate the derivative d(theta_p)/dz\n        dtheta_p_dz = epsilon * (theta_e_i - theta_p_i) + H_i\n\n        # Perform a single Euler forward step\n        theta_p_profile[i + 1] = theta_p_i + dtheta_p_dz * dz\n\n    # Step 4: Calculate the buoyancy profile.\n    buoyancy_profile = g * (theta_p_profile - theta_e_profile) / theta_e_profile\n\n    # Step 5: Find the Level of Free Convection (LFC).\n    # Find indices where buoyancy is non-negative.\n    lfc_indices = np.where(buoyancy_profile = 0)[0]\n    \n    if len(lfc_indices) == 0:\n        # LFC is not found within the domain; integrate to the top.\n        i_limit = n_levels - 1\n    else:\n        # LFC is the first height where buoyancy is non-negative.\n        i_limit = lfc_indices[0]\n\n    # The problem implies surface LFC is handled, but to be safe:\n    if i_limit == 0:\n        return 0.0\n\n    # Step 6: Calculate CIN using numerical integration.\n    # The integration range is from z=0 to z_LFC (or z_top).\n    integration_z_points = z_grid[:i_limit + 1]\n    buoyancy_to_integrate = buoyancy_profile[:i_limit + 1]\n    \n    # The integrand is min(B(z), 0).\n    integrand = np.minimum(buoyancy_to_integrate, 0)\n    \n    # Use numpy's trapezoidal rule for numerical quadrature.\n    cin_integral = np.trapz(integrand, x=integration_z_points)\n    \n    # CIN is the negative of the integrated negative buoyancy.\n    cin = -cin_integral\n\n    return round(cin, 1)\n\nsolve()\n```"
        },
        {
            "introduction": "在理解了单个气块的动力学之后，我们现在将概念升级，采用质量通量框架来描述整个对流云羽。本练习要求您从质量守恒和标量混合的基本原理出发，推导控制云羽质量通量 $M(z)$ 和虚位温 $\\theta_{v,u}(z)$ 随高度 $z$ 变化的耦合微分方程组。您将通过数值求解这些方程，比较恒定夹卷率和随高度变化的夹卷率这两种不同的参数化方案对云羽垂直结构的影响 。这项实践将使您深刻体会到，在模式中选择不同的参数化方案会对模拟结果产生多么显著的影响，这是环境与地球系统建模中的一个核心议题。",
            "id": "3896699",
            "problem": "要求您在环境和地球系统建模的背景下，使用质量通量框架为一个一维稳态对流上升羽流实现并比较两种夹卷参数化方案。比较的对象是一个常数夹卷率和一个随高度变化的夹卷率。目标是为给定的环境探空计算上升气流质量通量和浮力的垂直廓线，并总结特定的诊断输出。\n\n使用以下基本原理，您必须从第一性原理出发推导出工作方程：\n- 稳态夹卷羽流的质量守恒和应用于虚位温的标量混合。这两者共同构成了一个描述在夹卷和卷出作用下，上升气流质量通量和上升气流热力学属性的常微分方程组（ODEs）。\n- 基于虚位温的浮力定义，与 Boussinesq 近似一致。\n\n环境探空和常数：\n- 环境虚位温廓线由一个关于高度的线性函数给出：$\\theta_{v,e}(z) = \\theta_{v,\\text{sfc}} + \\gamma z$，其中 $\\theta_{v,\\text{sfc}} = 300\\,\\mathrm{K}$ 且 $\\gamma = 0.004\\,\\mathrm{K\\,m^{-1}}$。\n- 重力加速度为 $g = 9.81\\,\\mathrm{m\\,s^{-2}}$。\n- 羽流的下边界为 $z_0 = 500\\,\\mathrm{m}$，模式层顶为 $z_{\\text{top}} = 3000\\,\\mathrm{m}$。\n- 在 $z_0$ 处的初始上升气流质量通量为 $M_0 = 0.08\\,\\mathrm{kg\\,m^{-2}\\,s^{-1}}$。\n- 初始上升气流虚位温由一个环境扰动设定：$\\theta_{v,u}(z_0) = \\theta_{v,e}(z_0) + \\Delta\\theta_{v,0}$，其中 $\\Delta\\theta_{v,0} = 2.0\\,\\mathrm{K}$。\n- 卷出被参数化为夹卷的一个固定比例：$\\delta(z) = \\alpha\\,\\epsilon(z)$，其中每个测试案例的 $\\alpha$ 为常数。\n\n需要比较的参数化方案：\n- 常数夹卷率：$\\epsilon(z) = \\epsilon_0$，其中 $\\epsilon_0$ 由每个测试案例给出。\n- 随高度变化的夹卷率：$\\epsilon(z) = \\epsilon_0\\left(1 + \\frac{z}{H}\\right)$，其中 $H$ 是每个测试案例指定的深度尺度。\n\n任务：\n- 从夹卷羽流的质量守恒和标量混合出发，推导在夹卷和卷出作用下，上升气流质量通量 $M(z)$ 和上升气流虚位温 $\\theta_{v,u}(z)$ 的控制性常微分方程。然后，根据环境和上升气流的虚位温推导浮力 $b(z)$ 的表达式。\n- 使用固定的垂直步长 $\\Delta z = 10\\,\\mathrm{m}$，在高度上从 $z_0$ 到 $z_{\\text{top}}$ 实现数值积分，以获得测试套件中每个参数化案例的 $M(z)$ 和 $b(z)$。通过正确应用夹卷和卷出效应，并根据上升气流与环境的热力学差异计算浮力，来确保科学真实性。\n\n每个测试案例的必需输出：\n- 模式层顶的上升气流质量通量：$M(z_{\\text{top}})$，单位为 $\\mathrm{kg\\,m^{-2}\\,s^{-1}}$。\n- 模式层顶的浮力：$b(z_{\\text{top}})$，单位为 $\\mathrm{m\\,s^{-2}}$。\n- 第一个中性高度 $z_\\text{neutral}$，单位为米，定义为在 $[z_0, z_{\\text{top}}]$ 区间内 $b(z)$ 首次变为非正值的最低高度。如果在此区间内没有出现中性高度，则返回 $-1.0$。\n\n测试套件：\n- 案例1（理想路径）：常数夹卷，$\\epsilon_0 = 1.0\\times 10^{-4}\\,\\mathrm{m^{-1}}$ 且 $\\alpha = 0.2$。\n- 案例2（随高度变化）：随高度变化的夹卷，$\\epsilon_0 = 1.0\\times 10^{-4}\\,\\mathrm{m^{-1}}$，$H = 2000\\,\\mathrm{m}$ 且 $\\alpha = 0.2$。\n- 案例3（边界，无夹卷）：常数夹卷，$\\epsilon_0 = 0.0\\,\\mathrm{m^{-1}}$ 且 $\\alpha = 0.2$。\n- 案例4（边界，质量通量中性卷出）：常数夹卷，$\\epsilon_0 = 1.0\\times 10^{-4}\\,\\mathrm{m^{-1}}$ 且 $\\alpha = 1.0$。\n\n单位：\n- 以浮点数形式返回 $M(z_{\\text{top}})$（单位 $\\mathrm{kg\\,m^{-2}\\,s^{-1}}$）、$b(z_{\\text{top}})$（单位 $\\mathrm{m\\,s^{-2}}$）和 $z_\\text{neutral}$（单位 $\\mathrm{m}$）。不要使用百分比。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个由方括号括起来的、逗号分隔的列表的列表。每个内部列表对应一个测试案例，并且必须按 $[M(z_{\\text{top}}), b(z_{\\text{top}}), z_\\text{neutral}]$ 的顺序排列。例如：$[[m_1,b_1,z_1],[m_2,b_2,z_2],[m_3,b_3,z_3],[m_4,b_4,z_4]]$。",
            "solution": "我们从一维框架下稳态对流上升羽流的质量通量表示开始。设 $M(z)$ 表示单位面积的上升气流质量通量，$\\epsilon(z)$ 和 $\\delta(z)$ 分别表示单位高度的夹卷率和卷出率。设 $\\theta_{v,u}(z)$ 表示上升气流的虚位温，$\\theta_{v,e}(z)$ 表示环境的虚位温。根据 Boussinesq 近似，浮力定义为 $b(z) = g\\,\\frac{\\theta_{v,u}(z) - \\theta_{v,e}(z)}{\\theta_{v,e}(z)}$。推导过程基于以下基本原理。\n\n根据稳态夹卷羽流的质量守恒，质量通量随高度的变化率等于夹卷带来的净增益减去卷出造成的净损失。单位高度内，流入羽流的环境质量为 $\\epsilon(z)\\,M(z)$，因卷出而流出羽流的质量为 $\\delta(z)\\,M(z)$。因此，\n$$\n\\frac{dM}{dz} = \\left[\\epsilon(z) - \\delta(z)\\right]\\,M(z).\n$$\n我们将卷出参数化为夹卷的一部分，即 $\\delta(z) = \\alpha\\,\\epsilon(z)$，其中 $0 \\le \\alpha \\le 1$ 以在测试案例中保持物理真实性。代入后得到\n$$\n\\frac{dM}{dz} = \\left[1 - \\alpha\\right]\\,\\epsilon(z)\\,M(z).\n$$\n\n接下来，对于一个由上升气流携带的守恒标量 $\\chi$（忽略内部源和汇），稳态羽流的标量收支方程为\n$$\n\\frac{d}{dz}\\left[M(z)\\,\\chi_u(z)\\right] = \\epsilon(z)\\,M(z)\\,\\chi_e(z) - \\delta(z)\\,M(z)\\,\\chi_u(z),\n$$\n其中 $\\chi_u$ 表示上升气流中的标量，$\\chi_e$ 表示环境中的标量。用 $M(z)$ 除以方程两边，并使用质量收支中的 $\\frac{dM}{dz}$，\n$$\n\\frac{d\\chi_u}{dz} + \\frac{1}{M(z)}\\frac{dM}{dz}\\,\\chi_u(z) = \\epsilon(z)\\,\\chi_e(z) - \\delta(z)\\,\\chi_u(z),\n$$\n$$\n\\frac{d\\chi_u}{dz} + \\left[1 - \\alpha\\right]\\,\\epsilon(z)\\,\\chi_u(z) = \\epsilon(z)\\,\\chi_e(z) - \\alpha\\,\\epsilon(z)\\,\\chi_u(z),\n$$\n可简化为\n$$\n\\frac{d\\chi_u}{dz} = \\epsilon(z)\\,\\left[\\chi_e(z) - \\chi_u(z)\\right].\n$$\n取 $\\chi \\equiv \\theta_{v}$，我们得到\n$$\n\\frac{d\\theta_{v,u}}{dz} = \\epsilon(z)\\,\\left[\\theta_{v,e}(z) - \\theta_{v,u}(z)\\right].\n$$\n\n然后浮力计算如下\n$$\nb(z) = g\\,\\frac{\\theta_{v,u}(z) - \\theta_{v,e}(z)}{\\theta_{v,e}(z)}.\n$$\n在环境探空指定为\n$$\n\\theta_{v,e}(z) = \\theta_{v,\\text{sfc}} + \\gamma z,\n$$\n且 $\\theta_{v,\\text{sfc}} = 300\\,\\mathrm{K}$、$\\gamma = 0.004\\,\\mathrm{K\\,m^{-1}}$，以及常数 $g = 9.81\\,\\mathrm{m\\,s^{-2}}$ 的条件下，问题简化为对以下耦合系统进行数值积分：\n- $\\frac{dM}{dz} = \\left[1 - \\alpha\\right]\\,\\epsilon(z)\\,M(z)$,\n- $\\frac{d\\theta_{v,u}}{dz} = \\epsilon(z)\\,\\left[\\theta_{v,e}(z) - \\theta_{v,u}(z)\\right]$,\n初始条件位于 $z_0 = 500\\,\\mathrm{m}$：\n- $M(z_0) = M_0 = 0.08\\,\\mathrm{kg\\,m^{-2}\\,s^{-1}}$,\n- $\\theta_{v,u}(z_0) = \\theta_{v,e}(z_0) + \\Delta\\theta_{v,0}$，其中 $\\Delta\\theta_{v,0} = 2.0\\,\\mathrm{K}$,\n积分上限为 $z_{\\text{top}} = 3000\\,\\mathrm{m}$。\n\n夹卷参数化方案：\n- 常数：$\\epsilon(z) = \\epsilon_0$。\n- 随高度变化：$\\epsilon(z) = \\epsilon_0\\left(1 + \\frac{z}{H}\\right)$。\n\n数值方法：\n- 使用固定步长的向前欧拉格式，步长为 $\\Delta z = 10\\,\\mathrm{m}$ 来推进 $M$ 和 $\\theta_{v,u}$：\n$$\nM_{n+1} = M_n + \\left[1 - \\alpha\\right]\\,\\epsilon(z_n)\\,M_n\\,\\Delta z,\n$$\n$$\n\\theta_{v,u,n+1} = \\theta_{v,u,n} + \\epsilon(z_n)\\left[\\theta_{v,e}(z_n) - \\theta_{v,u,n}\\right]\\Delta z.\n$$\n在每个高度层计算浮力\n$$\nb_n = g\\,\\frac{\\theta_{v,u,n} - \\theta_{v,e}(z_n)}{\\theta_{v,e}(z_n)}.\n$$\n记录 $b$ 首次变为非正值时的第一个中性高度 $z_\\text{neutral}$。为提高精度，如果 $b_{n} > 0$ 且 $b_{n+1} \\le 0$，则在区间内进行线性插值：\n$$\nz_\\text{neutral} \\approx z_n + \\Delta z\\,\\frac{0 - b_n}{b_{n+1} - b_n}.\n$$\n如果在 $[z_0,z_{\\text{top}}]$ 上未找到交叉点，则返回 $-1.0$。\n\n测试套件参数：\n- 案例1：$\\epsilon_0 = 1.0\\times 10^{-4}\\,\\mathrm{m^{-1}}$, $\\alpha = 0.2$ (常数)。\n- 案例2：$\\epsilon_0 = 1.0\\times 10^{-4}\\,\\mathrm{m^{-1}}$, $H = 2000\\,\\mathrm{m}$, $\\alpha = 0.2$ (随高度变化)。\n- 案例3：$\\epsilon_0 = 0.0\\,\\mathrm{m^{-1}}$, $\\alpha = 0.2$ (常数；无夹卷的边界条件)。\n- 案例4：$\\epsilon_0 = 1.0\\times 10^{-4}\\,\\mathrm{m^{-1}}$, $\\alpha = 1.0$ (常数；边界条件，其中卷出在质量收支中恰好抵消了夹卷，因此 $M$ 随高度保持不变)。\n\n每个案例的算法输出：\n- $M(z_{\\text{top}})$，单位 $\\mathrm{kg\\,m^{-2}\\,s^{-1}}$，\n- $b(z_{\\text{top}})$，单位 $\\mathrm{m\\,s^{-2}}$，\n- $z_\\text{neutral}$，单位 $\\mathrm{m}$，若无中性高度则为 $-1.0$。\n\n最终程序将每个案例的这些结果汇总到单行打印输出中，格式为逗号分隔的列表的列表，以符合要求的格式。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef integrate_case(case, params):\n    # Unpack global parameters\n    z0 = params['z0']\n    z_top = params['z_top']\n    dz = params['dz']\n    g = params['g']\n    theta_sfc = params['theta_sfc']\n    gamma = params['gamma']\n    M0 = params['M0']\n    dtheta0 = params['dtheta0']\n    H_default = params['H_default']\n\n    case_type = case['type']           # 'const' or 'linear'\n    eps0 = case['eps0']                # base entrainment [1/m]\n    alpha = case['alpha']              # detrainment fraction of entrainment\n    H = case.get('H', H_default)       # depth scale [m] for linear entrainment\n\n    # Environmental virtual potential temperature profile\n    def theta_env(z):\n        return theta_sfc + gamma * z\n\n    # Entrainment parameterization function\n    if case_type == 'const':\n        def eps(z):\n            return eps0\n    elif case_type == 'linear':\n        def eps(z):\n            return eps0 * (1.0 + z / H)\n    else:\n        raise ValueError(\"Unknown case type.\")\n\n    # Initialize state at z0\n    z_levels = np.arange(z0, z_top + dz, dz)\n    M = M0\n    theta_u = theta_env(z0) + dtheta0\n    b_prev = g * (theta_u - theta_env(z0)) / theta_env(z0)\n    neutral_height = None\n\n    # March upward\n    for i in range(1, len(z_levels)):\n        z = z_levels[i-1]\n        z_next = z_levels[i]\n        # Compute entrainment\n        eps_z = eps(z)\n\n        # Update mass flux\n        dM = (1.0 - alpha) * eps_z * M * dz\n        M_next = M + dM\n\n        # Update updraft virtual potential temperature\n        theta_e_z = theta_env(z)\n        dtheta_u = eps_z * (theta_e_z - theta_u) * dz\n        theta_u_next = theta_u + dtheta_u\n\n        # Compute buoyancy at next level\n        theta_e_next = theta_env(z_next)\n        b_next = g * (theta_u_next - theta_e_next) / theta_e_next\n\n        # Detect first neutral level\n        if neutral_height is None and (b_prev  0.0) and (b_next = 0.0):\n            # Linear interpolation for crossing within [z, z_next]\n            frac = (0.0 - b_prev) / (b_next - b_prev) if (b_next - b_prev) != 0.0 else 0.0\n            neutral_height = z + dz * max(0.0, min(1.0, frac))\n\n        # Advance\n        M = M_next\n        theta_u = theta_u_next\n        b_prev = b_next\n\n    # Final outputs\n    M_top = M\n    b_top = b_prev\n    z_neutral = neutral_height if neutral_height is not None else -1.0\n\n    return [M_top, b_top, z_neutral]\n\ndef solve():\n    # Global parameters from the problem statement\n    params = {\n        'z0': 500.0,            # m\n        'z_top': 3000.0,        # m\n        'dz': 10.0,             # m\n        'g': 9.81,              # m/s^2\n        'theta_sfc': 300.0,     # K\n        'gamma': 0.004,         # K/m\n        'M0': 0.08,             # kg m^-2 s^-1\n        'dtheta0': 2.0,         # K\n        'H_default': 2000.0     # m\n    }\n\n    # Define the test cases from the problem statement\n    test_cases = [\n        # Case 1: Constant epsilon, alpha=0.2\n        {'type': 'const', 'eps0': 1.0e-4, 'alpha': 0.2},\n        # Case 2: Height-dependent epsilon, alpha=0.2, H=2000 m\n        {'type': 'linear', 'eps0': 1.0e-4, 'alpha': 0.2, 'H': 2000.0},\n        # Case 3: No entrainment, alpha=0.2\n        {'type': 'const', 'eps0': 0.0, 'alpha': 0.2},\n        # Case 4: Constant epsilon, alpha=1.0 (mass-flux neutral detrainment)\n        {'type': 'const', 'eps0': 1.0e-4, 'alpha': 1.0},\n    ]\n\n    results = []\n    for case in test_cases:\n        M_top, b_top, z_neutral = integrate_case(case, params)\n        results.append([M_top, b_top, z_neutral])\n\n    # Format output: single line, comma-separated lists with no spaces\n    def format_sublist(lst):\n        return \"[\" + \",\".join(f\"{x:.6f}\" for x in lst) + \"]\"\n    output = \"[\" + \",\".join(format_sublist(r) for r in results) + \"]\"\n    print(output)\n\nsolve()\n```"
        },
        {
            "introduction": "最后一个练习是一个综合性的挑战，旨在构建一个更为真实、包含复杂微物理过程的对流云羽模型。在这个任务中，您需要同时处理水汽（$q_v$）、云水（$q_c$）、雨水（$q_r$）和湿静力能（$h$）这四个相互作用的标量。您将实现一套微物理参数化方案，模拟云的凝结、雨水的蒸发、自动转化和碰落等过程 。这项实践的最终目标是验证您所构建的数值模型是否遵守广义湿静力能的守恒定律，这是检验数值方案保真性的关键一步，也是真实世界模型开发中的一项基本技能。",
            "id": "3896770",
            "problem": "考虑一个用于对流的一维、稳定、夹卷羽流模型，其中羽流输送四个标量：水汽混合比 $q_v$（千克/千克）、云液态水混合比 $q_c$（千克/千克）、雨水混合比 $q_r$（千克/千克）和湿静力能 $h$（焦耳/千克）。该羽流具有垂直质量通量 $M(z)$（千克/平方米/秒），并通过夹卷率 $e(z)$（每米）和卷出率 $d(z)$（每米）与环境交换质量。环境具有指定的温度 $T_{\\mathrm{env}}(z)$（开尔文）和水汽混合比 $q_{v,\\mathrm{env}}(z)$（千克/千克）的廓线。\n\n将湿静力能 $h$ 定义为 $h = c_p T + g z + L_v q_v$，其中 $c_p$（焦耳/千克/开尔文）是干空气的定压比热，$T$（开尔文）是羽流温度，$g$（米/平方秒）是重力加速度，$z$（米）是高度，$L_v$（焦耳/千克）是蒸发潜热。为进行能量守恒验证，还需定义广义湿静力能 $h_g = c_p T + g z + L_v (q_v + q_c + q_r)$，它考虑了储存在所有水成物中的潜热。\n\n假设以下基本定律和定义：\n- 在一个稳定的夹卷/卷出羽流中，对于任何羽流标量 $\\phi$，其标量守恒可写为垂直通量收支方程\n$$\\frac{d}{dz}\\left(M \\phi\\right) = e M \\left(\\phi_{\\mathrm{env}} - \\phi\\right) - d M \\left(\\phi - \\phi_{\\mathrm{env}}\\right) + S_\\phi,$$\n其中 $\\phi_{\\mathrm{env}}$ 是 $\\phi$ 在环境中的对应量，$S_\\phi$ 代表由微物理过程引起的内部源/汇项。在此模型中，夹卷和卷出被共同处理为一个对称的湍流交换过程，其净效应是将环境属性混合进羽流中，因此混合项可简化为 $(e + d) M (\\phi_{\\mathrm{env}} - \\phi)$。\n- 羽流质量通量的演变如下\n$$\\frac{dM}{dz} = \\left(e - d\\right) M.$$\n- 压力 $p(z)$（帕斯卡）是静力平衡的，并用指数廓线 $p(z) = p_0 \\exp\\left(-\\frac{z}{H}\\right)$ 近似，其中 $p_0$（帕斯卡）是参考压力，$H$（米）是标高。\n- 饱和水汽压 $e_s(T)$（帕斯卡）遵循克劳修斯-克拉佩龙关系\n$$e_s(T) = e_0 \\exp\\left(\\frac{L_v}{R_v}\\left(\\frac{1}{T_0} - \\frac{1}{T}\\right)\\right),$$\n其中 $e_0$（帕斯卡）是温度为 $T_0$（开尔文）时的参考饱和水汽压，$R_v$（焦耳/千克/开尔文）是水汽气体常数。饱和混合比 $q_{\\mathrm{sat}}(T,p)$（千克/千克）为\n$$q_{\\mathrm{sat}}(T,p) = \\epsilon \\frac{e_s(T)}{p - e_s(T)},$$\n其中 $\\epsilon$ 是干空气气体常数与水汽气体常数之比。\n\n微物理过程被参数化为每米变化率（混合比每米的变化），这些变化率是羽流状态的函数：\n- 凝结率 $r_C = \\max\\left(q_v - q_{\\mathrm{sat}}, 0\\right)/\\ell_{\\mathrm{cond}}$，在过饱和时将物质从 $q_v$ 转移到 $q_c$，其中 $\\ell_{\\mathrm{cond}}$（米）是凝结长度尺度。\n- 雨水蒸发率 $r_E = \\mathbf{1}_{q_{\\mathrm{sat}}  q_v} \\cdot \\min\\left(q_{\\mathrm{sat}} - q_v, q_r\\right)/\\ell_{\\mathrm{evap}}$，在未饱和时将物质从 $q_r$ 转移到 $q_v$，其中 $\\ell_{\\mathrm{evap}}$（米）是蒸发长度尺度。\n- 自动转化率 $r_A = \\max\\left(q_c - q_{\\mathrm{auto}}, 0\\right)/\\ell_{\\mathrm{auto}}$，在云水含量超过阈值 $q_{\\mathrm{auto}}$（千克/千克）时将物质从 $q_c$ 转移到 $q_r$，其中 $\\ell_{\\mathrm{auto}}$（米）是自动转化长度尺度。\n- 沉降率 $r_S = q_r / \\ell_{\\mathrm{sed}}$，将雨水从羽流中移除（离开气柱的降水），其中 $\\ell_{\\mathrm{sed}}$（米）是沉降长度尺度。\n\n因此，通量收支方程中的微物理源项为\n$$S_{q_v} = M\\left(-r_C + r_E\\right), \\quad S_{q_c} = M\\left(r_C - r_A\\right), \\quad S_{q_r} = M\\left(r_A - r_E - r_S\\right), \\quad S_h = 0,$$\n对于广义湿静力能\n$$S_{h_g} = - L_v M r_S,$$\n因为气柱内部的相变不改变 $h_g$，而降水（沉降）会从气柱中移除潜热。\n\n您的任务是实现一个数值求解器，该求解器能够：\n1. 将从 $z = 0$（米）到 $z = z_{\\mathrm{top}}$（米）的气柱离散化为 $N$ 个等间距的层级。\n2. 使用给定的基础值 $T(0)$（开尔文）、$q_v(0)$（千克/千克）、$q_c(0) = 0$（千克/千克）、$q_r(0) = 0$（千克/千克）和 $M(0)$（千克/平方米/秒）来初始化 $z = 0$ 处的羽流状态。设置 $h(0) = c_p T(0) + g\\cdot 0 + L_v q_v(0)$。\n3. 指定环境廓线：$T_{\\mathrm{env}}(z) = T_{\\mathrm{env},0} - \\Gamma z$（开尔文），其中递减率为 $\\Gamma$（开尔文/米）；$q_{v,\\mathrm{env}}(z) = q_{v,\\mathrm{env},0} \\exp\\left(-z/\\Lambda_q\\right)$（千克/千克），其中湿度标高为 $\\Lambda_q$（米）；以及 $h_{\\mathrm{env}}(z) = c_p T_{\\mathrm{env}}(z) + g z + L_v q_{v,\\mathrm{env}}(z)$。\n4. 对于每个标量通量 $F_\\phi = M \\phi$，使用上述收支方程和前向欧拉格式在 $z$ 方向向上推进，并使用 $\\frac{dM}{dz} = (e - d)M$ 更新 $M$。在每个层级，通过 $T = \\left(h - g z - L_v q_v\\right)/c_p$ 从 $h = c_p T + g z + L_v q_v$ 恢复 $T$，计算 $q_{\\mathrm{sat}}(T,p)$，然后计算 $r_C$、$r_E$、$r_A$ 和 $r_S$ 以及 $S_\\phi$。通过在0（千克/千克）处截断，保持 $q_v$、$q_c$ 和 $q_r$ 为非负。\n5. 计算离开气柱的累计降水质量通量，\n$$P = \\int_0^{z_{\\mathrm{top}}} M(z) r_S(z) \\, dz,$$\n单位为千克/平方米/秒。\n6. 通过数值检验 $h_g$ 通量收支的积分形式来验证气柱广义能量守恒：\n$$\\left[M h_g\\right]_{z=0}^{z=z_{\\mathrm{top}}} \\stackrel{?}{=} \\int_0^{z_{\\mathrm{top}}} \\left( (e+d) M \\left(h_{g,\\mathrm{env}} - h_g\\right) - L_v M r_S \\right) dz,$$\n其中 $h_g = c_p T + g z + L_v (q_v + q_c + q_r)$ 且 $h_{g,\\mathrm{env}} = c_p T_{\\mathrm{env}} + g z + L_v q_{v,\\mathrm{env}}$。\n7. 返回一个布尔值，指示左侧和右侧之间的绝对残差是否低于一个按两侧量级缩放的容差。使用标准\n$$\\left|\\Delta\\right| \\le \\tau \\cdot \\max\\left(\\left|L\\right| + \\left|R\\right|, \\delta\\right),$$\n其中 $\\tau = 10^{-6}$ 且 $\\delta = 10^{-12}$，$\\Delta$ 是左侧和右侧之差，$L$ 是左侧，$R$ 是右侧。\n\n所有测试用例中使用的常数和单位：\n- $c_p = 1004$（焦耳/千克/开尔文），$g = 9.81$（米/平方秒），$L_v = 2.5 \\times 10^6$（焦耳/千克），$\\epsilon = 0.622$（无量纲），$p_0 = 1.0 \\times 10^5$（帕斯卡），$H = 7000$（米），$e_0 = 611.2$（帕斯卡），$T_0 = 273.15$（开尔文），$R_v = 461.0$（焦耳/千克/开尔文）。\n\n测试套件：\n提供四组参数集以检验不同情景。所有高度单位为米，温度单位为开尔文，混合比单位为千克/千克。气柱顶部为 $z_{\\mathrm{top}} = 5000$（米），离散化为 $N = 101$ 个层级。\n- A例（一般湿对流，中等降水）：$M(0) = 0.05$, $e = 1.0 \\times 10^{-4}$, $d = 0.7 \\times 10^{-4}$, $\\ell_{\\mathrm{cond}} = 100.0$, $\\ell_{\\mathrm{evap}} = 150.0$, $\\ell_{\\mathrm{auto}} = 200.0$, $\\ell_{\\mathrm{sed}} = 500.0$, $q_{\\mathrm{auto}} = 1.0 \\times 10^{-4}$, $T(0) = 300.0$, $q_v(0) = 0.018$, $T_{\\mathrm{env},0} = 298.0$, $\\Gamma = 6.0 \\times 10^{-3}$, $q_{v,\\mathrm{env},0} = 0.015$, $\\Lambda_q = 2000.0$。\n- B例（无混合，仅微物理过程）：$M(0) = 0.05$, $e = 0.0$, $d = 0.0$, $\\ell_{\\mathrm{cond}} = 120.0$, $\\ell_{\\mathrm{evap}} = 150.0$, $\\ell_{\\mathrm{auto}} = 220.0$, $\\ell_{\\mathrm{sed}} = 600.0$, $q_{\\mathrm{auto}} = 1.2 \\times 10^{-4}$, $T(0) = 300.0$, $q_v(0) = 0.018$, $T_{\\mathrm{env},0} = 298.0$, $\\Gamma = 6.0 \\times 10^{-3}$, $q_{v,\\mathrm{env},0} = 0.015$, $\\Lambda_q = 2000.0$。\n- C例（强夹卷，干燥环境，蒸发为主）：$M(0) = 0.05$, $e = 3.0 \\times 10^{-4}$, $d = 2.0 \\times 10^{-4}$, $\\ell_{\\mathrm{cond}} = 100.0$, $\\ell_{\\mathrm{evap}} = 80.0$, $\\ell_{\\mathrm{auto}} = 220.0$, $\\ell_{\\mathrm{sed}} = 600.0$, $q_{\\mathrm{auto}} = 1.0 \\times 10^{-4}$, $T(0) = 299.0$, $q_v(0) = 0.017$, $T_{\\mathrm{env},0} = 296.0$, $\\Gamma = 6.5 \\times 10^{-3}$, $q_{v,\\mathrm{env},0} = 0.010$, $\\Lambda_q = 1000.0$。\n- D例（湿润环境，高效自动转化，强降水）：$M(0) = 0.08$, $e = 1.0 \\times 10^{-4}$, $d = 0.5 \\times 10^{-4}$, $\\ell_{\\mathrm{cond}} = 90.0$, $\\ell_{\\mathrm{evap}} = 140.0$, $\\ell_{\\mathrm{auto}} = 80.0$, $\\ell_{\\mathrm{sed}} = 300.0$, $q_{\\mathrm{auto}} = 1.0 \\times 10^{-4}$, $T(0) = 302.0$, $q_v(0) = 0.022$, $T_{\\mathrm{env},0} = 300.0$, $\\Gamma = 6.0 \\times 10^{-3}$, $q_{v,\\mathrm{env},0} = 0.020$, $\\Lambda_q = 2500.0$。\n\n您的程序应为每个测试用例对这些收支进行数值积分，并为每个用例输出一个布尔值，指示项目6中的广义能量守恒检查是否在项目7的容差范围内通过。您的程序应生成单行输出，其中包含一个方括号括起来的逗号分隔结果列表（例如，$[result_1,result_2,result_3,result_4]$），其中每个 $result_i$ 为 $True$ 或 $False$。",
            "solution": "用户提供了一个问题，要求为一个一维、稳态夹卷羽流模型开发一个数值求解器。该模型描述了垂直质量通量（$M$）和四个守恒标量：水汽（$q_v$）、云水（$q_c$）、雨水（$q_r$）和湿静力能（$h$）的演变。任务是实现这个求解器，将其应用于四个不同的测试用例，并对每个用例，根据指定的容差验证一个相关量——广义湿静力能（$h_g$）——的数值守恒性。\n\n在继续之前，必须对问题陈述进行严格验证。\n\n### 问题验证\n\n根据所需标准对问题进行验证。\n\n**步骤1：提取给定信息**\n所有数据、方程、常数、初始条件和数值参数都已从问题陈述中仔细提取。其中包括：\n- 关于$M(z)$, $M(z)q_v(z)$, $M(z)q_c(z)$, $M(z)q_r(z)$和$M(z)h(z)$的五个耦合常微分方程组。\n- 湿静力能（$h$）和广义湿静力能（$h_g$）的定义。\n- 关于压力（$p(z)$）、饱和水汽压（$e_s(T)$）和饱和混合比（$q_{\\mathrm{sat}}(T, p)$）的辅助物理关系。\n- 微物理过程的参数化：凝结（$r_C$）、蒸发（$r_E$）、自动转化（$r_A$）和沉降（$r_S$），以及它们在通量收支方程中对应的源项（$S_\\phi$）。\n- 指定的数值方法（前向欧拉法）、网格配置（$z_{\\mathrm{top}}, N$）和物理约束（混合比的非负性）。\n- 待验证的广义湿静力能积分守恒定律的精确方程。\n- 此验证的数值容差标准。\n- 用于四个不同测试用例的一整套物理常数和参数。\n\n**步骤2：使用提取的给定信息进行验证**\n- **科学依据**：该模型基于应用于大气对流的流体动力学和热力学的既定原理。夹卷羽流概念、质量和标量守恒、静力平衡以及克劳修斯-克拉佩龙热力学都是大气科学的基石。微物理参数化虽经简化，但代表了大气建模中的标准方法。该模型在科学上是合理的。\n- **适定性**：该问题为一个常微分方程组设立了一个初值问题。给定 $z=0$ 处的初始条件，可以对该系统进行积分以产生唯一解。任务定义清晰，并提供了产生解决方案所需的所有必要信息。\n- **客观性**：问题以精确、定量和客观的语言陈述。没有主观或基于观点的内容。\n- **完整性与一致性**：问题是自洽的。所提供的方程内部一致。例如，为验证而提出的 $h_g$ 守恒定律的积分形式，是同样也已给出的 $h_g$ 通量收支方程微分形式的正确数学推论。\n- **可行性**：指定的物理参数和初始条件在现实大气现象的范围内。该数值任务使用标准工具在计算上是可行的。\n\n**步骤3：结论与行动**\n问题定义明确、科学有效且内部一致。它构成了大气科学领域一个标准的、尽管全面的数值模拟练习。因此，该问题被视为**有效**，并将开发解决方案。\n\n### 解决方案与算法设计\n\n该解决方案涉及从指定的初始状态对一个常微分方程组进行数值积分。算法的核心是从大气柱底部到顶部，在高度上一步步向上推进。\n\n**1. 离散化与初始化**\n垂直域从 $z=0$ 到 $z=z_{\\mathrm{top}}$ 被离散化为 $N$ 个等间距的层级。这定义了一个高度网格 $z_i = i \\cdot \\Delta z$（$i=0, \\dots, N-1$），其中步长为 $\\Delta z = z_{\\mathrm{top}} / (N-1)$。\n\n初始化数组以存储羽流的状态变量——$M, q_v, q_c, q_r, h$——在每个网格层级。温度（$T_{\\mathrm{env}}(z)$）、水汽（$q_{v,\\mathrm{env}}(z)$）和压力（$p(z)$）的环境廓线根据提供的解析函数为所有网格层级预先计算并存储。\n\n羽流在基础层 $z_0=0$ 的状态根据给定的初始条件设置：$M(0)$、$T(0)$和$q_v(0)$是指定的，而$q_c(0)=0$和$q_r(0)=0$。初始湿静力能计算为 $h(0) = c_p T(0) + L_v q_v(0)$。\n\n**2. 使用前向欧拉格式进行数值积分**\n系统从层级 $i$ 向上积分到 $i+1$（$i=0, \\dots, N-2$）。问题指定对通量 $F_\\phi = M \\phi$ 和质量通量 $M$ 应用前向欧拉方法。更新规则是：\n$$M_{i+1} = M_i + \\left(\\frac{dM}{dz}\\right)_i \\Delta z$$\n$$F_{\\phi, i+1} = F_{\\phi, i} + \\left(\\frac{dF_\\phi}{dz}\\right)_i \\Delta z$$\n其中下标 $i$ 表示在层级 $z_i$ 处求值。\n\n在每个步骤 $i$ 的过程如下：\n- **状态恢复**：羽流温度 $T_i$ 从预报变量 $h_i$ 和其他状态变量中诊断得出：$T_i = (h_i - g z_i - L_v q_{v,i}) / c_p$。这一步至关重要，因为它隐含地考虑了相变产生的潜热加热/冷却，相变过程会守恒 $h$ 但改变 $T$ 和 $q_v$。\n- **热力学状态**：使用恢复的温度 $T_i$ 和预先计算的压力 $p_i$，通过克劳修斯-克拉佩龙关系及派生关系计算饱和混合比 $q_{\\mathrm{sat},i}$。\n- **微物理速率**：基于当前羽流状态（$q_{v,i}, q_{c,i}, q_{r,i}, q_{\\mathrm{sat},i}$）和指定的长度尺度，计算凝结（$r_{C,i}$）、蒸发（$r_{E,i}$）、自动转化（$r_{A,i}$）和沉降（$r_{S,i}$）的每米速率。\n- **源项计算**：使用微物理速率计算 $q_v, q_c$ 和 $q_r$ 通量方程的源项 $S_{\\phi,i}$。根据规定，$S_{h,i} = 0$。\n- **导数计算**：使用提供的控制方程计算导数 $\\left(\\frac{dM}{dz}\\right)_i$ 和 $\\left(\\frac{dF_\\phi}{dz}\\right)_i$，并用层级 $i$ 的量进行评估。对于标量 $\\phi \\in \\{q_c, q_r\\}$，环境值 $\\phi_{\\mathrm{env}}$ 为零。\n- **状态更新**：使用前向欧拉公式计算 $M_{i+1}$ 和通量 $F_{\\phi, i+1}$ 的值。\n- **标量恢复**：通过将其各自的通量除以新的质量通量来恢复层级 $i+1$ 处的标量混合比：$\\phi_{i+1} = F_{\\phi, i+1} / M_{i+1}$。\n- **物理约束**：按照指示，水物质混合比（$q_v, q_c, q_r$）通过将任何负值截断为零来约束为非负。这个数值过程可能会引入小的守恒误差，这是简单平流格式的一个已知的人为误差。\n\n**3. 能量守恒验证**\n在整个气柱上的积分完成后，检查广义湿静力能 $h_g$ 的数值守恒性。这涉及计算积分守恒定律的两侧：\n$$\\left[M h_g\\right]_{z=0}^{z_{\\mathrm{top}}} = \\int_0^{z_{\\mathrm{top}}} \\left( (e+d) M \\left(h_{g,\\mathrm{env}} - h_g\\right) - L_v M r_S \\right) dz$$\n- **左侧（LHS）**：这是离开该域的 $h_g$ 净通量，计算为 $(M h_g)_{N-1} - (M h_g)_0$。每个层级的 $h_g$ 值是从最终计算出的状态变量 $T_i, q_{v,i}, q_{c,i}, q_{r,i}$ 诊断得出的。\n- **右侧（RHS）**：这代表了域内由于与环境的侧向混合以及降水移除而产生的 $h_g$ 净源。被积函数在每个网格点 $i$ 计算。然后使用梯形法则对积分进行数值近似，该方法提供二阶精度，非常适合此验证。\n- **比较**：将 LHS 和 RHS 之间的绝对差 $\\Delta = \\mathrm{LHS} - \\mathrm{RHS}$ 与指定的相对容差进行比较：$|\\Delta| \\le \\tau \\cdot \\max(\\left|\\mathrm{LHS}\\right| + \\left|\\mathrm{RHS}\\right|, \\delta)$。此比较的结果是一个布尔值，是该测试用例的最终输出。\n\n这一全面的过程确保了模型按规定实现，其自洽性得到严格测试，并遵循了数值分析和科学计算的原则。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the entraining plume model simulation for all test cases\n    and report on the generalized energy conservation check.\n    \"\"\"\n\n    # --- Physical Constants ---\n    CONST = {\n        'cp': 1004.0,       # J/kg/K\n        'g': 9.81,          # m/s^2\n        'Lv': 2.5e6,        # J/kg\n        'eps': 0.622,       # dimensionless\n        'p0': 1.0e5,        # Pa\n        'H': 7000.0,        # m\n        'e0': 611.2,        # Pa at T0\n        'T0': 273.15,       # K\n        'Rv': 461.0,        # J/kg/K\n    }\n\n    # --- Simulation Parameters ---\n    z_top = 5000.0  # m\n    N = 101         # number of levels\n    \n    # --- Test Cases ---\n    test_cases = [\n        # Case A: General moist convection\n        {'name': 'A', 'M0': 0.05, 'e': 1.0e-4, 'd': 0.7e-4, 'l_cond': 100.0, 'l_evap': 150.0, 'l_auto': 200.0, 'l_sed': 500.0, 'q_auto': 1.0e-4, 'T0': 300.0, 'qv0': 0.018, 'T_env0': 298.0, 'Gamma': 6.0e-3, 'qv_env0': 0.015, 'Lambda_q': 2000.0},\n        # Case B: No mixing\n        {'name': 'B', 'M0': 0.05, 'e': 0.0, 'd': 0.0, 'l_cond': 120.0, 'l_evap': 150.0, 'l_auto': 220.0, 'l_sed': 600.0, 'q_auto': 1.2e-4, 'T0': 300.0, 'qv0': 0.018, 'T_env0': 298.0, 'Gamma': 6.0e-3, 'qv_env0': 0.015, 'Lambda_q': 2000.0},\n        # Case C: Strong entrainment, dry environment\n        {'name': 'C', 'M0': 0.05, 'e': 3.0e-4, 'd': 2.0e-4, 'l_cond': 100.0, 'l_evap': 80.0, 'l_auto': 220.0, 'l_sed': 600.0, 'q_auto': 1.0e-4, 'T0': 299.0, 'qv0': 0.017, 'T_env0': 296.0, 'Gamma': 6.5e-3, 'qv_env0': 0.010, 'Lambda_q': 1000.0},\n        # Case D: Moist environment, efficient autoconversion\n        {'name': 'D', 'M0': 0.08, 'e': 1.0e-4, 'd': 0.5e-4, 'l_cond': 90.0, 'l_evap': 140.0, 'l_auto': 80.0, 'l_sed': 300.0, 'q_auto': 1.0e-4, 'T0': 302.0, 'qv0': 0.022, 'T_env0': 300.0, 'Gamma': 6.0e-3, 'qv_env0': 0.020, 'Lambda_q': 2500.0},\n    ]\n\n    results = []\n    for params in test_cases:\n        conservation_passed = run_simulation(params, CONST, z_top, N)\n        results.append(conservation_passed)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\n\ndef run_simulation(params, C, z_top, N):\n    \"\"\"\n    Runs a single simulation for a given parameter set and checks energy conservation.\n    \"\"\"\n    # --- Grid setup ---\n    z = np.linspace(0, z_top, N)\n    dz = z[1] - z[0]\n\n    # --- Initialize state arrays ---\n    M = np.zeros(N)\n    qv = np.zeros(N)\n    qc = np.zeros(N)\n    qr = np.zeros(N)\n    h = np.zeros(N)\n    T = np.zeros(N)\n    \n    # --- Environment profiles ---\n    p_env = C['p0'] * np.exp(-z / C['H'])\n    T_env = params['T_env0'] - params['Gamma'] * z\n    qv_env = params['qv_env0'] * np.exp(-z / params['Lambda_q'])\n    h_env = C['cp'] * T_env + C['g'] * z + C['Lv'] * qv_env\n    # Assume environment has no cloud or rain for hg_env\n    hg_env = h_env \n\n    # --- Initial conditions (z=0) ---\n    M[0] = params['M0']\n    T[0] = params['T0']\n    qv[0] = params['qv0']\n    qc[0] = 0.0\n    qr[0] = 0.0\n    h[0] = C['cp'] * T[0] + C['Lv'] * qv[0]\n    \n    # --- Integration loop ---\n    for i in range(N - 1):\n        # 1. Diagnose current state temperature T[i]\n        # T[i] was set at the end of the previous loop (or initialization for i=0)\n        # So we can proceed to calculate rates at i.\n\n        # 2. Saturation properties at level i\n        es_i = C['e0'] * np.exp((C['Lv'] / C['Rv']) * (1/C['T0'] - 1/T[i]))\n        qsat_i = C['eps'] * es_i / (p_env[i] - es_i)\n\n        # 3. Microphysical rates at level i (per meter)\n        rC_i = max(0, qv[i] - qsat_i) / params['l_cond']\n        rE_i = (1 if qsat_i  qv[i] else 0) * min(qsat_i - qv[i], qr[i]) / params['l_evap']\n        rA_i = max(0, qc[i] - params['q_auto']) / params['l_auto']\n        rS_i = qr[i] / params['l_sed']\n        \n        # 4. Source terms for fluxes at level i\n        S_qv_i = M[i] * (-rC_i + rE_i)\n        S_qc_i = M[i] * (rC_i - rA_i)\n        S_qr_i = M[i] * (rA_i - rE_i - rS_i)\n        S_h_i = 0.0\n\n        # 5. Flux derivatives at level i\n        e_plus_d = params['e'] + params['d']\n        dFqv_dz = e_plus_d * M[i] * (qv_env[i] - qv[i]) + S_qv_i\n        dFqc_dz = e_plus_d * M[i] * (0.0 - qc[i]) + S_qc_i\n        dFqr_dz = e_plus_d * M[i] * (0.0 - qr[i]) + S_qr_i\n        dFh_dz = e_plus_d * M[i] * (h_env[i] - h[i]) + S_h_i\n\n        # 6. Mass flux derivative at level i\n        dM_dz = (params['e'] - params['d']) * M[i]\n\n        # 7. Update to level i+1 using Forward Euler\n        M[i+1] = M[i] + dM_dz * dz\n        \n        Fqv_i1 = (M[i] * qv[i]) + dFqv_dz * dz\n        Fqc_i1 = (M[i] * qc[i]) + dFqc_dz * dz\n        Fqr_i1 = (M[i] * qr[i]) + dFqr_dz * dz\n        Fh_i1 = (M[i] * h[i]) + dFh_dz * dz\n\n        # 8. Recover scalars at i+1\n        if M[i+1]  1e-12: # Avoid division by zero\n            qv[i+1] = Fqv_i1 / M[i+1]\n            qc[i+1] = Fqc_i1 / M[i+1]\n            qr[i+1] = Fqr_i1 / M[i+1]\n            h[i+1] = Fh_i1 / M[i+1]\n        else: # If mass flux vanishes, plume dies\n            M[i+1:] = 0\n            qv[i+1:] = qv_env[i+1]\n            qc[i+1:] = 0\n            qr[i+1:] = 0\n            h[i+1:] = h_env[i+1]\n            break\n\n        # 9. Clip for non-negativity\n        qv[i+1] = max(0, qv[i+1])\n        qc[i+1] = max(0, qc[i+1])\n        qr[i+1] = max(0, qr[i+1])\n        \n        # 10. Diagnose T[i+1] for next iteration\n        T[i+1] = (h[i+1] - C['g'] * z[i+1] - C['Lv'] * qv[i+1]) / C['cp']\n    \n    # --- Conservation Check ---\n    # Need to compute rates and integrand at all levels for trapezoidal rule\n    rS = np.zeros(N)\n    for i in range(N):\n        rS[i] = qr[i] / params['l_sed']\n\n    # Generalized moist static energy\n    hg = C['cp'] * T + C['g'] * z + C['Lv'] * (qv + qc + qr)\n\n    # Left-hand side of conservation equation\n    LHS = (M[-1] * hg[-1]) - (M[0] * hg[0])\n\n    # Right-hand side of conservation equation\n    integrand = (params['e'] + params['d']) * M * (hg_env - hg) - C['Lv'] * M * rS\n    RHS = np.trapz(integrand, x=z)\n    \n    # Tolerance check\n    Delta = LHS - RHS\n    tau = 1e-6\n    delta_min = 1e-12\n    threshold = tau * max(abs(LHS) + abs(RHS), delta_min)\n    \n    return abs(Delta) = threshold\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}