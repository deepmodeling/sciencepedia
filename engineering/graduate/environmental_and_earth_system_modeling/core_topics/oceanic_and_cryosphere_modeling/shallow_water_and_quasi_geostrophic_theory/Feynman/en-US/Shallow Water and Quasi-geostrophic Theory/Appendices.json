{
    "hands_on_practices": [
        {
            "introduction": "This first practice is a foundational exercise in quasi-geostrophic (QG) theory. By linearizing the full potential vorticity (PV) expression around a state of rest, you will derive the first-order PV anomaly, $q'$. This exercise clarifies how PV anomalies arise from two fundamental physical effects: changes in relative vorticity (the \"vorticity\" part) and changes in the fluid column's depth (the \"stretching\" part), providing the essential building block for the entire QG framework .",
            "id": "4048393",
            "problem": "Consider the single-layer rotating shallow-water system relevant to geostrophic adjustment on a midlatitude $\\beta$-plane, with Coriolis parameter $f(y) = f_{0} + \\beta y$, constant mean layer depth $H$, free-surface displacement $\\eta(x,y,t)$, and horizontal velocity components $u(x,y,t)$ and $v(x,y,t)$. The relative vorticity is defined by $\\zeta(x,y,t) = \\partial v/\\partial x - \\partial u/\\partial y$. In frictionless, non-diffusive flow with no bottom topography, the materially conserved potential vorticity (PV) is given by $q(x,y,t) = \\dfrac{\\zeta(x,y,t) + f(y)}{H + \\eta(x,y,t)}$.\n\nAssume a rest reference state with $u = 0$, $v = 0$, and $\\eta = 0$, and define small perturbations $\\zeta'(x,y,t)$ and $\\eta'(x,y,t)$ about this state such that $\\zeta = \\zeta'$ and $\\eta = \\eta'$. Linearize the PV $q$ about this rest state, retaining only terms that are first order in the perturbations, and express the resulting first-order PV anomaly $q'$ solely in terms of $\\zeta'$, $\\eta'$, $H$, and $f_{0}$. Treat $f_{0}$ as the constant Coriolis parameter at the reference latitude and do not include meridional advection of $f(y)$. Your final answer must be a single closed-form analytic expression for $q'$ in terms of $\\zeta'$, $\\eta'$, $H$, and $f_{0}$.",
            "solution": "The user wants me to find the first-order approximation of the potential vorticity (PV) anomaly for a single-layer rotating shallow-water system.\n\n### Step 1: Problem Validation\n\nFirst, I will validate the problem statement.\n\n#### Step 1.1: Extract Givens\n- **System:** Single-layer rotating shallow-water system on a midlatitude $\\beta$-plane.\n- **Coriolis Parameter:** $f(y) = f_{0} + \\beta y$.\n- **Mean Layer Depth:** $H$ (constant).\n- **Free-Surface Displacement:** $\\eta(x,y,t)$.\n- **Velocity Components:** $u(x,y,t)$ and $v(x,y,t)$.\n- **Relative Vorticity:** $\\zeta(x,y,t) = \\frac{\\partial v}{\\partial x} - \\frac{\\partial u}{\\partial y}$.\n- **Potential Vorticity (PV):** $q(x,y,t) = \\dfrac{\\zeta(x,y,t) + f(y)}{H + \\eta(x,y,t)}$.\n- **Reference State:** A state of rest, defined by $u = 0$, $v = 0$, and $\\eta = 0$.\n- **Perturbations:** Small perturbations about the rest state are denoted with a prime, such that the total vorticity is $\\zeta = \\zeta'$ and the total surface displacement is $\\eta = \\eta'$.\n- **Task:** Linearize the PV $q$ about the rest state and find the expression for the first-order PV anomaly, $q'$.\n- **Constraints:** The final expression for $q'$ must be solely in terms of $\\zeta'$, $\\eta'$, $H$, and $f_{0}$. The problem also states to \"Treat $f_{0}$ as the constant Coriolis parameter at the reference latitude and do not include meridional advection of $f(y)$.\"\n\n#### Step 1.2: Validate Using Extracted Givens\nThe problem is well-defined and rooted in the fundamental principles of geophysical fluid dynamics. The model described (rotating shallow-water equations), the definition of potential vorticity, and the process of linearization are all standard concepts in this field.\n\n- **Scientific Grounding:** The problem is scientifically sound. It deals with the derivation of the linearized potential vorticity, a cornerstone of quasi-geostrophic theory.\n- **Well-Posedness and Consistency:** The problem appears to have a minor internal contradiction at first glance: it is set on a $\\beta$-plane (where $f$ varies with latitude $y$), but asks for a final answer independent of $\\beta$ and $y$. However, this is not a\nflaw. In the standard derivation of quasi-geostrophic PV, one approximates the Coriolis parameter $f(y)$ as $f_0$ in terms that are already of first order in the perturbation fields (like the \"stretching\" term containing $\\eta$). The variation of $f$ with $y$ (the $\\beta$-effect) is retained in the background PV gradient, which governs wave dynamics, but the problem only asks for the expression for the PV anomaly itself, not its evolution equation. The problem's constraints guide the user to make this specific, standard approximation. Therefore, the problem is well-posed and internally consistent under this standard interpretation.\n- **Objectivity & Clarity:** The problem uses precise, objective scientific language and defines all terms clearly.\n\n#### Step 1.3: Verdict and Action\nThe problem is deemed **valid**. I will proceed with deriving the solution.\n\n### Step 2: Derivation of the Solution\n\nThe potential vorticity (PV) for the shallow-water system is given by:\n$$q(x,y,t) = \\frac{\\zeta(x,y,t) + f(y)}{H + \\eta(x,y,t)}$$\nWith the Coriolis parameter on a $\\beta$-plane being $f(y) = f_{0} + \\beta y$.\n\nThe system is analyzed around a reference state of rest, where $\\bar{u}=0$, $\\bar{v}=0$, and $\\bar{\\eta}=0$. This implies the reference relative vorticity is also zero, $\\bar{\\zeta}=0$. The PV of this reference state, denoted $\\bar{q}$, is a function of latitude $y$:\n$$\\bar{q}(y) = \\frac{\\bar{\\zeta} + f(y)}{H + \\bar{\\eta}} = \\frac{0 + f_{0} + \\beta y}{H} = \\frac{f_{0} + \\beta y}{H}$$\n\nThe total PV, $q$, can be decomposed into the sum of the background PV and a perturbation PV (anomaly), $q'$:\n$$q(x,y,t) = \\bar{q}(y) + q'(x,y,t)$$\nThe PV anomaly is thus $q' = q - \\bar{q}$. Given that the perturbations are defined such that $\\zeta = \\zeta'$ and $\\eta = \\eta'$, we can write the expression for $q'$:\n$$q' = \\frac{\\zeta' + f(y)}{H + \\eta'} - \\frac{f(y)}{H}$$\nSubstituting $f(y) = f_0 + \\beta y$:\n$$q' = \\frac{\\zeta' + f_{0} + \\beta y}{H + \\eta'} - \\frac{f_{0} + \\beta y}{H}$$\nTo combine the terms, we find a common denominator:\n$$q' = \\frac{H(\\zeta' + f_{0} + \\beta y) - (H + \\eta')(f_{0} + \\beta y)}{H(H + \\eta')}$$\nExpanding the numerator:\n$$q' = \\frac{H\\zeta' + H(f_{0} + \\beta y) - H(f_{0} + \\beta y) - \\eta'(f_{0} + \\beta y)}{H(H + \\eta')}$$\nSimplifying the numerator gives the exact expression for the PV anomaly:\n$$q' = \\frac{H\\zeta' - (f_{0} + \\beta y)\\eta'}{H^2 + H\\eta'}$$\n\nThe next step is to linearize this expression by retaining only terms that are first order in the small perturbations $\\zeta'$ and $\\eta'$. We can rewrite the denominator and use the Taylor expansion $(1+x)^{-1} \\approx 1-x$ for small $x = \\eta'/H$:\n$$q' = \\frac{H\\zeta' - (f_{0} + \\beta y)\\eta'}{H^2(1 + \\eta'/H)} \\approx \\left(\\frac{\\zeta'}{H} - \\frac{(f_{0} + \\beta y)\\eta'}{H^2}\\right) \\left(1 - \\frac{\\eta'}{H}\\right)$$\nExpanding the product:\n$$q' \\approx \\frac{\\zeta'}{H} - \\frac{\\zeta'\\eta'}{H^2} - \\frac{(f_{0} + \\beta y)\\eta'}{H^2} + \\frac{(f_{0} + \\beta y)(\\eta')^2}{H^3}$$\nWe discard terms that are second order or higher in the perturbations. The terms $\\frac{\\zeta'\\eta'}{H^2}$ and $\\frac{(f_{0} + \\beta y)(\\eta')^2}{H^3}$ are second order and are neglected. The linearized PV anomaly is therefore:\n$$q' \\approx \\frac{\\zeta'}{H} - \\frac{(f_{0} + \\beta y)\\eta'}{H^2}$$\n\nFinally, we must apply the constraint that the final expression for $q'$ depends only on $\\zeta'$, $\\eta'$, $H$, and $f_{0}$. This requires us to handle the term $(f_{0} + \\beta y)\\eta'$. This term can be written as $f_0 \\eta' + \\beta y \\eta'$. In quasi-geostrophic scaling, the term $\\beta y \\eta'$ is considered a higher-order correction compared to $f_0 \\eta'$, because the ratio $\\beta y/f_0$ is typically small for the length scales of interest. Therefore, a standard and consistent approximation within this framework is to replace $f(y) = f_0 + \\beta y$ with just $f_0$ in terms that are already multiplied by a first-order perturbation like $\\eta'$. This is precisely what the problem statement guides us to do.\n\nApplying this approximation, $(f_0 + \\beta y)\\eta' \\approx f_0 \\eta'$, we get the final expression for the first-order PV anomaly:\n$$q' = \\frac{\\zeta'}{H} - \\frac{f_{0}\\eta'}{H^2}$$\nThis result satisfies all conditions of the problem. It represents the linearized form of the shallow-water PV anomaly under the quasi-geostrophic approximation.",
            "answer": "$$\\boxed{\\frac{\\zeta'}{H} - \\frac{f_{0} \\eta'}{H^{2}}}$$"
        },
        {
            "introduction": "Building upon the single-layer case, this problem explores the vertical structure of quasi-geostrophic flows using a two-layer model. You will decompose the flow into its barotropic (depth-averaged) and baroclinic (vertically-sheared) components, a crucial concept for understanding how energy is distributed and transported in the atmosphere and ocean. This practice  reinforces the relationship between stratification, layer thickness, and the baroclinic deformation radius, a key length scale governing geostrophic adjustment and instability.",
            "id": "4047766",
            "problem": "Consider a two-layer quasi-geostrophic (QG) model on a beta-plane for large-scale atmospheric flow, under the Boussinesq approximation, hydrostatic balance, and geostrophic balance. Let the upper and lower layer mean thicknesses be $H_{1}$ and $H_{2}$, respectively, with a single internal interface displacement $\\eta(x,y,t)$ such that thickness anomalies satisfy $h_{1}' = -\\eta$ and $h_{2}' = \\eta$. The Coriolis parameter is $f = f_{0} + \\beta y$, where $f_{0}$ is a constant and $\\beta$ is the meridional gradient. Reduced gravity is defined by $g' = g\\,(\\rho_{2} - \\rho_{1})/\\rho_{0}$, where $g$ is gravitational acceleration, $\\rho_{1}$ and $\\rho_{2}$ are the layer densities, and $\\rho_{0}$ is a constant reference density. The geostrophic streamfunction in each layer is $\\psi_{j}(x,y,t)$, with horizontal velocity given by $\\boldsymbol{u}_{j} = \\left(-\\partial \\psi_{j}/\\partial y,\\,\\partial \\psi_{j}/\\partial x\\right)$ for $j \\in \\{1,2\\}$.\n\nStarting only from the fundamental balances and the conservation of potential vorticity in layered shallow-water systems, and using pressure continuity and hydrostatic-geostrophic coupling across the internal interface, derive the barotropic and baroclinic components of the QG potential vorticity in terms of the barotropic and baroclinic mode streamfunctions. Define the barotropic mode streamfunction by the mass-weighted average $ \\psi_{B} = \\dfrac{H_{1}\\,\\psi_{1} + H_{2}\\,\\psi_{2}}{H_{1}+H_{2}} $ and the baroclinic mode streamfunction by $ \\psi_{C} = \\psi_{1} - \\psi_{2} $. From the stratification and layer thicknesses, determine the baroclinic deformation radius $L_{D}$.\n\nThen, evaluate the barotropic and baroclinic QG potential vorticity anomalies and $L_{D}$ numerically for the following parameter set and streamfunctions:\n- $f_{0} = 1.0 \\times 10^{-4}\\ \\mathrm{s}^{-1}$, $\\beta = 1.6 \\times 10^{-11}\\ \\mathrm{m}^{-1}\\ \\mathrm{s}^{-1}$,\n- $H_{1} = 500\\ \\mathrm{m}$, $H_{2} = 3500\\ \\mathrm{m}$,\n- $g' = 0.02\\ \\mathrm{m}\\ \\mathrm{s}^{-2}$,\n- $\\psi_{1}(x,y) = A_{1}\\,\\cos(k x)\\,\\cos(l y)$ with $A_{1} = 1.0 \\times 10^{4}\\ \\mathrm{m}^{2}\\ \\mathrm{s}^{-1}$,\n- $\\psi_{2}(x,y) = A_{2}\\,\\cos(k x)\\,\\cos(l y)$ with $A_{2} = 0.50 \\times 10^{4}\\ \\mathrm{m}^{2}\\ \\mathrm{s}^{-1}$,\n- $k = \\dfrac{2\\pi}{10^{6}\\ \\mathrm{m}}$, $l = \\dfrac{2\\pi}{2 \\times 10^{6}\\ \\mathrm{m}}$.\n\nCompute the barotropic and baroclinic QG potential vorticity anomalies at the point $(x,y) = (0,0)$, and compute $L_{D}$ from the given stratification and thicknesses. Express the potential vorticity anomalies in $\\mathrm{s}^{-1}$ and express $L_{D}$ in $\\mathrm{km}$. Round your final reported values to four significant figures. Your final answer must be a single row vector containing the barotropic QG potential vorticity anomaly, the baroclinic QG potential vorticity anomaly, and $L_{D}$ in that order.",
            "solution": "The user wants me to solve a problem in geophysical fluid dynamics.\n\n**1. Problem Validation**\n\nFirst, I must validate the problem statement.\n\n**Step 1: Extract Givens**\n- **Model:** Two-layer quasi-geostrophic (QG) model on a beta-plane, Boussinesq approximation, hydrostatic balance, geostrophic balance.\n- **Layers:** Upper layer thickness $H_{1}$, lower layer thickness $H_{2}$.\n- **Interface:** Displacement $\\eta(x,y,t)$; thickness anomalies $h_{1}' = -\\eta$ and $h_{2}' = \\eta$.\n- **Coriolis:** $f = f_{0} + \\beta y$, with constant $f_{0}$ and $\\beta$.\n- **Gravity:** Reduced gravity $g' = g\\,(\\rho_{2} - \\rho_{1})/\\rho_{0}$.\n- **Kinematics:** Geostrophic streamfunction $\\psi_{j}$, horizontal velocity $\\boldsymbol{u}_{j} = \\left(-\\partial \\psi_{j}/\\partial y,\\,\\partial \\psi_{j}/\\partial x\\right)$ for $j \\in \\{1,2\\}$.\n- **Mode Definitions:**\n  - Barotropic streamfunction: $ \\psi_{B} = \\dfrac{H_{1}\\,\\psi_{1} + H_{2}\\,\\psi_{2}}{H_{1}+H_{2}} $\n  - Baroclinic streamfunction: $ \\psi_{C} = \\psi_{1} - \\psi_{2} $\n- **Numerical Parameters:**\n  - $f_{0} = 1.0 \\times 10^{-4}\\ \\mathrm{s}^{-1}$\n  - $\\beta = 1.6 \\times 10^{-11}\\ \\mathrm{m}^{-1}\\ \\mathrm{s}^{-1}$\n  - $H_{1} = 500\\ \\mathrm{m}$\n  - $H_{2} = 3500\\ \\mathrm{m}$\n  - $g' = 0.02\\ \\mathrm{m}\\ \\mathrm{s}^{-2}$\n  - $\\psi_{1}(x,y) = A_{1}\\,\\cos(k x)\\,\\cos(l y)$ with $A_{1} = 1.0 \\times 10^{4}\\ \\mathrm{m}^{2}\\ \\mathrm{s}^{-1}$\n  - $\\psi_{2}(x,y) = A_{2}\\,\\cos(k x)\\,\\cos(l y)$ with $A_{2} = 0.50 \\times 10^{4}\\ \\mathrm{m}^{2}\\ \\mathrm{s}^{-1}$\n  - $k = \\dfrac{2\\pi}{10^{6}\\ \\mathrm{m}}$\n  - $l = \\dfrac{2\\pi}{2 \\times 10^{6}\\ \\mathrm{m}}$\n- **Evaluation Point:** $(x,y) = (0,0)$.\n- **Required Outputs:** Barotropic QG potential vorticity anomaly at $(0,0)$, baroclinic QG potential vorticity anomaly at $(0,0)$, and $L_{D}$. Values to be rounded to four significant figures, PV in $\\mathrm{s}^{-1}$, $L_D$ in $\\mathrm{km}$.\n\n**Step 2: Validate Using Extracted Givens**\n- **Scientifically Grounded:** The problem is a standard exercise in the theory of quasi-geostrophic dynamics, a fundamental framework in meteorology and oceanography. All concepts and equations are well-established.\n- **Well-Posed:** The problem provides a complete set of definitions, equations, and parameters required for the derivation and subsequent calculation. The objectives are clearly stated. A unique solution exists.\n- **Objective:** The language is formal, precise, and free from any subjectivity.\n- **Flaw Checklist:** The problem does not violate any of the invalidity criteria. It is scientifically sound, formalizable, complete, realistic, well-posed, non-trivial, and verifiable.\n\n**Step 3: Verdict and Action**\nThe problem is valid. I will proceed with a full derivation and solution.\n\n**2. Derivation of QG Potential Vorticity (PV)**\n\nThe conservation of potential vorticity for a single layer $j$ in a shallow water system is given by:\n$$\n\\frac{D_{j}}{Dt}\\left(\\frac{\\zeta_{j} + f}{h_{j}}\\right) = 0\n$$\nwhere $\\zeta_{j} = \\nabla^2\\psi_{j}$ is the relative vorticity and $h_{j}$ is the layer thickness. For the QG approximation, we assume small perturbations about a state of rest. The layer thickness is $h_{j} = H_{j} + h_{j}'$, where $H_{j}$ is the large mean thickness and $|h_{j}'| \\ll H_{j}$. The relative vorticity is also assumed small, $|\\zeta_{j}| \\ll f_{0}$. The PV expression is linearized:\n$$\n\\frac{\\zeta_{j} + f}{H_{j} + h_{j}'} = \\frac{\\zeta_{j} + f_0 + \\beta y}{H_{j}}\\left(1 + \\frac{h_{j}'}{H_{j}}\\right)^{-1} \\approx \\frac{1}{H_{j}}\\left(\\zeta_{j} + f_0 + \\beta y\\right)\\left(1 - \\frac{h_{j}'}{H_{j}}\\right) \\approx \\frac{1}{H_{j}}\\left(\\zeta_{j} + f_0 + \\beta y - f_0 \\frac{h_{j}'}{H_{j}}\\right)\n$$\nThe QG potential vorticity is defined as $q_{j} = \\zeta_{j} + f + \\frac{f_{0}}{H_{j}}h_{j}'$. The conservation law under the QG approximation, where advection is by the geostrophic wind, becomes $(\\frac{\\partial}{\\partial t} + \\boldsymbol{u}_{j} \\cdot \\nabla)q_{j} = 0$.\n\nNext, we must relate the thickness perturbations $h_{j}'$ to the streamfunctions. The problem states $h_{1}' = -\\eta$ and $h_{2}' = \\eta$. The interface displacement $\\eta$ is related to the pressure fields. Under the Boussinesq approximation, the geostrophic relation is $\\boldsymbol{u}_{j} = \\frac{1}{\\rho_{0}f_{0}}\\hat{\\boldsymbol{k}}\\times\\nabla p_{j}$, which implies $\\psi_{j} = p_{j}/(\\rho_{0}f_{0})$. The hydrostatic balance across the interface at $z=\\eta$ implies that the pressure difference between the two layers is related to the reduced gravity $g'$.\n$$\np_{2} - p_{1} = \\rho_{0}g'\\eta\n$$\nTaking the horizontal gradient and substituting the geostrophic relationship for pressure:\n$$\n\\nabla p_{2} - \\nabla p_{1} = \\rho_{0}g'\\nabla\\eta\n$$\n$$\n\\rho_{0}f_{0}(\\hat{\\boldsymbol{k}}\\times\\boldsymbol{u}_{2} - \\hat{\\boldsymbol{k}}\\times\\boldsymbol{u}_{1}) = \\rho_{0}g'\\nabla\\eta\n$$\nSubstituting $\\boldsymbol{u}_{j} = \\hat{\\boldsymbol{k}}\\times\\nabla\\psi_{j}$ and using the vector identity $\\hat{\\boldsymbol{k}}\\times(\\hat{\\boldsymbol{k}}\\times\\boldsymbol{A}) = -\\boldsymbol{A}$:\n$$\nf_{0}(-\\nabla\\psi_{2} - (-\\nabla\\psi_{1})) = g'\\nabla\\eta\n$$\n$$\nf_{0}\\nabla(\\psi_{1} - \\psi_{2}) = g'\\nabla\\eta\n$$\nIntegrating yields $f_{0}(\\psi_{1} - \\psi_{2}) = g'\\eta$, where any spatially-uniform integration constant can be absorbed into the definition of the streamfunctions. Thus, the interface displacement is:\n$$\n\\eta = \\frac{f_{0}}{g'}(\\psi_{1} - \\psi_{2})\n$$\nWe substitute this into the QG PV expressions for each layer:\n$$\nq_{1} = \\nabla^2\\psi_{1} + f - \\frac{f_{0}}{H_{1}}\\frac{f_{0}}{g'}(\\psi_{1} - \\psi_{2}) = \\nabla^2\\psi_{1} + f - \\frac{f_{0}^{2}}{g'H_{1}}(\\psi_{1} - \\psi_{2})\n$$\n$$\nq_{2} = \\nabla^2\\psi_{2} + f + \\frac{f_{0}}{H_{2}}\\frac{f_{0}}{g'}(\\psi_{1} - \\psi_{2}) = \\nabla^2\\psi_{2} + f + \\frac{f_{0}^{2}}{g'H_{2}}(\\psi_{1} - \\psi_{2})\n$$\n\n**3. Barotropic and Baroclinic Modes**\n\nThe barotropic and baroclinic modes are formed by linear combinations of the layer variables. Let $H = H_{1} + H_{2}$.\nThe barotropic PV is the mass-weighted average of the layer PVs:\n$$\nq_{B} = \\frac{H_{1}q_{1} + H_{2}q_{2}}{H} = \\frac{1}{H} \\left[ H_{1}\\left(\\nabla^2\\psi_{1} + f - \\frac{f_{0}^{2}}{g'H_{1}}\\psi_{C}\\right) + H_{2}\\left(\\nabla^2\\psi_{2} + f + \\frac{f_{0}^{2}}{g'H_{2}}\\psi_{C}\\right) \\right]\n$$\nwhere $\\psi_{C} = \\psi_{1} - \\psi_{2}$ is the baroclinic streamfunction.\n$$\nq_{B} = \\frac{1}{H}\\left[\\nabla^2(H_{1}\\psi_{1} + H_{2}\\psi_{2}) + (H_{1}+H_{2})f - \\frac{f_{0}^{2}}{g'}\\psi_{C} + \\frac{f_{0}^{2}}{g'}\\psi_{C} \\right] = \\nabla^2\\left(\\frac{H_{1}\\psi_{1} + H_{2}\\psi_{2}}{H}\\right) + f\n$$\nUsing the definition of the barotropic streamfunction $\\psi_{B} = (H_{1}\\psi_{1} + H_{2}\\psi_{2})/H$, we obtain:\n$$\nq_{B} = \\nabla^2\\psi_{B} + f\n$$\nThe baroclinic PV is the difference between the layer PVs:\n$$\nq_{C} = q_{1} - q_{2} = \\left(\\nabla^2\\psi_{1} + f - \\frac{f_{0}^{2}}{g'H_{1}}\\psi_{C}\\right) - \\left(\\nabla^2\\psi_{2} + f + \\frac{f_{0}^{2}}{g'H_{2}}\\psi_{C}\\right)\n$$\n$$\nq_{C} = \\nabla^2(\\psi_{1} - \\psi_{2}) - \\left(\\frac{f_{0}^{2}}{g'H_{1}} + \\frac{f_{0}^{2}}{g'H_{2}}\\right)(\\psi_{1} - \\psi_{2})\n$$\n$$\nq_{C} = \\nabla^2\\psi_{C} - \\frac{f_{0}^{2}}{g'}\\left(\\frac{H_{1}+H_{2}}{H_{1}H_{2}}\\right)\\psi_{C}\n$$\nThis expression defines the baroclinic deformation radius, $L_{D}$, such that $L_{D}^{-2} = \\frac{f_{0}^{2}(H_{1}+H_{2})}{g'H_{1}H_{2}}$.\n$$\nq_{C} = \\nabla^2\\psi_{C} - \\frac{1}{L_{D}^{2}}\\psi_{C}\n$$\nThe QG potential vorticity anomalies are the parts of $q_B$ and $q_C$ that depend on the streamfunctions:\nBarotropic anomaly: $q'_{B} = \\nabla^2\\psi_{B}$.\nBaroclinic anomaly: $q'_{C} = \\nabla^2\\psi_{C} - \\frac{1}{L_{D}^{2}}\\psi_{C}$.\n\n**4. Numerical Evaluation**\n\n**4.1. Baroclinic Deformation Radius, $L_{D}$**\nFirst, we calculate $L_{D}$ from its definition:\n$$\nL_{D}^{2} = \\frac{g'H_{1}H_{2}}{f_{0}^{2}(H_{1}+H_{2})} = \\frac{(0.02\\ \\mathrm{m}\\ \\mathrm{s}^{-2})(500\\ \\mathrm{m})(3500\\ \\mathrm{m})}{(1.0 \\times 10^{-4}\\ \\mathrm{s}^{-1})^{2}(500\\ \\mathrm{m} + 3500\\ \\mathrm{m})}\n$$\n$$\nL_{D}^{2} = \\frac{35000\\ \\mathrm{m}^{3}\\ \\mathrm{s}^{-2}}{(1.0 \\times 10^{-8}\\ \\mathrm{s}^{-2})(4000\\ \\mathrm{m})} = \\frac{35000}{4.0 \\times 10^{-5}}\\ \\mathrm{m}^{2} = 8.75 \\times 10^{8}\\ \\mathrm{m}^{2}\n$$\n$$\nL_{D} = \\sqrt{8.75 \\times 10^{8}}\\ \\mathrm{m} \\approx 29580.4\\ \\mathrm{m}\n$$\nConverting to kilometers and rounding to four significant figures:\n$$\nL_{D} \\approx 29.58\\ \\mathrm{km}\n$$\n\n**4.2. Streamfunction Modes and Their Laplacians**\nThe streamfunctions are $\\psi_{1}(x,y) = A_{1}\\cos(kx)\\cos(ly)$ and $\\psi_{2}(x,y) = A_{2}\\cos(kx)\\cos(ly)$.\nLet $C(x,y) = \\cos(kx)\\cos(ly)$.\nThe barotropic streamfunction is $\\psi_{B} = A_{B}C(x,y)$, where:\n$$\nA_{B} = \\frac{H_{1}A_{1} + H_{2}A_{2}}{H_{1} + H_{2}} = \\frac{(500)(1.0 \\times 10^{4}) + (3500)(0.5 \\times 10^{4})}{4000} = \\frac{5.0 \\times 10^{6} + 1.75 \\times 10^{7}}{4000} = \\frac{2.25 \\times 10^{7}}{4000}\n$$\n$$\nA_{B} = 5625\\ \\mathrm{m}^{2}\\ \\mathrm{s}^{-1} = 5.625 \\times 10^{3}\\ \\mathrm{m}^{2}\\ \\mathrm{s}^{-1}\n$$\nThe baroclinic streamfunction is $\\psi_{C} = A_{C}C(x,y)$, where:\n$$\nA_{C} = A_{1} - A_{2} = 1.0 \\times 10^{4} - 0.5 \\times 10^{4} = 0.5 \\times 10^{4}\\ \\mathrm{m}^{2}\\ \\mathrm{s}^{-1}\n$$\nThe Laplacian of a function $\\psi(x,y) = A \\cos(kx)\\cos(ly)$ is:\n$$\n\\nabla^2\\psi = \\frac{\\partial^2 \\psi}{\\partial x^2} + \\frac{\\partial^2 \\psi}{\\partial y^2} = -k^{2}A\\cos(kx)\\cos(ly) - l^{2}A\\cos(kx)\\cos(ly) = -(k^{2}+l^{2})\\psi\n$$\nWe need to evaluate the PV anomalies at $(x,y)=(0,0)$, where $C(0,0)=1$, so $\\psi(0,0)=A$ and $\\nabla^2\\psi(0,0) = -(k^2+l^2)A$.\nLet's compute $k^2+l^2$:\n$$\nk = \\frac{2\\pi}{10^{6}}\\ \\mathrm{m}^{-1}, \\quad l = \\frac{2\\pi}{2 \\times 10^{6}} = \\frac{\\pi}{10^{6}}\\ \\mathrm{m}^{-1}\n$$\n$$\nk^{2}+l^{2} = \\left(\\frac{2\\pi}{10^{6}}\\right)^{2} + \\left(\\frac{\\pi}{10^{6}}\\right)^{2} = \\frac{4\\pi^{2}}{10^{12}} + \\frac{\\pi^{2}}{10^{12}} = \\frac{5\\pi^{2}}{10^{12}}\\ \\mathrm{m}^{-2} \\approx 4.9348 \\times 10^{-11}\\ \\mathrm{m}^{-2}\n$$\n\n**4.3. PV Anomaly Values**\nThe barotropic PV anomaly at $(0,0)$ is:\n$$\nq'_{B}(0,0) = \\nabla^2\\psi_{B}|_{(0,0)} = -(k^{2}+l^{2})A_{B} \\approx -(4.9348 \\times 10^{-11}\\ \\mathrm{m}^{-2})(5.625 \\times 10^{3}\\ \\mathrm{m}^{2}\\ \\mathrm{s}^{-1})\n$$\n$$\nq'_{B}(0,0) \\approx -2.7758 \\times 10^{-7}\\ \\mathrm{s}^{-1}\n$$\nRounding to four significant figures, $q'_{B}(0,0) = -2.776 \\times 10^{-7}\\ \\mathrm{s}^{-1}$.\n\nThe baroclinic PV anomaly at $(0,0)$ is:\n$$\nq'_{C}(0,0) = (\\nabla^2\\psi_{C} - \\frac{1}{L_{D}^{2}}\\psi_{C})|_{(0,0)} = -(k^{2}+l^{2} + \\frac{1}{L_{D}^{2}})A_{C}\n$$\nWe have $1/L_{D}^{2} = 1/(8.75 \\times 10^{8}\\ \\mathrm{m}^{2}) \\approx 1.14286 \\times 10^{-9}\\ \\mathrm{m}^{-2}$.\n$$\nk^{2}+l^{2} + \\frac{1}{L_{D}^{2}} \\approx 4.9348 \\times 10^{-11}\\ \\mathrm{m}^{-2} + 1.14286 \\times 10^{-9}\\ \\mathrm{m}^{-2} = (0.049348 + 1.14286) \\times 10^{-9}\\ \\mathrm{m}^{-2} \\approx 1.19221 \\times 10^{-9}\\ \\mathrm{m}^{-2}\n$$\n$$\nq'_{C}(0,0) \\approx -(1.19221 \\times 10^{-9}\\ \\mathrm{m}^{-2})(0.5 \\times 10^{4}\\ \\mathrm{m}^{2}\\ \\mathrm{s}^{-1})\n$$\n$$\nq'_{C}(0,0) \\approx -0.596105 \\times 10^{-5}\\ \\mathrm{s}^{-1} = -5.96105 \\times 10^{-6}\\ \\mathrm{s}^{-1}\n$$\nRounding to four significant figures, $q'_{C}(0,0) = -5.961 \\times 10^{-6}\\ \\mathrm{s}^{-1}$.\n\nThe final results are:\n- Barotropic PV anomaly: $-2.776 \\times 10^{-7}\\ \\mathrm{s}^{-1}$\n- Baroclinic PV anomaly: $-5.961 \\times 10^{-6}\\ \\mathrm{s}^{-1}$\n- Baroclinic deformation radius: $29.58\\ \\mathrm{km}$",
            "answer": "$$\n\\boxed{\\begin{pmatrix} -2.776 \\times 10^{-7} & -5.961 \\times 10^{-6} & 29.58 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "This practice moves from analytical derivation to computational application, illustrating one of the most powerful concepts in geophysical fluid dynamics: the \"invertibility principle.\" You will develop an algorithm to solve for the streamfunction—and thus the entire velocity and pressure field—from a given distribution of the QG potential vorticity anomaly. By implementing a spectral solver using the Fast Fourier Transform (FFT), you will gain hands-on experience with a standard numerical technique used in modern atmospheric and oceanic models .",
            "id": "3911751",
            "problem": "Consider a one-layer Quasi-Geostrophic (QG) flow on a doubly periodic square domain with side length $L_x = L_y = 2\\pi$. The fundamental base consists of the rotating shallow water equations under small Rossby number scaling, geostrophic balance between the Coriolis force and the pressure gradient, and the definition of Potential Vorticity (PV) as the ratio of absolute vorticity to the layer thickness. Under QG scaling, the geostrophic velocity is represented by a streamfunction $\\psi(x,y)$ via $\\mathbf{u}_g = (-\\partial \\psi/\\partial y, \\partial \\psi/\\partial x)$, and the QG PV anomaly $q'(x,y)$ is a linear function of $\\psi(x,y)$ involving spatial derivatives up to second order. On a doubly periodic domain, inversion from $q'(x,y)$ to $\\psi(x,y)$ is well-posed when the governing linear operator is invertible on the function space of periodic functions.\n\nYour task is to:\n1. Starting from the rotating shallow water momentum and continuity equations, the geostrophic balance $f_0 \\hat{\\mathbf{z}} \\times \\mathbf{u}_g = -g' \\nabla \\eta$, the definition of PV $Q = (\\zeta + f_0)/h$, and the small-amplitude free surface displacement $\\eta$ related to $\\psi$ through mass conservation, derive the QG PV anomaly in the one-layer case as a linear operator applied to $\\psi(x,y)$. Show that the inversion problem for $\\psi(x,y)$ given $q'(x,y)$ reduces to solving a constant-coefficient elliptic partial differential equation of the form\n$$\n\\left(\\nabla^2 - \\frac{1}{L_d^2}\\right)\\psi(x,y) = q'(x,y),\n$$\nwhere $L_d$ is the Rossby deformation radius, and $\\nabla^2$ is the two-dimensional Laplacian. State the conditions under which the operator is invertible on a doubly periodic domain, and discuss the special case when $L_d \\to \\infty$ (the barotropic limit), for which the equation reduces to the Poisson equation $\\nabla^2 \\psi(x,y) = q'(x,y)$ and compatibility requires that the spatial mean of $q'(x,y)$ vanishes.\n\n2. Devise an algorithm to invert $q'(x,y)$ to obtain $\\psi(x,y)$ in a doubly periodic domain by using the Discrete Fourier Transform (DFT), also known as the Fast Fourier Transform (FFT). Explicitly derive the spectral-space algebraic relationship that allows solving for the Fourier coefficients of $\\psi$ from those of $q'$, taking care of the zero-wavenumber mode in the Poisson case. Then describe how to reconstruct $\\psi(x,y)$, and how to validate the inversion by reconstructing the PV anomaly $q'_{\\text{rec}}(x,y)$ from $\\psi(x,y)$ and comparing it to the original $q'(x,y)$.\n\n3. Implement the algorithm in a program that uses $N_x = N_y = 64$ grid points, $L_x = L_y = 2\\pi$, and the following test suite of PV anomalies and deformation radii:\n   - Test case A (happy path): $L_d = 1.0$ and\n     $$\n     q'_A(x,y) = \\cos(x) + \\cos(y).\n     $$\n   - Test case B (barotropic limit, zero-mean anomaly): $L_d \\to \\infty$ and\n     $$\n     q'_B(x,y) = \\sin(2x) + \\sin(3y).\n     $$\n     Here the algorithm must treat the zero-wavenumber mode consistently with the compatibility condition.\n   - Test case C (zero-wavenumber inversion in Helmholtz case): $L_d = 0.5$ and\n     $$\n     q'_C(x,y) = 2.0,\n     $$\n     a spatially uniform anomaly.\n\nFor each test case, compute the geostrophic streamfunction $\\psi(x,y)$, reconstruct the PV anomaly\n$$\nq'_{\\text{rec}}(x,y) = \\nabla^2 \\psi(x,y) - \\frac{\\psi(x,y)}{L_d^2}\n$$\nfor finite $L_d$, and $q'_{\\text{rec}}(x,y) = \\nabla^2 \\psi(x,y)$ in the barotropic limit, and report the maximum absolute difference \n$$\nE = \\max_{x,y} \\left| q'_{\\text{rec}}(x,y) - q'(x,y) \\right|\n$$\nas a floating-point number.\n\nAll quantities are non-dimensional, so no physical units are required. Your program should produce a single line of output containing the results for the three test cases as a comma-separated list enclosed in square brackets (e.g., $[E_A,E_B,E_C]$).",
            "solution": "The comprehensive solution is presented in three parts: first, the derivation of the governing partial differential equation from fundamental principles; second, the design of a spectral algorithm for its solution; and third, the implementation details for the numerical test cases.\n\n### Part 1: Derivation of the Quasi-Geostrophic Potential Vorticity Equation\n\nWe begin with the rotating shallow water equations for a single layer of fluid with constant density, under the assumptions of the quasi-geostrophic (QG) approximation. The momentum and continuity equations are:\n$$\n\\frac{D\\mathbf{u}}{Dt} + f_0 \\hat{\\mathbf{z}} \\times \\mathbf{u} = -g' \\nabla \\eta\n$$\n$$\n\\frac{D h}{Dt} + h (\\nabla \\cdot \\mathbf{u}) = 0\n$$\nwhere $\\mathbf{u}$ is the horizontal velocity vector, $f_0$ is the constant Coriolis parameter, $\\hat{\\mathbf{z}}$ is the unit vector in the vertical direction, $g'$ is the reduced gravity, $\\eta$ is the free surface displacement from the mean height $H$, and $h = H + \\eta$ is the total fluid depth.\n\nUnder the QG approximation, the Rossby number is small, implying that the flow is in geostrophic balance at leading order. This balance is between the Coriolis force and the pressure gradient:\n$$\nf_0 \\hat{\\mathbf{z}} \\times \\mathbf{u}_g = -g' \\nabla \\eta\n$$\nwhere $\\mathbf{u}_g$ is the geostrophic velocity. We introduce a streamfunction $\\psi(x,y)$ such that $\\mathbf{u}_g = (-\\partial \\psi/\\partial y, \\partial \\psi/\\partial x)$. Substituting this into the geostrophic balance gives:\n$$\nf_0 \\hat{\\mathbf{z}} \\times \\left(-\\frac{\\partial \\psi}{\\partial y}, \\frac{\\partial \\psi}{\\partial x}\\right) = \\left(f_0 \\frac{\\partial \\psi}{\\partial x}, f_0 \\frac{\\partial \\psi}{\\partial y}\\right) = f_0 \\nabla \\psi\n$$\nComparing this with $-g' \\nabla \\eta$, we find $f_0 \\nabla \\psi = g' \\nabla \\eta$. Integrating yields the relation between the streamfunction and the free surface displacement:\n$$\n\\eta = \\frac{f_0}{g'} \\psi\n$$\nwhere any integration constant can be absorbed into the definition of $\\psi$.\n\nNext, we consider the potential vorticity (PV), defined as $Q = (\\zeta + f_0)/h$, where $\\zeta = \\hat{\\mathbf{z}} \\cdot (\\nabla \\times \\mathbf{u})$ is the relative vorticity. In the QG framework, $\\zeta$ is approximated by the geostrophic vorticity, $\\zeta_g = \\nabla \\times \\mathbf{u}_g = \\nabla^2 \\psi$. The fluid depth is $h = H + \\eta$. For small-amplitude displacements, $\\eta \\ll H$, we can linearize the PV expression:\n$$\nQ = \\frac{\\zeta_g + f_0}{H + \\eta} = \\frac{f_0(1 + \\zeta_g/f_0)}{H(1 + \\eta/H)} \\approx \\frac{f_0}{H} (1 + \\frac{\\zeta_g}{f_0}) (1 - \\frac{\\eta}{H}) \\approx \\frac{f_0}{H} \\left(1 + \\frac{\\zeta_g}{f_0} - \\frac{\\eta}{H}\\right)\n$$\nThe mean PV is $Q_0 = f_0/H$. The PV anomaly, $Q' = Q - Q_0$, is therefore:\n$$\nQ' \\approx \\frac{f_0}{H} \\left(\\frac{\\zeta_g}{f_0} - \\frac{\\eta}{H}\\right) = \\frac{\\zeta_g}{H} - \\frac{f_0 \\eta}{H^2}\n$$\nThe QG potential vorticity anomaly, typically denoted $q'$, is defined as $q' = H Q'$:\n$$\nq' = \\zeta_g - \\frac{f_0}{H} \\eta\n$$\nSubstituting $\\zeta_g = \\nabla^2 \\psi$ and $\\eta = (f_0/g') \\psi$:\n$$\nq'(x,y) = \\nabla^2 \\psi(x,y) - \\frac{f_0^2}{g'H} \\psi(x,y)\n$$\nWe identify the term $(f_0^2 / (g'H))^{-1/2}$ as the internal Rossby radius of deformation, $L_d = \\sqrt{g'H}/f_0$. The equation relating the QG PV anomaly $q'$ to the streamfunction $\\psi$ is thus a Helmholtz equation:\n$$\n\\left(\\nabla^2 - \\frac{1}{L_d^2}\\right)\\psi(x,y) = q'(x,y)\n$$\nThis equation represents the \"invertibility principle\" in QG theory: given the distribution of PV anomaly $q'$, one can find the corresponding streamfunction $\\psi$ and thus the entire velocity and pressure field.\n\nFor this operator, $L = \\nabla^2 - 1/L_d^2$, to be invertible on a doubly periodic domain, none of its eigenvalues can be zero. We analyze this using a Fourier series representation for functions on the domain $[0, 2\\pi] \\times [0, 2\\pi]$. An eigenfunction is of the form $e^{i(kx+ly)}$ where $k$ and $l$ are integer wavenumbers. Applying the operator:\n$$\nL e^{i(kx+ly)} = (\\nabla^2 - 1/L_d^2) e^{i(kx+ly)} = (-(k^2+l^2) - 1/L_d^2) e^{i(kx+ly)}\n$$\nThe eigenvalues are $\\lambda_{k,l} = -(k^2+l^2+1/L_d^2)$.\nIf $L_d$ is finite, then $1/L_d^2 > 0$. Since $k^2+l^2 \\ge 0$, the sum $k^2+l^2+1/L_d^2$ is always strictly positive. Thus, all eigenvalues $\\lambda_{k,l}$ are strictly negative and non-zero. The operator is invertible, and a unique solution $\\psi$ exists for any given $q'$.\n\nIn the special barotropic limit where $L_d \\to \\infty$, the term $1/L_d^2$ vanishes, and the equation becomes the Poisson equation:\n$$\n\\nabla^2 \\psi(x,y) = q'(x,y)\n$$\nThe eigenvalues of the operator $L = \\nabla^2$ are $\\lambda_{k,l} = -(k^2+l^2)$. For the zero-wavenumber mode $(k,l)=(0,0)$, the eigenvalue is $\\lambda_{0,0} = 0$. This indicates that the operator is not invertible. A solution can exist only if the right-hand side $q'$ is orthogonal to the null space of the operator's adjoint. For the self-adjoint Laplacian on a periodic domain, this means $q'$ must be orthogonal to the constant function, which spans the null space. This orthogonality condition is the compatibility condition: the spatial mean of $q'$ must be zero.\n$$\n\\langle q' \\rangle = \\frac{1}{(2\\pi)^2} \\int_0^{2\\pi} \\int_0^{2\\pi} q'(x,y) \\,dx\\,dy = 0\n$$\nIf this condition is met, a solution $\\psi$ exists, but it is not unique: if $\\psi_0$ is a solution, then $\\psi_0 + C$ is also a solution for any constant $C$. Uniqueness is conventionally enforced by requiring the spatial mean of $\\psi$ to be zero.\n\n### Part 2: Algorithm for Spectral Inversion\n\nThe inversion of the QG PV equation is efficiently performed in spectral space using the Discrete Fourier Transform (DFT), commonly implemented as the Fast Fourier Transform (FFT). For a doubly periodic domain $[0, 2\\pi] \\times [0, 2\\pi]$ discretized onto an $N_x \\times N_y$ grid, the algorithm is as follows:\n\n1.  **Forward Transform**: Given the PV anomaly $q'(x_j, y_m)$ on the grid, compute its 2D DFT to obtain its Fourier coefficients $\\hat{q}'_{k,l}$:\n    $$\n    \\hat{q}'_{k,l} = \\mathcal{F}(q') = \\sum_{j=0}^{N_x-1} \\sum_{m=0}^{N_y-1} q'(x_j, y_m) e^{-i(kx_j + ly_m)}\n    $$\n2.  **Algebraic Inversion**: The PDE $(\\nabla^2 - 1/L_d^2)\\psi = q'$ transforms into an algebraic equation in Fourier space. The Fourier transform of the Laplacian operator on the periodic domain corresponds to multiplication by $-(k^2+l^2)$, where $k$ and $l$ are the integer wavenumbers.\n    $$\n    (-(k^2 + l^2) - \\frac{1}{L_d^2}) \\hat{\\psi}_{k,l} = \\hat{q}'_{k,l}\n    $$\n    The Fourier coefficients of the streamfunction $\\hat{\\psi}_{k,l}$ are then found by division:\n    $$\n    \\hat{\\psi}_{k,l} = \\frac{\\hat{q}'_{k,l}}{-(k^2 + l^2 + 1/L_d^2)}\n    $$\n    -   For a finite deformation radius $L_d$ (Helmholtz case), the denominator is never zero, so this division is performed for all wavenumber pairs $(k,l)$.\n    -   For the barotropic limit $L_d \\to \\infty$ (Poisson case), the denominator becomes $-(k^2+l^2)$, which is zero for the zero-wavenumber mode $(k,l)=(0,0)$. The compatibility condition ensures that $\\hat{q}'_{0,0}$ (the mean of $q'$) is also zero. This leads to a $0/0$ form. To ensure a unique solution, we enforce the condition that the mean of the streamfunction is zero, which translates to setting its zero-wavenumber Fourier coefficient to zero: $\\hat{\\psi}_{0,0} = 0$.\n\n3.  **Inverse Transform**: Reconstruct the streamfunction $\\psi(x_j, y_m)$ in physical space by applying the inverse 2D DFT to its coefficients:\n    $$\n    \\psi(x_j, y_m) = \\mathcal{F}^{-1}(\\hat{\\psi}) = \\frac{1}{N_x N_y} \\sum_{k=0}^{N_x-1} \\sum_{l=0}^{N_y-1} \\hat{\\psi}_{k,l} e^{i(kx_j + ly_m)}\n    $$\n4.  **Validation**: To validate the inversion, we reconstruct the PV anomaly, $q'_{\\text{rec}}$, from the computed streamfunction $\\psi$, and compare it to the original $q'$. This is best done in spectral space to avoid finite difference errors.\n    -   Compute the Fourier coefficients of the reconstructed PV:\n        $$\n        \\hat{q}'_{\\text{rec},k,l} = (-(k^2+l^2) - 1/L_d^2)\\hat{\\psi}_{k,l}\n        $$\n    -   By construction, $\\hat{q}'_{\\text{rec},k,l}$ should be identical to the original $\\hat{q}'_{k,l}$ up to floating-point precision.\n    -   Apply the inverse DFT to get $q'_{\\text{rec}}(x,y) = \\mathcal{F}^{-1}(\\hat{q}'_{\\text{rec}})$.\n    -   Calculate the maximum absolute error:\n        $$\n        E = \\max_{j,m} | q'_{\\text{rec}}(x_j, y_m) - q'(x_j, y_m) |\n        $$\n\n### Part 3: Implementation for Test Cases\n\nThe algorithm is implemented for a domain with $L_x = L_y = 2\\pi$ on a grid of $N_x = N_y = 64$ points. The integer wavenumbers $k$ and $l$ range from $-32$ to $31$. A 2D grid of these wavenumbers is used to construct the spectral representation of the differential operator. The algorithm is applied to the three specified test cases:\n-   **Case A ($L_d=1.0$, $q'_A = \\cos x + \\cos y$)**: A standard Helmholtz inversion. The forcing is composed of wavenumbers $(k,l) = (\\pm 1, 0)$ and $(0, \\pm 1)$.\n-   **Case B ($L_d=\\infty$, $q'_B = \\sin(2x) + \\sin(3y)$)**: A Poisson inversion. The forcing has zero mean, satisfying the compatibility condition. The zero-wavenumber mode $\\hat{\\psi}_{0,0}$ is set to zero.\n-   **Case C ($L_d=0.5$, $q'_C = 2.0$)**: A Helmholtz inversion where the forcing is a constant, corresponding to the zero-wavenumber mode $(k,l)=(0,0)$. This tests the non-singular handling of the mean component when $L_d$ is finite.\n\nThe following Python code implements this procedure and computes the reconstruction error $E$ for each case.",
            "answer": "```python\nimport numpy as np\nfrom scipy import fft\n\ndef solve_qg_inversion(q_prime, Ld, N, L):\n    \"\"\"\n    Inverts the QG PV equation using spectral methods.\n\n    Args:\n        q_prime (np.ndarray): 2D array of the QG PV anomaly.\n        Ld (float): Rossby deformation radius. Use np.inf for the barotropic limit.\n        N (int): Number of grid points in each dimension.\n        L (float): Domain size in each dimension.\n\n    Returns:\n        float: The maximum absolute reconstruction error.\n    \"\"\"\n    # 1. Fourier transform the PV anomaly\n    q_hat = fft.fft2(q_prime)\n\n    # 2. Set up wavenumber grid\n    # For a domain of size L=2*pi, the wavenumbers are integers.\n    # fft.fftfreq(N) * N gives the integer wavenumbers [0, 1, ..., N/2-1, -N/2, ..., -1]\n    k = fft.fftfreq(N) * N\n    l = fft.fftfreq(N) * N\n    K, L_grid = np.meshgrid(k, l)\n\n    # 3. Construct the spectral operator\n    # The operator is -(k^2 + l^2) - 1/Ld^2\n    is_barotropic = np.isinf(Ld)\n    if is_barotropic:\n        # Barotropic (Poisson) case: Ld -> inf\n        spectral_op = -(K**2 + L_grid**2)\n    else:\n        # Baroclinic (Helmholtz) case\n        spectral_op = -(K**2 + L_grid**2) - 1.0/Ld**2\n\n    # 4. Solve for the streamfunction in spectral space\n    psi_hat = np.zeros_like(q_hat, dtype=complex)\n    \n    # Handle the zero-wavenumber mode for the Poisson case\n    if is_barotropic:\n        # Check compatibility condition (mean q' should be zero)\n        # q_hat[0, 0] is proportional to the mean. It should be numerically zero.\n        if np.abs(q_hat[0, 0]) > 1e-9:\n             # This case is not hit by the problem spec but is good practice\n            raise ValueError(\"Incompatible forcing for Poisson equation: mean is non-zero.\")\n\n        # For k=l=0, the operator is 0. We set psi_hat[0,0]=0 for a unique solution.\n        # For all other wavenumbers, the operator is non-zero.\n        non_zero_k = spectral_op != 0\n        psi_hat[non_zero_k] = q_hat[non_zero_k] / spectral_op[non_zero_k]\n        psi_hat[0, 0] = 0.0 + 0.0j # Enforce zero mean for psi\n    else:\n        # For the Helmholtz case, the operator is never zero.\n        psi_hat = q_hat / spectral_op\n\n    # 5. Reconstruct the PV anomaly to validate the inversion\n    q_rec_hat = spectral_op * psi_hat\n    \n    # In the barotropic case, q_hat[0,0] was already checked to be zero, and\n    # psi_hat[0,0] was set to zero, so spectral_op[0,0]*psi_hat[0,0] = 0*0 = 0.\n    # This correctly reproduces q_hat[0,0].\n\n    # 6. Transform back to physical space\n    q_rec = fft.ifft2(q_rec_hat)\n\n    # 7. Calculate the maximum absolute difference\n    # The result of ifft2 should be real since the original data was real\n    # and the operations preserve conjugacy. We take .real to discard\n    # negligible imaginary parts from floating-point inaccuracies.\n    error = np.max(np.abs(q_rec.real - q_prime))\n    \n    return error\n\ndef solve():\n    \"\"\"\n    Main function to run the test cases and print the results.\n    \"\"\"\n    # Common parameters\n    N = 64\n    L = 2.0 * np.pi\n    \n    # Grid setup\n    x = np.linspace(0, L, N, endpoint=False)\n    y = np.linspace(0, L, N, endpoint=False)\n    X, Y = np.meshgrid(x, y)\n\n    # --- Test Cases ---\n    test_cases = [\n        # Case A: Helmholtz, happy path\n        {\n            \"name\": \"A\",\n            \"Ld\": 1.0,\n            \"q_prime_func\": lambda x, y: np.cos(x) + np.cos(y)\n        },\n        # Case B: Poisson, barotropic limit\n        {\n            \"name\": \"B\",\n            \"Ld\": np.inf,\n            \"q_prime_func\": lambda x, y: np.sin(2*x) + np.sin(3*y)\n        },\n        # Case C: Helmholtz, zero-wavenumber forcing\n        {\n            \"name\": \"C\",\n            \"Ld\": 0.5,\n            \"q_prime_func\": lambda x, y: 2.0 + 0*x  # Ensure it is a 2D array\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        Ld = case[\"Ld\"]\n        q_prime = case[\"q_prime_func\"](X, Y)\n        \n        error = solve_qg_inversion(q_prime, Ld, N, L)\n        results.append(error)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}