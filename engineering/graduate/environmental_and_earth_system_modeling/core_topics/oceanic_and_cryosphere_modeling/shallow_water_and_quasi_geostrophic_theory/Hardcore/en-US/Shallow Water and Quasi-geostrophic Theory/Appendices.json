{
    "hands_on_practices": [
        {
            "introduction": "To analyze atmospheric and oceanic waves and instabilities, we must first separate the flow into a background state and the perturbations that evolve upon it. This exercise is a foundational step in that process, focusing on the linearization of potential vorticity (PV). By deriving the first-order PV anomaly, you will see precisely how small perturbations in the flow's rotation (vorticity) and the fluid's thickness (stretching) combine to form the essential dynamical quantity whose conservation governs quasi-geostrophic motions. ",
            "id": "4048393",
            "problem": "Consider the single-layer rotating shallow-water system relevant to geostrophic adjustment on a midlatitude $\\beta$-plane, with Coriolis parameter $f(y) = f_{0} + \\beta y$, constant mean layer depth $H$, free-surface displacement $\\eta(x,y,t)$, and horizontal velocity components $u(x,y,t)$ and $v(x,y,t)$. The relative vorticity is defined by $\\zeta(x,y,t) = \\partial v/\\partial x - \\partial u/\\partial y$. In frictionless, non-diffusive flow with no bottom topography, the materially conserved potential vorticity (PV) is given by $q(x,y,t) = \\dfrac{\\zeta(x,y,t) + f(y)}{H + \\eta(x,y,t)}$.\n\nAssume a rest reference state with $u = 0$, $v = 0$, and $\\eta = 0$, and define small perturbations $\\zeta'(x,y,t)$ and $\\eta'(x,y,t)$ about this state such that $\\zeta = \\zeta'$ and $\\eta = \\eta'$. Linearize the PV $q$ about this rest state, retaining only terms that are first order in the perturbations, and express the resulting first-order PV anomaly $q'$ solely in terms of $\\zeta'$, $\\eta'$, $H$, and $f_{0}$. Treat $f_{0}$ as the constant Coriolis parameter at the reference latitude and do not include meridional advection of $f(y)$. Your final answer must be a single closed-form analytic expression for $q'$ in terms of $\\zeta'$, $\\eta'$, $H$, and $f_{0}$.",
            "solution": "The user wants me to find the first-order approximation of the potential vorticity (PV) anomaly for a single-layer rotating shallow-water system.\n\n### Step 1: Problem Validation\n\nFirst, I will validate the problem statement.\n\n#### Step 1.1: Extract Givens\n- **System:** Single-layer rotating shallow-water system on a midlatitude $\\beta$-plane.\n- **Coriolis Parameter:** $f(y) = f_{0} + \\beta y$.\n- **Mean Layer Depth:** $H$ (constant).\n- **Free-Surface Displacement:** $\\eta(x,y,t)$.\n- **Velocity Components:** $u(x,y,t)$ and $v(x,y,t)$.\n- **Relative Vorticity:** $\\zeta(x,y,t) = \\frac{\\partial v}{\\partial x} - \\frac{\\partial u}{\\partial y}$.\n- **Potential Vorticity (PV):** $q(x,y,t) = \\dfrac{\\zeta(x,y,t) + f(y)}{H + \\eta(x,y,t)}$.\n- **Reference State:** A state of rest, defined by $u = 0$, $v = 0$, and $\\eta = 0$.\n- **Perturbations:** Small perturbations about the rest state are denoted with a prime, such that the total vorticity is $\\zeta = \\zeta'$ and the total surface displacement is $\\eta = \\eta'$.\n- **Task:** Linearize the PV $q$ about the rest state and find the expression for the first-order PV anomaly, $q'$.\n- **Constraints:** The final expression for $q'$ must be solely in terms of $\\zeta'$, $\\eta'$, $H$, and $f_{0}$. The problem also states to \"Treat $f_{0}$ as the constant Coriolis parameter at the reference latitude and do not include meridional advection of $f(y)$.\"\n\n#### Step 1.2: Validate Using Extracted Givens\nThe problem is well-defined and rooted in the fundamental principles of geophysical fluid dynamics. The model described (rotating shallow-water equations), the definition of potential vorticity, and the process of linearization are all standard concepts in this field.\n\n- **Scientific Grounding:** The problem is scientifically sound. It deals with the derivation of the linearized potential vorticity, a cornerstone of quasi-geostrophic theory.\n- **Well-Posedness and Consistency:** The problem appears to have a minor internal contradiction at first glance: it is set on a $\\beta$-plane (where $f$ varies with latitude $y$), but asks for a final answer independent of $\\beta$ and $y$. However, this is not a\nflaw. In the standard derivation of quasi-geostrophic PV, one approximates the Coriolis parameter $f(y)$ as $f_0$ in terms that are already of first order in the perturbation fields (like the \"stretching\" term containing $\\eta$). The variation of $f$ with $y$ (the $\\beta$-effect) is retained in the background PV gradient, which governs wave dynamics, but the problem only asks for the expression for the PV anomaly itself, not its evolution equation. The problem's constraints guide the user to make this specific, standard approximation. Therefore, the problem is well-posed and internally consistent under this standard interpretation.\n- **Objectivity  Clarity:** The problem uses precise, objective scientific language and defines all terms clearly.\n\n#### Step 1.3: Verdict and Action\nThe problem is deemed **valid**. I will proceed with deriving the solution.\n\n### Step 2: Derivation of the Solution\n\nThe potential vorticity (PV) for the shallow-water system is given by:\n$$q(x,y,t) = \\frac{\\zeta(x,y,t) + f(y)}{H + \\eta(x,y,t)}$$\nWith the Coriolis parameter on a $\\beta$-plane being $f(y) = f_{0} + \\beta y$.\n\nThe system is analyzed around a reference state of rest, where $\\bar{u}=0$, $\\bar{v}=0$, and $\\bar{\\eta}=0$. This implies the reference relative vorticity is also zero, $\\bar{\\zeta}=0$. The PV of this reference state, denoted $\\bar{q}$, is a function of latitude $y$:\n$$\\bar{q}(y) = \\frac{\\bar{\\zeta} + f(y)}{H + \\bar{\\eta}} = \\frac{0 + f_{0} + \\beta y}{H} = \\frac{f_{0} + \\beta y}{H}$$\n\nThe total PV, $q$, can be decomposed into the sum of the background PV and a perturbation PV (anomaly), $q'$:\n$$q(x,y,t) = \\bar{q}(y) + q'(x,y,t)$$\nThe PV anomaly is thus $q' = q - \\bar{q}$. Given that the perturbations are defined such that $\\zeta = \\zeta'$ and $\\eta = \\eta'$, we can write the expression for $q'$:\n$$q' = \\frac{\\zeta' + f(y)}{H + \\eta'} - \\frac{f(y)}{H}$$\nSubstituting $f(y) = f_0 + \\beta y$:\n$$q' = \\frac{\\zeta' + f_{0} + \\beta y}{H + \\eta'} - \\frac{f_{0} + \\beta y}{H}$$\nTo combine the terms, we find a common denominator:\n$$q' = \\frac{H(\\zeta' + f_{0} + \\beta y) - (H + \\eta')(f_{0} + \\beta y)}{H(H + \\eta')}$$\nExpanding the numerator:\n$$q' = \\frac{H\\zeta' + H(f_{0} + \\beta y) - H(f_{0} + \\beta y) - \\eta'(f_{0} + \\beta y)}{H(H + \\eta')}$$\nSimplifying the numerator gives the exact expression for the PV anomaly:\n$$q' = \\frac{H\\zeta' - (f_{0} + \\beta y)\\eta'}{H^2 + H\\eta'}$$\n\nThe next step is to linearize this expression by retaining only terms that are first order in the small perturbations $\\zeta'$ and $\\eta'$. We can rewrite the denominator and use the Taylor expansion $(1+x)^{-1} \\approx 1-x$ for small $x = \\eta'/H$:\n$$q' = \\frac{H\\zeta' - (f_{0} + \\beta y)\\eta'}{H^2(1 + \\eta'/H)} \\approx \\left(\\frac{\\zeta'}{H} - \\frac{(f_{0} + \\beta y)\\eta'}{H^2}\\right) \\left(1 - \\frac{\\eta'}{H}\\right)$$\nExpanding the product:\n$$q' \\approx \\frac{\\zeta'}{H} - \\frac{\\zeta'\\eta'}{H^2} - \\frac{(f_{0} + \\beta y)\\eta'}{H^2} + \\frac{(f_{0} + \\beta y)(\\eta')^2}{H^3}$$\nWe discard terms that are second order or higher in the perturbations. The terms $\\frac{\\zeta'\\eta'}{H^2}$ and $\\frac{(f_{0} + \\beta y)(\\eta')^2}{H^3}$ are second order and are neglected. The linearized PV anomaly is therefore:\n$$q' \\approx \\frac{\\zeta'}{H} - \\frac{(f_{0} + \\beta y)\\eta'}{H^2}$$\n\nFinally, we must apply the constraint that the final expression for $q'$ depends only on $\\zeta'$, $\\eta'$, $H$, and $f_{0}$. This requires us to handle the term $(f_{0} + \\beta y)\\eta'$. This term can be written as $f_0 \\eta' + \\beta y \\eta'$. In quasi-geostrophic scaling, the term $\\beta y \\eta'$ is considered a higher-order correction compared to $f_0 \\eta'$, because the ratio $\\beta y/f_0$ is typically small for the length scales of interest. Therefore, a standard and consistent approximation within this framework is to replace $f(y) = f_0 + \\beta y$ with just $f_0$ in terms that are already multiplied by a first-order perturbation like $\\eta'$. This is precisely what the problem statement guides us to do.\n\nApplying this approximation, $(f_0 + \\beta y)\\eta' \\approx f_0 \\eta'$, we get the final expression for the first-order PV anomaly:\n$$q' = \\frac{\\zeta'}{H} - \\frac{f_{0}\\eta'}{H^2}$$\nThis result satisfies all conditions of the problem. It represents the linearized form of the shallow-water PV anomaly under the quasi-geostrophic approximation.",
            "answer": "$$\\boxed{\\frac{\\zeta'}{H} - \\frac{f_{0} \\eta'}{H^{2}}}$$"
        },
        {
            "introduction": "A robust physical theory is defined as much by its limitations as by its explanatory power. This practice employs the powerful tool of scale analysis to probe the domain of validity for Quasi-Geostrophic (QG) theory. By calculating key non-dimensional parameters like the Rossby and Froude numbers for tropical conditions, you will develop a physical intuition for why this cornerstone of mid-latitude dynamics breaks down near the equator, paving the way for understanding alternative theoretical frameworks. ",
            "id": "4047787",
            "problem": "Consider the validity of Quasi-Geostrophic (QG) theory for large-scale tropical atmospheric circulations within the hydrostatic, rotating primitive equations framework. The horizontal momentum equations on a rotating sphere contain the Coriolis acceleration, pressure-gradient force, and advective acceleration, with the Coriolis parameter given by $f(\\phi) = 2 \\Omega \\sin \\phi$, where $\\phi$ is latitude, $\\Omega$ is Earth’s rotation rate, and $R$ is Earth’s mean radius. Near the equator, adopt the equatorial $\\beta$-plane approximation $f(y) \\approx \\beta y$ with $\\beta = \\partial f / \\partial y|_{\\phi=0} = 2 \\Omega / R$, and $y$ the meridional distance from the equator.\n\nYou are given representative large-scale tropical parameters $U = 15\\,\\mathrm{m\\,s^{-1}}$, $L = 1000\\,\\mathrm{km}$, buoyancy frequency $N = 10^{-2}\\,\\mathrm{s^{-1}}$, and vertical scale $H = 10^{4}\\,\\mathrm{m}$, along with Earth’s constants $\\Omega = 7.292 \\times 10^{-5}\\,\\mathrm{s^{-1}}$ and $R = 6.371 \\times 10^{6}\\,\\mathrm{m}$. Starting from the dimensional primitive equations, define the nondimensional measures that compare (i) advective to Coriolis acceleration, and (ii) advective speed to the gravity-wave propagation speed in a stably stratified fluid. Use appropriate scale analysis to evaluate these measures for the given parameters in the equatorial limit.\n\nUsing the $\\beta$-plane, obtain an expression for the latitude dependence of the advective-to-Coriolis measure. Determine the minimum latitude $\\phi_{\\min}$ (north of the equator) at which this measure equals unity for the given $U$ and $L$. Express $\\phi_{\\min}$ in degrees. Round your answer to three significant figures.\n\nFinally, interpret physically why QG theory breaks down in the deep tropics based on your estimates, and summarize what alternative scaling regimes become relevant there. Your final reported answer must be the single numerical value of $\\phi_{\\min}$ in degrees, rounded to three significant figures.",
            "solution": "The user wants me to solve the problem by following these steps:\n1.  Critically validate the problem statement.\n2.  If the problem is valid, provide a complete, reasoned solution.\n3.  Ensure all mathematical entities are formatted in LaTeX.\n4.  Provide the final answer in the required format.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n-   Coriolis parameter: $f(\\phi) = 2 \\Omega \\sin \\phi$\n-   $\\phi$: latitude\n-   $\\Omega$: Earth's rotation rate\n-   $R$: Earth's mean radius\n-   Equatorial $\\beta$-plane approximation: $f(y) \\approx \\beta y$\n-   $\\beta = \\partial f / \\partial y|_{\\phi=0} = 2 \\Omega / R$\n-   $y$: meridional distance from the equator\n-   Characteristic large-scale tropical horizontal velocity: $U = 15\\,\\mathrm{m\\,s^{-1}}$\n-   Characteristic large-scale tropical horizontal length scale: $L = 1000\\,\\mathrm{km}$\n-   Characteristic buoyancy frequency: $N = 10^{-2}\\,\\mathrm{s^{-1}}$\n-   Characteristic vertical scale: $H = 10^{4}\\,\\mathrm{m}$\n-   Earth's rotation rate: $\\Omega = 7.292 \\times 10^{-5}\\,\\mathrm{s^{-1}}$\n-   Earth's mean radius: $R = 6.371 \\times 10^{6}\\,\\mathrm{m}$\n\n**Step 2: Validate Using Extracted Givens**\n-   **Scientifically Grounded**: The problem is fundamentally based on the primitive equations of atmospheric motion and the principles of scale analysis in geophysical fluid dynamics. Quasi-Geostrophic (QG) theory, the equatorial $\\beta$-plane, Rossby numbers, and Froude numbers are all standard, well-established concepts in this field. The provided physical constants and characteristic scales are realistic for large-scale atmospheric phenomena in the tropics. The problem is scientifically sound.\n-   **Well-Posed**: The problem is clearly structured. It asks for the derivation and evaluation of specific nondimensional parameters, the calculation of a specific latitude based on a well-defined criterion ($Ro=1$), and a physical interpretation. The setup provides all necessary information for a unique solution.\n-   **Objective**: The problem is stated using precise, objective, and technical language common to the field of atmospheric science. There are no subjective or opinion-based elements.\n\n**Step 3: Verdict and Action**\nThe problem is valid as it is scientifically grounded, well-posed, objective, and self-contained. I will proceed with a full solution.\n\n### Solution\n\nThe problem requires a scale analysis of the primitive equations to understand the validity of Quasi-Geostrophic (QG) theory in the tropics. This involves defining and evaluating two key nondimensional numbers.\n\nThe first nondimensional measure compares the magnitude of advective acceleration to the Coriolis acceleration. The horizontal momentum equation includes the advection term $(\\mathbf{u} \\cdot \\nabla_h) \\mathbf{u}$ and the Coriolis term $f \\mathbf{k} \\times \\mathbf{u}$. Using the characteristic scales $U$ for velocity and $L$ for horizontal length, the magnitudes of these terms are scaled as:\n-   Advective acceleration: $|\\,(\\mathbf{u} \\cdot \\nabla_h) \\mathbf{u}\\,| \\sim \\frac{U^2}{L}$\n-   Coriolis acceleration: $|\\,f \\mathbf{k} \\times \\mathbf{u}\\,| \\sim f U$\n\nThe ratio of advection to Coriolis is the Rossby number, $Ro$:\n$$\nRo = \\frac{U^2/L}{fU} = \\frac{U}{fL}\n$$\nQG theory is valid for flows where the Rossby number is small, $Ro \\ll 1$, indicating that the Coriolis force is dominant over advective accelerations, leading to a primary geostrophic balance.\n\nThe second nondimensional measure compares the advective speed to the propagation speed of internal gravity waves in a stably stratified fluid. The advective speed scale is $U$. The phase speed of long internal gravity waves, $c_g$, is given by the product of the buoyancy frequency $N$ and the vertical length scale $H$.\n-   Advective speed: $U$\n-   Internal gravity wave speed: $c_g \\sim NH$\n\nThe ratio is the Froude number, $Fr$:\n$$\nFr = \\frac{U}{NH}\n$$\nFor QG theory to be a valid approximation, the Froude number should also be small, $Fr \\ll 1$, which is related to the requirement that the Burger number $Bu = (Ro/Fr)^2 = (N H / f L)^2$ be of order unity.\n\nLet us evaluate the Froude number for the given parameters:\n$U = 15\\,\\mathrm{m\\,s^{-1}}$, $N = 10^{-2}\\,\\mathrm{s^{-1}}$, and $H = 10^{4}\\,\\mathrm{m}$.\n$$\nFr = \\frac{15\\,\\mathrm{m\\,s^{-1}}}{(10^{-2}\\,\\mathrm{s^{-1}})(10^{4}\\,\\mathrm{m})} = \\frac{15}{100} = 0.15\n$$\nThis value is small compared to $1$, satisfying one of the conditions for QG-like dynamics.\n\nNext, we address the latitude dependence of the Rossby number. The Coriolis parameter $f$ is a function of latitude $\\phi$: $f(\\phi) = 2 \\Omega \\sin \\phi$. Thus, the Rossby number is also a function of latitude:\n$$\nRo(\\phi) = \\frac{U}{(2 \\Omega \\sin \\phi) L}\n$$\nThe problem asks for an expression based on the $\\beta$-plane approximation. Near the equator, for small $\\phi$, $\\sin \\phi \\approx \\phi$ (where $\\phi$ is in radians). The meridional distance from the equator is $y \\approx R\\phi$. The equatorial $\\beta$-plane approximation states $f(y) \\approx \\beta y = (2\\Omega/R)y$. Substituting $y = R\\phi$, we get $f(\\phi) \\approx (2\\Omega/R)(R\\phi) = 2\\Omega\\phi$. This is identical to the small-angle approximation of the full Coriolis parameter, confirming the consistency of the approach. Using the more general form $f(\\phi) = 2\\Omega\\sin\\phi$ is appropriate for finding the latitude.\n\nWe need to find the minimum latitude $\\phi_{\\min}$ (north of the equator, so $\\phi_{\\min}>0$) where the advective-to-Coriolis measure, $Ro(\\phi)$, equals unity.\n$$\nRo(\\phi_{\\min}) = 1\n$$\n$$\n\\frac{U}{(2 \\Omega \\sin \\phi_{\\min}) L} = 1\n$$\nSolving for $\\sin \\phi_{\\min}$:\n$$\n\\sin \\phi_{\\min} = \\frac{U}{2 \\Omega L}\n$$\nNow, we substitute the given values: $U = 15\\,\\mathrm{m\\,s^{-1}}$, $\\Omega = 7.292 \\times 10^{-5}\\,\\mathrm{s^{-1}}$, and $L = 1000\\,\\mathrm{km} = 10^6\\,\\mathrm{m}$.\n$$\n\\sin \\phi_{\\min} = \\frac{15}{2 \\times (7.292 \\times 10^{-5}) \\times 10^6} = \\frac{15}{145.84} \\approx 0.1028524\n$$\nTo find the latitude in degrees, we take the arcsin and convert from radians to degrees:\n$$\n\\phi_{\\min} = \\arcsin(0.1028524)\n$$\nIn radians, $\\phi_{\\min} \\approx 0.10302$ rad.\nIn degrees, $\\phi_{\\min} = \\arcsin(0.1028524) \\times \\frac{180}{\\pi} \\approx 5.9014^\\circ$.\nRounding to three significant figures, we get $\\phi_{\\min} = 5.90^\\circ$.\n\nFinally, we interpret this result physically. The fundamental assumption of QG theory is that the Rossby number is small, $Ro \\ll 1$. Our analysis shows that $Ro$ is inversely proportional to $\\sin \\phi$. As the equator is approached ($\\phi \\to 0$), $\\sin \\phi \\to 0$, causing $Ro \\to \\infty$. This signifies a complete breakdown of geostrophic balance, as the Coriolis force vanishes while advective accelerations remain significant. The latitude $\\phi_{\\min} \\approx 5.90^\\circ$ marks the approximate boundary of the \"equatorial waveguide\" region. For latitudes $|\\phi|  \\phi_{\\min}$, the Rossby number is greater than unity ($Ro  1$), and the atmospheric dynamics are highly ageostrophic and nonlinear. QG theory is inapplicable in this \"deep tropics\" region. For latitudes $|\\phi|  \\phi_{\\min}$, the Rossby number becomes less than unity ($Ro  1$), and QG theory becomes an increasingly valid approximation as latitude increases.\n\nIn the deep tropics where QG theory fails, alternative scaling regimes become relevant. The dynamics are governed by a different balance of forces that allows for equatorially trapped waves, such as Kelvin, Rossby-gravity, and equatorial Rossby waves. Theories designed for this regime, such as the shallow water equations on an equatorial $\\beta$-plane and the Weak Temperature Gradient (WTG) approximation, provide a more appropriate framework for understanding tropical phenomena like the Madden-Julian Oscillation (MJO) and El Niño-Southern Oscillation (ENSO).",
            "answer": "$$\n\\boxed{5.90}\n$$"
        },
        {
            "introduction": "A central pillar of quasi-geostrophic theory is the powerful \"invertibility principle,\" which asserts that the entire balanced flow field can be determined from the distribution of potential vorticity alone. This computational exercise brings that abstract principle to life, guiding you to build a numerical solver that uses spectral methods to invert the QG PV equation. Mastering this technique provides not only a solution to a specific problem but also a deep insight into how PV acts as the fundamental \"source\" for the velocity and pressure fields in large-scale balanced flows. ",
            "id": "3911751",
            "problem": "Consider a one-layer Quasi-Geostrophic (QG) flow on a doubly periodic square domain with side length $L_x = L_y = 2\\pi$. The fundamental base consists of the rotating shallow water equations under small Rossby number scaling, geostrophic balance between the Coriolis force and the pressure gradient, and the definition of Potential Vorticity (PV) as the ratio of absolute vorticity to the layer thickness. Under QG scaling, the geostrophic velocity is represented by a streamfunction $\\psi(x,y)$ via $\\mathbf{u}_g = (-\\partial \\psi/\\partial y, \\partial \\psi/\\partial x)$, and the QG PV anomaly $q'(x,y)$ is a linear function of $\\psi(x,y)$ involving spatial derivatives up to second order. On a doubly periodic domain, inversion from $q'(x,y)$ to $\\psi(x,y)$ is well-posed when the governing linear operator is invertible on the function space of periodic functions.\n\nYour task is to:\n1. Starting from the rotating shallow water momentum and continuity equations, the geostrophic balance $f_0 \\hat{\\mathbf{z}} \\times \\mathbf{u}_g = -g' \\nabla \\eta$, the definition of PV $Q = (\\zeta + f_0)/h$, and the small-amplitude free surface displacement $\\eta$ related to $\\psi$ through mass conservation, derive the QG PV anomaly in the one-layer case as a linear operator applied to $\\psi(x,y)$. Show that the inversion problem for $\\psi(x,y)$ given $q'(x,y)$ reduces to solving a constant-coefficient elliptic partial differential equation of the form\n$$\n\\left(\\nabla^2 - \\frac{1}{L_d^2}\\right)\\psi(x,y) = q'(x,y),\n$$\nwhere $L_d$ is the Rossby deformation radius, and $\\nabla^2$ is the two-dimensional Laplacian. State the conditions under which the operator is invertible on a doubly periodic domain, and discuss the special case when $L_d \\to \\infty$ (the barotropic limit), for which the equation reduces to the Poisson equation $\\nabla^2 \\psi(x,y) = q'(x,y)$ and compatibility requires that the spatial mean of $q'(x,y)$ vanishes.\n\n2. Devise an algorithm to invert $q'(x,y)$ to obtain $\\psi(x,y)$ in a doubly periodic domain by using the Discrete Fourier Transform (DFT), also known as the Fast Fourier Transform (FFT). Explicitly derive the spectral-space algebraic relationship that allows solving for the Fourier coefficients of $\\psi$ from those of $q'$, taking care of the zero-wavenumber mode in the Poisson case. Then describe how to reconstruct $\\psi(x,y)$, and how to validate the inversion by reconstructing the PV anomaly $q'_{\\text{rec}}(x,y)$ from $\\psi(x,y)$ and comparing it to the original $q'(x,y)$.\n\n3. Implement the algorithm in a program that uses $N_x = N_y = 64$ grid points, $L_x = L_y = 2\\pi$, and the following test suite of PV anomalies and deformation radii:\n   - Test case A (happy path): $L_d = 1.0$ and\n     $$\n     q'_A(x,y) = \\cos(x) + \\cos(y).\n     $$\n   - Test case B (barotropic limit, zero-mean anomaly): $L_d \\to \\infty$ and\n     $$\n     q'_B(x,y) = \\sin(2x) + \\sin(3y).\n     $$\n     Here the algorithm must treat the zero-wavenumber mode consistently with the compatibility condition.\n   - Test case C (zero-wavenumber inversion in Helmholtz case): $L_d = 0.5$ and\n     $$\n     q'_C(x,y) = 2.0,\n     $$\n     a spatially uniform anomaly.\n\nFor each test case, compute the geostrophic streamfunction $\\psi(x,y)$, reconstruct the PV anomaly\n$$\nq'_{\\text{rec}}(x,y) = \\nabla^2 \\psi(x,y) - \\frac{\\psi(x,y)}{L_d^2}\n$$\nfor finite $L_d$, and $q'_{\\text{rec}}(x,y) = \\nabla^2 \\psi(x,y)$ in the barotropic limit, and report the maximum absolute difference \n$$\nE = \\max_{x,y} \\left| q'_{\\text{rec}}(x,y) - q'(x,y) \\right|\n$$\nas a floating-point number.\n\nAll quantities are non-dimensional, so no physical units are required. Your program should produce a single line of output containing the results for the three test cases as a comma-separated list enclosed in square brackets (e.g., $[E_A,E_B,E_C]$).",
            "solution": "The comprehensive solution is presented in three parts: first, the derivation of the governing partial differential equation from fundamental principles; second, the design of a spectral algorithm for its solution; and third, the implementation details for the numerical test cases.\n\n### Part 1: Derivation of the Quasi-Geostrophic Potential Vorticity Equation\n\nWe begin with the rotating shallow water equations for a single layer of fluid with constant density, under the assumptions of the quasi-geostrophic (QG) approximation. The momentum and continuity equations are:\n$$\n\\frac{D\\mathbf{u}}{Dt} + f_0 \\hat{\\mathbf{z}} \\times \\mathbf{u} = -g' \\nabla \\eta\n$$\n$$\n\\frac{D h}{Dt} + h (\\nabla \\cdot \\mathbf{u}) = 0\n$$\nwhere $\\mathbf{u}$ is the horizontal velocity vector, $f_0$ is the constant Coriolis parameter, $\\hat{\\mathbf{z}}$ is the unit vector in the vertical direction, $g'$ is the reduced gravity, $\\eta$ is the free surface displacement from the mean height $H$, and $h = H + \\eta$ is the total fluid depth.\n\nUnder the QG approximation, the Rossby number is small, implying that the flow is in geostrophic balance at leading order. This balance is between the Coriolis force and the pressure gradient:\n$$\nf_0 \\hat{\\mathbf{z}} \\times \\mathbf{u}_g = -g' \\nabla \\eta\n$$\nwhere $\\mathbf{u}_g$ is the geostrophic velocity. We introduce a streamfunction $\\psi(x,y)$ such that $\\mathbf{u}_g = (-\\partial \\psi/\\partial y, \\partial \\psi/\\partial x)$. Substituting this into the geostrophic balance gives:\n$$\nf_0 \\hat{\\mathbf{z}} \\times \\left(-\\frac{\\partial \\psi}{\\partial y}, \\frac{\\partial \\psi}{\\partial x}\\right) = \\left(f_0 \\frac{\\partial \\psi}{\\partial x}, f_0 \\frac{\\partial \\psi}{\\partial y}\\right) = f_0 \\nabla \\psi\n$$\nComparing this with $-g' \\nabla \\eta$, we find $f_0 \\nabla \\psi = g' \\nabla \\eta$. Integrating yields the relation between the streamfunction and the free surface displacement:\n$$\n\\eta = \\frac{f_0}{g'} \\psi\n$$\nwhere any integration constant can be absorbed into the definition of $\\psi$.\n\nNext, we consider the potential vorticity (PV), defined as $Q = (\\zeta + f_0)/h$, where $\\zeta = \\hat{\\mathbf{z}} \\cdot (\\nabla \\times \\mathbf{u})$ is the relative vorticity. In the QG framework, $\\zeta$ is approximated by the geostrophic vorticity, $\\zeta_g = \\nabla \\times \\mathbf{u}_g = \\nabla^2 \\psi$. The fluid depth is $h = H + \\eta$. For small-amplitude displacements, $\\eta \\ll H$, we can linearize the PV expression:\n$$\nQ = \\frac{\\zeta_g + f_0}{H + \\eta} = \\frac{f_0(1 + \\zeta_g/f_0)}{H(1 + \\eta/H)} \\approx \\frac{f_0}{H} (1 + \\frac{\\zeta_g}{f_0}) (1 - \\frac{\\eta}{H}) \\approx \\frac{f_0}{H} \\left(1 + \\frac{\\zeta_g}{f_0} - \\frac{\\eta}{H}\\right)\n$$\nThe mean PV is $Q_0 = f_0/H$. The PV anomaly, $Q' = Q - Q_0$, is therefore:\n$$\nQ' \\approx \\frac{f_0}{H} \\left(\\frac{\\zeta_g}{f_0} - \\frac{\\eta}{H}\\right) = \\frac{\\zeta_g}{H} - \\frac{f_0 \\eta}{H^2}\n$$\nThe QG potential vorticity anomaly, typically denoted $q'$, is defined as $q' = H Q'$:\n$$\nq' = \\zeta_g - \\frac{f_0}{H} \\eta\n$$\nSubstituting $\\zeta_g = \\nabla^2 \\psi$ and $\\eta = (f_0/g') \\psi$:\n$$\nq'(x,y) = \\nabla^2 \\psi(x,y) - \\frac{f_0^2}{g'H} \\psi(x,y)\n$$\nWe identify the term $(f_0^2 / (g'H))^{-1/2}$ as the internal Rossby radius of deformation, $L_d = \\sqrt{g'H}/f_0$. The equation relating the QG PV anomaly $q'$ to the streamfunction $\\psi$ is thus a Helmholtz equation:\n$$\n\\left(\\nabla^2 - \\frac{1}{L_d^2}\\right)\\psi(x,y) = q'(x,y)\n$$\nThis equation represents the \"invertibility principle\" in QG theory: given the distribution of PV anomaly $q'$, one can find the corresponding streamfunction $\\psi$ and thus the entire velocity and pressure field.\n\nFor this operator, $L = \\nabla^2 - 1/L_d^2$, to be invertible on a doubly periodic domain, none of its eigenvalues can be zero. We analyze this using a Fourier series representation for functions on the domain $[0, 2\\pi] \\times [0, 2\\pi]$. An eigenfunction is of the form $e^{i(kx+ly)}$ where $k$ and $l$ are integer wavenumbers. Applying the operator:\n$$\nL e^{i(kx+ly)} = (\\nabla^2 - 1/L_d^2) e^{i(kx+ly)} = (-(k^2+l^2) - 1/L_d^2) e^{i(kx+ly)}\n$$\nThe eigenvalues are $\\lambda_{k,l} = -(k^2+l^2+1/L_d^2)$.\nIf $L_d$ is finite, then $1/L_d^2  0$. Since $k^2+l^2 \\ge 0$, the sum $k^2+l^2+1/L_d^2$ is always strictly positive. Thus, all eigenvalues $\\lambda_{k,l}$ are strictly negative and non-zero. The operator is invertible, and a unique solution $\\psi$ exists for any given $q'$.\n\nIn the special barotropic limit where $L_d \\to \\infty$, the term $1/L_d^2$ vanishes, and the equation becomes the Poisson equation:\n$$\n\\nabla^2 \\psi(x,y) = q'(x,y)\n$$\nThe eigenvalues of the operator $L = \\nabla^2$ are $\\lambda_{k,l} = -(k^2+l^2)$. For the zero-wavenumber mode $(k,l)=(0,0)$, the eigenvalue is $\\lambda_{0,0} = 0$. This indicates that the operator is not invertible. A solution can exist only if the right-hand side $q'$ is orthogonal to the null space of the operator's adjoint. For the self-adjoint Laplacian on a periodic domain, this means $q'$ must be orthogonal to the constant function, which spans the null space. This orthogonality condition is the compatibility condition: the spatial mean of $q'$ must be zero.\n$$\n\\langle q' \\rangle = \\frac{1}{(2\\pi)^2} \\int_0^{2\\pi} \\int_0^{2\\pi} q'(x,y) \\,dx\\,dy = 0\n$$\nIf this condition is met, a solution $\\psi$ exists, but it is not unique: if $\\psi_0$ is a solution, then $\\psi_0 + C$ is also a solution for any constant $C$. Uniqueness is conventionally enforced by requiring the spatial mean of $\\psi$ to be zero.\n\n### Part 2: Algorithm for Spectral Inversion\n\nThe inversion of the QG PV equation is efficiently performed in spectral space using the Discrete Fourier Transform (DFT), commonly implemented as the Fast Fourier Transform (FFT). For a doubly periodic domain $[0, 2\\pi] \\times [0, 2\\pi]$ discretized onto an $N_x \\times N_y$ grid, the algorithm is as follows:\n\n1.  **Forward Transform**: Given the PV anomaly $q'(x_j, y_m)$ on the grid, compute its 2D DFT to obtain its Fourier coefficients $\\hat{q}'_{k,l}$:\n    $$\n    \\hat{q}'_{k,l} = \\mathcal{F}(q') = \\sum_{j=0}^{N_x-1} \\sum_{m=0}^{N_y-1} q'(x_j, y_m) e^{-i(kx_j + ly_m)}\n    $$\n2.  **Algebraic Inversion**: The PDE $(\\nabla^2 - 1/L_d^2)\\psi = q'$ transforms into an algebraic equation in Fourier space. The Fourier transform of the Laplacian operator on the periodic domain corresponds to multiplication by $-(k^2+l^2)$, where $k$ and $l$ are the integer wavenumbers.\n    $$\n    (-(k^2 + l^2) - \\frac{1}{L_d^2}) \\hat{\\psi}_{k,l} = \\hat{q}'_{k,l}\n    $$\n    The Fourier coefficients of the streamfunction $\\hat{\\psi}_{k,l}$ are then found by division:\n    $$\n    \\hat{\\psi}_{k,l} = \\frac{\\hat{q}'_{k,l}}{-(k^2 + l^2 + 1/L_d^2)}\n    $$\n    -   For a finite deformation radius $L_d$ (Helmholtz case), the denominator is never zero, so this division is performed for all wavenumber pairs $(k,l)$.\n    -   For the barotropic limit $L_d \\to \\infty$ (Poisson case), the denominator becomes $-(k^2+l^2)$, which is zero for the zero-wavenumber mode $(k,l)=(0,0)$. The compatibility condition ensures that $\\hat{q}'_{0,0}$ (the mean of $q'$) is also zero. This leads to a $0/0$ form. To ensure a unique solution, we enforce the condition that the mean of the streamfunction is zero, which translates to setting its zero-wavenumber Fourier coefficient to zero: $\\hat{\\psi}_{0,0} = 0$.\n\n3.  **Inverse Transform**: Reconstruct the streamfunction $\\psi(x_j, y_m)$ in physical space by applying the inverse 2D DFT to its coefficients:\n    $$\n    \\psi(x_j, y_m) = \\mathcal{F}^{-1}(\\hat{\\psi}) = \\frac{1}{N_x N_y} \\sum_{k=0}^{N_x-1} \\sum_{l=0}^{N_y-1} \\hat{\\psi}_{k,l} e^{i(kx_j + ly_m)}\n    $$\n4.  **Validation**: To validate the inversion, we reconstruct the PV anomaly, $q'_{\\text{rec}}$, from the computed streamfunction $\\psi$, and compare it to the original $q'$. This is best done in spectral space to avoid finite difference errors.\n    -   Compute the Fourier coefficients of the reconstructed PV:\n        $$\n        \\hat{q}'_{\\text{rec},k,l} = (-(k^2+l^2) - 1/L_d^2)\\hat{\\psi}_{k,l}\n        $$\n    -   By construction, $\\hat{q}'_{\\text{rec},k,l}$ should be identical to the original $\\hat{q}'_{k,l}$ up to floating-point precision.\n    -   Apply the inverse DFT to get $q'_{\\text{rec}}(x,y) = \\mathcal{F}^{-1}(\\hat{q}'_{\\text{rec}})$.\n    -   Calculate the maximum absolute error:\n        $$\n        E = \\max_{j,m} | q'_{\\text{rec}}(x_j, y_m) - q'(x_j, y_m) |\n        $$\n\n### Part 3: Implementation for Test Cases\n\nThe algorithm is implemented for a domain with $L_x = L_y = 2\\pi$ on a grid of $N_x = N_y = 64$ points. The integer wavenumbers $k$ and $l$ range from $-32$ to $31$. A 2D grid of these wavenumbers is used to construct the spectral representation of the differential operator. The algorithm is applied to the three specified test cases:\n-   **Case A ($L_d=1.0$, $q'_A = \\cos x + \\cos y$)**: A standard Helmholtz inversion. The forcing is composed of wavenumbers $(k,l) = (\\pm 1, 0)$ and $(0, \\pm 1)$.\n-   **Case B ($L_d=\\infty$, $q'_B = \\sin(2x) + \\sin(3y)$)**: A Poisson inversion. The forcing has zero mean, satisfying the compatibility condition. The zero-wavenumber mode $\\hat{\\psi}_{0,0}$ is set to zero.\n-   **Case C ($L_d=0.5$, $q'_C = 2.0$)**: A Helmholtz inversion where the forcing is a constant, corresponding to the zero-wavenumber mode $(k,l)=(0,0)$. This tests the non-singular handling of the mean component when $L_d$ is finite.\n\nThe following Python code implements this procedure and computes the reconstruction error $E$ for each case.",
            "answer": "```python\nimport numpy as np\nfrom scipy import fft\n\ndef solve_qg_inversion(q_prime, Ld, N, L):\n    \"\"\"\n    Inverts the QG PV equation using spectral methods.\n\n    Args:\n        q_prime (np.ndarray): 2D array of the QG PV anomaly.\n        Ld (float): Rossby deformation radius. Use np.inf for the barotropic limit.\n        N (int): Number of grid points in each dimension.\n        L (float): Domain size in each dimension.\n\n    Returns:\n        float: The maximum absolute reconstruction error.\n    \"\"\"\n    # 1. Fourier transform the PV anomaly\n    q_hat = fft.fft2(q_prime)\n\n    # 2. Set up wavenumber grid\n    # For a domain of size L=2*pi, the wavenumbers are integers.\n    # fft.fftfreq(N) * N gives the integer wavenumbers [0, 1, ..., N/2-1, -N/2, ..., -1]\n    k = fft.fftfreq(N) * N\n    l = fft.fftfreq(N) * N\n    K, L_grid = np.meshgrid(k, l)\n\n    # 3. Construct the spectral operator\n    # The operator is -(k^2 + l^2) - 1/Ld^2\n    is_barotropic = np.isinf(Ld)\n    if is_barotropic:\n        # Barotropic (Poisson) case: Ld - inf\n        spectral_op = -(K**2 + L_grid**2)\n    else:\n        # Baroclinic (Helmholtz) case\n        spectral_op = -(K**2 + L_grid**2) - 1.0/Ld**2\n\n    # 4. Solve for the streamfunction in spectral space\n    psi_hat = np.zeros_like(q_hat, dtype=complex)\n    \n    # Handle the zero-wavenumber mode for the Poisson case\n    if is_barotropic:\n        # Check compatibility condition (mean q' should be zero)\n        # q_hat[0, 0] is proportional to the mean. It should be numerically zero.\n        if np.abs(q_hat[0, 0])  1e-9:\n             # This case is not hit by the problem spec but is good practice\n            raise ValueError(\"Incompatible forcing for Poisson equation: mean is non-zero.\")\n\n        # For k=l=0, the operator is 0. We set psi_hat[0,0]=0 for a unique solution.\n        # For all other wavenumbers, the operator is non-zero.\n        non_zero_k = spectral_op != 0\n        psi_hat[non_zero_k] = q_hat[non_zero_k] / spectral_op[non_zero_k]\n        psi_hat[0, 0] = 0.0 + 0.0j # Enforce zero mean for psi\n    else:\n        # For the Helmholtz case, the operator is never zero.\n        psi_hat = q_hat / spectral_op\n\n    # 5. Reconstruct the PV anomaly to validate the inversion\n    q_rec_hat = spectral_op * psi_hat\n    \n    # In the barotropic case, q_hat[0,0] was already checked to be zero, and\n    # psi_hat[0,0] was set to zero, so spectral_op[0,0]*psi_hat[0,0] = 0*0 = 0.\n    # This correctly reproduces q_hat[0,0].\n\n    # 6. Transform back to physical space\n    q_rec = fft.ifft2(q_rec_hat)\n\n    # 7. Calculate the maximum absolute difference\n    # The result of ifft2 should be real since the original data was real\n    # and the operations preserve conjugacy. We take .real to discard\n    # negligible imaginary parts from floating-point inaccuracies.\n    error = np.max(np.abs(q_rec.real - q_prime))\n    \n    return error\n\ndef solve():\n    \"\"\"\n    Main function to run the test cases and print the results.\n    \"\"\"\n    # Common parameters\n    N = 64\n    L = 2.0 * np.pi\n    \n    # Grid setup\n    x = np.linspace(0, L, N, endpoint=False)\n    y = np.linspace(0, L, N, endpoint=False)\n    X, Y = np.meshgrid(x, y)\n\n    # --- Test Cases ---\n    test_cases = [\n        # Case A: Helmholtz, happy path\n        {\n            \"name\": \"A\",\n            \"Ld\": 1.0,\n            \"q_prime_func\": lambda x, y: np.cos(x) + np.cos(y)\n        },\n        # Case B: Poisson, barotropic limit\n        {\n            \"name\": \"B\",\n            \"Ld\": np.inf,\n            \"q_prime_func\": lambda x, y: np.sin(2*x) + np.sin(3*y)\n        },\n        # Case C: Helmholtz, zero-wavenumber forcing\n        {\n            \"name\": \"C\",\n            \"Ld\": 0.5,\n            \"q_prime_func\": lambda x, y: 2.0 + 0*x  # Ensure it is a 2D array\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        Ld = case[\"Ld\"]\n        q_prime = case[\"q_prime_func\"](X, Y)\n        \n        error = solve_qg_inversion(q_prime, Ld, N, L)\n        results.append(error)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}