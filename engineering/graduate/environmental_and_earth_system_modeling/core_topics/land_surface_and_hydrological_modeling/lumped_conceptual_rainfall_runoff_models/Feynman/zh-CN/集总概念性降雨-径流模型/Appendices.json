{
    "hands_on_practices": [
        {
            "introduction": "集总式概念模型要求整个流域使用单一的、具有代表性的降水输入值。本练习将介绍泰森多边形法（Thiessen polygon method），这是一种从离散的雨量站数据计算流域面平均降水量的标准技术。通过这个实践，你将掌握为模型准备驱动数据的基本技能，并理解空间异质性信息是如何在集总过程中被平均化的。",
            "id": "3890221",
            "problem": "一个单一流域将采用日时间步长的集总式概念性降雨径流模型进行驱动。记为 $P_{t}$ 的每日全流域降水量输入，必须根据泰森多边形假设，通过对点测量值进行面积平均来获得。泰森框架将流域划分为多个互不重叠的子区域，每个子区域与一个雨量站相关联，使得降水场被视为分段常数，并且在其多边形内部等于该雨量站的观测值。在所讨论的当天，$G_{1}$到$G_{5}$五个雨量站有有效的日总降水量。它们的泰森多边形与流域的相交区域面积以及观测到的日降水量如下所示。\n\n- 雨量站 $G_{1}$：面积 $A_{1} = 42.3 \\,\\mathrm{km}^{2}$，降水量 $P_{1} = 14.2 \\,\\mathrm{mm \\, d^{-1}}$。\n- 雨量站 $G_{2}$：面积 $A_{2} = 25.7 \\,\\mathrm{km}^{2}$，降水量 $P_{2} = 0.0 \\,\\mathrm{mm \\, d^{-1}}$。\n- 雨量站 $G_{3}$：面积 $A_{3} = 18.9 \\,\\mathrm{km}^{2}$，降水量 $P_{3} = 5.5 \\,\\mathrm{mm \\, d^{-1}}$。\n- 雨量站 $G_{4}$：面积 $A_{4} = 33.4 \\,\\mathrm{km}^{2}$，降水量 $P_{4} = 22.1 \\,\\mathrm{mm \\, d^{-1}}$。\n- 雨量站 $G_{5}$：面积 $A_{5} = 29.7 \\,\\mathrm{km}^{2}$，降水量 $P_{5} = 9.8 \\,\\mathrm{mm \\, d^{-1}}$。\n\n假设泰森多边形完全覆盖流域，即流域总面积满足 $A = \\sum_{i=1}^{5} A_{i}$。仅使用面积平均的基本定义（即由总面积归一化的面积分）以及泰森假设（即每个多边形内的降水量为分段常数且等于该雨量站的值），计算该流域最终的集总式日降水量输入 $P_{t}$。将最终答案以毫米/天（mm $\\mathrm{d^{-1}}$）为单位表示，并四舍五入到四位有效数字。",
            "solution": "问题陈述已经过验证，被认为是有效的。它具有科学依据、问题良定、客观，并包含推导唯一解所需的所有必要信息。该问题要求使用泰森多边形法计算流域的面积平均降水量，这是水文学中的一个标准且明确定义的方法。\n\n在一个流域范围 $\\mathcal{A}$ 上，对于一个空间变化的降水场 $P(\\mathbf{x})$，其面积平均降水量 $P_{t}$ 的基本定义由该场在面积上的积分并由总面积 $A$ 归一化给出：\n$$P_{t} = \\frac{1}{A} \\int_{\\mathcal{A}} P(\\mathbf{x}) \\, dA$$\n\n泰森多边形法将这个连续问题离散化。它假设流域面积 $\\mathcal{A}$ 被划分为一组 $N$ 个不重叠的子区域或多边形 $\\mathcal{A}_{i}$，其中 $i = 1, 2, \\dots, N$。每个多边形 $\\mathcal{A}_{i}$ 与一个雨量站 $G_{i}$ 相关联。其核心假设是，降水在整个区域上是分段常数，在任何多边形 $\\mathcal{A}_{i}$ 内的值都等于雨量站 $G_{i}$ 的观测值 $P_{i}$。\n在数学上，这意味着：\n$$P(\\mathbf{x}) = P_{i} \\quad \\text{for all } \\mathbf{x} \\in \\mathcal{A}_{i}$$\n\n鉴于这些多边形构成了对流域的一个划分，总面积是各子区域面积之和，$A = \\sum_{i=1}^{N} A_{i}$，其中 $A_{i}$ 是多边形 $\\mathcal{A}_{i}$ 的面积。对整个流域 $\\mathcal{A}$ 的积分可以分解为对每个子区域的积分之和：\n$$P_{t} = \\frac{1}{A} \\sum_{i=1}^{N} \\int_{\\mathcal{A}_{i}} P(\\mathbf{x}) \\, dA$$\n\n由于在每个子区域 $\\mathcal{A}_{i}$ 内 $P(\\mathbf{x}) = P_{i}$（一个常数），我们可以写出：\n$$\\int_{\\mathcal{A}_{i}} P(\\mathbf{x}) \\, dA = \\int_{\\mathcal{A}_{i}} P_{i} \\, dA = P_{i} \\int_{\\mathcal{A}_{i}} dA = P_{i} A_{i}$$\n\n将此结果代回 $P_{t}$ 的表达式中，我们得到泰森多边形法的通用公式：\n$$P_{t} = \\frac{1}{A} \\sum_{i=1}^{N} P_{i} A_{i} = \\frac{\\sum_{i=1}^{N} P_{i} A_{i}}{\\sum_{i=1}^{N} A_{i}}$$\n该公式表示雨量站降水量的加权平均值，其中权重是各自多边形的面积。\n\n对于这个问题，我们有 $N=5$ 个雨量站。给定的数据如下：\n- 雨量站 $G_{1}$：$A_{1} = 42.3 \\,\\mathrm{km}^{2}$，$P_{1} = 14.2 \\,\\mathrm{mm \\, d^{-1}}$\n- 雨量站 $G_{2}$：$A_{2} = 25.7 \\,\\mathrm{km}^{2}$，$P_{2} = 0.0 \\,\\mathrm{mm \\, d^{-1}}$\n- 雨量站 $G_{3}$：$A_{3} = 18.9 \\,\\mathrm{km}^{2}$，$P_{3} = 5.5 \\,\\mathrm{mm \\, d^{-1}}$\n- 雨量站 $G_{4}$：$A_{4} = 33.4 \\,\\mathrm{km}^{2}$，$P_{4} = 22.1 \\,\\mathrm{mm \\, d^{-1}}$\n- 雨量站 $G_{5}$：$A_{5} = 29.7 \\,\\mathrm{km}^{2}$，$P_{5} = 9.8 \\,\\mathrm{mm \\, d^{-1}}$\n\n首先，我们计算流域总面积 $A$，即各个多边形面积之和：\n$$A = \\sum_{i=1}^{5} A_{i} = A_{1} + A_{2} + A_{3} + A_{4} + A_{5}$$\n$$A = 42.3 + 25.7 + 18.9 + 33.4 + 29.7 = 150.0 \\,\\mathrm{km}^{2}$$\n\n接下来，我们计算分子，即每个雨量站的降水量与其对应面积的乘积之和：\n$$\\sum_{i=1}^{5} P_{i} A_{i} = P_{1}A_{1} + P_{2}A_{2} + P_{3}A_{3} + P_{4}A_{4} + P_{5}A_{5}$$\n$$P_{1}A_{1} = (14.2)(42.3) = 600.66 \\,\\mathrm{mm \\, d^{-1} \\cdot km^{2}}$$\n$$P_{2}A_{2} = (0.0)(25.7) = 0.0 \\,\\mathrm{mm \\, d^{-1} \\cdot km^{2}}$$\n$$P_{3}A_{3} = (5.5)(18.9) = 103.95 \\,\\mathrm{mm \\, d^{-1} \\cdot km^{2}}$$\n$$P_{4}A_{4} = (22.1)(33.4) = 738.14 \\,\\mathrm{mm \\, d^{-1} \\cdot km^{2}}$$\n$$P_{5}A_{5} = (9.8)(29.7) = 291.06 \\,\\mathrm{mm \\, d^{-1} \\cdot km^{2}}$$\n\n将这些乘积相加：\n$$\\sum_{i=1}^{5} P_{i} A_{i} = 600.66 + 0.0 + 103.95 + 738.14 + 291.06 = 1733.81 \\,\\mathrm{mm \\, d^{-1} \\cdot km^{2}}$$\n\n最后，我们计算面积平均降水量 $P_{t}$：\n$$P_{t} = \\frac{\\sum_{i=1}^{5} P_{i} A_{i}}{\\sum_{i=1}^{5} A_{i}} = \\frac{1733.81 \\,\\mathrm{mm \\, d^{-1} \\cdot km^{2}}}{150.0 \\,\\mathrm{km}^{2}}$$\n$$P_{t} = 11.558733... \\,\\mathrm{mm \\, d^{-1}}$$\n\n问题要求答案四舍五入到四位有效数字。\n前四位有效数字是 $1$、$1$、$5$ 和 $5$。第五位有效数字是 $8$，大于或等于 $5$，因此我们将第四位有效数字向上进位。\n$$P_{t} \\approx 11.56 \\,\\mathrm{mm \\, d^{-1}}$$",
            "answer": "$$\\boxed{11.56}$$"
        },
        {
            "introduction": "掌握了输入数据的准备后，我们将深入模型的核心。本练习将引导你从最基本的质量守恒原理出发，推导出一个简单的线性水库模型的水平衡方程。通过分析模型在稳定驱动力下的行为，你将深刻理解模型的稳定性、平衡态以及参数的物理意义等核心概念。",
            "id": "3890273",
            "problem": "考虑一个由单一控制体（土壤-植被蓄水体）表示的空间集总式流域，其在离散的月度时间 $t \\in \\{0,1,2,\\dots\\}$ 的空间平均蓄水量为 $S_t$。从控制体的质量守恒定律出发：一个时间步长内蓄水量的变化等于总入流量减去总出流量。针对月度时间步长，假设以下符合物理规律的标准假设：(i) 在每个月内，降水量 $P_t$ 和实际蒸散发量 $E_t$ 可被视为在整个月份内积分的时间上均匀的通量；(ii) 径流量 $Q_t$（地表和地下径流）和向地下水的深层渗漏量 $L_t$ 与当前蓄水量成正比，这与月度出流量的线性水库近似一致。使用按流域面积归一化的等效水深单位，因此通量的单位为毫米/月（mm/month），蓄水量的单位为毫米（mm）。\n\n1. 仅使用一个月的离散质量守恒形式和出流量的线性水库闭合关系，推导集总式蓄水体的前向欧拉月度水量平衡更新方程，并明确定义每个符号：$S_{t+1}$、$S_t$、$P_t$、$E_t$、$Q_t$、$L_t$、$k$ 和 $\\ell$。你的推导必须从“蓄水量的离散变化等于入流量减去出流量”这一陈述开始，并且不得预设任何目标公式。\n\n2. 在 $P_t=\\bar{P}$ 和 $E_t=\\bar{E}$（对所有 $t$）的稳定月度驱动力下，将得到的线性时不变递推关系写成 $S_{t+1}=r S_t + b$ 的形式，并推导 $S_t$ 作为 $t$、$S_0$、$r$ 和 $b$ 的函数的闭式解。陈述 $r$ 满足渐近稳定性的条件，并根据出流系数对其进行物理解释。\n\n3. 考虑参数化 $Q_t = k S_t$ 和 $L_t = \\ell S_t$，其中 $k$ 和 $\\ell$ 是满足 $0  k + \\ell  1$ 的常数。给定初始蓄水量 $S_0 = 50\\,\\mathrm{mm}$，恒定的月度驱动力 $\\bar{P}=70\\,\\mathrm{mm}$ 和 $\\bar{E}=30\\,\\mathrm{mm}$，以及出流系数 $k=0.20$ 和 $\\ell=0.05$，计算第 $t=12$ 个月（即一年后）开始时的蓄水量 $S_{12}$。将最终答案以 $\\mathrm{mm}$ 为单位表示，并四舍五入到四位有效数字。",
            "solution": "该问题在集总式水文模型中提出了一个有效且适定的情景。它以质量守恒原理为科学基础，并使用了一种标准的简化方法——线性水库模型。问题本身是独立的，为每个部分提供了所有必要的数据和定义。其结构逻辑清晰，从推导到通解，再到具体的数值应用。我现在开始解答。\n\n### 第1部分：水量平衡更新方程的推导\n\n基本原理是代表该流域的控制体的质量守恒。在一个月的离散时间步长内，从时间 $t$ 到 $t+1$，蓄水量的变化 $\\Delta S$ 等于总质量流入减去总质量流出。\n\n设 $S_t$ 为第 $t$ 个月初流域的蓄水量，以等效水深单位毫米（mm）计量。该月内蓄水量的变化为 $S_{t+1} - S_t$。\n\n在第 $t$ 个月内，流入控制体的仅为降水量 $P_t$（单位：mm）。\n\n在第 $t$ 个月内，从控制体流出的包括实际蒸散发量 $E_t$（单位：mm）、径流量 $Q_t$（单位：mm）和向地下水的深层滲漏量 $L_t$（单位：mm）。\n\n因此，离散质量平衡方程为：\n$$S_{t+1} - S_t = \\text{入流量} - \\text{出流量}$$\n$$S_{t+1} - S_t = P_t - (E_t + Q_t + L_t)$$\n\n问题指明，由径流和渗漏产生的出流量被建模为线性水库。这意味着它们与水库中的蓄水量成正比。使用前向欧拉（显式）时间步进格式，这一个月的出流量被视为与月初的蓄水量 $S_t$ 成正比。因此我们可以写出：\n$$Q_t = k S_t$$\n$$L_t = \\ell S_t$$\n其中 $k$ 和 $\\ell$ 分别是径流和渗漏的比例系数。它们的单位实际上是每月（$month^{-1}$）。\n\n将这些线性水库闭合关系代入质量平衡方程：\n$$S_{t+1} - S_t = P_t - E_t - k S_t - \\ell S_t$$\n\n为了推导 $S_{t+1}$ 的更新规则，我们重排方程求解 $S_{t+1}$：\n$$S_{t+1} = S_t + P_t - E_t - k S_t - \\ell S_t$$\n\n合并包含 $S_t$ 的项：\n$$S_{t+1} = (1 - k - \\ell) S_t + (P_t - E_t)$$\n\n这就是集总式蓄水体的前向欧拉月度水量平衡更新方程。\n\n各符号定义如下：\n-   $S_t$: 第 $t$ 个月初流域的蓄水量（单位：mm）。\n-   $S_{t+1}$: 第 $t+1$ 个月初流域的蓄水量（单位：mm）。\n-   $P_t$: 第 $t$ 个月内的总降水量（单位：mm）。\n-   $E_t$: 第 $t$ 个月内的总实际蒸散发量（单位：mm）。\n-   $Q_t$: 第 $t$ 个月内的总径流量（单位：mm），模型为 $Q_t = k S_t$。\n-   $L_t$: 第 $t$ 个月内的总深层渗漏量（单位：mm），模型为 $L_t = \\ell S_t$。\n-   $k$: 径流比例系数（单位：每月）。\n-   $\\ell$: 深层渗漏比例系数（单位：每月）。\n\n### 第2部分：稳定驱动力下的解\n\n在稳定的月度驱动力下，降水量和蒸散发量对所有时间都是恒定的：$P_t = \\bar{P}$ 和 $E_t = \\bar{E}$。将这些代入推导出的水量平衡方程，得到：\n$$S_{t+1} = (1 - k - \\ell) S_t + (\\bar{P} - \\bar{E})$$\n这是一个形如 $S_{t+1} = r S_t + b$ 的线性时不变（LTI）一阶递推关系，其中：\n-   反馈因子为 $r = 1 - k - \\ell$。\n-   恒定驱动项为 $b = \\bar{P} - \\bar{E}$。\n\n为了求出 $S_t$ 的闭式解，我们可以分析其与平衡态 $S_{\\infty}$ 的偏差。平衡态是该递推关系的不动点，通过设 $S_{t+1} = S_t = S_{\\infty}$ 求得：\n$$S_{\\infty} = r S_{\\infty} + b$$\n$$S_{\\infty}(1-r) = b$$\n在 $r \\neq 1$ 的条件下，平衡蓄水量为 $S_{\\infty} = \\frac{b}{1-r}$。在我们的模型中，$1-r = 1 - (1-k-\\ell) = k+\\ell$。由于给定 $k>0$ 和 $\\ell>0$，所以 $k+\\ell > 0$，因此 $r \\neq 1$。\n\n设 $\\delta_t = S_t - S_{\\infty}$ 为时间 $t$ 时与平衡态的偏差。那么 $S_t = \\delta_t + S_{\\infty}$。代入递推关系：\n$$(\\delta_{t+1} + S_{\\infty}) = r(\\delta_t + S_{\\infty}) + b$$\n$$\\delta_{t+1} + S_{\\infty} = r\\delta_t + rS_{\\infty} + b$$\n由于 $S_{\\infty} = rS_{\\infty} + b$，这些项相互抵消，留下一个关于偏差的齐次递推关系：\n$$\\delta_{t+1} = r\\delta_t$$\n这是一个等比数列，其解为 $\\delta_t = r^t \\delta_0$，其中 $\\delta_0 = S_0 - S_{\\infty}$ 是初始偏差。\n\n代回 $S_t$：\n$$S_t - S_{\\infty} = r^t (S_0 - S_{\\infty})$$\n$S_t$ 的闭式解为：\n$$S_t = S_{\\infty} + r^t (S_0 - S_{\\infty})$$\n代入 $S_{\\infty}$、$r$ 和 $b$ 的表达式：\n$$S_t = \\frac{\\bar{P} - \\bar{E}}{k + \\ell} + (1 - k - \\ell)^t \\left(S_0 - \\frac{\\bar{P} - \\bar{E}}{k + \\ell}\\right)$$\n\n为使系统渐近稳定，蓄水量 $S_t$ 必须在 $t \\to \\infty$ 时收敛到平衡值 $S_{\\infty}$。这要求 $r^t (S_0 - S_{\\infty})$ 项在 $t \\to \\infty$ 时趋于零。这当且仅当 $|r|  1$ 时发生。\n\n稳定性条件是 $|r|  1$，即 $|1 - k - \\ell|  1$。这个不等式可以写作：\n$$-1  1 - k - \\ell  1$$\n右边的不等式 $1 - k - \\ell  1$ 意味着 $-k-\\ell  0$，即 $k+\\ell > 0$。这在物理上是必要的：为了使系统稳定，必须有出流路径，因此总出流系数必须为正。\n左边的不等式 $-1  1 - k - \\ell$ 意味着 $k+\\ell  2$。因此，数学上的稳定性条件是 $0  k+\\ell  2$。\n从物理上讲，$k+\\ell$ 代表在一个月内作为出流排出的水量占总蓄水量的比例。条件 $k+\\ell > 0$ 意味着出流量随蓄水量增加而增加，提供了一种稳定的负反馈。条件 $k+\\ell  2$ 确保了这种反馈不会强到引起发散的振荡。一个在物理上更具限制性且无振荡的条件是 $0  k+\\ell \\le 1$，这意味着 $0 \\le r  1$。问题中给出的参数落在此范围内。\n\n### 第3部分：$S_{12}$ 的数值计算\n\n我们已知以下参数值：\n-   初始蓄水量 $S_0 = 50\\,\\mathrm{mm}$\n-   恒定月降水量 $\\bar{P} = 70\\,\\mathrm{mm}$\n-   恒定月实际蒸散发量 $\\bar{E} = 30\\,\\mathrm{mm}$\n-   径流系数 $k = 0.20$\n-   渗漏系数 $\\ell = 0.05$\n\n首先，我们计算递推关系 $S_{t+1}=r S_t + b$ 的参数 $r$ 和 $b$：\n$$r = 1 - k - \\ell = 1 - 0.20 - 0.05 = 0.75$$\n$$b = \\bar{P} - \\bar{E} = 70 - 30 = 40\\,\\mathrm{mm}$$\n\n接下来，我们计算平衡蓄水量 $S_{\\infty}$：\n$$S_{\\infty} = \\frac{b}{1-r} = \\frac{40}{1 - 0.75} = \\frac{40}{0.25} = 160\\,\\mathrm{mm}$$\n\n现在我们使用第2部分推导的闭式解来计算第 $t=12$ 个月的蓄水量，记为 $S_{12}$：\n$$S_{t} = S_{\\infty} + r^{t} (S_0 - S_{\\infty})$$\n$$S_{12} = 160 + (0.75)^{12} (50 - 160)$$\n$$S_{12} = 160 + (0.75)^{12} (-110)$$\n$$S_{12} = 160 - 110 \\times (0.75)^{12}$$\n\n我们计算 $(0.75)^{12}$ 的数值：\n$$(0.75)^{12} \\approx 0.031676352$$\n现在，将此值代入 $S_{12}$ 的表达式中：\n$$S_{12} \\approx 160 - 110 \\times 0.031676352$$\n$$S_{12} \\approx 160 - 3.48439872$$\n$$S_{12} \\approx 156.51560128\\,\\mathrm{mm}$$\n\n问题要求将最终答案四舍五入到四位有效数字。前四位有效数字是 $1$、$5$、$6$ 和 $5$。第五位有效数字是 $1$，小于 $5$，所以我们向下舍入（截断）。\n$$S_{12} \\approx 156.5\\,\\mathrm{mm}$$",
            "answer": "$$\\boxed{156.5}$$"
        },
        {
            "introduction": "这项综合性练习模拟了水文模型研究者的完整工作流程，将理论与实践紧密结合。你将需要率定一个概念模型以匹配“观测”数据，在独立的验证期内评估其性能，并使用如纳什效率系数（NSE）和水量平衡闭合误差等高级诊断工具来解释模型与数据之间的差异。这个实践旨在揭示模型在真实世界应用中面临的挑战，例如模型结构误差、数据不确定性以及未被模型描述的物理过程。",
            "id": "3890275",
            "problem": "构建一个完整的、可运行的程序，该程序实现、率定并评估一个单水库集总式概念性降雨-径流模型，以量化率定期和验证期的水量平衡闭合误差，然后将差异解释为数据误差、渗漏或模型中的结构性误设。该模型必须源自应用于集总控制体的质量守恒定律。对于一个蓄水量为 $S_t$（单位：毫米，表示为 $\\mathrm{mm}$）、降水输入为 $P_t$（单位：$\\mathrm{mm/month}$）、潜在蒸散发为 $PET_t$（单位：$\\mathrm{mm/month}$）、实际蒸散发为 $\\mathrm{AET}_t$（单位：$\\mathrm{mm/month}$）以及河流径流量为 $Q_t$（单位：$\\mathrm{mm/month}$）的集总水桶模型，其基本质量守恒定律为\n$$\nS_{t+1} - S_t = P_t - \\mathrm{AET}_t - Q_t,\n$$\n其中月份索引 $t$ 以离散的月度步长推进。该模型必须将径流参数化为\n$$\nQ_t^{\\mathrm{sim}} = k_q \\, S_t + R_t,\n$$\n其中 $k_q$（单位：$\\mathrm{month}^{-1}$）是待率定的径流系数，$R_t$（单位：$\\mathrm{mm/month}$）是一个保证蓄水容量约束的溢流项；如果计算出的蓄水量将超过容量 $C$（单位：$\\mathrm{mm}$），则超出的部分将成为瞬时径流。蓄水容量 $C$ 也必须进行率定。实际蒸散发必须建模为潜在蒸散发的一个由蓄水量调节的分数：\n$$\n\\mathrm{AET}_t = PET_t \\cdot \\min\\!\\left(\\frac{S_t}{C}, 1\\right).\n$$\n蓄水量更新必须强制执行物理边界：\n$$\nS_{t+1} = \\max\\!\\left(0, \\min\\!\\left(C, S_t + P_t - \\mathrm{AET}_t - k_q S_t\\right)\\right),\n$$\n并且溢流必须通过以下方式计算：\n$$\nR_t = \\max\\!\\left(0, S_t + P_t - \\mathrm{AET}_t - k_q S_t - C\\right).\n$$\n率定必须通过在指定的率定窗口内最小化 $Q_t^{\\mathrm{sim}}$ 与观测径流 $Q_t^{\\mathrm{obs}}$ 之间的误差平方和来执行。纳什-萨特克利夫效率（NSE），定义为\n$$\n\\mathrm{NSE} = 1 - \\frac{\\sum_t \\left(Q_t^{\\mathrm{sim}} - Q_t^{\\mathrm{obs}}\\right)^2}{\\sum_t \\left(Q_t^{\\mathrm{obs}} - \\overline{Q^{\\mathrm{obs}}}\\right)^2},\n$$\n其中 $\\overline{Q^{\\mathrm{obs}}}$ 是该时期内 $Q_t^{\\mathrm{obs}}$ 的算术平均值，必须为率定期和验证期计算，以反映模型的结构充分性。\n\n将任一时期 $[t_0, t_1)$ 内的水量平衡闭合误差定义为\n$$\nE = \\sum_{t=t_0}^{t_1 - 1} P_t - \\sum_{t=t_0}^{t_1 - 1} \\mathrm{AET}_t - \\sum_{t=t_0}^{t_1 - 1} Q_t^{\\mathrm{obs}} - \\left(S_{t_1} - S_{t_0}\\right),\n$$\n并报告其相对于该时期总降水量的分数形式，\n$$\nE^{\\mathrm{frac}} = \\frac{E}{\\sum_{t=t_0}^{t_1 - 1} P_t}.\n$$\n所有量纲必须为 $\\mathrm{mm}$ 或 $\\mathrm{mm/month}$，最终的分数闭合误差必须报告为无量纲的小数值。对于率定后的模型，模拟第一个月的初始蓄水量应固定为 $S_0 = 0$ $\\mathrm{mm}$。观测径流必须被视为外部测量值，不一定满足模型方程，而建模的 $\\mathrm{AET}_t$ 和 $S_t$ 则源于模型动态。\n\n差异类型的分类必须使用以下映射编码为整数：渗漏 $\\rightarrow$ $1$，数据误差 $\\rightarrow$ $-1$，结构性误设 $\\rightarrow$ $0$，基于同时应用于率定期和验证期的以下规则：\n- 设闭合误差阈值为 $\\tau_E = 0.05$，纳什-萨特克利夫效率阈值为 $\\tau_{\\mathrm{NSE}} = 0.85$。\n- 如果在两个时期内 $E^{\\mathrm{frac}}$ 均为正且 $|E^{\\mathrm{frac}}| \\ge \\tau_E$，并且两个时期内的 $\\mathrm{NSE} \\ge \\tau_{\\mathrm{NSE}}$，则分类为渗漏（$1$）。\n- 如果在两个时期内 $E^{\\mathrm{frac}}$ 均为负且 $|E^{\\mathrm{frac}}| \\ge \\tau_E$，并且两个时期内的 $\\mathrm{NSE} \\ge \\tau_{\\mathrm{NSE}}$，则分类为数据误差（$-1$）。\n- 否则，分类为结构性误设（$0$）。\n\n您的程序必须使用以下综合数据集生成器设置和测试套件。基础的真实降水和潜在蒸散发序列（单位：$\\mathrm{mm/month}$）是固定且已知的：\n- $t = 1, \\dots, 18$ 月的基础降水 $P_t^{\\mathrm{true}}$：\n$$\n[80, 60, 40, 30, 20, 25, 40, 50, 90, 120, 150, 100, 70, 50, 35, 25, 20, 110].\n$$\n- $t = 1, \\dots, 18$ 月的基础潜在蒸散发 $PET_t$：\n$$\n[50, 60, 80, 100, 110, 120, 110, 90, 70, 60, 50, 60, 70, 80, 90, 100, 90, 60].\n$$\n率定窗口为第 $1$ 至 $12$ 月（含）（索引 $t = 1, \\dots, 12$），验证窗口为第 $13$ 至 $18$ 月（含）（索引 $t = 13, \\dots, 18$）。对于每个测试用例，必须通过模拟一个可能具有与率定模型不同特征的真实系统，然后应用指定的扰动来生成观测径流 $Q_t^{\\mathrm{obs}}$。必须使用固定的随机种子 $42$，添加标准差为 $\\sigma$（单位：$\\mathrm{mm/month}$）的零均值高斯噪声作为随机径流噪声。\n\n四个测试用例是指定 $(k_q^{\\mathrm{true}}, C^{\\mathrm{true}}, S_0^{\\mathrm{true}}, L, b, \\sigma)$ 的元组，其中 $k_q^{\\mathrm{true}}$ 是用于生成 $Q_t^{\\mathrm{true}}$ 的真实径流系数，$C^{\\mathrm{true}}$ 是真实容量，$S_0^{\\mathrm{true}}$ 是用于生成 $Q_t^{\\mathrm{true}}$ 的真实初始蓄水量，$L$ 是从观测径流中减去的恒定月度渗漏损失（单位：$\\mathrm{mm/month}$），$b$ 是应用于率定模型中 $P_t$ 的降水测量偏差因子（无量纲），$\\sigma$ 是径流噪声标准差（单位：$\\mathrm{mm/month}$）。在结构性误设的情况下，$k_q^{\\mathrm{true}}$ 如下文所述随季节变化。\n- 用例 $1$（良好闭合基线）：$(0.15, 300, 100, 0, 1.0, 2)$。\n- 用例 $2$（未观测到的渗漏）：$(0.15, 300, 100, 8, 1.0, 2)$。\n- 用例 $3$（降水漏测数据误差）：$(0.15, 300, 100, 0, 0.9, 2)$。\n- 用例 $4$（结构性误设）：$(\\text{季节性 } k_q^{\\mathrm{true}}, 300, 100, 0, 1.0, 2)$，其中 $t = 1, \\dots, 12$ 时 $k_q^{\\mathrm{true}}(t) = 0.15$，$t = 13, \\dots, 18$ 时 $k_q^{\\mathrm{true}}(t) = 0.30$。\n\n对于所有用例，必须通过使用 $P_t^{\\mathrm{true}}$、$PET_t$、指定的 $k_q^{\\mathrm{true}}$、$C^{\\mathrm{true}}$ 和 $S_0^{\\mathrm{true}}$ 模拟“真实”系统来内部生成 $Q_t^{\\mathrm{true}}$，溢流处理方式与率定模型相同。然后通过应用渗漏 $L$（从 $Q_t^{\\mathrm{true}}$ 中减去 $L$ 并在零处截断）并添加随机种子为 $42$ 的随机噪声来构建观测径流。对于率定模型，降水信号为 $P_t^{\\mathrm{meas}} = b \\cdot P_t^{\\mathrm{true}}$，初始蓄水量固定为 $S_0 = 0$ $\\mathrm{mm}$。\n\n率定必须在 $k_q \\in [0.05, 0.45]$（单位：$\\mathrm{month}^{-1}$）和 $C \\in [100, 500]$ $\\mathrm{mm}$ 的范围内搜索，使用步长 $\\Delta k_q = 0.005$ 和 $\\Delta C = 10$ $\\mathrm{mm}$ 的离散网格，以最小化率定误差平方和 $\\sum_{t=1}^{12} (Q_t^{\\mathrm{sim}} - Q_t^{\\mathrm{obs}})^2$。率定后，计算率定期和验证期的 $E^{\\mathrm{frac}}$，计算两个时期的纳什-萨特克利夫效率，然后使用上述规则进行分类。将每个报告的分数误差四舍五入到三位小数。\n\n您的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表的结果，每个测试用例贡献一个三元素列表 $[E^{\\mathrm{frac}}_{\\mathrm{cal}}, E^{\\mathrm{frac}}_{\\mathrm{val}}, \\text{class}]$（类别编码为 $1$、$-1$ 或 $0$）：例如，$[[0.012,-0.034,1],[\\dots]]$。最终输出中的所有浮点数必须报告为四舍五入到三位的小数，所有分类代码必须为整数。",
            "solution": "该问题陈述经过了严格验证，被认为是有效的。它科学地基于应用于水文系统的质量守恒原理，问题设定良好，具有清晰完整的方程、参数和程序，并且其表述是客观的。该任务要求实现、率定和评估一个集总式概念性降雨-径流模型，这是环境系统建模中一个标准且不简单的练习。\n\n解决方案的设计遵循了一系列逻辑步骤：综合数据生成、模型实现、通过网格搜索进行率定、使用标准水文指标进行评估，然后基于规则对模型-数据差异进行分类。\n\n**1. 模型构建与实现**\n\n问题的核心是一个单水库水量平衡模型，遵循质量守恒原理。对于离散时间步长 $t$，蓄水量 $S$ 的变化是流入和流出之差：\n$$\nS_{t+1} - S_t = P_t - \\mathrm{AET}_t - Q_t\n$$\n其中 $P_t$ 是降水量，$\\mathrm{AET}_t$ 是实际蒸散发量，$Q_t$ 是河流径流量。所有量纲均以深度（$mm$）或单位时间深度（$mm/month$）表示。\n\n该模型将流出量参数化为当前状态 $S_t$ 的函数：\n- **实际蒸散发（$\\mathrm{AET}_t$）**：这被建模为受可用能量（由潜在蒸散发，$PET_t$ 表示）或水库中可用水量限制。该公式使用随蓄水量线性扩展直至达到容量 $C$ 的方式：\n  $$\n  \\mathrm{AET}_t = PET_t \\cdot \\min\\!\\left(\\frac{S_t}{C}, 1\\right)\n  $$\n- **河流径流量（$Q_t^{\\mathrm{sim}}$）**：这由两部分组成：一个与蓄水量成比例的缓慢释放流，由径流系数 $k_q$ 控制；以及一个当蓄水容量 $C$ 被超过时发生的快速响应溢流 $R_t$。\n  $$\n  Q_t^{\\mathrm{sim}} = k_q \\, S_t + R_t\n  $$\n\n完整的状态更新按特定顺序执行，以确保满足物理约束。首先，我们通过对所有通量求和来计算潜在的下一时刻蓄水量 $S_{t+1}^{\\mathrm{pot}}$：\n$$\nS_{t+1}^{\\mathrm{pot}} = S_t + P_t - \\mathrm{AET}_t - k_q S_t\n$$\n然后，蓄水量被限制为非负，任何超过容量 $C$ 的多余部分被分配到溢流项 $R_t$ 中。\n$$\nS_{t+1} = \\max\\!\\left(0, \\min\\!\\left(C, S_{t+1}^{\\mathrm{pot}}\\right)\\right)\n$$\n$$\nR_t = \\max\\!\\left(0, S_{t+1}^{\\mathrm{pot}} - C\\right)\n$$\n一个专用的 `run_model` 函数封装了此逻辑，它接受 $P_t$ 和 $PET_t$ 的时间序列以及模型参数（$k_q, C, S_0$）作为输入，并返回模拟的蓄水量 $S_t$、实际蒸散发 $\\mathrm{AET}_t$ 和径流量 $Q_t^{\\mathrm{sim}}$ 的时间序列。\n\n**2. 综合数据生成**\n\n为了测试模型和诊断框架，我们首先生成综合的“观测”数据 $Q_t^{\\mathrm{obs}}$。对于每个测试用例，使用 `run_model` 函数和一组“真实”参数（$k_q^{\\mathrm{true}}, C^{\\mathrm{true}}, S_0^{\\mathrm{true}}$）以及真实降水 $P_t^{\\mathrm{true}}$ 来模拟一个“真实”的水文系统。这会产生一个真实的径流序列 $Q_t^{\\mathrm{true}}$。然后通过修改 $Q_t^{\\mathrm{true}}$ 来创建观测径流 $Q_t^{\\mathrm{obs}}$，以表示现实世界中的测量问题：\n$$\nQ_t^{\\mathrm{obs}} = \\max\\!\\left(0, Q_t^{\\mathrm{true}} - L\\right) + \\epsilon_t\n$$\n其中 $L$ 代表一个系统的、未测量的渗漏或抽取，而 $\\epsilon_t$ 是标准差为 $\\sigma$ 的零均值高斯噪声，模拟随机测量误差。固定的随机种子确保了可复现性。\n\n**3. 模型率定**\n\n率定的目标是找到模型参数 $k_q$ 和 $C$，使模拟径流 $Q_t^{\\mathrm{sim}}$ 在率定期（第1-12个月）内最好地匹配观测径流 $Q_t^{\\mathrm{obs}}$。“最佳匹配”通过最小化误差平方和（SSE）来定义：\n$$\n\\mathrm{SSE}(k_q, C) = \\sum_{t=1}^{12} \\left(Q_t^{\\mathrm{sim}}(k_q, C) - Q_t^{\\mathrm{obs}}\\right)^2\n$$\n问题指定了网格搜索优化方法。我们为 $k_q$（从 $0.05$ 到 $0.45$）和 $C$（从 $100$ 到 $500$）定义了一个离散的可能值网格。对网格上的每一对 $(k_q, C)$，使用测量降水 $P_t^{\\mathrm{meas}} = b \\cdot P_t^{\\mathrm{true}}$ 和固定的初始蓄水量 $S_0=0$ 执行 `run_model` 函数。为每次运行计算SSE，并选择产生最小SSE的参数对作为最优集 $(k_q^{\\mathrm{opt}}, C^{\\mathrm{opt}})$。\n\n**4. 模型评估与差异分类**\n\n使用率定后的参数，模型在整个18个月的周期内运行。然后在其率定期（第1-12个月）和验证期（第13-18个月）对性能进行评估。使用两个关键指标：\n\n- **纳什-萨特克利夫效率（NSE）**：该指标评估模型相对于观测数据均值的预测能力。\n  $$\n  \\mathrm{NSE} = 1 - \\frac{\\sum_t \\left(Q_t^{\\mathrm{sim}} - Q_t^{\\mathrm{obs}}\\right)^2}{\\sum_t \\left(Q_t^{\\mathrm{obs}} - \\overline{Q^{\\mathrm{obs}}}\\right)^2}\n  $$\n  NSE为1表示完美匹配，而低于0的值表明模型的预测能力比观测值的均值还差。高NSE（例如，$\\ge 0.85$）表明模型结构和率定参数足以表示观测到的径流动态。\n\n- **水量平衡闭合误差（$E^{\\mathrm{frac}}$）**：该指标量化了水量平衡的闭合程度，即输入是否等于输出加上蓄水量的变化。误差 $E$ 是使用模型的输入和状态但使用*观测*径流来定义的：\n  $$\n  E = \\sum P_t^{\\mathrm{meas}} - \\sum \\mathrm{AET}_t^{\\mathrm{sim}} - \\sum Q_t^{\\mathrm{obs}} - \\Delta S^{\\mathrm{sim}}\n  $$\n  其中 $\\Delta S^{\\mathrm{sim}} = S_{t_1} - S_{t_0}$ 是该时期内模拟蓄水量的变化。非零的 $E$ 表明模型所核算的水量与环境中测量的水量之间存在差异。分数误差 $E^{\\mathrm{frac}} = E / (\\sum P_t^{\\mathrm{meas}})$ 通过总水量输入对这种差异进行归一化。\n\n最后，应用一组规则，根据两个时期内 $E^{\\mathrm{frac}}$ 的符号和大小以及NSE的值，对模型-数据差异的主要来源进行分类：\n- **渗漏（1）**：具有高NSE的一致性正且显著的 $E^{\\mathrm{frac}}$ 表明，模型准确地捕捉了降雨-径流过程，但存在一个现实世界中的水量损失（例如，地下水补给、人类取水）未被 $Q_t^{\\mathrm{obs}}$ 测量所捕捉。\n- **数据误差（-1）**：具有高NSE的一致性负且显著的 $E^{\\mathrm{frac}}$ 表明，模型结构上是合理的，但输入数据（降水）被系统性地低估，导致进入模型的水量少于系统表现出的径流量。\n- **结构性误设（0）**：任何其他情况，尤其是在一个或两个时期内NSE较低的情况，表明模型的基本结构（例如，恒定参数、简化的过程方程）不足以表示真实的系统动态。\n这一系统化的程序允许对模型性能及其与基础数据和物理系统的关系进行稳健的定量诊断。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases for the rainfall-runoff model problem.\n    \"\"\"\n    # Base data provided in the problem statement\n    P_true_base = np.array([80, 60, 40, 30, 20, 25, 40, 50, 90, 120, 150, 100, 70, 50, 35, 25, 20, 110], dtype=float)\n    PET_base = np.array([50, 60, 80, 100, 110, 120, 110, 90, 70, 60, 50, 60, 70, 80, 90, 100, 90, 60], dtype=float)\n    \n    # Test cases: (k_q_true, C_true, S0_true, L, b, sigma)\n    test_cases = [\n        # Case 1: Well-closed baseline\n        (0.15, 300.0, 100.0, 0.0, 1.0, 2.0),\n        # Case 2: Unobserved leakage\n        (0.15, 300.0, 100.0, 8.0, 1.0, 2.0),\n        # Case 3: Precipitation undercatch data error\n        (0.15, 300.0, 100.0, 0.0, 0.9, 2.0),\n        # Case 4: Structural misspecification (seasonal k_q)\n        (\"seasonal\", 300.0, 100.0, 0.0, 1.0, 2.0),\n    ]\n\n    all_results = []\n    \n    # Fixed random seed for reproducibility of noise\n    rng = np.random.default_rng(42)\n\n    for case in test_cases:\n        k_q_true, C_true, S0_true, L, b, sigma = case\n\n        # --- 1. Generate Observed Data (Q_obs) ---\n        \n        # Handle seasonal k_q for case 4\n        if k_q_true == \"seasonal\":\n            k_q_true_ts = np.array([0.15] * 12 + [0.30] * 6)\n        else:\n            k_q_true_ts = np.full_like(P_true_base, k_q_true)\n            \n        Q_true, _, _ = run_model(P_true_base, PET_base, k_q_true_ts, C_true, S0_true)\n        \n        noise = rng.normal(0, sigma, size=len(P_true_base))\n        Q_obs = np.maximum(0, Q_true - L) + noise\n        \n        # --- 2. Calibrate Model ---\n\n        P_meas = P_true_base * b\n        \n        # Calibration data slices (months 1-12, i.e., indices 0-11)\n        cal_len = 12\n        P_cal = P_meas[:cal_len]\n        PET_cal = PET_base[:cal_len]\n        Q_obs_cal = Q_obs[:cal_len]\n\n        # Calibration grid\n        k_q_grid = np.arange(0.05, 0.451, 0.005)\n        C_grid = np.arange(100, 501, 10)\n        \n        best_sse = np.inf\n        k_q_opt, C_opt = None, None\n\n        for k_q_try in k_q_grid:\n            for C_try in C_grid:\n                # S0 for calibrated model is fixed at 0\n                Q_sim_cal, _, _ = run_model(P_cal, PET_cal, np.full_like(P_cal, k_q_try), C_try, S0=0.0)\n                sse = np.sum((Q_sim_cal - Q_obs_cal)**2)\n                if sse  best_sse:\n                    best_sse = sse\n                    k_q_opt = k_q_try\n                    C_opt = C_try\n\n        # --- 3. Evaluate Calibrated Model ---\n\n        # Run the calibrated model over the full period\n        Q_sim, S_sim, AET_sim = run_model(P_meas, PET_base, np.full_like(P_meas, k_q_opt), C_opt, S0=0.0)\n\n        # Split data into calibration and validation periods\n        cal_indices = slice(0, 12)\n        val_indices = slice(12, 18)\n\n        # Calculate NSE for both periods\n        nse_cal = calculate_nse(Q_sim[cal_indices], Q_obs[cal_indices])\n        nse_val = calculate_nse(Q_sim[val_indices], Q_obs[val_indices])\n\n        # Calculate Fractional Water Balance Error for both periods\n        e_frac_cal = calculate_e_frac(\n            P_meas[cal_indices], AET_sim[cal_indices], Q_obs[cal_indices], \n            S_sim[0], S_sim[12]\n        )\n        e_frac_val = calculate_e_frac(\n            P_meas[val_indices], AET_sim[val_indices], Q_obs[val_indices], \n            S_sim[12], S_sim[18]\n        )\n        \n        # --- 4. Classify Discrepancy ---\n\n        tau_E = 0.05\n        tau_NSE = 0.85\n        classification = 0 # Default: Structural misspecification\n\n        is_leakage = (e_frac_cal >= tau_E and e_frac_val >= tau_E and \n                      nse_cal >= tau_NSE and nse_val >= tau_NSE)\n        is_data_error = (e_frac_cal = -tau_E and e_frac_val = -tau_E and\n                         nse_cal >= tau_NSE and nse_val >= tau_NSE)\n\n        if is_leakage:\n            classification = 1\n        elif is_data_error:\n            classification = -1\n        \n        all_results.append([round(e_frac_cal, 3), round(e_frac_val, 3), classification])\n\n    # Final print statement in the exact required format.\n    print(str(all_results).replace(\" \", \"\").replace(\"'\", \"\"))\n\n\ndef run_model(P, PET, k_q, C, S0):\n    \"\"\"\n    Simulates the single-reservoir rainfall-runoff model.\n    k_q can be a scalar or a time series array.\n    \"\"\"\n    num_steps = len(P)\n    S = np.zeros(num_steps + 1)\n    AET = np.zeros(num_steps)\n    Q_sim = np.zeros(num_steps)\n    S[0] = S0\n\n    for t in range(num_steps):\n        k_q_t = k_q[t] if isinstance(k_q, np.ndarray) else k_q\n        \n        # Calculate AET\n        AET[t] = PET[t] * min(S[t] / C, 1.0)\n        \n        # Potential storage for calculating overflow\n        S_next_pot = S[t] + P[t] - AET[t] - k_q_t * S[t]\n\n        # Storage update with constraints\n        S[t+1] = max(0, min(C, S_next_pot))\n        \n        # Overflow calculation\n        R_t = max(0, S_next_pot - C)\n        \n        # Total simulated discharge\n        Q_sim[t] = k_q_t * S[t] + R_t\n\n    return Q_sim, S, AET\n\n\ndef calculate_nse(q_sim, q_obs):\n    \"\"\"Calculates the Nash-Sutcliffe Efficiency.\"\"\"\n    numerator = np.sum((q_sim - q_obs)**2)\n    denominator = np.sum((q_obs - np.mean(q_obs))**2)\n    if denominator == 0:\n        return -np.inf # Or handle as an error\n    return 1 - (numerator / denominator)\n\n\ndef calculate_e_frac(P, AET, Q_obs, S_initial, S_final):\n    \"\"\"Calculates the fractional water balance closure error.\"\"\"\n    sum_P = np.sum(P)\n    if sum_P == 0:\n        return 0.0 # Avoid division by zero\n    \n    delta_S = S_final - S_initial\n    error = sum_P - np.sum(AET) - np.sum(Q_obs) - delta_S\n    \n    return error / sum_P\n\nif __name__ == \"__main__\":\n    solve()\n\n```"
        }
    ]
}