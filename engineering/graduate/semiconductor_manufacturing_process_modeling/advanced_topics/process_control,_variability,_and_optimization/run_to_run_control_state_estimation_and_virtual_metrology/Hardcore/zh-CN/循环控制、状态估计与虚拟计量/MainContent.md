## 引言
在日益精密的[半导体制造](@entry_id:187383)中，维持工艺稳定性和产品一致性是至关重要的挑战。逐批（Run-to-Run, R2R）控制作为一种先进过程控制策略，为此提供了核心解决方案。然而，如何有效应对设备老化和环境变化引起的缓慢过程漂移，以及如何克服物理量测带来的高成本、延迟和[稀疏性](@entry_id:136793)问题，是实现高效[R2R控制](@entry_id:1130475)必须解决的知识鸿沟。本文旨在系统性地阐述[R2R控制](@entry_id:1130475)及其关键支撑技术——状态估计与[虚拟量测](@entry_id:1133824)（Virtual Metrology, VM）。

本文将引导读者分三步深入该领域。在“原理与机制”一章中，我们将建立描述过程动态的数学模型，并探讨EWMA和卡尔曼滤波器等核心估计算法。随后，在“应用与跨学科联系”一章，我们将展示这些理论如何在多设备协调、非线性模型集成等复杂场景中应用，并揭示其与机器学习、统计学等领域的深刻联系。最后，通过“动手实践”部分，读者将有机会通过解决具体问题来巩固所学知识。通过这一结构化的学习路径，本文将为您揭示如何利用数据驱动的方法，实现对复杂半导体工艺的精确、主动和智能的控制。

## 原理与机制

本章在前一章介绍[半导体制造](@entry_id:187383)[过程控制](@entry_id:271184)背景的基础上，深入探讨逐批（Run-to-Run, R2R）控制及其相关状态估计和[虚拟量测](@entry_id:1133824)（Virtual Metrology, VM）技术的核心原理与实现机制。我们将建立描述过程动态的数学模型，阐述如何估计不可测量的过程漂移，设计[反馈控制](@entry_id:272052)器以补偿这些漂移，并探讨[虚拟量测](@entry_id:1133824)如何克服物理量测的局限性以增强控制性能。

### 逐批控制问题：背景与建模

在[半导体制造](@entry_id:187383)的复杂工艺流程中，控制策略通常在不同的时间尺度上分层实施。理解逐批控制（R2R）在其所处的[控制层级](@entry_id:199483)中的独特角色至关重要。

#### 层级控制视角

过程控制系统可以被看作一个层级结构。在最底层，是**批次内（within-run）**或实时[反馈控制](@entry_id:272052)。这种控制作用于单个晶圆或批次的处理过程中，其时间尺度是连续的（以时间 $t$ 计）。它利用原位（in-situ）传感器，如等离子体刻蚀过程中的光学发射光谱（Optical Emission Spectroscopy, OES）信号 $s(t)$，来实时调整操作参数，例如精确确定刻蚀终点。批次内控制的主要目标是抑制处理期间发生的高频、快速变化的扰动，例如等离子体波动或图形负载效应 。

相比之下，**逐批（Run-to-Run, R2R）控制**作用于一个更高的、离散的层级。它的时间尺度是批次索引 $k$（例如，晶圆编号）。R2R 控制利用每个批次完成后的质量信息——例如，通过非原位（ex-situ）量测获得的晶圆关键尺寸（Critical Dimension, CD）$y_k$——来调整下一个批次（$k+1$）的配方（recipe）[设定点](@entry_id:154422)。其核心目标是补偿那些从一个批次到另一个批次缓慢变化的低频扰动，即所谓的**过程漂移（process drift）** 。这种漂移可能源于设备老化、腔室壁沉积或消耗品状态的变化。

[统计过程控制](@entry_id:186744)（Statistical Process Control, SPC）是另一种监控方法，但其哲学与 R2R 控制根本不同。SPC 主要使用[控制图](@entry_id:184113)来监控过程是否处于统计稳定状态。当过程在控制限内时，SPC 倡导不对其进行干预，只有在出现失控信号（表明存在“特殊原因”变异）时才采取措施。而 R2R 控制是一种**主动反馈控制**策略，它在每个批次之间持续调整输入，以主动对抗可预测的漂移，使输出紧密跟踪目标值 。

#### 核心过程模型

为了设计 R2R 控制器，我们首先需要一个能捕捉过程基本行为的数学模型。对于许多单输入单输出（SISO）的半导体工艺单元，一个线性化的[仿射模型](@entry_id:143914)被广泛使用，并证明是有效的。该模型描述了第 $k$ 批次的工艺输入 $u_k$ 与输出质量指标 $y_k$ 之间的关系：

$y_k = G u_k + d_k + v_k$

在此模型中：
- $y_k \in \mathbb{R}$ 是第 $k$ 批次完成后量测到的工艺输出，例如薄膜厚度或[关键尺寸](@entry_id:148910)。
- $u_k \in \mathbb{R}$ 是为第 $k$ 批次设定的可调工艺输入或配方参数，例如沉积时间或射频功率。
- $G \in \mathbb{R}$ 是一个常数，称为**过程增益（process gain）**，它表示输出对输入的局部灵敏度。我们通常假设 $G \neq 0$。
- $d_k \in \mathbb{R}$ 是一个**未量测的过程偏置或漂移（unmeasured process bias or drift）**。它代表了所有未建模的、随时间缓慢变化的工艺影响的总和，是 R2R 控制要补偿的主要对象。
- $v_k \in \mathbb{R}$ 是一个随机噪声项，代表不可预测的批次间变异和量测误差。通常假设 $v_k$ 是一个均值为零、[独立同分布](@entry_id:169067)的[白噪声](@entry_id:145248)序列 。

这个模型将输出分解为三个部分：由控制输入决定的部分 ($G u_k$)、由缓慢漂移决定的部分 ($d_k$) 和纯粹的随机部分 ($v_k$)。$v_k$ 解释了围绕当前偏置的逐批次散布，而 $d_k$ 则解释了偏置本身的长期老化趋势 。

#### 过程漂移的特性

对漂移项 $d_k$ 的建模是 R2R 控制理论的核心。最常用且最基础的模型是**随机游走（random walk）模型**：

$d_{k+1} = d_k + w_k$

其中，$w_k$ 是一个均值为零的[白噪声](@entry_id:145248)序列，代表漂移的微小增量，通常假设它与量测噪声 $v_k$ 互相独立。这个模型在物理上对应于一种累积效应：许多微小的、独立的磨损或污染事件（$w_k$）累积起来，导致了工艺状态的缓慢、持续漂移 ($d_k$) 。

[随机游走过程](@entry_id:171699)具有一些关键的统计特性。首先，它是一个**非平稳（non-stationary）**过程。一个宽义平稳（Wide-Sense Stationary, WSS）过程的均值必须是常数，且其[自协方差函数](@entry_id:262114)仅依赖于时间延迟。对于[随机游走过程](@entry_id:171699) $d_k = d_0 + \sum_{i=0}^{k-1} w_i$，其方差为 $\mathrm{Var}(d_k) = \mathrm{Var}(d_0) + k \sigma_w^2$，其中 $\sigma_w^2$ 是 $w_k$ 的方差。由于方差随时间 $k$ 线性增长，该过程是非平稳的。这也意味着它的功率谱密度在低频处集中，这正是“缓慢漂移”的数学体现。然而，该过程的[一阶差分](@entry_id:275675) $\Delta d_k = d_k - d_{k-1} = w_{k-1}$ 是一个[白噪声](@entry_id:145248)序列，因此是平稳的 。

[随机游走模型](@entry_id:180803)可以被推广为一个更通用的**一阶自回归（AR(1)）模型**：

$d_{k+1} = \alpha d_k + w_k$

其中，参数 $\alpha$ 决定了漂移的“记忆性”。
- 当 $|\alpha| < 1$ 时，该过程是宽义平稳的。它描述了一种[均值回归](@entry_id:164380)的漂移，其影响会随时间指数衰减。其[自协方差函数](@entry_id:262114)为 $r_d(\tau) = \frac{\sigma_w^2}{1-\alpha^2}\alpha^{|\tau|}$ 。
- 当 $\alpha \to 1$ 时，AR(1) 模型就逼近了[随机游走模型](@entry_id:180803)。因此，随机游走可以被看作是稳定的 AR(1) 过程在非平稳边界上的一个特例 。

#### [状态空间表示](@entry_id:147149)

为了应用现代控制理论中的[标准化](@entry_id:637219)工具，将上述模型转化为[状态空间](@entry_id:160914)形式是极其有用的一步。如果我们选择过程漂移 $d_k$ 作为系统的状态，即 $x_k = d_k$，那么过程和漂移模型可以被写成标准的离散时间线性[状态空间](@entry_id:160914)形式：

$x_{k+1} = A x_k + B u_k + w_k$
$y_k = C x_k + D u_k + v_k$

对于随机游走漂移模型 $d_{k+1} = d_k + w_k$，[状态方程](@entry_id:274378)变为 $x_{k+1} = 1 \cdot x_k + 0 \cdot u_k + w_k$。
对于输出方程 $y_k = G u_k + d_k + v_k$，它变为 $y_k = 1 \cdot x_k + G \cdot u_k + v_k$。

通过比较系数，我们可以确定[状态空间](@entry_id:160914)矩阵为：
$A=1$, $B=0$, $C=1$, $D=G$

这个简洁的表示法清楚地表明：状态（漂移）自身演化，不受当前输入 $u_k$ 的直接影响（$B=0$）；而输出是状态和输入的[线性组合](@entry_id:154743) 。这个形式为接下来要讨论的状态估计和[控制器设计](@entry_id:274982)奠定了基础。

### 逐批控制的状态估计

由于过程漂移 $d_k$ 是未知的，R2R 控制器必须在补偿它之前先对其进行**估计**。这个任务由[状态估计器](@entry_id:272846)完成，它利用可用的量测数据来推断隐藏状态 $d_k$ 的值。

#### 指数加权[移动平均](@entry_id:203766)（EWMA）估计器

一个非常流行且直观的估计器是**指数加权移动平均（Exponentially Weighted Moving Average, EWMA）**滤波器。从过程模型 $y_k = G u_k + d_k + v_k$ 中，我们可以得到一个关于 $d_k$ 的含噪量测：$y_k - G u_k = d_k + v_k$。这个量被称为**残差（residual）**，因为它表示在考虑了已知输入 $u_k$ 的影响后，输出 $y_k$ 中剩余的部分。

EWMA 估计器通过递归地更新漂移的估计值 $\hat{d}_k$ 来平滑这些含噪的量测：

$\hat{d}_k = (1 - \lambda)\hat{d}_{k-1} + \lambda (y_k - G u_k)$

其中，$0 < \lambda \le 1$ 是一个可调的**平滑或[遗忘因子](@entry_id:175644)（smoothing or forgetting factor）**。这个公式的含义是，对第 $k$ 批次漂移的新估计 $\hat{d}_k$ 是对旧估计 $\hat{d}_{k-1}$ 和新量测信息 $(y_k - G u_k)$ 的加权平均。

参数 $\lambda$ 的选择体现了一个经典的权衡 ：
- **较小的 $\lambda$** (接近 0)：估计器更多地依赖于过去的估计，对新的（可能有噪声的）量测信息反应迟钝。这会导致一个非常平滑的估计，能有效抑制量测噪声 $v_k$ 的影响，但跟踪真实漂移 $d_k$ 变化的响应会很慢。
- **较大的 $\lambda$** (接近 1)：估计器更多地依赖于当前批次的残差。这使得估计器能快速响应真实漂移的变化，但代价是估计值会变得“嘈杂”，因为它会放大[测量噪声](@entry_id:275238) $v_k$ 的影响。

#### 卡尔曼滤波器视角

EWMA 估计器不仅直观，而且具有坚实的理论基础。可以证明，对于我们之前定义的随机游走漂移模型，EWMA 滤波器正是其**[稳态](@entry_id:139253)卡尔曼滤波器（steady-state Kalman Filter）** 。卡尔曼滤波器是[线性高斯系统](@entry_id:1127254)下的最优递归状态估计器，它能最小化估计误差的均方值。

卡尔曼滤波器的增益（在[稳态](@entry_id:139253)下即为 $\lambda$）是根据过程噪声的方差 $\sigma_w^2$ 和量测噪声的方差 $\sigma_v^2$ 自动计算出来的。具体而言，增益的大小与噪声[方差比](@entry_id:162608) $\sigma_w^2 / \sigma_v^2$ 有关。当过程漂移更具波动性（即 $\sigma_w^2$ 增大）时，意味着先前的状态预测 $d_k \approx \hat{d}_{k-1}$ 不太可靠，此时滤波器会**增大**增益，给予新的量测数据更大的权重。反之，当[测量噪声](@entry_id:275238)更大时，则会减小增益 。

一个关键的结果是，即使漂移本身是非平稳的（方差无界），卡尔曼滤波器对它的估计误差方差却可以收敛到一个有限的[稳态](@entry_id:139253)值 $P$。对于[随机游走模型](@entry_id:180803)，这个[稳态](@entry_id:139253)后验误差方差 $P$ 满足一个称为**代数[Riccati方程](@entry_id:184132)**的[二次方程](@entry_id:163234)：

$P^2 + \sigma_w^2 P - \sigma_w^2 \sigma_v^2 = 0$

这个方程的正解给出了滤波器可以达到的最佳长期跟踪性能。它表明，只要 $\sigma_w^2 > 0$ 和 $\sigma_v^2 > 0$，我们就可以用一个有界的、已知的精度来跟踪一个无界的[随机游走过程](@entry_id:171699) 。这为 R2R 控制的有效性提供了理论保障。

### 逐批[控制器设计](@entry_id:274982)

一旦我们获得了对漂移状态 $\hat{d}_k$ 的估计，下一步就是设计一个控制器，利用这个信息来调整输入 $u_{k+1}$，以使未来的输出 $y_{k+1}$ 尽可能接近目标值 $y^{\star}$。

#### 基本[积分控制](@entry_id:270104)

最简单的 R2R 控制器之一是**[积分控制](@entry_id:270104)器**。其思想是，在每个批次后，根据观察到的输出误差 $(y^{\star} - y_k)$ 来增量地调整输入。一个基本的[积分控制](@entry_id:270104)律可以写作：

$u_{k+1} = u_k + K (y^{\star} - y_k)$

其中 $K$ 是[控制器增益](@entry_id:262009)。一个经过精心设计的增益是 $K = G^{-1}$，这使得控制律变为：

$u_{k+1} = u_k + G^{-1}(y^{\star} - y_k)$

这个形式的控制器试图在一步之内完全校正观察到的误差。假设漂移非常缓慢 ($d_{k+1} \approx d_k$)，我们可以看到，如果 $y_k$ 低于 $y^{\star}$，控制器就会增加 $u_{k+1}$，从而有望提升 $y_{k+1}$ 。

#### 基于优化的控制与移动抑制

尽管简单[积分控制](@entry_id:270104)很直观，但更系统的方法是基于一个明确的优化目标来[设计控制](@entry_id:904437)器。一个常见的目标函数（或成本函数）是二次的，它平衡了两个相互竞争的目标：跟踪性能和输入平滑性。

$J_k = \mathbb{E}[ (y_k - y^{\star})^2 ] + \rho (u_k - u_{k-1})^2$

这个成本函数由两部分组成 ：
1.  **[跟踪误差](@entry_id:273267)项** $\mathbb{E}[ (y_k - y^{\star})^2 ]$：惩罚输出值偏离目标值 $y^{\star}$。我们的目标是最小化这个期望的平方误差。
2.  **移动抑制项** $\rho (u_k - u_{k-1})^2$：惩罚输入值的剧烈变化。参数 $\rho > 0$ 是**移动抑制权重（move-suppression weight）**。在实际应用中，频繁或大幅度地改变配方可能是不受欢迎的，因为它可能扰动过程的稳定性或加速设备损耗。

通过对 $J_k$ 关于 $u_k$ 求导并令其为零，可以推导出最优的控制律。假设在选择 $u_k$ 时，我们有对漂移的估计 $\hat{d}_{k-1}$，则最优的 $u_k$ 具有如下的增量形式：

$u_k = u_{k-1} + \frac{G}{G^2+\rho} (y^{\star} - (\hat{d}_{k-1} + G u_{k-1}))$

这里的项 $y^{\star} - (\hat{d}_{k-1} + G u_{k-1})$ 是**预测的[跟踪误差](@entry_id:273267)**，即基于当前信息对下一步输出的预测与目标之间的差距。控制器根据这个预测误差来调整输入。

移动抑制权重 $\rho$ 在这里扮演了关键的调优角色：
- 当 $\rho \to 0$ 时，控制器变得非常激进，试图尽快消除[跟踪误差](@entry_id:273267)，这会导致对[过程噪声](@entry_id:270644)和[估计误差](@entry_id:263890)的过度反应，即所谓的“追逐噪声（noise chasing）”。
- 当 $\rho$ 增大时，[控制器增益](@entry_id:262009) $\frac{G}{G^2+\rho}$ 减小，使得输入调整变得更加平缓和保守。这会减慢对真实漂移的响应速度，但能有效抑制噪声的放大，从而得到更平滑的控制动作 。

这种基于优化的方法为我们提供了一个系统性的框架，来根据具体工艺的要求在跟踪速度和控制平稳性之间做出权衡。

### [虚拟量测](@entry_id:1133824)：实现高频反馈

R2R 控制的性能在很大程度上取决于反馈信息的质量和及时性。在[半导体制造](@entry_id:187383)中，许多关键的质量指标（如 CD）依赖于耗时且昂贵的非原位物理量测，这导致了两个主要挑战：**稀疏量测**（并非每批都测量）和**量测延迟**（测量结果在几个批次后才可用）。

#### 稀疏和延迟量测的挑战

量测延迟对反馈控制系统是极其有害的。如果一个 R2R 控制器在第 $k$ 批次时，只能获得第 $k-\tau$ 批次的输出 $y_{k-\tau}$（其中 $\tau \ge 1$ 是延迟），那么它实际上是在根据陈旧的信息进行决策。对于一个正在漂移的过程，这种延迟会严重降低控制性能，甚至导致系统不稳定。例如，一个简单的[积分控制](@entry_id:270104)器，在没有延迟时（$\tau=0$）的稳定条件是 $0 < a\lambda < 2$（其中 $a$ 是增益，$\lambda$ 是控制器参数），但当延迟为 $\tau=1$ 时，[稳定区域](@entry_id:166035)会缩小为 $0 < a\lambda < 1$，表明系统对增益变得更加敏感，稳定裕度减小 。

#### [虚拟量测](@entry_id:1133824)的引入

**[虚拟量测](@entry_id:1133824)（Virtual Metrology, VM）**是一种旨在克服这些限制的强大技术。VM 的核心思想是利用在每个批次处理期间都可采集到的、丰富的原位传感器数据（例如，压力、温度、OES 信号等），通过一个预测模型来实时地估计出最终的物理量测值 。

我们将可用的原位传感器数据向量记为 $z_k$。VM 模型就是一个函数 $f$，它将这些传感器[数据映射](@entry_id:895128)到一个对真实输出 $y_k$ 的预测 $\hat{y}_k^{\text{VM}}$：

$\hat{y}_k^{\text{VM}} = f(z_k)$

通过在每个批次结束后立即计算 $\hat{y}_k^{\text{VM}}$，VM 能够在没有物理量测的情况下为 R2R 控制器提供及时的反馈，有效地将量测延迟从 $\tau$ 减小到接近于 0。

#### 构建[虚拟量测](@entry_id:1133824)模型：[监督学习](@entry_id:161081)方法

构建 VM 模型本质上是一个**[监督学习](@entry_id:161081)（supervised learning）**问题。我们需要一个包含成对数据的[训练集](@entry_id:636396) $\lbrace (z_k, y_k) \rbrace_{k=1}^N$，其中 $y_k$ 是通过物理量测获得的“标签”。目标是找到一个模型 $f$ 来最小化某个损失函数，例如**平均[绝对误差](@entry_id:139354)（Mean Absolute Error, MAE）** ：

$\underset{f}{\text{minimize}} \quad \frac{1}{N} \sum_{k=1}^N |y_k - f(z_k)|$

选择 MAE 作为[损失函数](@entry_id:634569)有其统计学意义：它所对应的最优预测是目标值 $y_k$ 的条件[中位数](@entry_id:264877)，这使得模型对训练数据中的异常值（outliers）没有均方误差（MSE）那么敏感。

在构建 VM 模型时，一个至关重要的预处理步骤是**[特征标准化](@entry_id:910011)（feature standardization）**。半导体过程的传感器数据通常具有极不相同的物理单位和数值范围（例如，压力可能在 $10^2$ Pa，而 OES 强度可能在 $10^6$ counts）。如果不进行[标准化](@entry_id:637219)，在使用[梯度下降](@entry_id:145942)等一阶优化算法训练模型时，[数值范围](@entry_id:752817)大的特征将在梯度计算中占据主导地位，导致优化过程不稳定且收敛缓慢。通过将每个特征转换为零均值和单位方差（即 Z-score [标准化](@entry_id:637219)），可以确保所有特征在模型训练中具有可比的贡献，并使得正则化（如 $\ell_1$ 或 $\ell_2$）能公平地应用于所有模型参数 。

#### 将[虚拟量测](@entry_id:1133824)集成到控制回路中

当 VM 模型可用时，R2R 控制器可以在物理量测缺失的批次上使用 VM 的预测值 $\hat{y}_k^{\text{VM}}$ 作为反馈信号。一个成功的集成策略需要考虑以下几点：
- **[无偏性](@entry_id:902438)（Unbiasedness）**：VM 模型必须是无偏的，即其[预测误差](@entry_id:753692)的期望为零，$\mathbb{E}[\hat{y}_k^{\text{VM}} - y_k] = 0$。如果 VM 存在系统性偏差 $\beta \neq 0$，积分型 R2R 控制器会将此偏差误认为是真实的过程误差，并调整输入来补偿它，最终导致实际输出稳定在一个偏离目标的非[零稳态误差](@entry_id:269428)上 。
- **不确定性（Uncertainty）**：VM 的预测总是有误差的，其不确定性（方差）通常高于高精度的物理量测。一个明智的控制策略应该根据反馈信号的质量调整其行为。当使用不确定性较大的 VM 预测时，应采用一个更保守（即更小）的[控制器增益](@entry_id:262009)，以避免过度放大预测噪声。相反，当获得精确的物理量测时，则可以使用更激进（即更大）的增益来快速修正过程漂移。这种基于测量质量的**[增益调度](@entry_id:272589)（gain scheduling）**可以显著改善闭环系统的整体性能 。

### 实际挑战与高级主题

#### [闭环系统辨识](@entry_id:181765)

在实践中，过程模型（如增益 $G$ 或漂移参数 $\alpha$）可能并非完全已知，需要从历史数据中进行辨识。然而，从一个处于[反馈控制](@entry_id:272052)下的系统（即**闭环**）中辨识模型参数是一个具有挑战性的问题。这是因为控制器的作用会改变输出信号的动态特性，将控制器自身的动态与过程的动态混淆在一起。例如，仅从输出序列 $\lbrace y_k \rbrace$ 中，很难区分过程的漂移特性（由 $\alpha$ 决定）和控制器的响应特性（由 $\lambda$ 决定）。为了成功辨识，通常需要同时记录输入序列 $\lbrace u_k \rbrace$。有了输入和输出数据，我们就可以计算出不受控制器直接影响的残差序列 $e_k = y_k - G u_k$，并从该序列的[自相关](@entry_id:138991)结构中辨识出漂移模型的参数 。

#### 延迟状态估计

对于存在量测延迟 $\tau$ 的情况，除了使用 VM，也可以通过更复杂的估计器来直接处理延迟。卡尔曼滤波器框架可以被扩展来应对这种情况。一种方法是将系统状态进行**增广（augmentation）**，将过去 $\tau$ 步的输入或状态包含到新的、更高维的状态向量中，从而将[延迟系统](@entry_id:270560)转化为一个等效的、无延迟的更高维系统 。另一种更先进的技术是**[乱序](@entry_id:147540)量测（Out-of-Sequence Measurement, OOSM）**更新。当一个延迟的量测 $y_{k-\tau}$ 在时刻 $k$ 到达时，OOSM 算法会返回到时刻 $k-\tau$ 来更新当时的状态估计，然后将这个更新的效果系统地向前传播，以修正从 $k-\tau+1$ 到 $k$ 的所有状态估计。这两种方法都为在存在显著硬件延迟时进行精确状态跟踪提供了严谨的数学工具 。