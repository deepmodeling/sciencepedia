{
    "hands_on_practices": [
        {
            "introduction": "This first practice introduces the fundamental affine model used to describe overlay error. By applying this linear model to a set of hypothetical measurements, you will learn to deconstruct the total overlay vector into its constituent parts and attribute systematic distortions, like scale and skew, to their physical sources—in this case, the reticle and the wafer.",
            "id": "4146938",
            "problem": "In advanced optical lithography overlay modeling for semiconductor manufacturing, the printed position on a layer is often modeled as the nominal design position perturbed by a small affine distortion, valid to first order in the small parameters. Let the nominal design position be the vector $\\mathbf{x} \\in \\mathbb{R}^{2}$, referenced to the wafer center. For a given layer $\\ell \\in \\{r,w\\}$ (reticle-conditioned layer and wafer-conditioned layer, respectively), assume the printed position is\n$$\n\\mathbf{x}_{\\ell} = \\left( \\mathbf{I} + \\mathbf{E}_{\\ell} \\right)\\mathbf{x},\n$$\nwhere $\\mathbf{I}$ is the $2\\times 2$ identity and $\\mathbf{E}_{\\ell}$ is a small, constant distortion matrix for the layer over the field of view. In this problem, restrict attention to two first-order contributors only: isotropic scale and orthogonality skew. Model these as\n$$\n\\mathbf{E}_{\\ell} = s_{\\ell}\\,\\mathbf{I} + k_{\\ell}\\,\\mathbf{K},\n$$\nwhere $s_{\\ell}$ is the isotropic scale (dimensionless), $k_{\\ell}$ is the orthogonality skew (dimensionless), and\n$$\n\\mathbf{K} \\equiv \\begin{pmatrix} 0 & 1 \\\\ 1 & 0 \\end{pmatrix},\n$$\nso that a positive $k_{\\ell}$ couples $x$ into $y$ and $y$ into $x$ symmetrically. Assume translations are eliminated by centering the coordinate system at the wafer center, and that inter-layer rotation is negligible at the order of interest.\n\nThe overlay vector field is defined as the difference between the wafer-conditioned and reticle-conditioned printed positions at the same nominal design point:\n$$\n\\mathbf{u}(\\mathbf{x}) \\equiv \\mathbf{x}_{w} - \\mathbf{x}_{r}.\n$$\n\nYou measure overlay at 4 symmetrically placed sites at radius $L$ from the wafer center:\n- Site $\\mathbf{x}_{1} = (L, 0)$,\n- Site $\\mathbf{x}_{2} = (0, L)$,\n- Site $\\mathbf{x}_{3} = (-L, 0)$,\n- Site $\\mathbf{x}_{4} = (0, -L)$,\n\nwith $L = 10\\,\\mathrm{mm}$. The measured overlay vectors at these sites, expressed in nanometers, are:\n- $\\mathbf{u}(\\mathbf{x}_{1}) = (50\\,\\mathrm{nm},\\, -30\\,\\mathrm{nm})$,\n- $\\mathbf{u}(\\mathbf{x}_{2}) = (-30\\,\\mathrm{nm},\\, 50\\,\\mathrm{nm})$,\n- $\\mathbf{u}(\\mathbf{x}_{3}) = (-50\\,\\mathrm{nm},\\, 30\\,\\mathrm{nm})$,\n- $\\mathbf{u}(\\mathbf{x}_{4}) = (30\\,\\mathrm{nm},\\, -50\\,\\mathrm{nm})$.\n\nIndependent metrology on the reticle yields $s_{r} = -2.0 \\times 10^{-6}$ and $k_{r} = 1.0 \\times 10^{-6}$. Assume that across these sites the two-parameter model above is valid and that measurement noise is negligible.\n\nStarting from the definitions given and the first-order affine model, derive the overlay field in terms of the differential parameters and use the measured data to estimate the wafer layer’s orthogonality skew $k_{w}$. Express your final answer as a dimensionless decimal number and round to three significant figures. Do not use a percent sign or parts-per notation in your final answer.",
            "solution": "The user wants me to solve a problem based on an affine model for lithographic overlay.\n\n### Step 1: Extract Givens\n-   Nominal design position: $\\mathbf{x} \\in \\mathbb{R}^{2}$.\n-   Printed position on layer $\\ell \\in \\{r, w\\}$: $\\mathbf{x}_{\\ell} = (\\mathbf{I} + \\mathbf{E}_{\\ell})\\mathbf{x}$, where $\\mathbf{I}$ is the $2 \\times 2$ identity matrix.\n-   Distortion matrix model: $\\mathbf{E}_{\\ell} = s_{\\ell}\\mathbf{I} + k_{\\ell}\\mathbf{K}$.\n-   Parameters: $s_{\\ell}$ (isotropic scale), $k_{\\ell}$ (orthogonality skew).\n-   Matrix $\\mathbf{K}$: $\\mathbf{K} \\equiv \\begin{pmatrix} 0 & 1 \\\\ 1 & 0 \\end{pmatrix}$.\n-   Overlay vector field: $\\mathbf{u}(\\mathbf{x}) \\equiv \\mathbf{x}_{w} - \\mathbf{x}_{r}$.\n-   Measurement sites:\n    -   $\\mathbf{x}_{1} = (L, 0)$\n    -   $\\mathbf{x}_{2} = (0, L)$\n    -   $\\mathbf{x}_{3} = (-L, 0)$\n    -   $\\mathbf{x}_{4} = (0, -L)$\n-   Radius: $L = 10\\,\\mathrm{mm}$.\n-   Measured overlay vectors:\n    -   $\\mathbf{u}(\\mathbf{x}_{1}) = (50\\,\\mathrm{nm},\\, -30\\,\\mathrm{nm})$\n    -   $\\mathbf{u}(\\mathbf{x}_{2}) = (-30\\,\\mathrm{nm},\\, 50\\,\\mathrm{nm})$\n    -   $\\mathbf{u}(\\mathbf{x}_{3}) = (-50\\,\\mathrm{nm},\\, 30\\,\\mathrm{nm})$\n    -   $\\mathbf{u}(\\mathbf{x}_{4}) = (30\\,\\mathrm{nm},\\, -50\\,\\mathrm{nm})$\n-   Reticle layer parameters: $s_{r} = -2.0 \\times 10^{-6}$ and $k_{r} = 1.0 \\times 10^{-6}$.\n-   Objective: Find the wafer layer's orthogonality skew, $k_{w}$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, employing a standard first-order affine model for lithographic overlay, a well-established practice in semiconductor manufacturing process modeling. The model is well-posed, providing a system of linear equations with sufficient measurement data to solve for the unknown parameters. The problem is stated objectively using precise mathematical terms, and the provided data is complete and internally consistent. For example, the measurement at $\\mathbf{x}_{3} = -\\mathbf{x}_{1}$ is $\\mathbf{u}(\\mathbf{x}_3) = (-50, 30)\\,\\mathrm{nm}$, which is equal to $-\\mathbf{u}(\\mathbf{x}_1) = -(50, -30)\\,\\mathrm{nm}$. This is consistent with the linear relationship $\\mathbf{u}(\\mathbf{x}) = \\mathbf{M}\\mathbf{x}$. The physical values are realistic for overlay errors (nanometers) and distortion parameters (parts-per-million). The problem is therefore valid.\n\n### Step 3: Verdict and Action\nThe problem is valid. I will now proceed with a full, reasoned-out solution.\n\nThe objective is to determine the wafer layer's orthogonality skew, $k_{w}$. To do this, we must first establish the relationship between the measured overlay vectors and the model parameters.\n\nFirst, we derive the expression for the overlay vector field, $\\mathbf{u}(\\mathbf{x})$. By definition, it is the difference between the printed positions on the wafer-conditioned layer ($w$) and the reticle-conditioned layer ($r$):\n$$\n\\mathbf{u}(\\mathbf{x}) = \\mathbf{x}_{w} - \\mathbf{x}_{r}\n$$\nSubstituting the given model for the printed positions, $\\mathbf{x}_{\\ell} = (\\mathbf{I} + \\mathbf{E}_{\\ell})\\mathbf{x}$:\n$$\n\\mathbf{u}(\\mathbf{x}) = (\\mathbf{I} + \\mathbf{E}_{w})\\mathbf{x} - (\\mathbf{I} + \\mathbf{E}_{r})\\mathbf{x}\n$$\n$$\n\\mathbf{u}(\\mathbf{x}) = (\\mathbf{I} + \\mathbf{E}_{w} - \\mathbf{I} - \\mathbf{E}_{r})\\mathbf{x} = (\\mathbf{E}_{w} - \\mathbf{E}_{r})\\mathbf{x}\n$$\nLet's define a differential distortion matrix $\\Delta\\mathbf{E} = \\mathbf{E}_{w} - \\mathbf{E}_{r}$. The overlay field is thus a linear transformation of the nominal position vector: $\\mathbf{u}(\\mathbf{x}) = \\Delta\\mathbf{E}\\,\\mathbf{x}$.\n\nNext, we substitute the model for the distortion matrices, $\\mathbf{E}_{\\ell} = s_{\\ell}\\mathbf{I} + k_{\\ell}\\mathbf{K}$:\n$$\n\\Delta\\mathbf{E} = (s_{w}\\mathbf{I} + k_{w}\\mathbf{K}) - (s_{r}\\mathbf{I} + k_{r}\\mathbf{K})\n$$\nGrouping terms by the identity matrix $\\mathbf{I}$ and the skew matrix $\\mathbf{K}$:\n$$\n\\Delta\\mathbf{E} = (s_{w} - s_{r})\\mathbf{I} + (k_{w} - k_{r})\\mathbf{K}\n$$\nWe define the differential scale $\\Delta s = s_{w} - s_{r}$ and the differential orthogonality skew $\\Delta k = k_{w} - k_{r}$. The overlay model becomes:\n$$\n\\mathbf{u}(\\mathbf{x}) = (\\Delta s\\,\\mathbf{I} + \\Delta k\\,\\mathbf{K})\\mathbf{x}\n$$\nLet $\\mathbf{x} = \\begin{pmatrix} x \\\\ y \\end{pmatrix}$ and $\\mathbf{u}(\\mathbf{x}) = \\begin{pmatrix} u_x \\\\ u_y \\end{pmatrix}$. The matrix $\\Delta\\mathbf{E}$ is:\n$$\n\\Delta\\mathbf{E} = \\Delta s \\begin{pmatrix} 1 & 0 \\\\ 0 & 1 \\end{pmatrix} + \\Delta k \\begin{pmatrix} 0 & 1 \\\\ 1 & 0 \\end{pmatrix} = \\begin{pmatrix} \\Delta s & \\Delta k \\\\ \\Delta k & \\Delta s \\end{pmatrix}\n$$\nSo, the component equations for the overlay vector are:\n$$\nu_x(x, y) = (\\Delta s)x + (\\Delta k)y\n$$\n$$\nu_y(x, y) = (\\Delta k)x + (\\Delta s)y\n$$\nNow, we use the provided measurement data to determine the values of the differential parameters $\\Delta s$ and $\\Delta k$. We can use any of the four measurement sites. Let's use site $\\mathbf{x}_{1} = (L, 0)$.\nAt this site, $x=L$ and $y=0$. The model predicts:\n$$\nu_x(L, 0) = (\\Delta s)L + (\\Delta k)(0) = (\\Delta s)L\n$$\n$$\nu_y(L, 0) = (\\Delta k)L + (\\Delta s)(0) = (\\Delta k)L\n$$\nThe measurement at this site is given as $\\mathbf{u}(\\mathbf{x}_{1}) = (50\\,\\mathrm{nm},\\, -30\\,\\mathrm{nm})$. Equating the model to the measurement:\n$$\n(\\Delta s)L = 50\\,\\mathrm{nm}\n$$\n$$\n(\\Delta k)L = -30\\,\\mathrm{nm}\n$$\nThe radius $L$ is given as $10\\,\\mathrm{mm}$. To maintain consistent units, we convert $L$ to nanometers. Since $1\\,\\mathrm{mm} = 10^6\\,\\mathrm{nm}$:\n$$\nL = 10\\,\\mathrm{mm} = 10 \\times 10^6\\,\\mathrm{nm} = 1.0 \\times 10^7\\,\\mathrm{nm}\n$$\nNow we can solve for the dimensionless parameters $\\Delta s$ and $\\Delta k$:\n$$\n\\Delta s = \\frac{50\\,\\mathrm{nm}}{1.0 \\times 10^7\\,\\mathrm{nm}} = 5.0 \\times 10^{-6}\n$$\n$$\n\\Delta k = \\frac{-30\\,\\mathrm{nm}}{1.0 \\times 10^7\\,\\mathrm{nm}} = -3.0 \\times 10^{-6}\n$$\nThe problem asks for the wafer layer's orthogonality skew, $k_{w}$. We use the definition of the differential skew:\n$$\n\\Delta k = k_{w} - k_{r}\n$$\nSolving for $k_{w}$:\n$$\nk_{w} = \\Delta k + k_{r}\n$$\nWe substitute the value we just calculated for $\\Delta k$ and the given value for the reticle skew, $k_{r} = 1.0 \\times 10^{-6}$:\n$$\nk_{w} = (-3.0 \\times 10^{-6}) + (1.0 \\times 10^{-6}) = -2.0 \\times 10^{-6}\n$$\nThe problem requests the final answer as a dimensionless decimal number rounded to three significant figures. The calculated value is $-2.0 \\times 10^{-6}$. Rounding this to three significant figures gives $-2.00 \\times 10^{-6}$.",
            "answer": "$$\n\\boxed{-2.00 \\times 10^{-6}}\n$$"
        },
        {
            "introduction": "Building on the analysis of deterministic errors , this practice shifts the focus to their statistical behavior across a manufacturing process. You will treat error parameters as random variables and derive a process-level overlay budget from first principles. This exercise is crucial for understanding process capability and setting realistic control limits for high-volume manufacturing.",
            "id": "4146955",
            "problem": "In Lithography-Etch-Lithography-Etch (LELE) double patterning, the overlay between two sequential exposures is modeled by the difference between two small transformations applied to the ideal pattern coordinates. Consider a single die centered at the origin with rectangular extent $R = [-a,a] \\times [-b,b]$, with $a = 5\\,\\mathrm{mm}$ and $b = 4\\,\\mathrm{mm}$. For exposure $i \\in \\{1,2\\}$, the printed location $\\mathbf{r}'_{i}$ of an ideal point $\\mathbf{r} = (x,y)^\\top$ is modeled, under the small-error approximation, as\n$$\n\\mathbf{r}'_{i} = \\mathbf{t}_{i} + \\left( \\mathbf{I} + m_{i}\\,\\mathbf{I} + \\theta_{i}\\,\\mathbf{J} + \\alpha_{i}\\,\\mathbf{H} \\right)\\mathbf{r},\n$$\nwhere $\\mathbf{t}_{i} \\in \\mathbb{R}^{2}$ is the global translation vector, $m_{i}$ is the isotropic magnification error (dimensionless), $\\theta_{i}$ is the in-plane rotation angle around the die center (in radians), $\\alpha_{i}$ is the small non-orthogonality (skew) parameter (dimensionless), $\\mathbf{I}$ is the $2\\times 2$ identity matrix, $\\mathbf{J} = \\begin{pmatrix}0 & -1 \\\\ 1 & 0\\end{pmatrix}$ generates a small rotation, and $\\mathbf{H} = \\begin{pmatrix}0 & 1 \\\\ 1 & 0\\end{pmatrix}$ generates a small symmetric shear capturing non-orthogonality.\n\nAssume the following statistically well-tested conditions:\n- All scalar errors $m_{i}$, $\\theta_{i}$, $\\alpha_{i}$ and the translation components of $\\mathbf{t}_{i}$ are independent across $i$ and mutually independent within each exposure, each having zero mean.\n- The translation components of $\\mathbf{t}_{i}$ have identical standard deviation $\\sigma_{T}$ per axis, with $\\sigma_{T} = 0.8\\,\\mathrm{nm}$.\n- The magnification error has standard deviation $\\sigma_{M} = 1.5\\times 10^{-7}$ (dimensionless).\n- The rotation has standard deviation $\\sigma_{\\theta} = 3.5\\times 10^{-7}$ (in radians).\n- The non-orthogonality has standard deviation $\\sigma_{\\alpha} = 1.0\\times 10^{-7}$ (dimensionless).\n\nDefine the overlay vector at location $\\mathbf{r}$ as $\\mathbf{O}(\\mathbf{r}) = \\mathbf{r}'_{2} - \\mathbf{r}'_{1}$, and the die-averaged root-mean-square (RMS) overlay magnitude as\n$$\n\\mathrm{RMS} = \\left( \\frac{1}{|R|} \\iint_{R} \\mathbb{E}\\left[ \\|\\mathbf{O}(\\mathbf{r})\\|^{2} \\right]\\, \\mathrm{d}x\\,\\mathrm{d}y \\right)^{1/2},\n$$\nwhere $|R|$ is the die area and $\\mathbb{E}[\\cdot]$ denotes expectation over the error distributions.\n\nStarting from fundamental definitions of small rigid-body and linear distortions and the properties of independent zero-mean random variables, derive the die-averaged $\\mathrm{RMS}$ from first principles. Then evaluate the $3$-sigma double-patterning overlay budget defined as $3\\times \\mathrm{RMS}$ using the numerical parameters above.\n\nRound your final numeric answer to four significant figures. Express the overlay budget in nanometers. Use radians for any angular quantities in your derivation.",
            "solution": "The problem asks for the derivation and calculation of the $3$-sigma double-patterning overlay budget, defined as $3\\times \\mathrm{RMS}$, where $\\mathrm{RMS}$ is the die-averaged root-mean-square overlay magnitude.\n\n### Step 1: Problem Validation\n\n**1.1. Extract Givens:**\n- Process: Lithography-Etch-Lithography-Etch (LELE) double patterning.\n- Die region: $R = [-a,a] \\times [-b,b]$, with $a = 5\\,\\mathrm{mm}$ and $b = 4\\,\\mathrm{mm}$.\n- Transformation model for exposure $i \\in \\{1,2\\}$: $\\mathbf{r}'_{i} = \\mathbf{t}_{i} + \\left( \\mathbf{I} + m_{i}\\,\\mathbf{I} + \\theta_{i}\\,\\mathbf{J} + \\alpha_{i}\\,\\mathbf{H} \\right)\\mathbf{r}$.\n- Error terms: $\\mathbf{t}_{i}$ (translation), $m_{i}$ (magnification), $\\theta_{i}$ (rotation), $\\alpha_{i}$ (non-orthogonality).\n- Matrices: $\\mathbf{I} = \\begin{pmatrix}1 & 0 \\\\ 0 & 1\\end{pmatrix}$, $\\mathbf{J} = \\begin{pmatrix}0 & -1 \\\\ 1 & 0\\end{pmatrix}$, $\\mathbf{H} = \\begin{pmatrix}0 & 1 \\\\ 1 & 0\\end{pmatrix}$.\n- Statistical properties:\n    - All scalar errors ($m_i, \\theta_i, \\alpha_i$) and translation components are independent across $i$ and mutually independent within each exposure.\n    - All errors have zero mean: $\\mathbb{E}[m_i] = 0$, $\\mathbb{E}[\\theta_i] = 0$, $\\mathbb{E}[\\alpha_i] = 0$, $\\mathbb{E}[\\mathbf{t}_i] = \\mathbf{0}$.\n    - Standard deviations:\n        - Translation (per axis): $\\sigma_{T} = 0.8\\,\\mathrm{nm}$. So, $\\mathrm{Var}(t_{ix}) = \\mathrm{Var}(t_{iy}) = \\sigma_T^2$.\n        - Magnification: $\\sigma_{M} = 1.5\\times 10^{-7}$.\n        - Rotation: $\\sigma_{\\theta} = 3.5\\times 10^{-7}\\,\\mathrm{rad}$.\n        - Non-orthogonality: $\\sigma_{\\alpha} = 1.0\\times 10^{-7}$.\n- Definitions:\n    - Overlay vector: $\\mathbf{O}(\\mathbf{r}) = \\mathbf{r}'_{2} - \\mathbf{r}'_{1}$.\n    - Die-averaged RMS overlay magnitude: $\\mathrm{RMS} = \\left( \\frac{1}{|R|} \\iint_{R} \\mathbb{E}\\left[ \\|\\mathbf{O}(\\mathbf{r})\\|^{2} \\right]\\, \\mathrm{d}x\\,\\mathrm{d}y \\right)^{1/2}$. $|R|$ is the die area.\n- Task: Derive $\\mathrm{RMS}$ from first principles and evaluate $3 \\times \\mathrm{RMS}$ numerically, rounding to four significant figures.\n\n**1.2. Validate Using Extracted Givens:**\n- **Scientifically Grounded:** The problem is firmly located within semiconductor manufacturing process modeling, specifically photolithography overlay. The linear model for small distortions is a standard, scientifically valid approximation. The error components (translation, magnification, rotation, skew/non-orthogonality) are the conventional terms used in industry and academia.\n- **Well-Posed:** The problem provides all necessary definitions, statistical properties, and numerical values. The definitions of the overlay vector and the RMS average are mathematically precise and unambiguous. A unique, meaningful solution can be derived.\n- **Objective:** The language is formal and quantitative. No subjective or opinion-based statements are present.\n- The problem is self-contained and internally consistent.\n\n**1.3. Verdict and Action:**\nThe problem is valid. A full, reasoned solution will be provided.\n\n### Step 2: Derivation of the RMS Overlay\n\nThe overlay vector $\\mathbf{O}(\\mathbf{r})$ is the difference between the printed locations from the two exposures:\n$$\n\\mathbf{O}(\\mathbf{r}) = \\mathbf{r}'_{2} - \\mathbf{r}'_{1}\n$$\nSubstituting the given transformation model:\n$$\n\\mathbf{O}(\\mathbf{r}) = \\left[ \\mathbf{t}_{2} + \\left( \\mathbf{I} + m_{2}\\mathbf{I} + \\theta_{2}\\mathbf{J} + \\alpha_{2}\\mathbf{H} \\right)\\mathbf{r} \\right] - \\left[ \\mathbf{t}_{1} + \\left( \\mathbf{I} + m_{1}\\mathbf{I} + \\theta_{1}\\mathbf{J} + \\alpha_{1}\\mathbf{H} \\right)\\mathbf{r} \\right]\n$$\nGrouping terms:\n$$\n\\mathbf{O}(\\mathbf{r}) = (\\mathbf{t}_{2} - \\mathbf{t}_{1}) + \\left[ (m_{2}-m_{1})\\mathbf{I} + (\\theta_{2}-\\theta_{1})\\mathbf{J} + (\\alpha_{2}-\\alpha_{1})\\mathbf{H} \\right]\\mathbf{r}\n$$\nLet us define the differential error terms: $\\Delta\\mathbf{t} = \\mathbf{t}_{2} - \\mathbf{t}_{1}$, $\\Delta m = m_{2} - m_{1}$, $\\Delta\\theta = \\theta_{2} - \\theta_{1}$, and $\\Delta\\alpha = \\alpha_{2} - \\alpha_{1}$. The overlay vector becomes:\n$$\n\\mathbf{O}(\\mathbf{r}) = \\Delta\\mathbf{t} + (\\Delta m\\,\\mathbf{I} + \\Delta\\theta\\,\\mathbf{J} + \\Delta\\alpha\\,\\mathbf{H})\\mathbf{r}\n$$\nLet the distortion matrix be $\\mathbf{M}_{\\Delta} = \\Delta m\\,\\mathbf{I} + \\Delta\\theta\\,\\mathbf{J} + \\Delta\\alpha\\,\\mathbf{H}$. Then $\\mathbf{O}(\\mathbf{r}) = \\Delta\\mathbf{t} + \\mathbf{M}_{\\Delta}\\mathbf{r}$.\n\nWe need to compute the expected squared magnitude of the overlay vector, $\\mathbb{E}\\left[ \\|\\mathbf{O}(\\mathbf{r})\\|^{2} \\right]$.\n$$\n\\|\\mathbf{O}(\\mathbf{r})\\|^{2} = \\mathbf{O}(\\mathbf{r})^{\\top}\\mathbf{O}(\\mathbf{r}) = (\\Delta\\mathbf{t} + \\mathbf{M}_{\\Delta}\\mathbf{r})^{\\top}(\\Delta\\mathbf{t} + \\mathbf{M}_{\\Delta}\\mathbf{r})\n$$\n$$\n\\|\\mathbf{O}(\\mathbf{r})\\|^{2} = \\Delta\\mathbf{t}^{\\top}\\Delta\\mathbf{t} + 2\\Delta\\mathbf{t}^{\\top}\\mathbf{M}_{\\Delta}\\mathbf{r} + \\mathbf{r}^{\\top}\\mathbf{M}_{\\Delta}^{\\top}\\mathbf{M}_{\\Delta}\\mathbf{r}\n$$\nThe expectation is taken over the distributions of the error parameters. Using the linearity of expectation:\n$$\n\\mathbb{E}\\left[ \\|\\mathbf{O}(\\mathbf{r})\\|^{2} \\right] = \\mathbb{E}\\left[\\Delta\\mathbf{t}^{\\top}\\Delta\\mathbf{t}\\right] + 2\\mathbb{E}\\left[\\Delta\\mathbf{t}^{\\top}\\mathbf{M}_{\\Delta}\\mathbf{r}\\right] + \\mathbb{E}\\left[\\mathbf{r}^{\\top}\\mathbf{M}_{\\Delta}^{\\top}\\mathbf{M}_{\\Delta}\\mathbf{r}\\right]\n$$\nThe error terms $m_i, \\theta_i, \\alpha_i$ and the components of $\\mathbf{t}_i$ are all independent with zero mean. This implies their differences $\\Delta m, \\Delta\\theta, \\Delta\\alpha$ and the components of $\\Delta\\mathbf{t}$ also have zero mean. For example, $\\mathbb{E}[\\Delta m] = \\mathbb{E}[m_2] - \\mathbb{E}[m_1] = 0-0=0$.\nThe cross-term involves products of $\\Delta\\mathbf{t}$ components with $\\Delta m, \\Delta\\theta, \\Delta\\alpha$. Since all these variables are independent and have zero mean, the expectation of their product is zero.\n$$\n\\mathbb{E}\\left[\\Delta\\mathbf{t}^{\\top}\\mathbf{M}_{\\Delta}\\mathbf{r}\\right] = \\mathbb{E}[\\Delta\\mathbf{t}]^{\\top}\\mathbb{E}[\\mathbf{M}_{\\Delta}]\\mathbf{r} = \\mathbf{0}^{\\top}\\mathbf{0}\\mathbf{r} = 0\n$$\nThus, the expected squared magnitude simplifies to:\n$$\n\\mathbb{E}\\left[ \\|\\mathbf{O}(\\mathbf{r})\\|^{2} \\right] = \\mathbb{E}\\left[\\Delta\\mathbf{t}^{\\top}\\Delta\\mathbf{t}\\right] + \\mathbf{r}^{\\top}\\mathbb{E}\\left[\\mathbf{M}_{\\Delta}^{\\top}\\mathbf{M}_{\\Delta}\\right]\\mathbf{r}\n$$\nWe evaluate each term separately.\n\n1.  **Translation Term:** $\\mathbb{E}\\left[\\Delta\\mathbf{t}^{\\top}\\Delta\\mathbf{t}\\right]$\n    $\\Delta\\mathbf{t} = (\\Delta t_x, \\Delta t_y)^{\\top} = (t_{2x}-t_{1x}, t_{2y}-t_{1y})^{\\top}$.\n    $\\Delta\\mathbf{t}^{\\top}\\Delta\\mathbf{t} = (\\Delta t_x)^2 + (\\Delta t_y)^2$.\n    $\\mathbb{E}\\left[\\Delta\\mathbf{t}^{\\top}\\Delta\\mathbf{t}\\right] = \\mathbb{E}[(\\Delta t_x)^2] + \\mathbb{E}[(\\Delta t_y)^2]$.\n    Since $\\mathbb{E}[\\Delta t_x]=0$, $\\mathbb{E}[(\\Delta t_x)^2] = \\mathrm{Var}(\\Delta t_x) = \\mathrm{Var}(t_{2x}-t_{1x})$. Due to independence, $\\mathrm{Var}(t_{2x}-t_{1x}) = \\mathrm{Var}(t_{2x}) + \\mathrm{Var}(t_{1x}) = \\sigma_T^2 + \\sigma_T^2 = 2\\sigma_T^2$.\n    Similarly, $\\mathbb{E}[(\\Delta t_y)^2] = 2\\sigma_T^2$.\n    Therefore, $\\mathbb{E}\\left[\\Delta\\mathbf{t}^{\\top}\\Delta\\mathbf{t}\\right] = 2\\sigma_T^2 + 2\\sigma_T^2 = 4\\sigma_T^2$.\n\n2.  **Distortion Term:** $\\mathbf{r}^{\\top}\\mathbb{E}\\left[\\mathbf{M}_{\\Delta}^{\\top}\\mathbf{M}_{\\Delta}\\right]\\mathbf{r}$\n    First, find the expectation of $\\mathbf{M}_{\\Delta}^{\\top}\\mathbf{M}_{\\Delta}$. The product is $\\mathbf{M}_{\\Delta}^{\\top}\\mathbf{M}_{\\Delta} = (\\Delta m\\,\\mathbf{I} - \\Delta\\theta\\,\\mathbf{J} + \\Delta\\alpha\\,\\mathbf{H}) (\\Delta m\\,\\mathbf{I} + \\Delta\\theta\\,\\mathbf{J} + \\Delta\\alpha\\,\\mathbf{H})$. Taking the expectation of this product and using the independence and zero-mean properties of the error terms (e.g., $\\mathbb{E}[\\Delta m\\Delta\\alpha]=0$), all cross-product terms in the expansion vanish. The remaining terms simplify, using $\\mathbf{J}^2 = -\\mathbf{I}$ and $\\mathbf{H}^2 = \\mathbf{I}$, to:\n    $$\n\\mathbb{E}[\\mathbf{M}_{\\Delta}^{\\top}\\mathbf{M}_{\\Delta}] = (\\mathbb{E}[\\Delta m^2] + \\mathbb{E}[\\Delta\\theta^2] + \\mathbb{E}[\\Delta\\alpha^2])\\mathbf{I}\n$$\n    As with translation, $\\mathbb{E}[\\Delta m^2] = \\mathrm{Var}(\\Delta m) = 2\\sigma_M^2$, $\\mathbb{E}[\\Delta\\theta^2] = 2\\sigma_{\\theta}^2$, and $\\mathbb{E}[\\Delta\\alpha^2] = 2\\sigma_{\\alpha}^2$.\n    So, $\\mathbb{E}[\\mathbf{M}_{\\Delta}^{\\top}\\mathbf{M}_{\\Delta}] = (2\\sigma_M^2 + 2\\sigma_{\\theta}^2 + 2\\sigma_{\\alpha}^2)\\mathbf{I}$.\n    The distortion term becomes $ \\mathbf{r}^{\\top} \\left( 2(\\sigma_M^2 + \\sigma_{\\theta}^2 + \\sigma_{\\alpha}^2)\\mathbf{I} \\right) \\mathbf{r} = 2(\\sigma_M^2 + \\sigma_{\\theta}^2 + \\sigma_{\\alpha}^2) \\mathbf{r}^{\\top}\\mathbf{r}$.\n    With $\\mathbf{r}=(x,y)^{\\top}$, $\\mathbf{r}^{\\top}\\mathbf{r} = x^2+y^2$. The term is $2(\\sigma_M^2 + \\sigma_{\\theta}^2 + \\sigma_{\\alpha}^2)(x^2+y^2)$.\n\nCombining both terms, the expected squared overlay at position $\\mathbf{r}$ is:\n$$\n\\mathbb{E}\\left[ \\|\\mathbf{O}(\\mathbf{r})\\|^{2} \\right] = 4\\sigma_T^2 + 2(\\sigma_M^2 + \\sigma_{\\theta}^2 + \\sigma_{\\alpha}^2)(x^2+y^2)\n$$\n\nNow, we compute the die-averaged RMS overlay. This involves integrating $\\mathbb{E}\\left[ \\|\\mathbf{O}(\\mathbf{r})\\|^{2} \\right]$ over the die area $R=[-a,a] \\times [-b,b]$ and dividing by the area $|R|=(2a)(2b)=4ab$.\n$$\n\\frac{1}{|R|} \\iint_{R} \\mathbb{E}\\left[ \\|\\mathbf{O}(\\mathbf{r})\\|^{2} \\right]\\, \\mathrm{d}x\\,\\mathrm{d}y = \\frac{1}{4ab} \\iint_{R} \\left( 4\\sigma_T^2 + 2(\\sigma_M^2 + \\sigma_{\\theta}^2 + \\sigma_{\\alpha}^2)(x^2+y^2) \\right) \\mathrm{d}x\\,\\mathrm{d}y\n$$\nThe integral separates:\n$$\n\\frac{1}{4ab} \\left( \\iint_{R} 4\\sigma_T^2 \\,\\mathrm{d}A + \\iint_{R} 2(\\sigma_M^2 + \\dots)(x^2+y^2) \\,\\mathrm{d}A \\right)\n$$\nThe first integral is $4\\sigma_T^2 \\iint_{R} \\mathrm{d}A = 4\\sigma_T^2 |R| = 16ab\\sigma_T^2$.\nThe second integral requires integrating $x^2+y^2$ over the rectangle:\n$$\n\\iint_{R} (x^2+y^2) \\,\\mathrm{d}x\\,\\mathrm{d}y = \\int_{-b}^{b} \\int_{-a}^{a} (x^2+y^2) \\,\\mathrm{d}x\\,\\mathrm{d}y\n$$\n$$\n= \\int_{-b}^{b} \\left[ \\frac{x^3}{3} + y^2x \\right]_{-a}^{a} \\,\\mathrm{d}y = \\int_{-b}^{b} \\left( \\frac{2a^3}{3} + 2ay^2 \\right) \\,\\mathrm{d}y\n$$\n$$\n= \\left[ \\frac{2a^3}{3}y + \\frac{2a}{3}y^3 \\right]_{-b}^{b} = \\frac{4a^3b}{3} + \\frac{4ab^3}{3} = \\frac{4ab}{3}(a^2+b^2)\n$$\nThis integral is also equal to $|R|\\frac{a^2+b^2}{3}$.\nPlugging back into the average calculation:\n$$\n\\mathrm{RMS}^2 = \\frac{1}{4ab} \\left( 16ab\\sigma_T^2 + 2(\\sigma_M^2 + \\sigma_{\\theta}^2 + \\sigma_{\\alpha}^2) \\frac{4ab}{3}(a^2+b^2) \\right)\n$$\n$$\n\\mathrm{RMS}^2 = 4\\sigma_T^2 + \\frac{2}{3}(\\sigma_M^2 + \\sigma_{\\theta}^2 + \\sigma_{\\alpha}^2)(a^2+b^2)\n$$\nThe RMS overlay is the square root of this expression:\n$$\n\\mathrm{RMS} = \\sqrt{4\\sigma_T^2 + \\frac{2}{3}(\\sigma_M^2 + \\sigma_{\\theta}^2 + \\sigma_{\\alpha}^2)(a^2+b^2)}\n$$\n\n### Step 3: Numerical Evaluation\n\nWe are given:\n- $a = 5\\,\\mathrm{mm} = 5 \\times 10^6\\,\\mathrm{nm}$\n- $b = 4\\,\\mathrm{mm} = 4 \\times 10^6\\,\\mathrm{nm}$\n- $\\sigma_T = 0.8\\,\\mathrm{nm}$\n- $\\sigma_M = 1.5 \\times 10^{-7}$\n- $\\sigma_{\\theta} = 3.5 \\times 10^{-7}$\n- $\\sigma_{\\alpha} = 1.0 \\times 10^{-7}$\n\nFirst, calculate the squared standard deviations:\n- $\\sigma_T^2 = (0.8)^2 = 0.64\\,\\mathrm{nm}^2$\n- $\\sigma_M^2 = (1.5 \\times 10^{-7})^2 = 2.25 \\times 10^{-14}$\n- $\\sigma_{\\theta}^2 = (3.5 \\times 10^{-7})^2 = 12.25 \\times 10^{-14}$\n- $\\sigma_{\\alpha}^2 = (1.0 \\times 10^{-7})^2 = 1.00 \\times 10^{-14}$\n\nNext, calculate the terms for $\\mathrm{RMS}^2$. All units will be in nm.\n- Translation component contribution: $4\\sigma_T^2 = 4 \\times 0.64\\,\\mathrm{nm}^2 = 2.56\\,\\mathrm{nm}^2$.\n- Distortion component contribution:\n    - Sum of squared sigmas: $\\Sigma_{\\sigma^2} = \\sigma_M^2 + \\sigma_{\\theta}^2 + \\sigma_{\\alpha}^2 = (2.25 + 12.25 + 1.00) \\times 10^{-14} = 15.5 \\times 10^{-14}$.\n    - Sum of squared dimensions: $a^2+b^2 = (5 \\times 10^6)^2 + (4 \\times 10^6)^2 = (25 \\times 10^{12}) + (16 \\times 10^{12}) = 41 \\times 10^{12}\\,\\mathrm{nm}^2$.\n    - Distortion term: $\\frac{2}{3}\\Sigma_{\\sigma^2}(a^2+b^2) = \\frac{2}{3}(15.5 \\times 10^{-14})(41 \\times 10^{12})\\,\\mathrm{nm}^2$.\n    - $= \\frac{2 \\times 15.5 \\times 41}{3} \\times 10^{-2}\\,\\mathrm{nm}^2 = \\frac{1271}{3} \\times 10^{-2}\\,\\mathrm{nm}^2 \\approx 4.23667\\,\\mathrm{nm}^2$.\n\nNow, calculate $\\mathrm{RMS}^2$:\n$$\n\\mathrm{RMS}^2 = 2.56\\,\\mathrm{nm}^2 + 4.23667\\,\\mathrm{nm}^2 = 6.79667\\,\\mathrm{nm}^2\n$$\nCalculate $\\mathrm{RMS}$:\n$$\n\\mathrm{RMS} = \\sqrt{6.79667}\\,\\mathrm{nm} \\approx 2.6070417\\,\\mathrm{nm}\n$$\nFinally, calculate the $3$-sigma overlay budget:\n$$\n3 \\times \\mathrm{RMS} = 3 \\times 2.6070417\\,\\mathrm{nm} \\approx 7.821125\\,\\mathrm{nm}\n$$\nRounding to four significant figures gives $7.821\\,\\mathrm{nm}$.",
            "answer": "$$\\boxed{7.821}$$"
        },
        {
            "introduction": "Our final practice explores the powerful concept of virtual metrology, a key technique in modern smart manufacturing. You will implement a Maximum A Posteriori (MAP) estimator, a Bayesian method that optimally fuses prior knowledge from process sensors with sparse on-wafer measurements. This allows for accurate overlay prediction even when metrology data is limited, enabling denser process control and faster feedback.",
            "id": "4146958",
            "problem": "You are asked to implement a simulation-based virtual metrology estimator for overlay in semiconductor lithography using a principled probabilistic model, and apply it to a provided test suite. The objective is to compute, for each test case, the predicted overlay vector at a specified query location, expressed in nanometers and rounded to three decimals.\n\nFundamental base:\n- Overlay is modeled by a linearized two-dimensional affine map. Let $p \\in \\mathbb{R}^{6}$ be the parameter vector $p = [t_x, t_y, a, b, c, d]^\\top$, where $t_x$ and $t_y$ are wafer-level translations in nanometers, and $a, b, c, d$ define a $2 \\times 2$ linear distortion matrix $M = \\begin{bmatrix} a & b \\\\ c & d \\end{bmatrix}$ with units of nanometers per millimeter. For any site coordinate $(x, y)$ in millimeters, the overlay vector $o(x,y) \\in \\mathbb{R}^{2}$ in nanometers is\n$$\no(x,y) = \\begin{bmatrix} t_x \\\\ t_y \\end{bmatrix} + \\begin{bmatrix} a & b \\\\ c & d \\end{bmatrix} \\begin{bmatrix} x \\\\ y \\end{bmatrix}.\n$$\n- For $N$ metrology sites with coordinates $\\{(x_i, y_i)\\}_{i=1}^{N}$ in millimeters and measured overlay vectors $\\{z_i\\}_{i=1}^{N}$ in nanometers, stack $z \\in \\mathbb{R}^{2N}$ as $z = [z_{1x}, z_{1y}, \\ldots, z_{Nx}, z_{Ny}]^{\\top}$. The linear measurement model is\n$$\nz = H p + v,\n$$\nwhere $H \\in \\mathbb{R}^{2N \\times 6}$ is block-constructed from rows\n$$\nH_i = \\begin{bmatrix}\n1 & 0 & x_i & y_i & 0 & 0 \\\\\n0 & 1 & 0 & 0 & x_i & y_i\n\\end{bmatrix},\n$$\nand $v \\sim \\mathcal{N}(0, R)$ is zero-mean Gaussian measurement noise with covariance $R \\in \\mathbb{R}^{2N \\times 2N}$. In this problem, $R$ is specified as $\\sigma^2 I_{2N}$, with $\\sigma$ in nanometers.\n\n- Virtual metrology prior: Let $u \\in \\mathbb{R}^{m}$ be a vector of process sensor features (unitless). The prior on $p$ is Gaussian,\n$$\np \\sim \\mathcal{N}(G u, Q),\n$$\nwhere $G \\in \\mathbb{R}^{6 \\times m}$ maps sensors to the prior mean $G u$, and $Q \\in \\mathbb{R}^{6 \\times 6}$ is a diagonal prior covariance with entries corresponding to the variances of $t_x, t_y$ in $(\\text{nm})^2$ and $a, b, c, d$ in $(\\text{nm}/\\text{mm})^2$.\n\nTasks:\n1. Using the above foundations, derive the Maximum A Posteriori (MAP) estimator for $p$ given $z$, $H$, $R$, $G$, $u$, and $Q$. Then implement it to compute the posterior mean $\\hat{p}$.\n2. For a given query coordinate $(x_q, y_q)$ in millimeters, compute the predicted overlay vector $\\hat{o}(x_q,y_q) = H_q \\hat{p}$, where\n$$\nH_q = \\begin{bmatrix}\n1 & 0 & x_q & y_q & 0 & 0 \\\\\n0 & 1 & 0 & 0 & x_q & y_q\n\\end{bmatrix}.\n$$\n3. For each test case below, produce the predicted overlay vector $\\hat{o}(x_q,y_q)$ in nanometers, round each component to three decimals, and report the results as specified.\n\nUnits:\n- All overlay vectors and translation components $t_x, t_y$ are in nanometers.\n- Coordinates $x, y, x_q, y_q$ are in millimeters.\n- Matrix entries $a, b, c, d$ have units of nanometers per millimeter.\n- Measurement noise standard deviation $\\sigma$ is in nanometers.\n- Express the final predicted overlay components in nanometers, rounded to three decimals.\n\nTest suite:\n- Common mapping from sensors to prior mean (used in all cases): let $m = 2$ and\n$$\nG = \\begin{bmatrix}\n0 & 0 \\\\\n0 & 0 \\\\\n0.05 & 0 \\\\\n0 & 0.02 \\\\\n0 & -0.02 \\\\\n0.05 & 0\n\\end{bmatrix},\n$$\nso that only $a, b, c, d$ depend on the sensor features $u$.\n\n- Case $1$ (well-conditioned, informative metrology):\n  - True parameter vector $p_{\\text{true}} = [5, -3, 0.8, 0.2, -0.1, 0.5]^{\\top}$.\n  - Metrology sites: $(-10, -10)$, $(-10, 10)$, $(10, -10)$, $(10, 10)$.\n  - Measured overlay $z$ is generated exactly by $z = H p_{\\text{true}}$ (i.e., noise-free synthesis).\n  - Measurement noise standard deviation $\\sigma = 2$.\n  - Prior covariance $Q = \\mathrm{diag}([100^2, 100^2, 0.5^2, 0.5^2, 0.5^2, 0.5^2])$.\n  - Sensor vector $u = [2, -1]^{\\top}$.\n  - Query coordinate $(x_q, y_q) = (5, -5)$.\n\n- Case $2$ (severely underdetermined metrology, strong virtual metrology reliance):\n  - True parameter vector $p_{\\text{true}} = [2, 1, 0.3, -0.4, 0.1, 0.2]^{\\top}$.\n  - Metrology sites: $(0, 0)$ only.\n  - Measured overlay $z = H p_{\\text{true}}$.\n  - Measurement noise standard deviation $\\sigma = 1$.\n  - Prior covariance $Q = \\mathrm{diag}([50^2, 50^2, 0.2^2, 0.2^2, 0.2^2, 0.2^2])$.\n  - Sensor vector $u = [4, 3]^{\\top}$.\n  - Query coordinate $(x_q, y_q) = (8, 8)$.\n\n- Case $3$ (informative sensors, low-weight metrology due to high noise):\n  - True parameter vector $p_{\\text{true}} = [-4, 6, 0.4, -0.3, 0.25, 0.1]^{\\top}$.\n  - Metrology sites: $(-5, 0)$, $(0, 5)$, $(5, 0)$, $(0, -5)$.\n  - Measured overlay $z = H p_{\\text{true}}$.\n  - Measurement noise standard deviation $\\sigma = 50$.\n  - Prior covariance $Q = \\mathrm{diag}([200^2, 200^2, 0.3^2, 0.3^2, 0.3^2, 0.3^2])$.\n  - Sensor vector $u = [-3, 5]^{\\top}$.\n  - Query coordinate $(x_q, y_q) = (-7, 12)$.\n\nRequired final output format:\n- Your program should produce a single line of output containing a comma-separated list of the three predicted overlay vectors in nanometers, each as a two-element list with components rounded to three decimals, enclosed in square brackets. For example: $[[o_{1x}, o_{1y}], [o_{2x}, o_{2y}], [o_{3x}, o_{3y}]]$, where each $o_{ix}$ and $o_{iy}$ is a float with exactly three decimals.",
            "solution": "The user-provided problem is assessed to be valid. It is scientifically grounded in standard estimation theory and semiconductor process modeling, well-posed with a unique solvable structure, and formulated with objective, unambiguous language. All necessary data and conditions for a complete solution are provided.\n\nThe core of this problem is to find the Maximum A Posteriori (MAP) estimate for a parameter vector $p$ within a linear-Gaussian framework, which combines prior information from process sensors with direct metrology data.\n\n### Derivation of the MAP Estimator\n\nThe problem is structured around two probabilistic models: a prior on the parameter vector $p$ and a likelihood model for the measurements $z$.\n\n1.  **Prior Distribution**: The parameter vector $p \\in \\mathbb{R}^6$ is assumed to follow a Gaussian distribution, conditioned on sensor data $u \\in \\mathbb{R}^m$. The prior mean is a linear function of $u$, $\\mu_p = Gu$, and the prior covariance is $Q \\in \\mathbb{R}^{6 \\times 6}$.\n    $$\n    p \\sim \\mathcal{N}(Gu, Q)\n    $$\n    The probability density function (PDF) of the prior is:\n    $$\n    f(p) = \\frac{1}{\\sqrt{(2\\pi)^6 |Q|}} \\exp \\left( -\\frac{1}{2} (p - Gu)^{\\top} Q^{-1} (p - Gu) \\right)\n    $$\n\n2.  **Likelihood Function**: The measurement vector $z \\in \\mathbb{R}^{2N}$ is related to $p$ through a linear model $z = Hp + v$, where $H \\in \\mathbb{R}^{2N \\times 6}$ is the design matrix and $v \\sim \\mathcal{N}(0, R)$ is the measurement noise. The noise covariance is given as $R = \\sigma^2 I_{2N}$. This implies that the likelihood of observing $z$ given $p$ is also Gaussian:\n    $$\n    z|p \\sim \\mathcal{N}(Hp, R)\n    $$\n    The PDF of the likelihood is:\n    $$\n    f(z|p) = \\frac{1}{\\sqrt{(2\\pi)^{2N} |R|}} \\exp \\left( -\\frac{1}{2} (z - Hp)^{\\top} R^{-1} (z - Hp) \\right)\n    $$\n\n3.  **Posterior Distribution and MAP Estimation**: According to Bayes' theorem, the posterior distribution of $p$ given $z$ is proportional to the product of the likelihood and the prior:\n    $$\n    f(p|z) \\propto f(z|p) f(p)\n    $$\n    The MAP estimate, denoted $\\hat{p}$, is the value of $p$ that maximizes the posterior probability $f(p|z)$. This is equivalent to minimizing the negative logarithm of the posterior. Let $J(p) = -\\log f(p|z)$. Ignoring constant terms that do not depend on $p$, we have:\n    $$\n    J(p) \\propto \\frac{1}{2} (z - Hp)^{\\top} R^{-1} (z - Hp) + \\frac{1}{2} (p - Gu)^{\\top} Q^{-1} (p - Gu)\n    $$\n    To find the minimum of this quadratic cost function, we compute its gradient with respect to $p$ and set it to zero. Using standard matrix calculus identities $\\nabla_x(c-Ax)^\\top B(c-Ax) = -2A^\\top B(c-Ax)$ and $\\nabla_x(x-d)^\\top C(x-d) = 2C(x-d)$ for symmetric $C$, we get:\n    $$\n    \\nabla_p J(p) = \\frac{1}{2} \\left[ -2H^{\\top}R^{-1}(z - Hp) + 2Q^{-1}(p - Gu) \\right] = 0\n    $$\n    $$\n    -H^{\\top}R^{-1}z + H^{\\top}R^{-1}Hp + Q^{-1}p - Q^{-1}Gu = 0\n    $$\n    Rearranging the terms to solve for $p$:\n    $$\n    (H^{\\top}R^{-1}H + Q^{-1}) p = H^{\\top}R^{-1}z + Q^{-1}Gu\n    $$\n    This yields the MAP estimator $\\hat{p}$:\n    $$\n    \\hat{p} = (H^{\\top}R^{-1}H + Q^{-1})^{-1} (H^{\\top}R^{-1}z + Q^{-1}Gu)\n    $$\n    Substituting $R = \\sigma^2 I_{2N}$, so $R^{-1} = \\frac{1}{\\sigma^2} I_{2N}$, the expression simplifies to:\n    $$\n    \\hat{p} = \\left(\\frac{1}{\\sigma^2}H^{\\top}H + Q^{-1}\\right)^{-1} \\left(\\frac{1}{\\sigma^2}H^{\\top}z + Q^{-1}Gu\\right)\n    $$\n    This is the posterior mean of the distribution $p|z$, which for a Gaussian posterior (as is the case here) coincides with the mode (MAP) and the median.\n\n### Algorithm for Solution\n\nFor each test case, the following steps are executed:\n1.  **Data Assembly**: The parameters for the case are collected: metrology sites $\\{(x_i, y_i)\\}_{i=1}^{N}$, true parameter vector $p_{\\text{true}}$, sensor vector $u$, noise standard deviation $\\sigma$, and the diagonal entries of the prior covariance $Q$. The common matrix $G$ is also used.\n2.  **Matrix Construction**:\n    - Build the $2N \\times 6$ design matrix $H$ by stacking the $2 \\times 6$ blocks $H_i$ for each site $(x_i, y_i)$:\n      $$\n      H_i = \\begin{bmatrix} 1 & 0 & x_i & y_i & 0 & 0 \\\\ 0 & 1 & 0 & 0 & x_i & y_i \\end{bmatrix}\n      $$\n    - Synthesize the \"measured\" overlay vector $z \\in \\mathbb{R}^{2N}$ using the noise-free model provided: $z = H p_{\\text{true}}$.\n    - Construct the prior covariance matrix $Q$ from its diagonal elements and compute its inverse $Q^{-1}$.\n    - Compute the prior mean vector $\\mu_p = Gu$.\n3.  **Parameter Estimation**:\n    - Compute the posterior precision matrix (the term to be inverted): $P_{\\text{post}}^{-1} = \\frac{1}{\\sigma^2}H^{\\top}H + Q^{-1}$.\n    - Compute the right-hand side vector: $b = \\frac{1}{\\sigma^2}H^{\\top}z + Q^{-1}Gu$.\n    - Solve the linear system $P_{\\text{post}}^{-1} \\hat{p} = b$ for the MAP estimate $\\hat{p}$. Numerically, it is more stable to solve this system directly rather than explicitly computing the matrix inverse.\n4.  **Prediction**:\n    - Construct the $2 \\times 6$ query matrix $H_q$ for the given query coordinate $(x_q, y_q)$:\n      $$\n      H_q = \\begin{bmatrix} 1 & 0 & x_q & y_q & 0 & 0 \\\\ 0 & 1 & 0 & 0 & x_q & y_q \\end{bmatrix}\n      $$\n    - Compute the predicted overlay vector $\\hat{o}(x_q, y_q) \\in \\mathbb{R}^2$ using the estimated parameters: $\\hat{o}(x_q, y_q) = H_q \\hat{p}$.\n5.  **Formatting**: Round each component of the resulting vector $\\hat{o}(x_q, y_q)$ to three decimal places and format as specified. This process is repeated for all three test cases.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the MAP estimate for overlay parameters and predicts overlay\n    at a query point for three different test cases.\n    \"\"\"\n\n    # Common mapping matrix G from sensors to prior mean\n    G = np.array([\n        [0.05, 0],\n        [0, 0.02],\n        [0, -0.02],\n        [0.05, 0]\n    ])\n    # The first two parameters (translations) are not dependent on sensors.\n    # Prepend two zero rows to G.\n    G = np.vstack([np.zeros((2, 2)), G])\n\n    test_cases = [\n        # Case 1 (well-conditioned, informative metrology)\n        {\n            \"p_true\": np.array([5, -3, 0.8, 0.2, -0.1, 0.5]),\n            \"sites\": [(-10, -10), (-10, 10), (10, -10), (10, 10)],\n            \"sigma\": 2.0,\n            \"Q_diag\": np.array([100.0**2, 100.0**2, 0.5**2, 0.5**2, 0.5**2, 0.5**2]),\n            \"u\": np.array([2, -1]),\n            \"query_coord\": (5, -5)\n        },\n        # Case 2 (severely underdetermined metrology, strong VM reliance)\n        {\n            \"p_true\": np.array([2, 1, 0.3, -0.4, 0.1, 0.2]),\n            \"sites\": [(0, 0)],\n            \"sigma\": 1.0,\n            \"Q_diag\": np.array([50.0**2, 50.0**2, 0.2**2, 0.2**2, 0.2**2, 0.2**2]),\n            \"u\": np.array([4, 3]),\n            \"query_coord\": (8, 8)\n        },\n        # Case 3 (informative sensors, low-weight metrology)\n        {\n            \"p_true\": np.array([-4, 6, 0.4, -0.3, 0.25, 0.1]),\n            \"sites\": [(-5, 0), (0, 5), (5, 0), (0, -5)],\n            \"sigma\": 50.0,\n            \"Q_diag\": np.array([200.0**2, 200.0**2, 0.3**2, 0.3**2, 0.3**2, 0.3**2]),\n            \"u\": np.array([-3, 5]),\n            \"query_coord\": (-7, 12)\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        p_true = case[\"p_true\"].reshape(-1, 1)\n        sites = case[\"sites\"]\n        sigma = case[\"sigma\"]\n        Q_diag = case[\"Q_diag\"]\n        u = case[\"u\"].reshape(-1, 1)\n        xq, yq = case[\"query_coord\"]\n\n        # 1. Construct the design matrix H from metrology sites\n        N = len(sites)\n        H = np.zeros((2 * N, 6))\n        for i, (xi, yi) in enumerate(sites):\n            H[2*i, :] = [1, 0, xi, yi, 0, 0]\n            H[2*i + 1, :] = [0, 1, 0, 0, xi, yi]\n\n        # 2. Synthesize the measurement vector z\n        z = H @ p_true\n\n        # 3. Construct prior-related matrices and vectors\n        Q = np.diag(Q_diag)\n        # For a diagonal matrix, the inverse is the reciprocal of diagonal elements\n        Q_inv = np.diag(1.0 / Q_diag)\n        mu_p = G @ u\n\n        # 4. Compute the MAP estimate p_hat using the derived formula\n        # p_hat = (H.T @ H / sigma^2 + Q_inv)^-1 @ (H.T @ z / sigma^2 + Q_inv @ mu_p)\n        \n        # It's numerically more stable to solve the linear system Ax=b\n        # where A = (H.T @ H / sigma^2 + Q_inv) and b = (H.T @ z / sigma^2 + Q_inv @ mu_p)\n        \n        # Posterior precision matrix (A)\n        posterior_precision = (1.0 / sigma**2) * H.T @ H + Q_inv\n        \n        # Right-hand side vector (b)\n        rhs_vector = (1.0 / sigma**2) * H.T @ z + Q_inv @ mu_p\n        \n        p_hat = np.linalg.solve(posterior_precision, rhs_vector)\n\n        # 5. Compute the predicted overlay at the query coordinate\n        H_q = np.array([\n            [1, 0, xq, yq, 0, 0],\n            [0, 1, 0, 0, xq, yq]\n        ])\n        \n        o_hat = H_q @ p_hat\n        results.append(o_hat.flatten())\n\n    # 6. Format the final output string\n    # We need to round to 3 decimals and ensure the \".000\" format is kept.\n    # Ex: [[-6.000,-9.500],[5.600,-0.800],[-10.450,12.500]]\n    formatted_results = [f\"[{res[0]:.3f},{res[1]:.3f}]\" for res in results]\n    final_output_str = f\"[{','.join(formatted_results)}]\"\n    \n    print(final_output_str)\n\nsolve()\n```"
        }
    ]
}