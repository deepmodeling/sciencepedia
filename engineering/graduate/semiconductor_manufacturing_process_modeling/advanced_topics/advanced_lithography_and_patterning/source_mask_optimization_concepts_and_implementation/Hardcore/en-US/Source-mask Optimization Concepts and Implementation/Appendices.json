{
    "hands_on_practices": [
        {
            "introduction": "Before we can optimize a system, we must first build a robust model of its behavior. This initial practice guides you through constructing a foundational forward model of the complete photolithography process, from the light that hits the resist to the final etched pattern. By implementing the transformation from an aerial image to a final critical dimension (CD) using the classic Dill and Mack models, you will gain a concrete understanding of the essential physics and chemistry governing photoresist response, which is the final and crucial link in the imaging chain .",
            "id": "4165986",
            "problem": "You are asked to construct, derive, and implement a forward photoresist model using the Dill parameters $(A,B,C)$ together with a development rate law, mapping a one-dimensional aerial image to a latent image and then to a final printed critical dimension (CD). This exercise is situated in the context of source-mask optimization, where the illumination source configuration and mask duty cycle co-determine the aerial image modulation. The goal is to start from first principles in optical absorption and chemically amplified resist kinetics, and then derive an algorithm that computes the final printed line width for a periodic line-space pattern under specified process conditions.\n\nFundamental base:\n- Beer–Lambert law for intensity attenuation: If $I_0(x)$ is the incident intensity at the resist top at lateral position $x$, the intensity at depth $z$ is $I(x,z) = I_0(x)\\,\\exp\\!\\left(-\\alpha(x)\\,z\\right)$, with $\\alpha(x)$ the effective absorption coefficient per unit length.\n- Dill model for photoactive compound (PAC) bleaching in a positive-tone resist: The remaining PAC fraction $m(x,t)$ evolves under exposure according to $\\dfrac{dm(x,t)}{dt} = -\\,C\\,I_{\\mathrm{eff}}(x)\\,m(x,t)$, with $m(x,0) = 1$, where $C$ is a Dill rate constant and $I_{\\mathrm{eff}}(x)$ is an effective intensity that accounts for depth-dependent attenuation.\n- Effective absorption under bleaching: The absorption coefficient transitions from $A$ (unbleached) toward $B$ (bleached) as the PAC is consumed. We model this by $\\alpha(x) = A\\,m(x) + B\\,[1 - m(x)]$ at the end of the exposure, which is a standard first-order closure connecting the latent image state to optical absorption.\n- Development rate law for a positive-tone chemically amplified resist: The local dissolution rate $R(x)$ increases as the resist becomes more deprotected (as $m(x)$ decreases). A widely used parametric law is a monotone sigmoidal Mack-type form $R(m) = R_{\\min} + \\bigl(R_{\\max} - R_{\\min}\\bigr)\\,\\biggl[\\,\\dfrac{1}{1 + \\left(\\dfrac{m}{m_{\\mathrm{th}}}\\right)^n}\\biggr]$, with $R_{\\min}$ and $R_{\\max}$ the limiting rates, $m_{\\mathrm{th}}$ a threshold-like scale for $m$, and $n$ a steepness exponent.\n\nDerivation targets:\n1. Derive the mapping from the aerial image $I_0(x)$ to the latent PAC fraction $m(x)$ at the end of the exposure time $t_{\\mathrm{exp}}$ by combining Beer–Lambert attenuation and the Dill kinetic model. Use the depth-averaged intensity\n$$\nI_{\\mathrm{eff}}(x) \\equiv \\frac{1}{d}\\int_0^d I_0(x)\\,\\exp\\bigl(-\\alpha(x)\\,z\\bigr)\\,dz\n= I_0(x)\\,\\frac{1 - \\exp\\!\\bigl(-\\alpha(x)\\,d\\bigr)}{\\alpha(x)\\,d},\n$$\nwith $d$ the resist thickness, and $\\alpha(x)$ computed self-consistently from $m(x)$ via $\\alpha(x) = A\\,m(x) + B\\,[1 - m(x)]$. Use a fixed-point iteration to resolve the coupling of $I_{\\mathrm{eff}}(x)$ and $m(x)$.\n2. Derive the mapping from the latent image $m(x)$ to the remaining resist thickness after development. The local thickness removed is $\\Delta h(x) = R\\!\\bigl(m(x)\\bigr)\\,t_{\\mathrm{dev}}$, where $t_{\\mathrm{dev}}$ is the development time; the remaining thickness is $h_{\\mathrm{rem}}(x) = \\max\\{0,\\,d - \\Delta h(x)\\}$.\n3. Define the final printed critical dimension as the contiguous width centered at a line minimum of $I_0(x)$ where the remaining resist thickness exceeds a survival threshold $h_{\\mathrm{th}} = \\beta\\,d$ with $0 < \\beta < 1$. Use linear interpolation to locate the threshold-crossing boundaries with sub-grid accuracy.\n4. Connect to source-mask optimization concepts: Model the one-dimensional aerial image for a periodic line-space pattern of pitch $P$ produced by a given source-mask configuration as\n$$\nI_0(x) = I_{\\mathrm{mean}}\\,\\Bigl(1 - M\\,\\cos\\!\\bigl(2\\pi x/P\\bigr)\\Bigr),\n$$\nwhere $I_{\\mathrm{mean}}$ is the mean intensity and $M$ is a modulation factor that reflects the combined influence of the illumination source shape and the mask duty cycle. Larger $M$ typically indicates improved source-mask optimization (higher image contrast), while smaller $M$ indicates poorer optimization (lower contrast).\n\nUnits and outputs:\n- Intensities $I_0(x)$ and $I_{\\mathrm{eff}}(x)$ must be treated in $\\mathrm{mW}/\\mathrm{cm}^2$.\n- Exposure time $t_{\\mathrm{exp}}$ and development time $t_{\\mathrm{dev}}$ must be in $\\mathrm{s}$.\n- Resist thickness $d$, pitch $P$, and the final printed CD must be in $\\mu\\mathrm{m}$.\n- Dill parameters satisfy: $A$ and $B$ are in $\\mu\\mathrm{m}^{-1}$, and $C$ is in $\\mathrm{cm}^2/\\mathrm{mJ}$ so that $C\\,I\\,t$ is dimensionless when $I$ is in $\\mathrm{mW}/\\mathrm{cm}^2$ and $t$ in $\\mathrm{s}$.\n- The development rate $R$ must be in $\\mu\\mathrm{m}/\\mathrm{s}$.\n- The final CD must be expressed in $\\mu\\mathrm{m}$ as a float rounded to $4$ decimal places.\n\nTest suite:\nYour program must compute the final CD for the following four test cases. In each case, evaluate one period on $x \\in [-P/2,\\,+P/2]$, assume the line center is at $x = 0$ (intensity minimum), and use the specified parameters. The mask line width $W_{\\mathrm{mask}}$ is provided for context but is not directly fed into the aerial image law; its role is to interpret whether the final CD aligns with the intended duty cycle under the given source-mask modulation $M$.\n\n- Case $1$ (happy path):\n    - $P = 0.5\\,\\mu\\mathrm{m}$, $W_{\\mathrm{mask}} = 0.25\\,\\mu\\mathrm{m}$,\n    - $I_{\\mathrm{mean}} = 10\\,\\mathrm{mW}/\\mathrm{cm}^2$, $M = 0.4$,\n    - $A = 1.2\\,\\mu\\mathrm{m}^{-1}$, $B = 0.6\\,\\mu\\mathrm{m}^{-1}$, $C = 0.02\\,\\mathrm{cm}^2/\\mathrm{mJ}$,\n    - $d = 0.3\\,\\mu\\mathrm{m}$, $t_{\\mathrm{exp}} = 10\\,\\mathrm{s}$,\n    - $R_{\\min} = 0.002\\,\\mu\\mathrm{m}/\\mathrm{s}$, $R_{\\max} = 0.04\\,\\mu\\mathrm{m}/\\mathrm{s}$, $m_{\\mathrm{th}} = 0.3$, $n = 5$,\n    - $t_{\\mathrm{dev}} = 8\\,\\mathrm{s}$, $\\beta = 0.1$.\n- Case $2$ (overexposure / high contrast):\n    - $P = 0.5\\,\\mu\\mathrm{m}$, $W_{\\mathrm{mask}} = 0.22\\,\\mu\\mathrm{m}$,\n    - $I_{\\mathrm{mean}} = 18\\,\\mathrm{mW}/\\mathrm{cm}^2$, $M = 0.5$,\n    - $A = 1.4\\,\\mu\\mathrm{m}^{-1}$, $B = 0.7\\,\\mu\\mathrm{m}^{-1}$, $C = 0.025\\,\\mathrm{cm}^2/\\mathrm{mJ}$,\n    - $d = 0.3\\,\\mu\\mathrm{m}$, $t_{\\mathrm{exp}} = 12\\,\\mathrm{s}$,\n    - $R_{\\min} = 0.003\\,\\mu\\mathrm{m}/\\mathrm{s}$, $R_{\\max} = 0.06\\,\\mu\\mathrm{m}/\\mathrm{s}$, $m_{\\mathrm{th}} = 0.35$, $n = 4$,\n    - $t_{\\mathrm{dev}} = 15\\,\\mathrm{s}$, $\\beta = 0.1$.\n- Case $3$ (underexposure / low contrast):\n    - $P = 0.5\\,\\mu\\mathrm{m}$, $W_{\\mathrm{mask}} = 0.28\\,\\mu\\mathrm{m}$,\n    - $I_{\\mathrm{mean}} = 6\\,\\mathrm{mW}/\\mathrm{cm}^2$, $M = 0.25$,\n    - $A = 1.0\\,\\mu\\mathrm{m}^{-1}$, $B = 0.5\\,\\mu\\mathrm{m}^{-1}$, $C = 0.018\\,\\mathrm{cm}^2/\\mathrm{mJ}$,\n    - $d = 0.3\\,\\mu\\mathrm{m}$, $t_{\\mathrm{exp}} = 8\\,\\mathrm{s}$,\n    - $R_{\\min} = 0.002\\,\\mu\\mathrm{m}/\\mathrm{s}$, $R_{\\max} = 0.035\\,\\mu\\mathrm{m}/\\mathrm{s}$, $m_{\\mathrm{th}} = 0.4$, $n = 6$,\n    - $t_{\\mathrm{dev}} = 8\\,\\mathrm{s}$, $\\beta = 0.1$.\n- Case $4$ (boundary / near-threshold):\n    - $P = 0.5\\,\\mu\\mathrm{m}$, $W_{\\mathrm{mask}} = 0.25\\,\\mu\\mathrm{m}$,\n    - $I_{\\mathrm{mean}} = 12\\,\\mathrm{mW}/\\mathrm{cm}^2$, $M = 0.45$,\n    - $A = 1.1\\,\\mu\\mathrm{m}^{-1}$, $B = 0.6\\,\\mu\\mathrm{m}^{-1}$, $C = 0.02\\,\\mathrm{cm}^2/\\mathrm{mJ}$,\n    - $d = 0.3\\,\\mu\\mathrm{m}$, $t_{\\mathrm{exp}} = 9\\,\\mathrm{s}$,\n    - $R_{\\min} = 0.0025\\,\\mu\\mathrm{m}/\\mathrm{s}$, $R_{\\max} = 0.045\\,\\mu\\mathrm{m}/\\mathrm{s}$, $m_{\\mathrm{th}} = 0.32$, $n = 5$,\n    - $t_{\\mathrm{dev}} = 10\\,\\mathrm{s}$, $\\beta = 0.1$.\n\nAlgorithmic requirements:\n- Implement a fixed-point iteration for $m(x)$ over $x$ on a uniform grid with at least $N = 2048$ points per period to capture edges and compute $I_{\\mathrm{eff}}(x)$ using the current $\\alpha(x)$ and then update $m(x)$ via the closed-form Dill solution $m(x) = \\exp\\!\\bigl(- C\\,I_{\\mathrm{eff}}(x)\\,t_{\\mathrm{exp}}\\bigr)$. Iterate until the maximum change in $m(x)$ is below a tolerance $\\varepsilon = 10^{-8}$ or a maximum of $50$ iterations is reached.\n- Evaluate the development rate $R\\!\\bigl(m(x)\\bigr)$ and the remaining thickness $h_{\\mathrm{rem}}(x)$, then locate the contiguous interval centered at $x=0$ where $h_{\\mathrm{rem}}(x) \\ge h_{\\mathrm{th}}$ using linear interpolation at the threshold crossings to compute the CD width.\n- Treat the special case $\\alpha(x)\\,d \\to 0$ by taking the limit $\\dfrac{1 - \\exp(-\\alpha d)}{\\alpha d} \\to 1$ to avoid numerical issues.\n\nFinal output format:\nYour program should produce a single line of output containing the resulting CDs for the four test cases as a comma-separated list enclosed in square brackets (e.g., $[0.2500,0.0000,0.4800,0.3100]$). Each CD must be in $\\mu\\mathrm{m}$ and rounded to $4$ decimal places.",
            "solution": "### Principle-Based Solution Derivation\n\nThe process of calculating the final printed Critical Dimension (CD) from the given source-mask and process parameters involves a sequence of modeling steps. Below, I derive the formalism for each step.\n\n**1. Aerial Image Modeling**\n\nThe starting point is the intensity pattern projected onto the photoresist, known as the aerial image. As specified, for a periodic line-space pattern with pitch $P$, we use a simplified sinusoidal model which captures the primary modulation:\n$$\nI_0(x) = I_{\\mathrm{mean}}\\,\\Bigl(1 - M\\,\\cos\\!\\bigl(\\frac{2\\pi x}{P}\\bigr)\\Bigr)\n$$\nHere, $I_{\\mathrm{mean}}$ is the average intensity, and $M \\in [0, 1]$ is the modulation or contrast of the image. A higher value of $M$ signifies a better-optimized source and mask, producing a higher-contrast image on the wafer. The intensity is minimal at the line center, $x=0$, where the printed feature will be formed in this positive-tone resist system.\n\n**2. Latent Image Formation: A Self-Consistent Model**\n\nUpon exposure, photons are absorbed in the resist, driving a chemical reaction that alters the solubility of the polymer matrix. In this Dill model, this is represented by the depletion of a photoactive compound (PAC), whose normalized concentration is $m(x)$.\n\nThe rate of PAC depletion is given by $\\dfrac{dm}{dt} = -C\\,I_{\\mathrm{eff}}(x)\\,m$. Integrating this from $t=0$ to $t=t_{\\mathrm{exp}}$ with the initial condition $m(x,0)=1$ gives the final PAC concentration, or \"latent image\":\n$$\nm(x) = \\exp\\bigl(- C\\,I_{\\mathrm{eff}}(x)\\,t_{\\mathrm{exp}}\\bigr)\n$$\nThe complexity arises because the light intensity itself, $I_{\\mathrm{eff}}(x)$, depends on the PAC concentration. The local absorption coefficient $\\alpha(x)$ is a linear interpolation between the fully unbleached value $A$ (where $m=1$) and the fully bleached value $B$ (where $m=0$):\n$$\n\\alpha(x) = A\\,m(x) + B\\,(1-m(x)) = (A-B)m(x) + B\n$$\nThe effective intensity $I_{\\mathrm{eff}}(x)$ is the depth-average of the intensity attenuated by absorption according to the Beer-Lambert law:\n$$\nI_{\\mathrm{eff}}(x) \\equiv \\frac{1}{d}\\int_0^d I(x,z)\\,dz = \\frac{1}{d}\\int_0^d I_0(x)\\,\\exp\\bigl(-\\alpha(x)\\,z\\bigr)\\,dz = I_0(x)\\,\\frac{1 - \\exp\\!\\bigl(-\\alpha(x)\\,d\\bigr)}{\\alpha(x)\\,d}\n$$\nThe term $\\frac{1 - \\exp(-\\alpha d)}{\\alpha d}$ represents the average transmittance through the resist film of thickness $d$. Note that in the limit $\\alpha d \\to 0$, this term correctly approaches $1$.\n\nCombining these equations reveals a self-consistent relationship for $m(x)$:\n$$\nm(x) = \\exp\\left( -C \\cdot t_{\\mathrm{exp}} \\cdot I_0(x) \\cdot \\frac{1 - \\exp\\left(-d\\left[(A-B)m(x) + B\\right]\\right)}{d\\left[(A-B)m(x) + B\\right]} \\right)\n$$\nThis is a transcendental equation of the form $m = f(m)$, which we solve at each spatial grid point $x_i$ using the specified fixed-point iteration algorithm:\n1.  Initialize $m^{(0)}(x_i) = 1$ (fully unexposed state).\n2.  For iteration $k=1, 2, \\dots, 50$:\n    a. Calculate the absorption coefficient from the previous estimate of $m$: $\\alpha^{(k)}(x_i) = (A-B)m^{(k-1)}(x_i) + B$.\n    b. Calculate the effective intensity: $I_{\\mathrm{eff}}^{(k)}(x_i) = I_0(x_i) \\cdot \\frac{1 - \\exp(-\\alpha^{(k)}(x_i)d)}{\\alpha^{(k)}(x_i)d}$.\n    c. Update the latent image: $m^{(k)}(x_i) = \\exp\\bigl(- C \\cdot I_{\\mathrm{eff}}^{(k)}(x_i) \\cdot t_{\\mathrm{exp}}\\bigr)$.\n3.  The iteration stops when the maximum change across all grid points falls below a tolerance: $\\max_i |m^{(k)}(x_i) - m^{(k-1)}(x_i)| < \\varepsilon = 10^{-8}$.\n\n**3. Resist Development and Profile Formation**\n\nAfter exposure, the resist is immersed in a developer solution. For a positive-tone resist, regions with lower PAC concentration ($m$) dissolve faster. The development rate $R$ is described by the sigmoidal Mack-type law:\n$$\nR(m) = R_{\\min} + (R_{\\max} - R_{\\min})\\,\\left[\\frac{1}{1 + \\left(\\frac{m}{m_{\\mathrm{th}}}\\right)^n}\\right]\n$$\nwhere $R_{\\min}$ and $R_{\\max}$ are the minimum and maximum development rates, $m_{\\mathrm{th}}$ is a threshold PAC concentration, and $n$ controls the contrast of the development process.\n\nAfter a development time $t_{\\mathrm{dev}}$, the amount of resist thickness removed at each position is $\\Delta h(x) = R(m(x)) \\cdot t_{\\mathrm{dev}}$. The remaining resist thickness profile is therefore:\n$$\nh_{\\mathrm{rem}}(x) = \\max\\{0, d - \\Delta h(x)\\}\n$$\n\n**4. Critical Dimension (CD) Calculation**\n\nThe final printed line is the region where resist remains on the substrate. The CD is defined as the width of this remaining feature. We determine this width by finding where the remaining resist profile $h_{\\mathrm{rem}}(x)$ crosses a predefined threshold height $h_{\\mathrm{th}} = \\beta \\cdot d$.\n\nSince the aerial image $I_0(x)$ is symmetric around $x=0$, the resulting resist profile $h_{\\mathrm{rem}}(x)$ will also be symmetric. We can therefore find the right-hand boundary $x_R > 0$ where $h_{\\mathrm{rem}}(x_R) = h_{\\mathrm{th}}$ and compute the CD as $2 \\cdot x_R$.\n\nTo achieve sub-grid accuracy, we use linear interpolation. We first scan outwards from the center ($x=0$) to find the first grid index $i$ where $h_{\\mathrm{rem}}(x_i) < h_{\\mathrm{th}}$. The crossing must lie between the grid points $x_{i-1}$ and $x_i$. Let $h_1 = h_{\\mathrm{rem}}(x_{i-1})$ and $h_2 = h_{\\mathrm{rem}}(x_i)$. The interpolated boundary $x_R$ is found by solving the linear equation:\n$$\nh_{\\mathrm{th}} = h_1 + \\frac{h_2 - h_1}{x_i - x_{i-1}}(x_R - x_{i-1})\n$$\nwhich gives:\n$$\nx_R = x_{i-1} + (x_i - x_{i-1}) \\frac{h_{\\mathrm{th}} - h_1}{h_2 - h_1}\n$$\nThe final CD is $2 \\cdot x_R$. If the resist at the center is fully removed ($h_{\\mathrm{rem}}(0) < h_{\\mathrm{th}}$), the line is considered \"pinched\" or broken, and the CD is $0$.",
            "answer": "```python\nimport numpy as np\n\ndef calculate_cd(params):\n    \"\"\"\n    Calculates the final printed CD based on a 1D lithography process model.\n\n    This function implements the entire simulation chain:\n    1.  Computes the aerial image.\n    2.  Solves for the latent image (PAC concentration) using a fixed-point iteration.\n    3.  Calculates the development rate and final resist profile.\n    4.  Determines the CD using thresholding and linear interpolation.\n    \"\"\"\n    (P, W_mask, I_mean, M, A, B, C, d, t_exp, \n     R_min, R_max, m_th, n, t_dev, beta) = params\n\n    # Algorithmic and numerical constants\n    N = 2049  # Use odd number for a point at x=0, satisfies N >= 2048\n    MAX_ITER = 50\n    TOL = 1e-8\n\n    # 1. Spatial Grid and Aerial Image\n    x = np.linspace(-P / 2, P / 2, N)\n    I0_x = I_mean * (1 - M * np.cos(2 * np.pi * x / P))\n\n    # 2. Latent Image Calculation (Fixed-Point Iteration)\n    m_x = np.ones_like(x)  # Initial PAC concentration m(x,0) = 1\n\n    for _ in range(MAX_ITER):\n        m_old = m_x.copy()\n\n        # a. Calculate absorption coefficient\n        alpha_x = (A - B) * m_old + B\n\n        # b. Calculate depth-averaged effective intensity\n        # Use np.expm1 for numerical stability: (1-exp(-y))/y = -expm1(-y)/y\n        # For small y, -expm1(-y) -> y, so the ratio is 1.\n        term = alpha_x * d\n        # A small value threshold to switch to the limit value\n        small_term_mask = np.abs(term) < 1e-9\n        \n        # Calculate the fraction term, handling small values\n        frac = np.ones_like(term)\n        # Use the stable formula only for non-small terms\n        non_small_mask = ~small_term_mask\n        frac[non_small_mask] = -np.expm1(-term[non_small_mask]) / term[non_small_mask]\n        \n        Ieff_x = I0_x * frac\n        \n        # c. Update PAC concentration\n        m_x = np.exp(-C * Ieff_x * t_exp)\n\n        # Check for convergence\n        if np.max(np.abs(m_x - m_old)) < TOL:\n            break\n            \n    # 3. Resist Development and Profile Formation\n    R_x = R_min + (R_max - R_min) / (1 + (m_x / m_th)**n)\n    h_rem_x = np.maximum(0, d - R_x * t_dev)\n\n    # 4. CD Calculation\n    h_th = beta * d\n    center_idx = N // 2\n\n    # Check if line center is removed (pinched)\n    if h_rem_x[center_idx] < h_th:\n        return 0.0\n\n    # Search for the threshold crossing on the right side (x > 0)\n    # Find the first index i > center_idx where h_rem < h_th\n    try:\n        # np.where returns a tuple of arrays; we need the first element of the first array\n        crossing_indices = np.where(h_rem_x[center_idx:] < h_th)[0]\n        if len(crossing_indices) == 0:\n            # This case means the resist never drops below the threshold,\n            # implying the feature spans the whole pitch.\n            return P\n            \n        i = crossing_indices[0] + center_idx\n        \n        # Points for linear interpolation\n        x1, x2 = x[i - 1], x[i]\n        h1, h2 = h_rem_x[i - 1], h_rem_x[i]\n\n        # Linear interpolation to find x_R\n        x_R = x1 + (x2 - x1) * (h_th - h1) / (h2 - h1)\n\n        # CD is 2 * x_R due to symmetry\n        cd = 2 * x_R\n        return cd\n\n    except IndexError:\n        # This shouldn't happen if the above check for empty crossing_indices works.\n        # Fallback if no crossing is found (e.g., resist is not cleared anywhere)\n        return P\n\n\ndef solve():\n    \"\"\"\n    Main function to run the lithography simulation for the given test cases.\n    \"\"\"\n    test_cases = [\n        # Case 1: happy path\n        (0.5, 0.25, 10, 0.4, 1.2, 0.6, 0.02, 0.3, 10, 0.002, 0.04, 0.3, 5, 8, 0.1),\n        # Case 2: overexposure / high contrast\n        (0.5, 0.22, 18, 0.5, 1.4, 0.7, 0.025, 0.3, 12, 0.003, 0.06, 0.35, 4, 15, 0.1),\n        # Case 3: underexposure / low contrast\n        (0.5, 0.28, 6, 0.25, 1.0, 0.5, 0.018, 0.3, 8, 0.002, 0.035, 0.4, 6, 8, 0.1),\n        # Case 4: boundary / near-threshold\n        (0.5, 0.25, 12, 0.45, 1.1, 0.6, 0.02, 0.3, 9, 0.0025, 0.045, 0.32, 5, 10, 0.1),\n    ]\n\n    results = []\n    for case in test_cases:\n        cd = calculate_cd(case)\n        results.append(cd)\n\n    # Format the final output string exactly as required.\n    formatted_results = [f\"{res:.4f}\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "The necessity of source-mask optimization becomes clearest in high numerical aperture (NA) systems, where simple scalar approximations of light break down and vector effects become dominant. This practice moves beyond the ideal scalar world to model the real-world impact of light's polarization on imaging performance. You will investigate how gratings of different orientations interact with polarized light, leading to critical dimension variations—a key challenge that advanced SMO strategies are designed to mitigate .",
            "id": "4165988",
            "problem": "You are tasked with implementing a physically and mathematically grounded program that models orientation-dependent imaging in projection lithography and quantifies the Critical Dimension (CD) variation between $x$-oriented and $y$-oriented line gratings under two illumination conditions: azimuthally polarized ring illumination and unpolarized ring illumination. The goal is to expose how vector effects in the pupil (Transverse Electric (TE) and Transverse Magnetic (TM) channel weighting and apodization) produce anisotropic imaging for azimuthal polarization but not for unpolarized illumination.\n\nBegin from the following fundamental base:\n- Electromagnetic imaging is governed by Maxwell’s equations, and for high-resolution optical systems the image formation in the focal region can be approximated by Fourier optics with vectorial corrections. Under coherent imaging with an extended incoherent source, the Abbe imaging model applies per source point, with image intensity as an incoherent sum over source points.\n- The scalar Abbe model states that the image field of a mask with transmission $T(\\mathbf{r})$ is the inverse Fourier transform of the mask spectrum $M(\\mathbf{f})$ filtered by the pupil function $P(\\mathbf{f})$ shifted by the source point lateral spatial frequency $\\mathbf{f}_{s}$, i.e., $E(\\mathbf{r}; \\alpha) = \\mathcal{F}^{-1}\\left\\{ M(\\mathbf{f}) P(\\mathbf{f} + \\mathbf{f}_s(\\alpha)) \\right\\}$, where $\\alpha$ is the source azimuth angle. The image intensity for partially coherent extended sources is an incoherent sum over source points.\n- Vector effects enter through polarization-dependent channel gains and apodization: Transverse Electric (TE) and Transverse Magnetic (TM) channels experience different angular transmission. For an aplanatic high Numerical Aperture (NA) lens, a standard first-order approximation is an apodization factor proportional to $\\sqrt{\\cos\\theta}$ for the field amplitude and an additional TM channel factor $\\cos\\theta$. Here $\\theta$ is the polar angle of the ray in the pupil. The azimuthally polarized source has the pupil electric field tangent to the pupil ($\\hat{\\mathbf{e}}_{\\phi}$), so the TE/TM weighting depends on the projection of $\\hat{\\mathbf{e}}_{\\phi}$ onto the TE and TM directions determined by the grating orientation. Unpolarized illumination is modeled as equal mixing of TE and TM with no azimuthal dependence.\n\nModeling assumptions and definitions:\n- Consider one-dimensional binary amplitude gratings of period $p$ (in $\\mathrm{nm}$) with line duty cycle $f \\in (0,1)$ (fraction of the period occupied by the absorbing line, amplitude transmission zero) and space transmission one. The $x$-oriented lines vary along $y$; the $y$-oriented lines vary along $x$; both are one-dimensional in their varying direction. The image is computed over one period, sampled uniformly.\n- The pupil cutoff spatial frequency is $f_c = \\mathrm{NA}/\\lambda$ (in cycles per $\\mathrm{nm}$), where $\\lambda$ is the wavelength in $\\mathrm{nm}$. The ring illumination has normalized radius $\\sigma \\in (0,1]$, resulting in a source lateral spatial-frequency magnitude $f_s = \\sigma f_c$. The pupil polar angle is $\\theta_s$ satisfying $\\sin\\theta_s = \\sigma \\sin\\theta_{\\max} = \\sigma \\,\\mathrm{NA}/n$, with refractive index $n$; thus $\\cos\\theta_s = \\sqrt{1 - (\\sigma \\,\\mathrm{NA}/n)^2}$.\n- For each source point at azimuth angle $\\alpha$ (in radians), the shift of the pupil filter in the varying direction is $s(\\alpha) = f_s \\sin\\alpha$ for $x$-oriented lines (variation along $y$) and $s(\\alpha) = f_s \\cos\\alpha$ for $y$-oriented lines (variation along $x$).\n- The TE/TM polarization weights are:\n  - Azimuthal polarization: $\\hat{\\mathbf{e}}_{\\phi} = (-\\sin\\alpha, \\cos\\alpha)$ in the $\\{x,y\\}$ basis. For $x$-oriented lines (variation along $y$), the TE direction is $\\hat{\\mathbf{x}}$ and the TM transverse direction is $\\hat{\\mathbf{y}}$, yielding $w_{\\mathrm{TE}}(\\alpha) = \\sin^2\\alpha$ and $w_{\\mathrm{TM}}(\\alpha) = \\cos^2\\alpha$. For $y$-oriented lines (variation along $x$), TE is $\\hat{\\mathbf{y}}$ and TM transverse is $\\hat{\\mathbf{x}}$, yielding $w_{\\mathrm{TE}}(\\alpha) = \\cos^2\\alpha$ and $w_{\\mathrm{TM}}(\\alpha) = \\sin^2\\alpha$.\n  - Unpolarized illumination: $w_{\\mathrm{TE}}(\\alpha) = w_{\\mathrm{TM}}(\\alpha) = 1/2$ for all $\\alpha$.\n- The field amplitude apodization is an overall multiplicative factor $\\sqrt{\\cos\\theta_s}$. The per-ray intensity contribution is $I_{\\alpha}(\\mathbf{r}) = \\left[w_{\\mathrm{TE}}(\\alpha)\\,g_{\\mathrm{TE}}^2 + w_{\\mathrm{TM}}(\\alpha)\\,g_{\\mathrm{TM}}^2\\right] \\left|\\sqrt{\\cos\\theta_s}\\, E(\\mathbf{r};\\alpha)\\right|^2$, with $g_{\\mathrm{TE}} = 1$ and $g_{\\mathrm{TM}} = \\cos\\theta_s$.\n\nProcedure to compute the CD:\n- Compute the aerial image intensity $I(\\mathbf{r})$ as the mean of $I_{\\alpha}(\\mathbf{r})$ over uniformly sampled $\\alpha \\in [0,2\\pi)$ for a ring source.\n- Normalize the aerial image by its maximum: $I_{\\mathrm{norm}}(\\mathbf{r}) = I(\\mathbf{r})/\\max_{\\mathbf{r}} I(\\mathbf{r})$.\n- Define the resist threshold $I_{\\mathrm{th}} \\in (0,1)$ and measure the CD per period as the measure (length) of the region in the period where $I_{\\mathrm{norm}}(\\mathbf{r}) \\le I_{\\mathrm{th}}$. This CD must be expressed in nanometers ($\\mathrm{nm}$).\n\nYour implementation must:\n- Use numerical Fast Fourier Transform (FFT) to compute $E(\\mathbf{r};\\alpha)$ for each $\\alpha$ as the inverse transform of the mask spectrum filtered by the shifted pupil.\n- Respect and use all units consistently; angles must be in radians.\n- Output the CD difference between $x$-oriented and $y$-oriented lines (defined as $\\mathrm{CD}_x - \\mathrm{CD}_y$) under azimuthal polarization and under unpolarized illumination for each test case, in nanometers, rounded to three decimal places.\n\nTest Suite:\nProvide results for the following three parameter sets, chosen to test different regime characteristics (happy path, low NA boundary, aggressive source and duty cycle):\n1. $\\mathrm{NA} = 1.35$, $n = 1.44$, $\\lambda = 193$ $\\mathrm{nm}$, $p = 160$ $\\mathrm{nm}$, $f = 0.5$, $\\sigma = 0.6$, $I_{\\mathrm{th}} = 0.45$.\n2. $\\mathrm{NA} = 0.85$, $n = 1.0$, $\\lambda = 193$ $\\mathrm{nm}$, $p = 230$ $\\mathrm{nm}$, $f = 0.5$, $\\sigma = 0.4$, $I_{\\mathrm{th}} = 0.50$.\n3. $\\mathrm{NA} = 1.35$, $n = 1.44$, $\\lambda = 193$ $\\mathrm{nm}$, $p = 150$ $\\mathrm{nm}$, $f = 0.3$, $\\sigma = 0.9$, $I_{\\mathrm{th}} = 0.50$.\n\nFinal Output Format:\nYour program should produce a single line of output containing the six results, ordered by test case and illumination type as follows:\n$[\\Delta_{\\mathrm{az},1},\\Delta_{\\mathrm{unpol},1},\\Delta_{\\mathrm{az},2},\\Delta_{\\mathrm{unpol},2},\\Delta_{\\mathrm{az},3},\\Delta_{\\mathrm{unpol},3}]$,\nwhere each $\\Delta$ is the CD difference in $\\mathrm{nm}$ rounded to three decimal places, and the list is comma-separated with no spaces (e.g., \"[0.123,0.000,0.456,0.000,0.789,0.000]\").",
            "solution": "The solution is implemented by modeling the aerial image formation process step-by-step, from the object (mask) to the final intensity distribution in the image plane. The model is predicated on the Abbe theory of partially coherent imaging, augmented with vector effects pertinent to high numerical aperture (NA) systems.\n\n**1. Foundation: The Abbe-Hopkins Theory**\nImage formation for a partially coherent source is modeled by considering the source as a collection of mutually incoherent point sources. The final image intensity is the sum (integral) of intensities produced by each source point individually. For a single source point, the imaging is coherent, and the image electric field $E(\\mathbf{r})$ is described by the Abbe model. The source point is defined by its position in the pupil, which corresponds to an oblique plane wave illuminating the mask. Its lateral spatial frequency is $\\mathbf{f}_s$.\nThe mask, with a complex transmission function $T(\\mathbf{r})$, has a Fourier spectrum $M(\\mathbf{f}) = \\mathcal{F}\\{T(\\mathbf{r})\\}$. The optical system's pupil acts as a low-pass filter, described by a pupil function $P(\\mathbf{f})$. For a source point $\\mathbf{f}_s$, the pupil is effectively shifted, filtering the mask spectrum with $P(\\mathbf{f}+\\mathbf{f}_s)$. The resulting field in the image plane is:\n$$E(\\mathbf{r}; \\mathbf{f}_s) = \\mathcal{F}^{-1}\\left\\{ M(\\mathbf{f}) P(\\mathbf{f} + \\mathbf{f}_s) \\right\\}$$\nThe intensity from this source point is $|E(\\mathbf{r}; \\mathbf{f}_s)|^2$. The total image intensity $I(\\mathbf{r})$ is the integral over all source points $S(\\mathbf{f}_s)$ in the source distribution:\n$$I(\\mathbf{r}) = \\int S(\\mathbf{f}_s) |E(\\mathbf{r}; \\mathbf{f}_s)|^2 d\\mathbf{f}_s$$\n\n**2. Numerical Implementation Setup**\nTo implement this model numerically, we use the Fast Fourier Transform (FFT).\n- **Spatial Domain:** The image is computed over one period $p$ of the grating. This domain is discretized into $N$ sample points. The coordinate $u$ (representing $x$ or $y$) is given by $u_j = j \\cdot \\Delta u$ for $j=0, \\dots, N-1$, where $\\Delta u = p/N$.\n- **Frequency Domain:** The corresponding discrete frequency grid $f_k$ is obtained via `numpy.fft.fftfreq`, with a frequency resolution of $\\Delta f = 1/p$.\n\n**3. Mask Model**\nThe problem specifies a one-dimensional binary amplitude grating with period $p$ and line duty cycle $f$. The line has zero transmission, and the space has unity transmission. The mask function $T(u)$ is a periodic binary function. Its spectrum, $M(f_k) = \\mathcal{F}\\{T(u_j)\\}$, is computed using `numpy.fft.fft`.\n\n**4. Source and Pupil Model**\n- **Ring Source:** The illumination is a ring source of normalized radius $\\sigma$. Each point on the ring, parameterized by an azimuth angle $\\alpha \\in [0, 2\\pi)$, corresponds to a source spatial frequency $\\mathbf{f}_s(\\alpha)$. The magnitude is fixed: $|\\mathbf{f}_s| = f_s = \\sigma f_c$, where $f_c = \\mathrm{NA}/\\lambda$ is the pupil's cutoff frequency. For a 1D grating analysis, we only need the component of $\\mathbf{f}_s$ along the grating's direction of variation.\n- **Pupil Shift:** For an $x$-oriented grating (variation along $y$), the relevant shift is $s(\\alpha) = f_s \\sin\\alpha$. For a $y$-oriented grating (variation along $x$), the shift is $s(\\alpha) = f_s \\cos\\alpha$.\n- **Pupil Function:** The pupil is a simple top-hat function: $P(f) = 1$ for $|f| \\le f_c$ and $0$ otherwise. For each source point $\\alpha$, the shifted pupil is $P(f + s(\\alpha))$.\n\n**5. Vector Corrections for High-NA Imaging**\nVector effects are introduced through polarization-dependent apodization factors.\n- **Pupil Apodization:** The field is modified by lens-induced apodization. Aplanatic lenses introduce a factor of $\\sqrt{\\cos\\theta_s}$ to the field amplitude for a source point at pupil polar angle $\\theta_s$, where $\\sin\\theta_s = \\sigma \\cdot \\mathrm{NA}/n$.\n- **Polarization Channels (TE/TM):** The electric field is decomposed into Transverse Electric (TE) and Transverse Magnetic (TM) components relative to the plane of diffraction (defined by the grating vector and the optical axis). These components experience different transmission gains, $g_{\\mathrm{TE}} = 1$ and $g_{\\mathrm{TM}} = \\cos\\theta_s$.\n- **Source Polarization:** The contribution of each channel depends on the source polarization state. An azimuthally polarized source has an electric field vector $\\hat{\\mathbf{e}}_{\\phi} = (-\\sin\\alpha, \\cos\\alpha)$ in the pupil plane.\n- **Intensity Calculation:** The intensity from a single source point $\\alpha$ is given by:\n$$I_{\\alpha}(\\mathbf{r}) = \\left[w_{\\mathrm{TE}}(\\alpha)\\,g_{\\mathrm{TE}}^2 + w_{\\mathrm{TM}}(\\alpha)\\,g_{\\mathrm{TM}}^2\\right] \\left|\\sqrt{\\cos\\theta_s}\\, E(\\mathbf{r};\\alpha)\\right|^2$$\nwhich simplifies to:\n$$I_{\\alpha}(\\mathbf{r}) = \\left(w_{\\mathrm{TE}}(\\alpha) + w_{\\mathrm{TM}}(\\alpha)\\cos^2\\theta_s\\right) \\cos\\theta_s \\left|E(\\mathbf{r};\\alpha)\\right|^2$$\nThe weights $w_{\\mathrm{TE}}(\\alpha)$ and $w_{\\mathrm{TM}}(\\alpha)$ depend on both the source polarization and grating orientation:\n- **Azimuthal Polarization:**\n  - For $x$-oriented lines (TE along $\\hat{x}$, TM along $\\hat{y}$): $w_{\\mathrm{TE}}(\\alpha) = \\sin^2\\alpha$, $w_{\\mathrm{TM}}(\\alpha) = \\cos^2\\alpha$.\n  - For $y$-oriented lines (TE along $\\hat{y}$, TM along $\\hat{x}$): $w_{\\mathrm{TE}}(\\alpha) = \\cos^2\\alpha$, $w_{\\mathrm{TM}}(\\alpha) = \\sin^2\\alpha$.\n- **Unpolarized Illumination:** Modeled as an incoherent average of two orthogonal polarizations, resulting in $w_{\\mathrm{TE}}(\\alpha) = w_{\\mathrm{TM}}(\\alpha) = 1/2$ for all $\\alpha$ and both orientations.\n\n**6. Image Synthesis and CD Metrology**\n- **Total Image:** The final aerial image intensity $I(\\mathbf{r})$ is the average of $I_{\\alpha}(\\mathbf{r})$ over all source points $\\alpha$ on the ring.\n$$I(\\mathbf{r}) = \\frac{1}{2\\pi} \\int_0^{2\\pi} I_{\\alpha}(\\mathbf{r}) d\\alpha$$\nNumerically, this integral becomes a sum over a discrete set of angles.\n- **Normalization:** The image is normalized to its maximum value: $I_{\\mathrm{norm}}(\\mathbf{r}) = I(\\mathbf{r})/\\max I(\\mathbf{r})$.\n- **CD Measurement:** The Critical Dimension (CD) is the width of the feature printed in the resist. This is modeled by finding the spatial extent of the region where the normalized intensity is below a certain resist threshold, $I_{\\mathrm{norm}}(\\mathbf{r}) \\le I_{\\mathrm{th}}$. To achieve sub-grid precision, linear interpolation is used to find the exact coordinates where $I_{\\mathrm{norm}}(\\mathbf{r}) = I_{\\mathrm{th}}$. The CD is the distance between these two threshold-crossing points.\n\n**7. Final Calculation**\nThe procedure is executed for both $x$- and $y$-oriented gratings under both azimuthal and unpolarized illumination. The final output is the difference $\\Delta \\mathrm{CD} = \\mathrm{CD}_x - \\mathrm{CD}_y$ for each illumination type. As expected, for unpolarized illumination, the symmetry of the source integration leads to $\\mathrm{CD}_x \\approx \\mathrm{CD}_y$, hence $\\Delta \\mathrm{CD} \\approx 0$. For azimuthal polarization, the orientation-dependent weighting breaks this symmetry, yielding a non-zero $\\Delta \\mathrm{CD}$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the lithography simulation for all test cases.\n    \"\"\"\n    # Test cases: (NA, n, lambda, p, f, sigma, I_th)\n    test_cases = [\n        (1.35, 1.44, 193.0, 160.0, 0.5, 0.6, 0.45),\n        (0.85, 1.0, 193.0, 230.0, 0.5, 0.4, 0.50),\n        (1.35, 1.44, 193.0, 150.0, 0.3, 0.9, 0.50),\n    ]\n\n    results = []\n    \n    for NA, n, lam, p, f, sigma, I_th in test_cases:\n        params = {\n            'NA': NA, 'n': n, 'lam': lam, 'p': p, 'f': f, \n            'sigma': sigma, 'I_th': I_th\n        }\n\n        # Azimuthal polarization\n        cd_x_az = compute_cd(**params, polarization='azimuthal', orientation='x_oriented')\n        cd_y_az = compute_cd(**params, polarization='azimuthal', orientation='y_oriented')\n        delta_az = cd_x_az - cd_y_az\n\n        # Unpolarized illumination\n        cd_x_unpol = compute_cd(**params, polarization='unpolarized', orientation='x_oriented')\n        cd_y_unpol = compute_cd(**params, polarization='unpolarized', orientation='y_oriented')\n        delta_unpol = cd_x_unpol - cd_y_unpol\n\n        results.extend([delta_az, delta_unpol])\n\n    # Format output as specified\n    formatted_results = [f\"{res:.3f}\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\ndef compute_cd(NA, n, lam, p, f, sigma, I_th, polarization, orientation):\n    \"\"\"\n    Computes the Critical Dimension (CD) for a given set of lithography parameters.\n    \"\"\"\n    N = 2048  # Number of samples for FFT\n    num_alpha = 180  # Number of source points for integration\n\n    # Spatial domain setup\n    u_coords = np.linspace(0, p, N, endpoint=False)\n    du = p / N\n\n    # Frequency domain setup\n    freq_grid = np.fft.fftfreq(N, d=du)\n\n    # Mask definition (line centered at p/2)\n    mask = np.ones(N)\n    line_width = p * f\n    line_start = p / 2 - line_width / 2\n    line_end = p / 2 + line_width / 2\n    mask_indices = (u_coords >= line_start) & (u_coords < line_end)\n    mask[mask_indices] = 0.0\n    mask_spectrum = np.fft.fft(mask)\n\n    # Pre-calculate physical constants\n    f_c = NA / lam\n    f_s = sigma * f_c\n    \n    # Ensure argument of sqrt is non-negative\n    cos_theta_s_arg = 1 - (sigma * NA / n)**2\n    if cos_theta_s_arg < 0:\n        # This case is physically impossible (evanescent wave) and not expected with valid inputs\n        cos_theta_s_arg = 0\n    cos_theta_s = np.sqrt(cos_theta_s_arg)\n    g_te = 1.0\n    g_tm = cos_theta_s\n    field_apodization_sq = cos_theta_s\n    \n    total_intensity = np.zeros(N)\n    alphas = np.linspace(0, 2 * np.pi, num_alpha, endpoint=False)\n\n    # Incoherent source integration loop\n    for alpha in alphas:\n        if orientation == 'x_oriented':  # Variation along y\n            shift = f_s * np.sin(alpha)\n        else:  # 'y_oriented', variation along x\n            shift = f_s * np.cos(alpha)\n\n        # Shifted pupil function\n        pupil = (np.abs(freq_grid + shift) <= f_c).astype(complex)\n\n        # Coherent imaging for a single source point\n        filtered_spectrum = mask_spectrum * pupil\n        image_field = np.fft.ifft(filtered_spectrum)\n        \n        # Polarization weights\n        if polarization == 'azimuthal':\n            if orientation == 'x_oriented':\n                w_te = np.sin(alpha)**2\n                w_tm = np.cos(alpha)**2\n            else:  # 'y_oriented'\n                w_te = np.cos(alpha)**2\n                w_tm = np.sin(alpha)**2\n        else:  # 'unpolarized'\n            w_te = 0.5\n            w_tm = 0.5\n            \n        # Intensity contribution from the current source point\n        intensity_polarization_factor = (w_te * g_te**2 + w_tm * g_tm**2)\n        intensity_alpha = intensity_polarization_factor * field_apodization_sq * np.abs(image_field)**2\n        total_intensity += intensity_alpha\n        \n    # Average intensity over all source points\n    aerial_image = total_intensity / num_alpha\n    \n    # Normalize the aerial image\n    max_intensity = np.max(aerial_image)\n    if max_intensity > 1e-9: # Avoid division by zero\n        normalized_image = aerial_image / max_intensity\n    else:\n        normalized_image = aerial_image\n\n    # CD measurement with linear interpolation\n    diff_from_threshold = normalized_image - I_th\n    # Find indices just before a sign change (a threshold crossing)\n    cross_indices = np.where(np.diff(np.sign(diff_from_threshold)))[0]\n    \n    crossings = []\n    for i in cross_indices:\n        u1, u2 = u_coords[i], u_coords[i+1]\n        I1, I2 = normalized_image[i], normalized_image[i+1]\n        \n        # Linear interpolation to find the exact crossing coordinate\n        if abs(I2 - I1) > 1e-9:\n            u_cross = u1 + (u2 - u1) * (I_th - I1) / (I2 - I1)\n            crossings.append(u_cross)\n\n    if len(crossings) >= 2:\n        # Assuming a simple dip profile, the CD is the distance between the two main crossings\n        crossings.sort()\n        # Find the two crossings that bracket the intensity minimum\n        min_idx = np.argmin(normalized_image)\n        min_pos = u_coords[min_idx]\n        \n        left_crosses = [c for c in crossings if c < min_pos]\n        right_crosses = [c for c in crossings if c > min_pos]\n\n        if left_crosses and right_crosses:\n            cd = min(right_crosses) - max(left_crosses)\n        else: # Fallback if profile is not a simple dip\n            cd = max(crossings) - min(crossings)\n    else:\n        # Handle cases where the whole profile is above or below the threshold\n        if np.all(diff_from_threshold <= 0):\n            cd = p  # Entire period is below threshold\n        else:\n            cd = 0.0  # Entire period is above threshold\n\n    return cd\n\n# Execute the main function when the script is run\nif __name__ == \"__main__\":\n    solve()\n\n```"
        },
        {
            "introduction": "The \"optimization\" in Source-Mask Optimization relies on efficiently calculating how to adjust the source and mask to improve the printed pattern. This theoretical exercise builds the mathematical engine for any gradient-based SMO algorithm, connecting the physics of image formation directly to the optimization objective. By deriving the functional gradient of a performance metric with respect to the source distribution, you will uncover the fundamental mechanism that allows computational tools to navigate a vast design space and find optimal solutions .",
            "id": "4165997",
            "problem": "Consider a partially coherent optical imaging system used in semiconductor photolithography, where the object is a binary mask with transmission function $m(\\mathbf{x})$ and spatial frequency representation $\\tilde{M}(\\boldsymbol{\\nu}) = \\int m(\\mathbf{x}) \\exp(-i 2 \\pi \\boldsymbol{\\nu} \\cdot \\mathbf{x}) \\, d\\mathbf{x}$. The illumination is characterized by a nonnegative source distribution $S(\\boldsymbol{\\sigma})$ over source coordinates $\\boldsymbol{\\sigma}$ in the entrance pupil. The imaging system is characterized by a pupil-dependent transfer function $H(\\boldsymbol{\\nu}, \\boldsymbol{\\sigma})$, which encapsulates the effect of the projection optics for a plane-wave component associated with the source coordinate $\\boldsymbol{\\sigma}$. Under the Hopkins formulation with the Transmission Cross Coefficient (TCC) representation, the aerial image $I(\\mathbf{u})$ at the wafer plane is given by a bilinear form in the mask and a linear functional of the source:\n$$\nI(\\mathbf{u}) \\;=\\; \\iint \\tilde{M}(\\boldsymbol{\\nu}_{1}) \\, \\tilde{M}^{*}(\\boldsymbol{\\nu}_{2}) \\left[ \\int S(\\boldsymbol{\\sigma}) \\, H(\\boldsymbol{\\nu}_{1}, \\boldsymbol{\\sigma}) \\, H^{*}(\\boldsymbol{\\nu}_{2}, \\boldsymbol{\\sigma}) \\, d\\boldsymbol{\\sigma} \\right] \\exp\\!\\big(i 2 \\pi \\mathbf{u} \\cdot (\\boldsymbol{\\nu}_{1} - \\boldsymbol{\\nu}_{2})\\big) \\, d\\boldsymbol{\\nu}_{1} \\, d\\boldsymbol{\\nu}_{2}.\n$$\nLet the performance of the lithographic patterning be measured by a differentiable loss functional $L(I)$ that depends on the aerial image $I(\\mathbf{u})$. Assume the functional derivative of the loss with respect to the image intensity exists and define $g(\\mathbf{u}) = \\frac{\\partial L}{\\partial I(\\mathbf{u})}$.\n\n1) Starting from the bilinear TCC representation and using the chain rule, derive the analytic expression for the functional gradient $\\frac{\\partial L}{\\partial S(\\boldsymbol{\\sigma})}$ as a linear functional of $g(\\mathbf{u})$, explicitly in terms of $H(\\boldsymbol{\\nu}, \\boldsymbol{\\sigma})$ and $\\tilde{M}(\\boldsymbol{\\nu})$.\n\n2) Consider a discrete implementation in Source-Mask Optimization (SMO), where the source is sampled on $K$ points $\\{\\boldsymbol{\\sigma}_{k}\\}_{k=1}^{K}$, the mask spectrum is supported on $N_{f}$ discrete spatial-frequency indices $\\{\\boldsymbol{\\nu}_{p}\\}_{p=1}^{N_{f}}$, and the image is sampled on $N_{u}$ observation points $\\{\\mathbf{u}_{n}\\}_{n=1}^{N_{u}}$. Suppose you evaluate the gradient entries $\\left\\{\\frac{\\partial L}{\\partial S(\\boldsymbol{\\sigma}_{k})}\\right\\}_{k=1}^{K}$ by direct summation without exploiting fast transforms or special structure beyond the bilinear form. Derive the leading-order computational complexity scaling, expressed using Big-O notation, for computing all $K$ gradient components in terms of $K$, $N_{f}$, and $N_{u}$.\n\nExpress your final answer as a single closed-form analytic expression for $\\frac{\\partial L}{\\partial S(\\boldsymbol{\\sigma})}$ in continuous form. No numerical evaluation is required, and no units are to be reported. Any complexity analysis should be included in your derivation and justification, but the final reported answer must only be the analytic expression for the gradient.",
            "solution": "### Part 1: Derivation of the Functional Gradient $\\frac{\\partial L}{\\partial S(\\boldsymbol{\\sigma})}$\n\nThe loss functional $L$ is a function of the image intensity $I(\\mathbf{u})$, which in turn is a functional of the source distribution $S(\\boldsymbol{\\sigma})$. We apply the chain rule for functional derivatives to find the gradient of $L$ with respect to $S$. The variation in $L$, denoted $\\delta L$, can be expressed in two ways:\n$$ \\delta L = \\int \\frac{\\partial L}{\\partial I(\\mathbf{u})} \\delta I(\\mathbf{u}) \\, d\\mathbf{u} = \\int g(\\mathbf{u}) \\delta I(\\mathbf{u}) \\, d\\mathbf{u} \\quad (1) $$\nand\n$$ \\delta L = \\int \\frac{\\partial L}{\\partial S(\\boldsymbol{\\sigma})} \\delta S(\\boldsymbol{\\sigma}) \\, d\\boldsymbol{\\sigma} \\quad (2) $$\nOur goal is to find an expression for $\\frac{\\partial L}{\\partial S(\\boldsymbol{\\sigma})}$. We begin by finding the variation of the image intensity, $\\delta I(\\mathbf{u})$, caused by a variation in the source, $\\delta S(\\boldsymbol{\\sigma})$. The image intensity $I(\\mathbf{u})$ is a linear functional of the source $S(\\boldsymbol{\\sigma})$. From the given equation for $I(\\mathbf{u})$, we can find its variation by varying $S$:\n$$ \\delta I(\\mathbf{u}) = \\iint \\tilde{M}(\\boldsymbol{\\nu}_{1}) \\, \\tilde{M}^{*}(\\boldsymbol{\\nu}_{2}) \\left[ \\int \\delta S(\\boldsymbol{\\sigma}) \\, H(\\boldsymbol{\\nu}_{1}, \\boldsymbol{\\sigma}) \\, H^{*}(\\boldsymbol{\\nu}_{2}, \\boldsymbol{\\sigma}) \\, d\\boldsymbol{\\sigma} \\right] \\exp\\!\\big(i 2 \\pi \\mathbf{u} \\cdot (\\boldsymbol{\\nu}_{1} - \\boldsymbol{\\nu}_{2})\\big) \\, d\\boldsymbol{\\nu}_{1} \\, d\\boldsymbol{\\nu}_{2} $$\nThe functional derivative $\\frac{\\delta I(\\mathbf{u})}{\\delta S(\\boldsymbol{\\sigma})}$ is the kernel of the integral operator mapping $\\delta S$ to $\\delta I$. By inspection, we find:\n$$ \\frac{\\delta I(\\mathbf{u})}{\\delta S(\\boldsymbol{\\sigma})} = \\iint \\tilde{M}(\\boldsymbol{\\nu}_{1}) \\tilde{M}^{*}(\\boldsymbol{\\nu}_{2}) H(\\boldsymbol{\\nu}_{1}, \\boldsymbol{\\sigma}) H^{*}(\\boldsymbol{\\nu}_{2}, \\boldsymbol{\\sigma}) \\exp\\!\\big(i 2 \\pi \\mathbf{u} \\cdot (\\boldsymbol{\\nu}_{1} - \\boldsymbol{\\nu}_{2})\\big) \\, d\\boldsymbol{\\nu}_{1} \\, d\\boldsymbol{\\nu}_{2} $$\nThis expression can be factorized. We group terms with $\\boldsymbol{\\nu}_{1}$ and $\\boldsymbol{\\nu}_{2}$ separately:\n$$ \\frac{\\delta I(\\mathbf{u})}{\\delta S(\\boldsymbol{\\sigma})} = \\left[ \\int \\tilde{M}(\\boldsymbol{\\nu}_{1}) H(\\boldsymbol{\\nu}_{1}, \\boldsymbol{\\sigma}) \\exp(i 2 \\pi \\mathbf{u} \\cdot \\boldsymbol{\\nu}_{1}) \\, d\\boldsymbol{\\nu}_{1} \\right] \\left[ \\int \\tilde{M}^{*}(\\boldsymbol{\\nu}_{2}) H^{*}(\\boldsymbol{\\nu}_{2}, \\boldsymbol{\\sigma}) \\exp(-i 2 \\pi \\mathbf{u} \\cdot \\boldsymbol{\\nu}_{2}) \\, d\\boldsymbol{\\nu}_{2} \\right] $$\nLet us define the complex coherent electric field at the wafer plane, $E(\\mathbf{u}, \\boldsymbol{\\sigma})$, associated with illumination from a single source point $\\boldsymbol{\\sigma}$:\n$$ E(\\mathbf{u}, \\boldsymbol{\\sigma}) = \\int \\tilde{M}(\\boldsymbol{\\nu}) H(\\boldsymbol{\\nu}, \\boldsymbol{\\sigma}) \\exp(i 2 \\pi \\mathbf{u} \\cdot \\boldsymbol{\\nu}) \\, d\\boldsymbol{\\nu} $$\nThis field is the inverse Fourier transform of the product of the mask spectrum $\\tilde{M}(\\boldsymbol{\\nu})$ and the pupil function $H(\\boldsymbol{\\nu}, \\boldsymbol{\\sigma})$. The second term in the factored expression for $\\frac{\\delta I(\\mathbf{u})}{\\delta S(\\boldsymbol{\\sigma})}$ is the complex conjugate of $E(\\mathbf{u}, \\boldsymbol{\\sigma})$. Therefore, the functional derivative of the image intensity with respect to the source is the coherent intensity at the wafer:\n$$ \\frac{\\delta I(\\mathbf{u})}{\\delta S(\\boldsymbol{\\sigma})} = E(\\mathbf{u}, \\boldsymbol{\\sigma}) E^{*}(\\mathbf{u}, \\boldsymbol{\\sigma}) = |E(\\mathbf{u}, \\boldsymbol{\\sigma})|^2 $$\nNow, we can find the desired gradient $\\frac{\\partial L}{\\partial S(\\boldsymbol{\\sigma})}$ using the chain rule relation $\\frac{\\partial L}{\\partial S(\\boldsymbol{\\sigma})} = \\int \\frac{\\partial L}{\\partial I(\\mathbf{u})} \\frac{\\delta I(\\mathbf{u})}{\\delta S(\\boldsymbol{\\sigma})} d\\mathbf{u}$. Substituting the expressions for the derivatives:\n$$ \\frac{\\partial L}{\\partial S(\\boldsymbol{\\sigma})} = \\int g(\\mathbf{u}) |E(\\mathbf{u}, \\boldsymbol{\\sigma})|^2 \\, d\\mathbf{u} $$\nFinally, to express the result explicitly in terms of the given functions $g(\\mathbf{u})$, $\\tilde{M}(\\boldsymbol{\\nu})$, and $H(\\boldsymbol{\\nu}, \\boldsymbol{\\sigma})$, we substitute the definition of $E(\\mathbf{u}, \\boldsymbol{\\sigma})$ into this result:\n$$ \\frac{\\partial L}{\\partial S(\\boldsymbol{\\sigma})} = \\int g(\\mathbf{u}) \\left| \\int \\tilde{M}(\\boldsymbol{\\nu}) H(\\boldsymbol{\\nu}, \\boldsymbol{\\sigma}) \\exp(i 2 \\pi \\mathbf{u} \\cdot \\boldsymbol{\\nu}) \\, d\\boldsymbol{\\nu} \\right|^2 d\\mathbf{u} $$\nThis is the final analytical expression for the functional gradient. It is a linear functional of $g(\\mathbf{u})$ and represents the inner product of the loss gradient w.r.t the image with the coherent intensity generated by the source point $\\boldsymbol{\\sigma}$.\n\n### Part 2: Computational Complexity Analysis\n\nWe now analyze the computational complexity of evaluating the gradient for a discrete implementation. The source is sampled at $K$ points $\\{\\boldsymbol{\\sigma}_{k}\\}$, the mask spectrum at $N_{f}$ frequencies $\\{\\boldsymbol{\\nu}_{p}\\}$, and the image at $N_{u}$ points $\\{\\mathbf{u}_{n}\\}$. The gradient components to be computed are $\\left\\{\\frac{\\partial L}{\\partial S(\\boldsymbol{\\sigma}_{k})}\\right\\}_{k=1}^{K}$.\n\nThe discrete form of the gradient derived in Part 1 is:\n$$ \\frac{\\partial L}{\\partial S(\\boldsymbol{\\sigma}_{k})} = \\sum_{n=1}^{N_{u}} g(\\mathbf{u}_{n}) \\left| E(\\mathbf{u}_{n}, \\boldsymbol{\\sigma}_{k}) \\right|^2 $$\nwhere the discrete coherent field $E(\\mathbf{u}_{n}, \\boldsymbol{\\sigma}_{k})$ is given by:\n$$ E(\\mathbf{u}_{n}, \\boldsymbol{\\sigma}_{k}) = \\sum_{p=1}^{N_{f}} \\tilde{M}(\\boldsymbol{\\nu}_{p}) H(\\boldsymbol{\\nu}_{p}, \\boldsymbol{\\sigma}_{k}) \\exp(i 2 \\pi \\mathbf{u}_{n} \\cdot \\boldsymbol{\\nu}_{p}) $$\nThe computation proceeds by direct summation as specified. We can outline the computation as a series of nested loops and count the operations.\n\n1.  **Compute all coherent fields $E(\\mathbf{u}_{n}, \\boldsymbol{\\sigma}_{k})$**:\n    -   There are $K$ source points, $N_{u}$ image points, and $N_{f}$ frequency points. This calculation requires a three-level nested loop structure iterating over $k \\in \\{1, \\dots, K\\}$, $n \\in \\{1, \\dots, N_{u}\\}$, and $p \\in \\{1, \\dots, N_{f}\\}$.\n    -   The innermost operation involves multiplying three complex numbers ($\\tilde{M}_p$, $H_{pk}$, and the exponential term) and adding to a running sum. This is an $O(1)$ operation.\n    -   The total number of such operations to compute all $E(\\mathbf{u}_{n}, \\boldsymbol{\\sigma}_{k})$ values is proportional to the product of the loop ranges.\n    -   Cost of computing all fields: $O(K \\cdot N_{u} \\cdot N_{f})$.\n\n2.  **Compute the gradient components $\\frac{\\partial L}{\\partial S(\\boldsymbol{\\sigma}_{k})}$**:\n    -   For each source point $k$, we need to compute the sum over all image points $n$: $\\sum_{n=1}^{N_{u}} g_n |E_{nk}|^2$.\n    -   This requires a two-level nested loop structure over $k \\in \\{1, \\dots, K\\}$ and $n \\in \\{1, \\dots, N_{u}\\}$.\n    -   Inside the inner loop, we compute the squared magnitude of $E_{nk}$ (which is pre-computed from step 1), multiply by $g_n$, and add to a running sum for $\\frac{\\partial L}{\\partial S(\\boldsymbol{\\sigma}_{k})}$. This is an $O(1)$ operation.\n    -   The total cost for this step is $O(K \\cdot N_{u})$.\n\n3.  **Total Computational Complexity**:\n    -   The total cost is the sum of the costs of the two steps: $O(K N_{u} N_{f} + K N_{u})$.\n    -   In typical lithography simulations, the number of frequency components $N_{f}$ is at least $1$, so $K N_{u} N_{f} \\ge K N_{u}$. Therefore, the leading-order complexity is dominated by the field computation step.\n    -   The final leading-order computational complexity scaling is $O(K N_{f} N_{u})$.\n\nThis complexity arises from a straightforward, direct summation implementation without the use of fast Fourier transforms (FFTs), which, if applicable, could reduce the complexity of the sum over $p$ and $n$ from $O(N_u N_f)$ to $O(N \\log N)$ where $N$ is the number of grid points in the corresponding domain.",
            "answer": "$$\\boxed{\\int g(\\mathbf{u}) \\left| \\int \\tilde{M}(\\boldsymbol{\\nu}) H(\\boldsymbol{\\nu}, \\boldsymbol{\\sigma}) \\exp(i 2 \\pi \\mathbf{u} \\cdot \\boldsymbol{\\nu}) \\, d\\boldsymbol{\\nu} \\right|^2 d\\mathbf{u}}$$"
        }
    ]
}