{
    "hands_on_practices": [
        {
            "introduction": "The foundation of modeling radiative thermal processing is a precise understanding of the energy source. Lamps used in these systems are often approximated as blackbody or graybody emitters, whose radiative power is distributed across a spectrum of wavelengths as described by Planck's law. This exercise challenges you to move beyond simply using the total power and instead calculate the fraction of energy emitted within a specific wavelength band, a critical task for accurately modeling how lamp radiation couples to a spectrally-sensitive material like silicon . By deriving and implementing a numerically robust solution, you will gain hands-on experience with the fundamental physics of thermal radiation.",
            "id": "4158476",
            "problem": "A tungsten-halogen lamp array used in Rapid Thermal Processing (RTP) can be idealized as a collection of blackbody-like emitters with a filament temperature around $T \\approx 3000\\,\\mathrm{K}$. For radiative heat transfer modeling of the wafer-lamp coupling, an essential quantity is the band-limited fraction of the total blackbody emissive power emitted within a wavelength interval $[\\lambda_1,\\lambda_2]$. Starting from fundamental radiation laws appropriate for semiconductor manufacturing process modeling, implement a program that computes the dimensionless fraction\n$F(\\lambda_1,\\lambda_2;T) = \\dfrac{\\int_{\\lambda_1}^{\\lambda_2} E_\\lambda^{b}(T)\\, d\\lambda}{\\sigma T^4}$,\nwhere $E_\\lambda^{b}(T)$ is the spectral blackbody emissive power and $\\sigma$ is the Stefan–Boltzmann constant. Your derivation must begin with Planck’s law and the definition of total blackbody emissive power (the Stefan–Boltzmann law), and develop a numerically robust strategy appropriate for band integration in the near-infrared regime relevant to lamp array modeling. Do not assume any pre-tabulated blackbody fraction functions; instead, derive a numerically stable integral representation and specify a concrete numerical quadrature strategy to evaluate it for given parameters.\n\nAll physical constants you use must be standard and explicitly stated, and all calculations must be performed in the International System of Units (SI). The final reported quantity $F(\\lambda_1,\\lambda_2;T)$ is dimensionless and must be returned as a decimal number.\n\nYour program must evaluate $F(\\lambda_1,\\lambda_2;T)$ for the following test suite of parameter sets, each specified as $(\\lambda_1,\\lambda_2,T)$:\n\n- Case A (near-infrared band at tungsten-like temperature): $(0.8\\,\\mu\\mathrm{m},\\,2.5\\,\\mu\\mathrm{m},\\,3000\\,\\mathrm{K})$.\n- Case B (sanity check, full spectrum): $(0\\,\\mu\\mathrm{m},\\,+\\infty\\,\\mu\\mathrm{m},\\,3000\\,\\mathrm{K})$.\n- Case C (visible band at tungsten-like temperature): $(0.4\\,\\mu\\mathrm{m},\\,0.7\\,\\mu\\mathrm{m},\\,3000\\,\\mathrm{K})$.\n- Case D (near-infrared band at slightly cooler lamp): $(0.8\\,\\mu\\mathrm{m},\\,2.5\\,\\mu\\mathrm{m},\\,2800\\,\\mathrm{K})$.\n- Case E (degenerate band): $(1.0\\,\\mu\\mathrm{m},\\,1.0\\,\\mu\\mathrm{m},\\,3000\\,\\mathrm{K})$.\n\nInterpret $+\\infty$ as mathematical infinity. Angles are not involved. All wavelengths must be internally converted from micrometers to meters before use. The output for each case must be a single floating-point number between $0$ and $1$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[resultA,resultB,resultC,resultD,resultE]\"). Each floating-point result must be rounded to $8$ significant figures. No other text should be printed.",
            "solution": "The problem requires the computation of the band-limited fraction of total blackbody emissive power, a fundamental quantity in radiative heat transfer analysis, particularly relevant to modeling Rapid Thermal Processing (RTP) systems. The solution procedure begins with a validation of the problem statement, which is found to be scientifically sound, well-posed, and objective. The problem is based on established principles of thermal physics and is directly applicable to the specified engineering context. All provided parameters are realistic, and the requirements are self-consistent.\n\nThe core of the problem is to evaluate the dimensionless fraction $F(\\lambda_1, \\lambda_2; T)$ defined as:\n$$\nF(\\lambda_1,\\lambda_2;T) = \\frac{\\int_{\\lambda_1}^{\\lambda_2} E_\\lambda^{b}(T)\\, d\\lambda}{\\int_{0}^{\\infty} E_\\lambda^{b}(T)\\, d\\lambda}\n$$\nThe denominator represents the total blackbody emissive power, which, according to the Stefan–Boltzmann law, is equal to $\\sigma T^4$. The term $E_\\lambda^{b}(T)$ is the spectral blackbody emissive power, described by Planck’s law:\n$$\nE_\\lambda^{b}(T) = \\frac{2\\pi h c^2}{\\lambda^5 \\left(\\exp\\left(\\frac{hc}{\\lambda k_B T}\\right) - 1\\right)}\n$$\nwhere $h$ is the Planck constant, $c$ is the speed of light in vacuum, $k_B$ is the Boltzmann constant, $T$ is the absolute temperature, and $\\lambda$ is the wavelength.\n\nDirect numerical integration of this expression is prone to numerical instability due to the $\\lambda^5$ term at small wavelengths and potential floating-point overflow or underflow in the exponential term. A robust numerical strategy requires reformulating the integral. This is achieved through a change of variables to non-dimensionalize the integral. Let us define a dimensionless variable $x$ as:\n$$\nx = \\frac{hc}{\\lambda k_B T}\n$$\nFrom this, we can express $\\lambda$ and its differential $d\\lambda$ in terms of $x$:\n$$\n\\lambda = \\frac{hc}{x k_B T} \\quad \\implies \\quad d\\lambda = -\\frac{hc}{x^2 k_B T} dx\n$$\nThe integration limits also change. As $\\lambda$ goes from $\\lambda_1$ to $\\lambda_2$, $x$ goes from $x_2 = \\frac{hc}{\\lambda_1 k_B T}$ to $x_1 = \\frac{hc}{\\lambda_2 k_B T}$.\n\nSubstituting these into the integral in the numerator of $F(\\lambda_1, \\lambda_2; T)$:\n$$\n\\int_{\\lambda_1}^{\\lambda_2} E_\\lambda^{b}(T)\\, d\\lambda = \\int_{x_2}^{x_1} \\frac{2\\pi h c^2}{\\left(\\frac{hc}{x k_B T}\\right)^5 \\left(e^x - 1\\right)} \\left(-\\frac{hc}{x^2 k_B T}\\right) dx\n$$\nBy reversing the integration limits to cancel the negative sign and simplifying the algebraic terms, we get:\n$$\n\\int_{x_1}^{x_2} \\frac{2\\pi h c^2 (k_B T)^5 x^5}{(hc)^5 (e^x - 1)} \\frac{h c}{x^2 k_B T} dx = \\left(\\frac{2\\pi k_B^4}{h^3 c^2}\\right) T^4 \\int_{x_1}^{x_2} \\frac{x^3}{e^x - 1} dx\n$$\nThe denominator, the total emissive power, is found by letting $\\lambda_1 \\to 0$ and $\\lambda_2 \\to \\infty$, which corresponds to $x_2 \\to \\infty$ and $x_1 \\to 0$:\n$$\n\\sigma T^4 = \\int_{0}^{\\infty} E_\\lambda^{b}(T)\\, d\\lambda = \\left(\\frac{2\\pi k_B^4}{h^3 c^2}\\right) T^4 \\int_{0}^{\\infty} \\frac{x^3}{e^x - 1} dx\n$$\nThe definite integral $\\int_{0}^{\\infty} \\frac{x^3}{e^x - 1} dx$ is a standard form related to the Bose-Einstein integral and evaluates to $\\frac{\\pi^4}{15}$. This allows for a derivation of the Stefan-Boltzmann constant $\\sigma$ in terms of fundamental constants:\n$$\n\\sigma = \\frac{2\\pi k_B^4}{h^3 c^2} \\frac{\\pi^4}{15} = \\frac{2\\pi^5 k_B^4}{15 h^3 c^2}\n$$\n\nNow, the fraction $F(\\lambda_1, \\lambda_2; T)$ can be expressed as the ratio of the two transformed integrals:\n$$\nF(\\lambda_1,\\lambda_2;T) = \\frac{\\left(\\frac{2\\pi k_B^4}{h^3 c^2}\\right) T^4 \\int_{x_1}^{x_2} \\frac{x^3}{e^x - 1} dx}{\\left(\\frac{2\\pi k_B^4}{h^3 c^2}\\right) T^4 \\int_{0}^{\\infty} \\frac{x^3}{e^x - 1} dx} = \\frac{\\int_{x_1}^{x_2} \\frac{x^3}{e^x - 1} dx}{\\frac{\\pi^4}{15}}\n$$\nThis gives the final, numerically stable expression to be implemented:\n$$\nF(\\lambda_1,\\lambda_2;T) = \\frac{15}{\\pi^4} \\int_{\\frac{hc}{\\lambda_2 k_B T}}^{\\frac{hc}{\\lambda_1 k_B T}} \\frac{x^3}{e^x - 1} dx\n$$\nThe integrand, $f(x) = \\frac{x^3}{e^x - 1}$, is well-behaved and the integration is over a finite interval for finite, non-zero $\\lambda_1, \\lambda_2$.\n\nFor the numerical implementation, the following physical constants (2018 CODATA values) are used in SI units:\n- Planck constant, $h = 6.62607015 \\times 10^{-34}$ J·s\n- Speed of light, $c = 299792458$ m/s\n- Boltzmann constant, $k_B = 1.380649 \\times 10^{-23}$ J/K\n\nThe specified numerical quadrature strategy is to use the `quad` function from the `scipy.integrate` library. This function employs an adaptive quadrature scheme based on the QUADPACK FORTRAN library, which is robust for a wide variety of integrands, including those with integrable singularities at the endpoints. It can also handle infinite integration limits, which is necessary for Case B.\n\nThe test cases are handled as follows:\n- **Cases A, C, D**: Standard evaluation with finite, non-zero limits. Wavelengths are converted from $\\mu$m to m.\n- **Case B $(\\lambda_1=0, \\lambda_2=\\infty)$**: The integration limits for $x$ become $(\\infty, 0)$, so the integral is $\\int_0^\\infty$. The numerical integrator will compute this, and the result should be $1.0$, serving as a validation of the normalization.\n- **Case E $(\\lambda_1=\\lambda_2)$**: The integration limits are identical ($x_1=x_2$), so the integral is zero. This is handled with a conditional check to return $0.0$ directly.\n\nFor numerical precision, the term $e^x - 1$ is computed using `numpy.expm1(x)`, which maintains accuracy for small values of $x$. A safeguard is also included to handle potential overflow for very large $x$ in the integrand, where the function value tends to zero rapidly.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import integrate\n\ndef solve():\n    \"\"\"\n    Solves the blackbody radiation fraction problem for a suite of test cases.\n    The implementation follows the derivation of a numerically stable integral\n    representation of the band-limited emission fraction.\n    \"\"\"\n\n    # Physical Constants (2018 CODATA values, SI units)\n    H = 6.62607015e-34      # Planck constant (J.s)\n    C = 299792458.0         # Speed of light in vacuum (m/s)\n    K_B = 1.380649e-23      # Boltzmann constant (J/K)\n\n    # Second radiation constant, C2 = h*c/k_B (m.K)\n    C2 = H * C / K_B\n\n    def integrand(x):\n        \"\"\"\n        The non-dimensionalized integrand for the blackbody radiation function.\n        f(x) = x^3 / (exp(x) - 1).\n        \"\"\"\n        # Handle the limit at x=0, which is 0.\n        if x == 0:\n            return 0.0\n        # Prevent overflow for large x, where the integrand approaches zero.\n        # np.exp(709.78) is near floating point limit.\n        if x > 709.0:\n            return 0.0\n        # np.expm1(x) provides better precision for exp(x)-1 when x is small.\n        return x**3 / np.expm1(x)\n\n    def calculate_F(lambda1_micron, lambda2_micron, T_kelvin):\n        \"\"\"\n        Calculates the fraction of blackbody radiation F in the band [lambda1, lambda2]\n        at temperature T.\n\n        Args:\n            lambda1_micron (float): Start wavelength in micrometers.\n            lambda2_micron (float): End wavelength in micrometers.\n            T_kelvin (float): Temperature in Kelvin.\n\n        Returns:\n            float: The dimensionless fraction F.\n        \"\"\"\n        # Case E: Degenerate band of zero width\n        if lambda1_micron == lambda2_micron:\n            return 0.0\n        \n        # Convert wavelengths from micrometers to meters\n        lambda1_m = lambda1_micron * 1e-6\n        lambda2_m = lambda2_micron * 1e-6\n\n        # Calculate the dimensionless integration limits x = hc / (lambda * k_B * T)\n        # Note the inverse relationship between lambda and x.\n        \n        # Upper limit x2 corresponds to lower wavelength lambda1\n        if lambda1_m == 0.0:\n            x2 = np.inf\n        else:\n            x2 = C2 / (lambda1_m * T_kelvin)\n\n        # Lower limit x1 corresponds to upper wavelength lambda2\n        if np.isinf(lambda2_m):\n            x1 = 0.0\n        else:\n            x1 = C2 / (lambda2_m * T_kelvin)\n        \n        # The integral is over [x1, x2]\n        integral_val, _ = integrate.quad(integrand, x1, x2)\n        \n        # The total integral from 0 to infinity is pi^4 / 15\n        normalization_constant = 15.0 / (np.pi**4)\n        \n        return normalization_constant * integral_val\n\n    # Define the test cases from the problem statement.\n    # Each case is a tuple: (lambda1_micron, lambda2_micron, T_kelvin)\n    test_cases = [\n        (0.8, 2.5, 3000.0),      # Case A\n        (0.0, np.inf, 3000.0),   # Case B\n        (0.4, 0.7, 3000.0),      # Case C\n        (0.8, 2.5, 2800.0),      # Case D\n        (1.0, 1.0, 3000.0),      # Case E\n    ]\n\n    results = []\n    for case in test_cases:\n        lambda1, lambda2, T = case\n        fraction = calculate_F(lambda1, lambda2, T)\n        # Format the result to 8 significant figures\n        results.append(f\"{fraction:.8g}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "While understanding the source spectrum is crucial, the interaction of that radiation with the wafer is equally important. The absorptivity of materials like silicon can vary significantly with wavelength, a complexity often simplified by the \"gray body\" approximation, where absorptivity is assumed constant. This practice asks you to analyze the validity of this common assumption by quantifying the error it introduces in a realistic scenario where the wafer's absorptivity changes across the lamp's emission spectrum . Completing this analysis will sharpen your ability to critically evaluate modeling assumptions and understand their impact on simulation accuracy.",
            "id": "4158884",
            "problem": "A silicon wafer is heated in a Rapid Thermal Processing (RTP) system by an array of tungsten–halogen lamps. Assume the wafer is spatially isothermal, macroscopically smooth, optically thick over the near-infrared spectrum of interest, and that the wafer surface behaves as a diffuse, gray–nongray emitter/absorber with negligible transmission. The lamp bank and wafer face each other with unit view factor and the chamber walls are cold and nonparticipating. The spectral irradiance of the lamp field incident on the wafer can be modeled as three narrow bands centered at wavelengths $\\lambda_{1} = 0.9\\,\\mu\\mathrm{m}$, $\\lambda_{2} = 1.1\\,\\mu\\mathrm{m}$, and $\\lambda_{3} = 1.4\\,\\mu\\mathrm{m}$ that together carry all of the incident radiant power. Let the corresponding fractions of the total incident irradiance be $f_{1} = 0.50$, $f_{2} = 0.30$, and $f_{3} = 0.20$, with $f_{1} + f_{2} + f_{3} = 1$. The total incident irradiance magnitude is $H_{i}$.\n\nOver the band $[0.8, 1.5]\\,\\mu\\mathrm{m}$, the wafer’s spectral emissivity (equal to its absorptivity by Kirchhoff’s law) is well approximated by a linear function of wavelength,\n$$\n\\varepsilon(\\lambda) = \\varepsilon_{0} + s\\left(\\lambda - \\lambda_{\\mathrm{ref}}\\right),\n$$\nwith $\\varepsilon_{0} = 0.68$, $s = 0.25\\,\\mu\\mathrm{m}^{-1}$, and $\\lambda_{\\mathrm{ref}} = 1.0\\,\\mu\\mathrm{m}$. Outside this band, the lamp spectral power is negligible.\n\nStarting from the fundamental radiative transfer statement that the absorbed irradiance equals the spectral integral of the product of the wafer absorptivity and the incident spectral irradiance, and using the narrow-band representation above, first state and justify the physical and mathematical conditions under which replacing $\\varepsilon(\\lambda)$ by a constant (the gray-body approximation) yields a negligible error in predicting the absorbed lamp power. Then, using the common practitioner’s gray approximation $\\varepsilon_{g} = \\varepsilon(\\lambda_{\\mathrm{ref}})$, quantify the relative error $\\delta$ in the predicted absorbed lamp power due to the actual spectral variation of $\\varepsilon(\\lambda)$ over the lamp spectrum. Define\n$$\n\\delta \\equiv \\frac{q_{\\mathrm{gray}} - q_{\\mathrm{exact}}}{q_{\\mathrm{exact}}},\n$$\nwhere $q_{\\mathrm{exact}}$ is the absorbed irradiance computed with the true $\\varepsilon(\\lambda)$ and $q_{\\mathrm{gray}}$ is that computed with the constant $\\varepsilon_{g}$.\n\nExpress the final answer for $\\delta$ as a dimensionless decimal number and round your answer to four significant figures. No other result should be reported as the final answer.",
            "solution": "The problem is first validated to ensure it is scientifically sound, well-posed, and complete.\n\n### Step 1: Extract Givens\n-   System: A silicon wafer heated in a Rapid Thermal Processing (RTP) system.\n-   Assumptions: Wafer is spatially isothermal, macroscopically smooth, optically thick, and a diffuse, gray–nongray emitter/absorber with negligible transmission. Lamp and wafer have a unit view factor. Chamber walls are cold and nonparticipating.\n-   Incident Irradiance Model: Composed of three narrow bands.\n    -   Wavelengths: $\\lambda_{1} = 0.9\\,\\mu\\mathrm{m}$, $\\lambda_{2} = 1.1\\,\\mu\\mathrm{m}$, $\\lambda_{3} = 1.4\\,\\mu\\mathrm{m}$.\n    -   Fractions of total irradiance ($H_i$): $f_{1} = 0.50$, $f_{2} = 0.30$, $f_{3} = 0.20$. Note that $f_{1} + f_{2} + f_{3} = 1$.\n-   Wafer Spectral Emissivity/Absorptivity: In the band $[0.8, 1.5]\\,\\mu\\mathrm{m}$, $\\varepsilon(\\lambda) = \\varepsilon_{0} + s\\left(\\lambda - \\lambda_{\\mathrm{ref}}\\right)$.\n    -   Constants: $\\varepsilon_{0} = 0.68$, $s = 0.25\\,\\mu\\mathrm{m}^{-1}$, $\\lambda_{\\mathrm{ref}} = 1.0\\,\\mu\\mathrm{m}$.\n-   Gray Approximation: $\\varepsilon_{g} = \\varepsilon(\\lambda_{\\mathrm{ref}})$.\n-   Relative Error Definition: $\\delta \\equiv \\frac{q_{\\mathrm{gray}} - q_{\\mathrm{exact}}}{q_{\\mathrm{exact}}}$, where $q_{\\mathrm{exact}}$ and $q_{\\mathrm{gray}}$ are absorbed irradiances.\n\n### Step 2: Validate Using Extracted Givens\n-   **Scientifically Grounded**: The problem is based on the fundamental principles of radiative heat transfer, specifically spectral integration for nongray surfaces. The scenario (RTP of silicon) and the physical models (linear emissivity, narrow-band source) are common and valid approximations in engineering analysis.\n-   **Well-Posed**: The problem is clearly defined. It provides all necessary data and definitions to calculate the required quantities. The question is unambiguous and leads to a unique solution.\n-   **Objective**: The language is technical and free of subjective content.\n-   **Completeness and Consistency**: The data is self-consistent (e.g., $f_1+f_2+f_3=1$) and sufficient for the calculation. The givens are physically plausible.\n\n### Step 3: Verdict and Action\nThe problem is valid. A complete solution will be provided.\n\n### Solution Derivation\n\nThe analysis is divided into two parts as requested: first, a general discussion of the gray-body approximation, and second, the specific calculation of the relative error.\n\n**Part 1: Conditions for a Valid Gray-Body Approximation**\n\nThe absorbed radiant power per unit area, or irradiance, $q_{\\mathrm{abs}}$, is determined by integrating the product of the spectral absorptivity, $\\alpha(\\lambda)$, and the incident spectral irradiance, $H_{i,\\lambda}(\\lambda)$, over all wavelengths:\n$$\nq_{\\mathrm{abs}} = \\int_{0}^{\\infty} \\alpha(\\lambda) H_{i,\\lambda}(\\lambda) \\,d\\lambda\n$$\nFor an opaque surface, Kirchhoff's law of thermal radiation states that the spectral, directional emissivity is equal to the spectral, directional absorptivity. For a diffuse surface, this simplifies to $\\varepsilon(\\lambda) = \\alpha(\\lambda)$ at each wavelength $\\lambda$. The problem states these conditions apply. Therefore, the exact absorbed irradiance is:\n$$\nq_{\\mathrm{exact}} = \\int_{0}^{\\infty} \\varepsilon(\\lambda) H_{i,\\lambda}(\\lambda) \\,d\\lambda\n$$\nThe total incident irradiance is $H_{i} = \\int_{0}^{\\infty} H_{i,\\lambda}(\\lambda) \\,d\\lambda$. We can define a source-averaged emissivity (or absorptivity), $\\bar{\\varepsilon}_{S}$, as:\n$$\n\\bar{\\varepsilon}_{S} = \\frac{\\int_{0}^{\\infty} \\varepsilon(\\lambda) H_{i,\\lambda}(\\lambda) \\,d\\lambda}{\\int_{0}^{\\infty} H_{i,\\lambda}(\\lambda) \\,d\\lambda} = \\frac{q_{\\mathrm{exact}}}{H_{i}}\n$$\nThus, $q_{\\mathrm{exact}} = \\bar{\\varepsilon}_{S} H_{i}$.\n\nA gray-body approximation assumes the emissivity is constant with wavelength, i.e., $\\varepsilon(\\lambda) = \\varepsilon_{g}$. The absorbed irradiance under this approximation is:\n$$\nq_{\\mathrm{gray}} = \\int_{0}^{\\infty} \\varepsilon_{g} H_{i,\\lambda}(\\lambda) \\,d\\lambda = \\varepsilon_{g} \\int_{0}^{\\infty} H_{i,\\lambda}(\\lambda) \\,d\\lambda = \\varepsilon_{g} H_{i}\n$$\nThe error in the gray-body approximation is negligible when $q_{\\mathrm{gray}} \\approx q_{\\mathrm{exact}}$, which implies that $\\varepsilon_{g} \\approx \\bar{\\varepsilon}_{S}$.\n\nThe physical and mathematical conditions for this are:\n1.  **Physical Condition**: The gray-body approximation is accurate if the spectral emissivity $\\varepsilon(\\lambda)$ is nearly constant over the spectral region where the incident irradiance $H_{i,\\lambda}(\\lambda)$ is significant. If the source emits in a narrow band, or if $\\varepsilon(\\lambda)$ is flat across the source's emission spectrum, the approximation will be very good.\n2.  **Mathematical Condition**: The error is zero if $\\varepsilon_{g} = \\bar{\\varepsilon}_{S}$. This means the chosen constant $\\varepsilon_g$ must equal the source-irradiance-weighted average of the true spectral emissivity. The error is small if the integral of the deviations, weighted by the source spectrum, is close to zero:\n    $$\n    \\int_{0}^{\\infty} \\left( \\varepsilon_{g} - \\varepsilon(\\lambda) \\right) H_{i,\\lambda}(\\lambda) \\,d\\lambda \\approx 0\n    $$\nThis condition implies that the positive and negative variations of $\\varepsilon(\\lambda)$ around the chosen constant $\\varepsilon_g$ must effectively cancel each other out when weighted by the spectral power distribution of the incident radiation.\n\n**Part 2: Calculation of Relative Error $\\delta$**\n\nThe problem models the incident spectral irradiance as three discrete, narrow bands, which for integration purposes can be treated as Dirac delta functions:\n$$\nH_{i,\\lambda}(\\lambda) = H_{i} \\left[ f_{1} \\delta(\\lambda - \\lambda_{1}) + f_{2} \\delta(\\lambda - \\lambda_{2}) + f_{3} \\delta(\\lambda - \\lambda_{3}) \\right]\n$$\nThe exact absorbed irradiance, $q_{\\mathrm{exact}}$, is found by substituting this into the integral and using the sifting property of the delta function:\n$$\nq_{\\mathrm{exact}} = \\int_0^\\infty \\varepsilon(\\lambda) H_{i} \\left[ f_{1} \\delta(\\lambda-\\lambda_{1}) + f_{2} \\delta(\\lambda-\\lambda_{2}) + f_{3} \\delta(\\lambda-\\lambda_{3}) \\right] d\\lambda\n$$\n$$\nq_{\\mathrm{exact}} = H_{i} \\left[ f_{1} \\varepsilon(\\lambda_{1}) + f_{2} \\varepsilon(\\lambda_{2}) + f_{3} \\varepsilon(\\lambda_{3}) \\right]\n$$\nWe calculate the emissivity values at the specified wavelengths using the given linear model, $\\varepsilon(\\lambda) = \\varepsilon_{0} + s\\left(\\lambda - \\lambda_{\\mathrm{ref}}\\right)$, with $\\varepsilon_{0} = 0.68$, $s = 0.25\\,\\mu\\mathrm{m}^{-1}$, and $\\lambda_{\\mathrm{ref}} = 1.0\\,\\mu\\mathrm{m}$.\n$$\n\\varepsilon(\\lambda_{1}) = \\varepsilon(0.9\\,\\mu\\mathrm{m}) = 0.68 + 0.25(0.9 - 1.0) = 0.68 - 0.025 = 0.655\n$$\n$$\n\\varepsilon(\\lambda_{2}) = \\varepsilon(1.1\\,\\mu\\mathrm{m}) = 0.68 + 0.25(1.1 - 1.0) = 0.68 + 0.025 = 0.705\n$$\n$$\n\\varepsilon(\\lambda_{3}) = \\varepsilon(1.4\\,\\mu\\mathrm{m}) = 0.68 + 0.25(1.4 - 1.0) = 0.68 + 0.100 = 0.780\n$$\nNow, substitute these values along with the irradiance fractions ($f_{1}=0.50$, $f_{2}=0.30$, $f_{3}=0.20$) into the expression for $q_{\\mathrm{exact}}$:\n$$\nq_{\\mathrm{exact}} = H_{i} \\left[ (0.50)(0.655) + (0.30)(0.705) + (0.20)(0.780) \\right]\n$$\n$$\nq_{\\mathrm{exact}} = H_{i} \\left[ 0.3275 + 0.2115 + 0.1560 \\right] = H_{i} (0.6950)\n$$\nThe source-averaged emissivity is thus $\\bar{\\varepsilon}_{S} = 0.6950$.\n\nNext, we calculate the absorbed irradiance using the gray approximation, $q_{\\mathrm{gray}}$. The problem specifies using $\\varepsilon_{g} = \\varepsilon(\\lambda_{\\mathrm{ref}})$.\n$$\n\\varepsilon_{g} = \\varepsilon(1.0\\,\\mu\\mathrm{m}) = 0.68 + 0.25(1.0 - 1.0) = 0.68\n$$\nSo, the absorbed irradiance in the gray approximation is:\n$$\nq_{\\mathrm{gray}} = \\varepsilon_{g} H_{i} = 0.68 H_{i}\n$$\nFinally, we compute the relative error $\\delta$ using the provided definition:\n$$\n\\delta = \\frac{q_{\\mathrm{gray}} - q_{\\mathrm{exact}}}{q_{\\mathrm{exact}}} = \\frac{0.68 H_{i} - 0.6950 H_{i}}{0.6950 H_{i}} = \\frac{0.68 - 0.6950}{0.6950}\n$$\n$$\n\\delta = \\frac{-0.0150}{0.6950} \\approx -0.0215827338...\n$$\nRounding to four significant figures, the relative error is $-0.02158$.",
            "answer": "$$\n\\boxed{-0.02158}\n$$"
        },
        {
            "introduction": "To achieve the highest fidelity in thermal process modeling, we must often turn to numerical techniques that can handle the full complexity of radiative exchange. This capstone exercise guides you through the design of a Monte Carlo ray-tracing (MCRT) estimator, a powerful probabilistic method for simulating radiative heat transfer in complex systems . By sampling rays and tracing their interaction with a multilayer wafer using thin-film electromagnetic theory, you will build a sophisticated model that accounts for spectral, directional, and polarization effects, providing a practical foundation in state-of-the-art simulation.",
            "id": "4158936",
            "problem": "You are tasked with designing and implementing a Monte Carlo ray-tracing estimator to compute the absorbed radiative power in a multilayer semiconductor wafer during thermal processing. The estimator must sample wavelength, surface position, direction, and polarization, and use thin-film electromagnetic theory to evaluate the absorptance for each sampled ray. The physical context is a lamp-heated thermal process relevant to semiconductor manufacturing.\n\nStart from a principled base that is appropriate to radiative heat transfer and thin-film optics:\n\n- Radiative power absorbed by a surface is the weighted integral of incident spectral angular irradiance times absorptance, namely\n$$\nP_{\\text{abs}} \\;=\\; \\int_{\\lambda_{\\min}}^{\\lambda_{\\max}} \\int_{A} \\int_{\\Omega^+} E(\\lambda, \\boldsymbol{x}, \\theta, \\phi)\\, A(\\lambda,\\theta, \\text{pol}) \\,\\mathrm{d}\\Omega\\, \\mathrm{d}A\\, \\mathrm{d}\\lambda,\n$$\nwhere $E$ is the incident spectral irradiance per unit area per unit solid angle per unit wavelength, $A$ is the absorptance of the multilayer stack for wavelength $\\lambda$, incidence angle $\\theta$ and polarization $\\text{pol}$, and $\\Omega^+$ denotes the upper hemisphere relative to the wafer normal.\n\n- For a lamp whose irradiance distribution factorizes as a product of a normalized spectral distribution $S(\\lambda)$, a normalized spatial distribution $I(\\boldsymbol{x})$ over the wafer surface, and a normalized directional distribution $D(\\theta,\\phi)$ over the upper hemisphere, the incident power is\n$$\nP_{\\text{inc}} \\;=\\; \\int_{\\lambda} \\int_{A} \\int_{\\Omega^+} P_{\\text{inc}}\\; S(\\lambda)\\, I(\\boldsymbol{x})\\, D(\\theta,\\phi) \\;\\mathrm{d}\\Omega\\, \\mathrm{d}A\\, \\mathrm{d}\\lambda,\n$$\nwhich equals $P_{\\text{inc}}$ because each factor is normalized. The absorbed power is then\n$$\nP_{\\text{abs}} \\;=\\; P_{\\text{inc}} \\;\\mathbb{E}[A(\\lambda,\\theta,\\text{pol})],\n$$\nwhere the expectation is taken over the joint probability distribution $p(\\lambda,\\boldsymbol{x},\\theta,\\phi,\\text{pol}) = S(\\lambda)\\, I(\\boldsymbol{x})\\, D(\\theta,\\phi)\\, p_{\\text{pol}}(\\text{pol})$.\n\n- The absorptance $A(\\lambda,\\theta,\\text{pol})$ for a multilayer stack with $N$ finite-thickness layers on a semi-infinite substrate is computed from thin-film electromagnetic theory using the characteristic matrix method. Let the ambient medium be $0$ with refractive index $n_0$, the $j$-th layer have complex refractive index $n_j$ and thickness $d_j$, and the semi-infinite substrate have complex refractive index $n_{s}$. For incidence angle $\\theta_0$ in the ambient, the transmitted angle $\\theta_j$ in layer $j$ satisfies Snell's law $n_0 \\sin\\theta_0 = n_j \\sin\\theta_j$ and likewise $n_0 \\sin\\theta_0 = n_{s} \\sin\\theta_{s}$ in the substrate. Define the polarization-dependent admittance $q_j$ by\n$$\nq_j =\n\\begin{cases}\nn_j \\cos\\theta_j & \\text{for Transverse Electric (TE) polarization},\\\\\n\\dfrac{n_j}{\\cos\\theta_j} & \\text{for Transverse Magnetic (TM) polarization},\n\\end{cases}\n$$\nwith analogous definitions for $q_0$ and $q_{s}$. For layer $j$, the phase thickness is\n$$\n\\delta_j \\;=\\; \\dfrac{2\\pi}{\\lambda}\\, n_j\\, d_j\\, \\cos\\theta_j.\n$$\nThe layer characteristic matrix is\n$$\n\\mathbf{B}_j \\;=\\;\n\\begin{pmatrix}\n\\cos\\delta_j & \\dfrac{i\\,\\sin\\delta_j}{q_j}\\\\\ni\\,q_j\\,\\sin\\delta_j & \\cos\\delta_j\n\\end{pmatrix}.\n$$\nThe total characteristic matrix is $\\mathbf{M} = \\mathbf{B}_1 \\mathbf{B}_2 \\cdots \\mathbf{B}_N$. The complex reflection and transmission coefficients are\n$$\nr \\;=\\; \\dfrac{q_0 M_{11} + q_0 q_s M_{12} - M_{21} - q_s M_{22}}{q_0 M_{11} + q_0 q_s M_{12} + M_{21} + q_s M_{22}},\\qquad\nt \\;=\\; \\dfrac{2 q_0}{q_0 M_{11} + q_0 q_s M_{12} + M_{21} + q_s M_{22}}.\n$$\nThe reflectance and transmittance are\n$$\nR \\;=\\; |r|^2,\\qquad T \\;=\\; \\dfrac{\\operatorname{Re}(q_s)}{\\operatorname{Re}(q_0)}\\, |t|^2,\n$$\nand the absorptance is $A = 1 - R - T$. For lossless ambient and lossless substrate and layers, $A=0$.\n\nMonte Carlo estimator design requirements:\n\n- Sample wavelength $\\lambda$ from the provided discrete lamp spectrum $S(\\lambda)$, treated as a normalized categorical distribution over given lines. Units are meters.\n- Sample surface position $\\boldsymbol{x} = (x,y)$ on a circular wafer of radius $R$ from a radially symmetric Gaussian spatial distribution $I(r) \\propto \\exp\\left(-(r/\\sigma)^2\\right)$ over the disk, where $r = \\sqrt{x^2+y^2}$. Units are meters.\n- Sample direction $(\\theta,\\phi)$ from a cosine-weighted directional distribution $D(\\theta,\\phi) = \\cos\\theta/\\pi$ over the upper hemisphere, modeling a Lambertian source. Angles must be in radians.\n- Sample polarization as Transverse Electric (TE) with probability $p_{\\mathrm{TE}}$ and Transverse Magnetic (TM) with probability $1 - p_{\\mathrm{TE}}$.\n- Compute $A(\\lambda,\\theta,\\text{pol})$ via the characteristic matrix method and estimate $P_{\\text{abs}} \\approx P_{\\text{inc}} \\times \\dfrac{1}{N}\\sum_{k=1}^N A(\\lambda_k,\\theta_k,\\text{pol}_k)$ using $N$ Monte Carlo samples. Clamp the absorptance to the interval $[0,1]$ to avoid numerical artifacts.\n\nPhysical units and numerical requirements:\n\n- Wavelengths $\\lambda$ must be in meters.\n- Layer thicknesses $d_j$ must be in meters.\n- Refractive indices $n_j$ may be complex (dimensionless).\n- The final absorbed power must be expressed in Watts as a float.\n- Angles must be in radians.\n\nTest suite:\n\nImplement your program to compute absorbed power for the following three cases. In all cases, set the ambient index $n_0 = 1$ and use the specified number of Monte Carlo samples $N$.\n\n1. General case (multilayer with weakly absorbing substrate, mixed polarization):\n   - Wafer radius: $R = 0.1$ m, spatial width: $\\sigma = 0.05$ m.\n   - Lamp spectrum (discrete lines): $\\lambda = [4.5\\times 10^{-7},\\, 5.5\\times 10^{-7},\\, 7.0\\times 10^{-7},\\, 1.0\\times 10^{-6}]$ m with weights $[0.2,\\, 0.5,\\, 0.2,\\, 0.1]$.\n   - Layers: $N=2$ with $(n_1 = 2.0 + 0i,\\; d_1 = 100\\times 10^{-9}\\,\\mathrm{m})$, $(n_2 = 1.46 + 0i,\\; d_2 = 100\\times 10^{-9}\\,\\mathrm{m})$.\n   - Substrate: $n_s = 3.6 + 0.02i$.\n   - Polarization probability: $p_{\\mathrm{TE}} = 0.6$.\n   - Incident power: $P_{\\text{inc}} = 1000$ W.\n   - Samples: $N = 25000$.\n\n2. Boundary case (lossless stack, zero absorption):\n   - Wafer radius: $R = 0.1$ m, spatial width: $\\sigma = 0.03$ m.\n   - Lamp spectrum (discrete lines): $\\lambda = [5.0\\times 10^{-7},\\, 8.0\\times 10^{-7}]$ m with weights $[0.5,\\, 0.5]$.\n   - Layers: $N=1$ with $(n_1 = 1.46 + 0i,\\; d_1 = 200\\times 10^{-9}\\,\\mathrm{m})$.\n   - Substrate: $n_s = 1.46 + 0i$.\n   - Polarization probability: $p_{\\mathrm{TE}} = 0.5$.\n   - Incident power: $P_{\\text{inc}} = 200$ W.\n   - Samples: $N = 20000$.\n\n3. Edge case (strongly absorbing substrate):\n   - Wafer radius: $R = 0.1$ m, spatial width: $\\sigma = 0.04$ m.\n   - Lamp spectrum (discrete lines): $\\lambda = [8.0\\times 10^{-7}]$ m with weights $[1.0]$.\n   - Layers: $N=0$ (no finite-thickness layers).\n   - Substrate: $n_s = 2.0 + 10.0i$.\n   - Polarization probability: $p_{\\mathrm{TE}} = 0.5$.\n   - Incident power: $P_{\\text{inc}} = 500$ W.\n   - Samples: $N = 20000$.\n\nFinal output format:\n\nYour program should produce a single line of output containing the absorbed powers for the three test cases, as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3]\"). Each result must be a float in Watts. Angles must be handled in radians throughout.",
            "solution": "The problem requires the design and implementation of a Monte Carlo ray-tracing estimator to calculate the total absorbed radiative power in a multilayer semiconductor wafer. The solution must be based on the provided physical and mathematical framework, which integrates radiative heat transfer principles with thin-film electromagnetic theory.\n\nThe problem is determined to be scientifically grounded, well-posed, and self-contained, and therefore is valid for solution.\n\nThe absorbed power, $P_{\\text{abs}}$, is related to the incident power, $P_{\\text{inc}}$, through the expectation of the absorptance, $A$, over the distribution of incident radiation:\n$$\nP_{\\text{abs}} = P_{\\text{inc}} \\;\\mathbb{E}[A(\\lambda,\\theta,\\text{pol})]\n$$\nThis expectation is estimated using the Monte Carlo method by averaging the absorptance over a large number of $N$ samples (rays), each drawn from the specified probability distributions for wavelength $\\lambda$, incidence direction $(\\theta, \\phi)$, and polarization $\\text{pol}$. The estimator is given by:\n$$\nP_{\\text{abs}} \\approx P_{\\text{inc}} \\times \\frac{1}{N}\\sum_{k=1}^{N} A(\\lambda_k, \\theta_k, \\text{pol}_k)\n$$\nThe absorptance $A_k$ for each ray is calculated using the characteristic matrix method for thin films.\n\nThe core of the numerical solution consists of two main parts: (1) sampling the ray parameters from their respective probability distributions, and (2) calculating the absorptance for each sampled ray.\n\n**1. Monte Carlo Sampling Procedures**\n\nFor each of the $N$ Monte Carlo trials, a unique ray is defined by a set of sampled parameters.\n\n*   **Wavelength ($\\lambda$)**: The lamp spectrum $S(\\lambda)$ is given as a discrete set of wavelengths with associated weights, which form a normalized categorical distribution. A wavelength $\\lambda_k$ is sampled from this discrete distribution according to the given probabilities. For example, using a library function for weighted random choice.\n\n*   **Direction $(\\theta, \\phi)$**: The directional distribution $D(\\theta, \\phi)$ is Lambertian, given by $D(\\theta, \\phi) = \\cos\\theta / \\pi$ for $\\theta \\in [0, \\pi/2]$ and $\\phi \\in [0, 2\\pi]$. To sample from this distribution, we employ the inverse transform sampling method. The cumulative distribution function (CDF) for the polar angle $\\theta$ is $F(\\theta) = \\sin^2\\theta$. By setting $F(\\theta) = \\xi_1$, where $\\xi_1$ is a uniform random number in $[0, 1)$, we find $\\theta = \\arcsin(\\sqrt{\\xi_1})$. The azimuthal angle $\\phi$ is uniformly distributed, so it is sampled as $\\phi = 2\\pi\\xi_2$, where $\\xi_2$ is another uniform random number in $[0, 1)$. The sampled $\\theta$ represents the angle of incidence, $\\theta_0$, in the ambient medium.\n\n*   **Polarization (pol)**: The polarization is sampled from a Bernoulli distribution. With a probability of $p_{\\text{TE}}$, the ray is assigned Transverse Electric (TE) polarization; otherwise, with probability $1-p_{\\text{TE}}$, it is assigned Transverse Magnetic (TM) polarization. This is implemented by comparing a uniform random number $\\xi_3 \\in [0,1)$ to $p_{\\text{TE}}$.\n\n*   **Surface Position ($\\boldsymbol{x}$)**: The problem specifies sampling the ray's position on the wafer from a radially symmetric, truncated Gaussian distribution $I(r) \\propto \\exp(-(r/\\sigma)^2)$. However, the absorptance function $A(\\lambda, \\theta, \\text{pol})$ as defined by the provided thin-film optics model is uniform across the wafer surface; it does not depend on the position $\\boldsymbol{x}$. Consequently, the expectation $\\mathbb{E}[A(\\lambda,\\theta,\\text{pol})]$ is independent of the spatial distribution $I(\\boldsymbol{x})$. While one could implement the sampling for $\\boldsymbol{x}$ as specified, the sampled value would not be used in the subsequent absorptance calculation. This step is mathematically redundant for this particular problem formulation. Therefore, to maintain computational efficiency while respecting the physical model, the explicit sampling of surface position is omitted from the calculation of the average absorptance.\n\n**2. Absorptance Calculation via Characteristic Matrix Method**\n\nFor each sampled ray $(\\lambda_k, \\theta_k, \\text{pol}_k)$, the absorptance $A_k$ of the multilayer stack is calculated as follows. Let the incident ray parameters be $\\lambda$, $\\theta_0=\\theta_k$, and pol. The ambient medium has refractive index $n_0=1$. The structure consists of $N$ layers with complex refractive indices $n_j$ and thicknesses $d_j$, on a semi-infinite substrate with complex index $n_s$.\n\n*   **Angle in Layers**: The angle of propagation $\\theta_j$ inside each layer $j$ and the substrate $s$ is determined by Snell's Law: $n_j \\sin\\theta_j = n_0 \\sin\\theta_0$. This gives $\\sin\\theta_j = (n_0/n_j)\\sin\\theta_0$. The cosine of the angle is then $\\cos\\theta_j = \\sqrt{1 - \\sin^2\\theta_j}$. Since $n_j$ can be complex, all calculations involving these angles must use complex arithmetic.\n\n*   **Admittances**: The optical admittance $q_j$ is defined for each medium (ambient, layers, substrate) based on the polarization:\n    $$\n    q_j = \\begin{cases} n_j \\cos\\theta_j & \\text{for TE polarization} \\\\ n_j / \\cos\\theta_j & \\text{for TM polarization} \\end{cases}\n    $$\n\n*   **Characteristic Matrix**: For each layer $j$ from $1$ to $N$, a $2 \\times 2$ characteristic matrix $\\mathbf{B}_j$ is constructed. First, the phase thickness is calculated:\n    $$\n    \\delta_j = \\frac{2\\pi}{\\lambda} n_j d_j \\cos\\theta_j\n    $$\n    The matrix for layer $j$ is then:\n    $$\n    \\mathbf{B}_j = \\begin{pmatrix} \\cos\\delta_j & \\frac{i\\sin\\delta_j}{q_j} \\\\ i\\,q_j\\,\\sin\\delta_j & \\cos\\delta_j \\end{pmatrix}\n    $$\n    The total characteristic matrix for the stack, $\\mathbf{M}$, is the product of the individual layer matrices in order:\n    $$\n    \\mathbf{M} = \\mathbf{B}_1 \\mathbf{B}_2 \\cdots \\mathbf{B}_N\n    $$\n    In the special case of no layers ($N=0$), $\\mathbf{M}$ is the $2 \\times 2$ identity matrix.\n\n*   **Reflectance and Transmittance**: From the elements of the total matrix $\\mathbf{M} = \\begin{pmatrix} M_{11} & M_{12} \\\\ M_{21} & M_{22} \\end{pmatrix}$ and the admittances of the ambient ($q_0$) and substrate ($q_s$), the complex reflection and transmission coefficients ($r$ and $t$) are calculated:\n    $$\n    r = \\frac{q_0 M_{11} + q_0 q_s M_{12} - M_{21} - q_s M_{22}}{q_0 M_{11} + q_0 q_s M_{12} + M_{21} + q_s M_{22}}\n    $$\n    $$\n    t = \\frac{2 q_0}{q_0 M_{11} + q_0 q_s M_{12} + M_{21} + q_s M_{22}}\n    $$\n    The power reflectance $R$ and transmittance $T$ are then:\n    $$\n    R = |r|^2 \\quad \\text{and} \\quad T = \\frac{\\operatorname{Re}(q_s)}{\\operatorname{Re}(q_0)} |t|^2\n    $$\n\n*   **Absorptance**: Finally, the absorptance $A$ is found by applying conservation of energy:\n    $$\n    A = 1 - R - T\n    $$\n    Due to potential floating-point inaccuracies, the computed value of $A$ is clamped to the physically meaningful interval $[0, 1]$.\n\n**Algorithm Implementation**\nThe overall algorithm for each test case is as follows:\n1.  Set up the parameters for the specific case: incident power $P_{\\text{inc}}$, number of samples $N$, lamp spectrum, layer stack properties, etc.\n2.  Initialize an empty list to store the absorptance values for each ray.\n3.  Begin a loop that iterates $N$ times. In each iteration:\n    a. Sample a wavelength $\\lambda$ and polarization $\\text{pol}$.\n    b. Sample an incidence angle $\\theta_0$.\n    c. Call a function that implements the characteristic matrix method described above with the sampled ray parameters and the fixed stack properties, returning the absorptance $A$.\n    d. Clamp the computed $A$ to the range $[0, 1]$.\n    e. Append the clamped $A$ to the list.\n4.  After the loop completes, calculate the mean of all stored absorptance values, $\\bar{A}$.\n5.  Compute the final absorbed power as $P_{\\text{abs}} = P_{\\text{inc}} \\times \\bar{A}$.\n6.  This process is repeated for each of the three test cases, and the results are collected.\n\nThis principled approach ensures that the implemented simulation correctly models the specified physical phenomena and provides a robust estimate for the absorbed power. The provided test cases are designed to verify the implementation across different physical regimes, including a general case with absorption, a lossless boundary case where absorption should be zero, and an edge case with strong absorption at a single interface.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_absorptance(lambda_val, theta0, pol, layers, n_s, n0):\n    \"\"\"\n    Calculates the absorptance of a multilayer stack for a given ray.\n\n    Args:\n        lambda_val (float): Wavelength of the incident ray in meters.\n        theta0 (float): Angle of incidence in the ambient medium in radians.\n        pol (str): Polarization, 'TE' or 'TM'.\n        layers (list): List of tuples, where each tuple is (n_j, d_j)\n                       representing the complex refractive index and thickness\n                       of layer j.\n        n_s (complex): Complex refractive index of the substrate.\n        n0 (complex): Refractive index of the ambient medium.\n\n    Returns:\n        float: The absorptance A of the stack.\n    \"\"\"\n    k0 = 2 * np.pi / lambda_val\n    \n    # Store indices and thicknesses for easier access.\n    # Full stack: ambient(0), layer(1..N), substrate(N+1)\n    # The 'layers' list contains N elements for the thin films.\n    # Total number of media is N+2.\n    n_stack = [n0] + [layer[0] for layer in layers] + [n_s]\n    d_stack = [layer[1] for layer in layers]\n\n    num_layers = len(layers)\n    num_media = num_layers + 2\n\n    # Calculate angles in all media using Snell's Law\n    # n_j * sin(theta_j) = n0 * sin(theta0)\n    sin_thetas = (n0 / np.array(n_stack)) * np.sin(theta0)\n    cos_thetas = np.sqrt(1 - sin_thetas**2)\n    # Physical branch of sqrt for complex numbers ensures Re(cos) >= 0\n\n    # Calculate polarization-dependent admittances\n    if pol == 'TE':\n        q_stack = n_stack * cos_thetas\n    elif pol == 'TM':\n        q_stack = n_stack / cos_thetas\n    else:\n        raise ValueError(\"Polarization must be 'TE' or 'TM'\")\n\n    q0 = q_stack[0]\n    q_s = q_stack[-1]\n\n    # Calculate total characteristic matrix M = B1 * B2 * ... * BN\n    M = np.identity(2, dtype=np.complex128)\n\n    if num_layers > 0:\n        for j in range(num_layers):\n            # Layer j corresponds to index j+1 in the stack arrays\n            q_j = q_stack[j + 1]\n            n_j = n_stack[j + 1]\n            d_j = d_stack[j]\n            cos_theta_j = cos_thetas[j + 1]\n            \n            delta_j = k0 * n_j * d_j * cos_theta_j\n            \n            cos_delta = np.cos(delta_j)\n            sin_delta = np.sin(delta_j)\n            \n            B_j = np.array([\n                [cos_delta, (1j * sin_delta) / q_j],\n                [1j * q_j * sin_delta, cos_delta]\n            ], dtype=np.complex128)\n            \n            M = M @ B_j\n\n    M11, M12, M21, M22 = M[0, 0], M[0, 1], M[1, 0], M[1, 1]\n\n    # Calculate reflection and transmission coefficients\n    # Denominator\n    den = q0 * M11 + q0 * q_s * M12 + M21 + q_s * M22\n    # Numerator for r\n    num_r = q0 * M11 + q0 * q_s * M12 - M21 - q_s * M22\n    \n    r = num_r / den\n    t = (2 * q0) / den\n\n    # Calculate Reflectance, Transmittance, and Absorptance\n    R = np.abs(r)**2\n    # Ensure Re(q0) is not zero to avoid division errors, though n0=1 makes it safe\n    T = (np.real(q_s) / np.real(q0)) * np.abs(t)**2 if np.real(q0) != 0 else 0\n\n    A = 1 - R - T\n    \n    # Clamp absorptance to handle numerical artifacts\n    return np.clip(A, 0, 1)\n\n\ndef solve():\n    \"\"\"\n    Main function to run the Monte Carlo simulation for the given test cases.\n    \"\"\"\n    # Set a seed for reproducibility\n    np.random.seed(42)\n\n    test_cases = [\n        {\n            \"name\": \"General case (multilayer with weakly absorbing substrate, mixed polarization)\",\n            \"R_wafer\": 0.1, \"sigma_spatial\": 0.05,\n            \"lamp_spectrum\": {\n                \"lambdas\": np.array([4.5e-7, 5.5e-7, 7.0e-7, 1.0e-6]),\n                \"weights\": np.array([0.2, 0.5, 0.2, 0.1])\n            },\n            \"layers\": [(2.0 + 0j, 100e-9), (1.46 + 0j, 100e-9)],\n            \"n_s\": 3.6 + 0.02j,\n            \"p_TE\": 0.6,\n            \"P_inc\": 1000.0,\n            \"N_samples\": 25000,\n            \"n0\": 1.0 + 0j\n        },\n        {\n            \"name\": \"Boundary case (lossless stack, zero absorption)\",\n            \"R_wafer\": 0.1, \"sigma_spatial\": 0.03,\n            \"lamp_spectrum\": {\n                \"lambdas\": np.array([5.0e-7, 8.0e-7]),\n                \"weights\": np.array([0.5, 0.5])\n            },\n            \"layers\": [(1.46 + 0j, 200e-9)],\n            \"n_s\": 1.46 + 0j,\n            \"p_TE\": 0.5,\n            \"P_inc\": 200.0,\n            \"N_samples\": 20000,\n            \"n0\": 1.0 + 0j\n        },\n        {\n            \"name\": \"Edge case (strongly absorbing substrate)\",\n            \"R_wafer\": 0.1, \"sigma_spatial\": 0.04,\n            \"lamp_spectrum\": {\n                \"lambdas\": np.array([8.0e-7]),\n                \"weights\": np.array([1.0])\n            },\n            \"layers\": [],  # N=0 layers\n            \"n_s\": 2.0 + 10.0j,\n            \"p_TE\": 0.5,\n            \"P_inc\": 500.0,\n            \"N_samples\": 20000,\n            \"n0\": 1.0 + 0j\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        N = case[\"N_samples\"]\n        \n        # Sample all random variables in a vectorized way\n        # 1. Sample wavelength\n        lambdas_sampled = np.random.choice(\n            case[\"lamp_spectrum\"][\"lambdas\"],\n            size=N,\n            p=case[\"lamp_spectrum\"][\"weights\"]\n        )\n\n        # 2. Sample polarization\n        pols_sampled = np.random.choice(\n            ['TE', 'TM'],\n            size=N,\n            p=[case[\"p_TE\"], 1 - case[\"p_TE\"]]\n        )\n\n        # 3. Sample direction (theta from Lambertian distribution)\n        xi1 = np.random.rand(N)\n        thetas_sampled = np.arcsin(np.sqrt(xi1))\n        \n        # NOTE: As explained in the solution text, sampling position is redundant\n        # as absorptance is position-independent. The sampling is omitted.\n\n        absorptances = np.zeros(N)\n        for i in range(N):\n            absorptances[i] = calculate_absorptance(\n                lambdas_sampled[i],\n                thetas_sampled[i],\n                pols_sampled[i],\n                case[\"layers\"],\n                case[\"n_s\"],\n                case[\"n0\"]\n            )\n            \n        mean_absorptance = np.mean(absorptances)\n        P_abs = case[\"P_inc\"] * mean_absorptance\n        results.append(P_abs)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}