{
    "hands_on_practices": [
        {
            "introduction": "This exercise introduces the powerful method of images to solve diffusion problems in semi-infinite domains. By cleverly placing a fictitious \"image\" source, we can satisfy the boundary condition at the surface, providing an elegant analytical solution for a physically important scenario like post-implantation annealing with a capped surface . This practice reinforces the connection between the physics of a boundary (in this case, zero flux) and the mathematical form of the solution.",
            "id": "4176713",
            "problem": "A one-dimensional model of dopant redistribution during isothermal annealing is used for a semi-infinite silicon substrate occupying the half-line $x \\geq 0$. The dopant concentration $C(x,t)$ evolves according to Fick's second law with constant diffusivity $D$ at the anneal temperature, and the surface at $x=0$ is capped to prevent out-diffusion, imposing a zero-flux boundary. At time $t=0$, an ion implantation produces a narrow sheet of dopant localized at depth $x_{s}  0$ with total areal dose $Q$ (atoms per unit area), which is modeled as a Dirac delta distribution in the normal direction. Assume $D$ is constant and uniform, and neglect any clustering, segregation, or electric field effects.\n\nStarting from Fick's second law and the definition of flux, and using only fundamental principles together with the method of images, derive the explicit closed-form expression for the concentration $C(x,t)$ for $x \\geq 0$ and $t  0$ that satisfies:\n- the diffusion equation $\\partial C/\\partial t = D\\,\\partial^{2} C/\\partial x^{2}$,\n- the zero-flux boundary condition $\\left.\\partial C/\\partial x\\right|_{x=0} = 0$,\n- the initial condition $C(x,0) = Q\\,\\delta(x - x_{s})$,\n- and the far-field condition $C(x,t) \\to 0$ as $x \\to \\infty$ at any fixed $t0$.\n\nExpress your final answer as a single closed-form analytic expression in terms of $Q$, $D$, $x_{s}$, $x$, and $t$. No numerical rounding is required. All symbols must be clearly defined and consistent with the above description.",
            "solution": "The problem requires the derivation of the dopant concentration profile $C(x,t)$ in a semi-infinite silicon substrate ($x \\geq 0$) undergoing transient diffusion. The process is governed by a set of well-defined physical and mathematical conditions.\n\nFirst, we formalize the problem statement. The dopant concentration $C(x,t)$ must satisfy the one-dimensional diffusion equation, also known as Fick's second law:\n$$\n\\frac{\\partial C}{\\partial t} = D \\frac{\\partial^2 C}{\\partial x^2} \\quad \\text{for } x  0, t  0\n$$\nwhere $D$ is the constant dopant diffusivity.\n\nThe boundary and initial conditions are:\n1.  A zero-flux boundary condition at the surface $x=0$. The dopant flux $J$ is given by Fick's first law, $J = -D \\frac{\\partial C}{\\partial x}$. A zero-flux condition thus implies a zero concentration gradient normal to the boundary:\n    $$\n    \\left. J \\right|_{x=0} = -D \\left. \\frac{\\partial C}{\\partial x} \\right|_{x=0} = 0 \\implies \\left. \\frac{\\partial C}{\\partial x} \\right|_{x=0} = 0 \\quad \\text{for } t  0\n    $$\n    This is a Neumann boundary condition.\n\n2.  An initial condition at time $t=0$ representing a narrow sheet of dopant of total areal dose $Q$ implanted at a depth $x_s  0$. This is mathematically modeled as a Dirac delta function:\n    $$\n    C(x,0) = Q \\, \\delta(x - x_s) \\quad \\text{for } x \\geq 0\n    $$\n\n3.  A far-field condition stating that the concentration vanishes far from the source:\n    $$\n    \\lim_{x \\to \\infty} C(x,t) = 0 \\quad \\text{for } t  0\n    $$\n\nThe specified method to solve this initial-boundary value problem is the method of images. This method involves extending the problem from the semi-infinite domain ($x \\geq 0$) to an infinite domain ($-\\infty  x  \\infty$) by adding a fictitious \"image\" source in the non-physical region ($x  0$). The properties (location and strength) of this image source are chosen such that the solution in the full infinite domain automatically satisfies the boundary condition at $x=0$.\n\nThe fundamental solution to the diffusion equation in an infinite one-dimensional domain for an initial condition of a point source of strength $Q$ at $x=x_s$, i.e., $C(x,0) = Q\\,\\delta(x - x_s)$, is a Gaussian function:\n$$\nC_{\\text{source}}(x,t) = \\frac{Q}{\\sqrt{4\\pi Dt}} \\exp\\left(-\\frac{(x - x_s)^2}{4Dt}\\right)\n$$\nThis function represents the spreading of the initial dopant sheet over time.\n\nTo satisfy the zero-flux (Neumann) boundary condition at $x=0$, we must place an image source that creates a concentration profile whose gradient, when added to the gradient of the real source, sums to zero at $x=0$. The appropriate image source for a Neumann condition at $x=0$ is an image of the same sign and magnitude located at the mirror position, $x = -x_s$. Therefore, we place an image source with initial profile $Q\\,\\delta(x + x_s)$.\n\nThe solution for this image source in an infinite domain is:\n$$\nC_{\\text{image}}(x,t) = \\frac{Q}{\\sqrt{4\\pi Dt}} \\exp\\left(-\\frac{(x - (-x_s))^2}{4Dt}\\right) = \\frac{Q}{\\sqrt{4\\pi Dt}} \\exp\\left(-\\frac{(x + x_s)^2}{4Dt}\\right)\n$$\nBy the principle of superposition, the total solution $C_{\\text{full}}(x,t)$ in the infinite domain is the sum of the solutions for the real and image sources:\n$$\nC_{\\text{full}}(x,t) = C_{\\text{source}}(x,t) + C_{\\text{image}}(x,t) = \\frac{Q}{\\sqrt{4\\pi Dt}} \\left[ \\exp\\left(-\\frac{(x - x_s)^2}{4Dt}\\right) + \\exp\\left(-\\frac{(x + x_s)^2}{4Dt}\\right) \\right]\n$$\nWe must now verify that this constructed solution satisfies the zero-flux boundary condition at $x=0$. We compute the partial derivative of $C_{\\text{full}}$ with respect to $x$:\n$$\n\\frac{\\partial C_{\\text{full}}}{\\partial x} = \\frac{Q}{\\sqrt{4\\pi Dt}} \\left[ \\frac{-2(x - x_s)}{4Dt} \\exp\\left(-\\frac{(x - x_s)^2}{4Dt}\\right) + \\frac{-2(x + x_s)}{4Dt} \\exp\\left(-\\frac{(x + x_s)^2}{4Dt}\\right) \\right]\n$$\n$$\n\\frac{\\partial C_{\\text{full}}}{\\partial x} = -\\frac{Q}{2Dt\\sqrt{4\\pi Dt}} \\left[ (x - x_s) \\exp\\left(-\\frac{(x - x_s)^2}{4Dt}\\right) + (x + x_s) \\exp\\left(-\\frac{(x + x_s)^2}{4Dt}\\right) \\right]\n$$\nEvaluating this derivative at $x=0$:\n$$\n\\left. \\frac{\\partial C_{\\text{full}}}{\\partial x} \\right|_{x=0} = -\\frac{Q}{2Dt\\sqrt{4\\pi Dt}} \\left[ (0 - x_s) \\exp\\left(-\\frac{(-x_s)^2}{4Dt}\\right) + (0 + x_s) \\exp\\left(-\\frac{(x_s)^2}{4Dt}\\right) \\right]\n$$\n$$\n\\left. \\frac{\\partial C_{\\text{full}}}{\\partial x} \\right|_{x=0} = -\\frac{Q}{2Dt\\sqrt{4\\pi Dt}} \\left[ -x_s \\exp\\left(-\\frac{x_s^2}{4Dt}\\right) + x_s \\exp\\left(-\\frac{x_s^2}{4Dt}\\right) \\right] = 0\n$$\nThe boundary condition is satisfied. The solution $C(x,t)$ for the physical domain $x \\geq 0$ is the restriction of $C_{\\text{full}}(x,t)$ to this domain. The far-field and initial conditions are also satisfied by this construction. The total amount of dopant in the physical domain $\\int_0^\\infty C(x,t) dx$ is conserved and remains equal to $Q$ for all $t  0$, consistent with a no-flux boundary.\n\nThus, the final expression for the concentration profile is:\n$$\nC(x,t) = \\frac{Q}{\\sqrt{4\\pi Dt}} \\left[ \\exp\\left(-\\frac{(x-x_s)^2}{4Dt}\\right) + \\exp\\left(-\\frac{(x+x_s)^2}{4Dt}\\right) \\right]\n$$\nfor $x \\geq 0$ and $t  0$.",
            "answer": "$$\n\\boxed{\\frac{Q}{\\sqrt{4\\pi Dt}} \\left[ \\exp\\left(-\\frac{(x-x_s)^2}{4Dt}\\right) + \\exp\\left(-\\frac{(x+x_s)^2}{4Dt}\\right) \\right]}\n$$"
        },
        {
            "introduction": "Real-world diffusion processes are often more complex than the linear diffusion equation suggests, with diffusivity frequently depending on the local dopant concentration. This practice explores how to handle such nonlinearity by using perturbation analysis, a key technique in physics and engineering. You will linearize a nonlinear diffusion model to derive an effective, constant diffusion coefficient, providing insight into how the process behaves for small variations around a high background concentration .",
            "id": "4176728",
            "problem": "In high-dose boron drive-in diffusion in crystalline silicon, the dominant mechanism at elevated temperatures involves boron–self-interstitial pairs. Let the silicon contain a boron concentration field $C(x,t)$ and assume the boron–interstitial pair concentration $C_{p}(x,t)$ is proportional to the product of the boron concentration and a normalized, boron-dependent point-defect factor $H(C)$ that captures local charge-state and defect equilibria. The pair diffusivity $D_{p}$ is taken to be independent of $C$ under isothermal conditions. The boron flux is given by the pair flux, which follows Fick’s first law applied to the pair concentration, so that the conservation of boron reads\n$$\n\\frac{\\partial C}{\\partial t} \\;=\\; \\frac{\\partial}{\\partial x}\\!\\left[D_{p}\\,\\frac{\\partial}{\\partial x}\\!\\big(H(C)\\,C\\big)\\right].\n$$\nDefine the composite diffusivity $D(C)\\equiv D_{p}\\,H(C)$ so that the exact nonlinear diffusion equation takes the conservative form\n$$\n\\frac{\\partial C}{\\partial t} \\;=\\; \\frac{\\partial^{2}}{\\partial x^{2}}\\!\\big(D(C)\\,C\\big).\n$$\nConsider a spatially uniform background concentration $C_{0}0$ and a small perturbation $\\tilde{C}(x,t)$ such that $C(x,t)=C_{0}+\\tilde{C}(x,t)$ with $|\\tilde{C}|\\ll C_{0}$ for all $x$ and $t$. Work to first order in $\\tilde{C}$ and its spatial derivatives about the uniform state, starting only from the statement of mass conservation and the above constitutive relation.\n\nDerive the linearized evolution equation for $\\tilde{C}(x,t)$, show that it has the form of a linear diffusion equation with an effective constant diffusion coefficient, and determine the analytical expression for this effective linear diffusion coefficient in terms of $D(C_{0})$, $D'(C_{0})$, and $C_{0}$, where $D'(C)$ denotes the derivative of $D$ with respect to its argument $C$.\n\nYour final answer must be the single closed-form analytical expression for the effective diffusion coefficient. Do not provide intermediate steps in the final answer. No numerical evaluation is required, and no units should be reported in the final answer box.",
            "solution": "The problem requires the derivation of a linearized diffusion equation for a small perturbation $\\tilde{C}(x,t)$ about a uniform background concentration $C_0$, starting from the given nonlinear diffusion equation in conservative form. The goal is to identify the effective diffusion coefficient in this linearized equation.\n\nThe governing equation for the total boron concentration $C(x,t)$ is provided as:\n$$\n\\frac{\\partial C}{\\partial t} = \\frac{\\partial^{2}}{\\partial x^{2}}\\!\\big(D(C)\\,C\\big)\n$$\nwhere $D(C)$ is a concentration-dependent composite diffusivity.\n\nWe consider a small perturbation $\\tilde{C}(x,t)$ around a constant, uniform background concentration $C_0  0$. The total concentration is thus written as:\n$$\nC(x,t) = C_{0} + \\tilde{C}(x,t)\n$$\nwhere it is assumed that $|\\tilde{C}(x,t)| \\ll C_{0}$ for all positions $x$ and times $t$. We substitute this expression for $C(x,t)$ into the governing partial differential equation.\n\nLet us analyze the left-hand side (LHS) of the equation first:\n$$\n\\text{LHS} = \\frac{\\partial C}{\\partial t} = \\frac{\\partial}{\\partial t}\\left(C_{0} + \\tilde{C}(x,t)\\right)\n$$\nSince $C_0$ is a constant, its time derivative is zero. Therefore, the LHS simplifies to:\n$$\n\\text{LHS} = \\frac{\\partial \\tilde{C}}{\\partial t}\n$$\n\nNext, we analyze the right-hand side (RHS) of the equation:\n$$\n\\text{RHS} = \\frac{\\partial^{2}}{\\partial x^{2}}\\!\\big(D(C)\\,C\\big)\n$$\nSubstitute $C = C_0 + \\tilde{C}$:\n$$\n\\text{RHS} = \\frac{\\partial^{2}}{\\partial x^{2}}\\!\\left(D(C_{0} + \\tilde{C})\\,(C_{0} + \\tilde{C})\\right)\n$$\nThe argument of the second spatial derivative, the term $D(C)C$, is a nonlinear function of $C$. To linearize the equation, we perform a Taylor series expansion of this term around $C = C_0$ and keep only terms up to the first order in the small perturbation $\\tilde{C}$. Let us define the function $F(C) = D(C)C$. The expansion is:\n$$\nF(C) = F(C_{0} + \\tilde{C}) \\approx F(C_0) + F'(C_0)\\tilde{C}\n$$\nwhere $F'(C_0)$ is the derivative of $F(C)$ with respect to $C$, evaluated at $C = C_0$.\n\nWe compute the derivative $F'(C)$ using the product rule:\n$$\nF'(C) = \\frac{d}{dC}\\big(D(C)C\\big) = \\frac{dD}{dC} \\cdot C + D(C) \\cdot 1 = D'(C)C + D(C)\n$$\nEvaluating this derivative at $C = C_0$ gives:\n$$\nF'(C_0) = D'(C_0)C_0 + D(C_0)\n$$\nSubstituting this back into the Taylor expansion for $F(C)$, we get:\n$$\nD(C)C \\approx D(C_0)C_0 + \\left[ D(C_0) + C_0D'(C_0) \\right]\\tilde{C}\n$$\n\nNow, we substitute this linearized expression back into the RHS of the governing equation:\n$$\n\\text{RHS} \\approx \\frac{\\partial^{2}}{\\partial x^{2}}\\!\\left( D(C_0)C_0 + \\left[ D(C_0) + C_0D'(C_0) \\right]\\tilde{C} \\right)\n$$\nThe term $D(C_0)C_0$ is a constant with respect to both space $x$ and time $t$. Therefore, its second spatial derivative is zero:\n$$\n\\frac{\\partial^{2}}{\\partial x^{2}}\\!\\left( D(C_0)C_0 \\right) = 0\n$$\nThe RHS thus simplifies to:\n$$\n\\text{RHS} \\approx \\frac{\\partial^{2}}{\\partial x^{2}}\\!\\left( \\left[ D(C_0) + C_0D'(C_0) \\right]\\tilde{C} \\right)\n$$\nThe coefficient $\\left[ D(C_0) + C_0D'(C_0) \\right]$ is a constant because $C_0$ is constant and $D$ and $D'$ are evaluated at $C_0$. As a constant coefficient, it can be factored out of the spatial derivative:\n$$\n\\text{RHS} \\approx \\left[ D(C_0) + C_0D'(C_0) \\right] \\frac{\\partial^{2}\\tilde{C}}{\\partial x^{2}}\n$$\n\nFinally, we equate the linearized LHS and RHS to obtain the evolution equation for the perturbation $\\tilde{C}(x,t)$:\n$$\n\\frac{\\partial \\tilde{C}}{\\partial t} = \\left[ D(C_0) + C_0D'(C_0) \\right] \\frac{\\partial^{2}\\tilde{C}}{\\partial x^{2}}\n$$\nThis equation is a linear partial differential equation for $\\tilde{C}(x,t)$. It has the standard form of a linear diffusion equation:\n$$\n\\frac{\\partial u}{\\partial t} = D_{\\text{eff}} \\frac{\\partial^{2}u}{\\partial x^{2}}\n$$\nBy comparing our derived equation for $\\tilde{C}$ with this standard form, we can identify the effective diffusion coefficient, $D_{\\text{eff}}$.\n\nThe effective linear diffusion coefficient is the constant term multiplying the second spatial derivative of the perturbation. Therefore, we have:\n$$\nD_{\\text{eff}} = D(C_0) + C_0D'(C_0)\n$$\nThis expression depends only on the background concentration $C_0$ and the properties of the diffusivity function $D(C)$ and its derivative, evaluated at $C_0$, as required.",
            "answer": "$$\n\\boxed{D(C_{0}) + C_{0}D'(C_{0})}\n$$"
        },
        {
            "introduction": "While analytical solutions provide deep insight, most practical engineering problems with complex material properties and geometries require numerical methods. This hands-on practice guides you through the development of a finite volume method (FVM), a cornerstone of modern simulation, to solve the diffusion equation with spatially varying diffusivity. You will implement a scheme that rigorously conserves the total amount of dopant, a critical property for physically accurate simulations, and validate its correctness through a series of test cases .",
            "id": "4176749",
            "problem": "Consider one-dimensional dopant diffusion in a semiconductor wafer during thermal processing, modeled on a finite interval with zero-flux boundaries. The governing physical base is Fick's second law, which in one spatial dimension and for spatially varying diffusivity is the partial differential equation\n$$\n\\frac{\\partial C(x,t)}{\\partial t} = \\frac{\\partial}{\\partial x}\\left(D(x)\\,\\frac{\\partial C(x,t)}{\\partial x}\\right),\n$$\nwhere $C(x,t)$ is the dopant concentration measured in $\\mathrm{m}^{-3}$, $x$ is position in $\\mathrm{m}$, $t$ is time in $\\mathrm{s}$, and $D(x)$ is the diffusivity measured in $\\mathrm{m}^2/\\mathrm{s}$. The zero-flux boundary condition requires that the flux $J(x,t) = -D(x)\\,\\partial C/\\partial x$ satisfies $J(0,t) = 0$ and $J(L,t) = 0$ for all $t$, where $L$ is the wafer thickness in $\\mathrm{m}$.\n\nYour task is to implement a conservative finite volume method (FVM) discretization of the spatial operator $\\nabla\\cdot(D\\nabla C)$ in one dimension using interface conductances, and advance the solution in time using a fully implicit backward Euler scheme. You must derive the appropriate interface conductances from first principles, starting from the divergence theorem and Fick's law, and ensure that the resulting scheme is conservative in the sense of dose (total dopant per unit cross-sectional area) under zero-flux boundary conditions. You must also mathematically explain and demonstrate, by computation, discrete dose conservation for all test cases.\n\nDefinitions and requirements:\n- Let the domain be $[0,L]$ with $L$ in $\\mathrm{m}$, partitioned into $N$ control volumes (cells) with centers $x_i$ and widths $\\Delta x_i$, for $i=1,\\dots,N$. Let the cross-sectional area be unity so that the cell volume is $V_i = \\Delta x_i$.\n- The semi-discrete conservation law per control volume must be of the form\n$$\nV_i\\,\\frac{d C_i(t)}{dt} = F_{i+\\frac{1}{2}}(t) - F_{i-\\frac{1}{2}}(t),\n$$\nwhere $F_{i+\\frac{1}{2}}$ denotes the diffusive flux across the right face of cell $i$, defined consistently with Fick's law. You must derive a consistent expression for $F_{i+\\frac{1}{2}}$ in terms of an interface conductance and neighboring cell concentrations.\n- Time discretization must use backward Euler:\n$$\nV_i\\left(C_i^{n+1} - C_i^n\\right) = \\Delta t \\left(F_{i+\\frac{1}{2}}^{n+1} - F_{i-\\frac{1}{2}}^{n+1}\\right),\n$$\nwith time step $\\Delta t$ in $\\mathrm{s}$.\n\nProof requirement:\n- Prove, starting from the semi-discrete conservation law, that under zero-flux boundary conditions, the backward Euler update conserves the discrete dose\n$$\nQ^n = \\sum_{i=1}^N V_i\\,C_i^n,\n$$\ni.e., show that $Q^{n+1} = Q^n$ for all time steps, assuming exact arithmetic.\n\nImplementation requirements:\n- Implement the one-dimensional discretization using interface conductances computed from cell-centered diffusivities $D_i = D(x_i)$. The method must be conservative and consistent for spatially varying $D(x)$ and nonuniform meshes.\n- Assemble the matrix form of the implicit update\n$$\n\\left(\\mathbf{M} - \\Delta t\\,\\mathbf{A}\\right)\\,\\mathbf{C}^{n+1} = \\mathbf{M}\\,\\mathbf{C}^n,\n$$\nwhere $\\mathbf{M}$ is diagonal with entries $V_i$, and $\\mathbf{A}\\,\\mathbf{C}$ represents the net flux differences per control volume. You must ensure that $\\mathbf{A}$ satisfies the property $\\mathbf{A}\\,\\mathbf{1} = \\mathbf{0}$, where $\\mathbf{1}$ is the vector of ones, consistent with zero flux for uniform concentration.\n- Use units consistent with the physical definitions: $L$ in $\\mathrm{m}$, $D$ in $\\mathrm{m}^2/\\mathrm{s}$, $t$ in $\\mathrm{s}$, $C$ in $\\mathrm{m}^{-3}$. Outputs will be dimensionless booleans.\n\nTest suite:\nImplement and run the following four test cases. For each test case, run the implicit scheme for a specified number of steps and report two booleans: whether the discrete dose is conserved within a relative tolerance of $10^{-12}$, and whether all row sums of $\\mathbf{A}$ equal zero within an absolute tolerance of $10^{-12}$. The final output must aggregate the eight booleans in order as a single list.\n\n- Test case $1$ (uniform grid, uniform diffusivity, Gaussian initial condition):\n  - $L = 10^{-6}\\ \\mathrm{m}$, $N = 64$, $\\Delta t = 10\\ \\mathrm{s}$, number of steps $= 10$.\n  - $D(x) = 10^{-14}\\ \\mathrm{m}^2/\\mathrm{s}$ for all $x$.\n  - Initial condition $C(x,0) = C_0 \\exp\\left(-\\frac{(x - L/2)^2}{2\\sigma^2}\\right)$ with $C_0 = 10^{23}\\ \\mathrm{m}^{-3}$ and $\\sigma = L/10$.\n\n- Test case $2$ (uniform grid, piecewise diffusivity step, top-hat initial condition):\n  - $L = 10^{-6}\\ \\mathrm{m}$, $N = 100$, $\\Delta t = 20\\ \\mathrm{s}$, number of steps $= 10$.\n  - $D(x) = 10^{-14}\\ \\mathrm{m}^2/\\mathrm{s}$ for $x \\le L/2$ and $D(x) = 10^{-16}\\ \\mathrm{m}^2/\\mathrm{s}$ for $x gt; L/2$.\n  - Initial condition $C(x,0) = C_0$ for $x \\in [0, L/3]$ and $C(x,0) = 0$ otherwise, with $C_0 = 10^{22}\\ \\mathrm{m}^{-3}$.\n\n- Test case $3$ (nonuniform grid, smoothly varying diffusivity, piecewise linear initial condition):\n  - $L = 10^{-6}\\ \\mathrm{m}$, $N = 53$, $\\Delta t = 5\\ \\mathrm{s}$, number of steps $= 20$.\n  - Nonuniform mesh defined by mapping $s_j = j/N$ for $j=0,\\dots,N$ and faces at $x_{j+\\frac{1}{2}} = L\\,s_j^{2}$; cell widths are $\\Delta x_i = x_{i+\\frac{1}{2}} - x_{i-\\frac{1}{2}}$ and centers $x_i = (x_{i-\\frac{1}{2}} + x_{i+\\frac{1}{2}})/2$.\n  - $D(x) = D_0\\left(1 + \\alpha \\sin\\left(2\\pi x/L\\right)\\right)$ with $D_0 = 10^{-14}\\ \\mathrm{m}^2/\\mathrm{s}$ and $\\alpha = 0.8$.\n  - Initial condition $C(x,0)$ is piecewise linear: $C(x,0) = C_0 \\cdot (x/L)$ for $x \\in [0, L/2]$ and $C(x,0) = C_0 \\cdot (1 - x/L)$ for $x \\in (L/2, L]$, with $C_0 = 10^{21}\\ \\mathrm{m}^{-3}$.\n\n- Test case $4$ (single cell edge case):\n  - $L = 10^{-6}\\ \\mathrm{m}$, $N = 1$, $\\Delta t = 100\\ \\mathrm{s}$, number of steps $= 5$.\n  - $D(x) = 10^{-15}\\ \\mathrm{m}^2/\\mathrm{s}$ for all $x$.\n  - Initial condition $C(x,0) = C_0$ with $C_0 = 10^{20}\\ \\mathrm{m}^{-3}$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order\n$$\n[\\text{TC1\\_dose},\\text{TC1\\_rowsum},\\text{TC2\\_dose},\\text{TC2\\_rowsum},\\text{TC3\\_dose},\\text{TC3\\_rowsum},\\text{TC4\\_dose},\\text{TC4\\_rowsum}],\n$$\nwhere each entry is a boolean indicating whether the corresponding check passed for that test case.",
            "solution": "The task is to develop and implement a one-dimensional finite volume method (FVM) for the transient diffusion equation with spatially varying diffusivity, $\\frac{\\partial C(x,t)}{\\partial t} = \\frac{\\partial}{\\partial x}\\left(D(x)\\,\\frac{\\partial C(x,t)}{\\partial x}\\right)$, on a finite domain $[0,L]$ with zero-flux boundary conditions. The spatial discretization must be conservative, and the time integration will use the fully implicit backward Euler scheme. We must also prove that the resulting numerical scheme conserves the total dopant dose.\n\n**1. Derivation of the Semi-Discrete Finite Volume Scheme**\n\nThe finite volume method begins by integrating the governing partial differential equation (PDE) over a control volume $V_i$, which in one dimension is a cell $i$ spanning the interval $[x_{i-\\frac{1}{2}}, x_{i+\\frac{1}{2}}]$. The width of the cell is $\\Delta x_i = x_{i+\\frac{1}{2}} - x_{i-\\frac{1}{2}}$, and for unit cross-sectional area, the volume is $V_i = \\Delta x_i$.\n\nIntegrating the PDE over cell $i$:\n$$\n\\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} \\frac{\\partial C(x,t)}{\\partial t} dx = \\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} \\frac{\\partial}{\\partial x}\\left(D(x)\\,\\frac{\\partial C(x,t)}{\\partial x}\\right) dx\n$$\nAssuming the average concentration in cell $i$ is $C_i(t) = \\frac{1}{\\Delta x_i} \\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} C(x,t) dx$, the left-hand side can be approximated as:\n$$\n\\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} \\frac{\\partial C(x,t)}{\\partial t} dx \\approx \\frac{d}{dt} \\left(\\Delta x_i C_i(t)\\right) = V_i \\frac{dC_i(t)}{dt}\n$$\nThe right-hand side is integrated using the Fundamental Theorem of Calculus (the divergence theorem in 1D):\n$$\n\\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} \\frac{\\partial}{\\partial x}\\left(D(x)\\,\\frac{\\partial C(x,t)}{\\partial x}\\right) dx = \\left[ D(x)\\,\\frac{\\partial C(x,t)}{\\partial x} \\right]_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}}\n$$\nThe diffusive flux is defined by Fick's first law as $J(x,t) = -D(x)\\,\\frac{\\partial C(x,t)}{\\partial x}$. The problem defines flux as $F(x,t) = -J(x,t) = D(x)\\frac{\\partial C}{\\partial x}$. The integral thus becomes:\n$$\nF(x_{i+\\frac{1}{2}}, t) - F(x_{i-\\frac{1}{2}}, t) = F_{i+\\frac{1}{2}}(t) - F_{i-\\frac{1}{2}}(t)\n$$\nThis gives the semi-discrete conservation law for cell $i$:\n$$\nV_i\\,\\frac{d C_i(t)}{dt} = F_{i+\\frac{1}{2}}(t) - F_{i-\\frac{1}{2}}(t)\n$$\nTo proceed, we need a discrete expression for the flux $F_{i+\\frac{1}{2}}$ at the interface between cell $i$ and cell $i+1$. We approximate the concentration gradient at the interface using the cell-centered concentrations $C_i$ and $C_{i+1}$, and we need a representative diffusivity at the interface, $D_{i+\\frac{1}{2}}$. The flux is approximated as:\n$$\nF_{i+\\frac{1}{2}} \\approx D_{i+\\frac{1}{2}} \\frac{C_{i+1} - C_i}{x_{i+1} - x_i}\n$$\nwhere $x_i$ and $x_{i+1}$ are the centers of cells $i$ and $i+1$. For a grid where cell centers are midpoints, $x_{i+1} - x_i = (\\Delta x_i + \\Delta x_{i+1}) / 2$. However, a more robust formulation for interface flux, particularly for non-uniform grids and variable diffusivity, is derived by considering the flux to be constant between cell centers and integrating the resistance $1/D(x)$. This leads to a harmonic mean for the effective diffusivity. The flux between cell $i$ and cell $i+1$ is given by:\n$$\nF_{i+\\frac{1}{2}} = \\gamma_{i+\\frac{1}{2}} (C_{i+1} - C_i)\n$$\nwhere $\\gamma_{i+\\frac{1}{2}}$ is the interface conductance. It is derived by considering the series of resistances to diffusion from center $x_i$ to face $x_{i+\\frac{1}{2}}$ and from face $x_{i+\\frac{1}{2}}$ to center $x_{i+1}$:\n$$\n\\gamma_{i+\\frac{1}{2}} = \\frac{1}{R_i + R_{i+1}} = \\frac{1}{\\frac{x_{i+\\frac{1}{2}} - x_i}{D_i} + \\frac{x_{i+1} - x_{i+\\frac{1}{2}}}{D_{i+1}}} = \\frac{1}{\\frac{\\Delta x_i / 2}{D_i} + \\frac{\\Delta x_{i+1} / 2}{D_{i+1}}} = \\frac{2 D_i D_{i+1}}{D_{i+1} \\Delta x_i + D_i \\Delta x_{i+1}}\n$$\nHere, $D_i = D(x_i)$ is the diffusivity at the center of cell $i$. This expression is symmetric and correctly handles large contrasts in $D$.\nThe semi-discrete system for an interior cell $i$ is:\n$$\nV_i \\frac{dC_i}{dt} = \\gamma_{i+\\frac{1}{2}}(C_{i+1} - C_i) - \\gamma_{i-\\frac{1}{2}}(C_i - C_{i-1}) = \\gamma_{i-\\frac{1}{2}}C_{i-1} - (\\gamma_{i-\\frac{1}{2}} + \\gamma_{i+\\frac{1}{2}})C_i + \\gamma_{i+\\frac{1}{2}}C_{i+1}\n$$\n\n**2. Boundary Conditions and Matrix Structure**\n\nZero-flux boundary conditions, $J(0,t)=0$ and $J(L,t)=0$, imply $F_{1/2}(t)=0$ and $F_{N+1/2}(t)=0$. This is equivalent to setting the conductances at the domain boundaries to zero: $\\gamma_{1/2} = 0$ and $\\gamma_{N+1/2} = 0$.\nThe equations for the boundary cells are:\n- For cell $i=1$: $V_1 \\frac{dC_1}{dt} = F_{3/2} - F_{1/2} = \\gamma_{3/2}(C_2 - C_1)$\n- For cell $i=N$: $V_N \\frac{dC_N}{dt} = F_{N+1/2} - F_{N-1/2} = -\\gamma_{N-1/2}(C_N - C_{N-1})$\n\nLet $\\mathbf{C}$ be the vector of cell concentrations $[C_1, \\dots, C_N]^T$. The semi-discrete system can be written in matrix form as $\\mathbf{M} \\frac{d\\mathbf{C}}{dt} = \\mathbf{A}\\mathbf{C}$, where $\\mathbf{M}$ is a diagonal matrix with $M_{ii} = V_i = \\Delta x_i$. The matrix $\\mathbf{A}$ represents the spatial operator. Its entries are:\n- $A_{i,i} = -(\\gamma_{i-\\frac{1}{2}} + \\gamma_{i+\\frac{1}{2}})$ for $i=2, \\dots, N-1$\n- $A_{i, i-1} = \\gamma_{i-\\frac{1}{2}}$ for $i=2, \\dots, N$\n- $A_{i, i+1} = \\gamma_{i+\\frac{1}{2}}$ for $i=1, \\dots, N-1$\n- $A_{1,1} = -\\gamma_{3/2}$, $A_{N,N} = -\\gamma_{N-1/2}$\nThe sum of each row of $\\mathbf{A}$ is zero. For an interior row $i$, the sum is $A_{i,i-1} + A_{i,i} + A_{i,i+1} = \\gamma_{i-\\frac{1}{2}} -(\\gamma_{i-\\frac{1}{2}} + \\gamma_{i+\\frac{1}{2}}) + \\gamma_{i+\\frac{1}{2}} = 0$. For row $1$, it is $A_{1,1} + A_{1,2} = -\\gamma_{3/2} + \\gamma_{3/2} = 0$. For row $N$, it is $A_{N,N-1} + A_{N,N} = \\gamma_{N-1/2} - \\gamma_{N-1/2} = 0$. This property, $\\mathbf{A}\\mathbf{1}=\\mathbf{0}$, where $\\mathbf{1}$ is the vector of ones, ensures that a uniform concentration profile results in zero net flux and is a stationary solution, as expected physically.\n\n**3. Temporal Discretization and Final System**\n\nApplying the first-order accurate backward Euler method to the semi-discrete system gives:\n$$\nV_i \\frac{C_i^{n+1} - C_i^n}{\\Delta t} = F_{i+\\frac{1}{2}}^{n+1} - F_{i-\\frac{1}{2}}^{n+1}\n$$\nwhere the fluxes are evaluated at the new time level $n+1$. In matrix form:\n$$\n\\mathbf{M} \\frac{\\mathbf{C}^{n+1} - \\mathbf{C}^n}{\\Delta t} = \\mathbf{A} \\mathbf{C}^{n+1}\n$$\nRearranging to solve for $\\mathbf{C}^{n+1}$, we get:\n$$\n\\mathbf{M}\\mathbf{C}^{n+1} - \\Delta t \\mathbf{A}\\mathbf{C}^{n+1} = \\mathbf{M}\\mathbf{C}^n \\implies (\\mathbf{M} - \\Delta t \\mathbf{A})\\mathbf{C}^{n+1} = \\mathbf{M}\\mathbf{C}^n\n$$\nThis is a linear system of equations to be solved at each time step for the unknown concentration vector $\\mathbf{C}^{n+1}$.\n\n**4. Proof of Discrete Dose Conservation**\n\nThe discrete dose (total amount of dopant per unit area) at time step $n$ is defined as $Q^n = \\sum_{i=1}^N V_i C_i^n$. We must show that $Q^{n+1}=Q^n$ under the zero-flux boundary conditions.\nSum the fully discrete equation over all cells $i=1, \\dots, N$:\n$$\n\\sum_{i=1}^N V_i\\frac{C_i^{n+1} - C_i^n}{\\Delta t} = \\sum_{i=1}^N \\left(F_{i+\\frac{1}{2}}^{n+1} - F_{i-\\frac{1}{2}}^{n+1}\\right)\n$$\nThe left-hand side is:\n$$\n\\frac{1}{\\Delta t} \\left(\\sum_{i=1}^N V_i C_i^{n+1} - \\sum_{i=1}^N V_i C_i^n\\right) = \\frac{Q^{n+1} - Q^n}{\\Delta t}\n$$\nThe right-hand side is a telescoping sum:\n$$\n\\sum_{i=1}^N \\left(F_{i+\\frac{1}{2}}^{n+1} - F_{i-\\frac{1}{2}}^{n+1}\\right) = (F_{3/2}^{n+1} - F_{1/2}^{n+1}) + (F_{5/2}^{n+1} - F_{3/2}^{n+1}) + \\dots + (F_{N+\\frac{1}{2}}^{n+1} - F_{N-\\frac{1}{2}}^{n+1}) = F_{N+\\frac{1}{2}}^{n+1} - F_{1/2}^{n+1}\n$$\nThe zero-flux boundary conditions impose $F_{1/2}(t)=0$ and $F_{N+1/2}(t)=0$ for all time $t$, including $t=t^{n+1}$. Therefore, the sum on the right-hand side evaluates to $0-0=0$.\nWe are left with:\n$$\n\\frac{Q^{n+1} - Q^n}{\\Delta t} = 0\n$$\nThis implies $Q^{n+1} - Q^n = 0$, or $Q^{n+1} = Q^n$. This proves that the numerical scheme is conservative, meaning it preserves the total dose in the domain for any time step $\\Delta t$, assuming exact arithmetic. This property is a direct consequence of the FVM formulation where fluxes from adjacent cells cancel perfectly.",
            "answer": "```python\nimport numpy as np\nfrom scipy import linalg\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print results.\n    \"\"\"\n\n    def run_case(L, N, dt, num_steps, D_func, C_func, grid_type='uniform', grid_param=None):\n        \"\"\"\n        Runs a single simulation case for the 1D diffusion problem.\n        \n        Returns:\n            (bool, bool): A tuple containing booleans for dose conservation and A matrix row sum check.\n        \"\"\"\n        # 1. Grid Generation\n        # Cell indices k = 0, ..., N-1. Face indices j = 0, ..., N.\n        x_face = np.zeros(N + 1)\n        if grid_type == 'uniform':\n            x_face = np.linspace(0, L, N + 1)\n        elif grid_type == 'nonuniform':\n            s = np.linspace(0, 1, N + 1)\n            x_face = L * (s**grid_param)\n        \n        dx = x_face[1:] - x_face[:-1]  # Cell widths, V_i or M_ii\n        x_cell = 0.5 * (x_face[:-1] + x_face[1:]) # Cell centers\n\n        # 2. Initialization\n        D_cell = D_func(x_cell)\n        C_current = C_func(x_cell)\n        \n        # Diagonal of mass matrix M\n        M_diag = dx\n        \n        initial_dose = np.sum(M_diag * C_current)\n\n        # 3. Assemble stiffness matrix A\n        A = np.zeros((N, N))\n        \n        if N  1:\n            gamma = np.zeros(N - 1)\n            # Loop over interior faces (indices k = 0 to N-2, corresponding to interfaces 3/2, 5/2, ...)\n            for k in range(N - 1):\n                # Harmonic mean-based conductance\n                resistance = (dx[k] / (2.0 * D_cell[k])) + (dx[k+1] / (2.0 * D_cell[k+1]))\n                gamma[k] = 1.0 / resistance\n                A[k, k + 1] = gamma[k]\n                A[k + 1, k] = gamma[k]\n        \n        # Fill diagonal of A to enforce row sums are zero\n        # This handles boundary conditions implicitly.\n        for k in range(N):\n            A[k, k] = -np.sum(A[k, :])\n\n        # 4. Check properties of A\n        row_sums = np.sum(A, axis=1)\n        row_sum_check = np.all(np.abs(row_sums)  1e-12)\n\n        # 5. Time Stepping\n        # Form the system matrix S = (M - dt*A)\n        S = np.diag(M_diag) - dt * A\n        \n        for _ in range(num_steps):\n            # RHS vector b = M * C^n\n            b = M_diag * C_current\n            # Solve S * C^{n+1} = b\n            C_current = linalg.solve(S, b)\n\n        # 6. Check dose conservation\n        final_dose = np.sum(M_diag * C_current)\n        \n        # Use relative tolerance, guard against zero initial dose\n        if np.abs(initial_dose)  1e-20:\n            relative_error = np.abs((final_dose - initial_dose) / initial_dose)\n            dose_check = relative_error  1e-12\n        else: # If initial dose is effectively zero\n            dose_check = np.abs(final_dose)  1e-12\n\n        return dose_check, row_sum_check\n\n    test_cases = [\n        {\n            \"L\": 1e-6, \"N\": 64, \"dt\": 10.0, \"num_steps\": 10,\n            \"D_func\": lambda x: 1e-14 * np.ones_like(x),\n            \"C_func\": lambda x: 1e23 * np.exp(-(x - 1e-6/2)**2 / (2 * (1e-6/10)**2)),\n            \"grid_type\": \"uniform\", \"grid_param\": None\n        },\n        {\n            \"L\": 1e-6, \"N\": 100, \"dt\": 20.0, \"num_steps\": 10,\n            \"D_func\": lambda x: np.piecewise(x, [x = 1e-6/2], [1e-14, 1e-16]),\n            \"C_func\": lambda x: np.piecewise(x, [x = 1e-6/3], [1e22, 0.0]),\n            \"grid_type\": \"uniform\", \"grid_param\": None\n        },\n        {\n            \"L\": 1e-6, \"N\": 53, \"dt\": 5.0, \"num_steps\": 20,\n            \"D_func\": lambda x: 1e-14 * (1 + 0.8 * np.sin(2 * np.pi * x / 1e-6)),\n            \"C_func\": lambda x: 1e21 * np.piecewise(x, [x = 1e-6/2],\n                                [lambda v: v / 1e-6, lambda v: 1 - v / 1e-6]),\n            \"grid_type\": \"nonuniform\", \"grid_param\": 2.0\n        },\n        {\n            \"L\": 1e-6, \"N\": 1, \"dt\": 100.0, \"num_steps\": 5,\n            \"D_func\": lambda x: 1e-15 * np.ones_like(x),\n            \"C_func\": lambda x: 1e20 * np.ones_like(x),\n            \"grid_type\": \"uniform\", \"grid_param\": None\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        dose_ok, rowsum_ok = run_case(**case)\n        results.extend([dose_ok, rowsum_ok])\n        \n    formatted_results = [str(r).lower() for r in results]\n\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}