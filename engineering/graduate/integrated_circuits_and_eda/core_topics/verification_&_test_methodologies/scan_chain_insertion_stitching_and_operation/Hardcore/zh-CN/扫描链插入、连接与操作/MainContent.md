## 引言
在现代超大规模[集成电路](@entry_id:265543)（VLSI）的设计中，随着晶体管数量的指数级增长和设计复杂度的日益提高，如何确保芯片在制造后能够被有效、经济地测试，已成为一个核心挑战。尤其是对于包含数百万状态单元的[时序电路](@entry_id:174704)，其内部节点的[可控性与可观测性](@entry_id:174003)极低，使得传统的测试方法面临计算复杂度的“[维度灾难](@entry_id:143920)”。为了应对这一难题，可测试性设计（Design for Testability, DFT）应运而生，而[扫描链](@entry_id:171661)（Scan Chain）技术正是DFT方法论中最重要和最广泛应用的基石。

本文旨在系统性地阐述扫描链的插入、拼接与操作的全过程，为读者构建一个从理论到实践的完整知识框架。我们将首先揭示扫描链如何从根本上改变电路的测试范式，解决棘手的时序ATPG问题。随后，我们将探讨该技术在复杂的IC设计流程中如何与其他领域交叉融合，并最终通过具体练习来巩固这些核心概念。

在接下来的章节中，你将学习到：

- **第一章：原理与机制**，将深入探讨[扫描设计](@entry_id:177301)为何能极大地提升[可控性与可观测性](@entry_id:174003)，剖析主流扫描单元的内部结构，并详细介绍如何操作扫描链以检测包括[固定型故障](@entry_id:171196)和转换故障在内的关键缺陷模型。同时，本章还将覆盖物理实现中的核心挑战，如[扫描链](@entry_id:171661)拼接与[时序收敛](@entry_id:167567)。
- **第二章：应用与跨学科关联**，将视野扩展到扫描技术在整个EDA流程中的集成，包括如何通过[形式验证](@entry_id:149180)确保其功能正确性，以及它如何成为[测试压缩](@entry_id:1132958)、低功耗测试、系统级调试（JTAG）乃至硬件安全等高级应用的支撑平台。
- **第三章：动手实践**，将通过一系列精心设计的计算与分析问题，引导读者亲手处理[扫描插入](@entry_id:1131278)带来的时序影响、[保持时间](@entry_id:266567)风险分析以及扫描链重排序优化，将理论知识转化为解决实际工程问题的能力。

让我们首先进入第一章，从[扫描设计](@entry_id:177301)最核心的原理——增强电路[可控性与可观测性](@entry_id:174003)开始我们的探索。

## 原理与机制

### 基本原理：增强[可控性与可观测性](@entry_id:174003)

在[数字电路](@entry_id:268512)测试领域，两个核心概念是**可控性 (controllability)** 和**可观测性 (observability)**。对于电路中的任意一个内部节点 $x$，[可控性](@entry_id:148402)指的是通过施加一系列输入，将其设置为特定逻辑值（0或1）的能力；[可观测性](@entry_id:152062)则是指该节点上的逻辑值变化能够传播到某个可被观察的输出点的能力 。

在一个[同步时序电路](@entry_id:175242)中，我们可以将其建模为一个[有限状态机](@entry_id:174162)（FSM）。该[状态机](@entry_id:171352)由[状态空间](@entry_id:160914) $S = \{0,1\}^n$、主输入 $I = \{0,1\}^m$、主输出 $O = \{0,1\}^p$、次态函数 $s_{k+1} = F(s_k, i_k)$ 和输出函数 $y_k = G(s_k, i_k)$ 共同描述 。在这种模型下，测试的挑战变得尤为突出。为了控制某个内部节点的值，我们必须找到一个输入向量序列 $\{i_0, i_1, \dots, i_{t-1}\}$，驱动状态机从已知的复位状态 $s_{\text{reset}}$ 经过一系列状态转换，最终到达一个能够激活目标故障的特定状态 $s_{test}$。这个过程被称为“状态论证”（state justification）。然而，并非所有状态都是从 $s_{\text{reset}}$ 可达的，这构成了**状态[可达性](@entry_id:271693) (state reachability)** 的根本限制。同样，要观察一个故障效应，可能需要另一个输入序列，将锁存到触发器中的错误值通过多级时序逻辑逐步传播到主输出端。

这些挑战使得[时序电路](@entry_id:174704)的自动测试[向量生成](@entry_id:152883)（ATPG）成为一个极其复杂的问题。从[计算复杂性](@entry_id:204275)的角度看，它在最坏情况下是 $\mathsf{PSPACE}$-完备的 。为了解决这一难题，设计可测试性（DFT）领域引入了一种革命性的技术：**[扫描设计](@entry_id:177301) (scan design)**。

全扫描（full-scan）设计的基本思想是将电路中所有的 $n$ 个触发器都替换为可扫描的单元。通过这种转换，我们实际上在测试模式下打破了电路中的所有时序反馈环路。在测试时，这些扫描单元被连接成一条或多条[移位寄存器](@entry_id:754780)，即**扫描链 (scan chain)**。这一结构从根本上改变了[可控性](@entry_id:148402)和[可观测性](@entry_id:152062)：

1.  **完美的[可控性](@entry_id:148402)**：通过扫描链的“扫描移入”（scan-in）操作，我们可以在 $n$ 个时钟周期内将任意一个 $n$ 位的二进制向量加载到所有触发器中。这意味着电路的任何一个状态 $s \in \{0,1\}^n$ 都变得可以直接设置，完全摆脱了功能模式下状态可达性的束缚 。因此，在ATP工具眼中，触发器的输出在测试时表现得如同可以直接控制的**伪主输入 (Pseudo-Primary Inputs, PPIs)** 。

2.  **完美的[可观测性](@entry_id:152062)**：在施加一个测试激励（即设置好PPIs和主输入）并经过一个时钟周期的“捕获”（capture）操作后，[组合逻辑](@entry_id:265083)的输出结果被锁存到触发器中。这个新的状态 $s' = F(s, i)$ 可以通过“扫描移出”（scan-out）操作被完整地读出。因此，触发器的输入端在测试时等效于可直接观察的**伪主输出 (Pseudo-Primary Outputs, PPOs)** 。

通过将触发器状态转化为PPIs和PPOs，[扫描设计](@entry_id:177301)巧妙地将棘手的时序ATPG问题转化为了一个单周期内的组合逻辑ATPG问题。尽管[组合逻辑](@entry_id:265083)ATPG本身依然是 $\mathsf{NP}$-完备的，但其计算复杂度远低于时序ATPG，这使得对大规模[集成电路](@entry_id:265543)进行高质量的测试成为可能 。

### 扫描单元架构

将标准[触发器转换](@entry_id:177244)为扫描单元需要引入额外的逻辑。业界存在多种实现方式，其中最主流的是**[多路复用器](@entry_id:172320)D型（Muxed-D）[扫描触发器](@entry_id:168275)**和**电平敏感[扫描设计](@entry_id:177301)（LSSD）**。

#### Muxed-D [扫描触发器](@entry_id:168275)

Muxed-D 扫描单元的结构非常直观：在标准[D型触发器](@entry_id:171740)的数据输入端（D）前增加一个 $2:1$ 多路复用器（MUX）。该MUX由一个全局的**扫描使能（Scan Enable, SE）**信号控制。当 $SE=0$ 时，MUX选择功能数据输入 $D$，电路工作在正常的功能模式下。当 $SE=1$ 时，MUX选择扫描输入 $SI$，触发器的数据来源切换为前一个扫描单元的输出，从而形成扫描链 。扫描[移位](@entry_id:145848)和功能捕获都使用同一个[时钟信号](@entry_id:174447)。

这种架构的优点是设计简单、面积开销相对较小。然而，它也带来了不可忽视的性能影响。在功能模式下（$SE=0$），数据信号必须穿过MUX才能到达触发器内部的[锁存器](@entry_id:167607)，这会给[关键路径](@entry_id:265231)增加额外的延迟（$t_{mux}$）。这相当于增加了触发器的[建立时间](@entry_id:167213)（setup time, $t_{su}$），从而可能降低电路的最高工作频率。同时，MUX的存在也增加了D输入端的[等效电容](@entry_id:274130) $\Delta C_D$，对于驱动该节点的[组合逻辑](@entry_id:265083)门，这会使其[RC延迟](@entry_id:262267)增加 。

此外，Muxed-D 架构对时钟歪斜（clock skew）较为敏感。在扫描[移位](@entry_id:145848)期间，如果捕获级触发器的时钟边沿比发射级来得早太多，可能会发生[保持时间](@entry_id:266567)（hold time）违例，导致数据在一个时钟周期内“穿越”多个触发器，破坏[扫描链](@entry_id:171661)的完整性。因此，当[扫描链](@entry_id:171661)跨越时钟域或物理距离很远的区域时，往往需要插入特殊的时序单元来保证扫描的可靠性 。

#### 电平敏感[扫描设计](@entry_id:177301) (LSSD)

LSSD 采用了一种完全不同的设计哲学。其核心单元（通常称为[移位寄存器](@entry_id:754780)锁存器，SRL）由一个主[锁存器](@entry_id:167607)（L1）和一个从锁存器（L2）构成。扫描[移位](@entry_id:145848)操作由两个独立的、互不交叠的扫描时钟 $C_1$ 和 $C_2$ 控制。当 $C_1$ 有效时，L1 锁存器透明，捕获数据；当 $C_2$ 有效时，L2 锁存器透明，将数据从L1传递过来。由于 $C_1$ 和 $C_2$ 永远不会同时有效，数据绝无可能在一个[时钟周期](@entry_id:165839)内穿越整个SRL单元。

LSSD 的主要优势在于其**固有的无竞争（race-free）扫描机制**。这种两相时钟方案使得扫描操作对时钟歪斜的容忍度极高，大大增强了测试的鲁棒性。它还将扫描时序与功能时序[解耦](@entry_id:160890)，因为扫描[移位](@entry_id:145848)使用专用的 $C_1/C_2$ 时钟，不影响高速的功能时钟路径。其代价是，LSSD单元比Muxed-D单元更复杂，面积开销更大，并且需要额外布线两路扫描[时钟信号](@entry_id:174447) 。

### 面向故障测试的[扫描链](@entry_id:171661)操作

[扫描链](@entry_id:171661)的核心用途是为测试不同的[故障模型](@entry_id:1124860)提供强大的控制和观察能力。基本操作流程包含**扫描[移位](@entry_id:145848)模式 (scan shift mode)** 和 **扫描捕获模式 (scan capture mode)**。在[移位](@entry_id:145848)模式下，$SE=1$，功能时钟被屏蔽，扫描时钟有效，测试激励向量被移入扫描链，同时上一轮的测试结果被移出。在捕获模式下，$SE=0$，扫描时钟被屏蔽，功能时钟有效，电路执行一次或多次功能操作以激活并捕获故障效应 。

#### 静态测试：[固定型故障](@entry_id:171196) (Stuck-At Faults)

**[固定型故障](@entry_id:171196)**模型是最经典也是最基础的[故障模型](@entry_id:1124860)，它假设电路中某个节点永久性地固定为逻辑'1'（stuck-at-1）或逻辑'0'（stuck-at-0）。这是一种静态故障，其检测不依赖于电路的工作速度。

测试[固定型故障](@entry_id:171196)的扫描序列如下 ：
1.  **扫描移入**：置位 $SE=1$，通过扫描时钟将一个精心计算的测试向量移入[扫描链](@entry_id:171661)。该向量的作用是：(a) 在故障点产生与固定值相反的逻辑值（例如，测试stuck-at-1就需要驱动该点为0）；(b) 构造一条从故障点到某个PPO（即[扫描触发器](@entry_id:168275)的输入端）的敏化路径。
2.  **捕获**：置位 $SE=0$，施加一个**单一的**功能时钟脉冲。该脉冲将沿着敏化路径传播的故障效应（或无故障时的正确值）捕获到目标[扫描触发器](@entry_id:168275)中。由于是静态测试，该捕获时钟的频率无需达到电路的额定工作速度。
3.  **扫描移出**：再次置位 $SE=1$，通过扫描时钟将扫描链中的内容（即捕获到的测试结果）全部移出，并与[期望值](@entry_id:150961)进行比较，从而判断是否存在故障。

#### 动态测试：转换故障 (Transition Faults)

随着工艺尺寸缩小，由制造缺陷引起的微小延迟成为主要的失效模式之一。**转换故障**模型正是为了检测这类缺陷，它模拟某个节点的信号跳变（从0到1或从1到0）速度过慢，无法在指定的[时钟周期](@entry_id:165839)内完成。这是一种动态故障，其测试必须在电路的**额定速度（at-speed）**下进行。

检测转换故障需要施加两个连续的测试向量：第一个向量用于**初始化**节点状态，第二个向量用于**发射**一个相反的转换并**传播**其效应。在[扫描设计](@entry_id:177301)中，这通常通过以下两种方法实现 ：

1.  **捕获时发射 (Launch-on-Capture, LOC)**：
    -   首先，通过扫描移入操作加载**初始化向量**。
    -   然后，置位 $SE=0$。关键操作是连续施加**两个背靠背的、at-speed的功能时钟脉冲**。
    -   第一个脉冲的作用是“发射”：它捕获由初始化向量产生的组合逻辑结果，这个新状态作为第二个测试向量，从而在电路内部的目标节点上产生一个转换。
    -   第二个脉冲的作用是“捕获”：它在一个完整的、at-speed的[时钟周期](@entry_id:165839)后，捕获该转换的结果。如果转换过慢，捕获到的将是错误的逻辑值。
    -   最后，通过扫描移出观察结果。在整个LOC序列中，$SE$ 信号必须在两个功能时钟脉冲前后保持稳定，以避免[亚稳态](@entry_id:167515) 。

2.  **[移位](@entry_id:145848)时发射 (Launch-on-Shift, LOS)**：
    -   该方法巧妙地利用了扫描移位操作本身来发射转换。测试向量的加载方式有所不同：**最后一个扫描移位时钟脉冲**被设计为at-speed的。这个脉冲使发射触发器的值发生变化，从而在目标节点上“发射”转换。
    -   紧接着，在时钟的非有效电平期间，**$SE$ 信号必须迅速从1切换到0**，并满足下一级触发器的建立时间要求。
    -   然后，施加**一个 at-speed 的功能时钟脉冲**来捕获转换的结果。
    -   最后扫描移出。LOS方法对测试控制器的时序控制要求更高，特别是$SE$信号的快速切换和扫描时钟与功能时钟的精确对齐 。

### 物理实现：拼接与[时序收敛](@entry_id:167567)

将抽象的扫描概念付诸实践，需要在[物理设计](@entry_id:1129644)层面进行细致的规划，主要涉及**[扫描链](@entry_id:171661)拼接（stitching）**和**[时序收敛](@entry_id:167567)（timing closure）**。

#### [扫描链](@entry_id:171661)平衡

对于一个包含数百万触发器的大型设计，将所有触发器串成一条超长的[扫描链](@entry_id:171661)是不切实际的，因为其测试时间将长得无法接受。测试时间 $T_{test}$ 近似等于测试向量数 $N_p$ 乘以最长扫描链的长度 $L_{max}$，再除以扫描时钟频率 $f_s$。因此，一个关键的优化目标是**最小化最长[扫描链](@entry_id:171661)长度 $L_{max}$**。

**[扫描链](@entry_id:171661)平衡**就是将设计中所有的扫描单元划分到 $K$ 个并行的扫描链中（$K$受限于芯片可用的扫描I/O引脚数），并使得各链的长度尽可能均匀。在进行分区时，必须遵守严格的物理和功能约束，例如，通常禁止将属于不同时钟域的触发器混合拼接在同一条链中，以避免复杂的时序问题 。例如，一个包含三个时钟域，分别有2400、3600和1200个触发器，并有8个可用扫描通道的设计，一个优化的分配方案可能是将这些通道按2、4、2的[比例分配](@entry_id:634725)给三个域，使得最长链的长度被控制在1200，从而达到最短的测试时间 。

#### [跨时钟域](@entry_id:173614)拼接与[锁存器](@entry_id:167607)

尽管应尽量避免，但有时[扫描链](@entry_id:171661)不得不跨越时钟分布不均的物理区域，或不同的时钟域。此时，一个严峻的挑战来自**时钟歪斜（clock skew）**。考虑数据从发射触发器FF_A（时钟到达时间 $t_{\mathcal{L}}$）传输到捕获触发器FF_B（时钟到达时间 $t_{\mathcal{C}}$）。当时钟歪斜 $\Delta t = t_{\mathcal{C}} - t_{\mathcal{L}}$ 为正值且较大时（即捕获时钟晚于发射时钟），会严重挤压[建立时间](@entry_id:167213)。而当 $\Delta t$ 为负值时（捕获时钟早于发射时钟），则会威胁[保持时间](@entry_id:266567)。[扫描链](@entry_id:171661)中的[保持时间违例](@entry_id:175467)尤其危险，因为它会导致数据在一个周期内穿透多个触发器。

保持时间的基本约束可以表示为：
$t_{cq,\min} + d_{\min} \ge \Delta t_{skew} + t_{hold}$
其中 $t_{cq,\min}$ 是发射触发器的最小钟到Q延迟， $d_{\min}$ 是两者之间的[最小路径延迟](@entry_id:1127942)，$\Delta t_{skew}$ 是时钟歪斜， $t_{hold}$ 是捕获触发器的保持时间要求。如果 $\Delta t_{skew}$ 是一个很大的负值（在我们的定义下，即 $t_{\mathcal{C}} \ll t_{\mathcal{L}}$），这个不等式就很容易不成立。

为了解决这个问题，DFT工程师会插入一种称为**[锁存器](@entry_id:167607)（lock-up latch）**的特殊单元。对于一个上升沿触发的扫描系统，一个典型的[锁存器](@entry_id:167607)是一个**负电平敏感的[锁存器](@entry_id:167607)**。它被放置在FF_A和FF_B之间，并且其时钟输入连接到**发射端**的时钟（即FF_A的时钟）。其工作原理如下 ：
1.  在发射时钟的上升沿，FF_A发射出新数据。同时，由于时钟变为高电平，负电平敏感的锁存器变得不透明（关闭），它会继续保持前一个周期的数据。
2.  新数据到达锁存器输入端，但被阻挡。
3.  半个[时钟周期](@entry_id:165839)后 ($T/2$)，时钟变为低电平。锁存器变为透明（打开），允许新数据通过。

通过这种方式，锁存器人为地为扫描路径增加了大约半个时钟周期的延迟，极大地增加了[保持时间](@entry_id:266567)的裕量，从而可以容忍非常大的时钟歪斜。

### 系统级集成与高级考量

#### 通过[IEEE 1149.1](@entry_id:170153) (JTAG) 访问扫描链

芯片级的测试访问通常遵循 **[IEEE 1149.1](@entry_id:170153) 标准**，即广为人知的 **JTAG (Joint Test Action Group)**。该标准定义了一个**测试访问端口 (Test Access Port, TAP)** 和一个相应的控制器状态机。TAP提供了对芯片内部测试逻辑（包括扫描链）的标准化串行访问机制。

其核心是**指令寄存器 (Instruction Register, IR)** 和多个**数据寄存器 (Data Registers, DRs)**。要访问内部[扫描链](@entry_id:171661)，测试设备必须首先通过TAP控制器进入IR扫描周期，将一条特定的指令（例如，标准定义的 `EXTEST` 或芯片自定义的 `SCAN` 指令）加载到IR中。`Update-IR` 状态的来临会使该指令生效，其作用是配置TAP内部的[多路选择器](@entry_id:172320)，将串行数据路径 ($TDI \to TDO$) 连接到目标DR——在此即为内部[扫描链](@entry_id:171661)。随后，测试设备再通过TAP控制器进入DR扫描周期，此时对DR的`Capture-DR`、`Shift-DR`和`Update-DR`操作就等同于我们之前讨论的扫描捕获、[移位](@entry_id:145848)和更新操作 。

#### 全扫描 vs. 部分扫描的权衡

虽然全扫描提供了最理想的可测试性，但其成本不菲：每个触发器都需要增加一个MUX，这不仅带来面积开销，还会因额外的延迟而影响芯片的性能。一个重要的权衡是**部分扫描（partial scan）**。

部分扫描只选择一部分触发器进行扫描转换，通常会优先选择那些难以通过功能方式控制或观察的触发器（例如，[状态机](@entry_id:171352)中的触发器），或者有策略地选择足够的触发器来打断设计中所有的反馈环路。其优点是显而易见的：更小的面积开销和对时序关键路径的零影响（如果这些路径上的触发器被排除在扫描之外）。

然而，其缺点也同样显著。对于未被扫描的 $N_u$ 个触发器，ATPG工具必须重新面对时序测试生成的问题。有效[状态空间](@entry_id:160914)的大小变为 $2^{N_u}$，问题的复杂度也从 $\mathsf{NP}$-完备回归到 $\mathsf{PSPACE}$-完备 。因此，部分扫描是一种在测试覆盖率、测试生成时间、芯片面积和性能之间进行的复杂工程折衷。

#### 测试期间的功耗问题

一个在现代低功耗设计中日益严峻的问题是**测试期间的功耗**。在扫描移位期间，成千上万的触发器在每个时钟周期同步翻转，这会产生巨大的动态功耗。而在捕获周期，从一个随机的扫描状态出发，可能会导致组合逻辑中出现海量的、在功能模式下极少发生的同步翻转。

这种大规模的瞬时开关活动会导致对[供电网络](@entry_id:1130016)（PDN）的巨大电流需求。瞬时电流 $i(t)$ 在PDN的[等效电阻](@entry_id:264704) $R_{pdn}$ 和电感 $L_{pdn}$ 上会产生显著的[电压降](@entry_id:263648)，即 **IR-drop** 和 **Ldi/dt-drop**：
$v_{\text{drop}}(t) = R_{\text{pdn}} i(t) + L_{\text{pdn}} \frac{di(t)}{dt}$

我们可以定义**[移位](@entry_id:145848)活动性 ($A_{\text{shift}}$)** 和**捕获活动性 ($A_{\text{cap}}$)** 来量化每个时钟边沿附近同时翻转的节点数量。通常，由于组合逻辑的涟漪效应，捕获活动性远高于[移位](@entry_id:145848)活动性。这个活动性 $A$ 直接决定了峰值电流 $I_{\text{peak}} \approx A \cdot \bar{C}_{\text{eff}} \cdot V_{dd} / \tau_{tr}$，其中 $\bar{C}_{\text{eff}}$ 是平均[开关电容](@entry_id:197049)，$V_{dd}$ 是电源电压，$\tau_{tr}$ 是翻转时间。过大的[电压降](@entry_id:263648)可能导致芯片在测试时发生[逻辑错误](@entry_id:140967)，即使其在功能模式下是完全正常的，这被称为测试引起的良率损失。因此，低功耗DFT技术，如[扫描链](@entry_id:171661)重排序、[时钟门控](@entry_id:170233)和在测试时降低电压/频率，已成为现代DFT流程中不可或缺的一部分 。