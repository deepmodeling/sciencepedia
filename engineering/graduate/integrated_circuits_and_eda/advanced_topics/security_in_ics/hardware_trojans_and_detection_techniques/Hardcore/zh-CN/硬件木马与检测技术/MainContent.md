## 引言
在全球化[分工](@entry_id:190326)的背景下，[集成电路](@entry_id:265543)（IC）供应链的复杂性与日俱增，为硬件安全带来了前所未有的挑战。其中，硬件木马作为一种对电路的恶意、蓄意修改，已成为威胁国家安全、商业机密和个人隐私的重大隐患。这些恶意电路被巧妙地植入到芯片的设计或制造流程中，能在关键时刻被激活，执行破坏系统功能、降低性能或泄露敏感信息等恶意行为。传统芯片验证流程主要关注功能正确性，旨在消除无意的设计缺陷和制造瑕疵，但这在面对蓄意设计的、旨在规避标准测试的硬件木马时，暴露出巨大的知识鸿沟和防御盲点。

本文旨在系统性地填补这一空白，为读者构建一个关于硬件木马与检测技术的完整知识框架。在第一章“原理与机制”中，我们将深入剖析[硬件木马](@entry_id:1125920)的定义、分类及其规避检测的根本原理，揭示攻击者如何利用理论和结构上的弱点实现[隐蔽](@entry_id:196364)。随后的第二章“应用与跨学科连接”将展示这些理论如何应用于现实世界的检测技术，从硅前EDA分析到硅后[侧信道分析](@entry_id:1131612)，并揭示其与统计学、机器学习等领域的深刻交叉。最后，在“动手实践”部分，您将有机会通过一系列精心设计的练习，将理论知识转化为解决实际安全问题的能力，从而全面掌握这一关键领域的核心技能。

## 原理与机制

### 定义[硬件木马](@entry_id:1125920)：意图、功能与物理性

在集成电路 (IC) 安全领域，理解硬件木马的根本性质是识别和防御这些威胁的第一步。[硬件木马](@entry_id:1125920)是一种对电路的恶意、有意的修改，其目的是在关键时刻破坏系统的正常运行。为了精确地定义这一概念，我们必须将其与设计流程中无意引入的其他类型异常（如设计缺陷和制造缺陷）区分开来。

#### 核心定义：恶意意图与有效载荷

硬件木马的两个基本且不可或缺的构成要素是**恶意意图 (Malicious Intent)** 和**有效载荷 (Payload)**。一个电路中的异常行为 `x` 被定义为硬件木马，当且仅当它满足以下两个条件 ：

1.  **恶意意图 ($M(x)$)**：该异常是攻击者为了违反系统既定的安全策略而**故意**引入的。这是区分[硬件木马](@entry_id:1125920)与设计缺陷 (Design Bug) 和制造缺陷 (Manufacturing Defect) 的根本标准。设计缺陷是在设计阶段（如 RTL 编码）无意中引入的错误，而制造缺陷是在芯片制造过程中（如光刻、掺杂）无意中产生的物理瑕疵。这两者都缺乏恶意意图。

2.  **有效载荷 ($P(x)$)**：该异常必须能够在特定条件下对电路产生未经授权的、有害的影响。这种影响被称为有效载荷。一个仅存在于攻击者意图中但未在电路中实现任何实际效果的修改，不构成功能性的硬件木马。有效载荷是木马实现其恶意目标的具体机制。

因此，我们可以形式化地将[硬件木马](@entry_id:1125920)定义为 $H(x) \Leftrightarrow M(x) \land P(x)$。这个定义强调了，任何被归类为硬件木马的修改都必须同时具备主观上的恶意性和客观上的破坏能力。

#### 特征与定义之辨：隐蔽性与稀有激活

虽然恶意意图和有效载荷是[硬件木马](@entry_id:1125920)的必要且充分条件，但成功的[硬件木马](@entry_id:1125920)通常还具备另外两个重要特征：**[隐蔽](@entry_id:196364)性 (Stealthiness)** 和**稀有激活 (Activation Dependence)**。

-   **[隐蔽](@entry_id:196364)性 ($S(x)$)**：指木马在标准的硅前验证（如[形式验证](@entry_id:149180)、仿真）和硅后测试（如使用[自动测试向量生成 (ATPG)](@entry_id:174265) 的测试）下被检测到的概率极低。形式上，可以表示为 $\Pr(\text{detect}(x) \mid T_{\text{std}}) \le \epsilon$，其中 $T_{\text{std}}$ 是标准[测试集](@entry_id:637546)，$\epsilon$ 是一个很小的概率阈值。

-   **稀有激活 ($A(x)$)**：指木马的有效载荷仅在满足一个或一组非常见（即发生概率极低）的触发条件时才会被激活。这些条件可以是特定的输入数据、内部状态序列或外部环境参数（如温度、电压）。

需要强调的是，[隐蔽](@entry_id:196364)性和稀有激活是攻击者为了提高木马成功率而精心设计的**工程特征**，而不是其**基本定义**的一部分 。一个设计拙劣、容易被发现或始终处于激活状态的恶意电路，虽然效用低下，但根据其核心定义，它仍然是一个硬件木马。然而，在学术研究和实际防御中，我们主要关注的是那些具备高度隐蔽性和稀有激活特性的高级木马，因为它们对现有验证和测试流程构成了最大的挑战。

### [硬件木马](@entry_id:1125920)的[分类学](@entry_id:172984)：触发器与有效载荷

为了系统地研究和防御硬件木马，我们通常根据其两个主要组成部分——**触发器 (Trigger)** 和**有效载荷 (Payload)**——对其进行分类。触发器是激活木马的“开关”，而有效载荷是木马被激活后执行的恶意功能。

#### 触发机制：木马如何被激活

触发器被设计为对特定的内部或外部事件做出响应。根据其逻辑和物理性质，触发器可分为以下几类 ：

-   **组合逻辑触发器 (Combinational Trigger)**：这类触发器由一个或多个组合逻辑门构成，其激活条件仅依赖于当前[时钟周期](@entry_id:165839)的输入向量，不涉及任何状态记忆。例如，一个木马可能监视着一个加密模块的[数据总线](@entry_id:167432)，当总线上出现一个特定的、极少见的数值（如一个“神奇常数”）时，触发器就被激活。这种触发器结构简单，但由于缺乏时间维度，其隐蔽性相对较弱。

-   **[时序逻辑](@entry_id:181558)触发器 (Sequential Trigger)**：这类触发器包含状态元件（如触发器或[锁存器](@entry_id:167607)），需要一个跨越多个[时钟周期](@entry_id:165839)的特定事件序列才能激活。例如，一个木马可能内置一个计数器，在系统[上电复位](@entry_id:262502)后，当某个内部信号连续出现 N 次高电平后，木马才被激活。或者，一个[有限状态机 (FSM)](@entry_id:176747) 隐藏在正常逻辑中，只有在接收到一长串预设的指令序列后，才会转换到触发状态  。由于其激活[条件依赖](@entry_id:267749)于时间历史，时序触发器比组合触发器更难被功能测试所覆盖，因此[隐蔽](@entry_id:196364)性更强。

-   **模拟与环境触发器 (Analog and Environmental Trigger)**：这类触发器不依赖于数字逻辑值，而是监测连续变化的物理参数。例如，一个内置的模拟比较器可以监视芯片的供电电压 ($V_{dd}$) 或工作温度 ($\Theta$) 。当电压低于某个阈值（例如，在欠压攻击期间）或温度超过正常范围（表明系统处于高负载或被物理篡改）并持续一定时间后，木马被激活 。这类触发器利用了[数字电路](@entry_id:268512)与物理环境的交互，能有效规避纯数字域的验证和测试。

#### 有效载荷机制：木马的恶意行为

有效载荷是[硬件木马](@entry_id:1125920)造成危害的直接方式。根据其对系统的影响，有效载荷可分为以下几类  ：

-   **功能破坏 (Functional Corruption)**：这是最直接的攻击方式。木马在激活后，会改变电路的逻辑功能，导致其产生错误的输出。例如，在特定触发条件下，一个加法器可能输出错误的结果，或者一个处理器的输出端口的某一位被翻转。这种攻击直接破坏了系统的完整性。其可测量的特征是，在触发条件下，电路的输出与“黄金参考模型”的输出不匹配，产生一个非零的错误率 。

-   **参数退化 (Parametric Degradation)**：木马不直接改变电路的逻辑功能，而是恶化其模拟或时序参数。例如，激活后，木马可能会通过增加特定[关键路径](@entry_id:265231)上晶体管的体偏置电压，从而增加该路径的传播延迟 $\Delta d$ 。这会导致芯片的最大工作频率 ($f_{\max}$) 下降，或在标称频率下产生[时序违规](@entry_id:177649) (Timing Violation)。这种攻击不一定会导致立即的功能错误，但会降低系统的性能和可靠性，甚至在极端条件下（如高频工作）导致系统崩溃。其可测量的特征是，在触发条件下，通过片上时序监视器可以观察到路径延迟的增加和时序裕量的减小 。

-   **信息泄露 (Information Leakage)**：这是最隐蔽的攻击方式之一。木马不改变电路的主要功能，而是创建一个**隐蔽信道 (Covert Channel)**，将被保护的敏感信息（如加密密钥、个人数据）泄露到系统外部。例如，一个木马可以将一个秘密密钥的位值调制到一个内部环形振荡器的开关活动上。这个振荡器会产生额外的功耗或[电磁辐射](@entry_id:152916)，其[频谱](@entry_id:276824)特征（如在特定频率 $f_0$ 处出现或消失的谱线）与密钥相关。攻击者可以通过测量芯片的功耗或[电磁辐射](@entry_id:152916)等**旁路信道 (Side Channel)**，[解调](@entry_id:260584)出这些信号，从而窃取密钥 。其可测量的特征是，秘密数据与旁路信道测量值之间存在统计相关性（例如，非零的[相关系数](@entry_id:147037) $\rho$），而电路的逻辑功能输出保持不变 。

### 隐蔽性原理：[硬件木马](@entry_id:1125920)如何规避检测

[硬件木马](@entry_id:1125920)对现代[集成电路](@entry_id:265543)构成严重威胁的核心原因在于其高度的[隐蔽](@entry_id:196364)性。攻击者利用了现有设计验证和测试流程中的根本性盲点，使得木马能够像“特洛伊木马”一样，潜伏在看似正常的电路中。

#### 功能正确性与安全性的鸿沟：非干涉性原理

传统的芯片验证流程，如**形式[等价性检查](@entry_id:168767) (Formal Equivalence Checking)**，其主要目标是确保一个设计（如综合后的网表）在功能上与其规范（如 RTL 代码）等价。然而，“功能正确”并不等同于“安全”。这是一个根本性的区别，也是[硬件木马](@entry_id:1125920)赖以生存的理论基础 。

为了形式化地理解这一点，我们引入**[信息流安全](@entry_id:750638) (Information Flow Security, IFS)** 的概念。一个系统被认为是[信息流安全](@entry_id:750638)的，如果其高机密性输入（如密钥，记为 $\mathcal{H}$）的变化，不会对低安全性或公开的观测输出（如正常的数据输出和旁路信道，记为 $\mathcal{L}$) 产生任何影响。这个性质被称为**非干涉性 (Non-interference)**。

形式上，对于一个系统 $M$，如果对于任意两个不同的高机密性输入 $h_1, h_2 \in \mathcal{H}$，在保持所有低安全输入 $l \in \mathcal{L}$ 不变的情况下，其产生的低安全观测结果 $\pi_L(M(h,l))$ 总是相同的，即 $\pi_L(M(h_1,l)) = \pi_L(M(h_2,l))$，那么该系统就满足非干涉性。

[硬件木马](@entry_id:1125920)的设计巧妙地利用了这一点。一个信息泄露型木马可以被设计成在所有输入下都产生功能上正确的输出，从而通过所有[等价性检查](@entry_id:168767)。然而，它会根据高机密性输入 $h$ 的值来改变其内部的某些物理行为（如开关活动 $\alpha$），进而影响功耗 ($P_{\text{dyn}}$) 等旁路信道。如果我们的观测模型 $\pi_L$ 足够强大，能够包含对功耗的观测，那么当 $h$ 从 $h_1$ 变为 $h_2$ 时，我们就会观测到 $\pi_L$ 的变化，这意味着系统违反了非干涉性原则。因此，功能[等价性检查](@entry_id:168767)由于其观测范围的局限性（通常只关注指定的输出端口），无法保证非干涉性，从而为[硬件木马](@entry_id:1125920)留下了生存空间 。

#### 结构与概率[隐蔽](@entry_id:196364)性

除了利用验证理论的盲点，攻击者还会在电路结构和概率层面精心设计木马以实现隐蔽。

-   **[可控性与可观测性](@entry_id:174003)**：在电路测试领域，**可控性 (Controllability)** 指的是将一个内部节点设置为特定逻辑值（0 或 1）的难易程度；**[可观测性](@entry_id:152062) (Observability)** 指的是一个内部节点上的逻辑值变化能否被传播到主输出并被观察到的难易程度。像 SCOAP (Sandia Controllability/Observability Analysis Program) 这样的算法为每个节点计算可控性成本 ($CC0, CC1$) 和[可观测性](@entry_id:152062)成本 ($CO$) 。成本越高，意味着控制或观察越困难。
    一个精巧的木马触发器会被放置在一个**低[可控性](@entry_id:148402)**（高成本）的节点上。这意味着需要一个非常罕见且复杂的输入向量组合才能激活它。同样，一个隐蔽的有效载荷（特别是功能破坏型）会被设计成其影响只出现在一个**低可观测性**（高成本）的节点上，使得其导致的错误很难传播到芯片的引脚被检测到 。

-   **时序深度[与门](@entry_id:166291)控**：为了实现低[可控性](@entry_id:148402)，攻击者常常采用增加时序深度的方法。一个需要多个[时钟周期](@entry_id:165839)、依赖于一长串罕见事件序列的**时序触发器**，其激活概率会随着序列长度的增加而指数级下降 。例如，一个需要两个相隔一个周期的罕见事件 $r$（概率为 $P(r)$）才能触发的木马，其激活概率近似为 $P(r)^2$。此外，为了躲避基于[扫描链](@entry_id:171661)的测试，木马逻辑通常会被测试模式信号 (`test_mode`) 门控。当 `test_mode` 为高电平时（表示芯片处于测试模式），木马的状态更新逻辑被禁用，使其在整个测试过程中保持休眠状态，从而实现对标准 DFT (Design for Test) 流程的免疫 。

#### 量化[隐蔽](@entry_id:196364)性：规避行为的度量

为了更科学地评估[硬件木马](@entry_id:1125920)的隐蔽程度，研究人员提出了一系列量化指标，这些指标与不同的检测机制直接相关 ：

-   **结构相似性 (Structural Similarity)**：该指标用于评估木马对原始设计（黄金参考网表）的结构扰动程度。一个高度[隐蔽](@entry_id:196364)的木马应该只对网表做微小的修改。这可以通过**图[编辑距离](@entry_id:152711) (Graph Edit Distance)** 来度量，即把可疑网表转换为黄金参考网表所需的最少节点/边线增删改操作数。[编辑距离](@entry_id:152711)越小，结构相似性越高，木马越难被基于网表比较的[结构分析](@entry_id:153861)工具发现。

-   **开关活动偏差 (Switching Activity Deviation)**：该指标用于评估木马对电路功耗特征的影响。旁路信道分析通常通过比较可疑芯片与黄金芯片的功耗轨迹来检测异常。一个隐蔽的木马，其触发器和未激活时的有效载荷应该具有极低的开关活动，从而使其引入的功耗偏差小于检测系统的噪声阈值。该偏差可以量化为在典型输入激励下，两个设计在所有节点上开关活动因子 $\alpha_i$ 的加权差值之和。

-   **可测试性距离 (Testability Distance)**：该指标用于评估木马被 ATPG 工具生成的测试向量激活和传播的难度。一个隐蔽的木马通常被插入到电路中可测试性差的区域。这可以通过比较插入木马前后，其影响区域内节点的 SCOAP 可控性/[可观测性](@entry_id:152062)成本的变化来量化。如果木马显著增加了相关节点的测试成本，那么它就更难被基于仿真的测试方法所检测。

### 木马植入机制：攻击者的视角

理解硬件木马是如何被植入到芯片中的，对于构建一个安全的供应链至关重要。从最初的设计理念到最终的现场部署，现代 IC 供应链的每一个环节都可能成为攻击者的切入点。

#### IC 供应链的攻击面

硬件木马的植入可以在芯片生命周期的多个阶段发生，主要可以分为硅前（设计阶段）和硅后（制造与部署阶段）：

-   **设计阶段（硅前）**：
    1.  **RTL 设计**：一个恶意的内部设计人员可以直接在[硬件描述语言 (HDL)](@entry_id:1125915) 源代码中编写木马逻辑。
    2.  **第三方 IP 集成**：设计团队通常会从第三方供应商处购买[知识产权](@entry_id:908926) (IP) 核（如处理器、接口控制器）。这些 IP 核可能以加密的网表或硬核形式提供，难以进行彻底的内部审查，从而可能被植入木马。
    3.  **[逻辑综合](@entry_id:274398)与 DFT**：恶意工程师或被篡改的电子设计自动化 (EDA) 工具可以在将 RTL [代码转换](@entry_id:747446)为门级网表的过程中插入木马。验证流程中的漏洞（如不检查 DFT 逻辑）为木马提供了可乘之机。
    4.  **物理设计（布局布线）**：在物理设计阶段，攻击者可以通过工程变更指令 (ECO) 利用预留的备用[逻辑门](@entry_id:178011) (Spare Cells) 来构建木马电路，或修改布线以改变电路功能。

-   **制造与部署阶段（硅后）**：
    1.  **芯片代工厂 (Foundry)**：这是最危险的攻击环节之一。一个不值得信任的代工厂可以在制造过程中对芯片进行物理层面的修改。
    2.  **测试与封装**：虽然在测试阶段直接植入硬件逻辑很困难，但攻击者可以利用测试接口（如 JTAG）来激活预先植入的木马，或通过[熔断](@entry_id:751834) OTP (One-Time Programmable) 熔丝来永久改变芯片的配置以启用恶意功能。
    3.  **现场部署**：在最终产品中，通过恶意固件或软件更新，也可能激活芯片中休眠的硬件木马。

#### 不同抽象层次的攻击者能力

攻击者在不同阶段所能使用的技术和所面临的约束是不同的 ：

-   **RTL 层面**：攻击者拥有最大的灵活性，可以设计复杂的时序木马。但这些修改存在于源代码中，理论上可以通过严格的代码审查、[形式验证](@entry_id:149180)和属性检查来发现。

-   **门级网表层面**：攻击者可以直接操纵[逻辑门](@entry_id:178011)和连线。这种修改可以绕过 RTL 级别的检查，但通常会被逻辑[等价性检查](@entry_id:168767) (LEC) 捕获，因为LEC会逐点比较综合网表与黄金 RTL 设计的功能。

-   **物理版图层面**：攻击者可以修改走线、通孔或单元的摆放位置。如果这些修改没有改变电路的逻辑连接性，就可以通过版图与原理图对比 (LVS) 检查。然而，这些修改会改变线路的[寄生电容](@entry_id:270891)和电阻，从而引入参数退化型木马。这类木马可以通过精确的时序分析或[寄生参数提取](@entry_id:1129345)对比来检测。

-   **芯片代工厂层面：终极隐蔽**：代工厂层面的修改是最难被检测的。攻击者无需改变任何版图设计，而是直接在物理制造过程中修改晶体管的特性。一个典型的例子是**掺杂级木马 (Dopant-level Trojan)** 。通过修改离子注入的掩模，攻击者可以改变特定区域半导体的[掺杂浓度](@entry_id:272646)或类型。
    例如，通过将一个 NMOS 下拉管所在区域的 P 型衬底受主浓度 $N_A$ 从正常的 $10^{17}\,\mathrm{cm}^{-3}$ 增加到 $10^{18}\,\mathrm{cm}^{-3}$，可以显著提高该晶体管的阈值电压 $V_T$。根据 MOS 物理，阈值电压 $V_T$ 与 $N_A$ 正相关，具体的依赖关系为 $V_T = V_{FB} + 2\phi_F + \frac{\sqrt{2q\epsilon_s N_A(2\phi_F)}}{C_{ox}}$，其中费米势 $\phi_F$ 也随 $N_A$ 对数增加。计算表明，这样的掺杂修改足以将 $V_T$ 从正常工作电压以下（如 $0.73\,\mathrm{V}$）提升到工作电压以上（如 $1.08\,\mathrm{V}$）。其结果是，在正常的栅极电压（如 $0.8\,\mathrm{V}$）下，这个被篡改的晶体管将无法导通，导致其所在的[逻辑门](@entry_id:178011)功能失效（例如，一个反相器的输出无法被拉低）。
    更具破坏性的是，攻击者可以翻转源/漏区的掺杂极性（如将 $n^+$ 注入替换为 $p^+$ 注入）。这会彻底破坏晶体管的结构，使其变成一个永久关闭的开关或一个寄生二[极管](@entry_id:909477)。由于这些修改发生在原子层面，没有改变任何版图的几何形状，因此它们完全无法被 LVS 或[设计规则检查 (DRC)](@entry_id:1123589) 等标准的物理验证工具所发现，代表了[硬件木马](@entry_id:1125920)[隐蔽](@entry_id:196364)性的极致。