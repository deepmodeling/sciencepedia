{
    "hands_on_practices": [
        {
            "introduction": "要真正掌握一个算法，最好的方法之一就是亲手进行一次计算。本练习将引导你手动完成攀爬镜像微动弹性带（CI-NEB）方法中的一个核心步骤：对能量最高的“攀爬镜像”进行一次迭代更新。通过计算真实力在路径切向和法向上的分量，并施加攀爬力的修正，你将深刻理解CI-NEB方法如何精确地将一个镜像推向过渡态鞍点。",
            "id": "3437606",
            "problem": "考虑一个用作扩散势垒简化模型的二维势能面，由标量场 $V(x,y) = (x^{2} - 1)^{2} + y^{2}$ 定义，单位为电子伏特 (eV)。两个极小值点位于 $(-1,0)$ 和 $(1,0)$，由一个位于 $(0,0)$ 的一阶鞍点分隔。极小值点之间的一条离散路径由五个镜像 $\\{\\mathbf{r}_{0},\\mathbf{r}_{1},\\mathbf{r}_{2},\\mathbf{r}_{3},\\mathbf{r}_{4}\\}$ 表示，其固定端点为 $\\mathbf{r}_{0} = (-1,0)$ 和 $\\mathbf{r}_{4} = (1,0)$，当前的内部位置为\n$\\mathbf{r}_{1} = (-0.4, 0.2)$，$\\mathbf{r}_{2} = (0.0, 0.1)$ 和 $\\mathbf{r}_{3} = (0.3, -0.1)$。\n你将从第一性原理和核心定义出发，对能量最高的镜像执行一次攀爬镜像微动弹性带（Climbing-Image Nudged Elastic Band, CI-NEB）方法的迭代。\n\n假设以下建模前提：\n- 内部镜像 $i$ 处的路径切线是通过归一化连接其两个相邻镜像的弦得到的单位向量，$\\hat{\\boldsymbol{\\tau}}_{i} = \\dfrac{\\mathbf{r}_{i+1} - \\mathbf{r}_{i-1}}{\\lVert \\mathbf{r}_{i+1} - \\mathbf{r}_{i-1}\\rVert}$。\n- 由势能产生的真实力为 $-\\nabla V$。\n- 对于任意向量 $\\mathbf{A}$，其平行和垂直于单位方向 $\\hat{\\boldsymbol{\\tau}}$ 的分量由正交投影定义：$\\mathbf{A}^{\\parallel} = (\\mathbf{A}\\cdot \\hat{\\boldsymbol{\\tau}})\\hat{\\boldsymbol{\\tau}}$ 和 $\\mathbf{A}^{\\perp} = \\mathbf{A} - \\mathbf{A}^{\\parallel}$。\n\n将具有最高势能的内部镜像视为攀爬镜像。对于该镜像，构建真实力的平行和垂直分量，并应用与该方法定义一致的攀爬镜像修正。然后使用步长参数 $h = 0.5$ 对攀爬镜像执行一次显式欧拉位置更新：\n$\\mathbf{r}_{i}^{\\text{new}} = \\mathbf{r}_{i}^{\\text{old}} + h\\,\\mathbf{F}_{i}^{\\text{CI}}$，\n其中 $\\mathbf{F}_{i}^{\\text{CI}}$ 是你根据上述原理构建的总攀爬镜像力。\n\n从给定位置开始，对能量最高的镜像 $i$ 执行以下步骤：\n1. 通过计算内部镜像的 $V(\\mathbf{r}_{i})$ 来确定攀爬镜像的索引 $i$。\n2. 根据其相邻镜像计算切线 $\\hat{\\boldsymbol{\\tau}}_{i}$。\n3. 在 $\\mathbf{r}_{i}$ 处计算梯度 $\\nabla V$，然后使用上述投影定义将真实力 $-\\nabla V$ 分解为 $\\mathbf{F}_{i}^{\\parallel}$ 和 $\\mathbf{F}_{i}^{\\perp}$。\n4. 根据攀爬镜像修正，为该镜像构建攀爬镜像力 $\\mathbf{F}_{i}^{\\text{CI}}$。\n5. 使用给定的欧拉步长更新攀爬镜像的位置。\n6. 计算更新后的能量 $V(\\mathbf{r}_{i}^{\\text{new}})$。\n\n报告攀爬镜像更新后的能量 $V(\\mathbf{r}_{i}^{\\text{new}})$（单位：eV）作为你的最终答案。将答案四舍五入到四位有效数字。以 eV 表示最终能量。",
            "solution": "在尝试解答之前，对问题进行验证。\n\n### 步骤 1：提取已知条件\n-   势能面：$V(x,y) = (x^{2} - 1)^{2} + y^{2}$，单位为电子伏特 (eV)。\n-   离散路径镜像：$\\{\\mathbf{r}_{0},\\mathbf{r}_{1},\\mathbf{r}_{2},\\mathbf{r}_{3},\\mathbf{r}_{4}\\}$。\n-   固定端点：$\\mathbf{r}_{0} = (-1,0)$，$\\mathbf{r}_{4} = (1,0)$。\n-   内部镜像位置：$\\mathbf{r}_{1} = (-0.4, 0.2)$，$\\mathbf{r}_{2} = (0.0, 0.1)$，$\\mathbf{r}_{3} = (0.3, -0.1)$。\n-   路径切线定义：$\\hat{\\boldsymbol{\\tau}}_{i} = \\dfrac{\\mathbf{r}_{i+1} - \\mathbf{r}_{i-1}}{\\lVert \\mathbf{r}_{i+1} - \\mathbf{r}_{i-1}\\rVert}$。\n-   真实力定义：$-\\nabla V$。\n-   力的分量定义：$\\mathbf{A}^{\\parallel} = (\\mathbf{A}\\cdot \\hat{\\boldsymbol{\\tau}})\\hat{\\boldsymbol{\\tau}}$ 和 $\\mathbf{A}^{\\perp} = \\mathbf{A} - \\mathbf{A}^{\\parallel}$。\n-   攀爬镜像识别：具有最高势能的内部镜像。\n-   位置更新规则：$\\mathbf{r}_{i}^{\\text{new}} = \\mathbf{r}_{i}^{\\text{old}} + h\\,\\mathbf{F}_{i}^{\\text{CI}}$。\n-   步长参数：$h = 0.5$。\n-   目标：计算攀爬镜像更新后的能量 $V(\\mathbf{r}_{i}^{\\text{new}})$，四舍五入到四位有效数字。\n\n### 步骤 2：使用提取的已知条件进行验证\n-   **科学依据**：该问题描述了攀爬镜像微动弹性带（CI-NEB）方法，这是一种在计算化学和材料科学中用于寻找过渡态的标准且广泛使用的算法。势能 $V(x,y)$ 是一个经典的双阱势，是此类问题的常用模型系统。切线、力以及更新规则的定义与 CI-NEB 方法的既定公式一致。该问题在科学上是合理的。\n-   **适定性**：所有必要信息均已提供：势函数、所有镜像的初始坐标、所有计算量（切线、力）的定义以及更新步骤的参数（$h$）。目标陈述清晰，并且可以用给定数据实现。问题是自洽且无歧义的。\n-   **客观性**：问题使用精确的数学语言表述，不含主观或基于观点的陈述。\n\n### 步骤 3：结论与行动\n该问题被视为**有效**。将按照规定的步骤提供解答。\n\n解答过程遵循问题陈述中概述的六个步骤。\n\n**1. 确定攀爬镜像**\n计算每个内部镜像 $\\mathbf{r}_i = (x_i, y_i)$ 的势能 $V(\\mathbf{r}_i)$。\n势能函数为 $V(x,y) = (x^{2} - 1)^{2} + y^{2}$。\n\n对于镜像 $\\mathbf{r}_{1} = (-0.4, 0.2)$：\n$$V(\\mathbf{r}_{1}) = ((-0.4)^{2} - 1)^{2} + (0.2)^{2} = (0.16 - 1)^{2} + 0.04 = (-0.84)^{2} + 0.04 = 0.7056 + 0.04 = 0.7456 \\, \\text{eV}$$\n\n对于镜像 $\\mathbf{r}_{2} = (0.0, 0.1)$：\n$$V(\\mathbf{r}_{2}) = ((0.0)^{2} - 1)^{2} + (0.1)^{2} = (-1)^{2} + 0.01 = 1 + 0.01 = 1.01 \\, \\text{eV}$$\n\n对于镜像 $\\mathbf{r}_{3} = (0.3, -0.1)$：\n$$V(\\mathbf{r}_{3}) = ((0.3)^{2} - 1)^{2} + (-0.1)^{2} = (0.09 - 1)^{2} + 0.01 = (-0.91)^{2} + 0.01 = 0.8281 + 0.01 = 0.8381 \\, \\text{eV}$$\n\n比较这些能量，$V(\\mathbf{r}_2) > V(\\mathbf{r}_3) > V(\\mathbf{r}_1)$。势能最高的镜像是 $\\mathbf{r}_{2}$。因此，攀爬镜像是镜像 $i=2$。\n\n**2. 计算切线 $\\hat{\\boldsymbol{\\tau}}_{2}$**\n$\\mathbf{r}_2$ 处的切线由其相邻镜像 $\\mathbf{r}_1$ 和 $\\mathbf{r}_3$ 决定。\n$$\\mathbf{r}_{3} - \\mathbf{r}_{1} = (0.3 - (-0.4), -0.1 - 0.2) = (0.7, -0.3)$$\n该向量的范数为：\n$$\\lVert \\mathbf{r}_{3} - \\mathbf{r}_{1} \\rVert = \\sqrt{(0.7)^{2} + (-0.3)^{2}} = \\sqrt{0.49 + 0.09} = \\sqrt{0.58}$$\n单位切向量为：\n$$\\hat{\\boldsymbol{\\tau}}_{2} = \\frac{\\mathbf{r}_{3} - \\mathbf{r}_{1}}{\\lVert \\mathbf{r}_{3} - \\mathbf{r}_{1} \\rVert} = \\frac{1}{\\sqrt{0.58}}(0.7, -0.3)$$\n\n**3. 计算梯度并分解真实力**\n势能 $V(x,y) = (x^2-1)^2+y^2 = x^4-2x^2+1+y^2$ 的梯度为：\n$$\\nabla V = \\left( \\frac{\\partial V}{\\partial x}, \\frac{\\partial V}{\\partial y} \\right) = (4x^{3} - 4x, 2y)$$\n在攀爬镜像的位置 $\\mathbf{r}_{2} = (0.0, 0.1)$ 处：\n$$\\nabla V |_{\\mathbf{r}_2} = (4(0.0)^{3} - 4(0.0), 2(0.1)) = (0, 0.2)$$\n真实力为 $\\mathbf{F}_{\\text{true}} = -\\nabla V |_{\\mathbf{r}_2}$：\n$$\\mathbf{F}_{\\text{true}} = (0, -0.2)$$\n该力被分解为平行于（$\\mathbf{F}_{2}^{\\parallel}$）和垂直于（$\\mathbf{F}_{2}^{\\perp}$）切线 $\\hat{\\boldsymbol{\\tau}}_{2}$ 的分量。\n点积为：\n$$\\mathbf{F}_{\\text{true}} \\cdot \\hat{\\boldsymbol{\\tau}}_{2} = (0, -0.2) \\cdot \\frac{1}{\\sqrt{0.58}}(0.7, -0.3) = \\frac{1}{\\sqrt{0.58}} [0 \\cdot (0.7) + (-0.2) \\cdot (-0.3)] = \\frac{0.06}{\\sqrt{0.58}}$$\n平行力向量为：\n$$\\mathbf{F}_{2}^{\\parallel} = (\\mathbf{F}_{\\text{true}} \\cdot \\hat{\\boldsymbol{\\tau}}_{2}) \\hat{\\boldsymbol{\\tau}}_{2} = \\left(\\frac{0.06}{\\sqrt{0.58}}\\right) \\left(\\frac{1}{\\sqrt{0.58}}(0.7, -0.3)\\right) = \\frac{0.06}{0.58}(0.7, -0.3) = \\frac{3}{29}(0.7, -0.3)$$\n$$\\mathbf{F}_{2}^{\\parallel} = \\left(\\frac{2.1}{29}, -\\frac{0.9}{29}\\right)$$\n\n**4. 构建攀爬镜像力 $\\mathbf{F}_{2}^{\\text{CI}}$**\n对于攀爬镜像，力被修正以移除沿切线方向的弹簧力分量，并反转沿切线方向的真实力分量，从而推动镜像沿势能面朝鞍点攀升。\n$$\\mathbf{F}_{2}^{\\text{CI}} = \\mathbf{F}_{\\text{true}} - 2 \\mathbf{F}_{2}^{\\parallel} = (0, -0.2) - 2 \\left(\\frac{2.1}{29}, -\\frac{0.9}{29}\\right) = (0, -0.2) - \\left(\\frac{4.2}{29}, -\\frac{1.8}{29}\\right)$$\n$$\\mathbf{F}_{2}^{\\text{CI}} = \\left(-\\frac{4.2}{29}, -0.2 + \\frac{1.8}{29}\\right) = \\left(-\\frac{4.2}{29}, -\\frac{5.8}{29} + \\frac{1.8}{29}\\right) = \\left(-\\frac{4.2}{29}, -\\frac{4.0}{29}\\right)$$\n\n**5. 更新攀爬镜像的位置**\n使用 $h=0.5$ 的显式欧拉步长更新位置。\n$$\\mathbf{r}_{2}^{\\text{new}} = \\mathbf{r}_{2}^{\\text{old}} + h\\,\\mathbf{F}_{2}^{\\text{CI}}$$\n$$\\mathbf{r}_{2}^{\\text{new}} = (0.0, 0.1) + 0.5 \\left(-\\frac{4.2}{29}, -\\frac{4.0}{29}\\right) = (0, 0.1) + \\left(-\\frac{2.1}{29}, -\\frac{2.0}{29}\\right)$$\n新坐标为：\n$$x_{2}^{\\text{new}} = -\\frac{2.1}{29}$$\n$$y_{2}^{\\text{new}} = 0.1 - \\frac{2.0}{29} = \\frac{1}{10} - \\frac{2}{29} = \\frac{29 - 20}{290} = \\frac{9}{290}$$\n因此，新位置为 $\\mathbf{r}_{2}^{\\text{new}} = \\left(-\\frac{2.1}{29}, \\frac{9}{290}\\right)$。\n\n**6. 计算更新后的能量 $V(\\mathbf{r}_{2}^{\\text{new}})$**\n计算新位置处的能量：\n$$V(\\mathbf{r}_{2}^{\\text{new}}) = \\left( \\left(x_{2}^{\\text{new}}\\right)^{2} - 1 \\right)^{2} + \\left(y_{2}^{\\text{new}}\\right)^{2}$$\n$$V(\\mathbf{r}_{2}^{\\text{new}}) = \\left( \\left(-\\frac{2.1}{29}\\right)^{2} - 1 \\right)^{2} + \\left(\\frac{9}{290}\\right)^{2}$$\n数值计算各项：\n$$x_{2}^{\\text{new}} = -\\frac{2.1}{29} \\approx -0.07241379$$\n$$y_{2}^{\\text{new}} = \\frac{9}{290} \\approx 0.03103448$$\n$$V(\\mathbf{r}_{2}^{\\text{new}}) \\approx ((-0.07241379)^{2} - 1)^{2} + (0.03103448)^{2}$$\n$$V(\\mathbf{r}_{2}^{\\text{new}}) \\approx (0.00524376 - 1)^{2} + 0.00096314$$\n$$V(\\mathbf{r}_{2}^{\\text{new}}) \\approx (-0.99475624)^{2} + 0.00096314$$\n$$V(\\mathbf{r}_{2}^{\\text{new}}) \\approx 0.98954002 + 0.00096314 = 0.99050316 \\, \\text{eV}$$\n将结果四舍五入到四位有效数字得到 $0.9905$。",
            "answer": "$$\n\\boxed{0.9905}\n$$"
        },
        {
            "introduction": "微动弹性带方法的精度在很大程度上取决于对反应路径切线的稳定定义。本练习探讨了一个常见的数值陷阱：当路径在能量高点附近出现“尖角”时，朴素的切线定义可能导致计算不稳定。你将通过计算来比较不同切线定义的表现，并理解引入能量加权的切线如何提供一个更鲁棒的估计，从而避免振荡并改善收敛性。",
            "id": "3845749",
            "problem": "在微动弹性带 (Nudged Elastic Band, NEB) 方法及其爬山镜像优化 (Climbing-Image Nudged Elastic Band, CI-NEB) 的背景下，考虑势能面上的一个离散路径。三个连续的镜像位于位置 $\\mathbf{R}_{i-1}$、$\\mathbf{R}_{i}$、$\\mathbf{R}_{i+1}$，其相关能量为 $E_{i-1}$、$E_{i}$、$E_{i+1}$。在 NEB 和 CI-NEB 中，每个镜像上的力被分解为平行于和垂直于沿离散路径的切线方向 $\\hat{\\tau}_{i}$ 的分量。在尖锐拐角处（相邻路径段之间方向变化较大），不当的切线定义可能导致错误的力分解。\n\n给定以下旨在在镜像 $i$ 处产生一个尖锐拐角的特定构型：\n- 二维位置：$\\mathbf{R}_{i-1} = (1, 2)$，$\\mathbf{R}_{i} = (3, 1)$，$\\mathbf{R}_{i+1} = (4, 3)$。\n- 能量：$E_{i-1} = 0.38\\,\\mathrm{eV}$，$E_{i} = 0.55\\,\\mathrm{eV}$，$E_{i+1} = 0.52\\,\\mathrm{eV}$。\n\n将前向差分矢量定义为 $\\Delta \\mathbf{R}_{i}^{+} = \\mathbf{R}_{i+1} - \\mathbf{R}_{i}$，后向差分矢量定义为 $\\Delta \\mathbf{R}_{i}^{-} = \\mathbf{R}_{i} - \\mathbf{R}_{i-1}$。令相应的单位切线为 $\\hat{\\tau}_{i}^{+} = \\Delta \\mathbf{R}_{i}^{+} / \\|\\Delta \\mathbf{R}_{i}^{+}\\|$ 和 $\\hat{\\tau}_{i}^{-} = \\Delta \\mathbf{R}_{i}^{-} / \\|\\Delta \\mathbf{R}_{i}^{-}\\|$.\n\n首先，计算 $\\hat{\\tau}_{i}^{+}$ 和 $\\hat{\\tau}_{i}^{-}$ 之间的夹角 $\\theta_{\\mathrm{fb}}$。\n\n接下来，通过对前向和后向单位切线进行归一化线性组合，在拐角镜像 $i$ 处构造一个能量加权切线。其权重与到相邻镜像的绝对能量差成正比：\n- $w^{+} = |E_{i+1} - E_{i}|$，\n- $w^{-} = |E_{i-1} - E_{i}|$，\n并定义未归一化的加权切线矢量 $\\mathbf{t}_{w} = w^{+}\\,\\hat{\\tau}_{i}^{+} + w^{-}\\,\\hat{\\tau}_{i}^{-}$ 和相应的单位矢量 $\\hat{\\tau}_{w} = \\mathbf{t}_{w} / \\|\\mathbf{t}_{w}\\|$.\n\n使用此能量加权切线，计算 $\\hat{\\tau}_{w}$ 和 $\\hat{\\tau}_{i}^{-}$ 之间的夹角 $\\theta_{w-}$。将角度减小量 $\\Delta \\theta = \\theta_{\\mathrm{fb}} - \\theta_{w-}$ 解释为能量加权对用于 NEB 力分解的切线方向引入的平滑度的定量度量。\n\n您的任务是为给定的构型提供标量值 $\\Delta \\theta$。最终结果以弧度表示，并四舍五入到四位有效数字。请清楚地陈述从离散切线和能量加权的基本定义到最终 $\\Delta \\theta$ 的推导步骤。",
            "solution": "微动弹性带 (Nudged Elastic Band, NEB) 方法及其爬山镜像优化 (Climbing-Image Nudged Elastic Band, CI-NEB) 通过弛豫一组由弹簧连接的离散镜像来计算势能面上的最小能量路径。镜像 $i$ 上的力被分解为垂直于和平行于切线 $\\hat{\\tau}_{i}$ 的分量，该切线近似于局部路径方向。在尖锐拐角处，使用一个朴素的切线可能导致力的错误投影；能量加权切线通过将切线偏向极值点附近能量较高的路径段来缓解此问题，从而提供一个更平滑且物理上一致的方向。\n\n我们从离散前向和后向差分切线的基本定义开始。对于给定的位置，\n\n$$\n\\Delta \\mathbf{R}_{i}^{+} = \\mathbf{R}_{i+1} - \\mathbf{R}_{i} = (4, 3) - (3, 1) = (1, 2),\n$$\n\n\n$$\n\\Delta \\mathbf{R}_{i}^{-} = \\mathbf{R}_{i} - \\mathbf{R}_{i-1} = (3, 1) - (1, 2) = (2, -1).\n$$\n\n它们的模为\n\n$$\n\\|\\Delta \\mathbf{R}_{i}^{+}\\| = \\sqrt{1^{2} + 2^{2}} = \\sqrt{5}, \\quad \\|\\Delta \\mathbf{R}_{i}^{-}\\| = \\sqrt{2^{2} + (-1)^{2}} = \\sqrt{5}.\n$$\n\n因此，单位切线为\n\n$$\n\\hat{\\tau}_{i}^{+} = \\frac{(1, 2)}{\\sqrt{5}}, \\quad \\hat{\\tau}_{i}^{-} = \\frac{(2, -1)}{\\sqrt{5}}.\n$$\n\n$\\hat{\\tau}_{i}^{+}$ 和 $\\hat{\\tau}_{i}^{-}$ 之间的夹角 $\\theta_{\\mathrm{fb}}$ 可由点积公式得出\n\n$$\n\\hat{\\tau}_{i}^{+} \\cdot \\hat{\\tau}_{i}^{-} = \\|\\hat{\\tau}_{i}^{+}\\|\\,\\|\\hat{\\tau}_{i}^{-}\\|\\,\\cos(\\theta_{\\mathrm{fb}}) = \\cos(\\theta_{\\mathrm{fb}}).\n$$\n\n计算点积：\n\n$$\n\\hat{\\tau}_{i}^{+} \\cdot \\hat{\\tau}_{i}^{-} = \\frac{1}{\\sqrt{5}}\\frac{2}{\\sqrt{5}} + \\frac{2}{\\sqrt{5}}\\frac{(-1)}{\\sqrt{5}} = \\frac{2 - 2}{5} = 0,\n$$\n\n所以\n\n$$\n\\cos(\\theta_{\\mathrm{fb}}) = 0 \\quad \\Rightarrow \\quad \\theta_{\\mathrm{fb}} = \\frac{\\pi}{2}.\n$$\n\n这证实了在前向和后向离散切线之间存在一个直角的尖锐拐角。\n\n我们现在推导能量加权切线。能量值为\n\n$$\nE_{i-1} = 0.38\\,\\mathrm{eV}, \\quad E_{i} = 0.55\\,\\mathrm{eV}, \\quad E_{i+1} = 0.52\\,\\mathrm{eV}.\n$$\n\n绝对能量差为\n\n$$\nw^{+} = |E_{i+1} - E_{i}| = |0.52 - 0.55| = 0.03,\n$$\n\n\n$$\nw^{-} = |E_{i-1} - E_{i}| = |0.38 - 0.55| = 0.17.\n$$\n\n定义未归一化的加权切线矢量\n\n$$\n\\mathbf{t}_{w} = w^{+}\\,\\hat{\\tau}_{i}^{+} + w^{-}\\,\\hat{\\tau}_{i}^{-}.\n$$\n\n因为 $\\hat{\\tau}_{i}^{+}$ 和 $\\hat{\\tau}_{i}^{-}$ 是单位矢量且相互正交（如它们的点积为零所示），所以 $\\mathbf{t}_{w}$ 的模为\n\n$$\n\\|\\mathbf{t}_{w}\\| = \\sqrt{(w^{+})^{2}\\|\\hat{\\tau}_{i}^{+}\\|^{2} + (w^{-})^{2}\\|\\hat{\\tau}_{i}^{-}\\|^{2}} = \\sqrt{(w^{+})^{2} + (w^{-})^{2}} = \\sqrt{0.03^{2} + 0.17^{2}} = \\sqrt{0.0298}.\n$$\n\n则单位能量加权切线为\n\n$$\n\\hat{\\tau}_{w} = \\frac{\\mathbf{t}_{w}}{\\|\\mathbf{t}_{w}\\|}.\n$$\n\n我们求解 $\\hat{\\tau}_{w}$ 和 $\\hat{\\tau}_{i}^{-}$ 之间的夹角 $\\theta_{w-}$。使用点积，\n\n$$\n\\cos(\\theta_{w-}) = \\hat{\\tau}_{w} \\cdot \\hat{\\tau}_{i}^{-} = \\frac{\\mathbf{t}_{w}}{\\|\\mathbf{t}_{w}\\|} \\cdot \\hat{\\tau}_{i}^{-} = \\frac{w^{+}(\\hat{\\tau}_{i}^{+} \\cdot \\hat{\\tau}_{i}^{-}) + w^{-}(\\hat{\\tau}_{i}^{-} \\cdot \\hat{\\tau}_{i}^{-})}{\\|\\mathbf{t}_{w}\\|}.\n$$\n\n由于 $\\hat{\\tau}_{i}^{+} \\cdot \\hat{\\tau}_{i}^{-} = 0$ 且 $\\hat{\\tau}_{i}^{-} \\cdot \\hat{\\tau}_{i}^{-} = 1$，此式可简化为\n\n$$\n\\cos(\\theta_{w-}) = \\frac{w^{-}}{\\sqrt{(w^{+})^{2} + (w^{-})^{2}}}.\n$$\n\n等价地，利用正交性，该角度可以表示为\n\n$$\n\\theta_{w-} = \\arctan\\!\\left(\\frac{w^{+}}{w^{-}}\\right) = \\arctan\\!\\left(\\frac{0.03}{0.17}\\right) = \\arctan\\!\\left(\\frac{3}{17}\\right).\n$$\n\n这个表达式的由来是，$\\mathbf{t}_{w}$ 可以在标准正交基 $\\{\\hat{\\tau}_{i}^{-}, \\hat{\\tau}_{i}^{+}\\}$ 中表示为分量 $(w^{-}, w^{+})$，因此与 $\\hat{\\tau}_{i}^{-}$ 轴的夹角为 $\\arctan(w^{+}/w^{-})$。\n\n由能量加权引起的角度减小量，它量化了用于力分解的切线方向上的平滑度，为\n\n$$\n\\Delta \\theta = \\theta_{\\mathrm{fb}} - \\theta_{w-} = \\frac{\\pi}{2} - \\arctan\\!\\left(\\frac{3}{17}\\right).\n$$\n\n我们现在对此量进行数值计算，并以弧度为单位四舍五入到四位有效数字。首先，计算\n\n$$\n\\arctan\\!\\left(\\frac{3}{17}\\right) \\approx 0.1746731751\\,\\text{rad},\n$$\n\n所以\n\n$$\n\\Delta \\theta \\approx \\frac{\\pi}{2} - 0.1746731751 \\approx 1.3961231517\\,\\text{rad}.\n$$\n\n四舍五入到四位有效数字，所求值为\n\n$$\n\\Delta \\theta \\approx 1.396\\,\\text{rad}.\n$$\n\n这表明能量加权切线将拐角角度从 $\\pi/2$ 大幅减小到相对于主导路径段（偏向能量差较大的一侧）的一个小角度，从而平滑了 CI-NEB 力分解中使用的切线方向。",
            "answer": "$$\\boxed{1.396}$$"
        },
        {
            "introduction": "在掌握了算法的核心机制和数值细节之后，我们将目光转向实际应用中的计算性能。真实的CI-NEB计算通常非常耗时，必须借助并行计算来完成。本练习要求你分析在多个处理器之间分发反应路径上各个像点的不同策略，并量化其带来的通信开销，这是进行高效大规模模拟时需要考量的关键因素。",
            "id": "3845801",
            "problem": "考虑在微动弹性带 (NEB) 方法及其变体爬山镜像微动弹性带 (CI-NEB) 中的一个离散化过渡路径，其中路径由一系列镜像（构型）$\\{\\mathbf{r}_i\\}_{i=0}^{N-1}$ 表示，其中 $N \\geq 2$，端点 $i=0$ 和 $i=N-1$ 固定，内部镜像为 $i \\in \\{1,\\dots,N-2\\}$。每个镜像 $i$ 有一个位置向量 $\\mathbf{r}_i \\in \\mathbb{R}^d$，具有 $d \\geq 1$ 个自由度，以及一个标量能量 $E_i \\in \\mathbb{R}$。镜像 $i$ 的弹簧力取决于其邻居 $\\mathbf{r}_{i-1}$ 和 $\\mathbf{r}_{i+1}$ 的位置，而镜像 $i$ 处的切线取决于相邻能量 $E_{i-1}$ 和 $E_{i+1}$ 的相对顺序。在爬山镜像微动弹性带 (CI-NEB) 方法中，能量最高的镜像会修改其力的投影，但计算弹簧力和切线时对相邻镜像的数据依赖性保持局部性，并仅限于最近邻。\n\n假设一个具有 $P \\geq 1$ 个计算节点的分布式内存并行计算环境，以及一个分配映射 $a:\\{0,\\dots,N-1\\} \\rightarrow \\{0,\\dots,P-1\\}$，该映射将每个镜像索引 $i$ 映射到拥有它的节点 $a(i)$。仅当 $a(j) \\neq a(j+1)$ 且 $j$ 或 $j+1$ 中至少有一个是内部镜像索引时，才需要在相邻镜像边界 $(j,j+1)$（其中 $j \\in \\{0,\\dots,N-2\\}$）上进行通信。对于 $N \\leq 2$ 的情况，没有内部镜像，因此不需要通信。对于 $N \\geq 3$ 的情况，每个相邻边界 $(j,j+1)$ 都至少接触一个内部镜像，因此任何跨节点的邻接都需要通信。\n\n我们考虑两种镜像分布方案：\n\n- 连续块，记为 $\\mathcal{D}_\\text{contig}$：将索引集 $\\{0,\\dots,N-1\\}$ 划分为 $K=\\min(P,N)$ 个连续的、大小近似相等的块，并将块 $k$ 分配给节点 $k$，其中 $k \\in \\{0,\\dots,K-1\\}$。所有镜像都恰好属于一个块，并且这些块连续地覆盖整个链而没有重叠。\n\n- 轮询，记为 $\\mathcal{D}_\\text{rr}$：对于所有 $i \\in \\{0,\\dots,N-1\\}$，分配 $a(i)=i \\bmod P$。\n\n假设每次迭代进行一次最近邻幽灵交换，即对于每个跨节点的相邻边界 $(j,j+1)$，在每个方向上发送一条消息，其中包含邻居为其内部镜像评估弹簧力和切线所需的最小负载。假设每条消息的负载包括邻居的位置向量 $\\mathbf{r}$ 和标量能量 $E$，均以双精度表示。每条消息的负载大小为 $B_\\text{msg}=8(d+1)$ 字节，因为 $d$ 个位置分量和标量能量中的每一个都是 $8$ 字节的双精度数。忽略报头和协议开销，每次迭代的总消息数为 $M=2C$，其中 $C$ 是至少接触一个内部镜像的跨节点相邻边界的数量。则每次迭代的总字节数为 $B = M \\cdot B_\\text{msg} = 2C \\cdot 8(d+1)$。\n\n您的任务是实现一个程序，为下面的每个测试用例计算：\n- 整数 $C$，即上文定义的需要通信的跨节点相邻边界的数量。\n- 整数 $M=2C$，即每次迭代的半双工消息数量。\n- 整数 $B=2C \\cdot 8(d+1)$，即每次迭代通信的总字节数。\n\n需要实现的分布方案细节：\n- 对于 $\\mathcal{D}_\\text{contig}$：令 $K=\\min(P,N)$，并令 $q=\\left\\lfloor \\frac{N}{K} \\right\\rfloor$ 和 $r=N \\bmod K$。前 $r$ 个节点接收 $q+1$ 个连续镜像，其余 $K-r$ 个节点接收 $q$ 个连续镜像，从而形成 $\\{0,\\dots,N-1\\}$ 的一个连续分区。\n- 对于 $\\mathcal{D}_\\text{rr}$：对于所有 $i$，令 $a(i)=i \\bmod P$。\n\n通信计数规则：\n- 如果 $N \\leq 2$，则设 $C=0$。\n- 如果 $N \\geq 3$，则设 $C$ 为满足 $a(j) \\neq a(j+1)$ 的索引 $j \\in \\{0,\\dots,N-2\\}$ 的数量。\n\n测试套件参数集 $(N,P,d,\\text{scheme})$：\n1. $(16,4,3,\\mathcal{D}_\\text{contig})$。\n2. $(16,4,3,\\mathcal{D}_\\text{rr})$。\n3. $(5,10,2,\\mathcal{D}_\\text{contig})$。\n4. $(2,5,3,\\mathcal{D}_\\text{rr})$。\n5. $(64,1,6,\\mathcal{D}_\\text{contig})$。\n\n最终输出格式：\n您的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每个测试用例的结果是一个包含三个整数 $[C,M,B]$ 的列表，顺序与测试套件相同。例如，包含两个用例的输出将如下所示：$[[C_1,M_1,B_1],[C_2,M_2,B_2]]$。",
            "solution": "用户旨在确定在两种不同的数据分布方案下，爬山镜像微动弹性带 (CI-NEB) 方法并行实现的通信成本，以跨节点边界数 $C$、消息数 $M$ 和传输的总字节数 $B$ 来衡量。该问题定义明确，并基于高性能科学计算的标准实践。\n\n过渡路径被离散化为 $N$ 个镜像，索引从 $i=0$ 到 $i=N-1$。这些镜像分布在 $P$ 个计算节点上。镜像 $i$ 到节点的分配由映射 $a(i) \\in \\{0, \\dots, P-1\\}$ 给出。每个镜像的自由度由 $d$ 给出。\n\n所需的通信指标定义如下：\n- $C$：跨节点相邻边界的数量。问题规定，对于 $N \\leq 2$，没有内部镜像，因此 $C=0$。对于 $N \\geq 3$，每个边界 $(j, j+1)$（其中 $j \\in \\{0, \\dots, N-2\\}$）都与至少一个内部镜像相邻，因此当且仅当相邻镜像位于不同节点上时才需要通信。因此，对于 $N \\geq 3$，$C$ 是满足 $a(j) \\neq a(j+1)$ 的索引 $j \\in \\{0, \\dots, N-2\\}$ 的数量。\n- $M$：每次迭代的总消息数。由于每个跨节点边界都需要进行一次幽灵交换（每个方向一条消息），所以 $M = 2C$。\n- $B$：每次迭代通信的总字节数。每条消息的负载包括一个位置向量 $\\mathbf{r}_i \\in \\mathbb{R}^d$ 和一个标量能量 $E_i \\in \\mathbb{R}$，两者都表示为 $8$ 字节的双精度数。每条消息的大小为 $B_{\\text{msg}} = 8(d+1)$ 字节。总字节数为 $B = M \\cdot B_{\\text{msg}} = 2C \\cdot 8(d+1) = 16C(d+1)$。\n\n我们现在将为每种分布方案推导 $C$ 的公式。\n\n**1. 连续块分布 ($\\mathcal{D}_\\text{contig}$)**\n\n在此方案中，$N$ 个镜像被划分为 $K = \\min(P, N)$ 个连续块。前 $K$ 个节点（索引为 $0, \\dots, K-1$）各自接收一个块。如果 $P  N$，剩余的 $P-K$ 个节点处于空闲状态。\n分配映射 $a(i)$ 是分段常数，仅在两个连续块之间的边界处改变其值。共有 $K$ 个块，因此它们之间有 $K-1$ 个边界。这些边界中的每一个都分隔了分配给不同节点（例如节点 $k$ 和节点 $k+1$）的镜像。\n因此，跨节点边界数 $C$ 就是块边界的数量。\n- 如果 $K=1$（当 $P=1$ 或 $N \\leq 1$ 时发生），所有镜像都在单个节点上，没有块边界，所以 $C = 1-1=0$。\n- 如果 $K  1$，则有 $K-1$ 个边界。\n\n结合关于 $N$ 的一般规则：\n- 如果 $N \\leq 2$，$C=0$。\n- 如果 $N \\geq 3$，$C = K-1 = \\min(P, N) - 1$。\n注意，对于 $N=2$，该公式给出 $\\min(P,2)-1$，如果 $P \\geq 2$ 则可能为 $1$。所以我们必须严格遵守 $N \\le 2$ 时 $C=0$ 的规则。推导出的公式 $C = \\min(P,N)-1$ 仅对 $N \\geq 3$ 有效。\n\n**2. 轮询分布 ($\\mathcal{D}_\\text{rr}$)**\n\n在此方案中，分配映射由 $a(i) = i \\bmod P$ 给出。我们需要计算满足 $a(j) \\neq a(j+1)$ 的索引 $j \\in \\{0, \\dots, N-2\\}$ 的数量。\n这等同于计算满足 $j \\bmod P \\neq (j+1) \\bmod P$ 的 $j$ 的数量。\n\n- 情况 $P=1$：对于任何镜像 $i$，$a(i) = i \\bmod 1 = 0$。所有镜像都分配给节点 $0$。因此，对于所有 $j$，$a(j) = a(j+1)$，且 $C=0$。\n\n- 情况 $P1$：让我们考虑何时 $j \\bmod P = (j+1) \\bmod P$。假设这个共同值为 $k$。这意味着对于某些整数 $q_1, q_2$，$j = q_1 P + k$ 和 $j+1 = q_2 P + k$。从第二个方程中减去第一个方程得到 $1 = (q_2 - q_1)P$。由于 $P$ 是大于 $1$ 的整数，此方程没有整数解 $(q_2-q_1)$。因此，对于 $P1$，$j \\bmod P \\neq (j+1) \\bmod P$ 总是成立的。\n这意味着对于 $P1$，每对相邻的镜像 $(i, i+1)$ 都被分配到不同的节点对上。\n跨节点边界数 $C$ 是镜像之间相邻边界的总数，即 $N-1$。\n\n结合关于 $N$ 的一般规则：\n- 如果 $N \\leq 2$，$C=0$。\n- 如果 $N \\geq 3$：\n    - 如果 $P=1$，$C=0$。\n    - 如果 $P1$，$C=N-1$。\n\n我们现在将这些推导出的公式应用于每个测试用例。\n\n**测试用例 1：$(N,P,d,\\text{scheme}) = (16, 4, 3, \\mathcal{D}_\\text{contig})$**\n- $N=16$, $P=4$, $d=3$。由于 $N=16 \\geq 3$，我们应用 $\\mathcal{D}_\\text{contig}$ 的公式：\n- $C = \\min(P, N) - 1 = \\min(4, 16) - 1 = 4 - 1 = 3$。\n- $M = 2C = 2 \\cdot 3 = 6$。\n- $B = 16 C (d+1) = 16 \\cdot 3 \\cdot (3+1) = 48 \\cdot 4 = 192$。\n- 结果：$[3, 6, 192]$。\n\n**测试用例 2：$(N,P,d,\\text{scheme}) = (16, 4, 3, \\mathcal{D}_\\text{rr})$**\n- $N=16$, $P=4$, $d=3$。由于 $N=16 \\geq 3$ 且 $P=4  1$，我们应用 $\\mathcal{D}_\\text{rr}$ 的公式：\n- $C = N - 1 = 16 - 1 = 15$。\n- $M = 2C = 2 \\cdot 15 = 30$。\n- $B = 16 C (d+1) = 16 \\cdot 15 \\cdot (3+1) = 240 \\cdot 4 = 960$。\n- 结果：$[15, 30, 960]$。\n\n**测试用例 3：$(N,P,d,\\text{scheme}) = (5, 10, 2, \\mathcal{D}_\\text{contig})$**\n- $N=5$, $P=10$, $d=2$。由于 $N=5 \\geq 3$，我们应用 $\\mathcal{D}_\\text{contig}$ 的公式：\n- $C = \\min(P, N) - 1 = \\min(10, 5) - 1 = 5 - 1 = 4$。\n- $M = 2C = 2 \\cdot 4 = 8$。\n- $B = 16 C (d+1) = 16 \\cdot 4 \\cdot (2+1) = 64 \\cdot 3 = 192$。\n- 结果：$[4, 8, 192]$。\n\n**测试用例 4：$(N,P,d,\\text{scheme}) = (2, 5, 3, \\mathcal{D}_\\text{rr})$**\n- $N=2$, $P=5$, $d=3$。由于 $N=2 \\leq 2$，规则规定不需要通信。\n- $C = 0$。\n- $M = 0$。\n- $B = 0$。\n- 结果：$[0, 0, 0]$。\n\n**测试用例 5：$(N,P,d,\\text{scheme}) = (64, 1, 6, \\mathcal{D}_\\text{contig})$**\n- $N=64$, $P=1$, $d=6$。由于 $N=64 \\geq 3$，我们应用 $\\mathcal{D}_\\text{contig}$ 的公式：\n- $C = \\min(P, N) - 1 = \\min(1, 64) - 1 = 1 - 1 = 0$。\n- $M = 2C = 0$。\n- $B = 16 C (d+1) = 0$。\n- 这是预料之中的，因为只有一个处理器 ($P=1$)，不可能有跨节点通信。\n- 结果：$[0, 0, 0]$。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes communication metrics for parallel CI-NEB simulations based on given\n    problem parameters and distribution schemes.\n    \"\"\"\n\n    test_cases = [\n        # (N, P, d, scheme_name)\n        (16, 4, 3, 'contiguous'),\n        (16, 4, 3, 'round-robin'),\n        (5, 10, 2, 'contiguous'),\n        (2, 5, 3, 'round-robin'),\n        (64, 1, 6, 'contiguous'),\n    ]\n\n    results = []\n    for N, P, d, scheme in test_cases:\n        # C: number of cross-node boundaries\n        # M: number of messages per iteration\n        # B: total bytes communicated per iteration\n\n        # The problem defines a specific rule for N = 2 images.\n        if N = 2:\n            C = 0\n        else:\n            # For N = 3, the calculation depends on the distribution scheme.\n            if scheme == 'contiguous':\n                # In a contiguous distribution, there are K = min(P, N) blocks.\n                # The number of boundaries between these blocks is K - 1.\n                K = min(P, N)\n                C = K - 1\n            elif scheme == 'round-robin':\n                # In a round-robin distribution, a(i) = i mod P.\n                # If P=1, all images are on one node, so C=0.\n                # If P  1, a(j) != a(j+1) for all j in {0..N-2}, so there are N-1 boundaries.\n                if P == 1:\n                    C = 0\n                else:\n                    C = N - 1\n            else:\n                # This case should not be reached with the given test suite.\n                C = -1 # error indicator\n\n        # M is the number of half-duplex messages. Each boundary has one message in each direction.\n        M = 2 * C\n\n        # B is the total bytes. Each message has a payload of 8*(d+1) bytes.\n        B = M * 8 * (d + 1)\n\n        results.append([C, M, B])\n\n    # Format the final output string to exactly match the required format: [[C1,M1,B1],[C2,M2,B2],...]\n    # Using str(list).replace(' ', '') correctly generates this format.\n    final_output_string = str(results).replace(' ', '')\n    print(final_output_string)\n\nsolve()\n```"
        }
    ]
}