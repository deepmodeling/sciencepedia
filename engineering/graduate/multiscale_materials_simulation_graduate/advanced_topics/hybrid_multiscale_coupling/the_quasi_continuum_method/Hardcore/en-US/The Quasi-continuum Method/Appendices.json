{
    "hands_on_practices": [
        {
            "introduction": "The Quasi-Continuum method's power lies in its ability to derive macroscopic material behavior directly from atomistic principles. This first exercise provides a fundamental hands-on demonstration of this bridge between scales. By applying the Cauchy-Born hypothesis to a simple one-dimensional chain of atoms, you will derive the continuum strain energy density and stress directly from a given interatomic potential, clarifying how microscopic interactions give rise to a macroscopic constitutive law. ",
            "id": "3850871",
            "problem": "Consider a one-dimensional crystalline chain of identical atoms with a reference (undeformed) lattice spacing $a_{0}$ and nearest-neighbor interactions described by the Lennard–Jones pair potential $\\varphi(r) = 4 \\varepsilon \\left[ \\left( \\frac{\\sigma}{r} \\right)^{12} - \\left( \\frac{\\sigma}{r} \\right)^{6} \\right]$, where $r$ is the distance between two neighboring atoms, and $\\varepsilon$ and $\\sigma$ are positive material parameters. Assume a homogeneous deformation characterized by the deformation gradient $F > 0$ in the reference configuration. Under the Cauchy–Born hypothesis, each bond length changes affinely with the macroscopic deformation, and the quasi-continuum (QC) method approximates the coarse-grained strain energy density $W(F)$ in the reference configuration by counting the per-bond energy scaled by the number of bonds per unit reference length.\n\nStarting from first principles—namely, the atomistic energy of the chain, the definition of the deformation gradient, and the Cauchy–Born hypothesis—derive an explicit expression for the strain energy density $W(F)$ as a function of $F$, $a_{0}$, $\\varepsilon$, and $\\sigma$. Then, using the definition of the first Piola–Kirchhoff stress $P$ as the derivative of the strain energy density with respect to the deformation gradient, compute $P(F) = \\partial W / \\partial F$.\n\nExpress both $W(F)$ and $P(F)$ as closed-form symbolic expressions in terms of $F$, $a_{0}$, $\\varepsilon$, and $\\sigma$. No numerical substitution is required. Provide your final answer as a two-entry row matrix $\\begin{pmatrix} W(F) & P(F) \\end{pmatrix}$. No rounding is required, and no units should be reported in the final expressions.",
            "solution": "We begin by establishing the relationship between the macroscopic deformation and the microscopic bond lengths. The system is a one-dimensional chain of atoms with a reference lattice spacing of $a_{0}$. Let the positions of the atoms in the reference configuration be $X_{i} = i a_{0}$ for an integer $i$. A homogeneous deformation is applied, described by the deformation gradient $F$. According to the Cauchy–Born hypothesis, the position of each atom in the deformed configuration, $x_{i}$, is given by an affine mapping of its reference position: $x_{i} = F X_{i}$.\n\nThe distance, $r$, between two adjacent atoms in the deformed configuration is then:\n$$r = x_{i+1} - x_{i} = F X_{i+1} - F X_{i} = F(X_{i+1} - X_{i})$$\nSince the distance between adjacent atoms in the reference configuration is $X_{i+1} - X_{i} = a_{0}$, the deformed bond length is:\n$$r = F a_{0}$$\n\nThe energy stored in a single bond is given by the Lennard–Jones pair potential, $\\varphi(r)$, where $r$ is the interatomic distance. Substituting the expression for the deformed bond length into the potential gives the energy per bond as a function of the deformation gradient $F$:\n$$\\varphi(F a_{0}) = 4 \\varepsilon \\left[ \\left( \\frac{\\sigma}{F a_{0}} \\right)^{12} - \\left( \\frac{\\sigma}{F a_{0}} \\right)^{6} \\right]$$\n\nThe problem defines the coarse-grained strain energy density, $W(F)$, as the per-bond energy scaled by the number of bonds per unit reference length. In our one-dimensional chain, there is one bond for every segment of length $a_{0}$ in the reference configuration. Therefore, the number of bonds per unit reference length is $1/a_{0}$.\n\nThe strain energy density $W(F)$ is then:\n$$W(F) = \\frac{1}{a_{0}} \\times (\\text{Energy per bond}) = \\frac{1}{a_{0}} \\varphi(F a_{0})$$\nSubstituting the expression for $\\varphi(F a_{0})$, we obtain the explicit form for $W(F)$:\n$$W(F) = \\frac{4 \\varepsilon}{a_{0}} \\left[ \\left( \\frac{\\sigma}{F a_{0}} \\right)^{12} - \\left( \\frac{\\sigma}{F a_{0}} \\right)^{6} \\right]$$\n\nNext, we compute the first Piola–Kirchhoff stress, $P(F)$, which is defined as the derivative of the strain energy density with respect to the deformation gradient:\n$$P(F) = \\frac{\\partial W(F)}{\\partial F}$$\nTo facilitate the differentiation, we can rewrite $W(F)$ as:\n$$W(F) = \\frac{4 \\varepsilon}{a_{0}} \\left[ \\sigma^{12} (F a_{0})^{-12} - \\sigma^{6} (F a_{0})^{-6} \\right] = \\frac{4 \\varepsilon}{a_{0}} \\left[ \\frac{\\sigma^{12}}{a_{0}^{12}} F^{-12} - \\frac{\\sigma^{6}}{a_{0}^{6}} F^{-6} \\right]$$\nNow, we differentiate with respect to $F$:\n$$P(F) = \\frac{\\partial}{\\partial F} \\left( \\frac{4 \\varepsilon}{a_{0}} \\left[ \\frac{\\sigma^{12}}{a_{0}^{12}} F^{-12} - \\frac{\\sigma^{6}}{a_{0}^{6}} F^{-6} \\right] \\right)$$\n$$P(F) = \\frac{4 \\varepsilon}{a_{0}} \\left[ \\frac{\\sigma^{12}}{a_{0}^{12}} (-12 F^{-13}) - \\frac{\\sigma^{6}}{a_{0}^{6}} (-6 F^{-7}) \\right]$$\n$$P(F) = \\frac{4 \\varepsilon}{a_{0}} \\left[ -12 \\frac{\\sigma^{12}}{a_{0}^{12} F^{13}} + 6 \\frac{\\sigma^{6}}{a_{0}^{6} F^{7}} \\right]$$\nWe can simplify this expression by factoring out common terms:\n$$P(F) = \\frac{24 \\varepsilon}{a_{0}} \\left[ -2 \\frac{\\sigma^{12}}{a_{0}^{12} F^{13}} + \\frac{\\sigma^{6}}{a_{0}^{6} F^{7}} \\right]$$\nTo express this in a more compact form similar to the potential, we factor out $1/ (F a_{0})$ from the terms in the brackets but with the constants already extracted:\n$$P(F) = \\frac{24 \\varepsilon}{F a_{0}} \\left[ -2 \\frac{\\sigma^{12}}{(F a_{0})^{12}} + \\frac{\\sigma^{6}}{(F a_{0})^{6}} \\right]$$\n$$P(F) = \\frac{24 \\varepsilon}{F a_{0}} \\left[ \\left(\\frac{\\sigma}{F a_{0}}\\right)^{6} - 2 \\left(\\frac{\\sigma}{F a_{0}}\\right)^{12} \\right]$$\n\nThus, the final expressions for the strain energy density $W(F)$ and the first Piola–Kirchhoff stress $P(F)$ are:\n$$W(F) = \\frac{4 \\varepsilon}{a_{0}} \\left[ \\left( \\frac{\\sigma}{F a_{0}} \\right)^{12} - \\left( \\frac{\\sigma}{F a_{0}} \\right)^{6} \\right]$$\n$$P(F) = \\frac{24 \\varepsilon}{F a_{0}} \\left[ \\left(\\frac{\\sigma}{F a_{0}}\\right)^{6} - 2 \\left(\\frac{\\sigma}{F a_{0}}\\right)^{12} \\right]$$",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{4 \\varepsilon}{a_{0}} \\left[ \\left( \\frac{\\sigma}{F a_{0}} \\right)^{12} - \\left( \\frac{\\sigma}{F a_{0}} \\right)^{6} \\right] & \\frac{24 \\varepsilon}{F a_{0}} \\left[ \\left(\\frac{\\sigma}{F a_{0}}\\right)^{6} - 2 \\left(\\frac{\\sigma}{F a_{0}}\\right)^{12} \\right]\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "While the Cauchy-Born rule provides the energetic link between scales, the Finite Element Method provides the kinematic framework for the QC method's coarse-grained regions. This exercise focuses on a single finite element to illustrate how the discrete displacements of representative atoms (repatoms) are interpolated to define a continuous deformation field. You will calculate the deformation gradient, a key quantity for evaluating stress and energy, directly from the nodal displacements, solidifying the link between discrete degrees of freedom and continuum mechanics. ",
            "id": "3850840",
            "problem": "In the Quasi-Continuum (QC) method, coarse-graining replaces a fully atomistic description by representative atoms (repatoms) whose kinematics are interpolated over finite elements, and the continuum fields are evaluated at quadrature points to assemble an approximate energy. Consider a single linear triangular finite element in two dimensions whose nodes coincide with repatoms. The reference configuration nodal positions are $$\\mathbf{X}_1 = (0, 0), \\quad \\mathbf{X}_2 = (2, 0), \\quad \\mathbf{X}_3 = (0, 1),$$ in nanometers. The repatom displacements in the QC coarse-grained representation are prescribed as $$\\mathbf{u}_1 = (0.1, 0.05), \\quad \\mathbf{u}_2 = (0.2, -0.02), \\quad \\mathbf{u}_3 = (-0.05, 0.15),$$ in nanometers.\n\nStarting from continuum kinematics, the mapping from the reference position $\\mathbf{X}$ to the current position $\\mathbf{x}$ is $$\\mathbf{x}(\\mathbf{X}) = \\mathbf{X} + \\mathbf{u}(\\mathbf{X}),$$ where $\\mathbf{u}(\\mathbf{X})$ is the displacement field. In a linear triangular element, approximate the displacement by the standard first-order Lagrange shape functions $\\{N_i(\\mathbf{X})\\}_{i=1}^3$ that satisfy $$N_i(\\mathbf{X}_j) = \\delta_{ij}, \\quad \\sum_{i=1}^{3} N_i(\\mathbf{X}) = 1,$$ and are linear in the coordinates $\\mathbf{X} = (X, Y)$.\n\nUsing these definitions and the one-point centroid quadrature rule for the triangle (with centroid barycentric coordinates $(\\frac{1}{3}, \\frac{1}{3}, \\frac{1}{3})$), construct the interpolation $\\mathbf{u}(\\mathbf{X}) = \\sum_{i=1}^{3} N_i(\\mathbf{X}) \\mathbf{u}_i$, derive the gradient of the shape functions with respect to the reference coordinates, and compute the deformation gradient $$\\mathbf{F}(\\mathbf{X}) = \\frac{\\partial \\mathbf{x}}{\\partial \\mathbf{X}} = \\mathbf{I} + \\frac{\\partial \\mathbf{u}}{\\partial \\mathbf{X}}$$ evaluated at the centroid quadrature point. The deformation gradient is dimensionless; express your final answer as the $2 \\times 2$ matrix entries with exact decimal values. No rounding is required.",
            "solution": "The problem requires the computation of the deformation gradient tensor $\\mathbf{F}$ for a linear triangular element. The deformation gradient is defined as:\n$$ \\mathbf{F} = \\frac{\\partial \\mathbf{x}}{\\partial \\mathbf{X}} = \\mathbf{I} + \\frac{\\partial \\mathbf{u}}{\\partial \\mathbf{X}} = \\mathbf{I} + \\nabla_{\\mathbf{X}} \\mathbf{u} $$\nwhere $\\mathbf{I}$ is the identity tensor and $\\mathbf{u}$ is the displacement field. The displacement field is interpolated from the nodal displacements $\\mathbf{u}_i$ using linear shape functions $N_i(\\mathbf{X})$:\n$$ \\mathbf{u}(\\mathbf{X}) = \\sum_{i=1}^{3} N_i(\\mathbf{X}) \\mathbf{u}_i $$\nThe displacement gradient is therefore:\n$$ \\nabla_{\\mathbf{X}} \\mathbf{u} = \\sum_{i=1}^{3} \\mathbf{u}_i \\otimes (\\nabla_{\\mathbf{X}} N_i)^T $$\nFor a linear element, the shape function gradients are constant. We first determine the shape functions $N_i(X, Y) = a_i + b_i X + c_i Y$ using the nodal coordinates $\\mathbf{X}_1 = (0, 0)$, $\\mathbf{X}_2 = (2, 0)$, and $\\mathbf{X}_3 = (0, 1)$. Solving the system of equations from the condition $N_i(\\mathbf{X}_j) = \\delta_{ij}$ yields:\n$$ N_1(X, Y) = 1 - \\frac{1}{2}X - Y $$\n$$ N_2(X, Y) = \\frac{1}{2}X $$\n$$ N_3(X, Y) = Y $$\nThe gradients of the shape functions are:\n$$ \\nabla_{\\mathbf{X}} N_1 = \\begin{pmatrix} -0.5 \\\\ -1 \\end{pmatrix}, \\quad \\nabla_{\\mathbf{X}} N_2 = \\begin{pmatrix} 0.5 \\\\ 0 \\end{pmatrix}, \\quad \\nabla_{\\mathbf{X}} N_3 = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} $$\nUsing the nodal displacements $\\mathbf{u}_1 = (0.1, 0.05)^T$, $\\mathbf{u}_2 = (0.2, -0.02)^T$, and $\\mathbf{u}_3 = (-0.05, 0.15)^T$, we can compute the components of the displacement gradient tensor:\n$$ \\frac{\\partial u_x}{\\partial X} = \\sum_{i=1}^{3} u_{ix} \\frac{\\partial N_i}{\\partial X} = (0.1)(-0.5) + (0.2)(0.5) + (-0.05)(0) = 0.05 $$\n$$ \\frac{\\partial u_x}{\\partial Y} = \\sum_{i=1}^{3} u_{ix} \\frac{\\partial N_i}{\\partial Y} = (0.1)(-1) + (0.2)(0) + (-0.05)(1) = -0.15 $$\n$$ \\frac{\\partial u_y}{\\partial X} = \\sum_{i=1}^{3} u_{iy} \\frac{\\partial N_i}{\\partial X} = (0.05)(-0.5) + (-0.02)(0.5) + (0.15)(0) = -0.035 $$\n$$ \\frac{\\partial u_y}{\\partial Y} = \\sum_{i=1}^{3} u_{iy} \\frac{\\partial N_i}{\\partial Y} = (0.05)(-1) + (-0.02)(0) + (0.15)(1) = 0.10 $$\nThus, the displacement gradient tensor is:\n$$ \\nabla_{\\mathbf{X}} \\mathbf{u} = \\begin{pmatrix} 0.05 & -0.15 \\\\ -0.035 & 0.10 \\end{pmatrix} $$\nFinally, the deformation gradient is found by adding the identity matrix:\n$$ \\mathbf{F} = \\mathbf{I} + \\nabla_{\\mathbf{X}} \\mathbf{u} = \\begin{pmatrix} 1 & 0 \\\\ 0 & 1 \\end{pmatrix} + \\begin{pmatrix} 0.05 & -0.15 \\\\ -0.035 & 0.10 \\end{pmatrix} = \\begin{pmatrix} 1.05 & -0.15 \\\\ -0.035 & 1.10 \\end{pmatrix} $$\nSince the element is linear, the deformation gradient is constant throughout the element. The value is therefore the same at the centroid as it is everywhere else in the element.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n1.05 & -0.15 \\\\\n-0.035 & 1.10\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "A correct numerical implementation must pass fundamental consistency checks. This practice introduces the \"patch test,\" a cornerstone of verification in computational mechanics, applied here to a Cauchy-Born-based QC model. By subjecting a mesh to a uniform deformation, you will verify that the numerically assembled forces on all interior atoms correctly sum to zero, a non-trivial result that must hold even for irregular meshes. This exercise demonstrates how to build confidence in a multiscale code's implementation by confirming its ability to reproduce simple, exact continuum solutions. ",
            "id": "3850863",
            "problem": "You are asked to validate the Quasi-Continuum (QC) patch test numerically. The patch test requires that, under a uniform deformation, the internal residual forces at coarse representative atoms (repatoms) vanish when the QC method is consistent. In this exercise, you will implement a Cauchy–Born-based QC formulation on a two-dimensional triangular mesh and check that the assembled repatom residuals for interior nodes are numerically zero (up to tolerance).\n\nFundamental base:\n- Start from a two-dimensional triangular lattice of nearest-neighbor harmonic springs with reference bond vectors $\\{\\mathbf{a}_m\\}_{m=1}^6$ of unit length arranged at $60^\\circ$ increments, and a pair potential $\\phi(r) = \\tfrac{1}{2} k (r - r_0)^2$ with spring constant $k$ and stress-free bond length $r_0 = 1$.\n- Use the Cauchy–Born rule to define a continuum energy density at deformation gradient $\\mathbf{F} \\in \\mathbb{R}^{2 \\times 2}$ by locally mapping the bonds as $\\mathbf{F}\\mathbf{a}_m$ and summing the spring energies.\n- Use the principle of virtual work to form the internal nodal residuals for a piecewise-linear finite element discretization with linear triangular elements. For a uniform deformation gradient, the First Piola–Kirchhoff stress $\\mathbf{P}(\\mathbf{F})$ is constant in space, and the internal residual for an interior node is the area integral of $\\mathbf{P}(\\mathbf{F}) \\nabla N_i$, where $N_i$ is the corresponding shape function. The QC patch test requires these residuals to vanish for interior nodes under any uniform $\\mathbf{F}$ when Dirichlet boundary conditions enforce the uniform deformation on the boundary.\n\nYour program must:\n1. Construct a two-dimensional mesh of the unit square $\\Omega = [0,1] \\times [0,1]$ subdivided into $n_x \\times n_y$ rectangular cells, each split into two triangles. Nodes are located at grid points $(i/n_x, j/n_y)$ for integers $i = 0,\\dots,n_x$ and $j = 0,\\dots,n_y$. An optional interior jitter amplitude $\\epsilon$ can be applied to move interior nodes by a small random displacement while keeping boundary nodes fixed.\n2. Define the six nearest-neighbor reference bond vectors for the triangular lattice:\n   - $\\mathbf{a}_1 = [1,0]$, $\\mathbf{a}_2 = [\\tfrac{1}{2}, \\tfrac{\\sqrt{3}}{2}]$, $\\mathbf{a}_3 = [-\\tfrac{1}{2}, \\tfrac{\\sqrt{3}}{2}]$, $\\mathbf{a}_4 = [-1,0]$, $\\mathbf{a}_5 = [-\\tfrac{1}{2}, -\\tfrac{\\sqrt{3}}{2}]$, $\\mathbf{a}_6 = [\\tfrac{1}{2}, -\\tfrac{\\sqrt{3}}{2}]$.\n3. Use nondimensional units with spring constant $k = 1$ and reference bond lengths $r_0 = 1$.\n4. For a given uniform deformation gradient $\\mathbf{F}$, compute the First Piola–Kirchhoff stress by applying the Cauchy–Born rule with harmonic bonds. The bond $m$ contributes to the stress via the chain rule for $r_m = \\|\\mathbf{F}\\mathbf{a}_m\\|$:\n   - The derivative of $r_m$ with respect to $\\mathbf{F}$ is $\\partial r_m / \\partial \\mathbf{F} = (\\mathbf{F}\\mathbf{a}_m \\, \\mathbf{a}_m^\\top)/r_m$.\n   - The contribution to $\\mathbf{P}$ from bond $m$ is $k (r_m - r_0) \\, (\\mathbf{F}\\mathbf{a}_m \\, \\mathbf{a}_m^\\top)/r_m$.\n   - Sum the contributions over $m=1,\\dots,6$ to obtain $\\mathbf{P}(\\mathbf{F})$.\n5. Assemble the internal nodal force (residual) for each triangle. For a triangle with area $A_e$ and linear shape function gradients $\\nabla N_1$, $\\nabla N_2$, $\\nabla N_3$, the internal force contribution to node $i$ is $\\mathbf{f}_i^e = A_e \\, \\mathbf{P}(\\mathbf{F}) \\, \\nabla N_i$. Assemble over all elements adjacent to a node to obtain the global internal residual $\\mathbf{f}_i$.\n6. Identify interior nodes as those with indices not on the boundary grid lines $i \\in \\{0,n_x\\}$ or $j \\in \\{0,n_y\\}$. Compute the magnitude of the interior residuals as the Euclidean norm $\\|\\mathbf{f}\\| = \\left(\\sum_{i \\in \\text{interior}} \\|\\mathbf{f}_i\\|_2^2\\right)^{1/2}$.\n7. Report the ratio $\\|\\mathbf{f}\\|/\\text{tol}$, which is unitless in nondimensional units.\n\nTest suite:\nProvide the following four test cases to exercise different scenarios. For each case, compute the ratio $\\|\\mathbf{f}\\|/\\text{tol}$ where “tol” is the specified tolerance:\n- Case 1 (happy path, identity): $n_x = 2$, $n_y = 2$, $\\epsilon = 0$, $\\mathbf{F} = \\begin{bmatrix}1 & 0 \\\\ 0 & 1\\end{bmatrix}$, $\\text{tol} = 10^{-12}$.\n- Case 2 (general uniform shear, jittered interior): $n_x = 4$, $n_y = 3$, $\\epsilon = 0.02$, $\\mathbf{F} = \\begin{bmatrix}1 & \\gamma \\\\ 0 & 1\\end{bmatrix}$ with $\\gamma = 0.2$, $\\text{tol} = 10^{-11}$.\n- Case 3 (uniform rotation): $n_x = 3$, $n_y = 3$, $\\epsilon = 0$, $\\mathbf{F} = \\mathbf{R}(\\theta)$ with $\\theta = \\pi/6$ radians, i.e., $\\mathbf{F} = \\begin{bmatrix}\\cos\\theta & -\\sin\\theta \\\\ \\sin\\theta & \\cos\\theta\\end{bmatrix}$, $\\text{tol} = 10^{-12}$.\n- Case 4 (uniform stretch, mild jitter): $n_x = 5$, $n_y = 4$, $\\epsilon = 0.01$, $\\mathbf{F} = \\begin{bmatrix}1.1 & 0 \\\\ 0 & 0.9\\end{bmatrix}$, $\\text{tol} = 5 \\times 10^{-11}$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., “[result1,result2,result3,result4]”), where each “result” is the float value of $\\|\\mathbf{f}\\|/\\text{tol}$ for the corresponding test case. Use nondimensional units throughout; the ratio is unitless. No angles other than radians are used, and no percentages appear anywhere in the output.",
            "solution": "The provided code implements a numerical patch test for a Cauchy-Born-based Quasi-Continuum (QC) model. A patch test is a fundamental verification procedure in computational mechanics that checks whether a numerical method can exactly reproduce a state of constant strain when the boundary conditions are set to enforce it. For an interior node in a finite element mesh, this consistency should result in a zero net internal force (residual).\n\nThe procedure connects the atomistic and continuum scales using the Cauchy-Born (CB) rule. The rule assumes that under a uniform macroscopic deformation gradient $\\mathbf{F}$, the atomic lattice deforms according to the same gradient. The First Piola-Kirchhoff (PK1) stress tensor, $\\mathbf{P}$, is derived from the strain energy density, which is calculated by summing the energies of the deformed harmonic bonds:\n$$\n\\mathbf{P}(\\mathbf{F}) = \\sum_{m=1}^{6} k(r_m - r_0) \\frac{\\mathbf{r}_m \\mathbf{a}_m^\\top}{r_m}\n$$\nwhere $\\mathbf{r}_m = \\mathbf{F}\\mathbf{a}_m$ is the deformed bond vector and $r_m = \\|\\mathbf{r}_m\\|$. For any given uniform $\\mathbf{F}$, this formula yields a constant stress tensor $\\mathbf{P}$ throughout the material.\n\nThe continuum stress is translated into discrete nodal forces using the principle of virtual work. The internal force on a node $i$ is found by summing contributions from all adjacent finite elements:\n$$\n\\mathbf{f}_i = \\sum_{e \\in \\text{supp}(N_i)} \\int_{e} \\mathbf{P} \\nabla N_i(\\mathbf{X}) \\, d A_e = \\mathbf{P} \\left( \\sum_{e \\in \\text{supp}(N_i)} A_e (\\nabla N_i)|_e \\right)\n$$\nwhere $A_e$ is the area of element $e$ and $\\nabla N_i$ is the gradient of the shape function for node $i$.\n\nThe patch test passes because of a fundamental geometric property of finite element shape functions. For any node $i$ in the interior of the mesh, the sum of the area-weighted gradients of its shape function over its support is zero:\n$$\n\\sum_{e \\in \\text{supp}(N_i)} A_e (\\nabla N_i)|_e = \\mathbf{0}\n$$\nThis identity holds regardless of the mesh geometry, including random jitter. Consequently, the total internal residual force $\\mathbf{f}_i$ for any interior node must be zero. The provided code verifies this by assembling the forces and checking that the norm of the interior residuals is zero up to floating-point precision.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the QC patch test validation for all specified cases.\n    \"\"\"\n    # Seed the random number generator for reproducible jitter.\n    np.random.seed(0)\n    \n    # Define the six nearest-neighbor bond vectors for a 2D triangular lattice.\n    sqrt3_2 = np.sqrt(3) / 2.0\n    bonds = np.array([\n        [1.0, 0.0],\n        [0.5, sqrt3_2],\n        [-0.5, sqrt3_2],\n        [-1.0, 0.0],\n        [-0.5, -sqrt3_2],\n        [0.5, -sqrt3_2]\n    ])\n\n    # Define the test cases from the problem statement.\n    # Structure: (nx, ny, epsilon, F, tol)\n    theta_case3 = np.pi / 6.0\n    cos_t, sin_t = np.cos(theta_case3), np.sin(theta_case3)\n    \n    test_cases = [\n        (2, 2, 0.0, np.array([[1.0, 0.0], [0.0, 1.0]]), 1e-12),\n        (4, 3, 0.02, np.array([[1.0, 0.2], [0.0, 1.0]]), 1e-11),\n        (3, 3, 0.0, np.array([[cos_t, -sin_t], [sin_t, cos_t]]), 1e-12),\n        (5, 4, 0.01, np.array([[1.1, 0.0], [0.0, 0.9]]), 5e-11)\n    ]\n\n    results = []\n    for case in test_cases:\n        result = run_patch_test(*case, bonds=bonds)\n        results.append(result)\n\n    print(f\"[{','.join(f'{r:.15f}' for r in results)}]\")\n\n\ndef run_patch_test(nx, ny, epsilon, F, tol, bonds):\n    \"\"\"\n    Executes a single patch test case.\n\n    Args:\n        nx (int): Number of cells in the x-direction.\n        ny (int): Number of cells in the y-direction.\n        epsilon (float): Jitter amplitude for interior nodes.\n        F (np.ndarray): The 2x2 deformation gradient tensor.\n        tol (float): The tolerance for normalizing the residual norm.\n        bonds (np.ndarray): The reference bond vectors.\n\n    Returns:\n        float: The ratio of the interior residual norm to the tolerance.\n    \"\"\"\n    nodes, elements = generate_mesh(nx, ny, epsilon)\n    P = compute_stress(F, bonds)\n    \n    num_nodes = (nx + 1) * (ny + 1)\n    global_forces = np.zeros((num_nodes, 2))\n\n    for elem_nodes_indices in elements:\n        # Get coordinates of the three nodes of the element\n        node1_idx, node2_idx, node3_idx = elem_nodes_indices\n        p1, p2, p3 = nodes[node1_idx], nodes[node2_idx], nodes[node3_idx]\n\n        # Calculate element area\n        # 2 * Area = (x2-x1)*(y3-y1) - (x3-x1)*(y2-y1)\n        area = 0.5 * ((p2[0] - p1[0]) * (p3[1] - p1[1]) - (p3[0] - p1[0]) * (p2[1] - p1[1]))\n        if area <= 0:\n            # Skip inverted or zero-area elements, though unlikely with small jitter\n            continue\n\n        # Calculate shape function gradients (constant within a linear triangle)\n        # grad(N1) = (1/2A) * [y2-y3, x3-x2]\n        # grad(N2) = (1/2A) * [y3-y1, x1-x3]\n        # grad(N3) = (1/2A) * [y1-y2, x2-x1]\n        grad_N1 = (0.5 / area) * np.array([p2[1] - p3[1], p3[0] - p2[0]])\n        grad_N2 = (0.5 / area) * np.array([p3[1] - p1[1], p1[0] - p3[0]])\n        grad_N3 = (0.5 / area) * np.array([p1[1] - p2[1], p2[0] - p1[0]])\n\n        # Calculate force contribution from this element to its nodes\n        # f_i^e = Area * P @ grad(N_i)\n        f1_e = area * (P @ grad_N1)\n        f2_e = area * (P @ grad_N2)\n        f3_e = area * (P @ grad_N3)\n\n        # Assemble into global force vector\n        global_forces[node1_idx] += f1_e\n        global_forces[node2_idx] += f2_e\n        global_forces[node3_idx] += f3_e\n\n    # Calculate the norm of residuals for interior nodes\n    total_norm_sq = 0.0\n    for j in range(1, ny):\n        for i in range(1, nx):\n            node_idx = j * (nx + 1) + i\n            force_vector = global_forces[node_idx]\n            total_norm_sq += np.dot(force_vector, force_vector)\n            \n    residual_norm = np.sqrt(total_norm_sq)\n\n    return residual_norm / tol\n\n\ndef generate_mesh(nx, ny, epsilon):\n    \"\"\"\n    Generates a 2D triangular mesh on the unit square with optional jitter.\n    \"\"\"\n    num_nodes_x = nx + 1\n    num_nodes_y = ny + 1\n    nodes = np.zeros((num_nodes_y * num_nodes_x, 2))\n    \n    for j in range(num_nodes_y):\n        for i in range(num_nodes_x):\n            node_idx = j * num_nodes_x + i\n            nodes[node_idx] = [i / nx, j / ny]\n\n    # Apply jitter to interior nodes\n    if epsilon > 0.0:\n        # Jitter displacement is scaled by a characteristic length (1/nx)\n        # to ensure it's \"small\" relative to the mesh size.\n        jitter_scale = epsilon / nx\n        for j in range(1, ny):\n            for i in range(1, nx):\n                node_idx = j * num_nodes_x + i\n                # Generate a random displacement vector\n                displacement = (np.random.rand(2) - 0.5) * jitter_scale * 2.0\n                nodes[node_idx] += displacement\n\n    elements = []\n    for j in range(ny):\n        for i in range(nx):\n            # Node indices for the corners of the (i, j)-th cell\n            n1 = j * num_nodes_x + i       # bottom-left\n            n2 = j * num_nodes_x + (i + 1)   # bottom-right\n            n3 = (j + 1) * num_nodes_x + (i + 1) # top-right\n            n4 = (j + 1) * num_nodes_x + i       # top-left\n            \n            # Split the rectangular cell into two triangles\n            elements.append((n1, n2, n3))\n            elements.append((n1, n3, n4))\n            \n    return nodes, elements\n\n\ndef compute_stress(F, bonds):\n    \"\"\"\n    Computes the First Piola-Kirchhoff stress tensor using the Cauchy-Born rule.\n    \"\"\"\n    k = 1.0  # Spring constant\n    r0 = 1.0 # Reference bond length\n\n    P = np.zeros((2, 2))\n    for a_m in bonds:\n        r_m_vec = F @ a_m\n        r_m_len = np.linalg.norm(r_m_vec)\n        \n        # Avoid division by zero if a bond is compressed to zero length\n        if r_m_len < 1e-15:\n            continue\n            \n        P += k * (r_m_len - r0) * np.outer(r_m_vec, a_m) / r_m_len\n        \n    return P\n\nif __name__ == '__main__':\n    solve()\n\n```"
        }
    ]
}