{
    "hands_on_practices": [
        {
            "introduction": "要掌握刚体动力学中的四元数方法，首先必须理解其基础代数运算。本练习聚焦于四元数代数的基石——汉密尔顿积。通过从基本法则出发推导乘法公式并赋予其几何解释，您将深入理解四元数如何优雅地编码三维旋转的复合，包括其固有的非交换性。",
            "id": "3838903",
            "problem": "在多尺度材料模拟中，介观尺度刚性夹杂物（代表原子的粗粒化团簇）的取向通常通过将一个已有取向与一个由微观尺度力矩引起的微小增量旋转进行复合来更新。三维旋转的一种常见表示是四元数表示法，其中四元数写作 $q = q_{0} + q_{1}\\mathbf{i} + q_{2}\\mathbf{j} + q_{3}\\mathbf{k}$，或等效地写为标量-向量分裂形式 $q = (q_{0}, \\mathbf{q})$，其中 $\\mathbf{q} = (q_{1}, q_{2}, q_{3}) \\in \\mathbb{R}^{3}$。四元数基服从 Hamilton 法则 $\\mathbf{i}^{2} = \\mathbf{j}^{2} = \\mathbf{k}^{2} = \\mathbf{i}\\mathbf{j}\\mathbf{k} = -1$，以及 $\\mathbf{i}\\mathbf{j} = \\mathbf{k}$、$\\mathbf{j}\\mathbf{k} = \\mathbf{i}$、$\\mathbf{k}\\mathbf{i} = \\mathbf{j}$，连同反交换律 $\\mathbf{j}\\mathbf{i} = -\\mathbf{k}$、$\\mathbf{k}\\mathbf{j} = -\\mathbf{i}$、$\\mathbf{i}\\mathbf{k} = -\\mathbf{j}$。\n\n令 $p = (p_{0}, \\mathbf{p})$ 表示一个微小的增量旋转（可能源自微观尺度力矩），令 $q = (q_{0}, \\mathbf{q})$ 表示介观尺度上一个刚体的当前取向。$p$ 和 $q$ 都是单位四元数，表示特殊正交群 $\\mathrm{SO}(3)$ 中的元素。更新后的取向是四元数乘积 $r = p \\otimes q$，其中 $\\otimes$ 表示 Hamilton 乘积。\n\n任务：仅从上述基本的四元数乘法法则出发，推导 $r = p \\otimes q$ 的标量-向量分裂表达式（用 $p_{0}, p_{1}, p_{2}, p_{3}$ 和 $q_{0}, q_{1}, q_{2}, q_{3}$ 表示），并将分量 $(r_{0}, r_{1}, r_{2}, r_{3})$ 表示为单个行矩阵。然后，在刚体旋转复合的背景下对结果进行几何解释：解释标量部分和向量部分编码了关于先 $q$ 后 $p$ 的顺序作用的什么信息，并评论向量部分的结构如何反映三维旋转的非交换性。\n\n您的最终答案必须是推导出的 $(r_{0}, r_{1}, r_{2}, r_{3})$ 作为单个行矩阵的解析表达式。不需要四舍五入，最终答案中不包含任何物理单位。如果在您的解释中讨论到角度，应理解为以弧度为单位。",
            "solution": "问题陈述经评估是有效的。它以四元数代数及其在刚体动力学中应用的既定原理为科学基础。该问题是适定的、客观的、自洽的，并要求进行标准的推导和解释，这构成了对基础理解的有效检验。\n\n任务是推导四元数乘积 $r = p \\otimes q$ 的分量，并对结果进行几何解释。给定两个四元数 $p = (p_{0}, \\mathbf{p})$ 和 $q = (q_{0}, \\mathbf{q})$，我们可以将其写成完整的代数形式：\n$$p = p_{0} + p_{1}\\mathbf{i} + p_{2}\\mathbf{j} + p_{3}\\mathbf{k}$$\n$$q = q_{0} + q_{1}\\mathbf{i} + q_{2}\\mathbf{j} + q_{3}\\mathbf{k}$$\n乘积 $r = p \\otimes q$ 是通过应用乘法对加法的分配律来计算的，仅从所提供的 Hamilton 法则出发：$\\mathbf{i}^{2} = \\mathbf{j}^{2} = \\mathbf{k}^{2} = \\mathbf{i}\\mathbf{j}\\mathbf{k} = -1$，以及基向量 $\\mathbf{i}, \\mathbf{j}, \\mathbf{k}$ 的循环/反循环关系。\n\n令 $r = r_{0} + r_{1}\\mathbf{i} + r_{2}\\mathbf{j} + r_{3}\\mathbf{k}$。乘积 $p \\otimes q$ 是：\n$$r = (p_{0} + p_{1}\\mathbf{i} + p_{2}\\mathbf{j} + p_{3}\\mathbf{k}) \\otimes (q_{0} + q_{1}\\mathbf{i} + q_{2}\\mathbf{j} + q_{3}\\mathbf{k})$$\n我们逐项展开这个乘积：\n$$r = p_{0}(q_{0} + q_{1}\\mathbf{i} + q_{2}\\mathbf{j} + q_{3}\\mathbf{k}) + p_{1}\\mathbf{i}(q_{0} + q_{1}\\mathbf{i} + q_{2}\\mathbf{j} + q_{3}\\mathbf{k}) + p_{2}\\mathbf{j}(q_{0} + q_{1}\\mathbf{i} + q_{2}\\mathbf{j} + q_{3}\\mathbf{k}) + p_{3}\\mathbf{k}(q_{0} + q_{1}\\mathbf{i} + q_{2}\\mathbf{j} + q_{3}\\mathbf{k})$$\n分配每一项：\n$$r = (p_{0}q_{0} + p_{0}q_{1}\\mathbf{i} + p_{0}q_{2}\\mathbf{j} + p_{0}q_{3}\\mathbf{k})$$\n$$+ (p_{1}q_{0}\\mathbf{i} + p_{1}q_{1}\\mathbf{i}^{2} + p_{1}q_{2}\\mathbf{i}\\mathbf{j} + p_{1}q_{3}\\mathbf{i}\\mathbf{k})$$\n$$+ (p_{2}q_{0}\\mathbf{j} + p_{2}q_{1}\\mathbf{j}\\mathbf{i} + p_{2}q_{2}\\mathbf{j}^{2} + p_{2}q_{3}\\mathbf{j}\\mathbf{k})$$\n$$+ (p_{3}q_{0}\\mathbf{k} + p_{3}q_{1}\\mathbf{k}\\mathbf{i} + p_{3}q_{2}\\mathbf{k}\\mathbf{j} + p_{3}q_{3}\\mathbf{k}^{2})$$\n现在，我们应用 Hamilton 法则来简化基向量的乘积：\n$$r = (p_{0}q_{0} + p_{0}q_{1}\\mathbf{i} + p_{0}q_{2}\\mathbf{j} + p_{0}q_{3}\\mathbf{k})$$\n$$+ (p_{1}q_{0}\\mathbf{i} - p_{1}q_{1} + p_{1}q_{2}\\mathbf{k} - p_{1}q_{3}\\mathbf{j})$$\n$$+ (p_{2}q_{0}\\mathbf{j} - p_{2}q_{1}\\mathbf{k} - p_{2}q_{2} + p_{2}q_{3}\\mathbf{i})$$\n$$+ (p_{3}q_{0}\\mathbf{k} + p_{3}q_{1}\\mathbf{j} - p_{3}q_{2}\\mathbf{i} - p_{3}q_{3})$$\n下一步是收集对应于标量部分 ($1$) 和向量部分 ($\\mathbf{i}, \\mathbf{j}, \\mathbf{k}$) 的项。\n\n标量分量 $r_{0}$ 是所有不含向量基元的项之和：\n$$r_{0} = p_{0}q_{0} - p_{1}q_{1} - p_{2}q_{2} - p_{3}q_{3}$$\n这可以用标量-向量分裂表示法 $p = (p_{0}, \\mathbf{p})$ 和 $q = (q_{0}, \\mathbf{q})$ 紧凑地写出，其中 $\\mathbf{p} = (p_{1}, p_{2}, p_{3})$ 和 $\\mathbf{q} = (q_{1}, q_{2}, q_{3})$。$r_{0}$ 的表达式等价于：\n$$r_{0} = p_{0}q_{0} - \\mathbf{p} \\cdot \\mathbf{q}$$\n其中 $\\mathbf{p} \\cdot \\mathbf{q}$ 是标准的欧几里得点积。\n\n$\\mathbf{i}$ 的系数，即 $r_{1}$，是：\n$$r_{1} = p_{0}q_{1} + p_{1}q_{0} + p_{2}q_{3} - p_{3}q_{2}$$\n$\\mathbf{j}$ 的系数，即 $r_{2}$，是：\n$$r_{2} = p_{0}q_{2} - p_{1}q_{3} + p_{2}q_{0} + p_{3}q_{1}$$\n$\\mathbf{k}$ 的系数，即 $r_{3}$，是：\n$$r_{3} = p_{0}q_{3} + p_{1}q_{2} - p_{2}q_{1} + p_{3}q_{0}$$\n我们可以组合 $r$ 的向量部分，即 $\\mathbf{r} = (r_{1}, r_{2}, r_{3})$，并根据向量运算识别其结构。为清晰起见，让我们重新组织这些项：\n$$r_{1} = (p_{1}q_{0} + p_{0}q_{1}) + (p_{2}q_{3} - p_{3}q_{2})$$\n$$r_{2} = (p_{2}q_{0} + p_{0}q_{2}) + (p_{3}q_{1} - p_{1}q_{3})$$\n$$r_{3} = (p_{3}q_{0} + p_{0}q_{3}) + (p_{1}q_{2} - p_{2}q_{1})$$\n第一个括号中的项对应于 $p_{0}\\mathbf{q} + q_{0}\\mathbf{p}$ 的分量。第二个括号中的项是叉积 $\\mathbf{p} \\times \\mathbf{q}$ 的分量。因此，向量部分 $\\mathbf{r}$ 可以写作：\n$$\\mathbf{r} = p_{0}\\mathbf{q} + q_{0}\\mathbf{p} + \\mathbf{p} \\times \\mathbf{q}$$\n结合标量和向量部分，四元数乘积的标量-向量形式是：\n$$r = p \\otimes q = (p_{0}q_{0} - \\mathbf{p} \\cdot \\mathbf{q}, \\quad p_{0}\\mathbf{q} + q_{0}\\mathbf{p} + \\mathbf{p} \\times \\mathbf{q})$$\n由此确定了分量 $(r_{0}, r_{1}, r_{2}, r_{3})$。\n\n现在进行几何解释。四元数 $p$ 和 $q$ 是表示旋转的单位四元数。乘积 $r = p \\otimes q$ 表示先应用旋转 $q$ 然后再应用旋转 $p$ 所得到的复合旋转。\n一个表示绕单位轴向量 $\\mathbf{u}_{q}$ 旋转角度 $\\theta_{q}$ 的单位四元数 $q$ 由 $q = (\\cos(\\theta_{q}/2), \\sin(\\theta_{q}/2)\\mathbf{u}_{q})$ 给出。因此，$q_{0} = \\cos(\\theta_{q}/2)$ 且向量部分为 $\\mathbf{q} = \\sin(\\theta_{q}/2)\\mathbf{u}_{q}$。对于具有角度 $\\theta_{p}$ 和轴 $\\mathbf{u}_{p}$ 的 $p$ 也存在类似的表示。\n\n复合四元数的标量部分 $r_{0} = \\cos(\\theta_{r}/2)$ 是：\n$$r_{0} = p_{0}q_{0} - \\mathbf{p} \\cdot \\mathbf{q} = \\cos(\\frac{\\theta_{p}}{2})\\cos(\\frac{\\theta_{q}}{2}) - (\\sin(\\frac{\\theta_{p}}{2})\\mathbf{u}_{p}) \\cdot (\\sin(\\frac{\\theta_{q}}{2})\\mathbf{u}_{q})$$\n$$r_{0} = \\cos(\\frac{\\theta_{p}}{2})\\cos(\\frac{\\theta_{q}}{2}) - \\sin(\\frac{\\theta_{p}}{2})\\sin(\\frac{\\theta_{q}}{2})(\\mathbf{u}_{p} \\cdot \\mathbf{u}_{q})$$\n这个表达式是球面余弦定理的一种形式，它确定了复合旋转的角度 $\\theta_{r}$。它表明，所得角度不仅取决于单个旋转角 $\\theta_{p}$ 和 $\\theta_{q}$，还取决于它们轴的相对取向，这由点积 $\\mathbf{u}_{p} \\cdot \\mathbf{u}_{q}$ 体现。\n\n向量部分 $\\mathbf{r} = \\sin(\\theta_{r}/2)\\mathbf{u}_{r}$，即 $\\mathbf{r} = p_{0}\\mathbf{q} + q_{0}\\mathbf{p} + \\mathbf{p} \\times \\mathbf{q}$，确定了复合旋转的轴 $\\mathbf{u}_{r}$ 和大小 $\\sin(\\theta_{r}/2)$。该向量部分的结构明确地展示了三维旋转的非交换性。要理解这一点，考虑乘积的相反顺序 $q \\otimes p$。得到的标量部分将是 $q_{0}p_{0} - \\mathbf{q} \\cdot \\mathbf{p}$，这与 $p \\otimes q$ 的标量部分相同，因为标量乘法和点积都是可交换的。这意味着复合旋转角的大小 $|\\theta_r|$ 与应用顺序无关。然而，$q \\otimes p$ 的向量部分将是：\n$$\\mathbf{r}' = q_{0}\\mathbf{p} + p_{0}\\mathbf{q} + \\mathbf{q} \\times \\mathbf{p}$$\n将其与 $p \\otimes q$ 的向量部分 $\\mathbf{r} = p_{0}\\mathbf{q} + q_{0}\\mathbf{p} + \\mathbf{p} \\times \\mathbf{q}$ 进行比较，我们看到了差异。由于叉积是反交换的，$\\mathbf{q} \\times \\mathbf{p} = -(\\mathbf{p} \\times \\mathbf{q})$。这两个向量部分 $\\mathbf{r}$ 和 $\\mathbf{r}'$ 通常是不同的，除非 $\\mathbf{p} \\times \\mathbf{q} = \\mathbf{0}$，这种情况仅在旋转轴平行（$\\mathbf{u}_{p}$ 和 $\\mathbf{u}_{q}$ 共线）时发生。因此，项 $\\mathbf{p} \\times \\mathbf{q}$ 是四元数乘积中非交换性的来源。交换乘法顺序会使该项的符号反转，导致一个不同的向量部分，这对应于一个不同的复合旋转轴。四元数乘法的这种代数性质精确地反映了三维空间中有限旋转不可交换的基本几何性质。\n\n最终要求的 $(r_{0}, r_{1}, r_{2}, r_{3})$ 作为单个行矩阵的解析表达式，是由上面推导的分量表达式构建的。\n$r_{0} = p_{0}q_{0} - p_{1}q_{1} - p_{2}q_{2} - p_{3}q_{3}$\n$r_{1} = p_{0}q_{1} + p_{1}q_{0} + p_{2}q_{3} - p_{3}q_{2}$\n$r_{2} = p_{0}q_{2} + p_{2}q_{0} + p_{3}q_{1} - p_{1}q_{3}$\n$r_{3} = p_{0}q_{3} + p_{3}q_{0} + p_{1}q_{2} - p_{2}q_{1}$\n为了一致性，我们将向量部分重写为：\n$r_{1} = p_{0}q_{1} + p_{1}q_{0} + p_{2}q_{3} - p_{3}q_{2}$\n$r_{2} = p_{0}q_{2} - p_{1}q_{3} + p_{2}q_{0} + p_{3}q_{1}$\n$r_{3} = p_{0}q_{3} + p_{1}q_{2} - p_{2}q_{1} + p_{3}q_{0}$\n这种形式很清晰，并直接关联到向量形式 $\\mathbf{r} = p_{0}\\mathbf{q} + q_{0}\\mathbf{p} + \\mathbf{p} \\times \\mathbf{q}$。",
            "answer": "$$ \\boxed{ \\begin{pmatrix} p_{0}q_{0} - p_{1}q_{1} - p_{2}q_{2} - p_{3}q_{3} & p_{0}q_{1} + p_{1}q_{0} + p_{2}q_{3} - p_{3}q_{2} & p_{0}q_{2} - p_{1}q_{3} + p_{2}q_{0} + p_{3}q_{1} & p_{0}q_{3} + p_{1}q_{2} - p_{2}q_{1} + p_{3}q_{0} \\end{pmatrix} } $$"
        },
        {
            "introduction": "尽管四元数在动力学计算中表现优越，但在实际应用中我们常会遇到以旋转矩阵形式表示的方位数据。本练习旨在架起这两种表示之间的桥梁，重点关注将旋转矩阵转换为等效单位四元数的关键任务。此过程不仅要求推导转换公式，更强调了开发数值稳定算法的实际必要性，这是编写稳健仿真代码的一项至关重要的技能。",
            "id": "3838909",
            "problem": "在刚性晶体夹杂物嵌入连续介质的多尺度材料模拟中，粗尺度上的方向由单位四元数表示，以确保数值稳定的插值和时间积分。一个粗尺度单元报告了以下正交旋转矩阵 $\\mathbf{R} \\in \\mathrm{SO}(3)$，该矩阵将晶格坐标系映射到实验室坐标系：\n$$\n\\mathbf{R} \\;=\\;\n\\begin{pmatrix}\n-\\frac{6}{7} & \\frac{2}{7} & \\frac{3}{7} \\\\\n\\frac{2}{7} & -\\frac{3}{7} & \\frac{6}{7} \\\\\n\\frac{3}{7} & \\frac{6}{7} & \\frac{2}{7}\n\\end{pmatrix}.\n$$\n从三维向量 $\\mathbf{v} \\in \\mathbb{R}^{3}$ 的基本表示法——纯虚四元数 $(0,\\mathbf{v})$ 出发，以及单位四元数 $q = (q_{0},q_{1},q_{2},q_{3})$ 通过四元数共轭 $(0,\\mathbf{v}^{\\prime}) = q\\,(0,\\mathbf{v})\\,q^{-1}$ 作用于 $\\mathbf{v}$ 的定义，推导旋转矩阵各项关于 $q$ 的表达式，并说明如何使用矩阵的迹从 $\\mathbf{R}$ 构造 $q$，并对迹不为正时的数值稳定性进行适当的个案处理。然后，将您的推导应用于给定的 $\\mathbf{R}$，并计算相应的单位四元数 $q$。\n\n施加符号约定 $q_{0} \\ge 0$，如果 $q_{0} = 0$，则要求 $(q_{1},q_{2},q_{3})$ 中的第一个非零分量为非负。将最终的四元数表示为单个行向量 $(q_{0},q_{1},q_{2},q_{3})$，并使用最简精确根式形式。请勿四舍五入。",
            "solution": "问题陈述已经过验证，具有科学依据、提法恰当、客观且完整。它描述了刚体动力学中的一个标准问题，涉及将特殊正交群 $\\mathrm{SO}(3)$ 中的旋转矩阵转换为其对应的单位四元数表示。所提供的矩阵 $\\mathbf{R}$ 已被验证为正交旋转矩阵，满足 $\\mathbf{R}^T\\mathbf{R} = \\mathbf{I}$ 和 $\\det(\\mathbf{R})=1$。该问题要求从第一性原理进行推导，并随后应用所推导的公式，这是一个有效且实质性的任务。我们可以开始解题。\n\n该问题分三部分解决：\n$1$. 从单位四元数 $q$ 推导旋转矩阵 $\\mathbf{R}$。\n$2$. 推导逆关系，从 $\\mathbf{R}$ 求 $q$，包括处理数值稳定性的特殊情况。\n$3$. 将这些公式应用于给定的矩阵 $\\mathbf{R}$，求出特定的四元数 $q$。\n\n设单位四元数为 $q = (q_0, q_1, q_2, q_3) = q_0 + q_1\\mathbf{i} + q_2\\mathbf{j} + q_3\\mathbf{k}$，其中 $q_0$ 是标量部分，$\\mathbf{q} = (q_1, q_2, q_3)$ 是矢量部分。$q$ 作为单位四元数的条件是 $q_0^2 + q_1^2 + q_2^2 + q_3^2 = 1$。一个向量 $\\mathbf{v} \\in \\mathbb{R}^3$ 被表示为一个纯四元数 $v = (0, \\mathbf{v}) = v_x\\mathbf{i} + v_y\\mathbf{j} + v_z\\mathbf{k}$。\n\n**第1部分：从 $q$ 推导 $\\mathbf{R}$**\n\n向量 $\\mathbf{v}$ 到 $\\mathbf{v}'$ 的旋转由四元数共轭给出：\n$$ v' = q v q^{-1} $$\n其中 $v'=(0, \\mathbf{v}')$。对于单位四元数，其逆是其共轭，$q^{-1} = q^* = q_0 - \\mathbf{q}$。两个四元数 $a=(a_0, \\mathbf{a})$ 和 $b=(b_0, \\mathbf{b})$ 的乘法为 $ab = (a_0 b_0 - \\mathbf{a} \\cdot \\mathbf{b}, a_0 \\mathbf{b} + b_0 \\mathbf{a} + \\mathbf{a} \\times \\mathbf{b})$。\n\n首先，我们计算乘积 $qv$：\n$$ qv = (q_0, \\mathbf{q})(0, \\mathbf{v}) = (q_0(0) - \\mathbf{q} \\cdot \\mathbf{v}, q_0\\mathbf{v} + 0\\mathbf{q} + \\mathbf{q} \\times \\mathbf{v}) = (-\\mathbf{q} \\cdot \\mathbf{v}, q_0\\mathbf{v} + \\mathbf{q} \\times \\mathbf{v}) $$\n接下来，我们将此结果乘以 $q^{-1} = (q_0, -\\mathbf{q})$：\n$$ v' = (qv)q^{-1} = (-\\mathbf{q} \\cdot \\mathbf{v}, q_0\\mathbf{v} + \\mathbf{q} \\times \\mathbf{v})(q_0, -\\mathbf{q}) $$\n$v'$ 的标量部分是：\n$$ s' = (-\\mathbf{q} \\cdot \\mathbf{v})q_0 - (q_0\\mathbf{v} + \\mathbf{q} \\times \\mathbf{v}) \\cdot (-\\mathbf{q}) = -q_0(\\mathbf{q} \\cdot \\mathbf{v}) + q_0(\\mathbf{v} \\cdot \\mathbf{q}) + (\\mathbf{q} \\times \\mathbf{v}) \\cdot \\mathbf{q} = 0 $$\n这是预料之中的，因为旋转后的向量必须保持为纯四元数。矢量部分 $\\mathbf{v}'$ 是：\n$$ \\mathbf{v}' = (-\\mathbf{q} \\cdot \\mathbf{v})(-\\mathbf{q}) + q_0(q_0\\mathbf{v} + \\mathbf{q} \\times \\mathbf{v}) + (q_0\\mathbf{v} + \\mathbf{q} \\times \\mathbf{v}) \\times (-\\mathbf{q}) $$\n$$ \\mathbf{v}' = (\\mathbf{q} \\cdot \\mathbf{v})\\mathbf{q} + q_0^2\\mathbf{v} + q_0(\\mathbf{q} \\times \\mathbf{v}) - q_0(\\mathbf{v} \\times \\mathbf{q}) - (\\mathbf{q} \\times \\mathbf{v}) \\times \\mathbf{q} $$\n使用叉积的反交换性 $\\mathbf{v} \\times \\mathbf{q} = -(\\mathbf{q} \\times \\mathbf{v})$ 和向量三重积恒等式 $\\mathbf{a} \\times (\\mathbf{b} \\times \\mathbf{c}) = (\\mathbf{a}\\cdot\\mathbf{c})\\mathbf{b} - (\\mathbf{a}\\cdot\\mathbf{b})\\mathbf{c}$，我们进行简化：\n$$ \\mathbf{v}' = (\\mathbf{q} \\cdot \\mathbf{v})\\mathbf{q} + q_0^2\\mathbf{v} + 2q_0(\\mathbf{q} \\times \\mathbf{v}) - [(\\mathbf{q}\\cdot\\mathbf{q})\\mathbf{v} - (\\mathbf{q}\\cdot\\mathbf{v})\\mathbf{q}] $$\n$$ \\mathbf{v}' = (q_0^2 - \\mathbf{q}\\cdot\\mathbf{q})\\mathbf{v} + 2(\\mathbf{q}\\cdot\\mathbf{v})\\mathbf{q} + 2q_0(\\mathbf{q} \\times \\mathbf{v}) $$\n使用单位范数条件 $q_0^2 + \\mathbf{q}\\cdot\\mathbf{q} = 1$，我们可以写出 $q_0^2 - \\mathbf{q}\\cdot\\mathbf{q} = q_0^2 - (1 - q_0^2) = 2q_0^2 - 1$。\n变换为 $\\mathbf{v}' = \\mathbf{R}\\mathbf{v}$，其中旋转算子 $\\mathbf{R}$ 可以用张量积和向量积表示：\n$$ \\mathbf{R} = (2q_0^2 - 1)\\mathbf{I} + 2\\mathbf{q}\\otimes\\mathbf{q} + 2q_0[\\mathbf{q}]_\\times $$\n这里 $\\mathbf{I}$ 是单位矩阵，$\\mathbf{q}\\otimes\\mathbf{q}$ 是外积 $\\mathbf{q}\\mathbf{q}^T$，$[\\mathbf{q}]_\\times$ 是与 $\\mathbf{q}$ 的叉积的斜对称矩阵表示。以分量形式，这给出了旋转矩阵：\n$$ \\mathbf{R} = \\begin{pmatrix} q_0^2+q_1^2-q_2^2-q_3^2 & 2(q_1q_2 - q_0q_3) & 2(q_1q_3 + q_0q_2) \\\\ 2(q_1q_2 + q_0q_3) & q_0^2-q_1^2+q_2^2-q_3^2 & 2(q_2q_3 - q_0q_1) \\\\ 2(q_1q_3 - q_0q_2) & 2(q_2q_3 + q_0q_1) & q_0^2-q_1^2-q_2^2+q_3^2 \\end{pmatrix} $$\n或者，使用 $q_0^2+q_1^2+q_2^2+q_3^2=1$：\n$$ \\mathbf{R} = \\begin{pmatrix} 1-2(q_2^2+q_3^2) & 2(q_1q_2 - q_0q_3) & 2(q_1q_3 + q_0q_2) \\\\ 2(q_1q_2 + q_0q_3) & 1-2(q_1^2+q_3^2) & 2(q_2q_3 - q_0q_1) \\\\ 2(q_1q_3 - q_0q_2) & 2(q_2q_3 + q_0q_1) & 1-2(q_1^2+q_2^2) \\end{pmatrix} $$\n\n**第2部分：从 $\\mathbf{R}$ 推导 $q$**\n\n$\\mathbf{R}$ 的迹是其对角元素之和：\n$$ \\mathrm{Tr}(\\mathbf{R}) = R_{11} + R_{22} + R_{33} = (q_0^2+q_1^2-q_2^2-q_3^2) + (q_0^2-q_1^2+q_2^2-q_3^2) + (q_0^2-q_1^2-q_2^2+q_3^2) $$\n$$ \\mathrm{Tr}(\\mathbf{R}) = 3q_0^2 - q_1^2 - q_2^2 - q_3^2 = 3q_0^2 - (1 - q_0^2) = 4q_0^2 - 1 $$\n这给出了 $q_0^2$ 的直接表达式：\n$$ 4q_0^2 = \\mathrm{Tr}(\\mathbf{R}) + 1 \\implies q_0 = \\frac{1}{2}\\sqrt{\\mathrm{Tr}(\\mathbf{R}) + 1} $$\n根据问题的符号约定 $q_0 \\ge 0$，我们选择正根。其他分量可以从非对角项中找到：\n$$ R_{32} - R_{23} = 4q_0q_1 \\implies q_1 = \\frac{R_{32} - R_{23}}{4q_0} $$\n$$ R_{13} - R_{31} = 4q_0q_2 \\implies q_2 = \\frac{R_{13} - R_{31}}{4q_0} $$\n$$ R_{21} - R_{12} = 4q_0q_3 \\implies q_3 = \\frac{R_{21} - R_{12}}{4q_0} $$\n如果 $\\mathrm{Tr}(\\mathbf{R})$ 接近 $-1$，即旋转角接近 $\\pi$，这会使 $q_0$ 接近 $0$，此时该方法在数值上是不稳定的。\n\n为了得到一个数值稳定的算法，我们必须处理迹不为正的情况。一般的策略是首先计算 $q$ 中模最大的分量，然后用它来求其他分量。我们从 $\\mathbf{R}$ 的对角元素构造以下关系：\n$$ 4q_0^2 = 1 + R_{11} + R_{22} + R_{33} = 1 + \\mathrm{Tr}(\\mathbf{R}) $$\n$$ 4q_1^2 = 1 + R_{11} - R_{22} - R_{33} $$\n$$ 4q_2^2 = 1 - R_{11} + R_{22} - R_{33} $$\n$$ 4q_3^2 = 1 - R_{11} - R_{22} + R_{33} $$\n算法通过识别右侧的最大值来继续，该最大值对应于 $q$ 的最大分量。\n如果 $q_0$ 最大（即 $\\mathrm{Tr}(\\mathbf{R})$ 在相关项中最大，通常当 $\\mathrm{Tr}(\\mathbf{R})>0$ 时），我们使用上述公式。\n如果 $\\mathrm{Tr}(\\mathbf{R}) \\le 0$ 且 $R_{11}$ 是最大的对角项，那么 $|q_1|$ 是最大的分量。我们计算 $q_1 = \\frac{1}{2}\\sqrt{1 + R_{11} - R_{22} - R_{33}}$ (根据约定或其他值选择符号)，然后求解其他分量：\n$q_0 = \\frac{R_{32}-R_{23}}{4q_1}$，$q_2 = \\frac{R_{12}+R_{21}}{4q_1}$，$q_3 = \\frac{R_{13}+R_{31}}{4q_1}$。\n如果 $R_{22}$ 或 $R_{33}$ 是最大的对角元素，也存在类似的公式。\n\n**第3部分：应用于给定矩阵**\n\n给定的旋转矩阵是：\n$$ \\mathbf{R} = \\begin{pmatrix} -\\frac{6}{7} & \\frac{2}{7} & \\frac{3}{7} \\\\ \\frac{2}{7} & -\\frac{3}{7} & \\frac{6}{7} \\\\ \\frac{3}{7} & \\frac{6}{7} & \\frac{2}{7} \\end{pmatrix} $$\n首先，我们计算迹：\n$$ \\mathrm{Tr}(\\mathbf{R}) = -\\frac{6}{7} - \\frac{3}{7} + \\frac{2}{7} = \\frac{-7}{7} = -1 $$\n迹不为正，表示旋转角为 $\\theta = \\pi$。我们应用稳定方法。从 $\\mathrm{Tr}(\\mathbf{R}) = -1$ 可得：\n$$ q_0 = \\frac{1}{2}\\sqrt{-1+1} = 0 $$\n由于 $q_0=0$，我们必须使用对角元素来找到矢量分量。\n$$ 4q_1^2 = 1 + R_{11} - R_{22} - R_{33} = 1 - \\frac{6}{7} - (-\\frac{3}{7}) - \\frac{2}{7} = \\frac{7-6+3-2}{7} = \\frac{2}{7} \\implies q_1^2 = \\frac{1}{14} $$\n$$ 4q_2^2 = 1 - R_{11} + R_{22} - R_{33} = 1 - (-\\frac{6}{7}) - \\frac{3}{7} - \\frac{2}{7} = \\frac{7+6-3-2}{7} = \\frac{8}{7} \\implies q_2^2 = \\frac{2}{7} $$\n$$ 4q_3^2 = 1 - R_{11} - R_{22} + R_{33} = 1 - (-\\frac{6}{7}) - (-\\frac{3}{7}) + \\frac{2}{7} = \\frac{7+6+3+2}{7} = \\frac{18}{7} \\implies q_3^2 = \\frac{9}{14} $$\n模分别为 $|q_1| = \\frac{1}{\\sqrt{14}}$， $|q_2| = \\sqrt{\\frac{2}{7}}$，以及 $|q_3| = \\frac{3}{\\sqrt{14}}$。\n为了确定符号，我们使用 $\\mathbf{R}$ 的非对角元素。当 $q_0=0$ 时：\n$$ R_{12} = 2q_1q_2 = \\frac{2}{7} \\implies q_1q_2 = \\frac{1}{7} $$\n$$ R_{13} = 2q_1q_3 = \\frac{3}{7} \\implies q_1q_3 = \\frac{3}{14} $$\n$$ R_{23} = 2q_2q_3 = \\frac{6}{7} \\implies q_2q_3 = \\frac{3}{7} $$\n由于所有乘积 $q_iq_j$ 均为正，分量 $q_1, q_2, q_3$ 必须都具有相同的符号（要么全为正，要么全为负）。\n问题施加了符号约定：如果 $q_0=0$，则 $(q_1, q_2, q_3)$ 中的第一个非零分量必须为非负。由于 $q_1$ 非零，我们必须有 $q_1 > 0$。这也意味着 $q_2 > 0$ 和 $q_3 > 0$。\n因此，我们对模取正根：\n$$ q_1 = \\sqrt{\\frac{1}{14}} = \\frac{1}{\\sqrt{14}} = \\frac{\\sqrt{14}}{14} $$\n$$ q_2 = \\sqrt{\\frac{2}{7}} = \\frac{\\sqrt{2}}{\\sqrt{7}} = \\frac{\\sqrt{14}}{7} $$\n$$ q_3 = \\sqrt{\\frac{9}{14}} = \\frac{3}{\\sqrt{14}} = \\frac{3\\sqrt{14}}{14} $$\n最终的四元数是 $q=(q_0, q_1, q_2, q_3)$。\n$$ q = \\left(0, \\frac{\\sqrt{14}}{14}, \\frac{\\sqrt{14}}{7}, \\frac{3\\sqrt{14}}{14}\\right) $$\n最后的检查确认了范数：$q_0^2+q_1^2+q_2^2+q_3^2 = 0 + \\frac{1}{14} + \\frac{2}{7} + \\frac{9}{14} = \\frac{1+4+9}{14} = \\frac{14}{14} = 1$。解是一致的。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n0 & \\frac{\\sqrt{14}}{14} & \\frac{\\sqrt{14}}{7} & \\frac{3\\sqrt{14}}{14}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "在建立了代数和表示方法的基础之后，最后的这个实践将这些概念应用于一个完整的无力矩刚体运动仿真。这个综合性练习涉及实现耦合的运动方程——描述角速度的欧拉方程和描述姿态的四元数运动学方程。通过对这些方程进行数值积分，并验证能量和角动量等物理不变量的守恒，您将亲身体验四元数在精确高效地模拟复杂转动动力学方面的强大能力。",
            "id": "3838888",
            "problem": "考虑一个无转矩刚体，其姿态由单位四元数 $q(t) \\in \\mathbb{H}$ 表示，其在体坐标系中的角速度为 $\\boldsymbol{\\omega}(t) \\in \\mathbb{R}^3$。体坐标系中的主轴惯性张量是对角阵，$I = \\mathrm{diag}(I_1, I_2, I_3)$，其中 $I_1, I_2, I_3 > 0$ 是不同的主转动惯量。该动力学的基础是旋转运动的牛顿第二定律和四元数运动学的定义：\n- 在无转矩情况下，旋转运动的牛顿第二定律表述为 $\\frac{d \\boldsymbol{H}_{\\text{inertial}}}{dt} = \\boldsymbol{0}$，其中 $\\boldsymbol{H}_{\\text{inertial}}$ 是惯性坐标系中的角动量。\n- 在体坐标系中，当 $I$ 为常数时，角动量为 $\\boldsymbol{L} = I \\boldsymbol{\\omega}$，无转矩欧拉方程为 $I \\,\\dot{\\boldsymbol{\\omega}} = \\boldsymbol{L} \\times \\boldsymbol{\\omega}$。\n- 对于四元数运动学，设单位四元数为 $q = (q_0, \\boldsymbol{q_v})$，其标量部分为 $q_0 \\in \\mathbb{R}$，向量部分为 $\\boldsymbol{q_v} \\in \\mathbb{R}^3$。定义与角速度 $\\boldsymbol{\\omega}$ 相关的纯四元数为 $\\omega_q = (0,\\boldsymbol{\\omega})$。将体坐标系向量映射到惯性坐标系向量的主动旋转四元数遵循一阶常微分方程 (ODE) $\\dot{q} = \\frac{1}{2} \\, q \\otimes \\omega_q$，其中 $\\otimes$ 表示四元数乘法。\n\n从这些基础出发，推导 $\\dot{\\boldsymbol{\\omega}}(t)$ 和 $\\dot{q}(t)$ 的耦合常微分方程组。然后，设计并实现一个数值算法，该算法能够：\n- 使用经典的四阶龙格-库塔方法和固定时间步长对无转矩刚体动力学进行积分，并在每一步之后通过重归一化强制施加单位范数约束 $\\lVert q(t) \\rVert = 1$。\n- 在一组密集的时间样本点 $t_k$ 上，计算动能 $T(t_k) = \\frac{1}{2} \\, \\boldsymbol{\\omega}(t_k)^\\top I \\, \\boldsymbol{\\omega}(t_k)$、惯性坐标系角动量矢量 $\\boldsymbol{H}_{\\text{inertial}}(t_k) = R(q(t_k)) \\, I \\, \\boldsymbol{\\omega}(t_k)$ 及其模长 $\\lVert \\boldsymbol{H}_{\\text{inertial}}(t_k) \\rVert$。此处 $R(q)$ 是与四元数 $q$ 对应的旋转矩阵，它将体坐标系中的向量映射到惯性坐标系中，并且是三维特殊正交群 (SO(3)) 的一个元素。\n- 通过计算轨迹上的三个标量诊断量来验证与无转矩运动相关的不变量：动能与其初始值的最大相对偏差，惯性角动量模长与其初始值的最大相对偏差，以及惯性角动量矢量相对于其初始模长的最大相对变化，即\n$$\n\\Delta_T^{\\max} = \\max_k \\left| \\frac{T(t_k) - T(0)}{T(0)} \\right|, \\quad\n\\Delta_{H\\_n}^{\\max} = \\max_k \\left| \\frac{\\lVert \\boldsymbol{H}_{\\text{inertial}}(t_k) \\rVert - \\lVert \\boldsymbol{H}_{\\text{inertial}}(0) \\rVert}{\\lVert \\boldsymbol{H}_{\\text{inertial}}(0) \\rVert} \\right|, \\quad\n\\Delta_{H\\_v}^{\\max} = \\max_k \\left( \\frac{ \\lVert \\boldsymbol{H}_{\\text{inertial}}(t_k) - \\boldsymbol{H}_{\\text{inertial}}(0) \\rVert }{ \\lVert \\boldsymbol{H}_{\\text{inertial}}(0) \\rVert } \\right).\n$$\n所有角度都应以弧度为单位。这些诊断量是无量纲的。\n\n您的程序必须实现上述算法，并在以下参数集测试套件上进行评估，每个参数集由 $(I_1,I_2,I_3)$、$\\boldsymbol{\\omega}(0)$、$q(0)$、最终时间 $t_{\\mathrm{end}}$ 和固定步长 $\\Delta t$ 指定：\n- 测试用例 A（通用各向异性体，中等时间）：$(I_1,I_2,I_3) = (2.0, 1.0, 0.5)$，$\\boldsymbol{\\omega}(0) = (1.0, 0.2, 0.3)$，$q(0) = (1,0,0,0)$，$t_{\\mathrm{end}} = 1.0$，$\\Delta t = 10^{-3}$。\n- 测试用例 B（关于两轴近对称，较长时间）：$(I_1,I_2,I_3) = (1.0, 1.01, 2.0)$，$\\boldsymbol{\\omega}(0) = (0.7, -0.4, 0.5)$，$q(0) = (1,0,0,0)$，$t_{\\mathrm{end}} = 5.0$，$\\Delta t = 5 \\times 10^{-4}$。\n- 测试用例 C（主轴自旋，$\\boldsymbol{\\omega}$ 的演化是平凡的）：$(I_1,I_2,I_3) = (3.0, 2.0, 1.0)$，$\\boldsymbol{\\omega}(0) = (0.0, 0.0, 3.0)$，$q(0) = (1,0,0,0)$，$t_{\\mathrm{end}} = 2.0$，$\\Delta t = 10^{-3}$。\n\n您的程序应产生单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果，每个测试用例的条目是按 $\\left[\\Delta_T^{\\max}, \\Delta_{H\\_n}^{\\max}, \\Delta_{H\\_v}^{\\max}\\right]$ 顺序排列的三个诊断量的子列表。例如，输出格式必须严格符合\n$[\\,[d\\_1,d\\_2,d\\_3],[d\\_1',d\\_2',d\\_3'],[d\\_1'',d\\_2'',d\\_3'']\\,]$\n的形式，字符串中任何地方都不能有空格。每个 $d$ 都必须是十进制浮点数。",
            "solution": "问题陈述已经过严格审查，并被确定为有效。它在科学上基于经典力学原理，在数学上是一个适定的初值问题，并且客观地指定了唯一解所需的所有数据和定义。\n\n该问题要求推导并数值实现无转矩刚体的运动方程。系统在任意时刻 $t$ 的状态由一个7维状态向量 $y(t) = (\\omega_1(t), \\omega_2(t), \\omega_3(t), q_0(t), q_1(t), q_2(t), q_3(t))^\\top$ 描述，该向量结合了体坐标系中的角速度向量 $\\boldsymbol{\\omega} \\in \\mathbb{R}^3$ 和表示姿态的单位四元数 $q \\in \\mathbb{H}$（分量为 $(q_0, q_1, q_2, q_3)$）。该状态的演化由一个一阶常微分方程（ODE）系统 $\\dot{y} = f(y)$ 控制。\n\n系统的第一部分，即控制角速度 $\\boldsymbol{\\omega}$ 的部分，由无转矩欧拉方程给出。问题陈述为 $I \\dot{\\boldsymbol{\\omega}} = \\boldsymbol{L} \\times \\boldsymbol{\\omega}$，其中 $\\boldsymbol{L} = I\\boldsymbol{\\omega}$ 是体坐标系中的角动量，$I = \\mathrm{diag}(I_1, I_2, I_3)$ 是对角惯性张量。展开叉积可得到 $\\dot{\\boldsymbol{\\omega}}$ 的分量方程：\n$$\n\\begin{pmatrix} I_1 \\dot{\\omega}_1 \\\\ I_2 \\dot{\\omega}_2 \\\\ I_3 \\dot{\\omega}_3 \\end{pmatrix}\n=\n\\begin{pmatrix} I_1 \\omega_1 \\\\ I_2 \\omega_2 \\\\ I_3 \\omega_3 \\end{pmatrix}\n\\times\n\\begin{pmatrix} \\omega_1 \\\\ \\omega_2 \\\\ \\omega_3 \\end{pmatrix}\n=\n\\begin{pmatrix} (I_2 - I_3) \\omega_2 \\omega_3 \\\\ (I_3 - I_1) \\omega_3 \\omega_1 \\\\ (I_1 - I_2) \\omega_1 \\omega_2 \\end{pmatrix}\n$$\n解出 $\\dot{\\boldsymbol{\\omega}}$ 可得：\n$$\n\\dot{\\omega}_1 = \\frac{I_2 - I_3}{I_1} \\omega_2 \\omega_3 \\\\\n\\dot{\\omega}_2 = \\frac{I_3 - I_1}{I_2} \\omega_3 \\omega_1 \\\\\n\\dot{\\omega}_3 = \\frac{I_1 - I_2}{I_3} \\omega_1 \\omega_2\n$$\n\n系统的第二部分，即控制姿态四元数 $q$ 的部分，由运动学微分方程 $\\dot{q} = \\frac{1}{2} q \\otimes \\omega_q$ 给出，其中 $\\omega_q = (0, \\boldsymbol{\\omega})$ 是表示角速度的纯四元数。应用四元数乘法规则 $(a_0, \\boldsymbol{a_v}) \\otimes (b_0, \\boldsymbol{b_v}) = (a_0 b_0 - \\boldsymbol{a_v} \\cdot \\boldsymbol{b_v}, a_0 \\boldsymbol{b_v} + b_0 \\boldsymbol{a_v} + \\boldsymbol{a_v} \\times \\boldsymbol{b_v})$，其中 $a=q$，$b=\\omega_q$。这得到：\n$$\n\\dot{q} = \\frac{1}{2} (q_0 \\cdot 0 - \\boldsymbol{q_v} \\cdot \\boldsymbol{\\omega}, q_0 \\boldsymbol{\\omega} + 0 \\cdot \\boldsymbol{q_v} + \\boldsymbol{q_v} \\times \\boldsymbol{\\omega})\n$$\n以分量形式表示，其中 $q = (q_0, q_1, q_2, q_3)$ 且 $\\boldsymbol{\\omega} = (\\omega_1, \\omega_2, \\omega_3)$，$\\dot{q}$ 的方程为：\n$$\n\\dot{q}_0 = \\frac{1}{2} (-q_1 \\omega_1 - q_2 \\omega_2 - q_3 \\omega_3) \\\\\n\\dot{q}_1 = \\frac{1}{2} (q_0 \\omega_1 + q_2 \\omega_3 - q_3 \\omega_2) \\\\\n\\dot{q}_2 = \\frac{1}{2} (q_0 \\omega_2 - q_1 \\omega_3 + q_3 \\omega_1) \\\\\n\\dot{q}_3 = \\frac{1}{2} (q_0 \\omega_3 + q_1 \\omega_2 - q_2 \\omega_1)\n$$\n这可以紧凑地写成矩阵形式 $\\dot{q} = \\frac{1}{2} \\Omega(\\boldsymbol{\\omega}) q$，其中 $\\Omega(\\boldsymbol{\\omega})$ 是一个依赖于 $\\boldsymbol{\\omega}$ 的反对称矩阵。\n\n将这两组方程结合起来，得到7维状态向量 $y$ 的完整ODE系统 $\\dot{y} = f(y, I)$。这个初值问题将使用经典的四阶龙格-库塔 (RK4) 方法进行数值求解。给定时刻 $t_n$ 的状态 $y_n$，时刻 $t_{n+1} = t_n + \\Delta t$ 的状态 $y_{n+1}$ 计算如下：\n$$\ny_{n+1} = y_n + \\frac{1}{6} (k_1 + 2k_2 + 2k_3 + k_4)\n$$\n其中\n$$\n\\begin{aligned}\nk_1 &= \\Delta t \\cdot f(y_n, I) \\\\\nk_2 &= \\Delta t \\cdot f(y_n + \\frac{1}{2}k_1, I) \\\\\nk_3 &= \\Delta t \\cdot f(y_n + \\frac{1}{2}k_2, I) \\\\\nk_4 &= \\Delta t \\cdot f(y_n + k_3, I)\n\\end{aligned}\n$$\nRK4 方法不保证能保持四元数的单位范数。因此，在每个积分步之后，计算出的状态向量的四元数部分 $q_{n+1}$ 必须进行显式重归一化：$q_{n+1} \\leftarrow q_{n+1} / \\lVert q_{n+1} \\rVert$。这个投影步骤确保四元数保持在单位超球面 $S^3$上，从而表示一个有效的旋转。\n\n仿真生成一个状态轨迹 $(y_0, y_1, \\dots, y_N)$。在每一步 $k$，我们计算几个物理量来监控守恒定律。动能 $T$ 由下式给出：\n$$ T(t_k) = \\frac{1}{2} \\boldsymbol{\\omega}(t_k)^\\top I \\boldsymbol{\\omega}(t_k) = \\frac{1}{2} (I_1 \\omega_1^2(t_k) + I_2 \\omega_2^2(t_k) + I_3 \\omega_3^2(t_k)) $$\n对于无转矩运动，$T$ 必须是守恒的。\n在惯性坐标系中的角动量 $\\boldsymbol{H}_{\\text{inertial}}$ 是恒定的，因为没有外部转矩。它通过使用旋转矩阵 $R(q(t_k))$ 将体坐标系角动量 $\\boldsymbol{L}(t_k) = I \\boldsymbol{\\omega}(t_k)$ 转换到惯性坐标系来计算：\n$$ \\boldsymbol{H}_{\\text{inertial}}(t_k) = R(q(t_k)) \\boldsymbol{L}(t_k) $$\n对于单位四元数 $q=(q_0, q_1, q_2, q_3)$，将向量从体坐标系主动旋转到惯性坐标系的旋转矩阵 $R(q)$ 是：\n$$\nR(q) =\n\\begin{pmatrix}\n1 - 2(q_2^2 + q_3^2) & 2(q_1 q_2 - q_0 q_3) & 2(q_1 q_3 + q_0 q_2) \\\\\n2(q_1 q_2 + q_0 q_3) & 1 - 2(q_1^2 + q_3^2) & 2(q_2 q_3 - q_0 q_1) \\\\\n2(q_1 q_3 - q_0 q_2) & 2(q_2 q_3 + q_0 q_1) & 1 - 2(q_1^2 + q_2^2)\n\\end{pmatrix}\n$$\n向量 $\\boldsymbol{H}_{\\text{inertial}}$ 及其模长 $\\lVert \\boldsymbol{H}_{\\text{inertial}} \\rVert$ 都必须是守恒的。\n\n最后，在仿真完成后，计算三个诊断指标来量化这些守恒量中的数值误差。使用存储的 $T(t_k)$ 和 $\\boldsymbol{H}_{\\text{inertial}}(t_k)$ 的历史记录，根据指定的公式计算最大相对偏差：\n$$\n\\Delta_T^{\\max} = \\max_k \\left| \\frac{T(t_k) - T(0)}{T(0)} \\right|, \\quad\n\\Delta_{H\\_n}^{\\max} = \\max_k \\left| \\frac{\\lVert \\boldsymbol{H}_{\\text{inertial}}(t_k) \\rVert - \\lVert \\boldsymbol{H}_{\\text{inertial}}(0) \\rVert}{\\lVert \\boldsymbol{H}_{\\text{inertial}}(0) \\rVert} \\right|, \\quad\n\\Delta_{H\\_v}^{\\max} = \\max_k \\left( \\frac{ \\lVert \\boldsymbol{H}_{\\text{inertial}}(t_k) - \\boldsymbol{H}_{\\text{inertial}}(0) \\rVert }{ \\lVert \\boldsymbol{H}_{\\text{inertial}}(0) \\rVert } \\right)\n$$\n这些诊断量为算法在积分周期内的准确性和稳定性提供了一个度量。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef q_to_rot_matrix(q):\n    \"\"\"Converts a unit quaternion to a rotation matrix.\"\"\"\n    q0, q1, q2, q3 = q[0], q[1], q[2], q[3]\n    \n    # Per the problem description, this matrix maps body vectors to inertial vectors.\n    r11 = 1.0 - 2.0 * (q2**2 + q3**2)\n    r12 = 2.0 * (q1 * q2 - q0 * q3)\n    r13 = 2.0 * (q1 * q3 + q0 * q2)\n    \n    r21 = 2.0 * (q1 * q2 + q0 * q3)\n    r22 = 1.0 - 2.0 * (q1**2 + q3**2)\n    r23 = 2.0 * (q2 * q3 - q0 * q1)\n    \n    r31 = 2.0 * (q1 * q3 - q0 * q2)\n    r32 = 2.0 * (q2 * q3 + q0 * q1)\n    r33 = 1.0 - 2.0 * (q1**2 + q2**2)\n    \n    return np.array([[r11, r12, r13], [r21, r22, r23], [r31, r32, r33]])\n\ndef derivatives(state, I_vec):\n    \"\"\"\n    Computes the time derivative of the state vector [omega, q].\n    state: 7-element array (w1, w2, w3, q0, q1, q2, q3)\n    I_vec: 3-element array of principal moments of inertia (I1, I2, I3)\n    \"\"\"\n    omega = state[:3]\n    q = state[3:]\n    I1, I2, I3 = I_vec[0], I_vec[1], I_vec[2]\n\n    # Euler's equations for d(omega)/dt\n    omega_dot = np.array([\n        (I2 - I3) / I1 * omega[1] * omega[2],\n        (I3 - I1) / I2 * omega[2] * omega[0],\n        (I1 - I2) / I3 * omega[0] * omega[1]\n    ])\n\n    # Quaternion kinematics for dq/dt\n    # dq/dt = 0.5 * q * omega_q\n    q_dot = 0.5 * np.array([\n        -q[1]*omega[0] - q[2]*omega[1] - q[3]*omega[2],\n         q[0]*omega[0] + q[2]*omega[2] - q[3]*omega[1],\n         q[0]*omega[1] - q[1]*omega[2] + q[3]*omega[0],\n         q[0]*omega[2] + q[1]*omega[1] - q[2]*omega[0]\n    ])\n    \n    return np.concatenate((omega_dot, q_dot))\n\ndef run_simulation(I_vec, omega0, q0, t_end, dt):\n    \"\"\"\n    Integrates rigid body dynamics and computes diagnostic metrics.\n    \"\"\"\n    I_mat = np.diag(I_vec)\n    num_steps = int(round(t_end / dt))\n    \n    # Store trajectory history for post-processing\n    omega_hist = np.zeros((num_steps + 1, 3))\n    q_hist = np.zeros((num_steps + 1, 4))\n    \n    current_state = np.concatenate((omega0, q0))\n    omega_hist[0] = current_state[:3]\n    q_hist[0] = current_state[3:]\n\n    # Main integration loop\n    for i in range(num_steps):\n        # RK4 step\n        k1 = derivatives(current_state, I_vec)\n        k2 = derivatives(current_state + 0.5 * dt * k1, I_vec)\n        k3 = derivatives(current_state + 0.5 * dt * k2, I_vec)\n        k4 = derivatives(current_state + dt * k3, I_vec)\n        \n        current_state += (dt / 6.0) * (k1 + 2*k2 + 2*k3 + k4)\n        \n        # Enforce unit-norm constraint on quaternion by renormalization\n        q_part = current_state[3:]\n        norm = np.linalg.norm(q_part)\n        current_state[3:] = q_part / norm if norm > 0 else q_part\n        \n        omega_hist[i+1] = current_state[:3]\n        q_hist[i+1] = current_state[3:]\n\n    # Post-processing to calculate diagnostics\n    \n    # Calculate initial values of conserved quantities\n    T0 = 0.5 * omega_hist[0] @ I_mat @ omega_hist[0]\n    L0_body = I_mat @ omega_hist[0]\n    R0 = q_to_rot_matrix(q_hist[0])\n    H0_inertial = R0 @ L0_body\n    H0_norm = np.linalg.norm(H0_inertial)\n\n    # Avoid division by zero if initial state is at rest (not the case here).\n    T0_denom = T0 if T0 != 0 else 1.0\n    H0_norm_denom = H0_norm if H0_norm != 0 else 1.0\n\n    max_dev_T = 0.0\n    max_dev_H_norm = 0.0\n    max_dev_H_vec = 0.0\n    \n    for i in range(1, num_steps + 1):\n        omega_k = omega_hist[i]\n        q_k = q_hist[i]\n        \n        # Kinetic energy deviation\n        T_k = 0.5 * omega_k @ I_mat @ omega_k\n        dev_T = np.abs((T_k - T0) / T0_denom)\n        if dev_T > max_dev_T:\n            max_dev_T = dev_T\n            \n        # Inertial angular momentum deviations\n        L_k_body = I_mat @ omega_k\n        R_k = q_to_rot_matrix(q_k)\n        H_k_inertial = R_k @ L_k_body\n        H_k_norm = np.linalg.norm(H_k_inertial)\n        \n        dev_H_norm = np.abs((H_k_norm - H0_norm) / H0_norm_denom)\n        if dev_H_norm > max_dev_H_norm:\n            max_dev_H_norm = dev_H_norm\n            \n        dev_H_vec = np.linalg.norm(H_k_inertial - H0_inertial) / H0_norm_denom\n        if dev_H_vec > max_dev_H_vec:\n            max_dev_H_vec = dev_H_vec\n            \n    return [max_dev_T, max_dev_H_norm, max_dev_H_vec]\n\ndef solve():\n    \"\"\"\n    Main function to run test cases and print results.\n    \"\"\"\n    test_cases = [\n        # Case A: General anisotropic body\n        {'I_vec': np.array([2.0, 1.0, 0.5]), 'omega0': np.array([1.0, 0.2, 0.3]), \n         'q0': np.array([1.0, 0.0, 0.0, 0.0]), 't_end': 1.0, 'dt': 1e-3},\n        # Case B: Near-symmetric body\n        {'I_vec': np.array([1.0, 1.01, 2.0]), 'omega0': np.array([0.7, -0.4, 0.5]), \n         'q0': np.array([1.0, 0.0, 0.0, 0.0]), 't_end': 5.0, 'dt': 5e-4},\n        # Case C: Principal-axis spin\n        {'I_vec': np.array([3.0, 2.0, 1.0]), 'omega0': np.array([0.0, 0.0, 3.0]), \n         'q0': np.array([1.0, 0.0, 0.0, 0.0]), 't_end': 2.0, 'dt': 1e-3}\n    ]\n\n    results = []\n    for case in test_cases:\n        diagnostics = run_simulation(\n            case['I_vec'], case['omega0'], case['q0'], case['t_end'], case['dt']\n        )\n        results.append(diagnostics)\n\n    # Format output string exactly as specified: [[d1,d2,d3],[d'1,d'2,d'3],...]\n    sub_lists_str = [f\"[{','.join(map(str, res))}]\" for res in results]\n    final_output = f\"[{','.join(sub_lists_str)}]\"\n    print(final_output)\n\nsolve()\n```"
        }
    ]
}