{
    "hands_on_practices": [
        {
            "introduction": "重要性抽样的核心目标是减少蒙特卡洛估计的方差。这个练习将通过一个经典的例子，让你亲手推导方差如何依赖于提议分布，并找出最优的提议分布形式。通过这个过程 ，你将深刻理解为何选择一个与被积函数形状相似的分布是降低方差的关键。",
            "id": "3253345",
            "problem": "考虑使用带有重要性采样（IS）的蒙特卡洛（MC）积分方法来数值计算反常积分 $I=\\int_{0}^{\\infty} \\exp(-x)\\,dx$。令提议密度为指数族 $q(x;\\lambda)=\\lambda \\exp(-\\lambda x)$，其中 $x \\ge 0$ 且 $\\lambda>0$。您将构建单样本 IS 估计量，并分析其方差作为参数 $\\lambda$ 的函数。仅从 MC 积分和 IS 的定义出发（即 IS 将积分替换为在提议密度下的期望，并使用权重 $w(x)=\\frac{f(x)}{q(x;\\lambda)}$），完成以下任务：\n\n1. 基于从 $q(\\cdot;\\lambda)$ 中抽取的一个样本 $X\\sim q(\\cdot;\\lambda)$，推导出 $I$ 的单样本 IS 估计量 $\\widehat{I}$，并证明对于任何 $\\lambda>0$，它都是无偏的。\n2. 推导出方差 $\\operatorname{Var}_{q(\\cdot;\\lambda)}[\\widehat{I}]$ 作为 $\\lambda$ 的函数，并精确确定对于哪些 $\\lambda$ 该方差是有限的。\n3. 在所有 $\\lambda>0$ 中，找到使 $\\operatorname{Var}_{q(\\cdot;\\lambda)}[\\widehat{I}]$ 最小化的 $\\lambda$ 值。\n\n将您的最终答案表示为最小化方差的唯一最优 $\\lambda$ 值。无需四舍五入。",
            "solution": "所述问题是适定的、自洽的且科学上合理的。它是数值方法领域，特别是蒙特卡洛积分理论中的一个标准问题。我们可以开始求解。\n\n待估计的积分为 $I = \\int_{0}^{\\infty} \\exp(-x)\\,dx$。被积函数是 $f(x) = \\exp(-x)$。该积分的真实值为 $I = [-\\exp(-x)]_{0}^{\\infty} = 0 - (-1) = 1$。\n提议概率密度函数由指数分布给出，$q(x;\\lambda) = \\lambda \\exp(-\\lambda x)$，其中 $x \\ge 0$ 且参数 $\\lambda > 0$。\n\n根据重要性采样（IS）的原理，积分 $I$ 可以重写为关于提议分布 $q(x;\\lambda)$ 的期望：\n$$I = \\int_{0}^{\\infty} f(x) \\,dx = \\int_{0}^{\\infty} \\frac{f(x)}{q(x;\\lambda)} q(x;\\lambda) \\,dx = \\mathbb{E}_{X \\sim q(\\cdot;\\lambda)}[W(X)]$$\n其中 $W(x) = \\frac{f(x)}{q(x;\\lambda)}$ 是重要性权重。\n\n1. 单样本 IS 估计量的推导及无偏性证明。\n\n单样本重要性采样估计量 $\\widehat{I}$ 是通过从提议分布 $q(x;\\lambda)$ 中抽取的一个样本 $X$ 构建的。该估计量就是重要性权重在该样本处的取值：\n$$\\widehat{I} = W(X) = \\frac{f(X)}{q(X;\\lambda)}$$\n代入给定的函数 $f(x)$ 和 $q(x;\\lambda)$：\n$$W(x) = \\frac{\\exp(-x)}{\\lambda \\exp(-\\lambda x)} = \\frac{1}{\\lambda} \\exp(-x + \\lambda x) = \\frac{1}{\\lambda} \\exp(x(\\lambda-1))$$\n因此，单样本估计量为 $\\widehat{I} = \\frac{1}{\\lambda} \\exp(X(\\lambda-1))$，其中 $X \\sim q(\\cdot;\\lambda)$。\n\n为了证明该估计量对于任何 $\\lambda > 0$ 都是无偏的，我们必须证明其期望值等于积分的真实值 $I$。期望是关于提议分布 $q(x;\\lambda)$ 计算的。\n$$\\mathbb{E}_{q}[\\widehat{I}] = \\int_{0}^{\\infty} \\widehat{I}(x) q(x;\\lambda) \\,dx$$\n$$\\mathbb{E}_{q}[\\widehat{I}] = \\int_{0}^{\\infty} \\left( \\frac{1}{\\lambda} \\exp(x(\\lambda-1)) \\right) (\\lambda \\exp(-\\lambda x)) \\,dx$$\n$$\\mathbb{E}_{q}[\\widehat{I}] = \\int_{0}^{\\infty} \\exp(x(\\lambda-1) - \\lambda x) \\,dx$$\n$$\\mathbb{E}_{q}[\\widehat{I}] = \\int_{0}^{\\infty} \\exp(\\lambda x - x - \\lambda x) \\,dx$$\n$$\\mathbb{E}_{q}[\\widehat{I}] = \\int_{0}^{\\infty} \\exp(-x) \\,dx = I$$\n因为我们已经计算出 $I=1$，所以我们有 $\\mathbb{E}_{q}[\\widehat{I}] = 1$。这对任何使推导有效的 $\\lambda > 0$（即所有 $\\lambda > 0$）都成立。因此，估计量 $\\widehat{I}$ 是无偏的。\n\n2. 方差的推导及其有限性定义域。\n\n估计量 $\\widehat{I}$ 的方差由 $\\operatorname{Var}_{q}[\\widehat{I}] = \\mathbb{E}_{q}[\\widehat{I}^2] - (\\mathbb{E}_{q}[\\widehat{I}])^2$ 给出。\n由于该估计量是无偏的，且 $\\mathbb{E}_{q}[\\widehat{I}]=1$，方差可简化为：\n$$\\operatorname{Var}_{q}[\\widehat{I}] = \\mathbb{E}_{q}[\\widehat{I}^2] - 1^2 = \\mathbb{E}_{q}[\\widehat{I}^2] - 1$$\n我们首先计算二阶矩 $\\mathbb{E}_{q}[\\widehat{I}^2]$：\n$$\\mathbb{E}_{q}[\\widehat{I}^2] = \\int_{0}^{\\infty} \\widehat{I}(x)^2 q(x;\\lambda) \\,dx = \\int_{0}^{\\infty} \\left(\\frac{f(x)}{q(x;\\lambda)}\\right)^2 q(x;\\lambda) \\,dx = \\int_{0}^{\\infty} \\frac{f(x)^2}{q(x;\\lambda)} \\,dx$$\n代入 $f(x)$ 和 $q(x;\\lambda)$ 的表达式：\n$$f(x)^2 = (\\exp(-x))^2 = \\exp(-2x)$$\n$$\\mathbb{E}_{q}[\\widehat{I}^2] = \\int_{0}^{\\infty} \\frac{\\exp(-2x)}{\\lambda \\exp(-\\lambda x)} \\,dx = \\frac{1}{\\lambda} \\int_{0}^{\\infty} \\exp(-2x+\\lambda x) \\,dx$$\n$$\\mathbb{E}_{q}[\\widehat{I}^2] = \\frac{1}{\\lambda} \\int_{0}^{\\infty} \\exp(-x(2-\\lambda)) \\,dx$$\n该积分的形式为 $\\int_0^\\infty \\exp(-ax) \\,dx$，其收敛的充要条件是系数 $a$ 严格为正。在我们的例子中，$a = 2-\\lambda$。因此，为了使积分收敛且方差有限，我们必须有 $2-\\lambda > 0$，这意味着 $\\lambda  2$。\n考虑到问题中 $\\lambda > 0$ 的约束，方差仅在 $\\lambda \\in (0, 2)$ 时是有限的。\n\n对于 $\\lambda \\in (0, 2)$，我们可以计算该积分：\n$$\\int_{0}^{\\infty} \\exp(-x(2-\\lambda)) \\,dx = \\left[ \\frac{\\exp(-x(2-\\lambda))}{-(2-\\lambda)} \\right]_0^\\infty = 0 - \\frac{1}{-(2-\\lambda)} = \\frac{1}{2-\\lambda}$$\n因此，二阶矩为：\n$$\\mathbb{E}_{q}[\\widehat{I}^2] = \\frac{1}{\\lambda} \\cdot \\frac{1}{2-\\lambda} = \\frac{1}{\\lambda(2-\\lambda)}$$\n方差作为 $\\lambda$ 的函数是：\n$$\\operatorname{Var}_{q(\\cdot;\\lambda)}[\\widehat{I}] = V(\\lambda) = \\frac{1}{\\lambda(2-\\lambda)} - 1 \\quad \\text{for } \\lambda \\in (0, 2)$$\n\n3. 寻找 $\\lambda$ 的最优值。\n\n我们旨在找到使方差 $V(\\lambda)$ 最小的 $\\lambda \\in (0, 2)$ 的值。\n$$V(\\lambda) = \\frac{1}{2\\lambda - \\lambda^2} - 1$$\n最小化 $V(\\lambda)$ 等价于最小化项 $\\frac{1}{2\\lambda - \\lambda^2}$，因为 $-1$ 是一个常数偏移。而最小化这个分数又等价于在区间 $\\lambda \\in (0, 2)$ 上最大化其分母 $g(\\lambda) = 2\\lambda - \\lambda^2$。\n\n为了找到 $g(\\lambda)$ 的最大值，我们计算它关于 $\\lambda$ 的导数，并令其为零：\n$$\\frac{dg}{d\\lambda} = \\frac{d}{d\\lambda}(2\\lambda - \\lambda^2) = 2 - 2\\lambda$$\n令导数为零：\n$$2 - 2\\lambda = 0 \\implies 2\\lambda = 2 \\implies \\lambda = 1$$\n这个临界点 $\\lambda=1$ 位于定义域 $(0, 2)$ 内。为确认它是一个最大值点，我们考察二阶导数：\n$$\\frac{d^2g}{d\\lambda^2} = -2$$\n由于二阶导数为负，函数 $g(\\lambda)$ 在 $\\lambda=1$ 处有一个局部最大值。因为 $g(\\lambda)$ 是一个开口向下的抛物线，所以这也是它的全局最大值。\n因此，方差 $V(\\lambda)$ 在 $\\lambda=1$ 时被最小化。\n\n这个结果在概念上是合理的。IS 的理想提议分布是与被积函数 $f(x)$ 成正比的分布。我们被积函数的归一化版本是 $p(x) = \\frac{f(x)}{I} = \\frac{\\exp(-x)}{1} = \\exp(-x)$，这是一个参数为 1 的指数分布。通过选择 $\\lambda=1$，我们的提议分布 $q(x;1) = 1 \\cdot \\exp(-1 \\cdot x)$ 变得与这个理想选择完全相同。在这种情况下，重要性权重对于所有 $x$ 都变为 $W(x) = \\frac{\\exp(-x)}{\\exp(-x)} = 1$，并且估计量 $\\widehat{I}$ 始终为 1。一个常数的方差为零，这是可能的最小方差。\n最小化方差的 $\\lambda$ 值为 $1$。",
            "answer": "$$\\boxed{1}$$"
        },
        {
            "introduction": "在实际应用中，理想的提议分布通常是未知的，因此我们需要工具来评估所选分布的性能。这个练习将介绍一个关键的诊断工具——有效样本量（$N_{\\mathrm{eff}}$），它用于量化样本权重的退化问题。通过处理一组模拟真实材料模拟中可能出现的“重尾”权重 ，你将学会如何计算 $N_{\\mathrm{eff}}$ 并判断何时需要采取重采样等措施来稳定你的估计。",
            "id": "3816828",
            "problem": "在一个多尺度材料模拟中，您需要估计一个精细尺度的可观测量，其中原子态 $\\mathbf{x}$ 根据与高保真势 $U_{\\mathrm{f}}(\\mathbf{x})$ 相关的玻尔兹曼目标密度 $p(\\mathbf{x}) \\propto \\exp\\!\\left(-U_{\\mathrm{f}}(\\mathbf{x})/k_{B}T\\right)$ 分布。为了减小方差，您从一个粗粒化提议密度 $q(\\mathbf{x}) \\propto \\exp\\!\\left(-U_{\\mathrm{c}}(\\mathbf{x})/k_{B}T\\right)$ 中采样，并使用权重 $w(\\mathbf{x}) = p(\\mathbf{x})/q(\\mathbf{x}) = \\exp\\!\\left(-\\big(U_{\\mathrm{f}}(\\mathbf{x})-U_{\\mathrm{c}}(\\mathbf{x})\\big)/k_{B}T\\right)$ 构建一个重要性采样 (IS) 估计器。在这种情况下，表现出局域缺陷或高应变微观结构的材料构型会因为 $\\big(U_{\\mathrm{f}}(\\mathbf{x})-U_{\\mathrm{c}}(\\mathbf{x})\\big)$ 的巨大负值而产生一个 $w(\\mathbf{x})$ 的重尾分布。\n\n假设您从 $q(\\mathbf{x})$ 中收集了 $N$ 个独立样本 $\\{\\mathbf{x}_{i}\\}_{i=1}^{N}$，其对应的合成权重如下\n$$\nw_{1}=0.012,\\quad\nw_{2}=0.019,\\quad\nw_{3}=0.011,\\quad\nw_{4}=0.024,\\quad\nw_{5}=0.031,\\quad\nw_{6}=0.022,\\quad\nw_{7}=0.018,\\quad\nw_{8}=0.015,\\quad\nw_{9}=0.028,\\quad\nw_{10}=2.5,\\quad\nw_{11}=6.0,\\quad\nw_{12}=120.0,\n$$\n这些权重旨在模拟来自稀有但占主导地位的精细尺度贡献的重尾行为。将该估计器视为自归一化的，其归一化权重为 $\\tilde{w}_{i} = w_{i}/\\sum_{j=1}^{N} w_{j}$。\n\n从 Monte Carlo (MC) 和 Importance Sampling (IS) 的基本定义出发，并使用一个将归一化权重的二阶矩与在“有效”样本数上的均匀加权的二阶矩相等的权重集中度原则性概念，从第一性原理推导出有效样本量 (ESS)（表示为 $N_{\\mathrm{eff}}$）的数学上一致的表达式，该表达式用 $\\{w_{i}\\}_{i=1}^{N}$ 表示。然后，计算给定权重的 $N_{\\mathrm{eff}}$，并使用 Sequential Monte Carlo (SMC) 的重采样准则“当 $N_{\\mathrm{eff}}  \\tau$ 且 $\\tau = 0.5N$ 时进行重采样”，判断是否需要重采样来稳定 IS 估计。\n\n将您的 $N_{\\mathrm{eff}}$ 四舍五入到四位有效数字。仅提供 $N_{\\mathrm{eff}}$ 的最终数值答案。无需物理单位。",
            "solution": "该问题要求在自归一化重要性采样 (IS) 的背景下，推导有效样本量 ($N_{\\mathrm{eff}}$) 的表达式，然后计算给定一组合成权重的 $N_{\\mathrm{eff}}$，并判断是否需要重采样。\n\n首先，我们建立重要性采样的基本原理。目标是估计可观测量 $A(\\mathbf{x})$ 关于目标概率密度 $p(\\mathbf{x})$ 的期望，定义为 $\\langle A \\rangle_{p} = \\int A(\\mathbf{x}) p(\\mathbf{x}) d\\mathbf{x}$。直接从 $p(\\mathbf{x})$ 采样可能很困难。取而代之，我们从一个提议密度 $q(\\mathbf{x})$ 中抽取 $N$ 个独立样本 $\\{\\mathbf{x}_i\\}_{i=1}^N$。期望可以重写为：\n$$\n\\langle A \\rangle_{p} = \\int A(\\mathbf{x}) \\frac{p(\\mathbf{x})}{q(\\mathbf{x})} q(\\mathbf{x}) d\\mathbf{x} = \\int A(\\mathbf{x}) w(\\mathbf{x}) q(\\mathbf{x}) d\\mathbf{x} = \\mathbb{E}_{q}[A(\\mathbf{x})w(\\mathbf{x})]\n$$\n其中 $w(\\mathbf{x}) = p(\\mathbf{x})/q(\\mathbf{x})$ 是重要性权重。该期望的标准 Monte Carlo 估计器是 $\\frac{1}{N} \\sum_{i=1}^N w(\\mathbf{x}_i) A(\\mathbf{x}_i)$。\n\n在许多实际应用中，例如所描述的涉及玻尔兹曼分布的应用，$p(\\mathbf{x})$ 和 $q(\\mathbf{x})$ 的归一化常数是未知的。我们只能得到未归一化的密度 $p(\\mathbf{x}) \\propto \\bar{p}(\\mathbf{x})$ 和 $q(\\mathbf{x}) \\propto \\bar{q}(\\mathbf{x})$。未归一化的权重为 $w_i = \\bar{p}(\\mathbf{x}_i) / \\bar{q}(\\mathbf{x}_i)$。在这种情况下，使用自归一化 IS 估计器：\n$$\n\\langle A \\rangle_{p} \\approx \\frac{\\sum_{i=1}^N w_i A(\\mathbf{x}_i)}{\\sum_{j=1}^N w_j} = \\sum_{i=1}^N \\tilde{w}_i A(\\mathbf{x}_i)\n$$\n其中 $\\tilde{w}_i = w_i / \\sum_{j=1}^N w_j$ 是归一化权重，它们满足 $\\sum_{i=1}^N \\tilde{w}_i = 1$。\n\n该估计器的方差高度依赖于权重的方差。如果少数几个权重远大于其他权重，那么总和将由这少数几项主导，从而有效减少了对估计有贡献的样本数量。有效样本量 ($N_{\\mathrm{eff}}$) 是一个用于量化这种性能退化的启发式度量。\n\n我们的任务是基于将归一化权重的二阶矩与“有效”样本数上的均匀加权的二阶矩相等的原则，推导出 $N_{\\mathrm{eff}}$ 的表达式。\n\n设实际的归一化权重集为 $\\{\\tilde{w}_i\\}_{i=1}^N$。该权重分布的二阶矩由下式给出：\n$$\nM_2 = \\sum_{i=1}^N \\tilde{w}_i^2\n$$\n现在，考虑一个大小为 $N_{\\mathrm{eff}}$ 的理想样本，其中所有权重都是均匀的。为了满足归一化条件，这些理想权重中的每一个都必须是 $\\tilde{w}_{\\mathrm{ideal}} = 1/N_{\\mathrm{eff}}$。这个理想、均匀权重分布的二阶矩是：\n$$\nM_{2, \\mathrm{ideal}} = \\sum_{j=1}^{N_{\\mathrm{eff}}} \\left(\\frac{1}{N_{\\mathrm{eff}}}\\right)^2 = N_{\\mathrm{eff}} \\cdot \\frac{1}{N_{\\mathrm{eff}}^2} = \\frac{1}{N_{\\mathrm{eff}}}\n$$\n根据问题的要求，令两个二阶矩相等，$M_2 = M_{2, \\mathrm{ideal}}$，我们得到：\n$$\n\\sum_{i=1}^N \\tilde{w}_i^2 = \\frac{1}{N_{\\mathrm{eff}}}\n$$\n解出 $N_{\\mathrm{eff}}$ 即可从第一性原理得到所求的表达式：\n$$\nN_{\\mathrm{eff}} = \\frac{1}{\\sum_{i=1}^N \\tilde{w}_i^2}\n$$\n这个表达式可以用未归一化的权重 $\\{w_i\\}_{i=1}^N$ 来重写，这通常更便于计算。代入 $\\tilde{w}_i = w_i / \\sum_{j=1}^N w_j$：\n$$\nN_{\\mathrm{eff}} = \\frac{1}{\\sum_{i=1}^N \\left(\\frac{w_i}{\\sum_{j=1}^N w_j}\\right)^2} = \\frac{1}{\\frac{\\sum_{i=1}^N w_i^2}{\\left(\\sum_{j=1}^N w_j\\right)^2}} = \\frac{\\left(\\sum_{i=1}^N w_i\\right)^2}{\\sum_{i=1}^N w_i^2}\n$$\n这就是根据指定原理推导出的有效样本量的数学上一致的表达式。\n\n接下来，我们为给定的 $N=12$ 个合成权重计算 $N_{\\mathrm{eff}}$：\n$w_1=0.012$, $w_2=0.019$, $w_3=0.011$, $w_4=0.024$, $w_5=0.031$, $w_6=0.022$, $w_7=0.018$, $w_8=0.015$, $w_9=0.028$, $w_{10}=2.5$, $w_{11}=6.0$, $w_{12}=120.0$。\n\n我们需要两个量：权重之和 $S_1 = \\sum_{i=1}^{12} w_i$，以及权重的平方和 $S_2 = \\sum_{i=1}^{12} w_i^2$。\n\n计算 $S_1$：\n$$\nS_1 = 0.012+0.019+0.011+0.024+0.031+0.022+0.018+0.015+0.028+2.5+6.0+120.0 = 128.68\n$$\n计算 $S_2$：\n\\begin{align*}\nS_2 = (0.012)^2 + (0.019)^2 + (0.011)^2 + (0.024)^2 + (0.031)^2 + (0.022)^2 + (0.018)^2 + (0.015)^2 + (0.028)^2 \\\\\n   \\quad + (2.5)^2 + (6.0)^2 + (120.0)^2 \\\\\n   = 0.000144 + 0.000361 + 0.000121 + 0.000576 + 0.000961 + 0.000484 + 0.000324 + 0.000225 + 0.000784 \\\\\n   \\quad + 6.25 + 36.0 + 14400.0 \\\\\n   = 0.00398 + 6.25 + 36.0 + 14400.0 = 14442.25398\n\\end{align*}\n现在，我们使用推导出的 $N_{\\mathrm{eff}}$ 公式：\n$$\nN_{\\mathrm{eff}} = \\frac{S_1^2}{S_2} = \\frac{(128.68)^2}{14442.25398} = \\frac{16558.6224}{14442.25398} \\approx 1.1465319...\n$$\n按要求四舍五入到四位有效数字，我们得到：\n$$\nN_{\\mathrm{eff}} \\approx 1.147\n$$\n最后，我们使用准则“当 $N_{\\mathrm{eff}}  \\tau$ 且 $\\tau = 0.5N$ 时进行重采样”来判断是否需要重采样。\n总样本数为 $N = 12$。重采样阈值为：\n$$\n\\tau = 0.5 \\times N = 0.5 \\times 12 = 6\n$$\n我们将计算出的 $N_{\\mathrm{eff}}$ 与此阈值进行比较：\n$$\n1.147  6\n$$\n条件 $N_{\\mathrm{eff}}  \\tau$ 得到满足。因此，有必要采取重采样步骤来减轻高方差并稳定重要性采样估计。$N_{\\mathrm{eff}}$ 的低值正确地反映了权重在单个样本 ($w_{12}$) 上的极端集中情况，这使得其余的11个样本几乎无关紧要。",
            "answer": "$$\n\\boxed{1.147}\n$$"
        },
        {
            "introduction": "重要性抽样的威力远不止于简单积分，它更是偏置复杂随机过程（如分子动力学模拟）的强大工具。这个高级练习将重要性抽样应用于随机微分方程描述的路径抽样领域，以模拟材料科学中的稀有事件。通过为一个在外力引导下跨越势垒的反应路径推导其重要性权重 ，你不仅能将理论与前沿研究联系起来，还能通过编程实践，巩固对动态过程中重要性抽样的理解。",
            "id": "3816803",
            "problem": "考虑一个一维反应坐标 $r$，它描述了纳米颗粒中一个表面原子的集体跃迁路径。我们使用过阻尼朗之万动力学（一种伊东随机微分方程）来近似沿 $r$ 的随机动力学，其迁移率为 $\\mu$，扩散系数为 $D$，并在一个能稳定两个亚稳态盆地的双势阱 $U(r)$ 下进行。目标是在蒙特卡洛（MC）路径采样中构建一个重要性采样（IS）方案，该方案能提出带有朝向目标反应坐标 $r_{\\star}$ 的附加漂移的轨迹，同时通过从第一性原理推导出的IS权重保持精确性。\n\n基本依据与假设：\n- $r$ 的过阻尼朗之万动力学由 $dr_t = a(r_t)\\,dt + \\sqrt{2D}\\,dW_t$ 给出，其中 $W_t$ 是一个维纳过程（标准布朗运动）。\n- 我们使用欧拉-丸山格式对时间进行离散化：对于时间步长 $\\Delta t$，动力学引起的跃迁为 $r_{n+1} = r_n + a(r_n)\\,\\Delta t + \\sqrt{2D\\,\\Delta t}\\,\\xi_n$，其中增量 $\\xi_n$ 是一个均值为 $0$、方差为 $1$ 的标准正态随机变量，并且在各个步骤之间相互独立。\n- 双势阱为 $U(r) = \\alpha\\,(r^2 - 1)^2$，其中 $\\alpha > 0$。确定性漂移为 $a(r) = \\mu\\,F(r)$，其中力 $F(r)$ 是 $U(r)$ 的负梯度，即 $F(r) = -\\frac{dU}{dr}(r)$。\n- 用于路径采样的提议过程增加了一个朝向 $r_{\\star}$ 的引导漂移：$b(r) = a(r) + c\\,(r_{\\star} - r)$，其中 $c \\ge 0$ 是引导强度。我们假设提议过程使用与目标动力学相同的扩散系数 $D$ 和时间步长 $\\Delta t$。\n- 在无量纲化下，当热能被缩放为单位值（即 $k_{\\text{B}}T = 1$）时，爱因斯坦关系设定 $D = \\mu$。我们采用此设定。\n\n任务：\n1. 仅从欧拉-丸山离散化、每步跃迁的高斯性质以及上述定义出发，推导完整路径 $r_0, r_1, \\dots, r_N$ 的显式IS权重 $w$。该权重是漂移为 $a(\\cdot)$ 的目标动力学与漂移为 $b(\\cdot)$ 的提议动力学之间离散时间步长似然比的乘积。请用 $r_n$、$\\Delta r_n := r_{n+1} - r_n$、$a(r_n)$、$b(r_n)$、$\\Delta t$ 和 $D$ 完整清晰地表达您的推导过程。\n2. 实现一个程序，在给定参数和特定路径 $(r_n)_{n=0}^N$ 的情况下，使用您推导的表达式计算该路径的IS权重 $w$。\n\n科学真实性与参数化：\n- 使用 $U(r) = \\alpha\\,(r^2 - 1)^2$，因此 $\\frac{dU}{dr}(r) = 4\\,\\alpha\\,r\\,(r^2 - 1)$，$F(r) = -\\frac{dU}{dr}(r)$，以及 $a(r) = \\mu\\,F(r)$。\n- 使用 $D = \\mu$。\n- 对目标和提议使用相同的 $\\Delta t$。\n\n测试套件：\n计算以下三个测试案例的IS权重。所有量均为无量纲。\n\n- 案例1（理想路径，跨越势垒的引导跃迁）：\n  - $\\mu = 0.5$，$\\alpha = 1.0$， $D = \\mu$，$\\Delta t = 0.01$，$r_{\\star} = 1.0$，$c = 1.0$，\n  - 路径状态 $[\\, -0.9,-0.8,-0.75,-0.6,-0.4,-0.2,0.0,0.25,0.6,0.85,1.05 \\,]$。\n\n- 案例2（边界条件，提议等于目标，因此权重应恰好为1）：\n  - $\\mu = 0.5$，$\\alpha = 1.0$， $D = \\mu$，$\\Delta t = 0.01$，$r_{\\star} = 1.0$，$c = 0.0$，\n  - 路径状态 $[\\, -0.95,-0.98,-1.0,-0.99,-0.98,-0.97,-0.96,-0.96,-0.95,-0.95,-0.95 \\,]$。\n\n- 案例3（边缘案例，在强引导漂移下的恒定路径）：\n  - $\\mu = 0.5$，$\\alpha = 1.0$， $D = \\mu$，$\\Delta t = 0.01$，$r_{\\star} = 1.0$，$c = 2.0$，\n  - 路径状态 $[\\, -0.5,-0.5,-0.5,-0.5,-0.5,-0.5,-0.5,-0.5,-0.5,-0.5,-0.5 \\,]$。\n\n输出格式：\n- 您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表（例如 $[w_1,w_2,w_3]$），$w_i$ 是为案例 $i$ 计算出的IS权重，表示为浮点数。",
            "solution": "该问题要求推导在过阻尼朗之万动力学下演化的离散路径的重要性采样（IS）权重，并实现一个程序来为给定的测试案例计算此权重。\n\n### 第1步：问题陈述的验证\n首先，根据所需标准验证问题陈述。\n\n**提取的已知条件：**\n- **SDE（随机微分方程）：** $dr_t = a(r_t)\\,dt + \\sqrt{2D}\\,dW_t$\n- **离散化：** $r_{n+1} = r_n + a(r_n)\\,\\Delta t + \\sqrt{2D\\,\\Delta t}\\,\\xi_n$，其中 $\\xi_n \\sim \\mathcal{N}(0, 1)$\n- **势能：** $U(r) = \\alpha\\,(r^2 - 1)^2$\n- **目标漂移：** $a(r) = \\mu\\,F(r) = -\\mu\\,\\frac{dU}{dr}(r) = -4\\,\\alpha\\,\\mu\\,r\\,(r^2-1)$\n- **提议漂移：** $b(r) = a(r) + c\\,(r_{\\star} - r)$，其中 $c \\ge 0$\n- **约束条件：** $D = \\mu$\n- **任务：** 推导路径 $(r_n)_{n=0}^N$ 的IS权重 $w$，并实现一个程序来为三个测试案例计算它。\n\n**验证结论：**\n该问题在科学上植根于统计力学和计算物理学领域，特别涉及随机过程和蒙特卡洛方法。朗之万动力学、双势阱以及带引导势的重要性采样的使用是标准且成熟的技术。该问题是适定的，所有必要的参数、方程和边界条件都已明确定义。没有矛盾、歧义或事实不准确之处。措辞客观而正式。该问题要求一个不平凡的推导，然后是直接的实现，使其成为一个有效且有实质内容的任务。\n\n### 第2步：重要性采样权重的推导\n\n路径的重要性采样（IS）权重 $w$ 是在目标动力学下观测到该路径的概率与在提议动力学下观测到该路径的概率之比。设路径由状态序列 $R = (r_0, r_1, \\dots, r_N)$ 表示。以起始点 $r_0$ 为条件，路径的概率由下式给出：\n$$\nP(R) = P(r_N, r_{N-1}, \\dots, r_1 | r_0)\n$$\n由于欧拉-丸山格式所描述的动力学是马尔可夫的，整个路径的概率是单步跃迁概率的乘积：\n$$\nP(R) = \\prod_{n=0}^{N-1} P(r_{n+1} | r_n)\n$$\n因此，IS权重 $w$ 为：\n$$\nw = \\frac{P_{\\text{target}}(R)}{P_{\\text{proposal}}(R)} = \\frac{\\prod_{n=0}^{N-1} P_{\\text{target}}(r_{n+1} | r_n)}{\\prod_{n=0}^{N-1} P_{\\text{proposal}}(r_{n+1} | r_n)} = \\prod_{n=0}^{N-1} \\frac{P_{\\text{target}}(r_{n+1} | r_n)}{P_{\\text{proposal}}(r_{n+1} | r_n)} = \\prod_{n=0}^{N-1} w_n\n$$\n其中 $w_n$ 是从 $n$ 到 $n+1$ 的单个时间步的权重。我们的任务简化为找到 $w_n$ 的表达式。\n\n我们首先确定单步跃迁概率 $P(r_{n+1}|r_n)$。对于一个通用漂移 $f(r)$，欧拉-丸山离散化为：\n$$\nr_{n+1} = r_n + f(r_n)\\,\\Delta t + \\sqrt{2D\\,\\Delta t}\\,\\xi_n\n$$\n其中 $\\xi_n$ 是从标准正态分布 $\\xi_n \\sim \\mathcal{N}(0,1)$ 中抽取的随机变量。这个方程可以重排以表明 $r_{n+1}$ 是一个高斯随机变量：\n$$\nr_{n+1} \\sim \\mathcal{N}(\\mu_{r_{n+1}}, \\sigma^2_{r_{n+1}})\n$$\n均值为 $\\mu_{r_{n+1}} = r_n + f(r_n)\\,\\Delta t$，方差为 $\\sigma^2_{r_{n+1}} = (\\sqrt{2D\\,\\Delta t})^2 \\cdot \\text{Var}(\\xi_n) = 2D\\,\\Delta t$。此跃迁的概率密度由高斯概率密度函数（PDF）给出：\n$$\nP(r_{n+1} | r_n) = \\frac{1}{\\sqrt{2\\pi \\cdot (2D\\,\\Delta t)}} \\exp\\left( -\\frac{(r_{n+1} - (r_n + f(r_n)\\,\\Delta t))^2}{2 \\cdot (2D\\,\\Delta t)} \\right)\n$$\n令 $\\Delta r_n = r_{n+1} - r_n$。该密度可写作：\n$$\nP(r_{n+1} | r_n) = \\frac{1}{\\sqrt{4\\pi D\\Delta t}} \\exp\\left( -\\frac{(\\Delta r_n - f(r_n)\\,\\Delta t)^2}{4D\\,\\Delta t} \\right)\n$$\n现在，我们将此应用于我们特定的目标和提议动力学。\n对于**目标动力学**，漂移为 $f(r) = a(r)$。概率为：\n$$\nP_{\\text{target}}(r_{n+1} | r_n) = \\frac{1}{\\sqrt{4\\pi D\\Delta t}} \\exp\\left( -\\frac{(\\Delta r_n - a(r_n)\\,\\Delta t)^2}{4D\\,\\Delta t} \\right)\n$$\n对于**提议动力学**，漂移为 $f(r) = b(r)$。概率为：\n$$\nP_{\\text{proposal}}(r_{n+1} | r_n) = \\frac{1}{\\sqrt{4\\pi D\\Delta t}} \\exp\\left( -\\frac{(\\Delta r_n - b(r_n)\\,\\Delta t)^2}{4D\\,\\Delta t} \\right)\n$$\n单步权重 $w_n$ 是这两个概率的比值。归一化常数 $\\frac{1}{\\sqrt{4\\pi D\\Delta t}}$ 被约掉。\n$$\nw_n = \\frac{P_{\\text{target}}(r_{n+1} | r_n)}{P_{\\text{proposal}}(r_{n+1} | r_n)} = \\frac{\\exp\\left( -\\frac{(\\Delta r_n - a(r_n)\\,\\Delta t)^2}{4D\\,\\Delta t} \\right)}{\\exp\\left( -\\frac{(\\Delta r_n - b(r_n)\\,\\Delta t)^2}{4D\\,\\Delta t} \\right)}\n$$\n$$\nw_n = \\exp\\left( \\frac{(\\Delta r_n - b(r_n)\\,\\Delta t)^2 - (\\Delta r_n - a(r_n)\\,\\Delta t)^2}{4D\\,\\Delta t} \\right)\n$$\n为了数值稳定性，最好使用权重的对数 $\\ln(w)$。对于完整路径，$\\ln(w) = \\sum_{n=0}^{N-1} \\ln(w_n)$。对于单步：\n$$\n\\ln(w_n) = \\frac{(\\Delta r_n - b(r_n)\\,\\Delta t)^2 - (\\Delta r_n - a(r_n)\\,\\Delta t)^2}{4D\\,\\Delta t}\n$$\n我们展开分子：\n令 $a_n = a(r_n)$ 且 $b_n = b(r_n)$。\n分子 $= (\\Delta r_n^2 - 2\\Delta r_n b_n \\Delta t + b_n^2 \\Delta t^2) - (\\Delta r_n^2 - 2\\Delta r_n a_n \\Delta t + a_n^2 \\Delta t^2)$\n$= -2\\Delta r_n b_n \\Delta t + 2\\Delta r_n a_n \\Delta t + b_n^2 \\Delta t^2 - a_n^2 \\Delta t^2$\n$= 2\\Delta r_n (a_n - b_n) \\Delta t + (b_n^2 - a_n^2) \\Delta t^2$\n现在，我们将其代回 $\\ln(w_n)$ 的表达式中：\n$$\n\\ln(w_n) = \\frac{2\\Delta r_n (a_n - b_n) \\Delta t + (b_n^2 - a_n^2) \\Delta t^2}{4D\\,\\Delta t}\n$$\n除以 $\\Delta t$ 可以简化表达式：\n$$\n\\ln(w_n) = \\frac{2\\Delta r_n (a_n - b_n) + (b_n^2 - a_n^2) \\Delta t}{4D}\n$$\n使用平方差公式，$b_n^2 - a_n^2 = (b_n - a_n)(b_n + a_n)$，我们可以提出公因子 $(a_n - b_n)$：\n$$\n\\ln(w_n) = \\frac{2\\Delta r_n (a_n - b_n) - (a_n - b_n)(a_n + b_n) \\Delta t}{4D}\n$$\n$$\n\\ln(w_n) = \\frac{a_n - b_n}{4D} \\left( 2\\Delta r_n - (a_n + b_n)\\Delta t \\right)\n$$\n这是单步IS权重对数的最终显式表达式。总路径权重 $w$ 则通过对所有步骤的这些对数贡献求和，然后取指数来计算：\n$$\nw = \\exp\\left( \\sum_{n=0}^{N-1} \\ln(w_n) \\right) = \\exp\\left( \\sum_{n=0}^{N-1} \\frac{a(r_n) - b(r_n)}{4D} \\left( 2(r_{n+1}-r_n) - (a(r_n) + b(r_n))\\Delta t \\right) \\right)\n$$\n该公式将在程序中实现。\n\n所需的漂移是：\n- 目标漂移：$a(r) = -4\\alpha\\mu r(r^2-1)$\n- 提议漂移：$b(r) = a(r) + c(r_{\\star}-r)$\n实现过程将在给定路径的每一步 $r_n$ 计算这些值，以算出最终权重 $w$。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the Importance Sampling (IS) weights for given paths and parameters.\n    The derivation is based on the ratio of path probabilities under target and proposal dynamics,\n    discretized using the Euler-Maruyama scheme.\n    \"\"\"\n    \n    test_cases = [\n        {\n            \"params\": {\"mu\": 0.5, \"alpha\": 1.0, \"dt\": 0.01, \"r_star\": 1.0, \"c\": 1.0},\n            \"path\": [-0.9, -0.8, -0.75, -0.6, -0.4, -0.2, 0.0, 0.25, 0.6, 0.85, 1.05]\n        },\n        {\n            \"params\": {\"mu\": 0.5, \"alpha\": 1.0, \"dt\": 0.01, \"r_star\": 1.0, \"c\": 0.0},\n            \"path\": [-0.95, -0.98, -1.0, -0.99, -0.98, -0.97, -0.96, -0.96, -0.95, -0.95, -0.95]\n        },\n        {\n            \"params\": {\"mu\": 0.5, \"alpha\": 1.0, \"dt\": 0.01, \"r_star\": 1.0, \"c\": 2.0},\n            \"path\": [-0.5] * 11\n        }\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        p = case[\"params\"]\n        mu, alpha, dt, r_star, c = p[\"mu\"], p[\"alpha\"], p[\"dt\"], p[\"r_star\"], p[\"c\"]\n        \n        # Per the problem statement, the diffusion coefficient D is set by the Einstein relation\n        # under non-dimensionalization, where D = mu.\n        D = mu\n        \n        path = np.array(case[\"path\"], dtype=np.float64)\n        \n        # Define the target drift function a(r)\n        def a_drift(r, alpha_val, mu_val):\n            return -4.0 * alpha_val * mu_val * r * (r**2 - 1.0)\n            \n        log_w_total = 0.0\n\n        # Sum the log-weights over all N-1 steps in the path\n        for i in range(len(path) - 1):\n            r_n = path[i]\n            r_n_plus_1 = path[i+1]\n            \n            delta_r_n = r_n_plus_1 - r_n\n            \n            a_n = a_drift(r_n, alpha, mu)\n            # The proposal drift b(r) = a(r) + c*(r_star - r)\n            b_n = a_n + c * (r_star - r_n)\n            \n            # If c = 0, then a_n = b_n, and log(w_n) is exactly 0. This avoids potential\n            # floating-point inaccuracies from the formula.\n            if c == 0.0:\n                log_w_n = 0.0\n            else:\n                # This is the derived formula for the log of the single-step weight:\n                # ln(w_n) = (a_n - b_n) / (4*D) * (2*delta_r_n - (a_n + b_n)*dt)\n                a_minus_b = a_n - b_n\n                a_plus_b = a_n + b_n\n                \n                log_w_n = (a_minus_b / (4.0 * D)) * (2.0 * delta_r_n - a_plus_b * dt)\n            \n            log_w_total += log_w_n\n        \n        # The total weight is the exponential of the sum of log-weights\n        weight = np.exp(log_w_total)\n        results.append(weight)\n\n    # Format the output as a comma-separated list in brackets\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}