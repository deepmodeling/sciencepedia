{
    "hands_on_practices": [
        {
            "introduction": "A cornerstone of molecular dynamics is the accurate calculation of interatomic forces from a given potential energy function. This practice bridges the gap between the formal expression for the Ewald energy and its application in a simulation by tasking you with deriving the force on a particle from the real-space contribution . Mastering this derivation solidifies your understanding of how the mathematical structure of the Ewald sum translates directly into the dynamics of the system.",
            "id": "3821687",
            "problem": "Consider a three-dimensional periodic system of $N$ point charges $\\{q_i\\}_{i=1}^N$ at positions $\\{\\mathbf{r}_i\\}_{i=1}^N$ within a cell spanned by lattice vectors $\\mathbf{a}_1$, $\\mathbf{a}_2$, and $\\mathbf{a}_3$. Let $\\mathbf{t}_{\\mathbf{n}} = n_1 \\mathbf{a}_1 + n_2 \\mathbf{a}_2 + n_3 \\mathbf{a}_3$ denote a lattice translation for $\\mathbf{n}=(n_1,n_2,n_3)\\in\\mathbb{Z}^3$. The real-space part of the Ewald-split electrostatic energy for a screening parameter $\\alpha>0$ is\n$$\nE^{\\text{real}}(\\alpha) = \\frac{1}{2} \\sum_{i=1}^{N} \\sum_{j=1}^{N} \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3}^{\\prime} q_i q_j \\,\\phi\\!\\left(R_{ij\\mathbf{n}};\\alpha\\right),\n$$\nwhere $\\phi(R;\\alpha) = \\operatorname{erfc}(\\alpha R)/R$, $R_{ij\\mathbf{n}} = \\left| \\mathbf{R}_{ij\\mathbf{n}} \\right|$, and $\\mathbf{R}_{ij\\mathbf{n}}=\\mathbf{r}_i-\\mathbf{r}_j+\\mathbf{t}_{\\mathbf{n}}$. The prime on the lattice sum excludes the term with $i=j$ and $\\mathbf{n}=\\mathbf{0}$. Here $\\operatorname{erfc}$ is the complementary error function (erfc).\n\nStarting from the Coulomb interaction between point charges, the definition of $E^{\\text{real}}(\\alpha)$ above, and standard vector calculus, derive the force on particle $i$ arising from the real-space Ewald term,\n$$\n\\mathbf{F}_i^{\\text{real}}(\\alpha) = -\\frac{\\partial E^{\\text{real}}(\\alpha)}{\\partial \\mathbf{r}_i},\n$$\nand provide an explicit closed-form analytic expression for $\\mathbf{F}_i^{\\text{real}}(\\alpha)$ in terms of $\\operatorname{erfc}$ and Gaussian factors. Express your final answer as a single simplified analytic expression involving sums over particles and lattice vectors. No numerical evaluation is required. Your final expression should be valid for a general triclinic cell and must include contributions from all periodic images consistent with the primed summation convention above. Do not assume any specific cutoff or symmetry beyond what is stated. The final answer must be a single symbolic mathematical expression.",
            "solution": "The objective is to derive the force on particle $i$, $\\mathbf{F}_i^{\\text{real}}(\\alpha)$, by taking the negative gradient of the real-space Ewald energy, $E^{\\text{real}}(\\alpha)$, with respect to the particle's position vector, $\\mathbf{r}_i$. The force is defined as:\n$$\n\\mathbf{F}_i^{\\text{real}}(\\alpha) = -\\frac{\\partial E^{\\text{real}}(\\alpha)}{\\partial \\mathbf{r}_i} = -\\nabla_{\\mathbf{r}_i} E^{\\text{real}}(\\alpha)\n$$\nThe real-space energy is given by:\n$$\nE^{\\text{real}}(\\alpha) = \\frac{1}{2} \\sum_{j=1}^{N} \\sum_{k=1}^{N} \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3}^{\\prime} q_j q_k \\,\\phi\\!\\left(R_{jk\\mathbf{n}}\\right)\n$$\nwhere a different set of indices $(j,k)$ is used for summation to avoid confusion with the particle index $i$ for which the force is being calculated. The primed summation indicates that the term corresponding to $j=k$ and $\\mathbf{n}=\\mathbf{0}$ is excluded. The interaction potential is $\\phi(R) = \\operatorname{erfc}(\\alpha R)/R$, and the distance is $R_{jk\\mathbf{n}} = |\\mathbf{R}_{jk\\mathbf{n}}| = |\\mathbf{r}_j - \\mathbf{r}_k + \\mathbf{t}_{\\mathbf{n}}|$.\n\nWe can bring the gradient operator inside the summations:\n$$\n\\mathbf{F}_i^{\\text{real}}(\\alpha) = -\\frac{1}{2} \\sum_{j=1}^{N} \\sum_{k=1}^{N} \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3}^{\\prime} q_j q_k \\nabla_{\\mathbf{r}_i} \\phi\\!\\left(R_{jk\\mathbf{n}}\\right)\n$$\nThe gradient of the potential $\\phi(R_{jk\\mathbf{n}})$ is found using the chain rule:\n$$\n\\nabla_{\\mathbf{r}_i} \\phi(R_{jk\\mathbf{n}}) = \\frac{d\\phi(R_{jk\\mathbf{n}})}{dR_{jk\\mathbf{n}}} \\nabla_{\\mathbf{r}_i} R_{jk\\mathbf{n}}\n$$\nFirst, let's evaluate the gradient of the distance, $R_{jk\\mathbf{n}} = \\sqrt{\\mathbf{R}_{jk\\mathbf{n}} \\cdot \\mathbf{R}_{jk\\mathbf{n}}}$.\n$$\n\\nabla_{\\mathbf{r}_i} R_{jk\\mathbf{n}} = \\frac{1}{2 R_{jk\\mathbf{n}}} \\nabla_{\\mathbf{r}_i} (\\mathbf{R}_{jk\\mathbf{n}} \\cdot \\mathbf{R}_{jk\\mathbf{n}}) = \\frac{1}{R_{jk\\mathbf{n}}} (\\nabla_{\\mathbf{r}_i} \\mathbf{R}_{jk\\mathbf{n}}^T) \\mathbf{R}_{jk\\mathbf{n}}\n$$\nThe gradient of the vector $\\mathbf{R}_{jk\\mathbf{n}} = \\mathbf{r}_j - \\mathbf{r}_k + \\mathbf{t}_{\\mathbf{n}}$ with respect to $\\mathbf{r}_i$ is a second-rank tensor:\n$$\n\\nabla_{\\mathbf{r}_i} \\mathbf{R}_{jk\\mathbf{n}} = \\delta_{ij} \\mathbf{I} - \\delta_{ik} \\mathbf{I}\n$$\nwhere $\\mathbf{I}$ is the identity tensor and $\\delta_{ab}$ is the Kronecker delta. Therefore,\n$$\n\\nabla_{\\mathbf{r}_i} R_{jk\\mathbf{n}} = \\frac{1}{R_{jk\\mathbf{n}}} (\\delta_{ij} \\mathbf{I} - \\delta_{ik} \\mathbf{I})^T \\mathbf{R}_{jk\\mathbf{n}} = (\\delta_{ij} - \\delta_{ik}) \\frac{\\mathbf{R}_{jk\\mathbf{n}}}{R_{jk\\mathbf{n}}}\n$$\nSubstituting this back into the expression for the force:\n$$\n\\mathbf{F}_i^{\\text{real}}(\\alpha) = -\\frac{1}{2} \\sum_{j=1}^{N} \\sum_{k=1}^{N} \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3}^{\\prime} q_j q_k \\frac{d\\phi(R_{jk\\mathbf{n}})}{dR_{jk\\mathbf{n}}} (\\delta_{ij} - \\delta_{ik}) \\frac{\\mathbf{R}_{jk\\mathbf{n}}}{R_{jk\\mathbf{n}}}\n$$\nThe sum can be separated into two parts based on the Kronecker deltas:\n$$\n\\mathbf{F}_i^{\\text{real}}(\\alpha) = -\\frac{1}{2} \\left[ \\sum_{k=1}^{N} \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3}^{\\prime} q_i q_k \\frac{d\\phi(R_{ik\\mathbf{n}})}{dR_{ik\\mathbf{n}}} \\frac{\\mathbf{R}_{ik\\mathbf{n}}}{R_{ik\\mathbf{n}}} - \\sum_{j=1}^{N} \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3}^{\\prime} q_j q_i \\frac{d\\phi(R_{ji\\mathbf{n}})}{dR_{ji\\mathbf{n}}} \\frac{\\mathbf{R}_{ji\\mathbf{n}}}{R_{ji\\mathbf{n}}} \\right]\n$$\nIn the first term, the primed sum over $(k, \\mathbf{n})$ excludes $(k=i, \\mathbf{n}=\\mathbf{0})$. In the second term, the primed sum over $(j, \\mathbf{n})$ excludes $(j=i, \\mathbf{n}=\\mathbf{0})$. Let's analyze the second sum by relabeling the summation index $j$ to $k$:\n$$\n-\\sum_{k=1}^{N} \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3}^{\\prime} q_k q_i \\frac{d\\phi(R_{ki\\mathbf{n}})}{dR_{ki\\mathbf{n}}} \\frac{\\mathbf{R}_{ki\\mathbf{n}}}{R_{ki\\mathbf{n}}}\n$$\nWe use the relations $\\mathbf{R}_{ki\\mathbf{n}} = \\mathbf{r}_k - \\mathbf{r}_i + \\mathbf{t}_{\\mathbf{n}} = -(\\mathbf{r}_i - \\mathbf{r}_k - \\mathbf{t}_{\\mathbf{n}}) = -\\mathbf{R}_{ik,-\\mathbf{n}}$. This implies $R_{ki\\mathbf{n}} = R_{ik,-\\mathbf{n}}$. Since $\\phi(R)$ only depends on the magnitude $R$, its derivative $\\frac{d\\phi}{dR}$ also respects this symmetry. The second sum becomes:\n$$\n-\\sum_{k=1}^{N} \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3}^{\\prime} q_k q_i \\frac{d\\phi(R_{ik,-\\mathbf{n}})}{dR_{ik,-\\mathbf{n}}} \\frac{-\\mathbf{R}_{ik,-\\mathbf{n}}}{R_{ik,-\\mathbf{n}}} = \\sum_{k=1}^{N} \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3}^{\\prime} q_i q_k \\frac{d\\phi(R_{ik,-\\mathbf{n}})}{dR_{ik,-\\mathbf{n}}} \\frac{\\mathbf{R}_{ik,-\\mathbf{n}}}{R_{ik,-\\mathbf{n}}}\n$$\nSince the sum over $\\mathbf{n}$ spans all integer vectors in $\\mathbb{Z}^3$, we can change the summation variable from $\\mathbf{n}$ to $-\\mathbf{n}$. The summation limits and the prime condition (excluding $k=i, \\mathbf{n}=\\mathbf{0}$) remain unchanged. The second sum is therefore identical to the first sum.\n$$\n\\mathbf{F}_i^{\\text{real}}(\\alpha) = -\\frac{1}{2} \\left[ \\left(\\text{First Term}\\right) + \\left(\\text{First Term}\\right) \\right] = - \\sum_{k=1}^{N} \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3}^{\\prime} q_i q_k \\frac{d\\phi(R_{ik\\mathbf{n}})}{dR_{ik\\mathbf{n}}} \\frac{\\mathbf{R}_{ik\\mathbf{n}}}{R_{ik\\mathbf{n}}}\n$$\nNow, we compute the derivative of $\\phi(R) = \\operatorname{erfc}(\\alpha R)/R$. We use the quotient rule and the derivative $\\frac{d}{dx}\\operatorname{erfc}(x) = -\\frac{2}{\\sqrt{\\pi}}\\exp(-x^2)$.\n$$\n\\frac{d\\phi}{dR} = \\frac{R \\frac{d}{dR}(\\operatorname{erfc}(\\alpha R)) - \\operatorname{erfc}(\\alpha R) \\frac{dR}{dR}}{R^2} = \\frac{R \\left(-\\frac{2\\alpha}{\\sqrt{\\pi}}\\exp(-\\alpha^2 R^2)\\right) - \\operatorname{erfc}(\\alpha R)}{R^2}\n$$\n$$\n\\frac{d\\phi}{dR} = - \\frac{2\\alpha}{\\sqrt{\\pi}} \\frac{\\exp(-\\alpha^2 R^2)}{R} - \\frac{\\operatorname{erfc}(\\alpha R)}{R^2}\n$$\nSubstituting this derivative into the force expression and changing the dummy index $k$ to $j$ for consistency with the problem statement:\n$$\n\\mathbf{F}_i^{\\text{real}}(\\alpha) = - \\sum_{j=1}^{N} \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3}^{\\prime} q_i q_j \\left( - \\frac{2\\alpha}{\\sqrt{\\pi}} \\frac{\\exp(-\\alpha^2 R_{ij\\mathbf{n}}^2)}{R_{ij\\mathbf{n}}} - \\frac{\\operatorname{erfc}(\\alpha R_{ij\\mathbf{n}})}{R_{ij\\mathbf{n}}^2} \\right) \\frac{\\mathbf{R}_{ij\\mathbf{n}}}{R_{ij\\mathbf{n}}}\n$$\nSimplifying the expression by distributing the negative sign and combining terms:\n$$\n\\mathbf{F}_i^{\\text{real}}(\\alpha) = \\sum_{j=1}^{N} \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3}^{\\prime} q_i q_j \\left( \\frac{2\\alpha}{\\sqrt{\\pi}} \\frac{\\exp(-\\alpha^2 R_{ij\\mathbf{n}}^2)}{R_{ij\\mathbf{n}}^2} + \\frac{\\operatorname{erfc}(\\alpha R_{ij\\mathbf{n}})}{R_{ij\\mathbf{n}}^3} \\right) \\mathbf{R}_{ij\\mathbf{n}}\n$$\nThis is the final closed-form analytic expression for the force on particle $i$ due to the real-space Ewald sum. The sum is over all particles $j$ and all lattice vectors $\\mathbf{t_n}$, excluding the self-interaction term where $j=i$ and $\\mathbf{n}=\\mathbf{0}$. The vector $\\mathbf{R}_{ij\\mathbf{n}} = \\mathbf{r}_i - \\mathbf{r}_j + \\mathbf{t}_{\\mathbf{n}}$.",
            "answer": "$$\n\\boxed{\\sum_{j=1}^{N} \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3}^{\\prime} q_i q_j \\left( \\frac{\\operatorname{erfc}(\\alpha R_{ij\\mathbf{n}})}{R_{ij\\mathbf{n}}^3} + \\frac{2\\alpha}{\\sqrt{\\pi}} \\frac{\\exp(-\\alpha^2 R_{ij\\mathbf{n}}^2)}{R_{ij\\mathbf{n}}^2} \\right) \\mathbf{R}_{ij\\mathbf{n}}}\n$$"
        },
        {
            "introduction": "While powerful, periodic boundary conditions can introduce unphysical artifacts, especially for systems with a net charge, a common scenario when studying defects. This practice delves into this crucial issue by having you derive the leading-order finite-size energy correction for a charged point defect in a periodic cell . Understanding the origin of this $q^2/L$ error term from first principles is essential for performing accurate calculations of charged defect properties in condensed matter systems.",
            "id": "3821689",
            "problem": "Consider a three-dimensional periodic simulation of a charged point defect embedded in an otherwise inert host, modeled as a single point charge of magnitude $q$ located at the origin of a cubic supercell of side length $L$. To maintain overall charge neutrality under Periodic Boundary Conditions (PBC), the system includes a uniform compensating background charge density $-q/L^{3}$. The long-range electrostatic interactions are evaluated using the Ewald summation technique, in which the Coulomb kernel is split into short-range (real-space) and long-range (reciprocal-space) components. Assume conducting (\"tin-foil\") boundary conditions, meaning the macroscopic electric field vanishes and the zero-wavevector term in reciprocal space is omitted.\n\nStarting from electrostatics and the Poisson equation $\\nabla^{2}\\phi(\\mathbf{r})=-\\rho(\\mathbf{r})/\\varepsilon_{0}$, and using the standard definition of the Ewald potential for a lattice of point charges plus a uniform background, derive the leading finite-size contribution to the total electrostatic energy per supercell that arises solely from the interaction of the defect charge with its periodic images and the neutralizing background. You may assume the defect has no dipole or quadrupole moments beyond its net charge (i.e., treat it as a strict point charge), and you may neglect all higher-order multipole and shape-anisotropy effects. The shape-dependent lattice-sum constant that characterizes the potential at a lattice site due to all periodic images under the Ewald construction, known as the Madelung constant, is dimensionless and depends only on cell shape and boundary conditions; for a cubic supercell with conducting boundary conditions, denote this constant by $\\alpha_{M}$.\n\nExplain, from first principles, why the leading finite-size contribution scales with $q^{2}/L$ and compute the closed-form analytic expression for this leading term in terms of $q$, $L$, and $\\alpha_{M}$. Work in atomic units where the Coulomb interaction is $1/r$ and the energy unit is Hartree (Ha), and express your final energy in Hartree. The final answer must be a single closed-form analytic expression. No rounding is required.",
            "solution": "The problem asks for the leading finite-size contribution to the electrostatic energy of a periodic supercell containing a single point charge $q$ and a neutralizing background. This is a classic problem in computational materials science, and its solution is the leading term of the Makov-Payne corrections for charged defect calculations.\n\nThe analysis begins with the fundamental equation of electrostatics, the Poisson equation, which relates the electrostatic potential $\\phi(\\mathbf{r})$ to the charge density $\\rho(\\mathbf{r})$. The problem specifies the use of atomic units where the Coulomb interaction energy between two unit charges separated by a unit distance is one Hartree, and the force law is $1/r^{2}$. This corresponds to a system of units where $1/(4\\pi\\varepsilon_{0}) = 1$, so the Poisson equation takes the form:\n$$\n\\nabla^{2}\\phi(\\mathbf{r}) = -4\\pi\\rho(\\mathbf{r})\n$$\nThe system consists of a cubic supercell of side length $L$ and volume $V=L^3$. A point charge $q$ is placed at the origin, $\\mathbf{r}=0$. To maintain overall charge neutrality under Periodic Boundary Conditions (PBC), a uniform background charge density $\\rho_{\\text{bg}} = -q/V$ is added. The total charge distribution for the infinite, periodic system is therefore:\n$$\n\\rho_{\\text{total}}(\\mathbf{r}) = \\sum_{\\mathbf{n}} q\\delta(\\mathbf{r}-\\mathbf{R_n}) - \\frac{q}{V}\n$$\nwhere $\\mathbf{R_n}$ are the lattice vectors of the cubic lattice, i.e., $\\mathbf{R_n} = (n_x L, n_y L, n_z L)$ for integers $n_x, n_y, n_z$, and the sum runs over all such lattice vectors.\n\nThe total electrostatic energy per supercell, $E_{\\text{cell}}$, is given by the integral of the energy density over the volume of one supercell:\n$$\nE_{\\text{cell}} = \\frac{1}{2} \\int_{V} \\rho_{\\text{cell}}(\\mathbf{r})\\phi(\\mathbf{r}) d^{3}\\mathbf{r}\n$$\nwhere $\\rho_{\\text{cell}}(\\mathbf{r}) = q\\delta(\\mathbf{r}) - q/V$ is the charge distribution within the central cell, and $\\phi(\\mathbf{r})$ is the potential generated by the full periodic charge distribution $\\rho_{\\text{total}}(\\mathbf{r})$. Substituting the expression for $\\rho_{\\text{cell}}(\\mathbf{r})$:\n$$\nE_{\\text{cell}} = \\frac{1}{2} \\int_{V} \\left( q\\delta(\\mathbf{r}) - \\frac{q}{V} \\right) \\phi(\\mathbf{r}) d^{3}\\mathbf{r} = \\frac{1}{2} \\left( q\\phi(\\mathbf{r}=0) - \\frac{q}{V} \\int_{V} \\phi(\\mathbf{r}) d^{3}\\mathbf{r} \\right)\n$$\nThe integral term is related to the average electrostatic potential in the supercell, $\\langle\\phi\\rangle = (1/V) \\int_{V} \\phi(\\mathbf{r}) d^{3}\\mathbf{r}$. The problem specifies \"conducting\" or \"tin-foil\" boundary conditions, which implies that the macroscopic electric field is screened and the average electrostatic potential is set to zero. This is equivalent to omitting the $\\mathbf{k}=0$ component of the potential in the reciprocal-space (Ewald) sum. Thus, we have $\\langle\\phi\\rangle=0$. The energy expression simplifies to:\n$$\nE_{\\text{cell}} = \\frac{1}{2} q\\phi(0)\n$$\nThe potential at the origin, $\\phi(0)$, is the potential generated by the entire periodic charge distribution. It is useful to decompose this potential into two parts:\n1. The singular potential from the point charge $q$ at the origin itself, $\\phi_{\\text{self}}(\\mathbf{r}) = q/|\\mathbf{r}|$, which diverges as $\\mathbf{r} \\to 0$.\n2. The regular potential, $\\phi_{\\text{reg}}(\\mathbf{r})$, from all other charges in the system: the periodic images of the point charge at $\\mathbf{R_n} \\neq 0$ and the uniform neutralizing background.\n\nThe total potential is $\\phi(\\mathbf{r}) = \\phi_{\\text{self}}(\\mathbf{r}) + \\phi_{\\text{reg}}(\\mathbf{r})$. The term $E_{\\text{cell}}$ thus contains the infinite self-energy of the point charge, which is an unphysical artifact that must be removed. The physically meaningful quantity is the interaction energy of the charge $q$ with its periodic images and the background. This energy is what constitutes the leading finite-size error. This interaction energy, which we denote $E_{\\text{FS}}$, is obtained by using only the regular part of the potential in the energy expression.\n$$\nE_{\\text{FS}} = \\frac{1}{2} q \\phi_{\\text{reg}}(0)\n$$\nThe factor of $1/2$ is crucial; it arises from the fact that the total energy of a system of interacting particles is one-half the sum of the potential energies of each particle in the field of all others, to avoid double-counting the pairwise interactions.\n\nThe regular potential at the origin, $\\phi_{\\text{reg}}(0)$, is the result of a conditionally convergent lattice sum, which is regularized and computed using the Ewald summation technique. The result of this summation depends on the lattice geometry and the boundary conditions. For a given lattice structure, this potential is proportional to the source charge $q$ and inversely proportional to the characteristic length scale of the system, $L$. We can write:\n$$\n\\phi_{\\text{reg}}(0) = \\frac{\\alpha_M q}{L}\n$$\nHere, $\\alpha_M$ is a dimensionless constant known as the Madelung constant, which encapsulates the geometry of the lattice sum. The problem statement provides this constant for a cubic supercell with conducting boundary conditions.\n\nSubstituting this expression for the regular potential back into the energy formula, we obtain the leading finite-size contribution to the electrostatic energy:\n$$\nE_{\\text{FS}} = \\frac{1}{2} q \\left( \\frac{\\alpha_M q}{L} \\right) = \\frac{\\alpha_M q^2}{2L}\n$$\nThis expression reveals why the leading finite-size correction scales as $q^{2}/L$. The scaling with $q^2$ is a direct consequence of the pairwise nature of the electrostatic interaction; the energy arises from the interaction of the defect charge $q$ with its images (also of charge $q$) and the background (with total charge $-q$), making the energy proportional to $q \\times q = q^2$. The scaling with $1/L$ follows from dimensional analysis of the Coulomb potential ($1/r$ dependence), where the characteristic distance between the defect and its periodic images is the supercell size $L$. The dimensionless Madelung constant $\\alpha_M$ accounts for the specific geometric arrangement of the infinite lattice of images. This $1/L$ term represents an artificial interaction between the defect and its periodic images, which is the dominant source of error in calculations of charged defect formation energies in finite-sized supercells. Higher-order terms, which the problem instructs to neglect, scale as $1/L^3$, $1/L^5$, etc., and arise from interactions of higher-order multipole moments of the charge density.",
            "answer": "$$\n\\boxed{\\frac{\\alpha_{M} q^{2}}{2L}}\n$$"
        },
        {
            "introduction": "The theoretical equivalence between the slowly-converging solution of the Poisson equation in Fourier space and the rapidly-converging Ewald method is a key concept. This hands-on coding challenge asks you to demonstrate this equivalence numerically by implementing both a direct Fourier-space solution and the full Ewald summation to calculate the electrostatic potential . By programming these methods from first principles and verifying their agreement, you will gain a tangible, practical understanding of why and how the Ewald technique works.",
            "id": "3821713",
            "problem": "You must write a complete program that computes the electrostatic potential at a point in a three-dimensional periodic cell due to a set of point charges, using two independent methods: a Fourier-space solution of the Poisson equation and an Ewald summation. The objective is to verify numerical agreement between these methods to a specified absolute tolerance for multiple test cases.\n\nThe physical and mathematical context is as follows. Consider a cubic, three-dimensional periodic cell of side length $L$ under Periodic Boundary Conditions (PBC). There are $N$ point charges $q_i$ located at positions $\\mathbf{r}_i$ within the cell. The electrostatic potential $\\phi(\\mathbf{r})$ is defined by the Poisson equation in reduced electrostatic units where $4\\pi\\epsilon_0 = 1$, so that the equation reads $\\nabla^2 \\phi(\\mathbf{r}) = -4\\pi \\rho(\\mathbf{r})$, with charge density $\\rho(\\mathbf{r}) = \\sum_{i=1}^{N} q_i \\delta(\\mathbf{r}-\\mathbf{r}_i)$.\n\nStarting from this fundamental base, and using only the definitions and constraints below, implement the following two methods without introducing any unstated physical assumptions:\n\n- Fourier-space solution: Represent both $\\rho(\\mathbf{r})$ and $\\phi(\\mathbf{r})$ by Fourier series consistent with the periodic cell, and obtain $\\phi(\\mathbf{r})$ at a target position $\\mathbf{r}$ by summing nonzero Reciprocal Lattice Vectors (RLV) $\\mathbf{k}$ with $\\mathbf{k} = \\frac{2\\pi}{L} \\mathbf{m}$, where $\\mathbf{m} \\in \\mathbb{Z}^3$. You must implement this sum with a finite reciprocal-space cutoff $m_{\\max}$ by including all integer triplets $\\mathbf{m}$ with components in $[-m_{\\max}, +m_{\\max}]$ except $\\mathbf{m}=\\mathbf{0}$. Ensure that the net charge $\\sum_i q_i$ is zero so the zero-mode is absent.\n\n- Ewald summation: Implement the conventional three-dimensional Ewald decomposition using a splitting parameter $\\alpha > 0$. The total potential is the sum of a real-space contribution and a reciprocal-space contribution. The real-space sum must be truncated by a real-space cutoff $r_{\\mathrm{cut}}$ by including all lattice translation vectors $\\mathbf{n}L$ with $\\mathbf{n}\\in \\mathbb{Z}^3$ such that the distance between the evaluation point and the translated charge position is not larger than $r_{\\mathrm{cut}}$. The reciprocal-space sum must be truncated by the same finite set of nonzero RLVs defined by $m_{\\max}$. You must not include any self-interaction correction since the evaluation points will not coincide with any charge positions.\n\nAll computations must be performed and reported in reduced electrostatic units consistent with $4\\pi\\epsilon_0=1$ and lengths measured in units of the lattice parameter $a$, which we set equal to the cell side length $L$ for each test. Express the electrostatic potential $\\phi(\\mathbf{r})$ numerically without any unit symbol; that is, in the reduced unit system stated above.\n\nImplement both methods precisely from first principles as stated. Do not use or assume any ready-made shortcut formulas. Define and use the reciprocal lattice vectors and the lattice translations explicitly. Use robust numerical handling to avoid singularities and to ensure convergence within the chosen truncations.\n\nYour program must compute, for each test case, the Fourier-space potential $\\phi_{\\mathrm{F}}(\\mathbf{r})$, the Ewald potential $\\phi_{\\mathrm{E}}(\\mathbf{r})$, the absolute difference $\\Delta = |\\phi_{\\mathrm{F}}(\\mathbf{r}) - \\phi_{\\mathrm{E}}(\\mathbf{r})|$, and a boolean indicating if $\\Delta$ is less than or equal to the given tolerance.\n\nTest Suite:\nImplement the following three test cases. In each case, the charges are expressed in units of the elementary charge $e$ and positions in units of the cell side length $L$.\n\n- Test Case $1$ (general case):\n    - Cell side: $L = 10.0$\n    - Charges: $q = [ +1.0, -1.0 ]$\n    - Positions: $\\mathbf{r}_1 = (2.0, 2.0, 2.0)$, $\\mathbf{r}_2 = (7.0, 5.0, 3.0)$\n    - Evaluation point: $\\mathbf{r} = (1.0, 8.0, 4.0)$\n    - Reciprocal cutoff: $m_{\\max} = 7$\n    - Ewald splitting: $\\alpha = 0.35$\n    - Real-space cutoff: $r_{\\mathrm{cut}} = 15.0$\n    - Tolerance: $\\mathrm{tol} = 1.0\\times 10^{-6}$\n\n- Test Case $2$ (near-boundary evaluation point):\n    - Cell side: $L = 10.0$\n    - Charges: $q = [ +1.0, -1.0 ]$\n    - Positions: $\\mathbf{r}_1 = (2.0, 2.0, 2.0)$, $\\mathbf{r}_2 = (7.0, 5.0, 3.0)$\n    - Evaluation point: $\\mathbf{r} = (0.1, 9.9, 9.9)$\n    - Reciprocal cutoff: $m_{\\max} = 9$\n    - Ewald splitting: $\\alpha = 0.45$\n    - Real-space cutoff: $r_{\\mathrm{cut}} = 18.0$\n    - Tolerance: $\\mathrm{tol} = 1.0\\times 10^{-6}$\n\n- Test Case $3$ (symmetric cancellation edge case):\n    - Cell side: $L = 10.0$\n    - Charges: $q = [ +1.0, -1.0 ]$\n    - Positions: $\\mathbf{r}_1 = (2.0, 2.0, 2.0)$, $\\mathbf{r}_2 = (8.0, 8.0, 8.0)$\n    - Evaluation point: $\\mathbf{r} = (5.0, 5.0, 5.0)$\n    - Reciprocal cutoff: $m_{\\max} = 10$\n    - Ewald splitting: $\\alpha = 0.40$\n    - Real-space cutoff: $r_{\\mathrm{cut}} = 20.0$\n    - Tolerance: $\\mathrm{tol} = 1.0\\times 10^{-7}$\n\nFinal Output Format:\nYour program should produce a single line of output containing the results as a comma-separated list of per-test-case four-element lists, each of the form $[\\phi_{\\mathrm{F}},\\phi_{\\mathrm{E}},\\Delta,\\mathrm{pass}]$, enclosed in square brackets, with no spaces. For example: $[[\\phi_F^{(1)},\\phi_E^{(1)},\\Delta^{(1)},\\mathrm{pass}^{(1)}],[\\phi_F^{(2)},\\phi_E^{(2)},\\Delta^{(2)},\\mathrm{pass}^{(2)}],[\\phi_F^{(3)},\\phi_E^{(3)},\\Delta^{(3)},\\mathrm{pass}^{(3)}]]$.\n\nAngles are not used in this task. No rounding is required beyond the default floating-point representation. Ensure scientific realism by confirming that the net charge is zero in each test and that evaluation points do not coincide exactly with any charge position or its periodic images.",
            "solution": "The problem has been validated and is determined to be a well-posed, scientifically sound, and complete statement. It requests the implementation and numerical comparison of two fundamental methods for calculating electrostatic potentials in three-dimensional periodic systems: a direct Fourier-space solution of the Poisson equation and the Ewald summation method.\n\nThe theoretical foundation for both methods is the Poisson equation, which in the specified reduced electrostatic units ($4\\pi\\epsilon_0 = 1$) is:\n$$ \\nabla^2 \\phi(\\mathbf{r}) = -4\\pi \\rho(\\mathbf{r}) $$\nHere, $\\phi(\\mathbf{r})$ is the electrostatic potential at position $\\mathbf{r}$, and $\\rho(\\mathbf{r})$ is the charge density. For a system of $N$ point charges $q_i$ at positions $\\mathbf{r}_i$ within a periodic cubic cell of side length $L$, the charge density is given by $\\rho(\\mathbf{r}) = \\sum_{i=1}^{N} q_i \\delta(\\mathbf{r}-\\mathbf{r}_i)$. All calculations are performed under periodic boundary conditions.\n\n### Method 1: Fourier-Space Solution\n\nIn a periodic system, any sufficiently smooth function can be represented by a Fourier series. We expand both the potential $\\phi(\\mathbf{r})$ and the charge density $\\rho(\\mathbf{r})$:\n$$ \\phi(\\mathbf{r}) = \\sum_{\\mathbf{k}} \\hat{\\phi}(\\mathbf{k}) e^{i \\mathbf{k} \\cdot \\mathbf{r}} \\quad \\text{and} \\quad \\rho(\\mathbf{r}) = \\sum_{\\mathbf{k}} \\hat{\\rho}(\\mathbf{k}) e^{i \\mathbf{k} \\cdot \\mathbf{r}} $$\nThe sum is over the set of reciprocal lattice vectors (RLVs) $\\mathbf{k} = \\frac{2\\pi}{L}\\mathbf{m}$, where $\\mathbf{m} = (m_x, m_y, m_z)$ is a triplet of integers. The Fourier coefficients of the charge density, $\\hat{\\rho}(\\mathbf{k})$, are calculated as:\n$$ \\hat{\\rho}(\\mathbf{k}) = \\frac{1}{V} \\int_V \\rho(\\mathbf{r}) e^{-i \\mathbf{k} \\cdot \\mathbf{r}} d^3\\mathbf{r} = \\frac{1}{V} \\sum_{i=1}^{N} q_i e^{-i \\mathbf{k} \\cdot \\mathbf{r}_i} $$\nwhere $V=L^3$ is the cell volume. We define the structure factor $S(\\mathbf{k}) = \\sum_{i=1}^{N} q_i e^{-i \\mathbf{k} \\cdot \\mathbf{r}_i}$, so $\\hat{\\rho}(\\mathbf{k}) = S(\\mathbf{k})/V$.\n\nSubstituting the Fourier series into the Poisson equation and using $\\nabla^2 e^{i \\mathbf{k} \\cdot \\mathbf{r}} = -|\\mathbf{k}|^2 e^{i \\mathbf{k} \\cdot \\mathbf{r}} = -k^2 e^{i \\mathbf{k} \\cdot \\mathbf{r}}$, we obtain an algebraic relation for the Fourier coefficients:\n$$ -k^2 \\hat{\\phi}(\\mathbf{k}) = -4\\pi \\hat{\\rho}(\\mathbf{k}) \\implies \\hat{\\phi}(\\mathbf{k}) = \\frac{4\\pi}{k^2} \\hat{\\rho}(\\mathbf{k}) = \\frac{4\\pi}{V k^2} S(\\mathbf{k}) $$\nThis relation is valid for all $\\mathbf{k} \\neq \\mathbf{0}$. For $\\mathbf{k}=\\mathbf{0}$, the equation requires $\\hat{\\rho}(\\mathbf{0})=0$, which implies charge neutrality ($\\sum_i q_i=0$), a condition satisfied by all test cases. The $\\mathbf{k}=\\mathbf{0}$ component of the potential, $\\hat{\\phi}(\\mathbf{0})$, represents the average potential and is conventionally set to zero.\n\nThe potential $\\phi_{\\mathrm{F}}(\\mathbf{r})$ is reconstructed by summing over all non-zero RLVs within the specified cutoff $m_{\\max}$:\n$$ \\phi_{\\mathrm{F}}(\\mathbf{r}) = \\sum_{\\mathbf{k} \\neq \\mathbf{0}} \\hat{\\phi}(\\mathbf{k}) e^{i \\mathbf{k} \\cdot \\mathbf{r}} = \\frac{4\\pi}{V} \\sum_{\\mathbf{k} \\neq \\mathbf{0}} \\frac{S(\\mathbf{k})}{k^2} e^{i \\mathbf{k} \\cdot \\mathbf{r}} = \\frac{4\\pi}{V} \\sum_{\\mathbf{k} \\neq \\mathbf{0}} \\frac{1}{k^2} \\sum_{i=1}^{N} q_i e^{i \\mathbf{k} \\cdot (\\mathbf{r} - \\mathbf{r}_i)} $$\nThe sum over $\\mathbf{k}$ is performed for all integer vectors $\\mathbf{m}$ with components in $[-m_{\\max}, +m_{\\max}]$, excluding $\\mathbf{m}=\\mathbf{0}$.\n\n### Method 2: Ewald Summation\n\nThe Ewald method provides a more rapidly convergent series by splitting the Coulomb potential $1/r$ into a short-range and a long-range part using the identity $1 = \\mathrm{erfc}(\\alpha r) + \\mathrm{erf}(\\alpha r)$, where $\\alpha$ is a splitting parameter:\n$$ \\phi(\\mathbf{r}) = \\sum_{i=1}^N \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3} \\frac{q_i}{|\\mathbf{r}-\\mathbf{r}_i-\\mathbf{n}L|} = \\phi_{\\mathrm{real}}(\\mathbf{r}) + \\phi_{\\mathrm{recip}}(\\mathbf{r}) $$\nwhere $\\mathbf{n}L$ are the lattice translation vectors.\n\n1.  **Real-Space Contribution ($\\phi_{\\mathrm{real}}$)**: The short-range part, involving the complementary error function $\\mathrm{erfc}$, converges rapidly in real space. Its contribution to the potential is:\n    $$ \\phi_{\\mathrm{real}}(\\mathbf{r}) = \\sum_{i=1}^N \\sum_{\\mathbf{n}\\in\\mathbb{Z}^3} q_i \\frac{\\mathrm{erfc}(\\alpha |\\mathbf{r} - \\mathbf{r}_i - \\mathbf{n}L|)}{|\\mathbf{r} - \\mathbf{r}_i - \\mathbf{n}L|} $$\n    This sum is truncated by including only terms where the distance $|\\mathbf{r} - \\mathbf{r}_i - \\mathbf{n}L|$ does not exceed the real-space cutoff $r_{\\mathrm{cut}}$. Since the evaluation point $\\mathbf{r}$ does not coincide with any charge position $\\mathbf{r}_i$ or its periodic images, the denominator is never zero.\n\n2.  **Reciprocal-Space Contribution ($\\phi_{\\mathrm{recip}}$)**: The long-range part, involving the error function $\\mathrm{erf}$, is smoothly varying and is efficiently computed in reciprocal space. This contribution is equivalent to the potential generated by a set of smooth Gaussian charge distributions that cancel the long-range part of the point charges. The derivation follows the same logic as the Fourier-space method, but with an additional Gaussian factor in the structure factor. The resulting potential is:\n    $$ \\phi_{\\mathrm{recip}}(\\mathbf{r}) = \\frac{4\\pi}{V} \\sum_{\\mathbf{k}\\neq\\mathbf{0}} \\frac{e^{-k^2 / (4\\alpha^2)}}{k^2} S(\\mathbf{k}) e^{i \\mathbf{k} \\cdot \\mathbf{r}} = \\frac{4\\pi}{V} \\sum_{\\mathbf{k}\\neq\\mathbf{0}} \\frac{e^{-k^2 / (4\\alpha^2)}}{k^2} \\sum_{i=1}^{N} q_i e^{i\\mathbf{k} \\cdot (\\mathbf{r} - \\mathbf{r}_i)} $$\n    The sum is truncated using the same reciprocal-space cutoff $m_{\\max}$ as in the Fourier method. The problem statement's directive to omit self-interaction corrections is interpreted as calculating the potential at a field point $\\mathbf{r}$ distinct from any charge position, thus avoiding the issue of a particle's potential on itself. The standard Ewald potential formula for $\\phi(\\mathbf{r})$ is the direct sum $\\phi_{\\mathrm{E}}(\\mathbf{r}) = \\phi_{\\mathrm{real}}(\\mathbf{r}) + \\phi_{\\mathrm{recip}}(\\mathbf{r})$.\n\n### Algorithmic Implementation\n\nThe implementation involves two primary functions, one for each method. For both methods, the reciprocal-space sums are carried out by iterating through integer vectors $\\mathbf{m}$ where each component $m_x, m_y, m_z$ ranges from $-m_{\\max}$ to $+m_{\\max}$, skipping $\\mathbf{m}=\\mathbf{0}$. For the Ewald real-space sum, the iteration is over lattice vectors $\\mathbf{n}$, where a safe range for each component is determined from the cutoff $r_{\\mathrm{cut}}$ and cell length $L$. Complex arithmetic is used for sums involving $e^{i\\theta}$ for simplicity, with the real part of the final result taken, as the total sum must be real due to symmetry.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import erfc\nimport itertools\n\ndef compute_fourier_potential(L, charges, positions, r_eval, m_max):\n    \"\"\"\n    Computes the electrostatic potential using the Fourier-space method.\n    \"\"\"\n    V = L**3\n    potential_f = 0.0 + 0.0j\n    \n    positions = np.array(positions)\n    r_eval = np.array(r_eval)\n    \n    m_range = range(-m_max, m_max + 1)\n    m_vectors = itertools.product(m_range, m_range, m_range)\n\n    for m in m_vectors:\n        if m == (0, 0, 0):\n            continue\n            \n        m_vec = np.array(m)\n        k_vec = (2 * np.pi / L) * m_vec\n        k_sq = np.dot(k_vec, k_vec)\n\n        # Structure factor S(k)\n        s_k = 0.0 + 0.0j\n        for q, r_i in zip(charges, positions):\n            s_k += q * np.exp(-1j * np.dot(k_vec, r_i))\n            \n        term = (4 * np.pi / V) * (s_k / k_sq) * np.exp(1j * np.dot(k_vec, r_eval))\n        potential_f += term\n        \n    return potential_f.real\n\ndef compute_ewald_potential(L, charges, positions, r_eval, m_max, alpha, r_cut):\n    \"\"\"\n    Computes the electrostatic potential using the Ewald summation method.\n    \"\"\"\n    V = L**3\n    \n    positions = np.array(positions)\n    r_eval = np.array(r_eval)\n\n    # --- Reciprocal space contribution ---\n    potential_recip = 0.0 + 0.0j\n    m_range = range(-m_max, m_max + 1)\n    m_vectors = itertools.product(m_range, m_range, m_range)\n\n    for m in m_vectors:\n        if m == (0, 0, 0):\n            continue\n            \n        m_vec = np.array(m)\n        k_vec = (2 * np.pi / L) * m_vec\n        k_sq = np.dot(k_vec, k_vec)\n        \n        # Structure factor S(k)\n        s_k = 0.0 + 0.0j\n        for q, r_i in zip(charges, positions):\n            s_k += q * np.exp(-1j * np.dot(k_vec, r_i))\n\n        term = (4 * np.pi / V) * (s_k / k_sq) * np.exp(-k_sq / (4 * alpha**2)) * np.exp(1j * np.dot(k_vec, r_eval))\n        potential_recip += term\n\n    # --- Real space contribution ---\n    potential_real = 0.0\n    \n    # Determine range for lattice vectors n\n    n_max = int(np.ceil(r_cut / L)) + 1\n    n_range = range(-n_max, n_max + 1)\n    n_vectors = itertools.product(n_range, n_range, n_range)\n\n    # Storing n vectors to iterate over them for each charge\n    n_vec_list = list(n_vectors)\n\n    for q, r_i in zip(charges, positions):\n        for n in n_vec_list:\n            n_vec = np.array(n)\n            nL = n_vec * L\n            \n            dist_vec = r_eval - (r_i + nL)\n            dist = np.linalg.norm(dist_vec)\n            \n            if dist > 0 and dist <= r_cut:\n                potential_real += q * erfc(alpha * dist) / dist\n\n    total_potential = potential_recip.real + potential_real\n    return total_potential\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"L\": 10.0, \"q\": [1.0, -1.0], \n            \"pos\": [[2.0, 2.0, 2.0], [7.0, 5.0, 3.0]],\n            \"r_eval\": [1.0, 8.0, 4.0],\n            \"m_max\": 7, \"alpha\": 0.35, \"r_cut\": 15.0,\n            \"tol\": 1.0e-6\n        },\n        {\n            \"L\": 10.0, \"q\": [1.0, -1.0], \n            \"pos\": [[2.0, 2.0, 2.0], [7.0, 5.0, 3.0]],\n            \"r_eval\": [0.1, 9.9, 9.9],\n            \"m_max\": 9, \"alpha\": 0.45, \"r_cut\": 18.0,\n            \"tol\": 1.0e-6\n        },\n        {\n            \"L\": 10.0, \"q\": [1.0, -1.0], \n            \"pos\": [[2.0, 2.0, 2.0], [8.0, 8.0, 8.0]],\n            \"r_eval\": [5.0, 5.0, 5.0],\n            \"m_max\": 10, \"alpha\": 0.40, \"r_cut\": 20.0,\n            \"tol\": 1.0e-7\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        phi_f = compute_fourier_potential(\n            case[\"L\"], case[\"q\"], case[\"pos\"], case[\"r_eval\"], case[\"m_max\"]\n        )\n        phi_e = compute_ewald_potential(\n            case[\"L\"], case[\"q\"], case[\"pos\"], case[\"r_eval\"], \n            case[\"m_max\"], case[\"alpha\"], case[\"r_cut\"]\n        )\n        \n        delta = abs(phi_f - phi_e)\n        passed = delta <= case[\"tol\"]\n        \n        results.append(f\"[{phi_f:.10f},{phi_e:.10f},{delta:.10f},{str(passed).lower()}]\")\n        \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}